# PostgreSQL çª—å£å‡½æ•°è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-37

## ğŸ“‘ ç›®å½•

- [PostgreSQL çª—å£å‡½æ•°è¯¦è§£](#postgresql-çª—å£å‡½æ•°è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 çª—å£å‡½æ•°ä½“ç³»æ€ç»´å¯¼å›¾](#14-çª—å£å‡½æ•°ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. çª—å£å‡½æ•°åŸºç¡€](#2-çª—å£å‡½æ•°åŸºç¡€)
    - [2.1 çª—å£å‡½æ•°è¯­æ³•](#21-çª—å£å‡½æ•°è¯­æ³•)
    - [2.2 çª—å£å‡½æ•°ç±»å‹](#22-çª—å£å‡½æ•°ç±»å‹)
  - [3. çª—å£å‡½æ•°åº”ç”¨](#3-çª—å£å‡½æ•°åº”ç”¨)
    - [3.1 PARTITION BY](#31-partition-by)
    - [3.2 ORDER BY](#32-order-by)
    - [3.3 çª—å£æ¡†æ¶](#33-çª—å£æ¡†æ¶)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: é”€å”®æ’ååˆ†æï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-é”€å”®æ’ååˆ†æçœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: ç§»åŠ¨å¹³å‡è®¡ç®—ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-ç§»åŠ¨å¹³å‡è®¡ç®—çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 çª—å£å‡½æ•°ä½¿ç”¨](#51-çª—å£å‡½æ•°ä½¿ç”¨)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**çª—å£å‡½æ•°çš„ä»·å€¼**:

PostgreSQL çª—å£å‡½æ•°æä¾›äº†åœ¨æŸ¥è¯¢ç»“æœé›†ä¸Šæ‰§è¡Œè®¡ç®—çš„èƒ½åŠ›ï¼š

1. **åˆ†ç»„è®¡ç®—**: åœ¨åˆ†ç»„å†…è¿›è¡Œè®¡ç®—
2. **æ’åæ’åº**: å®ç°æ’åå’Œæ’åº
3. **ç´¯è®¡ç»Ÿè®¡**: è®¡ç®—ç´¯è®¡å€¼ã€ç§»åŠ¨å¹³å‡
4. **å‰åå¯¹æ¯”**: å¯¹æ¯”å‰åè¡Œçš„å€¼

**åº”ç”¨åœºæ™¯**:

- **æ’ååˆ†æ**: è®¡ç®—æ’åã€ç™¾åˆ†æ¯”æ’å
- **ç´¯è®¡ç»Ÿè®¡**: è®¡ç®—ç´¯è®¡å€¼ã€ç§»åŠ¨å¹³å‡
- **å‰åå¯¹æ¯”**: å¯¹æ¯”å‰åè¡Œçš„å€¼
- **åˆ†ç»„ç»Ÿè®¡**: åœ¨åˆ†ç»„å†…è¿›è¡Œç»Ÿè®¡

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | é¿å…å­æŸ¥è¯¢æå‡æ€§èƒ½ | **+60%** |
| **ä»£ç ç®€åŒ–** | ç®€åŒ–å¤æ‚æŸ¥è¯¢ | **-50%** |
| **åŠŸèƒ½å¼ºå¤§** | å¼ºå¤§çš„åˆ†æåŠŸèƒ½ | **é«˜** |
| **æ˜“ç”¨æ€§** | ç®€å•æ˜“ç”¨çš„è¯­æ³• | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æŸ¥è¯¢æ€§èƒ½**: é¿å…å­æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ 60%
- **ä»£ç ç®€åŒ–**: ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼Œå‡å°‘ä»£ç é‡ 50%
- **åŠŸèƒ½å¼ºå¤§**: å¼ºå¤§çš„åˆ†æåŠŸèƒ½
- **æ˜“ç”¨æ€§**: ç®€å•æ˜“ç”¨çš„è¯­æ³•

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡çª—å£å‡½æ•°çš„è¯­æ³•å’Œä½¿ç”¨
- ç†è§£çª—å£å‡½æ•°çš„åº”ç”¨åœºæ™¯
- å­¦ä¼šçª—å£å‡½æ•°ä¼˜åŒ–
- æŒæ¡å®é™…åº”ç”¨æ¡ˆä¾‹

### 1.4 çª—å£å‡½æ•°ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((çª—å£å‡½æ•°ä½“ç³»))
    çª—å£å‡½æ•°ç±»å‹
      æ’åå‡½æ•°
        ROW_NUMBER
        RANK
        DENSE_RANK
        PERCENT_RANK
        CUME_DIST
      èšåˆå‡½æ•°
        SUM
        AVG
        COUNT
        MAX
        MIN
      å€¼å‡½æ•°
        LAG
        LEAD
        FIRST_VALUE
        LAST_VALUE
        NTH_VALUE
    çª—å£å®šä¹‰
      PARTITION BY
        åˆ†ç»„çª—å£
        ç‹¬ç«‹è®¡ç®—
        åˆ†ç»„ç»Ÿè®¡
      ORDER BY
        æ’åºçª—å£
        ç´¯è®¡è®¡ç®—
        æ’åè®¡ç®—
      ROWS/RANGE
        ROWS BETWEEN
        RANGE BETWEEN
        çª—å£æ¡†æ¶
    çª—å£å‡½æ•°åº”ç”¨
      æ’ååˆ†æ
        æ’åè®¡ç®—
        ç™¾åˆ†æ¯”æ’å
        åˆ†ç»„æ’å
      ç´¯è®¡ç»Ÿè®¡
        ç´¯è®¡æ±‚å’Œ
        ç§»åŠ¨å¹³å‡
        ç´¯è®¡è®¡æ•°
      å‰åå¯¹æ¯”
        å‰åå€¼å¯¹æ¯”
        å·®å€¼è®¡ç®—
        è¶‹åŠ¿åˆ†æ
    æ€§èƒ½ä¼˜åŒ–
      çª—å£å‡½æ•°ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        åˆ†åŒºä¼˜åŒ–
        æ¡†æ¶ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–
        é¿å…é‡å¤è®¡ç®—
        ä¼˜åŒ–çª—å£å®šä¹‰
        å¹¶è¡Œæ‰§è¡Œ
```

## 2. çª—å£å‡½æ•°åŸºç¡€

### 2.1 çª—å£å‡½æ•°è¯­æ³•

**åŸºæœ¬è¯­æ³•**:

```sql
-- çª—å£å‡½æ•°åŸºæœ¬è¯­æ³•
SELECT
    column1,
    column2,
    window_function() OVER (
        PARTITION BY column1
        ORDER BY column2
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS result
FROM table_name;
```

### 2.2 çª—å£å‡½æ•°ç±»å‹

**æ’åå‡½æ•°**:

```sql
-- ROW_NUMBER(): è¡Œå·
SELECT
    id,
    name,
    score,
    ROW_NUMBER() OVER (ORDER BY score DESC) AS rank
FROM students;

-- RANK(): æ’åï¼ˆç›¸åŒå€¼ç›¸åŒæ’åï¼Œè·³è¿‡åç»­æ’åï¼‰
SELECT
    id,
    name,
    score,
    RANK() OVER (ORDER BY score DESC) AS rank
FROM students;

-- DENSE_RANK(): å¯†é›†æ’åï¼ˆç›¸åŒå€¼ç›¸åŒæ’åï¼Œä¸è·³è¿‡ï¼‰
SELECT
    id,
    name,
    score,
    DENSE_RANK() OVER (ORDER BY score DESC) AS rank
FROM students;

-- PERCENT_RANK(): ç™¾åˆ†æ¯”æ’å
SELECT
    id,
    name,
    score,
    PERCENT_RANK() OVER (ORDER BY score DESC) AS rank
FROM students;
```

**èšåˆå‡½æ•°**:

```sql
-- SUM(): ç´¯è®¡å’Œ
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date) AS cumulative_sum
FROM sales;

-- AVG(): ç§»åŠ¨å¹³å‡
SELECT
    date,
    amount,
    AVG(amount) OVER (
        ORDER BY date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg
FROM sales;

-- COUNT(): ç´¯è®¡è®¡æ•°
SELECT
    date,
    amount,
    COUNT(*) OVER (ORDER BY date) AS cumulative_count
FROM sales;
```

**å€¼å‡½æ•°**:

```sql
-- LAG(): å‰ä¸€è¡Œ
SELECT
    date,
    amount,
    LAG(amount, 1) OVER (ORDER BY date) AS prev_amount
FROM sales;

-- LEAD(): åä¸€è¡Œ
SELECT
    date,
    amount,
    LEAD(amount, 1) OVER (ORDER BY date) AS next_amount
FROM sales;

-- FIRST_VALUE(): ç¬¬ä¸€è¡Œ
SELECT
    date,
    amount,
    FIRST_VALUE(amount) OVER (ORDER BY date) AS first_amount
FROM sales;

-- LAST_VALUE(): æœ€åä¸€è¡Œ
SELECT
    date,
    amount,
    LAST_VALUE(amount) OVER (
        ORDER BY date
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS last_amount
FROM sales;
```

## 3. çª—å£å‡½æ•°åº”ç”¨

### 3.1 PARTITION BY

**PARTITION BY å­å¥**:

```sql
-- æŒ‰éƒ¨é—¨åˆ†ç»„è®¡ç®—æ’å
SELECT
    department,
    name,
    salary,
    RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dept_rank
FROM employees;
```

### 3.2 ORDER BY

**ORDER BY å­å¥**:

```sql
-- æŒ‰æ—¥æœŸæ’åºè®¡ç®—ç´¯è®¡å€¼
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date) AS cumulative_sum
FROM sales;
```

### 3.3 çª—å£æ¡†æ¶

**çª—å£æ¡†æ¶**:

```sql
-- ROWS BETWEEN: è¡ŒèŒƒå›´
SELECT
    date,
    amount,
    AVG(amount) OVER (
        ORDER BY date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg
FROM sales;

-- RANGE BETWEEN: å€¼èŒƒå›´
SELECT
    date,
    amount,
    AVG(amount) OVER (
        ORDER BY date
        RANGE BETWEEN INTERVAL '7 days' PRECEDING AND CURRENT ROW
    ) AS moving_avg
FROM sales;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: é”€å”®æ’ååˆ†æï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦åˆ†æé”€å”®æ’åï¼Œæ‰¾å‡ºæ¯ä¸ªç±»åˆ«çš„é”€å”®å† å†›ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ’åè®¡ç®—**: éœ€è¦è®¡ç®—æ¯ä¸ªç±»åˆ«çš„æ’å
2. **æ€§èƒ½é—®é¢˜**: ä½¿ç”¨å­æŸ¥è¯¢æ€§èƒ½å·®
3. **ä»£ç å¤æ‚**: ä»£ç å¤æ‚éš¾ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ’å
SELECT
    category,
    product_name,
    sales_amount,
    RANK() OVER (
        PARTITION BY category
        ORDER BY sales_amount DESC
    ) AS category_rank,
    PERCENT_RANK() OVER (
        PARTITION BY category
        ORDER BY sales_amount DESC
    ) AS percentile_rank
FROM product_sales
WHERE sales_date >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY category, category_rank;

-- æ‰¾å‡ºæ¯ä¸ªç±»åˆ«çš„é”€å”®å† å†›
WITH ranked_products AS (
    SELECT
        category,
        product_name,
        sales_amount,
        RANK() OVER (
            PARTITION BY category
            ORDER BY sales_amount DESC
        ) AS category_rank
    FROM product_sales
    WHERE sales_date >= CURRENT_DATE - INTERVAL '30 days'
)
SELECT
    category,
    product_name,
    sales_amount
FROM ranked_products
WHERE category_rank = 1;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 3 ç§’ | **< 500ms** | **83%** â¬‡ï¸ |
| **ä»£ç è¡Œæ•°** | 50 è¡Œ | **15 è¡Œ** | **70%** â¬‡ï¸ |
| **å¯è¯»æ€§** | ä½ | **é«˜** | **æå‡** |

### 4.2 æ¡ˆä¾‹: ç§»åŠ¨å¹³å‡è®¡ç®—ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦è®¡ç®—è‚¡ç¥¨ä»·æ ¼çš„ç§»åŠ¨å¹³å‡ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- è®¡ç®—7æ—¥ç§»åŠ¨å¹³å‡
SELECT
    date,
    stock_price,
    AVG(stock_price) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_avg_7d,
    AVG(stock_price) OVER (
        ORDER BY date
        ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
    ) AS moving_avg_30d
FROM stock_prices
ORDER BY date DESC;
```

## 5. æœ€ä½³å®è·µ

### 5.1 çª—å£å‡½æ•°ä½¿ç”¨

1. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨çª—å£å‡½æ•°æ›¿ä»£å­æŸ¥è¯¢
2. **ç´¢å¼•**: ç¡®ä¿çª—å£å‡½æ•°ä½¿ç”¨ç´¢å¼•
3. **åˆ†åŒº**: åˆç†ä½¿ç”¨ PARTITION BY

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•**: ä¸º ORDER BY åˆ—åˆ›å»ºç´¢å¼•
2. **åˆ†åŒº**: åˆç†ä½¿ç”¨ PARTITION BY
3. **æ¡†æ¶**: é€‰æ‹©åˆé€‚çš„çª—å£æ¡†æ¶

## 6. å‚è€ƒèµ„æ–™

- [é«˜çº§SQLç‰¹æ€§](./é«˜çº§SQLç‰¹æ€§.md)
- [ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–](./ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-37
