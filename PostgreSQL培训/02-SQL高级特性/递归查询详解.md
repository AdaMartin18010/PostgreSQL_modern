# PostgreSQL é€’å½’æŸ¥è¯¢è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-38

## ğŸ“‘ ç›®å½•

- [PostgreSQL é€’å½’æŸ¥è¯¢è¯¦è§£](#postgresql-é€’å½’æŸ¥è¯¢è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 é€’å½’æŸ¥è¯¢å·¥ä½œåŸç†æ¦‚è¿°](#10-é€’å½’æŸ¥è¯¢å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾](#14-é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. é€’å½’æŸ¥è¯¢åŸºç¡€](#2-é€’å½’æŸ¥è¯¢åŸºç¡€)
    - [2.1 é€’å½’æŸ¥è¯¢è¯­æ³•](#21-é€’å½’æŸ¥è¯¢è¯­æ³•)
    - [2.2 é€’å½’æŸ¥è¯¢ç»“æ„](#22-é€’å½’æŸ¥è¯¢ç»“æ„)
  - [3. é€’å½’æŸ¥è¯¢åº”ç”¨](#3-é€’å½’æŸ¥è¯¢åº”ç”¨)
    - [3.1 æ ‘å½¢ç»“æ„æŸ¥è¯¢](#31-æ ‘å½¢ç»“æ„æŸ¥è¯¢)
    - [3.2 è·¯å¾„æŸ¥æ‰¾](#32-è·¯å¾„æŸ¥æ‰¾)
    - [3.3 ç´¯è®¡è®¡ç®—](#33-ç´¯è®¡è®¡ç®—)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-ç»„ç»‡æ¶æ„æŸ¥è¯¢çœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: è¯„è®ºå›å¤æ ‘ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-è¯„è®ºå›å¤æ ‘çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é€’å½’æŸ¥è¯¢ä½¿ç”¨](#51-é€’å½’æŸ¥è¯¢ä½¿ç”¨)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [SQL æ ‡å‡†](#sql-æ ‡å‡†)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 é€’å½’æŸ¥è¯¢å·¥ä½œåŸç†æ¦‚è¿°

**é€’å½’æŸ¥è¯¢çš„æœ¬è´¨**ï¼š

é€’å½’æŸ¥è¯¢ï¼ˆRecursive Queryï¼‰æ˜¯ SQL æ ‡å‡†ä¸­çš„é«˜çº§ç‰¹æ€§ï¼Œé€šè¿‡ WITH RECURSIVE è¯­æ³•å®ç°ã€‚å®ƒå…è®¸æŸ¥è¯¢åœ¨ç»“æœé›†ä¸Šé€’å½’åœ°å¼•ç”¨è‡ªèº«ï¼Œä»è€Œå¤„ç†å±‚æ¬¡ç»“æ„ã€æ ‘å½¢æ•°æ®ã€å›¾éå†ç­‰å¤æ‚åœºæ™¯ã€‚é€’å½’æŸ¥è¯¢ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šé”šç‚¹æŸ¥è¯¢ï¼ˆåˆå§‹æŸ¥è¯¢ï¼‰å’Œé€’å½’æŸ¥è¯¢ï¼ˆé€’å½’éƒ¨åˆ†ï¼‰ã€‚

**é€’å½’æŸ¥è¯¢æ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢å¼€å§‹] --> B[æ‰§è¡Œé”šç‚¹æŸ¥è¯¢]
    B --> C[ç”Ÿæˆåˆå§‹ç»“æœé›†]
    C --> D[æ‰§è¡Œé€’å½’æŸ¥è¯¢]
    D --> E{æœ‰ç»“æœ?}
    E -->|æ˜¯| F[åˆå¹¶ç»“æœ]
    E -->|å¦| G[è¿”å›æœ€ç»ˆç»“æœ]
    F --> H{ç»ˆæ­¢æ¡ä»¶?}
    H -->|å¦| D
    H -->|æ˜¯| G

    style B fill:#FFD700
    style D fill:#90EE90
    style G fill:#87CEEB
```

**é€’å½’æŸ¥è¯¢æ‰§è¡Œæ­¥éª¤**ï¼š

1. **é”šç‚¹æŸ¥è¯¢**ï¼šæ‰§è¡Œåˆå§‹æŸ¥è¯¢ï¼Œç”ŸæˆåŸºç¡€ç»“æœé›†
2. **é€’å½’æŸ¥è¯¢**ï¼šåŸºäºå‰ä¸€æ¬¡çš„ç»“æœé›†æ‰§è¡Œé€’å½’æŸ¥è¯¢
3. **ç»“æœåˆå¹¶**ï¼šä½¿ç”¨ UNION ALL åˆå¹¶ç»“æœ
4. **ç»ˆæ­¢æ¡ä»¶**ï¼šæ£€æŸ¥ç»ˆæ­¢æ¡ä»¶ï¼ˆæ— æ–°ç»“æœæˆ–è¾¾åˆ°æ·±åº¦é™åˆ¶ï¼‰
5. **è¿”å›ç»“æœ**ï¼šè¿”å›æœ€ç»ˆåˆå¹¶çš„ç»“æœé›†

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é€’å½’æŸ¥è¯¢çš„ä»·å€¼**:

PostgreSQL é€’å½’æŸ¥è¯¢ï¼ˆWITH RECURSIVEï¼‰æä¾›äº†å¤„ç†å±‚æ¬¡ç»“æ„æ•°æ®çš„èƒ½åŠ›ï¼š

1. **å±‚æ¬¡ç»“æ„**: å¤„ç†æ ‘å½¢ç»“æ„ã€ç»„ç»‡æ¶æ„
2. **å›¾éå†**: éå†å›¾ç»“æ„æ•°æ®
3. **ç´¯è®¡è®¡ç®—**: è®¡ç®—ç´¯è®¡å€¼
4. **è·¯å¾„æŸ¥æ‰¾**: æŸ¥æ‰¾è·¯å¾„

**åº”ç”¨åœºæ™¯**:

- **ç»„ç»‡æ¶æ„**: æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘
- **åˆ†ç±»æ ‘**: æŸ¥è¯¢åˆ†ç±»æ ‘
- **è¯„è®ºå›å¤**: æŸ¥è¯¢è¯„è®ºå›å¤æ ‘
- **è·¯å¾„æŸ¥æ‰¾**: æŸ¥æ‰¾è·¯å¾„

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | é¿å…å¤šæ¬¡æŸ¥è¯¢æå‡æ€§èƒ½ | **+70%** |
| **ä»£ç ç®€åŒ–** | ç®€åŒ–å¤æ‚æŸ¥è¯¢ | **-60%** |
| **åŠŸèƒ½å¼ºå¤§** | å¼ºå¤§çš„å±‚æ¬¡æŸ¥è¯¢åŠŸèƒ½ | **é«˜** |
| **æ˜“ç”¨æ€§** | ç®€å•æ˜“ç”¨çš„è¯­æ³• | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æŸ¥è¯¢æ€§èƒ½**: é¿å…å¤šæ¬¡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ 70%
- **ä»£ç ç®€åŒ–**: ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼Œå‡å°‘ä»£ç é‡ 60%
- **åŠŸèƒ½å¼ºå¤§**: å¼ºå¤§çš„å±‚æ¬¡æŸ¥è¯¢åŠŸèƒ½
- **æ˜“ç”¨æ€§**: ç®€å•æ˜“ç”¨çš„è¯­æ³•

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡é€’å½’æŸ¥è¯¢çš„è¯­æ³•å’Œä½¿ç”¨
- ç†è§£é€’å½’æŸ¥è¯¢çš„åº”ç”¨åœºæ™¯
- å­¦ä¼šé€’å½’æŸ¥è¯¢ä¼˜åŒ–
- æŒæ¡å®é™…åº”ç”¨æ¡ˆä¾‹

### 1.4 é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é€’å½’æŸ¥è¯¢ä½“ç³»))
    é€’å½’æŸ¥è¯¢ç»“æ„
      é”šç‚¹æŸ¥è¯¢
        åˆå§‹æŸ¥è¯¢
        èµ·å§‹ç‚¹
        åŸºç¡€æ•°æ®
      é€’å½’æŸ¥è¯¢
        é€’å½’éƒ¨åˆ†
        è¿æ¥æ¡ä»¶
        ç»ˆæ­¢æ¡ä»¶
      UNION/UNION ALL
        ç»“æœåˆå¹¶
        å»é‡/ä¸å»é‡
        ç»“æœé›†
    é€’å½’æŸ¥è¯¢ç±»å‹
      æ ‘å½¢ç»“æ„
        ç»„ç»‡æ¶æ„
        åˆ†ç±»æ ‘
        è¯„è®ºæ ‘
      å›¾éå†
        è·¯å¾„æŸ¥æ‰¾
        è¿é€šæ€§
        æœ€çŸ­è·¯å¾„
      ç´¯è®¡è®¡ç®—
        ç´¯è®¡æ±‚å’Œ
        ç´¯è®¡è®¡æ•°
        ç´¯è®¡ç»Ÿè®¡
    é€’å½’æŸ¥è¯¢åº”ç”¨
      å±‚æ¬¡æŸ¥è¯¢
        æŸ¥è¯¢å­æ ‘
        æŸ¥è¯¢è·¯å¾„
        æŸ¥è¯¢æ·±åº¦
      è·¯å¾„æŸ¥æ‰¾
        æœ€çŸ­è·¯å¾„
        æ‰€æœ‰è·¯å¾„
        è·¯å¾„ç»Ÿè®¡
      ç´¯è®¡è®¡ç®—
        ç´¯è®¡å€¼
        ç´¯è®¡ç»Ÿè®¡
        è¶‹åŠ¿åˆ†æ
    æ€§èƒ½ä¼˜åŒ–
      é€’å½’ä¼˜åŒ–
        æ·±åº¦é™åˆ¶
        å‰ªæä¼˜åŒ–
        ç´¢å¼•ä½¿ç”¨
      æŸ¥è¯¢ä¼˜åŒ–
        ä¼˜åŒ–é€’å½’æ¡ä»¶
        ä¼˜åŒ–è¿æ¥æ¡ä»¶
        å¹¶è¡Œæ‰§è¡Œ
```

## 2. é€’å½’æŸ¥è¯¢åŸºç¡€

### 2.1 é€’å½’æŸ¥è¯¢è¯­æ³•

**åŸºæœ¬è¯­æ³•**:

```sql
WITH RECURSIVE recursive_query AS (
    -- åˆå§‹æŸ¥è¯¢ï¼ˆé”šç‚¹ï¼‰
    SELECT ...
    FROM ...
    WHERE ...

    UNION ALL

    -- é€’å½’æŸ¥è¯¢
    SELECT ...
    FROM recursive_query
    JOIN ...
    WHERE ...
)
SELECT * FROM recursive_query;
```

### 2.2 é€’å½’æŸ¥è¯¢ç»“æ„

**é€’å½’æŸ¥è¯¢ç»“æ„**:

```sql
-- æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘
WITH RECURSIVE org_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šæ ¹èŠ‚ç‚¹
    SELECT
        id,
        name,
        parent_id,
        1 AS level,
        ARRAY[id] AS path
    FROM organizations
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå­èŠ‚ç‚¹
    SELECT
        o.id,
        o.name,
        o.parent_id,
        ot.level + 1,
        ot.path || o.id
    FROM organizations o
    JOIN org_tree ot ON o.parent_id = ot.id
)
SELECT * FROM org_tree;
```

## 3. é€’å½’æŸ¥è¯¢åº”ç”¨

### 3.1 æ ‘å½¢ç»“æ„æŸ¥è¯¢

**æ ‘å½¢ç»“æ„æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢æ‰€æœ‰å­èŠ‚ç‚¹
WITH RECURSIVE subtree AS (
    SELECT id, name, parent_id
    FROM categories
    WHERE id = 1

    UNION ALL

    SELECT c.id, c.name, c.parent_id
    FROM categories c
    JOIN subtree s ON c.parent_id = s.id
)
SELECT * FROM subtree;
```

### 3.2 è·¯å¾„æŸ¥æ‰¾

**è·¯å¾„æŸ¥æ‰¾**:

```sql
-- æŸ¥æ‰¾ä»èŠ‚ç‚¹Aåˆ°èŠ‚ç‚¹Bçš„è·¯å¾„
WITH RECURSIVE path_search AS (
    SELECT
        id,
        name,
        parent_id,
        ARRAY[id] AS path
    FROM nodes
    WHERE id = 1

    UNION ALL

    SELECT
        n.id,
        n.name,
        n.parent_id,
        ps.path || n.id
    FROM nodes n
    JOIN path_search ps ON n.parent_id = ps.id
    WHERE n.id != ALL(ps.path)  -- é¿å…å¾ªç¯
)
SELECT * FROM path_search WHERE id = 10;
```

### 3.3 ç´¯è®¡è®¡ç®—

**ç´¯è®¡è®¡ç®—**:

```sql
-- è®¡ç®—ç´¯è®¡å€¼
WITH RECURSIVE cumulative AS (
    SELECT
        date,
        amount,
        amount AS cumulative_amount
    FROM sales
    WHERE date = (SELECT MIN(date) FROM sales)

    UNION ALL

    SELECT
        s.date,
        s.amount,
        c.cumulative_amount + s.amount
    FROM sales s
    JOIN cumulative c ON s.date = c.date + INTERVAL '1 day'
)
SELECT * FROM cumulative;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘ï¼Œæ‰¾å‡ºæŸä¸ªéƒ¨é—¨çš„æ‰€æœ‰å­éƒ¨é—¨ã€‚

**é—®é¢˜åˆ†æ**:

1. **å±‚æ¬¡ç»“æ„**: éœ€è¦å¤„ç†å¤šå±‚æ¬¡çš„éƒ¨é—¨ç»“æ„
2. **æ€§èƒ½é—®é¢˜**: ä½¿ç”¨å¤šæ¬¡æŸ¥è¯¢æ€§èƒ½å·®
3. **ä»£ç å¤æ‚**: ä»£ç å¤æ‚éš¾ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æŸ¥è¯¢éƒ¨é—¨æ ‘
WITH RECURSIVE dept_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šæ ¹éƒ¨é—¨
    SELECT
        id,
        name,
        parent_id,
        1 AS level,
        name AS path
    FROM departments
    WHERE id = 1

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå­éƒ¨é—¨
    SELECT
        d.id,
        d.name,
        d.parent_id,
        dt.level + 1,
        dt.path || ' > ' || d.name
    FROM departments d
    JOIN dept_tree dt ON d.parent_id = dt.id
)
SELECT
    id,
    name,
    level,
    path
FROM dept_tree
ORDER BY level, name;

-- æŸ¥è¯¢æŸä¸ªéƒ¨é—¨çš„æ‰€æœ‰å­éƒ¨é—¨
WITH RECURSIVE sub_depts AS (
    SELECT id, name, parent_id
    FROM departments
    WHERE id = 5

    UNION ALL

    SELECT d.id, d.name, d.parent_id
    FROM departments d
    JOIN sub_depts sd ON d.parent_id = sd.id
)
SELECT * FROM sub_depts;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **ä»£ç è¡Œæ•°** | 80 è¡Œ | **20 è¡Œ** | **75%** â¬‡ï¸ |
| **å¯è¯»æ€§** | ä½ | **é«˜** | **æå‡** |

### 4.2 æ¡ˆä¾‹: è¯„è®ºå›å¤æ ‘ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸè®ºå›éœ€è¦æŸ¥è¯¢è¯„è®ºå›å¤æ ‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›å¤ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æŸ¥è¯¢è¯„è®ºå›å¤æ ‘
WITH RECURSIVE comment_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šé¡¶çº§è¯„è®º
    SELECT
        id,
        content,
        parent_id,
        user_id,
        1 AS level,
        ARRAY[id] AS path
    FROM comments
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå›å¤
    SELECT
        c.id,
        c.content,
        c.parent_id,
        c.user_id,
        ct.level + 1,
        ct.path || c.id
    FROM comments c
    JOIN comment_tree ct ON c.parent_id = ct.id
)
SELECT
    id,
    content,
    level,
    path
FROM comment_tree
ORDER BY path;
```

## 5. æœ€ä½³å®è·µ

### 5.1 é€’å½’æŸ¥è¯¢ä½¿ç”¨

**æ¨èåšæ³•**ï¼š

1. **ç¡®ä¿é€’å½’æŸ¥è¯¢æœ‰ç»ˆæ­¢æ¡ä»¶**ï¼ˆé¿å…æ— é™é€’å½’ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ç»ˆæ­¢æ¡ä»¶ï¼ˆé¿å…æ— é™é€’å½’ï¼‰
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id, 1 AS level
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id, dt.level + 1
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
       WHERE dt.level < 10  -- ç»ˆæ­¢æ¡ä»¶ï¼šé™åˆ¶æ·±åº¦
   )
   SELECT * FROM dept_tree;

   -- âŒ ä¸å¥½ï¼šæ²¡æœ‰ç»ˆæ­¢æ¡ä»¶ï¼ˆå¯èƒ½å¯¼è‡´æ— é™é€’å½’ï¼‰
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
       -- ç¼ºå°‘ç»ˆæ­¢æ¡ä»¶
   )
   SELECT * FROM dept_tree;
   ```

2. **ä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯**ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
   WITH RECURSIVE path_search AS (
       SELECT id, name, parent_id, ARRAY[id] AS path
       FROM nodes
       WHERE id = 1

       UNION ALL

       SELECT n.id, n.name, n.parent_id, ps.path || n.id
       FROM nodes n
       JOIN path_search ps ON n.parent_id = ps.id
       WHERE n.id != ALL(ps.path)  -- é¿å…å¾ªç¯
   )
   SELECT * FROM path_search;

   -- âŒ ä¸å¥½ï¼šä¸ä½¿ç”¨è·¯å¾„æ£€æŸ¥ï¼ˆå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼‰
   WITH RECURSIVE path_search AS (
       SELECT id, name, parent_id
       FROM nodes
       WHERE id = 1

       UNION ALL

       SELECT n.id, n.name, n.parent_id
       FROM nodes n
       JOIN path_search ps ON n.parent_id = ps.id
       -- ç¼ºå°‘è·¯å¾„æ£€æŸ¥
   )
   SELECT * FROM path_search;
   ```

3. **ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–é€’å½’æŸ¥è¯¢**ï¼ˆæå‡æ€§èƒ½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä¸ºè¿æ¥åˆ—åˆ›å»ºç´¢å¼•ï¼ˆæå‡æ€§èƒ½ï¼‰
   CREATE INDEX idx_departments_parent_id ON departments(parent_id);

   -- é€’å½’æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç´¢å¼•
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
   )
   SELECT * FROM dept_tree;
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…æ²¡æœ‰ç»ˆæ­¢æ¡ä»¶**ï¼ˆå¯èƒ½å¯¼è‡´æ— é™é€’å½’ï¼‰
2. **é¿å…å¿½ç•¥è·¯å¾„æ£€æŸ¥**ï¼ˆå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼‰
3. **é¿å…å¿½ç•¥ç´¢å¼•**ï¼ˆé€’å½’æŸ¥è¯¢æ€§èƒ½å·®ï¼‰

### 5.2 æ€§èƒ½ä¼˜åŒ–

**æ¨èåšæ³•**ï¼š

1. **ä¸ºè¿æ¥åˆ—åˆ›å»ºç´¢å¼•**ï¼ˆæå‡æ€§èƒ½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä¸ºè¿æ¥åˆ—åˆ›å»ºç´¢å¼•ï¼ˆæå‡æ€§èƒ½ï¼‰
   CREATE INDEX idx_departments_parent_id ON departments(parent_id);
   CREATE INDEX idx_nodes_parent_id ON nodes(parent_id);

   -- é€’å½’æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç´¢å¼•
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
   )
   SELECT * FROM dept_tree;
   ```

2. **é™åˆ¶é€’å½’æ·±åº¦**ï¼ˆé¿å…æ·±åº¦é€’å½’ï¼‰

   ```sql
   -- âœ… å¥½ï¼šé™åˆ¶é€’å½’æ·±åº¦ï¼ˆé¿å…æ·±åº¦é€’å½’ï¼‰
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id, 1 AS level
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id, dt.level + 1
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
       WHERE dt.level < 10  -- é™åˆ¶æ·±åº¦
   )
   SELECT * FROM dept_tree;

   -- âŒ ä¸å¥½ï¼šä¸é™åˆ¶æ·±åº¦ï¼ˆå¯èƒ½å¯¼è‡´æ·±åº¦é€’å½’ï¼‰
   WITH RECURSIVE dept_tree AS (
       SELECT id, name, parent_id
       FROM departments
       WHERE id = 1

       UNION ALL

       SELECT d.id, d.name, d.parent_id
       FROM departments d
       JOIN dept_tree dt ON d.parent_id = dt.id
       -- ä¸é™åˆ¶æ·±åº¦
   )
   SELECT * FROM dept_tree;
   ```

3. **ä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯**ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
   WITH RECURSIVE path_search AS (
       SELECT id, name, parent_id, ARRAY[id] AS path
       FROM nodes
       WHERE id = 1

       UNION ALL

       SELECT n.id, n.name, n.parent_id, ps.path || n.id
       FROM nodes n
       JOIN path_search ps ON n.parent_id = ps.id
       WHERE n.id != ALL(ps.path)  -- é¿å…å¾ªç¯
   )
   SELECT * FROM path_search;
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…å¿½ç•¥ç´¢å¼•**ï¼ˆé€’å½’æŸ¥è¯¢æ€§èƒ½å·®ï¼‰
2. **é¿å…ä¸é™åˆ¶æ·±åº¦**ï¼ˆå¯èƒ½å¯¼è‡´æ·±åº¦é€’å½’ï¼‰
3. **é¿å…å¿½ç•¥è·¯å¾„æ£€æŸ¥**ï¼ˆå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼‰

## 6. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€’å½’æŸ¥è¯¢](https://www.postgresql.org/docs/current/queries-with.html)**
  - é€’å½’æŸ¥è¯¢å®Œæ•´æ•™ç¨‹
  - è¯­æ³•å’Œç¤ºä¾‹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - WITH RECURSIVE](https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-RECURSIVE)**
  - WITH RECURSIVE è¯­æ³•è¯¦è§£
  - é€’å½’æŸ¥è¯¢è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€’å½’æŸ¥è¯¢ç¤ºä¾‹](https://www.postgresql.org/docs/current/tutorial-recursive.html)**
  - é€’å½’æŸ¥è¯¢ç¤ºä¾‹
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### SQL æ ‡å‡†

- **ISO/IEC 9075:2016 - SQL æ ‡å‡†é€’å½’æŸ¥è¯¢**
  - SQL æ ‡å‡†é€’å½’æŸ¥è¯¢è§„èŒƒ
  - é€’å½’æŸ¥è¯¢æ ‡å‡†è¯­æ³•

### æŠ€æœ¯è®ºæ–‡

- **Leis, V., et al. (2015). "How Good Are Query Optimizers?"**
  - ä¼šè®®: SIGMOD 2015
  - è®ºæ–‡é“¾æ¥: [arXiv:1504.01155](https://arxiv.org/abs/1504.01155)
  - **é‡è¦æ€§**: ç°ä»£æŸ¥è¯¢ä¼˜åŒ–å™¨æ€§èƒ½è¯„ä¼°ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°è¯„ä¼°äº†ç°ä»£æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬é€’å½’æŸ¥è¯¢çš„ä¼˜åŒ–

- **Graefe, G. (1995). "The Cascades Framework for Query Optimization."**
  - æœŸåˆŠ: IEEE Data Engineering Bulletin, 18(3), 19-29
  - **é‡è¦æ€§**: æŸ¥è¯¢ä¼˜åŒ–å™¨æ¡†æ¶è®¾è®¡çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº† Cascades æŸ¥è¯¢ä¼˜åŒ–æ¡†æ¶ï¼Œå½±å“äº†ç°ä»£æ•°æ®åº“ä¼˜åŒ–å™¨çš„è®¾è®¡

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é€’å½’æŸ¥è¯¢](https://www.postgresql.org/docs/current/queries-with.html)**
  - é€’å½’æŸ¥è¯¢æœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL é€’å½’æŸ¥è¯¢](https://www.2ndquadrant.com/en/blog/postgresql-recursive-queries/)**
  - é€’å½’æŸ¥è¯¢å®æˆ˜
  - æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

- **[Percona - PostgreSQL é€’å½’æŸ¥è¯¢](https://www.percona.com/blog/postgresql-recursive-queries/)**
  - é€’å½’æŸ¥è¯¢ä½¿ç”¨æŠ€å·§
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[EnterpriseDB - PostgreSQL é€’å½’æŸ¥è¯¢](https://www.enterprisedb.com/postgres-tutorials/postgresql-recursive-queries-tutorial)**
  - é€’å½’æŸ¥è¯¢æ·±å…¥è§£æ
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - é€’å½’æŸ¥è¯¢](https://wiki.postgresql.org/wiki/Recursive_queries)**
  - é€’å½’æŸ¥è¯¢æŠ€å·§
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL é€’å½’æŸ¥è¯¢](https://stackoverflow.com/questions/tagged/postgresql+recursive)**
  - é€’å½’æŸ¥è¯¢é—®ç­”
  - å¸¸è§é—®é¢˜è§£ç­”

### ç›¸å…³æ–‡æ¡£

- [é«˜çº§SQLç‰¹æ€§](./é«˜çº§SQLç‰¹æ€§.md)
- [CTEè¯¦è§£](./CTEè¯¦è§£.md)
- [çª—å£å‡½æ•°è¯¦è§£](./çª—å£å‡½æ•°è¯¦è§£.md)
- [ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–](../01-SQLåŸºç¡€/ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-38
