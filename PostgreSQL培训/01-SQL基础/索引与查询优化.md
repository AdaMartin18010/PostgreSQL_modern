# PostgreSQL ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-03

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–](#postgresql-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ€ç»´å¯¼å›¾](#2-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ¶æ„](#21-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ¶æ„)
  - [3. ç´¢å¼•ç±»å‹](#3-ç´¢å¼•ç±»å‹)
    - [3.1 B-tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰](#31-b-tree-ç´¢å¼•é»˜è®¤)
    - [3.2 Hash ç´¢å¼•](#32-hash-ç´¢å¼•)
    - [3.3 GiST ç´¢å¼•](#33-gist-ç´¢å¼•)
    - [3.4 GIN ç´¢å¼•](#34-gin-ç´¢å¼•)
    - [3.5 BRIN ç´¢å¼•](#35-brin-ç´¢å¼•)
  - [4. ç´¢å¼•åˆ›å»ºä¸ç®¡ç†](#4-ç´¢å¼•åˆ›å»ºä¸ç®¡ç†)
    - [4.1 ç´¢å¼•åˆ›å»ºæœ€ä½³å®è·µ](#41-ç´¢å¼•åˆ›å»ºæœ€ä½³å®è·µ)
    - [4.2 ç´¢å¼•ç»´æŠ¤](#42-ç´¢å¼•ç»´æŠ¤)
  - [5. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§](#5-æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§)
    - [5.1 ä½¿ç”¨ EXPLAIN åˆ†æ](#51-ä½¿ç”¨-explain-åˆ†æ)
    - [5.2 æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™](#52-æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™)
  - [6. EXPLAIN åˆ†æ](#6-explain-åˆ†æ)
    - [6.1 ç†è§£æ‰§è¡Œè®¡åˆ’](#61-ç†è§£æ‰§è¡Œè®¡åˆ’)
    - [6.2 æ€§èƒ½åˆ†æå·¥å…·](#62-æ€§èƒ½åˆ†æå·¥å…·)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#71-æ¡ˆä¾‹-ç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
    - [7.2 æ¡ˆä¾‹: æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#72-æ¡ˆä¾‹-æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
  - [8. å®è·µç»ƒä¹ ](#8-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºåˆé€‚çš„ç´¢å¼•](#ç»ƒä¹ -1-åˆ›å»ºåˆé€‚çš„ç´¢å¼•)
    - [ç»ƒä¹  2: ä¼˜åŒ–æ…¢æŸ¥è¯¢](#ç»ƒä¹ -2-ä¼˜åŒ–æ…¢æŸ¥è¯¢)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 ç´¢å¼•åˆ›å»ºåŸåˆ™](#91-ç´¢å¼•åˆ›å»ºåŸåˆ™)
    - [9.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®](#92-æŸ¥è¯¢ä¼˜åŒ–å»ºè®®)
  - [10. å‚è€ƒèµ„æ–™](#10-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–çš„ä»·å€¼**:

ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–æ˜¯æ•°æ®åº“æ€§èƒ½çš„æ ¸å¿ƒï¼Œç›´æ¥å½±å“æŸ¥è¯¢æ€§èƒ½ï¼š

1. **ç´¢å¼•ç±»å‹**: B-treeã€Hashã€GiSTã€GINã€BRIN ç­‰
2. **æŸ¥è¯¢ä¼˜åŒ–**: SQL æŸ¥è¯¢è¯­å¥ä¼˜åŒ–
3. **æ‰§è¡Œè®¡åˆ’**: EXPLAIN åˆ†ææ‰§è¡Œè®¡åˆ’
4. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ä¼˜åŒ–**: æå‡æŸ¥è¯¢æ€§èƒ½
- **é«˜å¹¶å‘**: æ”¯æŒé«˜å¹¶å‘æŸ¥è¯¢
- **å¤§æ•°æ®**: å¤„ç†å¤§æ•°æ®é‡æŸ¥è¯¢
- **å®æ—¶æŸ¥è¯¢**: å®æ—¶æŸ¥è¯¢å“åº”

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½ | **10-1000x** |
| **å†™å…¥æ€§èƒ½** | ç´¢å¼•å½±å“å†™å…¥æ€§èƒ½ | **-10-30%** |
| **å­˜å‚¨ç©ºé—´** | ç´¢å¼•å ç”¨å­˜å‚¨ç©ºé—´ | **+20-50%** |
| **å¼€å‘æ•ˆç‡** | ä¼˜åŒ–æå‡å¼€å‘æ•ˆç‡ | **+50%** |

## 2. ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–))
    ç´¢å¼•ç±»å‹
      B-tree
        ç­‰å€¼æŸ¥è¯¢
        èŒƒå›´æŸ¥è¯¢
        æ’åºæŸ¥è¯¢
        é»˜è®¤ç´¢å¼•
      Hash
        ç­‰å€¼æŸ¥è¯¢
        å¿«é€ŸæŸ¥æ‰¾
        å†…å­˜ç´¢å¼•
      GiST
        ç©ºé—´ç´¢å¼•
        èŒƒå›´ç´¢å¼•
        å…¨æ–‡æœç´¢
        è‡ªå®šä¹‰ç±»å‹
      GIN
        å…¨æ–‡æœç´¢
        æ•°ç»„ç´¢å¼•
        JSONBç´¢å¼•
        å¤šå€¼ç´¢å¼•
      BRIN
        å¤§è¡¨ç´¢å¼•
        å—èŒƒå›´ç´¢å¼•
        æ—¶åºæ•°æ®
        ä½ç»´æŠ¤æˆæœ¬
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢é‡å†™
        å­æŸ¥è¯¢ä¼˜åŒ–
        JOINä¼˜åŒ–
        è°“è¯ä¸‹æ¨
        å¸¸é‡æŠ˜å 
      æ‰§è¡Œè®¡åˆ’
        EXPLAINåˆ†æ
        è®¡åˆ’ç¼“å­˜
        å‚æ•°åŒ–æŸ¥è¯¢
        å¹¶è¡ŒæŸ¥è¯¢
      ç»Ÿè®¡ä¿¡æ¯
        ANALYZE
        ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
        ç›´æ–¹å›¾
        ç›¸å…³æ€§ç»Ÿè®¡
    ä¼˜åŒ–æŠ€å·§
      é¿å…SELECT *
        åªé€‰æ‹©éœ€è¦çš„åˆ—
        å‡å°‘æ•°æ®ä¼ è¾“
      ä½¿ç”¨ç´¢å¼•
        ä¸ºWHEREæ¡ä»¶åˆ›å»ºç´¢å¼•
        ä¸ºJOINå­—æ®µåˆ›å»ºç´¢å¼•
      ä½¿ç”¨LIMIT
        é™åˆ¶ç»“æœé›†å¤§å°
        æå‡æŸ¥è¯¢æ€§èƒ½
      æ‰¹é‡æ“ä½œ
        æ‰¹é‡INSERT
        æ‰¹é‡UPDATE
        æ‰¹é‡DELETE
```

## 3. ç´¢å¼•ç±»å‹

### 3.1 B-tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰

```sql
-- åŸºæœ¬ B-tree ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_email_unique ON users(email);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_users_name_age ON users(name, age);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ»¡è¶³æ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_active_users ON users(email) WHERE is_active = TRUE;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users(LOWER(email));
```

### 3.2 Hash ç´¢å¼•

```sql
-- Hash ç´¢å¼•ï¼ˆåªæ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼‰
CREATE INDEX idx_users_id_hash ON users USING HASH(id);

-- ä½¿ç”¨åœºæ™¯ï¼šç­‰å€¼æŸ¥è¯¢ï¼Œä¸æ’åº
SELECT * FROM users WHERE id = 123;
```

### 3.3 GiST ç´¢å¼•

```sql
-- GiST ç´¢å¼•ï¼ˆé€šç”¨æœç´¢æ ‘ï¼‰
CREATE INDEX idx_documents_content_gist ON documents USING GIST(content);

-- ç”¨äºå¤æ‚æ•°æ®ç±»å‹ï¼šå‡ ä½•ç±»å‹ã€å…¨æ–‡æœç´¢ç­‰
```

### 3.4 GIN ç´¢å¼•

```sql
-- GIN ç´¢å¼•ï¼ˆå€’æ’ç´¢å¼•ï¼‰
-- å…¨æ–‡æœç´¢
CREATE INDEX idx_documents_content_gin ON documents
USING GIN(to_tsvector('english', content));

-- æ•°ç»„
CREATE INDEX idx_users_tags_gin ON users USING GIN(tags);

-- JSONB
CREATE INDEX idx_products_metadata_gin ON products USING GIN(metadata);
```

### 3.5 BRIN ç´¢å¼•

```sql
-- BRIN ç´¢å¼•ï¼ˆå—èŒƒå›´ç´¢å¼•ï¼Œç”¨äºå¤§è¡¨ï¼‰
CREATE INDEX idx_orders_date_brin ON orders USING BRIN(order_date);

-- é€‚ç”¨äºï¼šå¤§è¡¨ã€æœ‰åºæ•°æ®ã€èŒƒå›´æŸ¥è¯¢
```

## 4. ç´¢å¼•åˆ›å»ºä¸ç®¡ç†

### 4.1 ç´¢å¼•åˆ›å»ºæœ€ä½³å®è·µ

```sql
-- 1. ä¸»é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•
CREATE TABLE users (
    id SERIAL PRIMARY KEY  -- è‡ªåŠ¨åˆ›å»ºä¸»é”®ç´¢å¼•
);

-- 2. å¤–é”®åˆ—åˆ›å»ºç´¢å¼•
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id)
);
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- 3. é¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_date ON orders(order_date);

-- 4. å¤åˆç´¢å¼•çš„é¡ºåºå¾ˆé‡è¦
-- æŸ¥è¯¢: WHERE status = 'active' AND created_at > '2024-01-01'
CREATE INDEX idx_orders_status_date ON orders(status, created_at);
-- status åœ¨å‰ï¼Œå› ä¸ºé€‰æ‹©æ€§æ›´é«˜

-- 5. è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_users_covering ON users(email) INCLUDE (name, age);
-- æŸ¥è¯¢åªéœ€è¦ email, name, age æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»ç´¢å¼•è·å–ï¼Œæ— éœ€å›è¡¨
```

### 4.2 ç´¢å¼•ç»´æŠ¤

```sql
-- æŸ¥çœ‹ç´¢å¼•
SELECT
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public';

-- é‡å»ºç´¢å¼•
REINDEX INDEX idx_users_email;

-- é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE users;

-- åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
DROP INDEX idx_unused_index;
```

## 5. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

### 5.1 ä½¿ç”¨ EXPLAIN åˆ†æ

```sql
-- EXPLAIN æ˜¾ç¤ºæŸ¥è¯¢è®¡åˆ’
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN ANALYZEï¼ˆå®é™…æ‰§è¡Œå¹¶æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼‰
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN VERBOSEï¼ˆæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼‰
EXPLAIN VERBOSE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN BUFFERSï¼ˆæ˜¾ç¤ºç¼“å†²åŒºä½¿ç”¨æƒ…å†µï¼‰
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE email = 'john@example.com';
```

### 5.2 æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™

```sql
-- 1. é¿å… SELECT *
SELECT id, name, email FROM users;  -- åªé€‰æ‹©éœ€è¦çš„åˆ—

-- 2. ä½¿ç”¨ LIMIT
SELECT * FROM users ORDER BY id LIMIT 10;  -- é™åˆ¶ç»“æœé›†å¤§å°

-- 3. ä½¿ç”¨ç´¢å¼•åˆ—è¿›è¡Œè¿‡æ»¤
SELECT * FROM users WHERE email = 'john@example.com';  -- email æœ‰ç´¢å¼•
-- è€Œä¸æ˜¯
SELECT * FROM users WHERE UPPER(email) = 'JOHN@EXAMPLE.COM';  -- å‡½æ•°è°ƒç”¨æ— æ³•ä½¿ç”¨ç´¢å¼•

-- 4. é¿å…åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨å‡½æ•°
-- ä¸å¥½
SELECT * FROM users WHERE EXTRACT(YEAR FROM created_at) = 2024;
-- å¥½
SELECT * FROM users WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01';

-- 5. ä½¿ç”¨ EXISTS è€Œä¸æ˜¯ INï¼ˆå¯¹äºå¤§å­æŸ¥è¯¢ï¼‰
-- ä¸å¥½
SELECT * FROM users WHERE id IN (SELECT user_id FROM orders);
-- å¥½
SELECT * FROM users WHERE EXISTS (SELECT 1 FROM orders WHERE orders.user_id = users.id);

-- 6. ä½¿ç”¨ JOIN è€Œä¸æ˜¯å­æŸ¥è¯¢
-- ä¸å¥½
SELECT name, (SELECT COUNT(*) FROM orders WHERE orders.user_id = users.id) FROM users;
-- å¥½
SELECT u.name, COUNT(o.id)
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;
```

## 6. EXPLAIN åˆ†æ

### 6.1 ç†è§£æ‰§è¡Œè®¡åˆ’

```sql
-- é¡ºåºæ‰«æï¼ˆSeq Scanï¼‰- å…¨è¡¨æ‰«æï¼Œæ…¢
EXPLAIN SELECT * FROM users WHERE name LIKE '%John%';

-- ç´¢å¼•æ‰«æï¼ˆIndex Scanï¼‰- ä½¿ç”¨ç´¢å¼•ï¼Œå¿«
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- ç´¢å¼•å”¯ä¸€æ‰«æï¼ˆIndex Only Scanï¼‰- åªä»ç´¢å¼•è·å–æ•°æ®ï¼Œæœ€å¿«
EXPLAIN SELECT email FROM users WHERE email = 'john@example.com';

-- ä½å›¾ç´¢å¼•æ‰«æï¼ˆBitmap Index Scanï¼‰- å¤šä¸ªæ¡ä»¶æ—¶ä½¿ç”¨
EXPLAIN SELECT * FROM users WHERE age > 25 AND age < 35;
```

### 6.2 æ€§èƒ½åˆ†æå·¥å…·

```sql
-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- é‡ç½®ç»Ÿè®¡ä¿¡æ¯
SELECT pg_stat_statements_reset();
```

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦ä¼˜åŒ–å•†å“æœç´¢æŸ¥è¯¢ï¼Œæå‡æœç´¢æ€§èƒ½ã€‚

**é—®é¢˜åˆ†æ**:

1. **æŸ¥è¯¢æ…¢**: å•†å“æœç´¢æŸ¥è¯¢è€—æ—¶5ç§’
2. **ç´¢å¼•ç¼ºå¤±**: ç¼ºå°‘åˆé€‚çš„ç´¢å¼•
3. **æ€§èƒ½é—®é¢˜**: æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆ

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_products_title_gin ON products
USING GIN(to_tsvector('chinese', title));

CREATE INDEX idx_products_description_gin ON products
USING GIN(to_tsvector('chinese', description));

-- 2. åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_products_embedding ON products
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 100);

-- 3. åˆ›å»ºæ ‡ç­¾æ•°ç»„ç´¢å¼•
CREATE INDEX idx_products_tags_gin ON products
USING GIN(tags);

-- 4. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
CREATE INDEX idx_products_category_status ON products(category, status)
INCLUDE (id, title, price);

-- 5. ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
-- ä¼˜åŒ–å‰: ç®€å•LIKEæŸ¥è¯¢ï¼ˆè€—æ—¶5ç§’ï¼‰
SELECT * FROM products
WHERE title LIKE '%keyword%' OR description LIKE '%keyword%'
ORDER BY created_at DESC;

-- ä¼˜åŒ–å: å…¨æ–‡æœç´¢+å‘é‡æœç´¢æ··åˆï¼ˆè€—æ—¶<200msï¼‰
SELECT
    id,
    title,
    price,
    category,
    ts_rank(to_tsvector('chinese', title || ' ' || description), query) AS text_rank,
    1 - (embedding <=> query_vector::vector) AS vector_similarity,
    (ts_rank(to_tsvector('chinese', title || ' ' || description), query) * 0.4 +
     1 - (embedding <=> query_vector::vector) * 0.6) AS combined_score
FROM products, to_tsquery('chinese', 'keyword') query
WHERE to_tsvector('chinese', title || ' ' || description) @@ query
    OR embedding <=> query_vector::vector < 0.7
ORDER BY combined_score DESC
LIMIT 20;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 5 ç§’ | **< 200ms** | **96%** â¬‡ï¸ |
| **ç´¢å¼•æ•°é‡** | 2 ä¸ª | **7 ä¸ª** | **å¢åŠ ** |
| **å­˜å‚¨ç©ºé—´** | åŸºå‡† | **+35%** | **å¢åŠ ** |
| **å†™å…¥æ€§èƒ½** | åŸºå‡† | **-15%** | **ç•¥é™** |

### 7.2 æ¡ˆä¾‹: æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸæ•°æ®åˆ†æç³»ç»Ÿéœ€è¦ä¼˜åŒ–å¤æ‚åˆ†ææŸ¥è¯¢ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_sales_summary AS
SELECT
    DATE_TRUNC('month', created_at) AS month,
    category,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_revenue,
    AVG(total_amount) AS avg_order_value
FROM orders
GROUP BY DATE_TRUNC('month', created_at), category;

CREATE UNIQUE INDEX ON mv_sales_summary (month, category);

-- 2. åˆ›å»ºåˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_sales_summary()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_summary;
END;
$$ LANGUAGE plpgsql;

-- 3. ä½¿ç”¨ç‰©åŒ–è§†å›¾æŸ¥è¯¢ï¼ˆæ€§èƒ½æå‡100å€ï¼‰
SELECT * FROM mv_sales_summary
WHERE month >= CURRENT_DATE - INTERVAL '12 months'
ORDER BY month DESC, total_revenue DESC;
```

## 8. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºåˆé€‚çš„ç´¢å¼•

```sql
-- ä»»åŠ¡: ä¸ºä»¥ä¸‹æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•
-- SELECT * FROM users WHERE email = 'john@example.com';
CREATE INDEX idx_users_email ON users(email);

-- SELECT * FROM orders WHERE user_id = 123 AND status = 'active';
CREATE INDEX idx_orders_user_status ON orders(user_id, status);

-- SELECT * FROM products WHERE category = 'electronics' AND price BETWEEN 100 AND 500;
CREATE INDEX idx_products_category_price ON products(category, price);
```

### ç»ƒä¹  2: ä¼˜åŒ–æ…¢æŸ¥è¯¢

```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT u.name, o.order_date, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email LIKE '%@example.com'
ORDER BY o.order_date DESC
LIMIT 100;

-- ä¼˜åŒ–æ­¥éª¤:
-- 1. åœ¨ users.email ä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- 2. åœ¨ orders.user_id å’Œ orders.order_date ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date DESC);

-- 3. å¦‚æœå¯èƒ½ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„è¿‡æ»¤æ¡ä»¶
SELECT u.name, o.order_date, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email LIKE 'user%@example.com'  -- æ›´å…·ä½“çš„æ¨¡å¼
ORDER BY o.order_date DESC
LIMIT 100;
```

## 9. æœ€ä½³å®è·µ

### 9.1 ç´¢å¼•åˆ›å»ºåŸåˆ™

1. **æŒ‰éœ€åˆ›å»º**: åªä¸ºéœ€è¦çš„æŸ¥è¯¢åˆ›å»ºç´¢å¼•
2. **å®šæœŸç»´æŠ¤**: å®šæœŸé‡å»ºå’Œæ›´æ–°ç´¢å¼•
3. **ç›‘æ§ä½¿ç”¨**: ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
4. **é¿å…è¿‡å¤š**: é¿å…åˆ›å»ºè¿‡å¤šç´¢å¼•

### 9.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨EXPLAIN**: ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
2. **ä¼˜åŒ–WHERE**: ä¼˜åŒ–WHEREæ¡ä»¶
3. **ä½¿ç”¨ç´¢å¼•**: ä¸ºWHEREæ¡ä»¶åˆ›å»ºç´¢å¼•
4. **é¿å…å‡½æ•°**: é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°

## 10. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç´¢å¼•](https://www.postgresql.org/docs/current/indexes.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æç¤º](https://www.postgresql.org/docs/current/performance-tips.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-03
