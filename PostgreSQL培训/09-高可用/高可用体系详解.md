# PostgreSQL é«˜å¯ç”¨ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-60

## ğŸ“‘ ç›®å½•

- [PostgreSQL é«˜å¯ç”¨ä½“ç³»è¯¦è§£](#postgresql-é«˜å¯ç”¨ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰](#2-é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰)
    - [2.0 é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰](#20-é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰)
    - [2.1 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å¯¹æ¯”çŸ©é˜µ](#21-é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å¯¹æ¯”çŸ©é˜µ)
  - [3. é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾](#3-é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾)
    - [3.1 é«˜å¯ç”¨ä½“ç³»æ¶æ„](#31-é«˜å¯ç”¨ä½“ç³»æ¶æ„)
    - [3.2 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹](#32-é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹)
  - [4. é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£](#4-é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£)
    - [4.1 æµå¤åˆ¶æ–¹æ¡ˆ](#41-æµå¤åˆ¶æ–¹æ¡ˆ)
    - [4.2 é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ](#42-é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ)
    - [4.3 Patroni é«˜å¯ç”¨æ–¹æ¡ˆ](#43-patroni-é«˜å¯ç”¨æ–¹æ¡ˆ)
    - [4.4 è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ](#44-è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
    - [5.2 æ¡ˆä¾‹: ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#52-æ¡ˆä¾‹-ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 é«˜å¯ç”¨è®¾è®¡åŸåˆ™](#61-é«˜å¯ç”¨è®¾è®¡åŸåˆ™)
    - [6.2 é«˜å¯ç”¨å»ºè®®](#62-é«˜å¯ç”¨å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1 å®˜æ–¹æ–‡æ¡£](#61-å®˜æ–¹æ–‡æ¡£)
    - [6.2 æŠ€æœ¯è®ºæ–‡](#62-æŠ€æœ¯è®ºæ–‡)
    - [6.3 æŠ€æœ¯åšå®¢](#63-æŠ€æœ¯åšå®¢)
    - [6.4 ç¤¾åŒºèµ„æº](#64-ç¤¾åŒºèµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é«˜å¯ç”¨ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œæ•´çš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼š

1. **æµå¤åˆ¶**: ä¸»ä»å¤åˆ¶ï¼Œæ•°æ®åŒæ­¥
2. **é€»è¾‘å¤åˆ¶**: è¡¨çº§å¤åˆ¶ï¼Œé€‰æ‹©æ€§å¤åˆ¶
3. **è‡ªåŠ¨æ•…éšœè½¬ç§»**: Patroniã€repmgrç­‰å·¥å…·
4. **è¯»å†™åˆ†ç¦»**: ä¸»ä»è¯»å†™åˆ†ç¦»
5. **è´Ÿè½½å‡è¡¡**: è¿æ¥è´Ÿè½½å‡è¡¡

**åº”ç”¨åœºæ™¯**:

- **ä¸šåŠ¡è¿ç»­æ€§**: ä¿è¯ä¸šåŠ¡è¿ç»­æ€§
- **æ•°æ®å®‰å…¨**: ä¿æŠ¤æ•°æ®å®‰å…¨
- **æ€§èƒ½æå‡**: æå‡è¯»å†™æ€§èƒ½
- **ç¾éš¾æ¢å¤**: æ”¯æŒç¾éš¾æ¢å¤

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å¯ç”¨æ€§** | é«˜å¯ç”¨æå‡å¯ç”¨æ€§ | **99.9%+** |
| **æ•…éšœæ¢å¤æ—¶é—´** | è‡ªåŠ¨æ•…éšœè½¬ç§» | **< 30ç§’** |
| **æ•°æ®ä¸¢å¤±** | åŒæ­¥å¤åˆ¶é›¶ä¸¢å¤± | **0** |
| **æ€§èƒ½æå‡** | è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½ | **+100%** |

## 2. é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰

### 2.0 é«˜å¯ç”¨å½¢å¼åŒ–å®šä¹‰

**é«˜å¯ç”¨çš„æœ¬è´¨**ï¼šé«˜å¯ç”¨ä½“ç³»æ˜¯é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•æ„å»ºå®Œæ•´çš„æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨è½¬ç§»å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œå®ç°æ•°æ®åº“ç³»ç»Ÿçš„æŒç»­å¯ç”¨æ€§ã€‚

**å®šä¹‰ 1ï¼ˆé«˜å¯ç”¨æ€§ï¼‰**ï¼š
è®¾ HighAvailability = {uptime, failover_time, data_loss, recovery_time}ï¼Œå…¶ä¸­ï¼š

- uptimeï¼šå¯ç”¨æ—¶é—´ï¼ˆ99.9%+ï¼‰
- failover_timeï¼šæ•…éšœè½¬ç§»æ—¶é—´ï¼ˆ<30ç§’ï¼‰
- data_lossï¼šæ•°æ®ä¸¢å¤±ï¼ˆ0æˆ–æœ€å°ï¼‰
- recovery_timeï¼šæ¢å¤æ—¶é—´ï¼ˆ<5åˆ†é’Ÿï¼‰

**å®šä¹‰ 2ï¼ˆé«˜å¯ç”¨æ–¹æ¡ˆï¼‰**ï¼š
è®¾ HighAvailabilitySolution = {replication, failover, load_balancing, monitoring}ï¼Œå…¶ä¸­ï¼š

- replicationï¼šå¤åˆ¶æ–¹æ¡ˆï¼ˆæµå¤åˆ¶ã€é€»è¾‘å¤åˆ¶ï¼‰
- failoverï¼šæ•…éšœè½¬ç§»æ–¹æ¡ˆï¼ˆè‡ªåŠ¨ã€æ‰‹åŠ¨ï¼‰
- load_balancingï¼šè´Ÿè½½å‡è¡¡æ–¹æ¡ˆï¼ˆè¯»å†™åˆ†ç¦»ã€è¿æ¥æ± ï¼‰
- monitoringï¼šç›‘æ§æ–¹æ¡ˆï¼ˆå¥åº·æ£€æŸ¥ã€å‘Šè­¦ï¼‰

**å®šä¹‰ 3ï¼ˆæ•…éšœæ£€æµ‹ï¼‰**ï¼š
è®¾ FailureDetection = {heartbeat, health_check, timeout}ï¼Œå…¶ä¸­ï¼š

- heartbeatï¼šå¿ƒè·³æ£€æµ‹
- health_checkï¼šå¥åº·æ£€æŸ¥
- timeoutï¼šè¶…æ—¶æ£€æµ‹

**å®šä¹‰ 4ï¼ˆæ•…éšœè½¬ç§»ï¼‰**ï¼š
è®¾ Failover = {detection, election, promotion, routing_update}ï¼Œå…¶ä¸­ï¼š

- detectionï¼šæ•…éšœæ£€æµ‹
- electionï¼šä¸»åº“é€‰ä¸¾
- promotionï¼šå¤‡åº“æå‡
- routing_updateï¼šè·¯ç”±æ›´æ–°

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç† 1ï¼ˆé«˜å¯ç”¨æ€§ä¿è¯ï¼‰**ï¼š
å¦‚æœæ•…éšœè½¬ç§»æ—¶é—´å°äºæœåŠ¡ä¸­æ–­å®¹å¿æ—¶é—´ï¼Œåˆ™é«˜å¯ç”¨æ€§å¾—åˆ°ä¿è¯ã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰1ï¼Œé«˜å¯ç”¨æ€§åŒ…æ‹¬å¯ç”¨æ—¶é—´å’Œæ•…éšœè½¬ç§»æ—¶é—´
2. æ•…éšœè½¬ç§»æ—¶é—´å°äºæœåŠ¡ä¸­æ–­å®¹å¿æ—¶é—´
3. æœåŠ¡ä¸­æ–­æ—¶é—´åœ¨å¯æ¥å—èŒƒå›´å†…
4. å› æ­¤ï¼Œé«˜å¯ç”¨æ€§å¾—åˆ°ä¿è¯

**å®šç† 2ï¼ˆæ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼‰**ï¼š
åŒæ­¥å¤åˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚

**è¯æ˜**ï¼š

1. åŒæ­¥å¤åˆ¶è¦æ±‚ä¸»åº“ç­‰å¾…å¤‡åº“ç¡®è®¤
2. ä¸»åº“å’Œå¤‡åº“æ•°æ®ä¸€è‡´
3. ä½†å¢åŠ äº†ç½‘ç»œå»¶è¿Ÿå’Œç­‰å¾…æ—¶é—´
4. å¤‡åº“æ•…éšœå¯èƒ½å½±å“ä¸»åº“å¯ç”¨æ€§
5. å› æ­¤ï¼ŒåŒæ­¥å¤åˆ¶ä¿è¯ä¸€è‡´æ€§ä½†å¯èƒ½å½±å“æ€§èƒ½å’Œå¯ç”¨æ€§

**å®é™…åº”ç”¨**ï¼š

- é«˜å¯ç”¨ä½“ç³»åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œæ–¹æ¡ˆè®¾è®¡
- æ•…éšœè½¬ç§»ç³»ç»Ÿåˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œè½¬ç§»ç­–ç•¥è®¾è®¡
- è´Ÿè½½å‡è¡¡ç³»ç»Ÿåˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œè·¯ç”±ç­–ç•¥è®¾è®¡

### 2.1 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å¯¹æ¯”çŸ©é˜µ

**é«˜å¯ç”¨æ–¹æ¡ˆçš„é€‰æ‹©æ˜¯é«˜å¯ç”¨ç³»ç»Ÿå»ºè®¾çš„å…³é”®å†³ç­–**ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆå¯ä»¥å¹³è¡¡æ€§èƒ½ã€å¯ç”¨æ€§å’Œæˆæœ¬ã€‚

**é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å¯¹æ¯”çŸ©é˜µ**ï¼š

| æ–¹æ¡ˆ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|------|--------|------|--------|------|---------|---------|
| **æµå¤åˆ¶+Patroni** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ | ä¼ä¸šçº§é«˜å¯ç”¨ | 4.3/5 |
| **é€»è¾‘å¤åˆ¶** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | è¡¨çº§å¤åˆ¶ | 4.0/5 |
| **è¯»å†™åˆ†ç¦»** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | è¯»å¤šå†™å°‘ | 4.0/5 |
| **ç®€å•ä¸»ä»** | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | åŸºç¡€é«˜å¯ç”¨ | 3.5/5 |

**é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[éœ€è¦é«˜å¯ç”¨ç³»ç»Ÿ] --> B{å¯ç”¨æ€§è¦æ±‚}
    B -->|99.9%+| C{æ•°æ®ä¸€è‡´æ€§è¦æ±‚}
    B -->|99%| D[ä½¿ç”¨ç®€å•ä¸»ä»]
    C -->|é›¶æ•°æ®ä¸¢å¤±| E[ä½¿ç”¨æµå¤åˆ¶+åŒæ­¥å¤åˆ¶]
    C -->|æ€§èƒ½ä¼˜å…ˆ| F[ä½¿ç”¨æµå¤åˆ¶+å¼‚æ­¥å¤åˆ¶]
    C -->|è¡¨çº§å¤åˆ¶| G[ä½¿ç”¨é€»è¾‘å¤åˆ¶]
    E --> H[å®æ–½é«˜å¯ç”¨æ–¹æ¡ˆ]
    F --> H
    G --> H
    D --> H
    H --> I[éªŒè¯é«˜å¯ç”¨æ•ˆæœ]
    I --> J{å¯ç”¨æ€§æ»¡è¶³è¦æ±‚?}
    J -->|æ˜¯| K[é«˜å¯ç”¨ç³»ç»Ÿå®Œæˆ]
    J -->|å¦| L{é—®é¢˜åˆ†æ}
    L -->|æ€§èƒ½é—®é¢˜| M{æ˜¯å¦éœ€è¦ä¼˜åŒ–?}
    L -->|åŠŸèƒ½é—®é¢˜| N[é€‰æ‹©å…¶ä»–æ–¹æ¡ˆ]
    M -->|æ˜¯| O[ä¼˜åŒ–é«˜å¯ç”¨é…ç½®]
    M -->|å¦| P[é€‰æ‹©å…¶ä»–æ–¹æ¡ˆ]
    O --> I
    P --> B
    N --> B

    style B fill:#FFD700
    style J fill:#90EE90
    style K fill:#90EE90
```

## 3. é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾

### 3.1 é«˜å¯ç”¨ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((é«˜å¯ç”¨ä½“ç³»))
    æµå¤åˆ¶
      ç‰©ç†å¤åˆ¶
        ä¸»ä»å¤åˆ¶
        æ•°æ®åŒæ­¥
        WALä¼ è¾“
      åŒæ­¥å¤åˆ¶
        åŒæ­¥æäº¤
        é›¶æ•°æ®ä¸¢å¤±
        æ€§èƒ½å½±å“
      å¼‚æ­¥å¤åˆ¶
        å¼‚æ­¥æäº¤
        æ€§èƒ½ä¼˜å…ˆ
        å¯èƒ½ä¸¢å¤±
      çº§è”å¤åˆ¶
        å¤šçº§å¤åˆ¶
        æ‰©å±•æ€§
        å»¶è¿Ÿ
    é€»è¾‘å¤åˆ¶
      è¡¨çº§å¤åˆ¶
        é€‰æ‹©æ€§å¤åˆ¶
        è·¨ç‰ˆæœ¬å¤åˆ¶
        çµæ´»é…ç½®
      å‘å¸ƒè®¢é˜…
        å‘å¸ƒè€…
        è®¢é˜…è€…
        è¿‡æ»¤æ¡ä»¶
      å†²çªå¤„ç†
        å†²çªæ£€æµ‹
        å†²çªè§£å†³
        å†²çªç­–ç•¥
    æ•…éšœè½¬ç§»
      æ‰‹åŠ¨åˆ‡æ¢
        æ‰‹åŠ¨åˆ‡æ¢
        ç®€å•åœºæ™¯
      è‡ªåŠ¨åˆ‡æ¢
        Patroni
        repmgr
        pg_auto_failover
      åˆ‡æ¢ç­–ç•¥
        æ•…éšœæ£€æµ‹
        åˆ‡æ¢å†³ç­–
        åˆ‡æ¢æ‰§è¡Œ
    è¯»å†™åˆ†ç¦»
      ä¸»ä»åˆ†ç¦»
        ä¸»åº“å†™
        ä»åº“è¯»
        è´Ÿè½½å‡è¡¡
      è¿æ¥è·¯ç”±
        åº”ç”¨å±‚è·¯ç”±
        ä¸­é—´ä»¶è·¯ç”±
        ä»£ç†è·¯ç”±
      ä¸€è‡´æ€§ä¿è¯
        è¯»ä¸€è‡´æ€§
        å»¶è¿Ÿå¤„ç†
        æœ€ç»ˆä¸€è‡´æ€§
    è´Ÿè½½å‡è¡¡
      è¿æ¥æ± 
        PgBouncer
        è¿æ¥å¤ç”¨
        è¿æ¥ç®¡ç†
      è´Ÿè½½å‡è¡¡å™¨
        HAProxy
        Nginx
        äº‘è´Ÿè½½å‡è¡¡
      å¥åº·æ£€æŸ¥
        å¥åº·æ£€æµ‹
        æ•…éšœæ£€æµ‹
        è‡ªåŠ¨åˆ‡æ¢
    ç›‘æ§å‘Šè­¦
      çŠ¶æ€ç›‘æ§
        ä¸»ä»çŠ¶æ€
        å¤åˆ¶å»¶è¿Ÿ
        è¿æ¥çŠ¶æ€
      æ€§èƒ½ç›‘æ§
        æŸ¥è¯¢æ€§èƒ½
        å¤åˆ¶æ€§èƒ½
        èµ„æºä½¿ç”¨
      å‘Šè­¦é€šçŸ¥
        æ•…éšœå‘Šè­¦
        å»¶è¿Ÿå‘Šè­¦
        æ€§èƒ½å‘Šè­¦
```

### 3.2 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹

```mermaid
flowchart TD
    A[é«˜å¯ç”¨éœ€æ±‚] --> B{æ•°æ®ä¸¢å¤±å®¹å¿åº¦?}
    B -->|é›¶ä¸¢å¤±| C[åŒæ­¥å¤åˆ¶]
    B -->|å¯å®¹å¿| D[å¼‚æ­¥å¤åˆ¶]
    C --> E{æ€§èƒ½è¦æ±‚?}
    D --> E
    E -->|é«˜æ€§èƒ½| F[å¼‚æ­¥å¤åˆ¶+è¯»å†™åˆ†ç¦»]
    E -->|å¹³è¡¡| G[åŒæ­¥å¤åˆ¶+è¯»å†™åˆ†ç¦»]
    F --> H{è‡ªåŠ¨åˆ‡æ¢?}
    G --> H
    H -->|æ˜¯| I[Patroni/repmgr]
    H -->|å¦| J[æ‰‹åŠ¨åˆ‡æ¢]
    I --> K[ç›‘æ§å‘Šè­¦]
    J --> K
    K --> L[é«˜å¯ç”¨æ–¹æ¡ˆå®Œæˆ]
```

## 4. é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£

### 4.1 æµå¤åˆ¶æ–¹æ¡ˆ

**æµå¤åˆ¶ç±»å‹å¯¹æ¯”**:

| å¤åˆ¶ç±»å‹ | æ•°æ®ä¸¢å¤± | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|---------|------|---------|--------|
| **åŒæ­¥å¤åˆ¶** | 0 | â­â­â­ | é‡‘èã€å…³é”®ä¸šåŠ¡ | â­â­â­â­â­ |
| **å¼‚æ­¥å¤åˆ¶** | å¯èƒ½ä¸¢å¤± | â­â­â­â­â­ | ä¸€èˆ¬ä¸šåŠ¡ | â­â­â­â­ |
| **çº§è”å¤åˆ¶** | å¯èƒ½ä¸¢å¤± | â­â­â­â­ | å¤šåœ°åŸŸéƒ¨ç½² | â­â­â­ |

**æµå¤åˆ¶é…ç½®**:

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
synchronous_standby_names = 'standby1,standby2'  -- åŒæ­¥å¤åˆ¶

-- 2. ä¸»åº“é…ç½®ï¼ˆpg_hba.confï¼‰
host    replication    repuser    192.168.1.0/24    md5

-- 3. åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER repuser WITH REPLICATION PASSWORD 'password';

-- 4. ä»åº“åŸºç¡€å¤‡ä»½
pg_basebackup -h primary_host -D /var/lib/postgresql/data -U repuser -P -W -R

-- 5. ä»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
primary_conninfo = 'host=primary_host port=5432 user=repuser password=password'
```

### 4.2 é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ

**é€»è¾‘å¤åˆ¶ç‰¹ç‚¹**:

| ç‰¹ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **è¡¨çº§å¤åˆ¶** | é€‰æ‹©æ€§å¤åˆ¶è¡¨ | çµæ´» |
| **è·¨ç‰ˆæœ¬** | æ”¯æŒè·¨ç‰ˆæœ¬å¤åˆ¶ | å…¼å®¹æ€§å¥½ |
| **è¿‡æ»¤æ¡ä»¶** | æ”¯æŒè¿‡æ»¤æ¡ä»¶ | ç²¾ç¡®æ§åˆ¶ |

**é€»è¾‘å¤åˆ¶é…ç½®**:

```sql
-- 1. ä¸»åº“åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION pub_orders FOR TABLE orders, order_items;

-- 2. ä»åº“åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION sub_orders
CONNECTION 'host=primary_host port=5432 dbname=mydb user=repuser password=password'
PUBLICATION pub_orders;

-- 3. æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_subscription;
SELECT * FROM pg_stat_replication;
```

### 4.3 Patroni é«˜å¯ç”¨æ–¹æ¡ˆ

**Patroni ç‰¹ç‚¹**:

| ç‰¹ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **è‡ªåŠ¨æ•…éšœè½¬ç§»** | è‡ªåŠ¨æ£€æµ‹å’Œåˆ‡æ¢ | é«˜å¯ç”¨ |
| **é…ç½®ç®¡ç†** | é›†ä¸­é…ç½®ç®¡ç† | æ˜“ç®¡ç† |
| **å¤šç§åç«¯** | æ”¯æŒå¤šç§åç«¯ | çµæ´» |

**Patroni é…ç½®ç¤ºä¾‹**:

```yaml
# patroni.yml
scope: postgres
namespace: /db/
name: postgresql1

restapi:
  listen: 127.0.0.1:8008
  connect_address: 127.0.0.1:8008

etcd:
  hosts: 127.0.0.1:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        max_connections: 100
        max_wal_senders: 10
        max_replication_slots: 10

postgresql:
  listen: 127.0.0.1:5432
  connect_address: 127.0.0.1:5432
  data_dir: /var/lib/postgresql/data
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: repuser
      password: password
    superuser:
      username: postgres
      password: password
  parameters:
    unix_socket_directories: '/var/run/postgresql'
```

### 4.4 è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ

**è¯»å†™åˆ†ç¦»æ¶æ„**:

è¯»å†™åˆ†ç¦»é€šè¿‡å°†å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“ã€è¯»æ“ä½œè·¯ç”±åˆ°ä»åº“ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œæ€§èƒ½æå‡ã€‚

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆå†™æ“ä½œï¼‰
-- åº”ç”¨è¿æ¥åˆ°ä¸»åº“è¿›è¡Œå†™æ“ä½œ
-- è¿æ¥å­—ç¬¦ä¸²ç¤ºä¾‹ï¼š
-- postgresql://user:password@primary_host:5432/mydb

-- 2. ä»åº“é…ç½®ï¼ˆè¯»æ“ä½œï¼‰
-- åº”ç”¨è¿æ¥åˆ°ä»åº“è¿›è¡Œè¯»æ“ä½œ
-- è¿æ¥å­—ç¬¦ä¸²ç¤ºä¾‹ï¼š
-- postgresql://user:password@standby_host:5432/mydb

-- 3. ä½¿ç”¨ PgBouncer å®ç°è¿æ¥æ± å’Œè·¯ç”±
-- pgbouncer.ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby_host port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

-- 4. ä½¿ç”¨ HAProxy å®ç°è¯»å†™åˆ†ç¦»
# haproxy.cfg
global
    log stdout local0
    maxconn 4096

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# å†™æ“ä½œï¼ˆä¸»åº“ï¼‰
frontend pg_write
    bind *:5432
    default_backend pg_primary

backend pg_primary
    option pgsql-check user postgres
    server pg1 primary_host:5432 check

# è¯»æ“ä½œï¼ˆä»åº“ï¼‰
frontend pg_read
    bind *:5433
    default_backend pg_standby

backend pg_standby
    balance roundrobin
    option pgsql-check user postgres
    server pg2 standby1_host:5432 check
    server pg3 standby2_host:5432 check

-- 5. åº”ç”¨å±‚è¯»å†™åˆ†ç¦»ï¼ˆæ¨èï¼‰
-- Python ç¤ºä¾‹
import psycopg2
from psycopg2 import pool

# ä¸»åº“è¿æ¥æ± ï¼ˆå†™æ“ä½œï¼‰
write_pool = psycopg2.pool.ThreadedConnectionPool(
    1, 20,
    host='primary_host',
    port=5432,
    database='mydb',
    user='user',
    password='password'
)

# ä»åº“è¿æ¥æ± ï¼ˆè¯»æ“ä½œï¼‰
read_pool = psycopg2.pool.ThreadedConnectionPool(
    1, 50,
    host='standby_host',
    port=5432,
    database='mydb',
    user='user',
    password='password'
)

# å†™æ“ä½œä½¿ç”¨ä¸»åº“
def write_data(data):
    conn = write_pool.getconn()
    try:
        cursor = conn.cursor()
        cursor.execute("INSERT INTO table VALUES (%s)", (data,))
        conn.commit()
    finally:
        write_pool.putconn(conn)

# è¯»æ“ä½œä½¿ç”¨ä»åº“
def read_data():
    conn = read_pool.getconn()
    try:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM table")
        return cursor.fetchall()
    finally:
        read_pool.putconn(conn)

-- 6. ä½¿ç”¨ pgpool-II å®ç°è¯»å†™åˆ†ç¦»
# pgpool.conf
listen_addresses = '*'
port = 9999
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 0  -- ä¸»åº“æƒé‡ï¼ˆå†™æ“ä½œï¼‰
backend_hostname1 = 'standby_host'
backend_port1 = 5432
backend_weight1 = 1  -- ä»åº“æƒé‡ï¼ˆè¯»æ“ä½œï¼‰

load_balance_mode = on  -- å¯ç”¨è´Ÿè½½å‡è¡¡
master_slave_mode = on  -- å¯ç”¨ä¸»ä»æ¨¡å¼

-- 7. ç›‘æ§è¯»å†™åˆ†ç¦»æ•ˆæœ
-- æŸ¥çœ‹ä¸»åº“è¿æ¥æ•°ï¼ˆå†™æ“ä½œï¼‰
SELECT
    count(*) AS write_connections,
    state
FROM pg_stat_activity
WHERE datname = 'mydb'
GROUP BY state;

-- æŸ¥çœ‹ä»åº“è¿æ¥æ•°ï¼ˆè¯»æ“ä½œï¼‰
SELECT
    count(*) AS read_connections,
    state
FROM pg_stat_activity
WHERE datname = 'mydb'
    AND pg_is_in_recovery()
GROUP BY state;

-- 8. è¯»å†™åˆ†ç¦»æœ€ä½³å®è·µ
-- âœ… å¥½ï¼šå†™æ“ä½œä½¿ç”¨ä¸»åº“
INSERT INTO orders VALUES (...);

-- âœ… å¥½ï¼šè¯»æ“ä½œä½¿ç”¨ä»åº“
SELECT * FROM orders WHERE id = 123;

-- âŒ ä¸å¥½ï¼šè¯»æ“ä½œä½¿ç”¨ä¸»åº“ï¼ˆå¢åŠ ä¸»åº“è´Ÿè½½ï¼‰
-- SELECT * FROM orders WHERE id = 123;  -- åœ¨ä¸»åº“æ‰§è¡Œ

-- âœ… å¥½ï¼šäº‹åŠ¡æ€§è¯»æ“ä½œä½¿ç”¨ä¸»åº“ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
BEGIN;
SELECT * FROM orders WHERE id = 123 FOR UPDATE;
UPDATE orders SET status = 'paid' WHERE id = 123;
COMMIT;
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦éƒ¨ç½²é«˜å¯ç”¨PostgreSQLé›†ç¾¤ï¼Œä¿è¯99.99%å¯ç”¨æ€§ï¼Œé›¶æ•°æ®ä¸¢å¤±ï¼Œæ—¥äº¤æ˜“é‡5000ä¸‡+ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚

**é—®é¢˜åˆ†æ**:

1. **å¯ç”¨æ€§è¦æ±‚**: éœ€è¦99.99%å¯ç”¨æ€§
2. **æ•°æ®ä¸€è‡´æ€§**: éœ€è¦é›¶æ•°æ®ä¸¢å¤±
3. **æ€§èƒ½è¦æ±‚**: æ—¥äº¤æ˜“é‡5000ä¸‡+ï¼Œéœ€è¦é«˜æ€§èƒ½
4. **æ•…éšœæ¢å¤**: éœ€è¦å¿«é€Ÿæ•…éšœæ¢å¤ï¼ˆ<30ç§’ï¼‰

**é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºé‡‘èç³»ç»Ÿé€‰æ‹©åˆé€‚çš„é«˜å¯ç”¨æ–¹æ¡ˆï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šæµå¤åˆ¶+Patroni+åŒæ­¥å¤åˆ¶**

- **æè¿°**: ä½¿ç”¨æµå¤åˆ¶+Patroni+åŒæ­¥å¤åˆ¶å®ç°é«˜å¯ç”¨
- **ä¼˜ç‚¹**:
  - å¯ç”¨æ€§é«˜ï¼ˆ99.99%+ï¼‰
  - é›¶æ•°æ®ä¸¢å¤±
  - è‡ªåŠ¨æ•…éšœè½¬ç§»
- **ç¼ºç‚¹**:
  - æ€§èƒ½å½±å“å¤§ï¼ˆå»¶è¿Ÿå¢åŠ ï¼‰
  - é…ç½®å¤æ‚
  - æˆæœ¬é«˜
- **é€‚ç”¨åœºæ™¯**: é‡‘èç­‰å…³é”®ä¸šåŠ¡
- **æ€§èƒ½æ•°æ®**: å»¶è¿Ÿå¢åŠ 20-50msï¼ŒTPSé™ä½10-20%
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œç¡¬ä»¶æˆæœ¬é«˜ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œé£é™©ä¸­ç­‰

**æ–¹æ¡ˆ2ï¼šæµå¤åˆ¶+Patroni+å¼‚æ­¥å¤åˆ¶**

- **æè¿°**: ä½¿ç”¨æµå¤åˆ¶+Patroni+å¼‚æ­¥å¤åˆ¶å®ç°é«˜å¯ç”¨
- **ä¼˜ç‚¹**:
  - å¯ç”¨æ€§é«˜ï¼ˆ99.9%+ï¼‰
  - æ€§èƒ½å¥½ï¼ˆæ— å»¶è¿Ÿå½±å“ï¼‰
  - è‡ªåŠ¨æ•…éšœè½¬ç§»
- **ç¼ºç‚¹**:
  - å¯èƒ½ä¸¢å¤±å°‘é‡æ•°æ®ï¼ˆä¸»åº“æ•…éšœæ—¶ï¼‰
  - é…ç½®å¤æ‚
- **é€‚ç”¨åœºæ™¯**: ä¸€èˆ¬ä¼ä¸šçº§é«˜å¯ç”¨
- **æ€§èƒ½æ•°æ®**: æ— å»¶è¿Ÿå½±å“ï¼ŒTPSæ— é™ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œç¡¬ä»¶æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œé£é™©ä½

**æ–¹æ¡ˆ3ï¼šé€»è¾‘å¤åˆ¶**

- **æè¿°**: ä½¿ç”¨é€»è¾‘å¤åˆ¶å®ç°è¡¨çº§å¤åˆ¶
- **ä¼˜ç‚¹**:
  - çµæ´»æ€§å¼ºï¼ˆè¡¨çº§å¤åˆ¶ï¼‰
  - æ€§èƒ½å¥½
  - æ”¯æŒè·¨ç‰ˆæœ¬å¤åˆ¶
- **ç¼ºç‚¹**:
  - å¯ç”¨æ€§ç›¸å¯¹è¾ƒä½ï¼ˆ99%+ï¼‰
  - ä¸æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»
  - é…ç½®å¤æ‚
- **é€‚ç”¨åœºæ™¯**: è¡¨çº§å¤åˆ¶åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æ— å»¶è¿Ÿå½±å“ï¼ŒTPSæ— é™ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œç¡¬ä»¶æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä¸­ç­‰

**æ–¹æ¡ˆ4ï¼šç®€å•ä¸»ä»å¤åˆ¶**

- **æè¿°**: ä½¿ç”¨ç®€å•ä¸»ä»å¤åˆ¶å®ç°åŸºç¡€é«˜å¯ç”¨
- **ä¼˜ç‚¹**:
  - é…ç½®ç®€å•
  - æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - å¯ç”¨æ€§è¾ƒä½ï¼ˆ99%ï¼‰
  - ä¸æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»
  - éœ€è¦æ‰‹åŠ¨åˆ‡æ¢
- **é€‚ç”¨åœºæ™¯**: åŸºç¡€é«˜å¯ç”¨åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æ— å»¶è¿Ÿå½±å“ï¼ŒTPSæ— é™ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç¡¬ä»¶æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|------|--------|------|--------|------|---------|---------|
| æµå¤åˆ¶+Patroni+åŒæ­¥ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­ | é‡‘èç­‰å…³é”®ä¸šåŠ¡ | 3.3/5 |
| æµå¤åˆ¶+Patroni+å¼‚æ­¥ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | ä¼ä¸šçº§é«˜å¯ç”¨ | 4.3/5 |
| é€»è¾‘å¤åˆ¶ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | è¡¨çº§å¤åˆ¶ | 4.0/5 |
| ç®€å•ä¸»ä» | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | åŸºç¡€é«˜å¯ç”¨ | 3.5/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- å¯ç”¨æ€§ï¼šæƒé‡35%
- æ€§èƒ½ï¼šæƒé‡25%
- å¤æ‚åº¦ï¼šæƒé‡15%
- æˆæœ¬ï¼šæƒé‡15%
- é€‚ç”¨åœºæ™¯ï¼šæƒé‡10%

**è¯„åˆ†è®¡ç®—**:

- æµå¤åˆ¶+Patroni+åŒæ­¥ï¼š5.0 Ã— 0.35 + 3.0 Ã— 0.25 + 3.0 Ã— 0.15 + 2.0 Ã— 0.15 + 5.0 Ã— 0.1 = 3.3
- æµå¤åˆ¶+Patroni+å¼‚æ­¥ï¼š5.0 Ã— 0.35 + 5.0 Ã— 0.25 + 3.0 Ã— 0.15 + 3.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.3
- é€»è¾‘å¤åˆ¶ï¼š4.0 Ã— 0.35 + 5.0 Ã— 0.25 + 4.0 Ã— 0.15 + 4.0 Ã— 0.15 + 4.0 Ã— 0.1 = 4.0
- ç®€å•ä¸»ä»ï¼š3.0 Ã— 0.35 + 4.0 Ã— 0.25 + 5.0 Ã— 0.15 + 5.0 Ã— 0.15 + 3.0 Ã— 0.1 = 3.5

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: æµå¤åˆ¶+Patroni+åŒæ­¥å¤åˆ¶ï¼ˆé‡‘èç³»ç»Ÿï¼‰

**æ¨èç†ç”±**:

1. å¯ç”¨æ€§é«˜ï¼Œæ»¡è¶³99.99%å¯ç”¨æ€§è¦æ±‚
2. é›¶æ•°æ®ä¸¢å¤±ï¼Œæ»¡è¶³é‡‘èç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§è¦æ±‚
3. è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡
4. é€‚åˆé‡‘èç­‰å…³é”®ä¸šåŠ¡åœºæ™¯

**å®æ–½å»ºè®®**:

1. ä½¿ç”¨æµå¤åˆ¶+Patroni+åŒæ­¥å¤åˆ¶å®ç°é«˜å¯ç”¨
2. é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œä¿è¯å¿«é€Ÿæ¢å¤
3. å®æ–½è¯»å†™åˆ†ç¦»ï¼Œæå‡è¯»æ€§èƒ½
4. é…ç½®ç›‘æ§å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦å®ç°é«˜å¯ç”¨ï¼Œä¿è¯é›¶æ•°æ®ä¸¢å¤±ã€‚

**é—®é¢˜åˆ†æ**:

1. **é›¶æ•°æ®ä¸¢å¤±**: éœ€è¦åŒæ­¥å¤åˆ¶
2. **é«˜å¯ç”¨**: éœ€è¦è‡ªåŠ¨æ•…éšœè½¬ç§»
3. **æ€§èƒ½è¦æ±‚**: éœ€è¦è¯»å†™åˆ†ç¦»

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆåŒæ­¥å¤åˆ¶ï¼‰
-- postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
synchronous_standby_names = 'standby1,standby2'

-- 2. ä»åº“é…ç½®
-- postgresql.conf
primary_conninfo = 'host=primary_host port=5432 user=repuser password=password application_name=standby1'
hot_standby = on

-- 3. ä½¿ç”¨Patroniå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
# patroni.yml
scope: postgres
name: postgresql1
restapi:
  listen: 0.0.0.0:8008
etcd:
  hosts: etcd1:2379,etcd2:2379,etcd3:2379
bootstrap:
  dcs:
    synchronous_mode: true
    synchronous_mode_strict: true

-- 4. è¯»å†™åˆ†ç¦»é…ç½®
-- åº”ç”¨å±‚è·¯ç”±ï¼šå†™æ“ä½œåˆ°ä¸»åº“ï¼Œè¯»æ“ä½œåˆ°ä»åº“
-- æˆ–ä½¿ç”¨HAProxyå®ç°è‡ªåŠ¨è·¯ç”±
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å¯ç”¨æ€§** | 99.0% | **99.99%** | **æå‡** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 30 åˆ†é’Ÿ | **< 30ç§’** | **98%** â¬‡ï¸ |
| **æ•°æ®ä¸¢å¤±** | å¯èƒ½ä¸¢å¤± | **0** | **100%** â¬‡ï¸ |
| **è¯»æ€§èƒ½** | åŸºå‡† | **+100%** | **æå‡** |

### 5.2 æ¡ˆä¾‹: ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦å®ç°é«˜å¯ç”¨ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä¸»ä»å¤åˆ¶ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰
-- postgresql.conf
wal_level = replica
max_wal_senders = 10

-- 2. è¯»å†™åˆ†ç¦»
-- ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± 
-- pgbouncer.ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby1_host port=5432 dbname=mydb
mydb_ro2 = host=standby2_host port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 2000
default_pool_size = 50

-- 3. è´Ÿè½½å‡è¡¡
-- ä½¿ç”¨HAProxyå®ç°è´Ÿè½½å‡è¡¡
# haproxy.cfg
global
    maxconn 4096

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend pg_frontend
    bind *:5432
    default_backend pg_backend

backend pg_backend
    balance roundrobin
    option pgsql-check user postgres
    server pg1 primary_host:5432 check
    server pg2 standby1_host:5432 check backup
    server pg3 standby2_host:5432 check backup

-- 4. ç›‘æ§å‘Šè­¦
-- ä½¿ç”¨Prometheus + Grafanaç›‘æ§
-- ç›‘æ§æŒ‡æ ‡ï¼šä¸»ä»çŠ¶æ€ã€å¤åˆ¶å»¶è¿Ÿã€è¿æ¥æ•°ç­‰
```

## 6. æœ€ä½³å®è·µ

### 6.1 é«˜å¯ç”¨è®¾è®¡åŸåˆ™

**æ¨èåšæ³•**ï¼š

1. **å¤šå‰¯æœ¬è®¾è®¡**ï¼ˆè‡³å°‘2ä¸ªå‰¯æœ¬ï¼Œå…³é”®ä¸šåŠ¡3ä¸ªä»¥ä¸Šï¼‰

   ```sql
   -- âœ… å¥½ï¼šä¸»åº“ + 2ä¸ªä»åº“ï¼ˆä¸€ä¸»ä¸¤ä»ï¼‰
   -- ä¸»åº“ï¼šprimary_host
   -- ä»åº“1ï¼šstandby1_hostï¼ˆåŒæ­¥å¤åˆ¶ï¼‰
   -- ä»åº“2ï¼šstandby2_hostï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰

   -- é…ç½®åŒæ­¥å¤åˆ¶
   synchronous_standby_names = 'ANY 1 (standby1,standby2)'
   -- è‡³å°‘1ä¸ªä»åº“åŒæ­¥å³å¯ï¼Œä¿è¯é«˜å¯ç”¨
   ```

2. **ä½¿ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»å·¥å…·**ï¼ˆPatroniã€repmgrç­‰ï¼‰

   ```yaml
   # âœ… å¥½ï¼šä½¿ç”¨ Patroni å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
   # patroni.yml
   bootstrap:
     dcs:
       ttl: 30
       loop_wait: 10
       retry_timeout: 30
       maximum_lag_on_failover: 1048576
   ```

3. **å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦**ï¼ˆç›‘æ§å¤åˆ¶çŠ¶æ€ã€å»¶è¿Ÿã€è¿æ¥æ•°ç­‰ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç›‘æ§å¤åˆ¶å»¶è¿Ÿ
   SELECT
       application_name,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes,
       state,
       sync_state
   FROM pg_stat_replication;

   -- âœ… å¥½ï¼šç›‘æ§ä»åº“çŠ¶æ€
   SELECT
       pg_is_in_recovery() AS is_standby,
       pg_last_wal_receive_lsn() AS receive_lsn,
       pg_last_wal_replay_lsn() AS replay_lsn;
   ```

4. **å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ**ï¼ˆéªŒè¯æ•…éšœè½¬ç§»æµç¨‹ï¼‰

   ```bash
   # âœ… å¥½ï¼šå®šæœŸæµ‹è¯•æ•…éšœè½¬ç§»
   # 1. æ¨¡æ‹Ÿä¸»åº“æ•…éšœ
   # 2. éªŒè¯è‡ªåŠ¨åˆ‡æ¢
   # 3. éªŒè¯æ•°æ®ä¸€è‡´æ€§
   # 4. æ¢å¤åŸä¸»åº“
   ```

5. **ä½¿ç”¨å¤åˆ¶æ§½é˜²æ­¢WALä¸¢å¤±**ï¼ˆä¿è¯æ•°æ®å®‰å…¨ï¼‰

   ```sql
   -- âœ… å¥½ï¼šåˆ›å»ºå¤åˆ¶æ§½
   SELECT pg_create_physical_replication_slot('standby1_slot');

   -- ä»åº“é…ç½®ä½¿ç”¨å¤åˆ¶æ§½
   primary_slot_name = 'standby1_slot'
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…å•ç‚¹æ•…éšœ**ï¼ˆåªæœ‰1ä¸ªæ•°æ®åº“å®ä¾‹ï¼‰
2. **é¿å…æ‰‹åŠ¨æ•…éšœè½¬ç§»**ï¼ˆåº”ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼‰
3. **é¿å…å¿½ç•¥ç›‘æ§**ï¼ˆæ— æ³•åŠæ—¶å‘ç°æ•…éšœï¼‰
4. **é¿å…å¿½ç•¥æ•…éšœæ¼”ç»ƒ**ï¼ˆæ•…éšœæ—¶æ— æ³•å¿«é€Ÿæ¢å¤ï¼‰

### 6.2 é«˜å¯ç”¨å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **å…³é”®ä¸šåŠ¡ä½¿ç”¨åŒæ­¥å¤åˆ¶**ï¼ˆä¿è¯é›¶æ•°æ®ä¸¢å¤±ï¼‰

   ```sql
   -- âœ… å¥½ï¼šé‡‘èç³»ç»Ÿä½¿ç”¨åŒæ­¥å¤åˆ¶
   synchronous_standby_names = 'standby1,standby2'
   synchronous_commit = on

   -- âŒ ä¸å¥½ï¼šå…³é”®ä¸šåŠ¡ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼ˆå¯èƒ½ä¸¢å¤±æ•°æ®ï¼‰
   -- synchronous_standby_names = ''
   ```

2. **ä½¿ç”¨è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½**ï¼ˆå‡è½»ä¸»åº“è´Ÿè½½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå†™æ“ä½œä½¿ç”¨ä¸»åº“ï¼Œè¯»æ“ä½œä½¿ç”¨ä»åº“
   -- åº”ç”¨å±‚è·¯ç”±æˆ–ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆHAProxyã€pgpool-IIï¼‰

   -- âŒ ä¸å¥½ï¼šæ‰€æœ‰æ“ä½œéƒ½åœ¨ä¸»åº“ï¼ˆä¸»åº“è´Ÿè½½é«˜ï¼‰
   ```

3. **ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨**ï¼ˆåˆ†å‘è¯»è¯·æ±‚ï¼‰

   ```yaml
   # âœ… å¥½ï¼šä½¿ç”¨ HAProxy å®ç°è´Ÿè½½å‡è¡¡
   backend pg_standby
     balance roundrobin
     server pg2 standby1_host:5432 check
     server pg3 standby2_host:5432 check
   ```

4. **å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦**ï¼ˆåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç›‘æ§å…³é”®æŒ‡æ ‡
   -- 1. å¤åˆ¶å»¶è¿Ÿ
   SELECT pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) FROM pg_stat_replication;

   -- 2. è¿æ¥æ•°
   SELECT count(*) FROM pg_stat_activity WHERE datname = 'mydb';

   -- 3. ä¸»ä»çŠ¶æ€
   SELECT pg_is_in_recovery();
   ```

5. **åˆç†é…ç½®è¿æ¥æ± **ï¼ˆæå‡æ€§èƒ½å’Œç¨³å®šæ€§ï¼‰

   ```ini
   # âœ… å¥½ï¼šä½¿ç”¨ PgBouncer è¿æ¥æ± 
   [pgbouncer]
   pool_mode = transaction
   max_client_conn = 1000
   default_pool_size = 25
   max_db_connections = 100
   ```

6. **å®šæœŸå¤‡ä»½å’Œæ¢å¤æµ‹è¯•**ï¼ˆä¿è¯æ•°æ®å®‰å…¨ï¼‰

   ```bash
   # âœ… å¥½ï¼šå®šæœŸå¤‡ä»½
   pg_basebackup -h primary_host -D /backup/data -U repuser -P -W

   # âœ… å¥½ï¼šå®šæœŸæ¢å¤æµ‹è¯•
   # éªŒè¯å¤‡ä»½å¯ç”¨æ€§
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…å…³é”®ä¸šåŠ¡ä½¿ç”¨å¼‚æ­¥å¤åˆ¶**ï¼ˆå¯èƒ½ä¸¢å¤±æ•°æ®ï¼‰
2. **é¿å…æ‰€æœ‰æ“ä½œéƒ½åœ¨ä¸»åº“**ï¼ˆä¸»åº“è´Ÿè½½é«˜ï¼Œæ€§èƒ½å·®ï¼‰
3. **é¿å…å¿½ç•¥ç›‘æ§**ï¼ˆæ— æ³•åŠæ—¶å‘ç°æ•…éšœï¼‰
4. **é¿å…å¿½ç•¥å¤‡ä»½**ï¼ˆæ•°æ®ä¸¢å¤±é£é™©ï¼‰
5. **é¿å…è¿‡åº¦ä¾èµ–å•ä¸€å·¥å…·**ï¼ˆåº”æœ‰å¤šé‡ä¿éšœï¼‰

## 6. å‚è€ƒèµ„æ–™

### 6.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå®Œæ•´å‚è€ƒ
  - æµå¤åˆ¶å’Œé€»è¾‘å¤åˆ¶

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æµå¤åˆ¶](https://www.postgresql.org/docs/current/warm-standby.html)**
  - æµå¤åˆ¶é…ç½®å’Œç®¡ç†
  - ä¸»ä»å¤åˆ¶æœ€ä½³å®è·µ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)**
  - é€»è¾‘å¤åˆ¶é…ç½®å’Œç®¡ç†
  - è¡¨çº§å¤åˆ¶æœ€ä½³å®è·µ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ•…éšœè½¬ç§»](https://www.postgresql.org/docs/current/high-availability.html#HIGH-AVAILABILITY-FAILOVER)**
  - æ•…éšœè½¬ç§»æœºåˆ¶
  - è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§å’Œè¯Šæ–­](https://www.postgresql.org/docs/current/monitoring.html)**
  - é«˜å¯ç”¨ç³»ç»Ÿç›‘æ§
  - æ•…éšœè¯Šæ–­æ–¹æ³•

### 6.2 æŠ€æœ¯è®ºæ–‡

- **Kemme, B., & Alonso, G. (2000). "Database Replication: A Tale of Research across Communities."**
  - ä¼šè®®: VLDB 2000
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶æŠ€æœ¯çš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°æ€»ç»“äº†æ•°æ®åº“å¤åˆ¶çš„å„ç§æ–¹æ³•å’ŒæŒ‘æˆ˜

- **Bernstein, P. A., et al. (1987). "Concurrency Control and Recovery in Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: æ•°æ®åº“å¹¶å‘æ§åˆ¶å’Œæ¢å¤çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†é˜è¿°äº†æ•°æ®åº“å¤åˆ¶å’Œæ•…éšœæ¢å¤çš„ç†è®ºåŸºç¡€

- **Gray, J., et al. (1996). "The Dangers of Replication and a Solution."**
  - ä¼šè®®: SIGMOD 1996
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶ä¸€è‡´æ€§çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: åˆ†æäº†æ•°æ®åº“å¤åˆ¶çš„å±é™©æ€§å’Œè§£å†³æ–¹æ¡ˆ

### 6.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)**
  - é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£
  - é«˜å¯ç”¨æœ€ä½³å®è·µ

- **[2ndQuadrant - PostgreSQL é«˜å¯ç”¨æ–¹æ¡ˆ](https://www.2ndquadrant.com/en/blog/postgresql-high-availability/)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå®æˆ˜
  - æ•…éšœè½¬ç§»æ¡ˆä¾‹

- **[Percona - PostgreSQL é«˜å¯ç”¨](https://www.percona.com/blog/postgresql-high-availability/)**
  - é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡
  - æ•…éšœå¤„ç†ç­–ç•¥

- **[EnterpriseDB - PostgreSQL é«˜å¯ç”¨è¯¦è§£](https://www.enterprisedb.com/postgres-tutorials/postgresql-high-availability)**
  - é«˜å¯ç”¨æ¶æ„è®¾è®¡
  - é«˜å¯ç”¨æ€§èƒ½ä¼˜åŒ–

### 6.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - High Availability](https://wiki.postgresql.org/wiki/High_Availability)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”
  - é«˜å¯ç”¨å·¥å…·æ¨è

- **[PostgreSQL Wiki - Replication](https://wiki.postgresql.org/wiki/Replication)**
  - å¤åˆ¶æ–¹æ¡ˆè¯´æ˜
  - å¤åˆ¶é…ç½®æŒ‡å—

- **[Stack Overflow - PostgreSQL High Availability](https://stackoverflow.com/questions/tagged/postgresql+high-availability)**
  - é«˜å¯ç”¨ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Patroni å®˜æ–¹æ–‡æ¡£](https://patroni.readthedocs.io/)**
  - Patroni é«˜å¯ç”¨å·¥å…·æ–‡æ¡£
  - è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®

- [å¤åˆ¶ä¸é«˜å¯ç”¨](./å¤åˆ¶ä¸é«˜å¯ç”¨.md)
- [é€»è¾‘å¤åˆ¶è¯¦è§£](./é€»è¾‘å¤åˆ¶è¯¦è§£.md)
- [è¿æ¥æ± ç®¡ç†](./è¿æ¥æ± ç®¡ç†.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-60
