# PostgreSQL é€»è¾‘å¤åˆ¶è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-27

## ğŸ“‘ ç›®å½•

- [PostgreSQL é€»è¾‘å¤åˆ¶è¯¦è§£](#postgresql-é€»è¾‘å¤åˆ¶è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 é€»è¾‘å¤åˆ¶ä½“ç³»æ€ç»´å¯¼å›¾](#14-é€»è¾‘å¤åˆ¶ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. é€»è¾‘å¤åˆ¶é…ç½®](#2-é€»è¾‘å¤åˆ¶é…ç½®)
    - [2.0 é€»è¾‘å¤åˆ¶å·¥ä½œåŸç†æ¦‚è¿°](#20-é€»è¾‘å¤åˆ¶å·¥ä½œåŸç†æ¦‚è¿°)
    - [2.1 å‘å¸ƒç«¯é…ç½®](#21-å‘å¸ƒç«¯é…ç½®)
    - [2.2 è®¢é˜…ç«¯é…ç½®](#22-è®¢é˜…ç«¯é…ç½®)
  - [3. å‘å¸ƒå’Œè®¢é˜…](#3-å‘å¸ƒå’Œè®¢é˜…)
    - [3.1 å‘å¸ƒç®¡ç†](#31-å‘å¸ƒç®¡ç†)
    - [3.2 è®¢é˜…ç®¡ç†](#32-è®¢é˜…ç®¡ç†)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: æ•°æ®åˆ†å‘ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-æ•°æ®åˆ†å‘ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é…ç½®ä¼˜åŒ–](#51-é…ç½®ä¼˜åŒ–)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1 å®˜æ–¹æ–‡æ¡£](#61-å®˜æ–¹æ–‡æ¡£)
    - [6.2 æŠ€æœ¯è®ºæ–‡](#62-æŠ€æœ¯è®ºæ–‡)
    - [6.3 æŠ€æœ¯åšå®¢](#63-æŠ€æœ¯åšå®¢)
    - [6.4 ç¤¾åŒºèµ„æº](#64-ç¤¾åŒºèµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é€»è¾‘å¤åˆ¶çš„ä»·å€¼**:

PostgreSQL é€»è¾‘å¤åˆ¶æä¾›äº†çµæ´»çš„æ•°æ®å¤åˆ¶æœºåˆ¶ï¼š

1. **è¡¨çº§å¤åˆ¶**: å¯ä»¥é€‰æ‹©æ€§åœ°å¤åˆ¶ç‰¹å®šè¡¨
2. **è·¨ç‰ˆæœ¬å¤åˆ¶**: æ”¯æŒä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å¤åˆ¶
3. **æ•°æ®è½¬æ¢**: å¯ä»¥åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­è½¬æ¢æ•°æ®
4. **å¤šä¸»å¤åˆ¶**: æ”¯æŒå¤šä¸»å¤åˆ¶åœºæ™¯

**åº”ç”¨åœºæ™¯**:

- **æ•°æ®åˆ†å‘**: å°†æ•°æ®åˆ†å‘åˆ°å¤šä¸ªæ•°æ®åº“
- **ç‰ˆæœ¬å‡çº§**: è·¨ç‰ˆæœ¬æ•°æ®è¿ç§»
- **æ•°æ®é›†æˆ**: é›†æˆå¤šä¸ªæ•°æ®æº
- **æŠ¥è¡¨æ•°æ®åº“**: æ„å»ºæŠ¥è¡¨æ•°æ®åº“

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **çµæ´»æ€§** | è¡¨çº§é€‰æ‹©æ€§å¤åˆ¶ | **é«˜** |
| **è·¨ç‰ˆæœ¬** | æ”¯æŒè·¨ç‰ˆæœ¬å¤åˆ¶ | **é«˜** |
| **æ€§èƒ½** | é€»è¾‘å¤åˆ¶æ€§èƒ½ | **è‰¯å¥½** |
| **å¯æ‰©å±•æ€§** | æ”¯æŒå¤šè®¢é˜…è€… | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **çµæ´»æ€§**: è¡¨çº§é€‰æ‹©æ€§å¤åˆ¶ï¼Œçµæ´»é…ç½®
- **è·¨ç‰ˆæœ¬**: æ”¯æŒä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å¤åˆ¶
- **æ€§èƒ½**: é€»è¾‘å¤åˆ¶æ€§èƒ½è‰¯å¥½ï¼Œæ»¡è¶³å¤§å¤šæ•°åœºæ™¯
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤šä¸ªè®¢é˜…è€…ï¼Œå¯æ‰©å±•æ€§å¼º

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡é€»è¾‘å¤åˆ¶çš„é…ç½®
- ç†è§£å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶
- å­¦ä¼šç›‘æ§å’Œç®¡ç†é€»è¾‘å¤åˆ¶
- æŒæ¡å®é™…åº”ç”¨åœºæ™¯

### 1.4 é€»è¾‘å¤åˆ¶ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é€»è¾‘å¤åˆ¶ä½“ç³»))
    å‘å¸ƒç«¯
      å‘å¸ƒåˆ›å»º
        è¡¨çº§å‘å¸ƒ
        åˆ—çº§å‘å¸ƒ
        è¿‡æ»¤å‘å¸ƒ
      å‘å¸ƒç®¡ç†
        æ·»åŠ è¡¨
        åˆ é™¤è¡¨
        æ›´æ–°é…ç½®
      å‘å¸ƒç›‘æ§
        å‘å¸ƒçŠ¶æ€
        å¤åˆ¶å»¶è¿Ÿ
        é”™è¯¯å¤„ç†
    è®¢é˜…ç«¯
      è®¢é˜…åˆ›å»º
        è®¢é˜…é…ç½®
        è¿æ¥é…ç½®
        åŒæ­¥é…ç½®
      è®¢é˜…ç®¡ç†
        è®¢é˜…çŠ¶æ€
        åŒæ­¥çŠ¶æ€
        é”™è¯¯å¤„ç†
      è®¢é˜…ç›‘æ§
        å¤åˆ¶å»¶è¿Ÿ
        åŒæ­¥è¿›åº¦
        é”™è¯¯æ—¥å¿—
    å¤åˆ¶ç‰¹æ€§
      è¡¨çº§å¤åˆ¶
        é€‰æ‹©æ€§å¤åˆ¶
        çµæ´»é…ç½®
      è·¨ç‰ˆæœ¬å¤åˆ¶
        ç‰ˆæœ¬å…¼å®¹
        è¿ç§»æ”¯æŒ
      æ•°æ®è½¬æ¢
        æ•°æ®è¿‡æ»¤
        æ•°æ®è½¬æ¢
        æ•°æ®æ˜ å°„
    åº”ç”¨åœºæ™¯
      æ•°æ®åˆ†å‘
        å¤šæ•°æ®ä¸­å¿ƒ
        æ•°æ®åŒæ­¥
        è´Ÿè½½å‡è¡¡
      ç‰ˆæœ¬å‡çº§
        é›¶åœæœºå‡çº§
        æ•°æ®è¿ç§»
        å›æ»šæ”¯æŒ
      æŠ¥è¡¨æ•°æ®åº“
        åªè¯»å‰¯æœ¬
        æ•°æ®åˆ†æ
        æŠ¥è¡¨ç”Ÿæˆ
```

## 2. é€»è¾‘å¤åˆ¶é…ç½®

### 2.0 é€»è¾‘å¤åˆ¶å·¥ä½œåŸç†æ¦‚è¿°

**é€»è¾‘å¤åˆ¶çš„æœ¬è´¨**ï¼š

é€»è¾‘å¤åˆ¶ï¼ˆLogical Replicationï¼‰æ˜¯ PostgreSQL 10+ å¼•å…¥çš„è¡¨çº§å¤åˆ¶æŠ€æœ¯ï¼Œ
é€šè¿‡è§£æ WAL ä¸­çš„é€»è¾‘å˜æ›´è®°å½•ï¼ˆINSERTã€UPDATEã€DELETEï¼‰ï¼Œ
å°†å˜æ›´ä»¥ SQL è¯­å¥çš„å½¢å¼ä¼ è¾“åˆ°è®¢é˜…ç«¯å¹¶æ‰§è¡Œï¼Œå®ç°è¡¨çº§æ•°æ®åŒæ­¥ã€‚

**é€»è¾‘å¤åˆ¶æ¶æ„å›¾**ï¼š

```mermaid
flowchart TD
    A[å‘å¸ƒç«¯ Publisher] -->|WAL é€»è¾‘è§£ç | B[é€»è¾‘è§£ç è¿›ç¨‹]
    B -->|å˜æ›´è®°å½•| C[å¤åˆ¶æ§½ Replication Slot]
    C -->|å˜æ›´æµ| D[è®¢é˜…ç«¯ Subscriber]
    D -->|åº”ç”¨å˜æ›´| E[è®¢é˜…ç«¯è¡¨]

    F[åº”ç”¨å†™å…¥] --> A
    A --> G[WAL æ–‡ä»¶]
    G --> B

    H[å‘å¸ƒ Publication] --> A
    I[è®¢é˜… Subscription] --> D

    style A fill:#87CEEB
    style D fill:#90EE90
    style C fill:#FFD700
```

**é€»è¾‘å¤åˆ¶å·¥ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ä¸»åº“äº‹åŠ¡æäº¤] --> B[å†™å…¥ WAL]
    B --> C[é€»è¾‘è§£ç è¿›ç¨‹è¯»å– WAL]
    C --> D[è§£æé€»è¾‘å˜æ›´]
    D --> E{å˜æ›´ç±»å‹}
    E -->|INSERT| F[ç”Ÿæˆ INSERT è¯­å¥]
    E -->|UPDATE| G[ç”Ÿæˆ UPDATE è¯­å¥]
    E -->|DELETE| H[ç”Ÿæˆ DELETE è¯­å¥]
    F --> I[ä¼ è¾“åˆ°è®¢é˜…ç«¯]
    G --> I
    H --> I
    I --> J[è®¢é˜…ç«¯åº”ç”¨å˜æ›´]
    J --> K[è®¢é˜…ç«¯æ•°æ®æ›´æ–°]

    style C fill:#FFD700
    style I fill:#90EE90
```

**é€»è¾‘å¤åˆ¶ vs æµå¤åˆ¶**ï¼š

| ç‰¹æ€§ | é€»è¾‘å¤åˆ¶ | æµå¤åˆ¶ |
|------|---------|--------|
| **å¤åˆ¶ç²’åº¦** | è¡¨çº§ | æ•°æ®åº“çº§ |
| **é€‰æ‹©æ€§** | å¯é€‰æ‹©è¡¨ | å…¨éƒ¨å¤åˆ¶ |
| **è·¨ç‰ˆæœ¬** | æ”¯æŒ | ä¸æ”¯æŒ |
| **æ€§èƒ½** | ä¸­ç­‰ | é«˜ |
| **æ•°æ®ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´ | å¼ºä¸€è‡´ |

### 2.1 å‘å¸ƒç«¯é…ç½®

**å‘å¸ƒç«¯é…ç½®** (postgresql.conf):

```conf
# å¯ç”¨é€»è¾‘å¤åˆ¶
wal_level = logical  # å¿…é¡»è®¾ç½®ä¸º logical
max_replication_slots = 10  # æœ€å¤§å¤åˆ¶æ§½æ•°ï¼ˆæ¯ä¸ªè®¢é˜…éœ€è¦ä¸€ä¸ªæ§½ï¼‰
max_wal_senders = 10  # æœ€å¤§ WAL sender è¿›ç¨‹æ•°
max_logical_replication_workers = 4  # æœ€å¤§é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹æ•°
max_sync_workers_per_subscription = 2  # æ¯ä¸ªè®¢é˜…çš„æœ€å¤§åŒæ­¥å·¥ä½œè¿›ç¨‹æ•°
```

**åˆ›å»ºå‘å¸ƒ**:

```sql
-- 1. åˆ›å»ºåŸºæœ¬å‘å¸ƒï¼ˆå‘å¸ƒå¤šä¸ªè¡¨ï¼‰
CREATE PUBLICATION my_publication
FOR TABLE users, orders, products;

-- 2. å‘å¸ƒæ‰€æœ‰è¡¨
CREATE PUBLICATION all_tables FOR ALL TABLES;

-- 3. å‘å¸ƒç‰¹å®šåˆ—ï¼ˆPostgreSQL 15+ï¼‰
CREATE PUBLICATION users_publication
FOR TABLE users (id, name, email);

-- 4. åˆ›å»ºå¸¦è¿‡æ»¤æ¡ä»¶çš„å‘å¸ƒï¼ˆPostgreSQL 15+ï¼‰
CREATE PUBLICATION active_users_publication
FOR TABLE users
WHERE (status = 'active');

-- 5. æŸ¥çœ‹å‘å¸ƒä¿¡æ¯
SELECT
    pubname AS publication_name,
    puballtables AS all_tables,
    pubinsert AS insert_enabled,
    pubupdate AS update_enabled,
    pubdelete AS delete_enabled,
    pubtruncate AS truncate_enabled
FROM pg_publication;

-- 6. æŸ¥çœ‹å‘å¸ƒåŒ…å«çš„è¡¨
SELECT
    pubname AS publication_name,
    schemaname,
    tablename
FROM pg_publication_tables
WHERE pubname = 'my_publication';

-- 7. æ·»åŠ è¡¨åˆ°å‘å¸ƒ
ALTER PUBLICATION my_publication ADD TABLE new_table;

-- 8. ä»å‘å¸ƒä¸­ç§»é™¤è¡¨
ALTER PUBLICATION my_publication DROP TABLE old_table;

-- 9. è®¾ç½®å‘å¸ƒæ“ä½œç±»å‹ï¼ˆåªå‘å¸ƒ INSERT å’Œ UPDATEï¼‰
ALTER PUBLICATION my_publication SET (publish = 'insert,update');

-- 10. åˆ›å»ºå‘å¸ƒç”¨æˆ·ï¼ˆéœ€è¦ REPLICATION æƒé™ï¼‰
CREATE USER replicator WITH REPLICATION PASSWORD 'password';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replicator;
```

### 2.2 è®¢é˜…ç«¯é…ç½®

**åˆ›å»ºè®¢é˜…**:

```sql
-- 1. åˆ›å»ºåŸºæœ¬è®¢é˜…
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION my_publication;

-- 2. åˆ›å»ºè®¢é˜…ï¼ˆæŒ‡å®šå¤åˆ¶æ§½åç§°ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION my_publication
WITH (slot_name = 'my_subscription_slot');

-- 3. åˆ›å»ºè®¢é˜…ï¼ˆç¦ç”¨å¤åˆ¶æ§½ï¼Œæ‰‹åŠ¨ç®¡ç†ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION my_publication
WITH (create_slot = false);

-- 4. åˆ›å»ºè®¢é˜…ï¼ˆæŒ‡å®šåŒæ­¥è¡¨ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION my_publication
WITH (synchronous_commit = 'local');

-- 5. æŸ¥çœ‹è®¢é˜…ä¿¡æ¯
SELECT
    subname AS subscription_name,
    subenabled AS enabled,
    subslotname AS slot_name,
    subpublications AS publications
FROM pg_subscription;

-- 6. æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT
    subname AS subscription_name,
    pid,
    received_lsn,
    latest_end_lsn,
    latest_end_time,
    slot_name,
    active,
    sync_state
FROM pg_stat_subscription;

-- 7. æŸ¥çœ‹è®¢é˜…å»¶è¿Ÿ
SELECT
    subname AS subscription_name,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        latest_end_lsn
    ) AS replication_lag_bytes,
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            latest_end_lsn
        )
    ) AS replication_lag_size,
    latest_end_time,
    NOW() - latest_end_time AS replication_lag_time
FROM pg_stat_subscription;

-- 8. æš‚åœè®¢é˜…
ALTER SUBSCRIPTION my_subscription DISABLE;

-- 9. æ¢å¤è®¢é˜…
ALTER SUBSCRIPTION my_subscription ENABLE;

-- 10. åˆ·æ–°è®¢é˜…ï¼ˆé‡æ–°åŒæ­¥æ•°æ®ï¼‰
ALTER SUBSCRIPTION my_subscription REFRESH PUBLICATION;

-- 11. æ›´æ–°è®¢é˜…è¿æ¥ä¿¡æ¯
ALTER SUBSCRIPTION my_subscription
CONNECTION 'host=new_primary_host port=5432 user=replicator password=password dbname=mydb';

-- 12. æ·»åŠ å‘å¸ƒåˆ°è®¢é˜…
ALTER SUBSCRIPTION my_subscription ADD PUBLICATION new_publication;

-- 13. ä»è®¢é˜…ä¸­ç§»é™¤å‘å¸ƒ
ALTER SUBSCRIPTION my_subscription DROP PUBLICATION old_publication;

-- 14. åˆ é™¤è®¢é˜…
DROP SUBSCRIPTION my_subscription;

-- 15. åˆ é™¤è®¢é˜…ï¼ˆåŒæ—¶åˆ é™¤å¤åˆ¶æ§½ï¼‰
DROP SUBSCRIPTION my_subscription WITH (drop_slot = true);
```

## 3. å‘å¸ƒå’Œè®¢é˜…

### 3.1 å‘å¸ƒç®¡ç†

**å‘å¸ƒæ“ä½œ**:

```sql
-- æ·»åŠ è¡¨åˆ°å‘å¸ƒ
ALTER PUBLICATION my_publication ADD TABLE new_table;

-- ä»å‘å¸ƒä¸­ç§»é™¤è¡¨
ALTER PUBLICATION my_publication DROP TABLE old_table;

-- æŸ¥çœ‹å‘å¸ƒ
SELECT * FROM pg_publication;
SELECT * FROM pg_publication_tables;
```

### 3.2 è®¢é˜…ç®¡ç†

**è®¢é˜…æ“ä½œ**:

```sql
-- æš‚åœè®¢é˜…
ALTER SUBSCRIPTION my_subscription DISABLE;

-- æ¢å¤è®¢é˜…
ALTER SUBSCRIPTION my_subscription ENABLE;

-- åˆ é™¤è®¢é˜…
DROP SUBSCRIPTION my_subscription;

-- æŸ¥çœ‹è®¢é˜…å»¶è¿Ÿ
SELECT
    subname,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        latest_end_lsn
    ) AS replication_lag
FROM pg_stat_subscription;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: æ•°æ®åˆ†å‘ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å°†ä¸»æ•°æ®åº“çš„æ•°æ®åˆ†å‘åˆ°å¤šä¸ªæŠ¥è¡¨æ•°æ®åº“ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®åˆ†å‘**: éœ€è¦å°†æ•°æ®åˆ†å‘åˆ°å¤šä¸ªæ•°æ®åº“
2. **é€‰æ‹©æ€§å¤åˆ¶**: åªéœ€è¦å¤åˆ¶ç‰¹å®šè¡¨
3. **æ€§èƒ½è¦æ±‚**: ä¸èƒ½å½±å“ä¸»åº“æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åœ¨ä¸»åº“åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION reporting_publication
FOR TABLE sales, customers, products;

-- 2. åœ¨æŠ¥è¡¨åº“åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION reporting_subscription
CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION reporting_publication;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®åŒæ­¥** | æ‰‹åŠ¨ | **è‡ªåŠ¨** | **æå‡** |
| **æ€§èƒ½å½±å“** | é«˜ | **ä½** | **é™ä½** |
| **çµæ´»æ€§** | ä½ | **é«˜** | **æå‡** |

## 5. æœ€ä½³å®è·µ

### 5.1 é…ç½®ä¼˜åŒ–

**æ¨èåšæ³•**ï¼š

1. **æ­£ç¡®è®¾ç½® WAL çº§åˆ«**ï¼ˆå¿…é¡»è®¾ç½®ä¸º logicalï¼‰

   ```conf
   # âœ… å¥½ï¼šå¯ç”¨é€»è¾‘å¤åˆ¶
   wal_level = logical
   max_replication_slots = 10
   max_wal_senders = 10

   # âŒ ä¸å¥½ï¼šWAL çº§åˆ«ä¸å¤Ÿ
   # wal_level = replica  # é€»è¾‘å¤åˆ¶éœ€è¦ logical
   ```

2. **åˆç†é…ç½®å¤åˆ¶æ§½æ•°é‡**ï¼ˆæ¯ä¸ªè®¢é˜…éœ€è¦ä¸€ä¸ªæ§½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæ ¹æ®è®¢é˜…æ•°é‡é…ç½®
   max_replication_slots = 10  -- æ”¯æŒ10ä¸ªè®¢é˜…

   -- æŸ¥çœ‹å½“å‰å¤åˆ¶æ§½ä½¿ç”¨æƒ…å†µ
   SELECT
       slot_name,
       slot_type,
       database,
       active,
       pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) AS lag
   FROM pg_replication_slots;

   -- âŒ ä¸å¥½ï¼šå¤åˆ¶æ§½æ•°é‡ä¸è¶³
   # max_replication_slots = 1  -- åªèƒ½æ”¯æŒ1ä¸ªè®¢é˜…
   ```

3. **ç›‘æ§å¤åˆ¶å»¶è¿Ÿå’ŒçŠ¶æ€**ï¼ˆåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸç›‘æ§å¤åˆ¶å»¶è¿Ÿ
   SELECT
       subname,
       pg_wal_lsn_diff(pg_current_wal_lsn(), latest_end_lsn) AS lag_bytes,
       latest_end_time,
       NOW() - latest_end_time AS lag_time
   FROM pg_stat_subscription;

   -- âœ… å¥½ï¼šç›‘æ§å¤åˆ¶æ§½çŠ¶æ€
   SELECT
       slot_name,
       active,
       pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) AS lag
   FROM pg_replication_slots
   WHERE slot_type = 'logical';
   ```

4. **ä½¿ç”¨å¤åˆ¶æ§½é˜²æ­¢ WAL ä¸¢å¤±**ï¼ˆä¿è¯æ•°æ®å®‰å…¨ï¼‰

   ```sql
   -- âœ… å¥½ï¼šåˆ›å»ºè®¢é˜…æ—¶è‡ªåŠ¨åˆ›å»ºå¤åˆ¶æ§½
   CREATE SUBSCRIPTION my_subscription
   CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
   PUBLICATION my_publication;
   -- è‡ªåŠ¨åˆ›å»ºå¤åˆ¶æ§½ï¼Œé˜²æ­¢ WAL è¢«åˆ é™¤
   ```

5. **é…ç½®åˆé€‚çš„åŒæ­¥æäº¤çº§åˆ«**ï¼ˆå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨ï¼‰

   ```sql
   -- âœ… å¥½ï¼šè®¢é˜…ç«¯ä½¿ç”¨æœ¬åœ°æäº¤ï¼ˆæ€§èƒ½å¥½ï¼‰
   CREATE SUBSCRIPTION my_subscription
   CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
   PUBLICATION my_publication
   WITH (synchronous_commit = 'local');

   -- âœ… å¥½ï¼šå…³é”®æ•°æ®ä½¿ç”¨è¿œç¨‹æäº¤ï¼ˆæ•°æ®å®‰å…¨ï¼‰
   CREATE SUBSCRIPTION critical_subscription
   CONNECTION 'host=primary_host port=5432 user=replicator password=password dbname=mydb'
   PUBLICATION critical_publication
   WITH (synchronous_commit = 'remote_apply');
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å… WAL çº§åˆ«è®¾ç½®é”™è¯¯**ï¼ˆå¿…é¡»è®¾ç½®ä¸º logicalï¼‰
2. **é¿å…å¤åˆ¶æ§½æ•°é‡ä¸è¶³**ï¼ˆå¯¼è‡´è®¢é˜…åˆ›å»ºå¤±è´¥ï¼‰
3. **é¿å…å¿½ç•¥ç›‘æ§**ï¼ˆæ— æ³•åŠæ—¶å‘ç°å¤åˆ¶å»¶è¿Ÿå’Œé”™è¯¯ï¼‰
4. **é¿å…æ‰‹åŠ¨åˆ é™¤å¤åˆ¶æ§½**ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼‰

### 5.2 æ€§èƒ½ä¼˜åŒ–

**æ¨èåšæ³•**ï¼š

1. **é€‰æ‹©æ€§å¤åˆ¶**ï¼ˆåªå¤åˆ¶éœ€è¦çš„è¡¨ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ï¼‰

   ```sql
   -- âœ… å¥½ï¼šåªå¤åˆ¶éœ€è¦çš„è¡¨
   CREATE PUBLICATION my_publication
   FOR TABLE users, orders, products;

   -- âŒ ä¸å¥½ï¼šå¤åˆ¶æ‰€æœ‰è¡¨ï¼ˆåŒ…æ‹¬ä¸éœ€è¦çš„è¡¨ï¼‰
   CREATE PUBLICATION all_tables FOR ALL TABLES;
   ```

2. **åœ¨è®¢é˜…ç«¯åˆ›å»ºåˆé€‚çš„ç´¢å¼•**ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šè®¢é˜…ç«¯åˆ›å»ºç´¢å¼•ï¼ˆä¸å½±å“ä¸»åº“æ€§èƒ½ï¼‰
   CREATE INDEX idx_users_email ON users(email);
   CREATE INDEX idx_orders_date ON orders(order_date);

   -- âŒ ä¸å¥½ï¼šè®¢é˜…ç«¯æ²¡æœ‰ç´¢å¼•ï¼ˆæŸ¥è¯¢æ€§èƒ½å·®ï¼‰
   ```

3. **ä½¿ç”¨æ‰¹é‡æ“ä½œ**ï¼ˆå‡å°‘ç½‘ç»œå¾€è¿”ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæ‰¹é‡æ’å…¥ï¼ˆä¸»åº“ï¼‰
   INSERT INTO orders (customer_id, total_amount)
   VALUES
       (1, 100.00),
       (2, 200.00),
       (3, 300.00);
   -- é€»è¾‘å¤åˆ¶ä¼šæ‰¹é‡ä¼ è¾“å’Œåº”ç”¨

   -- âŒ ä¸å¥½ï¼šé€æ¡æ’å…¥ï¼ˆç½‘ç»œå¾€è¿”å¤šï¼‰
   INSERT INTO orders (customer_id, total_amount) VALUES (1, 100.00);
   INSERT INTO orders (customer_id, total_amount) VALUES (2, 200.00);
   INSERT INTO orders (customer_id, total_amount) VALUES (3, 300.00);
   ```

4. **ä¼˜åŒ–è®¢é˜…ç«¯é…ç½®**ï¼ˆæå‡åº”ç”¨æ€§èƒ½ï¼‰

   ```conf
   # âœ… å¥½ï¼šè®¢é˜…ç«¯é…ç½®ä¼˜åŒ–
   max_logical_replication_workers = 4  # å¢åŠ å·¥ä½œè¿›ç¨‹æ•°
   max_sync_workers_per_subscription = 2  # æ¯ä¸ªè®¢é˜…çš„åŒæ­¥å·¥ä½œè¿›ç¨‹æ•°
   shared_buffers = 256MB  # å¢åŠ å…±äº«ç¼“å†²åŒº
   ```

5. **ä½¿ç”¨è¿‡æ»¤æ¡ä»¶å‡å°‘æ•°æ®ä¼ è¾“**ï¼ˆPostgreSQL 15+ï¼‰

   ```sql
   -- âœ… å¥½ï¼šåªå¤åˆ¶æ´»è·ƒç”¨æˆ·ï¼ˆå‡å°‘æ•°æ®ä¼ è¾“ï¼‰
   CREATE PUBLICATION active_users_publication
   FOR TABLE users
   WHERE (status = 'active');

   -- âŒ ä¸å¥½ï¼šå¤åˆ¶æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ä¸æ´»è·ƒç”¨æˆ·ï¼‰
   CREATE PUBLICATION all_users_publication
   FOR TABLE users;
   ```

6. **å®šæœŸæ¸…ç†å¤åˆ¶æ§½**ï¼ˆé˜²æ­¢ WAL ç§¯ç´¯ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸæ£€æŸ¥å¤åˆ¶æ§½
   SELECT
       slot_name,
       pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) AS lag
   FROM pg_replication_slots
   WHERE slot_type = 'logical';

   -- å¦‚æœè®¢é˜…å·²åˆ é™¤ï¼Œæ‰‹åŠ¨åˆ é™¤å¤åˆ¶æ§½
   SELECT pg_drop_replication_slot('old_subscription_slot');
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…å¤åˆ¶ä¸éœ€è¦çš„è¡¨**ï¼ˆæµªè´¹ç½‘ç»œå¸¦å®½å’Œå­˜å‚¨ï¼‰
2. **é¿å…è®¢é˜…ç«¯æ²¡æœ‰ç´¢å¼•**ï¼ˆæŸ¥è¯¢æ€§èƒ½å·®ï¼‰
3. **é¿å…å¿½ç•¥æ€§èƒ½ç›‘æ§**ï¼ˆæ— æ³•å‘ç°æ€§èƒ½ç“¶é¢ˆï¼‰
4. **é¿å…å¤åˆ¶æ§½ç§¯ç´¯**ï¼ˆå¯¼è‡´ WAL æ–‡ä»¶ç§¯ç´¯ï¼Œå ç”¨ç£ç›˜ç©ºé—´ï¼‰

## 6. å‚è€ƒèµ„æ–™

### 6.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)**
  - é€»è¾‘å¤åˆ¶å®Œæ•´å‚è€ƒæ‰‹å†Œ
  - å‘å¸ƒå’Œè®¢é˜…é…ç½®

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å‘å¸ƒ](https://www.postgresql.org/docs/current/sql-createpublication.html)**
  - CREATE PUBLICATION å‘½ä»¤è¯¦è§£
  - å‘å¸ƒé…ç½®å’Œç®¡ç†

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è®¢é˜…](https://www.postgresql.org/docs/current/sql-createsubscription.html)**
  - CREATE SUBSCRIPTION å‘½ä»¤è¯¦è§£
  - è®¢é˜…é…ç½®å’Œç®¡ç†

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶é…ç½®](https://www.postgresql.org/docs/current/logical-replication-config.html)**
  - é€»è¾‘å¤åˆ¶é…ç½®å‚æ•°
  - æ€§èƒ½ä¼˜åŒ–é…ç½®

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶ç›‘æ§](https://www.postgresql.org/docs/current/monitoring-replication.html)**
  - é€»è¾‘å¤åˆ¶ç›‘æ§æ–¹æ³•
  - å¤åˆ¶å»¶è¿Ÿç›‘æ§

### 6.2 æŠ€æœ¯è®ºæ–‡

- **Kemme, B., & Alonso, G. (2000). "Database Replication: A Tale of Research across Communities."**
  - ä¼šè®®: VLDB 2000
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶æŠ€æœ¯çš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°æ€»ç»“äº†æ•°æ®åº“å¤åˆ¶çš„å„ç§æ–¹æ³•å’ŒæŒ‘æˆ˜ï¼ŒåŒ…æ‹¬é€»è¾‘å¤åˆ¶

- **Bernstein, P. A., et al. (1987). "Concurrency Control and Recovery in Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: æ•°æ®åº“å¹¶å‘æ§åˆ¶å’Œæ¢å¤çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†é˜è¿°äº†æ•°æ®åº“å¤åˆ¶å’Œæ•…éšœæ¢å¤çš„ç†è®ºåŸºç¡€

- **Gray, J., et al. (1996). "The Dangers of Replication and a Solution."**
  - ä¼šè®®: SIGMOD 1996
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶ä¸€è‡´æ€§çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: åˆ†æäº†æ•°æ®åº“å¤åˆ¶çš„å±é™©æ€§å’Œè§£å†³æ–¹æ¡ˆï¼Œä¸ºé€»è¾‘å¤åˆ¶æä¾›äº†ç†è®ºåŸºç¡€

### 6.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)**
  - é€»è¾‘å¤åˆ¶æœ€ä½³å®è·µ
  - é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–

- **[2ndQuadrant - PostgreSQL é€»è¾‘å¤åˆ¶](https://www.2ndquadrant.com/en/blog/postgresql-logical-replication/)**
  - é€»è¾‘å¤åˆ¶å®æˆ˜
  - é€»è¾‘å¤åˆ¶åº”ç”¨æ¡ˆä¾‹

- **[Percona - PostgreSQL é€»è¾‘å¤åˆ¶](https://www.percona.com/blog/postgresql-logical-replication/)**
  - é€»è¾‘å¤åˆ¶é…ç½®å’Œç®¡ç†
  - é€»è¾‘å¤åˆ¶æ•…éšœå¤„ç†

- **[EnterpriseDB - PostgreSQL é€»è¾‘å¤åˆ¶è¯¦è§£](https://www.enterprisedb.com/postgres-tutorials/postgresql-logical-replication)**
  - é€»è¾‘å¤åˆ¶æ·±å…¥è§£æ
  - é€»è¾‘å¤åˆ¶è®¾è®¡æŒ‡å—

### 6.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Logical Replication](https://wiki.postgresql.org/wiki/Logical_Replication)**
  - é€»è¾‘å¤åˆ¶ä½¿ç”¨æŒ‡å—
  - å¸¸è§é—®é¢˜è§£ç­”

- **[PostgreSQL Wiki - Replication](https://wiki.postgresql.org/wiki/Replication)**
  - å¤åˆ¶æ–¹æ¡ˆå¯¹æ¯”
  - å¤åˆ¶é…ç½®æŒ‡å—

- **[Stack Overflow - PostgreSQL Logical Replication](https://stackoverflow.com/questions/tagged/postgresql+logical-replication)**
  - é€»è¾‘å¤åˆ¶ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- [å¤åˆ¶ä¸é«˜å¯ç”¨](./å¤åˆ¶ä¸é«˜å¯ç”¨.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-27
