# PostgreSQL é«˜å¯ç”¨ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-60

## ğŸ“‘ ç›®å½•

- [PostgreSQL é«˜å¯ç”¨ä½“ç³»è¯¦è§£](#postgresql-é«˜å¯ç”¨ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾](#2-é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 é«˜å¯ç”¨ä½“ç³»æ¶æ„](#21-é«˜å¯ç”¨ä½“ç³»æ¶æ„)
    - [2.2 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹](#22-é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹)
  - [3. é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£](#3-é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£)
    - [3.1 æµå¤åˆ¶æ–¹æ¡ˆ](#31-æµå¤åˆ¶æ–¹æ¡ˆ)
    - [3.2 é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ](#32-é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ)
    - [3.3 Patroni é«˜å¯ç”¨æ–¹æ¡ˆ](#33-patroni-é«˜å¯ç”¨æ–¹æ¡ˆ)
    - [3.4 è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ](#34-è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é«˜å¯ç”¨è®¾è®¡åŸåˆ™](#51-é«˜å¯ç”¨è®¾è®¡åŸåˆ™)
    - [5.2 é«˜å¯ç”¨å»ºè®®](#52-é«˜å¯ç”¨å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é«˜å¯ç”¨ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œæ•´çš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼š

1. **æµå¤åˆ¶**: ä¸»ä»å¤åˆ¶ï¼Œæ•°æ®åŒæ­¥
2. **é€»è¾‘å¤åˆ¶**: è¡¨çº§å¤åˆ¶ï¼Œé€‰æ‹©æ€§å¤åˆ¶
3. **è‡ªåŠ¨æ•…éšœè½¬ç§»**: Patroniã€repmgrç­‰å·¥å…·
4. **è¯»å†™åˆ†ç¦»**: ä¸»ä»è¯»å†™åˆ†ç¦»
5. **è´Ÿè½½å‡è¡¡**: è¿æ¥è´Ÿè½½å‡è¡¡

**åº”ç”¨åœºæ™¯**:

- **ä¸šåŠ¡è¿ç»­æ€§**: ä¿è¯ä¸šåŠ¡è¿ç»­æ€§
- **æ•°æ®å®‰å…¨**: ä¿æŠ¤æ•°æ®å®‰å…¨
- **æ€§èƒ½æå‡**: æå‡è¯»å†™æ€§èƒ½
- **ç¾éš¾æ¢å¤**: æ”¯æŒç¾éš¾æ¢å¤

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å¯ç”¨æ€§** | é«˜å¯ç”¨æå‡å¯ç”¨æ€§ | **99.9%+** |
| **æ•…éšœæ¢å¤æ—¶é—´** | è‡ªåŠ¨æ•…éšœè½¬ç§» | **< 30ç§’** |
| **æ•°æ®ä¸¢å¤±** | åŒæ­¥å¤åˆ¶é›¶ä¸¢å¤± | **0** |
| **æ€§èƒ½æå‡** | è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½ | **+100%** |

## 2. é«˜å¯ç”¨ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 é«˜å¯ç”¨ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((é«˜å¯ç”¨ä½“ç³»))
    æµå¤åˆ¶
      ç‰©ç†å¤åˆ¶
        ä¸»ä»å¤åˆ¶
        æ•°æ®åŒæ­¥
        WALä¼ è¾“
      åŒæ­¥å¤åˆ¶
        åŒæ­¥æäº¤
        é›¶æ•°æ®ä¸¢å¤±
        æ€§èƒ½å½±å“
      å¼‚æ­¥å¤åˆ¶
        å¼‚æ­¥æäº¤
        æ€§èƒ½ä¼˜å…ˆ
        å¯èƒ½ä¸¢å¤±
      çº§è”å¤åˆ¶
        å¤šçº§å¤åˆ¶
        æ‰©å±•æ€§
        å»¶è¿Ÿ
    é€»è¾‘å¤åˆ¶
      è¡¨çº§å¤åˆ¶
        é€‰æ‹©æ€§å¤åˆ¶
        è·¨ç‰ˆæœ¬å¤åˆ¶
        çµæ´»é…ç½®
      å‘å¸ƒè®¢é˜…
        å‘å¸ƒè€…
        è®¢é˜…è€…
        è¿‡æ»¤æ¡ä»¶
      å†²çªå¤„ç†
        å†²çªæ£€æµ‹
        å†²çªè§£å†³
        å†²çªç­–ç•¥
    æ•…éšœè½¬ç§»
      æ‰‹åŠ¨åˆ‡æ¢
        æ‰‹åŠ¨åˆ‡æ¢
        ç®€å•åœºæ™¯
      è‡ªåŠ¨åˆ‡æ¢
        Patroni
        repmgr
        pg_auto_failover
      åˆ‡æ¢ç­–ç•¥
        æ•…éšœæ£€æµ‹
        åˆ‡æ¢å†³ç­–
        åˆ‡æ¢æ‰§è¡Œ
    è¯»å†™åˆ†ç¦»
      ä¸»ä»åˆ†ç¦»
        ä¸»åº“å†™
        ä»åº“è¯»
        è´Ÿè½½å‡è¡¡
      è¿æ¥è·¯ç”±
        åº”ç”¨å±‚è·¯ç”±
        ä¸­é—´ä»¶è·¯ç”±
        ä»£ç†è·¯ç”±
      ä¸€è‡´æ€§ä¿è¯
        è¯»ä¸€è‡´æ€§
        å»¶è¿Ÿå¤„ç†
        æœ€ç»ˆä¸€è‡´æ€§
    è´Ÿè½½å‡è¡¡
      è¿æ¥æ± 
        PgBouncer
        è¿æ¥å¤ç”¨
        è¿æ¥ç®¡ç†
      è´Ÿè½½å‡è¡¡å™¨
        HAProxy
        Nginx
        äº‘è´Ÿè½½å‡è¡¡
      å¥åº·æ£€æŸ¥
        å¥åº·æ£€æµ‹
        æ•…éšœæ£€æµ‹
        è‡ªåŠ¨åˆ‡æ¢
    ç›‘æ§å‘Šè­¦
      çŠ¶æ€ç›‘æ§
        ä¸»ä»çŠ¶æ€
        å¤åˆ¶å»¶è¿Ÿ
        è¿æ¥çŠ¶æ€
      æ€§èƒ½ç›‘æ§
        æŸ¥è¯¢æ€§èƒ½
        å¤åˆ¶æ€§èƒ½
        èµ„æºä½¿ç”¨
      å‘Šè­¦é€šçŸ¥
        æ•…éšœå‘Šè­¦
        å»¶è¿Ÿå‘Šè­¦
        æ€§èƒ½å‘Šè­¦
```

### 2.2 é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©æµç¨‹

```mermaid
flowchart TD
    A[é«˜å¯ç”¨éœ€æ±‚] --> B{æ•°æ®ä¸¢å¤±å®¹å¿åº¦?}
    B -->|é›¶ä¸¢å¤±| C[åŒæ­¥å¤åˆ¶]
    B -->|å¯å®¹å¿| D[å¼‚æ­¥å¤åˆ¶]
    C --> E{æ€§èƒ½è¦æ±‚?}
    D --> E
    E -->|é«˜æ€§èƒ½| F[å¼‚æ­¥å¤åˆ¶+è¯»å†™åˆ†ç¦»]
    E -->|å¹³è¡¡| G[åŒæ­¥å¤åˆ¶+è¯»å†™åˆ†ç¦»]
    F --> H{è‡ªåŠ¨åˆ‡æ¢?}
    G --> H
    H -->|æ˜¯| I[Patroni/repmgr]
    H -->|å¦| J[æ‰‹åŠ¨åˆ‡æ¢]
    I --> K[ç›‘æ§å‘Šè­¦]
    J --> K
    K --> L[é«˜å¯ç”¨æ–¹æ¡ˆå®Œæˆ]
```

## 3. é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£

### 3.1 æµå¤åˆ¶æ–¹æ¡ˆ

**æµå¤åˆ¶ç±»å‹å¯¹æ¯”**:

| å¤åˆ¶ç±»å‹ | æ•°æ®ä¸¢å¤± | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|---------|------|---------|--------|
| **åŒæ­¥å¤åˆ¶** | 0 | â­â­â­ | é‡‘èã€å…³é”®ä¸šåŠ¡ | â­â­â­â­â­ |
| **å¼‚æ­¥å¤åˆ¶** | å¯èƒ½ä¸¢å¤± | â­â­â­â­â­ | ä¸€èˆ¬ä¸šåŠ¡ | â­â­â­â­ |
| **çº§è”å¤åˆ¶** | å¯èƒ½ä¸¢å¤± | â­â­â­â­ | å¤šåœ°åŸŸéƒ¨ç½² | â­â­â­ |

**æµå¤åˆ¶é…ç½®**:

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
synchronous_standby_names = 'standby1,standby2'  -- åŒæ­¥å¤åˆ¶

-- 2. ä¸»åº“é…ç½®ï¼ˆpg_hba.confï¼‰
host    replication    repuser    192.168.1.0/24    md5

-- 3. åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER repuser WITH REPLICATION PASSWORD 'password';

-- 4. ä»åº“åŸºç¡€å¤‡ä»½
pg_basebackup -h primary_host -D /var/lib/postgresql/data -U repuser -P -W -R

-- 5. ä»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
primary_conninfo = 'host=primary_host port=5432 user=repuser password=password'
```

### 3.2 é€»è¾‘å¤åˆ¶æ–¹æ¡ˆ

**é€»è¾‘å¤åˆ¶ç‰¹ç‚¹**:

| ç‰¹ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **è¡¨çº§å¤åˆ¶** | é€‰æ‹©æ€§å¤åˆ¶è¡¨ | çµæ´» |
| **è·¨ç‰ˆæœ¬** | æ”¯æŒè·¨ç‰ˆæœ¬å¤åˆ¶ | å…¼å®¹æ€§å¥½ |
| **è¿‡æ»¤æ¡ä»¶** | æ”¯æŒè¿‡æ»¤æ¡ä»¶ | ç²¾ç¡®æ§åˆ¶ |

**é€»è¾‘å¤åˆ¶é…ç½®**:

```sql
-- 1. ä¸»åº“åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION pub_orders FOR TABLE orders, order_items;

-- 2. ä»åº“åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION sub_orders
CONNECTION 'host=primary_host port=5432 dbname=mydb user=repuser password=password'
PUBLICATION pub_orders;

-- 3. æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_subscription;
SELECT * FROM pg_stat_replication;
```

### 3.3 Patroni é«˜å¯ç”¨æ–¹æ¡ˆ

**Patroni ç‰¹ç‚¹**:

| ç‰¹ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **è‡ªåŠ¨æ•…éšœè½¬ç§»** | è‡ªåŠ¨æ£€æµ‹å’Œåˆ‡æ¢ | é«˜å¯ç”¨ |
| **é…ç½®ç®¡ç†** | é›†ä¸­é…ç½®ç®¡ç† | æ˜“ç®¡ç† |
| **å¤šç§åç«¯** | æ”¯æŒå¤šç§åç«¯ | çµæ´» |

**Patroni é…ç½®ç¤ºä¾‹**:

```yaml
# patroni.yml
scope: postgres
namespace: /db/
name: postgresql1

restapi:
  listen: 127.0.0.1:8008
  connect_address: 127.0.0.1:8008

etcd:
  hosts: 127.0.0.1:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        max_connections: 100
        max_wal_senders: 10
        max_replication_slots: 10

postgresql:
  listen: 127.0.0.1:5432
  connect_address: 127.0.0.1:5432
  data_dir: /var/lib/postgresql/data
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: repuser
      password: password
    superuser:
      username: postgres
      password: password
  parameters:
    unix_socket_directories: '/var/run/postgresql'
```

### 3.4 è¯»å†™åˆ†ç¦»æ–¹æ¡ˆ

**è¯»å†™åˆ†ç¦»æ¶æ„**:

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆå†™æ“ä½œï¼‰
-- åº”ç”¨è¿æ¥åˆ°ä¸»åº“è¿›è¡Œå†™æ“ä½œ

-- 2. ä»åº“é…ç½®ï¼ˆè¯»æ“ä½œï¼‰
-- åº”ç”¨è¿æ¥åˆ°ä»åº“è¿›è¡Œè¯»æ“ä½œ

-- 3. ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± å’Œè·¯ç”±
-- pgbouncer.ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby_host port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦å®ç°é«˜å¯ç”¨ï¼Œä¿è¯é›¶æ•°æ®ä¸¢å¤±ã€‚

**é—®é¢˜åˆ†æ**:

1. **é›¶æ•°æ®ä¸¢å¤±**: éœ€è¦åŒæ­¥å¤åˆ¶
2. **é«˜å¯ç”¨**: éœ€è¦è‡ªåŠ¨æ•…éšœè½¬ç§»
3. **æ€§èƒ½è¦æ±‚**: éœ€è¦è¯»å†™åˆ†ç¦»

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆåŒæ­¥å¤åˆ¶ï¼‰
-- postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
synchronous_standby_names = 'standby1,standby2'

-- 2. ä»åº“é…ç½®
-- postgresql.conf
primary_conninfo = 'host=primary_host port=5432 user=repuser password=password application_name=standby1'
hot_standby = on

-- 3. ä½¿ç”¨Patroniå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
# patroni.yml
scope: postgres
name: postgresql1
restapi:
  listen: 0.0.0.0:8008
etcd:
  hosts: etcd1:2379,etcd2:2379,etcd3:2379
bootstrap:
  dcs:
    synchronous_mode: true
    synchronous_mode_strict: true

-- 4. è¯»å†™åˆ†ç¦»é…ç½®
-- åº”ç”¨å±‚è·¯ç”±ï¼šå†™æ“ä½œåˆ°ä¸»åº“ï¼Œè¯»æ“ä½œåˆ°ä»åº“
-- æˆ–ä½¿ç”¨HAProxyå®ç°è‡ªåŠ¨è·¯ç”±
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å¯ç”¨æ€§** | 99.0% | **99.99%** | **æå‡** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 30 åˆ†é’Ÿ | **< 30ç§’** | **98%** â¬‡ï¸ |
| **æ•°æ®ä¸¢å¤±** | å¯èƒ½ä¸¢å¤± | **0** | **100%** â¬‡ï¸ |
| **è¯»æ€§èƒ½** | åŸºå‡† | **+100%** | **æå‡** |

### 4.2 æ¡ˆä¾‹: ç”µå•†å¹³å°é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦å®ç°é«˜å¯ç”¨ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä¸»ä»å¤åˆ¶ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰
-- postgresql.conf
wal_level = replica
max_wal_senders = 10

-- 2. è¯»å†™åˆ†ç¦»
-- ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± 
-- pgbouncer.ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby1_host port=5432 dbname=mydb
mydb_ro2 = host=standby2_host port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 2000
default_pool_size = 50

-- 3. è´Ÿè½½å‡è¡¡
-- ä½¿ç”¨HAProxyå®ç°è´Ÿè½½å‡è¡¡
# haproxy.cfg
global
    maxconn 4096

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend pg_frontend
    bind *:5432
    default_backend pg_backend

backend pg_backend
    balance roundrobin
    option pgsql-check user postgres
    server pg1 primary_host:5432 check
    server pg2 standby1_host:5432 check backup
    server pg3 standby2_host:5432 check backup

-- 4. ç›‘æ§å‘Šè­¦
-- ä½¿ç”¨Prometheus + Grafanaç›‘æ§
-- ç›‘æ§æŒ‡æ ‡ï¼šä¸»ä»çŠ¶æ€ã€å¤åˆ¶å»¶è¿Ÿã€è¿æ¥æ•°ç­‰
```

## 5. æœ€ä½³å®è·µ

### 5.1 é«˜å¯ç”¨è®¾è®¡åŸåˆ™

1. **å¤šå‰¯æœ¬**: è‡³å°‘2ä¸ªå‰¯æœ¬
2. **è‡ªåŠ¨åˆ‡æ¢**: ä½¿ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»å·¥å…·
3. **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦
4. **å®šæœŸæ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ

### 5.2 é«˜å¯ç”¨å»ºè®®

1. **åŒæ­¥å¤åˆ¶**: å…³é”®ä¸šåŠ¡ä½¿ç”¨åŒæ­¥å¤åˆ¶
2. **è¯»å†™åˆ†ç¦»**: ä½¿ç”¨è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½
3. **è´Ÿè½½å‡è¡¡**: ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨
4. **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦

## 6. å‚è€ƒèµ„æ–™

- [å¤åˆ¶ä¸é«˜å¯ç”¨](./å¤åˆ¶ä¸é«˜å¯ç”¨.md)
- [é€»è¾‘å¤åˆ¶è¯¦è§£](./é€»è¾‘å¤åˆ¶è¯¦è§£.md)
- [è¿æ¥æ± ç®¡ç†](./è¿æ¥æ± ç®¡ç†.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-60
