# PostgreSQL æ—¥å¿—ç®¡ç†ä¸åˆ†æ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-21

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ—¥å¿—ç®¡ç†ä¸åˆ†æ](#postgresql-æ—¥å¿—ç®¡ç†ä¸åˆ†æ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 æ—¥å¿—ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#14-æ—¥å¿—ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. æ—¥å¿—é…ç½®](#2-æ—¥å¿—é…ç½®)
    - [2.1 æ—¥å¿—çº§åˆ«](#21-æ—¥å¿—çº§åˆ«)
    - [2.2 æ—¥å¿—æ ¼å¼](#22-æ—¥å¿—æ ¼å¼)
    - [2.3 æ—¥å¿—è¾“å‡º](#23-æ—¥å¿—è¾“å‡º)
  - [3. æ—¥å¿—åˆ†æ](#3-æ—¥å¿—åˆ†æ)
    - [3.1 æ…¢æŸ¥è¯¢æ—¥å¿—](#31-æ…¢æŸ¥è¯¢æ—¥å¿—)
    - [3.2 é”™è¯¯æ—¥å¿—](#32-é”™è¯¯æ—¥å¿—)
    - [3.3 è¿æ¥æ—¥å¿—](#33-è¿æ¥æ—¥å¿—)
  - [4. æ—¥å¿—å·¥å…·](#4-æ—¥å¿—å·¥å…·)
    - [4.1 pgBadger](#41-pgbadger)
    - [4.2 è‡ªå®šä¹‰åˆ†æ](#42-è‡ªå®šä¹‰åˆ†æ)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ—¥å¿—åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ—¥å¿—åˆ†æç³»ç»ŸçœŸå®æ¡ˆä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ—¥å¿—é…ç½®](#61-æ—¥å¿—é…ç½®)
    - [6.2 æ—¥å¿—åˆ†æ](#62-æ—¥å¿—åˆ†æ)
    - [6.3 æ€§èƒ½ä¼˜åŒ–](#63-æ€§èƒ½ä¼˜åŒ–)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ—¥å¿—ç®¡ç†ä¸åˆ†æçš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼š

1. **é—®é¢˜è¯Šæ–­**: é€šè¿‡æ—¥å¿—è¯Šæ–­é—®é¢˜
2. **æ€§èƒ½åˆ†æ**: åˆ†ææ…¢æŸ¥è¯¢å’Œæ€§èƒ½é—®é¢˜
3. **å®‰å…¨å®¡è®¡**: å®¡è®¡æ•°æ®åº“è®¿é—®å’Œæ“ä½œ
4. **ç›‘æ§å‘Šè­¦**: ç›‘æ§æ•°æ®åº“çŠ¶æ€å’Œå¼‚å¸¸

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ä¼˜åŒ–**: åˆ†ææ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–æ€§èƒ½
- **æ•…éšœæ’æŸ¥**: æ’æŸ¥æ•°æ®åº“æ•…éšœ
- **å®‰å…¨å®¡è®¡**: å®¡è®¡æ•°æ®åº“è®¿é—®
- **ç›‘æ§å‘Šè­¦**: ç›‘æ§æ•°æ®åº“çŠ¶æ€

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **é—®é¢˜è¯Šæ–­æ—¶é—´** | æ—¥å¿—åˆ†æç¼©çŸ­è¯Šæ–­æ—¶é—´ | **-70%** |
| **æ€§èƒ½ä¼˜åŒ–æ•ˆç‡** | æ…¢æŸ¥è¯¢åˆ†ææå‡æ•ˆç‡ | **+80%** |
| **å®‰å…¨å®¡è®¡** | å®Œæ•´çš„å®¡è®¡æ—¥å¿— | **100%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | å¿«é€Ÿå®šä½é—®é¢˜ | **-60%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **é—®é¢˜è¯Šæ–­æ—¶é—´**: æ—¥å¿—åˆ†æç¼©çŸ­é—®é¢˜è¯Šæ–­æ—¶é—´ 70%
- **æ€§èƒ½ä¼˜åŒ–æ•ˆç‡**: æ…¢æŸ¥è¯¢åˆ†ææå‡æ€§èƒ½ä¼˜åŒ–æ•ˆç‡ 80%
- **å®‰å…¨å®¡è®¡**: æä¾›å®Œæ•´çš„å®¡è®¡æ—¥å¿—ï¼Œæ”¯æŒå®‰å…¨å®¡è®¡
- **æ•…éšœæ¢å¤æ—¶é—´**: å¿«é€Ÿå®šä½é—®é¢˜ï¼Œç¼©çŸ­æ•…éšœæ¢å¤æ—¶é—´ 60%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡æ—¥å¿—é…ç½®å’Œç®¡ç†
- ç†è§£ä¸åŒæ—¥å¿—ç±»å‹å’Œç”¨é€”
- å­¦ä¼šæ—¥å¿—åˆ†æå’Œé—®é¢˜è¯Šæ–­
- æŒæ¡æ—¥å¿—å·¥å…·çš„ä½¿ç”¨

### 1.4 æ—¥å¿—ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ—¥å¿—ç®¡ç†ä½“ç³»))
    æ—¥å¿—ç±»å‹
      é”™è¯¯æ—¥å¿—
        é”™è¯¯çº§åˆ«
        é”™è¯¯ä¿¡æ¯
        é”™è¯¯ç»Ÿè®¡
      æ…¢æŸ¥è¯¢æ—¥å¿—
        æ…¢æŸ¥è¯¢è®°å½•
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
      è¿æ¥æ—¥å¿—
        è¿æ¥è®°å½•
        æ–­å¼€è®°å½•
        è¿æ¥ç»Ÿè®¡
      å®¡è®¡æ—¥å¿—
        æ“ä½œå®¡è®¡
        è®¿é—®å®¡è®¡
        å®‰å…¨å®¡è®¡
    æ—¥å¿—é…ç½®
      æ—¥å¿—çº§åˆ«
        DEBUG
        INFO
        WARNING
        ERROR
      æ—¥å¿—æ ¼å¼
        æ ‡å‡†æ ¼å¼
        è‡ªå®šä¹‰æ ¼å¼
        CSVæ ¼å¼
        JSONæ ¼å¼
      æ—¥å¿—è¾“å‡º
        æ–‡ä»¶è¾“å‡º
        æ ‡å‡†è¾“å‡º
        ç³»ç»Ÿæ—¥å¿—
    æ—¥å¿—åˆ†æ
      pgBadger
        æ—¥å¿—åˆ†æ
        æŠ¥è¡¨ç”Ÿæˆ
        æ€§èƒ½åˆ†æ
      è‡ªå®šä¹‰åˆ†æ
        æ—¥å¿—è§£æ
        ç»Ÿè®¡åˆ†æ
        å‘Šè­¦é€šçŸ¥
    æ—¥å¿—ç®¡ç†
      æ—¥å¿—è½®è½¬
        æ—¥å¿—å½’æ¡£
        æ—¥å¿—æ¸…ç†
        æ—¥å¿—å‹ç¼©
      æ—¥å¿—ç›‘æ§
        æ—¥å¿—ç›‘æ§
        å‘Šè­¦é€šçŸ¥
        æ—¥å¿—ç»Ÿè®¡
```

## 2. æ—¥å¿—é…ç½®

### 2.1 æ—¥å¿—çº§åˆ«

**æ—¥å¿—çº§åˆ«é…ç½®** (postgresql.conf):

```conf
# æ—¥å¿—çº§åˆ«
log_min_messages = warning  # debug5, debug4, debug3, debug2, debug1, info, notice, warning, error, log, fatal, panic

# æ—¥å¿—è¯­å¥çº§åˆ«
log_min_duration_statement = 1000  # è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ 1000ms çš„è¯­å¥

# è®°å½•æ‰€æœ‰è¯­å¥
log_statement = 'all'  # none, ddl, mod, all

# è®°å½•è¿æ¥å’Œæ–­å¼€
log_connections = on
log_disconnections = on
```

### 2.2 æ—¥å¿—æ ¼å¼

**æ—¥å¿—æ ¼å¼é…ç½®**:

```conf
# æ—¥å¿—æ ¼å¼
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# CSV æ ¼å¼æ—¥å¿—
log_destination = 'csvlog'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
```

### 2.3 æ—¥å¿—è¾“å‡º

**æ—¥å¿—è¾“å‡ºé…ç½®**:

```conf
# è¾“å‡ºåˆ°æ–‡ä»¶
log_destination = 'stderr'
logging_collector = on

# è¾“å‡ºåˆ° syslog
log_destination = 'syslog'
syslog_facility = 'LOCAL0'
syslog_ident = 'postgresql'

# è¾“å‡ºåˆ° Windows äº‹ä»¶æ—¥å¿—ï¼ˆWindowsï¼‰
log_destination = 'eventlog'
```

## 3. æ—¥å¿—åˆ†æ

### 3.1 æ…¢æŸ¥è¯¢æ—¥å¿—

**æ…¢æŸ¥è¯¢åˆ†æ**:

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼ˆä½¿ç”¨ pg_stat_statementsï¼‰
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢è¯¦æƒ…
SELECT
    query,
    calls,
    total_exec_time / 1000 AS total_seconds,
    mean_exec_time / 1000 AS mean_seconds,
    (shared_blks_hit::float / NULLIF(shared_blks_hit + shared_blks_read, 0)) * 100 AS cache_hit_ratio
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC;
```

### 3.2 é”™è¯¯æ—¥å¿—

**é”™è¯¯æ—¥å¿—åˆ†æ**:

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR /var/log/postgresql/postgresql-*.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
tail -n 100 /var/log/postgresql/postgresql-*.log | grep ERROR

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep ERROR /var/log/postgresql/postgresql-*.log | awk '{print $5}' | sort | uniq -c | sort -rn
```

### 3.3 è¿æ¥æ—¥å¿—

**è¿æ¥æ—¥å¿—åˆ†æ**:

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres');
```

## 4. æ—¥å¿—å·¥å…·

### 4.1 pgBadger

**pgBadger ä½¿ç”¨**:

```bash
# å®‰è£… pgBadger
# Ubuntu/Debian
sudo apt-get install pgbadger

# ç”ŸæˆæŠ¥å‘Š
pgbadger /var/log/postgresql/postgresql-*.log -o report.html

# æŒ‡å®šæ—¶é—´èŒƒå›´
pgbadger /var/log/postgresql/postgresql-*.log \
    --start-time "2025-01-01 00:00:00" \
    --end-time "2025-01-31 23:59:59" \
    -o report.html

# å¢é‡åˆ†æ
pgbadger /var/log/postgresql/postgresql-*.log \
    --incremental \
    --outdir /var/reports/pgbadger
```

### 4.2 è‡ªå®šä¹‰åˆ†æ

**Python æ—¥å¿—åˆ†æè„šæœ¬**:

```python
# æ—¥å¿—åˆ†æè„šæœ¬
import re
from collections import defaultdict

class PostgresLogAnalyzer:
    def __init__(self, log_file):
        self.log_file = log_file
        self.slow_queries = []
        self.errors = []
        self.connections = defaultdict(int)

    def analyze(self):
        """åˆ†ææ—¥å¿—"""
        with open(self.log_file, 'r') as f:
            for line in f:
                self.parse_line(line)

        return {
            'slow_queries': self.slow_queries,
            'errors': self.errors,
            'connections': dict(self.connections)
        }

    def parse_line(self, line):
        """è§£ææ—¥å¿—è¡Œ"""
        # è§£ææ…¢æŸ¥è¯¢
        if 'duration:' in line:
            match = re.search(r'duration: ([\d.]+) ms', line)
            if match:
                duration = float(match.group(1))
                if duration > 1000:
                    self.slow_queries.append({
                        'duration': duration,
                        'line': line
                    })

        # è§£æé”™è¯¯
        if 'ERROR:' in line:
            self.errors.append(line)

        # è§£æè¿æ¥
        if 'connection received' in line:
            match = re.search(r'host=([^\s]+)', line)
            if match:
                host = match.group(1)
                self.connections[host] += 1
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ—¥å¿—åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦æ„å»ºæ—¥å¿—åˆ†æç³»ç»Ÿï¼Œå¿«é€Ÿè¯Šæ–­æ•°æ®åº“é—®é¢˜å’Œä¼˜åŒ–æ€§èƒ½ã€‚

**é—®é¢˜åˆ†æ**:

1. **é—®é¢˜è¯Šæ–­æ…¢**: é—®é¢˜è¯Šæ–­éœ€è¦å¤§é‡æ—¶é—´
2. **æ€§èƒ½åˆ†æéš¾**: æ€§èƒ½åˆ†æç¼ºä¹å·¥å…·æ”¯æŒ
3. **æ—¥å¿—é‡å¤§**: æ—¥å¿—é‡å¤§ï¼Œéš¾ä»¥åˆ†æ
4. **å‘Šè­¦ä¸åŠæ—¶**: å‘Šè­¦ä¸åŠæ—¶ï¼Œå½±å“ä¸šåŠ¡

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ—¥å¿—åˆ†æç³»ç»Ÿ
class LogAnalysisSystem:
    def __init__(self):
        self.analyzer = PostgresLogAnalyzer('/var/log/postgresql/postgresql.log')
        self.alert_service = AlertService()

    async def daily_analysis(self):
        """æ¯æ—¥æ—¥å¿—åˆ†æ"""
        # 1. åˆ†ææ—¥å¿—
        analysis_result = self.analyzer.analyze()

        # 2. åˆ†ææ…¢æŸ¥è¯¢
        slow_queries = analysis_result['slow_queries']
        if slow_queries:
            top_slow = sorted(slow_queries, key=lambda x: x['duration'], reverse=True)[:10]
            await self.alert_service.send_alert('slow_queries', top_slow)

        # 3. åˆ†æé”™è¯¯
        errors = analysis_result['errors']
        if errors:
            error_summary = self.summarize_errors(errors)
            await self.alert_service.send_alert('errors', error_summary)

        # 4. ç”ŸæˆæŠ¥å‘Š
        report = self.generate_report(analysis_result)
        return report
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é—®é¢˜è¯Šæ–­æ—¶é—´** | 2 å°æ—¶ | **< 30åˆ†é’Ÿ** | **75%** â¬‡ï¸ |
| **æ€§èƒ½ä¼˜åŒ–æ•ˆç‡** | åŸºå‡† | **+80%** | **æå‡** |
| **å‘Šè­¦åŠæ—¶æ€§** | å»¶è¿Ÿ | **å®æ—¶** | **æå‡** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ—¥å¿—é…ç½®

1. **åˆç†çº§åˆ«**: è®¾ç½®åˆç†çš„æ—¥å¿—çº§åˆ«
2. **æ—¥å¿—è½®è½¬**: é…ç½®æ—¥å¿—è½®è½¬ï¼Œé¿å…æ—¥å¿—è¿‡å¤§
3. **æ—¥å¿—ä¿ç•™**: è®¾ç½®åˆç†çš„æ—¥å¿—ä¿ç•™æ—¶é—´

### 6.2 æ—¥å¿—åˆ†æ

1. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†ææ—¥å¿—ï¼Œå‘ç°é—®é¢˜
2. **è‡ªåŠ¨åŒ–**: ä½¿ç”¨å·¥å…·è‡ªåŠ¨åŒ–æ—¥å¿—åˆ†æ
3. **å‘Šè­¦æœºåˆ¶**: è®¾ç½®å‘Šè­¦æœºåˆ¶ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

### 6.3 æ€§èƒ½ä¼˜åŒ–

1. **æ…¢æŸ¥è¯¢ä¼˜åŒ–**: é‡ç‚¹ä¼˜åŒ–æ…¢æŸ¥è¯¢
2. **ç´¢å¼•ä¼˜åŒ–**: æ ¹æ®æ—¥å¿—åˆ†æä¼˜åŒ–ç´¢å¼•
3. **é…ç½®ä¼˜åŒ–**: æ ¹æ®æ—¥å¿—åˆ†æä¼˜åŒ–é…ç½®

## 7. å‚è€ƒèµ„æ–™

- [ç›‘æ§ä¸è¯Šæ–­](./ç›‘æ§ä¸è¯Šæ–­.md)
- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](./æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ—¥å¿—ç®¡ç†](https://www.postgresql.org/docs/current/runtime-config-logging.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-21
