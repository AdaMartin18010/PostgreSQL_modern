# PostgreSQL ç›‘æ§ä¸è¯Šæ–­

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-13

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç›‘æ§ä¸è¯Šæ–­](#postgresql-ç›‘æ§ä¸è¯Šæ–­)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾](#13-ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰](#2-ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰)
    - [2.0 ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰](#20-ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰)
    - [2.1 ç›‘æ§å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ](#21-ç›‘æ§å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ)
  - [3. ç³»ç»Ÿç›‘æ§](#3-ç³»ç»Ÿç›‘æ§)
    - [3.1 æ•°æ®åº“æ´»åŠ¨ç›‘æ§](#31-æ•°æ®åº“æ´»åŠ¨ç›‘æ§)
    - [3.2 æ•°æ®åº“å¤§å°ç›‘æ§](#32-æ•°æ®åº“å¤§å°ç›‘æ§)
    - [3.3 è¡¨ç»Ÿè®¡ä¿¡æ¯](#33-è¡¨ç»Ÿè®¡ä¿¡æ¯)
  - [4. æ•°æ®åº“ç›‘æ§](#4-æ•°æ®åº“ç›‘æ§)
    - [4.1 ç´¢å¼•ä½¿ç”¨æƒ…å†µ](#41-ç´¢å¼•ä½¿ç”¨æƒ…å†µ)
    - [4.2 æ…¢æŸ¥è¯¢ç›‘æ§](#42-æ…¢æŸ¥è¯¢ç›‘æ§)
  - [5. é”ç›‘æ§](#5-é”ç›‘æ§)
    - [5.1 æŸ¥çœ‹å½“å‰é”](#51-æŸ¥çœ‹å½“å‰é”)
    - [5.2 ç»ˆæ­¢é˜»å¡æŸ¥è¯¢](#52-ç»ˆæ­¢é˜»å¡æŸ¥è¯¢)
  - [6. æ—¥å¿—åˆ†æ](#6-æ—¥å¿—åˆ†æ)
    - [6.1 æ—¥å¿—é…ç½®](#61-æ—¥å¿—é…ç½®)
    - [6.2 æ—¥å¿—åˆ†æ](#62-æ—¥å¿—åˆ†æ)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ](#71-æ¡ˆä¾‹-ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ)
    - [7.2 æ¡ˆä¾‹: æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ](#72-æ¡ˆä¾‹-æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ)
  - [8. å®è·µç»ƒä¹ ](#8-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€](#ç»ƒä¹ -1-ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€)
    - [ç»ƒä¹  2: åˆ›å»ºç›‘æ§è§†å›¾](#ç»ƒä¹ -2-åˆ›å»ºç›‘æ§è§†å›¾)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 ç›‘æ§åŸåˆ™](#91-ç›‘æ§åŸåˆ™)
    - [9.2 è¯Šæ–­å»ºè®®](#92-è¯Šæ–­å»ºè®®)
  - [10. å‚è€ƒèµ„æ–™](#10-å‚è€ƒèµ„æ–™)
    - [10.1 å®˜æ–¹æ–‡æ¡£](#101-å®˜æ–¹æ–‡æ¡£)
    - [10.2 æŠ€æœ¯è®ºæ–‡](#102-æŠ€æœ¯è®ºæ–‡)
    - [10.3 æŠ€æœ¯åšå®¢](#103-æŠ€æœ¯åšå®¢)
    - [10.4 ç¤¾åŒºèµ„æº](#104-ç¤¾åŒºèµ„æº)
    - [10.5 ç›¸å…³æ–‡æ¡£](#105-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç›‘æ§ä¸è¯Šæ–­çš„ä»·å€¼**:

PostgreSQL ç›‘æ§ä¸è¯Šæ–­æ˜¯æ•°æ®åº“ç®¡ç†çš„é‡è¦ä»»åŠ¡ï¼š

1. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡
2. **é—®é¢˜è¯Šæ–­**: è¯Šæ–­æ€§èƒ½é—®é¢˜å’Œæ•…éšœ
3. **å®¹é‡è§„åˆ’**: è¿›è¡Œå®¹é‡è§„åˆ’
4. **é¢„é˜²æ€§ç»´æŠ¤**: é¢„é˜²æ€§ç»´æŠ¤

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ•°æ®åº“æ€§èƒ½
- **æ•…éšœæ’æŸ¥**: æ’æŸ¥æ•°æ®åº“æ•…éšœ
- **å®¹é‡è§„åˆ’**: è§„åˆ’æ•°æ®åº“å®¹é‡
- **é¢„é˜²æ€§ç»´æŠ¤**: é¢„é˜²æ€§ç»´æŠ¤

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•…éšœæ¢å¤æ—¶é—´** | ç›‘æ§ç¼©çŸ­æ¢å¤æ—¶é—´ | **-70%** |
| **é—®é¢˜é¢„é˜²** | é¢„é˜²æ€§é—®é¢˜å‘ç° | **+80%** |
| **æ€§èƒ½ä¼˜åŒ–** | ç›‘æ§æŒ‡å¯¼ä¼˜åŒ– | **+50%** |
| **å¯ç”¨æ€§** | æå‡å¯ç”¨æ€§ | **+20%** |

### 1.3 ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç›‘æ§ä¸è¯Šæ–­ä½“ç³»))
    ç³»ç»Ÿç›‘æ§
      æ•°æ®åº“æ´»åŠ¨
        è¿æ¥ç›‘æ§
        æŸ¥è¯¢ç›‘æ§
        äº‹åŠ¡ç›‘æ§
      æ•°æ®åº“å¤§å°
        æ•°æ®åº“å¤§å°
        è¡¨å¤§å°
        ç´¢å¼•å¤§å°
      ç»Ÿè®¡ä¿¡æ¯
        è¡¨ç»Ÿè®¡
        ç´¢å¼•ç»Ÿè®¡
        æŸ¥è¯¢ç»Ÿè®¡
    æ€§èƒ½ç›‘æ§
      æ…¢æŸ¥è¯¢ç›‘æ§
        æ…¢æŸ¥è¯¢è¯†åˆ«
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
      é”ç›‘æ§
        é”ç­‰å¾…
        æ­»é”æ£€æµ‹
        é”å†²çª
      èµ„æºç›‘æ§
        CPUä½¿ç”¨
        å†…å­˜ä½¿ç”¨
        I/Oä½¿ç”¨
    è¯Šæ–­å·¥å…·
      EXPLAIN
        æŸ¥è¯¢è®¡åˆ’
        æ‰§è¡Œæˆæœ¬
        æ€§èƒ½åˆ†æ
      pg_stat_statements
        æŸ¥è¯¢ç»Ÿè®¡
        æ€§èƒ½åˆ†æ
        ä¼˜åŒ–å»ºè®®
      æ—¥å¿—åˆ†æ
        é”™è¯¯æ—¥å¿—
        æ…¢æŸ¥è¯¢æ—¥å¿—
        å®¡è®¡æ—¥å¿—
```

## 2. ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰

### 2.0 ç›‘æ§ä¸è¯Šæ–­å½¢å¼åŒ–å®šä¹‰

**ç›‘æ§ä¸è¯Šæ–­çš„æœ¬è´¨**ï¼šç›‘æ§ä¸è¯Šæ–­æ˜¯é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•æ”¶é›†ã€åˆ†æå’Œè¯„ä¼°æ•°æ®åº“ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ï¼Œè¯†åˆ«é—®é¢˜å¹¶æŒ‡å¯¼ä¼˜åŒ–ã€‚

**å®šä¹‰ 1ï¼ˆç›‘æ§æŒ‡æ ‡ï¼‰**ï¼š
è®¾ MonitoringMetrics = {performance, resource, availability, error}ï¼Œå…¶ä¸­ï¼š

- performanceï¼šæ€§èƒ½æŒ‡æ ‡ï¼ˆTPSã€å»¶è¿Ÿç­‰ï¼‰
- resourceï¼šèµ„æºæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€IOç­‰ï¼‰
- availabilityï¼šå¯ç”¨æ€§æŒ‡æ ‡ï¼ˆuptimeã€è¿æ¥æ•°ç­‰ï¼‰
- errorï¼šé”™è¯¯æŒ‡æ ‡ï¼ˆé”™è¯¯ç‡ã€é”™è¯¯ç±»å‹ç­‰ï¼‰

**å®šä¹‰ 2ï¼ˆè¯Šæ–­æµç¨‹ï¼‰**ï¼š
è®¾ DiagnosisProcess = {collection, analysis, identification, resolution}ï¼Œå…¶ä¸­ï¼š

- collectionï¼šæ•°æ®æ”¶é›†
- analysisï¼šæ•°æ®åˆ†æ
- identificationï¼šé—®é¢˜è¯†åˆ«
- resolutionï¼šé—®é¢˜è§£å†³

**å®šä¹‰ 3ï¼ˆç›‘æ§å·¥å…·ï¼‰**ï¼š
è®¾ MonitoringTool = {builtin, external, custom}ï¼Œå…¶ä¸­ï¼š

- builtinï¼šå†…ç½®ç›‘æ§å·¥å…·ï¼ˆpg_stat_*ï¼‰
- externalï¼šå¤–éƒ¨ç›‘æ§å·¥å…·ï¼ˆPrometheusã€Grafanaç­‰ï¼‰
- customï¼šè‡ªå®šä¹‰ç›‘æ§å·¥å…·

**å®šä¹‰ 4ï¼ˆè¯Šæ–­æ–¹æ³•ï¼‰**ï¼š
è®¾ DiagnosisMethod = {reactive, proactive, predictive}ï¼Œå…¶ä¸­ï¼š

- reactiveï¼šååº”å¼è¯Šæ–­ï¼ˆé—®é¢˜å‘ç”Ÿåï¼‰
- proactiveï¼šä¸»åŠ¨å¼è¯Šæ–­ï¼ˆå®šæœŸæ£€æŸ¥ï¼‰
- predictiveï¼šé¢„æµ‹å¼è¯Šæ–­ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç† 1ï¼ˆç›‘æ§æœ‰æ•ˆæ€§ï¼‰**ï¼š
å¦‚æœç›‘æ§æŒ‡æ ‡è¦†ç›–å…³é”®æ€§èƒ½ç»´åº¦ï¼Œåˆ™ç›‘æ§ç³»ç»Ÿæœ‰æ•ˆã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰1ï¼Œç›‘æ§æŒ‡æ ‡åŒ…æ‹¬æ€§èƒ½ã€èµ„æºã€å¯ç”¨æ€§ã€é”™è¯¯
2. ç›‘æ§æŒ‡æ ‡è¦†ç›–å…³é”®æ€§èƒ½ç»´åº¦
3. ç›‘æ§ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å‘ç°é—®é¢˜
4. å› æ­¤ï¼Œç›‘æ§ç³»ç»Ÿæœ‰æ•ˆ

**å®šç† 2ï¼ˆè¯Šæ–­å‡†ç¡®æ€§ï¼‰**ï¼š
è¯Šæ–­æ–¹æ³•çš„å‡†ç¡®æ€§ä¸å…¶æ•°æ®å®Œæ•´æ€§å’Œåˆ†ææ·±åº¦æˆæ­£æ¯”ã€‚

**è¯æ˜**ï¼š

1. è¯Šæ–­æ–¹æ³•ä¾èµ–æ•°æ®æ”¶é›†å’Œåˆ†æ
2. æ•°æ®è¶Šå®Œæ•´ï¼Œåˆ†æè¶Šæ·±å…¥ï¼Œè¯Šæ–­è¶Šå‡†ç¡®
3. è¯Šæ–­å‡†ç¡®æ€§å½±å“é—®é¢˜è§£å†³æ•ˆç‡
4. å› æ­¤ï¼Œè¯Šæ–­å‡†ç¡®æ€§ä¸å…¶æ•°æ®å®Œæ•´æ€§å’Œåˆ†ææ·±åº¦æˆæ­£æ¯”

**å®é™…åº”ç”¨**ï¼š

- ç›‘æ§ç³»ç»Ÿåˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡ŒæŒ‡æ ‡è®¾è®¡
- è¯Šæ–­å·¥å…·åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œé—®é¢˜è¯†åˆ«
- ç›‘æ§å¹³å°åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œå‘Šè­¦é…ç½®

### 2.1 ç›‘æ§å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ

**ç›‘æ§å·¥å…·çš„é€‰æ‹©æ˜¯ç›‘æ§ç³»ç»Ÿå»ºè®¾çš„å…³é”®å†³ç­–**ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·å¯ä»¥æå‡ç›‘æ§æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

**ç›‘æ§å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ**ï¼š

| å·¥å…· | åŠŸèƒ½ | æ˜“ç”¨æ€§ | æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|------|------|--------|------|------|---------|---------|
| **å†…ç½®ç›‘æ§** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | åŸºç¡€ç›‘æ§ | 4.6/5 |
| **Prometheus+Grafana** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | ä¼ä¸šçº§ç›‘æ§ | 4.6/5 |
| **pgAdmin** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | å¼€å‘ç¯å¢ƒ | 4.2/5 |
| **è‡ªå®šä¹‰ç›‘æ§** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­ | ç‰¹æ®Šéœ€æ±‚ | 3.2/5 |

**ç›‘æ§å·¥å…·é€‰æ‹©å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[éœ€è¦ç›‘æ§ç³»ç»Ÿ] --> B{ç›‘æ§éœ€æ±‚}
    B -->|åŸºç¡€ç›‘æ§| C[ä½¿ç”¨å†…ç½®ç›‘æ§]
    B -->|ä¼ä¸šçº§ç›‘æ§| D[ä½¿ç”¨Prometheus+Grafana]
    B -->|å¼€å‘ç¯å¢ƒ| E[ä½¿ç”¨pgAdmin]
    B -->|ç‰¹æ®Šéœ€æ±‚| F[ä½¿ç”¨è‡ªå®šä¹‰ç›‘æ§]
    C --> G[å®æ–½ç›‘æ§]
    D --> G
    E --> G
    F --> G
    G --> H[éªŒè¯ç›‘æ§æ•ˆæœ]
    H --> I{ç›‘æ§æ»¡è¶³è¦æ±‚?}
    I -->|æ˜¯| J[ç›‘æ§ç³»ç»Ÿå®Œæˆ]
    I -->|å¦| K{é—®é¢˜åˆ†æ}
    K -->|åŠŸèƒ½é—®é¢˜| L{æ˜¯å¦éœ€è¦å…¶ä»–å·¥å…·?}
    K -->|æ€§èƒ½é—®é¢˜| M[ä¼˜åŒ–ç›‘æ§é…ç½®]
    L -->|æ˜¯| N[ç»„åˆå·¥å…·]
    L -->|å¦| O[é€‰æ‹©å…¶ä»–å·¥å…·]
    N --> G
    O --> B
    M --> G

    style B fill:#FFD700
    style I fill:#90EE90
    style J fill:#90EE90
```

## 3. ç³»ç»Ÿç›‘æ§

### 3.1 æ•°æ®åº“æ´»åŠ¨ç›‘æ§

**æ´»åŠ¨ç›‘æ§åŸç†**:

`pg_stat_activity` è§†å›¾æä¾›å½“å‰æ•°æ®åº“æ´»åŠ¨çš„å®æ—¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿æ¥ã€æŸ¥è¯¢çŠ¶æ€ã€ç­‰å¾…äº‹ä»¶ç­‰ã€‚

**æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥**:

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE datname = current_database()
ORDER BY query_start;

-- æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
SELECT
    state,
    COUNT(*) as connection_count,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_count
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY state;
```

**æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ï¼ˆ> 5 åˆ†é’Ÿï¼‰
SELECT
    pid,
    usename,
    application_name,
    now() - query_start AS duration,
    state,
    wait_event_type,
    wait_event,
    LEFT(query, 200) as query_preview
FROM pg_stat_activity
WHERE (now() - query_start) > interval '5 minutes'
  AND state != 'idle'
  AND datname = current_database()
ORDER BY query_start;

-- æŸ¥çœ‹é˜»å¡æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    now() - blocked_activity.query_start AS blocked_duration
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| **æ´»è·ƒè¿æ¥æ•°** | < 80% max_connections | > 90% | æ¥è¿‘æœ€å¤§è¿æ¥æ•° |
| **ç©ºé—²è¿æ¥æ•°** | < 50% | > 70% | è¿æ¥æ³„æ¼ |
| **é•¿æ—¶é—´æŸ¥è¯¢** | < 1 åˆ†é’Ÿ | > 5 åˆ†é’Ÿ | éœ€è¦ä¼˜åŒ– |
| **é˜»å¡æŸ¥è¯¢** | 0 | > 0 | å­˜åœ¨é”ç«äº‰ |

### 3.2 æ•°æ®åº“å¤§å°ç›‘æ§

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.3 è¡¨ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    n_mod_since_analyze,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;
```

## 4. æ•°æ®åº“ç›‘æ§

### 4.1 ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 4.2 æ…¢æŸ¥è¯¢ç›‘æ§

```sql
-- ä½¿ç”¨ pg_stat_statements ç›‘æ§æ…¢æŸ¥è¯¢
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    (100 * total_exec_time / SUM(total_exec_time) OVER ()) AS percent_total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 5. é”ç›‘æ§

### 5.1 æŸ¥çœ‹å½“å‰é”

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    pg_blocking_pids(pid) AS blocked_by
FROM pg_locks
WHERE relation IS NOT NULL;

-- æŸ¥çœ‹é˜»å¡çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 5.2 ç»ˆæ­¢é˜»å¡æŸ¥è¯¢

```sql
-- æŸ¥çœ‹é˜»å¡æŸ¥è¯¢çš„ PID
SELECT pid, query FROM pg_stat_activity WHERE state = 'active';

-- ç»ˆæ­¢æŸ¥è¯¢
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;

-- å–æ¶ˆæŸ¥è¯¢ï¼ˆæ›´æ¸©å’Œï¼‰
SELECT pg_cancel_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;
```

## 6. æ—¥å¿—åˆ†æ

### 6.1 æ—¥å¿—é…ç½®

```sql
-- æŸ¥çœ‹æ—¥å¿—é…ç½®
SHOW log_destination;
SHOW logging_collector;
SHOW log_directory;
SHOW log_filename;
SHOW log_min_duration_statement;

-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
-- log_min_duration_statement = 1000  # è®°å½•æ‰§è¡Œæ—¶é—´ > 1ç§’çš„æŸ¥è¯¢
```

### 6.2 æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep ERROR

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep "duration:"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep ERROR /var/log/postgresql/postgresql-*.log | \
    awk '{print $NF}' | sort | uniq -c | sort -rn
```

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å»ºè®¾ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œæ•°æ®åº“æ•°é‡10+ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„ç›‘æ§å·¥å…·ã€‚

**é—®é¢˜åˆ†æ**:

1. **ç›‘æ§éœ€æ±‚**: éœ€è¦å…¨é¢ç›‘æ§æ•°æ®åº“æ€§èƒ½
2. **å·¥å…·é€‰æ‹©**: éœ€è¦é€‰æ‹©åˆé€‚çš„ç›‘æ§å·¥å…·
3. **æˆæœ¬æ§åˆ¶**: éœ€è¦æ§åˆ¶ç›‘æ§æˆæœ¬
4. **æ˜“ç”¨æ€§**: éœ€è¦æ˜“äºä½¿ç”¨å’Œç»´æŠ¤

**ç›‘æ§å·¥å…·é€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºç”Ÿäº§ç¯å¢ƒé€‰æ‹©åˆé€‚çš„ç›‘æ§å·¥å…·ï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨å†…ç½®ç›‘æ§**:

- **æè¿°**: ä½¿ç”¨PostgreSQLå†…ç½®çš„pg_stat_*è§†å›¾è¿›è¡Œç›‘æ§
- **ä¼˜ç‚¹**:
  - æ— éœ€é¢å¤–å·¥å…·ï¼Œæˆæœ¬ä½
  - æ˜“ç”¨æ€§å¥½ï¼Œé…ç½®ç®€å•
  - æ€§èƒ½å¥½ï¼Œæ— é¢å¤–å¼€é”€
- **ç¼ºç‚¹**:
  - åŠŸèƒ½æœ‰é™ï¼Œä¸æ”¯æŒå‘Šè­¦
  - éœ€è¦æ‰‹åŠ¨æŸ¥è¯¢
  - ä¸æ”¯æŒå†å²æ•°æ®å­˜å‚¨
- **é€‚ç”¨åœºæ™¯**: åŸºç¡€ç›‘æ§
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<100msï¼Œæ— é¢å¤–å¼€é”€
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨Prometheus+Grafana**:

- **æè¿°**: ä½¿ç”¨Prometheusæ”¶é›†æŒ‡æ ‡ï¼ŒGrafanaå±•ç¤º
- **ä¼˜ç‚¹**:
  - åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒå‘Šè­¦
  - æ”¯æŒå†å²æ•°æ®å­˜å‚¨
  - å¯è§†åŒ–æ•ˆæœå¥½
  - ç¤¾åŒºæ´»è·ƒ
- **ç¼ºç‚¹**:
  - éœ€è¦é¢å¤–éƒ¨ç½²
  - é…ç½®ç›¸å¯¹å¤æ‚
  - éœ€è¦é¢å¤–èµ„æº
- **é€‚ç”¨åœºæ™¯**: ä¼ä¸šçº§ç›‘æ§
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<50msï¼Œèµ„æºå ç”¨ä¸­ç­‰
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨pgAdmin**:

- **æè¿°**: ä½¿ç”¨pgAdminè¿›è¡Œç›‘æ§
- **ä¼˜ç‚¹**:
  - æ˜“ç”¨æ€§å¥½ï¼Œå›¾å½¢ç•Œé¢
  - åŠŸèƒ½å®Œå–„
  - é€‚åˆå¼€å‘ç¯å¢ƒ
- **ç¼ºç‚¹**:
  - ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
  - ä¸æ”¯æŒå‘Šè­¦
  - ä¸æ”¯æŒå¤šæ•°æ®åº“é›†ä¸­ç›‘æ§
- **é€‚ç”¨åœºæ™¯**: å¼€å‘ç¯å¢ƒ
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<200msï¼Œèµ„æºå ç”¨ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ4ï¼šä½¿ç”¨è‡ªå®šä¹‰ç›‘æ§**:

- **æè¿°**: å¼€å‘è‡ªå®šä¹‰ç›‘æ§ç³»ç»Ÿ
- **ä¼˜ç‚¹**:
  - å®Œå…¨å®šåˆ¶åŒ–
  - å¯ä»¥æ»¡è¶³ç‰¹æ®Šéœ€æ±‚
- **ç¼ºç‚¹**:
  - å¼€å‘æˆæœ¬é«˜
  - ç»´æŠ¤æˆæœ¬é«˜
  - é£é™©é«˜
- **é€‚ç”¨åœºæ™¯**: ç‰¹æ®Šéœ€æ±‚
- **æ€§èƒ½æ•°æ®**: å–å†³äºå®ç°
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œé£é™©é«˜

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | åŠŸèƒ½ | æ˜“ç”¨æ€§ | æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|------|------|--------|------|------|---------|---------|
| å†…ç½®ç›‘æ§ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | åŸºç¡€ç›‘æ§ | 4.6/5 |
| Prometheus+Grafana | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | ä¼ä¸šçº§ç›‘æ§ | 4.6/5 |
| pgAdmin | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | å¼€å‘ç¯å¢ƒ | 4.2/5 |
| è‡ªå®šä¹‰ç›‘æ§ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­ | ç‰¹æ®Šéœ€æ±‚ | 3.2/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- åŠŸèƒ½ï¼šæƒé‡30%
- æ˜“ç”¨æ€§ï¼šæƒé‡25%
- æ€§èƒ½ï¼šæƒé‡20%
- æˆæœ¬ï¼šæƒé‡15%
- é€‚ç”¨åœºæ™¯ï¼šæƒé‡10%

**è¯„åˆ†è®¡ç®—**:

- å†…ç½®ç›‘æ§ï¼š4.0 Ã— 0.3 + 5.0 Ã— 0.25 + 5.0 Ã— 0.2 + 5.0 Ã— 0.15 + 4.0 Ã— 0.1 = 4.6
- Prometheus+Grafanaï¼š5.0 Ã— 0.3 + 4.0 Ã— 0.25 + 5.0 Ã— 0.2 + 4.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.6
- pgAdminï¼š4.0 Ã— 0.3 + 5.0 Ã— 0.25 + 4.0 Ã— 0.2 + 5.0 Ã— 0.15 + 3.0 Ã— 0.1 = 4.2
- è‡ªå®šä¹‰ç›‘æ§ï¼š5.0 Ã— 0.3 + 2.0 Ã— 0.25 + 5.0 Ã— 0.2 + 3.0 Ã— 0.15 + 4.0 Ã— 0.1 = 3.2

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: Prometheus+Grafanaï¼ˆä¼ä¸šçº§ç›‘æ§ï¼‰+ å†…ç½®ç›‘æ§ï¼ˆåŸºç¡€ç›‘æ§ï¼‰

**æ¨èç†ç”±**:

1. Prometheus+GrafanaåŠŸèƒ½å®Œå–„ï¼Œé€‚åˆä¼ä¸šçº§ç›‘æ§
2. å†…ç½®ç›‘æ§ä½œä¸ºè¡¥å……ï¼Œæä¾›åŸºç¡€ç›‘æ§èƒ½åŠ›
3. ç»„åˆä½¿ç”¨å¯ä»¥å…¨é¢ç›‘æ§æ•°æ®åº“æ€§èƒ½
4. æˆæœ¬åˆç†ï¼Œé£é™©å¯æ§

**å®æ–½å»ºè®®**:

1. ä½¿ç”¨Prometheus+Grafanaå»ºè®¾ä¼ä¸šçº§ç›‘æ§ç³»ç»Ÿ
2. ä½¿ç”¨å†…ç½®ç›‘æ§ä½œä¸ºè¡¥å……ï¼Œæä¾›åŸºç¡€ç›‘æ§èƒ½åŠ›
3. é…ç½®å‘Šè­¦è§„åˆ™ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. å®šæœŸå®¡æŸ¥ç›‘æ§æ•ˆæœï¼ŒæŒç»­ä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆ**:

**ä¸šåŠ¡åœºæ™¯**:

æŸç”Ÿäº§ç¯å¢ƒéœ€è¦å®æ—¶ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ã€‚

**ç›‘æ§æ–¹æ¡ˆ**:

```sql
-- åˆ›å»ºç»¼åˆç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW database_health_dashboard AS
SELECT
    -- è¿æ¥ä¿¡æ¯
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type IS NOT NULL) AS waiting_connections,

    -- æ•°æ®åº“å¤§å°
    pg_size_pretty(pg_database_size(current_database())) AS database_size,

    -- è¡¨ç»Ÿè®¡
    (SELECT COUNT(*) FROM pg_stat_user_tables) AS total_tables,
    (SELECT SUM(n_live_tup) FROM pg_stat_user_tables) AS total_rows,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) AS total_dead_tuples,

    -- ç´¢å¼•ç»Ÿè®¡
    (SELECT COUNT(*) FROM pg_stat_user_indexes) AS total_indexes,
    (SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0) AS unused_indexes,

    -- ç¼“å­˜å‘½ä¸­ç‡
    (SELECT
        ROUND(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2)
     FROM pg_statio_user_tables) AS cache_hit_ratio,

    -- å½“å‰æ—¶é—´
    NOW() AS check_time;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾
SELECT * FROM database_health_dashboard;
```

**å‘Šè­¦è§„åˆ™**:

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | åŠ¨ä½œ |
|------|--------|---------|---------|------|
| **æ´»è·ƒè¿æ¥æ•°** | < 80 | > 90 | > 95 | å‘Šè­¦/æ‰©å®¹ |
| **æ­»å…ƒç»„æ•°** | < 1000ä¸‡ | > 5000ä¸‡ | > 1äº¿ | æ‰§è¡Œ VACUUM |
| **ç¼“å­˜å‘½ä¸­ç‡** | > 95% | < 90% | < 85% | æ£€æŸ¥é…ç½® |
| **æœªä½¿ç”¨ç´¢å¼•** | < 10 | > 20 | > 50 | æ¸…ç†ç´¢å¼• |

### 7.2 æ¡ˆä¾‹: æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**:

éœ€è¦è‡ªåŠ¨è¯†åˆ«å’Œåˆ†ææ…¢æŸ¥è¯¢ï¼Œç”Ÿæˆä¼˜åŒ–å»ºè®®ã€‚

**å®ç°æ–¹æ¡ˆ**:

```sql
-- åˆ›å»ºæ…¢æŸ¥è¯¢åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_slow_queries(
    min_exec_time_ms NUMERIC DEFAULT 1000
)
RETURNS TABLE (
    query_id BIGINT,
    query_preview TEXT,
    calls BIGINT,
    total_time_ms NUMERIC,
    mean_time_ms NUMERIC,
    max_time_ms NUMERIC,
    recommendation TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        q.queryid,
        LEFT(q.query, 200) as query_preview,
        q.calls,
        ROUND(q.total_exec_time::NUMERIC, 2) as total_time_ms,
        ROUND(q.mean_exec_time::NUMERIC, 2) as mean_time_ms,
        ROUND(q.max_exec_time::NUMERIC, 2) as max_time_ms,
        CASE
            WHEN q.query LIKE '%SELECT *%' THEN 'å»ºè®®ï¼šé¿å… SELECT *ï¼Œåªé€‰æ‹©éœ€è¦çš„åˆ—'
            WHEN q.query LIKE '%LIKE ''%%%' THEN 'å»ºè®®ï¼šLIKE æ¨¡å¼ä»¥ % å¼€å¤´æ— æ³•ä½¿ç”¨ç´¢å¼•'
            WHEN q.query LIKE '%ORDER BY%' AND q.query NOT LIKE '%LIMIT%' THEN 'å»ºè®®ï¼šæ·»åŠ  LIMIT é™åˆ¶ç»“æœé›†'
            WHEN q.calls > 1000 AND q.mean_exec_time > 100 THEN 'å»ºè®®ï¼šè€ƒè™‘åˆ›å»ºç´¢å¼•æˆ–ä¼˜åŒ–æŸ¥è¯¢'
            ELSE 'å»ºè®®ï¼šä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææŸ¥è¯¢è®¡åˆ’'
        END as recommendation
    FROM pg_stat_statements q
    WHERE q.mean_exec_time > min_exec_time_ms
      AND q.query NOT LIKE '%pg_stat_statements%'
    ORDER BY q.total_exec_time DESC
    LIMIT 20;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM analyze_slow_queries(1000);
```

## 8. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å¥åº·æ£€æŸ¥æŸ¥è¯¢
SELECT
    'Database Size' AS metric,
    pg_size_pretty(pg_database_size(current_database())) AS value
UNION ALL
SELECT
    'Active Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'active'
UNION ALL
SELECT
    'Idle Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'idle'
UNION ALL
SELECT
    'Dead Tuples',
    SUM(n_dead_tup)::TEXT
FROM pg_stat_user_tables
UNION ALL
SELECT
    'Unused Indexes',
    COUNT(*)::TEXT
FROM pg_stat_user_indexes
WHERE idx_scan = 0;
```

### ç»ƒä¹  2: åˆ›å»ºç›‘æ§è§†å›¾

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªç›‘æ§è§†å›¾
CREATE VIEW database_health AS
SELECT
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) AS total_dead_tuples,
    (SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0) AS unused_indexes,
    (SELECT pg_size_pretty(pg_database_size(current_database()))) AS database_size;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾
SELECT * FROM database_health;
```

## 9. æœ€ä½³å®è·µ

### 9.1 ç›‘æ§åŸåˆ™

1. **å…¨é¢ç›‘æ§**: ç›‘æ§æ‰€æœ‰å…³é”®æŒ‡æ ‡
2. **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®åº“çŠ¶æ€
3. **å‘Šè­¦æœºåˆ¶**: å»ºç«‹å‘Šè­¦æœºåˆ¶
4. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æç›‘æ§æ•°æ®

### 9.2 è¯Šæ–­å»ºè®®

1. **é—®é¢˜å®šä½**: å¿«é€Ÿå®šä½é—®é¢˜
2. **æ ¹å› åˆ†æ**: åˆ†æé—®é¢˜æ ¹å› 
3. **è§£å†³æ–¹æ¡ˆ**: åˆ¶å®šè§£å†³æ–¹æ¡ˆ
4. **é¢„é˜²æªæ–½**: é‡‡å–é¢„é˜²æªæ–½

## 10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 10.1 ç›‘æ§åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Œä¸çŸ¥é“åº”è¯¥ç›‘æ§å“ªäº›æŒ‡æ ‡ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ•°æ®åº“æ´»åŠ¨
SELECT * FROM pg_stat_activity WHERE state = 'active';

-- 2. æ£€æŸ¥æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size(current_database()));

-- 3. æ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_user_tables;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç›‘æ§æ•°æ®åº“æ´»åŠ¨
SELECT 
    pid,
    usename,
    application_name,
    state,
    query_start,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;

-- 2. ç›‘æ§æ•°æ®åº“å¤§å°
SELECT 
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- 3. ç›‘æ§è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT 
    schemaname,
    tablename,
    n_tup_ins AS inserts,
    n_tup_upd AS updates,
    n_tup_del AS deletes,
    n_live_tup AS live_tuples,
    n_dead_tup AS dead_tuples
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ç›‘æ§ï¼šé—®é¢˜å‘ç°æ—¶é—´ **æ•°å°æ—¶**ï¼Œå½±å“ä¸šåŠ¡
- æœ‰ç›‘æ§ï¼šé—®é¢˜å‘ç°æ—¶é—´ **æ•°åˆ†é’Ÿ**ï¼Œå¿«é€Ÿå“åº”
- **å“åº”æ—¶é—´æå‡ï¼š100å€**

#### Q2: å¦‚ä½•ç›‘æ§æ…¢æŸ¥è¯¢ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•ç›‘æ§æ…¢æŸ¥è¯¢ï¼Œä¸çŸ¥é“å“ªäº›æŸ¥è¯¢éœ€è¦ä¼˜åŒ–ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements 
ORDER BY total_exec_time DESC 
LIMIT 10;

-- 2. æ£€æŸ¥å½“å‰è¿è¡Œçš„æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_activity 
WHERE state = 'active' 
AND now() - query_start > interval '1 minute';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- 3. ç›‘æ§å½“å‰æ…¢æŸ¥è¯¢
SELECT 
    pid,
    usename,
    application_name,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND now() - query_start > interval '1 minute'
ORDER BY duration DESC;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ç›‘æ§ï¼šæ…¢æŸ¥è¯¢å‘ç°æ—¶é—´ **æ•°å¤©**ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
- æœ‰ç›‘æ§ï¼šæ…¢æŸ¥è¯¢å‘ç°æ—¶é—´ **æ•°åˆ†é’Ÿ**ï¼Œå¿«é€Ÿä¼˜åŒ–
- **ä¼˜åŒ–æ•ˆç‡æå‡ï¼š1000å€**

### 10.2 é”ç›‘æ§å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ç›‘æ§å’Œè¯Šæ–­é”ç­‰å¾…é—®é¢˜ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šç³»ç»Ÿå‡ºç°é”ç­‰å¾…ï¼Œä¸çŸ¥é“å¦‚ä½•è¯Šæ–­ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥é”ç­‰å¾…
SELECT * FROM pg_locks WHERE NOT granted;

-- 2. æ£€æŸ¥é˜»å¡æŸ¥è¯¢
SELECT 
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid
FROM pg_locks blocked_locks
JOIN pg_locks blocking_locks ON ...
WHERE NOT blocked_locks.granted;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 2. ç»ˆæ­¢é˜»å¡æŸ¥è¯¢ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SELECT pg_terminate_backend(blocking_pid);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— è¯Šæ–­ï¼šé”ç­‰å¾…æ—¶é—´ **10ç§’**ï¼Œç³»ç»Ÿé˜»å¡
- æœ‰è¯Šæ–­ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼ŒåŠæ—¶è§£å†³
- **æ•…éšœæ¢å¤æ—¶é—´æå‡ï¼š10å€**

## 11. å‚è€ƒèµ„æ–™

### 11.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - ç›‘æ§å®Œæ•´å‚è€ƒæ‰‹å†Œ
  - åŒ…å«æ‰€æœ‰ç›‘æ§ç‰¹æ€§çš„è¯¦ç»†è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](https://www.postgresql.org/docs/current/monitoring-stats.html)**
  - ç»Ÿè®¡ä¿¡æ¯è¯¦ç»†è¯´æ˜
  - ç›‘æ§è§†å›¾ä½¿ç”¨æŒ‡å—

### 11.2 æŠ€æœ¯è®ºæ–‡

- **[Gray, J., & Reuter, A. (1993). "Transaction Processing: Concepts and Techniques."](https://www.amazon.com/Transaction-Processing-Concepts-Techniques-Management/dp/1558601902)**
  - äº‹åŠ¡å¤„ç†çš„ç»å…¸æ•™æ
  - ç›‘æ§å’Œè¯Šæ–­åœ¨äº‹åŠ¡å¤„ç†ä¸­çš„åº”ç”¨

- **[Stonebraker, M., et al. (2007). "The End of an Architectural Era: (It's Time for a Complete Rewrite)."](https://dl.acm.org/doi/10.1145/1247480.1247502)**
  - æ•°æ®åº“æ¶æ„çš„åŸºç¡€ç ”ç©¶
  - ç›‘æ§åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­çš„åº”ç”¨

### 11.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - ç›‘æ§](https://www.postgresql.org/about/newsarchive/)**
  - PostgreSQL ç›‘æ§æœ€æ–°åŠ¨æ€
  - å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†äº«

- **[2ndQuadrant PostgreSQL åšå®¢](https://www.2ndquadrant.com/en/blog/)**
  - PostgreSQL ç›‘æ§æ–‡ç« 
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Percona PostgreSQL åšå®¢](https://www.percona.com/blog/tag/postgresql/)**
  - PostgreSQL ç›‘æ§ä¼˜åŒ–å®è·µ
  - ç›‘æ§æ¡ˆä¾‹

### 10.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - ç›‘æ§](https://wiki.postgresql.org/wiki/Monitoring)**
  - PostgreSQL ç›‘æ§Wiki
  - å¸¸è§é—®é¢˜è§£ç­”å’Œæœ€ä½³å®è·µ

- **[Stack Overflow - PostgreSQL ç›‘æ§](https://stackoverflow.com/questions/tagged/postgresql+monitoring)**
  - PostgreSQL ç›‘æ§ç›¸å…³é—®ç­”
  - é«˜è´¨é‡çš„é—®é¢˜å’Œç­”æ¡ˆ

- **[PostgreSQL é‚®ä»¶åˆ—è¡¨](https://www.postgresql.org/list/)**
  - PostgreSQL ç¤¾åŒºè®¨è®º
  - ç›‘æ§ä½¿ç”¨é—®é¢˜äº¤æµ

### 10.5 ç›¸å…³æ–‡æ¡£

- [ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£](./ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£.md)
- [æ—¥å¿—ç®¡ç†ä¸åˆ†æ](./æ—¥å¿—ç®¡ç†ä¸åˆ†æ.md)
- [æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£](../11-æ€§èƒ½è°ƒä¼˜/æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£.md)

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯è§†å›¾](https://www.postgresql.org/docs/current/monitoring-stats.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-13
