# PostgreSQL ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-58

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£](#postgresql-ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç›‘æ§è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾](#2-ç›‘æ§è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 ç›‘æ§è¯Šæ–­ä½“ç³»æ¶æ„](#21-ç›‘æ§è¯Šæ–­ä½“ç³»æ¶æ„)
    - [2.2 ç›‘æ§è¯Šæ–­æµç¨‹](#22-ç›‘æ§è¯Šæ–­æµç¨‹)
  - [3. ç›‘æ§æŒ‡æ ‡è¯¦è§£](#3-ç›‘æ§æŒ‡æ ‡è¯¦è§£)
    - [3.1 ç³»ç»Ÿç›‘æ§æŒ‡æ ‡](#31-ç³»ç»Ÿç›‘æ§æŒ‡æ ‡)
    - [3.2 æŸ¥è¯¢ç›‘æ§æŒ‡æ ‡](#32-æŸ¥è¯¢ç›‘æ§æŒ‡æ ‡)
    - [3.3 é”ç›‘æ§æŒ‡æ ‡](#33-é”ç›‘æ§æŒ‡æ ‡)
  - [4. è¯Šæ–­å·¥å…·è¯¦è§£](#4-è¯Šæ–­å·¥å…·è¯¦è§£)
    - [4.1 EXPLAIN å·¥å…·](#41-explain-å·¥å…·)
    - [4.2 pg\_stat\_activity è§†å›¾](#42-pg_stat_activity-è§†å›¾)
    - [4.3 pgBadger æ—¥å¿—åˆ†æ](#43-pgbadger-æ—¥å¿—åˆ†æ)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒç›‘æ§ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-ç”Ÿäº§ç¯å¢ƒç›‘æ§ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æ¡ˆä¾‹: æ€§èƒ½ä¼˜åŒ–è¯Šæ–­ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#52-æ¡ˆä¾‹-æ€§èƒ½ä¼˜åŒ–è¯Šæ–­çœŸå®æ¡ˆä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ç›‘æ§é…ç½®å»ºè®®](#61-ç›‘æ§é…ç½®å»ºè®®)
    - [6.2 è¯Šæ–­å»ºè®®](#62-è¯Šæ–­å»ºè®®)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç›‘æ§è¯Šæ–­ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œæ•´çš„ç›‘æ§å’Œè¯Šæ–­æœºåˆ¶ï¼š

1. **ç³»ç»Ÿç›‘æ§**: æ•°æ®åº“æ€§èƒ½ç›‘æ§
2. **æŸ¥è¯¢ç›‘æ§**: æŸ¥è¯¢æ€§èƒ½åˆ†æ
3. **é”ç›‘æ§**: é”ç­‰å¾…å’Œæ­»é”ç›‘æ§
4. **æ—¥å¿—åˆ†æ**: æ—¥å¿—æ”¶é›†å’Œåˆ†æ
5. **è¯Šæ–­å·¥å…·**: æ€§èƒ½è¯Šæ–­å·¥å…·

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ä¼˜åŒ–**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
- **æ•…éšœæ’æŸ¥**: å¿«é€Ÿå®šä½é—®é¢˜
- **å®¹é‡è§„åˆ’**: è§„åˆ’èµ„æºéœ€æ±‚
- **é¢„é˜²æ€§ç»´æŠ¤**: é¢„é˜²æ€§é—®é¢˜

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•…éšœå‘ç°æ—¶é—´** | å¿«é€Ÿå‘ç°é—®é¢˜ | **-80%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | å¿«é€Ÿæ¢å¤æœåŠ¡ | **-70%** |
| **æ€§èƒ½ä¼˜åŒ–** | è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ | **+50%** |
| **èµ„æºåˆ©ç”¨ç‡** | ä¼˜åŒ–èµ„æºä½¿ç”¨ | **+30%** |

## 2. ç›‘æ§è¯Šæ–­å½¢å¼åŒ–å®šä¹‰

### 2.0 ç›‘æ§è¯Šæ–­å½¢å¼åŒ–å®šä¹‰

**ç›‘æ§è¯Šæ–­çš„æœ¬è´¨**ï¼šç›‘æ§è¯Šæ–­ä½“ç³»æ˜¯é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•æ„å»ºå®Œæ•´çš„ç›‘æ§å’Œè¯Šæ–­æ¡†æ¶ï¼Œå®ç°å…¨é¢çš„æ€§èƒ½ç›‘æ§å’Œé—®é¢˜è¯Šæ–­ã€‚

**å®šä¹‰ 1ï¼ˆç›‘æ§ä½“ç³»ï¼‰**ï¼š
è®¾ MonitoringSystem = {metrics, collection, storage, visualization, alerting}ï¼Œå…¶ä¸­ï¼š

- metricsï¼šç›‘æ§æŒ‡æ ‡é›†åˆ
- collectionï¼šæ•°æ®æ”¶é›†æœºåˆ¶
- storageï¼šæ•°æ®å­˜å‚¨æœºåˆ¶
- visualizationï¼šæ•°æ®å¯è§†åŒ–
- alertingï¼šå‘Šè­¦æœºåˆ¶

**å®šä¹‰ 2ï¼ˆè¯Šæ–­ä½“ç³»ï¼‰**ï¼š
è®¾ DiagnosisSystem = {analysis, identification, resolution, prevention}ï¼Œå…¶ä¸­ï¼š

- analysisï¼šé—®é¢˜åˆ†æ
- identificationï¼šé—®é¢˜è¯†åˆ«
- resolutionï¼šé—®é¢˜è§£å†³
- preventionï¼šé—®é¢˜é¢„é˜²

**å®šä¹‰ 3ï¼ˆç›‘æ§æŒ‡æ ‡åˆ†ç±»ï¼‰**ï¼š
è®¾ MetricCategory = {system, query, lock, resource}ï¼Œå…¶ä¸­ï¼š

- systemï¼šç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€IOç­‰ï¼‰
- queryï¼šæŸ¥è¯¢æŒ‡æ ‡ï¼ˆæ…¢æŸ¥è¯¢ã€æŸ¥è¯¢ç»Ÿè®¡ç­‰ï¼‰
- lockï¼šé”æŒ‡æ ‡ï¼ˆé”ç­‰å¾…ã€æ­»é”ç­‰ï¼‰
- resourceï¼šèµ„æºæŒ‡æ ‡ï¼ˆæ•°æ®åº“å¤§å°ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰ï¼‰

**å®šä¹‰ 4ï¼ˆè¯Šæ–­æ–¹æ³•åˆ†ç±»ï¼‰**ï¼š
è®¾ DiagnosisMethod = {reactive, proactive, predictive}ï¼Œå…¶ä¸­ï¼š

- reactiveï¼šååº”å¼è¯Šæ–­ï¼ˆé—®é¢˜å‘ç”Ÿåï¼‰
- proactiveï¼šä¸»åŠ¨å¼è¯Šæ–­ï¼ˆå®šæœŸæ£€æŸ¥ï¼‰
- predictiveï¼šé¢„æµ‹å¼è¯Šæ–­ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç† 1ï¼ˆç›‘æ§ä½“ç³»å®Œæ•´æ€§ï¼‰**ï¼š
å¦‚æœç›‘æ§ä½“ç³»è¦†ç›–æ‰€æœ‰å…³é”®æŒ‡æ ‡ç±»åˆ«ï¼Œåˆ™ç›‘æ§ä½“ç³»å®Œæ•´ã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰3ï¼Œç›‘æ§æŒ‡æ ‡åŒ…æ‹¬ç³»ç»Ÿã€æŸ¥è¯¢ã€é”ã€èµ„æºå››ç±»
2. ç›‘æ§ä½“ç³»è¦†ç›–æ‰€æœ‰å…³é”®æŒ‡æ ‡ç±»åˆ«
3. ç›‘æ§ä½“ç³»èƒ½å¤Ÿå…¨é¢ç›‘æ§æ•°æ®åº“çŠ¶æ€
4. å› æ­¤ï¼Œç›‘æ§ä½“ç³»å®Œæ•´

**å®šç† 2ï¼ˆè¯Šæ–­ä½“ç³»æœ‰æ•ˆæ€§ï¼‰**ï¼š
è¯Šæ–­ä½“ç³»çš„æœ‰æ•ˆæ€§ä¸å…¶åˆ†ææ·±åº¦å’Œé—®é¢˜è¯†åˆ«å‡†ç¡®æ€§æˆæ­£æ¯”ã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰2ï¼Œè¯Šæ–­ä½“ç³»åŒ…æ‹¬åˆ†æã€è¯†åˆ«ã€è§£å†³ã€é¢„é˜²
2. åˆ†æè¶Šæ·±å…¥ï¼Œè¯†åˆ«è¶Šå‡†ç¡®ï¼Œè¯Šæ–­è¶Šæœ‰æ•ˆ
3. è¯Šæ–­æœ‰æ•ˆæ€§å½±å“é—®é¢˜è§£å†³æ•ˆç‡
4. å› æ­¤ï¼Œè¯Šæ–­ä½“ç³»æœ‰æ•ˆæ€§ä¸å…¶åˆ†ææ·±åº¦å’Œé—®é¢˜è¯†åˆ«å‡†ç¡®æ€§æˆæ­£æ¯”

**å®é™…åº”ç”¨**ï¼š

- ç›‘æ§ä½“ç³»åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œæ¶æ„è®¾è®¡
- è¯Šæ–­ä½“ç³»åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œæ–¹æ³•é€‰æ‹©
- ç›‘æ§å¹³å°åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡ŒæŒ‡æ ‡é…ç½®

### 2.1 ç›‘æ§æŒ‡æ ‡é€‰æ‹©å¯¹æ¯”çŸ©é˜µ

**ç›‘æ§æŒ‡æ ‡çš„é€‰æ‹©æ˜¯ç›‘æ§ç³»ç»Ÿå»ºè®¾çš„å…³é”®å†³ç­–**ï¼Œé€‰æ‹©åˆé€‚çš„æŒ‡æ ‡å¯ä»¥æå‡ç›‘æ§æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

**ç›‘æ§æŒ‡æ ‡é€‰æ‹©å¯¹æ¯”çŸ©é˜µ**ï¼š

| æŒ‡æ ‡ç±»åˆ« | é‡è¦æ€§ | å®æ—¶æ€§ | å­˜å‚¨æˆæœ¬ | åˆ†æä»·å€¼ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|---------|--------|--------|---------|---------|---------|---------|
| **ç³»ç»ŸæŒ‡æ ‡** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | æ‰€æœ‰åœºæ™¯ | 4.8/5 |
| **æŸ¥è¯¢æŒ‡æ ‡** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | æ€§èƒ½ä¼˜åŒ– | 4.4/5 |
| **é”æŒ‡æ ‡** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å¹¶å‘é—®é¢˜ | 4.2/5 |
| **èµ„æºæŒ‡æ ‡** | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å®¹é‡è§„åˆ’ | 3.8/5 |

**ç›‘æ§æŒ‡æ ‡é€‰æ‹©å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[éœ€è¦ç›‘æ§ç³»ç»Ÿ] --> B{ç›‘æ§ç›®æ ‡}
    B -->|æ€§èƒ½ç›‘æ§| C[é€‰æ‹©ç³»ç»ŸæŒ‡æ ‡+æŸ¥è¯¢æŒ‡æ ‡]
    B -->|æ•…éšœæ’æŸ¥| D[é€‰æ‹©ç³»ç»ŸæŒ‡æ ‡+é”æŒ‡æ ‡]
    B -->|å®¹é‡è§„åˆ’| E[é€‰æ‹©èµ„æºæŒ‡æ ‡]
    B -->|å…¨é¢ç›‘æ§| F[é€‰æ‹©æ‰€æœ‰æŒ‡æ ‡]
    C --> G[å®æ–½ç›‘æ§]
    D --> G
    E --> G
    F --> G
    G --> H[éªŒè¯ç›‘æ§æ•ˆæœ]
    H --> I{ç›‘æ§æ»¡è¶³è¦æ±‚?}
    I -->|æ˜¯| J[ç›‘æ§ç³»ç»Ÿå®Œæˆ]
    I -->|å¦| K{é—®é¢˜åˆ†æ}
    K -->|åŠŸèƒ½é—®é¢˜| L{æ˜¯å¦éœ€è¦å…¶ä»–æŒ‡æ ‡?}
    K -->|æ€§èƒ½é—®é¢˜| M[ä¼˜åŒ–ç›‘æ§é…ç½®]
    L -->|æ˜¯| N[æ·»åŠ æŒ‡æ ‡]
    L -->|å¦| O[é€‰æ‹©å…¶ä»–æŒ‡æ ‡]
    N --> G
    O --> B
    M --> G

    style B fill:#FFD700
    style I fill:#90EE90
    style J fill:#90EE90
```

## 3. ç›‘æ§è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾

### 3.1 ç›‘æ§è¯Šæ–­ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((ç›‘æ§è¯Šæ–­ä½“ç³»))
    ç³»ç»Ÿç›‘æ§
      è¿æ¥ç›‘æ§
        è¿æ¥æ•°
        è¿æ¥çŠ¶æ€
        è¿æ¥æ¥æº
      æ€§èƒ½ç›‘æ§
        CPUä½¿ç”¨ç‡
        å†…å­˜ä½¿ç”¨ç‡
        I/Oä½¿ç”¨ç‡
        ç½‘ç»œä½¿ç”¨ç‡
      èµ„æºç›‘æ§
        æ•°æ®åº“å¤§å°
        è¡¨å¤§å°
        ç´¢å¼•å¤§å°
        ç¼“å­˜å‘½ä¸­ç‡
    æŸ¥è¯¢ç›‘æ§
      æ…¢æŸ¥è¯¢ç›‘æ§
        æ…¢æŸ¥è¯¢è¯†åˆ«
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢ç»Ÿè®¡
        æŸ¥è¯¢æ¬¡æ•°
        æŸ¥è¯¢è€—æ—¶
        æŸ¥è¯¢è®¡åˆ’
        æŸ¥è¯¢ç¼“å­˜
      pg_stat_statements
        æŸ¥è¯¢ç»Ÿè®¡
        æ‰§è¡Œè®¡åˆ’
        æ€§èƒ½åˆ†æ
    é”ç›‘æ§
      é”ç­‰å¾…
        é”ç­‰å¾…æ—¶é—´
        é”ç­‰å¾…æŸ¥è¯¢
        é”ç­‰å¾…åŸå› 
      æ­»é”ç›‘æ§
        æ­»é”æ£€æµ‹
        æ­»é”æ—¥å¿—
        æ­»é”åˆ†æ
      é”ç»Ÿè®¡
        é”ç±»å‹ç»Ÿè®¡
        é”ç­‰å¾…ç»Ÿè®¡
        é”å†²çªç»Ÿè®¡
    æ—¥å¿—åˆ†æ
      é”™è¯¯æ—¥å¿—
        é”™è¯¯çº§åˆ«
        é”™è¯¯ä¿¡æ¯
        é”™è¯¯ç»Ÿè®¡
      æ…¢æŸ¥è¯¢æ—¥å¿—
        æ…¢æŸ¥è¯¢è®°å½•
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
      pgBadger
        æ—¥å¿—åˆ†æ
        æŠ¥è¡¨ç”Ÿæˆ
        æ€§èƒ½åˆ†æ
    è¯Šæ–­å·¥å…·
      EXPLAIN
        æŸ¥è¯¢è®¡åˆ’
        æ‰§è¡Œæˆæœ¬
        ä¼˜åŒ–å»ºè®®
      EXPLAIN ANALYZE
        å®é™…æ‰§è¡Œ
        å®é™…æˆæœ¬
        æ€§èƒ½åˆ†æ
      pg_stat_activity
        æ´»åŠ¨æŸ¥è¯¢
        æŸ¥è¯¢çŠ¶æ€
        æŸ¥è¯¢ä¿¡æ¯
      pg_locks
        é”ä¿¡æ¯
        é”ç­‰å¾…
        é”å†²çª
```

### 3.2 ç›‘æ§è¯Šæ–­æµç¨‹

```mermaid
flowchart TD
    A[ç›‘æ§éœ€æ±‚] --> B{ç›‘æ§ç±»å‹?}
    B -->|ç³»ç»Ÿç›‘æ§| C[ç³»ç»ŸæŒ‡æ ‡ç›‘æ§]
    B -->|æŸ¥è¯¢ç›‘æ§| D[æŸ¥è¯¢æ€§èƒ½ç›‘æ§]
    B -->|é”ç›‘æ§| E[é”ç­‰å¾…ç›‘æ§]
    B -->|æ—¥å¿—åˆ†æ| F[æ—¥å¿—åˆ†æ]
    C --> G{å‘ç°é—®é¢˜?}
    D --> G
    E --> G
    F --> G
    G -->|æ˜¯| H[é—®é¢˜è¯Šæ–­]
    G -->|å¦| I[æŒç»­ç›‘æ§]
    H --> J{é—®é¢˜ç±»å‹?}
    J -->|æ€§èƒ½é—®é¢˜| K[æ€§èƒ½ä¼˜åŒ–]
    J -->|é”é—®é¢˜| L[é”ä¼˜åŒ–]
    J -->|èµ„æºé—®é¢˜| M[èµ„æºä¼˜åŒ–]
    K --> N[éªŒè¯ä¼˜åŒ–æ•ˆæœ]
    L --> N
    M --> N
    N --> I
```

## 4. ç›‘æ§æŒ‡æ ‡è¯¦è§£

### 4.1 ç³»ç»Ÿç›‘æ§æŒ‡æ ‡

**å…³é”®ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ | è¯´æ˜ | é˜ˆå€¼ | é‡è¦æ€§ |
|------|------|------|--------|
| **è¿æ¥æ•°** | å½“å‰è¿æ¥æ•° | < max_connections * 80% | â­â­â­â­â­ |
| **CPUä½¿ç”¨ç‡** | CPUä½¿ç”¨ç‡ | < 80% | â­â­â­â­â­ |
| **å†…å­˜ä½¿ç”¨ç‡** | å†…å­˜ä½¿ç”¨ç‡ | < 90% | â­â­â­â­â­ |
| **I/Oä½¿ç”¨ç‡** | I/Oä½¿ç”¨ç‡ | < 80% | â­â­â­â­ |
| **ç¼“å­˜å‘½ä¸­ç‡** | ç¼“å­˜å‘½ä¸­ç‡ | > 95% | â­â­â­â­â­ |
| **æ•°æ®åº“å¤§å°** | æ•°æ®åº“å¤§å° | ç›‘æ§å¢é•¿ | â­â­â­ |
| **è¡¨å¤§å°** | è¡¨å¤§å° | ç›‘æ§å¢é•¿ | â­â­â­ |

**ç›‘æ§æŸ¥è¯¢ç¤ºä¾‹**:

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction
FROM pg_stat_activity;

-- 2. æ•°æ®åº“å¤§å°ç›‘æ§
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- 3. è¡¨å¤§å°ç›‘æ§
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) AS index_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- 4. ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    CASE
        WHEN sum(heap_blks_hit) = 0 THEN 0
        ELSE round(sum(heap_blks_hit)::numeric / (sum(heap_blks_hit) + sum(heap_blks_read)), 4) * 100
    END AS cache_hit_ratio
FROM pg_statio_user_tables;
```

### 4.2 æŸ¥è¯¢ç›‘æ§æŒ‡æ ‡

**æŸ¥è¯¢ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ | è¯´æ˜ | é˜ˆå€¼ | é‡è¦æ€§ |
|------|------|------|--------|
| **æ…¢æŸ¥è¯¢æ•°** | æ…¢æŸ¥è¯¢æ•°é‡ | < 10/åˆ†é’Ÿ | â­â­â­â­â­ |
| **å¹³å‡æŸ¥è¯¢æ—¶é—´** | å¹³å‡æŸ¥è¯¢æ—¶é—´ | < 100ms | â­â­â­â­â­ |
| **æŸ¥è¯¢æ€»æ•°** | æŸ¥è¯¢æ€»æ•° | ç›‘æ§è¶‹åŠ¿ | â­â­â­ |
| **æŸ¥è¯¢é”™è¯¯ç‡** | æŸ¥è¯¢é”™è¯¯ç‡ | < 1% | â­â­â­â­â­ |

**æŸ¥è¯¢ç›‘æ§ç¤ºä¾‹**:

```sql
-- 1. å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 3. æŸ¥è¯¢æœ€é¢‘ç¹çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 20;

-- 4. æŸ¥è¯¢æ€»è€—æ—¶æœ€é•¿çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

### 4.3 é”ç›‘æ§æŒ‡æ ‡

**é”ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ | è¯´æ˜ | é˜ˆå€¼ | é‡è¦æ€§ |
|------|------|------|--------|
| **é”ç­‰å¾…æ•°** | é”ç­‰å¾…æ•°é‡ | < 5 | â­â­â­â­â­ |
| **é”ç­‰å¾…æ—¶é—´** | é”ç­‰å¾…æ—¶é—´ | < 1ç§’ | â­â­â­â­â­ |
| **æ­»é”æ•°** | æ­»é”æ•°é‡ | 0 | â­â­â­â­â­ |

**é”ç›‘æ§ç¤ºä¾‹**:

```sql
-- 1. æŸ¥çœ‹å½“å‰é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    blocked_activity.application_name AS blocked_application,
    blocking_activity.application_name AS blocking_application
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 2. æŸ¥çœ‹é”ç»Ÿè®¡
SELECT
    locktype,
    mode,
    count(*) AS lock_count
FROM pg_locks
GROUP BY locktype, mode
ORDER BY lock_count DESC;

-- 3. æŸ¥çœ‹æ­»é”æ—¥å¿—
-- åœ¨postgresql.confä¸­å¯ç”¨
-- log_lock_waits = on
-- deadlock_timeout = 1s
```

## 5. è¯Šæ–­å·¥å…·è¯¦è§£

### 5.1 EXPLAIN å·¥å…·

**EXPLAIN ä½¿ç”¨ç¤ºä¾‹**:

```sql
-- 1. åŸºæœ¬EXPLAIN
EXPLAIN SELECT * FROM users WHERE email = 'user@example.com';

-- 2. EXPLAIN ANALYZEï¼ˆå®é™…æ‰§è¡Œï¼‰
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'user@example.com';

-- 3. EXPLAIN VERBOSEï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
EXPLAIN VERBOSE SELECT * FROM users WHERE email = 'user@example.com';

-- 4. EXPLAIN BUFFERSï¼ˆç¼“å†²åŒºä¿¡æ¯ï¼‰
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE email = 'user@example.com';

-- 5. EXPLAIN FORMATï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰
EXPLAIN (FORMAT JSON) SELECT * FROM users WHERE email = 'user@example.com';
EXPLAIN (FORMAT XML) SELECT * FROM users WHERE email = 'user@example.com';
```

### 5.2 pg_stat_activity è§†å›¾

**æ´»åŠ¨æŸ¥è¯¢ç›‘æ§**:

```sql
-- 1. æŸ¥çœ‹æ‰€æœ‰æ´»åŠ¨æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- 2. æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND now() - query_start > INTERVAL '5 minutes'
ORDER BY query_start;

-- 3. æŸ¥çœ‹é˜»å¡æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL;
```

### 5.3 pgBadger æ—¥å¿—åˆ†æ

**pgBadger é…ç½®**:

```bash
# 1. é…ç½®PostgreSQLæ—¥å¿—
# postgresql.conf
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
log_min_duration_statement = 1000  -- è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢

# 2. è¿è¡ŒpgBadger
pgbadger /var/lib/postgresql/data/log/postgresql-*.log -o report.html

# 3. å®šæœŸç”ŸæˆæŠ¥å‘Š
0 0 * * * /usr/bin/pgbadger /var/lib/postgresql/data/log/postgresql-*.log -o /var/www/html/reports/report-$(date +\%Y\%m\%d).html
```

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒç›‘æ§ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å»ºè®¾ç”Ÿäº§ç¯å¢ƒç›‘æ§ç³»ç»Ÿï¼Œæ•°æ®åº“æ•°é‡10+ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„ç›‘æ§æŒ‡æ ‡ã€‚

**é—®é¢˜åˆ†æ**:

1. **ç›‘æ§éœ€æ±‚**: éœ€è¦å…¨é¢ç›‘æ§æ•°æ®åº“æ€§èƒ½
2. **æŒ‡æ ‡é€‰æ‹©**: éœ€è¦é€‰æ‹©åˆé€‚çš„ç›‘æ§æŒ‡æ ‡
3. **æˆæœ¬æ§åˆ¶**: éœ€è¦æ§åˆ¶ç›‘æ§æˆæœ¬
4. **å®æ—¶æ€§**: éœ€è¦å®æ—¶ç›‘æ§èƒ½åŠ›

**ç›‘æ§æŒ‡æ ‡é€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºç”Ÿäº§ç¯å¢ƒé€‰æ‹©åˆé€‚çš„ç›‘æ§æŒ‡æ ‡ï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šç³»ç»ŸæŒ‡æ ‡+æŸ¥è¯¢æŒ‡æ ‡**

- **æè¿°**: ç›‘æ§ç³»ç»ŸæŒ‡æ ‡å’ŒæŸ¥è¯¢æŒ‡æ ‡
- **ä¼˜ç‚¹**:
  - è¦†ç›–æ€§èƒ½ç›‘æ§æ ¸å¿ƒéœ€æ±‚
  - å®æ—¶æ€§å¥½
  - åˆ†æä»·å€¼é«˜
- **ç¼ºç‚¹**:
  - å­˜å‚¨æˆæœ¬ä¸­ç­‰
  - ä¸åŒ…å«é”å’Œèµ„æºæŒ‡æ ‡
- **é€‚ç”¨åœºæ™¯**: æ€§èƒ½ä¼˜åŒ–åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<50msï¼Œå­˜å‚¨æˆæœ¬ä¸­ç­‰
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œå­˜å‚¨æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šç³»ç»ŸæŒ‡æ ‡+é”æŒ‡æ ‡**

- **æè¿°**: ç›‘æ§ç³»ç»ŸæŒ‡æ ‡å’Œé”æŒ‡æ ‡
- **ä¼˜ç‚¹**:
  - è¦†ç›–æ•…éšœæ’æŸ¥æ ¸å¿ƒéœ€æ±‚
  - å®æ—¶æ€§å¥½
  - å­˜å‚¨æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - ä¸åŒ…å«æŸ¥è¯¢å’Œèµ„æºæŒ‡æ ‡
  - åˆ†æä»·å€¼ä¸­ç­‰
- **é€‚ç”¨åœºæ™¯**: æ•…éšœæ’æŸ¥åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<50msï¼Œå­˜å‚¨æˆæœ¬ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œå­˜å‚¨æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ3ï¼šæ‰€æœ‰æŒ‡æ ‡**

- **æè¿°**: ç›‘æ§æ‰€æœ‰æŒ‡æ ‡ç±»åˆ«
- **ä¼˜ç‚¹**:
  - è¦†ç›–å…¨é¢
  - åˆ†æä»·å€¼é«˜
  - é€‚åˆå…¨é¢ç›‘æ§
- **ç¼ºç‚¹**:
  - å­˜å‚¨æˆæœ¬é«˜
  - é…ç½®å¤æ‚
- **é€‚ç”¨åœºæ™¯**: å…¨é¢ç›‘æ§åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<100msï¼Œå­˜å‚¨æˆæœ¬é«˜
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œå­˜å‚¨æˆæœ¬é«˜ï¼Œé£é™©ä¸­ç­‰

**æ–¹æ¡ˆ4ï¼šèµ„æºæŒ‡æ ‡**

- **æè¿°**: åªç›‘æ§èµ„æºæŒ‡æ ‡
- **ä¼˜ç‚¹**:
  - å­˜å‚¨æˆæœ¬ä½
  - é…ç½®ç®€å•
- **ç¼ºç‚¹**:
  - å®æ—¶æ€§å·®
  - åˆ†æä»·å€¼ä¸­ç­‰
  - ä¸åŒ…å«æ€§èƒ½å’Œæ•…éšœæŒ‡æ ‡
- **é€‚ç”¨åœºæ™¯**: å®¹é‡è§„åˆ’åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´<200msï¼Œå­˜å‚¨æˆæœ¬ä½
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œå­˜å‚¨æˆæœ¬ä½ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | é‡è¦æ€§ | å®æ—¶æ€§ | å­˜å‚¨æˆæœ¬ | åˆ†æä»·å€¼ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
|------|--------|--------|---------|---------|---------|---------|
| ç³»ç»Ÿ+æŸ¥è¯¢æŒ‡æ ‡ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | æ€§èƒ½ä¼˜åŒ– | 4.4/5 |
| ç³»ç»Ÿ+é”æŒ‡æ ‡ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | æ•…éšœæ’æŸ¥ | 4.2/5 |
| æ‰€æœ‰æŒ‡æ ‡ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | â­â­â­â­â­ | å…¨é¢ç›‘æ§ | 3.8/5 |
| èµ„æºæŒ‡æ ‡ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å®¹é‡è§„åˆ’ | 3.8/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- é‡è¦æ€§ï¼šæƒé‡30%
- å®æ—¶æ€§ï¼šæƒé‡25%
- å­˜å‚¨æˆæœ¬ï¼šæƒé‡20%
- åˆ†æä»·å€¼ï¼šæƒé‡15%
- é€‚ç”¨åœºæ™¯ï¼šæƒé‡10%

**è¯„åˆ†è®¡ç®—**:

- ç³»ç»Ÿ+æŸ¥è¯¢æŒ‡æ ‡ï¼š5.0 Ã— 0.3 + 4.0 Ã— 0.25 + 3.0 Ã— 0.2 + 5.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.4
- ç³»ç»Ÿ+é”æŒ‡æ ‡ï¼š4.0 Ã— 0.3 + 5.0 Ã— 0.25 + 5.0 Ã— 0.2 + 4.0 Ã— 0.15 + 4.0 Ã— 0.1 = 4.2
- æ‰€æœ‰æŒ‡æ ‡ï¼š5.0 Ã— 0.3 + 4.0 Ã— 0.25 + 2.0 Ã— 0.2 + 5.0 Ã— 0.15 + 5.0 Ã— 0.1 = 3.8
- èµ„æºæŒ‡æ ‡ï¼š4.0 Ã— 0.3 + 3.0 Ã— 0.25 + 5.0 Ã— 0.2 + 4.0 Ã— 0.15 + 3.0 Ã— 0.1 = 3.8

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: ç³»ç»ŸæŒ‡æ ‡+æŸ¥è¯¢æŒ‡æ ‡ï¼ˆæ€§èƒ½ä¼˜åŒ–åœºæ™¯ï¼‰

**æ¨èç†ç”±**:

1. è¦†ç›–æ€§èƒ½ç›‘æ§æ ¸å¿ƒéœ€æ±‚
2. å®æ—¶æ€§å¥½ï¼Œåˆ†æä»·å€¼é«˜
3. å­˜å‚¨æˆæœ¬åˆç†
4. é€‚åˆç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–

**å®æ–½å»ºè®®**:

1. ä¼˜å…ˆå®æ–½ç³»ç»ŸæŒ‡æ ‡å’ŒæŸ¥è¯¢æŒ‡æ ‡ç›‘æ§
2. æ ¹æ®å®é™…éœ€æ±‚é€æ­¥æ·»åŠ é”æŒ‡æ ‡å’Œèµ„æºæŒ‡æ ‡
3. é…ç½®å‘Šè­¦è§„åˆ™ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. å®šæœŸå®¡æŸ¥ç›‘æ§æ•ˆæœï¼ŒæŒç»­ä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆ**:

**ä¸šåŠ¡åœºæ™¯**:

æŸç”Ÿäº§ç¯å¢ƒéœ€è¦å»ºç«‹å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿã€‚

**ç›‘æ§æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºç›‘æ§è§†å›¾
CREATE VIEW monitoring.connection_stats AS
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction,
    count(*) FILTER (WHERE wait_event_type IS NOT NULL) AS waiting_connections
FROM pg_stat_activity;

-- 2. åˆ›å»ºæ…¢æŸ¥è¯¢ç›‘æ§è§†å›¾
CREATE VIEW monitoring.slow_queries AS
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC;

-- 3. åˆ›å»ºé”ç­‰å¾…ç›‘æ§è§†å›¾
CREATE VIEW monitoring.lock_waits AS
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    now() - blocked_activity.query_start AS wait_duration
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 4. åˆ›å»ºç›‘æ§å‡½æ•°
CREATE OR REPLACE FUNCTION monitoring.check_health()
RETURNS TABLE (
    metric TEXT,
    value NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'connections'::TEXT,
        (SELECT count(*) FROM pg_stat_activity)::NUMERIC,
        CASE
            WHEN (SELECT count(*) FROM pg_stat_activity) > (SELECT setting::INTEGER FROM pg_settings WHERE name = 'max_connections') * 0.8
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END
    UNION ALL
    SELECT
        'cache_hit_ratio'::TEXT,
        (SELECT
            CASE
                WHEN sum(heap_blks_hit) = 0 THEN 0
                ELSE round(sum(heap_blks_hit)::numeric / (sum(heap_blks_hit) + sum(heap_blks_read)), 4) * 100
            END
        FROM pg_statio_user_tables)::NUMERIC,
        CASE
            WHEN (SELECT
                CASE
                    WHEN sum(heap_blks_hit) = 0 THEN 0
                    ELSE round(sum(heap_blks_hit)::numeric / (sum(heap_blks_hit) + sum(heap_blks_read)), 4) * 100
                END
            FROM pg_statio_user_tables) < 95
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END
    UNION ALL
    SELECT
        'slow_queries'::TEXT,
        (SELECT count(*) FROM monitoring.slow_queries)::NUMERIC,
        CASE
            WHEN (SELECT count(*) FROM monitoring.slow_queries) > 10
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END
    UNION ALL
    SELECT
        'lock_waits'::TEXT,
        (SELECT count(*) FROM monitoring.lock_waits)::NUMERIC,
        CASE
            WHEN (SELECT count(*) FROM monitoring.lock_waits) > 5
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•…éšœå‘ç°æ—¶é—´** | 30 åˆ†é’Ÿ | **< 5 åˆ†é’Ÿ** | **83%** â¬‡ï¸ |
| **æ•…éšœæ¢å¤æ—¶é—´** | 2 å°æ—¶ | **< 30 åˆ†é’Ÿ** | **75%** â¬‡ï¸ |
| **æ€§èƒ½é—®é¢˜å‘ç°** | è¢«åŠ¨å‘ç° | **ä¸»åŠ¨å‘ç°** | **æå‡** |

### 6.2 æ¡ˆä¾‹: æ€§èƒ½ä¼˜åŒ–è¯Šæ–­ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç³»ç»Ÿéœ€è¦è¯Šæ–­å’Œä¼˜åŒ–æ€§èƒ½é—®é¢˜ã€‚

**è¯Šæ–­æ–¹æ¡ˆ**:

```sql
-- 1. è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 12345
  AND created_at > '2025-01-01';

-- 3. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;

-- 4. æ£€æŸ¥æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND schemaname = 'public';
```

## 7. æœ€ä½³å®è·µ

### 7.1 ç›‘æ§é…ç½®å»ºè®®

1. **å…³é”®æŒ‡æ ‡**: ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡
2. **å‘Šè­¦é˜ˆå€¼**: è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
3. **è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–ç›‘æ§å’Œå‘Šè­¦
4. **å®šæœŸæ£€æŸ¥**: å®šæœŸæ£€æŸ¥ç›‘æ§æ•°æ®

### 7.2 è¯Šæ–­å»ºè®®

1. **ä½¿ç”¨EXPLAIN**: ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢
2. **ç›‘æ§æ…¢æŸ¥è¯¢**: ç›‘æ§æ…¢æŸ¥è¯¢
3. **åˆ†ææ—¥å¿—**: å®šæœŸåˆ†ææ—¥å¿—
4. **æ€§èƒ½åŸºçº¿**: å»ºç«‹æ€§èƒ½åŸºçº¿

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - ç›‘æ§å®Œæ•´å‚è€ƒæ‰‹å†Œ
  - åŒ…å«æ‰€æœ‰ç›‘æ§ç‰¹æ€§çš„è¯¦ç»†è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](https://www.postgresql.org/docs/current/monitoring-stats.html)**
  - ç»Ÿè®¡ä¿¡æ¯è¯¦ç»†è¯´æ˜
  - ç›‘æ§è§†å›¾ä½¿ç”¨æŒ‡å—

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Gray, J., & Reuter, A. (1993). "Transaction Processing: Concepts and Techniques."](https://www.amazon.com/Transaction-Processing-Concepts-Techniques-Management/dp/1558601902)**
  - äº‹åŠ¡å¤„ç†çš„ç»å…¸æ•™æ
  - ç›‘æ§å’Œè¯Šæ–­åœ¨äº‹åŠ¡å¤„ç†ä¸­çš„åº”ç”¨

- **[Stonebraker, M., et al. (2007). "The End of an Architectural Era: (It's Time for a Complete Rewrite)."](https://dl.acm.org/doi/10.1145/1247480.1247502)**
  - æ•°æ®åº“æ¶æ„çš„åŸºç¡€ç ”ç©¶
  - ç›‘æ§åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­çš„åº”ç”¨

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - ç›‘æ§](https://www.postgresql.org/about/newsarchive/)**
  - PostgreSQL ç›‘æ§æœ€æ–°åŠ¨æ€
  - å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†äº«

- **[2ndQuadrant PostgreSQL åšå®¢](https://www.2ndquadrant.com/en/blog/)**
  - PostgreSQL ç›‘æ§æ–‡ç« 
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Percona PostgreSQL åšå®¢](https://www.percona.com/blog/tag/postgresql/)**
  - PostgreSQL ç›‘æ§ä¼˜åŒ–å®è·µ
  - ç›‘æ§æ¡ˆä¾‹

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - ç›‘æ§](https://wiki.postgresql.org/wiki/Monitoring)**
  - PostgreSQL ç›‘æ§Wiki
  - å¸¸è§é—®é¢˜è§£ç­”å’Œæœ€ä½³å®è·µ

- **[Stack Overflow - PostgreSQL ç›‘æ§](https://stackoverflow.com/questions/tagged/postgresql+monitoring)**
  - PostgreSQL ç›‘æ§ç›¸å…³é—®ç­”
  - é«˜è´¨é‡çš„é—®é¢˜å’Œç­”æ¡ˆ

- **[PostgreSQL é‚®ä»¶åˆ—è¡¨](https://www.postgresql.org/list/)**
  - PostgreSQL ç¤¾åŒºè®¨è®º
  - ç›‘æ§ä½¿ç”¨é—®é¢˜äº¤æµ

### 8.5 ç›¸å…³æ–‡æ¡£

- [ç›‘æ§ä¸è¯Šæ–­](./ç›‘æ§ä¸è¯Šæ–­.md)
- [æ—¥å¿—ç®¡ç†ä¸åˆ†æ](./æ—¥å¿—ç®¡ç†ä¸åˆ†æ.md)
- [æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£](../11-æ€§èƒ½è°ƒä¼˜/æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£.md)

- [ç›‘æ§ä¸è¯Šæ–­](./ç›‘æ§ä¸è¯Šæ–­.md)
- [æŸ¥è¯¢è®¡åˆ’ä¸ä¼˜åŒ–å™¨](./æŸ¥è¯¢è®¡åˆ’ä¸ä¼˜åŒ–å™¨.md)
- [æ—¥å¿—ç®¡ç†ä¸åˆ†æ](./æ—¥å¿—ç®¡ç†ä¸åˆ†æ.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-58
