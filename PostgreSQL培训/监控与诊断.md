# PostgreSQL ç›‘æ§ä¸è¯Šæ–­

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-13

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç›‘æ§ä¸è¯Šæ–­](#postgresql-ç›‘æ§ä¸è¯Šæ–­)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾](#13-ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. ç³»ç»Ÿç›‘æ§](#2-ç³»ç»Ÿç›‘æ§)
    - [1.1 æ•°æ®åº“æ´»åŠ¨ç›‘æ§](#11-æ•°æ®åº“æ´»åŠ¨ç›‘æ§)
    - [1.2 æ•°æ®åº“å¤§å°ç›‘æ§](#12-æ•°æ®åº“å¤§å°ç›‘æ§)
    - [1.3 è¡¨ç»Ÿè®¡ä¿¡æ¯](#13-è¡¨ç»Ÿè®¡ä¿¡æ¯)
  - [3. æ•°æ®åº“ç›‘æ§](#3-æ•°æ®åº“ç›‘æ§)
    - [2.1 ç´¢å¼•ä½¿ç”¨æƒ…å†µ](#21-ç´¢å¼•ä½¿ç”¨æƒ…å†µ)
    - [2.2 æ…¢æŸ¥è¯¢ç›‘æ§](#22-æ…¢æŸ¥è¯¢ç›‘æ§)
  - [4. é”ç›‘æ§](#4-é”ç›‘æ§)
    - [3.1 æŸ¥çœ‹å½“å‰é”](#31-æŸ¥çœ‹å½“å‰é”)
    - [3.2 ç»ˆæ­¢é˜»å¡æŸ¥è¯¢](#32-ç»ˆæ­¢é˜»å¡æŸ¥è¯¢)
  - [5. æ—¥å¿—åˆ†æ](#5-æ—¥å¿—åˆ†æ)
    - [4.1 æ—¥å¿—é…ç½®](#41-æ—¥å¿—é…ç½®)
    - [4.2 æ—¥å¿—åˆ†æ](#42-æ—¥å¿—åˆ†æ)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ](#51-æ¡ˆä¾‹-ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ)
    - [5.2 æ¡ˆä¾‹: æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ](#52-æ¡ˆä¾‹-æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ)
  - [7. å®è·µç»ƒä¹ ](#7-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€](#ç»ƒä¹ -1-ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€)
    - [ç»ƒä¹  2: åˆ›å»ºç›‘æ§è§†å›¾](#ç»ƒä¹ -2-åˆ›å»ºç›‘æ§è§†å›¾)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 ç›‘æ§åŸåˆ™](#81-ç›‘æ§åŸåˆ™)
    - [8.2 è¯Šæ–­å»ºè®®](#82-è¯Šæ–­å»ºè®®)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç›‘æ§ä¸è¯Šæ–­çš„ä»·å€¼**:

PostgreSQL ç›‘æ§ä¸è¯Šæ–­æ˜¯æ•°æ®åº“ç®¡ç†çš„é‡è¦ä»»åŠ¡ï¼š

1. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡
2. **é—®é¢˜è¯Šæ–­**: è¯Šæ–­æ€§èƒ½é—®é¢˜å’Œæ•…éšœ
3. **å®¹é‡è§„åˆ’**: è¿›è¡Œå®¹é‡è§„åˆ’
4. **é¢„é˜²æ€§ç»´æŠ¤**: é¢„é˜²æ€§ç»´æŠ¤

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ•°æ®åº“æ€§èƒ½
- **æ•…éšœæ’æŸ¥**: æ’æŸ¥æ•°æ®åº“æ•…éšœ
- **å®¹é‡è§„åˆ’**: è§„åˆ’æ•°æ®åº“å®¹é‡
- **é¢„é˜²æ€§ç»´æŠ¤**: é¢„é˜²æ€§ç»´æŠ¤

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•…éšœæ¢å¤æ—¶é—´** | ç›‘æ§ç¼©çŸ­æ¢å¤æ—¶é—´ | **-70%** |
| **é—®é¢˜é¢„é˜²** | é¢„é˜²æ€§é—®é¢˜å‘ç° | **+80%** |
| **æ€§èƒ½ä¼˜åŒ–** | ç›‘æ§æŒ‡å¯¼ä¼˜åŒ– | **+50%** |
| **å¯ç”¨æ€§** | æå‡å¯ç”¨æ€§ | **+20%** |

### 1.3 ç›‘æ§ä¸è¯Šæ–­ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç›‘æ§ä¸è¯Šæ–­ä½“ç³»))
    ç³»ç»Ÿç›‘æ§
      æ•°æ®åº“æ´»åŠ¨
        è¿æ¥ç›‘æ§
        æŸ¥è¯¢ç›‘æ§
        äº‹åŠ¡ç›‘æ§
      æ•°æ®åº“å¤§å°
        æ•°æ®åº“å¤§å°
        è¡¨å¤§å°
        ç´¢å¼•å¤§å°
      ç»Ÿè®¡ä¿¡æ¯
        è¡¨ç»Ÿè®¡
        ç´¢å¼•ç»Ÿè®¡
        æŸ¥è¯¢ç»Ÿè®¡
    æ€§èƒ½ç›‘æ§
      æ…¢æŸ¥è¯¢ç›‘æ§
        æ…¢æŸ¥è¯¢è¯†åˆ«
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
      é”ç›‘æ§
        é”ç­‰å¾…
        æ­»é”æ£€æµ‹
        é”å†²çª
      èµ„æºç›‘æ§
        CPUä½¿ç”¨
        å†…å­˜ä½¿ç”¨
        I/Oä½¿ç”¨
    è¯Šæ–­å·¥å…·
      EXPLAIN
        æŸ¥è¯¢è®¡åˆ’
        æ‰§è¡Œæˆæœ¬
        æ€§èƒ½åˆ†æ
      pg_stat_statements
        æŸ¥è¯¢ç»Ÿè®¡
        æ€§èƒ½åˆ†æ
        ä¼˜åŒ–å»ºè®®
      æ—¥å¿—åˆ†æ
        é”™è¯¯æ—¥å¿—
        æ…¢æŸ¥è¯¢æ—¥å¿—
        å®¡è®¡æ—¥å¿—
```

## 2. ç³»ç»Ÿç›‘æ§

### 1.1 æ•°æ®åº“æ´»åŠ¨ç›‘æ§

**æ´»åŠ¨ç›‘æ§åŸç†**:

`pg_stat_activity` è§†å›¾æä¾›å½“å‰æ•°æ®åº“æ´»åŠ¨çš„å®æ—¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿æ¥ã€æŸ¥è¯¢çŠ¶æ€ã€ç­‰å¾…äº‹ä»¶ç­‰ã€‚

**æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥**:

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE datname = current_database()
ORDER BY query_start;

-- æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
SELECT
    state,
    COUNT(*) as connection_count,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_count
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY state;
```

**æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ï¼ˆ> 5 åˆ†é’Ÿï¼‰
SELECT
    pid,
    usename,
    application_name,
    now() - query_start AS duration,
    state,
    wait_event_type,
    wait_event,
    LEFT(query, 200) as query_preview
FROM pg_stat_activity
WHERE (now() - query_start) > interval '5 minutes'
  AND state != 'idle'
  AND datname = current_database()
ORDER BY query_start;

-- æŸ¥çœ‹é˜»å¡æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    now() - blocked_activity.query_start AS blocked_duration
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| **æ´»è·ƒè¿æ¥æ•°** | < 80% max_connections | > 90% | æ¥è¿‘æœ€å¤§è¿æ¥æ•° |
| **ç©ºé—²è¿æ¥æ•°** | < 50% | > 70% | è¿æ¥æ³„æ¼ |
| **é•¿æ—¶é—´æŸ¥è¯¢** | < 1 åˆ†é’Ÿ | > 5 åˆ†é’Ÿ | éœ€è¦ä¼˜åŒ– |
| **é˜»å¡æŸ¥è¯¢** | 0 | > 0 | å­˜åœ¨é”ç«äº‰ |

### 1.2 æ•°æ®åº“å¤§å°ç›‘æ§

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 1.3 è¡¨ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    n_mod_since_analyze,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;
```

## 3. æ•°æ®åº“ç›‘æ§

### 2.1 ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 2.2 æ…¢æŸ¥è¯¢ç›‘æ§

```sql
-- ä½¿ç”¨ pg_stat_statements ç›‘æ§æ…¢æŸ¥è¯¢
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    (100 * total_exec_time / SUM(total_exec_time) OVER ()) AS percent_total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 4. é”ç›‘æ§

### 3.1 æŸ¥çœ‹å½“å‰é”

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    pg_blocking_pids(pid) AS blocked_by
FROM pg_locks
WHERE relation IS NOT NULL;

-- æŸ¥çœ‹é˜»å¡çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.2 ç»ˆæ­¢é˜»å¡æŸ¥è¯¢

```sql
-- æŸ¥çœ‹é˜»å¡æŸ¥è¯¢çš„ PID
SELECT pid, query FROM pg_stat_activity WHERE state = 'active';

-- ç»ˆæ­¢æŸ¥è¯¢
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;

-- å–æ¶ˆæŸ¥è¯¢ï¼ˆæ›´æ¸©å’Œï¼‰
SELECT pg_cancel_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;
```

## 5. æ—¥å¿—åˆ†æ

### 4.1 æ—¥å¿—é…ç½®

```sql
-- æŸ¥çœ‹æ—¥å¿—é…ç½®
SHOW log_destination;
SHOW logging_collector;
SHOW log_directory;
SHOW log_filename;
SHOW log_min_duration_statement;

-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
-- log_min_duration_statement = 1000  # è®°å½•æ‰§è¡Œæ—¶é—´ > 1ç§’çš„æŸ¥è¯¢
```

### 4.2 æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep ERROR

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep "duration:"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep ERROR /var/log/postgresql/postgresql-*.log | \
    awk '{print $NF}' | sort | uniq -c | sort -rn
```

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§ç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**:

æŸç”Ÿäº§ç¯å¢ƒéœ€è¦å®æ—¶ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ã€‚

**ç›‘æ§æ–¹æ¡ˆ**:

```sql
-- åˆ›å»ºç»¼åˆç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW database_health_dashboard AS
SELECT
    -- è¿æ¥ä¿¡æ¯
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type IS NOT NULL) AS waiting_connections,

    -- æ•°æ®åº“å¤§å°
    pg_size_pretty(pg_database_size(current_database())) AS database_size,

    -- è¡¨ç»Ÿè®¡
    (SELECT COUNT(*) FROM pg_stat_user_tables) AS total_tables,
    (SELECT SUM(n_live_tup) FROM pg_stat_user_tables) AS total_rows,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) AS total_dead_tuples,

    -- ç´¢å¼•ç»Ÿè®¡
    (SELECT COUNT(*) FROM pg_stat_user_indexes) AS total_indexes,
    (SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0) AS unused_indexes,

    -- ç¼“å­˜å‘½ä¸­ç‡
    (SELECT
        ROUND(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2)
     FROM pg_statio_user_tables) AS cache_hit_ratio,

    -- å½“å‰æ—¶é—´
    NOW() AS check_time;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾
SELECT * FROM database_health_dashboard;
```

**å‘Šè­¦è§„åˆ™**:

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | åŠ¨ä½œ |
|------|--------|---------|---------|------|
| **æ´»è·ƒè¿æ¥æ•°** | < 80 | > 90 | > 95 | å‘Šè­¦/æ‰©å®¹ |
| **æ­»å…ƒç»„æ•°** | < 1000ä¸‡ | > 5000ä¸‡ | > 1äº¿ | æ‰§è¡Œ VACUUM |
| **ç¼“å­˜å‘½ä¸­ç‡** | > 95% | < 90% | < 85% | æ£€æŸ¥é…ç½® |
| **æœªä½¿ç”¨ç´¢å¼•** | < 10 | > 20 | > 50 | æ¸…ç†ç´¢å¼• |

### 5.2 æ¡ˆä¾‹: æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**:

éœ€è¦è‡ªåŠ¨è¯†åˆ«å’Œåˆ†ææ…¢æŸ¥è¯¢ï¼Œç”Ÿæˆä¼˜åŒ–å»ºè®®ã€‚

**å®ç°æ–¹æ¡ˆ**:

```sql
-- åˆ›å»ºæ…¢æŸ¥è¯¢åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_slow_queries(
    min_exec_time_ms NUMERIC DEFAULT 1000
)
RETURNS TABLE (
    query_id BIGINT,
    query_preview TEXT,
    calls BIGINT,
    total_time_ms NUMERIC,
    mean_time_ms NUMERIC,
    max_time_ms NUMERIC,
    recommendation TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        q.queryid,
        LEFT(q.query, 200) as query_preview,
        q.calls,
        ROUND(q.total_exec_time::NUMERIC, 2) as total_time_ms,
        ROUND(q.mean_exec_time::NUMERIC, 2) as mean_time_ms,
        ROUND(q.max_exec_time::NUMERIC, 2) as max_time_ms,
        CASE
            WHEN q.query LIKE '%SELECT *%' THEN 'å»ºè®®ï¼šé¿å… SELECT *ï¼Œåªé€‰æ‹©éœ€è¦çš„åˆ—'
            WHEN q.query LIKE '%LIKE ''%%%' THEN 'å»ºè®®ï¼šLIKE æ¨¡å¼ä»¥ % å¼€å¤´æ— æ³•ä½¿ç”¨ç´¢å¼•'
            WHEN q.query LIKE '%ORDER BY%' AND q.query NOT LIKE '%LIMIT%' THEN 'å»ºè®®ï¼šæ·»åŠ  LIMIT é™åˆ¶ç»“æœé›†'
            WHEN q.calls > 1000 AND q.mean_exec_time > 100 THEN 'å»ºè®®ï¼šè€ƒè™‘åˆ›å»ºç´¢å¼•æˆ–ä¼˜åŒ–æŸ¥è¯¢'
            ELSE 'å»ºè®®ï¼šä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææŸ¥è¯¢è®¡åˆ’'
        END as recommendation
    FROM pg_stat_statements q
    WHERE q.mean_exec_time > min_exec_time_ms
      AND q.query NOT LIKE '%pg_stat_statements%'
    ORDER BY q.total_exec_time DESC
    LIMIT 20;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM analyze_slow_queries(1000);
```

## 7. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å¥åº·æ£€æŸ¥æŸ¥è¯¢
SELECT
    'Database Size' AS metric,
    pg_size_pretty(pg_database_size(current_database())) AS value
UNION ALL
SELECT
    'Active Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'active'
UNION ALL
SELECT
    'Idle Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'idle'
UNION ALL
SELECT
    'Dead Tuples',
    SUM(n_dead_tup)::TEXT
FROM pg_stat_user_tables
UNION ALL
SELECT
    'Unused Indexes',
    COUNT(*)::TEXT
FROM pg_stat_user_indexes
WHERE idx_scan = 0;
```

### ç»ƒä¹  2: åˆ›å»ºç›‘æ§è§†å›¾

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªç›‘æ§è§†å›¾
CREATE VIEW database_health AS
SELECT
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) AS total_dead_tuples,
    (SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0) AS unused_indexes,
    (SELECT pg_size_pretty(pg_database_size(current_database()))) AS database_size;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾
SELECT * FROM database_health;
```

## 8. æœ€ä½³å®è·µ

### 8.1 ç›‘æ§åŸåˆ™

1. **å…¨é¢ç›‘æ§**: ç›‘æ§æ‰€æœ‰å…³é”®æŒ‡æ ‡
2. **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®åº“çŠ¶æ€
3. **å‘Šè­¦æœºåˆ¶**: å»ºç«‹å‘Šè­¦æœºåˆ¶
4. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æç›‘æ§æ•°æ®

### 8.2 è¯Šæ–­å»ºè®®

1. **é—®é¢˜å®šä½**: å¿«é€Ÿå®šä½é—®é¢˜
2. **æ ¹å› åˆ†æ**: åˆ†æé—®é¢˜æ ¹å› 
3. **è§£å†³æ–¹æ¡ˆ**: åˆ¶å®šè§£å†³æ–¹æ¡ˆ
4. **é¢„é˜²æªæ–½**: é‡‡å–é¢„é˜²æªæ–½

## 9. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯è§†å›¾](https://www.postgresql.org/docs/current/monitoring-stats.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-13
