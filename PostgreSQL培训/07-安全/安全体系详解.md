# PostgreSQL å®‰å…¨ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-57

## ğŸ“‘ ç›®å½•

- [PostgreSQL å®‰å…¨ä½“ç³»è¯¦è§£](#postgresql-å®‰å…¨ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾](#2-å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 å®‰å…¨ä½“ç³»æ¶æ„](#21-å®‰å…¨ä½“ç³»æ¶æ„)
    - [2.2 å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹](#22-å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹)
  - [3. å®‰å…¨æœºåˆ¶è¯¦è§£](#3-å®‰å…¨æœºåˆ¶è¯¦è§£)
    - [3.1 èº«ä»½è®¤è¯æœºåˆ¶](#31-èº«ä»½è®¤è¯æœºåˆ¶)
    - [3.2 æƒé™ç®¡ç†æœºåˆ¶](#32-æƒé™ç®¡ç†æœºåˆ¶)
    - [3.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰æœºåˆ¶](#33-è¡Œçº§å®‰å…¨rlsæœºåˆ¶)
    - [3.4 æ•°æ®åŠ å¯†æœºåˆ¶](#34-æ•°æ®åŠ å¯†æœºåˆ¶)
    - [3.5 å®¡è®¡æ—¥å¿—æœºåˆ¶](#35-å®¡è®¡æ—¥å¿—æœºåˆ¶)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 å®‰å…¨é…ç½®åŸåˆ™](#51-å®‰å…¨é…ç½®åŸåˆ™)
    - [5.2 å®‰å…¨å»ºè®®](#52-å®‰å…¨å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**å®‰å…¨ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œæ•´çš„å®‰å…¨æœºåˆ¶ï¼š

1. **èº«ä»½è®¤è¯**: å¤šç§è®¤è¯æ–¹å¼
2. **æƒé™ç®¡ç†**: ç»†ç²’åº¦æƒé™æ§åˆ¶
3. **æ•°æ®åŠ å¯†**: ä¼ è¾“åŠ å¯†å’Œå­˜å‚¨åŠ å¯†
4. **è¡Œçº§å®‰å…¨**: è¡Œçº§å®‰å…¨ç­–ç•¥
5. **å®¡è®¡æ—¥å¿—**: æ“ä½œå®¡è®¡

**åº”ç”¨åœºæ™¯**:

- **æ•°æ®å®‰å…¨**: ä¿æŠ¤æ•°æ®å®‰å…¨
- **è®¿é—®æ§åˆ¶**: æ§åˆ¶æ•°æ®è®¿é—®
- **åˆè§„è¦æ±‚**: æ»¡è¶³åˆè§„è¦æ±‚
- **å®¡è®¡è¿½è¸ª**: è¿½è¸ªæ“ä½œè®°å½•

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®å®‰å…¨** | å¤šå±‚å®‰å…¨ä¿æŠ¤ | **100%** |
| **è®¿é—®æ§åˆ¶** | ç»†ç²’åº¦æƒé™æ§åˆ¶ | **100%** |
| **åˆè§„æ€§** | æ»¡è¶³åˆè§„è¦æ±‚ | **100%** |
| **å®¡è®¡èƒ½åŠ›** | å®Œæ•´å®¡è®¡è¿½è¸ª | **100%** |

## 2. å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 å®‰å…¨ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((å®‰å…¨ä½“ç³»))
    èº«ä»½è®¤è¯
      å¯†ç è®¤è¯
        MD5
        SCRAM-SHA-256
        å¯†ç ç­–ç•¥
      SSL/TLS
        ä¼ è¾“åŠ å¯†
        è¯ä¹¦è®¤è¯
        åŒå‘è®¤è¯
      LDAPè®¤è¯
        LDAPé›†æˆ
        ä¼ä¸šè®¤è¯
        å•ç‚¹ç™»å½•
      Kerberosè®¤è¯
        Kerberosé›†æˆ
        ä¼ä¸šè®¤è¯
        å•ç‚¹ç™»å½•
      PAMè®¤è¯
        PAMé›†æˆ
        ç³»ç»Ÿè®¤è¯
        çµæ´»è®¤è¯
    æƒé™ç®¡ç†
      è§’è‰²ç®¡ç†
        è§’è‰²åˆ›å»º
        è§’è‰²ç»§æ‰¿
        è§’è‰²æƒé™
      å¯¹è±¡æƒé™
        SELECT
        INSERT
        UPDATE
        DELETE
        TRUNCATE
        REFERENCES
        TRIGGER
        CREATE
        CONNECT
        TEMPORARY
      æ¨¡å¼æƒé™
        æ¨¡å¼åˆ›å»º
        æ¨¡å¼ä½¿ç”¨
        æ¨¡å¼æƒé™
      æ•°æ®åº“æƒé™
        æ•°æ®åº“åˆ›å»º
        æ•°æ®åº“è¿æ¥
        æ•°æ®åº“æƒé™
    è¡Œçº§å®‰å…¨
      RLSç­–ç•¥
        è¡Œçº§ç­–ç•¥
        æ¡ä»¶è¿‡æ»¤
        åŠ¨æ€è¿‡æ»¤
      SELECTç­–ç•¥
        æŸ¥è¯¢è¿‡æ»¤
        æ•°æ®å¯è§æ€§
      INSERTç­–ç•¥
        æ’å…¥æ§åˆ¶
        æ•°æ®éªŒè¯
      UPDATEç­–ç•¥
        æ›´æ–°æ§åˆ¶
        æ•°æ®ä¿æŠ¤
      DELETEç­–ç•¥
        åˆ é™¤æ§åˆ¶
        æ•°æ®ä¿æŠ¤
    æ•°æ®åŠ å¯†
      ä¼ è¾“åŠ å¯†
        SSL/TLS
        è¯ä¹¦ç®¡ç†
        åŠ å¯†å¼ºåº¦
      å­˜å‚¨åŠ å¯†
        é€æ˜åŠ å¯†
        å­—æ®µåŠ å¯†
        å¯†é’¥ç®¡ç†
      pgcryptoæ‰©å±•
        å“ˆå¸Œå‡½æ•°
        åŠ å¯†å‡½æ•°
        ç­¾åå‡½æ•°
    å®¡è®¡æ—¥å¿—
      æ“ä½œå®¡è®¡
        ç™»å½•å®¡è®¡
        æ“ä½œå®¡è®¡
        é”™è¯¯å®¡è®¡
      pgAuditæ‰©å±•
        è¯¦ç»†å®¡è®¡
        åˆè§„å®¡è®¡
        æ€§èƒ½å®¡è®¡
    å®‰å…¨é…ç½®
      å¯†ç ç­–ç•¥
        å¯†ç å¤æ‚åº¦
        å¯†ç è¿‡æœŸ
        å¯†ç å†å²
      è¿æ¥é™åˆ¶
        max_connections
        è¿æ¥è¶…æ—¶
        IPé™åˆ¶
      å®‰å…¨å‚æ•°
        sslå‚æ•°
        åŠ å¯†å‚æ•°
        å®‰å…¨å‚æ•°
```

### 2.2 å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[å®‰å…¨éœ€æ±‚] --> B{è®¤è¯æ–¹å¼?}
    B -->|å¯†ç | C[SCRAM-SHA-256]
    B -->|è¯ä¹¦| D[SSL/TLS]
    B -->|ä¼ä¸š| E[LDAP/Kerberos]
    C --> F{æƒé™æ§åˆ¶?}
    D --> F
    E --> F
    F -->|å¯¹è±¡çº§| G[å¯¹è±¡æƒé™]
    F -->|è¡Œçº§| H[RLSç­–ç•¥]
    F -->|åˆ—çº§| I[åˆ—æƒé™]
    G --> J{æ•°æ®åŠ å¯†?}
    H --> J
    I --> J
    J -->|ä¼ è¾“| K[SSL/TLS]
    J -->|å­˜å‚¨| L[pgcrypto]
    K --> M{å®¡è®¡éœ€æ±‚?}
    L --> M
    M -->|æ˜¯| N[pgAudit]
    M -->|å¦| O[åŸºç¡€æ—¥å¿—]
    N --> P[å®‰å…¨é…ç½®å®Œæˆ]
    O --> P
```

## 3. å®‰å…¨æœºåˆ¶è¯¦è§£

### 3.1 èº«ä»½è®¤è¯æœºåˆ¶

**è®¤è¯æ–¹å¼å¯¹æ¯”**:

| è®¤è¯æ–¹å¼ | å®‰å…¨æ€§ | æ˜“ç”¨æ€§ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|--------|--------|---------|--------|
| **SCRAM-SHA-256** | â­â­â­â­â­ | â­â­â­â­ | é»˜è®¤æ¨è | â­â­â­â­â­ |
| **MD5** | â­â­ | â­â­â­â­â­ | å…¼å®¹æ—§ç³»ç»Ÿ | â­ |
| **SSL/TLS** | â­â­â­â­â­ | â­â­â­ | é«˜å®‰å…¨è¦æ±‚ | â­â­â­â­â­ |
| **LDAP** | â­â­â­â­ | â­â­â­ | ä¼ä¸šç¯å¢ƒ | â­â­â­â­ |
| **Kerberos** | â­â­â­â­â­ | â­â­ | ä¼ä¸šç¯å¢ƒ | â­â­â­ |

**è®¤è¯é…ç½®ç¤ºä¾‹**:

```sql
-- 1. åˆ›å»ºç”¨æˆ·ï¼ˆSCRAM-SHA-256ï¼‰
CREATE USER app_user WITH PASSWORD 'secure_password';

-- 2. é…ç½®SSLè®¤è¯
-- postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'

-- pg_hba.conf
hostssl    all    all    0.0.0.0/0    cert

-- 3. é…ç½®LDAPè®¤è¯
-- pg_hba.conf
host    all    all    0.0.0.0/0    ldap ldapserver=ldap.example.com ldapprefix="uid=" ldapsuffix=",ou=people,dc=example,dc=com"
```

### 3.2 æƒé™ç®¡ç†æœºåˆ¶

**æƒé™ç±»å‹å¯¹æ¯”**:

| æƒé™ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | é‡è¦æ€§ |
|---------|------|---------|--------|
| **SELECT** | æŸ¥è¯¢æƒé™ | åªè¯»è®¿é—® | â­â­â­â­â­ |
| **INSERT** | æ’å…¥æƒé™ | æ•°æ®å†™å…¥ | â­â­â­â­â­ |
| **UPDATE** | æ›´æ–°æƒé™ | æ•°æ®ä¿®æ”¹ | â­â­â­â­â­ |
| **DELETE** | åˆ é™¤æƒé™ | æ•°æ®åˆ é™¤ | â­â­â­â­â­ |
| **TRUNCATE** | æ¸…ç©ºæƒé™ | è¡¨æ¸…ç©º | â­â­â­ |
| **REFERENCES** | å¤–é”®æƒé™ | å¤–é”®çº¦æŸ | â­â­â­ |
| **TRIGGER** | è§¦å‘å™¨æƒé™ | è§¦å‘å™¨åˆ›å»º | â­â­â­ |
| **CREATE** | åˆ›å»ºæƒé™ | å¯¹è±¡åˆ›å»º | â­â­â­â­ |

**æƒé™ç®¡ç†ç¤ºä¾‹**:

```sql
-- 1. åˆ›å»ºè§’è‰²
CREATE ROLE app_readonly;
CREATE ROLE app_readwrite;
CREATE ROLE app_admin;

-- 2. æˆäºˆæƒé™
-- åªè¯»æƒé™
GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_readonly;
GRANT USAGE ON SCHEMA public TO app_readonly;

-- è¯»å†™æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_readwrite;
GRANT USAGE ON SCHEMA public TO app_readwrite;

-- ç®¡ç†å‘˜æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_admin;
GRANT ALL PRIVILEGES ON SCHEMA public TO app_admin;

-- 3. æˆäºˆè§’è‰²ç»™ç”¨æˆ·
GRANT app_readonly TO readonly_user;
GRANT app_readwrite TO readwrite_user;
GRANT app_admin TO admin_user;

-- 4. åˆ—çº§æƒé™
GRANT SELECT (id, name, email) ON users TO app_readonly;
GRANT SELECT, UPDATE (name, email) ON users TO app_readwrite;
```

### 3.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰æœºåˆ¶

**RLSç­–ç•¥ç±»å‹**:

| ç­–ç•¥ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½ |
|---------|------|---------|------|
| **SELECTç­–ç•¥** | æŸ¥è¯¢è¿‡æ»¤ | æ•°æ®å¯è§æ€§æ§åˆ¶ | â­â­â­â­ |
| **INSERTç­–ç•¥** | æ’å…¥æ§åˆ¶ | æ•°æ®æ’å…¥éªŒè¯ | â­â­â­â­ |
| **UPDATEç­–ç•¥** | æ›´æ–°æ§åˆ¶ | æ•°æ®æ›´æ–°éªŒè¯ | â­â­â­â­ |
| **DELETEç­–ç•¥** | åˆ é™¤æ§åˆ¶ | æ•°æ®åˆ é™¤éªŒè¯ | â­â­â­â­ |

**RLSé…ç½®ç¤ºä¾‹**:

```sql
-- 1. å¯ç”¨RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 2. åˆ›å»ºSELECTç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼‰
CREATE POLICY orders_select_policy ON orders
    FOR SELECT
    USING (user_id = current_user_id());

-- 3. åˆ›å»ºINSERTç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®¢å•ï¼‰
CREATE POLICY orders_insert_policy ON orders
    FOR INSERT
    WITH CHECK (user_id = current_user_id());

-- 4. åˆ›å»ºUPDATEç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è®¢å•ï¼‰
CREATE POLICY orders_update_policy ON orders
    FOR UPDATE
    USING (user_id = current_user_id())
    WITH CHECK (user_id = current_user_id());

-- 5. åˆ›å»ºDELETEç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è®¢å•ï¼‰
CREATE POLICY orders_delete_policy ON orders
    FOR DELETE
    USING (user_id = current_user_id());

-- 6. ç®¡ç†å‘˜ç­–ç•¥ï¼ˆç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®ï¼‰
CREATE POLICY orders_admin_policy ON orders
    FOR ALL
    TO admin_role
    USING (true)
    WITH CHECK (true);
```

### 3.4 æ•°æ®åŠ å¯†æœºåˆ¶

**åŠ å¯†æ–¹å¼å¯¹æ¯”**:

| åŠ å¯†æ–¹å¼ | ç±»å‹ | æ€§èƒ½ | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|--------|---------|
| **SSL/TLS** | ä¼ è¾“åŠ å¯† | â­â­â­â­ | â­â­â­â­â­ | ç½‘ç»œä¼ è¾“ |
| **pgcrypto** | å­˜å‚¨åŠ å¯† | â­â­â­ | â­â­â­â­â­ | æ•æ„Ÿæ•°æ® |
| **é€æ˜åŠ å¯†** | å­˜å‚¨åŠ å¯† | â­â­â­â­â­ | â­â­â­â­ | å…¨ç›˜åŠ å¯† |

**åŠ å¯†é…ç½®ç¤ºä¾‹**:

```sql
-- 1. å¯ç”¨SSL
-- postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'

-- 2. ä½¿ç”¨pgcryptoåŠ å¯†
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†æ•°æ®
INSERT INTO users (id, name, encrypted_email)
VALUES (1, 'John', pgp_sym_encrypt('john@example.com', 'encryption_key'));

-- è§£å¯†æ•°æ®
SELECT id, name, pgp_sym_decrypt(encrypted_email, 'encryption_key') AS email
FROM users;

-- 3. å“ˆå¸Œå¯†ç 
INSERT INTO users (id, username, password_hash)
VALUES (1, 'john', crypt('password123', gen_salt('bf')));

-- éªŒè¯å¯†ç 
SELECT * FROM users
WHERE username = 'john'
  AND password_hash = crypt('password123', password_hash);
```

### 3.5 å®¡è®¡æ—¥å¿—æœºåˆ¶

**å®¡è®¡é…ç½®ç¤ºä¾‹**:

```sql
-- 1. å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- 2. é…ç½®å®¡è®¡å‚æ•°
-- postgresql.conf
pgaudit.log = 'all'  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
pgaudit.log_catalog = off
pgaudit.log_parameter = on
pgaudit.log_statement_once = off
pgaudit.log_relation = on
pgaudit.log_rows = on

-- 3. å®¡è®¡ç‰¹å®šè¡¨
ALTER TABLE sensitive_data SET (pgaudit.log = 'all');

-- 4. æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM pg_stat_statements
WHERE query LIKE '%sensitive_data%';
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸSaaSå¹³å°éœ€è¦å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œå®‰å…¨æ§åˆ¶ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®éš”ç¦»**: éœ€è¦éš”ç¦»ä¸åŒç§Ÿæˆ·çš„æ•°æ®
2. **è®¿é—®æ§åˆ¶**: éœ€è¦æ§åˆ¶ç§Ÿæˆ·è®¿é—®æƒé™
3. **å®‰å…¨è¦æ±‚**: éœ€è¦æ»¡è¶³å®‰å…¨åˆè§„è¦æ±‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºæ•°æ®è¡¨ï¼ˆåŒ…å«tenant_idï¼‰
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id),
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10, 2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·è§’è‰²
CREATE ROLE tenant_user;
CREATE ROLE tenant_admin;

-- 4. åˆ›å»ºRLSç­–ç•¥
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- ç§Ÿæˆ·ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ•°æ®
CREATE POLICY orders_tenant_policy ON orders
    FOR ALL
    TO tenant_user
    USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER)
    WITH CHECK (tenant_id = current_setting('app.current_tenant_id')::INTEGER);

-- ç§Ÿæˆ·ç®¡ç†å‘˜å¯ä»¥è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ‰€æœ‰æ•°æ®
CREATE POLICY orders_tenant_admin_policy ON orders
    FOR ALL
    TO tenant_admin
    USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER)
    WITH CHECK (tenant_id = current_setting('app.current_tenant_id')::INTEGER);

-- 5. è®¾ç½®å½“å‰ç§Ÿæˆ·ï¼ˆåœ¨åº”ç”¨å±‚è®¾ç½®ï¼‰
SET app.current_tenant_id = '1';

-- 6. æˆäºˆæƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON orders TO tenant_user;
GRANT ALL PRIVILEGES ON orders TO tenant_admin;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®éš”ç¦»** | åº”ç”¨å±‚éš”ç¦» | **æ•°æ®åº“å±‚éš”ç¦»** | **100%** â¬†ï¸ |
| **å®‰å…¨æ€§** | ä¸­ç­‰ | **é«˜** | **æå‡** |
| **åˆè§„æ€§** | 60% | **100%** | **67%** â¬†ï¸ |

### 4.2 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦å®ç°é«˜å®‰å…¨çº§åˆ«çš„æ•°æ®ä¿æŠ¤ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. å¯ç”¨SSL
-- postgresql.conf
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'

-- 2. é…ç½®å¼ºåˆ¶SSLè¿æ¥
-- pg_hba.conf
hostssl    all    all    0.0.0.0/0    cert

-- 3. ä½¿ç”¨pgcryptoåŠ å¯†æ•æ„Ÿæ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    account_number TEXT NOT NULL,
    encrypted_balance BYTEA NOT NULL,  -- åŠ å¯†ä½™é¢
    encrypted_pii BYTEA NOT NULL,  -- åŠ å¯†ä¸ªäººä¿¡æ¯
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥åŠ å¯†æ•°æ®
INSERT INTO accounts (account_number, encrypted_balance, encrypted_pii)
VALUES (
    'ACC001',
    pgp_sym_encrypt('10000.00', 'encryption_key_balance'),
    pgp_sym_encrypt('{"name":"John","ssn":"123-45-6789"}', 'encryption_key_pii')
);

-- æŸ¥è¯¢è§£å¯†æ•°æ®
SELECT
    account_number,
    pgp_sym_decrypt(encrypted_balance, 'encryption_key_balance')::DECIMAL AS balance,
    pgp_sym_decrypt(encrypted_pii, 'encryption_key_pii')::JSONB AS pii
FROM accounts;

-- 4. å¯ç”¨å®¡è®¡æ—¥å¿—
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- postgresql.conf
pgaudit.log = 'all'
pgaudit.log_relation = on
pgaudit.log_rows = on

-- 5. è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;

CREATE POLICY accounts_access_policy ON accounts
    FOR ALL
    USING (
        -- åªæœ‰è´¦æˆ·æ‰€æœ‰è€…å¯ä»¥è®¿é—®
        account_number IN (
            SELECT account_number FROM user_accounts
            WHERE user_id = current_user_id()
        )
    );
```

## 5. æœ€ä½³å®è·µ

### 5.1 å®‰å…¨é…ç½®åŸåˆ™

1. **æœ€å°æƒé™**: æˆäºˆæœ€å°å¿…è¦æƒé™
2. **å¤šå±‚é˜²æŠ¤**: ä½¿ç”¨å¤šå±‚å®‰å…¨æœºåˆ¶
3. **å®šæœŸå®¡è®¡**: å®šæœŸå®¡è®¡å®‰å…¨é…ç½®
4. **åŠæ—¶æ›´æ–°**: åŠæ—¶æ›´æ–°å®‰å…¨è¡¥ä¸

### 5.2 å®‰å…¨å»ºè®®

1. **ä½¿ç”¨SCRAM-SHA-256**: ä½¿ç”¨å¼ºå¯†ç è®¤è¯
2. **å¯ç”¨SSL**: å¯ç”¨SSLä¼ è¾“åŠ å¯†
3. **ä½¿ç”¨RLS**: ä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
4. **å¯ç”¨å®¡è®¡**: å¯ç”¨å®¡è®¡æ—¥å¿—

## 6. å‚è€ƒèµ„æ–™

- [å®‰å…¨ä¸åŠ å¯†](./å®‰å…¨ä¸åŠ å¯†.md)
- [æƒé™ç®¡ç†](./æƒé™ç®¡ç†.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/current/security.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-57
