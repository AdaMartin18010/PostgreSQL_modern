# æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¶é—´**: 2025 å¹´ 12 æœˆ 4 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ with ProvSQL
> **æ–‡æ¡£ç¼–å·**: 07-SEC-PROVENANCE

---

## ğŸ“‘ ç›®å½•

- [æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—](#æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº](#11-ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº)
    - [1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ](#12-ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
    - [1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#14-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [äºŒã€åŸç†ä¸ç†è®º](#äºŒåŸç†ä¸ç†è®º)
    - [2.1 æ•°æ®æº¯æºç†è®º](#21-æ•°æ®æº¯æºç†è®º)
    - [2.2 æº¯æºæ¨¡å‹](#22-æº¯æºæ¨¡å‹)
    - [2.3 è¡€ç¼˜åˆ†æåŸç†](#23-è¡€ç¼˜åˆ†æåŸç†)
    - [2.4 å‰æ²¿ç ”ç©¶ ProvSQL](#24-å‰æ²¿ç ”ç©¶-provsql)
  - [ä¸‰ã€æ¶æ„è®¾è®¡](#ä¸‰æ¶æ„è®¾è®¡)
    - [3.1 æ•´ä½“æ¶æ„](#31-æ•´ä½“æ¶æ„)
    - [3.2 æº¯æºæ•°æ®å­˜å‚¨](#32-æº¯æºæ•°æ®å­˜å‚¨)
    - [3.3 è¡€ç¼˜è¿½è¸ªæœºåˆ¶](#33-è¡€ç¼˜è¿½è¸ªæœºåˆ¶)
    - [3.4 å¯è§†åŒ–ç³»ç»Ÿ](#34-å¯è§†åŒ–ç³»ç»Ÿ)
  - [å››ã€ç¨‹åºè®¾è®¡](#å››ç¨‹åºè®¾è®¡)
    - [4.1 ç¯å¢ƒå‡†å¤‡](#41-ç¯å¢ƒå‡†å¤‡)
    - [4.2 åŸºç¡€æº¯æºå®ç°](#42-åŸºç¡€æº¯æºå®ç°)
    - [4.3 ProvSQLé›†æˆ](#43-provsqlé›†æˆ)
    - [4.4 è¡€ç¼˜åˆ†æå·¥å…·](#44-è¡€ç¼˜åˆ†æå·¥å…·)
  - [äº”ã€è¿ç»´ç®¡ç†](#äº”è¿ç»´ç®¡ç†)
    - [5.1 æ€§èƒ½ä¼˜åŒ–](#51-æ€§èƒ½ä¼˜åŒ–)
    - [5.2 å­˜å‚¨ç®¡ç†](#52-å­˜å‚¨ç®¡ç†)
    - [5.3 å¯è§†åŒ–ä¸æŠ¥è¡¨](#53-å¯è§†åŒ–ä¸æŠ¥è¡¨)
    - [5.4 æœ€ä½³å®è·µ](#54-æœ€ä½³å®è·µ)
  - [å…­ã€æ¡ˆä¾‹å®æˆ˜](#å…­æ¡ˆä¾‹å®æˆ˜)
    - [6.1 æ•°æ®è´¨é‡è¿½è¸ª](#61-æ•°æ®è´¨é‡è¿½è¸ª)
    - [6.2 åˆè§„æ€§å®¡è®¡](#62-åˆè§„æ€§å®¡è®¡)
    - [6.3 å½±å“åˆ†æ](#63-å½±å“åˆ†æ)
  - [ä¸ƒã€æ€»ç»“ä¸å±•æœ›](#ä¸ƒæ€»ç»“ä¸å±•æœ›)
  - [å…«ã€å‚è€ƒèµ„æ–™](#å…«å‚è€ƒèµ„æ–™)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº

**æ•°æ®æº¯æº**ï¼ˆData Provenanceï¼‰æ˜¯è®°å½•æ•°æ®çš„æ¥æºã€å†å²å’Œè½¬æ¢è¿‡ç¨‹çš„æŠ€æœ¯ï¼Œå›ç­”"è¿™ä¸ªæ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿç»è¿‡äº†ä»€ä¹ˆå¤„ç†ï¼Ÿ"

**æ ¸å¿ƒé—®é¢˜**ï¼š
- ğŸ“ **Where**: æ•°æ®æ¥è‡ªå“ªä¸ªæºç³»ç»Ÿï¼Ÿ
- ğŸ• **When**: æ•°æ®åœ¨ä»€ä¹ˆæ—¶é—´äº§ç”Ÿï¼Ÿ
- ğŸ‘¤ **Who**: è°åˆ›å»ºæˆ–ä¿®æ”¹äº†æ•°æ®ï¼Ÿ
- ğŸ”§ **How**: æ•°æ®ç»è¿‡äº†ä»€ä¹ˆè½¬æ¢ï¼Ÿ
- ğŸ¯ **Why**: æ•°æ®ä¸ºä»€ä¹ˆå˜åŒ–ï¼Ÿ

**ç¤ºä¾‹**ï¼š

```text
æ•°æ®è¡€ç¼˜å›¾ï¼š
-----------
[æºè¡¨A] â”€â”
         â”œâ”€â†’ [ETLè½¬æ¢1] â”€â†’ [ä¸­é—´è¡¨B] â”€â†’ [èšåˆè®¡ç®—] â”€â†’ [æŠ¥è¡¨C]
[æºè¡¨D] â”€â”˜                    â†“
                        [æ•°æ®è´¨é‡æ£€æŸ¥]

æº¯æºæŸ¥è¯¢ï¼š
---------
æŠ¥è¡¨Cä¸­çš„æŸä¸ªå€¼ â†’ è¿½æº¯åˆ°
  - ä¸­é—´è¡¨Bçš„ç¬¬123è¡Œ
  - æ¥è‡ªæºè¡¨Açš„ç¬¬456è¡Œå’Œæºè¡¨Dçš„ç¬¬789è¡Œ
  - ç»è¿‡ETLè½¬æ¢1ï¼ˆè¿æ¥ã€è¿‡æ»¤ã€èšåˆï¼‰
  - ç”±ç”¨æˆ·Johnåœ¨2024-12-01 10:30:00æ‰§è¡Œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

| åœºæ™¯ | éœ€æ±‚ | ä»·å€¼ |
|------|------|------|
| **æ•°æ®è´¨é‡** | è¿½è¸ªé”™è¯¯æ•°æ®çš„æ¥æº | å¿«é€Ÿå®šä½é—®é¢˜æ ¹å›  |
| **åˆè§„æ€§** | è¯æ˜æ•°æ®å¤„ç†è¿‡ç¨‹ | GDPR "è¢«é—å¿˜æƒ" |
| **å½±å“åˆ†æ** | è¯„ä¼°è¡¨ç»“æ„å˜æ›´å½±å“ | é™ä½å˜æ›´é£é™© |
| **å®¡è®¡è¿½è¸ª** | è®°å½•æ•°æ®è®¿é—®å†å² | æ»¡è¶³å®¡è®¡è¦æ±‚ |
| **æ•°æ®æ²»ç†** | ç†è§£æ•°æ®æµè½¬ | ä¼˜åŒ–æ•°æ®æ¶æ„ |
| **è°ƒè¯•åˆ†æ** | è¿½è¸ªè®¡ç®—è¿‡ç¨‹ | æå‡å¼€å‘æ•ˆç‡ |

### 1.3 æ ¸å¿ƒä»·å€¼

**æŠ€æœ¯ä»·å€¼**ï¼š
- ğŸ¯ **å¯è¿½æº¯æ€§**: ä»»ä½•æ•°æ®éƒ½èƒ½è¿½æº¯åˆ°æºå¤´
- ğŸ” **é€æ˜æ€§**: æ•°æ®å¤„ç†è¿‡ç¨‹å®Œå…¨é€æ˜
- ğŸ›¡ï¸ **å¯å®¡è®¡æ€§**: æ»¡è¶³åˆè§„æ€§è¦æ±‚
- ğŸ“Š **å¯è§†åŒ–**: ç›´è§‚å±•ç¤ºæ•°æ®æµè½¬

**ä¸šåŠ¡ä»·å€¼**ï¼š
- ğŸ’° **é™ä½é£é™©**: å¿«é€Ÿå®šä½æ•°æ®é—®é¢˜
- ğŸš€ **æå‡æ•ˆç‡**: åŠ é€Ÿé—®é¢˜è¯Šæ–­
- ğŸ” **æ»¡è¶³åˆè§„**: GDPRã€SOXã€HIPAA
- ğŸ“ˆ **ä¼˜åŒ–æ²»ç†**: æ•°æ®æ¶æ„ä¼˜åŒ–ä¾æ®

### 1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®æº¯æºä¸è¡€ç¼˜))
    åŸç†ä¸ç†è®º
      æº¯æºç†è®º
        Whyæº¯æº
        Whereæº¯æº
        Howæº¯æº
      æº¯æºæ¨¡å‹
        PROV-DM
        Open Provenance
        W3Cæ ‡å‡†
      è¡€ç¼˜åˆ†æ
        è¡¨çº§è¡€ç¼˜
        å­—æ®µçº§è¡€ç¼˜
        è®¡ç®—è¡€ç¼˜
      ProvSQL
        åŠç¯è¯­ä¹‰
        æ¦‚ç‡æº¯æº
        whyæº¯æº
    æ¶æ„è®¾è®¡
      æ•´ä½“æ¶æ„
        æ•è·å±‚
        å­˜å‚¨å±‚
        æŸ¥è¯¢å±‚
        å¯è§†åŒ–å±‚
      å­˜å‚¨è®¾è®¡
        æº¯æºè¡¨
        è¡€ç¼˜å›¾
        å…ƒæ•°æ®
      è¿½è¸ªæœºåˆ¶
        è§¦å‘å™¨
        æ—¥å¿—è§£æ
        Hookæœºåˆ¶
      å¯è§†åŒ–
        è¡€ç¼˜å›¾
        ä¾èµ–å…³ç³»
        å½±å“åˆ†æ
    ç¨‹åºè®¾è®¡
      åŸºç¡€å®ç°
        è§¦å‘å™¨æº¯æº
        æ—¥å¿—æº¯æº
        åº”ç”¨å±‚æº¯æº
      ProvSQLé›†æˆ
        å®‰è£…é…ç½®
        æº¯æºæŸ¥è¯¢
        æ¦‚ç‡è®¡ç®—
      è¡€ç¼˜å·¥å…·
        è§£æå™¨
        å›¾æ„å»º
        æŸ¥è¯¢API
      å¯è§†åŒ–
        D3.js
        GraphViz
        Neo4j Browser
    è¿ç»´ç®¡ç†
      æ€§èƒ½ä¼˜åŒ–
        æº¯æºå¼€é”€
        å­˜å‚¨å‹ç¼©
        æŸ¥è¯¢ä¼˜åŒ–
      å­˜å‚¨ç®¡ç†
        æ¸…ç†ç­–ç•¥
        å½’æ¡£æ–¹æ¡ˆ
        å‹ç¼©å­˜å‚¨
      ç›‘æ§æŠ¥è¡¨
        æº¯æºç»Ÿè®¡
        ä½¿ç”¨åˆ†æ
        åˆè§„æŠ¥å‘Š
    æ¡ˆä¾‹å®æˆ˜
      è´¨é‡è¿½è¸ª
        é”™è¯¯å®šä½
        æ ¹å› åˆ†æ
        ä¿®å¤éªŒè¯
      åˆè§„å®¡è®¡
        GDPR
        æ•°æ®è®¿é—®è®°å½•
        å˜æ›´è¿½è¸ª
      å½±å“åˆ†æ
        è¡¨å˜æ›´å½±å“
        å­—æ®µä¾èµ–
        ä¸‹æ¸¸å½±å“
```

---

## äºŒã€åŸç†ä¸ç†è®º

### 2.1 æ•°æ®æº¯æºç†è®º

#### **æº¯æºçš„ä¸‰ç§ç±»å‹**

**1. Why-Provenanceï¼ˆä¸ºä»€ä¹ˆæº¯æºï¼‰**

```sql
-- æŸ¥è¯¢ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªç»“æœåœ¨ç»“æœé›†ä¸­ï¼Ÿ
SELECT * FROM orders WHERE amount > 1000;

-- ç»“æœï¼šè®¢å•ID=123
-- Whyæº¯æºï¼šå› ä¸ºè®¢å•123çš„amount=1500ï¼Œæ»¡è¶³amount > 1000

-- æ•°å­¦è¡¨ç¤ºï¼š
-- å¦‚æœ tuple t âˆˆ Q(D)ï¼Œé‚£ä¹ˆ why(t) = å¯¼è‡´tå‡ºç°çš„æ‰€æœ‰è¾“å…¥å…ƒç»„é›†åˆ
```

**2. Where-Provenanceï¼ˆå“ªé‡Œæº¯æºï¼‰**

```sql
-- æŸ¥è¯¢ï¼šç»“æœä¸­çš„æ¯ä¸ªå€¼æ¥è‡ªå“ªé‡Œï¼Ÿ
SELECT user_name, order_total FROM users u JOIN orders o ON u.id = o.user_id;

-- ç»“æœï¼š('Alice', 1500)
-- Whereæº¯æºï¼š
--   'Alice' æ¥è‡ª usersè¡¨ç¬¬3è¡Œçš„nameåˆ—
--   1500 æ¥è‡ª ordersè¡¨ç¬¬5è¡Œçš„totalåˆ—
```

**3. How-Provenanceï¼ˆå¦‚ä½•æº¯æºï¼‰**

```sql
-- æŸ¥è¯¢ï¼šç»“æœæ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„ï¼Ÿ
SELECT user_id, SUM(amount) FROM orders GROUP BY user_id;

-- ç»“æœï¼š(1, 3500)
-- Howæº¯æºï¼š3500 = 1000 + 1500 + 1000
--   æ¥è‡ªè®¢å•ID: 101, 102, 103
```

### 2.2 æº¯æºæ¨¡å‹

#### **PROV-DMï¼ˆW3Cæ ‡å‡†ï¼‰**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PROV-DM æ ¸å¿ƒæ¦‚å¿µ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  å®ä½“ (Entity)                            â”‚
â”‚    - æ•°æ®ã€æ–‡æ¡£ã€è¡¨                       â”‚
â”‚                                            â”‚
â”‚  æ´»åŠ¨ (Activity)                          â”‚
â”‚    - æŸ¥è¯¢ã€è½¬æ¢ã€è®¡ç®—                     â”‚
â”‚                                            â”‚
â”‚  ä»£ç† (Agent)                             â”‚
â”‚    - ç”¨æˆ·ã€ç¨‹åºã€ç³»ç»Ÿ                     â”‚
â”‚                                            â”‚
â”‚  å…³ç³» (Relations)                         â”‚
â”‚    - wasGeneratedBy: å®ä½“ç”±æ´»åŠ¨ç”Ÿæˆ       â”‚
â”‚    - used: æ´»åŠ¨ä½¿ç”¨äº†å®ä½“                 â”‚
â”‚    - wasAttributedTo: å®ä½“å½’å±äºä»£ç†      â”‚
â”‚    - wasDerivedFrom: å®ä½“æ´¾ç”Ÿè‡ªå®ä½“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PostgreSQLå®ç°**ï¼š

```sql
-- PROV-DMæ•°æ®æ¨¡å‹
CREATE TABLE prov_entities (
    entity_id SERIAL PRIMARY KEY,
    entity_type VARCHAR(50),  -- 'table', 'row', 'column'
    entity_name TEXT,
    attributes JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE prov_activities (
    activity_id SERIAL PRIMARY KEY,
    activity_type VARCHAR(50),  -- 'SELECT', 'INSERT', 'UPDATE', 'DELETE'
    description TEXT,
    started_at TIMESTAMPTZ,
    ended_at TIMESTAMPTZ
);

CREATE TABLE prov_agents (
    agent_id SERIAL PRIMARY KEY,
    agent_type VARCHAR(50),  -- 'user', 'application', 'system'
    agent_name VARCHAR(100),
    metadata JSONB
);

-- å…³ç³»è¡¨
CREATE TABLE prov_was_generated_by (
    entity_id INT REFERENCES prov_entities(entity_id),
    activity_id INT REFERENCES prov_activities(activity_id),
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (entity_id, activity_id)
);

CREATE TABLE prov_used (
    activity_id INT REFERENCES prov_activities(activity_id),
    entity_id INT REFERENCES prov_entities(entity_id),
    used_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (activity_id, entity_id)
);

CREATE TABLE prov_was_attributed_to (
    entity_id INT REFERENCES prov_entities(entity_id),
    agent_id INT REFERENCES prov_agents(agent_id),
    attributed_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (entity_id, agent_id)
);

CREATE TABLE prov_was_derived_from (
    derived_entity_id INT REFERENCES prov_entities(entity_id),
    source_entity_id INT REFERENCES prov_entities(entity_id),
    derivation_type VARCHAR(50),  -- 'join', 'filter', 'aggregate'
    PRIMARY KEY (derived_entity_id, source_entity_id)
);
```

### 2.3 è¡€ç¼˜åˆ†æåŸç†

#### **è¡€ç¼˜ç±»å‹**

**1. è¡¨çº§è¡€ç¼˜**

```sql
-- æŸ¥è¯¢è¡¨ä¹‹é—´çš„ä¾èµ–å…³ç³»
WITH RECURSIVE table_lineage AS (
    -- èµ·ç‚¹ï¼šç›®æ ‡è¡¨
    SELECT
        target_table AS table_name,
        0 AS level,
        ARRAY[target_table] AS path
    FROM table_dependencies
    WHERE target_table = 'sales_report'

    UNION

    -- é€’å½’ï¼šä¸Šæ¸¸è¡¨
    SELECT
        td.source_table,
        tl.level + 1,
        tl.path || td.source_table
    FROM table_dependencies td
    JOIN table_lineage tl ON td.target_table = tl.table_name
    WHERE td.source_table != ALL(tl.path)  -- é¿å…å¾ªç¯
      AND tl.level < 10
)
SELECT * FROM table_lineage
ORDER BY level;

-- ç»“æœï¼š
-- sales_report (level 0)
--   â”œâ”€ sales_fact (level 1)
--   â”‚   â”œâ”€ orders (level 2)
--   â”‚   â””â”€ products (level 2)
--   â””â”€ customers (level 1)
```

**2. å­—æ®µçº§è¡€ç¼˜**

```sql
-- è¿½è¸ªå­—æ®µçš„æ•°æ®æ¥æº
CREATE TABLE column_lineage (
    target_table VARCHAR(100),
    target_column VARCHAR(100),
    source_table VARCHAR(100),
    source_column VARCHAR(100),
    transformation TEXT,  -- SQLè¡¨è¾¾å¼
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç¤ºä¾‹ï¼šsales_report.total_amountçš„è¡€ç¼˜
INSERT INTO column_lineage VALUES
('sales_report', 'total_amount', 'orders', 'amount', 'SUM(amount)', NOW()),
('sales_report', 'total_amount', 'order_items', 'quantity', 'SUM(quantity * price)', NOW());
```

**3. è¡Œçº§è¡€ç¼˜**

```sql
-- è¿½è¸ªæ¯ä¸€è¡Œæ•°æ®çš„æ¥æº
CREATE TABLE row_provenance (
    target_table VARCHAR(100),
    target_row_id BIGINT,
    source_table VARCHAR(100),
    source_row_id BIGINT,
    operation VARCHAR(50),  -- 'join', 'filter', 'aggregate'
    timestamp TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.4 å‰æ²¿ç ”ç©¶ ProvSQL

**è®ºæ–‡**: *ProvSQL: Provenance and Probability Management in PostgreSQL* (arXiv:2504.12058)

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ¯ **åŠç¯æº¯æº**: ä½¿ç”¨åŠç¯ä»£æ•°è¿½è¸ªæ•°æ®æ¥æº
- ğŸ¯ **æ¦‚ç‡æº¯æº**: æ”¯æŒä¸ç¡®å®šæ•°æ®çš„æº¯æº
- ğŸ¯ **Whyæº¯æº**: è§£é‡Šä¸ºä»€ä¹ˆæŸä¸ªå…ƒç»„åœ¨ç»“æœä¸­

**å®‰è£…ProvSQL**ï¼š

```bash
# ç¼–è¯‘å®‰è£…ï¼ˆéœ€è¦PostgreSQLæºç ï¼‰
git clone https://github.com/PierreSenellart/provsql.git
cd provsql
make
sudo make install
```

```sql
-- å¯ç”¨ProvSQL
CREATE EXTENSION provsql;

-- ä¸ºè¡¨å¯ç”¨æº¯æº
SELECT provsql.add_provenance('users');
SELECT provsql.add_provenance('orders');

-- æ‰§è¡ŒæŸ¥è¯¢å¹¶è·å–æº¯æº
SELECT *, provenance() AS prov
FROM users u
JOIN orders o ON u.user_id = o.user_id
WHERE o.amount > 1000;

-- æŸ¥è¯¢æº¯æºä¿¡æ¯
SELECT provsql.where_provenance(prov) FROM results;
```

---

## ä¸‰ã€æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

**è¯¦ç»†æ¶æ„è§å®Œæ•´æ–‡æ¡£...**

### 3.2 æº¯æºæ•°æ®å­˜å‚¨

**è¯¦ç»†è®¾è®¡è§å®Œæ•´æ–‡æ¡£...**

### 3.3 è¡€ç¼˜è¿½è¸ªæœºåˆ¶

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 3.4 å¯è§†åŒ–ç³»ç»Ÿ

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

---

## å››ã€ç¨‹åºè®¾è®¡

### 4.1 ç¯å¢ƒå‡†å¤‡

**è¯¦ç»†æ­¥éª¤è§å®Œæ•´æ–‡æ¡£...**

### 4.2 åŸºç¡€æº¯æºå®ç°

```python
# provenance_tracker.py
import psycopg2
from datetime import datetime
import json

class ProvenanceTracker:
    """æ•°æ®æº¯æºè¿½è¸ªå™¨"""

    def __init__(self, conn):
        self.conn = conn
        self._ensure_provenance_tables()

    def _ensure_provenance_tables(self):
        """ç¡®ä¿æº¯æºè¡¨å­˜åœ¨"""
        with self.conn.cursor() as cur:
            # åˆ›å»ºæº¯æºè¡¨ï¼ˆå¦‚å‰é¢PROV-DMæ¨¡å‹ï¼‰
            cur.execute("""
                CREATE TABLE IF NOT EXISTS data_lineage (
                    lineage_id SERIAL PRIMARY KEY,
                    source_table VARCHAR(100),
                    source_row_id BIGINT,
                    target_table VARCHAR(100),
                    target_row_id BIGINT,
                    operation VARCHAR(50),
                    sql_query TEXT,
                    executed_by VARCHAR(100),
                    executed_at TIMESTAMPTZ DEFAULT NOW()
                );
            """)
            self.conn.commit()

    def track_insert(
        self,
        target_table: str,
        target_row_id: int,
        source_info: dict,
        executed_by: str
    ):
        """è¿½è¸ªINSERTæ“ä½œ"""
        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO data_lineage
                (source_table, source_row_id, target_table, target_row_id,
                 operation, executed_by)
                VALUES (%s, %s, %s, %s, 'INSERT', %s)
            """, (
                source_info.get('table'),
                source_info.get('row_id'),
                target_table,
                target_row_id,
                executed_by
            ))
        self.conn.commit()

    def track_update(
        self,
        table: str,
        row_id: int,
        old_values: dict,
        new_values: dict,
        executed_by: str
    ):
        """è¿½è¸ªUPDATEæ“ä½œ"""
        lineage_record = {
            'table': table,
            'row_id': row_id,
            'old_values': old_values,
            'new_values': new_values,
            'executed_by': executed_by,
            'timestamp': datetime.now().isoformat()
        }

        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO data_lineage
                (target_table, target_row_id, operation, sql_query, executed_by)
                VALUES (%s, %s, 'UPDATE', %s, %s)
            """, (table, row_id, json.dumps(lineage_record), executed_by))
        self.conn.commit()

    def query_lineage(self, table: str, row_id: int):
        """æŸ¥è¯¢æ•°æ®è¡€ç¼˜"""
        with self.conn.cursor() as cur:
            cur.execute("""
                WITH RECURSIVE lineage AS (
                    -- èµ·ç‚¹
                    SELECT
                        lineage_id,
                        source_table,
                        source_row_id,
                        target_table,
                        target_row_id,
                        operation,
                        executed_by,
                        executed_at,
                        1 AS level,
                        ARRAY[lineage_id] AS path
                    FROM data_lineage
                    WHERE target_table = %s AND target_row_id = %s

                    UNION

                    -- é€’å½’ï¼šè¿½æº¯ä¸Šæ¸¸
                    SELECT
                        dl.lineage_id,
                        dl.source_table,
                        dl.source_row_id,
                        dl.target_table,
                        dl.target_row_id,
                        dl.operation,
                        dl.executed_by,
                        dl.executed_at,
                        l.level + 1,
                        l.path || dl.lineage_id
                    FROM data_lineage dl
                    JOIN lineage l ON dl.target_table = l.source_table
                                   AND dl.target_row_id = l.source_row_id
                    WHERE NOT (dl.lineage_id = ANY(l.path))
                      AND l.level < 10
                )
                SELECT * FROM lineage ORDER BY level;
            """, (table, row_id))

            return cur.fetchall()
```

### 4.3 ProvSQLé›†æˆ

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 4.4 è¡€ç¼˜åˆ†æå·¥å…·

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

---

## äº”ã€è¿ç»´ç®¡ç†

### 5.1 æ€§èƒ½ä¼˜åŒ–

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.2 å­˜å‚¨ç®¡ç†

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.3 å¯è§†åŒ–ä¸æŠ¥è¡¨

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.4 æœ€ä½³å®è·µ

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

---

## å…­ã€æ¡ˆä¾‹å®æˆ˜

### 6.1 æ•°æ®è´¨é‡è¿½è¸ª

**åœºæ™¯**: å‘ç°æŠ¥è¡¨æ•°æ®å¼‚å¸¸ï¼Œè¿½è¸ªé”™è¯¯æ¥æº

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 6.2 åˆè§„æ€§å®¡è®¡

**åœºæ™¯**: GDPRåˆè§„ï¼Œè¿½è¸ªä¸ªäººæ•°æ®å¤„ç†

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 6.3 å½±å“åˆ†æ

**åœºæ™¯**: è¯„ä¼°è¡¨ç»“æ„å˜æ›´çš„å½±å“èŒƒå›´

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

---

## ä¸ƒã€æ€»ç»“ä¸å±•æœ›

### æ ¸å¿ƒæ”¶è·

1. âœ… æ•°æ®æº¯æºæä¾›å®Œæ•´çš„æ•°æ®è¿½è¸ªèƒ½åŠ›
2. âœ… è¡€ç¼˜åˆ†æå¸®åŠ©ç†è§£æ•°æ®æµè½¬
3. âœ… ProvSQLæä¾›æ ‡å‡†åŒ–æº¯æºæ–¹æ¡ˆ
4. âœ… æ»¡è¶³åˆè§„æ€§å’Œå®¡è®¡è¦æ±‚

### é€‚ç”¨åœºæ™¯

- âœ… æ•°æ®è´¨é‡ç®¡ç†
- âœ… åˆè§„æ€§å®¡è®¡
- âœ… å½±å“åˆ†æ
- âœ… æ•°æ®æ²»ç†

---

## å…«ã€å‚è€ƒèµ„æ–™

1. **ProvSQL**: [https://github.com/PierreSenellart/provsql](https://github.com/PierreSenellart/provsql)
2. **W3C PROV**: [https://www.w3.org/TR/prov-dm/](https://www.w3.org/TR/prov-dm/)
3. **è®ºæ–‡**: ProvSQL: Provenance and Probability Management (arXiv:2504.12058)

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ4æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 07-SEC-PROVENANCE
**ç‰ˆæœ¬**: v1.0
