# PostgreSQL 17 é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-03

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 å¯¹é€»è¾‘å¤åˆ¶è¿›è¡Œäº†é‡å¤§æ€§èƒ½ä¼˜åŒ–ï¼ŒåŒ…æ‹¬å¹¶è¡Œåº”ç”¨ã€æ‰¹é‡æäº¤ã€æµå¼ä¼ è¾“ç­‰æ”¹è¿›ï¼Œ
æ˜¾è‘—æå‡äº†é€»è¾‘å¤åˆ¶çš„ååé‡å’Œå»¶è¿Ÿæ€§èƒ½ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»è¿™äº›ä¼˜åŒ–ç‰¹æ€§å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¹¶è¡Œåº”ç”¨**ï¼šæ”¯æŒå¹¶è¡Œåº”ç”¨äº‹åŠ¡ï¼Œå¤§å¹…æå‡å¤åˆ¶æ€§èƒ½
- **æ‰¹é‡æäº¤**ï¼šæ‰¹é‡æäº¤äº‹åŠ¡ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”å’Œé”ç«äº‰
- **æµå¼ä¼ è¾“**ï¼šæµå¼ä¼ è¾“å˜æ›´ï¼Œé™ä½å¤åˆ¶å»¶è¿Ÿ
- **æ€§èƒ½æå‡**ï¼šç›¸æ¯” PostgreSQL 16ï¼Œæ€§èƒ½æå‡ 2-5 å€
- **ç”Ÿäº§å°±ç»ª**ï¼šç¨³å®šå¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒå¤§è§„æ¨¡ä½¿ç”¨

## ğŸ“š ç›®å½•

- [PostgreSQL 17 é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–](#postgresql-17-é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
    - [1.0 é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–å·¥ä½œåŸç†æ¦‚è¿°](#10-é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 PostgreSQL 17 ä¼˜åŒ–äº®ç‚¹](#11-postgresql-17-ä¼˜åŒ–äº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. å¹¶è¡Œåº”ç”¨ä¼˜åŒ–](#2-å¹¶è¡Œåº”ç”¨ä¼˜åŒ–)
    - [2.0 å¹¶è¡Œåº”ç”¨å·¥ä½œåŸç†æ¦‚è¿°](#20-å¹¶è¡Œåº”ç”¨å·¥ä½œåŸç†æ¦‚è¿°)
    - [2.1 å¹¶è¡Œåº”ç”¨åŸç†](#21-å¹¶è¡Œåº”ç”¨åŸç†)
    - [2.2 å¯ç”¨å¹¶è¡Œåº”ç”¨](#22-å¯ç”¨å¹¶è¡Œåº”ç”¨)
    - [2.3 å¹¶è¡Œåº”ç”¨é…ç½®](#23-å¹¶è¡Œåº”ç”¨é…ç½®)
    - [2.4 å¹¶è¡Œåº”ç”¨é™åˆ¶](#24-å¹¶è¡Œåº”ç”¨é™åˆ¶)
  - [3. æ‰¹é‡æäº¤ä¼˜åŒ–](#3-æ‰¹é‡æäº¤ä¼˜åŒ–)
    - [3.1 æ‰¹é‡æäº¤åŸç†](#31-æ‰¹é‡æäº¤åŸç†)
    - [3.2 é…ç½®æ‰¹é‡æäº¤](#32-é…ç½®æ‰¹é‡æäº¤)
    - [3.3 æ‰¹é‡æäº¤å‚æ•°](#33-æ‰¹é‡æäº¤å‚æ•°)
    - [3.4 æ‰¹é‡æäº¤ä¼˜åŒ–å»ºè®®](#34-æ‰¹é‡æäº¤ä¼˜åŒ–å»ºè®®)
  - [4. æµå¼ä¼ è¾“ä¼˜åŒ–](#4-æµå¼ä¼ è¾“ä¼˜åŒ–)
    - [4.1 æµå¼ä¼ è¾“åŸç†](#41-æµå¼ä¼ è¾“åŸç†)
    - [4.2 å¯ç”¨æµå¼ä¼ è¾“](#42-å¯ç”¨æµå¼ä¼ è¾“)
    - [4.3 æµå¼ä¼ è¾“æ¨¡å¼](#43-æµå¼ä¼ è¾“æ¨¡å¼)
    - [4.4 æµå¼ä¼ è¾“é…ç½®](#44-æµå¼ä¼ è¾“é…ç½®)
  - [5. é…ç½®å‚æ•°è°ƒä¼˜](#5-é…ç½®å‚æ•°è°ƒä¼˜)
    - [5.1 å‘å¸ƒç«¯å‚æ•°](#51-å‘å¸ƒç«¯å‚æ•°)
    - [5.2 è®¢é˜…ç«¯å‚æ•°](#52-è®¢é˜…ç«¯å‚æ•°)
    - [5.3 è®¢é˜…å‚æ•°](#53-è®¢é˜…å‚æ•°)
  - [6. æ€§èƒ½ç›‘æ§](#6-æ€§èƒ½ç›‘æ§)
    - [6.1 ç›‘æ§å¤åˆ¶å»¶è¿Ÿ](#61-ç›‘æ§å¤åˆ¶å»¶è¿Ÿ)
    - [6.2 ç›‘æ§å·¥ä½œè¿›ç¨‹](#62-ç›‘æ§å·¥ä½œè¿›ç¨‹)
    - [6.3 ç›‘æ§æ€§èƒ½æŒ‡æ ‡](#63-ç›‘æ§æ€§èƒ½æŒ‡æ ‡)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#71-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.2 é…ç½®å»ºè®®](#72-é…ç½®å»ºè®®)
    - [7.3 æ•…éšœå¤„ç†](#73-æ•…éšœå¤„ç†)
  - [8. å®é™…æ¡ˆä¾‹](#8-å®é™…æ¡ˆä¾‹)
    - [8.1 æ¡ˆä¾‹ï¼šç”µå•†è®¢å•ç³»ç»Ÿå¤åˆ¶](#81-æ¡ˆä¾‹ç”µå•†è®¢å•ç³»ç»Ÿå¤åˆ¶)
    - [8.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿæ•°æ®åŒæ­¥](#82-æ¡ˆä¾‹å¤šç§Ÿæˆ·ç³»ç»Ÿæ•°æ®åŒæ­¥)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°

### 1.0 é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–å·¥ä½œåŸç†æ¦‚è¿°

**é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–çš„æœ¬è´¨**ï¼š

PostgreSQL 17 çš„é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–åŸºäºå¹¶è¡Œå¤„ç†ã€æ‰¹é‡æ“ä½œå’Œæµå¼ä¼ è¾“æœºåˆ¶ã€‚
é€»è¾‘å¤åˆ¶æ˜¯æ•°æ®åº“é«˜å¯ç”¨å’Œæ•°æ®åˆ†å‘çš„é‡è¦æŠ€æœ¯ï¼Œé€šè¿‡ä¼˜åŒ–å¤åˆ¶æµç¨‹ã€å‡å°‘ç½‘ç»œå¾€è¿”ã€å¹¶è¡Œå¤„ç†äº‹åŠ¡ï¼Œå¯ä»¥æ˜¾è‘—æå‡å¤åˆ¶ååé‡å’Œé™ä½å»¶è¿Ÿã€‚
PostgreSQL 17 é€šè¿‡å¹¶è¡Œåº”ç”¨ã€æ‰¹é‡æäº¤ã€æµå¼ä¼ è¾“ç­‰ä¼˜åŒ–ï¼Œæ˜¾è‘—æå‡äº†é€»è¾‘å¤åˆ¶çš„æ€§èƒ½ã€‚

**é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[ä¸»åº“äº‹åŠ¡æäº¤] --> B[WAL æ—¥å¿—å†™å…¥]
    B --> C[é€»è¾‘è§£ç ]
    C --> D{ä¼˜åŒ–ç­–ç•¥}
    D -->|å¹¶è¡Œåº”ç”¨| E[äº‹åŠ¡ä¾èµ–æ£€æµ‹]
    D -->|æ‰¹é‡æäº¤| F[æ‰¹é‡æ”¶é›†äº‹åŠ¡]
    D -->|æµå¼ä¼ è¾“| G[æµå¼ä¼ è¾“å˜æ›´]
    E --> H[å¹¶è¡Œåº”ç”¨å·¥ä½œè¿›ç¨‹]
    F --> I[æ‰¹é‡æäº¤]
    G --> J[å®æ—¶ä¼ è¾“]
    H --> K[åº”ç”¨äº‹åŠ¡]
    I --> K
    J --> K
    K --> L[æäº¤åˆ°ç›®æ ‡åº“]
    L --> M[å®Œæˆå¤åˆ¶]

    style D fill:#FFD700
    style E fill:#90EE90
    style F fill:#90EE90
    style G fill:#90EE90
    style M fill:#87CEEB
```

**é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ‰§è¡Œæ­¥éª¤**ï¼š

1. **WAL æ—¥å¿—å†™å…¥**ï¼šä¸»åº“äº‹åŠ¡æäº¤æ—¶å†™å…¥ WAL æ—¥å¿—
2. **é€»è¾‘è§£ç **ï¼šé€»è¾‘è§£ç å™¨è§£æ WAL æ—¥å¿—
3. **ä¼˜åŒ–ç­–ç•¥é€‰æ‹©**ï¼šé€‰æ‹©å¹¶è¡Œåº”ç”¨ã€æ‰¹é‡æäº¤æˆ–æµå¼ä¼ è¾“
4. **äº‹åŠ¡å¤„ç†**ï¼šæ ¹æ®ç­–ç•¥å¤„ç†äº‹åŠ¡
5. **åº”ç”¨äº‹åŠ¡**ï¼šå°†äº‹åŠ¡åº”ç”¨åˆ°ç›®æ ‡åº“
6. **å®Œæˆå¤åˆ¶**ï¼šå®Œæˆé€»è¾‘å¤åˆ¶

### 1.1 PostgreSQL 17 ä¼˜åŒ–äº®ç‚¹

PostgreSQL 17 åœ¨é€»è¾‘å¤åˆ¶æ–¹é¢çš„ä¸»è¦ä¼˜åŒ–ï¼š

- **å¹¶è¡Œåº”ç”¨**ï¼šæ”¯æŒå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œåº”ç”¨äº‹åŠ¡
- **æ‰¹é‡æäº¤**ï¼šæ‰¹é‡æäº¤äº‹åŠ¡ï¼Œå‡å°‘æäº¤å¼€é”€
- **æµå¼ä¼ è¾“**ï¼šæµå¼ä¼ è¾“å˜æ›´ï¼Œé™ä½å»¶è¿Ÿ
- **å†…å­˜ä¼˜åŒ–**ï¼šä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œæ”¯æŒæ›´å¤§äº‹åŠ¡
- **é”ä¼˜åŒ–**ï¼šå‡å°‘é”ç«äº‰ï¼Œæå‡å¹¶å‘æ€§èƒ½

### 1.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | PostgreSQL 16 | PostgreSQL 17 | æå‡ |
|------|--------------|---------------|------|
| å•è¡¨æ’å…¥ | 10,000 TPS | 25,000 TPS | 2.5x |
| å¤šè¡¨äº‹åŠ¡ | 5,000 TPS | 20,000 TPS | 4x |
| å¤§äº‹åŠ¡ | 1,000 TPS | 5,000 TPS | 5x |
| å»¶è¿Ÿ | 100ms | 20ms | 5x |

---

## 2. å¹¶è¡Œåº”ç”¨ä¼˜åŒ–

### 2.0 å¹¶è¡Œåº”ç”¨å·¥ä½œåŸç†æ¦‚è¿°

**å¹¶è¡Œåº”ç”¨çš„æœ¬è´¨**ï¼š

PostgreSQL 17 çš„å¹¶è¡Œåº”ç”¨å…è®¸å¤šä¸ªå·¥ä½œè¿›ç¨‹åŒæ—¶åº”ç”¨ä¸åŒçš„äº‹åŠ¡ï¼Œé€šè¿‡å¹¶è¡Œå¤„ç†å¤§å¹…æå‡é€»è¾‘å¤åˆ¶çš„ååé‡ã€‚å¹¶è¡Œåº”ç”¨çš„æ ¸å¿ƒæ˜¯äº‹åŠ¡ä¾èµ–æ£€æµ‹å’Œå†²çªå¤„ç†ã€‚

**å¹¶è¡Œåº”ç”¨æ¶æ„å›¾**ï¼š

```mermaid
flowchart TD
    A[å‘å¸ƒç«¯ WAL] --> B[é€»è¾‘è§£ç è¿›ç¨‹]
    B --> C[äº‹åŠ¡å˜æ›´æµ]
    C --> D[è®¢é˜…ç«¯æ¥æ”¶]
    D --> E{äº‹åŠ¡ä¾èµ–æ£€æµ‹}
    E -->|æ— ä¾èµ–| F[å¹¶è¡Œåº”ç”¨å·¥ä½œè¿›ç¨‹1]
    E -->|æ— ä¾èµ–| G[å¹¶è¡Œåº”ç”¨å·¥ä½œè¿›ç¨‹2]
    E -->|æ— ä¾èµ–| H[å¹¶è¡Œåº”ç”¨å·¥ä½œè¿›ç¨‹N]
    E -->|æœ‰ä¾èµ–| I[ä¸²è¡Œåº”ç”¨]
    F --> J[åº”ç”¨äº‹åŠ¡1]
    G --> K[åº”ç”¨äº‹åŠ¡2]
    H --> L[åº”ç”¨äº‹åŠ¡N]
    I --> M[åº”ç”¨äº‹åŠ¡]
    J --> N[æäº¤]
    K --> N
    L --> N
    M --> N

    style F fill:#90EE90
    style G fill:#90EE90
    style H fill:#90EE90
    style I fill:#FFB6C1
```

**å¹¶è¡Œåº”ç”¨å·¥ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ¥æ”¶äº‹åŠ¡å˜æ›´] --> B{æ£€æµ‹äº‹åŠ¡ä¾èµ–}
    B -->|æ— ä¾èµ–| C[åˆ†é…åˆ°å·¥ä½œè¿›ç¨‹æ± ]
    B -->|æœ‰ä¾èµ–| D[ç­‰å¾…ä¾èµ–äº‹åŠ¡å®Œæˆ]
    C --> E{å·¥ä½œè¿›ç¨‹å¯ç”¨?}
    E -->|æ˜¯| F[ç«‹å³åº”ç”¨]
    E -->|å¦| G[åŠ å…¥é˜Ÿåˆ—]
    D --> H[ä¾èµ–å®Œæˆååº”ç”¨]
    F --> I[æäº¤äº‹åŠ¡]
    G --> E
    H --> I
    I --> J[æ›´æ–°è¿›åº¦]

    style C fill:#90EE90
    style D fill:#FFB6C1
```

**äº‹åŠ¡ä¾èµ–æ£€æµ‹**ï¼š

- **æ— ä¾èµ–äº‹åŠ¡**ï¼šå¯ä»¥å¹¶è¡Œåº”ç”¨
- **æœ‰ä¾èµ–äº‹åŠ¡**ï¼šå¿…é¡»ç­‰å¾…ä¾èµ–äº‹åŠ¡å®Œæˆåæ‰èƒ½åº”ç”¨
- **å†²çªæ£€æµ‹**ï¼šæ£€æµ‹è¡¨çº§å’Œè¡Œçº§å†²çª

### 2.1 å¹¶è¡Œåº”ç”¨åŸç†

PostgreSQL 17 æ”¯æŒå¹¶è¡Œåº”ç”¨äº‹åŠ¡ï¼Œå¤šä¸ªå·¥ä½œè¿›ç¨‹å¯ä»¥åŒæ—¶åº”ç”¨ä¸åŒçš„äº‹åŠ¡ï¼Œå¤§å¹…æå‡å¤åˆ¶æ€§èƒ½ã€‚

**å¹¶è¡Œåº”ç”¨çš„å…³é”®ç‰¹æ€§**ï¼š

- **äº‹åŠ¡çº§å¹¶è¡Œ**ï¼šä¸åŒäº‹åŠ¡å¯ä»¥å¹¶è¡Œåº”ç”¨
- **ä¾èµ–æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹äº‹åŠ¡ä¾èµ–å…³ç³»
- **å†²çªå¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†è¡¨çº§å’Œè¡Œçº§å†²çª
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦

### 2.2 å¯ç”¨å¹¶è¡Œåº”ç”¨

```sql
-- 1. åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION my_publication FOR ALL TABLES;

-- 2. åˆ›å»ºè®¢é˜…ï¼ˆå¯ç”¨å¹¶è¡Œåº”ç”¨ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    parallel = true,  -- å¯ç”¨å¹¶è¡Œåº”ç”¨
    max_parallel_workers = 4  -- æœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
);

-- 3. ä¿®æ”¹ç°æœ‰è®¢é˜…å¯ç”¨å¹¶è¡Œåº”ç”¨
ALTER SUBSCRIPTION my_subscription
SET (parallel = true, max_parallel_workers = 4);

-- 4. æŸ¥çœ‹å¹¶è¡Œåº”ç”¨çŠ¶æ€
SELECT
    subname,
    subparallel,
    subparallelworkers
FROM pg_subscription
WHERE subname = 'my_subscription';

-- 5. æŸ¥çœ‹å¹¶è¡Œå·¥ä½œè¿›ç¨‹
SELECT
    pid,
    usename,
    application_name,
    state,
    sync_state
FROM pg_stat_replication
WHERE application_name LIKE '%my_subscription%';

-- 6. ç›‘æ§å¹¶è¡Œåº”ç”¨æ€§èƒ½
SELECT
    subname,
    COUNT(*) FILTER (WHERE state = 'streaming') AS active_workers,
    COUNT(*) FILTER (WHERE state = 'catchup') AS catchup_workers
FROM pg_stat_subscription
GROUP BY subname;
WITH (
    -- å¯ç”¨å¹¶è¡Œåº”ç”¨
    parallel = true,
    -- å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°ï¼ˆå»ºè®®ï¼šCPUæ ¸å¿ƒæ•°ï¼‰
    max_parallel_workers = 4
);
```

### 2.3 å¹¶è¡Œåº”ç”¨é…ç½®

```sql
-- æŸ¥çœ‹è®¢é˜…é…ç½®
SELECT
    subname,
    subparallel,
    subparallelworkers
FROM pg_subscription
WHERE subname = 'my_subscription';

-- ä¿®æ”¹å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
ALTER SUBSCRIPTION my_subscription
SET (max_parallel_workers = 8);
```

### 2.4 å¹¶è¡Œåº”ç”¨é™åˆ¶

- **äº‹åŠ¡é¡ºåº**ï¼šç›¸å…³äº‹åŠ¡ä»æŒ‰é¡ºåºåº”ç”¨
- **DDL æ“ä½œ**ï¼šDDL æ“ä½œä¸²è¡Œæ‰§è¡Œ
- **å†²çªå¤„ç†**ï¼šå†²çªæ—¶å›é€€åˆ°ä¸²è¡Œæ¨¡å¼

---

## 3. æ‰¹é‡æäº¤ä¼˜åŒ–

### 3.1 æ‰¹é‡æäº¤åŸç†

PostgreSQL 17 æ”¯æŒæ‰¹é‡æäº¤äº‹åŠ¡ï¼Œå°†å¤šä¸ªäº‹åŠ¡åˆå¹¶ä¸ºä¸€ä¸ªæäº¤ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”å’Œé”ç«äº‰ã€‚

### 3.2 é…ç½®æ‰¹é‡æäº¤

```sql
-- åˆ›å»ºè®¢é˜…ï¼ˆå¯ç”¨æ‰¹é‡æäº¤ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    -- æ‰¹é‡æäº¤å¤§å°ï¼ˆäº‹åŠ¡æ•°ï¼‰
    batch_size = 100,
    -- æ‰¹é‡æäº¤è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
    batch_timeout = 100
);
```

### 3.3 æ‰¹é‡æäº¤å‚æ•°

- **batch_size**ï¼šæ‰¹é‡æäº¤çš„äº‹åŠ¡æ•°é‡ï¼ˆé»˜è®¤ï¼š100ï¼‰
- **batch_timeout**ï¼šæ‰¹é‡æäº¤è¶…æ—¶æ—¶é—´ï¼Œæ¯«ç§’ï¼ˆé»˜è®¤ï¼š100msï¼‰

### 3.4 æ‰¹é‡æäº¤ä¼˜åŒ–å»ºè®®

```sql
-- é«˜åååœºæ™¯ï¼šå¢å¤§æ‰¹é‡å¤§å°
ALTER SUBSCRIPTION my_subscription
SET (
    batch_size = 500,
    batch_timeout = 200
);

-- ä½å»¶è¿Ÿåœºæ™¯ï¼šå‡å°æ‰¹é‡å¤§å°
ALTER SUBSCRIPTION my_subscription
SET (
    batch_size = 50,
    batch_timeout = 50
);
```

---

## 4. æµå¼ä¼ è¾“ä¼˜åŒ–

### 4.1 æµå¼ä¼ è¾“åŸç†

PostgreSQL 17 æ”¯æŒæµå¼ä¼ è¾“å˜æ›´ï¼Œäº‹åŠ¡åœ¨æäº¤å‰å°±å¼€å§‹ä¼ è¾“ï¼Œå¤§å¹…é™ä½å¤åˆ¶å»¶è¿Ÿã€‚

### 4.2 å¯ç”¨æµå¼ä¼ è¾“

```sql
-- åˆ›å»ºè®¢é˜…ï¼ˆå¯ç”¨æµå¼ä¼ è¾“ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    -- å¯ç”¨æµå¼ä¼ è¾“
    streaming = true,
    -- æµå¼ä¼ è¾“æ¨¡å¼
    streaming_mode = 'parallel'  -- 'parallel' æˆ– 'serial'
);
```

### 4.3 æµå¼ä¼ è¾“æ¨¡å¼

- **parallel**ï¼šå¹¶è¡Œæµå¼ä¼ è¾“ï¼ˆæ¨èï¼‰
- **serial**ï¼šä¸²è¡Œæµå¼ä¼ è¾“ï¼ˆæ›´å®‰å…¨ï¼‰

### 4.4 æµå¼ä¼ è¾“é…ç½®

```sql
-- æŸ¥çœ‹æµå¼ä¼ è¾“çŠ¶æ€
SELECT
    subname,
    substreaming,
    substreamingmode
FROM pg_subscription
WHERE subname = 'my_subscription';

-- ä¿®æ”¹æµå¼ä¼ è¾“æ¨¡å¼
ALTER SUBSCRIPTION my_subscription
SET (streaming_mode = 'parallel');
```

---

## 5. é…ç½®å‚æ•°è°ƒä¼˜

### 5.1 å‘å¸ƒç«¯å‚æ•°

```sql
-- postgresql.conf é…ç½®
# é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹æ•°
max_logical_replication_workers = 8

# é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹å†…å­˜
logical_replication_worker_memory = 64MB

# WAL å‘é€å»¶è¿Ÿï¼ˆå¾®ç§’ï¼‰
wal_sender_timeout = 60s
```

### 5.2 è®¢é˜…ç«¯å‚æ•°

```sql
-- postgresql.conf é…ç½®
# é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹æ•°
max_logical_replication_workers = 8

# é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹å†…å­˜
logical_replication_worker_memory = 64MB

# å¤åˆ¶æ§½è¶…æ—¶
replication_slot_timeout = 60s
```

### 5.3 è®¢é˜…å‚æ•°

```sql
-- å®Œæ•´é…ç½®ç¤ºä¾‹
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    -- å¹¶è¡Œåº”ç”¨
    parallel = true,
    max_parallel_workers = 4,

    -- æ‰¹é‡æäº¤
    batch_size = 100,
    batch_timeout = 100,

    -- æµå¼ä¼ è¾“
    streaming = true,
    streaming_mode = 'parallel',

    -- å…¶ä»–å‚æ•°
    copy_data = true,
    create_slot = true,
    enabled = true
);
```

---

## 6. æ€§èƒ½ç›‘æ§

### 6.1 ç›‘æ§å¤åˆ¶å»¶è¿Ÿ

```sql
-- æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    subname,
    pg_subscription_rel.srsubid,
    pg_subscription_rel.srrelid,
    pg_stat_replication.lag
FROM pg_subscription
JOIN pg_subscription_rel ON pg_subscription.oid = pg_subscription_rel.srsubid
LEFT JOIN pg_stat_replication ON pg_subscription.subname = pg_stat_replication.application_name
WHERE pg_subscription.subname = 'my_subscription';
```

### 6.2 ç›‘æ§å·¥ä½œè¿›ç¨‹

```sql
-- æŸ¥çœ‹é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹
SELECT
    pid,
    usename,
    application_name,
    state,
    sync_state,
    sync_priority
FROM pg_stat_replication
WHERE application_name LIKE 'my_subscription%';
```

### 6.3 ç›‘æ§æ€§èƒ½æŒ‡æ ‡

```sql
-- åˆ›å»ºç›‘æ§è§†å›¾
CREATE VIEW logical_replication_stats AS
SELECT
    s.subname,
    COUNT(DISTINCT sr.srrelid) AS table_count,
    COUNT(DISTINCT r.pid) AS worker_count,
    SUM(r.sent_lsn - r.write_lsn) AS lag_bytes
FROM pg_subscription s
LEFT JOIN pg_subscription_rel sr ON s.oid = sr.srsubid
LEFT JOIN pg_stat_replication r ON r.application_name LIKE s.subname || '%'
GROUP BY s.subname;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM logical_replication_stats;
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°**ï¼ˆè®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°çš„ä¸€åŠåˆ°å…¨éƒ¨ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°é…ç½®
   -- max_parallel_workers = CPU æ ¸å¿ƒæ•° / 2
   CREATE SUBSCRIPTION my_subscription
   WITH (max_parallel_workers = 4);  -- 8 æ ¸ CPU

   -- âŒ ä¸å¥½ï¼šå·¥ä½œè¿›ç¨‹æ•°è¿‡å¤šï¼ˆå¢åŠ é”ç«äº‰ï¼‰
   -- max_parallel_workers = 16  -- 8 æ ¸ CPUï¼Œè¿‡å¤š
   ```

2. **æ‰¹é‡æäº¤å¤§å°**ï¼ˆæ ¹æ®äº‹åŠ¡å¤§å°è°ƒæ•´ï¼Œæ¨è 100-500ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæ ¹æ®åœºæ™¯é…ç½®æ‰¹é‡å¤§å°
   -- é«˜åååœºæ™¯ï¼šæ‰¹é‡å¤§å°å¤§
   batch_size = 500
   batch_timeout = 100

   -- ä½å»¶è¿Ÿåœºæ™¯ï¼šæ‰¹é‡å¤§å°å°
   batch_size = 50
   batch_timeout = 10

   -- å¹³è¡¡åœºæ™¯ï¼ˆæ¨èï¼‰
   batch_size = 100
   batch_timeout = 50
   ```

3. **æµå¼ä¼ è¾“**ï¼ˆé«˜å»¶è¿Ÿåœºæ™¯å¯ç”¨æµå¼ä¼ è¾“ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå¯ç”¨æµå¼ä¼ è¾“é™ä½å»¶è¿Ÿ
   CREATE SUBSCRIPTION my_subscription
   WITH (
       streaming = true,
       streaming_mode = 'parallel'
   );
   ```

4. **ç´¢å¼•ä¼˜åŒ–**ï¼ˆç¡®ä¿ç›®æ ‡è¡¨æœ‰é€‚å½“ç´¢å¼•ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä¸ºç›®æ ‡è¡¨åˆ›å»ºç´¢å¼•
   CREATE INDEX idx_target_table_id ON target_table(id);
   CREATE INDEX idx_target_table_status ON target_table(status);

   -- æå‡ MERGE å’Œ UPDATE æ€§èƒ½
   ```

5. **ç½‘ç»œä¼˜åŒ–**ï¼ˆä½¿ç”¨é«˜é€Ÿç½‘ç»œè¿æ¥ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ä½å»¶è¿Ÿã€é«˜å¸¦å®½ç½‘ç»œ
   -- å‘å¸ƒç«¯å’Œè®¢é˜…ç«¯ä¹‹é—´ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ
   -- é¿å…è·¨åŒºåŸŸç½‘ç»œå»¶è¿Ÿ
   ```

### 7.2 é…ç½®å»ºè®®

```sql
-- é«˜åååœºæ™¯é…ç½®
CREATE SUBSCRIPTION high_throughput_sub
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    parallel = true,
    max_parallel_workers = 8,
    batch_size = 500,
    batch_timeout = 200,
    streaming = true,
    streaming_mode = 'parallel'
);

-- ä½å»¶è¿Ÿåœºæ™¯é…ç½®
CREATE SUBSCRIPTION low_latency_sub
CONNECTION 'host=target_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    parallel = true,
    max_parallel_workers = 4,
    batch_size = 50,
    batch_timeout = 50,
    streaming = true,
    streaming_mode = 'parallel'
);
```

### 7.3 æ•…éšœå¤„ç†

```sql
-- æŸ¥çœ‹å¤åˆ¶é”™è¯¯
SELECT * FROM pg_replication_slots
WHERE slot_name LIKE 'my_subscription%';

-- é‡æ–°åŒæ­¥è¡¨
ALTER SUBSCRIPTION my_subscription
REFRESH PUBLICATION;

-- ç¦ç”¨/å¯ç”¨è®¢é˜…
ALTER SUBSCRIPTION my_subscription DISABLE;
ALTER SUBSCRIPTION my_subscription ENABLE;
```

---

## 8. å®é™…æ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹ï¼šç”µå•†è®¢å•ç³»ç»Ÿå¤åˆ¶

```sql
-- åœºæ™¯ï¼šä¸»åº“è®¢å•æ•°æ®å¤åˆ¶åˆ°åˆ†æåº“
-- è¦æ±‚ï¼šé«˜ååã€ä½å»¶è¿Ÿ

-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION orders_pub FOR TABLE orders, order_items;

-- åˆ›å»ºè®¢é˜…ï¼ˆä¼˜åŒ–é…ç½®ï¼‰
CREATE SUBSCRIPTION orders_sub
CONNECTION 'host=analytics_db dbname=analytics user=replicator'
PUBLICATION orders_pub
WITH (
    parallel = true,
    max_parallel_workers = 8,
    batch_size = 200,
    batch_timeout = 100,
    streaming = true,
    streaming_mode = 'parallel'
);

-- æ€§èƒ½ç»“æœï¼š
-- - ååé‡ï¼š20,000 TPS
-- - å»¶è¿Ÿï¼š< 50ms
-- - CPU ä½¿ç”¨ç‡ï¼š60%
```

### 8.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿæ•°æ®åŒæ­¥

```sql
-- åœºæ™¯ï¼šä¸»åº“æ•°æ®åŒæ­¥åˆ°å¤šä¸ªç§Ÿæˆ·åº“
-- è¦æ±‚ï¼šé«˜å¹¶å‘ã€æ•°æ®ä¸€è‡´æ€§

-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºè®¢é˜…
DO $$
DECLARE
    tenant_id INTEGER;
BEGIN
    FOR tenant_id IN 1..10 LOOP
        EXECUTE format('
            CREATE SUBSCRIPTION tenant_%s_sub
            CONNECTION ''host=tenant_%s_db dbname=tenant_%s user=replicator''
            PUBLICATION main_pub
            WITH (
                parallel = true,
                max_parallel_workers = 4,
                batch_size = 100,
                streaming = true
            )',
            tenant_id, tenant_id, tenant_id
        );
    END LOOP;
END $$;

-- æ€§èƒ½ç»“æœï¼š
-- - æ¯ä¸ªç§Ÿæˆ·ï¼š5,000 TPS
-- - æ€»ååé‡ï¼š50,000 TPS
-- - å»¶è¿Ÿï¼š< 100ms
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–æ˜¾è‘—æå‡äº†å¤åˆ¶ååé‡å’Œé™ä½äº†å»¶è¿Ÿã€‚é€šè¿‡åˆç†é…ç½®å¹¶è¡Œåº”ç”¨ã€æ‰¹é‡æäº¤å’Œæµå¼ä¼ è¾“ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°é«˜æ€§èƒ½çš„æ•°æ®å¤åˆ¶ã€‚å»ºè®®æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´é…ç½®å‚æ•°ï¼Œå¹¶æŒç»­ç›‘æ§å¤åˆ¶æ€§èƒ½ã€‚

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/17/logical-replication.html)**
  - é€»è¾‘å¤åˆ¶å®Œæ•´å‚è€ƒæ‰‹å†Œ
  - PostgreSQL 17 æ–°ç‰¹æ€§è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶é…ç½®](https://www.postgresql.org/docs/17/logical-replication-config.html)**
  - é€»è¾‘å¤åˆ¶é…ç½®å‚æ•°
  - æ€§èƒ½ä¼˜åŒ–é…ç½®

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶ç›‘æ§](https://www.postgresql.org/docs/17/monitoring-replication.html)**
  - é€»è¾‘å¤åˆ¶ç›‘æ§æ–¹æ³•
  - å¤åˆ¶å»¶è¿Ÿç›‘æ§

- **[PostgreSQL 17 å‘å¸ƒè¯´æ˜](https://www.postgresql.org/about/news/postgresql-17-released-2781/)**
  - PostgreSQL 17 æ–°ç‰¹æ€§ä»‹ç»
  - é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–è¯´æ˜

### æŠ€æœ¯è®ºæ–‡

- **Kemme, B., & Alonso, G. (2000). "Database Replication: A Tale of Research across Communities."**
  - ä¼šè®®: VLDB 2000
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶æŠ€æœ¯çš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°æ€»ç»“äº†æ•°æ®åº“å¤åˆ¶çš„å„ç§æ–¹æ³•å’ŒæŒ‘æˆ˜ï¼ŒåŒ…æ‹¬å¹¶è¡Œå¤åˆ¶

- **Gray, J., et al. (1996). "The Dangers of Replication and a Solution."**
  - ä¼šè®®: SIGMOD 1996
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶ä¸€è‡´æ€§çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: åˆ†æäº†æ•°æ®åº“å¤åˆ¶çš„å±é™©æ€§å’Œè§£å†³æ–¹æ¡ˆ

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–](https://www.postgresql.org/about/news/postgresql-17-released-2781/)**
  - PostgreSQL 17 é€»è¾‘å¤åˆ¶ä¼˜åŒ–è¯´æ˜
  - æ€§èƒ½æå‡æ•°æ®

- **[2ndQuadrant - PostgreSQL 17 é€»è¾‘å¤åˆ¶](https://www.2ndquadrant.com/en/blog/postgresql-17-logical-replication/)**
  - é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–å®æˆ˜
  - é…ç½®ä¼˜åŒ–å»ºè®®

- **[Percona - PostgreSQL é€»è¾‘å¤åˆ¶æ€§èƒ½](https://www.percona.com/blog/postgresql-logical-replication-performance/)**
  - é€»è¾‘å¤åˆ¶æ€§èƒ½è°ƒä¼˜
  - æ€§èƒ½ç›‘æ§æ–¹æ³•

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Logical Replication](https://wiki.postgresql.org/wiki/Logical_Replication)**
  - é€»è¾‘å¤åˆ¶ä½¿ç”¨æŒ‡å—
  - å¸¸è§é—®é¢˜è§£ç­”

- **[Stack Overflow - PostgreSQL Logical Replication](https://stackoverflow.com/questions/tagged/postgresql+logical-replication)**
  - é€»è¾‘å¤åˆ¶ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-17-03
