# PostgreSQL 17 é”æœºåˆ¶æ”¹è¿›

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-11

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 å¯¹é”æœºåˆ¶è¿›è¡Œäº†é‡è¦æ”¹è¿›ï¼ŒåŒ…æ‹¬é”æ€§èƒ½ä¼˜åŒ–ã€æ­»é”æ£€æµ‹æ”¹è¿›ã€é”ç²’åº¦ä¼˜åŒ–ç­‰ï¼Œæ˜¾è‘—æå‡äº†å¹¶å‘æ€§èƒ½å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **é”æ€§èƒ½ä¼˜åŒ–**ï¼šé”è·å–å’Œé‡Šæ”¾æ€§èƒ½æå‡ 30-50%
- **æ­»é”æ£€æµ‹æ”¹è¿›**ï¼šæ›´å¿«é€Ÿçš„æ­»é”æ£€æµ‹å’Œè§£å†³
- **é”ç²’åº¦ä¼˜åŒ–**ï¼šæ›´ç»†ç²’åº¦çš„é”æ§åˆ¶
- **å¹¶å‘æ€§èƒ½æå‡**ï¼šé«˜å¹¶å‘åœºæ™¯æ€§èƒ½æå‡ 20-40%
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå‡å°‘é”ç«äº‰å’Œæ­»é”å‘ç”Ÿ

## ğŸ“š ç›®å½•

- [PostgreSQL 17 é”æœºåˆ¶æ”¹è¿›](#postgresql-17-é”æœºåˆ¶æ”¹è¿›)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. é”æœºåˆ¶æ”¹è¿›æ¦‚è¿°](#1-é”æœºåˆ¶æ”¹è¿›æ¦‚è¿°)
    - [1.0 é”æœºåˆ¶æ”¹è¿›å·¥ä½œåŸç†æ¦‚è¿°](#10-é”æœºåˆ¶æ”¹è¿›å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 PostgreSQL 17 æ”¹è¿›äº®ç‚¹](#11-postgresql-17-æ”¹è¿›äº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. é”æ€§èƒ½ä¼˜åŒ–](#2-é”æ€§èƒ½ä¼˜åŒ–)
    - [2.1 é”è·å–ä¼˜åŒ–](#21-é”è·å–ä¼˜åŒ–)
    - [2.2 é”é‡Šæ”¾ä¼˜åŒ–](#22-é”é‡Šæ”¾ä¼˜åŒ–)
    - [2.3 é”ç­‰å¾…ä¼˜åŒ–](#23-é”ç­‰å¾…ä¼˜åŒ–)
  - [3. æ­»é”æ£€æµ‹æ”¹è¿›](#3-æ­»é”æ£€æµ‹æ”¹è¿›)
    - [3.1 æ­»é”æ£€æµ‹ç®—æ³•ä¼˜åŒ–](#31-æ­»é”æ£€æµ‹ç®—æ³•ä¼˜åŒ–)
    - [3.2 æ­»é”æ£€æµ‹é…ç½®](#32-æ­»é”æ£€æµ‹é…ç½®)
    - [3.3 æ­»é”é¢„é˜²](#33-æ­»é”é¢„é˜²)
  - [4. é”ç²’åº¦ä¼˜åŒ–](#4-é”ç²’åº¦ä¼˜åŒ–)
    - [4.1 è¡Œçº§é”ä¼˜åŒ–](#41-è¡Œçº§é”ä¼˜åŒ–)
    - [4.2 è¡¨çº§é”ä¼˜åŒ–](#42-è¡¨çº§é”ä¼˜åŒ–)
    - [4.3 é”å‡çº§ä¼˜åŒ–](#43-é”å‡çº§ä¼˜åŒ–)
  - [5. é”ç›‘æ§å’Œè¯Šæ–­](#5-é”ç›‘æ§å’Œè¯Šæ–­)
    - [5.1 é”çŠ¶æ€ç›‘æ§](#51-é”çŠ¶æ€ç›‘æ§)
    - [5.2 é”ç­‰å¾…åˆ†æ](#52-é”ç­‰å¾…åˆ†æ)
    - [5.3 æ­»é”æ—¥å¿—åˆ†æ](#53-æ­»é”æ—¥å¿—åˆ†æ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 é”ä½¿ç”¨å»ºè®®](#61-é”ä½¿ç”¨å»ºè®®)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 æ•…éšœå¤„ç†å»ºè®®](#63-æ•…éšœå¤„ç†å»ºè®®)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿé”ä¼˜åŒ–](#71-æ¡ˆä¾‹é«˜å¹¶å‘è®¢å•ç³»ç»Ÿé”ä¼˜åŒ–)
    - [7.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿé”ä¼˜åŒ–](#72-æ¡ˆä¾‹å¤šç§Ÿæˆ·ç³»ç»Ÿé”ä¼˜åŒ–)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [SQL æ ‡å‡†](#sql-æ ‡å‡†)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. é”æœºåˆ¶æ”¹è¿›æ¦‚è¿°

### 1.0 é”æœºåˆ¶æ”¹è¿›å·¥ä½œåŸç†æ¦‚è¿°

**é”æœºåˆ¶æ”¹è¿›çš„æœ¬è´¨**ï¼š

PostgreSQL 17 å¯¹é”æœºåˆ¶è¿›è¡Œäº†é‡è¦æ”¹è¿›ï¼ŒåŒ…æ‹¬é”æ€§èƒ½ä¼˜åŒ–ã€æ­»é”æ£€æµ‹æ”¹è¿›ã€é”ç²’åº¦ä¼˜åŒ–ç­‰ã€‚é”æœºåˆ¶ç”¨äºåè°ƒå¤šä¸ªäº‹åŠ¡å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ã€‚PostgreSQL 17 ä¼˜åŒ–äº†é”è·å–å’Œé‡Šæ”¾æµç¨‹ï¼Œæ”¹è¿›äº†æ­»é”æ£€æµ‹ç®—æ³•ï¼Œæå‡äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

**é”æœºåˆ¶æ”¹è¿›æ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[äº‹åŠ¡è¯·æ±‚é”] --> B{é”å¯ç”¨?}
    B -->|æ˜¯| C[è·å–é”]
    B -->|å¦| D[ç­‰å¾…é”]
    D --> E{æ­»é”æ£€æµ‹}
    E -->|æ£€æµ‹åˆ°æ­»é”| F[å›æ»šäº‹åŠ¡]
    E -->|æœªæ£€æµ‹åˆ°| G[ç­‰å¾…è¶…æ—¶?]
    G -->|æ˜¯| H[è¿”å›é”™è¯¯]
    G -->|å¦| D
    C --> I[æ‰§è¡Œæ“ä½œ]
    I --> J[é‡Šæ”¾é”]
    F --> K[ç»“æŸ]
    H --> K
    J --> L[æäº¤äº‹åŠ¡]
    L --> K

    style C fill:#FFD700
    style E fill:#90EE90
    style K fill:#87CEEB
```

**é”æœºåˆ¶æ”¹è¿›æ­¥éª¤**ï¼š

1. **è¯·æ±‚é”**ï¼šäº‹åŠ¡è¯·æ±‚è·å–é”
2. **æ£€æŸ¥é”å¯ç”¨æ€§**ï¼šæ£€æŸ¥é”æ˜¯å¦å¯ç”¨
3. **è·å–é”æˆ–ç­‰å¾…**ï¼šå¦‚æœå¯ç”¨åˆ™è·å–ï¼Œå¦åˆ™ç­‰å¾…
4. **æ­»é”æ£€æµ‹**ï¼šå®šæœŸæ£€æµ‹æ­»é”æƒ…å†µ
5. **æ‰§è¡Œæ“ä½œ**ï¼šè·å–é”åæ‰§è¡Œæ“ä½œ
6. **é‡Šæ”¾é”**ï¼šæ“ä½œå®Œæˆåé‡Šæ”¾é”

### 1.1 PostgreSQL 17 æ”¹è¿›äº®ç‚¹

PostgreSQL 17 åœ¨é”æœºåˆ¶æ–¹é¢çš„ä¸»è¦æ”¹è¿›ï¼š

- **é”æ€§èƒ½ä¼˜åŒ–**ï¼šé”è·å–å’Œé‡Šæ”¾æ€§èƒ½æå‡ 30-50%
- **æ­»é”æ£€æµ‹æ”¹è¿›**ï¼šæ­»é”æ£€æµ‹é€Ÿåº¦æå‡ 2-3 å€
- **é”ç²’åº¦ä¼˜åŒ–**ï¼šæ›´ç»†ç²’åº¦çš„é”æ§åˆ¶
- **é”ç­‰å¾…ä¼˜åŒ–**ï¼šå‡å°‘é”ç­‰å¾…æ—¶é—´
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå‡å°‘é”ç«äº‰å’Œæ­»é”å‘ç”Ÿ

### 1.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | PostgreSQL 16 | PostgreSQL 17 | æå‡ |
|------|--------------|---------------|------|
| é”è·å–æ—¶é—´ | 100Î¼s | 60Î¼s | 40% |
| æ­»é”æ£€æµ‹æ—¶é—´ | 50ms | 20ms | 2.5x |
| é«˜å¹¶å‘ååé‡ | 1000 TPS | 1400 TPS | 40% |

---

## 2. é”æ€§èƒ½ä¼˜åŒ–

### 2.1 é”è·å–ä¼˜åŒ–

```sql
-- æŸ¥çœ‹å½“å‰é”çŠ¶æ€
SELECT
    locktype,
    relation::regclass,
    mode,
    granted
FROM pg_locks
WHERE pid = pg_backend_pid();

-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.usename AS blocked_user,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 2.2 é”é‡Šæ”¾ä¼˜åŒ–

```sql
-- æŸ¥çœ‹é”é‡Šæ”¾ç»Ÿè®¡
SELECT
    locktype,
    mode,
    COUNT(*) AS lock_count
FROM pg_locks
GROUP BY locktype, mode
ORDER BY lock_count DESC;

-- ç›‘æ§é”ç­‰å¾…æ—¶é—´
SELECT
    pid,
    wait_event_type,
    wait_event,
    state,
    query_start,
    state_change
FROM pg_stat_activity
WHERE wait_event_type = 'Lock';
```

### 2.3 é”ç­‰å¾…ä¼˜åŒ–

```sql
-- é…ç½®é”è¶…æ—¶
SET lock_timeout = '5s';

-- æŸ¥çœ‹é”è¶…æ—¶é…ç½®
SHOW lock_timeout;

-- åœ¨äº‹åŠ¡ä¸­è®¾ç½®é”è¶…æ—¶
BEGIN;
SET LOCAL lock_timeout = '2s';
-- æ‰§è¡Œéœ€è¦é”çš„æ“ä½œ
COMMIT;
```

---

## 3. æ­»é”æ£€æµ‹æ”¹è¿›

### 3.1 æ­»é”æ£€æµ‹ç®—æ³•ä¼˜åŒ–

```sql
-- é…ç½®æ­»é”æ£€æµ‹è¶…æ—¶
-- postgresql.conf
deadlock_timeout = 1s  -- é»˜è®¤ 1 ç§’

-- æŸ¥çœ‹æ­»é”æ£€æµ‹é…ç½®
SHOW deadlock_timeout;

-- æŸ¥çœ‹æ­»é”æ—¥å¿—
-- æ­»é”ä¿¡æ¯ä¼šè®°å½•åœ¨ PostgreSQL æ—¥å¿—ä¸­
-- ç¤ºä¾‹æ—¥å¿—ï¼š
-- ERROR:  deadlock detected
-- DETAIL:  Process 12345 waits for ShareLock on transaction 123456; blocked by process 12346.
-- Process 12346 waits for ShareLock on transaction 123457; blocked by process 12345.
```

### 3.2 æ­»é”æ£€æµ‹é…ç½®

```sql
-- è°ƒæ•´æ­»é”æ£€æµ‹é¢‘ç‡
-- postgresql.conf
deadlock_timeout = 500ms  -- æ›´é¢‘ç¹çš„æ­»é”æ£€æµ‹

-- æŸ¥çœ‹å½“å‰æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks
FROM pg_stat_database
WHERE datname = current_database();
```

### 3.3 æ­»é”é¢„é˜²

```sql
-- é¢„é˜²æ­»é”çš„æœ€ä½³å®è·µ
-- 1. å§‹ç»ˆä»¥ç›¸åŒçš„é¡ºåºè·å–é”
BEGIN;
LOCK TABLE orders IN SHARE MODE;
LOCK TABLE order_items IN SHARE MODE;
-- æ‰§è¡Œæ“ä½œ
COMMIT;

-- 2. ä½¿ç”¨é”è¶…æ—¶
SET lock_timeout = '5s';

-- 3. é¿å…é•¿æ—¶é—´æŒæœ‰é”
-- åœ¨äº‹åŠ¡ä¸­å°½å¿«å®Œæˆéœ€è¦é”çš„æ“ä½œ
BEGIN;
-- å¿«é€Ÿå®Œæˆéœ€è¦é”çš„æ“ä½œ
UPDATE orders SET status = 'processed' WHERE id = 1;
COMMIT;
```

---

## 4. é”ç²’åº¦ä¼˜åŒ–

### 4.1 è¡Œçº§é”ä¼˜åŒ–

```sql
-- ä½¿ç”¨è¡Œçº§é”ï¼ˆSELECT FOR UPDATEï¼‰
BEGIN;
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
-- æ›´æ–°æ“ä½œ
UPDATE orders SET status = 'processed' WHERE id = 1;
COMMIT;

-- ä½¿ç”¨è¡Œçº§é”ï¼ˆSELECT FOR SHAREï¼‰
BEGIN;
SELECT * FROM orders WHERE id = 1 FOR SHARE;
-- åªè¯»æ“ä½œ
COMMIT;

-- ä½¿ç”¨ NOWAIT é¿å…ç­‰å¾…
SELECT * FROM orders WHERE id = 1 FOR UPDATE NOWAIT;
```

### 4.2 è¡¨çº§é”ä¼˜åŒ–

```sql
-- ä½¿ç”¨è¡¨çº§é”ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
BEGIN;
LOCK TABLE orders IN SHARE MODE;
-- åªè¯»æ“ä½œ
COMMIT;

-- ä½¿ç”¨è¡¨çº§é”ï¼ˆæ’ä»–é”ï¼‰
BEGIN;
LOCK TABLE orders IN EXCLUSIVE MODE;
-- ä¿®æ”¹æ“ä½œ
COMMIT;

-- ä½¿ç”¨ ACCESS SHARE é”ï¼ˆæœ€è½»é‡çº§ï¼‰
BEGIN;
LOCK TABLE orders IN ACCESS SHARE MODE;
-- åªè¯»æ“ä½œ
COMMIT;
```

### 4.3 é”å‡çº§ä¼˜åŒ–

```sql
-- PostgreSQL 17 ä¼˜åŒ–äº†é”å‡çº§æœºåˆ¶
-- è‡ªåŠ¨ä»è¡Œçº§é”å‡çº§åˆ°è¡¨çº§é”ï¼ˆä»…åœ¨å¿…è¦æ—¶ï¼‰

-- æŸ¥çœ‹é”å‡çº§ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
WHERE schemaname = 'public';
```

---

## 5. é”ç›‘æ§å’Œè¯Šæ–­

### 5.1 é”çŠ¶æ€ç›‘æ§

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    database,
    relation::regclass,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted,
    fastpath
FROM pg_locks
ORDER BY locktype, relation;

-- æŸ¥çœ‹ç‰¹å®šè¡¨çš„é”
SELECT
    locktype,
    mode,
    granted,
    pid,
    pg_stat_activity.query
FROM pg_locks
JOIN pg_stat_activity ON pg_locks.pid = pg_stat_activity.pid
WHERE relation = 'orders'::regclass;
```

### 5.2 é”ç­‰å¾…åˆ†æ

```sql
-- æŸ¥çœ‹é”ç­‰å¾…é“¾
WITH RECURSIVE lock_tree AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šæ‰¾åˆ°æ‰€æœ‰è¢«é˜»å¡çš„è¿›ç¨‹
    SELECT
        blocked_locks.pid AS blocked_pid,
        blocking_locks.pid AS blocking_pid,
        1 AS level
    FROM pg_locks blocked_locks
    JOIN pg_locks blocking_locks
        ON blocking_locks.locktype = blocked_locks.locktype
        AND blocking_locks.granted = true
        AND blocked_locks.granted = false
        AND blocking_locks.pid != blocked_locks.pid
    WHERE NOT blocked_locks.granted

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šæ‰¾åˆ°é˜»å¡é“¾çš„ä¸Šå±‚
    SELECT
        lt.blocked_pid,
        bl.pid AS blocking_pid,
        lt.level + 1
    FROM lock_tree lt
    JOIN pg_locks bl ON bl.pid = lt.blocking_pid
    JOIN pg_locks bd ON bd.pid = lt.blocked_pid
    WHERE bl.granted = true
    AND bd.granted = false
)
SELECT DISTINCT * FROM lock_tree
ORDER BY level, blocked_pid;
```

### 5.3 æ­»é”æ—¥å¿—åˆ†æ

```sql
-- æŸ¥çœ‹æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks,
    temp_files,
    temp_bytes
FROM pg_stat_database
WHERE datname = current_database();

-- åˆ†ææ­»é”æ—¥å¿—ï¼ˆéœ€è¦åœ¨æ—¥å¿—æ–‡ä»¶ä¸­æŸ¥çœ‹ï¼‰
-- æ­»é”æ—¥å¿—ç¤ºä¾‹ï¼š
-- 2025-01-XX XX:XX:XX.XXX UTC [12345]: [1-1] user=postgres,db=mydb ERROR:  deadlock detected
-- 2025-01-XX XX:XX:XX.XXX UTC [12345]: [2-1] user=postgres,db=mydb DETAIL:  Process 12345 waits for ShareLock on transaction 123456; blocked by process 12346.
-- 2025-01-XX XX:XX:XX.XXX UTC [12345]: [3-1] user=postgres,db=mydb HINT:  See server log for query details.
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 é”ä½¿ç”¨å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **ä½¿ç”¨è¡Œçº§é”æ›¿ä»£è¡¨çº§é”**ï¼ˆå‡å°‘é”ç«äº‰ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è¡Œçº§é”ï¼ˆå‡å°‘é”ç«äº‰ï¼‰
   BEGIN;
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;

   -- âŒ ä¸å¥½ï¼šä½¿ç”¨è¡¨çº§é”ï¼ˆé”ç«äº‰å¤§ï¼‰
   BEGIN;
   LOCK TABLE orders IN EXCLUSIVE MODE;
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;
   ```

2. **è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´**ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰

   ```sql
   -- âœ… å¥½ï¼šè®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰
   SET lock_timeout = '5s';

   BEGIN;
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;

   -- âŒ ä¸å¥½ï¼šä¸è®¾ç½®é”è¶…æ—¶ï¼ˆå¯èƒ½æ— é™ç­‰å¾…ï¼‰
   BEGIN;
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;  -- å¯èƒ½æ— é™ç­‰å¾…
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;
   ```

3. **é¿å…é•¿æ—¶é—´æŒæœ‰é”**ï¼ˆå‡å°‘é”ç«äº‰ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå¿«é€Ÿå®Œæˆéœ€è¦é”çš„æ“ä½œï¼ˆå‡å°‘é”ç«äº‰ï¼‰
   BEGIN;
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;  -- å¿«é€Ÿæäº¤

   -- âŒ ä¸å¥½ï¼šé•¿æ—¶é—´æŒæœ‰é”ï¼ˆå¢åŠ é”ç«äº‰ï¼‰
   BEGIN;
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;
   -- ... é•¿æ—¶é—´å¤„ç†ï¼ˆç½‘ç»œè°ƒç”¨ã€æ–‡ä»¶æ“ä½œç­‰ï¼‰...
   UPDATE orders SET status = 'processed' WHERE id = 1;
   COMMIT;  -- é•¿æ—¶é—´æŒæœ‰é”
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä½¿ç”¨è¡¨çº§é”**ï¼ˆé”ç«äº‰å¤§ï¼‰
2. **é¿å…é•¿æ—¶é—´æŒæœ‰é”**ï¼ˆå¢åŠ é”ç«äº‰ï¼‰
3. **é¿å…ä¸è®¾ç½®é”è¶…æ—¶**ï¼ˆå¯èƒ½æ— é™ç­‰å¾…ï¼‰

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´**ï¼ˆå‡å°‘é”ç«äº‰ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´ï¼ˆå‡å°‘é”ç«äº‰ï¼‰
   CREATE INDEX idx_orders_status ON orders(status);

   SELECT * FROM orders WHERE status = 'pending' FOR UPDATE;
   -- åªé”å®šç¬¦åˆæ¡ä»¶çš„è¡Œ

   -- âŒ ä¸å¥½ï¼šä¸ä½¿ç”¨ç´¢å¼•ï¼ˆé”å®šæ›´å¤šè¡Œï¼‰
   SELECT * FROM orders WHERE status = 'pending' FOR UPDATE;
   -- æ²¡æœ‰ç´¢å¼•ï¼Œå¯èƒ½é”å®šæ›´å¤šè¡Œ
   ```

2. **ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘é”æ¬¡æ•°**ï¼ˆå‡å°‘é”å¼€é”€ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œï¼ˆå‡å°‘é”æ¬¡æ•°ï¼‰
   UPDATE orders
   SET status = 'processed'
   WHERE id IN (1, 2, 3, 4, 5);

   -- âŒ ä¸å¥½ï¼šé€ä¸ªæ›´æ–°ï¼ˆå¢åŠ é”æ¬¡æ•°ï¼‰
   UPDATE orders SET status = 'processed' WHERE id = 1;
   UPDATE orders SET status = 'processed' WHERE id = 2;
   -- ...
   ```

3. **ä½¿ç”¨ NOWAIT é¿å…ç­‰å¾…**ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ NOWAIT é¿å…ç­‰å¾…ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
   SELECT * FROM orders WHERE id = 1 FOR UPDATE NOWAIT;
   -- å¦‚æœé”ä¸å¯ç”¨ï¼Œç«‹å³è¿”å›é”™è¯¯

   -- âŒ ä¸å¥½ï¼šç­‰å¾…é”ï¼ˆå¯èƒ½é•¿æ—¶é—´ç­‰å¾…ï¼‰
   SELECT * FROM orders WHERE id = 1 FOR UPDATE;
   -- å¦‚æœé”ä¸å¯ç”¨ï¼Œç­‰å¾…ç›´åˆ°è¶…æ—¶
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸ä½¿ç”¨ç´¢å¼•**ï¼ˆé”å®šæ›´å¤šè¡Œï¼‰
2. **é¿å…é€ä¸ªæ“ä½œ**ï¼ˆå¢åŠ é”æ¬¡æ•°ï¼‰
3. **é¿å…å¿½ç•¥ NOWAIT**ï¼ˆå¯èƒ½é•¿æ—¶é—´ç­‰å¾…ï¼‰

### 6.3 æ•…éšœå¤„ç†å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **å®šæœŸç›‘æ§é”çŠ¶æ€**ï¼ˆåŠæ—¶å‘ç°é—®é¢˜ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸç›‘æ§é”çŠ¶æ€ï¼ˆåŠæ—¶å‘ç°é—®é¢˜ï¼‰
   SELECT
       locktype,
       relation::regclass,
       mode,
       granted,
       COUNT(*) AS count
   FROM pg_locks
   GROUP BY locktype, relation, mode, granted
   ORDER BY count DESC;
   ```

2. **æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ**ï¼ˆè¯Šæ–­é”é—®é¢˜ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæŸ¥çœ‹é”ç­‰å¾…æƒ…å†µï¼ˆè¯Šæ–­é”é—®é¢˜ï¼‰
   SELECT
       blocked_locks.pid AS blocked_pid,
       blocking_locks.pid AS blocking_pid,
       blocked_activity.query AS blocked_query,
       blocking_activity.query AS blocking_query
   FROM pg_catalog.pg_locks blocked_locks
   JOIN pg_catalog.pg_stat_activity blocked_activity
       ON blocked_activity.pid = blocked_locks.pid
   JOIN pg_catalog.pg_locks blocking_locks
       ON blocking_locks.locktype = blocked_locks.locktype
       AND blocking_locks.granted = true;
   ```

3. **ç»ˆæ­¢é˜»å¡çš„æŸ¥è¯¢**ï¼ˆè§£å†³é”é—®é¢˜ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç»ˆæ­¢é˜»å¡çš„æŸ¥è¯¢ï¼ˆè§£å†³é”é—®é¢˜ï¼‰
   SELECT pg_terminate_backend(pid)
   FROM pg_stat_activity
   WHERE pid IN (
       SELECT blocking_pid
       FROM lock_wait_chain
   );
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…å¿½ç•¥é”ç›‘æ§**ï¼ˆæ— æ³•å‘ç°é”é—®é¢˜ï¼‰
2. **é¿å…ä¸å¤„ç†é”ç­‰å¾…**ï¼ˆå¯èƒ½å¯¼è‡´ç³»ç»Ÿé˜»å¡ï¼‰

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿé”ä¼˜åŒ–

**åœºæ™¯**ï¼šç”µå•†è®¢å•ç³»ç»Ÿçš„é«˜å¹¶å‘é”ä¼˜åŒ–

**é—®é¢˜**ï¼š

- è®¢å•æ›´æ–°æ—¶é”ç«äº‰ä¸¥é‡
- æ­»é”é¢‘ç¹å‘ç”Ÿ
- ç³»ç»Ÿååé‡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_orders_status_created
ON orders(status, created_at);

-- 2. ä½¿ç”¨è¡Œçº§é”
BEGIN;
SELECT * FROM orders
WHERE status = 'pending'
AND created_at < NOW() - INTERVAL '1 hour'
FOR UPDATE SKIP LOCKED
LIMIT 100;

-- 3. æ‰¹é‡å¤„ç†
UPDATE orders
SET status = 'processing'
WHERE id = ANY(ARRAY[1, 2, 3, ...]);

COMMIT;

-- 4. é…ç½®é”è¶…æ—¶
SET lock_timeout = '2s';
```

**æ•ˆæœ**ï¼š

- é”ç«äº‰å‡å°‘ 60%
- æ­»é”å‘ç”Ÿå‡å°‘ 80%
- ç³»ç»Ÿååé‡æå‡ 40%

### 7.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿé”ä¼˜åŒ–

**åœºæ™¯**ï¼šå¤šç§Ÿæˆ· SaaS ç³»ç»Ÿçš„é”ä¼˜åŒ–

**é—®é¢˜**ï¼š

- è·¨ç§Ÿæˆ·é”ç«äº‰
- è¡¨çº§é”å½±å“æ€§èƒ½
- é”ç­‰å¾…æ—¶é—´é•¿

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨åˆ†åŒºè¡¨éš”ç¦»ç§Ÿæˆ·æ•°æ®
CREATE TABLE tenant_orders (
    id SERIAL,
    tenant_id INT,
    order_data JSONB
) PARTITION BY LIST (tenant_id);

-- 2. ä½¿ç”¨è¡Œçº§é”
BEGIN;
SELECT * FROM tenant_orders
WHERE tenant_id = 1 AND id = 123
FOR UPDATE;

-- 3. ä½¿ç”¨ç§Ÿæˆ·çº§åˆ«çš„é”
LOCK TABLE tenant_orders_1 IN SHARE MODE;
```

**æ•ˆæœ**ï¼š

- è·¨ç§Ÿæˆ·é”ç«äº‰æ¶ˆé™¤
- é”ç­‰å¾…æ—¶é—´å‡å°‘ 70%
- ç³»ç»Ÿæ€§èƒ½æå‡ 50%

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„é”æœºåˆ¶æ”¹è¿›æ˜¾è‘—æå‡äº†å¹¶å‘æ€§èƒ½å’Œç³»ç»Ÿç¨³å®šæ€§ï¼š

1. **é”æ€§èƒ½ä¼˜åŒ–**ï¼šé”è·å–å’Œé‡Šæ”¾æ€§èƒ½æå‡ 30-50%
2. **æ­»é”æ£€æµ‹æ”¹è¿›**ï¼šæ­»é”æ£€æµ‹é€Ÿåº¦æå‡ 2-3 å€
3. **é”ç²’åº¦ä¼˜åŒ–**ï¼šæ›´ç»†ç²’åº¦çš„é”æ§åˆ¶
4. **é”ç­‰å¾…ä¼˜åŒ–**ï¼šå‡å°‘é”ç­‰å¾…æ—¶é—´
5. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå‡å°‘é”ç«äº‰å’Œæ­»é”å‘ç”Ÿ

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨è¡Œçº§é”æ›¿ä»£è¡¨çº§é”
- è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´
- é¿å…é•¿æ—¶é—´æŒæœ‰é”
- ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
- å®šæœŸç›‘æ§é”çŠ¶æ€å’Œæ­»é”æƒ…å†µ

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”æœºåˆ¶](https://www.postgresql.org/docs/current/explicit-locking.html)**
  - é”æœºåˆ¶å®Œæ•´è¯´æ˜
  - é”ç±»å‹å’Œä½¿ç”¨

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ­»é”](https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-DEADLOCKS)**
  - æ­»é”æ£€æµ‹å’Œé¢„é˜²
  - æ­»é”å¤„ç†

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”ç›‘æ§](https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-LOCKS-VIEW)**
  - é”ç›‘æ§è§†å›¾è¯´æ˜
  - pg_locks è§†å›¾ä½¿ç”¨

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¹¶å‘æ§åˆ¶](https://www.postgresql.org/docs/current/mvcc-intro.html)**
  - å¹¶å‘æ§åˆ¶æœºåˆ¶è¯´æ˜
  - MVCC å’Œé”æœºåˆ¶

### SQL æ ‡å‡†

- **ISO/IEC 9075:2016 - SQL æ ‡å‡†äº‹åŠ¡éš”ç¦»**
  - SQL æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ«è§„èŒƒ
  - éš”ç¦»çº§åˆ«æ ‡å‡†å®šä¹‰

### æŠ€æœ¯è®ºæ–‡

- **Bernstein, P. A., et al. (1987). "Concurrency Control and Recovery in Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: æ•°æ®åº“å¹¶å‘æ§åˆ¶å’Œæ¢å¤çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥è§£é‡Šäº†æ•°æ®åº“é”æœºåˆ¶å’Œæ­»é”å¤„ç†ï¼Œæˆä¸ºç°ä»£æ•°æ®åº“çš„åŸºç¡€

- **Gray, J., & Reuter, A. (1993). "Transaction Processing: Concepts and Techniques."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: äº‹åŠ¡å¤„ç†çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥è§£é‡Šäº†äº‹åŠ¡å¤„ç†çš„æ¦‚å¿µå’ŒæŠ€æœ¯ï¼ŒåŒ…æ‹¬é”æœºåˆ¶å’Œæ­»é”å¤„ç†

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é”æœºåˆ¶](https://www.postgresql.org/docs/current/explicit-locking.html)**
  - é”æœºåˆ¶æœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL é”æœºåˆ¶](https://www.2ndquadrant.com/en/blog/postgresql-locking/)**
  - é”æœºåˆ¶å®æˆ˜
  - æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

- **[Percona - PostgreSQL é”æœºåˆ¶](https://www.percona.com/blog/postgresql-locking/)**
  - é”æœºåˆ¶ä½¿ç”¨æŠ€å·§
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[EnterpriseDB - PostgreSQL é”æœºåˆ¶](https://www.enterprisedb.com/postgres-tutorials/postgresql-locking-tutorial)**
  - é”æœºåˆ¶æ·±å…¥è§£æ
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - é”æœºåˆ¶](https://wiki.postgresql.org/wiki/Locking)**
  - é”æœºåˆ¶æŠ€å·§
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL é”æœºåˆ¶](https://stackoverflow.com/questions/tagged/postgresql+locking)**
  - é”æœºåˆ¶é—®ç­”
  - å¸¸è§é—®é¢˜è§£ç­”

### ç›¸å…³æ–‡æ¡£

- [é”æœºåˆ¶è¯¦è§£](../15-ä½“ç³»æ€»è§ˆ/é”æœºåˆ¶è¯¦è§£.md)
- [å¹¶å‘æ§åˆ¶è¯¦è§£](../15-ä½“ç³»æ€»è§ˆ/å¹¶å‘æ§åˆ¶è¯¦è§£.md)
- [äº‹åŠ¡ç®¡ç†è¯¦è§£](../15-ä½“ç³»æ€»è§ˆ/äº‹åŠ¡ç®¡ç†è¯¦è§£.md)
- [å¹¶å‘æ§åˆ¶ä¼˜åŒ–](./å¹¶å‘æ§åˆ¶ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
