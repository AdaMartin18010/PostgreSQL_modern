# PostgreSQL 17 æ€§èƒ½è¯Šæ–­æ”¹è¿›

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-14

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 å¯¹æ€§èƒ½è¯Šæ–­å·¥å…·è¿›è¡Œäº†é‡è¦æ”¹è¿›ï¼ŒåŒ…æ‹¬æ–°çš„è¯Šæ–­è§†å›¾ã€æ€§èƒ½åˆ†æå·¥å…·ã€æŸ¥è¯¢è¿½è¸ªå¢å¼ºç­‰ï¼Œä½¿å¾—æ€§èƒ½é—®é¢˜çš„å®šä½å’Œåˆ†ææ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **è¯Šæ–­å·¥å…·å¢å¼º**ï¼šæ–°çš„æ€§èƒ½è¯Šæ–­è§†å›¾å’Œå·¥å…·
- **æŸ¥è¯¢è¿½è¸ªæ”¹è¿›**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯
- **æ€§èƒ½åˆ†æä¼˜åŒ–**ï¼šæ›´å‡†ç¡®çš„æ€§èƒ½åˆ†æç»“æœ
- **é—®é¢˜å®šä½å¿«é€Ÿ**ï¼šå¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ
- **ç›‘æ§èƒ½åŠ›æå‡**ï¼šæ›´å…¨é¢çš„æ€§èƒ½ç›‘æ§

## ğŸ“š ç›®å½•

- [PostgreSQL 17 æ€§èƒ½è¯Šæ–­æ”¹è¿›](#postgresql-17-æ€§èƒ½è¯Šæ–­æ”¹è¿›)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. æ€§èƒ½è¯Šæ–­æ”¹è¿›æ¦‚è¿°](#1-æ€§èƒ½è¯Šæ–­æ”¹è¿›æ¦‚è¿°)
    - [1.1 PostgreSQL 17 æ”¹è¿›äº®ç‚¹](#11-postgresql-17-æ”¹è¿›äº®ç‚¹)
    - [1.2 åŠŸèƒ½å¯¹æ¯”](#12-åŠŸèƒ½å¯¹æ¯”)
  - [2. æ–°è¯Šæ–­è§†å›¾](#2-æ–°è¯Šæ–­è§†å›¾)
    - [2.1 pg\_stat\_statements å¢å¼º](#21-pg_stat_statements-å¢å¼º)
    - [2.2 pg\_stat\_progress è§†å›¾](#22-pg_stat_progress-è§†å›¾)
    - [2.3 pg\_stat\_activity å¢å¼º](#23-pg_stat_activity-å¢å¼º)
  - [3. æŸ¥è¯¢è¿½è¸ªå¢å¼º](#3-æŸ¥è¯¢è¿½è¸ªå¢å¼º)
    - [3.1 æ‰§è¡Œè®¡åˆ’è¿½è¸ª](#31-æ‰§è¡Œè®¡åˆ’è¿½è¸ª)
    - [3.2 æŸ¥è¯¢ç»Ÿè®¡è¿½è¸ª](#32-æŸ¥è¯¢ç»Ÿè®¡è¿½è¸ª)
    - [3.3 ç­‰å¾…äº‹ä»¶è¿½è¸ª](#33-ç­‰å¾…äº‹ä»¶è¿½è¸ª)
  - [4. æ€§èƒ½åˆ†æå·¥å…·](#4-æ€§èƒ½åˆ†æå·¥å…·)
    - [4.1 EXPLAIN å¢å¼º](#41-explain-å¢å¼º)
    - [4.2 æ€§èƒ½åˆ†æè„šæœ¬](#42-æ€§èƒ½åˆ†æè„šæœ¬)
    - [4.3 è‡ªåŠ¨åŒ–è¯Šæ–­](#43-è‡ªåŠ¨åŒ–è¯Šæ–­)
  - [5. ç›‘æ§å’Œå‘Šè­¦](#5-ç›‘æ§å’Œå‘Šè­¦)
    - [5.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#51-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
    - [5.2 æ…¢æŸ¥è¯¢ç›‘æ§](#52-æ…¢æŸ¥è¯¢ç›‘æ§)
    - [5.3 å‘Šè­¦é…ç½®](#53-å‘Šè­¦é…ç½®)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 è¯Šæ–­æµç¨‹å»ºè®®](#61-è¯Šæ–­æµç¨‹å»ºè®®)
    - [6.2 æ€§èƒ½åˆ†æå»ºè®®](#62-æ€§èƒ½åˆ†æå»ºè®®)
    - [6.3 ç›‘æ§é…ç½®å»ºè®®](#63-ç›‘æ§é…ç½®å»ºè®®)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–](#71-æ¡ˆä¾‹æ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–)
    - [7.2 æ¡ˆä¾‹ï¼šæ€§èƒ½ç“¶é¢ˆå®šä½](#72-æ¡ˆä¾‹æ€§èƒ½ç“¶é¢ˆå®šä½)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. æ€§èƒ½è¯Šæ–­æ”¹è¿›æ¦‚è¿°

### 1.1 PostgreSQL 17 æ”¹è¿›äº®ç‚¹

PostgreSQL 17 åœ¨æ€§èƒ½è¯Šæ–­æ–¹é¢çš„ä¸»è¦æ”¹è¿›ï¼š

- **æ–°è¯Šæ–­è§†å›¾**ï¼špg_stat_progress_vacuumã€pg_stat_progress_cluster ç­‰
- **æŸ¥è¯¢è¿½è¸ªå¢å¼º**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯
- **æ€§èƒ½åˆ†æä¼˜åŒ–**ï¼šæ›´å‡†ç¡®çš„æ€§èƒ½åˆ†æç»“æœ
- **è‡ªåŠ¨åŒ–è¯Šæ–­**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–æ€§èƒ½è¯Šæ–­
- **ç›‘æ§èƒ½åŠ›æå‡**ï¼šæ›´å…¨é¢çš„æ€§èƒ½ç›‘æ§

### 1.2 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | PostgreSQL 16 | PostgreSQL 17 |
|------|--------------|---------------|
| è¿›åº¦è§†å›¾ | åŸºç¡€ | å¢å¼º |
| æŸ¥è¯¢è¿½è¸ª | æ”¯æŒ | å¢å¼º |
| æ€§èƒ½åˆ†æ | åŸºç¡€ | ä¼˜åŒ– |
| è‡ªåŠ¨åŒ–è¯Šæ–­ | âŒ | âœ… |

---

## 2. æ–°è¯Šæ–­è§†å›¾

### 2.1 pg_stat_statements å¢å¼º

```sql
-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡ï¼ˆPostgreSQL 17 å¢å¼ºï¼‰
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 20;

-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’ç»Ÿè®¡
SELECT
    query,
    plans,
    total_plan_time,
    mean_plan_time,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
WHERE plans > 0
ORDER BY total_plan_time DESC
LIMIT 20;
```

### 2.2 pg_stat_progress è§†å›¾

```sql
-- æŸ¥çœ‹ VACUUM è¿›åº¦
SELECT
    pid,
    datname,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples
FROM pg_stat_progress_vacuum;

-- æŸ¥çœ‹ CLUSTER è¿›åº¦
SELECT
    pid,
    datname,
    relid::regclass,
    command,
    phase,
    cluster_index_relid::regclass,
    heap_tuples_scanned,
    heap_tuples_written,
    heap_blks_total,
    heap_blks_scanned
FROM pg_stat_progress_cluster;

-- æŸ¥çœ‹ CREATE INDEX è¿›åº¦
SELECT
    pid,
    datname,
    relid::regclass,
    index_relid::regclass,
    command,
    phase,
    tuples_total,
    tuples_done,
    partitions_total,
    partitions_done
FROM pg_stat_progress_create_index;
```

### 2.3 pg_stat_activity å¢å¼º

```sql
-- æŸ¥çœ‹æ´»åŠ¨è¿æ¥ï¼ˆPostgreSQL 17 å¢å¼ºï¼‰
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    wait_event_type,
    wait_event,
    query_start,
    state_change,
    backend_start,
    xact_start,
    query_start,
    state_change,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- æŸ¥çœ‹ç­‰å¾…äº‹ä»¶ç»Ÿè®¡
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
```

---

## 3. æŸ¥è¯¢è¿½è¸ªå¢å¼º

### 3.1 æ‰§è¡Œè®¡åˆ’è¿½è¸ª

```sql
-- å¯ç”¨æŸ¥è¯¢è¿½è¸ª
SET track_io_timing = on;
SET track_functions = all;

-- æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
SELECT * FROM orders WHERE status = 'pending';

-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡
SELECT
    query,
    plans,
    total_plan_time,
    mean_plan_time,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%orders%'
ORDER BY total_exec_time DESC;
```

### 3.2 æŸ¥è¯¢ç»Ÿè®¡è¿½è¸ª

```sql
-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡è¯¦æƒ…
SELECT
    queryid,
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    shared_blks_hit,
    shared_blks_read,
    shared_blks_dirtied,
    shared_blks_written,
    local_blks_hit,
    local_blks_read,
    local_blks_dirtied,
    local_blks_written,
    temp_blks_read,
    temp_blks_written,
    blk_read_time,
    blk_write_time
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 3.3 ç­‰å¾…äº‹ä»¶è¿½è¸ª

```sql
-- æŸ¥çœ‹ç­‰å¾…äº‹ä»¶
SELECT
    pid,
    usename,
    application_name,
    wait_event_type,
    wait_event,
    state,
    query
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
ORDER BY wait_event_type, wait_event;

-- æŸ¥çœ‹ç­‰å¾…äº‹ä»¶ç»Ÿè®¡
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count,
    AVG(EXTRACT(EPOCH FROM (now() - state_change))) AS avg_wait_time
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
```

---

## 4. æ€§èƒ½åˆ†æå·¥å…·

### 4.1 EXPLAIN å¢å¼º

```sql
-- è¯¦ç»†æ‰§è¡Œè®¡åˆ’åˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING, SUMMARY, FORMAT JSON)
SELECT * FROM orders WHERE status = 'pending';

-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æ ‘
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING, FORMAT TEXT)
SELECT
    o.id,
    o.order_date,
    SUM(oi.amount) AS total_amount
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
WHERE o.status = 'pending'
GROUP BY o.id, o.order_date;

-- æŸ¥çœ‹å¹¶è¡Œæ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING, FORMAT TEXT)
SELECT * FROM orders
WHERE order_date BETWEEN '2025-01-01' AND '2025-01-31';
```

### 4.2 æ€§èƒ½åˆ†æè„šæœ¬

```sql
-- æŸ¥æ‰¾æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡ 1 ç§’
AND query NOT LIKE '%pg_stat_statements%'
ORDER BY mean_exec_time DESC
LIMIT 20;

-- æŸ¥æ‰¾é«˜ I/O æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    shared_blks_read,
    shared_blks_hit,
    blk_read_time,
    blk_write_time
FROM pg_stat_statements
WHERE shared_blks_read > 1000
AND query NOT LIKE '%pg_stat_statements%'
ORDER BY shared_blks_read DESC
LIMIT 20;

-- æŸ¥æ‰¾é¢‘ç¹æ‰§è¡Œçš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    rows
FROM pg_stat_statements
WHERE calls > 10000
AND query NOT LIKE '%pg_stat_statements%'
ORDER BY calls DESC
LIMIT 20;
```

### 4.3 è‡ªåŠ¨åŒ–è¯Šæ–­

```sql
-- åˆ›å»ºæ€§èƒ½è¯Šæ–­å‡½æ•°
CREATE OR REPLACE FUNCTION diagnose_performance()
RETURNS TABLE (
    metric TEXT,
    value NUMERIC,
    threshold NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'slow_queries'::TEXT,
        COUNT(*)::NUMERIC,
        10::NUMERIC,
        CASE WHEN COUNT(*) > 10 THEN 'WARNING' ELSE 'OK' END
    FROM pg_stat_statements
    WHERE mean_exec_time > 1000;

    RETURN QUERY
    SELECT
        'high_io_queries'::TEXT,
        COUNT(*)::NUMERIC,
        5::NUMERIC,
        CASE WHEN COUNT(*) > 5 THEN 'WARNING' ELSE 'OK' END
    FROM pg_stat_statements
    WHERE shared_blks_read > 10000;

    RETURN QUERY
    SELECT
        'cache_hit_ratio'::TEXT,
        (SELECT
            100.0 * SUM(shared_blks_hit) / NULLIF(SUM(shared_blks_hit) + SUM(shared_blks_read), 0)
         FROM pg_stat_statements)::NUMERIC,
        95::NUMERIC,
        CASE
            WHEN (SELECT 100.0 * SUM(shared_blks_hit) / NULLIF(SUM(shared_blks_hit) + SUM(shared_blks_read), 0)
                  FROM pg_stat_statements) < 95
            THEN 'WARNING'
            ELSE 'OK'
        END;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ€§èƒ½è¯Šæ–­
SELECT * FROM diagnose_performance();
```

---

## 5. ç›‘æ§å’Œå‘Šè­¦

### 5.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

```sql
-- ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS cache_hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted,
    conflicts,
    temp_files,
    temp_bytes,
    deadlocks
FROM pg_stat_database
WHERE datname = current_database();

-- ç›‘æ§è¡¨æ€§èƒ½æŒ‡æ ‡
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY seq_scan DESC;
```

### 5.2 æ…¢æŸ¥è¯¢ç›‘æ§

```sql
-- åˆ›å»ºæ…¢æŸ¥è¯¢ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW slow_queries AS
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡ 1 ç§’
AND query NOT LIKE '%pg_stat_statements%'
ORDER BY mean_exec_time DESC;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM slow_queries LIMIT 20;

-- ç›‘æ§æ…¢æŸ¥è¯¢è¶‹åŠ¿
SELECT
    DATE_TRUNC('hour', now()) AS hour,
    COUNT(*) AS slow_query_count,
    AVG(mean_exec_time) AS avg_exec_time
FROM slow_queries
GROUP BY DATE_TRUNC('hour', now())
ORDER BY hour DESC;
```

### 5.3 å‘Šè­¦é…ç½®

```sql
-- åˆ›å»ºæ€§èƒ½å‘Šè­¦å‡½æ•°
CREATE OR REPLACE FUNCTION check_performance_alerts()
RETURNS TABLE (
    alert_type TEXT,
    message TEXT,
    severity TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
    IF (SELECT 100.0 * SUM(shared_blks_hit) / NULLIF(SUM(shared_blks_hit) + SUM(shared_blks_read), 0)
        FROM pg_stat_statements) < 95 THEN
        RETURN QUERY SELECT
            'cache_hit_ratio'::TEXT,
            'Cache hit ratio is below 95%'::TEXT,
            'WARNING'::TEXT;
    END IF;

    -- æ£€æŸ¥æ…¢æŸ¥è¯¢æ•°é‡
    IF (SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000) > 10 THEN
        RETURN QUERY SELECT
            'slow_queries'::TEXT,
            'Too many slow queries detected'::TEXT,
            'WARNING'::TEXT;
    END IF;

    -- æ£€æŸ¥æ­»é”
    IF (SELECT deadlocks FROM pg_stat_database WHERE datname = current_database()) > 0 THEN
        RETURN QUERY SELECT
            'deadlocks'::TEXT,
            'Deadlocks detected'::TEXT,
            'ERROR'::TEXT;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œå‘Šè­¦æ£€æŸ¥
SELECT * FROM check_performance_alerts();
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 è¯Šæ–­æµç¨‹å»ºè®®

```sql
-- 1. æŸ¥çœ‹æ•´ä½“æ€§èƒ½æŒ‡æ ‡
SELECT * FROM pg_stat_database WHERE datname = current_database();

-- 2. æŸ¥æ‰¾æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 3. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
-- æ…¢æŸ¥è¯¢è¯­å¥

-- 4. æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT * FROM pg_stat_activity WHERE wait_event IS NOT NULL;

-- 5. æ£€æŸ¥èµ„æºä½¿ç”¨
SELECT * FROM pg_stat_progress_vacuum;
```

### 6.2 æ€§èƒ½åˆ†æå»ºè®®

```sql
-- å®šæœŸåˆ†ææŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    mean_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 20;

-- åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 6.3 ç›‘æ§é…ç½®å»ºè®®

```sql
-- é…ç½®æ€§èƒ½è¿½è¸ª
-- postgresql.conf
track_io_timing = on
track_functions = all
track_activity_query_size = 2048

-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- é…ç½® pg_stat_statements
-- postgresql.conf
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
```

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–

**åœºæ™¯**ï¼šç”µå•†ç³»ç»Ÿçš„æ…¢æŸ¥è¯¢è¯Šæ–­å’Œä¼˜åŒ–

**é—®é¢˜**ï¼š

- è®¢å•æŸ¥è¯¢å“åº”æ—¶é—´è¶…è¿‡ 5 ç§’
- ç³»ç»Ÿè´Ÿè½½é«˜
- ç”¨æˆ·ä½“éªŒå·®

**è¯Šæ–­è¿‡ç¨‹**ï¼š

```sql
-- 1. æŸ¥æ‰¾æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE query LIKE '%orders%'
AND mean_exec_time > 1000
ORDER BY mean_exec_time DESC;

-- 2. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
SELECT * FROM orders
WHERE status = 'pending'
AND order_date > '2025-01-01';

-- 3. å‘ç°é—®é¢˜ï¼šç¼ºå°‘ç´¢å¼•
CREATE INDEX idx_orders_status_date
ON orders(status, order_date);

-- 4. éªŒè¯ä¼˜åŒ–æ•ˆæœ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
SELECT * FROM orders
WHERE status = 'pending'
AND order_date > '2025-01-01';
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢å“åº”æ—¶é—´ä» 5 ç§’é™è‡³ 50 æ¯«ç§’
- ç³»ç»Ÿè´Ÿè½½é™ä½ 60%
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

### 7.2 æ¡ˆä¾‹ï¼šæ€§èƒ½ç“¶é¢ˆå®šä½

**åœºæ™¯**ï¼šæ•°æ®åˆ†æç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆå®šä½

**é—®é¢˜**ï¼š

- æŠ¥è¡¨ç”Ÿæˆæ—¶é—´è¿‡é•¿
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡é«˜
- æ— æ³•å®šä½å…·ä½“ç“¶é¢ˆ

**è¯Šæ–­è¿‡ç¨‹**ï¼š

```sql
-- 1. æŸ¥çœ‹ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event;

-- 2. æŸ¥çœ‹ I/O ç»Ÿè®¡
SELECT
    query,
    shared_blks_read,
    shared_blks_hit,
    blk_read_time,
    blk_write_time
FROM pg_stat_statements
WHERE shared_blks_read > 10000
ORDER BY shared_blks_read DESC;

-- 3. æŸ¥çœ‹ VACUUM è¿›åº¦
SELECT * FROM pg_stat_progress_vacuum;

-- 4. å‘ç°é—®é¢˜ï¼šè¡¨éœ€è¦ VACUUM
VACUUM ANALYZE large_table;

-- 5. ä¼˜åŒ–æŸ¥è¯¢
-- æ·»åŠ ç´¢å¼•ã€ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ç­‰
```

**æ•ˆæœ**ï¼š

- æŠ¥è¡¨ç”Ÿæˆæ—¶é—´ä» 10 åˆ†é’Ÿé™è‡³ 2 åˆ†é’Ÿ
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡é™ä½ 40%
- æ€§èƒ½ç“¶é¢ˆæ¸…æ™°å®šä½

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„æ€§èƒ½è¯Šæ–­æ”¹è¿›æ˜¾è‘—æå‡äº†æ€§èƒ½é—®é¢˜çš„å®šä½å’Œåˆ†æèƒ½åŠ›ï¼š

1. **æ–°è¯Šæ–­è§†å›¾**ï¼špg_stat_progress_vacuumã€pg_stat_progress_cluster ç­‰
2. **æŸ¥è¯¢è¿½è¸ªå¢å¼º**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯
3. **æ€§èƒ½åˆ†æä¼˜åŒ–**ï¼šæ›´å‡†ç¡®çš„æ€§èƒ½åˆ†æç»“æœ
4. **è‡ªåŠ¨åŒ–è¯Šæ–­**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–æ€§èƒ½è¯Šæ–­
5. **ç›‘æ§èƒ½åŠ›æå‡**ï¼šæ›´å…¨é¢çš„æ€§èƒ½ç›‘æ§

**æœ€ä½³å®è·µ**ï¼š

- å®šæœŸåˆ†ææŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
- ä½¿ç”¨ EXPLAIN åˆ†ææ‰§è¡Œè®¡åˆ’
- ç›‘æ§ç­‰å¾…äº‹ä»¶å’Œèµ„æºä½¿ç”¨
- é…ç½®åˆç†çš„æ€§èƒ½å‘Šè­¦
- å»ºç«‹ç³»ç»ŸåŒ–çš„è¯Šæ–­æµç¨‹

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
