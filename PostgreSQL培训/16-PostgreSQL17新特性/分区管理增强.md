# PostgreSQL 17 åˆ†åŒºç®¡ç†å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-08

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 å¯¹åˆ†åŒºè¡¨ç®¡ç†è¿›è¡Œäº†é‡è¦å¢å¼ºï¼ŒåŒ…æ‹¬åˆ†åŒºæ“ä½œæ”¹è¿›ã€ç®¡ç†å·¥å…·å¢å¼ºã€è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†ç­‰åŠŸèƒ½ï¼Œä½¿å¾—åˆ†åŒºè¡¨çš„ç®¡ç†æ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **åˆ†åŒºæ“ä½œæ”¹è¿›**ï¼šæ›´å¿«é€Ÿçš„åˆ†åŒºæ“ä½œ
- **ç®¡ç†å·¥å…·å¢å¼º**ï¼šæ›´å¼ºå¤§çš„ç®¡ç†å·¥å…·
- **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†åŒºæ“ä½œæ€§èƒ½æå‡
- **æ˜“ç”¨æ€§æå‡**ï¼šç®€åŒ–åˆ†åŒºç®¡ç†æµç¨‹

## ğŸ“š ç›®å½•

- [PostgreSQL 17 åˆ†åŒºç®¡ç†å¢å¼º](#postgresql-17-åˆ†åŒºç®¡ç†å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. åˆ†åŒºç®¡ç†å¢å¼ºæ¦‚è¿°](#1-åˆ†åŒºç®¡ç†å¢å¼ºæ¦‚è¿°)
    - [1.0 åˆ†åŒºç®¡ç†å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°](#10-åˆ†åŒºç®¡ç†å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 PostgreSQL 17 å¢å¼ºäº®ç‚¹](#11-postgresql-17-å¢å¼ºäº®ç‚¹)
    - [1.2 åŠŸèƒ½å¯¹æ¯”](#12-åŠŸèƒ½å¯¹æ¯”)
  - [2. åˆ†åŒºæ“ä½œæ”¹è¿›](#2-åˆ†åŒºæ“ä½œæ”¹è¿›)
    - [2.1 åˆ†åŒºæ·»åŠ ä¼˜åŒ–](#21-åˆ†åŒºæ·»åŠ ä¼˜åŒ–)
    - [2.2 åˆ†åŒºåˆ é™¤ä¼˜åŒ–](#22-åˆ†åŒºåˆ é™¤ä¼˜åŒ–)
    - [2.3 åˆ†åŒºåˆå¹¶ä¼˜åŒ–](#23-åˆ†åŒºåˆå¹¶ä¼˜åŒ–)
    - [2.4 åˆ†åŒºæ‹†åˆ†ä¼˜åŒ–](#24-åˆ†åŒºæ‹†åˆ†ä¼˜åŒ–)
  - [3. ç®¡ç†å·¥å…·å¢å¼º](#3-ç®¡ç†å·¥å…·å¢å¼º)
    - [3.1 åˆ†åŒºä¿¡æ¯æŸ¥è¯¢](#31-åˆ†åŒºä¿¡æ¯æŸ¥è¯¢)
    - [3.2 åˆ†åŒºç»Ÿè®¡ä¿¡æ¯](#32-åˆ†åŒºç»Ÿè®¡ä¿¡æ¯)
    - [3.3 åˆ†åŒºç»´æŠ¤å·¥å…·](#33-åˆ†åŒºç»´æŠ¤å·¥å…·)
  - [4. è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†](#4-è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†)
    - [4.1 è‡ªåŠ¨åˆ†åŒºåˆ›å»º](#41-è‡ªåŠ¨åˆ†åŒºåˆ›å»º)
    - [4.2 è‡ªåŠ¨åˆ†åŒºåˆ é™¤](#42-è‡ªåŠ¨åˆ†åŒºåˆ é™¤)
    - [4.3 åˆ†åŒºç­–ç•¥é…ç½®](#43-åˆ†åŒºç­–ç•¥é…ç½®)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 åˆ†åŒºè®¾è®¡å»ºè®®](#51-åˆ†åŒºè®¾è®¡å»ºè®®)
    - [5.2 ç®¡ç†å»ºè®®](#52-ç®¡ç†å»ºè®®)
    - [5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#53-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [6. å®é™…æ¡ˆä¾‹](#6-å®é™…æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹ï¼šæ—¶é—´åºåˆ—æ•°æ®åˆ†åŒºç®¡ç†](#61-æ¡ˆä¾‹æ—¶é—´åºåˆ—æ•°æ®åˆ†åŒºç®¡ç†)
    - [6.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·æ•°æ®åˆ†åŒºç®¡ç†](#62-æ¡ˆä¾‹å¤šç§Ÿæˆ·æ•°æ®åˆ†åŒºç®¡ç†)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [SQL æ ‡å‡†](#sql-æ ‡å‡†)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. åˆ†åŒºç®¡ç†å¢å¼ºæ¦‚è¿°

### 1.0 åˆ†åŒºç®¡ç†å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°

**åˆ†åŒºç®¡ç†å¢å¼ºçš„æœ¬è´¨**ï¼š

PostgreSQL 17 çš„åˆ†åŒºç®¡ç†å¢å¼ºåŸºäºæ”¹è¿›çš„åˆ†åŒºæ“ä½œç®—æ³•ã€è‡ªåŠ¨åŒ–ç®¡ç†æœºåˆ¶å’Œå¢å¼ºçš„ç®¡ç†å·¥å…·ã€‚
åˆ†åŒºç®¡ç†æ˜¯æ•°æ®åº“ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡åˆç†çš„åˆ†åŒºç­–ç•¥å¯ä»¥æå‡æŸ¥è¯¢æ€§èƒ½ã€ç®€åŒ–æ•°æ®ç®¡ç†ã€‚
PostgreSQL 17 é€šè¿‡ä¼˜åŒ–åˆ†åŒºæ·»åŠ /åˆ é™¤æ“ä½œã€æ”¯æŒè‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†ã€å¢å¼ºåˆ†åŒºç»Ÿè®¡ä¿¡æ¯ï¼Œ
æ˜¾è‘—æå‡äº†åˆ†åŒºè¡¨çš„ç®¡ç†æ•ˆç‡å’Œæ€§èƒ½ã€‚

**åˆ†åŒºç®¡ç†å¢å¼ºæ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[åˆ†åŒºç®¡ç†éœ€æ±‚] --> B{æ“ä½œç±»å‹}
    B -->|æ·»åŠ åˆ†åŒº| C[åˆ†åŒºæ·»åŠ ä¼˜åŒ–]
    B -->|åˆ é™¤åˆ†åŒº| D[åˆ†åŒºåˆ é™¤ä¼˜åŒ–]
    B -->|åˆå¹¶åˆ†åŒº| E[åˆ†åŒºåˆå¹¶ä¼˜åŒ–]
    B -->|æ‹†åˆ†åˆ†åŒº| F[åˆ†åŒºæ‹†åˆ†ä¼˜åŒ–]
    C --> G[è‡ªåŠ¨åŒ–ç®¡ç†æ£€æŸ¥]
    D --> G
    E --> G
    F --> G
    G -->|éœ€è¦è‡ªåŠ¨åŒ–| H[è‡ªåŠ¨åˆ†åŒºåˆ›å»º/åˆ é™¤]
    G -->|æ‰‹åŠ¨ç®¡ç†| I[æ‰§è¡Œåˆ†åŒºæ“ä½œ]
    H --> J[æ›´æ–°ç»Ÿè®¡ä¿¡æ¯]
    I --> J
    J --> K[å®Œæˆåˆ†åŒºç®¡ç†]

    style B fill:#FFD700
    style G fill:#90EE90
    style H fill:#87CEEB
    style K fill:#87CEEB
```

**åˆ†åŒºç®¡ç†å¢å¼ºæ‰§è¡Œæ­¥éª¤**ï¼š

1. **è¯†åˆ«æ“ä½œç±»å‹**ï¼šç¡®å®šéœ€è¦æ‰§è¡Œçš„åˆ†åŒºæ“ä½œï¼ˆæ·»åŠ /åˆ é™¤/åˆå¹¶/æ‹†åˆ†ï¼‰
2. **ä¼˜åŒ–æ“ä½œç®—æ³•**ï¼šä½¿ç”¨æ”¹è¿›çš„ç®—æ³•æ‰§è¡Œåˆ†åŒºæ“ä½œ
3. **è‡ªåŠ¨åŒ–ç®¡ç†æ£€æŸ¥**ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨åŒ–ç®¡ç†
4. **æ‰§è¡Œåˆ†åŒºæ“ä½œ**ï¼šæ‰§è¡Œåˆ†åŒºæ·»åŠ /åˆ é™¤/åˆå¹¶/æ‹†åˆ†æ“ä½œ
5. **æ›´æ–°ç»Ÿè®¡ä¿¡æ¯**ï¼šæ›´æ–°åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
6. **å®Œæˆåˆ†åŒºç®¡ç†**ï¼šå®Œæˆåˆ†åŒºç®¡ç†æ“ä½œ

### 1.1 PostgreSQL 17 å¢å¼ºäº®ç‚¹

PostgreSQL 17 åœ¨åˆ†åŒºç®¡ç†æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **åˆ†åŒºæ“ä½œæ€§èƒ½æå‡**ï¼šåˆ†åŒºæ·»åŠ /åˆ é™¤é€Ÿåº¦æå‡ 2-3 å€
- **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šæ”¯æŒè‡ªåŠ¨åˆ›å»ºå’Œåˆ é™¤åˆ†åŒº
- **ç®¡ç†å·¥å…·å¢å¼º**ï¼šæ›´å¼ºå¤§çš„åˆ†åŒºç®¡ç†å·¥å…·
- **ç»Ÿè®¡ä¿¡æ¯æ”¹è¿›**ï¼šæ›´è¯¦ç»†çš„åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
- **æ“ä½œç®€åŒ–**ï¼šç®€åŒ–åˆ†åŒºç®¡ç†æ“ä½œæµç¨‹

### 1.2 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | PostgreSQL 16 | PostgreSQL 17 |
|------|--------------|---------------|
| è‡ªåŠ¨åˆ†åŒºåˆ›å»º | âŒ | âœ… |
| è‡ªåŠ¨åˆ†åŒºåˆ é™¤ | âŒ | âœ… |
| åˆ†åŒºåˆå¹¶ | æ”¯æŒ | ä¼˜åŒ– |
| åˆ†åŒºæ‹†åˆ† | æ”¯æŒ | ä¼˜åŒ– |
| åˆ†åŒºç»Ÿè®¡ | åŸºç¡€ | å¢å¼º |

---

## 2. åˆ†åŒºæ“ä½œæ”¹è¿›

### 2.1 åˆ†åŒºæ·»åŠ ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE orders (
    id SERIAL,
    order_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (order_date);

-- å¿«é€Ÿæ·»åŠ åˆ†åŒº
CREATE TABLE orders_2025_01 PARTITION OF orders
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- æ‰¹é‡æ·»åŠ åˆ†åŒº
DO $$
DECLARE
    month_date DATE;
BEGIN
    FOR i IN 1..12 LOOP
        month_date := DATE '2025-01-01' + (i-1) * INTERVAL '1 month';
        EXECUTE format(
            'CREATE TABLE orders_%s PARTITION OF orders
             FOR VALUES FROM (%L) TO (%L)',
            to_char(month_date, 'YYYY_MM'),
            month_date,
            month_date + INTERVAL '1 month'
        );
    END LOOP;
END $$;
```

### 2.2 åˆ†åŒºåˆ é™¤ä¼˜åŒ–

```sql
-- åˆ é™¤åˆ†åŒºï¼ˆå¿«é€Ÿï¼‰
DROP TABLE orders_2024_01;

-- åˆ é™¤åˆ†åŒºå¹¶ä¿ç•™æ•°æ®
ALTER TABLE orders DETACH PARTITION orders_2024_01;

-- æ‰¹é‡åˆ é™¤æ—§åˆ†åŒº
DO $$
DECLARE
    partition_name TEXT;
BEGIN
    FOR partition_name IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
        AND tablename LIKE 'orders_2024%'
    LOOP
        EXECUTE format('DROP TABLE %I', partition_name);
    END LOOP;
END $$;
```

### 2.3 åˆ†åŒºåˆå¹¶ä¼˜åŒ–

```sql
-- åˆå¹¶åˆ†åŒºï¼ˆPostgreSQL 17 ä¼˜åŒ–ï¼‰
-- å°†ä¸¤ä¸ªç›¸é‚»åˆ†åŒºåˆå¹¶ä¸ºä¸€ä¸ª
ALTER TABLE orders
MERGE PARTITIONS orders_2025_01, orders_2025_02
INTO orders_2025_q1;
```

### 2.4 åˆ†åŒºæ‹†åˆ†ä¼˜åŒ–

```sql
-- æ‹†åˆ†åˆ†åŒº
ALTER TABLE orders
SPLIT PARTITION orders_2025_q1
AT ('2025-02-01')
INTO (
    PARTITION orders_2025_01,
    PARTITION orders_2025_02
);
```

---

## 3. ç®¡ç†å·¥å…·å¢å¼º

### 3.1 åˆ†åŒºä¿¡æ¯æŸ¥è¯¢

```sql
-- æŸ¥çœ‹åˆ†åŒºè¡¨ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    partitiontype,
    partitionkey
FROM pg_partitioned_tables
WHERE schemaname = 'public';

-- æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº
SELECT
    schemaname,
    tablename,
    partitionbounddef
FROM pg_partitions
WHERE parenttablename = 'orders'
ORDER BY tablename;
```

### 3.2 åˆ†åŒºç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename LIKE 'orders_%'
ORDER BY tablename;

-- æŸ¥çœ‹åˆ†åŒºå¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
AND tablename LIKE 'orders_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.3 åˆ†åŒºç»´æŠ¤å·¥å…·

```sql
-- æ£€æŸ¥åˆ†åŒºå®Œæ•´æ€§
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
WHERE tablename LIKE 'orders_%'
ORDER BY tablename;

-- åˆ†ææ‰€æœ‰åˆ†åŒº
DO $$
DECLARE
    partition_name TEXT;
BEGIN
    FOR partition_name IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
        AND tablename LIKE 'orders_%'
    LOOP
        EXECUTE format('ANALYZE %I', partition_name);
    END LOOP;
END $$;
```

---

## 4. è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†

### 4.1 è‡ªåŠ¨åˆ†åŒºåˆ›å»º

```sql
-- ä½¿ç”¨ pg_partman è‡ªåŠ¨åˆ›å»ºåˆ†åŒº
-- å®‰è£… pg_partman
CREATE EXTENSION IF NOT EXISTS pg_partman;

-- é…ç½®è‡ªåŠ¨åˆ†åŒº
SELECT partman.create_parent(
    p_parent_table => 'public.orders',
    p_control => 'order_date',
    p_type => 'range',
    p_interval => 'monthly',
    p_premake => 3
);

-- è‡ªåŠ¨åˆ›å»ºæœªæ¥ 3 ä¸ªæœˆçš„åˆ†åŒº
SELECT partman.run_maintenance('public.orders');
```

### 4.2 è‡ªåŠ¨åˆ†åŒºåˆ é™¤

```sql
-- é…ç½®è‡ªåŠ¨åˆ é™¤æ—§åˆ†åŒº
SELECT partman.set_config(
    p_parent_table => 'public.orders',
    p_retention => '12 months',
    p_retention_keep_table => false
);

-- æ‰§è¡Œç»´æŠ¤ä»»åŠ¡ï¼ˆåˆ é™¤è¶…è¿‡ 12 ä¸ªæœˆçš„åˆ†åŒºï¼‰
SELECT partman.run_maintenance('public.orders');
```

### 4.3 åˆ†åŒºç­–ç•¥é…ç½®

```sql
-- é…ç½®åˆ†åŒºç­–ç•¥
SELECT partman.set_config(
    p_parent_table => 'public.orders',
    p_control => 'order_date',
    p_type => 'range',
    p_interval => 'monthly',
    p_premake => 3,
    p_retention => '12 months',
    p_retention_keep_table => false,
    p_automatic_maintenance => true
);

-- å¯ç”¨è‡ªåŠ¨ç»´æŠ¤
SELECT cron.schedule(
    'partition-maintenance',
    '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨ 2 ç‚¹
    $$SELECT partman.run_maintenance('public.orders')$$
);
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 åˆ†åŒºè®¾è®¡å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **æŒ‰æ—¶é—´èŒƒå›´åˆ†åŒº**ï¼ˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæŒ‰æ—¶é—´èŒƒå›´åˆ†åŒºï¼ˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰
   CREATE TABLE orders (
       id SERIAL,
       order_date DATE NOT NULL,
       amount DECIMAL(10,2)
   ) PARTITION BY RANGE (order_date);

   -- åˆ›å»ºåˆ†åŒº
   CREATE TABLE orders_2025_01 PARTITION OF orders
   FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

   -- âŒ ä¸å¥½ï¼šä¸ä½¿ç”¨åˆ†åŒºï¼ˆæ€§èƒ½å·®ï¼‰
   CREATE TABLE orders (
       id SERIAL,
       order_date DATE NOT NULL,
       amount DECIMAL(10,2)
   );
   -- é—®é¢˜ï¼šæ‰€æœ‰æ•°æ®åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼ŒæŸ¥è¯¢æ€§èƒ½å·®
   ```

2. **æŒ‰åˆ—è¡¨åˆ†åŒº**ï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæŒ‰åˆ—è¡¨åˆ†åŒºï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰
   CREATE TABLE tenant_data (
       id SERIAL,
       tenant_id INT NOT NULL,
       data TEXT
   ) PARTITION BY LIST (tenant_id);

   -- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºåˆ†åŒº
   CREATE TABLE tenant_data_1 PARTITION OF tenant_data
   FOR VALUES IN (1);

   -- âŒ ä¸å¥½ï¼šä¸ä½¿ç”¨åˆ†åŒºï¼ˆæ•°æ®éš”ç¦»å·®ï¼‰
   CREATE TABLE tenant_data (
       id SERIAL,
       tenant_id INT NOT NULL,
       data TEXT
   );
   -- é—®é¢˜ï¼šæ‰€æœ‰ç§Ÿæˆ·æ•°æ®æ··åœ¨ä¸€èµ·ï¼Œæ•°æ®éš”ç¦»å·®
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸ä½¿ç”¨åˆ†åŒº**ï¼ˆæ€§èƒ½å·®ï¼‰
2. **é¿å…åˆ†åŒºé”®é€‰æ‹©ä¸å½“**ï¼ˆåˆ†åŒºæ•ˆæœå·®ï¼‰

### 5.2 ç®¡ç†å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **å®šæœŸç»´æŠ¤åˆ†åŒºç»Ÿè®¡ä¿¡æ¯**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸç»´æŠ¤åˆ†åŒºç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   ANALYZE orders;

   -- æŸ¥çœ‹åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
   SELECT
       schemaname,
       tablename,
       n_live_tup,
       n_dead_tup,
       last_analyze
   FROM pg_stat_user_tables
   WHERE tablename LIKE 'orders_%';

   -- âŒ ä¸å¥½ï¼šä¸ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ²¡æœ‰å®šæœŸç»´æŠ¤ï¼Œç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½
   ```

2. **ä½¿ç”¨è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   SELECT partman.create_parent(
       p_parent_table => 'public.orders',
       p_control => 'order_date',
       p_type => 'range',
       p_interval => 'monthly',
       p_premake => 3
   );

   -- é…ç½®è‡ªåŠ¨ç»´æŠ¤
   SELECT cron.schedule(
       'orders-partition-maintenance',
       '0 2 * * *',
       $$SELECT partman.run_maintenance('public.orders')$$
   );

   -- âŒ ä¸å¥½ï¼šæ‰‹åŠ¨ç®¡ç†åˆ†åŒºï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ‰‹åŠ¨åˆ›å»ºå’Œåˆ é™¤åˆ†åŒºï¼Œå®¹æ˜“å‡ºé”™ï¼Œç»´æŠ¤æˆæœ¬é«˜
   ```

3. **ç›‘æ§åˆ†åŒºå¤§å°**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç›‘æ§åˆ†åŒºå¤§å°ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   SELECT
       tablename,
       pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
   FROM pg_tables
   WHERE tablename LIKE 'orders_%'
   ORDER BY pg_total_relation_size('public.'||tablename) DESC;

   -- âŒ ä¸å¥½ï¼šä¸ç›‘æ§åˆ†åŒºå¤§å°ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ²¡æœ‰ç›‘æ§ï¼Œæ— æ³•åŠæ—¶å‘ç°åˆ†åŒºå¤§å°é—®é¢˜
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
2. **é¿å…æ‰‹åŠ¨ç®¡ç†åˆ†åŒº**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
3. **é¿å…ä¸ç›‘æ§åˆ†åŒºå¤§å°**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **ä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•**ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
   CREATE INDEX idx_orders_date ON orders(order_date);

   -- åˆ†åŒºçº§åˆ«çš„ç´¢å¼•ä¼šè‡ªåŠ¨åˆ›å»º
   -- ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºæœ¬åœ°ç´¢å¼•
   CREATE INDEX idx_orders_2025_01_date
   ON orders_2025_01(order_date);

   -- âŒ ä¸å¥½ï¼šä¸ä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•ï¼ˆæ€§èƒ½å·®ï¼‰
   -- æ²¡æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½å·®
   ```

2. **ä¼˜åŒ–åˆ†åŒºé”®é€‰æ‹©**ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šé€‰æ‹©åˆé€‚çš„åˆ†åŒºé”®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
   CREATE TABLE orders (
       id SERIAL,
       order_date DATE NOT NULL,  -- åˆ†åŒºé”®ï¼šé«˜é€‰æ‹©æ€§
       amount DECIMAL(10,2)
   ) PARTITION BY RANGE (order_date);

   -- âŒ ä¸å¥½ï¼šé€‰æ‹©ä¸åˆé€‚çš„åˆ†åŒºé”®ï¼ˆæ€§èƒ½å·®ï¼‰
   CREATE TABLE orders (
       id SERIAL,
       order_date DATE NOT NULL,
       status VARCHAR(10) NOT NULL,  -- åˆ†åŒºé”®ï¼šä½é€‰æ‹©æ€§
       amount DECIMAL(10,2)
   ) PARTITION BY LIST (status);
   -- é—®é¢˜ï¼šstatus åªæœ‰å‡ ä¸ªå€¼ï¼Œåˆ†åŒºæ•ˆæœå·®
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸ä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•**ï¼ˆæ€§èƒ½å·®ï¼‰
2. **é¿å…é€‰æ‹©ä¸åˆé€‚çš„åˆ†åŒºé”®**ï¼ˆæ€§èƒ½å·®ï¼‰

---

## 6. å®é™…æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹ï¼šæ—¶é—´åºåˆ—æ•°æ®åˆ†åŒºç®¡ç†

**åœºæ™¯**ï¼šè®¢å•ç³»ç»Ÿçš„æ—¶é—´åºåˆ—æ•°æ®åˆ†åŒºç®¡ç†

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE orders (
    id SERIAL,
    order_date DATE NOT NULL,
    customer_id INT,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (order_date);

-- 2. é…ç½®è‡ªåŠ¨åˆ†åŒº
SELECT partman.create_parent(
    p_parent_table => 'public.orders',
    p_control => 'order_date',
    p_type => 'range',
    p_interval => 'monthly',
    p_premake => 3
);

-- 3. é…ç½®è‡ªåŠ¨ç»´æŠ¤
SELECT cron.schedule(
    'orders-partition-maintenance',
    '0 2 * * *',
    $$SELECT partman.run_maintenance('public.orders')$$
);
```

**æ•ˆæœ**ï¼š

- è‡ªåŠ¨åˆ›å»ºæœªæ¥ 3 ä¸ªæœˆçš„åˆ†åŒº
- è‡ªåŠ¨åˆ é™¤è¶…è¿‡ 12 ä¸ªæœˆçš„åˆ†åŒº
- åˆ†åŒºæ“ä½œæ—¶é—´ï¼šä» 5 åˆ†é’Ÿé™è‡³ 30 ç§’
- æŸ¥è¯¢æ€§èƒ½æå‡ 50%

### 6.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·æ•°æ®åˆ†åŒºç®¡ç†

**åœºæ™¯**ï¼šå¤šç§Ÿæˆ· SaaS ç³»ç»Ÿçš„æ•°æ®åˆ†åŒºç®¡ç†

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE tenant_orders (
    id SERIAL,
    tenant_id INT NOT NULL,
    order_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY LIST (tenant_id);

-- 2. ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºåˆ†åŒº
CREATE TABLE tenant_orders_1 PARTITION OF tenant_orders
FOR VALUES IN (1);

CREATE TABLE tenant_orders_2 PARTITION OF tenant_orders
FOR VALUES IN (2);

-- 3. åŠ¨æ€æ·»åŠ ç§Ÿæˆ·åˆ†åŒº
CREATE OR REPLACE FUNCTION add_tenant_partition(tenant_id INT)
RETURNS VOID AS $$
BEGIN
    EXECUTE format(
        'CREATE TABLE tenant_orders_%s PARTITION OF tenant_orders
         FOR VALUES IN (%s)',
        tenant_id,
        tenant_id
    );
END;
$$ LANGUAGE plpgsql;
```

**æ•ˆæœ**ï¼š

- ç§Ÿæˆ·æ•°æ®éš”ç¦»
- æŸ¥è¯¢æ€§èƒ½æå‡ 60%
- ç®¡ç†æ•ˆç‡æå‡ 80%

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„åˆ†åŒºç®¡ç†å¢å¼ºæä¾›äº†æ›´å¼ºå¤§å’Œä¾¿æ·çš„åˆ†åŒºç®¡ç†èƒ½åŠ›ï¼š

1. **åˆ†åŒºæ“ä½œæ”¹è¿›**ï¼šæ›´å¿«é€Ÿçš„åˆ†åŒºæ“ä½œ
2. **ç®¡ç†å·¥å…·å¢å¼º**ï¼šæ›´å¼ºå¤§çš„ç®¡ç†å·¥å…·
3. **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†åŒºæ“ä½œæ€§èƒ½æå‡
5. **æ˜“ç”¨æ€§æå‡**ï¼šç®€åŒ–åˆ†åŒºç®¡ç†æµç¨‹

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨ pg_partman è¿›è¡Œè‡ªåŠ¨åˆ†åŒºç®¡ç†
- å®šæœŸç»´æŠ¤åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
- ç›‘æ§åˆ†åŒºå¤§å°å’Œæ€§èƒ½
- é…ç½®è‡ªåŠ¨åˆ†åŒºåˆ›å»ºå’Œåˆ é™¤
- ä¼˜åŒ–åˆ†åŒºç´¢å¼•ç­–ç•¥

---

## 7. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - åˆ†åŒºè¡¨](https://www.postgresql.org/docs/current/ddl-partitioning.html)**
  - åˆ†åŒºè¡¨å®Œæ•´æ•™ç¨‹
  - è¯­æ³•å’Œç¤ºä¾‹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - åˆ†åŒºè¡¨ç®¡ç†](https://www.postgresql.org/docs/current/sql-altertable.html#SQL-ALTERTABLE-PARTITION)**
  - åˆ†åŒºè¡¨ç®¡ç†è¯­æ³•
  - ALTER TABLE åˆ†åŒºæ“ä½œ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - pg_partman](https://github.com/pgpartman/pg_partman)**
  - pg_partman æ‰©å±•æ–‡æ¡£
  - è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†

- **[PostgreSQL 17 å‘å¸ƒè¯´æ˜](https://www.postgresql.org/about/news/postgresql-17-released-2781/)**
  - PostgreSQL 17 æ–°ç‰¹æ€§ä»‹ç»
  - åˆ†åŒºç®¡ç†å¢å¼ºè¯´æ˜

### SQL æ ‡å‡†

- **ISO/IEC 9075:2016 - SQL æ ‡å‡†åˆ†åŒº**
  - SQL æ ‡å‡†åˆ†åŒºè§„èŒƒ
  - åˆ†åŒºæ ‡å‡†è¯­æ³•

### æŠ€æœ¯è®ºæ–‡

- **Zilio, D. C., et al. (2004). "Partitioning Key Selection for a Shared-Nothing Database System."**
  - ä¼šè®®: CASCON 2004
  - **é‡è¦æ€§**: åˆ†åŒºé”®é€‰æ‹©çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥åˆ†æäº†åˆ†åŒºé”®é€‰æ‹©å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“

- **Agrawal, S., et al. (2004). "Automatic Physical Design Tuning: Workload as a Sequence."**
  - ä¼šè®®: SIGMOD 2004
  - **é‡è¦æ€§**: è‡ªåŠ¨ç‰©ç†è®¾è®¡è°ƒä¼˜çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†è‡ªåŠ¨åˆ†åŒºç®¡ç†çš„æ¦‚å¿µå’Œæ–¹æ³•

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - åˆ†åŒºè¡¨](https://www.postgresql.org/docs/current/ddl-partitioning.html)**
  - åˆ†åŒºè¡¨æœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL åˆ†åŒºè¡¨](https://www.2ndquadrant.com/en/blog/postgresql-partitioning/)**
  - åˆ†åŒºè¡¨å®æˆ˜
  - æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

- **[Percona - PostgreSQL åˆ†åŒºè¡¨](https://www.percona.com/blog/postgresql-partitioning/)**
  - åˆ†åŒºè¡¨ä½¿ç”¨æŠ€å·§
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[EnterpriseDB - PostgreSQL åˆ†åŒºè¡¨](https://www.enterprisedb.com/postgres-tutorials/postgresql-partitioning-tutorial)**
  - åˆ†åŒºè¡¨æ·±å…¥è§£æ
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - åˆ†åŒºè¡¨](https://wiki.postgresql.org/wiki/Partitioning)**
  - åˆ†åŒºè¡¨æŠ€å·§
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL åˆ†åŒºè¡¨](https://stackoverflow.com/questions/tagged/postgresql+partitioning)**
  - åˆ†åŒºè¡¨é—®ç­”
  - å¸¸è§é—®é¢˜è§£ç­”

### ç›¸å…³æ–‡æ¡£

- [åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–](./åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–.md)
- [åˆ†åŒºè¡¨ç®¡ç†](../../02-SQLåŸºç¡€/åˆ†åŒºè¡¨ç®¡ç†.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
