# PostgreSQL 17 ç›‘æ§å·¥å…·å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-13

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 å¯¹ç›‘æ§å·¥å…·è¿›è¡Œäº†é‡å¤§å¢å¼ºï¼ŒåŒ…æ‹¬æ–°çš„ç›‘æ§è§†å›¾ã€æ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ã€æ›´å¥½çš„æ€§èƒ½è¯Šæ–­å·¥å…·ç­‰ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“ç›‘æ§å’Œè¯Šæ–­èƒ½åŠ›ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»è¿™äº›å¢å¼ºç‰¹æ€§å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **æ–°ç›‘æ§è§†å›¾**ï¼šæ›´å¤šç›‘æ§è§†å›¾å’Œç»Ÿè®¡ä¿¡æ¯
- **æ€§èƒ½è¯Šæ–­å¢å¼º**ï¼šæ›´å¼ºå¤§çš„æ€§èƒ½è¯Šæ–­å·¥å…·
- **å®æ—¶ç›‘æ§**ï¼šå®æ—¶ç›‘æ§æ•°æ®åº“æ´»åŠ¨
- **å‘Šè­¦æ”¯æŒ**ï¼šæ›´å¥½çš„å‘Šè­¦å’Œé€šçŸ¥æ”¯æŒ
- **å¯è§‚æµ‹æ€§æå‡**ï¼šå…¨é¢çš„æ•°æ®åº“å¯è§‚æµ‹æ€§

## ğŸ“š ç›®å½•

- [PostgreSQL 17 ç›‘æ§å·¥å…·å¢å¼º](#postgresql-17-ç›‘æ§å·¥å…·å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. ç›‘æ§å·¥å…·å¢å¼ºæ¦‚è¿°](#1-ç›‘æ§å·¥å…·å¢å¼ºæ¦‚è¿°)
    - [1.0 ç›‘æ§å·¥å…·å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°](#10-ç›‘æ§å·¥å…·å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 PostgreSQL 17 å¢å¼ºäº®ç‚¹](#11-postgresql-17-å¢å¼ºäº®ç‚¹)
    - [1.2 ç›‘æ§èƒ½åŠ›å¯¹æ¯”](#12-ç›‘æ§èƒ½åŠ›å¯¹æ¯”)
  - [2. æ–°ç›‘æ§è§†å›¾](#2-æ–°ç›‘æ§è§†å›¾)
    - [2.1 pg\_stat\_io è§†å›¾](#21-pg_stat_io-è§†å›¾)
    - [2.2 pg\_stat\_progress\_copy å¢å¼º](#22-pg_stat_progress_copy-å¢å¼º)
    - [2.3 pg\_stat\_progress\_vacuum å¢å¼º](#23-pg_stat_progress_vacuum-å¢å¼º)
  - [3. æ€§èƒ½è¯Šæ–­å·¥å…·](#3-æ€§èƒ½è¯Šæ–­å·¥å…·)
    - [3.1 pg\_stat\_statements å¢å¼º](#31-pg_stat_statements-å¢å¼º)
    - [3.2 pg\_stat\_activity å¢å¼º](#32-pg_stat_activity-å¢å¼º)
    - [3.3 é”ç›‘æ§å¢å¼º](#33-é”ç›‘æ§å¢å¼º)
  - [4. å®æ—¶ç›‘æ§](#4-å®æ—¶ç›‘æ§)
    - [4.1 å®æ—¶æŸ¥è¯¢ç›‘æ§](#41-å®æ—¶æŸ¥è¯¢ç›‘æ§)
    - [4.2 å®æ—¶æ€§èƒ½ç›‘æ§](#42-å®æ—¶æ€§èƒ½ç›‘æ§)
  - [5. ç»Ÿè®¡ä¿¡æ¯æ”¶é›†](#5-ç»Ÿè®¡ä¿¡æ¯æ”¶é›†)
    - [5.1 æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯](#51-æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯)
    - [5.2 è¡¨ç»Ÿè®¡ä¿¡æ¯](#52-è¡¨ç»Ÿè®¡ä¿¡æ¯)
    - [5.3 ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯](#53-ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ç›‘æ§é…ç½®](#61-ç›‘æ§é…ç½®)
    - [6.2 ç›‘æ§æŸ¥è¯¢](#62-ç›‘æ§æŸ¥è¯¢)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šæ€§èƒ½é—®é¢˜è¯Šæ–­](#71-æ¡ˆä¾‹æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [7.2 æ¡ˆä¾‹ï¼šå®¹é‡è§„åˆ’](#72-æ¡ˆä¾‹å®¹é‡è§„åˆ’)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [SQL æ ‡å‡†](#sql-æ ‡å‡†)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## 1. ç›‘æ§å·¥å…·å¢å¼ºæ¦‚è¿°

### 1.0 ç›‘æ§å·¥å…·å¢å¼ºå·¥ä½œåŸç†æ¦‚è¿°

**ç›‘æ§å·¥å…·å¢å¼ºçš„æœ¬è´¨**ï¼š

PostgreSQL 17 çš„ç›‘æ§å·¥å…·å¢å¼ºåŸºäºæ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æœºåˆ¶ã€æ–°çš„ç›‘æ§è§†å›¾å’Œå¢å¼ºçš„è¯Šæ–­å·¥å…·ã€‚
æ•°æ®åº“ç›‘æ§æ˜¯è¿ç»´çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡å®æ—¶ç›‘æ§æ•°æ®åº“æ´»åŠ¨ã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€è¯Šæ–­æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥åŠæ—¶å‘ç°å’Œè§£å†³æ•°æ®åº“é—®é¢˜ã€‚
PostgreSQL 17 é€šè¿‡æ–°å¢ç›‘æ§è§†å›¾ã€å¢å¼ºç»Ÿè®¡ä¿¡æ¯æ”¶é›†ã€æ”¹è¿›è¯Šæ–­å·¥å…·ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å¯è§‚æµ‹æ€§å’Œè¿ç»´æ•ˆç‡ã€‚

**ç›‘æ§å·¥å…·å¢å¼ºæ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®åº“æ´»åŠ¨] --> B[ç»Ÿè®¡ä¿¡æ¯æ”¶é›†]
    B --> C{ç›‘æ§ç±»å‹}
    C -->|I/Oç›‘æ§| D[pg_stat_io]
    C -->|æŸ¥è¯¢ç›‘æ§| E[pg_stat_statements]
    C -->|æ´»åŠ¨ç›‘æ§| F[pg_stat_activity]
    C -->|é”ç›‘æ§| G[pg_locks]
    D --> H[ç›‘æ§è§†å›¾]
    E --> H
    F --> H
    G --> H
    H --> I[æ€§èƒ½è¯Šæ–­]
    I --> J{é—®é¢˜è¯†åˆ«}
    J -->|å‘ç°é—®é¢˜| K[å‘Šè­¦é€šçŸ¥]
    J -->|æ­£å¸¸| L[ç»§ç»­ç›‘æ§]
    K --> M[é—®é¢˜å¤„ç†]
    L --> A
    M --> A

    style B fill:#FFD700
    style C fill:#90EE90
    style I fill:#87CEEB
    style J fill:#FFD700
```

**ç›‘æ§å·¥å…·å¢å¼ºæ‰§è¡Œæ­¥éª¤**ï¼š

1. **ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**ï¼šæ”¶é›†æ•°æ®åº“æ´»åŠ¨çš„ç»Ÿè®¡ä¿¡æ¯
2. **ç›‘æ§ç±»å‹è¯†åˆ«**ï¼šè¯†åˆ«éœ€è¦ç›‘æ§çš„ç±»å‹ï¼ˆI/Oã€æŸ¥è¯¢ã€æ´»åŠ¨ã€é”ï¼‰
3. **ç›‘æ§è§†å›¾æ›´æ–°**ï¼šæ›´æ–°ç›¸åº”çš„ç›‘æ§è§†å›¾
4. **æ€§èƒ½è¯Šæ–­**ï¼šä½¿ç”¨è¯Šæ–­å·¥å…·åˆ†ææ€§èƒ½é—®é¢˜
5. **é—®é¢˜è¯†åˆ«**ï¼šè¯†åˆ«æ½œåœ¨çš„æ€§èƒ½é—®é¢˜
6. **å‘Šè­¦é€šçŸ¥**ï¼šå‘é€å‘Šè­¦é€šçŸ¥
7. **é—®é¢˜å¤„ç†**ï¼šå¤„ç†å‘ç°çš„é—®é¢˜

### 1.1 PostgreSQL 17 å¢å¼ºäº®ç‚¹

PostgreSQL 17 åœ¨ç›‘æ§å·¥å…·æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **æ–°ç›‘æ§è§†å›¾**ï¼špg_stat_progress_* ç³»åˆ—è§†å›¾å¢å¼º
- **æ€§èƒ½è¯Šæ–­**ï¼špg_stat_statements å¢å¼º
- **å®æ—¶ç›‘æ§**ï¼špg_stat_activity å¢å¼º
- **é”ç›‘æ§**ï¼špg_locks å’Œ pg_blocking_pids å¢å¼º
- **I/O ç›‘æ§**ï¼špg_stat_io æ–°è§†å›¾

### 1.2 ç›‘æ§èƒ½åŠ›å¯¹æ¯”

| ç›‘æ§é¡¹ | PostgreSQL 16 | PostgreSQL 17 | æå‡ |
|--------|--------------|---------------|------|
| ç›‘æ§è§†å›¾æ•°é‡ | 20+ | 30+ | 50% |
| å®æ—¶ç›‘æ§ç²¾åº¦ | ç§’çº§ | æ¯«ç§’çº§ | - |
| è¯Šæ–­å·¥å…· | åŸºç¡€ | å¢å¼º | - |

---

## 2. æ–°ç›‘æ§è§†å›¾

### 2.1 pg_stat_io è§†å›¾

PostgreSQL 17 æ–°å¢äº† I/O ç»Ÿè®¡è§†å›¾ã€‚

```sql
-- æŸ¥çœ‹ I/O ç»Ÿè®¡ä¿¡æ¯
SELECT
    backend_type,
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    read_time,
    write_time
FROM pg_stat_io
ORDER BY reads DESC;

-- æŒ‰å¯¹è±¡ç±»å‹ç»Ÿè®¡ I/O
SELECT
    object,
    SUM(reads) AS total_reads,
    SUM(writes) AS total_writes,
    SUM(read_time) AS total_read_time,
    SUM(write_time) AS total_write_time
FROM pg_stat_io
GROUP BY object
ORDER BY total_reads DESC;
```

### 2.2 pg_stat_progress_copy å¢å¼º

PostgreSQL 17 å¢å¼ºäº† COPY æ“ä½œçš„è¿›åº¦ç›‘æ§ã€‚

```sql
-- æŸ¥çœ‹ COPY æ“ä½œè¿›åº¦
SELECT
    pid,
    datid,
    datname,
    relid,
    command,
    type,
    bytes_processed,
    bytes_total,
    tuples_processed,
    tuples_excluded
FROM pg_stat_progress_copy;

-- è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
SELECT
    pid,
    command,
    ROUND(100.0 * bytes_processed / NULLIF(bytes_total, 0), 2) AS progress_pct,
    tuples_processed,
    tuples_excluded
FROM pg_stat_progress_copy;
```

### 2.3 pg_stat_progress_vacuum å¢å¼º

PostgreSQL 17 å¢å¼ºäº† VACUUM æ“ä½œçš„è¿›åº¦ç›‘æ§ã€‚

```sql
-- æŸ¥çœ‹ VACUUM æ“ä½œè¿›åº¦
SELECT
    pid,
    datid,
    datname,
    relid,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples
FROM pg_stat_progress_vacuum;

-- è®¡ç®— VACUUM è¿›åº¦
SELECT
    pid,
    phase,
    ROUND(100.0 * heap_blks_scanned / NULLIF(heap_blks_total, 0), 2) AS progress_pct,
    heap_blks_vacuumed,
    num_dead_tuples
FROM pg_stat_progress_vacuum;
```

---

## 3. æ€§èƒ½è¯Šæ–­å·¥å…·

### 3.1 pg_stat_statements å¢å¼º

PostgreSQL 17 å¢å¼ºäº† pg_stat_statements æ‰©å±•ã€‚

```sql
-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡ 1 ç§’
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 3.2 pg_stat_activity å¢å¼º

PostgreSQL 17 å¢å¼ºäº†æ´»åŠ¨ä¼šè¯ç›‘æ§ã€‚

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨ä¼šè¯
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    state,
    NOW() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
  AND NOW() - query_start > INTERVAL '5 minutes'
ORDER BY query_start;
```

### 3.3 é”ç›‘æ§å¢å¼º

PostgreSQL 17 å¢å¼ºäº†é”ç›‘æ§åŠŸèƒ½ã€‚

```sql
-- æŸ¥çœ‹å½“å‰é”
SELECT
    l.locktype,
    l.database,
    l.relation,
    l.page,
    l.tuple,
    l.virtualxid,
    l.transactionid,
    l.classid,
    l.objid,
    l.objsubid,
    l.virtualtransaction,
    l.pid,
    l.mode,
    l.granted,
    a.usename,
    a.query,
    a.query_start
FROM pg_locks l
LEFT JOIN pg_stat_activity a ON l.pid = a.pid
WHERE NOT l.granted
ORDER BY l.pid;

-- æŸ¥çœ‹é˜»å¡å…³ç³»
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

## 4. å®æ—¶ç›‘æ§

### 4.1 å®æ—¶æŸ¥è¯¢ç›‘æ§

```sql
-- åˆ›å»ºå®æ—¶ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW real_time_queries AS
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    NOW() - query_start AS duration,
    wait_event_type,
    wait_event,
    LEFT(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state != 'idle'
  AND pid != pg_backend_pid()
ORDER BY query_start;

-- æŸ¥è¯¢å®æ—¶ç›‘æ§
SELECT * FROM real_time_queries;
```

### 4.2 å®æ—¶æ€§èƒ½ç›‘æ§

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW performance_monitor AS
SELECT
    NOW() AS timestamp,
    (SELECT count(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT count(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT sum(numbackends) FROM pg_stat_database) AS total_connections,
    (SELECT sum(xact_commit) FROM pg_stat_database) AS total_commits,
    (SELECT sum(xact_rollback) FROM pg_stat_database) AS total_rollbacks,
    (SELECT sum(blks_read) FROM pg_stat_database) AS total_disk_reads,
    (SELECT sum(blks_hit) FROM pg_stat_database) AS total_cache_hits,
    (SELECT sum(tup_returned) FROM pg_stat_database) AS total_tuples_returned,
    (SELECT sum(tup_fetched) FROM pg_stat_database) AS total_tuples_fetched;

-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT * FROM performance_monitor;
```

---

## 5. ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

### 5.1 æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted,
    conflicts,
    temp_files,
    temp_bytes,
    deadlocks,
    checksum_failures,
    blk_read_time,
    blk_write_time
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY xact_commit DESC;
```

### 5.2 è¡¨ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;
```

### 5.3 ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 ç›‘æ§é…ç½®

**æ¨èåšæ³•**ï¼š

1. **å¯ç”¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå¯ç”¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   -- postgresql.conf
   track_activities = on
   track_counts = on
   track_io_timing = on
   track_functions = all

   -- é‡å¯åç”Ÿæ•ˆ
   -- âŒ ä¸å¥½ï¼šä¸å¯ç”¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ²¡æœ‰ç»Ÿè®¡ä¿¡æ¯ï¼Œæ— æ³•ç›‘æ§æ•°æ®åº“æ´»åŠ¨
   ```

2. **é…ç½® pg_stat_statements**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šé…ç½® pg_stat_statementsï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   -- postgresql.conf
   shared_preload_libraries = 'pg_stat_statements'
   pg_stat_statements.track = all
   pg_stat_statements.max = 10000

   -- åˆ›å»ºæ‰©å±•
   CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

   -- âŒ ä¸å¥½ï¼šä¸é…ç½® pg_stat_statementsï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ— æ³•ç›‘æ§æŸ¥è¯¢æ€§èƒ½
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸å¯ç”¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
2. **é¿å…ä¸é…ç½® pg_stat_statements**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰

### 6.2 ç›‘æ§æŸ¥è¯¢

**æ¨èåšæ³•**ï¼š

1. **å®šæœŸæ”¶é›†ç›‘æ§æ•°æ®**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸæ”¶é›†ç›‘æ§æ•°æ®ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   CREATE TABLE monitoring_snapshots (
       id SERIAL PRIMARY KEY,
       snapshot_time TIMESTAMPTZ DEFAULT NOW(),
       active_connections INTEGER,
       total_connections INTEGER,
       cache_hit_ratio NUMERIC,
       slow_queries_count INTEGER
   );

   -- æ’å…¥ç›‘æ§å¿«ç…§
   INSERT INTO monitoring_snapshots (
       active_connections,
       total_connections,
       cache_hit_ratio,
       slow_queries_count
   )
   SELECT
       (SELECT count(*) FROM pg_stat_activity WHERE state = 'active'),
       (SELECT sum(numbackends) FROM pg_stat_database),
       (SELECT
           ROUND(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2)
        FROM pg_stat_database),
       (SELECT count(*) FROM pg_stat_statements WHERE mean_exec_time > 1000);

   -- é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆä½¿ç”¨ pg_cronï¼‰
   SELECT cron.schedule(
       'monitoring-snapshot',
       '*/5 * * * *',  -- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
       $$INSERT INTO monitoring_snapshots (...) SELECT ...$$
   );

   -- âŒ ä¸å¥½ï¼šä¸æ”¶é›†ç›‘æ§æ•°æ®ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ²¡æœ‰å†å²æ•°æ®ï¼Œæ— æ³•åˆ†æè¶‹åŠ¿
   ```

2. **ç›‘æ§æ…¢æŸ¥è¯¢**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   SELECT
       query,
       calls,
       mean_exec_time,
       max_exec_time,
       total_exec_time
   FROM pg_stat_statements
   WHERE mean_exec_time > 1000
   ORDER BY total_exec_time DESC
   LIMIT 10;

   -- âŒ ä¸å¥½ï¼šä¸ç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ— æ³•åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
   ```

3. **ç›‘æ§é”ç­‰å¾…**ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰

   ```sql
   -- âœ… å¥½ï¼šç›‘æ§é”ç­‰å¾…ï¼ˆå¯ç»´æŠ¤æ€§ï¼‰
   SELECT
       blocked_locks.pid AS blocked_pid,
       blocking_locks.pid AS blocking_pid,
       blocked_activity.query AS blocked_query,
       blocking_activity.query AS blocking_query
   FROM pg_locks blocked_locks
   JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
   JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
   JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
   WHERE NOT blocked_locks.granted
     AND blocking_locks.pid != blocked_locks.pid;

   -- âŒ ä¸å¥½ï¼šä¸ç›‘æ§é”ç­‰å¾…ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
   -- æ— æ³•åŠæ—¶å‘ç°æ­»é”é—®é¢˜
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ä¸æ”¶é›†ç›‘æ§æ•°æ®**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
2. **é¿å…ä¸ç›‘æ§æ…¢æŸ¥è¯¢**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰
3. **é¿å…ä¸ç›‘æ§é”ç­‰å¾…**ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šæ€§èƒ½é—®é¢˜è¯Šæ–­

```sql
-- åœºæ™¯ï¼šæ•°æ®åº“æ€§èƒ½ä¸‹é™
-- æ­¥éª¤ 1ï¼šæŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY total_exec_time DESC
LIMIT 10;

-- æ­¥éª¤ 2ï¼šæŸ¥çœ‹å½“å‰æ´»åŠ¨ä¼šè¯
SELECT
    pid,
    usename,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- æ­¥éª¤ 3ï¼šæŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
  AND blocking_locks.pid != blocked_locks.pid;

-- æ­¥éª¤ 4ï¼šæŸ¥çœ‹ I/O ç»Ÿè®¡
SELECT
    object,
    SUM(reads) AS total_reads,
    SUM(writes) AS total_writes,
    SUM(read_time) AS total_read_time
FROM pg_stat_io
GROUP BY object
ORDER BY total_reads DESC;
```

### 7.2 æ¡ˆä¾‹ï¼šå®¹é‡è§„åˆ’

```sql
-- åœºæ™¯ï¼šæ•°æ®åº“å®¹é‡è§„åˆ’
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹å¢é•¿è¶‹åŠ¿
SELECT
    snapshot_time,
    total_connections,
    cache_hit_ratio
FROM monitoring_snapshots
WHERE snapshot_time >= NOW() - INTERVAL '7 days'
ORDER BY snapshot_time;
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„ç›‘æ§å·¥å…·å¢å¼ºæ˜¾è‘—æå‡äº†æ•°æ®åº“ç›‘æ§å’Œè¯Šæ–­èƒ½åŠ›ã€‚é€šè¿‡åˆç†ä½¿ç”¨æ–°çš„ç›‘æ§è§†å›¾ã€æ€§èƒ½è¯Šæ–­å·¥å…·ã€å®æ—¶ç›‘æ§ç­‰åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚å»ºè®®å®šæœŸæ”¶é›†ç›‘æ§æ•°æ®ï¼Œå»ºç«‹ç›‘æ§å‘Šè­¦æœºåˆ¶ï¼Œå¹¶æŒç»­ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ã€‚

---

## 8. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - ç›‘æ§å®Œæ•´æ•™ç¨‹
  - ç›‘æ§è§†å›¾å’Œç»Ÿè®¡ä¿¡æ¯

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)**
  - pg_stat_statements æ‰©å±•æ–‡æ¡£
  - æŸ¥è¯¢æ€§èƒ½ç›‘æ§

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯è§†å›¾](https://www.postgresql.org/docs/current/monitoring-stats.html)**
  - ç»Ÿè®¡ä¿¡æ¯è§†å›¾è¯´æ˜
  - pg_stat_* ç³»åˆ—è§†å›¾

- **[PostgreSQL 17 å‘å¸ƒè¯´æ˜](https://www.postgresql.org/about/news/postgresql-17-released-2781/)**
  - PostgreSQL 17 æ–°ç‰¹æ€§ä»‹ç»
  - ç›‘æ§å·¥å…·å¢å¼ºè¯´æ˜

### SQL æ ‡å‡†

- **ISO/IEC 9075:2016 - SQL æ ‡å‡†ç›‘æ§**
  - SQL æ ‡å‡†ç›‘æ§è§„èŒƒ
  - ç›‘æ§æ ‡å‡†è¯­æ³•

### æŠ€æœ¯è®ºæ–‡

- **Chaudhuri, S., et al. (2004). "Self-Tuning Database Systems: A Decade of Progress."**
  - ä¼šè®®: VLDB 2004
  - **é‡è¦æ€§**: æ•°æ®åº“è‡ªè°ƒä¼˜çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥åˆ†æäº†æ•°æ®åº“ç›‘æ§å’Œè‡ªè°ƒä¼˜çš„æ–¹æ³•

- **Hellerstein, J. M., et al. (2004). "Feedback Control of Computing Systems."**
  - å‡ºç‰ˆç¤¾: Wiley-IEEE Press
  - **é‡è¦æ€§**: è®¡ç®—ç³»ç»Ÿåé¦ˆæ§åˆ¶çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥è§£é‡Šäº†ç›‘æ§å’Œåé¦ˆæ§åˆ¶çš„åŸç†

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - ç›‘æ§æœ€ä½³å®è·µ
  - æ€§èƒ½è¯Šæ–­æŠ€å·§

- **[2ndQuadrant - PostgreSQL ç›‘æ§](https://www.2ndquadrant.com/en/blog/postgresql-monitoring/)**
  - ç›‘æ§å®æˆ˜
  - æ€§èƒ½è¯Šæ–­æ¡ˆä¾‹

- **[Percona - PostgreSQL ç›‘æ§](https://www.percona.com/blog/postgresql-monitoring/)**
  - ç›‘æ§ä½¿ç”¨æŠ€å·§
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[EnterpriseDB - PostgreSQL ç›‘æ§](https://www.enterprisedb.com/postgres-tutorials/postgresql-monitoring-tutorial)**
  - ç›‘æ§æ·±å…¥è§£æ
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - ç›‘æ§](https://wiki.postgresql.org/wiki/Monitoring)**
  - ç›‘æ§æŠ€å·§
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL ç›‘æ§](https://stackoverflow.com/questions/tagged/postgresql+monitoring)**
  - ç›‘æ§é—®ç­”
  - å¸¸è§é—®é¢˜è§£ç­”

### ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](../../11-æ€§èƒ½è°ƒä¼˜/æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [æ€§èƒ½è¯Šæ–­æ”¹è¿›](./æ€§èƒ½è¯Šæ–­æ”¹è¿›.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-17-13
