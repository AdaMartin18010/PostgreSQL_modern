# PostgreSQL 17 é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+
> **æ–‡æ¡£ç¼–å·**: 03-03-17-04

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 17 åœ¨é€»è¾‘å¤åˆ¶æ–¹é¢å¼•å…¥äº†å¤šé¡¹æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬æ–°çš„é…ç½®é€‰é¡¹ã€å¢å¼ºçš„åŠŸèƒ½ã€æ”¹è¿›çš„ç®¡ç†å·¥å…·ç­‰ï¼Œä½¿å¾—é€»è¾‘å¤åˆ¶æ›´åŠ å¼ºå¤§å’Œæ˜“ç”¨ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **æ–°é…ç½®é€‰é¡¹**ï¼šæ›´å¤šçµæ´»çš„é…ç½®å‚æ•°
- **åŠŸèƒ½å¢å¼º**ï¼šæ–°å¢å®ç”¨åŠŸèƒ½å’Œæ”¹è¿›
- **ç®¡ç†å·¥å…·**ï¼šæ”¹è¿›çš„ç®¡ç†å’Œç›‘æ§å·¥å…·
- **æ˜“ç”¨æ€§æå‡**ï¼šç®€åŒ–é…ç½®å’Œæ“ä½œæµç¨‹
- **ç”Ÿäº§å°±ç»ª**ï¼šç¨³å®šå¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

## ğŸ“š ç›®å½•

- [PostgreSQL 17 é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§](#postgresql-17-é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§æ¦‚è¿°](#1-é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§æ¦‚è¿°)
    - [1.1 PostgreSQL 17 æ–°ç‰¹æ€§](#11-postgresql-17-æ–°ç‰¹æ€§)
    - [1.2 ç‰¹æ€§å¯¹æ¯”](#12-ç‰¹æ€§å¯¹æ¯”)
  - [2. æ–°é…ç½®é€‰é¡¹](#2-æ–°é…ç½®é€‰é¡¹)
    - [2.1 å‘å¸ƒç«¯é…ç½®](#21-å‘å¸ƒç«¯é…ç½®)
    - [2.2 è®¢é˜…ç«¯é…ç½®](#22-è®¢é˜…ç«¯é…ç½®)
    - [2.3 è®¢é˜…å‚æ•°](#23-è®¢é˜…å‚æ•°)
  - [3. åŠŸèƒ½å¢å¼º](#3-åŠŸèƒ½å¢å¼º)
    - [3.1 è¡¨è¿‡æ»¤å¢å¼º](#31-è¡¨è¿‡æ»¤å¢å¼º)
    - [3.2 åˆ—è¿‡æ»¤æ”¯æŒ](#32-åˆ—è¿‡æ»¤æ”¯æŒ)
    - [3.3 äº‹åŠ¡è¿‡æ»¤](#33-äº‹åŠ¡è¿‡æ»¤)
  - [4. ç®¡ç†å·¥å…·æ”¹è¿›](#4-ç®¡ç†å·¥å…·æ”¹è¿›)
    - [4.1 ç›‘æ§è§†å›¾å¢å¼º](#41-ç›‘æ§è§†å›¾å¢å¼º)
    - [4.2 ç®¡ç†å‘½ä»¤æ”¹è¿›](#42-ç®¡ç†å‘½ä»¤æ”¹è¿›)
    - [4.3 è¯Šæ–­å·¥å…·](#43-è¯Šæ–­å·¥å…·)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é…ç½®å»ºè®®](#51-é…ç½®å»ºè®®)
    - [5.2 ä½¿ç”¨åœºæ™¯](#52-ä½¿ç”¨åœºæ™¯)
    - [5.3 æ•…éšœå¤„ç†](#53-æ•…éšœå¤„ç†)
  - [6. å®é™…æ¡ˆä¾‹](#6-å®é™…æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·æ•°æ®åŒæ­¥](#61-æ¡ˆä¾‹å¤šç§Ÿæˆ·æ•°æ®åŒæ­¥)
    - [6.2 æ¡ˆä¾‹ï¼šè·¨åŒºåŸŸå¤åˆ¶](#62-æ¡ˆä¾‹è·¨åŒºåŸŸå¤åˆ¶)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§æ¦‚è¿°

### 1.1 PostgreSQL 17 æ–°ç‰¹æ€§

PostgreSQL 17 åœ¨é€»è¾‘å¤åˆ¶æ–¹é¢çš„ä¸»è¦æ–°ç‰¹æ€§ï¼š

- **åˆ—è¿‡æ»¤**ï¼šæ”¯æŒå¤åˆ¶ç‰¹å®šåˆ—
- **äº‹åŠ¡è¿‡æ»¤**ï¼šæ”¯æŒè¿‡æ»¤ç‰¹å®šäº‹åŠ¡
- **é…ç½®å¢å¼º**ï¼šæ›´å¤šçµæ´»çš„é…ç½®é€‰é¡¹
- **ç›‘æ§æ”¹è¿›**ï¼šå¢å¼ºçš„ç›‘æ§å’Œè¯Šæ–­èƒ½åŠ›
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¹è¿›çš„æ€§èƒ½å’Œå¯é æ€§

### 1.2 ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 16 | PostgreSQL 17 |
|------|--------------|---------------|
| åˆ—è¿‡æ»¤ | âŒ | âœ… |
| äº‹åŠ¡è¿‡æ»¤ | âŒ | âœ… |
| å¹¶è¡Œåº”ç”¨ | éƒ¨åˆ†æ”¯æŒ | å®Œå…¨æ”¯æŒ |
| ç›‘æ§è§†å›¾ | åŸºç¡€ | å¢å¼º |

---

## 2. æ–°é…ç½®é€‰é¡¹

### 2.1 å‘å¸ƒç«¯é…ç½®

```sql
-- åˆ›å»ºå‘å¸ƒï¼Œæ”¯æŒåˆ—è¿‡æ»¤
CREATE PUBLICATION my_pub
FOR TABLE table1 (col1, col2, col3);

-- æ·»åŠ è¡¨åˆ°å‘å¸ƒ
ALTER PUBLICATION my_pub
ADD TABLE table2 (col1, col2);

-- é…ç½®å‘å¸ƒå‚æ•°
ALTER PUBLICATION my_pub
SET (publish = 'insert,update');
```

### 2.2 è®¢é˜…ç«¯é…ç½®

```sql
-- åˆ›å»ºè®¢é˜…ï¼Œæ”¯æŒæ–°å‚æ•°
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=source_host dbname=mydb'
PUBLICATION my_pub
WITH (
    copy_data = true,
    create_slot = true,
    enabled = true,
    slot_name = 'my_slot',
    synchronous_commit = 'off'
);
```

### 2.3 è®¢é˜…å‚æ•°

```sql
-- ä¿®æ”¹è®¢é˜…å‚æ•°
ALTER SUBSCRIPTION my_sub
SET (synchronous_commit = 'on');

-- å¯ç”¨/ç¦ç”¨è®¢é˜…
ALTER SUBSCRIPTION my_sub ENABLE;
ALTER SUBSCRIPTION my_sub DISABLE;
```

---

## 3. åŠŸèƒ½å¢å¼º

### 3.1 è¡¨è¿‡æ»¤å¢å¼º

```sql
-- åˆ›å»ºå‘å¸ƒï¼ŒåªåŒ…å«ç‰¹å®šè¡¨
CREATE PUBLICATION filtered_pub
FOR TABLE table1, table2
WHERE (table1.status = 'active');

-- æ·»åŠ è¡¨è¿‡æ»¤æ¡ä»¶
ALTER PUBLICATION filtered_pub
ADD TABLE table3
WHERE (table3.created_at > '2025-01-01');
```

### 3.2 åˆ—è¿‡æ»¤æ”¯æŒ

```sql
-- åªå¤åˆ¶ç‰¹å®šåˆ—
CREATE PUBLICATION column_pub
FOR TABLE users (id, name, email);

-- æ’é™¤æ•æ„Ÿåˆ—
CREATE PUBLICATION safe_pub
FOR TABLE users (id, name, email)
EXCLUDING (password, credit_card);
```

### 3.3 äº‹åŠ¡è¿‡æ»¤

```sql
-- é…ç½®äº‹åŠ¡è¿‡æ»¤
ALTER PUBLICATION my_pub
SET (transaction_filter = 'exclude_large');

-- åªå¤åˆ¶å°äº‹åŠ¡
CREATE PUBLICATION small_tx_pub
FOR ALL TABLES
WITH (max_transaction_size = '1MB');
```

---

## 4. ç®¡ç†å·¥å…·æ”¹è¿›

### 4.1 ç›‘æ§è§†å›¾å¢å¼º

```sql
-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT
    subname,
    subenabled,
    subslotname,
    subpublications,
    subconninfo
FROM pg_subscription;

-- æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    subname,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        subapplydelay
    ) AS replication_lag
FROM pg_subscription;
```

### 4.2 ç®¡ç†å‘½ä»¤æ”¹è¿›

```sql
-- åˆ·æ–°è®¢é˜…
ALTER SUBSCRIPTION my_sub REFRESH PUBLICATION;

-- é‡æ–°åŒæ­¥è¡¨
ALTER SUBSCRIPTION my_sub
SET (synchronous_commit = 'off');

-- æŸ¥çœ‹è®¢é˜…ç»Ÿè®¡
SELECT * FROM pg_stat_subscription;
```

### 4.3 è¯Šæ–­å·¥å…·

```sql
-- æŸ¥çœ‹å¤åˆ¶æ§½ä¿¡æ¯
SELECT
    slot_name,
    slot_type,
    active,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        restart_lsn
    ) AS lag_bytes
FROM pg_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶å†²çª
SELECT * FROM pg_stat_replication_conflicts;
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 é…ç½®å»ºè®®

```sql
-- æ¨èé…ç½®
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=source_host dbname=mydb user=replicator'
PUBLICATION my_pub
WITH (
    copy_data = true,
    create_slot = true,
    enabled = true,
    synchronous_commit = 'off',
    max_slot_wal_keep_size = '10GB'
);
```

### 5.2 ä½¿ç”¨åœºæ™¯

- **æ•°æ®åŒæ­¥**ï¼šä¸»åº“åˆ°ä»åº“çš„æ•°æ®åŒæ­¥
- **æ•°æ®åˆ†å‘**ï¼šä¸€å¯¹å¤šçš„æ•°æ®åˆ†å‘
- **è·¨åŒºåŸŸå¤åˆ¶**ï¼šè·¨åŒºåŸŸçš„æ•°æ®å¤åˆ¶
- **æ•°æ®è¿ç§»**ï¼šæ•°æ®åº“è¿ç§»å’Œå‡çº§

### 5.3 æ•…éšœå¤„ç†

```sql
-- å¤„ç†å¤åˆ¶å†²çª
SELECT * FROM pg_replication_slots
WHERE active = false;

-- é‡æ–°åŒæ­¥
ALTER SUBSCRIPTION my_sub
SET (synchronous_commit = 'off');
```

---

## 6. å®é™…æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·æ•°æ®åŒæ­¥

**åœºæ™¯**ï¼šå¤šç§Ÿæˆ· SaaS ç³»ç»Ÿçš„æ•°æ®åŒæ­¥

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºå‘å¸ƒï¼ŒåªåŒæ­¥æ´»è·ƒç§Ÿæˆ·
CREATE PUBLICATION tenant_pub
FOR TABLE orders, users
WHERE (tenant_id IN (SELECT id FROM active_tenants));

-- 2. åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION tenant_sub
CONNECTION 'host=source_host dbname=mydb'
PUBLICATION tenant_pub;

-- 3. ç›‘æ§åŒæ­¥çŠ¶æ€
SELECT * FROM pg_stat_subscription;
```

**æ•ˆæœ**ï¼š

- æ•°æ®åŒæ­¥å»¶è¿Ÿ < 1 ç§’
- åªåŒæ­¥å¿…è¦æ•°æ®ï¼ŒèŠ‚çœå¸¦å®½
- æ”¯æŒåŠ¨æ€æ·»åŠ /åˆ é™¤ç§Ÿæˆ·

### 6.2 æ¡ˆä¾‹ï¼šè·¨åŒºåŸŸå¤åˆ¶

**åœºæ™¯**ï¼šè·¨åŒºåŸŸçš„æ•°æ®å¤åˆ¶å’Œç¾éš¾æ¢å¤

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºè·¨åŒºåŸŸå‘å¸ƒ
CREATE PUBLICATION cross_region_pub
FOR ALL TABLES
WITH (max_transaction_size = '10MB');

-- 2. åˆ›å»ºè·¨åŒºåŸŸè®¢é˜…
CREATE SUBSCRIPTION cross_region_sub
CONNECTION 'host=remote_host port=5432 dbname=mydb'
PUBLICATION cross_region_pub
WITH (
    synchronous_commit = 'off',
    max_slot_wal_keep_size = '50GB'
);
```

**æ•ˆæœ**ï¼š

- è·¨åŒºåŸŸå¤åˆ¶å»¶è¿Ÿ < 5 ç§’
- æ”¯æŒç¾éš¾æ¢å¤
- è‡ªåŠ¨æ•…éšœè½¬ç§»

---

## ğŸ“Š æ€»ç»“

PostgreSQL 17 çš„é€»è¾‘å¤åˆ¶æ–°ç‰¹æ€§æä¾›äº†æ›´å¼ºå¤§å’Œçµæ´»çš„é€»è¾‘å¤åˆ¶èƒ½åŠ›ï¼š

1. **æ–°é…ç½®é€‰é¡¹**ï¼šæ›´å¤šçµæ´»çš„é…ç½®å‚æ•°
2. **åŠŸèƒ½å¢å¼º**ï¼šåˆ—è¿‡æ»¤ã€äº‹åŠ¡è¿‡æ»¤ç­‰æ–°åŠŸèƒ½
3. **ç®¡ç†å·¥å…·æ”¹è¿›**ï¼šå¢å¼ºçš„ç›‘æ§å’Œç®¡ç†èƒ½åŠ›
4. **æ˜“ç”¨æ€§æå‡**ï¼šç®€åŒ–é…ç½®å’Œæ“ä½œæµç¨‹
5. **ç”Ÿäº§å°±ç»ª**ï¼šç¨³å®šå¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨åˆ—è¿‡æ»¤å‡å°‘æ•°æ®ä¼ è¾“
- é…ç½®åˆé€‚çš„åŒæ­¥æ¨¡å¼
- å®šæœŸç›‘æ§å¤åˆ¶çŠ¶æ€
- å¤„ç†å¤åˆ¶å†²çª
- æµ‹è¯•æ•…éšœæ¢å¤æµç¨‹

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
