# PostgreSQL 16 åˆ° 17 è¿ç§»æŒ‡å—

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 16 â†’ 17
> **æ–‡æ¡£ç¼–å·**: 03-03-17-17

## ğŸ“‘ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ä» PostgreSQL 16 å‡çº§åˆ° PostgreSQL 17 çš„å®Œæ•´è¿ç§»æŒ‡å—ï¼ŒåŒ…æ‹¬è¿ç§»æ­¥éª¤ã€æ³¨æ„äº‹é¡¹ã€å…¼å®¹æ€§é—®é¢˜ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®ç­‰ï¼Œå¸®åŠ©ç”¨æˆ·é¡ºåˆ©å®Œæˆç‰ˆæœ¬å‡çº§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¹³æ»‘è¿ç§»**ï¼šè¯¦ç»†çš„è¿ç§»æ­¥éª¤å’Œæœ€ä½³å®è·µ
- **å…¼å®¹æ€§æ£€æŸ¥**ï¼šè¯†åˆ«æ½œåœ¨çš„å…¼å®¹æ€§é—®é¢˜
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ©ç”¨æ–°ç‰¹æ€§çš„æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **å›æ»šæ–¹æ¡ˆ**ï¼šæä¾›è¿ç§»å¤±è´¥çš„å›æ»šç­–ç•¥
- **æµ‹è¯•éªŒè¯**ï¼šå®Œæ•´çš„æµ‹è¯•å’ŒéªŒè¯æµç¨‹

## ğŸ“š ç›®å½•

- [PostgreSQL 16 åˆ° 17 è¿ç§»æŒ‡å—](#postgresql-16-åˆ°-17-è¿ç§»æŒ‡å—)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. è¿ç§»æ¦‚è¿°](#1-è¿ç§»æ¦‚è¿°)
    - [1.1 PostgreSQL 17 ä¸»è¦å˜åŒ–](#11-postgresql-17-ä¸»è¦å˜åŒ–)
    - [1.2 è¿ç§»ç­–ç•¥](#12-è¿ç§»ç­–ç•¥)
  - [2. è¿ç§»å‰å‡†å¤‡](#2-è¿ç§»å‰å‡†å¤‡)
    - [2.1 ç¯å¢ƒæ£€æŸ¥](#21-ç¯å¢ƒæ£€æŸ¥)
    - [2.2 å¤‡ä»½ç­–ç•¥](#22-å¤‡ä»½ç­–ç•¥)
  - [3. å…¼å®¹æ€§æ£€æŸ¥](#3-å…¼å®¹æ€§æ£€æŸ¥)
    - [3.1 æ‰©å±•å…¼å®¹æ€§](#31-æ‰©å±•å…¼å®¹æ€§)
    - [3.2 åŠŸèƒ½å…¼å®¹æ€§](#32-åŠŸèƒ½å…¼å®¹æ€§)
  - [4. è¿ç§»æ­¥éª¤](#4-è¿ç§»æ­¥éª¤)
    - [4.1 ä½¿ç”¨ pg\_upgrade å‡çº§](#41-ä½¿ç”¨-pg_upgrade-å‡çº§)
    - [4.2 é€»è¾‘å¤åˆ¶è¿ç§»](#42-é€»è¾‘å¤åˆ¶è¿ç§»)
  - [5. è¿ç§»åä¼˜åŒ–](#5-è¿ç§»åä¼˜åŒ–)
    - [5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯](#51-æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)
    - [5.2 é‡å»ºç´¢å¼•](#52-é‡å»ºç´¢å¼•)
    - [5.3 åˆ©ç”¨æ–°ç‰¹æ€§](#53-åˆ©ç”¨æ–°ç‰¹æ€§)
  - [6. å¸¸è§é—®é¢˜](#6-å¸¸è§é—®é¢˜)
    - [6.1 æ‰©å±•ä¸å…¼å®¹](#61-æ‰©å±•ä¸å…¼å®¹)
    - [6.2 æ€§èƒ½ä¸‹é™](#62-æ€§èƒ½ä¸‹é™)
  - [7. å›æ»šæ–¹æ¡ˆ](#7-å›æ»šæ–¹æ¡ˆ)
    - [7.1 å›æ»šå‡†å¤‡](#71-å›æ»šå‡†å¤‡)
    - [7.2 å›æ»šæ­¥éª¤](#72-å›æ»šæ­¥éª¤)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. è¿ç§»æ¦‚è¿°

### 1.1 PostgreSQL 17 ä¸»è¦å˜åŒ–

PostgreSQL 17 çš„ä¸»è¦å˜åŒ–ï¼š

- **SQL MERGE è¯­å¥**ï¼šæ–°å¢æ ‡å‡† SQL MERGE æ”¯æŒ
- **é€»è¾‘å¤åˆ¶å¢å¼º**ï¼šæ€§èƒ½æå‡å’ŒåŠŸèƒ½å¢å¼º
- **æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›**ï¼šæŸ¥è¯¢æ€§èƒ½æ˜¾è‘—æå‡
- **åˆ†åŒºè¡¨ä¼˜åŒ–**ï¼šåˆ†åŒºæŸ¥è¯¢æ€§èƒ½æ”¹è¿›
- **JSON/JSONB å¢å¼º**ï¼šæ–°çš„æ“ä½œç¬¦å’Œå‡½æ•°

### 1.2 è¿ç§»ç­–ç•¥

```text
è¿ç§»ç­–ç•¥
â”œâ”€â”€ ç›´æ¥å‡çº§ï¼ˆpg_upgradeï¼‰
â”œâ”€â”€ é€»è¾‘å¤åˆ¶è¿ç§»
â”œâ”€â”€ å¯¼å‡º/å¯¼å…¥è¿ç§»
â””â”€â”€ åŒå†™è¿ç§»
```

---

## 2. è¿ç§»å‰å‡†å¤‡

### 2.1 ç¯å¢ƒæ£€æŸ¥

```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
psql --version

# æ£€æŸ¥æ•°æ®åº“å¤§å°
psql -c "SELECT pg_size_pretty(pg_database_size('mydb'));"

# æ£€æŸ¥æ‰©å±•
psql -c "SELECT extname, extversion FROM pg_extension;"

# æ£€æŸ¥é…ç½®
psql -c "SHOW ALL;" > pg16_config.txt
```

### 2.2 å¤‡ä»½ç­–ç•¥

```bash
# å®Œæ•´å¤‡ä»½
pg_dumpall -U postgres > pg16_backup.sql

# æ•°æ®åº“å¤‡ä»½
pg_dump -U postgres -Fc mydb > mydb_backup.dump

# WAL å½’æ¡£å¤‡ä»½
tar -czf wal_archive_backup.tar.gz /archive/
```

---

## 3. å…¼å®¹æ€§æ£€æŸ¥

### 3.1 æ‰©å±•å…¼å®¹æ€§

```sql
-- æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬
SELECT
    extname,
    extversion,
    pg_available_extensions.extversion AS available_version
FROM pg_extension
LEFT JOIN pg_available_extensions
    ON pg_extension.extname = pg_available_extensions.name;

-- æ£€æŸ¥ä¸å…¼å®¹çš„æ‰©å±•
SELECT extname
FROM pg_extension
WHERE extname NOT IN (
    SELECT name FROM pg_available_extensions
);
```

### 3.2 åŠŸèƒ½å…¼å®¹æ€§

```sql
-- æ£€æŸ¥å·²å¼ƒç”¨çš„åŠŸèƒ½
SELECT * FROM pg_settings
WHERE name LIKE '%deprecated%';

-- æ£€æŸ¥è‡ªå®šä¹‰å‡½æ•°å…¼å®¹æ€§
SELECT
    proname,
    prosrc
FROM pg_proc
WHERE prokind = 'f'
AND pronamespace = 'public'::regnamespace;
```

---

## 4. è¿ç§»æ­¥éª¤

### 4.1 ä½¿ç”¨ pg_upgrade å‡çº§

```bash
# 1. å®‰è£… PostgreSQL 17
# 2. åœæ­¢ PostgreSQL 16
sudo systemctl stop postgresql-16

# 3. è¿è¡Œ pg_upgrade
/usr/pgsql-17/bin/pg_upgrade \
    --old-datadir=/var/lib/pgsql/16/data \
    --new-datadir=/var/lib/pgsql/17/data \
    --old-bindir=/usr/pgsql-16/bin \
    --new-bindir=/usr/pgsql-17/bin \
    --check

# 4. æ‰§è¡Œå‡çº§
/usr/pgsql-17/bin/pg_upgrade \
    --old-datadir=/var/lib/pgsql/16/data \
    --new-datadir=/var/lib/pgsql/17/data \
    --old-bindir=/usr/pgsql-16/bin \
    --new-bindir=/usr/pgsql-17/bin

# 5. å¯åŠ¨ PostgreSQL 17
sudo systemctl start postgresql-17
```

### 4.2 é€»è¾‘å¤åˆ¶è¿ç§»

```sql
-- åœ¨ PostgreSQL 17 ä¸Šåˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION pg17_sub
CONNECTION 'host=pg16_host dbname=mydb user=replicator'
PUBLICATION pg16_pub
WITH (
    copy_data = true,
    create_slot = true
);

-- ç›‘æ§å¤åˆ¶è¿›åº¦
SELECT * FROM pg_stat_subscription;
```

---

## 5. è¿ç§»åä¼˜åŒ–

### 5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```sql
-- æ›´æ–°æ‰€æœ‰è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- æ›´æ–°ç‰¹å®šæ•°æ®åº“
ANALYZE DATABASE mydb;

-- æ›´æ–°ç‰¹å®šè¡¨
ANALYZE table_name;
```

### 5.2 é‡å»ºç´¢å¼•

```sql
-- é‡å»ºæ‰€æœ‰ç´¢å¼•
REINDEX DATABASE mydb;

-- é‡å»ºç‰¹å®šè¡¨ç´¢å¼•
REINDEX TABLE table_name;

-- é‡å»ºç‰¹å®šç´¢å¼•
REINDEX INDEX index_name;
```

### 5.3 åˆ©ç”¨æ–°ç‰¹æ€§

```sql
-- ä½¿ç”¨ SQL MERGE
MERGE INTO target_table AS t
USING source_table AS s
ON t.id = s.id
WHEN MATCHED THEN
    UPDATE SET value = s.value
WHEN NOT MATCHED THEN
    INSERT (id, value) VALUES (s.id, s.value);

-- ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM large_table;
```

---

## 6. å¸¸è§é—®é¢˜

### 6.1 æ‰©å±•ä¸å…¼å®¹

**é—®é¢˜**ï¼šæŸäº›æ‰©å±•åœ¨ PostgreSQL 17 ä¸­ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ£€æŸ¥æ‰©å±•æ›¿ä»£æ–¹æ¡ˆ
SELECT * FROM pg_available_extensions
WHERE name LIKE '%similar%';

-- æ›´æ–°æ‰©å±•
ALTER EXTENSION extension_name UPDATE;
```

### 6.2 æ€§èƒ½ä¸‹é™

**é—®é¢˜**ï¼šè¿ç§»åæŸ¥è¯¢æ€§èƒ½ä¸‹é™

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- é‡å»ºç´¢å¼•
REINDEX DATABASE mydb;

-- è°ƒæ•´é…ç½®å‚æ•°
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET work_mem = '16MB';
```

---

## 7. å›æ»šæ–¹æ¡ˆ

### 7.1 å›æ»šå‡†å¤‡

```bash
# ä¿ç•™ PostgreSQL 16 æ•°æ®ç›®å½•
cp -r /var/lib/pgsql/16/data /var/lib/pgsql/16/data.backup

# ä¿ç•™é…ç½®æ–‡ä»¶
cp /etc/postgresql/16/postgresql.conf /etc/postgresql/16/postgresql.conf.backup
```

### 7.2 å›æ»šæ­¥éª¤

```bash
# 1. åœæ­¢ PostgreSQL 17
sudo systemctl stop postgresql-17

# 2. æ¢å¤ PostgreSQL 16 æ•°æ®
cp -r /var/lib/pgsql/16/data.backup /var/lib/pgsql/16/data

# 3. å¯åŠ¨ PostgreSQL 16
sudo systemctl start postgresql-16

# 4. éªŒè¯æ•°æ®
psql -c "SELECT version();"
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 16 åˆ° 17 çš„è¿ç§»éœ€è¦ä»”ç»†è§„åˆ’å’Œæ‰§è¡Œï¼š

1. **è¿ç§»å‰å‡†å¤‡**ï¼šå®Œæ•´å¤‡ä»½å’Œç¯å¢ƒæ£€æŸ¥
2. **å…¼å®¹æ€§æ£€æŸ¥**ï¼šæ£€æŸ¥æ‰©å±•å’ŒåŠŸèƒ½å…¼å®¹æ€§
3. **è¿ç§»æ‰§è¡Œ**ï¼šé€‰æ‹©åˆé€‚çš„è¿ç§»æ–¹æ³•
4. **è¿ç§»åä¼˜åŒ–**ï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’Œåˆ©ç”¨æ–°ç‰¹æ€§
5. **å›æ»šå‡†å¤‡**ï¼šå‡†å¤‡å›æ»šæ–¹æ¡ˆä»¥é˜²ä¸‡ä¸€

**æœ€ä½³å®è·µ**ï¼š

- åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯
- å®Œæ•´å¤‡ä»½æ‰€æœ‰æ•°æ®
- æ£€æŸ¥æ‰©å±•å…¼å®¹æ€§
- ç›‘æ§è¿ç§»è¿‡ç¨‹
- è¿ç§»åæ€§èƒ½æµ‹è¯•
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
