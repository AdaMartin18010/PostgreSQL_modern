# PostgreSQL ä½ç½®æœåŠ¡åº”ç”¨

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ with PostGIS 3.4+
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-15

## ğŸ“‘ æ¦‚è¿°

ä½ç½®æœåŠ¡ï¼ˆLBS - Location-Based Servicesï¼‰æ˜¯åŸºäºç”¨æˆ·åœ°ç†ä½ç½®ä¿¡æ¯æä¾›çš„æœåŠ¡ã€‚
PostgreSQL ç»“åˆ PostGIS æ‰©å±•æä¾›äº†å¼ºå¤§çš„ä½ç½®æœåŠ¡å¼€å‘èƒ½åŠ›ï¼Œæ”¯æŒåœ°ç†å›´æ ã€è·¯å¾„è§„åˆ’ã€é™„è¿‘æœç´¢ã€ä½ç½®è¿½è¸ªç­‰åŠŸèƒ½ï¼Œ
å¹¿æ³›åº”ç”¨äºåœ°å›¾åº”ç”¨ã€å¯¼èˆªç³»ç»Ÿã€ä½ç½®è¥é”€ç­‰åœºæ™¯ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **åœ°ç†å›´æ **ï¼šæ”¯æŒåœ†å½¢ã€å¤šè¾¹å½¢ç­‰åœ°ç†å›´æ 
- **è·¯å¾„è§„åˆ’**ï¼šæ”¯æŒæœ€çŸ­è·¯å¾„ã€æœ€ä¼˜è·¯å¾„è§„åˆ’
- **é™„è¿‘æœç´¢**ï¼šé«˜æ•ˆçš„é™„è¿‘ä½ç½®æœç´¢
- **ä½ç½®è¿½è¸ª**ï¼šå®æ—¶ä½ç½®è¿½è¸ªå’Œå†å²è½¨è¿¹åˆ†æ
- **ä½ç½®åˆ†æ**ï¼šä½ç½®æ•°æ®ç»Ÿè®¡å’Œåˆ†æ

## ğŸ“š ç›®å½•

- [PostgreSQL ä½ç½®æœåŠ¡åº”ç”¨](#postgresql-ä½ç½®æœåŠ¡åº”ç”¨)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. ä½ç½®æœåŠ¡åŸºç¡€](#1-ä½ç½®æœåŠ¡åŸºç¡€)
    - [1.1 ä½ç½®æ•°æ®æ¨¡å‹](#11-ä½ç½®æ•°æ®æ¨¡å‹)
    - [1.2 åæ ‡ç³»ç»Ÿ](#12-åæ ‡ç³»ç»Ÿ)
    - [1.3 PostGIS è®¾ç½®](#13-postgis-è®¾ç½®)
  - [2. åœ°ç†å›´æ ](#2-åœ°ç†å›´æ )
    - [2.1 åœ†å½¢å›´æ ](#21-åœ†å½¢å›´æ )
    - [2.2 å¤šè¾¹å½¢å›´æ ](#22-å¤šè¾¹å½¢å›´æ )
    - [2.3 åŠ¨æ€å›´æ ](#23-åŠ¨æ€å›´æ )
  - [3. è·¯å¾„è§„åˆ’](#3-è·¯å¾„è§„åˆ’)
    - [3.1 æœ€çŸ­è·¯å¾„](#31-æœ€çŸ­è·¯å¾„)
    - [3.2 æœ€ä¼˜è·¯å¾„](#32-æœ€ä¼˜è·¯å¾„)
    - [3.3 å¤šè·¯å¾„è§„åˆ’](#33-å¤šè·¯å¾„è§„åˆ’)
  - [4. é™„è¿‘æœç´¢](#4-é™„è¿‘æœç´¢)
    - [4.1 è·ç¦»æœç´¢](#41-è·ç¦»æœç´¢)
    - [4.2 æœ€è¿‘é‚»æœç´¢](#42-æœ€è¿‘é‚»æœç´¢)
    - [4.3 åŒºåŸŸæœç´¢](#43-åŒºåŸŸæœç´¢)
  - [5. ä½ç½®è¿½è¸ª](#5-ä½ç½®è¿½è¸ª)
    - [5.1 å®æ—¶ä½ç½®](#51-å®æ—¶ä½ç½®)
    - [5.2 å†å²è½¨è¿¹](#52-å†å²è½¨è¿¹)
    - [5.3 è½¨è¿¹åˆ†æ](#53-è½¨è¿¹åˆ†æ)
  - [6. ä½ç½®åˆ†æ](#6-ä½ç½®åˆ†æ)
    - [6.1 çƒ­åŠ›å›¾åˆ†æ](#61-çƒ­åŠ›å›¾åˆ†æ)
    - [6.2 åŒºåŸŸç»Ÿè®¡](#62-åŒºåŸŸç»Ÿè®¡)
    - [6.3 ä½ç½®èšç±»](#63-ä½ç½®èšç±»)
  - [7. æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
    - [7.1 ç´¢å¼•ä¼˜åŒ–](#71-ç´¢å¼•ä¼˜åŒ–)
    - [7.2 æŸ¥è¯¢ä¼˜åŒ–](#72-æŸ¥è¯¢ä¼˜åŒ–)
    - [7.3 å­˜å‚¨ä¼˜åŒ–](#73-å­˜å‚¨ä¼˜åŒ–)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 è®¾è®¡å»ºè®®](#81-è®¾è®¡å»ºè®®)
    - [8.2 æŸ¥è¯¢å»ºè®®](#82-æŸ¥è¯¢å»ºè®®)
    - [8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#83-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šå¤–å–é…é€ç³»ç»Ÿ](#91-æ¡ˆä¾‹å¤–å–é…é€ç³»ç»Ÿ)
    - [9.2 æ¡ˆä¾‹ï¼šå…±äº«å•è½¦ç³»ç»Ÿ](#92-æ¡ˆä¾‹å…±äº«å•è½¦ç³»ç»Ÿ)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. ä½ç½®æœåŠ¡åŸºç¡€

### 1.1 ä½ç½®æ•°æ®æ¨¡å‹

```sql
-- ä½ç½®æ•°æ®æ¨¡å‹
-- 1. åˆ›å»ºä½ç½®è¡¨
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    geom GEOMETRY(POINT, 4326),  -- WGS84 åæ ‡ç³»
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_locations_geom ON locations USING GIST (geom);
CREATE INDEX idx_locations_lat_lon ON locations (latitude, longitude);

-- 3. æ’å…¥ä½ç½®æ•°æ®
INSERT INTO locations (name, latitude, longitude, geom)
VALUES (
    'Beijing',
    39.9093,
    116.3974,
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
);
```

### 1.2 åæ ‡ç³»ç»Ÿ

```sql
-- åæ ‡ç³»ç»Ÿ
-- 1. WGS84 (GPS åæ ‡)
SELECT ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326) AS wgs84_point;

-- 2. Web Mercator (Web åœ°å›¾)
SELECT ST_Transform(
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    3857
) AS web_mercator_point;

-- 3. åæ ‡è½¬æ¢
SELECT ST_Transform(
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    3857  -- è½¬æ¢ä¸º Web Mercator
) AS transformed_point;
```

### 1.3 PostGIS è®¾ç½®

```sql
-- PostGIS è®¾ç½®
-- 1. å¯ç”¨ PostGIS
CREATE EXTENSION IF NOT EXISTS postgis;

-- 2. éªŒè¯ PostGIS
SELECT PostGIS_Version();

-- 3. åˆ›å»ºç©ºé—´ç´¢å¼•
CREATE INDEX idx_locations_geom ON locations USING GIST (geom);
```

---

## 2. åœ°ç†å›´æ 

### 2.1 åœ†å½¢å›´æ 

```sql
-- åœ†å½¢å›´æ 
-- 1. åˆ›å»ºåœ†å½¢å›´æ 
CREATE TABLE geofences (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    center GEOMETRY(POINT, 4326),
    radius_meters DOUBLE PRECISION,
    geom GEOMETRY(POLYGON, 4326),  -- åœ†å½¢å›´æ å¤šè¾¹å½¢
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. åˆ›å»ºåœ†å½¢å›´æ å‡ ä½•
INSERT INTO geofences (name, center, radius_meters, geom)
VALUES (
    'Beijing Center',
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    5000,  -- 5 å…¬é‡Œ
    ST_Transform(
        ST_Buffer(
            ST_Transform(
                ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
                3857
            ),
            5000  -- 5 å…¬é‡Œï¼ˆç±³ï¼‰
        ),
        4326
    )
);

-- 3. æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å›´æ å†…
SELECT
    l.name,
    g.name AS geofence_name
FROM locations l
JOIN geofences g ON ST_Within(l.geom, g.geom)
WHERE l.id = 1;
```

### 2.2 å¤šè¾¹å½¢å›´æ 

```sql
-- å¤šè¾¹å½¢å›´æ 
-- 1. åˆ›å»ºå¤šè¾¹å½¢å›´æ 
CREATE TABLE polygon_geofences (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    geom GEOMETRY(POLYGON, 4326),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. æ’å…¥å¤šè¾¹å½¢å›´æ 
INSERT INTO polygon_geofences (name, geom)
VALUES (
    'Beijing Area',
    ST_GeomFromText(
        'POLYGON((
            116.0 39.0,
            117.0 39.0,
            117.0 40.0,
            116.0 40.0,
            116.0 39.0
        ))',
        4326
    )
);

-- 3. æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å›´æ å†…
SELECT
    l.name,
    g.name AS geofence_name
FROM locations l
JOIN polygon_geofences g ON ST_Within(l.geom, g.geom)
WHERE l.id = 1;
```

### 2.3 åŠ¨æ€å›´æ 

```sql
-- åŠ¨æ€å›´æ 
-- 1. åˆ›å»ºåŠ¨æ€å›´æ è¡¨
CREATE TABLE dynamic_geofences (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    user_id INTEGER,
    center GEOMETRY(POINT, 4326),
    radius_meters DOUBLE PRECISION,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. åˆ›å»ºåŠ¨æ€å›´æ å‡½æ•°
CREATE OR REPLACE FUNCTION check_dynamic_geofence(
    p_location GEOMETRY,
    p_user_id INTEGER
)
RETURNS TABLE (
    geofence_id INTEGER,
    geofence_name VARCHAR,
    distance_meters DOUBLE PRECISION
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        g.id,
        g.name,
        ST_Distance(
            ST_Transform(p_location, 3857),
            ST_Transform(g.center, 3857)
        ) AS distance
    FROM dynamic_geofences g
    WHERE g.user_id = p_user_id
    AND g.active = true
    AND ST_DWithin(
        ST_Transform(p_location, 3857),
        ST_Transform(g.center, 3857),
        g.radius_meters
    );
END;
$$ LANGUAGE plpgsql;

-- 3. ä½¿ç”¨åŠ¨æ€å›´æ 
SELECT * FROM check_dynamic_geofence(
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    1
);
```

---

## 3. è·¯å¾„è§„åˆ’

### 3.1 æœ€çŸ­è·¯å¾„

```sql
-- æœ€çŸ­è·¯å¾„ï¼ˆä½¿ç”¨ pgRoutingï¼‰
-- 1. å®‰è£… pgRouting
CREATE EXTENSION IF NOT EXISTS pgrouting;

-- 2. åˆ›å»ºè·¯ç½‘è¡¨
CREATE TABLE road_network (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    source INTEGER,
    target INTEGER,
    cost DOUBLE PRECISION,  -- è·ç¦»æˆ–æ—¶é—´æˆæœ¬
    reverse_cost DOUBLE PRECISION,
    geom GEOMETRY(LINESTRING, 4326)
);

CREATE INDEX idx_road_network_geom ON road_network USING GIST (geom);

-- 3. æœ€çŸ­è·¯å¾„æŸ¥è¯¢
SELECT * FROM pgr_dijkstra(
    'SELECT id, source, target, cost, reverse_cost FROM road_network',
    1,  -- èµ·ç‚¹èŠ‚ç‚¹ ID
    10,  -- ç»ˆç‚¹èŠ‚ç‚¹ ID
    directed := false
);

-- 4. è·å–è·¯å¾„å‡ ä½•
SELECT
    r.name,
    r.geom
FROM road_network r
JOIN pgr_dijkstra(
    'SELECT id, source, target, cost FROM road_network',
    1,
    10,
    directed := false
) AS path ON r.id = path.edge;
```

### 3.2 æœ€ä¼˜è·¯å¾„

```sql
-- æœ€ä¼˜è·¯å¾„ï¼ˆè€ƒè™‘å¤šç§å› ç´ ï¼‰
-- 1. åˆ›å»ºå¸¦æƒé‡çš„è·¯ç½‘è¡¨
CREATE TABLE weighted_road_network (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    source INTEGER,
    target INTEGER,
    distance DOUBLE PRECISION,
    time_cost DOUBLE PRECISION,
    toll_cost DOUBLE PRECISION,
    geom GEOMETRY(LINESTRING, 4326)
);

-- 2. è®¡ç®—ç»¼åˆæˆæœ¬
CREATE OR REPLACE FUNCTION calculate_total_cost(
    p_distance DOUBLE PRECISION,
    p_time_cost DOUBLE PRECISION,
    p_toll_cost DOUBLE PRECISION,
    p_weight_distance DOUBLE PRECISION DEFAULT 1.0,
    p_weight_time DOUBLE PRECISION DEFAULT 1.0,
    p_weight_toll DOUBLE PRECISION DEFAULT 1.0
)
RETURNS DOUBLE PRECISION AS $$
BEGIN
    RETURN
        p_distance * p_weight_distance +
        p_time_cost * p_weight_time +
        p_toll_cost * p_weight_toll;
END;
$$ LANGUAGE plpgsql;

-- 3. æœ€ä¼˜è·¯å¾„æŸ¥è¯¢
SELECT * FROM pgr_dijkstra(
    'SELECT
        id,
        source,
        target,
        calculate_total_cost(distance, time_cost, toll_cost) AS cost
     FROM weighted_road_network',
    1,
    10,
    directed := false
);
```

### 3.3 å¤šè·¯å¾„è§„åˆ’

```sql
-- å¤šè·¯å¾„è§„åˆ’
-- 1. K æœ€çŸ­è·¯å¾„
SELECT * FROM pgr_ksp(
    'SELECT id, source, target, cost FROM road_network',
    1,
    10,
    3,  -- K å€¼ï¼ˆè¿”å› 3 æ¡è·¯å¾„ï¼‰
    directed := false
);

-- 2. å¤‡é€‰è·¯å¾„
SELECT * FROM pgr_alternatives(
    'SELECT id, source, target, cost FROM road_network',
    1,
    10,
    directed := false
);
```

---

## 4. é™„è¿‘æœç´¢

### 4.1 è·ç¦»æœç´¢

```sql
-- è·ç¦»æœç´¢
-- 1. æœç´¢æŒ‡å®šè·ç¦»å†…çš„ä½ç½®
SELECT
    name,
    ST_Distance(
        ST_Transform(geom, 3857),
        ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857)
    ) AS distance_meters
FROM locations
WHERE ST_DWithin(
    ST_Transform(geom, 3857),
    ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857),
    5000  -- 5 å…¬é‡Œ
)
ORDER BY distance_meters;

-- 2. æœç´¢æŒ‡å®šè·ç¦»å†…çš„ä½ç½®ï¼ˆä½¿ç”¨åº¦ï¼‰
SELECT
    name,
    ST_Distance(
        geom,
        ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
    ) AS distance_degrees
FROM locations
WHERE ST_DWithin(
    geom,
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    0.05  -- çº¦ 5 å…¬é‡Œï¼ˆåº¦ï¼‰
)
ORDER BY distance_degrees;
```

### 4.2 æœ€è¿‘é‚»æœç´¢

```sql
-- æœ€è¿‘é‚»æœç´¢
-- 1. ä½¿ç”¨ <-> æ“ä½œç¬¦ï¼ˆæœ€å¿«ï¼‰
SELECT
    name,
    ST_Distance(
        ST_Transform(geom, 3857),
        ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857)
    ) AS distance_meters
FROM locations
ORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
LIMIT 10;

-- 2. ä½¿ç”¨ <#> æ“ä½œç¬¦ï¼ˆè¾¹ç•Œæ¡†è·ç¦»ï¼‰
SELECT
    name,
    ST_Distance(
        ST_Transform(geom, 3857),
        ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857)
    ) AS distance_meters
FROM locations
ORDER BY geom <#> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
LIMIT 10;
```

### 4.3 åŒºåŸŸæœç´¢

```sql
-- åŒºåŸŸæœç´¢
-- 1. çŸ©å½¢åŒºåŸŸæœç´¢
SELECT
    name,
    geom
FROM locations
WHERE geom && ST_MakeEnvelope(116.0, 39.0, 117.0, 40.0, 4326)
AND ST_Within(geom, ST_MakeEnvelope(116.0, 39.0, 117.0, 40.0, 4326));

-- 2. åœ†å½¢åŒºåŸŸæœç´¢
SELECT
    name,
    geom
FROM locations
WHERE ST_DWithin(
    ST_Transform(geom, 3857),
    ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857),
    5000  -- 5 å…¬é‡Œ
);

-- 3. å¤šè¾¹å½¢åŒºåŸŸæœç´¢
SELECT
    name,
    geom
FROM locations
WHERE ST_Within(
    geom,
    ST_GeomFromText(
        'POLYGON((
            116.0 39.0,
            117.0 39.0,
            117.0 40.0,
            116.0 40.0,
            116.0 39.0
        ))',
        4326
    )
);
```

---

## 5. ä½ç½®è¿½è¸ª

### 5.1 å®æ—¶ä½ç½®

```sql
-- å®æ—¶ä½ç½®
-- 1. åˆ›å»ºä½ç½®è¿½è¸ªè¡¨
CREATE TABLE location_tracking (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    geom GEOMETRY(POINT, 4326),
    accuracy DOUBLE PRECISION,
    timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_location_tracking_user_time ON location_tracking (user_id, timestamp DESC);
CREATE INDEX idx_location_tracking_geom ON location_tracking USING GIST (geom);

-- 2. æ’å…¥å®æ—¶ä½ç½®
INSERT INTO location_tracking (user_id, latitude, longitude, geom, accuracy)
VALUES (
    1,
    39.9093,
    116.3974,
    ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326),
    10.0
);

-- 3. æŸ¥è¯¢æœ€æ–°ä½ç½®
SELECT
    user_id,
    latitude,
    longitude,
    timestamp
FROM location_tracking
WHERE user_id = 1
ORDER BY timestamp DESC
LIMIT 1;
```

### 5.2 å†å²è½¨è¿¹

```sql
-- å†å²è½¨è¿¹
-- 1. æŸ¥è¯¢ç”¨æˆ·è½¨è¿¹
SELECT
    timestamp,
    latitude,
    longitude,
    geom
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp;

-- 2. ç”Ÿæˆè½¨è¿¹çº¿
SELECT
    user_id,
    ST_MakeLine(geom ORDER BY timestamp) AS trajectory
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_id;

-- 3. è½¨è¿¹ç®€åŒ–
SELECT
    user_id,
    ST_Simplify(
        ST_MakeLine(geom ORDER BY timestamp),
        0.0001
    ) AS simplified_trajectory
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_id;
```

### 5.3 è½¨è¿¹åˆ†æ

```sql
-- è½¨è¿¹åˆ†æ
-- 1. è®¡ç®—è½¨è¿¹é•¿åº¦
SELECT
    user_id,
    ST_Length(
        ST_Transform(
            ST_MakeLine(geom ORDER BY timestamp),
            3857
        )
    ) AS trajectory_length_meters
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_id;

-- 2. è®¡ç®—å¹³å‡é€Ÿåº¦
SELECT
    user_id,
    AVG(
        ST_Distance(
            ST_Transform(lag(geom) OVER (PARTITION BY user_id ORDER BY timestamp), 3857),
            ST_Transform(geom, 3857)
        ) / EXTRACT(EPOCH FROM (timestamp - lag(timestamp) OVER (PARTITION BY user_id ORDER BY timestamp)))
    ) AS avg_speed_mps
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours';

-- 3. åœç•™ç‚¹æ£€æµ‹
SELECT
    user_id,
    ST_Centroid(ST_Collect(geom)) AS stay_point,
    COUNT(*) AS stay_duration_minutes
FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_id, DATE_TRUNC('hour', timestamp)
HAVING COUNT(*) >= 10;  -- åœç•™è¶…è¿‡ 10 ä¸ªç‚¹
```

---

## 6. ä½ç½®åˆ†æ

### 6.1 çƒ­åŠ›å›¾åˆ†æ

```sql
-- çƒ­åŠ›å›¾åˆ†æ
-- 1. åˆ›å»ºç½‘æ ¼
CREATE TABLE heatmap_grid (
    id SERIAL PRIMARY KEY,
    geom GEOMETRY(POLYGON, 4326)
);

-- 2. è®¡ç®—ç½‘æ ¼çƒ­åº¦
SELECT
    g.id,
    g.geom,
    COUNT(l.id) AS point_count,
    ST_Centroid(g.geom) AS center
FROM heatmap_grid g
LEFT JOIN location_tracking l ON ST_Within(l.geom, g.geom)
WHERE l.timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY g.id, g.geom
ORDER BY point_count DESC;
```

### 6.2 åŒºåŸŸç»Ÿè®¡

```sql
-- åŒºåŸŸç»Ÿè®¡
-- 1. æŒ‰åŒºåŸŸç»Ÿè®¡ä½ç½®æ•°é‡
SELECT
    r.name AS region_name,
    COUNT(l.id) AS location_count,
    ST_Area(ST_Transform(r.geom, 3857)) AS area_m2
FROM regions r
LEFT JOIN locations l ON ST_Within(l.geom, r.geom)
GROUP BY r.id, r.name, r.geom
ORDER BY location_count DESC;

-- 2. æŒ‰æ—¶é—´æ®µç»Ÿè®¡
SELECT
    DATE_TRUNC('hour', timestamp) AS hour,
    COUNT(*) AS location_count
FROM location_tracking
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour;
```

### 6.3 ä½ç½®èšç±»

```sql
-- ä½ç½®èšç±»
-- 1. ä½¿ç”¨ DBSCAN èšç±»ï¼ˆéœ€è¦åœ¨åº”ç”¨å±‚å®ç°ï¼‰
-- 2. ä½¿ç”¨ç½‘æ ¼èšç±»
SELECT
    ST_SnapToGrid(geom, 0.01) AS grid_cell,
    COUNT(*) AS point_count,
    ST_Centroid(ST_Collect(geom)) AS cluster_center
FROM location_tracking
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY ST_SnapToGrid(geom, 0.01)
HAVING COUNT(*) >= 5  -- è‡³å°‘ 5 ä¸ªç‚¹
ORDER BY point_count DESC;
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- ç´¢å¼•ä¼˜åŒ–
-- 1. ç©ºé—´ç´¢å¼•
CREATE INDEX idx_locations_geom ON locations USING GIST (geom);

-- 2. æ—¶é—´ç´¢å¼•
CREATE INDEX idx_location_tracking_time ON location_tracking (timestamp DESC);

-- 3. å¤åˆç´¢å¼•
CREATE INDEX idx_location_tracking_user_time ON location_tracking (user_id, timestamp DESC);

-- 4. éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_location_tracking_recent ON location_tracking (user_id, timestamp DESC)
WHERE timestamp >= NOW() - INTERVAL '7 days';
```

### 7.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æŸ¥è¯¢ä¼˜åŒ–
-- 1. ä½¿ç”¨ç©ºé—´ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
SELECT * FROM locations
WHERE geom && ST_MakeEnvelope(116.0, 39.0, 117.0, 40.0, 4326)
AND ST_Within(geom, ST_MakeEnvelope(116.0, 39.0, 117.0, 40.0, 4326));

-- 2. ä½¿ç”¨æœ€è¿‘é‚»æ“ä½œç¬¦
SELECT * FROM locations
ORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
LIMIT 10;

-- 3. é™åˆ¶æŸ¥è¯¢èŒƒå›´
SELECT * FROM location_tracking
WHERE user_id = 1
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC
LIMIT 100;
```

### 7.3 å­˜å‚¨ä¼˜åŒ–

```sql
-- å­˜å‚¨ä¼˜åŒ–
-- 1. åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´ï¼‰
CREATE TABLE location_tracking_2024_01 PARTITION OF location_tracking
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 2. æ•°æ®å½’æ¡£
CREATE TABLE location_tracking_archive (
    LIKE location_tracking INCLUDING ALL
);

-- 3. å®šæœŸæ¸…ç†æ—§æ•°æ®
DELETE FROM location_tracking
WHERE timestamp < NOW() - INTERVAL '90 days';
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨åˆé€‚çš„å‡ ä½•ç±»å‹
CREATE TABLE locations (
    geom GEOMETRY(POINT, 4326)  -- æ˜ç¡®æŒ‡å®šç±»å‹
);

-- æ¨èï¼šåˆ›å»ºç©ºé—´ç´¢å¼•
CREATE INDEX idx_locations_geom ON locations USING GIST (geom);

-- æ¨èï¼šä½¿ç”¨æ—¶é—´åˆ†åŒº
CREATE TABLE location_tracking_2024_01 PARTITION OF location_tracking
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- é¿å…ï¼šä¸åˆ›å»ºç©ºé—´ç´¢å¼•
-- é¿å…ï¼šå­˜å‚¨è¿‡å¤šå†å²æ•°æ®
```

### 8.2 æŸ¥è¯¢å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨ç©ºé—´ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
WHERE geom && ST_MakeEnvelope(...)

-- æ¨èï¼šä½¿ç”¨æœ€è¿‘é‚»æ“ä½œç¬¦
ORDER BY geom <-> point

-- æ¨èï¼šé™åˆ¶æŸ¥è¯¢èŒƒå›´
WHERE timestamp >= NOW() - INTERVAL '24 hours'

-- é¿å…ï¼šä¸ä½¿ç”¨ç©ºé—´ç´¢å¼•
-- é¿å…ï¼šæŸ¥è¯¢è¿‡å¤šå†å²æ•°æ®
```

### 8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- æ¨èï¼šåˆ›å»ºç©ºé—´ç´¢å¼•
CREATE INDEX idx_locations_geom ON locations USING GIST (geom);

-- æ¨èï¼šä½¿ç”¨æ—¶é—´åˆ†åŒº
CREATE TABLE location_tracking_2024_01 PARTITION OF location_tracking
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- æ¨èï¼šå®šæœŸæ¸…ç†æ—§æ•°æ®
DELETE FROM location_tracking
WHERE timestamp < NOW() - INTERVAL '90 days';

-- é¿å…ï¼šä¸ç»´æŠ¤ç´¢å¼•
-- é¿å…ï¼šå­˜å‚¨è¿‡å¤šå†å²æ•°æ®
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šå¤–å–é…é€ç³»ç»Ÿ

**åœºæ™¯**ï¼šå¤–å–é…é€ä½ç½®æœåŠ¡ç³»ç»Ÿ

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºé…é€å‘˜ä½ç½®è¡¨
CREATE TABLE delivery_locations (
    id SERIAL PRIMARY KEY,
    delivery_id INTEGER,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    geom GEOMETRY(POINT, 4326),
    timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_delivery_locations_geom ON delivery_locations USING GIST (geom);
CREATE INDEX idx_delivery_locations_delivery_time ON delivery_locations (delivery_id, timestamp DESC);

-- 2. æŸ¥è¯¢é™„è¿‘é…é€å‘˜
SELECT
    delivery_id,
    ST_Distance(
        ST_Transform(geom, 3857),
        ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857)
    ) AS distance_meters
FROM delivery_locations
WHERE timestamp >= NOW() - INTERVAL '5 minutes'
ORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
LIMIT 10;

-- 3. è·¯å¾„è§„åˆ’
SELECT * FROM pgr_dijkstra(
    'SELECT id, source, target, cost FROM road_network',
    (SELECT source FROM road_network ORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326) LIMIT 1),
    (SELECT source FROM road_network ORDER BY geom <-> ST_SetSRID(ST_MakePoint(121.4737, 31.2304), 4326) LIMIT 1),
    directed := false
);
```

**æ•ˆæœ**ï¼š

- é™„è¿‘æœç´¢ï¼š< 50ms
- è·¯å¾„è§„åˆ’ï¼š< 200ms
- æ”¯æŒå®æ—¶ä½ç½®è¿½è¸ª

### 9.2 æ¡ˆä¾‹ï¼šå…±äº«å•è½¦ç³»ç»Ÿ

**åœºæ™¯**ï¼šå…±äº«å•è½¦ä½ç½®æœåŠ¡ç³»ç»Ÿ

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºå•è½¦ä½ç½®è¡¨
CREATE TABLE bike_locations (
    id SERIAL PRIMARY KEY,
    bike_id INTEGER,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    geom GEOMETRY(POINT, 4326),
    status VARCHAR(20),  -- available, in_use, maintenance
    timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_bike_locations_geom ON bike_locations USING GIST (geom);
CREATE INDEX idx_bike_locations_status ON bike_locations (status);

-- 2. æŸ¥è¯¢é™„è¿‘å¯ç”¨å•è½¦
SELECT
    bike_id,
    ST_Distance(
        ST_Transform(geom, 3857),
        ST_Transform(ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326), 3857)
    ) AS distance_meters
FROM bike_locations
WHERE status = 'available'
AND timestamp >= NOW() - INTERVAL '5 minutes'
ORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.3974, 39.9093), 4326)
LIMIT 10;

-- 3. åŒºåŸŸç»Ÿè®¡
SELECT
    r.name AS region_name,
    COUNT(b.id) AS available_bikes
FROM regions r
LEFT JOIN bike_locations b ON ST_Within(b.geom, r.geom) AND b.status = 'available'
GROUP BY r.id, r.name
ORDER BY available_bikes DESC;
```

**æ•ˆæœ**ï¼š

- é™„è¿‘æœç´¢ï¼š< 30ms
- åŒºåŸŸç»Ÿè®¡ï¼š< 100ms
- æ”¯æŒå®æ—¶ä½ç½®æ›´æ–°

---

## ğŸ“Š æ€»ç»“

PostgreSQL ç»“åˆ PostGIS æä¾›äº†å¼ºå¤§çš„ä½ç½®æœåŠ¡åº”ç”¨èƒ½åŠ›ï¼š

1. **åœ°ç†å›´æ **ï¼šæ”¯æŒåœ†å½¢ã€å¤šè¾¹å½¢ç­‰åœ°ç†å›´æ 
2. **è·¯å¾„è§„åˆ’**ï¼šæ”¯æŒæœ€çŸ­è·¯å¾„ã€æœ€ä¼˜è·¯å¾„è§„åˆ’
3. **é™„è¿‘æœç´¢**ï¼šé«˜æ•ˆçš„é™„è¿‘ä½ç½®æœç´¢
4. **ä½ç½®è¿½è¸ª**ï¼šå®æ—¶ä½ç½®è¿½è¸ªå’Œå†å²è½¨è¿¹åˆ†æ
5. **ä½ç½®åˆ†æ**ï¼šä½ç½®æ•°æ®ç»Ÿè®¡å’Œåˆ†æ

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨åˆé€‚çš„å‡ ä½•ç±»å‹
- åˆ›å»ºç©ºé—´ç´¢å¼•
- ä½¿ç”¨æ—¶é—´åˆ†åŒº
- ä¼˜åŒ–ç©ºé—´æŸ¥è¯¢
- å®šæœŸæ¸…ç†æ—§æ•°æ®

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostGIS å®˜æ–¹æ–‡æ¡£](https://postgis.net/documentation/) - ç©ºé—´æ•°æ®åº“æ‰©å±•
- [OGC æ ‡å‡†æ–‡æ¡£](https://www.ogc.org/standards/sfs) - OGC Simple Features æ ‡å‡†
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ‰©å±•](https://www.postgresql.org/docs/current/extend.html)

### æŠ€æœ¯è®ºæ–‡

- [Location-Based Services: A Survey](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - ä½ç½®æœåŠ¡ç ”ç©¶ç»¼è¿°
- [Spatial Query Processing in Database Systems](https://www.postgis.net/documentation/) - ç©ºé—´æŸ¥è¯¢å¤„ç†ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [PostGIS å®˜æ–¹åšå®¢](https://postgis.net/blog/) - PostGIS æœ€æ–°åŠ¨æ€
- [Understanding Location-Based Services](https://postgis.net/documentation/) - ä½ç½®æœåŠ¡è¯¦è§£
- [PostGIS LBS Best Practices](https://postgis.net/documentation/) - ä½ç½®æœåŠ¡æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostGIS Wiki](https://trac.osgeo.org/postgis/wiki) - PostGIS ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - Location-Based Services](https://stackoverflow.com/questions/tagged/location-based-services) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-TREND-15
