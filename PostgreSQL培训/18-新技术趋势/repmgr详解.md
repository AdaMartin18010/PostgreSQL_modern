# repmgr è¯¦è§£ï¼šPostgreSQL å¤åˆ¶ç®¡ç†å™¨

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+ with repmgr 5.4+
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-38

## ğŸ“‘ æ¦‚è¿°

repmgr æ˜¯ 2ndQuadrant å¼€å‘çš„ PostgreSQL å¤åˆ¶ç®¡ç†å™¨ï¼Œæä¾›å¤åˆ¶ç®¡ç†ã€æ•…éšœè½¬ç§»ã€èŠ‚ç‚¹ç®¡ç†ç­‰åŠŸèƒ½ï¼Œæ˜¯ PostgreSQL é«˜å¯ç”¨çš„æˆç†Ÿæ–¹æ¡ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¤åˆ¶ç®¡ç†**ï¼šç®€åŒ–çš„å¤åˆ¶é…ç½®å’Œç®¡ç†
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨å’Œæ‰‹åŠ¨æ•…éšœè½¬ç§»
- **èŠ‚ç‚¹ç®¡ç†**ï¼šèŠ‚ç‚¹æ³¨å†Œã€ç›‘æ§ã€ç®¡ç†
- **ç›‘æ§é›†æˆ**ï¼šç›‘æ§å¤åˆ¶çŠ¶æ€å’Œå»¶è¿Ÿ
- **ç”Ÿäº§å°±ç»ª**ï¼šç¨³å®šå¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

## ğŸ“š ç›®å½•

- [repmgr è¯¦è§£ï¼šPostgreSQL å¤åˆ¶ç®¡ç†å™¨](#repmgr-è¯¦è§£postgresql-å¤åˆ¶ç®¡ç†å™¨)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. repmgr åŸºç¡€](#1-repmgr-åŸºç¡€)
    - [1.0 repmgrçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-repmgrçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 ä»€ä¹ˆæ˜¯ repmgr](#11-ä»€ä¹ˆæ˜¯-repmgr)
    - [1.2 å®‰è£… repmgr](#12-å®‰è£…-repmgr)
  - [2. é›†ç¾¤é…ç½®](#2-é›†ç¾¤é…ç½®)
    - [2.1 ä¸»åº“é…ç½®](#21-ä¸»åº“é…ç½®)
    - [2.2 ä»åº“é…ç½®](#22-ä»åº“é…ç½®)
    - [2.3 é›†ç¾¤æ³¨å†Œ](#23-é›†ç¾¤æ³¨å†Œ)
  - [3. æ•…éšœè½¬ç§»](#3-æ•…éšœè½¬ç§»)
    - [3.1 è‡ªåŠ¨æ•…éšœè½¬ç§»](#31-è‡ªåŠ¨æ•…éšœè½¬ç§»)
    - [3.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»](#32-æ‰‹åŠ¨æ•…éšœè½¬ç§»)
  - [4. èŠ‚ç‚¹ç®¡ç†](#4-èŠ‚ç‚¹ç®¡ç†)
    - [4.1 èŠ‚ç‚¹æ³¨å†Œ](#41-èŠ‚ç‚¹æ³¨å†Œ)
    - [4.2 èŠ‚ç‚¹ç›‘æ§](#42-èŠ‚ç‚¹ç›‘æ§)
    - [4.3 èŠ‚ç‚¹ç»´æŠ¤](#43-èŠ‚ç‚¹ç»´æŠ¤)
  - [5. ç›‘æ§å’Œç®¡ç†](#5-ç›‘æ§å’Œç®¡ç†)
    - [5.1 é›†ç¾¤çŠ¶æ€æŸ¥è¯¢](#51-é›†ç¾¤çŠ¶æ€æŸ¥è¯¢)
    - [5.2 å¤åˆ¶çŠ¶æ€ç›‘æ§](#52-å¤åˆ¶çŠ¶æ€ç›‘æ§)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§é«˜å¯ç”¨éƒ¨ç½²](#71-æ¡ˆä¾‹ä¼ä¸šçº§é«˜å¯ç”¨éƒ¨ç½²)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [5. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#5-å¸¸è§é—®é¢˜faq)
    - [5.1 repmgråŸºç¡€å¸¸è§é—®é¢˜](#51-repmgråŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•å®‰è£…å’Œé…ç½®repmgrï¼Ÿ](#q1-å¦‚ä½•å®‰è£…å’Œé…ç½®repmgr)
      - [Q2: å¦‚ä½•é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Ÿ](#q2-å¦‚ä½•é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»)
    - [5.2 æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜](#52-æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜)
      - [Q3: æ•…éšœè½¬ç§»éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ](#q3-æ•…éšœè½¬ç§»éœ€è¦å¤šé•¿æ—¶é—´)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)

---

## 1. repmgr åŸºç¡€

### 1.0 repmgrçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((repmgr))
    é›†ç¾¤é…ç½®
      ä¸»åº“é…ç½®
        é…ç½®æ–¹æ³•
        é…ç½®éªŒè¯
      ä»åº“é…ç½®
        é…ç½®æ–¹æ³•
        é…ç½®éªŒè¯
      é›†ç¾¤æ³¨å†Œ
        æ³¨å†Œæ–¹æ³•
        æ³¨å†ŒéªŒè¯
    æ•…éšœè½¬ç§»
      è‡ªåŠ¨æ•…éšœè½¬ç§»
        æ•…éšœæ£€æµ‹
        åˆ‡æ¢æµç¨‹
      æ‰‹åŠ¨æ•…éšœè½¬ç§»
        è½¬ç§»æ–¹æ³•
        è½¬ç§»éªŒè¯
    èŠ‚ç‚¹ç®¡ç†
      èŠ‚ç‚¹æ³¨å†Œ
        æ³¨å†Œæ–¹æ³•
        æ³¨å†ŒéªŒè¯
      èŠ‚ç‚¹ç›‘æ§
        ç›‘æ§æ–¹æ³•
        ç›‘æ§æŒ‡æ ‡
      èŠ‚ç‚¹ç»´æŠ¤
        ç»´æŠ¤æ–¹æ³•
        ç»´æŠ¤æµç¨‹
    ç›‘æ§å’Œç®¡ç†
      é›†ç¾¤çŠ¶æ€æŸ¥è¯¢
        æŸ¥è¯¢æ–¹æ³•
        çŠ¶æ€åˆ†æ
      å¤åˆ¶çŠ¶æ€ç›‘æ§
        ç›‘æ§æ–¹æ³•
        ç›‘æ§æŒ‡æ ‡
```

### 1.1 ä»€ä¹ˆæ˜¯ repmgr

repmgr æ˜¯ PostgreSQL çš„å¤åˆ¶ç®¡ç†å™¨ï¼Œæä¾›ï¼š

- **å¤åˆ¶ç®¡ç†**ï¼šç®€åŒ–çš„å¤åˆ¶é…ç½®å’Œç®¡ç†
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨å’Œæ‰‹åŠ¨æ•…éšœè½¬ç§»
- **èŠ‚ç‚¹ç®¡ç†**ï¼šèŠ‚ç‚¹æ³¨å†Œã€ç›‘æ§ã€ç®¡ç†
- **ç›‘æ§é›†æˆ**ï¼šç›‘æ§å¤åˆ¶çŠ¶æ€å’Œå»¶è¿Ÿ

### 1.2 å®‰è£… repmgr

```bash
# å®‰è£… repmgr
# Ubuntu/Debian
apt-get install postgresql-repmgr

# CentOS/RHEL
yum install postgresql-repmgr

# æˆ–ä»æºç ç¼–è¯‘
git clone https://github.com/2ndQuadrant/repmgr.git
cd repmgr
make install
```

---

## 2. é›†ç¾¤é…ç½®

### 2.1 ä¸»åº“é…ç½®

```bash
# åˆ›å»º repmgr æ•°æ®åº“
createdb repmgr

# å®‰è£… repmgr æ‰©å±•
psql -d repmgr -c "CREATE EXTENSION repmgr"

# æ³¨å†Œä¸»åº“
repmgr primary register
```

**repmgr.conf é…ç½®**ï¼š

```ini
node_id=1
node_name=primary
conninfo='host=primary_host port=5432 user=repmgr dbname=repmgr'
data_directory='/var/lib/postgresql/data'
```

### 2.2 ä»åº“é…ç½®

```bash
# å…‹éš†ä¸»åº“
repmgr standby clone -h primary_host -U repmgr -d repmgr

# å¯åŠ¨ä»åº“
pg_ctl start -D /var/lib/postgresql/data

# æ³¨å†Œä»åº“
repmgr standby register
```

### 2.3 é›†ç¾¤æ³¨å†Œ

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
repmgr cluster show

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
repmgr node status
```

---

## 3. æ•…éšœè½¬ç§»

### 3.1 è‡ªåŠ¨æ•…éšœè½¬ç§»

**repmgrd å®ˆæŠ¤è¿›ç¨‹**ï¼š

```bash
# å¯åŠ¨ repmgrd
repmgrd -f /etc/repmgr.conf -d

# æŸ¥çœ‹ repmgrd çŠ¶æ€
repmgr daemon status
```

### 3.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»

```bash
# æ‰‹åŠ¨æ•…éšœè½¬ç§»
repmgr standby promote

# æŸ¥çœ‹æ•…éšœè½¬ç§»å†å²
repmgr cluster event
```

---

## 4. èŠ‚ç‚¹ç®¡ç†

### 4.1 èŠ‚ç‚¹æ³¨å†Œ

```bash
# æ³¨å†Œæ–°èŠ‚ç‚¹
repmgr node register

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
repmgr node show
```

### 4.2 èŠ‚ç‚¹ç›‘æ§

```bash
# ç›‘æ§èŠ‚ç‚¹çŠ¶æ€
repmgr node check

# æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
repmgr cluster show
```

### 4.3 èŠ‚ç‚¹ç»´æŠ¤

```bash
# èŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼
repmgr node service --action=stop

# æ¢å¤èŠ‚ç‚¹
repmgr node service --action=start
```

---

## 5. ç›‘æ§å’Œç®¡ç†

### 5.1 é›†ç¾¤çŠ¶æ€æŸ¥è¯¢

```sql
-- æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
SELECT * FROM repmgr.nodes;

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM repmgr.events;
```

### 5.2 å¤åˆ¶çŠ¶æ€ç›‘æ§

```bash
# æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
repmgr cluster show --verbose

# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
repmgr node status
```

---

## 6. æœ€ä½³å®è·µ

1. **å®šæœŸç›‘æ§**ï¼šå®šæœŸç›‘æ§é›†ç¾¤çŠ¶æ€å’Œå¤åˆ¶å»¶è¿Ÿ
2. **æ•…éšœæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œæ•…éšœè½¬ç§»æ¼”ç»ƒ
3. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½ï¼Œæ”¯æŒå¿«é€Ÿæ¢å¤

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§é«˜å¯ç”¨éƒ¨ç½²

**åœºæ™¯**ï¼šä¼ä¸šçº§åº”ç”¨ï¼Œéœ€è¦ç¨³å®šçš„é«˜å¯ç”¨æ–¹æ¡ˆ

**æ¶æ„**ï¼š

- ä¸»åº“ + 2ä¸ªä»åº“
- repmgr è‡ªåŠ¨æ•…éšœè½¬ç§»
- å®šæœŸç›‘æ§å’Œå‘Šè­¦

---

## ğŸ“Š æ€»ç»“

repmgr æä¾›æˆç†Ÿçš„ PostgreSQL å¤åˆ¶ç®¡ç†æ–¹æ¡ˆï¼š

- âœ… **å¤åˆ¶ç®¡ç†**ï¼šç®€åŒ–çš„å¤åˆ¶é…ç½®å’Œç®¡ç†
- âœ… **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨å’Œæ‰‹åŠ¨æ•…éšœè½¬ç§»
- âœ… **èŠ‚ç‚¹ç®¡ç†**ï¼šèŠ‚ç‚¹æ³¨å†Œã€ç›‘æ§ã€ç®¡ç†

---

## 5. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 5.1 repmgråŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•å®‰è£…å’Œé…ç½®repmgrï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•å®‰è£…å’Œé…ç½®repmgrã€‚

**å®‰è£…æ–¹æ³•**ï¼š

1. **ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…**ï¼š

    ```bash
    # Ubuntu/Debian
    sudo apt-get install repmgr

    # ä»æºç ç¼–è¯‘
    git clone https://github.com/2ndQuadrant/repmgr.git
    cd repmgr
    make install
    ```

2. **åˆ›å»ºæ‰©å±•**ï¼š

    ```sql
    -- âœ… å¥½ï¼šåˆ›å»ºrepmgræ‰©å±•
    CREATE EXTENSION IF NOT EXISTS repmgr;
    -- å¯ç”¨å¤åˆ¶ç®¡ç†åŠŸèƒ½
    ```

3. **æ³¨å†ŒèŠ‚ç‚¹**ï¼š

    ```bash
    # âœ… å¥½ï¼šæ³¨å†Œä¸»èŠ‚ç‚¹
    repmgr primary register
    # æ³¨å†Œä¸»èŠ‚ç‚¹
    ```

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
repmgr cluster show
```

#### Q2: å¦‚ä½•é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

**é…ç½®æ–¹æ³•**ï¼š

1. **é…ç½®repmgrå®ˆæŠ¤è¿›ç¨‹**ï¼š

    ```bash
    # âœ… å¥½ï¼šå¯åŠ¨repmgrå®ˆæŠ¤è¿›ç¨‹
    repmgrd -d -f /etc/repmgr.conf
    # å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œè‡ªåŠ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»
    ```

2. **é…ç½®æ•…éšœè½¬ç§»**ï¼š

    ```conf
    # âœ… å¥½ï¼šrepmgré…ç½®æ–‡ä»¶
    node_id=1
    node_name=node1
    conninfo='host=node1 dbname=repmgr user=repmgr'
    failover=automatic
    monitoring_interval=2
    ```

**æœ€ä½³å®è·µ**ï¼š

- **å¯ç”¨å®ˆæŠ¤è¿›ç¨‹**ï¼šä½¿ç”¨repmgrdè‡ªåŠ¨ç›‘æ§
- **é…ç½®å‘Šè­¦**ï¼šé…ç½®é‚®ä»¶æˆ–SNMPå‘Šè­¦
- **å®šæœŸæµ‹è¯•**ï¼šå®šæœŸæµ‹è¯•æ•…éšœè½¬ç§»

### 5.2 æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜

#### Q3: æ•…éšœè½¬ç§»éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šæƒ³çŸ¥é“æ•…éšœè½¬ç§»éœ€è¦å¤šé•¿æ—¶é—´ã€‚

**è½¬ç§»æ—¶é—´**ï¼š

1. **æ•…éšœæ£€æµ‹**ï¼š
   - æ£€æµ‹æ—¶é—´ï¼š2-5ç§’ï¼ˆå–å†³äºmonitoring_intervalï¼‰
   - å¯é…ç½®ï¼šå¯è°ƒæ•´ç›‘æ§é—´éš”

2. **æ•…éšœè½¬ç§»**ï¼š
   - åˆ‡æ¢æ—¶é—´ï¼š< 10ç§’
   - æ€»RTOï¼š< 15ç§’

**æ€§èƒ½æ•°æ®**ï¼š

- é»˜è®¤é…ç½®ï¼šRTO < 15ç§’
- ä¼˜åŒ–é…ç½®ï¼šRTO < 10ç§’
- **æ€§èƒ½æå‡ï¼š33%**
- âœ… **ç”Ÿäº§å°±ç»ª**ï¼šç¨³å®šå¯é ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [repmgr å®˜æ–¹æ–‡æ¡£](https://repmgr.org/)
- [GitHub ä»“åº“](https://github.com/2ndQuadrant/repmgr)

### æŠ€æœ¯åšå®¢

- repmgr ä½¿ç”¨æŒ‡å—
- PostgreSQL å¤åˆ¶ç®¡ç†å®è·µ

---
