# æ··åˆæœç´¢æ–¹æ¡ˆï¼šå‘é‡æœç´¢ + å…¨æ–‡æœç´¢

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+ with pgvector + å…¨æ–‡æœç´¢
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-03

## ğŸ“‘ æ¦‚è¿°

æ··åˆæœç´¢ç»“åˆäº†å‘é‡æœç´¢ï¼ˆè¯­ä¹‰æœç´¢ï¼‰å’Œå…¨æ–‡æœç´¢ï¼ˆå…³é”®è¯æœç´¢ï¼‰çš„ä¼˜åŠ¿ï¼Œèƒ½å¤ŸåŒæ—¶åˆ©ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦å’Œå…³é”®è¯åŒ¹é…æ¥æä¾›æ›´å‡†ç¡®çš„æœç´¢ç»“æœã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ PostgreSQL ä¸­å®ç°æ··åˆæœç´¢æ–¹æ¡ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **è¯­ä¹‰æœç´¢**ï¼šç†è§£æŸ¥è¯¢æ„å›¾ï¼Œæ‰¾åˆ°è¯­ä¹‰ç›¸ä¼¼çš„å†…å®¹
- **å…³é”®è¯æœç´¢**ï¼šç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼Œæ‰¾åˆ°ç›¸å…³æ–‡æ¡£
- **æ··åˆæ’åº**ï¼šç»“åˆä¸¤ç§æœç´¢ç»“æœçš„ç»¼åˆæ’åº
- **çµæ´»æƒé‡**ï¼šå¯è°ƒæ•´å‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢çš„æƒé‡
- **é«˜æ€§èƒ½**ï¼šåˆ©ç”¨ç´¢å¼•ä¼˜åŒ–ï¼Œå®ç°å¿«é€Ÿæœç´¢

## ğŸ“š ç›®å½•

- [æ··åˆæœç´¢æ–¹æ¡ˆï¼šå‘é‡æœç´¢ + å…¨æ–‡æœç´¢](#æ··åˆæœç´¢æ–¹æ¡ˆå‘é‡æœç´¢--å…¨æ–‡æœç´¢)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. æ··åˆæœç´¢æ¦‚è¿°](#1-æ··åˆæœç´¢æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æ··åˆæœç´¢](#11-ä»€ä¹ˆæ˜¯æ··åˆæœç´¢)
    - [1.2 æ··åˆæœç´¢ä¼˜åŠ¿](#12-æ··åˆæœç´¢ä¼˜åŠ¿)
    - [1.3 åº”ç”¨åœºæ™¯](#13-åº”ç”¨åœºæ™¯)
  - [2. å‘é‡æœç´¢åŸºç¡€](#2-å‘é‡æœç´¢åŸºç¡€)
    - [2.1 å®‰è£… pgvector](#21-å®‰è£…-pgvector)
    - [2.2 åˆ›å»ºå‘é‡åˆ—](#22-åˆ›å»ºå‘é‡åˆ—)
    - [2.3 å‘é‡æœç´¢æŸ¥è¯¢](#23-å‘é‡æœç´¢æŸ¥è¯¢)
  - [3. å…¨æ–‡æœç´¢åŸºç¡€](#3-å…¨æ–‡æœç´¢åŸºç¡€)
    - [3.1 åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•](#31-åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•)
    - [3.2 å…¨æ–‡æœç´¢æŸ¥è¯¢](#32-å…¨æ–‡æœç´¢æŸ¥è¯¢)
  - [4. æ··åˆæœç´¢å®ç°](#4-æ··åˆæœç´¢å®ç°)
    - [4.1 åŸºç¡€æ··åˆæœç´¢](#41-åŸºç¡€æ··åˆæœç´¢)
    - [4.2 ä½¿ç”¨æ··åˆæœç´¢](#42-ä½¿ç”¨æ··åˆæœç´¢)
  - [5. æ’åºç­–ç•¥](#5-æ’åºç­–ç•¥)
    - [5.1 åŠ æƒæ··åˆæ’åº](#51-åŠ æƒæ··åˆæ’åº)
    - [5.2 é‡æ’åºç­–ç•¥](#52-é‡æ’åºç­–ç•¥)
  - [6. æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
    - [6.1 ç´¢å¼•ä¼˜åŒ–](#61-ç´¢å¼•ä¼˜åŒ–)
    - [6.2 æŸ¥è¯¢ä¼˜åŒ–](#62-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.3 ç¼“å­˜ç­–ç•¥](#63-ç¼“å­˜ç­–ç•¥)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šç”µå•†å•†å“æœç´¢](#71-æ¡ˆä¾‹ç”µå•†å•†å“æœç´¢)
    - [7.2 æ¡ˆä¾‹ï¼šçŸ¥è¯†åº“æœç´¢](#72-æ¡ˆä¾‹çŸ¥è¯†åº“æœç´¢)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. æ··åˆæœç´¢æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ··åˆæœç´¢

æ··åˆæœç´¢ç»“åˆäº†ï¼š

- **å‘é‡æœç´¢**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æœç´¢ï¼ˆpgvectorï¼‰
- **å…¨æ–‡æœç´¢**ï¼šåŸºäºå…³é”®è¯åŒ¹é…çš„æœç´¢ï¼ˆPostgreSQL å…¨æ–‡æœç´¢ï¼‰

### 1.2 æ··åˆæœç´¢ä¼˜åŠ¿

- **æ›´å‡†ç¡®**ï¼šç»“åˆè¯­ä¹‰å’Œå…³é”®è¯ï¼Œæä¾›æ›´å‡†ç¡®çš„ç»“æœ
- **æ›´å…¨é¢**ï¼šè¦†ç›–è¯­ä¹‰ç›¸ä¼¼å’Œå…³é”®è¯åŒ¹é…çš„å†…å®¹
- **æ›´çµæ´»**ï¼šå¯æ ¹æ®åœºæ™¯è°ƒæ•´æƒé‡

### 1.3 åº”ç”¨åœºæ™¯

- ç”µå•†æœç´¢ï¼šå•†å“åç§° + å•†å“æè¿°è¯­ä¹‰
- å†…å®¹æœç´¢ï¼šæ–‡ç« æ ‡é¢˜ + æ–‡ç« å†…å®¹è¯­ä¹‰
- çŸ¥è¯†åº“æœç´¢ï¼šå…³é”®è¯ + è¯­ä¹‰ç†è§£
- æ¨èç³»ç»Ÿï¼šç”¨æˆ·åå¥½ + å†…å®¹è¯­ä¹‰

---

## 2. å‘é‡æœç´¢åŸºç¡€

### 2.1 å®‰è£… pgvector

```sql
-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;
```

### 2.2 åˆ›å»ºå‘é‡åˆ—

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    embedding vector(1536),  -- OpenAI ada-002
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_documents_embedding_hnsw
ON documents USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

### 2.3 å‘é‡æœç´¢æŸ¥è¯¢

```sql
-- å‘é‡ç›¸ä¼¼åº¦æœç´¢
SELECT
    id,
    title,
    1 - (embedding <=> $1::vector) AS similarity
FROM documents
WHERE embedding IS NOT NULL
ORDER BY embedding <=> $1::vector
LIMIT 10;
```

---

## 3. å…¨æ–‡æœç´¢åŸºç¡€

### 3.1 åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•

```sql
-- åˆ›å»ºå…¨æ–‡æœç´¢åˆ—
ALTER TABLE documents
ADD COLUMN title_tsvector tsvector,
ADD COLUMN content_tsvector tsvector;

-- åˆ›å»º GIN ç´¢å¼•
CREATE INDEX idx_documents_title_fts
ON documents USING GIN (title_tsvector);

CREATE INDEX idx_documents_content_fts
ON documents USING GIN (content_tsvector);

-- æ›´æ–°å…¨æ–‡æœç´¢å‘é‡
UPDATE documents
SET
    title_tsvector = to_tsvector('english', title),
    content_tsvector = to_tsvector('english', content);

-- åˆ›å»ºè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°
CREATE OR REPLACE FUNCTION update_document_tsvector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.title_tsvector := to_tsvector('english', NEW.title);
    NEW.content_tsvector := to_tsvector('english', NEW.content);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_document_tsvector
BEFORE INSERT OR UPDATE ON documents
FOR EACH ROW
EXECUTE FUNCTION update_document_tsvector();
```

### 3.2 å…¨æ–‡æœç´¢æŸ¥è¯¢

```sql
-- å…¨æ–‡æœç´¢æŸ¥è¯¢
SELECT
    id,
    title,
    ts_rank(title_tsvector, query) AS title_rank,
    ts_rank(content_tsvector, query) AS content_rank
FROM documents,
     to_tsquery('english', 'search & term') AS query
WHERE title_tsvector @@ query
   OR content_tsvector @@ query
ORDER BY title_rank + content_rank DESC
LIMIT 10;
```

---

## 4. æ··åˆæœç´¢å®ç°

### 4.1 åŸºç¡€æ··åˆæœç´¢

```sql
-- æ··åˆæœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION hybrid_search(
    query_text TEXT,
    query_embedding vector(1536),
    vector_weight FLOAT DEFAULT 0.7,
    text_weight FLOAT DEFAULT 0.3,
    result_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
    id INTEGER,
    title TEXT,
    content TEXT,
    vector_score FLOAT,
    text_score FLOAT,
    combined_score FLOAT
)
LANGUAGE plpgsql
AS $$
DECLARE
    query_tsquery tsquery;
BEGIN
    -- æ„å»ºå…¨æ–‡æœç´¢æŸ¥è¯¢
    query_tsquery := to_tsquery('english', query_text);

    RETURN QUERY
    SELECT
        d.id,
        d.title,
        d.content,
        -- å‘é‡ç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆå½’ä¸€åŒ–åˆ° 0-1ï¼‰
        (1 - (d.embedding <=> query_embedding))::FLOAT AS vector_score,
        -- å…¨æ–‡æœç´¢åˆ†æ•°ï¼ˆå½’ä¸€åŒ–ï¼‰
        (
            COALESCE(ts_rank(d.title_tsvector, query_tsquery), 0) * 0.3 +
            COALESCE(ts_rank(d.content_tsvector, query_tsquery), 0) * 0.7
        )::FLOAT AS text_score,
        -- æ··åˆåˆ†æ•°
        (
            (1 - (d.embedding <=> query_embedding))::FLOAT * vector_weight +
            (
                COALESCE(ts_rank(d.title_tsvector, query_tsquery), 0) * 0.3 +
                COALESCE(ts_rank(d.content_tsvector, query_tsquery), 0) * 0.7
            )::FLOAT * text_weight
        )::FLOAT AS combined_score
    FROM documents d
    WHERE d.embedding IS NOT NULL
      AND (
          d.title_tsvector @@ query_tsquery
          OR d.content_tsvector @@ query_tsquery
          OR d.embedding <=> query_embedding < 0.5  -- å‘é‡ç›¸ä¼¼åº¦é˜ˆå€¼
      )
    ORDER BY combined_score DESC
    LIMIT result_limit;
END;
$$;
```

### 4.2 ä½¿ç”¨æ··åˆæœç´¢

```sql
-- è°ƒç”¨æ··åˆæœç´¢
SELECT * FROM hybrid_search(
    'machine learning',
    '[0.1, 0.2, ...]'::vector(1536),  -- æŸ¥è¯¢å‘é‡
    0.7,  -- å‘é‡æƒé‡
    0.3,  -- æ–‡æœ¬æƒé‡
    10    -- ç»“æœæ•°é‡
);
```

---

## 5. æ’åºç­–ç•¥

### 5.1 åŠ æƒæ··åˆæ’åº

```sql
-- å¯é…ç½®æƒé‡çš„æ··åˆæœç´¢
CREATE OR REPLACE FUNCTION weighted_hybrid_search(
    query_text TEXT,
    query_embedding vector(1536),
    vector_weight FLOAT DEFAULT 0.6,
    title_weight FLOAT DEFAULT 0.2,
    content_weight FLOAT DEFAULT 0.2,
    result_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
    id INTEGER,
    title TEXT,
    combined_score FLOAT
)
LANGUAGE sql
AS $$
    WITH vector_results AS (
        SELECT
            id,
            title,
            (1 - (embedding <=> query_embedding))::FLOAT AS vector_score
        FROM documents
        WHERE embedding IS NOT NULL
        ORDER BY embedding <=> query_embedding
        LIMIT result_limit * 2
    ),
    text_results AS (
        SELECT
            id,
            title,
            (
                COALESCE(ts_rank(title_tsvector, to_tsquery('english', query_text)), 0) * 0.4 +
                COALESCE(ts_rank(content_tsvector, to_tsquery('english', query_text)), 0) * 0.6
            )::FLOAT AS text_score
        FROM documents,
             to_tsquery('english', query_text) AS query
        WHERE title_tsvector @@ query
           OR content_tsvector @@ query
        ORDER BY text_score DESC
        LIMIT result_limit * 2
    )
    SELECT
        COALESCE(v.id, t.id) AS id,
        COALESCE(v.title, t.title) AS title,
        (
            COALESCE(v.vector_score, 0) * vector_weight +
            COALESCE(t.text_score, 0) * (title_weight + content_weight)
        )::FLOAT AS combined_score
    FROM vector_results v
    FULL OUTER JOIN text_results t ON v.id = t.id
    ORDER BY combined_score DESC
    LIMIT result_limit;
$$;
```

### 5.2 é‡æ’åºç­–ç•¥

```sql
-- ä¸¤é˜¶æ®µæœç´¢ï¼šå…ˆç²—æ’ï¼Œå†ç²¾æ’
CREATE OR REPLACE FUNCTION two_stage_hybrid_search(
    query_text TEXT,
    query_embedding vector(1536),
    initial_limit INTEGER DEFAULT 100,
    final_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
    id INTEGER,
    title TEXT,
    final_score FLOAT
)
LANGUAGE sql
AS $$
    WITH initial_results AS (
        -- ç¬¬ä¸€é˜¶æ®µï¼šå‘é‡æœç´¢ + å…¨æ–‡æœç´¢çš„å¹¶é›†
        SELECT DISTINCT d.id, d.title
        FROM documents d
        LEFT JOIN LATERAL (
            SELECT 1 - (d.embedding <=> query_embedding) AS score
        ) AS v ON d.embedding IS NOT NULL
        LEFT JOIN LATERAL (
            SELECT GREATEST(
                COALESCE(ts_rank(d.title_tsvector, to_tsquery('english', query_text)), 0),
                COALESCE(ts_rank(d.content_tsvector, to_tsquery('english', query_text)), 0)
            ) AS score
        ) AS t ON true
        WHERE v.score > 0.3 OR t.score > 0.1
        ORDER BY COALESCE(v.score, 0) + COALESCE(t.score, 0) DESC
        LIMIT initial_limit
    )
    -- ç¬¬äºŒé˜¶æ®µï¼šç²¾ç¡®è®¡ç®—æ··åˆåˆ†æ•°
    SELECT
        ir.id,
        ir.title,
        (
            (1 - (d.embedding <=> query_embedding))::FLOAT * 0.7 +
            (
                COALESCE(ts_rank(d.title_tsvector, to_tsquery('english', query_text)), 0) * 0.2 +
                COALESCE(ts_rank(d.content_tsvector, to_tsquery('english', query_text)), 0) * 0.1
            )::FLOAT
        )::FLOAT AS final_score
    FROM initial_results ir
    JOIN documents d ON ir.id = d.id
    ORDER BY final_score DESC
    LIMIT final_limit;
$$;
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- å‘é‡ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_documents_embedding_hnsw
ON documents USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);

-- å…¨æ–‡æœç´¢ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_documents_title_content_fts
ON documents USING GIN (
    to_tsvector('english', title || ' ' || content)
);

-- å¤åˆç´¢å¼•ï¼ˆå¦‚æœç»å¸¸ä¸€èµ·æŸ¥è¯¢ï¼‰
CREATE INDEX idx_documents_id_embedding
ON documents (id)
INCLUDE (embedding);
```

### 6.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨é˜ˆå€¼è¿‡æ»¤
SELECT * FROM documents
WHERE embedding <=> $1::vector < 0.3  -- ç›¸ä¼¼åº¦é˜ˆå€¼
  AND (
      title_tsvector @@ to_tsquery('english', $2)
      OR content_tsvector @@ to_tsquery('english', $2)
  )
ORDER BY
    (1 - (embedding <=> $1::vector)) * 0.7 +
    ts_rank(title_tsvector, to_tsquery('english', $2)) * 0.3 DESC
LIMIT 10;
```

### 6.3 ç¼“å­˜ç­–ç•¥

```sql
-- ç¼“å­˜æŸ¥è¯¢å‘é‡ï¼ˆåº”ç”¨å±‚ï¼‰
-- å¯¹äºç›¸åŒçš„æŸ¥è¯¢æ–‡æœ¬ï¼Œå¯ä»¥ç¼“å­˜ç”Ÿæˆçš„å‘é‡

-- ç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ç»“æœ
CREATE MATERIALIZED VIEW popular_search_results AS
SELECT
    query_text,
    query_embedding,
    result_ids,
    created_at
FROM ...;

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY popular_search_results;
```

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šç”µå•†å•†å“æœç´¢

```sql
-- åœºæ™¯ï¼šç”µå•†å•†å“æœç´¢
-- è¦æ±‚ï¼šæ”¯æŒå•†å“åç§°å…³é”®è¯æœç´¢ + å•†å“æè¿°è¯­ä¹‰æœç´¢

-- åˆ›å»ºå•†å“è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    embedding vector(1536),
    name_tsvector tsvector,
    description_tsvector tsvector,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_products_embedding_hnsw
ON products USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_products_name_fts
ON products USING GIN (name_tsvector);

CREATE INDEX idx_products_description_fts
ON products USING GIN (description_tsvector);

-- åˆ›å»ºæ··åˆæœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_products(
    query_text TEXT,
    query_embedding vector(1536),
    category_filter TEXT DEFAULT NULL
)
RETURNS TABLE (
    id INTEGER,
    name TEXT,
    description TEXT,
    score FLOAT
)
LANGUAGE sql
AS $$
    SELECT
        p.id,
        p.name,
        p.description,
        (
            -- å‘é‡ç›¸ä¼¼åº¦ï¼ˆå•†å“æè¿°è¯­ä¹‰ï¼‰
            (1 - (p.embedding <=> query_embedding))::FLOAT * 0.5 +
            -- å•†å“åç§°å…³é”®è¯åŒ¹é…
            COALESCE(ts_rank(p.name_tsvector, to_tsquery('english', query_text)), 0) * 0.4 +
            -- å•†å“æè¿°å…³é”®è¯åŒ¹é…
            COALESCE(ts_rank(p.description_tsvector, to_tsquery('english', query_text)), 0) * 0.1
        )::FLOAT AS score
    FROM products p
    WHERE p.embedding IS NOT NULL
      AND (category_filter IS NULL OR p.category = category_filter)
      AND (
          p.name_tsvector @@ to_tsquery('english', query_text)
          OR p.description_tsvector @@ to_tsquery('english', query_text)
          OR p.embedding <=> query_embedding < 0.5
      )
    ORDER BY score DESC
    LIMIT 20;
$$;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM search_products(
    'wireless headphones',
    '[0.1, 0.2, ...]'::vector(1536),
    'electronics'
);

-- æ€§èƒ½ç»“æœï¼š
-- - æœç´¢æ—¶é—´ï¼š< 200ms
-- - å‡†ç¡®ç‡ï¼šæå‡ 30%ï¼ˆç›¸æ¯”å•ä¸€æœç´¢ï¼‰
```

### 7.2 æ¡ˆä¾‹ï¼šçŸ¥è¯†åº“æœç´¢

```sql
-- åœºæ™¯ï¼šä¼ä¸šçŸ¥è¯†åº“æœç´¢
-- è¦æ±‚ï¼šæ”¯æŒæ–‡æ¡£æ ‡é¢˜å…³é”®è¯ + æ–‡æ¡£å†…å®¹è¯­ä¹‰æœç´¢

-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    tags TEXT[],
    embedding vector(1536),
    title_tsvector tsvector,
    content_tsvector tsvector,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ··åˆæœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_knowledge_base(
    query_text TEXT,
    query_embedding vector(1536),
    tag_filter TEXT[] DEFAULT NULL
)
RETURNS TABLE (
    id INTEGER,
    title TEXT,
    content_preview TEXT,
    relevance_score FLOAT
)
LANGUAGE sql
AS $$
    SELECT
        kb.id,
        kb.title,
        LEFT(kb.content, 200) AS content_preview,
        (
            -- è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆç†è§£æŸ¥è¯¢æ„å›¾ï¼‰
            (1 - (kb.embedding <=> query_embedding))::FLOAT * 0.6 +
            -- æ ‡é¢˜å…³é”®è¯åŒ¹é…ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
            COALESCE(ts_rank(kb.title_tsvector, to_tsquery('english', query_text)), 0) * 0.3 +
            -- å†…å®¹å…³é”®è¯åŒ¹é…
            COALESCE(ts_rank(kb.content_tsvector, to_tsquery('english', query_text)), 0) * 0.1
        )::FLOAT AS relevance_score
    FROM knowledge_base kb
    WHERE kb.embedding IS NOT NULL
      AND (tag_filter IS NULL OR kb.tags && tag_filter)
      AND (
          kb.title_tsvector @@ to_tsquery('english', query_text)
          OR kb.content_tsvector @@ to_tsquery('english', query_text)
          OR kb.embedding <=> query_embedding < 0.4
      )
    ORDER BY relevance_score DESC
    LIMIT 15;
$$;
```

---

## ğŸ“Š æ€»ç»“

æ··åˆæœç´¢ç»“åˆäº†å‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢çš„ä¼˜åŠ¿ï¼Œèƒ½å¤Ÿæä¾›æ›´å‡†ç¡®å’Œå…¨é¢çš„æœç´¢ç»“æœã€‚é€šè¿‡åˆç†é…ç½®æƒé‡ã€ä¼˜åŒ–ç´¢å¼•å’ŒæŸ¥è¯¢ç­–ç•¥ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°é«˜æ€§èƒ½çš„æ··åˆæœç´¢ã€‚å»ºè®®æ ¹æ®å…·ä½“åœºæ™¯è°ƒæ•´å‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢çš„æƒé‡ï¼Œå¹¶æŒç»­ä¼˜åŒ–æœç´¢æ•ˆæœã€‚

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [pgvector å®˜æ–¹æ–‡æ¡£](https://github.com/pgvector/pgvector) - å‘é‡æœç´¢æ‰©å±•
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç´¢å¼•](https://www.postgresql.org/docs/current/indexes.html)
- [Supabase RRF ç®—æ³•æ–‡æ¡£](https://supabase.com/docs/guides/ai/hybrid-search) - RRF èåˆç®—æ³•

### æŠ€æœ¯è®ºæ–‡

- [Reciprocal Rank Fusion for Multiple Query Results](https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf) - RRF ç®—æ³•åŸå§‹è®ºæ–‡
- [Learning to Rank for Information Retrieval](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - ä¿¡æ¯æ£€ç´¢æ’åºå­¦ä¹ ç ”ç©¶
- [Hybrid Search: Combining Vector and Keyword Search](https://arxiv.org/abs/2304.01073) - æ··åˆæœç´¢ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [Supabase - Hybrid Search](https://supabase.com/blog/hybrid-search) - Supabase æ··åˆæœç´¢å®ç°
- [Neon - Vector and Full-Text Search](https://neon.tech/blog/vector-full-text-search) - å‘é‡å’Œå…¨æ–‡æœç´¢
- [Understanding Hybrid Search](https://www.postgresql.org/docs/current/textsearch.html) - æ··åˆæœç´¢è¯¦è§£

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Full Text Search](https://wiki.postgresql.org/wiki/Full_Text_Search) - PostgreSQL å…¨æ–‡æœç´¢ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - Hybrid Search](https://stackoverflow.com/questions/tagged/hybrid-search+postgresql) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-TREND-03
