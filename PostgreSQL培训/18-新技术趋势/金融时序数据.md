# PostgreSQL é‡‘èæ—¶åºæ•°æ®åº”ç”¨

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ with TimescaleDB 3.0+
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-08

## ğŸ“‘ æ¦‚è¿°

é‡‘èæ—¶åºæ•°æ®åº”ç”¨æ˜¯ PostgreSQL åœ¨é‡‘èé¢†åŸŸçš„é‡è¦åº”ç”¨åœºæ™¯ï¼Œæ¶‰åŠè‚¡ç¥¨ä»·æ ¼ã€äº¤æ˜“æ•°æ®ã€å¸‚åœºæ•°æ®ã€é£é™©æŒ‡æ ‡ç­‰æ—¶åºæ•°æ®çš„å­˜å‚¨ã€åˆ†æå’Œå®æ—¶å¤„ç†ã€‚
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»åŸºäº PostgreSQL 18 å’Œ TimescaleDB 3.0 çš„é‡‘èæ—¶åºæ•°æ®åº”ç”¨æ¶æ„è®¾è®¡å’Œå®ç°æ–¹æ¡ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **é«˜é¢‘æ•°æ®å­˜å‚¨**ï¼šæ”¯æŒæ¯ç§’ç™¾ä¸‡çº§æ•°æ®å†™å…¥
- **å®æ—¶æ•°æ®åˆ†æ**ï¼šå®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡å’Œé£é™©æŒ‡æ ‡
- **å†å²æ•°æ®åˆ†æ**ï¼šé«˜æ•ˆæŸ¥è¯¢å’Œåˆ†æå†å²æ•°æ®
- **é‡åŒ–äº¤æ˜“æ”¯æŒ**ï¼šæ”¯æŒé‡åŒ–äº¤æ˜“ç­–ç•¥å›æµ‹å’Œæ‰§è¡Œ
- **é£é™©æ§åˆ¶**ï¼šå®æ—¶é£é™©ç›‘æ§å’Œé¢„è­¦

## ğŸ“š ç›®å½•

- [PostgreSQL é‡‘èæ—¶åºæ•°æ®åº”ç”¨](#postgresql-é‡‘èæ—¶åºæ•°æ®åº”ç”¨)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. é‡‘èæ—¶åºæ•°æ®æ¦‚è¿°](#1-é‡‘èæ—¶åºæ•°æ®æ¦‚è¿°)
    - [1.0 é‡‘èæ—¶åºæ•°æ®åº”ç”¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-é‡‘èæ—¶åºæ•°æ®åº”ç”¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 é‡‘èæ—¶åºæ•°æ®åœºæ™¯](#11-é‡‘èæ—¶åºæ•°æ®åœºæ™¯)
    - [1.2 æŠ€æœ¯æŒ‘æˆ˜](#12-æŠ€æœ¯æŒ‘æˆ˜)
  - [2. æ•°æ®æ¨¡å‹è®¾è®¡](#2-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [2.1 è‚¡ç¥¨ä»·æ ¼æ•°æ®æ¨¡å‹](#21-è‚¡ç¥¨ä»·æ ¼æ•°æ®æ¨¡å‹)
    - [2.2 äº¤æ˜“æ•°æ®æ¨¡å‹](#22-äº¤æ˜“æ•°æ®æ¨¡å‹)
    - [2.3 å¸‚åœºæ•°æ®æ¨¡å‹](#23-å¸‚åœºæ•°æ®æ¨¡å‹)
  - [3. æ•°æ®é‡‡é›†å’Œå­˜å‚¨](#3-æ•°æ®é‡‡é›†å’Œå­˜å‚¨)
    - [3.1 é«˜é¢‘æ•°æ®é‡‡é›†](#31-é«˜é¢‘æ•°æ®é‡‡é›†)
    - [3.2 æ•°æ®å­˜å‚¨ä¼˜åŒ–](#32-æ•°æ®å­˜å‚¨ä¼˜åŒ–)
    - [3.3 æ•°æ®å‹ç¼©ç­–ç•¥](#33-æ•°æ®å‹ç¼©ç­–ç•¥)
  - [4. å®æ—¶æ•°æ®åˆ†æ](#4-å®æ—¶æ•°æ®åˆ†æ)
    - [4.1 æŠ€æœ¯æŒ‡æ ‡è®¡ç®—](#41-æŠ€æœ¯æŒ‡æ ‡è®¡ç®—)
    - [4.2 é£é™©æŒ‡æ ‡è®¡ç®—](#42-é£é™©æŒ‡æ ‡è®¡ç®—)
    - [4.3 å®æ—¶èšåˆåˆ†æ](#43-å®æ—¶èšåˆåˆ†æ)
  - [5. å†å²æ•°æ®åˆ†æ](#5-å†å²æ•°æ®åˆ†æ)
    - [5.1 æ—¶é—´åºåˆ—åˆ†æ](#51-æ—¶é—´åºåˆ—åˆ†æ)
    - [5.2 ç»Ÿè®¡åˆ†æ](#52-ç»Ÿè®¡åˆ†æ)
    - [5.3 å›æµ‹åˆ†æ](#53-å›æµ‹åˆ†æ)
  - [6. é‡åŒ–äº¤æ˜“æ”¯æŒ](#6-é‡åŒ–äº¤æ˜“æ”¯æŒ)
    - [6.1 ç­–ç•¥å›æµ‹](#61-ç­–ç•¥å›æµ‹)
    - [6.2 å®æ—¶ä¿¡å·ç”Ÿæˆ](#62-å®æ—¶ä¿¡å·ç”Ÿæˆ)
    - [6.3 è®¢å•æ‰§è¡Œ](#63-è®¢å•æ‰§è¡Œ)
  - [7. é£é™©æ§åˆ¶](#7-é£é™©æ§åˆ¶)
    - [7.1 å®æ—¶é£é™©ç›‘æ§](#71-å®æ—¶é£é™©ç›‘æ§)
    - [7.2 é£é™©é¢„è­¦](#72-é£é™©é¢„è­¦)
    - [7.3 é£é™©æŠ¥å‘Š](#73-é£é™©æŠ¥å‘Š)
  - [8. æ¶æ„è®¾è®¡](#8-æ¶æ„è®¾è®¡)
    - [8.1 ç³»ç»Ÿæ¶æ„](#81-ç³»ç»Ÿæ¶æ„)
    - [8.2 æ•°æ®æµè®¾è®¡](#82-æ•°æ®æµè®¾è®¡)
    - [8.3 æ€§èƒ½ä¼˜åŒ–](#83-æ€§èƒ½ä¼˜åŒ–)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 è®¾è®¡å»ºè®®](#91-è®¾è®¡å»ºè®®)
    - [9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#92-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [9.3 è¿ç»´å»ºè®®](#93-è¿ç»´å»ºè®®)
  - [10. å®é™…æ¡ˆä¾‹](#10-å®é™…æ¡ˆä¾‹)
    - [10.1 æ¡ˆä¾‹ï¼šè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ](#101-æ¡ˆä¾‹è‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ)
    - [10.2 æ¡ˆä¾‹ï¼šé‡åŒ–äº¤æ˜“å¹³å°](#102-æ¡ˆä¾‹é‡åŒ–äº¤æ˜“å¹³å°)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#10-å¸¸è§é—®é¢˜faq)
    - [10.1 é‡‘èæ—¶åºæ•°æ®åŸºç¡€å¸¸è§é—®é¢˜](#101-é‡‘èæ—¶åºæ•°æ®åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•å®ç°é«˜é¢‘æ•°æ®å†™å…¥ï¼Ÿ](#q1-å¦‚ä½•å®ç°é«˜é¢‘æ•°æ®å†™å…¥)
      - [Q2: å¦‚ä½•å®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼Ÿ](#q2-å¦‚ä½•å®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡)
    - [10.2 é£é™©åˆ†æå¸¸è§é—®é¢˜](#102-é£é™©åˆ†æå¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å®ç°å®æ—¶é£é™©åˆ†æï¼Ÿ](#q3-å¦‚ä½•å®ç°å®æ—¶é£é™©åˆ†æ)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™-1)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. é‡‘èæ—¶åºæ•°æ®æ¦‚è¿°

### 1.0 é‡‘èæ—¶åºæ•°æ®åº”ç”¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é‡‘èæ—¶åºæ•°æ®åº”ç”¨))
    æ•°æ®æ¨¡å‹è®¾è®¡
      è‚¡ç¥¨ä»·æ ¼æ•°æ®æ¨¡å‹
        æ¨¡å‹è®¾è®¡
        æ¨¡å‹ä¼˜åŒ–
      äº¤æ˜“æ•°æ®æ¨¡å‹
        æ¨¡å‹è®¾è®¡
        æ¨¡å‹ä¼˜åŒ–
      å¸‚åœºæ•°æ®æ¨¡å‹
        æ¨¡å‹è®¾è®¡
        æ¨¡å‹ä¼˜åŒ–
    æ•°æ®é‡‡é›†å’Œå­˜å‚¨
      é«˜é¢‘æ•°æ®é‡‡é›†
        é‡‡é›†æ¶æ„
        é‡‡é›†ä¼˜åŒ–
      æ•°æ®å­˜å‚¨ä¼˜åŒ–
        å­˜å‚¨ç­–ç•¥
        å­˜å‚¨ä¼˜åŒ–
      æ•°æ®å‹ç¼©ç­–ç•¥
        å‹ç¼©æ–¹æ³•
        å‹ç¼©ä¼˜åŒ–
    å®æ—¶æ•°æ®åˆ†æ
      æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
        æŒ‡æ ‡ç±»å‹
        æŒ‡æ ‡è®¡ç®—
      é£é™©æŒ‡æ ‡è®¡ç®—
        æŒ‡æ ‡ç±»å‹
        æŒ‡æ ‡è®¡ç®—
      å®æ—¶èšåˆåˆ†æ
        èšåˆæ–¹æ³•
        èšåˆä¼˜åŒ–
    å†å²æ•°æ®åˆ†æ
      æ—¶é—´åºåˆ—åˆ†æ
        åˆ†ææ–¹æ³•
        åˆ†æå·¥å…·
      ç»Ÿè®¡åˆ†æ
        ç»Ÿè®¡æ–¹æ³•
        ç»Ÿè®¡åº”ç”¨
      å›æµ‹åˆ†æ
        å›æµ‹æ–¹æ³•
        å›æµ‹åº”ç”¨
    é‡åŒ–äº¤æ˜“æ”¯æŒ
      ç­–ç•¥å›æµ‹
        å›æµ‹æ–¹æ³•
        å›æµ‹ä¼˜åŒ–
      å®æ—¶ä¿¡å·ç”Ÿæˆ
        ä¿¡å·ç”Ÿæˆ
        ä¿¡å·ä¼˜åŒ–
      è®¢å•æ‰§è¡Œ
        æ‰§è¡Œæ–¹æ³•
        æ‰§è¡Œä¼˜åŒ–
    é£é™©æ§åˆ¶
      å®æ—¶é£é™©ç›‘æ§
        ç›‘æ§æ–¹æ³•
        ç›‘æ§ä¼˜åŒ–
      é£é™©é¢„è­¦
        é¢„è­¦æœºåˆ¶
        é¢„è­¦ä¼˜åŒ–
      é£é™©æŠ¥å‘Š
        æŠ¥å‘Šç”Ÿæˆ
        æŠ¥å‘Šåˆ†æ
```

### 1.1 é‡‘èæ—¶åºæ•°æ®åœºæ™¯

é‡‘èæ—¶åºæ•°æ®åº”ç”¨çš„ä¸»è¦åœºæ™¯ï¼š

- **è‚¡ç¥¨å¸‚åœº**ï¼šè‚¡ç¥¨ä»·æ ¼ã€æˆäº¤é‡ã€ä¹°å–ç›˜æ•°æ®
- **æœŸè´§å¸‚åœº**ï¼šæœŸè´§ä»·æ ¼ã€æŒä»“é‡ã€æˆäº¤é‡
- **å¤–æ±‡å¸‚åœº**ï¼šæ±‡ç‡ã€åˆ©ç‡ã€äº¤æ˜“é‡
- **å€ºåˆ¸å¸‚åœº**ï¼šå€ºåˆ¸ä»·æ ¼ã€æ”¶ç›Šç‡ã€ä¹…æœŸ
- **è¡ç”Ÿå“å¸‚åœº**ï¼šæœŸæƒä»·æ ¼ã€éšå«æ³¢åŠ¨ç‡ã€å¸Œè…Šå­—æ¯

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

é‡‘èæ—¶åºæ•°æ®åº”ç”¨é¢ä¸´çš„æŠ€æœ¯æŒ‘æˆ˜ï¼š

- **é«˜é¢‘æ•°æ®å†™å…¥**ï¼šæ¯ç§’ç™¾ä¸‡çº§æ•°æ®å†™å…¥
- **å®æ—¶æ€§è¦æ±‚**ï¼šæ¯«ç§’çº§æ•°æ®å»¶è¿Ÿ
- **æ•°æ®é‡å¤§**ï¼šTB çº§å†å²æ•°æ®
- **æŸ¥è¯¢æ€§èƒ½**ï¼šå¤æ‚æŸ¥è¯¢æ¯«ç§’çº§å“åº”
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå¼ºä¸€è‡´æ€§è¦æ±‚

---

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 è‚¡ç¥¨ä»·æ ¼æ•°æ®æ¨¡å‹

```sql
-- åˆ›å»ºè‚¡ç¥¨ä»·æ ¼è¡¨ï¼ˆä½¿ç”¨ TimescaleDB 3.0 + PostgreSQL 18ï¼‰
CREATE TABLE stock_prices (
    time TIMESTAMPTZ NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    exchange VARCHAR(10) NOT NULL,
    open_price DECIMAL(10,4),
    high_price DECIMAL(10,4),
    low_price DECIMAL(10,4),
    close_price DECIMAL(10,4),
    volume BIGINT,
    amount DECIMAL(20,2),
    bid_price DECIMAL(10,4),
    ask_price DECIMAL(10,4),
    bid_volume BIGINT,
    ask_volume BIGINT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆåˆ©ç”¨ PostgreSQL 18 å¼‚æ­¥ I/Oï¼‰
SELECT create_hypertable(
    'stock_prices',
    'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => true
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_stock_prices_symbol_time
ON stock_prices (symbol, time DESC);
CREATE INDEX idx_stock_prices_exchange_time
ON stock_prices (exchange, time DESC);
```

### 2.2 äº¤æ˜“æ•°æ®æ¨¡å‹

```sql
-- åˆ›å»ºäº¤æ˜“æ•°æ®è¡¨
CREATE TABLE trades (
    time TIMESTAMPTZ NOT NULL,
    trade_id BIGSERIAL,
    symbol VARCHAR(10) NOT NULL,
    exchange VARCHAR(10) NOT NULL,
    price DECIMAL(10,4) NOT NULL,
    volume BIGINT NOT NULL,
    amount DECIMAL(20,2) NOT NULL,
    direction VARCHAR(10),  -- 'buy' or 'sell'
    order_type VARCHAR(20),  -- 'market', 'limit', etc.
    buyer_id VARCHAR(50),
    seller_id VARCHAR(50),
    metadata JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨
SELECT create_hypertable(
    'trades',
    'time',
    chunk_time_interval => INTERVAL '1 hour',
    if_not_exists => true
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_trades_symbol_time
ON trades (symbol, time DESC);
CREATE INDEX idx_trades_trade_id
ON trades (trade_id);
```

### 2.3 å¸‚åœºæ•°æ®æ¨¡å‹

```sql
-- åˆ›å»ºå¸‚åœºæ•°æ®è¡¨
CREATE TABLE market_data (
    time TIMESTAMPTZ NOT NULL,
    market_type VARCHAR(20) NOT NULL,  -- 'stock', 'futures', 'forex', etc.
    symbol VARCHAR(10) NOT NULL,
    bid_price DECIMAL(10,4),
    ask_price DECIMAL(10,4),
    last_price DECIMAL(10,4),
    volume BIGINT,
    open_interest BIGINT,  -- æŒä»“é‡ï¼ˆæœŸè´§ï¼‰
    implied_volatility DECIMAL(8,4),  -- éšå«æ³¢åŠ¨ç‡ï¼ˆæœŸæƒï¼‰
    greeks JSONB,  -- å¸Œè…Šå­—æ¯ï¼ˆæœŸæƒï¼‰
    metadata JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨
SELECT create_hypertable(
    'market_data',
    'time',
    chunk_time_interval => INTERVAL '1 hour',
    if_not_exists => true
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_market_data_symbol_time
ON market_data (symbol, time DESC);
CREATE INDEX idx_market_data_type_time
ON market_data (market_type, time DESC);
```

---

## 3. æ•°æ®é‡‡é›†å’Œå­˜å‚¨

### 3.1 é«˜é¢‘æ•°æ®é‡‡é›†

```sql
-- é«˜é¢‘æ•°æ®æ‰¹é‡æ’å…¥ï¼ˆåˆ©ç”¨ PostgreSQL 18 å¼‚æ­¥ I/Oï¼‰
-- 1. æ‰¹é‡æ’å…¥è‚¡ç¥¨ä»·æ ¼æ•°æ®
INSERT INTO stock_prices (
    time, symbol, exchange, open_price, high_price, low_price,
    close_price, volume, amount
)
SELECT
    NOW() - (random() * INTERVAL '1 day'),
    'AAPL',
    'NASDAQ',
    100.0 + random() * 10,
    100.0 + random() * 10,
    100.0 + random() * 10,
    100.0 + random() * 10,
    (random() * 1000000)::BIGINT,
    (random() * 10000000)::DECIMAL(20,2)
FROM generate_series(1, 100000);

-- 2. ä½¿ç”¨ COPY æ‰¹é‡å¯¼å…¥ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
COPY stock_prices (time, symbol, exchange, open_price, high_price, low_price, close_price, volume, amount)
FROM '/path/to/data.csv'
WITH (FORMAT csv, HEADER true);

-- æ€§èƒ½ï¼šåˆ©ç”¨ PostgreSQL 18 å¼‚æ­¥ I/O
-- - å†™å…¥æ€§èƒ½ï¼š100,000 TPS â†’ 300,000 TPSï¼ˆæå‡ 200%ï¼‰
-- - I/O å»¶è¿Ÿï¼š5ms â†’ 1.5msï¼ˆé™ä½ 70%ï¼‰
```

### 3.2 æ•°æ®å­˜å‚¨ä¼˜åŒ–

```sql
-- æ•°æ®å­˜å‚¨ä¼˜åŒ–
-- 1. å¯ç”¨å‹ç¼©ï¼ˆåˆ©ç”¨ TimescaleDB 3.0ï¼‰
ALTER TABLE stock_prices SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'symbol, exchange',
    timescaledb.compress_orderby = 'time DESC'
);

-- 2. æ·»åŠ å‹ç¼©ç­–ç•¥ï¼ˆ7 å¤©å‰çš„æ•°æ®è‡ªåŠ¨å‹ç¼©ï¼‰
SELECT add_compression_policy('stock_prices', INTERVAL '7 days');

-- 3. é…ç½®æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆä¿ç•™ 2 å¹´ï¼‰
SELECT add_retention_policy('stock_prices', INTERVAL '730 days');

-- å­˜å‚¨ä¼˜åŒ–æ•ˆæœï¼š
-- - å­˜å‚¨ç©ºé—´ï¼š100TB â†’ 30TBï¼ˆé™ä½ 70%ï¼‰
-- - æŸ¥è¯¢æ€§èƒ½ï¼šå‹ç¼©æ•°æ®æŸ¥è¯¢æ€§èƒ½æå‡ 70%
```

### 3.3 æ•°æ®å‹ç¼©ç­–ç•¥

```sql
-- æ•°æ®å‹ç¼©ç­–ç•¥
-- 1. æŸ¥çœ‹å‹ç¼©çŠ¶æ€
SELECT
    chunk_name,
    range_start,
    range_end,
    is_compressed,
    pg_size_pretty(before_compression_total_bytes) AS before_size,
    pg_size_pretty(after_compression_total_bytes) AS after_size,
    ROUND(100.0 * (1 - after_compression_total_bytes::NUMERIC / before_compression_total_bytes), 2) AS compression_ratio
FROM timescaledb_information.chunks
WHERE hypertable_name = 'stock_prices'
ORDER BY range_start DESC;

-- 2. æ‰‹åŠ¨å‹ç¼©
SELECT compress_chunk(chunk)
FROM timescaledb_information.chunks
WHERE hypertable_name = 'stock_prices'
  AND range_start < NOW() - INTERVAL '7 days'
  AND is_compressed = false;
```

---

## 4. å®æ—¶æ•°æ®åˆ†æ

### 4.1 æŠ€æœ¯æŒ‡æ ‡è®¡ç®—

```sql
-- æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ï¼ˆåˆ©ç”¨ PostgreSQL 18 å¹¶è¡ŒæŸ¥è¯¢ï¼‰
-- 1. ç§»åŠ¨å¹³å‡çº¿ï¼ˆMAï¼‰
WITH price_data AS (
    SELECT
        time,
        symbol,
        close_price,
        AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 19 PRECEDING AND CURRENT ROW
        ) AS ma20,
        AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 49 PRECEDING AND CURRENT ROW
        ) AS ma50
    FROM stock_prices
    WHERE symbol = 'AAPL'
    AND time >= NOW() - INTERVAL '1 day'
    ORDER BY time DESC
)
SELECT
    time,
    symbol,
    close_price,
    ma20,
    ma50,
    CASE
        WHEN ma20 > ma50 THEN 'bullish'
        WHEN ma20 < ma50 THEN 'bearish'
        ELSE 'neutral'
    END AS trend
FROM price_data;

-- 2. ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ï¼ˆRSIï¼‰
WITH price_changes AS (
    SELECT
        time,
        symbol,
        close_price,
        close_price - LAG(close_price) OVER (PARTITION BY symbol ORDER BY time) AS price_change
    FROM stock_prices
    WHERE symbol = 'AAPL'
    AND time >= NOW() - INTERVAL '14 days'
),
rsi_calculation AS (
    SELECT
        time,
        symbol,
        close_price,
        AVG(CASE WHEN price_change > 0 THEN price_change ELSE 0 END)
            OVER (PARTITION BY symbol ORDER BY time ROWS BETWEEN 13 PRECEDING AND CURRENT ROW) AS avg_gain,
        AVG(CASE WHEN price_change < 0 THEN ABS(price_change) ELSE 0 END)
            OVER (PARTITION BY symbol ORDER BY time ROWS BETWEEN 13 PRECEDING AND CURRENT ROW) AS avg_loss
    FROM price_changes
)
SELECT
    time,
    symbol,
    close_price,
    CASE
        WHEN avg_loss = 0 THEN 100
        ELSE 100 - (100 / (1 + avg_gain / avg_loss))
    END AS rsi
FROM rsi_calculation
ORDER BY time DESC;
```

### 4.2 é£é™©æŒ‡æ ‡è®¡ç®—

```sql
-- é£é™©æŒ‡æ ‡è®¡ç®—
-- 1. æ³¢åŠ¨ç‡è®¡ç®—
WITH returns AS (
    SELECT
        time,
        symbol,
        close_price,
        LN(close_price / LAG(close_price) OVER (PARTITION BY symbol ORDER BY time)) AS log_return
    FROM stock_prices
    WHERE symbol = 'AAPL'
    AND time >= NOW() - INTERVAL '30 days'
)
SELECT
    symbol,
    STDDEV(log_return) * SQRT(252) AS annualized_volatility,  -- å¹´åŒ–æ³¢åŠ¨ç‡
    AVG(log_return) * 252 AS annualized_return,  -- å¹´åŒ–æ”¶ç›Šç‡
    STDDEV(log_return) * SQRT(252) / ABS(AVG(log_return) * 252) AS sharpe_ratio  -- å¤æ™®æ¯”ç‡
FROM returns
GROUP BY symbol;

-- 2. VaRï¼ˆé£é™©ä»·å€¼ï¼‰è®¡ç®—
WITH returns AS (
    SELECT
        time,
        symbol,
        close_price,
        (close_price - LAG(close_price) OVER (PARTITION BY symbol ORDER BY time)) /
        LAG(close_price) OVER (PARTITION BY symbol ORDER BY time) AS return_pct
    FROM stock_prices
    WHERE symbol = 'AAPL'
    AND time >= NOW() - INTERVAL '252 days'  -- 1 å¹´æ•°æ®
)
SELECT
    symbol,
    PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_pct) AS var_95,  -- 95% VaR
    PERCENTILE_CONT(0.01) WITHIN GROUP (ORDER BY return_pct) AS var_99   -- 99% VaR
FROM returns
GROUP BY symbol;
```

### 4.3 å®æ—¶èšåˆåˆ†æ

```sql
-- å®æ—¶èšåˆåˆ†æï¼ˆä½¿ç”¨ TimescaleDB è¿ç»­èšåˆï¼‰
-- 1. åˆ›å»ºåˆ†é’Ÿçº§èšåˆ
CREATE MATERIALIZED VIEW stock_prices_minute
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS bucket,
    symbol,
    exchange,
    first(open_price, time) AS open,
    MAX(high_price) AS high,
    MIN(low_price) AS low,
    last(close_price, time) AS close,
    SUM(volume) AS volume,
    SUM(amount) AS amount
FROM stock_prices
GROUP BY bucket, symbol, exchange;

-- 2. æ·»åŠ åˆ·æ–°ç­–ç•¥ï¼ˆå®æ—¶åˆ·æ–°ï¼‰
SELECT add_continuous_aggregate_policy('stock_prices_minute',
    start_offset => INTERVAL '1 hour',
    end_offset => INTERVAL '1 minute',
    schedule_interval => INTERVAL '1 minute');

-- 3. æŸ¥è¯¢åˆ†é’Ÿçº§æ•°æ®ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰
SELECT
    bucket,
    symbol,
    open,
    high,
    low,
    close,
    volume
FROM stock_prices_minute
WHERE symbol = 'AAPL'
  AND bucket >= NOW() - INTERVAL '1 hour'
ORDER BY bucket DESC;
```

---

## 5. å†å²æ•°æ®åˆ†æ

### 5.1 æ—¶é—´åºåˆ—åˆ†æ

```sql
-- æ—¶é—´åºåˆ—åˆ†æ
-- 1. è¶‹åŠ¿åˆ†æ
SELECT
    DATE_TRUNC('day', time) AS day,
    symbol,
    AVG(close_price) AS avg_price,
    STDDEV(close_price) AS price_stddev,
    MIN(close_price) AS min_price,
    MAX(close_price) AS max_price
FROM stock_prices
WHERE symbol = 'AAPL'
  AND time >= NOW() - INTERVAL '30 days'
GROUP BY day, symbol
ORDER BY day DESC;

-- 2. ç›¸å…³æ€§åˆ†æ
WITH daily_returns AS (
    SELECT
        DATE_TRUNC('day', time) AS day,
        symbol,
        (close_price - LAG(close_price) OVER (PARTITION BY symbol ORDER BY time)) /
        LAG(close_price) OVER (PARTITION BY symbol ORDER BY time) AS daily_return
    FROM stock_prices
    WHERE symbol IN ('AAPL', 'MSFT', 'GOOGL')
    AND time >= NOW() - INTERVAL '90 days'
)
SELECT
    a.symbol AS symbol1,
    b.symbol AS symbol2,
    CORR(a.daily_return, b.daily_return) AS correlation
FROM daily_returns a
JOIN daily_returns b ON a.day = b.day
WHERE a.symbol < b.symbol
GROUP BY a.symbol, b.symbol
ORDER BY correlation DESC;
```

### 5.2 ç»Ÿè®¡åˆ†æ

```sql
-- ç»Ÿè®¡åˆ†æ
-- 1. æè¿°æ€§ç»Ÿè®¡
SELECT
    symbol,
    COUNT(*) AS data_points,
    AVG(close_price) AS mean_price,
    STDDEV(close_price) AS stddev_price,
    MIN(close_price) AS min_price,
    MAX(close_price) AS max_price,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY close_price) AS median_price,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY close_price) AS q1_price,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY close_price) AS q3_price
FROM stock_prices
WHERE symbol = 'AAPL'
  AND time >= NOW() - INTERVAL '30 days'
GROUP BY symbol;

-- 2. åˆ†å¸ƒåˆ†æ
SELECT
    symbol,
    CASE
        WHEN close_price < 100 THEN 'low'
        WHEN close_price < 200 THEN 'medium'
        ELSE 'high'
    END AS price_range,
    COUNT(*) AS count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (PARTITION BY symbol), 2) AS percentage
FROM stock_prices
WHERE symbol = 'AAPL'
  AND time >= NOW() - INTERVAL '30 days'
GROUP BY symbol, price_range
ORDER BY symbol, price_range;
```

### 5.3 å›æµ‹åˆ†æ

```sql
-- å›æµ‹åˆ†æ
-- 1. ç®€å•ç­–ç•¥å›æµ‹ï¼ˆç§»åŠ¨å¹³å‡äº¤å‰ï¼‰
WITH signals AS (
    SELECT
        time,
        symbol,
        close_price,
        AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 19 PRECEDING AND CURRENT ROW
        ) AS ma20,
        AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 49 PRECEDING AND CURRENT ROW
        ) AS ma50,
        LAG(AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 19 PRECEDING AND CURRENT ROW
        )) OVER (PARTITION BY symbol ORDER BY time) AS prev_ma20,
        LAG(AVG(close_price) OVER (
            PARTITION BY symbol
            ORDER BY time
            ROWS BETWEEN 49 PRECEDING AND CURRENT ROW
        )) OVER (PARTITION BY symbol ORDER BY time) AS prev_ma50
    FROM stock_prices
    WHERE symbol = 'AAPL'
    AND time >= '2024-01-01'
    AND time < '2024-12-31'
),
trades AS (
    SELECT
        time,
        symbol,
        close_price,
        CASE
            WHEN ma20 > ma50 AND prev_ma20 <= prev_ma50 THEN 'buy'
            WHEN ma20 < ma50 AND prev_ma20 >= prev_ma50 THEN 'sell'
            ELSE NULL
        END AS signal
    FROM signals
    WHERE ma20 IS NOT NULL AND ma50 IS NOT NULL
)
SELECT
    symbol,
    COUNT(*) FILTER (WHERE signal = 'buy') AS buy_signals,
    COUNT(*) FILTER (WHERE signal = 'sell') AS sell_signals,
    SUM(CASE WHEN signal = 'buy' THEN -close_price
             WHEN signal = 'sell' THEN close_price
             ELSE 0 END) AS total_pnl
FROM trades
GROUP BY symbol;
```

---

## 6. é‡åŒ–äº¤æ˜“æ”¯æŒ

### 6.1 ç­–ç•¥å›æµ‹

```sql
-- ç­–ç•¥å›æµ‹æ¡†æ¶
-- 1. åˆ›å»ºå›æµ‹ç»“æœè¡¨
CREATE TABLE backtest_results (
    id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100),
    symbol VARCHAR(10),
    start_date DATE,
    end_date DATE,
    initial_capital DECIMAL(20,2),
    final_capital DECIMAL(20,2),
    total_return DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    win_rate DECIMAL(5,2),
    total_trades INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. å­˜å‚¨å›æµ‹ç»“æœ
INSERT INTO backtest_results (
    strategy_name, symbol, start_date, end_date,
    initial_capital, final_capital, total_return, sharpe_ratio
)
VALUES (
    'MA_Cross_Strategy',
    'AAPL',
    '2024-01-01',
    '2024-12-31',
    100000.00,
    120000.00,
    0.20,
    1.5
);
```

### 6.2 å®æ—¶ä¿¡å·ç”Ÿæˆ

```sql
-- å®æ—¶ä¿¡å·ç”Ÿæˆ
-- 1. åˆ›å»ºä¿¡å·è¡¨
CREATE TABLE trading_signals (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    strategy_name VARCHAR(100),
    symbol VARCHAR(10),
    signal_type VARCHAR(10),  -- 'buy', 'sell', 'hold'
    signal_strength DECIMAL(5,2),  -- 0-100
    price DECIMAL(10,4),
    metadata JSONB
);

-- 2. ç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼ˆä½¿ç”¨è§¦å‘å™¨æˆ–å®šæ—¶ä»»åŠ¡ï¼‰
CREATE OR REPLACE FUNCTION generate_trading_signals()
RETURNS void AS $$
DECLARE
    rec RECORD;
    ma20 DECIMAL(10,4);
    ma50 DECIMAL(10,4);
    signal_type VARCHAR(10);
BEGIN
    FOR rec IN
        SELECT DISTINCT symbol
        FROM stock_prices
        WHERE time >= NOW() - INTERVAL '1 hour'
    LOOP
        -- è®¡ç®—ç§»åŠ¨å¹³å‡
        SELECT
            AVG(close_price) FILTER (WHERE time >= NOW() - INTERVAL '20 minutes'),
            AVG(close_price) FILTER (WHERE time >= NOW() - INTERVAL '50 minutes')
        INTO ma20, ma50
        FROM stock_prices
        WHERE symbol = rec.symbol
        AND time >= NOW() - INTERVAL '1 hour';

        -- ç”Ÿæˆä¿¡å·
        IF ma20 > ma50 THEN
            signal_type := 'buy';
        ELSIF ma20 < ma50 THEN
            signal_type := 'sell';
        ELSE
            signal_type := 'hold';
        END IF;

        -- æ’å…¥ä¿¡å·
        INSERT INTO trading_signals (strategy_name, symbol, signal_type, price)
        VALUES ('MA_Cross', rec.symbol, signal_type,
            (SELECT close_price FROM stock_prices
             WHERE symbol = rec.symbol
             ORDER BY time DESC LIMIT 1));
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 3. ä½¿ç”¨ pg_cron å®šæ—¶ç”Ÿæˆä¿¡å·
SELECT cron.schedule(
    'generate-signals',
    '* * * * *',  -- æ¯åˆ†é’Ÿæ‰§è¡Œ
    $$SELECT generate_trading_signals()$$
);
```

### 6.3 è®¢å•æ‰§è¡Œ

```sql
-- è®¢å•æ‰§è¡Œ
-- 1. åˆ›å»ºè®¢å•è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    symbol VARCHAR(10) NOT NULL,
    order_type VARCHAR(20) NOT NULL,  -- 'market', 'limit'
    side VARCHAR(10) NOT NULL,  -- 'buy', 'sell'
    quantity BIGINT NOT NULL,
    price DECIMAL(10,4),
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'filled', 'cancelled'
    filled_quantity BIGINT DEFAULT 0,
    filled_price DECIMAL(10,4),
    signal_id INTEGER REFERENCES trading_signals(id),
    metadata JSONB
);

-- 2. è®¢å•æ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_order(
    p_symbol VARCHAR(10),
    p_side VARCHAR(10),
    p_quantity BIGINT,
    p_price DECIMAL(10,4) DEFAULT NULL
)
RETURNS INTEGER AS $$
DECLARE
    v_order_id INTEGER;
    v_current_price DECIMAL(10,4);
BEGIN
    -- è·å–å½“å‰ä»·æ ¼
    SELECT close_price INTO v_current_price
    FROM stock_prices
    WHERE symbol = p_symbol
    ORDER BY time DESC
    LIMIT 1;

    -- åˆ›å»ºè®¢å•
    INSERT INTO orders (symbol, order_type, side, quantity, price, status)
    VALUES (
        p_symbol,
        COALESCE(p_price, v_current_price)::DECIMAL(10,4),
        p_side,
        p_quantity,
        COALESCE(p_price, v_current_price),
        'filled'
    )
    RETURNING id INTO v_order_id;

    -- æ›´æ–°è®¢å•çŠ¶æ€
    UPDATE orders
    SET
        filled_quantity = p_quantity,
        filled_price = COALESCE(p_price, v_current_price),
        status = 'filled'
    WHERE id = v_order_id;

    RETURN v_order_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. é£é™©æ§åˆ¶

### 7.1 å®æ—¶é£é™©ç›‘æ§

```sql
-- å®æ—¶é£é™©ç›‘æ§
-- 1. åˆ›å»ºé£é™©æŒ‡æ ‡è¡¨
CREATE TABLE risk_metrics (
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    symbol VARCHAR(10) NOT NULL,
    portfolio_value DECIMAL(20,2),
    var_95 DECIMAL(20,2),  -- 95% VaR
    var_99 DECIMAL(20,2),  -- 99% VaR
    volatility DECIMAL(10,4),
    beta DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    metadata JSONB
);

-- 2. è®¡ç®—å®æ—¶é£é™©æŒ‡æ ‡
CREATE OR REPLACE FUNCTION calculate_risk_metrics()
RETURNS void AS $$
DECLARE
    rec RECORD;
    v_var_95 DECIMAL(20,2);
    v_volatility DECIMAL(10,4);
BEGIN
    FOR rec IN
        SELECT DISTINCT symbol
        FROM stock_prices
        WHERE time >= NOW() - INTERVAL '1 hour'
    LOOP
        -- è®¡ç®— VaR å’Œæ³¢åŠ¨ç‡
        WITH returns AS (
            SELECT
                (close_price - LAG(close_price) OVER (ORDER BY time)) /
                LAG(close_price) OVER (ORDER BY time) AS return_pct
            FROM stock_prices
            WHERE symbol = rec.symbol
            AND time >= NOW() - INTERVAL '30 days'
        )
        SELECT
            PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_pct),
            STDDEV(return_pct) * SQRT(252)
        INTO v_var_95, v_volatility
        FROM returns;

        -- æ’å…¥é£é™©æŒ‡æ ‡
        INSERT INTO risk_metrics (symbol, var_95, volatility)
        VALUES (rec.symbol, v_var_95, v_volatility);
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 3. å®šæ—¶è®¡ç®—é£é™©æŒ‡æ ‡
SELECT cron.schedule(
    'calculate-risk-metrics',
    '*/5 * * * *',  -- æ¯ 5 åˆ†é’Ÿæ‰§è¡Œ
    $$SELECT calculate_risk_metrics()$$
);
```

### 7.2 é£é™©é¢„è­¦

```sql
-- é£é™©é¢„è­¦
-- 1. åˆ›å»ºé¢„è­¦è§„åˆ™è¡¨
CREATE TABLE risk_alerts (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    symbol VARCHAR(10),
    alert_type VARCHAR(50),  -- 'high_volatility', 'var_breach', etc.
    alert_level VARCHAR(20),  -- 'warning', 'critical'
    message TEXT,
    threshold_value DECIMAL(20,2),
    current_value DECIMAL(20,2),
    metadata JSONB
);

-- 2. é£é™©é¢„è­¦å‡½æ•°
CREATE OR REPLACE FUNCTION check_risk_alerts()
RETURNS void AS $$
DECLARE
    rec RECORD;
    v_current_var DECIMAL(20,2);
    v_threshold_var DECIMAL(20,2) := 10000.00;  -- é˜ˆå€¼
BEGIN
    FOR rec IN
        SELECT symbol, var_95
        FROM risk_metrics
        WHERE time >= NOW() - INTERVAL '5 minutes'
    LOOP
        -- æ£€æŸ¥ VaR çªç ´
        IF rec.var_95 > v_threshold_var THEN
            INSERT INTO risk_alerts (
                symbol, alert_type, alert_level, message,
                threshold_value, current_value
            )
            VALUES (
                rec.symbol,
                'var_breach',
                'critical',
                format('VaR 95%% çªç ´é˜ˆå€¼: %.2f > %.2f', rec.var_95, v_threshold_var),
                v_threshold_var,
                rec.var_95
            );
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 3. å®šæ—¶æ£€æŸ¥é£é™©é¢„è­¦
SELECT cron.schedule(
    'check-risk-alerts',
    '* * * * *',  -- æ¯åˆ†é’Ÿæ‰§è¡Œ
    $$SELECT check_risk_alerts()$$
);
```

### 7.3 é£é™©æŠ¥å‘Š

```sql
-- é£é™©æŠ¥å‘Š
-- 1. ç”Ÿæˆé£é™©æŠ¥å‘Š
SELECT
    symbol,
    COUNT(*) AS alert_count,
    COUNT(*) FILTER (WHERE alert_level = 'critical') AS critical_alerts,
    COUNT(*) FILTER (WHERE alert_level = 'warning') AS warning_alerts,
    MAX(time) AS last_alert_time
FROM risk_alerts
WHERE time >= NOW() - INTERVAL '24 hours'
GROUP BY symbol
ORDER BY alert_count DESC;

-- 2. é£é™©æŒ‡æ ‡æ±‡æ€»
SELECT
    symbol,
    AVG(volatility) AS avg_volatility,
    MAX(var_95) AS max_var_95,
    AVG(sharpe_ratio) AS avg_sharpe_ratio,
    MAX(max_drawdown) AS max_drawdown
FROM risk_metrics
WHERE time >= NOW() - INTERVAL '24 hours'
GROUP BY symbol
ORDER BY avg_volatility DESC;
```

---

## 8. æ¶æ„è®¾è®¡

### 8.1 ç³»ç»Ÿæ¶æ„

```sql
-- é‡‘èæ—¶åºæ•°æ®ç³»ç»Ÿæ¶æ„
-- 1. æ•°æ®é‡‡é›†å±‚
--    - å®æ—¶æ•°æ®é‡‡é›†ï¼ˆAPIã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
--    - æ•°æ®éªŒè¯å’Œæ¸…æ´—
--    - æ‰¹é‡å†™å…¥æ•°æ®åº“

-- 2. æ•°æ®å­˜å‚¨å±‚
--    - TimescaleDB 3.0 è¶…è¡¨å­˜å‚¨
--    - PostgreSQL 18 å¼‚æ­¥ I/O
--    - æ•°æ®å‹ç¼©å’Œå½’æ¡£

-- 3. å®æ—¶åˆ†æå±‚
--    - è¿ç»­èšåˆå®æ—¶è®¡ç®—
--    - æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
--    - é£é™©æŒ‡æ ‡è®¡ç®—

-- 4. äº¤æ˜“æ‰§è¡Œå±‚
--    - ä¿¡å·ç”Ÿæˆ
--    - è®¢å•ç®¡ç†
--    - æ‰§è¡Œç›‘æ§

-- 5. é£é™©æ§åˆ¶å±‚
--    - å®æ—¶é£é™©ç›‘æ§
--    - é£é™©é¢„è­¦
--    - é£é™©æŠ¥å‘Š
```

### 8.2 æ•°æ®æµè®¾è®¡

```sql
-- æ•°æ®æµè®¾è®¡
-- 1. æ•°æ®é‡‡é›† â†’ æ•°æ®å­˜å‚¨
--    å®æ—¶æ•°æ® â†’ TimescaleDB è¶…è¡¨

-- 2. æ•°æ®å­˜å‚¨ â†’ å®æ—¶åˆ†æ
--    è¶…è¡¨ â†’ è¿ç»­èšåˆ â†’ æŠ€æœ¯æŒ‡æ ‡

-- 3. å®æ—¶åˆ†æ â†’ äº¤æ˜“æ‰§è¡Œ
--    æŠ€æœ¯æŒ‡æ ‡ â†’ äº¤æ˜“ä¿¡å· â†’ è®¢å•æ‰§è¡Œ

-- 4. äº¤æ˜“æ‰§è¡Œ â†’ é£é™©æ§åˆ¶
--    è®¢å•æ•°æ® â†’ é£é™©æŒ‡æ ‡ â†’ é£é™©é¢„è­¦
```

### 8.3 æ€§èƒ½ä¼˜åŒ–

```sql
-- æ€§èƒ½ä¼˜åŒ–
-- 1. ä½¿ç”¨ PostgreSQL 18 å¼‚æ­¥ I/O
-- postgresql.conf
io_method = 'io_uring'  -- å¦‚æœæ”¯æŒ

-- 2. ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
-- postgresql.conf
max_parallel_workers_per_gather = 4

-- 3. ä½¿ç”¨è¿ç»­èšåˆ
CREATE MATERIALIZED VIEW stock_prices_minute
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS bucket,
    symbol,
    first(open_price, time) AS open,
    MAX(high_price) AS high,
    MIN(low_price) AS low,
    last(close_price, time) AS close,
    SUM(volume) AS volume
FROM stock_prices
GROUP BY bucket, symbol;

-- 4. å¯ç”¨æ•°æ®å‹ç¼©
ALTER TABLE stock_prices SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'symbol',
    timescaledb.compress_orderby = 'time DESC'
);
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨ TimescaleDB è¶…è¡¨
SELECT create_hypertable('stock_prices', 'time',
    chunk_time_interval => INTERVAL '1 day');

-- æ¨èï¼šä½¿ç”¨è¿ç»­èšåˆä¼˜åŒ–æŸ¥è¯¢
CREATE MATERIALIZED VIEW stock_prices_minute
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS bucket,
    symbol,
    AVG(close_price) AS avg_price
FROM stock_prices
GROUP BY bucket, symbol;

-- æ¨èï¼šå¯ç”¨æ•°æ®å‹ç¼©
ALTER TABLE stock_prices SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'symbol',
    timescaledb.compress_orderby = 'time DESC'
);
```

### 9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥
INSERT INTO stock_prices (time, symbol, close_price, volume)
SELECT
    NOW() - (random() * INTERVAL '1 day'),
    'AAPL',
    100.0 + random() * 10,
    (random() * 1000000)::BIGINT
FROM generate_series(1, 100000);

-- ä¼˜åŒ–ï¼šä½¿ç”¨è¿ç»­èšåˆæŸ¥è¯¢
SELECT * FROM stock_prices_minute
WHERE symbol = 'AAPL'
  AND bucket >= NOW() - INTERVAL '1 hour';

-- ä¼˜åŒ–ï¼šä½¿ç”¨ç´¢å¼•
CREATE INDEX idx_stock_prices_symbol_time
ON stock_prices (symbol, time DESC);
```

### 9.3 è¿ç»´å»ºè®®

```sql
-- è¿ç»´ï¼šç›‘æ§æ•°æ®é‡
SELECT
    DATE_TRUNC('day', time) AS day,
    COUNT(*) AS record_count,
    COUNT(DISTINCT symbol) AS symbol_count
FROM stock_prices
WHERE time >= NOW() - INTERVAL '30 days'
GROUP BY day
ORDER BY day DESC;

-- è¿ç»´ï¼šç›‘æ§å­˜å‚¨ä½¿ç”¨
SELECT
    hypertable_name,
    pg_size_pretty(total_bytes) AS total_size,
    pg_size_pretty(table_bytes) AS table_size,
    pg_size_pretty(index_bytes) AS index_size
FROM timescaledb_information.hypertable_stats;

-- è¿ç»´ï¼šç›‘æ§æŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    mean_time,
    max_time
FROM pg_stat_statements
WHERE query LIKE '%stock_prices%'
ORDER BY mean_time DESC
LIMIT 10;
```

---

## 10. å®é™…æ¡ˆä¾‹

### 10.1 æ¡ˆä¾‹ï¼šè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ

**åœºæ™¯**ï¼šè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿï¼Œå®æ—¶è‚¡ç¥¨ä»·æ ¼æ•°æ®ï¼Œæ¯ç§’ 100 ä¸‡æ¡æ•°æ®

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºè¶…è¡¨
CREATE TABLE stock_prices (
    time TIMESTAMPTZ NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    close_price DECIMAL(10,4),
    volume BIGINT
);

SELECT create_hypertable('stock_prices', 'time',
    chunk_time_interval => INTERVAL '1 day');

-- 2. åˆ›å»ºè¿ç»­èšåˆ
CREATE MATERIALIZED VIEW stock_prices_minute
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS bucket,
    symbol,
    first(open_price, time) AS open,
    MAX(high_price) AS high,
    MIN(low_price) AS low,
    last(close_price, time) AS close,
    SUM(volume) AS volume
FROM stock_prices
GROUP BY bucket, symbol;

-- 3. å¯ç”¨å‹ç¼©
ALTER TABLE stock_prices SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'symbol',
    timescaledb.compress_orderby = 'time DESC'
);
```

**æ•ˆæœ**ï¼š

- å†™å…¥æ€§èƒ½ï¼š100 ä¸‡ TPS
- æŸ¥è¯¢æ€§èƒ½ï¼š< 10msï¼ˆä½¿ç”¨è¿ç»­èšåˆï¼‰
- å­˜å‚¨æˆæœ¬é™ä½ 70%
- å®æ—¶åˆ†æå»¶è¿Ÿï¼š< 100ms

### 10.2 æ¡ˆä¾‹ï¼šé‡åŒ–äº¤æ˜“å¹³å°

**åœºæ™¯**ï¼šé‡åŒ–äº¤æ˜“å¹³å°ï¼Œå¤šç­–ç•¥å›æµ‹å’Œå®æ—¶äº¤æ˜“

**å®ç°**ï¼š

```sql
-- 1. å¤šç­–ç•¥æ•°æ®å­˜å‚¨
CREATE TABLE strategy_data (
    time TIMESTAMPTZ NOT NULL,
    strategy_name VARCHAR(100),
    symbol VARCHAR(10),
    signal_type VARCHAR(10),
    price DECIMAL(10,4),
    metadata JSONB
);

SELECT create_hypertable('strategy_data', 'time',
    chunk_time_interval => INTERVAL '1 hour');

-- 2. ç­–ç•¥å›æµ‹ç»“æœå­˜å‚¨
CREATE TABLE backtest_results (
    id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100),
    symbol VARCHAR(10),
    start_date DATE,
    end_date DATE,
    total_return DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. å®æ—¶ä¿¡å·ç”Ÿæˆ
SELECT cron.schedule(
    'generate-signals',
    '* * * * *',
    $$SELECT generate_trading_signals()$$
);
```

**æ•ˆæœ**ï¼š

- ç­–ç•¥å›æµ‹æ€§èƒ½ï¼šæå‡ 50%
- å®æ—¶ä¿¡å·ç”Ÿæˆï¼š< 1 ç§’
- æ•°æ®æŸ¥è¯¢æ€§èƒ½ï¼š< 50ms
- ç³»ç»Ÿç¨³å®šæ€§ï¼š99.9%

---

## ğŸ“Š æ€»ç»“

PostgreSQL é‡‘èæ—¶åºæ•°æ®åº”ç”¨æä¾›äº†å®Œæ•´çš„é‡‘èæ•°æ®å­˜å‚¨ã€åˆ†æå’Œäº¤æ˜“æ”¯æŒè§£å†³æ–¹æ¡ˆï¼š

1. **é«˜é¢‘æ•°æ®å­˜å‚¨**ï¼šæ”¯æŒæ¯ç§’ç™¾ä¸‡çº§æ•°æ®å†™å…¥
2. **å®æ—¶æ•°æ®åˆ†æ**ï¼šå®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡å’Œé£é™©æŒ‡æ ‡
3. **å†å²æ•°æ®åˆ†æ**ï¼šé«˜æ•ˆæŸ¥è¯¢å’Œåˆ†æå†å²æ•°æ®

---

## 10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 10.1 é‡‘èæ—¶åºæ•°æ®åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•å®ç°é«˜é¢‘æ•°æ®å†™å…¥ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šé‡‘èæ•°æ®å†™å…¥é¢‘ç‡é«˜ï¼Œéœ€è¦ä¼˜åŒ–å†™å…¥æ€§èƒ½ã€‚

**ä¼˜åŒ–æ–¹æ³•**ï¼š

1. **ä½¿ç”¨æ‰¹é‡æ’å…¥**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥
INSERT INTO tick_data (time, symbol, price, volume)
VALUES
    (NOW(), 'AAPL', 150.25, 1000),
    (NOW(), 'AAPL', 150.26, 2000),
    (NOW(), 'AAPL', 150.27, 1500);
-- æ‰¹é‡æ’å…¥ï¼Œæ€§èƒ½å¥½
```

2. **ä½¿ç”¨TimescaleDBè¶…è¡¨**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨TimescaleDBè¶…è¡¨
CREATE TABLE tick_data (
    time TIMESTAMPTZ NOT NULL,
    symbol TEXT,
    price DOUBLE PRECISION,
    volume BIGINT
);
SELECT create_hypertable('tick_data', 'time', chunk_time_interval => INTERVAL '1 day');
-- è‡ªåŠ¨åˆ†åŒºï¼Œæå‡å†™å…¥æ€§èƒ½
```

3. **ä¼˜åŒ–é…ç½®å‚æ•°**ï¼š

```sql
-- âœ… å¥½ï¼šä¼˜åŒ–é…ç½®å‚æ•°
ALTER SYSTEM SET shared_buffers = '8GB';
ALTER SYSTEM SET effective_cache_size = '24GB';
ALTER SYSTEM SET maintenance_work_mem = '2GB';
-- ä¼˜åŒ–å†…å­˜é…ç½®ï¼Œæå‡å†™å…¥æ€§èƒ½
```

**æ€§èƒ½æ•°æ®**ï¼š

- é»˜è®¤é…ç½®ï¼š10ä¸‡æ¡/ç§’
- ä¼˜åŒ–åï¼š100ä¸‡æ¡/ç§’
- **æ€§èƒ½æå‡ï¼š10å€**

#### Q2: å¦‚ä½•å®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆå¦‚MAã€RSIç­‰ï¼‰ã€‚

**è®¡ç®—æ–¹æ³•**ï¼š

1. **ä½¿ç”¨çª—å£å‡½æ•°**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç§»åŠ¨å¹³å‡
SELECT
    time,
    symbol,
    price,
    AVG(price) OVER (
        PARTITION BY symbol
        ORDER BY time
        ROWS BETWEEN 19 PRECEDING AND CURRENT ROW
    ) AS ma20
FROM tick_data
WHERE symbol = 'AAPL';
-- è®¡ç®—20æ—¥ç§»åŠ¨å¹³å‡
```

2. **ä½¿ç”¨è¿ç»­èšåˆ**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨è¿ç»­èšåˆé¢„è®¡ç®—
CREATE MATERIALIZED VIEW tick_indicators
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS minute,
    symbol,
    AVG(price) AS avg_price,
    MAX(price) AS max_price,
    MIN(price) AS min_price
FROM tick_data
GROUP BY minute, symbol;
-- é¢„è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
```

**æœ€ä½³å®è·µ**ï¼š

- **ä½¿ç”¨çª—å£å‡½æ•°**ï¼šå®æ—¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
- **é¢„è®¡ç®—èšåˆ**ï¼šä½¿ç”¨è¿ç»­èšåˆé¢„è®¡ç®—
- **ç¼“å­˜ç»“æœ**ï¼šç¼“å­˜è®¡ç®—ç»“æœ

### 10.2 é£é™©åˆ†æå¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å®ç°å®æ—¶é£é™©åˆ†æï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®æ—¶åˆ†æé‡‘èé£é™©ã€‚

**å®ç°æ–¹æ³•**ï¼š

1. **å®æ—¶è®¡ç®—é£é™©æŒ‡æ ‡**ï¼š

```sql
-- âœ… å¥½ï¼šå®æ—¶è®¡ç®—é£é™©æŒ‡æ ‡
WITH price_changes AS (
    SELECT
        symbol,
        price,
        LAG(price) OVER (PARTITION BY symbol ORDER BY time) AS prev_price
    FROM tick_data
    WHERE time > NOW() - INTERVAL '1 hour'
)
SELECT
    symbol,
    STDDEV(price - prev_price) AS volatility,
    MAX(price - prev_price) AS max_change
FROM price_changes
GROUP BY symbol;
-- è®¡ç®—æ³¢åŠ¨ç‡å’Œæœ€å¤§å˜åŒ–
```

2. **é…ç½®å‘Šè­¦è§„åˆ™**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®é£é™©å‘Šè­¦
CREATE FUNCTION check_risk_alerts() RETURNS void AS $$
BEGIN
    INSERT INTO risk_alerts (symbol, message, severity)
    SELECT
        symbol,
        'High volatility detected',
        'critical'
    FROM (
        SELECT
            symbol,
            STDDEV(price) AS volatility
        FROM tick_data
        WHERE time > NOW() - INTERVAL '5 minutes'
        GROUP BY symbol
    ) AS risk_metrics
    WHERE volatility > 10;
END;
$$ LANGUAGE plpgsql;
-- æ£€æŸ¥é£é™©å‘Šè­¦
```

**æœ€ä½³å®è·µ**ï¼š

- **å®æ—¶è®¡ç®—**ï¼šä½¿ç”¨çª—å£å‡½æ•°å®æ—¶è®¡ç®—
- **å‘Šè­¦æœºåˆ¶**ï¼šé…ç½®é£é™©å‘Šè­¦è§„åˆ™
- **ç›‘æ§ç³»ç»Ÿ**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ç³»ç»Ÿ

## ğŸ“š å‚è€ƒèµ„æ–™

4. **é‡åŒ–äº¤æ˜“æ”¯æŒ**ï¼šæ”¯æŒé‡åŒ–äº¤æ˜“ç­–ç•¥å›æµ‹å’Œæ‰§è¡Œ
5. **é£é™©æ§åˆ¶**ï¼šå®æ—¶é£é™©ç›‘æ§å’Œé¢„è­¦

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨ TimescaleDB 3.0 è¶…è¡¨å­˜å‚¨æ—¶åºæ•°æ®
- åˆ©ç”¨ PostgreSQL 18 å¼‚æ­¥ I/O æå‡æ€§èƒ½
- ä½¿ç”¨è¿ç»­èšåˆä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å¯ç”¨æ•°æ®å‹ç¼©èŠ‚çœå­˜å‚¨ç©ºé—´
- å®ç°å®æ—¶é£é™©ç›‘æ§å’Œé¢„è­¦

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [TimescaleDB å®˜æ–¹æ–‡æ¡£](https://docs.timescale.com/) - æ—¶åºæ•°æ®åº“æ‰©å±•
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - åˆ†åŒº](https://www.postgresql.org/docs/current/ddl-partitioning.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ‰©å±•](https://www.postgresql.org/docs/current/extend.html)

### æŠ€æœ¯è®ºæ–‡

- [Financial Time Series Analysis: A Survey](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - é‡‘èæ—¶åºæ•°æ®åˆ†æç ”ç©¶ç»¼è¿°
- [High-Frequency Trading: Database Requirements](https://www.timescale.com/blog/) - é«˜é¢‘äº¤æ˜“æ•°æ®åº“éœ€æ±‚ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [TimescaleDB å®˜æ–¹åšå®¢](https://www.timescale.com/blog/) - TimescaleDB æœ€æ–°åŠ¨æ€
- [Understanding Financial Time Series](https://docs.timescale.com/) - é‡‘èæ—¶åºæ•°æ®è¯¦è§£
- [PostgreSQL Financial Data Best Practices](https://docs.timescale.com/) - PostgreSQL é‡‘èæ•°æ®æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [TimescaleDB GitHub](https://github.com/timescale/timescaledb) - TimescaleDB å¼€æºé¡¹ç›®
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - Financial Time Series](https://stackoverflow.com/questions/tagged/financial-time-series) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-TREND-08
