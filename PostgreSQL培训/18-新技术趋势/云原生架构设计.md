# äº‘åŸç”Ÿæ¶æ„è®¾è®¡ï¼šPostgreSQL åœ¨äº‘ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+ äº‘åŸç”Ÿæ–¹æ¡ˆ
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-21

## ğŸ“‘ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» PostgreSQL åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­çš„æ¶æ„è®¾è®¡æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬å®¹å™¨åŒ–éƒ¨ç½²ã€Kubernetes é›†æˆã€é«˜å¯ç”¨æ–¹æ¡ˆã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç›‘æ§å‘Šè­¦ç­‰äº‘åŸç”Ÿç‰¹æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker å’Œ Kubernetes éƒ¨ç½²æ–¹æ¡ˆ
- **é«˜å¯ç”¨æ¶æ„**ï¼šäº‘ç¯å¢ƒä¸‹çš„é«˜å¯ç”¨æ–¹æ¡ˆ
- **è‡ªåŠ¨æ‰©ç¼©å®¹**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æº
- **æœåŠ¡å‘ç°**ï¼šåŠ¨æ€æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
- **ç›‘æ§å‘Šè­¦**ï¼šå®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»

## ğŸ“š ç›®å½•

- [äº‘åŸç”Ÿæ¶æ„è®¾è®¡ï¼šPostgreSQL åœ¨äº‘ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µ](#äº‘åŸç”Ÿæ¶æ„è®¾è®¡postgresql-åœ¨äº‘ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µ)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. äº‘åŸç”Ÿæ¶æ„æ¦‚è¿°](#1-äº‘åŸç”Ÿæ¶æ„æ¦‚è¿°)
    - [1.1 äº‘åŸç”Ÿæ¶æ„ç‰¹ç‚¹](#11-äº‘åŸç”Ÿæ¶æ„ç‰¹ç‚¹)
    - [1.2 æŠ€æœ¯æ ˆ](#12-æŠ€æœ¯æ ˆ)
  - [2. å®¹å™¨åŒ–éƒ¨ç½²](#2-å®¹å™¨åŒ–éƒ¨ç½²)
    - [2.1 Dockerfile](#21-dockerfile)
    - [2.2 Docker Compose](#22-docker-compose)
  - [3. Kubernetes é›†æˆ](#3-kubernetes-é›†æˆ)
    - [3.1 StatefulSet é…ç½®](#31-statefulset-é…ç½®)
    - [3.2 Service é…ç½®](#32-service-é…ç½®)
    - [3.3 ConfigMap å’Œ Secret](#33-configmap-å’Œ-secret)
  - [4. é«˜å¯ç”¨æ–¹æ¡ˆ](#4-é«˜å¯ç”¨æ–¹æ¡ˆ)
    - [4.1 Patroni é«˜å¯ç”¨](#41-patroni-é«˜å¯ç”¨)
    - [4.2 æµå¤åˆ¶é…ç½®](#42-æµå¤åˆ¶é…ç½®)
  - [5. è‡ªåŠ¨æ‰©ç¼©å®¹](#5-è‡ªåŠ¨æ‰©ç¼©å®¹)
    - [5.1 HPA (Horizontal Pod Autoscaler)](#51-hpa-horizontal-pod-autoscaler)
    - [5.2 VPA (Vertical Pod Autoscaler)](#52-vpa-vertical-pod-autoscaler)
  - [6. ç›‘æ§å‘Šè­¦](#6-ç›‘æ§å‘Šè­¦)
    - [6.1 Prometheus ç›‘æ§](#61-prometheus-ç›‘æ§)
    - [6.2 Grafana ä»ªè¡¨æ¿](#62-grafana-ä»ªè¡¨æ¿)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 èµ„æºç®¡ç†](#71-èµ„æºç®¡ç†)
    - [7.2 å­˜å‚¨ç®¡ç†](#72-å­˜å‚¨ç®¡ç†)
    - [7.3 å®‰å…¨é…ç½®](#73-å®‰å…¨é…ç½®)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. äº‘åŸç”Ÿæ¶æ„æ¦‚è¿°

### 1.1 äº‘åŸç”Ÿæ¶æ„ç‰¹ç‚¹

- **å®¹å™¨åŒ–**ï¼šä½¿ç”¨ Docker å®¹å™¨åŒ–åº”ç”¨
- **ç¼–æ’**ï¼šä½¿ç”¨ Kubernetes è¿›è¡Œå®¹å™¨ç¼–æ’
- **å¾®æœåŠ¡**ï¼šæœåŠ¡æ‹†åˆ†å’Œç‹¬ç«‹éƒ¨ç½²
- **è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©ç¼©å®¹ã€æ¢å¤
- **å¯è§‚æµ‹æ€§**ï¼šå®Œå–„çš„ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ª

### 1.2 æŠ€æœ¯æ ˆ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kubernetes    â”‚
â”‚  (Orchestration)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚
â”‚  (StatefulSet)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storage        â”‚
â”‚  (PV/PVC)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å®¹å™¨åŒ–éƒ¨ç½²

### 2.1 Dockerfile

```dockerfile
# PostgreSQL 17 Dockerfile
FROM postgres:17-alpine

# å®‰è£…æ‰©å±•
RUN apk add --no-cache \
    postgresql-contrib \
    postgresql-plpython3

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY init.sql /docker-entrypoint-initdb.d/
COPY postgresql.conf /etc/postgresql/
COPY pg_hba.conf /etc/postgresql/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV POSTGRES_DB=mydb
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=changeme

# æš´éœ²ç«¯å£
EXPOSE 5432

# å¯åŠ¨å‘½ä»¤
CMD ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
```

### 2.2 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:17-alpine
    container_name: postgres-primary
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - postgres-network
    restart: unless-stopped

  postgres-replica:
    image: postgres:17-alpine
    container_name: postgres-replica
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: changeme
      PGUSER: postgres
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
    networks:
      - postgres-network
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  postgres-data:
  postgres-replica-data:

networks:
  postgres-network:
    driver: bridge
```

---

## 3. Kubernetes é›†æˆ

### 3.1 StatefulSet é…ç½®

```yaml
# postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:17-alpine
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
```

### 3.2 Service é…ç½®

```yaml
# postgres-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: postgres
spec:
  type: ClusterIP
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
  clusterIP: None  # Headless Service for StatefulSet
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-read
  namespace: postgres
spec:
  type: ClusterIP
  selector:
    app: postgres
    role: replica
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
```

### 3.3 ConfigMap å’Œ Secret

```yaml
# postgres-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: postgres
data:
  postgresql.conf: |
    # è¿æ¥é…ç½®
    max_connections = 200
    shared_buffers = 2GB
    effective_cache_size = 6GB

    # æ—¥å¿—é…ç½®
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d.log'

    # å¤åˆ¶é…ç½®
    wal_level = replica
    max_wal_senders = 10
    hot_standby = on
---
# postgres-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: postgres
type: Opaque
stringData:
  username: postgres
  password: changeme
```

---

## 4. é«˜å¯ç”¨æ–¹æ¡ˆ

### 4.1 Patroni é«˜å¯ç”¨

```yaml
# patroni-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: patroni
  namespace: postgres
spec:
  serviceName: patroni
  replicas: 3
  selector:
    matchLabels:
      app: patroni
  template:
    metadata:
      labels:
        app: patroni
    spec:
      containers:
      - name: patroni
        image: patroni/patroni:latest
        env:
        - name: PATRONI_SCOPE
          value: postgres-cluster
        - name: PATRONI_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PATRONI_NAMESPACE
          value: /var/run/secrets/kubernetes.io/serviceaccount/namespace
        - name: PATRONI_RESTAPI_LISTEN
          value: 0.0.0.0:8008
        - name: PATRONI_RESTAPI_CONNECT_ADDRESS
          value: $(PATRONI_NAME).patroni:8008
        - name: PATRONI_POSTGRESQL_LISTEN
          value: 0.0.0.0:5432
        - name: PATRONI_POSTGRESQL_CONNECT_ADDRESS
          value: $(PATRONI_NAME).patroni:5432
        - name: PATRONI_KUBERNETES_USE_ENDPOINTS
          value: "true"
        - name: PATRONI_KUBERNETES_LABELS
          value: '{app: patroni}'
        ports:
        - containerPort: 5432
          name: postgres
        - containerPort: 8008
          name: rest-api
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
```

### 4.2 æµå¤åˆ¶é…ç½®

```yaml
# ä¸»åº“é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-primary-config
data:
  postgresql.conf: |
    wal_level = replica
    max_wal_senders = 10
    wal_keep_size = 1GB
    hot_standby = on
---
# ä»åº“é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-replica-config
data:
  postgresql.conf: |
    hot_standby = on
    max_standby_streaming_delay = 30s
```

---

## 5. è‡ªåŠ¨æ‰©ç¼©å®¹

### 5.1 HPA (Horizontal Pod Autoscaler)

```yaml
# postgres-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
  namespace: postgres
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Max
```

### 5.2 VPA (Vertical Pod Autoscaler)

```yaml
# postgres-vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: postgres-vpa
  namespace: postgres
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: postgres
      minAllowed:
        cpu: 500m
        memory: 1Gi
      maxAllowed:
        cpu: 4000m
        memory: 8Gi
      controlledResources: ["cpu", "memory"]
```

---

## 6. ç›‘æ§å‘Šè­¦

### 6.1 Prometheus ç›‘æ§

```yaml
# postgres-exporter.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-exporter
  namespace: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-exporter
  template:
    metadata:
      labels:
        app: postgres-exporter
    spec:
      containers:
      - name: postgres-exporter
        image: prometheuscommunity/postgres-exporter:latest
        env:
        - name: DATA_SOURCE_NAME
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: connection-string
        ports:
        - containerPort: 9187
          name: metrics
```

### 6.2 Grafana ä»ªè¡¨æ¿

```yaml
# grafana-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-postgres
  namespace: monitoring
data:
  postgres-dashboard.json: |
    {
      "dashboard": {
        "title": "PostgreSQL Dashboard",
        "panels": [
          {
            "title": "Connections",
            "targets": [
              {
                "expr": "pg_stat_database_numbackends"
              }
            ]
          },
          {
            "title": "Query Performance",
            "targets": [
              {
                "expr": "rate(pg_stat_statements_total_time[5m])"
              }
            ]
          }
        ]
      }
    }
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 èµ„æºç®¡ç†

```yaml
# èµ„æºè¯·æ±‚å’Œé™åˆ¶
resources:
  requests:
    memory: "2Gi"
    cpu: "1000m"
  limits:
    memory: "4Gi"
    cpu: "2000m"
```

### 7.2 å­˜å‚¨ç®¡ç†

```yaml
# ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨
volumeClaimTemplates:
- metadata:
    name: postgres-data
  spec:
    accessModes: [ "ReadWriteOnce" ]
    storageClassName: fast-ssd
    resources:
      requests:
        storage: 100Gi
```

### 7.3 å®‰å…¨é…ç½®

```yaml
# ä½¿ç”¨ Secret ç®¡ç†æ•æ„Ÿä¿¡æ¯
env:
- name: POSTGRES_PASSWORD
  valueFrom:
    secretKeyRef:
      name: postgres-secret
      key: password

# ä½¿ç”¨ NetworkPolicy é™åˆ¶ç½‘ç»œè®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: application
    ports:
    - protocol: TCP
      port: 5432
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­çš„æ¶æ„è®¾è®¡éœ€è¦å……åˆ†è€ƒè™‘å®¹å™¨åŒ–ã€ç¼–æ’ã€é«˜å¯ç”¨ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç›‘æ§å‘Šè­¦ç­‰æ–¹é¢ã€‚
é€šè¿‡åˆç†ä½¿ç”¨ Kubernetesã€StatefulSetã€Serviceã€ConfigMapã€Secret ç­‰èµ„æºï¼Œå¯ä»¥æ„å»ºç¨³å®šã€å¯æ‰©å±•ã€æ˜“ç»´æŠ¤çš„äº‘åŸç”Ÿ PostgreSQL é›†ç¾¤ã€‚

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-TREND-21
