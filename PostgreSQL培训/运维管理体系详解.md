# PostgreSQL è¿ç»´ç®¡ç†ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-61

## ğŸ“‘ ç›®å½•

- [PostgreSQL è¿ç»´ç®¡ç†ä½“ç³»è¯¦è§£](#postgresql-è¿ç»´ç®¡ç†ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è¿ç»´ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#2-è¿ç»´ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 è¿ç»´ç®¡ç†ä½“ç³»æ¶æ„](#21-è¿ç»´ç®¡ç†ä½“ç³»æ¶æ„)
    - [2.2 è¿ç»´ç®¡ç†æµç¨‹](#22-è¿ç»´ç®¡ç†æµç¨‹)
  - [3. è¿ç»´ç®¡ç†è¯¦è§£](#3-è¿ç»´ç®¡ç†è¯¦è§£)
    - [3.1 æ—¥å¸¸è¿ç»´ç®¡ç†](#31-æ—¥å¸¸è¿ç»´ç®¡ç†)
    - [3.2 æ€§èƒ½ç®¡ç†](#32-æ€§èƒ½ç®¡ç†)
    - [3.3 å®¹é‡ç®¡ç†](#33-å®¹é‡ç®¡ç†)
    - [3.4 å˜æ›´ç®¡ç†](#34-å˜æ›´ç®¡ç†)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒè¿ç»´ç®¡ç†ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-ç”Ÿäº§ç¯å¢ƒè¿ç»´ç®¡ç†çœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-è‡ªåŠ¨åŒ–è¿ç»´å¹³å°çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è¿ç»´ç®¡ç†åŸåˆ™](#51-è¿ç»´ç®¡ç†åŸåˆ™)
    - [5.2 è¿ç»´å»ºè®®](#52-è¿ç»´å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**è¿ç»´ç®¡ç†ä½“ç³»çš„ä»·å€¼**:

PostgreSQL è¿ç»´ç®¡ç†æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œæ¶‰åŠå¤šä¸ªæ–¹é¢ï¼š

1. **æ—¥å¸¸è¿ç»´**: æ—¥å¸¸ç›‘æ§å’Œç»´æŠ¤
2. **æ€§èƒ½ç®¡ç†**: æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
3. **å®¹é‡ç®¡ç†**: å®¹é‡è§„åˆ’å’Œæ‰©å±•
4. **å˜æ›´ç®¡ç†**: å˜æ›´å’Œå‡çº§ç®¡ç†
5. **æ•…éšœç®¡ç†**: æ•…éšœé¢„é˜²å’Œå¤„ç†

**åº”ç”¨åœºæ™¯**:

- **ç¨³å®šè¿è¡Œ**: ä¿è¯æ•°æ®åº“ç¨³å®šè¿è¡Œ
- **æ€§èƒ½ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–æ€§èƒ½
- **æˆæœ¬æ§åˆ¶**: æ§åˆ¶è¿è¥æˆæœ¬
- **é£é™©æ§åˆ¶**: æ§åˆ¶è¿ç»´é£é™©

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **ç¨³å®šæ€§** | è¿ç»´ç®¡ç†æå‡ç¨³å®šæ€§ | **+50%** |
| **æ•…éšœç‡** | é™ä½æ•…éšœç‡ | **-70%** |
| **æ¢å¤æ—¶é—´** | ç¼©çŸ­æ¢å¤æ—¶é—´ | **-80%** |
| **æˆæœ¬ä¼˜åŒ–** | ä¼˜åŒ–è¿è¥æˆæœ¬ | **-30%** |

## 2. è¿ç»´ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 è¿ç»´ç®¡ç†ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((è¿ç»´ç®¡ç†ä½“ç³»))
    æ—¥å¸¸è¿ç»´
      ç›‘æ§å‘Šè­¦
        ç³»ç»Ÿç›‘æ§
        æ•°æ®åº“ç›‘æ§
        åº”ç”¨ç›‘æ§
        å‘Šè­¦é€šçŸ¥
      æ—¥å¿—ç®¡ç†
        æ—¥å¿—æ”¶é›†
        æ—¥å¿—åˆ†æ
        æ—¥å¿—å½’æ¡£
        æ—¥å¿—æ¸…ç†
      å¤‡ä»½æ¢å¤
        å¤‡ä»½ç­–ç•¥
        å¤‡ä»½éªŒè¯
        æ¢å¤æµ‹è¯•
        ç¾éš¾æ¢å¤
    æ€§èƒ½ç®¡ç†
      æ€§èƒ½ç›‘æ§
        æŸ¥è¯¢æ€§èƒ½
        ç³»ç»Ÿæ€§èƒ½
        èµ„æºä½¿ç”¨
        æ€§èƒ½åŸºçº¿
      æ€§èƒ½ä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        é…ç½®ä¼˜åŒ–
        æ¶æ„ä¼˜åŒ–
      å®¹é‡è§„åˆ’
        å®¹é‡ç›‘æ§
        å®¹é‡é¢„æµ‹
        å®¹é‡æ‰©å±•
        èµ„æºè§„åˆ’
    å˜æ›´ç®¡ç†
      ç‰ˆæœ¬ç®¡ç†
        ç‰ˆæœ¬å‡çº§
        ç‰ˆæœ¬å›æ»š
        ç‰ˆæœ¬å…¼å®¹
        ç‰ˆæœ¬æµ‹è¯•
      é…ç½®ç®¡ç†
        é…ç½®å˜æ›´
        é…ç½®å®¡æ ¸
        é…ç½®å¤‡ä»½
        é…ç½®æ¢å¤
      å˜æ›´æµç¨‹
        å˜æ›´ç”³è¯·
        å˜æ›´å®¡æ‰¹
        å˜æ›´æ‰§è¡Œ
        å˜æ›´éªŒè¯
    æ•…éšœç®¡ç†
      æ•…éšœé¢„é˜²
        é£é™©è¯„ä¼°
        é¢„é˜²æªæ–½
        ç›‘æ§å‘Šè­¦
        å®šæœŸæ£€æŸ¥
      æ•…éšœå¤„ç†
        æ•…éšœå‘ç°
        æ•…éšœè¯Šæ–­
        æ•…éšœæ¢å¤
        æ•…éšœæ€»ç»“
      æ•…éšœæ¼”ç»ƒ
        æ¼”ç»ƒè®¡åˆ’
        æ¼”ç»ƒæ‰§è¡Œ
        æ¼”ç»ƒæ€»ç»“
        æ”¹è¿›æªæ–½
    å®‰å…¨ç®¡ç†
      è®¿é—®æ§åˆ¶
        ç”¨æˆ·ç®¡ç†
        æƒé™ç®¡ç†
        å®¡è®¡æ—¥å¿—
        å®‰å…¨ç­–ç•¥
      æ•°æ®å®‰å…¨
        æ•°æ®åŠ å¯†
        æ•°æ®å¤‡ä»½
        æ•°æ®æ¢å¤
        æ•°æ®è„±æ•
      å®‰å…¨å®¡è®¡
        å®‰å…¨æ‰«æ
        æ¼æ´æ£€æµ‹
        å®‰å…¨åŠ å›º
        åˆè§„æ£€æŸ¥
```

### 2.2 è¿ç»´ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[è¿ç»´éœ€æ±‚] --> B{è¿ç»´ç±»å‹?}
    B -->|æ—¥å¸¸è¿ç»´| C[ç›‘æ§å‘Šè­¦]
    B -->|æ€§èƒ½ç®¡ç†| D[æ€§èƒ½ä¼˜åŒ–]
    B -->|å˜æ›´ç®¡ç†| E[å˜æ›´æ‰§è¡Œ]
    B -->|æ•…éšœç®¡ç†| F[æ•…éšœå¤„ç†]
    C --> G[è¿ç»´æ£€æŸ¥]
    D --> G
    E --> G
    F --> G
    G --> H{å‘ç°é—®é¢˜?}
    H -->|æ˜¯| I[é—®é¢˜å¤„ç†]
    H -->|å¦| J[æŒç»­ç›‘æ§]
    I --> K[éªŒè¯æ•ˆæœ]
    K --> J
```

## 3. è¿ç»´ç®¡ç†è¯¦è§£

### 3.1 æ—¥å¸¸è¿ç»´ç®¡ç†

**æ—¥å¸¸è¿ç»´ä»»åŠ¡**:

| ä»»åŠ¡ | é¢‘ç‡ | é‡è¦æ€§ | è¯´æ˜ |
|------|------|--------|------|
| **ç›‘æ§æ£€æŸ¥** | å®æ—¶ | â­â­â­â­â­ | ç›‘æ§ç³»ç»ŸçŠ¶æ€ |
| **æ—¥å¿—æ£€æŸ¥** | æ¯æ—¥ | â­â­â­â­ | æ£€æŸ¥é”™è¯¯æ—¥å¿— |
| **å¤‡ä»½éªŒè¯** | æ¯æ—¥ | â­â­â­â­â­ | éªŒè¯å¤‡ä»½å®Œæ•´æ€§ |
| **æ€§èƒ½æ£€æŸ¥** | æ¯å‘¨ | â­â­â­â­ | æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡ |
| **å®¹é‡æ£€æŸ¥** | æ¯æœˆ | â­â­â­ | æ£€æŸ¥å®¹é‡ä½¿ç”¨ |

**æ—¥å¸¸è¿ç»´è„šæœ¬**:

```bash
#!/bin/bash
# æ—¥å¸¸è¿ç»´æ£€æŸ¥è„šæœ¬

# 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 2. æ£€æŸ¥æ•°æ®åº“å¤§å°
psql -U postgres -c "SELECT pg_size_pretty(pg_database_size('mydb'));"

# 3. æ£€æŸ¥æ…¢æŸ¥è¯¢
psql -U postgres -c "SELECT query, mean_exec_time FROM pg_stat_statements WHERE mean_exec_time > 1000 ORDER BY mean_exec_time DESC LIMIT 10;"

# 4. æ£€æŸ¥é”ç­‰å¾…
psql -U postgres -c "SELECT count(*) FROM pg_locks WHERE NOT granted;"

# 5. æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
psql -U postgres -c "SELECT pg_last_wal_replay_lsn(), pg_last_wal_receive_lsn();"

# 6. æ£€æŸ¥å¤‡ä»½çŠ¶æ€
ls -lh /backup/logical/
ls -lh /backup/basebackup/

# 7. æ£€æŸ¥æ—¥å¿—é”™è¯¯
grep -i error /var/lib/postgresql/data/log/postgresql-*.log | tail -20
```

### 3.2 æ€§èƒ½ç®¡ç†

**æ€§èƒ½ç®¡ç†æŒ‡æ ‡**:

| æŒ‡æ ‡ | é˜ˆå€¼ | é‡è¦æ€§ | è¯´æ˜ |
|------|------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | < 100ms | â­â­â­â­â­ | å¹³å‡æŸ¥è¯¢æ—¶é—´ |
| **æ…¢æŸ¥è¯¢æ•°** | < 10/åˆ†é’Ÿ | â­â­â­â­â­ | æ…¢æŸ¥è¯¢æ•°é‡ |
| **è¿æ¥æ•°** | < 80% max_connections | â­â­â­â­â­ | å½“å‰è¿æ¥æ•° |
| **ç¼“å­˜å‘½ä¸­ç‡** | > 95% | â­â­â­â­â­ | ç¼“å­˜å‘½ä¸­ç‡ |
| **å¤åˆ¶å»¶è¿Ÿ** | < 1ç§’ | â­â­â­â­ | å¤åˆ¶å»¶è¿Ÿ |

**æ€§èƒ½ç®¡ç†è„šæœ¬**:

```sql
-- 1. æ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW monitoring.performance_metrics AS
SELECT
    'query_time' AS metric,
    AVG(mean_exec_time) AS value
FROM pg_stat_statements
UNION ALL
SELECT
    'slow_queries' AS metric,
    COUNT(*)::NUMERIC AS value
FROM pg_stat_statements
WHERE mean_exec_time > 1000
UNION ALL
SELECT
    'connections' AS metric,
    COUNT(*)::NUMERIC AS value
FROM pg_stat_activity
UNION ALL
SELECT
    'cache_hit_ratio' AS metric,
    CASE
        WHEN sum(heap_blks_hit) = 0 THEN 0
        ELSE round(sum(heap_blks_hit)::numeric / (sum(heap_blks_hit) + sum(heap_blks_read)), 4) * 100
    END AS value
FROM pg_statio_user_tables;

-- 2. æ€§èƒ½å‘Šè­¦å‡½æ•°
CREATE OR REPLACE FUNCTION monitoring.check_performance()
RETURNS TABLE (
    metric TEXT,
    value NUMERIC,
    threshold NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'query_time'::TEXT,
        (SELECT AVG(mean_exec_time) FROM pg_stat_statements)::NUMERIC,
        100::NUMERIC,
        CASE
            WHEN (SELECT AVG(mean_exec_time) FROM pg_stat_statements) > 100
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END
    UNION ALL
    SELECT
        'slow_queries'::TEXT,
        (SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000)::NUMERIC,
        10::NUMERIC,
        CASE
            WHEN (SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000) > 10
            THEN 'WARNING'::TEXT
            ELSE 'OK'::TEXT
        END;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 å®¹é‡ç®¡ç†

**å®¹é‡ç®¡ç†æŒ‡æ ‡**:

| æŒ‡æ ‡ | é˜ˆå€¼ | é‡è¦æ€§ | è¯´æ˜ |
|------|------|--------|------|
| **æ•°æ®åº“å¤§å°** | ç›‘æ§å¢é•¿ | â­â­â­ | æ•°æ®åº“æ€»å¤§å° |
| **è¡¨å¤§å°** | ç›‘æ§å¢é•¿ | â­â­â­ | è¡¨å¤§å° |
| **ç´¢å¼•å¤§å°** | ç›‘æ§å¢é•¿ | â­â­â­ | ç´¢å¼•å¤§å° |
| **WALå¤§å°** | < max_wal_size | â­â­â­â­ | WALæ–‡ä»¶å¤§å° |
| **ç£ç›˜ä½¿ç”¨** | < 80% | â­â­â­â­â­ | ç£ç›˜ä½¿ç”¨ç‡ |

**å®¹é‡ç®¡ç†è„šæœ¬**:

```sql
-- 1. å®¹é‡ç›‘æ§è§†å›¾
CREATE VIEW monitoring.capacity_metrics AS
SELECT
    'database_size' AS metric,
    pg_size_pretty(pg_database_size(current_database())) AS size,
    pg_database_size(current_database()) AS bytes
UNION ALL
SELECT
    'table_size' AS metric,
    pg_size_pretty(pg_total_relation_size('orders')) AS size,
    pg_total_relation_size('orders') AS bytes
UNION ALL
SELECT
    'index_size' AS metric,
    pg_size_pretty(pg_indexes_size('orders')) AS size,
    pg_indexes_size('orders') AS bytes;

-- 2. å®¹é‡é¢„æµ‹å‡½æ•°
CREATE OR REPLACE FUNCTION monitoring.predict_capacity(
    days INTEGER DEFAULT 30
)
RETURNS TABLE (
    metric TEXT,
    current_size TEXT,
    predicted_size TEXT,
    growth_rate NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'database_size'::TEXT,
        pg_size_pretty(pg_database_size(current_database())) AS current_size,
        pg_size_pretty(
            pg_database_size(current_database()) * (1 + 0.1 * days / 30)
        ) AS predicted_size,
        0.1 AS growth_rate;
END;
$$ LANGUAGE plpgsql;
```

### 3.4 å˜æ›´ç®¡ç†

**å˜æ›´ç®¡ç†æµç¨‹**:

1. **å˜æ›´ç”³è¯·**: æäº¤å˜æ›´ç”³è¯·
2. **å˜æ›´å®¡æ‰¹**: å®¡æ‰¹å˜æ›´ç”³è¯·
3. **å˜æ›´å‡†å¤‡**: å‡†å¤‡å˜æ›´æ–¹æ¡ˆ
4. **å˜æ›´æ‰§è¡Œ**: æ‰§è¡Œå˜æ›´æ“ä½œ
5. **å˜æ›´éªŒè¯**: éªŒè¯å˜æ›´æ•ˆæœ
6. **å˜æ›´æ€»ç»“**: æ€»ç»“å˜æ›´ç»éªŒ

**å˜æ›´ç®¡ç†è„šæœ¬**:

```bash
#!/bin/bash
# å˜æ›´ç®¡ç†è„šæœ¬

# 1. å˜æ›´å‰å¤‡ä»½
pg_dump -Fc -d mydb -f /backup/before_change_$(date +%Y%m%d_%H%M%S).dump

# 2. å˜æ›´å‰æ£€æŸ¥
psql -U postgres -d mydb -c "SELECT version();"
psql -U postgres -d mydb -c "SELECT count(*) FROM pg_stat_activity;"

# 3. æ‰§è¡Œå˜æ›´
psql -U postgres -d mydb -f change_script.sql

# 4. å˜æ›´åéªŒè¯
psql -U postgres -d mydb -c "SELECT count(*) FROM pg_stat_activity;"
psql -U postgres -d mydb -c "SELECT * FROM pg_stat_statements WHERE query LIKE '%change%';"

# 5. å˜æ›´åå¤‡ä»½
pg_dump -Fc -d mydb -f /backup/after_change_$(date +%Y%m%d_%H%M%S).dump
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒè¿ç»´ç®¡ç†ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”Ÿäº§ç¯å¢ƒéœ€è¦å»ºç«‹å®Œæ•´çš„è¿ç»´ç®¡ç†ä½“ç³»ã€‚

**è¿ç»´æ–¹æ¡ˆ**:

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬

# 1. æ—¥å¸¸ç›‘æ§
monitor_database() {
    echo "=== æ•°æ®åº“ç›‘æ§ ==="
    psql -U postgres -c "
        SELECT
            'connections' AS metric,
            count(*) AS value
        FROM pg_stat_activity
        UNION ALL
        SELECT
            'slow_queries' AS metric,
            count(*) AS value
        FROM pg_stat_statements
        WHERE mean_exec_time > 1000;
    "
}

# 2. æ€§èƒ½æ£€æŸ¥
check_performance() {
    echo "=== æ€§èƒ½æ£€æŸ¥ ==="
    psql -U postgres -c "
        SELECT
            query,
            mean_exec_time,
            calls
        FROM pg_stat_statements
        WHERE mean_exec_time > 1000
        ORDER BY mean_exec_time DESC
        LIMIT 10;
    "
}

# 3. å®¹é‡æ£€æŸ¥
check_capacity() {
    echo "=== å®¹é‡æ£€æŸ¥ ==="
    psql -U postgres -c "
        SELECT
            pg_size_pretty(pg_database_size(current_database())) AS database_size,
            pg_size_pretty(
                (SELECT sum(pg_total_relation_size(schemaname||'.'||tablename))
                 FROM pg_tables WHERE schemaname = 'public')
            ) AS tables_size;
    "
}

# 4. å¤‡ä»½æ£€æŸ¥
check_backup() {
    echo "=== å¤‡ä»½æ£€æŸ¥ ==="
    ls -lh /backup/logical/ | tail -5
    ls -lh /backup/basebackup/ | tail -5
}

# 5. æ—¥å¿—æ£€æŸ¥
check_logs() {
    echo "=== æ—¥å¿—æ£€æŸ¥ ==="
    grep -i error /var/lib/postgresql/data/log/postgresql-*.log | tail -10
}

# ä¸»å‡½æ•°
main() {
    monitor_database
    check_performance
    check_capacity
    check_backup
    check_logs
}

main
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•…éšœå‘ç°æ—¶é—´** | 30 åˆ†é’Ÿ | **< 5 åˆ†é’Ÿ** | **83%** â¬‡ï¸ |
| **æ•…éšœæ¢å¤æ—¶é—´** | 2 å°æ—¶ | **< 30 åˆ†é’Ÿ** | **75%** â¬‡ï¸ |
| **è¿ç»´æ•ˆç‡** | åŸºå‡† | **+60%** | **æå‡** |

### 4.2 æ¡ˆä¾‹: è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å»ºç«‹è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```python
# è‡ªåŠ¨åŒ–è¿ç»´å¹³å°
import psycopg2
import schedule
import time
from datetime import datetime

class PostgreSQLMonitor:
    def __init__(self, host, port, database, user, password):
        self.conn = psycopg2.connect(
            host=host,
            port=port,
            database=database,
            user=user,
            password=password
        )

    def check_connections(self):
        """æ£€æŸ¥è¿æ¥æ•°"""
        cur = self.conn.cursor()
        cur.execute("SELECT count(*) FROM pg_stat_activity;")
        count = cur.fetchone()[0]
        cur.close()

        if count > 800:  # å‡è®¾max_connections=1000
            self.send_alert(f"è¿æ¥æ•°è¿‡é«˜: {count}")
        return count

    def check_slow_queries(self):
        """æ£€æŸ¥æ…¢æŸ¥è¯¢"""
        cur = self.conn.cursor()
        cur.execute("""
            SELECT count(*) FROM pg_stat_statements
            WHERE mean_exec_time > 1000;
        """)
        count = cur.fetchone()[0]
        cur.close()

        if count > 10:
            self.send_alert(f"æ…¢æŸ¥è¯¢è¿‡å¤š: {count}")
        return count

    def check_replication_lag(self):
        """æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ"""
        cur = self.conn.cursor()
        cur.execute("""
            SELECT pg_last_wal_replay_lsn(), pg_last_wal_receive_lsn();
        """)
        result = cur.fetchone()
        cur.close()

        # è®¡ç®—å»¶è¿Ÿï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        # å®é™…åº”è¯¥ä½¿ç”¨pg_wal_lsn_diff
        return result

    def send_alert(self, message):
        """å‘é€å‘Šè­¦"""
        print(f"[ALERT] {datetime.now()}: {message}")
        # å®é™…åº”è¯¥å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿ

    def run_monitoring(self):
        """è¿è¡Œç›‘æ§"""
        print(f"[INFO] {datetime.now()}: å¼€å§‹ç›‘æ§æ£€æŸ¥")
        self.check_connections()
        self.check_slow_queries()
        self.check_replication_lag()
        print(f"[INFO] {datetime.now()}: ç›‘æ§æ£€æŸ¥å®Œæˆ")

# å®šæ—¶ä»»åŠ¡
monitor = PostgreSQLMonitor(
    host='localhost',
    port=5432,
    database='mydb',
    user='postgres',
    password='password'
)

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
schedule.every(5).minutes.do(monitor.run_monitoring)

# è¿è¡Œè°ƒåº¦
while True:
    schedule.run_pending()
    time.sleep(1)
```

## 5. æœ€ä½³å®è·µ

### 5.1 è¿ç»´ç®¡ç†åŸåˆ™

1. **è‡ªåŠ¨åŒ–**: å°½å¯èƒ½è‡ªåŠ¨åŒ–è¿ç»´ä»»åŠ¡
2. **ç›‘æ§ä¼˜å…ˆ**: å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
3. **é¢„é˜²ä¸ºä¸»**: é¢„é˜²é—®é¢˜å‘ç”Ÿ
4. **æŒç»­æ”¹è¿›**: æŒç»­æ”¹è¿›è¿ç»´æµç¨‹

### 5.2 è¿ç»´å»ºè®®

1. **å®šæœŸæ£€æŸ¥**: å®šæœŸæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
2. **åŠæ—¶å“åº”**: åŠæ—¶å“åº”å‘Šè­¦
3. **æ–‡æ¡£åŒ–**: æ–‡æ¡£åŒ–è¿ç»´æµç¨‹
4. **æ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ

## 6. å‚è€ƒèµ„æ–™

- [ç›‘æ§ä¸è¯Šæ–­](./ç›‘æ§ä¸è¯Šæ–­.md)
- [ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£](./ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£.md)
- [å¤‡ä»½ä¸æ¢å¤](./å¤‡ä»½ä¸æ¢å¤.md)
- [å¤‡ä»½æ¢å¤ä½“ç³»è¯¦è§£](./å¤‡ä»½æ¢å¤ä½“ç³»è¯¦è§£.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-61
