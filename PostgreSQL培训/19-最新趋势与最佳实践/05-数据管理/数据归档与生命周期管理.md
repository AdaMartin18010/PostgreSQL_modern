# PostgreSQL数据归档与生命周期管理

> **更新时间**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **文档编号**: 19-05-03

---

## 📑 目录

- [PostgreSQL数据归档与生命周期管理](#postgresql数据归档与生命周期管理)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 数据生命周期管理价值](#11-数据生命周期管理价值)
  - [2. 数据生命周期管理决策树](#2-数据生命周期管理决策树)
  - [3. 归档策略对比矩阵](#3-归档策略对比矩阵)
  - [4. 实际应用案例](#4-实际应用案例)
    - [4.1 案例：电商订单数据归档](#41-案例电商订单数据归档)

---

## 1. 概述

### 1.1 数据生命周期管理价值

**数据生命周期管理的核心价值**：

| 价值维度 | 说明 | 量化数据 |
|---------|------|---------|
| **存储成本** | 冷热数据分离 | **-70%** 成本 |
| **查询性能** | 热数据优化 | **+50%** 性能 |
| **合规性** | 数据保留策略 | **100%** 合规 |

---

## 2. 数据生命周期管理决策树

```text
数据生命周期管理？
├─ 数据年龄？
│  ├─ < 3个月 → 热数据（在线存储）
│  ├─ 3-12个月 → 温数据（压缩存储）
│  └─ > 12个月 → 冷数据（归档存储）
└─ 访问频率？
   ├─ 高频 → 在线存储
   ├─ 中频 → 压缩存储
   └─ 低频 → 归档存储
```

---

## 3. 归档策略对比矩阵

| 策略 | 存储成本 | 查询性能 | 恢复时间 | 综合评分 |
|------|---------|---------|---------|---------|
| **定期归档** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | **3.8** |
| **实时归档** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **3.8** |
| **冷热分离** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | **3.7** |

---

## 4. 实际应用案例

### 4.1 案例：电商订单数据归档

**业务场景**：

- 电商平台订单系统
- 5000万+订单数据
- 需要保留7年历史数据

**实施方案**：

```sql
-- 1. 创建分区表（按时间分区）
CREATE TABLE orders (
    id BIGSERIAL,
    user_id BIGINT,
    total_amount DECIMAL(10, 2),
    created_at TIMESTAMPTZ NOT NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- 2. 创建热数据分区（最近3个月）
CREATE TABLE orders_2024_q4 PARTITION OF orders
    FOR VALUES FROM ('2024-10-01') TO ('2025-01-01');

-- 3. 创建温数据分区（3-12个月）
CREATE TABLE orders_2024_q3 PARTITION OF orders
    FOR VALUES FROM ('2024-07-01') TO ('2024-10-01');

-- 4. 创建冷数据分区（12个月以上）
CREATE TABLE orders_archive PARTITION OF orders
    FOR VALUES FROM ('2020-01-01') TO ('2024-07-01');

-- 5. 归档函数
CREATE OR REPLACE FUNCTION archive_old_orders()
RETURNS void AS $$
DECLARE
    archive_date TIMESTAMPTZ;
BEGIN
    -- 归档12个月前的数据
    archive_date := NOW() - INTERVAL '12 months';

    -- 将数据移动到归档表
    INSERT INTO orders_archive
    SELECT * FROM orders
    WHERE created_at < archive_date;

    -- 删除原数据
    DELETE FROM orders
    WHERE created_at < archive_date;
END;
$$ LANGUAGE plpgsql;

-- 6. 自动归档任务（使用pg_cron）
SELECT cron.schedule(
    'archive-old-orders',
    '0 2 * * 0',  -- 每周日凌晨2点执行
    $$SELECT archive_old_orders()$$
);
```

**实施效果**：

| 指标 | 实施前 | 实施后 | 提升 |
|------|--------|--------|------|
| **存储成本** | 100% | 30% | **-70%** |
| **查询性能** | 1000ms | 200ms | **5x** |
| **归档时间** | 手动（数小时） | 自动（10分钟） | **-95%** |

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
**文档编号**: 19-05-03
