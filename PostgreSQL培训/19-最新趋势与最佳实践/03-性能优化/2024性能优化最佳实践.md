# 2024 PostgreSQLæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 19-03-01

---

## ğŸ“‘ ç›®å½•

- [2024 PostgreSQLæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#2024-postgresqlæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 2024æ€§èƒ½ä¼˜åŒ–è¶‹åŠ¿](#11-2024æ€§èƒ½ä¼˜åŒ–è¶‹åŠ¿)
    - [1.2 ä¼˜åŒ–æ•ˆæœé‡åŒ–](#12-ä¼˜åŒ–æ•ˆæœé‡åŒ–)
  - [2. æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘](#2-æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘)
  - [3. ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”çŸ©é˜µ](#3-ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”çŸ©é˜µ)
    - [3.1 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ](#31-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ)
    - [3.2 é…ç½®ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ](#32-é…ç½®ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ)
  - [4. 2024æœ€æ–°ä¼˜åŒ–æŠ€æœ¯](#4-2024æœ€æ–°ä¼˜åŒ–æŠ€æœ¯)
    - [4.1 PostgreSQL 18å¼‚æ­¥I/O](#41-postgresql-18å¼‚æ­¥io)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›](#42-æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›)
  - [5. å®é™…ä¼˜åŒ–æ¡ˆä¾‹](#5-å®é™…ä¼˜åŒ–æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–](#51-æ¡ˆä¾‹ç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–)
  - [6. å¼‚æ­¥I/Oæ·±åº¦è§£æ](#6-å¼‚æ­¥ioæ·±åº¦è§£æ)
    - [6.1 å¼‚æ­¥I/OåŸç†](#61-å¼‚æ­¥ioåŸç†)
    - [6.2 å¼‚æ­¥I/Oé…ç½®](#62-å¼‚æ­¥ioé…ç½®)
    - [6.3 å¼‚æ­¥I/Oæ€§èƒ½æµ‹è¯•](#63-å¼‚æ­¥ioæ€§èƒ½æµ‹è¯•)
  - [7. æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›è¯¦è§£](#7-æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›è¯¦è§£)
    - [7.1 JOINé¡ºåºä¼˜åŒ–](#71-joiné¡ºåºä¼˜åŒ–)
    - [7.2 å­æŸ¥è¯¢ä¼˜åŒ–](#72-å­æŸ¥è¯¢ä¼˜åŒ–)
  - [8. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#8-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
    - [8.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®](#81-å¹¶è¡ŒæŸ¥è¯¢é…ç½®)
    - [8.2 å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½](#82-å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½)
  - [9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#9-å¸¸è§é—®é¢˜faq)
    - [9.1 æ€§èƒ½ä¼˜åŒ–åŸºç¡€å¸¸è§é—®é¢˜](#91-æ€§èƒ½ä¼˜åŒ–åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•è¯Šæ–­æ€§èƒ½é—®é¢˜ï¼Ÿ](#q1-å¦‚ä½•è¯Šæ–­æ€§èƒ½é—®é¢˜)
      - [Q2: å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ](#q2-å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢)
    - [9.2 é…ç½®ä¼˜åŒ–å¸¸è§é—®é¢˜](#92-é…ç½®ä¼˜åŒ–å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–PostgreSQLé…ç½®å‚æ•°ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–postgresqlé…ç½®å‚æ•°)

---

## 1. æ¦‚è¿°

### 1.1 2024æ€§èƒ½ä¼˜åŒ–è¶‹åŠ¿

**æ ¸å¿ƒè¶‹åŠ¿**ï¼š

1. **æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›**ï¼šPostgreSQL 17/18æŸ¥è¯¢ä¼˜åŒ–å™¨å¤§å¹…æ”¹è¿›
2. **å¼‚æ­¥I/O**ï¼šPostgreSQL 18å¼•å…¥å¼‚æ­¥I/Oæœºåˆ¶
3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼šå¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½æå‡50%+
4. **å­˜å‚¨ä¼˜åŒ–**ï¼šTOASTæœºåˆ¶ä¼˜åŒ–ï¼Œå­˜å‚¨æ•ˆç‡æå‡

### 1.2 ä¼˜åŒ–æ•ˆæœé‡åŒ–

| ä¼˜åŒ–æŠ€æœ¯ | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| **æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›** | 20-50% | å¤æ‚æŸ¥è¯¢ | P0 |
| **å¼‚æ­¥I/O** | 30-100% | I/Oå¯†é›†å‹ | P0 |
| **å¹¶è¡ŒæŸ¥è¯¢** | 50-200% | åˆ†ææŸ¥è¯¢ | P1 |
| **ç´¢å¼•ä¼˜åŒ–** | 10-100x | æŸ¥è¯¢ä¼˜åŒ– | P0 |

---

## 2. æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘

```text
æ€§èƒ½é—®é¢˜ï¼Ÿ
â”œâ”€ æŸ¥è¯¢æ…¢
â”‚  â”œâ”€ æŸ¥è¯¢ç±»å‹ï¼Ÿ
â”‚  â”‚  â”œâ”€ ç®€å•æŸ¥è¯¢ â†’ æ£€æŸ¥ç´¢å¼•
â”‚  â”‚  â”œâ”€ å¤æ‚æŸ¥è¯¢ â†’ æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼˜åŒ–
â”‚  â”‚  â””â”€ åˆ†ææŸ¥è¯¢ â†’ å¹¶è¡ŒæŸ¥è¯¢
â”‚  â””â”€ æ•°æ®è§„æ¨¡ï¼Ÿ
â”‚     â”œâ”€ å°è¡¨ â†’ æ£€æŸ¥ç´¢å¼•ã€ç»Ÿè®¡ä¿¡æ¯
â”‚     â”œâ”€ ä¸­è¡¨ â†’ ç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢é‡å†™
â”‚     â””â”€ å¤§è¡¨ â†’ åˆ†åŒºã€å¹¶è¡ŒæŸ¥è¯¢
â”œâ”€ I/Oæ…¢
â”‚  â”œâ”€ å­˜å‚¨ç±»å‹ï¼Ÿ
â”‚  â”‚  â”œâ”€ HDD â†’ å‡çº§SSD
â”‚  â”‚  â”œâ”€ SSD â†’ å¼‚æ­¥I/Oä¼˜åŒ–
â”‚  â”‚  â””â”€ NVMe â†’ é…ç½®ä¼˜åŒ–
â”‚  â””â”€ å¹¶å‘I/Oï¼Ÿ
â”‚     â”œâ”€ é«˜å¹¶å‘ â†’ å¼‚æ­¥I/O
â”‚     â””â”€ ä½å¹¶å‘ â†’ åŒæ­¥I/Oä¼˜åŒ–
â””â”€ å†…å­˜ä¸è¶³
   â”œâ”€ å…±äº«å†…å­˜ â†’ å¢åŠ shared_buffers
   â”œâ”€ å·¥ä½œå†…å­˜ â†’ å¢åŠ work_mem
   â””â”€ ç¼“å­˜å‘½ä¸­ç‡ â†’ ä¼˜åŒ–æŸ¥è¯¢ã€å¢åŠ å†…å­˜
```

---

## 3. ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”çŸ©é˜µ

### 3.1 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ

| ä¼˜åŒ–ç­–ç•¥ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ | ç»¼åˆè¯„åˆ† |
|---------|---------|---------|---------|------|---------|
| **ç´¢å¼•ä¼˜åŒ–** | 10-100x | â­â­ | æ‰€æœ‰æŸ¥è¯¢ | ä½ | **4.5** |
| **æŸ¥è¯¢é‡å†™** | 2-10x | â­â­â­ | å¤æ‚æŸ¥è¯¢ | ä½ | **4.0** |
| **ç»Ÿè®¡ä¿¡æ¯æ›´æ–°** | 20-50% | â­ | æ‰€æœ‰åœºæ™¯ | ä½ | **4.5** |
| **å¹¶è¡ŒæŸ¥è¯¢** | 50-200% | â­â­â­ | åˆ†ææŸ¥è¯¢ | ä¸­ | **4.0** |
| **ç‰©åŒ–è§†å›¾** | 10-100x | â­â­â­â­ | é‡å¤æŸ¥è¯¢ | ä¸­ | **3.5** |

### 3.2 é…ç½®ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ

| é…ç½®å‚æ•° | é»˜è®¤å€¼ | æ¨èå€¼ | æ€§èƒ½æå‡ | é£é™© | ä¼˜å…ˆçº§ |
|---------|--------|--------|---------|------|--------|
| **shared_buffers** | 128MB | 25%å†…å­˜ | 20-30% | ä½ | P0 |
| **work_mem** | 4MB | 64-256MB | 10-20% | ä¸­ | P1 |
| **effective_cache_size** | 4GB | 50-75%å†…å­˜ | 10-15% | ä½ | P1 |
| **maintenance_work_mem** | 64MB | 1-2GB | 30-50% | ä½ | P1 |
| **max_parallel_workers** | 8 | 16-32 | 50-200% | ä½ | P1 |

---

## 4. 2024æœ€æ–°ä¼˜åŒ–æŠ€æœ¯

### 4.1 PostgreSQL 18å¼‚æ­¥I/O

**æŠ€æœ¯åŸç†**ï¼š

PostgreSQL 18å¼•å…¥äº†å¼‚æ­¥I/Oæœºåˆ¶ï¼Œå…è®¸åœ¨ç­‰å¾…I/Oå®Œæˆæ—¶æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œå¤§å¹…æå‡I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½ã€‚

**æ€§èƒ½æ•°æ®**ï¼š

| åœºæ™¯ | åŒæ­¥I/O | å¼‚æ­¥I/O | æå‡å€æ•° |
|------|---------|---------|---------|
| **é¡ºåºæ‰«æ** | 1000ms | 300ms | **3.3x** |
| **ç´¢å¼•æ‰«æ** | 500ms | 200ms | **2.5x** |
| **æ‰¹é‡æ’å…¥** | 2000ms | 600ms | **3.3x** |

**é…ç½®æ–¹æ³•**ï¼š

```sql
-- å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_uring = on;
SELECT pg_reload_conf();
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›

**PostgreSQL 17/18æ”¹è¿›**ï¼š

1. **æ›´å¥½çš„JOINé¡ºåºé€‰æ‹©**
2. **æ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨**
3. **æ–°çš„ä¼˜åŒ–å™¨æç¤º**

**æ€§èƒ½æå‡**ï¼š

| æŸ¥è¯¢ç±»å‹ | PostgreSQL 16 | PostgreSQL 18 | æå‡ |
|---------|--------------|---------------|------|
| **å¤æ‚JOIN** | 1000ms | 600ms | **1.7x** |
| **å­æŸ¥è¯¢** | 800ms | 400ms | **2.0x** |
| **èšåˆæŸ¥è¯¢** | 1200ms | 700ms | **1.7x** |

---

## 5. å®é™…ä¼˜åŒ–æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**ï¼š

- å•†å“æœç´¢æŸ¥è¯¢æ…¢ï¼ˆ5ç§’+ï¼‰
- 1000ä¸‡å•†å“æ•°æ®
- å¤æ‚WHEREæ¡ä»¶

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_products_search ON products
(category_id, price, created_at)
WHERE status = 'active';

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE products;

-- 3. æŸ¥è¯¢ä¼˜åŒ–
EXPLAIN ANALYZE
SELECT * FROM products
WHERE category_id = 1
  AND price BETWEEN 100 AND 1000
  AND status = 'active'
ORDER BY created_at DESC
LIMIT 20;
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 5000ms | 50ms | **100x** |
| **ç´¢å¼•ä½¿ç”¨** | å¦ | æ˜¯ | - |
| **æ‰«æè¡Œæ•°** | 1000ä¸‡ | 1000 | **10000x** |

---

## 6. å¼‚æ­¥I/Oæ·±åº¦è§£æ

### 6.1 å¼‚æ­¥I/OåŸç†

**io_uringæœºåˆ¶**ï¼š

PostgreSQL 18å¼•å…¥äº†åŸºäºLinux io_uringçš„å¼‚æ­¥I/Oæœºåˆ¶ï¼Œå…è®¸åœ¨ç­‰å¾…I/Oå®Œæˆæ—¶æ‰§è¡Œå…¶ä»–æ“ä½œã€‚

**å·¥ä½œåŸç†**ï¼š

1. **æäº¤é˜Ÿåˆ—ï¼ˆSQï¼‰**ï¼šæäº¤I/Oè¯·æ±‚
2. **å®Œæˆé˜Ÿåˆ—ï¼ˆCQï¼‰**ï¼šæ¥æ”¶I/Oå®Œæˆé€šçŸ¥
3. **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäºäº‹ä»¶å¾ªç¯å¤„ç†I/O

**æ€§èƒ½ä¼˜åŠ¿**ï¼š

| æ“ä½œç±»å‹ | åŒæ­¥I/O | å¼‚æ­¥I/O | æå‡ |
|---------|---------|---------|------|
| **é¡ºåºæ‰«æ** | 1000ms | 300ms | **3.3x** |
| **ç´¢å¼•æ‰«æ** | 500ms | 200ms | **2.5x** |
| **æ‰¹é‡æ’å…¥** | 2000ms | 600ms | **3.3x** |
| **VACUUM** | 5000ms | 1500ms | **3.3x** |

### 6.2 å¼‚æ­¥I/Oé…ç½®

**é…ç½®æ–¹æ³•**ï¼š

```sql
-- 1. æ£€æŸ¥ç³»ç»Ÿæ”¯æŒ
SHOW io_uring;

-- 2. å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_uring = on;
SELECT pg_reload_conf();

-- 3. é…ç½®å¼‚æ­¥I/Oå‚æ•°
ALTER SYSTEM SET io_uring_entries = 1024;  -- é˜Ÿåˆ—å¤§å°
ALTER SYSTEM SET io_uring_register_files = on;  -- æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦
SELECT pg_reload_conf();
```

**ç³»ç»Ÿè¦æ±‚**ï¼š

- Linuxå†…æ ¸ 5.1+
- PostgreSQL 18+
- å¯ç”¨io_uringæ”¯æŒ

### 6.3 å¼‚æ­¥I/Oæ€§èƒ½æµ‹è¯•

**æµ‹è¯•è„šæœ¬**ï¼š

```sql
-- 1. åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_table (
    id BIGSERIAL PRIMARY KEY,
    data TEXT
);

-- 2. æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_table (data)
SELECT md5(random()::text) FROM generate_series(1, 1000000);

-- 3. æµ‹è¯•åŒæ­¥I/Oæ€§èƒ½
SET io_uring = off;
EXPLAIN ANALYZE
SELECT COUNT(*) FROM test_table WHERE data LIKE 'a%';

-- 4. æµ‹è¯•å¼‚æ­¥I/Oæ€§èƒ½
SET io_uring = on;
EXPLAIN ANALYZE
SELECT COUNT(*) FROM test_table WHERE data LIKE 'a%';
```

---

## 7. æŸ¥è¯¢ä¼˜åŒ–å™¨æ”¹è¿›è¯¦è§£

### 7.1 JOINé¡ºåºä¼˜åŒ–

**PostgreSQL 18æ”¹è¿›**ï¼š

1. **åŠ¨æ€è§„åˆ’ç®—æ³•ä¼˜åŒ–**ï¼š
   - æ›´æ™ºèƒ½çš„JOINé¡ºåºé€‰æ‹©
   - å‡å°‘æœç´¢ç©ºé—´
   - æé«˜ä¼˜åŒ–é€Ÿåº¦

2. **ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨æ”¹è¿›**ï¼š
   - æ›´å‡†ç¡®çš„åŸºæ•°ä¼°ç®—
   - æ›´å¥½çš„é€‰æ‹©æ€§ä¼°ç®—

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```sql
-- 1. æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    u.name,
    COUNT(o.id) AS order_count,
    SUM(oi.quantity * p.price) AS total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.id, u.name
HAVING COUNT(o.id) > 10
ORDER BY total_amount DESC
LIMIT 100;

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼˜åŒ–å™¨ä¾èµ–ï¼‰
ANALYZE users;
ANALYZE orders;
ANALYZE order_items;
ANALYZE products;

-- 3. ä½¿ç”¨ä¼˜åŒ–å™¨æç¤ºï¼ˆPostgreSQL 18+ï¼‰
SET enable_hashjoin = off;  -- ç¦ç”¨Hash Join
SET enable_mergejoin = on;  -- å¯ç”¨Merge Join
```

### 7.2 å­æŸ¥è¯¢ä¼˜åŒ–

**PostgreSQL 18å­æŸ¥è¯¢ä¼˜åŒ–**ï¼š

1. **å­æŸ¥è¯¢æå‡**ï¼šå°†å­æŸ¥è¯¢è½¬æ¢ä¸ºJOIN
2. **ç‰©åŒ–ä¼˜åŒ–**ï¼šè‡ªåŠ¨ç‰©åŒ–é‡å¤å­æŸ¥è¯¢
3. **å¹¶è¡Œæ‰§è¡Œ**ï¼šå­æŸ¥è¯¢å¹¶è¡Œæ‰§è¡Œ

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼ˆPostgreSQL 16ï¼‰
EXPLAIN ANALYZE
SELECT * FROM users
WHERE id IN (
    SELECT user_id FROM orders
    WHERE created_at > '2024-01-01'
);
-- æ‰§è¡Œæ—¶é—´ï¼š800ms

-- ä¼˜åŒ–åï¼ˆPostgreSQL 18ï¼‰
-- è‡ªåŠ¨è½¬æ¢ä¸ºJOIN
EXPLAIN ANALYZE
SELECT u.* FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.user_id = u.id
      AND o.created_at > '2024-01-01'
);
-- æ‰§è¡Œæ—¶é—´ï¼š400msï¼ˆæå‡2xï¼‰
```

---

## 8. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

### 8.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®

**å¹¶è¡ŒæŸ¥è¯¢å‚æ•°**ï¼š

```sql
-- 1. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 16;
ALTER SYSTEM SET parallel_setup_cost = 100;
ALTER SYSTEM SET parallel_tuple_cost = 0.01;
SELECT pg_reload_conf();

-- 2. è¡¨çº§å¹¶è¡Œåº¦è®¾ç½®
ALTER TABLE orders SET (parallel_workers = 4);

-- 3. æŸ¥è¯¢çº§å¹¶è¡Œåº¦è®¾ç½®
SET max_parallel_workers_per_gather = 8;
```

### 8.2 å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½

**æ€§èƒ½æµ‹è¯•æ•°æ®**ï¼š

| æŸ¥è¯¢ç±»å‹ | ä¸²è¡Œæ‰§è¡Œ | å¹¶è¡Œæ‰§è¡Œï¼ˆ4 workersï¼‰ | æå‡ |
|---------|---------|---------------------|------|
| **èšåˆæŸ¥è¯¢** | 5000ms | 1250ms | **4x** |
| **æ’åºæŸ¥è¯¢** | 3000ms | 750ms | **4x** |
| **JOINæŸ¥è¯¢** | 8000ms | 2000ms | **4x** |

---

## 9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 9.1 æ€§èƒ½ä¼˜åŒ–åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•è¯Šæ–­æ€§èƒ½é—®é¢˜ï¼Ÿ

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. æŸ¥çœ‹ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event;

-- 3. æŸ¥çœ‹I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit
FROM pg_statio_user_tables
ORDER BY heap_blks_read DESC
LIMIT 10;
```

#### Q2: å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

1. **åˆ›å»ºç´¢å¼•**ï¼š

    ```sql
    CREATE INDEX idx_products_category_price ON products (category_id, price);
    ```

2. **æ›´æ–°ç»Ÿè®¡ä¿¡æ¯**ï¼š

    ```sql
    ANALYZE products;
    ```

3. **æŸ¥è¯¢é‡å†™**ï¼š

```sql
-- ä¼˜åŒ–å‰
SELECT * FROM products WHERE category_id IN (1, 2, 3);

-- ä¼˜åŒ–å
SELECT * FROM products WHERE category_id = 1
UNION ALL
SELECT * FROM products WHERE category_id = 2
UNION ALL
SELECT * FROM products WHERE category_id = 3;
```

### 9.2 é…ç½®ä¼˜åŒ–å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–PostgreSQLé…ç½®å‚æ•°ï¼Ÿ

**é…ç½®ä¼˜åŒ–çŸ©é˜µ**ï¼š

| å‚æ•° | é»˜è®¤å€¼ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|--------|------|
| **shared_buffers** | 128MB | 25%å†…å­˜ | å…±äº«ç¼“å†²åŒº |
| **work_mem** | 4MB | 64-256MB | å·¥ä½œå†…å­˜ |
| **effective_cache_size** | 4GB | 50-75%å†…å­˜ | æœ‰æ•ˆç¼“å­˜å¤§å° |
| **maintenance_work_mem** | 64MB | 1-2GB | ç»´æŠ¤å·¥ä½œå†…å­˜ |
| **max_parallel_workers** | 8 | 16-32 | æœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹ |

**é…ç½®è„šæœ¬**ï¼š

```sql
-- æ ¹æ®ç³»ç»Ÿå†…å­˜è‡ªåŠ¨é…ç½®
DO $$
DECLARE
    total_mem BIGINT;
BEGIN
    -- è·å–ç³»ç»Ÿå†…å­˜ï¼ˆå‡è®¾64GBï¼‰
    total_mem := 64 * 1024 * 1024 * 1024;

    -- é…ç½®å‚æ•°
    ALTER SYSTEM SET shared_buffers = (total_mem * 0.25)::text || 'B';
    ALTER SYSTEM SET effective_cache_size = (total_mem * 0.75)::text || 'B';
    ALTER SYSTEM SET work_mem = '256MB';
    ALTER SYSTEM SET maintenance_work_mem = '2GB';
    ALTER SYSTEM SET max_parallel_workers = 16;

    SELECT pg_reload_conf();
END;
$$;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 19-03-01
