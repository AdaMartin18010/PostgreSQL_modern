# ç°ä»£PostgreSQLé«˜å¯ç”¨æ¶æ„è®¾è®¡

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 19-04-01

---

## ğŸ“‘ ç›®å½•

- [ç°ä»£PostgreSQLé«˜å¯ç”¨æ¶æ„è®¾è®¡](#ç°ä»£postgresqlé«˜å¯ç”¨æ¶æ„è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿](#11-ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿)
    - [1.2 é«˜å¯ç”¨ä»·å€¼è®ºè¯](#12-é«˜å¯ç”¨ä»·å€¼è®ºè¯)
  - [2. é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#2-é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
    - [2.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ](#21-å·¥å…·å¯¹æ¯”çŸ©é˜µ)
    - [2.2 æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#22-æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [3. æ¶æ„è®¾è®¡å†³ç­–æ ‘](#3-æ¶æ„è®¾è®¡å†³ç­–æ ‘)
  - [4. ç”Ÿäº§çº§æ¶æ„è®¾è®¡](#4-ç”Ÿäº§çº§æ¶æ„è®¾è®¡)
    - [4.1 Patronié«˜å¯ç”¨æ¶æ„](#41-patronié«˜å¯ç”¨æ¶æ„)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„](#51-æ¡ˆä¾‹é‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„)

---

## 1. æ¦‚è¿°

### 1.1 ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿

**2024-2025è¶‹åŠ¿**ï¼š

1. **è‡ªåŠ¨åŒ–æ•…éšœè½¬ç§»**ï¼šæ•…éšœæ¢å¤æ—¶é—´ < 30ç§’
2. **å¤šåŒºåŸŸéƒ¨ç½²**ï¼šè·¨åŒºåŸŸé«˜å¯ç”¨
3. **è¯»å†™åˆ†ç¦»ä¼˜åŒ–**ï¼šæ™ºèƒ½è·¯ç”±
4. **äº‘åŸç”Ÿé›†æˆ**ï¼šKubernetes Operator

### 1.2 é«˜å¯ç”¨ä»·å€¼è®ºè¯

| ä»·å€¼ç»´åº¦ | è¯´æ˜ | é‡åŒ–æ•°æ® |
|---------|------|---------|
| **å¯ç”¨æ€§** | è‡ªåŠ¨æ•…éšœæ¢å¤ | **99.9%** å¯ç”¨æ€§ |
| **æ¢å¤æ—¶é—´** | å¿«é€Ÿæ•…éšœæ¢å¤ | **< 30ç§’** |
| **æ•°æ®ä¸€è‡´æ€§** | å¼ºä¸€è‡´æ€§ä¿è¯ | **100%** |
| **è¿ç»´æˆæœ¬** | è‡ªåŠ¨åŒ–è¿ç»´ | **-70%** æˆæœ¬ |

---

## 2. é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

### 2.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ

| å·¥å…· | æ•…éšœæ¢å¤æ—¶é—´ | æ•°æ®ä¸€è‡´æ€§ | è¿ç»´å¤æ‚åº¦ | æˆæœ¬ | å¯æ‰©å±•æ€§ | ç»¼åˆè¯„åˆ† |
|------|------------|-----------|-----------|------|---------|---------|
| **Patroni** | < 30ç§’ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | **4.1** |
| **pg_auto_failover** | < 1åˆ†é’Ÿ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | **4.3** |
| **Citus** | < 1åˆ†é’Ÿ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | **3.8** |
| **repmgr** | < 2åˆ†é’Ÿ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­ | **3.5** |

### 2.2 æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ–¹æ¡ˆ | å¯ç”¨æ€§ | æ€§èƒ½ | æˆæœ¬ | å¤æ‚åº¦ | é€‚ç”¨è§„æ¨¡ | ç»¼åˆè¯„åˆ† |
|---------|--------|------|------|--------|---------|---------|
| **ä¸»ä»å¤åˆ¶** | 99.9% | â­â­â­â­ | â­â­â­â­â­ | â­â­ | ä¸­å°å‹ | **3.8** |
| **Patronié›†ç¾¤** | 99.99% | â­â­â­â­ | â­â­â­â­ | â­â­â­ | ä¸­å¤§å‹ | **4.1** |
| **Citusåˆ†å¸ƒå¼** | 99.99% | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | è¶…å¤§å‹ | **4.0** |
| **å¤šåŒºåŸŸéƒ¨ç½²** | 99.999% | â­â­â­â­ | â­â­ | â­â­â­â­â­ | å¤§å‹ | **3.5** |

---

## 3. æ¶æ„è®¾è®¡å†³ç­–æ ‘

```text
éœ€è¦é«˜å¯ç”¨ï¼Ÿ
â”œâ”€ æ˜¯
â”‚  â”œâ”€ æ•°æ®è§„æ¨¡ï¼Ÿ
â”‚  â”‚  â”œâ”€ å°å‹ï¼ˆ< 100GBï¼‰ â†’ ä¸»ä»å¤åˆ¶
â”‚  â”‚  â”œâ”€ ä¸­å‹ï¼ˆ100GB-1TBï¼‰ â†’ Patronié›†ç¾¤
â”‚  â”‚  â””â”€ å¤§å‹ï¼ˆ> 1TBï¼‰ â†’ Citusåˆ†å¸ƒå¼
â”‚  â”œâ”€ æ•…éšœæ¢å¤æ—¶é—´è¦æ±‚ï¼Ÿ
â”‚  â”‚  â”œâ”€ < 30ç§’ â†’ Patroni
â”‚  â”‚  â”œâ”€ < 1åˆ†é’Ÿ â†’ pg_auto_failover
â”‚  â”‚  â””â”€ < 5åˆ†é’Ÿ â†’ repmgr
â”‚  â””â”€ åŒºåŸŸè¦æ±‚ï¼Ÿ
â”‚     â”œâ”€ å•åŒºåŸŸ â†’ æœ¬åœ°é«˜å¯ç”¨
â”‚     â””â”€ å¤šåŒºåŸŸ â†’ è·¨åŒºåŸŸé«˜å¯ç”¨
â””â”€ å¦ â†’ å•æœºéƒ¨ç½²
```

---

## 4. ç”Ÿäº§çº§æ¶æ„è®¾è®¡

### 4.1 Patronié«˜å¯ç”¨æ¶æ„

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[HAProxyè´Ÿè½½å‡è¡¡]
    B --> C1[PostgreSQLä¸»èŠ‚ç‚¹]
    B --> C2[PostgreSQLä»èŠ‚ç‚¹1]
    B --> C3[PostgreSQLä»èŠ‚ç‚¹2]
    C1 --> D[æµå¤åˆ¶]
    D --> C2
    D --> C3
    C1 --> E[Patroni]
    C2 --> E
    C3 --> E
    E --> F[etcd/ZooKeeper]

    style C1 fill:#90EE90
    style E fill:#87CEEB
    style F fill:#FFD700
```

**æ¶æ„ç‰¹ç‚¹**ï¼š

- è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¼ºä¸€è‡´æ€§ä¿è¯
- è¯»å†™åˆ†ç¦»

---

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„

**ä¸šåŠ¡åœºæ™¯**ï¼š

- é‡‘èäº¤æ˜“ç³»ç»Ÿ
- æ¯ç§’10ä¸‡+äº¤æ˜“
- 99.99%å¯ç”¨æ€§è¦æ±‚
- é›¶æ•°æ®ä¸¢å¤±

**å®æ–½æ–¹æ¡ˆ**ï¼š

```yaml
# Patronié…ç½®
scope: finance-cluster
namespace: /db/
name: postgres-primary

restapi:
  listen: 0.0.0.0:8008
  connect_address: 10.0.1.10:8008

etcd:
  hosts: 10.0.1.20:2379,10.0.1.21:2379,10.0.1.22:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        max_wal_senders: 10
        synchronous_commit: on
        synchronous_standby_names: 'ANY 2 (standby1, standby2)'

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 10.0.1.10:5432
  data_dir: /var/lib/postgresql/17/main
  authentication:
    replication:
      username: replicator
      password: replicator_password
```

**HAProxyé…ç½®**ï¼š

```haproxy
global
    log /dev/log local0
    maxconn 100

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend postgresql_frontend
    bind *:5432
    default_backend postgresql_backend

backend postgresql_backend
    option pgsql-check user postgres
    server postgresql1 10.0.1.10:5432 check
    server postgresql2 10.0.1.11:5432 check backup
    server postgresql3 10.0.1.12:5432 check backup
```

**å®æ–½æ•ˆæœ**ï¼š

| æŒ‡æ ‡ | å®æ–½å‰ | å®æ–½å | æå‡ |
|------|--------|--------|------|
| **å¯ç”¨æ€§** | 99.5% | 99.99% | **+0.49%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 15åˆ†é’Ÿ | 25ç§’ | **-97%** |
| **æ•°æ®ä¸¢å¤±é£é™©** | ä¸­ç­‰ | é›¶ä¸¢å¤± | **-100%** |
| **äº¤æ˜“å¤„ç†èƒ½åŠ›** | 5ä¸‡TPS | 10ä¸‡TPS | **2x** |

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 19-04-01
