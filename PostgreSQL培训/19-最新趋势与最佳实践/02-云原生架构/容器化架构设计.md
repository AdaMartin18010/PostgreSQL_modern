# PostgreSQLå®¹å™¨åŒ–æ¶æ„è®¾è®¡

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+, Docker/Kubernetes
> **æ–‡æ¡£ç¼–å·**: 19-02-03

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå®¹å™¨åŒ–æ¶æ„è®¾è®¡](#postgresqlå®¹å™¨åŒ–æ¶æ„è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 å®¹å™¨åŒ–ä»·å€¼](#11-å®¹å™¨åŒ–ä»·å€¼)
  - [2. å®¹å™¨åŒ–æ¶æ„è®¾è®¡](#2-å®¹å™¨åŒ–æ¶æ„è®¾è®¡)
    - [2.1 æ¶æ„æ€ç»´å¯¼å›¾](#21-æ¶æ„æ€ç»´å¯¼å›¾)
  - [3. éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#3-éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
    - [4.1 Dockeréƒ¨ç½²](#41-dockeréƒ¨ç½²)
    - [4.2 Kubernetes StatefulSetéƒ¨ç½²](#42-kubernetes-statefulsetéƒ¨ç½²)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šå¾®æœåŠ¡æ¶æ„å®¹å™¨åŒ–éƒ¨ç½²](#51-æ¡ˆä¾‹å¾®æœåŠ¡æ¶æ„å®¹å™¨åŒ–éƒ¨ç½²)
  - [6. Docker Composeå¤šå®¹å™¨éƒ¨ç½²](#6-docker-composeå¤šå®¹å™¨éƒ¨ç½²)
    - [6.1 å¤šæœåŠ¡ç¼–æ’](#61-å¤šæœåŠ¡ç¼–æ’)
    - [6.2 æ•°æ®æŒä¹…åŒ–é…ç½®](#62-æ•°æ®æŒä¹…åŒ–é…ç½®)
  - [7. å®¹å™¨åŒ–æ€§èƒ½ä¼˜åŒ–](#7-å®¹å™¨åŒ–æ€§èƒ½ä¼˜åŒ–)
    - [7.1 èµ„æºé™åˆ¶ä¼˜åŒ–](#71-èµ„æºé™åˆ¶ä¼˜åŒ–)
    - [7.2 ç½‘ç»œä¼˜åŒ–](#72-ç½‘ç»œä¼˜åŒ–)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜](#81-å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: Dockerå’ŒKuberneteså¦‚ä½•é€‰æ‹©ï¼Ÿ](#q1-dockerå’Œkuberneteså¦‚ä½•é€‰æ‹©)
      - [Q2: å¦‚ä½•ä¿è¯å®¹å™¨æ•°æ®æŒä¹…åŒ–ï¼Ÿ](#q2-å¦‚ä½•ä¿è¯å®¹å™¨æ•°æ®æŒä¹…åŒ–)
    - [8.2 å®¹å™¨åŒ–æ€§èƒ½å¸¸è§é—®é¢˜](#82-å®¹å™¨åŒ–æ€§èƒ½å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–å®¹å™¨åŒ–PostgreSQLæ€§èƒ½ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–å®¹å™¨åŒ–postgresqlæ€§èƒ½)

---

## 1. æ¦‚è¿°

### 1.1 å®¹å™¨åŒ–ä»·å€¼

**PostgreSQLå®¹å™¨åŒ–çš„æ ¸å¿ƒä»·å€¼**ï¼š

| ä»·å€¼ç»´åº¦ | è¯´æ˜ | é‡åŒ–æ•°æ® |
|---------|------|---------|
| **éƒ¨ç½²æ•ˆç‡** | å¿«é€Ÿéƒ¨ç½² | **-90%** éƒ¨ç½²æ—¶é—´ |
| **ç¯å¢ƒä¸€è‡´æ€§** | å¼€å‘ç”Ÿäº§ä¸€è‡´ | **100%** ä¸€è‡´æ€§ |
| **èµ„æºåˆ©ç”¨ç‡** | å®¹å™¨èµ„æºéš”ç¦» | **+50%** åˆ©ç”¨ç‡ |
| **å¯ç§»æ¤æ€§** | è·¨å¹³å°éƒ¨ç½² | **100%** å¯ç§»æ¤ |

---

## 2. å®¹å™¨åŒ–æ¶æ„è®¾è®¡

### 2.1 æ¶æ„æ€ç»´å¯¼å›¾

```mermaid
graph TD
    A[å®¹å™¨åŒ–PostgreSQL] --> B[Dockerå®¹å™¨]
    A --> C[Kubernetes Pod]
    A --> D[å­˜å‚¨å·]

    B --> B1[PostgreSQLé•œåƒ]
    B --> B2[é…ç½®ç®¡ç†]
    B --> B3[æ•°æ®æŒä¹…åŒ–]

    C --> C1[StatefulSet]
    C --> C2[Service]
    C --> C3[ConfigMap]
    C --> C4[Secret]

    D --> D1[PVCæŒä¹…å·]
    D --> D2[æœ¬åœ°å­˜å‚¨]
    D --> D3[ç½‘ç»œå­˜å‚¨]

    style B fill:#90EE90
    style C fill:#87CEEB
    style D fill:#FFD700
```

---

## 3. éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | æ˜“ç”¨æ€§ | å¯æ‰©å±•æ€§ | ç”Ÿäº§å°±ç»ª | æˆæœ¬ | ç»¼åˆè¯„åˆ† |
|------|--------|---------|---------|------|---------|
| **Docker Compose** | â­â­â­â­â­ | â­â­ | â­â­â­ | â­â­â­â­â­ | **3.8** |
| **Kubernetes StatefulSet** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | **4.0** |
| **PostgreSQL Operator** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | **4.3** |

---

## 4. æœ€ä½³å®è·µ

### 4.1 Dockeréƒ¨ç½²

```dockerfile
FROM postgres:17

# ç¯å¢ƒå˜é‡
ENV POSTGRES_DB=mydb
ENV POSTGRES_USER=myuser
ENV POSTGRES_PASSWORD=mypassword

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY init.sql /docker-entrypoint-initdb.d/

# æ•°æ®æŒä¹…åŒ–
VOLUME ["/var/lib/postgresql/data"]
```

### 4.2 Kubernetes StatefulSetéƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgresql
        image: postgres:17
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgresql
        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
```

---

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šå¾®æœåŠ¡æ¶æ„å®¹å™¨åŒ–éƒ¨ç½²

**ä¸šåŠ¡åœºæ™¯**ï¼š

- å¾®æœåŠ¡æ¶æ„
- 10+ä¸ªæœåŠ¡
- éœ€è¦å¿«é€Ÿéƒ¨ç½²å’Œæ‰©å±•

**å®æ–½æ–¹æ¡ˆ**ï¼š

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgresql:
    image: postgres:17
    container_name: postgresql
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d mydb"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgresql-data:
    driver: local

networks:
  app-network:
    driver: bridge
```

**å®æ–½æ•ˆæœ**ï¼š

| æŒ‡æ ‡ | å®æ–½å‰ | å®æ–½å | æå‡ |
|------|--------|--------|------|
| **éƒ¨ç½²æ—¶é—´** | 2å°æ—¶ | 5åˆ†é’Ÿ | **-96%** |
| **ç¯å¢ƒä¸€è‡´æ€§** | 60% | 100% | **+67%** |
| **èµ„æºåˆ©ç”¨ç‡** | 40% | 70% | **+75%** |

---

## 6. Docker Composeå¤šå®¹å™¨éƒ¨ç½²

### 6.1 å¤šæœåŠ¡ç¼–æ’

**å®Œæ•´docker-compose.yml**ï¼š

```yaml
version: '3.8'
services:
  postgresql:
    image: postgres:17
    container_name: postgresql
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d mydb"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: postgres -c config_file=/etc/postgresql/postgresql.conf

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - app-network
    depends_on:
      - postgresql

volumes:
  postgresql-data:
    driver: local

networks:
  app-network:
    driver: bridge
```

### 6.2 æ•°æ®æŒä¹…åŒ–é…ç½®

**æ•°æ®å·ç®¡ç†**ï¼š

```bash
# 1. æŸ¥çœ‹æ•°æ®å·
docker volume ls

# 2. å¤‡ä»½æ•°æ®å·
docker run --rm -v postgresql-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/postgresql-backup.tar.gz /data

# 3. æ¢å¤æ•°æ®å·
docker run --rm -v postgresql-data:/data -v $(pwd):/backup \
  alpine tar xzf /backup/postgresql-backup.tar.gz -C /
```

---

## 7. å®¹å™¨åŒ–æ€§èƒ½ä¼˜åŒ–

### 7.1 èµ„æºé™åˆ¶ä¼˜åŒ–

**èµ„æºé™åˆ¶é…ç½®**ï¼š

```yaml
services:
  postgresql:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
```

### 7.2 ç½‘ç»œä¼˜åŒ–

**ç½‘ç»œé…ç½®ä¼˜åŒ–**ï¼š

```yaml
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
```

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: Dockerå’ŒKuberneteså¦‚ä½•é€‰æ‹©ï¼Ÿ

**é€‰æ‹©å†³ç­–æ ‘**ï¼š

```text
éƒ¨ç½²è§„æ¨¡ï¼Ÿ
â”œâ”€ å•æœº/å°è§„æ¨¡ â†’ Docker Compose
â”œâ”€ ä¸­è§„æ¨¡ â†’ Kubernetes StatefulSet
â””â”€ å¤§è§„æ¨¡ â†’ Kubernetes Operator

è¿ç»´èƒ½åŠ›ï¼Ÿ
â”œâ”€ å¼± â†’ Docker Compose
â”œâ”€ ä¸­ â†’ Kubernetes StatefulSet
â””â”€ å¼º â†’ Kubernetes Operator
```

#### Q2: å¦‚ä½•ä¿è¯å®¹å™¨æ•°æ®æŒä¹…åŒ–ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨å‘½åå·**ï¼š

```yaml
volumes:
  postgresql-data:
    driver: local
```

2. **ä½¿ç”¨ç»‘å®šæŒ‚è½½**ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š

```yaml
volumes:
  - ./data:/var/lib/postgresql/data
```

3. **ä½¿ç”¨ç½‘ç»œå­˜å‚¨**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

```yaml
volumes:
  - postgresql-data:/var/lib/postgresql/data
volumes:
  postgresql-data:
    driver: nfs
    driver_opts:
      share: "192.168.1.100:/nfs/postgresql"
```

### 8.2 å®¹å™¨åŒ–æ€§èƒ½å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–å®¹å™¨åŒ–PostgreSQLæ€§èƒ½ï¼Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

1. **èµ„æºé™åˆ¶ä¼˜åŒ–**ï¼š

```yaml
deploy:
  resources:
    limits:
      cpus: '4'
      memory: 8G
```

2. **å­˜å‚¨ä¼˜åŒ–**ï¼š

```yaml
volumes:
  - postgresql-data:/var/lib/postgresql/data
volumes:
  postgresql-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/postgresql
```

3. **ç½‘ç»œä¼˜åŒ–**ï¼š

```yaml
networks:
  app-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 19-02-03
