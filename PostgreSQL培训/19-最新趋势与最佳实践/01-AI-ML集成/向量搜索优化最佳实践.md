# 向量搜索优化最佳实践

> **更新时间**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+, pgvector 0.5+
> **文档编号**: 19-01-03

---

## 📑 目录

- [向量搜索优化最佳实践](#向量搜索优化最佳实践)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 优化价值](#11-优化价值)
  - [2. 向量搜索优化决策树](#2-向量搜索优化决策树)
  - [3. 索引优化策略矩阵](#3-索引优化策略矩阵)
  - [4. 性能优化技术](#4-性能优化技术)
    - [4.1 HNSW参数优化](#41-hnsw参数优化)

---

## 1. 概述

### 1.1 优化价值

**向量搜索优化的核心价值**：

| 优化项 | 优化前 | 优化后 | 提升倍数 |
|--------|--------|--------|---------|
| **查询性能** | 5000ms | 10ms | **500x** |
| **并发能力** | 10 QPS | 1000+ QPS | **100x** |
| **存储效率** | 100% | 50-70% | **1.4-2x** |

---

## 2. 向量搜索优化决策树

```text
向量搜索性能问题？
├─ 查询慢
│  ├─ 数据规模？
│  │  ├─ < 100万 → HNSW (m=16)
│  │  ├─ 100万-1000万 → HNSW (m=32)
│  │  └─ > 1000万 → Citus分布式
│  └─ 查询延迟要求？
│     ├─ < 10ms → HNSW (ef_search=100)
│     └─ < 50ms → IVFFlat
├─ 索引构建慢
│  └─ 构建参数优化
│     ├─ HNSW → 降低ef_construction
│     └─ IVFFlat → 减少lists数量
└─ 存储空间大
   ├─ 向量维度优化
   └─ 索引压缩
```

---

## 3. 索引优化策略矩阵

| 优化策略 | 性能提升 | 存储影响 | 实施难度 | 优先级 |
|---------|---------|---------|---------|--------|
| **HNSW索引** | 10-100x | +50% | 低 | P0 |
| **向量维度优化** | 2-5x | -30% | 中 | P1 |
| **批量插入优化** | 5-10x | 无 | 低 | P0 |
| **查询参数优化** | 2-3x | 无 | 低 | P1 |

---

## 4. 性能优化技术

### 4.1 HNSW参数优化

**参数调优矩阵**：

| 参数 | 默认值 | 推荐值（小规模） | 推荐值（大规模） | 影响 |
|------|--------|----------------|----------------|------|
| **m** | 16 | 16 | 32 | 连接数，影响查询性能 |
| **ef_construction** | 64 | 64 | 128 | 构建时搜索范围 |
| **ef_search** | 40 | 100 | 200 | 查询时搜索范围 |

---

## 5. 实际应用案例

### 5.1 案例：推荐系统向量搜索优化

**业务场景**：

- 商品推荐系统
- 1000万商品向量
- 1536维向量（OpenAI embedding）
- 实时推荐（< 100ms响应时间）

**优化方案**：

```sql
-- 1. 创建向量表
CREATE TABLE product_embeddings (
    product_id BIGINT PRIMARY KEY,
    embedding vector(1536),
    category_id INTEGER,
    metadata JSONB
);

-- 2. 创建HNSW索引（优化参数）
CREATE INDEX ON product_embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);

-- 3. 优化查询（使用ef_search参数）
SET hnsw.ef_search = 100;

-- 4. 批量插入优化
BEGIN;
COPY product_embeddings (product_id, embedding, category_id, metadata)
FROM '/path/to/data.csv' WITH CSV;
COMMIT;

-- 5. 查询优化
EXPLAIN ANALYZE
SELECT
    product_id,
    embedding <=> $1 AS similarity,
    metadata
FROM product_embeddings
WHERE category_id = $2
ORDER BY embedding <=> $1
LIMIT 10;
```

**优化效果**：

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| **查询时间** | 5000ms | 15ms | **333x** |
| **索引构建时间** | 24小时 | 15分钟 | **96x** |
| **并发能力** | 10 QPS | 1000+ QPS | **100x** |
| **存储空间** | 100GB | 60GB | **-40%** |

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
**文档编号**: 19-01-03
