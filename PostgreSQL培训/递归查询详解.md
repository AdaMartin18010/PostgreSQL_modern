# PostgreSQL é€’å½’æŸ¥è¯¢è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-38

## ğŸ“‘ ç›®å½•

- [PostgreSQL é€’å½’æŸ¥è¯¢è¯¦è§£](#postgresql-é€’å½’æŸ¥è¯¢è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾](#14-é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. é€’å½’æŸ¥è¯¢åŸºç¡€](#2-é€’å½’æŸ¥è¯¢åŸºç¡€)
    - [2.1 é€’å½’æŸ¥è¯¢è¯­æ³•](#21-é€’å½’æŸ¥è¯¢è¯­æ³•)
    - [2.2 é€’å½’æŸ¥è¯¢ç»“æ„](#22-é€’å½’æŸ¥è¯¢ç»“æ„)
  - [3. é€’å½’æŸ¥è¯¢åº”ç”¨](#3-é€’å½’æŸ¥è¯¢åº”ç”¨)
    - [3.1 æ ‘å½¢ç»“æ„æŸ¥è¯¢](#31-æ ‘å½¢ç»“æ„æŸ¥è¯¢)
    - [3.2 è·¯å¾„æŸ¥æ‰¾](#32-è·¯å¾„æŸ¥æ‰¾)
    - [3.3 ç´¯è®¡è®¡ç®—](#33-ç´¯è®¡è®¡ç®—)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-ç»„ç»‡æ¶æ„æŸ¥è¯¢çœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: è¯„è®ºå›å¤æ ‘ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-è¯„è®ºå›å¤æ ‘çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é€’å½’æŸ¥è¯¢ä½¿ç”¨](#51-é€’å½’æŸ¥è¯¢ä½¿ç”¨)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é€’å½’æŸ¥è¯¢çš„ä»·å€¼**:

PostgreSQL é€’å½’æŸ¥è¯¢ï¼ˆWITH RECURSIVEï¼‰æä¾›äº†å¤„ç†å±‚æ¬¡ç»“æ„æ•°æ®çš„èƒ½åŠ›ï¼š

1. **å±‚æ¬¡ç»“æ„**: å¤„ç†æ ‘å½¢ç»“æ„ã€ç»„ç»‡æ¶æ„
2. **å›¾éå†**: éå†å›¾ç»“æ„æ•°æ®
3. **ç´¯è®¡è®¡ç®—**: è®¡ç®—ç´¯è®¡å€¼
4. **è·¯å¾„æŸ¥æ‰¾**: æŸ¥æ‰¾è·¯å¾„

**åº”ç”¨åœºæ™¯**:

- **ç»„ç»‡æ¶æ„**: æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘
- **åˆ†ç±»æ ‘**: æŸ¥è¯¢åˆ†ç±»æ ‘
- **è¯„è®ºå›å¤**: æŸ¥è¯¢è¯„è®ºå›å¤æ ‘
- **è·¯å¾„æŸ¥æ‰¾**: æŸ¥æ‰¾è·¯å¾„

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | é¿å…å¤šæ¬¡æŸ¥è¯¢æå‡æ€§èƒ½ | **+70%** |
| **ä»£ç ç®€åŒ–** | ç®€åŒ–å¤æ‚æŸ¥è¯¢ | **-60%** |
| **åŠŸèƒ½å¼ºå¤§** | å¼ºå¤§çš„å±‚æ¬¡æŸ¥è¯¢åŠŸèƒ½ | **é«˜** |
| **æ˜“ç”¨æ€§** | ç®€å•æ˜“ç”¨çš„è¯­æ³• | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æŸ¥è¯¢æ€§èƒ½**: é¿å…å¤šæ¬¡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ 70%
- **ä»£ç ç®€åŒ–**: ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼Œå‡å°‘ä»£ç é‡ 60%
- **åŠŸèƒ½å¼ºå¤§**: å¼ºå¤§çš„å±‚æ¬¡æŸ¥è¯¢åŠŸèƒ½
- **æ˜“ç”¨æ€§**: ç®€å•æ˜“ç”¨çš„è¯­æ³•

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡é€’å½’æŸ¥è¯¢çš„è¯­æ³•å’Œä½¿ç”¨
- ç†è§£é€’å½’æŸ¥è¯¢çš„åº”ç”¨åœºæ™¯
- å­¦ä¼šé€’å½’æŸ¥è¯¢ä¼˜åŒ–
- æŒæ¡å®é™…åº”ç”¨æ¡ˆä¾‹

### 1.4 é€’å½’æŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é€’å½’æŸ¥è¯¢ä½“ç³»))
    é€’å½’æŸ¥è¯¢ç»“æ„
      é”šç‚¹æŸ¥è¯¢
        åˆå§‹æŸ¥è¯¢
        èµ·å§‹ç‚¹
        åŸºç¡€æ•°æ®
      é€’å½’æŸ¥è¯¢
        é€’å½’éƒ¨åˆ†
        è¿æ¥æ¡ä»¶
        ç»ˆæ­¢æ¡ä»¶
      UNION/UNION ALL
        ç»“æœåˆå¹¶
        å»é‡/ä¸å»é‡
        ç»“æœé›†
    é€’å½’æŸ¥è¯¢ç±»å‹
      æ ‘å½¢ç»“æ„
        ç»„ç»‡æ¶æ„
        åˆ†ç±»æ ‘
        è¯„è®ºæ ‘
      å›¾éå†
        è·¯å¾„æŸ¥æ‰¾
        è¿é€šæ€§
        æœ€çŸ­è·¯å¾„
      ç´¯è®¡è®¡ç®—
        ç´¯è®¡æ±‚å’Œ
        ç´¯è®¡è®¡æ•°
        ç´¯è®¡ç»Ÿè®¡
    é€’å½’æŸ¥è¯¢åº”ç”¨
      å±‚æ¬¡æŸ¥è¯¢
        æŸ¥è¯¢å­æ ‘
        æŸ¥è¯¢è·¯å¾„
        æŸ¥è¯¢æ·±åº¦
      è·¯å¾„æŸ¥æ‰¾
        æœ€çŸ­è·¯å¾„
        æ‰€æœ‰è·¯å¾„
        è·¯å¾„ç»Ÿè®¡
      ç´¯è®¡è®¡ç®—
        ç´¯è®¡å€¼
        ç´¯è®¡ç»Ÿè®¡
        è¶‹åŠ¿åˆ†æ
    æ€§èƒ½ä¼˜åŒ–
      é€’å½’ä¼˜åŒ–
        æ·±åº¦é™åˆ¶
        å‰ªæä¼˜åŒ–
        ç´¢å¼•ä½¿ç”¨
      æŸ¥è¯¢ä¼˜åŒ–
        ä¼˜åŒ–é€’å½’æ¡ä»¶
        ä¼˜åŒ–è¿æ¥æ¡ä»¶
        å¹¶è¡Œæ‰§è¡Œ
```

## 2. é€’å½’æŸ¥è¯¢åŸºç¡€

### 2.1 é€’å½’æŸ¥è¯¢è¯­æ³•

**åŸºæœ¬è¯­æ³•**:

```sql
WITH RECURSIVE recursive_query AS (
    -- åˆå§‹æŸ¥è¯¢ï¼ˆé”šç‚¹ï¼‰
    SELECT ...
    FROM ...
    WHERE ...

    UNION ALL

    -- é€’å½’æŸ¥è¯¢
    SELECT ...
    FROM recursive_query
    JOIN ...
    WHERE ...
)
SELECT * FROM recursive_query;
```

### 2.2 é€’å½’æŸ¥è¯¢ç»“æ„

**é€’å½’æŸ¥è¯¢ç»“æ„**:

```sql
-- æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘
WITH RECURSIVE org_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šæ ¹èŠ‚ç‚¹
    SELECT
        id,
        name,
        parent_id,
        1 AS level,
        ARRAY[id] AS path
    FROM organizations
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå­èŠ‚ç‚¹
    SELECT
        o.id,
        o.name,
        o.parent_id,
        ot.level + 1,
        ot.path || o.id
    FROM organizations o
    JOIN org_tree ot ON o.parent_id = ot.id
)
SELECT * FROM org_tree;
```

## 3. é€’å½’æŸ¥è¯¢åº”ç”¨

### 3.1 æ ‘å½¢ç»“æ„æŸ¥è¯¢

**æ ‘å½¢ç»“æ„æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢æ‰€æœ‰å­èŠ‚ç‚¹
WITH RECURSIVE subtree AS (
    SELECT id, name, parent_id
    FROM categories
    WHERE id = 1

    UNION ALL

    SELECT c.id, c.name, c.parent_id
    FROM categories c
    JOIN subtree s ON c.parent_id = s.id
)
SELECT * FROM subtree;
```

### 3.2 è·¯å¾„æŸ¥æ‰¾

**è·¯å¾„æŸ¥æ‰¾**:

```sql
-- æŸ¥æ‰¾ä»èŠ‚ç‚¹Aåˆ°èŠ‚ç‚¹Bçš„è·¯å¾„
WITH RECURSIVE path_search AS (
    SELECT
        id,
        name,
        parent_id,
        ARRAY[id] AS path
    FROM nodes
    WHERE id = 1

    UNION ALL

    SELECT
        n.id,
        n.name,
        n.parent_id,
        ps.path || n.id
    FROM nodes n
    JOIN path_search ps ON n.parent_id = ps.id
    WHERE n.id != ALL(ps.path)  -- é¿å…å¾ªç¯
)
SELECT * FROM path_search WHERE id = 10;
```

### 3.3 ç´¯è®¡è®¡ç®—

**ç´¯è®¡è®¡ç®—**:

```sql
-- è®¡ç®—ç´¯è®¡å€¼
WITH RECURSIVE cumulative AS (
    SELECT
        date,
        amount,
        amount AS cumulative_amount
    FROM sales
    WHERE date = (SELECT MIN(date) FROM sales)

    UNION ALL

    SELECT
        s.date,
        s.amount,
        c.cumulative_amount + s.amount
    FROM sales s
    JOIN cumulative c ON s.date = c.date + INTERVAL '1 day'
)
SELECT * FROM cumulative;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦æŸ¥è¯¢ç»„ç»‡æ¶æ„æ ‘ï¼Œæ‰¾å‡ºæŸä¸ªéƒ¨é—¨çš„æ‰€æœ‰å­éƒ¨é—¨ã€‚

**é—®é¢˜åˆ†æ**:

1. **å±‚æ¬¡ç»“æ„**: éœ€è¦å¤„ç†å¤šå±‚æ¬¡çš„éƒ¨é—¨ç»“æ„
2. **æ€§èƒ½é—®é¢˜**: ä½¿ç”¨å¤šæ¬¡æŸ¥è¯¢æ€§èƒ½å·®
3. **ä»£ç å¤æ‚**: ä»£ç å¤æ‚éš¾ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æŸ¥è¯¢éƒ¨é—¨æ ‘
WITH RECURSIVE dept_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šæ ¹éƒ¨é—¨
    SELECT
        id,
        name,
        parent_id,
        1 AS level,
        name AS path
    FROM departments
    WHERE id = 1

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå­éƒ¨é—¨
    SELECT
        d.id,
        d.name,
        d.parent_id,
        dt.level + 1,
        dt.path || ' > ' || d.name
    FROM departments d
    JOIN dept_tree dt ON d.parent_id = dt.id
)
SELECT
    id,
    name,
    level,
    path
FROM dept_tree
ORDER BY level, name;

-- æŸ¥è¯¢æŸä¸ªéƒ¨é—¨çš„æ‰€æœ‰å­éƒ¨é—¨
WITH RECURSIVE sub_depts AS (
    SELECT id, name, parent_id
    FROM departments
    WHERE id = 5

    UNION ALL

    SELECT d.id, d.name, d.parent_id
    FROM departments d
    JOIN sub_depts sd ON d.parent_id = sd.id
)
SELECT * FROM sub_depts;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **ä»£ç è¡Œæ•°** | 80 è¡Œ | **20 è¡Œ** | **75%** â¬‡ï¸ |
| **å¯è¯»æ€§** | ä½ | **é«˜** | **æå‡** |

### 4.2 æ¡ˆä¾‹: è¯„è®ºå›å¤æ ‘ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸè®ºå›éœ€è¦æŸ¥è¯¢è¯„è®ºå›å¤æ ‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›å¤ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æŸ¥è¯¢è¯„è®ºå›å¤æ ‘
WITH RECURSIVE comment_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šé¡¶çº§è¯„è®º
    SELECT
        id,
        content,
        parent_id,
        user_id,
        1 AS level,
        ARRAY[id] AS path
    FROM comments
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå›å¤
    SELECT
        c.id,
        c.content,
        c.parent_id,
        c.user_id,
        ct.level + 1,
        ct.path || c.id
    FROM comments c
    JOIN comment_tree ct ON c.parent_id = ct.id
)
SELECT
    id,
    content,
    level,
    path
FROM comment_tree
ORDER BY path;
```

## 5. æœ€ä½³å®è·µ

### 5.1 é€’å½’æŸ¥è¯¢ä½¿ç”¨

1. **ç»ˆæ­¢æ¡ä»¶**: ç¡®ä¿é€’å½’æŸ¥è¯¢æœ‰ç»ˆæ­¢æ¡ä»¶
2. **é¿å…å¾ªç¯**: ä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–é€’å½’æŸ¥è¯¢

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•**: ä¸ºè¿æ¥åˆ—åˆ›å»ºç´¢å¼•
2. **é™åˆ¶æ·±åº¦**: é™åˆ¶é€’å½’æ·±åº¦
3. **è·¯å¾„æ£€æŸ¥**: ä½¿ç”¨è·¯å¾„æ•°ç»„é¿å…å¾ªç¯

## 6. å‚è€ƒèµ„æ–™

- [é«˜çº§SQLç‰¹æ€§](./é«˜çº§SQLç‰¹æ€§.md)
- [ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–](./ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€’å½’æŸ¥è¯¢](https://www.postgresql.org/docs/current/queries-with.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-38
