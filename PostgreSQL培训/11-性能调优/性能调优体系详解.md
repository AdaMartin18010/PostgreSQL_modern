# PostgreSQL æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-59

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£](#postgresql-æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾](#2-æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 æ€§èƒ½è°ƒä¼˜ä½“ç³»æ¶æ„](#21-æ€§èƒ½è°ƒä¼˜ä½“ç³»æ¶æ„)
    - [2.2 æ€§èƒ½è°ƒä¼˜æµç¨‹](#22-æ€§èƒ½è°ƒä¼˜æµç¨‹)
  - [3. è°ƒä¼˜ç­–ç•¥è¯¦è§£](#3-è°ƒä¼˜ç­–ç•¥è¯¦è§£)
    - [3.1 é…ç½®è°ƒä¼˜ç­–ç•¥](#31-é…ç½®è°ƒä¼˜ç­–ç•¥)
    - [3.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#32-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [3.3 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#33-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
    - [3.4 æ¶æ„ä¼˜åŒ–ç­–ç•¥](#34-æ¶æ„ä¼˜åŒ–ç­–ç•¥)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æ€§èƒ½ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-ç”µå•†å¹³å°æ€§èƒ½ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è°ƒä¼˜åŸåˆ™](#51-è°ƒä¼˜åŸåˆ™)
    - [5.2 è°ƒä¼˜å»ºè®®](#52-è°ƒä¼˜å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ€§èƒ½è°ƒä¼˜ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æ€§èƒ½è°ƒä¼˜æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œæ¶‰åŠå¤šä¸ªå±‚é¢ï¼š

1. **é…ç½®è°ƒä¼˜**: æ•°æ®åº“é…ç½®å‚æ•°ä¼˜åŒ–
2. **æŸ¥è¯¢ä¼˜åŒ–**: SQLæŸ¥è¯¢è¯­å¥ä¼˜åŒ–
3. **ç´¢å¼•ä¼˜åŒ–**: ç´¢å¼•è®¾è®¡å’Œä¼˜åŒ–
4. **æ¶æ„ä¼˜åŒ–**: æ•°æ®åº“æ¶æ„ä¼˜åŒ–
5. **ç¡¬ä»¶ä¼˜åŒ–**: ç¡¬ä»¶èµ„æºé…ç½®ä¼˜åŒ–

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½æå‡**: æå‡æ•°æ®åº“æ€§èƒ½
- **èµ„æºä¼˜åŒ–**: ä¼˜åŒ–èµ„æºä½¿ç”¨
- **æˆæœ¬é™ä½**: é™ä½è¿è¥æˆæœ¬
- **ç”¨æˆ·ä½“éªŒ**: æå‡ç”¨æˆ·ä½“éªŒ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | è°ƒä¼˜æå‡æŸ¥è¯¢æ€§èƒ½ | **2-10x** |
| **èµ„æºä½¿ç”¨** | ä¼˜åŒ–é™ä½èµ„æºä½¿ç”¨ | **-30%** |
| **æˆæœ¬é™ä½** | ä¼˜åŒ–é™ä½è¿è¥æˆæœ¬ | **-40%** |
| **ç”¨æˆ·ä½“éªŒ** | æå‡ç”¨æˆ·ä½“éªŒ | **+60%** |

## 2. æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 æ€§èƒ½è°ƒä¼˜ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((æ€§èƒ½è°ƒä¼˜ä½“ç³»))
    é…ç½®è°ƒä¼˜
      å†…å­˜é…ç½®
        shared_buffers
        work_mem
        maintenance_work_mem
        effective_cache_size
      CPUé…ç½®
        max_parallel_workers
        max_parallel_workers_per_gather
        parallel_tuple_cost
        parallel_setup_cost
      I/Oé…ç½®
        random_page_cost
        seq_page_cost
        effective_io_concurrency
      WALé…ç½®
        wal_buffers
        checkpoint_timeout
        max_wal_size
        min_wal_size
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢é‡å†™
        å­æŸ¥è¯¢ä¼˜åŒ–
        JOINä¼˜åŒ–
        è°“è¯ä¸‹æ¨
        å¸¸é‡æŠ˜å 
      æ‰§è¡Œè®¡åˆ’
        EXPLAINåˆ†æ
        è®¡åˆ’ç¼“å­˜
        å‚æ•°åŒ–æŸ¥è¯¢
        å¹¶è¡ŒæŸ¥è¯¢
      ç»Ÿè®¡ä¿¡æ¯
        ANALYZE
        ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
        ç›´æ–¹å›¾
        ç›¸å…³æ€§ç»Ÿè®¡
    ç´¢å¼•ä¼˜åŒ–
      ç´¢å¼•ç±»å‹
        B-tree
        GIN
        GiST
        BRIN
      ç´¢å¼•ç­–ç•¥
        å•åˆ—ç´¢å¼•
        å¤šåˆ—ç´¢å¼•
        éƒ¨åˆ†ç´¢å¼•
        è¡¨è¾¾å¼ç´¢å¼•
      ç´¢å¼•ç»´æŠ¤
        ç´¢å¼•é‡å»º
        ç´¢å¼•åˆ†æ
        ç´¢å¼•ç›‘æ§
    æ¶æ„ä¼˜åŒ–
      åˆ†åŒºè¡¨
        èŒƒå›´åˆ†åŒº
        åˆ—è¡¨åˆ†åŒº
        å“ˆå¸Œåˆ†åŒº
      ç‰©åŒ–è§†å›¾
        ç‰©åŒ–è§†å›¾
        ç‰©åŒ–è§†å›¾åˆ·æ–°
        ç‰©åŒ–è§†å›¾ä¼˜åŒ–
      è¿æ¥æ± 
        PgBouncer
        è¿æ¥å¤ç”¨
        è¿æ¥ç®¡ç†
    ç¡¬ä»¶ä¼˜åŒ–
      CPUä¼˜åŒ–
        CPUæ ¸å¿ƒæ•°
        CPUé¢‘ç‡
        CPUç¼“å­˜
      å†…å­˜ä¼˜åŒ–
        å†…å­˜å¤§å°
        å†…å­˜ç±»å‹
        å†…å­˜é…ç½®
      I/Oä¼˜åŒ–
        SSDä½¿ç”¨
        I/Oè°ƒåº¦
        RAIDé…ç½®
      ç½‘ç»œä¼˜åŒ–
        ç½‘ç»œå¸¦å®½
        ç½‘ç»œå»¶è¿Ÿ
        ç½‘ç»œé…ç½®
```

### 2.2 æ€§èƒ½è°ƒä¼˜æµç¨‹

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B[æ€§èƒ½åˆ†æ]
    B --> C{é—®é¢˜ç±»å‹?}
    C -->|é…ç½®é—®é¢˜| D[é…ç½®è°ƒä¼˜]
    C -->|æŸ¥è¯¢é—®é¢˜| E[æŸ¥è¯¢ä¼˜åŒ–]
    C -->|ç´¢å¼•é—®é¢˜| F[ç´¢å¼•ä¼˜åŒ–]
    C -->|æ¶æ„é—®é¢˜| G[æ¶æ„ä¼˜åŒ–]
    C -->|ç¡¬ä»¶é—®é¢˜| H[ç¡¬ä»¶ä¼˜åŒ–]
    D --> I[æ€§èƒ½æµ‹è¯•]
    E --> I
    F --> I
    G --> I
    H --> I
    I --> J{æ€§èƒ½è¾¾æ ‡?}
    J -->|å¦| B
    J -->|æ˜¯| K[è°ƒä¼˜å®Œæˆ]
```

## 3. è°ƒä¼˜ç­–ç•¥è¯¦è§£

### 3.1 é…ç½®è°ƒä¼˜ç­–ç•¥

**å…³é”®é…ç½®å‚æ•°**:

| å‚æ•° | é»˜è®¤å€¼ | æ¨èå€¼ | è¯´æ˜ | å½±å“ |
|------|--------|--------|------|------|
| **shared_buffers** | 128MB | 25%å†…å­˜ | å…±äº«ç¼“å†²åŒº | **+30%** |
| **work_mem** | 4MB | 64-256MB | å·¥ä½œå†…å­˜ | **+25%** |
| **maintenance_work_mem** | 64MB | 1-2GB | ç»´æŠ¤å†…å­˜ | **+40%** |
| **effective_cache_size** | 4GB | 50-75%å†…å­˜ | æœ‰æ•ˆç¼“å­˜ | **+20%** |
| **max_parallel_workers** | 8 | CPUæ ¸å¿ƒæ•° | å¹¶è¡Œå·¥ä½œè¿›ç¨‹ | **+50%** |
| **random_page_cost** | 4.0 | 1.1-2.0 | éšæœºé¡µæˆæœ¬ | **+15%** |
| **checkpoint_timeout** | 5min | 15min | æ£€æŸ¥ç‚¹è¶…æ—¶ | **+10%** |
| **max_wal_size** | 1GB | 4-8GB | æœ€å¤§WALå¤§å° | **+10%** |

**é…ç½®è°ƒä¼˜ç¤ºä¾‹**:

```sql
-- 1. å†…å­˜é…ç½®ï¼ˆ8GBå†…å­˜æœåŠ¡å™¨ï¼‰
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET work_mem = '256MB';
ALTER SYSTEM SET maintenance_work_mem = '1GB';
ALTER SYSTEM SET effective_cache_size = '6GB';

-- 2. CPUé…ç½®ï¼ˆ16æ ¸å¿ƒï¼‰
ALTER SYSTEM SET max_parallel_workers = 16;
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET parallel_tuple_cost = 0.01;
ALTER SYSTEM SET parallel_setup_cost = 1000;

-- 3. I/Oé…ç½®ï¼ˆSSDï¼‰
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET seq_page_cost = 1.0;
ALTER SYSTEM SET effective_io_concurrency = 200;

-- 4. WALé…ç½®
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET checkpoint_timeout = '15min';
ALTER SYSTEM SET max_wal_size = '4GB';
ALTER SYSTEM SET min_wal_size = '1GB';

-- 5. é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

### 3.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**:

| ä¼˜åŒ–æŠ€å·§ | è¯´æ˜ | æ€§èƒ½æå‡ | æ¨èåº¦ |
|---------|------|---------|--------|
| **é¿å…SELECT *** | åªé€‰æ‹©éœ€è¦çš„åˆ— | **1.5-3x** | â­â­â­â­â­ |
| **ä½¿ç”¨ç´¢å¼•** | ä¸ºWHEREæ¡ä»¶åˆ›å»ºç´¢å¼• | **10-100x** | â­â­â­â­â­ |
| **ä½¿ç”¨EXISTS** | æ›¿ä»£INå­æŸ¥è¯¢ | **2-10x** | â­â­â­â­ |
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡INSERT/UPDATE | **10-100x** | â­â­â­â­â­ |
| **ä½¿ç”¨LIMIT** | é™åˆ¶è¿”å›è¡Œæ•° | **10-1000x** | â­â­â­â­â­ |
| **é¿å…å‡½æ•°è°ƒç”¨** | é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•° | **2-5x** | â­â­â­â­ |

**æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- 1. é¿å…SELECT *
-- ä¼˜åŒ–å‰
SELECT * FROM users WHERE email = 'user@example.com';

-- ä¼˜åŒ–å
SELECT id, name, email FROM users WHERE email = 'user@example.com';

-- 2. ä½¿ç”¨EXISTSæ›¿ä»£IN
-- ä¼˜åŒ–å‰
SELECT * FROM orders WHERE user_id IN (SELECT id FROM users WHERE status = 'active');

-- ä¼˜åŒ–å
SELECT * FROM orders o
WHERE EXISTS (SELECT 1 FROM users u WHERE u.id = o.user_id AND u.status = 'active');

-- 3. æ‰¹é‡æ“ä½œ
-- ä¼˜åŒ–å‰ï¼ˆå¾ªç¯æ’å…¥ï¼‰
FOR i IN 1..1000 LOOP
    INSERT INTO orders (user_id, total_amount) VALUES (i, 100);
END LOOP;

-- ä¼˜åŒ–åï¼ˆæ‰¹é‡æ’å…¥ï¼‰
INSERT INTO orders (user_id, total_amount)
SELECT generate_series(1, 1000), 100;

-- 4. ä½¿ç”¨LIMIT
-- ä¼˜åŒ–å‰
SELECT * FROM orders ORDER BY created_at DESC;

-- ä¼˜åŒ–å
SELECT * FROM orders ORDER BY created_at DESC LIMIT 20;
```

### 3.3 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**ç´¢å¼•ä¼˜åŒ–åŸåˆ™**:

1. **ä¸ºWHEREæ¡ä»¶åˆ›å»ºç´¢å¼•**: ä¸ºç»å¸¸åœ¨WHEREä¸­ä½¿ç”¨çš„å­—æ®µåˆ›å»ºç´¢å¼•
2. **ä¸ºJOINå­—æ®µåˆ›å»ºç´¢å¼•**: ä¸ºç»å¸¸JOINçš„å­—æ®µåˆ›å»ºç´¢å¼•
3. **ä¸ºORDER BYåˆ›å»ºç´¢å¼•**: ä¸ºç»å¸¸æ’åºçš„å­—æ®µåˆ›å»ºç´¢å¼•
4. **ä½¿ç”¨å¤åˆç´¢å¼•**: ä¸ºå¤šå­—æ®µæŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
5. **ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•**: ä¸ºæ¡ä»¶æŸ¥è¯¢åˆ›å»ºéƒ¨åˆ†ç´¢å¼•

**ç´¢å¼•ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- 1. ä¸ºWHEREæ¡ä»¶åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);

-- 2. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at);

-- 3. åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆæ¡ä»¶ç´¢å¼•ï¼‰
CREATE INDEX idx_orders_active ON orders(user_id)
WHERE status = 'active';

-- 4. åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users(LOWER(email));

-- 5. åˆ›å»ºè¦†ç›–ç´¢å¼•ï¼ˆINCLUDEï¼‰
CREATE INDEX idx_orders_user_cover ON orders(user_id)
INCLUDE (total_amount, created_at);
```

### 3.4 æ¶æ„ä¼˜åŒ–ç­–ç•¥

**æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ**:

| ä¼˜åŒ–æ–¹æ¡ˆ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½æå‡ |
|---------|------|---------|---------|
| **åˆ†åŒºè¡¨** | è¡¨åˆ†åŒº | å¤§è¡¨æŸ¥è¯¢ | **2-10x** |
| **ç‰©åŒ–è§†å›¾** | é¢„è®¡ç®—è§†å›¾ | å¤æ‚æŸ¥è¯¢ | **10-100x** |
| **è¿æ¥æ± ** | è¿æ¥å¤ç”¨ | é«˜å¹¶å‘ | **+50%** |
| **è¯»å†™åˆ†ç¦»** | ä¸»ä»å¤åˆ¶ | è¯»å¤šå†™å°‘ | **+100%** |

**æ¶æ„ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE orders (
    id SERIAL,
    user_id INTEGER,
    total_amount DECIMAL(10, 2),
    created_at TIMESTAMPTZ NOT NULL
) PARTITION BY RANGE (created_at);

CREATE TABLE orders_2025_01 PARTITION OF orders
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
CREATE TABLE orders_2025_02 PARTITION OF orders
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- 2. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_order_summary AS
SELECT
    DATE_TRUNC('month', created_at) AS month,
    user_id,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_revenue
FROM orders
GROUP BY DATE_TRUNC('month', created_at), user_id;

CREATE UNIQUE INDEX ON mv_order_summary (month, user_id);

-- 3. åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_order_summary;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æ€§èƒ½ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ã€‚

**é—®é¢˜åˆ†æ**:

1. **æŸ¥è¯¢æ…¢**: å•†å“æœç´¢æŸ¥è¯¢è€—æ—¶5ç§’
2. **å¹¶å‘ä½**: å¹¶å‘å¤„ç†èƒ½åŠ›ä½
3. **èµ„æºæµªè´¹**: èµ„æºä½¿ç”¨ä¸åˆç†

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. é…ç½®ä¼˜åŒ–
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET work_mem = '256MB';
ALTER SYSTEM SET max_parallel_workers = 16;
ALTER SYSTEM SET random_page_cost = 1.1;

-- 2. ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_products_title_gin ON products
USING GIN(to_tsvector('chinese', title));
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_status ON products(status)
WHERE status = 'active';

-- 3. æŸ¥è¯¢ä¼˜åŒ–
-- ä¼˜åŒ–å‰
SELECT * FROM products
WHERE title LIKE '%keyword%' OR description LIKE '%keyword%'
ORDER BY created_at DESC;

-- ä¼˜åŒ–å
SELECT
    id,
    title,
    price,
    category
FROM products
WHERE to_tsvector('chinese', title || ' ' || description) @@ to_tsquery('chinese', 'keyword')
  AND status = 'active'
ORDER BY created_at DESC
LIMIT 20;

-- 4. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_product_stats AS
SELECT
    category,
    COUNT(*) AS product_count,
    AVG(price) AS avg_price,
    MAX(price) AS max_price,
    MIN(price) AS min_price
FROM products
WHERE status = 'active'
GROUP BY category;

CREATE UNIQUE INDEX ON mv_product_stats (category);
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 5 ç§’ | **< 200ms** | **96%** â¬‡ï¸ |
| **å¹¶å‘èƒ½åŠ›** | 100 TPS | **500 TPS** | **400%** â¬†ï¸ |
| **CPUä½¿ç”¨ç‡** | 80% | **< 40%** | **50%** â¬‡ï¸ |
| **å†…å­˜ä½¿ç”¨** | 4GB | **< 2GB** | **50%** â¬‡ï¸ |

### 4.2 æ¡ˆä¾‹: æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸæ•°æ®åˆ†æç³»ç»Ÿéœ€è¦ä¼˜åŒ–å¤æ‚åˆ†ææŸ¥è¯¢ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE sales_data (
    id SERIAL,
    product_id INTEGER,
    sale_date DATE NOT NULL,
    amount DECIMAL(10, 2),
    quantity INTEGER
) PARTITION BY RANGE (sale_date);

CREATE TABLE sales_data_2024 PARTITION OF sales_data
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
CREATE TABLE sales_data_2025 PARTITION OF sales_data
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- 2. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_sales_summary AS
SELECT
    DATE_TRUNC('month', sale_date) AS month,
    product_id,
    SUM(amount) AS total_amount,
    SUM(quantity) AS total_quantity,
    AVG(amount) AS avg_amount
FROM sales_data
GROUP BY DATE_TRUNC('month', sale_date), product_id;

CREATE UNIQUE INDEX ON mv_sales_summary (month, product_id);

-- 3. åˆ›å»ºåˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_sales_summary()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_summary;
END;
$$ LANGUAGE plpgsql;

-- 4. å®šæ—¶åˆ·æ–°ï¼ˆä½¿ç”¨pg_cronï¼‰
SELECT cron.schedule('refresh-sales-summary', '0 2 * * *', 'SELECT refresh_sales_summary();');
```

## 5. æœ€ä½³å®è·µ

### 5.1 è°ƒä¼˜åŸåˆ™

1. **æµ‹é‡ä¼˜å…ˆ**: å…ˆæµ‹é‡å†ä¼˜åŒ–
2. **æ¸è¿›ä¼˜åŒ–**: æ¸è¿›å¼ä¼˜åŒ–
3. **å…¨é¢è€ƒè™‘**: è€ƒè™‘æ‰€æœ‰å› ç´ 
4. **æŒç»­ç›‘æ§**: æŒç»­ç›‘æ§æ€§èƒ½

### 5.2 è°ƒä¼˜å»ºè®®

1. **é…ç½®è°ƒä¼˜**: æ ¹æ®ç¡¬ä»¶é…ç½®è°ƒæ•´å‚æ•°
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æ…¢æŸ¥è¯¢
3. **ç´¢å¼•ä¼˜åŒ–**: åˆ›å»ºåˆé€‚çš„ç´¢å¼•
4. **æ¶æ„ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“æ¶æ„

## 6. å‚è€ƒèµ„æ–™

- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](./æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»è¯¦è§£](./æŸ¥è¯¢ä¼˜åŒ–ä½“ç³»è¯¦è§£.md)
- [ç´¢å¼•ä½“ç³»è¯¦è§£](./ç´¢å¼•ä½“ç³»è¯¦è§£.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½ä¼˜åŒ–](https://www.postgresql.org/docs/current/performance-tips.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-59
