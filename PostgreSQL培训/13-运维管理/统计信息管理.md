# PostgreSQL ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-30

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#postgresql-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°](#10-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#14-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. ç»Ÿè®¡ä¿¡æ¯åŸºç¡€](#2-ç»Ÿè®¡ä¿¡æ¯åŸºç¡€)
    - [2.1 ç»Ÿè®¡ä¿¡æ¯ç±»å‹](#21-ç»Ÿè®¡ä¿¡æ¯ç±»å‹)
    - [2.2 æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯](#22-æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯)
  - [3. ANALYZE æ“ä½œ](#3-analyze-æ“ä½œ)
    - [3.1 ANALYZE åŸºç¡€](#31-analyze-åŸºç¡€)
    - [3.2 è‡ªåŠ¨ ANALYZE](#32-è‡ªåŠ¨-analyze)
    - [3.3 ANALYZE ä¼˜åŒ–](#33-analyze-ä¼˜åŒ–)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#51-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 ç»Ÿè®¡ä¿¡æ¯åŸºç¡€å¸¸è§é—®é¢˜](#61-ç»Ÿè®¡ä¿¡æ¯åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒANALYZEï¼Ÿ](#q1-ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ‰§è¡Œanalyze)
      - [Q2: å¦‚ä½•ä¼˜åŒ–ANALYZEæ€§èƒ½ï¼Ÿ](#q2-å¦‚ä½•ä¼˜åŒ–analyzeæ€§èƒ½)
    - [6.2 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å¸¸è§é—®é¢˜](#62-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å¸¸è§é—®é¢˜)
      - [Q3: ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´æŸ¥è¯¢è®¡åˆ’å·®æ€ä¹ˆåŠï¼Ÿ](#q3-ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´æŸ¥è¯¢è®¡åˆ’å·®æ€ä¹ˆåŠ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
      - [âœ… ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å»ºè®®](#-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å»ºè®®)
      - [âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ ç»Ÿè®¡ä¿¡æ¯ç®¡ç†åæ¨¡å¼](#-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†åæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°

**ç»Ÿè®¡ä¿¡æ¯å·¥ä½œåŸç†**ï¼š

PostgreSQL ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å™¨è‡ªåŠ¨æ”¶é›†è¡¨å’Œç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ç³»ç»Ÿç›®å½•ä¸­ï¼Œä¾›æŸ¥è¯¢ä¼˜åŒ–å™¨ä½¿ç”¨ã€‚ç»Ÿè®¡ä¿¡æ¯çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**ï¼šANALYZEå‘½ä»¤æ”¶é›†è¡¨å’Œç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯
2. **ç»Ÿè®¡ä¿¡æ¯å­˜å‚¨**ï¼šç»Ÿè®¡ä¿¡æ¯å­˜å‚¨åœ¨pg_statisticç³»ç»Ÿç›®å½•ä¸­
3. **ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨**ï¼šæŸ¥è¯¢ä¼˜åŒ–å™¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆæœ€ä¼˜æŸ¥è¯¢è®¡åˆ’
4. **è‡ªåŠ¨æ›´æ–°**ï¼šè‡ªåŠ¨ANALYZEå®ˆæŠ¤è¿›ç¨‹å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯

**ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ‰§è¡ŒANALYZE] --> B[æ‰«æè¡¨é¡µé¢]
    B --> C[é‡‡æ ·æ•°æ®]
    C --> D[è®¡ç®—ç»Ÿè®¡ä¿¡æ¯]
    D --> E{ç»Ÿè®¡ä¿¡æ¯ç±»å‹}
    E -->|è¡¨ç»Ÿè®¡| F[è¡Œæ•°ã€å¤§å°ã€æ­»å…ƒç»„]
    E -->|åˆ—ç»Ÿè®¡| G[å”¯ä¸€å€¼ã€æœ€å¸¸è§å€¼ã€ç›´æ–¹å›¾]
    E -->|ç´¢å¼•ç»Ÿè®¡| H[ç´¢å¼•ä½¿ç”¨ã€ç´¢å¼•å¤§å°]
    F --> I[æ›´æ–°pg_statistic]
    G --> I
    H --> I
    I --> J[å®ŒæˆANALYZE]

    style A fill:#FFD700
    style D fill:#90EE90
    style J fill:#87CEEB
```

**æŸ¥è¯¢ä¼˜åŒ–å™¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢è¯·æ±‚] --> B[æŸ¥è¯¢ä¼˜åŒ–å™¨]
    B --> C[è¯»å–ç»Ÿè®¡ä¿¡æ¯]
    C --> D{ç»Ÿè®¡ä¿¡æ¯ç±»å‹}
    D -->|è¡¨ç»Ÿè®¡| E[ä¼°ç®—è¡¨å¤§å°]
    D -->|åˆ—ç»Ÿè®¡| F[ä¼°ç®—é€‰æ‹©ç‡]
    D -->|ç´¢å¼•ç»Ÿè®¡| G[ä¼°ç®—ç´¢å¼•æˆæœ¬]
    E --> H[ç”ŸæˆæŸ¥è¯¢è®¡åˆ’]
    F --> H
    G --> H
    H --> I[æ‰§è¡ŒæŸ¥è¯¢]

    style A fill:#FFD700
    style C fill:#90EE90
    style I fill:#87CEEB
```

**è‡ªåŠ¨ANALYZEè§¦å‘æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[è‡ªåŠ¨ANALYZEå®ˆæŠ¤è¿›ç¨‹] --> B[æ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯]
    B --> C{ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ?}
    C -->|å¦| D[ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥]
    C -->|æ˜¯| E[è®¡ç®—ANALYZEæˆæœ¬]
    E --> F{æˆæœ¬å¯æ¥å—?}
    F -->|å¦| G[å»¶è¿Ÿæ‰§è¡Œ]
    F -->|æ˜¯| H[æ‰§è¡ŒANALYZE]
    H --> I[æ›´æ–°ç»Ÿè®¡ä¿¡æ¯]
    I --> D
    G --> D
    D --> B

    style A fill:#FFD700
    style H fill:#90EE90
    style I fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç»Ÿè®¡ä¿¡æ¯ç®¡ç†çš„ä»·å€¼**:

PostgreSQL ç»Ÿè®¡ä¿¡æ¯æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨çš„é‡è¦ä¾æ®ï¼š

1. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–å™¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯é€‰æ‹©æœ€ä¼˜è®¡åˆ’
2. **æ€§èƒ½æå‡**: å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯æå‡æŸ¥è¯¢æ€§èƒ½
3. **ç´¢å¼•é€‰æ‹©**: å¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä½³ç´¢å¼•
4. **è¿æ¥é¡ºåº**: ä¼˜åŒ–è¿æ¥é¡ºåº

**åº”ç”¨åœºæ™¯**:

- **æŸ¥è¯¢ä¼˜åŒ–**: æå‡æŸ¥è¯¢æ€§èƒ½
- **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–ç´¢å¼•ä½¿ç”¨
- **æ€§èƒ½è°ƒä¼˜**: æ€§èƒ½è°ƒä¼˜çš„åŸºç¡€
- **è‡ªåŠ¨ä¼˜åŒ–**: æ”¯æŒè‡ªåŠ¨ä¼˜åŒ–

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æŸ¥è¯¢æ€§èƒ½** | å‡†ç¡®ç»Ÿè®¡ä¿¡æ¯æå‡æ€§èƒ½ | **2-10x** |
| **è®¡åˆ’è´¨é‡** | ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’ | **+50%** |
| **ç´¢å¼•ä½¿ç”¨** | ä¼˜åŒ–ç´¢å¼•ä½¿ç”¨ | **+40%** |
| **è‡ªåŠ¨ä¼˜åŒ–** | æ”¯æŒè‡ªåŠ¨ä¼˜åŒ– | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æŸ¥è¯¢æ€§èƒ½**: å‡†ç¡®ç»Ÿè®¡ä¿¡æ¯æå‡æŸ¥è¯¢æ€§èƒ½ 2-10 å€
- **è®¡åˆ’è´¨é‡**: ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’ï¼Œæå‡è´¨é‡ 50%
- **ç´¢å¼•ä½¿ç”¨**: ä¼˜åŒ–ç´¢å¼•ä½¿ç”¨ï¼Œæå‡ä½¿ç”¨ç‡ 40%
- **è‡ªåŠ¨ä¼˜åŒ–**: æ”¯æŒè‡ªåŠ¨ä¼˜åŒ–ï¼Œå‡å°‘äººå·¥å¹²é¢„

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡ç»Ÿè®¡ä¿¡æ¯çš„ä½œç”¨å’Œé‡è¦æ€§
- ç†è§£ ANALYZE æ“ä½œ
- å­¦ä¼šç»Ÿè®¡ä¿¡æ¯ç®¡ç†
- æŒæ¡å®é™…åº”ç”¨åœºæ™¯

### 1.4 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç»Ÿè®¡ä¿¡æ¯ç®¡ç†))
    ç»Ÿè®¡ä¿¡æ¯ç±»å‹
      è¡¨ç»Ÿè®¡
        è¡Œæ•°ç»Ÿè®¡
        è¡¨å¤§å°
        æ­»å…ƒç»„æ•°
      åˆ—ç»Ÿè®¡
        å”¯ä¸€å€¼æ•°
        æœ€å¸¸è§å€¼
        ç›´æ–¹å›¾
        ç›¸å…³æ€§
      ç´¢å¼•ç»Ÿè®¡
        ç´¢å¼•ä½¿ç”¨
        ç´¢å¼•å¤§å°
        ç´¢å¼•æ‰«æ
    ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
      ANALYZE
        æ‰‹åŠ¨åˆ†æ
        è‡ªåŠ¨åˆ†æ
        éƒ¨åˆ†åˆ†æ
      ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
        å¢é‡æ›´æ–°
        å…¨é‡æ›´æ–°
        å®šæ—¶æ›´æ–°
      ç»Ÿè®¡ä¿¡æ¯é…ç½®
        é‡‡æ ·ç‡
        ç»Ÿè®¡ç›®æ ‡
        è‡ªåŠ¨åˆ†æ
    ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨
      æŸ¥è¯¢ä¼˜åŒ–
        è®¡åˆ’é€‰æ‹©
        æˆæœ¬ä¼°ç®—
        ç´¢å¼•é€‰æ‹©
      æ€§èƒ½ä¼˜åŒ–
        ä¼˜åŒ–å™¨å†³ç­–
        è¿æ¥é¡ºåº
        èšåˆä¼˜åŒ–
    ç»Ÿè®¡ä¿¡æ¯ç®¡ç†
      ç»Ÿè®¡ä¿¡æ¯æŸ¥çœ‹
        è¡¨ç»Ÿè®¡
        åˆ—ç»Ÿè®¡
        ç´¢å¼•ç»Ÿè®¡
      ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤
        å®šæœŸæ›´æ–°
        ç›‘æ§ç»Ÿè®¡
        ä¼˜åŒ–é…ç½®
```

## 2. ç»Ÿè®¡ä¿¡æ¯åŸºç¡€

### 2.1 ç»Ÿè®¡ä¿¡æ¯ç±»å‹

**PostgreSQL ç»Ÿè®¡ä¿¡æ¯**:

1. **è¡¨ç»Ÿè®¡**: è¡¨çš„è¡Œæ•°ã€å¤§å°ç­‰
2. **åˆ—ç»Ÿè®¡**: åˆ—çš„åˆ†å¸ƒã€å”¯ä¸€å€¼ç­‰
3. **ç´¢å¼•ç»Ÿè®¡**: ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ
4. **ç³»ç»Ÿç»Ÿè®¡**: ç³»ç»Ÿçº§åˆ«çš„ç»Ÿè®¡

### 2.2 æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

**æŸ¥çœ‹è¡¨ç»Ÿè®¡**:

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'users';
```

**æŸ¥çœ‹åˆ—ç»Ÿè®¡**:

```sql
-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯
SELECT
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs
FROM pg_stats
WHERE tablename = 'users';
```

## 3. ANALYZE æ“ä½œ

### 3.1 ANALYZE åŸºç¡€

**æ‰‹åŠ¨ ANALYZE**:

```sql
-- åˆ†æå•ä¸ªè¡¨
ANALYZE users;

-- åˆ†ææ‰€æœ‰è¡¨
ANALYZE;

-- åˆ†æç‰¹å®šåˆ—
ANALYZE users (id, name);
```

### 3.2 è‡ªåŠ¨ ANALYZE

**è‡ªåŠ¨ ANALYZE é…ç½®** (postgresql.conf):

```conf
# å¯ç”¨è‡ªåŠ¨ ANALYZE
autovacuum = on

# è‡ªåŠ¨ ANALYZE é˜ˆå€¼
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# è‡ªåŠ¨ ANALYZE å»¶è¿Ÿ
autovacuum_analyze_delay = 0.2
```

### 3.3 ANALYZE ä¼˜åŒ–

**ANALYZE æœ€ä½³å®è·µ**:

```sql
-- 1. å®šæœŸ ANALYZE
-- æ¯å¤©æ‰§è¡Œä¸€æ¬¡
ANALYZE VERBOSE;

-- 2. å¤§è¡¨ ANALYZE
-- å¯¹å¤§è¡¨ä½¿ç”¨é‡‡æ ·
ANALYZE users (id, name) WITH (sample_percent = 10);

-- 3. ç›‘æ§ ANALYZE è¿›åº¦
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%ANALYZE%';
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸåº”ç”¨æŸ¥è¯¢æ€§èƒ½å·®ï¼Œä¼˜åŒ–å™¨é€‰æ‹©äº†é”™è¯¯çš„æŸ¥è¯¢è®¡åˆ’ã€‚

**é—®é¢˜åˆ†æ**:

1. **ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ**: ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
2. **æŸ¥è¯¢è®¡åˆ’å·®**: ä¼˜åŒ–å™¨é€‰æ‹©é”™è¯¯è®¡åˆ’
3. **æ€§èƒ½é—®é¢˜**: æŸ¥è¯¢æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
SELECT
    tablename,
    last_analyze,
    n_live_tup
FROM pg_stat_user_tables
WHERE tablename = 'orders';

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE VERBOSE orders;

-- 3. éªŒè¯æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 123
ORDER BY created_at DESC
LIMIT 10;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 2 ç§’ | **200ms** | **90%** â¬‡ï¸ |
| **è®¡åˆ’è´¨é‡** | å·® | **ä¼˜** | **æå‡** |
| **ç´¢å¼•ä½¿ç”¨** | 50% | **90%** | **80%** â¬†ï¸ |

## 5. æœ€ä½³å®è·µ

### 5.1 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

1. **å®šæœŸ ANALYZE**: å®šæœŸæ‰§è¡Œ ANALYZE
2. **ç›‘æ§**: ç›‘æ§ç»Ÿè®¡ä¿¡æ¯çŠ¶æ€
3. **è°ƒä¼˜**: æ ¹æ®å®é™…æƒ…å†µè°ƒä¼˜

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **åŠæ—¶æ›´æ–°**: æ•°æ®å˜åŒ–ååŠæ—¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
2. **é‡‡æ ·**: å¤§è¡¨ä½¿ç”¨é‡‡æ · ANALYZE
3. **ç›‘æ§**: ç›‘æ§ ANALYZE æ€§èƒ½å½±å“

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 ç»Ÿè®¡ä¿¡æ¯åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒANALYZEï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒANALYZEï¼Œä»€ä¹ˆæ—¶å€™ä¾èµ–è‡ªåŠ¨ANALYZEã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´
SELECT
    schemaname,
    relname,
    last_analyze,
    last_autoanalyze,
    n_live_tup,
    n_mod_since_analyze
FROM pg_stat_user_tables
WHERE relname = 'your_table';

-- 2. æ£€æŸ¥æ•°æ®å˜æ›´é‡
SELECT
    n_mod_since_analyze,
    n_live_tup,
    ROUND(n_mod_since_analyze::numeric / NULLIF(n_live_tup, 0) * 100, 2) AS change_ratio
FROM pg_stat_user_tables
WHERE relname = 'your_table';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¤§é‡æ•°æ®å˜æ›´åç«‹å³ANALYZE
-- å˜æ›´é‡ > 10% æ—¶å»ºè®®æ‰‹åŠ¨ANALYZE
INSERT INTO large_table SELECT * FROM source_table;
ANALYZE large_table;

-- 2. æ‰¹é‡å¯¼å…¥åç«‹å³ANALYZE
COPY large_table FROM '/path/to/data.csv' WITH CSV;
ANALYZE large_table;

-- 3. å®šæœŸç»´æŠ¤ï¼ˆä½å³°æœŸï¼‰
ANALYZE VERBOSE;
-- å¯¹æ‰€æœ‰è¡¨æ‰§è¡ŒANALYZE
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ANALYZEï¼šæŸ¥è¯¢è®¡åˆ’å·®ï¼ŒæŸ¥è¯¢æ—¶é—´ **10ç§’**
- æœ‰ANALYZEï¼šæŸ¥è¯¢è®¡åˆ’ä¼˜ï¼ŒæŸ¥è¯¢æ—¶é—´ **0.1ç§’**
- **æ€§èƒ½æå‡ï¼š100å€**

#### Q2: å¦‚ä½•ä¼˜åŒ–ANALYZEæ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šANALYZEæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ANALYZEè¿›åº¦
SELECT * FROM pg_stat_progress_analyze;

-- 2. æ£€æŸ¥è¡¨å¤§å°
SELECT pg_size_pretty(pg_total_relation_size('large_table'));
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨é‡‡æ ·ANALYZEï¼ˆå¤§è¡¨ï¼‰
ANALYZE large_table (column1, column2) WITH (sample_percent = 10);
-- åªåˆ†æ10%çš„æ•°æ®ï¼Œé€Ÿåº¦æå‡10å€

-- 2. è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
ALTER TABLE large_table ALTER COLUMN important_column SET STATISTICS 500;
ANALYZE large_table;
-- å¢åŠ é‡‡æ ·ç‡ï¼Œæå‡ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§

-- 3. è¡¨çº§è‡ªåŠ¨ANALYZEé…ç½®
ALTER TABLE large_table SET (
    autovacuum_analyze_scale_factor = 0.05,
    autovacuum_analyze_threshold = 10000
);
-- é™ä½è§¦å‘é˜ˆå€¼ï¼Œæ›´é¢‘ç¹è‡ªåŠ¨ANALYZE
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- å…¨é‡ANALYZEï¼šæ‰§è¡Œæ—¶é—´ **30åˆ†é’Ÿ**
- é‡‡æ ·ANALYZEï¼šæ‰§è¡Œæ—¶é—´ **3åˆ†é’Ÿ**
- **æ€§èƒ½æå‡ï¼š10å€**

### 6.2 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å¸¸è§é—®é¢˜

#### Q3: ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´æŸ¥è¯¢è®¡åˆ’å·®æ€ä¹ˆåŠï¼Ÿ

**é—®é¢˜æè¿°**ï¼šç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œä¼˜åŒ–å™¨é€‰æ‹©äº†é”™è¯¯çš„æŸ¥è¯¢è®¡åˆ’ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
SELECT
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals
FROM pg_stats
WHERE tablename = 'your_table' AND attname = 'your_column';

-- 2. åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM your_table WHERE your_column = 'value';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE VERBOSE your_table;

-- 2. å¢åŠ ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
ALTER TABLE your_table ALTER COLUMN your_column SET STATISTICS 500;
ANALYZE your_table;

-- 3. åˆ›å»ºæ‰©å±•ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¤šåˆ—ç›¸å…³æ€§ï¼‰
CREATE STATISTICS your_stats ON column1, column2 FROM your_table;
ANALYZE your_table;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼šæŸ¥è¯¢è®¡åˆ’å·®ï¼ŒæŸ¥è¯¢æ—¶é—´ **10ç§’**
- ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®ï¼šæŸ¥è¯¢è®¡åˆ’ä¼˜ï¼ŒæŸ¥è¯¢æ—¶é—´ **0.1ç§’**
- **æ€§èƒ½æå‡ï¼š100å€**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… ç»Ÿè®¡ä¿¡æ¯ç®¡ç†å»ºè®®

1. **ä¾èµ–è‡ªåŠ¨ANALYZE**ï¼š

   ```sql
   -- âœ… å¥½ï¼šé…ç½®åˆç†çš„è‡ªåŠ¨ANALYZEå‚æ•°
   -- postgresql.conf:
   autovacuum = on
   autovacuum_analyze_threshold = 50
   autovacuum_analyze_scale_factor = 0.1
   ```

2. **å®šæœŸæ‰‹åŠ¨ANALYZE**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå¯¹é«˜æ›´æ–°é¢‘ç‡çš„è¡¨å®šæœŸæ‰‹åŠ¨ANALYZE
   ANALYZE orders;
   ANALYZE users;
   ```

3. **ç›‘æ§ç»Ÿè®¡ä¿¡æ¯**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸæ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´
   SELECT
       schemaname,
       tablename,
       last_analyze,
       last_autoanalyze,
       n_mod_since_analyze
   FROM pg_stat_user_tables
   WHERE n_mod_since_analyze > 1000
   ORDER BY n_mod_since_analyze DESC;
   ```

#### âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ANALYZEæ€§èƒ½ä¼˜åŒ–**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨é‡‡æ ·åˆ†æå¤§è¡¨
   ANALYZE orders;  -- è‡ªåŠ¨é‡‡æ ·

   -- âœ… å¥½ï¼šé…ç½®åˆç†çš„ç»Ÿè®¡ç›®æ ‡
   ALTER TABLE orders ALTER COLUMN user_id SET STATISTICS 1000;
   ```

2. **ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå¯¹å…³é”®åˆ—è®¾ç½®æ›´é«˜çš„ç»Ÿè®¡ç›®æ ‡
   ALTER TABLE orders ALTER COLUMN created_at SET STATISTICS 1000;
   ```

### 7.2 é¿å…åšæ³•

#### âŒ ç»Ÿè®¡ä¿¡æ¯ç®¡ç†åæ¨¡å¼

1. **ç¦ç”¨è‡ªåŠ¨ANALYZE**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šç¦ç”¨è‡ªåŠ¨ANALYZE
   -- autovacuum = off  -- ç»Ÿè®¡ä¿¡æ¯ä¼šè¿‡æœŸ

   -- âœ… å¥½ï¼šå¯ç”¨å¹¶é…ç½®è‡ªåŠ¨ANALYZE
   autovacuum = on
   ```

2. **å¿½ç•¥ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šä¸æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯¼è‡´æŸ¥è¯¢è®¡åˆ’å·®
   -- ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸä¼šå¯¼è‡´ä¼˜åŒ–å™¨é€‰æ‹©é”™è¯¯çš„è®¡åˆ’

   -- âœ… å¥½ï¼šå®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   ANALYZE orders;
   ```

3. **ç»Ÿè®¡ç›®æ ‡è®¾ç½®è¿‡ä½**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šç»Ÿè®¡ç›®æ ‡è®¾ç½®è¿‡ä½ï¼Œç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®
   ALTER TABLE orders ALTER COLUMN user_id SET STATISTICS 10;

   -- âœ… å¥½ï¼šè®¾ç½®åˆç†çš„ç»Ÿè®¡ç›®æ ‡
   ALTER TABLE orders ALTER COLUMN user_id SET STATISTICS 1000;
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **ç»Ÿè®¡ä¿¡æ¯ç®¡ç†æ€§èƒ½ä¼˜åŒ–**ï¼š
   - é…ç½®åˆç†çš„è‡ªåŠ¨ANALYZEå‚æ•°ï¼Œå¹³è¡¡æ›´æ–°é¢‘ç‡å’Œæ€§èƒ½å½±å“
   - å¯¹é«˜æ›´æ–°é¢‘ç‡çš„è¡¨å®šæœŸæ‰‹åŠ¨ANALYZE
   - ä½¿ç”¨é‡‡æ ·åˆ†æå¤§è¡¨ï¼Œå‡å°‘ANALYZEæ—¶é—´

2. **æŸ¥è¯¢ä¼˜åŒ–å»ºè®®**ï¼š
   - ç¡®ä¿ç»Ÿè®¡ä¿¡æ¯åŠæ—¶æ›´æ–°ï¼Œä¼˜åŒ–å™¨æ‰èƒ½ç”Ÿæˆæœ€ä¼˜è®¡åˆ’
   - å¯¹å…³é”®åˆ—è®¾ç½®æ›´é«˜çš„ç»Ÿè®¡ç›®æ ‡ï¼Œæå‡ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§
   - å®šæœŸå®¡æŸ¥æŸ¥è¯¢è®¡åˆ’ï¼Œå‘ç°ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®çš„é—®é¢˜

3. **ç®¡ç†å»ºè®®**ï¼š
   - ç›‘æ§ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´ï¼ŒåŠæ—¶å‘ç°è¿‡æœŸç»Ÿè®¡ä¿¡æ¯
   - å»ºç«‹ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥ï¼Œç¡®ä¿å…³é”®è¡¨çš„ç»Ÿè®¡ä¿¡æ¯åŠæ—¶æ›´æ–°
   - å®šæœŸå®¡æŸ¥ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼Œä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ç­–ç•¥

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](https://www.postgresql.org/docs/current/planner-stats.html)**
  - ç»Ÿè®¡ä¿¡æ¯æ¦‚è¿°å’Œè¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ANALYZE](https://www.postgresql.org/docs/current/sql-analyze.html)**
  - ANALYZE è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è‡ªåŠ¨ANALYZE](https://www.postgresql.org/docs/current/runtime-config-autovacuum.html)**
  - è‡ªåŠ¨ANALYZEé…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æŸ¥è¯¢è§„åˆ’å™¨](https://www.postgresql.org/docs/current/planner-optimizer.html)**
  - æŸ¥è¯¢è§„åˆ’å™¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯è¯´æ˜

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Selinger, P. G., et al. (1979). "Access Path Selection in a Relational Database Management System."](https://dl.acm.org/doi/10.1145/582095.582099)**
  - æŸ¥è¯¢ä¼˜åŒ–å™¨çš„åŸºç¡€ç ”ç©¶ï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨æŸ¥è¯¢ä¼˜åŒ–ä¸­çš„åº”ç”¨

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Statistics: Best Practices](https://www.postgresql.org/docs/current/planner-stats.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šç»Ÿè®¡ä¿¡æ¯æœ€ä½³å®è·µ

- **[Understanding PostgreSQL Statistics](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-statistics)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL ç»Ÿè®¡ä¿¡æ¯

- **[PostgreSQL Statistics Optimization Tips](https://www.citusdata.com/blog/2017/10/25/statistics-optimization-in-postgresql/)**
  - Citus Data åšå®¢ï¼šç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL Statistics Guide](https://www.2ndquadrant.com/en/blog/postgresql-statistics-guide/)**
  - 2ndQuadrant åšå®¢ï¼šç»Ÿè®¡ä¿¡æ¯æŒ‡å—

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Statistics](https://wiki.postgresql.org/wiki/Statistics)**
  - PostgreSQL Wikiï¼šç»Ÿè®¡ä¿¡æ¯ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Statistics](https://stackoverflow.com/questions/tagged/postgresql+statistics)**
  - Stack Overflowï¼šPostgreSQL ç»Ÿè®¡ä¿¡æ¯ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šç»Ÿè®¡ä¿¡æ¯ç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [VACUUMä¸ç»´æŠ¤](../06-å­˜å‚¨ç®¡ç†/VACUUMä¸ç»´æŠ¤.md)
- [ç›‘æ§ä¸è¯Šæ–­](../10-ç›‘æ§è¯Šæ–­/ç›‘æ§ä¸è¯Šæ–­.md)
- [è¿ç»´ç®¡ç†ä½“ç³»è¯¦è§£](./è¿ç»´ç®¡ç†ä½“ç³»è¯¦è§£.md)

- [æŸ¥è¯¢è®¡åˆ’ä¸ä¼˜åŒ–å™¨](./æŸ¥è¯¢è®¡åˆ’ä¸ä¼˜åŒ–å™¨.md)
- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](./æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ANALYZE](https://www.postgresql.org/docs/current/sql-analyze.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-30
