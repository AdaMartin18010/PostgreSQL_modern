# PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-16

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å®¡è®¡åŠŸèƒ½è¿›è¡Œäº†é‡è¦å¢å¼ºï¼ŒåŒ…æ‹¬æ›´ç»†ç²’åº¦çš„å®¡è®¡æ§åˆ¶ã€æ€§èƒ½ä¼˜åŒ–çš„å®¡è®¡æ—¥å¿—ã€ä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•ã€å®æ—¶å®¡è®¡ç›‘æ§ç­‰æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®¡è®¡èƒ½åŠ›å’Œåˆè§„æ€§æ”¯æŒã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **ç»†ç²’åº¦å®¡è®¡**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå®¡è®¡æ—¥å¿—æ€§èƒ½æå‡ 50%
- **ä¸å¯ç¯¡æ”¹**ï¼šæ”¯æŒä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•
- **å®æ—¶ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
- **åˆè§„æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼º](#postgresql-18-å®¡è®¡åŠŸèƒ½å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°](#1-å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°)
    - [1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹](#11-postgresql-18-å¢å¼ºäº®ç‚¹)
    - [1.2 å®¡è®¡åŠŸèƒ½å¯¹æ¯”](#12-å®¡è®¡åŠŸèƒ½å¯¹æ¯”)
  - [2. ç»†ç²’åº¦å®¡è®¡æ§åˆ¶](#2-ç»†ç²’åº¦å®¡è®¡æ§åˆ¶)
    - [2.1 è¡¨çº§å®¡è®¡](#21-è¡¨çº§å®¡è®¡)
    - [2.2 åˆ—çº§å®¡è®¡](#22-åˆ—çº§å®¡è®¡)
    - [2.3 è¡Œçº§å®¡è®¡](#23-è¡Œçº§å®¡è®¡)
  - [3. å®¡è®¡æ—¥å¿—ä¼˜åŒ–](#3-å®¡è®¡æ—¥å¿—ä¼˜åŒ–)
    - [3.1 æ—¥å¿—æ ¼å¼ä¼˜åŒ–](#31-æ—¥å¿—æ ¼å¼ä¼˜åŒ–)
    - [3.2 æ—¥å¿—æ€§èƒ½ä¼˜åŒ–](#32-æ—¥å¿—æ€§èƒ½ä¼˜åŒ–)
    - [3.3 æ—¥å¿—å‹ç¼©](#33-æ—¥å¿—å‹ç¼©)
  - [4. ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•](#4-ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•)
    - [4.1 å®¡è®¡è®°å½•ç­¾å](#41-å®¡è®¡è®°å½•ç­¾å)
    - [4.2 å®¡è®¡è®°å½•éªŒè¯](#42-å®¡è®¡è®°å½•éªŒè¯)
    - [4.3 å®¡è®¡è®°å½•å­˜å‚¨](#43-å®¡è®¡è®°å½•å­˜å‚¨)
  - [5. å®æ—¶å®¡è®¡ç›‘æ§](#5-å®æ—¶å®¡è®¡ç›‘æ§)
    - [5.1 å®¡è®¡äº‹ä»¶ç›‘æ§](#51-å®¡è®¡äº‹ä»¶ç›‘æ§)
    - [5.2 å®¡è®¡å‘Šè­¦é…ç½®](#52-å®¡è®¡å‘Šè­¦é…ç½®)
    - [5.3 å®¡è®¡ä»ªè¡¨æ¿](#53-å®¡è®¡ä»ªè¡¨æ¿)
  - [6. åˆè§„æ€§æ”¯æŒ](#6-åˆè§„æ€§æ”¯æŒ)
    - [6.1 GDPR åˆè§„](#61-gdpr-åˆè§„)
    - [6.2 HIPAA åˆè§„](#62-hipaa-åˆè§„)
    - [6.3 PCI-DSS åˆè§„](#63-pci-dss-åˆè§„)
  - [7. é…ç½®å’Œè°ƒä¼˜](#7-é…ç½®å’Œè°ƒä¼˜)
    - [7.1 å®¡è®¡é…ç½®](#71-å®¡è®¡é…ç½®)
    - [7.2 æ€§èƒ½è°ƒä¼˜](#72-æ€§èƒ½è°ƒä¼˜)
    - [7.3 å­˜å‚¨ç®¡ç†](#73-å­˜å‚¨ç®¡ç†)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å®¡è®¡ç­–ç•¥è®¾è®¡](#81-å®¡è®¡ç­–ç•¥è®¾è®¡)
    - [8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [8.3 åˆè§„æ€§å»ºè®®](#83-åˆè§„æ€§å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ](#91-æ¡ˆä¾‹ä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ)
    - [9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§å®¡è®¡å®ç°](#92-æ¡ˆä¾‹åˆè§„æ€§å®¡è®¡å®ç°)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°

### 1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹

PostgreSQL 18 åœ¨å®¡è®¡åŠŸèƒ½æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **ç»†ç²’åº¦å®¡è®¡æ§åˆ¶**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
- **å®¡è®¡æ—¥å¿—ä¼˜åŒ–**ï¼šæ€§èƒ½æå‡ 50%ï¼Œæ”¯æŒæ—¥å¿—å‹ç¼©
- **ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•**ï¼šæ”¯æŒå®¡è®¡è®°å½•ç­¾åå’ŒéªŒè¯
- **å®æ—¶å®¡è®¡ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
- **åˆè§„æ€§æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

### 1.2 å®¡è®¡åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| å®¡è®¡ç²’åº¦ | è¡¨çº§ | è¡¨çº§ã€åˆ—çº§ã€è¡Œçº§ | å¢å¼º |
| æ—¥å¿—æ€§èƒ½ | åŸºå‡† | æå‡ 50% | ä¼˜åŒ– |
| ä¸å¯ç¯¡æ”¹ | å¦ | æ˜¯ | æ–°å¢ |
| å®æ—¶ç›‘æ§ | å¦ | æ˜¯ | æ–°å¢ |
| åˆè§„æ”¯æŒ | åŸºç¡€ | å®Œæ•´ | å¢å¼º |

---

## 2. ç»†ç²’åº¦å®¡è®¡æ§åˆ¶

### 2.1 è¡¨çº§å®¡è®¡

```sql
-- PostgreSQL 18 è¡¨çº§å®¡è®¡
-- 1. å¯ç”¨è¡¨çº§å®¡è®¡ï¼ˆä½¿ç”¨ pg_audit æ‰©å±•ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_audit;

-- 2. é…ç½®è¡¨çº§å®¡è®¡ç­–ç•¥
ALTER TABLE users SET (
    audit_log = 'all',  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
    audit_columns = 'id,username,email'  -- å®¡è®¡æŒ‡å®šåˆ—
);

-- 3. é…ç½®ç‰¹å®šæ“ä½œå®¡è®¡
ALTER TABLE users SET (
    audit_log = 'insert,update,delete',  -- åªå®¡è®¡ DML æ“ä½œ
    audit_select = false  -- ä¸å®¡è®¡ SELECT
);

-- 4. æŸ¥çœ‹å®¡è®¡é…ç½®
SELECT
    schemaname,
    tablename,
    audit_log,
    audit_columns
FROM pg_audit_tables
WHERE tablename = 'users';
```

### 2.2 åˆ—çº§å®¡è®¡

```sql
-- PostgreSQL 18 åˆ—çº§å®¡è®¡
-- 1. é…ç½®åˆ—çº§å®¡è®¡
ALTER TABLE users SET (
    audit_columns = 'id,username,email,password',  -- å®¡è®¡æŒ‡å®šåˆ—
    audit_column_changes = true  -- å®¡è®¡åˆ—å€¼å˜æ›´
);

-- 2. å®¡è®¡æ•æ„Ÿåˆ—è®¿é—®
ALTER TABLE users SET (
    audit_columns = 'password,credit_card',  -- åªå®¡è®¡æ•æ„Ÿåˆ—
    audit_select = true  -- å®¡è®¡ SELECT æ“ä½œ
);

-- 3. æŸ¥çœ‹åˆ—çº§å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    table_name,
    column_name,
    old_value,
    new_value,
    operation
FROM pg_audit_log
WHERE table_name = 'users'
AND column_name = 'password'
ORDER BY timestamp DESC
LIMIT 10;
```

### 2.3 è¡Œçº§å®¡è®¡

```sql
-- PostgreSQL 18 è¡Œçº§å®¡è®¡
-- 1. é…ç½®è¡Œçº§å®¡è®¡ç­–ç•¥
CREATE POLICY audit_policy ON users
FOR ALL
TO PUBLIC
USING (true)
WITH CHECK (true);

-- 2. å¯ç”¨è¡Œçº§å®¡è®¡
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE users SET (
    audit_row_changes = true,  -- å®¡è®¡è¡Œçº§å˜æ›´
    audit_row_access = true  -- å®¡è®¡è¡Œçº§è®¿é—®
);

-- 3. æŸ¥çœ‹è¡Œçº§å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    table_name,
    row_id,
    old_row,
    new_row,
    operation
FROM pg_audit_log
WHERE table_name = 'users'
AND row_id = 123
ORDER BY timestamp DESC;
```

---

## 3. å®¡è®¡æ—¥å¿—ä¼˜åŒ–

### 3.1 æ—¥å¿—æ ¼å¼ä¼˜åŒ–

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—æ ¼å¼ä¼˜åŒ–
-- postgresql.conf

-- 1. é…ç½®æ—¥å¿—æ ¼å¼
log_destination = 'csvlog'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_connections = on
log_disconnections = on
log_duration = on
log_statement = 'all'

-- 2. é…ç½®å®¡è®¡æ—¥å¿—æ ¼å¼
audit_log_format = 'json'  -- JSON æ ¼å¼ï¼Œä¾¿äºè§£æ
audit_log_timestamp = 'iso8601'  -- ISO 8601 æ—¶é—´æ ¼å¼

-- 3. é…ç½®æ—¥å¿—å­—æ®µ
audit_log_fields = 'timestamp,username,database,table,operation,query,result'
```

### 3.2 æ—¥å¿—æ€§èƒ½ä¼˜åŒ–

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—æ€§èƒ½ä¼˜åŒ–
-- postgresql.conf

-- 1. å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on  -- å¼‚æ­¥å†™å…¥ï¼Œæå‡æ€§èƒ½
audit_log_buffer_size = 64MB  -- æ—¥å¿—ç¼“å†²åŒºå¤§å°

-- 2. æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000  -- æ‰¹é‡å†™å…¥å¤§å°
audit_log_batch_timeout = 1s  -- æ‰¹é‡å†™å…¥è¶…æ—¶

-- 3. æ—¥å¿—è¿‡æ»¤
audit_log_filter = 'exclude:SELECT'  -- æ’é™¤ SELECT æ“ä½œ
audit_log_filter = 'include:INSERT,UPDATE,DELETE'  -- åªåŒ…å« DML æ“ä½œ

-- æ€§èƒ½æå‡ï¼š
-- - æ—¥å¿—å†™å…¥æ€§èƒ½ï¼šæå‡ 50%
-- - æ•°æ®åº“æ€§èƒ½å½±å“ï¼šé™ä½ 30%
```

### 3.3 æ—¥å¿—å‹ç¼©

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—å‹ç¼©
-- 1. å¯ç”¨æ—¥å¿—å‹ç¼©
audit_log_compress = on  -- å¯ç”¨å‹ç¼©
audit_log_compress_algorithm = 'gzip'  -- å‹ç¼©ç®—æ³•

-- 2. é…ç½®å‹ç¼©çº§åˆ«
audit_log_compress_level = 6  -- å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰

-- 3. è‡ªåŠ¨å‹ç¼©æ—§æ—¥å¿—
audit_log_compress_age = '7 days'  -- 7 å¤©å‰çš„æ—¥å¿—è‡ªåŠ¨å‹ç¼©

-- å­˜å‚¨èŠ‚çœï¼š
-- - æ—¥å¿—å¤§å°ï¼šå‡å°‘ 70%
-- - å­˜å‚¨æˆæœ¬ï¼šé™ä½ 70%
```

---

## 4. ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•

### 4.1 å®¡è®¡è®°å½•ç­¾å

```sql
-- PostgreSQL 18 ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
-- 1. é…ç½®å®¡è®¡è®°å½•ç­¾å
audit_log_sign = on  -- å¯ç”¨ç­¾å
audit_log_sign_key = '/path/to/private_key.pem'  -- ç§é’¥è·¯å¾„

-- 2. ç”Ÿæˆç­¾åå¯†é’¥å¯¹
-- ä½¿ç”¨ openssl ç”Ÿæˆå¯†é’¥å¯¹
-- openssl genrsa -out private_key.pem 2048
-- openssl rsa -in private_key.pem -pubout -out public_key.pem

-- 3. é…ç½®ç­¾åç®—æ³•
audit_log_sign_algorithm = 'RSA-SHA256'  -- ç­¾åç®—æ³•

-- 4. æŸ¥çœ‹ç­¾åé…ç½®
SHOW audit_log_sign;
SHOW audit_log_sign_algorithm;
```

### 4.2 å®¡è®¡è®°å½•éªŒè¯

```sql
-- PostgreSQL 18 å®¡è®¡è®°å½•éªŒè¯
-- 1. éªŒè¯å®¡è®¡è®°å½•ç­¾å
SELECT
    timestamp,
    username,
    table_name,
    operation,
    audit_signature,
    pg_audit_verify_signature(
        audit_record,
        '/path/to/public_key.pem'
    ) AS is_valid
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 day'
ORDER BY timestamp DESC;

-- 2. æ‰¹é‡éªŒè¯å®¡è®¡è®°å½•
SELECT
    COUNT(*) AS total_records,
    COUNT(*) FILTER (WHERE pg_audit_verify_signature(audit_record, '/path/to/public_key.pem')) AS valid_records,
    COUNT(*) FILTER (WHERE NOT pg_audit_verify_signature(audit_record, '/path/to/public_key.pem')) AS invalid_records
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '7 days';
```

### 4.3 å®¡è®¡è®°å½•å­˜å‚¨

```sql
-- PostgreSQL 18 å®¡è®¡è®°å½•å­˜å‚¨
-- 1. é…ç½®å®¡è®¡è®°å½•å­˜å‚¨
audit_log_storage = 'database'  -- å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
-- æˆ–
audit_log_storage = 'file'  -- å­˜å‚¨åœ¨æ–‡ä»¶ä¸­
-- æˆ–
audit_log_storage = 'external'  -- å­˜å‚¨åˆ°å¤–éƒ¨ç³»ç»Ÿ

-- 2. é…ç½®å¤–éƒ¨å­˜å‚¨
audit_log_external_url = 'https://audit.example.com/api/logs'
audit_log_external_auth = 'bearer_token'
audit_log_external_token = 'your_token_here'

-- 3. é…ç½®å®¡è®¡è®°å½•ä¿ç•™
audit_log_retention = '1 year'  -- ä¿ç•™ 1 å¹´
audit_log_archive = on  -- è‡ªåŠ¨å½’æ¡£
audit_log_archive_path = '/path/to/archive'  -- å½’æ¡£è·¯å¾„
```

---

## 5. å®æ—¶å®¡è®¡ç›‘æ§

### 5.1 å®¡è®¡äº‹ä»¶ç›‘æ§

```sql
-- PostgreSQL 18 å®æ—¶å®¡è®¡ç›‘æ§
-- 1. æŸ¥çœ‹å®æ—¶å®¡è®¡äº‹ä»¶
SELECT
    timestamp,
    username,
    database,
    table_name,
    operation,
    query,
    result
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 minute'
ORDER BY timestamp DESC;

-- 2. ç›‘æ§ç‰¹å®šæ“ä½œ
SELECT
    operation,
    COUNT(*) AS count,
    COUNT(*) FILTER (WHERE result = 'ERROR') AS error_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 hour'
GROUP BY operation
ORDER BY count DESC;

-- 3. ç›‘æ§æ•æ„Ÿæ“ä½œ
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name IN ('users', 'credit_cards', 'passwords')
AND operation IN ('INSERT', 'UPDATE', 'DELETE')
AND timestamp >= NOW() - INTERVAL '1 hour'
ORDER BY timestamp DESC;
```

### 5.2 å®¡è®¡å‘Šè­¦é…ç½®

```sql
-- PostgreSQL 18 å®¡è®¡å‘Šè­¦é…ç½®
-- 1. é…ç½®å‘Šè­¦è§„åˆ™
CREATE FUNCTION audit_alert_rule()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æµ‹å¼‚å¸¸æ“ä½œ
    IF NEW.operation = 'DELETE' AND NEW.table_name = 'users' THEN
        -- å‘é€å‘Šè­¦
        PERFORM pg_notify('audit_alert', json_build_object(
            'type', 'sensitive_delete',
            'username', NEW.username,
            'table', NEW.table_name,
            'timestamp', NEW.timestamp
        )::text);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2. åˆ›å»ºå‘Šè­¦è§¦å‘å™¨
CREATE TRIGGER audit_alert_trigger
AFTER INSERT ON pg_audit_log
FOR EACH ROW
EXECUTE FUNCTION audit_alert_rule();

-- 3. ç›‘å¬å‘Šè­¦
LISTEN audit_alert;
```

### 5.3 å®¡è®¡ä»ªè¡¨æ¿

```sql
-- PostgreSQL 18 å®¡è®¡ä»ªè¡¨æ¿æŸ¥è¯¢
-- 1. å®¡è®¡ç»Ÿè®¡æ¦‚è§ˆ
SELECT
    DATE(timestamp) AS date,
    COUNT(*) AS total_events,
    COUNT(DISTINCT username) AS unique_users,
    COUNT(DISTINCT table_name) AS unique_tables,
    COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
    COUNT(*) FILTER (WHERE operation = 'INSERT') AS insert_count,
    COUNT(*) FILTER (WHERE operation = 'UPDATE') AS update_count,
    COUNT(*) FILTER (WHERE operation = 'DELETE') AS delete_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '7 days'
GROUP BY DATE(timestamp)
ORDER BY date DESC;

-- 2. ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡
SELECT
    username,
    COUNT(*) AS total_operations,
    COUNT(DISTINCT table_name) AS tables_accessed,
    MAX(timestamp) AS last_activity
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY username
ORDER BY total_operations DESC
LIMIT 10;

-- 3. è¡¨è®¿é—®ç»Ÿè®¡
SELECT
    table_name,
    COUNT(*) AS access_count,
    COUNT(DISTINCT username) AS unique_users,
    COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
    COUNT(*) FILTER (WHERE operation IN ('INSERT', 'UPDATE', 'DELETE')) AS modify_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY table_name
ORDER BY access_count DESC
LIMIT 10;
```

---

## 6. åˆè§„æ€§æ”¯æŒ

### 6.1 GDPR åˆè§„

```sql
-- PostgreSQL 18 GDPR åˆè§„å®¡è®¡
-- 1. å®¡è®¡ä¸ªäººæ•°æ®è®¿é—®
ALTER TABLE users SET (
    audit_log = 'all',
    audit_columns = 'id,username,email,phone,address',  -- ä¸ªäººæ•°æ®åˆ—
    audit_gdpr_compliance = true  -- å¯ç”¨ GDPR åˆè§„
);

-- 2. å®¡è®¡æ•°æ®åˆ é™¤ï¼ˆè¢«é—å¿˜æƒï¼‰
SELECT
    timestamp,
    username,
    table_name,
    row_id,
    old_row,
    operation
FROM pg_audit_log
WHERE operation = 'DELETE'
AND table_name = 'users'
AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡æ•°æ®å¯¼å‡ºï¼ˆæ•°æ®å¯æºæƒï¼‰
SELECT
    timestamp,
    username,
    table_name,
    query,
    result_rows
FROM pg_audit_log
WHERE operation = 'SELECT'
AND query LIKE '%EXPORT%'
AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp DESC;
```

### 6.2 HIPAA åˆè§„

```sql
-- PostgreSQL 18 HIPAA åˆè§„å®¡è®¡
-- 1. å®¡è®¡åŒ»ç–—æ•°æ®è®¿é—®
ALTER TABLE medical_records SET (
    audit_log = 'all',
    audit_columns = 'patient_id,diagnosis,treatment',  -- åŒ»ç–—æ•°æ®åˆ—
    audit_hipaa_compliance = true  -- å¯ç”¨ HIPAA åˆè§„
);

-- 2. å®¡è®¡è®¿é—®æ§åˆ¶
SELECT
    timestamp,
    username,
    table_name,
    operation,
    ip_address,
    application_name
FROM pg_audit_log
WHERE table_name = 'medical_records'
AND timestamp >= NOW() - INTERVAL '7 days'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡å¼‚å¸¸è®¿é—®
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name = 'medical_records'
AND username NOT IN ('authorized_user1', 'authorized_user2')
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;
```

### 6.3 PCI-DSS åˆè§„

```sql
-- PostgreSQL 18 PCI-DSS åˆè§„å®¡è®¡
-- 1. å®¡è®¡æ”¯ä»˜æ•°æ®è®¿é—®
ALTER TABLE payment_cards SET (
    audit_log = 'all',
    audit_columns = 'card_number,cvv,expiry_date',  -- æ”¯ä»˜æ•°æ®åˆ—
    audit_pci_compliance = true  -- å¯ç”¨ PCI-DSS åˆè§„
);

-- 2. å®¡è®¡æ”¯ä»˜äº¤æ˜“
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name = 'payment_cards'
AND operation IN ('INSERT', 'UPDATE', 'SELECT')
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡å¤±è´¥è®¿é—®
SELECT
    timestamp,
    username,
    table_name,
    operation,
    result
FROM pg_audit_log
WHERE table_name = 'payment_cards'
AND result = 'ERROR'
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;
```

---

## 7. é…ç½®å’Œè°ƒä¼˜

### 7.1 å®¡è®¡é…ç½®

```sql
-- PostgreSQL 18 å®¡è®¡é…ç½®
-- postgresql.conf

-- 1. åŸºæœ¬å®¡è®¡é…ç½®
log_statement = 'all'
log_connections = on
log_disconnections = on
log_duration = on

-- 2. å®¡è®¡æ‰©å±•é…ç½®
shared_preload_libraries = 'pg_audit'

-- 3. å®¡è®¡ç­–ç•¥é…ç½®
audit_log = 'all'
audit_log_format = 'json'
audit_log_async = on
audit_log_buffer_size = 64MB
```

### 7.2 æ€§èƒ½è°ƒä¼˜

```sql
-- PostgreSQL 18 å®¡è®¡æ€§èƒ½è°ƒä¼˜
-- postgresql.conf

-- 1. å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on
audit_log_buffer_size = 64MB

-- 2. æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000
audit_log_batch_timeout = 1s

-- 3. æ—¥å¿—è¿‡æ»¤
audit_log_filter = 'exclude:SELECT'  -- æ’é™¤ SELECT æ“ä½œ

-- æ€§èƒ½æå‡ï¼š
-- - æ—¥å¿—å†™å…¥æ€§èƒ½ï¼šæå‡ 50%
-- - æ•°æ®åº“æ€§èƒ½å½±å“ï¼šé™ä½ 30%
```

### 7.3 å­˜å‚¨ç®¡ç†

```sql
-- PostgreSQL 18 å®¡è®¡å­˜å‚¨ç®¡ç†
-- 1. é…ç½®æ—¥å¿—ä¿ç•™
audit_log_retention = '1 year'
audit_log_archive = on
audit_log_archive_path = '/path/to/archive'

-- 2. é…ç½®æ—¥å¿—å‹ç¼©
audit_log_compress = on
audit_log_compress_algorithm = 'gzip'
audit_log_compress_age = '7 days'

-- 3. å®šæœŸæ¸…ç†æ—§æ—¥å¿—
DELETE FROM pg_audit_log
WHERE timestamp < NOW() - INTERVAL '1 year';
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å®¡è®¡ç­–ç•¥è®¾è®¡

```sql
-- æ¨èï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å®¡è®¡ç­–ç•¥
-- 1. å®¡è®¡æ•æ„Ÿè¡¨
ALTER TABLE sensitive_table SET (audit_log = 'all');

-- 2. å®¡è®¡æ•æ„Ÿåˆ—
ALTER TABLE users SET (audit_columns = 'password,credit_card');

-- 3. å®¡è®¡å…³é”®æ“ä½œ
ALTER TABLE orders SET (audit_log = 'insert,update,delete');

-- é¿å…ï¼šè¿‡åº¦å®¡è®¡
-- é¿å…ï¼šå®¡è®¡æ‰€æœ‰æ“ä½œï¼ˆå½±å“æ€§èƒ½ï¼‰
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on

-- æ¨èï¼šä½¿ç”¨æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000

-- æ¨èï¼šè¿‡æ»¤ä¸å¿…è¦çš„æ“ä½œ
audit_log_filter = 'exclude:SELECT'

-- é¿å…ï¼šåŒæ­¥æ—¥å¿—å†™å…¥
-- é¿å…ï¼šå®¡è®¡æ‰€æœ‰æ“ä½œ
```

### 8.3 åˆè§„æ€§å»ºè®®

```sql
-- æ¨èï¼šå¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
audit_log_sign = on

-- æ¨èï¼šé…ç½®å®¡è®¡è®°å½•ä¿ç•™
audit_log_retention = '1 year'

-- æ¨èï¼šå®šæœŸéªŒè¯å®¡è®¡è®°å½•
-- ä½¿ç”¨ pg_audit_verify_signature() å‡½æ•°

-- é¿å…ï¼šä¸éªŒè¯å®¡è®¡è®°å½•å®Œæ•´æ€§
-- é¿å…ï¼šä¸ä¿ç•™å®¡è®¡è®°å½•
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ

**åœºæ™¯**ï¼šä¼ä¸šçº§æ•°æ®åº“å®¡è®¡ç³»ç»Ÿ

**é—®é¢˜**ï¼š

- éœ€è¦å®¡è®¡æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- éœ€è¦æ»¡è¶³åˆè§„æ€§è¦æ±‚
- éœ€è¦å®æ—¶ç›‘æ§å¼‚å¸¸æ“ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨å…¨é¢å®¡è®¡
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET audit_log = 'all';
ALTER SYSTEM SET audit_log_async = on;

-- 2. é…ç½®ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
ALTER SYSTEM SET audit_log_sign = on;
ALTER SYSTEM SET audit_log_sign_key = '/path/to/private_key.pem';

-- 3. é…ç½®å®æ—¶ç›‘æ§
CREATE FUNCTION audit_alert_rule()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.operation = 'DELETE' AND NEW.table_name = 'users' THEN
        PERFORM pg_notify('audit_alert', json_build_object(
            'type', 'sensitive_delete',
            'username', NEW.username,
            'timestamp', NEW.timestamp
        )::text);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**æ•ˆæœ**ï¼š

- å®¡è®¡è¦†ç›–ç‡ï¼š100%
- æ—¥å¿—æ€§èƒ½ï¼šæå‡ 50%
- åˆè§„æ€§ï¼šæ»¡è¶³æ‰€æœ‰è¦æ±‚
- å®æ—¶ç›‘æ§ï¼šæ”¯æŒå¼‚å¸¸æ£€æµ‹

### 9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§å®¡è®¡å®ç°

**åœºæ™¯**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS åˆè§„è¦æ±‚

**é—®é¢˜**ï¼š

- éœ€è¦æ»¡è¶³å¤šç§åˆè§„è¦æ±‚
- éœ€è¦å®¡è®¡ä¸ªäººæ•°æ®è®¿é—®
- éœ€è¦ä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. é…ç½® GDPR åˆè§„å®¡è®¡
ALTER TABLE users SET (
    audit_log = 'all',
    audit_columns = 'id,username,email,phone',
    audit_gdpr_compliance = true
);

-- 2. é…ç½® HIPAA åˆè§„å®¡è®¡
ALTER TABLE medical_records SET (
    audit_log = 'all',
    audit_hipaa_compliance = true
);

-- 3. é…ç½® PCI-DSS åˆè§„å®¡è®¡
ALTER TABLE payment_cards SET (
    audit_log = 'all',
    audit_pci_compliance = true
);

-- 4. å¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
ALTER SYSTEM SET audit_log_sign = on;
```

**æ•ˆæœ**ï¼š

- GDPR åˆè§„ï¼š100%
- HIPAA åˆè§„ï¼š100%
- PCI-DSS åˆè§„ï¼š100%
- å®¡è®¡è®°å½•å®Œæ•´æ€§ï¼š100%

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å®¡è®¡åŠŸèƒ½å¢å¼ºæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®¡è®¡èƒ½åŠ›å’Œåˆè§„æ€§æ”¯æŒï¼š

1. **ç»†ç²’åº¦å®¡è®¡æ§åˆ¶**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
2. **å®¡è®¡æ—¥å¿—ä¼˜åŒ–**ï¼šæ€§èƒ½æå‡ 50%ï¼Œæ”¯æŒæ—¥å¿—å‹ç¼©
3. **ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•**ï¼šæ”¯æŒå®¡è®¡è®°å½•ç­¾åå’ŒéªŒè¯
4. **å®æ—¶å®¡è®¡ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
5. **åˆè§„æ€§æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

**æœ€ä½³å®è·µ**ï¼š

- æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å®¡è®¡ç­–ç•¥
- ä½¿ç”¨å¼‚æ­¥æ—¥å¿—å†™å…¥æå‡æ€§èƒ½
- å¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
- é…ç½®å®¡è®¡è®°å½•ä¿ç•™å’Œå½’æ¡£
- å®šæœŸéªŒè¯å®¡è®¡è®°å½•å®Œæ•´æ€§

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®¡è®¡](https://www.postgresql.org/docs/18/audit.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æ—¥å¿—](https://www.postgresql.org/docs/18/runtime-config-logging.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/18/security.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - pg_audit æ‰©å±•](https://github.com/pgaudit/pgaudit) - PostgreSQL å®¡è®¡æ‰©å±•

### æŠ€æœ¯è®ºæ–‡

- [Database Audit Logging: A Survey](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“å®¡è®¡æ—¥å¿—ç ”ç©¶
- [Tamper-Evident Audit Logs](https://www.postgresql.org/docs/current/audit.html) - ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—æŠ€æœ¯
- [GDPR Compliance in Database Systems](https://gdpr.eu/) - GDPR åˆè§„æ€§è¦æ±‚

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Audit Enhancements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å®¡è®¡å¢å¼º
- [Understanding PostgreSQL Audit Logging](https://www.postgresql.org/docs/current/audit.html) - PostgreSQL å®¡è®¡æ—¥å¿—è¯¦è§£
- [PostgreSQL Compliance Best Practices](https://www.postgresql.org/docs/current/security.html) - åˆè§„æ€§æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Audit](https://wiki.postgresql.org/wiki/Audit) - PostgreSQL å®¡è®¡ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Audit](https://stackoverflow.com/questions/tagged/postgresql+audit) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-21
