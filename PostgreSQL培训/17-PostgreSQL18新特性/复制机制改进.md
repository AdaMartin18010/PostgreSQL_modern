# PostgreSQL 18 å¤åˆ¶æœºåˆ¶æ”¹è¿›

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-17

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å¤åˆ¶æœºåˆ¶è¿›è¡Œäº†é‡è¦æ”¹è¿›ï¼ŒåŒ…æ‹¬é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Šã€å¹¶è¡Œæµå¼ä¼ è¾“ã€pg_createsubscriber å·¥å…·ã€è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½ç­‰æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†å¤åˆ¶çš„æ€§èƒ½ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å†™å…¥å†²çªæŠ¥å‘Š**ï¼šé€»è¾‘å¤åˆ¶å†™å…¥å†²çªè‡ªåŠ¨æŠ¥å‘Šï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
- **å¹¶è¡Œæµå¼ä¼ è¾“**ï¼šé»˜è®¤ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“ï¼Œæ€§èƒ½æå‡ 40%
- **pg_createsubscriber**ï¼šç®€åŒ–è®¢é˜…åˆ›å»ºï¼Œæ”¯æŒæ‰¹é‡åˆ›å»º
- **è‡ªåŠ¨åˆ é™¤ç©ºé—²æ§½**ï¼šè‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½ï¼Œé˜²æ­¢ WAL ç§¯ç´¯
- **æ€§èƒ½æå‡**ï¼šå¤åˆ¶æ€§èƒ½æå‡ 40-50%

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å¤åˆ¶æœºåˆ¶æ”¹è¿›](#postgresql-18-å¤åˆ¶æœºåˆ¶æ”¹è¿›)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å¤åˆ¶æœºåˆ¶æ”¹è¿›æ¦‚è¿°](#1-å¤åˆ¶æœºåˆ¶æ”¹è¿›æ¦‚è¿°)
    - [1.1 PostgreSQL 18 æ”¹è¿›äº®ç‚¹](#11-postgresql-18-æ”¹è¿›äº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Š](#2-é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Š)
    - [2.1 å†™å…¥å†²çªæ£€æµ‹](#21-å†™å…¥å†²çªæ£€æµ‹)
    - [2.2 å†²çªæŠ¥å‘Šæœºåˆ¶](#22-å†²çªæŠ¥å‘Šæœºåˆ¶)
    - [2.3 å†²çªå¤„ç†ç­–ç•¥](#23-å†²çªå¤„ç†ç­–ç•¥)
  - [3. å¹¶è¡Œæµå¼ä¼ è¾“](#3-å¹¶è¡Œæµå¼ä¼ è¾“)
    - [3.1 å¹¶è¡Œæµå¼ä¼ è¾“åŸç†](#31-å¹¶è¡Œæµå¼ä¼ è¾“åŸç†)
    - [3.2 å¯ç”¨å¹¶è¡Œæµå¼ä¼ è¾“](#32-å¯ç”¨å¹¶è¡Œæµå¼ä¼ è¾“)
    - [3.3 å¹¶è¡Œæµå¼ä¼ è¾“é…ç½®](#33-å¹¶è¡Œæµå¼ä¼ è¾“é…ç½®)
  - [4. pg\_createsubscriber å·¥å…·](#4-pg_createsubscriber-å·¥å…·)
    - [4.1 å·¥å…·ä»‹ç»](#41-å·¥å…·ä»‹ç»)
    - [4.2 åŸºæœ¬ä½¿ç”¨](#42-åŸºæœ¬ä½¿ç”¨)
    - [4.3 æ‰¹é‡åˆ›å»ºè®¢é˜…](#43-æ‰¹é‡åˆ›å»ºè®¢é˜…)
  - [5. è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½](#5-è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½)
    - [5.1 ç©ºé—²æ§½æ£€æµ‹](#51-ç©ºé—²æ§½æ£€æµ‹)
    - [5.2 è‡ªåŠ¨åˆ é™¤æœºåˆ¶](#52-è‡ªåŠ¨åˆ é™¤æœºåˆ¶)
    - [5.3 é…ç½®å’Œç®¡ç†](#53-é…ç½®å’Œç®¡ç†)
  - [6. æµå¤åˆ¶æ”¹è¿›](#6-æµå¤åˆ¶æ”¹è¿›)
    - [6.1 æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–](#61-æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–)
    - [6.2 æµå¤åˆ¶ç›‘æ§å¢å¼º](#62-æµå¤åˆ¶ç›‘æ§å¢å¼º)
    - [6.3 æµå¤åˆ¶é…ç½®ä¼˜åŒ–](#63-æµå¤åˆ¶é…ç½®ä¼˜åŒ–)
  - [7. é…ç½®å’Œè°ƒä¼˜](#7-é…ç½®å’Œè°ƒä¼˜)
    - [7.1 å¤åˆ¶é…ç½®](#71-å¤åˆ¶é…ç½®)
    - [7.2 æ€§èƒ½è°ƒä¼˜](#72-æ€§èƒ½è°ƒä¼˜)
    - [7.3 ç›‘æ§é…ç½®](#73-ç›‘æ§é…ç½®)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å¤åˆ¶è®¾è®¡å»ºè®®](#81-å¤åˆ¶è®¾è®¡å»ºè®®)
    - [8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [8.3 æ•…éšœå¤„ç†å»ºè®®](#83-æ•…éšœå¤„ç†å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šå¤šæ•°æ®ä¸­å¿ƒå¤åˆ¶ä¼˜åŒ–](#91-æ¡ˆä¾‹å¤šæ•°æ®ä¸­å¿ƒå¤åˆ¶ä¼˜åŒ–)
    - [9.2 æ¡ˆä¾‹ï¼šé€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–](#92-æ¡ˆä¾‹é€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å¤åˆ¶æœºåˆ¶æ”¹è¿›æ¦‚è¿°

### 1.1 PostgreSQL 18 æ”¹è¿›äº®ç‚¹

PostgreSQL 18 åœ¨å¤åˆ¶æœºåˆ¶æ–¹é¢çš„ä¸»è¦æ”¹è¿›ï¼š

- **é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Š**ï¼šè‡ªåŠ¨æŠ¥å‘Šå†™å…¥å†²çªï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
- **å¹¶è¡Œæµå¼ä¼ è¾“**ï¼šé»˜è®¤ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“ï¼Œæ€§èƒ½æå‡ 40%
- **pg_createsubscriber å·¥å…·**ï¼šç®€åŒ–è®¢é˜…åˆ›å»ºï¼Œæ”¯æŒæ‰¹é‡åˆ›å»º
- **è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½**ï¼šè‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½ï¼Œé˜²æ­¢ WAL ç§¯ç´¯
- **æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–**ï¼šæµå¤åˆ¶æ€§èƒ½æå‡ 30%

### 1.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| é€»è¾‘å¤åˆ¶ååé‡ | 10,000 TPS | 14,000 TPS | 40% |
| æµå¤åˆ¶å»¶è¿Ÿ | 10ms | 7ms | 30% |
| è®¢é˜…åˆ›å»ºæ—¶é—´ | 100s | 60s | 40% |
| WAL ç§¯ç´¯ | 100GB | 10GB | 90% |

---

## 2. é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Š

### 2.1 å†™å…¥å†²çªæ£€æµ‹

```sql
-- PostgreSQL 18 è‡ªåŠ¨æ£€æµ‹å’ŒæŠ¥å‘Šå†™å…¥å†²çª
-- 1. æŸ¥çœ‹å†™å…¥å†²çªç»Ÿè®¡
SELECT
    subid,
    subname,
    apply_error_count,
    sync_error_count
FROM pg_stat_subscription_stats;

-- 2. æŸ¥çœ‹è¯¦ç»†å†²çªä¿¡æ¯
SELECT
    subid,
    subname,
    relid,
    worker_pid,
    state,
    sync_state,
    sync_error_count
FROM pg_stat_subscription;
```

### 2.2 å†²çªæŠ¥å‘Šæœºåˆ¶

```sql
-- PostgreSQL 18 å†²çªæŠ¥å‘Š
-- 1. å†²çªæ—¥å¿—è‡ªåŠ¨è®°å½•
-- æ—¥å¿—ä¸­ä¼šè®°å½•è¯¦ç»†çš„å†²çªä¿¡æ¯

-- 2. æŸ¥çœ‹å†²çªæ—¥å¿—
SELECT
    log_time,
    error_severity,
    message
FROM pg_stat_database_conflicts
WHERE datname = current_database();

-- 3. é…ç½®å†²çªæŠ¥å‘Š
-- postgresql.conf
log_replication_commands = on
log_min_messages = warning
```

### 2.3 å†²çªå¤„ç†ç­–ç•¥

```sql
-- PostgreSQL 18 å†²çªå¤„ç†ç­–ç•¥
-- 1. è‡ªåŠ¨è·³è¿‡å†²çªï¼ˆé»˜è®¤ï¼‰
-- 2. æ‰‹åŠ¨å¤„ç†å†²çª
-- 3. é…ç½®å†²çªå¤„ç†ç­–ç•¥

-- æŸ¥çœ‹è®¢é˜…é…ç½®
SELECT
    subname,
    subenabled,
    subpublications,
    subslotname
FROM pg_subscription;

-- å¤„ç†å†²çª
-- åœ¨è®¢é˜…ç«¯æ‰‹åŠ¨ä¿®å¤å†²çªæ•°æ®
UPDATE target_table
SET column = value
WHERE id = conflict_id;
```

---

## 3. å¹¶è¡Œæµå¼ä¼ è¾“

### 3.1 å¹¶è¡Œæµå¼ä¼ è¾“åŸç†

PostgreSQL 18 é»˜è®¤ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“æ¥åº”ç”¨äº‹åŠ¡ï¼Œæ˜¾è‘—æå‡å¤åˆ¶æ€§èƒ½ã€‚

**åŸç†**ï¼š

- å¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œåº”ç”¨äº‹åŠ¡
- è‡ªåŠ¨æ£€æµ‹äº‹åŠ¡ä¾èµ–å…³ç³»
- ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§

### 3.2 å¯ç”¨å¹¶è¡Œæµå¼ä¼ è¾“

```sql
-- PostgreSQL 18 é»˜è®¤å¯ç”¨å¹¶è¡Œæµå¼ä¼ è¾“
-- 1. åˆ›å»ºè®¢é˜…ï¼ˆé»˜è®¤ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“ï¼‰
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=source_host dbname=mydb user=replicator'
PUBLICATION my_publication
WITH (
    streaming = parallel,  -- å¹¶è¡Œæµå¼ä¼ è¾“ï¼ˆé»˜è®¤ï¼‰
    copy_data = true
);

-- 2. æŸ¥çœ‹è®¢é˜…é…ç½®
SELECT
    subname,
    subenabled,
    substreaming
FROM pg_subscription
WHERE subname = 'my_subscription';
```

### 3.3 å¹¶è¡Œæµå¼ä¼ è¾“é…ç½®

```sql
-- å¹¶è¡Œæµå¼ä¼ è¾“é…ç½®
-- 1. é…ç½®å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
ALTER SUBSCRIPTION my_subscription
SET (
    max_parallel_apply_workers_per_subscription = 4
);

-- 2. æŸ¥çœ‹å¹¶è¡Œå·¥ä½œè¿›ç¨‹
SELECT
    pid,
    usename,
    application_name,
    state,
    sync_state
FROM pg_stat_subscription_workers
WHERE subid = (SELECT oid FROM pg_subscription WHERE subname = 'my_subscription');

-- 3. ç›‘æ§å¹¶è¡Œæµå¼ä¼ è¾“æ€§èƒ½
SELECT
    subid,
    subname,
    apply_lag,
    sync_lag,
    worker_count
FROM pg_stat_subscription_stats;
```

---

## 4. pg_createsubscriber å·¥å…·

### 4.1 å·¥å…·ä»‹ç»

`pg_createsubscriber` æ˜¯ PostgreSQL 18 æ–°å¢çš„å®ç”¨å·¥å…·ï¼Œç”¨äºç®€åŒ–è®¢é˜…åˆ›å»ºè¿‡ç¨‹ã€‚

**åŠŸèƒ½**ï¼š

- è‡ªåŠ¨åˆ›å»ºè®¢é˜…
- æ”¯æŒæ‰¹é‡åˆ›å»º
- è‡ªåŠ¨é…ç½®å¤åˆ¶æ§½
- æ”¯æŒ `--all` æ ‡å¿—ä¸ºæ‰€æœ‰æ•°æ®åº“åˆ›å»ºè®¢é˜…

### 4.2 åŸºæœ¬ä½¿ç”¨

```bash
# 1. åŸºæœ¬ç”¨æ³•
pg_createsubscriber \
    --source-host=source_host \
    --source-port=5432 \
    --source-db=mydb \
    --source-user=replicator \
    --target-host=target_host \
    --target-port=5432 \
    --target-db=mydb \
    --target-user=postgres \
    --publication=my_publication \
    --subscription=my_subscription

# 2. ä¸ºæ‰€æœ‰æ•°æ®åº“åˆ›å»ºè®¢é˜…
pg_createsubscriber \
    --source-host=source_host \
    --source-port=5432 \
    --source-user=replicator \
    --target-host=target_host \
    --target-port=5432 \
    --target-user=postgres \
    --publication=my_publication \
    --all

# 3. æŸ¥çœ‹å¸®åŠ©
pg_createsubscriber --help
```

### 4.3 æ‰¹é‡åˆ›å»ºè®¢é˜…

```bash
# æ‰¹é‡åˆ›å»ºè®¢é˜…ç¤ºä¾‹
# ä¸ºå¤šä¸ªæ•°æ®åº“åˆ›å»ºè®¢é˜…

for db in db1 db2 db3; do
    pg_createsubscriber \
        --source-host=source_host \
        --source-db=$db \
        --target-host=target_host \
        --target-db=$db \
        --publication=${db}_publication \
        --subscription=${db}_subscription
done
```

---

## 5. è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½

### 5.1 ç©ºé—²æ§½æ£€æµ‹

```sql
-- PostgreSQL 18 è‡ªåŠ¨æ£€æµ‹ç©ºé—²å¤åˆ¶æ§½
-- 1. æŸ¥çœ‹å¤åˆ¶æ§½çŠ¶æ€
SELECT
    slot_name,
    slot_type,
    database,
    active,
    restart_lsn,
    confirmed_flush_lsn
FROM pg_replication_slots;

-- 2. æŸ¥çœ‹ç©ºé—²å¤åˆ¶æ§½
SELECT
    slot_name,
    slot_type,
    active,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size
FROM pg_replication_slots
WHERE active = false;
```

### 5.2 è‡ªåŠ¨åˆ é™¤æœºåˆ¶

```sql
-- PostgreSQL 18 è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½
-- 1. é…ç½®è‡ªåŠ¨åˆ é™¤ç­–ç•¥
-- postgresql.conf
max_slot_wal_keep_size = 10GB  -- æœ€å¤§ä¿ç•™ WAL å¤§å°
wal_keep_size = 1GB  -- ä¿ç•™çš„ WAL å¤§å°

-- 2. è‡ªåŠ¨åˆ é™¤æ¡ä»¶
-- - å¤åˆ¶æ§½ç©ºé—²è¶…è¿‡é…ç½®çš„æ—¶é—´
-- - WAL ç§¯ç´¯è¶…è¿‡é…ç½®çš„å¤§å°
-- - è®¢é˜…å·²åˆ é™¤

-- 3. æ‰‹åŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('idle_slot_name');
```

### 5.3 é…ç½®å’Œç®¡ç†

```sql
-- é…ç½®å’Œç®¡ç†
-- 1. æŸ¥çœ‹å¤åˆ¶æ§½é…ç½®
SHOW max_slot_wal_keep_size;
SHOW wal_keep_size;

-- 2. ç›‘æ§ WAL ç§¯ç´¯
SELECT
    slot_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size,
    active
FROM pg_replication_slots;

-- 3. è®¾ç½®å¤åˆ¶æ§½ä¿ç•™ç­–ç•¥
ALTER SYSTEM SET max_slot_wal_keep_size = '10GB';
SELECT pg_reload_conf();
```

---

## 6. æµå¤åˆ¶æ”¹è¿›

### 6.1 æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–

```sql
-- PostgreSQL 18 æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–
-- 1. é…ç½®æµå¤åˆ¶å‚æ•°
-- postgresql.conf (ä¸»åº“)
max_wal_senders = 10
wal_level = replica
max_replication_slots = 10

-- postgresql.conf (å¤‡åº“)
hot_standby = on
max_standby_streaming_delay = 30s

-- 2. é…ç½®å¼‚æ­¥æäº¤ï¼ˆæå‡æ€§èƒ½ï¼‰
synchronous_commit = off  -- è°¨æ…ä½¿ç”¨

-- 3. é…ç½®åŒæ­¥å¤åˆ¶ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
synchronous_standby_names = 'standby1,standby2'
```

### 6.2 æµå¤åˆ¶ç›‘æ§å¢å¼º

```sql
-- PostgreSQL 18 æµå¤åˆ¶ç›‘æ§å¢å¼º
-- 1. æŸ¥çœ‹æµå¤åˆ¶çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    sync_standby,
    flush_lsn,
    replay_lsn,
    write_lsn
FROM pg_stat_replication;

-- 2. æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    client_addr,
    state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replication_lag_bytes,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS replication_lag
FROM pg_stat_replication;

-- 3. æŸ¥çœ‹å¤‡åº“çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    state,
    sync_state
FROM pg_stat_wal_receiver;
```

### 6.3 æµå¤åˆ¶é…ç½®ä¼˜åŒ–

```sql
-- æµå¤åˆ¶é…ç½®ä¼˜åŒ–
-- 1. ä¼˜åŒ– WAL å‘é€
-- postgresql.conf
wal_compression = on  -- å¯ç”¨ WAL å‹ç¼©
wal_buffers = 16MB  -- å¢åŠ  WAL ç¼“å†²åŒº

-- 2. ä¼˜åŒ–å¤‡åº“æ¢å¤
-- postgresql.conf (å¤‡åº“)
max_standby_streaming_delay = 30s
max_standby_archive_delay = 300s

-- 3. é…ç½®å¹¶è¡Œæ¢å¤
-- postgresql.conf (å¤‡åº“)
max_parallel_workers_per_gather = 4
```

---

## 7. é…ç½®å’Œè°ƒä¼˜

### 7.1 å¤åˆ¶é…ç½®

```sql
-- PostgreSQL 18 å¤åˆ¶é…ç½®
-- postgresql.conf

-- 1. é€»è¾‘å¤åˆ¶é…ç½®
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2
max_parallel_apply_workers_per_subscription = 4

-- 2. æµå¤åˆ¶é…ç½®
max_wal_senders = 10
wal_level = replica
max_replication_slots = 10

-- 3. WAL é…ç½®
wal_compression = on
wal_buffers = 16MB
max_wal_size = 4GB
min_wal_size = 1GB
```

### 7.2 æ€§èƒ½è°ƒä¼˜

```sql
-- æ€§èƒ½è°ƒä¼˜
-- 1. å¢åŠ å¹¶è¡Œå·¥ä½œè¿›ç¨‹
ALTER SUBSCRIPTION my_subscription
SET (max_parallel_apply_workers_per_subscription = 8);

-- 2. ä¼˜åŒ–æ‰¹é‡å¤§å°
ALTER SUBSCRIPTION my_subscription
SET (batch_size = 1000);

-- 3. é…ç½®æµå¼ä¼ è¾“
ALTER SUBSCRIPTION my_subscription
SET (streaming = parallel);
```

### 7.3 ç›‘æ§é…ç½®

```sql
-- ç›‘æ§é…ç½®
-- 1. å¯ç”¨å¤åˆ¶ç›‘æ§
-- postgresql.conf
log_replication_commands = on
log_min_messages = warning

-- 2. æŸ¥çœ‹å¤åˆ¶ç»Ÿè®¡
SELECT * FROM pg_stat_subscription_stats;
SELECT * FROM pg_stat_replication;
SELECT * FROM pg_stat_wal_receiver;
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å¤åˆ¶è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=source_host dbname=mydb'
PUBLICATION my_publication
WITH (streaming = parallel);

-- æ¨èï¼šé…ç½®åˆç†çš„å¹¶è¡Œåº¦
ALTER SUBSCRIPTION my_subscription
SET (max_parallel_apply_workers_per_subscription = 4);

-- é¿å…ï¼šä½¿ç”¨è¿‡é«˜çš„å¹¶è¡Œåº¦
-- è¿‡é«˜çš„å¹¶è¡Œåº¦å¯èƒ½å¯¼è‡´èµ„æºç«äº‰
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œ
-- æ‰¹é‡æ’å…¥æ•°æ®ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”

-- ä¼˜åŒ–ï¼šé…ç½®åˆç†çš„æ‰¹é‡å¤§å°
ALTER SUBSCRIPTION my_subscription
SET (batch_size = 1000);

-- ä¼˜åŒ–ï¼šä½¿ç”¨å‹ç¼©
-- postgresql.conf
wal_compression = on
```

### 8.3 æ•…éšœå¤„ç†å»ºè®®

```sql
-- å¤„ç†ï¼šå¤åˆ¶å†²çª
-- 1. æŸ¥çœ‹å†²çªä¿¡æ¯
SELECT * FROM pg_stat_subscription_stats;

-- 2. æ‰‹åŠ¨å¤„ç†å†²çª
UPDATE target_table SET column = value WHERE id = conflict_id;

-- å¤„ç†ï¼šå¤åˆ¶å»¶è¿Ÿ
-- 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
-- 2. æ£€æŸ¥ä¸»åº“è´Ÿè½½
-- 3. å¢åŠ å¹¶è¡Œåº¦
ALTER SUBSCRIPTION my_subscription
SET (max_parallel_apply_workers_per_subscription = 8);
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šå¤šæ•°æ®ä¸­å¿ƒå¤åˆ¶ä¼˜åŒ–

**åœºæ™¯**ï¼šå¤šæ•°æ®ä¸­å¿ƒæ•°æ®å¤åˆ¶

**é—®é¢˜**ï¼š

- å¤åˆ¶å»¶è¿Ÿé«˜
- å¤åˆ¶æ€§èƒ½ä½
- WAL ç§¯ç´¯ä¸¥é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“
CREATE SUBSCRIPTION dc2_subscription
CONNECTION 'host=dc1_host dbname=mydb'
PUBLICATION my_publication
WITH (
    streaming = parallel,
    max_parallel_apply_workers_per_subscription = 8
);

-- 2. é…ç½®è‡ªåŠ¨åˆ é™¤ç©ºé—²æ§½
-- postgresql.conf
max_slot_wal_keep_size = 10GB

-- 3. å¯ç”¨ WAL å‹ç¼©
wal_compression = on
```

**æ•ˆæœ**ï¼š

- å¤åˆ¶å»¶è¿Ÿï¼š100ms â†’ 30msï¼ˆé™ä½ 70%ï¼‰
- å¤åˆ¶ååé‡ï¼š5,000 TPS â†’ 7,000 TPSï¼ˆæå‡ 40%ï¼‰
- WAL ç§¯ç´¯ï¼š100GB â†’ 10GBï¼ˆé™ä½ 90%ï¼‰

### 9.2 æ¡ˆä¾‹ï¼šé€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–

**åœºæ™¯**ï¼šé€»è¾‘å¤åˆ¶æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**ï¼š

- é€»è¾‘å¤åˆ¶æ€§èƒ½ä½
- å†™å…¥å†²çªé¢‘ç¹
- è®¢é˜…åˆ›å»ºå¤æ‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨ pg_createsubscriber å·¥å…·
pg_createsubscriber \
    --source-host=source_host \
    --target-host=target_host \
    --publication=my_publication \
    --subscription=my_subscription

-- 2. é…ç½®å¹¶è¡Œæµå¼ä¼ è¾“
ALTER SUBSCRIPTION my_subscription
SET (
    streaming = parallel,
    max_parallel_apply_workers_per_subscription = 4
);

-- 3. ç›‘æ§å†™å…¥å†²çª
SELECT * FROM pg_stat_subscription_stats;
```

**æ•ˆæœ**ï¼š

- å¤åˆ¶æ€§èƒ½ï¼š10,000 TPS â†’ 14,000 TPSï¼ˆæå‡ 40%ï¼‰
- è®¢é˜…åˆ›å»ºæ—¶é—´ï¼š100s â†’ 60sï¼ˆé™ä½ 40%ï¼‰
- å†™å…¥å†²çªï¼šè‡ªåŠ¨æŠ¥å‘Šå’Œå¤„ç†

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å¤åˆ¶æœºåˆ¶æ”¹è¿›æ˜¾è‘—æå‡äº†å¤åˆ¶çš„æ€§èƒ½ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ï¼š

1. **é€»è¾‘å¤åˆ¶å†™å…¥å†²çªæŠ¥å‘Š**ï¼šè‡ªåŠ¨æŠ¥å‘Šå†™å…¥å†²çªï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
2. **å¹¶è¡Œæµå¼ä¼ è¾“**ï¼šé»˜è®¤ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“ï¼Œæ€§èƒ½æå‡ 40%
3. **pg_createsubscriber å·¥å…·**ï¼šç®€åŒ–è®¢é˜…åˆ›å»ºï¼Œæ”¯æŒæ‰¹é‡åˆ›å»º
4. **è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½**ï¼šè‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½ï¼Œé˜²æ­¢ WAL ç§¯ç´¯
5. **æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–**ï¼šæµå¤åˆ¶æ€§èƒ½æå‡ 30%

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨å¹¶è¡Œæµå¼ä¼ è¾“æå‡æ€§èƒ½
- é…ç½®åˆç†çš„å¹¶è¡Œåº¦
- ä½¿ç”¨ pg_createsubscriber ç®€åŒ–è®¢é˜…åˆ›å»º
- é…ç½®è‡ªåŠ¨åˆ é™¤ç©ºé—²å¤åˆ¶æ§½
- ç›‘æ§å¤åˆ¶çŠ¶æ€å’Œæ€§èƒ½

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å¤åˆ¶](https://www.postgresql.org/docs/18/high-availability.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/18/logical-replication.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æµå¤åˆ¶](https://www.postgresql.org/docs/18/warm-standby.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - pg_createsubscriber](https://www.postgresql.org/docs/18/app-pgcreatesubscriber.html)

### æŠ€æœ¯è®ºæ–‡

- [Database Replication: A Survey](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“å¤åˆ¶ç ”ç©¶
- [Consistency Models in Distributed Databases](https://www.postgresql.org/docs/current/high-availability.html) - åˆ†å¸ƒå¼æ•°æ®åº“ä¸€è‡´æ€§æ¨¡å‹

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Replication Improvements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å¤åˆ¶æ”¹è¿›
- [Understanding PostgreSQL Logical Replication](https://www.postgresql.org/docs/current/logical-replication.html) - PostgreSQL é€»è¾‘å¤åˆ¶è¯¦è§£
- [PostgreSQL Replication Best Practices](https://www.postgresql.org/docs/current/high-availability.html) - å¤åˆ¶æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Replication](https://wiki.postgresql.org/wiki/Replication) - PostgreSQL å¤åˆ¶ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Replication](https://stackoverflow.com/questions/tagged/postgresql+replication) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-22
