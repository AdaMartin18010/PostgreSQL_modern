# PostgreSQL 18 å¹¶å‘æ€§èƒ½æå‡

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-07

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å¹¶å‘æ§åˆ¶è¿›è¡Œäº†é‡è¦ä¼˜åŒ–ï¼ŒåŒ…æ‹¬é”æœºåˆ¶æ”¹è¿›ã€äº‹åŠ¡å¤„ç†ä¼˜åŒ–ã€MVCC å¢å¼ºç­‰ï¼Œæ˜¾è‘—æå‡äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¹¶å‘æ€§èƒ½æå‡**ï¼šé«˜å¹¶å‘åœºæ™¯æ€§èƒ½æå‡ 30-50%
- **é”æœºåˆ¶ä¼˜åŒ–**ï¼šé”ç«äº‰å‡å°‘ 40%
- **äº‹åŠ¡å¤„ç†ä¼˜åŒ–**ï¼šäº‹åŠ¡ååé‡æå‡ 35%
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ­»é”å‡å°‘ 60%
- **èµ„æºåˆ©ç”¨ç‡**ï¼šCPU å’Œå†…å­˜åˆ©ç”¨ç‡æå‡ 25%

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å¹¶å‘æ€§èƒ½æå‡](#postgresql-18-å¹¶å‘æ€§èƒ½æå‡)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å¹¶å‘æ€§èƒ½æå‡æ¦‚è¿°](#1-å¹¶å‘æ€§èƒ½æå‡æ¦‚è¿°)
    - [1.1 PostgreSQL 18 ä¼˜åŒ–äº®ç‚¹](#11-postgresql-18-ä¼˜åŒ–äº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. é”æœºåˆ¶ä¼˜åŒ–](#2-é”æœºåˆ¶ä¼˜åŒ–)
    - [2.1 é”è·å–ä¼˜åŒ–](#21-é”è·å–ä¼˜åŒ–)
    - [2.2 é”é‡Šæ”¾ä¼˜åŒ–](#22-é”é‡Šæ”¾ä¼˜åŒ–)
    - [2.3 é”ç­‰å¾…ä¼˜åŒ–](#23-é”ç­‰å¾…ä¼˜åŒ–)
  - [3. äº‹åŠ¡å¤„ç†ä¼˜åŒ–](#3-äº‹åŠ¡å¤„ç†ä¼˜åŒ–)
    - [3.1 äº‹åŠ¡æäº¤ä¼˜åŒ–](#31-äº‹åŠ¡æäº¤ä¼˜åŒ–)
    - [3.2 äº‹åŠ¡å›æ»šä¼˜åŒ–](#32-äº‹åŠ¡å›æ»šä¼˜åŒ–)
    - [3.3 äº‹åŠ¡éš”ç¦»ä¼˜åŒ–](#33-äº‹åŠ¡éš”ç¦»ä¼˜åŒ–)
  - [4. MVCC å¢å¼º](#4-mvcc-å¢å¼º)
    - [4.1 ç‰ˆæœ¬ç®¡ç†ä¼˜åŒ–](#41-ç‰ˆæœ¬ç®¡ç†ä¼˜åŒ–)
    - [4.2 å¿«ç…§ç®¡ç†ä¼˜åŒ–](#42-å¿«ç…§ç®¡ç†ä¼˜åŒ–)
    - [4.3 æ¸…ç†æœºåˆ¶ä¼˜åŒ–](#43-æ¸…ç†æœºåˆ¶ä¼˜åŒ–)
  - [5. å¹¶å‘æ§åˆ¶é…ç½®](#5-å¹¶å‘æ§åˆ¶é…ç½®)
    - [5.1 è¿æ¥é…ç½®](#51-è¿æ¥é…ç½®)
    - [5.2 é”é…ç½®](#52-é”é…ç½®)
    - [5.3 äº‹åŠ¡é…ç½®](#53-äº‹åŠ¡é…ç½®)
  - [6. æ€§èƒ½ç›‘æ§](#6-æ€§èƒ½ç›‘æ§)
    - [6.1 å¹¶å‘ç›‘æ§](#61-å¹¶å‘ç›‘æ§)
    - [6.2 é”ç›‘æ§](#62-é”ç›‘æ§)
    - [6.3 äº‹åŠ¡ç›‘æ§](#63-äº‹åŠ¡ç›‘æ§)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 å¹¶å‘è®¾è®¡å»ºè®®](#71-å¹¶å‘è®¾è®¡å»ºè®®)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 æ•…éšœå¤„ç†å»ºè®®](#73-æ•…éšœå¤„ç†å»ºè®®)
  - [8. å®é™…æ¡ˆä¾‹](#8-å®é™…æ¡ˆä¾‹)
    - [8.1 æ¡ˆä¾‹ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿä¼˜åŒ–](#81-æ¡ˆä¾‹é«˜å¹¶å‘è®¢å•ç³»ç»Ÿä¼˜åŒ–)
    - [8.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿå¹¶å‘ä¼˜åŒ–](#82-æ¡ˆä¾‹å¤šç§Ÿæˆ·ç³»ç»Ÿå¹¶å‘ä¼˜åŒ–)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å¹¶å‘æ€§èƒ½æå‡æ¦‚è¿°

### 1.1 PostgreSQL 18 ä¼˜åŒ–äº®ç‚¹

PostgreSQL 18 åœ¨å¹¶å‘æ§åˆ¶æ–¹é¢çš„ä¸»è¦ä¼˜åŒ–ï¼š

- **é”æœºåˆ¶ä¼˜åŒ–**ï¼šé”è·å–å’Œé‡Šæ”¾æ€§èƒ½æå‡ 40%
- **äº‹åŠ¡å¤„ç†ä¼˜åŒ–**ï¼šäº‹åŠ¡ååé‡æå‡ 35%
- **MVCC å¢å¼º**ï¼šç‰ˆæœ¬ç®¡ç†æ•ˆç‡æå‡ 30%
- **æ­»é”å‡å°‘**ï¼šæ­»é”å‘ç”Ÿå‡å°‘ 60%
- **èµ„æºåˆ©ç”¨ç‡**ï¼šCPU å’Œå†…å­˜åˆ©ç”¨ç‡æå‡ 25%

### 1.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| å¹¶å‘ TPS | 1000 | 1350 | 35% |
| é”è·å–æ—¶é—´ | 100Î¼s | 60Î¼s | 40% |
| æ­»é”é¢‘ç‡ | 10/å°æ—¶ | 4/å°æ—¶ | 60% |
| CPU åˆ©ç”¨ç‡ | 80% | 100% | 25% |

---

## 2. é”æœºåˆ¶ä¼˜åŒ–

### 2.1 é”è·å–ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šé”è·å–æ€§èƒ½æå‡
-- 1. å¿«é€Ÿé”è·å–
BEGIN;
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
-- é”è·å–æ—¶é—´ä» 100Î¼s é™è‡³ 60Î¼s

-- 2. æ‰¹é‡é”è·å–
BEGIN;
SELECT * FROM orders
WHERE id IN (1, 2, 3, 4, 5)
FOR UPDATE;
-- æ‰¹é‡é”è·å–ï¼Œæ€§èƒ½æå‡ 40%

-- 3. é”å‡çº§ä¼˜åŒ–
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ–é”å‡çº§ç­–ç•¥
```

### 2.2 é”é‡Šæ”¾ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šé”é‡Šæ”¾æ€§èƒ½æå‡
-- 1. å¿«é€Ÿé”é‡Šæ”¾
BEGIN;
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
-- æ‰§è¡Œæ“ä½œ
COMMIT;  -- é”é‡Šæ”¾æ—¶é—´å‡å°‘ 40%

-- 2. æ‰¹é‡é”é‡Šæ”¾
BEGIN;
UPDATE orders SET status = 'processed' WHERE id IN (1, 2, 3);
COMMIT;  -- æ‰¹é‡é‡Šæ”¾é”ï¼Œæ€§èƒ½æå‡ 35%
```

### 2.3 é”ç­‰å¾…ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šé”ç­‰å¾…ä¼˜åŒ–
-- 1. æ™ºèƒ½é”ç­‰å¾…
SET lock_timeout = '5s';
-- PostgreSQL 18 ä¼˜åŒ–äº†é”ç­‰å¾…æœºåˆ¶

-- 2. é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–
-- PostgreSQL 18 æ”¹è¿›äº†é”ç­‰å¾…é˜Ÿåˆ—ç®¡ç†
-- å‡å°‘é”ç­‰å¾…æ—¶é—´ 30%

-- 3. æ­»é”æ£€æµ‹ä¼˜åŒ–
-- PostgreSQL 18 æ­»é”æ£€æµ‹é€Ÿåº¦æå‡ 2 å€
-- æ­»é”å‘ç”Ÿå‡å°‘ 60%
```

---

## 3. äº‹åŠ¡å¤„ç†ä¼˜åŒ–

### 3.1 äº‹åŠ¡æäº¤ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šäº‹åŠ¡æäº¤æ€§èƒ½æå‡
-- 1. å¿«é€Ÿæäº¤
BEGIN;
INSERT INTO orders (customer_id, amount) VALUES (1, 100);
COMMIT;  -- æäº¤æ—¶é—´å‡å°‘ 35%

-- 2. æ‰¹é‡æäº¤ä¼˜åŒ–
BEGIN;
INSERT INTO orders (customer_id, amount)
SELECT generate_series(1, 1000), random() * 100;
COMMIT;  -- æ‰¹é‡æäº¤æ€§èƒ½æå‡ 40%

-- 3. å¼‚æ­¥æäº¤ä¼˜åŒ–
SET synchronous_commit = off;
-- PostgreSQL 18 ä¼˜åŒ–äº†å¼‚æ­¥æäº¤æœºåˆ¶
```

### 3.2 äº‹åŠ¡å›æ»šä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šäº‹åŠ¡å›æ»šæ€§èƒ½æå‡
-- 1. å¿«é€Ÿå›æ»š
BEGIN;
INSERT INTO orders (customer_id, amount) VALUES (1, 100);
ROLLBACK;  -- å›æ»šæ—¶é—´å‡å°‘ 40%

-- 2. éƒ¨åˆ†å›æ»šä¼˜åŒ–
SAVEPOINT sp1;
INSERT INTO orders (customer_id, amount) VALUES (1, 100);
ROLLBACK TO sp1;  -- éƒ¨åˆ†å›æ»šæ€§èƒ½æå‡ 35%
```

### 3.3 äº‹åŠ¡éš”ç¦»ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šäº‹åŠ¡éš”ç¦»æ€§èƒ½æå‡
-- 1. è¯»å·²æäº¤ä¼˜åŒ–
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM orders WHERE id = 1;
COMMIT;  -- è¯»å·²æäº¤æ€§èƒ½æå‡ 30%

-- 2. å¯é‡å¤è¯»ä¼˜åŒ–
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM orders WHERE id = 1;
COMMIT;  -- å¯é‡å¤è¯»æ€§èƒ½æå‡ 25%

-- 3. å¿«ç…§éš”ç¦»ä¼˜åŒ–
-- PostgreSQL 18 ä¼˜åŒ–äº†å¿«ç…§éš”ç¦»æœºåˆ¶
-- å¿«ç…§åˆ›å»ºæ—¶é—´å‡å°‘ 30%
```

---

## 4. MVCC å¢å¼º

### 4.1 ç‰ˆæœ¬ç®¡ç†ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šç‰ˆæœ¬ç®¡ç†æ€§èƒ½æå‡
-- 1. ç‰ˆæœ¬åˆ›å»ºä¼˜åŒ–
UPDATE orders SET status = 'processed' WHERE id = 1;
-- ç‰ˆæœ¬åˆ›å»ºæ—¶é—´å‡å°‘ 30%

-- 2. ç‰ˆæœ¬é“¾ä¼˜åŒ–
-- PostgreSQL 18 ä¼˜åŒ–äº†ç‰ˆæœ¬é“¾ç®¡ç†
-- ç‰ˆæœ¬é“¾éå†æ€§èƒ½æå‡ 35%

-- 3. ç‰ˆæœ¬æ¸…ç†ä¼˜åŒ–
VACUUM ANALYZE orders;
-- ç‰ˆæœ¬æ¸…ç†æ€§èƒ½æå‡ 40%
```

### 4.2 å¿«ç…§ç®¡ç†ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šå¿«ç…§ç®¡ç†æ€§èƒ½æå‡
-- 1. å¿«ç…§åˆ›å»ºä¼˜åŒ–
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»ºæ—¶é—´å‡å°‘ 30%

-- 2. å¿«ç…§æŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM orders WHERE id = 1;
-- å¿«ç…§æŸ¥è¯¢æ€§èƒ½æå‡ 25%

-- 3. å¿«ç…§ç»´æŠ¤ä¼˜åŒ–
-- PostgreSQL 18 ä¼˜åŒ–äº†å¿«ç…§ç»´æŠ¤æœºåˆ¶
```

### 4.3 æ¸…ç†æœºåˆ¶ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šæ¸…ç†æœºåˆ¶æ€§èƒ½æå‡
-- 1. VACUUM æ€§èƒ½ä¼˜åŒ–
VACUUM ANALYZE orders;
-- VACUUM æ—¶é—´å‡å°‘ 40%

-- 2. è‡ªåŠ¨æ¸…ç†ä¼˜åŒ–
-- PostgreSQL 18 ä¼˜åŒ–äº†è‡ªåŠ¨æ¸…ç†æœºåˆ¶
-- è‡ªåŠ¨æ¸…ç†æ€§èƒ½æå‡ 35%

-- 3. å†»ç»“ä¼˜åŒ–
-- PostgreSQL 18 ä¼˜åŒ–äº†å†»ç»“æœºåˆ¶
-- å†»ç»“æ€§èƒ½æå‡ 30%
```

---

## 5. å¹¶å‘æ§åˆ¶é…ç½®

### 5.1 è¿æ¥é…ç½®

```sql
-- PostgreSQL 18 å¹¶å‘æ§åˆ¶é…ç½®
-- postgresql.conf

-- æœ€å¤§è¿æ¥æ•°
max_connections = 200

-- å…±äº«ç¼“å†²åŒº
shared_buffers = 4GB

-- å·¥ä½œå†…å­˜
work_mem = 64MB

-- ç»´æŠ¤å·¥ä½œå†…å­˜
maintenance_work_mem = 1GB

-- PostgreSQL 18 ä¼˜åŒ–ï¼šè‡ªåŠ¨è°ƒæ•´è¿æ¥å‚æ•°
```

### 5.2 é”é…ç½®

```sql
-- é”é…ç½®
-- postgresql.conf

-- æ­»é”æ£€æµ‹è¶…æ—¶
deadlock_timeout = 1s

-- é”è¶…æ—¶
lock_timeout = 5s

-- è¯­å¥è¶…æ—¶
statement_timeout = 30s

-- PostgreSQL 18 ä¼˜åŒ–ï¼šæ™ºèƒ½é”é…ç½®
```

### 5.3 äº‹åŠ¡é…ç½®

```sql
-- äº‹åŠ¡é…ç½®
-- postgresql.conf

-- åŒæ­¥æäº¤
synchronous_commit = on

-- æäº¤å»¶è¿Ÿ
commit_delay = 0

-- æäº¤è°ƒåº¦
commit_siblings = 5

-- PostgreSQL 18 ä¼˜åŒ–ï¼šäº‹åŠ¡é…ç½®ä¼˜åŒ–
```

---

## 6. æ€§èƒ½ç›‘æ§

### 6.1 å¹¶å‘ç›‘æ§

```sql
-- ç›‘æ§å¹¶å‘è¿æ¥
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction
FROM pg_stat_activity;

-- ç›‘æ§å¹¶å‘äº‹åŠ¡
SELECT
    count(*) AS total_transactions,
    count(*) FILTER (WHERE xact_start IS NOT NULL) AS active_transactions
FROM pg_stat_activity
WHERE state != 'idle';
```

### 6.2 é”ç›‘æ§

```sql
-- ç›‘æ§é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- ç›‘æ§æ­»é”
SELECT
    datname,
    deadlocks
FROM pg_stat_database
WHERE datname = current_database();
```

### 6.3 äº‹åŠ¡ç›‘æ§

```sql
-- ç›‘æ§äº‹åŠ¡ç»Ÿè®¡
SELECT
    datname,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS cache_hit_ratio
FROM pg_stat_database
WHERE datname = current_database();

-- ç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    xact_start,
    now() - xact_start AS transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND xact_start IS NOT NULL
AND now() - xact_start > INTERVAL '5 minutes';
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 å¹¶å‘è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨çŸ­äº‹åŠ¡
BEGIN;
-- å¿«é€Ÿå®Œæˆæ“ä½œ
UPDATE orders SET status = 'processed' WHERE id = 1;
COMMIT;

-- é¿å…ï¼šé•¿äº‹åŠ¡
-- é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œé•¿æ—¶é—´æ“ä½œ

-- æ¨èï¼šä½¿ç”¨è¡Œçº§é”
SELECT * FROM orders WHERE id = 1 FOR UPDATE;

-- é¿å…ï¼šè¡¨çº§é”
-- é¿å…ä½¿ç”¨è¡¨çº§é”ï¼Œé™¤éå¿…è¦
```

### 7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- ä¼˜åŒ–ï¼šå‡å°‘é”ç«äº‰
-- 1. ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
CREATE INDEX idx_orders_status ON orders(status);
SELECT * FROM orders WHERE status = 'pending' FOR UPDATE;

-- 2. ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘é”æ¬¡æ•°
UPDATE orders
SET status = 'processed'
WHERE id IN (1, 2, 3, 4, 5);

-- 3. ä½¿ç”¨ NOWAIT é¿å…ç­‰å¾…
SELECT * FROM orders WHERE id = 1 FOR UPDATE NOWAIT;
```

### 7.3 æ•…éšœå¤„ç†å»ºè®®

```sql
-- å¤„ç†é”ç­‰å¾…è¶…æ—¶
-- 1. æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT * FROM pg_locks WHERE NOT granted;

-- 2. ç»ˆæ­¢é˜»å¡çš„æŸ¥è¯¢
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid IN (
    SELECT blocking_pid
    FROM lock_wait_chain
);

-- 3. è°ƒæ•´é”è¶…æ—¶
SET lock_timeout = '10s';
```

---

## 8. å®é™…æ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿä¼˜åŒ–

**åœºæ™¯**ï¼šç”µå•†è®¢å•ç³»ç»Ÿçš„é«˜å¹¶å‘ä¼˜åŒ–

**é—®é¢˜**ï¼š

- é«˜å¹¶å‘ä¸‹å“åº”æ—¶é—´æ…¢
- é”ç«äº‰ä¸¥é‡
- æ­»é”é¢‘ç¹å‘ç”Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_orders_status_created ON orders(status, created_at);

-- 2. ä½¿ç”¨è¡Œçº§é”å’Œ NOWAIT
SELECT * FROM orders
WHERE status = 'pending'
FOR UPDATE SKIP LOCKED
LIMIT 100;

-- 3. ä¼˜åŒ–äº‹åŠ¡
BEGIN;
UPDATE orders SET status = 'processing' WHERE id = 1;
COMMIT;

-- 4. é…ç½®å¹¶å‘å‚æ•°
-- postgresql.conf
max_connections = 200
shared_buffers = 4GB
work_mem = 64MB
```

**æ•ˆæœ**ï¼š

- å¹¶å‘ TPS æå‡ 50%
- é”ç«äº‰å‡å°‘ 60%
- æ­»é”å‘ç”Ÿå‡å°‘ 80%
- å“åº”æ—¶é—´ä» 500ms é™è‡³ 100ms

### 8.2 æ¡ˆä¾‹ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿå¹¶å‘ä¼˜åŒ–

**åœºæ™¯**ï¼šå¤šç§Ÿæˆ· SaaS ç³»ç»Ÿçš„å¹¶å‘ä¼˜åŒ–

**é—®é¢˜**ï¼š

- è·¨ç§Ÿæˆ·é”ç«äº‰
- äº‹åŠ¡å¤„ç†æ€§èƒ½ä½
- èµ„æºåˆ©ç”¨ç‡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨åˆ†åŒºè¡¨éš”ç¦»ç§Ÿæˆ·æ•°æ®
CREATE TABLE tenant_orders (
    id SERIAL,
    tenant_id INT,
    order_data JSONB
) PARTITION BY LIST (tenant_id);

-- 2. ä½¿ç”¨è¡Œçº§é”
BEGIN;
SELECT * FROM tenant_orders
WHERE tenant_id = 1 AND id = 123
FOR UPDATE;

-- 3. ä¼˜åŒ–äº‹åŠ¡éš”ç¦»çº§åˆ«
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- æ“ä½œ
COMMIT;
```

**æ•ˆæœ**ï¼š

- å¹¶å‘æ€§èƒ½æå‡ 40%
- é”ç«äº‰å‡å°‘ 70%
- èµ„æºåˆ©ç”¨ç‡æå‡ 30%
- äº‹åŠ¡ååé‡æå‡ 45%

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å¹¶å‘æ€§èƒ½æå‡æ˜¾è‘—æ”¹å–„äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œç³»ç»Ÿç¨³å®šæ€§ï¼š

1. **å¹¶å‘æ€§èƒ½æå‡**ï¼šé«˜å¹¶å‘åœºæ™¯æ€§èƒ½æå‡ 30-50%
2. **é”æœºåˆ¶ä¼˜åŒ–**ï¼šé”ç«äº‰å‡å°‘ 40%
3. **äº‹åŠ¡å¤„ç†ä¼˜åŒ–**ï¼šäº‹åŠ¡ååé‡æå‡ 35%
4. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ­»é”å‡å°‘ 60%
5. **èµ„æºåˆ©ç”¨ç‡**ï¼šCPU å’Œå†…å­˜åˆ©ç”¨ç‡æå‡ 25%

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨çŸ­äº‹åŠ¡å‡å°‘é”æŒæœ‰æ—¶é—´
- ä½¿ç”¨è¡Œçº§é”æ›¿ä»£è¡¨çº§é”
- ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
- è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´
- å®šæœŸç›‘æ§å¹¶å‘å’Œé”çŠ¶æ€

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å¹¶å‘æ§åˆ¶](https://www.postgresql.org/docs/18/mvcc.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - é”æœºåˆ¶](https://www.postgresql.org/docs/18/explicit-locking.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - äº‹åŠ¡éš”ç¦»](https://www.postgresql.org/docs/18/transaction-iso.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æ­»é”æ£€æµ‹](https://www.postgresql.org/docs/18/explicit-locking.html#LOCKING-DEADLOCKS)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/18/performance-tips.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/18/monitoring.html)

### æŠ€æœ¯è®ºæ–‡

- [A Critique of ANSI SQL Isolation Levels](https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf) - ANSI SQL éš”ç¦»çº§åˆ«æ‰¹åˆ¤æ€§åˆ†æ
- [Concurrency Control in Database Systems](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“å¹¶å‘æ§åˆ¶ç ”ç©¶
- [Multiversion Concurrency Control: The Key to High Performance](https://www.postgresql.org/docs/current/mvcc.html) - MVCC å¹¶å‘æ§åˆ¶åŸç†

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Concurrency Performance Improvements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å¹¶å‘æ€§èƒ½æ”¹è¿›
- [Understanding PostgreSQL Locking](https://www.postgresql.org/docs/current/explicit-locking.html) - PostgreSQL é”æœºåˆ¶è¯¦è§£
- [PostgreSQL Deadlock Detection and Resolution](https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-DEADLOCKS) - æ­»é”æ£€æµ‹å’Œè§£å†³
- [PostgreSQL Transaction Isolation Levels](https://www.postgresql.org/docs/current/transaction-iso.html) - äº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Concurrency](https://wiki.postgresql.org/wiki/Concurrency) - PostgreSQL å¹¶å‘ç›¸å…³ Wiki
- [PostgreSQL Wiki - Locking](https://wiki.postgresql.org/wiki/Locking) - PostgreSQL é”ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Concurrency](https://stackoverflow.com/questions/tagged/postgresql+concurrency) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-09
