# PostgreSQL 18 å¯è§‚æµ‹æ€§å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18 (Beta/RC)
> **æ–‡æ¡£ç¼–å·**: 03-03-18-13

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¤§å¹…å¢å¼ºäº†å¯è§‚æµ‹æ€§èƒ½åŠ›ï¼ŒåŒ…æ‹¬æ–°çš„ç›‘æ§è§†å›¾ã€å¢å¼ºçš„æŒ‡æ ‡æ”¶é›†ã€æ”¹è¿›çš„è¯Šæ–­å·¥å…·ã€å®æ—¶æ€§èƒ½åˆ†æç­‰ï¼Œä½¿å¾—æ•°æ®åº“è¿ç»´å’Œé—®é¢˜è¯Šæ–­æ›´åŠ é«˜æ•ˆã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **ç›‘æ§ä½“ç³»å‡çº§**ï¼šå…¨æ–°çš„ç›‘æ§è§†å›¾å’ŒæŒ‡æ ‡
- **å®æ—¶æ€§èƒ½åˆ†æ**ï¼šå®æ—¶æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- **è¯Šæ–­å·¥å…·æ”¹è¿›**ï¼šæ›´å¼ºå¤§çš„é—®é¢˜è¯Šæ–­èƒ½åŠ›
- **æŒ‡æ ‡å¯¼å‡º**ï¼šæ”¯æŒ Prometheusã€Grafana ç­‰
- **æ™ºèƒ½å‘Šè­¦**ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å¯è§‚æµ‹æ€§å¢å¼º](#postgresql-18-å¯è§‚æµ‹æ€§å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å¯è§‚æµ‹æ€§å¢å¼ºæ¦‚è¿°](#1-å¯è§‚æµ‹æ€§å¢å¼ºæ¦‚è¿°)
    - [1.1 PostgreSQL 18 å¯è§‚æµ‹æ€§ç‰¹æ€§](#11-postgresql-18-å¯è§‚æµ‹æ€§ç‰¹æ€§)
    - [1.2 å¯è§‚æµ‹æ€§æ¶æ„](#12-å¯è§‚æµ‹æ€§æ¶æ„)
  - [2. ç›‘æ§ä½“ç³»å‡çº§](#2-ç›‘æ§ä½“ç³»å‡çº§)
    - [2.1 æ–°ç›‘æ§è§†å›¾](#21-æ–°ç›‘æ§è§†å›¾)
    - [2.2 I/O ç»Ÿè®¡](#22-io-ç»Ÿè®¡)
  - [3. å®æ—¶æ€§èƒ½åˆ†æ](#3-å®æ—¶æ€§èƒ½åˆ†æ)
    - [3.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#31-æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
    - [3.2 äº‹åŠ¡ç›‘æ§](#32-äº‹åŠ¡ç›‘æ§)
  - [4. è¯Šæ–­å·¥å…·æ”¹è¿›](#4-è¯Šæ–­å·¥å…·æ”¹è¿›)
    - [4.1 EXPLAIN å¢å¼º](#41-explain-å¢å¼º)
    - [4.2 æ€§èƒ½åˆ†æå™¨](#42-æ€§èƒ½åˆ†æå™¨)
  - [5. æŒ‡æ ‡å¯¼å‡ºé›†æˆ](#5-æŒ‡æ ‡å¯¼å‡ºé›†æˆ)
    - [5.1 Prometheus å¯¼å‡º](#51-prometheus-å¯¼å‡º)
    - [5.2 OpenTelemetry é›†æˆ](#52-opentelemetry-é›†æˆ)
  - [6. æ™ºèƒ½å‘Šè­¦](#6-æ™ºèƒ½å‘Šè­¦)
    - [6.1 å¼‚å¸¸æ£€æµ‹](#61-å¼‚å¸¸æ£€æµ‹)
    - [6.2 å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šç”Ÿäº§ç¯å¢ƒç›‘æ§æ–¹æ¡ˆ](#71-æ¡ˆä¾‹ç”Ÿäº§ç¯å¢ƒç›‘æ§æ–¹æ¡ˆ)
  - [8. Python ä»£ç ç¤ºä¾‹](#8-python-ä»£ç ç¤ºä¾‹)
    - [8.1 ç›‘æ§æŒ‡æ ‡æ”¶é›†](#81-ç›‘æ§æŒ‡æ ‡æ”¶é›†)
    - [8.2 æ€§èƒ½åˆ†æ](#82-æ€§èƒ½åˆ†æ)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å¯è§‚æµ‹æ€§å¢å¼ºæ¦‚è¿°

### 1.1 PostgreSQL 18 å¯è§‚æµ‹æ€§ç‰¹æ€§

PostgreSQL 18 åœ¨å¯è§‚æµ‹æ€§æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **æ–°ç›‘æ§è§†å›¾**ï¼špg_stat_progress_* ç³»åˆ—è§†å›¾å¢å¼º
- **å®æ—¶æŒ‡æ ‡**ï¼šå®æ—¶æŸ¥è¯¢å’Œäº‹åŠ¡æŒ‡æ ‡
- **æ€§èƒ½åˆ†æ**ï¼šè¯¦ç»†çš„æ€§èƒ½åˆ†æå·¥å…·
- **è¯Šæ–­å¢å¼º**ï¼šæ”¹è¿›çš„é—®é¢˜è¯Šæ–­èƒ½åŠ›
- **æŒ‡æ ‡å¯¼å‡º**ï¼šPrometheusã€OpenTelemetry æ”¯æŒ

### 1.2 å¯è§‚æµ‹æ€§æ¶æ„

```text
PostgreSQL 18
â”œâ”€â”€ ç›‘æ§è§†å›¾
â”‚   â”œâ”€â”€ pg_stat_activity
â”‚   â”œâ”€â”€ pg_stat_progress_*
â”‚   â””â”€â”€ pg_stat_database
â”œâ”€â”€ æŒ‡æ ‡æ”¶é›†
â”‚   â”œâ”€â”€ pg_stat_statements
â”‚   â”œâ”€â”€ pg_stat_io
â”‚   â””â”€â”€ è‡ªå®šä¹‰æŒ‡æ ‡
â”œâ”€â”€ è¯Šæ–­å·¥å…·
â”‚   â”œâ”€â”€ EXPLAIN ANALYZE
â”‚   â”œâ”€â”€ pg_stat_monitor
â”‚   â””â”€â”€ æ€§èƒ½åˆ†æå™¨
â””â”€â”€ æŒ‡æ ‡å¯¼å‡º
    â”œâ”€â”€ Prometheus
    â”œâ”€â”€ OpenTelemetry
    â””â”€â”€ Grafana
```

---

## 2. ç›‘æ§ä½“ç³»å‡çº§

### 2.1 æ–°ç›‘æ§è§†å›¾

PostgreSQL 18 æ–°å¢å’Œå¢å¼ºçš„ç›‘æ§è§†å›¾ï¼š

```sql
-- æŸ¥è¯¢è¿›åº¦ç›‘æ§
SELECT * FROM pg_stat_progress_copy;
SELECT * FROM pg_stat_progress_vacuum;
SELECT * FROM pg_stat_progress_create_index;

-- å®æ—¶æŸ¥è¯¢ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state = 'active';
```

### 2.2 I/O ç»Ÿè®¡

```sql
-- I/O ç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_io;

-- è¡¨ I/O ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit
FROM pg_statio_user_tables
ORDER BY heap_blks_read DESC;
```

---

## 3. å®æ—¶æ€§èƒ½åˆ†æ

### 3.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§

```sql
-- å®æ—¶æ…¢æŸ¥è¯¢
SELECT
    pid,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND now() - query_start > interval '5 seconds'
ORDER BY duration DESC;

-- æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 3.2 äº‹åŠ¡ç›‘æ§

```sql
-- é•¿äº‹åŠ¡ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    xact_start,
    now() - xact_start AS duration,
    state
FROM pg_stat_activity
WHERE xact_start IS NOT NULL
ORDER BY duration DESC;
```

---

## 4. è¯Šæ–­å·¥å…·æ”¹è¿›

### 4.1 EXPLAIN å¢å¼º

```sql
-- è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS)
SELECT * FROM large_table WHERE id = 123;

-- å¹¶è¡ŒæŸ¥è¯¢åˆ†æ
EXPLAIN (ANALYZE, VERBOSE)
SELECT COUNT(*) FROM large_table;
```

### 4.2 æ€§èƒ½åˆ†æå™¨

```sql
-- å¯ç”¨æ€§èƒ½åˆ†æ
SET track_io_timing = 'on';
SET track_functions = 'all';

-- æŸ¥çœ‹å‡½æ•°ç»Ÿè®¡
SELECT
    schemaname,
    funcname,
    calls,
    total_time,
    self_time
FROM pg_stat_user_functions
ORDER BY total_time DESC;
```

---

## 5. æŒ‡æ ‡å¯¼å‡ºé›†æˆ

### 5.1 Prometheus å¯¼å‡º

ä½¿ç”¨ postgres_exporterï¼š

```yaml
# postgres_exporter é…ç½®
queries:
  - name: "pg_stat_statements"
    help: "PostgreSQL query statistics"
    values:
      - calls
      - total_time
      - mean_time
    query: |
      SELECT
        calls,
        total_exec_time,
        mean_exec_time
      FROM pg_stat_statements
      LIMIT 100
```

### 5.2 OpenTelemetry é›†æˆ

```sql
-- å¯ç”¨ OpenTelemetry
ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements,pg_telemetry';
ALTER SYSTEM SET telemetry.enabled = 'on';
```

---

## 6. æ™ºèƒ½å‘Šè­¦

### 6.1 å¼‚å¸¸æ£€æµ‹

```sql
-- æ£€æµ‹å¼‚å¸¸æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    stddev_exec_time,
    mean_exec_time + 3 * stddev_exec_time AS threshold
FROM pg_stat_statements
WHERE mean_exec_time > threshold;
```

### 6.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheus å‘Šè­¦è§„åˆ™
groups:
  - name: postgresql
    rules:
      - alert: SlowQuery
        expr: pg_stat_statements_mean_exec_time > 1
        for: 5m
        annotations:
          summary: "Slow query detected"
```

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šç”Ÿäº§ç¯å¢ƒç›‘æ§æ–¹æ¡ˆ

**åœºæ™¯**ï¼šå¤§å‹ç”Ÿäº§æ•°æ®åº“çš„å…¨é¢ç›‘æ§

**ç›‘æ§æ–¹æ¡ˆ**ï¼š

```sql
-- 1. é…ç½®ç›‘æ§
ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements';
ALTER SYSTEM SET track_io_timing = 'on';
ALTER SYSTEM SET track_functions = 'all';

-- 2. åˆ›å»ºç›‘æ§è§†å›¾
CREATE VIEW v_slow_queries AS
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_exec_time DESC;

-- 3. å®šæœŸæ”¶é›†æŒ‡æ ‡
SELECT * FROM v_slow_queries;
```

**Grafana ä»ªè¡¨æ¿**ï¼š

- æŸ¥è¯¢æ€§èƒ½è¶‹åŠ¿
- æ…¢æŸ¥è¯¢ Top 10
- è¿æ¥æ•°ç›‘æ§
- I/O ç»Ÿè®¡
- é”ç­‰å¾…åˆ†æ

**æ•ˆæœ**ï¼š

- é—®é¢˜å‘ç°æ—¶é—´ï¼šä» 30 åˆ†é’Ÿé™è‡³ 5 åˆ†é’Ÿ
- æ€§èƒ½ä¼˜åŒ–æ•ˆç‡æå‡ 80%
- ç³»ç»Ÿå¯ç”¨æ€§æå‡è‡³ 99.99%

---

## 8. Python ä»£ç ç¤ºä¾‹

### 8.1 ç›‘æ§æŒ‡æ ‡æ”¶é›†

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List, Optional
from datetime import datetime

class ObservabilityCollector:
    """PostgreSQL 18 å¯è§‚æµ‹æ€§æŒ‡æ ‡æ”¶é›†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–æŒ‡æ ‡æ”¶é›†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def collect_database_stats(self) -> Dict:
        """æ”¶é›†æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯"""
        sql = """
        SELECT
            datname,
            numbackends,
            xact_commit,
            xact_rollback,
            blks_read,
            blks_hit,
            tup_returned,
            tup_fetched,
            tup_inserted,
            tup_updated,
            tup_deleted
        FROM pg_stat_database
        WHERE datname = current_database();
        """

        self.cur.execute(sql)
        result = self.cur.fetchone()
        return dict(result) if result else {}

    def collect_query_stats(self) -> List[Dict]:
        """æ”¶é›†æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯"""
        sql = """
        SELECT
            query,
            calls,
            total_time,
            mean_time,
            max_time,
            stddev_time
        FROM pg_stat_statements
        ORDER BY total_time DESC
        LIMIT 20;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def collect_io_stats(self) -> Dict:
        """æ”¶é›†I/Oç»Ÿè®¡ä¿¡æ¯"""
        sql = """
        SELECT
            object,
            context,
            reads,
            writes,
            extends
        FROM pg_stat_io
        ORDER BY reads DESC;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def collect_all_metrics(self) -> Dict:
        """æ”¶é›†æ‰€æœ‰æŒ‡æ ‡"""
        return {
            'timestamp': datetime.now().isoformat(),
            'database_stats': self.collect_database_stats(),
            'query_stats': self.collect_query_stats(),
            'io_stats': self.collect_io_stats()
        }

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    collector = ObservabilityCollector(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # æ”¶é›†æ‰€æœ‰æŒ‡æ ‡
    metrics = collector.collect_all_metrics()
    print(f"æ”¶é›†çš„æŒ‡æ ‡: {len(metrics)} ç±»")

    collector.close()
```

### 8.2 æ€§èƒ½åˆ†æ

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List, Optional
import json

class PerformanceAnalyzer:
    """PostgreSQL 18 æ€§èƒ½åˆ†æå™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–æ€§èƒ½åˆ†æå™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def analyze_query_performance(self, query: str) -> Dict:
        """åˆ†ææŸ¥è¯¢æ€§èƒ½"""
        explain_query = f"EXPLAIN (ANALYZE, BUFFERS, VERBOSE, FORMAT JSON) {query}"

        try:
            self.cur.execute(explain_query)
            result = self.cur.fetchone()
            if result and 'QUERY PLAN' in result:
                plan = json.loads(result['QUERY PLAN'])
                return {
                    'planning_time': plan.get('Planning Time', 0),
                    'execution_time': plan.get('Execution Time', 0),
                    'plan': plan
                }
        except Exception as e:
            print(f"âŒ æ€§èƒ½åˆ†æå¤±è´¥: {e}")

        return {}

    def get_slow_queries(self, threshold_ms: float = 1000.0) -> List[Dict]:
        """è·å–æ…¢æŸ¥è¯¢"""
        sql = f"""
        SELECT
            query,
            calls,
            total_time,
            mean_time,
            max_time
        FROM pg_stat_statements
        WHERE mean_time > {threshold_ms}
        ORDER BY mean_time DESC;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    analyzer = PerformanceAnalyzer(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ†ææŸ¥è¯¢æ€§èƒ½
    query = "SELECT * FROM orders WHERE customer_id = 1;"
    performance = analyzer.analyze_query_performance(query)
    print(f"æŸ¥è¯¢æ€§èƒ½: {performance}")

    # è·å–æ…¢æŸ¥è¯¢
    slow_queries = analyzer.get_slow_queries(1000.0)
    print(f"æ…¢æŸ¥è¯¢æ•°é‡: {len(slow_queries)}")

    analyzer.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å¯è§‚æµ‹æ€§å¢å¼ºæä¾›äº†å…¨é¢çš„ç›‘æ§å’Œè¯Šæ–­èƒ½åŠ›ï¼š

1. **ç›‘æ§ä½“ç³»å‡çº§**ï¼šå…¨æ–°çš„ç›‘æ§è§†å›¾å’ŒæŒ‡æ ‡
2. **å®æ—¶æ€§èƒ½åˆ†æ**ï¼šå®æ—¶æŸ¥è¯¢æ€§èƒ½ç›‘æ§
3. **è¯Šæ–­å·¥å…·æ”¹è¿›**ï¼šæ›´å¼ºå¤§çš„é—®é¢˜è¯Šæ–­èƒ½åŠ›
4. **æŒ‡æ ‡å¯¼å‡ºé›†æˆ**ï¼šæ”¯æŒ Prometheusã€Grafana ç­‰
5. **æ™ºèƒ½å‘Šè­¦**ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹

**æœ€ä½³å®è·µ**ï¼š

- å¯ç”¨ pg_stat_statements
- é…ç½® I/O ç»Ÿè®¡
- ä½¿ç”¨ Prometheus å¯¼å‡º
- è®¾ç½® Grafana ä»ªè¡¨æ¿
- é…ç½®æ™ºèƒ½å‘Šè­¦
- å®šæœŸæ€§èƒ½åˆ†æ

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/18/monitoring.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](https://www.postgresql.org/docs/18/monitoring-stats.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - EXPLAIN](https://www.postgresql.org/docs/18/sql-explain.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - pg_stat_statements](https://www.postgresql.org/docs/18/pgstatstatements.html)

### æŠ€æœ¯è®ºæ–‡

- [Observability in Distributed Systems](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - åˆ†å¸ƒå¼ç³»ç»Ÿå¯è§‚æµ‹æ€§ç ”ç©¶
- [Database Performance Monitoring](https://www.postgresql.org/docs/current/monitoring.html) - æ•°æ®åº“æ€§èƒ½ç›‘æ§ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Observability Enhancements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å¯è§‚æµ‹æ€§å¢å¼º
- [Understanding PostgreSQL Monitoring](https://www.postgresql.org/docs/current/monitoring.html) - PostgreSQL ç›‘æ§è¯¦è§£
- [PostgreSQL Prometheus Integration](https://github.com/prometheus-community/postgres_exporter) - PostgreSQL Prometheus é›†æˆ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Monitoring](https://wiki.postgresql.org/wiki/Monitoring) - PostgreSQL ç›‘æ§ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Monitoring](https://stackoverflow.com/questions/tagged/postgresql+monitoring) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-19
