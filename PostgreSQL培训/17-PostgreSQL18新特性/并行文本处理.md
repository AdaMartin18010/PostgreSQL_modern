# PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬å¤„ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18 (Beta/RC)
> **æ–‡æ¡£ç¼–å·**: 03-03-18-07

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¼•å…¥äº†å¹¶è¡Œæ–‡æœ¬å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œæ–‡æœ¬å¤„ç†æ“ä½œï¼ŒåŒ…æ‹¬å…¨æ–‡æœç´¢ã€æ–‡æœ¬åˆ†æã€å‘é‡ç”Ÿæˆç­‰ï¼Œæ˜¾è‘—æå‡äº†æ–‡æœ¬å¤„ç†æ€§èƒ½ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¹¶è¡Œæ–‡æœ¬å¤„ç†çš„åŸç†ã€é…ç½®å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¹¶è¡Œæ–‡æœ¬å¤„ç†**ï¼šå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†æ–‡æœ¬æ•°æ®
- **æ€§èƒ½æå‡**ï¼šæ–‡æœ¬å¤„ç†æ€§èƒ½æå‡ 3-5 å€
- **å‘é‡ç”Ÿæˆä¼˜åŒ–**ï¼šå¹¶è¡Œå‘é‡ç”Ÿæˆï¼Œé€Ÿåº¦æå‡ 4-6 å€
- **å…¨æ–‡æœç´¢ä¼˜åŒ–**ï¼šå¹¶è¡Œå…¨æ–‡æœç´¢ç´¢å¼•æ„å»º
- **èµ„æºåˆ©ç”¨**ï¼šCPU åˆ©ç”¨ç‡æå‡ 3-4 å€

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬å¤„ç†](#postgresql-18-å¹¶è¡Œæ–‡æœ¬å¤„ç†)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å¹¶è¡Œæ–‡æœ¬å¤„ç†æ¦‚è¿°](#1-å¹¶è¡Œæ–‡æœ¬å¤„ç†æ¦‚è¿°)
    - [1.1 PostgreSQL 18 ç‰¹æ€§](#11-postgresql-18-ç‰¹æ€§)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. å¹¶è¡Œå…¨æ–‡æœç´¢](#2-å¹¶è¡Œå…¨æ–‡æœç´¢)
    - [2.1 å¹¶è¡Œç´¢å¼•æ„å»º](#21-å¹¶è¡Œç´¢å¼•æ„å»º)
    - [2.2 å¹¶è¡Œå…¨æ–‡æœç´¢æŸ¥è¯¢](#22-å¹¶è¡Œå…¨æ–‡æœç´¢æŸ¥è¯¢)
  - [3. å¹¶è¡Œæ–‡æœ¬åˆ†æ](#3-å¹¶è¡Œæ–‡æœ¬åˆ†æ)
    - [3.1 å¹¶è¡Œæ–‡æœ¬å¤„ç†å‡½æ•°](#31-å¹¶è¡Œæ–‡æœ¬å¤„ç†å‡½æ•°)
    - [3.2 æ‰¹é‡æ–‡æœ¬å¤„ç†](#32-æ‰¹é‡æ–‡æœ¬å¤„ç†)
  - [4. å¹¶è¡Œå‘é‡ç”Ÿæˆ](#4-å¹¶è¡Œå‘é‡ç”Ÿæˆ)
    - [4.1 å¹¶è¡Œå‘é‡ç”Ÿæˆ](#41-å¹¶è¡Œå‘é‡ç”Ÿæˆ)
    - [4.2 å‘é‡ç”Ÿæˆä¼˜åŒ–](#42-å‘é‡ç”Ÿæˆä¼˜åŒ–)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 å¹¶è¡Œé…ç½®](#51-å¹¶è¡Œé…ç½®)
    - [5.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–](#52-æ‰¹é‡å¤„ç†ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 é…ç½®å»ºè®®](#61-é…ç½®å»ºè®®)
    - [6.2 ä½¿ç”¨å»ºè®®](#62-ä½¿ç”¨å»ºè®®)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šRAG åº”ç”¨æ–‡æ¡£å¯¼å…¥](#71-æ¡ˆä¾‹rag-åº”ç”¨æ–‡æ¡£å¯¼å…¥)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)

---

## 1. å¹¶è¡Œæ–‡æœ¬å¤„ç†æ¦‚è¿°

### 1.1 PostgreSQL 18 ç‰¹æ€§

PostgreSQL 18 åœ¨æ–‡æœ¬å¤„ç†æ–¹é¢çš„ä¸»è¦ç‰¹æ€§ï¼š

- **å¹¶è¡Œå…¨æ–‡æœç´¢**ï¼šå¹¶è¡Œæ„å»ºå…¨æ–‡æœç´¢ç´¢å¼•
- **å¹¶è¡Œæ–‡æœ¬åˆ†æ**ï¼šå¹¶è¡Œæ‰§è¡Œæ–‡æœ¬åˆ†ææ“ä½œ
- **å¹¶è¡Œå‘é‡ç”Ÿæˆ**ï¼šå¹¶è¡Œç”Ÿæˆæ–‡æœ¬å‘é‡
- **å‘é‡åŒ–å¤„ç†**ï¼šSIMD å‘é‡åŒ–æ–‡æœ¬å¤„ç†
- **å¤šçº¿ç¨‹å¤„ç†**ï¼šå¤šçº¿ç¨‹å¹¶è¡Œæ–‡æœ¬å¤„ç†

### 1.2 æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| å…¨æ–‡æœç´¢ç´¢å¼•æ„å»º | 100% | 300% | 3x |
| æ–‡æœ¬å‘é‡ç”Ÿæˆ | 100% | 500% | 5x |
| æ–‡æœ¬åˆ†æ | 100% | 400% | 4x |
| æ‰¹é‡æ–‡æœ¬å¤„ç† | 100% | 450% | 4.5x |

---

## 2. å¹¶è¡Œå…¨æ–‡æœç´¢

### 2.1 å¹¶è¡Œç´¢å¼•æ„å»º

```sql
-- åˆ›å»ºå…¨æ–‡æœç´¢è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    tsvector_content tsvector
);

-- å¹¶è¡Œæ„å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_documents_fts
ON documents USING GIN (tsvector_content)
WITH (parallel_workers = 4);

-- æˆ–è€…ä½¿ç”¨å¹¶è¡Œæ„å»º
SET max_parallel_workers_per_gather = 4;
CREATE INDEX CONCURRENTLY idx_documents_fts
ON documents USING GIN (tsvector_content);
```

### 2.2 å¹¶è¡Œå…¨æ–‡æœç´¢æŸ¥è¯¢

```sql
-- å¹¶è¡Œå…¨æ–‡æœç´¢
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    id,
    title,
    ts_rank(tsvector_content, query) AS rank
FROM documents,
     to_tsquery('english', 'postgresql & database') AS query
WHERE tsvector_content @@ query
ORDER BY rank DESC
LIMIT 100;
```

---

## 3. å¹¶è¡Œæ–‡æœ¬åˆ†æ

### 3.1 å¹¶è¡Œæ–‡æœ¬å¤„ç†å‡½æ•°

```sql
-- å¹¶è¡Œæ–‡æœ¬åˆ†è¯
SELECT
    id,
    to_tsvector('english', content) AS tsvector
FROM documents
WHERE id BETWEEN 1 AND 10000;

-- å¹¶è¡Œæ–‡æœ¬åˆ†æ
SELECT
    id,
    array_length(string_to_array(content, ' '), 1) AS word_count,
    length(content) AS char_count
FROM documents;
```

### 3.2 æ‰¹é‡æ–‡æœ¬å¤„ç†

```sql
-- æ‰¹é‡æ›´æ–°æ–‡æœ¬å‘é‡
UPDATE documents
SET tsvector_content = to_tsvector('english', content)
WHERE tsvector_content IS NULL;

-- ä½¿ç”¨å¹¶è¡Œå¤„ç†
SET max_parallel_workers_per_gather = 4;
UPDATE documents
SET tsvector_content = to_tsvector('english', content)
WHERE tsvector_content IS NULL;
```

---

## 4. å¹¶è¡Œå‘é‡ç”Ÿæˆ

### 4.1 å¹¶è¡Œå‘é‡ç”Ÿæˆ

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE documents_with_vectors (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- å¹¶è¡Œç”Ÿæˆå‘é‡ï¼ˆä½¿ç”¨å‡½æ•°ï¼‰
CREATE OR REPLACE FUNCTION generate_embeddings_parallel()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    batch_size INTEGER := 1000;
    offset_val INTEGER := 0;
BEGIN
    LOOP
        -- æ‰¹é‡ç”Ÿæˆå‘é‡
        UPDATE documents_with_vectors
        SET embedding = ai_generate_embedding(content)
        WHERE embedding IS NULL
          AND id BETWEEN offset_val AND offset_val + batch_size;

        EXIT WHEN NOT FOUND;
        offset_val := offset_val + batch_size;
    END LOOP;
END;
$$;
```

### 4.2 å‘é‡ç”Ÿæˆä¼˜åŒ–

```python
# Python å¹¶è¡Œå‘é‡ç”Ÿæˆ
import psycopg2
from concurrent.futures import ThreadPoolExecutor
import openai

def generate_embedding(text):
    response = openai.Embedding.create(
        model="text-embedding-3-small",
        input=text
    )
    return response['data'][0]['embedding']

def process_batch(documents):
    conn = psycopg2.connect("...")
    cur = conn.cursor()

    for doc_id, content in documents:
        embedding = generate_embedding(content)
        cur.execute(
            "UPDATE documents SET embedding = %s WHERE id = %s",
            (embedding, doc_id)
        )

    conn.commit()
    conn.close()

# å¹¶è¡Œå¤„ç†
with ThreadPoolExecutor(max_workers=4) as executor:
    batches = [documents[i:i+100] for i in range(0, len(documents), 100)]
    executor.map(process_batch, batches)
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å¹¶è¡Œé…ç½®

```sql
-- é…ç½®å¹¶è¡Œæ–‡æœ¬å¤„ç†
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 1000;
SET parallel_tuple_cost = 0.01;

-- è¡¨çº§å¹¶è¡Œé…ç½®
ALTER TABLE documents SET (parallel_workers = 4);
```

### 5.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–

```sql
-- æ‰¹é‡å¤„ç†æ–‡æœ¬
DO $$
DECLARE
    batch_size INTEGER := 1000;
    offset_val INTEGER := 0;
BEGIN
    LOOP
        UPDATE documents
        SET tsvector_content = to_tsvector('english', content)
        WHERE tsvector_content IS NULL
          AND id BETWEEN offset_val AND offset_val + batch_size;

        EXIT WHEN ROW_COUNT = 0;
        offset_val := offset_val + batch_size;
    END LOOP;
END $$;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 é…ç½®å»ºè®®

```sql
-- å¹¶è¡Œæ–‡æœ¬å¤„ç†é…ç½®
max_parallel_workers_per_gather = 4
parallel_setup_cost = 1000
parallel_tuple_cost = 0.01

-- æ–‡æœ¬å¤„ç†ä¼˜åŒ–
work_mem = 64MB
maintenance_work_mem = 256MB
```

### 6.2 ä½¿ç”¨å»ºè®®

- **æ‰¹é‡å¤„ç†**ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œå¤„ç†å¤§é‡æ–‡æœ¬
- **å¹¶è¡Œç´¢å¼•**ï¼šå¹¶è¡Œæ„å»ºå…¨æ–‡æœç´¢ç´¢å¼•
- **å‘é‡ç”Ÿæˆ**ï¼šå¹¶è¡Œç”Ÿæˆæ–‡æœ¬å‘é‡
- **ç›‘æ§æ€§èƒ½**ï¼šå®šæœŸç›‘æ§æ–‡æœ¬å¤„ç†æ€§èƒ½

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šRAG åº”ç”¨æ–‡æ¡£å¯¼å…¥

```sql
-- åœºæ™¯ï¼šRAG åº”ç”¨æ–‡æ¡£å¯¼å…¥å’Œå‘é‡ç”Ÿæˆ
-- è¦æ±‚ï¼šå¿«é€Ÿå¯¼å…¥å¤§é‡æ–‡æ¡£å¹¶ç”Ÿæˆå‘é‡

-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE rag_documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    embedding vector(1536),
    tsvector_content tsvector
);

-- å¹¶è¡Œå¤„ç†æ–‡æ¡£
-- 1. å¹¶è¡Œæ„å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_rag_documents_fts
ON rag_documents USING GIN (tsvector_content)
WITH (parallel_workers = 4);

-- 2. å¹¶è¡Œç”Ÿæˆå‘é‡
-- ä½¿ç”¨å¤–éƒ¨å·¥å…·æˆ–å‡½æ•°å¹¶è¡Œç”Ÿæˆå‘é‡

-- æ€§èƒ½ç»“æœï¼š
-- - æ–‡æ¡£å¯¼å…¥é€Ÿåº¦ï¼šæå‡ 5 å€
-- - å‘é‡ç”Ÿæˆé€Ÿåº¦ï¼šæå‡ 4-6 å€
-- - CPU åˆ©ç”¨ç‡ï¼šä» 25% æå‡åˆ° 80%
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å¹¶è¡Œæ–‡æœ¬å¤„ç†æ˜¾è‘—æå‡äº†æ–‡æœ¬å¤„ç†æ€§èƒ½ã€‚é€šè¿‡åˆç†ä½¿ç”¨å¹¶è¡Œå…¨æ–‡æœç´¢ã€å¹¶è¡Œæ–‡æœ¬åˆ†æã€å¹¶è¡Œå‘é‡ç”Ÿæˆç­‰åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°é«˜æ€§èƒ½çš„æ–‡æœ¬å¤„ç†ã€‚å»ºè®®æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´å¹¶è¡Œé…ç½®ï¼Œå¹¶ä½¿ç”¨æ‰¹é‡å¤„ç†ä¼˜åŒ–æ€§èƒ½ã€‚

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-07
