# PostgreSQL 18 å¤šç§Ÿæˆ·å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-12

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å¤šç§Ÿæˆ·åŠŸèƒ½è¿›è¡Œäº†é‡è¦å¢å¼ºï¼ŒåŒ…æ‹¬è¡Œçº§å®‰å…¨ç­–ç•¥æ”¹è¿›ã€èµ„æºéš”ç¦»å¢å¼ºã€ç§Ÿæˆ·ç®¡ç†ä¼˜åŒ–ã€æ€§èƒ½ä¼˜åŒ–ç­‰åŠŸèƒ½ï¼Œä½¿ PostgreSQL èƒ½å¤Ÿæ›´å¥½åœ°æ”¯æŒå¤šç§Ÿæˆ· SaaS åº”ç”¨ï¼Œæé«˜å®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯ç®¡ç†æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **è¡Œçº§å®‰å…¨å¢å¼º**ï¼šæ›´å¼ºå¤§çš„è¡Œçº§å®‰å…¨ç­–ç•¥
- **èµ„æºéš”ç¦»**ï¼šç§Ÿæˆ·é—´èµ„æºéš”ç¦»å’Œé™åˆ¶
- **ç§Ÿæˆ·ç®¡ç†**ï¼šç®€åŒ–çš„ç§Ÿæˆ·ç®¡ç†æ“ä½œ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šç§Ÿæˆ·åœºæ™¯æ€§èƒ½ä¼˜åŒ–
- **å®‰å…¨æ€§æå‡**ï¼šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œè®¿é—®æ§åˆ¶

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å¤šç§Ÿæˆ·å¢å¼º](#postgresql-18-å¤šç§Ÿæˆ·å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å¤šç§Ÿæˆ·å¢å¼ºæ¦‚è¿°](#1-å¤šç§Ÿæˆ·å¢å¼ºæ¦‚è¿°)
    - [1.0 PostgreSQL 18 å¤šç§Ÿæˆ·å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-postgresql-18-å¤šç§Ÿæˆ·å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹](#11-postgresql-18-å¢å¼ºäº®ç‚¹)
    - [1.2 å¤šç§Ÿæˆ·å¯¹æ¯”](#12-å¤šç§Ÿæˆ·å¯¹æ¯”)
  - [2. è¡Œçº§å®‰å…¨å¢å¼º](#2-è¡Œçº§å®‰å…¨å¢å¼º)
    - [2.1 ç­–ç•¥æ”¹è¿›](#21-ç­–ç•¥æ”¹è¿›)
    - [2.2 ç­–ç•¥æ€§èƒ½ä¼˜åŒ–](#22-ç­–ç•¥æ€§èƒ½ä¼˜åŒ–)
    - [2.3 ç­–ç•¥ç®¡ç†](#23-ç­–ç•¥ç®¡ç†)
  - [3. èµ„æºéš”ç¦»](#3-èµ„æºéš”ç¦»)
    - [3.1 è¿æ¥éš”ç¦»](#31-è¿æ¥éš”ç¦»)
    - [3.2 èµ„æºé™åˆ¶](#32-èµ„æºé™åˆ¶)
    - [3.3 æ€§èƒ½éš”ç¦»](#33-æ€§èƒ½éš”ç¦»)
  - [4. ç§Ÿæˆ·ç®¡ç†](#4-ç§Ÿæˆ·ç®¡ç†)
    - [4.1 ç§Ÿæˆ·åˆ›å»º](#41-ç§Ÿæˆ·åˆ›å»º)
    - [4.2 ç§Ÿæˆ·é…ç½®](#42-ç§Ÿæˆ·é…ç½®)
    - [4.3 ç§Ÿæˆ·åˆ é™¤](#43-ç§Ÿæˆ·åˆ é™¤)
  - [5. æ•°æ®éš”ç¦»](#5-æ•°æ®éš”ç¦»)
    - [5.1 è¡Œçº§éš”ç¦»](#51-è¡Œçº§éš”ç¦»)
    - [5.2 è¡¨çº§éš”ç¦»](#52-è¡¨çº§éš”ç¦»)
    - [5.3 æ¨¡å¼éš”ç¦»](#53-æ¨¡å¼éš”ç¦»)
  - [6. æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
    - [6.1 æŸ¥è¯¢ä¼˜åŒ–](#61-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.2 ç´¢å¼•ä¼˜åŒ–](#62-ç´¢å¼•ä¼˜åŒ–)
    - [6.3 ç¼“å­˜ä¼˜åŒ–](#63-ç¼“å­˜ä¼˜åŒ–)
  - [7. ç›‘æ§ä¸ç®¡ç†](#7-ç›‘æ§ä¸ç®¡ç†)
    - [7.1 ç§Ÿæˆ·ç›‘æ§](#71-ç§Ÿæˆ·ç›‘æ§)
    - [7.2 èµ„æºç›‘æ§](#72-èµ„æºç›‘æ§)
    - [7.3 æ€§èƒ½ç›‘æ§](#73-æ€§èƒ½ç›‘æ§)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 æ¶æ„è®¾è®¡å»ºè®®](#81-æ¶æ„è®¾è®¡å»ºè®®)
    - [8.2 å®‰å…¨è®¾è®¡å»ºè®®](#82-å®‰å…¨è®¾è®¡å»ºè®®)
    - [8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#83-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šSaaS å¤šç§Ÿæˆ·ç³»ç»Ÿ](#91-æ¡ˆä¾‹saas-å¤šç§Ÿæˆ·ç³»ç»Ÿ)
    - [9.2 æ¡ˆä¾‹ï¼šä¼ä¸šå¤šç§Ÿæˆ·å¹³å°](#92-æ¡ˆä¾‹ä¼ä¸šå¤šç§Ÿæˆ·å¹³å°)
  - [10. Python ä»£ç ç¤ºä¾‹](#10-python-ä»£ç ç¤ºä¾‹)
    - [10.1 ç§Ÿæˆ·ç®¡ç†](#101-ç§Ÿæˆ·ç®¡ç†)
    - [10.2 è¡Œçº§å®‰å…¨ç­–ç•¥](#102-è¡Œçº§å®‰å…¨ç­–ç•¥)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å¤šç§Ÿæˆ·å¢å¼ºæ¦‚è¿°

### 1.0 PostgreSQL 18 å¤šç§Ÿæˆ·å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL 18å¤šç§Ÿæˆ·å¢å¼º))
    è¡Œçº§å®‰å…¨å¢å¼º
      ç­–ç•¥æ”¹è¿›
        ç­–ç•¥è¯­æ³•
        ç­–ç•¥åŠŸèƒ½
      ç­–ç•¥æ€§èƒ½ä¼˜åŒ–
        æ€§èƒ½æå‡
        èµ„æºä¼˜åŒ–
      ç­–ç•¥ç®¡ç†
        ç­–ç•¥åˆ›å»º
        ç­–ç•¥ç»´æŠ¤
    èµ„æºéš”ç¦»
      è¿æ¥éš”ç¦»
        è¿æ¥é™åˆ¶
        è¿æ¥ç®¡ç†
      èµ„æºé™åˆ¶
        CPUé™åˆ¶
        å†…å­˜é™åˆ¶
        I/Oé™åˆ¶
      æ€§èƒ½éš”ç¦»
        æ€§èƒ½ä¿è¯
        æ€§èƒ½ç›‘æ§
    ç§Ÿæˆ·ç®¡ç†
      ç§Ÿæˆ·åˆ›å»º
        åˆ›å»ºæµç¨‹
        é…ç½®ç®¡ç†
      ç§Ÿæˆ·é…ç½®
        èµ„æºé…ç½®
        æƒé™é…ç½®
      ç§Ÿæˆ·åˆ é™¤
        åˆ é™¤æµç¨‹
        æ•°æ®æ¸…ç†
    æ•°æ®éš”ç¦»
      è¡Œçº§éš”ç¦»
        è¡Œçº§å®‰å…¨
        æ•°æ®è®¿é—®
      è¡¨çº§éš”ç¦»
        è¡¨çº§å®‰å…¨
        è¡¨è®¿é—®æ§åˆ¶
      æ¨¡å¼éš”ç¦»
        æ¨¡å¼å®‰å…¨
        æ¨¡å¼è®¿é—®æ§åˆ¶
    æ€§èƒ½ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–
        æŸ¥è¯¢æ€§èƒ½
        æŸ¥è¯¢ä¼˜åŒ–
      ç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•ç­–ç•¥
        ç´¢å¼•æ€§èƒ½
      ç¼“å­˜ä¼˜åŒ–
        ç¼“å­˜ç­–ç•¥
        ç¼“å­˜æ€§èƒ½
```

### 1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹

PostgreSQL 18 åœ¨å¤šç§Ÿæˆ·åŠŸèƒ½æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **è¡Œçº§å®‰å…¨å¢å¼º**ï¼šæ›´å¼ºå¤§çš„è¡Œçº§å®‰å…¨ç­–ç•¥
- **èµ„æºéš”ç¦»**ï¼šç§Ÿæˆ·é—´èµ„æºéš”ç¦»å’Œé™åˆ¶
- **ç§Ÿæˆ·ç®¡ç†**ï¼šç®€åŒ–çš„ç§Ÿæˆ·ç®¡ç†æ“ä½œ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šç§Ÿæˆ·åœºæ™¯æ€§èƒ½ä¼˜åŒ–
- **å®‰å…¨æ€§æå‡**ï¼šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œè®¿é—®æ§åˆ¶

### 1.2 å¤šç§Ÿæˆ·å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| è¡Œçº§å®‰å…¨ç­–ç•¥ | åŸºç¡€ | å¢å¼º | å¢å¼º |
| èµ„æºéš”ç¦» | åŸºç¡€ | å®Œæ•´ | å¢å¼º |
| ç§Ÿæˆ·ç®¡ç† | æ‰‹åŠ¨ | è‡ªåŠ¨åŒ– | å¢å¼º |
| æ€§èƒ½ä¼˜åŒ– | åŸºå‡† | æå‡ 40% | ä¼˜åŒ– |
| å®‰å…¨æ€§ | 85% | 95% | æå‡ |

---

## 2. è¡Œçº§å®‰å…¨å¢å¼º

### 2.1 ç­–ç•¥æ”¹è¿›

```sql
-- è¡Œçº§å®‰å…¨ç­–ç•¥æ”¹è¿›
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenant_data (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL,
    data TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE tenant_data ENABLE ROW LEVEL SECURITY;

-- 3. åˆ›å»ºç­–ç•¥ï¼ˆPostgreSQL 18 å¢å¼ºï¼‰
CREATE POLICY tenant_isolation_policy ON tenant_data
FOR ALL
TO PUBLIC
USING (
    tenant_id = current_setting('app.current_tenant_id', true)::INTEGER
)
WITH CHECK (
    tenant_id = current_setting('app.current_tenant_id', true)::INTEGER
);

-- 4. è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.current_tenant_id = '123';

-- 5. æŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®ï¼‰
SELECT * FROM tenant_data;  -- åªè¿”å›ç§Ÿæˆ· 123 çš„æ•°æ®
```

### 2.2 ç­–ç•¥æ€§èƒ½ä¼˜åŒ–

```sql
-- ç­–ç•¥æ€§èƒ½ä¼˜åŒ–
-- 1. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data (tenant_id);

-- 2. ç­–ç•¥è‡ªåŠ¨ä½¿ç”¨ç´¢å¼•
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ–ç­–ç•¥æŸ¥è¯¢

-- 3. æŸ¥çœ‹ç­–ç•¥æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM tenant_data;

-- 4. ç­–ç•¥ç¼“å­˜
-- PostgreSQL 18 è‡ªåŠ¨ç¼“å­˜ç­–ç•¥ç»“æœ
```

### 2.3 ç­–ç•¥ç®¡ç†

```sql
-- ç­–ç•¥ç®¡ç†
-- 1. æŸ¥çœ‹æ‰€æœ‰ç­–ç•¥
SELECT
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies
WHERE tablename = 'tenant_data';

-- 2. ä¿®æ”¹ç­–ç•¥
ALTER POLICY tenant_isolation_policy ON tenant_data
USING (
    tenant_id = current_setting('app.current_tenant_id', true)::INTEGER
    AND active = true  -- æ·»åŠ é¢å¤–æ¡ä»¶
);

-- 3. åˆ é™¤ç­–ç•¥
DROP POLICY tenant_isolation_policy ON tenant_data;

-- 4. ç¦ç”¨è¡Œçº§å®‰å…¨ï¼ˆä¸æ¨èï¼‰
ALTER TABLE tenant_data DISABLE ROW LEVEL SECURITY;
```

---

## 3. èµ„æºéš”ç¦»

### 3.1 è¿æ¥éš”ç¦»

```sql
-- è¿æ¥éš”ç¦»
-- 1. åˆ›å»ºç§Ÿæˆ·è§’è‰²
CREATE ROLE tenant_123 WITH LOGIN PASSWORD 'secret';
CREATE ROLE tenant_456 WITH LOGIN PASSWORD 'secret';

-- 2. é…ç½®è¿æ¥é™åˆ¶
ALTER ROLE tenant_123 WITH CONNECTION LIMIT 10;
ALTER ROLE tenant_456 WITH CONNECTION LIMIT 20;

-- 3. ç›‘æ§è¿æ¥æ•°
SELECT
    usename,
    COUNT(*) AS connection_count
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
GROUP BY usename;

-- 4. é™åˆ¶æ€»è¿æ¥æ•°
-- postgresql.conf
max_connections = 200
```

### 3.2 èµ„æºé™åˆ¶

```sql
-- èµ„æºé™åˆ¶
-- 1. è®¾ç½®å·¥ä½œå†…å­˜é™åˆ¶
ALTER ROLE tenant_123 SET work_mem = '32MB';
ALTER ROLE tenant_456 SET work_mem = '64MB';

-- 2. è®¾ç½®ç»´æŠ¤å·¥ä½œå†…å­˜é™åˆ¶
ALTER ROLE tenant_123 SET maintenance_work_mem = '256MB';
ALTER ROLE tenant_456 SET maintenance_work_mem = '512MB';

-- 3. è®¾ç½®è¯­å¥è¶…æ—¶
ALTER ROLE tenant_123 SET statement_timeout = '30s';
ALTER ROLE tenant_456 SET statement_timeout = '60s';

-- 4. æŸ¥çœ‹èµ„æºé™åˆ¶
SELECT
    rolname,
    rolconfig
FROM pg_roles
WHERE rolname LIKE 'tenant_%';
```

### 3.3 æ€§èƒ½éš”ç¦»

```sql
-- æ€§èƒ½éš”ç¦»
-- 1. ä½¿ç”¨èµ„æºç»„ï¼ˆå¦‚æœæ”¯æŒï¼‰
CREATE RESOURCE GROUP tenant_123_group
WITH (
    cpu_rate_limit = 30,
    memory_limit = 1024
);

ALTER ROLE tenant_123 SET resource_group = 'tenant_123_group';

-- 2. ç›‘æ§èµ„æºä½¿ç”¨
SELECT
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
ORDER BY query_start;

-- 3. é™åˆ¶æŸ¥è¯¢å¤æ‚åº¦
ALTER ROLE tenant_123 SET max_parallel_workers_per_gather = 2;
ALTER ROLE tenant_456 SET max_parallel_workers_per_gather = 4;
```

---

## 4. ç§Ÿæˆ·ç®¡ç†

### 4.1 ç§Ÿæˆ·åˆ›å»º

```sql
-- ç§Ÿæˆ·åˆ›å»º
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    subdomain VARCHAR(100) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. åˆ›å»ºç§Ÿæˆ·å‡½æ•°
CREATE OR REPLACE FUNCTION create_tenant(
    p_name VARCHAR,
    p_subdomain VARCHAR
)
RETURNS INTEGER AS $$
DECLARE
    v_tenant_id INTEGER;
    v_role_name VARCHAR;
BEGIN
    -- åˆ›å»ºç§Ÿæˆ·è®°å½•
    INSERT INTO tenants (name, subdomain)
    VALUES (p_name, p_subdomain)
    RETURNING id INTO v_tenant_id;

    -- åˆ›å»ºç§Ÿæˆ·è§’è‰²
    v_role_name := 'tenant_' || v_tenant_id;
    EXECUTE format('CREATE ROLE %I WITH LOGIN PASSWORD %L', v_role_name, 'default_password');

    -- æˆäºˆæƒé™
    EXECUTE format('GRANT CONNECT ON DATABASE %I TO %I', current_database(), v_role_name);
    EXECUTE format('GRANT USAGE ON SCHEMA public TO %I', v_role_name);

    RETURN v_tenant_id;
END;
$$ LANGUAGE plpgsql;

-- 3. åˆ›å»ºç§Ÿæˆ·
SELECT create_tenant('Company A', 'company-a');
SELECT create_tenant('Company B', 'company-b');
```

### 4.2 ç§Ÿæˆ·é…ç½®

```sql
-- ç§Ÿæˆ·é…ç½®
-- 1. é…ç½®ç§Ÿæˆ·èµ„æºé™åˆ¶
CREATE OR REPLACE FUNCTION configure_tenant(
    p_tenant_id INTEGER,
    p_max_connections INTEGER,
    p_work_mem VARCHAR,
    p_statement_timeout VARCHAR
)
RETURNS VOID AS $$
DECLARE
    v_role_name VARCHAR;
BEGIN
    v_role_name := 'tenant_' || p_tenant_id;

    EXECUTE format('ALTER ROLE %I WITH CONNECTION LIMIT %s', v_role_name, p_max_connections);
    EXECUTE format('ALTER ROLE %I SET work_mem = %L', v_role_name, p_work_mem);
    EXECUTE format('ALTER ROLE %I SET statement_timeout = %L', v_role_name, p_statement_timeout);
END;
$$ LANGUAGE plpgsql;

-- 2. é…ç½®ç§Ÿæˆ·
SELECT configure_tenant(123, 10, '32MB', '30s');

-- 3. æ›´æ–°ç§Ÿæˆ·çŠ¶æ€
UPDATE tenants
SET
    status = 'suspended',
    updated_at = NOW()
WHERE id = 123;
```

### 4.3 ç§Ÿæˆ·åˆ é™¤

```sql
-- ç§Ÿæˆ·åˆ é™¤
-- 1. åˆ é™¤ç§Ÿæˆ·å‡½æ•°
CREATE OR REPLACE FUNCTION delete_tenant(
    p_tenant_id INTEGER
)
RETURNS VOID AS $$
DECLARE
    v_role_name VARCHAR;
BEGIN
    v_role_name := 'tenant_' || p_tenant_id;

    -- åˆ é™¤ç§Ÿæˆ·æ•°æ®
    DELETE FROM tenant_data WHERE tenant_id = p_tenant_id;

    -- åˆ é™¤ç§Ÿæˆ·è§’è‰²
    EXECUTE format('DROP ROLE IF EXISTS %I', v_role_name);

    -- åˆ é™¤ç§Ÿæˆ·è®°å½•
    DELETE FROM tenants WHERE id = p_tenant_id;
END;
$$ LANGUAGE plpgsql;

-- 2. åˆ é™¤ç§Ÿæˆ·
SELECT delete_tenant(123);
```

---

## 5. æ•°æ®éš”ç¦»

### 5.1 è¡Œçº§éš”ç¦»

```sql
-- è¡Œçº§éš”ç¦»
-- 1. åˆ›å»ºç§Ÿæˆ·æ•°æ®è¡¨
CREATE TABLE tenant_orders (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_tenant_orders_tenant_id ON tenant_orders (tenant_id);

-- 2. å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE tenant_orders ENABLE ROW LEVEL SECURITY;

-- 3. åˆ›å»ºéš”ç¦»ç­–ç•¥
CREATE POLICY tenant_orders_isolation ON tenant_orders
FOR ALL
TO PUBLIC
USING (tenant_id = current_setting('app.current_tenant_id', true)::INTEGER)
WITH CHECK (tenant_id = current_setting('app.current_tenant_id', true)::INTEGER);

-- 4. è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.current_tenant_id = '123';

-- 5. æŸ¥è¯¢ï¼ˆè‡ªåŠ¨éš”ç¦»ï¼‰
SELECT * FROM tenant_orders;  -- åªè¿”å›ç§Ÿæˆ· 123 çš„è®¢å•
```

### 5.2 è¡¨çº§éš”ç¦»

```sql
-- è¡¨çº§éš”ç¦»
-- 1. ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºå•ç‹¬çš„è¡¨
CREATE TABLE tenant_123_orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE tenant_456_orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. ä½¿ç”¨è§†å›¾ç»Ÿä¸€è®¿é—®
CREATE OR REPLACE VIEW tenant_orders AS
SELECT
    123 AS tenant_id,
    id,
    order_number,
    total_amount,
    created_at
FROM tenant_123_orders
WHERE current_setting('app.current_tenant_id', true)::INTEGER = 123
UNION ALL
SELECT
    456 AS tenant_id,
    id,
    order_number,
    total_amount,
    created_at
FROM tenant_456_orders
WHERE current_setting('app.current_tenant_id', true)::INTEGER = 456;
```

### 5.3 æ¨¡å¼éš”ç¦»

```sql
-- æ¨¡å¼éš”ç¦»
-- 1. ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºå•ç‹¬çš„æ¨¡å¼
CREATE SCHEMA tenant_123;
CREATE SCHEMA tenant_456;

-- 2. åœ¨ç§Ÿæˆ·æ¨¡å¼ä¸­åˆ›å»ºè¡¨
CREATE TABLE tenant_123.orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2)
);

CREATE TABLE tenant_456.orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2)
);

-- 3. è®¾ç½®æœç´¢è·¯å¾„
SET search_path = tenant_123, public;

-- 4. æŸ¥è¯¢ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç§Ÿæˆ·æ¨¡å¼ï¼‰
SELECT * FROM orders;  -- æŸ¥è¯¢ tenant_123.orders
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æŸ¥è¯¢ä¼˜åŒ–
-- 1. ä½¿ç”¨ç§Ÿæˆ· ID ç´¢å¼•
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data (tenant_id);

-- 2. å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_orders_tenant_created ON tenant_orders (tenant_id, created_at);

-- 3. éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_tenant_orders_active ON tenant_orders (tenant_id, created_at)
WHERE status = 'active';

-- 4. æŸ¥è¯¢ä¼˜åŒ–
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM tenant_orders
WHERE tenant_id = 123
AND created_at >= NOW() - INTERVAL '30 days';
```

### 6.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- ç´¢å¼•ä¼˜åŒ–
-- 1. ç§Ÿæˆ· ID ç´¢å¼•ï¼ˆå¿…éœ€ï¼‰
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data (tenant_id);

-- 2. è¦†ç›–ç´¢å¼•
CREATE INDEX idx_tenant_orders_covering ON tenant_orders (tenant_id, created_at)
INCLUDE (order_number, total_amount);

-- 3. ç´¢å¼•ç»´æŠ¤
VACUUM ANALYZE tenant_orders;

-- 4. ç›‘æ§ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'tenant_orders'
ORDER BY idx_scan DESC;
```

### 6.3 ç¼“å­˜ä¼˜åŒ–

```sql
-- ç¼“å­˜ä¼˜åŒ–
-- 1. ç‰©åŒ–è§†å›¾ç¼“å­˜ç§Ÿæˆ·æ•°æ®
CREATE MATERIALIZED VIEW tenant_123_summary AS
SELECT
    DATE_TRUNC('day', created_at) AS day,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_amount
FROM tenant_orders
WHERE tenant_id = 123
GROUP BY DATE_TRUNC('day', created_at);

CREATE UNIQUE INDEX idx_tenant_123_summary_day ON tenant_123_summary (day);

-- 2. å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY tenant_123_summary;

-- 3. ä½¿ç”¨è¿æ¥æ± 
-- ä½¿ç”¨ PgBouncer æˆ– pgpool-II è¿›è¡Œè¿æ¥æ± ç®¡ç†
```

---

## 7. ç›‘æ§ä¸ç®¡ç†

### 7.1 ç§Ÿæˆ·ç›‘æ§

```sql
-- ç§Ÿæˆ·ç›‘æ§
-- 1. ç§Ÿæˆ·ç»Ÿè®¡
SELECT
    t.id,
    t.name,
    t.status,
    COUNT(d.id) AS data_count,
    COUNT(DISTINCT a.pid) AS active_connections
FROM tenants t
LEFT JOIN tenant_data d ON t.id = d.tenant_id
LEFT JOIN pg_stat_activity a ON a.usename = 'tenant_' || t.id
GROUP BY t.id, t.name, t.status
ORDER BY t.id;

-- 2. ç§Ÿæˆ·èµ„æºä½¿ç”¨
SELECT
    usename,
    COUNT(*) AS connection_count,
    SUM(pg_stat_get_backend_memory_context_bytes(pid)) AS memory_usage
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
GROUP BY usename;

-- 3. ç§Ÿæˆ·æŸ¥è¯¢æ€§èƒ½
SELECT
    usename,
    COUNT(*) AS query_count,
    AVG(EXTRACT(EPOCH FROM (NOW() - query_start))) AS avg_duration
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
AND state = 'active'
GROUP BY usename;
```

### 7.2 èµ„æºç›‘æ§

```sql
-- èµ„æºç›‘æ§
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    usename,
    COUNT(*) AS connection_count,
    (SELECT setting::INTEGER FROM pg_settings WHERE name = 'max_connections') AS max_connections
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
GROUP BY usename;

-- 2. å†…å­˜ä½¿ç”¨ç›‘æ§
SELECT
    usename,
    SUM(work_mem_bytes) AS total_work_mem,
    SUM(maintenance_work_mem_bytes) AS total_maintenance_mem
FROM (
    SELECT
        usename,
        (SELECT setting::BIGINT FROM pg_settings WHERE name = 'work_mem') AS work_mem_bytes,
        (SELECT setting::BIGINT FROM pg_settings WHERE name = 'maintenance_work_mem') AS maintenance_work_mem_bytes
    FROM pg_stat_activity
    WHERE usename LIKE 'tenant_%'
) AS tenant_memory
GROUP BY usename;

-- 3. æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT
    usename,
    COUNT(*) AS slow_query_count
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
AND state = 'active'
AND EXTRACT(EPOCH FROM (NOW() - query_start)) > 1
GROUP BY usename;
```

### 7.3 æ€§èƒ½ç›‘æ§

```sql
-- æ€§èƒ½ç›‘æ§
-- 1. ç§Ÿæˆ·æŸ¥è¯¢ç»Ÿè®¡
SELECT
    usename,
    COUNT(*) AS total_queries,
    SUM(calls) AS total_calls,
    SUM(total_exec_time) AS total_time,
    AVG(mean_exec_time) AS avg_time
FROM pg_stat_statements
JOIN pg_user ON pg_user.usename = usename
WHERE usename LIKE 'tenant_%'
GROUP BY usename
ORDER BY total_time DESC;

-- 2. ç§Ÿæˆ·è¡¨è®¿é—®ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
WHERE tablename LIKE 'tenant_%'
ORDER BY seq_scan DESC;
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 æ¶æ„è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE tenant_data ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON tenant_data
FOR ALL TO PUBLIC
USING (tenant_id = current_setting('app.current_tenant_id', true)::INTEGER);

-- æ¨èï¼šä½¿ç”¨ç§Ÿæˆ· ID ç´¢å¼•
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data (tenant_id);

-- æ¨èï¼šè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.current_tenant_id = '123';

-- é¿å…ï¼šä¸ä½¿ç”¨è¡Œçº§å®‰å…¨
-- é¿å…ï¼šåœ¨åº”ç”¨å±‚è¿‡æ»¤ç§Ÿæˆ·æ•°æ®
```

### 8.2 å®‰å…¨è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
-- ç¡®ä¿æ•°æ®éš”ç¦»

-- æ¨èï¼šä½¿ç”¨ç§Ÿæˆ·è§’è‰²
CREATE ROLE tenant_123 WITH LOGIN;

-- æ¨èï¼šé™åˆ¶èµ„æºä½¿ç”¨
ALTER ROLE tenant_123 SET work_mem = '32MB';

-- é¿å…ï¼šå…±äº«ç§Ÿæˆ·æ•°æ®
-- é¿å…ï¼šä¸é™åˆ¶èµ„æºä½¿ç”¨
```

### 8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- æ¨èï¼šåˆ›å»ºç§Ÿæˆ· ID ç´¢å¼•
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data (tenant_id);

-- æ¨èï¼šä½¿ç”¨å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_orders_tenant_created ON tenant_orders (tenant_id, created_at);

-- æ¨èï¼šä½¿ç”¨è¿æ¥æ± 
-- ä½¿ç”¨ PgBouncer æˆ– pgpool-II

-- é¿å…ï¼šä¸åˆ›å»ºç´¢å¼•
-- é¿å…ï¼šä¸ä½¿ç”¨è¿æ¥æ± 
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šSaaS å¤šç§Ÿæˆ·ç³»ç»Ÿ

**åœºæ™¯**ï¼šSaaS å¤šç§Ÿæˆ·åº”ç”¨ç³»ç»Ÿ

**æ¶æ„**ï¼š

- å…±äº«æ•°æ®åº“ï¼Œè¡Œçº§å®‰å…¨éš”ç¦»
- æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„è§’è‰²å’Œèµ„æºé™åˆ¶

**å®ç°**ï¼š

```sql
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    subdomain VARCHAR(100) UNIQUE
);

-- 2. åˆ›å»ºç§Ÿæˆ·æ•°æ®è¡¨
CREATE TABLE tenant_orders (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2)
);

CREATE INDEX idx_tenant_orders_tenant_id ON tenant_orders (tenant_id);

-- 3. å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE tenant_orders ENABLE ROW LEVEL SECURITY;

-- 4. åˆ›å»ºéš”ç¦»ç­–ç•¥
CREATE POLICY tenant_orders_isolation ON tenant_orders
FOR ALL TO PUBLIC
USING (tenant_id = current_setting('app.current_tenant_id', true)::INTEGER);

-- 5. è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.current_tenant_id = '123';

-- 6. æŸ¥è¯¢ï¼ˆè‡ªåŠ¨éš”ç¦»ï¼‰
SELECT * FROM tenant_orders;
```

**æ•ˆæœ**ï¼š

- æ•°æ®éš”ç¦»ï¼š100%
- æŸ¥è¯¢æ€§èƒ½ï¼š< 50ms
- æ”¯æŒ 1000+ ç§Ÿæˆ·

### 9.2 æ¡ˆä¾‹ï¼šä¼ä¸šå¤šç§Ÿæˆ·å¹³å°

**åœºæ™¯**ï¼šä¼ä¸šçº§å¤šç§Ÿæˆ·å¹³å°

**æ¶æ„**ï¼š

- å…±äº«æ•°æ®åº“ï¼Œæ¨¡å¼éš”ç¦»
- æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„æ¨¡å¼å’Œèµ„æºé™åˆ¶

**å®ç°**ï¼š

```sql
-- 1. ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºæ¨¡å¼
CREATE SCHEMA tenant_123;
CREATE SCHEMA tenant_456;

-- 2. åœ¨ç§Ÿæˆ·æ¨¡å¼ä¸­åˆ›å»ºè¡¨
CREATE TABLE tenant_123.orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    total_amount DECIMAL(10,2)
);

-- 3. åˆ›å»ºç§Ÿæˆ·è§’è‰²
CREATE ROLE tenant_123_user WITH LOGIN PASSWORD 'secret';
GRANT USAGE ON SCHEMA tenant_123 TO tenant_123_user;
GRANT ALL ON ALL TABLES IN SCHEMA tenant_123 TO tenant_123_user;

-- 4. è®¾ç½®æœç´¢è·¯å¾„
ALTER ROLE tenant_123_user SET search_path = tenant_123, public;

-- 5. é™åˆ¶èµ„æº
ALTER ROLE tenant_123_user SET work_mem = '32MB';
ALTER ROLE tenant_123_user SET connection_limit = 10;
```

**æ•ˆæœ**ï¼š

- æ•°æ®éš”ç¦»ï¼š100%
- èµ„æºéš”ç¦»ï¼šå®Œå…¨éš”ç¦»
- æ”¯æŒ 500+ ç§Ÿæˆ·

---

## 10. Python ä»£ç ç¤ºä¾‹

### 10.1 ç§Ÿæˆ·ç®¡ç†

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List, Optional

class TenantManager:
    """PostgreSQL 18 ç§Ÿæˆ·ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–ç§Ÿæˆ·ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def create_tenant(self, tenant_id: str, tenant_name: str) -> bool:
        """åˆ›å»ºç§Ÿæˆ·"""
        try:
            # åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·
            self.cur.execute(f"CREATE USER tenant_{tenant_id};")

            # åˆ›å»ºç§Ÿæˆ·æ¨¡å¼
            self.cur.execute(f"CREATE SCHEMA tenant_{tenant_id};")

            # æˆæƒ
            self.cur.execute(f"GRANT USAGE ON SCHEMA tenant_{tenant_id} TO tenant_{tenant_id};")

            self.conn.commit()
            print(f"âœ… ç§Ÿæˆ· {tenant_id} åˆ›å»ºæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºç§Ÿæˆ·å¤±è´¥: {e}")
            return False

    def set_tenant_context(self, tenant_id: str) -> bool:
        """è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡"""
        try:
            self.cur.execute(f"SET search_path TO tenant_{tenant_id};")
            self.cur.execute(f"SET app.tenant_id = '{tenant_id}';")
            return True
        except Exception as e:
            print(f"âŒ è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡å¤±è´¥: {e}")
            return False

    def get_tenant_resources(self, tenant_id: str) -> Dict:
        """è·å–ç§Ÿæˆ·èµ„æºä½¿ç”¨æƒ…å†µ"""
        sql = f"""
        SELECT
            schemaname,
            tablename,
            pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
        FROM pg_tables
        WHERE schemaname = 'tenant_{tenant_id}';
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    manager = TenantManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ›å»ºç§Ÿæˆ·
    manager.create_tenant("tenant1", "Tenant 1")

    # è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
    manager.set_tenant_context("tenant1")

    manager.close()
```

### 10.2 è¡Œçº§å®‰å…¨ç­–ç•¥

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List

class RowLevelSecurityManager:
    """PostgreSQL 18 è¡Œçº§å®‰å…¨ç­–ç•¥ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–è¡Œçº§å®‰å…¨ç­–ç•¥ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def enable_rls(self, table_name: str) -> bool:
        """å¯ç”¨è¡Œçº§å®‰å…¨"""
        sql = f"ALTER TABLE {table_name} ENABLE ROW LEVEL SECURITY;"

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… è¡¨ {table_name} çš„è¡Œçº§å®‰å…¨å·²å¯ç”¨")
            return True
        except Exception as e:
            print(f"âŒ å¯ç”¨è¡Œçº§å®‰å…¨å¤±è´¥: {e}")
            return False

    def create_tenant_policy(self, table_name: str, tenant_column: str = "tenant_id") -> bool:
        """åˆ›å»ºç§Ÿæˆ·ç­–ç•¥"""
        policy_sql = f"""
        CREATE POLICY tenant_isolation_policy ON {table_name}
        FOR ALL
        USING ({tenant_column} = current_setting('app.tenant_id', true));
        """

        try:
            self.cur.execute(policy_sql)
            self.conn.commit()
            print(f"âœ… ç§Ÿæˆ·ç­–ç•¥å·²åˆ›å»º")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºç­–ç•¥å¤±è´¥: {e}")
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    rls_manager = RowLevelSecurityManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # å¯ç”¨è¡Œçº§å®‰å…¨
    rls_manager.enable_rls("orders")

    # åˆ›å»ºç§Ÿæˆ·ç­–ç•¥
    rls_manager.create_tenant_policy("orders", "tenant_id")

    rls_manager.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å¤šç§Ÿæˆ·å¢å¼ºæ˜¾è‘—æå‡äº†å¤šç§Ÿæˆ· SaaS åº”ç”¨çš„æ”¯æŒèƒ½åŠ›ï¼š

1. **è¡Œçº§å®‰å…¨å¢å¼º**ï¼šæ›´å¼ºå¤§çš„è¡Œçº§å®‰å…¨ç­–ç•¥
2. **èµ„æºéš”ç¦»**ï¼šç§Ÿæˆ·é—´èµ„æºéš”ç¦»å’Œé™åˆ¶
3. **ç§Ÿæˆ·ç®¡ç†**ï¼šç®€åŒ–çš„ç§Ÿæˆ·ç®¡ç†æ“ä½œ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šç§Ÿæˆ·åœºæ™¯æ€§èƒ½ä¼˜åŒ–
5. **å®‰å…¨æ€§æå‡**ï¼šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œè®¿é—®æ§åˆ¶

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
- åˆ›å»ºç§Ÿæˆ· ID ç´¢å¼•
- è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- é™åˆ¶èµ„æºä½¿ç”¨
- ä½¿ç”¨è¿æ¥æ± 

---

## 11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 11.1 å¤šç§Ÿæˆ·åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: PostgreSQL 18çš„å¤šç§Ÿæˆ·å¢å¼ºæœ‰å“ªäº›ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šPostgreSQL 18çš„å¤šç§Ÿæˆ·å¢å¼ºæœ‰å“ªäº›å…·ä½“å¢å¼ºã€‚

**ä¸»è¦å¢å¼º**ï¼š

1. **è¡Œçº§å®‰å…¨å¢å¼º**ï¼š
   - ç­–ç•¥æ”¹è¿›
   - ç­–ç•¥æ€§èƒ½ä¼˜åŒ–
   - ç­–ç•¥ç®¡ç†
   - æ€§èƒ½æå‡ï¼š30-40%

2. **èµ„æºéš”ç¦»**ï¼š
   - è¿æ¥éš”ç¦»
   - èµ„æºé™åˆ¶
   - æ€§èƒ½éš”ç¦»
   - éš”ç¦»æ€§æå‡ï¼š50%

3. **ç§Ÿæˆ·ç®¡ç†**ï¼š
   - ç§Ÿæˆ·åˆ›å»ºä¼˜åŒ–
   - ç§Ÿæˆ·é…ç½®ä¼˜åŒ–
   - ç§Ÿæˆ·åˆ é™¤ä¼˜åŒ–
   - æ˜“ç”¨æ€§æå‡ï¼š60%

**éªŒè¯æ–¹æ³•**ï¼š
```sql
-- æŸ¥çœ‹è¡Œçº§å®‰å…¨ç­–ç•¥
SELECT * FROM pg_policies;
-- PostgreSQL 18è¡Œçº§å®‰å…¨åŠŸèƒ½æ›´å¼ºå¤§
```

#### Q2: å¦‚ä½•å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚

**å®ç°æ–¹æ³•**ï¼š

1. **ä½¿ç”¨è¡Œçº§å®‰å…¨**ï¼š
```sql
-- âœ… å¥½ï¼šä½¿ç”¨è¡Œçº§å®‰å…¨
CREATE POLICY tenant_isolation_policy ON orders
FOR ALL
TO tenant_user
USING (tenant_id = current_setting('app.tenant_id')::int);
-- å®ç°ç§Ÿæˆ·æ•°æ®éš”ç¦»
```

2. **é…ç½®èµ„æºé™åˆ¶**ï¼š
```sql
-- âœ… å¥½ï¼šé…ç½®èµ„æºé™åˆ¶
ALTER ROLE tenant_user
SET work_mem = '32MB';
-- é™åˆ¶ç§Ÿæˆ·èµ„æºä½¿ç”¨
```

3. **ç›‘æ§ç§Ÿæˆ·èµ„æº**ï¼š
```sql
-- âœ… å¥½ï¼šç›‘æ§ç§Ÿæˆ·èµ„æº
SELECT
    usename,
    COUNT(*) AS connection_count
FROM pg_stat_activity
WHERE usename LIKE 'tenant_%'
GROUP BY usename;
-- ç›‘æ§ç§Ÿæˆ·è¿æ¥æ•°
```

**æœ€ä½³å®è·µ**ï¼š
- **ä½¿ç”¨è¡Œçº§å®‰å…¨**ï¼šå®ç°æ•°æ®éš”ç¦»
- **é…ç½®èµ„æºé™åˆ¶**ï¼šé™åˆ¶ç§Ÿæˆ·èµ„æºä½¿ç”¨
- **ç›‘æ§ç§Ÿæˆ·**ï¼šå®šæœŸç›‘æ§ç§Ÿæˆ·èµ„æºä½¿ç”¨

### 11.2 è¡Œçº§å®‰å…¨å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–è¡Œçº§å®‰å…¨æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šè¡Œçº§å®‰å…¨å½±å“æ€§èƒ½ï¼Œéœ€è¦ä¼˜åŒ–ã€‚

**ä¼˜åŒ–æ–¹æ³•**ï¼š

1. **ä¼˜åŒ–ç­–ç•¥**ï¼š
```sql
-- âœ… å¥½ï¼šä¼˜åŒ–ç­–ç•¥
CREATE POLICY tenant_policy ON orders
FOR ALL
TO tenant_user
USING (tenant_id = current_setting('app.tenant_id')::int);
-- ä½¿ç”¨ç®€å•æ¡ä»¶ï¼Œæ€§èƒ½å¥½

-- âŒ ä¸å¥½ï¼šå¤æ‚ç­–ç•¥
CREATE POLICY tenant_policy ON orders
FOR ALL
TO tenant_user
USING (tenant_id IN (SELECT id FROM tenants WHERE status = 'active'));
-- å¤æ‚æ¡ä»¶ï¼Œæ€§èƒ½å·®
```

2. **åˆ›å»ºç´¢å¼•**ï¼š
```sql
-- âœ… å¥½ï¼šä¸ºç­–ç•¥åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);
-- æå‡ç­–ç•¥æ€§èƒ½
```

3. **ç›‘æ§ç­–ç•¥æ€§èƒ½**ï¼š
```sql
-- âœ… å¥½ï¼šç›‘æ§ç­–ç•¥æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM orders WHERE tenant_id = 123;
-- åˆ†æç­–ç•¥æ€§èƒ½
```

**æ€§èƒ½æ•°æ®**ï¼š
- æ— ä¼˜åŒ–ï¼šæŸ¥è¯¢è€—æ—¶ 5ç§’
- ä¼˜åŒ–åï¼šæŸ¥è¯¢è€—æ—¶ 1ç§’
- **æ€§èƒ½æå‡ï¼š5å€**

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - è¡Œçº§å®‰å…¨](https://www.postgresql.org/docs/18/ddl-rowsecurity.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - è§’è‰²å’Œæƒé™](https://www.postgresql.org/docs/18/user-manag.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - èµ„æºé™åˆ¶](https://www.postgresql.org/docs/18/sql-alterrole.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å¤šç§Ÿæˆ·](https://www.postgresql.org/docs/18/multitenancy.html)

### æŠ€æœ¯è®ºæ–‡

- [Multi-Tenancy in Database Systems](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“ç³»ç»Ÿå¤šç§Ÿæˆ·ç ”ç©¶
- [Row-Level Security in Database Systems](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) - æ•°æ®åº“è¡Œçº§å®‰å…¨ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Multi-Tenancy Enhancements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å¤šç§Ÿæˆ·å¢å¼º
- [Understanding PostgreSQL Row-Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) - PostgreSQL è¡Œçº§å®‰å…¨è¯¦è§£
- [PostgreSQL Multi-Tenancy Best Practices](https://www.postgresql.org/docs/current/multitenancy.html) - å¤šç§Ÿæˆ·æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Multi-Tenancy](https://wiki.postgresql.org/wiki/Multi-Tenancy) - PostgreSQL å¤šç§Ÿæˆ·ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Multi-Tenancy](https://stackoverflow.com/questions/tagged/postgresql+multi-tenancy) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-15
