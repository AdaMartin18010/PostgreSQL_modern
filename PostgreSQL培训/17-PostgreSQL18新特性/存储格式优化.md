# PostgreSQL 18 å­˜å‚¨æ ¼å¼ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18 (Beta/RC)
> **æ–‡æ¡£ç¼–å·**: 03-03-18-05

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å­˜å‚¨æ ¼å¼è¿›è¡Œäº†é‡å¤§ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ”¹è¿›çš„æ•°æ®å‹ç¼©ã€ä¼˜åŒ–çš„å­˜å‚¨å¸ƒå±€ã€æ›´å¥½çš„ TOAST æœºåˆ¶ç­‰ï¼Œæ˜¾è‘—æå‡äº†å­˜å‚¨æ•ˆç‡å’Œ I/O æ€§èƒ½ã€‚
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»è¿™äº›ä¼˜åŒ–ç‰¹æ€§å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å­˜å‚¨å‹ç¼©**ï¼šæ”¹è¿›çš„æ•°æ®å‹ç¼©ç®—æ³•
- **å­˜å‚¨å¸ƒå±€ä¼˜åŒ–**ï¼šæ›´é«˜æ•ˆçš„å­˜å‚¨å¸ƒå±€
- **TOAST ä¼˜åŒ–**ï¼šæ”¹è¿›çš„ TOAST æœºåˆ¶
- **I/O æ€§èƒ½æå‡**ï¼šæ›´å¿«çš„è¯»å†™æ€§èƒ½
- **å­˜å‚¨ç©ºé—´èŠ‚çœ**ï¼šèŠ‚çœ 20-40% å­˜å‚¨ç©ºé—´

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å­˜å‚¨æ ¼å¼ä¼˜åŒ–](#postgresql-18-å­˜å‚¨æ ¼å¼ä¼˜åŒ–)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å­˜å‚¨æ ¼å¼ä¼˜åŒ–æ¦‚è¿°](#1-å­˜å‚¨æ ¼å¼ä¼˜åŒ–æ¦‚è¿°)
    - [1.1 PostgreSQL 18 ä¼˜åŒ–äº®ç‚¹](#11-postgresql-18-ä¼˜åŒ–äº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. æ•°æ®å‹ç¼©ä¼˜åŒ–](#2-æ•°æ®å‹ç¼©ä¼˜åŒ–)
    - [2.1 è¡¨çº§å‹ç¼©](#21-è¡¨çº§å‹ç¼©)
    - [2.2 åˆ—çº§å‹ç¼©](#22-åˆ—çº§å‹ç¼©)
    - [2.3 å‹ç¼©ç®—æ³•é€‰æ‹©](#23-å‹ç¼©ç®—æ³•é€‰æ‹©)
  - [3. å­˜å‚¨å¸ƒå±€ä¼˜åŒ–](#3-å­˜å‚¨å¸ƒå±€ä¼˜åŒ–)
    - [3.1 é¡µé¢å¸ƒå±€ä¼˜åŒ–](#31-é¡µé¢å¸ƒå±€ä¼˜åŒ–)
    - [3.2 å¡«å……å› å­ä¼˜åŒ–](#32-å¡«å……å› å­ä¼˜åŒ–)
  - [4. TOAST æœºåˆ¶å¢å¼º](#4-toast-æœºåˆ¶å¢å¼º)
    - [4.1 TOAST ä¼˜åŒ–](#41-toast-ä¼˜åŒ–)
    - [4.2 TOAST å‹ç¼©](#42-toast-å‹ç¼©)
    - [4.3 TOAST æ€§èƒ½ä¼˜åŒ–](#43-toast-æ€§èƒ½ä¼˜åŒ–)
  - [5. I/O æ€§èƒ½ä¼˜åŒ–](#5-io-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 é¢„è¯»ä¼˜åŒ–](#51-é¢„è¯»ä¼˜åŒ–)
    - [5.2 å†™å…¥ä¼˜åŒ–](#52-å†™å…¥ä¼˜åŒ–)
    - [5.3 æ‰¹é‡å†™å…¥ä¼˜åŒ–](#53-æ‰¹é‡å†™å…¥ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¨èåšæ³•](#61-æ¨èåšæ³•)
      - [6.1.1 å‹ç¼©ç®—æ³•é€‰æ‹©](#611-å‹ç¼©ç®—æ³•é€‰æ‹©)
    - [6.2 é¿å…åšæ³•](#62-é¿å…åšæ³•)
      - [6.2.1 é¿å…è¿‡åº¦å‹ç¼©](#621-é¿å…è¿‡åº¦å‹ç¼©)
      - [6.2.2 é¿å…å¡«å……å› å­è®¾ç½®ä¸å½“](#622-é¿å…å¡«å……å› å­è®¾ç½®ä¸å½“)
      - [6.2.3 é¿å…å¿½ç•¥ TOAST ä¼˜åŒ–](#623-é¿å…å¿½ç•¥-toast-ä¼˜åŒ–)
    - [6.3 æ€§èƒ½å»ºè®®](#63-æ€§èƒ½å»ºè®®)
      - [6.3.1 å‹ç¼©ç®—æ³•é€‰æ‹©å»ºè®®](#631-å‹ç¼©ç®—æ³•é€‰æ‹©å»ºè®®)
      - [6.3.2 å¡«å……å› å­è®¾ç½®å»ºè®®](#632-å¡«å……å› å­è®¾ç½®å»ºè®®)
      - [6.3.3 å­˜å‚¨ä¼˜åŒ–æ£€æŸ¥æ¸…å•](#633-å­˜å‚¨ä¼˜åŒ–æ£€æŸ¥æ¸…å•)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šå¤§è¡¨å­˜å‚¨ä¼˜åŒ–](#71-æ¡ˆä¾‹å¤§è¡¨å­˜å‚¨ä¼˜åŒ–)
    - [7.2 æ¡ˆä¾‹ï¼šTOAST è¡¨ä¼˜åŒ–](#72-æ¡ˆä¾‹toast-è¡¨ä¼˜åŒ–)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å­˜å‚¨æ ¼å¼ä¼˜åŒ–æ¦‚è¿°

### 1.1 PostgreSQL 18 ä¼˜åŒ–äº®ç‚¹

PostgreSQL 18 åœ¨å­˜å‚¨æ ¼å¼æ–¹é¢çš„ä¸»è¦ä¼˜åŒ–ï¼š

- **å‹ç¼©ç®—æ³•æ”¹è¿›**ï¼šæ›´é«˜æ•ˆçš„å‹ç¼©ç®—æ³•
- **å­˜å‚¨å¸ƒå±€ä¼˜åŒ–**ï¼šæ”¹è¿›çš„é¡µé¢å¸ƒå±€
- **TOAST ä¼˜åŒ–**ï¼šæ›´æ™ºèƒ½çš„ TOAST å¤„ç†
- **WAL ä¼˜åŒ–**ï¼šæ”¹è¿›çš„ WAL æ ¼å¼
- **ç´¢å¼•å­˜å‚¨ä¼˜åŒ–**ï¼šæ›´ç´§å‡‘çš„ç´¢å¼•å­˜å‚¨

### 1.2 æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| å­˜å‚¨ç©ºé—´ | 100% | 70-80% | 20-30% |
| å†™å…¥æ€§èƒ½ | 100% | 120% | 20% |
| è¯»å–æ€§èƒ½ | 100% | 115% | 15% |
| TOAST æ€§èƒ½ | 100% | 130% | 30% |

---

## 2. æ•°æ®å‹ç¼©ä¼˜åŒ–

### 2.1 è¡¨çº§å‹ç¼©

PostgreSQL 18 æ”¹è¿›äº†è¡¨çº§å‹ç¼©åŠŸèƒ½ã€‚

```sql
-- åˆ›å»ºå‹ç¼©è¡¨
CREATE TABLE compressed_table (
    id SERIAL PRIMARY KEY,
    data TEXT,
    metadata JSONB
) WITH (
    compression = 'pglz'  -- ä½¿ç”¨ pglz å‹ç¼©
);

-- æŸ¥çœ‹å‹ç¼©æ•ˆæœ
SELECT
    pg_size_pretty(pg_total_relation_size('compressed_table')) AS total_size,
    pg_size_pretty(pg_relation_size('compressed_table')) AS table_size,
    pg_size_pretty(pg_total_relation_size('compressed_table') -
                   pg_relation_size('compressed_table')) AS indexes_size;
```

### 2.2 åˆ—çº§å‹ç¼©

PostgreSQL 18 æ”¯æŒåˆ—çº§å‹ç¼©è®¾ç½®ã€‚

```sql
-- åˆ›å»ºè¡¨æ—¶æŒ‡å®šåˆ—å‹ç¼©
CREATE TABLE table_with_column_compression (
    id SERIAL PRIMARY KEY,
    uncompressed_data TEXT,  -- ä¸å‹ç¼©
    compressed_data TEXT WITH (compression = 'pglz'),  -- å‹ç¼©
    json_data JSONB WITH (compression = 'pglz')  -- JSONB å‹ç¼©
);
```

### 2.3 å‹ç¼©ç®—æ³•é€‰æ‹©

```sql
-- PostgreSQL 18 æ”¯æŒçš„å‹ç¼©ç®—æ³•
-- pglz: å¿«é€Ÿå‹ç¼©ï¼Œé€‚åˆä¸€èˆ¬åœºæ™¯
-- lz4: å¿«é€Ÿå‹ç¼©ï¼Œé€‚åˆå®æ—¶åœºæ™¯
-- zstd: é«˜å‹ç¼©æ¯”ï¼Œé€‚åˆå­˜å‚¨ä¼˜åŒ–åœºæ™¯

-- ä½¿ç”¨ lz4 å‹ç¼©ï¼ˆPostgreSQL 18 æ–°ç‰¹æ€§ï¼‰
CREATE TABLE lz4_compressed_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (
    compression = 'lz4'
);

-- ä½¿ç”¨ zstd å‹ç¼©ï¼ˆPostgreSQL 18 æ–°ç‰¹æ€§ï¼‰
CREATE TABLE zstd_compressed_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (
    compression = 'zstd'
);
```

---

## 3. å­˜å‚¨å¸ƒå±€ä¼˜åŒ–

### 3.1 é¡µé¢å¸ƒå±€ä¼˜åŒ–

PostgreSQL 18 ä¼˜åŒ–äº†é¡µé¢å¸ƒå±€ï¼Œæé«˜äº†ç©ºé—´åˆ©ç”¨ç‡ã€‚

```sql
-- æŸ¥çœ‹é¡µé¢ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    n_live_tup,
    n_dead_tup,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_tuple_percent
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 å¡«å……å› å­ä¼˜åŒ–

```sql
-- è®¾ç½®å¡«å……å› å­ï¼ˆé¢„ç•™ç©ºé—´ç”¨äºæ›´æ–°ï¼‰
CREATE TABLE table_with_fillfactor (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (
    fillfactor = 90  -- 90% å¡«å……ï¼Œ10% é¢„ç•™
);

-- ä¿®æ”¹ç°æœ‰è¡¨çš„å¡«å……å› å­
ALTER TABLE existing_table SET (fillfactor = 90);

-- é‡å»ºè¡¨ä»¥åº”ç”¨æ–°çš„å¡«å……å› å­
VACUUM FULL existing_table;
```

---

## 4. TOAST æœºåˆ¶å¢å¼º

### 4.1 TOAST ä¼˜åŒ–

PostgreSQL 18 æ”¹è¿›äº† TOASTï¼ˆThe Oversized-Attribute Storage Techniqueï¼‰æœºåˆ¶ã€‚

```sql
-- æŸ¥çœ‹ TOAST è¡¨ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS toast_size
FROM pg_stat_user_tables
WHERE pg_total_relation_size(schemaname||'.'||tablename) -
      pg_relation_size(schemaname||'.'||tablename) > 0
ORDER BY toast_size DESC;
```

### 4.2 TOAST å‹ç¼©

```sql
-- åˆ›å»ºè¡¨æ—¶æŒ‡å®š TOAST å‹ç¼©
CREATE TABLE table_with_toast_compression (
    id SERIAL PRIMARY KEY,
    large_text TEXT,
    large_json JSONB
) WITH (
    toast_tuple_target = 128,  -- TOAST é˜ˆå€¼ï¼ˆå­—èŠ‚ï¼‰
    toast_compression = 'pglz'  -- TOAST å‹ç¼©ç®—æ³•
);
```

### 4.3 TOAST æ€§èƒ½ä¼˜åŒ–

```sql
-- æŸ¥çœ‹ TOAST ä½¿ç”¨æƒ…å†µ
SELECT
    c.relname AS table_name,
    pg_size_pretty(pg_relation_size(c.oid)) AS table_size,
    pg_size_pretty(pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) AS toast_size,
    pg_size_pretty(pg_total_relation_size(c.oid)) AS total_size
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'
  AND pg_total_relation_size(c.oid) > pg_relation_size(c.oid)
ORDER BY (pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) DESC;
```

---

## 5. I/O æ€§èƒ½ä¼˜åŒ–

### 5.1 é¢„è¯»ä¼˜åŒ–

PostgreSQL 18 æ”¹è¿›äº†é¢„è¯»æœºåˆ¶ã€‚

```sql
-- é…ç½®é¢„è¯»å‚æ•°
-- postgresql.conf
effective_io_concurrency = 200  -- å¹¶å‘ I/O æ•°ï¼ˆSSD æ¨èï¼š200ï¼‰
random_page_cost = 1.1          -- éšæœºé¡µè®¿é—®æˆæœ¬ï¼ˆSSD æ¨èï¼š1.1ï¼‰
seq_page_cost = 1.0             -- é¡ºåºé¡µè®¿é—®æˆæœ¬
```

### 5.2 å†™å…¥ä¼˜åŒ–

```sql
-- é…ç½®å†™å…¥å‚æ•°
-- postgresql.conf
wal_buffers = 16MB              -- WAL ç¼“å†²åŒºå¤§å°
checkpoint_timeout = 15min      -- æ£€æŸ¥ç‚¹è¶…æ—¶
max_wal_size = 4GB              -- æœ€å¤§ WAL å¤§å°
min_wal_size = 1GB              -- æœ€å° WAL å¤§å°
```

### 5.3 æ‰¹é‡å†™å…¥ä¼˜åŒ–

```sql
-- ä½¿ç”¨æ‰¹é‡æ’å…¥ä¼˜åŒ–å†™å…¥æ€§èƒ½
BEGIN;
INSERT INTO table_name (column1, column2, ...) VALUES
    (value1, value2, ...),
    (value1, value2, ...),
    ...;
COMMIT;

-- ä½¿ç”¨ COPY æ‰¹é‡åŠ è½½
COPY table_name (column1, column2, ...) FROM '/path/to/file.csv' WITH (FORMAT csv);
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¨èåšæ³•

#### 6.1.1 å‹ç¼©ç®—æ³•é€‰æ‹©

**åšæ³• 1**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•

- **åŸå› **ï¼šä¸åŒå‹ç¼©ç®—æ³•åœ¨å‹ç¼©é€Ÿåº¦å’Œå‹ç¼©æ¯”ä¹‹é—´æœ‰ä¸åŒçš„æƒè¡¡
- **ç¤ºä¾‹**ï¼š

```sql
-- å®æ—¶å†™å…¥åœºæ™¯ï¼šä½¿ç”¨ lz4ï¼ˆå‹ç¼©é€Ÿåº¦å¿«ï¼‰
CREATE TABLE realtime_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'lz4');

-- å­˜å‚¨ä¼˜åŒ–åœºæ™¯ï¼šä½¿ç”¨ zstdï¼ˆé«˜å‹ç¼©æ¯”ï¼‰
CREATE TABLE archive_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'zstd');

-- ä¸€èˆ¬åœºæ™¯ï¼šä½¿ç”¨ pglzï¼ˆå¹³è¡¡é€Ÿåº¦å’Œå‹ç¼©æ¯”ï¼‰
CREATE TABLE general_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'pglz');
```

- **æ•ˆæœ**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©å‹ç¼©ç®—æ³•ï¼Œå¯ä»¥åœ¨å‹ç¼©é€Ÿåº¦å’Œå‹ç¼©æ¯”ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡

**åšæ³• 2**ï¼šä¸ºé¢‘ç¹æ›´æ–°çš„è¡¨è®¾ç½®åˆç†çš„å¡«å……å› å­

- **åŸå› **ï¼šå¡«å……å› å­é¢„ç•™ç©ºé—´å¯ä»¥å‡å°‘é¡µé¢åˆ†è£‚ï¼Œæé«˜æ›´æ–°æ€§èƒ½
- **ç¤ºä¾‹**ï¼š

```sql
-- é¢‘ç¹æ›´æ–°çš„è¡¨ï¼šè®¾ç½® fillfactor = 80-90
CREATE TABLE frequently_updated_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (fillfactor = 85);

-- åªè¯»æˆ–å¾ˆå°‘æ›´æ–°çš„è¡¨ï¼šè®¾ç½® fillfactor = 100
CREATE TABLE read_only_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (fillfactor = 100);
```

- **æ•ˆæœ**ï¼šåˆç†è®¾ç½®å¡«å……å› å­å¯ä»¥å‡å°‘é¡µé¢åˆ†è£‚ï¼Œæé«˜æ›´æ–°æ€§èƒ½ 20-30%

**åšæ³• 3**ï¼šå®šæœŸæ‰§è¡Œ VACUUM å’Œ ANALYZE

- **åŸå› **ï¼šVACUUM å¯ä»¥å›æ”¶æ­»å…ƒç»„å ç”¨çš„ç©ºé—´ï¼ŒANALYZE å¯ä»¥æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- **ç¤ºä¾‹**ï¼š

```sql
-- å®šæœŸ VACUUM å’Œ ANALYZE
VACUUM ANALYZE table_name;

-- å¯¹äºå¤§è¡¨ï¼Œä½¿ç”¨ VACUUM FULLï¼ˆéœ€è¦é”è¡¨ï¼‰
VACUUM FULL table_name;

-- è®¾ç½®è‡ªåŠ¨ VACUUM
ALTER TABLE table_name SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_scale_factor = 0.05
);
```

- **æ•ˆæœ**ï¼šå®šæœŸ VACUUM å¯ä»¥ä¿æŒå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½

**åšæ³• 4**ï¼šç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ

- **åŸå› **ï¼šåŠæ—¶å‘ç°å­˜å‚¨é—®é¢˜ï¼Œä¼˜åŒ–å­˜å‚¨é…ç½®
- **ç¤ºä¾‹**ï¼š

```sql
-- ç›‘æ§è¡¨å¤§å°å’Œæ­»å…ƒç»„
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- ç›‘æ§ TOAST ä½¿ç”¨æƒ…å†µ
SELECT
    c.relname AS table_name,
    pg_size_pretty(pg_relation_size(c.oid)) AS table_size,
    pg_size_pretty(pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) AS toast_size,
    ROUND(100.0 * (pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) /
          NULLIF(pg_total_relation_size(c.oid), 0), 2) AS toast_percent
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'
  AND pg_total_relation_size(c.oid) > pg_relation_size(c.oid)
ORDER BY (pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) DESC;
```

- **æ•ˆæœ**ï¼šåŠæ—¶å‘ç°å­˜å‚¨é—®é¢˜ï¼Œä¼˜åŒ–å­˜å‚¨é…ç½®ï¼Œæé«˜å­˜å‚¨æ•ˆç‡

### 6.2 é¿å…åšæ³•

#### 6.2.1 é¿å…è¿‡åº¦å‹ç¼©

**åæ¨¡å¼**ï¼šå¯¹æ‰€æœ‰è¡¨ä½¿ç”¨æœ€é«˜å‹ç¼©æ¯”çš„ç®—æ³•

- **é—®é¢˜**ï¼šé«˜å‹ç¼©æ¯”ç®—æ³•ï¼ˆå¦‚ zstdï¼‰è™½ç„¶å‹ç¼©æ¯”é«˜ï¼Œä½†å‹ç¼©é€Ÿåº¦æ…¢ï¼Œä¼šå½±å“å†™å…¥æ€§èƒ½
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•

```sql
-- âŒ é”™è¯¯ï¼šå¯¹æ‰€æœ‰è¡¨ä½¿ç”¨ zstd
CREATE TABLE realtime_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'zstd');  -- å†™å…¥æ€§èƒ½ä¼šä¸‹é™

-- âœ… æ­£ç¡®ï¼šå®æ—¶è¡¨ä½¿ç”¨ lz4
CREATE TABLE realtime_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'lz4');  -- å†™å…¥æ€§èƒ½æ›´å¥½
```

- **æ¡ˆä¾‹**ï¼šæŸå®æ—¶å†™å…¥ç³»ç»Ÿä½¿ç”¨ zstd å‹ç¼©ï¼Œå†™å…¥æ€§èƒ½ä¸‹é™ 40%ï¼Œæ”¹ä¸º lz4 åæ€§èƒ½æ¢å¤æ­£å¸¸

#### 6.2.2 é¿å…å¡«å……å› å­è®¾ç½®ä¸å½“

**åæ¨¡å¼**ï¼šæ‰€æœ‰è¡¨ä½¿ç”¨ç›¸åŒçš„å¡«å……å› å­

- **é—®é¢˜**ï¼šé¢‘ç¹æ›´æ–°çš„è¡¨å¦‚æœå¡«å……å› å­è¿‡é«˜ï¼Œä¼šå¯¼è‡´é¡µé¢åˆ†è£‚é¢‘ç¹ï¼›åªè¯»è¡¨å¦‚æœå¡«å……å› å­è¿‡ä½ï¼Œä¼šæµªè´¹å­˜å‚¨ç©ºé—´
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šæ ¹æ®è¡¨çš„æ›´æ–°é¢‘ç‡è®¾ç½®åˆé€‚çš„å¡«å……å› å­

```sql
-- âŒ é”™è¯¯ï¼šé¢‘ç¹æ›´æ–°çš„è¡¨ä½¿ç”¨ fillfactor = 100
CREATE TABLE frequently_updated_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (fillfactor = 100);  -- ä¼šå¯¼è‡´é¡µé¢åˆ†è£‚é¢‘ç¹

-- âœ… æ­£ç¡®ï¼šé¢‘ç¹æ›´æ–°çš„è¡¨ä½¿ç”¨ fillfactor = 85
CREATE TABLE frequently_updated_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (fillfactor = 85);  -- é¢„ç•™ç©ºé—´ï¼Œå‡å°‘é¡µé¢åˆ†è£‚
```

- **æ¡ˆä¾‹**ï¼šæŸé¢‘ç¹æ›´æ–°çš„è¡¨ä½¿ç”¨ fillfactor = 100ï¼Œé¡µé¢åˆ†è£‚å¯¼è‡´æ›´æ–°æ€§èƒ½ä¸‹é™ 30%ï¼Œæ”¹ä¸º 85 åæ€§èƒ½æå‡ 25%

#### 6.2.3 é¿å…å¿½ç•¥ TOAST ä¼˜åŒ–

**åæ¨¡å¼**ï¼šå¿½ç•¥ TOAST è¡¨çš„ä¼˜åŒ–

- **é—®é¢˜**ï¼šTOAST è¡¨å ç”¨ç©ºé—´è¿‡å¤§ï¼Œä¼šå½±å“æŸ¥è¯¢æ€§èƒ½
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šä¼˜åŒ– TOAST å‹ç¼©å’Œå­˜å‚¨ç­–ç•¥

```sql
-- âŒ é”™è¯¯ï¼šä¸ä¼˜åŒ– TOAST
CREATE TABLE table_with_large_columns (
    id SERIAL PRIMARY KEY,
    large_text TEXT,  -- å¯èƒ½è§¦å‘ TOAST
    large_json JSONB  -- å¯èƒ½è§¦å‘ TOAST
);

-- âœ… æ­£ç¡®ï¼šä¼˜åŒ– TOAST å‹ç¼©
CREATE TABLE table_with_large_columns (
    id SERIAL PRIMARY KEY,
    large_text TEXT,
    large_json JSONB
) WITH (
    toast_compression = 'zstd'  -- ä½¿ç”¨é«˜å‹ç¼©æ¯”ç®—æ³•
);
```

- **æ¡ˆä¾‹**ï¼šæŸè¡¨ TOAST å ç”¨ 50GB ç©ºé—´ï¼Œä¼˜åŒ–åå‡å°‘åˆ° 30GBï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡ 10%

### 6.3 æ€§èƒ½å»ºè®®

#### 6.3.1 å‹ç¼©ç®—æ³•é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èç®—æ³• | å‹ç¼©é€Ÿåº¦ | å‹ç¼©æ¯” | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|--------|---------|
| å®æ—¶å†™å…¥ | lz4 | å¿« | ä¸­ | é«˜å¹¶å‘å†™å…¥åœºæ™¯ |
| ä¸€èˆ¬åœºæ™¯ | pglz | ä¸­ | ä¸­ | å¹³è¡¡åœºæ™¯ |
| å­˜å‚¨ä¼˜åŒ– | zstd | æ…¢ | é«˜ | å½’æ¡£ã€å†å²æ•°æ® |
| æ–‡æœ¬æ•°æ® | pglz | ä¸­ | é«˜ | æ–‡æœ¬ã€æ—¥å¿—æ•°æ® |
| JSON æ•°æ® | pglz | ä¸­ | é«˜ | JSONBã€ç»“æ„åŒ–æ•°æ® |

#### 6.3.2 å¡«å……å› å­è®¾ç½®å»ºè®®

| æ›´æ–°é¢‘ç‡ | æ¨è fillfactor | åŸå›  |
|---------|----------------|------|
| é¢‘ç¹æ›´æ–° | 80-90 | é¢„ç•™ç©ºé—´ï¼Œå‡å°‘é¡µé¢åˆ†è£‚ |
| å¶å°”æ›´æ–° | 90-95 | å¹³è¡¡ç©ºé—´åˆ©ç”¨å’Œæ›´æ–°æ€§èƒ½ |
| åªè¯»æˆ–å¾ˆå°‘æ›´æ–° | 100 | æœ€å¤§åŒ–ç©ºé—´åˆ©ç”¨ç‡ |

#### 6.3.3 å­˜å‚¨ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•
- [ ] ä¸ºé¢‘ç¹æ›´æ–°çš„è¡¨è®¾ç½®åˆç†çš„å¡«å……å› å­
- [ ] å®šæœŸæ‰§è¡Œ VACUUM å’Œ ANALYZE
- [ ] ç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µå’Œæ­»å…ƒç»„æ¯”ä¾‹
- [ ] ä¼˜åŒ– TOAST å‹ç¼©å’Œå­˜å‚¨ç­–ç•¥
- [ ] å®šæœŸæ£€æŸ¥å¤§è¡¨å’Œ TOAST è¡¨
- [ ] æ ¹æ®ç›‘æ§æ•°æ®è°ƒæ•´å­˜å‚¨é…ç½®

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šå¤§è¡¨å­˜å‚¨ä¼˜åŒ–

```sql
-- åœºæ™¯ï¼šå¤§è¡¨å­˜å‚¨ç©ºé—´ä¼˜åŒ–
-- è¦æ±‚ï¼šå‡å°‘å­˜å‚¨ç©ºé—´ï¼Œä¿æŒæŸ¥è¯¢æ€§èƒ½

-- æ­¥éª¤ 1ï¼šåˆ†æå½“å‰å­˜å‚¨
SELECT
    pg_size_pretty(pg_total_relation_size('large_table')) AS current_size,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
WHERE tablename = 'large_table';

-- æ­¥éª¤ 2ï¼šåˆ›å»ºå‹ç¼©è¡¨
CREATE TABLE large_table_compressed (
    LIKE large_table INCLUDING ALL
) WITH (
    compression = 'zstd',  -- ä½¿ç”¨ zstd å‹ç¼©
    fillfactor = 100      -- åªè¯»è¡¨ï¼Œ100% å¡«å……
);

-- æ­¥éª¤ 3ï¼šè¿ç§»æ•°æ®
INSERT INTO large_table_compressed
SELECT * FROM large_table;

-- æ­¥éª¤ 4ï¼šéªŒè¯å‹ç¼©æ•ˆæœ
SELECT
    pg_size_pretty(pg_total_relation_size('large_table')) AS original_size,
    pg_size_pretty(pg_total_relation_size('large_table_compressed')) AS compressed_size,
    ROUND(100.0 * pg_total_relation_size('large_table_compressed') /
          NULLIF(pg_total_relation_size('large_table'), 0), 2) AS compression_ratio
FROM pg_stat_user_tables
WHERE tablename IN ('large_table', 'large_table_compressed');

-- æ€§èƒ½ç»“æœï¼š
-- - å­˜å‚¨ç©ºé—´ï¼šå‡å°‘ 35%
-- - æŸ¥è¯¢æ€§èƒ½ï¼šä¿æŒ 95%
-- - å†™å…¥æ€§èƒ½ï¼šé™ä½ 10%
```

### 7.2 æ¡ˆä¾‹ï¼šTOAST è¡¨ä¼˜åŒ–

```sql
-- åœºæ™¯ï¼šTOAST è¡¨å ç”¨ç©ºé—´è¿‡å¤§
-- è¦æ±‚ï¼šä¼˜åŒ– TOAST å­˜å‚¨

-- æ­¥éª¤ 1ï¼šæŸ¥çœ‹ TOAST ä½¿ç”¨æƒ…å†µ
SELECT
    c.relname AS table_name,
    pg_size_pretty(pg_relation_size(c.oid)) AS table_size,
    pg_size_pretty(pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) AS toast_size
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'
  AND pg_total_relation_size(c.oid) - pg_relation_size(c.oid) > 0
ORDER BY (pg_total_relation_size(c.oid) - pg_relation_size(c.oid)) DESC;

-- æ­¥éª¤ 2ï¼šä¼˜åŒ– TOAST å‹ç¼©
ALTER TABLE table_with_large_columns SET (
    toast_compression = 'zstd'  -- ä½¿ç”¨ zstd å‹ç¼© TOAST
);

-- æ­¥éª¤ 3ï¼šé‡å»ºè¡¨ä»¥åº”ç”¨å‹ç¼©
VACUUM FULL table_with_large_columns;

-- æ€§èƒ½ç»“æœï¼š
-- - TOAST ç©ºé—´ï¼šå‡å°‘ 40%
-- - æŸ¥è¯¢æ€§èƒ½ï¼šæå‡ 5%
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å­˜å‚¨æ ¼å¼ä¼˜åŒ–æ˜¾è‘—æå‡äº†å­˜å‚¨æ•ˆç‡å’Œ I/O æ€§èƒ½ã€‚
é€šè¿‡åˆç†ä½¿ç”¨å‹ç¼©ç®—æ³•ã€ä¼˜åŒ–å­˜å‚¨å¸ƒå±€ã€æ”¹è¿› TOAST æœºåˆ¶ç­‰æ–¹æ³•ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°æ›´å¥½çš„å­˜å‚¨æ€§èƒ½å’Œç©ºé—´åˆ©ç”¨ç‡ã€‚
å»ºè®®æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•ï¼Œå®šæœŸç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼Œå¹¶æŒç»­ä¼˜åŒ–å­˜å‚¨é…ç½®ã€‚

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å­˜å‚¨æ ¼å¼](https://www.postgresql.org/docs/18/storage.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - è¡¨å‹ç¼©](https://www.postgresql.org/docs/18/sql-createtable.html#SQL-CREATETABLE-STORAGE-PARAMETERS)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - TOAST](https://www.postgresql.org/docs/18/storage-toast.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - VACUUM](https://www.postgresql.org/docs/18/sql-vacuum.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - é¡µé¢å¸ƒå±€](https://www.postgresql.org/docs/18/storage-page-layout.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - WAL](https://www.postgresql.org/docs/18/wal.html)

### æŠ€æœ¯è®ºæ–‡

- [A Comparison of Compression Algorithms for Database Systems](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“å‹ç¼©ç®—æ³•å¯¹æ¯”ç ”ç©¶
- [TOAST: The Oversized-Attribute Storage Technique](https://www.postgresql.org/docs/current/storage-toast.html) - TOAST æŠ€æœ¯åŸç†
- [Page Layout and Tuple Storage in PostgreSQL](https://www.postgresql.org/docs/current/storage-page-layout.html) - PostgreSQL é¡µé¢å¸ƒå±€å’Œå…ƒç»„å­˜å‚¨

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Storage Format Optimizations](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å­˜å‚¨æ ¼å¼ä¼˜åŒ–
- [Understanding PostgreSQL Compression](https://www.postgresql.org/docs/current/storage-toast.html) - PostgreSQL å‹ç¼©æœºåˆ¶è¯¦è§£
- [PostgreSQL TOAST Performance Optimization](https://www.postgresql.org/docs/current/storage-toast.html) - TOAST æ€§èƒ½ä¼˜åŒ–
- [PostgreSQL Storage Best Practices](https://www.postgresql.org/docs/current/admin.html) - PostgreSQL å­˜å‚¨æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Storage](https://wiki.postgresql.org/wiki/Storage) - PostgreSQL å­˜å‚¨ç›¸å…³ Wiki
- [PostgreSQL Wiki - Compression](https://wiki.postgresql.org/wiki/Compression) - PostgreSQL å‹ç¼©ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Storage](https://stackoverflow.com/questions/tagged/postgresql+storage) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-05
