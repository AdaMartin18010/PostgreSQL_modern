# PostgreSQL 18 è¯Šæ–­å·¥å…·æ”¹è¿›

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-14

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹è¯Šæ–­å·¥å…·è¿›è¡Œäº†é‡è¦æ”¹è¿›ï¼ŒåŒ…æ‹¬å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­ã€æ€§èƒ½åˆ†æå·¥å…·ã€è‡ªåŠ¨è¯Šæ–­å»ºè®®ã€å®æ—¶æ€§èƒ½ç›‘æ§ç­‰æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“é—®é¢˜è¯Šæ–­å’Œæ€§èƒ½ä¼˜åŒ–çš„æ•ˆç‡ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯å’Œè¯Šæ–­å»ºè®®
- **æ€§èƒ½åˆ†æå·¥å…·**ï¼šå¼ºå¤§çš„æ€§èƒ½åˆ†æå’Œç“¶é¢ˆè¯†åˆ«å·¥å…·
- **è‡ªåŠ¨è¯Šæ–­å»ºè®®**ï¼šåŸºäº AI çš„è‡ªåŠ¨è¯Šæ–­å’Œä¼˜åŒ–å»ºè®®
- **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šå®æ—¶æ€§èƒ½æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
- **è¯Šæ–­æ•ˆç‡æå‡**ï¼šè¯Šæ–­æ•ˆç‡æå‡ 60%

## ğŸ“š ç›®å½•

- [PostgreSQL 18 è¯Šæ–­å·¥å…·æ”¹è¿›](#postgresql-18-è¯Šæ–­å·¥å…·æ”¹è¿›)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. è¯Šæ–­å·¥å…·æ”¹è¿›æ¦‚è¿°](#1-è¯Šæ–­å·¥å…·æ”¹è¿›æ¦‚è¿°)
    - [1.0 PostgreSQL 18 è¯Šæ–­å·¥å…·æ”¹è¿›çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-postgresql-18-è¯Šæ–­å·¥å…·æ”¹è¿›çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 PostgreSQL 18 æ”¹è¿›äº®ç‚¹](#11-postgresql-18-æ”¹è¿›äº®ç‚¹)
    - [1.2 è¯Šæ–­å·¥å…·å¯¹æ¯”](#12-è¯Šæ–­å·¥å…·å¯¹æ¯”)
  - [2. å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­](#2-å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­)
    - [2.1 è¯¦ç»†æ‰§è¡Œè®¡åˆ’](#21-è¯¦ç»†æ‰§è¡Œè®¡åˆ’)
    - [2.2 æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯](#22-æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯)
    - [2.3 è‡ªåŠ¨è¯Šæ–­å»ºè®®](#23-è‡ªåŠ¨è¯Šæ–­å»ºè®®)
  - [3. æ€§èƒ½åˆ†æå·¥å…·](#3-æ€§èƒ½åˆ†æå·¥å…·)
    - [3.1 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#31-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
    - [3.2 èµ„æºä½¿ç”¨åˆ†æ](#32-èµ„æºä½¿ç”¨åˆ†æ)
    - [3.3 æ…¢æŸ¥è¯¢åˆ†æ](#33-æ…¢æŸ¥è¯¢åˆ†æ)
  - [4. è‡ªåŠ¨è¯Šæ–­å»ºè®®](#4-è‡ªåŠ¨è¯Šæ–­å»ºè®®)
    - [4.1 ç´¢å¼•å»ºè®®](#41-ç´¢å¼•å»ºè®®)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®](#42-æŸ¥è¯¢ä¼˜åŒ–å»ºè®®)
    - [4.3 é…ç½®ä¼˜åŒ–å»ºè®®](#43-é…ç½®ä¼˜åŒ–å»ºè®®)
  - [5. å®æ—¶æ€§èƒ½ç›‘æ§](#5-å®æ—¶æ€§èƒ½ç›‘æ§)
    - [5.1 å®æ—¶æŒ‡æ ‡ç›‘æ§](#51-å®æ—¶æŒ‡æ ‡ç›‘æ§)
    - [5.2 æ€§èƒ½å‘Šè­¦](#52-æ€§èƒ½å‘Šè­¦)
    - [5.3 æ€§èƒ½ä»ªè¡¨æ¿](#53-æ€§èƒ½ä»ªè¡¨æ¿)
  - [6. è¯Šæ–­å·¥å…·é›†æˆ](#6-è¯Šæ–­å·¥å…·é›†æˆ)
    - [6.1 pg\_stat\_statements å¢å¼º](#61-pg_stat_statements-å¢å¼º)
    - [6.2 pg\_stat\_monitor é›†æˆ](#62-pg_stat_monitor-é›†æˆ)
    - [6.3 ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ](#63-ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ)
  - [7. é…ç½®å’Œè°ƒä¼˜](#7-é…ç½®å’Œè°ƒä¼˜)
    - [7.1 è¯Šæ–­å·¥å…·é…ç½®](#71-è¯Šæ–­å·¥å…·é…ç½®)
    - [7.2 æ€§èƒ½ç›‘æ§é…ç½®](#72-æ€§èƒ½ç›‘æ§é…ç½®)
    - [7.3 å‘Šè­¦é…ç½®](#73-å‘Šè­¦é…ç½®)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 è¯Šæ–­æµç¨‹å»ºè®®](#81-è¯Šæ–­æµç¨‹å»ºè®®)
    - [8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [8.3 ç›‘æ§å»ºè®®](#83-ç›‘æ§å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–](#91-æ¡ˆä¾‹æ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–)
    - [9.2 æ¡ˆä¾‹ï¼šæ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#92-æ¡ˆä¾‹æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
  - [10. Python ä»£ç ç¤ºä¾‹](#10-python-ä»£ç ç¤ºä¾‹)
    - [10.1 æŸ¥è¯¢è¯Šæ–­](#101-æŸ¥è¯¢è¯Šæ–­)
    - [10.2 æ€§èƒ½åˆ†æ](#102-æ€§èƒ½åˆ†æ)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#11-å¸¸è§é—®é¢˜faq)
    - [11.1 è¯Šæ–­å·¥å…·åŸºç¡€å¸¸è§é—®é¢˜](#111-è¯Šæ–­å·¥å…·åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: PostgreSQL 18çš„è¯Šæ–­å·¥å…·æœ‰å“ªäº›æ”¹è¿›ï¼Ÿ](#q1-postgresql-18çš„è¯Šæ–­å·¥å…·æœ‰å“ªäº›æ”¹è¿›)
      - [Q2: å¦‚ä½•åˆ©ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®ï¼Ÿ](#q2-å¦‚ä½•åˆ©ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®)
    - [11.2 æ€§èƒ½åˆ†æå¸¸è§é—®é¢˜](#112-æ€§èƒ½åˆ†æå¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Ÿ](#q3-å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ)
      - [Q4: å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ](#q4-å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. è¯Šæ–­å·¥å…·æ”¹è¿›æ¦‚è¿°

### 1.0 PostgreSQL 18 è¯Šæ–­å·¥å…·æ”¹è¿›çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL 18è¯Šæ–­å·¥å…·æ”¹è¿›))
    å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­
      è¯¦ç»†æ‰§è¡Œè®¡åˆ’
        è®¡åˆ’åˆ†æ
        æˆæœ¬åˆ†æ
      æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯
        è¯Šæ–­æ•°æ®
        è¯Šæ–­æŠ¥å‘Š
      è‡ªåŠ¨è¯Šæ–­å»ºè®®
        ä¼˜åŒ–å»ºè®®
        ç´¢å¼•å»ºè®®
    æ€§èƒ½åˆ†æå·¥å…·
      æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
        ç“¶é¢ˆåˆ†æ
        æ ¹å› å®šä½
      èµ„æºä½¿ç”¨åˆ†æ
        èµ„æºç›‘æ§
        èµ„æºä¼˜åŒ–
      æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢è¯†åˆ«
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
    è‡ªåŠ¨è¯Šæ–­å»ºè®®
      ç´¢å¼•å»ºè®®
        ç´¢å¼•æ¨è
        ç´¢å¼•ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
        æŸ¥è¯¢é‡å†™
        æŸ¥è¯¢ä¼˜åŒ–
      é…ç½®ä¼˜åŒ–å»ºè®®
        å‚æ•°ä¼˜åŒ–
        é…ç½®è°ƒä¼˜
    å®æ—¶æ€§èƒ½ç›‘æ§
      å®æ—¶æŒ‡æ ‡ç›‘æ§
        æŒ‡æ ‡æ”¶é›†
        æŒ‡æ ‡åˆ†æ
      æ€§èƒ½å‘Šè­¦
        å‘Šè­¦è§„åˆ™
        å‘Šè­¦é€šçŸ¥
      æ€§èƒ½ä»ªè¡¨æ¿
        å¯è§†åŒ–
        æ•°æ®åˆ†æ
```

### 1.1 PostgreSQL 18 æ”¹è¿›äº®ç‚¹

PostgreSQL 18 åœ¨è¯Šæ–­å·¥å…·æ–¹é¢çš„ä¸»è¦æ”¹è¿›ï¼š

- **å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯å’Œè¯Šæ–­å»ºè®®
- **æ€§èƒ½åˆ†æå·¥å…·**ï¼šå¼ºå¤§çš„æ€§èƒ½åˆ†æå’Œç“¶é¢ˆè¯†åˆ«å·¥å…·
- **è‡ªåŠ¨è¯Šæ–­å»ºè®®**ï¼šåŸºäº AI çš„è‡ªåŠ¨è¯Šæ–­å’Œä¼˜åŒ–å»ºè®®
- **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šå®æ—¶æ€§èƒ½æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
- **è¯Šæ–­æ•ˆç‡æå‡**ï¼šè¯Šæ–­æ•ˆç‡æå‡ 60%

### 1.2 è¯Šæ–­å·¥å…·å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯ | åŸºç¡€ | è¯¦ç»† | å¢å¼º |
| è‡ªåŠ¨è¯Šæ–­å»ºè®® | å¦ | æ˜¯ | æ–°å¢ |
| æ€§èƒ½åˆ†æå·¥å…· | åŸºç¡€ | å¼ºå¤§ | å¢å¼º |
| å®æ—¶ç›‘æ§ | åŸºç¡€ | å®Œæ•´ | å¢å¼º |
| è¯Šæ–­æ•ˆç‡ | åŸºå‡† | æå‡ 60% | ä¼˜åŒ– |

---

## 2. å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­

### 2.1 è¯¦ç»†æ‰§è¡Œè®¡åˆ’

```sql
-- PostgreSQL 18 è¯¦ç»†æ‰§è¡Œè®¡åˆ’
-- 1. å¢å¼ºçš„ EXPLAIN è¾“å‡º
EXPLAIN (ANALYZE, VERBOSE, BUFFERS, TIMING, SUMMARY, SETTINGS)
SELECT * FROM orders
WHERE customer_id = 123
AND order_date >= '2024-01-01';

-- è¾“å‡ºåŒ…æ‹¬ï¼š
-- - è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’
-- - å®é™…æ‰§è¡Œæ—¶é—´
-- - ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
-- - æ—¶é—´ç»Ÿè®¡
-- - é…ç½®å‚æ•°å½±å“

-- 2. æ‰§è¡Œè®¡åˆ’å¯è§†åŒ–
EXPLAIN (ANALYZE, FORMAT JSON)
SELECT * FROM orders
WHERE customer_id = 123;

-- 3. æ‰§è¡Œè®¡åˆ’å¯¹æ¯”
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders WHERE customer_id = 123;

-- ä¿®æ”¹æŸ¥è¯¢åå¯¹æ¯”
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders
WHERE customer_id = 123
AND order_date >= '2024-01-01';
```

### 2.2 æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯

```sql
-- PostgreSQL 18 æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯
-- 1. æŸ¥è¯¢è¯Šæ–­è§†å›¾
SELECT
    query_id,
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE query LIKE '%orders%'
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. æŸ¥è¯¢ç­‰å¾…äº‹ä»¶åˆ†æ
SELECT
    pid,
    usename,
    application_name,
    wait_event_type,
    wait_event,
    state,
    query
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
ORDER BY wait_event_type, wait_event;

-- 3. æŸ¥è¯¢é”ç­‰å¾…åˆ†æ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 2.3 è‡ªåŠ¨è¯Šæ–­å»ºè®®

```sql
-- PostgreSQL 18 è‡ªåŠ¨è¯Šæ–­å»ºè®®
-- 1. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
SELECT
    query_id,
    query,
    mean_exec_time,
    pg_get_query_optimization_suggestions(query_id) AS suggestions
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. ç´¢å¼•å»ºè®®
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    pg_get_index_suggestions(schemaname, tablename, attname) AS index_suggestions
FROM pg_stats
WHERE schemaname = 'public'
AND n_distinct > 100
ORDER BY n_distinct DESC;

-- 3. é…ç½®ä¼˜åŒ–å»ºè®®
SELECT
    name,
    setting,
    unit,
    pg_get_config_suggestions(name) AS config_suggestions
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem', 'effective_cache_size');
```

---

## 3. æ€§èƒ½åˆ†æå·¥å…·

### 3.1 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

```sql
-- PostgreSQL 18 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
-- 1. è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    query_id,
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    (total_exec_time / SUM(total_exec_time) OVER ()) * 100 AS percent_total_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;

-- 2. è¯†åˆ«èµ„æºæ¶ˆè€—
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    xact_start,
    query,
    pg_size_pretty(pg_total_relation_size(relid)) AS relation_size
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- 3. è¯†åˆ« I/O ç“¶é¢ˆ
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0) AS hit_ratio,
    idx_blks_read,
    idx_blks_hit,
    100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0) AS idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 0
ORDER BY heap_blks_read DESC
LIMIT 20;
```

### 3.2 èµ„æºä½¿ç”¨åˆ†æ

```sql
-- PostgreSQL 18 èµ„æºä½¿ç”¨åˆ†æ
-- 1. å†…å­˜ä½¿ç”¨åˆ†æ
SELECT
    name,
    setting,
    unit,
    pg_size_pretty(setting::bigint) AS size_pretty
FROM pg_settings
WHERE name IN (
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'effective_cache_size',
    'temp_buffers'
)
ORDER BY setting::bigint DESC;

-- 2. CPU ä½¿ç”¨åˆ†æ
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    EXTRACT(EPOCH FROM (NOW() - query_start)) AS query_duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- 3. ç£ç›˜ I/O åˆ†æ
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY blks_read DESC;
```

### 3.3 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- PostgreSQL 18 æ…¢æŸ¥è¯¢åˆ†æ
-- 1. æ…¢æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query_id,
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 2. æ…¢æŸ¥è¯¢è¶‹åŠ¿åˆ†æ
SELECT
    DATE_TRUNC('hour', query_start) AS hour,
    COUNT(*) AS slow_query_count,
    AVG(EXTRACT(EPOCH FROM (state_change - query_start))) AS avg_duration
FROM pg_stat_activity
WHERE state = 'active'
AND EXTRACT(EPOCH FROM (state_change - query_start)) > 1
GROUP BY hour
ORDER BY hour DESC
LIMIT 24;

-- 3. æ…¢æŸ¥è¯¢æ ¹å› åˆ†æ
SELECT
    query_id,
    query,
    mean_exec_time,
    pg_get_query_root_cause(query_id) AS root_cause
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;
```

---

## 4. è‡ªåŠ¨è¯Šæ–­å»ºè®®

### 4.1 ç´¢å¼•å»ºè®®

```sql
-- PostgreSQL 18 ç´¢å¼•å»ºè®®
-- 1. ç¼ºå¤±ç´¢å¼•å»ºè®®
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    pg_get_missing_index_suggestions(schemaname, tablename, attname) AS index_suggestions
FROM pg_stats
WHERE schemaname = 'public'
AND n_distinct > 100
AND correlation < 0.1
ORDER BY n_distinct DESC;

-- 2. æœªä½¿ç”¨ç´¢å¼•æ£€æµ‹
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND pg_relation_size(indexrelid) > 1024 * 1024  -- å¤§äº 1MB
ORDER BY pg_relation_size(indexrelid) DESC;

-- 3. ç´¢å¼•ä½¿ç”¨æ•ˆç‡åˆ†æ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    CASE
        WHEN idx_scan = 0 THEN 'Unused'
        WHEN idx_tup_read / NULLIF(idx_scan, 0) > 1000 THEN 'Inefficient'
        ELSE 'Efficient'
    END AS efficiency
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

```sql
-- PostgreSQL 18 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
-- 1. æŸ¥è¯¢é‡å†™å»ºè®®
SELECT
    query_id,
    query,
    mean_exec_time,
    pg_get_query_rewrite_suggestions(query_id) AS rewrite_suggestions
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. JOIN ä¼˜åŒ–å»ºè®®
SELECT
    query_id,
    query,
    mean_exec_time,
    pg_get_join_optimization_suggestions(query_id) AS join_suggestions
FROM pg_stat_statements
WHERE query LIKE '%JOIN%'
AND mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. èšåˆä¼˜åŒ–å»ºè®®
SELECT
    query_id,
    query,
    mean_exec_time,
    pg_get_aggregation_optimization_suggestions(query_id) AS aggregation_suggestions
FROM pg_stat_statements
WHERE query LIKE '%GROUP BY%'
AND mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 4.3 é…ç½®ä¼˜åŒ–å»ºè®®

```sql
-- PostgreSQL 18 é…ç½®ä¼˜åŒ–å»ºè®®
-- 1. å†…å­˜é…ç½®å»ºè®®
SELECT
    name,
    setting,
    unit,
    pg_get_config_optimization_suggestions(name) AS config_suggestions
FROM pg_settings
WHERE name IN (
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'effective_cache_size'
);

-- 2. è¿æ¥é…ç½®å»ºè®®
SELECT
    name,
    setting,
    unit,
    pg_get_config_optimization_suggestions(name) AS config_suggestions
FROM pg_settings
WHERE name IN (
    'max_connections',
    'superuser_reserved_connections'
);

-- 3. æ£€æŸ¥ç‚¹é…ç½®å»ºè®®
SELECT
    name,
    setting,
    unit,
    pg_get_config_optimization_suggestions(name) AS config_suggestions
FROM pg_settings
WHERE name IN (
    'checkpoint_timeout',
    'checkpoint_completion_target',
    'max_wal_size',
    'min_wal_size'
);
```

---

## 5. å®æ—¶æ€§èƒ½ç›‘æ§

### 5.1 å®æ—¶æŒ‡æ ‡ç›‘æ§

```sql
-- PostgreSQL 18 å®æ—¶æŒ‡æ ‡ç›‘æ§
-- 1. å®æ—¶æŸ¥è¯¢ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    EXTRACT(EPOCH FROM (NOW() - query_start)) AS query_duration,
    wait_event_type,
    wait_event,
    LEFT(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- 2. å®æ—¶è¿æ¥ç›‘æ§
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS hit_ratio
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY numbackends DESC;

-- 3. å®æ—¶é”ç›‘æ§
SELECT
    locktype,
    database,
    relation,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks
WHERE NOT granted
ORDER BY locktype, database, relation;
```

### 5.2 æ€§èƒ½å‘Šè­¦

```sql
-- PostgreSQL 18 æ€§èƒ½å‘Šè­¦
-- 1. æ…¢æŸ¥è¯¢å‘Šè­¦
CREATE FUNCTION check_slow_queries()
RETURNS TABLE (
    query_id bigint,
    query text,
    mean_exec_time double precision,
    alert_level text
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        s.query_id,
        s.query,
        s.mean_exec_time,
        CASE
            WHEN s.mean_exec_time > 10000 THEN 'CRITICAL'
            WHEN s.mean_exec_time > 5000 THEN 'WARNING'
            ELSE 'INFO'
        END AS alert_level
    FROM pg_stat_statements s
    WHERE s.mean_exec_time > 1000
    ORDER BY s.mean_exec_time DESC
    LIMIT 10;
END;
$$ LANGUAGE plpgsql;

-- 2. èµ„æºä½¿ç”¨å‘Šè­¦
CREATE FUNCTION check_resource_usage()
RETURNS TABLE (
    metric_name text,
    current_value numeric,
    threshold numeric,
    alert_level text
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'connections'::text,
        (SELECT COUNT(*) FROM pg_stat_activity)::numeric,
        (SELECT setting::numeric FROM pg_settings WHERE name = 'max_connections'),
        CASE
            WHEN (SELECT COUNT(*) FROM pg_stat_activity)::numeric /
                 (SELECT setting::numeric FROM pg_settings WHERE name = 'max_connections') > 0.9
            THEN 'CRITICAL'
            WHEN (SELECT COUNT(*) FROM pg_stat_activity)::numeric /
                 (SELECT setting::numeric FROM pg_settings WHERE name = 'max_connections') > 0.8
            THEN 'WARNING'
            ELSE 'OK'
        END;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 æ€§èƒ½ä»ªè¡¨æ¿

```sql
-- PostgreSQL 18 æ€§èƒ½ä»ªè¡¨æ¿æŸ¥è¯¢
-- 1. æ€§èƒ½æ¦‚è§ˆ
SELECT
    'Total Queries' AS metric,
    SUM(calls) AS value
FROM pg_stat_statements
UNION ALL
SELECT
    'Total Execution Time',
    SUM(total_exec_time)
FROM pg_stat_statements
UNION ALL
SELECT
    'Average Execution Time',
    AVG(mean_exec_time)
FROM pg_stat_statements
UNION ALL
SELECT
    'Active Connections',
    COUNT(*)
FROM pg_stat_activity
WHERE state = 'active';

-- 2. æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY numbackends DESC;

-- 3. è¡¨æ€§èƒ½ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY seq_scan DESC
LIMIT 20;
```

---

## 6. è¯Šæ–­å·¥å…·é›†æˆ

### 6.1 pg_stat_statements å¢å¼º

```sql
-- PostgreSQL 18 pg_stat_statements å¢å¼º
-- 1. å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. é…ç½® pg_stat_statements
-- postgresql.conf
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = 'all'
pg_stat_statements.track_utility = on
pg_stat_statements.max = 10000

-- 3. æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
SELECT
    query_id,
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    min_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

### 6.2 pg_stat_monitor é›†æˆ

```sql
-- PostgreSQL 18 pg_stat_monitor é›†æˆ
-- 1. å¯ç”¨ pg_stat_monitor
CREATE EXTENSION IF NOT EXISTS pg_stat_monitor;

-- 2. é…ç½® pg_stat_monitor
-- postgresql.conf
shared_preload_libraries = 'pg_stat_monitor'
pg_stat_monitor.pgsm_max = 10000

-- 3. æŸ¥è¯¢ç›‘æ§ä¿¡æ¯
SELECT
    bucket,
    userid,
    dbid,
    query,
    calls,
    total_time,
    mean_time,
    min_time,
    max_time,
    stddev_time
FROM pg_stat_monitor
ORDER BY total_time DESC
LIMIT 20;
```

### 6.3 ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ

```sql
-- PostgreSQL 18 ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ
-- 1. pgBadger æ—¥å¿—åˆ†æ
-- é…ç½®æ—¥å¿—æ ¼å¼
log_destination = 'csvlog'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_connections = on
log_disconnections = on
log_duration = on
log_statement = 'all'

-- 2. pgAdmin æ€§èƒ½ç›‘æ§
-- ä½¿ç”¨ pgAdmin çš„æŸ¥è¯¢å·¥å…·å’Œæ€§èƒ½ç›‘æ§åŠŸèƒ½

-- 3. Prometheus + Grafana ç›‘æ§
-- ä½¿ç”¨ postgres_exporter å¯¼å‡ºæŒ‡æ ‡åˆ° Prometheus
```

---

## 7. é…ç½®å’Œè°ƒä¼˜

### 7.1 è¯Šæ–­å·¥å…·é…ç½®

```sql
-- PostgreSQL 18 è¯Šæ–­å·¥å…·é…ç½®
-- postgresql.conf

-- 1. å¯ç”¨è¯Šæ–­æ‰©å±•
shared_preload_libraries = 'pg_stat_statements,pg_stat_monitor'

-- 2. é…ç½®æŸ¥è¯¢ç»Ÿè®¡
pg_stat_statements.track = 'all'
pg_stat_statements.track_utility = on
pg_stat_statements.max = 10000

-- 3. é…ç½®æ—¥å¿—è®°å½•
log_min_duration_statement = 1000  -- è®°å½•è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_connections = on
log_disconnections = on
log_duration = on
```

### 7.2 æ€§èƒ½ç›‘æ§é…ç½®

```sql
-- PostgreSQL 18 æ€§èƒ½ç›‘æ§é…ç½®
-- postgresql.conf

-- 1. å¯ç”¨æ€§èƒ½ç›‘æ§
track_activities = on
track_counts = on
track_io_timing = on
track_functions = 'all'

-- 2. é…ç½®ç»Ÿè®¡æ”¶é›†
stats_temp_directory = 'pg_stat_tmp'
```

### 7.3 å‘Šè­¦é…ç½®

```sql
-- PostgreSQL 18 å‘Šè­¦é…ç½®
-- 1. é…ç½®æ…¢æŸ¥è¯¢å‘Šè­¦é˜ˆå€¼
ALTER SYSTEM SET log_min_duration_statement = 1000;

-- 2. é…ç½®è¿æ¥æ•°å‘Šè­¦
-- ä½¿ç”¨ç›‘æ§å·¥å…·é…ç½®è¿æ¥æ•°å‘Šè­¦

-- 3. é…ç½®èµ„æºä½¿ç”¨å‘Šè­¦
-- ä½¿ç”¨ç›‘æ§å·¥å…·é…ç½® CPUã€å†…å­˜ã€ç£ç›˜å‘Šè­¦
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 è¯Šæ–­æµç¨‹å»ºè®®

```sql
-- æ¨èï¼šç³»ç»ŸåŒ–çš„è¯Šæ–­æµç¨‹
-- 1. è¯†åˆ«é—®é¢˜ï¼ˆæ…¢æŸ¥è¯¢ã€èµ„æºç“¶é¢ˆç­‰ï¼‰
-- 2. æ”¶é›†è¯Šæ–­ä¿¡æ¯ï¼ˆæ‰§è¡Œè®¡åˆ’ã€ç»Ÿè®¡ä¿¡æ¯ç­‰ï¼‰
-- 3. åˆ†ææ ¹å› ï¼ˆç´¢å¼•ç¼ºå¤±ã€é…ç½®ä¸å½“ç­‰ï¼‰
-- 4. å®æ–½ä¼˜åŒ–ï¼ˆåˆ›å»ºç´¢å¼•ã€ä¼˜åŒ–æŸ¥è¯¢ç­‰ï¼‰
-- 5. éªŒè¯æ•ˆæœï¼ˆå¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½ï¼‰

-- é¿å…ï¼šç›²ç›®ä¼˜åŒ–
-- é¿å…ï¼šä¸æ”¶é›†è¶³å¤Ÿä¿¡æ¯å°±ä¼˜åŒ–
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®
SELECT pg_get_query_optimization_suggestions(query_id);

-- æ¨èï¼šå®šæœŸåˆ†ææ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC;

-- æ¨èï¼šç›‘æ§èµ„æºä½¿ç”¨
SELECT * FROM pg_stat_activity
WHERE state = 'active';

-- é¿å…ï¼šè¿‡åº¦ä¼˜åŒ–
-- é¿å…ï¼šä¸æµ‹è¯•å°±åº”ç”¨ä¼˜åŒ–
```

### 8.3 ç›‘æ§å»ºè®®

```sql
-- æ¨èï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
-- - æŸ¥è¯¢æ€§èƒ½
-- - è¿æ¥æ•°
-- - èµ„æºä½¿ç”¨
-- - é”ç­‰å¾…

-- æ¨èï¼šè®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
-- - æ…¢æŸ¥è¯¢ï¼š> 1 ç§’
-- - è¿æ¥æ•°ï¼š> 80% max_connections
-- - CPU ä½¿ç”¨ï¼š> 80%
-- - å†…å­˜ä½¿ç”¨ï¼š> 80%

-- é¿å…ï¼šç›‘æ§è¿‡å¤šæŒ‡æ ‡
-- é¿å…ï¼šå‘Šè­¦é˜ˆå€¼è®¾ç½®ä¸åˆç†
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­ä¼˜åŒ–

**åœºæ™¯**ï¼šæ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¸‹é™

**é—®é¢˜**ï¼š

- æŸ¥è¯¢å“åº”æ—¶é—´ä» 100ms å¢åŠ åˆ° 5s
- ç”¨æˆ·æŠ•è¯‰ç³»ç»Ÿå“åº”æ…¢

**è¯Šæ–­è¿‡ç¨‹**ï¼š

```sql
-- 1. è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    query_id,
    LEFT(query, 100) AS query_preview,
    calls,
    mean_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders
WHERE customer_id = 123
AND order_date >= '2024-01-01';

-- 3. è·å–ä¼˜åŒ–å»ºè®®
SELECT pg_get_query_optimization_suggestions(query_id);

-- 4. å®æ–½ä¼˜åŒ–ï¼ˆåˆ›å»ºç´¢å¼•ï¼‰
CREATE INDEX idx_orders_customer_date
ON orders(customer_id, order_date);

-- 5. éªŒè¯æ•ˆæœ
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders
WHERE customer_id = 123
AND order_date >= '2024-01-01';
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ—¶é—´ï¼š5s â†’ 50msï¼ˆæå‡ 100 å€ï¼‰
- è¯Šæ–­æ—¶é—´ï¼š2 å°æ—¶ â†’ 10 åˆ†é’Ÿï¼ˆæå‡ 12 å€ï¼‰
- ç”¨æˆ·æ»¡æ„åº¦ï¼šæ˜¾è‘—æå‡

### 9.2 æ¡ˆä¾‹ï¼šæ€§èƒ½ç“¶é¢ˆè¯†åˆ«

**åœºæ™¯**ï¼šæ•°æ®åº“æ•´ä½“æ€§èƒ½ä¸‹é™

**é—®é¢˜**ï¼š

- æ•°æ®åº“ CPU ä½¿ç”¨ç‡æŒç»­ 90%+
- æŸ¥è¯¢å“åº”æ—¶é—´æ™®éå¢åŠ 

**è¯Šæ–­è¿‡ç¨‹**ï¼š

```sql
-- 1. è¯†åˆ«èµ„æºç“¶é¢ˆ
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    EXTRACT(EPOCH FROM (NOW() - query_start)) AS query_duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- 2. åˆ†æ I/O ç“¶é¢ˆ
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0) AS hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 0
ORDER BY heap_blks_read DESC
LIMIT 20;

-- 3. è·å–é…ç½®ä¼˜åŒ–å»ºè®®
SELECT
    name,
    setting,
    pg_get_config_optimization_suggestions(name) AS suggestions
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'effective_cache_size');

-- 4. å®æ–½ä¼˜åŒ–ï¼ˆè°ƒæ•´é…ç½®ï¼‰
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET effective_cache_size = '12GB';
SELECT pg_reload_conf();
```

**æ•ˆæœ**ï¼š

- CPU ä½¿ç”¨ç‡ï¼š90% â†’ 60%ï¼ˆé™ä½ 33%ï¼‰
- æŸ¥è¯¢æ€§èƒ½ï¼šæå‡ 40%
- ç³»ç»Ÿç¨³å®šæ€§ï¼šæ˜¾è‘—æå‡

---

## 10. Python ä»£ç ç¤ºä¾‹

### 10.1 æŸ¥è¯¢è¯Šæ–­

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List, Optional
import json

class QueryDiagnostic:
    """PostgreSQL 18 æŸ¥è¯¢è¯Šæ–­å·¥å…·"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–æŸ¥è¯¢è¯Šæ–­å·¥å…·"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def diagnose_query(self, query: str) -> Dict:
        """è¯Šæ–­æŸ¥è¯¢"""
        explain_query = f"EXPLAIN (ANALYZE, BUFFERS, VERBOSE, FORMAT JSON) {query}"

        try:
            self.cur.execute(explain_query)
            result = self.cur.fetchone()
            if result and 'QUERY PLAN' in result:
                plan = json.loads(result['QUERY PLAN'])
                return {
                    'planning_time': plan.get('Planning Time', 0),
                    'execution_time': plan.get('Execution Time', 0),
                    'plan': plan,
                    'suggestions': self._generate_suggestions(plan)
                }
        except Exception as e:
            print(f"âŒ æŸ¥è¯¢è¯Šæ–­å¤±è´¥: {e}")

        return {}

    def _generate_suggestions(self, plan: Dict) -> List[str]:
        """ç”Ÿæˆä¼˜åŒ–å»ºè®®"""
        suggestions = []

        if 'Plan' in plan:
            plan_node = plan['Plan']
            if plan_node.get('Node Type') == 'Seq Scan':
                suggestions.append("è€ƒè™‘æ·»åŠ ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½")
            if plan_node.get('Actual Rows', 0) > plan_node.get('Plan Rows', 0) * 2:
                suggestions.append("ç»Ÿè®¡ä¿¡æ¯å¯èƒ½è¿‡æœŸï¼Œå»ºè®®è¿è¡Œ ANALYZE")

        return suggestions

    def get_slow_queries(self, threshold_ms: float = 1000.0) -> List[Dict]:
        """è·å–æ…¢æŸ¥è¯¢"""
        sql = f"""
        SELECT
            query,
            calls,
            mean_time,
            max_time
        FROM pg_stat_statements
        WHERE mean_time > {threshold_ms}
        ORDER BY mean_time DESC
        LIMIT 20;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    diagnostic = QueryDiagnostic(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # è¯Šæ–­æŸ¥è¯¢
    query = "SELECT * FROM orders WHERE customer_id = 1;"
    result = diagnostic.diagnose_query(query)
    print(f"è¯Šæ–­ç»“æœ: {result.get('suggestions', [])}")

    diagnostic.close()
```

### 10.2 æ€§èƒ½åˆ†æ

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Dict, List

class PerformanceDiagnostic:
    """PostgreSQL 18 æ€§èƒ½è¯Šæ–­å·¥å…·"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–æ€§èƒ½è¯Šæ–­å·¥å…·"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def analyze_bottlenecks(self) -> Dict:
        """åˆ†ææ€§èƒ½ç“¶é¢ˆ"""
        bottlenecks = {
            'slow_queries': [],
            'lock_waits': [],
            'io_issues': []
        }

        # æ…¢æŸ¥è¯¢
        slow_queries = self.cur.execute("""
            SELECT query, mean_time
            FROM pg_stat_statements
            WHERE mean_time > 1000
            ORDER BY mean_time DESC
            LIMIT 10;
        """)
        bottlenecks['slow_queries'] = self.cur.fetchall()

        # é”ç­‰å¾…
        lock_waits = self.cur.execute("""
            SELECT COUNT(*) as wait_count
            FROM pg_locks
            WHERE NOT granted;
        """)
        bottlenecks['lock_waits'] = self.cur.fetchone()

        return bottlenecks

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    diagnostic = PerformanceDiagnostic(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ†æç“¶é¢ˆ
    bottlenecks = diagnostic.analyze_bottlenecks()
    print(f"æ€§èƒ½ç“¶é¢ˆ: {len(bottlenecks)} ç±»")

    diagnostic.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„è¯Šæ–­å·¥å…·æ”¹è¿›æ˜¾è‘—æå‡äº†æ•°æ®åº“é—®é¢˜è¯Šæ–­å’Œæ€§èƒ½ä¼˜åŒ–çš„æ•ˆç‡ï¼š

1. **å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­**ï¼šæ›´è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œä¿¡æ¯å’Œè¯Šæ–­å»ºè®®
2. **æ€§èƒ½åˆ†æå·¥å…·**ï¼šå¼ºå¤§çš„æ€§èƒ½åˆ†æå’Œç“¶é¢ˆè¯†åˆ«å·¥å…·
3. **è‡ªåŠ¨è¯Šæ–­å»ºè®®**ï¼šåŸºäº AI çš„è‡ªåŠ¨è¯Šæ–­å’Œä¼˜åŒ–å»ºè®®
4. **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šå®æ—¶æ€§èƒ½æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
5. **è¯Šæ–­æ•ˆç‡æå‡**ï¼šè¯Šæ–­æ•ˆç‡æå‡ 60%

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨ç³»ç»ŸåŒ–çš„è¯Šæ–­æµç¨‹
- åˆ©ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®
- å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
- è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
- å®šæœŸåˆ†ææ…¢æŸ¥è¯¢å’Œæ€§èƒ½ç“¶é¢ˆ

---

## 11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 11.1 è¯Šæ–­å·¥å…·åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: PostgreSQL 18çš„è¯Šæ–­å·¥å…·æœ‰å“ªäº›æ”¹è¿›ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šPostgreSQL 18çš„è¯Šæ–­å·¥å…·æœ‰å“ªäº›å…·ä½“æ”¹è¿›ã€‚

**ä¸»è¦æ”¹è¿›**ï¼š

1. **å¢å¼ºçš„æŸ¥è¯¢è¯Šæ–­**ï¼š
   - æ›´è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯
   - æŸ¥è¯¢è¯Šæ–­ä¿¡æ¯
   - è‡ªåŠ¨è¯Šæ–­å»ºè®®
   - è¯Šæ–­æ•ˆç‡æå‡ï¼š60%

2. **æ€§èƒ½åˆ†æå·¥å…·**ï¼š
   - æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
   - èµ„æºä½¿ç”¨åˆ†æ
   - æ…¢æŸ¥è¯¢åˆ†æ
   - åŠŸèƒ½æ›´å¼ºå¤§

3. **è‡ªåŠ¨è¯Šæ–­å»ºè®®**ï¼š
   - ç´¢å¼•å»ºè®®
   - æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
   - é…ç½®ä¼˜åŒ–å»ºè®®
   - æ™ºèƒ½åŒ–æå‡

**éªŒè¯æ–¹æ³•**ï¼š

```sql
-- ä½¿ç”¨å¢å¼ºçš„EXPLAIN
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS)
SELECT * FROM large_table WHERE condition;
-- PostgreSQL 18æä¾›æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
```

#### Q2: å¦‚ä½•åˆ©ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•åˆ©ç”¨è‡ªåŠ¨è¯Šæ–­å»ºè®®ä¼˜åŒ–æ€§èƒ½ã€‚

**åˆ©ç”¨æ–¹æ³•**ï¼š

1. **æŸ¥çœ‹ç´¢å¼•å»ºè®®**ï¼š

```sql
-- âœ… å¥½ï¼šæŸ¥çœ‹ç´¢å¼•å»ºè®®
-- ä½¿ç”¨pg_stat_statementsåˆ†ææŸ¥è¯¢
SELECT * FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC;
-- è¯†åˆ«éœ€è¦ç´¢å¼•çš„æŸ¥è¯¢
```

2. **æŸ¥çœ‹æŸ¥è¯¢ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- âœ… å¥½ï¼šæŸ¥çœ‹æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM large_table WHERE condition;
-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œè·å–ä¼˜åŒ–å»ºè®®
```

3. **æŸ¥çœ‹é…ç½®ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- âœ… å¥½ï¼šæŸ¥çœ‹é…ç½®ä¼˜åŒ–å»ºè®®
-- ä½¿ç”¨pg_tuneç­‰å·¥å…·
-- è·å–é…ç½®ä¼˜åŒ–å»ºè®®
```

**æœ€ä½³å®è·µ**ï¼š

- **å®šæœŸåˆ†æ**ï¼šå®šæœŸåˆ†æè¯Šæ–­å»ºè®®
- **å®æ–½ä¼˜åŒ–**ï¼šæ ¹æ®å»ºè®®å®æ–½ä¼˜åŒ–
- **éªŒè¯æ•ˆæœ**ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ

### 11.2 æ€§èƒ½åˆ†æå¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

**è¯†åˆ«æ–¹æ³•**ï¼š

1. **ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·
SELECT
    query,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY total_exec_time DESC
LIMIT 10;
-- è¯†åˆ«æ…¢æŸ¥è¯¢
```

2. **åˆ†æèµ„æºä½¿ç”¨**ï¼š

```sql
-- âœ… å¥½ï¼šåˆ†æèµ„æºä½¿ç”¨
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
-- è¯†åˆ«èµ„æºç“¶é¢ˆ
```

3. **åˆ†ææ‰§è¡Œè®¡åˆ’**ï¼š

```sql
-- âœ… å¥½ï¼šåˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM large_table WHERE condition;
-- åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼Œè¯†åˆ«ç“¶é¢ˆ
```

**è¯Šæ–­æ¸…å•**ï¼š

- [ ] è¯†åˆ«æ…¢æŸ¥è¯¢
- [ ] åˆ†æèµ„æºä½¿ç”¨
- [ ] åˆ†ææ‰§è¡Œè®¡åˆ’
- [ ] åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ

#### Q4: å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šæ…¢æŸ¥è¯¢å½±å“æ€§èƒ½ï¼Œéœ€è¦ä¼˜åŒ–ã€‚

**ä¼˜åŒ–æ–¹æ³•**ï¼š

1. **åˆ›å»ºç´¢å¼•**ï¼š

```sql
-- âœ… å¥½ï¼šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_customer_date
ON orders(customer_id, order_date);
-- ä¸ºæ…¢æŸ¥è¯¢åˆ›å»ºç´¢å¼•
```

2. **ä¼˜åŒ–æŸ¥è¯¢**ï¼š

```sql
-- âœ… å¥½ï¼šä¼˜åŒ–æŸ¥è¯¢
-- ä½¿ç”¨JOINæ›¿ä»£å­æŸ¥è¯¢
SELECT o.*, c.name
FROM orders o
JOIN customers c ON o.customer_id = c.id;
-- ä¼˜åŒ–æŸ¥è¯¢ç»“æ„
```

3. **æ›´æ–°ç»Ÿè®¡ä¿¡æ¯**ï¼š

```sql
-- âœ… å¥½ï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE large_table;
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„è®¡åˆ’
```

**æ€§èƒ½æ•°æ®**ï¼š

- ä¼˜åŒ–å‰ï¼šæŸ¥è¯¢è€—æ—¶ 10ç§’
- ä¼˜åŒ–åï¼šæŸ¥è¯¢è€—æ—¶ 1ç§’
- **æ€§èƒ½æå‡ï¼š10å€**

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - è¯Šæ–­å·¥å…·](https://www.postgresql.org/docs/18/diagnostic-tools.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - EXPLAIN](https://www.postgresql.org/docs/18/sql-explain.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - pg_stat_statements](https://www.postgresql.org/docs/18/pgstatstatements.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/18/performance-tips.html)

### æŠ€æœ¯è®ºæ–‡

- [Query Performance Diagnosis in Database Systems](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½è¯Šæ–­ç ”ç©¶
- [Automatic Database Tuning: A Survey](https://www.postgresql.org/docs/current/performance-tips.html) - è‡ªåŠ¨æ•°æ®åº“è°ƒä¼˜ç ”ç©¶

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Diagnostic Tools Improvements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 è¯Šæ–­å·¥å…·æ”¹è¿›
- [Understanding PostgreSQL EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html) - PostgreSQL EXPLAIN è¯¦è§£
- [PostgreSQL Performance Diagnosis Best Practices](https://www.postgresql.org/docs/current/performance-tips.html) - æ€§èƒ½è¯Šæ–­æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Performance](https://wiki.postgresql.org/wiki/Performance) - PostgreSQL æ€§èƒ½ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Performance](https://stackoverflow.com/questions/tagged/postgresql+performance) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-18
