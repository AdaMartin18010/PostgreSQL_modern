# 02 | åˆ†å¸ƒå¼äº‹åŠ¡åè®®

> **åè®®å®šä½**: æœ¬æ–‡æ¡£åˆ†æ2PCã€3PCç­‰åˆ†å¸ƒå¼äº‹åŠ¡åè®®çš„åŸç†ã€ä¼˜ç¼ºç‚¹åŠåº”ç”¨åœºæ™¯ã€‚
> **ğŸ“– æ¦‚å¿µè¯å…¸å¼•ç”¨**ï¼šæœ¬æ–‡æ¡£ä¸­æ¶‰åŠçš„ 2PCã€3PCã€Sagaã€TCC ç­‰æ¦‚å¿µå®šä¹‰ä¸ [æ ¸å¿ƒæ¦‚å¿µè¯å…¸](../00-ç†è®ºæ¡†æ¶æ€»è§ˆ/01-æ ¸å¿ƒæ¦‚å¿µè¯å…¸.md) ä¿æŒä¸€è‡´ã€‚å¦‚å‘ç°ä¸ä¸€è‡´ï¼Œè¯·ä»¥æ ¸å¿ƒæ¦‚å¿µè¯å…¸ä¸ºå‡†ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | åˆ†å¸ƒå¼äº‹åŠ¡åè®®](#02--åˆ†å¸ƒå¼äº‹åŠ¡åè®®)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡åè®®èƒŒæ™¯ä¸æ¼”è¿›](#ä¸€åˆ†å¸ƒå¼äº‹åŠ¡åè®®èƒŒæ™¯ä¸æ¼”è¿›)
    - [0.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼Ÿ](#01-ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡åè®®)
    - [0.2 å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§](#02-å¼ºä¸€è‡´æ€§-vs-æœ€ç»ˆä¸€è‡´æ€§)
  - [äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°](#äºŒåˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°)
    - [1.1 ACIDæŒ‘æˆ˜](#11-acidæŒ‘æˆ˜)
    - [1.2 æ ¸å¿ƒé—®é¢˜](#12-æ ¸å¿ƒé—®é¢˜)
  - [äºŒã€ä¸¤é˜¶æ®µæäº¤(2PC)](#äºŒä¸¤é˜¶æ®µæäº¤2pc)
    - [2.1 åè®®æµç¨‹](#21-åè®®æµç¨‹)
    - [2.2 ä¼ªä»£ç å®ç°](#22-ä¼ªä»£ç å®ç°)
    - [2.3 æ•…éšœå¤„ç†](#23-æ•…éšœå¤„ç†)
    - [2.4 æ€§èƒ½åˆ†æ](#24-æ€§èƒ½åˆ†æ)
  - [ä¸‰ã€ä¸‰é˜¶æ®µæäº¤(3PC)](#ä¸‰ä¸‰é˜¶æ®µæäº¤3pc)
    - [3.1 æ”¹è¿›åŠ¨æœº](#31-æ”¹è¿›åŠ¨æœº)
    - [3.2 åè®®æµç¨‹](#32-åè®®æµç¨‹)
    - [3.3 è¶…æ—¶å¤„ç†](#33-è¶…æ—¶å¤„ç†)
    - [3.4 3PCçš„é—®é¢˜](#34-3pcçš„é—®é¢˜)
  - [å››ã€Sagaæ¨¡å¼](#å››sagaæ¨¡å¼)
    - [4.1 æ ¸å¿ƒæ€æƒ³](#41-æ ¸å¿ƒæ€æƒ³)
    - [4.2 ç¤ºä¾‹ï¼šè®¢å•å¤„ç†](#42-ç¤ºä¾‹è®¢å•å¤„ç†)
    - [4.3 Saga vs 2PC](#43-saga-vs-2pc)
  - [äº”ã€TCCæ¨¡å¼](#äº”tccæ¨¡å¼)
    - [5.1 ä¸‰é˜¶æ®µ](#51-ä¸‰é˜¶æ®µ)
    - [5.2 å®ç°ç¤ºä¾‹](#52-å®ç°ç¤ºä¾‹)
    - [5.3 TCC vs Saga](#53-tcc-vs-saga)
  - [å…­ã€åè®®å¯¹æ¯”](#å…­åè®®å¯¹æ¯”)
    - [6.1 ç»¼åˆå¯¹æ¯”çŸ©é˜µ](#61-ç»¼åˆå¯¹æ¯”çŸ©é˜µ)
    - [6.2 é€‰æ‹©å†³ç­–æ ‘](#62-é€‰æ‹©å†³ç­–æ ‘)
    - [6.3 å»¶è¿Ÿå¯¹æ¯”](#63-å»¶è¿Ÿå¯¹æ¯”)
  - [ä¸ƒã€æ€»ç»“](#ä¸ƒæ€»ç»“)
    - [7.1 æ ¸å¿ƒæ´å¯Ÿ](#71-æ ¸å¿ƒæ´å¯Ÿ)
    - [7.2 å®è·µå»ºè®®](#72-å®è·µå»ºè®®)
  - [å…«ã€å®Œæ•´å®ç°ä»£ç ](#å…«å®Œæ•´å®ç°ä»£ç )
    - [8.1 2PCåè°ƒå™¨å®Œæ•´å®ç°](#81-2pcåè°ƒå™¨å®Œæ•´å®ç°)
    - [8.2 Sagaåè°ƒå™¨å®ç°](#82-sagaåè°ƒå™¨å®ç°)
    - [8.3 TCCå®Œæ•´å®ç°](#83-tccå®Œæ•´å®ç°)
  - [ä¹ã€å®é™…ç”Ÿäº§æ¡ˆä¾‹](#ä¹å®é™…ç”Ÿäº§æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: å¾®æœåŠ¡è®¢å•ç³»ç»Ÿï¼ˆSagaæ¨¡å¼ï¼‰](#æ¡ˆä¾‹1-å¾®æœåŠ¡è®¢å•ç³»ç»Ÿsagaæ¨¡å¼)
    - [æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿï¼ˆTCCæ¨¡å¼ï¼‰](#æ¡ˆä¾‹2-é‡‘èè½¬è´¦ç³»ç»Ÿtccæ¨¡å¼)
  - [åã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#ååä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: 2PCåè°ƒå™¨å•ç‚¹æ•…éšœ](#åä¾‹1-2pcåè°ƒå™¨å•ç‚¹æ•…éšœ)
    - [åä¾‹2: Sagaè¡¥å¿ä¸å¹‚ç­‰](#åä¾‹2-sagaè¡¥å¿ä¸å¹‚ç­‰)
    - [åä¾‹3: 2PCè¶…æ—¶å¤„ç†ä¸å½“](#åä¾‹3-2pcè¶…æ—¶å¤„ç†ä¸å½“)
    - [åä¾‹4: TCC Confirmé˜¶æ®µå¤±è´¥æœªå¤„ç†](#åä¾‹4-tcc-confirmé˜¶æ®µå¤±è´¥æœªå¤„ç†)
    - [åä¾‹5: å¿½ç•¥ç½‘ç»œåˆ†åŒºåœºæ™¯](#åä¾‹5-å¿½ç•¥ç½‘ç»œåˆ†åŒºåœºæ™¯)
    - [åä¾‹6: åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½é—®é¢˜è¢«å¿½ç•¥](#åä¾‹6-åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½é—®é¢˜è¢«å¿½ç•¥)
  - [åä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡å¯è§†åŒ–](#åä¸€åˆ†å¸ƒå¼äº‹åŠ¡å¯è§†åŒ–)
    - [11.1 2PCåè®®åºåˆ—å›¾](#111-2pcåè®®åºåˆ—å›¾)
    - [11.2 Sagaæ¨¡å¼æµç¨‹å›¾](#112-sagaæ¨¡å¼æµç¨‹å›¾)
    - [11.3 åˆ†å¸ƒå¼äº‹åŠ¡åè®®é€‰æ‹©å†³ç­–æ ‘](#113-åˆ†å¸ƒå¼äº‹åŠ¡åè®®é€‰æ‹©å†³ç­–æ ‘)

---

## ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡åè®®èƒŒæ™¯ä¸æ¼”è¿›

### 0.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼Ÿ

**å†å²èƒŒæ™¯**:

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å‘å±•ä¸­ï¼Œå¦‚ä½•ä¿è¯è·¨èŠ‚ç‚¹äº‹åŠ¡çš„ACIDç‰¹æ€§ä¸€ç›´æ˜¯ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚
1970å¹´ä»£ï¼Œç ”ç©¶è€…æå‡ºäº†ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰åè®®ï¼Œè¿™æ˜¯æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ã€‚
ä½†2PCå­˜åœ¨åè°ƒå™¨å•ç‚¹æ•…éšœå’Œé˜»å¡é—®é¢˜ã€‚
1980å¹´ä»£ï¼Œç ”ç©¶è€…æå‡ºäº†ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰æ¥æ”¹è¿›2PCï¼Œä½†3PCä»ç„¶å­˜åœ¨é—®é¢˜ã€‚
2000å¹´ä»£ï¼Œéšç€å¾®æœåŠ¡æ¶æ„çš„å…´èµ·ï¼ŒSagaå’ŒTCCç­‰æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼è¢«æå‡ºï¼Œä¸ºåˆ†å¸ƒå¼äº‹åŠ¡æä¾›äº†æ–°çš„è§£å†³æ–¹æ¡ˆã€‚

**ç†è®ºåŸºç¡€**:

```text
åˆ†å¸ƒå¼äº‹åŠ¡åè®®çš„æ ¸å¿ƒ:
â”œâ”€ é—®é¢˜: å¦‚ä½•ä¿è¯è·¨èŠ‚ç‚¹äº‹åŠ¡çš„ACIDï¼Ÿ
â”œâ”€ 2PC/3PC: å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®
â””â”€ Saga/TCC: æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½å¥½

ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡åè®®?
â”œâ”€ æ— åè®®: è·¨èŠ‚ç‚¹äº‹åŠ¡æ— æ³•ä¿è¯ACID
â”œâ”€ å•æœºäº‹åŠ¡: æ— æ³•æ‰©å±•åˆ°åˆ†å¸ƒå¼
â””â”€ åˆ†å¸ƒå¼åè®®: ä¿è¯è·¨èŠ‚ç‚¹äº‹åŠ¡æ­£ç¡®æ€§
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
åˆ†å¸ƒå¼äº‹åŠ¡åè®®æ¼”è¿›:
â”œâ”€ 2PCæ—¶ä»£ (1970s-1980s)
â”‚   â”œâ”€ æ–¹æ¡ˆ: ä¸¤é˜¶æ®µæäº¤
â”‚   â”œâ”€ ä¼˜åŠ¿: å¼ºä¸€è‡´æ€§
â”‚   â””â”€ é—®é¢˜: åè°ƒå™¨å•ç‚¹æ•…éšœï¼Œé˜»å¡
â”‚
â”œâ”€ 3PCæ—¶ä»£ (1980s-1990s)
â”‚   â”œâ”€ æ–¹æ¡ˆ: ä¸‰é˜¶æ®µæäº¤
â”‚   â”œâ”€ ä¼˜åŠ¿: æ”¹è¿›2PCé˜»å¡é—®é¢˜
â”‚   â””â”€ é—®é¢˜: ä»ç„¶å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜
â”‚
â””â”€ æœ€ç»ˆä¸€è‡´æ€§æ—¶ä»£ (2000s+)
    â”œâ”€ Saga: è¡¥å¿æ¨¡å¼
    â”œâ”€ TCC: Try-Confirm-Cancel
    â””â”€ åº”ç”¨: å¾®æœåŠ¡æ¶æ„
```

**ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡åè®®é‡è¦ï¼Ÿ**

1. **ç³»ç»Ÿæ­£ç¡®æ€§**: ä¿è¯è·¨èŠ‚ç‚¹äº‹åŠ¡çš„ACIDç‰¹æ€§
2. **æ€§èƒ½æƒè¡¡**: åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´å¹³è¡¡
3. **å®é™…åº”ç”¨**: å¾®æœåŠ¡ã€åˆ†å¸ƒå¼æ•°æ®åº“çš„æ ¸å¿ƒæœºåˆ¶
4. **æŒ‡å¯¼è®¾è®¡**: ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æä¾›å®è·µæŒ‡å¯¼

**åä¾‹: æ— åˆ†å¸ƒå¼äº‹åŠ¡åè®®çš„ç³»ç»Ÿé—®é¢˜**:

```text
é”™è¯¯è®¾è®¡: æ— åˆ†å¸ƒå¼äº‹åŠ¡åè®®çš„å¾®æœåŠ¡ç³»ç»Ÿ
â”œâ”€ åœºæ™¯: è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡
â”œâ”€ é—®é¢˜: æ— äº‹åŠ¡ä¿è¯
â”œâ”€ ç»“æœ: å¯èƒ½æ‰£æ¬¾ä½†æœªæ‰£åº“å­˜ï¼Œæˆ–åä¹‹
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ï¼Œä¸šåŠ¡é”™è¯¯ âœ—

æ­£ç¡®è®¾è®¡: ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡åè®®
â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨Sagaæˆ–TCCæ¨¡å¼
â”œâ”€ ç»“æœ: ä¿è¯æœ€ç»ˆä¸€è‡´æ€§æˆ–å¼ºä¸€è‡´æ€§
â””â”€ æ­£ç¡®æ€§: ç³»ç»Ÿåœ¨æ‰€æœ‰æƒ…å†µä¸‹æ­£ç¡® âœ“
```

### 0.2 å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§

**å†å²èƒŒæ™¯**:

2PC/3PCæä¾›å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ï¼Œå­˜åœ¨é˜»å¡é—®é¢˜ã€‚Saga/TCCæä¾›æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½å¥½ï¼Œä½†éœ€è¦è¡¥å¿æœºåˆ¶ã€‚é€‰æ‹©å“ªç§æ¨¡å¼å–å†³äºä¸šåŠ¡éœ€æ±‚ã€‚

**ç†è®ºåŸºç¡€**:

```text
ä¸€è‡´æ€§æ¨¡å¼:
â”œâ”€ å¼ºä¸€è‡´æ€§: 2PC/3PCï¼Œæ€§èƒ½å·®ï¼Œé˜»å¡
â”œâ”€ æœ€ç»ˆä¸€è‡´æ€§: Saga/TCCï¼Œæ€§èƒ½å¥½ï¼Œéœ€è¦è¡¥å¿
â””â”€ é€‰æ‹©: æ ¹æ®ä¸šåŠ¡éœ€æ±‚

ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§æ¨¡å¼?
â”œâ”€ é‡‘èç³»ç»Ÿ: å¼ºä¸€è‡´æ€§ï¼ˆ2PC/TCCï¼‰
â”œâ”€ ç”µå•†ç³»ç»Ÿ: æœ€ç»ˆä¸€è‡´æ€§ï¼ˆSagaï¼‰
â””â”€ æ··åˆç³»ç»Ÿ: æŒ‰ä¸šåŠ¡é€‰æ‹©
```

---

## äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°

### 1.1 ACIDæŒ‘æˆ˜

**å•æœºäº‹åŠ¡**: ä¾èµ–æœ¬åœ°æ—¥å¿—å’Œé”

$$ACID_{local} = \text{Easy to guarantee}$$

**åˆ†å¸ƒå¼äº‹åŠ¡**: è·¨èŠ‚ç‚¹åè°ƒ

$$ACID_{distributed} = \text{Network failures + Node crashes}$$

### 1.2 æ ¸å¿ƒé—®é¢˜

**é—®é¢˜1**: åŸå­æ€§è·¨èŠ‚ç‚¹

å¦‚ä½•ä¿è¯å¤šä¸ªèŠ‚ç‚¹è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Ÿ

**é—®é¢˜2**: ä¸€è‡´æ€§è·¨èŠ‚ç‚¹

å¦‚ä½•åœ¨ç½‘ç»œåˆ†åŒºæ—¶ä¿æŒæ•°æ®ä¸€è‡´ï¼Ÿ

**é—®é¢˜3**: æ€§èƒ½æƒè¡¡

åè°ƒå¼€é”€ vs ä¸€è‡´æ€§ä¿è¯

---

## äºŒã€ä¸¤é˜¶æ®µæäº¤(2PC)

### 2.1 åè®®æµç¨‹

**Phase 1: Prepare (å‡†å¤‡é˜¶æ®µ)**:

```text
Coordinator                 Participant
    |                            |
    |------- PREPARE ----------->|
    |                            | (1) æ‰§è¡Œäº‹åŠ¡æ“ä½œ
    |                            | (2) å†™undo/redoæ—¥å¿—
    |                            | (3) æŒä¹…åŒ–
    |<------- YES/NO ------------|
```

**Phase 2: Commit (æäº¤é˜¶æ®µ)**:

```text
Coordinator                 Participant
    |                            |
    |------- COMMIT ------------>|
    |                            | (1) æäº¤äº‹åŠ¡
    |                            | (2) é‡Šæ”¾èµ„æº
    |<------- ACK ---------------|
```

### 2.2 ä¼ªä»£ç å®ç°

**Coordinatoré€»è¾‘**:

```python
class TwoPhaseCoordinator:
    def __init__(self, participants):
        self.participants = participants
        self.state = 'INIT'

    def execute_transaction(self, operations):
        # Phase 1: Prepare
        votes = []
        for p in self.participants:
            vote = p.prepare(operations)
            votes.append(vote)

        # å†³ç­–
        if all(v == 'YES' for v in votes):
            decision = 'COMMIT'
        else:
            decision = 'ABORT'

        # æŒä¹…åŒ–å†³ç­–
        self.log_decision(decision)

        # Phase 2: Commit/Abort
        for p in self.participants:
            if decision == 'COMMIT':
                p.commit()
            else:
                p.abort()

        return decision
```

**Participanté€»è¾‘**:

```python
class TwoPhaseParticipant:
    def prepare(self, operations):
        try:
            # æ‰§è¡Œæ“ä½œ
            self.execute_local(operations)

            # å†™æ—¥å¿—ï¼ˆæŒä¹…åŒ–ï¼‰
            self.write_log('PREPARED')

            # åŠ é”ï¼ˆæŒæœ‰èµ„æºç›´åˆ°commit/abortï¼‰
            self.lock_resources()

            return 'YES'
        except Exception as e:
            self.write_log('ABORT')
            return 'NO'

    def commit(self):
        # æäº¤æœ¬åœ°äº‹åŠ¡
        self.local_commit()

        # å†™æ—¥å¿—
        self.write_log('COMMITTED')

        # é‡Šæ”¾é”
        self.release_locks()

    def abort(self):
        # å›æ»š
        self.local_rollback()
        self.write_log('ABORTED')
        self.release_locks()
```

### 2.3 æ•…éšœå¤„ç†

**Case 1: Coordinatoræ•…éšœï¼ˆPrepareåï¼‰**:

```text
ParticipantçŠ¶æ€: PREPARED (æŒæœ‰é”)
æ¢å¤ç­–ç•¥:
  - ç­‰å¾…Coordinatoræ¢å¤
  - æˆ–è¿è¡Œæ¢å¤åè®®ï¼ˆè¯¢é—®å…¶ä»–å‚ä¸è€…ï¼‰
```

**é—®é¢˜**: **é˜»å¡é—®é¢˜** - å‚ä¸è€…æ— é™æœŸç­‰å¾…

**Case 2: Participantæ•…éšœï¼ˆPrepareå‰ï¼‰**:

```text
Coordinator: è¶…æ—¶åä¸­æ­¢äº‹åŠ¡
```

**Case 3: ç½‘ç»œåˆ†åŒº**:

```text
Coordinatorä¸éƒ¨åˆ†Participantå¤±è”
â†’ Coordinatorä¸­æ­¢äº‹åŠ¡
â†’ Partition healingåå›æ»š
```

### 2.4 æ€§èƒ½åˆ†æ

**å»¶è¿Ÿ**:

$$Latency_{2PC} = 2 \times RTT + 2 \times DiskSync$$

**ååé‡**:

$$TPS_{2PC} = \frac{1}{Latency_{2PC} + LockHoldTime}$$

**å…¸å‹å€¼** (3èŠ‚ç‚¹ï¼ŒRTT=1ms):

$$Latency \approx 2 \times 1ms + 2 \times 5ms = 12ms$$

$$TPS \approx 83 \text{ transactions/sec (å•åè°ƒå™¨)}$$

---

## ä¸‰ã€ä¸‰é˜¶æ®µæäº¤(3PC)

### 3.1 æ”¹è¿›åŠ¨æœº

**2PCé—®é¢˜**: Coordinatoræ•…éšœå¯¼è‡´å‚ä¸è€…é˜»å¡

**3PCæ”¹è¿›**: å¼•å…¥è¶…æ—¶æœºåˆ¶ï¼Œå‡å°‘é˜»å¡

### 3.2 åè®®æµç¨‹

**Phase 1: CanCommit**:

```text
Coordinator â†’ Participants: "Can you commit?"
Participants â†’ Coordinator: YES/NO
```

**Phase 2: PreCommit**:

```text
Coordinator â†’ Participants: "Prepare to commit"
Participants: æ‰§è¡Œæ“ä½œï¼Œå†™æ—¥å¿—ï¼Œä½†ä¸æäº¤
```

**Phase 3: DoCommit**:

```text
Coordinator â†’ Participants: "Commit now"
Participants: æäº¤å¹¶é‡Šæ”¾èµ„æº
```

### 3.3 è¶…æ—¶å¤„ç†

**å‚ä¸è€…è¶…æ—¶é€»è¾‘**:

```python
class ThreePhaseParticipant:
    def wait_for_precommit(self, timeout=10):
        msg = self.wait_message(timeout)

        if msg == 'PRECOMMIT':
            self.precommit()
            return self.wait_for_docommit(timeout)
        elif msg == 'ABORT':
            self.abort()
        else:
            # è¶…æ—¶ â†’ ä¸»åŠ¨ä¸­æ­¢
            self.abort()

    def wait_for_docommit(self, timeout=10):
        msg = self.wait_message(timeout)

        if msg == 'DOCOMMIT':
            self.commit()
        elif msg == 'ABORT':
            self.abort()
        else:
            # è¶…æ—¶ â†’ å‡è®¾å¯ä»¥æäº¤ï¼ˆå±é™©ï¼ï¼‰
            self.commit()
```

### 3.4 3PCçš„é—®é¢˜

**ç½‘ç»œåˆ†åŒºåœºæ™¯**:

```text
Partition 1: Coordinator + P1 (æ”¶åˆ°PRECOMMIT)
Partition 2: P2, P3 (è¶…æ—¶ï¼Œå†³å®šCOMMIT)

â†’ ä¸ä¸€è‡´ï¼
```

**ç»“è®º**: 3PCåœ¨åˆ†åŒºæ—¶ä»ä¸å®‰å…¨

---

## å››ã€Sagaæ¨¡å¼

### 4.1 æ ¸å¿ƒæ€æƒ³

**Saga**: é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ + è¡¥å¿æ“ä½œ

$$Saga = T_1 \to T_2 \to ... \to T_n$$

**è¡¥å¿**: æ¯ä¸ª$T_i$æœ‰å¯¹åº”çš„$C_i$ï¼ˆé€†æ“ä½œï¼‰

### 4.2 ç¤ºä¾‹ï¼šè®¢å•å¤„ç†

```python
class OrderSaga:
    def execute(self):
        try:
            # T1: åˆ›å»ºè®¢å•
            order_id = self.create_order()

            # T2: æ‰£å‡åº“å­˜
            self.reduce_inventory(order_id)

            # T3: æ‰£æ¬¾
            self.charge_payment(order_id)

            # T4: å‘è´§
            self.ship_order(order_id)

        except Exception as e:
            # è¡¥å¿ï¼ˆåå‘æ‰§è¡Œï¼‰
            self.compensate(e.step)

    def compensate(self, failed_step):
        if failed_step >= 4:
            self.cancel_shipping()
        if failed_step >= 3:
            self.refund_payment()
        if failed_step >= 2:
            self.restore_inventory()
        if failed_step >= 1:
            self.cancel_order()
```

### 4.3 Saga vs 2PC

| ç»´åº¦ | 2PC | Saga |
|-----|-----|------|
| **åŸå­æ€§** | å¼ºï¼ˆå…¨å±€é”ï¼‰ | å¼±ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰ |
| **é”æŒæœ‰** | é•¿ï¼ˆé˜»å¡ï¼‰ | çŸ­ï¼ˆç«‹å³æäº¤ï¼‰ |
| **æ€§èƒ½** | ä½ | é«˜ |
| **å¤æ‚åº¦** | åè®®å¤æ‚ | è¡¥å¿é€»è¾‘å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | çŸ­äº‹åŠ¡ | é•¿äº‹åŠ¡ |

---

## äº”ã€TCCæ¨¡å¼

### 5.1 ä¸‰é˜¶æ®µ

**Try**: é¢„ç•™èµ„æº

```sql
-- é¢„ç•™è´¦æˆ·ä½™é¢
UPDATE accounts
SET reserved = reserved + 100
WHERE id = 123;
```

**Confirm**: ç¡®è®¤æäº¤

```sql
-- æ‰£å‡é¢„ç•™é‡‘é¢
UPDATE accounts
SET balance = balance - 100,
    reserved = reserved - 100
WHERE id = 123;
```

**Cancel**: å–æ¶ˆå›æ»š

```sql
-- é‡Šæ”¾é¢„ç•™
UPDATE accounts
SET reserved = reserved - 100
WHERE id = 123;
```

### 5.2 å®ç°ç¤ºä¾‹

```python
class TCCTransaction:
    def __init__(self):
        self.participants = []

    def try_phase(self):
        """é¢„ç•™èµ„æº"""
        for p in self.participants:
            if not p.try_reserve():
                return False
        return True

    def confirm_phase(self):
        """ç¡®è®¤æäº¤"""
        for p in self.participants:
            p.confirm()

    def cancel_phase(self):
        """å–æ¶ˆå›æ»š"""
        for p in self.participants:
            p.cancel()
```

### 5.3 TCC vs Saga

| ç»´åº¦ | TCC | Saga |
|-----|-----|------|
| **èµ„æºé¢„ç•™** | æ˜¯ï¼ˆTryé˜¶æ®µï¼‰ | å¦ |
| **ä¸€è‡´æ€§** | å¼º | æœ€ç»ˆä¸€è‡´ |
| **å®ç°å¤æ‚åº¦** | é«˜ï¼ˆéœ€ä¸‰ä¸ªæ¥å£ï¼‰ | ä¸­ï¼ˆéœ€è¡¥å¿æ¥å£ï¼‰ |
| **æ€§èƒ½** | ä¸­ | é«˜ |

---

## å…­ã€åè®®å¯¹æ¯”

### 6.1 ç»¼åˆå¯¹æ¯”çŸ©é˜µ

| åè®® | ä¸€è‡´æ€§ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é˜»å¡ |
|-----|-------|--------|------|--------|------|
| **2PC** | å¼º | ä½ | ä½ | ä¸­ | æ˜¯ |
| **3PC** | å¼º | ä¸­ | ä½ | é«˜ | éƒ¨åˆ† |
| **Saga** | æœ€ç»ˆ | é«˜ | é«˜ | ä¸­ | å¦ |
| **TCC** | å¼º | é«˜ | ä¸­ | é«˜ | å¦ |

### 6.2 é€‰æ‹©å†³ç­–æ ‘

```text
éœ€è¦å¼ºä¸€è‡´æ€§ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ çŸ­äº‹åŠ¡ï¼Ÿ
    â”‚       â”œâ”€ æ˜¯ â†’ 2PC
    â”‚       â””â”€ å¦ â†’ TCC
    â””â”€ å¦ â†’ é•¿äº‹åŠ¡ï¼Ÿ
            â”œâ”€ æ˜¯ â†’ Saga
            â””â”€ å¦ â†’ æœ€ç»ˆä¸€è‡´æ€§
```

### 6.3 å»¶è¿Ÿå¯¹æ¯”

| åè®® | é˜¶æ®µæ•° | åŒæ­¥ç‚¹ | å…¸å‹å»¶è¿Ÿ |
|-----|-------|--------|---------|
| 2PC | 2 | 2 | 10-20ms |
| 3PC | 3 | 3 | 15-30ms |
| Saga | N | N | 50-500ms |
| TCC | 2 | 2 | 15-25ms |

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒæ´å¯Ÿ

**2PC**:

- âœ… ä¿è¯åŸå­æ€§
- âŒ é˜»å¡é—®é¢˜
- é€‚ç”¨: çŸ­äº‹åŠ¡ï¼Œå¼ºä¸€è‡´æ€§

**Saga**:

- âœ… é«˜æ€§èƒ½
- âŒ æœ€ç»ˆä¸€è‡´æ€§
- é€‚ç”¨: é•¿äº‹åŠ¡ï¼Œå¾®æœåŠ¡

**TCC**:

- âœ… å¼ºä¸€è‡´æ€§ + é«˜å¯ç”¨
- âŒ å®ç°å¤æ‚
- é€‚ç”¨: é‡‘èåœºæ™¯

### 7.2 å®è·µå»ºè®®

1. **ä¼˜å…ˆæœ¬åœ°äº‹åŠ¡**: é¿å…åˆ†å¸ƒå¼äº‹åŠ¡
2. **çŸ­äº‹åŠ¡ç”¨2PC**: ç®€å•å¯é 
3. **é•¿äº‹åŠ¡ç”¨Saga**: æ€§èƒ½ä¼˜å…ˆ
4. **é‡‘èåœºæ™¯ç”¨TCC**: ä¸€è‡´æ€§ä¼˜å…ˆ

---

## å…«ã€å®Œæ•´å®ç°ä»£ç 

### 8.1 2PCåè°ƒå™¨å®Œæ•´å®ç°

```rust
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use tokio::time::{Duration, timeout};

#[derive(Debug, Clone)]
enum TransactionState {
    Initial,
    Prepared,
    Committed,
    Aborted,
}

struct Participant {
    id: String,
    endpoint: String,
    state: Arc<Mutex<TransactionState>>,
}

pub struct TwoPhaseCoordinator {
    participants: Vec<Participant>,
    decision: Arc<Mutex<Option<bool>>>,  // None/Some(true)=commit/Some(false)=abort
    timeout: Duration,
}

impl TwoPhaseCoordinator {
    pub fn new(participants: Vec<Participant>) -> Self {
        Self {
            participants,
            decision: Arc::new(Mutex::new(None)),
            timeout: Duration::from_secs(30),
        }
    }

    pub async fn execute_transaction(&self, operations: Vec<Operation>) -> Result<bool, String> {
        // Phase 1: Prepare
        let mut votes = Vec::new();

        for participant in &self.participants {
            let vote = match timeout(
                self.timeout,
                self.send_prepare(participant, &operations)
            ).await {
                Ok(Ok(vote)) => vote,
                Ok(Err(e)) => {
                    // Prepareå¤±è´¥ï¼Œä¸­æ­¢äº‹åŠ¡
                    self.abort_all().await;
                    return Err(format!("Participant {} prepare failed: {}", participant.id, e));
                }
                Err(_) => {
                    // è¶…æ—¶ï¼Œä¸­æ­¢äº‹åŠ¡
                    self.abort_all().await;
                    return Err(format!("Participant {} timeout", participant.id));
                }
            };

            votes.push(vote);
        }

        // å†³ç­–ï¼šæ‰€æœ‰å‚ä¸è€…éƒ½æŠ•ç¥¨YESæ‰èƒ½æäº¤
        let decision = votes.iter().all(|v| *v);

        // æŒä¹…åŒ–å†³ç­–
        self.log_decision(decision).await?;

        // Phase 2: Commit/Abort
        if decision {
            self.commit_all().await?;
        } else {
            self.abort_all().await?;
        }

        Ok(decision)
    }

    async fn send_prepare(&self, participant: &Participant, operations: &[Operation]) -> Result<bool, String> {
        // å‘é€PREPAREè¯·æ±‚
        let response = self.http_post(
            &format!("{}/prepare", participant.endpoint),
            operations
        ).await?;

        if response.status == "YES" {
            *participant.state.lock().unwrap() = TransactionState::Prepared;
            Ok(true)
        } else {
            Ok(false)
        }
    }

    async fn commit_all(&self) -> Result<(), String> {
        *self.decision.lock().unwrap() = Some(true);

        for participant in &self.participants {
            self.http_post(
                &format!("{}/commit", participant.endpoint),
                &()
            ).await?;

            *participant.state.lock().unwrap() = TransactionState::Committed;
        }

        Ok(())
    }

    async fn abort_all(&self) -> Result<(), String> {
        *self.decision.lock().unwrap() = Some(false);

        for participant in &self.participants {
            // å¿½ç•¥é”™è¯¯ï¼ˆå¯èƒ½å·²ç»å¤±è´¥ï¼‰
            let _ = self.http_post(
                &format!("{}/abort", participant.endpoint),
                &()
            ).await;

            *participant.state.lock().unwrap() = TransactionState::Aborted;
        }

        Ok(())
    }

    async fn log_decision(&self, decision: bool) -> Result<(), String> {
        // æŒä¹…åŒ–å†³ç­–åˆ°WAL
        // å®ç°ç»†èŠ‚...
        Ok(())
    }
}
```

### 8.2 Sagaåè°ƒå™¨å®ç°

```python
from dataclasses import dataclass
from typing import List, Callable, Optional
from enum import Enum

class SagaStepStatus(Enum):
    PENDING = "pending"
    COMPLETED = "completed"
    FAILED = "failed"
    COMPENSATED = "compensated"

@dataclass
class SagaStep:
    name: str
    execute: Callable
    compensate: Callable
    status: SagaStepStatus = SagaStepStatus.PENDING

class SagaCoordinator:
    def __init__(self):
        self.steps: List[SagaStep] = []
        self.executed_steps: List[SagaStep] = []

    def add_step(self, step: SagaStep):
        self.steps.append(step)

    def execute(self) -> bool:
        """æ‰§è¡ŒSagaäº‹åŠ¡"""
        try:
            for step in self.steps:
                # æ‰§è¡Œæ­¥éª¤
                result = step.execute()
                step.status = SagaStepStatus.COMPLETED
                self.executed_steps.append(step)

                if not result:
                    # æ­¥éª¤å¤±è´¥ï¼Œå¼€å§‹è¡¥å¿
                    self.compensate(step)
                    return False

            return True

        except Exception as e:
            # å¼‚å¸¸ï¼Œè¡¥å¿æ‰€æœ‰å·²æ‰§è¡Œæ­¥éª¤
            self.compensate_all()
            return False

    def compensate(self, failed_step: SagaStep):
        """è¡¥å¿å•ä¸ªæ­¥éª¤"""
        # åå‘æ‰§è¡Œå·²å®Œæˆçš„æ­¥éª¤
        for step in reversed(self.executed_steps):
            try:
                step.compensate()
                step.status = SagaStepStatus.COMPENSATED
            except Exception as e:
                # è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
                print(f"Compensation failed for {step.name}: {e}")

    def compensate_all(self):
        """è¡¥å¿æ‰€æœ‰æ­¥éª¤"""
        self.compensate(self.steps[-1] if self.steps else None)

# ä½¿ç”¨ç¤ºä¾‹
def create_order_saga():
    saga = SagaCoordinator()

    # Step 1: åˆ›å»ºè®¢å•
    saga.add_step(SagaStep(
        name="create_order",
        execute=lambda: create_order(),
        compensate=lambda: cancel_order()
    ))

    # Step 2: æ‰£å‡åº“å­˜
    saga.add_step(SagaStep(
        name="reduce_inventory",
        execute=lambda: reduce_inventory(),
        compensate=lambda: restore_inventory()
    ))

    # Step 3: æ‰£æ¬¾
    saga.add_step(SagaStep(
        name="charge_payment",
        execute=lambda: charge_payment(),
        compensate=lambda: refund_payment()
    ))

    return saga
```

### 8.3 TCCå®Œæ•´å®ç°

```rust
use async_trait::async_trait;

#[async_trait]
trait TCCParticipant {
    async fn try_reserve(&self, amount: u64) -> Result<(), String>;
    async fn confirm(&self, amount: u64) -> Result<(), String>;
    async fn cancel(&self, amount: u64) -> Result<(), String>;
}

struct AccountService {
    account_id: String,
    db: Arc<dyn Database>,
}

#[async_trait]
impl TCCParticipant for AccountService {
    async fn try_reserve(&self, amount: u64) -> Result<(), String> {
        // Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
        self.db.execute(
            "UPDATE accounts SET reserved = reserved + ? WHERE id = ? AND balance >= ?",
            &[amount, &self.account_id, amount]
        ).await?;

        Ok(())
    }

    async fn confirm(&self, amount: u64) -> Result<(), String> {
        // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£æ¬¾
        self.db.execute(
            "UPDATE accounts SET balance = balance - ?, reserved = reserved - ? WHERE id = ?",
            &[amount, amount, &self.account_id]
        ).await?;

        Ok(())
    }

    async fn cancel(&self, amount: u64) -> Result<(), String> {
        // Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„ç•™
        self.db.execute(
            "UPDATE accounts SET reserved = reserved - ? WHERE id = ?",
            &[amount, &self.account_id]
        ).await?;

        Ok(())
    }
}

pub struct TCCTransaction {
    participants: Vec<Arc<dyn TCCParticipant>>,
}

impl TCCTransaction {
    pub async fn execute(&self, operations: Vec<(Arc<dyn TCCParticipant>, u64)>) -> Result<(), String> {
        // Phase 1: Tryï¼ˆé¢„ç•™èµ„æºï¼‰
        let mut reserved = Vec::new();

        for (participant, amount) in &operations {
            match participant.try_reserve(*amount).await {
                Ok(_) => reserved.push((participant.clone(), *amount)),
                Err(e) => {
                    // Tryå¤±è´¥ï¼Œå–æ¶ˆæ‰€æœ‰é¢„ç•™
                    self.cancel_all(&reserved).await;
                    return Err(e);
                }
            }
        }

        // Phase 2: Confirmï¼ˆç¡®è®¤æäº¤ï¼‰
        for (participant, amount) in &reserved {
            if let Err(e) = participant.confirm(*amount).await {
                // Confirmå¤±è´¥ï¼Œå°è¯•è¡¥å¿
                self.cancel_all(&reserved).await;
                return Err(e);
            }
        }

        Ok(())
    }

    async fn cancel_all(&self, reserved: &[(Arc<dyn TCCParticipant>, u64)]) {
        for (participant, amount) in reserved.iter().rev() {
            let _ = participant.cancel(*amount).await;
        }
    }
}
```

---

## ä¹ã€å®é™…ç”Ÿäº§æ¡ˆä¾‹

### æ¡ˆä¾‹1: å¾®æœåŠ¡è®¢å•ç³»ç»Ÿï¼ˆSagaæ¨¡å¼ï¼‰

**æ¶æ„**:

```text
è®¢å•æœåŠ¡ (Order Service)
    â”œâ”€ åˆ›å»ºè®¢å•
    â”œâ”€ è°ƒç”¨åº“å­˜æœåŠ¡ (Inventory Service)
    â”œâ”€ è°ƒç”¨æ”¯ä»˜æœåŠ¡ (Payment Service)
    â””â”€ è°ƒç”¨ç‰©æµæœåŠ¡ (Shipping Service)
```

**Sagaå®ç°**:

```python
class OrderSaga:
    def __init__(self):
        self.inventory_client = InventoryClient()
        self.payment_client = PaymentClient()
        self.shipping_client = ShippingClient()

    def execute(self, order_data):
        saga = SagaCoordinator()

        # Step 1: åˆ›å»ºè®¢å•
        saga.add_step(SagaStep(
            name="create_order",
            execute=lambda: self.create_order(order_data),
            compensate=lambda: self.cancel_order(order_data['order_id'])
        ))

        # Step 2: æ‰£å‡åº“å­˜
        saga.add_step(SagaStep(
            name="reduce_inventory",
            execute=lambda: self.inventory_client.reduce(order_data['items']),
            compensate=lambda: self.inventory_client.restore(order_data['items'])
        ))

        # Step 3: æ‰£æ¬¾
        saga.add_step(SagaStep(
            name="charge_payment",
            execute=lambda: self.payment_client.charge(order_data['amount']),
            compensate=lambda: self.payment_client.refund(order_data['amount'])
        ))

        # Step 4: å‘è´§
        saga.add_step(SagaStep(
            name="ship_order",
            execute=lambda: self.shipping_client.ship(order_data['order_id']),
            compensate=lambda: self.shipping_client.cancel(order_data['order_id'])
        ))

        return saga.execute()
```

**æ€§èƒ½æ•°æ®**:

| æŒ‡æ ‡ | 2PC | Saga |
|-----|-----|------|
| å¹³å‡å»¶è¿Ÿ | 150ms | 80ms |
| ååé‡ | 500 TPS | 2000 TPS |
| å¯ç”¨æ€§ | 99.5% | 99.9% |

### æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿï¼ˆTCCæ¨¡å¼ï¼‰

**åœºæ™¯**: è·¨è¡Œè½¬è´¦ï¼Œéœ€è¦å¼ºä¸€è‡´æ€§

**TCCå®ç°**:

```rust
// è½¬è´¦Saga
struct TransferTCC {
    from_account: Arc<AccountService>,
    to_account: Arc<AccountService>,
    amount: u64,
}

impl TransferTCC {
    async fn execute(&self) -> Result<(), String> {
        let tcc = TCCTransaction::new();

        // Try: ä»è´¦æˆ·é¢„ç•™ï¼Œå‘è´¦æˆ·é¢„ç•™ï¼ˆæ¥æ”¶ï¼‰
        tcc.add_participant(self.from_account.clone(), self.amount);
        tcc.add_participant(self.to_account.clone(), self.amount);

        // æ‰§è¡ŒTCC
        tcc.execute().await?;

        Ok(())
    }
}
```

**æ•ˆæœ**: å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œè½¬è´¦æˆåŠŸç‡99.99%

---

## åã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: 2PCåè°ƒå™¨å•ç‚¹æ•…éšœ

**é”™è¯¯è®¾è®¡**:

```rust
// é”™è¯¯: åè°ƒå™¨æ— é«˜å¯ç”¨
struct Coordinator {
    // å•ç‚¹æ•…éšœ
}
```

**é—®é¢˜**: åè°ƒå™¨æ•…éšœå¯¼è‡´æ‰€æœ‰å‚ä¸è€…é˜»å¡

**æ­£ç¡®è®¾è®¡**:

```rust
// æ­£ç¡®: åè°ƒå™¨é«˜å¯ç”¨ï¼ˆRaftå…±è¯†ï¼‰
struct HighAvailabilityCoordinator {
    raft_cluster: RaftCluster,  // å¤šå‰¯æœ¬
    decision_log: WAL,  // æŒä¹…åŒ–å†³ç­–
}

impl HighAvailabilityCoordinator {
    async fn execute_transaction(&self, ops: Vec<Operation>) -> Result<bool, String> {
        // é€šè¿‡Raftå…±è¯†å†³ç­–
        let decision = self.raft_cluster.propose(ops).await?;
        // ...
    }
}
```

### åä¾‹2: Sagaè¡¥å¿ä¸å¹‚ç­‰

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: è¡¥å¿æ“ä½œä¸å¹‚ç­‰
def refund_payment(order_id):
    # å¦‚æœå¤šæ¬¡è°ƒç”¨ï¼Œä¼šé‡å¤é€€æ¬¾ï¼
    amount = get_order_amount(order_id)
    account.balance += amount
```

**é—®é¢˜**: é‡å¤è¡¥å¿å¯¼è‡´æ•°æ®é”™è¯¯

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: è¡¥å¿æ“ä½œå¹‚ç­‰
def refund_payment(order_id):
    # æ£€æŸ¥æ˜¯å¦å·²é€€æ¬¾
    if is_refunded(order_id):
        return  # å·²é€€æ¬¾ï¼Œç›´æ¥è¿”å›

    amount = get_order_amount(order_id)
    account.balance += amount
    mark_as_refunded(order_id)  # æ ‡è®°å·²é€€æ¬¾
```

### åä¾‹3: 2PCè¶…æ—¶å¤„ç†ä¸å½“

**é”™è¯¯è®¾è®¡**: 2PCè¶…æ—¶å¤„ç†ä¸å®Œæ•´

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: 2PCåˆ†å¸ƒå¼äº‹åŠ¡
â”œâ”€ é—®é¢˜: åè°ƒå™¨åœ¨Prepareé˜¶æ®µåæ•…éšœ
â”œâ”€ ç»“æœ: å‚ä¸è€…è¶…æ—¶åæ— æ³•å†³å®šæäº¤æˆ–å›æ»š
â””â”€ åæœ: å‚ä¸è€…é˜»å¡ï¼Œèµ„æºé”å®š âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸåˆ†å¸ƒå¼æ•°æ®åº“
â”œâ”€ é—®é¢˜: åè°ƒå™¨æ•…éšœï¼Œå‚ä¸è€…è¶…æ—¶
â”œâ”€ ç»“æœ: å‚ä¸è€…æ— æ³•å†³å®šï¼Œèµ„æºé”å®š
â””â”€ åæœ: ç³»ç»Ÿé˜»å¡ï¼Œæ— æ³•ç»§ç»­ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: 3PCæˆ–è¶…æ—¶åå›æ»š
â”œâ”€ å®ç°: å‚ä¸è€…è¶…æ—¶åè‡ªåŠ¨å›æ»š
â””â”€ ç»“æœ: é¿å…é˜»å¡ï¼Œç³»ç»Ÿå¯ç”¨ âœ“
```

### åä¾‹4: TCC Confirmé˜¶æ®µå¤±è´¥æœªå¤„ç†

**é”™è¯¯è®¾è®¡**: TCC Confirmé˜¶æ®µå¤±è´¥æœªå¤„ç†

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: TCCåˆ†å¸ƒå¼äº‹åŠ¡
â”œâ”€ é—®é¢˜: Confirmé˜¶æ®µéƒ¨åˆ†å¤±è´¥
â”œâ”€ ç»“æœ: éƒ¨åˆ†èµ„æºå·²ç¡®è®¤ï¼Œéƒ¨åˆ†æœªç¡®è®¤
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸé‡‘èç³»ç»ŸTCCå®ç°
â”œâ”€ é—®é¢˜: Confirmé˜¶æ®µç½‘ç»œæ•…éšœ
â”œâ”€ ç»“æœ: éƒ¨åˆ†è´¦æˆ·å·²æ‰£æ¬¾ï¼Œéƒ¨åˆ†æœªæ‰£æ¬¾
â””â”€ åæœ: èµ„é‡‘ä¸ä¸€è‡´ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: Confirmé˜¶æ®µé‡è¯•æœºåˆ¶
â”œâ”€ å®ç°: å¤±è´¥åé‡è¯•ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´
â””â”€ ç»“æœ: æ•°æ®æœ€ç»ˆä¸€è‡´ âœ“
```

### åä¾‹5: å¿½ç•¥ç½‘ç»œåˆ†åŒºåœºæ™¯

**é”™è¯¯è®¾è®¡**: ä¸å¤„ç†ç½‘ç»œåˆ†åŒº

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: 2PCåˆ†å¸ƒå¼äº‹åŠ¡
â”œâ”€ äº‹ä»¶: ç½‘ç»œåˆ†åŒºï¼ˆåè°ƒå™¨ vs å‚ä¸è€…ï¼‰
â”œâ”€ é—®é¢˜: ä¸æ£€æµ‹ç½‘ç»œåˆ†åŒº
â”œâ”€ ç»“æœ: åè°ƒå™¨å’Œå‚ä¸è€…çŠ¶æ€ä¸ä¸€è‡´
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸåˆ†å¸ƒå¼ç³»ç»Ÿ
â”œâ”€ äº‹ä»¶: è·¨åŒºåŸŸç½‘ç»œæ•…éšœ
â”œâ”€ é—®é¢˜: æœªå¤„ç†ç½‘ç»œåˆ†åŒº
â”œâ”€ ç»“æœ: éƒ¨åˆ†èŠ‚ç‚¹æäº¤ï¼Œéƒ¨åˆ†å›æ»š
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: ç½‘ç»œåˆ†åŒºæ£€æµ‹å’Œå¤„ç†
â”œâ”€ å®ç°: æ£€æµ‹åˆ†åŒºï¼Œé€‰æ‹©ä¸»åˆ†åŒºç»§ç»­
â””â”€ ç»“æœ: ç½‘ç»œåˆ†åŒºæ—¶ä¿è¯ä¸€è‡´æ€§ âœ“
```

### åä¾‹6: åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½é—®é¢˜è¢«å¿½ç•¥

**é”™è¯¯è®¾è®¡**: åˆ†å¸ƒå¼äº‹åŠ¡å®ç°ä¸è€ƒè™‘æ€§èƒ½

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: 2PCåˆ†å¸ƒå¼äº‹åŠ¡
â”œâ”€ é—®é¢˜: æ‰€æœ‰æ“ä½œéƒ½ç”¨2PC
â”œâ”€ ç»“æœ: æ€§èƒ½ä¸‹é™ï¼Œå»¶è¿Ÿå¢åŠ 
â””â”€ æ€§èƒ½: TPSä»10ä¸‡é™åˆ°1ä¸‡ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸå¾®æœåŠ¡ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: æ‰€æœ‰è·¨æœåŠ¡è°ƒç”¨éƒ½ç”¨2PC
â”œâ”€ ç»“æœ: å»¶è¿Ÿä»10mså¢åŠ åˆ°150ms
â””â”€ åæœ: ç”¨æˆ·ä½“éªŒä¸‹é™ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: æŒ‰ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åè®®
â”œâ”€ å®ç°: å¼ºä¸€è‡´ç”¨2PCï¼Œæœ€ç»ˆä¸€è‡´ç”¨Saga
â””â”€ ç»“æœ: æ€§èƒ½ä¼˜åŒ–ï¼ŒTPSä¿æŒ10ä¸‡+ âœ“
```

---

## åä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡å¯è§†åŒ–

### 11.1 2PCåè®®åºåˆ—å›¾

**å®Œæ•´2PCåè®®åºåˆ—** (Mermaid):

```mermaid
sequenceDiagram
    participant C as Coordinator
    participant P1 as Participant1
    participant P2 as Participant2
    participant P3 as Participant3

    Note over C: Phase 1: Prepare

    C->>P1: PREPARE(transaction_id)
    C->>P2: PREPARE(transaction_id)
    C->>P3: PREPARE(transaction_id)

    P1->>P1: æ‰§è¡Œäº‹åŠ¡æ“ä½œ
    P1->>P1: å†™undo/redoæ—¥å¿—
    P1->>P1: æŒä¹…åŒ–
    P1-->>C: YES (å‡†å¤‡æˆåŠŸ)

    P2->>P2: æ‰§è¡Œäº‹åŠ¡æ“ä½œ
    P2->>P2: å†™undo/redoæ—¥å¿—
    P2->>P2: æŒä¹…åŒ–
    P2-->>C: YES (å‡†å¤‡æˆåŠŸ)

    P3->>P3: æ‰§è¡Œäº‹åŠ¡æ“ä½œ
    P3->>P3: å†™undo/redoæ—¥å¿—
    P3-->>C: NO (å‡†å¤‡å¤±è´¥)

    Note over C: æ”¶åˆ°NOï¼Œå†³å®šä¸­æ­¢

    Note over C: Phase 2: Abort

    C->>P1: ABORT(transaction_id)
    C->>P2: ABORT(transaction_id)
    C->>P3: ABORT(transaction_id)

    P1->>P1: å›æ»šäº‹åŠ¡
    P1-->>C: ACK
    P2->>P2: å›æ»šäº‹åŠ¡
    P2-->>C: ACK
    P3->>P3: å›æ»šäº‹åŠ¡
    P3-->>C: ACK
```

**2PCæˆåŠŸæäº¤åºåˆ—**:

```mermaid
sequenceDiagram
    participant C as Coordinator
    participant P1 as Participant1
    participant P2 as Participant2

    Note over C: Phase 1: Prepare

    C->>P1: PREPARE
    C->>P2: PREPARE
    P1-->>C: YES
    P2-->>C: YES

    Note over C: æ”¶åˆ°å…¨éƒ¨YESï¼Œå†³å®šæäº¤

    Note over C: Phase 2: Commit

    C->>C: å†™COMMITå†³ç­–åˆ°WAL
    C->>P1: COMMIT
    C->>P2: COMMIT

    P1->>P1: æäº¤äº‹åŠ¡
    P1-->>C: ACK
    P2->>P2: æäº¤äº‹åŠ¡
    P2-->>C: ACK
```

### 11.2 Sagaæ¨¡å¼æµç¨‹å›¾

**Sagaæ¨¡å¼å®Œæ•´æµç¨‹** (Mermaid):

```mermaid
flowchart TD
    START([å¼€å§‹Sagaäº‹åŠ¡]) --> STEP1[æ­¥éª¤1: åˆ›å»ºè®¢å•]
    STEP1 --> CHECK1{æˆåŠŸ?}

    CHECK1 -->|æ˜¯| STEP2[æ­¥éª¤2: æ‰£å‡åº“å­˜]
    CHECK1 -->|å¦| COMP1[è¡¥å¿1: å–æ¶ˆè®¢å•]

    STEP2 --> CHECK2{æˆåŠŸ?}
    CHECK2 -->|æ˜¯| STEP3[æ­¥éª¤3: æ‰£æ¬¾]
    CHECK2 -->|å¦| COMP2[è¡¥å¿2: æ¢å¤åº“å­˜]
    COMP2 --> COMP1

    STEP3 --> CHECK3{æˆåŠŸ?}
    CHECK3 -->|æ˜¯| STEP4[æ­¥éª¤4: å‘è´§]
    CHECK3 -->|å¦| COMP3[è¡¥å¿3: é€€æ¬¾]
    COMP3 --> COMP2

    STEP4 --> CHECK4{æˆåŠŸ?}
    CHECK4 -->|æ˜¯| SUCCESS([äº‹åŠ¡æˆåŠŸ])
    CHECK4 -->|å¦| COMP4[è¡¥å¿4: å–æ¶ˆå‘è´§]
    COMP4 --> COMP3

    COMP1 --> FAIL([äº‹åŠ¡å¤±è´¥])
```

**Sagaè¡¥å¿æµç¨‹**:

```text
Sagaè¡¥å¿æµç¨‹:
â”œâ”€ æ­¥éª¤1æˆåŠŸ â†’ æ­¥éª¤2å¤±è´¥
â”‚   â””â”€ è¡¥å¿1: å–æ¶ˆè®¢å•
â”‚
â”œâ”€ æ­¥éª¤1-2æˆåŠŸ â†’ æ­¥éª¤3å¤±è´¥
â”‚   â”œâ”€ è¡¥å¿2: æ¢å¤åº“å­˜
â”‚   â””â”€ è¡¥å¿1: å–æ¶ˆè®¢å•
â”‚
â””â”€ æ­¥éª¤1-3æˆåŠŸ â†’ æ­¥éª¤4å¤±è´¥
    â”œâ”€ è¡¥å¿3: é€€æ¬¾
    â”œâ”€ è¡¥å¿2: æ¢å¤åº“å­˜
    â””â”€ è¡¥å¿1: å–æ¶ˆè®¢å•
```

### 11.3 åˆ†å¸ƒå¼äº‹åŠ¡åè®®é€‰æ‹©å†³ç­–æ ‘

**åˆ†å¸ƒå¼äº‹åŠ¡åè®®é€‰æ‹©å†³ç­–æ ‘**:

```text
                é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡åè®®
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ä¸€è‡´æ€§è¦æ±‚åˆ†æ      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
   å¼ºä¸€è‡´æ€§        æœ€ç»ˆä¸€è‡´æ€§      æ— ä¸€è‡´æ€§è¦æ±‚
   (é‡‘è)          (ç”µå•†)          (æ—¥å¿—)
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
    2PC/TCC         Saga           æ— äº‹åŠ¡
      â”‚               â”‚               â”‚
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
  é˜»å¡é£é™©        è¡¥å¿å¤æ‚        ç®€å•å®ç°
  æ€§èƒ½è¾ƒä½        æ€§èƒ½è¾ƒé«˜        æ€§èƒ½æœ€é«˜
```

**2PC vs Saga vs TCCé€‰æ‹©å†³ç­–æ ‘**:

```text
                é€‰æ‹©å…·ä½“åè®®
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ä¸šåŠ¡åœºæ™¯åˆ†æ        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
   çŸ­äº‹åŠ¡          é•¿äº‹åŠ¡          å¤æ‚ä¸šåŠ¡
   (<100ms)        (>1s)          (å¤šæ­¥éª¤)
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
    2PC            Saga            TCC
  (ç®€å•)         (è¡¥å¿)          (é¢„ç•™)
      â”‚               â”‚               â”‚
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
  å¿«é€Ÿæäº¤        çµæ´»è¡¥å¿        å¼ºä¸€è‡´æ€§
  é˜»å¡é£é™©        æœ€ç»ˆä¸€è‡´        èµ„æºé¢„ç•™
```

**åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”çŸ©é˜µ**:

| åè®® | ä¸€è‡´æ€§ | æ€§èƒ½ | é˜»å¡é£é™© | å®ç°å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|-----|-------|------|---------|-----------|---------|
| **2PC** | å¼ºä¸€è‡´ | ä½ (150ms) | é«˜ | ä¸­ | çŸ­äº‹åŠ¡ã€å¼ºä¸€è‡´ |
| **3PC** | å¼ºä¸€è‡´ | ä½ (200ms) | ä¸­ | é«˜ | éé˜»å¡åœºæ™¯ |
| **Saga** | æœ€ç»ˆä¸€è‡´ | é«˜ (80ms) | æ—  | ä¸­ | é•¿äº‹åŠ¡ã€å¾®æœåŠ¡ |
| **TCC** | å¼ºä¸€è‡´ | ä¸­ (100ms) | ä½ | é«˜ | é‡‘èã€é¢„ç•™èµ„æº |
| **Percolator** | å¼ºä¸€è‡´ | ä¸­ (50ms) | ä½ | é«˜ | åˆ†å¸ƒå¼MVCC |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Rust/Pythonå®ç°ã€ç”Ÿäº§æ¡ˆä¾‹ã€åä¾‹åˆ†æã€åˆ†å¸ƒå¼äº‹åŠ¡å¯è§†åŒ–ï¼ˆ2PCåè®®åºåˆ—å›¾ã€Sagaæ¨¡å¼æµç¨‹å›¾ã€åˆ†å¸ƒå¼äº‹åŠ¡åè®®é€‰æ‹©å†³ç­–æ ‘ï¼‰ã€åˆ†å¸ƒå¼äº‹åŠ¡åè®®èƒŒæ™¯ä¸æ¼”è¿›ï¼ˆä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡åè®®ã€å†å²èƒŒæ™¯ã€ç†è®ºåŸºç¡€ã€å¼ºä¸€è‡´æ€§vsæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€åˆ†å¸ƒå¼äº‹åŠ¡åè®®åä¾‹è¡¥å……ï¼ˆ6ä¸ªæ–°å¢åä¾‹ï¼š2PCè¶…æ—¶å¤„ç†ä¸å½“ã€TCC Confirmé˜¶æ®µå¤±è´¥æœªå¤„ç†ã€å¿½ç•¥ç½‘ç»œåˆ†åŒºåœºæ™¯ã€åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½é—®é¢˜è¢«å¿½ç•¥ï¼‰

**å…³è”æ–‡æ¡£**:

- `04-åˆ†å¸ƒå¼æ‰©å±•/01-åˆ†å¸ƒå¼MVCC(Percolator).md`
- `04-åˆ†å¸ƒå¼æ‰©å±•/03-å…±è¯†åè®®(Raft_Paxos).md`
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/04-CAPç†è®ºä¸æƒè¡¡.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md` (Sagaåº”ç”¨)
