# è®¾è®¡æ¨¡å¼åº“ï¼šä»å·¥ä¸šæ¡ˆä¾‹ä¸­æå–çš„å¯å¤ç”¨æ¨¡å¼

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05
> **ç›®æ ‡**: ä»å·¥ä¸šæ¡ˆä¾‹ä¸­æå–å¯å¤ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œæä¾›ç³»ç»ŸåŒ–çš„è®¾è®¡æŒ‡å—
> **é€‚ç”¨èŒƒå›´**: æ‰€æœ‰å¹¶å‘ç³»ç»Ÿå’Œæ•°æ®åº“åº”ç”¨åœºæ™¯
> **ğŸ“– æ¦‚å¿µè¯å…¸å¼•ç”¨**ï¼šæœ¬æ–‡æ¡£ä¸­æ¶‰åŠçš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå®šä¹‰ä¸ [æ ¸å¿ƒæ¦‚å¿µè¯å…¸](../00-ç†è®ºæ¡†æ¶æ€»è§ˆ/01-æ ¸å¿ƒæ¦‚å¿µè¯å…¸.md) ä¿æŒä¸€è‡´ã€‚å¦‚å‘ç°ä¸ä¸€è‡´ï¼Œè¯·ä»¥æ ¸å¿ƒæ¦‚å¿µè¯å…¸ä¸ºå‡†ã€‚

---

## ğŸ“‘ ç›®å½•

- [è®¾è®¡æ¨¡å¼åº“ï¼šä»å·¥ä¸šæ¡ˆä¾‹ä¸­æå–çš„å¯å¤ç”¨æ¨¡å¼](#è®¾è®¡æ¨¡å¼åº“ä»å·¥ä¸šæ¡ˆä¾‹ä¸­æå–çš„å¯å¤ç”¨æ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¨¡å¼åˆ†ç±»ä½“ç³»](#ä¸€æ¨¡å¼åˆ†ç±»ä½“ç³»)
  - [äºŒã€å¹¶å‘æ§åˆ¶æ¨¡å¼](#äºŒå¹¶å‘æ§åˆ¶æ¨¡å¼)
    - [2.1 åˆ†å±‚è¿‡æ»¤æ¨¡å¼ï¼ˆLayered Filteringï¼‰](#21-åˆ†å±‚è¿‡æ»¤æ¨¡å¼layered-filtering)
    - [2.2 å¿«é€Ÿå¤±è´¥æ¨¡å¼ï¼ˆFail Fastï¼‰](#22-å¿«é€Ÿå¤±è´¥æ¨¡å¼fail-fast)
    - [2.3 ä¹è§‚é”é‡è¯•æ¨¡å¼ï¼ˆOptimistic Lock Retryï¼‰](#23-ä¹è§‚é”é‡è¯•æ¨¡å¼optimistic-lock-retry)
    - [2.4 å¹‚ç­‰æ€§æ¨¡å¼ï¼ˆIdempotencyï¼‰](#24-å¹‚ç­‰æ€§æ¨¡å¼idempotency)
  - [ä¸‰ã€ä¸€è‡´æ€§ä¿è¯æ¨¡å¼](#ä¸‰ä¸€è‡´æ€§ä¿è¯æ¨¡å¼)
    - [3.1 æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼ï¼ˆEventual Consistencyï¼‰](#31-æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼eventual-consistency)
    - [3.2 å¼ºä¸€è‡´æ€§æ¨¡å¼ï¼ˆStrong Consistencyï¼‰](#32-å¼ºä¸€è‡´æ€§æ¨¡å¼strong-consistency)
    - [3.3 è¡¥å¿äº‹åŠ¡æ¨¡å¼ï¼ˆCompensating Transactionï¼‰](#33-è¡¥å¿äº‹åŠ¡æ¨¡å¼compensating-transaction)
  - [å››ã€æ€§èƒ½ä¼˜åŒ–æ¨¡å¼](#å››æ€§èƒ½ä¼˜åŒ–æ¨¡å¼)
    - [4.1 ç¼“å­˜é¢„å‡æ¨¡å¼ï¼ˆCache Pre-decrementï¼‰](#41-ç¼“å­˜é¢„å‡æ¨¡å¼cache-pre-decrement)
    - [4.2 æ‰¹é‡å¤„ç†æ¨¡å¼ï¼ˆBatch Processingï¼‰](#42-æ‰¹é‡å¤„ç†æ¨¡å¼batch-processing)
    - [4.3 å¼‚æ­¥åŒ–æ¨¡å¼ï¼ˆAsynchronizationï¼‰](#43-å¼‚æ­¥åŒ–æ¨¡å¼asynchronization)
  - [äº”ã€å®¹é”™ä¸æ¢å¤æ¨¡å¼](#äº”å®¹é”™ä¸æ¢å¤æ¨¡å¼)
    - [5.1 é‡è¯•æ¨¡å¼ï¼ˆRetryï¼‰](#51-é‡è¯•æ¨¡å¼retry)
    - [5.2 å›æ»šæ¨¡å¼ï¼ˆRollbackï¼‰](#52-å›æ»šæ¨¡å¼rollback)
    - [5.3 å®šæ—¶åŒæ­¥æ¨¡å¼ï¼ˆPeriodic Syncï¼‰](#53-å®šæ—¶åŒæ­¥æ¨¡å¼periodic-sync)
  - [å…­ã€ç›‘æ§ä¸å‘Šè­¦æ¨¡å¼](#å…­ç›‘æ§ä¸å‘Šè­¦æ¨¡å¼)
    - [6.1 å®æ—¶ç›‘æ§æ¨¡å¼ï¼ˆReal-time Monitoringï¼‰](#61-å®æ—¶ç›‘æ§æ¨¡å¼real-time-monitoring)
    - [6.2 å‘Šè­¦æ¨¡å¼ï¼ˆAlertingï¼‰](#62-å‘Šè­¦æ¨¡å¼alerting)
  - [ä¸ƒã€æ¨¡å¼é€‰æ‹©å†³ç­–æ ‘](#ä¸ƒæ¨¡å¼é€‰æ‹©å†³ç­–æ ‘)
  - [å…«ã€æ¨¡å¼ç»„åˆä½¿ç”¨](#å…«æ¨¡å¼ç»„åˆä½¿ç”¨)
  - [ä¹ã€æ¨¡å¼æ€§èƒ½å¯¹æ¯”](#ä¹æ¨¡å¼æ€§èƒ½å¯¹æ¯”)
  - [åã€æ¨¡å¼åº”ç”¨æ¡ˆä¾‹](#åæ¨¡å¼åº”ç”¨æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: ç§’æ€ç³»ç»Ÿæ¨¡å¼ç»„åˆ](#æ¡ˆä¾‹1-ç§’æ€ç³»ç»Ÿæ¨¡å¼ç»„åˆ)
    - [æ¡ˆä¾‹2: é‡‘èç³»ç»Ÿæ¨¡å¼ç»„åˆ](#æ¡ˆä¾‹2-é‡‘èç³»ç»Ÿæ¨¡å¼ç»„åˆ)

---

## ä¸€ã€æ¨¡å¼åˆ†ç±»ä½“ç³»

**è®¾è®¡æ¨¡å¼åˆ†ç±»**:

```text
è®¾è®¡æ¨¡å¼åˆ†ç±»ä½“ç³»:
â”œâ”€ å¹¶å‘æ§åˆ¶æ¨¡å¼
â”‚   â”œâ”€ åˆ†å±‚è¿‡æ»¤æ¨¡å¼
â”‚   â”œâ”€ å¿«é€Ÿå¤±è´¥æ¨¡å¼
â”‚   â”œâ”€ ä¹è§‚é”é‡è¯•æ¨¡å¼
â”‚   â””â”€ å¹‚ç­‰æ€§æ¨¡å¼
â”‚
â”œâ”€ ä¸€è‡´æ€§ä¿è¯æ¨¡å¼
â”‚   â”œâ”€ æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼
â”‚   â”œâ”€ å¼ºä¸€è‡´æ€§æ¨¡å¼
â”‚   â””â”€ è¡¥å¿äº‹åŠ¡æ¨¡å¼
â”‚
â”œâ”€ æ€§èƒ½ä¼˜åŒ–æ¨¡å¼
â”‚   â”œâ”€ ç¼“å­˜é¢„å‡æ¨¡å¼
â”‚   â”œâ”€ æ‰¹é‡å¤„ç†æ¨¡å¼
â”‚   â””â”€ å¼‚æ­¥åŒ–æ¨¡å¼
â”‚
â”œâ”€ å®¹é”™ä¸æ¢å¤æ¨¡å¼
â”‚   â”œâ”€ é‡è¯•æ¨¡å¼
â”‚   â”œâ”€ å›æ»šæ¨¡å¼
â”‚   â””â”€ å®šæ—¶åŒæ­¥æ¨¡å¼
â”‚
â””â”€ ç›‘æ§ä¸å‘Šè­¦æ¨¡å¼
    â”œâ”€ å®æ—¶ç›‘æ§æ¨¡å¼
    â””â”€ å‘Šè­¦æ¨¡å¼
```

---

## äºŒã€å¹¶å‘æ§åˆ¶æ¨¡å¼

### 2.1 åˆ†å±‚è¿‡æ»¤æ¨¡å¼ï¼ˆLayered Filteringï¼‰

**æ¨¡å¼å®šä¹‰**: é€šè¿‡å¤šå±‚é˜²æŠ¤æœºåˆ¶ï¼Œé€å±‚è¿‡æ»¤æ— æ•ˆè¯·æ±‚ï¼Œå‡å°‘åº•å±‚ç³»ç»Ÿå‹åŠ›ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… é«˜å¹¶å‘åœºæ™¯ï¼ˆç§’æ€ã€æŠ¢ç¥¨ï¼‰
- âœ… éœ€è¦å‡å°‘æ•°æ®åº“å‹åŠ›çš„åœºæ™¯
- âœ… éœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
åˆ†å±‚è¿‡æ»¤æ¶æ„:
â”œâ”€ L4: ç”¨æˆ·å±‚
â”‚   â””â”€ å®¢æˆ·ç«¯é™æµã€éªŒè¯ç 
â”‚
â”œâ”€ L3: æ¥å…¥å±‚
â”‚   â””â”€ è´Ÿè½½å‡è¡¡ã€é™æµä¸­é—´ä»¶
â”‚
â”œâ”€ L2: åº”ç”¨å±‚
â”‚   â””â”€ åº”ç”¨é™æµã€æœ¬åœ°ç¼“å­˜
â”‚
â”œâ”€ L1: ç¼“å­˜å±‚
â”‚   â””â”€ Redisé¢„å‡ã€å¿«é€Ÿå¤±è´¥
â”‚
â””â”€ L0: æ•°æ®å±‚
    â””â”€ æ•°æ®åº“æœ€ç»ˆéªŒè¯
```

**å®ç°ç¤ºä¾‹**:

```rust
// åˆ†å±‚è¿‡æ»¤å®ç°
pub struct LayeredFilter {
    rate_limiter: RateLimiter,
    local_cache: LocalCache,
    redis: RedisClient,
    db: DatabaseClient,
}

impl LayeredFilter {
    async fn process_request(&self, request: Request) -> Result<Response> {
        // L2: åº”ç”¨å±‚é™æµ
        if !self.rate_limiter.allow() {
            return Err(Error::RateLimited);
        }

        // L2: æœ¬åœ°ç¼“å­˜æ£€æŸ¥
        if let Some(cached) = self.local_cache.get(&request.key) {
            return Ok(cached);
        }

        // L1: Redisé¢„å‡ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
        let remaining = self.redis.pre_decrement(&request.key).await?;
        if remaining < 0 {
            return Err(Error::OutOfStock);
        }

        // L0: æ•°æ®åº“æœ€ç»ˆéªŒè¯
        let result = self.db.verify(&request).await?;

        Ok(result)
    }
}
```

**æ€§èƒ½å½±å“**:

- æ— æ•ˆè¯·æ±‚æ‹¦æˆªç‡: 98%+
- æ•°æ®åº“å‹åŠ›å‡å°‘: 98%+
- å“åº”æ—¶é—´: ä»1,200msé™è‡³10ms

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

### 2.2 å¿«é€Ÿå¤±è´¥æ¨¡å¼ï¼ˆFail Fastï¼‰

**æ¨¡å¼å®šä¹‰**: åœ¨è¯·æ±‚å¤„ç†çš„æ—©æœŸé˜¶æ®µè¿›è¡Œå¿«é€Ÿæ£€æŸ¥ï¼Œæ— æ•ˆè¯·æ±‚ç«‹å³è¿”å›ï¼Œé¿å…æµªè´¹ç³»ç»Ÿèµ„æºã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… é«˜å¹¶å‘åœºæ™¯
- âœ… éœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯
- âœ… èµ„æºæœ‰é™çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
å¿«é€Ÿå¤±è´¥æµç¨‹:
â”œâ”€ æ£€æŸ¥1: å‚æ•°éªŒè¯ï¼ˆæœ€å¿«ï¼Œåº”ç”¨å±‚ï¼‰
â”‚   â””â”€ æ— æ•ˆå‚æ•° â†’ ç«‹å³è¿”å›
â”‚
â”œâ”€ æ£€æŸ¥2: ä¸šåŠ¡è§„åˆ™æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼Œåº”ç”¨å±‚ï¼‰
â”‚   â””â”€ è¿åè§„åˆ™ â†’ ç«‹å³è¿”å›
â”‚
â”œâ”€ æ£€æŸ¥3: ç¼“å­˜æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼Œç¼“å­˜å±‚ï¼‰
â”‚   â””â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ ç»§ç»­
â”‚
â””â”€ æ£€æŸ¥4: æ•°æ®åº“éªŒè¯ï¼ˆè¾ƒæ…¢ï¼Œæ•°æ®å±‚ï¼‰
    â””â”€ åªæœ‰é€šè¿‡å‰3å±‚æ£€æŸ¥çš„è¯·æ±‚æ‰ä¼šåˆ°è¾¾
```

**å®ç°ç¤ºä¾‹**:

```rust
// å¿«é€Ÿå¤±è´¥å®ç°
async fn process_with_fail_fast(
    &self,
    user_id: i64,
    product_id: i64,
) -> Result<OrderId> {
    // æ£€æŸ¥1: å‚æ•°éªŒè¯ï¼ˆæœ€å¿«ï¼‰
    if user_id <= 0 || product_id <= 0 {
        return Err(Error::InvalidParameter);
    }

    // æ£€æŸ¥2: é™è´­æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼‰
    if self.has_purchased(user_id, product_id).await? {
        return Err(Error::AlreadyPurchased);  // ç«‹å³è¿”å›
    }

    // æ£€æŸ¥3: Redisé¢„å‡ï¼ˆå¿«é€Ÿï¼‰
    let remaining = self.redis.pre_decrement(product_id).await?;
    if remaining < 0 {
        return Err(Error::OutOfStock);  // ç«‹å³è¿”å›
    }

    // æ£€æŸ¥4: æ•°æ®åº“éªŒè¯ï¼ˆè¾ƒæ…¢ï¼Œåªæœ‰é€šè¿‡å‰3å±‚æ£€æŸ¥çš„è¯·æ±‚ï¼‰
    self.db.verify_and_create_order(user_id, product_id).await
}
```

**æ€§èƒ½å½±å“**:

- æ— æ•ˆè¯·æ±‚å“åº”æ—¶é—´: ä»1,200msé™è‡³10ms
- ç³»ç»Ÿèµ„æºèŠ‚çœ: 98%+

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

### 2.3 ä¹è§‚é”é‡è¯•æ¨¡å¼ï¼ˆOptimistic Lock Retryï¼‰

**æ¨¡å¼å®šä¹‰**: ä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³å®ç°ä¹è§‚é”ï¼Œå†²çªæ—¶é‡è¯•ï¼Œé¿å…æ‚²è§‚é”çš„æ€§èƒ½é—®é¢˜ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… å†²çªç‡ä½çš„åœºæ™¯ï¼ˆ<10%ï¼‰
- âœ… éœ€è¦é«˜å¹¶å‘çš„åœºæ™¯
- âœ… å¯ä»¥æ¥å—é‡è¯•çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
ä¹è§‚é”é‡è¯•æµç¨‹:
â”œâ”€ Step 1: è¯»å–å½“å‰ç‰ˆæœ¬å·
â”œâ”€ Step 2: è®¡ç®—æ–°å€¼
â”œâ”€ Step 3: CASæ›´æ–°ï¼ˆç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
â”‚   â”œâ”€ æˆåŠŸ â†’ å®Œæˆ
â”‚   â””â”€ å¤±è´¥ â†’ é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
â””â”€ Step 4: è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•° â†’ å¤±è´¥
```

**å®ç°ç¤ºä¾‹**:

```rust
// ä¹è§‚é”é‡è¯•å®ç°
async fn update_with_optimistic_lock(
    &self,
    id: i64,
    update_fn: impl Fn(Value) -> Value,
) -> Result<Value> {
    const MAX_RETRIES: usize = 3;
    const BASE_DELAY_MS: u64 = 10;

    for attempt in 0..MAX_RETRIES {
        // Step 1: è¯»å–å½“å‰ç‰ˆæœ¬å’Œå€¼
        let (current_version, current_value) = self.get_with_version(id).await?;

        // Step 2: è®¡ç®—æ–°å€¼
        let new_value = update_fn(current_value);

        // Step 3: CASæ›´æ–°
        match self.cas_update(id, current_version, new_value).await {
            Ok(updated_value) => return Ok(updated_value),
            Err(Error::VersionConflict) => {
                if attempt < MAX_RETRIES - 1 {
                    // æŒ‡æ•°é€€é¿
                    let delay = BASE_DELAY_MS * (1 << attempt);
                    tokio::time::sleep(Duration::from_millis(delay)).await;
                    continue;
                } else {
                    return Err(Error::TooManyRetries);
                }
            }
            Err(e) => return Err(e),
        }
    }

    Err(Error::TooManyRetries)
}
```

**æ€§èƒ½å½±å“**:

- æ— å†²çªæ—¶æ€§èƒ½: æ¥è¿‘æ— é”æ€§èƒ½
- å†²çªæ—¶æ€§èƒ½: é‡è¯•å¼€é”€ < 5%
- é€‚ç”¨å†²çªç‡: < 10%

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

### 2.4 å¹‚ç­‰æ€§æ¨¡å¼ï¼ˆIdempotencyï¼‰

**æ¨¡å¼å®šä¹‰**: é€šè¿‡å¹‚ç­‰é”®ä¿è¯æ“ä½œçš„å¹‚ç­‰æ€§ï¼Œé‡å¤è¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… é‡‘èäº¤æ˜“ç³»ç»Ÿ
- âœ… æ”¯ä»˜ç³»ç»Ÿ
- âœ… ä»»ä½•éœ€è¦é˜²æ­¢é‡å¤æ‰§è¡Œçš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
å¹‚ç­‰æ€§å®ç°:
â”œâ”€ Step 1: ç”Ÿæˆå¹‚ç­‰é”®ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
â”œâ”€ Step 2: æ£€æŸ¥å¹‚ç­‰é”®æ˜¯å¦å­˜åœ¨
â”‚   â”œâ”€ å­˜åœ¨ â†’ è¿”å›å·²æœ‰ç»“æœï¼ˆå¹‚ç­‰ï¼‰
â”‚   â””â”€ ä¸å­˜åœ¨ â†’ ç»§ç»­
â”œâ”€ Step 3: æ‰§è¡Œæ“ä½œ
â””â”€ Step 4: è®°å½•å¹‚ç­‰é”®å’Œç»“æœ
```

**å®ç°ç¤ºä¾‹**:

```java
// å¹‚ç­‰æ€§å®ç°ï¼ˆJavaï¼‰
@Service
public class TransferService {
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public TransferResult transfer(
        String idempotentKey,  // å¹‚ç­‰é”®
        String fromAccount,
        String toAccount,
        BigDecimal amount
    ) throws TransferException {
        // Step 1: æ£€æŸ¥å¹‚ç­‰æ€§
        Transfer existing = transferRepository.findByIdempotentKey(idempotentKey);
        if (existing != null) {
            // é‡å¤è¯·æ±‚ï¼Œç›´æ¥è¿”å›å·²æœ‰ç»“æœ
            return new TransferResult(existing);
        }

        // Step 2: æ‰§è¡Œè½¬è´¦
        TransferResult result = doTransfer(fromAccount, toAccount, amount);

        // Step 3: è®°å½•å¹‚ç­‰é”®
        Transfer transfer = new Transfer();
        transfer.setIdempotentKey(idempotentKey);
        transfer.setFromAccount(fromAccount);
        transfer.setToAccount(toAccount);
        transfer.setAmount(amount);
        transfer.setResult(result);
        transferRepository.save(transfer);

        return result;
    }
}
```

**æ•°æ®åº“çº¦æŸ**:

```sql
-- å¹‚ç­‰é”®å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_transfers_idempotent_key
ON transfers(idempotent_key);

-- æ’å…¥æ—¶æ£€æŸ¥
INSERT INTO transfers (idempotent_key, from_account, to_account, amount)
VALUES ($1, $2, $3, $4)
ON CONFLICT (idempotent_key) DO NOTHING
RETURNING *;
```

**æ€§èƒ½å½±å“**:

- å¹‚ç­‰æ€§æ£€æŸ¥å¼€é”€: < 1ms
- é‡å¤è¯·æ±‚å¤„ç†: ç›´æ¥è¿”å›ï¼Œæ— ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
- æ€§èƒ½å½±å“: å¯å¿½ç•¥

**æ¥æºæ¡ˆä¾‹**: `02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

## ä¸‰ã€ä¸€è‡´æ€§ä¿è¯æ¨¡å¼

### 3.1 æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼ï¼ˆEventual Consistencyï¼‰

**æ¨¡å¼å®šä¹‰**: é€šè¿‡ç¼“å­˜é¢„å‡å’Œæ•°æ®åº“éªŒè¯ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… ç§’æ€ç³»ç»Ÿ
- âœ… åº“å­˜ç®¡ç†
- âœ… å…è®¸çŸ­æš‚ä¸ä¸€è‡´çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
æœ€ç»ˆä¸€è‡´æ€§æµç¨‹:
â”œâ”€ T1: Redisé¢„å‡ï¼ˆå¿«é€Ÿï¼Œå¯èƒ½ä¸ä¸€è‡´ï¼‰
â”œâ”€ T2: æ•°æ®åº“éªŒè¯ï¼ˆè¾ƒæ…¢ï¼Œå¼ºä¸€è‡´ï¼‰
â”œâ”€ T3: å¤±è´¥å›æ»šï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
â””â”€ T4: å®šæ—¶åŒæ­¥ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
```

**å®ç°ç¤ºä¾‹**:

```rust
// æœ€ç»ˆä¸€è‡´æ€§å®ç°
async fn seckill_with_eventual_consistency(
    &self,
    user_id: i64,
    product_id: i64,
) -> Result<OrderId> {
    // T1: Redisé¢„å‡ï¼ˆå¿«é€Ÿï¼Œå¯èƒ½ä¸ä¸€è‡´ï¼‰
    let remaining = self.redis.pre_decrement(product_id).await?;
    if remaining < 0 {
        return Err(Error::OutOfStock);
    }

    // T2: æ•°æ®åº“éªŒè¯ï¼ˆå¼ºä¸€è‡´ï¼‰
    match self.db.verify_and_create_order(user_id, product_id).await {
        Ok(order_id) => Ok(order_id),
        Err(e) => {
            // T3: å¤±è´¥å›æ»šï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
            self.redis.rollback(product_id).await?;
            Err(e)
        }
    }
}

// T4: å®šæ—¶åŒæ­¥ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
async fn sync_stock_periodically() {
    loop {
        tokio::time::sleep(Duration::from_millis(100)).await;

        // ä»æ•°æ®åº“è¯»å–çœŸå®åº“å­˜
        let real_stock = self.db.get_stock(product_id).await?;

        // æ›´æ–°Redis
        self.redis.set_stock(product_id, real_stock).await?;
    }
}
```

**ä¸€è‡´æ€§ä¿è¯**:

- å¼ºä¸€è‡´æ€§: æ•°æ®åº“å±‚ä¿è¯
- æœ€ç»ˆä¸€è‡´æ€§: Rediså±‚æœ€ç»ˆä¸æ•°æ®åº“ä¸€è‡´
- ä¸€è‡´æ€§å»¶è¿Ÿ: < 100msï¼ˆå®šæ—¶åŒæ­¥é—´éš”ï¼‰

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

### 3.2 å¼ºä¸€è‡´æ€§æ¨¡å¼ï¼ˆStrong Consistencyï¼‰

**æ¨¡å¼å®šä¹‰**: ä½¿ç”¨Serializableéš”ç¦»çº§åˆ«å’ŒSSIï¼Œä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé€‚ç”¨äºé‡‘èåœºæ™¯ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… é‡‘èäº¤æ˜“ç³»ç»Ÿ
- âœ… æ”¯ä»˜ç³»ç»Ÿ
- âœ… é›¶å®¹å¿æ•°æ®é”™è¯¯çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
å¼ºä¸€è‡´æ€§æµç¨‹:
â”œâ”€ Step 1: å¼€å¯Serializableäº‹åŠ¡
â”œâ”€ Step 2: FOR UPDATEé”å®šå…³é”®è¡Œ
â”œâ”€ Step 3: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
â”œâ”€ Step 4: SSIå†²çªæ£€æµ‹
â”‚   â”œâ”€ æ— å†²çª â†’ COMMIT
â”‚   â””â”€ æœ‰å†²çª â†’ ROLLBACK + é‡è¯•
â””â”€ Step 5: WALæŒä¹…åŒ–
```

**å®ç°ç¤ºä¾‹**:

```java
// å¼ºä¸€è‡´æ€§å®ç°
@Transactional(isolation = Isolation.SERIALIZABLE)
public TransferResult transfer(
    String fromAccount,
    String toAccount,
    BigDecimal amount
) throws TransferException {
    // Step 1: FOR UPDATEé”å®š
    Account from = jdbcTemplate.queryForObject(
        "SELECT * FROM accounts WHERE account_id = ? FOR UPDATE",
        new Object[]{fromAccount},
        new AccountRowMapper()
    );

    Account to = jdbcTemplate.queryForObject(
        "SELECT * FROM accounts WHERE account_id = ? FOR UPDATE",
        new Object[]{toAccount},
        new AccountRowMapper()
    );

    // Step 2: ä¸šåŠ¡é€»è¾‘
    if (from.getBalance().compareTo(amount) < 0) {
        throw new InsufficientFundsException();
    }

    // Step 3: æ›´æ–°ä½™é¢
    jdbcTemplate.update(
        "UPDATE accounts SET balance = balance - ? WHERE account_id = ?",
        amount, fromAccount
    );

    jdbcTemplate.update(
        "UPDATE accounts SET balance = balance + ? WHERE account_id = ?",
        amount, toAccount
    );

    // Step 4: SSIè‡ªåŠ¨æ£€æµ‹å†²çª
    // Step 5: WALè‡ªåŠ¨æŒä¹…åŒ–

    return new TransferResult(fromAccount, toAccount, amount);
}
```

**ä¸€è‡´æ€§ä¿è¯**:

- éš”ç¦»çº§åˆ«: Serializableï¼ˆæœ€å¼ºï¼‰
- å†²çªæ£€æµ‹: SSIè‡ªåŠ¨æ£€æµ‹
- æ•°æ®æ­£ç¡®æ€§: 100%ï¼ˆé›¶é”™è¯¯ï¼‰

**æ¥æºæ¡ˆä¾‹**: `02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

### 3.3 è¡¥å¿äº‹åŠ¡æ¨¡å¼ï¼ˆCompensating Transactionï¼‰

**æ¨¡å¼å®šä¹‰**: å½“åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥æ—¶ï¼Œé€šè¿‡è¡¥å¿æ“ä½œå›æ»šå·²æ‰§è¡Œçš„æ“ä½œã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… åˆ†å¸ƒå¼ç³»ç»Ÿ
- âœ… è·¨æœåŠ¡äº‹åŠ¡
- âœ… Sagaæ¨¡å¼

**æ¨¡å¼ç»“æ„**:

```text
è¡¥å¿äº‹åŠ¡æµç¨‹:
â”œâ”€ Step 1: æ‰§è¡Œæ“ä½œ1
â”œâ”€ Step 2: æ‰§è¡Œæ“ä½œ2
â”œâ”€ Step 3: æ‰§è¡Œæ“ä½œ3å¤±è´¥
â””â”€ Step 4: è¡¥å¿æ“ä½œï¼ˆå›æ»šæ“ä½œ1å’Œ2ï¼‰
```

**å®ç°ç¤ºä¾‹**:

```rust
// è¡¥å¿äº‹åŠ¡å®ç°
async fn distributed_transfer_with_compensation(
    &self,
    from_account: AccountId,
    to_account: AccountId,
    amount: Decimal,
) -> Result<()> {
    let mut compensations = Vec::new();

    // Step 1: æ‰£æ¬¾
    match self.account_service.debit(from_account, amount).await {
        Ok(_) => {
            compensations.push(Compensation::Credit(from_account, amount));
        }
        Err(e) => return Err(e),
    }

    // Step 2: å…¥è´¦
    match self.account_service.credit(to_account, amount).await {
        Ok(_) => {
            compensations.push(Compensation::Debit(to_account, amount));
        }
        Err(e) => {
            // è¡¥å¿: å›æ»šæ‰£æ¬¾
            self.compensate(compensations).await?;
            return Err(e);
        }
    }

    // Step 3: è®°å½•è½¬è´¦
    match self.transfer_service.record_transfer(from_account, to_account, amount).await {
        Ok(_) => Ok(()),
        Err(e) => {
            // è¡¥å¿: å›æ»šæ‰£æ¬¾å’Œå…¥è´¦
            self.compensate(compensations).await?;
            Err(e)
        }
    }
}

async fn compensate(&self, compensations: Vec<Compensation>) -> Result<()> {
    // æŒ‰ç›¸åé¡ºåºæ‰§è¡Œè¡¥å¿æ“ä½œ
    for comp in compensations.iter().rev() {
        match comp {
            Compensation::Credit(account, amount) => {
                self.account_service.credit(*account, *amount).await?;
            }
            Compensation::Debit(account, amount) => {
                self.account_service.debit(*account, *amount).await?;
            }
        }
    }
    Ok(())
}
```

**æ¥æºæ¡ˆä¾‹**: `02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`ã€`07-åˆ†å¸ƒå¼ç¼“å­˜.md`

---

## å››ã€æ€§èƒ½ä¼˜åŒ–æ¨¡å¼

### 4.1 ç¼“å­˜é¢„å‡æ¨¡å¼ï¼ˆCache Pre-decrementï¼‰

**æ¨¡å¼å®šä¹‰**: åœ¨ç¼“å­˜å±‚è¿›è¡Œé¢„å‡æ“ä½œï¼Œå¿«é€Ÿæ‹¦æˆªæ— æ•ˆè¯·æ±‚ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… é«˜å¹¶å‘åº“å­˜æ‰£å‡
- âœ… ç§’æ€ç³»ç»Ÿ
- âœ… éœ€è¦å¿«é€Ÿå¤±è´¥çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
ç¼“å­˜é¢„å‡æµç¨‹:
â”œâ”€ Step 1: Redis DECRï¼ˆåŸå­æ“ä½œï¼‰
â”œâ”€ Step 2: æ£€æŸ¥ç»“æœ
â”‚   â”œâ”€ remaining >= 0 â†’ ç»§ç»­
â”‚   â””â”€ remaining < 0 â†’ å›æ»š + å¿«é€Ÿå¤±è´¥
â”œâ”€ Step 3: æ•°æ®åº“éªŒè¯
â””â”€ Step 4: å¤±è´¥æ—¶å›æ»šRedis
```

**å®ç°ç¤ºä¾‹**:

```rust
// ç¼“å­˜é¢„å‡å®ç°
impl RedisStockManager {
    pub async fn pre_decrease_stock(
        &self,
        product_id: i64,
        quantity: i64,
    ) -> Result<i64, StockError> {
        let key = format!("seckill:{}:stock", product_id);
        let mut conn = self.conn.lock().await;

        // åŸå­æ“ä½œ: DECR
        let remaining: i64 = conn.decr(&key, quantity).await?;

        if remaining < 0 {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š
            conn.incr(&key, quantity).await?;
            return Err(StockError::OutOfStock);
        }

        Ok(remaining)
    }

    pub async fn rollback_stock(
        &self,
        product_id: i64,
        quantity: i64,
    ) -> Result<(), StockError> {
        let key = format!("seckill:{}:stock", product_id);
        let mut conn = self.conn.lock().await;
        conn.incr(&key, quantity).await?;
        Ok(())
    }
}
```

**æ€§èƒ½å½±å“**:

- æ— æ•ˆè¯·æ±‚æ‹¦æˆªç‡: 98%+
- æ•°æ®åº“å‹åŠ›å‡å°‘: 98%+
- å“åº”æ—¶é—´: ä»1,200msé™è‡³10ms

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

### 4.2 æ‰¹é‡å¤„ç†æ¨¡å¼ï¼ˆBatch Processingï¼‰

**æ¨¡å¼å®šä¹‰**: å°†å¤šä¸ªæ“ä½œåˆå¹¶ä¸ºæ‰¹é‡æ“ä½œï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… æ‰¹é‡æ’å…¥
- âœ… æ‰¹é‡æ›´æ–°
- âœ… éœ€è¦å‡å°‘æ•°æ®åº“è®¿é—®çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
æ‰¹é‡å¤„ç†æµç¨‹:
â”œâ”€ Step 1: æ”¶é›†æ“ä½œï¼ˆå†…å­˜ï¼‰
â”œâ”€ Step 2: è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–è¶…æ—¶
â”œâ”€ Step 3: æ‰¹é‡æ‰§è¡Œï¼ˆå•æ¬¡æ•°æ®åº“è®¿é—®ï¼‰
â””â”€ Step 4: è¿”å›ç»“æœ
```

**å®ç°ç¤ºä¾‹**:

```rust
// æ‰¹é‡å¤„ç†å®ç°
pub struct BatchProcessor<T> {
    batch: Vec<T>,
    batch_size: usize,
    timeout: Duration,
    last_flush: Instant,
}

impl<T> BatchProcessor<T> {
    pub async fn add(&mut self, item: T) -> Result<()> {
        self.batch.push(item);

        // è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–è¶…æ—¶ï¼Œæ‰§è¡Œæ‰¹é‡æ“ä½œ
        if self.batch.len() >= self.batch_size
            || self.last_flush.elapsed() >= self.timeout {
            self.flush().await?;
        }

        Ok(())
    }

    async fn flush(&mut self) -> Result<()> {
        if self.batch.is_empty() {
            return Ok(());
        }

        // æ‰¹é‡æ’å…¥
        self.db.batch_insert(&self.batch).await?;

        self.batch.clear();
        self.last_flush = Instant::now();
        Ok(())
    }
}
```

**æ€§èƒ½å½±å“**:

- æ•°æ®åº“è®¿é—®å‡å°‘: ä»Næ¬¡é™è‡³1æ¬¡
- æ€§èƒ½æå‡: NÃ—ï¼ˆNä¸ºæ‰¹é‡å¤§å°ï¼‰

**æ¥æºæ¡ˆä¾‹**: `04-å®æ—¶åˆ†æç³»ç»Ÿ.md`ã€`05-IoTæ—¶åºæ•°æ®.md`

---

### 4.3 å¼‚æ­¥åŒ–æ¨¡å¼ï¼ˆAsynchronizationï¼‰

**æ¨¡å¼å®šä¹‰**: å°†éå…³é”®è·¯å¾„æ“ä½œå¼‚æ­¥åŒ–ï¼Œå‡å°‘ä¸»æµç¨‹å»¶è¿Ÿã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… æ—¥å¿—è®°å½•
- âœ… é€šçŸ¥å‘é€
- âœ… ç»Ÿè®¡åˆ†æ
- âœ… éå…³é”®è·¯å¾„æ“ä½œ

**æ¨¡å¼ç»“æ„**:

```text
å¼‚æ­¥åŒ–æµç¨‹:
â”œâ”€ åŒæ­¥æ“ä½œ: å…³é”®è·¯å¾„ï¼ˆå¿…é¡»åŒæ­¥ï¼‰
â”‚   â””â”€ åº“å­˜æ‰£å‡ã€è®¢å•åˆ›å»º
â”‚
â””â”€ å¼‚æ­¥æ“ä½œ: éå…³é”®è·¯å¾„ï¼ˆå¯ä»¥å¼‚æ­¥ï¼‰
    â”œâ”€ å‘é€é€šçŸ¥
    â”œâ”€ æ›´æ–°ç»Ÿè®¡
    â””â”€ è®°å½•æ—¥å¿—
```

**å®ç°ç¤ºä¾‹**:

```rust
// å¼‚æ­¥åŒ–å®ç°
async fn seckill_with_async(
    &self,
    user_id: i64,
    product_id: i64,
) -> Result<OrderId> {
    // åŒæ­¥æ“ä½œ: å…³é”®è·¯å¾„
    let order_id = self.seckill_sync(user_id, product_id).await?;

    // å¼‚æ­¥æ“ä½œ: éå…³é”®è·¯å¾„
    let order_id_clone = order_id;
    let user_id_clone = user_id;
    let product_id_clone = product_id;

    tokio::spawn(async move {
        // å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
        notification_service.send_order_created(order_id_clone).await?;

        // æ›´æ–°ç»Ÿè®¡ï¼ˆå¼‚æ­¥ï¼‰
        statistics_service.record_seckill(user_id_clone, product_id_clone).await?;

        // è®°å½•æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰
        log_service.log_seckill(user_id_clone, product_id_clone).await?;

        Ok::<(), Error>(())
    });

    Ok(order_id)
}
```

**æ€§èƒ½å½±å“**:

- ä¸»æµç¨‹å»¶è¿Ÿ: ä»150msé™è‡³95ms
- ç³»ç»Ÿååé‡: æå‡30%+

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`ã€`03-ç¤¾äº¤ç½‘ç»œç³»ç»Ÿ.md`

---

## äº”ã€å®¹é”™ä¸æ¢å¤æ¨¡å¼

### 5.1 é‡è¯•æ¨¡å¼ï¼ˆRetryï¼‰

**æ¨¡å¼å®šä¹‰**: æ“ä½œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæé«˜æˆåŠŸç‡ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… ç½‘ç»œè¯·æ±‚
- âœ… æ•°æ®åº“æ“ä½œ
- âœ… å¤–éƒ¨APIè°ƒç”¨
- âœ… ä¸´æ—¶æ€§å¤±è´¥

**æ¨¡å¼ç»“æ„**:

```text
é‡è¯•ç­–ç•¥:
â”œâ”€ å›ºå®šé‡è¯•: æ¯æ¬¡é‡è¯•é—´éš”å›ºå®š
â”œâ”€ æŒ‡æ•°é€€é¿: é‡è¯•é—´éš”æŒ‡æ•°å¢é•¿
â”œâ”€ éšæœºé€€é¿: é‡è¯•é—´éš”éšæœºï¼ˆé¿å…é‡è¯•åŒæ­¥ï¼‰
â””â”€ è‡ªé€‚åº”é€€é¿: æ ¹æ®å†²çªç‡è°ƒæ•´
```

**å®ç°ç¤ºä¾‹**:

```rust
// é‡è¯•æ¨¡å¼å®ç°
pub struct RetryPolicy {
    max_retries: usize,
    base_delay: Duration,
    max_delay: Duration,
    strategy: RetryStrategy,
}

pub enum RetryStrategy {
    Fixed,           // å›ºå®šé—´éš”
    Exponential,     // æŒ‡æ•°é€€é¿
    Random,          // éšæœºé€€é¿
    Adaptive,        // è‡ªé€‚åº”
}

impl RetryPolicy {
    pub async fn execute<F, T, E>(
        &self,
        mut operation: F,
    ) -> Result<T, E>
    where
        F: FnMut() -> Result<T, E>,
        E: std::error::Error + Send + Sync + 'static,
    {
        for attempt in 0..self.max_retries {
            match operation() {
                Ok(result) => return Ok(result),
                Err(e) => {
                    if attempt < self.max_retries - 1 {
                        let delay = self.calculate_delay(attempt);
                        tokio::time::sleep(delay).await;
                        continue;
                    } else {
                        return Err(e);
                    }
                }
            }
        }

        unreachable!()
    }

    fn calculate_delay(&self, attempt: usize) -> Duration {
        match self.strategy {
            RetryStrategy::Fixed => self.base_delay,
            RetryStrategy::Exponential => {
                let delay = self.base_delay.as_millis() as u64 * (1 << attempt);
                Duration::from_millis(delay.min(self.max_delay.as_millis() as u64))
            }
            RetryStrategy::Random => {
                let base = self.base_delay.as_millis() as u64;
                let random = rand::random::<u64>() % base;
                Duration::from_millis(base + random)
            }
            RetryStrategy::Adaptive => {
                // æ ¹æ®å†²çªç‡è°ƒæ•´
                let conflict_rate = self.get_conflict_rate();
                let multiplier = if conflict_rate > 0.1 { 2.0 } else { 1.0 };
                let delay = (self.base_delay.as_millis() as f64 * multiplier * (1 << attempt) as f64) as u64;
                Duration::from_millis(delay.min(self.max_delay.as_millis() as u64))
            }
        }
    }
}
```

**æ€§èƒ½å½±å“**:

- æˆåŠŸç‡æå‡: ä»90%æå‡è‡³99%+
- é‡è¯•å¼€é”€: < 5%ï¼ˆä½å†²çªç‡æ—¶ï¼‰

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`ã€`02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

### 5.2 å›æ»šæ¨¡å¼ï¼ˆRollbackï¼‰

**æ¨¡å¼å®šä¹‰**: æ“ä½œå¤±è´¥æ—¶å›æ»šå·²æ‰§è¡Œçš„æ“ä½œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… åˆ†å¸ƒå¼äº‹åŠ¡
- âœ… å¤šæ­¥éª¤æ“ä½œ
- âœ… éœ€è¦ä¿è¯åŸå­æ€§çš„åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
å›æ»šæµç¨‹:
â”œâ”€ Step 1: æ‰§è¡Œæ“ä½œ1
â”œâ”€ Step 2: æ‰§è¡Œæ“ä½œ2
â”œâ”€ Step 3: æ“ä½œ3å¤±è´¥
â””â”€ Step 4: å›æ»šæ“ä½œ1å’Œ2
```

**å®ç°ç¤ºä¾‹**:

```rust
// å›æ»šæ¨¡å¼å®ç°
async fn transfer_with_rollback(
    &self,
    from_account: AccountId,
    to_account: AccountId,
    amount: Decimal,
) -> Result<()> {
    // Step 1: Redisé¢„å‡
    let remaining = self.redis.pre_decrement(from_account, amount).await?;

    // Step 2: æ•°æ®åº“éªŒè¯
    match self.db.transfer(from_account, to_account, amount).await {
        Ok(_) => Ok(()),
        Err(e) => {
            // Step 3: å¤±è´¥å›æ»š
            self.redis.rollback(from_account, amount).await?;
            Err(e)
        }
    }
}
```

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`ã€`02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

### 5.3 å®šæ—¶åŒæ­¥æ¨¡å¼ï¼ˆPeriodic Syncï¼‰

**æ¨¡å¼å®šä¹‰**: å®šæœŸåŒæ­¥æ•°æ®ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

**é€‚ç”¨åœºæ™¯**:

- âœ… ç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥
- âœ… ä¸»ä»æ•°æ®åŒæ­¥
- âœ… æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯

**æ¨¡å¼ç»“æ„**:

```text
å®šæ—¶åŒæ­¥æµç¨‹:
â”œâ”€ å®šæ—¶è§¦å‘ï¼ˆæ¯Tç§’ï¼‰
â”œâ”€ è¯»å–æºæ•°æ®
â”œâ”€ æ›´æ–°ç›®æ ‡æ•°æ®
â””â”€ è®°å½•åŒæ­¥æ—¶é—´
```

**å®ç°ç¤ºä¾‹**:

```rust
// å®šæ—¶åŒæ­¥å®ç°
async fn sync_stock_periodically() {
    let sync_interval = Duration::from_millis(100);

    loop {
        tokio::time::sleep(sync_interval).await;

        // ä»æ•°æ®åº“è¯»å–çœŸå®åº“å­˜
        let products = db.query_all_products().await?;

        for product in products {
            // æ›´æ–°Redis
            redis.set(
                format!("seckill:{}:stock", product.id),
                product.stock
            ).await?;
        }

        // è®°å½•åŒæ­¥æ—¶é—´
        last_sync_time.store(Instant::now());
    }
}
```

**æ€§èƒ½å½±å“**:

- ä¸€è‡´æ€§å»¶è¿Ÿ: < åŒæ­¥é—´éš”ï¼ˆ100msï¼‰
- æ€§èƒ½å¼€é”€: ä½ï¼ˆåå°ä»»åŠ¡ï¼‰

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`

---

## å…­ã€ç›‘æ§ä¸å‘Šè­¦æ¨¡å¼

### 6.1 å®æ—¶ç›‘æ§æ¨¡å¼ï¼ˆReal-time Monitoringï¼‰

**æ¨¡å¼å®šä¹‰**: å®æ—¶æ”¶é›†å’Œå±•ç¤ºç³»ç»ŸæŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ã€‚

**å…³é”®æŒ‡æ ‡**:

```rust
// å®æ—¶ç›‘æ§æŒ‡æ ‡
pub struct SystemMetrics {
    // æ€§èƒ½æŒ‡æ ‡
    tps: AtomicU64,
    latency_p50: AtomicU64,
    latency_p99: AtomicU64,

    // ä¸šåŠ¡æŒ‡æ ‡
    success_rate: AtomicU64,
    error_rate: AtomicU64,

    // ç³»ç»ŸæŒ‡æ ‡
    cpu_usage: AtomicU64,
    memory_usage: AtomicU64,
    connection_pool_usage: AtomicU64,
}
```

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`ã€`02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

### 6.2 å‘Šè­¦æ¨¡å¼ï¼ˆAlertingï¼‰

**æ¨¡å¼å®šä¹‰**: å½“æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨å‘Šè­¦ï¼ŒåŠæ—¶é€šçŸ¥è¿ç»´äººå‘˜ã€‚

**å‘Šè­¦è§„åˆ™**:

```rust
// å‘Šè­¦è§„åˆ™
fn check_alerts(metrics: &SystemMetrics) {
    if metrics.tps.load() < 10_000 {
        alert_system.send(Alert::LowTPS);
    }

    if metrics.latency_p99.load() > 200_000_000 {  // 200ms
        alert_system.send(Alert::HighLatency);
    }

    if metrics.error_rate.load() > 1_000 {  // 1%
        alert_system.send(Alert::HighErrorRate);
    }
}
```

**æ¥æºæ¡ˆä¾‹**: `01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`ã€`02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`

---

## ä¸ƒã€æ¨¡å¼é€‰æ‹©å†³ç­–æ ‘

**æ¨¡å¼é€‰æ‹©å†³ç­–æ ‘**:

```text
                    å¼€å§‹ï¼šé€‰æ‹©è®¾è®¡æ¨¡å¼
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   åœºæ™¯ç±»å‹åˆ†æ        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚               â”‚               â”‚
        é«˜å¹¶å‘åœºæ™¯      å¼ºä¸€è‡´æ€§åœºæ™¯    æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯
            â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼
      åˆ†å±‚è¿‡æ»¤æ¨¡å¼      å¼ºä¸€è‡´æ€§æ¨¡å¼    æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼
      å¿«é€Ÿå¤±è´¥æ¨¡å¼      å¹‚ç­‰æ€§æ¨¡å¼      è¡¥å¿äº‹åŠ¡æ¨¡å¼
      ç¼“å­˜é¢„å‡æ¨¡å¼      é‡è¯•æ¨¡å¼        å®šæ—¶åŒæ­¥æ¨¡å¼
      ä¹è§‚é”é‡è¯•æ¨¡å¼    WALå½’æ¡£æ¨¡å¼
      å¼‚æ­¥åŒ–æ¨¡å¼
```

---

## å…«ã€æ¨¡å¼ç»„åˆä½¿ç”¨

**å¸¸è§æ¨¡å¼ç»„åˆ**:

| åœºæ™¯ | æ¨¡å¼ç»„åˆ | æ•ˆæœ |
|------|---------|------|
| **ç§’æ€ç³»ç»Ÿ** | åˆ†å±‚è¿‡æ»¤ + å¿«é€Ÿå¤±è´¥ + ç¼“å­˜é¢„å‡ + ä¹è§‚é”é‡è¯• | TPS 55,000 |
| **é‡‘èç³»ç»Ÿ** | å¼ºä¸€è‡´æ€§ + å¹‚ç­‰æ€§ + é‡è¯• + WALå½’æ¡£ | æ­£ç¡®æ€§100% |
| **å®æ—¶åˆ†æ** | æ‰¹é‡å¤„ç† + å¼‚æ­¥åŒ– + æœ€ç»ˆä¸€è‡´æ€§ | ååé‡æå‡10Ã— |

---

## ä¹ã€æ¨¡å¼æ€§èƒ½å¯¹æ¯”

**æ¨¡å¼æ€§èƒ½å¯¹æ¯”çŸ©é˜µ**:

| æ¨¡å¼ | æ€§èƒ½æå‡ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|--------|---------|
| **åˆ†å±‚è¿‡æ»¤** | 98%æ— æ•ˆè¯·æ±‚æ‹¦æˆª | ä¸­ | é«˜å¹¶å‘ |
| **å¿«é€Ÿå¤±è´¥** | å“åº”æ—¶é—´-92% | ä½ | é«˜å¹¶å‘ |
| **ç¼“å­˜é¢„å‡** | TPS +1471% | ä¸­ | åº“å­˜æ‰£å‡ |
| **ä¹è§‚é”é‡è¯•** | TPS +243% | ä¸­ | ä½å†²çªç‡ |
| **å¹‚ç­‰æ€§** | é˜²æ­¢é‡å¤æ‰§è¡Œ | ä½ | é‡‘èç³»ç»Ÿ |
| **æ‰¹é‡å¤„ç†** | æ€§èƒ½æå‡NÃ— | ä¸­ | æ‰¹é‡æ“ä½œ |
| **å¼‚æ­¥åŒ–** | å»¶è¿Ÿ-37% | ä½ | éå…³é”®è·¯å¾„ |

---

## åã€æ¨¡å¼åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹1: ç§’æ€ç³»ç»Ÿæ¨¡å¼ç»„åˆ

**ä½¿ç”¨çš„æ¨¡å¼**:

1. åˆ†å±‚è¿‡æ»¤æ¨¡å¼
2. å¿«é€Ÿå¤±è´¥æ¨¡å¼
3. ç¼“å­˜é¢„å‡æ¨¡å¼
4. ä¹è§‚é”é‡è¯•æ¨¡å¼
5. å¼‚æ­¥åŒ–æ¨¡å¼

**æ•ˆæœ**: TPSä»3,500æå‡è‡³55,000ï¼ˆ+1471%ï¼‰

### æ¡ˆä¾‹2: é‡‘èç³»ç»Ÿæ¨¡å¼ç»„åˆ

**ä½¿ç”¨çš„æ¨¡å¼**:

1. å¼ºä¸€è‡´æ€§æ¨¡å¼
2. å¹‚ç­‰æ€§æ¨¡å¼
3. é‡è¯•æ¨¡å¼
4. WALå½’æ¡£æ¨¡å¼

**æ•ˆæœ**: æ­£ç¡®æ€§100%ï¼Œé›¶é”™è¯¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05

**ç›¸å…³æ–‡æ¡£**:

- `09-å·¥ä¸šæ¡ˆä¾‹åº“/01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/02-é‡‘èäº¤æ˜“ç³»ç»Ÿ.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/03-ç¤¾äº¤ç½‘ç»œç³»ç»Ÿ.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/04-å®æ—¶åˆ†æç³»ç»Ÿ.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/05-IoTæ—¶åºæ•°æ®.md`
