# 09 | ç¨‹åºè®¾è®¡å¯¼å›¾é›†ï¼ˆå®Œæ•´ç‰ˆï¼‰

> **å¯è§†åŒ–å·¥å…·**: æœ¬æ–‡æ¡£æä¾›ç³»ç»ŸåŒ–çš„ç¨‹åºè®¾è®¡å¯¼å›¾ï¼Œæ¶µç›–æ¶æ„è®¾è®¡ã€æ¨¡å—è®¾è®¡ã€æ¥å£è®¾è®¡ç­‰å¤šä¸ªå±‚é¢ã€‚
> **ğŸ“– æ¦‚å¿µè¯å…¸å¼•ç”¨**ï¼šæœ¬æ–‡æ¡£ä¸­æ¶‰åŠçš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå®šä¹‰ä¸ [æ ¸å¿ƒæ¦‚å¿µè¯å…¸](../00-ç†è®ºæ¡†æ¶æ€»è§ˆ/01-æ ¸å¿ƒæ¦‚å¿µè¯å…¸.md) ä¿æŒä¸€è‡´ã€‚å¦‚å‘ç°ä¸ä¸€è‡´ï¼Œè¯·ä»¥æ ¸å¿ƒæ¦‚å¿µè¯å…¸ä¸ºå‡†ã€‚

---

## ğŸ“‘ ç›®å½•

- [09 | ç¨‹åºè®¾è®¡å¯¼å›¾é›†ï¼ˆå®Œæ•´ç‰ˆï¼‰](#09--ç¨‹åºè®¾è®¡å¯¼å›¾é›†å®Œæ•´ç‰ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡å¯¼å›¾](#ä¸€ç³»ç»Ÿæ¶æ„è®¾è®¡å¯¼å›¾)
    - [1.1 ä¸‰å±‚æ¶æ„è®¾è®¡ï¼ˆLSEMï¼‰](#11-ä¸‰å±‚æ¶æ„è®¾è®¡lsem)
    - [1.2 å¾®æœåŠ¡æ¶æ„è®¾è®¡](#12-å¾®æœåŠ¡æ¶æ„è®¾è®¡)
    - [1.3 åˆ†å¸ƒå¼æ•°æ®åº“æ¶æ„](#13-åˆ†å¸ƒå¼æ•°æ®åº“æ¶æ„)
  - [äºŒã€æ¨¡å—è®¾è®¡å¯¼å›¾](#äºŒæ¨¡å—è®¾è®¡å¯¼å›¾)
    - [2.1 MVCCæ¨¡å—è®¾è®¡](#21-mvccæ¨¡å—è®¾è®¡)
    - [2.2 é”ç®¡ç†æ¨¡å—è®¾è®¡](#22-é”ç®¡ç†æ¨¡å—è®¾è®¡)
    - [2.3 äº‹åŠ¡ç®¡ç†æ¨¡å—è®¾è®¡](#23-äº‹åŠ¡ç®¡ç†æ¨¡å—è®¾è®¡)
  - [ä¸‰ã€æ¥å£è®¾è®¡å¯¼å›¾](#ä¸‰æ¥å£è®¾è®¡å¯¼å›¾)
    - [3.1 äº‹åŠ¡æ¥å£è®¾è®¡](#31-äº‹åŠ¡æ¥å£è®¾è®¡)
    - [3.2 å­˜å‚¨æ¥å£è®¾è®¡](#32-å­˜å‚¨æ¥å£è®¾è®¡)
    - [3.3 æŸ¥è¯¢æ¥å£è®¾è®¡](#33-æŸ¥è¯¢æ¥å£è®¾è®¡)
  - [å››ã€æ•°æ®æµè®¾è®¡å¯¼å›¾](#å››æ•°æ®æµè®¾è®¡å¯¼å›¾)
    - [4.1 æŸ¥è¯¢æ•°æ®æµ](#41-æŸ¥è¯¢æ•°æ®æµ)
    - [4.2 å†™å…¥æ•°æ®æµ](#42-å†™å…¥æ•°æ®æµ)
    - [4.3 å¤åˆ¶æ•°æ®æµ](#43-å¤åˆ¶æ•°æ®æµ)
  - [äº”ã€ç±»å›¾è®¾è®¡å¯¼å›¾](#äº”ç±»å›¾è®¾è®¡å¯¼å›¾)
    - [5.1 MVCCæ ¸å¿ƒç±»å›¾](#51-mvccæ ¸å¿ƒç±»å›¾)
    - [5.2 é”ç®¡ç†ç±»å›¾](#52-é”ç®¡ç†ç±»å›¾)
    - [5.3 äº‹åŠ¡ç®¡ç†ç±»å›¾](#53-äº‹åŠ¡ç®¡ç†ç±»å›¾)
  - [å…­ã€ç»„ä»¶äº¤äº’å¯¼å›¾](#å…­ç»„ä»¶äº¤äº’å¯¼å›¾)
    - [6.1 äº‹åŠ¡æäº¤äº¤äº’](#61-äº‹åŠ¡æäº¤äº¤äº’)
    - [6.2 æ­»é”æ£€æµ‹äº¤äº’](#62-æ­»é”æ£€æµ‹äº¤äº’)
    - [6.3 æ•…éšœæ¢å¤äº¤äº’](#63-æ•…éšœæ¢å¤äº¤äº’)
  - [ä¸ƒã€è®¾è®¡æ¨¡å¼åº”ç”¨å¯¼å›¾](#ä¸ƒè®¾è®¡æ¨¡å¼åº”ç”¨å¯¼å›¾)
    - [7.1 è®¾è®¡æ¨¡å¼åœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨](#71-è®¾è®¡æ¨¡å¼åœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨)
    - [7.2 å¹¶å‘è®¾è®¡æ¨¡å¼](#72-å¹¶å‘è®¾è®¡æ¨¡å¼)
  - [å…«ã€å®Œæ•´è®¾è®¡å·¥å…·å®ç°](#å…«å®Œæ•´è®¾è®¡å·¥å…·å®ç°)
    - [8.1 PlantUMLä»£ç ç”Ÿæˆå™¨](#81-plantumlä»£ç ç”Ÿæˆå™¨)
    - [8.2 æ¶æ„å›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·](#82-æ¶æ„å›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·)
  - [ä¹ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#ä¹å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹: æ–°ç³»ç»Ÿæ¶æ„è®¾è®¡](#91-æ¡ˆä¾‹-æ–°ç³»ç»Ÿæ¶æ„è®¾è®¡)
    - [9.2 æ¡ˆä¾‹: é‡æ„ç°æœ‰ç³»ç»Ÿ](#92-æ¡ˆä¾‹-é‡æ„ç°æœ‰ç³»ç»Ÿ)
  - [åã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#ååä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: è¿‡åº¦è®¾è®¡å¯¼è‡´å¤æ‚åº¦é«˜](#åä¾‹1-è¿‡åº¦è®¾è®¡å¯¼è‡´å¤æ‚åº¦é«˜)
    - [åä¾‹2: å¿½ç•¥æ¥å£è®¾è®¡å¯¼è‡´è€¦åˆ](#åä¾‹2-å¿½ç•¥æ¥å£è®¾è®¡å¯¼è‡´è€¦åˆ)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡å¯¼å›¾

### 1.1 ä¸‰å±‚æ¶æ„è®¾è®¡ï¼ˆLSEMï¼‰

**å®Œæ•´æ¶æ„å›¾**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    L2: åˆ†å¸ƒå¼å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å…¨å±€æ—¶é—´æˆ³    â”‚  â”‚ å…±è¯†åè®®      â”‚  â”‚ å¤åˆ¶åè°ƒ     â”‚       â”‚
â”‚  â”‚(HLC/TrueTime)â”‚  â”‚ (Raft/Paxos) â”‚  â”‚ (2PC/3PC)    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ æ—¶é—´æˆ³æ˜ å°„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    L1: è¿è¡Œæ—¶å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ äº‹åŠ¡ç®¡ç†      â”‚  â”‚ é”ç®¡ç†        â”‚  â”‚ å†…å­˜ç®¡ç†      â”‚       â”‚
â”‚  â”‚ (BEGIN/COMMIT)â”‚  â”‚ (Lock/Unlock)â”‚  â”‚ (Ownership)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚ äº‹åŠ¡IDæ˜ å°„                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ xmin/xmaxæ˜ å°„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    L0: å­˜å‚¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ MVCCå­˜å‚¨      â”‚  â”‚ WALæ—¥å¿—       â”‚  â”‚ ç´¢å¼•å­˜å‚¨      â”‚      â”‚
â”‚  â”‚ (HeapTuple)  â”‚  â”‚ (XLogRecord)  â”‚  â”‚ (B-tree/Hash)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨¡å—ä¾èµ–å…³ç³»**:

```text
L2å±‚æ¨¡å—:
â”œâ”€ GlobalTimestampService
â”‚   â”œâ”€ ä¾èµ–: ClockSyncService
â”‚   â””â”€ æä¾›: Timestamp
â”‚
â”œâ”€ ConsensusService
â”‚   â”œâ”€ ä¾èµ–: NetworkService
â”‚   â””â”€ æä¾›: ConsensusDecision
â”‚
â””â”€ ReplicationCoordinator
    â”œâ”€ ä¾èµ–: ConsensusService, GlobalTimestampService
    â””â”€ æä¾›: ReplicationStatus

L1å±‚æ¨¡å—:
â”œâ”€ TransactionManager
â”‚   â”œâ”€ ä¾èµ–: GlobalTimestampService (L2)
â”‚   â”œâ”€ ä¾èµ–: LockManager (L1)
â”‚   â””â”€ æä¾›: Transaction
â”‚
â”œâ”€ LockManager
â”‚   â”œâ”€ ä¾èµ–: TransactionManager (L1)
â”‚   â””â”€ æä¾›: Lock
â”‚
â””â”€ MemoryManager
    â”œâ”€ ä¾èµ–: TransactionManager (L1)
    â””â”€ æä¾›: MemoryAllocation

L0å±‚æ¨¡å—:
â”œâ”€ MVCCStorage
â”‚   â”œâ”€ ä¾èµ–: TransactionManager (L1)
â”‚   â””â”€ æä¾›: TupleVersion
â”‚
â”œâ”€ WALManager
â”‚   â”œâ”€ ä¾èµ–: TransactionManager (L1)
â”‚   â””â”€ æä¾›: WALRecord
â”‚
â””â”€ IndexManager
    â”œâ”€ ä¾èµ–: MVCCStorage (L0)
    â””â”€ æä¾›: IndexEntry
```

### 1.2 å¾®æœåŠ¡æ¶æ„è®¾è®¡

**å¾®æœåŠ¡æ¶æ„å›¾**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway                             â”‚
â”‚              (è·¯ç”±ã€è®¤è¯ã€é™æµ)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚è´¦æˆ·æœåŠ¡â”‚  â”‚äº¤æ˜“æœåŠ¡â”‚  â”‚æŸ¥è¯¢æœåŠ¡â”‚
â”‚       â”‚  â”‚       â”‚  â”‚       â”‚
â”‚ â”Œâ”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â” â”‚
â”‚ â”‚DB â”‚ â”‚  â”‚ â”‚DB â”‚ â”‚  â”‚ â”‚DB â”‚ â”‚
â”‚ â””â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚          â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚ æ¶ˆæ¯é˜Ÿåˆ—    â”‚
        â”‚ (Kafka)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡é—´é€šä¿¡**:

```text
åŒæ­¥é€šä¿¡ (REST/gRPC):
â”œâ”€ è´¦æˆ·æœåŠ¡ â†â†’ äº¤æ˜“æœåŠ¡ (è½¬è´¦)
â”œâ”€ æŸ¥è¯¢æœåŠ¡ â†â†’ è´¦æˆ·æœåŠ¡ (ä½™é¢æŸ¥è¯¢)
â””â”€ API Gateway â†’ æ‰€æœ‰æœåŠ¡ (è·¯ç”±)

å¼‚æ­¥é€šä¿¡ (æ¶ˆæ¯é˜Ÿåˆ—):
â”œâ”€ äº¤æ˜“æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ é€šçŸ¥æœåŠ¡ (äº¤æ˜“å®Œæˆ)
â”œâ”€ è´¦æˆ·æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ å®¡è®¡æœåŠ¡ (è´¦æˆ·å˜æ›´)
â””â”€ æŸ¥è¯¢æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ åˆ†ææœåŠ¡ (æŸ¥è¯¢ç»Ÿè®¡)

æ•°æ®ä¸€è‡´æ€§:
â”œâ”€ åˆ†å¸ƒå¼äº‹åŠ¡ (2PC/Saga)
â”œâ”€ æœ€ç»ˆä¸€è‡´æ€§ (äº‹ä»¶æº¯æº)
â””â”€ è¡¥å¿æœºåˆ¶ (TCC)
```

### 1.3 åˆ†å¸ƒå¼æ•°æ®åº“æ¶æ„

**TiDBæ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TiDB Server (SQLå±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ SQL Parser   â”‚  â”‚ Optimizer    â”‚  â”‚ Executor     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ SQL â†’ KV
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TiKV (å­˜å‚¨å±‚)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Raft Group   â”‚  â”‚ MVCC         â”‚  â”‚ Transaction  â”‚     â”‚
â”‚  â”‚ (Region)     â”‚  â”‚ (Percolator) â”‚  â”‚ (2PC)        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PD (Placement Driver)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ å…ƒæ•°æ®ç®¡ç†    â”‚  â”‚ è°ƒåº¦å™¨        â”‚  â”‚ æ—¶é—´æˆ³åˆ†é…    â”‚     â”‚
â”‚  â”‚ (Region Map) â”‚  â”‚ (Balance)    â”‚  â”‚ (TSO)        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ¨¡å—è®¾è®¡å¯¼å›¾

### 2.1 MVCCæ¨¡å—è®¾è®¡

**æ¨¡å—ç»“æ„**:

```text
MVCCæ¨¡å—
â”œâ”€ SnapshotManager
â”‚   â”œâ”€ create_snapshot()
â”‚   â”œâ”€ get_current_snapshot()
â”‚   â””â”€ update_snapshot()
â”‚
â”œâ”€ VisibilityChecker
â”‚   â”œâ”€ is_visible()
â”‚   â”œâ”€ check_xmin()
â”‚   â””â”€ check_xmax()
â”‚
â”œâ”€ VersionManager
â”‚   â”œâ”€ create_version()
â”‚   â”œâ”€ delete_version()
â”‚   â””â”€ get_latest_version()
â”‚
â””â”€ TupleHeaderManager
    â”œâ”€ set_xmin()
    â”œâ”€ set_xmax()
    â””â”€ get_hint_bits()
```

**ç±»å›¾** (PlantUML):

```plantuml
@startuml
class Snapshot {
    - xmin: TransactionId
    - xmax: TransactionId
    - xip: Set<TransactionId>
    + get_xmin(): TransactionId
    + get_xmax(): TransactionId
    + contains(xid: TransactionId): bool
}

class SnapshotManager {
    - current_snapshot: Snapshot
    + create_snapshot(): Snapshot
    + get_current_snapshot(): Snapshot
}

class TupleVersion {
    - xmin: TransactionId
    - xmax: TransactionId
    - data: byte[]
    + get_xmin(): TransactionId
    + get_xmax(): TransactionId
}

class VisibilityChecker {
    + is_visible(tuple: TupleVersion, snapshot: Snapshot): bool
    + check_xmin(xmin: TransactionId, snapshot: Snapshot): bool
    + check_xmax(xmax: TransactionId, snapshot: Snapshot): bool
}

SnapshotManager --> Snapshot : creates
VisibilityChecker --> Snapshot : uses
VisibilityChecker --> TupleVersion : checks
@enduml
```

### 2.2 é”ç®¡ç†æ¨¡å—è®¾è®¡

**æ¨¡å—ç»“æ„**:

```text
LockManageræ¨¡å—
â”œâ”€ LockTable
â”‚   â”œâ”€ acquire_lock()
â”‚   â”œâ”€ release_lock()
â”‚   â””â”€ check_compatibility()
â”‚
â”œâ”€ DeadlockDetector
â”‚   â”œâ”€ build_wait_graph()
â”‚   â”œâ”€ detect_cycle()
â”‚   â””â”€ select_victim()
â”‚
â”œâ”€ FastPathLockManager
â”‚   â”œâ”€ acquire_fast_path()
â”‚   â””â”€ promote_to_slow_path()
â”‚
â””â”€ LockMode
    â”œâ”€ ACCESS_SHARE
    â”œâ”€ ROW_EXCLUSIVE
    â””â”€ ACCESS_EXCLUSIVE
```

**ç±»å›¾**:

```plantuml
@startuml
enum LockMode {
    ACCESS_SHARE
    ROW_SHARE
    ROW_EXCLUSIVE
    SHARE_UPDATE_EXCLUSIVE
    SHARE
    SHARE_ROW_EXCLUSIVE
    EXCLUSIVE
    ACCESS_EXCLUSIVE
}

class LockRequest {
    - transaction_id: int
    - resource_id: str
    - lock_mode: LockMode
    - granted: bool
}

class LockTable {
    - locks: Map<ResourceId, Map<LockMode, Set<TransactionId>>>
    - wait_queue: Map<ResourceId, List<LockRequest>>
    + acquire_lock(tx_id: int, resource: str, mode: LockMode): bool
    + release_lock(tx_id: int, resource: str, mode: LockMode)
    + check_compatibility(mode1: LockMode, mode2: LockMode): bool
}

class DeadlockDetector {
    - wait_graph: Map<TransactionId, Set<TransactionId>>
    + build_wait_graph(lock_table: LockTable)
    + detect_cycle(): Optional<List<TransactionId>>
    + select_victim(cycle: List<TransactionId>): TransactionId
}

LockTable --> LockRequest : contains
DeadlockDetector --> LockTable : uses
@enduml
```

### 2.3 äº‹åŠ¡ç®¡ç†æ¨¡å—è®¾è®¡

**æ¨¡å—ç»“æ„**:

```text
TransactionManageræ¨¡å—
â”œâ”€ Transaction
â”‚   â”œâ”€ begin()
â”‚   â”œâ”€ commit()
â”‚   â”œâ”€ rollback()
â”‚   â””â”€ get_status()
â”‚
â”œâ”€ TransactionState
â”‚   â”œâ”€ ACTIVE
â”‚   â”œâ”€ COMMITTED
â”‚   â””â”€ ABORTED
â”‚
â”œâ”€ WALManager
â”‚   â”œâ”€ write_log()
â”‚   â”œâ”€ flush_log()
â”‚   â””â”€ recover()
â”‚
â””â”€ ClogManager
    â”œâ”€ set_status()
    â”œâ”€ get_status()
    â””â”€ truncate()
```

---

## ä¸‰ã€æ¥å£è®¾è®¡å¯¼å›¾

### 3.1 äº‹åŠ¡æ¥å£è®¾è®¡

**æ¥å£å±‚æ¬¡**:

```text
åº”ç”¨å±‚æ¥å£:
â””â”€ TransactionService
    â”œâ”€ begin_transaction() â†’ Transaction
    â”œâ”€ commit(Transaction)
    â””â”€ rollback(Transaction)

è¿è¡Œæ—¶å±‚æ¥å£:
â””â”€ TransactionManager
    â”œâ”€ create_transaction() â†’ TransactionId
    â”œâ”€ commit_transaction(TransactionId)
    â”œâ”€ abort_transaction(TransactionId)
    â””â”€ get_transaction_status(TransactionId) â†’ Status

å­˜å‚¨å±‚æ¥å£:
â””â”€ StorageEngine
    â”œâ”€ read(TransactionId, Key) â†’ Value
    â”œâ”€ write(TransactionId, Key, Value)
    â””â”€ delete(TransactionId, Key)
```

**æ¥å£å®šä¹‰** (Rust):

```rust
// åº”ç”¨å±‚æ¥å£
pub trait TransactionService {
    fn begin_transaction(&self) -> Result<Transaction, Error>;
    fn commit(&self, tx: Transaction) -> Result<(), Error>;
    fn rollback(&self, tx: Transaction) -> Result<(), Error>;
}

// è¿è¡Œæ—¶å±‚æ¥å£
pub trait TransactionManager {
    fn create_transaction(&self) -> Result<TransactionId, Error>;
    fn commit_transaction(&self, tx_id: TransactionId) -> Result<(), Error>;
    fn abort_transaction(&self, tx_id: TransactionId) -> Result<(), Error>;
    fn get_status(&self, tx_id: TransactionId) -> TransactionStatus;
}

// å­˜å‚¨å±‚æ¥å£
pub trait StorageEngine {
    fn read(&self, tx_id: TransactionId, key: &[u8]) -> Result<Option<Vec<u8>>, Error>;
    fn write(&self, tx_id: TransactionId, key: &[u8], value: &[u8]) -> Result<(), Error>;
    fn delete(&self, tx_id: TransactionId, key: &[u8]) -> Result<(), Error>;
}
```

### 3.2 å­˜å‚¨æ¥å£è®¾è®¡

**å­˜å‚¨æŠ½è±¡å±‚**:

```text
StorageInterface
â”œâ”€ PageManager
â”‚   â”œâ”€ allocate_page() â†’ PageId
â”‚   â”œâ”€ read_page(PageId) â†’ Page
â”‚   â””â”€ write_page(PageId, Page)
â”‚
â”œâ”€ TupleManager
â”‚   â”œâ”€ insert_tuple(PageId, Tuple) â†’ TupleId
â”‚   â”œâ”€ update_tuple(TupleId, Tuple)
â”‚   â””â”€ delete_tuple(TupleId)
â”‚
â””â”€ IndexManager
    â”œâ”€ create_index(IndexDef) â†’ IndexId
    â”œâ”€ insert_entry(IndexId, Key, TupleId)
    â””â”€ search(IndexId, Key) â†’ List<TupleId>
```

### 3.3 æŸ¥è¯¢æ¥å£è®¾è®¡

**æŸ¥è¯¢å¤„ç†æ¥å£**:

```text
QueryProcessor
â”œâ”€ Parser
â”‚   â””â”€ parse(SQL) â†’ AST
â”‚
â”œâ”€ Optimizer
â”‚   â””â”€ optimize(AST) â†’ Plan
â”‚
â”œâ”€ Executor
â”‚   â”œâ”€ execute(Plan) â†’ ResultSet
â”‚   â””â”€ execute_step(PlanNode) â†’ ResultSet
â”‚
â””â”€ ResultSet
    â”œâ”€ next() â†’ Row
    â””â”€ close()
```

---

## å››ã€æ•°æ®æµè®¾è®¡å¯¼å›¾

### 4.1 æŸ¥è¯¢æ•°æ®æµ

**å®Œæ•´æŸ¥è¯¢æµç¨‹**:

```text
å®¢æˆ·ç«¯
  â”‚
  â”‚ SQL: "SELECT * FROM users WHERE id = 1"
  â–¼
Parser (è§£æ)
  â”‚
  â”‚ AST
  â–¼
Optimizer (ä¼˜åŒ–)
  â”‚
  â”‚ Plan: IndexScan(users_pkey, id=1)
  â–¼
Executor (æ‰§è¡Œ)
  â”‚
  â”‚ è°ƒç”¨ IndexManager.search()
  â–¼
IndexManager
  â”‚
  â”‚ è¿”å› TupleId = (page=5, offset=123)
  â–¼
TupleManager
  â”‚
  â”‚ è°ƒç”¨ VisibilityChecker.is_visible()
  â–¼
VisibilityChecker
  â”‚
  â”‚ æ£€æŸ¥ xmin/xmax
  â–¼
SnapshotManager
  â”‚
  â”‚ è·å–å½“å‰å¿«ç…§
  â–¼
è¿”å›ç»“æœ: Row(id=1, name="Alice")
```

### 4.2 å†™å…¥æ•°æ®æµ

**å®Œæ•´å†™å…¥æµç¨‹**:

```text
å®¢æˆ·ç«¯
  â”‚
  â”‚ SQL: "UPDATE users SET name='Bob' WHERE id=1"
  â–¼
Parser
  â”‚
  â”‚ AST
  â–¼
Optimizer
  â”‚
  â”‚ Plan: IndexScan + Update
  â–¼
Executor
  â”‚
  â”‚ 1. è¯»å–æ—§ç‰ˆæœ¬
  â–¼
TupleManager.read()
  â”‚
  â”‚ 2. åˆ›å»ºæ–°ç‰ˆæœ¬
  â–¼
TupleManager.insert_tuple()
  â”‚
  â”‚ 3. è®¾ç½®xmin = current_tx_id
  â”‚ 4. è®¾ç½®æ—§ç‰ˆæœ¬xmax = current_tx_id
  â–¼
WALManager.write_log()
  â”‚
  â”‚ 5. å†™WALè®°å½•
  â–¼
COMMIT
  â”‚
  â”‚ 6. å†™COMMITè®°å½•
  â”‚ 7. fsync WAL
  â”‚ 8. æ›´æ–°pg_clog
  â–¼
å®Œæˆ
```

### 4.3 å¤åˆ¶æ•°æ®æµ

**ä¸»ä»å¤åˆ¶æµç¨‹**:

```text
ä¸»åº“ (Primary)
  â”‚
  â”‚ 1. äº‹åŠ¡æäº¤
  â”‚ 2. å†™WAL
  â–¼
WAL Sender
  â”‚
  â”‚ 3. å‘é€WALè®°å½•
  â–¼
ç½‘ç»œ
  â”‚
  â”‚ WALè®°å½•æµ
  â–¼
ä»åº“ (Standby)
  â”‚
  â”‚ 4. WAL Receiveræ¥æ”¶
  â–¼
WAL Receiver
  â”‚
  â”‚ 5. å†™å…¥WALæ–‡ä»¶
  â–¼
WAL Replay
  â”‚
  â”‚ 6. é‡æ”¾WALè®°å½•
  â”‚ 7. æ›´æ–°æ•°æ®é¡µ
  â–¼
ä»åº“æ•°æ®æ›´æ–°å®Œæˆ
```

---

## äº”ã€ç±»å›¾è®¾è®¡å¯¼å›¾

### 5.1 MVCCæ ¸å¿ƒç±»å›¾

**å®Œæ•´ç±»å…³ç³»**:

```plantuml
@startuml
class Transaction {
    - xid: TransactionId
    - status: TransactionStatus
    - snapshot: Snapshot
    + begin()
    + commit()
    + rollback()
}

class Snapshot {
    - xmin: TransactionId
    - xmax: TransactionId
    - xip: Set<TransactionId>
    + contains(xid: TransactionId): bool
}

class TupleVersion {
    - xmin: TransactionId
    - xmax: TransactionId
    - data: byte[]
    - ctid: TupleId
}

class VisibilityChecker {
    + is_visible(tuple: TupleVersion, snapshot: Snapshot, tx: Transaction): bool
    + check_xmin(xmin: TransactionId, snapshot: Snapshot): bool
    + check_xmax(xmax: TransactionId, snapshot: Snapshot): bool
}

class SnapshotManager {
    - current_snapshot: Snapshot
    + create_snapshot(): Snapshot
    + get_snapshot(): Snapshot
}

Transaction --> Snapshot : has
Transaction --> TupleVersion : reads/writes
VisibilityChecker --> Snapshot : uses
VisibilityChecker --> TupleVersion : checks
SnapshotManager --> Snapshot : creates
@enduml
```

### 5.2 é”ç®¡ç†ç±»å›¾

**å®Œæ•´ç±»å…³ç³»**:

```plantuml
@startuml
class LockManager {
    - lock_table: LockTable
    - deadlock_detector: DeadlockDetector
    + acquire_lock(tx_id: int, resource: str, mode: LockMode): bool
    + release_lock(tx_id: int, resource: str, mode: LockMode)
}

class LockTable {
    - locks: Map<ResourceId, Map<LockMode, Set<TransactionId>>>
    - wait_queue: Map<ResourceId, List<LockRequest>>
    + grant_lock(request: LockRequest): bool
    + release_lock(tx_id: int, resource: str, mode: LockMode)
}

class LockRequest {
    - transaction_id: int
    - resource_id: str
    - lock_mode: LockMode
    - granted: bool
}

class DeadlockDetector {
    - wait_graph: Map<TransactionId, Set<TransactionId>>
    + detect_cycle(): Optional[List<TransactionId>>
    + select_victim(cycle: List<TransactionId>): TransactionId
}

LockManager --> LockTable : uses
LockManager --> DeadlockDetector : uses
LockTable --> LockRequest : contains
DeadlockDetector --> LockTable : analyzes
@enduml
```

### 5.3 äº‹åŠ¡ç®¡ç†ç±»å›¾

**å®Œæ•´ç±»å…³ç³»**:

```plantuml
@startuml
class TransactionManager {
    - active_transactions: Map<TransactionId, Transaction>
    - wal_manager: WALManager
    - clog_manager: ClogManager
    + begin_transaction(): TransactionId
    + commit_transaction(tx_id: TransactionId)
    + abort_transaction(tx_id: TransactionId)
}

class Transaction {
    - xid: TransactionId
    - status: TransactionStatus
    - start_time: Timestamp
    - commit_time: Optional<Timestamp>
}

class WALManager {
    - wal_buffer: byte[]
    - wal_file: File
    + write_log(record: WALRecord)
    + flush()
    + recover()
}

class ClogManager {
    - clog: byte[]
    + set_status(xid: TransactionId, status: CommitStatus)
    + get_status(xid: TransactionId): CommitStatus
}

TransactionManager --> Transaction : manages
TransactionManager --> WALManager : uses
TransactionManager --> ClogManager : uses
@enduml
```

---

## å…­ã€ç»„ä»¶äº¤äº’å¯¼å›¾

### 6.1 äº‹åŠ¡æäº¤äº¤äº’

**åºåˆ—å›¾** (Mermaid):

```mermaid
sequenceDiagram
    participant Client
    participant TM as TransactionManager
    participant WAL as WALManager
    participant CLog as ClogManager
    participant Storage

    Client->>TM: COMMIT
    TM->>WAL: write_log(COMMIT)
    WAL->>WAL: fsync()
    WAL-->>TM: success
    TM->>CLog: set_status(COMMITTED)
    CLog-->>TM: success
    TM->>Storage: release_locks()
    Storage-->>TM: success
    TM-->>Client: COMMITæˆåŠŸ
```

### 6.2 æ­»é”æ£€æµ‹äº¤äº’

**åºåˆ—å›¾**:

```mermaid
sequenceDiagram
    participant T1 as Transaction1
    participant T2 as Transaction2
    participant LM as LockManager
    participant DD as DeadlockDetector

    T1->>LM: acquire_lock(resource_A, EXCLUSIVE)
    LM-->>T1: granted
    T2->>LM: acquire_lock(resource_B, EXCLUSIVE)
    LM-->>T2: granted

    T1->>LM: acquire_lock(resource_B, EXCLUSIVE)
    LM->>DD: check_deadlock()
    DD->>DD: build_wait_graph()
    DD->>DD: detect_cycle()
    DD-->>LM: cycle detected: [T1, T2]
    LM->>DD: select_victim()
    DD-->>LM: T2
    LM->>T2: abort()
    LM-->>T1: granted
```

### 6.3 æ•…éšœæ¢å¤äº¤äº’

**åºåˆ—å›¾**:

```mermaid
sequenceDiagram
    participant System
    participant WAL as WALManager
    participant CLog as ClogManager
    participant Storage

    System->>System: ç³»ç»Ÿå¯åŠ¨
    System->>WAL: recover()
    WAL->>WAL: scan_wal_records()
    WAL->>CLog: get_status(xid)
    CLog-->>WAL: IN_PROGRESS
    WAL->>Storage: redo(record)
    Storage-->>WAL: success
    WAL->>CLog: get_status(xid)
    CLog-->>WAL: COMMITTED
    WAL->>Storage: apply(record)
    Storage-->>WAL: success
    WAL-->>System: recovery complete
```

---

## ä¸ƒã€è®¾è®¡æ¨¡å¼åº”ç”¨å¯¼å›¾

### 7.1 è®¾è®¡æ¨¡å¼åœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨

**æ¨¡å¼åˆ†ç±»**:

```text
åˆ›å»ºå‹æ¨¡å¼:
â”œâ”€ å•ä¾‹æ¨¡å¼ (Singleton)
â”‚   â””â”€ åº”ç”¨: SnapshotManager, GlobalTimestampService
â”‚
â”œâ”€ å·¥å‚æ¨¡å¼ (Factory)
â”‚   â””â”€ åº”ç”¨: TransactionFactory, IndexFactory
â”‚
â””â”€ å»ºé€ è€…æ¨¡å¼ (Builder)
    â””â”€ åº”ç”¨: QueryPlanBuilder, TransactionBuilder

ç»“æ„å‹æ¨¡å¼:
â”œâ”€ é€‚é…å™¨æ¨¡å¼ (Adapter)
â”‚   â””â”€ åº”ç”¨: StorageAdapter (ç»Ÿä¸€ä¸åŒå­˜å‚¨å¼•æ“æ¥å£)
â”‚
â”œâ”€ è£…é¥°å™¨æ¨¡å¼ (Decorator)
â”‚   â””â”€ åº”ç”¨: CachedStorage (ç¼“å­˜è£…é¥°å­˜å‚¨å±‚)
â”‚
â””â”€ å¤–è§‚æ¨¡å¼ (Facade)
    â””â”€ åº”ç”¨: DatabaseFacade (ç»Ÿä¸€æ•°æ®åº“æ¥å£)

è¡Œä¸ºå‹æ¨¡å¼:
â”œâ”€ è§‚å¯Ÿè€…æ¨¡å¼ (Observer)
â”‚   â””â”€ åº”ç”¨: WALListener (ç›‘å¬WALå˜åŒ–)
â”‚
â”œâ”€ ç­–ç•¥æ¨¡å¼ (Strategy)
â”‚   â””â”€ åº”ç”¨: IsolationLevelStrategy (ä¸åŒéš”ç¦»çº§åˆ«ç­–ç•¥)
â”‚
â”œâ”€ çŠ¶æ€æ¨¡å¼ (State)
â”‚   â””â”€ åº”ç”¨: TransactionState (äº‹åŠ¡çŠ¶æ€è½¬æ¢)
â”‚
â””â”€ æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method)
    â””â”€ åº”ç”¨: QueryExecutor (æŸ¥è¯¢æ‰§è¡Œæ¨¡æ¿)
```

### 7.2 å¹¶å‘è®¾è®¡æ¨¡å¼

**å¹¶å‘æ¨¡å¼åº”ç”¨**:

```text
é”æ¨¡å¼:
â”œâ”€ è¯»å†™é” (ReadWriteLock)
â”‚   â””â”€ åº”ç”¨: è¡¨çº§é” (ShareLock/ExclusiveLock)
â”‚
â”œâ”€ è‡ªæ—‹é” (SpinLock)
â”‚   â””â”€ åº”ç”¨: å¿«é€Ÿè·¯å¾„é” (FastPathLock)
â”‚
â””â”€ æ¡ä»¶å˜é‡ (Condition)
    â””â”€ åº”ç”¨: é”ç­‰å¾…é˜Ÿåˆ—

æ— é”æ¨¡å¼:
â”œâ”€ CASæ“ä½œ (Compare-And-Swap)
â”‚   â””â”€ åº”ç”¨: åŸå­è®¡æ•°å™¨ã€ç‰ˆæœ¬å·æ›´æ–°
â”‚
â”œâ”€ æ— é”é˜Ÿåˆ— (Lock-Free Queue)
â”‚   â””â”€ åº”ç”¨: WALç¼“å†²åŒºã€ä»»åŠ¡é˜Ÿåˆ—
â”‚
â””â”€ å†…å­˜å±éšœ (Memory Barrier)
    â””â”€ åº”ç”¨: å¯è§æ€§ä¿è¯ã€é¡ºåºä¿è¯

å¹¶å‘æ§åˆ¶æ¨¡å¼:
â”œâ”€ ä¹è§‚å¹¶å‘æ§åˆ¶ (OCC)
â”‚   â””â”€ åº”ç”¨: MVCCå¯è§æ€§æ£€æŸ¥
â”‚
â”œâ”€ æ‚²è§‚å¹¶å‘æ§åˆ¶ (PCC)
â”‚   â””â”€ åº”ç”¨: 2PLé”æœºåˆ¶
â”‚
â””â”€ æ··åˆæ¨¡å¼ (Hybrid)
    â””â”€ åº”ç”¨: PostgreSQL (MVCC + 2PL)
```

---

## å…«ã€å®Œæ•´è®¾è®¡å·¥å…·å®ç°

### 8.1 PlantUMLä»£ç ç”Ÿæˆå™¨

**å®Œæ•´å®ç°**: è‡ªåŠ¨ç”ŸæˆPlantUMLç±»å›¾ä»£ç 

```python
from dataclasses import dataclass
from typing import List, Dict, Optional

@dataclass
class UMLClass:
    """UMLç±»"""
    name: str
    attributes: List[str]
    methods: List[str]
    visibility: str = "public"  # public, private, protected

@dataclass
class UMLRelationship:
    """UMLå…³ç³»"""
    from_class: str
    to_class: str
    type: str  # "-->", "<|--", "*--", "o--"
    label: Optional[str] = None

class PlantUMLGenerator:
    """PlantUMLä»£ç ç”Ÿæˆå™¨"""

    def __init__(self):
        self.classes: Dict[str, UMLClass] = {}
        self.relationships: List[UMLRelationship] = []

    def add_class(self, uml_class: UMLClass):
        """æ·»åŠ ç±»"""
        self.classes[uml_class.name] = uml_class

    def add_relationship(self, relationship: UMLRelationship):
        """æ·»åŠ å…³ç³»"""
        self.relationships.append(relationship)

    def generate(self) -> str:
        """ç”ŸæˆPlantUMLä»£ç """
        lines = ["@startuml", ""]

        # ç”Ÿæˆç±»å®šä¹‰
        for class_name, uml_class in self.classes.items():
            lines.append(f"class {class_name} {{")

            # æ·»åŠ å±æ€§
            for attr in uml_class.attributes:
                visibility_symbol = self._get_visibility_symbol(uml_class.visibility)
                lines.append(f"  {visibility_symbol} {attr}")

            # æ·»åŠ æ–¹æ³•
            for method in uml_class.methods:
                visibility_symbol = self._get_visibility_symbol(uml_class.visibility)
                lines.append(f"  {visibility_symbol} {method}()")

            lines.append("}")
            lines.append("")

        # ç”Ÿæˆå…³ç³»
        for rel in self.relationships:
            if rel.label:
                lines.append(f"{rel.from_class} {rel.type} {rel.to_class} : {rel.label}")
            else:
                lines.append(f"{rel.from_class} {rel.type} {rel.to_class}")

        lines.append("")
        lines.append("@enduml")

        return "\n".join(lines)

    def _get_visibility_symbol(self, visibility: str) -> str:
        """è·å–å¯è§æ€§ç¬¦å·"""
        symbols = {
            "public": "+",
            "private": "-",
            "protected": "#"
        }
        return symbols.get(visibility, "+")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    generator = PlantUMLGenerator()

    # æ·»åŠ ç±»
    generator.add_class(UMLClass(
        name="Transaction",
        attributes=["- xid: TransactionId", "- status: TransactionStatus"],
        methods=["+ begin()", "+ commit()", "+ rollback()"]
    ))

    generator.add_class(UMLClass(
        name="TransactionManager",
        attributes=["- transactions: Map<TransactionId, Transaction>"],
        methods=["+ create_transaction()", "+ commit_transaction()"]
    ))

    # æ·»åŠ å…³ç³»
    generator.add_relationship(UMLRelationship(
        from_class="TransactionManager",
        to_class="Transaction",
        type="-->",
        label="manages"
    ))

    # ç”Ÿæˆä»£ç 
    plantuml_code = generator.generate()
    print(plantuml_code)
```

### 8.2 æ¶æ„å›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·

**å®Œæ•´å®ç°**: ä»ä»£ç è‡ªåŠ¨ç”Ÿæˆæ¶æ„å›¾

```python
import ast
from typing import List, Dict
from dataclasses import dataclass

@dataclass
class Module:
    """æ¨¡å—"""
    name: str
    dependencies: List[str]
    exports: List[str]

class ArchitectureAnalyzer:
    """æ¶æ„åˆ†æå™¨"""

    def __init__(self):
        self.modules: Dict[str, Module] = {}

    def analyze_file(self, filepath: str):
        """åˆ†æPythonæ–‡ä»¶"""
        with open(filepath, 'r', encoding='utf-8') as f:
            tree = ast.parse(f.read())

        module_name = filepath.replace('.py', '').replace('/', '.')
        dependencies = []
        exports = []

        for node in ast.walk(tree):
            # æå–importè¯­å¥
            if isinstance(node, ast.Import):
                for alias in node.names:
                    dependencies.append(alias.name)
            elif isinstance(node, ast.ImportFrom):
                if node.module:
                    dependencies.append(node.module)

            # æå–ç±»å®šä¹‰
            if isinstance(node, ast.ClassDef):
                exports.append(node.name)

        self.modules[module_name] = Module(
            name=module_name,
            dependencies=dependencies,
            exports=exports
        )

    def generate_architecture_diagram(self) -> str:
        """ç”Ÿæˆæ¶æ„å›¾"""
        lines = ["graph TD"]

        # ç”ŸæˆèŠ‚ç‚¹
        for module_name in self.modules:
            node_id = module_name.replace('.', '_')
            lines.append(f"    {node_id}[\"{module_name}\"]")

        # ç”Ÿæˆä¾èµ–å…³ç³»
        for module_name, module in self.modules.items():
            from_id = module_name.replace('.', '_')
            for dep in module.dependencies:
                if dep in self.modules:
                    to_id = dep.replace('.', '_')
                    lines.append(f"    {from_id} --> {to_id}")

        return "\n".join(lines)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    analyzer = ArchitectureAnalyzer()

    # åˆ†ææ–‡ä»¶
    analyzer.analyze_file("transaction_manager.py")
    analyzer.analyze_file("lock_manager.py")
    analyzer.analyze_file("storage_engine.py")

    # ç”Ÿæˆæ¶æ„å›¾
    diagram = analyzer.generate_architecture_diagram()
    print(diagram)
```

---

## ä¹ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹: æ–°ç³»ç»Ÿæ¶æ„è®¾è®¡

**åœºæ™¯**: è®¾è®¡æ–°çš„åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ

**è®¾è®¡è¿‡ç¨‹**:

1. **éœ€æ±‚åˆ†æ**:
   - æ”¯æŒSQLæŸ¥è¯¢
   - åˆ†å¸ƒå¼äº‹åŠ¡
   - é«˜å¯ç”¨æ€§

2. **æ¶æ„è®¾è®¡** (ä½¿ç”¨è®¾è®¡å¯¼å›¾):

    ```text
    ç³»ç»Ÿæ¶æ„:
    â”œâ”€ SQLå±‚ (TiDB Server)
    â”‚   â”œâ”€ Parser
    â”‚   â”œâ”€ Optimizer
    â”‚   â””â”€ Executor
    â”‚
    â”œâ”€ å­˜å‚¨å±‚ (TiKV)
    â”‚   â”œâ”€ Raft Group
    â”‚   â”œâ”€ MVCC
    â”‚   â””â”€ Transaction
    â”‚
    â””â”€ åè°ƒå±‚ (PD)
        â”œâ”€ å…ƒæ•°æ®ç®¡ç†
        â”œâ”€ è°ƒåº¦å™¨
        â””â”€ æ—¶é—´æˆ³åˆ†é…
    ```

3. **æ¨¡å—è®¾è®¡**:
   - ä½¿ç”¨ç±»å›¾è®¾è®¡å„æ¨¡å—æ¥å£
   - ä½¿ç”¨åºåˆ—å›¾è®¾è®¡äº¤äº’æµç¨‹
   - ä½¿ç”¨æ•°æ®æµå›¾è®¾è®¡æ•°æ®æµè½¬

**æ•ˆæœ**: æ¶æ„æ¸…æ™°ï¼Œæ¨¡å—èŒè´£æ˜ç¡®ï¼Œå¼€å‘æ•ˆç‡æå‡50%

### 9.2 æ¡ˆä¾‹: é‡æ„ç°æœ‰ç³»ç»Ÿ

**åœºæ™¯**: é‡æ„å•æœºæ•°æ®åº“ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿ

**é‡æ„è¿‡ç¨‹**:

1. **ç°çŠ¶åˆ†æ** (ä½¿ç”¨æ¶æ„å›¾):
   - è¯†åˆ«å•æœºç“¶é¢ˆ
   - è¯†åˆ«å¯æ‹†åˆ†æ¨¡å—

2. **ç›®æ ‡æ¶æ„** (ä½¿ç”¨è®¾è®¡å¯¼å›¾):
   - è®¾è®¡åˆ†å¸ƒå¼æ¶æ„
   - è®¾è®¡æ•°æ®åˆ†ç‰‡ç­–ç•¥
   - è®¾è®¡ä¸€è‡´æ€§åè®®

3. **è¿ç§»æ–¹æ¡ˆ**:
   - ä½¿ç”¨æµç¨‹å›¾è®¾è®¡è¿ç§»æ­¥éª¤
   - ä½¿ç”¨åºåˆ—å›¾è®¾è®¡æ•°æ®åŒæ­¥

**æ•ˆæœ**: ç³»ç»Ÿæ€§èƒ½æå‡10å€ï¼Œå¯ç”¨æ€§ä»99.9%æå‡åˆ°99.99%

---

## åã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: è¿‡åº¦è®¾è®¡å¯¼è‡´å¤æ‚åº¦é«˜

**é”™è¯¯è®¾è®¡**:

```text
ç³»ç»Ÿè®¾è®¡:
â”œâ”€ æŠ½è±¡å±‚1
â”‚   â”œâ”€ æŠ½è±¡å±‚2
â”‚   â”‚   â”œâ”€ æŠ½è±¡å±‚3
â”‚   â”‚   â”‚   â””â”€ å®é™…å®ç°
â”‚   â”‚   â””â”€ é€‚é…å™¨1
â”‚   â””â”€ é€‚é…å™¨2
â””â”€ å¤–è§‚å±‚
```

**é—®é¢˜**: å±‚æ¬¡è¿‡å¤šï¼Œéš¾ä»¥ç†è§£å’Œç»´æŠ¤

**æ­£ç¡®è®¾è®¡**:

```text
ç³»ç»Ÿè®¾è®¡:
â”œâ”€ æ¥å£å±‚ (æ¸…æ™°å®šä¹‰)
â””â”€ å®ç°å±‚ (ç›´æ¥å®ç°)
```

**åŸåˆ™**: KISSåŸåˆ™ï¼Œé¿å…è¿‡åº¦æŠ½è±¡

### åä¾‹2: å¿½ç•¥æ¥å£è®¾è®¡å¯¼è‡´è€¦åˆ

**é”™è¯¯è®¾è®¡**:

```text
æ¨¡å—Aç›´æ¥è°ƒç”¨æ¨¡å—Bçš„å†…éƒ¨å®ç°
  â”‚
  â”œâ”€ æ¨¡å—A â†’ æ¨¡å—B.private_method()
  â””â”€ æ¨¡å—A â†’ æ¨¡å—B.internal_data
```

**é—®é¢˜**: é«˜è€¦åˆï¼Œéš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤

**æ­£ç¡®è®¾è®¡**:

```text
æ¨¡å—Aé€šè¿‡æ¥å£è°ƒç”¨æ¨¡å—B
  â”‚
  â”œâ”€ æ¨¡å—A â†’ Interface â†’ æ¨¡å—B
  â””â”€ æ¥å£å®šä¹‰æ¸…æ™°ï¼Œå®ç°å¯æ›¿æ¢
```

**åŸåˆ™**: ä¾èµ–å€’ç½®ï¼Œé¢å‘æ¥å£ç¼–ç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå®Œæ•´ç‰ˆï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: ç³»ç»Ÿæ¶æ„è®¾è®¡ã€æ¨¡å—è®¾è®¡ã€æ¥å£è®¾è®¡ã€æ•°æ®æµè®¾è®¡ã€ç±»å›¾è®¾è®¡ã€ç»„ä»¶äº¤äº’ã€è®¾è®¡æ¨¡å¼åº”ç”¨ã€å®Œæ•´è®¾è®¡å·¥å…·å®ç°ã€å®é™…åº”ç”¨æ¡ˆä¾‹ã€åä¾‹åˆ†æ

**å·¥å…·ä»£ç **: PlantUMLç”Ÿæˆå™¨ + æ¶æ„åˆ†æå™¨
**GitHub**: <https://github.com/db-theory/design-diagrams>

**å…³è”æ–‡æ¡£**:

- `07-å¯è§†åŒ–ä¸æ€ç»´æ¨¡å‹/01-æ ¸å¿ƒæ€ç»´å¯¼å›¾é›†.md` (æ€ç»´å¯¼å›¾)
- `07-å¯è§†åŒ–ä¸æ€ç»´æ¨¡å‹/03-å†³ç­–æ ‘å›¾é›†.md` (å†³ç­–æ ‘)
- `07-å¯è§†åŒ–ä¸æ€ç»´æ¨¡å‹/04-æµç¨‹å›¾é›†.md` (æµç¨‹å›¾)
- `05-å®ç°æœºåˆ¶/` (å®ç°ç»†èŠ‚)
