# é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+, Apache AGE 1.0+
> **æ–‡æ¡£ç¼–å·**: 08-02-02

## ğŸ“‘ ç›®å½•

- [é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹](#é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ä¸šåŠ¡åœºæ™¯](#2-ä¸šåŠ¡åœºæ™¯)
    - [2.1 åæ¬ºè¯ˆåœºæ™¯](#21-åæ¬ºè¯ˆåœºæ™¯)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 å›¾æ•°æ®æ¨¡å‹](#31-å›¾æ•°æ®æ¨¡å‹)
    - [3.2 å…³ç³»è¡¨è®¾è®¡](#32-å…³ç³»è¡¨è®¾è®¡)
  - [4. å›¾å‘é‡è”åˆæŸ¥è¯¢](#4-å›¾å‘é‡è”åˆæŸ¥è¯¢)
    - [4.1 åŸºäºå›¾çš„è´¦æˆ·å‘ç°](#41-åŸºäºå›¾çš„è´¦æˆ·å‘ç°)
    - [4.2 åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°](#42-åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°)
    - [4.3 å›¾å‘é‡è”åˆæŸ¥è¯¢](#43-å›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 å›¾æŸ¥è¯¢ä¼˜åŒ–](#51-å›¾æŸ¥è¯¢ä¼˜åŒ–)
    - [5.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–](#52-å‘é‡æŸ¥è¯¢ä¼˜åŒ–)
  - [6. å®è·µæ•ˆæœ](#6-å®è·µæ•ˆæœ)
    - [6.1 æ€§èƒ½æŒ‡æ ‡](#61-æ€§èƒ½æŒ‡æ ‡)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

é‡‘èåæ¬ºè¯ˆåœºæ™¯éœ€è¦ï¼š

- **å…³ç³»åˆ†æ**: åˆ†æè´¦æˆ·ä¹‹é—´çš„å…³è”å…³ç³»
- **è¯­ä¹‰ç†è§£**: ç†è§£äº¤æ˜“è¡Œä¸ºçš„è¯­ä¹‰
- **å®æ—¶æŸ¥è¯¢**: æ¯«ç§’çº§å“åº”æ—¶é—´
- **é«˜ç²¾åº¦**: é™ä½è¯¯æŠ¥ç‡

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å›¾æ•°æ®åº“**: Apache AGEï¼ˆPostgreSQL å›¾æ‰©å±•ï¼‰
- **å‘é‡æœç´¢**: pgvector å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
- **è”åˆæŸ¥è¯¢**: å›¾æŸ¥è¯¢ + å‘é‡æœç´¢èåˆ

### 1.2 æ ¸å¿ƒä»·å€¼

- **å¬å›ç‡æå‡**: å®é™…æ¡ˆä¾‹æ˜¾ç¤ºå¬å›ç‡æå‡ 19%
- **è¯¯æŠ¥ç‡é™ä½**: è¯¯æŠ¥ç‡é™ä½ 35%
- **æŸ¥è¯¢æ€§èƒ½**: P99 å»¶è¿Ÿ < 100ms

## 2. ä¸šåŠ¡åœºæ™¯

### 2.1 åæ¬ºè¯ˆåœºæ™¯

**åœºæ™¯æè¿°**:

- **è´¦æˆ·å…³ç³»ç½‘ç»œ**: åˆ†æè´¦æˆ·ä¹‹é—´çš„è½¬è´¦å…³ç³»
- **å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**: è¯†åˆ«å¼‚å¸¸äº¤æ˜“æ¨¡å¼
- **å›¢ä¼™è¯†åˆ«**: è¯†åˆ«æ¬ºè¯ˆå›¢ä¼™

**æŸ¥è¯¢éœ€æ±‚**:

- æŸ¥æ‰¾ä¸å¯ç–‘è´¦æˆ·ç›¸å…³çš„è´¦æˆ·
- æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“æ¨¡å¼
- æŸ¥æ‰¾å¼‚å¸¸è¡Œä¸ºæ¨¡å¼

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å›¾æ•°æ®æ¨¡å‹

```sql
-- å¯ç”¨ Apache AGE
CREATE EXTENSION IF NOT EXISTS age;

-- åˆ›å»ºå›¾
SELECT create_graph('fraud_detection');

-- è´¦æˆ·èŠ‚ç‚¹
SELECT * FROM cypher('fraud_detection', $$
    CREATE (a:Account {
        id: 'acc_001',
        name: 'Account 1',
        embedding: [0.1, 0.2, 0.3, ...]::vector(1536),
        risk_score: 0.3
    })
$$) AS (a agtype);

-- äº¤æ˜“å…³ç³»
SELECT * FROM cypher('fraud_detection', $$
    MATCH (a:Account {id: 'acc_001'}), (b:Account {id: 'acc_002'})
    CREATE (a)-[t:TRANSFER {
        amount: 10000,
        timestamp: '2024-01-01',
        embedding: [0.2, 0.3, 0.4, ...]::vector(1536)
    }]->(b)
$$) AS (t agtype);
```

### 3.2 å…³ç³»è¡¨è®¾è®¡

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    id TEXT PRIMARY KEY,
    name TEXT,
    embedding vector(1536),
    risk_score FLOAT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    from_account TEXT REFERENCES accounts(id),
    to_account TEXT REFERENCES accounts(id),
    amount DECIMAL(10, 2),
    embedding vector(1536),
    timestamp TIMESTAMPTZ,
    risk_score FLOAT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON accounts USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON transactions (from_account, timestamp);
CREATE INDEX ON transactions (to_account, timestamp);
```

## 4. å›¾å‘é‡è”åˆæŸ¥è¯¢

### 4.1 åŸºäºå›¾çš„è´¦æˆ·å‘ç°

```sql
-- æŸ¥æ‰¾å¯ç–‘è´¦æˆ·çš„å…³è”è´¦æˆ·ï¼ˆå›¾æŸ¥è¯¢ï¼‰
SELECT * FROM cypher('fraud_detection', $$
    MATCH (suspicious:Account {id: 'acc_001'})-[t:TRANSFER*1..3]-(related:Account)
    WHERE suspicious.risk_score > 0.7
    RETURN DISTINCT related.id, related.name, related.risk_score
    LIMIT 50
$$) AS (account_id agtype, account_name agtype, risk_score agtype);
```

### 4.2 åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°

```sql
-- æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“æ¨¡å¼ï¼ˆå‘é‡æœç´¢ï¼‰
WITH suspicious_transaction AS (
    SELECT embedding FROM transactions WHERE id = 12345
)
SELECT
    t.id,
    t.from_account,
    t.to_account,
    t.amount,
    1 - (t.embedding <=> st.embedding) AS similarity
FROM transactions t, suspicious_transaction st
WHERE 1 - (t.embedding <=> st.embedding) > 0.8
ORDER BY t.embedding <=> st.embedding
LIMIT 20;
```

### 4.3 å›¾å‘é‡è”åˆæŸ¥è¯¢

```python
# å›¾å‘é‡è”åˆæŸ¥è¯¢å®ç°
class GraphVectorHybridQuery:
    async def find_fraud_patterns(self, suspicious_account_id, query_vector):
        """å›¾å‘é‡è”åˆæŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¬ºè¯ˆæ¨¡å¼"""
        # 1. å›¾æŸ¥è¯¢ï¼šæŸ¥æ‰¾å…³è”è´¦æˆ·
        related_accounts = await self.db.fetch("""
            SELECT * FROM cypher('fraud_detection', $$
                MATCH (suspicious:Account {id: $1})-[t:TRANSFER*1..3]-(related:Account)
                RETURN DISTINCT related.id AS account_id, related.risk_score
                LIMIT 50
            $$) AS (account_id agtype, risk_score agtype)
        """, suspicious_account_id)

        account_ids = [acc['account_id'] for acc in related_accounts]

        # 2. å‘é‡æœç´¢ï¼šæŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“
        similar_transactions = await self.db.fetch("""
            SELECT
                t.id,
                t.from_account,
                t.to_account,
                t.amount,
                1 - (t.embedding <=> $1::vector) AS similarity
            FROM transactions t
            WHERE (t.from_account = ANY($2::text[]) OR t.to_account = ANY($2::text[]))
            AND 1 - (t.embedding <=> $1::vector) > 0.7
            ORDER BY t.embedding <=> $1::vector
            LIMIT 20
        """, query_vector, account_ids)

        # 3. èåˆç»“æœ
        return {
            'related_accounts': related_accounts,
            'similar_transactions': similar_transactions
        }
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ›å»ºå›¾ç´¢å¼•
SELECT * FROM cypher('fraud_detection', $$
    CREATE INDEX ON :Account(id)
$$) AS (result agtype);

-- ä¼˜åŒ–å›¾æŸ¥è¯¢ï¼ˆé™åˆ¶æ·±åº¦ï¼‰
SELECT * FROM cypher('fraud_detection', $$
    MATCH (suspicious:Account {id: $1})-[t:TRANSFER*1..2]-(related:Account)
    WHERE suspicious.risk_score > 0.7
    RETURN DISTINCT related.id, related.risk_score
    LIMIT 50
$$) AS (account_id agtype, risk_score agtype);
```

### 5.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨ HNSW ç´¢å¼•ä¼˜åŒ–å‘é‡æŸ¥è¯¢
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ä¼˜åŒ–æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- æé«˜å¬å›ç‡
```

## 6. å®è·µæ•ˆæœ

### 6.1 æ€§èƒ½æŒ‡æ ‡

**æŸ¥è¯¢æ€§èƒ½**:

- **å›¾æŸ¥è¯¢**: P99 å»¶è¿Ÿ 45ms
- **å‘é‡æŸ¥è¯¢**: P99 å»¶è¿Ÿ 38ms
- **è”åˆæŸ¥è¯¢**: P99 å»¶è¿Ÿ 82ms

**ä¸šåŠ¡æŒ‡æ ‡**:

- **å¬å›ç‡**: ä» 78% æå‡è‡³ 97%ï¼ˆ+19%ï¼‰
- **è¯¯æŠ¥ç‡**: ä» 12% é™ä½è‡³ 7.8%ï¼ˆ-35%ï¼‰
- **æŸ¥è¯¢é€Ÿåº¦**: æå‡ 3.5 å€

## 7. å‚è€ƒèµ„æ–™

- [å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ](./å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ.md)
- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../../04-å¤šæ¨¡ä¸€ä½“åŒ–/æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-02-02
