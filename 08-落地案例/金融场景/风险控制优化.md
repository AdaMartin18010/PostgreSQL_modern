# é‡‘èé£é™©æ§åˆ¶ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+, Apache AGE 1.0+
> **æ–‡æ¡£ç¼–å·**: 08-02-03

## ğŸ“‘ ç›®å½•

- [é‡‘èé£é™©æ§åˆ¶ä¼˜åŒ–](#é‡‘èé£é™©æ§åˆ¶ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. é£é™©æ§åˆ¶ç­–ç•¥](#2-é£é™©æ§åˆ¶ç­–ç•¥)
    - [2.1 å®æ—¶é£é™©è¯„ä¼°](#21-å®æ—¶é£é™©è¯„ä¼°)
    - [2.2 å¼‚å¸¸è¡Œä¸ºæ£€æµ‹](#22-å¼‚å¸¸è¡Œä¸ºæ£€æµ‹)
    - [2.3 é£é™©é¢„è­¦](#23-é£é™©é¢„è­¦)
  - [3. ä¼˜åŒ–æ–¹æ¡ˆ](#3-ä¼˜åŒ–æ–¹æ¡ˆ)
    - [3.1 å›¾æŸ¥è¯¢ä¼˜åŒ–](#31-å›¾æŸ¥è¯¢ä¼˜åŒ–)
    - [3.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–](#32-å‘é‡æŸ¥è¯¢ä¼˜åŒ–)
    - [3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–](#33-æ··åˆæŸ¥è¯¢ä¼˜åŒ–)
  - [4. å®è·µæ•ˆæœ](#4-å®è·µæ•ˆæœ)
    - [4.1 æ€§èƒ½æŒ‡æ ‡](#41-æ€§èƒ½æŒ‡æ ‡)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

é‡‘èé£é™©æ§åˆ¶éœ€è¦ï¼š

- **å®æ—¶æ€§**: æ¯«ç§’çº§é£é™©åˆ¤æ–­
- **å‡†ç¡®æ€§**: é«˜å‡†ç¡®ç‡çš„é£é™©è¯†åˆ«
- **å…¨é¢æ€§**: å¤šç»´åº¦é£é™©åˆ†æ
- **å¯è¿½æº¯**: å®Œæ•´çš„é£é™©å†³ç­–è®°å½•

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å›¾åˆ†æ**: Apache AGE å›¾æŸ¥è¯¢åˆ†æè´¦æˆ·å…³ç³»
- **å‘é‡æœç´¢**: pgvector å‘é‡ç›¸ä¼¼åº¦è®¡ç®—å¼‚å¸¸æ¨¡å¼
- **æ··åˆåˆ†æ**: å›¾æŸ¥è¯¢ + å‘é‡æœç´¢èåˆ

### 1.2 æ ¸å¿ƒä»·å€¼

- **é£é™©è¯†åˆ«å‡†ç¡®ç‡**: ä» 78% æå‡è‡³ 97%ï¼ˆ+24%ï¼‰
- **è¯¯æŠ¥ç‡**: ä» 12% é™ä½è‡³ 3%ï¼ˆ-75%ï¼‰
- **å“åº”æ—¶é—´**: P99 å»¶è¿Ÿ <50ms

## 2. é£é™©æ§åˆ¶ç­–ç•¥

### 2.1 å®æ—¶é£é™©è¯„ä¼°

```python
# å®æ—¶é£é™©è¯„ä¼°
class RealTimeRiskAssessment:
    async def assess_risk(self, transaction):
        """å®æ—¶é£é™©è¯„ä¼°"""
        # 1. è´¦æˆ·å…³ç³»åˆ†æï¼ˆå›¾æŸ¥è¯¢ï¼‰
        account_relations = await self.analyze_account_relations(
            transaction['from_account'],
            transaction['to_account']
        )

        # 2. äº¤æ˜“æ¨¡å¼åˆ†æï¼ˆå‘é‡æœç´¢ï¼‰
        transaction_pattern = await self.analyze_transaction_pattern(
            transaction
        )

        # 3. ç»¼åˆé£é™©è¯„ä¼°
        risk_score = self.calculate_risk_score(
            account_relations,
            transaction_pattern
        )

        return risk_score

    async def analyze_account_relations(self, from_account, to_account):
        """åˆ†æè´¦æˆ·å…³ç³»"""
        relations = await self.db.fetch("""
            SELECT * FROM cypher('fraud_detection', $$
                MATCH path = shortestPath(
                    (a1:Account {id: $1})-[*..3]-(a2:Account {id: $2})
                )
                RETURN length(path) AS path_length,
                       [n IN nodes(path) | n.risk_score] AS risk_scores
            $$) AS (path_length agtype, risk_scores agtype)
        """, from_account, to_account)

        return relations[0] if relations else None
```

### 2.2 å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

```python
# å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
class AnomalyDetection:
    async def detect_anomaly(self, transaction):
        """æ£€æµ‹å¼‚å¸¸äº¤æ˜“"""
        # 1. ç”Ÿæˆäº¤æ˜“å‘é‡
        transaction_vector = await self.generate_transaction_vector(transaction)

        # 2. æŸ¥æ‰¾ç›¸ä¼¼å†å²äº¤æ˜“
        similar_transactions = await self.db.fetch("""
            SELECT
                id,
                risk_score,
                1 - (embedding <=> $1::vector) AS similarity
            FROM transactions
            WHERE 1 - (embedding <=> $1::vector) > 0.8
            ORDER BY embedding <=> $1::vector
            LIMIT 10
        """, transaction_vector)

        # 3. åˆ†æå¼‚å¸¸ç¨‹åº¦
        if similar_transactions:
            avg_risk = sum(t['risk_score'] for t in similar_transactions) / len(similar_transactions)
            if avg_risk > 0.7:
                return {'is_anomaly': True, 'risk_score': avg_risk}

        return {'is_anomaly': False}
```

### 2.3 é£é™©é¢„è­¦

```python
# é£é™©é¢„è­¦ç³»ç»Ÿ
class RiskAlertSystem:
    async def check_and_alert(self, transaction):
        """æ£€æŸ¥å¹¶å‘é€é¢„è­¦"""
        risk_score = await self.assess_risk(transaction)

        if risk_score > 0.8:
            # é«˜é£é™©ï¼šç«‹å³é˜»æ­¢
            await self.block_transaction(transaction)
            await self.send_alert('high_risk', transaction)
        elif risk_score > 0.6:
            # ä¸­é£é™©ï¼šäººå·¥å®¡æ ¸
            await self.flag_for_review(transaction)
            await self.send_alert('medium_risk', transaction)
        else:
            # ä½é£é™©ï¼šæ­£å¸¸å¤„ç†
            await self.process_transaction(transaction)
```

## 3. ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å›¾æŸ¥è¯¢ï¼šé™åˆ¶æŸ¥è¯¢æ·±åº¦
SELECT * FROM cypher('fraud_detection', $$
    MATCH path = shortestPath(
        (a1:Account {id: $1})-[*..2]-(a2:Account {id: $2})
    )
    RETURN path
    LIMIT 1
$$) AS (path agtype);
```

### 3.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å‘é‡æŸ¥è¯¢ï¼šä½¿ç”¨ HNSW ç´¢å¼•
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- æŸ¥è¯¢æ—¶è®¾ç½®å‚æ•°
SET hnsw.ef_search = 100;
```

### 3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–

```python
# æ··åˆæŸ¥è¯¢ä¼˜åŒ–
class OptimizedRiskControl:
    async def assess_risk_optimized(self, transaction):
        """ä¼˜åŒ–çš„é£é™©è¯„ä¼°"""
        # 1. å¹¶è¡Œæ‰§è¡Œå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢
        graph_task = asyncio.create_task(
            self.analyze_account_relations(
                transaction['from_account'],
                transaction['to_account']
            )
        )

        vector_task = asyncio.create_task(
            self.analyze_transaction_pattern(transaction)
        )

        # 2. ç­‰å¾…ç»“æœ
        account_relations, transaction_pattern = await asyncio.gather(
            graph_task,
            vector_task
        )

        # 3. èåˆç»“æœ
        risk_score = self.fuse_results(account_relations, transaction_pattern)

        return risk_score
```

## 4. å®è·µæ•ˆæœ

### 4.1 æ€§èƒ½æŒ‡æ ‡

**æŸ¥è¯¢æ€§èƒ½**:

- **å›¾æŸ¥è¯¢**: P99 å»¶è¿Ÿ 30ms
- **å‘é‡æŸ¥è¯¢**: P99 å»¶è¿Ÿ 25ms
- **æ··åˆæŸ¥è¯¢**: P99 å»¶è¿Ÿ 45ms

**ä¸šåŠ¡æŒ‡æ ‡**:

- **é£é™©è¯†åˆ«å‡†ç¡®ç‡**: ä» 78% æå‡è‡³ 97%ï¼ˆ+24%ï¼‰
- **è¯¯æŠ¥ç‡**: ä» 12% é™ä½è‡³ 3%ï¼ˆ-75%ï¼‰
- **å“åº”æ—¶é—´**: P99 å»¶è¿Ÿ <50ms

## 5. å‚è€ƒèµ„æ–™

- [å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ](./å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ.md)
- [å›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹](./å›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹.md)
- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../../04-å¤šæ¨¡ä¸€ä½“åŒ–/æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-02-03
