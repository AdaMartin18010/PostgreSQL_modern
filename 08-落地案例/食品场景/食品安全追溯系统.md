# é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-32-01

## ğŸ“‘ ç›®å½•

- [é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿ](#é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿéœ€è¦ï¼š

- **å…¨ç¨‹è¿½æº¯**: è¿½æº¯é£Ÿå“ä»ç”Ÿäº§åˆ°é”€å”®çš„å…¨ç¨‹
- **æ‰¹æ¬¡ç®¡ç†**: ç®¡ç†é£Ÿå“æ‰¹æ¬¡ä¿¡æ¯
- **è´¨é‡æ£€æµ‹**: æ£€æµ‹é£Ÿå“è´¨é‡
- **å¿«é€Ÿå¬å›**: å¿«é€Ÿå¬å›é—®é¢˜é£Ÿå“

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†å›¾åƒç‰¹å¾
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **è¿½æº¯æ•ˆç‡** | å¿«é€Ÿè¿½æº¯æå‡æ•ˆç‡ | **+65%** |
| **å¬å›æ—¶é—´** | ç¼©çŸ­å¬å›æ—¶é—´ | **-75%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **12x** |
| **é£Ÿå“å®‰å…¨** | æå‡é£Ÿå“å®‰å…¨æ°´å¹³ | **+50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **è¿½æº¯æ•ˆç‡**: å¿«é€Ÿè¿½æº¯æå‡æ•ˆç‡ 65%
- **å¬å›æ—¶é—´**: ç¼©çŸ­å¬å›æ—¶é—´ 75%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 12 å€
- **é£Ÿå“å®‰å…¨**: æå‡é£Ÿå“å®‰å…¨æ°´å¹³ 50%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ¶æ„è®¾è®¡

```text
é£Ÿå“æ•°æ®é‡‡é›†
  â”œâ”€â”€ ç”Ÿäº§æ•°æ®
  â”œâ”€â”€ åŠ å·¥æ•°æ®
  â”œâ”€â”€ è¿è¾“æ•°æ®
  â””â”€â”€ é”€å”®æ•°æ®
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ ç”Ÿäº§æ•°æ®
  â”œâ”€â”€ åŠ å·¥æ•°æ®
  â””â”€â”€ è¿è¾“æ•°æ®
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ å›¾åƒç‰¹å¾
  â””â”€â”€ è´¨é‡ç‰¹å¾
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ è¿½æº¯æŸ¥è¯¢
  â”œâ”€â”€ æ‰¹æ¬¡ç®¡ç†
  â””â”€â”€ å¬å›ç®¡ç†
```

### 2.2 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + pgvector
- **æ•°æ®é‡‡é›†**: RFIDã€äºŒç»´ç ã€ä¼ æ„Ÿå™¨ã€æ‘„åƒå¤´
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 è¿½æº¯æ•°æ®æ—¶åºè¡¨

```sql
-- åˆ›å»ºè¿½æº¯æ•°æ®æ—¶åºè¡¨
CREATE TABLE trace_data (
    time TIMESTAMPTZ NOT NULL,
    batch_id TEXT NOT NULL,
    product_id TEXT NOT NULL,
    stage TEXT,
    location TEXT,
    operator TEXT,
    status TEXT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('trace_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX td_batch_time_idx ON trace_data (batch_id, time DESC);
CREATE INDEX td_product_idx ON trace_data (product_id, time DESC);
```

### 3.2 è´¨é‡æ£€æµ‹è¡¨

```sql
CREATE TABLE quality_inspection (
    id SERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL,
    batch_id TEXT NOT NULL,
    product_id TEXT,
    image_vector vector(512),
    quality_score DECIMAL(10, 2),
    defect_type TEXT,
    status TEXT,
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX qi_vector_idx ON quality_inspection
USING ivfflat (image_vector vector_cosine_ops)
WITH (lists = 100);
```

## 4. è¿½æº¯ç®¡ç†

### 4.1 å…¨ç¨‹è¿½æº¯

```sql
-- æŸ¥è¯¢é£Ÿå“å…¨ç¨‹è¿½æº¯ä¿¡æ¯
WITH trace_path AS (
    SELECT
        batch_id,
        product_id,
        stage,
        location,
        operator,
        time,
        ROW_NUMBER() OVER (PARTITION BY batch_id ORDER BY time) AS step_order
    FROM trace_data
    WHERE batch_id = $1
    ORDER BY time
)
SELECT
    step_order,
    stage,
    location,
    operator,
    time
FROM trace_path
ORDER BY step_order;
```

### 4.2 å¿«é€Ÿå¬å›

```python
# å¿«é€Ÿå¬å›
class ProductRecall:
    async def recall_products(self, batch_id):
        """å¬å›äº§å“"""
        # 1. æŸ¥è¯¢æ‰€æœ‰ç›¸å…³äº§å“
        products = await self.db.fetch("""
            SELECT DISTINCT product_id
            FROM trace_data
            WHERE batch_id = $1
        """, batch_id)

        # 2. æŸ¥è¯¢é”€å”®ä½ç½®
        sales_locations = await self.db.fetch("""
            SELECT DISTINCT location
            FROM trace_data
            WHERE batch_id = $1
                AND stage = 'sales'
        """, batch_id)

        # 3. ç”Ÿæˆå¬å›é€šçŸ¥
        recall_notice = {
            'batch_id': batch_id,
            'products': [p['product_id'] for p in products],
            'locations': [l['location'] for l in sales_locations],
            'recall_time': NOW()
        }

        return recall_notice
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé£Ÿå“ä¼ä¸šéœ€è¦æ„å»ºé£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿï¼Œå®ç°å…¨ç¨‹è¿½æº¯ï¼Œå¿«é€Ÿå¬å›ã€‚

**é—®é¢˜åˆ†æ**:

1. **è¿½æº¯å›°éš¾**: è¿½æº¯ä¿¡æ¯åˆ†æ•£ï¼Œè¿½æº¯å›°éš¾
2. **å¬å›æ…¢**: å¬å›é€Ÿåº¦æ…¢
3. **è´¨é‡æ£€æµ‹**: è´¨é‡æ£€æµ‹æ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# é£Ÿå“å®‰å…¨è¿½æº¯ç³»ç»Ÿ
class FoodSafetyTraceabilitySystem:
    def __init__(self):
        self.product_recall = ProductRecall()
        self.quality_detection = QualityDetection()

    async def trace_product(self, batch_id):
        """è¿½æº¯äº§å“"""
        # 1. æŸ¥è¯¢è¿½æº¯è·¯å¾„
        trace_path = await self.get_trace_path(batch_id)

        # 2. æŸ¥è¯¢è´¨é‡æ£€æµ‹è®°å½•
        quality_records = await self.db.fetch("""
            SELECT *
            FROM quality_inspection
            WHERE batch_id = $1
            ORDER BY time DESC
        """, batch_id)

        return {
            'trace_path': trace_path,
            'quality_records': quality_records
        }

    async def handle_recall(self, batch_id, reason):
        """å¤„ç†å¬å›"""
        # 1. ç”Ÿæˆå¬å›é€šçŸ¥
        recall_notice = await self.product_recall.recall_products(batch_id)

        # 2. é€šçŸ¥ç›¸å…³æ–¹
        await self.notify_stakeholders(recall_notice, reason)

        # 3. æ›´æ–°çŠ¶æ€
        await self.update_product_status(batch_id, 'recalled')

        return recall_notice
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **è¿½æº¯æ•ˆç‡** | åŸºå‡† | **+65%** | **æå‡** |
| **å¬å›æ—¶é—´** | 48 å°æ—¶ | **< 12å°æ—¶** | **75%** â¬‡ï¸ |
| **æŸ¥è¯¢æ€§èƒ½** | 3 ç§’ | **< 250ms** | **92%** â¬‡ï¸ |
| **é£Ÿå“å®‰å…¨** | åŸºå‡† | **+50%** | **æå‡** |

## 6. æœ€ä½³å®è·µ

### 6.1 è¿½æº¯ç®¡ç†

1. **å…¨ç¨‹è®°å½•**: è®°å½•é£Ÿå“ä»ç”Ÿäº§åˆ°é”€å”®çš„å…¨è¿‡ç¨‹
2. **æ‰¹æ¬¡ç®¡ç†**: ä¸¥æ ¼ç®¡ç†æ‰¹æ¬¡ä¿¡æ¯
3. **å¿«é€ŸæŸ¥è¯¢**: å¿«é€ŸæŸ¥è¯¢è¿½æº¯ä¿¡æ¯

### 6.2 å¬å›ç®¡ç†

1. **å¿«é€Ÿå“åº”**: å¿«é€Ÿå“åº”å¬å›éœ€æ±‚
2. **ç²¾å‡†å®šä½**: ç²¾å‡†å®šä½é—®é¢˜äº§å“
3. **åŠæ—¶é€šçŸ¥**: åŠæ—¶é€šçŸ¥ç›¸å…³æ–¹

## 7. å‚è€ƒèµ„æ–™

- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)
- [æ•°æ®è„±æ•å®è·µ](../æ”¿åŠ¡åœºæ™¯/æ•°æ®è„±æ•å®è·µ.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-32-01
