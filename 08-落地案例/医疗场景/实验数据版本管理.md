# åŒ»ç–—å®éªŒæ•°æ®ç‰ˆæœ¬ç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, Neon Platform
> **æ–‡æ¡£ç¼–å·**: 08-03-03

## ğŸ“‘ ç›®å½•

- [åŒ»ç–—å®éªŒæ•°æ®ç‰ˆæœ¬ç®¡ç†](#åŒ»ç–—å®éªŒæ•°æ®ç‰ˆæœ¬ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ¶æ„è®¾è®¡](#21-æ¶æ„è®¾è®¡)
    - [2.2 æŠ€æœ¯æ ˆ](#22-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®ç‰ˆæœ¬ç®¡ç†](#3-æ•°æ®ç‰ˆæœ¬ç®¡ç†)
    - [3.1 åˆ†æ”¯åˆ›å»º](#31-åˆ†æ”¯åˆ›å»º)
    - [3.2 ç‰ˆæœ¬å¯¹æ¯”](#32-ç‰ˆæœ¬å¯¹æ¯”)
    - [3.3 ç‰ˆæœ¬åˆå¹¶](#33-ç‰ˆæœ¬åˆå¹¶)
  - [4. å®è·µæ¡ˆä¾‹](#4-å®è·µæ¡ˆä¾‹)
    - [4.1 ä¸´åºŠè¯•éªŒæ•°æ®ç®¡ç†](#41-ä¸´åºŠè¯•éªŒæ•°æ®ç®¡ç†)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 åˆ†æ”¯ç®¡ç†ç­–ç•¥](#51-åˆ†æ”¯ç®¡ç†ç­–ç•¥)
    - [5.2 æ•°æ®ç®¡ç†å»ºè®®](#52-æ•°æ®ç®¡ç†å»ºè®®)
    - [5.3 æˆæœ¬ä¼˜åŒ–å»ºè®®](#53-æˆæœ¬ä¼˜åŒ–å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

åŒ»ç–—å®éªŒæ•°æ®ç®¡ç†éœ€è¦ï¼š

- **ç‰ˆæœ¬æ§åˆ¶**: ç®¡ç†å®éªŒæ•°æ®çš„ä¸åŒç‰ˆæœ¬
- **åˆ†æ”¯ç®¡ç†**: ä¸ºä¸åŒå®éªŒåˆ›å»ºç‹¬ç«‹åˆ†æ”¯
- **æ•°æ®è¿½æº¯**: è¿½æº¯æ•°æ®å˜æ›´å†å²
- **åˆè§„è¦æ±‚**: æ»¡è¶³åŒ»ç–—æ•°æ®åˆè§„è¦æ±‚

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ•°æ®åº“åˆ†æ”¯**: Neon æ•°æ®åº“åˆ†æ”¯åŠŸèƒ½
- **ç‰ˆæœ¬ç®¡ç†**: Git-like ç‰ˆæœ¬ç®¡ç†
- **æ•°æ®å®¡è®¡**: å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### 1.2 æ ¸å¿ƒä»·å€¼

- **å®éªŒæ•ˆç‡**: æå‡ 200%
- **æ•°æ®å®‰å…¨**: 100% æ•°æ®éš”ç¦»
- **åˆè§„æ€§**: æ»¡è¶³åŒ»ç–—æ•°æ®åˆè§„è¦æ±‚

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ¶æ„è®¾è®¡

```text
ä¸»æ•°æ®åº“ï¼ˆç”Ÿäº§æ•°æ®ï¼‰
  â†“
å®éªŒåˆ†æ”¯åˆ›å»º
  â”œâ”€â”€ å®éªŒ A åˆ†æ”¯
  â”œâ”€â”€ å®éªŒ B åˆ†æ”¯
  â””â”€â”€ å®éªŒ C åˆ†æ”¯
  â†“
å®éªŒæ•°æ®ä¿®æ”¹
  â†“
ç‰ˆæœ¬å¯¹æ¯”å’Œåˆå¹¶
```

### 2.2 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“å¹³å°**: Neon Platform
- **åˆ†æ”¯ç®¡ç†**: Neon Branching API
- **åº”ç”¨æ¡†æ¶**: Python / Node.js

## 3. æ•°æ®ç‰ˆæœ¬ç®¡ç†

### 3.1 åˆ†æ”¯åˆ›å»º

```python
# ä½¿ç”¨ Neon API åˆ›å»ºå®éªŒåˆ†æ”¯
import requests

class ExperimentBranchManager:
    def __init__(self, neon_api_key, project_id):
        self.api_key = neon_api_key
        self.project_id = project_id
        self.base_url = 'https://api.neon.tech'

    def create_experiment_branch(self, experiment_name):
        """ä¸ºå®éªŒåˆ›å»ºæ•°æ®åº“åˆ†æ”¯"""
        headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json'
        }

        data = {
            'branch': {
                'name': f'experiment-{experiment_name}',
                'parent_id': self.project_id
            }
        }

        response = requests.post(
            f'{self.base_url}/projects/{self.project_id}/branches',
            headers=headers,
            json=data
        )

        branch = response.json()['branch']
        return branch['id'], branch['connection_uris'][0]['connection_uri']
```

### 3.2 ç‰ˆæœ¬å¯¹æ¯”

```python
# å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯çš„æ•°æ®å·®å¼‚
class VersionComparator:
    async def compare_branches(self, branch1_id, branch2_id):
        """å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯çš„æ•°æ®å·®å¼‚"""
        # 1. è·å–ä¸¤ä¸ªåˆ†æ”¯çš„æ•°æ®
        branch1_data = await self.get_branch_data(branch1_id)
        branch2_data = await self.get_branch_data(branch2_id)

        # 2. å¯¹æ¯”å·®å¼‚
        differences = {
            'added': [],
            'modified': [],
            'deleted': []
        }

        # å¯¹æ¯”é€»è¾‘
        for table_name in branch1_data:
            if table_name not in branch2_data:
                differences['deleted'].append(table_name)
            else:
                table_diff = self._compare_table(
                    branch1_data[table_name],
                    branch2_data[table_name]
                )
                if table_diff:
                    differences['modified'].append({
                        'table': table_name,
                        'diff': table_diff
                    })

        return differences
```

### 3.3 ç‰ˆæœ¬åˆå¹¶

```python
# åˆå¹¶å®éªŒåˆ†æ”¯åˆ°ä¸»åˆ†æ”¯
class VersionMerger:
    async def merge_branch(self, source_branch_id, target_branch_id):
        """åˆå¹¶åˆ†æ”¯"""
        # 1. æ£€æŸ¥å†²çª
        conflicts = await self.check_conflicts(source_branch_id, target_branch_id)

        if conflicts:
            raise MergeConflictError(f"Found {len(conflicts)} conflicts")

        # 2. æ‰§è¡Œåˆå¹¶
        await self.execute_merge(source_branch_id, target_branch_id)

        # 3. è®°å½•åˆå¹¶å†å²
        await self.record_merge_history(source_branch_id, target_branch_id)
```

## 4. å®è·µæ¡ˆä¾‹

### 4.1 ä¸´åºŠè¯•éªŒæ•°æ®ç®¡ç†

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸåŒ»ç–—ç ”ç©¶æœºæ„ï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **å®éªŒæ•°é‡**: æ¯æœˆ 50+ ä¸ªä¸´åºŠè¯•éªŒ
- **æ•°æ®è§„æ¨¡**: æ¯ä¸ªå®éªŒ 10GB-100GB æ•°æ®
- **éœ€æ±‚**: ä¸ºæ¯ä¸ªå®éªŒåˆ›å»ºç‹¬ç«‹æ•°æ®åº“åˆ†æ”¯

**å®ç°æ–¹æ¡ˆ**:

```python
# ä¸´åºŠè¯•éªŒæ•°æ®ç®¡ç†
class ClinicalTrialManager:
    def __init__(self):
        self.branch_manager = ExperimentBranchManager(
            neon_api_key=os.getenv('NEON_API_KEY'),
            project_id=os.getenv('NEON_PROJECT_ID')
        )

    async def create_trial_branch(self, trial_id, trial_name):
        """ä¸ºä¸´åºŠè¯•éªŒåˆ›å»ºåˆ†æ”¯"""
        branch_id, connection_uri = self.branch_manager.create_experiment_branch(
            f'trial-{trial_id}'
        )

        # åˆå§‹åŒ–å®éªŒæ•°æ®
        await self.initialize_trial_data(branch_id, trial_id)

        return branch_id, connection_uri

    async def finalize_trial(self, trial_id, branch_id):
        """å®Œæˆè¯•éªŒï¼Œåˆå¹¶åˆ°ä¸»åˆ†æ”¯"""
        # 1. éªŒè¯æ•°æ®å®Œæ•´æ€§
        await self.validate_trial_data(branch_id)

        # 2. åˆå¹¶åˆ°ä¸»åˆ†æ”¯
        await self.merge_branch(branch_id, 'main')

        # 3. åˆ é™¤å®éªŒåˆ†æ”¯
        await self.delete_branch(branch_id)
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å®éªŒåˆ›å»ºæ—¶é—´** | 2 å°æ—¶ | **< 1 ç§’** | **99.9%** â¬‡ï¸ |
| **æ•°æ®éš”ç¦»** | 60% | **100%** | **æå‡** |
| **å®éªŒæˆæœ¬** | é«˜ | **é™ä½ 90%** | **èŠ‚çœ** |
| **å®éªŒæ•ˆç‡** | åŸºå‡† | **æå‡ 200%** | **æå‡** |

## 5. æœ€ä½³å®è·µ

### 5.1 åˆ†æ”¯ç®¡ç†ç­–ç•¥

1. **å‘½åè§„èŒƒ**: ä½¿ç”¨æ¸…æ™°çš„å‘½åè§„èŒƒï¼ˆå¦‚ trial-{trial_id}ï¼‰
2. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„å®éªŒåˆ†æ”¯
3. **ç‰ˆæœ¬æ ‡ç­¾**: ä¸ºé‡è¦ç‰ˆæœ¬åˆ›å»ºæ ‡ç­¾

### 5.2 æ•°æ®ç®¡ç†å»ºè®®

1. **æ•°æ®éªŒè¯**: åˆå¹¶å‰éªŒè¯æ•°æ®å®Œæ•´æ€§
2. **å†²çªå¤„ç†**: åˆ¶å®šå†²çªå¤„ç†ç­–ç•¥
3. **å¤‡ä»½ç­–ç•¥**: é‡è¦å®éªŒæ•°æ®å®šæœŸå¤‡ä»½

### 5.3 æˆæœ¬ä¼˜åŒ–å»ºè®®

1. **è‡ªåŠ¨æ¸…ç†**: è®¾ç½®è‡ªåŠ¨æ¸…ç†è¿‡æœŸåˆ†æ”¯
2. **Scale-to-Zero**: åˆ©ç”¨ Scale-to-Zero é™ä½å®éªŒæˆæœ¬
3. **å­˜å‚¨ä¼˜åŒ–**: åªä¿ç•™å¿…è¦çš„å®éªŒæ•°æ®

## 6. å‚è€ƒèµ„æ–™

- [Neon æ¶æ„è¯¦è§£](../../03-Serverlessä¸åˆ†æ”¯/Neonå¹³å°/Neonæ¶æ„è¯¦è§£.md)
- [Serverless æ¶æ„åŸç†](../../03-Serverlessä¸åˆ†æ”¯/æŠ€æœ¯åŸç†/Serverlessæ¶æ„åŸç†.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-03-03
