# ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-10-01

## ğŸ“‘ ç›®å½•

- [ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿ](#ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ¶æ„è®¾è®¡](#21-æ¶æ„è®¾è®¡)
    - [2.2 æŠ€æœ¯æ ˆ](#22-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 ç©å®¶è¡Œä¸ºæ—¶åºè¡¨](#31-ç©å®¶è¡Œä¸ºæ—¶åºè¡¨)
    - [3.2 ç©å®¶ç”»åƒè¡¨](#32-ç©å®¶ç”»åƒè¡¨)
    - [3.3 æ¸¸æˆäº‹ä»¶è¡¨](#33-æ¸¸æˆäº‹ä»¶è¡¨)
  - [4. è¡Œä¸ºåˆ†æç®—æ³•](#4-è¡Œä¸ºåˆ†æç®—æ³•)
    - [4.1 ç©å®¶åˆ†ç¾¤](#41-ç©å®¶åˆ†ç¾¤)
    - [4.2 æµå¤±é¢„æµ‹](#42-æµå¤±é¢„æµ‹)
    - [4.3 ä»˜è´¹é¢„æµ‹](#43-ä»˜è´¹é¢„æµ‹)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ‰‹æ¸¸ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ‰‹æ¸¸ç©å®¶è¡Œä¸ºåˆ†æç³»ç»ŸçœŸå®æ¡ˆä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ•°æ®é‡‡é›†](#61-æ•°æ®é‡‡é›†)
    - [6.2 åˆ†ææ¨¡å‹ä¼˜åŒ–](#62-åˆ†ææ¨¡å‹ä¼˜åŒ–)
    - [6.3 è¿è¥åº”ç”¨](#63-è¿è¥åº”ç”¨)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ¸¸æˆç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿéœ€è¦ï¼š

- **è¡Œä¸ºè¿½è¸ª**: è¿½è¸ªç©å®¶æ¸¸æˆè¡Œä¸º
- **ç©å®¶åˆ†ç¾¤**: å¯¹ç©å®¶è¿›è¡Œåˆ†ç¾¤åˆ†æ
- **æµå¤±é¢„æµ‹**: é¢„æµ‹ç©å®¶æµå¤±é£é™©
- **ä»˜è´¹é¢„æµ‹**: é¢„æµ‹ç©å®¶ä»˜è´¹æ„æ„¿

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **å‘é‡æœç´¢**: pgvector å‘é‡ç›¸ä¼¼åº¦è®¡ç®—ç©å®¶ç›¸ä¼¼æ€§
- **æœºå™¨å­¦ä¹ **: ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œé¢„æµ‹

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æµå¤±ç‡** | æµå¤±é¢„æµ‹é™ä½æµå¤±ç‡ | **-30%** |
| **ä»˜è´¹è½¬åŒ–ç‡** | ç²¾å‡†è¥é”€æå‡ä»˜è´¹ç‡ | **+25%** |
| **ç©å®¶ç•™å­˜ç‡** | ä¸ªæ€§åŒ–è¿è¥æå‡ç•™å­˜ | **+20%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **10x** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æµå¤±ç‡**: æµå¤±é¢„æµ‹å’Œå¹²é¢„é™ä½æµå¤±ç‡ 30%
- **ä»˜è´¹è½¬åŒ–ç‡**: ç²¾å‡†è¥é”€æå‡ä»˜è´¹è½¬åŒ–ç‡ 25%
- **ç©å®¶ç•™å­˜ç‡**: ä¸ªæ€§åŒ–è¿è¥æå‡ç©å®¶ç•™å­˜ç‡ 20%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 10 å€

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ¶æ„è®¾è®¡

```text
æ¸¸æˆäº‹ä»¶é‡‡é›†
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ ç©å®¶è¡Œä¸ºæ•°æ®
  â””â”€â”€ æ¸¸æˆäº‹ä»¶æ•°æ®
  â†“
å‘é‡åŒ–å¤„ç†
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â†“
è¡Œä¸ºåˆ†æå¼•æ“
  â”œâ”€â”€ ç©å®¶åˆ†ç¾¤
  â”œâ”€â”€ æµå¤±é¢„æµ‹
  â””â”€â”€ ä»˜è´¹é¢„æµ‹
  â†“
è¿è¥å†³ç­–æ”¯æŒ
```

### 2.2 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + pgvector
- **æ•°æ®é‡‡é›†**: æ¸¸æˆ SDKã€äº‹ä»¶è¿½è¸ª
- **åˆ†ææ¨¡å‹**: Python + scikit-learnã€XGBoost
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç©å®¶è¡Œä¸ºæ—¶åºè¡¨

```sql
-- åˆ›å»ºç©å®¶è¡Œä¸ºæ—¶åºè¡¨
CREATE TABLE player_behaviors (
    time TIMESTAMPTZ NOT NULL,
    player_id TEXT NOT NULL,
    event_type TEXT NOT NULL,  -- 'login', 'play', 'purchase', 'logout'
    game_level INTEGER,
    duration INTEGER,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('player_behaviors', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX player_behaviors_player_time_idx ON player_behaviors (player_id, time DESC);
CREATE INDEX player_behaviors_event_time_idx ON player_behaviors (event_type, time DESC);
```

### 3.2 ç©å®¶ç”»åƒè¡¨

```sql
CREATE TABLE player_profiles (
    player_id TEXT PRIMARY KEY,
    registration_date DATE,
    total_play_time INTEGER,
    total_spent DECIMAL(10, 2),
    current_level INTEGER,
    embedding vector(1536),
    profile_data JSONB,
    last_updated TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX player_profiles_embedding_idx ON player_profiles USING hnsw (embedding vector_cosine_ops);
CREATE INDEX player_profiles_level_idx ON player_profiles (current_level);
```

### 3.3 æ¸¸æˆäº‹ä»¶è¡¨

```sql
CREATE TABLE game_events (
    id SERIAL PRIMARY KEY,
    player_id TEXT NOT NULL,
    event_type TEXT NOT NULL,
    event_data JSONB,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX game_events_player_time_idx ON game_events (player_id, timestamp DESC);
CREATE INDEX game_events_type_time_idx ON game_events (event_type, timestamp DESC);
```

## 4. è¡Œä¸ºåˆ†æç®—æ³•

### 4.1 ç©å®¶åˆ†ç¾¤

```python
# ç©å®¶åˆ†ç¾¤
class PlayerClustering:
    async def cluster_players(self, n_clusters=5):
        """ç©å®¶åˆ†ç¾¤"""
        # 1. è·å–ç©å®¶ç‰¹å¾å‘é‡
        players = await self.db.fetch("""
            SELECT player_id, embedding FROM player_profiles
        """)

        # 2. ä½¿ç”¨ K-means èšç±»
        embeddings = np.array([p['embedding'] for p in players])
        from sklearn.cluster import KMeans
        kmeans = KMeans(n_clusters=n_clusters, random_state=42)
        clusters = kmeans.fit_predict(embeddings)

        # 3. ä¿å­˜åˆ†ç¾¤ç»“æœ
        for player, cluster_id in zip(players, clusters):
            await self.db.execute("""
                UPDATE player_profiles
                SET profile_data = jsonb_set(
                    COALESCE(profile_data, '{}'::jsonb),
                    '{cluster_id}',
                    $1::text::jsonb
                )
                WHERE player_id = $2
            """, cluster_id, player['player_id'])

        return clusters
```

### 4.2 æµå¤±é¢„æµ‹

```python
# æµå¤±é¢„æµ‹
class ChurnPrediction:
    async def predict_churn(self, player_id, days=7):
        """é¢„æµ‹ç©å®¶æµå¤±é£é™©"""
        # 1. è·å–ç©å®¶æœ€è¿‘è¡Œä¸ºæ•°æ®
        recent_behaviors = await self.db.fetch("""
            SELECT
                time_bucket('1 day', time) AS bucket,
                COUNT(*) AS event_count,
                SUM(CASE WHEN event_type = 'play' THEN duration ELSE 0 END) AS play_duration
            FROM player_behaviors
            WHERE player_id = $1
                AND time > NOW() - INTERVAL '30 days'
            GROUP BY bucket
            ORDER BY bucket DESC
        """, player_id)

        # 2. è®¡ç®—ç‰¹å¾
        features = self.extract_features(recent_behaviors)

        # 3. ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹é¢„æµ‹
        churn_probability = self.churn_model.predict_proba([features])[0][1]

        # 4. åˆ¤æ–­æµå¤±é£é™©
        risk_level = 'high' if churn_probability > 0.7 else 'medium' if churn_probability > 0.4 else 'low'

        return {
            'player_id': player_id,
            'churn_probability': churn_probability,
            'risk_level': risk_level
        }
```

### 4.3 ä»˜è´¹é¢„æµ‹

```python
# ä»˜è´¹é¢„æµ‹
class PaymentPrediction:
    async def predict_payment(self, player_id):
        """é¢„æµ‹ç©å®¶ä»˜è´¹æ„æ„¿"""
        # 1. è·å–ç©å®¶ç”»åƒ
        profile = await self.db.fetchrow("""
            SELECT * FROM player_profiles WHERE player_id = $1
        """, player_id)

        # 2. è·å–ç›¸ä¼¼ä»˜è´¹ç©å®¶
        similar_payers = await self.db.fetch("""
            SELECT
                player_id,
                total_spent,
                1 - (embedding <=> $1::vector) AS similarity
            FROM player_profiles
            WHERE total_spent > 0
                AND player_id != $2
            ORDER BY embedding <=> $1::vector
            LIMIT 10
        """, profile['embedding'], player_id)

        # 3. è®¡ç®—ä»˜è´¹æ¦‚ç‡
        if similar_payers:
            avg_spent = sum(p['total_spent'] for p in similar_payers) / len(similar_payers)
            avg_similarity = sum(p['similarity'] for p in similar_payers) / len(similar_payers)
            payment_probability = avg_similarity * min(avg_spent / 100, 1.0)
        else:
            payment_probability = 0.1

        return {
            'player_id': player_id,
            'payment_probability': payment_probability,
            'recommended_offer': self.recommend_offer(payment_probability)
        }
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ‰‹æ¸¸ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸæ‰‹æ¸¸å…¬å¸éœ€è¦æ„å»ºç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿï¼Œæå‡ç©å®¶ç•™å­˜ç‡å’Œä»˜è´¹è½¬åŒ–ç‡ã€‚

**é—®é¢˜åˆ†æ**:

1. **æµå¤±ç‡é«˜**: ç©å®¶æµå¤±ç‡é«˜ï¼Œç¼ºä¹æœ‰æ•ˆå¹²é¢„
2. **ä»˜è´¹ç‡ä½**: ä»˜è´¹è½¬åŒ–ç‡ä½
3. **è¿è¥æ•ˆç‡ä½**: è¿è¥å†³ç­–ç¼ºä¹æ•°æ®æ”¯æŒ
4. **æŸ¥è¯¢æ€§èƒ½**: è¡Œä¸ºæ•°æ®æŸ¥è¯¢æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**:

```python
# ç©å®¶è¡Œä¸ºåˆ†æç³»ç»Ÿ
class PlayerBehaviorAnalysisSystem:
    def __init__(self):
        self.clustering = PlayerClustering()
        self.churn_prediction = ChurnPrediction()
        self.payment_prediction = PaymentPrediction()

    async def daily_analysis(self):
        """æ¯æ—¥åˆ†æ"""
        # 1. ç©å®¶åˆ†ç¾¤
        clusters = await self.clustering.cluster_players()

        # 2. æµå¤±é¢„æµ‹
        players = await self.get_active_players()
        churn_risks = []
        for player in players:
            risk = await self.churn_prediction.predict_churn(player['id'])
            if risk['risk_level'] == 'high':
                churn_risks.append(risk)

        # 3. ä»˜è´¹é¢„æµ‹
        non_payers = await self.get_non_paying_players()
        payment_opportunities = []
        for player in non_payers:
            prediction = await self.payment_prediction.predict_payment(player['id'])
            if prediction['payment_probability'] > 0.5:
                payment_opportunities.append(prediction)

        return {
            'clusters': clusters,
            'churn_risks': churn_risks,
            'payment_opportunities': payment_opportunities
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æµå¤±ç‡** | åŸºå‡† | **-30%** | **é™ä½** |
| **ä»˜è´¹è½¬åŒ–ç‡** | åŸºå‡† | **+25%** | **æå‡** |
| **ç©å®¶ç•™å­˜ç‡** | åŸºå‡† | **+20%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 5 ç§’ | **< 100ms** | **98%** â¬‡ï¸ |
| **è¿è¥æ•ˆç‡** | åŸºå‡† | **+40%** | **æå‡** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ•°æ®é‡‡é›†

1. **äº‹ä»¶è®¾è®¡**: è®¾è®¡åˆç†çš„äº‹ä»¶ä½“ç³»
2. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®è´¨é‡å’Œå®Œæ•´æ€§
3. **å®æ—¶é‡‡é›†**: å®æ—¶é‡‡é›†ç©å®¶è¡Œä¸ºæ•°æ®

### 6.2 åˆ†ææ¨¡å‹ä¼˜åŒ–

1. **ç‰¹å¾å·¥ç¨‹**: æå–æœ‰æ•ˆçš„ç©å®¶ç‰¹å¾
2. **æ¨¡å‹é€‰æ‹©**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å‹
3. **æ¨¡å‹æ›´æ–°**: å®šæœŸæ›´æ–°æ¨¡å‹ï¼Œé€‚åº”ç©å®¶è¡Œä¸ºå˜åŒ–

### 6.3 è¿è¥åº”ç”¨

1. **ä¸ªæ€§åŒ–è¿è¥**: åŸºäºåˆ†ç¾¤ç»“æœè¿›è¡Œä¸ªæ€§åŒ–è¿è¥
2. **æµå¤±å¹²é¢„**: å¯¹é«˜é£é™©ç©å®¶è¿›è¡Œæµå¤±å¹²é¢„
3. **ç²¾å‡†è¥é”€**: åŸºäºä»˜è´¹é¢„æµ‹è¿›è¡Œç²¾å‡†è¥é”€

## 7. å‚è€ƒèµ„æ–™

- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)
- [ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ](../ç”µå•†åœºæ™¯/ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-10-01
