# 5.5 行级主权标签

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: pg_dsr 1.0  
> **文档编号**: 05-03-01

## 📑 目录

- [5.5 行级主权标签](#55-行级主权标签)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 标签设计](#2-标签设计)
    - [2.1 标签结构](#21-标签结构)
    - [2.2 标签层次](#22-标签层次)
  - [3. 实现方法](#3-实现方法)
    - [3.1 自动标签](#31-自动标签)
  - [4. 访问控制](#4-访问控制)
    - [4.1 基于标签的访问控制](#41-基于标签的访问控制)
  - [5. 最佳实践](#5-最佳实践)
  - [6. 参考资料](#6-参考资料)

---

## 1. 概述

行级主权标签为每行数据标注主权信息，实现细粒度的数据主权管理。

---

## 2. 标签设计

### 2.1 标签结构

```sql
-- 主权标签列
ALTER TABLE user_data ADD COLUMN data_sovereignty TEXT[];

-- 标签示例
UPDATE user_data
SET data_sovereignty = ARRAY['EU', 'DE', 'Berlin']
WHERE user_country = 'Germany';
```

### 2.2 标签层次

- **国家级别**: 'EU', 'US', 'CN'
- **地区级别**: 'DE', 'FR', 'UK'
- **城市级别**: 'Berlin', 'Paris', 'London'

---

## 3. 实现方法

### 3.1 自动标签

```sql
-- 自动标签函数
CREATE OR REPLACE FUNCTION auto_label_sovereignty()
RETURNS TRIGGER AS $$
BEGIN
    NEW.data_sovereignty := ARRAY[
        get_country_code(NEW.user_country),
        get_region_code(NEW.user_region),
        get_city_code(NEW.user_city)
    ];
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER auto_sovereignty_label
BEFORE INSERT OR UPDATE ON user_data
FOR EACH ROW
EXECUTE FUNCTION auto_label_sovereignty();
```

---

## 4. 访问控制

### 4.1 基于标签的访问控制

```sql
-- 创建访问控制策略
CREATE POLICY "sovereignty_access"
ON user_data FOR SELECT
USING (
    current_setting('user.country') = ANY(data_sovereignty)
);
```

---

## 5. 最佳实践

1. **标签完整性**: 确保所有数据都有主权标签
2. **自动标签**: 使用自动标签减少人工错误
3. **访问控制**: 基于标签实施访问控制

---

## 6. 参考资料

- [数据库合规架构](../技术原理/数据库合规架构.md)
- [跨境数据拦截](./跨境数据拦截.md)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team
