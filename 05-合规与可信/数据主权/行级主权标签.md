# è¡Œçº§ä¸»æƒæ ‡ç­¾

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 05-03-01

## ğŸ“‘ ç›®å½•

- [è¡Œçº§ä¸»æƒæ ‡ç­¾](#è¡Œçº§ä¸»æƒæ ‡ç­¾)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è¡Œçº§ä¸»æƒæ ‡ç­¾è®¾è®¡](#2-è¡Œçº§ä¸»æƒæ ‡ç­¾è®¾è®¡)
    - [2.1 æ ‡ç­¾ç»“æ„](#21-æ ‡ç­¾ç»“æ„)
    - [2.2 æ ‡ç­¾ç®¡ç†](#22-æ ‡ç­¾ç®¡ç†)
  - [3. æ•°æ®è®¿é—®æ§åˆ¶](#3-æ•°æ®è®¿é—®æ§åˆ¶)
    - [3.1 åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶](#31-åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶)
    - [3.2 è¡Œçº§å®‰å…¨ç­–ç•¥](#32-è¡Œçº§å®‰å…¨ç­–ç•¥)
  - [4. å®è·µæ¡ˆä¾‹](#4-å®è·µæ¡ˆä¾‹)
    - [4.1 å¤šåœ°åŒºæ•°æ®ä¸»æƒç®¡ç†](#41-å¤šåœ°åŒºæ•°æ®ä¸»æƒç®¡ç†)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ•°æ®ä¸»æƒç®¡ç†éœ€è¦ï¼š

- **æ•°æ®å½’å±**: æ˜ç¡®æ•°æ®çš„å½’å±åœ°åŒº/å›½å®¶
- **è®¿é—®æ§åˆ¶**: åŸºäºæ•°æ®ä¸»æƒçš„è®¿é—®æ§åˆ¶
- **åˆè§„è¦æ±‚**: æ»¡è¶³æ•°æ®ä¸»æƒæ³•è§„è¦æ±‚
- **æ•°æ®éš”ç¦»**: ä¸åŒä¸»æƒæ•°æ®éš”ç¦»

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **è¡Œçº§æ ‡ç­¾**: ä¸ºæ¯è¡Œæ•°æ®æ·»åŠ ä¸»æƒæ ‡ç­¾
- **è¡Œçº§å®‰å…¨**: PostgreSQL RLS å®ç°è®¿é—®æ§åˆ¶
- **æ ‡ç­¾ç­–ç•¥**: åŸºäºæ ‡ç­¾çš„è®¿é—®ç­–ç•¥

### 1.2 æ ¸å¿ƒä»·å€¼

- **åˆè§„æ€§**: 100% æ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚
- **æ•°æ®å®‰å…¨**: ä¸¥æ ¼çš„æ•°æ®è®¿é—®æ§åˆ¶
- **çµæ´»æ€§**: çµæ´»çš„ä¸»æƒæ ‡ç­¾ç®¡ç†

## 2. è¡Œçº§ä¸»æƒæ ‡ç­¾è®¾è®¡

### 2.1 æ ‡ç­¾ç»“æ„

```sql
-- ä¸»æƒæ ‡ç­¾è¡¨
CREATE TABLE sovereignty_labels (
    id SERIAL PRIMARY KEY,
    label_name TEXT UNIQUE NOT NULL,
    region TEXT NOT NULL,  -- 'EU', 'US', 'CN', 'APAC'
    country TEXT,
    data_residency_required BOOLEAN DEFAULT TRUE,
    cross_border_allowed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ•°æ®è¡¨æ·»åŠ ä¸»æƒæ ‡ç­¾
CREATE TABLE customer_data (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT,
    sovereignty_label_id INTEGER REFERENCES sovereignty_labels(id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON customer_data (sovereignty_label_id);
```

### 2.2 æ ‡ç­¾ç®¡ç†

```sql
-- åˆ›å»ºä¸»æƒæ ‡ç­¾
INSERT INTO sovereignty_labels (label_name, region, country, data_residency_required, cross_border_allowed)
VALUES
    ('EU_DATA', 'EU', 'ALL', TRUE, FALSE),
    ('US_DATA', 'US', 'US', TRUE, FALSE),
    ('CN_DATA', 'CN', 'CN', TRUE, FALSE),
    ('GLOBAL_DATA', 'GLOBAL', NULL, FALSE, TRUE);

-- ä¸ºæ•°æ®æ·»åŠ ä¸»æƒæ ‡ç­¾
UPDATE customer_data
SET sovereignty_label_id = (
    SELECT id FROM sovereignty_labels WHERE label_name = 'EU_DATA'
)
WHERE region = 'EU';
```

## 3. æ•°æ®è®¿é—®æ§åˆ¶

### 3.1 åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶

```sql
-- ç”¨æˆ·ä¸»æƒæƒé™è¡¨
CREATE TABLE user_sovereignty_permissions (
    id SERIAL PRIMARY KEY,
    user_id TEXT NOT NULL,
    allowed_labels INTEGER[] NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºå‡½æ•°è·å–ç”¨æˆ·å…è®¸çš„ä¸»æƒæ ‡ç­¾
CREATE OR REPLACE FUNCTION get_user_allowed_labels(user_id TEXT)
RETURNS INTEGER[] AS $$
DECLARE
    allowed_labels INTEGER[];
BEGIN
    SELECT allowed_labels INTO allowed_labels
    FROM user_sovereignty_permissions
    WHERE user_sovereignty_permissions.user_id = get_user_allowed_labels.user_id;

    RETURN COALESCE(allowed_labels, ARRAY[]::INTEGER[]);
END;
$$ LANGUAGE plpgsql;
```

### 3.2 è¡Œçº§å®‰å…¨ç­–ç•¥

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE customer_data ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºåŸºäºä¸»æƒæ ‡ç­¾çš„è¡Œçº§å®‰å…¨ç­–ç•¥
CREATE POLICY sovereignty_access_policy ON customer_data
    FOR SELECT
    USING (
        sovereignty_label_id = ANY(get_user_allowed_labels(current_user))
    );

-- åˆ›å»ºå‡½æ•°è·å–å½“å‰ç”¨æˆ·
CREATE OR REPLACE FUNCTION current_user()
RETURNS TEXT AS $$
BEGIN
    RETURN current_setting('app.current_user', TRUE);
END;
$$ LANGUAGE plpgsql;

-- è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
SET app.current_user = 'user_001';
```

## 4. å®è·µæ¡ˆä¾‹

### 4.1 å¤šåœ°åŒºæ•°æ®ä¸»æƒç®¡ç†

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸè·¨å›½ä¼ä¸šï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **æ•°æ®åˆ†å¸ƒ**: EUã€USã€CN ä¸‰ä¸ªåœ°åŒº
- **æ•°æ®è§„æ¨¡**: 1000 ä¸‡æ¡å®¢æˆ·æ•°æ®
- **éœ€æ±‚**: æ»¡è¶³å„åœ°åŒºçš„æ•°

æ®ä¸»æƒè¦æ±‚

**å®ç°æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºä¸»æƒæ ‡ç­¾
INSERT INTO sovereignty_labels (label_name, region, country, data_residency_required, cross_border_allowed)
VALUES
    ('EU_DATA', 'EU', 'ALL', TRUE, FALSE),
    ('US_DATA', 'US', 'US', TRUE, FALSE),
    ('CN_DATA', 'CN', 'CN', TRUE, FALSE);

-- 2. ä¸ºæ•°æ®æ·»åŠ ä¸»æƒæ ‡ç­¾
UPDATE customer_data
SET sovereignty_label_id = (
    SELECT id FROM sovereignty_labels
    WHERE region = customer_data.region
);

-- 3. é…ç½®ç”¨æˆ·æƒé™
INSERT INTO user_sovereignty_permissions (user_id, allowed_labels)
VALUES
    ('eu_user', ARRAY[(SELECT id FROM sovereignty_labels WHERE label_name = 'EU_DATA')]),
    ('us_user', ARRAY[(SELECT id FROM sovereignty_labels WHERE label_name = 'US_DATA')]),
    ('cn_user', ARRAY[(SELECT id FROM sovereignty_labels WHERE label_name = 'CN_DATA')]),
    ('admin_user', ARRAY[(SELECT id FROM sovereignty_labels)]);

-- 4. æµ‹è¯•è®¿é—®æ§åˆ¶
SET app.current_user = 'eu_user';
SELECT * FROM customer_data;  -- åªèƒ½çœ‹åˆ° EU æ•°æ®

SET app.current_user = 'admin_user';
SELECT * FROM customer_data;  -- å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ•°æ®
```

**æ•ˆæœ**:

- **åˆè§„æ€§**: 100% æ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚
- **æ•°æ®å®‰å…¨**: ä¸¥æ ¼çš„æ•°æ®è®¿é—®æ§åˆ¶
- **çµæ´»æ€§**: çµæ´»çš„ä¸»æƒæ ‡ç­¾ç®¡ç†

## 5. å‚è€ƒèµ„æ–™

- [è·¨å¢ƒæ•°æ®æ‹¦æˆª](./è·¨å¢ƒæ•°æ®æ‹¦æˆª.md)
- [æ•°æ®ç•™å­˜ç­–ç•¥](./æ•°æ®ç•™å­˜ç­–ç•¥.md)
- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 05-03-01
