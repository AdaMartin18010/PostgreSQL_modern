# 5.7 æ•°æ®ç•™å­˜ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0  
> **æ–‡æ¡£ç¼–å·**: 05-03-03

## ğŸ“‘ ç›®å½•

- [5.7 æ•°æ®ç•™å­˜ç­–ç•¥](#57-æ•°æ®ç•™å­˜ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç•™å­˜ç­–ç•¥](#2-ç•™å­˜ç­–ç•¥)
    - [2.1 ç­–ç•¥é…ç½®](#21-ç­–ç•¥é…ç½®)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 è‡ªåŠ¨æ¸…ç†](#31-è‡ªåŠ¨æ¸…ç†)
  - [4. è‡ªåŠ¨åŒ–ç®¡ç†](#4-è‡ªåŠ¨åŒ–ç®¡ç†)
    - [4.1 ç•™å­˜ç›‘æ§](#41-ç•™å­˜ç›‘æ§)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

æ•°æ®ç•™å­˜ç­–ç•¥ç®¡ç†æ•°æ®çš„ä¿ç•™æœŸé™å’Œæ¸…ç†è§„åˆ™ã€‚

---

## 2. ç•™å­˜ç­–ç•¥

### 2.1 ç­–ç•¥é…ç½®

```sql
-- åˆ›å»ºç•™å­˜ç­–ç•¥è¡¨
CREATE TABLE retention_policies (
    id SERIAL PRIMARY KEY,
    table_name TEXT,
    retention_period INTERVAL,
    retention_reason TEXT,
    auto_delete BOOLEAN DEFAULT TRUE
);

-- ç¤ºä¾‹ç­–ç•¥
INSERT INTO retention_policies (table_name, retention_period, retention_reason)
VALUES
    ('user_data', INTERVAL '7 years', 'Legal requirement'),
    ('audit_logs', INTERVAL '10 years', 'Compliance requirement'),
    ('temp_data', INTERVAL '30 days', 'Temporary data');
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 è‡ªåŠ¨æ¸…ç†

```sql
-- è‡ªåŠ¨æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION auto_cleanup_expired_data()
RETURNS void AS $$
DECLARE
    policy_record RECORD;
BEGIN
    FOR policy_record IN
        SELECT * FROM retention_policies WHERE auto_delete = TRUE
    LOOP
        EXECUTE format(
            'DELETE FROM %I WHERE created_at < NOW() - $1',
            policy_record.table_name
        ) USING policy_record.retention_period;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡
SELECT cron.schedule('cleanup-expired-data', '0 2 * * *',
    'SELECT auto_cleanup_expired_data()');
```

---

## 4. è‡ªåŠ¨åŒ–ç®¡ç†

### 4.1 ç•™å­˜ç›‘æ§

```sql
-- æ£€æŸ¥å³å°†è¿‡æœŸçš„æ•°æ®
CREATE OR REPLACE FUNCTION check_expiring_data()
RETURNS TABLE (
    table_name TEXT,
    expiring_count BIGINT,
    expiration_date DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        rp.table_name,
        COUNT(*) as expiring_count,
        (NOW() + rp.retention_period)::DATE as expiration_date
    FROM retention_policies rp
    JOIN information_schema.tables t ON t.table_name = rp.table_name
    GROUP BY rp.table_name, rp.retention_period;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. æœ€ä½³å®è·µ

1. **ç­–ç•¥åˆ¶å®š**: æ ¹æ®æ³•è§„è¦æ±‚åˆ¶å®šç•™å­˜ç­–ç•¥
2. **è‡ªåŠ¨åŒ–**: ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ç®¡ç†æ•°æ®ç•™å­˜
3. **ç›‘æ§å‘Šè­¦**: ç›‘æ§æ•°æ®ç•™å­˜çŠ¶æ€

---

## 6. å‚è€ƒèµ„æ–™

- [è¡Œçº§ä¸»æƒæ ‡ç­¾](./è¡Œçº§ä¸»æƒæ ‡ç­¾.md)
- [è·¨å¢ƒæ•°æ®æ‹¦æˆª](./è·¨å¢ƒæ•°æ®æ‹¦æˆª.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
