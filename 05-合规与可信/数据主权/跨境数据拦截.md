# è·¨å¢ƒæ•°æ®æ‹¦æˆª

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 05-03-02

## ğŸ“‘ ç›®å½•

- [è·¨å¢ƒæ•°æ®æ‹¦æˆª](#è·¨å¢ƒæ•°æ®æ‹¦æˆª)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. æ‹¦æˆªæœºåˆ¶è®¾è®¡](#2-æ‹¦æˆªæœºåˆ¶è®¾è®¡)
    - [2.1 æ•°æ®æ‹¦æˆªè§„åˆ™](#21-æ•°æ®æ‹¦æˆªè§„åˆ™)
    - [2.2 æ‹¦æˆªè§¦å‘å™¨](#22-æ‹¦æˆªè§¦å‘å™¨)
  - [3. æ‹¦æˆªç­–ç•¥](#3-æ‹¦æˆªç­–ç•¥)
    - [3.1 åŸºäºä¸»æƒçš„æ‹¦æˆª](#31-åŸºäºä¸»æƒçš„æ‹¦æˆª)
    - [3.2 åŸºäºç›®çš„åœ°çš„æ‹¦æˆª](#32-åŸºäºç›®çš„åœ°çš„æ‹¦æˆª)
  - [4. å®è·µæ¡ˆä¾‹](#4-å®è·µæ¡ˆä¾‹)
    - [4.1 ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª](#41-ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

è·¨å¢ƒæ•°æ®æ‹¦æˆªéœ€è¦ï¼š

- **æ•°æ®ä¿æŠ¤**: é˜²æ­¢æ•æ„Ÿæ•°æ®è·¨å¢ƒä¼ è¾“
- **åˆè§„è¦æ±‚**: æ»¡è¶³æ•°æ®ä¸»æƒæ³•è§„è¦æ±‚
- **å®æ—¶æ‹¦æˆª**: å®æ—¶æ‹¦æˆªè¿è§„æ•°æ®ä¼ è¾“
- **å®¡è®¡è®°å½•**: è®°å½•æ‹¦æˆªäº‹ä»¶

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **è§¦å‘å™¨æ‹¦æˆª**: ä½¿ç”¨è§¦å‘å™¨æ‹¦æˆªæ•°æ®æ“ä½œ
- **è§„åˆ™å¼•æ“**: åŸºäºè§„åˆ™çš„æ•°æ®æ‹¦æˆª
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‹¦æˆªäº‹ä»¶

### 1.2 æ ¸å¿ƒä»·å€¼

- **åˆè§„æ€§**: 100% æ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚
- **æ•°æ®å®‰å…¨**: é˜²æ­¢æ•æ„Ÿæ•°æ®æ³„éœ²
- **å®æ—¶æ€§**: å®æ—¶æ‹¦æˆªè¿è§„æ“ä½œ

## 2. æ‹¦æˆªæœºåˆ¶è®¾è®¡

### 2.1 æ•°æ®æ‹¦æˆªè§„åˆ™

```sql
-- è·¨å¢ƒæ•°æ®æ‹¦æˆªè§„åˆ™è¡¨
CREATE TABLE cross_border_interception_rules (
    id SERIAL PRIMARY KEY,
    rule_name TEXT NOT NULL,
    source_region TEXT NOT NULL,
    destination_region TEXT NOT NULL,
    data_type TEXT NOT NULL,  -- 'personal', 'sensitive', 'confidential'
    action TEXT NOT NULL,  -- 'block', 'allow', 'require_approval'
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºæ‹¦æˆªè§„åˆ™
INSERT INTO cross_border_interception_rules (
    rule_name,
    source_region,
    destination_region,
    data_type,
    action
) VALUES
    ('EU_TO_US_PERSONAL', 'EU', 'US', 'personal', 'block'),
    ('EU_TO_CN_SENSITIVE', 'EU', 'CN', 'sensitive', 'block'),
    ('US_TO_EU_PERSONAL', 'US', 'EU', 'personal', 'require_approval');
```

### 2.2 æ‹¦æˆªè§¦å‘å™¨

```sql
-- è·¨å¢ƒæ•°æ®æ‹¦æˆªæ—¥å¿—è¡¨
CREATE TABLE cross_border_interception_logs (
    id SERIAL PRIMARY KEY,
    operation_type TEXT NOT NULL,  -- 'SELECT', 'INSERT', 'UPDATE', 'DELETE'
    table_name TEXT NOT NULL,
    row_id INTEGER,
    source_region TEXT,
    destination_region TEXT,
    intercepted BOOLEAN DEFAULT FALSE,
    reason TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ‹¦æˆªå‡½æ•°
CREATE OR REPLACE FUNCTION intercept_cross_border_data()
RETURNS TRIGGER AS $$
DECLARE
    source_label_id INTEGER;
    destination_region TEXT;
    rule_action TEXT;
    intercepted BOOLEAN := FALSE;
BEGIN
    -- è·å–æ•°æ®æºä¸»æƒæ ‡ç­¾
    IF TG_OP = 'INSERT' THEN
        source_label_id := NEW.sovereignty_label_id;
    ELSIF TG_OP = 'UPDATE' THEN
        source_label_id := NEW.sovereignty_label_id;
    ELSE
        source_label_id := OLD.sovereignty_label_id;
    END IF;

    -- è·å–ç›®æ ‡åŒºåŸŸï¼ˆä»ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰
    destination_region := current_setting('app.destination_region', TRUE);

    -- æ£€æŸ¥æ‹¦æˆªè§„åˆ™
    SELECT action INTO rule_action
    FROM cross_border_interception_rules
    WHERE source_region = (
        SELECT region FROM sovereignty_labels WHERE id = source_label_id
    )
    AND destination_region = destination_region
    AND data_type = (
        SELECT data_type FROM data_classification WHERE table_name = TG_TABLE_NAME
    )
    AND enabled = TRUE;

    -- æ‰§è¡Œæ‹¦æˆª
    IF rule_action = 'block' THEN
        intercepted := TRUE;
        RAISE EXCEPTION 'Cross-border data transfer blocked: % to %',
            (SELECT region FROM sovereignty_labels WHERE id = source_label_id),
            destination_region;
    ELSIF rule_action = 'require_approval' THEN
        -- è®°å½•éœ€è¦å®¡æ‰¹
        INSERT INTO cross_border_interception_logs (
            operation_type,
            table_name,
            row_id,
            source_region,
            destination_region,
            intercepted,
            reason
        ) VALUES (
            TG_OP,
            TG_TABLE_NAME,
            COALESCE(NEW.id, OLD.id),
            (SELECT region FROM sovereignty_labels WHERE id = source_label_id),
            destination_region,
            FALSE,
            'Requires approval'
        );
    END IF;

    -- è®°å½•æ‹¦æˆªæ—¥å¿—
    IF intercepted THEN
        INSERT INTO cross_border_interception_logs (
            operation_type,
            table_name,
            row_id,
            source_region,
            destination_region,
            intercepted,
            reason
        ) VALUES (
            TG_OP,
            TG_TABLE_NAME,
            COALESCE(NEW.id, OLD.id),
            (SELECT region FROM sovereignty_labels WHERE id = source_label_id),
            destination_region,
            TRUE,
            'Blocked by rule'
        );
    END IF;

    IF TG_OP = 'DELETE' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER cross_border_interception_trigger
    BEFORE INSERT OR UPDATE OR DELETE ON customer_data
    FOR EACH ROW
    EXECUTE FUNCTION intercept_cross_border_data();
```

## 3. æ‹¦æˆªç­–ç•¥

### 3.1 åŸºäºä¸»æƒçš„æ‹¦æˆª

```sql
-- åŸºäºä¸»æƒçš„æ‹¦æˆªç­–ç•¥
CREATE OR REPLACE FUNCTION check_sovereignty_interception(
    source_label_id INTEGER,
    destination_region TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    source_region TEXT;
    rule_action TEXT;
BEGIN
    -- è·å–æºåŒºåŸŸ
    SELECT region INTO source_region
    FROM sovereignty_labels
    WHERE id = source_label_id;

    -- æ£€æŸ¥æ‹¦æˆªè§„åˆ™
    SELECT action INTO rule_action
    FROM cross_border_interception_rules
    WHERE source_region = source_region
    AND destination_region = destination_region
    AND enabled = TRUE;

    -- è¿”å›æ˜¯å¦æ‹¦æˆª
    RETURN rule_action = 'block';
END;
$$ LANGUAGE plpgsql;
```

### 3.2 åŸºäºç›®çš„åœ°çš„æ‹¦æˆª

```sql
-- åŸºäºç›®çš„åœ°çš„æ‹¦æˆªç­–ç•¥
CREATE OR REPLACE FUNCTION intercept_by_destination(
    table_name TEXT,
    row_id INTEGER,
    destination_region TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    source_label_id INTEGER;
    intercepted BOOLEAN;
BEGIN
    -- è·å–æ•°æ®çš„ä¸»æƒæ ‡ç­¾
    EXECUTE format('SELECT sovereignty_label_id FROM %I WHERE id = $1', table_name)
    INTO source_label_id
    USING row_id;

    -- æ£€æŸ¥æ‹¦æˆª
    intercepted := check_sovereignty_interception(source_label_id, destination_region);

    -- è®°å½•æ‹¦æˆªæ—¥å¿—
    IF intercepted THEN
        INSERT INTO cross_border_interception_logs (
            operation_type,
            table_name,
            row_id,
            source_region,
            destination_region,
            intercepted,
            reason
        ) VALUES (
            'SELECT',
            table_name,
            row_id,
            (SELECT region FROM sovereignty_labels WHERE id = source_label_id),
            destination_region,
            TRUE,
            'Blocked by destination'
        );
    END IF;

    RETURN intercepted;
END;
$$ LANGUAGE plpgsql;
```

## 4. å®è·µæ¡ˆä¾‹

### 4.1 ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸè·¨å›½ä¼ä¸šï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **æ•°æ®åˆ†å¸ƒ**: EUã€USã€CN ä¸‰ä¸ªåœ°åŒº
- **æ•°æ®è§„æ¨¡**: 1000 ä¸‡æ¡å®¢æˆ·æ•°æ®
- **éœ€æ±‚**: é˜²æ­¢ EU æ•°æ®è·¨å¢ƒä¼ è¾“åˆ° US/CN

**å®ç°æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºæ‹¦æˆªè§„åˆ™
INSERT INTO cross_border_interception_rules (
    rule_name,
    source_region,
    destination_region,
    data_type,
    action
) VALUES
    ('EU_TO_US_BLOCK', 'EU', 'US', 'personal', 'block'),
    ('EU_TO_CN_BLOCK', 'EU', 'CN', 'personal', 'block');

-- 2. è®¾ç½®ç”¨æˆ·ç›®çš„åœ°
SET app.destination_region = 'US';

-- 3. å°è¯•è®¿é—® EU æ•°æ®ï¼ˆä¼šè¢«æ‹¦æˆªï¼‰
-- è¿™ä¼šè§¦å‘å¼‚å¸¸
INSERT INTO customer_data (name, email, sovereignty_label_id)
VALUES ('John Doe', 'john@example.com',
    (SELECT id FROM sovereignty_labels WHERE label_name = 'EU_DATA'));
-- ERROR: Cross-border data transfer blocked: EU to US

-- 4. æŸ¥çœ‹æ‹¦æˆªæ—¥å¿—
SELECT * FROM cross_border_interception_logs
WHERE intercepted = TRUE
ORDER BY created_at DESC;
```

**æ•ˆæœ**:

- **åˆè§„æ€§**: 100% æ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚
- **æ•°æ®å®‰å…¨**: é˜²æ­¢æ•æ„Ÿæ•°æ®è·¨å¢ƒä¼ è¾“
- **å®æ—¶æ€§**: å®æ—¶æ‹¦æˆªè¿è§„æ“ä½œ

## 5. å‚è€ƒèµ„æ–™

- [è¡Œçº§ä¸»æƒæ ‡ç­¾](./è¡Œçº§ä¸»æƒæ ‡ç­¾.md)
- [æ•°æ®ç•™å­˜ç­–ç•¥](./æ•°æ®ç•™å­˜ç­–ç•¥.md)
- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 05-03-02
