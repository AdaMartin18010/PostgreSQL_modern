# 5.8 ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+  
> **æ–‡æ¡£ç¼–å·**: 05-04-01

## ğŸ“‘ ç›®å½•

- [5.8 ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—](#58-ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. Ledger è¡¨è®¾è®¡](#2-ledger-è¡¨è®¾è®¡)
    - [2.1 åˆ›å»º Ledger è¡¨](#21-åˆ›å»º-ledger-è¡¨)
    - [2.2 å“ˆå¸Œè®¡ç®—](#22-å“ˆå¸Œè®¡ç®—)
  - [3. å“ˆå¸Œé“¾æœºåˆ¶](#3-å“ˆå¸Œé“¾æœºåˆ¶)
    - [3.1 æ’å…¥å®¡è®¡è®°å½•](#31-æ’å…¥å®¡è®¡è®°å½•)
  - [4. å®Œæ•´æ€§éªŒè¯](#4-å®Œæ•´æ€§éªŒè¯)
    - [4.1 éªŒè¯å‡½æ•°](#41-éªŒè¯å‡½æ•°)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—ä½¿ç”¨ Ledger è¡¨å’Œå“ˆå¸Œé“¾æœºåˆ¶ï¼Œç¡®ä¿å®¡è®¡æ—¥å¿—çš„å®Œæ•´æ€§ã€‚

---

## 2. Ledger è¡¨è®¾è®¡

### 2.1 åˆ›å»º Ledger è¡¨

```sql
-- åˆ›å»º Ledger è¡¨
CREATE TABLE user_data_ledger (
    id BIGSERIAL PRIMARY KEY,
    sequence_number BIGINT NOT NULL,
    operation TEXT NOT NULL,  -- 'INSERT', 'UPDATE', 'DELETE'
    table_name TEXT NOT NULL,
    record_id BIGINT,
    old_data JSONB,
    new_data JSONB,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    user_id TEXT,
    previous_hash TEXT,
    current_hash TEXT NOT NULL
);
```

### 2.2 å“ˆå¸Œè®¡ç®—

```sql
-- è®¡ç®—å“ˆå¸Œå‡½æ•°
CREATE OR REPLACE FUNCTION calculate_hash(
    sequence_number BIGINT,
    operation TEXT,
    data JSONB,
    previous_hash TEXT
)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(
        digest(
            sequence_number::TEXT || operation || data::TEXT || previous_hash,
            'sha256'
        ),
        'hex'
    );
END;
$$ LANGUAGE plpgsql;
```

---

## 3. å“ˆå¸Œé“¾æœºåˆ¶

### 3.1 æ’å…¥å®¡è®¡è®°å½•

```sql
-- æ’å…¥å®¡è®¡è®°å½•å‡½æ•°
CREATE OR REPLACE FUNCTION insert_audit_log(
    p_operation TEXT,
    p_table_name TEXT,
    p_record_id BIGINT,
    p_old_data JSONB,
    p_new_data JSONB,
    p_user_id TEXT
)
RETURNS void AS $$
DECLARE
    v_sequence_number BIGINT;
    v_previous_hash TEXT;
    v_current_hash TEXT;
BEGIN
    -- è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
    SELECT COALESCE(MAX(sequence_number), 0) + 1 INTO v_sequence_number
    FROM user_data_ledger;

    -- è·å–å‰ä¸€ä¸ªå“ˆå¸Œ
    SELECT current_hash INTO v_previous_hash
    FROM user_data_ledger
    ORDER BY sequence_number DESC
    LIMIT 1;

    -- è®¡ç®—å½“å‰å“ˆå¸Œ
    v_current_hash := calculate_hash(
        v_sequence_number,
        p_operation,
        COALESCE(p_new_data, p_old_data),
        COALESCE(v_previous_hash, '')
    );

    -- æ’å…¥è®°å½•
    INSERT INTO user_data_ledger (
        sequence_number, operation, table_name, record_id,
        old_data, new_data, user_id, previous_hash, current_hash
    ) VALUES (
        v_sequence_number, p_operation, p_table_name, p_record_id,
        p_old_data, p_new_data, p_user_id, v_previous_hash, v_current_hash
    );
END;
$$ LANGUAGE plpgsql;
```

---

## 4. å®Œæ•´æ€§éªŒè¯

### 4.1 éªŒè¯å‡½æ•°

```sql
-- éªŒè¯å®Œæ•´æ€§å‡½æ•°
CREATE OR REPLACE FUNCTION verify_audit_integrity()
RETURNS TABLE (
    is_valid BOOLEAN,
    invalid_records BIGINT[]
) AS $$
DECLARE
    record RECORD;
    calculated_hash TEXT;
    invalid_ids BIGINT[] := ARRAY[]::BIGINT[];
BEGIN
    FOR record IN
        SELECT * FROM user_data_ledger ORDER BY sequence_number
    LOOP
        calculated_hash := calculate_hash(
            record.sequence_number,
            record.operation,
            COALESCE(record.new_data, record.old_data),
            record.previous_hash
        );

        IF calculated_hash != record.current_hash THEN
            invalid_ids := array_append(invalid_ids, record.id);
        END IF;
    END LOOP;

    RETURN QUERY
    SELECT
        (array_length(invalid_ids, 1) IS NULL) as is_valid,
        invalid_ids;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. æœ€ä½³å®è·µ

1. **å®šæœŸéªŒè¯**: å®šæœŸéªŒè¯å®¡è®¡æ—¥å¿—å®Œæ•´æ€§
2. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½å®¡è®¡æ—¥å¿—
3. **è®¿é—®æ§åˆ¶**: é™åˆ¶å®¡è®¡æ—¥å¿—çš„è®¿é—®æƒé™

---

## 6. å‚è€ƒèµ„æ–™

- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)
- [åŠ¨æ€æ•°æ®è„±æ•](./åŠ¨æ€æ•°æ®è„±æ•.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
