# ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 05-04-01

## ğŸ“‘ ç›®å½•

- [ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—](#ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. å®¡è®¡æ—¥å¿—è®¾è®¡](#2-å®¡è®¡æ—¥å¿—è®¾è®¡)
    - [2.1 æ—¥å¿—ç»“æ„](#21-æ—¥å¿—ç»“æ„)
    - [2.2 å“ˆå¸Œé“¾è®¾è®¡](#22-å“ˆå¸Œé“¾è®¾è®¡)
  - [3. ä¸å¯ç¯¡æ”¹æœºåˆ¶](#3-ä¸å¯ç¯¡æ”¹æœºåˆ¶)
    - [3.1 å“ˆå¸Œè®¡ç®—](#31-å“ˆå¸Œè®¡ç®—)
    - [3.2 å®Œæ•´æ€§éªŒè¯](#32-å®Œæ•´æ€§éªŒè¯)
  - [4. å®è·µæ¡ˆä¾‹](#4-å®è·µæ¡ˆä¾‹)
    - [4.1 ä¼ä¸šå®¡è®¡æ—¥å¿—ç³»ç»Ÿ](#41-ä¼ä¸šå®¡è®¡æ—¥å¿—ç³»ç»Ÿ)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—éœ€è¦ï¼š

- **å®Œæ•´æ€§**: ä¿è¯å®¡è®¡æ—¥å¿—ä¸è¢«ç¯¡æ”¹
- **å¯è¿½æº¯**: è¿½æº¯æ‰€æœ‰æ•°æ®æ“ä½œ
- **åˆè§„è¦æ±‚**: æ»¡è¶³å®¡è®¡åˆè§„è¦æ±‚
- **æ€§èƒ½**: ä¸å½±å“æ•°æ®åº“æ€§èƒ½

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å“ˆå¸Œé“¾**: ä½¿ç”¨å“ˆå¸Œé“¾ä¿è¯å®Œæ•´æ€§
- **è§¦å‘å™¨**: è‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—
- **åŒºå—é“¾**: å¯é€‰åŒºå—é“¾å­˜å‚¨

### 1.2 æ ¸å¿ƒä»·å€¼

- **å®Œæ•´æ€§**: 100% ä¿è¯æ—¥å¿—ä¸è¢«ç¯¡æ”¹
- **å¯è¿½æº¯æ€§**: å®Œæ•´çš„æ“ä½œå†å²
- **åˆè§„æ€§**: æ»¡è¶³å®¡è®¡åˆè§„è¦æ±‚

## 2. å®¡è®¡æ—¥å¿—è®¾è®¡

### 2.1 æ—¥å¿—ç»“æ„

```sql
-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    operation_type TEXT NOT NULL,  -- 'INSERT', 'UPDATE', 'DELETE', 'SELECT'
    row_id INTEGER,
    old_data JSONB,
    new_data JSONB,
    user_id TEXT NOT NULL,
    ip_address INET,
    timestamp TIMESTAMP DEFAULT NOW(),
    previous_hash TEXT,
    current_hash TEXT,
    hash_chain_index INTEGER
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON audit_logs (table_name, operation_type, timestamp);
CREATE INDEX ON audit_logs (user_id, timestamp);
CREATE INDEX ON audit_logs (hash_chain_index);
```

### 2.2 å“ˆå¸Œé“¾è®¾è®¡

```sql
-- å“ˆå¸Œé“¾è¡¨
CREATE TABLE hash_chain (
    id SERIAL PRIMARY KEY,
    chain_index INTEGER UNIQUE NOT NULL,
    log_id INTEGER REFERENCES audit_logs(id),
    previous_hash TEXT,
    current_hash TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºå‡½æ•°è®¡ç®—å“ˆå¸Œ
CREATE OR REPLACE FUNCTION calculate_hash(
    log_data JSONB,
    previous_hash TEXT
)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(
        digest(
            COALESCE(previous_hash, '') || log_data::TEXT,
            'sha256'
        ),
        'hex'
    );
END;
$$ LANGUAGE plpgsql;
```

## 3. ä¸å¯ç¯¡æ”¹æœºåˆ¶

### 3.1 å“ˆå¸Œè®¡ç®—

```sql
-- å®¡è®¡æ—¥å¿—è§¦å‘å™¨
CREATE OR REPLACE FUNCTION audit_log_trigger()
RETURNS TRIGGER AS $$
DECLARE
    log_id INTEGER;
    log_data JSONB;
    previous_hash TEXT;
    current_hash TEXT;
    chain_index INTEGER;
BEGIN
    -- æ„å»ºæ—¥å¿—æ•°æ®
    log_data := jsonb_build_object(
        'table_name', TG_TABLE_NAME,
        'operation_type', TG_OP,
        'row_id', COALESCE(NEW.id, OLD.id),
        'old_data', row_to_json(OLD)::jsonb,
        'new_data', row_to_json(NEW)::jsonb,
        'user_id', current_user,
        'timestamp', NOW()
    );

    -- è·å–ä¸Šä¸€ä¸ªå“ˆå¸Œ
    SELECT current_hash INTO previous_hash
    FROM hash_chain
    ORDER BY chain_index DESC
    LIMIT 1;

    -- è®¡ç®—å½“å‰å“ˆå¸Œ
    current_hash := calculate_hash(log_data, previous_hash);

    -- è·å–é“¾ç´¢å¼•
    SELECT COALESCE(MAX(chain_index), 0) + 1 INTO chain_index
    FROM hash_chain;

    -- æ’å…¥å®¡è®¡æ—¥å¿—
    INSERT INTO audit_logs (
        table_name,
        operation_type,
        row_id,
        old_data,
        new_data,
        user_id,
        previous_hash,
        current_hash,
        hash_chain_index
    ) VALUES (
        TG_TABLE_NAME,
        TG_OP,
        COALESCE(NEW.id, OLD.id),
        row_to_json(OLD)::jsonb,
        row_to_json(NEW)::jsonb,
        current_user,
        previous_hash,
        current_hash,
        chain_index
    ) RETURNING id INTO log_id;

    -- æ’å…¥å“ˆå¸Œé“¾
    INSERT INTO hash_chain (
        chain_index,
        log_id,
        previous_hash,
        current_hash
    ) VALUES (
        chain_index,
        log_id,
        previous_hash,
        current_hash
    );

    IF TG_OP = 'DELETE' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER audit_log_trigger
    AFTER INSERT OR UPDATE OR DELETE ON customer_data
    FOR EACH ROW
    EXECUTE FUNCTION audit_log_trigger();
```

### 3.2 å®Œæ•´æ€§éªŒè¯

```sql
-- å®Œæ•´æ€§éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION verify_audit_integrity()
RETURNS TABLE (
    chain_index INTEGER,
    is_valid BOOLEAN,
    error_message TEXT
) AS $$
DECLARE
    rec RECORD;
    calculated_hash TEXT;
    expected_hash TEXT;
BEGIN
    FOR rec IN
        SELECT
            hc.chain_index,
            hc.previous_hash,
            hc.current_hash,
            al.table_name,
            al.operation_type,
            al.row_id,
            al.old_data,
            al.new_data,
            al.user_id,
            al.timestamp
        FROM hash_chain hc
        JOIN audit_logs al ON hc.log_id = al.id
        ORDER BY hc.chain_index
    LOOP
        -- è®¡ç®—æœŸæœ›çš„å“ˆå¸Œ
        calculated_hash := calculate_hash(
            jsonb_build_object(
                'table_name', rec.table_name,
                'operation_type', rec.operation_type,
                'row_id', rec.row_id,
                'old_data', rec.old_data,
                'new_data', rec.new_data,
                'user_id', rec.user_id,
                'timestamp', rec.timestamp
            ),
            rec.previous_hash
        );

        -- éªŒè¯å“ˆå¸Œ
        IF calculated_hash != rec.current_hash THEN
            RETURN QUERY SELECT
                rec.chain_index,
                FALSE,
                format('Hash mismatch at index %s', rec.chain_index);
        ELSE
            RETURN QUERY SELECT
                rec.chain_index,
                TRUE,
                NULL::TEXT;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

## 4. å®è·µæ¡ˆä¾‹

### 4.1 ä¼ä¸šå®¡è®¡æ—¥å¿—ç³»ç»Ÿ

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸä¼ä¸šå®¡è®¡ç³»ç»Ÿï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **æ•°æ®è§„æ¨¡**: 1000 ä¸‡æ¡å®¡è®¡è®°å½•
- **éœ€æ±‚**: ä¸å¯ç¯¡æ”¹çš„å®¡è®¡æ—¥å¿—

**å®ç°æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
-- (å·²åœ¨ä¸Šé¢åˆ›å»º)

-- 2. åˆ›å»ºè§¦å‘å™¨
-- (å·²åœ¨ä¸Šé¢åˆ›å»º)

-- 3. æµ‹è¯•å®¡è®¡æ—¥å¿—
INSERT INTO customer_data (name, email)
VALUES ('John Doe', 'john@example.com');

-- 4. æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM audit_logs
ORDER BY timestamp DESC
LIMIT 10;

-- 5. éªŒè¯å®Œæ•´æ€§
SELECT * FROM verify_audit_integrity()
WHERE is_valid = FALSE;

-- 6. æŸ¥çœ‹å“ˆå¸Œé“¾
SELECT * FROM hash_chain
ORDER BY chain_index DESC
LIMIT 10;
```

**æ•ˆæœ**:

- **å®Œæ•´æ€§**: 100% ä¿è¯æ—¥å¿—ä¸è¢«ç¯¡æ”¹
- **å¯è¿½æº¯æ€§**: å®Œæ•´çš„æ“ä½œå†å²
- **åˆè§„æ€§**: æ»¡è¶³å®¡è®¡åˆè§„è¦æ±‚

## 5. å‚è€ƒèµ„æ–™

- [åŠ¨æ€æ•°æ®è„±æ•](./åŠ¨æ€æ•°æ®è„±æ•.md)
- [ç»†ç²’åº¦æƒé™æ§åˆ¶](./ç»†ç²’åº¦æƒé™æ§åˆ¶.md)
- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 05-04-01
