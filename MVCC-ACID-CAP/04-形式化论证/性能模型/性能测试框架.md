# æ€§èƒ½æµ‹è¯•æ¡†æ¶

> **æ–‡æ¡£ç¼–å·**: PERF-TEST-FRAMEWORK-001
> **ä¸»é¢˜**: Ruståº”ç”¨ä¸PostgreSQL MVCCæ€§èƒ½æµ‹è¯•æ¡†æ¶
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **ç›¸å…³æ–‡æ¡£**:
>
> - [æ·±åº¦æ€§èƒ½å¯¹æ¯”åˆ†æ](æ·±åº¦æ€§èƒ½å¯¹æ¯”åˆ†æ.md)
> - [Rustæ€§èƒ½ä¼˜åŒ–æŠ€å·§](Rustæ€§èƒ½ä¼˜åŒ–æŠ€å·§.md)
> - [æ··åˆç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–](æ··åˆç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–.md)

---

## ğŸ“‘ ç›®å½•

- [æ€§èƒ½æµ‹è¯•æ¡†æ¶](#æ€§èƒ½æµ‹è¯•æ¡†æ¶)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ§ª ç¬¬ä¸€éƒ¨åˆ†ï¼šæµ‹è¯•æ¡†æ¶è®¾è®¡](#-ç¬¬ä¸€éƒ¨åˆ†æµ‹è¯•æ¡†æ¶è®¾è®¡)
    - [1.1 æµ‹è¯•æ¶æ„](#11-æµ‹è¯•æ¶æ„)
      - [1.1.1 æ¶æ„è®¾è®¡](#111-æ¶æ„è®¾è®¡)
    - [1.2 æµ‹è¯•å·¥å…·](#12-æµ‹è¯•å·¥å…·)
      - [1.2.1 å·¥å…·é€‰æ‹©](#121-å·¥å…·é€‰æ‹©)
    - [1.3 æµ‹è¯•ç¯å¢ƒ](#13-æµ‹è¯•ç¯å¢ƒ)
      - [1.3.1 ç¯å¢ƒé…ç½®](#131-ç¯å¢ƒé…ç½®)
  - [ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCæ€§èƒ½æµ‹è¯•](#-ç¬¬äºŒéƒ¨åˆ†mvccæ€§èƒ½æµ‹è¯•)
    - [2.1 äº‹åŠ¡æ€§èƒ½æµ‹è¯•](#21-äº‹åŠ¡æ€§èƒ½æµ‹è¯•)
      - [2.1.1 äº‹åŠ¡æµ‹è¯•](#211-äº‹åŠ¡æµ‹è¯•)
    - [2.2 å¹¶å‘æ€§èƒ½æµ‹è¯•](#22-å¹¶å‘æ€§èƒ½æµ‹è¯•)
      - [2.2.1 å¹¶å‘æµ‹è¯•](#221-å¹¶å‘æµ‹è¯•)
    - [2.3 å¿«ç…§æ€§èƒ½æµ‹è¯•](#23-å¿«ç…§æ€§èƒ½æµ‹è¯•)
      - [2.3.1 å¿«ç…§æµ‹è¯•](#231-å¿«ç…§æµ‹è¯•)
  - [âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæµ‹è¯•ç”¨ä¾‹](#-ç¬¬ä¸‰éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹)
    - [3.1 è¯»æ€§èƒ½æµ‹è¯•](#31-è¯»æ€§èƒ½æµ‹è¯•)
      - [3.1.1 è¯»æµ‹è¯•ç”¨ä¾‹](#311-è¯»æµ‹è¯•ç”¨ä¾‹)
    - [3.2 å†™æ€§èƒ½æµ‹è¯•](#32-å†™æ€§èƒ½æµ‹è¯•)
      - [3.2.1 å†™æµ‹è¯•ç”¨ä¾‹](#321-å†™æµ‹è¯•ç”¨ä¾‹)
  - [ğŸ“ˆ ç¬¬å››éƒ¨åˆ†ï¼šç»“æœåˆ†æ](#-ç¬¬å››éƒ¨åˆ†ç»“æœåˆ†æ)
    - [4.1 æ€§èƒ½æŒ‡æ ‡](#41-æ€§èƒ½æŒ‡æ ‡)
      - [4.1.1 æŒ‡æ ‡å®šä¹‰](#411-æŒ‡æ ‡å®šä¹‰)
    - [4.2 ç»“æœåˆ†æ](#42-ç»“æœåˆ†æ)
      - [4.2.1 åˆ†ææ–¹æ³•](#421-åˆ†ææ–¹æ³•)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›Ruståº”ç”¨ä¸PostgreSQL MVCCæ€§èƒ½æµ‹è¯•æ¡†æ¶çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬æµ‹è¯•æ¡†æ¶è®¾è®¡ã€MVCCæ€§èƒ½æµ‹è¯•ã€æµ‹è¯•ç”¨ä¾‹å’Œç»“æœåˆ†æã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š

- æµ‹è¯•æ¡†æ¶è®¾è®¡ï¼ˆæµ‹è¯•æ¶æ„ã€æµ‹è¯•å·¥å…·ã€æµ‹è¯•ç¯å¢ƒï¼‰
- MVCCæ€§èƒ½æµ‹è¯•ï¼ˆäº‹åŠ¡æ€§èƒ½ã€å¹¶å‘æ€§èƒ½ã€å¿«ç…§æ€§èƒ½ï¼‰
- æµ‹è¯•ç”¨ä¾‹ï¼ˆè¯»æ€§èƒ½ã€å†™æ€§èƒ½ï¼‰
- ç»“æœåˆ†æï¼ˆæ€§èƒ½æŒ‡æ ‡ã€åˆ†ææ–¹æ³•ï¼‰

**ç›®æ ‡è¯»è€…**ï¼š

- æ€§èƒ½æµ‹è¯•å·¥ç¨‹å¸ˆ
- Rustå¼€å‘è€…
- æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å·¥ç¨‹å¸ˆ

---

## ğŸ§ª ç¬¬ä¸€éƒ¨åˆ†ï¼šæµ‹è¯•æ¡†æ¶è®¾è®¡

### 1.1 æµ‹è¯•æ¶æ„

#### 1.1.1 æ¶æ„è®¾è®¡

```rust
// æ€§èƒ½æµ‹è¯•æ¡†æ¶æ¶æ„ï¼š
// 1. æµ‹è¯•é©±åŠ¨å±‚ï¼šcriterionã€cargo bench
// 2. æ•°æ®ç”Ÿæˆå±‚ï¼šæµ‹è¯•æ•°æ®ç”Ÿæˆ
// 3. æ‰§è¡Œå±‚ï¼šæµ‹è¯•æ‰§è¡Œå’Œç›‘æ§
// 4. åˆ†æå±‚ï¼šç»“æœåˆ†æå’ŒæŠ¥å‘Š
```

### 1.2 æµ‹è¯•å·¥å…·

#### 1.2.1 å·¥å…·é€‰æ‹©

```rust
// Rustæ€§èƒ½æµ‹è¯•å·¥å…·ï¼š
// - criterion: åŸºå‡†æµ‹è¯•æ¡†æ¶
// - cargo bench: å†…ç½®åŸºå‡†æµ‹è¯•
// - tokio-metrics: å¼‚æ­¥è¿è¡Œæ—¶æŒ‡æ ‡

// PostgreSQLæ€§èƒ½æµ‹è¯•å·¥å…·ï¼š
// - pgbench: PostgreSQLåŸºå‡†æµ‹è¯•å·¥å…·
// - EXPLAIN ANALYZE: æŸ¥è¯¢è®¡åˆ’åˆ†æ
```

### 1.3 æµ‹è¯•ç¯å¢ƒ

#### 1.3.1 ç¯å¢ƒé…ç½®

```rust
// æµ‹è¯•ç¯å¢ƒé…ç½®ï¼š
// 1. éš”ç¦»çš„æµ‹è¯•æ•°æ®åº“
// 2. æ ‡å‡†åŒ–çš„ç¡¬ä»¶é…ç½®
// 3. ä¸€è‡´çš„æµ‹è¯•æ•°æ®
// 4. ç›‘æ§å·¥å…·é…ç½®
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCæ€§èƒ½æµ‹è¯•

### 2.1 äº‹åŠ¡æ€§èƒ½æµ‹è¯•

#### 2.1.1 äº‹åŠ¡æµ‹è¯•

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};
use sqlx::PgPool;

fn bench_transaction(c: &mut Criterion, pool: &PgPool) {
    c.bench_function("transaction_commit", |b| {
        b.to_async(tokio::runtime::Runtime::new().unwrap())
            .iter(|| async {
                let mut tx = pool.begin().await.unwrap();
                sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
                    .bind(1i32)
                    .bind("Test")
                    .execute(&mut *tx)
                    .await
                    .unwrap();
                tx.commit().await.unwrap();
            });
    });
}
```

### 2.2 å¹¶å‘æ€§èƒ½æµ‹è¯•

#### 2.2.1 å¹¶å‘æµ‹è¯•

```rust
use tokio::task;

async fn concurrent_read_test(pool: &PgPool, concurrency: usize) {
    let handles: Vec<_> = (0..concurrency)
        .map(|_| {
            let pool = pool.clone();
            task::spawn(async move {
                sqlx::query("SELECT * FROM users WHERE id = $1")
                    .bind(1i32)
                    .fetch_one(&pool)
                    .await
            })
        })
        .collect();

    for handle in handles {
        handle.await.unwrap();
    }
}
```

### 2.3 å¿«ç…§æ€§èƒ½æµ‹è¯•

#### 2.3.1 å¿«ç…§æµ‹è¯•

```rust
// MVCCå¿«ç…§æ€§èƒ½æµ‹è¯•ï¼š
// 1. å¿«ç…§è·å–æ—¶é—´
// 2. å¿«ç…§å¯è§æ€§åˆ¤æ–­æ—¶é—´
// 3. å¿«ç…§å†…å­˜å ç”¨
```

---

## âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæµ‹è¯•ç”¨ä¾‹

### 3.1 è¯»æ€§èƒ½æµ‹è¯•

#### 3.1.1 è¯»æµ‹è¯•ç”¨ä¾‹

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn bench_read_performance(c: &mut Criterion, pool: &PgPool) {
    c.bench_function("read_by_id", |b| {
        b.to_async(tokio::runtime::Runtime::new().unwrap())
            .iter(|| async {
                black_box(
                    sqlx::query("SELECT * FROM users WHERE id = $1")
                        .bind(1i32)
                        .fetch_one(pool)
                        .await
                )
            });
    });

    c.bench_function("read_range", |b| {
        b.to_async(tokio::runtime::Runtime::new().unwrap())
            .iter(|| async {
                black_box(
                    sqlx::query("SELECT * FROM users WHERE id BETWEEN $1 AND $2")
                        .bind(1i32)
                        .bind(100i32)
                        .fetch_all(pool)
                        .await
                )
            });
    });
}
```

### 3.2 å†™æ€§èƒ½æµ‹è¯•

#### 3.2.1 å†™æµ‹è¯•ç”¨ä¾‹

```rust
fn bench_write_performance(c: &mut Criterion, pool: &PgPool) {
    c.bench_function("write_single", |b| {
        b.to_async(tokio::runtime::Runtime::new().unwrap())
            .iter(|| async {
                let mut tx = pool.begin().await.unwrap();
                black_box(
                    sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
                        .bind(1i32)
                        .bind("Test")
                        .execute(&mut *tx)
                        .await
                );
                tx.commit().await.unwrap();
            });
    });

    c.bench_function("write_batch", |b| {
        b.to_async(tokio::runtime::Runtime::new().unwrap())
            .iter(|| async {
                let mut tx = pool.begin().await.unwrap();
                for i in 1..=100 {
                    sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
                        .bind(i)
                        .bind(format!("User{}", i))
                        .execute(&mut *tx)
                        .await
                        .unwrap();
                }
                tx.commit().await.unwrap();
            });
    });
}
```

---

## ğŸ“ˆ ç¬¬å››éƒ¨åˆ†ï¼šç»“æœåˆ†æ

### 4.1 æ€§èƒ½æŒ‡æ ‡

#### 4.1.1 æŒ‡æ ‡å®šä¹‰

```rust
// æ€§èƒ½æŒ‡æ ‡ï¼š
// 1. ååé‡ï¼ˆQPS/TPSï¼‰
// 2. å»¶è¿Ÿï¼ˆP50/P95/P99ï¼‰
// 3. å¹¶å‘åº¦
// 4. èµ„æºä½¿ç”¨ç‡ï¼ˆCPU/å†…å­˜/IOï¼‰
```

### 4.2 ç»“æœåˆ†æ

#### 4.2.1 åˆ†ææ–¹æ³•

```rust
// ç»“æœåˆ†ææ–¹æ³•ï¼š
// 1. ç»Ÿè®¡åˆ†æ
// 2. è¶‹åŠ¿åˆ†æ
// 3. å¯¹æ¯”åˆ†æ
// 4. ç“¶é¢ˆåˆ†æ
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†Ruståº”ç”¨ä¸PostgreSQL MVCCæ€§èƒ½æµ‹è¯•æ¡†æ¶çš„å®Œæ•´æŒ‡å—ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. **æµ‹è¯•æ¡†æ¶è®¾è®¡**ï¼š
   - æµ‹è¯•æ¶æ„ã€æµ‹è¯•å·¥å…·ã€æµ‹è¯•ç¯å¢ƒ

2. **MVCCæ€§èƒ½æµ‹è¯•**ï¼š
   - äº‹åŠ¡æ€§èƒ½ã€å¹¶å‘æ€§èƒ½ã€å¿«ç…§æ€§èƒ½

3. **æµ‹è¯•ç”¨ä¾‹**ï¼š
   - è¯»æ€§èƒ½æµ‹è¯•ã€å†™æ€§èƒ½æµ‹è¯•

4. **ç»“æœåˆ†æ**ï¼š
   - æ€§èƒ½æŒ‡æ ‡ã€åˆ†ææ–¹æ³•

**ä¸‹ä¸€æ­¥**ï¼š

- å®Œå–„æµ‹è¯•ç”¨ä¾‹
- æ·»åŠ æ›´å¤šæ€§èƒ½æµ‹è¯•åœºæ™¯
- å®Œå–„è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
