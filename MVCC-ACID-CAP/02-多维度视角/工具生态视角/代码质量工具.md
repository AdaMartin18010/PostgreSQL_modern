# ä»£ç è´¨é‡å·¥å…·

> **æ–‡æ¡£ç¼–å·**: TOOLS-CODE-QUALITY-001
> **ä¸»é¢˜**: Rustä»£ç è´¨é‡å·¥å…·ä¸PostgreSQL MVCCä»£ç è´¨é‡
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **ç›¸å…³æ–‡æ¡£**:
>
> - [Rustæµ‹è¯•å·¥å…·ä¸MVCC](Rustæµ‹è¯•å·¥å…·ä¸MVCC.md)
> - [CI/CDé›†æˆ](CI-CDé›†æˆ.md)
> - [Ruståº”ç”¨æ•…éšœè¯Šæ–­](../è¿ç»´è§†è§’/Ruståº”ç”¨æ•…éšœè¯Šæ–­.md)

---

## ğŸ“‘ ç›®å½•

- [ä»£ç è´¨é‡å·¥å…·](#ä»£ç è´¨é‡å·¥å…·)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç è´¨é‡å·¥å…·](#-ç¬¬ä¸€éƒ¨åˆ†ä»£ç è´¨é‡å·¥å…·)
    - [1.1 Clippy](#11-clippy)
      - [1.1.1 Clippyä½¿ç”¨](#111-clippyä½¿ç”¨)
    - [1.2 rustfmt](#12-rustfmt)
      - [1.2.1 rustfmtä½¿ç”¨](#121-rustfmtä½¿ç”¨)
    - [1.3 rust-analyzer](#13-rust-analyzer)
      - [1.3.1 rust-analyzerä½¿ç”¨](#131-rust-analyzerä½¿ç”¨)
  - [ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCä»£ç è´¨é‡](#-ç¬¬äºŒéƒ¨åˆ†mvccä»£ç è´¨é‡)
    - [2.1 äº‹åŠ¡ä»£ç è´¨é‡](#21-äº‹åŠ¡ä»£ç è´¨é‡)
      - [2.1.1 äº‹åŠ¡ä»£ç æ£€æŸ¥](#211-äº‹åŠ¡ä»£ç æ£€æŸ¥)
    - [2.2 å¹¶å‘ä»£ç è´¨é‡](#22-å¹¶å‘ä»£ç è´¨é‡)
      - [2.2.1 å¹¶å‘ä»£ç æ£€æŸ¥](#221-å¹¶å‘ä»£ç æ£€æŸ¥)
  - [âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè´¨é‡æ£€æŸ¥é›†æˆ](#-ç¬¬ä¸‰éƒ¨åˆ†è´¨é‡æ£€æŸ¥é›†æˆ)
    - [3.1 CIé›†æˆ](#31-cié›†æˆ)
      - [3.1.1 CIé…ç½®](#311-cié…ç½®)
    - [3.2 é¢„æäº¤é’©å­](#32-é¢„æäº¤é’©å­)
      - [3.2.1 é’©å­é…ç½®](#321-é’©å­é…ç½®)
  - [ğŸ¯ ç¬¬å››éƒ¨åˆ†ï¼šæœ€ä½³å®è·µ](#-ç¬¬å››éƒ¨åˆ†æœ€ä½³å®è·µ)
    - [4.1 è´¨é‡ç­–ç•¥](#41-è´¨é‡ç­–ç•¥)
      - [4.1.1 ç­–ç•¥é€‰æ‹©](#411-ç­–ç•¥é€‰æ‹©)
    - [4.2 æŒç»­æ”¹è¿›](#42-æŒç»­æ”¹è¿›)
      - [4.2.1 æ”¹è¿›æ–¹æ³•](#421-æ”¹è¿›æ–¹æ³•)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Rustä»£ç è´¨é‡å·¥å…·åœ¨PostgreSQL MVCCä»£ç è´¨é‡ä¿è¯ä¸­çš„åº”ç”¨ï¼ŒåŒ…æ‹¬ä»£ç è´¨é‡å·¥å…·ã€MVCCä»£ç è´¨é‡æ£€æŸ¥å’Œæœ€ä½³å®è·µã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š

- ä»£ç è´¨é‡å·¥å…·ï¼ˆClippyã€rustfmtã€rust-analyzerï¼‰
- MVCCä»£ç è´¨é‡ï¼ˆäº‹åŠ¡ä»£ç è´¨é‡ã€å¹¶å‘ä»£ç è´¨é‡ï¼‰
- è´¨é‡æ£€æŸ¥é›†æˆï¼ˆCIé›†æˆã€é¢„æäº¤é’©å­ï¼‰
- æœ€ä½³å®è·µï¼ˆè´¨é‡ç­–ç•¥ã€æŒç»­æ”¹è¿›ï¼‰

**ç›®æ ‡è¯»è€…**ï¼š

- Rustå¼€å‘è€…
- ä»£ç å®¡æŸ¥äººå‘˜
- è´¨é‡ä¿è¯å·¥ç¨‹å¸ˆ

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç è´¨é‡å·¥å…·

### 1.1 Clippy

#### 1.1.1 Clippyä½¿ç”¨

```bash
# è¿è¡ŒClippyæ£€æŸ¥
cargo clippy

# è¿è¡ŒClippyå¹¶è‡ªåŠ¨ä¿®å¤
cargo clippy --fix

# è¿è¡ŒClippyå¹¶æ˜¾ç¤ºæ‰€æœ‰è­¦å‘Š
cargo clippy -- -W clippy::all
```

### 1.2 rustfmt

#### 1.2.1 rustfmtä½¿ç”¨

```bash
# æ ¼å¼åŒ–ä»£ç 
cargo fmt

# æ£€æŸ¥æ ¼å¼åŒ–
cargo fmt --check
```

### 1.3 rust-analyzer

#### 1.3.1 rust-analyzerä½¿ç”¨

```json
// VS Codeé…ç½®
{
    "rust-analyzer.checkOnSave.command": "clippy",
    "rust-analyzer.checkOnSave.allTargets": true
}
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCä»£ç è´¨é‡

### 2.1 äº‹åŠ¡ä»£ç è´¨é‡

#### 2.1.1 äº‹åŠ¡ä»£ç æ£€æŸ¥

```rust
use sqlx::PgPool;

// âœ… å¥½çš„å®è·µï¼šä½¿ç”¨äº‹åŠ¡
async fn good_transaction(pool: &PgPool) -> Result<(), sqlx::Error> {
    let mut tx = pool.begin().await?;
    sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
        .bind(1i32)
        .bind("Alice")
        .execute(&mut *tx)
        .await?;
    tx.commit().await?;
    Ok(())
}

// âŒ ä¸å¥½çš„å®è·µï¼šä¸ä½¿ç”¨äº‹åŠ¡
async fn bad_transaction(pool: &PgPool) -> Result<(), sqlx::Error> {
    sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
        .bind(1i32)
        .bind("Alice")
        .execute(pool)
        .await?;
    Ok(())
}
```

### 2.2 å¹¶å‘ä»£ç è´¨é‡

#### 2.2.1 å¹¶å‘ä»£ç æ£€æŸ¥

```rust
use sqlx::PgPool;

// âœ… å¥½çš„å®è·µï¼šä½¿ç”¨MVCCæ— é”è¯»
async fn good_concurrent(pool: &PgPool) -> Result<(), sqlx::Error> {
    let user = sqlx::query("SELECT * FROM users WHERE id = $1")
        .bind(1i32)
        .fetch_one(pool)
        .await?;
    Ok(())
}

// âŒ ä¸å¥½çš„å®è·µï¼šä¸å¿…è¦çš„é”
async fn bad_concurrent(pool: &PgPool) -> Result<(), sqlx::Error> {
    let mut tx = pool.begin().await?;
    sqlx::query("SELECT * FROM users WHERE id = $1 FOR UPDATE")
        .bind(1i32)
        .fetch_one(&mut *tx)
        .await?;
    tx.commit().await?;
    Ok(())
}
```

---

## âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè´¨é‡æ£€æŸ¥é›†æˆ

### 3.1 CIé›†æˆ

#### 3.1.1 CIé…ç½®

```yaml
# .github/workflows/quality.yml
name: Code Quality

on: [push, pull_request]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Run Clippy
        run: cargo clippy -- -D warnings
      - name: Run rustfmt
        run: cargo fmt --check
```

### 3.2 é¢„æäº¤é’©å­

#### 3.2.1 é’©å­é…ç½®

```bash
#!/bin/bash
# .git/hooks/pre-commit

cargo fmt --check || exit 1
cargo clippy -- -D warnings || exit 1
cargo test || exit 1
```

---

## ğŸ¯ ç¬¬å››éƒ¨åˆ†ï¼šæœ€ä½³å®è·µ

### 4.1 è´¨é‡ç­–ç•¥

#### 4.1.1 ç­–ç•¥é€‰æ‹©

```rust
// ä»£ç è´¨é‡ç­–ç•¥ï¼š
// 1. ä½¿ç”¨Clippyæ£€æŸ¥ä»£ç 
// 2. ä½¿ç”¨rustfmtæ ¼å¼åŒ–ä»£ç 
// 3. åœ¨CIä¸­è¿è¡Œè´¨é‡æ£€æŸ¥
// 4. ä½¿ç”¨é¢„æäº¤é’©å­
```

### 4.2 æŒç»­æ”¹è¿›

#### 4.2.1 æ”¹è¿›æ–¹æ³•

```rust
// æŒç»­æ”¹è¿›æ–¹æ³•ï¼š
// 1. å®šæœŸè¿è¡Œè´¨é‡æ£€æŸ¥
// 2. ä¿®å¤è´¨é‡é—®é¢˜
// 3. æ›´æ–°è´¨é‡è§„åˆ™
// 4. å›¢é˜Ÿä»£ç å®¡æŸ¥
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†Rustä»£ç è´¨é‡å·¥å…·åœ¨PostgreSQL MVCCä»£ç è´¨é‡ä¿è¯ä¸­çš„åº”ç”¨ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. **ä»£ç è´¨é‡å·¥å…·**ï¼š
   - Clippyã€rustfmtã€rust-analyzer

2. **MVCCä»£ç è´¨é‡**ï¼š
   - äº‹åŠ¡ä»£ç è´¨é‡ã€å¹¶å‘ä»£ç è´¨é‡

3. **è´¨é‡æ£€æŸ¥é›†æˆ**ï¼š
   - CIé›†æˆã€é¢„æäº¤é’©å­

4. **æœ€ä½³å®è·µ**ï¼š
   - è´¨é‡ç­–ç•¥ã€æŒç»­æ”¹è¿›

**ä¸‹ä¸€æ­¥**ï¼š

- å®Œå–„è´¨é‡æ£€æŸ¥æ¡ˆä¾‹
- æ·»åŠ æ›´å¤šè´¨é‡è§„åˆ™
- å®Œå–„è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥æµç¨‹

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
