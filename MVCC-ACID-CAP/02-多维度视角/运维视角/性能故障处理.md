# PostgreSQLæ€§èƒ½æ•…éšœå¤„ç†

> **æ–‡æ¡£ç¼–å·**: OPS-TROUBLESHOOTING-PERFORMANCE-001
> **ä¸»é¢˜**: æ€§èƒ½æ•…éšœå¤„ç†
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ðŸ“‘ ç›®å½•

- [PostgreSQLæ€§èƒ½æ•…éšœå¤„ç†](#postgresqlæ€§èƒ½æ•…éšœå¤„ç†)
  - [ðŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ðŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ðŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€§èƒ½ä¸‹é™è¯Šæ–­](#-ç¬¬ä¸€éƒ¨åˆ†æ€§èƒ½ä¸‹é™è¯Šæ–­)
    - [1.1 æŸ¥è¯¢æ€§èƒ½ä¸‹é™](#11-æŸ¥è¯¢æ€§èƒ½ä¸‹é™)
    - [1.2 å†™å…¥æ€§èƒ½ä¸‹é™](#12-å†™å…¥æ€§èƒ½ä¸‹é™)
    - [1.3 VACUUMæ€§èƒ½é—®é¢˜](#13-vacuumæ€§èƒ½é—®é¢˜)
  - [ðŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–](#-ç¬¬äºŒéƒ¨åˆ†æ€§èƒ½ä¼˜åŒ–)
    - [2.1 æŸ¥è¯¢ä¼˜åŒ–](#21-æŸ¥è¯¢ä¼˜åŒ–)
    - [2.2 ç´¢å¼•ä¼˜åŒ–](#22-ç´¢å¼•ä¼˜åŒ–)
    - [2.3 é…ç½®ä¼˜åŒ–](#23-é…ç½®ä¼˜åŒ–)
  - [ðŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ€§èƒ½ç›‘æŽ§](#-ç¬¬ä¸‰éƒ¨åˆ†æ€§èƒ½ç›‘æŽ§)
    - [3.1 æ€§èƒ½åŸºçº¿](#31-æ€§èƒ½åŸºçº¿)
    - [3.2 æ€§èƒ½æŒ‡æ ‡](#32-æ€§èƒ½æŒ‡æ ‡)
    - [3.3 æ€§èƒ½å‘Šè­¦](#33-æ€§èƒ½å‘Šè­¦)
  - [ðŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒæœºåˆ¶](#æ ¸å¿ƒæœºåˆ¶)
    - [MVCCå½±å“](#mvccå½±å“)
    - [æœ€ä½³å®žè·µ](#æœ€ä½³å®žè·µ)

---

## ðŸ“‹ æ¦‚è¿°

æ€§èƒ½æ•…éšœå¤„ç†æ˜¯PostgreSQLè¿ç»´çš„é‡è¦æŠ€èƒ½ï¼ŒåŒ…æ‹¬æ€§èƒ½ä¸‹é™è¯Šæ–­ã€æ€§èƒ½ä¼˜åŒ–å’Œæ€§èƒ½ç›‘æŽ§ã€‚æœ¬æ–‡æ¡£æ·±å…¥åˆ†æžæ€§èƒ½æ•…éšœçš„å¤„ç†æ–¹æ³•ï¼Œç‰¹åˆ«å…³æ³¨MVCCå¯¹æ€§èƒ½çš„å½±å“ã€‚

---

## ðŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€§èƒ½ä¸‹é™è¯Šæ–­

### 1.1 æŸ¥è¯¢æ€§èƒ½ä¸‹é™

```sql
-- æŸ¥è¯¢æ€§èƒ½ä¸‹é™è¯Šæ–­
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM metrics WHERE time BETWEEN ...;

-- 3. æ£€æŸ¥MVCCçŠ¶æ€
SELECT
    relname,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
WHERE relname = 'metrics';
```

### 1.2 å†™å…¥æ€§èƒ½ä¸‹é™

```sql
-- å†™å…¥æ€§èƒ½ä¸‹é™è¯Šæ–­
-- 1. æ£€æŸ¥å†™å…¥ç»Ÿè®¡
SELECT
    relname,
    n_tup_ins,
    n_tup_upd,
    n_tup_hot_upd,
    round(n_tup_hot_upd * 100.0 / NULLIF(n_tup_upd, 0), 2) AS hot_ratio
FROM pg_stat_user_tables
WHERE relname = 'metrics';

-- 2. æ£€æŸ¥WALç”Ÿæˆ
SELECT pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0')) AS total_wal;

-- 3. æ£€æŸ¥é”ç­‰å¾…
SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event IS NOT NULL;
```

### 1.3 VACUUMæ€§èƒ½é—®é¢˜

```sql
-- VACUUMæ€§èƒ½é—®é¢˜è¯Šæ–­
-- 1. æ£€æŸ¥VACUUMè¿›åº¦
SELECT
    pid,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed
FROM pg_stat_progress_vacuum;

-- 2. æ£€æŸ¥æ­»äº¡å…ƒç»„
SELECT
    relname,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

---

## ðŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–

### 2.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æŸ¥è¯¢ä¼˜åŒ–
-- 1. ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM metrics WHERE time BETWEEN ...;

-- 2. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_metrics_time ON metrics (time);

-- 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE metrics;
```

### 2.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- ç´¢å¼•ä¼˜åŒ–
-- 1. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan;

-- 2. åˆ é™¤æœªä½¿ç”¨ç´¢å¼•
DROP INDEX IF EXISTS unused_index;

-- 3. åˆ›å»ºéƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_metrics_recent ON metrics (time)
WHERE time > NOW() - INTERVAL '7 days';
```

### 2.3 é…ç½®ä¼˜åŒ–

```sql
-- é…ç½®ä¼˜åŒ–
-- 1. ä¼˜åŒ–shared_buffers
ALTER SYSTEM SET shared_buffers = '256MB';

-- 2. ä¼˜åŒ–work_mem
ALTER SYSTEM SET work_mem = '16MB';

-- 3. ä¼˜åŒ–autovacuum
ALTER TABLE metrics SET (
    autovacuum_vacuum_scale_factor = 0.05,
    autovacuum_analyze_scale_factor = 0.02
);
```

---

## ðŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ€§èƒ½ç›‘æŽ§

### 3.1 æ€§èƒ½åŸºçº¿

```sql
-- æ€§èƒ½åŸºçº¿å»ºç«‹
-- 1. è®°å½•æ€§èƒ½æŒ‡æ ‡
CREATE TABLE performance_baseline (
    metric_name TEXT,
    metric_value NUMERIC,
    recorded_at TIMESTAMP DEFAULT NOW()
);

-- 2. å®šæœŸè®°å½•
INSERT INTO performance_baseline (metric_name, metric_value)
SELECT 'query_time', mean_exec_time FROM pg_stat_statements WHERE query = '...';
```

### 3.2 æ€§èƒ½æŒ‡æ ‡

```text
æ€§èƒ½æŒ‡æ ‡ç›‘æŽ§ï¼š

1. æŸ¥è¯¢æ€§èƒ½ï¼š
   - å¹³å‡æŸ¥è¯¢æ—¶é—´
   - æœ€å¤§æŸ¥è¯¢æ—¶é—´
   - æ…¢æŸ¥è¯¢æ•°é‡

2. å†™å…¥æ€§èƒ½ï¼š
   - INSERTæ€§èƒ½
   - UPDATEæ€§èƒ½
   - HOTæ›´æ–°çŽ‡

3. MVCCæ€§èƒ½ï¼š
   - æ­»äº¡å…ƒç»„æ¯”ä¾‹
   - VACUUMé¢‘çŽ‡
   - ç‰ˆæœ¬é“¾é•¿åº¦
```

### 3.3 æ€§èƒ½å‘Šè­¦

```text
æ€§èƒ½å‘Šè­¦é…ç½®ï¼š

1. å‘Šè­¦é˜ˆå€¼ï¼š
   - æŸ¥è¯¢æ—¶é—´ > 1ç§’ï¼šè­¦å‘Š
   - æ­»äº¡å…ƒç»„æ¯”ä¾‹ > 20%ï¼šè­¦å‘Š
   - HOTæ›´æ–°çŽ‡ < 50%ï¼šè­¦å‘Š

2. å‘Šè­¦å¤„ç†ï¼š
   - ç«‹å³å“åº”
   - å¿«é€Ÿè¯Šæ–­
   - åŠæ—¶ä¼˜åŒ–
```

---

## ðŸ“ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

1. **æ€§èƒ½è¯Šæ–­**: æŸ¥è¯¢æ€§èƒ½ã€å†™å…¥æ€§èƒ½ã€VACUUMæ€§èƒ½
2. **æ€§èƒ½ä¼˜åŒ–**: æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–ã€é…ç½®ä¼˜åŒ–
3. **æ€§èƒ½ç›‘æŽ§**: æ€§èƒ½åŸºçº¿ã€æ€§èƒ½æŒ‡æ ‡ã€æ€§èƒ½å‘Šè­¦

### MVCCå½±å“

- **æŸ¥è¯¢æ€§èƒ½**: ç‰ˆæœ¬é“¾è¿‡é•¿å½±å“æŸ¥è¯¢æ€§èƒ½
- **å†™å…¥æ€§èƒ½**: HOTæ›´æ–°çŽ‡ä½Žå½±å“å†™å…¥æ€§èƒ½
- **VACUUMæ€§èƒ½**: æ­»äº¡å…ƒç»„ç§¯ç´¯å½±å“VACUUMæ€§èƒ½

### æœ€ä½³å®žè·µ

1. **æ€§èƒ½è¯Šæ–­**: ç³»ç»ŸåŒ–è¯Šæ–­ã€å¿«é€Ÿå®šä½ã€å‡†ç¡®è¯„ä¼°
2. **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹æ€§ä¼˜åŒ–ã€æŒç»­æ”¹è¿›ã€æ•ˆæžœéªŒè¯
3. **æ€§èƒ½ç›‘æŽ§**: å»ºç«‹åŸºçº¿ã€æŒç»­ç›‘æŽ§ã€åŠæ—¶å‘Šè­¦

PostgreSQLæ€§èƒ½æ•…éšœå¤„ç†é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿè¯Šæ–­å’Œä¼˜åŒ–æ€§èƒ½é—®é¢˜ï¼Œä¿è¯æ•°æ®åº“é«˜æ€§èƒ½è¿è¡Œã€‚
