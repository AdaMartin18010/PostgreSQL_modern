# é…ç½®ç®¡ç†

> **æ–‡æ¡£ç¼–å·**: OPS-CONFIG-MANAGEMENT-001
> **ä¸»é¢˜**: Ruståº”ç”¨é…ç½®ç®¡ç†ä¸PostgreSQL MVCC
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **ç›¸å…³æ–‡æ¡£**:
>
> - [Ruståº”ç”¨éƒ¨ç½²ç­–ç•¥](Ruståº”ç”¨éƒ¨ç½²ç­–ç•¥.md)
> - [Ruståº”ç”¨æ•…éšœè¯Šæ–­](Ruståº”ç”¨æ•…éšœè¯Šæ–­.md)
> - [Ruståº”ç”¨æ€§èƒ½æ•…éšœå¤„ç†](Ruståº”ç”¨æ€§èƒ½æ•…éšœå¤„ç†.md)

---

## ğŸ“‘ ç›®å½•

- [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [âš™ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šé…ç½®åˆ†ç±»](#ï¸-ç¬¬ä¸€éƒ¨åˆ†é…ç½®åˆ†ç±»)
    - [1.1 åº”ç”¨é…ç½®](#11-åº”ç”¨é…ç½®)
      - [1.1.1 åº”ç”¨å‚æ•°é…ç½®](#111-åº”ç”¨å‚æ•°é…ç½®)
    - [1.2 æ•°æ®åº“é…ç½®](#12-æ•°æ®åº“é…ç½®)
      - [1.2.1 è¿æ¥é…ç½®](#121-è¿æ¥é…ç½®)
    - [1.3 ç¯å¢ƒé…ç½®](#13-ç¯å¢ƒé…ç½®)
      - [1.3.1 ç¯å¢ƒå˜é‡é…ç½®](#131-ç¯å¢ƒå˜é‡é…ç½®)
  - [ğŸ”§ ç¬¬äºŒéƒ¨åˆ†ï¼šé…ç½®åŠ è½½](#-ç¬¬äºŒéƒ¨åˆ†é…ç½®åŠ è½½)
    - [2.1 é…ç½®æ–‡ä»¶åŠ è½½](#21-é…ç½®æ–‡ä»¶åŠ è½½)
      - [2.1.1 TOMLé…ç½®](#211-tomlé…ç½®)
    - [2.2 ç¯å¢ƒå˜é‡åŠ è½½](#22-ç¯å¢ƒå˜é‡åŠ è½½)
      - [2.2.1 ç¯å¢ƒå˜é‡è§£æ](#221-ç¯å¢ƒå˜é‡è§£æ)
    - [2.3 é…ç½®ä¼˜å…ˆçº§](#23-é…ç½®ä¼˜å…ˆçº§)
      - [2.3.1 ä¼˜å…ˆçº§è§„åˆ™](#231-ä¼˜å…ˆçº§è§„åˆ™)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šé…ç½®éªŒè¯](#-ç¬¬ä¸‰éƒ¨åˆ†é…ç½®éªŒè¯)
    - [3.1 é…ç½®éªŒè¯](#31-é…ç½®éªŒè¯)
      - [3.1.1 ç±»å‹éªŒè¯](#311-ç±»å‹éªŒè¯)
  - [ğŸ”„ ç¬¬å››éƒ¨åˆ†ï¼šMVCCé…ç½®](#-ç¬¬å››éƒ¨åˆ†mvccé…ç½®)
    - [4.1 MVCCç›¸å…³é…ç½®](#41-mvccç›¸å…³é…ç½®)
      - [4.1.1 äº‹åŠ¡é…ç½®](#411-äº‹åŠ¡é…ç½®)
    - [4.2 è¿æ¥æ± é…ç½®](#42-è¿æ¥æ± é…ç½®)
      - [4.2.1 æ± å‚æ•°é…ç½®](#421-æ± å‚æ•°é…ç½®)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›Ruståº”ç”¨é…ç½®ç®¡ç†çš„å®Œæ•´æŒ‡å—ï¼Œé‡ç‚¹å…³æ³¨ä¸PostgreSQL MVCCç›¸å…³çš„é…ç½®ç®¡ç†ã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š

- é…ç½®åˆ†ç±»ï¼ˆåº”ç”¨é…ç½®ã€æ•°æ®åº“é…ç½®ã€ç¯å¢ƒé…ç½®ï¼‰
- é…ç½®åŠ è½½ï¼ˆé…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€ä¼˜å…ˆçº§ï¼‰
- é…ç½®éªŒè¯ï¼ˆç±»å‹éªŒè¯ã€çƒ­é‡è½½ï¼‰
- MVCCé…ç½®ï¼ˆäº‹åŠ¡é…ç½®ã€è¿æ¥æ± é…ç½®ï¼‰

**ç›®æ ‡è¯»è€…**ï¼š

- è¿ç»´å·¥ç¨‹å¸ˆ
- Rustå¼€å‘è€…
- ç³»ç»Ÿæ¶æ„å¸ˆ

---

## âš™ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šé…ç½®åˆ†ç±»

### 1.1 åº”ç”¨é…ç½®

#### 1.1.1 åº”ç”¨å‚æ•°é…ç½®

```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Deserialize, Serialize)]
pub struct AppConfig {
    pub host: String,
    pub port: u16,
    pub max_connections: u32,
    pub timeout: u64,
}
```

### 1.2 æ•°æ®åº“é…ç½®

#### 1.2.1 è¿æ¥é…ç½®

```rust
#[derive(Debug, Deserialize, Serialize)]
pub struct DatabaseConfig {
    pub url: String,
    pub max_connections: u32,
    pub min_connections: u32,
    pub acquire_timeout: u64,
    pub idle_timeout: u64,
}
```

### 1.3 ç¯å¢ƒé…ç½®

#### 1.3.1 ç¯å¢ƒå˜é‡é…ç½®

```rust
use std::env;

fn load_env_config() -> DatabaseConfig {
    DatabaseConfig {
        url: env::var("DATABASE_URL")
            .expect("DATABASE_URL must be set"),
        max_connections: env::var("MAX_CONNECTIONS")
            .unwrap_or_else(|_| "20".to_string())
            .parse()
            .unwrap(),
        min_connections: env::var("MIN_CONNECTIONS")
            .unwrap_or_else(|_| "5".to_string())
            .parse()
            .unwrap(),
        acquire_timeout: env::var("ACQUIRE_TIMEOUT")
            .unwrap_or_else(|_| "30".to_string())
            .parse()
            .unwrap(),
        idle_timeout: env::var("IDLE_TIMEOUT")
            .unwrap_or_else(|_| "600".to_string())
            .parse()
            .unwrap(),
    }
}
```

---

## ğŸ”§ ç¬¬äºŒéƒ¨åˆ†ï¼šé…ç½®åŠ è½½

### 2.1 é…ç½®æ–‡ä»¶åŠ è½½

#### 2.1.1 TOMLé…ç½®

```rust
use serde::{Deserialize, Serialize};
use std::fs;

#[derive(Debug, Deserialize, Serialize)]
pub struct Config {
    pub app: AppConfig,
    pub database: DatabaseConfig,
}

fn load_config() -> Result<Config, Box<dyn std::error::Error>> {
    let config_str = fs::read_to_string("config.toml")?;
    let config: Config = toml::from_str(&config_str)?;
    Ok(config)
}
```

### 2.2 ç¯å¢ƒå˜é‡åŠ è½½

#### 2.2.1 ç¯å¢ƒå˜é‡è§£æ

```rust
use std::env;

fn load_from_env() -> DatabaseConfig {
    DatabaseConfig {
        url: env::var("DATABASE_URL").unwrap(),
        max_connections: env::var("MAX_CONNECTIONS")
            .unwrap_or_else(|_| "20".to_string())
            .parse()
            .unwrap(),
        // ...
    }
}
```

### 2.3 é…ç½®ä¼˜å…ˆçº§

#### 2.3.1 ä¼˜å…ˆçº§è§„åˆ™

```rust
// é…ç½®ä¼˜å…ˆçº§ï¼š
// 1. ç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
// 2. é…ç½®æ–‡ä»¶
// 3. é»˜è®¤å€¼ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šé…ç½®éªŒè¯

### 3.1 é…ç½®éªŒè¯

#### 3.1.1 ç±»å‹éªŒè¯

```rust
use validator::Validate;

#[derive(Debug, Deserialize, Validate)]
pub struct DatabaseConfig {
    #[validate(url)]
    pub url: String,

    #[validate(range(min = 1, max = 100))]
    pub max_connections: u32,

    #[validate(range(min = 1, max = 50))]
    pub min_connections: u32,
}

fn validate_config(config: &DatabaseConfig) -> Result<(), validator::ValidationErrors> {
    config.validate()
}
```

---

## ğŸ”„ ç¬¬å››éƒ¨åˆ†ï¼šMVCCé…ç½®

### 4.1 MVCCç›¸å…³é…ç½®

#### 4.1.1 äº‹åŠ¡é…ç½®

```rust
#[derive(Debug, Deserialize)]
pub struct TransactionConfig {
    pub isolation_level: String,  // READ COMMITTED, REPEATABLE READ, SERIALIZABLE
    pub read_only: bool,
    pub deferrable: bool,
}
```

### 4.2 è¿æ¥æ± é…ç½®

#### 4.2.1 æ± å‚æ•°é…ç½®

```rust
use sqlx::postgres::PgPoolOptions;

async fn create_pool(config: &DatabaseConfig) -> Result<PgPool, sqlx::Error> {
    let pool = PgPoolOptions::new()
        .max_connections(config.max_connections)
        .min_connections(config.min_connections)
        .acquire_timeout(std::time::Duration::from_secs(config.acquire_timeout))
        .idle_timeout(std::time::Duration::from_secs(config.idle_timeout))
        .connect(&config.url)
        .await?;

    Ok(pool)
}
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†Ruståº”ç”¨é…ç½®ç®¡ç†çš„å®Œæ•´æŒ‡å—ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. **é…ç½®åˆ†ç±»**ï¼š
   - åº”ç”¨é…ç½®ã€æ•°æ®åº“é…ç½®ã€ç¯å¢ƒé…ç½®

2. **é…ç½®åŠ è½½**ï¼š
   - é…ç½®æ–‡ä»¶åŠ è½½ã€ç¯å¢ƒå˜é‡åŠ è½½ã€é…ç½®ä¼˜å…ˆçº§

3. **é…ç½®éªŒè¯**ï¼š
   - ç±»å‹éªŒè¯ã€é…ç½®çƒ­é‡è½½

4. **MVCCé…ç½®**ï¼š
   - äº‹åŠ¡é…ç½®ã€è¿æ¥æ± é…ç½®

**ä¸‹ä¸€æ­¥**ï¼š

- å®Œå–„é…ç½®ç®¡ç†æ¡ˆä¾‹
- æ·»åŠ æ›´å¤šé…ç½®é€‰é¡¹
- å®Œå–„é…ç½®éªŒè¯æœºåˆ¶

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
