# PostgreSQL数据故障处理

> **文档编号**: OPS-TROUBLESHOOTING-DATA-001
> **主题**: 数据故障处理
> **版本**: PostgreSQL 17 & 18

---

## 📑 目录

- [PostgreSQL数据故障处理](#postgresql数据故障处理)
  - [📑 目录](#-目录)
  - [📋 概述](#-概述)
  - [🔍 第一部分：数据损坏修复](#-第一部分数据损坏修复)
    - [1.1 故障诊断](#11-故障诊断)
    - [1.2 修复方案](#12-修复方案)
    - [1.3 预防措施](#13-预防措施)
  - [🚀 第二部分：数据一致性检查](#-第二部分数据一致性检查)
    - [2.1 一致性检查](#21-一致性检查)
    - [2.2 修复方案](#22-修复方案)
    - [2.3 预防措施](#23-预防措施)
  - [📊 第三部分：数据恢复](#-第三部分数据恢复)
    - [3.1 备份恢复](#31-备份恢复)
    - [3.2 PITR恢复](#32-pitr恢复)
    - [3.3 预防措施](#33-预防措施)
  - [📝 总结](#-总结)
    - [核心机制](#核心机制)
    - [MVCC影响](#mvcc影响)
    - [最佳实践](#最佳实践)

---

## 📋 概述

数据故障处理是PostgreSQL运维的关键技能，包括数据损坏修复、数据一致性检查和数据恢复。本文档深入分析数据故障的处理方法，特别关注MVCC对数据一致性的影响。

---

## 🔍 第一部分：数据损坏修复

### 1.1 故障诊断

```sql
-- 数据损坏诊断
-- 1. 检查数据完整性
SELECT * FROM pg_stat_database WHERE datname = current_database();

-- 2. 使用pg_checksums检查（PostgreSQL 12+）
-- pg_checksums --check -D $PGDATA

-- 3. 检查错误日志
-- 查看PostgreSQL日志中的错误信息
```

### 1.2 修复方案

```sql
-- 数据损坏修复方案
-- 1. 使用REINDEX重建索引
REINDEX TABLE table_name;

-- 2. 使用VACUUM FULL重建表
VACUUM FULL table_name;

-- 3. 从备份恢复
-- 使用pg_basebackup或pg_restore恢复
```

### 1.3 预防措施

```text
数据损坏预防措施：

1. 定期备份：
   - 物理备份
   - 逻辑备份
   - 备份验证

2. 数据校验：
   - 启用checksums
   - 定期检查
   - 监控告警

3. 硬件维护：
   - 定期检查硬件
   - 监控磁盘健康
   - 及时更换故障硬件
```

---

## 🚀 第二部分：数据一致性检查

### 2.1 一致性检查

```sql
-- 数据一致性检查
-- 1. 检查约束违反
SELECT
    conname,
    contype,
    conrelid::regclass
FROM pg_constraint
WHERE conrelid = 'table_name'::regclass;

-- 2. 检查外键一致性
SELECT
    COUNT(*)
FROM table1 t1
LEFT JOIN table2 t2 ON t1.fk = t2.id
WHERE t2.id IS NULL;

-- 3. 检查MVCC一致性
SELECT
    relname,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables;
```

### 2.2 修复方案

```sql
-- 数据一致性修复方案
-- 1. 修复约束违反
-- 根据具体情况修复数据

-- 2. 修复外键不一致
-- 删除或修复不一致数据

-- 3. 修复MVCC不一致
VACUUM ANALYZE table_name;
```

### 2.3 预防措施

```text
数据一致性预防措施：

1. 应用层约束：
   - 使用数据库约束
   - 应用层验证
   - 事务管理

2. 定期检查：
   - 定期一致性检查
   - 监控告警
   - 及时修复

3. MVCC优化：
   - 定期VACUUM
   - 优化fillfactor
   - 减少版本链长度
```

---

## 📊 第三部分：数据恢复

### 3.1 备份恢复

```bash
# 备份恢复
# 1. 物理备份恢复
pg_basebackup -D /restore/pgdata -h backup_server

# 2. 逻辑备份恢复
pg_restore -d mydb backup.dump

# 3. 验证恢复
psql -d mydb -c "SELECT COUNT(*) FROM table_name;"
```

### 3.2 PITR恢复

```bash
# PITR恢复
# 1. 恢复基础备份
pg_basebackup -D /restore/pgdata -h backup_server

# 2. 配置恢复
echo "restore_command = 'cp /backup/wal/%f %p'" >> postgresql.conf
echo "recovery_target_time = '2024-01-01 12:00:00'" >> postgresql.conf

# 3. 启动恢复
touch recovery.signal
pg_ctl start -D /restore/pgdata
```

### 3.3 预防措施

```text
数据恢复预防措施：

1. 备份策略：
   - 定期备份
   - 备份验证
   - 备份测试

2. WAL归档：
   - 连续归档
   - WAL保留
   - 归档验证

3. 恢复测试：
   - 定期恢复测试
   - 验证恢复流程
   - 优化恢复时间
```

---

## 📝 总结

### 核心机制

1. **数据损坏修复**: 诊断、修复、预防
2. **数据一致性检查**: 检查、修复、预防
3. **数据恢复**: 备份恢复、PITR恢复、预防措施

### MVCC影响

- **数据一致性**: MVCC保证事务一致性
- **数据恢复**: MVCC状态需要恢复
- **数据验证**: MVCC状态需要验证

### 最佳实践

1. **预防为主**: 定期备份、数据校验、硬件维护
2. **快速恢复**: 备份策略、恢复测试、优化流程
3. **持续改进**: 分析原因、优化策略、预防复发

PostgreSQL数据故障处理通过系统化的方法和工具，可以快速修复和恢复数据问题，保证数据安全和一致性。
