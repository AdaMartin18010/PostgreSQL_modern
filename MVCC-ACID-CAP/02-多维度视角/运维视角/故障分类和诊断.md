# PostgreSQLæ•…éšœåˆ†ç±»å’Œè¯Šæ–­

> **æ–‡æ¡£ç¼–å·**: OPS-TROUBLESHOOTING-CLASSIFICATION-001
> **ä¸»é¢˜**: æ•…éšœåˆ†ç±»å’Œè¯Šæ–­
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLæ•…éšœåˆ†ç±»å’Œè¯Šæ–­](#postgresqlæ•…éšœåˆ†ç±»å’Œè¯Šæ–­)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•…éšœåˆ†ç±»](#-ç¬¬ä¸€éƒ¨åˆ†æ•…éšœåˆ†ç±»)
    - [1.1 MVCCç›¸å…³æ•…éšœ](#11-mvccç›¸å…³æ•…éšœ)
      - [XIDå›å·æ•…éšœ](#xidå›å·æ•…éšœ)
      - [è¡¨è†¨èƒ€æ•…éšœ](#è¡¨è†¨èƒ€æ•…éšœ)
      - [ç‰ˆæœ¬é“¾è¿‡é•¿æ•…éšœ](#ç‰ˆæœ¬é“¾è¿‡é•¿æ•…éšœ)
    - [1.2 äº‹åŠ¡ç›¸å…³æ•…éšœ](#12-äº‹åŠ¡ç›¸å…³æ•…éšœ)
      - [é•¿äº‹åŠ¡æ•…éšœ](#é•¿äº‹åŠ¡æ•…éšœ)
      - [æ­»é”æ•…éšœ](#æ­»é”æ•…éšœ)
      - [é”ç­‰å¾…æ•…éšœ](#é”ç­‰å¾…æ•…éšœ)
    - [1.3 æ€§èƒ½ç›¸å…³æ•…éšœ](#13-æ€§èƒ½ç›¸å…³æ•…éšœ)
      - [æŸ¥è¯¢æ€§èƒ½ä¸‹é™](#æŸ¥è¯¢æ€§èƒ½ä¸‹é™)
      - [å†™å…¥æ€§èƒ½ä¸‹é™](#å†™å…¥æ€§èƒ½ä¸‹é™)
      - [VACUUMæ€§èƒ½é—®é¢˜](#vacuumæ€§èƒ½é—®é¢˜)
    - [1.4 æ•°æ®ç›¸å…³æ•…éšœ](#14-æ•°æ®ç›¸å…³æ•…éšœ)
      - [æ•°æ®æŸå](#æ•°æ®æŸå)
      - [æ•°æ®ä¸ä¸€è‡´](#æ•°æ®ä¸ä¸€è‡´)
      - [æ•°æ®ä¸¢å¤±](#æ•°æ®ä¸¢å¤±)
  - [ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šè¯Šæ–­æµç¨‹](#-ç¬¬äºŒéƒ¨åˆ†è¯Šæ–­æµç¨‹)
    - [2.1 æ•…éšœå‘ç°](#21-æ•…éšœå‘ç°)
      - [ç›‘æ§å‘Šè­¦](#ç›‘æ§å‘Šè­¦)
      - [ç”¨æˆ·åé¦ˆ](#ç”¨æˆ·åé¦ˆ)
      - [ä¸»åŠ¨æ£€æŸ¥](#ä¸»åŠ¨æ£€æŸ¥)
    - [2.2 æ•…éšœå®šä½](#22-æ•…éšœå®šä½)
      - [æ—¥å¿—åˆ†æ](#æ—¥å¿—åˆ†æ)
      - [ç³»ç»Ÿè§†å›¾æŸ¥è¯¢](#ç³»ç»Ÿè§†å›¾æŸ¥è¯¢)
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
    - [2.3 æ•…éšœç¡®è®¤](#23-æ•…éšœç¡®è®¤)
      - [é—®é¢˜å¤ç°](#é—®é¢˜å¤ç°)
      - [å½±å“è¯„ä¼°](#å½±å“è¯„ä¼°)
      - [ä¼˜å…ˆçº§ç¡®å®š](#ä¼˜å…ˆçº§ç¡®å®š)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯Šæ–­å·¥å…·](#-ç¬¬ä¸‰éƒ¨åˆ†è¯Šæ–­å·¥å…·)
    - [3.1 ç³»ç»Ÿè§†å›¾](#31-ç³»ç»Ÿè§†å›¾)
      - [pg\_stat\_activity](#pg_stat_activity)
      - [pg\_stat\_database](#pg_stat_database)
      - [pg\_stat\_user\_tables](#pg_stat_user_tables)
    - [3.2 æ—¥å¿—åˆ†æ](#32-æ—¥å¿—åˆ†æ)
      - [PostgreSQLæ—¥å¿—](#postgresqlæ—¥å¿—)
      - [æ…¢æŸ¥è¯¢æ—¥å¿—](#æ…¢æŸ¥è¯¢æ—¥å¿—)
      - [é”™è¯¯æ—¥å¿—](#é”™è¯¯æ—¥å¿—)
    - [3.3 æ€§èƒ½å·¥å…·](#33-æ€§èƒ½å·¥å…·)
      - [EXPLAIN ANALYZE](#explain-analyze)
      - [pg\_stat\_statements](#pg_stat_statements)
      - [pgBadger](#pgbadger)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒæœºåˆ¶](#æ ¸å¿ƒæœºåˆ¶)
    - [MVCCç›¸å…³æ•…éšœ](#mvccç›¸å…³æ•…éšœ)
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ“‹ æ¦‚è¿°

æ•…éšœåˆ†ç±»å’Œè¯Šæ–­æ˜¯æ•…éšœå¤„ç†çš„ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ç³»ç»ŸåŒ–çš„åˆ†ç±»å’Œè¯Šæ–­æµç¨‹ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ã€è¯„ä¼°å½±å“å¹¶åˆ¶å®šè§£å†³æ–¹æ¡ˆã€‚æœ¬æ–‡æ¡£æ·±å…¥åˆ†æPostgreSQLæ•…éšœåˆ†ç±»å’Œè¯Šæ–­æ–¹æ³•ï¼Œç‰¹åˆ«å…³æ³¨MVCCç›¸å…³æ•…éšœã€‚

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•…éšœåˆ†ç±»

### 1.1 MVCCç›¸å…³æ•…éšœ

#### XIDå›å·æ•…éšœ

```sql
-- XIDå›å·æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥XIDå¹´é¾„
SELECT
    datname,
    age(datfrozenxid) AS xid_age,
    CASE
        WHEN age(datfrozenxid) > 2000000000 THEN 'CRITICAL: XID wraparound risk'
        WHEN age(datfrozenxid) > 1000000000 THEN 'WARNING: High XID age'
        ELSE 'OK'
    END AS status
FROM pg_database
WHERE datname = current_database();

-- 2. æ£€æŸ¥è¡¨XIDå¹´é¾„
SELECT
    schemaname,
    relname,
    age(relfrozenxid) AS xid_age
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind = 'r'
ORDER BY age(relfrozenxid) DESC
LIMIT 10;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. XIDå¹´é¾„æ¥è¿‘20äº¿
-- 2. æ•°æ®åº“æ‹’ç»å†™å…¥
-- 3. éœ€è¦ç´§æ€¥VACUUM FREEZE

-- MVCCå½±å“ï¼š
-- XIDå›å·å¯¼è‡´MVCCå¤±æ•ˆ
-- æ•°æ®åº“æ— æ³•æ­£å¸¸å·¥ä½œ
-- éœ€è¦ç´§æ€¥å¤„ç†
```

#### è¡¨è†¨èƒ€æ•…éšœ

```sql
-- è¡¨è†¨èƒ€æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥è¡¨è†¨èƒ€
SELECT
    schemaname,
    relname,
    pg_size_pretty(pg_total_relation_size(relid)) AS total_size,
    pg_size_pretty(pg_relation_size(relid)) AS table_size,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY dead_ratio DESC;

-- 2. æ£€æŸ¥ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE pg_relation_size(indexrelid) > 100 * 1024 * 1024  -- 100MB
ORDER BY pg_relation_size(indexrelid) DESC;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. è¡¨å¤§å°å¼‚å¸¸å¢é•¿
-- 2. æ­»äº¡å…ƒç»„æ¯”ä¾‹é«˜ï¼ˆ>20%ï¼‰
-- 3. æŸ¥è¯¢æ€§èƒ½ä¸‹é™

-- MVCCå½±å“ï¼š
-- è¡¨è†¨èƒ€å¯¼è‡´ç‰ˆæœ¬é“¾è¿‡é•¿
-- æŸ¥è¯¢æ€§èƒ½ä¸‹é™
-- VACUUMæ•ˆç‡ä½
```

#### ç‰ˆæœ¬é“¾è¿‡é•¿æ•…éšœ

```sql
-- ç‰ˆæœ¬é“¾è¿‡é•¿æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥ç‰ˆæœ¬é“¾é•¿åº¦ï¼ˆéœ€è¦æ‰©å±•ï¼‰
-- ä½¿ç”¨pageinspectæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pageinspect;

-- 2. æ£€æŸ¥HOTæ›´æ–°ç‡
SELECT
    schemaname,
    relname,
    n_tup_upd,
    n_tup_hot_upd,
    round(n_tup_hot_upd * 100.0 / NULLIF(n_tup_upd, 0), 2) AS hot_ratio
FROM pg_stat_user_tables
WHERE n_tup_upd > 1000
ORDER BY hot_ratio ASC;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. HOTæ›´æ–°ç‡ä½ï¼ˆ<50%ï¼‰
-- 2. ç‰ˆæœ¬é“¾é•¿åº¦é•¿
-- 3. æŸ¥è¯¢æ€§èƒ½ä¸‹é™

-- MVCCå½±å“ï¼š
-- ç‰ˆæœ¬é“¾è¿‡é•¿å¯¼è‡´å¯è§æ€§åˆ¤æ–­æ…¢
-- æŸ¥è¯¢æ€§èƒ½ä¸‹é™
-- éœ€è¦ä¼˜åŒ–fillfactor
```

### 1.2 äº‹åŠ¡ç›¸å…³æ•…éšœ

#### é•¿äº‹åŠ¡æ•…éšœ

```sql
-- é•¿äº‹åŠ¡æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    datname,
    state,
    now() - xact_start AS transaction_duration,
    now() - query_start AS query_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND now() - xact_start > interval '5 minutes'
ORDER BY xact_start;

-- 2. æ£€æŸ¥é•¿äº‹åŠ¡å½±å“
SELECT
    datname,
    age(datfrozenxid) AS xid_age,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state != 'idle') AS active_transactions
FROM pg_database
WHERE datname = current_database();

-- æ•…éšœç‰¹å¾ï¼š
-- 1. äº‹åŠ¡æŒç»­æ—¶é—´é•¿ï¼ˆ>5åˆ†é’Ÿï¼‰
-- 2. é˜»æ­¢VACUUM
-- 3. å½±å“XIDå¹´é¾„

-- MVCCå½±å“ï¼š
-- é•¿äº‹åŠ¡é˜»æ­¢VACUUM
-- å½±å“ç‰ˆæœ¬é“¾æ¸…ç†
-- å½±å“XIDå¹´é¾„
```

#### æ­»é”æ•…éšœ

```sql
-- æ­»é”æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks,
    xact_commit,
    xact_rollback
FROM pg_stat_database
WHERE datname = current_database();

-- 2. æ£€æŸ¥å½“å‰é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. æ­»é”æ¬¡æ•°å¢åŠ 
-- 2. äº‹åŠ¡å›æ»š
-- 3. åº”ç”¨é”™è¯¯

-- MVCCå½±å“ï¼š
-- æ­»é”å¯¼è‡´äº‹åŠ¡å›æ»š
-- ä¸å½±å“MVCCæœºåˆ¶
-- ä½†å½±å“ä¸šåŠ¡
```

#### é”ç­‰å¾…æ•…éšœ

```sql
-- é”ç­‰å¾…æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥é”ç­‰å¾…
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS wait_count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY wait_count DESC;

-- 2. æ£€æŸ¥è¡¨çº§é”
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    COUNT(*) AS lock_count
FROM pg_locks
WHERE locktype = 'relation'
GROUP BY locktype, relation, mode, granted
ORDER BY lock_count DESC;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. é”ç­‰å¾…æ—¶é—´é•¿
-- 2. æŸ¥è¯¢é˜»å¡
-- 3. æ€§èƒ½ä¸‹é™

-- MVCCå½±å“ï¼š
-- é”ç­‰å¾…ä¸å½±å“MVCCæœºåˆ¶
-- ä½†å½±å“æŸ¥è¯¢æ€§èƒ½
-- éœ€è¦ä¼˜åŒ–é”ç­–ç•¥
```

### 1.3 æ€§èƒ½ç›¸å…³æ•…éšœ

#### æŸ¥è¯¢æ€§èƒ½ä¸‹é™

```sql
-- æŸ¥è¯¢æ€§èƒ½ä¸‹é™è¯Šæ–­
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM metrics WHERE time BETWEEN ...;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. æŸ¥è¯¢æ—¶é—´å¢åŠ 
-- 2. æŸ¥è¯¢è®¡åˆ’å˜åŒ–
-- 3. ç´¢å¼•æœªä½¿ç”¨

-- MVCCå½±å“ï¼š
-- æŸ¥è¯¢æ€§èƒ½ä¸‹é™å¯èƒ½ç”±ç‰ˆæœ¬é“¾è¿‡é•¿å¼•èµ·
-- éœ€è¦æ£€æŸ¥MVCCçŠ¶æ€
```

#### å†™å…¥æ€§èƒ½ä¸‹é™

```sql
-- å†™å…¥æ€§èƒ½ä¸‹é™è¯Šæ–­
-- 1. æ£€æŸ¥å†™å…¥ç»Ÿè®¡
SELECT
    schemaname,
    relname,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    round(n_tup_hot_upd * 100.0 / NULLIF(n_tup_upd, 0), 2) AS hot_ratio
FROM pg_stat_user_tables
ORDER BY n_tup_ins DESC;

-- 2. æ£€æŸ¥WALç”Ÿæˆ
SELECT
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0')) AS total_wal;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. INSERT/UPDATEæ€§èƒ½ä¸‹é™
-- 2. HOTæ›´æ–°ç‡ä½
-- 3. WALç”Ÿæˆé‡å¤§

-- MVCCå½±å“ï¼š
-- å†™å…¥æ€§èƒ½ä¸‹é™å¯èƒ½ç”±ç‰ˆæœ¬é“¾è¿‡é•¿å¼•èµ·
-- éœ€è¦ä¼˜åŒ–fillfactor
```

#### VACUUMæ€§èƒ½é—®é¢˜

```sql
-- VACUUMæ€§èƒ½é—®é¢˜è¯Šæ–­
-- 1. æ£€æŸ¥VACUUMç»Ÿè®¡
SELECT
    schemaname,
    relname,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    n_dead_tup
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;

-- 2. æ£€æŸ¥VACUUMè¿›åº¦
SELECT
    pid,
    datname,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tup,
    num_dead_tup
FROM pg_stat_progress_vacuum;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. VACUUMæ—¶é—´é•¿
-- 2. VACUUMé¢‘ç‡ä½
-- 3. æ­»äº¡å…ƒç»„ç§¯ç´¯

-- MVCCå½±å“ï¼š
-- VACUUMæ€§èƒ½é—®é¢˜å¯¼è‡´ç‰ˆæœ¬é“¾æ¸…ç†ä¸åŠæ—¶
-- å½±å“æŸ¥è¯¢æ€§èƒ½
```

### 1.4 æ•°æ®ç›¸å…³æ•…éšœ

#### æ•°æ®æŸå

```sql
-- æ•°æ®æŸåè¯Šæ–­
-- 1. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
SELECT * FROM pg_stat_database WHERE datname = current_database();

-- 2. ä½¿ç”¨pg_checksumsæ£€æŸ¥ï¼ˆPostgreSQL 12+ï¼‰
-- pg_checksums --check -D $PGDATA

-- æ•…éšœç‰¹å¾ï¼š
-- 1. æŸ¥è¯¢é”™è¯¯
-- 2. æ•°æ®ä¸ä¸€è‡´
-- 3. æ•°æ®åº“æ— æ³•å¯åŠ¨

-- MVCCå½±å“ï¼š
-- æ•°æ®æŸåå¯èƒ½å¯¼è‡´MVCCå¤±æ•ˆ
-- éœ€è¦æ•°æ®æ¢å¤
```

#### æ•°æ®ä¸ä¸€è‡´

```sql
-- æ•°æ®ä¸ä¸€è‡´è¯Šæ–­
-- 1. æ£€æŸ¥çº¦æŸè¿å
SELECT
    conname,
    contype,
    conrelid::regclass
FROM pg_constraint
WHERE conrelid = 'table_name'::regclass;

-- 2. æ£€æŸ¥å¤–é”®ä¸€è‡´æ€§
SELECT
    COUNT(*)
FROM table1 t1
LEFT JOIN table2 t2 ON t1.fk = t2.id
WHERE t2.id IS NULL;

-- æ•…éšœç‰¹å¾ï¼š
-- 1. çº¦æŸè¿å
-- 2. å¤–é”®ä¸ä¸€è‡´
-- 3. æ•°æ®é€»è¾‘é”™è¯¯

-- MVCCå½±å“ï¼š
-- æ•°æ®ä¸ä¸€è‡´ä¸å½±å“MVCCæœºåˆ¶
-- ä½†å½±å“æ•°æ®å®Œæ•´æ€§
```

#### æ•°æ®ä¸¢å¤±

```text
æ•°æ®ä¸¢å¤±è¯Šæ–­ï¼š

1. æ£€æŸ¥å¤‡ä»½ï¼š
   - æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§
   - æ£€æŸ¥å¤‡ä»½æ—¶é—´
   - æ£€æŸ¥æ¢å¤æµ‹è¯•

2. æ£€æŸ¥WALï¼š
   - æ£€æŸ¥WALå®Œæ•´æ€§
   - æ£€æŸ¥WALå½’æ¡£
   - æ£€æŸ¥PITRèƒ½åŠ›

3. æ•…éšœç‰¹å¾ï¼š
   - æ•°æ®æ— æ³•æŸ¥è¯¢
   - å¤‡ä»½ç¼ºå¤±
   - æ¢å¤å¤±è´¥

MVCCå½±å“ï¼š
- æ•°æ®ä¸¢å¤±ä¸å½±å“MVCCæœºåˆ¶
- ä½†éœ€è¦æ•°æ®æ¢å¤
```

---

## ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šè¯Šæ–­æµç¨‹

### 2.1 æ•…éšœå‘ç°

#### ç›‘æ§å‘Šè­¦

```text
ç›‘æ§å‘Šè­¦å‘ç°æ•…éšœï¼š

1. ç›‘æ§æŒ‡æ ‡ï¼š
   - XIDå¹´é¾„å‘Šè­¦
   - è¡¨è†¨èƒ€å‘Šè­¦
   - é•¿äº‹åŠ¡å‘Šè­¦
   - æ­»é”å‘Šè­¦
   - æ€§èƒ½ä¸‹é™å‘Šè­¦

2. å‘Šè­¦é˜ˆå€¼ï¼š
   - XIDå¹´é¾„ > 1äº¿ï¼šè­¦å‘Š
   - æ­»äº¡å…ƒç»„æ¯”ä¾‹ > 20%ï¼šè­¦å‘Š
   - äº‹åŠ¡æŒç»­æ—¶é—´ > 5åˆ†é’Ÿï¼šè­¦å‘Š

3. å‘Šè­¦å¤„ç†ï¼š
   - ç«‹å³å“åº”
   - å¿«é€Ÿè¯Šæ–­
   - åŠæ—¶å¤„ç†
```

#### ç”¨æˆ·åé¦ˆ

```text
ç”¨æˆ·åé¦ˆå‘ç°æ•…éšœï¼š

1. åé¦ˆæ¸ é“ï¼š
   - åº”ç”¨é”™è¯¯æ—¥å¿—
   - ç”¨æˆ·æŠ¥å‘Š
   - æ€§èƒ½ç›‘æ§

2. åé¦ˆå†…å®¹ï¼š
   - é”™è¯¯ä¿¡æ¯
   - æ“ä½œæ­¥éª¤
   - å½±å“èŒƒå›´

3. åé¦ˆå¤„ç†ï¼š
   - æ”¶é›†ä¿¡æ¯
   - å¿«é€Ÿè¯Šæ–­
   - åŠæ—¶å¤„ç†
```

#### ä¸»åŠ¨æ£€æŸ¥

```sql
-- ä¸»åŠ¨æ£€æŸ¥è„šæœ¬
-- 1. å¥åº·æ£€æŸ¥
SELECT
    CASE
        WHEN age(datfrozenxid) > 2000000000 THEN 'CRITICAL: XID wraparound risk'
        WHEN age(datfrozenxid) > 1000000000 THEN 'WARNING: High XID age'
        ELSE 'OK'
    END AS xid_status,
    CASE
        WHEN MAX(dead_ratio) > 50 THEN 'CRITICAL: High dead tuple ratio'
        WHEN MAX(dead_ratio) > 20 THEN 'WARNING: Moderate dead tuple ratio'
        ELSE 'OK'
    END AS mvcc_status
FROM pg_database d
CROSS JOIN (
    SELECT
        round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio
    FROM pg_stat_user_tables
) t
WHERE d.datname = current_database();
```

### 2.2 æ•…éšœå®šä½

#### æ—¥å¿—åˆ†æ

```text
æ—¥å¿—åˆ†æå®šä½æ•…éšœï¼š

1. PostgreSQLæ—¥å¿—ï¼š
   - é”™è¯¯æ—¥å¿—
   - æ…¢æŸ¥è¯¢æ—¥å¿—
   - è¿æ¥æ—¥å¿—

2. ç³»ç»Ÿæ—¥å¿—ï¼š
   - ç³»ç»Ÿé”™è¯¯
   - èµ„æºä½¿ç”¨
   - ç½‘ç»œé—®é¢˜

3. åº”ç”¨æ—¥å¿—ï¼š
   - åº”ç”¨é”™è¯¯
   - ä¸šåŠ¡é€»è¾‘
   - æ€§èƒ½é—®é¢˜
```

#### ç³»ç»Ÿè§†å›¾æŸ¥è¯¢

```sql
-- ç³»ç»Ÿè§†å›¾æŸ¥è¯¢å®šä½æ•…éšœ
-- 1. æ£€æŸ¥æ´»è·ƒäº‹åŠ¡
SELECT * FROM pg_stat_activity WHERE state != 'idle';

-- 2. æ£€æŸ¥é”ç­‰å¾…
SELECT * FROM pg_locks WHERE NOT granted;

-- 3. æ£€æŸ¥è¡¨ç»Ÿè®¡
SELECT * FROM pg_stat_user_tables WHERE n_dead_tup > 1000;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½åˆ†æå®šä½æ•…éšœ
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;

-- 2. æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT ...;

-- 3. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
SELECT * FROM pg_stat_user_indexes WHERE idx_scan = 0;
```

### 2.3 æ•…éšœç¡®è®¤

#### é—®é¢˜å¤ç°

```text
é—®é¢˜å¤ç°ç¡®è®¤æ•…éšœï¼š

1. å¤ç°æ­¥éª¤ï¼š
   - è®°å½•æ“ä½œæ­¥éª¤
   - å¤ç°é—®é¢˜
   - éªŒè¯é—®é¢˜

2. å¤ç°ç¯å¢ƒï¼š
   - æµ‹è¯•ç¯å¢ƒ
   - ç”Ÿäº§ç¯å¢ƒ
   - éš”ç¦»ç¯å¢ƒ

3. å¤ç°ç»“æœï¼š
   - ç¡®è®¤é—®é¢˜
   - è¯„ä¼°å½±å“
   - åˆ¶å®šæ–¹æ¡ˆ
```

#### å½±å“è¯„ä¼°

```text
å½±å“è¯„ä¼°ç¡®è®¤æ•…éšœï¼š

1. å½±å“èŒƒå›´ï¼š
   - æ•°æ®åº“çº§åˆ«
   - è¡¨çº§åˆ«
   - æŸ¥è¯¢çº§åˆ«

2. å½±å“ç¨‹åº¦ï¼š
   - ä¸¥é‡ï¼šæ•°æ®åº“æ— æ³•ä½¿ç”¨
   - ä¸­ç­‰ï¼šæ€§èƒ½ä¸‹é™
   - è½»å¾®ï¼šéƒ¨åˆ†åŠŸèƒ½å—å½±å“

3. å½±å“æ—¶é—´ï¼š
   - ç«‹å³å¤„ç†
   - è®¡åˆ’å¤„ç†
   - ç›‘æ§å¤„ç†
```

#### ä¼˜å…ˆçº§ç¡®å®š

```text
ä¼˜å…ˆçº§ç¡®å®šç¡®è®¤æ•…éšœï¼š

1. ä¼˜å…ˆçº§æ ‡å‡†ï¼š
   - P0ï¼šæ•°æ®åº“æ— æ³•ä½¿ç”¨
   - P1ï¼šæ€§èƒ½ä¸¥é‡ä¸‹é™
   - P2ï¼šéƒ¨åˆ†åŠŸèƒ½å—å½±å“
   - P3ï¼šç›‘æ§å¤„ç†

2. ä¼˜å…ˆçº§å¤„ç†ï¼š
   - P0ï¼šç«‹å³å¤„ç†
   - P1ï¼šå¿«é€Ÿå¤„ç†
   - P2ï¼šè®¡åˆ’å¤„ç†
   - P3ï¼šç›‘æ§å¤„ç†
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯Šæ–­å·¥å…·

### 3.1 ç³»ç»Ÿè§†å›¾

#### pg_stat_activity

```sql
-- pg_stat_activityè¯Šæ–­
SELECT
    pid,
    usename,
    datname,
    state,
    wait_event_type,
    wait_event,
    query_start,
    state_change,
    query
FROM pg_stat_activity
WHERE state != 'idle';
```

#### pg_stat_database

```sql
-- pg_stat_databaseè¯Šæ–­
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted,
    deadlocks,
    temp_files,
    temp_bytes,
    blk_read_time,
    blk_write_time
FROM pg_stat_database
WHERE datname = current_database();
```

#### pg_stat_user_tables

```sql
-- pg_stat_user_tablesè¯Šæ–­
SELECT
    schemaname,
    relname,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    last_analyze,
    last_autoanalyze,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;
```

### 3.2 æ—¥å¿—åˆ†æ

#### PostgreSQLæ—¥å¿—

```text
PostgreSQLæ—¥å¿—åˆ†æï¼š

1. æ—¥å¿—ä½ç½®ï¼š
   - log_directoryé…ç½®
   - log_filenameé…ç½®
   - æ—¥å¿—è½®è½¬é…ç½®

2. æ—¥å¿—çº§åˆ«ï¼š
   - DEBUG5-DEBUG1
   - INFO
   - NOTICE
   - WARNING
   - ERROR
   - LOG
   - FATAL
   - PANIC

3. æ—¥å¿—åˆ†æï¼š
   - grepé”™è¯¯
   - åˆ†ææ…¢æŸ¥è¯¢
   - åˆ†æè¿æ¥é—®é¢˜
```

#### æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- æ…¢æŸ¥è¯¢æ—¥å¿—é…ç½®
-- postgresql.conf
log_min_duration_statement = 1000;  -- è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';

-- åˆ†ææ…¢æŸ¥è¯¢
-- ä½¿ç”¨pgBadgeråˆ†ææ—¥å¿—
```

#### é”™è¯¯æ—¥å¿—

```text
é”™è¯¯æ—¥å¿—åˆ†æï¼š

1. é”™è¯¯ç±»å‹ï¼š
   - è¿æ¥é”™è¯¯
   - æŸ¥è¯¢é”™è¯¯
   - æ•°æ®é”™è¯¯
   - ç³»ç»Ÿé”™è¯¯

2. é”™è¯¯åˆ†æï¼š
   - é”™è¯¯é¢‘ç‡
   - é”™è¯¯æ¨¡å¼
   - é”™è¯¯åŸå› 

3. é”™è¯¯å¤„ç†ï¼š
   - ä¿®å¤é”™è¯¯
   - é¢„é˜²é”™è¯¯
   - ç›‘æ§é”™è¯¯
```

### 3.3 æ€§èƒ½å·¥å…·

#### EXPLAIN ANALYZE

```sql
-- EXPLAIN ANALYZEè¯Šæ–­
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM metrics
WHERE time BETWEEN '2024-01-01' AND '2024-01-02';

-- åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼š
-- 1. æ‰«ææ–¹å¼ï¼ˆSeq Scan vs Index Scanï¼‰
-- 2. æˆæœ¬ä¼°ç®—
-- 3. å®é™…æ‰§è¡Œæ—¶é—´
-- 4. ç¼“å†²åŒºä½¿ç”¨
```

#### pg_stat_statements

```sql
-- pg_stat_statementsè¯Šæ–­
-- 1. å¯ç”¨æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### pgBadger

```text
pgBadgeræ—¥å¿—åˆ†æï¼š

1. å®‰è£…pgBadgerï¼š
   - ä¸‹è½½pgBadger
   - é…ç½®PostgreSQLæ—¥å¿—
   - è¿è¡ŒpgBadger

2. ç”ŸæˆæŠ¥å‘Šï¼š
   - HTMLæŠ¥å‘Š
   - æ€§èƒ½åˆ†æ
   - æ…¢æŸ¥è¯¢åˆ†æ

3. æŠ¥å‘Šå†…å®¹ï¼š
   - æŸ¥è¯¢ç»Ÿè®¡
   - æ€§èƒ½åˆ†æ
   - é”™è¯¯åˆ†æ
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

1. **æ•…éšœåˆ†ç±»**: MVCCç›¸å…³ã€äº‹åŠ¡ç›¸å…³ã€æ€§èƒ½ç›¸å…³ã€æ•°æ®ç›¸å…³
2. **è¯Šæ–­æµç¨‹**: æ•…éšœå‘ç°ã€æ•…éšœå®šä½ã€æ•…éšœç¡®è®¤
3. **è¯Šæ–­å·¥å…·**: ç³»ç»Ÿè§†å›¾ã€æ—¥å¿—åˆ†æã€æ€§èƒ½å·¥å…·

### MVCCç›¸å…³æ•…éšœ

- **XIDå›å·**: ç´§æ€¥å¤„ç†ï¼Œéœ€è¦VACUUM FREEZE
- **è¡¨è†¨èƒ€**: å®šæœŸVACUUMï¼Œä¼˜åŒ–fillfactor
- **ç‰ˆæœ¬é“¾è¿‡é•¿**: ä¼˜åŒ–fillfactorï¼Œæé«˜HOTæ›´æ–°ç‡

### æœ€ä½³å®è·µ

1. **æ•…éšœå‘ç°**: ç›‘æ§å‘Šè­¦ã€ç”¨æˆ·åé¦ˆã€ä¸»åŠ¨æ£€æŸ¥
2. **æ•…éšœå®šä½**: æ—¥å¿—åˆ†æã€ç³»ç»Ÿè§†å›¾æŸ¥è¯¢ã€æ€§èƒ½åˆ†æ
3. **æ•…éšœç¡®è®¤**: é—®é¢˜å¤ç°ã€å½±å“è¯„ä¼°ã€ä¼˜å…ˆçº§ç¡®å®š

PostgreSQLæ•…éšœåˆ†ç±»å’Œè¯Šæ–­é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ã€è¯„ä¼°å½±å“å¹¶åˆ¶å®šè§£å†³æ–¹æ¡ˆï¼Œæ˜¯æ•…éšœå¤„ç†çš„åŸºç¡€ã€‚
