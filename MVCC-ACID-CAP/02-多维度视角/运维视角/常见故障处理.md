# PostgreSQLå¸¸è§æ•…éšœå¤„ç†

> **æ–‡æ¡£ç¼–å·**: OPS-TROUBLESHOOTING-COMMON-001
> **ä¸»é¢˜**: å¸¸è§æ•…éšœå¤„ç†
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå¸¸è§æ•…éšœå¤„ç†](#postgresqlå¸¸è§æ•…éšœå¤„ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šXIDå›å·å¤„ç†](#-ç¬¬ä¸€éƒ¨åˆ†xidå›å·å¤„ç†)
    - [1.1 æ•…éšœè¯Šæ–­](#11-æ•…éšœè¯Šæ–­)
    - [1.2 ç´§æ€¥å¤„ç†](#12-ç´§æ€¥å¤„ç†)
    - [1.3 é¢„é˜²æªæ–½](#13-é¢„é˜²æªæ–½)
  - [ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šè¡¨è†¨èƒ€å¤„ç†](#-ç¬¬äºŒéƒ¨åˆ†è¡¨è†¨èƒ€å¤„ç†)
    - [2.1 æ•…éšœè¯Šæ–­](#21-æ•…éšœè¯Šæ–­)
    - [2.2 å¤„ç†æ–¹æ¡ˆ](#22-å¤„ç†æ–¹æ¡ˆ)
    - [2.3 é¢„é˜²æªæ–½](#23-é¢„é˜²æªæ–½)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šé•¿äº‹åŠ¡å¤„ç†](#-ç¬¬ä¸‰éƒ¨åˆ†é•¿äº‹åŠ¡å¤„ç†)
    - [3.1 æ•…éšœè¯Šæ–­](#31-æ•…éšœè¯Šæ–­)
    - [3.2 å¤„ç†æ–¹æ¡ˆ](#32-å¤„ç†æ–¹æ¡ˆ)
    - [3.3 é¢„é˜²æªæ–½](#33-é¢„é˜²æªæ–½)
  - [ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šæ­»é”å¤„ç†](#-ç¬¬å››éƒ¨åˆ†æ­»é”å¤„ç†)
    - [4.1 æ•…éšœè¯Šæ–­](#41-æ•…éšœè¯Šæ–­)
    - [4.2 å¤„ç†æ–¹æ¡ˆ](#42-å¤„ç†æ–¹æ¡ˆ)
    - [4.3 é¢„é˜²æªæ–½](#43-é¢„é˜²æªæ–½)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒæœºåˆ¶](#æ ¸å¿ƒæœºåˆ¶)
    - [MVCCå½±å“](#mvccå½±å“)
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ“‹ æ¦‚è¿°

å¸¸è§æ•…éšœå¤„ç†æ˜¯PostgreSQLè¿ç»´çš„æ ¸å¿ƒæŠ€èƒ½ï¼ŒåŒ…æ‹¬XIDå›å·ã€è¡¨è†¨èƒ€ã€é•¿äº‹åŠ¡ã€æ­»é”ç­‰å¸¸è§é—®é¢˜çš„è¯Šæ–­å’Œå¤„ç†ã€‚æœ¬æ–‡æ¡£æ·±å…¥åˆ†æè¿™äº›å¸¸è§æ•…éšœçš„å¤„ç†æ–¹æ³•ï¼Œç‰¹åˆ«å…³æ³¨MVCCç›¸å…³æ•…éšœã€‚

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šXIDå›å·å¤„ç†

### 1.1 æ•…éšœè¯Šæ–­

```sql
-- XIDå›å·æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥XIDå¹´é¾„
SELECT
    datname,
    age(datfrozenxid) AS xid_age,
    CASE
        WHEN age(datfrozenxid) > 2000000000 THEN 'CRITICAL: XID wraparound risk'
        WHEN age(datfrozenxid) > 1000000000 THEN 'WARNING: High XID age'
        ELSE 'OK'
    END AS status
FROM pg_database
WHERE datname = current_database();

-- 2. æ£€æŸ¥è¡¨XIDå¹´é¾„
SELECT
    schemaname,
    relname,
    age(relfrozenxid) AS xid_age
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind = 'r'
ORDER BY age(relfrozenxid) DESC
LIMIT 10;
```

### 1.2 ç´§æ€¥å¤„ç†

```sql
-- XIDå›å·ç´§æ€¥å¤„ç†
-- 1. ç«‹å³VACUUM FREEZE
VACUUM FREEZE VERBOSE;

-- 2. è¡¨çº§VACUUM FREEZE
VACUUM FREEZE VERBOSE table_name;

-- 3. æ•°æ®åº“çº§VACUUM FREEZE
VACUUM FREEZE VERBOSE;

-- 4. ç›‘æ§VACUUMè¿›åº¦
SELECT
    pid,
    datname,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed
FROM pg_stat_progress_vacuum;
```

### 1.3 é¢„é˜²æªæ–½

```sql
-- XIDå›å·é¢„é˜²æªæ–½
-- 1. é…ç½®autovacuum_freeze_max_age
ALTER SYSTEM SET autovacuum_freeze_max_age = 200000000;

-- 2. ç›‘æ§XIDå¹´é¾„
-- å®šæœŸæ£€æŸ¥XIDå¹´é¾„
-- è®¾ç½®å‘Šè­¦é˜ˆå€¼

-- 3. å®šæœŸVACUUM FREEZE
-- å®šæœŸæ‰§è¡ŒVACUUM FREEZE
-- é¿å…XIDå›å·
```

---

## ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šè¡¨è†¨èƒ€å¤„ç†

### 2.1 æ•…éšœè¯Šæ–­

```sql
-- è¡¨è†¨èƒ€æ•…éšœè¯Šæ–­
SELECT
    schemaname,
    relname,
    pg_size_pretty(pg_total_relation_size(relid)) AS total_size,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY dead_ratio DESC;
```

### 2.2 å¤„ç†æ–¹æ¡ˆ

```sql
-- è¡¨è†¨èƒ€å¤„ç†æ–¹æ¡ˆ
-- 1. VACUUM FULLï¼ˆéœ€è¦é”è¡¨ï¼‰
VACUUM FULL VERBOSE table_name;

-- 2. é‡å»ºè¡¨ï¼ˆPostgreSQL 9.0+ï¼‰
CREATE TABLE table_name_new (LIKE table_name INCLUDING ALL);
INSERT INTO table_name_new SELECT * FROM table_name;
BEGIN;
ALTER TABLE table_name RENAME TO table_name_old;
ALTER TABLE table_name_new RENAME TO table_name;
COMMIT;
DROP TABLE table_name_old;

-- 3. åˆ†åŒºè¡¨DROPåˆ†åŒºï¼ˆæ¨èï¼‰
DROP TABLE partition_name;
```

### 2.3 é¢„é˜²æªæ–½

```sql
-- è¡¨è†¨èƒ€é¢„é˜²æªæ–½
-- 1. ä¼˜åŒ–fillfactor
ALTER TABLE table_name SET (fillfactor = 90);

-- 2. å®šæœŸVACUUM
ALTER TABLE table_name SET (
    autovacuum_vacuum_scale_factor = 0.05
);

-- 3. å‡å°‘UPDATE/DELETE
-- ä½¿ç”¨å½’æ¡£ä»£æ›¿DELETE
-- ä¼˜åŒ–UPDATEç­–ç•¥
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šé•¿äº‹åŠ¡å¤„ç†

### 3.1 æ•…éšœè¯Šæ–­

```sql
-- é•¿äº‹åŠ¡æ•…éšœè¯Šæ–­
SELECT
    pid,
    usename,
    datname,
    state,
    now() - xact_start AS transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND now() - xact_start > interval '5 minutes'
ORDER BY xact_start;
```

### 3.2 å¤„ç†æ–¹æ¡ˆ

```sql
-- é•¿äº‹åŠ¡å¤„ç†æ–¹æ¡ˆ
-- 1. ç»ˆæ­¢é•¿äº‹åŠ¡
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = <pid>;

-- 2. å–æ¶ˆæŸ¥è¯¢
SELECT pg_cancel_backend(pid)
FROM pg_stat_activity
WHERE pid = <pid>;

-- 3. è®¾ç½®äº‹åŠ¡è¶…æ—¶
SET idle_in_transaction_session_timeout = '5min';
```

### 3.3 é¢„é˜²æªæ–½

```text
é•¿äº‹åŠ¡é¢„é˜²æªæ–½ï¼š

1. åº”ç”¨å±‚ä¼˜åŒ–ï¼š
   - å‡å°‘äº‹åŠ¡é•¿åº¦
   - å¿«é€Ÿæäº¤
   - é¿å…é•¿äº‹åŠ¡

2. æ•°æ®åº“é…ç½®ï¼š
   - idle_in_transaction_session_timeout
   - statement_timeout
   - lock_timeout

3. ç›‘æ§å‘Šè­¦ï¼š
   - ç›‘æ§é•¿äº‹åŠ¡
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼
   - åŠæ—¶å¤„ç†
```

---

## ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šæ­»é”å¤„ç†

### 4.1 æ•…éšœè¯Šæ–­

```sql
-- æ­»é”æ•…éšœè¯Šæ–­
-- 1. æ£€æŸ¥æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks
FROM pg_stat_database
WHERE datname = current_database();

-- 2. æ£€æŸ¥é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 4.2 å¤„ç†æ–¹æ¡ˆ

```sql
-- æ­»é”å¤„ç†æ–¹æ¡ˆ
-- 1. PostgreSQLè‡ªåŠ¨å¤„ç†æ­»é”
-- PostgreSQLä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å›æ»šæ­»é”äº‹åŠ¡

-- 2. æ‰‹åŠ¨ç»ˆæ­¢é˜»å¡äº‹åŠ¡
SELECT pg_terminate_backend(blocking_pid);

-- 3. åˆ†ææ­»é”æ—¥å¿—
-- æŸ¥çœ‹PostgreSQLæ—¥å¿—ä¸­çš„æ­»é”ä¿¡æ¯
```

### 4.3 é¢„é˜²æªæ–½

```text
æ­»é”é¢„é˜²æªæ–½ï¼š

1. åº”ç”¨å±‚ä¼˜åŒ–ï¼š
   - ç»Ÿä¸€é”é¡ºåº
   - å‡å°‘é”æŒæœ‰æ—¶é—´
   - ä½¿ç”¨SELECT FOR UPDATE NOWAIT

2. æ•°æ®åº“é…ç½®ï¼š
   - deadlock_timeout
   - lock_timeout

3. ç›‘æ§å‘Šè­¦ï¼š
   - ç›‘æ§æ­»é”æ¬¡æ•°
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼
   - åˆ†ææ­»é”æ¨¡å¼
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

1. **XIDå›å·**: ç´§æ€¥å¤„ç†ï¼Œéœ€è¦VACUUM FREEZE
2. **è¡¨è†¨èƒ€**: VACUUM FULLæˆ–é‡å»ºè¡¨
3. **é•¿äº‹åŠ¡**: ç»ˆæ­¢äº‹åŠ¡æˆ–è®¾ç½®è¶…æ—¶
4. **æ­»é”**: PostgreSQLè‡ªåŠ¨å¤„ç†ï¼Œéœ€è¦é¢„é˜²

### MVCCå½±å“

- **XIDå›å·**: MVCCå¤±æ•ˆï¼Œéœ€è¦ç´§æ€¥å¤„ç†
- **è¡¨è†¨èƒ€**: ç‰ˆæœ¬é“¾è¿‡é•¿ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½
- **é•¿äº‹åŠ¡**: é˜»æ­¢VACUUMï¼Œå½±å“ç‰ˆæœ¬é“¾æ¸…ç†
- **æ­»é”**: ä¸å½±å“MVCCï¼Œä½†å½±å“ä¸šåŠ¡

### æœ€ä½³å®è·µ

1. **é¢„é˜²ä¸ºä¸»**: é…ç½®ç›‘æ§ã€å®šæœŸç»´æŠ¤ã€ä¼˜åŒ–åº”ç”¨
2. **å¿«é€Ÿå“åº”**: åŠæ—¶è¯Šæ–­ã€å¿«é€Ÿå¤„ç†ã€å‡å°‘å½±å“
3. **æŒç»­æ”¹è¿›**: åˆ†æåŸå› ã€ä¼˜åŒ–ç­–ç•¥ã€é¢„é˜²å¤å‘

PostgreSQLå¸¸è§æ•…éšœå¤„ç†é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•å’Œå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿè¯Šæ–­å’Œå¤„ç†é—®é¢˜ï¼Œä¿è¯æ•°æ®åº“ç¨³å®šè¿è¡Œã€‚
