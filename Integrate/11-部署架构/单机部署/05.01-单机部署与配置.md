---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\05-éƒ¨ç½²æ¶æ„\å•æœºéƒ¨ç½²\05.01-å•æœºéƒ¨ç½²ä¸é…ç½®.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å•æœºéƒ¨ç½²ä¸é…ç½®

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [å•æœºéƒ¨ç½²ä¸é…ç½®](#å•æœºéƒ¨ç½²ä¸é…ç½®)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å®‰è£…ä¸åˆå§‹åŒ–](#3-å®‰è£…ä¸åˆå§‹åŒ–)
    - [3.1 åŒ…ç®¡ç†å™¨å®‰è£…](#31-åŒ…ç®¡ç†å™¨å®‰è£…)
      - [Ubuntu/Debian](#ubuntudebian)
      - [CentOS/RHEL](#centosrhel)
      - [macOS](#macos)
    - [3.2 æºç ç¼–è¯‘å®‰è£…](#32-æºç ç¼–è¯‘å®‰è£…)
    - [3.3 æ•°æ®åº“åˆå§‹åŒ–](#33-æ•°æ®åº“åˆå§‹åŒ–)
    - [3.4 æœåŠ¡ç®¡ç†](#34-æœåŠ¡ç®¡ç†)
    - [3.5 éªŒè¯å®‰è£…](#35-éªŒè¯å®‰è£…)
  - [4. é…ç½®è¦ç‚¹](#4-é…ç½®è¦ç‚¹)
    - [4.1 postgresql.confåŸºç¡€é…ç½®](#41-postgresqlconfåŸºç¡€é…ç½®)
      - [è¿æ¥è®¾ç½®](#è¿æ¥è®¾ç½®)
      - [å†…å­˜è®¾ç½®](#å†…å­˜è®¾ç½®)
      - [I/Oè®¾ç½®](#ioè®¾ç½®)
      - [WALè®¾ç½®](#walè®¾ç½®)
      - [æ—¥å¿—è®¾ç½®](#æ—¥å¿—è®¾ç½®)
    - [4.2 pg\_hba.confè®¤è¯é…ç½®](#42-pg_hbaconfè®¤è¯é…ç½®)
      - [è®¤è¯è§„åˆ™ç¤ºä¾‹](#è®¤è¯è§„åˆ™ç¤ºä¾‹)
      - [è®¤è¯æ–¹æ³•è¯´æ˜](#è®¤è¯æ–¹æ³•è¯´æ˜)
    - [4.3 ç³»ç»Ÿå‚æ•°ä¼˜åŒ–](#43-ç³»ç»Ÿå‚æ•°ä¼˜åŒ–)
      - [Linuxå†…æ ¸å‚æ•°](#linuxå†…æ ¸å‚æ•°)
      - [èµ„æºé™åˆ¶](#èµ„æºé™åˆ¶)
    - [4.4 é…ç½®éªŒè¯](#44-é…ç½®éªŒè¯)
  - [5. å®‰å…¨ä¸åˆè§„](#5-å®‰å…¨ä¸åˆè§„)
    - [5.1 ç”¨æˆ·å’Œæƒé™ç®¡ç†](#51-ç”¨æˆ·å’Œæƒé™ç®¡ç†)
    - [5.2 SSL/TLSåŠ å¯†](#52-ssltlsåŠ å¯†)
    - [5.3 å®¡è®¡æ—¥å¿—](#53-å®¡è®¡æ—¥å¿—)
    - [5.4 è¡Œçº§å®‰å…¨ç­–ç•¥](#54-è¡Œçº§å®‰å…¨ç­–ç•¥)
    - [5.5 æ•°æ®åŠ å¯†](#55-æ•°æ®åŠ å¯†)
    - [5.6 å®‰å…¨æœ€ä½³å®è·µ](#56-å®‰å…¨æœ€ä½³å®è·µ)
  - [6. PostgreSQL 18ç”Ÿäº§çº§é…ç½®](#6-postgresql-18ç”Ÿäº§çº§é…ç½®)
    - [6.1 å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ\<10GBæ•°æ®ï¼Œ\<100è¿æ¥ï¼‰](#61-å°è§„æ¨¡éƒ¨ç½²é…ç½®10gbæ•°æ®100è¿æ¥)
    - [6.2 ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ10-100GBæ•°æ®ï¼Œ100-500è¿æ¥ï¼‰](#62-ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®10-100gbæ•°æ®100-500è¿æ¥)
    - [6.3 å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ\>100GBæ•°æ®ï¼Œ\>500è¿æ¥ï¼‰](#63-å¤§è§„æ¨¡éƒ¨ç½²é…ç½®100gbæ•°æ®500è¿æ¥)
    - [6.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®](#64-postgresql-18æ–°ç‰¹æ€§é…ç½®)
  - [7. æ•…éšœæ’æŸ¥ä¸è¯Šæ–­](#7-æ•…éšœæ’æŸ¥ä¸è¯Šæ–­)
    - [7.1 å¯åŠ¨é—®é¢˜æ’æŸ¥](#71-å¯åŠ¨é—®é¢˜æ’æŸ¥)
    - [7.2 è¿æ¥é—®é¢˜è¯Šæ–­](#72-è¿æ¥é—®é¢˜è¯Šæ–­)
    - [7.3 æ€§èƒ½é—®é¢˜è¯Šæ–­](#73-æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [7.4 æ—¥å¿—åˆ†ææ–¹æ³•](#74-æ—¥å¿—åˆ†ææ–¹æ³•)
  - [8. æ€§èƒ½ä¼˜åŒ–å®è·µ](#8-æ€§èƒ½ä¼˜åŒ–å®è·µ)
    - [8.1 ç³»ç»Ÿçº§ä¼˜åŒ–](#81-ç³»ç»Ÿçº§ä¼˜åŒ–)
    - [8.2 æ•°æ®åº“å‚æ•°ä¼˜åŒ–](#82-æ•°æ®åº“å‚æ•°ä¼˜åŒ–)
    - [8.3 å­˜å‚¨ä¼˜åŒ–](#83-å­˜å‚¨ä¼˜åŒ–)
    - [8.4 ç½‘ç»œä¼˜åŒ–](#84-ç½‘ç»œä¼˜åŒ–)
  - [9. ç›‘æ§ä¸å‘Šè­¦é…ç½®](#9-ç›‘æ§ä¸å‘Šè­¦é…ç½®)
    - [9.1 å…³é”®æŒ‡æ ‡ç›‘æ§](#91-å…³é”®æŒ‡æ ‡ç›‘æ§)
    - [9.2 Prometheusç›‘æ§é…ç½®](#92-prometheusç›‘æ§é…ç½®)
    - [9.3 å‘Šè­¦è§„åˆ™é…ç½®](#93-å‘Šè­¦è§„åˆ™é…ç½®)
  - [10. å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—](#10-å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—)
    - [10.1 SSL/TLSå®Œæ•´é…ç½®](#101-ssltlså®Œæ•´é…ç½®)
    - [10.2 é˜²ç«å¢™è§„åˆ™é…ç½®](#102-é˜²ç«å¢™è§„åˆ™é…ç½®)
    - [10.3 å®¡è®¡æ—¥å¿—é…ç½®](#103-å®¡è®¡æ—¥å¿—é…ç½®)
    - [10.4 è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®](#104-è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®)
  - [11. åç»­æ•´åˆä»»åŠ¡](#11-åç»­æ•´åˆä»»åŠ¡)
    - [11.1 ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚](#111-ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚)
      - [Ubuntu/Debian](#ubuntudebian-1)
      - [CentOS/RHEL](#centosrhel-1)
      - [macOS (Homebrew)](#macos-homebrew)
    - [11.2 ç³»ç»Ÿå‚æ•°æ¨èè¡¨](#112-ç³»ç»Ÿå‚æ•°æ¨èè¡¨)
    - [11.3 æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•](#113-æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•)
  - [12. OpenTelemetryé›†æˆ](#12-opentelemetryé›†æˆ)
    - [12.1 OpenTelemetryæ¶æ„å’ŒåŸç†](#121-opentelemetryæ¶æ„å’ŒåŸç†)
      - [12.1.1 OpenTelemetryæ¶æ„](#1211-opentelemetryæ¶æ„)
      - [12.1.2 é¥æµ‹æ•°æ®ç±»å‹](#1212-é¥æµ‹æ•°æ®ç±»å‹)
      - [12.1.3 OpenTelemetryä¼˜åŠ¿](#1213-opentelemetryä¼˜åŠ¿)
    - [12.2 PostgreSQLé©±åŠ¨é›†æˆé…ç½®](#122-postgresqlé©±åŠ¨é›†æˆé…ç½®)
      - [12.2.1 Pythoné©±åŠ¨é›†æˆï¼ˆpsycopg3ï¼‰](#1221-pythoné©±åŠ¨é›†æˆpsycopg3)
      - [12.2.2 Javaé©±åŠ¨é›†æˆï¼ˆJDBCï¼‰](#1222-javaé©±åŠ¨é›†æˆjdbc)
      - [12.2.3 Node.jsé©±åŠ¨é›†æˆï¼ˆpgï¼‰](#1223-nodejsé©±åŠ¨é›†æˆpg)
      - [12.2.4 é…ç½®æœ€ä½³å®è·µ](#1224-é…ç½®æœ€ä½³å®è·µ)
    - [12.3 è·¨æœåŠ¡è¯·æ±‚è·Ÿè¸ªé…ç½®](#123-è·¨æœåŠ¡è¯·æ±‚è·Ÿè¸ªé…ç½®)
      - [12.3.1 è¿½è¸ªé…ç½®](#1231-è¿½è¸ªé…ç½®)
      - [12.3.2 ä¸Šä¸‹æ–‡ä¼ æ’­](#1232-ä¸Šä¸‹æ–‡ä¼ æ’­)
      - [12.3.3 å®é™…æ¡ˆä¾‹](#1233-å®é™…æ¡ˆä¾‹)
    - [12.4 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«æ–¹æ³•](#124-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«æ–¹æ³•)
      - [12.4.1 è¿½è¸ªæ•°æ®åˆ†æ](#1241-è¿½è¸ªæ•°æ®åˆ†æ)
      - [12.4.2 ç“¶é¢ˆå®šä½æ–¹æ³•](#1242-ç“¶é¢ˆå®šä½æ–¹æ³•)
      - [12.4.3 ä¼˜åŒ–å»ºè®®](#1243-ä¼˜åŒ–å»ºè®®)
  - [13. ELK/Graylogæ—¥å¿—ç®¡ç†](#13-elkgraylogæ—¥å¿—ç®¡ç†)
    - [13.1 ELK Stackå®Œæ•´é…ç½®](#131-elk-stackå®Œæ•´é…ç½®)
      - [13.1.1 Elasticsearché…ç½®](#1311-elasticsearché…ç½®)
      - [13.1.2 Logstashé…ç½®](#1312-logstashé…ç½®)
      - [13.1.3 Kibanaé…ç½®](#1313-kibanaé…ç½®)
    - [13.2 Graylogé…ç½®å’Œé›†æˆ](#132-graylogé…ç½®å’Œé›†æˆ)
      - [13.2.1 Graylogå®‰è£…é…ç½®](#1321-graylogå®‰è£…é…ç½®)
      - [13.2.2 PostgreSQLé›†æˆ](#1322-postgresqlé›†æˆ)
      - [13.2.3 æ—¥å¿—é‡‡é›†é…ç½®](#1323-æ—¥å¿—é‡‡é›†é…ç½®)
    - [13.3 æ—¥å¿—åˆ†æå’ŒæŸ¥è¯¢](#133-æ—¥å¿—åˆ†æå’ŒæŸ¥è¯¢)
      - [13.3.1 æŸ¥è¯¢è¯­æ³•](#1331-æŸ¥è¯¢è¯­æ³•)
      - [13.3.2 åˆ†ææ¡ˆä¾‹](#1332-åˆ†ææ¡ˆä¾‹)
      - [13.3.3 å¯è§†åŒ–é…ç½®](#1333-å¯è§†åŒ–é…ç½®)
    - [13.4 æ—¥å¿—å‘Šè­¦é…ç½®](#134-æ—¥å¿—å‘Šè­¦é…ç½®)
      - [13.4.1 å‘Šè­¦è§„åˆ™é…ç½®](#1341-å‘Šè­¦è§„åˆ™é…ç½®)
      - [13.4.2 é€šçŸ¥é…ç½®](#1342-é€šçŸ¥é…ç½®)
      - [13.4.3 å®é™…æ¡ˆä¾‹](#1343-å®é™…æ¡ˆä¾‹)
  - [14. PostgreSQLæ—¥å¿—ç®¡ç†è¯¦ç»†é…ç½®](#14-postgresqlæ—¥å¿—ç®¡ç†è¯¦ç»†é…ç½®)
    - [14.1 æ—¥å¿—å‚æ•°è¯¦ç»†é…ç½®](#141-æ—¥å¿—å‚æ•°è¯¦ç»†é…ç½®)
      - [14.1.1 åŸºç¡€æ—¥å¿—é…ç½®](#1411-åŸºç¡€æ—¥å¿—é…ç½®)
      - [14.1.2 è¿æ¥æ—¥å¿—é…ç½®](#1412-è¿æ¥æ—¥å¿—é…ç½®)
      - [14.1.3 è¯­å¥æ—¥å¿—é…ç½®](#1413-è¯­å¥æ—¥å¿—é…ç½®)
      - [14.1.4 æ£€æŸ¥ç‚¹å’Œè‡ªåŠ¨æ¸…ç†æ—¥å¿—](#1414-æ£€æŸ¥ç‚¹å’Œè‡ªåŠ¨æ¸…ç†æ—¥å¿—)
      - [14.1.5 é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—](#1415-é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—)
    - [14.2 æ—¥å¿—æ–‡ä»¶ç®¡ç†ç­–ç•¥](#142-æ—¥å¿—æ–‡ä»¶ç®¡ç†ç­–ç•¥)
      - [14.2.1 æ—¥å¿—è½®è½¬é…ç½®](#1421-æ—¥å¿—è½®è½¬é…ç½®)
      - [14.2.2 æ—¥å¿—å½’æ¡£ç­–ç•¥](#1422-æ—¥å¿—å½’æ¡£ç­–ç•¥)
      - [14.2.3 æ—¥å¿—æ¸…ç†ç­–ç•¥](#1423-æ—¥å¿—æ¸…ç†ç­–ç•¥)
    - [14.3 æ—¥å¿—åˆ†æå·¥å…·](#143-æ—¥å¿—åˆ†æå·¥å…·)
      - [14.3.1 pgBadgerä½¿ç”¨](#1431-pgbadgerä½¿ç”¨)
      - [14.3.2 æ—¥å¿—åˆ†æè„šæœ¬](#1432-æ—¥å¿—åˆ†æè„šæœ¬)
      - [14.3.3 å®æ—¶æ—¥å¿—ç›‘æ§](#1433-å®æ—¶æ—¥å¿—ç›‘æ§)
  - [15. äº¤å‰å¼•ç”¨](#15-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)

---

## 1. æ¦‚è¿°

- å®‰è£…ã€åˆå§‹åŒ–ã€åŸºç¡€é…ç½®ä¸å®‰å…¨åŠ å›º

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½².mdï¼ˆåŸºç¡€é…ç½®ç‰‡æ®µï¼‰
- 1.1.16-æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§-æ‰©å……ç‰ˆ.mdï¼ˆç›¸å…³é…ç½®ï¼‰

## 3. å®‰è£…ä¸åˆå§‹åŒ–

- åŒ…ç®¡ç†å™¨/æºç å®‰è£…ï¼Œinitdbï¼Œpg_ctl/æœåŠ¡ç®¡ç†

### 3.1 åŒ…ç®¡ç†å™¨å®‰è£…

#### Ubuntu/Debian

```bash
# æ·»åŠ PostgreSQLå®˜æ–¹APTä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# å®‰è£…PostgreSQL 18
sudo apt-get install -y postgresql-18 postgresql-contrib-18

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql
```

#### CentOS/RHEL

```bash
# å®‰è£…PostgreSQLå®˜æ–¹YUMä»“åº“
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL 18
sudo dnf install -y postgresql18-server postgresql18-contrib

# åˆå§‹åŒ–æ•°æ®åº“
sudo /usr/pgsql-18/bin/postgresql-18-setup initdb

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18
```

#### macOS

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install postgresql@18

# å¯åŠ¨æœåŠ¡
brew services start postgresql@18

# åˆ›å»ºæ•°æ®åº“
createdb mydb
```

### 3.2 æºç ç¼–è¯‘å®‰è£…

```bash
# 1. å®‰è£…ä¾èµ–
sudo apt-get install -y build-essential libreadline-dev zlib1g-dev libssl-dev libxml2-dev libxslt1-dev

# 2. ä¸‹è½½æºç 
wget https://ftp.postgresql.org/pub/source/v18.0/postgresql-18.0.tar.gz
tar -xzf postgresql-18.0.tar.gz
cd postgresql-18.0

# 3. é…ç½®ç¼–è¯‘é€‰é¡¹
./configure --prefix=/usr/local/pgsql \
    --with-openssl \
    --with-libxml \
    --with-libxslt \
    --enable-nls \
    --with-python \
    --with-perl

# 4. ç¼–è¯‘å’Œå®‰è£…
make -j$(nproc)
sudo make install

# 5. åˆ›å»ºæ•°æ®ç›®å½•
sudo mkdir -p /usr/local/pgsql/data
sudo chown postgres:postgres /usr/local/pgsql/data

# 6. åˆå§‹åŒ–æ•°æ®åº“
sudo -u postgres /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
```

### 3.3 æ•°æ®åº“åˆå§‹åŒ–

```bash
# ä½¿ç”¨initdbåˆå§‹åŒ–æ•°æ®åº“
sudo -u postgres /usr/pgsql-18/bin/initdb -D /var/lib/pgsql/18/data \
    --locale=zh_CN.UTF-8 \
    --encoding=UTF8 \
    --data-checksums

# åˆå§‹åŒ–å‚æ•°è¯´æ˜ï¼š
# -D: æ•°æ®ç›®å½•
# --locale: åŒºåŸŸè®¾ç½®
# --encoding: å­—ç¬¦ç¼–ç 
# --data-checksums: å¯ç”¨æ•°æ®æ ¡éªŒå’Œï¼ˆPostgreSQL 9.3+ï¼‰
```

### 3.4 æœåŠ¡ç®¡ç†

```bash
# ä½¿ç”¨systemdç®¡ç†ï¼ˆæ¨èï¼‰
sudo systemctl start postgresql-18
sudo systemctl stop postgresql-18
sudo systemctl restart postgresql-18
sudo systemctl status postgresql-18
sudo systemctl enable postgresql-18

# ä½¿ç”¨pg_ctlç®¡ç†
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data start
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data stop
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data restart
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data status
```

### 3.5 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥PostgreSQLç‰ˆæœ¬
psql --version

# è¿æ¥åˆ°æ•°æ®åº“
sudo -u postgres psql

# åœ¨psqlä¸­æ‰§è¡Œ
SELECT version();
\conninfo
\l
```

## 4. é…ç½®è¦ç‚¹

- postgresql.conf / pg_hba.confï¼Œå†…å­˜/IO/è¿æ¥æ•°

### 4.1 postgresql.confåŸºç¡€é…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /var/lib/pgsql/18/data/postgresql.conf
```

#### è¿æ¥è®¾ç½®

```conf
# ç›‘å¬åœ°å€ï¼ˆå…è®¸æ‰€æœ‰IPè¿æ¥ï¼‰
listen_addresses = '*'

# ç«¯å£
port = 5432

# æœ€å¤§è¿æ¥æ•°
max_connections = 100

# è¶…çº§ç”¨æˆ·ä¿ç•™è¿æ¥æ•°
superuser_reserved_connections = 3
```

#### å†…å­˜è®¾ç½®

```conf
# å…±äº«ç¼“å†²åŒºï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„25%ï¼‰
shared_buffers = 256MB

# å·¥ä½œå†…å­˜ï¼ˆç”¨äºæ’åºã€å“ˆå¸Œç­‰æ“ä½œï¼‰
work_mem = 4MB

# ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç”¨äºVACUUMã€CREATE INDEXç­‰ï¼‰
maintenance_work_mem = 64MB

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%ï¼‰
effective_cache_size = 1GB
```

#### I/Oè®¾ç½®

```conf
# éšæœºé¡µé¢æˆæœ¬ï¼ˆSSDå»ºè®®1.1ï¼ŒHDDå»ºè®®4.0ï¼‰
random_page_cost = 1.1

# æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆSSDå»ºè®®200ï¼ŒHDDå»ºè®®2ï¼‰
effective_io_concurrency = 200

# å¼‚æ­¥I/Oï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
backend_flush_after = 0
```

#### WALè®¾ç½®

```conf
# WALçº§åˆ«
wal_level = replica

# æœ€å°WALå¤§å°
min_wal_size = 1GB

# æœ€å¤§WALå¤§å°
max_wal_size = 4GB

# æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
checkpoint_completion_target = 0.9
```

#### æ—¥å¿—è®¾ç½®

```conf
# æ—¥å¿—æ”¶é›†
logging_collector = on

# æ—¥å¿—ç›®å½•
log_directory = 'log'

# æ—¥å¿—æ–‡ä»¶å
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# æ—¥å¿—è½®è½¬
log_rotation_age = 1d
log_rotation_size = 100MB

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500

# è®°å½•æ£€æŸ¥ç‚¹
log_checkpoints = on

# è®°å½•è¿æ¥
log_connections = on
log_disconnections = on
```

### 4.2 pg_hba.confè®¤è¯é…ç½®

```bash
# ç¼–è¾‘è®¤è¯é…ç½®æ–‡ä»¶
sudo nano /var/lib/pgsql/18/data/pg_hba.conf
```

#### è®¤è¯è§„åˆ™ç¤ºä¾‹

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥ä½¿ç”¨peerè®¤è¯
local   all             all                                     peer

# IPv4æœ¬åœ°è¿æ¥ä½¿ç”¨md5è®¤è¯
host    all             all             127.0.0.1/32            md5

# IPv4å±€åŸŸç½‘è¿æ¥ä½¿ç”¨md5è®¤è¯
host    all             all             192.168.1.0/24          md5

# å¤åˆ¶è¿æ¥ä½¿ç”¨md5è®¤è¯
host    replication     replicator      192.168.1.0/24          md5

# SSLè¿æ¥ä½¿ç”¨scram-sha-256è®¤è¯
hostssl all             all             0.0.0.0/0               scram-sha-256
```

#### è®¤è¯æ–¹æ³•è¯´æ˜

- **trust**: æ— æ¡ä»¶å…è®¸è¿æ¥ï¼ˆä»…ç”¨äºæœ¬åœ°å¼€å‘ï¼‰
- **md5**: ä½¿ç”¨MD5åŠ å¯†å¯†ç 
- **scram-sha-256**: ä½¿ç”¨SCRAM-SHA-256åŠ å¯†å¯†ç ï¼ˆæ¨èï¼‰
- **peer**: ä½¿ç”¨æ“ä½œç³»ç»Ÿç”¨æˆ·åè®¤è¯ï¼ˆä»…æœ¬åœ°ï¼‰
- **cert**: ä½¿ç”¨SSLå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯

### 4.3 ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

#### Linuxå†…æ ¸å‚æ•°

```bash
# ç¼–è¾‘sysctl.conf
sudo nano /etc/sysctl.conf

# æ·»åŠ ä»¥ä¸‹å‚æ•°
# å…±äº«å†…å­˜è®¾ç½®
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# è™šæ‹Ÿå†…å­˜å‚æ•°
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# åº”ç”¨é…ç½®
sudo sysctl -p
```

#### èµ„æºé™åˆ¶

```bash
# ç¼–è¾‘limits.conf
sudo nano /etc/security/limits.conf

# æ·»åŠ ä»¥ä¸‹é™åˆ¶
postgres soft nofile 65536
postgres hard nofile 65536
postgres soft nproc 32768
postgres hard nproc 32768
```

### 4.4 é…ç½®éªŒè¯

```sql
-- æŸ¥çœ‹å½“å‰é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    shared_buffers_val TEXT;
    max_connections_val TEXT;
    work_mem_val TEXT;
BEGIN
    SHOW shared_buffers INTO shared_buffers_val;
    SHOW max_connections INTO max_connections_val;
    SHOW work_mem INTO work_mem_val;

    RAISE NOTICE 'shared_buffers: %', shared_buffers_val;
    RAISE NOTICE 'max_connections: %', max_connections_val;
    RAISE NOTICE 'work_mem: %', work_mem_val;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥çœ‹é…ç½®å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹æ‰€æœ‰é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    config_count INT;
BEGIN
    SELECT COUNT(*) INTO config_count
    FROM pg_settings;

    RAISE NOTICE 'æ‰¾åˆ° % ä¸ªé…ç½®å‚æ•°', config_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹é…ç½®å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, source FROM pg_settings ORDER BY name;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- é‡æ–°åŠ è½½é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    PERFORM pg_reload_conf();
    RAISE NOTICE 'é…ç½®é‡æ–°åŠ è½½æˆåŠŸ';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é‡æ–°åŠ è½½é…ç½®å¤±è´¥: %', SQLERRM;
END $$;
```

## 5. å®‰å…¨ä¸åˆè§„

- è®¤è¯æ–¹å¼ã€åŠ å¯†ã€å®¡è®¡

### 5.1 ç”¨æˆ·å’Œæƒé™ç®¡ç†

```sql
-- åˆ›å»ºç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'app_user'
    ) THEN
        DROP USER app_user;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç”¨æˆ·: app_user';
    END IF;

    CREATE USER app_user WITH PASSWORD 'secure_password';
    RAISE NOTICE 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ: app_user';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING 'ç”¨æˆ·app_userå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç”¨æˆ·å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºæ•°æ®åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_database
        WHERE datname = 'app_db'
    ) THEN
        DROP DATABASE app_db;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰æ•°æ®åº“: app_db';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'app_user'
    ) THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    CREATE DATABASE app_db OWNER app_user;
    RAISE NOTICE 'æ•°æ®åº“åˆ›å»ºæˆåŠŸ: app_db';
EXCEPTION
    WHEN duplicate_database THEN
        RAISE WARNING 'æ•°æ®åº“app_dbå·²å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ•°æ®åº“å¤±è´¥: %', SQLERRM;
END $$;

-- æˆäºˆæƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_database
        WHERE datname = 'app_db'
    ) THEN
        RAISE EXCEPTION 'æ•°æ®åº“app_dbä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'app_user'
    ) THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    GRANT CONNECT ON DATABASE app_db TO app_user;
    GRANT USAGE ON SCHEMA public TO app_user;
    GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;

    RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: app_user';
EXCEPTION
    WHEN undefined_database THEN
        RAISE EXCEPTION 'æ•°æ®åº“app_dbä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦æ•°æ®åº“æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
END $$;

-- è®¾ç½®é»˜è®¤æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_database
        WHERE datname = current_database()
    ) THEN
        RAISE EXCEPTION 'å½“å‰æ•°æ®åº“ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'app_user'
    ) THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ALTER DEFAULT PRIVILEGES IN SCHEMA public
        GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;

    RAISE NOTICE 'é»˜è®¤æƒé™è®¾ç½®æˆåŠŸ: app_user';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦æ•°æ®åº“æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®é»˜è®¤æƒé™å¤±è´¥: %', SQLERRM;
END $$;
```

### 5.2 SSL/TLSåŠ å¯†

```bash
# ç”ŸæˆSSLè¯ä¹¦
sudo -u postgres openssl req -new -x509 -days 365 -nodes \
    -text -out /var/lib/pgsql/18/data/server.crt \
    -keyout /var/lib/pgsql/18/data/server.key \
    -subj "/CN=postgresql-server"

# è®¾ç½®æƒé™
sudo chmod 600 /var/lib/pgsql/18/data/server.key
sudo chown postgres:postgres /var/lib/pgsql/18/data/server.key
sudo chown postgres:postgres /var/lib/pgsql/18/data/server.crt
```

```conf
# postgresql.confä¸­å¯ç”¨SSL
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
```

### 5.3 å®¡è®¡æ—¥å¿—

```conf
# postgresql.confä¸­å¯ç”¨å®¡è®¡
log_statement = 'all'  # è®°å½•æ‰€æœ‰SQLè¯­å¥
# æˆ–
log_statement = 'ddl'  # ä»…è®°å½•DDLè¯­å¥
log_statement = 'mod'  # è®°å½•ä¿®æ”¹æ•°æ®çš„è¯­å¥

# è®°å½•å‚æ•°å˜æ›´
log_parameter_max_length = 1024
```

### 5.4 è¡Œçº§å®‰å…¨ç­–ç•¥

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name = 'sensitive_data'
    ) THEN
        RAISE EXCEPTION 'è¡¨sensitive_dataä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ALTER TABLE sensitive_data ENABLE ROW LEVEL SECURITY;
    RAISE NOTICE 'è¡Œçº§å®‰å…¨å·²å¯ç”¨: sensitive_data';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨sensitive_dataä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¯ç”¨è¡Œçº§å®‰å…¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name = 'sensitive_data'
    ) THEN
        RAISE EXCEPTION 'è¡¨sensitive_dataä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_policies
        WHERE schemaname = 'public'
        AND tablename = 'sensitive_data'
        AND policyname = 'user_data_policy'
    ) THEN
        DROP POLICY user_data_policy ON sensitive_data;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: user_data_policy';
    END IF;

    CREATE POLICY user_data_policy ON sensitive_data
        FOR ALL
    TO app_user
    USING (user_id = current_user_id());
```

### 5.5 æ•°æ®åŠ å¯†

```sql
-- ä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å­˜å‚¨
INSERT INTO users (username, password_hash)
VALUES ('user1', crypt('password123', gen_salt('bf')));

-- éªŒè¯å¯†ç 
SELECT * FROM users
WHERE username = 'user1'
AND password_hash = crypt('password123', password_hash);
```

### 5.6 å®‰å…¨æœ€ä½³å®è·µ

```bash
# 1. å®šæœŸæ›´æ–°PostgreSQL
sudo apt-get update && sudo apt-get upgrade postgresql-18

# 2. é™åˆ¶ç½‘ç»œè®¿é—®
# åœ¨pg_hba.confä¸­ä»…å…è®¸å¿…è¦çš„IPè®¿é—®

# 3. ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
# åœ¨åº”ç”¨å±‚æˆ–ä½¿ç”¨passwordcheckæ‰©å±•

# 4. å®šæœŸå¤‡ä»½
# é…ç½®è‡ªåŠ¨å¤‡ä»½è„šæœ¬

# 5. ç›‘æ§å¼‚å¸¸è®¿é—®
# ä½¿ç”¨pg_stat_statementså’Œæ—¥å¿—åˆ†æ
```

## 6. PostgreSQL 18ç”Ÿäº§çº§é…ç½®

### 6.1 å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ<10GBæ•°æ®ï¼Œ<100è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: å°å‹åº”ç”¨ã€å¼€å‘æµ‹è¯•ç¯å¢ƒã€ä¸ªäººé¡¹ç›®

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ2GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 512MB              # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 1GB          # ç³»ç»Ÿå†…å­˜çš„50%
work_mem = 4MB                      # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB         # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 8MB                 # ä¸´æ—¶ç¼“å†²åŒº

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 512MB
max_wal_size = 2GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on                # PostgreSQL 18: WALå‹ç¼©

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1              # SSD
effective_io_concurrency = 200      # SSD
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 64               # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 2          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 1GB

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000  # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
```

**pg_hba.confé…ç½®**:

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             all                                     peer

# IPv4æœ¬åœ°è¿æ¥
host    all             all             127.0.0.1/32            scram-sha-256

# å±€åŸŸç½‘è¿æ¥ï¼ˆä»…å…è®¸ç‰¹å®šç½‘æ®µï¼‰
host    all             all             192.168.1.0/24          scram-sha-256

# SSLè¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
hostssl all             all             0.0.0.0/0               scram-sha-256
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ2GBç³»ç»Ÿï¼‰
kernel.shmmax = 2147483648
kernel.shmall = 524288

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 2097152
```

### 6.2 ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ10-100GBæ•°æ®ï¼Œ100-500è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: ä¸­å‹åº”ç”¨ã€ç”Ÿäº§ç¯å¢ƒã€å¤šç”¨æˆ·ç³»ç»Ÿ

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ8GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 300
superuser_reserved_connections = 5

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 2GB                # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 6GB          # ç³»ç»Ÿå†…å­˜çš„75%
work_mem = 16MB                     # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
maintenance_work_mem = 512MB        # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 16MB                 # ä¸´æ—¶ç¼“å†²åŒº
max_prepared_transactions = 100     # é¢„å‡†å¤‡äº‹åŠ¡

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 16MB                  # WALç¼“å†²åŒº

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1
effective_io_concurrency = 200
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 128              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 4          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 10                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 6GB
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# ============================================
# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
# ============================================
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 500   # è®°å½•è¶…è¿‡500msçš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# ============================================
# ç»Ÿè®¡ä¿¡æ¯
# ============================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
pg_stat_statements.max = 10000
pg_stat_statements.track = all
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ8GBç³»ç»Ÿï¼‰
kernel.shmmax = 8589934592
kernel.shmall = 2097152

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.overcommit_memory = 2

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 2097152
fs.aio-max-nr = 1048576
```

### 6.3 å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ>100GBæ•°æ®ï¼Œ>500è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: å¤§å‹åº”ç”¨ã€é«˜å¹¶å‘ç³»ç»Ÿã€ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ32GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 1000
superuser_reserved_connections = 10

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 8GB                # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 24GB         # ç³»ç»Ÿå†…å­˜çš„75%
work_mem = 64MB                     # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜ï¼ˆæ³¨æ„ï¼šmax_connections * work_memä¸èƒ½å¤ªå¤§ï¼‰
maintenance_work_mem = 2GB          # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 32MB                 # ä¸´æ—¶ç¼“å†²åŒº
max_prepared_transactions = 200     # é¢„å‡†å¤‡äº‹åŠ¡
huge_pages = try                     # å°è¯•ä½¿ç”¨å¤§é¡µ

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 2GB
max_wal_size = 8GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 32MB                  # WALç¼“å†²åŒº
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1
effective_io_concurrency = 300      # NVMe SSD
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 256              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 8          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 16                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 24GB
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
join_collapse_limit = 12
from_collapse_limit = 12

# ============================================
# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
# ============================================
max_parallel_workers_per_gather = 8
max_parallel_workers = 16
max_parallel_maintenance_workers = 8
parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 200    # è®°å½•è¶…è¿‡200msçš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_autovacuum_min_duration = 0     # è®°å½•æ‰€æœ‰autovacuumæ“ä½œ

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 6
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 2000

# ============================================
# ç»Ÿè®¡ä¿¡æ¯
# ============================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
pg_stat_statements.max = 50000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ32GBç³»ç»Ÿï¼‰
kernel.shmmax = 34359738368
kernel.shmall = 8388608

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 8192
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30
net.ipv4.ip_local_port_range = 10000 65535

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 10
vm.dirty_background_ratio = 3
vm.overcommit_memory = 2
vm.overcommit_ratio = 80

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 4194304
fs.aio-max-nr = 1048576
fs.nr_open = 1048576

# å¤§é¡µæ”¯æŒï¼ˆå¯é€‰ï¼Œæå‡æ€§èƒ½ï¼‰
vm.nr_hugepages = 4096
```

### 6.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®

**å¼‚æ­¥I/Oé…ç½®**:

```conf
# postgresql.conf
# å¯ç”¨å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
io_method = aio                     # ä½¿ç”¨å¼‚æ­¥I/O
io_combine_limit = 128              # I/Oè¯·æ±‚åˆå¹¶é™åˆ¶
maintenance_io_workers = 4          # ç»´æŠ¤æ“ä½œçš„I/Oå·¥ä½œè¿›ç¨‹æ•°
max_io_workers = 10                 # æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹æ•°

# æ€§èƒ½æå‡ï¼š
# - é¡ºåºæ‰«ææ€§èƒ½æå‡2-3å€
# - VACUUMæ€§èƒ½æå‡2-3å€
# - ç´¢å¼•æ„å»ºæ€§èƒ½æå‡40%+
```

**è™šæ‹Ÿç”Ÿæˆåˆ—é…ç½®**:

```sql
-- åˆ›å»ºå¸¦è™šæ‹Ÿç”Ÿæˆåˆ—çš„è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) VIRTUAL
);

-- åœ¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆPostgreSQL 18æ”¯æŒï¼‰
CREATE INDEX idx_products_final_price ON products (final_price);

-- æŸ¥è¯¢ä¼˜åŒ–å™¨è‡ªåŠ¨åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM products WHERE final_price BETWEEN 50 AND 100;
```

**OAuth 2.0è®¤è¯é…ç½®**:

```conf
# pg_hba.conf
# OAuth 2.0è®¤è¯ï¼ˆPostgreSQL 18ï¼‰
host    all             all             0.0.0.0/0               oauth

# postgresql.conf
# OAuth 2.0é…ç½®
oauth_issuer = 'https://auth.example.com'
oauth_client_id = 'postgresql-client'
oauth_client_secret = 'client-secret'
oauth_scope = 'openid profile email'
```

## 7. æ•…éšœæ’æŸ¥ä¸è¯Šæ–­

### 7.1 å¯åŠ¨é—®é¢˜æ’æŸ¥

**å¸¸è§å¯åŠ¨é—®é¢˜**:

```bash
# 1. æ£€æŸ¥PostgreSQLè¿›ç¨‹
ps aux | grep postgres

# 2. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la /var/lib/pgsql/18/data
# åº”è¯¥å±äºpostgresç”¨æˆ·

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data --check-config

# 4. æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 5432
# æˆ–
sudo ss -tlnp | grep 5432

# 5. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
sudo tail -f /var/lib/pgsql/18/data/log/postgresql-*.log

# 6. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•ï¼ˆå‰å°è¿è¡Œï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼‰
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

```bash
# é”™è¯¯1: "could not create shared memory segment"
# åŸå› : å…±äº«å†…å­˜ä¸è¶³
# è§£å†³: å¢åŠ kernel.shmmaxå’Œkernel.shmall
sudo sysctl -w kernel.shmmax=68719476736
sudo sysctl -w kernel.shmall=4294967296

# é”™è¯¯2: "FATAL: lock file "postmaster.pid" already exists"
# åŸå› : ä¹‹å‰çš„PostgreSQLè¿›ç¨‹å¼‚å¸¸é€€å‡º
# è§£å†³: æ£€æŸ¥å¹¶åˆ é™¤é”æ–‡ä»¶
sudo -u postgres rm /var/lib/pgsql/18/data/postmaster.pid

# é”™è¯¯3: "FATAL: could not open directory "pg_wal": Permission denied"
# åŸå› : ç›®å½•æƒé™é—®é¢˜
# è§£å†³: ä¿®å¤æƒé™
sudo chown -R postgres:postgres /var/lib/pgsql/18/data
sudo chmod 700 /var/lib/pgsql/18/data

# é”™è¯¯4: "FATAL: password authentication failed"
# åŸå› : å¯†ç é”™è¯¯æˆ–pg_hba.confé…ç½®é—®é¢˜
# è§£å†³: æ£€æŸ¥pg_hba.confé…ç½®å’Œç”¨æˆ·å¯†ç 
```

### 7.2 è¿æ¥é—®é¢˜è¯Šæ–­

**è¿æ¥é—®é¢˜æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# 2. æ£€æŸ¥ç›‘å¬åœ°å€å’Œç«¯å£
sudo netstat -tlnp | grep postgres
# æˆ–
sudo ss -tlnp | grep postgres

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L -n | grep 5432
# æˆ–
sudo firewall-cmd --list-all

# 4. æµ‹è¯•æœ¬åœ°è¿æ¥
psql -h localhost -U postgres -d postgres

# 5. æµ‹è¯•è¿œç¨‹è¿æ¥
psql -h <server_ip> -U postgres -d postgres

# 6. æ£€æŸ¥pg_hba.confé…ç½®
sudo cat /var/lib/pgsql/18/data/pg_hba.conf | grep -v "^#"

# 7. æ£€æŸ¥è¿æ¥æ—¥å¿—
sudo tail -f /var/lib/pgsql/18/data/log/postgresql-*.log | grep -i connection
```

**å¸¸è§è¿æ¥é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**:

```sql
-- é—®é¢˜1: "too many connections"
-- åŸå› : è¿æ¥æ•°è¾¾åˆ°max_connectionsé™åˆ¶
-- è§£å†³: å¢åŠ max_connectionsæˆ–ä½¿ç”¨è¿æ¥æ± 

-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity;

-- æŸ¥çœ‹è¿æ¥è¯¦æƒ…
SELECT
    datname,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change
FROM pg_stat_activity
ORDER BY query_start;

-- æŸ¥çœ‹è¿æ¥æ•°é™åˆ¶
SHOW max_connections;

-- é—®é¢˜2: "connection refused"
-- åŸå› : PostgreSQLæœªå¯åŠ¨æˆ–ç›‘å¬åœ°å€é…ç½®é”™è¯¯
-- è§£å†³: æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œlisten_addressesé…ç½®

-- é—®é¢˜3: "password authentication failed"
-- åŸå› : å¯†ç é”™è¯¯æˆ–è®¤è¯æ–¹æ³•é…ç½®é”™è¯¯
-- è§£å†³: æ£€æŸ¥pg_hba.confå’Œç”¨æˆ·å¯†ç 

-- é‡ç½®å¯†ç 
ALTER USER postgres WITH PASSWORD 'new_password';
```

### 7.3 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½é—®é¢˜æ’æŸ¥æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time,
    stddev_time,
    rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;

-- 2. æ£€æŸ¥é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
AND blocking_locks.granted;

-- 3. æ£€æŸ¥I/Oæ€§èƒ½
SELECT * FROM pg_stat_io
ORDER BY reads DESC
LIMIT 20;

-- 4. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
SELECT
    'index hit rate' AS name,
    (sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read), 0) AS ratio
FROM pg_statio_user_indexes
UNION ALL
SELECT
    'table hit rate' AS name,
    sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) AS ratio
FROM pg_statio_user_tables;

-- 5. æ£€æŸ¥è¡¨å¤§å°å’Œè†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    n_dead_tup,
    n_live_tup,
    round(n_dead_tup * 100.0 / nullif(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- 6. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;
```

**æ€§èƒ½ä¼˜åŒ–è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# performance_diagnosis.sh - PostgreSQLæ€§èƒ½è¯Šæ–­è„šæœ¬

echo "=== PostgreSQLæ€§èƒ½è¯Šæ–­æŠ¥å‘Š ==="
echo "ç”Ÿæˆæ—¶é—´: $(date)"
echo ""

echo "=== 1. ç³»ç»Ÿèµ„æº ==="
echo "å†…å­˜ä½¿ç”¨:"
free -h
echo ""
echo "ç£ç›˜ä½¿ç”¨:"
df -h
echo ""
echo "I/Oç»Ÿè®¡:"
iostat -x 1 3
echo ""

echo "=== 2. PostgreSQLè¿æ¥æ•° ==="
psql -c "SELECT count(*) as total_connections, count(*) FILTER (WHERE state = 'active') as active_connections FROM pg_stat_activity;"
echo ""

echo "=== 3. æ…¢æŸ¥è¯¢Top 10 ==="
psql -c "SELECT query, calls, mean_time, max_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
echo ""

echo "=== 4. é”ç­‰å¾… ==="
psql -c "SELECT count(*) as lock_waits FROM pg_stat_activity WHERE wait_event_type = 'Lock';"
echo ""

echo "=== 5. ç¼“å­˜å‘½ä¸­ç‡ ==="
psql -c "SELECT 'index hit rate' AS name, (sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read), 0) AS ratio FROM pg_statio_user_indexes UNION ALL SELECT 'table hit rate' AS name, sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) AS ratio FROM pg_statio_user_tables;"
echo ""

echo "=== 6. è¡¨å¤§å°Top 10 ==="
psql -c "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_stat_user_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;"
```

### 7.4 æ—¥å¿—åˆ†ææ–¹æ³•

**æ—¥å¿—é…ç½®ä¼˜åŒ–**:

```conf
# postgresql.conf - è¯¦ç»†æ—¥å¿—é…ç½®

# åŸºæœ¬æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# æ—¥å¿—çº§åˆ«
log_min_messages = warning          # è®°å½•è­¦å‘ŠåŠä»¥ä¸Šçº§åˆ«
log_min_error_statement = error     # è®°å½•é”™è¯¯è¯­å¥

# æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500    # è®°å½•è¶…è¿‡500msçš„æŸ¥è¯¢
log_statement = 'ddl'               # è®°å½•DDLè¯­å¥
log_duration = off                  # ä¸è®°å½•æ¯ä¸ªè¯­å¥çš„æŒç»­æ—¶é—´ï¼ˆé¿å…æ—¥å¿—è¿‡å¤§ï¼‰

# è¿æ¥æ—¥å¿—
log_connections = on
log_disconnections = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# æ£€æŸ¥ç‚¹å’ŒWALæ—¥å¿—
log_checkpoints = on
log_autovacuum_min_duration = 0     # è®°å½•æ‰€æœ‰autovacuumæ“ä½œ

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

# ä¸´æ—¶æ–‡ä»¶æ—¥å¿—
log_temp_files = 0                  # è®°å½•æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶åˆ›å»º
```

**æ—¥å¿—åˆ†æå·¥å…·**:

```bash
# 1. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
grep "duration:" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    awk '{print $NF}' | \
    sort -n | \
    tail -20

# 2. åˆ†æé”™è¯¯æ—¥å¿—
grep -i "error\|fatal\|panic" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    tail -50

# 3. åˆ†æè¿æ¥æ—¥å¿—
grep "connection" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    awk '{print $1, $2, $NF}' | \
    sort | uniq -c | sort -rn | head -20

# 4. åˆ†æé”ç­‰å¾…æ—¥å¿—
grep "lock" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    tail -50

# 5. ä½¿ç”¨pgBadgeråˆ†ææ—¥å¿—ï¼ˆæ¨èï¼‰
# å®‰è£…pgBadger
sudo apt-get install pgbadger

# ç”ŸæˆHTMLæŠ¥å‘Š
pgbadger /var/lib/pgsql/18/data/log/postgresql-*.log -o report.html

# 6. å®æ—¶ç›‘æ§æ—¥å¿—
tail -f /var/lib/pgsql/18/data/log/postgresql-*.log | \
    grep -E "ERROR|FATAL|duration|connection"
```

## 8. æ€§èƒ½ä¼˜åŒ–å®è·µ

### 8.1 ç³»ç»Ÿçº§ä¼˜åŒ–

**æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–**:

```bash
# 1. ä½¿ç”¨XFSæ–‡ä»¶ç³»ç»Ÿï¼ˆæ¨èç”¨äºPostgreSQLï¼‰
# åˆ›å»ºXFSæ–‡ä»¶ç³»ç»Ÿ
sudo mkfs.xfs /dev/sdb1

# æŒ‚è½½æ—¶ä¼˜åŒ–å‚æ•°
sudo mount -o noatime,nodiratime /dev/sdb1 /var/lib/pgsql

# 2. è°ƒæ•´I/Oè°ƒåº¦å™¨ï¼ˆSSDæ¨èä½¿ç”¨noneæˆ–noopï¼‰
echo none | sudo tee /sys/block/sdb/queue/scheduler

# 3. ç¦ç”¨æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ—¶é—´æ›´æ–°ï¼ˆæå‡æ€§èƒ½ï¼‰
# åœ¨/etc/fstabä¸­æ·»åŠ noatimeé€‰é¡¹
/dev/sdb1 /var/lib/pgsql xfs defaults,noatime,nodiratime 0 0
```

**ç½‘ç»œä¼˜åŒ–**:

```bash
# /etc/sysctl.conf
# TCPå‚æ•°ä¼˜åŒ–
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
```

### 8.2 æ•°æ®åº“å‚æ•°ä¼˜åŒ–

**å…³é”®å‚æ•°è°ƒä¼˜æŒ‡å—**:

```conf
# ============================================
# å†…å­˜å‚æ•°è°ƒä¼˜
# ============================================
# shared_buffers: ç³»ç»Ÿå†…å­˜çš„25%
# - å¤ªå°ï¼šé¢‘ç¹ç£ç›˜I/O
# - å¤ªå¤§ï¼šå ç”¨è¿‡å¤šç³»ç»Ÿå†…å­˜ï¼Œå½±å“å…¶ä»–è¿›ç¨‹
# æ¨èå€¼ï¼š2GB-8GBï¼ˆæ ¹æ®ç³»ç»Ÿå†…å­˜è°ƒæ•´ï¼‰

# effective_cache_size: ç³»ç»Ÿå†…å­˜çš„50-75%
# - å‘Šè¯‰ä¼˜åŒ–å™¨ç³»ç»Ÿæœ‰å¤šå°‘å†…å­˜å¯ç”¨äºç¼“å­˜
# - ä¸å½±å“å®é™…å†…å­˜ä½¿ç”¨ï¼Œä»…ç”¨äºæŸ¥è¯¢è§„åˆ’
# æ¨èå€¼ï¼šç³»ç»Ÿå†…å­˜çš„75%

# work_mem: æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
# - æ³¨æ„ï¼šmax_connections * work_memä¸èƒ½è¶…è¿‡ç³»ç»Ÿå†…å­˜
# - ç”¨äºæ’åºã€å“ˆå¸Œè¿æ¥ã€åˆå¹¶è¿æ¥ç­‰æ“ä½œ
# æ¨èå€¼ï¼š4MB-64MBï¼ˆæ ¹æ®è¿æ¥æ•°è°ƒæ•´ï¼‰

# ============================================
# I/Oå‚æ•°è°ƒä¼˜ï¼ˆPostgreSQL 18ï¼‰
# ============================================
# io_method = aio: å¯ç”¨å¼‚æ­¥I/O
# - æ€§èƒ½æå‡2-3å€ï¼ˆé¡ºåºæ‰«æã€VACUUMç­‰ï¼‰
# - éœ€è¦Linuxå†…æ ¸æ”¯æŒio_uring

# effective_io_concurrency: I/Oå¹¶å‘æ•°
# - SSD: 200-300
# - NVMe: 300-500
# - HDD: 2-4

# ============================================
# WALå‚æ•°è°ƒä¼˜
# ============================================
# max_wal_size: æœ€å¤§WALå¤§å°
# - å½±å“æ£€æŸ¥ç‚¹é¢‘ç‡
# - æ¨èå€¼ï¼šç³»ç»Ÿå†…å­˜çš„25-50%
# - å¤ªå¤§ï¼šæ¢å¤æ—¶é—´é•¿
# - å¤ªå°ï¼šé¢‘ç¹æ£€æŸ¥ç‚¹ï¼Œå½±å“æ€§èƒ½

# checkpoint_completion_target: æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
# - æ¨èå€¼ï¼š0.9ï¼ˆåœ¨æ£€æŸ¥ç‚¹æ—¶é—´çª—å£çš„90%å†…å®Œæˆï¼‰
# - å¹³æ»‘I/Oè´Ÿè½½
```

### 8.3 å­˜å‚¨ä¼˜åŒ–

**è¡¨ç©ºé—´ä¼˜åŒ–**:

```sql
-- 1. åˆ›å»ºä¸“ç”¨è¡¨ç©ºé—´ï¼ˆä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ï¼‰
CREATE TABLESPACE fast_storage
LOCATION '/fast_storage/postgresql';

-- 2. åœ¨è¡¨ç©ºé—´ä¸Šåˆ›å»ºè¡¨
CREATE TABLE large_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) TABLESPACE fast_storage;

-- 3. ç§»åŠ¨ç°æœ‰è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE large_table SET TABLESPACE fast_storage;

-- 4. æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) AS size
FROM pg_tablespace;
```

**åˆ†åŒºè¡¨ä¼˜åŒ–**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE sales (
    id SERIAL,
    sale_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- 2. åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2024_01 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01')
TABLESPACE fast_storage;

-- 3. ä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•
CREATE INDEX idx_sales_date ON sales (sale_date);

-- 4. è‡ªåŠ¨åˆ›å»ºåˆ†åŒºï¼ˆä½¿ç”¨å‡½æ•°ï¼‰
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';

    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF %I
                    FOR VALUES FROM (%L) TO (%L)',
                    partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 8.4 ç½‘ç»œä¼˜åŒ–

**è¿æ¥æ± é…ç½®**:

```sql
-- ä½¿ç”¨PgBouncerè¿æ¥æ± 
-- pgbouncer.inié…ç½®
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction          # äº‹åŠ¡çº§è¿æ¥æ± 
max_client_conn = 1000           # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
default_pool_size = 25           # é»˜è®¤è¿æ¥æ± å¤§å°
min_pool_size = 5                # æœ€å°è¿æ¥æ± å¤§å°
reserve_pool_size = 5            # ä¿ç•™è¿æ¥æ± å¤§å°
reserve_pool_timeout = 3         # ä¿ç•™è¿æ¥æ± è¶…æ—¶
max_db_connections = 100         # æ¯ä¸ªæ•°æ®åº“æœ€å¤§è¿æ¥æ•°
max_user_connections = 100       # æ¯ä¸ªç”¨æˆ·æœ€å¤§è¿æ¥æ•°
```

## 9. ç›‘æ§ä¸å‘Šè­¦é…ç½®

### 9.1 å…³é”®æŒ‡æ ‡ç›‘æ§

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**:

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active_connections,
    count(*) FILTER (WHERE state = 'idle') as idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    max_conn - count(*) as available_connections
FROM pg_stat_activity, (SELECT setting::int as max_conn FROM pg_settings WHERE name = 'max_connections') mc;

-- 2. æ•°æ®åº“å¤§å°ç›‘æ§
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- 3. è¡¨å¤§å°å’Œè†¨èƒ€ç›‘æ§
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / nullif(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;

-- 4. å¤åˆ¶å»¶è¿Ÿç›‘æ§ï¼ˆå¦‚æœæœ‰ä»åº“ï¼‰
SELECT
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn) AS write_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn) AS flush_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replay_lag_bytes
FROM pg_stat_replication;

-- 5. æ£€æŸ¥ç‚¹ç›‘æ§
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;

-- 6. I/Oæ€§èƒ½ç›‘æ§ï¼ˆPostgreSQL 18ï¼‰
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    read_time,
    write_time,
    sync_time
FROM pg_stat_io
ORDER BY reads DESC;
```

### 9.2 Prometheusç›‘æ§é…ç½®

**PostgreSQL Exporteré…ç½®**:

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:password@postgres:5432/postgres?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - postgres

volumes:
  postgres_data:
```

**Prometheusé…ç½®**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres_exporter:9187']
    metrics_path: /metrics
```

**Grafanaä»ªè¡¨æ¿é…ç½®**:

```json
{
  "dashboard": {
    "title": "PostgreSQLç›‘æ§",
    "panels": [
      {
        "title": "è¿æ¥æ•°",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢QPS",
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])"
          }
        ]
      },
      {
        "title": "ç¼“å­˜å‘½ä¸­ç‡",
        "targets": [
          {
            "expr": "sum(rate(pg_stat_database_blks_hit[5m])) / (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m])))"
          }
        ]
      }
    ]
  }
}
```

### 9.3 å‘Šè­¦è§„åˆ™é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**:

```yaml
# alerts.yml
groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°ä¸º {{ $value }}ï¼Œè¶…è¿‡é˜ˆå€¼80"

      # æ…¢æŸ¥è¯¢å‘Šè­¦
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_mean_exec_time[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢"
          description: "æŸ¥è¯¢å¹³å‡æ‰§è¡Œæ—¶é—´ {{ $value }}ç§’ï¼Œè¶…è¿‡é˜ˆå€¼1ç§’"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 10485760  # 10MB
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿ"
          description: "å¤åˆ¶å»¶è¿Ÿ {{ $value }} å­—èŠ‚ï¼Œè¶…è¿‡é˜ˆå€¼10MB"

      # ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: PostgreSQLDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql"} / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLç£ç›˜ç©ºé—´ä¸è¶³"
          description: "ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡90%"

      # æ£€æŸ¥ç‚¹å‘Šè­¦
      - alert: PostgreSQLCheckpointTooFrequent
        expr: rate(pg_stat_bgwriter_checkpoints_timed[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹"
          description: "æ£€æŸ¥ç‚¹é¢‘ç‡ {{ $value }}ï¼Œå¯èƒ½å½±å“æ€§èƒ½"
```

## 10. å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—

### 10.1 SSL/TLSå®Œæ•´é…ç½®

**ç”ŸæˆSSLè¯ä¹¦**:

```bash
# 1. åˆ›å»ºè¯ä¹¦ç›®å½•
sudo mkdir -p /var/lib/pgsql/18/data/ssl
sudo chown postgres:postgres /var/lib/pgsql/18/data/ssl
cd /var/lib/pgsql/18/data/ssl

# 2. ç”ŸæˆCAç§é’¥
sudo -u postgres openssl genrsa -out ca.key 4096

# 3. ç”ŸæˆCAè¯ä¹¦
sudo -u postgres openssl req -new -x509 -days 3650 -key ca.key -out ca.crt \
    -subj "/CN=PostgreSQL-CA"

# 4. ç”ŸæˆæœåŠ¡å™¨ç§é’¥
sudo -u postgres openssl genrsa -out server.key 4096

# 5. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦è¯·æ±‚
sudo -u postgres openssl req -new -key server.key -out server.csr \
    -subj "/CN=postgresql-server"

# 6. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
sudo -u postgres openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt

# 7. è®¾ç½®æƒé™
sudo chmod 600 server.key
sudo chown postgres:postgres server.key server.crt

# 8. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
sudo rm server.csr
```

**PostgreSQL SSLé…ç½®**:

```conf
# postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'              # å¯é€‰ï¼šå®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
ssl_crl_file = ''                   # å¯é€‰ï¼šè¯ä¹¦æ’¤é”€åˆ—è¡¨
ssl_prefer_server_ciphers = on      # ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨å¯†ç å¥—ä»¶
ssl_ciphers = 'HIGH:!aNULL:!MD5'    # å…è®¸çš„å¯†ç å¥—ä»¶
ssl_min_protocol_version = 'TLSv1.2'  # æœ€å°TLSç‰ˆæœ¬
```

**pg_hba.conf SSLé…ç½®**:

```conf
# å¼ºåˆ¶SSLè¿æ¥
hostssl all             all             0.0.0.0/0               scram-sha-256

# å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰
hostssl all             all             0.0.0.0/0               cert
```

**å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•**:

```bash
# ä½¿ç”¨SSLè¿æ¥
psql "postgresql://user:password@host:5432/dbname?sslmode=require"

# éªŒè¯SSLè¿æ¥
psql -h host -U user -d dbname -c "\conninfo"
# åº”è¯¥æ˜¾ç¤º: SSL connection (protocol: TLSv1.3, cipher: ...)
```

### 10.2 é˜²ç«å¢™è§„åˆ™é…ç½®

**iptablesé˜²ç«å¢™é…ç½®**:

```bash
# 1. å…è®¸æœ¬åœ°è¿æ¥
sudo iptables -A INPUT -i lo -j ACCEPT

# 2. å…è®¸ç‰¹å®šIPè®¿é—®PostgreSQL
sudo iptables -A INPUT -p tcp --dport 5432 -s 192.168.1.0/24 -j ACCEPT

# 3. æ‹’ç»å…¶ä»–IPè®¿é—®PostgreSQL
sudo iptables -A INPUT -p tcp --dport 5432 -j DROP

# 4. ä¿å­˜è§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4

# 5. æŸ¥çœ‹è§„åˆ™
sudo iptables -L -n -v | grep 5432
```

**firewalldé˜²ç«å¢™é…ç½®**:

```bash
# 1. æ·»åŠ PostgreSQLæœåŠ¡
sudo firewall-cmd --permanent --add-service=postgresql

# 2. æˆ–æ·»åŠ è‡ªå®šä¹‰ç«¯å£
sudo firewall-cmd --permanent --add-port=5432/tcp

# 3. é™åˆ¶æºIPï¼ˆå¯é€‰ï¼‰
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port port="5432" protocol="tcp" accept'

# 4. é‡æ–°åŠ è½½é˜²ç«å¢™
sudo firewall-cmd --reload

# 5. æŸ¥çœ‹è§„åˆ™
sudo firewall-cmd --list-all
```

### 10.3 å®¡è®¡æ—¥å¿—é…ç½®

**å¯ç”¨è¯¦ç»†å®¡è®¡æ—¥å¿—**:

```conf
# postgresql.conf
# è®°å½•æ‰€æœ‰DDLè¯­å¥
log_statement = 'ddl'

# è®°å½•æ‰€æœ‰æ•°æ®ä¿®æ”¹è¯­å¥
log_statement = 'mod'

# è®°å½•æ‰€æœ‰è¯­å¥ï¼ˆç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ï¼Œä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼‰
# log_statement = 'all'

# è®°å½•å‚æ•°å€¼
log_parameter_max_length = 1024
log_parameter = on

# è®°å½•è¿æ¥å’Œæ–­å¼€
log_connections = on
log_disconnections = on

# è®°å½•è¿æ¥æŒç»­æ—¶é—´
log_duration = on

# è®°å½•é”ç­‰å¾…
log_lock_waits = on

# è®°å½•ä¸´æ—¶æ–‡ä»¶
log_temp_files = 0
```

**ä½¿ç”¨pgAuditæ‰©å±•ï¼ˆæ¨èï¼‰**:

```sql
-- 1. å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- 2. é…ç½®å®¡è®¡çº§åˆ«
ALTER SYSTEM SET pgaudit.log = 'read,write,ddl';
ALTER SYSTEM SET pgaudit.log_catalog = off;
ALTER SYSTEM SET pgaudit.log_parameter = on;
ALTER SYSTEM SET pgaudit.log_statement_once = on;

-- 3. é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();

-- 4. æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM pg_stat_statements WHERE query LIKE '%DELETE%' OR query LIKE '%UPDATE%';
```

### 10.4 è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®

**è¡Œçº§å®‰å…¨ç­–ç•¥è¯¦ç»†é…ç½®**:

```sql
-- 1. åˆ›å»ºç¤ºä¾‹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        DROP TABLE orders;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: orders';
    END IF;

    CREATE TABLE orders (
        id SERIAL PRIMARY KEY,
        user_id INTEGER,
        order_date DATE,
        amount DECIMAL(10,2),
        status VARCHAR(20)
    );

    RAISE NOTICE 'è¡¨åˆ›å»ºæˆåŠŸ: orders';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨orderså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- 2. å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
    RAISE NOTICE 'è¡Œçº§å®‰å…¨å·²å¯ç”¨: orders';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¯ç”¨è¡Œçº§å®‰å…¨å¤±è´¥: %', SQLERRM;
END $$;

-- 3. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_policies
        WHERE schemaname = 'public'
        AND tablename = 'orders'
        AND policyname = 'user_orders_policy'
    ) THEN
        DROP POLICY user_orders_policy ON orders;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: user_orders_policy';
    END IF;

    CREATE POLICY user_orders_policy ON orders
        FOR SELECT
        TO app_user
        USING (user_id = current_setting('app.current_user_id', true)::INTEGER);

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: user_orders_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- 4. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®¢å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_policies
        WHERE schemaname = 'public'
        AND tablename = 'orders'
        AND policyname = 'user_orders_insert_policy'
    ) THEN
        DROP POLICY user_orders_insert_policy ON orders;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: user_orders_insert_policy';
    END IF;

    CREATE POLICY user_orders_insert_policy ON orders
        FOR INSERT
        TO app_user
        WITH CHECK (user_id = current_setting('app.current_user_id', true)::INTEGER);

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: user_orders_insert_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- 5. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è®¢å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_policies
        WHERE schemaname = 'public'
        AND tablename = 'orders'
        AND policyname = 'user_orders_update_policy'
    ) THEN
        DROP POLICY user_orders_update_policy ON orders;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: user_orders_update_policy';
    END IF;

    CREATE POLICY user_orders_update_policy ON orders
        FOR UPDATE
        TO app_user
        USING (user_id = current_setting('app.current_user_id', true)::INTEGER)
        WITH CHECK (user_id = current_setting('app.current_user_id', true)::INTEGER);

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: user_orders_update_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç”¨æˆ·app_userä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- 6. åˆ›å»ºç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'admin_user'
    ) THEN
        RAISE WARNING 'ç”¨æˆ·admin_userä¸å­˜åœ¨ï¼Œç­–ç•¥å°†æ— æ³•ç”Ÿæ•ˆ';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_policies
        WHERE schemaname = 'public'
        AND tablename = 'orders'
        AND policyname = 'admin_orders_policy'
    ) THEN
        DROP POLICY admin_orders_policy ON orders;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: admin_orders_policy';
    END IF;

    CREATE POLICY admin_orders_policy ON orders
        FOR ALL
        TO admin_user
        USING (true)
        WITH CHECK (true);

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: admin_orders_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE WARNING 'ç”¨æˆ·admin_userä¸å­˜åœ¨ï¼Œç­–ç•¥å·²åˆ›å»ºä½†æ— æ³•ç”Ÿæ•ˆ';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¡¨æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- 7. æµ‹è¯•ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨';
        RETURN;
    END IF;

    SET app.current_user_id = '123';
    SELECT COUNT(*) INTO result_count FROM orders;
    RAISE NOTICE 'å½“å‰ç”¨æˆ·å¯æŸ¥çœ‹ % æ¡è®¢å•ï¼ˆuser_id=123ï¼‰', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•ç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;
```

## 11. åç»­æ•´åˆä»»åŠ¡

- è¡¥å……ç³»ç»Ÿå‚æ•°æ¨èè¡¨ä¸ä¸åŒOSå·®å¼‚

### 11.1 ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚

#### Ubuntu/Debian

```bash
# æ•°æ®ç›®å½•ä½ç½®
/var/lib/postgresql/18/main

# é…ç½®æ–‡ä»¶ä½ç½®
/etc/postgresql/18/main/postgresql.conf
/etc/postgresql/18/main/pg_hba.conf

# æ—¥å¿—ç›®å½•
/var/log/postgresql/
```

#### CentOS/RHEL

```bash
# æ•°æ®ç›®å½•ä½ç½®
/var/lib/pgsql/18/data

# é…ç½®æ–‡ä»¶ä½ç½®
/var/lib/pgsql/18/data/postgresql.conf
/var/lib/pgsql/18/data/pg_hba.conf

# æ—¥å¿—ç›®å½•
/var/lib/pgsql/18/data/log
```

#### macOS (Homebrew)

```bash
# æ•°æ®ç›®å½•ä½ç½®
/opt/homebrew/var/postgresql@18

# é…ç½®æ–‡ä»¶ä½ç½®
/opt/homebrew/var/postgresql@18/postgresql.conf
/opt/homebrew/var/postgresql@18/pg_hba.conf
```

### 11.2 ç³»ç»Ÿå‚æ•°æ¨èè¡¨

| ç³»ç»Ÿå†…å­˜ | shared_buffers | effective_cache_size | work_mem | maintenance_work_mem |
|---------|----------------|---------------------|----------|---------------------|
| 1GB     | 256MB         | 512MB              | 2MB      | 32MB                |
| 2GB     | 512MB         | 1GB                | 4MB      | 64MB                |
| 4GB     | 1GB           | 2GB                | 8MB      | 128MB               |
| 8GB     | 2GB           | 4GB                | 16MB     | 256MB               |
| 16GB    | 4GB           | 8GB                | 32MB     | 512MB               |
| 32GB    | 8GB           | 16GB               | 64MB     | 1GB                 |
| 64GB    | 16GB          | 32GB               | 128MB    | 2GB                 |

### 11.3 æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•

```bash
# 1. æ£€æŸ¥PostgreSQLç‰ˆæœ¬
psql --version

# 2. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la /var/lib/pgsql/18/data

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data -C config_file

# 4. æ£€æŸ¥å…±äº«å†…å­˜
ipcs -m

# 5. æ£€æŸ¥ç³»ç»Ÿèµ„æº
free -h
df -h
iostat -x 1

# 6. æ£€æŸ¥è¿æ¥æ•°
psql -c "SELECT count(*) FROM pg_stat_activity;"

# 7. æ£€æŸ¥æ…¢æŸ¥è¯¢
psql -c "SELECT * FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"
```

---

## 12. OpenTelemetryé›†æˆ

### 12.1 OpenTelemetryæ¶æ„å’ŒåŸç†

**OpenTelemetry**æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†çš„å¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œç”¨äºç”Ÿæˆã€æ”¶é›†å’Œç®¡ç†é¥æµ‹æ•°æ®ï¼ˆæŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ªï¼‰ï¼Œå¸®åŠ©è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œç³»ç»Ÿé—®é¢˜ã€‚

#### 12.1.1 OpenTelemetryæ¶æ„

**æ ¸å¿ƒç»„ä»¶**ï¼š

1. **Instrumentationï¼ˆæ’æ¡©ï¼‰**ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­åµŒå…¥ä»£ç ï¼Œæ”¶é›†é¥æµ‹æ•°æ®
2. **Collectorï¼ˆæ”¶é›†å™¨ï¼‰**ï¼šæ¥æ”¶ã€å¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®
3. **Backendï¼ˆåç«¯ï¼‰**ï¼šå­˜å‚¨å’Œåˆ†æé¥æµ‹æ•°æ®ï¼ˆå¦‚Jaegerã€Zipkinã€Prometheusï¼‰

**æ¶æ„å›¾**ï¼š

```text
åº”ç”¨ç¨‹åº
    â†“
OpenTelemetry SDKï¼ˆæ’æ¡©ï¼‰
    â†“
OpenTelemetry Collector
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Jaeger   â”‚Prometheusâ”‚å…¶ä»–åç«¯ â”‚
â”‚(è¿½è¸ª)   â”‚(æŒ‡æ ‡)   â”‚(æ—¥å¿—)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.1.2 é¥æµ‹æ•°æ®ç±»å‹

**ä¸‰ç§é¥æµ‹æ•°æ®**ï¼š

1. **Tracesï¼ˆè¿½è¸ªï¼‰**ï¼š
   - åˆ†å¸ƒå¼è¯·æ±‚çš„å®Œæ•´è·¯å¾„
   - åŒ…å«spanï¼ˆæ“ä½œï¼‰å’Œtraceï¼ˆè¯·æ±‚ï¼‰
   - ç”¨äºè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

2. **Metricsï¼ˆæŒ‡æ ‡ï¼‰**ï¼š
   - æ•°å€¼å‹æ•°æ®ï¼Œå¦‚CPUä½¿ç”¨ç‡ã€è¯·æ±‚æ•°
   - ç”¨äºç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€

3. **Logsï¼ˆæ—¥å¿—ï¼‰**ï¼š
   - æ–‡æœ¬å‹æ•°æ®ï¼Œè®°å½•äº‹ä»¶å’Œé”™è¯¯
   - ç”¨äºé—®é¢˜è¯Šæ–­

#### 12.1.3 OpenTelemetryä¼˜åŠ¿

**ä¼˜åŠ¿**ï¼š

1. **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„APIå’ŒSDKï¼Œæ”¯æŒå¤šç§è¯­è¨€
2. **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§åç«¯ç³»ç»Ÿ
3. **å¯è§‚æµ‹æ€§**ï¼šæä¾›å®Œæ•´çš„å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆ
4. **è·¨æœåŠ¡è¿½è¸ª**ï¼šè¿½è¸ªè·¨å¤šä¸ªæœåŠ¡çš„è¯·æ±‚

### 12.2 PostgreSQLé©±åŠ¨é›†æˆé…ç½®

#### 12.2.1 Pythoné©±åŠ¨é›†æˆï¼ˆpsycopg3ï¼‰

**å®‰è£…ä¾èµ–**ï¼š

```bash
# å®‰è£…OpenTelemetryç›¸å…³åŒ…
pip install opentelemetry-api opentelemetry-sdk
pip install opentelemetry-instrumentation-psycopg
pip install opentelemetry-exporter-jaeger
pip install opentelemetry-exporter-prometheus
```

**é…ç½®ç¤ºä¾‹**ï¼š

```python
# PostgreSQL OpenTelemetryé›†æˆç¤ºä¾‹ï¼ˆPythonï¼‰
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.jaeger.thrift import JaegerExporter
from opentelemetry.instrumentation.psycopg import PsycopgInstrumentor
import psycopg

# é…ç½®TracerProvider
trace.set_tracer_provider(TracerProvider())

# é…ç½®Jaegerå¯¼å‡ºå™¨
jaeger_exporter = JaegerExporter(
    agent_host_name="localhost",
    agent_port=6831,
)
trace.get_tracer_provider().add_span_processor(
    BatchSpanProcessor(jaeger_exporter)
)

# è‡ªåŠ¨æ’æ¡©psycopg
PsycopgInstrumentor().instrument()

# ä½¿ç”¨PostgreSQLè¿æ¥ï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰
conn = psycopg.connect(
    host="localhost",
    port=5432,
    dbname="mydb",
    user="postgres",
    password="password"
)

# æ‰§è¡ŒæŸ¥è¯¢ï¼ˆè‡ªåŠ¨åˆ›å»ºspanï¼‰
with conn.cursor() as cur:
    cur.execute("SELECT * FROM users WHERE id = %s", (123,))
    result = cur.fetchall()

conn.close()
```

#### 12.2.2 Javaé©±åŠ¨é›†æˆï¼ˆJDBCï¼‰

**Mavenä¾èµ–**ï¼š

```xml
<!-- pom.xml -->
<dependencies>
    <!-- OpenTelemetry API -->
    <dependency>
        <groupId>io.opentelemetry</groupId>
        <artifactId>opentelemetry-api</artifactId>
        <version>1.32.0</version>
    </dependency>

    <!-- OpenTelemetry SDK -->
    <dependency>
        <groupId>io.opentelemetry</groupId>
        <artifactId>opentelemetry-sdk</artifactId>
        <version>1.32.0</version>
    </dependency>

    <!-- JDBCè‡ªåŠ¨æ’æ¡© -->
    <dependency>
        <groupId>io.opentelemetry.instrumentation</groupId>
        <artifactId>opentelemetry-jdbc</artifactId>
        <version>1.32.0-alpha</version>
    </dependency>

    <!-- PostgreSQL JDBCé©±åŠ¨ -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
        <version>42.7.1</version>
    </dependency>
</dependencies>
```

**é…ç½®ç¤ºä¾‹**ï¼š

```java
// PostgreSQL OpenTelemetryé›†æˆç¤ºä¾‹ï¼ˆJavaï¼‰
import io.opentelemetry.api.OpenTelemetry;
import io.opentelemetry.api.trace.Tracer;
import io.opentelemetry.instrumentation.jdbc.OpenTelemetryDriver;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.sql.ResultSet;

public class PostgreSQLOpenTelemetryExample {
    public static void main(String[] args) throws Exception {
        // æ³¨å†ŒOpenTelemetry JDBCé©±åŠ¨
        Class.forName("io.opentelemetry.instrumentation.jdbc.OpenTelemetryDriver");

        // é…ç½®è¿æ¥URLï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰
        String url = "jdbc:otel:postgresql://localhost:5432/mydb";
        String user = "postgres";
        String password = "password";

        // å»ºç«‹è¿æ¥ï¼ˆè‡ªåŠ¨åˆ›å»ºspanï¼‰
        try (Connection conn = DriverManager.getConnection(url, user, password);
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery("SELECT * FROM users WHERE id = 123")) {

            while (rs.next()) {
                System.out.println(rs.getString("name"));
            }
        }
    }
}
```

#### 12.2.3 Node.jsé©±åŠ¨é›†æˆï¼ˆpgï¼‰

**å®‰è£…ä¾èµ–**ï¼š

```bash
npm install @opentelemetry/api
npm install @opentelemetry/sdk-node
npm install @opentelemetry/instrumentation-pg
npm install @opentelemetry/exporter-jaeger
npm install pg
```

**é…ç½®ç¤ºä¾‹**ï¼š

```javascript
// PostgreSQL OpenTelemetryé›†æˆç¤ºä¾‹ï¼ˆNode.jsï¼‰
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { JaegerExporter } = require('@opentelemetry/exporter-jaeger');
const { Resource } = require('@opentelemetry/resources');
const { SemanticResourceAttributes } = require('@opentelemetry/semantic-resources');

// é…ç½®OpenTelemetry SDK
const sdk = new NodeSDK({
  resource: new Resource({
    [SemanticResourceAttributes.SERVICE_NAME]: 'postgresql-app',
  }),
  traceExporter: new JaegerExporter({
    endpoint: 'http://localhost:14268/api/traces',
  }),
  instrumentations: [getNodeAutoInstrumentations()],
});

// å¯åŠ¨SDK
sdk.start();

// ä½¿ç”¨PostgreSQLï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰
const { Pool } = require('pg');

const pool = new Pool({
  host: 'localhost',
  port: 5432,
  database: 'mydb',
  user: 'postgres',
  password: 'password',
});

// æ‰§è¡ŒæŸ¥è¯¢ï¼ˆè‡ªåŠ¨åˆ›å»ºspanï¼‰
async function queryUsers() {
  const result = await pool.query('SELECT * FROM users WHERE id = $1', [123]);
  return result.rows;
}

queryUsers().then(rows => {
  console.log(rows);
  pool.end();
});
```

#### 12.2.4 é…ç½®æœ€ä½³å®è·µ

**é…ç½®å»ºè®®**ï¼š

1. **é‡‡æ ·ç‡**ï¼šæ ¹æ®è´Ÿè½½è°ƒæ•´é‡‡æ ·ç‡ï¼Œé¿å…è¿‡åº¦é‡‡æ ·
2. **æ‰¹é‡å¯¼å‡º**ï¼šä½¿ç”¨æ‰¹é‡å¯¼å‡ºå‡å°‘ç½‘ç»œå¼€é”€
3. **å¼‚æ­¥å¯¼å‡º**ï¼šä½¿ç”¨å¼‚æ­¥å¯¼å‡ºé¿å…é˜»å¡åº”ç”¨
4. **èµ„æºæ ‡ç­¾**ï¼šæ·»åŠ æœåŠ¡åã€ç‰ˆæœ¬ç­‰æ ‡ç­¾ä¾¿äºè¿‡æ»¤

**é…ç½®ç¤ºä¾‹**ï¼š

```python
# OpenTelemetryé…ç½®æœ€ä½³å®è·µï¼ˆPythonï¼‰
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.sdk.resources import Resource
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter

# é…ç½®èµ„æºæ ‡ç­¾
resource = Resource.create({
    "service.name": "postgresql-app",
    "service.version": "1.0.0",
    "deployment.environment": "production",
})

# é…ç½®TracerProvider
trace.set_tracer_provider(TracerProvider(resource=resource))

# é…ç½®OTLPå¯¼å‡ºå™¨ï¼ˆæ¨èï¼‰
otlp_exporter = OTLPSpanExporter(
    endpoint="http://localhost:4317",
    insecure=True,
)

# é…ç½®æ‰¹é‡å¤„ç†å™¨ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
span_processor = BatchSpanProcessor(
    otlp_exporter,
    max_queue_size=2048,  # æœ€å¤§é˜Ÿåˆ—å¤§å°
    max_export_batch_size=512,  # æœ€å¤§æ‰¹é‡å¤§å°
    export_timeout_millis=30000,  # å¯¼å‡ºè¶…æ—¶
)

trace.get_tracer_provider().add_span_processor(span_processor)

# é…ç½®é‡‡æ ·ç‡ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®0.1-0.5ï¼‰
from opentelemetry.sdk.trace.sampling import TraceIdRatioBased

trace.get_tracer_provider().sampler = TraceIdRatioBased(0.1)  # 10%é‡‡æ ·ç‡
```

### 12.3 è·¨æœåŠ¡è¯·æ±‚è·Ÿè¸ªé…ç½®

#### 12.3.1 è¿½è¸ªé…ç½®

**åˆ†å¸ƒå¼è¿½è¸ª**ï¼š

åˆ†å¸ƒå¼è¿½è¸ªé€šè¿‡è¿½è¸ªIDï¼ˆTrace IDï¼‰å’Œè·¨åº¦IDï¼ˆSpan IDï¼‰å…³è”è·¨æœåŠ¡çš„è¯·æ±‚ã€‚

**è¿½è¸ªæµç¨‹**ï¼š

```text
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
æœåŠ¡Aï¼ˆåˆ›å»ºTrace ID: abc123ï¼‰
    â†“
è°ƒç”¨PostgreSQLï¼ˆSpan ID: span1ï¼ŒParent: rootï¼‰
    â†“
è°ƒç”¨æœåŠ¡Bï¼ˆSpan ID: span2ï¼ŒParent: span1ï¼‰
    â†“
è°ƒç”¨PostgreSQLï¼ˆSpan ID: span3ï¼ŒParent: span2ï¼‰
    â†“
è¿”å›ç»“æœï¼ˆæ‰€æœ‰spanå…³è”åˆ°Trace ID: abc123ï¼‰
```

**é…ç½®ç¤ºä¾‹**ï¼š

```python
# è·¨æœåŠ¡è¯·æ±‚è·Ÿè¸ªé…ç½®ï¼ˆPythonï¼‰
from opentelemetry import trace
from opentelemetry.propagate import inject, extract
from opentelemetry.trace.propagation.tracecontext import TraceContextTextMapPropagator
import requests

# åˆ›å»ºè¿½è¸ªå™¨
tracer = trace.get_tracer(__name__)

# æœåŠ¡Aï¼šåˆ›å»ºspanå¹¶ä¼ æ’­ä¸Šä¸‹æ–‡
def service_a():
    with tracer.start_as_current_span("service_a_operation") as span:
        span.set_attribute("service.name", "service-a")
        span.set_attribute("operation.type", "database_query")

        # æ‰§è¡ŒPostgreSQLæŸ¥è¯¢
        with tracer.start_as_current_span("postgresql_query") as db_span:
            db_span.set_attribute("db.system", "postgresql")
            db_span.set_attribute("db.statement", "SELECT * FROM users")
            # æ‰§è¡ŒæŸ¥è¯¢...

        # è°ƒç”¨æœåŠ¡Bï¼ˆä¼ æ’­è¿½è¸ªä¸Šä¸‹æ–‡ï¼‰
        headers = {}
        inject(headers)  # æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡åˆ°HTTPå¤´
        response = requests.get("http://service-b/api/data", headers=headers)

# æœåŠ¡Bï¼šæ¥æ”¶å¹¶ç»§ç»­è¿½è¸ª
def service_b():
    # ä»HTTPå¤´æå–è¿½è¸ªä¸Šä¸‹æ–‡
    headers = request.headers
    context = extract(headers)

    with tracer.start_as_current_span("service_b_operation", context=context) as span:
        span.set_attribute("service.name", "service-b")
        # ç»§ç»­å¤„ç†...
```

#### 12.3.2 ä¸Šä¸‹æ–‡ä¼ æ’­

**ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶**ï¼š

OpenTelemetryé€šè¿‡ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ˆContext Propagationï¼‰åœ¨æœåŠ¡é—´ä¼ é€’è¿½è¸ªä¿¡æ¯ã€‚

**ä¼ æ’­æ–¹å¼**ï¼š

1. **HTTPå¤´ä¼ æ’­**ï¼šé€šè¿‡HTTPå¤´ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡
2. **gRPCå…ƒæ•°æ®ä¼ æ’­**ï¼šé€šè¿‡gRPCå…ƒæ•°æ®ä¼ é€’
3. **æ¶ˆæ¯é˜Ÿåˆ—ä¼ æ’­**ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯å±æ€§ä¼ é€’

**HTTPå¤´ä¼ æ’­ç¤ºä¾‹**ï¼š

```python
# HTTPå¤´ä¼ æ’­é…ç½®
from opentelemetry.propagate import inject, extract
from opentelemetry.trace.propagation.tracecontext import TraceContextTextMapPropagator

# å‘é€è¯·æ±‚æ—¶æ³¨å…¥ä¸Šä¸‹æ–‡
def send_request(url, data):
    headers = {}
    inject(headers)  # æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡
    response = requests.post(url, json=data, headers=headers)
    return response

# æ¥æ”¶è¯·æ±‚æ—¶æå–ä¸Šä¸‹æ–‡
def handle_request(request):
    headers = dict(request.headers)
    context = extract(headers)  # æå–è¿½è¸ªä¸Šä¸‹æ–‡

    with tracer.start_as_current_span("handle_request", context=context):
        # å¤„ç†è¯·æ±‚...
        pass
```

#### 12.3.3 å®é™…æ¡ˆä¾‹

**æ¡ˆä¾‹ï¼šå¾®æœåŠ¡æ¶æ„ä¸­çš„PostgreSQLè¿½è¸ª**:

```python
# å¾®æœåŠ¡æ¶æ„ä¸­çš„PostgreSQLè¿½è¸ªç¤ºä¾‹
from opentelemetry import trace
from opentelemetry.instrumentation.psycopg import PsycopgInstrumentor
import psycopg
from flask import Flask, request
from opentelemetry.propagate import extract

app = Flask(__name__)
tracer = trace.get_tracer(__name__)

# è‡ªåŠ¨æ’æ¡©PostgreSQL
PsycopgInstrumentor().instrument()

# ç”¨æˆ·æœåŠ¡
@app.route('/api/users/<user_id>', methods=['GET'])
def get_user(user_id):
    # ä»è¯·æ±‚å¤´æå–è¿½è¸ªä¸Šä¸‹æ–‡
    context = extract(dict(request.headers))

    with tracer.start_as_current_span("get_user", context=context) as span:
        span.set_attribute("user.id", user_id)

        # è¿æ¥PostgreSQLï¼ˆè‡ªåŠ¨åˆ›å»ºspanï¼‰
        conn = psycopg.connect(
            host="localhost",
            port=5432,
            dbname="mydb",
            user="postgres",
            password="password"
        )

        with conn.cursor() as cur:
            # æŸ¥è¯¢ç”¨æˆ·ï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰
            cur.execute("SELECT * FROM users WHERE id = %s", (user_id,))
            user = cur.fetchone()

        conn.close()

        return {"user": user}
```

### 12.4 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«æ–¹æ³•

#### 12.4.1 è¿½è¸ªæ•°æ®åˆ†æ

**åˆ†æç»´åº¦**ï¼š

1. **SpanæŒç»­æ—¶é—´**ï¼šè¯†åˆ«è€—æ—¶æœ€é•¿çš„æ“ä½œ
2. **Spanæ•°é‡**ï¼šè¯†åˆ«è°ƒç”¨æœ€é¢‘ç¹çš„æ“ä½œ
3. **é”™è¯¯ç‡**ï¼šè¯†åˆ«é”™è¯¯ç‡æœ€é«˜çš„æ“ä½œ
4. **ä¾èµ–å…³ç³»**ï¼šè¯†åˆ«æœåŠ¡é—´çš„ä¾èµ–å…³ç³»

**åˆ†æå·¥å…·**ï¼š

1. **Jaeger UI**ï¼šå¯è§†åŒ–è¿½è¸ªæ•°æ®
2. **Zipkin UI**ï¼šè¿½è¸ªæ•°æ®å¯è§†åŒ–
3. **Grafana Tempo**ï¼šä¸Grafanaé›†æˆ

**åˆ†æç¤ºä¾‹**ï¼š

```sql
-- ä½¿ç”¨JaegeræŸ¥è¯¢è¿½è¸ªæ•°æ®ï¼ˆæ¦‚å¿µæ€§ç¤ºä¾‹ï¼‰
-- å®é™…ä½¿ç”¨Jaeger APIæˆ–UI

-- æŸ¥è¯¢æœ€æ…¢çš„PostgreSQLæŸ¥è¯¢
SELECT
  operation_name,
  AVG(duration) AS avg_duration,
  MAX(duration) AS max_duration,
  COUNT(*) AS call_count
FROM traces
WHERE service_name = 'postgresql'
  AND operation_name LIKE '%query%'
GROUP BY operation_name
ORDER BY avg_duration DESC
LIMIT 10;
```

#### 12.4.2 ç“¶é¢ˆå®šä½æ–¹æ³•

**å®šä½æ­¥éª¤**ï¼š

1. **è¯†åˆ«æ…¢æ“ä½œ**ï¼šé€šè¿‡è¿½è¸ªæ•°æ®è¯†åˆ«è€—æ—¶æœ€é•¿çš„æ“ä½œ
2. **åˆ†æè°ƒç”¨é“¾**ï¼šåˆ†æå®Œæ•´çš„è°ƒç”¨é“¾ï¼Œæ‰¾å‡ºç“¶é¢ˆç¯èŠ‚
3. **æ£€æŸ¥ä¾èµ–**ï¼šæ£€æŸ¥å¤–éƒ¨ä¾èµ–ï¼ˆæ•°æ®åº“ã€APIç­‰ï¼‰çš„æ€§èƒ½
4. **ä¼˜åŒ–å»ºè®®**ï¼šæ ¹æ®åˆ†æç»“æœæå‡ºä¼˜åŒ–å»ºè®®

**ç“¶é¢ˆè¯†åˆ«ç¤ºä¾‹**ï¼š

```python
# æ€§èƒ½ç“¶é¢ˆè¯†åˆ«è„šæœ¬ï¼ˆPythonï¼‰
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import ConsoleSpanExporter

# é…ç½®æ§åˆ¶å°å¯¼å‡ºå™¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
trace.set_tracer_provider(TracerProvider())
trace.get_tracer_provider().add_span_processor(
    BatchSpanProcessor(ConsoleSpanExporter())
)

tracer = trace.get_tracer(__name__)

# æ‰§è¡Œæ“ä½œå¹¶åˆ†ææ€§èƒ½
def analyze_performance():
    with tracer.start_as_current_span("complex_operation") as span:
        # æ­¥éª¤1ï¼šæ•°æ®åº“æŸ¥è¯¢
        with tracer.start_as_current_span("db_query") as db_span:
            # æ‰§è¡ŒæŸ¥è¯¢...
            db_span.set_attribute("db.query.duration", 100)  # 100ms

        # æ­¥éª¤2ï¼šå¤–éƒ¨APIè°ƒç”¨
        with tracer.start_as_current_span("api_call") as api_span:
            # è°ƒç”¨API...
            api_span.set_attribute("http.duration", 500)  # 500msï¼ˆç“¶é¢ˆï¼ï¼‰

        # æ­¥éª¤3ï¼šæ•°æ®å¤„ç†
        with tracer.start_as_current_span("data_processing") as proc_span:
            # å¤„ç†æ•°æ®...
            proc_span.set_attribute("processing.duration", 50)  # 50ms

# åˆ†æç»“æœï¼š
# - æ€»è€—æ—¶ï¼š650ms
# - ç“¶é¢ˆï¼šAPIè°ƒç”¨ï¼ˆ500msï¼Œ77%ï¼‰
# - ä¼˜åŒ–å»ºè®®ï¼šä¼˜åŒ–APIè°ƒç”¨æˆ–ä½¿ç”¨ç¼“å­˜
```

#### 12.4.3 ä¼˜åŒ–å»ºè®®

**å¸¸è§ä¼˜åŒ–å»ºè®®**ï¼š

1. **æ•°æ®åº“ä¼˜åŒ–**ï¼š
   - æ·»åŠ ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
   - ä½¿ç”¨è¿æ¥æ± 
   - å¯ç”¨æŸ¥è¯¢ç¼“å­˜

2. **APIè°ƒç”¨ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨å¼‚æ­¥è°ƒç”¨
   - å®ç°è¯·æ±‚æ‰¹å¤„ç†
   - ä½¿ç”¨ç¼“å­˜å‡å°‘APIè°ƒç”¨

3. **æœåŠ¡ä¼˜åŒ–**ï¼š
   - å‡å°‘æœåŠ¡é—´è°ƒç”¨
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
   - å®ç°æœåŠ¡ç¼“å­˜

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```python
# åŸºäºè¿½è¸ªæ•°æ®çš„ä¼˜åŒ–å»ºè®®ï¼ˆPythonï¼‰
def generate_optimization_suggestions(trace_data):
    suggestions = []

    # åˆ†ææ•°æ®åº“æŸ¥è¯¢
    db_spans = [s for s in trace_data.spans if s.attributes.get('db.system') == 'postgresql']
    if db_spans:
        avg_db_duration = sum(s.duration for s in db_spans) / len(db_spans)
        if avg_db_duration > 100:  # è¶…è¿‡100ms
            suggestions.append({
                'type': 'database',
                'issue': f'å¹³å‡æ•°æ®åº“æŸ¥è¯¢æ—¶é—´è¿‡é•¿: {avg_db_duration}ms',
                'suggestions': [
                    'æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦æœ‰åˆé€‚çš„ç´¢å¼•',
                    'ä¼˜åŒ–æŸ¥è¯¢è¯­å¥',
                    'è€ƒè™‘ä½¿ç”¨è¿æ¥æ± ',
                ]
            })

    # åˆ†æAPIè°ƒç”¨
    api_spans = [s for s in trace_data.spans if s.attributes.get('http.method')]
    if api_spans:
        avg_api_duration = sum(s.duration for s in api_spans) / len(api_spans)
        if avg_api_duration > 200:  # è¶…è¿‡200ms
            suggestions.append({
                'type': 'api',
                'issue': f'å¹³å‡APIè°ƒç”¨æ—¶é—´è¿‡é•¿: {avg_api_duration}ms',
                'suggestions': [
                    'è€ƒè™‘ä½¿ç”¨å¼‚æ­¥è°ƒç”¨',
                    'å®ç°è¯·æ±‚æ‰¹å¤„ç†',
                    'ä½¿ç”¨ç¼“å­˜å‡å°‘APIè°ƒç”¨',
                ]
            })

    return suggestions
```

---

## 13. ELK/Graylogæ—¥å¿—ç®¡ç†

### 13.1 ELK Stackå®Œæ•´é…ç½®

**ELK Stack**æ˜¯ç”±Elasticsearchã€Logstashå’ŒKibanaç»„æˆçš„æ—¥å¿—ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ”¶é›†ã€å­˜å‚¨ã€åˆ†æå’Œå¯è§†åŒ–æ—¥å¿—æ•°æ®ã€‚

#### 13.1.1 Elasticsearché…ç½®

**Elasticsearch**æ˜¯åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œç”¨äºå­˜å‚¨å’Œç´¢å¼•æ—¥å¿—æ•°æ®ã€‚

**å®‰è£…å’Œé…ç½®**ï¼š

```bash
# å®‰è£…Elasticsearchï¼ˆUbuntu/Debianï¼‰
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
sudo apt-get update && sudo apt-get install elasticsearch

# é…ç½®Elasticsearch
sudo nano /etc/elasticsearch/elasticsearch.yml
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š

```yaml
# /etc/elasticsearch/elasticsearch.yml
cluster.name: postgresql-logs
node.name: node-1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 0.0.0.0
http.port: 9200
discovery.type: single-node  # å•èŠ‚ç‚¹é…ç½®

# ç”Ÿäº§ç¯å¢ƒé…ç½®
bootstrap.memory_lock: true
cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 85%
cluster.routing.allocation.disk.watermark.high: 90%
```

**å¯åŠ¨å’ŒéªŒè¯**ï¼š

```bash
# å¯åŠ¨Elasticsearch
sudo systemctl start elasticsearch
sudo systemctl enable elasticsearch

# éªŒè¯Elasticsearchè¿è¡Œ
curl http://localhost:9200
```

#### 13.1.2 Logstashé…ç½®

**Logstash**æ˜¯æ•°æ®æ”¶é›†å’Œå¤„ç†ç®¡é“ï¼Œç”¨äºä»PostgreSQLæ”¶é›†æ—¥å¿—å¹¶å‘é€åˆ°Elasticsearchã€‚

**å®‰è£…å’Œé…ç½®**ï¼š

```bash
# å®‰è£…Logstash
sudo apt-get install logstash

# åˆ›å»ºPostgreSQLæ—¥å¿—æ”¶é›†é…ç½®
sudo nano /etc/logstash/conf.d/postgresql.conf
```

**Logstashé…ç½®ç¤ºä¾‹**ï¼š

```ruby
# /etc/logstash/conf.d/postgresql.conf
input {
  # ä»PostgreSQLæ—¥å¿—æ–‡ä»¶è¯»å–
  file {
    path => "/var/log/postgresql/postgresql-*.log"
    start_position => "beginning"
    sincedb_path => "/var/lib/logstash/sincedb"
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
    }
  }

  # ä»syslogè¯»å–ï¼ˆå¦‚æœPostgreSQLæ—¥å¿—å‘é€åˆ°syslogï¼‰
  syslog {
    port => 514
    type => "postgresql"
  }
}

filter {
  if [type] == "postgresql" {
    # è§£æPostgreSQLæ—¥å¿—æ ¼å¼
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{NUMBER:pid}\] %{WORD:level}:  %{GREEDYDATA:message}"
      }
    }

    # è§£æSQLè¯­å¥
    if [message] =~ /statement:/ {
      grok {
        match => {
          "message" => "statement: %{GREEDYDATA:sql_statement}"
        }
      }
    }

    # è§£æè¿æ¥ä¿¡æ¯
    if [message] =~ /connection/ {
      grok {
        match => {
          "message" => "connection %{WORD:connection_type}: %{GREEDYDATA:connection_info}"
        }
      }
    }

    # è§£æé”™è¯¯ä¿¡æ¯
    if [level] == "ERROR" {
      grok {
        match => {
          "message" => "ERROR:  %{GREEDYDATA:error_message}"
        }
      }
    }

    # æ—¥æœŸè§£æ
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    }

    # æ·»åŠ å­—æ®µ
    mutate {
      add_field => {
        "database" => "postgresql"
        "environment" => "production"
      }
    }
  }
}

output {
  # è¾“å‡ºåˆ°Elasticsearch
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "postgresql-logs-%{+YYYY.MM.dd}"
    template_name => "postgresql-logs"
    template => "/etc/logstash/templates/postgresql-logs.json"
    template_overwrite => true
  }

  # è°ƒè¯•è¾“å‡ºï¼ˆå¯é€‰ï¼‰
  stdout {
    codec => rubydebug
  }
}
```

**PostgreSQLæ—¥å¿—é…ç½®**ï¼š

```conf
# postgresql.conf
# å¯ç”¨æ—¥å¿—è®°å½•
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# è®°å½•æ‰€æœ‰SQLè¯­å¥ï¼ˆç”¨äºåˆ†æï¼‰
log_statement = 'all'
log_min_duration_statement = 0

# è®°å½•è¿æ¥ä¿¡æ¯
log_connections = on
log_disconnections = on

# è®°å½•é”ç­‰å¾…
log_lock_waits = on

# è®°å½•æ£€æŸ¥ç‚¹
log_checkpoints = on

# è®°å½•è‡ªåŠ¨æ¸…ç†
log_autovacuum_min_duration = 0

# æ—¥å¿—æ ¼å¼ï¼ˆä¾¿äºè§£æï¼‰
log_line_prefix = '%t [%p] %l: '
log_timezone = 'UTC'
```

#### 13.1.3 Kibanaé…ç½®

**Kibana**æ˜¯æ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨äºæŸ¥è¯¢å’Œå¯è§†åŒ–Elasticsearchä¸­çš„æ—¥å¿—æ•°æ®ã€‚

**å®‰è£…å’Œé…ç½®**ï¼š

```bash
# å®‰è£…Kibana
sudo apt-get install kibana

# é…ç½®Kibana
sudo nano /etc/kibana/kibana.yml
```

**Kibanaé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# /etc/kibana/kibana.yml
server.port: 5601
server.host: "0.0.0.0"
elasticsearch.hosts: ["http://localhost:9200"]
kibana.index: ".kibana"

# ç”Ÿäº§ç¯å¢ƒé…ç½®
server.maxPayloadBytes: 1048576
elasticsearch.requestTimeout: 300000
```

**åˆ›å»ºKibanaä»ªè¡¨æ¿**ï¼š

```json
// Kibanaä»ªè¡¨æ¿é…ç½®ç¤ºä¾‹ï¼ˆJSONå¯¼å‡ºæ ¼å¼ï¼‰
{
  "version": "8.0.0",
  "objects": [
    {
      "type": "dashboard",
      "id": "postgresql-logs-dashboard",
      "attributes": {
        "title": "PostgreSQL Logs Dashboard",
        "panelsJSON": "[...]"
      }
    }
  ]
}
```

**Kibanaå¯è§†åŒ–é…ç½®**ï¼š

```text
Kibanaå¯è§†åŒ–é…ç½®æ­¥éª¤ï¼š

1. åˆ›å»ºç´¢å¼•æ¨¡å¼
   - æ¨¡å¼ï¼špostgresql-logs-*
   - æ—¶é—´å­—æ®µï¼š@timestamp

2. åˆ›å»ºå¯è§†åŒ–
   - é”™è¯¯æ—¥å¿—æ•°é‡ï¼ˆæŸ±çŠ¶å›¾ï¼‰
   - æ…¢æŸ¥è¯¢è¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾ï¼‰
   - è¿æ¥æ•°ç»Ÿè®¡ï¼ˆé¥¼å›¾ï¼‰
   - SQLè¯­å¥åˆ†å¸ƒï¼ˆè¯äº‘ï¼‰

3. åˆ›å»ºä»ªè¡¨æ¿
   - ç»„åˆæ‰€æœ‰å¯è§†åŒ–
   - è®¾ç½®è‡ªåŠ¨åˆ·æ–°
   - é…ç½®ç­›é€‰å™¨
```

### 13.2 Graylogé…ç½®å’Œé›†æˆ

**Graylog**æ˜¯å¼€æºçš„æ—¥å¿—ç®¡ç†å¹³å°ï¼Œæä¾›æ—¥å¿—æ”¶é›†ã€å­˜å‚¨ã€æœç´¢å’Œåˆ†æåŠŸèƒ½ã€‚

#### 13.2.1 Graylogå®‰è£…é…ç½®

**å®‰è£…Graylog**ï¼š

```bash
# å®‰è£…MongoDBï¼ˆGraylogå…ƒæ•°æ®å­˜å‚¨ï¼‰
sudo apt-get install mongodb-org

# å®‰è£…Elasticsearchï¼ˆGraylogæ•°æ®å­˜å‚¨ï¼‰
sudo apt-get install elasticsearch

# å®‰è£…Graylog
wget https://packages.graylog2.org/repo/packages/graylog-5.1-repository_latest.deb
sudo dpkg -i graylog-5.1-repository_latest.deb
sudo apt-get update
sudo apt-get install graylog-server
```

**Graylogé…ç½®**ï¼š

```conf
# /etc/graylog/server/server.conf
is_master = true
node_id_file = /etc/graylog/server/node-id
password_secret = <generate-secret>
root_username = admin
root_password_sha2 = <generate-hash>
http_bind_address = 0.0.0.0:9000
http_external_uri = http://localhost:9000/
elasticsearch_hosts = http://localhost:9200
mongodb_uri = mongodb://localhost:27017/graylog
```

#### 13.2.2 PostgreSQLé›†æˆ

**é…ç½®PostgreSQLæ—¥å¿—è¾“å…¥**ï¼š

```text
Graylogè¾“å…¥é…ç½®ï¼š

1. System -> Inputs
2. é€‰æ‹©è¾“å…¥ç±»å‹ï¼š
   - GELF UDPï¼ˆæ¨èï¼‰
   - Syslog UDP
   - Beatsï¼ˆFilebeatï¼‰
3. é…ç½®è¾“å…¥å‚æ•°
4. å¯åŠ¨è¾“å…¥
```

**ä½¿ç”¨Filebeatæ”¶é›†PostgreSQLæ—¥å¿—**ï¼š

```yaml
# /etc/filebeat/filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/postgresql/postgresql-*.log
    fields:
      logtype: postgresql
      environment: production
    fields_under_root: true
    multiline.pattern: '^%{TIMESTAMP_ISO8601}'
    multiline.negate: true
    multiline.match: after

processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~

output.logstash:
  hosts: ["localhost:5044"]

# æˆ–ç›´æ¥è¾“å‡ºåˆ°Graylog
output.gelf:
  hosts: ["localhost:12201"]
```

**PostgreSQLæ—¥å¿—æ ¼å¼é…ç½®**ï¼š

```conf
# postgresql.conf
# é…ç½®æ—¥å¿—æ ¼å¼ä¾¿äºGraylogè§£æ
log_line_prefix = '%t [%p] %l: '
log_timezone = 'UTC'
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'

# è®°å½•è¯¦ç»†ä¿¡æ¯
log_statement = 'all'
log_min_duration_statement = 0
log_connections = on
log_disconnections = on
log_lock_waits = on
```

#### 13.2.3 æ—¥å¿—é‡‡é›†é…ç½®

**ä½¿ç”¨rsyslogè½¬å‘æ—¥å¿—**ï¼š

```conf
# /etc/rsyslog.d/30-postgresql.conf
# è½¬å‘PostgreSQLæ—¥å¿—åˆ°Graylog
$ModLoad imfile
$InputFileName /var/log/postgresql/postgresql-*.log
$InputFileTag postgresql:
$InputFileStateFile postgresql-state
$InputFileSeverity info
$InputFileFacility local0
$InputRunFileMonitor

*.* @localhost:514;RSYSLOG_SyslogProtocol23Format
```

**ä½¿ç”¨GELFç›´æ¥å‘é€**ï¼š

```python
# ä½¿ç”¨Pythonå‘é€æ—¥å¿—åˆ°Graylogï¼ˆGELFæ ¼å¼ï¼‰
import json
import socket
from datetime import datetime

def send_to_graylog(message, level='INFO', host='localhost', port=12201):
    """å‘é€æ—¥å¿—åˆ°Graylogï¼ˆGELFæ ¼å¼ï¼‰"""
    gelf_message = {
        "version": "1.1",
        "host": socket.gethostname(),
        "short_message": message,
        "full_message": message,
        "timestamp": datetime.now().timestamp(),
        "level": 6 if level == 'INFO' else 3,  # 6=INFO, 3=ERROR
        "_service": "postgresql",
        "_environment": "production"
    }

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(json.dumps(gelf_message).encode(), (host, port))
    sock.close()

# ä½¿ç”¨ç¤ºä¾‹
send_to_graylog("PostgreSQL connection established", "INFO")
send_to_graylog("Slow query detected: SELECT * FROM large_table", "WARNING")
```

### 13.3 æ—¥å¿—åˆ†æå’ŒæŸ¥è¯¢

#### 13.3.1 æŸ¥è¯¢è¯­æ³•

**ElasticsearchæŸ¥è¯¢è¯­æ³•ï¼ˆKibanaï¼‰**ï¼š

```text
KibanaæŸ¥è¯¢ç¤ºä¾‹ï¼š

1. åŸºæœ¬æŸ¥è¯¢
   - æœç´¢æ‰€æœ‰é”™è¯¯ï¼šlevel:ERROR
   - æœç´¢ç‰¹å®šæ—¶é—´ï¼š@timestamp:[2025-01-16 TO 2025-01-17]
   - ç»„åˆæŸ¥è¯¢ï¼šlevel:ERROR AND message:connection

2. å­—æ®µæŸ¥è¯¢
   - æœç´¢ç‰¹å®šSQLï¼šsql_statement:SELECT
   - æœç´¢ç‰¹å®šç”¨æˆ·ï¼šuser:postgres
   - æœç´¢ç‰¹å®šæ•°æ®åº“ï¼šdatabase:mydb

3. æ­£åˆ™è¡¨è¾¾å¼
   - æœç´¢æ¨¡å¼ï¼šmessage:/timeout|deadlock/i

4. èŒƒå›´æŸ¥è¯¢
   - æœç´¢æ…¢æŸ¥è¯¢ï¼šduration:[100 TO *]
   - æœç´¢ç‰¹å®šPIDï¼špid:[1000 TO 2000]
```

**GraylogæŸ¥è¯¢è¯­æ³•**ï¼š

```text
GraylogæŸ¥è¯¢ç¤ºä¾‹ï¼š

1. åŸºæœ¬æŸ¥è¯¢
   - æœç´¢æ‰€æœ‰é”™è¯¯ï¼šlevel:ERROR
   - æœç´¢ç‰¹å®šæ¶ˆæ¯ï¼šmessage:"connection failed"
   - ç»„åˆæŸ¥è¯¢ï¼šlevel:ERROR AND message:timeout

2. å­—æ®µæŸ¥è¯¢
   - æœç´¢ç‰¹å®šå­—æ®µï¼šsource:postgresql-server-1
   - æœç´¢ç‰¹å®šæœåŠ¡ï¼šservice:postgresql

3. æ—¶é—´èŒƒå›´
   - æœ€è¿‘1å°æ—¶ï¼štimestamp:[now-1h TO now]
   - ç‰¹å®šæ—¥æœŸï¼štimestamp:2025-01-16

4. å‡½æ•°æŸ¥è¯¢
   - ç»Ÿè®¡é”™è¯¯æ•°ï¼šcount(level:ERROR)
   - åˆ†ç»„ç»Ÿè®¡ï¼šgroupby(level)
```

#### 13.3.2 åˆ†ææ¡ˆä¾‹

**æ¡ˆä¾‹1ï¼šæ…¢æŸ¥è¯¢åˆ†æ**ï¼š

```text
KibanaæŸ¥è¯¢ï¼šåˆ†ææ…¢æŸ¥è¯¢

æŸ¥è¯¢æ¡ä»¶ï¼š
- duration:[100 TO *]  # æŸ¥è¯¢æ—¶é—´è¶…è¿‡100ms
- @timestamp:[now-1d TO now]  # æœ€è¿‘24å°æ—¶

åˆ†æç»´åº¦ï¼š
1. æŒ‰SQLè¯­å¥åˆ†ç»„ç»Ÿè®¡
2. æŒ‰æ‰§è¡Œæ—¶é—´æ’åº
3. è¯†åˆ«æœ€æ…¢çš„æŸ¥è¯¢
4. åˆ†ææŸ¥è¯¢æ¨¡å¼

å¯è§†åŒ–ï¼š
- æ…¢æŸ¥è¯¢è¶‹åŠ¿å›¾ï¼ˆæŠ˜çº¿å›¾ï¼‰
- æ…¢æŸ¥è¯¢åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰
- SQLè¯­å¥è¯äº‘
```

**æ¡ˆä¾‹2ï¼šé”™è¯¯æ—¥å¿—åˆ†æ**ï¼š

```text
GraylogæŸ¥è¯¢ï¼šåˆ†æé”™è¯¯æ—¥å¿—

æŸ¥è¯¢æ¡ä»¶ï¼š
- level:ERROR
- timestamp:[now-7d TO now]  # æœ€è¿‘7å¤©

åˆ†æç»´åº¦ï¼š
1. é”™è¯¯ç±»å‹ç»Ÿè®¡
2. é”™è¯¯é¢‘ç‡è¶‹åŠ¿
3. é”™è¯¯æ¥æºåˆ†æ
4. é”™è¯¯å½±å“è¯„ä¼°

å¯è§†åŒ–ï¼š
- é”™è¯¯æ•°é‡è¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾ï¼‰
- é”™è¯¯ç±»å‹åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰
- é”™è¯¯æ¥æºåœ°å›¾ï¼ˆåœ°ç†åˆ†å¸ƒï¼‰
```

**æ¡ˆä¾‹3ï¼šè¿æ¥åˆ†æ**ï¼š

```sql
-- ä½¿ç”¨Kibanaåˆ†æPostgreSQLè¿æ¥
-- æŸ¥è¯¢æ¡ä»¶ï¼šlog_connections:true

-- åˆ†æç»´åº¦ï¼š
-- 1. è¿æ¥æ•°è¶‹åŠ¿
-- 2. è¿æ¥æ¥æºIPåˆ†å¸ƒ
-- 3. è¿æ¥æŒç»­æ—¶é—´
-- 4. è¿æ¥å¤±è´¥åŸå› 

-- KibanaæŸ¥è¯¢ç¤ºä¾‹
{
  "query": {
    "bool": {
      "must": [
        {"match": {"message": "connection"}},
        {"range": {"@timestamp": {"gte": "now-1d"}}}
      ]
    }
  },
  "aggs": {
    "connections_by_hour": {
      "date_histogram": {
        "field": "@timestamp",
        "interval": "1h"
      }
    },
    "connections_by_ip": {
      "terms": {
        "field": "client_ip.keyword",
        "size": 10
      }
    }
  }
}
```

#### 13.3.3 å¯è§†åŒ–é…ç½®

**Kibanaä»ªè¡¨æ¿é…ç½®**ï¼š

```json
// PostgreSQLæ—¥å¿—ç›‘æ§ä»ªè¡¨æ¿é…ç½®
{
  "dashboard": {
    "title": "PostgreSQL Logs Monitoring",
    "panels": [
      {
        "type": "visualization",
        "id": "error-count",
        "title": "Error Count",
        "visState": {
          "type": "histogram",
          "params": {
            "field": "@timestamp",
            "interval": "1h"
          },
          "aggs": [
            {
              "type": "filter",
              "params": {
                "query": "level:ERROR"
              }
            },
            {
              "type": "count"
            }
          ]
        }
      },
      {
        "type": "visualization",
        "id": "slow-queries",
        "title": "Slow Queries",
        "visState": {
          "type": "line",
          "params": {
            "field": "duration",
            "interval": "1h"
          }
        }
      }
    ]
  }
}
```

### 13.4 æ—¥å¿—å‘Šè­¦é…ç½®

#### 13.4.1 å‘Šè­¦è§„åˆ™é…ç½®

**Kibanaå‘Šè­¦é…ç½®**ï¼š

```json
// Kibanaå‘Šè­¦è§„åˆ™é…ç½®
{
  "alert": {
    "name": "PostgreSQL Error Alert",
    "schedule": {
      "interval": "1m"
    },
    "conditions": {
      "aggType": "count",
      "aggField": "@timestamp",
      "termSize": 5,
      "termField": "level.keyword",
      "thresholdComparator": ">",
      "threshold": [10]
    },
    "actions": [
      {
        "type": "email",
        "subject": "PostgreSQL Error Alert",
        "to": ["admin@example.com"],
        "body": "Error count exceeded threshold: {{context.conditions}}"
      },
      {
        "type": "webhook",
        "url": "https://hooks.slack.com/services/YOUR/WEBHOOK/URL",
        "body": "{\"text\": \"PostgreSQL Error Alert: {{context.conditions}}\"}"
      }
    ]
  }
}
```

**Graylogå‘Šè­¦é…ç½®**ï¼š

```text
Graylogå‘Šè­¦é…ç½®æ­¥éª¤ï¼š

1. System -> Alerts
2. åˆ›å»ºå‘Šè­¦æ¡ä»¶ï¼š
   - æŸ¥è¯¢ï¼šlevel:ERROR
   - æ—¶é—´èŒƒå›´ï¼š5åˆ†é’Ÿ
   - é˜ˆå€¼ï¼šé”™è¯¯æ•° > 10
3. é…ç½®é€šçŸ¥ï¼š
   - Emailé€šçŸ¥
   - Slacké€šçŸ¥
   - PagerDutyé€šçŸ¥
4. æµ‹è¯•å‘Šè­¦
```

**å‘Šè­¦è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
# Graylogå‘Šè­¦è§„åˆ™é…ç½®ï¼ˆYAMLæ ¼å¼ï¼‰
alerts:
  - name: "PostgreSQL High Error Rate"
    condition:
      query: "level:ERROR"
      time_range: "5m"
      threshold: 10
    notifications:
      - type: email
        recipients: ["admin@example.com"]
      - type: slack
        webhook_url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

  - name: "PostgreSQL Slow Query Alert"
    condition:
      query: "duration:[1000 TO *]"
      time_range: "1m"
      threshold: 5
    notifications:
      - type: email
        recipients: ["dba@example.com"]

  - name: "PostgreSQL Connection Failure"
    condition:
      query: "message:connection*failed"
      time_range: "1m"
      threshold: 1
    notifications:
      - type: pagerduty
        service_key: "YOUR_PAGERDUTY_KEY"
```

#### 13.4.2 é€šçŸ¥é…ç½®

**Emailé€šçŸ¥é…ç½®**ï¼š

```conf
# Graylog Emailé€šçŸ¥é…ç½®
# /etc/graylog/server/server.conf

transport_email_enabled = true
transport_email_hostname = smtp.example.com
transport_email_port = 587
transport_email_use_auth = true
transport_email_auth_username = alerts@example.com
transport_email_auth_password = <password>
transport_email_subject_prefix = [PostgreSQL Alert]
transport_email_from_email = alerts@example.com
```

**Slacké€šçŸ¥é…ç½®**ï¼š

```python
# Slacké€šçŸ¥è„šæœ¬ï¼ˆPythonï¼‰
import requests
import json

def send_slack_alert(message, webhook_url):
    """å‘é€Slackå‘Šè­¦"""
    payload = {
        "text": f"ğŸš¨ PostgreSQL Alert: {message}",
        "attachments": [
            {
                "color": "danger",
                "fields": [
                    {
                        "title": "Alert",
                        "value": message,
                        "short": False
                    }
                ]
            }
        ]
    }

    response = requests.post(
        webhook_url,
        data=json.dumps(payload),
        headers={'Content-Type': 'application/json'}
    )

    return response.status_code == 200

# ä½¿ç”¨ç¤ºä¾‹
send_slack_alert(
    "Error count exceeded threshold: 15 errors in last 5 minutes",
    "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
)
```

#### 13.4.3 å®é™…æ¡ˆä¾‹

**æ¡ˆä¾‹ï¼šPostgreSQLæ…¢æŸ¥è¯¢å‘Šè­¦**ï¼š

```text
å‘Šè­¦åœºæ™¯ï¼šæ£€æµ‹æ…¢æŸ¥è¯¢å¹¶å‘Šè­¦

å‘Šè­¦è§„åˆ™ï¼š
- æŸ¥è¯¢æ¡ä»¶ï¼šduration:[5000 TO *]  # æŸ¥è¯¢æ—¶é—´è¶…è¿‡5ç§’
- æ—¶é—´çª—å£ï¼š5åˆ†é’Ÿ
- é˜ˆå€¼ï¼š3æ¬¡æ…¢æŸ¥è¯¢

å‘Šè­¦åŠ¨ä½œï¼š
1. å‘é€Emailé€šçŸ¥DBAå›¢é˜Ÿ
2. å‘é€Slackæ¶ˆæ¯åˆ°#postgresql-alertsé¢‘é“
3. åˆ›å»ºJIRAå·¥å•ï¼ˆè‡ªåŠ¨ï¼‰

å‘Šè­¦æ¶ˆæ¯ç¤ºä¾‹ï¼š
"ğŸš¨ PostgreSQL Slow Query Alert
Time: 2025-01-16 10:30:00
Slow queries detected: 5
Top slow queries:
1. SELECT * FROM large_table WHERE id = ? (15.2s)
2. UPDATE orders SET status = ? WHERE user_id = ? (8.5s)
3. DELETE FROM logs WHERE created_at < ? (6.3s)
Action required: Review and optimize slow queries"
```

---

## 14. PostgreSQLæ—¥å¿—ç®¡ç†è¯¦ç»†é…ç½®

### 14.1 æ—¥å¿—å‚æ•°è¯¦ç»†é…ç½®

#### 14.1.1 åŸºç¡€æ—¥å¿—é…ç½®

**æ—¥å¿—è®°å½•é…ç½®**ï¼š

```conf
# postgresql.conf
# ============================================
# æ—¥å¿—è®°å½•åŸºç¡€é…ç½®
# ============================================

# å¯ç”¨æ—¥å¿—æ”¶é›†å™¨
logging_collector = on

# æ—¥å¿—ç›®å½•
log_directory = 'log'

# æ—¥å¿—æ–‡ä»¶åæ ¼å¼
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# æ—¥å¿—è½®è½¬é…ç½®
log_rotation_age = 1d      # æ¯å¤©è½®è½¬
log_rotation_size = 100MB  # æˆ–è¾¾åˆ°100MBæ—¶è½®è½¬

# æ—¥å¿—æ ¼å¼
log_line_prefix = '%t [%p] %l: '  # æ—¶é—´æˆ³ [è¿›ç¨‹ID] æ—¥å¿—çº§åˆ«:
log_timezone = 'UTC'               # æ—¥å¿—æ—¶åŒº
```

#### 14.1.2 è¿æ¥æ—¥å¿—é…ç½®

**è¿æ¥å’Œæ–­å¼€æ—¥å¿—**ï¼š

```conf
# è®°å½•æ‰€æœ‰è¿æ¥
log_connections = on

# è®°å½•æ‰€æœ‰æ–­å¼€
log_disconnections = on

# è¿æ¥æ—¥å¿—ç¤ºä¾‹è¾“å‡ºï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: connection received: host=192.168.1.100 port=54321
# 2025-01-16 10:30:00 UTC [12345] LOG: connection authorized: user=postgres database=mydb
# 2025-01-16 10:35:00 UTC [12345] LOG: disconnection: session time: 0:05:00.123 user=postgres database=mydb
```

**è¿æ¥è¯¦æƒ…é…ç½®**ï¼š

```conf
# è®°å½•è¿æ¥è¯¦æƒ…ï¼ˆPostgreSQL 14+ï¼‰
log_connection_details = on

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: connection received: host=192.168.1.100 port=54321
# 2025-01-16 10:30:00 UTC [12345] DETAIL: connection parameters: application_name=psql, client_encoding=UTF8
```

#### 14.1.3 è¯­å¥æ—¥å¿—é…ç½®

**SQLè¯­å¥æ—¥å¿—**ï¼š

```conf
# è®°å½•æ‰€æœ‰SQLè¯­å¥
log_statement = 'all'  # é€‰é¡¹ï¼šnone, ddl, mod, all

# é€‰é¡¹è¯´æ˜ï¼š
# - none: ä¸è®°å½•è¯­å¥
# - ddl: åªè®°å½•DDLè¯­å¥ï¼ˆCREATE, ALTER, DROPç­‰ï¼‰
# - mod: è®°å½•DDLå’ŒDMLè¯­å¥ï¼ˆINSERT, UPDATE, DELETEç­‰ï¼‰
# - all: è®°å½•æ‰€æœ‰è¯­å¥ï¼ˆåŒ…æ‹¬SELECTï¼‰

# è®°å½•æ…¢æŸ¥è¯¢ï¼ˆæ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šæ¯«ç§’ï¼‰
log_min_duration_statement = 1000  # 1000ms = 1ç§’

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: duration: 1234.567 ms statement: SELECT * FROM large_table WHERE id = 123
```

**è¯­å¥æ—¥å¿—è¯¦ç»†é…ç½®**ï¼š

```conf
# è®°å½•è¯­å¥å‚æ•°ï¼ˆPostgreSQL 9.6+ï¼‰
log_parameter_max_length = 0  # 0=ä¸è®°å½•ï¼Œ-1=è®°å½•æ‰€æœ‰ï¼Œ>0=è®°å½•å‰Nå­—èŠ‚

# è®°å½•è¯­å¥æ‰§è¡Œè®¡åˆ’ï¼ˆPostgreSQL 9.0+ï¼‰
log_planner_stats = off
log_executor_stats = off
log_statement_stats = off

# è®°å½•é”ç­‰å¾…
log_lock_waits = on  # è®°å½•ç­‰å¾…é”è¶…è¿‡deadlock_timeoutçš„è¯­å¥

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: process 12345 still waiting for ShareLock on transaction 123456 after 1000.123 ms
```

#### 14.1.4 æ£€æŸ¥ç‚¹å’Œè‡ªåŠ¨æ¸…ç†æ—¥å¿—

**æ£€æŸ¥ç‚¹æ—¥å¿—**ï¼š

```conf
# è®°å½•æ£€æŸ¥ç‚¹
log_checkpoints = on

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: checkpoint starting: time
# 2025-01-16 10:30:05 UTC [12345] LOG: checkpoint complete: wrote 1024 buffers (6.3%); 0 WAL file(s) added, 0 removed, 1 recycled; write=4.123 s, sync=0.456 s, total=5.234 s; sync files=1024, longest=0.123 s, average=0.004 s; distance=16384 kB, estimate=16384 kB
```

**è‡ªåŠ¨æ¸…ç†æ—¥å¿—**ï¼š

```conf
# è®°å½•è‡ªåŠ¨æ¸…ç†æ“ä½œ
log_autovacuum_min_duration = 0  # è®°å½•æ‰€æœ‰è‡ªåŠ¨æ¸…ç†æ“ä½œï¼ˆ0=å…¨éƒ¨è®°å½•ï¼Œ-1=ä¸è®°å½•ï¼‰

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-01-16 10:30:00 UTC [12345] LOG: automatic vacuum of table "public.users": index scans: 1
# 2025-01-16 10:30:00 UTC [12345] DETAIL: pages: 0 removed, 1000 remain, 0 skipped due to pins, 0 skipped frozen
# 2025-01-16 10:30:00 UTC [12345] DETAIL: tuples: 100 removed, 10000 remain, 0 are dead but not yet removable
```

#### 14.1.5 é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—

**é”™è¯¯æ—¥å¿—çº§åˆ«**ï¼š

```conf
# æ—¥å¿—çº§åˆ«
log_min_messages = warning  # é€‰é¡¹ï¼šdebug5, debug4, debug3, debug2, debug1, info, notice, warning, error, log, fatal, panic

# æ¨èé…ç½®ï¼š
# - å¼€å‘ç¯å¢ƒï¼šinfo æˆ– notice
# - ç”Ÿäº§ç¯å¢ƒï¼šwarning æˆ– error

# è®°å½•æ—¶é—´æˆ³
log_timestamp = on

# è®°å½•ä¸»æœºå
log_hostname = on

# è®°å½•è¿›ç¨‹ID
log_process_id = on
```

**è¯¦ç»†é”™è¯¯ä¿¡æ¯**ï¼š

```conf
# è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
log_error_verbosity = default  # é€‰é¡¹ï¼šterse, default, verbose

# verboseæ¨¡å¼è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯
# é€‚ç”¨äºé—®é¢˜è¯Šæ–­
```

### 14.2 æ—¥å¿—æ–‡ä»¶ç®¡ç†ç­–ç•¥

#### 14.2.1 æ—¥å¿—è½®è½¬é…ç½®

**è‡ªåŠ¨è½®è½¬**ï¼š

```conf
# postgresql.conf
# æ—¥å¿—è½®è½¬é…ç½®

# æŒ‰æ—¶é—´è½®è½¬
log_rotation_age = 1d      # æ¯å¤©è½®è½¬
# æˆ–
log_rotation_age = 1h      # æ¯å°æ—¶è½®è½¬

# æŒ‰å¤§å°è½®è½¬
log_rotation_size = 100MB  # è¾¾åˆ°100MBæ—¶è½®è½¬

# ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°
log_truncate_on_rotation = off  # ä¸æˆªæ–­ï¼Œä¿ç•™æ‰€æœ‰æ—¥å¿—
```

**æ‰‹åŠ¨è½®è½¬**ï¼š

```bash
# ä½¿ç”¨logrotateï¼ˆLinuxï¼‰
# /etc/logrotate.d/postgresql
/var/lib/pgsql/18/data/log/postgresql-*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    missingok
    create 0640 postgres postgres
    sharedscripts
    postrotate
        /usr/bin/pg_ctl -D /var/lib/pgsql/18/data reload > /dev/null 2>&1 || true
    endscript
}
```

#### 14.2.2 æ—¥å¿—å½’æ¡£ç­–ç•¥

**æ—¥å¿—å½’æ¡£é…ç½®**ï¼š

```bash
# åˆ›å»ºæ—¥å¿—å½’æ¡£è„šæœ¬
#!/bin/bash
# archive_logs.sh

LOG_DIR="/var/lib/pgsql/18/data/log"
ARCHIVE_DIR="/var/lib/pgsql/18/data/log/archive"
DATE=$(date +%Y%m%d)

# åˆ›å»ºå½’æ¡£ç›®å½•
mkdir -p "$ARCHIVE_DIR"

# å½’æ¡£æ˜¨å¤©çš„æ—¥å¿—
find "$LOG_DIR" -name "postgresql-*.log" -mtime +1 -exec mv {} "$ARCHIVE_DIR/" \;

# å‹ç¼©å½’æ¡£æ—¥å¿—
find "$ARCHIVE_DIR" -name "*.log" -mtime +7 -exec gzip {} \;

# åˆ é™¤30å¤©å‰çš„å½’æ¡£æ—¥å¿—
find "$ARCHIVE_DIR" -name "*.log.gz" -mtime +30 -delete

# ä½¿ç”¨cronå®šæœŸæ‰§è¡Œ
# 0 2 * * * /usr/local/bin/archive_logs.sh
```

**æ—¥å¿—å‹ç¼©**ï¼š

```bash
# å‹ç¼©æ—§æ—¥å¿—
find /var/lib/pgsql/18/data/log -name "postgresql-*.log" -mtime +1 -exec gzip {} \;

# ä½¿ç”¨å¹¶è¡Œå‹ç¼©ï¼ˆæ›´å¿«ï¼‰
find /var/lib/pgsql/18/data/log -name "postgresql-*.log" -mtime +1 -print0 | \
    xargs -0 -P 4 -I {} gzip {}
```

#### 14.2.3 æ—¥å¿—æ¸…ç†ç­–ç•¥

**è‡ªåŠ¨æ¸…ç†è„šæœ¬**ï¼š

```sql
-- åˆ›å»ºæ—¥å¿—æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION cleanup_old_logs(
    retention_days INTEGER DEFAULT 30
)
RETURNS TABLE (
    deleted_files INTEGER,
    freed_space TEXT
) AS $$
DECLARE
    log_dir TEXT;
    deleted_count INTEGER := 0;
    freed_bytes BIGINT := 0;
    file_rec RECORD;
BEGIN
    -- è·å–æ—¥å¿—ç›®å½•
    SELECT setting INTO log_dir
    FROM pg_settings
    WHERE name = 'log_directory';

    -- åˆ é™¤è¶…è¿‡ä¿ç•™æœŸçš„æ—¥å¿—æ–‡ä»¶
    FOR file_rec IN
        SELECT filename, size
        FROM pg_ls_logdir() AS f
        WHERE f.modification < NOW() - (retention_days || ' days')::INTERVAL
          AND f.filename LIKE 'postgresql-%.log'
    LOOP
        PERFORM pg_file_unlink(log_dir || '/' || file_rec.filename);
        deleted_count := deleted_count + 1;
        freed_bytes := freed_bytes + file_rec.size;
    END LOOP;

    RETURN QUERY SELECT
        deleted_count,
        pg_size_pretty(freed_bytes);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM cleanup_old_logs(30);
```

### 14.3 æ—¥å¿—åˆ†æå·¥å…·

#### 14.3.1 pgBadgerä½¿ç”¨

**pgBadgerå®‰è£…**ï¼š

```bash
# Ubuntu/Debian
sudo apt-get install pgbadger

# CentOS/RHEL
sudo yum install pgbadger

# æˆ–ä»æºç å®‰è£…
wget https://github.com/darold/pgbadger/archive/v12.0.tar.gz
tar -xzf v12.0.tar.gz
cd pgbadger-12.0
perl Makefile.PL
make && sudo make install
```

**pgBadgerä½¿ç”¨**ï¼š

```bash
# åŸºæœ¬ä½¿ç”¨
pgbadger /var/lib/pgsql/18/data/log/postgresql-*.log

# è¾“å‡ºHTMLæŠ¥å‘Š
pgbadger -o report.html /var/lib/pgsql/18/data/log/postgresql-*.log

# åˆ†æå¤šä¸ªæ—¥å¿—æ–‡ä»¶
pgbadger /var/lib/pgsql/18/data/log/postgresql-*.log \
         /var/lib/pgsql/18/data/log/postgresql-*.log.1

# å¢é‡åˆ†æï¼ˆåªåˆ†ææ–°æ—¥å¿—ï¼‰
pgbadger -I /var/lib/pgsql/18/data/log/postgresql-*.log \
         --incremental \
         --outdir /var/lib/pgsql/18/data/log/reports

# ç”ŸæˆJSONæŠ¥å‘Š
pgbadger -f json -o report.json /var/lib/pgsql/18/data/log/postgresql-*.log
```

**pgBadgeré…ç½®**ï¼š

```bash
# åˆ›å»ºpgBadgeré…ç½®æ–‡ä»¶
# ~/.pgbadgerrc
{
    "log_line_prefix": "%t [%p] %l: ",
    "log_timezone": "UTC",
    "outdir": "/var/lib/pgsql/18/data/log/reports",
    "incremental": true,
    "jobs": 4
}

# ä½¿ç”¨é…ç½®æ–‡ä»¶
pgbadger -c ~/.pgbadgerrc /var/lib/pgsql/18/data/log/postgresql-*.log
```

#### 14.3.2 æ—¥å¿—åˆ†æè„šæœ¬

**æ…¢æŸ¥è¯¢åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# analyze_slow_queries.sh

LOG_FILE="/var/lib/pgsql/18/data/log/postgresql-*.log"
OUTPUT_FILE="/tmp/slow_queries.txt"

# æå–æ…¢æŸ¥è¯¢ï¼ˆæ‰§è¡Œæ—¶é—´>1ç§’ï¼‰
grep "duration:" "$LOG_FILE" | \
    awk '$NF > 1000 {print}' | \
    sort -k2 -n -r | \
    head -20 > "$OUTPUT_FILE"

echo "Top 20 slow queries saved to $OUTPUT_FILE"
```

**é”™è¯¯æ—¥å¿—åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# analyze_errors.sh

LOG_FILE="/var/lib/pgsql/18/data/log/postgresql-*.log"
OUTPUT_FILE="/tmp/errors.txt"

# æå–é”™è¯¯æ—¥å¿—
grep -E "ERROR|FATAL|PANIC" "$LOG_FILE" | \
    awk '{print $1, $2, $3, $0}' | \
    sort > "$OUTPUT_FILE"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
echo "Error Statistics:"
grep -E "ERROR|FATAL|PANIC" "$LOG_FILE" | \
    awk '{print $NF}' | \
    sort | uniq -c | sort -rn

echo "Errors saved to $OUTPUT_FILE"
```

**è¿æ¥åˆ†æè„šæœ¬**ï¼š

```sql
-- ä»æ—¥å¿—ä¸­åˆ†æè¿æ¥æ¨¡å¼ï¼ˆéœ€è¦log_connections = onï¼‰
-- ä½¿ç”¨pg_read_fileè¯»å–æ—¥å¿—æ–‡ä»¶

CREATE OR REPLACE FUNCTION analyze_connections(
    log_file_path TEXT
)
RETURNS TABLE (
    connection_time TIMESTAMP,
    user_name TEXT,
    database_name TEXT,
    client_host TEXT,
    session_duration INTERVAL
) AS $$
DECLARE
    log_content TEXT;
    log_line TEXT;
BEGIN
    -- è¯»å–æ—¥å¿—æ–‡ä»¶
    log_content := pg_read_file(log_file_path);

    -- è§£æè¿æ¥æ—¥å¿—ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
    -- å®é™…å®ç°éœ€è¦æ›´å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼è§£æ

    RETURN QUERY
    SELECT
        NOW() AS connection_time,  -- ç®€åŒ–ç¤ºä¾‹
        'postgres'::TEXT AS user_name,
        'mydb'::TEXT AS database_name,
        '192.168.1.100'::TEXT AS client_host,
        '5 minutes'::INTERVAL AS session_duration;
END;
$$ LANGUAGE plpgsql;
```

#### 14.3.3 å®æ—¶æ—¥å¿—ç›‘æ§

**å®æ—¶æ—¥å¿—ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# monitor_logs.sh

LOG_FILE="/var/lib/pgsql/18/data/log/postgresql-$(date +%Y-%m-%d)*.log"

# å®æ—¶ç›‘æ§é”™è¯¯
tail -f "$LOG_FILE" | grep --line-buffered -E "ERROR|FATAL|PANIC" | \
    while read line; do
        echo "[$(date +%Y-%m-%d\ %H:%M:%S)] $line"
        # å‘é€å‘Šè­¦ï¼ˆç¤ºä¾‹ï¼‰
        # send_alert "$line"
    done

# å®æ—¶ç›‘æ§æ…¢æŸ¥è¯¢
tail -f "$LOG_FILE" | grep --line-buffered "duration:" | \
    awk '$NF > 1000 {print "[SLOW QUERY]", $0}'
```

**æ—¥å¿—ç›‘æ§å·¥å…·é›†æˆ**ï¼š

```python
# ä½¿ç”¨Pythonç›‘æ§PostgreSQLæ—¥å¿—
import subprocess
import re
from datetime import datetime

def monitor_postgresql_logs(log_file, callback):
    """ç›‘æ§PostgreSQLæ—¥å¿—å¹¶è°ƒç”¨å›è°ƒå‡½æ•°"""
    process = subprocess.Popen(
        ['tail', '-f', log_file],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    for line in process.stdout:
        # æ£€æµ‹é”™è¯¯
        if re.search(r'ERROR|FATAL|PANIC', line):
            callback('error', line)

        # æ£€æµ‹æ…¢æŸ¥è¯¢
        match = re.search(r'duration: (\d+\.\d+) ms', line)
        if match and float(match.group(1)) > 1000:
            callback('slow_query', line)

        # æ£€æµ‹è¿æ¥é—®é¢˜
        if re.search(r'connection.*failed|connection.*refused', line):
            callback('connection_error', line)

# ä½¿ç”¨ç¤ºä¾‹
def handle_log_event(event_type, line):
    print(f"[{datetime.now()}] {event_type}: {line}")
    # å‘é€å‘Šè­¦ã€è®°å½•åˆ°æ•°æ®åº“ç­‰

monitor_postgresql_logs(
    '/var/lib/pgsql/18/data/log/postgresql-2025-01-16.log',
    handle_log_event
)
```

---

## 15. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](./05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½ä¼˜åŒ–æŒ‡å—
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­ [Dockeréƒ¨ç½²](../å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å®¹å™¨åŒ–éƒ¨ç½²

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](../../../01-æ ¸å¿ƒåŸºç¡€/01.02-ç³»ç»Ÿæ¶æ„/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„åŸºç¡€
- â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†
- â­â­ [å®‰å…¨ä¸åˆè§„](../../../05-å®‰å…¨ä¸åˆè§„/README.md) - å®‰å…¨é…ç½®

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../../04-å­˜å‚¨ä¸æ¢å¤/README.md) - å¤‡ä»½æ¢å¤

#### é«˜çº§ç‰¹æ€§

- â­â­ [å®‰å…¨ä¸åˆè§„](../../../05-å®‰å…¨ä¸åˆè§„/README.md) - å®‰å…¨æœ€ä½³å®è·µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
