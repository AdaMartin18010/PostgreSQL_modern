---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\04-éƒ¨ç½²è¿ç»´\04.02-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLé›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒã€é«˜å¯ç”¨éœ€æ±‚ã€å¤§è§„æ¨¡å¹¶å‘ã€è¯»å†™åˆ†ç¦»

---

## ğŸ“‘ ç›®å½•

- [1.1 é«˜å¯ç”¨æ¦‚å¿µ](#11-é«˜å¯ç”¨æ¦‚å¿µ)
- [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
- [1.3 æ¶æ„æ¨¡å¼](#13-æ¶æ„æ¨¡å¼)
- [2.1 ç‰©ç†å¤åˆ¶ï¼ˆæµå¤åˆ¶ï¼‰](#21-ç‰©ç†å¤åˆ¶æµå¤åˆ¶)
- [2.2 é€»è¾‘å¤åˆ¶](#22-é€»è¾‘å¤åˆ¶)
- [2.3 åŒæ­¥ç­–ç•¥ä¸ä»²è£](#23-åŒæ­¥ç­–ç•¥ä¸ä»²è£)
- [2.4 å¤åˆ¶å»¶è¿Ÿç®¡ç†](#24-å¤åˆ¶å»¶è¿Ÿç®¡ç†)
- [3.1 Patronié«˜å¯ç”¨](#31-patronié«˜å¯ç”¨)
- [3.2 pgpool-IIè¯»å†™åˆ†ç¦»](#32-pgpool-iiè¯»å†™åˆ†ç¦»)
- [3.3 pgbouncerè¿æ¥æ± ](#33-pgbouncerè¿æ¥æ± )
- [3.4 Keepalivedè™šæ‹ŸIP](#34-keepalivedè™šæ‹Ÿip)
- [4.1 ä¸»ä»å¤åˆ¶æ¶æ„](#41-ä¸»ä»å¤åˆ¶æ¶æ„)
- [4.2 ä¸€ä¸»å¤šä»æ¶æ„](#42-ä¸€ä¸»å¤šä»æ¶æ„)
- [4.3 å¤šä¸»æ¶æ„ï¼ˆCitusï¼‰](#43-å¤šä¸»æ¶æ„citus)
- [4.4 ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´æ¶æ„](#44-ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´æ¶æ„)
- [5.1 è‡ªåŠ¨æ•…éšœè½¬ç§»](#51-è‡ªåŠ¨æ•…éšœè½¬ç§»)
- [5.2 æ‰‹åŠ¨æ•…éšœåˆ‡æ¢](#52-æ‰‹åŠ¨æ•…éšœåˆ‡æ¢)
- [5.3 æ•…éšœæ¢å¤æµç¨‹](#53-æ•…éšœæ¢å¤æµç¨‹)
- [5.4 RTO/RPOè¯„ä¼°](#54-rtorpoè¯„ä¼°)
- [6.1 å¤åˆ¶çŠ¶æ€ç›‘æ§](#61-å¤åˆ¶çŠ¶æ€ç›‘æ§)
- [6.2 å»¶è¿Ÿç›‘æ§](#62-å»¶è¿Ÿç›‘æ§)
- [6.3 å¥åº·æ£€æŸ¥](#63-å¥åº·æ£€æŸ¥)
- [7.1 å¤åˆ¶æ–¹å¼å¯¹æ¯”](#71-å¤åˆ¶æ–¹å¼å¯¹æ¯”)
- [7.2 é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”](#72-é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”)
- [7.3 æ¶æ„æ¨¡å¼å¯¹æ¯”](#73-æ¶æ„æ¨¡å¼å¯¹æ¯”)
- [8.1 æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°é«˜å¯ç”¨éƒ¨ç½²](#81-æ¡ˆä¾‹1ç”µå•†å¹³å°é«˜å¯ç”¨éƒ¨ç½²)
- [8.2 æ¡ˆä¾‹2ï¼šé‡‘èç³»ç»Ÿå¼ºä¸€è‡´éƒ¨ç½²](#82-æ¡ˆä¾‹2é‡‘èç³»ç»Ÿå¼ºä¸€è‡´éƒ¨ç½²)
- [9.1 éƒ¨ç½²æœ€ä½³å®è·µ](#91-éƒ¨ç½²æœ€ä½³å®è·µ)
- [9.2 è¿ç»´æœ€ä½³å®è·µ](#92-è¿ç»´æœ€ä½³å®è·µ)
- [10.1 å¸¸è§é—®é¢˜](#101-å¸¸è§é—®é¢˜)
- [10.2 è¯Šæ–­æ–¹æ³•](#102-è¯Šæ–­æ–¹æ³•)
- [11.1 å®˜æ–¹æ–‡æ¡£](#111-å®˜æ–¹æ–‡æ¡£)
- [11.2 ç›¸å…³æ–‡æ¡£](#112-ç›¸å…³æ–‡æ¡£)
---

## ä¸€ã€æ¦‚è¿°

### 1.1 é«˜å¯ç”¨æ¦‚å¿µ

**é«˜å¯ç”¨æ€§ï¼ˆHigh Availability, HAï¼‰**æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤ŸæŒç»­æä¾›æœåŠ¡çš„èƒ½åŠ›ï¼Œå³ä½¿åœ¨æŸäº›ç»„ä»¶å‘ç”Ÿæ•…éšœæ—¶ä¹Ÿèƒ½ä¿æŒè¿è¡Œã€‚å¯¹äºPostgreSQLæ•°æ®åº“ç³»ç»Ÿï¼Œé«˜å¯ç”¨æ€§é€šå¸¸é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

- **æ•°æ®å¤åˆ¶**ï¼šå°†æ•°æ®å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œç¡®ä¿æ•°æ®å†—ä½™
- **æ•…éšœæ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹æ•…éšœ
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨æˆ–æ‰‹åŠ¨å°†æœåŠ¡åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹
- **è´Ÿè½½å‡è¡¡**ï¼šå°†è¯»è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªèŠ‚ç‚¹

**å…³é”®æŒ‡æ ‡**ï¼š

- **RTOï¼ˆRecovery Time Objectiveï¼‰**ï¼šæ¢å¤æ—¶é—´ç›®æ ‡ï¼Œä»æ•…éšœå‘ç”Ÿåˆ°ç³»ç»Ÿæ¢å¤æœåŠ¡çš„æ—¶é—´
- **RPOï¼ˆRecovery Point Objectiveï¼‰**ï¼šæ¢å¤ç‚¹ç›®æ ‡ï¼Œå…è®¸ä¸¢å¤±çš„æ•°æ®é‡æˆ–æ—¶é—´çª—å£

### 1.2 é€‚ç”¨åœºæ™¯

**é«˜å¯ç”¨éƒ¨ç½²é€‚ç”¨äº**ï¼š

- **ç”Ÿäº§ç¯å¢ƒ**ï¼šéœ€è¦7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡
- **å…³é”®ä¸šåŠ¡ç³»ç»Ÿ**ï¼šé‡‘èã€ç”µå•†ã€åŒ»ç–—ç­‰å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯
- **å¤§è§„æ¨¡å¹¶å‘**ï¼šéœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¯»å†™è¯·æ±‚
- **æ•°æ®å®‰å…¨**ï¼šéœ€è¦æ•°æ®å†—ä½™å’Œå¿«é€Ÿæ¢å¤èƒ½åŠ›

**ä¸é€‚ç”¨åœºæ™¯**ï¼š

- å¼€å‘æµ‹è¯•ç¯å¢ƒï¼ˆå•æœºéƒ¨ç½²å³å¯ï¼‰
- ä½æµé‡åº”ç”¨ï¼ˆå•æœºéƒ¨ç½²è¶³å¤Ÿï¼‰
- å¯¹æˆæœ¬æ•æ„Ÿçš„å°å‹é¡¹ç›®

### 1.3 æ¶æ„æ¨¡å¼

PostgreSQLé«˜å¯ç”¨æ¶æ„ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ¨¡å¼ï¼š

1. **ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slaveï¼‰**ï¼šä¸€ä¸»å¤šä»ï¼Œä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»
2. **ä¸»ä¸»å¤åˆ¶ï¼ˆMaster-Masterï¼‰**ï¼šå¤šä¸»æ¶æ„ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½å¯è¯»å†™ï¼ˆéœ€è¦ç‰¹æ®Šæ–¹æ¡ˆå¦‚Citusï¼‰
3. **å…±äº«å­˜å‚¨**ï¼šå¤šä¸ªèŠ‚ç‚¹å…±äº«åŒä¸€å­˜å‚¨ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰
4. **åˆ†å¸ƒå¼é›†ç¾¤**ï¼šä½¿ç”¨Citusã€PostgreSQL-XLç­‰åˆ†å¸ƒå¼æ–¹æ¡ˆ

## äºŒã€å¤åˆ¶æ¶æ„

### 2.1 ç‰©ç†å¤åˆ¶ï¼ˆæµå¤åˆ¶ï¼‰

**ç‰©ç†å¤åˆ¶ï¼ˆPhysical Replicationï¼‰**æ˜¯PostgreSQLæœ€å¸¸ç”¨çš„å¤åˆ¶æ–¹å¼ï¼Œé€šè¿‡å¤åˆ¶WALï¼ˆWrite-Ahead Logï¼‰æ–‡ä»¶å®ç°æ•°æ®åŒæ­¥ã€‚

#### 2.1.1 ä¸»åº“é…ç½®

**åˆ›å»ºå¤åˆ¶ç”¨æˆ·**ï¼š

```sql
-- åˆ›å»ºå¤åˆ¶ä¸“ç”¨ç”¨æˆ·
CREATE USER repl WITH REPLICATION PASSWORD 'secure_password';

-- æˆäºˆå¿…è¦æƒé™
GRANT CONNECTION ON DATABASE postgres TO repl;
```

**é…ç½®postgresql.conf**ï¼š

```text
# WALçº§åˆ«ï¼ˆå¿…é¡»ä¸ºreplicaæˆ–logicalï¼‰
wal_level = replica

# æœ€å¤§WALå‘é€è¿›ç¨‹æ•°ï¼ˆå»ºè®®ä¸ºä»åº“æ•°é‡+2ï¼‰
max_wal_senders = 10

# æœ€å¤§å¤åˆ¶æ§½æ•°é‡ï¼ˆå»ºè®®ä¸ºä»åº“æ•°é‡+1ï¼‰
max_replication_slots = 10

# ä¿ç•™çš„WALå¤§å°ï¼ˆé˜²æ­¢ä»åº“å»¶è¿Ÿå¯¼è‡´WALè¢«åˆ é™¤ï¼‰
wal_keep_size = '1GB'

# å¯ç”¨å½’æ¡£ï¼ˆå¯é€‰ï¼Œç”¨äºPITRï¼‰
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'
```

**é…ç½®pg_hba.conf**ï¼š

```text
# å…è®¸å¤åˆ¶è¿æ¥
host replication repl 10.0.0.0/24 md5
```

**åˆ›å»ºå¤åˆ¶æ§½ï¼ˆæ¨èï¼‰**ï¼š

```sql
-- åˆ›å»ºå¤åˆ¶æ§½ï¼Œé˜²æ­¢WALè¢«è¿‡æ—©åˆ é™¤
SELECT * FROM pg_create_physical_replication_slot('replica1');
SELECT * FROM pg_create_physical_replication_slot('replica2');
```

#### 2.1.2 ä»åº“åˆå§‹åŒ–

**ä½¿ç”¨pg_basebackupåˆå§‹åŒ–**ï¼š

```bash
# åœæ­¢ä»åº“PostgreSQLæœåŠ¡
sudo systemctl stop postgresql

# å¤‡ä»½ç°æœ‰æ•°æ®ç›®å½•ï¼ˆå¦‚æœæœ‰ï¼‰
sudo mv /var/lib/postgresql/data /var/lib/postgresql/data.backup

# ä½¿ç”¨pg_basebackupåˆ›å»ºåŸºç¡€å¤‡ä»½
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C \
  -S replica1 \
  -v \
  -P

# å¯åŠ¨ä»åº“æœåŠ¡
sudo systemctl start postgresql
```

**å‚æ•°è¯´æ˜**ï¼š

- `-h`: ä¸»åº“åœ°å€
- `-U`: å¤åˆ¶ç”¨æˆ·
- `-D`: æ•°æ®ç›®å½•
- `-X stream`: æµå¼ä¼ è¾“WAL
- `-R`: è‡ªåŠ¨åˆ›å»ºrecoveryé…ç½®æ–‡ä»¶
- `-C`: åˆ›å»ºå¤åˆ¶æ§½
- `-S`: å¤åˆ¶æ§½åç§°
- `-v`: è¯¦ç»†è¾“å‡º
- `-P`: æ˜¾ç¤ºè¿›åº¦

#### 2.1.3 éªŒè¯å¤åˆ¶çŠ¶æ€

**åœ¨ä¸»åº“æ£€æŸ¥å¤åˆ¶çŠ¶æ€**ï¼š

```sql
-- æŸ¥çœ‹å¤åˆ¶è¿æ¥
SELECT
    application_name,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag_bytes,
    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag_bytes,
    pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag_bytes,
    pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS total_lag_bytes
FROM pg_stat_replication;
```

**åœ¨ä»åº“æ£€æŸ¥å¤åˆ¶çŠ¶æ€**ï¼š

```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
    pg_is_in_recovery() AS is_standby,
    pg_last_wal_receive_lsn() AS receive_lsn,
    pg_last_wal_replay_lsn() AS replay_lsn,
    pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) AS lag_bytes;
```

### 2.2 é€»è¾‘å¤åˆ¶

**é€»è¾‘å¤åˆ¶ï¼ˆLogical Replicationï¼‰**åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å‹ï¼Œå¯ä»¥å¤åˆ¶ç‰¹å®šçš„è¡¨æˆ–æ•°æ®åº“ã€‚

#### 2.2.1 ä¸»åº“é…ç½®

```sql
-- è®¾ç½®WALçº§åˆ«ä¸ºlogical
ALTER SYSTEM SET wal_level = logical;
SELECT pg_reload_conf();

-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION my_publication FOR TABLE users, orders, products;

-- æˆ–è€…å‘å¸ƒæ‰€æœ‰è¡¨
CREATE PUBLICATION all_tables FOR ALL TABLES;
```

#### 2.2.2 ä»åº“é…ç½®

```sql
-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=primary_host port=5432 user=repl password=secure_password dbname=mydb'
PUBLICATION my_publication;

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
SELECT * FROM pg_stat_subscription;
```

### 2.3 åŒæ­¥ç­–ç•¥ä¸ä»²è£

#### 2.3.1 åŒæ­¥æäº¤çº§åˆ«

PostgreSQLæä¾›å¤šç§åŒæ­¥æäº¤çº§åˆ«ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ï¼š

| çº§åˆ« | è¯´æ˜ | æ€§èƒ½ | æ•°æ®å®‰å…¨æ€§ |
|------|------|------|-----------|
| `off` | å¼‚æ­¥æäº¤ | æœ€é«˜ | æœ€ä½ï¼ˆå¯èƒ½ä¸¢å¤±æœ€è¿‘1ä¸ªäº‹åŠ¡ï¼‰ |
| `local` | æœ¬åœ°åŒæ­¥ | é«˜ | ä½ï¼ˆå¯èƒ½ä¸¢å¤±æœ€è¿‘1ä¸ªäº‹åŠ¡ï¼‰ |
| `remote_write` | è¿œç¨‹å†™å…¥ | ä¸­ | ä¸­ï¼ˆä»åº“å´©æºƒå¯èƒ½ä¸¢å¤±ï¼‰ |
| `on` / `remote_apply` | è¿œç¨‹åº”ç”¨ | ä½ | æœ€é«˜ï¼ˆæ•°æ®å·²åº”ç”¨åˆ°ä»åº“ï¼‰ |

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- è®¾ç½®åŒæ­¥æäº¤çº§åˆ«
ALTER SYSTEM SET synchronous_commit = 'remote_apply';
SELECT pg_reload_conf();
```

#### 2.3.2 åŒæ­¥å¤‡åº“é…ç½®

**æŒ‡å®šåŒæ­¥å¤‡åº“**ï¼š

```text
# postgresql.conf
# æ–¹å¼1ï¼šæŒ‡å®šå…·ä½“å¤‡åº“
synchronous_standby_names = 'replica1,replica2'

# æ–¹å¼2ï¼šä½¿ç”¨Quorumï¼ˆä»»æ„Nä¸ªï¼‰
synchronous_standby_names = 'ANY 1 (replica1, replica2, replica3)'

# æ–¹å¼3ï¼šä½¿ç”¨Firstï¼ˆå‰Nä¸ªï¼‰
synchronous_standby_names = 'FIRST 2 (replica1, replica2, replica3)'
```

**Quorumé…ç½®ç¤ºä¾‹**ï¼š

```text
# ä»»æ„1ä¸ªå¤‡åº“åŒæ­¥å³å¯
synchronous_standby_names = 'ANY 1 (node_b, node_c)'

# ä»»æ„2ä¸ªå¤‡åº“åŒæ­¥
synchronous_standby_names = 'ANY 2 (node_b, node_c, node_d)'
```

#### 2.3.3 RPO/RTOæƒè¡¡

**ä¸åŒåŒæ­¥ç­–ç•¥çš„RPO/RTOå¯¹æ¯”**ï¼š

| ç­–ç•¥ | RPO | RTO | é€‚ç”¨åœºæ™¯ |
|------|-----|-----|---------|
| å¼‚æ­¥å¤åˆ¶ | æ•°ç§’åˆ°æ•°åˆ†é’Ÿ | æ•°åˆ†é’Ÿ | å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ |
| åŒæ­¥å¤åˆ¶ï¼ˆremote_writeï¼‰ | 0ï¼ˆä»åº“ä¸å´©æºƒï¼‰ | æ•°åˆ†é’Ÿ | å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§ |
| åŒæ­¥å¤åˆ¶ï¼ˆremote_applyï¼‰ | 0 | æ•°åˆ†é’Ÿ | é‡‘èã€æ”¯ä»˜ç­‰å¼ºä¸€è‡´æ€§åœºæ™¯ |

### 2.4 å¤åˆ¶å»¶è¿Ÿç®¡ç†

#### 2.4.1 ç›‘æ§å¤åˆ¶å»¶è¿Ÿ

```sql
-- å®æ—¶ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) / 1024 / 1024 AS lag_mb,
    EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS lag_seconds
FROM pg_stat_replication;
```

#### 2.4.2 å‡å°‘å¤åˆ¶å»¶è¿Ÿ

**ä¼˜åŒ–å»ºè®®**ï¼š

1. **å¢åŠ WALä¿ç•™**ï¼š

   ```text
   wal_keep_size = '2GB'
   ```

2. **ä½¿ç”¨å¤åˆ¶æ§½**ï¼š

   ```sql
   SELECT * FROM pg_create_physical_replication_slot('replica1');
   ```

3. **ä¼˜åŒ–ä»åº“æ€§èƒ½**ï¼š
   - ä½¿ç”¨SSDå­˜å‚¨
   - å¢åŠ ä»åº“å†…å­˜
   - ä¼˜åŒ–æ£€æŸ¥ç‚¹å‚æ•°

4. **ç½‘ç»œä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ
   - å¢åŠ ç½‘ç»œå¸¦å®½
   - å‡å°‘ç½‘ç»œå»¶è¿Ÿ

## ä¸‰ã€é«˜å¯ç”¨ç»„ä»¶

### 3.1 Patronié«˜å¯ç”¨

**Patroni**æ˜¯ä¸€ä¸ªç”¨äºPostgreSQLé«˜å¯ç”¨çš„æ¨¡æ¿ï¼Œæ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»å’Œé›†ç¾¤ç®¡ç†ã€‚

#### 3.1.1 å®‰è£…Patroni

```bash
# ä½¿ç”¨pipå®‰è£…
pip install patroni[etcd]

# æˆ–ä½¿ç”¨yumå®‰è£…ï¼ˆCentOS/RHELï¼‰
sudo yum install -y patroni python3-etcd
```

#### 3.1.2 é…ç½®Patroni

**patroni.ymlé…ç½®ç¤ºä¾‹**ï¼š

```yaml
scope: pg_cluster
namespace: /service/pg
name: node_a

restapi:
  listen: 0.0.0.0:8008
  connect_address: node_a:8008
  authentication:
    username: admin
    password: admin_password

etcd:
  hosts: [etcd1:2379, etcd2:2379, etcd3:2379]
  protocol: http

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        wal_keep_size: 1GB
        max_wal_senders: 10
        max_replication_slots: 10
        synchronous_commit: "on"
        synchronous_standby_names: "ANY 1 (node_b, node_c)"

postgresql:
  listen: 0.0.0.0:5432
  connect_address: node_a:5432
  data_dir: /var/lib/postgresql/data
  bin_dir: /usr/lib/postgresql/18/bin
  pgpass: /var/lib/postgresql/.pgpass
  parameters:
    wal_level: replica
    max_connections: 200
    max_wal_senders: 10
    max_replication_slots: 10
    wal_keep_size: 1GB
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (node_b, node_c)'
  pg_hba:
    - host all all 0.0.0.0/0 md5
    - host replication repl 0.0.0.0/0 md5
  authentication:
    replication:
      username: repl
      password: "repl_password"
    superuser:
      username: postgres
      password: "postgres_password"

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```

#### 3.1.3 å¯åŠ¨Patroni

```bash
# å¯åŠ¨PatroniæœåŠ¡
sudo systemctl start patroni
sudo systemctl enable patroni

# æ£€æŸ¥çŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list
```

#### 3.1.4 Patroniå¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list

# æ‰‹åŠ¨æ•…éšœè½¬ç§»
patronictl -c /etc/patroni/patroni.yml failover

# é‡å¯èŠ‚ç‚¹
patronictl -c /etc/patroni/patroni.yml restart node_a

# é‡æ–°åŠ è½½é…ç½®
patronictl -c /etc/patroni/patroni.yml reload node_a
```

### 3.2 pgpool-IIè¯»å†™åˆ†ç¦»

**pgpool-II**æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæä¾›è¿æ¥æ± ã€è´Ÿè½½å‡è¡¡ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ç­‰åŠŸèƒ½ã€‚

#### 3.2.1 å®‰è£…pgpool-II

```bash
# Ubuntu/Debian
sudo apt-get install pgpool2

# CentOS/RHEL
sudo yum install pgpool-II
```

#### 3.2.2 é…ç½®pgpool-II

**pgpool.confé…ç½®ç¤ºä¾‹**ï¼š

```text
# ç›‘å¬åœ°å€å’Œç«¯å£
listen_addresses = '*'
port = 9999

# åç«¯æ•°æ®åº“é…ç½®
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 0
backend_flag0 = 'ALLOW_TO_FAILOVER'

backend_hostname1 = 'standby1_host'
backend_port1 = 5432
backend_weight1 = 1
backend_flag1 = 'ALLOW_TO_FAILOVER'

backend_hostname2 = 'standby2_host'
backend_port2 = 5432
backend_weight2 = 1
backend_flag2 = 'ALLOW_TO_FAILOVER'

# ä¸»ä»å¤åˆ¶æ¨¡å¼
master_slave_mode = on
master_slave_sub_mode = 'stream'

# è´Ÿè½½å‡è¡¡
load_balance_mode = on

# å¥åº·æ£€æŸ¥
health_check_period = 30
health_check_timeout = 10
health_check_user = 'postgres'
health_check_password = 'password'
health_check_database = 'postgres'

# æ•…éšœè½¬ç§»
failover_on_backend_error = on
failover_command = '/etc/pgpool-II/failover.sh %d %h %p %D %m %H %M %P %r %R'
```

#### 3.2.3 å¯åŠ¨pgpool-II

```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start pgpool-II
sudo systemctl enable pgpool-II

# æ£€æŸ¥çŠ¶æ€
psql -h localhost -p 9999 -U postgres -c "SHOW POOL_NODES;"
```

### 3.3 pgbouncerè¿æ¥æ± 

**pgbouncer**æ˜¯ä¸€ä¸ªè½»é‡çº§è¿æ¥æ± ï¼Œç”¨äºç®¡ç†æ•°æ®åº“è¿æ¥ã€‚

#### 3.3.1 å®‰è£…pgbouncer

```bash
# Ubuntu/Debian
sudo apt-get install pgbouncer

# CentOS/RHEL
sudo yum install pgbouncer
```

#### 3.3.2 é…ç½®pgbouncer

**pgbouncer.inié…ç½®ç¤ºä¾‹**ï¼š

```ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb

[pgbouncer]
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5
```

### 3.4 Keepalivedè™šæ‹ŸIP

**Keepalived**ç”¨äºå®ç°è™šæ‹ŸIPï¼ˆVIPï¼‰çš„è‡ªåŠ¨åˆ‡æ¢ã€‚

#### 3.4.1 å®‰è£…Keepalived

```bash
# Ubuntu/Debian
sudo apt-get install keepalived

# CentOS/RHEL
sudo yum install keepalived
```

#### 3.4.2 é…ç½®Keepalived

**keepalived.confé…ç½®ç¤ºä¾‹ï¼ˆä¸»èŠ‚ç‚¹ï¼‰**ï¼š

```text
vrrp_script chk_postgres {
    script "/usr/local/bin/check_postgres.sh"
    interval 2
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 101
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass your_password
    }
    virtual_ipaddress {
        10.0.0.100/24
    }
    track_script {
        chk_postgres
    }
}
```

**keepalived.confé…ç½®ç¤ºä¾‹ï¼ˆå¤‡èŠ‚ç‚¹ï¼‰**ï¼š

```text
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100
    # ... å…¶ä»–é…ç½®ç›¸åŒ
}
```

## å››ã€éƒ¨ç½²æ¶æ„

### 4.1 ä¸»ä»å¤åˆ¶æ¶æ„

**æ¶æ„å›¾**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“ (Primary)
  â”‚                â”‚
  â”‚                â”œâ”€ æµå¤åˆ¶ â”€â”€â†’ ä»åº“1 (Standby)
  â”‚                â””â”€ æµå¤åˆ¶ â”€â”€â†’ ä»åº“2 (Standby)
  â”‚
  â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
```

**ç‰¹ç‚¹**ï¼š

- ä¸€ä¸»å¤šä»
- ä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»
- ä»åº“å¯ä»¥æ°´å¹³æ‰©å±•
- é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯

### 4.2 ä¸€ä¸»å¤šä»æ¶æ„

**æ¶æ„å›¾**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“ (Primary)
  â”‚                â”‚
  â”‚                â”œâ”€ åŒæ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“1 (Sync Standby)
  â”‚                â”œâ”€ å¼‚æ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“2 (Async Standby)
  â”‚                â””â”€ å¼‚æ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“3 (Async Standby)
  â”‚
  â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
```

**é…ç½®ç¤ºä¾‹**ï¼š

```text
# postgresql.conf
synchronous_standby_names = 'FIRST 1 (standby1, standby2)'
```

### 4.3 å¤šä¸»æ¶æ„ï¼ˆCitusï¼‰

**Citus**æ˜¯PostgreSQLçš„åˆ†å¸ƒå¼æ‰©å±•ï¼Œæ”¯æŒå¤šä¸»æ¶æ„ã€‚

**æ¶æ„å›¾**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â””â”€ CoordinatorèŠ‚ç‚¹
        â”‚
        â”œâ”€ WorkerèŠ‚ç‚¹1ï¼ˆåˆ†ç‰‡1ï¼‰
        â”œâ”€ WorkerèŠ‚ç‚¹2ï¼ˆåˆ†ç‰‡2ï¼‰
        â””â”€ WorkerèŠ‚ç‚¹3ï¼ˆåˆ†ç‰‡3ï¼‰
```

### 4.4 ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´æ¶æ„

**æ¶æ„å›¾**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â””â”€ VIP (10.0.0.100)
        â”‚
        â”œâ”€ ä¸»åº“ (Primary) â”€â”€â”
        â”‚                    â”‚
        â”œâ”€ ä»åº“1 (Sync) â”€â”€â”€â”€â”€â”¼â”€ åŒæ­¥å¤åˆ¶
        â”‚                    â”‚
        â””â”€ ä»åº“2 (Sync) â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹**ï¼š

```text
# postgresql.conf
synchronous_standby_names = 'ANY 1 (standby1, standby2)'
```

## äº”ã€æ•…éšœè½¬ç§»ä¸æ¢å¤

### 5.1 è‡ªåŠ¨æ•…éšœè½¬ç§»

#### 5.1.1 Patroniè‡ªåŠ¨æ•…éšœè½¬ç§»

**æ•…éšœæ£€æµ‹**ï¼š

- Patroniå®šæœŸæ£€æŸ¥PostgreSQLå¥åº·çŠ¶æ€
- æ£€æµ‹åˆ°æ•…éšœåè‡ªåŠ¨è§¦å‘æ•…éšœè½¬ç§»
- ä»å¤‡åº“ä¸­é€‰ä¸¾æ–°çš„ä¸»åº“

**æ•…éšœè½¬ç§»æµç¨‹**ï¼š

1. æ£€æµ‹åˆ°ä¸»åº“æ•…éšœ
2. ä»åŒæ­¥å¤‡åº“ä¸­é€‰æ‹©æ–°çš„ä¸»åº“
3. æå‡æ–°ä¸»åº“
4. æ›´æ–°VIPï¼ˆå¦‚æœä½¿ç”¨Keepalivedï¼‰
5. é€šçŸ¥åº”ç”¨å±‚ï¼ˆå¦‚æœé…ç½®äº†å›è°ƒï¼‰

#### 5.1.2 pgpool-IIè‡ªåŠ¨æ•…éšœè½¬ç§»

**æ•…éšœæ£€æµ‹**ï¼š

- pgpool-IIå®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥
- æ£€æµ‹åˆ°åç«¯æ•…éšœåè‡ªåŠ¨åˆ‡æ¢

**æ•…éšœè½¬ç§»æµç¨‹**ï¼š

1. æ£€æµ‹åˆ°ä¸»åº“æ•…éšœ
2. è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡åº“
3. æ›´æ–°åç«¯çŠ¶æ€
4. åº”ç”¨å±‚è‡ªåŠ¨é‡è¿

### 5.2 æ‰‹åŠ¨æ•…éšœåˆ‡æ¢

#### 5.2.1 ä½¿ç”¨Patroniæ‰‹åŠ¨åˆ‡æ¢

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list

# æ‰‹åŠ¨æ•…éšœè½¬ç§»
patronictl -c /etc/patroni/patroni.yml failover

# æŒ‡å®šæ–°ä¸»åº“
patronictl -c /etc/patroni/patroni.yml failover --master node_a --candidate node_b
```

#### 5.2.2 ä½¿ç”¨PostgreSQLå‘½ä»¤åˆ‡æ¢

```sql
-- åœ¨ä¸»åº“ä¸Šæ‰§è¡Œï¼ˆPostgreSQL 12+ï¼‰
SELECT pg_promote();

-- æˆ–ä½¿ç”¨recovery.confï¼ˆPostgreSQL 11åŠä»¥ä¸‹ï¼‰
-- åœ¨ä»åº“ä¸Šåˆ›å»ºtriggeræ–‡ä»¶
touch /var/lib/postgresql/data/promote_trigger
```

### 5.3 æ•…éšœæ¢å¤æµç¨‹

#### 5.3.1 æ—§ä¸»åº“æ¢å¤ä¸ºä»åº“

**æ­¥éª¤1ï¼šæ¸…ç†æ—§ä¸»åº“æ•°æ®**ï¼š

```bash
# åœæ­¢PostgreSQL
sudo systemctl stop postgresql

# å¤‡ä»½æ•°æ®ç›®å½•
sudo mv /var/lib/postgresql/data /var/lib/postgresql/data.backup

# ä½¿ç”¨pg_basebackupé‡æ–°åˆå§‹åŒ–
pg_basebackup -h new_primary -U repl -D /var/lib/postgresql/data -X stream -R -C -S replica1
```

**æ­¥éª¤2ï¼šå¯åŠ¨ä»åº“**ï¼š

```bash
sudo systemctl start postgresql
```

**æ­¥éª¤3ï¼šéªŒè¯å¤åˆ¶çŠ¶æ€**ï¼š

```sql
SELECT pg_is_in_recovery();
```

### 5.4 RTO/RPOè¯„ä¼°

**ä¸åŒæ–¹æ¡ˆçš„RTO/RPOå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | RTO | RPO | è¯´æ˜ |
|------|-----|-----|------|
| å¼‚æ­¥å¤åˆ¶ | 5-15åˆ†é’Ÿ | æ•°ç§’åˆ°æ•°åˆ†é’Ÿ | éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ |
| åŒæ­¥å¤åˆ¶+Patroni | 30ç§’-2åˆ†é’Ÿ | 0 | è‡ªåŠ¨æ•…éšœè½¬ç§» |
| åŒæ­¥å¤åˆ¶+pgpool-II | 1-3åˆ†é’Ÿ | 0 | è‡ªåŠ¨åˆ‡æ¢ |
| ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´ | 30ç§’-1åˆ†é’Ÿ | 0 | æœ€é«˜å¯ç”¨æ€§ |

## å…­ã€ç›‘æ§ä¸è¯Šæ–­

### 6.1 å¤åˆ¶çŠ¶æ€ç›‘æ§

```sql
-- æŸ¥çœ‹æ‰€æœ‰å¤åˆ¶è¿æ¥
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag,
    pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag,
    pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS total_lag
FROM pg_stat_replication;
```

### 6.2 å»¶è¿Ÿç›‘æ§

```sql
-- ç›‘æ§å¤åˆ¶å»¶è¿Ÿï¼ˆå­—èŠ‚ï¼‰
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) / 1024 / 1024 AS lag_mb
FROM pg_stat_replication;

-- ç›‘æ§å¤åˆ¶å»¶è¿Ÿï¼ˆæ—¶é—´ï¼‰
SELECT
    application_name,
    EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS lag_seconds
FROM pg_stat_replication;
```

### 6.3 å¥åº·æ£€æŸ¥

**ä½¿ç”¨Patroni APIæ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
curl http://node_a:8008/patroni

# æ£€æŸ¥ä¸»åº“ä¿¡æ¯
curl http://node_a:8008/patroni | jq '.role'
```

**ä½¿ç”¨pg_isreadyæ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥PostgreSQLæ˜¯å¦å°±ç»ª
pg_isready -h primary_host -p 5432
```

## ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 7.1 å¤åˆ¶æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | ç‰©ç†å¤åˆ¶ | é€»è¾‘å¤åˆ¶ |
|------|---------|---------|
| å¤åˆ¶ç²’åº¦ | æ•´ä¸ªæ•°æ®åº“ | è¡¨çº§åˆ« |
| å»¶è¿Ÿ | ä½ï¼ˆæ¯«ç§’çº§ï¼‰ | ä¸­ï¼ˆç§’çº§ï¼‰ |
| æ€§èƒ½å½±å“ | ä½ | ä¸­ |
| ç‰ˆæœ¬è¦æ±‚ | PostgreSQL 9.0+ | PostgreSQL 10+ |
| é€‚ç”¨åœºæ™¯ | é«˜å¯ç”¨ã€å¤‡ä»½ | æ•°æ®è¿ç§»ã€å¤šä¸» |

### 7.2 é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | RTO | RPO | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|--------|-----|-----|------|---------|
| Patroni | é«˜ | 30ç§’-2åˆ†é’Ÿ | 0 | ä¸­ | ç”Ÿäº§ç¯å¢ƒ |
| pgpool-II | ä¸­ | 1-3åˆ†é’Ÿ | 0 | ä½ | ä¸­å°è§„æ¨¡ |
| Keepalived | ä½ | 1-2åˆ†é’Ÿ | 0 | ä½ | ç®€å•åœºæ™¯ |
| æ‰‹åŠ¨åˆ‡æ¢ | ä½ | 5-15åˆ†é’Ÿ | æ•°ç§’åˆ°æ•°åˆ†é’Ÿ | æœ€ä½ | éå…³é”®ä¸šåŠ¡ |

### 7.3 æ¶æ„æ¨¡å¼å¯¹æ¯”

| æ¶æ„ | èŠ‚ç‚¹æ•° | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | æˆæœ¬ |
|------|--------|--------|------|--------|------|
| ä¸€ä¸»ä¸€ä» | 2 | ä¸­ | ä¸­ | ä½ | ä½ |
| ä¸€ä¸»å¤šä» | 3+ | é«˜ | é«˜ | ä¸­ | ä¸­ |
| ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´ | 3 | æœ€é«˜ | ä¸­ | é«˜ | ä¸­ |
| å¤šä¸»ï¼ˆCitusï¼‰ | 4+ | é«˜ | æœ€é«˜ | æœ€é«˜ | é«˜ |

## å…«ã€å®è·µæ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°é«˜å¯ç”¨éƒ¨ç½²

**éœ€æ±‚**ï¼š

- 7Ã—24å°æ—¶æœåŠ¡
- è¯»å¤šå†™å°‘ï¼ˆè¯»å†™æ¯”8:2ï¼‰
- RTO < 2åˆ†é’Ÿï¼ŒRPO = 0

**æ¶æ„**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â”œâ”€ å†™æ“ä½œ â”€â”€â†’ pgpool-II â”€â”€â†’ ä¸»åº“
  â”‚                                â”‚
  â”‚                                â”œâ”€ åŒæ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“1
  â”‚                                â””â”€ å¼‚æ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“2
  â”‚
  â””â”€ è¯»æ“ä½œ â”€â”€â†’ pgpool-II â”€â”€â†’ ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
```

**é…ç½®è¦ç‚¹**ï¼š

- ä½¿ç”¨Patroniç®¡ç†é«˜å¯ç”¨
- pgpool-IIå®ç°è¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡
- ä¸»åº“ä¸ä»åº“1åŒæ­¥å¤åˆ¶ï¼Œä»åº“2å¼‚æ­¥å¤åˆ¶
- ä½¿ç”¨Keepalivedå®ç°VIPåˆ‡æ¢

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- RTO: 1-2åˆ†é’Ÿ
- RPO: 0
- è¯»æ€§èƒ½æå‡: 2å€ï¼ˆ2ä¸ªä»åº“ï¼‰
- å¯ç”¨æ€§: 99.9%

### 8.2 æ¡ˆä¾‹2ï¼šé‡‘èç³»ç»Ÿå¼ºä¸€è‡´éƒ¨ç½²

**éœ€æ±‚**ï¼š

- å¼ºä¸€è‡´æ€§è¦æ±‚
- é›¶æ•°æ®ä¸¢å¤±
- RTO < 1åˆ†é’Ÿ

**æ¶æ„**ï¼š

```text
åº”ç”¨å±‚
  â”‚
  â””â”€ VIP â”€â”€â†’ ä¸»åº“
              â”‚
              â”œâ”€ åŒæ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“1
              â””â”€ åŒæ­¥å¤åˆ¶ â”€â”€â†’ ä»åº“2
```

**é…ç½®è¦ç‚¹**ï¼š

- ä¸‰èŠ‚ç‚¹å¼ºä¸€è‡´æ¶æ„
- ä½¿ç”¨QuorumåŒæ­¥ï¼ˆANY 1ï¼‰
- Patroniè‡ªåŠ¨æ•…éšœè½¬ç§»
- æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨SSDå­˜å‚¨

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- RTO: 30ç§’-1åˆ†é’Ÿ
- RPO: 0
- å†™å»¶è¿Ÿ: å¢åŠ 10-20msï¼ˆåŒæ­¥å¤åˆ¶ï¼‰
- å¯ç”¨æ€§: 99.99%

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 éƒ¨ç½²æœ€ä½³å®è·µ

1. **ç½‘ç»œé…ç½®**ï¼š
   - ä½¿ç”¨ä¸“ç”¨ç½‘ç»œè¿›è¡Œå¤åˆ¶
   - ç¡®ä¿ç½‘ç»œå»¶è¿Ÿ < 1ms
   - ä½¿ç”¨åƒå…†æˆ–ä¸‡å…†ç½‘ç»œ

2. **å­˜å‚¨é…ç½®**ï¼š
   - ä¸»åº“å’Œä»åº“ä½¿ç”¨ç›¸åŒå­˜å‚¨ç±»å‹
   - ä½¿ç”¨SSDæé«˜æ€§èƒ½
   - é…ç½®RAIDæé«˜å¯é æ€§

3. **ç›‘æ§é…ç½®**ï¼š
   - é…ç½®å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
   - ç›‘æ§èŠ‚ç‚¹å¥åº·çŠ¶æ€
   - å®šæœŸæ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§

### 9.2 è¿ç»´æœ€ä½³å®è·µ

1. **å®šæœŸæ¼”ç»ƒ**ï¼š
   - æ¯æœˆæ‰§è¡Œä¸€æ¬¡æ•…éšœè½¬ç§»æ¼”ç»ƒ
   - æµ‹è¯•è‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½
   - éªŒè¯æ¢å¤æµç¨‹

2. **å¤‡ä»½ç­–ç•¥**ï¼š
   - å®šæœŸå…¨é‡å¤‡ä»½
   - æŒç»­WALå½’æ¡£
   - æµ‹è¯•æ¢å¤æµç¨‹

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å®šæœŸåˆ†ææ…¢æŸ¥è¯¢
   - ä¼˜åŒ–å¤åˆ¶å»¶è¿Ÿ
   - è°ƒæ•´è¿æ¥æ± å‚æ•°

## åã€æ•…éšœæ’æŸ¥

### 10.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šå¤åˆ¶å»¶è¿Ÿè¿‡å¤§

**ç—‡çŠ¶**ï¼šä»åº“å»¶è¿ŸæŒç»­å¢é•¿

**åŸå› **ï¼š

- ä»åº“æ€§èƒ½ä¸è¶³
- ç½‘ç»œå¸¦å®½ä¸è¶³
- WALç”Ÿæˆè¿‡å¿«

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ£€æŸ¥å»¶è¿Ÿ
SELECT pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) FROM pg_stat_replication;

-- ä¼˜åŒ–ä»åº“æ€§èƒ½
-- å¢åŠ å†…å­˜ã€ä½¿ç”¨SSDã€ä¼˜åŒ–æ£€æŸ¥ç‚¹å‚æ•°
```

#### é—®é¢˜2ï¼šæ•…éšœè½¬ç§»å¤±è´¥

**ç—‡çŠ¶**ï¼šä¸»åº“æ•…éšœåæ— æ³•è‡ªåŠ¨åˆ‡æ¢

**åŸå› **ï¼š

- Patronié…ç½®é”™è¯¯
- ç½‘ç»œè¿æ¥é—®é¢˜
- ä»åº“çŠ¶æ€å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥PatroniçŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list

# æ£€æŸ¥æ—¥å¿—
journalctl -u patroni -f

# æ‰‹åŠ¨æ•…éšœè½¬ç§»
patronictl -c /etc/patroni/patroni.yml failover
```

### 10.2 è¯Šæ–­æ–¹æ³•

**æ£€æŸ¥å¤åˆ¶çŠ¶æ€**ï¼š

```sql
-- æŸ¥çœ‹å¤åˆ¶è¿æ¥
SELECT * FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;

-- æŸ¥çœ‹WALçŠ¶æ€
SELECT pg_current_wal_lsn(), pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn();
```

**æ£€æŸ¥èŠ‚ç‚¹å¥åº·**ï¼š

```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
pg_isready -h hostname -p 5432

# æ£€æŸ¥PatroniçŠ¶æ€
curl http://hostname:8008/patroni

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
top
iostat -x 1
```

## åä¸€ã€å‚è€ƒèµ„æº

### 11.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLæµå¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/warm-standby.html)
- [PostgreSQLé€»è¾‘å¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/logical-replication.html)
- [Patroniå®˜æ–¹æ–‡æ¡£](https://patroni.readthedocs.io/)
- [pgpool-IIå®˜æ–¹æ–‡æ¡£](https://www.pgpool.net/docs/)

### 11.2 ç›¸å…³æ–‡æ¡£

- [å•æœºéƒ¨ç½²ä¸é…ç½®](./04.01-å•æœºéƒ¨ç½²ä¸é…ç½®.md)
- [ç›‘æ§ä¸è¯Šæ–­](./04.04-ç›‘æ§ä¸è¯Šæ–­.md)
- [å¤‡ä»½ä¸æ¢å¤](./04.05-å¤‡ä»½ä¸æ¢å¤.md)
- [æ€§èƒ½è°ƒä¼˜å®è·µ](./04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: Data Science Team
