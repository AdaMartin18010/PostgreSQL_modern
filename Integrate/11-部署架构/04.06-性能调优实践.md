---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\04-éƒ¨ç½²è¿ç»´\04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLæ€§èƒ½è°ƒä¼˜å®è·µå®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–ã€ç³»ç»Ÿè°ƒä¼˜ã€æ€§èƒ½é—®é¢˜è¯Šæ–­ã€æ€§èƒ½åŸºå‡†æµ‹è¯•
> ğŸ†• **PostgreSQL 18 + pgvector 2.0 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹** â­â­â­
>
> PostgreSQL 18 + pgvector 2.0 å¸¦æ¥å¤šé¡¹æ€§èƒ½æ”¹è¿›ï¼Œè°ƒä¼˜æ—¶åº”é‡ç‚¹å…³æ³¨ï¼š
>
> - âœ… **å¼‚æ­¥ I/O å­ç³»ç»Ÿ**: å‘é‡æ£€ç´¢ I/O æ€§èƒ½æå‡ 2-3 å€ â­â­â­
> - âœ… **è™šæ‹Ÿç”Ÿæˆåˆ—**: åŠ¨æ€è®¡ç®—ä¼˜åŒ–ï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡ 15-25% â­â­
> - âœ… **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**: æ›´æ™ºèƒ½çš„å¹¶è¡Œæ‰§è¡Œè®¡åˆ’ï¼Œå»ºè®®è°ƒæ•´max_parallel_workers
> - âœ… **ç´¢å¼•ä¼˜åŒ–**: B-treeå»é‡ä¼˜åŒ–ï¼ŒBRINæ€§èƒ½æå‡15-20%
> - âœ… **å†…å­˜ç®¡ç†**: åŠ¨æ€å…±äº«å†…å­˜ï¼Œå¯å‡å°‘é¢„åˆ†é…å†…å­˜
> - âœ… **å‘é‡æ“ä½œ**: pgvector 2.0 SIMDä¼˜åŒ–ï¼Œæ€§èƒ½æå‡35-45%

---

## ğŸ“‘ ç›®å½•

- [1.1 æ€§èƒ½è°ƒä¼˜æ¦‚å¿µ](#11-æ€§èƒ½è°ƒä¼˜æ¦‚å¿µ)
- [1.2 è°ƒä¼˜æ–¹æ³•è®º](#12-è°ƒä¼˜æ–¹æ³•è®º)
- [1.3 æ€§èƒ½æŒ‡æ ‡](#13-æ€§èƒ½æŒ‡æ ‡)
- [2.1 å»ºç«‹æ€§èƒ½åŸºçº¿](#21-å»ºç«‹æ€§èƒ½åŸºçº¿)
- [2.2 å˜æ›´ç®¡ç†æµç¨‹](#22-å˜æ›´ç®¡ç†æµç¨‹)
- [2.3 å›æ»šç­–ç•¥](#23-å›æ»šç­–ç•¥)
- [3.1 æ€§èƒ½è¯Šæ–­æµç¨‹](#31-æ€§èƒ½è¯Šæ–­æµç¨‹)
- [3.2 ç“¶é¢ˆè¯†åˆ«](#32-ç“¶é¢ˆè¯†åˆ«)
- [3.3 ä¼˜åŒ–ç­–ç•¥é€‰æ‹©](#33-ä¼˜åŒ–ç­–ç•¥é€‰æ‹©)
- [5.1 è¿æ¥ä¸å¹¶å‘å‚æ•°](#51-è¿æ¥ä¸å¹¶å‘å‚æ•°)
- [5.2 å†…å­˜å‚æ•°](#52-å†…å­˜å‚æ•°)
- [5.3 I/Oå‚æ•°](#53-ioå‚æ•°)
- [5.4 WALå‚æ•°](#54-walå‚æ•°)
- [5.5 æ£€æŸ¥ç‚¹å‚æ•°](#55-æ£€æŸ¥ç‚¹å‚æ•°)
- [5.6 Autovacuumå‚æ•°](#56-autovacuumå‚æ•°)
- [6.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#61-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
- [6.2 ç´¢å¼•ä¼˜åŒ–](#62-ç´¢å¼•ä¼˜åŒ–)
- [6.3 ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–](#63-ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–)
- [6.4 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#64-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
- [7.1 è¡¨è®¾è®¡ä¼˜åŒ–](#71-è¡¨è®¾è®¡ä¼˜åŒ–)
- [7.2 åˆ†åŒºç­–ç•¥](#72-åˆ†åŒºç­–ç•¥)
- [7.3 ç´¢å¼•è®¾è®¡](#73-ç´¢å¼•è®¾è®¡)
- [8.1 å¼‚æ­¥I/Oä¼˜åŒ–](#81-å¼‚æ­¥ioä¼˜åŒ–)
- [8.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#82-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
- [8.3 å¹¶è¡ŒæŸ¥è¯¢å¢å¼º](#83-å¹¶è¡ŒæŸ¥è¯¢å¢å¼º)
- [9.1 å·¥ä½œè´Ÿè½½é…ç½®å¯¹æ¯”](#91-å·¥ä½œè´Ÿè½½é…ç½®å¯¹æ¯”)
- [9.2 å‚æ•°è°ƒä¼˜å¯¹æ¯”](#92-å‚æ•°è°ƒä¼˜å¯¹æ¯”)
- [12.1 æ€§èƒ½éªŒè¯](#121-æ€§èƒ½éªŒè¯)
- [12.2 å›å½’æµ‹è¯•](#122-å›å½’æµ‹è¯•)
- [12.3 ç›‘æ§å‘Šè­¦](#123-ç›‘æ§å‘Šè­¦)
- [13.1 è°ƒä¼˜æœ€ä½³å®è·µ](#131-è°ƒä¼˜æœ€ä½³å®è·µ)
- [13.2 é¿å…å¸¸è§é”™è¯¯](#132-é¿å…å¸¸è§é”™è¯¯)
- [14.1 å®˜æ–¹æ–‡æ¡£](#141-å®˜æ–¹æ–‡æ¡£)
- [14.2 ç›¸å…³æ–‡æ¡£](#142-ç›¸å…³æ–‡æ¡£)
- [å¼‚æ­¥ I/O ä¼˜åŒ–](#å¼‚æ­¥-io-ä¼˜åŒ–)
- [è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
- [æ¡ˆä¾‹1: OLTPç³»ç»Ÿè°ƒä¼˜](#æ¡ˆä¾‹1-oltpç³»ç»Ÿè°ƒä¼˜)
- [æ¡ˆä¾‹2: OLAPåˆ†æç³»ç»Ÿè°ƒä¼˜](#æ¡ˆä¾‹2-olapåˆ†æç³»ç»Ÿè°ƒä¼˜)
- [æ¡ˆä¾‹3: æ··åˆè´Ÿè½½è°ƒä¼˜](#æ¡ˆä¾‹3-æ··åˆè´Ÿè½½è°ƒä¼˜)
- [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
- [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
---

## ä¸€ã€æ¦‚è¿°

### 1.1 æ€§èƒ½è°ƒä¼˜æ¦‚å¿µ

**æ€§èƒ½è°ƒä¼˜ï¼ˆPerformance Tuningï¼‰**æ˜¯é€šè¿‡ç³»ç»Ÿé…ç½®ã€å‚æ•°è°ƒæ•´ã€æŸ¥è¯¢ä¼˜åŒ–ç­‰æ‰‹æ®µï¼Œæå‡æ•°æ®åº“ç³»ç»Ÿæ€§èƒ½çš„è¿‡ç¨‹ã€‚

**æ€§èƒ½è°ƒä¼˜çš„ç›®æ ‡**ï¼š

- **æé«˜ååé‡**ï¼šå¤„ç†æ›´å¤šäº‹åŠ¡/æŸ¥è¯¢
- **é™ä½å»¶è¿Ÿ**ï¼šå‡å°‘å“åº”æ—¶é—´
- **æé«˜èµ„æºåˆ©ç”¨ç‡**ï¼šæ›´é«˜æ•ˆä½¿ç”¨CPUã€å†…å­˜ã€I/O
- **ä¿è¯ç¨³å®šæ€§**ï¼šé¿å…æ€§èƒ½æ³¢åŠ¨å’Œç³»ç»Ÿä¸ç¨³å®š

### 1.2 è°ƒä¼˜æ–¹æ³•è®º

**æ€§èƒ½è°ƒä¼˜é—­ç¯**ï¼š

```text
ç›‘æµ‹ â†’ è¯Šæ–­ â†’ å®šä½ â†’ ä¼˜åŒ– â†’ éªŒè¯ â†’ å›å½’é˜²æŠ¤
  â†‘                                              â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†å±‚è°ƒä¼˜**ï¼š

1. **ç³»ç»Ÿèµ„æºå±‚**ï¼šCPUã€å†…å­˜ã€I/Oã€ç½‘ç»œ
2. **æ•°æ®åº“å®ä¾‹å±‚**ï¼šè¿æ¥ã€ç¼“å†²ã€æ£€æŸ¥ç‚¹ã€WALã€Autovacuum
3. **å¯¹è±¡å±‚**ï¼šè¡¨ã€ç´¢å¼•ã€è†¨èƒ€
4. **æŸ¥è¯¢å±‚**ï¼šæ‰§è¡Œè®¡åˆ’ã€ä»£ä»·ã€å¹¶è¡Œã€åŸºæ•°
5. **åº”ç”¨å±‚**ï¼šè¿æ¥æ± ã€äº‹åŠ¡æ¨¡å‹ã€SQLä¼˜åŒ–

### 1.3 æ€§èƒ½æŒ‡æ ‡

**å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆKPIï¼‰**ï¼š

- **ååé‡**ï¼šTPSï¼ˆäº‹åŠ¡/ç§’ï¼‰ã€QPSï¼ˆæŸ¥è¯¢/ç§’ï¼‰
- **å»¶è¿Ÿ**ï¼šP50ã€P95ã€P99å“åº”æ—¶é—´
- **èµ„æºåˆ©ç”¨ç‡**ï¼šCPUã€å†…å­˜ã€I/Oä½¿ç”¨ç‡
- **é”™è¯¯ç‡**ï¼šå¤±è´¥äº‹åŠ¡/æŸ¥è¯¢æ¯”ä¾‹
- **é˜Ÿåˆ—é•¿åº¦**ï¼šç­‰å¾…å¤„ç†çš„è¯·æ±‚æ•°

## äºŒã€åŸºçº¿ä¸å˜æ›´æ²»ç†

### 2.1 å»ºç«‹æ€§èƒ½åŸºçº¿

**æ€§èƒ½åŸºçº¿åŒ…å«**ï¼š

1. **å‚æ•°åŸºçº¿**ï¼šè®°å½•æ‰€æœ‰å…³é”®å‚æ•°çš„å½“å‰å€¼
2. **æ€§èƒ½æŒ‡æ ‡åŸºçº¿**ï¼šTPSã€QPSã€å»¶è¿Ÿã€èµ„æºä½¿ç”¨ç‡
3. **SLAç›®æ ‡**ï¼šå®šä¹‰æ€§èƒ½ç›®æ ‡å’Œé˜ˆå€¼
4. **å›æ»šè„šæœ¬**ï¼šå‡†å¤‡å‚æ•°å›æ»šè„šæœ¬

**åŸºçº¿è®°å½•è¡¨**ï¼š

```sql
-- åˆ›å»ºå‚æ•°åŸºçº¿è¡¨
CREATE TABLE parameter_baseline (
    parameter_name VARCHAR(255) PRIMARY KEY,
    current_value TEXT NOT NULL,
    baseline_date TIMESTAMPTZ DEFAULT NOW(),
    description TEXT
);

-- è®°å½•å…³é”®å‚æ•°
INSERT INTO parameter_baseline (parameter_name, current_value, description)
VALUES
    ('max_connections', current_setting('max_connections'), 'æœ€å¤§è¿æ¥æ•°'),
    ('shared_buffers', current_setting('shared_buffers'), 'å…±äº«ç¼“å†²åŒº'),
    ('work_mem', current_setting('work_mem'), 'å·¥ä½œå†…å­˜');
```

### 2.2 å˜æ›´ç®¡ç†æµç¨‹

**å˜æ›´ç®¡ç†åŸåˆ™**ï¼š

1. **å•å˜é‡å˜æ›´**ï¼šæ¯æ¬¡åªå˜æ›´ä¸€ä¸ªæˆ–å°‘é‡ç›¸å…³å‚æ•°
2. **è®°å½•å˜æ›´**ï¼šè¯¦ç»†è®°å½•å˜æ›´å†…å®¹
3. **éªŒè¯çª—å£**ï¼šè®¾ç½®åˆç†çš„éªŒè¯æ—¶é—´çª—å£
4. **å›æ»šæ¡ä»¶**ï¼šå®šä¹‰æ˜ç¡®çš„å›æ»šè§¦å‘æ¡ä»¶

**å˜æ›´ç¥¨æ®æ¨¡æ¿**ï¼š

```sql
-- å˜æ›´è®°å½•è¡¨
CREATE TABLE parameter_changes (
    change_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parameter_name VARCHAR(255) NOT NULL,
    old_value TEXT NOT NULL,
    new_value TEXT NOT NULL,
    expected_impact TEXT,
    validation_window INTERVAL,
    rollback_condition TEXT,
    change_date TIMESTAMPTZ DEFAULT NOW(),
    changed_by VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending'  -- pending, applied, rolled_back
);
```

### 2.3 å›æ»šç­–ç•¥

**å›æ»šè§¦å‘æ¡ä»¶**ï¼š

- P95å»¶è¿Ÿæ¶åŒ–>10%
- é”™è¯¯ç‡å‡é«˜
- ç³»ç»Ÿè´Ÿè½½å¼‚å¸¸
- èµ„æºä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼

**å›æ»šè„šæœ¬**ï¼š

```sql
-- å›æ»šå‡½æ•°
CREATE OR REPLACE FUNCTION rollback_parameter_change(
    p_change_id UUID
)
RETURNS BOOLEAN
AS $$
DECLARE
    v_param_name VARCHAR(255);
    v_old_value TEXT;
BEGIN
    SELECT parameter_name, old_value
    INTO v_param_name, v_old_value
    FROM parameter_changes
    WHERE change_id = p_change_id;

    EXECUTE format('ALTER SYSTEM SET %I = %L', v_param_name, v_old_value);
    PERFORM pg_reload_conf();

    UPDATE parameter_changes
    SET status = 'rolled_back'
    WHERE change_id = p_change_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

## ä¸‰ã€è°ƒä¼˜æµç¨‹

### 3.1 æ€§èƒ½è¯Šæ–­æµç¨‹

**æ­¥éª¤åŒ–SOP**ï¼š

1. **å…¥å£æŒ‡å¾**ï¼šP99/åå/é”™è¯¯ç‡å¼‚å¸¸ã€é˜Ÿåˆ—å †ç§¯ã€å‘Šè­¦è§¦å‘
2. **å¿«é€Ÿä½“æ£€**ï¼šè¿æ¥ã€CPUåˆ©ç”¨ã€IOé¥±å’Œã€WAL/æ£€æŸ¥ç‚¹ã€Autovacuumæ»å
3. **TopNåˆ†æ**ï¼š`pg_stat_statements`/æ´»åŠ¨ä¼šè¯/ç­‰å¾…äº‹ä»¶
4. **è®¡åˆ’æ ¸æŸ¥**ï¼š`EXPLAIN (ANALYZE, BUFFERS, VERBOSE)` ä¸åŸºæ•°ã€å¹¶è¡Œåº¦ã€I/Oå‘½ä¸­
5. **ç­–ç•¥é€‰æ‹©**ï¼šç´¢å¼•/ç»Ÿè®¡/SQL/å‚æ•°/æ¶æ„æ”¹é€ 
6. **å°æ­¥å¿«è·‘**ï¼šå•å˜é‡å˜æ›´â†’å¯¹æ¯”æŒ‡æ ‡â†’ä¿ç•™æˆ–å›æ»š
7. **å›å½’å®ˆæŠ¤**ï¼šå‘Šè­¦é—¨æ§›ã€è‡ªåŠ¨å›æ»šå¼€å…³ï¼ˆå¿…è¦æ—¶ï¼‰

### 3.2 ç“¶é¢ˆè¯†åˆ«

**å¸¸è§ç“¶é¢ˆç±»å‹**ï¼š

1. **CPUç“¶é¢ˆ**ï¼šCPUä½¿ç”¨ç‡é«˜ï¼ŒæŸ¥è¯¢æ‰§è¡Œæ—¶é—´é•¿
2. **I/Oç“¶é¢ˆ**ï¼šç£ç›˜I/Oé¥±å’Œï¼Œç­‰å¾…I/Oæ—¶é—´é•¿
3. **å†…å­˜ç“¶é¢ˆ**ï¼šå†…å­˜ä¸è¶³ï¼Œé¢‘ç¹swap
4. **é”ç“¶é¢ˆ**ï¼šé”ç­‰å¾…æ—¶é—´é•¿ï¼Œå¹¶å‘æ€§èƒ½å·®
5. **ç½‘ç»œç“¶é¢ˆ**ï¼šç½‘ç»œå»¶è¿Ÿé«˜ï¼Œå¸¦å®½ä¸è¶³

**ç“¶é¢ˆè¯†åˆ«SQL**ï¼š

```sql
-- CPUç“¶é¢ˆè¯†åˆ«
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    now() - query_start AS query_duration,
    left(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state = 'active'
  AND now() - query_start > interval '5 seconds'
ORDER BY query_start;

-- I/Oç“¶é¢ˆè¯†åˆ«
SELECT
    schemaname,
    relname,
    heap_blks_read,
    heap_blks_hit,
    CASE
        WHEN heap_blks_read + heap_blks_hit > 0
        THEN round(100.0 * heap_blks_hit / (heap_blks_read + heap_blks_hit), 2)
        ELSE 0
    END AS hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 1000
ORDER BY heap_blks_read DESC
LIMIT 20;
```

### 3.3 ä¼˜åŒ–ç­–ç•¥é€‰æ‹©

**ä¼˜åŒ–ç­–ç•¥çŸ©é˜µ**ï¼š

| ç“¶é¢ˆç±»å‹ | ä¼˜åŒ–ç­–ç•¥ | ä¼˜å…ˆçº§ |
|---------|---------|--------|
| CPU | æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–ã€å¹¶è¡ŒæŸ¥è¯¢ | é«˜ |
| I/O | ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜ä¼˜åŒ–ã€I/Oå‚æ•°è°ƒä¼˜ | é«˜ |
| å†…å­˜ | è¿æ¥æ± ã€work_memè°ƒä¼˜ã€shared_buffers | ä¸­ |
| é” | äº‹åŠ¡ä¼˜åŒ–ã€é”è¶…æ—¶ã€è¿æ¥æ±  | ä¸­ |
| ç½‘ç»œ | è¿æ¥æ± ã€æ‰¹é‡æ“ä½œã€å‹ç¼© | ä½ |

## 5. å…¸å‹åœºæ™¯

- ç´¢å¼•/ç»Ÿè®¡ä¿¡æ¯ã€è¿æ¥æ± ã€å¹¶è¡Œã€å­˜å‚¨ä¸æ£€æŸ¥ç‚¹
- ç¤ºä¾‹æ’æŸ¥ä¸å¤„ç½®ï¼š
  - ä¼°ç®—åå·®â†’æ‰©å¤§ç»Ÿè®¡ç›®æ ‡æˆ–åˆ›å»ºæ‰©å±•ç»Ÿè®¡ï¼š

    ```sql
    ALTER TABLE t ALTER COLUMN c SET STATISTICS 2000;
    CREATE STATISTICS s_t_multi (dependencies) ON c1, c2 FROM t;  -- ç›¸å…³æ€§
    ANALYZE t;
    ```

  - ç´¢å¼•æœªå‘½ä¸­â†’è°“è¯å¯ç´¢å¼•åŒ–/è¡¨è¾¾å¼ç´¢å¼•/ç±»å‹ä¸€è‡´ï¼š

    ```sql
    CREATE INDEX idx_t_lower_email ON t (lower(email));
    -- ç¡®ä¿æŸ¥è¯¢ç”¨ lower(email) = ...
    ```

  - é”ç­‰å¾…â†’å®šä½æŒé”é•¿äº‹åŠ¡ä¸å†²çªè¯­å¥ï¼Œå¿…è¦æ—¶æ‹†åˆ†DDL/æ‰¹é‡ï¼š

    ```sql
    SELECT * FROM pg_locks l JOIN pg_stat_activity a USING(pid) WHERE NOT granted;
    ```

  - è†¨èƒ€â†’è¯„ä¼° `autovacuum`ã€é‡å»ºç´¢å¼•/è¡¨ï¼š

    ```sql
    REINDEX TABLE CONCURRENTLY t;
    VACUUM (VERBOSE, ANALYZE) t;
    ```

## 6. å·¥å…·ä¸æ–¹æ³•

- EXPLAIN(ANALYZE, BUFFERS)ã€pg_stat_statementsã€é‡‡æ ·/å‰–æ
- å¿…å¤‡æ‰©å±•ä¸è®¾ç½®ï¼š
  - `pg_stat_statements`ï¼š

    ```sql
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
    SELECT query, calls, mean_time, rows
    FROM pg_stat_statements ORDER BY total_time DESC LIMIT 20;
    ```

  - `auto_explain`ï¼ˆå¼€å‘/é¢„ç”Ÿäº§å¯ç”¨ï¼Œç”Ÿäº§æ…ç”¨é«˜é˜ˆå€¼ï¼‰ï¼š

    ```text
    shared_preload_libraries = 'pg_stat_statements,auto_explain'
    auto_explain.log_min_duration = '200ms'
    auto_explain.log_analyze = on
    auto_explain.log_buffers = on
    auto_explain.log_nested_statements = on
    ```

  - é‡‡æ ·ä¸ç­‰å¾…åˆ†æï¼š`pg_wait_sampling`ã€`pg_stat_kcache`ã€eBPF/bcc å·¥å…·ï¼ˆå¦‚ `profile`, `offcputime`ï¼‰ã€‚

## äº”ã€æ•°æ®åº“å‚æ•°è°ƒä¼˜

### 5.1 è¿æ¥ä¸å¹¶å‘å‚æ•°

#### 5.1.1 max_connections

**é…ç½®åŸåˆ™**ï¼š

- ä½¿ç”¨è¿æ¥æ± ï¼ˆpgbouncerï¼‰é™ä½max_connectionså‹åŠ›
- åŸºäºå†…å­˜é¢„ç®—å’Œå·¥ä½œè´Ÿè½½å¹¶å‘åº¦è®¾ç½®
- è¿‡é«˜ä¼šé™ä½å‘½ä¸­ç‡å’Œå¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- ä¸ä½¿ç”¨è¿æ¥æ± ï¼šmax_connections = 100-200
-- ä½¿ç”¨è¿æ¥æ± ï¼šmax_connections = 50-100ï¼Œpgbouncerå¤„ç†1000+è¿æ¥

-- è®¡ç®—å†…å­˜éœ€æ±‚
-- æ¯ä¸ªè¿æ¥çº¦å ç”¨10MBå†…å­˜ï¼ˆwork_mem + å…¶ä»–å¼€é”€ï¼‰
-- max_connections = 200 â†’ çº¦2GBå†…å­˜
ALTER SYSTEM SET max_connections = 200;
```

#### 5.1.2 work_mem

**é…ç½®åŸåˆ™**ï¼š

- æŒ‰å¹¶å‘æ’åº/å“ˆå¸Œæ“ä½œä¼°ç®—
- å¸¸è§åŸºçº¿ï¼š4-64MB
- é¿å…å…¨å±€æ”¾å¤§å¯¼è‡´å†…å­˜æº¢å‡º

**è®¡ç®—å…¬å¼**ï¼š

```text
work_mem = (å¯ç”¨å†…å­˜ - shared_buffers) / (max_connections * å¹¶å‘æ“ä½œæ•°)
```

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- OLTPï¼šè¾ƒå°work_mem
ALTER SYSTEM SET work_mem = '16MB';

-- OLAPï¼šè¾ƒå¤§work_mem
ALTER SYSTEM SET work_mem = '256MB';

-- ä¼šè¯çº§è°ƒæ•´
SET work_mem = '64MB';
```

### 5.2 å†…å­˜å‚æ•°

#### 5.2.1 shared_buffers

**é…ç½®åŸåˆ™**ï¼š

- å¸¸è§25%ç‰©ç†å†…å­˜èµ·æ­¥
- Linuxç³»ç»Ÿè€ƒè™‘PageCacheï¼Œè¶…å¤§æœªå¿…æ”¶ç›Šæ›´é«˜
- 32GBå†…å­˜ï¼š8GB shared_buffers

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- 32GBå†…å­˜ç³»ç»Ÿ
ALTER SYSTEM SET shared_buffers = '8GB';

-- 64GBå†…å­˜ç³»ç»Ÿ
ALTER SYSTEM SET shared_buffers = '16GB';

-- éœ€è¦é‡å¯PostgreSQL
```

#### 5.2.2 effective_cache_size

**é…ç½®åŸåˆ™**ï¼š

- ä¼°è®¡OS PageCache + shared_buffers
- å¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’
- 64GBå†…å­˜ï¼š48GB effective_cache_size

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- 64GBå†…å­˜ç³»ç»Ÿ
ALTER SYSTEM SET effective_cache_size = '48GB';
```

#### 5.2.3 maintenance_work_mem

**é…ç½®åŸåˆ™**ï¼š

- ç”¨äºVACUUMã€CREATE INDEXç­‰ç»´æŠ¤æ“ä½œ
- ç´¢å¼•é‡å»º/å¹¶è¡Œç»´æŠ¤æ—¶æé«˜
- å¸¸è§é…ç½®ï¼š512MB-4GB

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET maintenance_work_mem = '2GB';
```

### 5.3 I/Oå‚æ•°

#### 5.3.1 random_page_cost

**é…ç½®åŸåˆ™**ï¼š

- SSDï¼š1.1-1.5
- HDDï¼š4.0ï¼ˆé»˜è®¤ï¼‰
- NVMeï¼š1.0-1.1

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- SSD
ALTER SYSTEM SET random_page_cost = 1.1;

-- NVMe
ALTER SYSTEM SET random_page_cost = 1.0;
```

#### 5.3.2 effective_io_concurrency

**é…ç½®åŸåˆ™**ï¼š

- SSDï¼š200-300
- NVMeï¼š256-512
- HDDï¼š2-4

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- NVMe
ALTER SYSTEM SET effective_io_concurrency = 256;
```

### 5.4 WALå‚æ•°

#### 5.4.1 wal_compression

**é…ç½®åŸåˆ™**ï¼š

- å¯ç”¨å¯å‡å°‘WALå¤§å°ï¼ˆå†™æ”¾å¤§ä¸‹é™ï¼‰
- å¢åŠ CPUå¼€é”€
- å»ºè®®å¯ç”¨

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET wal_compression = on;
```

#### 5.4.2 synchronous_commit

**é…ç½®åŸåˆ™**ï¼š

- `on`ï¼šå¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒä½
- `off`ï¼šå¼‚æ­¥æäº¤ï¼Œæ€§èƒ½é«˜ä½†å¯èƒ½ä¸¢å¤±æ•°æ®
- `local`ï¼šæœ¬åœ°åŒæ­¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- å¼ºä¸€è‡´æ€§è¦æ±‚
ALTER SYSTEM SET synchronous_commit = on;

-- æ€§èƒ½ä¼˜å…ˆï¼ˆå¯æ¥å—æ•°æ®ä¸¢å¤±é£é™©ï¼‰
ALTER SYSTEM SET synchronous_commit = off;
```

### 5.5 æ£€æŸ¥ç‚¹å‚æ•°

#### 5.5.1 checkpoint_timeout

**é…ç½®åŸåˆ™**ï¼š

- æ§åˆ¶æ£€æŸ¥ç‚¹é¢‘ç‡
- å¸¸è§é…ç½®ï¼š10-30åˆ†é’Ÿ
- è¿‡é•¿å¯¼è‡´æ¢å¤æ—¶é—´é•¿ï¼Œè¿‡çŸ­å¯¼è‡´I/Oå‹åŠ›å¤§

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET checkpoint_timeout = '15min';
```

#### 5.5.2 max_wal_size

**é…ç½®åŸåˆ™**ï¼š

- æ§åˆ¶WALæœ€å¤§å¤§å°
- å¸¸è§é…ç½®ï¼š2-20GB
- å½±å“æ£€æŸ¥ç‚¹é¢‘ç‡å’Œæ¢å¤æ—¶é—´

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET max_wal_size = '4GB';
```

#### 5.5.3 checkpoint_completion_target

**é…ç½®åŸåˆ™**ï¼š

- æ§åˆ¶æ£€æŸ¥ç‚¹å®Œæˆæ—¶é—´
- å¸¸è§é…ç½®ï¼š0.7-0.9
- å¹³æ»‘I/Oè´Ÿè½½

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
```

### 5.6 Autovacuumå‚æ•°

#### 5.6.1 autovacuum_vacuum_scale_factor

**é…ç½®åŸåˆ™**ï¼š

- æ§åˆ¶ä½•æ—¶è§¦å‘VACUUM
- å¤§è¡¨å»ºè®®é™ä½ï¼ˆ0.1â†’0.02ï¼‰
- ç»“åˆautovacuum_vacuum_thresholdä½¿ç”¨

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- å…¨å±€è®¾ç½®
ALTER SYSTEM SET autovacuum_vacuum_scale_factor = 0.1;

-- è¡¨çº§è®¾ç½®ï¼ˆå¤§è¡¨ï¼‰
ALTER TABLE large_table SET (
    autovacuum_vacuum_scale_factor = 0.02
);
```

#### 5.6.2 autovacuum_max_workers

**é…ç½®åŸåˆ™**ï¼š

- æ§åˆ¶å¹¶å‘autovacuumè¿›ç¨‹æ•°
- å¸¸è§é…ç½®ï¼š3-6
- æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
ALTER SYSTEM SET autovacuum_max_workers = 4;
```

## å…­ã€æŸ¥è¯¢ä¼˜åŒ–

### 6.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

#### 6.1.1 EXPLAINåˆ†æ

**åŸºæœ¬ç”¨æ³•**ï¼š

```sql
-- åŸºæœ¬æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE id = 123;

-- è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å«å®é™…æ‰§è¡Œæ—¶é—´ï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM users WHERE email = 'user@example.com';

-- æ ¼å¼åŒ–è¾“å‡º
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON)
SELECT * FROM orders WHERE user_id = 123;
```

**å…³é”®æŒ‡æ ‡**ï¼š

- **æ‰§è¡Œæ—¶é—´**ï¼šactual time
- **è¡Œæ•°**ï¼šrows vs actual rows
- **ç¼“å†²åŒºå‘½ä¸­ç‡**ï¼šshared hit vs shared read
- **å¹¶è¡Œåº¦**ï¼šWorkers Launched

#### 6.1.2 è®¡åˆ’é—®é¢˜è¯†åˆ«

**å¸¸è§é—®é¢˜**ï¼š

1. **é¡ºåºæ‰«æè¿‡å¤š**ï¼šç¼ºå°‘ç´¢å¼•æˆ–ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®
2. **åŸºæ•°ä¼°ç®—é”™è¯¯**ï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æœŸæˆ–ä¸å‡†ç¡®
3. **å¹¶è¡Œåº¦ä¸è¶³**ï¼šmax_parallel_workersè®¾ç½®ä¸å½“
4. **åµŒå¥—å¾ªç¯æ•ˆç‡ä½**ï¼šè¿æ¥é¡ºåºä¸å½“

### 6.2 ç´¢å¼•ä¼˜åŒ–

#### 6.2.1 ç´¢å¼•ç±»å‹é€‰æ‹©

**ç´¢å¼•ç±»å‹å¯¹æ¯”**ï¼š

| ç´¢å¼•ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------|---------|------|
| B-tree | ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ | é€šç”¨ï¼Œé»˜è®¤ç´¢å¼• |
| Hash | ç­‰å€¼æŸ¥è¯¢ | å¿«é€Ÿï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ |
| GiST | å…¨æ–‡æœç´¢ã€ç©ºé—´æ•°æ® | é€šç”¨æœç´¢æ ‘ |
| GIN | å…¨æ–‡æœç´¢ã€æ•°ç»„ | å€’æ’ç´¢å¼• |
| BRIN | å¤§è¡¨ã€æœ‰åºæ•°æ® | å—èŒƒå›´ç´¢å¼•ï¼Œç©ºé—´å° |
| SP-GiST | éå¹³è¡¡æ•°æ®ç»“æ„ | ç©ºé—´åˆ†åŒºæœç´¢æ ‘ |

#### 6.2.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**è¦†ç›–ç´¢å¼•**ï¼š

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_orders_covering ON orders (user_id, created_at)
INCLUDE (total, status);

-- æŸ¥è¯¢å¯ä»¥ç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®ï¼Œæ— éœ€å›è¡¨
SELECT user_id, created_at, total, status
FROM orders
WHERE user_id = 123;
```

**è¡¨è¾¾å¼ç´¢å¼•**ï¼š

```sql
-- åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users (lower(email));

-- æŸ¥è¯¢å¿…é¡»ä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼
SELECT * FROM users WHERE lower(email) = 'user@example.com';
```

**éƒ¨åˆ†ç´¢å¼•**ï¼š

```sql
-- åªç´¢å¼•æ´»è·ƒæ•°æ®
CREATE INDEX idx_orders_active ON orders (user_id, created_at)
WHERE status = 'active';
```

#### 6.2.3 ç´¢å¼•ç»´æŠ¤

**ç´¢å¼•è†¨èƒ€æ£€æŸ¥**ï¼š

```sql
-- æ£€æŸ¥ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

**é‡å»ºç´¢å¼•**ï¼š

```sql
-- å¹¶å‘é‡å»ºç´¢å¼•ï¼ˆä¸é˜»å¡æŸ¥è¯¢ï¼‰
REINDEX TABLE CONCURRENTLY orders;

-- é‡å»ºç‰¹å®šç´¢å¼•
REINDEX INDEX CONCURRENTLY idx_orders_user_id;
```

### 6.3 ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

#### 6.3.1 ç»Ÿè®¡ç›®æ ‡è°ƒæ•´

**é»˜è®¤ç»Ÿè®¡ç›®æ ‡**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰ç»Ÿè®¡ç›®æ ‡
SELECT attname, attstattarget
FROM pg_attribute
WHERE attrelid = 'users'::regclass
  AND attnum > 0;

-- æé«˜ç»Ÿè®¡ç›®æ ‡ï¼ˆæ›´å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯ï¼‰
ALTER TABLE users ALTER COLUMN email SET STATISTICS 1000;
ANALYZE users;
```

#### 6.3.2 æ‰©å±•ç»Ÿè®¡

**å¤šåˆ—ç»Ÿè®¡**ï¼š

```sql
-- åˆ›å»ºå¤šåˆ—ç»Ÿè®¡ï¼ˆæ£€æµ‹åˆ—é—´ç›¸å…³æ€§ï¼‰
CREATE STATISTICS stats_user_email_name (dependencies)
ON email, name FROM users;

ANALYZE users;
```

**è¡¨è¾¾å¼ç»Ÿè®¡**ï¼š

```sql
-- åˆ›å»ºè¡¨è¾¾å¼ç»Ÿè®¡
CREATE STATISTICS stats_user_lower_email (dependencies)
ON lower(email) FROM users;

ANALYZE users;
```

### 6.4 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

#### 6.4.1 å¹¶è¡Œå‚æ•°é…ç½®

```sql
-- å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 16;

-- å¹¶è¡Œæˆæœ¬é˜ˆå€¼
ALTER SYSTEM SET parallel_setup_cost = 1000;
ALTER SYSTEM SET parallel_tuple_cost = 0.01;
```

#### 6.4.2 å¹¶è¡ŒæŸ¥è¯¢æ¡ä»¶

**å¯å¹¶è¡ŒåŒ–çš„æ“ä½œ**ï¼š

- é¡ºåºæ‰«æ
- ç´¢å¼•æ‰«æ
- è¿æ¥æ“ä½œ
- èšåˆæ“ä½œ

**ä¸å¯å¹¶è¡ŒåŒ–çš„æ“ä½œ**ï¼š

- å†™æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰
- æ•°æ®ä¿®æ”¹å‡½æ•°
- éå¹¶è¡Œå®‰å…¨å‡½æ•°

## ä¸ƒã€å­˜å‚¨ä¸è¡¨è®¾è®¡ä¼˜åŒ–

### 7.1 è¡¨è®¾è®¡ä¼˜åŒ–

#### 7.1.1 fillfactor

**é…ç½®åŸåˆ™**ï¼š

- å†™å¤šè¡¨ï¼šé™ä½fillfactorï¼ˆ80-90ï¼‰å‡å°‘é¡µåˆ†è£‚
- è¯»å¤šè¡¨ï¼šæé«˜fillfactorï¼ˆ100ï¼‰æé«˜ç©ºé—´åˆ©ç”¨

**é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- å†™å¤šè¡¨
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID,
    total DECIMAL(10,2)
) WITH (fillfactor = 85);

-- è¯»å¤šè¡¨
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name TEXT,
    price DECIMAL(10,2)
) WITH (fillfactor = 100);
```

#### 7.1.2 TOASTä¸å‹ç¼©

**TOASTï¼ˆThe Oversized-Attribute Storage Techniqueï¼‰**ï¼š

- PostgreSQLè‡ªåŠ¨å¤„ç†å¤§å­—æ®µ
- è¶…è¿‡2KBçš„å­—æ®µè‡ªåŠ¨TOAST

**å‹ç¼©é…ç½®**ï¼š

```sql
-- PostgreSQL 15+æ”¯æŒLZ4/ZSTDå‹ç¼©
-- éœ€è¦åœ¨ç¼–è¯‘æ—¶å¯ç”¨
-- åˆ›å»ºè¡¨æ—¶æŒ‡å®šå‹ç¼©
CREATE TABLE large_data (
    id BIGSERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'lz4');
```

### 7.2 åˆ†åŒºç­–ç•¥

#### 7.2.1 æ—¶é—´åˆ†åŒº

**æŒ‰æœˆåˆ†åŒºç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE events (
    event_id BIGSERIAL,
    event_time TIMESTAMPTZ NOT NULL,
    event_data JSONB
) PARTITION BY RANGE (event_time);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE events_2025_01 PARTITION OF events
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE events_2025_02 PARTITION OF events
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

#### 7.2.2 èŒƒå›´åˆ†åŒº

**æŒ‰IDèŒƒå›´åˆ†åŒº**ï¼š

```sql
CREATE TABLE users (
    user_id BIGINT,
    name TEXT
) PARTITION BY RANGE (user_id);

CREATE TABLE users_0_1000000 PARTITION OF users
FOR VALUES FROM (0) TO (1000000);
```

### 7.3 ç´¢å¼•è®¾è®¡

#### 7.3.1 ç´¢å¼•é€‰æ‹©åŸåˆ™

1. **ä¸»é”®ç´¢å¼•**ï¼šè‡ªåŠ¨åˆ›å»ºï¼Œé€šå¸¸ä¸éœ€è¦é¢å¤–ä¼˜åŒ–
2. **å¤–é”®ç´¢å¼•**ï¼šå»ºè®®åˆ›å»ºï¼Œæé«˜è¿æ¥æ€§èƒ½
3. **æŸ¥è¯¢ç´¢å¼•**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
4. **å¤åˆç´¢å¼•**ï¼šè€ƒè™‘åˆ—é¡ºåºå’ŒæŸ¥è¯¢æ¨¡å¼

#### 7.3.2 ç´¢å¼•ç»´æŠ¤

**å®šæœŸé‡å»ºç´¢å¼•**ï¼š

```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;
```

## å…«ã€PostgreSQL 18ä¼˜åŒ–

### 8.1 å¼‚æ­¥I/Oä¼˜åŒ–

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡I/Oæ€§èƒ½ã€‚

**é…ç½®**ï¼š

```sql
-- å¯ç”¨å¼‚æ­¥I/Oï¼ˆPostgreSQL 18è‡ªåŠ¨å¯ç”¨ï¼‰
-- æ— éœ€é¢å¤–é…ç½®ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¼˜åŒ–

-- æ£€æŸ¥å¼‚æ­¥I/OçŠ¶æ€
SELECT * FROM pg_stat_io;
```

**æ€§èƒ½æå‡**ï¼š

- å‘é‡ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡40%+
- å¤§è§„æ¨¡æŸ¥è¯¢I/Oæ€§èƒ½æå‡2-3å€
- æ›´å¥½çš„å¹¶å‘å¤„ç†èƒ½åŠ›

### 8.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

**è™šæ‹Ÿç”Ÿæˆåˆ—**å¯ä»¥ä¼˜åŒ–è®¡ç®—å¯†é›†å‹æŸ¥è¯¢ã€‚

**ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºè™šæ‹Ÿç”Ÿæˆåˆ—
CREATE TABLE products (
    id UUID PRIMARY KEY,
    price DECIMAL(10,2),
    discount_rate FLOAT,
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æœ€ç»ˆä»·æ ¼
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (
        price * (1 - discount_rate)
    ) STORED
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON products (final_price);

-- æŸ¥è¯¢æ—¶ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é‡å¤è®¡ç®—
SELECT id, final_price
FROM products
WHERE final_price > 100;
```

**ä¼˜åŠ¿**ï¼š

- æŸ¥è¯¢æ€§èƒ½æå‡15-25%
- æ”¯æŒç´¢å¼•ä¼˜åŒ–
- å‡å°‘é‡å¤è®¡ç®—

### 8.3 å¹¶è¡ŒæŸ¥è¯¢å¢å¼º

PostgreSQL 18ä¼˜åŒ–äº†å¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œã€‚

**æ”¹è¿›**ï¼š

- æ›´æ™ºèƒ½çš„å¹¶è¡Œæ‰§è¡Œè®¡åˆ’
- æ›´å¥½çš„å¹¶è¡Œåº¦é€‰æ‹©
- å‡å°‘å¹¶è¡Œå¼€é”€

**é…ç½®**ï¼š

```sql
-- è°ƒæ•´å¹¶è¡Œå‚æ•°
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 16;
```

## ä¹ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 9.1 å·¥ä½œè´Ÿè½½é…ç½®å¯¹æ¯”

| å‚æ•° | OLTP | OLAP | æ··åˆè´Ÿè½½ |
|------|------|------|---------|
| max_connections | 100-200 | 50-100 | 150 |
| shared_buffers | 20-30%å†…å­˜ | 30-40%å†…å­˜ | 25%å†…å­˜ |
| work_mem | 8-32MB | 64-512MB | 32-128MB |
| max_parallel_workers | 2-4 | 4-8 | 4 |
| JIT | å…³é—­ | å¼€å¯ | å…³é—­ï¼ˆä¸»åº“ï¼‰ |
| synchronous_commit | on | off | onï¼ˆä¸»åº“ï¼‰ |

### 9.2 å‚æ•°è°ƒä¼˜å¯¹æ¯”

| å‚æ•° | ä½é…ç½® | ä¸­é…ç½® | é«˜é…ç½® |
|------|--------|--------|--------|
| shared_buffers | 1GB | 8GB | 32GB |
| work_mem | 4MB | 16MB | 256MB |
| max_connections | 50 | 200 | 500 |
| max_parallel_workers | 2 | 4 | 8 |

## åäºŒã€éªŒè¯ä¸å›å½’

### 12.1 æ€§èƒ½éªŒè¯

**åŸºå‡†æŒ‡æ ‡**ï¼š

- **ååé‡**ï¼šTPSã€QPS
- **å»¶è¿Ÿ**ï¼šP50ã€P95ã€P99
- **èµ„æºä½¿ç”¨**ï¼šCPUã€å†…å­˜ã€I/Oä½¿ç”¨ç‡
- **ç³»ç»ŸæŒ‡æ ‡**ï¼šé˜Ÿåˆ—é•¿åº¦ã€å‘½ä¸­ç‡ã€WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹é¢‘ç‡

**éªŒè¯æ–¹æ³•**ï¼š

```sql
-- æ€§èƒ½åŸºå‡†æµ‹è¯•
SELECT
    NOW() AS test_time,
    (SELECT count(*) FROM pg_stat_statements) AS query_count,
    (SELECT sum(calls) FROM pg_stat_statements) AS total_calls,
    (SELECT avg(mean_exec_time) FROM pg_stat_statements) AS avg_time;
```

### 12.2 å›å½’æµ‹è¯•

**å¯¹æ¯”æ–¹æ³•**ï¼š

- è°ƒä¼˜å‰å30-60åˆ†é’Ÿç¨³å®šçª—å£å¯¹æ¯”
- ä¸šåŠ¡ä½å³°ç°åº¦5-10%æµé‡æµ‹è¯•
- A/Bæµ‹è¯•å¯¹æ¯”

**å›æ»šè§¦å‘æ¡ä»¶**ï¼š

- P95å»¶è¿Ÿæ¶åŒ–>10%
- é”™è¯¯ç‡å‡é«˜
- é”å†²çªä¸Šå‡
- ç³»ç»Ÿè´Ÿè½½å¼‚å¸¸

### 12.3 ç›‘æ§å‘Šè­¦

**å‘Šè­¦é…ç½®**ï¼š

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW performance_metrics AS
SELECT
    NOW() AS timestamp,
    (SELECT count(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT sum(blks_hit)::float / NULLIF(sum(blks_hit) + sum(blks_read), 0) * 100
     FROM pg_stat_database) AS cache_hit_ratio,
    (SELECT avg(mean_exec_time) FROM pg_stat_statements) AS avg_query_time;
```

## åä¸‰ã€æœ€ä½³å®è·µ

### 13.1 è°ƒä¼˜æœ€ä½³å®è·µ

1. **å»ºç«‹åŸºçº¿**ï¼šè®°å½•è°ƒä¼˜å‰çš„æ€§èƒ½æŒ‡æ ‡
2. **å•å˜é‡å˜æ›´**ï¼šæ¯æ¬¡åªå˜æ›´ä¸€ä¸ªæˆ–å°‘é‡ç›¸å…³å‚æ•°
3. **å……åˆ†æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
4. **ç°åº¦å‘å¸ƒ**ï¼šç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ
5. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®åˆç†çš„ç›‘æ§å‘Šè­¦
6. **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•è°ƒä¼˜è¿‡ç¨‹å’Œç»“æœ

### 13.2 é¿å…å¸¸è§é”™è¯¯

**å¸¸è§é”™è¯¯**ï¼š

1. **è¿‡åº¦è°ƒä¼˜**ï¼šè¿‡åº¦ä¼˜åŒ–å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
2. **å¿½ç•¥åŸºçº¿**ï¼šæ²¡æœ‰å»ºç«‹æ€§èƒ½åŸºçº¿
3. **æ‰¹é‡å˜æ›´**ï¼šåŒæ—¶å˜æ›´å¤šä¸ªå‚æ•°
4. **ç¼ºä¹æµ‹è¯•**ï¼šæœªå……åˆ†æµ‹è¯•å°±ä¸Šçº¿
5. **å¿½ç•¥ç›‘æ§**ï¼šæ²¡æœ‰è®¾ç½®ç›‘æ§å‘Šè­¦

## åå››ã€å‚è€ƒèµ„æº

### 14.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://www.postgresql.org/docs/current/performance-tips.html)
- [PostgreSQLé…ç½®å‚æ•°](https://www.postgresql.org/docs/current/runtime-config.html)
- [pg_stat_statementsæ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [EXPLAINæ–‡æ¡£](https://www.postgresql.org/docs/current/sql-explain.html)

### 14.2 ç›¸å…³æ–‡æ¡£

- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.03-æ‰§è¡Œè®¡åˆ’/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æŸ¥è¯¢ä¼˜åŒ–
- [ç›‘æ§ä¸è¯Šæ–­](./04.04-ç›‘æ§ä¸è¯Šæ–­.md) - æ€§èƒ½ç›‘æ§
- [å‘é‡æœç´¢](../07-å¤šæ¨¡å‹æ•°æ®åº“/README.md) - å‘é‡æ£€ç´¢ä¼˜åŒ–
- [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - ä¼˜åŒ–å™¨åŸç†

---

## åäº”ã€å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/performance-tips.html)
3. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [é…ç½®å‚æ•°](https://www.postgresql.org/docs/current/runtime-config.html)
4. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
5. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html)
6. TimescaleDB - [æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](https://docs.timescale.com/timescaledb/latest/how-to-guides/performance/)
7. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: Data Science Team

## 12. PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

### å¼‚æ­¥ I/O ä¼˜åŒ–

PostgreSQL 18 çš„å¼‚æ­¥ I/O å­ç³»ç»Ÿå¯ä»¥æ˜¾è‘—æå‡I/Oå¯†é›†å‹æ“ä½œçš„æ€§èƒ½ï¼š

```sql
-- PostgreSQL 18: å¼‚æ­¥ I/O è‡ªåŠ¨å¯ç”¨
-- æ— éœ€é¢å¤–é…ç½®ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¼˜åŒ–I/Oæ“ä½œ
-- ç‰¹åˆ«é€‚ç”¨äºï¼š
-- - å¤§è§„æ¨¡å‘é‡æ£€ç´¢
-- - æ‰¹é‡æ•°æ®å¯¼å…¥
-- - å¹¶è¡ŒæŸ¥è¯¢
```

**æ€§èƒ½æå‡**:

- å‘é‡ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡ 40%+
- å¤§è§„æ¨¡æŸ¥è¯¢I/Oæ€§èƒ½æå‡ 2-3å€
- æ›´å¥½çš„å¹¶å‘å¤„ç†èƒ½åŠ›

### è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

PostgreSQL 18 çš„è™šæ‹Ÿç”Ÿæˆåˆ—å¯ä»¥ä¼˜åŒ–è®¡ç®—å¯†é›†å‹æŸ¥è¯¢ï¼š

```sql
-- PostgreSQL 18: ä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–æŸ¥è¯¢
CREATE TABLE products (
    id UUID PRIMARY KEY,
    price DECIMAL(10,2),
    discount_rate FLOAT,
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æœ€ç»ˆä»·æ ¼
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (
        price * (1 - discount_rate)
    ) STORED
);

-- æŸ¥è¯¢æ—¶ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é‡å¤è®¡ç®—
SELECT id, final_price FROM products WHERE final_price > 100;
```

**ä¼˜åŠ¿**:

- æŸ¥è¯¢æ€§èƒ½æå‡ 15-25%
- æ”¯æŒç´¢å¼•ä¼˜åŒ–
- å‡å°‘é‡å¤è®¡ç®—

---

## 13. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: OLTPç³»ç»Ÿè°ƒä¼˜

**åœºæ™¯**: ç”µå•†è®¢å•ç³»ç»Ÿï¼Œé«˜å¹¶å‘å†™å…¥ï¼Œä½å»¶è¿ŸæŸ¥è¯¢

**è°ƒä¼˜æ–¹æ¡ˆ**:

```sql
-- è¿æ¥æ± é…ç½®
-- pgbouncer transactionæ¨¡å¼
max_client_conn = 1000
default_pool_size = 25

-- PostgreSQLå‚æ•°
max_connections = 200
shared_buffers = 8GB  -- 25% of 32GB RAM
work_mem = 16MB
effective_cache_size = 24GB
random_page_cost = 1.1  -- SSD
effective_io_concurrency = 200  -- NVMe

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_orders_user_created
ON orders(user_id, created_at DESC);
```

**æ•ˆæœ**: QPSæå‡40%ï¼ŒP99å»¶è¿Ÿé™ä½30%

### æ¡ˆä¾‹2: OLAPåˆ†æç³»ç»Ÿè°ƒä¼˜

**åœºæ™¯**: æ•°æ®ä»“åº“ï¼Œå¤æ‚èšåˆæŸ¥è¯¢ï¼Œæ‰¹é‡åˆ†æ

**è°ƒä¼˜æ–¹æ¡ˆ**:

```sql
-- PostgreSQLå‚æ•°
max_parallel_workers_per_gather = 4
max_parallel_workers = 16
work_mem = 256MB
shared_buffers = 16GB
effective_cache_size = 48GB
jit = on
jit_above_cost = 200000

-- åˆ†åŒºè¡¨ä¼˜åŒ–
CREATE TABLE sales (
    sale_date DATE,
    product_id INT,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE sales_2025_01 PARTITION OF sales
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**æ•ˆæœ**: å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡60%ï¼Œå¹¶è¡Œåˆ©ç”¨ç‡æå‡50%

### æ¡ˆä¾‹3: æ··åˆè´Ÿè½½è°ƒä¼˜

**åœºæ™¯**: è¯»å†™æ··åˆï¼Œéœ€è¦å¹³è¡¡OLTPå’ŒOLAPæ€§èƒ½

**è°ƒä¼˜æ–¹æ¡ˆ**:

```sql
-- è¯»å†™åˆ†ç¦»
-- ä¸»åº“ï¼ˆOLTPï¼‰
max_connections = 200
work_mem = 16MB
shared_buffers = 8GB
jit = off

-- åªè¯»å‰¯æœ¬ï¼ˆOLAPï¼‰
max_connections = 100
work_mem = 256MB
shared_buffers = 16GB
jit = on
max_parallel_workers_per_gather = 4
```

**æ•ˆæœ**: OLTPå»¶è¿Ÿç¨³å®šï¼ŒOLAPæŸ¥è¯¢æ€§èƒ½æå‡50%

---

## 14. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

- ğŸ“Š [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.03-æ‰§è¡Œè®¡åˆ’/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æŸ¥è¯¢ä¼˜åŒ–
- ğŸ” [ç›‘æ§ä¸è¯Šæ–­](./04.04-ç›‘æ§ä¸è¯Šæ–­.md) - æ€§èƒ½ç›‘æ§
- ğŸ“ˆ [å‘é‡æœç´¢](../07-å¤šæ¨¡å‹æ•°æ®åº“/README.md) - å‘é‡æ£€ç´¢ä¼˜åŒ–
- ğŸ› ï¸ [æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯](../13-é«˜å¯ç”¨æ¶æ„/è¿ç»´æ‰‹å†Œ/01-æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯.md) - å˜æ›´ç®¡ç†

### å¤–éƒ¨èµ„æº

- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://www.postgresql.org/docs/current/performance-tips.html)
- [pg_stat_statementsæ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [PostgreSQLé…ç½®å‚æ•°](https://www.postgresql.org/docs/current/runtime-config.html)

---

## 15. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/performance-tips.html)
3. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [é…ç½®å‚æ•°](https://www.postgresql.org/docs/current/runtime-config.html)
4. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
5. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html)
6. TimescaleDB - [æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](https://docs.timescale.com/timescaledb/latest/how-to-guides/performance/)
7. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
