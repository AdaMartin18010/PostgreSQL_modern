---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\04-éƒ¨ç½²è¿ç»´\04.03-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLäº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å®¹å™¨åŒ–éƒ¨ç½²ã€Kubernetesç¼–æ’ã€äº‘åŸç”Ÿåº”ç”¨ã€å¾®æœåŠ¡æ¶æ„

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLäº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²å®Œæ•´æŒ‡å—](#postgresqläº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 äº‘åŸç”Ÿæ¦‚å¿µ](#11-äº‘åŸç”Ÿæ¦‚å¿µ)
    - [1.2 å®¹å™¨åŒ–ä¼˜åŠ¿](#12-å®¹å™¨åŒ–ä¼˜åŠ¿)
    - [1.3 é€‚ç”¨åœºæ™¯](#13-é€‚ç”¨åœºæ™¯)
  - [äºŒã€Dockerå®¹å™¨åŒ–éƒ¨ç½²](#äºŒdockerå®¹å™¨åŒ–éƒ¨ç½²)
    - [2.1 DockeråŸºç¡€éƒ¨ç½²](#21-dockeråŸºç¡€éƒ¨ç½²)
    - [2.2 Docker Composeéƒ¨ç½²](#22-docker-composeéƒ¨ç½²)
    - [2.3 è‡ªå®šä¹‰é•œåƒæ„å»º](#23-è‡ªå®šä¹‰é•œåƒæ„å»º)
    - [2.4 æ•°æ®æŒä¹…åŒ–](#24-æ•°æ®æŒä¹…åŒ–)
    - [2.5 ç½‘ç»œé…ç½®](#25-ç½‘ç»œé…ç½®)
    - [2.6 å¥åº·æ£€æŸ¥](#26-å¥åº·æ£€æŸ¥)
  - [ä¸‰ã€Kuberneteséƒ¨ç½²](#ä¸‰kuberneteséƒ¨ç½²)
    - [3.1 StatefulSetéƒ¨ç½²](#31-statefulsetéƒ¨ç½²)
    - [3.2 ä½¿ç”¨PostgreSQL Operator](#32-ä½¿ç”¨postgresql-operator)
    - [3.3 Helm Chartéƒ¨ç½²](#33-helm-chartéƒ¨ç½²)
    - [3.4 å­˜å‚¨é…ç½®](#34-å­˜å‚¨é…ç½®)
    - [3.5 æœåŠ¡å‘ç°](#35-æœåŠ¡å‘ç°)
  - [å››ã€é«˜å¯ç”¨é…ç½®](#å››é«˜å¯ç”¨é…ç½®)
    - [4.1 ä¸»ä»å¤åˆ¶](#41-ä¸»ä»å¤åˆ¶)
    - [4.2 Patronié«˜å¯ç”¨](#42-patronié«˜å¯ç”¨)
    - [4.3 è‡ªåŠ¨æ•…éšœè½¬ç§»](#43-è‡ªåŠ¨æ•…éšœè½¬ç§»)
  - [äº”ã€ç›‘æ§ä¸æ—¥å¿—](#äº”ç›‘æ§ä¸æ—¥å¿—)
    - [5.1 Prometheusç›‘æ§](#51-prometheusç›‘æ§)
    - [5.2 æ—¥å¿—æ”¶é›†](#52-æ—¥å¿—æ”¶é›†)
    - [5.3 å‘Šè­¦é…ç½®](#53-å‘Šè­¦é…ç½®)
  - [å…­ã€å¤‡ä»½ä¸æ¢å¤](#å…­å¤‡ä»½ä¸æ¢å¤)
    - [6.1 å®¹å™¨å†…å¤‡ä»½](#61-å®¹å™¨å†…å¤‡ä»½)
    - [6.2 æŒä¹…åŒ–å·å¤‡ä»½](#62-æŒä¹…åŒ–å·å¤‡ä»½)
    - [6.3 è‡ªåŠ¨åŒ–å¤‡ä»½](#63-è‡ªåŠ¨åŒ–å¤‡ä»½)
  - [ä¸ƒã€å®‰å…¨é…ç½®](#ä¸ƒå®‰å…¨é…ç½®)
    - [7.1 é•œåƒå®‰å…¨](#71-é•œåƒå®‰å…¨)
    - [7.2 ç½‘ç»œå®‰å…¨](#72-ç½‘ç»œå®‰å…¨)
    - [7.3 å¯†é’¥ç®¡ç†](#73-å¯†é’¥ç®¡ç†)
  - [å…«ã€æ€§èƒ½ä¼˜åŒ–](#å…«æ€§èƒ½ä¼˜åŒ–)
    - [8.1 èµ„æºé™åˆ¶](#81-èµ„æºé™åˆ¶)
    - [8.2 å­˜å‚¨ä¼˜åŒ–](#82-å­˜å‚¨ä¼˜åŒ–)
    - [8.3 ç½‘ç»œä¼˜åŒ–](#83-ç½‘ç»œä¼˜åŒ–)
  - [ä¹ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¹çŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [9.1 éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”](#91-éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”)
    - [9.2 Operatorå¯¹æ¯”](#92-operatorå¯¹æ¯”)
    - [9.3 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”](#93-å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”)
  - [åã€å®è·µæ¡ˆä¾‹](#åå®è·µæ¡ˆä¾‹)
    - [10.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²](#101-å¼€å‘ç¯å¢ƒéƒ¨ç½²)
    - [10.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#102-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
    - [10.3 å¤šç§Ÿæˆ·éƒ¨ç½²](#103-å¤šç§Ÿæˆ·éƒ¨ç½²)
  - [åä¸€ã€æ•…éšœæ’æŸ¥](#åä¸€æ•…éšœæ’æŸ¥)
    - [11.1 å¸¸è§é—®é¢˜](#111-å¸¸è§é—®é¢˜)
    - [11.2 è¯Šæ–­æ–¹æ³•](#112-è¯Šæ–­æ–¹æ³•)
    - [11.3 è§£å†³æ–¹æ¡ˆ](#113-è§£å†³æ–¹æ¡ˆ)
  - [åäºŒã€æœ€ä½³å®è·µ](#åäºŒæœ€ä½³å®è·µ)
    - [12.1 éƒ¨ç½²æœ€ä½³å®è·µ](#121-éƒ¨ç½²æœ€ä½³å®è·µ)
    - [12.2 å®‰å…¨æœ€ä½³å®è·µ](#122-å®‰å…¨æœ€ä½³å®è·µ)
    - [12.3 è¿ç»´æœ€ä½³å®è·µ](#123-è¿ç»´æœ€ä½³å®è·µ)
  - [åä¸‰ã€å‚è€ƒèµ„æº](#åä¸‰å‚è€ƒèµ„æº)
    - [13.1 å®˜æ–¹æ–‡æ¡£](#131-å®˜æ–¹æ–‡æ¡£)
    - [13.2 ç½‘ç»œèµ„æº](#132-ç½‘ç»œèµ„æº)
    - [13.3 ç›¸å…³æ–‡æ¡£](#133-ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 äº‘åŸç”Ÿæ¦‚å¿µ

äº‘åŸç”Ÿæ˜¯ä¸€ç§æ„å»ºå’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œå……åˆ†åˆ©ç”¨äº‘è®¡ç®—äº¤ä»˜æ¨¡å‹çš„ä¼˜åŠ¿ã€‚PostgreSQLäº‘åŸç”Ÿéƒ¨ç½²åŒ…æ‹¬ï¼š

- **å®¹å™¨åŒ–**ï¼šä½¿ç”¨Dockerç­‰å®¹å™¨æŠ€æœ¯
- **ç¼–æ’**ï¼šä½¿ç”¨Kubernetesç­‰ç¼–æ’å¹³å°
- **å¾®æœåŠ¡**ï¼šæ”¯æŒå¾®æœåŠ¡æ¶æ„
- **è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†
- **å¯è§‚æµ‹æ€§**ï¼šç›‘æ§ã€æ—¥å¿—å’Œè¿½è¸ª

### 1.2 å®¹å™¨åŒ–ä¼˜åŠ¿

**å®¹å™¨åŒ–éƒ¨ç½²çš„ä¼˜åŠ¿**ï¼š

- âœ… **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸€è‡´
- âœ… **å¿«é€Ÿéƒ¨ç½²**ï¼šç§’çº§å¯åŠ¨å’Œåœæ­¢
- âœ… **èµ„æºéš”ç¦»**ï¼šè¿›ç¨‹å’Œèµ„æºéš”ç¦»
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ°´å¹³æ‰©å±•å’Œè‡ªåŠ¨ä¼¸ç¼©
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šè½»æ¾åˆ‡æ¢ç‰ˆæœ¬
- âœ… **ç®€åŒ–è¿ç»´**ï¼šç»Ÿä¸€çš„éƒ¨ç½²å’Œç®¡ç†æ–¹å¼

### 1.3 é€‚ç”¨åœºæ™¯

**å®¹å™¨åŒ–éƒ¨ç½²é€‚ç”¨åœºæ™¯**ï¼š

- **å¾®æœåŠ¡æ¶æ„**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“å®ä¾‹
- **å¼€å‘æµ‹è¯•ç¯å¢ƒ**ï¼šå¿«é€Ÿæ­å»ºå’Œé”€æ¯
- **CI/CDæµæ°´çº¿**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²
- **äº‘åŸç”Ÿåº”ç”¨**ï¼šKubernetesé›†ç¾¤éƒ¨ç½²
- **å¤šç§Ÿæˆ·åº”ç”¨**ï¼šéš”ç¦»çš„æ•°æ®åº“å®ä¾‹

---

## äºŒã€Dockerå®¹å™¨åŒ–éƒ¨ç½²

### 2.1 DockeråŸºç¡€éƒ¨ç½²

**æ‹‰å–PostgreSQLé•œåƒ**ï¼š

```bash
# æ‹‰å–PostgreSQL 18å®˜æ–¹é•œåƒ
docker pull postgres:18

# æŸ¥çœ‹å¯ç”¨æ ‡ç­¾
docker search postgres

# æŸ¥çœ‹é•œåƒä¿¡æ¯
docker inspect postgres:18
```

**è¿è¡ŒPostgreSQLå®¹å™¨**ï¼š

```bash
# åŸºæœ¬è¿è¡Œ
docker run --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  -d postgres:18

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker ps

# æŸ¥çœ‹æ—¥å¿—
docker logs postgres
docker logs -f postgres  # å®æ—¶æŸ¥çœ‹

# åœæ­¢å®¹å™¨
docker stop postgres

# å¯åŠ¨å®¹å™¨
docker start postgres

# åˆ é™¤å®¹å™¨
docker rm postgres
```

**ç¯å¢ƒå˜é‡é…ç½®**ï¼š

```bash
# å®Œæ•´ç¯å¢ƒå˜é‡é…ç½®
docker run --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_DB=mydb \
  -e POSTGRES_INITDB_ARGS="--encoding=UTF8 --locale=zh_CN.UTF-8" \
  -e POSTGRES_HOST_AUTH_METHOD=scram-sha-256 \
  -p 5432:5432 \
  -d postgres:18
```

**å¸¸ç”¨ç¯å¢ƒå˜é‡**ï¼š

- `POSTGRES_PASSWORD`ï¼šPostgreSQLè¶…çº§ç”¨æˆ·å¯†ç ï¼ˆå¿…éœ€ï¼‰
- `POSTGRES_USER`ï¼šPostgreSQLç”¨æˆ·åï¼ˆé»˜è®¤ï¼špostgresï¼‰
- `POSTGRES_DB`ï¼šåˆå§‹æ•°æ®åº“åï¼ˆé»˜è®¤ï¼špostgresï¼‰
- `POSTGRES_INITDB_ARGS`ï¼šinitdbå‚æ•°
- `POSTGRES_HOST_AUTH_METHOD`ï¼šè®¤è¯æ–¹æ³•ï¼ˆmd5/scram-sha-256ï¼‰

### 2.2 Docker Composeéƒ¨ç½²

**åŸºç¡€docker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: mydb
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=zh_CN.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - postgres_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local

networks:
  postgres_network:
    driver: bridge
```

**å®Œæ•´docker-compose.ymlï¼ˆç”Ÿäº§çº§ï¼‰**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-mydb}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=zh_CN.UTF-8 --data-checksums"
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_config:/etc/postgresql
      - ./init:/docker-entrypoint-initdb.d
      - ./backups:/backups
    networks:
      - postgres_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-mydb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # pgAdminï¼ˆå¯é€‰ï¼‰
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - postgres_network
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  postgres_config:
    driver: local
  pgadmin_data:
    driver: local

networks:
  postgres_network:
    driver: bridge
```

**ä½¿ç”¨Docker Compose**ï¼š

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f postgres

# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œå·
docker-compose down -v

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build
```

### 2.3 è‡ªå®šä¹‰é•œåƒæ„å»º

**Dockerfileç¤ºä¾‹**ï¼š

```dockerfile
# åŸºäºPostgreSQL 18å®˜æ–¹é•œåƒ
FROM postgres:18

# è®¾ç½®ç»´æŠ¤è€…
LABEL maintainer="your-email@example.com"

# å®‰è£…é¢å¤–å·¥å…·
RUN apt-get update && \
    apt-get install -y \
    postgresql-contrib-18 \
    postgresql-18-pgvector \
    vim \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY postgresql.conf /etc/postgresql/postgresql.conf
COPY pg_hba.conf /etc/postgresql/pg_hba.conf

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY init-scripts/ /docker-entrypoint-initdb.d/

# è®¾ç½®æƒé™
RUN chmod +x /docker-entrypoint-initdb.d/*.sh

# æš´éœ²ç«¯å£
EXPOSE 5432

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®å¯åŠ¨
CMD ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
```

**æ„å»ºå’Œè¿è¡Œè‡ªå®šä¹‰é•œåƒ**ï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t my-postgres:18 .

# è¿è¡Œè‡ªå®šä¹‰é•œåƒ
docker run --name my-postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -p 5432:5432 \
  -d my-postgres:18

# æ¨é€åˆ°é•œåƒä»“åº“
docker tag my-postgres:18 registry.example.com/my-postgres:18
docker push registry.example.com/my-postgres:18
```

**å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–**ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM postgres:18 AS builder

# å®‰è£…ç¼–è¯‘å·¥å…·
RUN apt-get update && \
    apt-get install -y \
    build-essential \
    postgresql-server-dev-18 \
    && rm -rf /var/lib/apt/lists/*

# ç¼–è¯‘æ‰©å±•
WORKDIR /tmp
RUN git clone https://github.com/pgvector/pgvector.git && \
    cd pgvector && \
    make && \
    make install

# è¿è¡Œé˜¶æ®µ
FROM postgres:18

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ‰©å±•
COPY --from=builder /usr/share/postgresql/18/extension/pgvector* /usr/share/postgresql/18/extension/
COPY --from=builder /usr/lib/postgresql/18/lib/vector.so /usr/lib/postgresql/18/lib/

# å¤åˆ¶é…ç½®å’Œè„šæœ¬
COPY postgresql.conf /etc/postgresql/postgresql.conf
COPY init-scripts/ /docker-entrypoint-initdb.d/

EXPOSE 5432
```

### 2.4 æ•°æ®æŒä¹…åŒ–

**ä½¿ç”¨å‘½åå·ï¼ˆæ¨èï¼‰**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
    driver: local
```

**ä½¿ç”¨ç»‘å®šæŒ‚è½½**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    volumes:
      - ./data:/var/lib/postgresql/data
      - ./config:/etc/postgresql
```

**æ•°æ®å·ç®¡ç†**ï¼š

```bash
# æŸ¥çœ‹æ•°æ®å·
docker volume ls

# æŸ¥çœ‹æ•°æ®å·è¯¦æƒ…
docker volume inspect postgres_data

# å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres_backup.tar.gz /data

# æ¢å¤æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/postgres_backup.tar.gz -C /
```

### 2.5 ç½‘ç»œé…ç½®

**è‡ªå®šä¹‰ç½‘ç»œ**ï¼š

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create postgres_network

# è¿è¡ŒPostgreSQLå®¹å™¨
docker run --name postgres \
  --network postgres_network \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -d postgres:18

# è¿è¡Œåº”ç”¨å®¹å™¨ï¼ˆè¿æ¥åˆ°åŒä¸€ç½‘ç»œï¼‰
docker run --name myapp \
  --network postgres_network \
  -e DATABASE_URL=postgresql://postgres:mysecretpassword@postgres:5432/mydb \
  -d myapp:latest
```

**Docker Composeç½‘ç»œé…ç½®**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    networks:
      - backend

  app:
    image: myapp:latest
    networks:
      - backend
    depends_on:
      - postgres

networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 2.6 å¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥é…ç½®**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d mydb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
```

**è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# healthcheck.sh

set -e

# æ£€æŸ¥PostgreSQLæ˜¯å¦å°±ç»ª
pg_isready -U postgres -d mydb

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
psql -U postgres -d mydb -c "SELECT 1" > /dev/null

# æ£€æŸ¥WALå½’æ¡£ï¼ˆå¦‚æœå¯ç”¨ï¼‰
# pg_archivecheck /path/to/wal

exit 0
```

---

## ä¸‰ã€Kuberneteséƒ¨ç½²

### 3.1 StatefulSetéƒ¨ç½²

**StatefulSeté…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_DB
          value: "mydb"
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi
```

**ConfigMapé…ç½®**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: postgres
data:
  postgresql.conf: |
    # è¿æ¥è®¾ç½®
    listen_addresses = '*'
    port = 5432
    max_connections = 100

    # å†…å­˜è®¾ç½®
    shared_buffers = 256MB
    effective_cache_size = 1GB
    work_mem = 4MB
    maintenance_work_mem = 64MB

    # WALè®¾ç½®
    wal_level = replica
    max_wal_size = 1GB
    min_wal_size = 80MB

    # æ—¥å¿—è®¾ç½®
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d.log'
    log_min_duration_statement = 1000
```

**Secreté…ç½®**ï¼š

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: postgres
type: Opaque
stringData:
  postgres-password: mysecretpassword
  replication-password: replicationpassword
```

**Serviceé…ç½®**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-read
  namespace: postgres
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
```

**éƒ¨ç½²å‘½ä»¤**ï¼š

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace postgres

# åˆ›å»ºSecret
kubectl apply -f postgres-secret.yaml

# åˆ›å»ºConfigMap
kubectl apply -f postgres-configmap.yaml

# åˆ›å»ºStatefulSet
kubectl apply -f postgres-statefulset.yaml

# åˆ›å»ºService
kubectl apply -f postgres-service.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n postgres
kubectl get svc -n postgres
kubectl get pvc -n postgres

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f postgres-0 -n postgres

# è¿æ¥æ•°æ®åº“
kubectl exec -it postgres-0 -n postgres -- psql -U postgres -d mydb
```

### 3.2 ä½¿ç”¨PostgreSQL Operator

**å®‰è£…Crunchy PostgreSQL Operator**ï¼š

```bash
# æ·»åŠ Helmä»“åº“
helm repo add postgres-operator https://opensource.crunchydata.com/postgres-operator
helm repo update

# å®‰è£…Operator
helm install postgres-operator postgres-operator/postgres-operator \
  --namespace postgres-operator \
  --create-namespace \
  --set image.repository=registry.developers.crunchydata.com/crunchydata/postgres-operator \
  --set image.tag=ubi8-5.4.0-0

# éªŒè¯å®‰è£…
kubectl get pods -n postgres-operator
```

**åˆ›å»ºPostgreSQLé›†ç¾¤**ï¼š

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 3
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 2000m
      dataVolumeClaimSpec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
  proxy:
    pgBouncer:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.19-0
      replicas: 2
      resources:
        requests:
          memory: 64Mi
          cpu: 100m
```

**åº”ç”¨é…ç½®**ï¼š

```bash
# åˆ›å»ºé›†ç¾¤
kubectl apply -f postgres-cluster.yaml

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl get postgresclusters -n postgres

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n postgres -l postgres-operator.crunchydata.com/cluster=postgres-cluster

# è·å–è¿æ¥ä¿¡æ¯
kubectl get secrets postgres-cluster-pguser-postgres -n postgres -o jsonpath='{.data.password}' | base64 -d
```

### 3.3 Helm Chartéƒ¨ç½²

**ä½¿ç”¨Bitnami Helm Chart**ï¼š

```bash
# æ·»åŠ Helmä»“åº“
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# å®‰è£…PostgreSQL
helm install postgres bitnami/postgresql \
  --namespace postgres \
  --create-namespace \
  --set auth.postgresPassword=mysecretpassword \
  --set auth.database=mydb \
  --set primary.persistence.size=10Gi \
  --set metrics.enabled=true

# æŸ¥çœ‹çŠ¶æ€
helm list -n postgres
kubectl get pods -n postgres

# è·å–è¿æ¥ä¿¡æ¯
kubectl get secret postgres-postgresql -n postgres -o jsonpath='{.data.postgres-password}' | base64 -d
```

**è‡ªå®šä¹‰values.yaml**ï¼š

```yaml
# values.yaml
auth:
  postgresPassword: mysecretpassword
  database: mydb
  username: myuser
  password: myuserpassword

primary:
  persistence:
    enabled: true
    size: 20Gi
    storageClass: fast-ssd
  resources:
    requests:
      memory: 2Gi
      cpu: 1000m
    limits:
      memory: 4Gi
      cpu: 2000m

readReplicas:
  replicaCount: 2
  persistence:
    enabled: true
    size: 20Gi

metrics:
  enabled: true
  serviceMonitor:
    enabled: true

postgresql:
  shared_buffers: 256MB
  effective_cache_size: 1GB
  work_mem: 4MB
```

**ä½¿ç”¨è‡ªå®šä¹‰valueséƒ¨ç½²**ï¼š

```bash
helm install postgres bitnami/postgresql \
  --namespace postgres \
  --create-namespace \
  -f values.yaml
```

### 3.4 å­˜å‚¨é…ç½®

**StorageClassé…ç½®**ï¼š

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  fsType: ext4
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

**PersistentVolumeClaimé…ç½®**ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: postgres
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
```

**å­˜å‚¨æ‰©å±•**ï¼š

```bash
# æ‰©å±•PVC
kubectl patch pvc postgres-pvc -n postgres -p '{"spec":{"resources":{"requests":{"storage":"100Gi"}}}}'

# åœ¨PostgreSQLä¸­æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
kubectl exec -it postgres-0 -n postgres -- psql -U postgres -c "SELECT pg_size_pretty(pg_database_size('mydb'));"
```

### 3.5 æœåŠ¡å‘ç°

**Headless Service**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
```

**DNSæœåŠ¡å‘ç°**ï¼š

```bash
# åœ¨Podä¸­é€šè¿‡DNSè®¿é—®
# postgres-0.postgres-headless.postgres.svc.cluster.local

# åº”ç”¨è¿æ¥ç¤ºä¾‹
DATABASE_URL=postgresql://postgres:password@postgres-headless.postgres.svc.cluster.local:5432/mydb
```

---

## å››ã€é«˜å¯ç”¨é…ç½®

### 4.1 ä¸»ä»å¤åˆ¶

**ä¸»åº“é…ç½®ï¼ˆStatefulSetï¼‰**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-primary
  namespace: postgres
spec:
  serviceName: postgres-primary
  replicas: 1
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_REPLICATION_USER
          value: replicator
        - name: POSTGRES_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        volumeMounts:
        - name: postgres-config
          mountPath: /etc/postgresql
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-primary-config
```

**ä¸»åº“ConfigMap**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-primary-config
  namespace: postgres
data:
  postgresql.conf: |
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_size = 1GB
  pg_hba.conf: |
    host replication replicator 0.0.0.0/0 scram-sha-256
```

**ä»åº“é…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-replica
  namespace: postgres
spec:
  serviceName: postgres-replica
  replicas: 2
  template:
    spec:
      initContainers:
      - name: init-replica
        image: postgres:18
        command:
        - /bin/bash
        - -c
        - |
          pg_basebackup -h postgres-primary.postgres.svc.cluster.local \
            -U replicator \
            -D /var/lib/postgresql/data \
            -X stream \
            -R \
            -C \
            -S replica-$(hostname)
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
      containers:
      - name: postgres
        image: postgres:18
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 4.2 Patronié«˜å¯ç”¨

**Patroni ConfigMap**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: patroni-config
  namespace: postgres
data:
  patroni.yml: |
    scope: postgres
    namespace: /service/postgres
    name: ${POD_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${POD_IP}:8008

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 30
        maximum_lag_on_failover: 1048576
        postgresql:
          use_pg_rewind: true
          parameters:
            wal_level: replica
            hot_standby: on
            max_connections: 100
            max_wal_senders: 10
            max_replication_slots: 10
            wal_keep_size: 1GB

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${POD_IP}:5432
      data_dir: /var/lib/postgresql/data/pgdata
      pgpass: /tmp/pgpass
      authentication:
        replication:
          username: replicator
          password: ${REPLICATION_PASSWORD}
        superuser:
          username: postgres
          password: ${POSTGRES_PASSWORD}
      parameters:
        unix_socket_directories: '/var/run/postgresql'

    consul:
      host: consul.postgres.svc.cluster.local:8500
```

**Patroni StatefulSet**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: patroni
  namespace: postgres
spec:
  serviceName: patroni
  replicas: 3
  selector:
    matchLabels:
      app: patroni
  template:
    metadata:
      labels:
        app: patroni
    spec:
      containers:
      - name: patroni
        image: patroni/patroni:latest
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        volumeMounts:
        - name: patroni-config
          mountPath: /etc/patroni
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: patroni-config
        configMap:
          name: patroni-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 4.3 è‡ªåŠ¨æ•…éšœè½¬ç§»

**æ•…éšœè½¬ç§»é…ç½®**ï¼š

```yaml
# Patroniæ•…éšœè½¬ç§»é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: patroni-config
data:
  patroni.yml: |
    dcs:
      ttl: 30
      loop_wait: 10
      retry_timeout: 30
      maximum_lag_on_failover: 1048576
      master_start_timeout: 300
      synchronous_mode: false
      synchronous_mode_strict: false
      synchronous_node_count: 1
```

**æµ‹è¯•æ•…éšœè½¬ç§»**ï¼š

```bash
# æŸ¥çœ‹å½“å‰ä¸»èŠ‚ç‚¹
kubectl exec -it patroni-0 -n postgres -- patronictl list

# æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœ
kubectl delete pod patroni-0 -n postgres

# è§‚å¯Ÿæ•…éšœè½¬ç§»
kubectl exec -it patroni-1 -n postgres -- patronictl list
```

---

## äº”ã€ç›‘æ§ä¸æ—¥å¿—

### 5.1 Prometheusç›‘æ§

**PostgreSQL Exporteréƒ¨ç½²**ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-exporter
  namespace: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-exporter
  template:
    metadata:
      labels:
        app: postgres-exporter
    spec:
      containers:
      - name: postgres-exporter
        image: prometheuscommunity/postgres-exporter:latest
        env:
        - name: DATA_SOURCE_NAME
          value: "postgresql://postgres:password@postgres.postgres.svc.cluster.local:5432/mydb?sslmode=disable"
        ports:
        - containerPort: 9187
          name: metrics
```

**ServiceMonitoré…ç½®**ï¼š

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-exporter
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres-exporter
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### 5.2 æ—¥å¿—æ”¶é›†

**Fluentdæ—¥å¿—æ”¶é›†**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: postgres
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/postgresql/*.log
      pos_file /var/log/fluentd-postgres.log.pos
      tag postgres.log
      <parse>
        @type none
      </parse>
    </source>

    <match postgres.log>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name postgres
      type_name _doc
    </match>
```

### 5.3 å‘Šè­¦é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-alerts
  namespace: postgres
spec:
  groups:
  - name: postgres
    rules:
    - alert: PostgresDown
      expr: pg_up == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL instance is down"

    - alert: PostgresTooManyConnections
      expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL has too many connections"

    - alert: PostgresSlowQueries
      expr: rate(pg_stat_statements_mean_exec_time[5m]) > 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL has slow queries"
```

---

## å…­ã€å¤‡ä»½ä¸æ¢å¤

### 6.1 å®¹å™¨å†…å¤‡ä»½

**CronJobå¤‡ä»½**ï¼š

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: postgres
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: postgres-backup
            image: postgres:18
            command:
            - /bin/bash
            - -c
            - |
              pg_dump -h postgres.postgres.svc.cluster.local \
                -U postgres \
                -d mydb \
                -F c \
                -f /backup/mydb_$(date +%Y%m%d_%H%M%S).dump
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: postgres-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
          restartPolicy: OnFailure
```

### 6.2 æŒä¹…åŒ–å·å¤‡ä»½

**å·å¿«ç…§å¤‡ä»½**ï¼š

```yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: postgres-snapshot
  namespace: postgres
spec:
  source:
    persistentVolumeClaimName: postgres-storage-postgres-0
  volumeSnapshotClassName: csi-snapshotter
```

### 6.3 è‡ªåŠ¨åŒ–å¤‡ä»½

**ä½¿ç”¨pgBackRest**ï¼š

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pgbackrest-backup
  namespace: postgres
spec:
  schedule: "0 */6 * * *"  # æ¯6å°æ—¶
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: pgbackrest
            image: pgbackrest/pgbackrest:latest
            command:
            - pgbackrest
            - --stanza=postgres
            - backup
            - --type=incr
            volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: postgres-storage
            persistentVolumeClaim:
              claimName: postgres-storage-postgres-0
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
          restartPolicy: OnFailure
```

---

## ä¸ƒã€å®‰å…¨é…ç½®

### 7.1 é•œåƒå®‰å…¨

**ä½¿ç”¨å®˜æ–¹é•œåƒ**ï¼š

```bash
# ä½¿ç”¨å®˜æ–¹PostgreSQLé•œåƒ
image: postgres:18

# é¿å…ä½¿ç”¨latestæ ‡ç­¾
image: postgres:18.0

# å®šæœŸæ›´æ–°é•œåƒ
docker pull postgres:18
```

**é•œåƒæ‰«æ**ï¼š

```bash
# ä½¿ç”¨Trivyæ‰«æé•œåƒ
trivy image postgres:18

# ä½¿ç”¨Snykæ‰«æ
snyk test --docker postgres:18
```

### 7.2 ç½‘ç»œå®‰å…¨

**NetworkPolicyé…ç½®**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: postgres
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: app-namespace
    ports:
    - protocol: TCP
      port: 5432
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: app-namespace
    ports:
    - protocol: TCP
      port: 5432
```

### 7.3 å¯†é’¥ç®¡ç†

**ä½¿ç”¨Sealed Secrets**ï¼š

```bash
# å®‰è£…Sealed Secrets
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# åˆ›å»ºSealed Secret
kubectl create secret generic postgres-secret \
  --from-literal=postgres-password=mysecretpassword \
  --dry-run=client -o yaml | \
  kubectl seal -o yaml > postgres-sealed-secret.yaml
```

**ä½¿ç”¨External Secrets Operator**ï¼š

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-secret
  namespace: postgres
spec:
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: postgres-secret
  data:
  - secretKey: postgres-password
    remoteRef:
      key: postgres/credentials
      property: password
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 èµ„æºé™åˆ¶

**èµ„æºè¯·æ±‚å’Œé™åˆ¶**ï¼š

```yaml
resources:
  requests:
    memory: "2Gi"
    cpu: "1000m"
  limits:
    memory: "4Gi"
    cpu: "2000m"
```

**HPAè‡ªåŠ¨ä¼¸ç¼©**ï¼š

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
  namespace: postgres
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 8.2 å­˜å‚¨ä¼˜åŒ–

**ä½¿ç”¨æœ¬åœ°SSD**ï¼š

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-ssd
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
```

**å­˜å‚¨æ€§èƒ½ä¼˜åŒ–**ï¼š

```yaml
# ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ç±»
storageClassName: fast-ssd

# å¯ç”¨å­˜å‚¨æ‰©å±•
allowVolumeExpansion: true
```

### 8.3 ç½‘ç»œä¼˜åŒ–

**ä½¿ç”¨Service Mesh**ï¼š

```yaml
# Istio VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: postgres
  namespace: postgres
spec:
  hosts:
  - postgres.postgres.svc.cluster.local
  tcp:
  - match:
    - port: 5432
    route:
    - destination:
        host: postgres.postgres.svc.cluster.local
        port:
          number: 5432
```

---

## ä¹ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 9.1 éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | è‡ªåŠ¨åŒ–ç¨‹åº¦ | é«˜å¯ç”¨ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|------|--------|-----------|--------|---------|--------|
| **Dockerå•å®¹å™¨** | â­ | â­â­ | â­ | å¼€å‘æµ‹è¯• | â­â­â­ |
| **Docker Compose** | â­â­ | â­â­â­ | â­â­ | å¼€å‘æµ‹è¯•ã€å°å‹ç”Ÿäº§ | â­â­â­â­ |
| **Kubernetes StatefulSet** | â­â­â­ | â­â­â­ | â­â­â­ | ç”Ÿäº§ç¯å¢ƒ | â­â­â­â­ |
| **PostgreSQL Operator** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | ç”Ÿäº§ç¯å¢ƒ | â­â­â­â­â­ |
| **Helm Chart** | â­â­â­ | â­â­â­â­ | â­â­â­ | å¿«é€Ÿéƒ¨ç½² | â­â­â­â­ |

### 9.2 Operatorå¯¹æ¯”

| Operator | åŠŸèƒ½å®Œæ•´æ€§ | æ˜“ç”¨æ€§ | ç¤¾åŒºæ”¯æŒ | æ¨èåº¦ |
|---------|-----------|--------|---------|--------|
| **Crunchy PostgreSQL Operator** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **Zalando PostgreSQL Operator** | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **CloudNativePG** | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |

### 9.3 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| å­˜å‚¨æ–¹æ¡ˆ | æ€§èƒ½ | å¯é æ€§ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|------|--------|------|---------|--------|
| **æœ¬åœ°å­˜å‚¨** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | é«˜æ€§èƒ½éœ€æ±‚ | â­â­â­ |
| **ç½‘ç»œå­˜å‚¨ï¼ˆNFSï¼‰** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | å…±äº«å­˜å‚¨ | â­â­â­ |
| **äº‘å­˜å‚¨ï¼ˆEBS/GCE PDï¼‰** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | äº‘ç¯å¢ƒ | â­â­â­â­â­ |
| **åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆCephï¼‰** | â­â­â­â­ | â­â­â­â­â­ | â­â­ | å¤§è§„æ¨¡éƒ¨ç½² | â­â­â­â­ |

---

## åã€å®è·µæ¡ˆä¾‹

### 10.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²

**å¼€å‘ç¯å¢ƒdocker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: devpassword
      POSTGRES_DB: devdb
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    networks:
      - dev_network

  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: dev@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - dev_network
    depends_on:
      - postgres

volumes:
  postgres_dev_data:

networks:
  dev_network:
    driver: bridge
```

### 10.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**ç”Ÿäº§ç¯å¢ƒKubernetesé…ç½®**ï¼š

```yaml
# ä½¿ç”¨PostgreSQL Operator
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-prod
  namespace: production
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 3
      resources:
        requests:
          memory: 4Gi
          cpu: 2000m
        limits:
          memory: 8Gi
          cpu: 4000m
      dataVolumeClaimSpec:
        accessModes:
        - ReadWriteOnce
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 100Gi
  backups:
    pgbackrest:
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            storageClassName: fast-ssd
            resources:
              requests:
                storage: 200Gi
  proxy:
    pgBouncer:
      replicas: 3
      resources:
        requests:
          memory: 128Mi
          cpu: 200m
```

### 10.3 å¤šç§Ÿæˆ·éƒ¨ç½²

**å¤šç§Ÿæˆ·StatefulSeté…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-tenant-${TENANT_ID}
  namespace: tenants
spec:
  serviceName: postgres-tenant-${TENANT_ID}
  replicas: 1
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_DB
          value: "tenant_${TENANT_ID}"
        - name: POSTGRES_USER
          value: "tenant_${TENANT_ID}"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: tenant-${TENANT_ID}-secret
              key: password
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

---

## åä¸€ã€æ•…éšœæ’æŸ¥

### 11.1 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šå®¹å™¨æ— æ³•å¯åŠ¨**:

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs postgres
kubectl logs postgres-0 -n postgres

# æ£€æŸ¥é…ç½®
docker exec postgres cat /etc/postgresql/postgresql.conf
kubectl exec postgres-0 -n postgres -- cat /etc/postgresql/postgresql.conf

# æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
docker exec postgres ls -la /var/lib/postgresql/data
```

**é—®é¢˜2ï¼šè¿æ¥è¢«æ‹’ç»**:

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get svc -n postgres

# æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicies -n postgres

# æµ‹è¯•è¿æ¥
kubectl run -it --rm debug --image=postgres:18 --restart=Never -- \
  psql -h postgres.postgres.svc.cluster.local -U postgres
```

**é—®é¢˜3ï¼šå­˜å‚¨é—®é¢˜**:

```bash
# æ£€æŸ¥PVCçŠ¶æ€
kubectl get pvc -n postgres

# æ£€æŸ¥PVçŠ¶æ€
kubectl get pv

# æŸ¥çœ‹å­˜å‚¨äº‹ä»¶
kubectl describe pvc postgres-storage-postgres-0 -n postgres
```

### 11.2 è¯Šæ–­æ–¹æ³•

**Podè¯Šæ–­**ï¼š

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl describe pod postgres-0 -n postgres

# æŸ¥çœ‹Podäº‹ä»¶
kubectl get events -n postgres --sort-by='.lastTimestamp'

# è¿›å…¥Podè°ƒè¯•
kubectl exec -it postgres-0 -n postgres -- /bin/bash
```

**ç½‘ç»œè¯Šæ–­**ï¼š

```bash
# æµ‹è¯•DNSè§£æ
kubectl run -it --rm debug --image=busybox --restart=Never -- \
  nslookup postgres.postgres.svc.cluster.local

# æµ‹è¯•ç«¯å£è¿é€šæ€§
kubectl run -it --rm debug --image=postgres:18 --restart=Never -- \
  pg_isready -h postgres.postgres.svc.cluster.local -p 5432
```

### 11.3 è§£å†³æ–¹æ¡ˆ

**æ•°æ®æ¢å¤**ï¼š

```bash
# ä»å¤‡ä»½æ¢å¤
kubectl exec -it postgres-0 -n postgres -- \
  pg_restore -h localhost -U postgres -d mydb /backup/mydb.dump

# ä»å·å¿«ç…§æ¢å¤
kubectl create pvc postgres-restored \
  --from-snapshot=postgres-snapshot \
  -n postgres
```

**æ€§èƒ½é—®é¢˜**ï¼š

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pod postgres-0 -n postgres

# è°ƒæ•´èµ„æºé™åˆ¶
kubectl patch statefulset postgres -n postgres -p '
{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "postgres",
          "resources": {
            "limits": {"memory": "8Gi", "cpu": "4000m"}
          }
        }]
      }
    }
  }
}'
```

---

## åäºŒã€æœ€ä½³å®è·µ

### 12.1 éƒ¨ç½²æœ€ä½³å®è·µ

1. **é•œåƒé€‰æ‹©**ï¼š
   - ä½¿ç”¨å®˜æ–¹é•œåƒ
   - å›ºå®šç‰ˆæœ¬æ ‡ç­¾
   - å®šæœŸæ›´æ–°é•œåƒ

2. **èµ„æºé…ç½®**ï¼š
   - è®¾ç½®åˆç†çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶
   - ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
   - ä½¿ç”¨HPAè‡ªåŠ¨ä¼¸ç¼©

3. **å­˜å‚¨ç®¡ç†**ï¼š
   - ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨
   - å®šæœŸå¤‡ä»½
   - å¯ç”¨å­˜å‚¨æ‰©å±•

### 12.2 å®‰å…¨æœ€ä½³å®è·µ

1. **å¯†é’¥ç®¡ç†**ï¼š
   - ä½¿ç”¨Secretå­˜å‚¨å¯†ç 
   - ä½¿ç”¨Sealed Secretsæˆ–External Secrets
   - å®šæœŸè½®æ¢å¯†é’¥

2. **ç½‘ç»œå®‰å…¨**ï¼š
   - ä½¿ç”¨NetworkPolicyé™åˆ¶è®¿é—®
   - å¯ç”¨TLS/SSL
   - ä½¿ç”¨Service Mesh

3. **é•œåƒå®‰å…¨**ï¼š
   - æ‰«æé•œåƒæ¼æ´
   - ä½¿ç”¨å¯ä¿¡é•œåƒæº
   - å®šæœŸæ›´æ–°é•œåƒ

### 12.3 è¿ç»´æœ€ä½³å®è·µ

1. **ç›‘æ§å‘Šè­¦**ï¼š
   - é…ç½®Prometheusç›‘æ§
   - è®¾ç½®å‘Šè­¦è§„åˆ™
   - å®šæœŸæ£€æŸ¥æ—¥å¿—

2. **å¤‡ä»½æ¢å¤**ï¼š
   - è‡ªåŠ¨åŒ–å¤‡ä»½
   - å®šæœŸæµ‹è¯•æ¢å¤
   - å¤šåœ°ç‚¹å¤‡ä»½

3. **æ•…éšœå¤„ç†**ï¼š
   - å»ºç«‹æ•…éšœå¤„ç†æµç¨‹
   - å®šæœŸæ¼”ç»ƒæ•…éšœè½¬ç§»
   - è®°å½•æ•…éšœå¤„ç†ç»éªŒ

---

## åä¸‰ã€å‚è€ƒèµ„æº

### 13.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQL Dockeré•œåƒ](https://hub.docker.com/_/postgres)
- [Kubernetes StatefulSet](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)
- [Crunchy PostgreSQL Operator](https://www.crunchydata.com/products/crunchy-postgresql-operator)

### 13.2 ç½‘ç»œèµ„æº

- [PostgreSQLå®¹å™¨åŒ–æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/)
- [Kuberneteséƒ¨ç½²æŒ‡å—](https://kubernetes.io/docs/)
- [Docker Composeæ–‡æ¡£](https://docs.docker.com/compose/)

### 13.3 ç›¸å…³æ–‡æ¡£

- `04-éƒ¨ç½²è¿ç»´/04.01-å•æœºéƒ¨ç½²ä¸é…ç½®.md` - å•æœºéƒ¨ç½²æŒ‡å—
- `04-éƒ¨ç½²è¿ç»´/04.02-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md` - é«˜å¯ç”¨éƒ¨ç½²
- `05-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md` - Dockerè¯¦ç»†æŒ‡å—
- `05-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.13-Kuberneteséƒ¨ç½².md` - Kubernetesè¯¦ç»†æŒ‡å—

---

**ç»´æŠ¤è€…**: Data-Science Team
**æœ€åæ›´æ–°**: 2025-01-15
**ç‰ˆæœ¬**: 3.0
