---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\05-éƒ¨ç½²æ¶æ„\å®¹å™¨åŒ–éƒ¨ç½²\05.12-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# äº‘åŸç”Ÿä¸å®¹å™¨åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [äº‘åŸç”Ÿä¸å®¹å™¨åŒ–](#äº‘åŸç”Ÿä¸å®¹å™¨åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å®¹å™¨åŒ–è¦ç‚¹](#3-å®¹å™¨åŒ–è¦ç‚¹)
    - [3.1 Dockeré•œåƒæ„å»º](#31-dockeré•œåƒæ„å»º)
      - [åŸºç¡€Dockerfile](#åŸºç¡€dockerfile)
      - [å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–](#å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–)
    - [3.2 å‚æ•°æ³¨å…¥](#32-å‚æ•°æ³¨å…¥)
      - [ä½¿ç”¨ç¯å¢ƒå˜é‡](#ä½¿ç”¨ç¯å¢ƒå˜é‡)
      - [ä½¿ç”¨ConfigMapï¼ˆKubernetesï¼‰](#ä½¿ç”¨configmapkubernetes)
    - [3.3 å¥åº·æ£€æŸ¥](#33-å¥åº·æ£€æŸ¥)
      - [Dockerå¥åº·æ£€æŸ¥](#dockerå¥åº·æ£€æŸ¥)
      - [Docker Composeå¥åº·æ£€æŸ¥](#docker-composeå¥åº·æ£€æŸ¥)
      - [Kuberneteså¥åº·æ£€æŸ¥](#kuberneteså¥åº·æ£€æŸ¥)
    - [3.4 æ—¥å¿—ç®¡ç†](#34-æ—¥å¿—ç®¡ç†)
      - [Dockeræ—¥å¿—é…ç½®](#dockeræ—¥å¿—é…ç½®)
      - [æ—¥å¿—æ”¶é›†ï¼ˆFluentdï¼‰](#æ—¥å¿—æ”¶é›†fluentd)
  - [4. Kubernetes](#4-kubernetes)
    - [4.1 StatefulSetéƒ¨ç½²](#41-statefulsetéƒ¨ç½²)
      - [åŸºç¡€StatefulSet](#åŸºç¡€statefulset)
    - [4.2 PersistentVolumeå’ŒPersistentVolumeClaim](#42-persistentvolumeå’Œpersistentvolumeclaim)
      - [åˆ›å»ºStorageClass](#åˆ›å»ºstorageclass)
      - [ä½¿ç”¨PVC](#ä½¿ç”¨pvc)
    - [4.3 PostgreSQL Operator](#43-postgresql-operator)
      - [Crunchy PostgreSQL Operator](#crunchy-postgresql-operator)
      - [Zalando PostgreSQL Operator](#zalando-postgresql-operator)
    - [4.4 è‡ªåŠ¨å¤‡ä»½](#44-è‡ªåŠ¨å¤‡ä»½)
      - [CronJobå¤‡ä»½](#cronjobå¤‡ä»½)
    - [4.5 è‡ªåŠ¨æ‰©ç¼©å®¹](#45-è‡ªåŠ¨æ‰©ç¼©å®¹)
      - [HPAé…ç½®](#hpaé…ç½®)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 èµ„æºè¯·æ±‚å’Œé™åˆ¶](#51-èµ„æºè¯·æ±‚å’Œé™åˆ¶)
    - [5.2 äº²å’Œæ€§å’Œåäº²å’Œæ€§](#52-äº²å’Œæ€§å’Œåäº²å’Œæ€§)
      - [Podåäº²å’Œæ€§ï¼ˆé¿å…åŒä¸€èŠ‚ç‚¹ï¼‰](#podåäº²å’Œæ€§é¿å…åŒä¸€èŠ‚ç‚¹)
      - [èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆæŒ‡å®šèŠ‚ç‚¹ç±»å‹ï¼‰](#èŠ‚ç‚¹äº²å’Œæ€§æŒ‡å®šèŠ‚ç‚¹ç±»å‹)
    - [5.3 æ»šåŠ¨å‡çº§](#53-æ»šåŠ¨å‡çº§)
      - [æ›´æ–°ç­–ç•¥](#æ›´æ–°ç­–ç•¥)
      - [é‡‘ä¸é›€å‘å¸ƒ](#é‡‘ä¸é›€å‘å¸ƒ)
    - [5.4 ç½‘ç»œç­–ç•¥](#54-ç½‘ç»œç­–ç•¥)
    - [5.5 é…ç½®ç®¡ç†](#55-é…ç½®ç®¡ç†)
      - [ä½¿ç”¨ConfigMapå’ŒSecret](#ä½¿ç”¨configmapå’Œsecret)
    - [5.6 ç›‘æ§é›†æˆ](#56-ç›‘æ§é›†æˆ)
      - [Prometheusç›‘æ§](#prometheusç›‘æ§)
  - [6. åç»­æ•´åˆä»»åŠ¡](#6-åç»­æ•´åˆä»»åŠ¡)
    - [11.1 Helm Chartç¤ºä¾‹](#111-helm-chartç¤ºä¾‹)
    - [11.2 Operatorå¯¹æ¯”](#112-operatorå¯¹æ¯”)
    - [11.3 é€‰æ‹©å»ºè®®](#113-é€‰æ‹©å»ºè®®)
  - [6. ç”Ÿäº§çº§é…ç½®ç¤ºä¾‹](#6-ç”Ÿäº§çº§é…ç½®ç¤ºä¾‹)
    - [6.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®](#61-å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®)
    - [6.2 å¤šç¯å¢ƒé…ç½®ç®¡ç†](#62-å¤šç¯å¢ƒé…ç½®ç®¡ç†)
    - [6.3 å®‰å…¨é…ç½®](#63-å®‰å…¨é…ç½®)
    - [6.4 æ€§èƒ½ä¼˜åŒ–é…ç½®](#64-æ€§èƒ½ä¼˜åŒ–é…ç½®)
  - [7. Helm Chartå®Œæ•´ç¤ºä¾‹](#7-helm-chartå®Œæ•´ç¤ºä¾‹)
    - [7.1 Bitnami PostgreSQL Charté…ç½®](#71-bitnami-postgresql-charté…ç½®)
    - [7.2 è‡ªå®šä¹‰Helm Chart](#72-è‡ªå®šä¹‰helm-chart)
    - [7.3 Helm Chartæœ€ä½³å®è·µ](#73-helm-chartæœ€ä½³å®è·µ)
  - [8. Operatorè¯¦ç»†å¯¹æ¯”å’Œé€‰æ‹©](#8-operatorè¯¦ç»†å¯¹æ¯”å’Œé€‰æ‹©)
    - [8.1 Crunchy Operatorè¯¦ç»†å¯¹æ¯”](#81-crunchy-operatorè¯¦ç»†å¯¹æ¯”)
    - [8.2 Zalando Operatorè¯¦ç»†å¯¹æ¯”](#82-zalando-operatorè¯¦ç»†å¯¹æ¯”)
    - [8.3 CloudNativePGè¯¦ç»†å¯¹æ¯”](#83-cloudnativepgè¯¦ç»†å¯¹æ¯”)
    - [8.4 é€‰æ‹©å»ºè®®å’Œè¿ç§»æŒ‡å—](#84-é€‰æ‹©å»ºè®®å’Œè¿ç§»æŒ‡å—)
  - [9. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­](#9-æ•…éšœæ’æŸ¥å’Œè¯Šæ–­)
    - [9.1 å®¹å™¨åŒ–é—®é¢˜æ’æŸ¥](#91-å®¹å™¨åŒ–é—®é¢˜æ’æŸ¥)
    - [9.2 Kubernetesé—®é¢˜æ’æŸ¥](#92-kubernetesé—®é¢˜æ’æŸ¥)
    - [9.3 æ€§èƒ½é—®é¢˜è¯Šæ–­](#93-æ€§èƒ½é—®é¢˜è¯Šæ–­)
  - [10. ç›‘æ§å’Œå‘Šè­¦é…ç½®](#10-ç›‘æ§å’Œå‘Šè­¦é…ç½®)
    - [10.1 Prometheusç›‘æ§é›†æˆ](#101-prometheusç›‘æ§é›†æˆ)
    - [10.2 Grafanaä»ªè¡¨æ¿é…ç½®](#102-grafanaä»ªè¡¨æ¿é…ç½®)
    - [10.3 å‘Šè­¦è§„åˆ™é…ç½®](#103-å‘Šè­¦è§„åˆ™é…ç½®)
  - [11. åç»­æ•´åˆä»»åŠ¡](#11-åç»­æ•´åˆä»»åŠ¡)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [å‰æ²¿æŠ€æœ¯](#å‰æ²¿æŠ€æœ¯)

---

## 1. æ¦‚è¿°

- å®¹å™¨é•œåƒã€Kubernetesç¼–æ’ã€æŒä¹…åŒ–ä¸è¿ç»´

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²-æ‰©å……ç‰ˆ.md
- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½².md

## 3. å®¹å™¨åŒ–è¦ç‚¹

- é•œåƒæ„å»ºã€å‚æ•°æ³¨å…¥ã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—

### 3.1 Dockeré•œåƒæ„å»º

#### åŸºç¡€Dockerfile

```dockerfile
# ä½¿ç”¨å®˜æ–¹PostgreSQLé•œåƒ
FROM postgres:18

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV POSTGRES_DB=mydb
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=changeme

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY postgresql.conf /etc/postgresql/postgresql.conf
COPY pg_hba.conf /etc/postgresql/pg_hba.conf

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY init.sql /docker-entrypoint-initdb.d/

# è®¾ç½®æ•°æ®ç›®å½•æƒé™
RUN chown -R postgres:postgres /var/lib/postgresql/data

# æš´éœ²ç«¯å£
EXPOSE 5432

# ä½¿ç”¨è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["postgres"]
```

#### å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM postgres:18 AS builder

# å®‰è£…æ‰©å±•
RUN apt-get update && apt-get install -y \
    postgresql-18-pgvector \
    postgresql-18-pg-stat-statements \
    && rm -rf /var/lib/apt/lists/*

# è¿è¡Œé˜¶æ®µ
FROM postgres:18

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ‰©å±•
COPY --from=builder /usr/share/postgresql/18/extension/* \
    /usr/share/postgresql/18/extension/
COPY --from=builder /usr/lib/postgresql/18/lib/* \
    /usr/lib/postgresql/18/lib/

# å¤åˆ¶é…ç½®å’Œè„šæœ¬
COPY postgresql.conf /etc/postgresql/
COPY init-extensions.sql /docker-entrypoint-initdb.d/
```

### 3.2 å‚æ•°æ³¨å…¥

#### ä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=zh_CN.UTF-8"
      # è‡ªå®šä¹‰é…ç½®å‚æ•°
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 100
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
```

#### ä½¿ç”¨ConfigMapï¼ˆKubernetesï¼‰

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    shared_buffers = 256MB
    max_connections = 100
    work_mem = 4MB
    effective_cache_size = 1GB
  pg_hba.conf: |
    host all all 0.0.0.0/0 md5
```

### 3.3 å¥åº·æ£€æŸ¥

#### Dockerå¥åº·æ£€æŸ¥

```dockerfile
# Dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD pg_isready -U postgres -d mydb || exit 1
```

#### Docker Composeå¥åº·æ£€æŸ¥

```yaml
services:
  postgres:
    image: postgres:18
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
```

#### Kuberneteså¥åº·æ£€æŸ¥

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 3.4 æ—¥å¿—ç®¡ç†

#### Dockeræ—¥å¿—é…ç½®

```yaml
services:
  postgres:
    image: postgres:18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"
```

#### æ—¥å¿—æ”¶é›†ï¼ˆFluentdï¼‰

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: "postgres.{{.Name}}"

  fluentd:
    image: fluent/fluentd:latest
    volumes:
      - ./fluentd.conf:/fluentd/etc/fluent.conf
    ports:
      - "24224:24224"
```

## 4. Kubernetes

- StatefulSetã€PV/PVCã€Operatorã€å¤‡ä»½ä¸ä¼¸ç¼©

### 4.1 StatefulSetéƒ¨ç½²

#### åŸºç¡€StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
```

### 4.2 PersistentVolumeå’ŒPersistentVolumeClaim

#### åˆ›å»ºStorageClass

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  fsType: ext4
  encrypted: "true"
```

#### ä½¿ç”¨PVC

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
```

### 4.3 PostgreSQL Operator

#### Crunchy PostgreSQL Operator

```bash
# å®‰è£…Operator
kubectl apply -f https://raw.githubusercontent.com/CrunchyData/postgres-operator/v5.3.0/install/kubectl/postgres-operator.yaml

# åˆ›å»ºPostgreSQLé›†ç¾¤
kubectl apply -f - <<EOF
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 2
      dataVolumeClaimSpec:
        accessModes:
        - "ReadWriteOnce"
        resources:
          requests:
            storage: 10Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - "ReadWriteOnce"
            resources:
              requests:
                storage: 20Gi
EOF
```

#### Zalando PostgreSQL Operator

```yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgres-cluster
spec:
  teamId: "myteam"
  volume:
    size: 10Gi
  numberOfInstances: 2
  users:
    zalando:
    - superuser
    - createdb
  databases:
    foo: zalando
  postgresql:
    version: "18"
```

### 4.4 è‡ªåŠ¨å¤‡ä»½

#### CronJobå¤‡ä»½

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: pg-dump
            image: postgres:18
            command:
            - /bin/sh
            - -c
            - |
              pg_dump -h postgres -U postgres mydb > /backup/mydb-$(date +%Y%m%d).sql
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            volumeMounts:
            - name: backup-volume
              mountPath: /backup
          volumes:
          - name: backup-volume
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### 4.5 è‡ªåŠ¨æ‰©ç¼©å®¹

#### HPAé…ç½®

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 1
  maxReplicas: 3
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

## 5. æœ€ä½³å®è·µ

- èµ„æºè¯·æ±‚/é™åˆ¶ã€äº²å’Œ/åäº²å’Œã€æ»šåŠ¨å‡çº§

### 5.1 èµ„æºè¯·æ±‚å’Œé™åˆ¶

```yaml
spec:
  containers:
  - name: postgres
    image: postgres:18
    resources:
      requests:
        memory: "2Gi"
        cpu: "1000m"
      limits:
        memory: "4Gi"
        cpu: "2000m"
```

### 5.2 äº²å’Œæ€§å’Œåäº²å’Œæ€§

#### Podåäº²å’Œæ€§ï¼ˆé¿å…åŒä¸€èŠ‚ç‚¹ï¼‰

```yaml
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - postgres
          topologyKey: kubernetes.io/hostname
```

#### èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆæŒ‡å®šèŠ‚ç‚¹ç±»å‹ï¼‰

```yaml
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-type
            operator: In
            values:
            - database
```

### 5.3 æ»šåŠ¨å‡çº§

#### æ›´æ–°ç­–ç•¥

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0  # ä»ç¬¬0ä¸ªPodå¼€å§‹æ›´æ–°
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18  # æ›´æ–°é•œåƒç‰ˆæœ¬
```

#### é‡‘ä¸é›€å‘å¸ƒ

```yaml
# 1. åˆ›å»ºé‡‘ä¸é›€ç‰ˆæœ¬
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-canary
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18-new

# 2. é€æ­¥å¢åŠ é‡‘ä¸é›€æµé‡
# ä½¿ç”¨Serviceå’ŒTraffic Splitting
```

### 5.4 ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: myapp
    ports:
    - protocol: TCP
      port: 5432
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: backup
    ports:
    - protocol: TCP
      port: 5432
```

### 5.5 é…ç½®ç®¡ç†

#### ä½¿ç”¨ConfigMapå’ŒSecret

```yaml
# ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    shared_buffers = 256MB
    max_connections = 100

# Secret
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
stringData:
  password: changeme
  username: postgres
```

### 5.6 ç›‘æ§é›†æˆ

#### Prometheusç›‘æ§

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9187"
spec:
  ports:
  - name: metrics
    port: 9187
    targetPort: 9187
```

## 6. åç»­æ•´åˆä»»åŠ¡

- å¢è¡¥Helmç¤ºä¾‹ä¸Operatorå¯¹æ¯”

### 11.1 Helm Chartç¤ºä¾‹

```yaml
# values.yaml
postgresql:
  image:
    repository: postgres
    tag: "18"
  auth:
    postgresPassword: changeme
    database: mydb
  persistence:
    enabled: true
    size: 20Gi
  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
```

```bash
# å®‰è£…Helm Chart
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install postgres bitnami/postgresql -f values.yaml
```

### 11.2 Operatorå¯¹æ¯”

| ç‰¹æ€§ | Crunchy Operator | Zalando Operator | CloudNativePG |
|------|-----------------|-----------------|---------------|
| é«˜å¯ç”¨ | âœ… | âœ… | âœ… |
| è‡ªåŠ¨å¤‡ä»½ | âœ… (pgBackRest) | âœ… | âœ… |
| ç›‘æ§é›†æˆ | âœ… | âœ… | âœ… |
| æ‰©å±•æ”¯æŒ | âœ… | âœ… | âœ… |
| ç¤¾åŒºæ´»è·ƒåº¦ | é«˜ | ä¸­ | é«˜ |
| æ˜“ç”¨æ€§ | ä¸­ | é«˜ | é«˜ |

### 11.3 é€‰æ‹©å»ºè®®

- **å°å‹é¡¹ç›®**: ä½¿ç”¨StatefulSet + ConfigMap/Secret
- **ä¸­å‹é¡¹ç›®**: ä½¿ç”¨Helm Chartï¼ˆå¦‚Bitnamiï¼‰
- **å¤§å‹é¡¹ç›®**: ä½¿ç”¨Operatorï¼ˆæ¨èCrunchyæˆ–CloudNativePGï¼‰
- **äº‘ç¯å¢ƒ**: ä½¿ç”¨äº‘æœåŠ¡å•†çš„æ‰˜ç®¡æœåŠ¡

---

## 6. ç”Ÿäº§çº§é…ç½®ç¤ºä¾‹

### 6.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®

**å®Œæ•´çš„äº‘åŸç”ŸPostgreSQLé…ç½®**:

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C --data-checksums"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - hba_file=/etc/postgresql/pg_hba.conf
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - postgres_network

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres/data

networks:
  postgres_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 6.2 å¤šç¯å¢ƒé…ç½®ç®¡ç†

**ä½¿ç”¨Kustomizeç®¡ç†å¤šç¯å¢ƒ**:

```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- statefulset.yaml
- service.yaml
- configmap.yaml
- secret.yaml

# production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../base

patches:
- path: production-patch.yaml

# production/production-patch.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: postgres
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
```

### 6.3 å®‰å…¨é…ç½®

**äº‘åŸç”Ÿå®‰å…¨é…ç½®**:

```yaml
# ä½¿ç”¨Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
stringData:
  postgres-password: ${POSTGRES_PASSWORD}
  replication-password: ${REPLICATION_PASSWORD}

# ä½¿ç”¨SecurityContext
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: postgres
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
```

### 6.4 æ€§èƒ½ä¼˜åŒ–é…ç½®

**äº‘åŸç”Ÿæ€§èƒ½ä¼˜åŒ–**:

```yaml
# ä½¿ç”¨InitContainerä¼˜åŒ–å¯åŠ¨
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      initContainers:
      - name: init-postgres
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          chown -R 999:999 /var/lib/postgresql/data
          chmod 700 /var/lib/postgresql/data
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data

      containers:
      - name: postgres
        image: postgres:18
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
        # PostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–
        env:
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF8 --locale=C --data-checksums"
```

## 7. Helm Chartå®Œæ•´ç¤ºä¾‹

### 7.1 Bitnami PostgreSQL Charté…ç½®

**å®Œæ•´çš„Bitnami Charté…ç½®**:

```yaml
# values-prod.yaml
global:
  postgresql:
    auth:
      postgresPassword: ${POSTGRES_PASSWORD}
      database: mydb
      username: app_user
      password: ${APP_PASSWORD}

postgresql:
  image:
    repository: postgres
    tag: "18"

  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd
    resources:
      requests:
        memory: "4Gi"
        cpu: "2"
      limits:
        memory: "8Gi"
        cpu: "4"
    configuration:
      max_connections: "500"
      shared_buffers: "2GB"
      effective_cache_size: "6GB"
      work_mem: "16MB"
      maintenance_work_mem: "512MB"
      # PostgreSQL 18æ–°ç‰¹æ€§
      io_method: "aio"
      io_combine_limit: "128"
      maintenance_io_workers: "4"
      max_io_workers: "10"
      parallel_leader_participation: "on"

  readReplicas:
    replicaCount: 2
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd
    resources:
      requests:
        memory: "4Gi"
        cpu: "2"
      limits:
        memory: "8Gi"
        cpu: "4"

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring

  networkPolicy:
    enabled: true
    ingress:
      - from:
        - namespaceSelector:
            matchLabels:
              name: application
```

**å®‰è£…å’Œå‡çº§**:

```bash
# æ·»åŠ Helmä»“åº“
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# å®‰è£…ç”Ÿäº§ç¯å¢ƒ
helm install postgres-prod bitnami/postgresql \
  -f values-prod.yaml \
  --namespace postgres \
  --create-namespace

# å‡çº§
helm upgrade postgres-prod bitnami/postgresql \
  -f values-prod.yaml \
  --namespace postgres

# æŸ¥çœ‹çŠ¶æ€
helm status postgres-prod --namespace postgres
```

### 7.2 è‡ªå®šä¹‰Helm Chart

**åˆ›å»ºè‡ªå®šä¹‰Helm Chart**:

```bash
# åˆ›å»ºChart
helm create postgres-custom
cd postgres-custom

# ç›®å½•ç»“æ„
# postgres-custom/
#   Chart.yaml
#   values.yaml
#   templates/
#     statefulset.yaml
#     service.yaml
#     configmap.yaml
#     secret.yaml
```

**Chart.yaml**:

```yaml
apiVersion: v2
name: postgres-custom
description: Custom PostgreSQL Helm chart
type: application
version: 1.0.0
appVersion: "18"
```

**values.yaml**:

```yaml
replicaCount: 3

image:
  repository: postgres
  tag: "18"
  pullPolicy: IfNotPresent

postgresql:
  database: mydb
  username: postgres
  password: changeme

persistence:
  enabled: true
  size: 100Gi
  storageClass: fast-ssd

resources:
  requests:
    memory: "4Gi"
    cpu: "2"
  limits:
    memory: "8Gi"
    cpu: "4"

monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
```

### 7.3 Helm Chartæœ€ä½³å®è·µ

**Helm Chartæœ€ä½³å®è·µ**:

```yaml
# 1. ä½¿ç”¨values.schema.jsonéªŒè¯é…ç½®
# values.schema.json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "replicaCount": {
      "type": "integer",
      "minimum": 1,
      "maximum": 10
    },
    "resources": {
      "type": "object",
      "properties": {
        "requests": {
          "type": "object",
          "properties": {
            "memory": {"type": "string"},
            "cpu": {"type": "string"}
          }
        }
      }
    }
  }
}

# 2. ä½¿ç”¨Helm hooksè¿›è¡Œåˆå§‹åŒ–
# templates/job-init.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "postgres.fullname" . }}-init
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      containers:
      - name: init
        image: postgres:18
        command:
        - /bin/sh
        - -c
        - |
          # åˆå§‹åŒ–è„šæœ¬
          echo "Initializing database..."
```

## 8. Operatorè¯¦ç»†å¯¹æ¯”å’Œé€‰æ‹©

### 8.1 Crunchy Operatorè¯¦ç»†å¯¹æ¯”

**Crunchy Operatorç‰¹ç‚¹**:

```yaml
# Crunchy Operatorä¼˜åŠ¿
ä¼˜åŠ¿:
  - ä¼ä¸šçº§åŠŸèƒ½å®Œæ•´
  - pgBackRestå¤‡ä»½é›†æˆ
  - æ”¯æŒå¤šç§å­˜å‚¨åç«¯
  - æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ
  - è¯¦ç»†çš„æ–‡æ¡£

åŠ£åŠ¿:
  - é…ç½®ç›¸å¯¹å¤æ‚
  - èµ„æºæ¶ˆè€—è¾ƒé«˜
  - å­¦ä¹ æ›²çº¿è¾ƒé™¡

é€‚ç”¨åœºæ™¯:
  - ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ
  - éœ€è¦å®Œæ•´å¤‡ä»½æ¢å¤åŠŸèƒ½
  - éœ€è¦é«˜å¯ç”¨å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»
  - éœ€è¦è¯¦ç»†çš„ç›‘æ§å’Œå‘Šè­¦
```

**Crunchy Operatoré…ç½®ç¤ºä¾‹**:

```yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
  - name: instance1
    replicas: 3
    resources:
      requests:
        memory: 4Gi
        cpu: 2
      limits:
        memory: 8Gi
        cpu: 4
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast-ssd
  backups:
    pgbackrest:
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 200Gi
      schedules:
        full: "0 2 * * 0"
        incremental: "0 2 * * *"
```

### 8.2 Zalando Operatorè¯¦ç»†å¯¹æ¯”

**Zalando Operatorç‰¹ç‚¹**:

```yaml
# Zalando Operatorä¼˜åŠ¿
ä¼˜åŠ¿:
  - é…ç½®ç®€å•æ˜“ç”¨
  - è‡ªåŠ¨æ•…éšœè½¬ç§»
  - æ”¯æŒé€»è¾‘å¤åˆ¶
  - è‰¯å¥½çš„Kubernetesé›†æˆ
  - æ”¯æŒå¤šç‰ˆæœ¬PostgreSQL

åŠ£åŠ¿:
  - å¤‡ä»½åŠŸèƒ½ç›¸å¯¹ç®€å•
  - ç¤¾åŒºæ´»è·ƒåº¦ä¸­ç­‰
  - æ–‡æ¡£ç›¸å¯¹è¾ƒå°‘

é€‚ç”¨åœºæ™¯:
  - ä¸­å°å‹é¡¹ç›®
  - éœ€è¦ç®€å•çš„é…ç½®
  - éœ€è¦å¿«é€Ÿéƒ¨ç½²
  - ä¸éœ€è¦å¤æ‚çš„å¤‡ä»½ç­–ç•¥
```

**Zalando Operatoré…ç½®ç¤ºä¾‹**:

```yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgres-cluster
spec:
  teamId: "myteam"
  volume:
    size: 100Gi
    storageClass: fast-ssd
  numberOfInstances: 3
  users:
    zalando:
    - superuser
    - createdb
  databases:
    foo: zalando
  postgresql:
    version: "18"
    parameters:
      max_connections: "500"
      shared_buffers: "2GB"
      effective_cache_size: "6GB"
      # PostgreSQL 18æ–°ç‰¹æ€§
      io_method: "aio"
      io_combine_limit: "128"
      maintenance_io_workers: "4"
      max_io_workers: "10"
  resources:
    requests:
      cpu: 2
      memory: 4Gi
    limits:
      cpu: 4
      memory: 8Gi
  enableMasterLoadBalancer: true
  enableReplicaLoadBalancer: true
```

### 8.3 CloudNativePGè¯¦ç»†å¯¹æ¯”

**CloudNativePGç‰¹ç‚¹**:

```yaml
# CloudNativePGä¼˜åŠ¿
ä¼˜åŠ¿:
  - CNCFé¡¹ç›®ï¼Œæ ‡å‡†åŒ–
  - é…ç½®çµæ´»
  - æ”¯æŒå¤šç§å¤‡ä»½æ–¹å¼
  - è‰¯å¥½çš„ç¤¾åŒºæ”¯æŒ
  - è¯¦ç»†çš„æ–‡æ¡£

åŠ£åŠ¿:
  - ç›¸å¯¹è¾ƒæ–°
  - åŠŸèƒ½è¿˜åœ¨å®Œå–„ä¸­
  - ä¼ä¸šçº§åŠŸèƒ½è¾ƒå°‘

é€‚ç”¨åœºæ™¯:
  - äº‘åŸç”Ÿç¯å¢ƒ
  - éœ€è¦CNCFæ ‡å‡†åŒ–
  - éœ€è¦çµæ´»çš„é…ç½®
  - ä¸­å°å‹åˆ°å¤§å‹é¡¹ç›®
```

**CloudNativePGé…ç½®ç¤ºä¾‹**:

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
spec:
  instances: 3
  postgresql:
    parameters:
      max_connections: "500"
      shared_buffers: "2GB"
      effective_cache_size: "6GB"
      # PostgreSQL 18æ–°ç‰¹æ€§
      io_method: "aio"
      io_combine_limit: "128"
      maintenance_io_workers: "4"
      max_io_workers: "10"
  resources:
    requests:
      memory: 4Gi
      cpu: 2
    limits:
      memory: 8Gi
      cpu: 4
  storage:
    size: 100Gi
    storageClass: fast-ssd
  backup:
    barmanObjectStore:
      destinationPath: s3://backup-bucket/postgres
      s3Credentials:
        accessKeyId:
          name: backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: backup-credentials
          key: SECRET_ACCESS_KEY
      wal:
        retention: "7d"
      data:
        retention: "30d"
```

### 8.4 é€‰æ‹©å»ºè®®å’Œè¿ç§»æŒ‡å—

**Operatoré€‰æ‹©å†³ç­–æ ‘**:

```text
éœ€è¦ä¼ä¸šçº§åŠŸèƒ½ï¼Ÿ
â”œâ”€ æ˜¯ â†’ Crunchy Operator
â”‚   â””â”€ éœ€è¦å®Œæ•´å¤‡ä»½æ¢å¤ã€é«˜å¯ç”¨ã€è¯¦ç»†ç›‘æ§
â”‚
â”œâ”€ å¦ â†’ éœ€è¦ç®€å•é…ç½®ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ Zalando Operator
â”‚   â”‚   â””â”€ ä¸­å°å‹é¡¹ç›®ã€å¿«é€Ÿéƒ¨ç½²
â”‚   â”‚
â”‚   â””â”€ å¦ â†’ CloudNativePG
â”‚       â””â”€ äº‘åŸç”Ÿç¯å¢ƒã€CNCFæ ‡å‡†åŒ–
```

**è¿ç§»æŒ‡å—**:

```bash
# ä»StatefulSetè¿ç§»åˆ°Operator
# 1. å¤‡ä»½æ•°æ®
pg_dump -h old_postgres -U postgres -d mydb -F c -f backup.dump

# 2. å®‰è£…Operator
helm install postgres-operator <operator-chart>

# 3. åˆ›å»ºPostgresCluster
kubectl apply -f postgres-cluster.yaml

# 4. ç­‰å¾…é›†ç¾¤å°±ç»ª
kubectl wait --for=condition=ready postgrescluster/postgres-cluster

# 5. æ¢å¤æ•°æ®
pg_restore -h new_postgres -U postgres -d mydb -F c backup.dump

# 6. éªŒè¯æ•°æ®
psql -h new_postgres -U postgres -d mydb -c "SELECT count(*) FROM table_name;"

# 7. åˆ‡æ¢åº”ç”¨è¿æ¥
# æ›´æ–°åº”ç”¨è¿æ¥å­—ç¬¦ä¸²æŒ‡å‘æ–°é›†ç¾¤

# 8. åˆ é™¤æ—§StatefulSet
kubectl delete statefulset old-postgres
```

## 9. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­

### 9.1 å®¹å™¨åŒ–é—®é¢˜æ’æŸ¥

**å®¹å™¨åŒ–é—®é¢˜è¯Šæ–­**:

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a | grep postgres
docker logs postgres

# 2. æ£€æŸ¥èµ„æºä½¿ç”¨
docker stats postgres

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network inspect postgres_network

# 4. æ£€æŸ¥æ•°æ®å·
docker volume inspect postgres_data

# 5. è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it postgres bash

# 6. æ£€æŸ¥PostgreSQLé…ç½®
docker exec postgres cat /etc/postgresql/postgresql.conf
```

**å¸¸è§å®¹å™¨åŒ–é—®é¢˜**:

```bash
# é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥
# åŸå› : é…ç½®é”™è¯¯æˆ–èµ„æºä¸è¶³
# è§£å†³: æ£€æŸ¥æ—¥å¿—å’Œèµ„æº
docker logs postgres
docker stats postgres

# é—®é¢˜2: æ•°æ®æŒä¹…åŒ–å¤±è´¥
# åŸå› : å·æŒ‚è½½é—®é¢˜æˆ–æƒé™é—®é¢˜
# è§£å†³: æ£€æŸ¥å·æŒ‚è½½å’Œæƒé™
docker volume inspect postgres_data
docker exec postgres ls -la /var/lib/postgresql/data

# é—®é¢˜3: ç½‘ç»œè¿æ¥é—®é¢˜
# åŸå› : ç½‘ç»œé…ç½®é”™è¯¯
# è§£å†³: æ£€æŸ¥ç½‘ç»œé…ç½®
docker network inspect postgres_network
```

### 9.2 Kubernetesé—®é¢˜æ’æŸ¥

**Kubernetesé—®é¢˜è¯Šæ–­**:

```bash
# 1. æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -n postgres
kubectl describe pod postgres-0 -n postgres

# 2. æ£€æŸ¥Podæ—¥å¿—
kubectl logs postgres-0 -n postgres
kubectl logs postgres-0 -n postgres --previous

# 3. æ£€æŸ¥èµ„æºä½¿ç”¨
kubectl top pod postgres-0 -n postgres
kubectl top node

# 4. æ£€æŸ¥å­˜å‚¨
kubectl get pvc -n postgres
kubectl describe pvc postgres-storage-postgres-0 -n postgres

# 5. æ£€æŸ¥ç½‘ç»œ
kubectl get svc -n postgres
kubectl get endpoints -n postgres

# 6. æ£€æŸ¥äº‹ä»¶
kubectl get events -n postgres --sort-by='.lastTimestamp'
```

**å¸¸è§Kubernetesé—®é¢˜**:

```bash
# é—®é¢˜1: Podä¸€ç›´å¤„äºPendingçŠ¶æ€
# åŸå› : èµ„æºä¸è¶³æˆ–è°ƒåº¦é—®é¢˜
# è§£å†³: æ£€æŸ¥èŠ‚ç‚¹èµ„æº
kubectl describe node <node-name>
kubectl get nodes

# é—®é¢˜2: Podä¸€ç›´å¤„äºCrashLoopBackOffçŠ¶æ€
# åŸå› : å®¹å™¨å¯åŠ¨å¤±è´¥
# è§£å†³: æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºé”™è¯¯
kubectl logs postgres-0 -n postgres --previous

# é—®é¢˜3: å­˜å‚¨å·æ— æ³•æŒ‚è½½
# åŸå› : PVCæœªåˆ›å»ºæˆ–å­˜å‚¨ç±»é—®é¢˜
# è§£å†³: æ£€æŸ¥PVCå’ŒStorageClass
kubectl get pvc -n postgres
kubectl get storageclass
```

### 9.3 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# scripts/cloudnative_performance_diagnosis.sh

echo "=== äº‘åŸç”ŸPostgreSQLæ€§èƒ½è¯Šæ–­ ==="

# 1. å®¹å™¨/K8sèµ„æºä½¿ç”¨
if command -v docker &> /dev/null; then
    echo "=== Dockerå®¹å™¨èµ„æºä½¿ç”¨ ==="
    docker stats --no-stream postgres
elif command -v kubectl &> /dev/null; then
    echo "=== Kubernetes Podèµ„æºä½¿ç”¨ ==="
    kubectl top pods -n postgres
fi

# 2. æ•°æ®åº“è¿æ¥æ•°
echo "=== æ•°æ®åº“è¿æ¥æ•° ==="
psql -h localhost -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 3. æ…¢æŸ¥è¯¢
echo "=== æ…¢æŸ¥è¯¢Top 10 ==="
psql -h localhost -U postgres -c "SELECT query, calls, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# 4. I/Oæ€§èƒ½ï¼ˆPostgreSQL 18ï¼‰
echo "=== I/Oæ€§èƒ½ ==="
psql -h localhost -U postgres -c "SELECT object, context, reads, writes, read_time, write_time FROM pg_stat_io ORDER BY reads DESC LIMIT 10;"
```

## 10. ç›‘æ§å’Œå‘Šè­¦é…ç½®

### 10.1 Prometheusç›‘æ§é›†æˆ

**å®Œæ•´çš„Prometheusé…ç½®**:

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
    - job_name: 'postgres'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - postgres
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: postgres
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        action: keep
        regex: metrics
```

**ServiceMonitoré…ç½®**:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### 10.2 Grafanaä»ªè¡¨æ¿é…ç½®

**Grafanaæ•°æ®æºé…ç½®**:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource
  namespace: monitoring
data:
  datasource.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus:9090
      isDefault: true
```

**Grafanaä»ªè¡¨æ¿é…ç½®**:

```json
{
  "dashboard": {
    "title": "PostgreSQLäº‘åŸç”Ÿç›‘æ§",
    "panels": [
      {
        "title": "å®¹å™¨CPUä½¿ç”¨ç‡",
        "targets": [
          {
            "expr": "rate(container_cpu_usage_seconds_total{name=\"postgres\"}[5m]) * 100"
          }
        ]
      },
      {
        "title": "å®¹å™¨å†…å­˜ä½¿ç”¨",
        "targets": [
          {
            "expr": "container_memory_usage_bytes{name=\"postgres\"}"
          }
        ]
      },
      {
        "title": "PostgreSQLè¿æ¥æ•°",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"mydb\"}"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢QPS",
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])"
          }
        ]
      }
    ]
  }
}
```

### 10.3 å‘Šè­¦è§„åˆ™é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-cloudnative-alerts
  namespace: monitoring
spec:
  groups:
  - name: postgres_cloudnative
    interval: 30s
    rules:
    - alert: PostgreSQLContainerDown
      expr: up{job="postgres"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL container is down"
        description: "PostgreSQL container {{ $labels.instance }} is down"

    - alert: PostgreSQLHighCPU
      expr: rate(container_cpu_usage_seconds_total{name="postgres"}[5m]) * 100 > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL CPU usage is high"
        description: "CPU usage is {{ $value }}%"

    - alert: PostgreSQLHighMemory
      expr: container_memory_usage_bytes{name="postgres"} / container_spec_memory_limit_bytes{name="postgres"} > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL memory usage is high"
        description: "Memory usage is {{ $value | humanizePercentage }}"
```

---

## 11. åç»­æ•´åˆä»»åŠ¡

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [Docker éƒ¨ç½²æŒ‡å—](./05.12-Dockeréƒ¨ç½².md) - Dockeréƒ¨ç½²
- â­â­â­ [Kubernetes éƒ¨ç½²æŒ‡å—](./05.13-Kuberneteséƒ¨ç½².md) - Kuberneteséƒ¨ç½²
- â­â­ [Serverlesséƒ¨ç½²](./05.15-Serverlesséƒ¨ç½².md) - Serverlessæ¶æ„
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](../../../01-æ ¸å¿ƒåŸºç¡€/01.02-ç³»ç»Ÿæ¶æ„/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„åŸºç¡€
- â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

#### å‰æ²¿æŠ€æœ¯

- â­â­ [AIä¸æœºå™¨å­¦ä¹ ](../../../10-AIä¸æœºå™¨å­¦ä¹ /README.md) - Serverlessæ¶æ„ä¸åˆ†æ”¯åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
