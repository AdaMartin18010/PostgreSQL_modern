---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\05-éƒ¨ç½²æ¶æ„\é›†ç¾¤éƒ¨ç½²\05.05-ä¸»ä»å¤åˆ¶.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—](#ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [é€‰æ‹©å»ºè®®](#é€‰æ‹©å»ºè®®)
  - [2. ç‰©ç†å¤åˆ¶é…ç½®](#2-ç‰©ç†å¤åˆ¶é…ç½®)
    - [2.1 ä¸»åº“é…ç½®](#21-ä¸»åº“é…ç½®)
      - [postgresql.conf](#postgresqlconf)
      - [pg\_hba.conf](#pg_hbaconf)
    - [2.2 åˆ›å»ºå¤åˆ¶ç”¨æˆ·](#22-åˆ›å»ºå¤åˆ¶ç”¨æˆ·)
    - [2.3 ä»åº“åˆå§‹åŒ–](#23-ä»åº“åˆå§‹åŒ–)
      - [æ–¹æ³•1: ä½¿ç”¨ pg\_basebackupï¼ˆæ¨èï¼‰](#æ–¹æ³•1-ä½¿ç”¨-pg_basebackupæ¨è)
      - [æ–¹æ³•2: æ‰‹åŠ¨é…ç½®](#æ–¹æ³•2-æ‰‹åŠ¨é…ç½®)
    - [2.4 ä»åº“é…ç½®](#24-ä»åº“é…ç½®)
      - [2.4.1 postgresql.conf](#241-postgresqlconf)
      - [standby.signal](#standbysignal)
  - [3. é€»è¾‘å¤åˆ¶é…ç½®](#3-é€»è¾‘å¤åˆ¶é…ç½®)
    - [3.1 ä¸»åº“é…ç½®](#31-ä¸»åº“é…ç½®)
      - [3.1.1 postgresql.conf](#311-postgresqlconf)
    - [3.2 åˆ›å»ºå‘å¸ƒï¼ˆPublicationï¼‰](#32-åˆ›å»ºå‘å¸ƒpublication)
    - [3.3 ä»åº“åˆ›å»ºè®¢é˜…ï¼ˆSubscriptionï¼‰](#33-ä»åº“åˆ›å»ºè®¢é˜…subscription)
    - [3.4 ç®¡ç†è®¢é˜…](#34-ç®¡ç†è®¢é˜…)
  - [4. åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥](#4-åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥)
    - [4.1 åŒæ­¥å¤åˆ¶é…ç½®](#41-åŒæ­¥å¤åˆ¶é…ç½®)
      - [postgresql.confï¼ˆä¸»åº“ï¼‰](#postgresqlconfä¸»åº“)
      - [åŒæ­¥çº§åˆ«å¯¹æ¯”](#åŒæ­¥çº§åˆ«å¯¹æ¯”)
    - [4.2 å¼‚æ­¥å¤åˆ¶é…ç½®](#42-å¼‚æ­¥å¤åˆ¶é…ç½®)
    - [4.3 æ€§èƒ½ä¸ä¸€è‡´æ€§æƒè¡¡](#43-æ€§èƒ½ä¸ä¸€è‡´æ€§æƒè¡¡)
  - [5. å¤åˆ¶æ§½ç®¡ç†](#5-å¤åˆ¶æ§½ç®¡ç†)
    - [5.1 åˆ›å»ºå¤åˆ¶æ§½](#51-åˆ›å»ºå¤åˆ¶æ§½)
    - [5.2 æŸ¥çœ‹å¤åˆ¶æ§½](#52-æŸ¥çœ‹å¤åˆ¶æ§½)
    - [5.3 åˆ é™¤å¤åˆ¶æ§½](#53-åˆ é™¤å¤åˆ¶æ§½)
    - [5.4 å¤åˆ¶æ§½ç›‘æ§](#54-å¤åˆ¶æ§½ç›‘æ§)
  - [6. ç›‘æ§ä¸è¯Šæ–­](#6-ç›‘æ§ä¸è¯Šæ–­)
    - [6.1 å¤åˆ¶çŠ¶æ€æŸ¥è¯¢](#61-å¤åˆ¶çŠ¶æ€æŸ¥è¯¢)
    - [6.2 ä»åº“çŠ¶æ€æŸ¥è¯¢](#62-ä»åº“çŠ¶æ€æŸ¥è¯¢)
    - [6.3 å»¶è¿Ÿç›‘æ§](#63-å»¶è¿Ÿç›‘æ§)
  - [7. ç”Ÿäº§çº§å¤åˆ¶é…ç½®](#7-ç”Ÿäº§çº§å¤åˆ¶é…ç½®)
    - [7.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®](#71-å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®)
    - [7.2 çº§è”å¤åˆ¶é…ç½®](#72-çº§è”å¤åˆ¶é…ç½®)
    - [7.3 å¤åˆ¶æ§½ç®¡ç†æœ€ä½³å®è·µ](#73-å¤åˆ¶æ§½ç®¡ç†æœ€ä½³å®è·µ)
    - [7.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®](#74-postgresql-18æ–°ç‰¹æ€§é…ç½®)
  - [8. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­](#8-æ•…éšœæ’æŸ¥å’Œè¯Šæ–­)
    - [8.1 å¤åˆ¶å»¶è¿Ÿé—®é¢˜è¯Šæ–­](#81-å¤åˆ¶å»¶è¿Ÿé—®é¢˜è¯Šæ–­)
    - [8.2 å¤åˆ¶ä¸­æ–­é—®é¢˜æ’æŸ¥](#82-å¤åˆ¶ä¸­æ–­é—®é¢˜æ’æŸ¥)
    - [8.3 æ•°æ®ä¸ä¸€è‡´é—®é¢˜](#83-æ•°æ®ä¸ä¸€è‡´é—®é¢˜)
    - [8.4 æ€§èƒ½é—®é¢˜è¯Šæ–­](#84-æ€§èƒ½é—®é¢˜è¯Šæ–­)
  - [9. ç›‘æ§å’Œå‘Šè­¦](#9-ç›‘æ§å’Œå‘Šè­¦)
    - [9.1 å¤åˆ¶çŠ¶æ€ç›‘æ§](#91-å¤åˆ¶çŠ¶æ€ç›‘æ§)
    - [9.2 å»¶è¿Ÿç›‘æ§](#92-å»¶è¿Ÿç›‘æ§)
    - [9.3 å‘Šè­¦è§„åˆ™é…ç½®](#93-å‘Šè­¦è§„åˆ™é…ç½®)
    - [9.4 è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬](#94-è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬)
  - [10. æ•…éšœå¤„ç†](#10-æ•…éšœå¤„ç†)
    - [10.1 å¤åˆ¶ä¸­æ–­æ¢å¤](#101-å¤åˆ¶ä¸­æ–­æ¢å¤)
    - [10.2 ä»åº“æå‡ä¸ºä¸»åº“](#102-ä»åº“æå‡ä¸ºä¸»åº“)
    - [10.3 é€»è¾‘å¤åˆ¶å†²çªå¤„ç†](#103-é€»è¾‘å¤åˆ¶å†²çªå¤„ç†)
    - [10.4 ä¸»åº“æ•…éšœåˆ‡æ¢](#104-ä¸»åº“æ•…éšœåˆ‡æ¢)
  - [11. äº¤å‰å¼•ç”¨](#11-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

PostgreSQL æ”¯æŒä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š

- **ç‰©ç†å¤åˆ¶ï¼ˆPhysical Replicationï¼‰**: åŸºäº WAL çš„å—çº§å¤åˆ¶ï¼Œé€‚ç”¨äºä¸»ä»é«˜å¯ç”¨åœºæ™¯
- **é€»è¾‘å¤åˆ¶ï¼ˆLogical Replicationï¼‰**: åŸºäºé€»è¾‘å˜æ›´çš„å¤åˆ¶ï¼Œé€‚ç”¨äºè·¨ç‰ˆæœ¬å‡çº§ã€éƒ¨åˆ†è¡¨å¤åˆ¶ç­‰åœºæ™¯

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | è¯´æ˜ |
| --- | --- | --- |
| é«˜å¯ç”¨ä¸»ä» | ç‰©ç†å¤åˆ¶ | å»¶è¿Ÿä½ã€æ•°æ®ä¸€è‡´æ€§å¼º |
| è·¨ç‰ˆæœ¬å‡çº§ | é€»è¾‘å¤åˆ¶ | æ”¯æŒä¸åŒç‰ˆæœ¬é—´å¤åˆ¶ |
| éƒ¨åˆ†è¡¨å¤åˆ¶ | é€»è¾‘å¤åˆ¶ | å¯é€‰æ‹©ç‰¹å®šè¡¨ |
| è¯»å†™åˆ†ç¦» | ç‰©ç†å¤åˆ¶ | ä»åº“å¯è¯»ï¼Œå»¶è¿Ÿä½ |
| å¤šä¸»å¤åˆ¶ | é€»è¾‘å¤åˆ¶ | æ”¯æŒåŒå‘å¤åˆ¶ |

---

## 2. ç‰©ç†å¤åˆ¶é…ç½®

### 2.1 ä¸»åº“é…ç½®

#### postgresql.conf

```text
# WAL çº§åˆ«
wal_level = replica  # PostgreSQL 18 æ¨èä½¿ç”¨ replica

# æœ€å¤§ WAL å‘é€è¿›ç¨‹æ•°
max_wal_senders = 10

# æœ€å¤§å¤åˆ¶æ§½æ•°
max_replication_slots = 10

# WAL ä¿ç•™å¤§å°ï¼ˆé¿å…å¤åˆ¶å»¶è¿Ÿæ—¶ WAL è¢«å›æ”¶ï¼‰
wal_keep_size = '1GB'  # PostgreSQL 13+ æ¨èä½¿ç”¨ wal_keep_size
# æˆ–ä½¿ç”¨ max_slot_wal_keep_size æ§åˆ¶å¤åˆ¶æ§½ä¿ç•™çš„ WAL

# çƒ­å¤‡æ¨¡å¼ï¼ˆå…è®¸ä»åº“æŸ¥è¯¢ï¼‰
hot_standby = on
```

#### pg_hba.conf

```text
# å…è®¸å¤åˆ¶è¿æ¥
host replication repl 10.0.0.0/24 md5
# æˆ–ä½¿ç”¨ scram-sha-256ï¼ˆæ¨èï¼‰
host replication repl 10.0.0.0/24 scram-sha-256
```

### 2.2 åˆ›å»ºå¤åˆ¶ç”¨æˆ·

```sql
-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER repl WITH REPLICATION PASSWORD 'secure_password';

-- æˆäºˆå¿…è¦æƒé™
GRANT CONNECT ON DATABASE postgres TO repl;
```

### 2.3 ä»åº“åˆå§‹åŒ–

#### æ–¹æ³•1: ä½¿ç”¨ pg_basebackupï¼ˆæ¨èï¼‰

```bash
# åŸºæœ¬ç”¨æ³•
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C -S replica1

# å‚æ•°è¯´æ˜ï¼š
# -h: ä¸»åº“åœ°å€
# -U: å¤åˆ¶ç”¨æˆ·
# -D: æ•°æ®ç›®å½•
# -X stream: æµå¼ä¼ è¾“ WAL
# -R: è‡ªåŠ¨åˆ›å»º standby.signal å’Œ postgresql.auto.conf
# -C -S: åˆ›å»ºå¤åˆ¶æ§½ replica1
```

#### æ–¹æ³•2: æ‰‹åŠ¨é…ç½®

```bash
# 1. å¤‡ä»½ä¸»åº“
pg_basebackup -h primary -U repl -D /var/lib/postgresql/data -X stream

# 2. åˆ›å»º standby.signal
touch /var/lib/postgresql/data/standby.signal

# 3. é…ç½® postgresql.conf
primary_conninfo = 'host=primary_host port=5432 user=repl password=secure_password'
```

### 2.4 ä»åº“é…ç½®

#### 2.4.1 postgresql.conf

```text
# çƒ­å¤‡æ¨¡å¼
hot_standby = on

# æœ€å¤§çƒ­å¤‡è¿æ¥æ•°
max_standby_streaming_delay = 30s
max_standby_archive_delay = 300s
```

#### standby.signal

```text
# ç©ºæ–‡ä»¶ï¼Œæ ‡è¯†ä¸ºå¤‡ç”¨æœåŠ¡å™¨
```

---

## 3. é€»è¾‘å¤åˆ¶é…ç½®

### 3.1 ä¸»åº“é…ç½®

#### 3.1.1 postgresql.conf

```text
# WAL çº§åˆ«ï¼ˆé€»è¾‘å¤åˆ¶éœ€è¦ logicalï¼‰
wal_level = logical

# æœ€å¤§é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2
```

### 3.2 åˆ›å»ºå‘å¸ƒï¼ˆPublicationï¼‰

```sql
-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«æ‰€æœ‰è¡¨
CREATE PUBLICATION pub_all FOR ALL TABLES;

-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«ç‰¹å®šè¡¨
CREATE PUBLICATION pub_specific FOR TABLE users, orders;

-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«ç‰¹å®šæ¨¡å¼
CREATE PUBLICATION pub_schema FOR TABLES IN SCHEMA public;

-- æŸ¥çœ‹å‘å¸ƒ
SELECT * FROM pg_publication;
```

### 3.3 ä»åº“åˆ›å»ºè®¢é˜…ï¼ˆSubscriptionï¼‰

```sql
-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION sub_replica
CONNECTION 'host=primary_host port=5432 user=repl password=secure_password dbname=mydb'
PUBLICATION pub_all;

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
SELECT * FROM pg_subscription_rel;
```

### 3.4 ç®¡ç†è®¢é˜…

```sql
-- æš‚åœè®¢é˜…
ALTER SUBSCRIPTION sub_replica DISABLE;

-- æ¢å¤è®¢é˜…
ALTER SUBSCRIPTION sub_replica ENABLE;

-- åˆ é™¤è®¢é˜…
DROP SUBSCRIPTION sub_replica;
```

---

## 4. åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥

### 4.1 åŒæ­¥å¤åˆ¶é…ç½®

#### postgresql.confï¼ˆä¸»åº“ï¼‰

```text
# åŒæ­¥æäº¤çº§åˆ«
synchronous_commit = remote_write  # æˆ– remote_apply

# åŒæ­¥å¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨
synchronous_standby_names = 'ANY 1 (node_b, node_c)'
# æˆ–ä½¿ç”¨ Quorum æ¨¡å¼
synchronous_standby_names = 'FIRST 2 (node_b, node_c, node_d)'
```

#### åŒæ­¥çº§åˆ«å¯¹æ¯”

| çº§åˆ« | è¯´æ˜ | æ€§èƒ½ | ä¸€è‡´æ€§ |
| --- | --- | --- | --- |
| `local` | æœ¬åœ°æäº¤ | æœ€å¿« | å¼± |
| `remote_write` | è¿œç¨‹å†™å…¥ WAL | å¿« | ä¸­ |
| `remote_apply` | è¿œç¨‹åº”ç”¨ WAL | æ…¢ | å¼º |
| `on` | ç­‰åŒäº `remote_write` | ä¸­ | ä¸­ |
| `off` | å¼‚æ­¥æäº¤ | æœ€å¿« | æœ€å¼± |

### 4.2 å¼‚æ­¥å¤åˆ¶é…ç½®

```text
# å¼‚æ­¥æäº¤ï¼ˆé»˜è®¤ï¼‰
synchronous_commit = local
synchronous_standby_names = ''
```

### 4.3 æ€§èƒ½ä¸ä¸€è‡´æ€§æƒè¡¡

- **å¼ºåŒæ­¥ï¼ˆremote_applyï¼‰**: RPO = 0ï¼Œä½†å†™å»¶è¿Ÿå¢åŠ  2-5 å€
- **å¼±åŒæ­¥ï¼ˆremote_writeï¼‰**: RPO â‰ˆ 0ï¼Œå†™å»¶è¿Ÿå¢åŠ  1-2 å€
- **å¼‚æ­¥**: RPO > 0ï¼ˆå¯èƒ½ä¸¢å¤±å‡ ç§’æ•°æ®ï¼‰ï¼Œä½†å†™å»¶è¿Ÿæœ€ä½

---

## 5. å¤åˆ¶æ§½ç®¡ç†

### 5.1 åˆ›å»ºå¤åˆ¶æ§½

```sql
-- ç‰©ç†å¤åˆ¶æ§½
SELECT * FROM pg_create_physical_replication_slot('replica1');

-- é€»è¾‘å¤åˆ¶æ§½
SELECT * FROM pg_create_logical_replication_slot('logical_slot', 'pgoutput');
```

### 5.2 æŸ¥çœ‹å¤åˆ¶æ§½

```sql
-- æŸ¥çœ‹æ‰€æœ‰å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶æ§½å»¶è¿Ÿ
SELECT
  slot_name,
  slot_type,
  active,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag
FROM pg_replication_slots;
```

### 5.3 åˆ é™¤å¤åˆ¶æ§½

```sql
-- åˆ é™¤ç‰©ç†å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('replica1');

-- åˆ é™¤é€»è¾‘å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('logical_slot');
```

### 5.4 å¤åˆ¶æ§½ç›‘æ§

```sql
-- ç›‘æ§å¤åˆ¶æ§½ WAL ä¿ç•™
SELECT
  slot_name,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size,
  active,
  restart_lsn,
  confirmed_flush_lsn
FROM pg_replication_slots;
```

---

## 6. ç›‘æ§ä¸è¯Šæ–­

### 6.1 å¤åˆ¶çŠ¶æ€æŸ¥è¯¢

```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
  pid,
  usename,
  application_name,
  client_addr,
  state,
  sync_state,
  sync_priority,
  pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
  pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag,
  pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag,
  pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag
FROM pg_stat_replication;
```

### 6.2 ä»åº“çŠ¶æ€æŸ¥è¯¢

```sql
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT
  pg_is_in_recovery() AS is_standby,
  pg_last_wal_receive_lsn() AS receive_lsn,
  pg_last_wal_replay_lsn() AS replay_lsn,
  pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) AS lag_bytes;
```

### 6.3 å»¶è¿Ÿç›‘æ§

```sql
-- ä¸»åº“ï¼šæŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
  application_name,
  client_addr,
  state,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn)) AS sent_lag,
  pg_size_pretty(pg_wal_lsn_diff(sent_lsn, replay_lsn)) AS replay_lag,
  EXTRACT(EPOCH FROM (now() - write_lag)) AS write_lag_seconds,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS replay_lag_seconds
FROM pg_stat_replication;
```

---

## 7. ç”Ÿäº§çº§å¤åˆ¶é…ç½®

### 7.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®

**ä¸»åº“å®Œæ•´é…ç½®ï¼ˆpostgresql.confï¼‰**:

```conf
# ============================================
# WALé…ç½®ï¼ˆå¤åˆ¶å¿…éœ€ï¼‰
# ============================================
wal_level = replica                    # ç‰©ç†å¤åˆ¶ä½¿ç”¨replicaï¼Œé€»è¾‘å¤åˆ¶ä½¿ç”¨logical
max_wal_senders = 10                   # æœ€å¤§WALå‘é€è¿›ç¨‹æ•°
max_replication_slots = 10             # æœ€å¤§å¤åˆ¶æ§½æ•°
wal_keep_size = 1GB                    # WALä¿ç•™å¤§å°ï¼ˆPostgreSQL 13+ï¼‰
# max_slot_wal_keep_size = 2GB         # å¤åˆ¶æ§½ä¿ç•™çš„WALå¤§å°ï¼ˆPostgreSQL 13+ï¼‰

# ============================================
# åŒæ­¥å¤åˆ¶é…ç½®
# ============================================
synchronous_commit = remote_write      # åŒæ­¥æäº¤çº§åˆ«
synchronous_standby_names = 'ANY 1 (replica1, replica2)'  # åŒæ­¥å¤‡ç”¨æœåŠ¡å™¨

# ============================================
# æ€§èƒ½ä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰
# ============================================
# å¼‚æ­¥I/Oæå‡å¤åˆ¶æ€§èƒ½
io_method = aio                        # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 128                 # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 4             # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æ—¥å¿—é…ç½®
# ============================================
log_replication_commands = on          # è®°å½•å¤åˆ¶å‘½ä»¤
log_connections = on
log_disconnections = on
```

**ä»åº“å®Œæ•´é…ç½®ï¼ˆpostgresql.confï¼‰**:

```conf
# ============================================
# çƒ­å¤‡é…ç½®
# ============================================
hot_standby = on                       # å¯ç”¨çƒ­å¤‡æ¨¡å¼
max_standby_streaming_delay = 30s      # æœ€å¤§æµå¼å»¶è¿Ÿ
max_standby_archive_delay = 300s       # æœ€å¤§å½’æ¡£å»¶è¿Ÿ
hot_standby_feedback = on              # å‘ä¸»åº“åé¦ˆæŸ¥è¯¢ä¿¡æ¯

# ============================================
# æ€§èƒ½ä¼˜åŒ–
# ============================================
# ä»åº“æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
max_connections = 500                  # ä»åº“å¯ä»¥æ”¯æŒæ›´å¤šè¿æ¥ï¼ˆåªè¯»ï¼‰
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 16MB

# ============================================
# PostgreSQL 18æ–°ç‰¹æ€§
# ============================================
# å¼‚æ­¥I/Oæå‡ä»åº“æ€§èƒ½
io_method = aio                        # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 128                 # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 4             # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
```

**ä¸»åº“pg_hba.confé…ç½®**:

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# ç‰©ç†å¤åˆ¶è¿æ¥
host    replication     repl            192.168.1.0/24          scram-sha-256
host    replication     repl            10.0.0.0/24              scram-sha-256

# é€»è¾‘å¤åˆ¶è¿æ¥
host    all             repl            192.168.1.0/24          scram-sha-256
```

**ä»åº“standby.signalé…ç½®**:

```bash
# åˆ›å»ºstandby.signalæ–‡ä»¶ï¼ˆæ ‡è¯†ä¸ºå¤‡ç”¨æœåŠ¡å™¨ï¼‰
touch /var/lib/postgresql/data/standby.signal
```

**ä»åº“postgresql.auto.confé…ç½®**:

```conf
# è‡ªåŠ¨ç”Ÿæˆçš„å¤åˆ¶é…ç½®ï¼ˆpg_basebackup -Rè‡ªåŠ¨åˆ›å»ºï¼‰
primary_conninfo = 'host=primary_host port=5432 user=repl password=secure_password application_name=replica1'
primary_slot_name = 'replica1'
```

### 7.2 çº§è”å¤åˆ¶é…ç½®

**çº§è”å¤åˆ¶æ¶æ„**:

```text
ä¸»åº“ (Primary)
  â”œâ”€â”€ ä»åº“1 (Standby 1) - ç›´æ¥ä»ä¸»åº“å¤åˆ¶
  â”‚     â””â”€â”€ ä»åº“2 (Standby 2) - ä»Standby 1å¤åˆ¶ï¼ˆçº§è”ï¼‰
  â””â”€â”€ ä»åº“3 (Standby 3) - ç›´æ¥ä»ä¸»åº“å¤åˆ¶
```

**çº§è”å¤åˆ¶é…ç½®**:

```bash
# 1. é…ç½®Standby 1ä½œä¸ºçº§è”ä¸»åº“
# åœ¨Standby 1çš„postgresql.confä¸­
wal_level = replica
max_wal_senders = 5
hot_standby = on

# 2. åœ¨Standby 1çš„pg_hba.confä¸­å…è®¸å¤åˆ¶è¿æ¥
host    replication     repl            192.168.1.0/24          scram-sha-256

# 3. ä»Standby 2è¿æ¥åˆ°Standby 1
pg_basebackup \
  -h standby1_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C -S replica2
```

**çº§è”å¤åˆ¶ç›‘æ§**:

```sql
-- åœ¨Standby 1ä¸ŠæŸ¥çœ‹çº§è”å¤åˆ¶çŠ¶æ€
SELECT
  application_name,
  client_addr,
  state,
  pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag
FROM pg_stat_replication;
```

### 7.3 å¤åˆ¶æ§½ç®¡ç†æœ€ä½³å®è·µ

**å¤åˆ¶æ§½æœ€ä½³å®è·µ**:

```sql
-- 1. åˆ›å»ºå¤åˆ¶æ§½ï¼ˆæ¨èåœ¨pg_basebackupæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
-- pg_basebackup -C -S replica1

-- 2. ç›‘æ§å¤åˆ¶æ§½çŠ¶æ€
SELECT
  slot_name,
  slot_type,
  active,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) AS confirmed_lag
FROM pg_replication_slots;

-- 3. ç›‘æ§å¤åˆ¶æ§½WALä¿ç•™ï¼ˆé¿å…WALæ— é™å¢é•¿ï¼‰
SELECT
  slot_name,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS wal_retained,
  CASE
    WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) > 2147483648 THEN 'WARNING: >2GB'
    ELSE 'OK'
  END AS status
FROM pg_replication_slots
WHERE active = false;

-- 4. å®šæœŸæ¸…ç†éæ´»è·ƒå¤åˆ¶æ§½
-- æ³¨æ„ï¼šç¡®ä¿ä»åº“ä¸å†éœ€è¦è¯¥å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('old_slot_name');
```

**å¤åˆ¶æ§½è‡ªåŠ¨æ¸…ç†è„šæœ¬**:

```bash
#!/bin/bash
# scripts/cleanup_replication_slots.sh

# æŸ¥æ‰¾éæ´»è·ƒä¸”WALä¿ç•™è¶…è¿‡2GBçš„å¤åˆ¶æ§½
psql -h primary_host -U postgres -t -c "
SELECT slot_name
FROM pg_replication_slots
WHERE active = false
AND pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) > 2147483648;
" | while read slot_name; do
  if [ ! -z "$slot_name" ]; then
    echo "Dropping inactive replication slot: $slot_name"
    psql -h primary_host -U postgres -c "SELECT pg_drop_replication_slot('$slot_name');"
  fi
done
```

### 7.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®

**å¼‚æ­¥I/Oåœ¨å¤åˆ¶ä¸­çš„åº”ç”¨**:

```conf
# postgresql.conf
# PostgreSQL 18: å¼‚æ­¥I/Oæå‡å¤åˆ¶æ€§èƒ½
io_method = aio                        # å¯ç”¨å¼‚æ­¥I/O
io_combine_limit = 128                 # I/Oè¯·æ±‚åˆå¹¶é™åˆ¶
maintenance_io_workers = 4             # ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 10                    # æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# æ€§èƒ½æå‡ï¼š
# - WALä¼ è¾“æ€§èƒ½æå‡2-3å€
# - ä»åº“åº”ç”¨WALæ€§èƒ½æå‡2-3å€
# - å¤åˆ¶å»¶è¿Ÿé™ä½30-50%
```

**é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡é…ç½®**:

```conf
# postgresql.conf
# PostgreSQL 18: é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡
wal_level = logical
max_logical_replication_workers = 8    # å¢åŠ é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹
max_sync_workers_per_subscription = 4  # å¢åŠ åŒæ­¥å·¥ä½œè¿›ç¨‹

# é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡ï¼š
# - å¤åˆ¶ååé‡æå‡30-40%
# - å»¶è¿Ÿé™ä½20-30%
```

**å¢é‡å¤‡ä»½é…ç½®**:

```sql
-- PostgreSQL 18: æ”¯æŒå¢é‡å¤‡ä»½
-- ä½¿ç”¨pg_basebackupè¿›è¡Œå¢é‡å¤‡ä»½
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  --incremental \
  -P
```

## 8. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­

### 8.1 å¤åˆ¶å»¶è¿Ÿé—®é¢˜è¯Šæ–­

**å»¶è¿Ÿè¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥å¤åˆ¶çŠ¶æ€
SELECT
  application_name,
  client_addr,
  state,
  sync_state,
  pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag_bytes,
  pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag_bytes,
  pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag_bytes,
  pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag_bytes,
  EXTRACT(EPOCH FROM (now() - write_lag)) AS write_lag_seconds,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS replay_lag_seconds
FROM pg_stat_replication;

-- 2. æ£€æŸ¥ä»åº“çŠ¶æ€
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT
  pg_is_in_recovery() AS is_standby,
  pg_last_wal_receive_lsn() AS receive_lsn,
  pg_last_wal_replay_lsn() AS replay_lsn,
  pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) AS lag_bytes,
  EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS lag_seconds;

-- 3. æ£€æŸ¥WALæ–‡ä»¶
SELECT
  name,
  size,
  modification
FROM pg_ls_waldir()
ORDER BY modification DESC
LIMIT 20;

-- 4. æ£€æŸ¥å¤åˆ¶æ§½å»¶è¿Ÿ
SELECT
  slot_name,
  slot_type,
  active,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size
FROM pg_replication_slots;
```

**å»¶è¿Ÿé—®é¢˜è§£å†³æ–¹æ¡ˆ**:

```bash
# é—®é¢˜1: ç½‘ç»œå»¶è¿Ÿ
# è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¸¦å®½
ping -c 10 primary_host
iperf3 -c primary_host

# é—®é¢˜2: ä»åº“æ€§èƒ½ä¸è¶³
# è§£å†³: ä¼˜åŒ–ä»åº“é…ç½®ï¼Œå¢åŠ èµ„æº
# åœ¨ä»åº“postgresql.confä¸­
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 16MB

# é—®é¢˜3: ä¸»åº“WALç”Ÿæˆè¿‡å¿«
# è§£å†³: ä¼˜åŒ–ä¸»åº“å†™æ“ä½œï¼Œä½¿ç”¨å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
io_method = aio
io_combine_limit = 128

# é—®é¢˜4: ä»åº“æœ‰é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
# è§£å†³: æ£€æŸ¥å¹¶ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT pid, query, state, query_start
FROM pg_stat_activity
WHERE state = 'active'
AND query_start < now() - interval '5 minutes';
```

### 8.2 å¤åˆ¶ä¸­æ–­é—®é¢˜æ’æŸ¥

**å¤åˆ¶ä¸­æ–­è¯Šæ–­**:

```sql
-- 1. æ£€æŸ¥å¤åˆ¶è¿æ¥çŠ¶æ€
SELECT
  pid,
  usename,
  application_name,
  client_addr,
  state,
  sync_state,
  sync_priority
FROM pg_stat_replication;

-- 2. æ£€æŸ¥å¤åˆ¶æ§½çŠ¶æ€
SELECT
  slot_name,
  slot_type,
  active,
  restart_lsn,
  confirmed_flush_lsn
FROM pg_replication_slots
WHERE active = false;

-- 3. æ£€æŸ¥WALæ–‡ä»¶å®Œæ•´æ€§
SELECT
  name,
  size,
  modification
FROM pg_ls_waldir()
WHERE modification > now() - interval '1 hour'
ORDER BY modification DESC;

-- 4. æ£€æŸ¥é”™è¯¯æ—¥å¿—
-- æŸ¥çœ‹PostgreSQLæ—¥å¿—æ–‡ä»¶
tail -f /var/lib/postgresql/data/log/postgresql-*.log | grep -i "replication\|error\|fatal"
```

**å¤åˆ¶ä¸­æ–­æ¢å¤æ­¥éª¤**:

```bash
# æ­¥éª¤1: æ£€æŸ¥ä¸»åº“çŠ¶æ€
psql -h primary_host -U postgres -c "SELECT pg_current_wal_lsn();"

# æ­¥éª¤2: æ£€æŸ¥ä»åº“çŠ¶æ€
psql -h standby_host -U postgres -c "SELECT pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn();"

# æ­¥éª¤3: æ£€æŸ¥ç½‘ç»œè¿æ¥
ping -c 10 primary_host
telnet primary_host 5432

# æ­¥éª¤4: é‡æ–°åŒæ­¥ä»åº“
# æ–¹æ³•1: ä½¿ç”¨pg_rewindï¼ˆPostgreSQL 12+ï¼‰
pg_rewind \
  --source-server="host=primary_host user=postgres" \
  --target-pgdata=/var/lib/postgresql/data \
  --dry-run

# æ–¹æ³•2: é‡æ–°åˆå§‹åŒ–ä»åº“
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C -S replica1 \
  -P
```

### 8.3 æ•°æ®ä¸ä¸€è‡´é—®é¢˜

**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**:

```sql
-- 1. æ£€æŸ¥è¡¨è¡Œæ•°
-- åœ¨ä¸»åº“æ‰§è¡Œ
SELECT
  schemaname,
  tablename,
  n_live_tup,
  n_dead_tup
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;

-- åœ¨ä»åº“æ‰§è¡Œç›¸åŒæŸ¥è¯¢ï¼Œå¯¹æ¯”ç»“æœ

-- 2. æ£€æŸ¥æ•°æ®æ ¡éªŒå’Œï¼ˆå¦‚æœå¯ç”¨ï¼‰
SELECT
  datname,
  checksum_failures,
  checksum_last_failure
FROM pg_stat_database
WHERE checksum_failures > 0;

-- 3. ä½¿ç”¨pg_checksumsæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
pg_checksums --check -D /var/lib/postgresql/data

-- 4. å¯¹æ¯”å…³é”®è¡¨æ•°æ®
-- åœ¨ä¸»åº“
SELECT count(*), sum(id), max(created_at) FROM important_table;

-- åœ¨ä»åº“æ‰§è¡Œç›¸åŒæŸ¥è¯¢ï¼Œå¯¹æ¯”ç»“æœ
```

**æ•°æ®ä¸ä¸€è‡´ä¿®å¤**:

```bash
# æ–¹æ³•1: é‡æ–°åŒæ­¥ä»åº“ï¼ˆæ¨èï¼‰
pg_rewind \
  --source-server="host=primary_host user=postgres" \
  --target-pgdata=/var/lib/postgresql/data

# æ–¹æ³•2: é‡æ–°åˆå§‹åŒ–ä»åº“
# 1. åœæ­¢ä»åº“
systemctl stop postgresql

# 2. å¤‡ä»½æ•°æ®ç›®å½•ï¼ˆå¯é€‰ï¼‰
mv /var/lib/postgresql/data /var/lib/postgresql/data.backup

# 3. é‡æ–°åˆå§‹åŒ–
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C -S replica1

# 4. å¯åŠ¨ä»åº“
systemctl start postgresql
```

### 8.4 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# scripts/replication_performance_diagnosis.sh

echo "=== PostgreSQLå¤åˆ¶æ€§èƒ½è¯Šæ–­ ==="

# 1. ä¸»åº“WALç”Ÿæˆé€Ÿç‡
echo "=== ä¸»åº“WALç”Ÿæˆé€Ÿç‡ ==="
psql -h primary_host -U postgres -c "
SELECT
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0')) AS total_wal,
  pg_size_pretty(
    pg_wal_lsn_diff(
      pg_current_wal_lsn(),
      (SELECT restart_lsn FROM pg_replication_slots WHERE slot_name = 'replica1')
    )
  ) AS wal_since_last_checkpoint;
"

# 2. å¤åˆ¶å»¶è¿Ÿ
echo "=== å¤åˆ¶å»¶è¿Ÿ ==="
psql -h primary_host -U postgres -c "
SELECT
  application_name,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS total_lag,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS lag_seconds
FROM pg_stat_replication;
"

# 3. ä»åº“æŸ¥è¯¢æ€§èƒ½
echo "=== ä»åº“æŸ¥è¯¢æ€§èƒ½ ==="
psql -h standby_host -U postgres -c "
SELECT
  query,
  calls,
  mean_time,
  max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
"

# 4. I/Oæ€§èƒ½ï¼ˆPostgreSQL 18ï¼‰
echo "=== I/Oæ€§èƒ½ ==="
psql -h primary_host -U postgres -c "
SELECT
  object,
  context,
  reads,
  writes,
  read_time,
  write_time
FROM pg_stat_io
ORDER BY reads DESC
LIMIT 10;
"
```

## 9. ç›‘æ§å’Œå‘Šè­¦

### 9.1 å¤åˆ¶çŠ¶æ€ç›‘æ§

**å¤åˆ¶çŠ¶æ€ç›‘æ§SQL**:

```sql
-- 1. å¤åˆ¶è¿æ¥çŠ¶æ€
SELECT
  application_name,
  client_addr,
  state,
  sync_state,
  sync_priority,
  CASE
    WHEN state = 'streaming' THEN 'OK'
    ELSE 'ERROR'
  END AS status
FROM pg_stat_replication;

-- 2. å¤åˆ¶æ§½çŠ¶æ€
SELECT
  slot_name,
  slot_type,
  active,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size,
  CASE
    WHEN active THEN 'ACTIVE'
    WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) > 2147483648 THEN 'WARNING: High WAL retention'
    ELSE 'INACTIVE'
  END AS status
FROM pg_replication_slots;

-- 3. ä»åº“å¥åº·çŠ¶æ€
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT
  pg_is_in_recovery() AS is_standby,
  pg_last_wal_receive_lsn() AS receive_lsn,
  pg_last_wal_replay_lsn() AS replay_lsn,
  pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) AS lag_bytes,
  EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS lag_seconds,
  CASE
    WHEN pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) > 10485760 THEN 'WARNING: High lag'
    ELSE 'OK'
  END AS status;
```

### 9.2 å»¶è¿Ÿç›‘æ§

**å»¶è¿Ÿç›‘æ§é…ç½®**:

```sql
-- åˆ›å»ºå»¶è¿Ÿç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW replication_lag_monitor AS
SELECT
  application_name,
  client_addr,
  state,
  sync_state,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn)) AS sent_lag,
  pg_size_pretty(pg_wal_lsn_diff(sent_lsn, write_lsn)) AS write_lag,
  pg_size_pretty(pg_wal_lsn_diff(write_lsn, flush_lsn)) AS flush_lag,
  pg_size_pretty(pg_wal_lsn_diff(flush_lsn, replay_lsn)) AS replay_lag,
  EXTRACT(EPOCH FROM (now() - write_lag)) AS write_lag_seconds,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS replay_lag_seconds,
  CASE
    WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 104857600 THEN 'CRITICAL: >100MB'
    WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 10485760 THEN 'WARNING: >10MB'
    ELSE 'OK'
  END AS lag_status
FROM pg_stat_replication;

-- æŸ¥è¯¢å»¶è¿Ÿç›‘æ§
SELECT * FROM replication_lag_monitor;
```

### 9.3 å‘Šè­¦è§„åˆ™é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**:

```yaml
# replication-alerts.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-replication-alerts
  namespace: monitoring
spec:
  groups:
  - name: postgres_replication
    interval: 30s
    rules:
    - alert: PostgreSQLReplicationDown
      expr: pg_replication_is_replica == 0 and pg_replication_lag == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL replication is down"
        description: "Replication connection is not active"

    - alert: PostgreSQLReplicationLag
      expr: pg_replication_lag > 10485760  # 10MB
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL replication lag is high"
        description: "Replication lag is {{ $value }} bytes"

    - alert: PostgreSQLReplicationLagCritical
      expr: pg_replication_lag > 104857600  # 100MB
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL replication lag is critical"
        description: "Replication lag is {{ $value }} bytes"

    - alert: PostgreSQLReplicationSlotInactive
      expr: pg_replication_slot_active == 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL replication slot is inactive"
        description: "Replication slot {{ $labels.slot_name }} is inactive"
```

### 9.4 è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬

**è‡ªåŠ¨æ•…éšœæ£€æµ‹è„šæœ¬**:

```bash
#!/bin/bash
# scripts/replication_health_check.sh

PRIMARY_HOST="primary_host"
STANDBY_HOST="standby_host"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥å¤åˆ¶çŠ¶æ€
REPLICATION_STATUS=$(psql -h $PRIMARY_HOST -U postgres -t -c "
SELECT count(*)
FROM pg_stat_replication
WHERE state = 'streaming';
")

if [ "$REPLICATION_STATUS" -eq 0 ]; then
  echo "CRITICAL: No active replication connections"
  echo "No active replication connections" | mail -s "PostgreSQL Replication Alert" $ALERT_EMAIL
  exit 1
fi

# æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
REPLICATION_LAG=$(psql -h $PRIMARY_HOST -U postgres -t -c "
SELECT max(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn))
FROM pg_stat_replication;
")

if [ "$REPLICATION_LAG" -gt 104857600 ]; then  # 100MB
  echo "CRITICAL: Replication lag is high: $REPLICATION_LAG bytes"
  echo "Replication lag is $REPLICATION_LAG bytes" | mail -s "PostgreSQL Replication Lag Alert" $ALERT_EMAIL
  exit 1
fi

echo "OK: Replication is healthy"
exit 0
```

**è‡ªåŠ¨ä¿®å¤è„šæœ¬**:

```bash
#!/bin/bash
# scripts/replication_auto_fix.sh

PRIMARY_HOST="primary_host"
STANDBY_HOST="standby_host"
REPLICATION_SLOT="replica1"

# æ£€æŸ¥å¤åˆ¶çŠ¶æ€
REPLICATION_STATE=$(psql -h $PRIMARY_HOST -U postgres -t -c "
SELECT state
FROM pg_stat_replication
WHERE application_name = '$REPLICATION_SLOT';
")

if [ "$REPLICATION_STATE" != "streaming" ]; then
  echo "Replication is not streaming, attempting to fix..."

  # 1. æ£€æŸ¥ä»åº“çŠ¶æ€
  STANDBY_STATE=$(psql -h $STANDBY_HOST -U postgres -t -c "SELECT pg_is_in_recovery();")

  if [ "$STANDBY_STATE" = "t" ]; then
    # 2. å°è¯•æ¢å¤å¤åˆ¶
    psql -h $STANDBY_HOST -U postgres -c "SELECT pg_wal_replay_resume();"

    # 3. ç­‰å¾…å¹¶æ£€æŸ¥
    sleep 10
    NEW_STATE=$(psql -h $PRIMARY_HOST -U postgres -t -c "
    SELECT state
    FROM pg_stat_replication
    WHERE application_name = '$REPLICATION_SLOT';
    ")

    if [ "$NEW_STATE" = "streaming" ]; then
      echo "Replication restored successfully"
    else
      echo "Failed to restore replication, manual intervention required"
      exit 1
    fi
  else
    echo "Standby is not in recovery mode, manual intervention required"
    exit 1
  fi
fi
```

## 10. æ•…éšœå¤„ç†

### 10.1 å¤åˆ¶ä¸­æ–­æ¢å¤

```sql
-- æ£€æŸ¥å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication WHERE state != 'streaming';

-- æ£€æŸ¥ WAL æ–‡ä»¶
SELECT * FROM pg_ls_waldir() ORDER BY modification DESC LIMIT 10;

-- é‡æ–°åŒæ­¥ä»åº“
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT pg_wal_replay_resume();
```

### 10.2 ä»åº“æå‡ä¸ºä¸»åº“

```sql
-- åœ¨ä»åº“æ‰§è¡Œï¼ˆPostgreSQL 12+ï¼‰
SELECT pg_promote();

-- æˆ–æ‰‹åŠ¨æå‡
-- 1. åœæ­¢ä»åº“
-- 2. åˆ é™¤ standby.signal
-- 3. å¯åŠ¨æ•°æ®åº“
```

### 10.3 é€»è¾‘å¤åˆ¶å†²çªå¤„ç†

```sql
-- æŸ¥çœ‹å†²çª
SELECT * FROM pg_stat_subscription_stats;

-- å¤„ç†å†²çªï¼ˆåœ¨è®¢é˜…ç«¯ï¼‰
ALTER SUBSCRIPTION sub_replica SET (slot_name = NONE);
ALTER SUBSCRIPTION sub_replica SET (slot_name = 'sub_replica');
```

### 10.4 ä¸»åº“æ•…éšœåˆ‡æ¢

**ä¸»åº“æ•…éšœåˆ‡æ¢æ­¥éª¤**:

```bash
# æ­¥éª¤1: ç¡®è®¤ä¸»åº“æ•…éšœ
ping -c 10 primary_host
psql -h primary_host -U postgres -c "SELECT 1;" || echo "Primary is down"

# æ­¥éª¤2: æå‡ä»åº“ä¸ºä¸»åº“
psql -h standby_host -U postgres -c "SELECT pg_promote();"

# æ­¥éª¤3: éªŒè¯æ–°ä¸»åº“
psql -h standby_host -U postgres -c "SELECT pg_is_in_recovery();"
# åº”è¯¥è¿”å› false

# æ­¥éª¤4: æ›´æ–°åº”ç”¨è¿æ¥å­—ç¬¦ä¸²
# å°†åº”ç”¨æŒ‡å‘æ–°çš„ä¸»åº“åœ°å€

# æ­¥éª¤5: é…ç½®å…¶ä»–ä»åº“è¿æ¥åˆ°æ–°ä¸»åº“
# åœ¨å…¶ä»–ä»åº“ä¸Šæ›´æ–°primary_conninfo
```

**è‡ªåŠ¨æ•…éšœåˆ‡æ¢è„šæœ¬**:

```bash
#!/bin/bash
# scripts/auto_failover.sh

PRIMARY_HOST="primary_host"
STANDBY_HOST="standby_host"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥ä¸»åº“å¥åº·
PRIMARY_HEALTH=$(psql -h $PRIMARY_HOST -U postgres -t -c "SELECT 1;" 2>/dev/null)

if [ -z "$PRIMARY_HEALTH" ]; then
  echo "Primary is down, initiating failover..."

  # æå‡ä»åº“
  PROMOTE_RESULT=$(psql -h $STANDBY_HOST -U postgres -t -c "SELECT pg_promote();" 2>/dev/null)

  if [ "$PROMOTE_RESULT" = "t" ]; then
    echo "Failover successful: $STANDBY_HOST is now primary"
    echo "Failover completed: $STANDBY_HOST is now primary" | mail -s "PostgreSQL Failover Alert" $ALERT_EMAIL
  else
    echo "Failover failed"
    echo "Failover failed for $STANDBY_HOST" | mail -s "PostgreSQL Failover Error" $ALERT_EMAIL
    exit 1
  fi
fi
```

---

## 11. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](./05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­â­ [è¯»å†™åˆ†ç¦»](./05.06-è¯»å†™åˆ†ç¦».md) - è¯»å†™åˆ†ç¦»é…ç½®
- â­â­ [åˆ†å¸ƒå¼æ¶æ„è®¾è®¡](../åˆ†å¸ƒå¼éƒ¨ç½²/05.08-åˆ†å¸ƒå¼æ¶æ„è®¾è®¡.md) - åˆ†å¸ƒå¼æ¶æ„

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../../03-äº‹åŠ¡ä¸å¹¶å‘/03.02-ACIDç‰¹æ€§/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç®¡ç†åŸºç¡€
- â­â­ [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../../../03-äº‹åŠ¡ä¸å¹¶å‘/03.01-MVCCæœºåˆ¶/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - å¤åˆ¶ç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

#### é«˜çº§ç‰¹æ€§

- â­â­ [åˆ†å¸ƒå¼ç³»ç»Ÿ](../../../15-åˆ†å¸ƒå¼ç³»ç»Ÿ/README.md) - åˆ†å¸ƒå¼äº‹åŠ¡

### å¤–éƒ¨èµ„æº

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¤åˆ¶](https://www.postgresql.org/docs/current/high-availability.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
