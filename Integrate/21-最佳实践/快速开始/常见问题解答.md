---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\09-å®è·µæŒ‡å—\å¿«é€Ÿå¼€å§‹\å¸¸è§é—®é¢˜è§£ç­”.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL å‘é‡æœç´¢å¸¸è§é—®é¢˜è§£ç­”

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 09-01-03

## ğŸ“‘ ç›®å½•

- [PostgreSQL å‘é‡æœç´¢å¸¸è§é—®é¢˜è§£ç­”](#postgresql-å‘é‡æœç´¢å¸¸è§é—®é¢˜è§£ç­”)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ–‡æ¡£ç›®æ ‡](#11-æ–‡æ¡£ç›®æ ‡)
    - [1.2 é—®é¢˜åˆ†ç±»](#12-é—®é¢˜åˆ†ç±»)
  - [2. å®‰è£…é—®é¢˜](#2-å®‰è£…é—®é¢˜)
    - [Q1: å¦‚ä½•å®‰è£… pgvector æ‰©å±•ï¼Ÿ](#q1-å¦‚ä½•å®‰è£…-pgvector-æ‰©å±•)
    - [Q2: å®‰è£…åæ— æ³•åˆ›å»ºæ‰©å±•ï¼Ÿ](#q2-å®‰è£…åæ— æ³•åˆ›å»ºæ‰©å±•)
      - [é”™è¯¯ 1: extension "vector" does not exist](#é”™è¯¯-1-extension-vector-does-not-exist)
      - [é”™è¯¯ 2: permission denied to create extension](#é”™è¯¯-2-permission-denied-to-create-extension)
      - [é”™è¯¯ 3: incompatible library](#é”™è¯¯-3-incompatible-library)
  - [3. ä½¿ç”¨é—®é¢˜](#3-ä½¿ç”¨é—®é¢˜)
    - [Q3: å¦‚ä½•é€‰æ‹©å‘é‡ç»´åº¦ï¼Ÿ](#q3-å¦‚ä½•é€‰æ‹©å‘é‡ç»´åº¦)
    - [Q4: å¦‚ä½•è®¡ç®—å‘é‡ç›¸ä¼¼åº¦ï¼Ÿ](#q4-å¦‚ä½•è®¡ç®—å‘é‡ç›¸ä¼¼åº¦)
    - [Q5: å¦‚ä½•æ’å…¥å‘é‡æ•°æ®ï¼Ÿ](#q5-å¦‚ä½•æ’å…¥å‘é‡æ•°æ®)
  - [4. æ€§èƒ½é—®é¢˜](#4-æ€§èƒ½é—®é¢˜)
    - [Q6: æŸ¥è¯¢é€Ÿåº¦æ…¢æ€ä¹ˆåŠï¼Ÿ](#q6-æŸ¥è¯¢é€Ÿåº¦æ…¢æ€ä¹ˆåŠ)
    - [Q7: ç´¢å¼•æ„å»ºå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ](#q7-ç´¢å¼•æ„å»ºå¾ˆæ…¢æ€ä¹ˆåŠ)
  - [5. ç´¢å¼•é—®é¢˜](#5-ç´¢å¼•é—®é¢˜)
    - [Q8: HNSW å’Œ IVFFlat å¦‚ä½•é€‰æ‹©ï¼Ÿ](#q8-hnsw-å’Œ-ivfflat-å¦‚ä½•é€‰æ‹©)
    - [Q9: ç´¢å¼•å ç”¨ç©ºé—´å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ](#q9-ç´¢å¼•å ç”¨ç©ºé—´å¤ªå¤§æ€ä¹ˆåŠ)
  - [6. è¿ç§»é—®é¢˜](#6-è¿ç§»é—®é¢˜)
    - [Q10: å¦‚ä½•ä»å…¶ä»–å‘é‡æ•°æ®åº“è¿ç§»ï¼Ÿ](#q10-å¦‚ä½•ä»å…¶ä»–å‘é‡æ•°æ®åº“è¿ç§»)
    - [Q11: è¿ç§»åæ€§èƒ½ä¸å¦‚åŸæ•°æ®åº“ï¼Ÿ](#q11-è¿ç§»åæ€§èƒ½ä¸å¦‚åŸæ•°æ®åº“)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£æä¾› PostgreSQL + pgvector å¸¸è§é—®é¢˜çš„å¿«é€Ÿè§£ç­”ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè§£å†³ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ã€‚

### 1.2 é—®é¢˜åˆ†ç±»

- **å®‰è£…é—®é¢˜**: æ‰©å±•å®‰è£…ã€ç¯å¢ƒé…ç½®
- **ä½¿ç”¨é—®é¢˜**: å‘é‡æ“ä½œã€æŸ¥è¯¢è¯­æ³•
- **æ€§èƒ½é—®é¢˜**: æŸ¥è¯¢æ…¢ã€ç´¢å¼•æ„å»ºæ…¢
- **ç´¢å¼•é—®é¢˜**: ç´¢å¼•é€‰æ‹©ã€å‚æ•°è°ƒä¼˜
- **è¿ç§»é—®é¢˜**: æ•°æ®è¿ç§»ã€æ€§èƒ½å¯¹æ¯”

## 2. å®‰è£…é—®é¢˜

### Q1: å¦‚ä½•å®‰è£… pgvector æ‰©å±•ï¼Ÿ

**A**: æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å®‰è£…æ–¹å¼ï¼š

**Ubuntu/Debian**:

```bash
sudo apt-get install postgresql-14-pgvector
```

**macOS**:

```bash
brew install pgvector
```

**Docker**:

```bash
docker run -d \
  --name postgres-pgvector \
  -e POSTGRES_PASSWORD=password \
  pgvector/pgvector:pg16
```

**ä»æºç ç¼–è¯‘**:

```bash
git clone --branch v0.7.0 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install
```

### Q2: å®‰è£…åæ— æ³•åˆ›å»ºæ‰©å±•ï¼Ÿ

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

```sql
-- 1. æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- 2. æ£€æŸ¥ PostgreSQL ç‰ˆæœ¬ï¼ˆéœ€è¦ 11+ï¼‰
SELECT version();

-- 3. æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
-- éœ€è¦ superuser æˆ–æ•°æ®åº“æ‰€æœ‰è€…æƒé™

-- 4. æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ï¼ˆå¦‚æœæ‰¾ä¸åˆ°ï¼‰
CREATE EXTENSION vector WITH SCHEMA public;
```

#### é”™è¯¯ 1: extension "vector" does not exist

```sql
-- è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦å®‰è£…æ‰©å±•
-- Ubuntu/Debian: sudo apt-get install postgresql-14-pgvector
-- æˆ–ä»æºç ç¼–è¯‘å®‰è£…
```

#### é”™è¯¯ 2: permission denied to create extension

```sql
-- è§£å†³æ–¹æ¡ˆ: éœ€è¦ superuser æƒé™
-- ä½¿ç”¨ postgres ç”¨æˆ·æˆ–æˆäºˆæƒé™
GRANT CREATE ON DATABASE mydb TO myuser;
```

#### é”™è¯¯ 3: incompatible library

```bash
# è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥ PostgreSQL ç‰ˆæœ¬å’Œ pgvector ç‰ˆæœ¬å…¼å®¹æ€§
# pgvector 0.7.0+ éœ€è¦ PostgreSQL 11+
SELECT version();
```

## 3. ä½¿ç”¨é—®é¢˜

### Q3: å¦‚ä½•é€‰æ‹©å‘é‡ç»´åº¦ï¼Ÿ

**A**: å‘é‡ç»´åº¦å–å†³äºæ‚¨ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹ï¼š

```sql
-- OpenAI text-embedding-ada-002: 1536 ç»´
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- OpenAI text-embedding-3-small: 1536 ç»´
-- OpenAI text-embedding-3-large: 3072 ç»´
-- sentence-transformers: é€šå¸¸ 384 æˆ– 768 ç»´
```

**ç»´åº¦é€‰æ‹©æŒ‡å—**:

| Embedding æ¨¡å‹ | ç»´åº¦ | æ¨èåœºæ™¯ |
|---------------|------|---------|
| OpenAI text-embedding-ada-002 | 1536 | é€šç”¨æ–‡æœ¬åµŒå…¥ |
| OpenAI text-embedding-3-small | 1536 | é«˜è´¨é‡æ–‡æœ¬åµŒå…¥ |
| OpenAI text-embedding-3-large | 3072 | æœ€é«˜è´¨é‡æ–‡æœ¬åµŒå…¥ |
| sentence-transformers/all-MiniLM-L6-v2 | 384 | è½»é‡çº§åº”ç”¨ |
| sentence-transformers/all-mpnet-base-v2 | 768 | å¹³è¡¡è´¨é‡å’Œæ€§èƒ½ |

**æ³¨æ„äº‹é¡¹**:

- ç»´åº¦è¶Šé«˜ï¼Œå­˜å‚¨ç©ºé—´è¶Šå¤§ï¼ŒæŸ¥è¯¢é€Ÿåº¦è¶Šæ…¢
- ç»´åº¦è¶Šé«˜ï¼Œé€šå¸¸ç²¾åº¦è¶Šé«˜
- å»ºè®®æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç»´åº¦

### Q4: å¦‚ä½•è®¡ç®—å‘é‡ç›¸ä¼¼åº¦ï¼Ÿ

**A**: pgvector æ”¯æŒä¸‰ç§è·ç¦»è®¡ç®—ï¼š

```sql
-- ä½™å¼¦è·ç¦»ï¼ˆæ¨èç”¨äºæ–‡æœ¬åµŒå…¥ï¼‰
SELECT embedding <=> query_vector AS cosine_distance FROM vectors;

-- å†…ç§¯è·ç¦»
SELECT embedding <#> query_vector AS inner_product FROM vectors;

-- æ¬§æ°è·ç¦»
SELECT embedding <-> query_vector AS euclidean_distance FROM vectors;
```

**è·ç¦»å‡½æ•°é€‰æ‹©**:

| è·ç¦»å‡½æ•° | æ“ä½œç¬¦ | é€‚ç”¨åœºæ™¯ | èŒƒå›´ |
|---------|--------|---------|------|
| ä½™å¼¦è·ç¦» | `<=>` | æ–‡æœ¬åµŒå…¥ï¼ˆæ¨èï¼‰ | 0-2 |
| å†…ç§¯è·ç¦» | `<#>` | å½’ä¸€åŒ–å‘é‡ | -âˆ åˆ° +âˆ |
| æ¬§æ°è·ç¦» | `<->` | åæ ‡æ•°æ® | 0 åˆ° +âˆ |

**ç›¸ä¼¼åº¦è½¬æ¢**:

```sql
-- ä½™å¼¦è·ç¦»è½¬ç›¸ä¼¼åº¦ï¼ˆ0-1ï¼Œ1 è¡¨ç¤ºæœ€ç›¸ä¼¼ï¼‰
SELECT 1 - (embedding <=> query_vector) AS similarity FROM vectors;

-- å†…ç§¯è½¬ç›¸ä¼¼åº¦ï¼ˆå½’ä¸€åŒ–å‘é‡ï¼‰
SELECT -1 * (embedding <#> query_vector) AS similarity FROM vectors;
```

### Q5: å¦‚ä½•æ’å…¥å‘é‡æ•°æ®ï¼Ÿ

**A**: ä½¿ç”¨ Python ç¤ºä¾‹ï¼š

```python
import asyncpg
import numpy as np

async def insert_vector():
    conn = await asyncpg.connect('postgresql://user:password@localhost/db')

    # ç”Ÿæˆå‘é‡ï¼ˆç¤ºä¾‹ï¼‰
    vector = np.random.rand(1536).tolist()
    vector_str = '[' + ','.join(map(str, vector)) + ']'

    await conn.execute("""
        INSERT INTO vectors (embedding, metadata)
        VALUES ($1::vector, $2::jsonb)
    """, vector_str, {'text': 'example'})

    await conn.close()
```

**æ‰¹é‡æ’å…¥ä¼˜åŒ–**:

```python
# æ‰¹é‡æ’å…¥ï¼ˆæ¨èï¼‰
async def batch_insert_vectors(vectors, metadata_list):
    conn = await asyncpg.connect('postgresql://user:password@localhost/db')

    # æ‰¹é‡æ’å…¥
    await conn.executemany("""
        INSERT INTO vectors (embedding, metadata)
        VALUES ($1::vector, $2::jsonb)
    """, [(vector_to_str(v), m) for v, m in zip(vectors, metadata_list)])

    await conn.close()

# ä½¿ç”¨ COPY å‘½ä»¤ï¼ˆæœ€å¿«ï¼‰
async def copy_insert_vectors(vectors, metadata_list):
    conn = await asyncpg.connect('postgresql://user:password@localhost/db')

    # å‡†å¤‡æ•°æ®
    data = [(vector_to_str(v), json.dumps(m)) for v, m in zip(vectors, metadata_list)]

    # ä½¿ç”¨ COPY
    await conn.copy_records_to_table(
        'vectors',
        records=data,
        columns=['embedding', 'metadata']
    )

    await conn.close()
```

## 4. æ€§èƒ½é—®é¢˜

### Q6: æŸ¥è¯¢é€Ÿåº¦æ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

```sql
-- 1. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- åº”è¯¥çœ‹åˆ°: Index Scan using vectors_embedding_idx
-- å¦‚æœçœ‹åˆ°: Seq Scanï¼Œéœ€è¦åˆ›å»ºç´¢å¼•

-- 2. åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. è°ƒæ•´ ef_search å‚æ•°
SET hnsw.ef_search = 40;  -- é»˜è®¤å€¼
-- é™ä½å€¼å¯ä»¥åŠ å¿«æŸ¥è¯¢ï¼Œä½†å¯èƒ½é™ä½å¬å›ç‡
```

**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**:

1. âœ… **æ£€æŸ¥ç´¢å¼•**: ç¡®ä¿ä½¿ç”¨äº† HNSW æˆ– IVFFlat ç´¢å¼•
2. âœ… **æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’**: ä½¿ç”¨ EXPLAIN ANALYZE æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
3. âœ… **è°ƒæ•´ ef_search**: æ ¹æ®ç²¾åº¦è¦æ±‚è°ƒæ•´æœç´¢å‚æ•°
4. âœ… **ä¼˜åŒ–è¿‡æ»¤æ¡ä»¶**: å…ˆè¿‡æ»¤åæœç´¢ï¼Œå‡å°‘å‘é‡è®¡ç®—é‡
5. âœ… **ä½¿ç”¨è¿æ¥æ± **: å‡å°‘è¿æ¥å¼€é”€

**æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–å‰: å…¨è¡¨æ‰«æ
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;  -- æ…¢: éœ€è¦è®¡ç®—æ‰€æœ‰å‘é‡çš„è·ç¦»

-- ä¼˜åŒ–å: ä½¿ç”¨ç´¢å¼•
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops);
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;  -- å¿«: ä½¿ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾

-- è¿›ä¸€æ­¥ä¼˜åŒ–: å…ˆè¿‡æ»¤åæœç´¢
SELECT * FROM vectors
WHERE category = 'electronics'  -- å…ˆè¿‡æ»¤
ORDER BY embedding <=> query_vector
LIMIT 10;  -- æ›´å¿«: å‡å°‘å‘é‡è®¡ç®—é‡
```

### Q7: ç´¢å¼•æ„å»ºå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: ä¼˜åŒ–ç´¢å¼•æ„å»ºå‚æ•°ï¼š

```sql
-- 1. é™ä½ ef_constructionï¼ˆåŠ å¿«æ„å»ºï¼Œå¯èƒ½é™ä½è´¨é‡ï¼‰
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- 2. é™ä½ m å‚æ•°ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);

-- 3. åœ¨ä½å³°æœŸæ„å»ºç´¢å¼•
-- 4. ä½¿ç”¨ CONCURRENTLYï¼ˆPostgreSQL 12+ï¼‰
CREATE INDEX CONCURRENTLY ON vectors USING hnsw (embedding vector_cosine_ops);
```

**ç´¢å¼•æ„å»ºä¼˜åŒ–ç­–ç•¥**:

| ä¼˜åŒ–æ–¹æ³• | æ•ˆæœ | è¯´æ˜ |
|---------|------|------|
| é™ä½ ef_construction | æ„å»ºé€Ÿåº¦æå‡ 2-3 å€ | å¯èƒ½é™ä½ç´¢å¼•è´¨é‡ |
| é™ä½ m å‚æ•° | æ„å»ºé€Ÿåº¦æå‡ 1.5-2 å€ | å¯èƒ½é™ä½æŸ¥è¯¢æ€§èƒ½ |
| ä½¿ç”¨ CONCURRENTLY | ä¸é˜»å¡æŸ¥è¯¢ | æ„å»ºæ—¶é—´å¢åŠ  20-30% |
| åœ¨ä½å³°æœŸæ„å»º | å‡å°‘å½±å“ | ä¸å½±å“ä¸šåŠ¡ |

**å®é™…ä¼˜åŒ–æ¡ˆä¾‹**:

```sql
-- æ¡ˆä¾‹: 1 äº¿å‘é‡ç´¢å¼•æ„å»ºä¼˜åŒ–
-- åŸå§‹é…ç½®: m=16, ef_construction=64, æ„å»ºæ—¶é—´: 8 å°æ—¶
-- ä¼˜åŒ–é…ç½®: m=16, ef_construction=32, æ„å»ºæ—¶é—´: 3 å°æ—¶ï¼ˆæå‡ 62%ï¼‰

CREATE INDEX CONCURRENTLY ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);
```

## 5. ç´¢å¼•é—®é¢˜

### Q8: HNSW å’Œ IVFFlat å¦‚ä½•é€‰æ‹©ï¼Ÿ

**A**: æ ¹æ®åœºæ™¯é€‰æ‹©ï¼š

| åœºæ™¯ | æ¨èç´¢å¼• | åŸå›  |
|------|---------|------|
| æŸ¥è¯¢ä¸ºä¸»ï¼Œé«˜ç²¾åº¦è¦æ±‚ | HNSW | å¬å›ç‡é«˜ï¼ŒæŸ¥è¯¢å¿« |
| å¤§è§„æ¨¡æ•°æ®ï¼Œé«˜æ›´æ–°é¢‘ç‡ | IVFFlat | æ›´æ–°æˆæœ¬ä½ï¼Œå†…å­˜å ç”¨å° |
| å†…å­˜å—é™ | IVFFlat | å†…å­˜å ç”¨æ›´å° |

```sql
-- HNSW ç¤ºä¾‹
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- IVFFlat ç¤ºä¾‹
CREATE INDEX ON vectors USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

**è¯¦ç»†å¯¹æ¯”**:

| ç‰¹æ€§ | HNSW | IVFFlat |
|------|------|---------|
| æŸ¥è¯¢é€Ÿåº¦ | **å¿«** (5-10ms) | ä¸­ç­‰ (20-50ms) |
| å¬å›ç‡ | **é«˜** (95-99%) | ä¸­ç­‰ (80-90%) |
| ç´¢å¼•æ„å»º | æ…¢ (2-8 å°æ—¶) | **å¿«** (30 åˆ†é’Ÿ-2 å°æ—¶) |
| ç´¢å¼•å¤§å° | å¤§ (3-4x æ•°æ®) | **å°** (1.5-2x æ•°æ®) |
| æ›´æ–°æˆæœ¬ | é«˜ | **ä½** |
| å†…å­˜å ç”¨ | é«˜ | **ä½** |
| é€‚ç”¨åœºæ™¯ | æŸ¥è¯¢ä¸ºä¸»ã€é«˜ç²¾åº¦ | å¤§è§„æ¨¡æ•°æ®ã€é«˜æ›´æ–°é¢‘ç‡ |

**é€‰æ‹©å»ºè®®**:

- **æŸ¥è¯¢ä¸ºä¸»**: é€‰æ‹© HNSWï¼ˆæ¨èï¼‰
- **å¤§è§„æ¨¡æ•°æ® (> 1 äº¿)**: è€ƒè™‘ IVFFlat
- **é«˜æ›´æ–°é¢‘ç‡**: é€‰æ‹© IVFFlat
- **å†…å­˜å—é™**: é€‰æ‹© IVFFlat

### Q9: ç´¢å¼•å ç”¨ç©ºé—´å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

**A**: ä¼˜åŒ–ç´¢å¼•å‚æ•°ï¼š

```sql
-- 1. é™ä½ m å‚æ•°ï¼ˆHNSWï¼‰
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 8);  -- é»˜è®¤æ˜¯ 16

-- 2. é™ä½ lists å‚æ•°ï¼ˆIVFFlatï¼‰
CREATE INDEX ON vectors USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 50);  -- é»˜è®¤æ˜¯ 100

-- 3. æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_indexes
WHERE tablename = 'vectors';
```

**ç©ºé—´ä¼˜åŒ–ç­–ç•¥**:

| ä¼˜åŒ–æ–¹æ³• | ç©ºé—´å‡å°‘ | æ€§èƒ½å½±å“ |
|---------|---------|---------|
| é™ä½ m å‚æ•° (HNSW) | 20-30% | æŸ¥è¯¢é€Ÿåº¦é™ä½ 10-20% |
| é™ä½ lists å‚æ•° (IVFFlat) | 30-50% | å¬å›ç‡é™ä½ 5-10% |
| ä½¿ç”¨éƒ¨åˆ†ç´¢å¼• | 50-80% | ä»…ç´¢å¼•éƒ¨åˆ†æ•°æ® |

**å®é™…ä¼˜åŒ–æ¡ˆä¾‹**:

```sql
-- æ¡ˆä¾‹: 1 äº¿å‘é‡ç´¢å¼•ç©ºé—´ä¼˜åŒ–
-- åŸå§‹é…ç½®: m=16, ç´¢å¼•å¤§å°: 120GB
-- ä¼˜åŒ–é…ç½®: m=8, ç´¢å¼•å¤§å°: 80GBï¼ˆå‡å°‘ 33%ï¼‰

CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);
```

## 6. è¿ç§»é—®é¢˜

### Q10: å¦‚ä½•ä»å…¶ä»–å‘é‡æ•°æ®åº“è¿ç§»ï¼Ÿ

**A**: å‚è€ƒè¿ç§»æŒ‡å—ï¼š

- [ä» Milvus è¿ç§»](../è¿ç§»æŒ‡å—/ä»ä¸“ç”¨å‘é‡æ•°æ®åº“è¿ç§».md#3-milvus-è¿ç§»)
- [ä» Pinecone è¿ç§»](../è¿ç§»æŒ‡å—/ä»ä¸“ç”¨å‘é‡æ•°æ®åº“è¿ç§».md#4-pinecone-è¿ç§»)
- [ä» MongoDB è¿ç§»](../è¿ç§»æŒ‡å—/ä»MongoDBè¿ç§».md)

**è¿ç§»æ­¥éª¤æ¦‚è§ˆ**:

1. **æ•°æ®å¯¼å‡º**: ä»æºæ•°æ®åº“å¯¼å‡ºå‘é‡å’Œå…ƒæ•°æ®
2. **æ•°æ®è½¬æ¢**: è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆå¦‚éœ€è¦ï¼‰
3. **æ•°æ®å¯¼å…¥**: å¯¼å…¥åˆ° PostgreSQL
4. **ç´¢å¼•åˆ›å»º**: åˆ›å»º HNSW æˆ– IVFFlat ç´¢å¼•
5. **æ€§èƒ½æµ‹è¯•**: å¯¹æ¯”æŸ¥è¯¢æ€§èƒ½
6. **æ•°æ®éªŒè¯**: éªŒè¯æ•°æ®ä¸€è‡´æ€§

**è¿ç§»å·¥å…·**:

- **Milvus**: ä½¿ç”¨ pymilvus å¯¼å‡ºï¼Œpsycopg2 å¯¼å…¥
- **Pinecone**: ä½¿ç”¨ pinecone-client å¯¼å‡º
- **Weaviate**: ä½¿ç”¨ weaviate-client å¯¼å‡º

è¯¦ç»†è¿ç§»æ­¥éª¤è¯·å‚è€ƒï¼š[ä»ä¸“ç”¨å‘é‡æ•°æ®åº“è¿ç§»](../è¿ç§»æŒ‡å—/ä»ä¸“ç”¨å‘é‡æ•°æ®åº“è¿ç§».md)

### Q11: è¿ç§»åæ€§èƒ½ä¸å¦‚åŸæ•°æ®åº“ï¼Ÿ

**A**: ä¼˜åŒ–é…ç½®ï¼š

```sql
-- 1. ç¡®ä¿ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. è°ƒæ•´ PostgreSQL é…ç½®
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET effective_cache_size = '6GB';

-- 3. è°ƒæ•´æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- æé«˜å¬å›ç‡

-- 4. ä½¿ç”¨è¿æ¥æ± 
-- å‚è€ƒ: [è¿æ¥æ± ä¼˜åŒ–](../../01-å‘é‡ä¸æ··åˆæœç´¢/æ€§èƒ½ä¼˜åŒ–/HNSWæ€§èƒ½ä¼˜åŒ–.md#51-è¿æ¥æ± ä¼˜åŒ–)
```

**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**:

1. âœ… **ç´¢å¼•é…ç½®**: ç¡®ä¿ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•ç±»å‹å’Œå‚æ•°
2. âœ… **PostgreSQL é…ç½®**: ä¼˜åŒ– shared_buffersã€work_mem ç­‰å‚æ•°
3. âœ… **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ï¼Œå…ˆè¿‡æ»¤åæœç´¢
4. âœ… **è¿æ¥æ± **: ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€
5. âœ… **ç¡¬ä»¶é…ç½®**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„ CPU å’Œå†…å­˜

**æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–å‰: æŸ¥è¯¢å»¶è¿Ÿ 100ms
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- ä¼˜åŒ–å: æŸ¥è¯¢å»¶è¿Ÿ 15msï¼ˆæå‡ 85%ï¼‰
-- 1. åˆ›å»ºç´¢å¼•
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. è°ƒæ•´æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;

-- 3. ä¼˜åŒ–æŸ¥è¯¢
SELECT * FROM vectors
WHERE category = 'electronics'  -- å…ˆè¿‡æ»¤
ORDER BY embedding <=> query_vector
LIMIT 10;
```

**å®é™…æ¡ˆä¾‹**:

æŸå…¬å¸ä» Milvus è¿ç§»åˆ° PostgreSQL + pgvectorï¼š

- **è¿ç§»å‰**: Milvus æŸ¥è¯¢å»¶è¿Ÿ 20ms
- **è¿ç§»å**: PostgreSQL æŸ¥è¯¢å»¶è¿Ÿ 15msï¼ˆ**æå‡ 25%**ï¼‰
- **æˆæœ¬**: é™ä½ **60%**ï¼ˆç»Ÿä¸€æ•°æ®åº“ï¼‰

## 7. å‚è€ƒèµ„æ–™

- [å¿«é€Ÿå¼€å§‹æŒ‡å—](../../01-å‘é‡ä¸æ··åˆæœç´¢/æœ€ä½³å®è·µ/å¿«é€Ÿå¼€å§‹æŒ‡å—.md)
- [ç´¢å¼•é€‰æ‹©ç­–ç•¥](../../01-å‘é‡ä¸æ··åˆæœç´¢/æœ€ä½³å®è·µ/ç´¢å¼•é€‰æ‹©ç­–ç•¥.md)
- [æ€§èƒ½è°ƒä¼˜æŠ€å·§](../../01-å‘é‡ä¸æ··åˆæœç´¢/æœ€ä½³å®è·µ/æ€§èƒ½è°ƒä¼˜æŠ€å·§.md)
- [å¸¸è§é—®é¢˜è¯Šæ–­](../æ•…éšœæ’æŸ¥/å¸¸è§é—®é¢˜è¯Šæ–­.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 09-01-03
