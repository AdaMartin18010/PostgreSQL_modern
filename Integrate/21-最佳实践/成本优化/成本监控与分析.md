# PostgreSQL成本监控与分析指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL成本监控与分析指南](#postgresql成本监控与分析指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 监控指标](#2-监控指标)
    - [2.1 资源监控](#21-资源监控)
    - [2.2 存储监控](#22-存储监控)
  - [3. 成本分析](#3-成本分析)
    - [3.1 成本构成分析](#31-成本构成分析)
    - [3.2 查询成本分析](#32-查询成本分析)
  - [4. 报告生成](#4-报告生成)
    - [4.1 成本报告](#41-成本报告)
    - [4.2 趋势分析](#42-趋势分析)
  - [5. 优化跟踪](#5-优化跟踪)
    - [5.1 优化效果](#51-优化效果)
    - [5.2 持续改进](#52-持续改进)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

成本监控与分析帮助识别成本热点，跟踪优化效果。

**监控内容**:

- 资源使用
- 成本构成
- 趋势分析
- 优化效果

---

## 2. 监控指标

### 2.1 资源监控

```sql
-- 监控CPU使用
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE state = 'active';

-- 监控内存使用
SELECT
    name,
    setting,
    unit
FROM pg_settings
WHERE name LIKE '%memory%' OR name LIKE '%buffer%';
```

### 2.2 存储监控

```sql
-- 监控存储使用
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

---

## 3. 成本分析

### 3.1 成本构成分析

```sql
-- 分析表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 查询成本分析

```sql
-- 分析查询成本
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    (total_exec_time / SUM(total_exec_time) OVER ()) * 100 AS pct
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

---

## 4. 报告生成

### 4.1 成本报告

```sql
-- 生成成本报告
SELECT
    'Storage Cost' AS cost_type,
    pg_size_pretty(SUM(pg_total_relation_size(schemaname||'.'||tablename))) AS total_size,
    COUNT(*) AS table_count
FROM pg_tables
UNION ALL
SELECT
    'Connection Cost' AS cost_type,
    COUNT(*)::TEXT AS total_connections,
    NULL AS table_count
FROM pg_stat_activity;
```

### 4.2 趋势分析

```text
1. 收集历史数据
2. 分析趋势
3. 预测未来成本
4. 制定优化计划
```

---

## 5. 优化跟踪

### 5.1 优化效果

```text
1. 记录优化前指标
2. 实施优化措施
3. 记录优化后指标
4. 计算优化效果
```

### 5.2 持续改进

```text
1. 定期审查成本
2. 识别新的优化机会
3. 实施优化措施
4. 跟踪优化效果
```

---

## 📚 相关文档

- [成本优化完整指南.md](./成本优化完整指南.md) - 成本优化完整指南
- [云成本优化.md](./云成本优化.md) - 云成本优化
- [资源使用优化.md](./资源使用优化.md) - 资源使用优化
- [21-最佳实践/README.md](../README.md) - 最佳实践主题

---

**最后更新**: 2025年1月
