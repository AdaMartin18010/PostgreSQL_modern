# PostgreSQLæˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—](#postgresqlæˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æˆæœ¬æ„æˆ](#2-æˆæœ¬æ„æˆ)
    - [2.1 æˆæœ¬ç±»å‹](#21-æˆæœ¬ç±»å‹)
    - [2.2 æˆæœ¬åˆ†æ](#22-æˆæœ¬åˆ†æ)
  - [3. ä¼˜åŒ–ç­–ç•¥](#3-ä¼˜åŒ–ç­–ç•¥)
    - [3.1 è®¡ç®—æˆæœ¬ä¼˜åŒ–](#31-è®¡ç®—æˆæœ¬ä¼˜åŒ–)
    - [3.2 å­˜å‚¨æˆæœ¬ä¼˜åŒ–](#32-å­˜å‚¨æˆæœ¬ä¼˜åŒ–)
    - [3.3 ç½‘ç»œæˆæœ¬ä¼˜åŒ–](#33-ç½‘ç»œæˆæœ¬ä¼˜åŒ–)
    - [3.4 ç»¼åˆä¼˜åŒ–ç­–ç•¥](#34-ç»¼åˆä¼˜åŒ–ç­–ç•¥)
  - [4. ç›‘æ§åˆ†æ](#4-ç›‘æ§åˆ†æ)
    - [4.1 æˆæœ¬ç›‘æ§](#41-æˆæœ¬ç›‘æ§)
    - [4.2 æˆæœ¬åˆ†æ](#42-æˆæœ¬åˆ†æ)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æˆæœ¬ä¼˜åŒ–æ˜¯PostgreSQLè¿ç»´çš„é‡è¦ç¯èŠ‚ï¼Œæ¶‰åŠè®¡ç®—ã€å­˜å‚¨ã€ç½‘ç»œç­‰å¤šä¸ªæ–¹é¢ã€‚

**ä¼˜åŒ–ç›®æ ‡**:

- é™ä½è¿è¥æˆæœ¬
- æé«˜èµ„æºåˆ©ç”¨ç‡
- ä¼˜åŒ–æ€§èƒ½æˆæœ¬æ¯”
- æ§åˆ¶é¢„ç®—

---

## 2. æˆæœ¬æ„æˆ

### 2.1 æˆæœ¬ç±»å‹

| æˆæœ¬ç±»å‹ | å æ¯” | ä¼˜åŒ–é‡ç‚¹ |
| --- | --- | --- |
| **è®¡ç®—æˆæœ¬** | 40-50% | å®ä¾‹è§„æ ¼ã€è¿æ¥æ•° |
| **å­˜å‚¨æˆæœ¬** | 30-40% | æ•°æ®é‡ã€å¤‡ä»½ |
| **ç½‘ç»œæˆæœ¬** | 10-20% | æ•°æ®ä¼ è¾“ |
| **äººåŠ›æˆæœ¬** | 10-20% | è‡ªåŠ¨åŒ– |

### 2.2 æˆæœ¬åˆ†æ

**æˆæœ¬åˆ†æå·¥å…·**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬åˆ†æè§†å›¾
CREATE OR REPLACE VIEW cost_analysis_view AS
SELECT
    'è®¡ç®—æˆæœ¬' AS cost_category,
    COUNT(*)::NUMERIC * 0.1 AS estimated_monthly_cost,
    'å®ä¾‹è§„æ ¼å’Œè¿æ¥æ•°' AS cost_factors
FROM pg_stat_activity![1767001741120](image/æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—/1767001741120.png)
UNION ALL
SELECT
    'å­˜å‚¨æˆæœ¬',
    SUM(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024 / 1024 * 0.1,
    'æ•°æ®é‡å’Œå¤‡ä»½'
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
UNION ALL
SELECT
    'ç½‘ç»œæˆæœ¬',
    SUM(sent_bytes + received_bytes)::NUMERIC / 1024 / 1024 / 1024 * 0.09,
    'æ•°æ®ä¼ è¾“é‡'
FROM pg_stat_statements;

-- æŸ¥è¯¢æˆæœ¬åˆ†æ
SELECT
    cost_category,
    ROUND(estimated_monthly_cost, 2) AS monthly_cost,
    ROUND(estimated_monthly_cost * 12, 2) AS annual_cost,
    ROUND(estimated_monthly_cost / SUM(estimated_monthly_cost) OVER () * 100, 2) || '%' AS cost_percentage,
    cost_factors
FROM cost_analysis_view
ORDER BY estimated_monthly_cost DESC;
```

**è¯¦ç»†æˆæœ¬æ„æˆåˆ†æ**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬æ„æˆåˆ†æè¡¨
CREATE TABLE IF NOT EXISTS cost_breakdown (
    cost_id SERIAL PRIMARY KEY,
    cost_category VARCHAR(50),
    cost_subcategory VARCHAR(100),
    monthly_cost NUMERIC,
    annual_cost NUMERIC,
    cost_percentage NUMERIC,
    optimization_potential NUMERIC,
    analysis_date DATE DEFAULT CURRENT_DATE
);

-- æ’å…¥æˆæœ¬æ•°æ®
INSERT INTO cost_breakdown
(cost_category, cost_subcategory, monthly_cost, optimization_potential)
VALUES
('è®¡ç®—æˆæœ¬', 'å®ä¾‹è§„æ ¼', 500.0, 20.0),
('è®¡ç®—æˆæœ¬', 'è¿æ¥æ•°', 100.0, 30.0),
('å­˜å‚¨æˆæœ¬', 'æ•°æ®å­˜å‚¨', 300.0, 40.0),
('å­˜å‚¨æˆæœ¬', 'å¤‡ä»½å­˜å‚¨', 150.0, 50.0),
('ç½‘ç»œæˆæœ¬', 'æ•°æ®ä¼ è¾“', 50.0, 25.0),
('äººåŠ›æˆæœ¬', 'è¿ç»´ç®¡ç†', 200.0, 60.0);

-- æ›´æ–°å¹´åº¦æˆæœ¬å’Œå æ¯”
UPDATE cost_breakdown
SET
    annual_cost = monthly_cost * 12,
    cost_percentage = ROUND(
        monthly_cost / (SELECT SUM(monthly_cost) FROM cost_breakdown) * 100, 2
    );

-- æŸ¥è¯¢æˆæœ¬æ„æˆ
SELECT
    cost_category,
    cost_subcategory,
    ROUND(monthly_cost, 2) AS monthly_cost,
    ROUND(annual_cost, 2) AS annual_cost,
    cost_percentage || '%' AS cost_percentage,
    optimization_potential || '%' AS optimization_potential,
    ROUND(monthly_cost * optimization_potential / 100, 2) AS potential_savings
FROM cost_breakdown
ORDER BY monthly_cost DESC;
```

---

## 3. ä¼˜åŒ–ç­–ç•¥

### 3.1 è®¡ç®—æˆæœ¬ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```text
1. é€‰æ‹©åˆé€‚çš„å®ä¾‹è§„æ ¼
2. ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥æ•°
3. ä¼˜åŒ–æŸ¥è¯¢å‡å°‘CPUä½¿ç”¨
4. ä½¿ç”¨åªè¯»å‰¯æœ¬åˆ†æ‹…è´Ÿè½½
```

**è®¡ç®—æˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- åˆ›å»ºè®¡ç®—æˆæœ¬ä¼˜åŒ–è·Ÿè¸ªè¡¨
CREATE TABLE IF NOT EXISTS compute_cost_optimization (
    optimization_id SERIAL PRIMARY KEY,
    optimization_type VARCHAR(50),
    before_value NUMERIC,
    after_value NUMERIC,
    cost_savings NUMERIC,
    optimization_date TIMESTAMPTZ DEFAULT NOW()
);

-- å®ä¾‹è§„æ ¼ä¼˜åŒ–
-- åˆ†æå½“å‰å®ä¾‹ä½¿ç”¨æƒ…å†µ
SELECT
    COUNT(*) AS total_connections,
    COUNT(*) FILTER (WHERE state = 'active') AS active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') AS idle_connections,
    AVG(EXTRACT(EPOCH FROM (NOW() - query_start))) AS avg_query_duration
FROM pg_stat_activity
WHERE datname NOT IN ('template0', 'template1');

-- è¿æ¥æ± ä¼˜åŒ–æ•ˆæœ
INSERT INTO compute_cost_optimization
(optimization_type, before_value, after_value, cost_savings)
VALUES
('è¿æ¥æ± ä¼˜åŒ–', 200, 50, 150 * 0.1), -- å‡è®¾æ¯ä¸ªè¿æ¥æˆæœ¬0.1/æœˆ
('æŸ¥è¯¢ä¼˜åŒ–', 1000, 500, 500 * 0.05), -- å‡è®¾CPUä½¿ç”¨å‡å°‘50%
('å®ä¾‹é™çº§', 1000, 500, 500 * 0.3); -- å‡è®¾å®ä¾‹æˆæœ¬é™ä½30%

-- æŸ¥è¯¢ä¼˜åŒ–æ•ˆæœ
SELECT
    optimization_type,
    before_value,
    after_value,
    ROUND(cost_savings, 2) AS monthly_savings,
    ROUND(cost_savings * 12, 2) AS annual_savings,
    optimization_date
FROM compute_cost_optimization
ORDER BY cost_savings DESC;
```

### 3.2 å­˜å‚¨æˆæœ¬ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```text
1. æ•°æ®å‹ç¼©
2. å†·çƒ­æ•°æ®åˆ†ç¦»
3. å®šæœŸæ¸…ç†å†å²æ•°æ®
4. ä¼˜åŒ–å¤‡ä»½ç­–ç•¥
```

**å­˜å‚¨æˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- åˆ›å»ºå­˜å‚¨æˆæœ¬ä¼˜åŒ–è·Ÿè¸ªè¡¨
CREATE TABLE IF NOT EXISTS storage_cost_optimization (
    optimization_id SERIAL PRIMARY KEY,
    optimization_type VARCHAR(50),
    before_size_gb NUMERIC,
    after_size_gb NUMERIC,
    storage_saved_gb NUMERIC,
    cost_savings NUMERIC,
    optimization_date TIMESTAMPTZ DEFAULT NOW()
);

-- æ•°æ®å‹ç¼©ä¼˜åŒ–
INSERT INTO storage_cost_optimization
(optimization_type, before_size_gb, after_size_gb, storage_saved_gb)
SELECT
    'è¡¨å‹ç¼©',
    pg_total_relation_size('public.users')::NUMERIC / 1024 / 1024 / 1024,
    pg_total_relation_size('public.users')::NUMERIC / 1024 / 1024 / 1024 * 0.7, -- å‡è®¾å‹ç¼©30%
    pg_total_relation_size('public.users')::NUMERIC / 1024 / 1024 / 1024 * 0.3
WHERE EXISTS (SELECT 1 FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users');

-- æ›´æ–°æˆæœ¬èŠ‚çœ
UPDATE storage_cost_optimization
SET cost_savings = storage_saved_gb * 0.1; -- å‡è®¾å­˜å‚¨æˆæœ¬0.1/GB/æœˆ

-- æŸ¥è¯¢å­˜å‚¨ä¼˜åŒ–æ•ˆæœ
SELECT
    optimization_type,
    ROUND(before_size_gb, 2) AS before_gb,
    ROUND(after_size_gb, 2) AS after_gb,
    ROUND(storage_saved_gb, 2) AS saved_gb,
    ROUND(cost_savings, 2) AS monthly_savings,
    ROUND(cost_savings * 12, 2) AS annual_savings
FROM storage_cost_optimization
ORDER BY cost_savings DESC;
```

### 3.3 ç½‘ç»œæˆæœ¬ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```text
1. å‡å°‘æ•°æ®ä¼ è¾“é‡
2. ä½¿ç”¨æ‰¹é‡æ“ä½œ
3. æ•°æ®æœ¬åœ°åŒ–
4. å‹ç¼©ä¼ è¾“
```

**ç½‘ç»œæˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- åˆ›å»ºç½‘ç»œæˆæœ¬ä¼˜åŒ–è·Ÿè¸ªè¡¨
CREATE TABLE IF NOT EXISTS network_cost_optimization (
    optimization_id SERIAL PRIMARY KEY,
    optimization_type VARCHAR(50),
    before_traffic_gb NUMERIC,
    after_traffic_gb NUMERIC,
    traffic_saved_gb NUMERIC,
    cost_savings NUMERIC,
    optimization_date TIMESTAMPTZ DEFAULT NOW()
);

-- æ‰¹é‡æ“ä½œä¼˜åŒ–
-- ä¼˜åŒ–å‰ï¼šå•æ¡æ’å…¥ï¼Œæ¯æ¬¡ä¼ è¾“1KB
-- ä¼˜åŒ–åï¼šæ‰¹é‡æ’å…¥ï¼Œæ¯æ¬¡ä¼ è¾“100KBï¼ˆå‡å°‘99%çš„ç½‘ç»œå¼€é”€ï¼‰
INSERT INTO network_cost_optimization
(optimization_type, before_traffic_gb, after_traffic_gb, traffic_saved_gb)
VALUES
('æ‰¹é‡æ“ä½œ', 10.0, 0.1, 9.9),
('æ•°æ®å‹ç¼©', 5.0, 1.0, 4.0),
('æ•°æ®æœ¬åœ°åŒ–', 20.0, 0.0, 20.0);

-- æ›´æ–°æˆæœ¬èŠ‚çœï¼ˆå‡è®¾ç½‘ç»œæˆæœ¬0.09/GBï¼‰
UPDATE network_cost_optimization
SET cost_savings = traffic_saved_gb * 0.09;

-- æŸ¥è¯¢ç½‘ç»œä¼˜åŒ–æ•ˆæœ
SELECT
    optimization_type,
    ROUND(before_traffic_gb, 2) AS before_gb,
    ROUND(after_traffic_gb, 2) AS after_gb,
    ROUND(traffic_saved_gb, 2) AS saved_gb,
    ROUND(cost_savings, 2) AS monthly_savings,
    ROUND(cost_savings * 12, 2) AS annual_savings
FROM network_cost_optimization
ORDER BY cost_savings DESC;
```

### 3.4 ç»¼åˆä¼˜åŒ–ç­–ç•¥

**ä¼˜åŒ–ä¼˜å…ˆçº§çŸ©é˜µ**ï¼š

```sql
-- åˆ›å»ºä¼˜åŒ–ä¼˜å…ˆçº§çŸ©é˜µ
CREATE TABLE IF NOT EXISTS optimization_priority_matrix (
    optimization_id SERIAL PRIMARY KEY,
    optimization_type VARCHAR(100),
    cost_category VARCHAR(50),
    current_cost NUMERIC,
    potential_savings NUMERIC,
    implementation_effort VARCHAR(20),
    priority_score NUMERIC,
    priority_rank INTEGER
);

-- æ’å…¥ä¼˜åŒ–é¡¹
INSERT INTO optimization_priority_matrix
(optimization_type, cost_category, current_cost, potential_savings, implementation_effort)
VALUES
('æ•°æ®å½’æ¡£', 'å­˜å‚¨æˆæœ¬', 300.0, 120.0, 'ä½'),
('è¿æ¥æ± ', 'è®¡ç®—æˆæœ¬', 100.0, 70.0, 'ä½'),
('æŸ¥è¯¢ä¼˜åŒ–', 'è®¡ç®—æˆæœ¬', 500.0, 100.0, 'ä¸­'),
('å¤‡ä»½å‹ç¼©', 'å­˜å‚¨æˆæœ¬', 150.0, 75.0, 'ä½'),
('å®ä¾‹é™çº§', 'è®¡ç®—æˆæœ¬', 500.0, 150.0, 'é«˜');

-- è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆèŠ‚çœé‡‘é¢ / å®æ–½éš¾åº¦ï¼‰
UPDATE optimization_priority_matrix
SET
    priority_score = potential_savings / CASE
        WHEN implementation_effort = 'ä½' THEN 1
        WHEN implementation_effort = 'ä¸­' THEN 2
        WHEN implementation_effort = 'é«˜' THEN 3
        ELSE 1
    END,
    priority_rank = ROW_NUMBER() OVER (
        ORDER BY potential_savings / CASE
            WHEN implementation_effort = 'ä½' THEN 1
            WHEN implementation_effort = 'ä¸­' THEN 2
            WHEN implementation_effort = 'é«˜' THEN 3
            ELSE 1
        END DESC
    );

-- æŸ¥è¯¢ä¼˜åŒ–ä¼˜å…ˆçº§
SELECT
    priority_rank,
    optimization_type,
    cost_category,
    ROUND(current_cost, 2) AS current_cost,
    ROUND(potential_savings, 2) AS potential_savings,
    implementation_effort,
    ROUND(priority_score, 2) AS priority_score
FROM optimization_priority_matrix
ORDER BY priority_rank;
```

---

## 4. ç›‘æ§åˆ†æ

### 4.1 æˆæœ¬ç›‘æ§

**å®æ—¶æˆæœ¬ç›‘æ§**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW real_time_cost_monitoring AS
SELECT
    'è®¡ç®—èµ„æº' AS resource_type,
    COUNT(*)::NUMERIC * 0.1 AS current_cost,
    COUNT(*) FILTER (WHERE state = 'idle')::NUMERIC * 0.1 AS idle_cost,
    COUNT(*) FILTER (WHERE state = 'active')::NUMERIC * 0.1 AS active_cost
FROM pg_stat_activity
WHERE datname NOT IN ('template0', 'template1')
UNION ALL
SELECT
    'å­˜å‚¨èµ„æº',
    SUM(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024 / 1024 * 0.1,
    0,
    0
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema');

-- æŸ¥è¯¢å®æ—¶æˆæœ¬
SELECT
    resource_type,
    ROUND(current_cost, 2) AS current_monthly_cost,
    ROUND(idle_cost, 2) AS idle_cost,
    ROUND(active_cost, 2) AS active_cost,
    ROUND((idle_cost / NULLIF(current_cost, 0)) * 100, 2) || '%' AS idle_percentage
FROM real_time_cost_monitoring
ORDER BY current_cost DESC;
```

**æˆæœ¬å‘Šè­¦é…ç½®**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬å‘Šè­¦é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS cost_alerts (
    alert_id SERIAL PRIMARY KEY,
    alert_name VARCHAR(200),
    cost_category VARCHAR(50),
    threshold_amount NUMERIC,
    alert_level VARCHAR(20),
    enabled BOOLEAN DEFAULT TRUE,
    last_triggered TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥å‘Šè­¦é…ç½®
INSERT INTO cost_alerts
(alert_name, cost_category, threshold_amount, alert_level)
VALUES
('è®¡ç®—æˆæœ¬å‘Šè­¦', 'è®¡ç®—æˆæœ¬', 600.0, 'é«˜'),
('å­˜å‚¨æˆæœ¬å‘Šè­¦', 'å­˜å‚¨æˆæœ¬', 400.0, 'ä¸­'),
('ç½‘ç»œæˆæœ¬å‘Šè­¦', 'ç½‘ç»œæˆæœ¬', 100.0, 'ä½');

-- æ£€æŸ¥å‘Šè­¦
CREATE OR REPLACE FUNCTION check_cost_alerts()
RETURNS TABLE (
    alert_name VARCHAR(200),
    cost_category VARCHAR(50),
    current_cost NUMERIC,
    threshold_amount NUMERIC,
    alert_level VARCHAR(20)
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        a.alert_name,
        a.cost_category,
        CASE
            WHEN a.cost_category = 'è®¡ç®—æˆæœ¬' THEN
                (SELECT COUNT(*)::NUMERIC * 0.1 FROM pg_stat_activity
                 WHERE datname NOT IN ('template0', 'template1'))
            WHEN a.cost_category = 'å­˜å‚¨æˆæœ¬' THEN
                (SELECT SUM(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024 / 1024 * 0.1
                 FROM pg_tables WHERE schemaname NOT IN ('pg_catalog', 'information_schema'))
            ELSE 0
        END AS current_cost,
        a.threshold_amount,
        a.alert_level
    FROM cost_alerts a
    WHERE a.enabled = TRUE
      AND CASE
            WHEN a.cost_category = 'è®¡ç®—æˆæœ¬' THEN
                (SELECT COUNT(*)::NUMERIC * 0.1 FROM pg_stat_activity
                 WHERE datname NOT IN ('template0', 'template1'))
            WHEN a.cost_category = 'å­˜å‚¨æˆæœ¬' THEN
                (SELECT SUM(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024 / 1024 * 0.1
                 FROM pg_tables WHERE schemaname NOT IN ('pg_catalog', 'information_schema'))
            ELSE 0
          END >= a.threshold_amount;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢å‘Šè­¦
SELECT * FROM check_cost_alerts();
```

### 4.2 æˆæœ¬åˆ†æ

**æˆæœ¬åˆ†ææµç¨‹**ï¼š

```text
1. å®šæœŸåˆ†ææˆæœ¬æ„æˆ
2. è¯†åˆ«æˆæœ¬çƒ­ç‚¹
3. åˆ¶å®šä¼˜åŒ–è®¡åˆ’
4. è·Ÿè¸ªä¼˜åŒ–æ•ˆæœ
```

**æˆæœ¬è¶‹åŠ¿åˆ†æ**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬å†å²è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS cost_history (
    record_id SERIAL PRIMARY KEY,
    record_date DATE DEFAULT CURRENT_DATE,
    compute_cost NUMERIC,
    storage_cost NUMERIC,
    network_cost NUMERIC,
    total_cost NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥å†å²æˆæœ¬æ•°æ®
INSERT INTO cost_history
(record_date, compute_cost, storage_cost, network_cost, total_cost)
VALUES
(CURRENT_DATE - INTERVAL '30 days', 500.0, 300.0, 50.0, 850.0),
(CURRENT_DATE - INTERVAL '20 days', 480.0, 310.0, 45.0, 835.0),
(CURRENT_DATE - INTERVAL '10 days', 450.0, 290.0, 40.0, 780.0),
(CURRENT_DATE, 420.0, 280.0, 35.0, 735.0);

-- è®¡ç®—æˆæœ¬è¶‹åŠ¿
SELECT
    record_date,
    ROUND(compute_cost, 2) AS compute_cost,
    ROUND(storage_cost, 2) AS storage_cost,
    ROUND(network_cost, 2) AS network_cost,
    ROUND(total_cost, 2) AS total_cost,
    ROUND(total_cost - LAG(total_cost) OVER (ORDER BY record_date), 2) AS cost_change,
    ROUND((total_cost - LAG(total_cost) OVER (ORDER BY record_date)) /
          NULLIF(LAG(total_cost) OVER (ORDER BY record_date), 0) * 100, 2) || '%' AS change_percentage
FROM cost_history
ORDER BY record_date DESC;
```

**æˆæœ¬é¢„æµ‹**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬é¢„æµ‹å‡½æ•°
CREATE OR REPLACE FUNCTION predict_future_cost(
    p_months_ahead INTEGER DEFAULT 3
)
RETURNS TABLE (
    month_date DATE,
    predicted_compute_cost NUMERIC,
    predicted_storage_cost NUMERIC,
    predicted_network_cost NUMERIC,
    predicted_total_cost NUMERIC
) AS $$
DECLARE
    v_avg_compute_cost NUMERIC;
    v_avg_storage_cost NUMERIC;
    v_avg_network_cost NUMERIC;
    v_trend_compute NUMERIC;
    v_trend_storage NUMERIC;
    v_trend_network NUMERIC;
    v_month_offset INTEGER;
BEGIN
    -- è®¡ç®—å¹³å‡æˆæœ¬å’Œè¶‹åŠ¿
    SELECT
        AVG(compute_cost),
        AVG(storage_cost),
        AVG(network_cost),
        (MAX(compute_cost) - MIN(compute_cost)) / NULLIF(COUNT(*), 0),
        (MAX(storage_cost) - MIN(storage_cost)) / NULLIF(COUNT(*), 0),
        (MAX(network_cost) - MIN(network_cost)) / NULLIF(COUNT(*), 0)
    INTO
        v_avg_compute_cost,
        v_avg_storage_cost,
        v_avg_network_cost,
        v_trend_compute,
        v_trend_storage,
        v_trend_network
    FROM cost_history
    WHERE record_date >= CURRENT_DATE - INTERVAL '3 months';

    -- ç”Ÿæˆé¢„æµ‹æ•°æ®
    FOR v_month_offset IN 1..p_months_ahead LOOP
        RETURN QUERY SELECT
            CURRENT_DATE + (v_month_offset || ' months')::INTERVAL,
            v_avg_compute_cost + v_trend_compute * v_month_offset,
            v_avg_storage_cost + v_trend_storage * v_month_offset,
            v_avg_network_cost + v_trend_network * v_month_offset,
            (v_avg_compute_cost + v_trend_compute * v_month_offset) +
            (v_avg_storage_cost + v_trend_storage * v_month_offset) +
            (v_avg_network_cost + v_trend_network * v_month_offset);
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢æˆæœ¬é¢„æµ‹
SELECT
    month_date,
    ROUND(predicted_compute_cost, 2) AS compute_cost,
    ROUND(predicted_storage_cost, 2) AS storage_cost,
    ROUND(predicted_network_cost, 2) AS network_cost,
    ROUND(predicted_total_cost, 2) AS total_cost
FROM predict_future_cost(6)
ORDER BY month_date;
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

**æˆæœ¬ä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

1. **å®šæœŸæˆæœ¬å®¡æŸ¥** - æ¯æœˆå®¡æŸ¥æˆæœ¬
2. **èµ„æºç›‘æ§** - æŒç»­ç›‘æ§èµ„æºä½¿ç”¨
3. **ä¼˜åŒ–æŸ¥è¯¢** - å‡å°‘ä¸å¿…è¦çš„è®¡ç®—
4. **è‡ªåŠ¨åŒ–ç®¡ç†** - å‡å°‘äººåŠ›æˆæœ¬

**æˆæœ¬ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬ä¼˜åŒ–æ£€æŸ¥æ¸…å•
CREATE TABLE IF NOT EXISTS cost_optimization_checklist (
    check_id SERIAL PRIMARY KEY,
    check_item VARCHAR(200),
    check_category VARCHAR(50),
    check_status VARCHAR(20) DEFAULT 'å¾…æ£€æŸ¥',
    check_result TEXT,
    optimization_potential NUMERIC,
    priority INTEGER,
    checked_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥æ£€æŸ¥é¡¹
INSERT INTO cost_optimization_checklist
(check_item, check_category, optimization_potential, priority)
VALUES
('å®ä¾‹è§„æ ¼æ˜¯å¦åˆé€‚', 'è®¡ç®—æˆæœ¬', 20.0, 1),
('è¿æ¥æ± æ˜¯å¦é…ç½®', 'è®¡ç®—æˆæœ¬', 30.0, 2),
('æ…¢æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ–', 'è®¡ç®—æˆæœ¬', 25.0, 3),
('æ•°æ®æ˜¯å¦å‹ç¼©', 'å­˜å‚¨æˆæœ¬', 40.0, 4),
('å†·æ•°æ®æ˜¯å¦å½’æ¡£', 'å­˜å‚¨æˆæœ¬', 35.0, 5),
('å¤‡ä»½ç­–ç•¥æ˜¯å¦ä¼˜åŒ–', 'å­˜å‚¨æˆæœ¬', 30.0, 6),
('ç½‘ç»œä¼ è¾“æ˜¯å¦ä¼˜åŒ–', 'ç½‘ç»œæˆæœ¬', 20.0, 7),
('è‡ªåŠ¨åŒ–æ˜¯å¦å®æ–½', 'äººåŠ›æˆæœ¬', 50.0, 8);

-- æ‰§è¡Œæˆæœ¬ä¼˜åŒ–æ£€æŸ¥
CREATE OR REPLACE FUNCTION perform_cost_optimization_check()
RETURNS TABLE (
    check_item VARCHAR(200),
    check_category VARCHAR(50),
    check_status VARCHAR(20),
    optimization_potential NUMERIC,
    recommendation TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        c.check_item,
        c.check_category,
        c.check_status,
        c.optimization_potential,
        CASE
            WHEN c.optimization_potential >= 30 THEN 'é«˜ä¼˜å…ˆçº§ä¼˜åŒ–'
            WHEN c.optimization_potential >= 20 THEN 'ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–'
            ELSE 'ä½ä¼˜å…ˆçº§ä¼˜åŒ–'
        END AS recommendation
    FROM cost_optimization_checklist c
    WHERE c.check_status = 'å¾…æ£€æŸ¥'
    ORDER BY c.priority, c.optimization_potential DESC;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
SELECT * FROM perform_cost_optimization_check();
```

**æˆæœ¬ä¼˜åŒ–ROIåˆ†æ**ï¼š

```sql
-- åˆ›å»ºROIåˆ†æè¡¨
CREATE TABLE IF NOT EXISTS cost_optimization_roi (
    optimization_id SERIAL PRIMARY KEY,
    optimization_name VARCHAR(200),
    implementation_cost NUMERIC,
    monthly_savings NUMERIC,
    annual_savings NUMERIC,
    payback_period_months NUMERIC,
    roi_percentage NUMERIC,
    implementation_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥ä¼˜åŒ–ROIæ•°æ®
INSERT INTO cost_optimization_roi
(optimization_name, implementation_cost, monthly_savings, implementation_date)
VALUES
('æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–', 500.0, 120.0, CURRENT_DATE),
('è¿æ¥æ± é…ç½®', 200.0, 70.0, CURRENT_DATE),
('æŸ¥è¯¢ä¼˜åŒ–', 1000.0, 100.0, CURRENT_DATE),
('å¤‡ä»½å‹ç¼©', 300.0, 75.0, CURRENT_DATE);

-- è®¡ç®—ROIæŒ‡æ ‡
UPDATE cost_optimization_roi
SET
    annual_savings = monthly_savings * 12,
    payback_period_months = CASE
        WHEN monthly_savings > 0 THEN ROUND(implementation_cost / monthly_savings, 1)
        ELSE NULL
    END,
    roi_percentage = CASE
        WHEN implementation_cost > 0 THEN ROUND((monthly_savings * 12 - implementation_cost) / implementation_cost * 100, 2)
        ELSE NULL
    END;

-- æŸ¥è¯¢ROIåˆ†æ
SELECT
    optimization_name,
    ROUND(implementation_cost, 2) AS implementation_cost,
    ROUND(monthly_savings, 2) AS monthly_savings,
    ROUND(annual_savings, 2) AS annual_savings,
    payback_period_months || ' ä¸ªæœˆ' AS payback_period,
    roi_percentage || '%' AS roi_percentage,
    CASE
        WHEN payback_period_months <= 6 THEN 'ä¼˜ç§€'
        WHEN payback_period_months <= 12 THEN 'è‰¯å¥½'
        ELSE 'ä¸€èˆ¬'
    END AS roi_rating
FROM cost_optimization_roi
ORDER BY roi_percentage DESC NULLS LAST;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [äº‘æˆæœ¬ä¼˜åŒ–.md](./äº‘æˆæœ¬ä¼˜åŒ–.md) - äº‘æˆæœ¬ä¼˜åŒ–è¯¦è§£
- [èµ„æºä½¿ç”¨ä¼˜åŒ–.md](./èµ„æºä½¿ç”¨ä¼˜åŒ–.md) - èµ„æºä½¿ç”¨ä¼˜åŒ–
- [å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md](./å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md) - å­˜å‚¨æˆæœ¬ä¼˜åŒ–
- [21-æœ€ä½³å®è·µ/README.md](../README.md) - æœ€ä½³å®è·µä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
