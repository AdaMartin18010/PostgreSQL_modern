# PostgreSQL计算成本优化指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL计算成本优化指南](#postgresql计算成本优化指南)
  - [1. 概述](#1-概述)
  - [2. 查询优化](#2-查询优化)
  - [3. 索引优化](#3-索引优化)
  - [4. 连接优化](#4-连接优化)
  - [5. 配置优化](#5-配置优化)

---

## 1. 概述

计算成本优化通过减少CPU使用降低计算成本。

**优化策略**:
- 查询优化
- 索引优化
- 连接优化
- 配置优化

---

## 2. 查询优化

### 2.1 慢查询优化

```sql
-- 查找慢查询
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 2.2 查询重写

```sql
-- 优化前
SELECT * FROM users WHERE email LIKE '%@example.com';

-- 优化后
SELECT * FROM users WHERE email LIKE 'user%@example.com';
-- 使用前缀索引
CREATE INDEX idx_users_email_prefix ON users(email text_pattern_ops);
```

---

## 3. 索引优化

### 3.1 索引分析

```sql
-- 分析索引使用
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan;
```

### 3.2 索引维护

```sql
-- 删除未使用的索引
DROP INDEX IF EXISTS unused_index;

-- 重建索引
REINDEX INDEX idx_users_email;
```

---

## 4. 连接优化

### 4.1 连接池

```text
使用PgBouncer:
- 减少连接数
- 提高资源利用率
- 降低内存使用
```

### 4.2 连接管理

```sql
-- 限制连接数
ALTER DATABASE mydb CONNECTION LIMIT 100;

-- 查看连接使用
SELECT COUNT(*) FROM pg_stat_activity;
```

---

## 5. 配置优化

### 5.1 性能参数

```text
shared_buffers = 25% of RAM
work_mem = (RAM - shared_buffers) / max_connections
effective_cache_size = 50-75% of RAM
max_connections = 根据实际需求
```

### 5.2 并行查询

```sql
-- 启用并行查询
SET max_parallel_workers_per_gather = 4;
SET max_parallel_workers = 8;
```

---

## 📚 相关文档

- [成本优化完整指南.md](./成本优化完整指南.md) - 成本优化完整指南
- [资源使用优化.md](./资源使用优化.md) - 资源使用优化
- [存储成本优化.md](./存储成本优化.md) - 存储成本优化
- [21-最佳实践/README.md](../README.md) - 最佳实践主题

---

**最后更新**: 2025年1月
