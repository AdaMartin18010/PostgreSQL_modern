# PostgreSQLäº‘æˆæœ¬ä¼˜åŒ–æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLäº‘æˆæœ¬ä¼˜åŒ–æŒ‡å—](#postgresqläº‘æˆæœ¬ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å®ä¾‹é€‰æ‹©](#2-å®ä¾‹é€‰æ‹©)
    - [2.1 å®ä¾‹è§„æ ¼](#21-å®ä¾‹è§„æ ¼)
    - [2.2 é€‰æ‹©ç­–ç•¥](#22-é€‰æ‹©ç­–ç•¥)
  - [3. å­˜å‚¨ä¼˜åŒ–](#3-å­˜å‚¨ä¼˜åŒ–)
    - [3.1 å­˜å‚¨ç±»å‹](#31-å­˜å‚¨ç±»å‹)
    - [3.2 ä¼˜åŒ–ç­–ç•¥](#32-ä¼˜åŒ–ç­–ç•¥)
  - [4. ç½‘ç»œä¼˜åŒ–](#4-ç½‘ç»œä¼˜åŒ–)
    - [4.1 ç½‘ç»œæˆæœ¬](#41-ç½‘ç»œæˆæœ¬)
    - [4.2 ä¼˜åŒ–ç­–ç•¥](#42-ä¼˜åŒ–ç­–ç•¥)
  - [5. äº‘å¹³å°ä¼˜åŒ–](#5-äº‘å¹³å°ä¼˜åŒ–)
    - [5.1 AWSä¼˜åŒ–](#51-awsä¼˜åŒ–)
    - [5.2 Azureä¼˜åŒ–](#52-azureä¼˜åŒ–)
    - [5.3 Google Cloudä¼˜åŒ–](#53-google-cloudä¼˜åŒ–)
    - [5.4 å¤šäº‘æˆæœ¬å¯¹æ¯”](#54-å¤šäº‘æˆæœ¬å¯¹æ¯”)
    - [5.5 æˆæœ¬ç›‘æ§å’Œå‘Šè­¦](#55-æˆæœ¬ç›‘æ§å’Œå‘Šè­¦)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

äº‘æˆæœ¬ä¼˜åŒ–é’ˆå¯¹äº‘ç¯å¢ƒä¸‹çš„PostgreSQLéƒ¨ç½²ï¼Œé™ä½äº‘æœåŠ¡æˆæœ¬ã€‚

**ä¼˜åŒ–é‡ç‚¹**:

- å®ä¾‹è§„æ ¼é€‰æ‹©
- å­˜å‚¨ç±»å‹é€‰æ‹©
- ç½‘ç»œæµé‡ä¼˜åŒ–
- äº‘å¹³å°ç‰¹æ€§åˆ©ç”¨

---

## 2. å®ä¾‹é€‰æ‹©

### 2.1 å®ä¾‹è§„æ ¼

| è§„æ ¼ç±»å‹ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ |
| --- | --- | --- |
| **é€šç”¨å‹** | å¤§å¤šæ•°åœºæ™¯ | ä¸­ç­‰ |
| **è®¡ç®—ä¼˜åŒ–** | CPUå¯†é›†å‹ | è¾ƒé«˜ |
| **å†…å­˜ä¼˜åŒ–** | å†…å­˜å¯†é›†å‹ | è¾ƒé«˜ |
| **å­˜å‚¨ä¼˜åŒ–** | å­˜å‚¨å¯†é›†å‹ | è¾ƒä½ |

### 2.2 é€‰æ‹©ç­–ç•¥

**é€‰æ‹©æµç¨‹**ï¼š

```text
1. è¯„ä¼°å·¥ä½œè´Ÿè½½
2. é€‰æ‹©åˆé€‚çš„è§„æ ¼
3. ä½¿ç”¨é¢„ç•™å®ä¾‹
4. å®šæœŸè¯„ä¼°è°ƒæ•´
```

**å®ä¾‹é€‰æ‹©å†³ç­–çŸ©é˜µ**ï¼š

```sql
-- åˆ›å»ºå®ä¾‹é€‰æ‹©å†³ç­–è¡¨
CREATE TABLE IF NOT EXISTS instance_selection_matrix (
    workload_type VARCHAR(50) PRIMARY KEY,
    cpu_intensive BOOLEAN,
    memory_intensive BOOLEAN,
    io_intensive BOOLEAN,
    recommended_instance_type VARCHAR(50),
    cost_per_hour NUMERIC,
    notes TEXT
);

-- æ’å…¥å®ä¾‹é€‰æ‹©å»ºè®®
INSERT INTO instance_selection_matrix
(workload_type, cpu_intensive, memory_intensive, io_intensive, recommended_instance_type, cost_per_hour, notes)
VALUES
('OLTP', false, false, true, 'é€šç”¨å‹', 0.5, 'é€‚åˆå¤§å¤šæ•°äº‹åŠ¡å¤„ç†åœºæ™¯'),
('OLAP', true, true, false, 'è®¡ç®—ä¼˜åŒ–+å†…å­˜ä¼˜åŒ–', 1.5, 'é€‚åˆåˆ†ææŸ¥è¯¢åœºæ™¯'),
('æ··åˆè´Ÿè½½', false, false, false, 'é€šç”¨å‹', 0.5, 'é€‚åˆæ··åˆå·¥ä½œè´Ÿè½½'),
('å†…å­˜æ•°æ®åº“', false, true, false, 'å†…å­˜ä¼˜åŒ–', 2.0, 'é€‚åˆå†…å­˜å¯†é›†å‹åœºæ™¯'),
('æ‰¹é‡å¤„ç†', true, false, false, 'è®¡ç®—ä¼˜åŒ–', 1.0, 'é€‚åˆCPUå¯†é›†å‹æ‰¹å¤„ç†')
ON CONFLICT (workload_type) DO UPDATE SET
    recommended_instance_type = EXCLUDED.recommended_instance_type,
    cost_per_hour = EXCLUDED.cost_per_hour;

-- æŸ¥è¯¢å®ä¾‹é€‰æ‹©å»ºè®®
SELECT
    workload_type,
    recommended_instance_type,
    cost_per_hour,
    notes
FROM instance_selection_matrix
ORDER BY cost_per_hour;
```

**é¢„ç•™å®ä¾‹æˆæœ¬åˆ†æ**ï¼š

```sql
-- åˆ›å»ºé¢„ç•™å®ä¾‹æˆæœ¬åˆ†æè¡¨
CREATE TABLE IF NOT EXISTS reserved_instance_analysis (
    instance_type VARCHAR(50),
    on_demand_price NUMERIC,
    reserved_1year_price NUMERIC,
    reserved_3year_price NUMERIC,
    savings_1year NUMERIC,
    savings_3year NUMERIC,
    break_even_days INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥é¢„ç•™å®ä¾‹æˆæœ¬æ•°æ®
INSERT INTO reserved_instance_analysis
(instance_type, on_demand_price, reserved_1year_price, reserved_3year_price)
VALUES
('db.t3.medium', 0.072, 0.036, 0.024),
('db.r5.large', 0.192, 0.096, 0.064),
('db.m5.xlarge', 0.384, 0.192, 0.128);

-- è®¡ç®—èŠ‚çœé‡‘é¢å’Œå›æœ¬å¤©æ•°
UPDATE reserved_instance_analysis
SET
    savings_1year = (on_demand_price - reserved_1year_price) * 24 * 365,
    savings_3year = (on_demand_price - reserved_3year_price) * 24 * 365 * 3,
    break_even_days = CASE
        WHEN reserved_1year_price > 0 THEN
            ROUND((reserved_1year_price * 24 * 365) / ((on_demand_price - reserved_1year_price) * 24))
        ELSE NULL
    END;

-- æŸ¥è¯¢é¢„ç•™å®ä¾‹æˆæœ¬åˆ†æ
SELECT
    instance_type,
    on_demand_price,
    reserved_1year_price,
    reserved_3year_price,
    ROUND(savings_1year, 2) AS annual_savings_1year,
    ROUND(savings_3year, 2) AS total_savings_3year,
    break_even_days,
    CASE
        WHEN break_even_days <= 180 THEN 'å¼ºçƒˆæ¨è'
        WHEN break_even_days <= 365 THEN 'æ¨è'
        ELSE 'ä¸æ¨è'
    END AS recommendation
FROM reserved_instance_analysis
ORDER BY savings_1year DESC;
```

---

## 3. å­˜å‚¨ä¼˜åŒ–

### 3.1 å­˜å‚¨ç±»å‹

| å­˜å‚¨ç±»å‹ | æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- |
| **SSD** | é«˜ | é«˜ | ç”Ÿäº§ç¯å¢ƒ |
| **HDD** | ä¸­ | ä½ | å¤‡ä»½å½’æ¡£ |
| **å†·å­˜å‚¨** | ä½ | æä½ | é•¿æœŸå½’æ¡£ |

### 3.2 ä¼˜åŒ–ç­–ç•¥

**å­˜å‚¨åˆ†å±‚ç­–ç•¥**ï¼š

```text
1. çƒ­æ•°æ®ä½¿ç”¨SSD
2. å†·æ•°æ®ä½¿ç”¨HDD
3. å½’æ¡£æ•°æ®ä½¿ç”¨å†·å­˜å‚¨
4. å®šæœŸæ•°æ®è¿ç§»
```

**å­˜å‚¨æˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- åˆ›å»ºå­˜å‚¨åˆ†å±‚é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS storage_tier_config (
    table_name VARCHAR(200) PRIMARY KEY,
    schema_name VARCHAR(100),
    access_frequency VARCHAR(20),
    current_storage_type VARCHAR(50),
    recommended_storage_type VARCHAR(50),
    data_size_gb NUMERIC,
    monthly_cost_current NUMERIC,
    monthly_cost_recommended NUMERIC,
    potential_savings NUMERIC,
    migration_priority INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ†æè¡¨å­˜å‚¨ä½¿ç”¨æƒ…å†µ
INSERT INTO storage_tier_config
(table_name, schema_name, access_frequency, current_storage_type, data_size_gb)
SELECT
    tablename,
    schemaname,
    CASE
        WHEN last_vacuum > NOW() - INTERVAL '7 days' THEN 'çƒ­æ•°æ®'
        WHEN last_vacuum > NOW() - INTERVAL '30 days' THEN 'æ¸©æ•°æ®'
        ELSE 'å†·æ•°æ®'
    END AS access_frequency,
    'SSD' AS current_storage_type,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))::NUMERIC / 1024 / 1024 / 1024 AS data_size_gb
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æ›´æ–°æ¨èå­˜å‚¨ç±»å‹å’Œæˆæœ¬
UPDATE storage_tier_config
SET
    recommended_storage_type = CASE
        WHEN access_frequency = 'çƒ­æ•°æ®' THEN 'SSD'
        WHEN access_frequency = 'æ¸©æ•°æ®' THEN 'HDD'
        ELSE 'å†·å­˜å‚¨'
    END,
    monthly_cost_current = CASE
        WHEN current_storage_type = 'SSD' THEN data_size_gb * 0.1
        WHEN current_storage_type = 'HDD' THEN data_size_gb * 0.05
        ELSE data_size_gb * 0.01
    END,
    monthly_cost_recommended = CASE
        WHEN access_frequency = 'çƒ­æ•°æ®' THEN data_size_gb * 0.1
        WHEN access_frequency = 'æ¸©æ•°æ®' THEN data_size_gb * 0.05
        ELSE data_size_gb * 0.01
    END,
    potential_savings = CASE
        WHEN current_storage_type = 'SSD' AND access_frequency = 'å†·æ•°æ®' THEN data_size_gb * 0.09
        WHEN current_storage_type = 'SSD' AND access_frequency = 'æ¸©æ•°æ®' THEN data_size_gb * 0.05
        ELSE 0
    END,
    migration_priority = CASE
        WHEN access_frequency = 'å†·æ•°æ®' AND current_storage_type = 'SSD' THEN 1
        WHEN access_frequency = 'æ¸©æ•°æ®' AND current_storage_type = 'SSD' THEN 2
        ELSE 3
    END;

-- æŸ¥è¯¢å­˜å‚¨ä¼˜åŒ–å»ºè®®
SELECT
    table_name,
    access_frequency,
    current_storage_type,
    recommended_storage_type,
    ROUND(data_size_gb, 2) AS size_gb,
    ROUND(monthly_cost_current, 2) AS current_cost,
    ROUND(monthly_cost_recommended, 2) AS recommended_cost,
    ROUND(potential_savings, 2) AS monthly_savings,
    migration_priority
FROM storage_tier_config
WHERE potential_savings > 0
ORDER BY potential_savings DESC, migration_priority;
```

**è‡ªåŠ¨æ•°æ®è¿ç§»è„šæœ¬**ï¼š

```sql
-- åˆ›å»ºæ•°æ®è¿ç§»å‡½æ•°
CREATE OR REPLACE FUNCTION migrate_to_cold_storage(
    p_table_name VARCHAR(200),
    p_schema_name VARCHAR(100) DEFAULT 'public'
)
RETURNS TABLE (
    migration_status TEXT,
    rows_migrated BIGINT,
    storage_saved_gb NUMERIC
) AS $$
DECLARE
    v_row_count BIGINT;
    v_table_size_gb NUMERIC;
    v_archive_table_name VARCHAR(200);
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = p_schema_name
          AND table_name = p_table_name
    ) THEN
        RETURN QUERY SELECT 'è¡¨ä¸å­˜åœ¨'::TEXT, 0::BIGINT, 0::NUMERIC;
        RETURN;
    END IF;

    -- åˆ›å»ºå½’æ¡£è¡¨
    v_archive_table_name := p_table_name || '_archive_' || to_char(NOW(), 'YYYYMMDD');

    EXECUTE format('CREATE TABLE %I.%I (LIKE %I.%I INCLUDING ALL)',
        p_schema_name, v_archive_table_name, p_schema_name, p_table_name);

    -- è¿ç§»æ•°æ®ï¼ˆç¤ºä¾‹ï¼šè¿ç§»6ä¸ªæœˆå‰çš„æ•°æ®ï¼‰
    EXECUTE format('
        INSERT INTO %I.%I
        SELECT * FROM %I.%I
        WHERE created_at < NOW() - INTERVAL ''6 months''
    ', p_schema_name, v_archive_table_name, p_schema_name, p_table_name);

    GET DIAGNOSTICS v_row_count = ROW_COUNT;

    -- åˆ é™¤å·²è¿ç§»çš„æ•°æ®
    EXECUTE format('
        DELETE FROM %I.%I
        WHERE created_at < NOW() - INTERVAL ''6 months''
    ', p_schema_name, p_table_name);

    -- è®¡ç®—èŠ‚çœçš„å­˜å‚¨ç©ºé—´
    SELECT pg_size_pretty(pg_total_relation_size(p_schema_name||'.'||v_archive_table_name))::NUMERIC / 1024 / 1024 / 1024
    INTO v_table_size_gb;

    RETURN QUERY SELECT 'è¿ç§»å®Œæˆ'::TEXT, v_row_count, v_table_size_gb;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM migrate_to_cold_storage('orders', 'public');
```

---

## 4. ç½‘ç»œä¼˜åŒ–

### 4.1 ç½‘ç»œæˆæœ¬

```text
1. åŒåŒºåŸŸä¼ è¾“ - å…è´¹
2. è·¨åŒºåŸŸä¼ è¾“ - æ”¶è´¹
3. å…¬ç½‘ä¼ è¾“ - æ”¶è´¹
4. CDNåŠ é€Ÿ - æ”¶è´¹
```

### 4.2 ä¼˜åŒ–ç­–ç•¥

```text
1. æ•°æ®æœ¬åœ°åŒ–
2. ä½¿ç”¨å†…ç½‘ä¼ è¾“
3. æ‰¹é‡æ“ä½œ
4. å‹ç¼©ä¼ è¾“
```

---

## 5. äº‘å¹³å°ä¼˜åŒ–

### 5.1 AWSä¼˜åŒ–

```text
1. ä½¿ç”¨RDSé¢„ç•™å®ä¾‹
2. ä½¿ç”¨Aurora Serverless
3. ä½¿ç”¨S3å½’æ¡£
4. ä½¿ç”¨CloudWatchç›‘æ§
```

### 5.2 Azureä¼˜åŒ–

**Azureä¼˜åŒ–ç­–ç•¥**ï¼š

```text
1. ä½¿ç”¨Azure Databaseé¢„ç•™å®¹é‡
2. ä½¿ç”¨Azure Blobå†·å­˜å‚¨
3. ä½¿ç”¨Azure Monitor
4. ä½¿ç”¨Azure Cost Management
```

**Azureæˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- Azure Databaseé¢„ç•™å®¹é‡åˆ†æ
CREATE TABLE IF NOT EXISTS azure_reserved_capacity (
    sku_name VARCHAR(100),
    region VARCHAR(50),
    on_demand_price NUMERIC,
    reserved_1year_price NUMERIC,
    reserved_3year_price NUMERIC,
    savings_percentage_1year NUMERIC,
    savings_percentage_3year NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥Azureé¢„ç•™å®¹é‡æ•°æ®
INSERT INTO azure_reserved_capacity
(sku_name, region, on_demand_price, reserved_1year_price, reserved_3year_price)
VALUES
('GP_Gen5_2', 'eastus', 0.272, 0.163, 0.109),
('BC_Gen5_2', 'eastus', 0.544, 0.326, 0.218);

-- è®¡ç®—èŠ‚çœç™¾åˆ†æ¯”
UPDATE azure_reserved_capacity
SET
    savings_percentage_1year = ROUND((on_demand_price - reserved_1year_price) / on_demand_price * 100, 2),
    savings_percentage_3year = ROUND((on_demand_price - reserved_3year_price) / on_demand_price * 100, 2);

-- æŸ¥è¯¢Azureé¢„ç•™å®¹é‡å»ºè®®
SELECT
    sku_name,
    region,
    on_demand_price,
    reserved_1year_price,
    reserved_3year_price,
    savings_percentage_1year || '%' AS savings_1year,
    savings_percentage_3year || '%' AS savings_3year,
    CASE
        WHEN savings_percentage_1year >= 40 THEN 'å¼ºçƒˆæ¨è'
        WHEN savings_percentage_1year >= 30 THEN 'æ¨è'
        ELSE 'è€ƒè™‘'
    END AS recommendation
FROM azure_reserved_capacity
ORDER BY savings_percentage_1year DESC;
```

### 5.3 Google Cloudä¼˜åŒ–

**GCPä¼˜åŒ–ç­–ç•¥**ï¼š

```text
1. ä½¿ç”¨Cloud SQLé¢„ç•™å®ä¾‹
2. ä½¿ç”¨Cloud Storageå½’æ¡£å­˜å‚¨
3. ä½¿ç”¨Cloud Monitoring
4. ä½¿ç”¨Cloud Billingé¢„ç®—å‘Šè­¦
```

**GCPæˆæœ¬ä¼˜åŒ–å®ç°**ï¼š

```sql
-- GCPé¢„ç•™å®ä¾‹åˆ†æ
CREATE TABLE IF NOT EXISTS gcp_reserved_instances (
    machine_type VARCHAR(100),
    region VARCHAR(50),
    on_demand_price NUMERIC,
    committed_use_1year_price NUMERIC,
    committed_use_3year_price NUMERIC,
    sustained_use_discount NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥GCPé¢„ç•™å®ä¾‹æ•°æ®
INSERT INTO gcp_reserved_instances
(machine_type, region, on_demand_price, committed_use_1year_price, committed_use_3year_price, sustained_use_discount)
VALUES
('db-n1-standard-2', 'us-central1', 0.19, 0.114, 0.076, 0.15),
('db-n1-highmem-2', 'us-central1', 0.38, 0.228, 0.152, 0.15);

-- æŸ¥è¯¢GCPä¼˜åŒ–å»ºè®®
SELECT
    machine_type,
    region,
    on_demand_price,
    committed_use_1year_price,
    committed_use_3year_price,
    ROUND((on_demand_price - committed_use_1year_price) / on_demand_price * 100, 2) || '%' AS savings_1year,
    ROUND((on_demand_price - committed_use_3year_price) / on_demand_price * 100, 2) || '%' AS savings_3year,
    sustained_use_discount || '%' AS sustained_discount
FROM gcp_reserved_instances
ORDER BY (on_demand_price - committed_use_1year_price) / on_demand_price DESC;
```

### 5.4 å¤šäº‘æˆæœ¬å¯¹æ¯”

**å¤šäº‘æˆæœ¬å¯¹æ¯”åˆ†æ**ï¼š

```sql
-- åˆ›å»ºå¤šäº‘æˆæœ¬å¯¹æ¯”è¡¨
CREATE TABLE IF NOT EXISTS multi_cloud_cost_comparison (
    provider VARCHAR(50),
    instance_type VARCHAR(100),
    region VARCHAR(50),
    on_demand_price NUMERIC,
    reserved_1year_price NUMERIC,
    storage_price_per_gb NUMERIC,
    network_price_per_gb NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥å¤šäº‘æˆæœ¬æ•°æ®
INSERT INTO multi_cloud_cost_comparison
(provider, instance_type, region, on_demand_price, reserved_1year_price, storage_price_per_gb, network_price_per_gb)
VALUES
('AWS', 'db.t3.medium', 'us-east-1', 0.072, 0.036, 0.1, 0.09),
('Azure', 'GP_Gen5_2', 'eastus', 0.272, 0.163, 0.115, 0.05),
('GCP', 'db-n1-standard-2', 'us-central1', 0.19, 0.114, 0.17, 0.12);

-- æŸ¥è¯¢å¤šäº‘æˆæœ¬å¯¹æ¯”
SELECT
    provider,
    instance_type,
    region,
    on_demand_price,
    reserved_1year_price,
    ROUND((on_demand_price - reserved_1year_price) / on_demand_price * 100, 2) || '%' AS savings_percentage,
    storage_price_per_gb,
    network_price_per_gb,
    ROW_NUMBER() OVER (ORDER BY reserved_1year_price) AS cost_rank
FROM multi_cloud_cost_comparison
ORDER BY reserved_1year_price;
```

### 5.5 æˆæœ¬ç›‘æ§å’Œå‘Šè­¦

**æˆæœ¬ç›‘æ§å®ç°**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬ç›‘æ§è¡¨
CREATE TABLE IF NOT EXISTS cost_monitoring (
    monitoring_id SERIAL PRIMARY KEY,
    resource_type VARCHAR(50),
    resource_name VARCHAR(200),
    daily_cost NUMERIC,
    monthly_cost NUMERIC,
    cost_trend VARCHAR(20),
    alert_threshold NUMERIC,
    alert_status VARCHAR(20),
    monitoring_date DATE DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥æˆæœ¬ç›‘æ§æ•°æ®
INSERT INTO cost_monitoring
(resource_type, resource_name, daily_cost, monthly_cost, cost_trend, alert_threshold)
VALUES
('æ•°æ®åº“å®ä¾‹', 'prod-db-1', 10.5, 315.0, 'ç¨³å®š', 400.0),
('å­˜å‚¨', 'prod-storage', 5.2, 156.0, 'ä¸Šå‡', 200.0),
('ç½‘ç»œ', 'prod-network', 2.1, 63.0, 'ç¨³å®š', 100.0);

-- æ›´æ–°å‘Šè­¦çŠ¶æ€
UPDATE cost_monitoring
SET alert_status = CASE
    WHEN monthly_cost > alert_threshold THEN 'å‘Šè­¦'
    WHEN monthly_cost > alert_threshold * 0.8 THEN 'è­¦å‘Š'
    ELSE 'æ­£å¸¸'
END;

-- æŸ¥è¯¢æˆæœ¬å‘Šè­¦
SELECT
    resource_type,
    resource_name,
    ROUND(monthly_cost, 2) AS monthly_cost,
    alert_threshold,
    alert_status,
    cost_trend
FROM cost_monitoring
WHERE alert_status IN ('å‘Šè­¦', 'è­¦å‘Š')
ORDER BY monthly_cost DESC;
```

**æˆæœ¬é¢„ç®—ç®¡ç†**ï¼š

```sql
-- åˆ›å»ºæˆæœ¬é¢„ç®—è¡¨
CREATE TABLE IF NOT EXISTS cost_budgets (
    budget_id SERIAL PRIMARY KEY,
    budget_name VARCHAR(200),
    budget_amount NUMERIC,
    budget_period VARCHAR(20),
    current_spend NUMERIC,
    spend_percentage NUMERIC,
    alert_threshold_percentage NUMERIC,
    alert_status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥é¢„ç®—æ•°æ®
INSERT INTO cost_budgets
(budget_name, budget_amount, budget_period, current_spend, alert_threshold_percentage)
VALUES
('æ•°æ®åº“æˆæœ¬é¢„ç®—', 1000.0, 'æœˆåº¦', 750.0, 80.0),
('å­˜å‚¨æˆæœ¬é¢„ç®—', 500.0, 'æœˆåº¦', 400.0, 80.0);

-- æ›´æ–°é¢„ç®—çŠ¶æ€
UPDATE cost_budgets
SET
    spend_percentage = ROUND(current_spend / budget_amount * 100, 2),
    alert_status = CASE
        WHEN current_spend >= budget_amount THEN 'è¶…é¢„ç®—'
        WHEN current_spend >= budget_amount * alert_threshold_percentage / 100 THEN 'æ¥è¿‘é¢„ç®—'
        ELSE 'æ­£å¸¸'
    END;

-- æŸ¥è¯¢é¢„ç®—çŠ¶æ€
SELECT
    budget_name,
    budget_amount,
    current_spend,
    spend_percentage || '%' AS spend_percentage,
    alert_status
FROM cost_budgets
ORDER BY spend_percentage DESC;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—.md](./æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—.md) - æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—
- [èµ„æºä½¿ç”¨ä¼˜åŒ–.md](./èµ„æºä½¿ç”¨ä¼˜åŒ–.md) - èµ„æºä½¿ç”¨ä¼˜åŒ–
- [å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md](./å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md) - å­˜å‚¨æˆæœ¬ä¼˜åŒ–
- [21-æœ€ä½³å®è·µ/README.md](../README.md) - æœ€ä½³å®è·µä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
