# PostgreSQL存储成本优化指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL存储成本优化指南](#postgresql存储成本优化指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 数据压缩](#2-数据压缩)
    - [2.1 TOAST压缩](#21-toast压缩)
    - [2.2 表压缩](#22-表压缩)
  - [3. 数据归档](#3-数据归档)
    - [3.1 归档策略](#31-归档策略)
    - [3.2 分区归档](#32-分区归档)
  - [4. 备份优化](#4-备份优化)
    - [4.1 增量备份](#41-增量备份)
    - [4.2 备份压缩](#42-备份压缩)
  - [5. 分区优化](#5-分区优化)
    - [5.1 分区管理](#51-分区管理)
    - [5.2 分区归档](#52-分区归档)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

存储成本优化通过减少存储空间降低存储成本。

**优化策略**:

- 数据压缩
- 数据归档
- 备份优化
- 分区管理

---

## 2. 数据压缩

### 2.1 TOAST压缩

```sql
-- 查看TOAST表
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 2.2 表压缩

```sql
-- 使用pg_repack压缩
pg_repack -d mydb -t users

-- 或使用ALTER TABLE
ALTER TABLE users SET (fillfactor = 90);
```

---

## 3. 数据归档

### 3.1 归档策略

```sql
-- 归档历史数据
CREATE TABLE users_archive (LIKE users INCLUDING ALL);

INSERT INTO users_archive
SELECT * FROM users
WHERE created_at < CURRENT_DATE - INTERVAL '1 year';

DELETE FROM users
WHERE created_at < CURRENT_DATE - INTERVAL '1 year';
```

### 3.2 分区归档

```sql
-- 删除旧分区
DROP TABLE IF EXISTS orders_2023_01;

-- 或迁移到归档表
ALTER TABLE orders_2023_01 SET TABLESPACE archive_tablespace;
```

---

## 4. 备份优化

### 4.1 增量备份

```bash
# PostgreSQL 18增量备份
pg_basebackup --incremental -D /backup/inc

# 减少备份存储
```

### 4.2 备份压缩

```bash
# 压缩备份
pg_dump -Fc -Z 9 mydb > backup.dump

# 或使用压缩工具
pg_dump mydb | gzip > backup.sql.gz
```

---

## 5. 分区优化

### 5.1 分区管理

```sql
-- 按时间分区
CREATE TABLE orders (
    id SERIAL,
    order_date DATE,
    amount NUMERIC
) PARTITION BY RANGE (order_date);

-- 创建分区
CREATE TABLE orders_2024_01 PARTITION OF orders
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### 5.2 分区归档

```sql
-- 分离旧分区
ALTER TABLE orders DETACH PARTITION orders_2023_01;

-- 移动到归档表空间
ALTER TABLE orders_2023_01 SET TABLESPACE archive_tablespace;
```

---

## 📚 相关文档

- [成本优化完整指南.md](./成本优化完整指南.md) - 成本优化完整指南
- [资源使用优化.md](./资源使用优化.md) - 资源使用优化
- [计算成本优化.md](./计算成本优化.md) - 计算成本优化
- [21-最佳实践/README.md](../README.md) - 最佳实践主题

---

**最后更新**: 2025年1月
