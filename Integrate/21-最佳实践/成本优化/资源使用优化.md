# PostgreSQLèµ„æºä½¿ç”¨ä¼˜åŒ–æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLèµ„æºä½¿ç”¨ä¼˜åŒ–æŒ‡å—](#postgresqlèµ„æºä½¿ç”¨ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. CPUä¼˜åŒ–](#2-cpuä¼˜åŒ–)
    - [2.1 æŸ¥è¯¢ä¼˜åŒ–](#21-æŸ¥è¯¢ä¼˜åŒ–)
    - [2.2 å¹¶è¡ŒæŸ¥è¯¢](#22-å¹¶è¡ŒæŸ¥è¯¢)
  - [3. å†…å­˜ä¼˜åŒ–](#3-å†…å­˜ä¼˜åŒ–)
    - [3.1 å…±äº«ç¼“å†²åŒº](#31-å…±äº«ç¼“å†²åŒº)
    - [3.2 ä¼˜åŒ–é…ç½®](#32-ä¼˜åŒ–é…ç½®)
  - [4. I/Oä¼˜åŒ–](#4-ioä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æ‰¹é‡æ“ä½œ](#42-æ‰¹é‡æ“ä½œ)
  - [5. è¿æ¥ä¼˜åŒ–](#5-è¿æ¥ä¼˜åŒ–)
    - [5.1 è¿æ¥æ± ](#51-è¿æ¥æ± )
    - [5.2 è¿æ¥ç®¡ç†](#52-è¿æ¥ç®¡ç†)
    - [5.3 èµ„æºä½¿ç”¨ä¼˜åŒ–æœ€ä½³å®è·µ](#53-èµ„æºä½¿ç”¨ä¼˜åŒ–æœ€ä½³å®è·µ)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

èµ„æºä½¿ç”¨ä¼˜åŒ–é€šè¿‡æé«˜èµ„æºåˆ©ç”¨ç‡é™ä½å•ä½æˆæœ¬ã€‚

**ä¼˜åŒ–ç›®æ ‡**:

- æé«˜CPUåˆ©ç”¨ç‡
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- å‡å°‘I/Oæ“ä½œ
- ä¼˜åŒ–è¿æ¥æ•°

---

## 2. CPUä¼˜åŒ–

### 2.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–æ…¢æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users WHERE email = 'test@example.com';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
```

### 2.2 å¹¶è¡ŒæŸ¥è¯¢

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;

-- å¹¶è¡Œæ‰§è¡Œ
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM large_table WHERE condition;
```

---

## 3. å†…å­˜ä¼˜åŒ–

### 3.1 å…±äº«ç¼“å†²åŒº

```sql
-- æŸ¥çœ‹å†…å­˜ä½¿ç”¨
SELECT
    name,
    setting,
    unit
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem');
```

### 3.2 ä¼˜åŒ–é…ç½®

**å†…å­˜é…ç½®ä¼˜åŒ–**ï¼š

```text
shared_buffers = 25% of RAM
work_mem = (RAM - shared_buffers) / max_connections
effective_cache_size = 50-75% of RAM
```

**å†…å­˜é…ç½®ä¼˜åŒ–å®ç°**ï¼š

```sql
-- åˆ›å»ºå†…å­˜é…ç½®åˆ†æè¡¨
CREATE TABLE IF NOT EXISTS memory_config_analysis (
    config_id SERIAL PRIMARY KEY,
    config_name VARCHAR(100),
    current_value NUMERIC,
    recommended_value NUMERIC,
    unit VARCHAR(20),
    optimization_potential NUMERIC,
    analysis_date TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥å†…å­˜é…ç½®æ•°æ®
INSERT INTO memory_config_analysis
(config_name, current_value, unit)
SELECT
    name,
    setting::NUMERIC,
    unit
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'effective_cache_size', 'maintenance_work_mem');

-- è®¡ç®—æ¨èå€¼ï¼ˆå‡è®¾ç³»ç»Ÿæœ‰16GB RAMï¼‰
UPDATE memory_config_analysis
SET
    recommended_value = CASE
        WHEN config_name = 'shared_buffers' THEN 4096 -- 4GB (25% of 16GB)
        WHEN config_name = 'work_mem' THEN 32 -- 32MB (å‡è®¾max_connections=100)
        WHEN config_name = 'effective_cache_size' THEN 12288 -- 12GB (75% of 16GB)
        WHEN config_name = 'maintenance_work_mem' THEN 1024 -- 1GB
        ELSE current_value
    END,
    optimization_potential = CASE
        WHEN config_name = 'shared_buffers' AND current_value < 4096 THEN
            ROUND((4096 - current_value) / 4096 * 100, 2)
        WHEN config_name = 'work_mem' AND current_value < 32 THEN
            ROUND((32 - current_value) / 32 * 100, 2)
        ELSE 0
    END;

-- æŸ¥è¯¢å†…å­˜é…ç½®ä¼˜åŒ–å»ºè®®
SELECT
    config_name,
    current_value || COALESCE(' ' || unit, '') AS current_value,
    recommended_value || COALESCE(' ' || unit, '') AS recommended_value,
    optimization_potential || '%' AS optimization_potential,
    CASE
        WHEN optimization_potential > 20 THEN 'é«˜ä¼˜å…ˆçº§ä¼˜åŒ–'
        WHEN optimization_potential > 10 THEN 'ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–'
        ELSE 'ä½ä¼˜å…ˆçº§ä¼˜åŒ–'
    END AS priority
FROM memory_config_analysis
ORDER BY optimization_potential DESC;
```

**å†…å­˜ä½¿ç”¨ç›‘æ§**ï¼š

```sql
-- åˆ›å»ºå†…å­˜ä½¿ç”¨ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW memory_usage_monitoring AS
SELECT
    'å…±äº«ç¼“å†²åŒº' AS memory_type,
    pg_size_pretty(setting::BIGINT * 8192) AS allocated_size,
    pg_size_pretty(
        (SELECT SUM(buffers_alloc) * 8192 FROM pg_stat_bgwriter)
    ) AS used_size,
    ROUND(
        (SELECT SUM(buffers_alloc)::NUMERIC / NULLIF(setting::NUMERIC, 0) * 100
         FROM pg_stat_bgwriter, pg_settings
         WHERE pg_settings.name = 'shared_buffers'), 2
    ) || '%' AS usage_percentage
FROM pg_settings
WHERE name = 'shared_buffers'
UNION ALL
SELECT
    'å·¥ä½œå†…å­˜',
    pg_size_pretty(setting::BIGINT * 1024),
    pg_size_pretty(
        (SELECT SUM(work_mem_bytes) FROM pg_stat_statements)
    ),
    'N/A'
FROM pg_settings
WHERE name = 'work_mem';

-- æŸ¥è¯¢å†…å­˜ä½¿ç”¨æƒ…å†µ
SELECT * FROM memory_usage_monitoring;
```

---

## 4. I/Oä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ†æç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 4.2 æ‰¹é‡æ“ä½œ

**æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼š

```sql
-- æ‰¹é‡æ’å…¥
INSERT INTO users (name, email)
SELECT name, email FROM staging_users;

-- æ‰¹é‡æ›´æ–°
UPDATE users SET status = 'active'
WHERE last_login > CURRENT_DATE - INTERVAL '30 days';
```

**æ‰¹é‡æ“ä½œæ€§èƒ½åˆ†æ**ï¼š

```sql
-- åˆ›å»ºæ‰¹é‡æ“ä½œåˆ†æè¡¨
CREATE TABLE IF NOT EXISTS batch_operation_analysis (
    operation_id SERIAL PRIMARY KEY,
    operation_type VARCHAR(50),
    batch_size INTEGER,
    single_op_time_ms NUMERIC,
    batch_op_time_ms NUMERIC,
    throughput_improvement NUMERIC,
    cost_reduction NUMERIC,
    analyzed_date TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥æ‰¹é‡æ“ä½œåˆ†ææ•°æ®
INSERT INTO batch_operation_analysis
(operation_type, batch_size, single_op_time_ms, batch_op_time_ms)
VALUES
('INSERT', 1000, 1000, 50), -- å•æ¡æ’å…¥1000æ¡éœ€è¦1000msï¼Œæ‰¹é‡æ’å…¥éœ€è¦50ms
('UPDATE', 1000, 2000, 100),
('DELETE', 1000, 1500, 75);

-- è®¡ç®—æ€§èƒ½æ”¹è¿›
UPDATE batch_operation_analysis
SET
    throughput_improvement = (single_op_time_ms / NULLIF(batch_op_time_ms, 0)),
    cost_reduction = CASE
        WHEN single_op_time_ms > 0 THEN
            (single_op_time_ms - batch_op_time_ms) / single_op_time_ms * 100
        ELSE 0
    END;

-- æŸ¥è¯¢æ‰¹é‡æ“ä½œæ•ˆæœ
SELECT
    operation_type,
    batch_size,
    ROUND(single_op_time_ms, 2) AS single_op_ms,
    ROUND(batch_op_time_ms, 2) AS batch_op_ms,
    ROUND(throughput_improvement, 2) || 'x' AS speedup,
    ROUND(cost_reduction, 2) || '%' AS cost_reduction
FROM batch_operation_analysis
ORDER BY throughput_improvement DESC;
```

**æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ**ï¼š

```sql
-- æ‰¹é‡æ’å…¥ä¼˜åŒ–ç¤ºä¾‹
DO $$
DECLARE
    v_batch_size INTEGER := 1000;
    v_total_records INTEGER := 10000;
    v_batch_count INTEGER;
    v_start_time TIMESTAMPTZ;
    v_end_time TIMESTAMPTZ;
BEGIN
    v_batch_count := CEIL(v_total_records::NUMERIC / v_batch_size);
    v_start_time := clock_timestamp();

    -- æ‰¹é‡æ’å…¥
    FOR i IN 1..v_batch_count LOOP
        INSERT INTO users (name, email, created_at)
        SELECT
            'user_' || generate_series(1, LEAST(v_batch_size, v_total_records - (i-1) * v_batch_size)),
            'user_' || generate_series(1, LEAST(v_batch_size, v_total_records - (i-1) * v_batch_size)) || '@example.com',
            NOW();
    END LOOP;

    v_end_time := clock_timestamp();
    RAISE NOTICE 'æ‰¹é‡æ’å…¥å®Œæˆ: % æ¡è®°å½•, è€—æ—¶: %',
        v_total_records,
        EXTRACT(EPOCH FROM (v_end_time - v_start_time)) || ' ç§’';
END $$;

-- æ‰¹é‡æ›´æ–°ä¼˜åŒ–ç¤ºä¾‹
DO $$
DECLARE
    v_batch_size INTEGER := 5000;
    v_updated_count INTEGER := 0;
BEGIN
    -- ä½¿ç”¨CTEæ‰¹é‡æ›´æ–°
    WITH batch_update AS (
        SELECT id
        FROM users
        WHERE last_login < CURRENT_DATE - INTERVAL '1 year'
        LIMIT v_batch_size
        FOR UPDATE SKIP LOCKED
    )
    UPDATE users u
    SET status = 'inactive'
    FROM batch_update bu
    WHERE u.id = bu.id;

    GET DIAGNOSTICS v_updated_count = ROW_COUNT;
    RAISE NOTICE 'æ‰¹é‡æ›´æ–°å®Œæˆ: % æ¡è®°å½•', v_updated_count;
END $$;
```

---

## 5. è¿æ¥ä¼˜åŒ–

### 5.1 è¿æ¥æ± 

```text
ä½¿ç”¨PgBounceræˆ–pgpool-II
- å‡å°‘è¿æ¥æ•°
- æé«˜èµ„æºåˆ©ç”¨ç‡
- é™ä½å†…å­˜ä½¿ç”¨
```

### 5.2 è¿æ¥ç®¡ç†

**è¿æ¥ç®¡ç†ä¼˜åŒ–**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥æ•°
SELECT COUNT(*) FROM pg_stat_activity;

-- æŸ¥çœ‹è¿æ¥è¯¦æƒ…
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start
FROM pg_stat_activity
WHERE state = 'active';
```

**è¿æ¥èµ„æºä½¿ç”¨åˆ†æ**ï¼š

```sql
-- åˆ›å»ºè¿æ¥èµ„æºåˆ†æè§†å›¾
CREATE OR REPLACE VIEW connection_resource_analysis AS
SELECT
    state,
    COUNT(*) AS connection_count,
    COUNT(*) FILTER (WHERE state_change < NOW() - INTERVAL '1 hour') AS long_running,
    AVG(EXTRACT(EPOCH FROM (NOW() - state_change))) AS avg_duration_seconds,
    SUM(CASE WHEN state = 'active' THEN 1 ELSE 0 END) AS active_count,
    SUM(CASE WHEN state = 'idle' THEN 1 ELSE 0 END) AS idle_count,
    SUM(CASE WHEN state = 'idle in transaction' THEN 1 ELSE 0 END) AS idle_in_transaction_count
FROM pg_stat_activity
WHERE datname NOT IN ('template0', 'template1')
GROUP BY state;

-- æŸ¥è¯¢è¿æ¥èµ„æºä½¿ç”¨
SELECT
    state,
    connection_count,
    long_running,
    ROUND(avg_duration_seconds, 2) AS avg_duration_sec,
    active_count,
    idle_count,
    idle_in_transaction_count,
    ROUND((idle_count::NUMERIC / NULLIF(connection_count, 0)) * 100, 2) || '%' AS idle_percentage
FROM connection_resource_analysis
ORDER BY connection_count DESC;
```

**è¿æ¥ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- åˆ›å»ºè¿æ¥ä¼˜åŒ–å»ºè®®å‡½æ•°
CREATE OR REPLACE FUNCTION generate_connection_optimization_suggestions()
RETURNS TABLE (
    issue_type TEXT,
    issue_description TEXT,
    current_value INTEGER,
    recommendation TEXT,
    expected_improvement TEXT
) AS $$
DECLARE
    v_total_connections INTEGER;
    v_idle_connections INTEGER;
    v_long_running_connections INTEGER;
BEGIN
    SELECT
        COUNT(*),
        COUNT(*) FILTER (WHERE state = 'idle'),
        COUNT(*) FILTER (WHERE state_change < NOW() - INTERVAL '1 hour')
    INTO v_total_connections, v_idle_connections, v_long_running_connections
    FROM pg_stat_activity
    WHERE datname NOT IN ('template0', 'template1');

    -- ç”Ÿæˆä¼˜åŒ–å»ºè®®
    RETURN QUERY
    SELECT
        'ç©ºé—²è¿æ¥è¿‡å¤š'::TEXT,
        'å­˜åœ¨å¤§é‡ç©ºé—²è¿æ¥ï¼Œå ç”¨èµ„æº'::TEXT,
        v_idle_connections,
        'ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBounceræˆ–pgpool-IIï¼‰å‡å°‘è¿æ¥æ•°'::TEXT,
        'å¯å‡å°‘ ' || ROUND(v_idle_connections * 0.7) || ' ä¸ªè¿æ¥'::TEXT
    WHERE v_idle_connections > v_total_connections * 0.5

    UNION ALL

    SELECT
        'é•¿æ—¶é—´è¿è¡Œè¿æ¥',
        'å­˜åœ¨é•¿æ—¶é—´è¿è¡Œçš„è¿æ¥ï¼Œå¯èƒ½å½±å“æ€§èƒ½',
        v_long_running_connections,
        'è®¾ç½®statement_timeoutå’Œidle_in_transaction_session_timeout',
        'å¯é‡Šæ”¾ ' || v_long_running_connections || ' ä¸ªè¿æ¥'
    WHERE v_long_running_connections > 0;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢è¿æ¥ä¼˜åŒ–å»ºè®®
SELECT * FROM generate_connection_optimization_suggestions();
```

### 5.3 èµ„æºä½¿ç”¨ä¼˜åŒ–æœ€ä½³å®è·µ

**èµ„æºä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- åˆ›å»ºèµ„æºä¼˜åŒ–æ£€æŸ¥è¡¨
CREATE TABLE IF NOT EXISTS resource_optimization_checklist (
    check_id SERIAL PRIMARY KEY,
    resource_type VARCHAR(50),
    check_item VARCHAR(200),
    current_usage NUMERIC,
    optimal_usage NUMERIC,
    optimization_status VARCHAR(20),
    optimization_potential NUMERIC,
    checked_date TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥èµ„æºæ£€æŸ¥é¡¹
INSERT INTO resource_optimization_checklist
(resource_type, check_item, current_usage, optimal_usage)
SELECT
    'CPU',
    'æŸ¥è¯¢CPUä½¿ç”¨ç‡',
    (SELECT AVG(EXTRACT(EPOCH FROM (NOW() - query_start)))
     FROM pg_stat_activity
     WHERE state = 'active'),
    100.0 -- ç›®æ ‡ï¼šå¹³å‡æŸ¥è¯¢æ—¶é—´<100ms
UNION ALL
SELECT
    'å†…å­˜',
    'å…±äº«ç¼“å†²åŒºä½¿ç”¨ç‡',
    (SELECT SUM(buffers_alloc)::NUMERIC / NULLIF(setting::NUMERIC, 0) * 100
     FROM pg_stat_bgwriter, pg_settings
     WHERE pg_settings.name = 'shared_buffers'),
    80.0 -- ç›®æ ‡ï¼šä½¿ç”¨ç‡80%
UNION ALL
SELECT
    'I/O',
    'ç¼“å­˜å‘½ä¸­ç‡',
    (SELECT SUM(blks_hit)::NUMERIC / NULLIF(SUM(blks_hit + blks_read), 0) * 100
     FROM pg_stat_database),
    95.0; -- ç›®æ ‡ï¼šå‘½ä¸­ç‡>95%

-- æ›´æ–°ä¼˜åŒ–çŠ¶æ€
UPDATE resource_optimization_checklist
SET
    optimization_status = CASE
        WHEN current_usage <= optimal_usage THEN 'æ­£å¸¸'
        WHEN current_usage <= optimal_usage * 1.2 THEN 'éœ€å…³æ³¨'
        ELSE 'éœ€ä¼˜åŒ–'
    END,
    optimization_potential = CASE
        WHEN current_usage > optimal_usage THEN
            ROUND((current_usage - optimal_usage) / current_usage * 100, 2)
        ELSE 0
    END;

-- æŸ¥è¯¢èµ„æºä¼˜åŒ–çŠ¶æ€
SELECT
    resource_type,
    check_item,
    ROUND(current_usage, 2) AS current_usage,
    optimal_usage AS target_usage,
    optimization_status,
    optimization_potential || '%' AS optimization_potential
FROM resource_optimization_checklist
ORDER BY optimization_potential DESC;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—.md](./æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—.md) - æˆæœ¬ä¼˜åŒ–å®Œæ•´æŒ‡å—
- [è®¡ç®—æˆæœ¬ä¼˜åŒ–.md](./è®¡ç®—æˆæœ¬ä¼˜åŒ–.md) - è®¡ç®—æˆæœ¬ä¼˜åŒ–
- [å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md](./å­˜å‚¨æˆæœ¬ä¼˜åŒ–.md) - å­˜å‚¨æˆæœ¬ä¼˜åŒ–
- [21-æœ€ä½³å®è·µ/README.md](../README.md) - æœ€ä½³å®è·µä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
