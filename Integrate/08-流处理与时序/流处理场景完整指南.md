# PostgreSQLæµå¤„ç†åœºæ™¯å®Œæ•´æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: å®æ—¶æ•°æ®å¤„ç†ã€äº‹ä»¶æµå¤„ç†ã€CEP
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§
> **å‚è€ƒ**: [10.01-æµå¤„ç†ä¸æ—¶é—´è¯­ä¹‰-çª—å£ä¸CEPçš„å½¢å¼åŒ–.md](./10.01-æµå¤„ç†ä¸æ—¶é—´è¯­ä¹‰-çª—å£ä¸CEPçš„å½¢å¼åŒ–.md)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæµå¤„ç†åœºæ™¯å®Œæ•´æŒ‡å—](#postgresqlæµå¤„ç†åœºæ™¯å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æµå¤„ç†ï¼Ÿ](#11-ä»€ä¹ˆæ˜¯æµå¤„ç†)
    - [1.2 PostgreSQLæµå¤„ç†èƒ½åŠ›](#12-postgresqlæµå¤„ç†èƒ½åŠ›)
  - [2. æµå¤„ç†æ¶æ„](#2-æµå¤„ç†æ¶æ„)
    - [2.1 æ¶æ„æ¨¡å¼](#21-æ¶æ„æ¨¡å¼)
      - [2.1.1 äº‹ä»¶é©±åŠ¨æ¶æ„](#211-äº‹ä»¶é©±åŠ¨æ¶æ„)
      - [2.1.2 æµå¼å¤„ç†æ¶æ„](#212-æµå¼å¤„ç†æ¶æ„)
    - [2.2 æ ¸å¿ƒç»„ä»¶](#22-æ ¸å¿ƒç»„ä»¶)
      - [2.2.1 é€»è¾‘å¤åˆ¶](#221-é€»è¾‘å¤åˆ¶)
      - [2.2.2 è§¦å‘å™¨](#222-è§¦å‘å™¨)
  - [3. å®æ—¶æ•°æ®å¤„ç†](#3-å®æ—¶æ•°æ®å¤„ç†)
    - [3.1 å®æ—¶èšåˆ](#31-å®æ—¶èšåˆ)
      - [3.1.1 ç‰©åŒ–è§†å›¾å®æ—¶åˆ·æ–°](#311-ç‰©åŒ–è§†å›¾å®æ—¶åˆ·æ–°)
      - [3.1.2 æ»‘åŠ¨çª—å£èšåˆ](#312-æ»‘åŠ¨çª—å£èšåˆ)
    - [3.2 å®æ—¶æ•°æ®åŒæ­¥](#32-å®æ—¶æ•°æ®åŒæ­¥)
  - [4. å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰](#4-å¤æ‚äº‹ä»¶å¤„ç†cep)
    - [4.1 äº‹ä»¶æ¨¡å¼åŒ¹é…](#41-äº‹ä»¶æ¨¡å¼åŒ¹é…)
    - [4.2 äº‹ä»¶åºåˆ—æ£€æµ‹](#42-äº‹ä»¶åºåˆ—æ£€æµ‹)
  - [5. æµå¤„ç†æ€§èƒ½ä¼˜åŒ–](#5-æµå¤„ç†æ€§èƒ½ä¼˜åŒ–)
    - [5.1 ç´¢å¼•ä¼˜åŒ–](#51-ç´¢å¼•ä¼˜åŒ–)
    - [5.2 åˆ†åŒºä¼˜åŒ–](#52-åˆ†åŒºä¼˜åŒ–)
    - [5.3 æ‰¹é‡å¤„ç†](#53-æ‰¹é‡å¤„ç†)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¶æ„è®¾è®¡](#61-æ¶æ„è®¾è®¡)
    - [6.2 æ€§èƒ½ä¼˜åŒ–](#62-æ€§èƒ½ä¼˜åŒ–)
    - [6.3 ç›‘æ§å’Œå‘Šè­¦](#63-ç›‘æ§å’Œå‘Šè­¦)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æµå¤„ç†ï¼Ÿ

æµå¤„ç†æ˜¯å¯¹è¿ç»­æ•°æ®æµè¿›è¡Œå®æ—¶å¤„ç†çš„æŠ€æœ¯ï¼Œé€‚ç”¨äºï¼š

- âœ… **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€
- âœ… **äº‹ä»¶å¤„ç†**: å®æ—¶å¤„ç†äº‹ä»¶æµ
- âœ… **æ•°æ®åˆ†æ**: å®æ—¶æ•°æ®åˆ†æ
- âœ… **å‘Šè­¦ç³»ç»Ÿ**: å®æ—¶å‘Šè­¦å’Œé€šçŸ¥

### 1.2 PostgreSQLæµå¤„ç†èƒ½åŠ›

PostgreSQLé€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¯æŒæµå¤„ç†ï¼š

- **é€»è¾‘å¤åˆ¶**: å®æ—¶æ•°æ®æµ
- **è§¦å‘å™¨**: äº‹ä»¶é©±åŠ¨å¤„ç†
- **NOTIFY/LISTEN**: å‘å¸ƒè®¢é˜…æœºåˆ¶
- **ç‰©åŒ–è§†å›¾**: å®æ—¶èšåˆ
- **TimescaleDB**: æ—¶åºæ•°æ®å¤„ç†

---

## 2. æµå¤„ç†æ¶æ„

### 2.1 æ¶æ„æ¨¡å¼

#### 2.1.1 äº‹ä»¶é©±åŠ¨æ¶æ„

```text
æ•°æ®æº â†’ äº‹ä»¶é˜Ÿåˆ— â†’ PostgreSQL â†’ è§¦å‘å™¨ â†’ å¤„ç†é€»è¾‘ â†’ è¾“å‡º
```

#### 2.1.2 æµå¼å¤„ç†æ¶æ„

```text
æ•°æ®æº â†’ æµå¤„ç†å±‚ â†’ PostgreSQL â†’ ç‰©åŒ–è§†å›¾ â†’ å®æ—¶æŸ¥è¯¢
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 é€»è¾‘å¤åˆ¶

```sql
-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION stream_publication FOR TABLE events;

-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION stream_subscription
CONNECTION 'host=source_db port=5432 dbname=mydb'
PUBLICATION stream_publication;
```

#### 2.2.2 è§¦å‘å™¨

```sql
-- åˆ›å»ºæµå¤„ç†è§¦å‘å™¨
CREATE OR REPLACE FUNCTION process_stream_event()
RETURNS TRIGGER AS $$
BEGIN
    -- å¤„ç†äº‹ä»¶
    INSERT INTO processed_events (event_id, processed_at, data)
    VALUES (NEW.id, NOW(), NEW.data);

    -- å‘é€é€šçŸ¥
    PERFORM pg_notify('stream_event', NEW.id::TEXT);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER stream_trigger
AFTER INSERT ON events
FOR EACH ROW EXECUTE FUNCTION process_stream_event();
```

---

## 3. å®æ—¶æ•°æ®å¤„ç†

### 3.1 å®æ—¶èšåˆ

#### 3.1.1 ç‰©åŒ–è§†å›¾å®æ—¶åˆ·æ–°

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_realtime_stats AS
SELECT
    date_trunc('minute', created_at) as time_window,
    count(*) as event_count,
    sum(amount) as total_amount
FROM events
GROUP BY date_trunc('minute', created_at);

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX ON mv_realtime_stats(time_window);

-- å®æ—¶åˆ·æ–°ï¼ˆä½¿ç”¨è§¦å‘å™¨ï¼‰
CREATE OR REPLACE FUNCTION refresh_realtime_stats()
RETURNS TRIGGER AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_realtime_stats;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER refresh_stats_trigger
AFTER INSERT ON events
FOR EACH STATEMENT EXECUTE FUNCTION refresh_realtime_stats();
```

#### 3.1.2 æ»‘åŠ¨çª—å£èšåˆ

```sql
-- æ»‘åŠ¨çª—å£æŸ¥è¯¢
SELECT
    time_bucket('1 minute', created_at) as time_window,
    count(*) as event_count,
    avg(amount) as avg_amount
FROM events
WHERE created_at >= NOW() - INTERVAL '1 hour'
GROUP BY time_bucket('1 minute', created_at)
ORDER BY time_window DESC;
```

### 3.2 å®æ—¶æ•°æ®åŒæ­¥

```sql
-- ä½¿ç”¨é€»è¾‘å¤åˆ¶åŒæ­¥
CREATE PUBLICATION sync_publication FOR TABLE source_table;

-- åœ¨ç›®æ ‡æ•°æ®åº“åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION sync_subscription
CONNECTION 'host=source_db port=5432 dbname=mydb'
PUBLICATION sync_publication;
```

---

## 4. å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰

### 4.1 äº‹ä»¶æ¨¡å¼åŒ¹é…

```sql
-- åˆ›å»ºäº‹ä»¶æ¨¡å¼è¡¨
CREATE TABLE event_patterns (
    id SERIAL PRIMARY KEY,
    pattern_name TEXT,
    pattern_definition JSONB,
    action TEXT
);

-- äº‹ä»¶æ¨¡å¼åŒ¹é…å‡½æ•°
CREATE OR REPLACE FUNCTION match_event_pattern(
    p_event JSONB,
    p_pattern JSONB
)
RETURNS BOOLEAN AS $$
BEGIN
    -- æ¨¡å¼åŒ¹é…é€»è¾‘
    RETURN (
        p_event->>'type' = p_pattern->>'type' AND
        (p_event->>'value')::NUMERIC > (p_pattern->>'threshold')::NUMERIC
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨æ¨¡å¼åŒ¹é…
SELECT *
FROM events
WHERE match_event_pattern(to_jsonb(events.*), '{"type": "alert", "threshold": 100}'::JSONB);
```

### 4.2 äº‹ä»¶åºåˆ—æ£€æµ‹

```sql
-- æ£€æµ‹äº‹ä»¶åºåˆ—
WITH event_sequence AS (
    SELECT
        id,
        event_type,
        created_at,
        LAG(event_type) OVER (ORDER BY created_at) as prev_event,
        LEAD(event_type) OVER (ORDER BY created_at) as next_event
    FROM events
    WHERE created_at >= NOW() - INTERVAL '1 hour'
)
SELECT *
FROM event_sequence
WHERE
    prev_event = 'login' AND
    event_type = 'purchase' AND
    next_event = 'logout';
```

---

## 5. æµå¤„ç†æ€§èƒ½ä¼˜åŒ–

### 5.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- æ—¶é—´ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public'
        AND tablename = 'events'
        AND indexname = 'idx_events_created_at'
    ) THEN
        CREATE INDEX idx_events_created_at ON events(created_at);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_events_created_at';
    ELSE
        RAISE WARNING 'ç´¢å¼•idx_events_created_atå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆæœ€è¿‘æ•°æ®ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public'
        AND tablename = 'events'
        AND indexname = 'idx_events_recent'
    ) THEN
        CREATE INDEX idx_events_recent ON events(created_at)
        WHERE created_at >= NOW() - INTERVAL '24 hours';
        RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_events_recent';
    ELSE
        RAISE WARNING 'ç´¢å¼•idx_events_recentå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºéƒ¨åˆ†ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 5.2 åˆ†åŒºä¼˜åŒ–

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
        DROP TABLE events CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: events';
    END IF;

    CREATE TABLE events (
        id SERIAL,
        event_data JSONB,
        created_at TIMESTAMPTZ
    ) PARTITION BY RANGE (created_at);

    RAISE NOTICE 'åˆ†åŒºè¡¨åˆ›å»ºæˆåŠŸ: events';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨eventså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºåˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
        RAISE EXCEPTION 'åˆ†åŒºè¡¨eventsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name = 'events_2025_01'
    ) THEN
        CREATE TABLE events_2025_01 PARTITION OF events
        FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
        RAISE NOTICE 'åˆ†åŒºåˆ›å»ºæˆåŠŸ: events_2025_01';
    ELSE
        RAISE WARNING 'åˆ†åŒºevents_2025_01å·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'åˆ†åŒºè¡¨eventsä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'åˆ†åŒºå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;
```

### 5.3 æ‰¹é‡å¤„ç†

```sql
-- æ‰¹é‡å¤„ç†äº‹ä»¶ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION batch_process_events()
RETURNS void AS $$
DECLARE
    v_batch_size INT := 1000;
    v_update_count INT;
    v_start_time TIMESTAMPTZ;
    v_end_time TIMESTAMPTZ;
    v_duration INTERVAL;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
        AND table_name = 'events'
        AND column_name = 'processed'
    ) THEN
        RAISE EXCEPTION 'è¡¨eventsç¼ºå°‘processedåˆ—';
    END IF;

    v_start_time := clock_timestamp();

    -- æ‰¹é‡å¤„ç†
    WITH batch AS (
        SELECT *
        FROM events
        WHERE processed = false
        LIMIT v_batch_size
        FOR UPDATE SKIP LOCKED
    )
    UPDATE events
    SET processed = true,
        processed_at = NOW()
    FROM batch
    WHERE events.id = batch.id;

    GET DIAGNOSTICS v_update_count = ROW_COUNT;
    v_end_time := clock_timestamp();
    v_duration := v_end_time - v_start_time;

    RAISE NOTICE 'æ‰¹é‡å¤„ç†å®Œæˆ: % è¡Œï¼Œè€—æ—¶: %', v_update_count, v_duration;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨eventsä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'è¡¨eventsç¼ºå°‘processedåˆ—';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰¹é‡å¤„ç†äº‹ä»¶å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¶æ„è®¾è®¡

- âœ… **äº‹ä»¶é©±åŠ¨**: ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„
- âœ… **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨å¼‚æ­¥å¤„ç†æé«˜æ€§èƒ½
- âœ… **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¤„ç†å‡å°‘å¼€é”€
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

### 6.2 æ€§èƒ½ä¼˜åŒ–

- âœ… **ç´¢å¼•ä¼˜åŒ–**: åˆ›å»ºåˆé€‚çš„æ—¶é—´ç´¢å¼•
- âœ… **åˆ†åŒºä¼˜åŒ–**: ä½¿ç”¨åˆ†åŒºè¡¨ç®¡ç†æ•°æ®
- âœ… **ç‰©åŒ–è§†å›¾**: ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„èšåˆ
- âœ… **è¿æ¥æ± **: ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥

### 6.3 ç›‘æ§å’Œå‘Šè­¦

- âœ… **å®æ—¶ç›‘æ§**: ç›‘æ§æµå¤„ç†æ€§èƒ½
- âœ… **å»¶è¿Ÿç›‘æ§**: ç›‘æ§å¤„ç†å»¶è¿Ÿ
- âœ… **é”™è¯¯ç›‘æ§**: ç›‘æ§å¤„ç†é”™è¯¯
- âœ… **å‘Šè­¦æœºåˆ¶**: è®¾ç½®å‘Šè­¦é˜ˆå€¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [10.01-æµå¤„ç†ä¸æ—¶é—´è¯­ä¹‰-çª—å£ä¸CEPçš„å½¢å¼åŒ–.md](./10.01-æµå¤„ç†ä¸æ—¶é—´è¯­ä¹‰-çª—å£ä¸CEPçš„å½¢å¼åŒ–.md) - æµå¤„ç†å½¢å¼åŒ–
- [10.04-æ•°æ®åº“æµå¤„ç†æ¨¡å‹-æµæŸ¥è¯¢è¯­è¨€ä¸çª—å£æ“ä½œçš„å½¢å¼åŒ–.md](./10.04-æ•°æ®åº“æµå¤„ç†æ¨¡å‹-æµæŸ¥è¯¢è¯­è¨€ä¸çª—å£æ“ä½œçš„å½¢å¼åŒ–.md) - æµå¤„ç†æ¨¡å‹
- [10.05-æ•°æ®åº“äº‹ä»¶å¤„ç†æ¨¡å‹-å¤æ‚äº‹ä»¶å¤„ç†ä¸æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–.md](./10.05-æ•°æ®åº“äº‹ä»¶å¤„ç†æ¨¡å‹-å¤æ‚äº‹ä»¶å¤„ç†ä¸æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–.md) - äº‹ä»¶å¤„ç†æ¨¡å‹
- [TimescaleDBæ–‡æ¡£](../07-å¤šæ¨¡å‹æ•°æ®åº“/README.md) - æ—¶åºæ•°æ®åº“

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
