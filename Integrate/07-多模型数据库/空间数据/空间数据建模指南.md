# 空间数据建模指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 18+, PostGIS 3.4+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [空间数据建模指南](#空间数据建模指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 空间数据类型选择](#2-空间数据类型选择)
    - [2.1 GEOMETRY vs GEOGRAPHY](#21-geometry-vs-geography)
    - [2.2 选择建议](#22-选择建议)
  - [3. 空间数据建模原则](#3-空间数据建模原则)
    - [3.1 选择合适的SRID](#31-选择合适的srid)
    - [3.2 使用约束](#32-使用约束)
    - [3.3 规范化设计](#33-规范化设计)
  - [4. 常见建模模式](#4-常见建模模式)
    - [4.1 点数据模型](#41-点数据模型)
    - [4.2 线数据模型](#42-线数据模型)
    - [4.3 面数据模型](#43-面数据模型)
    - [4.4 混合数据模型](#44-混合数据模型)
  - [5. 最佳实践](#5-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

空间数据建模是PostGIS应用的基础。合理的空间数据模型设计可以：

- 提升查询性能
- 简化数据管理
- 优化存储空间
- 提高数据质量

---

## 2. 空间数据类型选择

### 2.1 GEOMETRY vs GEOGRAPHY

| 特性 | GEOMETRY | GEOGRAPHY |
|------|----------|-----------|
| **坐标系** | 平面坐标系 | 球面坐标系（WGS84） |
| **计算方式** | 平面几何计算 | 球面距离计算 |
| **性能** | 快 | 较慢 |
| **适用场景** | 局部区域、投影坐标系 | 全球数据、GPS坐标 |
| **距离计算** | 单位取决于SRID | 单位：米 |

### 2.2 选择建议

- **GEOMETRY** - 推荐用于大多数场景
  - 局部区域数据（城市、国家）
  - 使用投影坐标系（如Web Mercator）
  - 性能更好

- **GEOGRAPHY** - 用于全球数据
  - GPS坐标数据
  - 全球范围查询
  - 需要精确的球面距离计算

---

## 3. 空间数据建模原则

### 3.1 选择合适的SRID

```sql
-- 常用SRID
-- 4326: WGS84（GPS坐标）
-- 3857: Web Mercator（Web地图）
-- 2154: RGF93 / Lambert-93（法国）
-- 4490: CGCS2000 / 3-degree Gauss-Kruger zone 25（中国）

-- 创建表时指定SRID
CREATE TABLE places (
    id SERIAL PRIMARY KEY,
    name TEXT,
    location GEOMETRY(POINT, 4326)  -- 使用WGS84
);
```

### 3.2 使用约束

```sql
-- 添加空间约束
ALTER TABLE places
ADD CONSTRAINT places_location_check
CHECK (ST_IsValid(location));

-- 或者使用触发器验证
CREATE OR REPLACE FUNCTION validate_geometry()
RETURNS TRIGGER AS $$
BEGIN
    IF NOT ST_IsValid(NEW.location) THEN
        RAISE EXCEPTION 'Invalid geometry: %', ST_AsText(NEW.location);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 规范化设计

```sql
-- 避免存储冗余的空间数据
-- ❌ 不推荐：存储多个相关字段
CREATE TABLE routes (
    id SERIAL,
    start_point GEOMETRY(POINT),
    end_point GEOMETRY(POINT),
    route_line GEOMETRY(LINESTRING),
    route_length DOUBLE PRECISION  -- 可以从route_line计算
);

-- ✅ 推荐：只存储必要的空间数据
CREATE TABLE routes (
    id SERIAL,
    route_line GEOMETRY(LINESTRING),
    -- 其他属性
);
-- 需要时计算
SELECT
    ST_StartPoint(route_line) AS start_point,
    ST_EndPoint(route_line) AS end_point,
    ST_Length(route_line) AS route_length
FROM routes;
```

---

## 4. 常见建模模式

### 4.1 点数据模型

```sql
-- 适用于：位置点、兴趣点、事件位置
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    name TEXT,
    category TEXT,
    location GEOMETRY(POINT, 4326),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX locations_geom_idx ON locations USING GIST (location);
```

### 4.2 线数据模型

```sql
-- 适用于：道路、路径、边界
CREATE TABLE roads (
    id SERIAL PRIMARY KEY,
    name TEXT,
    road_type TEXT,
    geometry GEOMETRY(LINESTRING, 4326),
    length_meters DOUBLE PRECISION GENERATED ALWAYS AS
        ST_Length(geometry::geography) STORED
);

CREATE INDEX roads_geom_idx ON roads USING GIST (geometry);
```

### 4.3 面数据模型

```sql
-- 适用于：区域、地块、行政边界
CREATE TABLE regions (
    id SERIAL PRIMARY KEY,
    name TEXT,
    region_type TEXT,
    boundary GEOMETRY(POLYGON, 4326),
    area_sqkm DOUBLE PRECISION GENERATED ALWAYS AS
        ST_Area(boundary::geography) / 1000000 STORED
);

CREATE INDEX regions_boundary_idx ON regions USING GIST (boundary);
```

### 4.4 混合数据模型

```sql
-- 适用于：包含多种几何类型的场景
CREATE TABLE features (
    id SERIAL PRIMARY KEY,
    name TEXT,
    feature_type TEXT CHECK (feature_type IN ('point', 'line', 'polygon')),
    geometry GEOMETRY(GEOMETRY, 4326),  -- 通用几何类型
    CHECK (
        (feature_type = 'point' AND ST_GeometryType(geometry) = 'ST_Point') OR
        (feature_type = 'line' AND ST_GeometryType(geometry) = 'ST_LineString') OR
        (feature_type = 'polygon' AND ST_GeometryType(geometry) = 'ST_Polygon')
    )
);

CREATE INDEX features_geom_idx ON features USING GIST (geometry);
```

---

## 5. 最佳实践

### ✅ 推荐做法

1. **选择合适的SRID** - 根据数据范围选择
2. **使用空间索引** - GIST索引对空间查询至关重要
3. **添加约束验证** - 确保数据质量
4. **规范化设计** - 避免冗余，使用计算字段
5. **考虑分区** - 对于大表考虑按空间或时间分区

### ❌ 避免做法

1. **混合使用GEOMETRY和GEOGRAPHY** - 保持一致性
2. **忽略SRID** - 必须指定正确的SRID
3. **不使用空间索引** - 空间查询性能会极差
4. **存储冗余数据** - 可以从几何数据计算

---

## 📚 相关文档

- [PostGIS完整深化指南.md](./PostGIS完整深化指南.md) - PostGIS完整指南
- [PostgreSQL18-PostGIS地理空间数据库实战.md](./PostgreSQL18-PostGIS地理空间数据库实战.md) - PostGIS实战指南
- [07-多模型数据库/README.md](../README.md) - 多模型数据库主题

---

**最后更新**: 2025年1月
