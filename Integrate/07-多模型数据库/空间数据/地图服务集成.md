# åœ°å›¾æœåŠ¡é›†æˆ

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+, PostGIS 3.4+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [åœ°å›¾æœåŠ¡é›†æˆ](#åœ°å›¾æœåŠ¡é›†æˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. Webåœ°å›¾æœåŠ¡ï¼ˆWMSï¼‰](#2-webåœ°å›¾æœåŠ¡wms)
    - [2.1 ä½¿ç”¨MapServer](#21-ä½¿ç”¨mapserver)
    - [2.2 ä½¿ç”¨GeoServer](#22-ä½¿ç”¨geoserver)
  - [3. Webè¦ç´ æœåŠ¡ï¼ˆWFSï¼‰](#3-webè¦ç´ æœåŠ¡wfs)
    - [3.1 WFSæŸ¥è¯¢](#31-wfsæŸ¥è¯¢)
    - [3.2 WFS-Tï¼ˆäº‹åŠ¡ï¼‰](#32-wfs-täº‹åŠ¡)
  - [4. TileæœåŠ¡](#4-tileæœåŠ¡)
    - [4.1 ä½¿ç”¨PostGISç”Ÿæˆç“¦ç‰‡](#41-ä½¿ç”¨postgisç”Ÿæˆç“¦ç‰‡)
    - [4.2 ä½¿ç”¨pg\_tileserv](#42-ä½¿ç”¨pg_tileserv)
  - [5. GeoJSON API](#5-geojson-api)
    - [5.1 åˆ›å»ºGeoJSONè§†å›¾](#51-åˆ›å»ºgeojsonè§†å›¾)
    - [5.2 RESTful APIç¤ºä¾‹](#52-restful-apiç¤ºä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

PostGISå¯ä»¥ä¸å„ç§åœ°å›¾æœåŠ¡é›†æˆï¼Œæä¾›åœ°ç†æ•°æ®çš„WebæœåŠ¡æ¥å£ã€‚å¸¸è§çš„åœ°å›¾æœåŠ¡åŒ…æ‹¬ï¼š

- **WMS** - Webåœ°å›¾æœåŠ¡ï¼ˆå›¾ç‰‡ï¼‰
- **WFS** - Webè¦ç´ æœåŠ¡ï¼ˆçŸ¢é‡æ•°æ®ï¼‰
- **TileæœåŠ¡** - ç“¦ç‰‡åœ°å›¾æœåŠ¡
- **GeoJSON API** - RESTfulåœ°ç†æ•°æ®API

---

## 2. Webåœ°å›¾æœåŠ¡ï¼ˆWMSï¼‰

### 2.1 ä½¿ç”¨MapServer

```sql
-- å‡†å¤‡æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cities') THEN
        DROP TABLE cities;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: cities';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_extension
        WHERE extname = 'postgis'
    ) THEN
        RAISE EXCEPTION 'PostGISæ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…';
    END IF;

    CREATE TABLE cities (
        id SERIAL PRIMARY KEY,
        name TEXT,
        population INT,
        geom GEOMETRY(POINT, 4326)
    );

    RAISE NOTICE 'è¡¨åˆ›å»ºæˆåŠŸ: cities';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'GEOMETRYç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å®‰è£…PostGISæ‰©å±•';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨citieså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- MapServeré…ç½®ç¤ºä¾‹ï¼ˆmapfileï¼‰
MAP
    NAME "cities"
    STATUS ON
    SIZE 800 600
    EXTENT -180 -90 180 90
    UNITS DD
    SHAPEPATH "/data"

    LAYER
        NAME "cities"
        TYPE POINT
        STATUS ON
        CONNECTIONTYPE postgis
        CONNECTION "host=localhost dbname=mydb user=postgres password=xxx"
        DATA "geom FROM cities USING UNIQUE id USING srid=4326"
        CLASS
            STYLE
                COLOR 255 0 0
                SIZE 8
            END
        END
    END
END

```

### 2.2 ä½¿ç”¨GeoServer

```sql
-- GeoServeré€šè¿‡JDBCè¿æ¥PostGIS
-- é…ç½®æ•°æ®å­˜å‚¨ï¼š
-- ç±»å‹: PostGIS
-- ä¸»æœº: localhost
-- ç«¯å£: 5432
-- æ•°æ®åº“: mydb
-- ç”¨æˆ·: postgres
-- å¯†ç : xxx
-- æ¶æ„: public
```

---

## 3. Webè¦ç´ æœåŠ¡ï¼ˆWFSï¼‰

### 3.1 WFSæŸ¥è¯¢

```sql
-- WFS GetFeatureè¯·æ±‚ç¤ºä¾‹
-- URL: http://localhost:8080/geoserver/wfs?
--      service=WFS&version=1.1.0&request=GetFeature&
--      typeName=cities&outputFormat=application/json

-- å¯¹åº”çš„SQLæŸ¥è¯¢
SELECT
    id,
    name,
    population,
    ST_AsGeoJSON(geom) AS geometry
FROM cities
WHERE ST_Within(geom, ST_MakeEnvelope(116.0, 39.7, 116.7, 40.2, 4326));
```

### 3.2 WFS-Tï¼ˆäº‹åŠ¡ï¼‰

```sql
-- WFS-Tæ’å…¥
INSERT INTO cities (name, population, geom)
VALUES (
    'Beijing',
    21540000,
    ST_SetSRID(ST_MakePoint(116.4074, 39.9042), 4326)
);

-- WFS-Tæ›´æ–°
UPDATE cities
SET population = 22000000
WHERE name = 'Beijing';

-- WFS-Tåˆ é™¤
DELETE FROM cities WHERE name = 'Beijing';
```

---

## 4. TileæœåŠ¡

### 4.1 ä½¿ç”¨PostGISç”Ÿæˆç“¦ç‰‡

```sql
-- åˆ›å»ºç“¦ç‰‡è¡¨
CREATE TABLE tiles (
    z INT,
    x INT,
    y INT,
    tile_data BYTEA,
    PRIMARY KEY (z, x, y)
);

-- ç”Ÿæˆç“¦ç‰‡å‡½æ•°
CREATE OR REPLACE FUNCTION generate_tile(
    z INT,
    x INT,
    y INT
)
RETURNS BYTEA AS $$
DECLARE
    bbox GEOMETRY;
    tile_data BYTEA;
BEGIN
    -- è®¡ç®—ç“¦ç‰‡è¾¹ç•Œæ¡†
    bbox := ST_TileEnvelope(z, x, y);

    -- æŸ¥è¯¢è¯¥åŒºåŸŸçš„æ•°æ®å¹¶ç”Ÿæˆç“¦ç‰‡
    -- è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦ä½¿ç”¨åœ°å›¾æ¸²æŸ“åº“
    SELECT ST_AsMVT(q, 'cities', 4096, 'geom')
    INTO tile_data
    FROM (
        SELECT
            id,
            name,
            ST_AsMVTGeom(geom, bbox, 4096, 256, true) AS geom
        FROM cities
        WHERE geom && bbox
    ) q;

    RETURN tile_data;
END;
$$ LANGUAGE plpgsql;
```

### 4.2 ä½¿ç”¨pg_tileserv

```bash
# pg_tileservæ˜¯PostGISçš„ç“¦ç‰‡æœåŠ¡
# å®‰è£…å’Œä½¿ç”¨ï¼š
# https://github.com/CrunchyData/pg_tileserv

# é…ç½®è¿æ¥
export DATABASE_URL="postgresql://postgres:password@localhost/mydb"

# å¯åŠ¨æœåŠ¡
pg_tileserv serve

# è®¿é—®ç“¦ç‰‡
# http://localhost:7800/index.html
```

---

## 5. GeoJSON API

### 5.1 åˆ›å»ºGeoJSONè§†å›¾

```sql
-- åˆ›å»ºGeoJSONè§†å›¾
CREATE OR REPLACE VIEW cities_geojson AS
SELECT
    json_build_object(
        'type', 'FeatureCollection',
        'features', json_agg(
            json_build_object(
                'type', 'Feature',
                'id', id,
                'geometry', ST_AsGeoJSON(geom)::json,
                'properties', json_build_object(
                    'name', name,
                    'population', population
                )
            )
        )
    ) AS geojson
FROM cities;
```

### 5.2 RESTful APIç¤ºä¾‹

```sql
-- ä½¿ç”¨PostgRESTæˆ–è‡ªå®šä¹‰API
-- æŸ¥è¯¢æ‰€æœ‰åŸå¸‚
SELECT
    id,
    name,
    population,
    ST_AsGeoJSON(geom)::json AS geometry
FROM cities;

-- æŒ‰åŒºåŸŸæŸ¥è¯¢
SELECT
    id,
    name,
    population,
    ST_AsGeoJSON(geom)::json AS geometry
FROM cities
WHERE ST_Within(
    geom,
    ST_MakeEnvelope(116.0, 39.7, 116.7, 40.2, 4326)
);
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨æ ‡å‡†æœåŠ¡åè®®** - WMSã€WFSã€TileæœåŠ¡
2. **ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½** - ä½¿ç”¨ç©ºé—´ç´¢å¼•å’Œè¾¹ç•Œæ¡†è¿‡æ»¤
3. **ç¼“å­˜ç“¦ç‰‡** - å¯¹äºé™æ€æ•°æ®ä½¿ç”¨ç¼“å­˜
4. **ä½¿ç”¨è¿æ¥æ± ** - æé«˜å¹¶å‘æ€§èƒ½
5. **ç›‘æ§æœåŠ¡æ€§èƒ½** - è·Ÿè¸ªå“åº”æ—¶é—´å’Œé”™è¯¯ç‡

### âŒ é¿å…åšæ³•

1. **ç›´æ¥æš´éœ²æ•°æ®åº“** - ä½¿ç”¨æœåŠ¡å±‚å°è£…
2. **è¿”å›è¿‡å¤šæ•°æ®** - ä½¿ç”¨åˆ†é¡µå’Œé™åˆ¶
3. **å¿½ç•¥æ€§èƒ½ä¼˜åŒ–** - ç©ºé—´æŸ¥è¯¢éœ€è¦ä¼˜åŒ–
4. **ä¸å¤„ç†é”™è¯¯** - æä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostGISå®Œæ•´æ·±åŒ–æŒ‡å—.md](./PostGISå®Œæ•´æ·±åŒ–æŒ‡å—.md) - PostGISå®Œæ•´æŒ‡å—
- [åœ°ç†ä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–.md](./åœ°ç†ä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–æŒ‡å—
- [ç©ºé—´æ•°æ®å»ºæ¨¡æŒ‡å—.md](./ç©ºé—´æ•°æ®å»ºæ¨¡æŒ‡å—.md) - æ•°æ®å»ºæ¨¡æŒ‡å—

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
