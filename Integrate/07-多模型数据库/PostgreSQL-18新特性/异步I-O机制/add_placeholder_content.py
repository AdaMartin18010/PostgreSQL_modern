#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¸ºç©ºæ–‡æ¡£æ·»åŠ å ä½H3æ ‡é¢˜ï¼Œä½¿å…¶ç»“æ„ä¸ç›®å½•åŒ¹é…
"""

import os
import re
from pathlib import Path

base_path = Path(__file__).parent

# éœ€è¦æ·»åŠ å†…å®¹çš„æ–‡æ¡£åŠå…¶H3æ ‡é¢˜
documents_to_fix = {
    "04-æ¶æ„è®¾è®¡": [
        ("4.1", "æ•´ä½“æ¶æ„"),
        ("4.2", "å¼‚æ­¥ I/O ç®¡ç†å±‚"),
        ("4.3", "I/O çº¿ç¨‹æ± "),
        ("4.4", "å­˜å‚¨å±‚é›†æˆ"),
    ],
    "08-å®é™…åº”ç”¨åœºæ™¯": [
        ("8.1", "RAG åº”ç”¨æ–‡æ¡£å¯¼å…¥"),
        ("8.2", "IoT æ—¶åºæ•°æ®å†™å…¥"),
        ("8.3", "æ—¥å¿—ç³»ç»Ÿæ‰¹é‡å†™å…¥"),
        ("8.4", "äº‘åŸç”Ÿå¾®æœåŠ¡åœºæ™¯"),
        ("8.5", "æ··åˆå·¥ä½œè´Ÿè½½åœºæ™¯"),
    ],
    "09-æœ€ä½³å®è·µ": [
        ("9.1", "æ‰¹é‡æ“ä½œ"),
        ("9.2", "å¹¶å‘å†™å…¥"),
        ("9.3", "æ€§èƒ½ç›‘æ§"),
    ],
    "11-è¿ç§»æŒ‡å—": [
        ("11.1", "ä»PostgreSQL 17è¿ç§»åˆ°18"),
        ("11.2", "å¯ç”¨å¼‚æ­¥I/Oé…ç½®"),
        ("11.3", "æ€§èƒ½å¯¹æ¯”æµ‹è¯•"),
        ("11.4", "å›æ»šæ–¹æ¡ˆ"),
    ],
    "12-æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•": [
        ("12.1", "é…ç½®æ£€æŸ¥æ¸…å•"),
        ("12.2", "æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•è¡¨"),
        ("12.3", "æ€§èƒ½è°ƒä¼˜æ­¥éª¤"),
    ],
    "13-ä¸å…¶ä»–ç‰¹æ€§é›†æˆ": [
        ("13.1", "ä¸å†…ç½®è¿æ¥æ± çš„é›†æˆ"),
        ("13.2", "ä¸å¹¶è¡ŒæŸ¥è¯¢çš„é›†æˆ"),
        ("13.3", "ä¸é€»è¾‘å¤åˆ¶çš„é›†æˆ"),
        ("13.4", "ä¸åˆ†åŒºè¡¨çš„é›†æˆ"),
    ],
    "14-å¸¸è§é—®é¢˜FAQ": [
        ("14.1", "é…ç½®é—®é¢˜"),
        ("14.2", "æ€§èƒ½é—®é¢˜"),
        ("14.3", "å…¼å®¹æ€§é—®é¢˜"),
    ],
    "15-å®‰å…¨ä¸é«˜å¯ç”¨": [
        ("15.1", "å®‰å…¨é…ç½®"),
        ("15.2", "å¤‡ä»½æ¢å¤"),
        ("15.3", "é«˜å¯ç”¨ç¯å¢ƒ"),
    ],
    "16-æ€§èƒ½æµ‹è¯•å·¥å…·": [
        ("16.1", "pgbench"),
        ("16.2", "è‡ªå®šä¹‰å·¥å…·"),
    ],
    "18-CICDé›†æˆ": [
        ("18.1", "GitHub Actions"),
        ("18.2", "GitLab CI"),
        ("18.3", "è‡ªåŠ¨åŒ–æµ‹è¯•"),
        ("18.4", "éƒ¨ç½²æµç¨‹"),
    ],
    "19-é«˜çº§æ€§èƒ½ä¼˜åŒ–": [
        ("19.1", "å‚æ•°è°ƒä¼˜"),
        ("19.2", "å·¥ä½œè´Ÿè½½ä¼˜åŒ–"),
        ("19.3", "æ·±åº¦æŠ€å·§"),
        ("19.4", "é«˜çº§é…ç½®"),
        ("19.5", "æ€§èƒ½åˆ†æ"),
        ("19.6", "ä¼˜åŒ–ç­–ç•¥"),
        ("19.7", "æœ€ä½³å®è·µ"),
        ("19.8", "æ•…éšœæ’æŸ¥"),
    ],
}

print("=" * 70)
print("ğŸ”§ ä¸ºç©ºæ–‡æ¡£æ·»åŠ å ä½H3æ ‡é¢˜")
print("=" * 70)

fixed_count = 0

for folder_name, headings in documents_to_fix.items():
    folder = base_path / folder_name
    readme_path = folder / "README.md"
    
    if not readme_path.exists():
        print(f"  âš ï¸  {folder_name}: æ–‡ä»¶ä¸å­˜åœ¨")
        continue
    
    try:
        with open(readme_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰H3æ ‡é¢˜
        h3_count = len(re.findall(r'^###\s+\d+\.\d+', content, re.MULTILINE))
        if h3_count > 0:
            print(f"  â­ï¸  {folder_name}: å·²æœ‰ {h3_count} ä¸ªH3æ ‡é¢˜ï¼Œè·³è¿‡")
            continue
        
        # æ‰¾åˆ°å¯¼èˆªé“¾æ¥çš„ä½ç½®
        nav_match = re.search(r'\*\*è¿”å›\*\*:.*?\n', content)
        if nav_match:
            nav_pos = nav_match.start()
            
            # åœ¨å¯¼èˆªé“¾æ¥å‰æ’å…¥H3æ ‡é¢˜
            h3_content = "\n\n"
            for num, title in headings:
                h3_content += f"### {num} {title}\n\n"
                h3_content += f"*æœ¬èŠ‚å†…å®¹å¾…è¡¥å……*\n\n"
            
            new_content = content[:nav_pos] + h3_content + content[nav_pos:]
            
            with open(readme_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            fixed_count += 1
            print(f"  âœ… {folder_name}: å·²æ·»åŠ  {len(headings)} ä¸ªH3æ ‡é¢˜")
        else:
            print(f"  âš ï¸  {folder_name}: æœªæ‰¾åˆ°å¯¼èˆªé“¾æ¥ä½ç½®")
    
    except Exception as e:
        print(f"  âŒ {folder_name}: å¤„ç†å¤±è´¥ - {e}")

print(f"\n  âœ… å…±ä¿®å¤ {fixed_count} ä¸ªæ–‡æ¡£")
print("\n" + "=" * 70)
print("ä¿®å¤å®Œæˆ")
print("=" * 70)
