---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: æ–°å¢æ·±åŒ–æ–‡æ¡£
> **ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£èšç„¦ç›‘æ§ä¸è¯Šæ–­æ·±åº¦åº”ç”¨ä¸åœºæ™¯åˆ†æ

---

# PostgreSQLç›‘æ§ä¸è¯Šæ–­æ·±åº¦åº”ç”¨æŒ‡å—

## å…ƒæ•°æ®

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01
- **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç›‘æ§ | è¯Šæ–­ | æ€§èƒ½åˆ†æ | å‘Šè­¦
- **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)
- **é¢„è®¡é˜…è¯»**: 180åˆ†é’Ÿ
- **å‰ç½®è¦æ±‚**: ç†Ÿæ‚‰PostgreSQLåŸºç¡€ã€ç›‘æ§åŸºç¡€ã€æ€§èƒ½è°ƒä¼˜åŸºç¡€

---

## ğŸ“‹ å®Œæ•´ç›®å½•

- [PostgreSQLç›‘æ§ä¸è¯Šæ–­æ·±åº¦åº”ç”¨æŒ‡å—](#postgresqlç›‘æ§ä¸è¯Šæ–­æ·±åº¦åº”ç”¨æŒ‡å—)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [ğŸ“‹ å®Œæ•´ç›®å½•](#-å®Œæ•´ç›®å½•)
  - [1. ç›‘æ§ä¸è¯Šæ–­æ¦‚è¿°](#1-ç›‘æ§ä¸è¯Šæ–­æ¦‚è¿°)
    - [1.1 ç›‘æ§ä½“ç³»](#11-ç›‘æ§ä½“ç³»)
      - [ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾](#ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.2 è¯Šæ–­ä½“ç³»](#12-è¯Šæ–­ä½“ç³»)
      - [è¯Šæ–­ä½“ç³»å†³ç­–çŸ©é˜µ](#è¯Šæ–­ä½“ç³»å†³ç­–çŸ©é˜µ)
  - [2. ç›‘æ§æŒ‡æ ‡é€‰å‹å†³ç­–](#2-ç›‘æ§æŒ‡æ ‡é€‰å‹å†³ç­–)
    - [2.1 å…³é”®æŒ‡æ ‡åœºæ™¯](#21-å…³é”®æŒ‡æ ‡åœºæ™¯)
      - [2.1.1 åœºæ™¯æè¿°](#211-åœºæ™¯æè¿°)
      - [2.1.2 å…³é”®æŒ‡æ ‡å®ç°](#212-å…³é”®æŒ‡æ ‡å®ç°)
      - [2.1.3 æ€§èƒ½è®ºè¯](#213-æ€§èƒ½è®ºè¯)
    - [2.2 é˜ˆå€¼è®¾ç½®åœºæ™¯](#22-é˜ˆå€¼è®¾ç½®åœºæ™¯)
      - [2.2.1 åœºæ™¯æè¿°](#221-åœºæ™¯æè¿°)
      - [2.2.2 é˜ˆå€¼è®¾ç½®å®ç°](#222-é˜ˆå€¼è®¾ç½®å®ç°)
      - [2.2.3 æ•ˆæœè®ºè¯](#223-æ•ˆæœè®ºè¯)
    - [2.3 å‘Šè­¦ç­–ç•¥åœºæ™¯](#23-å‘Šè­¦ç­–ç•¥åœºæ™¯)
      - [2.3.1 åœºæ™¯æè¿°](#231-åœºæ™¯æè¿°)
      - [2.3.2 å‘Šè­¦ç­–ç•¥å®ç°](#232-å‘Šè­¦ç­–ç•¥å®ç°)
      - [2.3.3 æ•ˆæœè®ºè¯](#233-æ•ˆæœè®ºè¯)
  - [3. æ€§èƒ½è¯Šæ–­åœºæ™¯åˆ†æ](#3-æ€§èƒ½è¯Šæ–­åœºæ™¯åˆ†æ)
    - [3.1 æ…¢æŸ¥è¯¢è¯Šæ–­åœºæ™¯](#31-æ…¢æŸ¥è¯¢è¯Šæ–­åœºæ™¯)
      - [3.1.1 åœºæ™¯æè¿°](#311-åœºæ™¯æè¿°)
      - [3.1.2 æ…¢æŸ¥è¯¢è¯Šæ–­å®ç°](#312-æ…¢æŸ¥è¯¢è¯Šæ–­å®ç°)
      - [3.1.3 æ€§èƒ½è®ºè¯](#313-æ€§èƒ½è®ºè¯)
    - [3.2 é”ç­‰å¾…è¯Šæ–­åœºæ™¯](#32-é”ç­‰å¾…è¯Šæ–­åœºæ™¯)
      - [3.2.1 åœºæ™¯æè¿°](#321-åœºæ™¯æè¿°)
      - [3.2.2 é”ç­‰å¾…è¯Šæ–­å®ç°](#322-é”ç­‰å¾…è¯Šæ–­å®ç°)
      - [3.2.3 æ€§èƒ½è®ºè¯](#323-æ€§èƒ½è®ºè¯)
    - [3.3 IOç“¶é¢ˆè¯Šæ–­åœºæ™¯](#33-ioç“¶é¢ˆè¯Šæ–­åœºæ™¯)
      - [3.3.1 åœºæ™¯æè¿°](#331-åœºæ™¯æè¿°)
      - [3.3.2 IOç“¶é¢ˆè¯Šæ–­å®ç°](#332-ioç“¶é¢ˆè¯Šæ–­å®ç°)
      - [3.3.3 æ€§èƒ½è®ºè¯](#333-æ€§èƒ½è®ºè¯)
  - [4. ç›‘æ§æ¶æ„è®¾è®¡åœºæ™¯](#4-ç›‘æ§æ¶æ„è®¾è®¡åœºæ™¯)
    - [4.1 ç›‘æ§å·¥å…·é€‰å‹](#41-ç›‘æ§å·¥å…·é€‰å‹)
      - [4.1.1 åœºæ™¯æè¿°](#411-åœºæ™¯æè¿°)
      - [4.1.2 å·¥å…·é€‰å‹å®ç°](#412-å·¥å…·é€‰å‹å®ç°)
      - [4.1.3 é€‰å‹è®ºè¯](#413-é€‰å‹è®ºè¯)
    - [4.2 ç›‘æ§æ¶æ„è®¾è®¡](#42-ç›‘æ§æ¶æ„è®¾è®¡)
      - [4.2.1 åœºæ™¯æè¿°](#421-åœºæ™¯æè¿°)
      - [4.2.2 æ¶æ„è®¾è®¡å®ç°](#422-æ¶æ„è®¾è®¡å®ç°)
      - [4.2.3 æ¶æ„è®ºè¯](#423-æ¶æ„è®ºè¯)
  - [5. è¯Šæ–­å·¥å…·å¯¹æ¯”ä¸åº”ç”¨åœºæ™¯](#5-è¯Šæ–­å·¥å…·å¯¹æ¯”ä¸åº”ç”¨åœºæ™¯)
    - [5.1 è¯Šæ–­å·¥å…·å¯¹æ¯”](#51-è¯Šæ–­å·¥å…·å¯¹æ¯”)
      - [5.1.1 å·¥å…·å¯¹æ¯”åˆ†æ](#511-å·¥å…·å¯¹æ¯”åˆ†æ)
      - [5.1.2 å·¥å…·é€‰å‹å†³ç­–](#512-å·¥å…·é€‰å‹å†³ç­–)
  - [6. ç»¼åˆé€‰å‹æ¡ˆä¾‹](#6-ç»¼åˆé€‰å‹æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹1ï¼šå¤§è§„æ¨¡ç³»ç»Ÿç›‘æ§æ¶æ„è®¾è®¡](#61-æ¡ˆä¾‹1å¤§è§„æ¨¡ç³»ç»Ÿç›‘æ§æ¶æ„è®¾è®¡)
    - [6.2 æ¡ˆä¾‹2ï¼šæ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹](#62-æ¡ˆä¾‹2æ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
  - [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## 1. ç›‘æ§ä¸è¯Šæ–­æ¦‚è¿°

### 1.1 ç›‘æ§ä½“ç³»

ç›‘æ§ä½“ç³»æ˜¯PostgreSQLè¿ç»´çš„åŸºç¡€ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç›‘æ§ã€æŸ¥è¯¢ç›‘æ§ã€é”ç›‘æ§ç­‰ã€‚

#### ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç›‘æ§ä½“ç³»))
    ç³»ç»Ÿç›‘æ§
      CPUç›‘æ§
        ä½¿ç”¨ç‡
        è´Ÿè½½
      å†…å­˜ç›‘æ§
        ä½¿ç”¨ç‡
        ç¼“å­˜å‘½ä¸­ç‡
      IOç›‘æ§
        è¯»å†™IOPS
        å»¶è¿Ÿ
        ååé‡
    æ•°æ®åº“ç›‘æ§
      è¿æ¥ç›‘æ§
        è¿æ¥æ•°
        è¿æ¥çŠ¶æ€
        è¿æ¥æ± 
      æŸ¥è¯¢ç›‘æ§
        æ…¢æŸ¥è¯¢
        æŸ¥è¯¢ç»Ÿè®¡
        æ‰§è¡Œè®¡åˆ’
      é”ç›‘æ§
        é”ç­‰å¾…
        æ­»é”
        é”å†²çª
    æ€§èƒ½ç›‘æ§
      ç¼“å­˜å‘½ä¸­ç‡
      ç´¢å¼•ä½¿ç”¨ç‡
      è¡¨ç»Ÿè®¡ä¿¡æ¯
      WALç»Ÿè®¡
```

### 1.2 è¯Šæ–­ä½“ç³»

#### è¯Šæ–­ä½“ç³»å†³ç­–çŸ©é˜µ

| è¯Šæ–­ç±»å‹ | è¯Šæ–­å·¥å…· | è¯Šæ–­æ—¶é—´ | å‡†ç¡®åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|--------|---------|
| **æ…¢æŸ¥è¯¢è¯Šæ–­** | EXPLAIN, pg_stat_statements | 5åˆ†é’Ÿ | é«˜ | æŸ¥è¯¢æ€§èƒ½é—®é¢˜ |
| **é”ç­‰å¾…è¯Šæ–­** | pg_locks, pg_stat_activity | 2åˆ†é’Ÿ | å¾ˆé«˜ | é”å†²çªé—®é¢˜ |
| **IOç“¶é¢ˆè¯Šæ–­** | pg_stat_io, pg_stat_get_backend_io(), iostat | 3åˆ†é’Ÿ | é«˜ | IOæ€§èƒ½é—®é¢˜ï¼ˆPostgreSQL 18å¢å¼ºï¼šread_bytes/write_bytesåˆ—ï¼‰ |
| **æ€§èƒ½è¯Šæ–­** | EXPLAIN (ANALYZE, BUFFERS, SETTINGS) | 2åˆ†é’Ÿ | å¾ˆé«˜ | æŸ¥è¯¢æ€§èƒ½é—®é¢˜ï¼ˆPostgreSQL 18å¢å¼ºï¼šå³æ—¶è¯Šæ–­ï¼‰ |
| **å¹¶è¡ŒæŸ¥è¯¢åˆ†æ** | pg_stat_statements (parallel_workers_*) | 1åˆ†é’Ÿ | é«˜ | å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18æ–°å¢ï¼‰ |
| **è¿æ¥é—®é¢˜è¯Šæ–­** | pg_stat_activity | 1åˆ†é’Ÿ | å¾ˆé«˜ | è¿æ¥é—®é¢˜ |

---

## 2. ç›‘æ§æŒ‡æ ‡é€‰å‹å†³ç­–

### 2.1 å…³é”®æŒ‡æ ‡åœºæ™¯

#### 2.1.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šå…³é”®ä¸šåŠ¡ç³»ç»Ÿç›‘æ§
éœ€æ±‚ï¼š
1. å…³é”®æŒ‡æ ‡ç›‘æ§
2. å®æ—¶å‘Šè­¦
3. æ€§èƒ½åˆ†æ
4. å®¹é‡è§„åˆ’

ç³»ç»Ÿç‰¹å¾ï¼š
- å…³é”®ä¸šåŠ¡ç³»ç»Ÿ
- 7x24å°æ—¶æœåŠ¡
- æ€§èƒ½è¦æ±‚é«˜
- éœ€è¦å®¹é‡è§„åˆ’
```

#### 2.1.2 å…³é”®æŒ‡æ ‡å®ç°

**å…³é”®æŒ‡æ ‡æŸ¥è¯¢**:

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction,
    max_conn AS max_connections,
    round(100.0 * count(*) / max_conn, 2) AS connection_usage_percent
FROM pg_stat_activity, (
    SELECT setting::int AS max_conn FROM pg_settings WHERE name = 'max_connections'
) mc
GROUP BY max_conn;

-- 2. æŸ¥è¯¢æ€§èƒ½ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_count INT;
BEGIN
    SELECT COUNT(*) INTO db_count
    FROM pg_stat_database;

    RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ•°æ®åº“', db_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_databaseè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢æ€§èƒ½ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    round(100.0 * blks_hit / nullif(blks_hit + blks_read, 0), 2) AS cache_hit_ratio,
    tup_returned AS tuples_returned,
    tup_fetched AS tuples_fetched,
    tup_inserted AS tuples_inserted,
    tup_updated AS tuples_updated,
    tup_deleted AS tuples_deleted
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres');

-- 3. é”ç­‰å¾…ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    blocked_count INT;
BEGIN
    SELECT COUNT(*) INTO blocked_count
    FROM pg_locks blocked_locks
    JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
    JOIN pg_locks blocking_locks
        ON blocking_locks.locktype = blocked_locks.locktype
        AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
        AND blocking_locks.pid != blocked_locks.pid
    JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
    WHERE NOT blocked_locks.granted;

    RAISE NOTICE 'å‘ç° % ä¸ªé˜»å¡çš„é”', blocked_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_locksæˆ–pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é”ç­‰å¾…ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 4. è¡¨å¤§å°ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    SELECT COUNT(*) INTO table_count
    FROM pg_stat_user_tables;

    RAISE NOTICE 'æ‰¾åˆ° % ä¸ªç”¨æˆ·è¡¨', table_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¡¨å¤§å°ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    n_live_tup AS row_count,
    n_dead_tup AS dead_rows,
    round(100.0 * n_dead_tup / nullif(n_live_tup + n_dead_tup, 0), 2) AS dead_row_percent
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;
```

#### 2.1.3 æ€§èƒ½è®ºè¯

**ç›‘æ§æŒ‡æ ‡é‡è¦æ€§**:

| æŒ‡æ ‡ | é‡è¦æ€§ | å‘Šè­¦é˜ˆå€¼ | å½±å“èŒƒå›´ |
|------|--------|---------|---------|
| **è¿æ¥æ•°** | å¾ˆé«˜ | > 80% | å…¨ç³»ç»Ÿ |
| **ç¼“å­˜å‘½ä¸­ç‡** | é«˜ | < 95% | æŸ¥è¯¢æ€§èƒ½ |
| **é”ç­‰å¾…** | å¾ˆé«˜ | > 0 | å¹¶å‘æ€§èƒ½ |
| **è¡¨å¤§å°** | ä¸­ | > 10GB | å­˜å‚¨æ€§èƒ½ |

---

### 2.2 é˜ˆå€¼è®¾ç½®åœºæ™¯

#### 2.2.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šæ™ºèƒ½é˜ˆå€¼è®¾ç½®
éœ€æ±‚ï¼š
1. åŠ¨æ€é˜ˆå€¼
2. å‡å°‘è¯¯æŠ¥
3. åŠæ—¶å‘Šè­¦
4. è‡ªé€‚åº”è°ƒæ•´

ç³»ç»Ÿç‰¹å¾ï¼š
- ä¸šåŠ¡è´Ÿè½½æ³¢åŠ¨
- éœ€è¦å‡å°‘è¯¯æŠ¥
- åŠæ—¶å‘ç°é—®é¢˜
- è‡ªé€‚åº”èƒ½åŠ›
```

#### 2.2.2 é˜ˆå€¼è®¾ç½®å®ç°

**åŠ¨æ€é˜ˆå€¼è®¡ç®—**:

```sql
-- åˆ›å»ºé˜ˆå€¼è®¡ç®—å‡½æ•°
CREATE OR REPLACE FUNCTION calculate_dynamic_threshold(
    metric_name TEXT,
    lookback_hours INTEGER DEFAULT 24
) RETURNS TABLE(
    current_value NUMERIC,
    avg_value NUMERIC,
    stddev_value NUMERIC,
    threshold_warning NUMERIC,
    threshold_critical NUMERIC
) AS $$
DECLARE
    current_val NUMERIC;
    avg_val NUMERIC;
    stddev_val NUMERIC;
BEGIN
    -- è·å–å½“å‰å€¼ï¼ˆç¤ºä¾‹ï¼šè¿æ¥æ•°ï¼‰
    SELECT count(*) INTO current_val
    FROM pg_stat_activity
    WHERE state != 'idle';

    -- è®¡ç®—å†å²å¹³å‡å€¼å’Œæ ‡å‡†å·®
    SELECT
        avg(connection_count),
        stddev(connection_count)
    INTO avg_val, stddev_val
    FROM (
        -- è¿™é‡Œéœ€è¦ä»ç›‘æ§ç³»ç»Ÿè·å–å†å²æ•°æ®
        -- ç¤ºä¾‹ï¼šå‡è®¾æœ‰ç›‘æ§å†å²è¡¨
        SELECT connection_count
        FROM monitoring_history
        WHERE metric_name = $1
        AND timestamp > NOW() - (lookback_hours || ' hours')::INTERVAL
    ) hist;

    -- è®¡ç®—åŠ¨æ€é˜ˆå€¼ï¼ˆå¹³å‡å€¼ + 2å€æ ‡å‡†å·®ï¼‰
    threshold_warning := avg_val + 1.5 * stddev_val;
    threshold_critical := avg_val + 3 * stddev_val;

    RETURN QUERY SELECT
        current_val,
        avg_val,
        stddev_val,
        threshold_warning,
        threshold_critical;
END;
$$ LANGUAGE plpgsql;
```

**é˜ˆå€¼é…ç½®**:

```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # è¿æ¥æ•°å‘Šè­¦ï¼ˆåŠ¨æ€é˜ˆå€¼ï¼‰
      - alert: PostgreSQLHighConnections
        expr: |
          (
            pg_stat_activity_count{state!="idle"}
            >
            (
              avg_over_time(pg_stat_activity_count[24h])
              + 2 * stddev_over_time(pg_stat_activity_count[24h])
            )
          )
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°å¼‚å¸¸"
          description: "è¿æ¥æ•° {{ $value }} è¶…è¿‡åŠ¨æ€é˜ˆå€¼"

      # ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
      - alert: PostgreSQLLowCacheHitRatio
        expr: pg_stat_database_cache_hit_ratio < 0.95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLç¼“å­˜å‘½ä¸­ç‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ {{ $value }} ä½äº95%"
```

#### 2.2.3 æ•ˆæœè®ºè¯

**é˜ˆå€¼è®¾ç½®æ•ˆæœ**:

| é˜ˆå€¼ç±»å‹ | è¯¯æŠ¥ç‡ | æ¼æŠ¥ç‡ | å“åº”æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|---------|---------|
| **å›ºå®šé˜ˆå€¼** | é«˜ | ä½ | å¿« | ç¨³å®šè´Ÿè½½ |
| **åŠ¨æ€é˜ˆå€¼** | ä½ | ä½ | å¿« | æ³¢åŠ¨è´Ÿè½½ |
| **è‡ªé€‚åº”é˜ˆå€¼** | å¾ˆä½ | å¾ˆä½ | ä¸­ | å¤æ‚è´Ÿè½½ |

---

### 2.3 å‘Šè­¦ç­–ç•¥åœºæ™¯

#### 2.3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šæ™ºèƒ½å‘Šè­¦ç­–ç•¥
éœ€æ±‚ï¼š
1. åˆ†çº§å‘Šè­¦
2. å‘Šè­¦èšåˆ
3. å‘Šè­¦æŠ‘åˆ¶
4. å‘Šè­¦å‡çº§

ç³»ç»Ÿç‰¹å¾ï¼š
- å¤šç³»ç»Ÿç›‘æ§
- å‘Šè­¦é‡å¤§
- éœ€è¦åˆ†çº§å¤„ç†
- å¿«é€Ÿå“åº”
```

#### 2.3.2 å‘Šè­¦ç­–ç•¥å®ç°

**åˆ†çº§å‘Šè­¦é…ç½®**:

```yaml
# å‘Šè­¦åˆ†çº§ç­–ç•¥
alert_levels:
  critical:
    conditions:
      - connection_usage > 95%
      - cache_hit_ratio < 90%
      - deadlock_count > 0
    actions:
      - notify: ["oncall_engineer", "dba_team"]
      - escalate: true
      - auto_recovery: false

  warning:
    conditions:
      - connection_usage > 80%
      - cache_hit_ratio < 95%
      - slow_query_count > 10
    actions:
      - notify: ["dba_team"]
      - escalate: false
      - auto_recovery: true

  info:
    conditions:
      - connection_usage > 70%
      - table_size_growth > 10%
    actions:
      - notify: ["monitoring_team"]
      - escalate: false
      - auto_recovery: false
```

**å‘Šè­¦èšåˆ**:

```sql
-- å‘Šè­¦èšåˆæŸ¥è¯¢
SELECT
    alert_type,
    count(*) AS alert_count,
    min(alert_time) AS first_alert,
    max(alert_time) AS last_alert,
    array_agg(DISTINCT hostname) AS affected_hosts
FROM alerts
WHERE alert_time > NOW() - INTERVAL '1 hour'
AND status = 'active'
GROUP BY alert_type
HAVING count(*) > 5  -- èšåˆè¶…è¿‡5æ¬¡çš„å‘Šè­¦
ORDER BY alert_count DESC;
```

#### 2.3.3 æ•ˆæœè®ºè¯

**å‘Šè­¦ç­–ç•¥æ•ˆæœ**:

| ç­–ç•¥ | å‘Šè­¦é‡ | å“åº”æ—¶é—´ | è¯¯æŠ¥ç‡ | é€‚ç”¨åœºæ™¯ |
|------|--------|---------|--------|---------|
| **æ— èšåˆ** | é«˜ | å¿« | é«˜ | å°è§„æ¨¡ç³»ç»Ÿ |
| **ç®€å•èšåˆ** | ä¸­ | ä¸­ | ä¸­ | ä¸­ç­‰è§„æ¨¡ç³»ç»Ÿ |
| **æ™ºèƒ½èšåˆ** | ä½ | ä¸­ | ä½ | å¤§è§„æ¨¡ç³»ç»Ÿ |

---

## 3. æ€§èƒ½è¯Šæ–­åœºæ™¯åˆ†æ

### 3.1 æ…¢æŸ¥è¯¢è¯Šæ–­åœºæ™¯

#### 3.1.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­ä¸ä¼˜åŒ–
éœ€æ±‚ï¼š
1. è¯†åˆ«æ…¢æŸ¥è¯¢
2. åˆ†ææ‰§è¡Œè®¡åˆ’
3. ä¼˜åŒ–å»ºè®®
4. éªŒè¯æ•ˆæœ

ç³»ç»Ÿç‰¹å¾ï¼š
- æŸ¥è¯¢æ€§èƒ½é—®é¢˜
- æ…¢æŸ¥è¯¢å¤š
- éœ€è¦ä¼˜åŒ–
- æ€§èƒ½è¦æ±‚é«˜
```

#### 3.1.2 æ…¢æŸ¥è¯¢è¯Šæ–­å®ç°

**æ…¢æŸ¥è¯¢è¯†åˆ«**:

```sql
-- 1. å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 3. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM orders WHERE user_id = 12345;

-- 4. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
AND tablename = 'orders'
ORDER BY abs(correlation) DESC;
```

**æ…¢æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- 1. åˆ›å»ºç¼ºå¤±ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_orders_user_id ON orders(user_id);

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- 3. éªŒè¯ä¼˜åŒ–æ•ˆæœ
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders WHERE user_id = 12345;
```

#### 3.1.3 æ€§èƒ½è®ºè¯

**ä¼˜åŒ–æ•ˆæœ**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **æŸ¥è¯¢æ—¶é—´** | 5ç§’ | 0.1ç§’ | -98% |
| **ç´¢å¼•ä½¿ç”¨** | æ—  | æœ‰ | +100% |
| **ç¼“å­˜å‘½ä¸­ç‡** | 60% | 95% | +58% |

---

### 3.2 é”ç­‰å¾…è¯Šæ–­åœºæ™¯

#### 3.2.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šé”ç­‰å¾…é—®é¢˜è¯Šæ–­
éœ€æ±‚ï¼š
1. è¯†åˆ«é”ç­‰å¾…
2. åˆ†æé”å†²çª
3. è§£å†³æ­»é”
4. ä¼˜åŒ–é”ç­–ç•¥

ç³»ç»Ÿç‰¹å¾ï¼š
- é«˜å¹¶å‘ç³»ç»Ÿ
- é”ç­‰å¾…å¤š
- æ€§èƒ½ä¸‹é™
- éœ€è¦ä¼˜åŒ–
```

#### 3.2.2 é”ç­‰å¾…è¯Šæ–­å®ç°

**é”ç­‰å¾…æŸ¥è¯¢**:

```sql
-- 1. æŸ¥è¯¢é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    blocked_activity.state AS blocked_state,
    blocking_activity.state AS blocking_state,
    age(now(), blocked_activity.query_start) AS blocked_duration,
    age(now(), blocking_activity.query_start) AS blocking_duration
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 2. æŸ¥è¯¢æ­»é”
SELECT
    pid,
    usename,
    query,
    state,
    wait_event_type,
    wait_event
FROM pg_stat_activity
WHERE wait_event_type = 'Lock'
ORDER BY query_start;

-- 3. è§£å†³æ­»é”ï¼ˆç»ˆæ­¢é˜»å¡æŸ¥è¯¢ï¼‰
SELECT pg_terminate_backend(blocking_pid)
FROM (
    -- ä½¿ç”¨ä¸Šé¢çš„é”ç­‰å¾…æŸ¥è¯¢
) locks;
```

#### 3.2.3 æ€§èƒ½è®ºè¯

**ä¼˜åŒ–æ•ˆæœ**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **é”ç­‰å¾…æ—¶é—´** | 10ç§’ | 0.5ç§’ | -95% |
| **æ­»é”é¢‘ç‡** | æ¯å¤©5æ¬¡ | æ¯å‘¨1æ¬¡ | -93% |
| **å¹¶å‘æ€§èƒ½** | ä½ | é«˜ | +200% |

---

### 3.3 IOç“¶é¢ˆè¯Šæ–­åœºæ™¯

#### 3.3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šIOæ€§èƒ½ç“¶é¢ˆè¯Šæ–­
éœ€æ±‚ï¼š
1. è¯†åˆ«IOç“¶é¢ˆ
2. åˆ†æIOæ¨¡å¼
3. ä¼˜åŒ–IOæ€§èƒ½
4. å®¹é‡è§„åˆ’

ç³»ç»Ÿç‰¹å¾ï¼š
- IOå¯†é›†å‹ç³»ç»Ÿ
- IOæ€§èƒ½é—®é¢˜
- éœ€è¦ä¼˜åŒ–
- å®¹é‡è§„åˆ’
```

#### 3.3.2 IOç“¶é¢ˆè¯Šæ–­å®ç°

**IOç›‘æ§æŸ¥è¯¢**:

```sql
-- 1. æŸ¥è¯¢IOç»Ÿè®¡ï¼ˆPostgreSQL 17+ï¼ŒPostgreSQL 18å¢å¼ºï¼‰
-- PostgreSQL 18æ–°å¢ï¼šread_bytesã€write_bytesã€extend_bytesåˆ—
-- PostgreSQL 18æ–°å¢ï¼špg_stat_get_backend_io()å‡½æ•°æ”¯æŒåç«¯çº§åˆ«I/Oè¿½è¸ª
DO $$
DECLARE
    pg_version int;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    IF pg_version >= 180000 THEN
        -- PostgreSQL 18+: ä½¿ç”¨å¢å¼ºçš„I/Oç»Ÿè®¡
        RAISE NOTICE 'ä½¿ç”¨PostgreSQL 18å¢å¼ºI/Oç»Ÿè®¡';
        RAISE NOTICE 'PostgreSQL 18æ–°å¢åŠŸèƒ½:';
        RAISE NOTICE '- read_bytes/write_bytes/extend_bytesåˆ—';
        RAISE NOTICE '- pg_stat_get_backend_io()å‡½æ•°';
        RAISE NOTICE '- pg_stat_reset_backend_stats()å‡½æ•°';
    ELSIF pg_version >= 170000 THEN
        -- PostgreSQL 17+: åŸºç¡€I/Oç»Ÿè®¡
        RAISE NOTICE 'ä½¿ç”¨PostgreSQL 17åŸºç¡€I/Oç»Ÿè®¡';
    ELSE
        RAISE WARNING 'pg_stat_ioè§†å›¾éœ€è¦PostgreSQL 17+';
        RETURN;
    END IF;
END $$;

-- PostgreSQL 18å¢å¼ºï¼šåŒ…å«å­—èŠ‚ç»Ÿè®¡
SELECT
    object,
    context,
    reads,
    CASE
        WHEN (SELECT current_setting('server_version_num')::int) >= 180000
        THEN read_bytes
        ELSE NULL
    END AS read_bytes,  -- PostgreSQL 18æ–°å¢
    writes,
    CASE
        WHEN (SELECT current_setting('server_version_num')::int) >= 180000
        THEN write_bytes
        ELSE NULL
    END AS write_bytes,  -- PostgreSQL 18æ–°å¢
    extends,
    CASE
        WHEN (SELECT current_setting('server_version_num')::int) >= 180000
        THEN extend_bytes
        ELSE NULL
    END AS extend_bytes,  -- PostgreSQL 18æ–°å¢
    fsyncs,
    op_bytes,
    evictions,
    reuses,
    unpins,
    -- PostgreSQL 18: è®¡ç®—I/Oååé‡
    CASE
        WHEN (SELECT current_setting('server_version_num')::int) >= 180000
        THEN ROUND((read_bytes + write_bytes)::numeric / 1024 / 1024, 2)
        ELSE NULL
    END AS total_io_mb
FROM pg_stat_io
WHERE reads > 0 OR writes > 0
ORDER BY reads + writes DESC
LIMIT 20;

-- 2. æŸ¥è¯¢è¡¨IOç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    toast_blks_read,
    toast_blks_hit,
    round(100.0 * heap_blks_hit / nullif(heap_blks_hit + heap_blks_read, 0), 2) AS heap_hit_ratio,
    round(100.0 * idx_blks_hit / nullif(idx_blks_hit + idx_blks_read, 0), 2) AS idx_hit_ratio
FROM pg_statio_user_tables
ORDER BY heap_blks_read + idx_blks_read DESC
LIMIT 20;

-- 3. æŸ¥è¯¢ç´¢å¼•IOç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * idx_blks_hit / nullif(idx_blks_hit + idx_blks_read, 0), 2) AS hit_ratio
FROM pg_statio_user_indexes
WHERE idx_blks_read > 0
ORDER BY idx_blks_read DESC
LIMIT 20;
```

**IOä¼˜åŒ–**:

```sql
-- 1. å¢åŠ shared_buffers
ALTER SYSTEM SET shared_buffers = '8GB';

-- 2. ä¼˜åŒ–checkpoint
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';

-- 3. ä½¿ç”¨SSDè¡¨ç©ºé—´
CREATE TABLESPACE fast_ssd LOCATION '/data/fast_ssd';
ALTER TABLE hot_table SET TABLESPACE fast_ssd;

-- 4. PostgreSQL 18: å¯ç”¨å¼‚æ­¥I/Oï¼ˆæ–°å¢ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®ï¼š
-- io_method = 'worker'  # æˆ– 'io_uring'ï¼ˆå¦‚æœç³»ç»Ÿæ”¯æŒï¼‰
-- max_io_workers = 10
-- maintenance_io_workers = 4

-- 5. PostgreSQL 18: åç«¯çº§åˆ«I/Oè¿½è¸ªï¼ˆæ–°å¢ï¼‰
-- æŸ¥è¯¢ç‰¹å®šåç«¯çš„I/Oç»Ÿè®¡
DO $$
DECLARE
    pg_version int;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    IF pg_version >= 180000 THEN
        -- PostgreSQL 18+: ä½¿ç”¨pg_stat_get_backend_io()å‡½æ•°
        RAISE NOTICE 'ä½¿ç”¨PostgreSQL 18åç«¯I/Oè¿½è¸ªåŠŸèƒ½';

        -- æŸ¥è¯¢æ´»è·ƒåç«¯çš„I/Oç»Ÿè®¡
        PERFORM
            pid,
            usename,
            application_name,
            state,
            query_start,
            pg_stat_get_backend_io(pid) AS io_stats
        FROM pg_stat_activity
        WHERE pid != pg_backend_pid()
          AND state = 'active'
        ORDER BY query_start DESC
        LIMIT 10;

        -- é‡ç½®åç«¯ç»Ÿè®¡ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
        -- SELECT pg_stat_reset_backend_stats(pid) FROM pg_stat_activity WHERE pid = 12345;
    ELSE
        RAISE WARNING 'pg_stat_get_backend_io()å‡½æ•°éœ€è¦PostgreSQL 18+';
    END IF;
END $$;

-- 6. PostgreSQL 18: EXPLAINå¢å¼º - å³æ—¶æ€§èƒ½è¯Šæ–­ï¼ˆæ–°å¢ï¼‰
-- ä½¿ç”¨EXPLAINçš„å¢å¼ºåŠŸèƒ½è¿›è¡Œå³æ—¶æ€§èƒ½è¯Šæ–­
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS, TIMING)
SELECT o.*, u.username
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.created_at > NOW() - INTERVAL '30 days'
ORDER BY o.created_at DESC
LIMIT 100;

-- PostgreSQL 18 EXPLAINå¢å¼ºç‰¹æ€§:
-- - SETTINGSé€‰é¡¹ï¼šæ˜¾ç¤ºå½±å“æŸ¥è¯¢çš„é…ç½®å‚æ•°
-- - å¢å¼ºçš„BUFFERSï¼šæ›´è¯¦ç»†çš„ç¼“å­˜ä½¿ç”¨ç»Ÿè®¡
-- - å¢å¼ºçš„VERBOSEï¼šæ›´è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯
-- - ä¼˜åŒ–å»ºè®®ï¼šè‡ªåŠ¨æä¾›ç´¢å¼•ä¼˜åŒ–ã€å†…å­˜è°ƒä¼˜å»ºè®®

-- 7. PostgreSQL 18: pg_stat_statementså¹¶è¡ŒæŸ¥è¯¢è¿½è¸ªï¼ˆæ–°å¢ï¼‰
-- æŸ¥è¯¢å¹¶è¡ŒæŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    parallel_workers_to_launch,  -- PostgreSQL 18æ–°å¢ï¼šè®¡åˆ’å¯åŠ¨çš„å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
    parallel_workers_launched,    -- PostgreSQL 18æ–°å¢ï¼šå®é™…å¯åŠ¨çš„å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
    ROUND(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0), 2) AS parallel_efficiency
FROM pg_stat_statements
WHERE parallel_workers_to_launch > 0
ORDER BY total_exec_time DESC
LIMIT 20;

-- PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ªä¼˜åŠ¿:
-- - åˆ†æå¹¶è¡ŒæŸ¥è¯¢æ•ˆæœ
-- - è¯†åˆ«å¹¶è¡ŒæŸ¥è¯¢ç“¶é¢ˆ
-- - ä¼˜åŒ–å¹¶è¡ŒæŸ¥è¯¢é…ç½®
-- - SETè¯­å¥å‚æ•°åŒ–è¿½è¸ªï¼ˆå‡å°‘ç»Ÿè®¡ä¿¡æ¯è†¨èƒ€ï¼‰
```

#### 3.3.3 æ€§èƒ½è®ºè¯

**ä¼˜åŒ–æ•ˆæœ**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **IOPS** | 1000 | 5000 | +400% |
| **IOå»¶è¿Ÿ** | 10ms | 2ms | -80% |
| **ç¼“å­˜å‘½ä¸­ç‡** | 70% | 95% | +36% |
| **å¼‚æ­¥I/Oæ€§èƒ½**ï¼ˆPostgreSQL 18ï¼‰ | åŸºå‡† | 3å€æå‡ | +200% |
| **å¹¶è¡ŒæŸ¥è¯¢æ•ˆç‡**ï¼ˆPostgreSQL 18ï¼‰ | 60% | 95% | +58% |

---

## 4. ç›‘æ§æ¶æ„è®¾è®¡åœºæ™¯

### 4.1 ç›‘æ§å·¥å…·é€‰å‹

#### 4.1.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šç›‘æ§å·¥å…·é€‰å‹
éœ€æ±‚ï¼š
1. é€‰æ‹©åˆé€‚çš„ç›‘æ§å·¥å…·
2. é›†æˆç°æœ‰ç³»ç»Ÿ
3. æˆæœ¬æ§åˆ¶
4. æ‰©å±•æ€§

ç³»ç»Ÿç‰¹å¾ï¼š
- å¤šæ•°æ®åº“å®ä¾‹
- éœ€è¦ç»Ÿä¸€ç›‘æ§
- æˆæœ¬æ•æ„Ÿ
- éœ€è¦æ‰©å±•
```

#### 4.1.2 å·¥å…·é€‰å‹å®ç°

**ç›‘æ§å·¥å…·å¯¹æ¯”**:

| å·¥å…· | åŠŸèƒ½ | æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **Prometheus + Grafana** | å¾ˆé«˜ | é«˜ | å…è´¹ | å¤§è§„æ¨¡ç³»ç»Ÿ |
| **pgAdmin** | ä¸­ | ä¸­ | å…è´¹ | å°è§„æ¨¡ç³»ç»Ÿ |
| **Datadog** | å¾ˆé«˜ | å¾ˆé«˜ | ä»˜è´¹ | ä¼ä¸šçº§ç³»ç»Ÿ |
| **New Relic** | é«˜ | é«˜ | ä»˜è´¹ | åº”ç”¨ç›‘æ§ |

**Prometheusé…ç½®**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['db1:9187', 'db2:9187', 'db3:9187']
    scrape_interval: 15s
    metrics_path: /metrics
```

#### 4.1.3 é€‰å‹è®ºè¯

**é€‰å‹å†³ç­–æµç¨‹**:

```mermaid
flowchart TD
    A[ç›‘æ§éœ€æ±‚] --> B{ç³»ç»Ÿè§„æ¨¡?}
    B -->|å°è§„æ¨¡| C[pgAdmin]
    B -->|ä¸­ç­‰è§„æ¨¡| D{æˆæœ¬è¦æ±‚?}
    B -->|å¤§è§„æ¨¡| E[Prometheus+Grafana]
    D -->|å…è´¹| E
    D -->|ä»˜è´¹| F[Datadog/New Relic]
    C --> G[å®Œæˆé€‰å‹]
    E --> G
    F --> G
```

---

### 4.2 ç›‘æ§æ¶æ„è®¾è®¡

#### 4.2.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**:

```text
åœºæ™¯ï¼šå¤§è§„æ¨¡ç›‘æ§æ¶æ„è®¾è®¡
éœ€æ±‚ï¼š
1. å¯æ‰©å±•æ¶æ„
2. é«˜å¯ç”¨æ€§
3. æ•°æ®ä¿ç•™
4. æ€§èƒ½ä¼˜åŒ–

ç³»ç»Ÿç‰¹å¾ï¼š
- 100+æ•°æ®åº“å®ä¾‹
- 7x24å°æ—¶ç›‘æ§
- é•¿æœŸæ•°æ®ä¿ç•™
- é«˜æ€§èƒ½è¦æ±‚
```

#### 4.2.2 æ¶æ„è®¾è®¡å®ç°

**ç›‘æ§æ¶æ„**:

```text
æ•°æ®æ”¶é›†å±‚
â”œâ”€â”€ postgres_exporter (æ¯ä¸ªæ•°æ®åº“å®ä¾‹)
â”œâ”€â”€ node_exporter (ç³»ç»Ÿç›‘æ§)
â””â”€â”€ æ—¥å¿—æ”¶é›† (Filebeat/Vector)

æ•°æ®å­˜å‚¨å±‚
â”œâ”€â”€ Prometheus (çŸ­æœŸå­˜å‚¨ï¼Œ15å¤©)
â”œâ”€â”€ VictoriaMetrics (é•¿æœŸå­˜å‚¨ï¼Œ1å¹´)
â””â”€â”€ å¯¹è±¡å­˜å‚¨ (å½’æ¡£å­˜å‚¨ï¼Œ7å¹´)

æ•°æ®åˆ†æå±‚
â”œâ”€â”€ Grafana (å¯è§†åŒ–)
â”œâ”€â”€ Alertmanager (å‘Šè­¦)
â””â”€â”€ è‡ªå®šä¹‰åˆ†æè„šæœ¬

å‘Šè­¦å±‚
â”œâ”€â”€ å‘Šè­¦è§„åˆ™
â”œâ”€â”€ å‘Šè­¦è·¯ç”±
â””â”€â”€ å‘Šè­¦é€šçŸ¥
```

#### 4.2.3 æ¶æ„è®ºè¯

**æ¶æ„ä¼˜åŠ¿**:

| æ¶æ„ç‰¹æ€§ | ä¼˜åŠ¿ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| **å¯æ‰©å±•æ€§** | æ°´å¹³æ‰©å±• | å¤§è§„æ¨¡ç³»ç»Ÿ |
| **é«˜å¯ç”¨æ€§** | å†—ä½™è®¾è®¡ | å…³é”®ç³»ç»Ÿ |
| **æ•°æ®ä¿ç•™** | åˆ†å±‚å­˜å‚¨ | åˆè§„è¦æ±‚ |
| **æ€§èƒ½** | åˆ†å¸ƒå¼ | é«˜æ€§èƒ½è¦æ±‚ |

---

## 5. è¯Šæ–­å·¥å…·å¯¹æ¯”ä¸åº”ç”¨åœºæ™¯

### 5.1 è¯Šæ–­å·¥å…·å¯¹æ¯”

#### 5.1.1 å·¥å…·å¯¹æ¯”åˆ†æ

**è¯Šæ–­å·¥å…·å¯¹æ¯”çŸ©é˜µ**:

| å·¥å…· | åŠŸèƒ½ | æ€§èƒ½ | æ˜“ç”¨æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|---------|
| **EXPLAIN** | é«˜ | é«˜ | ä¸­ | æŸ¥è¯¢ä¼˜åŒ– |
| **pg_stat_statements** | å¾ˆé«˜ | é«˜ | ä¸­ | æ…¢æŸ¥è¯¢åˆ†æ |
| **pgBadger** | é«˜ | ä¸­ | é«˜ | æ—¥å¿—åˆ†æ |
| **pgAdmin** | ä¸­ | ä¸­ | å¾ˆé«˜ | å›¾å½¢åŒ–è¯Šæ–­ |

#### 5.1.2 å·¥å…·é€‰å‹å†³ç­–

**é€‰å‹å†³ç­–æµç¨‹**:

```mermaid
flowchart TD
    A[è¯Šæ–­éœ€æ±‚] --> B{é—®é¢˜ç±»å‹?}
    B -->|æŸ¥è¯¢æ€§èƒ½| C[EXPLAIN + pg_stat_statements]
    B -->|é”é—®é¢˜| D[pg_locks + pg_stat_activity]
    B -->|IOé—®é¢˜| E[pg_stat_io + iostat]
    B -->|æ—¥å¿—åˆ†æ| F[pgBadger]
    C --> G[å®Œæˆé€‰å‹]
    D --> G
    E --> G
    F --> G
```

---

## 6. ç»¼åˆé€‰å‹æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹1ï¼šå¤§è§„æ¨¡ç³»ç»Ÿç›‘æ§æ¶æ„è®¾è®¡

**ä¸šåŠ¡èƒŒæ™¯**:

- 100+æ•°æ®åº“å®ä¾‹
- 7x24å°æ—¶ç›‘æ§
- é•¿æœŸæ•°æ®ä¿ç•™
- é«˜æ€§èƒ½è¦æ±‚

**ç›‘æ§æ¶æ„è®¾è®¡**:

```text
æ–¹æ¡ˆï¼šPrometheus + VictoriaMetrics + Grafana

æ¶æ„å±‚æ¬¡ï¼š
1. æ•°æ®æ”¶é›†ï¼špostgres_exporter (æ¯ä¸ªå®ä¾‹)
2. çŸ­æœŸå­˜å‚¨ï¼šPrometheus (15å¤©)
3. é•¿æœŸå­˜å‚¨ï¼šVictoriaMetrics (1å¹´)
4. å¯è§†åŒ–ï¼šGrafana
5. å‘Šè­¦ï¼šAlertmanager

æ€§èƒ½æŒ‡æ ‡ï¼š
- æ•°æ®æ”¶é›†å»¶è¿Ÿï¼š< 15ç§’
- æŸ¥è¯¢å“åº”æ—¶é—´ï¼š< 1ç§’
- å­˜å‚¨æˆæœ¬ï¼šé™ä½ 60%
```

### 6.2 æ¡ˆä¾‹2ï¼šæ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹

**ä¸šåŠ¡èƒŒæ™¯**:

- æŸ¥è¯¢æ€§èƒ½é—®é¢˜
- éœ€è¦å¿«é€Ÿè¯Šæ–­
- éœ€è¦ä¼˜åŒ–å»ºè®®
- éœ€è¦éªŒè¯æ•ˆæœ

**è¯Šæ–­æµç¨‹**:

```text
æ–¹æ¡ˆï¼šç³»ç»ŸåŒ–è¯Šæ–­æµç¨‹

è¯Šæ–­æ­¥éª¤ï¼š
1. è¯†åˆ«é—®é¢˜ï¼špg_stat_statementsæŸ¥è¯¢æ…¢æŸ¥è¯¢
2. åˆ†ææ‰§è¡Œè®¡åˆ’ï¼šEXPLAIN (ANALYZE, BUFFERS, TIMING)
3. ä¼˜åŒ–å»ºè®®ï¼šç´¢å¼•ã€ç»Ÿè®¡ä¿¡æ¯ã€æŸ¥è¯¢é‡å†™
4. å®æ–½ä¼˜åŒ–ï¼šåˆ›å»ºç´¢å¼•ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
5. éªŒè¯æ•ˆæœï¼šå¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½

æ€§èƒ½æå‡ï¼š
- æŸ¥è¯¢æ—¶é—´ï¼šä»5ç§’é™ä½åˆ°0.1ç§’
- ç´¢å¼•ä½¿ç”¨ç‡ï¼šä»0%æå‡åˆ°100%
- ç¼“å­˜å‘½ä¸­ç‡ï¼šä»60%æå‡åˆ°95%
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18ç›‘æ§æ–‡æ¡£](https://www.postgresql.org/docs/18/monitoring-stats.html)
- [PostgreSQL 18æ€§èƒ½è°ƒä¼˜æ–‡æ¡£](https://www.postgresql.org/docs/18/performance-tips.html)
- [PostgreSQL 18 pg_stat_statementsæ–‡æ¡£](https://www.postgresql.org/docs/18/pgstatstatements.html)
- [PostgreSQL 18 pg_stat_ioè§†å›¾](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW)
- [PostgreSQL 18å¼‚æ­¥I/O](https://www.postgresql.org/docs/18/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-ASYNC-IO)
- [PostgreSQL 18 EXPLAINå¢å¼º](https://www.postgresql.org/docs/18/sql-explain.html)
- [PostgreSQL 18 Release Notes](https://www.postgresql.org/docs/18/release-18.html)

### ç›¸å…³æ–‡æ¡£

- [ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£](./ç›‘æ§è¯Šæ–­ä½“ç³»è¯¦è§£.md)
- [ç›‘æ§ä¸è¯Šæ–­è½åœ°æŒ‡å—](./06.01-ç›‘æ§ä¸è¯Šæ–­.md)
- [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](./06.04-æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-01**: åˆå§‹ç‰ˆæœ¬åˆ›å»º
  - å®Œæˆç›‘æ§æŒ‡æ ‡é€‰å‹å†³ç­–
  - å®Œæˆæ€§èƒ½è¯Šæ–­åœºæ™¯åˆ†æ
  - å®Œæˆç›‘æ§æ¶æ„è®¾è®¡åœºæ™¯
  - å®Œæˆè¯Šæ–­å·¥å…·å¯¹æ¯”
- **2025-01**: PostgreSQL 18ç‰¹æ€§å¯¹é½
  - æ·»åŠ PostgreSQL 18 I/Oç›‘æ§å¢å¼ºï¼ˆread_bytes/write_bytesåˆ—ï¼‰
  - æ·»åŠ PostgreSQL 18åç«¯I/Oè¿½è¸ªï¼ˆpg_stat_get_backend_io()å‡½æ•°ï¼‰
  - æ·»åŠ PostgreSQL 18 EXPLAINå¢å¼ºï¼ˆå³æ—¶æ€§èƒ½è¯Šæ–­ï¼‰
  - æ·»åŠ PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ªï¼ˆparallel_workers_*åˆ—ï¼‰
  - æ·»åŠ PostgreSQL 18å¼‚æ­¥I/Oæ€§èƒ½ä¼˜åŒ–
  - æ›´æ–°è¯Šæ–­å·¥å…·å¯¹æ¯”çŸ©é˜µ
  - æ›´æ–°æ€§èƒ½ä¼˜åŒ–æ•ˆæœæ•°æ®

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆï¼ˆå·²å¯¹é½PostgreSQL 18æœ€æ–°ç‰¹æ€§ï¼‰
