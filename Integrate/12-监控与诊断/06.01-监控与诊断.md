---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\ç›‘æ§ä¸è¯Šæ–­\06.01-ç›‘æ§ä¸è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç›‘æ§ä¸è¯Šæ–­

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°
> ğŸ†• **PostgreSQL 18ç›‘æ§å¢å¼º**
>
> PostgreSQL 18å¼•å…¥å¤šé¡¹ç›‘æ§æ”¹è¿›ï¼š
>
> - âœ… **æ–°å¢ç³»ç»Ÿè§†å›¾**: å¢å¼ºçš„pg_stat_statementsï¼Œæ–°å¢æ ‡å‡†å·®ç»Ÿè®¡
> - âœ… **æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š**: pg_stat_progress_*è§†å›¾æ›´è¯¦ç»†
> - âœ… **å…±äº«å†…å­˜ç›‘æ§**: æ–°å¢pg_shmem_allocationsè§†å›¾
> - âœ… **æ›´ç»†ç²’åº¦çš„ç­‰å¾…äº‹ä»¶**: æ›´å‡†ç¡®çš„æ€§èƒ½è¯Šæ–­

---

## ğŸ“‹ ç›®å½•

- [ç›‘æ§ä¸è¯Šæ–­](#ç›‘æ§ä¸è¯Šæ–­)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æŒ‡æ ‡ä½“ç³»](#1-æŒ‡æ ‡ä½“ç³»)
    - [1.1 å®ä¾‹çº§æŒ‡æ ‡](#11-å®ä¾‹çº§æŒ‡æ ‡)
    - [1.2 è¡¨/ç´¢å¼•çº§æŒ‡æ ‡](#12-è¡¨ç´¢å¼•çº§æŒ‡æ ‡)
    - [1.3 æŸ¥è¯¢çº§æŒ‡æ ‡](#13-æŸ¥è¯¢çº§æŒ‡æ ‡)
  - [2. PostgreSQL 18æ–°å¢ç›‘æ§ç‰¹æ€§](#2-postgresql-18æ–°å¢ç›‘æ§ç‰¹æ€§)
    - [2.1 å¢å¼ºçš„pg\_stat\_statements](#21-å¢å¼ºçš„pg_stat_statements)
    - [2.2 å…±äº«å†…å­˜ç›‘æ§](#22-å…±äº«å†…å­˜ç›‘æ§)
    - [2.3 æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š](#23-æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š)
  - [3. å¸¸ç”¨è§†å›¾ä¸SQL](#3-å¸¸ç”¨è§†å›¾ä¸sql)
    - [3.1 æ´»è·ƒä¼šè¯ç›‘æ§](#31-æ´»è·ƒä¼šè¯ç›‘æ§)
    - [3.2 é”ä¸ç­‰å¾…](#32-é”ä¸ç­‰å¾…)
    - [3.3 è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨](#33-è¡¨æ‰«æç´¢å¼•ä½¿ç”¨)
    - [3.4 I/Oå‘½ä¸­ç‡](#34-ioå‘½ä¸­ç‡)
    - [3.5 æ…¢æŸ¥è¯¢åˆ†æ](#35-æ…¢æŸ¥è¯¢åˆ†æ)
  - [4. ç›‘æ§å®ç°ï¼ˆPrometheus + Grafanaï¼‰](#4-ç›‘æ§å®ç°prometheus--grafana)
  - [5. è¯Šæ–­æµç¨‹ï¼ˆSOPï¼‰](#5-è¯Šæ–­æµç¨‹sop)
    - [5.1 æ€§èƒ½åŠ£åŒ–è¯Šæ–­æµç¨‹](#51-æ€§èƒ½åŠ£åŒ–è¯Šæ–­æµç¨‹)
    - [5.2 é”ç­‰å¾…/æ­»é”è¯Šæ–­æµç¨‹](#52-é”ç­‰å¾…æ­»é”è¯Šæ–­æµç¨‹)
    - [5.3 è†¨èƒ€/åƒåœ¾è¯Šæ–­æµç¨‹](#53-è†¨èƒ€åƒåœ¾è¯Šæ–­æµç¨‹)
  - [6. ä»ªè¡¨ç›˜å»ºè®®ï¼ˆPrometheus+Grafanaï¼‰](#6-ä»ªè¡¨ç›˜å»ºè®®prometheusgrafana)
    - [6.1 æ¦‚è§ˆä»ªè¡¨æ¿](#61-æ¦‚è§ˆä»ªè¡¨æ¿)
    - [6.2 æŸ¥è¯¢æ€§èƒ½ä»ªè¡¨æ¿](#62-æŸ¥è¯¢æ€§èƒ½ä»ªè¡¨æ¿)
    - [6.3 å­˜å‚¨ä»ªè¡¨æ¿](#63-å­˜å‚¨ä»ªè¡¨æ¿)
    - [6.4 å‘Šè­¦è§„åˆ™](#64-å‘Šè­¦è§„åˆ™)
  - [7. å¸¸è§é—®é¢˜ä¸å¯¹ç­–](#7-å¸¸è§é—®é¢˜ä¸å¯¹ç­–)
    - [7.1 ä¼°ç®—åå·®å¤§](#71-ä¼°ç®—åå·®å¤§)
    - [7.2 ç´¢å¼•æœªå‘½ä¸­](#72-ç´¢å¼•æœªå‘½ä¸­)
    - [7.3 å†™æ”¾å¤§ä¸è†¨èƒ€](#73-å†™æ”¾å¤§ä¸è†¨èƒ€)
  - [8. æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º](#8-æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º)
    - [8.1 å®Œæ•´æ—¥å¿—é…ç½®](#81-å®Œæ•´æ—¥å¿—é…ç½®)
    - [8.2 æ—¥å¿—é‡‡é›†é…ç½®](#82-æ—¥å¿—é‡‡é›†é…ç½®)
    - [8.3 æ…¢SQLå½’ä¸€åŒ–](#83-æ…¢sqlå½’ä¸€åŒ–)
  - [9. äº¤å‰å¼•ç”¨](#9-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [æŸ¥è¯¢ä¸ä¼˜åŒ–](#æŸ¥è¯¢ä¸ä¼˜åŒ–)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [è¡Œä¸šæ¡ˆä¾‹](#è¡Œä¸šæ¡ˆä¾‹)
    - [å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)

---

## 1. æŒ‡æ ‡ä½“ç³»

- å®ä¾‹çº§ï¼šè¿æ¥æ•°ã€äº‹åŠ¡æäº¤/å›æ»šã€ç¼“å†²å‘½ä¸­ç‡ã€WALå†™å…¥é€Ÿç‡ã€æ£€æŸ¥ç‚¹é¢‘ç‡ã€åå°å†™å…¥/æ¸…ç†é˜Ÿåˆ—ã€‚
- è¡¨/ç´¢å¼•çº§ï¼š`seq_scan/idx_scan`ã€è†¨èƒ€ä¸æ­»å…ƒç»„ã€çƒ­ç‚¹å¯¹è±¡ã€I/Oå‘½ä¸­ã€‚
- æŸ¥è¯¢çº§ï¼šè°ƒç”¨æ¬¡æ•°ã€å¹³å‡/TP95/TP99è€—æ—¶ã€è¿”å›è¡Œæ•°ã€å…±äº«å—å‘½ä¸­ç‡ã€‚

### 1.1 å®ä¾‹çº§æŒ‡æ ‡

```sql
-- è¿æ¥æ•°ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹ç›‘æ§è¿æ¥æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') as idle_connections,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_connections
FROM pg_stat_activity
WHERE datname IS NOT NULL
GROUP BY datname;

-- äº‹åŠ¡ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) AS cache_hit_ratio
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1');

-- WALå’Œæ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean
FROM pg_stat_bgwriter;
```

### 1.2 è¡¨/ç´¢å¼•çº§æŒ‡æ ‡

```sql
-- è¡¨æ‰«æç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹è¡¨æ‰«æç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    n_live_tup,
    n_dead_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE seq_scan + idx_scan > 0
ORDER BY seq_scan DESC
LIMIT 20;

-- ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC
LIMIT 20;
```

### 1.3 æŸ¥è¯¢çº§æŒ‡æ ‡

```sql
-- Top SQLç»Ÿè®¡
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

## 2. PostgreSQL 18æ–°å¢ç›‘æ§ç‰¹æ€§

### 2.1 å¢å¼ºçš„pg_stat_statements

```sql
-- PostgreSQL 18+: æ–°å¢æ ‡å‡†å·®ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰

-- åˆ›å»ºæ‰©å±•ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION pg_stat_statements;
            RAISE NOTICE 'æ‰©å±• pg_stat_statements åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pg_stat_statements å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'æ‰©å±• pg_stat_statements å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆå«æ ‡å‡†å·®ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'æ‰©å±• pg_stat_statements ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    query,
    calls,
    mean_exec_time,
    stddev_exec_time,  -- â­ PostgreSQL 17æ–°å¢
    min_exec_time,
    max_exec_time,
    rows,
    shared_blks_hit,
    shared_blks_read,
    -- è®¡ç®—ç¨³å®šæ€§æŒ‡æ ‡
    CASE
        WHEN mean_exec_time > 0
        THEN round((stddev_exec_time / mean_exec_time * 100)::numeric, 2)
        ELSE 0
    END AS cv_percent  -- å˜å¼‚ç³»æ•°ï¼Œè¡¡é‡æŸ¥è¯¢ç¨³å®šæ€§
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;

-- è¯†åˆ«ä¸ç¨³å®šçš„æŸ¥è¯¢ï¼ˆé«˜å˜å¼‚ç³»æ•°ï¼‰
SELECT
    left(query, 60) AS query_preview,
    calls,
    round(mean_exec_time::numeric, 2) AS mean_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,
    round((stddev_exec_time / mean_exec_time * 100)::numeric, 2) AS cv_percent
FROM pg_stat_statements
WHERE calls > 100
  AND mean_exec_time > 10
  AND stddev_exec_time / mean_exec_time > 0.5  -- å˜å¼‚ç³»æ•°>50%
ORDER BY cv_percent DESC
LIMIT 10;
```

### 2.2 å…±äº«å†…å­˜ç›‘æ§

```sql
-- PostgreSQL 18+: ç›‘æ§åŠ¨æ€å…±äº«å†…å­˜ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹ç›‘æ§åŠ¨æ€å…±äº«å†…å­˜ä½¿ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    allocated_size,
    free_size,
    used_size,
    dynamic,
    pg_size_pretty(allocated_size) AS allocated,
    pg_size_pretty(free_size) AS free,
    pg_size_pretty(used_size) AS used,
    round((used_size::float / allocated_size * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
WHERE allocated_size > 0
ORDER BY allocated_size DESC
LIMIT 20;

-- åŠ¨æ€å…±äº«å†…å­˜æ€»è§ˆ
SELECT
    dynamic,
    count(*) AS segment_count,
    pg_size_pretty(sum(allocated_size)) AS total_allocated,
    pg_size_pretty(sum(used_size)) AS total_used,
    round((sum(used_size)::float / sum(allocated_size) * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
GROUP BY dynamic
ORDER BY dynamic;
```

### 2.3 æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š

```sql
-- PostgreSQL 18+: å¢å¼ºçš„VACUUMè¿›åº¦ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹ç›‘æ§VACUUMè¿›åº¦';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples,
    -- è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
    round((heap_blks_scanned::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS scan_progress,
    round((heap_blks_vacuumed::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS vacuum_progress
FROM pg_stat_progress_vacuum
ORDER BY scan_progress DESC;

-- ANALYZEè¿›åº¦ç›‘æ§
SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    sample_blks_total,
    sample_blks_scanned,
    round((sample_blks_scanned::float / NULLIF(sample_blks_total, 0) * 100)::numeric, 2) AS progress
FROM pg_stat_progress_analyze
ORDER BY progress DESC;
```

---

## 3. å¸¸ç”¨è§†å›¾ä¸SQL

### 3.1 æ´»è·ƒä¼šè¯ç›‘æ§

```sql
-- æ´»è·ƒä¼šè¯ï¼ˆPostgreSQL 18å¢å¼ºï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æ´»è·ƒä¼šè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    xact_start,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    state,
    backend_xid,
    backend_xmin,
    left(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state <> 'idle'
ORDER BY
    CASE state
        WHEN 'active' THEN 1
        WHEN 'idle in transaction' THEN 2
        ELSE 3
    END,
    query_start;

-- é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    now() - xact_start AS transaction_duration,
    now() - query_start AS query_duration,
    left(query, 80) AS query_preview
FROM pg_stat_activity
WHERE xact_start IS NOT NULL
  AND state NOT IN ('idle')
ORDER BY xact_start
LIMIT 20;
```

### 3.2 é”ä¸ç­‰å¾…

```sql
-- é”ä¸ç­‰å¾…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹é”ä¸ç­‰å¾…';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid
FROM pg_locks
WHERE NOT granted
ORDER BY relation, pid;

-- é”ç­‰å¾…è¯¦æƒ…ï¼ˆå…³è”ä¼šè¯ä¿¡æ¯ï¼‰
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.3 è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨

```sql
-- è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    n_live_tup,
    n_dead_tup,
    round((n_dead_tup::float / NULLIF(n_live_tup, 0) * 100)::numeric, 2) AS dead_tuple_percent,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY (seq_scan + idx_scan) DESC
LIMIT 20;

-- è¯†åˆ«ç¼ºå°‘ç´¢å¼•çš„è¡¨ï¼ˆé¡ºåºæ‰«æè¿‡å¤šï¼‰
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_live_tup,
    round((seq_scan::float / NULLIF(seq_scan + idx_scan, 0) * 100)::numeric, 2) AS seq_scan_percent
FROM pg_stat_user_tables
WHERE seq_scan > 100
  AND n_live_tup > 1000
  AND seq_scan > idx_scan
ORDER BY seq_scan DESC
LIMIT 10;
```

### 3.4 I/Oå‘½ä¸­ç‡

```sql
-- I/O å‘½ä¸­ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹I/Oå‘½ä¸­ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    relname,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) AS heap_hit_ratio,
    round(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) AS idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 0
ORDER BY heap_hit_ratio ASC NULLS LAST
LIMIT 20;

-- æ•´ä½“ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    round(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2) AS cache_hit_ratio
FROM pg_statio_user_tables;
```

### 3.5 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æ…¢æŸ¥è¯¢ï¼ˆéœ€ pg_stat_statementsï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'æ‰©å±• pg_stat_statements ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢æ…¢æŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æ…¢æŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    left(query, 80) AS query_preview,
    calls,
    round(total_exec_time::numeric, 2) AS total_time_ms,
    round(mean_exec_time::numeric, 2) AS mean_time_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,  -- PG18+
    round(min_exec_time::numeric, 2) AS min_time_ms,
    round(max_exec_time::numeric, 2) AS max_time_ms,
    rows,
    round(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) AS cache_hit_percent
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 4. ç›‘æ§å®ç°ï¼ˆPrometheus + Grafanaï¼‰

- Exporter éƒ¨ç½²ï¼š
  - `postgres_exporter` è¿è¡Œåœ¨æ¯å°å®ä¾‹æ—ï¼Œä½¿ç”¨æœ€å°æƒé™ç›‘æ§ç”¨æˆ·ï¼š

    ```sql
    -- åˆ›å»ºç›‘æ§ä¸“ç”¨ç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    DO $$
    BEGIN
        BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'metrics') THEN
                CREATE ROLE metrics WITH LOGIN PASSWORD '***';
                RAISE NOTICE 'ç›‘æ§ç”¨æˆ· metrics åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE NOTICE 'ç›‘æ§ç”¨æˆ· metrics å·²å­˜åœ¨';
            END IF;
            GRANT pg_monitor TO metrics;
            -- å¦‚éœ€ wal/replication ç»†ç²’åº¦æŒ‡æ ‡
            GRANT pg_read_all_stats TO metrics;
        EXCEPTION
            WHEN duplicate_object THEN
                RAISE NOTICE 'ç›‘æ§ç”¨æˆ· metrics å·²å­˜åœ¨';
            WHEN OTHERS THEN
                RAISE WARNING 'åˆ›å»ºç›‘æ§ç”¨æˆ·å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;
    ```

  - å¯åŠ¨å‚æ•°ç¤ºä¾‹ï¼š

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

- Prometheus æŠ“å–é…ç½®ï¼š

  ```yaml
  scrape_configs:
    - job_name: pg
      scrape_interval: 15s
      static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
  ```

- Grafana é¢æ¿å»ºè®®ï¼š
  - æ¦‚è§ˆï¼šè¿æ¥ã€TPS/QPSã€ç¼“å†²å‘½ä¸­ã€WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€Autovacuumã€é”ç­‰å¾…ã€‚
  - æ˜ç»†ï¼šTop è¡¨ä¸ç´¢å¼•ã€Top æŸ¥è¯¢ã€å¤åˆ¶å»¶è¿Ÿã€ç£ç›˜ I/Oã€CPU ä¸å†…å­˜ã€‚

## 5. è¯Šæ–­æµç¨‹ï¼ˆSOPï¼‰

- æ€§èƒ½åŠ£åŒ–ï¼š
  1) æ£€æŸ¥å®ä¾‹å‹åŠ›ï¼ˆè¿æ¥/CPU/IOï¼‰â†’ 2) æ…¢æŸ¥è¯¢TopN â†’ 3) EXPLAIN ANALYZE å¯¹æ¯”ä¼°ç®—/å®é™…åŸºæ•° â†’ 4) ç´¢å¼•/ç»Ÿè®¡ä¿®å¤ â†’ 5) å¤æµ‹ã€‚
- é”ç­‰å¾…/æ­»é”ï¼š
  1) `pg_locks` ä¸ç­‰å¾…é“¾ â†’ 2) æ‰¾å‡ºæŒé”é•¿äº‹åŠ¡ â†’ 3) è¯„ä¼°ä¸­æ­¢ä¸DDL/äº‹åŠ¡æ‹†åˆ† â†’ 4) é˜²å†å‘ï¼ˆç´¢å¼•/é¡ºåº/æ‰¹é‡ç­–ç•¥ï¼‰ã€‚
- è†¨èƒ€/åƒåœ¾ï¼š
  1) æ­»å…ƒç»„ä¸ `autovacuum` é¢‘æ¬¡ â†’ 2) æå‡ `autovacuum_*` æˆ–ç¦»å³° `VACUUM (FULL)`/é‡å»ºç´¢å¼• â†’ 3) é•¿äº‹åŠ¡æ’æŸ¥ã€‚

### 5.1 æ€§èƒ½åŠ£åŒ–è¯Šæ–­æµç¨‹

**æ­¥éª¤1: æ£€æŸ¥å®ä¾‹å‹åŠ›**:

```sql
-- æ£€æŸ¥è¿æ¥æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM pg_stat_activity;

-- æ£€æŸ¥CPUå’ŒI/Oï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
```

**æ­¥éª¤2: æ…¢æŸ¥è¯¢TopN**:

```sql
-- æ…¢æŸ¥è¯¢TopNï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'æ‰©å±• pg_stat_statements ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢æ…¢æŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æ…¢æŸ¥è¯¢TopN';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

**æ­¥éª¤3: EXPLAIN ANALYZEåˆ†æ**:

```sql
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
-- ç²˜è´´æ…¢æŸ¥è¯¢SQL
```

**æ­¥éª¤4: ç´¢å¼•/ç»Ÿè®¡ä¿®å¤**:

```sql
-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE indexname = 'idx_name'
        ) THEN
            CREATE INDEX CONCURRENTLY idx_name ON table_name(column_name);
            RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        ANALYZE table_name;
        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**æ­¥éª¤5: å¤æµ‹**:

```sql
-- é‡æ–°æ‰§è¡ŒæŸ¥è¯¢å¹¶å¯¹æ¯”æ€§èƒ½
```

### 5.2 é”ç­‰å¾…/æ­»é”è¯Šæ–­æµç¨‹

**æ­¥éª¤1: æŸ¥çœ‹é”ç­‰å¾…é“¾**:

```sql
-- æŸ¥çœ‹é”ç­‰å¾…é“¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹é”ç­‰å¾…é“¾';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**æ­¥éª¤2: æ‰¾å‡ºæŒé”é•¿äº‹åŠ¡**:

```sql
SELECT
    pid,
    usename,
    datname,
    state,
    NOW() - xact_start as transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND NOW() - xact_start > INTERVAL '5 minutes';
```

**æ­¥éª¤3: è¯„ä¼°ä¸­æ­¢ä¸DDL/äº‹åŠ¡æ‹†åˆ†**:

```sql
-- ç»ˆæ­¢é˜»å¡äº‹åŠ¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    blocking_pid_var INTEGER;
BEGIN
    BEGIN
        -- æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶éœ€è¦ä¼ å…¥å…·ä½“çš„blocking_pid
        -- SELECT blocking_pid INTO blocking_pid_var FROM ... LIMIT 1;
        -- IF blocking_pid_var IS NOT NULL THEN
        --     PERFORM pg_terminate_backend(blocking_pid_var);
        --     RAISE NOTICE 'å·²ä¸­æ­¢é˜»å¡äº‹åŠ¡: %', blocking_pid_var;
        -- END IF;
        RAISE NOTICE 'è¯·è°¨æ…ä½¿ç”¨ pg_terminate_backendï¼Œç¡®ä¿ä¼ å…¥æ­£ç¡®çš„è¿›ç¨‹ID';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸­æ­¢äº‹åŠ¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¼˜åŒ–äº‹åŠ¡é€»è¾‘
-- å‡å°‘äº‹åŠ¡æŒæœ‰æ—¶é—´
-- ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”
```

**æ­¥éª¤4: é˜²å†å‘æªæ–½**:

```sql
-- åˆ›å»ºç´¢å¼•å‡å°‘é”ç«äº‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE indexname = 'idx_name'
        ) THEN
            CREATE INDEX CONCURRENTLY idx_name ON table_name(column_name);
            RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è°ƒæ•´é”è¶…æ—¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET lock_timeout = '5s';
        RAISE NOTICE 'é”è¶…æ—¶è®¾ç½®æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®é”è¶…æ—¶å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.3 è†¨èƒ€/åƒåœ¾è¯Šæ–­æµç¨‹

**æ­¥éª¤1: æ£€æŸ¥æ­»å…ƒç»„å’Œautovacuumé¢‘æ¬¡**:

```sql
-- æ£€æŸ¥è¡¨è†¨èƒ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥è¡¨è†¨èƒ€';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_autovacuum,
    NOW() - last_autovacuum as time_since_vacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 20;
```

**æ­¥éª¤2: æå‡autovacuumæˆ–æ‰§è¡ŒVACUUM**:

```sql
-- è°ƒæ•´autovacuumå‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        ALTER TABLE table_name SET (
            autovacuum_vacuum_scale_factor = 0.1,
            autovacuum_analyze_scale_factor = 0.05
        );
        RAISE NOTICE 'autovacuumå‚æ•°è°ƒæ•´æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è°ƒæ•´autovacuumå‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰‹åŠ¨æ‰§è¡ŒVACUUM
VACUUM ANALYZE table_name;

-- é‡å»ºè¡¨ï¼ˆå¦‚æœè†¨èƒ€ä¸¥é‡ï¼‰
CLUSTER table_name USING index_name;
```

**æ­¥éª¤3: é•¿äº‹åŠ¡æ’æŸ¥**:

```sql
SELECT
    pid,
    usename,
    datname,
    state,
    NOW() - xact_start as transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND NOW() - xact_start > INTERVAL '1 hour';
```

## 6. ä»ªè¡¨ç›˜å»ºè®®ï¼ˆPrometheus+Grafanaï¼‰

- é¢æ¿ï¼šè¿æ¥/äº‹åŠ¡ã€å‘½ä¸­ç‡/WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€Autovacuumã€Topè¡¨ä¸ç´¢å¼•ã€TopæŸ¥è¯¢ã€é”ç­‰å¾…çƒ­åŠ›å›¾ã€‚
- å‘Šè­¦ï¼šè¿æ¥æ¥è¿‘ä¸Šé™ã€å‘½ä¸­ç‡éª¤é™ã€WALæš´æ¶¨ã€æ£€æŸ¥ç‚¹é¢‘ç‡å¼‚å¸¸ã€Autovacuumæ»åã€æ­»é”äº‹ä»¶ã€‚

### 6.1 æ¦‚è§ˆä»ªè¡¨æ¿

**å…³é”®æŒ‡æ ‡é¢æ¿**:

```promql
# è¿æ¥æ•°
pg_stat_database_numbackends{datname="postgres"}

# äº‹åŠ¡é€Ÿç‡
rate(pg_stat_database_xact_commit{datname="postgres"}[5m])

# ç¼“å†²å‘½ä¸­ç‡
100 * (
  sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) /
  (sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) +
   sum(rate(pg_stat_database_blks_read{datname="postgres"}[5m])))
)

# WALå†™å…¥é€Ÿç‡
rate(pg_stat_wal_written_bytes[5m])
```

### 6.2 æŸ¥è¯¢æ€§èƒ½ä»ªè¡¨æ¿

**æ…¢æŸ¥è¯¢ç›‘æ§**:

```promql
# Top 10 æ…¢æŸ¥è¯¢
topk(10, pg_stat_statements_mean_exec_time)

# æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
histogram_quantile(0.95, rate(pg_stat_statements_calls[5m]))

# æ…¢æŸ¥è¯¢æ•°é‡
count(pg_stat_statements_mean_exec_time > 1000)
```

### 6.3 å­˜å‚¨ä»ªè¡¨æ¿

**è¡¨å¤§å°å’Œè†¨èƒ€**:

```promql
# æ•°æ®åº“å¤§å°
pg_database_size_bytes{datname="postgres"}

# è¡¨è†¨èƒ€
pg_stat_user_tables_n_dead_tup

# I/Oç»Ÿè®¡
rate(pg_stat_io_reads[5m])
rate(pg_stat_io_writes[5m])
```

### 6.4 å‘Šè­¦è§„åˆ™

```yaml
# prometheus_alerts.yml
groups:
  - name: postgresql_alerts
    rules:
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{datname="postgres"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLé«˜è¿æ¥æ•°å‘Šè­¦"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°: {{ $value }}ï¼Œè¶…è¿‡é˜ˆå€¼80"

      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          100 * (
            sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) /
            (sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) +
             sum(rate(pg_stat_database_blks_read{datname="postgres"}[5m])))
          ) < 95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç¼“å­˜å‘½ä¸­ç‡ä½"
          description: "æ•°æ®åº“ {{ $labels.datname }} ç¼“å­˜å‘½ä¸­ç‡: {{ $value }}%ï¼Œä½äºé˜ˆå€¼95%"
```

## 7. å¸¸è§é—®é¢˜ä¸å¯¹ç­–

- ä¼°ç®—åå·®å¤§ï¼šæé«˜ç»Ÿè®¡ç›®æ ‡ã€æ‰©å±•ç»Ÿè®¡ã€è¡¨è¾¾å¼åˆ—ï¼›
- ç´¢å¼•æœªå‘½ä¸­ï¼šè°“è¯ä¸åŒ¹é…ã€å‡½æ•°æœªå¯ç´¢å¼•åŒ–ã€ç±»å‹éšå¼è½¬æ¢ï¼›
- å†™æ”¾å¤§ä¸è†¨èƒ€ï¼šæ‰¹å†™/åˆå¹¶ã€åˆç† `fillfactor`ã€å†·çƒ­åˆ†å±‚ã€å‘¨æœŸé‡å»ºã€‚

### 7.1 ä¼°ç®—åå·®å¤§

**é—®é¢˜**: æŸ¥è¯¢è®¡åˆ’å™¨å¯¹æ•°æ®åˆ†å¸ƒçš„ä¼°ç®—ä¸å‡†ç¡®ï¼Œå¯¼è‡´é€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. æé«˜ç»Ÿè®¡ç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        ALTER TABLE table_name ALTER COLUMN column_name SET STATISTICS 1000;
        RAISE NOTICE 'ç»Ÿè®¡ç›®æ ‡è®¾ç½®æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        ANALYZE table_name;
        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä½¿ç”¨æ‰©å±•ç»Ÿè®¡
CREATE STATISTICS stats_name ON table_name (column1, column2);

-- 4. è¡¨è¾¾å¼åˆ—ç»Ÿè®¡
CREATE STATISTICS stats_expr ON table_name ((expression(column_name)));
```

### 7.2 ç´¢å¼•æœªå‘½ä¸­

**é—®é¢˜**: æŸ¥è¯¢æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM table_name WHERE column_name = 'value';

-- 2. åˆ›å»ºåŒ¹é…çš„ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE INDEX CONCURRENTLY idx_name ON table_name(column_name);

-- 3. é¿å…å‡½æ•°ç´¢å¼•ï¼ˆå¦‚æœå¯èƒ½ï¼‰
-- é”™è¯¯: WHERE UPPER(column_name) = 'VALUE'
-- æ­£ç¡®: WHERE column_name = 'value' (å¦‚æœæ•°æ®å·²æ ‡å‡†åŒ–)

-- 4. é¿å…ç±»å‹éšå¼è½¬æ¢
-- ç¡®ä¿æŸ¥è¯¢ä¸­çš„ç±»å‹ä¸åˆ—ç±»å‹åŒ¹é…
```

### 7.3 å†™æ”¾å¤§ä¸è†¨èƒ€

**é—®é¢˜**: é¢‘ç¹æ›´æ–°å¯¼è‡´è¡¨è†¨èƒ€ï¼Œå½±å“æ€§èƒ½ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. æ‰¹å†™/åˆå¹¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- ä½¿ç”¨æ‰¹é‡æ’å…¥è€Œä¸æ˜¯å•æ¡æ’å…¥
DO $$
BEGIN
    BEGIN
        INSERT INTO table_name SELECT ... FROM ...;
        RAISE NOTICE 'æ‰¹é‡æ’å…¥æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡æ’å…¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åˆç†fillfactorï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
ALTER TABLE table_name SET (fillfactor = 90);
CLUSTER table_name USING index_name;

-- 3. å†·çƒ­åˆ†å±‚
-- å°†çƒ­æ•°æ®å’Œå†·æ•°æ®åˆ†ç¦»åˆ°ä¸åŒè¡¨

-- 4. å‘¨æœŸé‡å»º
CLUSTER table_name USING index_name;
-- æˆ–
VACUUM FULL table_name;
```

## 8. æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º

- å»ºè®®çš„ `postgresql.conf` æ—¥å¿—å…³é”®é¡¹ï¼š

  ```text
  log_line_prefix = '%m [%p] %u@%d %r %a '
  log_min_duration_statement = 500ms        # ç”Ÿäº§æŒ‰æµé‡ä¸å­˜å‚¨è°ƒèŠ‚
  log_checkpoints = on
  log_autovacuum_min_duration = 1s
  log_lock_waits = on
  track_io_timing = on
  shared_preload_libraries = 'pg_stat_statements,auto_explain'
  auto_explain.log_min_duration = '200ms'
  auto_explain.log_analyze = on
  auto_explain.log_buffers = on
  ```

- æ…¢æ—¥å¿—é‡‡é›†ï¼š
- Filebeat/Vector â†’ Loki/Elasticï¼Œå†åœ¨ Grafana å»ºç«‹æ…¢SQLé¢æ¿ä¸ TopNã€‚
- ç”Ÿæˆ `fingerprint`ï¼ˆæ­£åˆ™å½’ä¸€åŒ–ï¼‰ä¾¿äºèšåˆç»Ÿè®¡ã€‚

### 8.1 å®Œæ•´æ—¥å¿—é…ç½®

```sql
-- postgresql.confå®Œæ•´æ—¥å¿—é…ç½®

-- åŸºæœ¬æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

-- æ—¥å¿—æ ¼å¼
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'Asia/Shanghai'

-- æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500
log_min_messages = warning

-- æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on

-- Autovacuumæ—¥å¿—
log_autovacuum_min_duration = 1s

-- é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

-- I/Oæ—¶é—´è·Ÿè¸ª
track_io_timing = on

-- æ‰©å±•ç»Ÿè®¡
shared_preload_libraries = 'pg_stat_statements,auto_explain'

-- auto_explainé…ç½®
auto_explain.log_min_duration = 200
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_verbose = on
auto_explain.log_format = json
```

### 8.2 æ—¥å¿—é‡‡é›†é…ç½®

**Filebeaté…ç½®**:

```yaml
# filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/lib/postgresql/14/data/log/postgresql-*.log
    fields:
      service: postgresql
      environment: production
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "postgresql-logs-%{+yyyy.MM.dd}"
```

**Vectoré…ç½®**:

```toml
# vector.toml
[sources.postgresql_logs]
type = "file"
include = ["/var/lib/postgresql/14/data/log/postgresql-*.log"]

[transforms.postgresql_parse]
type = "regex_parser"
inputs = ["postgresql_logs"]
field = "message"
patterns = ['^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<pid>\d+)\]: \[(?P<log_level>\w+)\] (?P<message>.*)']

[sinks.loki]
type = "loki"
inputs = ["postgresql_parse"]
endpoint = "http://loki:3100"
```

### 8.3 æ…¢SQLå½’ä¸€åŒ–

```sql
-- åˆ›å»ºæ…¢SQLæŒ‡çº¹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'slow_query_fingerprints') THEN
            CREATE TABLE slow_query_fingerprints (
    fingerprint_id SERIAL PRIMARY KEY,
    normalized_query TEXT UNIQUE,
    first_seen TIMESTAMP DEFAULT NOW(),
    last_seen TIMESTAMP DEFAULT NOW(),
    total_calls BIGINT DEFAULT 0,
    total_time NUMERIC DEFAULT 0,
    avg_time NUMERIC DEFAULT 0,
    max_time NUMERIC DEFAULT 0
);

-- å®šæœŸæ›´æ–°æ…¢SQLæŒ‡çº¹
INSERT INTO slow_query_fingerprints (normalized_query, last_seen, total_calls, total_time, avg_time, max_time)
SELECT
    regexp_replace(
        regexp_replace(query, '\$\d+', '?', 'g'),
        '\d{4}-\d{2}-\d{2}', 'YYYY-MM-DD', 'g'
    ) as normalized_query,
    NOW() as last_seen,
    calls as total_calls,
    total_exec_time as total_time,
    mean_exec_time as avg_time,
    max_exec_time as max_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ON CONFLICT (normalized_query) DO UPDATE
SET
    last_seen = EXCLUDED.last_seen,
    total_calls = slow_query_fingerprints.total_calls + EXCLUDED.total_calls,
    total_time = slow_query_fingerprints.total_time + EXCLUDED.total_time,
    avg_time = (slow_query_fingerprints.total_time + EXCLUDED.total_time) /
               (slow_query_fingerprints.total_calls + EXCLUDED.total_calls),
    max_time = GREATEST(slow_query_fingerprints.max_time, EXCLUDED.max_time);
```

## 9. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### æŸ¥è¯¢ä¸ä¼˜åŒ–

- â­â­â­ [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.03-æ‰§è¡Œè®¡åˆ’/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æŸ¥è¯¢æ€§èƒ½åˆ†æ
- â­â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–åŸºç¡€
- â­â­ [ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.04-ç»Ÿè®¡ä¿¡æ¯/02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ç»Ÿè®¡ä¿¡æ¯ç›‘æ§

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç›‘æ§ï¼ˆåˆ—å­˜å‚¨ç›‘æ§ã€åˆ—å‹ç¼©ç›‘æ§ï¼‰ğŸ†•
- â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](../../01-æ ¸å¿ƒåŸºç¡€/01.02-ç³»ç»Ÿæ¶æ„/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„ç›‘æ§

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­è½åœ°æŒ‡å—](../06.02-ç›‘æ§ä¸è¯Šæ–­è½åœ°æŒ‡å—.md) - ç”Ÿäº§çº§ç›‘æ§å®è·µ
- â­â­ [æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯](../06.03-æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯.md) - å˜æ›´ç®¡ç†

#### è¡Œä¸šæ¡ˆä¾‹

- â­â­â­ [æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - æ€§èƒ½è¯Šæ–­å®è·µæ¡ˆä¾‹

### å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- â­â­â­ [å®æˆ˜æ¡ˆä¾‹](../../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ
