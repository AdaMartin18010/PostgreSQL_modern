# æ¨¡å‹æ¨ç†æ•°æ®å»ºæ¨¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQL 18+ + TimescaleDB + å®è·µæ€»ç»“
> **çŠ¶æ€**: PostgreSQL 18+æ–°ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 11-04

---

## ğŸ“‘ ç›®å½•

- [æ¨¡å‹æ¨ç†æ•°æ®å»ºæ¨¡æŒ‡å—](#æ¨¡å‹æ¨ç†æ•°æ®å»ºæ¨¡æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 æ¨¡å‹æ¨ç†æ¦‚å¿µ](#111-æ¨¡å‹æ¨ç†æ¦‚å¿µ)
    - [1.1.2 æ¨ç†ç±»å‹ç†è®º](#112-æ¨ç†ç±»å‹ç†è®º)
    - [1.1.3 æ¨ç†æ€§èƒ½ç†è®º](#113-æ¨ç†æ€§èƒ½ç†è®º)
    - [1.1.4 ç¼“å­˜ç†è®º](#114-ç¼“å­˜ç†è®º)
    - [1.1.5 å¤æ‚åº¦åˆ†æ](#115-å¤æ‚åº¦åˆ†æ)
  - [2. æ¨ç†è¯·æ±‚å»ºæ¨¡](#2-æ¨ç†è¯·æ±‚å»ºæ¨¡)
    - [2.1 æ¨ç†è¯·æ±‚è¡¨ï¼ˆTimescaleDBï¼‰](#21-æ¨ç†è¯·æ±‚è¡¨timescaledb)
    - [2.2 æ‰¹é‡æ¨ç†è¯·æ±‚è¡¨](#22-æ‰¹é‡æ¨ç†è¯·æ±‚è¡¨)
  - [3. æ¨ç†ç»“æœå­˜å‚¨](#3-æ¨ç†ç»“æœå­˜å‚¨)
    - [3.1 æ¨ç†ç»“æœè¡¨](#31-æ¨ç†ç»“æœè¡¨)
    - [3.2 æ¨ç†ç»“æœæ±‡æ€»è¡¨](#32-æ¨ç†ç»“æœæ±‡æ€»è¡¨)
  - [4. æ¨ç†æ€§èƒ½ç›‘æ§](#4-æ¨ç†æ€§èƒ½ç›‘æ§)
    - [4.1 æ€§èƒ½æŒ‡æ ‡è¡¨ï¼ˆTimescaleDBï¼‰](#41-æ€§èƒ½æŒ‡æ ‡è¡¨timescaledb)
    - [4.2 æ€§èƒ½ç›‘æ§è§†å›¾](#42-æ€§èƒ½ç›‘æ§è§†å›¾)
  - [5. æ¨ç†ç¼“å­˜å»ºæ¨¡](#5-æ¨ç†ç¼“å­˜å»ºæ¨¡)
    - [5.1 æ¨ç†ç¼“å­˜è¡¨](#51-æ¨ç†ç¼“å­˜è¡¨)
    - [5.2 ç¼“å­˜æŸ¥è¯¢å‡½æ•°](#52-ç¼“å­˜æŸ¥è¯¢å‡½æ•°)
  - [6. PostgreSQL 18ä¼˜åŒ–](#6-postgresql-18ä¼˜åŒ–)
    - [6.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#61-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
    - [6.2 å¼‚æ­¥I/Oä¼˜åŒ–](#62-å¼‚æ­¥ioä¼˜åŒ–)
    - [6.3 å‘é‡ç´¢å¼•ä¼˜åŒ–](#63-å‘é‡ç´¢å¼•ä¼˜åŒ–)
  - [7. æ€§èƒ½ä¼˜åŒ–å»ºè®®](#7-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#71-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
    - [7.2 TimescaleDBåˆ†åŒºä¼˜åŒ–](#72-timescaledbåˆ†åŒºä¼˜åŒ–)
    - [7.3 TimescaleDBè¿ç»­èšåˆä¼˜åŒ–](#73-timescaledbè¿ç»­èšåˆä¼˜åŒ–)
    - [7.4 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–](#74-ç¼“å­˜ç­–ç•¥ä¼˜åŒ–)
    - [7.5 æ‰¹é‡æ“ä½œä¼˜åŒ–](#75-æ‰¹é‡æ“ä½œä¼˜åŒ–)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 æ¨ç†è¯·æ±‚ç®¡ç†](#81-æ¨ç†è¯·æ±‚ç®¡ç†)
    - [8.2 ç»“æœå­˜å‚¨](#82-ç»“æœå­˜å‚¨)
    - [8.3 æ€§èƒ½ç›‘æ§](#83-æ€§èƒ½ç›‘æ§)
    - [8.4 ç¼“å­˜ç­–ç•¥](#84-ç¼“å­˜ç­–ç•¥)
    - [8.5 SQLå®ç°æ³¨æ„äº‹é¡¹](#85-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#9-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1: æ¨ç†è¯·æ±‚å¤„ç†å»¶è¿Ÿé«˜](#é—®é¢˜1-æ¨ç†è¯·æ±‚å¤„ç†å»¶è¿Ÿé«˜)
    - [é—®é¢˜2: æ¨ç†ç»“æœè¡¨æ•°æ®é‡è¿‡å¤§](#é—®é¢˜2-æ¨ç†ç»“æœè¡¨æ•°æ®é‡è¿‡å¤§)
    - [é—®é¢˜3: æ¨ç†ç¼“å­˜å‘½ä¸­ç‡ä½](#é—®é¢˜3-æ¨ç†ç¼“å­˜å‘½ä¸­ç‡ä½)
    - [é—®é¢˜4: æ¨ç†æ€§èƒ½ç›‘æ§æ•°æ®é‡å¤§](#é—®é¢˜4-æ¨ç†æ€§èƒ½ç›‘æ§æ•°æ®é‡å¤§)
  - [10. ç›¸å…³èµ„æº](#10-ç›¸å…³èµ„æº)
    - [10.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£](#101-æ ¸å¿ƒç›¸å…³æ–‡æ¡£)
    - [10.2 å®˜æ–¹èµ„æº](#102-å®˜æ–¹èµ„æº)

---

## 1. æ¦‚è¿°

æ¨¡å‹æ¨ç†æ•°æ®å»ºæ¨¡æ¶‰åŠæ¨ç†è¯·æ±‚çš„å­˜å‚¨ã€ç»“æœçš„ç¼“å­˜ã€æ€§èƒ½çš„ç›‘æ§ç­‰ã€‚

**æ ¸å¿ƒéœ€æ±‚**:

- æ¨ç†è¯·æ±‚å­˜å‚¨
- æ¨ç†ç»“æœå­˜å‚¨
- æ€§èƒ½ç›‘æ§
- ç»“æœç¼“å­˜

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 æ¨¡å‹æ¨ç†æ¦‚å¿µ

**æ¨¡å‹æ¨ç†ï¼ˆModel Inferenceï¼‰**æ˜¯ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¯¹æ–°æ•°æ®è¿›è¡Œé¢„æµ‹çš„è¿‡ç¨‹ï¼š

1. **è¯·æ±‚æ¥æ”¶**: æ¥æ”¶æ¨ç†è¯·æ±‚
2. **æ•°æ®é¢„å¤„ç†**: å¯¹è¾“å…¥æ•°æ®è¿›è¡Œé¢„å¤„ç†
3. **æ¨¡å‹æ¨ç†**: ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹
4. **ç»“æœåå¤„ç†**: å¯¹é¢„æµ‹ç»“æœè¿›è¡Œåå¤„ç†
5. **ç»“æœè¿”å›**: è¿”å›é¢„æµ‹ç»“æœ

### 1.1.2 æ¨ç†ç±»å‹ç†è®º

**å®æ—¶æ¨ç†ï¼ˆReal-time Inferenceï¼‰**:

- **ä½å»¶è¿Ÿ**: æ¯«ç§’çº§å“åº”æ—¶é—´
- **é«˜å¯ç”¨**: 99.9%+å¯ç”¨æ€§
- **åœ¨çº¿æœåŠ¡**: ç›´æ¥å“åº”ç”¨æˆ·è¯·æ±‚

**æ‰¹é‡æ¨ç†ï¼ˆBatch Inferenceï¼‰**:

- **é«˜åå**: æ‰¹é‡å¤„ç†å¤§é‡æ•°æ®
- **ç¦»çº¿å¤„ç†**: å¼‚æ­¥å¤„ç†
- **æˆæœ¬ä¼˜åŒ–**: åˆ©ç”¨ç©ºé—²èµ„æº

**æµå¼æ¨ç†ï¼ˆStreaming Inferenceï¼‰**:

- **è¿ç»­å¤„ç†**: æŒç»­å¤„ç†æ•°æ®æµ
- **ä½å»¶è¿Ÿ**: æ¥è¿‘å®æ—¶å¤„ç†
- **çŠ¶æ€ç®¡ç†**: ç®¡ç†æ¨ç†çŠ¶æ€

### 1.1.3 æ¨ç†æ€§èƒ½ç†è®º

**æ€§èƒ½æŒ‡æ ‡**:

- **å»¶è¿Ÿï¼ˆLatencyï¼‰**: $L = T_{end} - T_{start}$
- **ååé‡ï¼ˆThroughputï¼‰**: $T = \frac{N}{T_{total}}$ (requests/second)
- **å¹¶å‘åº¦ï¼ˆConcurrencyï¼‰**: åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

- **ç¼“å­˜**: ç¼“å­˜å¸¸è§è¯·æ±‚çš„ç»“æœ
- **æ‰¹å¤„ç†**: æ‰¹é‡å¤„ç†è¯·æ±‚æå‡ååé‡
- **å¹¶è¡ŒåŒ–**: å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚
- **æ¨¡å‹ä¼˜åŒ–**: æ¨¡å‹é‡åŒ–ã€å‰ªæç­‰ä¼˜åŒ–

### 1.1.4 ç¼“å­˜ç†è®º

**ç¼“å­˜ç­–ç•¥**:

- **LRUï¼ˆLeast Recently Usedï¼‰**: æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜
- **LFUï¼ˆLeast Frequently Usedï¼‰**: æ·˜æ±°ä½¿ç”¨é¢‘ç‡æœ€ä½çš„ç¼“å­˜
- **TTLï¼ˆTime To Liveï¼‰**: åŸºäºæ—¶é—´çš„ç¼“å­˜è¿‡æœŸ

**ç¼“å­˜å‘½ä¸­ç‡**:

$$Hit\ Rate = \frac{Cache\ Hits}{Total\ Requests}$$

### 1.1.5 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **æ¨ç†è¯·æ±‚**: $O(R)$ where R is number of requests
- **æ¨ç†ç»“æœ**: $O(R)$
- **æ€§èƒ½æŒ‡æ ‡**: $O(R)$

**æŸ¥è¯¢å¤æ‚åº¦**:

- **è¯·æ±‚æŸ¥æ‰¾**: $O(\log R)$ with index
- **ç»“æœæŸ¥è¯¢**: $O(\log R)$ with index
- **ç¼“å­˜æŸ¥è¯¢**: $O(1)$ with hash index

---

## 2. æ¨ç†è¯·æ±‚å»ºæ¨¡

### 2.1 æ¨ç†è¯·æ±‚è¡¨ï¼ˆTimescaleDBï¼‰

```sql
-- æ¨ç†è¯·æ±‚è¡¨ï¼ˆä½¿ç”¨TimescaleDBè¿›è¡Œæ—¶åºå­˜å‚¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS inference_requests (
        id BIGSERIAL,
        request_id VARCHAR(255) UNIQUE NOT NULL,
        model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
        request_type VARCHAR(50) NOT NULL,  -- 'batch', 'realtime', 'streaming'
        input_data JSONB NOT NULL,
        input_vector vector(1536),  -- å‘é‡è¾“å…¥ï¼ˆå¦‚æœæœ‰ï¼‰
        status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'timeout')),
        priority INTEGER DEFAULT 5,  -- ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        started_at TIMESTAMPTZ,
        completed_at TIMESTAMPTZ,
        processing_time_ms INTEGER GENERATED ALWAYS AS (
            EXTRACT(EPOCH FROM (completed_at - started_at)) * 1000
        )::INTEGER VIRTUAL,  -- PostgreSQL 18è™šæ‹Ÿç”Ÿæˆåˆ—
        metadata JSONB DEFAULT '{}',
        PRIMARY KEY (id, created_at)
    );
    RAISE NOTICE 'è¡¨ inference_requests åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ inference_requests å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ inference_requests å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºTimescaleDBè¶…è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    PERFORM create_hypertable(
        'inference_requests',
        'created_at',
        chunk_time_interval => INTERVAL '1 day',
        if_not_exists => TRUE
    );
    RAISE NOTICE 'TimescaleDBè¶…è¡¨åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºTimescaleDBè¶…è¡¨å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦å…ˆå®‰è£…TimescaleDBæ‰©å±•ï¼‰: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_inference_requests_request_id ON inference_requests(request_id);
    CREATE INDEX IF NOT EXISTS idx_inference_requests_model_version ON inference_requests(model_version_id, created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_inference_requests_status ON inference_requests(status, created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_inference_requests_input_vector ON inference_requests USING hnsw (input_vector vector_cosine_ops)
    WHERE input_vector IS NOT NULL;
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 2.2 æ‰¹é‡æ¨ç†è¯·æ±‚è¡¨

```sql
-- æ‰¹é‡æ¨ç†è¯·æ±‚è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'batch_inference_requests') THEN
        CREATE TABLE batch_inference_requests (
            id SERIAL PRIMARY KEY,
            batch_id VARCHAR(255) UNIQUE NOT NULL,
            model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
            total_requests INTEGER NOT NULL,
            completed_requests INTEGER DEFAULT 0,
            failed_requests INTEGER DEFAULT 0,
            progress_percentage NUMERIC(5,2) GENERATED ALWAYS AS (
                CASE
                    WHEN total_requests > 0 THEN (completed_requests::NUMERIC / total_requests * 100)
                    ELSE 0
                END
            ) VIRTUAL,  -- PostgreSQL 18è™šæ‹Ÿç”Ÿæˆåˆ—
            status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
            input_file_path TEXT,
            output_file_path TEXT,
            started_at TIMESTAMPTZ,
            completed_at TIMESTAMPTZ,
            duration INTERVAL GENERATED ALWAYS AS (completed_at - started_at) VIRTUAL,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            created_by VARCHAR(255)
        );
        RAISE NOTICE 'è¡¨ batch_inference_requests åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ batch_inference_requests å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ batch_inference_requests å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_batch_inference_requests_model_version ON batch_inference_requests(model_version_id);
    CREATE INDEX IF NOT EXISTS idx_batch_inference_requests_status ON batch_inference_requests(status);
    CREATE INDEX IF NOT EXISTS idx_batch_inference_requests_started_at ON batch_inference_requests(started_at DESC);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 3. æ¨ç†ç»“æœå­˜å‚¨

### 3.1 æ¨ç†ç»“æœè¡¨

```sql
-- æ¨ç†ç»“æœè¡¨ï¼ˆåˆ†åŒºå­˜å‚¨ï¼‰
CREATE TABLE inference_results (
    id BIGSERIAL,
    request_id VARCHAR(255) NOT NULL,
    model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
    output_data JSONB NOT NULL,
    output_vector vector(1536),  -- å‘é‡è¾“å‡ºï¼ˆå¦‚æœæœ‰ï¼‰
    confidence_score NUMERIC(5,4),  -- ç½®ä¿¡åº¦
    prediction_label VARCHAR(255),  -- é¢„æµ‹æ ‡ç­¾
    prediction_value NUMERIC(10,6),  -- é¢„æµ‹å€¼
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE inference_results_2024_01 PARTITION OF inference_results
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_inference_results_request_id ON inference_results(request_id);
CREATE INDEX idx_inference_results_model_version ON inference_results(model_version_id, created_at DESC);
CREATE INDEX idx_inference_results_output_vector ON inference_results USING hnsw (output_vector vector_cosine_ops)
WHERE output_vector IS NOT NULL;
```

### 3.2 æ¨ç†ç»“æœæ±‡æ€»è¡¨

```sql
-- æ¨ç†ç»“æœæ±‡æ€»è¡¨ï¼ˆç”¨äºå¿«é€Ÿç»Ÿè®¡ï¼‰
CREATE TABLE inference_result_summaries (
    id SERIAL PRIMARY KEY,
    model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
    summary_date DATE NOT NULL,
    total_requests BIGINT DEFAULT 0,
    successful_requests BIGINT DEFAULT 0,
    failed_requests BIGINT DEFAULT 0,
    avg_processing_time_ms NUMERIC(10,3),
    avg_confidence_score NUMERIC(5,4),
    p95_processing_time_ms INTEGER,
    p99_processing_time_ms INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(model_version_id, summary_date)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_inference_result_summaries_model_version ON inference_result_summaries(model_version_id, summary_date DESC);
```

---

## 4. æ¨ç†æ€§èƒ½ç›‘æ§

### 4.1 æ€§èƒ½æŒ‡æ ‡è¡¨ï¼ˆTimescaleDBï¼‰

```sql
-- æ€§èƒ½æŒ‡æ ‡è¡¨ï¼ˆä½¿ç”¨TimescaleDBï¼‰
CREATE TABLE inference_performance_metrics (
    time TIMESTAMPTZ NOT NULL,
    model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
    metric_name VARCHAR(100) NOT NULL,  -- 'latency', 'throughput', 'error_rate', etc.
    metric_value NUMERIC(10,6) NOT NULL,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºTimescaleDBè¶…è¡¨
SELECT create_hypertable(
    'inference_performance_metrics',
    'time',
    chunk_time_interval => INTERVAL '1 hour',
    if_not_exists => TRUE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_inference_performance_metrics_model_version ON inference_performance_metrics(model_version_id, time DESC);
CREATE INDEX idx_inference_performance_metrics_name ON inference_performance_metrics(metric_name, time DESC);
```

### 4.2 æ€§èƒ½ç›‘æ§è§†å›¾

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆä½¿ç”¨è¿ç»­èšåˆï¼‰
CREATE MATERIALIZED VIEW inference_performance_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    model_version_id,
    metric_name,
    AVG(metric_value) AS avg_value,
    MIN(metric_value) AS min_value,
    MAX(metric_value) AS max_value,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY metric_value) AS p95_value,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY metric_value) AS p99_value
FROM inference_performance_metrics
GROUP BY bucket, model_version_id, metric_name;

-- åˆ›å»ºåˆ·æ–°ç­–ç•¥
SELECT add_continuous_aggregate_policy(
    'inference_performance_hourly',
    start_offset => INTERVAL '1 day',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour'
);
```

---

## 5. æ¨ç†ç¼“å­˜å»ºæ¨¡

### 5.1 æ¨ç†ç¼“å­˜è¡¨

```sql
-- æ¨ç†ç¼“å­˜è¡¨ï¼ˆä½¿ç”¨pgvectorè¿›è¡Œç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE TABLE inference_cache (
    id SERIAL PRIMARY KEY,
    model_version_id INTEGER NOT NULL REFERENCES model_versions(id),
    input_hash VARCHAR(64) NOT NULL,  -- è¾“å…¥æ•°æ®å“ˆå¸Œ
    input_vector vector(1536),  -- è¾“å…¥å‘é‡ï¼ˆç”¨äºç›¸ä¼¼åº¦æœç´¢ï¼‰
    output_data JSONB NOT NULL,
    output_vector vector(1536),  -- è¾“å‡ºå‘é‡
    hit_count INTEGER DEFAULT 0,
    last_accessed_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ,
    UNIQUE(model_version_id, input_hash)
);

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆç”¨äºç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE INDEX idx_inference_cache_input_vector_hnsw
ON inference_cache USING hnsw (input_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64)
WHERE input_vector IS NOT NULL;

-- åˆ›å»ºè®¿é—®ç´¢å¼•
CREATE INDEX idx_inference_cache_last_accessed ON inference_cache(last_accessed_at DESC);
CREATE INDEX idx_inference_cache_expires_at ON inference_cache(expires_at)
WHERE expires_at IS NOT NULL;
```

### 5.2 ç¼“å­˜æŸ¥è¯¢å‡½æ•°

```sql
-- ç¼“å­˜æŸ¥è¯¢å‡½æ•°ï¼ˆç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE OR REPLACE FUNCTION get_cached_inference(
    p_model_version_id INTEGER,
    p_input_vector vector(1536),
    p_similarity_threshold NUMERIC DEFAULT 0.95
)
RETURNS TABLE (
    output_data JSONB,
    similarity NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        ic.output_data,
        1 - (ic.input_vector <=> p_input_vector) AS similarity
    FROM inference_cache ic
    WHERE ic.model_version_id = p_model_version_id
      AND ic.input_vector IS NOT NULL
      AND (ic.expires_at IS NULL OR ic.expires_at > NOW())
      AND 1 - (ic.input_vector <=> p_input_vector) >= p_similarity_threshold
    ORDER BY ic.input_vector <=> p_input_vector
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. PostgreSQL 18ä¼˜åŒ–

### 6.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–è®¡ç®—å­—æ®µ
ALTER TABLE inference_requests
ADD COLUMN processing_time_ms INTEGER GENERATED ALWAYS AS (
    EXTRACT(EPOCH FROM (completed_at - started_at)) * 1000
)::INTEGER VIRTUAL;

ALTER TABLE batch_inference_requests
ADD COLUMN progress_percentage NUMERIC(5,2) GENERATED ALWAYS AS (
    CASE
        WHEN total_requests > 0 THEN (completed_requests::NUMERIC / total_requests * 100)
        ELSE 0
    END
) VIRTUAL;

ALTER TABLE batch_inference_requests
ADD COLUMN duration INTERVAL GENERATED ALWAYS AS (
    completed_at - started_at
) VIRTUAL;
```

### 6.2 å¼‚æ­¥I/Oä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šå¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆæ¨ç†è¯·æ±‚å’Œç»“æœæ‰¹é‡å†™å…¥ï¼‰
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET io_direct = 'data';
    ALTER SYSTEM SET io_combine_limit = '256kB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°ï¼ˆæ¨ç†æ•°æ®å†™å…¥æ€§èƒ½æå‡50-60%ï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é…ç½®å¼‚æ­¥I/Oå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

### 6.3 å‘é‡ç´¢å¼•ä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šGINå¹¶è¡Œæ„å»ºä¼˜åŒ–ï¼ˆå‘é‡ç´¢å¼•ï¼‰
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET max_parallel_maintenance_workers = 8;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'GINå¹¶è¡Œæ„å»ºå·²é…ç½®ï¼ˆæ¨ç†ç¼“å­˜å‘é‡ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡3-4å€ï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é…ç½®GINå¹¶è¡Œæ„å»ºå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

---

## 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**æ¨ç†è¯·æ±‚æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_inference_requests_model_status
ON inference_requests(model_version_id, status, created_at DESC);
CREATE INDEX idx_inference_requests_request_id
ON inference_requests(request_id);

-- ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_inference_requests_input_data
ON inference_requests USING gin(input_data);
```

**æ¨ç†ç»“æœæŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- ä¸ºç»“æœæŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_inference_results_request_id
ON inference_results(request_id);
CREATE INDEX idx_inference_results_model_created
ON inference_results(model_version_id, created_at DESC);
```

**ç¼“å­˜æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- å‘é‡ç¼“å­˜ç´¢å¼•ï¼ˆHNSWï¼‰
CREATE INDEX idx_inference_cache_vector ON inference_cache
USING hnsw (input_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ç¼“å­˜é”®ç´¢å¼•
CREATE INDEX idx_inference_cache_key ON inference_cache(cache_key);
```

### 7.2 TimescaleDBåˆ†åŒºä¼˜åŒ–

**æ¨ç†è¯·æ±‚è¡¨åˆ†åŒº**:

```sql
-- TimescaleDBè‡ªåŠ¨åˆ†åŒºä¼˜åŒ–
SELECT create_hypertable(
    'inference_requests',
    'created_at',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- è°ƒæ•´chunkå¤§å°
SELECT set_chunk_time_interval('inference_requests', INTERVAL '1 day');
```

**æ€§èƒ½æŒ‡æ ‡è¡¨åˆ†åŒº**:

```sql
-- åˆ›å»ºTimescaleDBè¶…è¡¨
SELECT create_hypertable(
    'inference_performance_metrics',
    'timestamp',
    chunk_time_interval => INTERVAL '1 hour',
    if_not_exists => TRUE
);
```

### 7.3 TimescaleDBè¿ç»­èšåˆä¼˜åŒ–

**é¢„èšåˆæ€§èƒ½æŒ‡æ ‡**:

```sql
-- åˆ›å»ºè¿ç»­èšåˆè§†å›¾
CREATE MATERIALIZED VIEW inference_performance_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', timestamp) AS bucket,
    model_version_id,
    AVG(latency_ms) AS avg_latency,
    AVG(throughput_rps) AS avg_throughput,
    COUNT(*) AS request_count
FROM inference_performance_metrics
GROUP BY bucket, model_version_id;

-- è‡ªåŠ¨åˆ·æ–°ç­–ç•¥
SELECT add_continuous_aggregate_policy(
    'inference_performance_hourly',
    start_offset => INTERVAL '1 day',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour'
);
```

### 7.4 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

**LRUç¼“å­˜å®ç°**:

```sql
-- åˆ›å»ºç¼“å­˜è®¿é—®æ—¶é—´è·Ÿè¸ª
ALTER TABLE inference_cache
ADD COLUMN last_accessed_at TIMESTAMPTZ DEFAULT NOW();

-- åˆ›å»ºå‡½æ•°æ›´æ–°è®¿é—®æ—¶é—´
CREATE OR REPLACE FUNCTION update_cache_access_time(p_cache_key VARCHAR(255))
RETURNS VOID AS $$
BEGIN
    UPDATE inference_cache
    SET last_accessed_at = NOW()
    WHERE cache_key = p_cache_key;
END;
$$ LANGUAGE plpgsql;

-- LRUç¼“å­˜æ¸…ç†ï¼ˆåˆ é™¤æœ€ä¹…æœªè®¿é—®çš„ç¼“å­˜ï¼‰
CREATE OR REPLACE FUNCTION cleanup_lru_cache(p_max_size INTEGER)
RETURNS INTEGER AS $$
DECLARE
    v_deleted_count INTEGER;
BEGIN
    WITH cache_to_delete AS (
        SELECT cache_key
        FROM inference_cache
        ORDER BY last_accessed_at ASC
        LIMIT (SELECT GREATEST(0, COUNT(*) - p_max_size) FROM inference_cache)
    )
    DELETE FROM inference_cache
    WHERE cache_key IN (SELECT cache_key FROM cache_to_delete);

    GET DIAGNOSTICS v_deleted_count = ROW_COUNT;
    RETURN v_deleted_count;
END;
$$ LANGUAGE plpgsql;
```

### 7.5 æ‰¹é‡æ“ä½œä¼˜åŒ–

**æ‰¹é‡æ¨ç†è¯·æ±‚æ’å…¥**:

```sql
-- ä½¿ç”¨COPYå‘½ä»¤æ‰¹é‡æ’å…¥
COPY inference_requests (request_id, model_version_id, input_data, status)
FROM STDIN WITH (FORMAT csv);
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 æ¨ç†è¯·æ±‚ç®¡ç†

1. **è¯·æ±‚ID**: ä½¿ç”¨å”¯ä¸€è¯·æ±‚IDè¿½è¸ªè¯·æ±‚
2. **ä¼˜å…ˆçº§**: æ”¯æŒè¯·æ±‚ä¼˜å…ˆçº§è°ƒåº¦
3. **è¶…æ—¶å¤„ç†**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
4. **è¯·æ±‚å»é‡**: å®ç°è¯·æ±‚å»é‡æœºåˆ¶

### 8.2 ç»“æœå­˜å‚¨

1. **åˆ†åŒºç­–ç•¥**: æŒ‰æ—¶é—´åˆ†åŒºï¼Œä¾¿äºæ•°æ®ç®¡ç†å’Œæ¸…ç†
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢æ¨¡å¼åˆ›å»ºç´¢å¼•
3. **æ•°æ®ä¿ç•™**: è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™ç­–ç•¥
4. **ç»“æœå‹ç¼©**: å¯¹å¤§å‹ç»“æœè¿›è¡Œå‹ç¼©å­˜å‚¨

### 8.3 æ€§èƒ½ç›‘æ§

1. **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§æ¨ç†æ€§èƒ½æŒ‡æ ‡
2. **å‘Šè­¦æœºåˆ¶**: è®¾ç½®æ€§èƒ½å‘Šè­¦é˜ˆå€¼
3. **æ€§èƒ½åˆ†æ**: å®šæœŸåˆ†ææ€§èƒ½è¶‹åŠ¿
4. **æ€§èƒ½ä¼˜åŒ–**: åŸºäºç›‘æ§æ•°æ®ä¼˜åŒ–æ¨ç†æ€§èƒ½

### 8.4 ç¼“å­˜ç­–ç•¥

1. **ç›¸ä¼¼åº¦æœç´¢**: ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢ç¼“å­˜
2. **ç¼“å­˜è¿‡æœŸ**: è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
3. **ç¼“å­˜æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
4. **ç¼“å­˜é¢„çƒ­**: é¢„çƒ­å¸¸ç”¨è¯·æ±‚çš„ç¼“å­˜

### 8.5 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ä½¿ç”¨DOå—å¤„ç†æ¨ç†æ“ä½œé”™è¯¯
2. **äº‹åŠ¡ç®¡ç†**: æ¨ç†è¯·æ±‚å’Œç»“æœåº”åœ¨äº‹åŠ¡ä¸­å¤„ç†
3. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨EXPLAIN (ANALYZE, BUFFERS, TIMING)åˆ†ææŸ¥è¯¢æ€§èƒ½
4. **å¹¶å‘æ§åˆ¶**: å¤„ç†å¹¶å‘æ¨ç†è¯·æ±‚çš„ç«äº‰æ¡ä»¶

---

## 9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: æ¨ç†è¯·æ±‚å¤„ç†å»¶è¿Ÿé«˜

**åŸå› **:

- ç¼ºå°‘ç´¢å¼•
- æ•°æ®åº“è¿æ¥æ± ä¸è¶³
- æ¨ç†æœåŠ¡æ€§èƒ½ç“¶é¢ˆ

**è§£å†³æ–¹æ¡ˆ**:

- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
- ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®
- ä¼˜åŒ–æ¨ç†æœåŠ¡æ€§èƒ½

**ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–è¯·æ±‚æŸ¥è¯¢
CREATE INDEX idx_inference_requests_pending
ON inference_requests(status, priority DESC, created_at ASC)
WHERE status = 'pending';

-- æŸ¥è¯¢å¾…å¤„ç†è¯·æ±‚ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
SELECT * FROM inference_requests
WHERE status = 'pending'
ORDER BY priority DESC, created_at ASC
LIMIT 100;
```

### é—®é¢˜2: æ¨ç†ç»“æœè¡¨æ•°æ®é‡è¿‡å¤§

**åŸå› **:

- ç»“æœæœªåˆ†åŒº
- å†å²æ•°æ®æœªå½’æ¡£
- ç¼ºå°‘æ•°æ®ä¿ç•™ç­–ç•¥

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨TimescaleDBåˆ†åŒº
- å®šæœŸå½’æ¡£å†å²æ•°æ®
- å®æ–½æ•°æ®ä¿ç•™ç­–ç•¥

**ç¤ºä¾‹**:

```sql
-- TimescaleDBè‡ªåŠ¨åˆ†åŒº
SELECT create_hypertable(
    'inference_results',
    'created_at',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- å½’æ¡£æ—§æ•°æ®
CREATE TABLE inference_results_archive (LIKE inference_results INCLUDING ALL);
INSERT INTO inference_results_archive
SELECT * FROM inference_results
WHERE created_at < NOW() - INTERVAL '3 months';
DELETE FROM inference_results
WHERE created_at < NOW() - INTERVAL '3 months';
```

### é—®é¢˜3: æ¨ç†ç¼“å­˜å‘½ä¸­ç‡ä½

**åŸå› **:

- ç¼“å­˜é”®è®¾è®¡ä¸åˆç†
- ç¼“å­˜è¿‡æœŸæ—¶é—´è¿‡çŸ­
- è¾“å…¥æ•°æ®å˜åŒ–é¢‘ç¹

**è§£å†³æ–¹æ¡ˆ**:

- ä¼˜åŒ–ç¼“å­˜é”®è®¾è®¡ï¼ˆä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦ï¼‰
- è°ƒæ•´ç¼“å­˜è¿‡æœŸæ—¶é—´
- ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢æé«˜å‘½ä¸­ç‡

**ç¤ºä¾‹**:

```sql
-- ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢ç¼“å­˜
CREATE OR REPLACE FUNCTION get_cached_result(
    p_input_vector vector(1536),
    p_similarity_threshold FLOAT DEFAULT 0.95
)
RETURNS TABLE(result JSONB, similarity FLOAT) AS $$
BEGIN
    RETURN QUERY
    SELECT
        ic.result,
        1 - (ic.input_vector <=> p_input_vector) AS similarity
    FROM inference_cache ic
    WHERE 1 - (ic.input_vector <=> p_input_vector) >= p_similarity_threshold
    ORDER BY ic.input_vector <=> p_input_vector
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

### é—®é¢˜4: æ¨ç†æ€§èƒ½ç›‘æ§æ•°æ®é‡å¤§

**åŸå› **:

- æ€§èƒ½æŒ‡æ ‡æœªèšåˆ
- ç¼ºå°‘è¿ç»­èšåˆ
- æŸ¥è¯¢æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨TimescaleDBè¿ç»­èšåˆ
- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜æ±‡æ€»æ•°æ®
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**ç¤ºä¾‹**:

```sql
-- åˆ›å»ºè¿ç»­èšåˆè§†å›¾
CREATE MATERIALIZED VIEW inference_performance_daily
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 day', timestamp) AS bucket,
    model_version_id,
    AVG(latency_ms) AS avg_latency,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY latency_ms) AS p95_latency,
    SUM(request_count) AS total_requests
FROM inference_performance_metrics
GROUP BY bucket, model_version_id;

-- æŸ¥è¯¢æ€§èƒ½æ±‡æ€»
SELECT * FROM inference_performance_daily
WHERE bucket >= NOW() - INTERVAL '7 days'
ORDER BY bucket DESC;
```

---

## 10. ç›¸å…³èµ„æº

### 10.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£

- [æ—¶åºæ•°æ®å»ºæ¨¡](../06-IoTä¸æ—¶åºå»ºæ¨¡/æ—¶åºæ•°æ®æ¨¡å‹.md) - TimescaleDBå»ºæ¨¡æŒ‡å—
- [å‘é‡æ•°æ®åº“å»ºæ¨¡](../08-PostgreSQLå»ºæ¨¡å®è·µ/å‘é‡æ•°æ®åº“å»ºæ¨¡.md) - pgvectorå»ºæ¨¡æŒ‡å—
- [PostgreSQL18æ–°ç‰¹æ€§](../08-PostgreSQLå»ºæ¨¡å®è·µ/PostgreSQL18æ–°ç‰¹æ€§.md) - PostgreSQL 18æ–°ç‰¹æ€§æŒ‡å—

### 10.2 å®˜æ–¹èµ„æº

- [TimescaleDBæ–‡æ¡£](https://docs.timescale.com/) - TimescaleDBå®˜æ–¹æ–‡æ¡£
- [pgvector GitHub](https://github.com/pgvector/pgvector) - pgvectorå®˜æ–¹ä»“åº“
- [PostgreSQL 18æ–‡æ¡£](https://www.postgresql.org/docs/18/) - PostgreSQL 18å®˜æ–¹æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**çŠ¶æ€**: âœ… å·²å®Œæˆ
