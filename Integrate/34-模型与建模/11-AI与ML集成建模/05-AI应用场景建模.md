# AIåº”ç”¨åœºæ™¯å»ºæ¨¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQL 18+ + pgvector + TimescaleDB + å®è·µæ€»ç»“
> **çŠ¶æ€**: PostgreSQL 18+æ–°ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 11-05

---

## ğŸ“‘ ç›®å½•

- [AIåº”ç”¨åœºæ™¯å»ºæ¨¡æŒ‡å—](#aiåº”ç”¨åœºæ™¯å»ºæ¨¡æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç†è®º](#111-ragæ£€ç´¢å¢å¼ºç”Ÿæˆç†è®º)
    - [1.1.2 æ¨èç³»ç»Ÿç†è®º](#112-æ¨èç³»ç»Ÿç†è®º)
    - [1.1.3 è¯­ä¹‰æœç´¢ç†è®º](#113-è¯­ä¹‰æœç´¢ç†è®º)
    - [1.1.4 çŸ¥è¯†å›¾è°±ç†è®º](#114-çŸ¥è¯†å›¾è°±ç†è®º)
    - [1.1.5 å¤æ‚åº¦åˆ†æ](#115-å¤æ‚åº¦åˆ†æ)
  - [2. RAGåº”ç”¨å»ºæ¨¡](#2-ragåº”ç”¨å»ºæ¨¡)
    - [2.1 æ–‡æ¡£å­˜å‚¨å’Œå‘é‡åŒ–](#21-æ–‡æ¡£å­˜å‚¨å’Œå‘é‡åŒ–)
    - [2.2 RAGæ£€ç´¢å‡½æ•°](#22-ragæ£€ç´¢å‡½æ•°)
  - [3. æ¨èç³»ç»Ÿå»ºæ¨¡](#3-æ¨èç³»ç»Ÿå»ºæ¨¡)
    - [3.1 ç”¨æˆ·å’Œç‰©å“è¡¨](#31-ç”¨æˆ·å’Œç‰©å“è¡¨)
    - [3.2 ç”¨æˆ·è¡Œä¸ºè¡¨ï¼ˆTimescaleDBï¼‰](#32-ç”¨æˆ·è¡Œä¸ºè¡¨timescaledb)
    - [3.3 æ¨èå‡½æ•°](#33-æ¨èå‡½æ•°)
  - [4. è¯­ä¹‰æœç´¢å»ºæ¨¡](#4-è¯­ä¹‰æœç´¢å»ºæ¨¡)
    - [4.1 æœç´¢å†…å®¹è¡¨](#41-æœç´¢å†…å®¹è¡¨)
    - [4.2 è¯­ä¹‰æœç´¢å‡½æ•°](#42-è¯­ä¹‰æœç´¢å‡½æ•°)
  - [5. çŸ¥è¯†å›¾è°±åº”ç”¨å»ºæ¨¡](#5-çŸ¥è¯†å›¾è°±åº”ç”¨å»ºæ¨¡)
    - [5.1 å®ä½“å’Œå…³ç³»è¡¨](#51-å®ä½“å’Œå…³ç³»è¡¨)
    - [5.2 çŸ¥è¯†å›¾è°±æŸ¥è¯¢å‡½æ•°](#52-çŸ¥è¯†å›¾è°±æŸ¥è¯¢å‡½æ•°)
  - [6. PostgreSQL 18ä¼˜åŒ–](#6-postgresql-18ä¼˜åŒ–)
    - [6.1 å¼‚æ­¥I/Oä¼˜åŒ–](#61-å¼‚æ­¥ioä¼˜åŒ–)
    - [6.2 GINå¹¶è¡Œæ„å»ºä¼˜åŒ–](#62-ginå¹¶è¡Œæ„å»ºä¼˜åŒ–)
    - [6.3 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#63-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
  - [7. æ€§èƒ½ä¼˜åŒ–å»ºè®®](#7-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.1 RAGåº”ç”¨ä¼˜åŒ–](#71-ragåº”ç”¨ä¼˜åŒ–)
    - [7.2 æ¨èç³»ç»Ÿä¼˜åŒ–](#72-æ¨èç³»ç»Ÿä¼˜åŒ–)
    - [7.3 è¯­ä¹‰æœç´¢ä¼˜åŒ–](#73-è¯­ä¹‰æœç´¢ä¼˜åŒ–)
    - [7.4 çŸ¥è¯†å›¾è°±ä¼˜åŒ–](#74-çŸ¥è¯†å›¾è°±ä¼˜åŒ–)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 RAGåº”ç”¨](#81-ragåº”ç”¨)
    - [8.2 æ¨èç³»ç»Ÿ](#82-æ¨èç³»ç»Ÿ)
    - [8.3 è¯­ä¹‰æœç´¢](#83-è¯­ä¹‰æœç´¢)
    - [8.4 çŸ¥è¯†å›¾è°±](#84-çŸ¥è¯†å›¾è°±)
    - [8.5 SQLå®ç°æ³¨æ„äº‹é¡¹](#85-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#9-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1: RAGæ£€ç´¢å»¶è¿Ÿé«˜](#é—®é¢˜1-ragæ£€ç´¢å»¶è¿Ÿé«˜)
    - [é—®é¢˜2: æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜](#é—®é¢˜2-æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜)
    - [é—®é¢˜3: è¯­ä¹‰æœç´¢ç»“æœä¸å‡†ç¡®](#é—®é¢˜3-è¯­ä¹‰æœç´¢ç»“æœä¸å‡†ç¡®)
    - [é—®é¢˜4: çŸ¥è¯†å›¾è°±æŸ¥è¯¢æ€§èƒ½å·®](#é—®é¢˜4-çŸ¥è¯†å›¾è°±æŸ¥è¯¢æ€§èƒ½å·®)
  - [10. ç›¸å…³èµ„æº](#10-ç›¸å…³èµ„æº)
    - [10.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£](#101-æ ¸å¿ƒç›¸å…³æ–‡æ¡£)
    - [10.2 å®˜æ–¹èµ„æº](#102-å®˜æ–¹èµ„æº)

---

## 1. æ¦‚è¿°

æœ¬æŒ‡å—æ¶µç›–PostgreSQLåœ¨å¸¸è§AIåº”ç”¨åœºæ™¯ä¸­çš„æ•°æ®å»ºæ¨¡å®è·µï¼ŒåŒ…æ‹¬RAGã€æ¨èç³»ç»Ÿã€è¯­ä¹‰æœç´¢ã€çŸ¥è¯†å›¾è°±ç­‰ã€‚

**æ ¸å¿ƒåœºæ™¯**:

- RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åº”ç”¨
- æ¨èç³»ç»Ÿ
- è¯­ä¹‰æœç´¢
- çŸ¥è¯†å›¾è°±åº”ç”¨

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç†è®º

**RAGæ¶æ„**ç»“åˆäº†æ£€ç´¢å’Œç”Ÿæˆä¸¤ä¸ªé˜¶æ®µï¼š

1. **æ£€ç´¢é˜¶æ®µ**: ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£
2. **ç”Ÿæˆé˜¶æ®µ**: åŸºäºæ£€ç´¢åˆ°çš„æ–‡æ¡£ç”Ÿæˆå›ç­”

**æ£€ç´¢ç­–ç•¥**:

- **å‘é‡æ£€ç´¢**: ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢ç›¸å…³æ–‡æ¡£
- **æ··åˆæ£€ç´¢**: ç»“åˆå‘é‡æ£€ç´¢å’Œå…¨æ–‡æœç´¢
- **é‡æ’åº**: ä½¿ç”¨ä¸šåŠ¡è§„åˆ™å¯¹ç»“æœé‡æ’åº

**ç›¸ä¼¼åº¦è®¡ç®—**:

- **ä½™å¼¦ç›¸ä¼¼åº¦**: $\text{cos}(\theta) = \frac{\mathbf{A} \cdot \mathbf{B}}{||\mathbf{A}|| \times ||\mathbf{B}||}$
- **æ¬§æ°è·ç¦»**: $d = ||\mathbf{A} - \mathbf{B}||_2$
- **ç‚¹ç§¯**: $\mathbf{A} \cdot \mathbf{B}$

### 1.1.2 æ¨èç³»ç»Ÿç†è®º

**æ¨èç®—æ³•**:

1. **ååŒè¿‡æ»¤ï¼ˆCollaborative Filteringï¼‰**:
   - **ç”¨æˆ·ååŒè¿‡æ»¤**: åŸºäºç›¸ä¼¼ç”¨æˆ·çš„åå¥½æ¨è
   - **ç‰©å“ååŒè¿‡æ»¤**: åŸºäºç›¸ä¼¼ç‰©å“æ¨è

2. **å†…å®¹æ¨èï¼ˆContent-Basedï¼‰**:
   - åŸºäºç‰©å“ç‰¹å¾æ¨è
   - åŸºäºç”¨æˆ·ç”»åƒæ¨è

3. **æ··åˆæ¨èï¼ˆHybridï¼‰**:
   - ç»“åˆå¤šç§æ¨èç­–ç•¥
   - åŠ æƒèåˆæ¨èç»“æœ

**ç›¸ä¼¼åº¦è®¡ç®—**:

- **ä½™å¼¦ç›¸ä¼¼åº¦**: $\text{cos}(\theta) = \frac{\sum_{i} u_i v_i}{\sqrt{\sum_{i} u_i^2} \sqrt{\sum_{i} v_i^2}}$
- **çš®å°”é€Šç›¸å…³ç³»æ•°**: $r = \frac{\sum_{i}(u_i - \bar{u})(v_i - \bar{v})}{\sqrt{\sum_{i}(u_i - \bar{u})^2}\sqrt{\sum_{i}(v_i - \bar{v})^2}}$

### 1.1.3 è¯­ä¹‰æœç´¢ç†è®º

**è¯­ä¹‰æœç´¢**ä½¿ç”¨å‘é‡è¡¨ç¤ºç†è§£æŸ¥è¯¢å’Œæ–‡æ¡£çš„è¯­ä¹‰ï¼š

- **æŸ¥è¯¢å‘é‡åŒ–**: å°†æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡
- **æ–‡æ¡£å‘é‡åŒ–**: å°†æ–‡æ¡£è½¬æ¢ä¸ºå‘é‡
- **ç›¸ä¼¼åº¦æœç´¢**: ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢ç›¸å…³æ–‡æ¡£

**å‘é‡åŒ–æ–¹æ³•**:

- **è¯åµŒå…¥ï¼ˆWord Embeddingsï¼‰**: Word2Vecã€GloVe
- **å¥å­åµŒå…¥ï¼ˆSentence Embeddingsï¼‰**: BERTã€Sentence-BERT
- **æ–‡æ¡£åµŒå…¥ï¼ˆDocument Embeddingsï¼‰**: Doc2Vec

### 1.1.4 çŸ¥è¯†å›¾è°±ç†è®º

**çŸ¥è¯†å›¾è°±**æ˜¯ç»“æ„åŒ–çš„çŸ¥è¯†è¡¨ç¤ºï¼š

- **å®ä½“ï¼ˆEntityï¼‰**: å›¾ä¸­çš„èŠ‚ç‚¹
- **å…³ç³»ï¼ˆRelationï¼‰**: å›¾ä¸­çš„è¾¹
- **å±æ€§ï¼ˆPropertyï¼‰**: å®ä½“å’Œå…³ç³»çš„å±æ€§

**å›¾æŸ¥è¯¢**:

- **è·¯å¾„æŸ¥è¯¢**: æŸ¥æ‰¾å®ä½“é—´çš„è·¯å¾„
- **æ¨¡å¼åŒ¹é…**: åŒ¹é…å›¾æ¨¡å¼
- **å›¾ç®—æ³•**: PageRankã€ç¤¾åŒºæ£€æµ‹ç­‰

### 1.1.5 å¤æ‚åº¦åˆ†æ

**RAGæ£€ç´¢å¤æ‚åº¦**:

- **å‘é‡ç´¢å¼•æ„å»º**: $O(N \log N)$ (HNSW)
- **å‘é‡æœç´¢**: $O(\log N)$ (è¿‘ä¼¼æœ€è¿‘é‚»)
- **é‡æ’åº**: $O(K)$ (Kä¸ºå€™é€‰æ•°é‡)

**æ¨èç³»ç»Ÿå¤æ‚åº¦**:

- **ç”¨æˆ·ç›¸ä¼¼åº¦è®¡ç®—**: $O(U^2)$ (Uä¸ºç”¨æˆ·æ•°)
- **ç‰©å“ç›¸ä¼¼åº¦è®¡ç®—**: $O(I^2)$ (Iä¸ºç‰©å“æ•°)
- **æ¨èç”Ÿæˆ**: $O(U \times I)$

---

## 2. RAGåº”ç”¨å»ºæ¨¡

### 2.1 æ–‡æ¡£å­˜å‚¨å’Œå‘é‡åŒ–

```sql
-- æ–‡æ¡£è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'documents') THEN
        CREATE TABLE documents (
            id SERIAL PRIMARY KEY,
            document_id VARCHAR(255) UNIQUE NOT NULL,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            content_type VARCHAR(50),  -- 'text', 'markdown', 'pdf', etc.
            source_url TEXT,
            metadata JSONB DEFAULT '{}',
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ documents åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ documents å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ documents å¤±è´¥: %', SQLERRM;
END $$;

-- æ–‡æ¡£åˆ†å—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'document_chunks') THEN
        CREATE TABLE document_chunks (
            id SERIAL PRIMARY KEY,
            document_id VARCHAR(255) NOT NULL REFERENCES documents(document_id),
            chunk_index INTEGER NOT NULL,
            chunk_text TEXT NOT NULL,
            embedding vector(1536) NOT NULL,  -- OpenAI text-embedding-3-large
            token_count INTEGER,
            metadata JSONB DEFAULT '{}',
            created_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE(document_id, chunk_index)
        );
        RAISE NOTICE 'è¡¨ document_chunks åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ document_chunks å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ document_chunks å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ document_chunks å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆHNSWï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_document_chunks_embedding_hnsw
    ON document_chunks USING hnsw (embedding vector_cosine_ops)
    WITH (m = 16, ef_construction = 64);
    RAISE NOTICE 'å‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºå‘é‡ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQL 18 GINå¹¶è¡Œæ„å»ºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_document_chunks_text_gin
    ON document_chunks USING GIN (to_tsvector('english', chunk_text));
    RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºæ–‡æ¡£ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_document_chunks_document_id ON document_chunks(document_id);
    RAISE NOTICE 'æ–‡æ¡£ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºæ–‡æ¡£ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 2.2 RAGæ£€ç´¢å‡½æ•°

```sql
-- RAGæ£€ç´¢å‡½æ•°ï¼ˆå‘é‡ç›¸ä¼¼åº¦ + å…¨æ–‡æœç´¢ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION rag_retrieve(
    query_embedding vector(1536),
    query_text TEXT,
    top_k INTEGER DEFAULT 10,
    similarity_threshold FLOAT DEFAULT 0.7
)
RETURNS TABLE (
    chunk_id INTEGER,
    document_id VARCHAR(255),
    chunk_text TEXT,
    similarity FLOAT,
    text_rank FLOAT,
    combined_score FLOAT
) AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF query_embedding IS NULL THEN
        RAISE EXCEPTION 'query_embeddingä¸èƒ½ä¸ºNULL';
    END IF;
    IF query_text IS NULL OR query_text = '' THEN
        RAISE EXCEPTION 'query_textä¸èƒ½ä¸ºç©º';
    END IF;
    IF top_k <= 0 OR top_k > 100 THEN
        RAISE EXCEPTION 'top_kå¿…é¡»åœ¨1-100ä¹‹é—´';
    END IF;

    RETURN QUERY
    WITH vector_results AS (
        SELECT
            dc.id,
            dc.document_id,
            dc.chunk_text,
            1 - (dc.embedding <=> query_embedding) AS similarity
        FROM document_chunks dc
        WHERE 1 - (dc.embedding <=> query_embedding) >= similarity_threshold
        ORDER BY dc.embedding <=> query_embedding
        LIMIT top_k * 2
    ),
    text_results AS (
        SELECT
            dc.id,
            dc.document_id,
            dc.chunk_text,
            ts_rank(to_tsvector('english', dc.chunk_text), plainto_tsquery('english', query_text)) AS text_rank
        FROM document_chunks dc
        WHERE to_tsvector('english', dc.chunk_text) @@ plainto_tsquery('english', query_text)
        ORDER BY text_rank DESC
        LIMIT top_k * 2
    )
    SELECT
        COALESCE(v.id, t.id) AS chunk_id,
        COALESCE(v.document_id, t.document_id) AS document_id,
        COALESCE(v.chunk_text, t.chunk_text) AS chunk_text,
        COALESCE(v.similarity, 0) AS similarity,
        COALESCE(t.text_rank, 0) AS text_rank,
        COALESCE(v.similarity, 0) * 0.6 + COALESCE(t.text_rank, 0) * 0.4 AS combined_score
    FROM vector_results v
    FULL OUTER JOIN text_results t ON v.id = t.id
    ORDER BY combined_score DESC
    LIMIT top_k;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'RAGæ£€ç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM rag_retrieve(
    '[0.1,0.2,...]'::vector(1536),
    'test query',
    10,
    0.7
);
```

---

## 3. æ¨èç³»ç»Ÿå»ºæ¨¡

### 3.1 ç”¨æˆ·å’Œç‰©å“è¡¨

```sql
-- ç”¨æˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        user_id VARCHAR(255) UNIQUE NOT NULL,
        user_profile JSONB DEFAULT '{}',
        user_embedding vector(1536),  -- ç”¨æˆ·å‘é‡è¡¨ç¤º
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'è¡¨ users åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ users å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ users å¤±è´¥: %', SQLERRM;
END $$;

-- ç‰©å“è¡¨ï¼ˆå•†å“ã€å†…å®¹ç­‰ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS items (
        id SERIAL PRIMARY KEY,
        item_id VARCHAR(255) UNIQUE NOT NULL,
        item_type VARCHAR(50) NOT NULL,  -- 'product', 'article', 'video', etc.
        title TEXT NOT NULL,
    description TEXT,
    item_embedding vector(1536),  -- ç‰©å“å‘é‡è¡¨ç¤º
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_users_embedding_hnsw
ON users USING hnsw (user_embedding vector_cosine_ops)
WHERE user_embedding IS NOT NULL;

CREATE INDEX idx_items_embedding_hnsw
ON items USING hnsw (item_embedding vector_cosine_ops)
WHERE item_embedding IS NOT NULL;
```

### 3.2 ç”¨æˆ·è¡Œä¸ºè¡¨ï¼ˆTimescaleDBï¼‰

```sql
-- ç”¨æˆ·è¡Œä¸ºè¡¨ï¼ˆä½¿ç”¨TimescaleDBï¼‰
CREATE TABLE user_behaviors (
    time TIMESTAMPTZ NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    item_id VARCHAR(255) NOT NULL,
    behavior_type VARCHAR(50) NOT NULL,  -- 'view', 'click', 'purchase', 'like', etc.
    behavior_value NUMERIC(10,2),  -- è¡Œä¸ºå€¼ï¼ˆè¯„åˆ†ã€é‡‘é¢ç­‰ï¼‰
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºTimescaleDBè¶…è¡¨
SELECT create_hypertable(
    'user_behaviors',
    'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_behaviors_user_item ON user_behaviors(user_id, item_id, time DESC);
CREATE INDEX idx_user_behaviors_item ON user_behaviors(item_id, time DESC);
```

### 3.3 æ¨èå‡½æ•°

```sql
-- åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„æ¨èå‡½æ•°
CREATE OR REPLACE FUNCTION recommend_items(
    p_user_id VARCHAR(255),
    p_top_k INTEGER DEFAULT 20,
    p_exclude_items TEXT[] DEFAULT ARRAY[]::TEXT[]
)
RETURNS TABLE (
    item_id VARCHAR(255),
    title TEXT,
    similarity FLOAT,
    score FLOAT
) AS $$
DECLARE
    v_user_embedding vector(1536);
BEGIN
    -- è·å–ç”¨æˆ·å‘é‡
    SELECT user_embedding INTO v_user_embedding
    FROM users
    WHERE user_id = p_user_id;

    IF v_user_embedding IS NULL THEN
        RAISE EXCEPTION 'User embedding not found for user_id: %', p_user_id;
    END IF;

    RETURN QUERY
    SELECT
        i.item_id,
        i.title,
        1 - (i.item_embedding <=> v_user_embedding) AS similarity,
        -- ç»¼åˆè¯„åˆ†ï¼šå‘é‡ç›¸ä¼¼åº¦ + çƒ­åº¦ + æ—¶é—´è¡°å‡
        (1 - (i.item_embedding <=> v_user_embedding)) * 0.6 +
        COALESCE(ub.popularity_score, 0) * 0.3 +
        COALESCE(ub.recency_score, 0) * 0.1 AS score
    FROM items i
    LEFT JOIN LATERAL (
        SELECT
            COUNT(*)::FLOAT / (EXTRACT(EPOCH FROM (NOW() - MIN(time))) / 86400 + 1) AS popularity_score,
            EXP(-EXTRACT(EPOCH FROM (NOW() - MAX(time))) / 86400 / 7) AS recency_score
        FROM user_behaviors
        WHERE item_id = i.item_id
    ) ub ON TRUE
    WHERE i.item_embedding IS NOT NULL
      AND i.item_id != ALL(p_exclude_items)
    ORDER BY score DESC
    LIMIT p_top_k;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. è¯­ä¹‰æœç´¢å»ºæ¨¡

### 4.1 æœç´¢å†…å®¹è¡¨

```sql
-- æœç´¢å†…å®¹è¡¨
CREATE TABLE search_content (
    id SERIAL PRIMARY KEY,
    content_id VARCHAR(255) UNIQUE NOT NULL,
    content_type VARCHAR(50) NOT NULL,  -- 'article', 'product', 'faq', etc.
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    embedding vector(1536) NOT NULL,
    search_vector tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_search_content_embedding_hnsw
ON search_content USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQL 18 GINå¹¶è¡Œæ„å»ºï¼‰
CREATE INDEX idx_search_content_search_vector_gin
ON search_content USING GIN (search_vector);

-- è‡ªåŠ¨æ›´æ–°å…¨æ–‡æœç´¢å‘é‡
CREATE TRIGGER update_search_content_vector
BEFORE INSERT OR UPDATE ON search_content
FOR EACH ROW
EXECUTE FUNCTION tsvector_update_trigger(
    search_vector, 'pg_catalog.english', title, content
);
```

### 4.2 è¯­ä¹‰æœç´¢å‡½æ•°

```sql
-- è¯­ä¹‰æœç´¢å‡½æ•°ï¼ˆæ··åˆæœç´¢ï¼‰
CREATE OR REPLACE FUNCTION semantic_search(
    query_embedding vector(1536),
    query_text TEXT,
    content_type VARCHAR(50) DEFAULT NULL,
    top_k INTEGER DEFAULT 20
)
RETURNS TABLE (
    content_id VARCHAR(255),
    title TEXT,
    content TEXT,
    similarity FLOAT,
    text_rank FLOAT,
    combined_score FLOAT
) AS $$
BEGIN
    RETURN QUERY
    WITH vector_results AS (
        SELECT
            sc.content_id,
            sc.title,
            sc.content,
            1 - (sc.embedding <=> query_embedding) AS similarity
        FROM search_content sc
        WHERE (content_type IS NULL OR sc.content_type = content_type)
        ORDER BY sc.embedding <=> query_embedding
        LIMIT top_k * 2
    ),
    text_results AS (
        SELECT
            sc.content_id,
            sc.title,
            sc.content,
            ts_rank(sc.search_vector, plainto_tsquery('english', query_text)) AS text_rank
        FROM search_content sc
        WHERE (content_type IS NULL OR sc.content_type = content_type)
          AND sc.search_vector @@ plainto_tsquery('english', query_text)
        ORDER BY text_rank DESC
        LIMIT top_k * 2
    )
    SELECT
        COALESCE(v.content_id, t.content_id) AS content_id,
        COALESCE(v.title, t.title) AS title,
        COALESCE(v.content, t.content) AS content,
        COALESCE(v.similarity, 0) AS similarity,
        COALESCE(t.text_rank, 0) AS text_rank,
        COALESCE(v.similarity, 0) * 0.7 + COALESCE(t.text_rank, 0) * 0.3 AS combined_score
    FROM vector_results v
    FULL OUTER JOIN text_results t ON v.content_id = t.content_id
    ORDER BY combined_score DESC
    LIMIT top_k;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. çŸ¥è¯†å›¾è°±åº”ç”¨å»ºæ¨¡

### 5.1 å®ä½“å’Œå…³ç³»è¡¨

```sql
-- å®ä½“è¡¨
CREATE TABLE knowledge_entities (
    id SERIAL PRIMARY KEY,
    entity_id VARCHAR(255) UNIQUE NOT NULL,
    entity_type VARCHAR(50) NOT NULL,  -- 'person', 'organization', 'concept', etc.
    name TEXT NOT NULL,
    description TEXT,
    embedding vector(1536),  -- å®ä½“å‘é‡è¡¨ç¤º
    properties JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å…³ç³»è¡¨
CREATE TABLE knowledge_relationships (
    id SERIAL PRIMARY KEY,
    source_entity_id VARCHAR(255) NOT NULL REFERENCES knowledge_entities(entity_id),
    target_entity_id VARCHAR(255) NOT NULL REFERENCES knowledge_entities(entity_id),
    relationship_type VARCHAR(100) NOT NULL,  -- 'works_for', 'located_in', 'related_to', etc.
    weight NUMERIC(5,4) DEFAULT 1.0,  -- å…³ç³»æƒé‡
    properties JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(source_entity_id, target_entity_id, relationship_type)
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_knowledge_entities_embedding_hnsw
ON knowledge_entities USING hnsw (embedding vector_cosine_ops)
WHERE embedding IS NOT NULL;

-- åˆ›å»ºå…³ç³»ç´¢å¼•
CREATE INDEX idx_knowledge_relationships_source ON knowledge_relationships(source_entity_id);
CREATE INDEX idx_knowledge_relationships_target ON knowledge_relationships(target_entity_id);
CREATE INDEX idx_knowledge_relationships_type ON knowledge_relationships(relationship_type);
```

### 5.2 çŸ¥è¯†å›¾è°±æŸ¥è¯¢å‡½æ•°

```sql
-- å®ä½“ç›¸ä¼¼åº¦æŸ¥è¯¢
CREATE OR REPLACE FUNCTION find_similar_entities(
    query_embedding vector(1536),
    entity_type VARCHAR(50) DEFAULT NULL,
    top_k INTEGER DEFAULT 10
)
RETURNS TABLE (
    entity_id VARCHAR(255),
    name TEXT,
    similarity FLOAT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        ke.entity_id,
        ke.name,
        1 - (ke.embedding <=> query_embedding) AS similarity
    FROM knowledge_entities ke
    WHERE ke.embedding IS NOT NULL
      AND (entity_type IS NULL OR ke.entity_type = entity_type)
    ORDER BY ke.embedding <=> query_embedding
    LIMIT top_k;
END;
$$ LANGUAGE plpgsql;

-- å…³ç³»è·¯å¾„æŸ¥è¯¢ï¼ˆä½¿ç”¨é€’å½’CTEï¼‰
CREATE OR REPLACE FUNCTION find_relationship_path(
    source_entity_id VARCHAR(255),
    target_entity_id VARCHAR(255),
    max_depth INTEGER DEFAULT 3
)
RETURNS TABLE (
    path TEXT[],
    depth INTEGER,
    total_weight NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE entity_paths AS (
        -- èµ·å§‹èŠ‚ç‚¹
        SELECT
            ARRAY[source_entity_id]::TEXT[] AS path,
            0 AS depth,
            0::NUMERIC AS total_weight
        WHERE source_entity_id != target_entity_id

        UNION ALL

        -- é€’å½’æŸ¥æ‰¾
        SELECT
            ep.path || kr.target_entity_id,
            ep.depth + 1,
            ep.total_weight + kr.weight
        FROM entity_paths ep
        JOIN knowledge_relationships kr ON ep.path[array_length(ep.path, 1)] = kr.source_entity_id
        WHERE ep.depth < max_depth
          AND kr.target_entity_id != ALL(ep.path)  -- é¿å…å¾ªç¯
          AND kr.target_entity_id != source_entity_id
    )
    SELECT
        ep.path,
        ep.depth,
        ep.total_weight
    FROM entity_paths ep
    WHERE ep.path[array_length(ep.path, 1)] = target_entity_id
    ORDER BY ep.depth, ep.total_weight
    LIMIT 10;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. PostgreSQL 18ä¼˜åŒ–

### 6.1 å¼‚æ­¥I/Oä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šå¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆå‘é‡æ£€ç´¢å’Œæ‰¹é‡å†™å…¥ï¼‰
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET io_direct = 'data';
    ALTER SYSTEM SET io_combine_limit = '256kB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°ï¼ˆAIåº”ç”¨æ€§èƒ½æå‡50-60%ï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é…ç½®å¼‚æ­¥I/Oå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

### 6.2 GINå¹¶è¡Œæ„å»ºä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šGINå¹¶è¡Œæ„å»ºä¼˜åŒ–ï¼ˆå…¨æ–‡æœç´¢ç´¢å¼•ï¼‰
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET max_parallel_maintenance_workers = 8;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'GINå¹¶è¡Œæ„å»ºå·²é…ç½®ï¼ˆå…¨æ–‡æœç´¢ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡3-4å€ï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é…ç½®GINå¹¶è¡Œæ„å»ºå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

### 6.3 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–è®¡ç®—å­—æ®µ
ALTER TABLE user_behaviors
ADD COLUMN behavior_score NUMERIC(10,6) GENERATED ALWAYS AS (
    CASE behavior_type
        WHEN 'purchase' THEN behavior_value * 10
        WHEN 'like' THEN behavior_value * 5
        WHEN 'click' THEN behavior_value * 2
        ELSE behavior_value
    END
) VIRTUAL;
```

---

## 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 RAGåº”ç”¨ä¼˜åŒ–

**å‘é‡ç´¢å¼•ä¼˜åŒ–**:

```sql
-- HNSWç´¢å¼•ä¼˜åŒ–æ–‡æ¡£å‘é‡æ£€ç´¢
CREATE INDEX idx_document_chunks_embedding ON document_chunks
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64, ef_search = 100);

-- å…¨æ–‡æœç´¢ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_document_chunks_text_search ON document_chunks
USING gin(to_tsvector('english', chunk_text));
```

**æ··åˆæ£€ç´¢ä¼˜åŒ–**:

```sql
-- åˆ›å»ºå‡½æ•°å®ç°æ··åˆæ£€ç´¢
CREATE OR REPLACE FUNCTION hybrid_search(
    p_query_text TEXT,
    p_query_vector vector(1536),
    p_limit INTEGER DEFAULT 10
)
RETURNS TABLE(chunk_id INTEGER, score FLOAT) AS $$
BEGIN
    RETURN QUERY
    WITH vector_results AS (
        SELECT
            id,
            1 - (embedding <=> p_query_vector) AS vector_score
        FROM document_chunks
        ORDER BY embedding <=> p_query_vector
        LIMIT p_limit * 2
    ),
    text_results AS (
        SELECT
            id,
            ts_rank(to_tsvector('english', chunk_text), plainto_tsquery('english', p_query_text)) AS text_score
        FROM document_chunks
        WHERE to_tsvector('english', chunk_text) @@ plainto_tsquery('english', p_query_text)
        ORDER BY text_score DESC
        LIMIT p_limit * 2
    ),
    combined_results AS (
        SELECT
            COALESCE(v.id, t.id) AS id,
            COALESCE(v.vector_score, 0) * 0.6 + COALESCE(t.text_score, 0) * 0.4 AS combined_score
        FROM vector_results v
        FULL OUTER JOIN text_results t ON v.id = t.id
    )
    SELECT id, combined_score
    FROM combined_results
    ORDER BY combined_score DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 æ¨èç³»ç»Ÿä¼˜åŒ–

**ç”¨æˆ·è¡Œä¸ºç´¢å¼•ä¼˜åŒ–**:

```sql
-- TimescaleDBè‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_behaviors_user_time ON user_behaviors(user_id, time DESC);
CREATE INDEX idx_user_behaviors_item_time ON user_behaviors(item_id, time DESC);

-- åˆ›å»ºè¿ç»­èšåˆè§†å›¾
CREATE MATERIALIZED VIEW user_item_interactions_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    user_id,
    item_id,
    COUNT(*) AS interaction_count,
    SUM(behavior_value) AS total_value
FROM user_behaviors
GROUP BY bucket, user_id, item_id;
```

**æ¨èè®¡ç®—ä¼˜åŒ–**:

```sql
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç”¨æˆ·ç›¸ä¼¼åº¦
CREATE MATERIALIZED VIEW mv_user_similarity AS
SELECT
    u1.user_id AS user1_id,
    u2.user_id AS user2_id,
    (
        SELECT COUNT(*)
        FROM user_behaviors ub1
        JOIN user_behaviors ub2 ON ub1.item_id = ub2.item_id
        WHERE ub1.user_id = u1.user_id AND ub2.user_id = u2.user_id
    )::FLOAT / NULLIF(
        (SELECT COUNT(DISTINCT item_id) FROM user_behaviors WHERE user_id = u1.user_id), 0
    ) AS similarity
FROM (SELECT DISTINCT user_id FROM user_behaviors) u1
CROSS JOIN (SELECT DISTINCT user_id FROM user_behaviors) u2
WHERE u1.user_id < u2.user_id;
```

### 7.3 è¯­ä¹‰æœç´¢ä¼˜åŒ–

**å‘é‡ç´¢å¼•ä¼˜åŒ–**:

```sql
-- HNSWç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_search_content_embedding ON search_content
USING hnsw (content_embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_search_content_text ON search_content
USING gin(to_tsvector('english', title || ' ' || content));
```

**ç¼“å­˜ç­–ç•¥**:

```sql
-- åˆ›å»ºæŸ¥è¯¢ç¼“å­˜è¡¨
CREATE TABLE search_query_cache (
    query_hash VARCHAR(64) PRIMARY KEY,
    query_text TEXT NOT NULL,
    results JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '1 hour'
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_search_query_cache_expires ON search_query_cache(expires_at);
```

### 7.4 çŸ¥è¯†å›¾è°±ä¼˜åŒ–

**å®ä½“å‘é‡ç´¢å¼•**:

```sql
-- å®ä½“å‘é‡ç´¢å¼•
CREATE INDEX idx_knowledge_entities_embedding ON knowledge_entities
USING hnsw (entity_embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

**å›¾æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- ä½¿ç”¨é€’å½’CTEä¼˜åŒ–è·¯å¾„æŸ¥è¯¢
CREATE OR REPLACE FUNCTION find_entity_path(
    p_start_entity_id INTEGER,
    p_end_entity_id INTEGER,
    p_max_depth INTEGER DEFAULT 5
)
RETURNS TABLE(path INTEGER[]) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE entity_path AS (
        SELECT
            ARRAY[start_entity_id, end_entity_id] AS path,
            1 AS depth
        FROM knowledge_relations
        WHERE start_entity_id = p_start_entity_id
          AND end_entity_id = p_end_entity_id
        UNION ALL
        SELECT
            ep.path || kr.end_entity_id,
            ep.depth + 1
        FROM entity_path ep
        JOIN knowledge_relations kr ON ep.path[array_length(ep.path, 1)] = kr.start_entity_id
        WHERE ep.depth < p_max_depth
          AND NOT (kr.end_entity_id = ANY(ep.path))
    )
    SELECT path FROM entity_path
    WHERE path[array_length(path, 1)] = p_end_entity_id
    ORDER BY array_length(path, 1)
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 RAGåº”ç”¨

1. **æ–‡æ¡£åˆ†å—**: ä½¿ç”¨å›ºå®šå¤§å°æˆ–è¯­ä¹‰åˆ†å—
2. **æ··åˆæœç´¢**: ç»“åˆå‘é‡ç›¸ä¼¼åº¦å’Œå…¨æ–‡æœç´¢
3. **é‡æ’åº**: ä½¿ç”¨ä¸šåŠ¡è§„åˆ™è¿›è¡Œç»“æœé‡æ’åº
4. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ

### 8.2 æ¨èç³»ç»Ÿ

1. **å¤šç­–ç•¥èåˆ**: ç»“åˆååŒè¿‡æ»¤ã€å†…å®¹æ¨èã€æ·±åº¦å­¦ä¹ 
2. **å®æ—¶æ›´æ–°**: ä½¿ç”¨TimescaleDBå­˜å‚¨ç”¨æˆ·è¡Œä¸º
3. **å†·å¯åŠ¨**: ä½¿ç”¨å†…å®¹ç‰¹å¾å¤„ç†æ–°ç”¨æˆ·/æ–°ç‰©å“
4. **å¤šæ ·æ€§**: ç¡®ä¿æ¨èç»“æœçš„å¤šæ ·æ€§

### 8.3 è¯­ä¹‰æœç´¢

1. **ç´¢å¼•ä¼˜åŒ–**: ä½¿ç”¨HNSWç´¢å¼•åŠ é€Ÿå‘é‡æ£€ç´¢
2. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ç»“æœ
3. **ç»“æœå¤šæ ·æ€§**: ç¡®ä¿ç»“æœå¤šæ ·æ€§
4. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 8.4 çŸ¥è¯†å›¾è°±

1. **å®ä½“å‘é‡åŒ–**: ä½¿ç”¨å®ä½“æè¿°ç”Ÿæˆå‘é‡
2. **å…³ç³»æƒé‡**: æ ¹æ®å…³ç³»é‡è¦æ€§è®¾ç½®æƒé‡
3. **è·¯å¾„æŸ¥è¯¢**: ä½¿ç”¨é€’å½’CTEè¿›è¡Œè·¯å¾„æŸ¥è¯¢
4. **å›¾ç®—æ³•**: ä½¿ç”¨å›¾ç®—æ³•å‘ç°æ¨¡å¼

### 8.5 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ä½¿ç”¨DOå—å¤„ç†AIåº”ç”¨æ“ä½œé”™è¯¯
2. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨EXPLAIN (ANALYZE, BUFFERS, TIMING)åˆ†ææŸ¥è¯¢æ€§èƒ½
3. **å¹¶å‘æ§åˆ¶**: å¤„ç†å¹¶å‘è¯·æ±‚çš„ç«äº‰æ¡ä»¶
4. **èµ„æºç®¡ç†**: é™åˆ¶æŸ¥è¯¢çš„å†…å­˜å’ŒCPUä½¿ç”¨

---

## 9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: RAGæ£€ç´¢å»¶è¿Ÿé«˜

**åŸå› **:

- å‘é‡ç´¢å¼•æœªä¼˜åŒ–
- æŸ¥è¯¢å‘é‡æœªç¼“å­˜
- æ–‡æ¡£æ•°é‡è¿‡å¤§

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨HNSWç´¢å¼•ä¼˜åŒ–å‘é‡æ£€ç´¢
- ç¼“å­˜æŸ¥è¯¢å‘é‡
- ä½¿ç”¨PCAé™ç»´å‡å°‘å‘é‡ç»´åº¦

**ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–å‘é‡æ£€ç´¢
CREATE INDEX idx_document_chunks_embedding ON document_chunks
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64, ef_search = 100);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT id, chunk_text, 1 - (embedding <=> $query_vector) AS similarity
FROM document_chunks
ORDER BY embedding <=> $query_vector
LIMIT 10;
```

### é—®é¢˜2: æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜

**åŸå› **:

- æ–°ç”¨æˆ·/æ–°ç‰©å“ç¼ºå°‘è¡Œä¸ºæ•°æ®
- ååŒè¿‡æ»¤æ— æ³•å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨å†…å®¹ç‰¹å¾æ¨è
- ä½¿ç”¨çƒ­é—¨æ¨è
- ä½¿ç”¨æ··åˆæ¨èç­–ç•¥

**ç¤ºä¾‹**:

```sql
-- æ–°ç”¨æˆ·æ¨èï¼ˆåŸºäºå†…å®¹ç‰¹å¾ï¼‰
CREATE OR REPLACE FUNCTION recommend_for_new_user(
    p_user_id INTEGER,
    p_limit INTEGER DEFAULT 10
)
RETURNS TABLE(item_id INTEGER, score FLOAT) AS $$
BEGIN
    RETURN QUERY
    -- åŸºäºç‰©å“ç‰¹å¾æ¨è
    SELECT
        i.item_id,
        AVG(ic.feature_value::FLOAT) AS content_score
    FROM items i
    JOIN item_features ic ON i.item_id = ic.item_id
    WHERE i.item_id NOT IN (
        SELECT item_id FROM user_behaviors WHERE user_id = p_user_id
    )
    GROUP BY i.item_id
    ORDER BY content_score DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### é—®é¢˜3: è¯­ä¹‰æœç´¢ç»“æœä¸å‡†ç¡®

**åŸå› **:

- å‘é‡è´¨é‡å·®
- æŸ¥è¯¢ç†è§£ä¸å‡†ç¡®
- ç¼ºå°‘é‡æ’åº

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨æ›´å¥½çš„å‘é‡æ¨¡å‹
- ä¼˜åŒ–æŸ¥è¯¢é¢„å¤„ç†
- å®ç°é‡æ’åºæœºåˆ¶

### é—®é¢˜4: çŸ¥è¯†å›¾è°±æŸ¥è¯¢æ€§èƒ½å·®

**åŸå› **:

- å›¾è§„æ¨¡è¿‡å¤§
- è·¯å¾„æŸ¥è¯¢æ·±åº¦è¿‡å¤§
- ç¼ºå°‘ç´¢å¼•

**è§£å†³æ–¹æ¡ˆ**:

- é™åˆ¶è·¯å¾„æŸ¥è¯¢æ·±åº¦
- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
- ä½¿ç”¨å›¾æ•°æ®åº“ï¼ˆå¦‚Apache AGEï¼‰

**ç¤ºä¾‹**:

```sql
-- é™åˆ¶è·¯å¾„æŸ¥è¯¢æ·±åº¦
WITH RECURSIVE entity_path AS (
    SELECT
        ARRAY[start_entity_id, end_entity_id] AS path,
        1 AS depth
    FROM knowledge_relations
    WHERE start_entity_id = $start_id
    UNION ALL
    SELECT
        ep.path || kr.end_entity_id,
        ep.depth + 1
    FROM entity_path ep
    JOIN knowledge_relations kr ON ep.path[array_length(ep.path, 1)] = kr.start_entity_id
    WHERE ep.depth < 5  -- é™åˆ¶æœ€å¤§æ·±åº¦
      AND NOT (kr.end_entity_id = ANY(ep.path))
)
SELECT path FROM entity_path
WHERE path[array_length(path, 1)] = $end_id;
```

---

## 10. ç›¸å…³èµ„æº

### 10.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£

- [å‘é‡æ•°æ®åº“å»ºæ¨¡](../08-PostgreSQLå»ºæ¨¡å®è·µ/å‘é‡æ•°æ®åº“å»ºæ¨¡.md) - pgvectorå»ºæ¨¡æŒ‡å—
- [æ—¶åºæ•°æ®å»ºæ¨¡](../06-IoTä¸æ—¶åºå»ºæ¨¡/æ—¶åºæ•°æ®æ¨¡å‹.md) - TimescaleDBå»ºæ¨¡æŒ‡å—
- [PostgreSQL18æ–°ç‰¹æ€§](../08-PostgreSQLå»ºæ¨¡å®è·µ/PostgreSQL18æ–°ç‰¹æ€§.md) - PostgreSQL 18æ–°ç‰¹æ€§æŒ‡å—

### 10.2 å®˜æ–¹èµ„æº

- [pgvector GitHub](https://github.com/pgvector/pgvector) - pgvectorå®˜æ–¹ä»“åº“
- [TimescaleDBæ–‡æ¡£](https://docs.timescale.com/) - TimescaleDBå®˜æ–¹æ–‡æ¡£
- [PostgreSQL 18æ–‡æ¡£](https://www.postgresql.org/docs/18/) - PostgreSQL 18å®˜æ–¹æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**çŠ¶æ€**: âœ… å·²å®Œæˆ
