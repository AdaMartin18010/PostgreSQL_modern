# PostgreSQLçº¦æŸè®¾è®¡å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQLå®˜æ–¹æ–‡æ¡£ + å®è·µæ€»ç»“
> **çŠ¶æ€**: åŸºäºPostgreSQL 17+/18+ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 08-04

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLçº¦æŸè®¾è®¡å®Œæ•´æŒ‡å—](#postgresqlçº¦æŸè®¾è®¡å®Œæ•´æŒ‡å—)
- [2. çº¦æŸç±»å‹](#2-çº¦æŸç±»å‹)
  - [2.1 ä¸»é”®çº¦æŸï¼ˆPRIMARY KEYï¼‰](#21-ä¸»é”®çº¦æŸprimary-key)
  - [2.2 å¤–é”®çº¦æŸï¼ˆFOREIGN KEYï¼‰](#22-å¤–é”®çº¦æŸforeign-key)
  - [2.3 å”¯ä¸€çº¦æŸï¼ˆUNIQUEï¼‰](#23-å”¯ä¸€çº¦æŸunique)
  - [2.4 éç©ºçº¦æŸï¼ˆNOT NULLï¼‰](#24-éç©ºçº¦æŸnot-null)
  - [2.5 CHECKçº¦æŸ](#25-checkçº¦æŸ)
  - [2.6 EXCLUDEçº¦æŸ](#26-excludeçº¦æŸ)
- [3. çº¦æŸè®¾è®¡ç­–ç•¥](#3-çº¦æŸè®¾è®¡ç­–ç•¥)
- [4. çº¦æŸæ€§èƒ½ä¼˜åŒ–](#4-çº¦æŸæ€§èƒ½ä¼˜åŒ–)
- [5. çº¦æŸæœ€ä½³å®è·µ](#5-çº¦æŸæœ€ä½³å®è·µ)
- [6. å¸¸è§çº¦æŸæ¨¡å¼](#6-å¸¸è§çº¦æŸæ¨¡å¼)
- [7. ç›¸å…³èµ„æº](#7-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

çº¦æŸï¼ˆConstraintsï¼‰æ˜¯æ•°æ®åº“è®¾è®¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ã€‚PostgreSQLæä¾›äº†ä¸°å¯Œçš„çº¦æŸç±»å‹ï¼Œæ­£ç¡®ä½¿ç”¨çº¦æŸå¯ä»¥å‡å°‘åº”ç”¨å±‚ä»£ç å¤æ‚åº¦ï¼Œæé«˜æ•°æ®è´¨é‡ã€‚

---

## 2. çº¦æŸç±»å‹

### 2.1 ä¸»é”®çº¦æŸï¼ˆPRIMARY KEYï¼‰

**å®šä¹‰**: å”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„æ¯ä¸€è¡Œï¼Œä¸èƒ½ä¸ºNULLä¸”å¿…é¡»å”¯ä¸€ã€‚

**ç‰¹ç‚¹**:

- è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•
- åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®
- å¯ä»¥æ˜¯å•åˆ—æˆ–å¤åˆåˆ—

**PostgreSQLå®ç°**:

```sql
-- å•åˆ—ä¸»é”®
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,  -- è‡ªåŠ¨åˆ›å»ºä¸»é”®çº¦æŸå’Œç´¢å¼•
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL
);

-- å¤åˆä¸»é”®
CREATE TABLE order_items (
    order_id INT NOT NULL,
    line_number INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    PRIMARY KEY (order_id, line_number)  -- å¤åˆä¸»é”®
);

-- æ˜¾å¼å‘½åä¸»é”®çº¦æŸ
CREATE TABLE products (
    product_id SERIAL,
    sku VARCHAR(50) UNIQUE NOT NULL,
    CONSTRAINT pk_products PRIMARY KEY (product_id)
);
```

**ä¸»é”®é€‰æ‹©å»ºè®®**:

- **ä»£ç†é”®**: ä½¿ç”¨SERIAL/BIGSERIALï¼ˆæ¨èï¼‰
- **ä¸šåŠ¡é”®**: ä½¿ç”¨ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ï¼ˆéœ€ç¡®ä¿ç¨³å®šæ€§ï¼‰
- **UUID**: åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨UUID

---

### 2.2 å¤–é”®çº¦æŸï¼ˆFOREIGN KEYï¼‰

**å®šä¹‰**: ç¡®ä¿å¼•ç”¨å®Œæ•´æ€§ï¼Œå¤–é”®å€¼å¿…é¡»åœ¨è¢«å¼•ç”¨è¡¨çš„ä¸»é”®ä¸­å­˜åœ¨ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒçº§è”æ“ä½œï¼ˆCASCADEã€RESTRICTã€SET NULLã€SET DEFAULTï¼‰
- è‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼ˆPostgreSQL 11+ï¼‰
- å¯ä»¥å»¶è¿Ÿæ£€æŸ¥ï¼ˆDEFERRABLEï¼‰

**PostgreSQLå®ç°**:

```sql
-- åŸºæœ¬å¤–é”®çº¦æŸ
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT fk_orders_customer
        FOREIGN KEY (customer_id)
        REFERENCES customers(customer_id)
);

-- çº§è”åˆ é™¤
CREATE TABLE order_items (
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    CONSTRAINT fk_order_items_order
        FOREIGN KEY (order_id)
        REFERENCES orders(order_id)
        ON DELETE CASCADE,  -- åˆ é™¤è®¢å•æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è®¢å•é¡¹
    CONSTRAINT fk_order_items_product
        FOREIGN KEY (product_id)
        REFERENCES products(product_id)
        ON DELETE RESTRICT  -- æœ‰è®¢å•é¡¹æ—¶ï¼Œç¦æ­¢åˆ é™¤äº§å“
);

-- çº§è”æ›´æ–°
CREATE TABLE order_items (
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    CONSTRAINT fk_order_items_product
        FOREIGN KEY (product_id)
        REFERENCES products(product_id)
        ON UPDATE CASCADE  -- æ›´æ–°äº§å“IDæ—¶ï¼ŒåŒæ­¥æ›´æ–°è®¢å•é¡¹
);

-- è®¾ç½®ä¸ºNULL
CREATE TABLE order_items (
    order_id INT NOT NULL,
    product_id INT,  -- å…è®¸NULL
    CONSTRAINT fk_order_items_product
        FOREIGN KEY (product_id)
        REFERENCES products(product_id)
        ON DELETE SET NULL  -- åˆ é™¤äº§å“æ—¶ï¼Œå°†product_idè®¾ä¸ºNULL
);
```

**å¤–é”®ç´¢å¼•**:

```sql
-- PostgreSQL 11+è‡ªåŠ¨åˆ›å»ºç´¢å¼•
-- æ‰‹åŠ¨åˆ›å»ºç´¢å¼•ï¼ˆä¼˜åŒ–JOINæ€§èƒ½ï¼‰
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_order_items_order ON order_items(order_id);
CREATE INDEX idx_order_items_product ON order_items(product_id);
```

---

### 2.3 å”¯ä¸€çº¦æŸï¼ˆUNIQUEï¼‰

**å®šä¹‰**: ç¡®ä¿åˆ—å€¼å”¯ä¸€ï¼ˆå…è®¸NULLï¼‰ã€‚

**ç‰¹ç‚¹**:

- è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•
- å…è®¸NULLå€¼ï¼ˆå¤šä¸ªNULLè§†ä¸ºä¸åŒï¼‰
- å¯ä»¥æ˜¯å•åˆ—æˆ–å¤åˆåˆ—

**PostgreSQLå®ç°**:

```sql
-- å•åˆ—å”¯ä¸€çº¦æŸ
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL
);

-- å¤åˆå”¯ä¸€çº¦æŸ
CREATE TABLE enrollments (
    student_id INT NOT NULL,
    course_id INT NOT NULL,
    semester VARCHAR(20) NOT NULL,
    UNIQUE (student_id, course_id, semester)  -- åŒä¸€å­¦æœŸä¸èƒ½é‡å¤é€‰è¯¾
);

-- å‘½åå”¯ä¸€çº¦æŸ
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    sku VARCHAR(50) NOT NULL,
    CONSTRAINT uk_product_sku UNIQUE (sku)
);

-- éƒ¨åˆ†å”¯ä¸€çº¦æŸï¼ˆä»…å¯¹æ»¡è¶³æ¡ä»¶çš„è¡Œå”¯ä¸€ï¼‰
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50),
    status VARCHAR(20) DEFAULT 'pending',
    UNIQUE (order_number) WHERE status != 'cancelled'  -- ä»…éå–æ¶ˆè®¢å•å”¯ä¸€
);
```

---

### 2.4 éç©ºçº¦æŸï¼ˆNOT NULLï¼‰

**å®šä¹‰**: ç¡®ä¿åˆ—å€¼ä¸èƒ½ä¸ºNULLã€‚

**ç‰¹ç‚¹**:

- æœ€ç®€å•çš„çº¦æŸ
- æé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆé¿å…NULLæ£€æŸ¥ï¼‰
- ä¸é»˜è®¤å€¼é…åˆä½¿ç”¨

**PostgreSQLå®ç°**:

```sql
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),  -- å¯é€‰å­—æ®µ
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- æ·»åŠ NOT NULLçº¦æŸ
ALTER TABLE users
ALTER COLUMN phone SET NOT NULL;

-- åˆ é™¤NOT NULLçº¦æŸ
ALTER TABLE users
ALTER COLUMN phone DROP NOT NULL;
```

---

### 2.5 CHECKçº¦æŸ

**å®šä¹‰**: å®šä¹‰åˆ—å€¼å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒå¤æ‚æ¡ä»¶è¡¨è¾¾å¼
- å¯ä»¥æ˜¯åˆ—çº§æˆ–è¡¨çº§
- æ”¯æŒå‡½æ•°è°ƒç”¨

**PostgreSQLå®ç°**:

```sql
-- åˆ—çº§CHECKçº¦æŸ
CREATE TABLE students (
    student_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    age INT CHECK (age >= 18 AND age <= 100),
    email VARCHAR(100) CHECK (email LIKE '%@%.%'),
    grade CHAR(2) CHECK (grade IN ('A', 'B', 'C', 'D', 'F'))
);

-- è¡¨çº§CHECKçº¦æŸï¼ˆå¯ä»¥å¼•ç”¨å¤šåˆ—ï¼‰
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    order_date DATE NOT NULL,
    ship_date DATE,
    delivery_date DATE,
    CONSTRAINT chk_dates
        CHECK (ship_date IS NULL OR ship_date >= order_date),
    CONSTRAINT chk_delivery
        CHECK (delivery_date IS NULL OR delivery_date >= ship_date)
);

-- å‘½åCHECKçº¦æŸ
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    price NUMERIC(10,2) NOT NULL,
    discount NUMERIC(10,2) DEFAULT 0,
    CONSTRAINT chk_price_positive CHECK (price > 0),
    CONSTRAINT chk_discount_range CHECK (discount >= 0 AND discount <= price)
);

-- ä½¿ç”¨å‡½æ•°
CREATE TABLE events (
    event_id SERIAL PRIMARY KEY,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    CONSTRAINT chk_event_duration
        CHECK (end_time > start_time AND end_time <= start_time + INTERVAL '24 hours')
);
```

---

### 2.6 EXCLUDEçº¦æŸ

**å®šä¹‰**: PostgreSQLç‰¹æœ‰çº¦æŸï¼Œä½¿ç”¨ç´¢å¼•æ–¹æ³•æ’é™¤æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„è¡Œã€‚

**ç‰¹ç‚¹**:

- é˜²æ­¢æ—¶é—´èŒƒå›´é‡å 
- é˜²æ­¢ç©ºé—´èŒƒå›´é‡å 
- éœ€è¦GISTç´¢å¼•æ”¯æŒ

**PostgreSQLå®ç°**:

```sql
-- å¯ç”¨btree_gistæ‰©å±•
CREATE EXTENSION IF NOT EXISTS btree_gist;

-- é˜²æ­¢ä¼šè®®å®¤é¢„è®¢æ—¶é—´é‡å 
CREATE TABLE room_bookings (
    booking_id SERIAL PRIMARY KEY,
    room_id INT NOT NULL,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    CONSTRAINT chk_time_range CHECK (end_time > start_time),
    CONSTRAINT uk_room_time
        EXCLUDE USING GIST (
            room_id WITH =,
            tsrange(start_time, end_time) WITH &&
        )
);

-- æ’å…¥æµ‹è¯•
INSERT INTO room_bookings (room_id, start_time, end_time)
VALUES (1, '2024-01-01 10:00:00', '2024-01-01 11:00:00');  -- âœ… æˆåŠŸ

INSERT INTO room_bookings (room_id, start_time, end_time)
VALUES (1, '2024-01-01 10:30:00', '2024-01-01 11:30:00');  -- âŒ å¤±è´¥ï¼šæ—¶é—´é‡å 

-- é˜²æ­¢IPåœ°å€èŒƒå›´é‡å 
CREATE TABLE ip_ranges (
    range_id SERIAL PRIMARY KEY,
    network_name VARCHAR(100) NOT NULL,
    start_ip INET NOT NULL,
    end_ip INET NOT NULL,
    CONSTRAINT chk_ip_range CHECK (end_ip > start_ip),
    CONSTRAINT uk_ip_range
        EXCLUDE USING GIST (
            inetrange(start_ip, end_ip) WITH &&
        )
);
```

---

## 3. çº¦æŸè®¾è®¡ç­–ç•¥

### 3.1 çº¦æŸå‘½åè§„èŒƒ

**å‘½åæ ¼å¼**: `çº¦æŸç±»å‹_è¡¨å_åˆ—å` æˆ– `çº¦æŸç±»å‹_è¡¨å_æè¿°`

**ç¤ºä¾‹**:

```sql
-- ä¸»é”®
CONSTRAINT pk_orders PRIMARY KEY (order_id)

-- å¤–é”®
CONSTRAINT fk_orders_customers FOREIGN KEY (customer_id) REFERENCES customers(customer_id)

-- å”¯ä¸€çº¦æŸ
CONSTRAINT uk_products_sku UNIQUE (sku)

-- CHECKçº¦æŸ
CONSTRAINT chk_orders_amount CHECK (amount > 0)

-- EXCLUDEçº¦æŸ
CONSTRAINT uk_room_bookings_time EXCLUDE USING GIST (...)
```

---

### 3.2 çº¦æŸé€‰æ‹©åŸåˆ™

**åŸåˆ™1: åœ¨æ•°æ®åº“å±‚å®šä¹‰çº¦æŸ**

- âœ… æ•°æ®åº“å±‚çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
- âŒ åº”ç”¨å±‚çº¦æŸå¯èƒ½è¢«ç»•è¿‡

**åŸåˆ™2: ä½¿ç”¨åˆé€‚çš„å¤–é”®çº§è”ç­–ç•¥**

- `CASCADE`: å­è¡¨æ•°æ®éšçˆ¶è¡¨åˆ é™¤
- `RESTRICT`: æœ‰å­è¡¨æ•°æ®æ—¶ç¦æ­¢åˆ é™¤çˆ¶è¡¨
- `SET NULL`: å­è¡¨å¤–é”®è®¾ä¸ºNULL
- `SET DEFAULT`: å­è¡¨å¤–é”®è®¾ä¸ºé»˜è®¤å€¼

**åŸåˆ™3: ä½¿ç”¨EXCLUDEçº¦æŸé˜²æ­¢é‡å **

- æ—¶é—´èŒƒå›´é‡å 
- ç©ºé—´èŒƒå›´é‡å 
- IPåœ°å€èŒƒå›´é‡å 

---

## 4. çº¦æŸæ€§èƒ½ä¼˜åŒ–

### 4.1 çº¦æŸæ£€æŸ¥æ€§èƒ½

**å»¶è¿Ÿçº¦æŸæ£€æŸ¥**:

```sql
-- åˆ›å»ºå¯å»¶è¿Ÿçš„çº¦æŸ
CREATE TABLE departments (
    dept_id SERIAL PRIMARY KEY,
    dept_name VARCHAR(100) NOT NULL,
    manager_id INT,
    CONSTRAINT fk_dept_manager
        FOREIGN KEY (manager_id)
        REFERENCES employees(emp_id)
        DEFERRABLE INITIALLY DEFERRED  -- å¯å»¶è¿Ÿï¼Œåˆå§‹ä¸ºå»¶è¿Ÿ
);

-- åœ¨äº‹åŠ¡ä¸­å»¶è¿Ÿçº¦æŸæ£€æŸ¥
BEGIN;
SET CONSTRAINTS fk_dept_manager DEFERRED;

-- ç°åœ¨å¯ä»¥æ’å…¥å¾ªç¯å¼•ç”¨çš„æ•°æ®
INSERT INTO employees (emp_id, emp_name, dept_id)
VALUES (1, 'John', 1);

INSERT INTO departments (dept_id, dept_name, manager_id)
VALUES (1, 'IT', 1);

COMMIT;  -- æäº¤æ—¶æ‰æ£€æŸ¥çº¦æŸ
```

---

### 4.2 çº¦æŸç´¢å¼•ä¼˜åŒ–

**å¤–é”®ç´¢å¼•**:

```sql
-- PostgreSQL 11+è‡ªåŠ¨ä¸ºå¤–é”®åˆ›å»ºç´¢å¼•
-- æ‰‹åŠ¨åˆ›å»ºç´¢å¼•ä¼˜åŒ–JOIN
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_order_items_order ON order_items(order_id);
```

**å”¯ä¸€çº¦æŸç´¢å¼•**:

```sql
-- å”¯ä¸€çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•
-- éƒ¨åˆ†å”¯ä¸€çº¦æŸç´¢å¼•
CREATE UNIQUE INDEX idx_orders_number_active
ON orders(order_number)
WHERE status != 'cancelled';
```

---

## 5. çº¦æŸæœ€ä½³å®è·µ

### 5.1 è®¾è®¡åŸåˆ™

**åŸåˆ™1: å®Œæ•´æ€§ä¼˜å…ˆ**:

```sql
-- âœ… æ­£ç¡®ï¼šå®Œæ•´çš„çº¦æŸ
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date DATE NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    CONSTRAINT fk_orders_customer FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    CONSTRAINT chk_amount_positive CHECK (amount > 0)
);

-- âŒ é”™è¯¯ï¼šç¼ºå°‘çº¦æŸ
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id INT,  -- ç¼ºå°‘NOT NULLå’Œå¤–é”®
    amount NUMERIC(10,2)  -- ç¼ºå°‘CHECKçº¦æŸ
);
```

---

**åŸåˆ™2: çº¦æŸå‘½åä¸€è‡´**:

```sql
-- âœ… æ­£ç¡®ï¼šç»Ÿä¸€çš„å‘½åè§„èŒƒ
CREATE TABLE orders (
    order_id BIGSERIAL,
    customer_id INT NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    CONSTRAINT pk_orders PRIMARY KEY (order_id),
    CONSTRAINT fk_orders_customers FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    CONSTRAINT chk_orders_amount CHECK (amount > 0)
);
```

---

**åŸåˆ™3: ä½¿ç”¨EXCLUDEçº¦æŸé˜²æ­¢é‡å **:

```sql
-- âœ… æ­£ç¡®ï¼šä½¿ç”¨EXCLUDEçº¦æŸ
CREATE TABLE bookings (
    room_id INT NOT NULL,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    CONSTRAINT uk_room_time
        EXCLUDE USING GIST (
            room_id WITH =,
            tsrange(start_time, end_time) WITH &&
        )
);

-- âŒ é”™è¯¯ï¼šåº”ç”¨å±‚æ£€æŸ¥ï¼ˆå¯èƒ½å¹¶å‘é—®é¢˜ï¼‰
-- åº”ç”¨å±‚SELECT ... FOR UPDATEæ£€æŸ¥ï¼Œç„¶åINSERT
```

---

## 6. å¸¸è§çº¦æŸæ¨¡å¼

### 6.1 è½¯åˆ é™¤æ¨¡å¼

```sql
-- æ¨¡å¼ï¼šä½¿ç”¨deleted_atæ ‡è®°åˆ é™¤
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    deleted_at TIMESTAMPTZ,
    CONSTRAINT uk_product_name_active
        UNIQUE NULLS NOT DISTINCT (name, deleted_at)  -- PostgreSQL 15+
);

-- æŸ¥è¯¢æ´»è·ƒäº§å“
SELECT * FROM products WHERE deleted_at IS NULL;
```

---

### 6.2 çŠ¶æ€è½¬æ¢çº¦æŸ

```sql
-- æ¨¡å¼ï¼šé™åˆ¶çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    previous_status VARCHAR(20),
    CONSTRAINT chk_status_transition CHECK (
        (status = 'pending' AND previous_status IS NULL) OR
        (status = 'processing' AND previous_status = 'pending') OR
        (status = 'shipped' AND previous_status = 'processing') OR
        (status = 'delivered' AND previous_status = 'shipped') OR
        (status = 'cancelled' AND previous_status IN ('pending', 'processing'))
    )
);
```

---

### 6.3 æ—¶é—´èŒƒå›´çº¦æŸ

```sql
-- æ¨¡å¼ï¼šç¡®ä¿æ—¶é—´èŒƒå›´çš„åˆç†æ€§
CREATE TABLE events (
    event_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    CONSTRAINT chk_event_time_range
        CHECK (end_time > start_time),
    CONSTRAINT uk_event_time_overlap
        EXCLUDE USING GIST (
            tsrange(start_time, end_time) WITH &&
        )
);
```

---

## 7. ç›¸å…³èµ„æº

- [çº¦æŸç†è®º](../01-æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€/çº¦æŸç†è®º.md) - çº¦æŸç†è®ºåŸºç¡€
- [æ•°æ®ç±»å‹é€‰æ‹©](./æ•°æ®ç±»å‹é€‰æ‹©.md) - çº¦æŸä¸æ•°æ®ç±»å‹
- [ç´¢å¼•ç­–ç•¥](./ç´¢å¼•ç­–ç•¥.md) - çº¦æŸç´¢å¼•ä¼˜åŒ–
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Constraints](https://www.postgresql.org/docs/current/ddl-constraints.html)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
