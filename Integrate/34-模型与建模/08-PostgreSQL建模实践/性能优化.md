# PostgreSQLæ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQLå®˜æ–¹æ–‡æ¡£ + å®žè·µæ€»ç»“
> **çŠ¶æ€**: åŸºäºŽPostgreSQL 17+/18+ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 08-05

---

## ðŸ“‘ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æŸ¥è¯¢ä¼˜åŒ–](#2-æŸ¥è¯¢ä¼˜åŒ–)
  - [2.1 æ‰§è¡Œè®¡åˆ’åˆ†æž](#21-æ‰§è¡Œè®¡åˆ’åˆ†æž)
  - [2.2 ç´¢å¼•ä¼˜åŒ–](#22-ç´¢å¼•ä¼˜åŒ–)
  - [2.3 JOINä¼˜åŒ–](#23-joinä¼˜åŒ–)
- [3. å‚æ•°è°ƒä¼˜](#3-å‚æ•°è°ƒä¼˜)
  - [3.1 å†…å­˜å‚æ•°](#31-å†…å­˜å‚æ•°)
  - [3.2 è¿žæŽ¥å‚æ•°](#32-è¿žæŽ¥å‚æ•°)
  - [3.3 æŸ¥è¯¢å‚æ•°](#33-æŸ¥è¯¢å‚æ•°)
- [4. è¡¨è®¾è®¡ä¼˜åŒ–](#4-è¡¨è®¾è®¡ä¼˜åŒ–)
- [5. åˆ†åŒºä¼˜åŒ–](#5-åˆ†åŒºä¼˜åŒ–)
- [6. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#6-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
- [7. ç›¸å…³èµ„æº](#7-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

PostgreSQLæ€§èƒ½ä¼˜åŒ–æ¶‰åŠæŸ¥è¯¢ä¼˜åŒ–ã€å‚æ•°è°ƒä¼˜ã€è¡¨è®¾è®¡ã€ç´¢å¼•ç­–ç•¥ç­‰å¤šä¸ªæ–¹é¢ã€‚
æ­£ç¡®çš„ä¼˜åŒ–ç­–ç•¥å¯ä»¥æ˜¾è‘—æå‡æ•°æ®åº“æ€§èƒ½ï¼Œæ”¯æŒæ›´é«˜çš„å¹¶å‘å’Œæ›´å¤§çš„æ•°æ®é‡ã€‚

---

## 2. æŸ¥è¯¢ä¼˜åŒ–

### 2.1 æ‰§è¡Œè®¡åˆ’åˆ†æž

**EXPLAINå‘½ä»¤**:

```sql
-- åŸºæœ¬æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM orders WHERE customer_id = 123;

-- è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å«å®žé™…æ‰§è¡Œæ—¶é—´ï¼‰
EXPLAIN ANALYZE SELECT * FROM orders WHERE customer_id = 123;

-- è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å«ç¼“å†²åŒºä½¿ç”¨ï¼‰
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM orders WHERE customer_id = 123;

-- æ ¼å¼åŒ–è¾“å‡º
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON) SELECT * FROM orders WHERE customer_id = 123;
```

**æ‰§è¡Œè®¡åˆ’è§£è¯»**:

```sql
-- ç¤ºä¾‹è¾“å‡º
EXPLAIN ANALYZE SELECT * FROM orders WHERE customer_id = 123;

-- è¾“å‡ºï¼š
-- Index Scan using idx_orders_customer on orders
--   (cost=0.42..8.44 rows=1 width=100)
--   (actual time=0.123..0.125 rows=1 loops=1)
--   Index Cond: (customer_id = 123)
-- Planning Time: 0.234 ms
-- Execution Time: 0.156 ms

-- å…³é”®æŒ‡æ ‡ï¼š
-- cost: é¢„ä¼°æˆæœ¬ï¼ˆå¯åŠ¨æˆæœ¬..æ€»æˆæœ¬ï¼‰
-- rows: é¢„ä¼°è¡Œæ•°
-- actual time: å®žé™…æ‰§è¡Œæ—¶é—´ï¼ˆå¯åŠ¨æ—¶é—´..æ€»æ—¶é—´ï¼‰
-- loops: å¾ªçŽ¯æ¬¡æ•°
```

---

### 2.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•é€‰æ‹©**:

```sql
-- âœ… æ­£ç¡®ï¼šä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_date ON orders(order_date);

-- âœ… æ­£ç¡®ï¼šå¤åˆç´¢å¼•ï¼ˆé«˜é€‰æ‹©æ€§åˆ—åœ¨å‰ï¼‰
CREATE INDEX idx_orders_customer_date ON orders(customer_id, order_date);

-- âœ… æ­£ç¡®ï¼šéƒ¨åˆ†ç´¢å¼•ï¼ˆä»…ç´¢å¼•æ»¡è¶³æ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_orders_active ON orders(customer_id)
WHERE status IN ('pending', 'processing');

-- âŒ é”™è¯¯ï¼šä¸ºå¾ˆå°‘æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_notes ON orders(notes);  -- å¾ˆå°‘æŸ¥è¯¢
```

**ç´¢å¼•ä½¿ç”¨æ£€æŸ¥**:

```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC;  -- æœªä½¿ç”¨çš„ç´¢å¼•

-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
DROP INDEX idx_orders_notes;
```

---

### 2.3 JOINä¼˜åŒ–

**JOINç±»åž‹é€‰æ‹©**:

```sql
-- Hash Joinï¼šé€‚ç”¨äºŽå¤§è¡¨JOIN
EXPLAIN ANALYZE
SELECT o.*, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id;
-- Hash Join (cost=...)

-- Merge Joinï¼šé€‚ç”¨äºŽå·²æŽ’åºçš„è¡¨
EXPLAIN ANALYZE
SELECT o.*, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
ORDER BY o.customer_id;
-- Merge Join (cost=...)

-- Nested Loopï¼šé€‚ç”¨äºŽå°è¡¨JOIN
EXPLAIN ANALYZE
SELECT o.*, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_id = 123;
-- Nested Loop (cost=...)
```

**JOINé¡ºåºä¼˜åŒ–**:

```sql
-- âœ… æ­£ç¡®ï¼šå°è¡¨åœ¨å‰
SELECT *
FROM small_table s
JOIN large_table l ON s.id = l.id;

-- âŒ é”™è¯¯ï¼šå¤§è¡¨åœ¨å‰ï¼ˆå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼‰
SELECT *
FROM large_table l
JOIN small_table s ON l.id = s.id;
```

---

## 3. å‚æ•°è°ƒä¼˜

### 3.1 å†…å­˜å‚æ•°

**shared_buffers**:

```sql
-- æŽ¨èå€¼ï¼š25% RAM
-- é…ç½®æ–‡ä»¶ï¼špostgresql.conf
shared_buffers = 8GB  -- 32GB RAMçš„25%

-- æŸ¥çœ‹å½“å‰å€¼
SHOW shared_buffers;
```

**work_mem**:

```sql
-- æŽ¨èå€¼ï¼šRAM / (max_connections Ã— 3)
-- ç¤ºä¾‹ï¼š32GB RAMï¼Œ100è¿žæŽ¥
work_mem = 32GB / (100 Ã— 3) = 107MB

-- é…ç½®æ–‡ä»¶
work_mem = 128MB

-- æŸ¥çœ‹å½“å‰å€¼
SHOW work_mem;
```

**effective_cache_size**:

```sql
-- æŽ¨èå€¼ï¼š50-75% RAM
effective_cache_size = 24GB  -- 32GB RAMçš„75%

-- æŸ¥çœ‹å½“å‰å€¼
SHOW effective_cache_size;
```

---

### 3.2 è¿žæŽ¥å‚æ•°

**max_connections**:

```sql
-- æŽ¨èå€¼ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚
max_connections = 100  -- ä¸­å°åž‹åº”ç”¨
max_connections = 500  -- å¤§åž‹åº”ç”¨ï¼ˆé…åˆPgBouncerï¼‰

-- è¶…è¿‡500å»ºè®®ä½¿ç”¨è¿žæŽ¥æ± ï¼ˆPgBouncerï¼‰
```

**è¿žæŽ¥æ± é…ç½®**:

```ini
# PgBounceré…ç½®ï¼ˆpgbouncer.iniï¼‰
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

---

### 3.3 æŸ¥è¯¢å‚æ•°

**random_page_cost**:

```sql
-- SSDï¼šæŽ¨èå€¼1.1-1.5
random_page_cost = 1.1

-- HDDï¼šé»˜è®¤å€¼4.0
random_page_cost = 4.0

-- æŸ¥çœ‹å½“å‰å€¼
SHOW random_page_cost;
```

**effective_io_concurrency**:

```sql
-- SSDï¼šæŽ¨èå€¼200
effective_io_concurrency = 200

-- HDDï¼šæŽ¨èå€¼2
effective_io_concurrency = 2

-- æŸ¥çœ‹å½“å‰å€¼
SHOW effective_io_concurrency;
```

---

## 4. è¡¨è®¾è®¡ä¼˜åŒ–

### 4.1 åˆ—é¡ºåºä¼˜åŒ–

**åŽŸåˆ™**: å›ºå®šé•¿åº¦åˆ—åœ¨å‰ï¼Œå¯å˜é•¿åº¦åˆ—åœ¨åŽ

```sql
-- âœ… æ­£ç¡®ï¼šå›ºå®šé•¿åº¦åˆ—åœ¨å‰
CREATE TABLE users (
    user_id BIGINT NOT NULL,        -- 8å­—èŠ‚ï¼Œå›ºå®š
    status CHAR(1) NOT NULL,        -- 1å­—èŠ‚ï¼Œå›ºå®š
    created_at TIMESTAMPTZ NOT NULL, -- 8å­—èŠ‚ï¼Œå›ºå®š
    username VARCHAR(50),           -- å¯å˜é•¿åº¦
    email VARCHAR(100),             -- å¯å˜é•¿åº¦
    bio TEXT                        -- å¯å˜é•¿åº¦
);

-- âŒ é”™è¯¯ï¼šå¯å˜é•¿åº¦åˆ—åœ¨å‰
CREATE TABLE users (
    bio TEXT,                       -- å¯å˜é•¿åº¦
    username VARCHAR(50),
    user_id BIGINT NOT NULL
);
```

---

### 4.2 å¡«å……å› å­ä¼˜åŒ–

**fillfactorå‚æ•°**:

```sql
-- é¢‘ç¹æ›´æ–°çš„è¡¨ï¼šé™ä½Žå¡«å……å› å­
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    status VARCHAR(20) DEFAULT 'pending',
    updated_at TIMESTAMPTZ DEFAULT NOW()
) WITH (fillfactor = 80);  -- é¢„ç•™20%ç©ºé—´ç”¨äºŽæ›´æ–°

-- åªè¯»è¡¨ï¼šæé«˜å¡«å……å› å­
CREATE TABLE order_archive (
    LIKE orders INCLUDING ALL
) WITH (fillfactor = 100);  -- 100%å¡«å……
```

---

## 5. åˆ†åŒºä¼˜åŒ–

### 5.1 åˆ†åŒºå‰ªæž

**ç¡®ä¿åˆ†åŒºå‰ªæžç”Ÿæ•ˆ**:

```sql
-- âœ… æ­£ç¡®ï¼šåˆ†åŒºé”®åœ¨WHEREæ¡ä»¶ä¸­
SELECT * FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-01-31';
-- ä»…æ‰«æç›¸å…³åˆ†åŒº

-- âŒ é”™è¯¯ï¼šä½¿ç”¨å‡½æ•°ï¼ˆåˆ†åŒºå‰ªæžå¤±æ•ˆï¼‰
SELECT * FROM sales
WHERE DATE_TRUNC('month', sale_date) = '2024-01-01';
-- æ‰«ææ‰€æœ‰åˆ†åŒº

-- âœ… ä¿®æ­£ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢
SELECT * FROM sales
WHERE sale_date >= '2024-01-01' AND sale_date < '2024-02-01';
```

---

### 5.2 åˆ†åŒºç´¢å¼•ç­–ç•¥

```sql
-- æ¯ä¸ªåˆ†åŒºè‡ªåŠ¨ç»§æ‰¿çˆ¶è¡¨ç´¢å¼•
CREATE INDEX idx_sales_customer ON sales(customer_id);
-- è‡ªåŠ¨åœ¨æ‰€æœ‰åˆ†åŒºåˆ›å»ºç´¢å¼•

-- åˆ†åŒºç‰¹å®šç´¢å¼•
CREATE INDEX idx_sales_2024_q1_date ON sales_2024_q1(sale_date);

-- BRINç´¢å¼•ï¼ˆæ—¶åºæ•°æ®ï¼‰
CREATE INDEX idx_sales_date_brin ON sales USING BRIN (sale_date);
```

---

## 6. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

### 6.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```sql
-- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders(customer_id, order_date);

-- æ›´æ–°æ•°æ®åº“æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- è‡ªåŠ¨åˆ†æžé…ç½®
ALTER TABLE orders SET (
    autovacuum_analyze_scale_factor = 0.05,  -- 5%å˜åŒ–æ—¶åˆ†æž
    autovacuum_analyze_threshold = 50       -- è‡³å°‘50è¡Œå˜åŒ–
);
```

---

### 6.2 ç»Ÿè®¡ä¿¡æ¯æŸ¥çœ‹

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup AS live_tuples,
    n_dead_tup AS dead_tuples,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC;

-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯
SELECT
    attname AS column_name,
    n_distinct AS distinct_values,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
  AND tablename = 'orders'
ORDER BY attname;
```

---

## 7. ç›¸å…³èµ„æº

- [ç´¢å¼•ç­–ç•¥](./ç´¢å¼•ç­–ç•¥.md) - ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
- [åˆ†åŒºç­–ç•¥](./åˆ†åŒºç­–ç•¥.md) - åˆ†åŒºä¼˜åŒ–ç­–ç•¥
- [æ•°æ®ç±»åž‹é€‰æ‹©](./æ•°æ®ç±»åž‹é€‰æ‹©.md) - æ•°æ®ç±»åž‹æ€§èƒ½å½±å“
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Performance Tips](https://www.postgresql.org/docs/current/performance-tips.html)

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
