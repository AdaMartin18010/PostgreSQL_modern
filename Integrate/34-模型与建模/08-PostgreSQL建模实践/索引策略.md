# PostgreSQLç´¢å¼•ç­–ç•¥å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQLå®˜æ–¹æ–‡æ¡£ + å®è·µæ€»ç»“
> **çŠ¶æ€**: åŸºäºPostgreSQL 17+/18+ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 08-02

---

## ğŸ“‘ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. ç´¢å¼•ç±»å‹](#2-ç´¢å¼•ç±»å‹)
  - [2.1 B-Treeç´¢å¼•](#21-b-treeç´¢å¼•)
  - [2.2 GINç´¢å¼•](#22-ginç´¢å¼•)
  - [2.3 GISTç´¢å¼•](#23-gistç´¢å¼•)
  - [2.4 BRINç´¢å¼•](#24-brinç´¢å¼•)
  - [2.5 SP-GISTç´¢å¼•](#25-sp-gistç´¢å¼•)
  - [2.6 Hashç´¢å¼•](#26-hashç´¢å¼•)
- [3. ç´¢å¼•é€‰æ‹©å†³ç­–](#3-ç´¢å¼•é€‰æ‹©å†³ç­–)
- [4. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ](#4-ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ)
- [5. ç´¢å¼•ç»´æŠ¤ä¸ä¼˜åŒ–](#5-ç´¢å¼•ç»´æŠ¤ä¸ä¼˜åŒ–)
- [6. å¸¸è§ç´¢å¼•æ¨¡å¼](#6-å¸¸è§ç´¢å¼•æ¨¡å¼)
- [7. ç´¢å¼•æ€§èƒ½è°ƒä¼˜](#7-ç´¢å¼•æ€§èƒ½è°ƒä¼˜)
- [8. ç›¸å…³èµ„æº](#8-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

PostgreSQLæä¾›äº†5ç§ä¸»è¦ç´¢å¼•ç±»å‹ï¼ˆB-Treeã€GINã€GISTã€BRINã€SP-GISTï¼‰ï¼Œæ¯ç§ç´¢å¼•ç±»å‹é’ˆå¯¹ä¸åŒçš„æŸ¥è¯¢æ¨¡å¼å’Œæ•°æ®ç‰¹æ€§ä¼˜åŒ–ã€‚
æ­£ç¡®é€‰æ‹©å’Œä½¿ç”¨ç´¢å¼•æ˜¯PostgreSQLæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚

---

## 2. ç´¢å¼•ç±»å‹

### 2.1 B-Treeç´¢å¼•

**å®šä¹‰**: æœ€å¸¸ç”¨çš„ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºå¤§å¤šæ•°æŸ¥è¯¢åœºæ™¯ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒç­‰å€¼æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢
- æ”¯æŒæ’åºï¼ˆORDER BYï¼‰
- æ”¯æŒå”¯ä¸€çº¦æŸ
- è‡ªåŠ¨åˆ›å»ºï¼ˆPRIMARY KEYã€UNIQUEçº¦æŸï¼‰

**æ—¶é—´å¤æ‚åº¦**: O(log n)

**å­˜å‚¨ç©ºé—´**: çº¦1.2Ã—æ•°æ®é‡

**é€‚ç”¨åœºæ™¯**:

- ç­‰å€¼æŸ¥è¯¢ï¼ˆWHERE column = valueï¼‰
- èŒƒå›´æŸ¥è¯¢ï¼ˆWHERE column BETWEEN ...ï¼‰
- æ’åºæŸ¥è¯¢ï¼ˆORDER BY columnï¼‰
- å”¯ä¸€æ€§çº¦æŸ

**PostgreSQLå®ç°**:

```sql
-- è‡ªåŠ¨åˆ›å»ºï¼ˆä¸»é”®ï¼‰
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,  -- è‡ªåŠ¨åˆ›å»ºB-Treeç´¢å¼•
    username VARCHAR(50) UNIQUE,     -- è‡ªåŠ¨åˆ›å»ºB-Treeç´¢å¼•
    email VARCHAR(100) UNIQUE
);

-- æ‰‹åŠ¨åˆ›å»º
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_users_name_email ON users(username, email);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆä»…ç´¢å¼•æ»¡è¶³æ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_active_users ON users(email) WHERE is_active = TRUE;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users(LOWER(email));

-- æ’åºç´¢å¼•ï¼ˆæ”¯æŒDESCæ’åºï¼‰
CREATE INDEX idx_users_created_desc ON users(created_at DESC);
```

**æ€§èƒ½å¯¹æ¯”**:

```sql
-- æ— ç´¢å¼•ï¼šå…¨è¡¨æ‰«æ O(n)
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
-- Seq Scan on users (cost=0.00..10000.00 rows=1 width=100)

-- æœ‰ç´¢å¼•ï¼šç´¢å¼•æ‰«æ O(log n)
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
-- Index Scan using idx_users_email (cost=0.42..8.44 rows=1 width=100)
```

---

### 2.2 GINç´¢å¼•

**å®šä¹‰**: Generalized Inverted Indexï¼Œå€’æ’ç´¢å¼•ï¼Œé€‚ç”¨äºæ•°ç»„ã€JSONBã€å…¨æ–‡æœç´¢ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒæ•°ç»„åŒ…å«æŸ¥è¯¢ï¼ˆ@>ã€&&ï¼‰
- æ”¯æŒJSONBè·¯å¾„æŸ¥è¯¢
- æ”¯æŒå…¨æ–‡æœç´¢ï¼ˆtsvectorï¼‰
- å†™å…¥æ€§èƒ½è¾ƒæ…¢ï¼ˆéœ€ç»´æŠ¤å€’æ’åˆ—è¡¨ï¼‰

**æ—¶é—´å¤æ‚åº¦**: O(k)ï¼Œkä¸ºå…³é”®è¯æ•°

**å­˜å‚¨ç©ºé—´**: çº¦0.5Ã—æ•°æ®é‡

**é€‚ç”¨åœºæ™¯**:

- JSONBå­—æ®µæŸ¥è¯¢
- æ•°ç»„åŒ…å«æŸ¥è¯¢
- å…¨æ–‡æœç´¢
- æ ‡ç­¾ç³»ç»Ÿ

**PostgreSQLå®ç°**:

```sql
-- JSONBç´¢å¼•
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    attributes JSONB,
    tags TEXT[]
);

-- GINç´¢å¼•JSONB
CREATE INDEX idx_products_attributes_gin ON products USING GIN (attributes);

-- GINç´¢å¼•æ•°ç»„
CREATE INDEX idx_products_tags_gin ON products USING GIN (tags);

-- JSONBè·¯å¾„ç´¢å¼•
CREATE INDEX idx_products_attributes_path ON products USING GIN ((attributes->'category'));

-- æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM products
WHERE attributes @> '{"color": "red"}';  -- GINç´¢å¼•åŠ é€Ÿ

SELECT * FROM products
WHERE tags @> ARRAY['electronics'];  -- GINç´¢å¼•åŠ é€Ÿ

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_products_name_fts ON products USING GIN (to_tsvector('english', name));

SELECT * FROM products
WHERE to_tsvector('english', name) @@ to_tsquery('laptop');
```

**æ€§èƒ½å¯¹æ¯”**:

```sql
-- æ— ç´¢å¼•ï¼šå…¨è¡¨æ‰«æ
EXPLAIN ANALYZE SELECT * FROM products WHERE attributes @> '{"color": "red"}';
-- Seq Scan on products (cost=0.00..50000.00 rows=1000 width=200)

-- æœ‰GINç´¢å¼•ï¼šç´¢å¼•æ‰«æ
EXPLAIN ANALYZE SELECT * FROM products WHERE attributes @> '{"color": "red"}';
-- Bitmap Index Scan on idx_products_attributes_gin (cost=0.00..100.00 rows=1000)
```

---

### 2.3 GISTç´¢å¼•

**å®šä¹‰**: Generalized Search Treeï¼Œé€šç”¨æœç´¢æ ‘ï¼Œé€‚ç”¨äºç©ºé—´æ•°æ®ã€èŒƒå›´ç±»å‹ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒç©ºé—´æŸ¥è¯¢ï¼ˆPostGISï¼‰
- æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆtsrangeã€int4rangeç­‰ï¼‰
- æ”¯æŒEXCLUDEçº¦æŸ
- æ”¯æŒKNNæŸ¥è¯¢ï¼ˆæœ€è¿‘é‚»ï¼‰

**æ—¶é—´å¤æ‚åº¦**: O(log n)

**å­˜å‚¨ç©ºé—´**: çº¦1.5Ã—æ•°æ®é‡

**é€‚ç”¨åœºæ™¯**:

- ç©ºé—´æ•°æ®æŸ¥è¯¢ï¼ˆPostGISï¼‰
- èŒƒå›´ç±»å‹æŸ¥è¯¢
- å…¨æ–‡æœç´¢ï¼ˆæ›¿ä»£GINï¼‰
- ç½‘ç»œåœ°å€æŸ¥è¯¢

**PostgreSQLå®ç°**:

```sql
-- å¯ç”¨PostGISæ‰©å±•
CREATE EXTENSION IF NOT EXISTS postgis;

CREATE TABLE locations (
    location_id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    geom_point GEOGRAPHY(POINT, 4326),
    geom_polygon GEOMETRY(POLYGON, 4326)
);

-- GISTç©ºé—´ç´¢å¼•
CREATE INDEX idx_locations_geom_point ON locations USING GIST (geom_point);
CREATE INDEX idx_locations_geom_polygon ON locations USING GIST (geom_polygon);

-- ç©ºé—´æŸ¥è¯¢
SELECT * FROM locations
WHERE ST_DWithin(
    geom_point,
    ST_GeogFromText('POINT(116.4074 39.9042)'),  -- åŒ—äº¬
    100000  -- 100å…¬é‡Œ
);

-- KNNæŸ¥è¯¢ï¼ˆæœ€è¿‘é‚»ï¼‰
SELECT *, ST_Distance(geom_point, ST_GeogFromText('POINT(116.4074 39.9042)')) AS distance
FROM locations
ORDER BY geom_point <-> ST_GeogFromText('POINT(116.4074 39.9042)')
LIMIT 10;

-- èŒƒå›´ç±»å‹ç´¢å¼•
CREATE TABLE bookings (
    booking_id BIGSERIAL PRIMARY KEY,
    room_id INT NOT NULL,
    booking_period TSRANGE NOT NULL,
    EXCLUDE USING GIST (
        room_id WITH =,
        booking_period WITH &&
    )
);

CREATE INDEX idx_bookings_period ON bookings USING GIST (booking_period);
```

---

### 2.4 BRINç´¢å¼•

**å®šä¹‰**: Block Range Indexï¼Œå—èŒƒå›´ç´¢å¼•ï¼Œé€‚ç”¨äºæœ‰åºæ•°æ®ã€‚

**ç‰¹ç‚¹**:

- ç´¢å¼•æå°ï¼ˆçº¦0.01%æ•°æ®é‡ï¼‰
- å†™å…¥æ€§èƒ½æå¿«ï¼ˆä»…æ›´æ–°å…ƒæ•°æ®ï¼‰
- é€‚ç”¨äºé¡ºåºæ•°æ®ï¼ˆæ—¶é—´åºåˆ—ã€è‡ªå¢IDï¼‰
- æŸ¥è¯¢æ€§èƒ½å–å†³äºæ•°æ®å±€éƒ¨æ€§

**æ—¶é—´å¤æ‚åº¦**: O(n/block_range)

**å­˜å‚¨ç©ºé—´**: çº¦0.01%æ•°æ®é‡ï¼ˆæå°ï¼‰

**é€‚ç”¨åœºæ™¯**:

- æ—¶é—´åºåˆ—æ•°æ®
- è‡ªå¢IDèŒƒå›´æŸ¥è¯¢
- é¡ºåºå†™å…¥çš„æ•°æ®
- å¤§è¡¨ï¼ˆTBçº§ï¼‰çš„ç²—ç²’åº¦ç´¢å¼•

**PostgreSQLå®ç°**:

```sql
-- æ—¶é—´åºåˆ—è¡¨
CREATE TABLE sensor_readings (
    reading_id BIGSERIAL PRIMARY KEY,
    device_id INT NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    value DOUBLE PRECISION NOT NULL
);

-- BRINç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰
CREATE INDEX idx_readings_timestamp_brin ON sensor_readings USING BRIN (timestamp);

-- BRINç´¢å¼•ï¼ˆè‡ªå¢IDï¼‰
CREATE INDEX idx_readings_id_brin ON sensor_readings USING BRIN (reading_id);

-- è‡ªå®šä¹‰å—èŒƒå›´å¤§å°ï¼ˆé»˜è®¤128é¡µï¼‰
CREATE INDEX idx_readings_timestamp_brin_custom ON sensor_readings
USING BRIN (timestamp) WITH (pages_per_range = 64);

-- æŸ¥è¯¢ç¤ºä¾‹ï¼ˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
SELECT * FROM sensor_readings
WHERE timestamp BETWEEN '2024-01-01' AND '2024-01-31'
  AND device_id = 123;
```

**æ€§èƒ½å¯¹æ¯”**:

```sql
-- B-Treeç´¢å¼•ï¼š12GBï¼ˆ1äº¿è¡Œæ•°æ®ï¼‰
CREATE INDEX idx_readings_timestamp_btree ON sensor_readings USING BTREE (timestamp);
-- ç´¢å¼•å¤§å°ï¼š12GB

-- BRINç´¢å¼•ï¼š1.2MBï¼ˆ1äº¿è¡Œæ•°æ®ï¼‰
CREATE INDEX idx_readings_timestamp_brin ON sensor_readings USING BRIN (timestamp);
-- ç´¢å¼•å¤§å°ï¼š1.2MBï¼ˆå°10000å€ï¼‰

-- å†™å…¥æ€§èƒ½å¯¹æ¯”
-- B-Treeï¼šæ¯æ¬¡INSERTæ›´æ–°12GBç´¢å¼• -> 5ms
-- BRINï¼šä»…æ›´æ–°å…ƒæ•°æ® -> 0.1msï¼ˆå¿«50å€ï¼‰
```

---

### 2.5 SP-GISTç´¢å¼•

**å®šä¹‰**: Space-Partitioned GISTï¼Œç©ºé—´åˆ†åŒºGISTï¼Œé€‚ç”¨äºéå¹³è¡¡æ ‘ç»“æ„ã€‚

**ç‰¹ç‚¹**:

- æ”¯æŒéå¹³è¡¡æ•°æ®ç»“æ„
- é€‚ç”¨äºç‚¹ã€èŒƒå›´ã€æ–‡æœ¬ç­‰ç±»å‹
- æ€§èƒ½ä»‹äºGISTå’ŒGINä¹‹é—´

**é€‚ç”¨åœºæ™¯**:

- ç‚¹æ•°æ®ï¼ˆéç©ºé—´ï¼‰
- IPåœ°å€èŒƒå›´
- æ–‡æœ¬å‰ç¼€åŒ¹é…

**PostgreSQLå®ç°**:

```sql
-- IPåœ°å€èŒƒå›´ç´¢å¼•
CREATE TABLE ip_ranges (
    range_id BIGSERIAL PRIMARY KEY,
    network_name TEXT NOT NULL,
    ip_range INET NOT NULL
);

CREATE INDEX idx_ip_ranges_spgist ON ip_ranges USING SPGIST (ip_range);

-- æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM ip_ranges
WHERE ip_range >>= '192.168.1.100';  -- åŒ…å«æŸ¥è¯¢
```

---

### 2.6 Hashç´¢å¼•

**å®šä¹‰**: å“ˆå¸Œç´¢å¼•ï¼Œä»…æ”¯æŒç­‰å€¼æŸ¥è¯¢ã€‚

**ç‰¹ç‚¹**:

- ä»…æ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼ˆ=ï¼‰
- ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€æ’åº
- å†™å…¥æ€§èƒ½å¿«
- ä¸å¸¸ç”¨ï¼ˆB-Treeå·²è¶³å¤Ÿå¥½ï¼‰

**æ—¶é—´å¤æ‚åº¦**: O(1)

**å­˜å‚¨ç©ºé—´**: çº¦1.0Ã—æ•°æ®é‡

**é€‚ç”¨åœºæ™¯**:

- ä»…ç­‰å€¼æŸ¥è¯¢çš„åœºæ™¯
- é«˜å¹¶å‘å†™å…¥åœºæ™¯

**PostgreSQLå®ç°**:

```sql
CREATE INDEX idx_users_email_hash ON users USING HASH (email);

-- ä»…æ”¯æŒç­‰å€¼æŸ¥è¯¢
SELECT * FROM users WHERE email = 'test@example.com';  -- âœ… ä½¿ç”¨Hashç´¢å¼•
SELECT * FROM users WHERE email > 'test@example.com';   -- âŒ ä¸ä½¿ç”¨Hashç´¢å¼•
```

---

## 3. ç´¢å¼•é€‰æ‹©å†³ç­–

### 3.1 ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘

```mermaid
graph TD
    A[é€‰æ‹©ç´¢å¼•ç±»å‹] --> B{æŸ¥è¯¢ç±»å‹?}
    B -->|ç­‰å€¼/èŒƒå›´æŸ¥è¯¢| C[B-Tree]
    B -->|æ•°ç»„/JSONBæŸ¥è¯¢| D{GIN}
    B -->|ç©ºé—´æŸ¥è¯¢| E{GIST}
    B -->|æ—¶é—´åºåˆ—| F{æ•°æ®æœ‰åº?}
    F -->|æ˜¯| G[BRIN]
    F -->|å¦| C
    B -->|ä»…ç­‰å€¼æŸ¥è¯¢| H[Hash]
```

---

### 3.2 ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ

| ç´¢å¼•ç±»å‹ | ç­‰å€¼æŸ¥è¯¢ | èŒƒå›´æŸ¥è¯¢ | æ•°ç»„æŸ¥è¯¢ | JSONBæŸ¥è¯¢ | ç©ºé—´æŸ¥è¯¢ | å­˜å‚¨ç©ºé—´ | å†™å…¥æ€§èƒ½ |
|---------|---------|---------|---------|----------|---------|---------|---------|
| **B-Tree** | âœ… ä¼˜ç§€ | âœ… ä¼˜ç§€ | âŒ | âŒ | âŒ | 1.2Ã— | è‰¯å¥½ |
| **GIN** | âš ï¸ ä¸€èˆ¬ | âŒ | âœ… ä¼˜ç§€ | âœ… ä¼˜ç§€ | âŒ | 0.5Ã— | è¾ƒæ…¢ |
| **GIST** | âš ï¸ ä¸€èˆ¬ | âœ… è‰¯å¥½ | âŒ | âŒ | âœ… ä¼˜ç§€ | 1.5Ã— | è‰¯å¥½ |
| **BRIN** | âš ï¸ ä¸€èˆ¬ | âœ… è‰¯å¥½ | âŒ | âŒ | âŒ | 0.01Ã— | æå¿« |
| **Hash** | âœ… ä¼˜ç§€ | âŒ | âŒ | âŒ | âŒ | 1.0Ã— | è‰¯å¥½ |

---

## 4. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ

### 4.1 ç´¢å¼•è®¾è®¡åŸåˆ™

**åŸåˆ™1: ä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•**

```sql
-- âœ… æ­£ç¡®ï¼šæŸ¥è¯¢é¢‘ç¹çš„åˆ—
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_date ON orders(order_date);

-- âŒ é”™è¯¯ï¼šå¾ˆå°‘æŸ¥è¯¢çš„åˆ—
CREATE INDEX idx_orders_notes ON orders(notes);  -- å¾ˆå°‘æŸ¥è¯¢
```

---

**åŸåˆ™2: å¤åˆç´¢å¼•åˆ—é¡ºåº**

```sql
-- æŸ¥è¯¢ï¼šWHERE customer_id = ? AND order_date BETWEEN ? AND ?
-- âœ… æ­£ç¡®ï¼šé«˜é€‰æ‹©æ€§åˆ—åœ¨å‰
CREATE INDEX idx_orders_customer_date ON orders(customer_id, order_date);

-- âŒ é”™è¯¯ï¼šä½é€‰æ‹©æ€§åˆ—åœ¨å‰
CREATE INDEX idx_orders_date_customer ON orders(order_date, customer_id);
```

---

**åŸåˆ™3: ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å‡å°‘ç´¢å¼•å¤§å°**

```sql
-- âœ… æ­£ç¡®ï¼šä»…ç´¢å¼•æ´»è·ƒè®¢å•
CREATE INDEX idx_orders_active ON orders(customer_id)
WHERE status IN ('pending', 'processing');

-- âŒ é”™è¯¯ï¼šç´¢å¼•æ‰€æœ‰è®¢å•
CREATE INDEX idx_orders_all ON orders(customer_id);
```

---

**åŸåˆ™4: ä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•æ”¯æŒå‡½æ•°æŸ¥è¯¢**

```sql
-- âœ… æ­£ç¡®ï¼šæ”¯æŒå¤§å°å†™ä¸æ•æ„ŸæŸ¥è¯¢
CREATE INDEX idx_users_email_lower ON users(LOWER(email));

-- æŸ¥è¯¢
SELECT * FROM users WHERE LOWER(email) = LOWER('Test@Example.com');
```

---

### 4.2 ç´¢å¼•å‘½åè§„èŒƒ

**å‘½åæ ¼å¼**: `idx_è¡¨å_åˆ—å_ç±»å‹`

**ç¤ºä¾‹**:

```sql
-- B-Treeç´¢å¼•ï¼ˆé»˜è®¤ï¼Œå¯ä¸æ ‡æ³¨ï¼‰
CREATE INDEX idx_users_email ON users(email);

-- GINç´¢å¼•
CREATE INDEX idx_products_tags_gin ON products USING GIN (tags);

-- GISTç´¢å¼•
CREATE INDEX idx_locations_geom_gist ON locations USING GIST (geom_point);

-- BRINç´¢å¼•
CREATE INDEX idx_readings_timestamp_brin ON sensor_readings USING BRIN (timestamp);
```

---

## 5. ç´¢å¼•ç»´æŠ¤ä¸ä¼˜åŒ–

### 5.1 ç´¢å¼•ç»´æŠ¤

**é‡å»ºç´¢å¼•**:

```sql
-- é‡å»ºç´¢å¼•ï¼ˆå›æ”¶ç©ºé—´ï¼‰
REINDEX INDEX idx_users_email;

-- é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE users;

-- é‡å»ºæ•°æ®åº“çš„æ‰€æœ‰ç´¢å¼•
REINDEX DATABASE mydb;
```

---

**ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**:

```sql
-- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå½±å“æŸ¥è¯¢è®¡åˆ’ï¼‰
ANALYZE users;

-- æ›´æ–°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
ANALYZE users(email);
```

---

**ç´¢å¼•è†¨èƒ€æ£€æŸ¥**:

```sql
-- æ£€æŸ¥ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

---

### 5.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**ç­–ç•¥1: åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•**

```sql
-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND schemaname = 'public';
```

---

**ç­–ç•¥2: åˆå¹¶é‡å¤ç´¢å¼•**

```sql
-- âŒ é”™è¯¯ï¼šé‡å¤ç´¢å¼•
CREATE INDEX idx_users_email1 ON users(email);
CREATE INDEX idx_users_email2 ON users(email);

-- âœ… æ­£ç¡®ï¼šåªä¿ç•™ä¸€ä¸ª
CREATE INDEX idx_users_email ON users(email);
```

---

**ç­–ç•¥3: ä½¿ç”¨è¦†ç›–ç´¢å¼•**

```sql
-- è¦†ç›–ç´¢å¼•ï¼šç´¢å¼•åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—
CREATE INDEX idx_orders_covering ON orders(customer_id, order_date, total_amount);

-- æŸ¥è¯¢ä»…éœ€æ‰«æç´¢å¼•ï¼Œæ— éœ€è®¿é—®è¡¨
SELECT customer_id, order_date, total_amount
FROM orders
WHERE customer_id = 123;
```

---

## 6. å¸¸è§ç´¢å¼•æ¨¡å¼

### 6.1 æ—¶é—´åºåˆ—ç´¢å¼•æ¨¡å¼

```sql
-- æ¨¡å¼ï¼šBRIN + B-Treeå¤åˆ
CREATE TABLE time_series_data (
    id BIGSERIAL,
    timestamp TIMESTAMPTZ NOT NULL,
    device_id INT NOT NULL,
    value DOUBLE PRECISION
);

-- BRINç´¢å¼•ï¼šæ—¶é—´èŒƒå›´æŸ¥è¯¢
CREATE INDEX idx_ts_timestamp_brin ON time_series_data USING BRIN (timestamp);

-- B-Treeç´¢å¼•ï¼šè®¾å¤‡æŸ¥è¯¢
CREATE INDEX idx_ts_device ON time_series_data(device_id);

-- å¤åˆæŸ¥è¯¢ï¼šæ—¶é—´èŒƒå›´ + è®¾å¤‡
CREATE INDEX idx_ts_device_timestamp ON time_series_data(device_id, timestamp);
```

---

### 6.2 JSONBç´¢å¼•æ¨¡å¼

```sql
-- æ¨¡å¼ï¼šGIN + è¡¨è¾¾å¼ç´¢å¼•
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    attributes JSONB
);

-- GINç´¢å¼•ï¼šé€šç”¨JSONBæŸ¥è¯¢
CREATE INDEX idx_products_attrs_gin ON products USING GIN (attributes);

-- è¡¨è¾¾å¼ç´¢å¼•ï¼šç‰¹å®šè·¯å¾„æŸ¥è¯¢
CREATE INDEX idx_products_category ON products ((attributes->>'category'));
CREATE INDEX idx_products_price ON products ((attributes->>'price')::NUMERIC);
```

---

### 6.3 å…¨æ–‡æœç´¢ç´¢å¼•æ¨¡å¼

```sql
-- æ¨¡å¼ï¼šGIN + tsvector
CREATE TABLE articles (
    article_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL
);

-- GINå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_articles_title_fts ON articles USING GIN (to_tsvector('english', title));
CREATE INDEX idx_articles_content_fts ON articles USING GIN (to_tsvector('english', content));

-- æŸ¥è¯¢
SELECT * FROM articles
WHERE to_tsvector('english', title || ' ' || content) @@ to_tsquery('postgresql & performance');
```

---

## 7. ç´¢å¼•æ€§èƒ½è°ƒä¼˜

### 7.1 ç´¢å¼•å‚æ•°è°ƒä¼˜

**B-Treeå‚æ•°**:

```sql
-- fillfactorï¼šæ§åˆ¶ç´¢å¼•é¡µå¡«å……ç‡ï¼ˆé»˜è®¤90%ï¼‰
CREATE INDEX idx_users_email ON users(email) WITH (fillfactor = 80);
```

---

**BRINå‚æ•°**:

```sql
-- pages_per_rangeï¼šæ§åˆ¶å—èŒƒå›´å¤§å°ï¼ˆé»˜è®¤128é¡µï¼‰
CREATE INDEX idx_readings_timestamp_brin ON sensor_readings
USING BRIN (timestamp) WITH (pages_per_range = 64);
```

---

### 7.2 æŸ¥è¯¢è®¡åˆ’åˆ†æ

```sql
-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- è¾“å‡ºç¤ºä¾‹ï¼š
-- Index Scan using idx_users_email on users
--   (cost=0.42..8.44 rows=1 width=100)
--   (actual time=0.123..0.125 rows=1 loops=1)
--   Index Cond: (email = 'test@example.com'::text)
```

---

## 8. ç›¸å…³èµ„æº

- [æ•°æ®ç±»å‹é€‰æ‹©](./æ•°æ®ç±»å‹é€‰æ‹©.md) - æ•°æ®ç±»å‹ä¸ç´¢å¼•é€‰æ‹©
- [åˆ†åŒºç­–ç•¥](./åˆ†åŒºç­–ç•¥.md) - åˆ†åŒºè¡¨ç´¢å¼•ç­–ç•¥
- [æ€§èƒ½ä¼˜åŒ–](./æ€§èƒ½ä¼˜åŒ–.md) - æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Indexes](https://www.postgresql.org/docs/current/indexes.html)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
