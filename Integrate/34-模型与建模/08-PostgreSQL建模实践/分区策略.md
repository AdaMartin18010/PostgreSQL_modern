# PostgreSQLåˆ†åŒºç­–ç•¥å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQLå®˜æ–¹æ–‡æ¡£ + å®žè·µæ€»ç»“
> **çŠ¶æ€**: åŸºäºŽPostgreSQL 17+/18+ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 08-03

---

## ðŸ“‘ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. åˆ†åŒºç±»åž‹](#2-åˆ†åŒºç±»åž‹)
  - [2.1 RANGEåˆ†åŒº](#21-rangeåˆ†åŒº)
  - [2.2 LISTåˆ†åŒº](#22-liståˆ†åŒº)
  - [2.3 HASHåˆ†åŒº](#23-hashåˆ†åŒº)
- [3. åˆ†åŒºè®¾è®¡å†³ç­–](#3-åˆ†åŒºè®¾è®¡å†³ç­–)
- [4. åˆ†åŒºç®¡ç†](#4-åˆ†åŒºç®¡ç†)
- [5. åˆ†åŒºæ€§èƒ½ä¼˜åŒ–](#5-åˆ†åŒºæ€§èƒ½ä¼˜åŒ–)
- [6. åˆ†åŒºæœ€ä½³å®žè·µ](#6-åˆ†åŒºæœ€ä½³å®žè·µ)
- [7. å¸¸è§åˆ†åŒºæ¨¡å¼](#7-å¸¸è§åˆ†åŒºæ¨¡å¼)
- [8. ç›¸å…³èµ„æº](#8-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

PostgreSQLæ”¯æŒå£°æ˜Žå¼åˆ†åŒºï¼ˆDeclarative Partitioningï¼‰ï¼Œå¯ä»¥å°†å¤§è¡¨åˆ†å‰²æˆå¤šä¸ªè¾ƒå°çš„åˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€ç®€åŒ–æ•°æ®ç®¡ç†ã€‚
åˆ†åŒºç­–ç•¥çš„é€‰æ‹©ç›´æŽ¥å½±å“æ•°æ®åº“æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## 2. åˆ†åŒºç±»åž‹

### 2.1 RANGEåˆ†åŒº

**å®šä¹‰**: æŒ‰èŒƒå›´åˆ†åŒºï¼Œé€‚ç”¨äºŽæœ‰åºæ•°æ®ï¼ˆæ—¥æœŸã€æ•°å€¼ï¼‰ã€‚

**ç‰¹ç‚¹**:

- é€‚ç”¨äºŽæ—¶é—´åºåˆ—æ•°æ®
- æ”¯æŒåˆ†åŒºå‰ªæžï¼ˆPartition Pruningï¼‰
- æ˜“äºŽæ•°æ®å½’æ¡£

**PostgreSQLå®žçŽ°**:

```sql
-- æŒ‰æ—¥æœŸèŒƒå›´åˆ†åŒº
CREATE TABLE sales (
    sale_id BIGSERIAL,
    sale_date DATE NOT NULL,
    customer_id INT NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    PRIMARY KEY (sale_id, sale_date)
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2024_q1 PARTITION OF sales
    FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');

CREATE TABLE sales_2024_q2 PARTITION OF sales
    FOR VALUES FROM ('2024-04-01') TO ('2024-07-01');

CREATE TABLE sales_2024_q3 PARTITION OF sales
    FOR VALUES FROM ('2024-07-01') TO ('2024-10-01');

CREATE TABLE sales_2024_q4 PARTITION OF sales
    FOR VALUES FROM ('2024-10-01') TO ('2025-01-01');

-- é»˜è®¤åˆ†åŒºï¼ˆå¯é€‰ï¼Œæ•èŽ·ä¸åŒ¹é…çš„æ•°æ®ï¼‰
CREATE TABLE sales_default PARTITION OF sales DEFAULT;

-- æŒ‰æ•°å€¼èŒƒå›´åˆ†åŒº
CREATE TABLE orders (
    order_id BIGSERIAL,
    order_number INT NOT NULL,
    customer_id INT NOT NULL,
    PRIMARY KEY (order_id, order_number)
) PARTITION BY RANGE (order_number);

CREATE TABLE orders_low PARTITION OF orders
    FOR VALUES FROM (1) TO (1000000);

CREATE TABLE orders_mid PARTITION OF orders
    FOR VALUES FROM (1000000) TO (10000000);

CREATE TABLE orders_high PARTITION OF orders
    FOR VALUES FROM (10000000) TO (MAXVALUE);
```

**æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- åˆ†åŒºå‰ªæžï¼šä»…æ‰«æç›¸å…³åˆ†åŒº
EXPLAIN ANALYZE SELECT * FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-01-31';
-- ä»…æ‰«æ sales_2024_q1 åˆ†åŒº

-- è·¨åˆ†åŒºæŸ¥è¯¢
EXPLAIN ANALYZE SELECT * FROM sales
WHERE sale_date BETWEEN '2024-03-01' AND '2024-05-01';
-- æ‰«æ sales_2024_q1 å’Œ sales_2024_q2 åˆ†åŒº
```

---

### 2.2 LISTåˆ†åŒº

**å®šä¹‰**: æŒ‰åˆ—è¡¨å€¼åˆ†åŒºï¼Œé€‚ç”¨äºŽç¦»æ•£å€¼ï¼ˆåœ°åŒºã€çŠ¶æ€ï¼‰ã€‚

**ç‰¹ç‚¹**:

- é€‚ç”¨äºŽåˆ†ç±»æ•°æ®
- æ”¯æŒæžšä¸¾å€¼åˆ†åŒº
- çµæ´»çš„åˆ†åŒºç­–ç•¥

**PostgreSQLå®žçŽ°**:

```sql
-- æŒ‰åœ°åŒºåˆ†åŒº
CREATE TABLE customers (
    customer_id BIGSERIAL,
    region VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    PRIMARY KEY (customer_id, region)
) PARTITION BY LIST (region);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE customers_north PARTITION OF customers
    FOR VALUES IN ('Beijing', 'Tianjin', 'Hebei');

CREATE TABLE customers_south PARTITION OF customers
    FOR VALUES IN ('Guangdong', 'Guangxi', 'Hainan');

CREATE TABLE customers_east PARTITION OF customers
    FOR VALUES IN ('Shanghai', 'Jiangsu', 'Zhejiang');

CREATE TABLE customers_west PARTITION OF customers
    FOR VALUES IN ('Sichuan', 'Chongqing', 'Yunnan');

-- é»˜è®¤åˆ†åŒº
CREATE TABLE customers_other PARTITION OF customers DEFAULT;

-- æŒ‰çŠ¶æ€åˆ†åŒº
CREATE TABLE orders (
    order_id BIGSERIAL,
    status VARCHAR(20) NOT NULL,
    order_date DATE NOT NULL,
    PRIMARY KEY (order_id, status)
) PARTITION BY LIST (status);

CREATE TABLE orders_active PARTITION OF orders
    FOR VALUES IN ('pending', 'processing', 'shipping');

CREATE TABLE orders_completed PARTITION OF orders
    FOR VALUES IN ('delivered', 'completed');

CREATE TABLE orders_cancelled PARTITION OF orders
    FOR VALUES IN ('cancelled', 'refunded');
```

---

### 2.3 HASHåˆ†åŒº

**å®šä¹‰**: æŒ‰å“ˆå¸Œå€¼åˆ†åŒºï¼Œé€‚ç”¨äºŽå‡åŒ€åˆ†å¸ƒæ•°æ®ã€‚

**ç‰¹ç‚¹**:

- æ•°æ®å‡åŒ€åˆ†å¸ƒ
- é€‚ç”¨äºŽæ— è‡ªç„¶åˆ†åŒºé”®çš„æ•°æ®
- æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢

**PostgreSQLå®žçŽ°**:

```sql
-- æŒ‰å“ˆå¸Œåˆ†åŒº
CREATE TABLE users (
    user_id BIGSERIAL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    PRIMARY KEY (user_id)
) PARTITION BY HASH (user_id);

-- åˆ›å»º4ä¸ªå“ˆå¸Œåˆ†åŒº
CREATE TABLE users_0 PARTITION OF users
    FOR VALUES WITH (MODULUS 4, REMAINDER 0);

CREATE TABLE users_1 PARTITION OF users
    FOR VALUES WITH (MODULUS 4, REMAINDER 1);

CREATE TABLE users_2 PARTITION OF users
    FOR VALUES WITH (MODULUS 4, REMAINDER 2);

CREATE TABLE users_3 PARTITION OF users
    FOR VALUES WITH (MODULUS 4, REMAINDER 3);

-- å¤åˆåˆ†åŒºé”®å“ˆå¸Œ
CREATE TABLE events (
    event_id BIGSERIAL,
    user_id INT NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    event_time TIMESTAMPTZ NOT NULL,
    PRIMARY KEY (event_id, user_id)
) PARTITION BY HASH (user_id, event_type);
```

---

## 3. åˆ†åŒºè®¾è®¡å†³ç­–

### 3.1 åˆ†åŒºé”®é€‰æ‹©

**é€‰æ‹©åŽŸåˆ™**:

1. **æŸ¥è¯¢æ¨¡å¼**: é€‰æ‹©WHEREå­å¥ä¸­é¢‘ç¹ä½¿ç”¨çš„åˆ—
2. **æ•°æ®åˆ†å¸ƒ**: ç¡®ä¿æ•°æ®å‡åŒ€åˆ†å¸ƒ
3. **æ—¶é—´ç‰¹æ€§**: æ—¶é—´åºåˆ—æ•°æ®ä¼˜å…ˆé€‰æ‹©æ—¶é—´åˆ—

**ç¤ºä¾‹**:

```sql
-- âœ… æ­£ç¡®ï¼šæŸ¥è¯¢é¢‘ç¹ä½¿ç”¨sale_date
CREATE TABLE sales (
    sale_id BIGSERIAL,
    sale_date DATE NOT NULL,  -- åˆ†åŒºé”®
    customer_id INT NOT NULL,
    amount NUMERIC(10,2)
) PARTITION BY RANGE (sale_date);

-- âŒ é”™è¯¯ï¼šåˆ†åŒºé”®ä¸åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­
CREATE TABLE sales (
    sale_id BIGSERIAL,
    sale_date DATE NOT NULL,
    customer_id INT NOT NULL,  -- åˆ†åŒºé”®ï¼Œä½†æŸ¥è¯¢å¾ˆå°‘ç”¨
    amount NUMERIC(10,2)
) PARTITION BY HASH (customer_id);
```

---

### 3.2 åˆ†åŒºæ•°é‡å†³ç­–

**åŽŸåˆ™**:

- **å¤ªå°‘**: åˆ†åŒºè¿‡å¤§ï¼Œæ€§èƒ½æå‡æœ‰é™
- **å¤ªå¤š**: å…ƒæ•°æ®å¼€é”€å¤§ï¼ŒæŸ¥è¯¢è®¡åˆ’ç”Ÿæˆæ…¢
- **æŽ¨è**: 100-1000ä¸ªåˆ†åŒºï¼ˆå–å†³äºŽæ•°æ®é‡ï¼‰

**ç¤ºä¾‹**:

```sql
-- âœ… æ­£ç¡®ï¼šæŒ‰å­£åº¦åˆ†åŒºï¼ˆæ¯å¹´4ä¸ªåˆ†åŒºï¼‰
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);

-- ä¿ç•™3å¹´æ•°æ® = 12ä¸ªåˆ†åŒºï¼ˆåˆç†ï¼‰

-- âŒ é”™è¯¯ï¼šæŒ‰å¤©åˆ†åŒºï¼ˆ3650ä¸ªåˆ†åŒºï¼Œè¿‡å¤šï¼‰
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);

-- ä¿ç•™10å¹´æ•°æ® = 3650ä¸ªåˆ†åŒºï¼ˆè¿‡å¤šï¼‰
```

---

### 3.3 åˆ†åŒºå¤§å°å†³ç­–

**åŽŸåˆ™**:

- **å°åˆ†åŒº**: æŸ¥è¯¢å¿«ï¼Œä½†åˆ†åŒºæ•°é‡å¤š
- **å¤§åˆ†åŒº**: åˆ†åŒºæ•°é‡å°‘ï¼Œä½†æŸ¥è¯¢æ…¢
- **æŽ¨è**: æ¯ä¸ªåˆ†åŒº1-10GBï¼ˆå–å†³äºŽç¡¬ä»¶ï¼‰

**ç¤ºä¾‹**:

```sql
-- âœ… æ­£ç¡®ï¼šæŒ‰æœˆåˆ†åŒºï¼ˆæ¯åˆ†åŒºçº¦5GBï¼‰
CREATE TABLE sensor_data (
    timestamp TIMESTAMPTZ NOT NULL,
    device_id INT NOT NULL,
    value DOUBLE PRECISION
) PARTITION BY RANGE (timestamp);

CREATE TABLE sensor_data_202401 PARTITION OF sensor_data
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
-- æ¯æœˆçº¦1000ä¸‡æ¡è®°å½•ï¼Œçº¦5GB

-- âš ï¸ è­¦å‘Šï¼šæŒ‰å¹´åˆ†åŒºï¼ˆæ¯åˆ†åŒºçº¦60GBï¼Œè¿‡å¤§ï¼‰
CREATE TABLE sensor_data_2024 PARTITION OF sensor_data
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
-- æ¯å¹´çº¦1.2äº¿æ¡è®°å½•ï¼Œçº¦60GBï¼ˆæŸ¥è¯¢æ…¢ï¼‰
```

---

## 4. åˆ†åŒºç®¡ç†

### 4.1 æ·»åŠ åˆ†åŒº

```sql
-- æ·»åŠ æ–°åˆ†åŒº
CREATE TABLE sales_2025_q1 PARTITION OF sales
    FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

-- ä½¿ç”¨å‡½æ•°è‡ªåŠ¨åˆ›å»ºåˆ†åŒº
CREATE OR REPLACE FUNCTION create_monthly_partition(
    table_name TEXT,
    start_date DATE
) RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := table_name || '_' || TO_CHAR(start_date, 'YYYY_MM');
    end_date := start_date + INTERVAL '1 month';

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
        partition_name,
        table_name,
        start_date,
        end_date
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT create_monthly_partition('sales', '2025-01-01');
```

---

### 4.2 åˆ é™¤åˆ†åŒº

```sql
-- åˆ é™¤åˆ†åŒºï¼ˆæ•°æ®ä¹Ÿåˆ é™¤ï¼‰
DROP TABLE sales_2024_q1;

-- åˆ†ç¦»åˆ†åŒºï¼ˆä¿ç•™æ•°æ®ï¼Œä½†ä¸å±žäºŽçˆ¶è¡¨ï¼‰
ALTER TABLE sales DETACH PARTITION sales_2024_q1;

-- åˆ†ç¦»åŽå¯ä»¥å•ç‹¬ç®¡ç†
ALTER TABLE sales_2024_q1 RENAME TO sales_2024_q1_archive;
```

---

### 4.3 åˆå¹¶åˆ†åŒº

```sql
-- PostgreSQLä¸æ”¯æŒç›´æŽ¥åˆå¹¶åˆ†åŒºï¼Œéœ€è¦ï¼š
-- 1. åˆ›å»ºæ–°åˆ†åŒº
CREATE TABLE sales_2024_h1 PARTITION OF sales
    FOR VALUES FROM ('2024-01-01') TO ('2024-07-01');

-- 2. è¿ç§»æ•°æ®
INSERT INTO sales_2024_h1
SELECT * FROM sales_2024_q1
UNION ALL
SELECT * FROM sales_2024_q2;

-- 3. åˆ é™¤æ—§åˆ†åŒº
DROP TABLE sales_2024_q1;
DROP TABLE sales_2024_q2;
```

---

### 4.4 åˆ†åŒºç»´æŠ¤

```sql
-- æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename LIKE 'sales_%'
ORDER BY tablename;

-- æŸ¥çœ‹åˆ†åŒºé”®ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_get_partkeydef(tableoid::regclass) AS partition_key
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename = 'sales';

-- æŸ¥çœ‹åˆ†åŒºçº¦æŸ
SELECT
    conname AS constraint_name,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'sales'::regclass;
```

---

## 5. åˆ†åŒºæ€§èƒ½ä¼˜åŒ–

### 5.1 åˆ†åŒºå‰ªæžï¼ˆPartition Pruningï¼‰

**å®šä¹‰**: æŸ¥è¯¢æ—¶è‡ªåŠ¨æŽ’é™¤ä¸ç›¸å…³çš„åˆ†åŒºã€‚

**ç¤ºä¾‹**:

```sql
-- âœ… æ­£ç¡®ï¼šåˆ†åŒºå‰ªæžç”Ÿæ•ˆ
EXPLAIN ANALYZE SELECT * FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-01-31';
-- ä»…æ‰«æ sales_2024_q1 åˆ†åŒº

-- âŒ é”™è¯¯ï¼šåˆ†åŒºå‰ªæžå¤±æ•ˆï¼ˆå‡½æ•°è°ƒç”¨ï¼‰
EXPLAIN ANALYZE SELECT * FROM sales
WHERE DATE_TRUNC('month', sale_date) = '2024-01-01';
-- æ‰«ææ‰€æœ‰åˆ†åŒºï¼ˆå…¨è¡¨æ‰«æï¼‰

-- âœ… ä¿®æ­£ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢
EXPLAIN ANALYZE SELECT * FROM sales
WHERE sale_date >= '2024-01-01' AND sale_date < '2024-02-01';
-- åˆ†åŒºå‰ªæžç”Ÿæ•ˆ
```

---

### 5.2 åˆ†åŒºç´¢å¼•ç­–ç•¥

```sql
-- æ¯ä¸ªåˆ†åŒºè‡ªåŠ¨ç»§æ‰¿çˆ¶è¡¨ç´¢å¼•
CREATE INDEX idx_sales_customer ON sales(customer_id);
-- è‡ªåŠ¨åœ¨æ‰€æœ‰åˆ†åŒºåˆ›å»ºç´¢å¼•

-- åˆ†åŒºç‰¹å®šç´¢å¼•
CREATE INDEX idx_sales_2024_q1_date ON sales_2024_q1(sale_date);

-- BRINç´¢å¼•ï¼ˆæ—¶åºæ•°æ®ï¼‰
CREATE INDEX idx_sales_date_brin ON sales USING BRIN (sale_date);
```

---

### 5.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;

-- è·¨åˆ†åŒºå¹¶è¡ŒæŸ¥è¯¢
EXPLAIN ANALYZE SELECT SUM(amount) FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-12-31';
-- å¹¶è¡Œæ‰«æå¤šä¸ªåˆ†åŒº
```

---

## 6. åˆ†åŒºæœ€ä½³å®žè·µ

### 6.1 è®¾è®¡åŽŸåˆ™

**åŽŸåˆ™1: é€‰æ‹©åˆé€‚çš„åˆ†åŒºé”®**

```sql
-- âœ… æ­£ç¡®ï¼šæŸ¥è¯¢é¢‘ç¹ä½¿ç”¨çš„åˆ—
CREATE TABLE orders (
    order_date DATE NOT NULL,  -- æŸ¥è¯¢é¢‘ç¹
    ...
) PARTITION BY RANGE (order_date);

-- âŒ é”™è¯¯ï¼šå¾ˆå°‘æŸ¥è¯¢çš„åˆ—
CREATE TABLE orders (
    order_date DATE NOT NULL,
    notes TEXT,  -- å¾ˆå°‘æŸ¥è¯¢
    ...
) PARTITION BY HASH (notes);  -- é”™è¯¯é€‰æ‹©
```

---

**åŽŸåˆ™2: æŽ§åˆ¶åˆ†åŒºæ•°é‡**

```sql
-- âœ… æ­£ç¡®ï¼šåˆç†åˆ†åŒºæ•°ï¼ˆ12ä¸ªï¼‰
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);
-- æŒ‰å­£åº¦åˆ†åŒºï¼Œä¿ç•™3å¹´ = 12ä¸ªåˆ†åŒº

-- âŒ é”™è¯¯ï¼šåˆ†åŒºè¿‡å¤šï¼ˆ3650ä¸ªï¼‰
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);
-- æŒ‰å¤©åˆ†åŒºï¼Œä¿ç•™10å¹´ = 3650ä¸ªåˆ†åŒºï¼ˆè¿‡å¤šï¼‰
```

---

**åŽŸåˆ™3: ä½¿ç”¨é»˜è®¤åˆ†åŒºæ•èŽ·å¼‚å¸¸æ•°æ®**

```sql
-- âœ… æ­£ç¡®ï¼šä½¿ç”¨é»˜è®¤åˆ†åŒº
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);

CREATE TABLE sales_default PARTITION OF sales DEFAULT;
-- æ•èŽ·ä¸ç¬¦åˆä»»ä½•åˆ†åŒºæ¡ä»¶çš„æ•°æ®

-- å®šæœŸæ£€æŸ¥é»˜è®¤åˆ†åŒº
SELECT COUNT(*) FROM sales_default;
-- å¦‚æžœæ•°æ®é‡å¤§ï¼Œåˆ›å»ºæ–°åˆ†åŒºå¹¶è¿ç§»
```

---

### 6.2 å¸¸è§é”™è¯¯ä¸Žé¿å…

**é”™è¯¯1: åˆ†åŒºé”®ä¸åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­**

```sql
-- âŒ é”™è¯¯
CREATE TABLE orders (
    order_date DATE NOT NULL,
    customer_id INT NOT NULL,
    ...
) PARTITION BY HASH (customer_id);

-- æŸ¥è¯¢ä¸ä½¿ç”¨customer_id
SELECT * FROM orders WHERE order_date = '2024-01-01';
-- æ‰«ææ‰€æœ‰åˆ†åŒº

-- âœ… æ­£ç¡®
CREATE TABLE orders (
    order_date DATE NOT NULL,
    customer_id INT NOT NULL,
    ...
) PARTITION BY RANGE (order_date);
```

---

**é”™è¯¯2: åˆ†åŒºæ•°é‡å¤±æŽ§**

```sql
-- âŒ é”™è¯¯ï¼šæŒ‰å¤©åˆ†åŒºï¼Œ10å¹´æ•°æ® = 3650ä¸ªåˆ†åŒº
CREATE TABLE events (
    event_time TIMESTAMPTZ NOT NULL,
    ...
) PARTITION BY RANGE (event_time);
-- å…ƒæ•°æ®å¼€é”€å¤§ï¼ŒæŸ¥è¯¢è®¡åˆ’ç”Ÿæˆæ…¢

-- âœ… æ­£ç¡®ï¼šæŒ‰æœˆåˆ†åŒºï¼Œ10å¹´æ•°æ® = 120ä¸ªåˆ†åŒº
CREATE TABLE events (
    event_time TIMESTAMPTZ NOT NULL,
    ...
) PARTITION BY RANGE (event_time);
```

---

**é”™è¯¯3: åˆ†åŒºå¤§å°ä¸å‡**

```sql
-- âŒ é”™è¯¯ï¼šåˆ†åŒºå¤§å°å·®å¼‚å¤§
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);

-- å­£åº¦1ï¼š100ä¸‡æ¡ï¼ˆ1GBï¼‰
-- å­£åº¦2ï¼š1000ä¸‡æ¡ï¼ˆ10GBï¼‰- è¿‡å¤§

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æ›´ç»†ç²’åº¦åˆ†åŒº
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    ...
) PARTITION BY RANGE (sale_date);
-- æŒ‰æœˆåˆ†åŒºï¼Œå¤§å°æ›´å‡åŒ€
```

---

## 7. å¸¸è§åˆ†åŒºæ¨¡å¼

### 7.1 æ—¶é—´åºåˆ—åˆ†åŒºæ¨¡å¼

```sql
-- æ¨¡å¼ï¼šæŒ‰æœˆåˆ†åŒº + è‡ªåŠ¨å½’æ¡£
CREATE TABLE time_series_data (
    timestamp TIMESTAMPTZ NOT NULL,
    device_id INT NOT NULL,
    value DOUBLE PRECISION,
    PRIMARY KEY (timestamp, device_id)
) PARTITION BY RANGE (timestamp);

-- åˆ›å»ºæœªæ¥3ä¸ªæœˆçš„åˆ†åŒº
SELECT create_monthly_partition('time_series_data', CURRENT_DATE);
SELECT create_monthly_partition('time_series_data', CURRENT_DATE + INTERVAL '1 month');
SELECT create_monthly_partition('time_series_data', CURRENT_DATE + INTERVAL '2 months');

-- è‡ªåŠ¨å½’æ¡£æ—§åˆ†åŒºï¼ˆä¿ç•™12ä¸ªæœˆï¼‰
DO $$
DECLARE
    old_partition TEXT;
    archive_date DATE;
BEGIN
    archive_date := CURRENT_DATE - INTERVAL '12 months';

    FOR old_partition IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
          AND tablename LIKE 'time_series_data_%'
          AND tablename < 'time_series_data_' || TO_CHAR(archive_date, 'YYYY_MM')
    LOOP
        EXECUTE format('ALTER TABLE time_series_data DETACH PARTITION %I', old_partition);
        EXECUTE format('ALTER TABLE %I RENAME TO %I_archive', old_partition, old_partition);
    END LOOP;
END $$;
```

---

### 7.2 å¤šçº§åˆ†åŒºæ¨¡å¼

```sql
-- æ¨¡å¼ï¼šå…ˆæŒ‰æ—¶é—´ï¼Œå†æŒ‰åœ°åŒº
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    region VARCHAR(50) NOT NULL,
    customer_id INT NOT NULL,
    amount NUMERIC(10,2),
    PRIMARY KEY (sale_date, region, customer_id)
) PARTITION BY RANGE (sale_date);

-- ä¸€çº§åˆ†åŒºï¼šæŒ‰å­£åº¦
CREATE TABLE sales_2024_q1 PARTITION OF sales
    FOR VALUES FROM ('2024-01-01') TO ('2024-04-01')
    PARTITION BY LIST (region);

-- äºŒçº§åˆ†åŒºï¼šæŒ‰åœ°åŒº
CREATE TABLE sales_2024_q1_north PARTITION OF sales_2024_q1
    FOR VALUES IN ('Beijing', 'Tianjin');

CREATE TABLE sales_2024_q1_south PARTITION OF sales_2024_q1
    FOR VALUES IN ('Guangdong', 'Guangxi');
```

---

### 7.3 çƒ­æ¸©å†·æ•°æ®åˆ†åŒºæ¨¡å¼

```sql
-- æ¨¡å¼ï¼šçƒ­æ•°æ®ï¼ˆå½“å‰ï¼‰ã€æ¸©æ•°æ®ï¼ˆåŽ†å²ï¼‰ã€å†·æ•°æ®ï¼ˆå½’æ¡£ï¼‰
CREATE TABLE orders (
    order_date DATE NOT NULL,
    order_id BIGSERIAL,
    ...
) PARTITION BY RANGE (order_date);

-- çƒ­æ•°æ®ï¼šå½“å‰3ä¸ªæœˆï¼ˆSSDï¼‰
CREATE TABLE orders_hot PARTITION OF orders
    FOR VALUES FROM (CURRENT_DATE - INTERVAL '3 months') TO (CURRENT_DATE + INTERVAL '1 month');

-- æ¸©æ•°æ®ï¼š3-12ä¸ªæœˆï¼ˆHDDï¼‰
CREATE TABLE orders_warm PARTITION OF orders
    FOR VALUES FROM (CURRENT_DATE - INTERVAL '12 months') TO (CURRENT_DATE - INTERVAL '3 months');

-- å†·æ•°æ®ï¼š12ä¸ªæœˆä»¥ä¸Šï¼ˆå½’æ¡£è¡¨ï¼‰
CREATE TABLE orders_cold (
    LIKE orders INCLUDING ALL
);
```

---

## 8. ç›¸å…³èµ„æº

- [ç´¢å¼•ç­–ç•¥](./ç´¢å¼•ç­–ç•¥.md) - åˆ†åŒºè¡¨ç´¢å¼•ç­–ç•¥
- [æ•°æ®ç±»åž‹é€‰æ‹©](./æ•°æ®ç±»åž‹é€‰æ‹©.md) - åˆ†åŒºé”®æ•°æ®ç±»åž‹é€‰æ‹©
- [æ€§èƒ½ä¼˜åŒ–](./æ€§èƒ½ä¼˜åŒ–.md) - åˆ†åŒºæ€§èƒ½ä¼˜åŒ–
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Table Partitioning](https://www.postgresql.org/docs/current/ddl-partitioning.html)

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
