# æ•°æ®ç½‘æ ¼æ¶æ„å»ºæ¨¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: PostgreSQL 18+ + å®è·µæ€»ç»“
> **çŠ¶æ€**: PostgreSQL 18+æ–°ç‰¹æ€§
> **æ–‡æ¡£ç¼–å·**: 12-01

---

## ğŸ“‘ ç›®å½•

- [æ•°æ®ç½‘æ ¼æ¶æ„å»ºæ¨¡æŒ‡å—](#æ•°æ®ç½‘æ ¼æ¶æ„å»ºæ¨¡æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 æ•°æ®ç½‘æ ¼æ¶æ„æ¦‚å¿µ](#111-æ•°æ®ç½‘æ ¼æ¶æ„æ¦‚å¿µ)
    - [1.1.2 æ•°æ®ç½‘æ ¼å››å¤§åŸåˆ™](#112-æ•°æ®ç½‘æ ¼å››å¤§åŸåˆ™)
    - [1.1.3 æ•°æ®äº§å“å»ºæ¨¡ç†è®º](#113-æ•°æ®äº§å“å»ºæ¨¡ç†è®º)
    - [1.1.4 æ•°æ®åŸŸå»ºæ¨¡ç†è®º](#114-æ•°æ®åŸŸå»ºæ¨¡ç†è®º)
    - [1.1.5 å¤æ‚åº¦åˆ†æ](#115-å¤æ‚åº¦åˆ†æ)
  - [2. æ•°æ®äº§å“å»ºæ¨¡](#2-æ•°æ®äº§å“å»ºæ¨¡)
    - [2.1 æ•°æ®äº§å“è¡¨](#21-æ•°æ®äº§å“è¡¨)
    - [2.2 æ•°æ®äº§å“è®¿é—®è¡¨](#22-æ•°æ®äº§å“è®¿é—®è¡¨)
  - [3. æ•°æ®åŸŸå»ºæ¨¡](#3-æ•°æ®åŸŸå»ºæ¨¡)
    - [3.1 æ•°æ®åŸŸè¡¨](#31-æ•°æ®åŸŸè¡¨)
    - [3.2 æ•°æ®åŸŸå…³ç³»è¡¨](#32-æ•°æ®åŸŸå…³ç³»è¡¨)
  - [4. æ•°æ®æ²»ç†å»ºæ¨¡](#4-æ•°æ®æ²»ç†å»ºæ¨¡)
    - [4.1 æ•°æ®ç›®å½•è¡¨](#41-æ•°æ®ç›®å½•è¡¨)
    - [4.2 æ•°æ®è´¨é‡ç›‘æ§è¡¨](#42-æ•°æ®è´¨é‡ç›‘æ§è¡¨)
  - [5. PostgreSQL 18ä¼˜åŒ–](#5-postgresql-18ä¼˜åŒ–)
    - [5.1 OAuth 2.0èº«ä»½éªŒè¯](#51-oauth-20èº«ä»½éªŒè¯)
    - [5.2 RLSå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»](#52-rlså¤šç§Ÿæˆ·æ•°æ®éš”ç¦»)
    - [5.3 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#53-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
  - [6. æ€§èƒ½ä¼˜åŒ–å»ºè®®](#6-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#61-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
    - [6.2 åˆ†åŒºç­–ç•¥ä¼˜åŒ–](#62-åˆ†åŒºç­–ç•¥ä¼˜åŒ–)
    - [6.3 ç‰©åŒ–è§†å›¾ç¼“å­˜](#63-ç‰©åŒ–è§†å›¾ç¼“å­˜)
    - [6.4 PostgreSQL 18 RLSä¼˜åŒ–](#64-postgresql-18-rlsä¼˜åŒ–)
    - [6.5 æ‰¹é‡æ“ä½œä¼˜åŒ–](#65-æ‰¹é‡æ“ä½œä¼˜åŒ–)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ•°æ®äº§å“è®¾è®¡](#71-æ•°æ®äº§å“è®¾è®¡)
    - [7.2 æ•°æ®åŸŸç®¡ç†](#72-æ•°æ®åŸŸç®¡ç†)
    - [7.3 æ•°æ®æ²»ç†](#73-æ•°æ®æ²»ç†)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#8-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1: æ•°æ®äº§å“å‘ç°å›°éš¾](#é—®é¢˜1-æ•°æ®äº§å“å‘ç°å›°éš¾)
    - [é—®é¢˜2: æ•°æ®äº§å“è®¿é—®æ§åˆ¶å¤æ‚](#é—®é¢˜2-æ•°æ®äº§å“è®¿é—®æ§åˆ¶å¤æ‚)
    - [é—®é¢˜3: æ•°æ®è´¨é‡ç›‘æ§æ€§èƒ½å·®](#é—®é¢˜3-æ•°æ®è´¨é‡ç›‘æ§æ€§èƒ½å·®)
    - [é—®é¢˜4: æ•°æ®åŸŸåä½œå›°éš¾](#é—®é¢˜4-æ•°æ®åŸŸåä½œå›°éš¾)
  - [9. ç›¸å…³èµ„æº](#9-ç›¸å…³èµ„æº)
    - [9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£](#91-æ ¸å¿ƒç›¸å…³æ–‡æ¡£)
    - [9.2 å®˜æ–¹èµ„æº](#92-å®˜æ–¹èµ„æº)

---

## 1. æ¦‚è¿°

æ•°æ®ç½‘æ ¼ï¼ˆData Meshï¼‰æ˜¯ä¸€ç§åˆ†å¸ƒå¼æ•°æ®æ¶æ„ï¼Œå°†æ•°æ®è§†ä¸ºäº§å“ï¼Œç”±æ•°æ®åŸŸï¼ˆData Domainï¼‰è´Ÿè´£ç®¡ç†ã€‚

**æ ¸å¿ƒåŸåˆ™**:

- æ•°æ®å³äº§å“ï¼ˆData as a Productï¼‰
- åŸŸå¯¼å‘çš„æ•°æ®æ‰€æœ‰æƒï¼ˆDomain-Oriented Data Ownershipï¼‰
- è‡ªåŠ©å¼æ•°æ®åŸºç¡€è®¾æ–½ï¼ˆSelf-Serve Data Infrastructureï¼‰
- è”åˆæ²»ç†ï¼ˆFederated Governanceï¼‰

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 æ•°æ®ç½‘æ ¼æ¶æ„æ¦‚å¿µ

**æ•°æ®ç½‘æ ¼ï¼ˆData Meshï¼‰**æ˜¯ä¸€ç§åˆ†å¸ƒå¼æ•°æ®æ¶æ„èŒƒå¼ï¼Œç”±Zhamak Dehghaniåœ¨2019å¹´æå‡ºï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿæ•°æ®æ¶æ„çš„ç—›ç‚¹ï¼š

1. **é›†ä¸­å¼æ•°æ®æ¹–/ä»“åº“çš„ç“¶é¢ˆ**: å•ä¸€å›¢é˜Ÿç®¡ç†æ‰€æœ‰æ•°æ®ï¼Œæˆä¸ºç“¶é¢ˆ
2. **æ•°æ®æ‰€æœ‰æƒä¸æ˜ç¡®**: æ•°æ®ç”Ÿäº§è€…ä¸è´Ÿè´£æ•°æ®è´¨é‡
3. **æ•°æ®è®¿é—®å¤æ‚**: æ•°æ®æ¶ˆè´¹è€…éš¾ä»¥æ‰¾åˆ°å’Œä½¿ç”¨æ•°æ®

### 1.1.2 æ•°æ®ç½‘æ ¼å››å¤§åŸåˆ™

**1. æ•°æ®å³äº§å“ï¼ˆData as a Productï¼‰**:

- æ•°æ®äº§å“å…·æœ‰æ˜ç¡®çš„SLAï¼ˆæœåŠ¡çº§åˆ«åè®®ï¼‰
- æ•°æ®äº§å“æœ‰æ˜ç¡®çš„æ‹¥æœ‰è€…
- æ•°æ®äº§å“æä¾›æ¸…æ™°çš„æ–‡æ¡£å’Œå…ƒæ•°æ®

**2. åŸŸå¯¼å‘çš„æ•°æ®æ‰€æœ‰æƒï¼ˆDomain-Oriented Data Ownershipï¼‰**:

- æ•°æ®åŸŸï¼ˆData Domainï¼‰æ˜¯ä¸šåŠ¡é¢†åŸŸçš„è¾¹ç•Œ
- æ¯ä¸ªåŸŸæ‹¥æœ‰è‡ªå·±çš„æ•°æ®äº§å“
- åŸŸå›¢é˜Ÿè´Ÿè´£æ•°æ®çš„ç”Ÿäº§ã€è´¨é‡å’Œæ²»ç†

**3. è‡ªåŠ©å¼æ•°æ®åŸºç¡€è®¾æ–½ï¼ˆSelf-Serve Data Infrastructureï¼‰**:

- æä¾›ç»Ÿä¸€çš„æ•°æ®åŸºç¡€è®¾æ–½å¹³å°
- åŸŸå›¢é˜Ÿå¯ä»¥è‡ªåŠ©åˆ›å»ºå’Œç®¡ç†æ•°æ®äº§å“
- é™ä½æ•°æ®äº§å“çš„åˆ›å»ºå’Œç»´æŠ¤æˆæœ¬

**4. è”åˆæ²»ç†ï¼ˆFederated Governanceï¼‰**:

- å»ºç«‹è·¨åŸŸçš„æ•°æ®æ²»ç†æ ‡å‡†
- åŸŸå›¢é˜Ÿéµå¾ªç»Ÿä¸€çš„æ²»ç†è§„åˆ™
- å¹³è¡¡è‡ªæ²»å’Œæ ‡å‡†åŒ–

### 1.1.3 æ•°æ®äº§å“å»ºæ¨¡ç†è®º

**æ•°æ®äº§å“ï¼ˆData Productï¼‰**æ˜¯æ•°æ®ç½‘æ ¼ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- **å¯å‘ç°æ€§ï¼ˆDiscoverabilityï¼‰**: å¯ä»¥é€šè¿‡æ•°æ®ç›®å½•å‘ç°
- **å¯ç†è§£æ€§ï¼ˆUnderstandabilityï¼‰**: æä¾›æ¸…æ™°çš„æ–‡æ¡£å’Œå…ƒæ•°æ®
- **å¯ä¿¡èµ–æ€§ï¼ˆTrustworthinessï¼‰**: æ»¡è¶³è´¨é‡å’Œå¯ç”¨æ€§SLA
- **å¯è®¿é—®æ€§ï¼ˆAccessibilityï¼‰**: æä¾›æ ‡å‡†åŒ–çš„è®¿é—®æ¥å£

### 1.1.4 æ•°æ®åŸŸå»ºæ¨¡ç†è®º

**æ•°æ®åŸŸï¼ˆData Domainï¼‰**æ˜¯ä¸šåŠ¡é¢†åŸŸçš„è¾¹ç•Œï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- **ä¸šåŠ¡å¯¹é½**: ä¸ä¸šåŠ¡é¢†åŸŸå¯¹é½
- **æ•°æ®æ‰€æœ‰æƒ**: æ‹¥æœ‰åŸŸå†…çš„æ•°æ®äº§å“
- **è‡ªæ²»æ€§**: å¯ä»¥ç‹¬ç«‹ç®¡ç†æ•°æ®äº§å“
- **åä½œæ€§**: ä¸å…¶ä»–åŸŸåä½œå…±äº«æ•°æ®

### 1.1.5 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **æ•°æ®äº§å“**: $O(P)$ where P is number of products
- **æ•°æ®åŸŸ**: $O(D)$ where D is number of domains
- **è®¿é—®æ§åˆ¶**: $O(P \times C)$ where C is number of consumers

**æŸ¥è¯¢å¤æ‚åº¦**:

- **äº§å“å‘ç°**: $O(\log P)$ with index
- **åŸŸæŸ¥è¯¢**: $O(\log D)$ with index
- **è®¿é—®æ§åˆ¶æ£€æŸ¥**: $O(\log C)$ with index

---

## 2. æ•°æ®äº§å“å»ºæ¨¡

### 2.1 æ•°æ®äº§å“è¡¨

```sql
-- æ•°æ®äº§å“è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_products') THEN
        CREATE TABLE data_products (
            id SERIAL PRIMARY KEY,
            product_name VARCHAR(255) NOT NULL,
            domain_id INTEGER NOT NULL REFERENCES data_domains(id),
            product_type VARCHAR(50) NOT NULL,  -- 'dataset', 'api', 'stream', 'ml_model', etc.
            description TEXT,
            schema_definition JSONB,  -- æ•°æ®æ¨¡å¼å®šä¹‰
            quality_sla JSONB DEFAULT '{}',  -- è´¨é‡SLA
            availability_sla JSONB DEFAULT '{}',  -- å¯ç”¨æ€§SLA
            owner_team VARCHAR(255) NOT NULL,
            status VARCHAR(20) NOT NULL CHECK (status IN ('draft', 'published', 'deprecated')),
            version VARCHAR(50) NOT NULL DEFAULT '1.0.0',
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE(product_name, version)
        );
        RAISE NOTICE 'è¡¨ data_products åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_products å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ data_products å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_products_domain ON data_products(domain_id);
    CREATE INDEX IF NOT EXISTS idx_data_products_status ON data_products(status);
    CREATE INDEX IF NOT EXISTS idx_data_products_owner ON data_products(owner_team);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 2.2 æ•°æ®äº§å“è®¿é—®è¡¨

```sql
-- æ•°æ®äº§å“è®¿é—®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_product_access') THEN
        CREATE TABLE data_product_access (
            id SERIAL PRIMARY KEY,
            product_id INTEGER NOT NULL REFERENCES data_products(id),
            consumer_team VARCHAR(255) NOT NULL,
            access_type VARCHAR(50) NOT NULL CHECK (access_type IN ('read', 'write', 'admin')),
            access_method VARCHAR(50),  -- 'api', 'database', 's3', etc.
            endpoint_url TEXT,
            credentials_config JSONB DEFAULT '{}',  -- å‡­è¯é…ç½®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
            is_active BOOLEAN DEFAULT TRUE,
            granted_at TIMESTAMPTZ DEFAULT NOW(),
            granted_by VARCHAR(255),
            expires_at TIMESTAMPTZ,
            UNIQUE(product_id, consumer_team)
        );
        RAISE NOTICE 'è¡¨ data_product_access åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_product_access å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ data_product_access å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_product_access_product ON data_product_access(product_id);
    CREATE INDEX IF NOT EXISTS idx_data_product_access_consumer ON data_product_access(consumer_team);
    CREATE INDEX IF NOT EXISTS idx_data_product_access_active ON data_product_access(product_id, is_active) WHERE is_active = TRUE;
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 3. æ•°æ®åŸŸå»ºæ¨¡

### 3.1 æ•°æ®åŸŸè¡¨

```sql
-- æ•°æ®åŸŸè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_domains') THEN
        CREATE TABLE data_domains (
            id SERIAL PRIMARY KEY,
            domain_name VARCHAR(255) NOT NULL,
            description TEXT,
            owner_team VARCHAR(255) NOT NULL,
            business_capability TEXT,  -- ä¸šåŠ¡èƒ½åŠ›æè¿°
            data_sources TEXT[],  -- æ•°æ®æºåˆ—è¡¨
            metadata JSONB DEFAULT '{}',
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE(domain_name)
        );
        RAISE NOTICE 'è¡¨ data_domains åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_domains å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ data_domains å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_domains_owner ON data_domains(owner_team);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 3.2 æ•°æ®åŸŸå…³ç³»è¡¨

```sql
-- æ•°æ®åŸŸå…³ç³»è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_domain_relationships') THEN
        CREATE TABLE data_domain_relationships (
            id SERIAL PRIMARY KEY,
            source_domain_id INTEGER NOT NULL REFERENCES data_domains(id),
            target_domain_id INTEGER NOT NULL REFERENCES data_domains(id),
            relationship_type VARCHAR(50) NOT NULL,  -- 'depends_on', 'produces', 'consumes', etc.
            description TEXT,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            CHECK (source_domain_id != target_domain_id),
            UNIQUE(source_domain_id, target_domain_id, relationship_type)
        );
        RAISE NOTICE 'è¡¨ data_domain_relationships åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_domain_relationships å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ data_domain_relationships å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_domain_relationships_source ON data_domain_relationships(source_domain_id);
    CREATE INDEX IF NOT EXISTS idx_data_domain_relationships_target ON data_domain_relationships(target_domain_id);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 4. æ•°æ®æ²»ç†å»ºæ¨¡

### 4.1 æ•°æ®ç›®å½•è¡¨

```sql
-- æ•°æ®ç›®å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_catalog') THEN
        CREATE TABLE data_catalog (
            id SERIAL PRIMARY KEY,
            product_id INTEGER NOT NULL REFERENCES data_products(id),
            asset_name VARCHAR(255) NOT NULL,
            asset_type VARCHAR(50) NOT NULL,  -- 'table', 'column', 'view', 'api', etc.
            description TEXT,
            tags TEXT[],
            classification VARCHAR(50),  -- 'public', 'internal', 'confidential', 'restricted'
            data_classification JSONB DEFAULT '{}',  -- æ•°æ®åˆ†ç±»ï¼ˆPIIã€æ•æ„Ÿæ•°æ®ç­‰ï¼‰
            lineage_info JSONB DEFAULT '{}',  -- è¡€ç¼˜ä¿¡æ¯
            quality_metrics JSONB DEFAULT '{}',  -- è´¨é‡æŒ‡æ ‡
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE(product_id, asset_name)
        );
        RAISE NOTICE 'è¡¨ data_catalog åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_catalog å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ data_catalog å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQL 18 GINå¹¶è¡Œæ„å»ºä¼˜åŒ–ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_catalog_search_vector ON data_catalog USING GIN (
        to_tsvector('english', COALESCE(description, '') || ' ' || COALESCE(array_to_string(tags, ' '), ''))
    );
    CREATE INDEX IF NOT EXISTS idx_data_catalog_product ON data_catalog(product_id);
    CREATE INDEX IF NOT EXISTS idx_data_catalog_classification ON data_catalog(classification);
    CREATE INDEX IF NOT EXISTS idx_data_catalog_tags ON data_catalog USING GIN (tags);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 4.2 æ•°æ®è´¨é‡ç›‘æ§è¡¨

```sql
-- æ•°æ®è´¨é‡ç›‘æ§è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œåˆ†åŒºè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'data_quality_monitoring') THEN
        CREATE TABLE data_quality_monitoring (
            id SERIAL PRIMARY KEY,
            product_id INTEGER NOT NULL REFERENCES data_products(id),
            asset_id INTEGER REFERENCES data_catalog(id),
            quality_metric_name VARCHAR(100) NOT NULL,
            metric_value NUMERIC(10,6) NOT NULL,
            threshold_value NUMERIC(10,6),
            status VARCHAR(20) GENERATED ALWAYS AS (
                CASE
                    WHEN threshold_value IS NULL THEN 'unknown'
                    WHEN metric_value >= threshold_value THEN 'pass'
                    ELSE 'fail'
                END
            ) VIRTUAL,  -- PostgreSQL 18è™šæ‹Ÿç”Ÿæˆåˆ—
            evaluated_at TIMESTAMPTZ DEFAULT NOW(),
            notes TEXT
        ) PARTITION BY RANGE (evaluated_at);
        RAISE NOTICE 'åˆ†åŒºè¡¨ data_quality_monitoring åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ data_quality_monitoring å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºè¡¨ data_quality_monitoring å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºæœˆåº¦åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS data_quality_monitoring_2024_01 PARTITION OF data_quality_monitoring
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
    RAISE NOTICE 'åˆ†åŒºåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'åˆ†åŒºå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_data_quality_monitoring_product ON data_quality_monitoring(product_id, evaluated_at DESC);
    CREATE INDEX IF NOT EXISTS idx_data_quality_monitoring_status ON data_quality_monitoring(status);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 5. PostgreSQL 18ä¼˜åŒ–

### 5.1 OAuth 2.0èº«ä»½éªŒè¯

```conf
# pg_hba.conf
# OAuth 2.0è®¤è¯é…ç½®ï¼ˆPostgreSQL 18ï¼‰
host    all             all             0.0.0.0/0               oauth

# postgresql.conf
# OAuth 2.0é…ç½®
oauth_issuer = 'https://auth.example.com'
oauth_client_id = 'postgresql-client'
oauth_client_secret = 'client-secret'
oauth_scope = 'openid profile email'
```

### 5.2 RLSå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

```sql
-- PostgreSQL 18ï¼šRLSæ€§èƒ½ä¼˜åŒ–ï¼ˆæ•°æ®åŸŸéš”ç¦»ï¼‰
CREATE POLICY data_product_domain_isolation ON data_products
FOR ALL
TO PUBLIC
USING (
    domain_id IN (
        SELECT domain_id FROM data_domain_access
        WHERE team_name = current_setting('app.current_team', true)
    )
);

ALTER TABLE data_products ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºdomain_idç´¢å¼•ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
CREATE INDEX idx_data_products_domain_id ON data_products(domain_id);
```

### 5.3 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

```sql
-- PostgreSQL 18ï¼šä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–è®¡ç®—å­—æ®µ
ALTER TABLE data_quality_monitoring
ADD COLUMN status VARCHAR(20) GENERATED ALWAYS AS (
    CASE
        WHEN threshold_value IS NULL THEN 'unknown'
        WHEN metric_value >= threshold_value THEN 'pass'
        ELSE 'fail'
    END
) VIRTUAL;
```

---

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**æ•°æ®äº§å“æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_data_products_domain_status ON data_products(domain_id, status);
CREATE INDEX idx_data_products_owner_status ON data_products(owner_team, status);
CREATE INDEX idx_data_products_type_status ON data_products(product_type, status);

-- ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_data_products_schema ON data_products USING gin(schema_definition);
CREATE INDEX idx_data_products_quality_sla ON data_products USING gin(quality_sla);
```

**æ•°æ®ç›®å½•æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- ä¸ºæ•°æ®ç›®å½•åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_data_catalog_search ON data_catalog
USING gin(to_tsvector('english', title || ' ' || description || ' ' || tags::text));
```

### 6.2 åˆ†åŒºç­–ç•¥ä¼˜åŒ–

**æ•°æ®è´¨é‡ç›‘æ§è¡¨åˆ†åŒº**:

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨è´¨é‡ç›‘æ§æ•°æ®
CREATE TABLE data_quality_monitoring (
    id BIGSERIAL,
    product_id INTEGER NOT NULL,
    metric_name VARCHAR(255) NOT NULL,
    metric_value DOUBLE PRECISION,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (id, timestamp)
) PARTITION BY RANGE (timestamp);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE data_quality_monitoring_2025_01 PARTITION OF data_quality_monitoring
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 6.3 ç‰©åŒ–è§†å›¾ç¼“å­˜

**ç¼“å­˜æ•°æ®äº§å“æ±‡æ€»**:

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜æ•°æ®äº§å“æ±‡æ€»
CREATE MATERIALIZED VIEW mv_data_products_summary AS
SELECT
    d.domain_name,
    COUNT(dp.id) AS product_count,
    COUNT(CASE WHEN dp.status = 'published' THEN 1 END) AS published_count,
    AVG((dp.quality_sla->>'availability')::FLOAT) AS avg_availability
FROM data_domains d
LEFT JOIN data_products dp ON d.id = dp.domain_id
GROUP BY d.id, d.domain_name;

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_data_products_summary;
```

### 6.4 PostgreSQL 18 RLSä¼˜åŒ–

**å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ä¼˜åŒ–**:

```sql
-- PostgreSQL 18ï¼šä½¿ç”¨RLSå®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
ALTER TABLE data_products ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥ï¼šåŸŸå›¢é˜Ÿåªèƒ½è®¿é—®è‡ªå·±åŸŸçš„æ•°æ®äº§å“
CREATE POLICY domain_team_access ON data_products
FOR ALL
TO authenticated
USING (
    owner_team = current_setting('app.current_team', true)
    OR EXISTS (
        SELECT 1 FROM data_product_access dpa
        WHERE dpa.product_id = data_products.id
          AND dpa.consumer_team = current_setting('app.current_team', true)
          AND dpa.is_active = TRUE
    )
);
```

### 6.5 æ‰¹é‡æ“ä½œä¼˜åŒ–

**æ‰¹é‡æ•°æ®äº§å“åˆ›å»º**:

```sql
-- ä½¿ç”¨COPYå‘½ä»¤æ‰¹é‡æ’å…¥
COPY data_products (product_name, domain_id, product_type, description, owner_team, status)
FROM STDIN WITH (FORMAT csv);
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ•°æ®äº§å“è®¾è®¡

1. **äº§å“åŒ–æ€ç»´**: å°†æ•°æ®è§†ä¸ºäº§å“ï¼Œå…³æ³¨ç”¨æˆ·ä½“éªŒ
2. **ç‰ˆæœ¬ç®¡ç†**: å¯¹æ•°æ®äº§å“è¿›è¡Œç‰ˆæœ¬ç®¡ç†
3. **SLAå®šä¹‰**: æ˜ç¡®å®šä¹‰è´¨é‡å’Œå¯ç”¨æ€§SLA
4. **æ–‡æ¡£å®Œå–„**: æä¾›æ¸…æ™°çš„äº§å“æ–‡æ¡£å’Œå…ƒæ•°æ®

### 7.2 æ•°æ®åŸŸç®¡ç†

1. **åŸŸæ‰€æœ‰æƒ**: æ˜ç¡®æ•°æ®åŸŸçš„æ‹¥æœ‰è€…
2. **åŸŸè¾¹ç•Œ**: æ¸…æ™°å®šä¹‰åŸŸçš„è¾¹ç•Œå’ŒèŒè´£
3. **åŸŸåä½œ**: å»ºç«‹åŸŸä¹‹é—´çš„åä½œæœºåˆ¶
4. **åŸŸæ²»ç†**: åŸŸå†…æ•°æ®æ²»ç†éµå¾ªè”åˆæ²»ç†æ ‡å‡†

### 7.3 æ•°æ®æ²»ç†

1. **è”åˆæ²»ç†**: å»ºç«‹è”åˆæ²»ç†æœºåˆ¶
2. **è‡ªåŠ©æœåŠ¡**: æä¾›è‡ªåŠ©å¼æ•°æ®åŸºç¡€è®¾æ–½
3. **è´¨é‡ç›‘æ§**: æŒç»­ç›‘æ§æ•°æ®è´¨é‡
4. **è®¿é—®æ§åˆ¶**: å®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ä½¿ç”¨DOå—å¤„ç†æ•°æ®äº§å“æ“ä½œé”™è¯¯
2. **äº‹åŠ¡ç®¡ç†**: æ•°æ®äº§å“æ›´æ–°åº”åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
3. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨EXPLAIN (ANALYZE, BUFFERS, TIMING)åˆ†ææŸ¥è¯¢æ€§èƒ½
4. **å®‰å…¨æ§åˆ¶**: ä½¿ç”¨RLSå®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

---

## 8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: æ•°æ®äº§å“å‘ç°å›°éš¾

**åŸå› **:

- ç¼ºå°‘æ•°æ®ç›®å½•
- å…ƒæ•°æ®ä¸å®Œæ•´
- æœç´¢åŠŸèƒ½ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:

- å»ºç«‹ç»Ÿä¸€çš„æ•°æ®ç›®å½•
- å®Œå–„äº§å“å…ƒæ•°æ®
- å®ç°å…¨æ–‡æœç´¢åŠŸèƒ½

**ç¤ºä¾‹**:

```sql
-- åˆ›å»ºæ•°æ®ç›®å½•å…¨æ–‡æœç´¢
CREATE INDEX idx_data_catalog_search ON data_catalog
USING gin(to_tsvector('english', title || ' ' || description || ' ' || tags::text));

-- æœç´¢æ•°æ®äº§å“
-- æŸ¥è¯¢æ•°æ®ç›®å½•ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM data_catalog
WHERE to_tsvector('english', title || ' ' || description || ' ' || tags::text)
      @@ plainto_tsquery('english', 'user behavior');
```

### é—®é¢˜2: æ•°æ®äº§å“è®¿é—®æ§åˆ¶å¤æ‚

**åŸå› **:

- è®¿é—®æƒé™åˆ†æ•£
- ç¼ºå°‘ç»Ÿä¸€çš„è®¿é—®æ§åˆ¶æœºåˆ¶
- æƒé™ç®¡ç†å¤æ‚

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨RLSå®ç°ç»Ÿä¸€çš„è®¿é—®æ§åˆ¶
- é›†ä¸­ç®¡ç†è®¿é—®æƒé™
- å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

**ç¤ºä¾‹**:

```sql
-- ä½¿ç”¨RLSå®ç°è®¿é—®æ§åˆ¶
ALTER TABLE data_products ENABLE ROW LEVEL SECURITY;

CREATE POLICY product_access ON data_products
FOR SELECT
TO authenticated
USING (
    owner_team = current_setting('app.current_team', true)
    OR EXISTS (
        SELECT 1 FROM data_product_access dpa
        WHERE dpa.product_id = data_products.id
          AND dpa.consumer_team = current_setting('app.current_team', true)
          AND dpa.is_active = TRUE
    )
);
```

### é—®é¢˜3: æ•°æ®è´¨é‡ç›‘æ§æ€§èƒ½å·®

**åŸå› **:

- è´¨é‡ç›‘æ§æ•°æ®æœªåˆ†åŒº
- ç¼ºå°‘ç´¢å¼•
- æŸ¥è¯¢å¤æ‚

**è§£å†³æ–¹æ¡ˆ**:

- ä½¿ç”¨æ—¶é—´åˆ†åŒºè¡¨
- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æ±‡æ€»æ•°æ®

**ç¤ºä¾‹**:

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE data_quality_monitoring (
    id BIGSERIAL,
    product_id INTEGER NOT NULL,
    metric_name VARCHAR(255) NOT NULL,
    metric_value DOUBLE PRECISION,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (id, timestamp)
) PARTITION BY RANGE (timestamp);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_quality_monitoring_product_metric
ON data_quality_monitoring(product_id, metric_name, timestamp DESC);
```

### é—®é¢˜4: æ•°æ®åŸŸåä½œå›°éš¾

**åŸå› **:

- åŸŸè¾¹ç•Œä¸æ¸…æ™°
- ç¼ºå°‘åŸŸé—´åä½œæœºåˆ¶
- æ•°æ®å…±äº«å›°éš¾

**è§£å†³æ–¹æ¡ˆ**:

- æ˜ç¡®å®šä¹‰åŸŸè¾¹ç•Œ
- å»ºç«‹åŸŸé—´åä½œæœºåˆ¶
- å®ç°æ•°æ®äº§å“å…±äº«

**ç¤ºä¾‹**:

```sql
-- åˆ›å»ºåŸŸå…³ç³»è¡¨
CREATE TABLE domain_relationships (
    id SERIAL PRIMARY KEY,
    source_domain_id INTEGER NOT NULL REFERENCES data_domains(id),
    target_domain_id INTEGER NOT NULL REFERENCES data_domains(id),
    relationship_type VARCHAR(50) NOT NULL,  -- 'depends_on', 'shares_data', 'collaborates'
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(source_domain_id, target_domain_id, relationship_type)
);

-- æŸ¥è¯¢åŸŸä¾èµ–å…³ç³»
WITH RECURSIVE domain_deps AS (
    SELECT source_domain_id, target_domain_id, 1 AS level
    FROM domain_relationships
    WHERE source_domain_id = $domain_id
    UNION ALL
    SELECT dr.source_domain_id, dr.target_domain_id, dd.level + 1
    FROM domain_relationships dr
    JOIN domain_deps dd ON dr.source_domain_id = dd.target_domain_id
    WHERE dd.level < 5
)
SELECT DISTINCT target_domain_id FROM domain_deps;
```

---

## 9. ç›¸å…³èµ„æº

### 9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·å¢å¼º](../../18-ç‰ˆæœ¬ç‰¹æ€§/18.01-PostgreSQL18æ–°ç‰¹æ€§/å¤šç§Ÿæˆ·å¢å¼º.md) - PostgreSQL 18å¤šç§Ÿæˆ·ç‰¹æ€§
- [PostgreSQL18æ–°ç‰¹æ€§](../08-PostgreSQLå»ºæ¨¡å®è·µ/PostgreSQL18æ–°ç‰¹æ€§.md) - PostgreSQL 18æ–°ç‰¹æ€§æŒ‡å—
- [æ€§èƒ½ä¼˜åŒ–](../08-PostgreSQLå»ºæ¨¡å®è·µ/æ€§èƒ½ä¼˜åŒ–.md) - æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 9.2 å®˜æ–¹èµ„æº

- [PostgreSQL 18æ–‡æ¡£](https://www.postgresql.org/docs/18/) - PostgreSQL 18å®˜æ–¹æ–‡æ¡£
- [æ•°æ®ç½‘æ ¼åŸåˆ™](https://martinfowler.com/articles/data-mesh-principles.html) - Martin Fowleræ•°æ®ç½‘æ ¼æ–‡ç« 

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**çŠ¶æ€**: âœ… å·²å®Œæˆ
