# è®¾å¤‡å­ªç”Ÿæ¨¡å‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: IoTæ•°å­—å­ªç”Ÿç†è®º
> **çŠ¶æ€**: âœ… å·²å®Œæˆ
> **æ–‡æ¡£ç¼–å·**: 06-03

---

## ğŸ“‘ ç›®å½•

- [è®¾å¤‡å­ªç”Ÿæ¨¡å‹](#è®¾å¤‡å­ªç”Ÿæ¨¡å‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 è®¾å¤‡å­ªç”ŸåŸºæœ¬æ¦‚å¿µ](#111-è®¾å¤‡å­ªç”ŸåŸºæœ¬æ¦‚å¿µ)
    - [1.1.2 è®¾å¤‡çŠ¶æ€ç®¡ç†ç†è®º](#112-è®¾å¤‡çŠ¶æ€ç®¡ç†ç†è®º)
    - [1.1.3 é¥æµ‹æ•°æ®ç†è®º](#113-é¥æµ‹æ•°æ®ç†è®º)
    - [1.1.4 å‘½ä»¤æ§åˆ¶ç†è®º](#114-å‘½ä»¤æ§åˆ¶ç†è®º)
    - [1.1.5 è®¾å¤‡å…³ç³»ç†è®º](#115-è®¾å¤‡å…³ç³»ç†è®º)
    - [1.1.6 å¤æ‚åº¦åˆ†æ](#116-å¤æ‚åº¦åˆ†æ)
  - [2. è®¾å¤‡æ¨¡å‹è®¾è®¡](#2-è®¾å¤‡æ¨¡å‹è®¾è®¡)
    - [2.1 è®¾å¤‡åŸºç¡€æ¨¡å‹](#21-è®¾å¤‡åŸºç¡€æ¨¡å‹)
    - [2.2 è®¾å¤‡å±æ€§æ¨¡å‹](#22-è®¾å¤‡å±æ€§æ¨¡å‹)
    - [2.3 è®¾å¤‡å…³ç³»æ¨¡å‹](#23-è®¾å¤‡å…³ç³»æ¨¡å‹)
  - [3. çŠ¶æ€ç®¡ç†](#3-çŠ¶æ€ç®¡ç†)
    - [3.1 è®¾å¤‡çŠ¶æ€è¡¨](#31-è®¾å¤‡çŠ¶æ€è¡¨)
    - [3.2 çŠ¶æ€æ›´æ–°å‡½æ•°](#32-çŠ¶æ€æ›´æ–°å‡½æ•°)
    - [3.3 çŠ¶æ€æŸ¥è¯¢](#33-çŠ¶æ€æŸ¥è¯¢)
  - [4. é¥æµ‹æ•°æ®](#4-é¥æµ‹æ•°æ®)
    - [4.1 é¥æµ‹æ•°æ®æ¨¡å‹](#41-é¥æµ‹æ•°æ®æ¨¡å‹)
    - [4.2 é¥æµ‹æ•°æ®æŸ¥è¯¢](#42-é¥æµ‹æ•°æ®æŸ¥è¯¢)
  - [5. å‘½ä»¤ä¸æ§åˆ¶](#5-å‘½ä»¤ä¸æ§åˆ¶)
    - [5.1 å‘½ä»¤æ¨¡å‹](#51-å‘½ä»¤æ¨¡å‹)
    - [5.2 å‘½ä»¤æ‰§è¡Œå‡½æ•°](#52-å‘½ä»¤æ‰§è¡Œå‡½æ•°)
    - [5.3 å‘½ä»¤æŸ¥è¯¢](#53-å‘½ä»¤æŸ¥è¯¢)
  - [6. PostgreSQLå®ç°](#6-postgresqlå®ç°)
    - [6.1 å®Œæ•´è®¾å¤‡å­ªç”Ÿç³»ç»Ÿ](#61-å®Œæ•´è®¾å¤‡å­ªç”Ÿç³»ç»Ÿ)
    - [6.2 è®¾å¤‡å­ªç”Ÿè§†å›¾](#62-è®¾å¤‡å­ªç”Ÿè§†å›¾)
  - [7. æ›´å¤šå®é™…æ¡ˆä¾‹ / More Practical Examples](#7-æ›´å¤šå®é™…æ¡ˆä¾‹--more-practical-examples)
    - [7.1 æ¡ˆä¾‹1: æ™ºèƒ½å®¶å±…è®¾å¤‡å­ªç”Ÿ](#71-æ¡ˆä¾‹1-æ™ºèƒ½å®¶å±…è®¾å¤‡å­ªç”Ÿ)
    - [7.2 æ¡ˆä¾‹2: å·¥ä¸šè®¾å¤‡ç›‘æ§å­ªç”Ÿ](#72-æ¡ˆä¾‹2-å·¥ä¸šè®¾å¤‡ç›‘æ§å­ªç”Ÿ)
    - [7.3 æ¡ˆä¾‹3: è½¦è¾†è®¾å¤‡å­ªç”Ÿ](#73-æ¡ˆä¾‹3-è½¦è¾†è®¾å¤‡å­ªç”Ÿ)
  - [8. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ / Performance Optimization and Monitoring](#8-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§--performance-optimization-and-monitoring)
    - [8.1 è®¾å¤‡å­ªç”Ÿæ€§èƒ½ä¼˜åŒ–](#81-è®¾å¤‡å­ªç”Ÿæ€§èƒ½ä¼˜åŒ–)
    - [8.2 è®¾å¤‡å­ªç”Ÿç›‘æ§](#82-è®¾å¤‡å­ªç”Ÿç›‘æ§)
  - [9. å¸¸è§é—®é¢˜è§£ç­” / FAQ](#9-å¸¸è§é—®é¢˜è§£ç­”--faq)
    - [Q1: è®¾å¤‡å­ªç”Ÿæ•°æ®åº”è¯¥å­˜å‚¨å¤šä¹…ï¼Ÿ](#q1-è®¾å¤‡å­ªç”Ÿæ•°æ®åº”è¯¥å­˜å‚¨å¤šä¹…)
    - [Q2: å¦‚ä½•å¤„ç†è®¾å¤‡ç¦»çº¿æƒ…å†µï¼Ÿ](#q2-å¦‚ä½•å¤„ç†è®¾å¤‡ç¦»çº¿æƒ…å†µ)
    - [Q3: è®¾å¤‡å‘½ä»¤å¦‚ä½•ä¿è¯å¯é æ€§ï¼Ÿ](#q3-è®¾å¤‡å‘½ä»¤å¦‚ä½•ä¿è¯å¯é æ€§)
    - [Q4: è®¾å¤‡å­ªç”Ÿæ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ](#q4-è®¾å¤‡å­ªç”Ÿæ€§èƒ½å¦‚ä½•ä¼˜åŒ–)
    - [Q5: å¦‚ä½•å®ç°è®¾å¤‡å­ªç”Ÿçš„åŒæ­¥ï¼Ÿ](#q5-å¦‚ä½•å®ç°è®¾å¤‡å­ªç”Ÿçš„åŒæ­¥)
  - [9. ç›¸å…³èµ„æº / Related Resources](#9-ç›¸å…³èµ„æº--related-resources)
    - [9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents](#91-æ ¸å¿ƒç›¸å…³æ–‡æ¡£--core-related-documents)
    - [9.2 ç†è®ºåŸºç¡€ / Theoretical Foundation](#92-ç†è®ºåŸºç¡€--theoretical-foundation)
    - [9.3 å®è·µæŒ‡å— / Practical Guides](#93-å®è·µæŒ‡å—--practical-guides)
    - [9.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases](#94-åº”ç”¨æ¡ˆä¾‹--application-cases)
    - [9.5 å‚è€ƒèµ„æº / Reference Resources](#95-å‚è€ƒèµ„æº--reference-resources)

---

## 1. æ¦‚è¿°

è®¾å¤‡å­ªç”Ÿæ¨¡å‹ç”¨äºåœ¨æ•°æ®åº“ä¸­è¡¨ç¤ºç‰©ç†è®¾å¤‡çš„æ•°å­—å‰¯æœ¬ï¼Œæ”¯æŒçŠ¶æ€åŒæ­¥å’Œè¿œç¨‹æ§åˆ¶ã€‚
è®¾å¤‡å­ªç”Ÿï¼ˆDigital Twinï¼‰æ˜¯ç‰©ç†è®¾å¤‡åœ¨æ•°å­—ä¸–ç•Œçš„å®Œæ•´æ˜ å°„ï¼ŒåŒ…å«è®¾å¤‡å±æ€§ã€çŠ¶æ€ã€é¥æµ‹æ•°æ®å’Œå‘½ä»¤æ¥å£ã€‚

**æ ¸å¿ƒä»·å€¼**:

- **çŠ¶æ€åŒæ­¥**ï¼šå®æ—¶åŒæ­¥ç‰©ç†è®¾å¤‡çŠ¶æ€
- **è¿œç¨‹æ§åˆ¶**ï¼šé€šè¿‡æ•°å­—å­ªç”Ÿæ§åˆ¶ç‰©ç†è®¾å¤‡
- **å†å²è¿½æº¯**ï¼šè®°å½•è®¾å¤‡å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **é¢„æµ‹åˆ†æ**ï¼šåŸºäºå­ªç”Ÿæ•°æ®è¿›è¡Œé¢„æµ‹

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 è®¾å¤‡å­ªç”ŸåŸºæœ¬æ¦‚å¿µ

**è®¾å¤‡å­ªç”Ÿï¼ˆDigital Twinï¼‰**:

- **å®šä¹‰**: ç‰©ç†è®¾å¤‡åœ¨æ•°å­—ä¸–ç•Œçš„å®Œæ•´æ˜ å°„
- **ç»„æˆ**: è®¾å¤‡å±æ€§ã€çŠ¶æ€ã€é¥æµ‹æ•°æ®ã€å‘½ä»¤æ¥å£
- **åŒæ­¥**: å®æ—¶åŒæ­¥ç‰©ç†è®¾å¤‡çŠ¶æ€

**è®¾å¤‡å­ªç”Ÿæ¶æ„**:

- **ç‰©ç†å±‚**: ç‰©ç†è®¾å¤‡
- **æ•°å­—å±‚**: æ•°å­—å­ªç”Ÿï¼ˆæ•°æ®åº“ï¼‰
- **åŒæ­¥å±‚**: çŠ¶æ€åŒæ­¥æœºåˆ¶

### 1.1.2 è®¾å¤‡çŠ¶æ€ç®¡ç†ç†è®º

**è®¾å¤‡çŠ¶æ€**:

- **çŠ¶æ€å®šä¹‰**: $S = \{s_1, s_2, ..., s_n\}$
- **çŠ¶æ€è½¬æ¢**: $s_i \rightarrow s_j$ (çŠ¶æ€æœº)
- **çŠ¶æ€å†å²**: è®°å½•çŠ¶æ€è½¬æ¢å†å²

**çŠ¶æ€åŒæ­¥**:

- **æ¨é€æ¨¡å¼**: è®¾å¤‡ä¸»åŠ¨æ¨é€çŠ¶æ€
- **æ‹‰å–æ¨¡å¼**: ç³»ç»Ÿä¸»åŠ¨æ‹‰å–çŠ¶æ€
- **æ··åˆæ¨¡å¼**: æ¨é€+æ‹‰å–

### 1.1.3 é¥æµ‹æ•°æ®ç†è®º

**é¥æµ‹æ•°æ®ï¼ˆTelemetryï¼‰**:

- **å®šä¹‰**: è®¾å¤‡ä¼ æ„Ÿå™¨æ•°æ®
- **ç‰¹å¾**: é«˜é¢‘ã€æ—¶åºã€ä¸å¯å˜
- **å­˜å‚¨**: ä½¿ç”¨æ—¶åºæ•°æ®åº“å­˜å‚¨

**é¥æµ‹æ•°æ®æ¨¡å‹**:

- **æ—¶é—´æˆ³**: $T = \{t_1, t_2, ..., t_n\}$
- **æŒ‡æ ‡å€¼**: $V = \{v_1, v_2, ..., v_n\}$
- **æ ‡ç­¾**: $L = \{l_1, l_2, ..., l_m\}$

### 1.1.4 å‘½ä»¤æ§åˆ¶ç†è®º

**è®¾å¤‡å‘½ä»¤**:

- **å‘½ä»¤å®šä¹‰**: $C = \{c_1, c_2, ..., c_n\}$
- **å‘½ä»¤çŠ¶æ€**: pending â†’ executing â†’ completed/failed
- **å‘½ä»¤é˜Ÿåˆ—**: ç®¡ç†å‘½ä»¤æ‰§è¡Œé˜Ÿåˆ—

**å‘½ä»¤å¯é æ€§**:

- **ç¡®è®¤æœºåˆ¶**: è®¾å¤‡ç¡®è®¤å‘½ä»¤æ¥æ”¶
- **é‡è¯•æœºåˆ¶**: å¤±è´¥å‘½ä»¤è‡ªåŠ¨é‡è¯•
- **è¶…æ—¶å¤„ç†**: è¶…æ—¶å‘½ä»¤è‡ªåŠ¨å–æ¶ˆ

### 1.1.5 è®¾å¤‡å…³ç³»ç†è®º

**è®¾å¤‡å…³ç³»**:

- **å±‚æ¬¡å…³ç³»**: è®¾å¤‡å¯ä»¥æœ‰çˆ¶å­å…³ç³»
- **ç½‘ç»œå…³ç³»**: è®¾å¤‡å¯ä»¥å½¢æˆç½‘ç»œ
- **å…³ç³»å›¾**: $G = (V, E)$ where V is devices, E is relationships

**å…³ç³»æŸ¥è¯¢**:

- **å±‚æ¬¡æŸ¥è¯¢**: æŸ¥è¯¢è®¾å¤‡å±‚æ¬¡ç»“æ„
- **ç½‘ç»œæŸ¥è¯¢**: æŸ¥è¯¢è®¾å¤‡ç½‘ç»œ
- **è·¯å¾„æŸ¥è¯¢**: æŸ¥è¯¢è®¾å¤‡é—´è·¯å¾„

### 1.1.6 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **è®¾å¤‡è¡¨**: $O(D)$ where D is number of devices
- **çŠ¶æ€è¡¨**: $O(D \times S)$ where S is average states per device
- **é¥æµ‹æ•°æ®**: $O(D \times T)$ where T is average telemetry per device

**æŸ¥è¯¢å¤æ‚åº¦**:

- **è®¾å¤‡æŸ¥è¯¢**: $O(\log D)$ with index
- **çŠ¶æ€æŸ¥è¯¢**: $O(\log S)$ with index
- **é¥æµ‹æŸ¥è¯¢**: $O(\log T)$ with time index

---

## 2. è®¾å¤‡æ¨¡å‹è®¾è®¡

### 2.1 è®¾å¤‡åŸºç¡€æ¨¡å‹

**è®¾å¤‡å…ƒæ•°æ®è¡¨**:

```sql
-- è®¾å¤‡è¡¨ï¼ˆè®¾å¤‡å­ªç”Ÿï¼‰
CREATE TABLE device_twin (
    device_id VARCHAR(50) PRIMARY KEY,
    device_name VARCHAR(200) NOT NULL,
    device_type VARCHAR(50) NOT NULL,
    -- è®¾å¤‡å±æ€§ï¼ˆJSONBå­˜å‚¨çµæ´»å±æ€§ï¼‰
    properties JSONB DEFAULT '{}',
    -- è®¾å¤‡é…ç½®
    configuration JSONB DEFAULT '{}',
    -- è®¾å¤‡çŠ¶æ€
    status VARCHAR(50) DEFAULT 'offline', -- 'online', 'offline', 'error'
    -- ä½ç½®ä¿¡æ¯
    location JSONB,
    -- å…ƒæ•°æ®
    manufacturer VARCHAR(100),
    model_number VARCHAR(100),
    serial_number VARCHAR(100),
    firmware_version VARCHAR(50),
    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_seen_at TIMESTAMPTZ
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_device_twin_type ON device_twin(device_type);
CREATE INDEX idx_device_twin_status ON device_twin(status);
CREATE INDEX idx_device_twin_properties ON device_twin USING GIN(properties);
```

### 2.2 è®¾å¤‡å±æ€§æ¨¡å‹

**ç»“æ„åŒ–å±æ€§è®¾è®¡**:

```sql
-- è®¾å¤‡å±æ€§å®šä¹‰è¡¨
CREATE TABLE device_property_definition (
    property_id SERIAL PRIMARY KEY,
    device_type VARCHAR(50) NOT NULL,
    property_name VARCHAR(100) NOT NULL,
    property_type VARCHAR(50) NOT NULL, -- 'string', 'number', 'boolean', 'object'
    description TEXT,
    default_value JSONB,
    constraints JSONB, -- çº¦æŸæ¡ä»¶ï¼Œå¦‚èŒƒå›´ã€æšä¸¾å€¼ç­‰
    is_required BOOLEAN DEFAULT FALSE,
    UNIQUE(device_type, property_name)
);

-- ç¤ºä¾‹ï¼šæ¸©åº¦ä¼ æ„Ÿå™¨å±æ€§å®šä¹‰
INSERT INTO device_property_definition (
    device_type, property_name, property_type, description, constraints, is_required
) VALUES
    ('temperature_sensor', 'temperature', 'number', 'æ¸©åº¦å€¼ï¼ˆæ‘„æ°åº¦ï¼‰',
     '{"min": -50, "max": 100}', TRUE),
    ('temperature_sensor', 'humidity', 'number', 'æ¹¿åº¦å€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰',
     '{"min": 0, "max": 100}', FALSE),
    ('temperature_sensor', 'battery_level', 'number', 'ç”µæ± ç”µé‡',
     '{"min": 0, "max": 100}', FALSE);
```

### 2.3 è®¾å¤‡å…³ç³»æ¨¡å‹

**è®¾å¤‡å±‚çº§å…³ç³»**:

```sql
-- è®¾å¤‡å…³ç³»è¡¨ï¼ˆæ”¯æŒå±‚çº§ç»“æ„ï¼‰
CREATE TABLE device_relationship (
    relationship_id SERIAL PRIMARY KEY,
    parent_device_id VARCHAR(50) REFERENCES device_twin(device_id),
    child_device_id VARCHAR(50) REFERENCES device_twin(device_id),
    relationship_type VARCHAR(50) NOT NULL, -- 'contains', 'controls', 'monitors'
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(parent_device_id, child_device_id, relationship_type),
    CHECK (parent_device_id != child_device_id)
);

-- ç¤ºä¾‹ï¼šç½‘å…³åŒ…å«å¤šä¸ªä¼ æ„Ÿå™¨
INSERT INTO device_relationship (parent_device_id, child_device_id, relationship_type) VALUES
    ('gateway_001', 'sensor_001', 'contains'),
    ('gateway_001', 'sensor_002', 'contains'),
    ('gateway_001', 'sensor_003', 'contains');
```

---

## 3. çŠ¶æ€ç®¡ç†

### 3.1 è®¾å¤‡çŠ¶æ€è¡¨

**çŠ¶æ€å†å²è®°å½•**:

```sql
-- è®¾å¤‡çŠ¶æ€å†å²è¡¨
CREATE TABLE device_state_history (
    state_id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL REFERENCES device_twin(device_id),
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(50) NOT NULL,
    state_data JSONB, -- å®Œæ•´çŠ¶æ€å¿«ç…§
    -- çŠ¶æ€å˜åŒ–åŸå› 
    change_reason VARCHAR(200),
    -- æ—¶é—´æˆ³
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_state_history_device_time ON device_state_history(device_id, timestamp DESC);
CREATE INDEX idx_state_history_status ON device_state_history(status, timestamp DESC);

-- åˆ†åŒºï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE device_state_history (
    state_id BIGSERIAL,
    device_id VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    state_data JSONB,
    change_reason VARCHAR(200),
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (state_id, timestamp)
) PARTITION BY RANGE (timestamp);

CREATE TABLE device_state_history_2025_01
    PARTITION OF device_state_history
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 3.2 çŠ¶æ€æ›´æ–°å‡½æ•°

**çŠ¶æ€åŒæ­¥å‡½æ•°**:

```sql
-- æ›´æ–°è®¾å¤‡çŠ¶æ€
CREATE OR REPLACE FUNCTION update_device_state(
    p_device_id VARCHAR,
    p_status VARCHAR,
    p_state_data JSONB DEFAULT NULL,
    p_change_reason VARCHAR DEFAULT NULL
)
RETURNS VOID AS $$
BEGIN
    -- æ›´æ–°è®¾å¤‡å­ªç”Ÿå½“å‰çŠ¶æ€
    UPDATE device_twin
    SET
        status = p_status,
        properties = COALESCE(p_state_data, properties),
        updated_at = NOW(),
        last_seen_at = NOW()
    WHERE device_id = p_device_id;

    -- è®°å½•çŠ¶æ€å†å²
    INSERT INTO device_state_history (
        device_id, status, state_data, change_reason
    ) VALUES (
        p_device_id, p_status, p_state_data, p_change_reason
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT update_device_state(
    'device_001',
    'online',
    '{"temperature": 25.5, "humidity": 60.0}'::JSONB,
    'è®¾å¤‡ä¸Šçº¿'
);
```

### 3.3 çŠ¶æ€æŸ¥è¯¢

**å½“å‰çŠ¶æ€æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢è®¾å¤‡å½“å‰çŠ¶æ€
SELECT
    dt.device_id,
    dt.device_name,
    dt.status,
    dt.properties,
    dt.last_seen_at,
    CASE
        WHEN dt.last_seen_at > NOW() - INTERVAL '5 minutes' THEN 'active'
        WHEN dt.last_seen_at > NOW() - INTERVAL '1 hour' THEN 'inactive'
        ELSE 'offline'
    END AS activity_status
FROM device_twin dt
WHERE dt.device_id = 'device_001';

-- æŸ¥è¯¢çŠ¶æ€å†å²
SELECT
    status,
    timestamp,
    state_data,
    change_reason,
    LAG(status) OVER (ORDER BY timestamp) AS previous_status
FROM device_state_history
WHERE device_id = 'device_001'
ORDER BY timestamp DESC
LIMIT 100;
```

---

## 4. é¥æµ‹æ•°æ®

### 4.1 é¥æµ‹æ•°æ®æ¨¡å‹

**é¥æµ‹æ•°æ®è¡¨**:

```sql
-- é¥æµ‹æ•°æ®è¡¨ï¼ˆä½¿ç”¨TimescaleDBï¼‰
CREATE TABLE device_telemetry (
    time TIMESTAMPTZ NOT NULL,
    device_id VARCHAR(50) NOT NULL REFERENCES device_twin(device_id),
    -- é¥æµ‹æ•°æ®ï¼ˆJSONBå­˜å‚¨çµæ´»ç»“æ„ï¼‰
    telemetry_data JSONB NOT NULL,
    -- æ•°æ®è´¨é‡
    quality_code INT DEFAULT 0, -- 0=good, 1=uncertain, 2=bad
    -- å…ƒæ•°æ®
    metadata JSONB
);

-- è½¬æ¢ä¸ºHypertable
SELECT create_hypertable('device_telemetry', 'time',
    chunk_time_interval => INTERVAL '1 day');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_telemetry_device_time ON device_telemetry(device_id, time DESC);
CREATE INDEX idx_telemetry_data ON device_telemetry USING GIN(telemetry_data);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO device_telemetry (time, device_id, telemetry_data) VALUES
    (NOW(), 'device_001', '{"temperature": 25.5, "humidity": 60.0, "pressure": 1013.25}'),
    (NOW() + INTERVAL '1 second', 'device_001', '{"temperature": 25.6, "humidity": 60.1, "pressure": 1013.26}');
```

### 4.2 é¥æµ‹æ•°æ®æŸ¥è¯¢

**æ•°æ®æŸ¥è¯¢å‡½æ•°**:

```sql
-- æŸ¥è¯¢è®¾å¤‡é¥æµ‹æ•°æ®
CREATE OR REPLACE FUNCTION get_device_telemetry(
    p_device_id VARCHAR,
    p_start_time TIMESTAMPTZ,
    p_end_time TIMESTAMPTZ,
    p_metric_name VARCHAR DEFAULT NULL
)
RETURNS TABLE (
    time TIMESTAMPTZ,
    metric_name VARCHAR,
    metric_value DOUBLE PRECISION
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        dt.time,
        key AS metric_name,
        (value::TEXT)::DOUBLE PRECISION AS metric_value
    FROM device_telemetry dt,
         jsonb_each(dt.telemetry_data) AS kv
    WHERE dt.device_id = p_device_id
      AND dt.time BETWEEN p_start_time AND p_end_time
      AND (p_metric_name IS NULL OR key = p_metric_name)
    ORDER BY dt.time DESC;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM get_device_telemetry(
    'device_001',
    NOW() - INTERVAL '1 hour',
    NOW(),
    'temperature'
);
```

---

## 5. å‘½ä»¤ä¸æ§åˆ¶

### 5.1 å‘½ä»¤æ¨¡å‹

**è®¾å¤‡å‘½ä»¤è¡¨**:

```sql
-- è®¾å¤‡å‘½ä»¤è¡¨
CREATE TABLE device_command (
    command_id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL REFERENCES device_twin(device_id),
    -- å‘½ä»¤ä¿¡æ¯
    command_name VARCHAR(100) NOT NULL,
    command_payload JSONB,
    -- å‘½ä»¤çŠ¶æ€
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'sent', 'acknowledged', 'completed', 'failed'
    -- ä¼˜å…ˆçº§
    priority INT DEFAULT 5 CHECK (priority BETWEEN 1 AND 10),
    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sent_at TIMESTAMPTZ,
    acknowledged_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    -- ç»“æœ
    result JSONB,
    error_message TEXT,
    -- è¶…æ—¶è®¾ç½®
    timeout_seconds INT DEFAULT 30
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_command_device_status ON device_command(device_id, status);
CREATE INDEX idx_command_pending ON device_command(status, priority DESC, created_at)
    WHERE status = 'pending';
```

### 5.2 å‘½ä»¤æ‰§è¡Œå‡½æ•°

**å‘½ä»¤å‘é€å‡½æ•°**:

```sql
-- å‘é€è®¾å¤‡å‘½ä»¤
CREATE OR REPLACE FUNCTION send_device_command(
    p_device_id VARCHAR,
    p_command_name VARCHAR,
    p_command_payload JSONB DEFAULT NULL,
    p_priority INT DEFAULT 5,
    p_timeout_seconds INT DEFAULT 30
)
RETURNS BIGINT AS $$
DECLARE
    v_command_id BIGINT;
BEGIN
    -- æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿
    IF NOT EXISTS (
        SELECT 1 FROM device_twin
        WHERE device_id = p_device_id AND status = 'online'
    ) THEN
        RAISE EXCEPTION 'Device % is not online', p_device_id;
    END IF;

    -- åˆ›å»ºå‘½ä»¤
    INSERT INTO device_command (
        device_id, command_name, command_payload, priority, timeout_seconds
    ) VALUES (
        p_device_id, p_command_name, p_command_payload, p_priority, p_timeout_seconds
    ) RETURNING command_id INTO v_command_id;

    RETURN v_command_id;
END;
$$ LANGUAGE plpgsql;

-- æ›´æ–°å‘½ä»¤çŠ¶æ€
CREATE OR REPLACE FUNCTION update_command_status(
    p_command_id BIGINT,
    p_status VARCHAR,
    p_result JSONB DEFAULT NULL,
    p_error_message TEXT DEFAULT NULL
)
RETURNS VOID AS $$
BEGIN
    UPDATE device_command
    SET
        status = p_status,
        result = p_result,
        error_message = p_error_message,
        sent_at = CASE WHEN p_status = 'sent' THEN NOW() ELSE sent_at END,
        acknowledged_at = CASE WHEN p_status = 'acknowledged' THEN NOW() ELSE acknowledged_at END,
        completed_at = CASE WHEN p_status IN ('completed', 'failed') THEN NOW() ELSE completed_at END
    WHERE command_id = p_command_id;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 å‘½ä»¤æŸ¥è¯¢

**å¾…æ‰§è¡Œå‘½ä»¤æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢å¾…æ‰§è¡Œçš„å‘½ä»¤
SELECT
    command_id,
    device_id,
    command_name,
    command_payload,
    priority,
    created_at,
    EXTRACT(EPOCH FROM (NOW() - created_at)) AS age_seconds
FROM device_command
WHERE status = 'pending'
  AND device_id = 'device_001'
ORDER BY priority DESC, created_at ASC
LIMIT 10;

-- æŸ¥è¯¢å‘½ä»¤å†å²
SELECT
    command_id,
    device_id,
    command_name,
    status,
    created_at,
    completed_at,
    EXTRACT(EPOCH FROM (completed_at - created_at)) AS execution_time_seconds
FROM device_command
WHERE device_id = 'device_001'
ORDER BY created_at DESC
LIMIT 100;
```

---

## 6. PostgreSQLå®ç°

### 6.1 å®Œæ•´è®¾å¤‡å­ªç”Ÿç³»ç»Ÿ

```sql
-- è®¾å¤‡å­ªç”Ÿä¸»è¡¨
CREATE TABLE device_twin (
    device_id VARCHAR(50) PRIMARY KEY,
    device_name VARCHAR(200) NOT NULL,
    device_type VARCHAR(50) NOT NULL,
    properties JSONB DEFAULT '{}',
    configuration JSONB DEFAULT '{}',
    status VARCHAR(50) DEFAULT 'offline',
    location JSONB,
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_seen_at TIMESTAMPTZ
);

-- è®¾å¤‡çŠ¶æ€å†å²ï¼ˆåˆ†åŒºè¡¨ï¼‰
CREATE TABLE device_state_history (
    state_id BIGSERIAL,
    device_id VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    state_data JSONB,
    change_reason VARCHAR(200),
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (state_id, timestamp)
) PARTITION BY RANGE (timestamp);

-- è®¾å¤‡é¥æµ‹æ•°æ®ï¼ˆHypertableï¼‰
CREATE TABLE device_telemetry (
    time TIMESTAMPTZ NOT NULL,
    device_id VARCHAR(50) NOT NULL,
    telemetry_data JSONB NOT NULL,
    quality_code INT DEFAULT 0,
    metadata JSONB
);

SELECT create_hypertable('device_telemetry', 'time');

-- è®¾å¤‡å‘½ä»¤è¡¨
CREATE TABLE device_command (
    command_id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL,
    command_name VARCHAR(100) NOT NULL,
    command_payload JSONB,
    status VARCHAR(50) DEFAULT 'pending',
    priority INT DEFAULT 5,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sent_at TIMESTAMPTZ,
    acknowledged_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    result JSONB,
    error_message TEXT,
    timeout_seconds INT DEFAULT 30
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_device_twin_status ON device_twin(status);
CREATE INDEX idx_device_twin_properties ON device_twin USING GIN(properties);
CREATE INDEX idx_state_history_device ON device_state_history(device_id, timestamp DESC);
CREATE INDEX idx_telemetry_device ON device_telemetry(device_id, time DESC);
CREATE INDEX idx_command_pending ON device_command(device_id, status, priority DESC);
```

### 6.2 è®¾å¤‡å­ªç”Ÿè§†å›¾

**ç»¼åˆè§†å›¾**:

```sql
-- è®¾å¤‡å­ªç”Ÿç»¼åˆè§†å›¾
CREATE VIEW device_twin_summary AS
SELECT
    dt.device_id,
    dt.device_name,
    dt.device_type,
    dt.status,
    dt.last_seen_at,
    -- æœ€æ–°é¥æµ‹æ•°æ®
    (
        SELECT telemetry_data
        FROM device_telemetry
        WHERE device_id = dt.device_id
        ORDER BY time DESC
        LIMIT 1
    ) AS latest_telemetry,
    -- å¾…æ‰§è¡Œå‘½ä»¤æ•°
    (
        SELECT COUNT(*)
        FROM device_command
        WHERE device_id = dt.device_id AND status = 'pending'
    ) AS pending_commands,
    -- ä»Šæ—¥æ•°æ®ç‚¹æ•°
    (
        SELECT COUNT(*)
        FROM device_telemetry
        WHERE device_id = dt.device_id
          AND time > CURRENT_DATE
    ) AS today_data_points
FROM device_twin dt;
```

---

## 7. æ›´å¤šå®é™…æ¡ˆä¾‹ / More Practical Examples

### 7.1 æ¡ˆä¾‹1: æ™ºèƒ½å®¶å±…è®¾å¤‡å­ªç”Ÿ

**æ™ºèƒ½å®¶å±…è®¾å¤‡å®Œæ•´å®ç°**:

```sql
-- æ™ºèƒ½å®¶å±…è®¾å¤‡ç±»å‹
INSERT INTO device_type (type_name, description, schema_definition) VALUES
    ('smart_thermostat', 'æ™ºèƒ½æ’æ¸©å™¨', '{
        "properties": {
            "temperature": {"type": "number", "unit": "celsius"},
            "humidity": {"type": "number", "unit": "percent"},
            "mode": {"type": "string", "enum": ["heat", "cool", "auto", "off"]},
            "target_temperature": {"type": "number"}
        },
        "commands": ["set_temperature", "set_mode", "schedule"]
    }'::jsonb),
    ('smart_light', 'æ™ºèƒ½ç¯æ³¡', '{
        "properties": {
            "brightness": {"type": "number", "min": 0, "max": 100},
            "color": {"type": "string"},
            "power": {"type": "boolean"}
        },
        "commands": ["turn_on", "turn_off", "set_brightness", "set_color"]
    }'::jsonb);

-- æ™ºèƒ½å®¶å±…è®¾å¤‡
INSERT INTO device (device_id, device_name, device_type, location, metadata) VALUES
    ('thermostat_001', 'å®¢å…æ’æ¸©å™¨', 'smart_thermostat', 'å®¢å…', '{"room": "living_room"}'::jsonb),
    ('light_001', 'å§å®¤ç¯', 'smart_light', 'ä¸»å§å®¤', '{"room": "master_bedroom"}'::jsonb);

-- è®¾å¤‡å±æ€§
INSERT INTO device_property (device_id, property_name, property_value, updated_at) VALUES
    ('thermostat_001', 'temperature', '22.5', NOW()),
    ('thermostat_001', 'humidity', '45', NOW()),
    ('thermostat_001', 'mode', 'auto', NOW()),
    ('thermostat_001', 'target_temperature', '23', NOW()),
    ('light_001', 'brightness', '80', NOW()),
    ('light_001', 'color', '#FFFFFF', NOW()),
    ('light_001', 'power', 'true', NOW());

-- æŸ¥è¯¢æ™ºèƒ½å®¶å±…è®¾å¤‡çŠ¶æ€
SELECT
    d.device_name,
    d.location,
    jsonb_object_agg(dp.property_name, dp.property_value) AS current_state
FROM device d
LEFT JOIN device_property dp ON d.device_id = dp.device_id
WHERE d.device_type IN ('smart_thermostat', 'smart_light')
GROUP BY d.device_id, d.device_name, d.location;
```

### 7.2 æ¡ˆä¾‹2: å·¥ä¸šè®¾å¤‡ç›‘æ§å­ªç”Ÿ

**å·¥ä¸šè®¾å¤‡ç›‘æ§ç³»ç»Ÿ**:

```sql
-- å·¥ä¸šè®¾å¤‡ç±»å‹
INSERT INTO device_type (type_name, description, schema_definition) VALUES
    ('industrial_motor', 'å·¥ä¸šç”µæœº', '{
        "properties": {
            "rpm": {"type": "number", "unit": "rpm"},
            "temperature": {"type": "number", "unit": "celsius"},
            "vibration": {"type": "number", "unit": "mm/s"},
            "power_consumption": {"type": "number", "unit": "kW"},
            "status": {"type": "string", "enum": ["running", "stopped", "maintenance", "error"]}
        },
        "commands": ["start", "stop", "set_speed", "emergency_stop"],
        "alerts": {
            "high_temperature": {"threshold": 80, "severity": "critical"},
            "high_vibration": {"threshold": 10, "severity": "warning"}
        }
    }'::jsonb);

-- å·¥ä¸šè®¾å¤‡
INSERT INTO device (device_id, device_name, device_type, location, metadata) VALUES
    ('motor_001', 'ç”Ÿäº§çº¿1å·ç”µæœº', 'industrial_motor', 'ç”Ÿäº§è½¦é—´A', '{"production_line": "line_1"}'::jsonb),
    ('motor_002', 'ç”Ÿäº§çº¿2å·ç”µæœº', 'industrial_motor', 'ç”Ÿäº§è½¦é—´A', '{"production_line": "line_2"}'::jsonb);

-- è®¾å¤‡é¥æµ‹æ•°æ®ï¼ˆä½¿ç”¨TimescaleDBï¼‰
CREATE TABLE device_telemetry (
    time TIMESTAMPTZ NOT NULL,
    device_id VARCHAR(100) NOT NULL,
    rpm DOUBLE PRECISION,
    temperature DOUBLE PRECISION,
    vibration DOUBLE PRECISION,
    power_consumption DOUBLE PRECISION
);

SELECT create_hypertable('device_telemetry', 'time');

-- è®¾å¤‡çŠ¶æ€ç›‘æ§æŸ¥è¯¢
CREATE VIEW device_health_monitor AS
SELECT
    d.device_id,
    d.device_name,
    dt.temperature,
    dt.vibration,
    dt.rpm,
    CASE
        WHEN dt.temperature > 80 THEN 'critical'
        WHEN dt.vibration > 10 THEN 'warning'
        ELSE 'normal'
    END AS health_status,
    dt.time AS last_update
FROM device d
JOIN LATERAL (
    SELECT * FROM device_telemetry
    WHERE device_id = d.device_id
    ORDER BY time DESC LIMIT 1
) dt ON true
WHERE d.device_type = 'industrial_motor';
```

### 7.3 æ¡ˆä¾‹3: è½¦è¾†è®¾å¤‡å­ªç”Ÿ

**è½¦è¾†è®¾å¤‡å­ªç”Ÿç³»ç»Ÿ**:

```sql
-- è½¦è¾†è®¾å¤‡ç±»å‹
INSERT INTO device_type (type_name, description, schema_definition) VALUES
    ('vehicle', 'è½¦è¾†', '{
        "properties": {
            "speed": {"type": "number", "unit": "km/h"},
            "fuel_level": {"type": "number", "unit": "percent"},
            "engine_temperature": {"type": "number", "unit": "celsius"},
            "location": {"type": "object", "properties": {"lat": "number", "lon": "number"}},
            "odometer": {"type": "number", "unit": "km"},
            "status": {"type": "string", "enum": ["running", "parked", "maintenance"]}
        },
        "commands": ["lock", "unlock", "start_engine", "stop_engine", "set_route"]
    }'::jsonb);

-- è½¦è¾†è®¾å¤‡
INSERT INTO device (device_id, device_name, device_type, location, metadata) VALUES
    ('vehicle_001', 'å…¬å¸è½¦è¾†001', 'vehicle', 'æ€»éƒ¨åœè½¦åœº', '{"license_plate": "äº¬A12345", "driver": "å¼ ä¸‰"}'::jsonb);

-- è½¦è¾†ä½ç½®è¿½è¸ªï¼ˆä½¿ç”¨PostGISï¼‰
CREATE EXTENSION IF NOT EXISTS postgis;

ALTER TABLE device_telemetry
ADD COLUMN location GEOGRAPHY(POINT, 4326);

CREATE INDEX idx_device_telemetry_location
ON device_telemetry USING GIST (location);

-- æŸ¥è¯¢è½¦è¾†å½“å‰ä½ç½®å’Œè½¨è¿¹
SELECT
    device_id,
    time,
    ST_AsText(location) AS location,
    speed,
    fuel_level
FROM device_telemetry
WHERE device_id = 'vehicle_001'
  AND time >= NOW() - INTERVAL '24 hours'
ORDER BY time DESC;
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ / Performance Optimization and Monitoring

### 8.1 è®¾å¤‡å­ªç”Ÿæ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**:

```sql
-- è®¾å¤‡å±æ€§ç´¢å¼•
CREATE INDEX idx_device_property_device
ON device_property(device_id, property_name, updated_at DESC);

-- è®¾å¤‡å‘½ä»¤ç´¢å¼•
CREATE INDEX idx_device_command_device_status
ON device_command(device_id, status, created_at DESC);

-- è®¾å¤‡é¥æµ‹æ•°æ®ç´¢å¼•ï¼ˆTimescaleDBï¼‰
CREATE INDEX idx_telemetry_device_time
ON device_telemetry(device_id, time DESC);

-- è®¾å¤‡çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_device_twin_status
ON device_twin(status, last_connected_at);
```

**æ‰¹é‡æ›´æ–°ä¼˜åŒ–**:

```sql
-- æ‰¹é‡æ›´æ–°è®¾å¤‡å±æ€§
CREATE OR REPLACE FUNCTION batch_update_device_properties(
    p_updates JSONB
)
RETURNS VOID AS $$
DECLARE
    v_update JSONB;
BEGIN
    FOR v_update IN SELECT * FROM jsonb_array_elements(p_updates)
    LOOP
        INSERT INTO device_property (device_id, property_name, property_value, updated_at)
        VALUES (
            v_update->>'device_id',
            v_update->>'property_name',
            v_update->>'property_value',
            NOW()
        )
        ON CONFLICT (device_id, property_name)
        DO UPDATE SET
            property_value = EXCLUDED.property_value,
            updated_at = EXCLUDED.updated_at;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 è®¾å¤‡å­ªç”Ÿç›‘æ§

**è®¾å¤‡ç›‘æ§æŸ¥è¯¢**:

```sql
-- ç›‘æ§ï¼šè®¾å¤‡è¿æ¥çŠ¶æ€
SELECT
    device_type,
    COUNT(*) FILTER (WHERE status = 'online') AS online_count,
    COUNT(*) FILTER (WHERE status = 'offline') AS offline_count,
    COUNT(*) FILTER (WHERE status = 'error') AS error_count,
    AVG(EXTRACT(EPOCH FROM (NOW() - last_connected_at)))
        FILTER (WHERE status = 'offline') AS avg_offline_seconds
FROM device_twin
GROUP BY device_type
ORDER BY online_count DESC;

-- ç›‘æ§ï¼šè®¾å¤‡é¥æµ‹æ•°æ®é¢‘ç‡
SELECT
    device_id,
    COUNT(*) AS data_points,
    MIN(time) AS first_data,
    MAX(time) AS last_data,
    EXTRACT(EPOCH FROM (MAX(time) - MIN(time))) / COUNT(*) AS avg_interval_seconds
FROM device_telemetry
WHERE time >= NOW() - INTERVAL '1 hour'
GROUP BY device_id
HAVING MAX(time) < NOW() - INTERVAL '5 minutes'  -- æ•°æ®å»¶è¿Ÿçš„è®¾å¤‡
ORDER BY avg_interval_seconds DESC;

-- ç›‘æ§ï¼šå¾…å¤„ç†å‘½ä»¤
SELECT
    device_id,
    COUNT(*) AS pending_commands,
    MIN(created_at) AS oldest_command,
    MAX(created_at) AS newest_command
FROM device_command
WHERE status = 'pending'
GROUP BY device_id
ORDER BY pending_commands DESC;
```

---

## 9. å¸¸è§é—®é¢˜è§£ç­” / FAQ

### Q1: è®¾å¤‡å­ªç”Ÿæ•°æ®åº”è¯¥å­˜å‚¨å¤šä¹…ï¼Ÿ

**A**: æ•°æ®ä¿ç•™ç­–ç•¥ï¼š

- **å®æ—¶æ•°æ®**: ä¿ç•™æœ€è¿‘24å°æ—¶ï¼ˆç”¨äºå®æ—¶ç›‘æ§ï¼‰
- **å†å²æ•°æ®**: ä¿ç•™1-3ä¸ªæœˆï¼ˆç”¨äºåˆ†æå’ŒæŠ¥å‘Šï¼‰
- **èšåˆæ•°æ®**: æ°¸ä¹…ä¿ç•™ï¼ˆç”¨äºè¶‹åŠ¿åˆ†æï¼‰

**å®ç°**:

```sql
-- æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆTimescaleDBï¼‰
SELECT add_retention_policy('device_telemetry', INTERVAL '90 days');

-- å®šæœŸå½’æ¡£æ—§æ•°æ®
CREATE TABLE device_telemetry_archive (LIKE device_telemetry INCLUDING ALL);

INSERT INTO device_telemetry_archive
SELECT * FROM device_telemetry
WHERE time < NOW() - INTERVAL '90 days';

DELETE FROM device_telemetry
WHERE time < NOW() - INTERVAL '90 days';
```

### Q2: å¦‚ä½•å¤„ç†è®¾å¤‡ç¦»çº¿æƒ…å†µï¼Ÿ

**A**: ç¦»çº¿å¤„ç†ç­–ç•¥ï¼š

```sql
-- æ£€æµ‹ç¦»çº¿è®¾å¤‡
CREATE OR REPLACE FUNCTION detect_offline_devices(
    p_timeout_seconds INT DEFAULT 300
)
RETURNS TABLE(device_id VARCHAR, last_connected TIMESTAMPTZ) AS $$
BEGIN
    RETURN QUERY
    SELECT dt.device_id, dt.last_connected_at
    FROM device_twin dt
    WHERE dt.status = 'online'
      AND dt.last_connected_at < NOW() - (p_timeout_seconds || ' seconds')::INTERVAL;
END;
$$ LANGUAGE plpgsql;

-- æ›´æ–°ç¦»çº¿çŠ¶æ€
UPDATE device_twin
SET status = 'offline',
    last_disconnected_at = NOW()
WHERE device_id IN (
    SELECT device_id FROM detect_offline_devices(300)
);
```

### Q3: è®¾å¤‡å‘½ä»¤å¦‚ä½•ä¿è¯å¯é æ€§ï¼Ÿ

**A**: å¯é æ€§ä¿è¯ï¼š

1. **å‘½ä»¤ç¡®è®¤**: è®¾å¤‡æ”¶åˆ°å‘½ä»¤åå‘é€ç¡®è®¤
2. **è¶…æ—¶é‡è¯•**: å‘½ä»¤è¶…æ—¶åè‡ªåŠ¨é‡è¯•
3. **å‘½ä»¤é˜Ÿåˆ—**: ä½¿ç”¨é˜Ÿåˆ—ç®¡ç†å‘½ä»¤æ‰§è¡Œé¡ºåº

```sql
-- å‘½ä»¤ç¡®è®¤æœºåˆ¶
CREATE OR REPLACE FUNCTION confirm_command(
    p_command_id BIGINT,
    p_status VARCHAR,
    p_result JSONB DEFAULT NULL
)
RETURNS VOID AS $$
BEGIN
    UPDATE device_command
    SET status = p_status,
        completed_at = NOW(),
        result = p_result
    WHERE command_id = p_command_id;
END;
$$ LANGUAGE plpgsql;

-- è¶…æ—¶é‡è¯•
CREATE OR REPLACE FUNCTION retry_timeout_commands()
RETURNS VOID AS $$
BEGIN
    UPDATE device_command
    SET status = 'pending',
        retry_count = retry_count + 1,
        created_at = NOW()
    WHERE status = 'pending'
      AND created_at < NOW() - INTERVAL '30 seconds'
      AND retry_count < 3;
END;
$$ LANGUAGE plpgsql;
```

### Q4: è®¾å¤‡å­ªç”Ÿæ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**A**: æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š

1. **åˆ†åŒº**: å¯¹é¥æµ‹æ•°æ®è¡¨è¿›è¡Œæ—¶é—´åˆ†åŒº
2. **å‹ç¼©**: ä½¿ç”¨TimescaleDBå‹ç¼©æ—§æ•°æ®
3. **èšåˆ**: åˆ›å»ºè¿ç»­èšåˆè§†å›¾
4. **ç´¢å¼•**: ä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•

```sql
-- åˆ›å»ºè¿ç»­èšåˆï¼ˆTimescaleDBï¼‰
CREATE MATERIALIZED VIEW device_telemetry_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    device_id,
    AVG(temperature) AS avg_temperature,
    MAX(temperature) AS max_temperature,
    MIN(temperature) AS min_temperature,
    COUNT(*) AS data_points
FROM device_telemetry
GROUP BY bucket, device_id;

-- æ·»åŠ åˆ·æ–°ç­–ç•¥
SELECT add_continuous_aggregate_policy('device_telemetry_hourly',
    start_offset => INTERVAL '3 hours',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour');
```

### Q5: å¦‚ä½•å®ç°è®¾å¤‡å­ªç”Ÿçš„åŒæ­¥ï¼Ÿ

**A**: åŒæ­¥ç­–ç•¥ï¼š

```sql
-- è®¾å¤‡å±æ€§åŒæ­¥å‡½æ•°
CREATE OR REPLACE FUNCTION sync_device_twin(
    p_device_id VARCHAR,
    p_properties JSONB
)
RETURNS VOID AS $$
DECLARE
    v_property_name TEXT;
    v_property_value TEXT;
BEGIN
    -- æ›´æ–°è®¾å¤‡å±æ€§
    FOR v_property_name, v_property_value IN
        SELECT * FROM jsonb_each_text(p_properties)
    LOOP
        INSERT INTO device_property (device_id, property_name, property_value, updated_at)
        VALUES (p_device_id, v_property_name, v_property_value, NOW())
        ON CONFLICT (device_id, property_name)
        DO UPDATE SET
            property_value = EXCLUDED.property_value,
            updated_at = EXCLUDED.updated_at;
    END LOOP;

    -- æ›´æ–°è®¾å¤‡è¿æ¥çŠ¶æ€
    UPDATE device_twin
    SET status = 'online',
        last_connected_at = NOW(),
        last_sync_at = NOW()
    WHERE device_id = p_device_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 9. ç›¸å…³èµ„æº / Related Resources

### 9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents

- [æ—¶åºæ•°æ®æ¨¡å‹](./æ—¶åºæ•°æ®æ¨¡å‹.md) - æ—¶åºæ•°æ®å»ºæ¨¡æŒ‡å—
- [TimescaleDBå®è·µ](./TimescaleDBå®è·µ.md) - TimescaleDBè¯¦ç»†æŒ‡å—
- [æ•°æ®ç±»å‹é€‰æ‹©](../08-PostgreSQLå»ºæ¨¡å®è·µ/æ•°æ®ç±»å‹é€‰æ‹©.md) - JSONBæ•°æ®ç±»å‹é€‰æ‹©
- [ç´¢å¼•ç­–ç•¥](../08-PostgreSQLå»ºæ¨¡å®è·µ/ç´¢å¼•ç­–ç•¥.md) - è®¾å¤‡å­ªç”Ÿç´¢å¼•è®¾è®¡
- [æ€§èƒ½ä¼˜åŒ–](../08-PostgreSQLå»ºæ¨¡å®è·µ/æ€§èƒ½ä¼˜åŒ–.md) - è®¾å¤‡å­ªç”Ÿæ€§èƒ½ä¼˜åŒ–

### 9.2 ç†è®ºåŸºç¡€ / Theoretical Foundation

- [èŒƒå¼ç†è®º](../01-æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€/èŒƒå¼ç†è®º.md) - è®¾å¤‡æ•°æ®èŒƒå¼è®¾è®¡

### 9.3 å®è·µæŒ‡å— / Practical Guides

- [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#8-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§--performance-optimization-and-monitoring) - æœ¬æ–‡æ¡£çš„æ€§èƒ½ç›‘æ§ç« èŠ‚
- [æ›´å¤šå®é™…æ¡ˆä¾‹](#7-æ›´å¤šå®é™…æ¡ˆä¾‹--more-practical-examples) - æœ¬æ–‡æ¡£çš„åº”ç”¨æ¡ˆä¾‹ç« èŠ‚

### 9.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases

- [IoTç›‘æ§ç³»ç»Ÿæ¡ˆä¾‹](../10-ç»¼åˆåº”ç”¨æ¡ˆä¾‹/IoTç›‘æ§ç³»ç»Ÿæ¡ˆä¾‹.md) - IoTè®¾å¤‡å­ªç”Ÿå®Œæ•´æ¡ˆä¾‹

### 9.5 å‚è€ƒèµ„æº / Reference Resources

- [æƒå¨èµ„æºç´¢å¼•](../00-å¯¼èˆªä¸ç´¢å¼•/æƒå¨èµ„æºç´¢å¼•.md) - æƒå¨èµ„æºåˆ—è¡¨
- [æœ¯è¯­å¯¹ç…§è¡¨](../00-å¯¼èˆªä¸ç´¢å¼•/æœ¯è¯­å¯¹ç…§è¡¨.md) - æœ¯è¯­å¯¹ç…§
- [å¿«é€ŸæŸ¥æ‰¾æŒ‡å—](../00-å¯¼èˆªä¸ç´¢å¼•/å¿«é€ŸæŸ¥æ‰¾æŒ‡å—.md) - å¿«é€ŸæŸ¥æ‰¾å·¥å…·
- Azure IoT Hub: [Azure IoT Hub Device Twins](https://docs.microsoft.com/azure/iot-hub/)
- AWS IoT: [AWS IoT Device Shadow](https://docs.aws.amazon.com/iot/)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
