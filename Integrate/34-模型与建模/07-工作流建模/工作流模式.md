# å·¥ä½œæµæ¨¡å¼

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: å·¥ä½œæµæ¨¡å¼ç ”ç©¶
> **çŠ¶æ€**: âœ… å·²å®Œæˆ
> **æ–‡æ¡£ç¼–å·**: 07-04

---

## ğŸ“‘ ç›®å½•

- [å·¥ä½œæµæ¨¡å¼](#å·¥ä½œæµæ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 å·¥ä½œæµæ¨¡å¼åŸºæœ¬æ¦‚å¿µ](#111-å·¥ä½œæµæ¨¡å¼åŸºæœ¬æ¦‚å¿µ)
    - [1.1.2 é¡ºåºæ¨¡å¼ç†è®º](#112-é¡ºåºæ¨¡å¼ç†è®º)
    - [1.1.3 å¹¶è¡Œæ¨¡å¼ç†è®º](#113-å¹¶è¡Œæ¨¡å¼ç†è®º)
    - [1.1.4 é€‰æ‹©æ¨¡å¼ç†è®º](#114-é€‰æ‹©æ¨¡å¼ç†è®º)
    - [1.1.5 å¾ªç¯æ¨¡å¼ç†è®º](#115-å¾ªç¯æ¨¡å¼ç†è®º)
    - [1.1.6 æ¨¡å¼ç»„åˆç†è®º](#116-æ¨¡å¼ç»„åˆç†è®º)
    - [1.1.7 å¤æ‚åº¦åˆ†æ](#117-å¤æ‚åº¦åˆ†æ)
  - [2. é¡ºåºæ¨¡å¼](#2-é¡ºåºæ¨¡å¼)
    - [2.1 é¡ºåºæ¨¡å¼å®šä¹‰](#21-é¡ºåºæ¨¡å¼å®šä¹‰)
    - [2.2 PostgreSQLå®ç°](#22-postgresqlå®ç°)
    - [2.3 é¡ºåºæ‰§è¡Œå‡½æ•°](#23-é¡ºåºæ‰§è¡Œå‡½æ•°)
  - [3. å¹¶è¡Œæ¨¡å¼](#3-å¹¶è¡Œæ¨¡å¼)
    - [3.1 å¹¶è¡Œæ¨¡å¼å®šä¹‰](#31-å¹¶è¡Œæ¨¡å¼å®šä¹‰)
    - [3.2 PostgreSQLå®ç°](#32-postgresqlå®ç°)
  - [4. é€‰æ‹©æ¨¡å¼](#4-é€‰æ‹©æ¨¡å¼)
    - [4.1 é€‰æ‹©æ¨¡å¼å®šä¹‰](#41-é€‰æ‹©æ¨¡å¼å®šä¹‰)
    - [4.2 PostgreSQLå®ç°](#42-postgresqlå®ç°)
  - [5. å¾ªç¯æ¨¡å¼](#5-å¾ªç¯æ¨¡å¼)
    - [5.1 å¾ªç¯æ¨¡å¼å®šä¹‰](#51-å¾ªç¯æ¨¡å¼å®šä¹‰)
    - [5.2 PostgreSQLå®ç°](#52-postgresqlå®ç°)
  - [6. PostgreSQLå®ç°](#6-postgresqlå®ç°)
    - [6.1 ç»¼åˆå·¥ä½œæµå¼•æ“](#61-ç»¼åˆå·¥ä½œæµå¼•æ“)
  - [7. æ›´å¤šå®é™…æ¡ˆä¾‹ / More Practical Examples](#7-æ›´å¤šå®é™…æ¡ˆä¾‹--more-practical-examples)
    - [7.1 æ¡ˆä¾‹1: è®¢å•å¤„ç†å·¥ä½œæµ](#71-æ¡ˆä¾‹1-è®¢å•å¤„ç†å·¥ä½œæµ)
    - [7.2 æ¡ˆä¾‹2: æ–‡æ¡£å®¡æ‰¹å·¥ä½œæµ](#72-æ¡ˆä¾‹2-æ–‡æ¡£å®¡æ‰¹å·¥ä½œæµ)
    - [7.3 æ¡ˆä¾‹3: æ•°æ®å¤„ç†ç®¡é“å·¥ä½œæµ](#73-æ¡ˆä¾‹3-æ•°æ®å¤„ç†ç®¡é“å·¥ä½œæµ)
  - [8. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ / Performance Optimization and Monitoring](#8-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§--performance-optimization-and-monitoring)
    - [8.1 å·¥ä½œæµæ€§èƒ½ä¼˜åŒ–](#81-å·¥ä½œæµæ€§èƒ½ä¼˜åŒ–)
    - [8.2 å·¥ä½œæµç›‘æ§](#82-å·¥ä½œæµç›‘æ§)
  - [9. å¸¸è§é—®é¢˜è§£ç­” / FAQ](#9-å¸¸è§é—®é¢˜è§£ç­”--faq)
    - [Q1: å·¥ä½œæµåº”è¯¥ä½¿ç”¨é¡ºåºæ¨¡å¼è¿˜æ˜¯å¹¶è¡Œæ¨¡å¼ï¼Ÿ](#q1-å·¥ä½œæµåº”è¯¥ä½¿ç”¨é¡ºåºæ¨¡å¼è¿˜æ˜¯å¹¶è¡Œæ¨¡å¼)
    - [Q2: å¦‚ä½•å¤„ç†å·¥ä½œæµå¤±è´¥å’Œé‡è¯•ï¼Ÿ](#q2-å¦‚ä½•å¤„ç†å·¥ä½œæµå¤±è´¥å’Œé‡è¯•)
    - [Q3: å¦‚ä½•å®ç°å·¥ä½œæµçš„æš‚åœå’Œæ¢å¤ï¼Ÿ](#q3-å¦‚ä½•å®ç°å·¥ä½œæµçš„æš‚åœå’Œæ¢å¤)
    - [Q4: å·¥ä½œæµæ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ](#q4-å·¥ä½œæµæ€§èƒ½å¦‚ä½•ä¼˜åŒ–)
    - [Q5: å¦‚ä½•ç›‘æ§å·¥ä½œæµçš„å¥åº·çŠ¶æ€ï¼Ÿ](#q5-å¦‚ä½•ç›‘æ§å·¥ä½œæµçš„å¥åº·çŠ¶æ€)
  - [9. ç›¸å…³èµ„æº / Related Resources](#9-ç›¸å…³èµ„æº--related-resources)
    - [9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents](#91-æ ¸å¿ƒç›¸å…³æ–‡æ¡£--core-related-documents)
    - [9.2 ç†è®ºåŸºç¡€ / Theoretical Foundation](#92-ç†è®ºåŸºç¡€--theoretical-foundation)
    - [9.3 å®è·µæŒ‡å— / Practical Guides](#93-å®è·µæŒ‡å—--practical-guides)
    - [9.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases](#94-åº”ç”¨æ¡ˆä¾‹--application-cases)
    - [9.5 å‚è€ƒèµ„æº / Reference Resources](#95-å‚è€ƒèµ„æº--reference-resources)

---

## 1. æ¦‚è¿°

å·¥ä½œæµæ¨¡å¼å®šä¹‰äº†å¸¸è§çš„å·¥ä½œæµæ§åˆ¶ç»“æ„ï¼Œæ˜¯æ„å»ºå¤æ‚ä¸šåŠ¡æµç¨‹çš„åŸºç¡€ã€‚
è¿™äº›æ¨¡å¼æ˜¯ç»è¿‡éªŒè¯çš„ã€å¯é‡ç”¨çš„å·¥ä½œæµè®¾è®¡è§£å†³æ–¹æ¡ˆã€‚

**æ ¸å¿ƒä»·å€¼**:

- **æ ‡å‡†åŒ–**ï¼šæä¾›æ ‡å‡†çš„å·¥ä½œæµæ§åˆ¶ç»“æ„
- **å¯é‡ç”¨**ï¼šæ¨¡å¼å¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸­é‡ç”¨
- **å¯ç»„åˆ**ï¼šå¤šä¸ªæ¨¡å¼å¯ä»¥ç»„åˆæˆå¤æ‚æµç¨‹
- **å¯ç»´æŠ¤**ï¼šæ ‡å‡†æ¨¡å¼æ˜“äºç†è§£å’Œç»´æŠ¤

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 å·¥ä½œæµæ¨¡å¼åŸºæœ¬æ¦‚å¿µ

**å·¥ä½œæµæ¨¡å¼ï¼ˆWorkflow Patternsï¼‰**:

- **å®šä¹‰**: å¸¸è§çš„å·¥ä½œæµæ§åˆ¶ç»“æ„
- **æ¥æº**: Workflow Patterns Initiativeç ”ç©¶
- **ç›®çš„**: æä¾›æ ‡å‡†çš„å·¥ä½œæµè®¾è®¡è§£å†³æ–¹æ¡ˆ

**æ¨¡å¼åˆ†ç±»**:

- **æ§åˆ¶æµæ¨¡å¼**: æ§åˆ¶ä»»åŠ¡æ‰§è¡Œé¡ºåº
- **æ•°æ®æµæ¨¡å¼**: æ§åˆ¶æ•°æ®æµè½¬
- **èµ„æºæ¨¡å¼**: æ§åˆ¶èµ„æºåˆ†é…
- **å¼‚å¸¸å¤„ç†æ¨¡å¼**: å¤„ç†å¼‚å¸¸æƒ…å†µ

### 1.1.2 é¡ºåºæ¨¡å¼ç†è®º

**é¡ºåºæ¨¡å¼ï¼ˆSequence Patternï¼‰**:

- **å®šä¹‰**: ä»»åŠ¡æŒ‰å›ºå®šé¡ºåºä¾æ¬¡æ‰§è¡Œ
- **æ•°å­¦è¡¨ç¤º**: $T_1 \rightarrow T_2 \rightarrow ... \rightarrow T_n$
- **æ‰§è¡Œæ¡ä»¶**: å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡

**é¡ºåºæ¨¡å¼ç‰¹ç‚¹**:

- **ä¸¥æ ¼é¡ºåº**: ä»»åŠ¡å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ
- **ä¾èµ–å…³ç³»**: ä»»åŠ¡ä¹‹é—´æœ‰ä¾èµ–å…³ç³»
- **ä¸²è¡Œæ‰§è¡Œ**: ä»»åŠ¡ä¸²è¡Œæ‰§è¡Œ

### 1.1.3 å¹¶è¡Œæ¨¡å¼ç†è®º

**å¹¶è¡Œæ¨¡å¼ï¼ˆParallel Patternï¼‰**:

- **å®šä¹‰**: å¤šä¸ªä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ
- **æ•°å­¦è¡¨ç¤º**: $T_1 || T_2 || ... || T_n$
- **åŒæ­¥ç‚¹**: æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­

**å¹¶è¡Œæ¨¡å¼ç‰¹ç‚¹**:

- **å¹¶è¡Œæ‰§è¡Œ**: ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
- **åŒæ­¥**: éœ€è¦åŒæ­¥ç‚¹
- **æ€§èƒ½**: æé«˜æ‰§è¡Œæ€§èƒ½

### 1.1.4 é€‰æ‹©æ¨¡å¼ç†è®º

**é€‰æ‹©æ¨¡å¼ï¼ˆChoice Patternï¼‰**:

- **å®šä¹‰**: æ ¹æ®æ¡ä»¶é€‰æ‹©æ‰§è¡Œåˆ†æ”¯
- **æ•°å­¦è¡¨ç¤º**: $if(C) then T_1 else T_2$
- **äº’æ–¥æ€§**: åˆ†æ”¯äº’æ–¥ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œ

**é€‰æ‹©æ¨¡å¼ç‰¹ç‚¹**:

- **æ¡ä»¶åˆ¤æ–­**: æ ¹æ®æ¡ä»¶é€‰æ‹©åˆ†æ”¯
- **äº’æ–¥æ€§**: åˆ†æ”¯äº’æ–¥
- **çµæ´»æ€§**: æ”¯æŒåŠ¨æ€é€‰æ‹©

### 1.1.5 å¾ªç¯æ¨¡å¼ç†è®º

**å¾ªç¯æ¨¡å¼ï¼ˆLoop Patternï¼‰**:

- **å®šä¹‰**: ä»»åŠ¡é‡å¤æ‰§è¡Œç›´åˆ°æ¡ä»¶æ»¡è¶³
- **æ•°å­¦è¡¨ç¤º**: $while(C) do T$
- **ç»ˆæ­¢æ¡ä»¶**: å¾ªç¯ç»ˆæ­¢æ¡ä»¶

**å¾ªç¯æ¨¡å¼ç‰¹ç‚¹**:

- **é‡å¤æ‰§è¡Œ**: ä»»åŠ¡é‡å¤æ‰§è¡Œ
- **ç»ˆæ­¢æ¡ä»¶**: éœ€è¦ç»ˆæ­¢æ¡ä»¶
- **æ€§èƒ½**: æ³¨æ„é¿å…æ— é™å¾ªç¯

### 1.1.6 æ¨¡å¼ç»„åˆç†è®º

**æ¨¡å¼ç»„åˆ**:

- **é¡ºåºç»„åˆ**: $P_1 \rightarrow P_2$
- **å¹¶è¡Œç»„åˆ**: $P_1 || P_2$
- **åµŒå¥—ç»„åˆ**: $P_1(P_2)$

**ç»„åˆåŸåˆ™**:

- **å¯ç»„åˆæ€§**: æ¨¡å¼å¯ä»¥ç»„åˆ
- **å¯é‡ç”¨æ€§**: æ¨¡å¼å¯ä»¥é‡ç”¨
- **å¯ç»´æŠ¤æ€§**: ç»„åˆæ¨¡å¼æ˜“äºç»´æŠ¤

### 1.1.7 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **å·¥ä½œæµå®šä¹‰**: $O(P)$ where P is number of patterns
- **å·¥ä½œæµå®ä¾‹**: $O(P \times I)$ where I is average instances per pattern

**æ‰§è¡Œå¤æ‚åº¦**:

- **é¡ºåºæ¨¡å¼**: $O(n)$ where n is number of tasks
- **å¹¶è¡Œæ¨¡å¼**: $O(\max(t_i))$ where $t_i$ is task execution time
- **é€‰æ‹©æ¨¡å¼**: $O(1)$ (constant time)
- **å¾ªç¯æ¨¡å¼**: $O(n \times m)$ where n is iterations, m is task time

---

## 2. é¡ºåºæ¨¡å¼

### 2.1 é¡ºåºæ¨¡å¼å®šä¹‰

**é¡ºåºæ¨¡å¼ï¼ˆSequence Patternï¼‰**ï¼šä»»åŠ¡æŒ‰å›ºå®šé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

**ç‰¹ç‚¹**:

- ä¸¥æ ¼çš„æ‰§è¡Œé¡ºåº
- å‰é©±ä»»åŠ¡å®Œæˆåæ‰èƒ½å¼€å§‹åç»­ä»»åŠ¡
- é€‚ç”¨äºæœ‰ä¾èµ–å…³ç³»çš„ä»»åŠ¡é“¾

### 2.2 PostgreSQLå®ç°

**é¡ºåºå·¥ä½œæµè¡¨è®¾è®¡**:

```sql
-- å·¥ä½œæµå®šä¹‰è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS workflow_definition (
        workflow_id SERIAL PRIMARY KEY,
        workflow_name VARCHAR(200) NOT NULL,
        workflow_type VARCHAR(50) NOT NULL, -- 'sequence', 'parallel', 'choice', 'loop'
        definition JSONB NOT NULL,
        version INT DEFAULT 1,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'è¡¨ workflow_definition åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ workflow_definition å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ workflow_definition å¤±è´¥: %', SQLERRM;
END $$;

-- å·¥ä½œæµå®ä¾‹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS workflow_instance (
        instance_id BIGSERIAL PRIMARY KEY,
        workflow_id INT NOT NULL REFERENCES workflow_definition(workflow_id),
        current_step INT DEFAULT 1,
        status VARCHAR(50) DEFAULT 'running', -- 'running', 'completed', 'failed', 'cancelled'
        context JSONB DEFAULT '{}',
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW(),
        completed_at TIMESTAMPTZ
    );
    RAISE NOTICE 'è¡¨ workflow_instance åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ workflow_instance å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ workflow_instance å¤±è´¥: %', SQLERRM;
END $$;

-- å·¥ä½œæµæ­¥éª¤è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS workflow_step (
        step_id SERIAL PRIMARY KEY,
        workflow_id INT NOT NULL REFERENCES workflow_definition(workflow_id),
        step_order INT NOT NULL,
        step_name VARCHAR(200) NOT NULL,
        step_type VARCHAR(50), -- 'task', 'sub_workflow'
        handler_function VARCHAR(200),
        is_required BOOLEAN DEFAULT TRUE,
        UNIQUE(workflow_id, step_order)
    );
    RAISE NOTICE 'è¡¨ workflow_step åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ workflow_step å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ workflow_step å¤±è´¥: %', SQLERRM;
END $$;

-- å·¥ä½œæµæ‰§è¡Œå†å²è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS workflow_execution_history (
        history_id BIGSERIAL PRIMARY KEY,
        instance_id BIGINT NOT NULL REFERENCES workflow_instance(instance_id),
        step_id INT NOT NULL REFERENCES workflow_step(step_id),
        status VARCHAR(50) NOT NULL, -- 'started', 'completed', 'failed'
        start_time TIMESTAMPTZ,
        end_time TIMESTAMPTZ,
        result JSONB,
        error_message TEXT
    );
    RAISE NOTICE 'è¡¨ workflow_execution_history åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ workflow_execution_history å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ workflow_execution_history å¤±è´¥: %', SQLERRM;
END $$;

-- é¡ºåºå·¥ä½œæµå®šä¹‰ç¤ºä¾‹
INSERT INTO workflow_definition (workflow_name, workflow_type, definition) VALUES (
    'è®¢å•å¤„ç†æµç¨‹',
    'sequence',
    '{
        "steps": [
            {"order": 1, "name": "éªŒè¯è®¢å•", "handler": "validate_order"},
            {"order": 2, "name": "å¤„ç†æ”¯ä»˜", "handler": "process_payment"},
            {"order": 3, "name": "å‡†å¤‡å‘è´§", "handler": "prepare_shipment"},
            {"order": 4, "name": "å‘é€é€šçŸ¥", "handler": "send_notification"}
        ]
    }'::JSONB
);
```

### 2.3 é¡ºåºæ‰§è¡Œå‡½æ•°

**é¡ºåºæ‰§è¡Œé€»è¾‘**:

```sql
-- æ‰§è¡Œä¸‹ä¸€æ­¥
CREATE OR REPLACE FUNCTION execute_next_step(
    p_instance_id BIGINT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_workflow_id INT;
    v_current_step INT;
    v_next_step RECORD;
    v_step_handler VARCHAR;
BEGIN
    -- è·å–å½“å‰å·¥ä½œæµä¿¡æ¯
    SELECT workflow_id, current_step INTO v_workflow_id, v_current_step
    FROM workflow_instance
    WHERE instance_id = p_instance_id
      AND status = 'running';

    IF NOT FOUND THEN
        RETURN FALSE;
    END IF;

    -- è·å–ä¸‹ä¸€æ­¥
    SELECT * INTO v_next_step
    FROM workflow_step
    WHERE workflow_id = v_workflow_id
      AND step_order = v_current_step;

    IF NOT FOUND THEN
        -- å·¥ä½œæµå®Œæˆ
        UPDATE workflow_instance
        SET status = 'completed',
            completed_at = NOW()
        WHERE instance_id = p_instance_id;
        RETURN FALSE;
    END IF;

    -- è®°å½•æ­¥éª¤å¼€å§‹
    INSERT INTO workflow_execution_history (
        instance_id, step_id, status, start_time
    ) VALUES (
        p_instance_id, v_next_step.step_id, 'started', NOW()
    );

    -- æ‰§è¡Œæ­¥éª¤ï¼ˆè¿™é‡Œè°ƒç”¨handlerå‡½æ•°ï¼‰
    -- å®é™…å®ç°ä¸­ï¼Œhandler_functionä¼šæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
    -- ç¤ºä¾‹ï¼šEXECUTE format('SELECT %s($1)', v_next_step.handler_function) USING p_instance_id;

    -- æ›´æ–°å½“å‰æ­¥éª¤
    UPDATE workflow_instance
    SET current_step = current_step + 1,
        updated_at = NOW()
    WHERE instance_id = p_instance_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

---

## 3. å¹¶è¡Œæ¨¡å¼

### 3.1 å¹¶è¡Œæ¨¡å¼å®šä¹‰

**å¹¶è¡Œæ¨¡å¼ï¼ˆParallel Patternï¼‰**ï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œæ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­åç»­æµç¨‹ã€‚

**ç‰¹ç‚¹**:

- ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ
- éœ€è¦ç­‰å¾…æ‰€æœ‰å¹¶è¡Œä»»åŠ¡å®Œæˆ
- é€‚ç”¨äºç‹¬ç«‹çš„ä»»åŠ¡é›†åˆ

### 3.2 PostgreSQLå®ç°

**å¹¶è¡Œå·¥ä½œæµå®šä¹‰**:

```sql
-- å¹¶è¡Œå·¥ä½œæµå®šä¹‰ç¤ºä¾‹
INSERT INTO workflow_definition (workflow_name, workflow_type, definition) VALUES (
    'è®¢å•æ”¯ä»˜åå¤„ç†',
    'parallel',
    '{
        "steps": [
            {"order": 1, "name": "å‘é€é‚®ä»¶é€šçŸ¥", "handler": "send_email", "parallel_group": 1},
            {"order": 1, "name": "å‘é€çŸ­ä¿¡é€šçŸ¥", "handler": "send_sms", "parallel_group": 1},
            {"order": 1, "name": "æ›´æ–°åº“å­˜", "handler": "update_inventory", "parallel_group": 1},
            {"order": 2, "name": "åç»­å¤„ç†", "handler": "post_process"}
        ],
        "parallel_groups": [1]
    }'::JSONB
);

-- å¹¶è¡Œæ­¥éª¤æ‰§è¡ŒçŠ¶æ€è¡¨
CREATE TABLE parallel_step_status (
    status_id BIGSERIAL PRIMARY KEY,
    instance_id BIGINT NOT NULL REFERENCES workflow_instance(instance_id),
    parallel_group INT NOT NULL,
    step_id INT NOT NULL REFERENCES workflow_step(step_id),
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'running', 'completed', 'failed'
    start_time TIMESTAMPTZ,
    end_time TIMESTAMPTZ,
    result JSONB
);

-- æ£€æŸ¥å¹¶è¡Œç»„æ˜¯å¦å®Œæˆ
CREATE OR REPLACE FUNCTION check_parallel_group_completed(
    p_instance_id BIGINT,
    p_parallel_group INT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_total_count INT;
    v_completed_count INT;
BEGIN
    -- ç»Ÿè®¡å¹¶è¡Œç»„ä¸­çš„æ­¥éª¤æ€»æ•°
    SELECT COUNT(*) INTO v_total_count
    FROM workflow_step ws
    JOIN workflow_instance wi ON ws.workflow_id = wi.workflow_id
    WHERE wi.instance_id = p_instance_id
      AND (ws.definition->>'parallel_group')::INT = p_parallel_group;

    -- ç»Ÿè®¡å·²å®Œæˆæ­¥éª¤æ•°
    SELECT COUNT(*) INTO v_completed_count
    FROM parallel_step_status
    WHERE instance_id = p_instance_id
      AND parallel_group = p_parallel_group
      AND status = 'completed';

    RETURN v_completed_count = v_total_count;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. é€‰æ‹©æ¨¡å¼

### 4.1 é€‰æ‹©æ¨¡å¼å®šä¹‰

**é€‰æ‹©æ¨¡å¼ï¼ˆChoice Patternï¼‰**ï¼šæ ¹æ®æ¡ä»¶é€‰æ‹©æ‰§è¡Œä¸åŒçš„åˆ†æ”¯ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯ä¼šè¢«æ‰§è¡Œã€‚

**ç‰¹ç‚¹**:

- åŸºäºæ¡ä»¶çš„åˆ†æ”¯é€‰æ‹©
- äº’æ–¥æ‰§è¡Œ
- é€‚ç”¨äºæ¡ä»¶åˆ¤æ–­åœºæ™¯

### 4.2 PostgreSQLå®ç°

**é€‰æ‹©å·¥ä½œæµå®šä¹‰**:

```sql
-- é€‰æ‹©å·¥ä½œæµå®šä¹‰ç¤ºä¾‹
INSERT INTO workflow_definition (workflow_name, workflow_type, definition) VALUES (
    'è®¢å•å¤„ç†åˆ†æ”¯',
    'choice',
    '{
        "condition": "order_amount > 1000",
        "branches": [
            {
                "condition": "order_amount > 1000",
                "steps": [
                    {"order": 1, "name": "VIPå¤„ç†", "handler": "vip_process"}
                ]
            },
            {
                "condition": "order_amount <= 1000",
                "steps": [
                    {"order": 1, "name": "æ™®é€šå¤„ç†", "handler": "normal_process"}
                ]
            }
        ]
    }'::JSONB
);

-- é€‰æ‹©åˆ†æ”¯æ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_choice_branch(
    p_instance_id BIGINT,
    p_condition JSONB
)
RETURNS INT AS $$
DECLARE
    v_workflow_id INT;
    v_context JSONB;
    v_branch RECORD;
    v_matched_branch INT;
BEGIN
    -- è·å–å·¥ä½œæµå’Œä¸Šä¸‹æ–‡
    SELECT wi.workflow_id, wi.context INTO v_workflow_id, v_context
    FROM workflow_instance wi
    WHERE wi.instance_id = p_instance_id;

    -- æŸ¥æ‰¾åŒ¹é…çš„åˆ†æ”¯
    SELECT branch_id INTO v_matched_branch
    FROM jsonb_array_elements(
        (SELECT definition->'branches' FROM workflow_definition WHERE workflow_id = v_workflow_id)
    ) WITH ORDINALITY AS branches(branch, branch_id)
    WHERE evaluate_condition(branch->>'condition', v_context);

    IF v_matched_branch IS NULL THEN
        RAISE EXCEPTION 'No matching branch found';
    END IF;

    RETURN v_matched_branch;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. å¾ªç¯æ¨¡å¼

### 5.1 å¾ªç¯æ¨¡å¼å®šä¹‰

**å¾ªç¯æ¨¡å¼ï¼ˆLoop Patternï¼‰**ï¼šé‡å¤æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œç›´åˆ°æ»¡è¶³é€€å‡ºæ¡ä»¶ã€‚

**ç‰¹ç‚¹**:

- é‡å¤æ‰§è¡Œ
- æœ‰é€€å‡ºæ¡ä»¶
- é€‚ç”¨äºéœ€è¦é‡è¯•æˆ–è¿­ä»£çš„åœºæ™¯

### 5.2 PostgreSQLå®ç°

**å¾ªç¯å·¥ä½œæµå®šä¹‰**:

```sql
-- å¾ªç¯å·¥ä½œæµå®šä¹‰ç¤ºä¾‹
INSERT INTO workflow_definition (workflow_name, workflow_type, definition) VALUES (
    'é‡è¯•æ”¯ä»˜æµç¨‹',
    'loop',
    '{
        "max_iterations": 3,
        "exit_condition": "payment_status = ''success''",
        "steps": [
            {"order": 1, "name": "å°è¯•æ”¯ä»˜", "handler": "attempt_payment"},
            {"order": 2, "name": "æ£€æŸ¥ç»“æœ", "handler": "check_result"}
        ]
    }'::JSONB
);

-- å¾ªç¯æ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_loop_workflow(
    p_instance_id BIGINT
)
RETURNS VOID AS $$
DECLARE
    v_workflow_def JSONB;
    v_max_iterations INT;
    v_current_iteration INT := 0;
    v_exit_condition TEXT;
    v_context JSONB;
    v_should_exit BOOLEAN := FALSE;
BEGIN
    -- è·å–å·¥ä½œæµå®šä¹‰
    SELECT wd.definition, wi.context INTO v_workflow_def, v_context
    FROM workflow_instance wi
    JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
    WHERE wi.instance_id = p_instance_id;

    v_max_iterations := (v_workflow_def->>'max_iterations')::INT;
    v_exit_condition := v_workflow_def->>'exit_condition';

    -- å¾ªç¯æ‰§è¡Œ
    WHILE v_current_iteration < v_max_iterations AND NOT v_should_exit LOOP
        v_current_iteration := v_current_iteration + 1;

        -- æ‰§è¡Œå¾ªç¯ä½“å†…çš„æ­¥éª¤
        PERFORM execute_workflow_steps(p_instance_id, v_workflow_def->'steps');

        -- æ£€æŸ¥é€€å‡ºæ¡ä»¶
        SELECT evaluate_condition(v_exit_condition, v_context) INTO v_should_exit;

        -- æ›´æ–°ä¸Šä¸‹æ–‡
        UPDATE workflow_instance
        SET context = context || jsonb_build_object('iteration', v_current_iteration),
            updated_at = NOW()
        WHERE instance_id = p_instance_id;
    END LOOP;

    -- å¦‚æœè¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ä»æœªé€€å‡ºï¼Œæ ‡è®°ä¸ºå¤±è´¥
    IF NOT v_should_exit THEN
        UPDATE workflow_instance
        SET status = 'failed',
            context = context || jsonb_build_object('error', 'Max iterations reached')
        WHERE instance_id = p_instance_id;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. PostgreSQLå®ç°

### 6.1 ç»¼åˆå·¥ä½œæµå¼•æ“

**å®Œæ•´å·¥ä½œæµç³»ç»Ÿ**:

```sql
-- å·¥ä½œæµæ‰§è¡Œå¼•æ“ä¸»å‡½æ•°
CREATE OR REPLACE FUNCTION execute_workflow(
    p_instance_id BIGINT
)
RETURNS VOID AS $$
DECLARE
    v_workflow_type VARCHAR;
    v_workflow_def JSONB;
BEGIN
    -- è·å–å·¥ä½œæµç±»å‹å’Œå®šä¹‰
    SELECT wd.workflow_type, wd.definition INTO v_workflow_type, v_workflow_def
    FROM workflow_instance wi
    JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
    WHERE wi.instance_id = p_instance_id
      AND wi.status = 'running';

    -- æ ¹æ®ç±»å‹æ‰§è¡Œä¸åŒçš„æ¨¡å¼
    CASE v_workflow_type
        WHEN 'sequence' THEN
            PERFORM execute_sequence_workflow(p_instance_id);
        WHEN 'parallel' THEN
            PERFORM execute_parallel_workflow(p_instance_id);
        WHEN 'choice' THEN
            PERFORM execute_choice_workflow(p_instance_id);
        WHEN 'loop' THEN
            PERFORM execute_loop_workflow(p_instance_id);
        ELSE
            RAISE EXCEPTION 'Unknown workflow type: %', v_workflow_type;
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- å·¥ä½œæµçŠ¶æ€æŸ¥è¯¢è§†å›¾
CREATE VIEW workflow_status_view AS
SELECT
    wi.instance_id,
    wd.workflow_name,
    wi.status,
    wi.current_step,
    wi.created_at,
    wi.updated_at,
    wi.completed_at,
    -- æ‰§è¡Œè¿›åº¦
    (
        SELECT COUNT(*)
        FROM workflow_execution_history weh
        WHERE weh.instance_id = wi.instance_id
          AND weh.status = 'completed'
    ) AS completed_steps,
    (
        SELECT COUNT(*)
        FROM workflow_step ws
        WHERE ws.workflow_id = wi.workflow_id
    ) AS total_steps
FROM workflow_instance wi
JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id;
```

---

## 7. æ›´å¤šå®é™…æ¡ˆä¾‹ / More Practical Examples

### 7.1 æ¡ˆä¾‹1: è®¢å•å¤„ç†å·¥ä½œæµ

**è®¢å•å¤„ç†å®Œæ•´å·¥ä½œæµ**:

```sql
-- è®¢å•å¤„ç†å·¥ä½œæµå®šä¹‰
INSERT INTO workflow_definition (workflow_name, workflow_type, description) VALUES
    ('order_processing', 'sequence', 'è®¢å•å¤„ç†å·¥ä½œæµ');

-- å·¥ä½œæµæ­¥éª¤
INSERT INTO workflow_step (workflow_id, step_name, step_type, step_order, handler_function) VALUES
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'order_processing'),
     'validate_order', 'task', 1, 'validate_order_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'order_processing'),
     'process_payment', 'task', 2, 'process_payment_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'order_processing'),
     'prepare_shipment', 'task', 3, 'prepare_shipment_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'order_processing'),
     'send_notification', 'task', 4, 'send_notification_function');

-- è®¢å•å¤„ç†å‡½æ•°
CREATE OR REPLACE FUNCTION validate_order_function(p_instance_id BIGINT)
RETURNS VOID AS $$
DECLARE
    v_order_id BIGINT;
BEGIN
    SELECT context->>'order_id' INTO v_order_id
    FROM workflow_instance WHERE instance_id = p_instance_id;

    -- éªŒè¯è®¢å•
    IF NOT EXISTS (SELECT 1 FROM orders WHERE order_id = v_order_id) THEN
        RAISE EXCEPTION 'Order % not found', v_order_id;
    END IF;

    -- æ›´æ–°æ­¥éª¤çŠ¶æ€
    UPDATE workflow_execution_history
    SET status = 'completed', completed_at = NOW()
    WHERE instance_id = p_instance_id AND step_name = 'validate_order';
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION process_payment_function(p_instance_id BIGINT)
RETURNS VOID AS $$
DECLARE
    v_order_id BIGINT;
    v_payment_result VARCHAR;
BEGIN
    SELECT context->>'order_id' INTO v_order_id
    FROM workflow_instance WHERE instance_id = p_instance_id;

    -- å¤„ç†æ”¯ä»˜
    SELECT change_order_state(v_order_id, 'pay', '{}'::jsonb) INTO v_payment_result;

    -- æ›´æ–°æ­¥éª¤çŠ¶æ€
    UPDATE workflow_execution_history
    SET status = 'completed', completed_at = NOW()
    WHERE instance_id = p_instance_id AND step_name = 'process_payment';
END;
$$ LANGUAGE plpgsql;
```

### 7.2 æ¡ˆä¾‹2: æ–‡æ¡£å®¡æ‰¹å·¥ä½œæµ

**å¤šçº§å¹¶è¡Œå®¡æ‰¹å·¥ä½œæµ**:

```sql
-- æ–‡æ¡£å®¡æ‰¹å·¥ä½œæµï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰
INSERT INTO workflow_definition (workflow_name, workflow_type, description) VALUES
    ('document_approval', 'parallel', 'æ–‡æ¡£å®¡æ‰¹å·¥ä½œæµ');

-- å¹¶è¡Œå®¡æ‰¹æ­¥éª¤
INSERT INTO workflow_step (workflow_id, step_name, step_type, step_order, handler_function) VALUES
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'document_approval'),
     'legal_review', 'task', 1, 'legal_review_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'document_approval'),
     'finance_review', 'task', 1, 'finance_review_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'document_approval'),
     'technical_review', 'task', 1, 'technical_review_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'document_approval'),
     'final_approval', 'task', 2, 'final_approval_function');

-- å¹¶è¡Œæ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_parallel_approval(p_instance_id BIGINT)
RETURNS VOID AS $$
DECLARE
    v_step RECORD;
    v_all_completed BOOLEAN;
BEGIN
    -- å¯åŠ¨æ‰€æœ‰å¹¶è¡Œæ­¥éª¤
    FOR v_step IN
        SELECT step_name FROM workflow_step
        WHERE workflow_id = (
            SELECT workflow_id FROM workflow_instance WHERE instance_id = p_instance_id
        )
        AND step_order = 1
    LOOP
        INSERT INTO workflow_execution_history (instance_id, step_name, status)
        VALUES (p_instance_id, v_step.step_name, 'running');
    END LOOP;

    -- ç­‰å¾…æ‰€æœ‰æ­¥éª¤å®Œæˆ
    LOOP
        SELECT bool_and(status = 'completed') INTO v_all_completed
        FROM workflow_execution_history
        WHERE instance_id = p_instance_id AND step_order = 1;

        EXIT WHEN v_all_completed;

        PERFORM pg_sleep(1);  -- ç­‰å¾…1ç§’
    END LOOP;

    -- æ‰§è¡Œæœ€ç»ˆå®¡æ‰¹
    PERFORM execute_workflow_step(p_instance_id, 'final_approval');
END;
$$ LANGUAGE plpgsql;
```

### 7.3 æ¡ˆä¾‹3: æ•°æ®å¤„ç†ç®¡é“å·¥ä½œæµ

**ETLæ•°æ®å¤„ç†å·¥ä½œæµ**:

```sql
-- æ•°æ®å¤„ç†ç®¡é“å·¥ä½œæµ
INSERT INTO workflow_definition (workflow_name, workflow_type, description) VALUES
    ('data_processing_pipeline', 'sequence', 'æ•°æ®å¤„ç†ç®¡é“');

-- æ•°æ®å¤„ç†æ­¥éª¤
INSERT INTO workflow_step (workflow_id, step_name, step_type, step_order, handler_function) VALUES
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'data_processing_pipeline'),
     'extract_data', 'task', 1, 'extract_data_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'data_processing_pipeline'),
     'transform_data', 'task', 2, 'transform_data_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'data_processing_pipeline'),
     'load_data', 'task', 3, 'load_data_function'),
    ((SELECT workflow_id FROM workflow_definition WHERE workflow_name = 'data_processing_pipeline'),
     'validate_result', 'task', 4, 'validate_result_function');

-- ETLå‡½æ•°
CREATE OR REPLACE FUNCTION extract_data_function(p_instance_id BIGINT)
RETURNS VOID AS $$
DECLARE
    v_source_table TEXT;
    v_target_table TEXT;
BEGIN
    SELECT context->>'source_table', context->>'target_table'
    INTO v_source_table, v_target_table
    FROM workflow_instance WHERE instance_id = p_instance_id;

    -- æå–æ•°æ®åˆ°ä¸´æ—¶è¡¨
    EXECUTE format('CREATE TEMP TABLE %I AS SELECT * FROM %I', v_target_table, v_source_table);

    UPDATE workflow_execution_history
    SET status = 'completed', completed_at = NOW()
    WHERE instance_id = p_instance_id AND step_name = 'extract_data';
END;
$$ LANGUAGE plpgsql;
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ / Performance Optimization and Monitoring

### 8.1 å·¥ä½œæµæ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**:

```sql
-- å·¥ä½œæµå®ä¾‹ç´¢å¼•
CREATE INDEX idx_workflow_instance_status
ON workflow_instance(status, created_at);

CREATE INDEX idx_workflow_instance_workflow
ON workflow_instance(workflow_id, status);

-- æ‰§è¡Œå†å²ç´¢å¼•
CREATE INDEX idx_execution_history_instance
ON workflow_execution_history(instance_id, step_order);

CREATE INDEX idx_execution_history_status
ON workflow_execution_history(status, completed_at)
WHERE status IN ('running', 'failed');
```

**æ‰¹é‡å¤„ç†ä¼˜åŒ–**:

```sql
-- æ‰¹é‡å¯åŠ¨å·¥ä½œæµ
CREATE OR REPLACE FUNCTION batch_start_workflow(
    p_workflow_name VARCHAR,
    p_contexts JSONB[]
)
RETURNS TABLE(instance_id BIGINT) AS $$
DECLARE
    v_context JSONB;
    v_instance_id BIGINT;
BEGIN
    FOREACH v_context IN ARRAY p_contexts
    LOOP
        INSERT INTO workflow_instance (workflow_id, status, context)
        SELECT workflow_id, 'running', v_context
        FROM workflow_definition
        WHERE workflow_name = p_workflow_name
        RETURNING instance_id INTO v_instance_id;

        RETURN QUERY SELECT v_instance_id;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 å·¥ä½œæµç›‘æ§

**å·¥ä½œæµç›‘æ§æŸ¥è¯¢**:

```sql
-- ç›‘æ§ï¼šå·¥ä½œæµæ‰§è¡Œç»Ÿè®¡
SELECT
    wd.workflow_name,
    wi.status,
    COUNT(*) AS instance_count,
    AVG(EXTRACT(EPOCH FROM (COALESCE(wi.completed_at, NOW()) - wi.created_at))) AS avg_duration_seconds,
    MAX(EXTRACT(EPOCH FROM (COALESCE(wi.completed_at, NOW()) - wi.created_at))) AS max_duration_seconds
FROM workflow_instance wi
JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
GROUP BY wd.workflow_name, wi.status
ORDER BY instance_count DESC;

-- ç›‘æ§ï¼šé•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œæµ
SELECT
    wi.instance_id,
    wd.workflow_name,
    wi.status,
    wi.current_step,
    NOW() - wi.created_at AS running_duration,
    wi.context
FROM workflow_instance wi
JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
WHERE wi.status = 'running'
  AND wi.created_at < NOW() - INTERVAL '1 hour'
ORDER BY running_duration DESC;

-- ç›‘æ§ï¼šå¤±è´¥çš„æ­¥éª¤
SELECT
    weh.instance_id,
    weh.step_name,
    weh.status,
    weh.error_message,
    weh.created_at,
    wd.workflow_name
FROM workflow_execution_history weh
JOIN workflow_instance wi ON weh.instance_id = wi.instance_id
JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
WHERE weh.status = 'failed'
  AND weh.created_at >= NOW() - INTERVAL '24 hours'
ORDER BY weh.created_at DESC;
```

---

## 9. å¸¸è§é—®é¢˜è§£ç­” / FAQ

### Q1: å·¥ä½œæµåº”è¯¥ä½¿ç”¨é¡ºåºæ¨¡å¼è¿˜æ˜¯å¹¶è¡Œæ¨¡å¼ï¼Ÿ

**A**: é€‰æ‹©åŸåˆ™ï¼š

- **é¡ºåºæ¨¡å¼**: æ­¥éª¤ä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ
- **å¹¶è¡Œæ¨¡å¼**: æ­¥éª¤ä¹‹é—´æ— ä¾èµ–ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œä»¥æé«˜æ•ˆç‡

**ç¤ºä¾‹**:

```sql
-- âœ… é¡ºåºæ¨¡å¼ï¼šè®¢å•å¤„ç†ï¼ˆæ”¯ä»˜å¿…é¡»åœ¨éªŒè¯ä¹‹åï¼‰
validate_order â†’ process_payment â†’ prepare_shipment

-- âœ… å¹¶è¡Œæ¨¡å¼ï¼šæ–‡æ¡£å®¡æ‰¹ï¼ˆå¤šä¸ªéƒ¨é—¨å¯ä»¥åŒæ—¶å®¡æ‰¹ï¼‰
legal_review || finance_review || technical_review â†’ final_approval
```

### Q2: å¦‚ä½•å¤„ç†å·¥ä½œæµå¤±è´¥å’Œé‡è¯•ï¼Ÿ

**A**: å¤±è´¥å¤„ç†ç­–ç•¥ï¼š

```sql
-- æ·»åŠ é‡è¯•é…ç½®åˆ°å·¥ä½œæµæ­¥éª¤
ALTER TABLE workflow_step
ADD COLUMN max_retries INT DEFAULT 3,
ADD COLUMN retry_delay INTERVAL DEFAULT '5 minutes';

-- é‡è¯•å‡½æ•°
CREATE OR REPLACE FUNCTION retry_failed_step(
    p_instance_id BIGINT,
    p_step_name VARCHAR
)
RETURNS VOID AS $$
DECLARE
    v_retry_count INT;
    v_max_retries INT;
BEGIN
    SELECT retry_count, max_retries
    INTO v_retry_count, v_max_retries
    FROM workflow_execution_history
    WHERE instance_id = p_instance_id AND step_name = p_step_name
    ORDER BY created_at DESC LIMIT 1;

    IF v_retry_count >= v_max_retries THEN
        RAISE EXCEPTION 'Max retries exceeded for step %', p_step_name;
    END IF;

    -- é‡ç½®æ­¥éª¤çŠ¶æ€å¹¶é‡è¯•
    UPDATE workflow_execution_history
    SET status = 'running', retry_count = retry_count + 1
    WHERE instance_id = p_instance_id AND step_name = p_step_name;
END;
$$ LANGUAGE plpgsql;
```

### Q3: å¦‚ä½•å®ç°å·¥ä½œæµçš„æš‚åœå’Œæ¢å¤ï¼Ÿ

**A**: æš‚åœ/æ¢å¤å®ç°ï¼š

```sql
-- æš‚åœå·¥ä½œæµ
CREATE OR REPLACE FUNCTION pause_workflow(p_instance_id BIGINT)
RETURNS VOID AS $$
BEGIN
    UPDATE workflow_instance
    SET status = 'paused', paused_at = NOW()
    WHERE instance_id = p_instance_id AND status = 'running';
END;
$$ LANGUAGE plpgsql;

-- æ¢å¤å·¥ä½œæµ
CREATE OR REPLACE FUNCTION resume_workflow(p_instance_id BIGINT)
RETURNS VOID AS $$
BEGIN
    UPDATE workflow_instance
    SET status = 'running', paused_at = NULL
    WHERE instance_id = p_instance_id AND status = 'paused';
END;
$$ LANGUAGE plpgsql;
```

### Q4: å·¥ä½œæµæ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**A**: æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š

1. **å¼‚æ­¥æ‰§è¡Œ**: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œå·¥ä½œæµæ­¥éª¤
2. **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¯åŠ¨å’Œå¤„ç†å·¥ä½œæµå®ä¾‹
3. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
4. **åˆ†åŒº**: å¯¹å†å²è¡¨è¿›è¡Œåˆ†åŒº

```sql
-- å¼‚æ­¥æ‰§è¡Œå·¥ä½œæµæ­¥éª¤
CREATE TABLE workflow_queue (
    queue_id BIGSERIAL PRIMARY KEY,
    instance_id BIGINT NOT NULL,
    step_name VARCHAR(100) NOT NULL,
    priority INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_workflow_queue_priority
ON workflow_queue(priority DESC, created_at);
```

### Q5: å¦‚ä½•ç›‘æ§å·¥ä½œæµçš„å¥åº·çŠ¶æ€ï¼Ÿ

**A**: å¥åº·ç›‘æ§ï¼š

```sql
-- å·¥ä½œæµå¥åº·æ£€æŸ¥è§†å›¾
CREATE VIEW workflow_health_check AS
SELECT
    wd.workflow_name,
    COUNT(*) FILTER (WHERE wi.status = 'running') AS running_count,
    COUNT(*) FILTER (WHERE wi.status = 'completed') AS completed_count,
    COUNT(*) FILTER (WHERE wi.status = 'failed') AS failed_count,
    AVG(EXTRACT(EPOCH FROM (COALESCE(wi.completed_at, NOW()) - wi.created_at)))
        FILTER (WHERE wi.status = 'completed') AS avg_completion_time,
    COUNT(*) FILTER (
        WHERE wi.status = 'running'
        AND wi.created_at < NOW() - INTERVAL '1 hour'
    ) AS stuck_count
FROM workflow_instance wi
JOIN workflow_definition wd ON wi.workflow_id = wd.workflow_id
GROUP BY wd.workflow_name;
```

---

## 9. ç›¸å…³èµ„æº / Related Resources

### 9.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents

- [çŠ¶æ€æœºå»ºæ¨¡](./çŠ¶æ€æœºå»ºæ¨¡.md) - çŠ¶æ€æœºå»ºæ¨¡åŸºç¡€
- [JSONBçŠ¶æ€æœºå®ç°](./JSONBçŠ¶æ€æœºå®ç°.md) - JSONBå®ç°çŠ¶æ€æœº
- [BPMNå»ºæ¨¡](./BPMNå»ºæ¨¡.md) - BPMNæ ‡å‡†å»ºæ¨¡
- [è®¢å•ç®¡ç†æ¨¡å‹](../04-OLTPå»ºæ¨¡/è®¢å•ç®¡ç†æ¨¡å‹.md) - è®¢å•å·¥ä½œæµåº”ç”¨æ¡ˆä¾‹

### 9.2 ç†è®ºåŸºç¡€ / Theoretical Foundation

- [çº¦æŸç†è®º](../01-æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€/çº¦æŸç†è®º.md) - å·¥ä½œæµçº¦æŸç†è®º

### 9.3 å®è·µæŒ‡å— / Practical Guides

- [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#8-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§--performance-optimization-and-monitoring) - æœ¬æ–‡æ¡£çš„æ€§èƒ½ç›‘æ§ç« èŠ‚
- [æ›´å¤šå®é™…æ¡ˆä¾‹](#7-æ›´å¤šå®é™…æ¡ˆä¾‹--more-practical-examples) - æœ¬æ–‡æ¡£çš„åº”ç”¨æ¡ˆä¾‹ç« èŠ‚
- [æ€§èƒ½ä¼˜åŒ–](../08-PostgreSQLå»ºæ¨¡å®è·µ/æ€§èƒ½ä¼˜åŒ–.md) - å·¥ä½œæµæ€§èƒ½ä¼˜åŒ–

### 9.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases

- [ç”µå•†æ•°æ®æ¨¡å‹æ¡ˆä¾‹](../10-ç»¼åˆåº”ç”¨æ¡ˆä¾‹/ç”µå•†æ•°æ®æ¨¡å‹æ¡ˆä¾‹.md) - ç”µå•†å·¥ä½œæµæ¡ˆä¾‹
- [é‡‘èæ•°æ®æ¨¡å‹æ¡ˆä¾‹](../10-ç»¼åˆåº”ç”¨æ¡ˆä¾‹/é‡‘èæ•°æ®æ¨¡å‹æ¡ˆä¾‹.md) - é‡‘èå·¥ä½œæµæ¡ˆä¾‹

### 9.5 å‚è€ƒèµ„æº / Reference Resources

- [æƒå¨èµ„æºç´¢å¼•](../00-å¯¼èˆªä¸ç´¢å¼•/æƒå¨èµ„æºç´¢å¼•.md) - æƒå¨èµ„æºåˆ—è¡¨
- [æœ¯è¯­å¯¹ç…§è¡¨](../00-å¯¼èˆªä¸ç´¢å¼•/æœ¯è¯­å¯¹ç…§è¡¨.md) - æœ¯è¯­å¯¹ç…§
- [å¿«é€ŸæŸ¥æ‰¾æŒ‡å—](../00-å¯¼èˆªä¸ç´¢å¼•/å¿«é€ŸæŸ¥æ‰¾æŒ‡å—.md) - å¿«é€ŸæŸ¥æ‰¾å·¥å…·
- å·¥ä½œæµæ¨¡å¼ç ”ç©¶: [Workflow Patterns](https://www.workflowpatterns.com/)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
