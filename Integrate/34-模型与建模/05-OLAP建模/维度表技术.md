# OLAPç»´åº¦è¡¨æŠ€æœ¯å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: Kimballã€Šæ•°æ®ä»“åº“å·¥å…·ç®±ã€‹+ æƒå¨èµ„æºå¯¹é½
> **çŠ¶æ€**: åŸºäºæƒå¨èµ„æºæ·±åŒ–æ‰©å±•
> **æ–‡æ¡£ç¼–å·**: 05-03

---

## ğŸ“‘ ç›®å½•

- [OLAPç»´åº¦è¡¨æŠ€æœ¯å®Œæ•´æŒ‡å—](#olapç»´åº¦è¡¨æŠ€æœ¯å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç¼“æ…¢å˜åŒ–ç»´åº¦ï¼ˆSCDï¼‰](#2-ç¼“æ…¢å˜åŒ–ç»´åº¦scd)
    - [2.1 SCD Type 1: è¦†ç›–å†å²å€¼](#21-scd-type-1-è¦†ç›–å†å²å€¼)
    - [2.2 SCD Type 2: ä¿ç•™å®Œæ•´å†å²](#22-scd-type-2-ä¿ç•™å®Œæ•´å†å²)
    - [2.3 SCD Type 3: ä¿ç•™æœ‰é™å†å²](#23-scd-type-3-ä¿ç•™æœ‰é™å†å²)
    - [2.4 SCD Type 4: å¿«ç…§è¡¨](#24-scd-type-4-å¿«ç…§è¡¨)
    - [2.5 SCD Type 6: æ··åˆæ–¹æ³•](#25-scd-type-6-æ··åˆæ–¹æ³•)
  - [3. è§’è‰²æ‰®æ¼”ç»´åº¦](#3-è§’è‰²æ‰®æ¼”ç»´åº¦)
  - [4. æ‚é¡¹ç»´åº¦](#4-æ‚é¡¹ç»´åº¦)
  - [5. é€€åŒ–ç»´åº¦](#5-é€€åŒ–ç»´åº¦)
  - [6. ä¸€è‡´æ€§ç»´åº¦](#6-ä¸€è‡´æ€§ç»´åº¦)
  - [7. PostgreSQLå®ç°](#7-postgresqlå®ç°)
    - [7.1 SCD Type 2è‡ªåŠ¨å¤„ç†](#71-scd-type-2è‡ªåŠ¨å¤„ç†)
    - [7.2 ç»´åº¦è¡¨ç´¢å¼•ç­–ç•¥](#72-ç»´åº¦è¡¨ç´¢å¼•ç­–ç•¥)
  - [8. ç›¸å…³èµ„æº](#8-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

ç»´åº¦è¡¨æ˜¯ç»´åº¦å»ºæ¨¡çš„æ ¸å¿ƒç»„ä»¶ï¼Œæè¿°ä¸šåŠ¡è¿‡ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚
Kimballå®šä¹‰äº†å¤šç§ç»´åº¦è¡¨æŠ€æœ¯ï¼ŒåŒ…æ‹¬ç¼“æ…¢å˜åŒ–ç»´åº¦ï¼ˆSCDï¼‰ã€è§’è‰²æ‰®æ¼”ç»´åº¦ã€æ‚é¡¹ç»´åº¦ç­‰ã€‚
æ­£ç¡®ä½¿ç”¨è¿™äº›æŠ€æœ¯å¯¹æ•°æ®ä»“åº“è®¾è®¡è‡³å…³é‡è¦ã€‚

---

## 2. ç¼“æ…¢å˜åŒ–ç»´åº¦ï¼ˆSCDï¼‰

### 2.1 SCD Type 1: è¦†ç›–å†å²å€¼

**å®šä¹‰**: ç›´æ¥æ›´æ–°ç»´åº¦è®°å½•ï¼Œä¸ä¿ç•™å†å²å€¼ã€‚

**ç‰¹ç‚¹**:

- ç®€å•ç›´æ¥
- ä¸ä¿ç•™å†å²
- é€‚åˆä¸é‡è¦çš„å±æ€§å˜æ›´

**é€‚ç”¨åœºæ™¯**:

- å®¢æˆ·åœ°å€æ›´æ­£
- äº§å“æè¿°æ›´æ–°
- ä¸é‡è¦çš„å±æ€§å˜æ›´

**PostgreSQLå®ç°**:

```sql
-- SCD Type 1ï¼šå®¢æˆ·ç»´åº¦è¡¨
CREATE TABLE dim_customer (
    customer_key SERIAL PRIMARY KEY,
    customer_id INT NOT NULL UNIQUE,  -- ä¸šåŠ¡é”®
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    city VARCHAR(50),
    state VARCHAR(50),
    country VARCHAR(50) DEFAULT 'China',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ›´æ–°å®¢æˆ·ä¿¡æ¯ï¼ˆç›´æ¥è¦†ç›–ï¼‰
UPDATE dim_customer
SET
    email = 'newemail@example.com',
    phone = '13800138000',
    updated_at = NOW()
WHERE customer_id = 123;
```

---

### 2.2 SCD Type 2: ä¿ç•™å®Œæ•´å†å²

**å®šä¹‰**: ä¸ºæ¯ä¸ªå˜åŒ–åˆ›å»ºæ–°è®°å½•ï¼Œä¿ç•™å®Œæ•´å†å²ã€‚

**ç‰¹ç‚¹**:

- ä¿ç•™å®Œæ•´å†å²
- æ”¯æŒå†å²åˆ†æ
- éœ€è¦æœ‰æ•ˆæ—¥æœŸå­—æ®µ

**é€‚ç”¨åœºæ™¯**:

- å®¢æˆ·åœ°å€å˜æ›´
- äº§å“åˆ†ç±»å˜æ›´
- å‘˜å·¥éƒ¨é—¨å˜æ›´

**PostgreSQLå®ç°**:

```sql
-- SCD Type 2ï¼šå®¢æˆ·ç»´åº¦è¡¨ï¼ˆä¿ç•™å†å²ï¼‰
CREATE TABLE dim_customer (
    customer_key SERIAL PRIMARY KEY,
    customer_id INT NOT NULL,  -- ä¸šåŠ¡é”®ï¼ˆä¸å”¯ä¸€ï¼‰
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    city VARCHAR(50),
    state VARCHAR(50),
    -- SCD Type 2å­—æ®µ
    valid_from DATE NOT NULL,
    valid_to DATE,
    is_current BOOLEAN DEFAULT TRUE,
    version_number INT DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (valid_to IS NULL OR valid_to >= valid_from)
);

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆä¸šåŠ¡é”® + æœ‰æ•ˆæ—¥æœŸï¼‰
CREATE UNIQUE INDEX idx_dim_customer_business_key
ON dim_customer(customer_id, valid_from);

-- æ’å…¥æ–°å®¢æˆ·
INSERT INTO dim_customer (customer_id, customer_name, email, city, valid_from)
VALUES (123, 'å¼ ä¸‰', 'zhangsan@example.com', 'åŒ—äº¬', '2024-01-01');

-- å®¢æˆ·åœ°å€å˜æ›´ï¼ˆåˆ›å»ºæ–°è®°å½•ï¼‰
INSERT INTO dim_customer (customer_id, customer_name, email, city, valid_from, version_number)
VALUES (123, 'å¼ ä¸‰', 'zhangsan@example.com', 'ä¸Šæµ·', '2024-06-01', 2);

-- æ›´æ–°æ—§è®°å½•çš„valid_toå’Œis_current
UPDATE dim_customer
SET
    valid_to = '2024-05-31',
    is_current = FALSE
WHERE customer_id = 123
  AND is_current = TRUE
  AND version_number = 1;

-- æŸ¥è¯¢å½“å‰æœ‰æ•ˆè®°å½•
SELECT * FROM dim_customer
WHERE customer_id = 123
  AND is_current = TRUE;

-- æŸ¥è¯¢å†å²è®°å½•
SELECT * FROM dim_customer
WHERE customer_id = 123
ORDER BY valid_from DESC;
```

**è‡ªåŠ¨å¤„ç†SCD Type 2çš„å‡½æ•°**:

```sql
-- SCD Type 2æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION update_dim_customer_scd2(
    p_customer_id INT,
    p_customer_name VARCHAR(100),
    p_email VARCHAR(100),
    p_city VARCHAR(50),
    p_change_date DATE DEFAULT CURRENT_DATE
)
RETURNS INT AS $$
DECLARE
    v_new_key INT;
    v_new_version INT;
BEGIN
    -- è·å–å½“å‰ç‰ˆæœ¬å·
    SELECT COALESCE(MAX(version_number), 0) + 1
    INTO v_new_version
    FROM dim_customer
    WHERE customer_id = p_customer_id;

    -- å…³é—­æ—§è®°å½•
    UPDATE dim_customer
    SET
        valid_to = p_change_date - INTERVAL '1 day',
        is_current = FALSE,
        updated_at = NOW()
    WHERE customer_id = p_customer_id
      AND is_current = TRUE;

    -- æ’å…¥æ–°è®°å½•
    INSERT INTO dim_customer (
        customer_id, customer_name, email, city,
        valid_from, version_number, is_current
    )
    VALUES (
        p_customer_id, p_customer_name, p_email, p_city,
        p_change_date, v_new_version, TRUE
    )
    RETURNING customer_key INTO v_new_key;

    RETURN v_new_key;
END;
$$ LANGUAGE plpgsql;
```

---

### 2.3 SCD Type 3: ä¿ç•™æœ‰é™å†å²

**å®šä¹‰**: åœ¨ç»´åº¦è¡¨ä¸­æ·»åŠ "æ—§å€¼"åˆ—ï¼Œä»…ä¿ç•™ä¸Šä¸€æ¬¡çš„å€¼ã€‚

**ç‰¹ç‚¹**:

- ä¿ç•™æœ‰é™å†å²ï¼ˆä»…ä¸Šä¸€æ¬¡ï¼‰
- è¡¨ç»“æ„ç®€å•
- é€‚åˆå¶å°”å˜åŒ–çš„å±æ€§

**é€‚ç”¨åœºæ™¯**:

- äº§å“å½“å‰åˆ†ç±»å’Œä¸Šä¸€åˆ†ç±»
- å®¢æˆ·å½“å‰åœ°åŒºå’Œä¸Šä¸€åœ°åŒº

**PostgreSQLå®ç°**:

```sql
-- SCD Type 3ï¼šäº§å“ç»´åº¦è¡¨ï¼ˆä¿ç•™ä¸Šä¸€å€¼ï¼‰
CREATE TABLE dim_product (
    product_key SERIAL PRIMARY KEY,
    product_id INT NOT NULL UNIQUE,
    product_name VARCHAR(200) NOT NULL,
    -- å½“å‰å€¼
    current_category VARCHAR(100),
    current_brand VARCHAR(100),
    -- ä¸Šä¸€å€¼ï¼ˆSCD Type 3ï¼‰
    previous_category VARCHAR(100),
    previous_brand VARCHAR(100),
    -- å˜æ›´æ—¥æœŸ
    category_changed_date DATE,
    brand_changed_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ›´æ–°äº§å“åˆ†ç±»ï¼ˆä¿ç•™ä¸Šä¸€å€¼ï¼‰
CREATE OR REPLACE FUNCTION update_product_category_scd3(
    p_product_id INT,
    p_new_category VARCHAR(100)
)
RETURNS VOID AS $$
BEGIN
    UPDATE dim_product
    SET
        previous_category = current_category,
        current_category = p_new_category,
        category_changed_date = CURRENT_DATE,
        updated_at = NOW()
    WHERE product_id = p_product_id;
END;
$$ LANGUAGE plpgsql;
```

---

### 2.4 SCD Type 4: å¿«ç…§è¡¨

**å®šä¹‰**: ä½¿ç”¨å•ç‹¬çš„è¿·ä½ ç»´åº¦è¡¨å­˜å‚¨é¢‘ç¹å˜åŒ–çš„å±æ€§ã€‚

**ç‰¹ç‚¹**:

- ä¸»ç»´åº¦è¡¨ç¨³å®š
- è¿·ä½ ç»´åº¦è¡¨å­˜å‚¨å˜åŒ–
- é€‚åˆé¢‘ç¹å˜åŒ–çš„å±æ€§

**é€‚ç”¨åœºæ™¯**:

- äº§å“ä»·æ ¼å†å²
- å®¢æˆ·ä¿¡ç”¨ç­‰çº§å†å²
- åº“å­˜æ°´å¹³å†å²

**PostgreSQLå®ç°**:

```sql
-- ä¸»ç»´åº¦è¡¨ï¼ˆç¨³å®šå±æ€§ï¼‰
CREATE TABLE dim_product (
    product_key SERIAL PRIMARY KEY,
    product_id INT NOT NULL UNIQUE,
    product_name VARCHAR(200) NOT NULL,
    category VARCHAR(100),
    brand VARCHAR(100)
);

-- è¿·ä½ ç»´åº¦è¡¨ï¼ˆä»·æ ¼å†å²ï¼‰
CREATE TABLE dim_product_price (
    price_key SERIAL PRIMARY KEY,
    product_key INT NOT NULL REFERENCES dim_product(product_key),
    price NUMERIC(10,2) NOT NULL,
    effective_date DATE NOT NULL,
    expiry_date DATE,
    is_current BOOLEAN DEFAULT TRUE,
    UNIQUE(product_key, effective_date)
);

-- æŸ¥è¯¢äº§å“å½“å‰ä»·æ ¼
SELECT
    p.product_name,
    pp.price AS current_price,
    pp.effective_date
FROM dim_product p
JOIN dim_product_price pp ON p.product_key = pp.product_key
WHERE pp.is_current = TRUE;
```

---

### 2.5 SCD Type 6: æ··åˆæ–¹æ³•

**å®šä¹‰**: ç»“åˆSCD Type 1ã€Type 2ã€Type 3çš„æ··åˆæ–¹æ³•ã€‚

**ç‰¹ç‚¹**:

- çµæ´»å¤„ç†ä¸åŒå±æ€§
- éƒ¨åˆ†å±æ€§ä¿ç•™å†å²ï¼Œéƒ¨åˆ†ç›´æ¥æ›´æ–°
- é€‚åˆå¤æ‚ä¸šåŠ¡åœºæ™¯

**PostgreSQLå®ç°**:

```sql
-- SCD Type 6ï¼šæ··åˆæ–¹æ³•
CREATE TABLE dim_customer (
    customer_key SERIAL PRIMARY KEY,
    customer_id INT NOT NULL,
    customer_name VARCHAR(100) NOT NULL,
    -- Type 1ï¼šç›´æ¥æ›´æ–°ï¼ˆä¸ä¿ç•™å†å²ï¼‰
    email VARCHAR(100),
    phone VARCHAR(20),
    -- Type 2ï¼šä¿ç•™å®Œæ•´å†å²
    city VARCHAR(50),
    state VARCHAR(50),
    valid_from DATE NOT NULL,
    valid_to DATE,
    is_current BOOLEAN DEFAULT TRUE,
    -- Type 3ï¼šä¿ç•™ä¸Šä¸€å€¼
    previous_city VARCHAR(50),
    city_changed_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 3. è§’è‰²æ‰®æ¼”ç»´åº¦

**å®šä¹‰**: åŒä¸€ä¸ªç»´åº¦è¡¨åœ¨äº‹å®è¡¨ä¸­å¤šæ¬¡ä½¿ç”¨ï¼Œæ‰®æ¼”ä¸åŒè§’è‰²ã€‚

**ç‰¹ç‚¹**:

- é¿å…é‡å¤ç»´åº¦è¡¨
- ä½¿ç”¨è§†å›¾æˆ–åˆ«å
- å¸¸è§äºæ—¶é—´ç»´åº¦

**PostgreSQLå®ç°**:

```sql
-- è®¢å•äº‹å®è¡¨ï¼ˆå¤šä¸ªæ—¥æœŸç»´åº¦ï¼‰
CREATE TABLE fact_orders (
    order_key BIGSERIAL PRIMARY KEY,
    order_date_key INT NOT NULL REFERENCES dim_date(date_key),
    ship_date_key INT REFERENCES dim_date(date_key),
    delivery_date_key INT REFERENCES dim_date(date_key),
    cancel_date_key INT REFERENCES dim_date(date_key),
    product_key INT NOT NULL REFERENCES dim_product(product_key),
    customer_key INT NOT NULL REFERENCES dim_customer(customer_key),
    order_amount NUMERIC(10,2) NOT NULL
);

-- åˆ›å»ºè§’è‰²æ‰®æ¼”è§†å›¾
CREATE VIEW dim_order_date AS SELECT * FROM dim_date;
CREATE VIEW dim_ship_date AS SELECT * FROM dim_date;
CREATE VIEW dim_delivery_date AS SELECT * FROM dim_date;

-- æŸ¥è¯¢ï¼ˆä½¿ç”¨è§†å›¾ï¼‰
SELECT
    od.year_number AS order_year,
    sd.month_name AS ship_month,
    dd.day_name AS delivery_day,
    SUM(f.order_amount) AS total_amount
FROM fact_orders f
JOIN dim_order_date od ON f.order_date_key = od.date_key
JOIN dim_ship_date sd ON f.ship_date_key = sd.date_key
JOIN dim_delivery_date dd ON f.delivery_date_key = dd.date_key
GROUP BY od.year_number, sd.month_name, dd.day_name;
```

---

## 4. æ‚é¡¹ç»´åº¦

**å®šä¹‰**: å°†å¤šä¸ªä½åŸºæ•°çš„æ ‡å¿—å’ŒæŒ‡æ ‡ç»„åˆæˆä¸€ä¸ªç»´åº¦è¡¨ã€‚

**ç‰¹ç‚¹**:

- å‡å°‘äº‹å®è¡¨åˆ—æ•°
- æé«˜æŸ¥è¯¢æ€§èƒ½
- é€‚åˆå¤šä¸ªå¸ƒå°”æ ‡å¿—

**PostgreSQLå®ç°**:

```sql
-- æ‚é¡¹ç»´åº¦è¡¨
CREATE TABLE dim_order_junk (
    junk_key SERIAL PRIMARY KEY,
    -- ç»„åˆå¤šä¸ªæ ‡å¿—
    is_online_order BOOLEAN NOT NULL,
    is_express_delivery BOOLEAN NOT NULL,
    is_gift_wrapped BOOLEAN NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    delivery_method VARCHAR(20) NOT NULL,
    -- å”¯ä¸€çº¦æŸ
    UNIQUE(is_online_order, is_express_delivery, is_gift_wrapped, payment_method, delivery_method)
);

-- è®¢å•äº‹å®è¡¨ï¼ˆä½¿ç”¨æ‚é¡¹ç»´åº¦ï¼‰
CREATE TABLE fact_orders (
    order_key BIGSERIAL PRIMARY KEY,
    order_date_key INT NOT NULL REFERENCES dim_date(date_key),
    product_key INT NOT NULL REFERENCES dim_product(product_key),
    customer_key INT NOT NULL REFERENCES dim_customer(customer_key),
    junk_key INT NOT NULL REFERENCES dim_order_junk(junk_key),  -- æ‚é¡¹ç»´åº¦
    order_amount NUMERIC(10,2) NOT NULL
);

-- æŸ¥è¯¢ï¼ˆä½¿ç”¨æ‚é¡¹ç»´åº¦ï¼‰
SELECT
    d.year_number,
    j.is_online_order,
    j.payment_method,
    SUM(f.order_amount) AS total_amount
FROM fact_orders f
JOIN dim_date d ON f.order_date_key = d.date_key
JOIN dim_order_junk j ON f.junk_key = j.junk_key
WHERE j.is_express_delivery = TRUE
GROUP BY d.year_number, j.is_online_order, j.payment_method;
```

---

## 5. é€€åŒ–ç»´åº¦

**å®šä¹‰**: ç»´åº¦å±æ€§ç›´æ¥å­˜å‚¨åœ¨äº‹å®è¡¨ä¸­ï¼Œä¸å•ç‹¬åˆ›å»ºç»´åº¦è¡¨ã€‚

**é€‚ç”¨åœºæ™¯**:

- äº¤æ˜“ç¼–å·
- è®¢å•ç¼–å·
- å‘ç¥¨ç¼–å·

**PostgreSQLå®ç°**:

```sql
-- äº‹å®è¡¨ï¼ˆåŒ…å«é€€åŒ–ç»´åº¦ï¼‰
CREATE TABLE fact_sales (
    sale_id BIGSERIAL PRIMARY KEY,
    date_key INT NOT NULL REFERENCES dim_date(date_key),
    product_key INT NOT NULL REFERENCES dim_product(product_key),
    -- é€€åŒ–ç»´åº¦ï¼ˆç›´æ¥å­˜å‚¨åœ¨äº‹å®è¡¨ä¸­ï¼‰
    transaction_number VARCHAR(50),  -- äº¤æ˜“ç¼–å·
    receipt_number VARCHAR(50),      -- æ”¶æ®ç¼–å·
    -- åº¦é‡å€¼
    sales_amount NUMERIC(10,2) NOT NULL
);

-- ä¸ºé€€åŒ–ç»´åº¦åˆ›å»ºç´¢å¼•
CREATE INDEX idx_fact_sales_transaction_num ON fact_sales(transaction_number);
CREATE INDEX idx_fact_sales_receipt_num ON fact_sales(receipt_number);
```

---

## 6. ä¸€è‡´æ€§ç»´åº¦

**å®šä¹‰**: åœ¨ä¸åŒäº‹å®è¡¨ä¸­ä½¿ç”¨ç›¸åŒçš„ç»´åº¦è¡¨ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

**ç‰¹ç‚¹**:

- ç»´åº¦é”®å€¼ä¸€è‡´
- å±æ€§å®šä¹‰ä¸€è‡´
- æ”¯æŒè·¨äº‹å®è¡¨åˆ†æ

**PostgreSQLå®ç°**:

```sql
-- ä¸€è‡´æ€§ç»´åº¦ï¼šæ—¶é—´ç»´åº¦
CREATE TABLE dim_date (
    date_key INT PRIMARY KEY,
    date_actual DATE NOT NULL UNIQUE,
    day_name VARCHAR(10),
    month_name VARCHAR(10),
    quarter_number INT,
    year_number INT
);

-- å¤šä¸ªäº‹å®è¡¨ä½¿ç”¨ç›¸åŒçš„æ—¶é—´ç»´åº¦
CREATE TABLE fact_sales (
    sale_id BIGSERIAL PRIMARY KEY,
    date_key INT NOT NULL REFERENCES dim_date(date_key),  -- ä¸€è‡´æ€§ç»´åº¦
    ...
);

CREATE TABLE fact_orders (
    order_id BIGSERIAL PRIMARY KEY,
    date_key INT NOT NULL REFERENCES dim_date(date_key),  -- ä¸€è‡´æ€§ç»´åº¦
    ...
);

-- è·¨äº‹å®è¡¨åˆ†æ
SELECT
    d.year_number,
    SUM(s.sales_amount) AS total_sales,
    SUM(o.order_amount) AS total_orders
FROM dim_date d
LEFT JOIN fact_sales s ON d.date_key = s.date_key
LEFT JOIN fact_orders o ON d.date_key = o.date_key
WHERE d.year_number = 2024
GROUP BY d.year_number;
```

---

## 7. PostgreSQLå®ç°

### 7.1 SCD Type 2è‡ªåŠ¨å¤„ç†

```sql
-- åˆ›å»ºSCD Type 2å¤„ç†å‡½æ•°
CREATE OR REPLACE FUNCTION process_scd_type2(
    p_table_name TEXT,
    p_business_key_col TEXT,
    p_business_key_val INT,
    p_change_date DATE DEFAULT CURRENT_DATE
)
RETURNS INT AS $$
DECLARE
    v_sql TEXT;
    v_new_key INT;
BEGIN
    -- å…³é—­æ—§è®°å½•
    v_sql := format('
        UPDATE %I
        SET valid_to = $1 - INTERVAL ''1 day'',
            is_current = FALSE,
            updated_at = NOW()
        WHERE %I = $2
          AND is_current = TRUE',
        p_table_name, p_business_key_col);

    EXECUTE v_sql USING p_change_date, p_business_key_val;

    -- è¿”å›æ–°é”®ï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µå®ç°ï¼‰
    RETURN v_new_key;
END;
$$ LANGUAGE plpgsql;
```

---

### 7.2 ç»´åº¦è¡¨ç´¢å¼•ç­–ç•¥

```sql
-- SCD Type 2ç»´åº¦è¡¨ç´¢å¼•
CREATE INDEX idx_dim_customer_business_key ON dim_customer(customer_id, valid_from);
CREATE INDEX idx_dim_customer_current ON dim_customer(customer_id) WHERE is_current = TRUE;
CREATE INDEX idx_dim_customer_valid_date ON dim_customer(valid_from, valid_to);

-- ç»´åº¦è¡¨æŸ¥è¯¢ä¼˜åŒ–
-- æŸ¥è¯¢å½“å‰æœ‰æ•ˆè®°å½•ï¼ˆä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼‰
SELECT * FROM dim_customer
WHERE customer_id = 123
  AND is_current = TRUE;

-- æŸ¥è¯¢å†å²è®°å½•ï¼ˆä½¿ç”¨æ—¥æœŸç´¢å¼•ï¼‰
SELECT * FROM dim_customer
WHERE customer_id = 123
  AND valid_from <= '2024-06-01'
  AND (valid_to IS NULL OR valid_to >= '2024-06-01');
```

---

## 8. ç›¸å…³èµ„æº

- [Kimballç»´åº¦å»ºæ¨¡](../02-æƒå¨èµ„æºä¸æ ‡å‡†/Kimballç»´åº¦å»ºæ¨¡.md) - ç»´åº¦è¡¨æŠ€æœ¯æ¥æº
- [ç»´åº¦å»ºæ¨¡åŸºç¡€](./ç»´åº¦å»ºæ¨¡åŸºç¡€.md) - ç»´åº¦å»ºæ¨¡åŸºç¡€
- [äº‹å®è¡¨æŠ€æœ¯](./äº‹å®è¡¨æŠ€æœ¯.md) - äº‹å®è¡¨è®¾è®¡æŠ€æœ¯
- [ç´¢å¼•ç­–ç•¥](../08-PostgreSQLå»ºæ¨¡å®è·µ/ç´¢å¼•ç­–ç•¥.md) - ç»´åº¦è¡¨ç´¢å¼•ç­–ç•¥

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
