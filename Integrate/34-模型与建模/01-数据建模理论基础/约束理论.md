# çº¦æŸç†è®ºå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: æ•°æ®åº“ç³»ç»Ÿç†è®ºåŸºç¡€
> **çŠ¶æ€**: åŸºäºç°æœ‰å†…å®¹æ·±åŒ–æ‰©å±•
> **æ–‡æ¡£ç¼–å·**: 01-04

---

## ğŸ“‘ ç›®å½•

- [çº¦æŸç†è®ºå®Œæ•´æŒ‡å—](#çº¦æŸç†è®ºå®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 çº¦æŸç†è®ºåŸºæœ¬æ¦‚å¿µ](#111-çº¦æŸç†è®ºåŸºæœ¬æ¦‚å¿µ)
    - [1.1.2 å®ä½“å®Œæ•´æ€§ç†è®º](#112-å®ä½“å®Œæ•´æ€§ç†è®º)
    - [1.1.3 å‚ç…§å®Œæ•´æ€§ç†è®º](#113-å‚ç…§å®Œæ•´æ€§ç†è®º)
    - [1.1.4 ç”¨æˆ·å®šä¹‰çº¦æŸç†è®º](#114-ç”¨æˆ·å®šä¹‰çº¦æŸç†è®º)
    - [1.1.5 çº¦æŸéªŒè¯ç†è®º](#115-çº¦æŸéªŒè¯ç†è®º)
    - [1.1.6 çº¦æŸä¼˜åŒ–ç†è®º](#116-çº¦æŸä¼˜åŒ–ç†è®º)
    - [1.1.7 å¤æ‚åº¦åˆ†æ](#117-å¤æ‚åº¦åˆ†æ)
  - [2. çº¦æŸç±»å‹](#2-çº¦æŸç±»å‹)
    - [2.1 å®ä½“å®Œæ•´æ€§çº¦æŸï¼ˆEntity Integrityï¼‰](#21-å®ä½“å®Œæ•´æ€§çº¦æŸentity-integrity)
    - [2.2 å‚ç…§å®Œæ•´æ€§çº¦æŸï¼ˆReferential Integrityï¼‰](#22-å‚ç…§å®Œæ•´æ€§çº¦æŸreferential-integrity)
    - [2.3 ç”¨æˆ·å®šä¹‰çº¦æŸï¼ˆUser-Defined Constraintsï¼‰](#23-ç”¨æˆ·å®šä¹‰çº¦æŸuser-defined-constraints)
      - [2.3.1 CHECKçº¦æŸ](#231-checkçº¦æŸ)
      - [2.3.2 NOT NULLçº¦æŸ](#232-not-nullçº¦æŸ)
      - [2.3.3 UNIQUEçº¦æŸ](#233-uniqueçº¦æŸ)
      - [2.3.4 EXCLUDEçº¦æŸï¼ˆPostgreSQLç‰¹æœ‰ï¼‰](#234-excludeçº¦æŸpostgresqlç‰¹æœ‰)
  - [3. çº¦æŸç®¡ç†](#3-çº¦æŸç®¡ç†)
    - [3.1 æ·»åŠ çº¦æŸ](#31-æ·»åŠ çº¦æŸ)
    - [3.2 åˆ é™¤çº¦æŸ](#32-åˆ é™¤çº¦æŸ)
    - [3.3 ä¿®æ”¹çº¦æŸ](#33-ä¿®æ”¹çº¦æŸ)
    - [3.4 æŸ¥çœ‹çº¦æŸ](#34-æŸ¥çœ‹çº¦æŸ)
  - [4. çº¦æŸéªŒè¯](#4-çº¦æŸéªŒè¯)
    - [4.1 å»¶è¿Ÿçº¦æŸæ£€æŸ¥ï¼ˆDeferred Constraintsï¼‰](#41-å»¶è¿Ÿçº¦æŸæ£€æŸ¥deferred-constraints)
    - [4.2 çº¦æŸæœ‰æ•ˆæ€§](#42-çº¦æŸæœ‰æ•ˆæ€§)
  - [5. çº¦æŸè®¾è®¡æœ€ä½³å®è·µ](#5-çº¦æŸè®¾è®¡æœ€ä½³å®è·µ)
    - [5.1 å‘½åè§„èŒƒ](#51-å‘½åè§„èŒƒ)
    - [5.2 çº¦æŸé€‰æ‹©åŸåˆ™](#52-çº¦æŸé€‰æ‹©åŸåˆ™)
    - [5.3 æ€§èƒ½è€ƒè™‘](#53-æ€§èƒ½è€ƒè™‘)
  - [6. å¸¸è§çº¦æŸæ¨¡å¼](#6-å¸¸è§çº¦æŸæ¨¡å¼)
    - [æ¨¡å¼1: è½¯åˆ é™¤](#æ¨¡å¼1-è½¯åˆ é™¤)
    - [æ¨¡å¼2: æ—¶é—´èŒƒå›´çº¦æŸ](#æ¨¡å¼2-æ—¶é—´èŒƒå›´çº¦æŸ)
    - [æ¨¡å¼3: çŠ¶æ€è½¬æ¢çº¦æŸ](#æ¨¡å¼3-çŠ¶æ€è½¬æ¢çº¦æŸ)
  - [7. ç›¸å…³èµ„æº](#7-ç›¸å…³èµ„æº)
  - [8. å‚è€ƒæ–‡æ¡£](#8-å‚è€ƒæ–‡æ¡£)

---

## 1. æ¦‚è¿°

çº¦æŸç†è®ºï¼ˆConstraint Theoryï¼‰æ˜¯æ•°æ®åº“è®¾è®¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ã€‚
çº¦æŸå®šä¹‰äº†æ•°æ®å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œæ•°æ®åº“ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶å¼ºåˆ¶æ‰§è¡Œè¿™äº›çº¦æŸã€‚

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 çº¦æŸç†è®ºåŸºæœ¬æ¦‚å¿µ

**çº¦æŸï¼ˆConstraintï¼‰**:

- **å®šä¹‰**: æ•°æ®å¿…é¡»æ»¡è¶³çš„æ¡ä»¶
- **ç›®çš„**: ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§
- **æ‰§è¡Œ**: æ•°æ®åº“ç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥å¹¶å¼ºåˆ¶æ‰§è¡Œ

**çº¦æŸåˆ†ç±»**:

- **å®Œæ•´æ€§çº¦æŸ**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **ä¸€è‡´æ€§çº¦æŸ**: ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **æ­£ç¡®æ€§çº¦æŸ**: ä¿è¯æ•°æ®æ­£ç¡®æ€§

### 1.1.2 å®ä½“å®Œæ•´æ€§ç†è®º

**å®ä½“å®Œæ•´æ€§ï¼ˆEntity Integrityï¼‰**:

- **å®šä¹‰**: ä¸»é”®ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»å”¯ä¸€
- **æ•°å­¦è¡¨ç¤º**: $\forall t \in R, t[PK] \neq NULL \land \forall t_1, t_2 \in R, t_1[PK] \neq t_2[PK]$
- **ç›®çš„**: ä¿è¯æ¯ä¸ªå®ä½“éƒ½æœ‰å”¯ä¸€æ ‡è¯†

**å®ä½“å®Œæ•´æ€§çº¦æŸ**:

- **ä¸»é”®çº¦æŸ**: PRIMARY KEY
- **å”¯ä¸€çº¦æŸ**: UNIQUE
- **éç©ºçº¦æŸ**: NOT NULL

### 1.1.3 å‚ç…§å®Œæ•´æ€§ç†è®º

**å‚ç…§å®Œæ•´æ€§ï¼ˆReferential Integrityï¼‰**:

- **å®šä¹‰**: å¤–é”®å¿…é¡»å¼•ç”¨å­˜åœ¨çš„ä¸»é”®å€¼

- **æ•°å­¦è¡¨ç¤º**: $\forall t \in R, t[FK] \in \pi_{PK}(S) \lor t[FK] = NULL$
- **ç›®çš„**: ä¿è¯å¼•ç”¨å…³ç³»çš„ä¸€è‡´æ€§

**å‚ç…§å®Œæ•´æ€§çº¦æŸ**:

- **å¤–é”®çº¦æŸ**: FOREIGN KEY
- **å¼•ç”¨åŠ¨ä½œ**: ON DELETE/UPDATE CASCADE/RESTRICT/SET NULL

### 1.1.4 ç”¨æˆ·å®šä¹‰çº¦æŸç†è®º

**CHECKçº¦æŸ**:

- **å®šä¹‰**: ç”¨æˆ·å®šä¹‰çš„çº¦æŸæ¡ä»¶
- **æ•°å­¦è¡¨ç¤º**: $\forall t \in R, P(t)$ where P is predicate

- **ç›®çš„**: ä¿è¯æ•°æ®æ»¡è¶³ä¸šåŠ¡è§„åˆ™

**CHECKçº¦æŸç±»å‹**:

- **åˆ—çº§çº¦æŸ**: çº¦æŸå•ä¸ªåˆ—
- **è¡¨çº§çº¦æŸ**: çº¦æŸå¤šä¸ªåˆ—
- **æ¡ä»¶çº¦æŸ**: åŸºäºæ¡ä»¶çš„çº¦æŸ

### 1.1.5 çº¦æŸéªŒè¯ç†è®º

**çº¦æŸéªŒè¯**:

- **ç«‹å³éªŒè¯**: æ’å…¥/æ›´æ–°æ—¶ç«‹å³éªŒè¯

- **å»¶è¿ŸéªŒè¯**: äº‹åŠ¡æäº¤æ—¶éªŒè¯
- **éƒ¨åˆ†éªŒè¯**: åªéªŒè¯æ–°æ•°æ®

**çº¦æŸæœ‰æ•ˆæ€§**:

- **æœ‰æ•ˆçº¦æŸ**: çº¦æŸå½“å‰æœ‰æ•ˆ
- **æ— æ•ˆçº¦æŸ**: çº¦æŸå½“å‰æ— æ•ˆ
- **ç¦ç”¨çº¦æŸ**: ä¸´æ—¶ç¦ç”¨çº¦æŸ

### 1.1.6 çº¦æŸä¼˜åŒ–ç†è®º

**çº¦æŸæ€§èƒ½**:

- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºçº¦æŸåˆ—åˆ›å»ºç´¢å¼•

- **çº¦æŸé¡ºåº**: ä¼˜åŒ–çº¦æŸæ£€æŸ¥é¡ºåº
- **çº¦æŸåˆå¹¶**: åˆå¹¶å¤šä¸ªçº¦æŸ

**çº¦æŸæƒè¡¡**:

- **å®Œæ•´æ€§**: çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§

- **æ€§èƒ½**: çº¦æŸæ£€æŸ¥å½±å“æ€§èƒ½
- **çµæ´»æ€§**: çº¦æŸé™åˆ¶æ•°æ®çµæ´»æ€§

### 1.1.7 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **çº¦æŸå®šä¹‰**: $O(C)$ where C is number of constraints
- **çº¦æŸæ£€æŸ¥**: $O(N)$ where N is number of rows

**æ‰§è¡Œå¤æ‚åº¦**:

- **çº¦æŸæ£€æŸ¥**: $O(1)$ (constant time) with index
- **çº¦æŸéªŒè¯**: $O(N)$ (worst case)

---

## 2. çº¦æŸç±»å‹

### 2.1 å®ä½“å®Œæ•´æ€§çº¦æŸï¼ˆEntity Integrityï¼‰

**å®šä¹‰**: ä¸»é”®ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»å”¯ä¸€ã€‚

**ç‰¹ç‚¹**:

- æ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®
- ä¸»é”®å¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—ç»„æˆï¼ˆå¤åˆä¸»é”®ï¼‰
- ä¸»é”®å€¼ä¸èƒ½ä¸ºNULL
- ä¸»é”®å€¼å¿…é¡»å”¯ä¸€

**PostgreSQLå®ç°**:

```sql
-- å•åˆ—ä¸»é”®
CREATE TABLE students (
    student_id SERIAL PRIMARY KEY,  -- SERIALè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ID
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE
);

-- å¤åˆä¸»é”®
CREATE TABLE enrollments (
    student_id INT NOT NULL,
    course_id INT NOT NULL,
    enrollment_date DATE DEFAULT CURRENT_DATE,
    PRIMARY KEY (student_id, course_id)  -- å¤åˆä¸»é”®
);

-- æ˜¾å¼å®šä¹‰ä¸»é”®çº¦æŸ
CREATE TABLE orders (
    order_id INT,
    order_date DATE,
    CONSTRAINT pk_orders PRIMARY KEY (order_id)
);
```

---

### 2.2 å‚ç…§å®Œæ•´æ€§çº¦æŸï¼ˆReferential Integrityï¼‰

**å®šä¹‰**: å¤–é”®å¿…é¡»å¼•ç”¨å­˜åœ¨çš„ä¸»é”®å€¼ã€‚

**ç‰¹ç‚¹**:

- å¤–é”®å€¼å¿…é¡»åœ¨è¢«å¼•ç”¨è¡¨çš„ä¸»é”®ä¸­å­˜åœ¨
- å¤–é”®å¯ä»¥ä¸ºNULLï¼ˆè¡¨ç¤ºå¯é€‰å…³ç³»ï¼‰
- åˆ é™¤æˆ–æ›´æ–°è¢«å¼•ç”¨è¡Œæ—¶çš„è¡Œä¸ºå¯ä»¥å®šä¹‰

**PostgreSQLå®ç°**:

```sql
-- åŸºæœ¬å¤–é”®çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'departments') THEN
        CREATE TABLE departments (
            dept_id SERIAL PRIMARY KEY,
            dept_name VARCHAR(100) NOT NULL
        );
        RAISE NOTICE 'è¡¨ departments åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ departments å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ departments å¤±è´¥: %', SQLERRM;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'employees') THEN
        CREATE TABLE employees (
            emp_id SERIAL PRIMARY KEY,
            emp_name VARCHAR(100) NOT NULL,
            dept_id INT NOT NULL,
            CONSTRAINT fk_emp_dept
                FOREIGN KEY (dept_id)
                REFERENCES departments(dept_id)
        );
        RAISE NOTICE 'è¡¨ employees åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ employees å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º departments è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ employees å¤±è´¥: %', SQLERRM;
END $$;

-- å¤–é”®çº¦æŸçš„çº§è”æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦å…ˆåˆ›å»ºcustomersè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'orders') THEN
        CREATE TABLE orders (
            order_id SERIAL PRIMARY KEY,
            customer_id INT NOT NULL,
            order_date DATE DEFAULT CURRENT_DATE,
            CONSTRAINT fk_order_customer
                FOREIGN KEY (customer_id)
                REFERENCES customers(customer_id)
                ON DELETE CASCADE      -- åˆ é™¤å®¢æˆ·æ—¶ï¼Œåˆ é™¤å…¶æ‰€æœ‰è®¢å•
                ON UPDATE CASCADE      -- æ›´æ–°å®¢æˆ·IDæ—¶ï¼ŒåŒæ­¥æ›´æ–°è®¢å•
        );
        RAISE NOTICE 'è¡¨ orders åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ orders å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º customers è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders å¤±è´¥: %', SQLERRM;
END $$;

-- å¤–é”®çº¦æŸçš„å…¶ä»–é€‰é¡¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'order_items') THEN
        CREATE TABLE order_items (
            order_id INT NOT NULL,
            product_id INT NOT NULL,
            quantity INT NOT NULL,
            CONSTRAINT fk_order_item_order
                FOREIGN KEY (order_id)
                REFERENCES orders(order_id)
                ON DELETE RESTRICT     -- ç¦æ­¢åˆ é™¤æœ‰è®¢å•é¡¹çš„è®¢å•
                ON UPDATE CASCADE,
            CONSTRAINT fk_order_item_product
                FOREIGN KEY (product_id)
                REFERENCES products(product_id)
                ON DELETE SET NULL     -- åˆ é™¤äº§å“æ—¶ï¼Œå°†product_idè®¾ä¸ºNULL
                ON UPDATE CASCADE
        );
        RAISE NOTICE 'è¡¨ order_items åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ order_items å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º orders å’Œ products è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ order_items å¤±è´¥: %', SQLERRM;
END $$;
```

**çº§è”æ“ä½œé€‰é¡¹**:

- `CASCADE`: çº§è”åˆ é™¤/æ›´æ–°
- `RESTRICT` / `NO ACTION`: ç¦æ­¢åˆ é™¤/æ›´æ–°ï¼ˆé»˜è®¤ï¼‰
- `SET NULL`: è®¾ç½®ä¸ºNULL
- `SET DEFAULT`: è®¾ç½®ä¸ºé»˜è®¤å€¼

---

### 2.3 ç”¨æˆ·å®šä¹‰çº¦æŸï¼ˆUser-Defined Constraintsï¼‰

#### 2.3.1 CHECKçº¦æŸ

**å®šä¹‰**: å®šä¹‰åˆ—å€¼å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ã€‚

**PostgreSQLå®ç°**:

```sql
-- å•åˆ—CHECKçº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'students') THEN
        CREATE TABLE students (
            student_id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            age INT CHECK (age >= 18 AND age <= 100),  -- å¹´é¾„èŒƒå›´
            email VARCHAR(100) CHECK (email LIKE '%@%.%'),  -- é‚®ç®±æ ¼å¼
            grade CHAR(2) CHECK (grade IN ('A', 'B', 'C', 'D', 'F'))  -- æšä¸¾å€¼
        );
        RAISE NOTICE 'è¡¨ students åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ students å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ students å¤±è´¥: %', SQLERRM;
END $$;

-- è¡¨çº§CHECKçº¦æŸï¼ˆå¯ä»¥å¼•ç”¨å¤šåˆ—ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'orders_with_check') THEN
        CREATE TABLE orders_with_check (
            order_id SERIAL PRIMARY KEY,
            order_date DATE NOT NULL,
            ship_date DATE,
            delivery_date DATE,
            CONSTRAINT chk_dates
                CHECK (ship_date IS NULL OR ship_date >= order_date),
            CONSTRAINT chk_delivery
                CHECK (delivery_date IS NULL OR delivery_date >= ship_date)
        );
        RAISE NOTICE 'è¡¨ orders_with_check åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ orders_with_check å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders_with_check å¤±è´¥: %', SQLERRM;
END $$;

-- å‘½åCHECKçº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'products') THEN
        CREATE TABLE products (
            product_id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            price NUMERIC(10,2) NOT NULL,
            discount NUMERIC(10,2) DEFAULT 0,
            CONSTRAINT chk_price_positive CHECK (price > 0),
            CONSTRAINT chk_discount_range CHECK (discount >= 0 AND discount <= price)
        );
        RAISE NOTICE 'è¡¨ products åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ products å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ products å¤±è´¥: %', SQLERRM;
END $$;
```

---

#### 2.3.2 NOT NULLçº¦æŸ

**å®šä¹‰**: åˆ—å€¼ä¸èƒ½ä¸ºNULLã€‚

**PostgreSQLå®ç°**:

```sql
-- NOT NULLçº¦æŸç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'customers') THEN
        CREATE TABLE customers (
            customer_id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,           -- å¿…é¡»æä¾›
            email VARCHAR(100) NOT NULL UNIQUE,   -- å¿…é¡»æä¾›ä¸”å”¯ä¸€
            phone VARCHAR(20),                     -- å¯é€‰
            created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()  -- é»˜è®¤å€¼
        );
        RAISE NOTICE 'è¡¨ customers åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ customers å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ customers å¤±è´¥: %', SQLERRM;
END $$;
```

---

#### 2.3.3 UNIQUEçº¦æŸ

**å®šä¹‰**: åˆ—å€¼å¿…é¡»å”¯ä¸€ï¼ˆå…è®¸NULLï¼‰ã€‚

**PostgreSQLå®ç°**:

```sql
-- å•åˆ—å”¯ä¸€çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'users') THEN
        CREATE TABLE users (
            user_id SERIAL PRIMARY KEY,
            username VARCHAR(50) UNIQUE NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL
        );
        RAISE NOTICE 'è¡¨ users åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ users å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ users å¤±è´¥: %', SQLERRM;
END $$;

-- å¤åˆå”¯ä¸€çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'enrollments_unique') THEN
        CREATE TABLE enrollments_unique (
            student_id INT NOT NULL,
            course_id INT NOT NULL,
            semester VARCHAR(20) NOT NULL,
            UNIQUE (student_id, course_id, semester)  -- åŒä¸€å­¦æœŸä¸èƒ½é‡å¤é€‰è¯¾
        );
        RAISE NOTICE 'è¡¨ enrollments_unique åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ enrollments_unique å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ enrollments_unique å¤±è´¥: %', SQLERRM;
END $$;

-- å‘½åå”¯ä¸€çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'products_sku') THEN
        CREATE TABLE products_sku (
            product_id SERIAL PRIMARY KEY,
            sku VARCHAR(50) NOT NULL,
            name VARCHAR(100) NOT NULL,
            CONSTRAINT uk_product_sku UNIQUE (sku)
        );
        RAISE NOTICE 'è¡¨ products_sku åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ products_sku å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ products_sku å¤±è´¥: %', SQLERRM;
END $$;
```

---

#### 2.3.4 EXCLUDEçº¦æŸï¼ˆPostgreSQLç‰¹æœ‰ï¼‰

**å®šä¹‰**: ä½¿ç”¨ç´¢å¼•æ–¹æ³•æ’é™¤æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„è¡Œã€‚

**åº”ç”¨åœºæ™¯**: é˜²æ­¢æ—¶é—´èŒƒå›´é‡å ã€é˜²æ­¢ç©ºé—´é‡å ç­‰ã€‚

**PostgreSQLå®ç°**:

```sql
-- é˜²æ­¢ä¼šè®®å®¤é¢„è®¢æ—¶é—´é‡å ï¼ˆEXCLUDEçº¦æŸï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'room_bookings') THEN
        CREATE TABLE room_bookings (
            booking_id SERIAL PRIMARY KEY,
            room_id INT NOT NULL,
            start_time TIMESTAMPTZ NOT NULL,
            end_time TIMESTAMPTZ NOT NULL,
            CONSTRAINT chk_time_range CHECK (end_time > start_time),
            CONSTRAINT uk_room_time
                EXCLUDE USING GIST (
                    room_id WITH =,
                    tsrange(start_time, end_time) WITH &&
                )
        );
        RAISE NOTICE 'è¡¨ room_bookings åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ room_bookings å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ room_bookings å¤±è´¥: %', SQLERRM;
END $$;

-- éœ€è¦å…ˆåˆ›å»ºbtree_gistæ‰©å±•
CREATE EXTENSION IF NOT EXISTS btree_gist;

-- æ’å…¥æµ‹è¯•
INSERT INTO room_bookings (room_id, start_time, end_time)
VALUES (1, '2024-01-01 10:00:00', '2024-01-01 11:00:00');  -- æˆåŠŸ

INSERT INTO room_bookings (room_id, start_time, end_time)
VALUES (1, '2024-01-01 10:30:00', '2024-01-01 11:30:00');  -- å¤±è´¥ï¼šæ—¶é—´é‡å 

-- é˜²æ­¢IPåœ°å€èŒƒå›´é‡å 
CREATE TABLE ip_ranges (
    range_id SERIAL PRIMARY KEY,
    network_name VARCHAR(100) NOT NULL,
    start_ip INET NOT NULL,
    end_ip INET NOT NULL,
    CONSTRAINT chk_ip_range CHECK (end_ip > start_ip),
    CONSTRAINT uk_ip_range
        EXCLUDE USING GIST (
            inetrange(start_ip, end_ip) WITH &&
        )
);
```

---

## 3. çº¦æŸç®¡ç†

### 3.1 æ·»åŠ çº¦æŸ

**PostgreSQLå®ç°**:

```sql
-- æ·»åŠ CHECKçº¦æŸ
ALTER TABLE students
ADD CONSTRAINT chk_age CHECK (age >= 18);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE employees
ADD CONSTRAINT fk_emp_dept
FOREIGN KEY (dept_id) REFERENCES departments(dept_id);

-- æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE products
ADD CONSTRAINT uk_product_sku UNIQUE (sku);

-- æ·»åŠ NOT NULLçº¦æŸ
ALTER TABLE customers
ALTER COLUMN email SET NOT NULL;
```

---

### 3.2 åˆ é™¤çº¦æŸ

**PostgreSQLå®ç°**:

```sql
-- åˆ é™¤çº¦æŸï¼ˆéœ€è¦çŸ¥é“çº¦æŸåç§°ï¼‰
ALTER TABLE students
DROP CONSTRAINT chk_age;

-- åˆ é™¤ä¸»é”®çº¦æŸ
ALTER TABLE students
DROP CONSTRAINT students_pkey;

-- åˆ é™¤å¤–é”®çº¦æŸ
ALTER TABLE employees
DROP CONSTRAINT fk_emp_dept;

-- åˆ é™¤NOT NULLçº¦æŸ
ALTER TABLE customers
ALTER COLUMN phone DROP NOT NULL;
```

---

### 3.3 ä¿®æ”¹çº¦æŸ

**PostgreSQLå®ç°**:

```sql
-- PostgreSQLä¸æ”¯æŒç›´æ¥ä¿®æ”¹çº¦æŸï¼Œéœ€è¦å…ˆåˆ é™¤å†æ·»åŠ 
ALTER TABLE students
DROP CONSTRAINT chk_age;

ALTER TABLE students
ADD CONSTRAINT chk_age CHECK (age >= 16 AND age <= 100);
```

---

### 3.4 æŸ¥çœ‹çº¦æŸ

**PostgreSQLå®ç°**:

```sql
-- æŸ¥çœ‹è¡¨çš„æ‰€æœ‰çº¦æŸ
SELECT
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'students'::regclass;

-- æŸ¥çœ‹å¤–é”®çº¦æŸ
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    rc.update_rule,
    rc.delete_rule
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
JOIN information_schema.referential_constraints AS rc
    ON rc.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_name = 'employees';
```

---

## 4. çº¦æŸéªŒè¯

### 4.1 å»¶è¿Ÿçº¦æŸæ£€æŸ¥ï¼ˆDeferred Constraintsï¼‰

**å®šä¹‰**: å…è®¸åœ¨äº‹åŠ¡æäº¤æ—¶æ‰æ£€æŸ¥çº¦æŸï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡è¯­å¥æ‰§è¡Œæ—¶æ£€æŸ¥ã€‚

**åº”ç”¨åœºæ™¯**: å¾ªç¯å¼•ç”¨ã€æ‰¹é‡å¯¼å…¥æ•°æ®ç­‰ã€‚

**PostgreSQLå®ç°**:

```sql
-- åˆ›å»ºå¯å»¶è¿Ÿçš„çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦å…ˆåˆ›å»ºemployeesè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'departments_deferred') THEN
        CREATE TABLE departments_deferred (
            dept_id SERIAL PRIMARY KEY,
            dept_name VARCHAR(100) NOT NULL,
            manager_id INT,
            CONSTRAINT fk_dept_manager
                FOREIGN KEY (manager_id)
                REFERENCES employees(emp_id)
                DEFERRABLE INITIALLY DEFERRED  -- å¯å»¶è¿Ÿï¼Œåˆå§‹ä¸ºå»¶è¿Ÿ
        );
        RAISE NOTICE 'è¡¨ departments_deferred åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ departments_deferred å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º employees è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ departments_deferred å¤±è´¥: %', SQLERRM;
END $$;

-- åœ¨äº‹åŠ¡ä¸­å»¶è¿Ÿçº¦æŸæ£€æŸ¥
BEGIN;
SET CONSTRAINTS fk_dept_manager DEFERRED;

-- ç°åœ¨å¯ä»¥æ’å…¥å¾ªç¯å¼•ç”¨çš„æ•°æ®
INSERT INTO employees (emp_id, emp_name, dept_id)
VALUES (1, 'John', 1);

INSERT INTO departments (dept_id, dept_name, manager_id)
VALUES (1, 'IT', 1);

COMMIT;  -- æäº¤æ—¶æ‰æ£€æŸ¥çº¦æŸ
```

---

### 4.2 çº¦æŸæœ‰æ•ˆæ€§

**PostgreSQLå®ç°**:

```sql
-- ç¦ç”¨çº¦æŸï¼ˆä¸æ¨èï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰
ALTER TABLE employees
DISABLE TRIGGER ALL;  -- ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨ï¼ˆåŒ…æ‹¬çº¦æŸè§¦å‘å™¨ï¼‰

-- é‡æ–°å¯ç”¨çº¦æŸ
ALTER TABLE employees
ENABLE TRIGGER ALL;

-- éªŒè¯ç°æœ‰æ•°æ®æ˜¯å¦ç¬¦åˆçº¦æŸ
ALTER TABLE students
ADD CONSTRAINT chk_age CHECK (age >= 18) NOT VALID;  -- ä¸éªŒè¯ç°æœ‰æ•°æ®

-- ç¨åéªŒè¯
ALTER TABLE students
VALIDATE CONSTRAINT chk_age;  -- éªŒè¯ç°æœ‰æ•°æ®
```

---

## 5. çº¦æŸè®¾è®¡æœ€ä½³å®è·µ

### 5.1 å‘½åè§„èŒƒ

**å»ºè®®**:

- ä¸»é”®: `pk_è¡¨å`
- å¤–é”®: `fk_è¡¨å_å¼•ç”¨è¡¨å`
- CHECKçº¦æŸ: `chk_è¡¨å_åˆ—å` æˆ– `chk_è¡¨å_æè¿°`
- UNIQUEçº¦æŸ: `uk_è¡¨å_åˆ—å`
- EXCLUDEçº¦æŸ: `uk_è¡¨å_æè¿°`

**ç¤ºä¾‹**:

```sql
-- çº¦æŸå‘½åè§„èŒƒç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦å…ˆåˆ›å»ºcustomersè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'orders_named_constraints') THEN
        CREATE TABLE orders_named_constraints (
            order_id SERIAL,
            customer_id INT NOT NULL,
            order_date DATE NOT NULL,
            CONSTRAINT pk_orders PRIMARY KEY (order_id),
            CONSTRAINT fk_orders_customers
                FOREIGN KEY (customer_id)
                REFERENCES customers(customer_id),
            CONSTRAINT chk_order_date
                CHECK (order_date >= '2020-01-01')
        );
        RAISE NOTICE 'è¡¨ orders_named_constraints åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ orders_named_constraints å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º customers è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders_named_constraints å¤±è´¥: %', SQLERRM;
END $$;
```

---

### 5.2 çº¦æŸé€‰æ‹©åŸåˆ™

**åŸåˆ™1: åœ¨æ•°æ®åº“å±‚å®šä¹‰çº¦æŸ**:

- âœ… æ•°æ®åº“å±‚çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
- âŒ åº”ç”¨å±‚çº¦æŸå¯èƒ½è¢«ç»•è¿‡

**åŸåˆ™2: ä½¿ç”¨åˆé€‚çš„å¤–é”®çº§è”ç­–ç•¥**:

- `CASCADE`: å­è¡¨æ•°æ®éšçˆ¶è¡¨åˆ é™¤
- `RESTRICT`: æœ‰å­è¡¨æ•°æ®æ—¶ç¦æ­¢åˆ é™¤çˆ¶è¡¨
- `SET NULL`: å­è¡¨å¤–é”®è®¾ä¸ºNULL

**åŸåˆ™3: ä½¿ç”¨EXCLUDEçº¦æŸé˜²æ­¢é‡å **:

- æ—¶é—´èŒƒå›´é‡å 
- ç©ºé—´èŒƒå›´é‡å 
- IPåœ°å€èŒƒå›´é‡å 

---

### 5.3 æ€§èƒ½è€ƒè™‘

**ç´¢å¼•è‡ªåŠ¨åˆ›å»º**:

- PRIMARY KEYè‡ªåŠ¨åˆ›å»ºç´¢å¼•
- UNIQUEçº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•
- å¤–é”®å»ºè®®æ‰‹åŠ¨åˆ›å»ºç´¢å¼•ä»¥æé«˜JOINæ€§èƒ½

**ç¤ºä¾‹**:

```sql
-- æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦å…ˆåˆ›å»ºcustomersè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'orders_indexed') THEN
        CREATE TABLE orders_indexed (
            order_id SERIAL PRIMARY KEY,  -- è‡ªåŠ¨åˆ›å»ºç´¢å¼•
            customer_id INT NOT NULL,
            CONSTRAINT fk_order_customer
                FOREIGN KEY (customer_id)
                REFERENCES customers(customer_id)
        );
        RAISE NOTICE 'è¡¨ orders_indexed åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ orders_indexed å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º customers è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders_indexed å¤±è´¥: %', SQLERRM;
END $$;

-- æ‰‹åŠ¨ä¸ºå¤–é”®åˆ›å»ºç´¢å¼•ï¼ˆå¦‚æœæŸ¥è¯¢é¢‘ç¹ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE INDEX IF NOT EXISTS idx_orders_customer ON orders_indexed(customer_id);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 6. å¸¸è§çº¦æŸæ¨¡å¼

### æ¨¡å¼1: è½¯åˆ é™¤

**éœ€æ±‚**: æ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤ã€‚

**å®ç°**:

```sql
-- è½¯åˆ é™¤æ¨¡å¼ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼ŒPostgreSQL 15+ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'products_soft_delete') THEN
        CREATE TABLE products_soft_delete (
            product_id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            deleted_at TIMESTAMPTZ,
            CONSTRAINT uk_product_name_active
                UNIQUE NULLS NOT DISTINCT (name, deleted_at)  -- PostgreSQL 15+
        );
        RAISE NOTICE 'è¡¨ products_soft_delete åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ products_soft_delete å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ products_soft_delete å¤±è´¥: %', SQLERRM;
END $$;
```

---

### æ¨¡å¼2: æ—¶é—´èŒƒå›´çº¦æŸ

**éœ€æ±‚**: ç¡®ä¿æ—¶é—´èŒƒå›´çš„åˆç†æ€§ã€‚

**å®ç°**:

```sql
-- æ—¶é—´èŒƒå›´çº¦æŸç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦btree_gistæ‰©å±•ï¼‰
DO $$
BEGIN
    CREATE EXTENSION IF NOT EXISTS btree_gist;
    RAISE NOTICE 'btree_gistæ‰©å±•å·²å®‰è£…';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'btree_gistæ‰©å±•å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…';
    WHEN OTHERS THEN
        RAISE WARNING 'å®‰è£…btree_gistæ‰©å±•å¤±è´¥: %', SQLERRM;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'events') THEN
        CREATE TABLE events (
            event_id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            start_time TIMESTAMPTZ NOT NULL,
            end_time TIMESTAMPTZ NOT NULL,
            CONSTRAINT chk_event_time_range
                CHECK (end_time > start_time),
            CONSTRAINT uk_event_time_overlap
                EXCLUDE USING GIST (
                    tsrange(start_time, end_time) WITH &&
                )
        );
        RAISE NOTICE 'è¡¨ events åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ events å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ events å¤±è´¥: %', SQLERRM;
END $$;
```

---

### æ¨¡å¼3: çŠ¶æ€è½¬æ¢çº¦æŸ

**éœ€æ±‚**: é™åˆ¶çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§ã€‚

**å®ç°**:

```sql
-- çŠ¶æ€è½¬æ¢çº¦æŸç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'orders_status') THEN
        CREATE TABLE orders_status (
            order_id SERIAL PRIMARY KEY,
            status VARCHAR(20) NOT NULL DEFAULT 'pending',
            previous_status VARCHAR(20),
            CONSTRAINT chk_status_transition CHECK (
                (status = 'pending' AND previous_status IS NULL) OR
                (status = 'processing' AND previous_status = 'pending') OR
                (status = 'shipped' AND previous_status = 'processing') OR
                (status = 'delivered' AND previous_status = 'shipped') OR
                (status = 'cancelled' AND previous_status IN ('pending', 'processing'))
            )
        );
        RAISE NOTICE 'è¡¨ orders_status åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ orders_status å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders_status å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 7. ç›¸å…³èµ„æº

- [èŒƒå¼ç†è®º](./èŒƒå¼ç†è®º.md) - æ•°æ®åº“è§„èŒƒåŒ–ç†è®º
- [ERæ¨¡å‹](./ERæ¨¡å‹.md) - å®ä½“-å…³ç³»æ¨¡å‹
- [å…³ç³»ä»£æ•°](./å…³ç³»ä»£æ•°.md) - å…³ç³»æ¨¡å‹çš„æ•°å­¦åŸºç¡€

---

## 8. å‚è€ƒæ–‡æ¡£

- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹- Abraham Silberschatz et al.
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Constraints](https://www.postgresql.org/docs/current/ddl-constraints.html)
- PostgreSQLå®˜æ–¹æ–‡æ¡£: [Exclusion Constraints](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-EXCLUSION)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
