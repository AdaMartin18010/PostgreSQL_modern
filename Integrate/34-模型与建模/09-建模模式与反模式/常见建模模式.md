# å¸¸è§å»ºæ¨¡æ¨¡å¼

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: æ•°æ®å»ºæ¨¡æ¨¡å¼åº“
> **çŠ¶æ€**: å¾…å®Œå–„
> **æ–‡æ¡£ç¼–å·**: 09-01

---

## ğŸ“‘ ç›®å½•

- [å¸¸è§å»ºæ¨¡æ¨¡å¼](#å¸¸è§å»ºæ¨¡æ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. Partyæ¨¡å¼](#2-partyæ¨¡å¼)
    - [2.1 Partyæ¨¡å¼æ¦‚è¿°](#21-partyæ¨¡å¼æ¦‚è¿°)
    - [2.2 Partyæ¨¡å¼è®¾è®¡](#22-partyæ¨¡å¼è®¾è®¡)
  - [3. Orderæ¨¡å¼](#3-orderæ¨¡å¼)
    - [3.1 Orderæ¨¡å¼æ¦‚è¿°](#31-orderæ¨¡å¼æ¦‚è¿°)
    - [3.2 Orderæ¨¡å¼è®¾è®¡](#32-orderæ¨¡å¼è®¾è®¡)
  - [4. Productæ¨¡å¼](#4-productæ¨¡å¼)
    - [4.1 Productæ¨¡å¼æ¦‚è¿°](#41-productæ¨¡å¼æ¦‚è¿°)
    - [4.2 Productæ¨¡å¼è®¾è®¡](#42-productæ¨¡å¼è®¾è®¡)
  - [5. Accountæ¨¡å¼](#5-accountæ¨¡å¼)
    - [5.1 Accountæ¨¡å¼æ¦‚è¿°](#51-accountæ¨¡å¼æ¦‚è¿°)
    - [5.2 Accountæ¨¡å¼è®¾è®¡](#52-accountæ¨¡å¼è®¾è®¡)
  - [6. PostgreSQLå®ç°](#6-postgresqlå®ç°)
    - [6.1 æ¨¡å¼ç»„åˆä½¿ç”¨](#61-æ¨¡å¼ç»„åˆä½¿ç”¨)
    - [6.2 æ¨¡å¼æŸ¥è¯¢è§†å›¾](#62-æ¨¡å¼æŸ¥è¯¢è§†å›¾)
  - [7. ç›¸å…³èµ„æº](#7-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

å¸¸è§å»ºæ¨¡æ¨¡å¼æ˜¯ç»è¿‡éªŒè¯çš„ã€å¯é‡ç”¨çš„æ•°æ®æ¨¡å‹è®¾è®¡è§£å†³æ–¹æ¡ˆã€‚
è¿™äº›æ¨¡å¼æ¥è‡ªSilverstonçš„æ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œï¼Œæ˜¯æ•°æ®å»ºæ¨¡é¢†åŸŸçš„ç»å…¸æ¨¡å¼ã€‚

**æ ¸å¿ƒä»·å€¼**:

- **å¯é‡ç”¨æ€§**ï¼šæ¨¡å¼å¯åœ¨å¤šä¸ªé¡¹ç›®ä¸­é‡ç”¨
- **æ ‡å‡†åŒ–**ï¼šæä¾›æ ‡å‡†çš„æ•°æ®æ¨¡å‹ç»“æ„
- **æœ€ä½³å®è·µ**ï¼šåŸºäºè¡Œä¸šæœ€ä½³å®è·µ
- **æ‰©å±•æ€§**ï¼šæ¨¡å¼æ˜“äºæ‰©å±•å’Œå®šåˆ¶

---

## 2. Partyæ¨¡å¼

### 2.1 Partyæ¨¡å¼æ¦‚è¿°

**Partyæ¨¡å¼**ï¼šç»Ÿä¸€è¡¨ç¤ºäººå‘˜ï¼ˆPersonï¼‰å’Œç»„ç»‡ï¼ˆOrganizationï¼‰çš„é€šç”¨æ¨¡å¼ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:

- ç»Ÿä¸€ç®¡ç†äººå‘˜å’Œç»„ç»‡
- æ”¯æŒå¤æ‚çš„è§’è‰²å…³ç³»
- çµæ´»çš„è§’è‰²åˆ†é…
- æ˜“äºæ‰©å±•

### 2.2 Partyæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- Partyçˆ¶è¡¨ï¼ˆä½¿ç”¨è¡¨ç»§æ‰¿ï¼‰
CREATE TABLE party (
    party_id SERIAL PRIMARY KEY,
    party_type CHAR(1) NOT NULL CHECK (party_type IN ('P', 'O')),
    -- é€šç”¨å±æ€§
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Personå­è¡¨
CREATE TABLE person (
    party_id INT PRIMARY KEY REFERENCES party(party_id),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    date_of_birth DATE,
    gender CHAR(1) CHECK (gender IN ('M', 'F', 'O')),
    email VARCHAR(200),
    phone VARCHAR(50)
) INHERITS (party);

-- Organizationå­è¡¨
CREATE TABLE organization (
    party_id INT PRIMARY KEY REFERENCES party(party_id),
    legal_name VARCHAR(200) NOT NULL,
    tax_id VARCHAR(50),
    registration_number VARCHAR(100),
    website VARCHAR(200)
) INHERITS (party);

-- Party Roleå…³è”è¡¨
CREATE TABLE party_role (
    role_id SERIAL PRIMARY KEY,
    party_id INT NOT NULL REFERENCES party(party_id),
    role_type VARCHAR(50) NOT NULL, -- 'customer', 'supplier', 'employee', etc.
    role_name VARCHAR(200),
    valid_from TIMESTAMPTZ DEFAULT NOW(),
    valid_to TIMESTAMPTZ,
    is_primary BOOLEAN DEFAULT FALSE,
    UNIQUE(party_id, role_type, valid_from)
);

-- Partyå…³ç³»è¡¨
CREATE TABLE party_relationship (
    relationship_id SERIAL PRIMARY KEY,
    from_party_id INT NOT NULL REFERENCES party(party_id),
    to_party_id INT NOT NULL REFERENCES party(party_id),
    relationship_type VARCHAR(50) NOT NULL, -- 'employee_of', 'customer_of', 'parent_of'
    valid_from TIMESTAMPTZ DEFAULT NOW(),
    valid_to TIMESTAMPTZ,
    CHECK (from_party_id != to_party_id)
);
```

---

## 3. Orderæ¨¡å¼

### 3.1 Orderæ¨¡å¼æ¦‚è¿°

**Orderæ¨¡å¼**ï¼šè®¢å•ç®¡ç†ç³»ç»Ÿçš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„è®¢å•å¤„ç†æµç¨‹ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Order Headerï¼ˆè®¢å•å¤´ï¼‰
- Order Lineï¼ˆè®¢å•è¡Œï¼‰
- Order Statusï¼ˆè®¢å•çŠ¶æ€ï¼‰
- Paymentï¼ˆæ”¯ä»˜ï¼‰
- Shipmentï¼ˆé…é€ï¼‰

### 3.2 Orderæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- è®¢å•å¤´è¡¨
CREATE TABLE order_header (
    order_id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    -- Partyå…³è”
    customer_party_id INT NOT NULL REFERENCES party(party_id),
    -- è®¢å•ä¿¡æ¯
    order_date TIMESTAMPTZ DEFAULT NOW(),
    required_date TIMESTAMPTZ,
    shipped_date TIMESTAMPTZ,
    -- è®¢å•çŠ¶æ€
    order_status VARCHAR(50) DEFAULT 'pending',
    -- é‡‘é¢ä¿¡æ¯
    subtotal NUMERIC(10,2) NOT NULL DEFAULT 0,
    tax_amount NUMERIC(10,2) DEFAULT 0,
    shipping_amount NUMERIC(10,2) DEFAULT 0,
    total_amount NUMERIC(10,2) GENERATED ALWAYS AS (
        subtotal + tax_amount + shipping_amount
    ) STORED,
    -- å…ƒæ•°æ®
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- è®¢å•è¡Œè¡¨
CREATE TABLE order_line (
    line_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    line_number INT NOT NULL,
    -- äº§å“å…³è”
    product_id INT NOT NULL, -- å¼•ç”¨äº§å“è¡¨
    -- è®¢å•è¡Œä¿¡æ¯
    quantity INT NOT NULL CHECK (quantity > 0),
    unit_price NUMERIC(10,2) NOT NULL,
    discount_amount NUMERIC(10,2) DEFAULT 0,
    line_total NUMERIC(10,2) GENERATED ALWAYS AS (
        quantity * unit_price - discount_amount
    ) STORED,
    -- çŠ¶æ€
    line_status VARCHAR(50) DEFAULT 'pending',
    -- å…ƒæ•°æ®
    notes TEXT,
    UNIQUE(order_id, line_number)
);

-- è®¢å•çŠ¶æ€å†å²è¡¨
CREATE TABLE order_status_history (
    history_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    changed_at TIMESTAMPTZ DEFAULT NOW(),
    changed_by VARCHAR(100),
    notes TEXT
);

-- æ”¯ä»˜è¡¨
CREATE TABLE payment (
    payment_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    payment_method VARCHAR(50) NOT NULL, -- 'credit_card', 'debit_card', 'paypal', etc.
    payment_status VARCHAR(50) DEFAULT 'pending',
    amount NUMERIC(10,2) NOT NULL,
    payment_date TIMESTAMPTZ,
    transaction_id VARCHAR(100),
    payment_details JSONB
);
```

---

## 4. Productæ¨¡å¼

### 4.1 Productæ¨¡å¼æ¦‚è¿°

**Productæ¨¡å¼**ï¼šäº§å“ç›®å½•ç®¡ç†çš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„äº§å“åˆ†ç±»å’Œå±æ€§ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Productï¼ˆäº§å“ï¼‰
- Product Categoryï¼ˆäº§å“åˆ†ç±»ï¼‰
- Product Attributeï¼ˆäº§å“å±æ€§ï¼‰
- Product Priceï¼ˆäº§å“ä»·æ ¼ï¼‰

### 4.2 Productæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- äº§å“åˆ†ç±»è¡¨
CREATE TABLE product_category (
    category_id SERIAL PRIMARY KEY,
    parent_category_id INT REFERENCES product_category(category_id),
    category_code VARCHAR(50) UNIQUE NOT NULL,
    category_name VARCHAR(200) NOT NULL,
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);

-- äº§å“è¡¨
CREATE TABLE product (
    product_id SERIAL PRIMARY KEY,
    product_code VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    -- åˆ†ç±»å…³è”
    category_id INT REFERENCES product_category(category_id),
    -- äº§å“ä¿¡æ¯
    description TEXT,
    brand VARCHAR(100),
    manufacturer VARCHAR(200),
    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'active', -- 'active', 'inactive', 'discontinued'
    -- å…ƒæ•°æ®
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº§å“å±æ€§å®šä¹‰è¡¨
CREATE TABLE product_attribute_definition (
    attribute_id SERIAL PRIMARY KEY,
    category_id INT REFERENCES product_category(category_id),
    attribute_name VARCHAR(100) NOT NULL,
    attribute_type VARCHAR(50) NOT NULL, -- 'text', 'number', 'boolean', 'date'
    is_required BOOLEAN DEFAULT FALSE,
    display_order INT DEFAULT 0,
    UNIQUE(category_id, attribute_name)
);

-- äº§å“å±æ€§å€¼è¡¨
CREATE TABLE product_attribute_value (
    value_id BIGSERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES product(product_id),
    attribute_id INT NOT NULL REFERENCES product_attribute_definition(attribute_id),
    attribute_value TEXT NOT NULL,
    UNIQUE(product_id, attribute_id)
);

-- äº§å“ä»·æ ¼è¡¨ï¼ˆæ”¯æŒå¤šä»·æ ¼ç­–ç•¥ï¼‰
CREATE TABLE product_price (
    price_id BIGSERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES product(product_id),
    price_type VARCHAR(50) NOT NULL, -- 'list', 'sale', 'wholesale', 'member'
    price_amount NUMERIC(10,2) NOT NULL,
    currency_code CHAR(3) DEFAULT 'USD',
    valid_from TIMESTAMPTZ DEFAULT NOW(),
    valid_to TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE
);

-- äº§å“åº“å­˜è¡¨
CREATE TABLE product_inventory (
    inventory_id BIGSERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES product(product_id),
    location_id INT, -- ä»“åº“ä½ç½®
    quantity_on_hand INT NOT NULL DEFAULT 0,
    quantity_reserved INT NOT NULL DEFAULT 0,
    quantity_available INT GENERATED ALWAYS AS (
        quantity_on_hand - quantity_reserved
    ) STORED,
    reorder_point INT DEFAULT 0,
    last_updated TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 5. Accountæ¨¡å¼

### 5.1 Accountæ¨¡å¼æ¦‚è¿°

**Accountæ¨¡å¼**ï¼šè´¦æˆ·ç®¡ç†çš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒé‡‘èè´¦æˆ·ã€ä¼šå‘˜è´¦æˆ·ç­‰å¤šç§è´¦æˆ·ç±»å‹ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Accountï¼ˆè´¦æˆ·ï¼‰
- Account Typeï¼ˆè´¦æˆ·ç±»å‹ï¼‰
- Account Balanceï¼ˆè´¦æˆ·ä½™é¢ï¼‰
- Transactionï¼ˆäº¤æ˜“ï¼‰

### 5.2 Accountæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- è´¦æˆ·ç±»å‹è¡¨
CREATE TABLE account_type (
    type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(200) NOT NULL,
    description TEXT,
    allows_negative_balance BOOLEAN DEFAULT FALSE,
    interest_rate NUMERIC(5,4) DEFAULT 0
);

-- è´¦æˆ·è¡¨
CREATE TABLE account (
    account_id BIGSERIAL PRIMARY KEY,
    account_number VARCHAR(50) UNIQUE NOT NULL,
    -- Partyå…³è”
    party_id INT NOT NULL REFERENCES party(party_id),
    -- è´¦æˆ·ç±»å‹
    account_type_id INT NOT NULL REFERENCES account_type(type_id),
    -- è´¦æˆ·ä¿¡æ¯
    account_name VARCHAR(200),
    currency_code CHAR(3) DEFAULT 'USD',
    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'active', -- 'active', 'closed', 'frozen'
    -- æ—¶é—´æˆ³
    opened_date DATE DEFAULT CURRENT_DATE,
    closed_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è´¦æˆ·ä½™é¢è¡¨ï¼ˆå¿«ç…§è¡¨ï¼‰
CREATE TABLE account_balance (
    balance_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES account(account_id),
    balance_date DATE NOT NULL,
    -- ä½™é¢ä¿¡æ¯
    opening_balance NUMERIC(15,2) NOT NULL DEFAULT 0,
    closing_balance NUMERIC(15,2) NOT NULL DEFAULT 0,
    -- äº¤æ˜“ç»Ÿè®¡
    debit_count INT DEFAULT 0,
    credit_count INT DEFAULT 0,
    total_debits NUMERIC(15,2) DEFAULT 0,
    total_credits NUMERIC(15,2) DEFAULT 0,
    UNIQUE(account_id, balance_date)
);

-- äº¤æ˜“è¡¨
CREATE TABLE transaction (
    transaction_id BIGSERIAL PRIMARY KEY,
    transaction_number VARCHAR(50) UNIQUE NOT NULL,
    -- è´¦æˆ·å…³è”
    account_id BIGINT NOT NULL REFERENCES account(account_id),
    -- äº¤æ˜“ä¿¡æ¯
    transaction_type VARCHAR(50) NOT NULL, -- 'debit', 'credit', 'transfer'
    transaction_date TIMESTAMPTZ DEFAULT NOW(),
    amount NUMERIC(15,2) NOT NULL,
    -- ä½™é¢
    balance_after NUMERIC(15,2),
    -- å…³è”ä¿¡æ¯
    related_transaction_id BIGINT REFERENCES transaction(transaction_id),
    related_account_id BIGINT REFERENCES account(account_id),
    -- æè¿°
    description TEXT,
    reference_number VARCHAR(100),
    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'posted', -- 'pending', 'posted', 'cancelled'
    posted_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_transaction_account_date ON transaction(account_id, transaction_date DESC);
CREATE INDEX idx_transaction_type ON transaction(transaction_type, transaction_date DESC);
CREATE INDEX idx_account_balance_date ON account_balance(account_id, balance_date DESC);
```

---

## 6. PostgreSQLå®ç°

### 6.1 æ¨¡å¼ç»„åˆä½¿ç”¨

**ç»¼åˆåº”ç”¨ç¤ºä¾‹**:

```sql
-- ç”µå•†ç³»ç»Ÿï¼šç»„åˆä½¿ç”¨Partyã€Orderã€Productæ¨¡å¼
-- 1. å®¢æˆ·ï¼ˆPartyï¼‰
INSERT INTO person (party_id, party_type, name, first_name, last_name, email)
VALUES (1, 'P', 'John Doe', 'John', 'Doe', 'john@example.com');

INSERT INTO party_role (party_id, role_type, role_name, is_primary)
VALUES (1, 'customer', 'Customer', TRUE);

-- 2. äº§å“ï¼ˆProductï¼‰
INSERT INTO product (product_code, product_name, category_id, status)
VALUES ('PROD001', 'Laptop Computer', 1, 'active');

INSERT INTO product_price (product_id, price_type, price_amount)
VALUES (1, 'list', 999.99);

-- 3. è®¢å•ï¼ˆOrderï¼‰
INSERT INTO order_header (order_number, customer_party_id, order_status, subtotal)
VALUES ('ORD001', 1, 'pending', 999.99);

INSERT INTO order_line (order_id, line_number, product_id, quantity, unit_price)
VALUES (1, 1, 1, 1, 999.99);

-- 4. è´¦æˆ·ï¼ˆAccountï¼‰- å¦‚æœæ”¯æŒè´¦æˆ·ä½™é¢
INSERT INTO account (account_number, party_id, account_type_id, account_name)
VALUES ('ACC001', 1, 1, 'Customer Account');
```

### 6.2 æ¨¡å¼æŸ¥è¯¢è§†å›¾

**å¸¸ç”¨æŸ¥è¯¢è§†å›¾**:

```sql
-- å®¢æˆ·è®¢å•è§†å›¾
CREATE VIEW customer_order_view AS
SELECT
    p.party_id,
    p.name AS customer_name,
    o.order_id,
    o.order_number,
    o.order_date,
    o.total_amount,
    o.order_status,
    COUNT(ol.line_id) AS line_count
FROM party p
JOIN party_role pr ON p.party_id = pr.party_id AND pr.role_type = 'customer'
JOIN order_header o ON p.party_id = o.customer_party_id
LEFT JOIN order_line ol ON o.order_id = ol.order_id
GROUP BY p.party_id, p.name, o.order_id, o.order_number, o.order_date, o.total_amount, o.order_status;

-- äº§å“é”€å”®ç»Ÿè®¡è§†å›¾
CREATE VIEW product_sales_view AS
SELECT
    p.product_id,
    p.product_code,
    p.product_name,
    SUM(ol.quantity) AS total_quantity_sold,
    SUM(ol.line_total) AS total_revenue,
    COUNT(DISTINCT ol.order_id) AS order_count
FROM product p
JOIN order_line ol ON p.product_id = ol.product_id
JOIN order_header o ON ol.order_id = o.order_id
WHERE o.order_status = 'completed'
GROUP BY p.product_id, p.product_code, p.product_name;
```

---

## 7. ç›¸å…³èµ„æº

- [Partyæ¨¡å‹](../04-OLTPå»ºæ¨¡/Partyæ¨¡å‹.md) - Partyæ¨¡å‹è¯¦ç»†è¯´æ˜
- [è®¢å•ç®¡ç†æ¨¡å‹](../04-OLTPå»ºæ¨¡/è®¢å•ç®¡ç†æ¨¡å‹.md) - è®¢å•æ¨¡å‹è¯¦ç»†è¯´æ˜
- [Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ](../02-æƒå¨èµ„æºä¸æ ‡å‡†/Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ.md) - æƒå¨èµ„æº
- [å»ºæ¨¡åæ¨¡å¼](./å»ºæ¨¡åæ¨¡å¼.md) - åæ¨¡å¼è¯†åˆ«

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
