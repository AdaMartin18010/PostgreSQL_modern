# å¸¸è§å»ºæ¨¡æ¨¡å¼

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: æ•°æ®å»ºæ¨¡æ¨¡å¼åº“
> **çŠ¶æ€**: âœ… å·²å®Œæˆ
> **æ–‡æ¡£ç¼–å·**: 09-01

---

## ğŸ“‘ ç›®å½•

- [å¸¸è§å»ºæ¨¡æ¨¡å¼](#å¸¸è§å»ºæ¨¡æ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 ç†è®ºåŸºç¡€](#11-ç†è®ºåŸºç¡€)
    - [1.1.1 å»ºæ¨¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ](#111-å»ºæ¨¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ)
    - [1.1.2 Partyæ¨¡å¼ç†è®º](#112-partyæ¨¡å¼ç†è®º)
    - [1.1.3 Orderæ¨¡å¼ç†è®º](#113-orderæ¨¡å¼ç†è®º)
    - [1.1.4 Productæ¨¡å¼ç†è®º](#114-productæ¨¡å¼ç†è®º)
    - [1.1.5 Accountæ¨¡å¼ç†è®º](#115-accountæ¨¡å¼ç†è®º)
    - [1.1.6 æ¨¡å¼ç»„åˆç†è®º](#116-æ¨¡å¼ç»„åˆç†è®º)
    - [1.1.7 å¤æ‚åº¦åˆ†æ](#117-å¤æ‚åº¦åˆ†æ)
  - [2. Partyæ¨¡å¼](#2-partyæ¨¡å¼)
    - [2.1 Partyæ¨¡å¼æ¦‚è¿°](#21-partyæ¨¡å¼æ¦‚è¿°)
    - [2.2 Partyæ¨¡å¼è®¾è®¡](#22-partyæ¨¡å¼è®¾è®¡)
  - [3. Orderæ¨¡å¼](#3-orderæ¨¡å¼)
    - [3.1 Orderæ¨¡å¼æ¦‚è¿°](#31-orderæ¨¡å¼æ¦‚è¿°)
    - [3.2 Orderæ¨¡å¼è®¾è®¡](#32-orderæ¨¡å¼è®¾è®¡)
  - [5. Accountæ¨¡å¼](#5-accountæ¨¡å¼)
    - [5.1 Accountæ¨¡å¼æ¦‚è¿°](#51-accountæ¨¡å¼æ¦‚è¿°)
    - [5.2 Accountæ¨¡å¼è®¾è®¡](#52-accountæ¨¡å¼è®¾è®¡)
    - [6.2 æ¨¡å¼æŸ¥è¯¢è§†å›¾](#62-æ¨¡å¼æŸ¥è¯¢è§†å›¾)
  - [7. æ¨¡å¼åº”ç”¨æ¡ˆä¾‹ / Pattern Application Examples](#7-æ¨¡å¼åº”ç”¨æ¡ˆä¾‹--pattern-application-examples)
    - [7.1 æ¡ˆä¾‹1: CRMç³»ç»Ÿï¼ˆPartyæ¨¡å¼ï¼‰](#71-æ¡ˆä¾‹1-crmç³»ç»Ÿpartyæ¨¡å¼)
    - [7.2 æ¡ˆä¾‹2: ç”µå•†ç³»ç»Ÿï¼ˆParty+Order+Productæ¨¡å¼ï¼‰](#72-æ¡ˆä¾‹2-ç”µå•†ç³»ç»Ÿpartyorderproductæ¨¡å¼)
    - [7.3 æ¡ˆä¾‹3: é“¶è¡Œç³»ç»Ÿï¼ˆAccountæ¨¡å¼ï¼‰](#73-æ¡ˆä¾‹3-é“¶è¡Œç³»ç»Ÿaccountæ¨¡å¼)
  - [8. å¸¸è§é—®é¢˜è§£ç­” / FAQ](#8-å¸¸è§é—®é¢˜è§£ç­”--faq)
    - [Q1: ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨Partyæ¨¡å¼ï¼Ÿ](#q1-ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨partyæ¨¡å¼)
    - [Q2: Orderæ¨¡å¼å’ŒAccountæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](#q2-orderæ¨¡å¼å’Œaccountæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«)
    - [Q3: å¦‚ä½•ç»„åˆä½¿ç”¨å¤šä¸ªæ¨¡å¼ï¼Ÿ](#q3-å¦‚ä½•ç»„åˆä½¿ç”¨å¤šä¸ªæ¨¡å¼)
    - [Q4: æ¨¡å¼è®¾è®¡å¦‚ä½•å¹³è¡¡çµæ´»æ€§å’Œæ€§èƒ½ï¼Ÿ](#q4-æ¨¡å¼è®¾è®¡å¦‚ä½•å¹³è¡¡çµæ´»æ€§å’Œæ€§èƒ½)
    - [Q5: å¦‚ä½•è¿ç§»ç°æœ‰ç³»ç»Ÿåˆ°æ ‡å‡†æ¨¡å¼ï¼Ÿ](#q5-å¦‚ä½•è¿ç§»ç°æœ‰ç³»ç»Ÿåˆ°æ ‡å‡†æ¨¡å¼)
  - [8. ç›¸å…³èµ„æº / Related Resources](#8-ç›¸å…³èµ„æº--related-resources)
    - [8.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents](#81-æ ¸å¿ƒç›¸å…³æ–‡æ¡£--core-related-documents)
    - [8.2 ç†è®ºåŸºç¡€ / Theoretical Foundation](#82-ç†è®ºåŸºç¡€--theoretical-foundation)
    - [8.3 å®è·µæŒ‡å— / Practical Guides](#83-å®è·µæŒ‡å—--practical-guides)
    - [8.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases](#84-åº”ç”¨æ¡ˆä¾‹--application-cases)
    - [8.5 å‚è€ƒèµ„æº / Reference Resources](#85-å‚è€ƒèµ„æº--reference-resources)

---

## 1. æ¦‚è¿°

å¸¸è§å»ºæ¨¡æ¨¡å¼æ˜¯ç»è¿‡éªŒè¯çš„ã€å¯é‡ç”¨çš„æ•°æ®æ¨¡å‹è®¾è®¡è§£å†³æ–¹æ¡ˆã€‚
è¿™äº›æ¨¡å¼æ¥è‡ªSilverstonçš„æ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œï¼Œæ˜¯æ•°æ®å»ºæ¨¡é¢†åŸŸçš„ç»å…¸æ¨¡å¼ã€‚

**æ ¸å¿ƒä»·å€¼**:

- **å¯é‡ç”¨æ€§**ï¼šæ¨¡å¼å¯åœ¨å¤šä¸ªé¡¹ç›®ä¸­é‡ç”¨
- **æ ‡å‡†åŒ–**ï¼šæä¾›æ ‡å‡†çš„æ•°æ®æ¨¡å‹ç»“æ„
- **æœ€ä½³å®è·µ**ï¼šåŸºäºè¡Œä¸šæœ€ä½³å®è·µ
- **æ‰©å±•æ€§**ï¼šæ¨¡å¼æ˜“äºæ‰©å±•å’Œå®šåˆ¶

---

## 1.1 ç†è®ºåŸºç¡€

### 1.1.1 å»ºæ¨¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ

**å»ºæ¨¡æ¨¡å¼ï¼ˆData Modeling Patternï¼‰**:

- **å®šä¹‰**: ç»è¿‡éªŒè¯çš„ã€å¯é‡ç”¨çš„æ•°æ®æ¨¡å‹è®¾è®¡è§£å†³æ–¹æ¡ˆ
- **æ¥æº**: Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ
- **ç›®çš„**: æä¾›æ ‡å‡†çš„æ•°æ®æ¨¡å‹ç»“æ„

**æ¨¡å¼ç‰¹å¾**:

- **å¯é‡ç”¨æ€§**: æ¨¡å¼å¯ä»¥åœ¨å¤šä¸ªé¡¹ç›®ä¸­é‡ç”¨
- **æ ‡å‡†åŒ–**: æä¾›æ ‡å‡†çš„æ•°æ®æ¨¡å‹ç»“æ„
- **æœ€ä½³å®è·µ**: åŸºäºè¡Œä¸šæœ€ä½³å®è·µ
- **æ‰©å±•æ€§**: æ¨¡å¼æ˜“äºæ‰©å±•å’Œå®šåˆ¶

### 1.1.2 Partyæ¨¡å¼ç†è®º

**Partyæ¨¡å¼**:

- **å®šä¹‰**: ç»Ÿä¸€è¡¨ç¤ºäººå‘˜ï¼ˆPersonï¼‰å’Œç»„ç»‡ï¼ˆOrganizationï¼‰çš„é€šç”¨æ¨¡å¼
- **æŠ½è±¡**: $Party = Person \cup Organization$
- **ä¼˜åŠ¿**: é¿å…é‡å¤è®¾è®¡ï¼Œæ”¯æŒå¤æ‚è§’è‰²å…³ç³»

**Partyæ¨¡å¼ä¼˜åŠ¿**:

- **ç»Ÿä¸€ç®¡ç†**: ç»Ÿä¸€ç®¡ç†äººå‘˜å’Œç»„ç»‡
- **è§’è‰²åˆ†ç¦»**: è§’è‰²é€šè¿‡Party Roleè¡¨ç®¡ç†
- **å…³ç³»ç®¡ç†**: æ”¯æŒå¤æ‚çš„Partyå…³ç³»

### 1.1.3 Orderæ¨¡å¼ç†è®º

**Orderæ¨¡å¼**:

- **å®šä¹‰**: è®¢å•å¤´-è®¢å•è¡Œæ¨¡å¼
- **ç»“æ„**: Order Header + Order Lines
- **ä¼˜åŠ¿**: æ”¯æŒå¤æ‚è®¢å•ç»“æ„

**Orderæ¨¡å¼ç‰¹ç‚¹**:

- **ä¸€å¯¹å¤šå…³ç³»**: ä¸€ä¸ªè®¢å•å¤´å¯¹åº”å¤šä¸ªè®¢å•è¡Œ
- **èšåˆæ ¹**: è®¢å•å¤´æ˜¯èšåˆæ ¹
- **äº‹åŠ¡è¾¹ç•Œ**: è®¢å•å¤´+è®¢å•è¡Œåœ¨åŒä¸€äº‹åŠ¡ä¸­

### 1.1.4 Productæ¨¡å¼ç†è®º

**Productæ¨¡å¼**:

- **å®šä¹‰**: äº§å“åˆ†ç±»å’Œå±æ€§æ¨¡å¼
- **ç»“æ„**: Product + Product Category + Product Attribute
- **ä¼˜åŠ¿**: æ”¯æŒçµæ´»çš„äº§å“å±æ€§ç®¡ç†

**Productæ¨¡å¼ç‰¹ç‚¹**:

- **åˆ†ç±»å±‚æ¬¡**: æ”¯æŒäº§å“åˆ†ç±»å±‚æ¬¡ç»“æ„
- **å±æ€§çµæ´»**: æ”¯æŒåŠ¨æ€äº§å“å±æ€§
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒäº§å“ç‰ˆæœ¬ç®¡ç†

### 1.1.5 Accountæ¨¡å¼ç†è®º

**Accountæ¨¡å¼**:

- **å®šä¹‰**: è´¦æˆ·ä½™é¢å’Œäº¤æ˜“æ¨¡å¼
- **ç»“æ„**: Account + Account Balance + Transaction
- **ä¼˜åŠ¿**: æ”¯æŒè´¦æˆ·ä½™é¢å’Œäº¤æ˜“å†å²

**Accountæ¨¡å¼ç‰¹ç‚¹**:

- **ä½™é¢ç®¡ç†**: æ”¯æŒè´¦æˆ·ä½™é¢ç®¡ç†
- **äº¤æ˜“å†å²**: è®°å½•æ‰€æœ‰äº¤æ˜“å†å²
- **ä¸€è‡´æ€§**: ä¿è¯ä½™é¢ä¸€è‡´æ€§

### 1.1.6 æ¨¡å¼ç»„åˆç†è®º

**æ¨¡å¼ç»„åˆ**:

- **ç»„åˆåŸåˆ™**: æ¨¡å¼å¯ä»¥ç»„åˆä½¿ç”¨
- **ç»„åˆæ–¹å¼**: Party + Order + Product
- **ç»„åˆä¼˜åŠ¿**: æ„å»ºå®Œæ•´çš„ä¸šåŠ¡æ¨¡å‹

**æ¨¡å¼ç»„åˆç¤ºä¾‹**:

- **CRMç³»ç»Ÿ**: Partyæ¨¡å¼
- **ç”µå•†ç³»ç»Ÿ**: Party + Order + Productæ¨¡å¼
- **é“¶è¡Œç³»ç»Ÿ**: Party + Accountæ¨¡å¼

### 1.1.7 å¤æ‚åº¦åˆ†æ

**å­˜å‚¨å¤æ‚åº¦**:

- **Partyæ¨¡å¼**: $O(P)$ where P is number of parties
- **Orderæ¨¡å¼**: $O(O + L)$ where O is orders, L is order lines
- **Productæ¨¡å¼**: $O(P + C)$ where P is products, C is categories

**æŸ¥è¯¢å¤æ‚åº¦**:

- **æ¨¡å¼æŸ¥è¯¢**: $O(\log N)$ with index
- **æ¨¡å¼ç»„åˆæŸ¥è¯¢**: $O(\log N \times M)$ where M is number of patterns

---

## 2. Partyæ¨¡å¼

### 2.1 Partyæ¨¡å¼æ¦‚è¿°

**Partyæ¨¡å¼**ï¼šç»Ÿä¸€è¡¨ç¤ºäººå‘˜ï¼ˆPersonï¼‰å’Œç»„ç»‡ï¼ˆOrganizationï¼‰çš„é€šç”¨æ¨¡å¼ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:

- ç»Ÿä¸€ç®¡ç†äººå‘˜å’Œç»„ç»‡
- æ”¯æŒå¤æ‚çš„è§’è‰²å…³ç³»
- çµæ´»çš„è§’è‰²åˆ†é…
- æ˜“äºæ‰©å±•

### 2.2 Partyæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- Partyçˆ¶è¡¨ï¼ˆä½¿ç”¨è¡¨ç»§æ‰¿ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS party (
        party_id SERIAL PRIMARY KEY,
        party_type CHAR(1) NOT NULL CHECK (party_type IN ('P', 'O')),
        -- é€šç”¨å±æ€§
        name TEXT NOT NULL,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'è¡¨ party åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ party å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ party å¤±è´¥: %', SQLERRM;
END $$;

-- Personå­è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS person (
        party_id INT PRIMARY KEY REFERENCES party(party_id),
        first_name VARCHAR(100),
        last_name VARCHAR(100),
        date_of_birth DATE,
        gender CHAR(1) CHECK (gender IN ('M', 'F', 'O')),
        email VARCHAR(200),
        phone VARCHAR(50)
    ) INHERITS (party);
    RAISE NOTICE 'è¡¨ person åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ person å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ person å¤±è´¥: %', SQLERRM;
END $$;

-- Organizationå­è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS organization (
        party_id INT PRIMARY KEY REFERENCES party(party_id),
        legal_name VARCHAR(200) NOT NULL,
        tax_id VARCHAR(50),
        registration_number VARCHAR(100),
        website VARCHAR(200)
    ) INHERITS (party);
    RAISE NOTICE 'è¡¨ organization åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ organization å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ organization å¤±è´¥: %', SQLERRM;
END $$;

-- Party Roleå…³è”è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS party_role (
        role_id SERIAL PRIMARY KEY,
        party_id INT NOT NULL REFERENCES party(party_id),
        role_type VARCHAR(50) NOT NULL, -- 'customer', 'supplier', 'employee', etc.
        role_name VARCHAR(200),
        valid_from TIMESTAMPTZ DEFAULT NOW(),
        valid_to TIMESTAMPTZ,
        is_primary BOOLEAN DEFAULT FALSE,
        UNIQUE(party_id, role_type, valid_from)
    );
    RAISE NOTICE 'è¡¨ party_role åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ party_role å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ party_role å¤±è´¥: %', SQLERRM;
END $$;

-- Partyå…³ç³»è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS party_relationship (
        relationship_id SERIAL PRIMARY KEY,
        from_party_id INT NOT NULL REFERENCES party(party_id),
        to_party_id INT NOT NULL REFERENCES party(party_id),
        relationship_type VARCHAR(50) NOT NULL, -- 'employee_of', 'customer_of', 'parent_of'
        valid_from TIMESTAMPTZ DEFAULT NOW(),
        valid_to TIMESTAMPTZ,
        CHECK (from_party_id != to_party_id)
    );
    RAISE NOTICE 'è¡¨ party_relationship åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ party_relationship å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ party_relationship å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 3. Orderæ¨¡å¼

### 3.1 Orderæ¨¡å¼æ¦‚è¿°

**Orderæ¨¡å¼**ï¼šè®¢å•ç®¡ç†ç³»ç»Ÿçš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„è®¢å•å¤„ç†æµç¨‹ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Order Headerï¼ˆè®¢å•å¤´ï¼‰
- Order Lineï¼ˆè®¢å•è¡Œï¼‰
- Order Statusï¼ˆè®¢å•çŠ¶æ€ï¼‰
- Paymentï¼ˆæ”¯ä»˜ï¼‰
- Shipmentï¼ˆé…é€ï¼‰

### 3.2 Orderæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- è®¢å•å¤´è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS order_header (
        order_id BIGSERIAL PRIMARY KEY,
        order_number VARCHAR(50) UNIQUE NOT NULL,
        -- Partyå…³è”
        customer_party_id INT NOT NULL REFERENCES party(party_id),
        -- è®¢å•ä¿¡æ¯
        order_date TIMESTAMPTZ DEFAULT NOW(),
        required_date TIMESTAMPTZ,
        shipped_date TIMESTAMPTZ,
        -- è®¢å•çŠ¶æ€
        order_status VARCHAR(50) DEFAULT 'pending',
        -- é‡‘é¢ä¿¡æ¯
        subtotal NUMERIC(10,2) NOT NULL DEFAULT 0,
        tax_amount NUMERIC(10,2) DEFAULT 0,
        shipping_amount NUMERIC(10,2) DEFAULT 0,
        total_amount NUMERIC(10,2) GENERATED ALWAYS AS (
            subtotal + tax_amount + shipping_amount
        ) STORED,
        -- å…ƒæ•°æ®
        notes TEXT,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'è¡¨ order_header åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨ order_header å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ order_header å¤±è´¥: %', SQLERRM;
END $$;
```

-- è®¢å•è¡Œè¡¨
CREATE TABLE order_line (
    line_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    line_number INT NOT NULL,
    -- äº§å“å…³è”
    product_id INT NOT NULL, -- å¼•ç”¨äº§å“è¡¨
    -- è®¢å•è¡Œä¿¡æ¯
    quantity INT NOT NULL CHECK (quantity > 0),
    unit_price NUMERIC(10,2) NOT NULL,
    discount_amount NUMERIC(10,2) DEFAULT 0,
    line_total NUMERIC(10,2) GENERATED ALWAYS AS (
        quantity * unit_price - discount_amount
    ) STORED,
    -- çŠ¶æ€
    line_status VARCHAR(50) DEFAULT 'pending',
    -- å…ƒæ•°æ®
    notes TEXT,
    UNIQUE(order_id, line_number)
);

-- è®¢å•çŠ¶æ€å†å²è¡¨
CREATE TABLE order_status_history (
    history_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    changed_at TIMESTAMPTZ DEFAULT NOW(),
    changed_by VARCHAR(100),
    notes TEXT
);

-- æ”¯ä»˜è¡¨
CREATE TABLE payment (
    payment_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_header(order_id),
    payment_method VARCHAR(50) NOT NULL, -- 'credit_card', 'debit_card', 'paypal', etc.
    payment_status VARCHAR(50) DEFAULT 'pending',
    amount NUMERIC(10,2) NOT NULL,
    payment_date TIMESTAMPTZ,
    transaction_id VARCHAR(100),
    payment_details JSONB
);

```

---

## 4. Productæ¨¡å¼

### 4.1 Productæ¨¡å¼æ¦‚è¿°

**Productæ¨¡å¼**ï¼šäº§å“ç›®å½•ç®¡ç†çš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„äº§å“åˆ†ç±»å’Œå±æ€§ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Productï¼ˆäº§å“ï¼‰
- Product Categoryï¼ˆäº§å“åˆ†ç±»ï¼‰
- Product Attributeï¼ˆäº§å“å±æ€§ï¼‰
- Product Priceï¼ˆäº§å“ä»·æ ¼ï¼‰

### 4.2 Productæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- äº§å“åˆ†ç±»è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product_category') THEN
        CREATE TABLE product_category (
            category_id SERIAL PRIMARY KEY,
            parent_category_id INT REFERENCES product_category(category_id),
            category_code VARCHAR(50) UNIQUE NOT NULL,
            category_name VARCHAR(200) NOT NULL,
            description TEXT,
            display_order INT DEFAULT 0,
            is_active BOOLEAN DEFAULT TRUE
        );
        RAISE NOTICE 'è¡¨ product_category åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product_category å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product_category å¤±è´¥: %', SQLERRM;
END $$;

-- äº§å“è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product') THEN
        CREATE TABLE product (
            product_id SERIAL PRIMARY KEY,
            product_code VARCHAR(50) UNIQUE NOT NULL,
            product_name VARCHAR(200) NOT NULL,
            -- åˆ†ç±»å…³è”
            category_id INT REFERENCES product_category(category_id),
            -- äº§å“ä¿¡æ¯
            description TEXT,
            brand VARCHAR(100),
            manufacturer VARCHAR(200),
            -- çŠ¶æ€
            status VARCHAR(50) DEFAULT 'active', -- 'active', 'inactive', 'discontinued'
            -- å…ƒæ•°æ®
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ product åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product å¤±è´¥: %', SQLERRM;
END $$;

-- äº§å“å±æ€§å®šä¹‰è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product_attribute_definition') THEN
        CREATE TABLE product_attribute_definition (
            attribute_id SERIAL PRIMARY KEY,
            category_id INT REFERENCES product_category(category_id),
            attribute_name VARCHAR(100) NOT NULL,
            attribute_type VARCHAR(50) NOT NULL, -- 'text', 'number', 'boolean', 'date'
            is_required BOOLEAN DEFAULT FALSE,
            display_order INT DEFAULT 0,
            UNIQUE(category_id, attribute_name)
        );
        RAISE NOTICE 'è¡¨ product_attribute_definition åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product_attribute_definition å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product_attribute_definition å¤±è´¥: %', SQLERRM;
END $$;

-- äº§å“å±æ€§å€¼è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product_attribute_value') THEN
        CREATE TABLE product_attribute_value (
            value_id BIGSERIAL PRIMARY KEY,
            product_id INT NOT NULL REFERENCES product(product_id),
            attribute_id INT NOT NULL REFERENCES product_attribute_definition(attribute_id),
            attribute_value TEXT NOT NULL,
            UNIQUE(product_id, attribute_id)
        );
        RAISE NOTICE 'è¡¨ product_attribute_value åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product_attribute_value å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product_attribute_value å¤±è´¥: %', SQLERRM;
END $$;

-- äº§å“ä»·æ ¼è¡¨ï¼ˆæ”¯æŒå¤šä»·æ ¼ç­–ç•¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product_price') THEN
        CREATE TABLE product_price (
            price_id BIGSERIAL PRIMARY KEY,
            product_id INT NOT NULL REFERENCES product(product_id),
            price_type VARCHAR(50) NOT NULL, -- 'list', 'sale', 'wholesale', 'member'
            price_amount NUMERIC(10,2) NOT NULL,
            currency_code CHAR(3) DEFAULT 'USD',
            valid_from TIMESTAMPTZ DEFAULT NOW(),
            valid_to TIMESTAMPTZ,
            is_active BOOLEAN DEFAULT TRUE
        );
        RAISE NOTICE 'è¡¨ product_price åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product_price å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product_price å¤±è´¥: %', SQLERRM;
END $$;

-- äº§å“åº“å­˜è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'product_inventory') THEN
        CREATE TABLE product_inventory (
            inventory_id BIGSERIAL PRIMARY KEY,
            product_id INT NOT NULL REFERENCES product(product_id),
            location_id INT, -- ä»“åº“ä½ç½®
            quantity_on_hand INT NOT NULL DEFAULT 0,
            quantity_reserved INT NOT NULL DEFAULT 0,
            quantity_available INT GENERATED ALWAYS AS (
                quantity_on_hand - quantity_reserved
            ) STORED,
            reorder_point INT DEFAULT 0,
            last_updated TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ product_inventory åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ product_inventory å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ product_inventory å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 5. Accountæ¨¡å¼

### 5.1 Accountæ¨¡å¼æ¦‚è¿°

**Accountæ¨¡å¼**ï¼šè´¦æˆ·ç®¡ç†çš„æ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒé‡‘èè´¦æˆ·ã€ä¼šå‘˜è´¦æˆ·ç­‰å¤šç§è´¦æˆ·ç±»å‹ã€‚

**æ ¸å¿ƒç»„ä»¶**:

- Accountï¼ˆè´¦æˆ·ï¼‰
- Account Typeï¼ˆè´¦æˆ·ç±»å‹ï¼‰
- Account Balanceï¼ˆè´¦æˆ·ä½™é¢ï¼‰
- Transactionï¼ˆäº¤æ˜“ï¼‰

### 5.2 Accountæ¨¡å¼è®¾è®¡

**PostgreSQLå®ç°**:

```sql
-- è´¦æˆ·ç±»å‹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'account_type') THEN
        CREATE TABLE account_type (
            type_id SERIAL PRIMARY KEY,
            type_code VARCHAR(50) UNIQUE NOT NULL,
            type_name VARCHAR(200) NOT NULL,
            description TEXT,
            allows_negative_balance BOOLEAN DEFAULT FALSE,
            interest_rate NUMERIC(5,4) DEFAULT 0
        );
        RAISE NOTICE 'è¡¨ account_type åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ account_type å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ account_type å¤±è´¥: %', SQLERRM;
END $$;

-- è´¦æˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦å…ˆåˆ›å»ºpartyè¡¨ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'account') THEN
        CREATE TABLE account (
            account_id BIGSERIAL PRIMARY KEY,
            account_number VARCHAR(50) UNIQUE NOT NULL,
            -- Partyå…³è”
            party_id INT NOT NULL REFERENCES party(party_id),
            -- è´¦æˆ·ç±»å‹
            account_type_id INT NOT NULL REFERENCES account_type(type_id),
            -- è´¦æˆ·ä¿¡æ¯
            account_name VARCHAR(200),
            currency_code CHAR(3) DEFAULT 'USD',
            -- çŠ¶æ€
            status VARCHAR(50) DEFAULT 'active', -- 'active', 'closed', 'frozen'
            -- æ—¶é—´æˆ³
            opened_date DATE DEFAULT CURRENT_DATE,
            closed_date DATE,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ account åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ account å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¯·å…ˆåˆ›å»º party è¡¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ account å¤±è´¥: %', SQLERRM;
END $$;

-- è´¦æˆ·ä½™é¢è¡¨ï¼ˆå¿«ç…§è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'account_balance') THEN
        CREATE TABLE account_balance (
            balance_id BIGSERIAL PRIMARY KEY,
            account_id BIGINT NOT NULL REFERENCES account(account_id),
            balance_date DATE NOT NULL,
            -- ä½™é¢ä¿¡æ¯
            opening_balance NUMERIC(15,2) NOT NULL DEFAULT 0,
            closing_balance NUMERIC(15,2) NOT NULL DEFAULT 0,
            -- äº¤æ˜“ç»Ÿè®¡
            debit_count INT DEFAULT 0,
            credit_count INT DEFAULT 0,
            total_debits NUMERIC(15,2) DEFAULT 0,
            total_credits NUMERIC(15,2) DEFAULT 0,
            UNIQUE(account_id, balance_date)
        );
        RAISE NOTICE 'è¡¨ account_balance åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨ account_balance å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨ account_balance å¤±è´¥: %', SQLERRM;
END $$;
```

-- äº¤æ˜“è¡¨
CREATE TABLE transaction (
    transaction_id BIGSERIAL PRIMARY KEY,
    transaction_number VARCHAR(50) UNIQUE NOT NULL,
    -- è´¦æˆ·å…³è”
    account_id BIGINT NOT NULL REFERENCES account(account_id),
    -- äº¤æ˜“ä¿¡æ¯
    transaction_type VARCHAR(50) NOT NULL, -- 'debit', 'credit', 'transfer'
    transaction_date TIMESTAMPTZ DEFAULT NOW(),
    amount NUMERIC(15,2) NOT NULL,
    -- ä½™é¢
    balance_after NUMERIC(15,2),
    -- å…³è”ä¿¡æ¯
    related_transaction_id BIGINT REFERENCES transaction(transaction_id),
    related_account_id BIGINT REFERENCES account(account_id),
    -- æè¿°
    description TEXT,
    reference_number VARCHAR(100),
    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'posted', -- 'pending', 'posted', 'cancelled'
    posted_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_transaction_account_date ON transaction(account_id, transaction_date DESC);
CREATE INDEX idx_transaction_type ON transaction(transaction_type, transaction_date DESC);
CREATE INDEX idx_account_balance_date ON account_balance(account_id, balance_date DESC);

```

---

## 6. PostgreSQLå®ç°

### 6.1 æ¨¡å¼ç»„åˆä½¿ç”¨

**ç»¼åˆåº”ç”¨ç¤ºä¾‹**:

```sql
-- ç”µå•†ç³»ç»Ÿï¼šç»„åˆä½¿ç”¨Partyã€Orderã€Productæ¨¡å¼
-- 1. å®¢æˆ·ï¼ˆPartyï¼‰
INSERT INTO person (party_id, party_type, name, first_name, last_name, email)
VALUES (1, 'P', 'John Doe', 'John', 'Doe', 'john@example.com');

INSERT INTO party_role (party_id, role_type, role_name, is_primary)
VALUES (1, 'customer', 'Customer', TRUE);

-- 2. äº§å“ï¼ˆProductï¼‰
INSERT INTO product (product_code, product_name, category_id, status)
VALUES ('PROD001', 'Laptop Computer', 1, 'active');

INSERT INTO product_price (product_id, price_type, price_amount)
VALUES (1, 'list', 999.99);

-- 3. è®¢å•ï¼ˆOrderï¼‰
INSERT INTO order_header (order_number, customer_party_id, order_status, subtotal)
VALUES ('ORD001', 1, 'pending', 999.99);

INSERT INTO order_line (order_id, line_number, product_id, quantity, unit_price)
VALUES (1, 1, 1, 1, 999.99);

-- 4. è´¦æˆ·ï¼ˆAccountï¼‰- å¦‚æœæ”¯æŒè´¦æˆ·ä½™é¢
INSERT INTO account (account_number, party_id, account_type_id, account_name)
VALUES ('ACC001', 1, 1, 'Customer Account');
```

### 6.2 æ¨¡å¼æŸ¥è¯¢è§†å›¾

**å¸¸ç”¨æŸ¥è¯¢è§†å›¾**:

```sql
-- å®¢æˆ·è®¢å•è§†å›¾
CREATE VIEW customer_order_view AS
SELECT
    p.party_id,
    p.name AS customer_name,
    o.order_id,
    o.order_number,
    o.order_date,
    o.total_amount,
    o.order_status,
    COUNT(ol.line_id) AS line_count
FROM party p
JOIN party_role pr ON p.party_id = pr.party_id AND pr.role_type = 'customer'
JOIN order_header o ON p.party_id = o.customer_party_id
LEFT JOIN order_line ol ON o.order_id = ol.order_id
GROUP BY p.party_id, p.name, o.order_id, o.order_number, o.order_date, o.total_amount, o.order_status;

-- äº§å“é”€å”®ç»Ÿè®¡è§†å›¾
CREATE VIEW product_sales_view AS
SELECT
    p.product_id,
    p.product_code,
    p.product_name,
    SUM(ol.quantity) AS total_quantity_sold,
    SUM(ol.line_total) AS total_revenue,
    COUNT(DISTINCT ol.order_id) AS order_count
FROM product p
JOIN order_line ol ON p.product_id = ol.product_id
JOIN order_header o ON ol.order_id = o.order_id
WHERE o.order_status = 'completed'
GROUP BY p.product_id, p.product_code, p.product_name;
```

---

## 7. æ¨¡å¼åº”ç”¨æ¡ˆä¾‹ / Pattern Application Examples

### 7.1 æ¡ˆä¾‹1: CRMç³»ç»Ÿï¼ˆPartyæ¨¡å¼ï¼‰

**CRMç³»ç»Ÿå®Œæ•´å®ç°**:

```sql
-- CRMç³»ç»Ÿï¼šä½¿ç”¨Partyæ¨¡å¼ç»Ÿä¸€ç®¡ç†å®¢æˆ·ã€è”ç³»äººã€ä¾›åº”å•†
CREATE TABLE party (
    party_id BIGSERIAL PRIMARY KEY,
    party_type CHAR(1) NOT NULL CHECK (party_type IN ('P', 'O')),
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY LIST (party_type);

CREATE TABLE party_person PARTITION OF party FOR VALUES IN ('P');
CREATE TABLE party_organization PARTITION OF party FOR VALUES IN ('O');

-- å®¢æˆ·è§’è‰²
CREATE TABLE party_role (
    party_role_id BIGSERIAL PRIMARY KEY,
    party_id BIGINT NOT NULL REFERENCES party(party_id),
    role_type VARCHAR(50) NOT NULL,
    valid_from TIMESTAMPTZ DEFAULT NOW(),
    valid_to TIMESTAMPTZ,
    UNIQUE(party_id, role_type, valid_from)
);

-- å®¢æˆ·è”ç³»ä¿¡æ¯
CREATE TABLE contact_mechanism (
    contact_id BIGSERIAL PRIMARY KEY,
    party_id BIGINT NOT NULL REFERENCES party(party_id),
    contact_type VARCHAR(50) NOT NULL, -- 'email', 'phone', 'address'
    contact_value TEXT NOT NULL,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- CRMä¸šåŠ¡è¡¨
CREATE TABLE opportunity (
    opportunity_id BIGSERIAL PRIMARY KEY,
    customer_party_id BIGINT NOT NULL REFERENCES party(party_id),
    title VARCHAR(200) NOT NULL,
    amount NUMERIC(10,2),
    stage VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŸ¥è¯¢ï¼šè·å–æ‰€æœ‰å®¢æˆ·åŠå…¶è”ç³»ä¿¡æ¯
SELECT
    p.party_id,
    p.name,
    pr.role_type,
    cm.contact_type,
    cm.contact_value
FROM party p
JOIN party_role pr ON p.party_id = pr.party_id
LEFT JOIN contact_mechanism cm ON p.party_id = cm.party_id AND cm.is_primary = TRUE
WHERE pr.role_type = 'customer'
  AND (pr.valid_to IS NULL OR pr.valid_to > NOW());
```

### 7.2 æ¡ˆä¾‹2: ç”µå•†ç³»ç»Ÿï¼ˆParty+Order+Productæ¨¡å¼ï¼‰

**ç”µå•†ç³»ç»Ÿå®Œæ•´å®ç°**:

```sql
-- ç”µå•†ç³»ç»Ÿï¼šç»„åˆä½¿ç”¨Partyã€Orderã€Productæ¨¡å¼
-- Partyæ¨¡å¼ï¼šç®¡ç†ç”¨æˆ·å’Œå•†å®¶
CREATE TABLE ecommerce_party (
    party_id BIGSERIAL PRIMARY KEY,
    party_type CHAR(1) NOT NULL CHECK (party_type IN ('P', 'O')),
    name TEXT NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Productæ¨¡å¼ï¼šå•†å“ç®¡ç†
CREATE TABLE product (
    product_id BIGSERIAL PRIMARY KEY,
    product_code VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    description TEXT,
    category_id INT,
    price NUMERIC(10,2) NOT NULL,
    stock_quantity INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Orderæ¨¡å¼ï¼šè®¢å•ç®¡ç†
CREATE TABLE ecommerce_order (
    order_id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    customer_party_id BIGINT NOT NULL REFERENCES ecommerce_party(party_id),
    seller_party_id BIGINT REFERENCES ecommerce_party(party_id),
    order_date TIMESTAMPTZ DEFAULT NOW(),
    total_amount NUMERIC(10,2) NOT NULL,
    order_status VARCHAR(20) DEFAULT 'pending',
    shipping_address JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE order_item (
    item_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES ecommerce_order(order_id),
    product_id BIGINT NOT NULL REFERENCES product(product_id),
    quantity INT NOT NULL CHECK (quantity > 0),
    unit_price NUMERIC(10,2) NOT NULL,
    line_total NUMERIC(10,2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŸ¥è¯¢ï¼šè·å–å®¢æˆ·è®¢å•ç»Ÿè®¡
SELECT
    p.party_id,
    p.name,
    COUNT(DISTINCT o.order_id) AS order_count,
    SUM(o.total_amount) AS total_spent,
    AVG(o.total_amount) AS avg_order_amount
FROM ecommerce_party p
JOIN ecommerce_order o ON p.party_id = o.customer_party_id
WHERE o.order_status = 'completed'
GROUP BY p.party_id, p.name
ORDER BY total_spent DESC;
```

### 7.3 æ¡ˆä¾‹3: é“¶è¡Œç³»ç»Ÿï¼ˆAccountæ¨¡å¼ï¼‰

**é“¶è¡Œç³»ç»Ÿå®Œæ•´å®ç°**:

```sql
-- é“¶è¡Œç³»ç»Ÿï¼šä½¿ç”¨Accountæ¨¡å¼ç®¡ç†è´¦æˆ·
CREATE TABLE bank_party (
    party_id BIGSERIAL PRIMARY KEY,
    party_type CHAR(1) NOT NULL CHECK (party_type IN ('P', 'O')),
    name TEXT NOT NULL,
    id_number VARCHAR(50) UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Accountæ¨¡å¼ï¼šè´¦æˆ·ç®¡ç†
CREATE TABLE account (
    account_id BIGSERIAL PRIMARY KEY,
    account_number VARCHAR(50) UNIQUE NOT NULL,
    party_id BIGINT NOT NULL REFERENCES bank_party(party_id),
    account_type VARCHAR(50) NOT NULL, -- 'savings', 'checking', 'credit'
    balance NUMERIC(15,2) NOT NULL DEFAULT 0,
    currency VARCHAR(3) DEFAULT 'CNY',
    status VARCHAR(20) DEFAULT 'active',
    opened_date DATE DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è´¦æˆ·äº¤æ˜“
CREATE TABLE account_transaction (
    transaction_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES account(account_id),
    transaction_type VARCHAR(20) NOT NULL, -- 'deposit', 'withdrawal', 'transfer'
    amount NUMERIC(15,2) NOT NULL,
    balance_after NUMERIC(15,2) NOT NULL,
    transaction_date TIMESTAMPTZ DEFAULT NOW(),
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŸ¥è¯¢ï¼šè·å–è´¦æˆ·ä½™é¢å’Œäº¤æ˜“å†å²
SELECT
    a.account_number,
    p.name AS account_holder,
    a.account_type,
    a.balance,
    COUNT(at.transaction_id) AS transaction_count,
    MAX(at.transaction_date) AS last_transaction_date
FROM account a
JOIN bank_party p ON a.party_id = p.party_id
LEFT JOIN account_transaction at ON a.account_id = at.account_id
WHERE a.status = 'active'
GROUP BY a.account_id, a.account_number, p.name, a.account_type, a.balance;
```

---

## 8. å¸¸è§é—®é¢˜è§£ç­” / FAQ

### Q1: ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨Partyæ¨¡å¼ï¼Ÿ

**A**: Partyæ¨¡å¼é€‚ç”¨åœºæ™¯ï¼š

- âœ… **ç»Ÿä¸€ç®¡ç†**: éœ€è¦ç»Ÿä¸€ç®¡ç†äººå‘˜å’Œç»„ç»‡
- âœ… **è§’è‰²å¤æ‚**: å®ä½“å¯èƒ½æ‰®æ¼”å¤šä¸ªè§’è‰²
- âœ… **å…³ç³»å¤æ‚**: å®ä½“ä¹‹é—´å­˜åœ¨å¤æ‚å…³ç³»
- âœ… **æ‰©å±•éœ€æ±‚**: æœªæ¥å¯èƒ½æ·»åŠ æ–°çš„å®ä½“ç±»å‹

**ä¸é€‚ç”¨åœºæ™¯**:

- âŒ **ç®€å•åœºæ™¯**: åªæœ‰å•ä¸€ç±»å‹çš„å®ä½“ï¼ˆå¦‚åªæœ‰ç”¨æˆ·ï¼‰
- âŒ **æ€§èƒ½æ•æ„Ÿ**: éœ€è¦æè‡´æŸ¥è¯¢æ€§èƒ½çš„åœºæ™¯
- âŒ **ç»“æ„å›ºå®š**: å®ä½“ç»“æ„éå¸¸å›ºå®šï¼Œä¸ä¼šå˜åŒ–

### Q2: Orderæ¨¡å¼å’ŒAccountæ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**: åŒºåˆ«å¯¹æ¯”ï¼š

| ç‰¹æ€§ | Orderæ¨¡å¼ | Accountæ¨¡å¼ |
|------|-----------|-------------|
| ç”¨é€” | ç®¡ç†è®¢å•å’Œäº¤æ˜“ | ç®¡ç†è´¦æˆ·å’Œä½™é¢ |
| æ ¸å¿ƒå®ä½“ | Orderï¼ˆè®¢å•ï¼‰ | Accountï¼ˆè´¦æˆ·ï¼‰ |
| çŠ¶æ€ç®¡ç† | è®¢å•çŠ¶æ€æµè½¬ | è´¦æˆ·ä½™é¢å˜åŒ– |
| é€‚ç”¨åœºæ™¯ | ç”µå•†ã€é›¶å”® | é“¶è¡Œã€é‡‘è |

**é€‰æ‹©åŸåˆ™**:

- éœ€è¦ç®¡ç†è®¢å•æµç¨‹ â†’ ä½¿ç”¨Orderæ¨¡å¼
- éœ€è¦ç®¡ç†è´¦æˆ·ä½™é¢ â†’ ä½¿ç”¨Accountæ¨¡å¼

### Q3: å¦‚ä½•ç»„åˆä½¿ç”¨å¤šä¸ªæ¨¡å¼ï¼Ÿ

**A**: æ¨¡å¼ç»„åˆç­–ç•¥ï¼š

```sql
-- ç¤ºä¾‹ï¼šç”µå•†ç³»ç»Ÿç»„åˆParty+Order+Productæ¨¡å¼
-- 1. Partyæ¨¡å¼ï¼šç®¡ç†ç”¨æˆ·å’Œå•†å®¶
CREATE TABLE party (...);

-- 2. Productæ¨¡å¼ï¼šç®¡ç†å•†å“
CREATE TABLE product (...);

-- 3. Orderæ¨¡å¼ï¼šç®¡ç†è®¢å•ï¼ˆå¼•ç”¨Partyå’ŒProductï¼‰
CREATE TABLE order_header (
    order_id BIGSERIAL PRIMARY KEY,
    customer_party_id BIGINT REFERENCES party(party_id),  -- å¼•ç”¨Party
    ...
);

CREATE TABLE order_line (
    line_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES order_header(order_id),
    product_id BIGINT REFERENCES product(product_id),  -- å¼•ç”¨Product
    ...
);
```

### Q4: æ¨¡å¼è®¾è®¡å¦‚ä½•å¹³è¡¡çµæ´»æ€§å’Œæ€§èƒ½ï¼Ÿ

**A**: å¹³è¡¡ç­–ç•¥ï¼š

1. **æ ¸å¿ƒè¡¨è§„èŒƒåŒ–**: ä¿æŒæ ¸å¿ƒè¡¨è§„èŒƒåŒ–
2. **æ‰©å±•è¡¨çµæ´»åŒ–**: ä½¿ç”¨JSONBå­˜å‚¨æ‰©å±•ä¿¡æ¯
3. **æŸ¥è¯¢ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•å’Œè§†å›¾
4. **ç‰©åŒ–è§†å›¾**: é¢„è®¡ç®—å¤æ‚æŸ¥è¯¢ç»“æœ

```sql
-- ç¤ºä¾‹ï¼šå¹³è¡¡çµæ´»æ€§å’Œæ€§èƒ½
-- æ ¸å¿ƒè¡¨ï¼šè§„èŒƒåŒ–è®¾è®¡
CREATE TABLE party (
    party_id BIGSERIAL PRIMARY KEY,
    party_type CHAR(1) NOT NULL,
    name TEXT NOT NULL
);

-- æ‰©å±•è¡¨ï¼šçµæ´»è®¾è®¡
CREATE TABLE party_extension (
    party_id BIGINT PRIMARY KEY REFERENCES party(party_id),
    custom_attributes JSONB,  -- çµæ´»å­˜å‚¨
    metadata JSONB
);

-- æŸ¥è¯¢è§†å›¾ï¼šä¼˜åŒ–æŸ¥è¯¢
CREATE MATERIALIZED VIEW party_summary AS
SELECT
    p.party_id,
    p.name,
    jsonb_object_keys(pe.custom_attributes) AS attribute_keys
FROM party p
LEFT JOIN party_extension pe ON p.party_id = pe.party_id;
```

### Q5: å¦‚ä½•è¿ç§»ç°æœ‰ç³»ç»Ÿåˆ°æ ‡å‡†æ¨¡å¼ï¼Ÿ

**A**: è¿ç§»ç­–ç•¥ï¼š

1. **åˆ†æç°æœ‰ç»“æ„**: è¯†åˆ«ç°æœ‰è¡¨ç»“æ„
2. **æ˜ å°„åˆ°æ¨¡å¼**: å°†ç°æœ‰è¡¨æ˜ å°„åˆ°æ ‡å‡†æ¨¡å¼
3. **é€æ­¥è¿ç§»**: åˆ†é˜¶æ®µè¿ç§»æ•°æ®
4. **åŒå†™éªŒè¯**: æ–°æ—§ç³»ç»Ÿå¹¶è¡Œè¿è¡ŒéªŒè¯

```sql
-- è¿ç§»ç¤ºä¾‹ï¼šå°†ç”¨æˆ·è¡¨è¿ç§»åˆ°Partyæ¨¡å¼
-- æ­¥éª¤1ï¼šåˆ›å»ºPartyè¡¨
CREATE TABLE party_new (
    party_id BIGSERIAL PRIMARY KEY,
    party_type CHAR(1) DEFAULT 'P',
    name TEXT NOT NULL
);

-- æ­¥éª¤2ï¼šè¿ç§»æ•°æ®
INSERT INTO party_new (party_id, name)
-- æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT user_id, username FROM users;

-- æ­¥éª¤3ï¼šåˆ›å»ºæ˜ å°„è¡¨
CREATE TABLE user_party_mapping (
    old_user_id BIGINT PRIMARY KEY,
    new_party_id BIGINT REFERENCES party_new(party_id)
);

-- æ­¥éª¤4ï¼šæ›´æ–°å¤–é”®å¼•ç”¨
UPDATE orders o
SET customer_id = (
    SELECT new_party_id FROM user_party_mapping
    WHERE old_user_id = o.customer_id
);
```

---

## 8. ç›¸å…³èµ„æº / Related Resources

### 8.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£ / Core Related Documents

- [Partyæ¨¡å‹](../04-OLTPå»ºæ¨¡/Partyæ¨¡å‹.md) - Partyæ¨¡å‹è¯¦ç»†è¯´æ˜
- [è®¢å•ç®¡ç†æ¨¡å‹](../04-OLTPå»ºæ¨¡/è®¢å•ç®¡ç†æ¨¡å‹.md) - è®¢å•æ¨¡å‹è¯¦ç»†è¯´æ˜
- [èŒƒå¼åŒ–è®¾è®¡](../04-OLTPå»ºæ¨¡/èŒƒå¼åŒ–è®¾è®¡.md) - OLTPèŒƒå¼åŒ–è®¾è®¡
- [å»ºæ¨¡åæ¨¡å¼](./å»ºæ¨¡åæ¨¡å¼.md) - åæ¨¡å¼è¯†åˆ«
- [çº¦æŸè®¾è®¡](../08-PostgreSQLå»ºæ¨¡å®è·µ/çº¦æŸè®¾è®¡.md) - æ¨¡å¼çº¦æŸè®¾è®¡

### 8.2 ç†è®ºåŸºç¡€ / Theoretical Foundation

- [Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ](../02-æƒå¨èµ„æºä¸æ ‡å‡†/Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ.md) - æƒå¨èµ„æº
- [èŒƒå¼ç†è®º](../01-æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€/èŒƒå¼ç†è®º.md) - æ•°æ®åº“èŒƒå¼ç†è®º
- [ERæ¨¡å‹](../01-æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€/ERæ¨¡å‹.md) - å®ä½“-å…³ç³»æ¨¡å‹

### 8.3 å®è·µæŒ‡å— / Practical Guides

- [æ¨¡å¼åº”ç”¨æ¡ˆä¾‹](#7-æ¨¡å¼åº”ç”¨æ¡ˆä¾‹--pattern-application-examples) - æœ¬æ–‡æ¡£çš„åº”ç”¨æ¡ˆä¾‹ç« èŠ‚
- [æ€§èƒ½ä¼˜åŒ–](../08-PostgreSQLå»ºæ¨¡å®è·µ/æ€§èƒ½ä¼˜åŒ–.md) - æ¨¡å¼æ€§èƒ½ä¼˜åŒ–

### 8.4 åº”ç”¨æ¡ˆä¾‹ / Application Cases

- [ç”µå•†æ•°æ®æ¨¡å‹æ¡ˆä¾‹](../10-ç»¼åˆåº”ç”¨æ¡ˆä¾‹/ç”µå•†æ•°æ®æ¨¡å‹æ¡ˆä¾‹.md) - ç”µå•†å»ºæ¨¡æ¨¡å¼åº”ç”¨
- [é‡‘èæ•°æ®æ¨¡å‹æ¡ˆä¾‹](../10-ç»¼åˆåº”ç”¨æ¡ˆä¾‹/é‡‘èæ•°æ®æ¨¡å‹æ¡ˆä¾‹.md) - é‡‘èå»ºæ¨¡æ¨¡å¼åº”ç”¨

### 8.5 å‚è€ƒèµ„æº / Reference Resources

- [æƒå¨èµ„æºç´¢å¼•](../00-å¯¼èˆªä¸ç´¢å¼•/æƒå¨èµ„æºç´¢å¼•.md) - æƒå¨èµ„æºåˆ—è¡¨
- [æœ¯è¯­å¯¹ç…§è¡¨](../00-å¯¼èˆªä¸ç´¢å¼•/æœ¯è¯­å¯¹ç…§è¡¨.md) - æœ¯è¯­å¯¹ç…§
- [å¿«é€ŸæŸ¥æ‰¾æŒ‡å—](../00-å¯¼èˆªä¸ç´¢å¼•/å¿«é€ŸæŸ¥æ‰¾æŒ‡å—.md) - å¿«é€ŸæŸ¥æ‰¾å·¥å…·

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
