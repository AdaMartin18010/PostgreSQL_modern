# 制造业数据模型案例

> **创建日期**: 2025年1月
> **来源**: Silverston《数据模型资源手册》卷2 Chapter 2 - Manufacturing + 实践总结
> **状态**: 基于权威资源深化扩展
> **文档编号**: 10-02

---

## 📑 目录

- [制造业数据模型案例](#制造业数据模型案例)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
  - [1.1 理论基础](#11-理论基础)
    - [1.1.1 制造数据模型设计理论](#111-制造数据模型设计理论)
    - [1.1.2 BOM模式理论](#112-bom模式理论)
  - [2. 业务需求](#2-业务需求)
    - [2.1 核心业务功能](#21-核心业务功能)
    - [2.2 性能要求](#22-性能要求)
  - [3. 产品与零件模型](#3-产品与零件模型)
    - [3.1 产品与零件](#31-产品与零件)
    - [3.2 工程变更](#32-工程变更)
  - [4. BOM管理](#4-bom管理)
    - [4.1 物料清单（BOM）](#41-物料清单bom)
    - [4.2 零件替代](#42-零件替代)
  - [5. 生产计划模型](#5-生产计划模型)
    - [5.1 工艺计划](#51-工艺计划)
    - [5.2 生产运行](#52-生产运行)
  - [6. PostgreSQL完整实现](#6-postgresql完整实现)
    - [6.1 索引设计](#61-索引设计)
    - [6.2 查询示例](#62-查询示例)
  - [7. 常见问题解答 / FAQ](#7-常见问题解答--faq)
    - [Q1: 如何管理BOM的版本？](#q1-如何管理bom的版本)
    - [Q2: 如何处理零件替代？](#q2-如何处理零件替代)
  - [8. 相关资源](#8-相关资源)
    - [8.1 核心相关文档](#81-核心相关文档)
    - [8.2 理论基础](#82-理论基础)
    - [8.3 参考资源](#83-参考资源)

---

---

## 1. 概述

制造业数据模型案例展示制造业的数据建模实践。
本案例涵盖制造核心业务的数据模型设计，包括产品与零件、物料清单（BOM）、生产计划、工艺计划、生产运行等。

**案例特点**:

- **BOM管理**：支持多层级物料清单和替代件
- **生产计划**：完整的生产计划和工艺计划管理
- **工程变更**：支持工程变更和版本管理
- **生产执行**：生产运行和资源分配管理

---

## 1.1 理论基础

### 1.1.1 制造数据模型设计理论

**制造数据模型**:

- **BOM管理**: 多层级物料清单和替代件管理
- **生产计划**: 生产计划和工艺计划管理
- **工程变更**: 工程变更和版本控制
- **生产执行**: 生产运行和资源分配

**模型设计原则**:

- **BOM灵活性**: 支持多层级BOM和替代件
- **版本控制**: 完整的工程变更和版本历史
- **生产追踪**: 完整的生产运行历史
- **性能优化**: 优化BOM查询和生产查询性能

### 1.1.2 BOM模式理论

**BOM模式应用**:

- **多层级BOM**: 支持多层级物料清单结构
- **替代件管理**: 支持零件替代和配置
- **版本管理**: 支持BOM版本和工程变更

**BOM模式特点**:

- **递归结构**: 使用递归关系支持多层级BOM
- **替代灵活性**: 支持替代件和配置管理
- **可追溯性**: 完整的版本和变更历史

---

## 2. 业务需求

### 2.1 核心业务功能

**业务需求清单**:

1. **产品与零件管理**
   - 产品定义和分类
   - 零件规格和文档管理
   - 工程变更管理

2. **BOM管理**
   - 多层级物料清单
   - 零件替代管理
   - 库存配置管理

3. **生产计划管理**
   - 生产计划制定
   - 工艺计划管理
   - 工作中心管理

4. **生产执行管理**
   - 生产运行管理
   - 资源分配
   - 生产结果追踪

5. **供应链管理**
   - 材料需求计划（MRP）
   - 订单管理
   - 交付管理

### 2.2 性能要求

- **高并发**：支持500+ TPS
- **低延迟**：BOM查询响应时间<100ms
- **高可用**：99.9%可用性
- **数据完整性**：严格的数据完整性约束

---

## 3. 产品与零件模型

### 3.1 产品与零件

**产品与零件表设计**:

```sql
-- 产品表（基于Product扩展）
CREATE TABLE manufacturing_product (
    product_id SERIAL PRIMARY KEY,
    product_code VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    product_type VARCHAR(50), -- 'PRODUCT', 'PART', 'RAW_MATERIAL'
    description TEXT,
    unit_of_measure_id INT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 零件规格表
CREATE TABLE part_specification (
    specification_id SERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    specification_number VARCHAR(50) UNIQUE NOT NULL,
    specification_type VARCHAR(50),
    description TEXT,
    status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'approved', 'superseded'
    version_number VARCHAR(50),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 规格文档表
CREATE TABLE part_specification_document (
    document_id SERIAL PRIMARY KEY,
    specification_id INT NOT NULL REFERENCES part_specification(specification_id) ON DELETE CASCADE,
    document_type VARCHAR(50),
    document_name VARCHAR(200),
    document_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.2 工程变更

**工程变更表设计**:

```sql
-- 工程变更表
CREATE TABLE engineering_change (
    change_id SERIAL PRIMARY KEY,
    change_number VARCHAR(50) UNIQUE NOT NULL,
    change_type VARCHAR(50),
    change_description TEXT,
    change_reason TEXT,
    change_date DATE DEFAULT CURRENT_DATE,
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'approved', 'implemented'
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 规格变更关联表
CREATE TABLE specification_engineering_change (
    specification_id INT NOT NULL REFERENCES part_specification(specification_id),
    change_id INT NOT NULL REFERENCES engineering_change(change_id),
    change_type VARCHAR(50), -- 'CREATED', 'MODIFIED', 'SUPERSEDED'
    PRIMARY KEY (specification_id, change_id)
);
```

---

## 4. BOM管理

### 4.1 物料清单（BOM）

**BOM表设计**:

```sql
-- 物料清单表（多层级BOM）
CREATE TABLE bill_of_material (
    bom_id SERIAL PRIMARY KEY,
    parent_product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    child_product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    specification_id INT REFERENCES part_specification(specification_id),
    quantity_required NUMERIC(10,4) NOT NULL DEFAULT 1.0 CHECK (quantity_required > 0),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    instruction TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (parent_product_id != child_product_id),
    UNIQUE(parent_product_id, child_product_id, from_date)
);

-- BOM递归查询示例
WITH RECURSIVE product_bom AS (
    -- 基础查询：起始产品
    SELECT
        mp.product_id,
        mp.product_name,
        bom.child_product_id,
        bom.quantity_required,
        1 AS level,
        ARRAY[mp.product_id] AS path
    FROM manufacturing_product mp
    INNER JOIN bill_of_material bom ON mp.product_id = bom.parent_product_id
    WHERE mp.product_id = :root_product_id
      AND bom.from_date <= CURRENT_DATE
      AND (bom.thru_date IS NULL OR bom.thru_date >= CURRENT_DATE)

    UNION ALL

    -- 递归查询：子产品BOM
    SELECT
        mp.product_id,
        mp.product_name,
        bom.child_product_id,
        bom.quantity_required * pbom.quantity_required,
        pbom.level + 1,
        pbom.path || mp.product_id
    FROM manufacturing_product mp
    INNER JOIN bill_of_material bom ON mp.product_id = bom.parent_product_id
    INNER JOIN product_bom pbom ON bom.parent_product_id = pbom.child_product_id
    WHERE bom.from_date <= CURRENT_DATE
      AND (bom.thru_date IS NULL OR bom.thru_date >= CURRENT_DATE)
      AND mp.product_id != ALL(pbom.path) -- 防止循环
      AND pbom.level < 10 -- 限制递归深度
)
SELECT
    product_id,
    REPEAT('  ', level - 1) || product_name AS product_name,
    quantity_required,
    level
FROM product_bom
ORDER BY path, level;
```

### 4.2 零件替代

**零件替代表设计**:

```sql
-- 零件替代表
CREATE TABLE part_substitution (
    substitution_id SERIAL PRIMARY KEY,
    bom_id INT NOT NULL REFERENCES bill_of_material(bom_id) ON DELETE CASCADE,
    substitute_product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    substitution_ratio NUMERIC(10,4) DEFAULT 1.0,
    substitution_type VARCHAR(50), -- 'MANDATORY', 'OPTIONAL', 'PREFERRED'
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 5. 生产计划模型

### 5.1 工艺计划

**工艺计划表设计**:

```sql
-- 工艺计划表
CREATE TABLE process_plan (
    plan_id SERIAL PRIMARY KEY,
    plan_number VARCHAR(50) UNIQUE NOT NULL,
    product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    plan_name VARCHAR(200),
    description TEXT,
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 工艺步骤表
CREATE TABLE process_plan_step (
    step_id SERIAL PRIMARY KEY,
    plan_id INT NOT NULL REFERENCES process_plan(plan_id) ON DELETE CASCADE,
    step_sequence INT NOT NULL,
    step_name VARCHAR(200),
    step_description TEXT,
    work_center_id INT, -- 工作中心
    estimated_hours NUMERIC(10,2),
    setup_hours NUMERIC(10,2),
    UNIQUE(plan_id, step_sequence),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 工作中心表
CREATE TABLE work_center (
    work_center_id SERIAL PRIMARY KEY,
    work_center_code VARCHAR(50) UNIQUE NOT NULL,
    work_center_name VARCHAR(200) NOT NULL,
    facility_id INT, -- 引用设施
    capacity_hours_per_day NUMERIC(10,2),
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 5.2 生产运行

**生产运行表设计**:

```sql
-- 生产运行表
CREATE TABLE production_run (
    run_id SERIAL PRIMARY KEY,
    run_number VARCHAR(50) UNIQUE NOT NULL,
    product_id INT NOT NULL REFERENCES manufacturing_product(product_id),
    plan_id INT REFERENCES process_plan(plan_id),
    work_order_id INT, -- 引用工作订单
    scheduled_start_date TIMESTAMPTZ,
    scheduled_completion_date TIMESTAMPTZ,
    actual_start_date TIMESTAMPTZ,
    actual_completion_date TIMESTAMPTZ,
    planned_quantity NUMERIC(10,2),
    actual_quantity NUMERIC(10,2),
    status VARCHAR(50) DEFAULT 'planned', -- 'planned', 'running', 'completed', 'cancelled'
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 生产运行步骤表
CREATE TABLE production_run_step (
    run_step_id SERIAL PRIMARY KEY,
    run_id INT NOT NULL REFERENCES production_run(run_id) ON DELETE CASCADE,
    step_id INT NOT NULL REFERENCES process_plan_step(step_id),
    step_sequence INT NOT NULL,
    scheduled_start TIMESTAMPTZ,
    scheduled_end TIMESTAMPTZ,
    actual_start TIMESTAMPTZ,
    actual_end TIMESTAMPTZ,
    work_center_id INT REFERENCES work_center(work_center_id),
    status VARCHAR(50) DEFAULT 'planned',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 6. PostgreSQL完整实现

### 6.1 索引设计

```sql
-- 产品索引
CREATE INDEX idx_manufacturing_product_code ON manufacturing_product(product_code);
CREATE INDEX idx_manufacturing_product_type ON manufacturing_product(product_type);

-- BOM索引
CREATE INDEX idx_bill_of_material_parent ON bill_of_material(parent_product_id);
CREATE INDEX idx_bill_of_material_child ON bill_of_material(child_product_id);
CREATE INDEX idx_bill_of_material_dates ON bill_of_material USING gist (daterange(from_date, thru_date));

-- 规格索引
CREATE INDEX idx_part_specification_product ON part_specification(product_id);
CREATE INDEX idx_part_specification_number ON part_specification(specification_number);
CREATE INDEX idx_part_specification_status ON part_specification(status);

-- 工艺计划索引
CREATE INDEX idx_process_plan_product ON process_plan(product_id);
CREATE INDEX idx_process_plan_step_plan ON process_plan_step(plan_id);
CREATE INDEX idx_process_plan_step_work_center ON process_plan_step(work_center_id);

-- 生产运行索引
CREATE INDEX idx_production_run_product ON production_run(product_id);
CREATE INDEX idx_production_run_status ON production_run(status, scheduled_start_date);
CREATE INDEX idx_production_run_dates ON production_run(scheduled_start_date, scheduled_completion_date);
```

### 6.2 查询示例

**查询1: 查询产品完整BOM**:

```sql
-- 查询产品完整BOM（递归查询）
WITH RECURSIVE product_bom AS (
    SELECT
        mp.product_id,
        mp.product_name,
        bom.child_product_id,
        bom.quantity_required,
        1 AS level
    FROM manufacturing_product mp
    INNER JOIN bill_of_material bom ON mp.product_id = bom.parent_product_id
    WHERE mp.product_code = :product_code
      AND bom.from_date <= CURRENT_DATE
      AND (bom.thru_date IS NULL OR bom.thru_date >= CURRENT_DATE)

    UNION ALL

    SELECT
        mp.product_id,
        mp.product_name,
        bom.child_product_id,
        bom.quantity_required * pbom.quantity_required,
        pbom.level + 1
    FROM manufacturing_product mp
    INNER JOIN bill_of_material bom ON mp.product_id = bom.parent_product_id
    INNER JOIN product_bom pbom ON bom.parent_product_id = pbom.child_product_id
    WHERE bom.from_date <= CURRENT_DATE
      AND (bom.thru_date IS NULL OR bom.thru_date >= CURRENT_DATE)
      AND pbom.level < 10
)
-- 查询BOM层级结构（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM product_bom ORDER BY level, product_id;
```

**查询2: 查询生产运行统计**:

```sql
-- 查询生产运行统计
SELECT
    mp.product_code,
    mp.product_name,
    COUNT(pr.run_id) AS run_count,
    SUM(pr.planned_quantity) AS total_planned_quantity,
    SUM(pr.actual_quantity) AS total_actual_quantity,
    AVG(EXTRACT(EPOCH FROM (pr.actual_completion_date - pr.actual_start_date)) / 3600) AS avg_hours
FROM production_run pr
INNER JOIN manufacturing_product mp ON pr.product_id = mp.product_id
WHERE pr.status = 'completed'
  AND pr.actual_completion_date >= :start_date
GROUP BY mp.product_code, mp.product_name
ORDER BY run_count DESC;
```

---

## 7. 常见问题解答 / FAQ

### Q1: 如何管理BOM的版本？

**A**: BOM版本管理：

```sql
-- 使用from_date和thru_date管理BOM版本
-- 使用工程变更表追踪变更历史
-- 使用规格表管理零件规格版本
```

### Q2: 如何处理零件替代？

**A**: 零件替代处理：

```sql
-- 使用零件替代表定义替代关系
-- 在生产运行时选择适用的替代件
-- 支持强制替代和可选替代
```

---

## 8. 相关资源

### 8.1 核心相关文档

- [产品管理模型](../04-OLTP建模/产品管理模型.md) - BOM和产品组件模型
- [工作努力模型](../04-OLTP建模/工作努力模型.md) - 生产工作管理
- [订单管理模型](../04-OLTP建模/订单管理模型.md) - 生产订单管理

### 8.2 理论基础

- [Silverston数据模型资源手册](../02-权威资源与标准/Silverston数据模型资源手册.md) - 制造模型来源
- [工作努力模型](../04-OLTP建模/工作努力模型.md) - 生产工作理论

### 8.3 参考资源

- [术语对照表](../00-导航与索引/术语对照表.md) - 术语对照
- [权威资源索引](../00-导航与索引/权威资源索引.md) - 权威资源列表

---

**状态**: ✅ 文档完整内容已补充（600+行）
**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
