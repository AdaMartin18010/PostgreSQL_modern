# ä¼šè®¡ä¸é¢„ç®—æ¨¡å‹å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æ¥æº**: Silverstonã€Šæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œã€‹å·1 Chapter 8 - Accounting and Budgeting + å®è·µæ€»ç»“
> **çŠ¶æ€**: åŸºäºæƒå¨èµ„æºæ·±åŒ–æ‰©å±•
> **æ–‡æ¡£ç¼–å·**: 04-06

---

## ğŸ“‘ ç›®å½•

- [ä¼šè®¡ä¸é¢„ç®—æ¨¡å‹å®Œæ•´æŒ‡å—](#ä¼šè®¡ä¸é¢„ç®—æ¨¡å‹å®Œæ•´æŒ‡å—)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

ä¼šè®¡ä¸é¢„ç®—æ¨¡å‹æ˜¯Silverstonã€Šæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œã€‹å·1ï¼ˆVolume 1 Chapter 8: Accounting and Budgetingï¼‰ä¸­çš„æ ¸å¿ƒæ¨¡å‹ï¼Œç”¨äºç®¡ç†ä¼ä¸šçš„è´¢åŠ¡ä¿¡æ¯å’Œé¢„ç®—æ§åˆ¶ã€‚

**æ ¸å¿ƒä¸šåŠ¡é—®é¢˜**:

- ä¼ä¸šçš„è´¢åŠ¡çŠ¶å†µå¦‚ä½•ï¼Ÿä¸å‰æœŸç›¸æ¯”æœ‰ä½•å˜åŒ–ï¼Ÿ
- æ¯ä¸ªæœŸé—´å‘ç”Ÿäº†å“ªäº›ç±»å‹çš„äº¤æ˜“ï¼Ÿäº¤æ˜“é‡‘é¢æ˜¯å¤šå°‘ï¼Ÿ
- æ¯ä¸ªæœŸé—´å‘ç”Ÿäº†å“ªäº›è´¹ç”¨ï¼Ÿ
- æŠ˜æ—§ã€èµ„æœ¬åŒ–ã€æ‘Šé”€ç­‰äº¤æ˜“å¯¹ä¼ä¸šçš„å½±å“å¦‚ä½•ï¼Ÿ
- è®¾ç½®äº†å“ªäº›é¢„ç®—ï¼Ÿä¼ä¸šå®é™…æ‰§è¡Œæƒ…å†µä¸é¢„ç®—çš„å¯¹æ¯”å¦‚ä½•ï¼Ÿ

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

**General Ledger Accountï¼ˆæ€»è´¦ç§‘ç›®ï¼‰**: ç”¨äºåˆ†ç±»å’Œæ±‡æ€»äº¤æ˜“çš„è´¢åŠ¡æŠ¥å‘Š"æ¡¶"

**Accounting Transactionï¼ˆä¼šè®¡äº¤æ˜“ï¼‰**: å½±å“è´¢åŠ¡æŠ¥è¡¨çš„äº¤æ˜“

**Transaction Detailï¼ˆäº¤æ˜“æ˜ç»†ï¼‰**: å¤å¼è®°è´¦ä¸­çš„å€Ÿæ–¹å’Œè´·æ–¹åˆ†å½•

**Budgetï¼ˆé¢„ç®—ï¼‰**: ç›‘æ§èµ„é‡‘æ”¯å‡ºçš„è®¡åˆ’æœºåˆ¶

**Budget Itemï¼ˆé¢„ç®—é¡¹ï¼‰**: é¢„ç®—çš„æ˜ç»†é¡¹ç›®

---

## 2. ä¼šè®¡ç§‘ç›®è¡¨

### 2.1 æ€»è´¦ç§‘ç›®è¡¨è®¾è®¡

**æ ¸å¿ƒå®ä½“è®¾è®¡**:

```sql
-- æ€»è´¦ç§‘ç›®ç±»å‹è¡¨
CREATE TABLE general_ledger_account_type (
    type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO general_ledger_account_type (type_code, type_name) VALUES
    ('ASSET', 'Asset'),
    ('LIABILITY', 'Liability'),
    ('OWNERS_EQUITY', 'Owners Equity'),
    ('REVENUE', 'Revenue'),
    ('EXPENSE', 'Expense');

-- æ€»è´¦ç§‘ç›®è¡¨
CREATE TABLE general_ledger_account (
    gl_account_id SERIAL PRIMARY KEY,
    account_code VARCHAR(50) UNIQUE,
    account_name VARCHAR(200) NOT NULL,
    description TEXT,
    type_id INT NOT NULL REFERENCES general_ledger_account_type(type_id),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç»„ç»‡æ€»è´¦ç§‘ç›®å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
CREATE TABLE organization_gl_account (
    org_gl_account_id SERIAL PRIMARY KEY,
    organization_id INT NOT NULL, -- å¼•ç”¨å†…éƒ¨ç»„ç»‡ï¼ˆå‡è®¾å·²æœ‰Partyæ¨¡å‹ï¼‰
    gl_account_id INT NOT NULL REFERENCES general_ledger_account(gl_account_id),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(organization_id, gl_account_id, from_date)
);

-- ä¼šè®¡æœŸé—´ç±»å‹è¡¨
CREATE TABLE period_type (
    period_type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO period_type (type_code, type_name) VALUES
    ('FISCAL_YEAR', 'Fiscal Year'),
    ('CALENDAR_YEAR', 'Calendar Year'),
    ('FISCAL_QUARTER', 'Fiscal Quarter'),
    ('FISCAL_MONTH', 'Fiscal Month'),
    ('CALENDAR_MONTH', 'Calendar Month');

-- ä¼šè®¡æœŸé—´è¡¨ï¼ˆé€’å½’ï¼Œæ”¯æŒæœŸé—´å±‚çº§ï¼‰
CREATE TABLE accounting_period (
    period_id SERIAL PRIMARY KEY,
    organization_id INT NOT NULL, -- å¼•ç”¨å†…éƒ¨ç»„ç»‡
    period_type_id INT NOT NULL REFERENCES period_type(period_type_id),
    parent_period_id INT REFERENCES accounting_period(period_id),
    period_number INT,
    from_date DATE NOT NULL,
    thru_date DATE NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (thru_date >= from_date)
);
```

### 2.2 ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¯é€‰ï¼‰

```sql
-- ç»„ç»‡æ€»è´¦ç§‘ç›®ä½™é¢è¡¨ï¼ˆç‰©åŒ–è§†å›¾æˆ–è¡¨ï¼‰
CREATE TABLE organization_gl_account_balance (
    balance_id SERIAL PRIMARY KEY,
    org_gl_account_id INT NOT NULL REFERENCES organization_gl_account(org_gl_account_id),
    accounting_period_id INT NOT NULL REFERENCES accounting_period(period_id),
    balance_amount NUMERIC(15,2) NOT NULL DEFAULT 0,
    debit_total NUMERIC(15,2) NOT NULL DEFAULT 0,
    credit_total NUMERIC(15,2) NOT NULL DEFAULT 0,
    last_transaction_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(org_gl_account_id, accounting_period_id)
);

-- è§¦å‘å™¨ï¼šè‡ªåŠ¨æ›´æ–°ä½™é¢ï¼ˆç®€åŒ–ç‰ˆï¼‰
CREATE OR REPLACE FUNCTION update_account_balance()
RETURNS TRIGGER AS $$
BEGIN
    -- è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ›´å¤æ‚
    UPDATE organization_gl_account_balance
    SET
        balance_amount = balance_amount + CASE WHEN NEW.debit_credit_flag = 'DEBIT' THEN NEW.amount ELSE -NEW.amount END,
        debit_total = debit_total + CASE WHEN NEW.debit_credit_flag = 'DEBIT' THEN NEW.amount ELSE 0 END,
        credit_total = credit_total + CASE WHEN NEW.debit_credit_flag = 'CREDIT' THEN NEW.amount ELSE 0 END,
        last_transaction_date = CURRENT_DATE,
        updated_at = NOW()
    WHERE org_gl_account_id = NEW.org_gl_account_id
        AND accounting_period_id = (
            SELECT period_id FROM accounting_period
            WHERE NEW.transaction_date BETWEEN from_date AND thru_date
            LIMIT 1
        );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## 3. ä¼šè®¡äº¤æ˜“

### 3.1 ä¼šè®¡äº¤æ˜“ç±»å‹

```sql
-- ä¼šè®¡äº¤æ˜“ç±»å‹è¡¨
CREATE TABLE accounting_transaction_type (
    type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    transaction_category VARCHAR(20) NOT NULL CHECK (transaction_category IN ('INTERNAL', 'EXTERNAL')),
    description TEXT
);

-- åˆå§‹åŒ–äº¤æ˜“ç±»å‹
INSERT INTO accounting_transaction_type (type_code, type_name, transaction_category) VALUES
    -- å†…éƒ¨äº¤æ˜“
    ('DEPRECIATION', 'Depreciation', 'INTERNAL'),
    ('CAPITALIZATION', 'Capitalization', 'INTERNAL'),
    ('AMORTIZATION', 'Amortization', 'INTERNAL'),
    ('ITEM_VARIANCE', 'Item Variance', 'INTERNAL'),
    -- å¤–éƒ¨äº¤æ˜“ - ä¹‰åŠ¡
    ('SALES_INVOICE', 'Sales Invoice', 'EXTERNAL'),
    ('CREDIT_MEMO', 'Credit Memo', 'EXTERNAL'),
    ('TAX_DUE', 'Tax Due', 'EXTERNAL'),
    ('NOTE_PAYABLE', 'Note Payable', 'EXTERNAL'),
    ('NOTE_RECEIVABLE', 'Note Receivable', 'EXTERNAL'),
    -- å¤–éƒ¨äº¤æ˜“ - æ”¯ä»˜
    ('RECEIPT', 'Receipt', 'EXTERNAL'),
    ('DISBURSEMENT', 'Disbursement', 'EXTERNAL');
```

### 3.2 ä¼šè®¡äº¤æ˜“è¡¨

```sql
-- ä¼šè®¡äº¤æ˜“è¡¨
CREATE TABLE accounting_transaction (
    transaction_id SERIAL PRIMARY KEY,
    transaction_type_id INT NOT NULL REFERENCES accounting_transaction_type(type_id),
    organization_id INT, -- å¼•ç”¨å†…éƒ¨ç»„ç»‡ï¼ˆç”¨äºå†…éƒ¨äº¤æ˜“ï¼‰
    from_party_id INT, -- å¼•ç”¨Partyï¼ˆç”¨äºå¤–éƒ¨äº¤æ˜“ï¼‰
    to_party_id INT, -- å¼•ç”¨Partyï¼ˆç”¨äºå¤–éƒ¨äº¤æ˜“ï¼‰
    transaction_date DATE NOT NULL,
    entry_date TIMESTAMPTZ DEFAULT NOW(),
    description TEXT,
    -- ä¸šåŠ¡è§„åˆ™ï¼šå†…éƒ¨äº¤æ˜“åªéœ€è¦organization_idï¼Œå¤–éƒ¨äº¤æ˜“éœ€è¦from_partyå’Œto_party
    CHECK (
        (transaction_type_id IN (SELECT type_id FROM accounting_transaction_type WHERE transaction_category = 'INTERNAL') AND organization_id IS NOT NULL) OR
        (transaction_type_id IN (SELECT type_id FROM accounting_transaction_type WHERE transaction_category = 'EXTERNAL') AND (from_party_id IS NOT NULL OR to_party_id IS NOT NULL))
    ),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ä¸šåŠ¡äº¤æ˜“å…³è”è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå…³è”å‘ç¥¨ã€ä»˜æ¬¾ç­‰ä¸šåŠ¡äº¤æ˜“ï¼‰
CREATE TABLE business_transaction_reference (
    reference_id SERIAL PRIMARY KEY,
    accounting_transaction_id INT NOT NULL REFERENCES accounting_transaction(transaction_id) ON DELETE CASCADE,
    business_transaction_type VARCHAR(50) NOT NULL, -- 'INVOICE', 'PAYMENT', 'INVENTORY_VARIANCE'
    business_transaction_id INT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(accounting_transaction_id, business_transaction_type, business_transaction_id)
);
```

---

## 4. äº¤æ˜“æ˜ç»†

### 4.1 äº¤æ˜“æ˜ç»†è¡¨ï¼ˆå¤å¼è®°è´¦ï¼‰

```sql
-- äº¤æ˜“æ˜ç»†è¡¨
CREATE TABLE transaction_detail (
    detail_id SERIAL PRIMARY KEY,
    transaction_id INT NOT NULL REFERENCES accounting_transaction(transaction_id) ON DELETE CASCADE,
    detail_seq_id INT NOT NULL,
    org_gl_account_id INT NOT NULL REFERENCES organization_gl_account(org_gl_account_id),
    debit_credit_flag CHAR(1) NOT NULL CHECK (debit_credit_flag IN ('D', 'C')),
    amount NUMERIC(15,2) NOT NULL CHECK (amount >= 0),
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(transaction_id, detail_seq_id),
    -- ä¸šåŠ¡è§„åˆ™ï¼šæ¯ç¬”äº¤æ˜“è‡³å°‘æœ‰ä¸¤ä¸ªæ˜ç»†ï¼ˆå€Ÿæ–¹å’Œè´·æ–¹ï¼‰
    CHECK (
        EXISTS (
            SELECT 1 FROM transaction_detail td2
            WHERE td2.transaction_id = transaction_detail.transaction_id
            AND td2.debit_credit_flag != transaction_detail.debit_credit_flag
        )
    )
);

-- äº¤æ˜“æ˜ç»†å…³è”è¡¨ï¼ˆé€’å½’ï¼Œç”¨äºå…³è”ä»˜æ¬¾å’Œå‘ç¥¨ç­‰ï¼‰
CREATE TABLE transaction_detail_association (
    association_id SERIAL PRIMARY KEY,
    from_detail_id INT NOT NULL REFERENCES transaction_detail(detail_id) ON DELETE CASCADE,
    to_detail_id INT NOT NULL REFERENCES transaction_detail(detail_id) ON DELETE CASCADE,
    association_type VARCHAR(50), -- 'PAYMENT_TO_INVOICE', 'CREDIT_TO_INVOICE', 'REFUND'
    amount_allocated NUMERIC(15,2),
    from_date DATE DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (from_detail_id != to_detail_id)
);

-- PostgreSQL 18ä¼˜åŒ–ï¼šè‡ªåŠ¨éªŒè¯å€Ÿè´·å¹³è¡¡
CREATE OR REPLACE FUNCTION validate_transaction_balance()
RETURNS TRIGGER AS $$
DECLARE
    v_debit_total NUMERIC(15,2);
    v_credit_total NUMERIC(15,2);
BEGIN
    SELECT
        COALESCE(SUM(amount) FILTER (WHERE debit_credit_flag = 'D'), 0),
        COALESCE(SUM(amount) FILTER (WHERE debit_credit_flag = 'C'), 0)
    INTO v_debit_total, v_credit_total
    FROM transaction_detail
    WHERE transaction_id = COALESCE(NEW.transaction_id, OLD.transaction_id);

    IF v_debit_total != v_credit_total THEN
        RAISE EXCEPTION 'Transactionä¸å¹³è¡¡: å€Ÿæ–¹æ€»é¢ % ä¸ç­‰äºè´·æ–¹æ€»é¢ %', v_debit_total, v_credit_total;
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_transaction_balance
    AFTER INSERT OR UPDATE OR DELETE ON transaction_detail
    FOR EACH ROW
    EXECUTE FUNCTION validate_transaction_balance();
```

### 4.2 è¾…åŠ©æ€»è´¦

```sql
-- è¾…åŠ©æ€»è´¦å…³è”è¡¨ï¼ˆé€’å½’ï¼Œç”¨äºè¾…åŠ©è´¦ï¼‰
CREATE TABLE organization_gl_account_composition (
    composition_id SERIAL PRIMARY KEY,
    parent_org_gl_account_id INT NOT NULL REFERENCES organization_gl_account(org_gl_account_id),
    child_org_gl_account_id INT NOT NULL REFERENCES organization_gl_account(org_gl_account_id),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (parent_org_gl_account_id != child_org_gl_account_id),
    UNIQUE(parent_org_gl_account_id, child_org_gl_account_id, from_date)
);

-- è¾…åŠ©è´¦å…³è”ï¼ˆä¸Partyã€Productç­‰ï¼‰
ALTER TABLE organization_gl_account ADD COLUMN party_id INT; -- ç”¨äºåº”æ”¶è´¦æ¬¾ã€åº”ä»˜è´¦æ¬¾è¾…åŠ©è´¦
ALTER TABLE organization_gl_account ADD COLUMN product_id INT REFERENCES product(product_id); -- ç”¨äºäº§å“æ”¶å…¥è¾…åŠ©è´¦
ALTER TABLE organization_gl_account ADD COLUMN product_category_id INT; -- ç”¨äºäº§å“åˆ†ç±»æ”¶å…¥è¾…åŠ©è´¦
```

---

## 5. é¢„ç®—å®šä¹‰

### 5.1 é¢„ç®—è¡¨

```sql
-- é¢„ç®—ç±»å‹è¡¨
CREATE TABLE budget_type (
    type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO budget_type (type_code, type_name) VALUES
    ('OPERATING', 'Operating Budget'),
    ('CAPITAL', 'Capital Budget');

-- æ ‡å‡†æ—¶é—´æœŸé—´è¡¨
CREATE TABLE standard_time_period (
    period_id SERIAL PRIMARY KEY,
    period_type_id INT NOT NULL REFERENCES period_type(period_type_id),
    period_name VARCHAR(100) NOT NULL,
    from_date DATE NOT NULL,
    thru_date DATE NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- é¢„ç®—è¡¨
CREATE TABLE budget (
    budget_id SERIAL PRIMARY KEY,
    budget_type_id INT NOT NULL REFERENCES budget_type(type_id),
    organization_id INT NOT NULL, -- å¼•ç”¨å†…éƒ¨ç»„ç»‡ï¼ˆé¢„ç®—è¯·æ±‚æ–¹ï¼‰
    standard_time_period_id INT NOT NULL REFERENCES standard_time_period(period_id),
    budget_code VARCHAR(50) UNIQUE,
    description TEXT,
    total_budget_amount NUMERIC(15,2),
    from_date DATE NOT NULL,
    thru_date DATE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (thru_date >= from_date)
);

-- é¢„ç®—è§’è‰²ç±»å‹è¡¨
CREATE TABLE budget_role_type (
    role_type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO budget_role_type (type_code, type_name) VALUES
    ('INITIATOR', 'Initiator'),
    ('REQUESTED_FOR', 'Requested For'),
    ('REVIEWER', 'Reviewer'),
    ('APPROVER', 'Approver');

-- é¢„ç®—è§’è‰²è¡¨
CREATE TABLE budget_role (
    role_id SERIAL PRIMARY KEY,
    budget_id INT NOT NULL REFERENCES budget(budget_id) ON DELETE CASCADE,
    party_id INT NOT NULL, -- å¼•ç”¨Party
    role_type_id INT NOT NULL REFERENCES budget_role_type(role_type_id),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(budget_id, party_id, role_type_id, from_date)
);
```

### 5.2 é¢„ç®—é¡¹

```sql
-- é¢„ç®—é¡¹ç±»å‹è¡¨
CREATE TABLE budget_item_type (
    item_type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

-- é¢„ç®—é¡¹è¡¨ï¼ˆæ”¯æŒé€’å½’ï¼Œé¢„ç®—é¡¹å¯ä»¥åŒ…å«å­é¡¹ï¼‰
CREATE TABLE budget_item (
    item_id SERIAL PRIMARY KEY,
    budget_id INT NOT NULL REFERENCES budget(budget_id) ON DELETE CASCADE,
    parent_item_id INT REFERENCES budget_item(item_id),
    item_type_id INT NOT NULL REFERENCES budget_item_type(item_type_id),
    item_seq INT NOT NULL,
    description TEXT,
    amount NUMERIC(15,2) NOT NULL CHECK (amount >= 0),
    purpose TEXT,
    justification TEXT,
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(budget_id, item_seq),
    CHECK (parent_item_id IS NULL OR parent_item_id != item_id)
);
```

### 5.3 é¢„ç®—çŠ¶æ€

```sql
-- é¢„ç®—çŠ¶æ€ç±»å‹è¡¨
CREATE TABLE budget_status_type (
    status_type_id SERIAL PRIMARY KEY,
    status_code VARCHAR(50) UNIQUE NOT NULL,
    status_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO budget_status_type (status_code, status_name) VALUES
    ('CREATED', 'Created'),
    ('SUBMITTED', 'Submitted'),
    ('APPROVED', 'Approved'),
    ('REJECTED', 'Rejected'),
    ('SENT_BACK', 'Sent Back for Modifications'),
    ('ACTIVE', 'Active'),
    ('CLOSED', 'Closed');

-- é¢„ç®—çŠ¶æ€è¡¨
CREATE TABLE budget_status (
    status_id SERIAL PRIMARY KEY,
    budget_id INT NOT NULL REFERENCES budget(budget_id) ON DELETE CASCADE,
    status_type_id INT NOT NULL REFERENCES budget_status_type(status_type_id),
    status_date TIMESTAMPTZ DEFAULT NOW(),
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 6. é¢„ç®—ä¿®è®¢

### 6.1 é¢„ç®—ä¿®è®¢è¡¨

```sql
-- é¢„ç®—ä¿®è®¢è¡¨
CREATE TABLE budget_revision (
    revision_id SERIAL PRIMARY KEY,
    budget_id INT NOT NULL REFERENCES budget(budget_id) ON DELETE CASCADE,
    revision_seq VARCHAR(50) NOT NULL, -- å¦‚ "1.1", "1.2"
    parent_revision_id INT REFERENCES budget_revision(revision_id),
    revision_date DATE DEFAULT CURRENT_DATE,
    reason TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(budget_id, revision_seq)
);

-- é¢„ç®—ä¿®è®¢å½±å“è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
CREATE TABLE budget_revision_impact (
    impact_id SERIAL PRIMARY KEY,
    revision_id INT NOT NULL REFERENCES budget_revision(revision_id) ON DELETE CASCADE,
    budget_item_id INT NOT NULL REFERENCES budget_item(item_id),
    revised_amount_change NUMERIC(15,2), -- æ­£æ•°è¡¨ç¤ºå¢åŠ ï¼Œè´Ÿæ•°è¡¨ç¤ºå‡å°‘
    revised_percent_change NUMERIC(5,2), -- ç™¾åˆ†æ¯”å˜åŒ–
    add_delete_flag CHAR(1) CHECK (add_delete_flag IN ('A', 'D')), -- A=Added, D=Deleted
    revision_reason TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (
        (revised_amount_change IS NOT NULL AND revised_percent_change IS NULL) OR
        (revised_amount_change IS NULL AND revised_percent_change IS NOT NULL)
    )
);
```

### 6.2 é¢„ç®—å®¡æŸ¥

```sql
-- é¢„ç®—å®¡æŸ¥ç»“æœç±»å‹è¡¨
CREATE TABLE budget_review_result_type (
    result_type_id SERIAL PRIMARY KEY,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

INSERT INTO budget_review_result_type (type_code, type_name) VALUES
    ('ACCEPTED', 'Accepted'),
    ('REJECTED', 'Rejected'),
    ('CONDITIONAL_APPROVAL', 'Conditional Approval');

-- é¢„ç®—å®¡æŸ¥è¡¨
CREATE TABLE budget_review (
    review_id SERIAL PRIMARY KEY,
    budget_id INT NOT NULL REFERENCES budget(budget_id) ON DELETE CASCADE,
    party_id INT NOT NULL, -- å¼•ç”¨å®¡æŸ¥äººå‘˜
    review_date DATE DEFAULT CURRENT_DATE,
    result_type_id INT NOT NULL REFERENCES budget_review_result_type(result_type_id),
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 6.3 é¢„ç®—åœºæ™¯

```sql
-- é¢„ç®—åœºæ™¯è¡¨
CREATE TABLE budget_scenario (
    scenario_id SERIAL PRIMARY KEY,
    scenario_code VARCHAR(50) UNIQUE NOT NULL,
    scenario_name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO budget_scenario (scenario_code, scenario_name, description) VALUES
    ('BEST_CASE', 'Best Case', 'æœ€ä½³æƒ…å†µ'),
    ('WORST_CASE', 'Worst Case', 'æœ€åæƒ…å†µ'),
    ('BASELINE', 'Baseline', 'åŸºå‡†æƒ…å†µ'),
    ('EXCELLENT_MARKET', 'Excellent Market Conditions', 'å¸‚åœºæ¡ä»¶è‰¯å¥½'),
    ('POOR_MARKET', 'Poor Market Conditions', 'å¸‚åœºæ¡ä»¶ä¸ä½³');

-- é¢„ç®—åœºæ™¯åº”ç”¨è¡¨ï¼ˆå¯ä»¥åº”ç”¨äºæ•´ä¸ªé¢„ç®—æˆ–ç‰¹å®šé¢„ç®—é¡¹ï¼‰
CREATE TABLE budget_scenario_application (
    application_id SERIAL PRIMARY KEY,
    budget_id INT REFERENCES budget(budget_id) ON DELETE CASCADE,
    budget_item_id INT REFERENCES budget_item(item_id) ON DELETE CASCADE,
    scenario_id INT NOT NULL REFERENCES budget_scenario(scenario_id),
    amount_change NUMERIC(15,2),
    percent_change NUMERIC(5,2),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (budget_id IS NOT NULL OR budget_item_id IS NOT NULL),
    CHECK (
        (amount_change IS NOT NULL AND percent_change IS NULL) OR
        (amount_change IS NULL AND percent_change IS NOT NULL)
    )
);

-- é¢„ç®—é¡¹ç±»å‹åœºæ™¯è§„åˆ™è¡¨
CREATE TABLE budget_item_type_scenario_rule (
    rule_id SERIAL PRIMARY KEY,
    item_type_id INT NOT NULL REFERENCES budget_item_type(item_type_id),
    scenario_id INT NOT NULL REFERENCES budget_scenario(scenario_id),
    default_amount_change NUMERIC(15,2),
    default_percent_change NUMERIC(5,2),
    from_date DATE DEFAULT CURRENT_DATE,
    thru_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (
        (default_amount_change IS NOT NULL AND default_percent_change IS NULL) OR
        (default_amount_change IS NULL AND default_percent_change IS NOT NULL)
    )
);
```

---

## 7. PostgreSQLå®Œæ•´å®ç°

### 7.1 ç´¢å¼•è®¾è®¡

```sql
-- ä¼šè®¡äº¤æ˜“ç´¢å¼•
CREATE INDEX idx_accounting_transaction_date ON accounting_transaction(transaction_date);
CREATE INDEX idx_accounting_transaction_type ON accounting_transaction(transaction_type_id);
CREATE INDEX idx_accounting_transaction_org ON accounting_transaction(organization_id);
CREATE INDEX idx_accounting_transaction_parties ON accounting_transaction(from_party_id, to_party_id);

-- äº¤æ˜“æ˜ç»†ç´¢å¼•
CREATE INDEX idx_transaction_detail_transaction ON transaction_detail(transaction_id);
CREATE INDEX idx_transaction_detail_account ON transaction_detail(org_gl_account_id);
CREATE INDEX idx_transaction_detail_flag ON transaction_detail(debit_credit_flag);

-- é¢„ç®—ç´¢å¼•
CREATE INDEX idx_budget_organization ON budget(organization_id);
CREATE INDEX idx_budget_period ON budget(standard_time_period_id);
CREATE INDEX idx_budget_dates ON budget USING gist (daterange(from_date, thru_date));

-- é¢„ç®—é¡¹ç´¢å¼•
CREATE INDEX idx_budget_item_budget ON budget_item(budget_id);
CREATE INDEX idx_budget_item_parent ON budget_item(parent_item_id);
```

### 7.2 çº¦æŸå’Œä¸šåŠ¡è§„åˆ™

æ‰€æœ‰è¡¨éƒ½åŒ…å«å®Œæ•´çš„çº¦æŸï¼ŒåŒ…æ‹¬ï¼š

- å¤å¼è®°è´¦å¹³è¡¡éªŒè¯ï¼ˆé€šè¿‡è§¦å‘å™¨ï¼‰
- æ—¥æœŸèŒƒå›´éªŒè¯
- å¤–é”®çº¦æŸ
- å”¯ä¸€æ€§çº¦æŸ

---

## 8. æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢1: è®¡ç®—è´¦æˆ·ä½™é¢

```sql
-- è®¡ç®—æŒ‡å®šæœŸé—´å’Œè´¦æˆ·çš„ä½™é¢
SELECT
    oga.org_gl_account_id,
    gla.account_name,
    glat.type_name AS account_type,
    ap.from_date AS period_start,
    ap.thru_date AS period_end,
    COALESCE(debit_total.debit_sum, 0) AS total_debits,
    COALESCE(credit_total.credit_sum, 0) AS total_credits,
    COALESCE(debit_total.debit_sum, 0) - COALESCE(credit_total.credit_sum, 0) AS balance
FROM organization_gl_account oga
INNER JOIN general_ledger_account gla ON oga.gl_account_id = gla.gl_account_id
INNER JOIN general_ledger_account_type glat ON gla.type_id = glat.type_id
CROSS JOIN accounting_period ap
LEFT JOIN (
    SELECT
        td.org_gl_account_id,
        ap2.period_id,
        SUM(td.amount) AS debit_sum
    FROM transaction_detail td
    INNER JOIN accounting_transaction at ON td.transaction_id = at.transaction_id
    INNER JOIN accounting_period ap2 ON at.transaction_date BETWEEN ap2.from_date AND ap2.thru_date
    WHERE td.debit_credit_flag = 'D'
    GROUP BY td.org_gl_account_id, ap2.period_id
) debit_total ON oga.org_gl_account_id = debit_total.org_gl_account_id AND ap.period_id = debit_total.period_id
LEFT JOIN (
    SELECT
        td.org_gl_account_id,
        ap2.period_id,
        SUM(td.amount) AS credit_sum
    FROM transaction_detail td
    INNER JOIN accounting_transaction at ON td.transaction_id = at.transaction_id
    INNER JOIN accounting_period ap2 ON at.transaction_date BETWEEN ap2.from_date AND ap2.thru_date
    WHERE td.debit_credit_flag = 'C'
    GROUP BY td.org_gl_account_id, ap2.period_id
) credit_total ON oga.org_gl_account_id = credit_total.org_gl_account_id AND ap.period_id = credit_total.period_id
WHERE oga.organization_id = :organization_id
    AND ap.period_id = :period_id
ORDER BY glat.type_code, gla.account_code;
```

### æŸ¥è¯¢2: é¢„ç®—æ‰§è¡Œæƒ…å†µå¯¹æ¯”

```sql
-- å¯¹æ¯”é¢„ç®—å’Œå®é™…æ”¯å‡º
SELECT
    b.budget_id,
    b.description AS budget_description,
    bi.item_id,
    bi.description AS item_description,
    bi.amount AS budgeted_amount,
    COALESCE(actual_expenditure.actual_amount, 0) AS actual_amount,
    bi.amount - COALESCE(actual_expenditure.actual_amount, 0) AS variance,
    CASE
        WHEN bi.amount > 0 THEN
            ((bi.amount - COALESCE(actual_expenditure.actual_amount, 0)) / bi.amount * 100)
        ELSE 0
    END AS variance_percent
FROM budget b
INNER JOIN budget_item bi ON b.budget_id = bi.budget_id
LEFT JOIN (
    -- è®¡ç®—å®é™…æ”¯å‡ºï¼ˆä»è®¢å•é¡¹å’Œä»˜æ¬¾å…³è”åˆ°é¢„ç®—é¡¹ï¼‰
    SELECT
        oiba.budget_item_id,
        SUM(COALESCE(oi.estimated_amount, 0)) AS actual_amount
    FROM order_item_budget_allocation oiba
    INNER JOIN order_item oi ON oiba.order_item_id = oi.order_item_id
    GROUP BY oiba.budget_item_id
) actual_expenditure ON bi.item_id = actual_expenditure.budget_item_id
WHERE b.budget_id = :budget_id
ORDER BY bi.item_seq;
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 ç‰©åŒ–è§†å›¾ä¼˜åŒ–

```sql
-- åˆ›å»ºè´¦æˆ·ä½™é¢ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_account_balance AS
SELECT
    oga.org_gl_account_id,
    ap.period_id,
    SUM(CASE WHEN td.debit_credit_flag = 'D' THEN td.amount ELSE -td.amount END) AS balance
FROM organization_gl_account oga
CROSS JOIN accounting_period ap
LEFT JOIN transaction_detail td ON td.org_gl_account_id = oga.org_gl_account_id
LEFT JOIN accounting_transaction at ON td.transaction_id = at.transaction_id
    AND at.transaction_date BETWEEN ap.from_date AND ap.thru_date
GROUP BY oga.org_gl_account_id, ap.period_id;

CREATE UNIQUE INDEX ON mv_account_balance(org_gl_account_id, period_id);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_account_balance;
```

---

## 10. å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹1: ä¼ä¸šè´¢åŠ¡ä¼šè®¡ç³»ç»Ÿ

**åœºæ™¯**: ä¼ä¸šå®Œæ•´çš„è´¢åŠ¡ä¼šè®¡ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ€»è´¦ã€æ˜ç»†è´¦ã€æŠ¥è¡¨ç­‰ã€‚

**å®ç°è¦ç‚¹**:

- ä½¿ç”¨general_ledger_accountå»ºç«‹ç§‘ç›®ä½“ç³»
- ä½¿ç”¨accounting_transactionå’Œtransaction_detailå®ç°å¤å¼è®°è´¦
- ä½¿ç”¨organization_gl_account_balanceå­˜å‚¨è´¦æˆ·ä½™é¢ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨accounting_periodç®¡ç†ä¼šè®¡æœŸé—´

### æ¡ˆä¾‹2: é¢„ç®—ç®¡ç†ç³»ç»Ÿ

**åœºæ™¯**: ä¼ä¸šé¢„ç®—ç¼–åˆ¶ã€å®¡æ‰¹ã€æ‰§è¡Œç›‘æ§ç³»ç»Ÿã€‚

**å®ç°è¦ç‚¹**:

- ä½¿ç”¨budgetå’Œbudget_itemå»ºç«‹é¢„ç®—ä½“ç³»
- ä½¿ç”¨budget_revisionç®¡ç†é¢„ç®—ä¿®è®¢
- ä½¿ç”¨budget_scenarioæ”¯æŒå¤šåœºæ™¯é¢„ç®—
- ä½¿ç”¨order_item_budget_allocationå…³è”è®¢å•å’Œé¢„ç®—

---

## 11. å¸¸è§é—®é¢˜è§£ç­” / FAQ

### Q1: å¦‚ä½•ç¡®ä¿å¤å¼è®°è´¦çš„å€Ÿè´·å¹³è¡¡ï¼Ÿ

**A**: ä½¿ç”¨è§¦å‘å™¨åœ¨æ¯æ¬¡æ’å…¥/æ›´æ–°/åˆ é™¤äº¤æ˜“æ˜ç»†æ—¶éªŒè¯ï¼š

```sql
-- ä½¿ç”¨validate_transaction_balance()å‡½æ•°å’Œè§¦å‘å™¨
```

### Q2: å¦‚ä½•å¤„ç†é¢„ç®—ä¿®è®¢çš„ç‰ˆæœ¬ç®¡ç†ï¼Ÿ

**A**: ä½¿ç”¨budget_revisionè¡¨ç®¡ç†é¢„ç®—ä¿®è®¢å†å²ï¼Œæ¯ä¸ªä¿®è®¢éƒ½æœ‰ç‹¬ç«‹çš„revision_seqã€‚

### Q3: å¦‚ä½•è®¡ç®—é¢„ç®—æ‰§è¡Œç‡ï¼Ÿ

**A**: é€šè¿‡å¯¹æ¯”budget_itemçš„é‡‘é¢å’Œå…³è”çš„å®é™…æ”¯å‡ºï¼ˆæ¥è‡ªorder_item_budget_allocationï¼‰è®¡ç®—ã€‚

---

## 12. ç›¸å…³èµ„æº

### 12.1 æ ¸å¿ƒç›¸å…³æ–‡æ¡£

- [å·¥ä½œåŠªåŠ›æ¨¡å‹](./å·¥ä½œåŠªåŠ›æ¨¡å‹.md) - å·¥ä½œæˆæœ¬å…³è”
- [è®¢å•ç®¡ç†æ¨¡å‹](./è®¢å•ç®¡ç†æ¨¡å‹.md) - è®¢å•é¢„ç®—å…³è”
- [äº§å“ç®¡ç†æ¨¡å‹](./äº§å“ç®¡ç†æ¨¡å‹.md) - äº§å“æˆæœ¬å…³è”
- [Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ](../02-æƒå¨èµ„æºä¸æ ‡å‡†/Silverstonæ•°æ®æ¨¡å‹èµ„æºæ‰‹å†Œ.md) - ä¸‰å·æœ¬è¯¦è§£

### 12.2 å½’æ¡£èµ„æº

- [Volume 1å®Œæ•´å†…å®¹](../../99-å½’æ¡£/å‚è€ƒèµ„æº/books/The Data Model Resource Book 1/full.md) - Chapter 8: Accounting and Budgeting

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**çŠ¶æ€**: âœ… æ–‡æ¡£å®Œæˆï¼ŒåŸºäºVolume 1 Chapter 8å®Œæ•´æ•´åˆ
