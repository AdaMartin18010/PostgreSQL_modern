---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\04-è¿æ¥é—®é¢˜è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# è¿æ¥é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**
> **è¿æ¥æ± ã€è¶…æ—¶ã€è¿æ¥æ³„æ¼**

---

## æ¡ˆä¾‹1ï¼šè¿æ¥æ•°è€—å°½

### ç—‡çŠ¶

```text
é”™è¯¯ä¿¡æ¯ï¼š
FATAL: remaining connection slots are reserved for non-replication superuser connections

åº”ç”¨æ— æ³•å»ºç«‹æ–°è¿æ¥
ç°æœ‰è¿æ¥æ­£å¸¸
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥å½“å‰è¿æ¥æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥å½“å‰è¿æ¥æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢è¿æ¥ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active,
    count(*) FILTER (WHERE state = 'idle') AS idle,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction,
    setting AS max_connections
FROM pg_stat_activity
CROSS JOIN pg_settings
WHERE name = 'max_connections'
GROUP BY setting;

/*
total_connections: 98
max_connections: 100
idle_in_transaction: 45 (é—®é¢˜ï¼)
*/

-- æŸ¥æ‰¾è¿æ¥æ¥æºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥æ‰¾è¿æ¥æ¥æº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢è¿æ¥æ¥æºï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    usename,
    application_name,
    client_addr,
    count(*) AS connection_count,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_tx_count
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY usename, application_name, client_addr
ORDER BY connection_count DESC;

/*
application_name: web_app
connection_count: 50
idle_tx_count: 30 (é—®é¢˜ï¼)
*/
```

### è§£å†³

```sql
-- ç«‹å³ï¼šç»ˆæ­¢ç©ºé—²äº‹åŠ¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    terminated_count int := 0;
    backend_record RECORD;
BEGIN
    BEGIN
        FOR backend_record IN
            SELECT pid
            FROM pg_stat_activity
            WHERE state = 'idle in transaction'
            AND now() - state_change > interval '5 minutes'
            AND pid != pg_backend_pid()
        LOOP
            BEGIN
                PERFORM pg_terminate_backend(backend_record.pid);
                terminated_count := terminated_count + 1;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'ç»ˆæ­¢è¿›ç¨‹ % å¤±è´¥: %', backend_record.pid, SQLERRM;
            END;
        END LOOP;

        RAISE NOTICE 'å·²ç»ˆæ­¢ % ä¸ªç©ºé—²äº‹åŠ¡è¿æ¥', terminated_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»ˆæ­¢ç©ºé—²äº‹åŠ¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é•¿æœŸï¼šä½¿ç”¨è¿æ¥æ± 
-- æ–¹æ¡ˆ1ï¼šPgBouncerï¼ˆæ¨èï¼‰
-- é…ç½®ï¼špool_mode = transaction
-- max_client_conn = 1000
-- default_pool_size = 25

-- æ–¹æ¡ˆ2ï¼šåº”ç”¨å±‚è¿æ¥æ± 
-- é™åˆ¶æ¯ä¸ªåº”ç”¨å®ä¾‹çš„è¿æ¥æ•°
-- ä½¿ç”¨è¿æ¥æ± åº“ï¼ˆå¦‚HikariCPï¼‰

-- æ–¹æ¡ˆ3ï¼šè®¾ç½®è¶…æ—¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER DATABASE current_database() SET idle_in_transaction_session_timeout = '10min';
            ALTER DATABASE current_database() SET statement_timeout = '30s';
            RAISE NOTICE 'è¶…æ—¶å‚æ•°è®¾ç½®æˆåŠŸ';
        ELSE
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½è®¾ç½®æ•°æ®åº“å‚æ•°';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®æ•°æ®åº“å‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®è¶…æ—¶å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## æ¡ˆä¾‹2ï¼šè¿æ¥è¶…æ—¶

### ç—‡çŠ¶

```text
é”™è¯¯ä¿¡æ¯ï¼š
timeout expired
connection timed out

åº”ç”¨é—´æ­‡æ€§æ— æ³•è¿æ¥
ç½‘ç»œæ­£å¸¸
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥è¿æ¥ç­‰å¾…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥è¿æ¥ç­‰å¾…';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢è¿æ¥ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    state,
    wait_event_type,
    wait_event,
    query_start,
    now() - query_start AS query_duration
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
ORDER BY query_duration DESC
LIMIT 100;

-- æ£€æŸ¥é”ç­‰å¾…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥é”ç­‰å¾…';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢é”ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked.pid AS blocked_pid,
    blocking.pid AS blocking_pid,
    blocking.query AS blocking_query,
    now() - blocking.query_start AS blocking_duration
FROM pg_stat_activity blocked
JOIN pg_locks blocked_lock ON blocked.pid = blocked_lock.pid
JOIN pg_locks blocking_lock ON blocking_lock.locktype = blocked_lock.locktype
    AND blocking_lock.pid != blocked_lock.pid
JOIN pg_stat_activity blocking ON blocking.pid = blocking_lock.pid
WHERE NOT blocked_lock.granted
  AND blocking_lock.granted
LIMIT 100;

-- æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç½‘ç»œå»¶è¿Ÿï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    client_addr,
    count(*) AS connections,
    avg(now() - backend_start) AS avg_connection_age
FROM pg_stat_activity
WHERE client_addr IS NOT NULL
GROUP BY client_addr
LIMIT 100;
```

### è§£å†³

```sql
-- 1. ä¼˜åŒ–æ…¢æŸ¥è¯¢
-- ä½¿ç”¨EXPLAIN (ANALYZE, BUFFERS, TIMING)æ‰¾åˆ°æ…¢æŸ¥è¯¢
-- æ·»åŠ ç´¢å¼•ã€ä¼˜åŒ–JOIN

-- 2. è®¾ç½®åˆç†çš„è¶…æ—¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER DATABASE current_database() SET statement_timeout = '30s';
            ALTER DATABASE current_database() SET lock_timeout = '10s';
            RAISE NOTICE 'è¶…æ—¶å‚æ•°è®¾ç½®æˆåŠŸ';
        ELSE
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½è®¾ç½®æ•°æ®åº“å‚æ•°';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®æ•°æ®åº“å‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®è¶…æ—¶å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä½¿ç”¨è¿æ¥æ± ï¼ˆå‡å°‘è¿æ¥å»ºç«‹å¼€é”€ï¼‰
-- PgBounceré…ç½®ï¼š
-- pool_mode = transaction
-- server_connect_timeout = 15

-- 4. åº”ç”¨å±‚é‡è¯•æœºåˆ¶
-- æŒ‡æ•°é€€é¿é‡è¯•
-- è¿æ¥å¥åº·æ£€æŸ¥
```

---

## æ¡ˆä¾‹3ï¼šè¿æ¥æ³„æ¼

### ç—‡çŠ¶

```text
è¿æ¥æ•°æŒç»­å¢é•¿
åº”ç”¨é‡å¯åè¿æ¥æ•°ä¸‹é™
å†…å­˜ä½¿ç”¨æŒç»­å¢åŠ 
```

### è¯Šæ–­

```sql
-- æŸ¥æ‰¾é•¿æ—¶é—´ç©ºé—²è¿æ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥æ‰¾é•¿æ—¶é—´ç©ºé—²è¿æ¥';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç©ºé—²è¿æ¥ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    state_change,
    now() - backend_start AS connection_age,
    now() - state_change AS idle_duration,
    query
FROM pg_stat_activity
WHERE datname = current_database()
  AND state IN ('idle', 'idle in transaction')
ORDER BY idle_duration DESC
LIMIT 100;

-- æŸ¥æ‰¾åº”ç”¨è¿æ¥æ¨¡å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥æ‰¾åº”ç”¨è¿æ¥æ¨¡å¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢åº”ç”¨è¿æ¥æ¨¡å¼ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    client_addr,
    count(*) AS connection_count,
    min(backend_start) AS first_connection,
    max(backend_start) AS last_connection
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY application_name, client_addr
ORDER BY connection_count DESC
LIMIT 100;

/*
application_name: web_app
connection_count: 200 (å¼‚å¸¸é«˜ï¼)
*/
```

### è§£å†³

```python
# åº”ç”¨å±‚ï¼šç¡®ä¿è¿æ¥å…³é—­
# é”™è¯¯ç¤ºä¾‹
def bad_query():
    conn = psycopg2.connect(...)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
    # å¿˜è®°å…³é—­è¿æ¥ï¼âŒ
    return cursor.fetchall()

# æ­£ç¡®ç¤ºä¾‹1ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
def good_query():
    with psycopg2.connect(...) as conn:
        with conn.cursor() as cursor:
            cursor.execute("SELECT * FROM users")
            return cursor.fetchall()
    # è‡ªåŠ¨å…³é—­è¿æ¥ âœ“

# æ­£ç¡®ç¤ºä¾‹2ï¼šä½¿ç”¨è¿æ¥æ± 
from psycopg2 import pool

connection_pool = pool.SimpleConnectionPool(
    minconn=1,
    maxconn=10,  # é™åˆ¶æœ€å¤§è¿æ¥æ•°
    ...
)

def query_with_pool():
    conn = connection_pool.getconn()
    try:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users")
        return cursor.fetchall()
    finally:
        connection_pool.putconn(conn)  # å½’è¿˜è¿æ¥
```

```sql
-- æ•°æ®åº“å±‚ï¼šè‡ªåŠ¨æ¸…ç†ç©ºé—²è¿æ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER DATABASE current_database() SET idle_in_transaction_session_timeout = '10min';
            ALTER DATABASE current_database() SET idle_session_timeout = '1h';
            RAISE NOTICE 'ç©ºé—²è¿æ¥è¶…æ—¶å‚æ•°è®¾ç½®æˆåŠŸ';
        ELSE
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½è®¾ç½®æ•°æ®åº“å‚æ•°';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®æ•°æ®åº“å‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç©ºé—²è¿æ¥è¶…æ—¶å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›‘æ§è¿æ¥è¶‹åŠ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        DROP VIEW IF EXISTS connection_stats;
        CREATE VIEW connection_stats AS
        SELECT
            date_trunc('minute', now()) AS time,
            count(*) AS total_connections,
            count(*) FILTER (WHERE state = 'active') AS active,
            count(*) FILTER (WHERE state = 'idle') AS idle
        FROM pg_stat_activity
        GROUP BY time;
        RAISE NOTICE 'è¿æ¥ç»Ÿè®¡è§†å›¾åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¿æ¥ç»Ÿè®¡è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## æ¡ˆä¾‹4ï¼šè¿æ¥æ± é…ç½®ä¸å½“

### ç—‡çŠ¶

```text
ä½¿ç”¨PgBounceråæ€§èƒ½ä¸‹é™
è¿æ¥æ± å‘½ä¸­ç‡ä½
æŸ¥è¯¢å˜æ…¢
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥PgBouncerç»Ÿè®¡ï¼ˆå¦‚æœå¯ç”¨pg_stat_statementsï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥PgBouncerç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢æ•°æ®åº“ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    usename,
    count(*) AS connections,
    sum(xact_count) AS transactions,
    sum(query_count) AS queries
FROM pg_stat_database
GROUP BY datname, usename
LIMIT 100;

-- æ£€æŸ¥è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
-- PgBouncerç®¡ç†ç•Œé¢ï¼š
-- SHOW POOLS;
-- SHOW STATS;
```

### è§£å†³

```ini
# PgBounceré…ç½®ä¼˜åŒ–

# 1. é€‰æ‹©åˆé€‚çš„pool_mode
# transaction: é€‚åˆOLTPï¼ˆæ¨èï¼‰
# session: é€‚åˆéœ€è¦ä¼šè¯çŠ¶æ€çš„åœºæ™¯
# statement: é€‚åˆç®€å•æŸ¥è¯¢

pool_mode = transaction

# 2. è®¾ç½®åˆç†çš„è¿æ¥æ± å¤§å°
# å…¬å¼ï¼šmax_client_conn / max_pool_size â‰ˆ 10-20
max_client_conn = 1000
default_pool_size = 25  # æ¯ä¸ªæ•°æ®åº“çš„è¿æ¥æ•°

# 3. è®¾ç½®è¶…æ—¶
server_idle_timeout = 600  # 10åˆ†é’Ÿ
query_timeout = 0  # ä¸é™åˆ¶æŸ¥è¯¢æ—¶é—´ï¼ˆç”±PostgreSQLæ§åˆ¶ï¼‰
query_wait_timeout = 120  # ç­‰å¾…å¯ç”¨è¿æ¥çš„æ—¶é—´

# 4. å¯ç”¨è¿æ¥å¤ç”¨
reserve_pool_size = 5  # ä¿ç•™è¿æ¥æ•°
reserve_pool_timeout = 3  # ç­‰å¾…ä¿ç•™è¿æ¥çš„æ—¶é—´
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
