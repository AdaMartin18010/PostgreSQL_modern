---
> **📋 文档来源**: `PostgreSQL\runbook\变更与回滚.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# Runbook：变更与回滚（PostgreSQL 18+）

> **文档编号**: RUNBOOK-变更回滚
> **最后更新**: 2025年1月
> **技术版本**: PostgreSQL 18+
> **用途**: PostgreSQL变更管理与回滚生产指南

## 📑 目录

- [Runbook：变更与回滚（PostgreSQL 18+）](#runbook变更与回滚postgresql-18)
  - [📑 目录](#-目录)
  - [1. 范围](#1-范围)
  - [2. 原则](#2-原则)
    - [2.1 核心原则](#21-核心原则)
    - [2.2 变更窗口](#22-变更窗口)
  - [3. 变更流程](#3-变更流程)
    - [3.1 变更流程](#31-变更流程)
    - [3.2 变更步骤](#32-变更步骤)
  - [4. 回滚策略](#4-回滚策略)
    - [4.1 参数回滚](#41-参数回滚)
    - [4.2 DDL回滚](#42-ddl回滚)
    - [4.3 索引回滚](#43-索引回滚)
    - [7.3 版本升级](#73-版本升级)
  - [8. 最佳实践](#8-最佳实践)
    - [8.1 变更管理最佳实践](#81-变更管理最佳实践)
    - [8.2 回滚最佳实践](#82-回滚最佳实践)

---

## 1. 范围

**变更类型**：

| 变更类型 | 说明 | 风险等级 |
|---------|------|---------|
| **参数变更** | postgresql.conf参数调整 | 中 |
| **DDL变更** | 表结构、索引变更 | 高 |
| **索引变更** | 创建、重建、删除索引 | 中 |
| **分区变更** | 分区表结构调整 | 高 |
| **版本升级** | PostgreSQL主版本升级 | 高 |
| **扩展变更** | 扩展安装、升级 | 中 |

**变更范围**：

- 单实例变更
- 集群变更（主从）
- 多实例变更（分片）

---

## 2. 原则

### 2.1 核心原则

**变更原则**：

1. **蓝绿/金丝雀部署**：
   - 优先对读流量试点
   - 逐步扩大范围
   - 验证无问题后全量

2. **可回滚**：
   - 保留旧结构与数据路径
   - 影子索引/表
   - 一键回滚脚本

3. **可观测**：
   - 变更前后指标对比
   - 实时监控
   - 告警设置

### 2.2 变更窗口

**变更时间选择**：

- ✅ 业务低峰期
- ✅ 只读期
- ✅ 维护窗口
- ❌ 业务高峰期
- ❌ 重要活动期间

**变更通知**：

- 提前1周通知
- 变更前1小时提醒
- 变更后确认

---

## 3. 变更流程

### 3.1 变更流程

**标准变更流程**：

```mermaid
graph TD
    A[变更申请] --> B[影响评估]
    B --> C[回滚方案]
    C --> D[变更审批]
    D --> E[变更窗口]
    E --> F[执行变更]
    F --> G[验证]
    G --> H{验证通过?}
    H -->|是| I[完成]
    H -->|否| J[回滚]
    J --> K[问题分析]
    K --> B
```

### 3.2 变更步骤

**步骤1：评审**（变更前1周）

**影响评估**：

- 影响范围分析
- 性能影响评估
- 业务影响评估

**回滚路径**：

- 回滚方案设计
- 回滚脚本准备
- 回滚测试

**验证计划**：

- 功能验证
- 性能验证
- 一致性验证

**步骤2：变更窗口**（变更执行）

**准备阶段**：

- 冻结长事务
- 通知相关人员
- 准备监控

**执行阶段**：

- 分批执行
- 幂等脚本
- 错误即停

**步骤3：验证**（变更后）

**功能验证**：

```sql
-- 验证功能正常（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM critical_table
LIMIT 100;

-- 注意：函数调用需要根据实际函数调整
-- SELECT * FROM critical_function();
```

**性能验证**：

```sql
-- 对比变更前后性能
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM critical_table WHERE ...;
```

**一致性验证**：

```sql
-- 验证数据一致性（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM table1
LIMIT 100;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM table2
LIMIT 100;
```

**步骤4：回滚**（如需要）

**回滚条件**：

- 功能异常
- 性能严重下降
- 数据不一致

**回滚步骤**：

- 执行回滚脚本
- 验证回滚结果
- 问题分析

---

## 4. 回滚策略

### 4.1 参数回滚

**参数变更**：

```sql
-- 1. 保存原配置（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'max_connections')
ORDER BY name
LIMIT 100;

-- 2. 变更参数（带错误处理）
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET shared_buffers = '16GB';
            PERFORM pg_reload_conf();
            RAISE NOTICE '参数变更成功，配置已重新加载';
        ELSE
            RAISE EXCEPTION '需要超级用户权限才能修改系统配置';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING '权限不足，无法修改系统配置';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '变更参数失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. 验证（带错误处理）
DO $$
DECLARE
    shared_buffers_value text;
BEGIN
    BEGIN
        SHOW shared_buffers INTO shared_buffers_value;
        RAISE NOTICE '当前shared_buffers值: %', shared_buffers_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '获取shared_buffers值失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. 回滚（如需要）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET shared_buffers = '8GB';
            PERFORM pg_reload_conf();
            RAISE NOTICE '参数回滚成功，配置已重新加载';
        ELSE
            RAISE EXCEPTION '需要超级用户权限才能修改系统配置';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING '权限不足，无法修改系统配置';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '回滚参数失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

```

**回滚脚本**：

```bash
#!/bin/bash
# rollback_params.sh

# 恢复原配置
psql -c "ALTER SYSTEM SET shared_buffers = '8GB';"
psql -c "ALTER SYSTEM SET work_mem = '4MB';"
psql -c "SELECT pg_reload_conf();"

# 验证
psql -c "SHOW shared_buffers;"
psql -c "SHOW work_mem;"
```

### 4.2 DDL回滚

**DDL变更策略**：

```sql
-- 1. 创建新表（保留旧表）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents_new') THEN
                CREATE TABLE documents_new (
                    LIKE documents INCLUDING ALL,
                    new_column TEXT
                );
                RAISE NOTICE '新表 documents_new 创建成功';
            ELSE
                RAISE NOTICE '新表 documents_new 已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过新表创建';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建新表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 数据迁移（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents_new') AND
           EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            INSERT INTO documents_new
            SELECT *, 'default_value' AS new_column
            FROM documents;
            RAISE NOTICE '数据迁移成功';
        ELSE
            RAISE WARNING '表不存在，跳过数据迁移';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '数据迁移失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. 切换表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') AND
           EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents_new') THEN
            BEGIN;
            ALTER TABLE documents RENAME TO documents_old;
            ALTER TABLE documents_new RENAME TO documents;
            COMMIT;
            RAISE NOTICE '表切换成功';
        ELSE
            RAISE WARNING '表不存在，跳过表切换';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '表切换失败: %', SQLERRM;
            ROLLBACK;
            RAISE;
    END;
END $$;
```

-- 4. 回滚（如需要）
BEGIN;
ALTER TABLE documents RENAME TO documents_new;
ALTER TABLE documents_old RENAME TO documents;
COMMIT;

```

**视图桥接**：

```sql
-- 使用视图桥接新旧表（带错误处理）
DO $$
BEGIN
    BEGIN
        DROP VIEW IF EXISTS documents_view;
        CREATE VIEW documents_view AS
        SELECT
            id,
            content,
            COALESCE(new_column, 'default') AS new_column
        FROM documents_old
        UNION ALL
        SELECT * FROM documents_new;
        RAISE NOTICE '视图 documents_view 创建成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建视图失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.3 索引回滚

**在线索引创建**：

```sql
-- 1. 创建新索引（CONCURRENTLY，不锁表）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (
                SELECT 1 FROM pg_indexes
                WHERE indexname = 'documents_new_idx'
            ) THEN
                CREATE INDEX CONCURRENTLY documents_new_idx
                ON documents (new_column);
                RAISE NOTICE '索引创建成功';
            ELSE
                RAISE NOTICE '索引已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过索引创建';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '索引已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 验证索引（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_indexes
WHERE indexname = 'documents_new_idx'
LIMIT 100;

-- 3. 切换索引（通过查询计划器自动选择）
-- 或手动指定索引（带错误处理）
DO $$
BEGIN
    BEGIN
        SET enable_seqscan = off;
        SET enable_indexscan = on;
        RAISE NOTICE '索引扫描参数设置成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '设置索引扫描参数失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. 删除旧索引（如需要）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE indexname = 'documents_old_idx'
        ) THEN
            DROP INDEX CONCURRENTLY documents_old_idx;
            RAISE NOTICE '旧索引删除成功';
        ELSE
            RAISE WARNING '索引 documents_old_idx 不存在，跳过删除';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '删除索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

```

**影子索引策略**：

```sql
-- 1. 创建影子索引（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (
                SELECT 1 FROM pg_indexes
                WHERE indexname = 'documents_shadow_idx'
            ) THEN
                CREATE INDEX CONCURRENTLY documents_shadow_idx
                ON documents (column_name);
                RAISE NOTICE '影子索引创建成功';
            ELSE
                RAISE NOTICE '影子索引已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过影子索引创建';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '索引已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建影子索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 验证性能（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents WHERE column_name = 'value'
LIMIT 100;

-- 3. 切换索引（重命名）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'documents_old_idx') AND
           EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'documents_shadow_idx') THEN
            ALTER INDEX documents_old_idx RENAME TO documents_idx_backup;
            ALTER INDEX documents_shadow_idx RENAME TO documents_idx;
            RAISE NOTICE '索引切换成功';
        ELSE
            RAISE WARNING '索引不存在，跳过索引切换';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '切换索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. 回滚（如需要）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'documents_idx') AND
           EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'documents_idx_backup') THEN
            ALTER INDEX documents_idx RENAME TO documents_shadow_idx;
            ALTER INDEX documents_idx_backup RENAME TO documents_idx;
            RAISE NOTICE '索引回滚成功';
        ELSE
            RAISE WARNING '索引不存在，跳过索引回滚';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '回滚索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

```

---

## 5. 检查清单

### 5.1 变更前检查

**变更前检查清单**：

- [ ] 变更脚本已干跑（非生产环境）且通过
- [ ] 受影响对象与依赖清单已确认（视图/触发器/函数/订阅）
- [ ] 监控看板与门限已设定（前/中/后对比）
- [ ] 回滚脚本与步骤已校验
- [ ] 变更窗口已确定（低峰期）
- [ ] 相关人员已通知
- [ ] 备份已完成
- [ ] 变更影响评估已完成

### 5.2 变更中检查

**变更中检查清单**：

- [ ] 变更步骤按计划执行
- [ ] 监控指标正常
- [ ] 无错误日志
- [ ] 性能指标正常
- [ ] 功能验证通过

### 5.3 变更后检查

**变更后检查清单**：

- [ ] 功能验证通过
- [ ] 性能验证通过
- [ ] 数据一致性验证通过
- [ ] 监控指标正常
- [ ] 无告警
- [ ] 文档已更新

---

## 6. 演练频率

### 6.1 演练计划

**演练频率**：

| 演练类型 | 频率 | 时长 | 人员 |
|---------|------|------|------|
| **桌面演练** | 每周 | 30分钟 | DBA团队 |
| **部分演练** | 每月 | 1小时 | DBA+开发 |
| **全面演练** | 每季度 | 4小时 | 全团队 |

### 6.2 演练内容

**桌面演练**：

- 讨论变更步骤
- 熟悉回滚流程
- 检查清单审查

**部分演练**：

- 恢复单个数据库
- 验证回滚步骤
- 性能测试

**全面演练**：

- 完整灾难恢复
- 验证RTO/RPO
- 端到端测试

---

## 7. 变更类型详解

### 7.1 参数变更

**PostgreSQL 18参数变更**：

```sql
-- 1. 异步I/O配置（PostgreSQL 18新特性）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            -- 注意：io_method参数可能不存在，需要根据实际PostgreSQL版本调整
            -- ALTER SYSTEM SET io_method = 'io_uring';  -- Linux only
            PERFORM pg_reload_conf();
            RAISE NOTICE '配置已重新加载';
        ELSE
            RAISE EXCEPTION '需要超级用户权限才能修改系统配置';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING '权限不足，无法修改系统配置';
            RAISE;
        WHEN undefined_object THEN
            RAISE NOTICE 'io_method参数不存在，跳过设置';
        WHEN OTHERS THEN
            RAISE WARNING '设置异步I/O配置失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. WAL压缩（PostgreSQL 18新特性）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET wal_compression = 'lz4';
            PERFORM pg_reload_conf();
            RAISE NOTICE 'WAL压缩配置已更新，配置已重新加载';
        ELSE
            RAISE EXCEPTION '需要超级用户权限才能修改系统配置';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING '权限不足，无法修改系统配置';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '设置WAL压缩配置失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. 内存参数（带错误处理）
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET shared_buffers = '16GB';
            ALTER SYSTEM SET effective_cache_size = '48GB';
            PERFORM pg_reload_conf();
            RAISE NOTICE '内存参数已更新，配置已重新加载';
        ELSE
            RAISE EXCEPTION '需要超级用户权限才能修改系统配置';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING '权限不足，无法修改系统配置';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '设置内存参数失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**变更验证**：

```sql
-- 验证参数变更（带错误处理）
DO $$
DECLARE
    io_method_value text;
    wal_compression_value text;
    shared_buffers_value text;
BEGIN
    BEGIN
        -- 注意：io_method可能不存在
        BEGIN
            SHOW io_method INTO io_method_value;
            RAISE NOTICE 'io_method: %', io_method_value;
        EXCEPTION
            WHEN undefined_object THEN
                RAISE NOTICE 'io_method参数不存在';
        END;

        SHOW wal_compression INTO wal_compression_value;
        SHOW shared_buffers INTO shared_buffers_value;
        RAISE NOTICE 'wal_compression: %, shared_buffers: %', wal_compression_value, shared_buffers_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '获取参数值失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 验证性能（带性能测试）
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table LIMIT 1000;
```

```

### 7.2 DDL变更

**表结构变更**：

```sql
-- 1. 添加列（PostgreSQL 18支持更快）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (
                SELECT 1 FROM information_schema.columns
                WHERE table_name = 'documents' AND column_name = 'new_column'
            ) THEN
                ALTER TABLE documents
                ADD COLUMN new_column TEXT DEFAULT 'default_value';
                RAISE NOTICE '列添加成功';
            ELSE
                RAISE NOTICE '列已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过添加列';
        END IF;
    EXCEPTION
        WHEN duplicate_column THEN
            RAISE NOTICE '列已存在';
        WHEN OTHERS THEN
            RAISE WARNING '添加列失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 修改列类型（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'documents' AND column_name = 'content'
        ) THEN
            ALTER TABLE documents
            ALTER COLUMN content TYPE TEXT;
            RAISE NOTICE '列类型修改成功';
        ELSE
            RAISE WARNING '列 content 不存在，跳过类型修改';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '修改列类型失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. 添加约束（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (
                SELECT 1 FROM information_schema.table_constraints
                WHERE table_name = 'documents' AND constraint_name = 'check_content_length'
            ) THEN
                ALTER TABLE documents
                ADD CONSTRAINT check_content_length
                CHECK (length(content) > 0);
                RAISE NOTICE '约束添加成功';
            ELSE
                RAISE NOTICE '约束已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过添加约束';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE '约束已存在';
        WHEN OTHERS THEN
            RAISE WARNING '添加约束失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**分区变更**：

```sql
-- 1. 添加分区（PostgreSQL 18优化）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents') THEN
            IF NOT EXISTS (
                SELECT 1 FROM information_schema.tables
                WHERE table_name = 'documents_202501'
            ) THEN
                CREATE TABLE documents_202501 PARTITION OF documents
                FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
                RAISE NOTICE '分区创建成功';
            ELSE
                RAISE NOTICE '分区已存在';
            END IF;
        ELSE
            RAISE WARNING '表 documents 不存在，跳过分区创建';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '分区已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建分区失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 删除分区（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'documents_202412') THEN
            DROP TABLE documents_202412;
            RAISE NOTICE '分区删除成功';
        ELSE
            RAISE WARNING '分区 documents_202412 不存在，跳过删除';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '删除分区失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 7.3 版本升级

**PostgreSQL 18升级**：

```bash
# 1. 使用pg_upgrade（PostgreSQL 18保留统计信息）
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data \
  --check

# 2. 执行升级
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data

# 3. 验证升级
/usr/lib/postgresql/18/bin/postgres --version
```

**零停机升级**：

```bash
# 1. 升级从库
# 2. 切换主从
# 3. 升级原主库
# 4. 切换回来
```

---

## 8. 最佳实践

### 8.1 变更管理最佳实践

**变更原则**：

- ✅ 小步快跑
- ✅ 充分测试
- ✅ 可回滚
- ✅ 可观测

**变更流程**：

- ✅ 标准化流程
- ✅ 检查清单
- ✅ 审批机制
- ✅ 文档记录

### 8.2 回滚最佳实践

**回滚准备**：

- ✅ 回滚脚本准备
- ✅ 回滚测试
- ✅ 回滚时间窗口
- ✅ 回滚影响评估

**回滚执行**：

- ✅ 快速回滚
- ✅ 验证回滚结果
- ✅ 问题分析
- ✅ 改进措施

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
**文档编号**: RUNBOOK-变更回滚
