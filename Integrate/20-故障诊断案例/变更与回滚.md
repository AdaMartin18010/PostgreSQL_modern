---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\å˜æ›´ä¸å›æ»š.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šå˜æ›´ä¸å›æ»šï¼ˆPostgreSQL 18+ï¼‰

> **æ–‡æ¡£ç¼–å·**: RUNBOOK-å˜æ›´å›æ»š
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **ç”¨é€”**: PostgreSQLå˜æ›´ç®¡ç†ä¸å›æ»šç”Ÿäº§æŒ‡å—

## ğŸ“‘ ç›®å½•

- [Runbookï¼šå˜æ›´ä¸å›æ»šï¼ˆPostgreSQL 18+ï¼‰](#runbookå˜æ›´ä¸å›æ»špostgresql-18)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. èŒƒå›´](#1-èŒƒå›´)
  - [2. åŸåˆ™](#2-åŸåˆ™)
    - [2.1 æ ¸å¿ƒåŸåˆ™](#21-æ ¸å¿ƒåŸåˆ™)
    - [2.2 å˜æ›´çª—å£](#22-å˜æ›´çª—å£)
  - [3. å˜æ›´æµç¨‹](#3-å˜æ›´æµç¨‹)
    - [3.1 å˜æ›´æµç¨‹](#31-å˜æ›´æµç¨‹)
    - [3.2 å˜æ›´æ­¥éª¤](#32-å˜æ›´æ­¥éª¤)
  - [4. å›æ»šç­–ç•¥](#4-å›æ»šç­–ç•¥)
    - [4.1 å‚æ•°å›æ»š](#41-å‚æ•°å›æ»š)
    - [4.2 DDLå›æ»š](#42-ddlå›æ»š)
    - [4.3 ç´¢å¼•å›æ»š](#43-ç´¢å¼•å›æ»š)
  - [5. æ£€æŸ¥æ¸…å•](#5-æ£€æŸ¥æ¸…å•)
    - [5.1 å˜æ›´å‰æ£€æŸ¥](#51-å˜æ›´å‰æ£€æŸ¥)
    - [5.2 å˜æ›´ä¸­æ£€æŸ¥](#52-å˜æ›´ä¸­æ£€æŸ¥)
    - [5.3 å˜æ›´åæ£€æŸ¥](#53-å˜æ›´åæ£€æŸ¥)
  - [6. æ¼”ç»ƒé¢‘ç‡](#6-æ¼”ç»ƒé¢‘ç‡)
    - [6.1 æ¼”ç»ƒè®¡åˆ’](#61-æ¼”ç»ƒè®¡åˆ’)
    - [6.2 æ¼”ç»ƒå†…å®¹](#62-æ¼”ç»ƒå†…å®¹)
  - [7. å˜æ›´ç±»å‹è¯¦è§£](#7-å˜æ›´ç±»å‹è¯¦è§£)
    - [7.1 å‚æ•°å˜æ›´](#71-å‚æ•°å˜æ›´)
    - [7.2 DDLå˜æ›´](#72-ddlå˜æ›´)
    - [7.3 ç‰ˆæœ¬å‡çº§](#73-ç‰ˆæœ¬å‡çº§)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å˜æ›´ç®¡ç†æœ€ä½³å®è·µ](#81-å˜æ›´ç®¡ç†æœ€ä½³å®è·µ)
    - [8.2 å›æ»šæœ€ä½³å®è·µ](#82-å›æ»šæœ€ä½³å®è·µ)

---

## 1. èŒƒå›´

**å˜æ›´ç±»å‹**ï¼š

| å˜æ›´ç±»å‹ | è¯´æ˜ | é£é™©ç­‰çº§ |
|---------|------|---------|
| **å‚æ•°å˜æ›´** | postgresql.confå‚æ•°è°ƒæ•´ | ä¸­ |
| **DDLå˜æ›´** | è¡¨ç»“æ„ã€ç´¢å¼•å˜æ›´ | é«˜ |
| **ç´¢å¼•å˜æ›´** | åˆ›å»ºã€é‡å»ºã€åˆ é™¤ç´¢å¼• | ä¸­ |
| **åˆ†åŒºå˜æ›´** | åˆ†åŒºè¡¨ç»“æ„è°ƒæ•´ | é«˜ |
| **ç‰ˆæœ¬å‡çº§** | PostgreSQLä¸»ç‰ˆæœ¬å‡çº§ | é«˜ |
| **æ‰©å±•å˜æ›´** | æ‰©å±•å®‰è£…ã€å‡çº§ | ä¸­ |

**å˜æ›´èŒƒå›´**ï¼š

- å•å®ä¾‹å˜æ›´
- é›†ç¾¤å˜æ›´ï¼ˆä¸»ä»ï¼‰
- å¤šå®ä¾‹å˜æ›´ï¼ˆåˆ†ç‰‡ï¼‰

---

## 2. åŸåˆ™

### 2.1 æ ¸å¿ƒåŸåˆ™

**å˜æ›´åŸåˆ™**ï¼š

1. **è“ç»¿/é‡‘ä¸é›€éƒ¨ç½²**ï¼š
   - ä¼˜å…ˆå¯¹è¯»æµé‡è¯•ç‚¹
   - é€æ­¥æ‰©å¤§èŒƒå›´
   - éªŒè¯æ— é—®é¢˜åå…¨é‡

2. **å¯å›æ»š**ï¼š
   - ä¿ç•™æ—§ç»“æ„ä¸æ•°æ®è·¯å¾„
   - å½±å­ç´¢å¼•/è¡¨
   - ä¸€é”®å›æ»šè„šæœ¬

3. **å¯è§‚æµ‹**ï¼š
   - å˜æ›´å‰åæŒ‡æ ‡å¯¹æ¯”
   - å®æ—¶ç›‘æ§
   - å‘Šè­¦è®¾ç½®

### 2.2 å˜æ›´çª—å£

**å˜æ›´æ—¶é—´é€‰æ‹©**ï¼š

- âœ… ä¸šåŠ¡ä½å³°æœŸ
- âœ… åªè¯»æœŸ
- âœ… ç»´æŠ¤çª—å£
- âŒ ä¸šåŠ¡é«˜å³°æœŸ
- âŒ é‡è¦æ´»åŠ¨æœŸé—´

**å˜æ›´é€šçŸ¥**ï¼š

- æå‰1å‘¨é€šçŸ¥
- å˜æ›´å‰1å°æ—¶æé†’
- å˜æ›´åç¡®è®¤

---

## 3. å˜æ›´æµç¨‹

### 3.1 å˜æ›´æµç¨‹

**æ ‡å‡†å˜æ›´æµç¨‹**ï¼š

```mermaid
graph TD
    A[å˜æ›´ç”³è¯·] --> B[å½±å“è¯„ä¼°]
    B --> C[å›æ»šæ–¹æ¡ˆ]
    C --> D[å˜æ›´å®¡æ‰¹]
    D --> E[å˜æ›´çª—å£]
    E --> F[æ‰§è¡Œå˜æ›´]
    F --> G[éªŒè¯]
    G --> H{éªŒè¯é€šè¿‡?}
    H -->|æ˜¯| I[å®Œæˆ]
    H -->|å¦| J[å›æ»š]
    J --> K[é—®é¢˜åˆ†æ]
    K --> B
```

### 3.2 å˜æ›´æ­¥éª¤

**æ­¥éª¤1ï¼šè¯„å®¡**ï¼ˆå˜æ›´å‰1å‘¨ï¼‰

**å½±å“è¯„ä¼°**ï¼š

- å½±å“èŒƒå›´åˆ†æ
- æ€§èƒ½å½±å“è¯„ä¼°
- ä¸šåŠ¡å½±å“è¯„ä¼°

**å›æ»šè·¯å¾„**ï¼š

- å›æ»šæ–¹æ¡ˆè®¾è®¡
- å›æ»šè„šæœ¬å‡†å¤‡
- å›æ»šæµ‹è¯•

**éªŒè¯è®¡åˆ’**ï¼š

- åŠŸèƒ½éªŒè¯
- æ€§èƒ½éªŒè¯
- ä¸€è‡´æ€§éªŒè¯

**æ­¥éª¤2ï¼šå˜æ›´çª—å£**ï¼ˆå˜æ›´æ‰§è¡Œï¼‰

**å‡†å¤‡é˜¶æ®µ**ï¼š

- å†»ç»“é•¿äº‹åŠ¡
- é€šçŸ¥ç›¸å…³äººå‘˜
- å‡†å¤‡ç›‘æ§

**æ‰§è¡Œé˜¶æ®µ**ï¼š

- åˆ†æ‰¹æ‰§è¡Œ
- å¹‚ç­‰è„šæœ¬
- é”™è¯¯å³åœ

**æ­¥éª¤3ï¼šéªŒè¯**ï¼ˆå˜æ›´åï¼‰

**åŠŸèƒ½éªŒè¯**ï¼š

```sql
-- éªŒè¯åŠŸèƒ½æ­£å¸¸
SELECT count(*) FROM critical_table;
SELECT * FROM critical_function();
```

**æ€§èƒ½éªŒè¯**ï¼š

```sql
-- å¯¹æ¯”å˜æ›´å‰åæ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM critical_table WHERE ...;
```

**ä¸€è‡´æ€§éªŒè¯**ï¼š

```sql
-- éªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT count(*) FROM table1;
SELECT count(*) FROM table2;
```

**æ­¥éª¤4ï¼šå›æ»š**ï¼ˆå¦‚éœ€è¦ï¼‰

**å›æ»šæ¡ä»¶**ï¼š

- åŠŸèƒ½å¼‚å¸¸
- æ€§èƒ½ä¸¥é‡ä¸‹é™
- æ•°æ®ä¸ä¸€è‡´

**å›æ»šæ­¥éª¤**ï¼š

- æ‰§è¡Œå›æ»šè„šæœ¬
- éªŒè¯å›æ»šç»“æœ
- é—®é¢˜åˆ†æ

---

## 4. å›æ»šç­–ç•¥

### 4.1 å‚æ•°å›æ»š

**å‚æ•°å˜æ›´**ï¼š

```sql
-- 1. ä¿å­˜åŸé…ç½®
SELECT name, setting FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'max_connections')
ORDER BY name;

-- 2. å˜æ›´å‚æ•°
ALTER SYSTEM SET shared_buffers = '16GB';
SELECT pg_reload_conf();

-- 3. éªŒè¯
SHOW shared_buffers;

-- 4. å›æ»šï¼ˆå¦‚éœ€è¦ï¼‰
ALTER SYSTEM SET shared_buffers = '8GB';
SELECT pg_reload_conf();
```

**å›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# rollback_params.sh

# æ¢å¤åŸé…ç½®
psql -c "ALTER SYSTEM SET shared_buffers = '8GB';"
psql -c "ALTER SYSTEM SET work_mem = '4MB';"
psql -c "SELECT pg_reload_conf();"

# éªŒè¯
psql -c "SHOW shared_buffers;"
psql -c "SHOW work_mem;"
```

### 4.2 DDLå›æ»š

**DDLå˜æ›´ç­–ç•¥**ï¼š

```sql
-- 1. åˆ›å»ºæ–°è¡¨ï¼ˆä¿ç•™æ—§è¡¨ï¼‰
CREATE TABLE documents_new (
    LIKE documents INCLUDING ALL,
    new_column TEXT
);

-- 2. æ•°æ®è¿ç§»
INSERT INTO documents_new
SELECT *, 'default_value' AS new_column
FROM documents;

-- 3. åˆ‡æ¢è¡¨
BEGIN;
ALTER TABLE documents RENAME TO documents_old;
ALTER TABLE documents_new RENAME TO documents;
COMMIT;

-- 4. å›æ»šï¼ˆå¦‚éœ€è¦ï¼‰
BEGIN;
ALTER TABLE documents RENAME TO documents_new;
ALTER TABLE documents_old RENAME TO documents;
COMMIT;
```

**è§†å›¾æ¡¥æ¥**ï¼š

```sql
-- ä½¿ç”¨è§†å›¾æ¡¥æ¥æ–°æ—§è¡¨
CREATE VIEW documents_view AS
SELECT
    id,
    content,
    COALESCE(new_column, 'default') AS new_column
FROM documents_old
UNION ALL
SELECT * FROM documents_new;
```

### 4.3 ç´¢å¼•å›æ»š

**åœ¨çº¿ç´¢å¼•åˆ›å»º**ï¼š

```sql
-- 1. åˆ›å»ºæ–°ç´¢å¼•ï¼ˆCONCURRENTLYï¼Œä¸é”è¡¨ï¼‰
CREATE INDEX CONCURRENTLY documents_new_idx
ON documents (new_column);

-- 2. éªŒè¯ç´¢å¼•
SELECT * FROM pg_indexes
WHERE indexname = 'documents_new_idx';

-- 3. åˆ‡æ¢ç´¢å¼•ï¼ˆé€šè¿‡æŸ¥è¯¢è®¡åˆ’å™¨è‡ªåŠ¨é€‰æ‹©ï¼‰
-- æˆ–æ‰‹åŠ¨æŒ‡å®šç´¢å¼•
SET enable_seqscan = off;
SET enable_indexscan = on;

-- 4. åˆ é™¤æ—§ç´¢å¼•ï¼ˆå¦‚éœ€è¦ï¼‰
DROP INDEX CONCURRENTLY documents_old_idx;
```

**å½±å­ç´¢å¼•ç­–ç•¥**ï¼š

```sql
-- 1. åˆ›å»ºå½±å­ç´¢å¼•
CREATE INDEX CONCURRENTLY documents_shadow_idx
ON documents (column_name);

-- 2. éªŒè¯æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents WHERE column_name = 'value';

-- 3. åˆ‡æ¢ç´¢å¼•ï¼ˆé‡å‘½åï¼‰
ALTER INDEX documents_old_idx RENAME TO documents_idx_backup;
ALTER INDEX documents_shadow_idx RENAME TO documents_idx;

-- 4. å›æ»šï¼ˆå¦‚éœ€è¦ï¼‰
ALTER INDEX documents_idx RENAME TO documents_shadow_idx;
ALTER INDEX documents_idx_backup RENAME TO documents_idx;
```

---

## 5. æ£€æŸ¥æ¸…å•

### 5.1 å˜æ›´å‰æ£€æŸ¥

**å˜æ›´å‰æ£€æŸ¥æ¸…å•**ï¼š

- [ ] å˜æ›´è„šæœ¬å·²å¹²è·‘ï¼ˆéç”Ÿäº§ç¯å¢ƒï¼‰ä¸”é€šè¿‡
- [ ] å—å½±å“å¯¹è±¡ä¸ä¾èµ–æ¸…å•å·²ç¡®è®¤ï¼ˆè§†å›¾/è§¦å‘å™¨/å‡½æ•°/è®¢é˜…ï¼‰
- [ ] ç›‘æ§çœ‹æ¿ä¸é—¨é™å·²è®¾å®šï¼ˆå‰/ä¸­/åå¯¹æ¯”ï¼‰
- [ ] å›æ»šè„šæœ¬ä¸æ­¥éª¤å·²æ ¡éªŒ
- [ ] å˜æ›´çª—å£å·²ç¡®å®šï¼ˆä½å³°æœŸï¼‰
- [ ] ç›¸å…³äººå‘˜å·²é€šçŸ¥
- [ ] å¤‡ä»½å·²å®Œæˆ
- [ ] å˜æ›´å½±å“è¯„ä¼°å·²å®Œæˆ

### 5.2 å˜æ›´ä¸­æ£€æŸ¥

**å˜æ›´ä¸­æ£€æŸ¥æ¸…å•**ï¼š

- [ ] å˜æ›´æ­¥éª¤æŒ‰è®¡åˆ’æ‰§è¡Œ
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] æ— é”™è¯¯æ—¥å¿—
- [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸
- [ ] åŠŸèƒ½éªŒè¯é€šè¿‡

### 5.3 å˜æ›´åæ£€æŸ¥

**å˜æ›´åæ£€æŸ¥æ¸…å•**ï¼š

- [ ] åŠŸèƒ½éªŒè¯é€šè¿‡
- [ ] æ€§èƒ½éªŒè¯é€šè¿‡
- [ ] æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] æ— å‘Šè­¦
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## 6. æ¼”ç»ƒé¢‘ç‡

### 6.1 æ¼”ç»ƒè®¡åˆ’

**æ¼”ç»ƒé¢‘ç‡**ï¼š

| æ¼”ç»ƒç±»å‹ | é¢‘ç‡ | æ—¶é•¿ | äººå‘˜ |
|---------|------|------|------|
| **æ¡Œé¢æ¼”ç»ƒ** | æ¯å‘¨ | 30åˆ†é’Ÿ | DBAå›¢é˜Ÿ |
| **éƒ¨åˆ†æ¼”ç»ƒ** | æ¯æœˆ | 1å°æ—¶ | DBA+å¼€å‘ |
| **å…¨é¢æ¼”ç»ƒ** | æ¯å­£åº¦ | 4å°æ—¶ | å…¨å›¢é˜Ÿ |

### 6.2 æ¼”ç»ƒå†…å®¹

**æ¡Œé¢æ¼”ç»ƒ**ï¼š

- è®¨è®ºå˜æ›´æ­¥éª¤
- ç†Ÿæ‚‰å›æ»šæµç¨‹
- æ£€æŸ¥æ¸…å•å®¡æŸ¥

**éƒ¨åˆ†æ¼”ç»ƒ**ï¼š

- æ¢å¤å•ä¸ªæ•°æ®åº“
- éªŒè¯å›æ»šæ­¥éª¤
- æ€§èƒ½æµ‹è¯•

**å…¨é¢æ¼”ç»ƒ**ï¼š

- å®Œæ•´ç¾éš¾æ¢å¤
- éªŒè¯RTO/RPO
- ç«¯åˆ°ç«¯æµ‹è¯•

---

## 7. å˜æ›´ç±»å‹è¯¦è§£

### 7.1 å‚æ•°å˜æ›´

**PostgreSQL 18å‚æ•°å˜æ›´**ï¼š

```sql
-- 1. å¼‚æ­¥I/Oé…ç½®ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
ALTER SYSTEM SET io_method = 'io_uring';  -- Linux only
SELECT pg_reload_conf();

-- 2. WALå‹ç¼©ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
ALTER SYSTEM SET wal_compression = 'lz4';
SELECT pg_reload_conf();

-- 3. å†…å­˜å‚æ•°
ALTER SYSTEM SET shared_buffers = '16GB';
ALTER SYSTEM SET effective_cache_size = '48GB';
SELECT pg_reload_conf();
```

**å˜æ›´éªŒè¯**ï¼š

```sql
-- éªŒè¯å‚æ•°å˜æ›´
SHOW io_method;
SHOW wal_compression;
SHOW shared_buffers;

-- éªŒè¯æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM large_table LIMIT 1000;
```

### 7.2 DDLå˜æ›´

**è¡¨ç»“æ„å˜æ›´**ï¼š

```sql
-- 1. æ·»åŠ åˆ—ï¼ˆPostgreSQL 18æ”¯æŒæ›´å¿«ï¼‰
ALTER TABLE documents
ADD COLUMN new_column TEXT DEFAULT 'default_value';

-- 2. ä¿®æ”¹åˆ—ç±»å‹
ALTER TABLE documents
ALTER COLUMN content TYPE TEXT;

-- 3. æ·»åŠ çº¦æŸ
ALTER TABLE documents
ADD CONSTRAINT check_content_length
CHECK (length(content) > 0);
```

**åˆ†åŒºå˜æ›´**ï¼š

```sql
-- 1. æ·»åŠ åˆ†åŒºï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
CREATE TABLE documents_202501 PARTITION OF documents
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 2. åˆ é™¤åˆ†åŒº
DROP TABLE documents_202412;
```

### 7.3 ç‰ˆæœ¬å‡çº§

**PostgreSQL 18å‡çº§**ï¼š

```bash
# 1. ä½¿ç”¨pg_upgradeï¼ˆPostgreSQL 18ä¿ç•™ç»Ÿè®¡ä¿¡æ¯ï¼‰
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data \
  --check

# 2. æ‰§è¡Œå‡çº§
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data

# 3. éªŒè¯å‡çº§
/usr/lib/postgresql/18/bin/postgres --version
```

**é›¶åœæœºå‡çº§**ï¼š

```bash
# 1. å‡çº§ä»åº“
# 2. åˆ‡æ¢ä¸»ä»
# 3. å‡çº§åŸä¸»åº“
# 4. åˆ‡æ¢å›æ¥
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å˜æ›´ç®¡ç†æœ€ä½³å®è·µ

**å˜æ›´åŸåˆ™**ï¼š

- âœ… å°æ­¥å¿«è·‘
- âœ… å……åˆ†æµ‹è¯•
- âœ… å¯å›æ»š
- âœ… å¯è§‚æµ‹

**å˜æ›´æµç¨‹**ï¼š

- âœ… æ ‡å‡†åŒ–æµç¨‹
- âœ… æ£€æŸ¥æ¸…å•
- âœ… å®¡æ‰¹æœºåˆ¶
- âœ… æ–‡æ¡£è®°å½•

### 8.2 å›æ»šæœ€ä½³å®è·µ

**å›æ»šå‡†å¤‡**ï¼š

- âœ… å›æ»šè„šæœ¬å‡†å¤‡
- âœ… å›æ»šæµ‹è¯•
- âœ… å›æ»šæ—¶é—´çª—å£
- âœ… å›æ»šå½±å“è¯„ä¼°

**å›æ»šæ‰§è¡Œ**ï¼š

- âœ… å¿«é€Ÿå›æ»š
- âœ… éªŒè¯å›æ»šç»“æœ
- âœ… é—®é¢˜åˆ†æ
- âœ… æ”¹è¿›æªæ–½

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: RUNBOOK-å˜æ›´å›æ»š
