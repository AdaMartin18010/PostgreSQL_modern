# æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **ç”¨é€”**: ç»Ÿä¸€æ•…éšœè¯Šæ–­æ–‡æ¡£æ ¼å¼ï¼Œé€‚ç”¨äºå„ç§æ•…éšœç±»å‹
> **æ¥æº**: åŸºäºæ…¢æŸ¥è¯¢è¯Šæ–­ã€é”å†²çªè¯Šæ–­ã€å†…å­˜æº¢å‡ºè¯Šæ–­ç­‰æ–‡æ¡£

## ğŸ“‘ ç›®å½•

- [æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿](#æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ–‡æ¡£è¯´æ˜](#1-æ–‡æ¡£è¯´æ˜)
  - [2. æ•…éšœè¯Šæ–­é€šç”¨ç»“æ„](#2-æ•…éšœè¯Šæ–­é€šç”¨ç»“æ„)
    - [2.1 ç—‡çŠ¶æè¿°](#21-ç—‡çŠ¶æè¿°)
    - [2.2 è¯Šæ–­æ­¥éª¤](#22-è¯Šæ–­æ­¥éª¤)
    - [2.3 è§£å†³æ–¹æ¡ˆ](#23-è§£å†³æ–¹æ¡ˆ)
    - [2.4 é¢„é˜²æªæ–½](#24-é¢„é˜²æªæ–½)
  - [3. å…·ä½“æ•…éšœç±»å‹](#3-å…·ä½“æ•…éšœç±»å‹)
    - [3.1 æ…¢æŸ¥è¯¢è¯Šæ–­](#31-æ…¢æŸ¥è¯¢è¯Šæ–­)
    - [3.2 é”å†²çªè¯Šæ–­](#32-é”å†²çªè¯Šæ–­)
    - [3.3 å†…å­˜æº¢å‡ºè¯Šæ–­](#33-å†…å­˜æº¢å‡ºè¯Šæ–­)
    - [3.4 è¿æ¥é—®é¢˜è¯Šæ–­](#34-è¿æ¥é—®é¢˜è¯Šæ–­)
    - [3.5 å¤åˆ¶é—®é¢˜è¯Šæ–­](#35-å¤åˆ¶é—®é¢˜è¯Šæ–­)
    - [3.6 å­˜å‚¨é—®é¢˜è¯Šæ–­](#36-å­˜å‚¨é—®é¢˜è¯Šæ–­)
  - [4. è¯Šæ–­å·¥å…·](#4-è¯Šæ–­å·¥å…·)
    - [4.1 PostgreSQLå†…ç½®å·¥å…·](#41-postgresqlå†…ç½®å·¥å…·)
    - [4.2 å¤–éƒ¨å·¥å…·](#42-å¤–éƒ¨å·¥å…·)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è¯Šæ–­æµç¨‹æœ€ä½³å®è·µ](#51-è¯Šæ–­æµç¨‹æœ€ä½³å®è·µ)
    - [5.2 æ–‡æ¡£è®°å½•æœ€ä½³å®è·µ](#52-æ–‡æ¡£è®°å½•æœ€ä½³å®è·µ)

---

## 1. æ–‡æ¡£è¯´æ˜

**æœ¬æ–‡æ¡£æä¾›äº†æ•…éšœè¯Šæ–­çš„é€šç”¨æ¨¡æ¿å’Œæ ¼å¼**ï¼Œå„å…·ä½“æ•…éšœç±»å‹åº”éµå¾ªæ­¤æ ¼å¼ï¼Œä½†ä¿ç•™å„è‡ªç‰¹å®šçš„è¯Šæ–­å†…å®¹ã€‚

**åŸå§‹æ–‡æ¡£æ¥æº**:

- `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\01-æ…¢æŸ¥è¯¢è¯Šæ–­.md`
- `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\02-é”å†²çªè¯Šæ–­.md`
- `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\03-å†…å­˜æº¢å‡ºè¯Šæ–­.md`

**é€‚ç”¨åœºæ™¯**ï¼š

- æ€§èƒ½é—®é¢˜è¯Šæ–­
- åŠŸèƒ½å¼‚å¸¸è¯Šæ–­
- æ•°æ®é—®é¢˜è¯Šæ–­
- ç³»ç»Ÿæ•…éšœè¯Šæ–­

---

## 2. æ•…éšœè¯Šæ–­é€šç”¨ç»“æ„

### 2.1 ç—‡çŠ¶æè¿°

**é—®é¢˜è¡¨ç°**ï¼š

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
-- å…·ä½“é”™è¯¯ä¿¡æ¯
ERROR: ...
FATAL: ...
```

**æ€§èƒ½æŒ‡æ ‡å¼‚å¸¸**ï¼š

- æŸ¥è¯¢å»¶è¿Ÿ > é˜ˆå€¼
- CPUä½¿ç”¨ç‡ > é˜ˆå€¼
- å†…å­˜ä½¿ç”¨ç‡ > é˜ˆå€¼
- è¿æ¥æ•° > é˜ˆå€¼

**ç”¨æˆ·åé¦ˆ**ï¼š

- åŠŸèƒ½ä¸å¯ç”¨
- å“åº”ç¼“æ…¢
- æ•°æ®ä¸ä¸€è‡´

### 2.2 è¯Šæ–­æ­¥éª¤

**æ­¥éª¤1: é—®é¢˜å®šä½**

**å¿«é€Ÿæ£€æŸ¥**ï¼š

```sql
-- 1. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT version();

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery();

-- 2. æ£€æŸ¥è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM pg_stat_activity;

-- 3. æ£€æŸ¥å½“å‰æ´»åŠ¨ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    state,
    wait_event_type,
    wait_event,
    query_start,
    now() - query_start AS duration,
    LEFT(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY duration DESC
LIMIT 100;
```

**æ­¥éª¤2: æ ¹å› åˆ†æ**

**æ·±å…¥åˆ†æ**ï¼š

```sql
-- æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©ç›¸åº”çš„è¯Šæ–­æŸ¥è¯¢
-- è§å…·ä½“æ•…éšœç±»å‹ç« èŠ‚
```

**æ­¥éª¤3: éªŒè¯ç¡®è®¤**

**éªŒè¯æŸ¥è¯¢**ï¼š

```sql
-- éªŒè¯é—®é¢˜æ˜¯å¦è§£å†³
-- è§å…·ä½“æ•…éšœç±»å‹ç« èŠ‚
```

### 2.3 è§£å†³æ–¹æ¡ˆ

**ç«‹å³æªæ–½**ï¼š

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼š

- ç»ˆæ­¢é—®é¢˜æŸ¥è¯¢
- é‡å¯æœåŠ¡
- åˆ‡æ¢å¤‡ç”¨å®ä¾‹

**ç´§æ€¥SQL**ï¼š

```sql
-- ç»ˆæ­¢é—®é¢˜æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    target_pid int := 12345;  -- æ›¿æ¢ä¸ºå®é™…çš„é—®é¢˜è¿›ç¨‹ID
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_stat_activity WHERE pid = target_pid) THEN
            PERFORM pg_terminate_backend(target_pid);
            RAISE NOTICE 'è¿›ç¨‹ % å·²ç»ˆæ­¢', target_pid;
        ELSE
            RAISE WARNING 'è¿›ç¨‹ % ä¸å­˜åœ¨', target_pid;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»ˆæ­¢è¿›ç¨‹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é‡å¯PostgreSQLï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
-- sudo systemctl restart postgresql-18
```

**é•¿æœŸæªæ–½**ï¼š

**æ ¹æœ¬è§£å†³æ–¹æ¡ˆ**ï¼š

- ä¼˜åŒ–æŸ¥è¯¢
- è°ƒæ•´é…ç½®
- å‡çº§ç¡¬ä»¶
- æ¶æ„ä¼˜åŒ–

**é¢„é˜²æªæ–½**ï¼š

- ç›‘æ§å‘Šè­¦è®¾ç½®
- å®šæœŸæ£€æŸ¥
- æœ€ä½³å®è·µéµå¾ª

### 2.4 é¢„é˜²æªæ–½

**ç›‘æ§å‘Šè­¦**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
- alert: ProblemDetected
  expr: problem_metric > threshold
  for: 5m
  annotations:
    summary: "é—®é¢˜æ£€æµ‹"
```

**å®šæœŸæ£€æŸ¥**ï¼š

```sql
-- å®šæœŸæ£€æŸ¥è„šæœ¬
-- è§å…·ä½“æ•…éšœç±»å‹ç« èŠ‚
```

**æœ€ä½³å®è·µ**ï¼š

- âœ… éµå¾ªPostgreSQLæœ€ä½³å®è·µ
- âœ… å®šæœŸç»´æŠ¤
- âœ… ç›‘æ§å‘Šè­¦
- âœ… æ–‡æ¡£è®°å½•

---

## 3. å…·ä½“æ•…éšœç±»å‹

### 3.1 æ…¢æŸ¥è¯¢è¯Šæ–­

**å‚è€ƒæ–‡æ¡£**ï¼š

- [æ…¢æŸ¥è¯¢è¯Šæ–­-è¯¦ç»†æ¡ˆä¾‹](./01-æ…¢æŸ¥è¯¢è¯Šæ–­.md)

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- Topæ…¢æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 200) AS query_preview,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;

-- æŸ¥è¯¢è®¡åˆ’åˆ†æï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT * FROM table WHERE ...
LIMIT 100;
```

### 3.2 é”å†²çªè¯Šæ–­

**å‚è€ƒæ–‡æ¡£**ï¼š

- [é”å†²çªè¯Šæ–­-è¯¦ç»†æ¡ˆä¾‹](./02-é”å†²çªè¯Šæ–­.md)

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- é”ç­‰å¾…åˆ†æï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
LIMIT 100;
```

### 3.3 å†…å­˜æº¢å‡ºè¯Šæ–­

**å‚è€ƒæ–‡æ¡£**ï¼š

- [å†…å­˜æº¢å‡ºè¯Šæ–­-è¯¦ç»†æ¡ˆä¾‹](./03-å†…å­˜æº¢å‡ºè¯Šæ–­.md)

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- å†…å­˜ä½¿ç”¨ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    setting,
    unit,
    source
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem', 'effective_cache_size')
ORDER BY name
LIMIT 100;

-- æ£€æŸ¥å†…å­˜æº¢å‡ºï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    query,
    state
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY now() - query_start DESC
LIMIT 100;
```

### 3.4 è¿æ¥é—®é¢˜è¯Šæ–­

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- è¿æ¥æ•°ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction
FROM pg_stat_activity;

-- è¿æ¥æ¥æºç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    client_addr,
    application_name,
    count(*) AS connection_count
FROM pg_stat_activity
GROUP BY client_addr, application_name
ORDER BY connection_count DESC
LIMIT 100;
```

### 3.5 å¤åˆ¶é—®é¢˜è¯Šæ–­

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- å¤åˆ¶çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority
FROM pg_stat_replication
LIMIT 100;

-- å¤åˆ¶å»¶è¿Ÿï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_current_wal_lsn() AS current_lsn,
    pg_replication_slots_confirmed_flush_lsn('slot_name') AS confirmed_lsn,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        pg_replication_slots_confirmed_flush_lsn('slot_name')
    ) AS lag_bytes;
```

### 3.6 å­˜å‚¨é—®é¢˜è¯Šæ–­

**å…³é”®è¯Šæ–­æŸ¥è¯¢**ï¼š

```sql
-- è¡¨å¤§å°ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- ç£ç›˜ä½¿ç”¨ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(sum(pg_database_size(oid))) AS total_size
FROM pg_database
LIMIT 100;
```

---

## 4. è¯Šæ–­å·¥å…·

### 4.1 PostgreSQLå†…ç½®å·¥å…·

**pg_stat_statements**ï¼š

```sql
-- å¯ç”¨pg_stat_statementsï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
            RAISE NOTICE 'æ‰©å±• pg_stat_statements åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pg_stat_statements å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'æ‰©å±•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_statements LIMIT 10;
```

**auto_explain**ï¼š

```sql
-- å¯ç”¨auto_explainï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET shared_preload_libraries = 'auto_explain';
            ALTER SYSTEM SET auto_explain.log_min_duration = '200ms';
            PERFORM pg_reload_conf();
            RAISE NOTICE 'auto_explainé…ç½®å·²æ›´æ–°ï¼Œé…ç½®å·²é‡æ–°åŠ è½½';
        ELSE
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®auto_explainé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**pg_stat_activity**ï¼š

```sql
-- æ´»åŠ¨ä¼šè¯æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_activity
LIMIT 100;
```

### 4.2 å¤–éƒ¨å·¥å…·

**pgAdmin**ï¼š

- å¯è§†åŒ–æŸ¥è¯¢è®¡åˆ’
- æ€§èƒ½ç›‘æ§
- æ•°æ®åº“ç®¡ç†

**DBeaver**ï¼š

- SQLæŸ¥è¯¢
- æ•°æ®æµè§ˆ
- æ€§èƒ½åˆ†æ

**Prometheus + Grafana**ï¼š

- æŒ‡æ ‡ç›‘æ§
- å¯è§†åŒ–é¢æ¿
- å‘Šè­¦

---

## 5. æœ€ä½³å®è·µ

### 5.1 è¯Šæ–­æµç¨‹æœ€ä½³å®è·µ

**è¯Šæ–­åŸåˆ™**ï¼š

- âœ… å…ˆæµ‹é‡ï¼Œå†è¯Šæ–­
- âœ… ç³»ç»Ÿæ€§åˆ†æ
- âœ… è®°å½•è¯Šæ–­è¿‡ç¨‹
- âœ… éªŒè¯è§£å†³æ–¹æ¡ˆ

**è¯Šæ–­æ­¥éª¤**ï¼š

1. æ”¶é›†ç—‡çŠ¶ä¿¡æ¯
2. å¿«é€Ÿå®šä½é—®é¢˜
3. æ·±å…¥åˆ†ææ ¹å› 
4. åˆ¶å®šè§£å†³æ–¹æ¡ˆ
5. éªŒè¯è§£å†³æ–¹æ¡ˆ
6. æ€»ç»“å’Œé¢„é˜²

### 5.2 æ–‡æ¡£è®°å½•æœ€ä½³å®è·µ

**è®°å½•å†…å®¹**ï¼š

- âœ… é—®é¢˜ç—‡çŠ¶
- âœ… è¯Šæ–­è¿‡ç¨‹
- âœ… è§£å†³æ–¹æ¡ˆ
- âœ… é¢„é˜²æªæ–½

**æ–‡æ¡£æ ¼å¼**ï¼š

- âœ… ç»“æ„åŒ–æ ¼å¼
- âœ… ä»£ç ç¤ºä¾‹
- âœ… å›¾è¡¨è¯´æ˜
- âœ… æ—¶é—´è®°å½•

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: é€šç”¨æ¨¡æ¿æ–‡æ¡£
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
