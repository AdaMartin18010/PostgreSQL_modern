---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\02-é”å†²çªè¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿](./æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿.md) - é€šç”¨è¯Šæ–­æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºé”å†²çªè¯Šæ–­çš„è¯¦ç»†æ¡ˆä¾‹å‚è€ƒã€‚

---

# é”å†²çªè¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**

---

## æ¡ˆä¾‹1ï¼šé•¿äº‹åŠ¡é˜»å¡

### ç—‡çŠ¶

```text
åº”ç”¨æŠ¥é”™ï¼štimeout waiting for lock
å¤§é‡æŸ¥è¯¢ç­‰å¾…
```

### è¯Šæ–­

```sql
-- æŸ¥æ‰¾é”ç­‰å¾…
SELECT
    blocked.pid AS blocked_pid,
    blocked.query AS blocked_query,
    blocking.pid AS blocking_pid,
    blocking.query AS blocking_query,
    blocking.state,
    blocking.query_start
FROM pg_stat_activity blocked
JOIN pg_locks blocked_lock ON blocked.pid = blocked_lock.pid
JOIN pg_locks blocking_lock ON blocking_lock.locktype = blocked_lock.locktype
    AND blocking_lock.pid != blocked_lock.pid
JOIN pg_stat_activity blocking ON blocking.pid = blocking_lock.pid
WHERE NOT blocked_lock.granted
  AND blocking_lock.granted;

/*
blocking_pid: 12345
blocking_query: UPDATE orders SET ...ï¼ˆå·²è¿è¡Œ30åˆ†é’Ÿï¼‰
state: idle in transaction  -- å¿˜è®°COMMITï¼
*/
```

### è§£å†³

```sql
-- ç«‹å³ï¼šæ€æ­»é˜»å¡ä¼šè¯
SELECT pg_terminate_backend(12345);

-- é•¿æœŸï¼šè®¾ç½®è¶…æ—¶
ALTER DATABASE mydb SET statement_timeout = '30s';
ALTER DATABASE mydb SET idle_in_transaction_session_timeout = '10min';
```

---

## æ¡ˆä¾‹2ï¼šæ­»é”

### ç—‡çŠ¶

```text
ERROR: deadlock detected
DETAIL: Process 123 waits for ShareLock on transaction 456
Process 456 waits for ShareLock on transaction 123
```

### è¯Šæ–­

```sql
-- æŸ¥çœ‹æ—¥å¿—
SELECT * FROM pg_stat_database WHERE datname = current_database();

-- deadlockså­—æ®µæ˜¾ç¤ºæ­»é”æ¬¡æ•°

-- å¯ç”¨æ­»é”æ—¥å¿—
ALTER SYSTEM SET deadlock_timeout = '1s';
ALTER SYSTEM SET log_lock_waits = on;
```

### è§£å†³

```sql
-- ä»£ç å±‚é¢ï¼šç»Ÿä¸€è¡¨è®¿é—®é¡ºåº

-- é”™è¯¯ä»£ç ï¼ˆå¯èƒ½æ­»é”ï¼‰
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 'A';  -- äº‹åŠ¡1
UPDATE accounts SET balance = balance + 100 WHERE account_id = 'B';  -- äº‹åŠ¡1

-- åŒæ—¶
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE account_id = 'B';  -- äº‹åŠ¡2
UPDATE accounts SET balance = balance + 50 WHERE account_id = 'A';  -- äº‹åŠ¡2
-- æ­»é”ï¼

-- æ­£ç¡®ä»£ç ï¼ˆæŒ‰account_idæ’åºï¼‰
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 'A';
UPDATE accounts SET balance = balance + 100 WHERE account_id = 'B';
COMMIT;
```

---

## æ¡ˆä¾‹3ï¼šè¡¨çº§é”å†²çª

### ç—‡çŠ¶

```sql
-- DDLæ“ä½œè¢«é˜»å¡
ALTER TABLE orders ADD COLUMN new_col INT;
-- ä¸€ç›´ç­‰å¾…...
```

### è¯Šæ–­

```sql
-- æŸ¥çœ‹è¡¨é”
SELECT
    l.pid,
    l.mode,
    l.granted,
    a.query,
    a.state
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.relation = 'orders'::regclass;

/*
mode: AccessShareLock, granted: trueï¼ˆæŸ¥è¯¢æŒæœ‰ï¼‰
mode: AccessExclusiveLock, granted: falseï¼ˆDDLç­‰å¾…ï¼‰
*/
```

### è§£å†³

```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨CONCURRENTLYï¼ˆä¸é˜»å¡ï¼‰
CREATE INDEX CONCURRENTLY idx_orders_new ON orders(new_col);

-- æ–¹æ¡ˆ2ï¼šåœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡ŒDDL
-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨pg_terminate_backendæ€æ­»é•¿æŸ¥è¯¢ï¼ˆè°¨æ…ï¼‰
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
