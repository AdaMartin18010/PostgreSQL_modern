---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\03-å†…å­˜æº¢å‡ºè¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿](./æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿.md) - é€šç”¨è¯Šæ–­æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºå†…å­˜æº¢å‡ºè¯Šæ–­çš„è¯¦ç»†æ¡ˆä¾‹å‚è€ƒã€‚

---

# å†…å­˜æº¢å‡ºè¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**

---

## æ¡ˆä¾‹1ï¼šwork_memæº¢å‡º

### ç—‡çŠ¶

```text
ç³»ç»Ÿæ—¥å¿—ï¼š
temporary file: path "base/pgsql_tmp/pgsql_tmp12345.0", size 8589934592
æŸ¥è¯¢ï¼šORDER BYæ“ä½œæ…¢
```

### è¯Šæ–­

```sql
-- æŸ¥çœ‹ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨
SELECT
    datname,
    temp_files,
    temp_bytes,
    pg_size_pretty(temp_bytes) as temp_size
FROM pg_stat_database
WHERE datname = current_database();

/*
temp_files: 150
temp_bytes: 85899345920 (80GB!)
*/

-- æŸ¥çœ‹å½“å‰work_mem
SHOW work_mem;  -- 4MBï¼ˆå¤ªå°ï¼‰
```

### è§£å†³

```sql
-- æ–¹æ¡ˆ1ï¼šå¢åŠ work_memï¼ˆä¼šè¯çº§ï¼‰
SET work_mem = '256MB';

-- æ–¹æ¡ˆ2ï¼šä¼˜åŒ–æŸ¥è¯¢
-- åŸæŸ¥è¯¢
SELECT * FROM orders
WHERE order_date > '2025-01-01'
ORDER BY amount DESC;

-- ä¼˜åŒ–ï¼šå…ˆè¿‡æ»¤å†æ’åº
SELECT * FROM orders
WHERE order_date > '2025-01-01'
  AND amount > 1000  -- å¢åŠ è¿‡æ»¤
ORDER BY amount DESC
LIMIT 1000;  -- é™åˆ¶ç»“æœ

-- æ–¹æ¡ˆ3ï¼šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_amount ON orders(amount DESC)
WHERE order_date > '2025-01-01';
```

---

## æ¡ˆä¾‹2ï¼šOOM Killer

### ç—‡çŠ¶

```text
ç³»ç»Ÿæ—¥å¿—ï¼š
Out of memory: Kill process 12345 (postgres) score 850
æ•°æ®åº“è¿›ç¨‹è¢«æ€
è¿æ¥æ–­å¼€
```

### è¯Šæ–­

```sql
-- â­ PostgreSQL 18ï¼šå¢å¼ºçš„å†…å­˜è¯Šæ–­
SELECT
    name,
    type,  -- æ–°å¢
    path,  -- æ–°å¢
    pg_size_pretty(total_bytes) as total,
    pg_size_pretty(used_bytes) as used,
    pg_size_pretty(free_bytes) as free
FROM pg_backend_memory_contexts
WHERE used_bytes > 100 * 1024 * 1024  -- >100MB
ORDER BY used_bytes DESC;

/*
name: ExecutorState
type: AllocSet
used: 15GB (å¼‚å¸¸å¤§ï¼)
*/

-- æŸ¥çœ‹æŸ¥è¯¢
SELECT pid, query, state, backend_type
FROM pg_stat_activity
WHERE pid = 12345;
```

### è§£å†³

```sql
-- 1. æ‰¾åˆ°é—®é¢˜æŸ¥è¯¢
SELECT
    pid,
    usename,
    query,
    state,
    pg_size_pretty(
        (SELECT sum(used_bytes)
         FROM pg_backend_memory_contexts
         WHERE pid = pg_stat_activity.pid)
    ) as mem_used
FROM pg_stat_activity
ORDER BY mem_used DESC;

-- 2. æ€æ­»é—®é¢˜æŸ¥è¯¢
SELECT pg_cancel_backend(problematic_pid);

-- 3. ä¼˜åŒ–æŸ¥è¯¢
-- é¿å…ï¼šSELECT * FROM huge_table
-- ä½¿ç”¨ï¼šSELECT id, name FROM huge_table LIMIT 1000

-- 4. é…ç½®é™åˆ¶
ALTER ROLE app_user SET work_mem = '128MB';
```

---

## æ¡ˆä¾‹3ï¼šshared_buffersä¸è¶³

### ç—‡çŠ¶

```text
ç¼“å­˜å‘½ä¸­ç‡ä½ï¼š70%ï¼ˆåº”è¯¥>95%ï¼‰
I/Oé«˜
æŸ¥è¯¢æ…¢
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_hit) * 100.0 /
    NULLIF(sum(heap_blks_hit + heap_blks_read), 0) as cache_hit_ratio
FROM pg_statio_user_tables;

-- 70%ï¼ˆå¤ªä½ï¼‰

-- æ£€æŸ¥shared_buffers
SHOW shared_buffers;  -- 128MBï¼ˆå¤ªå°ï¼‰
```

### è§£å†³

```ini
# postgresql.conf
# è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„25%
shared_buffers = 32GB

# é‡å¯PostgreSQL
pg_ctl restart
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
