---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\06-å­˜å‚¨é—®é¢˜è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å­˜å‚¨é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**
> **è¡¨è†¨èƒ€ã€VACUUMã€ç£ç›˜ç©ºé—´**

---

## æ¡ˆä¾‹1ï¼šè¡¨è†¨èƒ€ä¸¥é‡

### ç—‡çŠ¶

```text
è¡¨å¤§å°æŒç»­å¢é•¿
æŸ¥è¯¢å˜æ…¢
ç£ç›˜ç©ºé—´ä¸è¶³
n_dead_tupæ¯”ä¾‹é«˜ï¼ˆ>30%ï¼‰
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥è¡¨è†¨èƒ€æƒ…å†µ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC;

/*
tablename: orders
total_size: 50GB
table_size: 45GB
n_live_tup: 10,000,000
n_dead_tup: 5,000,000
dead_ratio: 33.33% (ä¸¥é‡è†¨èƒ€ï¼)
last_autovacuum: 2025-12-01 (ä¸€å‘¨å‰)
*/

-- æ£€æŸ¥ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE pg_relation_size(indexrelid) > 1024 * 1024 * 1024  -- >1GB
ORDER BY pg_relation_size(indexrelid) DESC;

-- æ£€æŸ¥VACUUMè¿›åº¦
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples
FROM pg_stat_progress_vacuum;
```

### è§£å†³

```sql
-- 1. ç«‹å³VACUUMï¼ˆä¸é”è¡¨ï¼‰
VACUUM ANALYZE orders;

-- 2. å¦‚æœæ— æ•ˆï¼Œä½¿ç”¨VACUUM FULLï¼ˆé”è¡¨ï¼Œéœ€è°¨æ…ï¼‰
-- åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
VACUUM FULL ANALYZE orders;

-- 3. é‡å»ºè¡¨ï¼ˆæ¨èï¼Œä¸é”è¡¨ï¼‰
BEGIN;
CREATE TABLE orders_new (LIKE orders INCLUDING ALL);
INSERT INTO orders_new SELECT * FROM orders;
ALTER TABLE orders RENAME TO orders_old;
ALTER TABLE orders_new RENAME TO orders;
-- é‡å»ºç´¢å¼•
CREATE INDEX CONCURRENTLY idx_orders_customer ON orders(customer_id);
-- ... å…¶ä»–ç´¢å¼•
COMMIT;
DROP TABLE orders_old;

-- 4. è°ƒæ•´autovacuumå‚æ•°
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.1,  -- 10%æ­»å…ƒç»„è§¦å‘
    autovacuum_vacuum_threshold = 1000,
    autovacuum_analyze_scale_factor = 0.05,
    autovacuum_analyze_threshold = 500
);

-- 5. ä½¿ç”¨fillfactoré¢„ç•™ç©ºé—´ï¼ˆå‡å°‘æœªæ¥è†¨èƒ€ï¼‰
ALTER TABLE orders SET (fillfactor = 80);  -- é¢„ç•™20%ç©ºé—´
```

---

## æ¡ˆä¾‹2ï¼šç£ç›˜ç©ºé—´ä¸è¶³

### ç—‡çŠ¶

```text
é”™è¯¯ï¼šcould not extend file
ç£ç›˜ä½¿ç”¨ç‡>90%
æ— æ³•å†™å…¥æ•°æ®
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æ£€æŸ¥è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- æ£€æŸ¥WALå¤§å°
SELECT
    pg_size_pretty(pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        '0/0'
    )) AS total_wal_size;

-- æ£€æŸ¥WALç›®å½•å¤§å°ï¼ˆéœ€è¦ç³»ç»Ÿå‘½ä»¤ï¼‰
-- SELECT pg_ls_waldir();

-- æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶
SELECT
    datname,
    temp_files,
    pg_size_pretty(temp_bytes) AS temp_size
FROM pg_stat_database
WHERE temp_bytes > 0
ORDER BY temp_bytes DESC;

-- æ£€æŸ¥TOASTè¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(
        (SELECT pg_total_relation_size(oid)
         FROM pg_class
         WHERE relname = tablename || '_toast')
    ) AS toast_size
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY toast_size DESC NULLS LAST
LIMIT 10;
```

### è§£å†³

```sql
-- 1. æ¸…ç†æ­»å…ƒç»„ï¼ˆé‡Šæ”¾ç©ºé—´ï¼‰
VACUUM FULL;

-- 2. æ¸…ç†WALï¼ˆå¦‚æœä½¿ç”¨å½’æ¡£ï¼‰
-- æ£€æŸ¥å½’æ¡£é…ç½®
SHOW archive_mode;
SHOW archive_command;

-- å¦‚æœä½¿ç”¨pg_wal_archiveï¼Œæ¸…ç†æ—§WAL
-- æ³¨æ„ï¼šç¡®ä¿å·²å½’æ¡£åˆ°å¤‡ä»½ä½ç½®

-- 3. åˆ é™¤ä¸éœ€è¦çš„æ•°æ®
-- åˆ é™¤æ—§æ•°æ®
DELETE FROM orders WHERE order_date < '2020-01-01';
VACUUM FULL orders;

-- 4. ä½¿ç”¨è¡¨åˆ†åŒºï¼ˆç®¡ç†å¤§è¡¨ï¼‰
-- æŒ‰æœˆåˆ†åŒºï¼Œåˆ é™¤æ—§åˆ†åŒº
DROP TABLE orders_2020_01;  -- åˆ é™¤æ•´ä¸ªåˆ†åŒº

-- 5. å‹ç¼©å¤§å¯¹è±¡
-- æ£€æŸ¥å¤§å¯¹è±¡
SELECT
    oid,
    pg_size_pretty(pg_largeobject_length(oid)) AS size
FROM pg_largeobject_metadata
ORDER BY pg_largeobject_length(oid) DESC
LIMIT 10;

-- 6. æ‰©å±•ç£ç›˜ï¼ˆå¦‚æœå¯èƒ½ï¼‰
-- æ·»åŠ æ–°çš„è¡¨ç©ºé—´
CREATE TABLESPACE new_tablespace LOCATION '/new/disk/path';
ALTER TABLE orders SET TABLESPACE new_tablespace;
```

---

## æ¡ˆä¾‹3ï¼šVACUUMä¸å·¥ä½œ

### ç—‡çŠ¶

```text
autovacuumæœªè¿è¡Œ
è¡¨æŒç»­è†¨èƒ€
last_autovacuumä¸ºNULLæˆ–å¾ˆä¹…ä»¥å‰
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥autovacuumçŠ¶æ€
SELECT
    name,
    setting,
    unit,
    context
FROM pg_settings
WHERE name LIKE '%autovacuum%'
ORDER BY name;

/*
autovacuum = on (åº”è¯¥å¼€å¯)
autovacuum_max_workers = 3
autovacuum_naptime = 1min
*/

-- æ£€æŸ¥autovacuumè¿›ç¨‹
SELECT
    pid,
    usename,
    application_name,
    state,
    query,
    query_start
FROM pg_stat_activity
WHERE query LIKE '%autovacuum%'
   OR application_name = 'autovacuum launcher'
   OR application_name LIKE 'autovacuum worker%';

-- æ£€æŸ¥è¡¨çº§autovacuumè®¾ç½®
SELECT
    schemaname,
    tablename,
    reloptions
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
  AND reloptions IS NOT NULL;

-- æ£€æŸ¥autovacuumç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    last_analyze,
    last_autoanalyze,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;

-- æ£€æŸ¥autovacuumæ—¥å¿—ï¼ˆéœ€è¦é…ç½®ï¼‰
-- log_autovacuum_min_duration = 0
-- æŸ¥çœ‹PostgreSQLæ—¥å¿—æ–‡ä»¶
```

### è§£å†³

```sql
-- 1. ç¡®ä¿autovacuumå¼€å¯
ALTER SYSTEM SET autovacuum = on;
SELECT pg_reload_conf();

-- 2. è°ƒæ•´autovacuumå‚æ•°
-- postgresql.conf
autovacuum_max_workers = 3  -- å¢åŠ workeræ•°
autovacuum_naptime = 30s  -- å‡å°‘ç­‰å¾…æ—¶é—´
autovacuum_vacuum_scale_factor = 0.1  -- 10%æ­»å…ƒç»„è§¦å‘
autovacuum_analyze_scale_factor = 0.05  -- 5%å˜åŒ–è§¦å‘ANALYZE

-- 3. è¡¨çº§è°ƒæ•´ï¼ˆé’ˆå¯¹å¤§è¡¨ï¼‰
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- æ›´é¢‘ç¹
    autovacuum_vacuum_threshold = 5000,
    autovacuum_analyze_scale_factor = 0.02
);

-- 4. æ‰‹åŠ¨è§¦å‘VACUUM
VACUUM ANALYZE orders;

-- 5. æ£€æŸ¥autovacuumé˜»å¡
SELECT
    blocked.pid AS blocked_pid,
    blocking.pid AS blocking_pid,
    blocking.query AS blocking_query
FROM pg_stat_activity blocked
JOIN pg_locks blocked_lock ON blocked.pid = blocked_lock.pid
JOIN pg_locks blocking_lock ON blocking_lock.locktype = blocked_lock.locktype
    AND blocking_lock.pid != blocked_lock.pid
JOIN pg_stat_activity blocking ON blocking.pid = blocking_lock.pid
WHERE blocked.query LIKE '%autovacuum%'
  AND NOT blocked_lock.granted
  AND blocking_lock.granted;
```

---

## æ¡ˆä¾‹4ï¼šç´¢å¼•è†¨èƒ€

### ç—‡çŠ¶

```text
ç´¢å¼•å¤§å°å¼‚å¸¸å¤§
æŸ¥è¯¢æ€§èƒ½ä¸‹é™
ç´¢å¼•æ‰«ææ…¢
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    pg_size_pretty(pg_relation_size(indrelid)) AS table_size,
    round(100.0 * pg_relation_size(indexrelid) /
          NULLIF(pg_relation_size(indrelid), 0), 2) AS index_ratio,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE pg_relation_size(indexrelid) > 1024 * 1024 * 1024  -- >1GB
ORDER BY pg_relation_size(indexrelid) DESC;

/*
indexname: idx_orders_customer
index_size: 15GB
table_size: 10GB
index_ratio: 150% (å¼‚å¸¸ï¼ç´¢å¼•æ¯”è¡¨è¿˜å¤§)
idx_scan: 1000 (ä½¿ç”¨é¢‘ç‡ä½)
*/

-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    CASE
        WHEN idx_scan = 0 THEN 'æœªä½¿ç”¨'
        WHEN idx_scan < 100 THEN 'ä½¿ç”¨é¢‘ç‡ä½'
        ELSE 'æ­£å¸¸ä½¿ç”¨'
    END AS usage_status
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;

-- æ£€æŸ¥é‡å¤ç´¢å¼•
SELECT
    a.schemaname,
    a.tablename,
    a.indexname AS index1,
    b.indexname AS index2,
    a.indexdef AS def1,
    b.indexdef AS def2
FROM pg_indexes a
JOIN pg_indexes b ON a.schemaname = b.schemaname
    AND a.tablename = b.tablename
    AND a.indexname < b.indexname
WHERE a.indexdef = b.indexdef;  -- å®Œå…¨ç›¸åŒçš„ç´¢å¼•
```

### è§£å†³

```sql
-- 1. é‡å»ºç´¢å¼•ï¼ˆä¸é”è¡¨ï¼‰
REINDEX INDEX CONCURRENTLY idx_orders_customer;

-- 2. é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE CONCURRENTLY orders;

-- 3. åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
DROP INDEX CONCURRENTLY idx_unused_index;

-- 4. åˆå¹¶é‡å¤ç´¢å¼•
-- å¦‚æœä¸¤ä¸ªç´¢å¼•åŠŸèƒ½ç›¸åŒï¼Œåˆ é™¤ä¸€ä¸ª
DROP INDEX CONCURRENTLY idx_orders_customer_old;

-- 5. ä¼˜åŒ–ç´¢å¼•å®šä¹‰
-- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
DROP INDEX idx_orders_status;
CREATE INDEX idx_orders_status_active
ON orders(status)
WHERE status = 'active';

-- ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆINCLUDEåˆ—ï¼‰
DROP INDEX idx_orders_customer;
CREATE INDEX idx_orders_customer
ON orders(customer_id)
INCLUDE (order_date, amount);
```

---

## æ¡ˆä¾‹5ï¼šWALç©ºé—´å ç”¨è¿‡å¤§

### ç—‡çŠ¶

```text
WALç›®å½•å ç”¨å¤§é‡ç©ºé—´
ç£ç›˜ç©ºé—´ä¸è¶³
pg_walç›®å½•>50GB
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥WALä½¿ç”¨æƒ…å†µ
SELECT
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            '0/0'
        )
    ) AS total_wal_size;

-- æ£€æŸ¥WALæ®µæ•°é‡ï¼ˆéœ€è¦ç³»ç»Ÿè®¿é—®ï¼‰
-- SELECT count(*) FROM pg_ls_waldir();

-- æ£€æŸ¥å¤åˆ¶æ§½ï¼ˆå¯èƒ½é˜»æ­¢WALæ¸…ç†ï¼‰
SELECT
    slot_name,
    slot_type,
    database,
    active,
    restart_lsn,
    confirmed_flush_lsn,
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            COALESCE(confirmed_flush_lsn, restart_lsn)
        )
    ) AS retained_wal_size
FROM pg_replication_slots;

-- æ£€æŸ¥checkpointé…ç½®
SELECT
    name,
    setting,
    unit
FROM pg_settings
WHERE name IN (
    'checkpoint_timeout',
    'max_wal_size',
    'min_wal_size',
    'wal_keep_size'
);
```

### è§£å†³

```sql
-- 1. è°ƒæ•´checkpointå‚æ•°
ALTER SYSTEM SET max_wal_size = '4GB';  -- é™åˆ¶WALå¤§å°
ALTER SYSTEM SET checkpoint_timeout = '15min';  -- æ›´é¢‘ç¹checkpoint
SELECT pg_reload_conf();

-- 2. æ‰‹åŠ¨checkpoint
CHECKPOINT;

-- 3. æ¸…ç†ä¸æ´»è·ƒçš„å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('old_slot_name');

-- 4. å¦‚æœä½¿ç”¨å½’æ¡£ï¼Œç¡®ä¿å½’æ¡£æ­£å¸¸
-- æ£€æŸ¥å½’æ¡£å‘½ä»¤
SHOW archive_command;

-- 5. ç›‘æ§WALç”Ÿæˆé€Ÿåº¦
CREATE VIEW wal_generation_rate AS
SELECT
    now() AS time,
    pg_current_wal_lsn() AS current_lsn,
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            '0/0'
        )
    ) AS total_wal_size;

-- 6. ä¼˜åŒ–å†™å…¥æ¨¡å¼ï¼ˆå¦‚æœå…è®¸ï¼‰
-- æ‰¹é‡æäº¤äº‹åŠ¡
-- å‡å°‘ä¸å¿…è¦çš„WALï¼ˆä½¿ç”¨UNLOGGEDè¡¨ï¼Œå¦‚æœå…è®¸ï¼‰
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
