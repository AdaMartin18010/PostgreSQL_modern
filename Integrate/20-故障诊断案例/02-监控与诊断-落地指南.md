---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\02-ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç¼–å·**: RUNBOOK-02
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **ç”¨é€”**: PostgreSQLç›‘æ§ä¸è¯Šæ–­ç”Ÿäº§è½åœ°æŒ‡å—

## ğŸ“‘ ç›®å½•

- [ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. ç›‘æ§ç»„ä»¶](#1-ç›‘æ§ç»„ä»¶)
  - [2. éƒ¨ç½²æ­¥éª¤](#2-éƒ¨ç½²æ­¥éª¤)
    - [2.1 åˆ›å»ºç›‘æ§ç”¨æˆ·](#21-åˆ›å»ºç›‘æ§ç”¨æˆ·)
    - [2.2 å¯åŠ¨postgres\_exporter](#22-å¯åŠ¨postgres_exporter)
    - [2.3 Prometheusé…ç½®](#23-prometheusé…ç½®)
    - [2.4 Grafanaå¯¼å…¥](#24-grafanaå¯¼å…¥)
  - [3. æ—¥å¿—é…ç½®](#3-æ—¥å¿—é…ç½®)
    - [3.1 PostgreSQLæ—¥å¿—é…ç½®](#31-postgresqlæ—¥å¿—é…ç½®)
    - [3.2 æ—¥å¿—é‡‡é›†](#32-æ—¥å¿—é‡‡é›†)
  - [4. è¯Šæ–­SQL](#4-è¯Šæ–­sql)
    - [4.1 æ€§èƒ½è¯Šæ–­](#41-æ€§èƒ½è¯Šæ–­)
    - [4.2 é”è¯Šæ–­](#42-é”è¯Šæ–­)
    - [4.3 å­˜å‚¨è¯Šæ–­](#43-å­˜å‚¨è¯Šæ–­)
  - [5. å‘Šè­¦è§„åˆ™](#5-å‘Šè­¦è§„åˆ™)
    - [5.1 Prometheuså‘Šè­¦è§„åˆ™](#51-prometheuså‘Šè­¦è§„åˆ™)
  - [6. Grafanaä»ªè¡¨æ¿](#6-grafanaä»ªè¡¨æ¿)
    - [6.1 å…³é”®æŒ‡æ ‡é¢æ¿](#61-å…³é”®æŒ‡æ ‡é¢æ¿)
    - [6.2 æŸ¥è¯¢æ€§èƒ½é¢æ¿](#62-æŸ¥è¯¢æ€§èƒ½é¢æ¿)
  - [7. æ•…éšœå®šä½æµç¨‹](#7-æ•…éšœå®šä½æµç¨‹)
    - [7.1 æ€§èƒ½é—®é¢˜å®šä½](#71-æ€§èƒ½é—®é¢˜å®šä½)
    - [7.2 å¸¸è§é—®é¢˜è¯Šæ–­](#72-å¸¸è§é—®é¢˜è¯Šæ–­)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 ç›‘æ§æœ€ä½³å®è·µ](#81-ç›‘æ§æœ€ä½³å®è·µ)
    - [8.2 æ—¥å¿—æœ€ä½³å®è·µ](#82-æ—¥å¿—æœ€ä½³å®è·µ)

---

## 1. ç›‘æ§ç»„ä»¶

**ç›‘æ§æ¶æ„**ï¼š

```mermaid
graph TB
    PG[(PostgreSQL)]
    Exporter[postgres_exporter]
    Prometheus[Prometheus]
    Grafana[Grafana]
    Loki[Loki]
    Filebeat[Filebeat/Vector]

    PG --> Exporter
    Exporter --> Prometheus
    Prometheus --> Grafana
    PG --> Filebeat
    Filebeat --> Loki
    Loki --> Grafana

    style PG fill:#4a90e2,color:#fff
    style Prometheus fill:#e6522c,color:#fff
    style Grafana fill:#f46800,color:#fff
```

**æ ¸å¿ƒç»„ä»¶**ï¼š

| ç»„ä»¶ | åŠŸèƒ½ | ç‰ˆæœ¬è¦æ±‚ |
|------|------|---------|
| **postgres_exporter** | æŒ‡æ ‡é‡‡é›† | >= 0.15.0 |
| **Prometheus** | æŒ‡æ ‡å­˜å‚¨ | >= 2.40.0 |
| **Grafana** | å¯è§†åŒ– | >= 9.0.0 |
| **Filebeat/Vector** | æ—¥å¿—é‡‡é›† | æœ€æ–° |
| **Loki** | æ—¥å¿—å­˜å‚¨ | >= 2.8.0 |

---

## 2. éƒ¨ç½²æ­¥éª¤

### 2.1 åˆ›å»ºç›‘æ§ç”¨æˆ·

**åˆ›å»ºä¸“ç”¨ç›‘æ§ç”¨æˆ·**ï¼š

```sql
-- 1. åˆ›å»ºç›‘æ§ç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'metrics') THEN
            CREATE ROLE metrics WITH LOGIN PASSWORD 'secure_password';
            RAISE NOTICE 'ç›‘æ§ç”¨æˆ· metrics åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç›‘æ§ç”¨æˆ· metrics å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'ç”¨æˆ·å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç›‘æ§ç”¨æˆ·å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æˆäºˆç›‘æ§æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'metrics') THEN
            GRANT pg_monitor TO metrics;
            RAISE NOTICE 'pg_monitoræƒé™æˆäºˆæˆåŠŸ';
        ELSE
            RAISE WARNING 'ç”¨æˆ· metrics ä¸å­˜åœ¨ï¼Œè·³è¿‡æƒé™æˆäºˆ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆpg_monitoræƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ç»†ç²’åº¦æƒé™ï¼ˆå¯é€‰ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'metrics') THEN
            GRANT pg_read_all_stats TO metrics;
            RAISE NOTICE 'pg_read_all_statsæƒé™æˆäºˆæˆåŠŸ';
        ELSE
            RAISE WARNING 'ç”¨æˆ· metrics ä¸å­˜åœ¨ï¼Œè·³è¿‡æƒé™æˆäºˆ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆpg_read_all_statsæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. éªŒè¯æƒé™ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_roles WHERE rolname = 'metrics';
```

**æƒé™è¯´æ˜**ï¼š

- `pg_monitor`ï¼šåŒ…å«æ‰€æœ‰ç›‘æ§ç›¸å…³æƒé™
- `pg_read_all_stats`ï¼šè¯»å–æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯

### 2.2 å¯åŠ¨postgres_exporter

**å®‰è£…postgres_exporter**ï¼š

```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz
tar xvfz postgres_exporter-0.15.0.linux-amd64.tar.gz
sudo mv postgres_exporter /usr/local/bin/
```

**é…ç½®ç¯å¢ƒå˜é‡**ï¼š

```bash
# è®¾ç½®æ•°æ®æº
export DATA_SOURCE_NAME="postgresql://metrics:password@127.0.0.1:5432/postgres?sslmode=disable"

# å¯åŠ¨exporter
postgres_exporter --web.listen-address=:9187
```

**systemdæœåŠ¡é…ç½®**ï¼š

```ini
# /etc/systemd/system/postgres_exporter.service
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
Environment=DATA_SOURCE_NAME="postgresql://metrics:password@127.0.0.1:5432/postgres?sslmode=disable"
ExecStart=/usr/local/bin/postgres_exporter --web.listen-address=:9187
Restart=always

[Install]
WantedBy=multi-user.target
```

**å¯åŠ¨æœåŠ¡**ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable postgres_exporter
sudo systemctl start postgres_exporter
sudo systemctl status postgres_exporter
```

### 2.3 Prometheusé…ç½®

**prometheus.ymlé…ç½®**ï¼š

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets:
          - 'db1:9187'
          - 'db2:9187'
          - 'db3:9187'
    scrape_interval: 15s
    metrics_path: /metrics

  - job_name: 'postgresql-exporter'
    static_configs:
      - targets: ['localhost:9187']
```

**éªŒè¯é…ç½®**ï¼š

```bash
# æ£€æŸ¥é…ç½®
promtool check config prometheus.yml

# å¯åŠ¨Prometheus
prometheus --config.file=prometheus.yml
```

### 2.4 Grafanaå¯¼å…¥

**å¯¼å…¥PostgreSQLä»ªè¡¨æ¿**ï¼š

1. **è¿æ¥Prometheusæ•°æ®æº**ï¼š
   - URL: `http://prometheus:9090`
   - Access: Server (Default)

2. **å¯¼å…¥ä»ªè¡¨æ¿**ï¼š
   - Dashboard ID: 9628 (PostgreSQL Database)
   - æˆ–ä½¿ç”¨è‡ªå®šä¹‰JSON

**å…³é”®é¢æ¿**ï¼š

- è¿æ¥/äº‹åŠ¡ç»Ÿè®¡
- ç¼“å­˜å‘½ä¸­ç‡
- WALç»Ÿè®¡
- æ£€æŸ¥ç‚¹ç»Ÿè®¡
- Autovacuumç»Ÿè®¡
- é”ç­‰å¾…ç»Ÿè®¡
- TopæŸ¥è¯¢ç»Ÿè®¡

---

## 3. æ—¥å¿—é…ç½®

### 3.1 PostgreSQLæ—¥å¿—é…ç½®

**postgresql.confé…ç½®**ï¼š

```conf
# æ—¥å¿—åŸºç¡€é…ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# æ—¥å¿—æ ¼å¼ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
log_line_prefix = '%m [%p] %u@%d %r %a '

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500ms

# æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on

# Autovacuumæ—¥å¿—
log_autovacuum_min_duration = 1s

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

# I/Oç»Ÿè®¡
track_io_timing = on

# æŸ¥è¯¢ç»Ÿè®¡
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# auto_explainé…ç½®
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_verbose = on
```

**åº”ç”¨æ—¥å¿—é…ç½®**ï¼š

```conf
# åº”ç”¨åç§°æ³¨å…¥
log_line_prefix = '%m [%p] %u@%d %r %a [%a] '

# åœ¨åº”ç”¨ä¸­è®¾ç½®
SET application_name = 'my_app_v1.2.3';
```

### 3.2 æ—¥å¿—é‡‡é›†

**Filebeaté…ç½®**ï¼š

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/lib/postgresql/18/data/log/postgresql-*.log
  fields:
    log_type: postgresql
    environment: production
  fields_under_root: false

output.loki:
  hosts: ["http://loki:3100"]
  labels:
    job: postgresql
    environment: production
```

**Vectoré…ç½®**ï¼š

```toml
[sources.postgresql_logs]
type = "file"
include = ["/var/lib/postgresql/18/data/log/postgresql-*.log"]

[transforms.parse_logs]
type = "regex_parser"
field = "message"
patterns = ['^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<pid>\d+)\] (?P<user>\w+)@(?P<database>\w+) (?P<remote_host>[\d.]+) (?P<app>\w+)']

[sinks.loki]
type = "loki"
inputs = ["parse_logs"]
endpoint = "http://loki:3100"
```

---

## 4. è¯Šæ–­SQL

### 4.1 æ€§èƒ½è¯Šæ–­

**Topæ…¢æŸ¥è¯¢**ï¼š

```sql
-- å¯ç”¨pg_stat_statementsï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
            RAISE NOTICE 'æ‰©å±• pg_stat_statements åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pg_stat_statements å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'æ‰©å±•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- Topæ…¢æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 20;
```

**è¿æ¥æ•°ç»Ÿè®¡**ï¼š

```sql
-- å½“å‰è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active_connections,
    count(*) FILTER (WHERE state = 'idle') AS idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction,
    count(*) FILTER (WHERE wait_event_type IS NOT NULL) AS waiting_connections
FROM pg_stat_activity
WHERE datname = current_database();
```

**ç¼“å­˜å‘½ä¸­ç‡**ï¼š

```sql
-- æ•°æ®åº“ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    blks_hit,
    blks_read,
    round(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY cache_hit_ratio DESC
LIMIT 100;
```

### 4.2 é”è¯Šæ–­

**é”ç­‰å¾…åˆ†æ**ï¼š

```sql
-- å½“å‰é”ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    blocked_activity.application_name AS blocked_app,
    blocking_activity.application_name AS blocking_app
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
  AND blocking_locks.granted
LIMIT 100;
```

**è¡¨é”ç»Ÿè®¡**ï¼š

```sql
-- è¡¨çº§é”ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC
LIMIT 20;
```

### 4.3 å­˜å‚¨è¯Šæ–­

**è¡¨å¤§å°ç»Ÿè®¡**ï¼š

```sql
-- è¡¨å¤§å°ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;
```

**ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡**ï¼š

```sql
-- ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC
LIMIT 20;
```

---

## 5. å‘Šè­¦è§„åˆ™

### 5.1 Prometheuså‘Šè­¦è§„åˆ™

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š

```yaml
# alerts.yml
groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{datname!~"template.*|postgres"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°: {{ $value }}"

      # ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          (
            sum(rate(pg_stat_database_blks_hit{datname!~"template.*|postgres"}[5m])) by (datname)
            /
            sum(rate(pg_stat_database_blks_hit{datname!~"template.*|postgres"}[5m]) + rate(pg_stat_database_blks_read{datname!~"template.*|postgres"}[5m])) by (datname)
          ) * 100 < 95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "æ•°æ®åº“ {{ $labels.datname }} ç¼“å­˜å‘½ä¸­ç‡: {{ $value }}%"

      # WALé€Ÿç‡å‘Šè­¦
      - alert: PostgreSQLHighWALRate
        expr: rate(pg_stat_database_xlog_bytes{datname!~"template.*|postgres"}[5m]) > 104857600
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WALé€Ÿç‡è¿‡é«˜"
          description: "æ•°æ®åº“ {{ $labels.datname }} WALé€Ÿç‡: {{ $value }} bytes/s"

      # æ£€æŸ¥ç‚¹å‘Šè­¦
      - alert: PostgreSQLFrequentCheckpoints
        expr: rate(pg_stat_bgwriter_checkpoints_timed[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹"
          description: "æ£€æŸ¥ç‚¹é¢‘ç‡: {{ $value }}/s"

      # Autovacuumæ»åå‘Šè­¦
      - alert: PostgreSQLAutovacuumLag
        expr: |
          sum(pg_stat_user_tables_n_dead_tup) by (schemaname, relname) > 1000000
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL Autovacuumæ»å"
          description: "è¡¨ {{ $labels.schemaname }}.{{ $labels.relname }} æ­»å…ƒç»„æ•°: {{ $value }}"

      # æ­»é”å‘Šè­¦
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname!~"template.*|postgres"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLæ£€æµ‹åˆ°æ­»é”"
          description: "æ•°æ®åº“ {{ $labels.datname }} æ­»é”ç‡: {{ $value }}/s"
```

**åŠ è½½å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# prometheus.yml
rule_files:
  - "alerts.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

---

## 6. Grafanaä»ªè¡¨æ¿

### 6.1 å…³é”®æŒ‡æ ‡é¢æ¿

**è¿æ¥æ•°é¢æ¿**ï¼š

```promql
# æ€»è¿æ¥æ•°
sum(pg_stat_database_numbackends{datname!~"template.*|postgres"})

# æ´»åŠ¨è¿æ¥æ•°
sum(pg_stat_activity_count{state="active"})

# ç­‰å¾…è¿æ¥æ•°
sum(pg_stat_activity_count{wait_event_type!=""})
```

**ç¼“å­˜å‘½ä¸­ç‡é¢æ¿**ï¼š

```promql
# ç¼“å­˜å‘½ä¸­ç‡
(
  sum(rate(pg_stat_database_blks_hit[5m])) by (datname)
  /
  sum(rate(pg_stat_database_blks_hit[5m] + pg_stat_database_blks_read[5m])) by (datname)
) * 100
```

**WALç»Ÿè®¡é¢æ¿**ï¼š

```promql
# WALç”Ÿæˆé€Ÿç‡
rate(pg_stat_database_xlog_bytes[5m])

# WALå½’æ¡£é€Ÿç‡
rate(pg_stat_archiver_archived_count[5m])
```

### 6.2 æŸ¥è¯¢æ€§èƒ½é¢æ¿

**Topæ…¢æŸ¥è¯¢**ï¼š

```promql
# Top 10æ…¢æŸ¥è¯¢
topk(10,
  sum(rate(pg_stat_statements_total_exec_time[5m])) by (queryid)
)
```

**æŸ¥è¯¢å»¶è¿Ÿåˆ†å¸ƒ**ï¼š

```promql
# P50å»¶è¿Ÿ
histogram_quantile(0.50,
  sum(rate(pg_stat_statements_exec_time_bucket[5m])) by (le, queryid)
)

# P95å»¶è¿Ÿ
histogram_quantile(0.95,
  sum(rate(pg_stat_statements_exec_time_bucket[5m])) by (le, queryid)
)

# P99å»¶è¿Ÿ
histogram_quantile(0.99,
  sum(rate(pg_stat_statements_exec_time_bucket[5m])) by (le, queryid)
)
```

---

## 7. æ•…éšœå®šä½æµç¨‹

### 7.1 æ€§èƒ½é—®é¢˜å®šä½

**æ•…éšœå®šä½æµç¨‹**ï¼š

```mermaid
graph TD
    A[æ€§èƒ½é—®é¢˜] --> B{æ£€æŸ¥è¿æ¥æ•°}
    B -->|æ­£å¸¸| C{æ£€æŸ¥æ…¢æŸ¥è¯¢}
    B -->|å¼‚å¸¸| D[è¿æ¥æ•°é—®é¢˜]
    C -->|æœ‰æ…¢æŸ¥è¯¢| E[æŸ¥è¯¢ä¼˜åŒ–]
    C -->|æ— æ…¢æŸ¥è¯¢| F{æ£€æŸ¥é”ç­‰å¾…}
    F -->|æœ‰é”ç­‰å¾…| G[é”å†²çªè§£å†³]
    F -->|æ— é”ç­‰å¾…| H{æ£€æŸ¥I/O}
    H -->|I/Oç“¶é¢ˆ| I[å­˜å‚¨ä¼˜åŒ–]
    H -->|æ­£å¸¸| J[å…¶ä»–é—®é¢˜]
```

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥è¿æ¥æ•°**ï¼š

```sql
-- æ£€æŸ¥è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM pg_stat_activity;
```

1. **æ£€æŸ¥æ…¢æŸ¥è¯¢**ï¼š

```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_statements
ORDER BY total_exec_time DESC LIMIT 10;
```

1. **æ£€æŸ¥é”ç­‰å¾…**ï¼š

```sql
-- æ£€æŸ¥é”ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_locks WHERE NOT granted
LIMIT 100;
```

1. **æ£€æŸ¥I/O**ï¼š

```sql
-- æ£€æŸ¥I/Oï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_io
LIMIT 100;
```

### 7.2 å¸¸è§é—®é¢˜è¯Šæ–­

**é—®é¢˜1ï¼šè¿æ¥æ•°è¿‡é«˜**

**ç—‡çŠ¶**ï¼š

- è¿æ¥æ•°æ¥è¿‘max_connections
- æ–°è¿æ¥è¢«æ‹’ç»

**è¯Šæ–­**ï¼š

```sql
-- æ£€æŸ¥è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) FROM pg_stat_activity;

-- æ£€æŸ¥è¿æ¥æ¥æºï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT client_addr, count(*)
FROM pg_stat_activity
GROUP BY client_addr
ORDER BY count(*) DESC
LIMIT 100;
```

**è§£å†³**ï¼š

- ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBouncerï¼‰
- å¢åŠ max_connections
- ä¼˜åŒ–åº”ç”¨è¿æ¥ç®¡ç†

**é—®é¢˜2ï¼šç¼“å­˜å‘½ä¸­ç‡ä½**

**ç—‡çŠ¶**ï¼š

- ç¼“å­˜å‘½ä¸­ç‡ < 95%
- æŸ¥è¯¢å˜æ…¢

**è¯Šæ–­**ï¼š

```sql
-- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    round(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio
FROM pg_stat_database
LIMIT 100;
```

**è§£å†³**ï¼š

- å¢åŠ shared_buffers
- ä¼˜åŒ–æŸ¥è¯¢
- é¢„çƒ­ç¼“å­˜

---

## 8. æœ€ä½³å®è·µ

### 8.1 ç›‘æ§æœ€ä½³å®è·µ

**æŒ‡æ ‡é€‰æ‹©**ï¼š

- âœ… æ ¸å¿ƒæŒ‡æ ‡ï¼šè¿æ¥æ•°ã€ç¼“å­˜å‘½ä¸­ç‡ã€æŸ¥è¯¢å»¶è¿Ÿ
- âœ… å­˜å‚¨æŒ‡æ ‡ï¼šè¡¨å¤§å°ã€ç´¢å¼•å¤§å°ã€è†¨èƒ€ç‡
- âœ… å¤åˆ¶æŒ‡æ ‡ï¼šå»¶è¿Ÿã€åŒæ­¥çŠ¶æ€
- âœ… å¤‡ä»½æŒ‡æ ‡ï¼šå¤‡ä»½æ—¶é—´ã€æ¢å¤æ—¶é—´

**å‘Šè­¦è®¾ç½®**ï¼š

- âœ… è®¾ç½®åˆç†çš„é˜ˆå€¼
- âœ… é¿å…å‘Šè­¦é£æš´
- âœ… åˆ†çº§å‘Šè­¦ï¼ˆwarning/criticalï¼‰
- âœ… å‘Šè­¦å…³è”å’Œå»é‡

### 8.2 æ—¥å¿—æœ€ä½³å®è·µ

**æ—¥å¿—çº§åˆ«**ï¼š

- ERRORï¼šé”™è¯¯æ—¥å¿—
- WARNINGï¼šè­¦å‘Šæ—¥å¿—
- INFOï¼šä¿¡æ¯æ—¥å¿—ï¼ˆé€‚åº¦ï¼‰
- DEBUGï¼šè°ƒè¯•æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ—¥å¿—ä¿ç•™**ï¼š

- ç”Ÿäº§ç¯å¢ƒï¼š30-90å¤©
- å¼€å‘ç¯å¢ƒï¼š7-30å¤©
- å½’æ¡£ï¼šé•¿æœŸå­˜å‚¨

**æ—¥å¿—åˆ†æ**ï¼š

- æ…¢æŸ¥è¯¢åˆ†æ
- é”™è¯¯æ¨¡å¼è¯†åˆ«
- æ€§èƒ½è¶‹åŠ¿åˆ†æ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: RUNBOOK-02
