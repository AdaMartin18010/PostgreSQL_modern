---

> **📋 文档来源**: `PostgreSQL\runbook\02-监控与诊断-落地指南.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 监控与诊断-落地指南（Runbook）

## 1. 组件

- postgres_exporter、Prometheus、Grafana、日志管道（Filebeat/Vector → Loki/Elastic）。
- 参考：`04-部署运维/04.04-监控与诊断.md`。

## 2. 步骤

1) 创建监控用户：

    ```sql
    CREATE ROLE metrics WITH LOGIN PASSWORD '***';
    GRANT pg_monitor TO metrics;
    -- 细粒度：GRANT pg_read_all_stats TO metrics;
    ```

2) 启动 exporter：

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

3) Prometheus 抓取：

    ```yaml
    scrape_configs:
    - job_name: pg
        scrape_interval: 15s
        static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
    ```

4) Grafana 导入：连接/事务、命中率/WAL、检查点、Autovacuum、锁等待、Top 查询。

## 3. 日志建议

```text
log_line_prefix = '%m [%p] %u@%d %r %a '
log_min_duration_statement = 500ms
log_checkpoints = on
log_autovacuum_min_duration = 1s
log_lock_waits = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

## 4. 诊断SQL

- 见 `sql/diagnostics.sql`；慢SQL面板 TopN 与 EXPLAIN 结合。

## 5. 告警门槛（示例）

- 连接使用率 > 80%；缓冲命中率 < 95%；WAL 速率骤增；检查点过于频繁；Autovacuum 滞后；死锁事件。
