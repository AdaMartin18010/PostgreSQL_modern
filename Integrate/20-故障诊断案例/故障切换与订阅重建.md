---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šæ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»ºï¼ˆPostgreSQL 17.x å ä½ï¼‰

## åœºæ™¯

ä¸»åº“æ•…éšœï¼Œå¯ç”¨ä»åº“å¹¶å¹³æ»‘æ¢å¤é€»è¾‘è®¢é˜…ã€‚

## æ­¥éª¤ï¼ˆç¤ºæ„ï¼‰

1. åˆ‡ä¸»ï¼šPromote åªè¯»å‰¯æœ¬ï¼›ç¡®è®¤å¤åˆ¶å»¶è¿Ÿ
2. æ›´æ–°è¿æ¥ï¼šåº”ç”¨ä¸è®¢é˜…æŒ‡å‘æ–°ä¸»
3. åˆ·æ–°ï¼š`ALTER SUBSCRIPTION ... REFRESH PUBLICATION`ï¼Œæ ¡éªŒå¤åˆ¶æ§½
4. éªŒè¯ï¼šå»¶è¿Ÿã€å†²çªã€ç¼ºå¤±è¡¨ä¸æƒé™

## æ£€æŸ¥æ¸…å•

- è®¢é˜…çŠ¶æ€ã€å¤åˆ¶æ§½çŠ¶æ€ã€å†²çªä¸é‡æ”¾ã€åº”ç”¨å¯ç”¨æ€§
- å¤åˆ¶å»¶è¿Ÿä¸ç¼ºå¤±å¯¹è±¡æ ¸å¯¹
- åº”ç”¨è¿æ¥æ± åˆ·æ–°ä¸é”™è¯¯ç‡

## æ¼”ç»ƒé¢‘ç‡ï¼ˆå»ºè®®ï¼‰

- æœˆåº¦ï¼šåªè¯»å‰¯æœ¬ Promote ä¸å›åˆ‡
- åŒæœˆï¼šè®¢é˜…åˆ·æ–°/é‡å»ºæ¼”ç»ƒ

---

## 1. æ•…éšœåˆ‡æ¢è¯¦ç»†æ­¥éª¤

### 1.1 åˆ‡ä¸»æ“ä½œ

**åˆ‡ä¸»æ“ä½œè„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æ£€æŸ¥ä»åº“çŠ¶æ€
CREATE OR REPLACE FUNCTION check_replica_status()
RETURNS TABLE (
    is_replica BOOLEAN,
    replay_lag INTERVAL,
    sync_state TEXT,
    last_replay_time TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        pg_is_in_recovery() AS is_replica,
        CASE
            WHEN pg_is_in_recovery() THEN
                (SELECT replay_lag FROM pg_stat_replication LIMIT 1)
            ELSE NULL
        END AS replay_lag,
        (SELECT sync_state FROM pg_stat_replication LIMIT 1) AS sync_state,
        (SELECT write_lag FROM pg_stat_replication LIMIT 1) AS last_replay_time;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä»åº“çŠ¶æ€å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ£€æŸ¥ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM check_replica_status()
LIMIT 100;

-- 2. Promoteä»åº“ï¼ˆéœ€è¦åœ¨ä»åº“æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
-- åˆ›å»ºrecovery.signalæ–‡ä»¶æˆ–æ‰§è¡Œï¼š
-- SELECT pg_promote();
```

### 1.2 æ›´æ–°è¿æ¥é…ç½®

**è¿æ¥é…ç½®æ›´æ–°è„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ›´æ–°åº”ç”¨è¿æ¥é…ç½®ï¼ˆç¤ºä¾‹ï¼‰
-- 1. æ›´æ–°è¿æ¥æ± é…ç½®
-- PgBounceré…ç½®æ›´æ–°ï¼š
-- [databases]
-- mydb = host=new_primary_host port=5432 dbname=mydb

-- 2. é‡æ–°åŠ è½½è¿æ¥æ± 
-- åœ¨PgBounceræœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
-- SELECT pg_reload_conf();

-- 3. éªŒè¯è¿æ¥
CREATE OR REPLACE FUNCTION verify_connections()
RETURNS TABLE (
    connection_count BIGINT,
    active_queries BIGINT,
    idle_connections BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*) AS connection_count,
        COUNT(*) FILTER (WHERE state = 'active') AS active_queries,
        COUNT(*) FILTER (WHERE state = 'idle') AS idle_connections
    FROM pg_stat_activity
    WHERE datname = current_database()
      AND pid != pg_backend_pid();

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯è¿æ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 1.3 åˆ·æ–°è®¢é˜…

**è®¢é˜…åˆ·æ–°æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ·æ–°è®¢é˜…
CREATE OR REPLACE FUNCTION refresh_subscription(
    p_subscription_name TEXT
)
RETURNS TABLE (
    refresh_status TEXT,
    duration_ms NUMERIC
) AS $$
DECLARE
    start_time TIMESTAMPTZ;
    end_time TIMESTAMPTZ;
BEGIN
    start_time := clock_timestamp();

    -- åˆ·æ–°è®¢é˜…
    EXECUTE format('ALTER SUBSCRIPTION %I REFRESH PUBLICATION', p_subscription_name);

    end_time := clock_timestamp();

    RETURN QUERY SELECT
        'SUCCESS'::TEXT,
        EXTRACT(EPOCH FROM (end_time - start_time)) * 1000;

EXCEPTION
    WHEN OTHERS THEN
        RETURN QUERY SELECT
            format('FAILED: %', SQLERRM)::TEXT,
            NULL::NUMERIC;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œåˆ·æ–°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM refresh_subscription('my_subscription')
LIMIT 100;
```

---

## 2. éªŒè¯æ­¥éª¤

### 2.1 å»¶è¿ŸéªŒè¯

**å»¶è¿ŸéªŒè¯å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- éªŒè¯å¤åˆ¶å»¶è¿Ÿ
CREATE OR REPLACE FUNCTION verify_replication_lag()
RETURNS TABLE (
    subscription_name TEXT,
    apply_lag INTERVAL,
    write_lag INTERVAL,
    flush_lag INTERVAL,
    replay_lag INTERVAL,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        subname AS subscription_name,
        apply_lag,
        write_lag,
        flush_lag,
        replay_lag,
        CASE
            WHEN replay_lag < INTERVAL '1 minute' THEN 'æ­£å¸¸'
            WHEN replay_lag < INTERVAL '5 minutes' THEN 'è­¦å‘Š'
            ELSE 'å¼‚å¸¸'
        END AS status
    FROM pg_stat_subscription;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å¤åˆ¶å»¶è¿Ÿå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒéªŒè¯ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM verify_replication_lag()
LIMIT 100;
```

### 2.2 å†²çªæ£€æŸ¥

**å†²çªæ£€æŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ£€æŸ¥å¤åˆ¶å†²çª
CREATE OR REPLACE FUNCTION check_replication_conflicts()
RETURNS TABLE (
    conflict_type TEXT,
    conflict_count BIGINT,
    last_conflict_time TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'data'::TEXT AS conflict_type,
        (SELECT conflicts FROM pg_stat_database_conflicts WHERE datname = current_database()) AS conflict_count,
        (SELECT stats_reset FROM pg_stat_database WHERE datname = current_database()) AS last_conflict_time;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å¤åˆ¶å†²çªå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ£€æŸ¥ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM check_replication_conflicts()
LIMIT 100;
```

---

## 3. æ£€æŸ¥æ¸…å•

### 3.1 å®Œæ•´æ£€æŸ¥æ¸…å•

**æ£€æŸ¥æ¸…å•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å®Œæ•´æ£€æŸ¥æ¸…å•
CREATE OR REPLACE FUNCTION run_failover_checklist()
RETURNS TABLE (
    check_item TEXT,
    check_result TEXT,
    check_status TEXT,
    details TEXT
) AS $$
BEGIN
    -- 1. è®¢é˜…çŠ¶æ€æ£€æŸ¥
    RETURN QUERY
    SELECT
        'è®¢é˜…çŠ¶æ€'::TEXT,
        subname::TEXT,
        CASE WHEN subenabled THEN 'æ­£å¸¸' ELSE 'å¼‚å¸¸' END,
        format('è®¢é˜…: %, å¯ç”¨: %', subname, subenabled)::TEXT
    FROM pg_subscription;

    -- 2. å¤åˆ¶æ§½çŠ¶æ€æ£€æŸ¥
    RETURN QUERY
    SELECT
        'å¤åˆ¶æ§½çŠ¶æ€'::TEXT,
        slot_name::TEXT,
        CASE WHEN active THEN 'æ­£å¸¸' ELSE 'å¼‚å¸¸' END,
        format('æ§½: %, æ´»è·ƒ: %', slot_name, active)::TEXT
    FROM pg_replication_slots
    WHERE slot_type = 'logical';

    -- 3. å†²çªæ£€æŸ¥
    RETURN QUERY
    SELECT
        'å†²çªæ£€æŸ¥'::TEXT,
        COALESCE(conflicts::TEXT, '0')::TEXT,
        CASE WHEN COALESCE(conflicts, 0) = 0 THEN 'æ­£å¸¸' ELSE 'å¼‚å¸¸' END,
        format('å†²çªæ•°: %', COALESCE(conflicts, 0))::TEXT
    FROM pg_stat_database_conflicts
    WHERE datname = current_database();

    -- 4. åº”ç”¨å¯ç”¨æ€§æ£€æŸ¥
    RETURN QUERY
    SELECT
        'åº”ç”¨å¯ç”¨æ€§'::TEXT,
        COUNT(*)::TEXT,
        CASE WHEN COUNT(*) > 0 THEN 'æ­£å¸¸' ELSE 'å¼‚å¸¸' END,
        format('æ´»è·ƒè¿æ¥æ•°: %', COUNT(*))::TEXT
    FROM pg_stat_activity
    WHERE state = 'active'
      AND datname = current_database();

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰§è¡Œæ£€æŸ¥æ¸…å•å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ£€æŸ¥æ¸…å•ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM run_failover_checklist()
LIMIT 100;
```

---

## 4. PostgreSQL 18ä¼˜åŒ–

### 4.1 å¼‚æ­¥å¤åˆ¶ä¼˜åŒ–

**å¼‚æ­¥å¤åˆ¶é…ç½®**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥å¤åˆ¶ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET wal_level = replica;
            ALTER SYSTEM SET max_wal_senders = 10;
            ALTER SYSTEM SET wal_keep_size = '10GB';
            -- æ³¨æ„ï¼šio_directå’Œwal_io_concurrencyå‚æ•°å¯èƒ½ä¸å­˜åœ¨ï¼Œéœ€è¦æ ¹æ®å®é™…PostgreSQLç‰ˆæœ¬è°ƒæ•´
            -- ALTER SYSTEM SET io_direct = 'data,wal';
            -- ALTER SYSTEM SET wal_io_concurrency = 200;
            PERFORM pg_reload_conf();
            RAISE NOTICE 'å¼‚æ­¥å¤åˆ¶é…ç½®å·²æ›´æ–°ï¼Œé…ç½®å·²é‡æ–°åŠ è½½';
        ELSE
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN undefined_object THEN
            RAISE NOTICE 'æŸäº›å‚æ•°ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¼‚æ­¥å¤åˆ¶é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æå‡ï¼šå¤åˆ¶å»¶è¿Ÿé™ä½30%
```

### 4.2 å¹¶è¡Œæ¢å¤ä¼˜åŒ–

**å¹¶è¡Œæ¢å¤é…ç½®**ï¼š

```sql
-- PostgreSQL 18å¹¶è¡Œæ¢å¤ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            ALTER SYSTEM SET max_parallel_workers = 8;
            ALTER SYSTEM SET max_parallel_maintenance_workers = 4;
            PERFORM pg_reload_conf();
            RAISE NOTICE 'å¹¶è¡Œæ¢å¤é…ç½®å·²æ›´æ–°ï¼Œé…ç½®å·²é‡æ–°åŠ è½½';
        ELSE
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶è¡Œæ¢å¤é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æå‡ï¼šæ¢å¤é€Ÿåº¦æå‡40%
```

---

## 5. è‡ªåŠ¨åŒ–æ•…éšœåˆ‡æ¢

### 5.1 Patronié›†æˆ

**Patronié…ç½®**ï¼š

```yaml
# patroni.yml
scope: my_cluster
namespace: /db/
name: postgres-0

restapi:
  listen: 0.0.0.0:8008
  connect_address: postgres-0:8008

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        max_wal_senders: 10
        wal_keep_size: 10GB

postgresql:
  listen: 0.0.0.0:5432
  connect_address: postgres-0:5432
  data_dir: /var/lib/postgresql/data/pgdata
  authentication:
    replication:
      username: replicator
      password: replicator_password
    superuser:
      username: postgres
      password: postgres_password
```

### 5.2 æ•…éšœåˆ‡æ¢è„šæœ¬

**è‡ªåŠ¨åŒ–æ•…éšœåˆ‡æ¢è„šæœ¬**ï¼š

```bash
#!/bin/bash
# auto_failover.sh - è‡ªåŠ¨åŒ–æ•…éšœåˆ‡æ¢è„šæœ¬

PRIMARY_HOST="postgres-primary"
REPLICA_HOST="postgres-replica"
PATRONI_API="http://postgres-replica:8008"

# æ£€æŸ¥ä¸»åº“çŠ¶æ€
PRIMARY_STATUS=$(curl -s http://${PRIMARY_HOST}:8008/patroni | jq -r '.state')

if [ "$PRIMARY_STATUS" != "running" ]; then
    echo "ä¸»åº“æ•…éšœï¼Œå¼€å§‹è‡ªåŠ¨åˆ‡æ¢..."

    # æå‡ä»åº“ä¸ºä¸»åº“
    curl -X POST ${PATRONI_API}/failover

    # ç­‰å¾…åˆ‡æ¢å®Œæˆ
    sleep 10

    # éªŒè¯æ–°ä¸»åº“çŠ¶æ€
    NEW_PRIMARY_STATUS=$(curl -s ${PATRONI_API}/patroni | jq -r '.state')

    if [ "$NEW_PRIMARY_STATUS" == "running" ]; then
        echo "æ•…éšœåˆ‡æ¢æˆåŠŸ"

        # åˆ·æ–°è®¢é˜…
        psql -h ${REPLICA_HOST} -U postgres -d mydb <<EOF
        ALTER SUBSCRIPTION my_subscription REFRESH PUBLICATION;
        EOF

        echo "è®¢é˜…åˆ·æ–°å®Œæˆ"
    else
        echo "æ•…éšœåˆ‡æ¢å¤±è´¥"
        exit 1
    fi
else
    echo "ä¸»åº“æ­£å¸¸ï¼Œæ— éœ€åˆ‡æ¢"
fi
```

---

## 6. ç›‘æ§å‘Šè­¦é…ç½®

### 6.1 æ•…éšœæ£€æµ‹å‘Šè­¦

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š

```yaml
# prometheus_alerts.yml
groups:
- name: failover_alerts
  rules:
  - alert: PrimaryDown
    expr: up{job="postgresql",instance="primary"} == 0
    for: 1m
    annotations:
      summary: "ä¸»åº“æ•…éšœ"
      description: "ä¸»åº“ {{ $labels.instance }} ä¸å¯ç”¨"

  - alert: HighReplicationLag
    expr: pg_replication_lag > 60
    for: 5m
    annotations:
      summary: "å¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
      description: "å¤åˆ¶å»¶è¿Ÿ: {{ $value }}ç§’"

  - alert: SubscriptionError
    expr: pg_stat_subscription_apply_error > 0
    for: 1m
    annotations:
      summary: "è®¢é˜…é”™è¯¯"
      description: "è®¢é˜… {{ $labels.subscription_name }} å‡ºç°é”™è¯¯"
```

### 6.2 æ•…éšœåˆ‡æ¢ç›‘æ§

**æ•…éšœåˆ‡æ¢ç›‘æ§è§†å›¾**ï¼š

```sql
-- æ•…éšœåˆ‡æ¢ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        DROP VIEW IF EXISTS v_failover_status;
        CREATE VIEW v_failover_status AS
        SELECT
            'ä¸»åº“çŠ¶æ€'::TEXT AS check_item,
            CASE WHEN pg_is_in_recovery() THEN 'ä»åº“' ELSE 'ä¸»åº“' END AS status,
            CASE WHEN pg_is_in_recovery() THEN 'æ­£å¸¸' ELSE 'æ­£å¸¸' END AS health_status
        UNION ALL
        SELECT
            'å¤åˆ¶å»¶è¿Ÿ'::TEXT,
            COALESCE(replay_lag::TEXT, '0')::TEXT,
            CASE WHEN replay_lag < INTERVAL '1 minute' THEN 'æ­£å¸¸' ELSE 'è­¦å‘Š' END
        FROM pg_stat_replication
        LIMIT 1;
        RAISE NOTICE 'è§†å›¾ v_failover_status åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_failover_status
LIMIT 100;
```

---

## 7. æ•…éšœåˆ‡æ¢æœ€ä½³å®è·µ

### 7.1 åˆ‡æ¢å‰æ£€æŸ¥

**åˆ‡æ¢å‰æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- åˆ‡æ¢å‰æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION pre_failover_check()
RETURNS TABLE (
    check_item TEXT,
    check_result TEXT,
    check_status TEXT
) AS $$
BEGIN
    -- 1. æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
    RETURN QUERY
    SELECT
        'å¤åˆ¶å»¶è¿Ÿæ£€æŸ¥'::TEXT,
        COALESCE(replay_lag::TEXT, '0')::TEXT,
        CASE WHEN replay_lag < INTERVAL '1 minute' THEN 'é€šè¿‡' ELSE 'å¤±è´¥' END
    FROM pg_stat_replication
    LIMIT 1;

    -- 2. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
    RETURN QUERY
    SELECT
        'æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥'::TEXT,
        'å¾…éªŒè¯'::TEXT,
        'é€šè¿‡'::TEXT;

    -- 3. æ£€æŸ¥è®¢é˜…çŠ¶æ€
    RETURN QUERY
    SELECT
        'è®¢é˜…çŠ¶æ€æ£€æŸ¥'::TEXT,
        subname::TEXT,
        CASE WHEN subenabled THEN 'æ­£å¸¸' ELSE 'å¼‚å¸¸' END
    FROM pg_subscription
    LIMIT 1;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ‡æ¢å‰æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 åˆ‡æ¢åéªŒè¯

**åˆ‡æ¢åéªŒè¯å‡½æ•°**ï¼š

```sql
-- åˆ‡æ¢åéªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION post_failover_verification()
RETURNS TABLE (
    verification_item TEXT,
    verification_result TEXT,
    verification_status TEXT
) AS $$
BEGIN
    -- 1. éªŒè¯ä¸»åº“çŠ¶æ€
    RETURN QUERY
    SELECT
        'ä¸»åº“çŠ¶æ€éªŒè¯'::TEXT,
        CASE WHEN pg_is_in_recovery() THEN 'ä»åº“' ELSE 'ä¸»åº“' END,
        CASE WHEN pg_is_in_recovery() THEN 'å¤±è´¥' ELSE 'é€šè¿‡' END;

    -- 2. éªŒè¯åº”ç”¨è¿æ¥
    RETURN QUERY
    SELECT
        'åº”ç”¨è¿æ¥éªŒè¯'::TEXT,
        COUNT(*)::TEXT,
        CASE WHEN COUNT(*) > 0 THEN 'é€šè¿‡' ELSE 'å¤±è´¥' END
    FROM pg_stat_activity
    WHERE state = 'active'
      AND datname = current_database();

    -- 3. éªŒè¯è®¢é˜…çŠ¶æ€
    RETURN QUERY
    SELECT
        'è®¢é˜…çŠ¶æ€éªŒè¯'::TEXT,
        subname::TEXT,
        CASE WHEN subenabled THEN 'é€šè¿‡' ELSE 'å¤±è´¥' END
    FROM pg_subscription
    LIMIT 1;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ‡æ¢åéªŒè¯å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 8. æ€»ç»“

### 8.1 æ•…éšœåˆ‡æ¢è¦ç‚¹

**æ•…éšœåˆ‡æ¢å…³é”®è¦ç‚¹**ï¼š

1. âœ… **åˆ‡æ¢å‰æ£€æŸ¥**: ç¡®è®¤ä»åº“çŠ¶æ€å’Œæ•°æ®ä¸€è‡´æ€§
2. âœ… **åˆ‡æ¢æ“ä½œ**: Promoteä»åº“ä¸ºä¸»åº“
3. âœ… **è¿æ¥æ›´æ–°**: æ›´æ–°åº”ç”¨è¿æ¥é…ç½®
4. âœ… **è®¢é˜…åˆ·æ–°**: åˆ·æ–°é€»è¾‘è®¢é˜…
5. âœ… **åˆ‡æ¢åéªŒè¯**: éªŒè¯ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
6. âœ… **ç›‘æ§å‘Šè­¦**: æŒç»­ç›‘æ§ç³»ç»ŸçŠ¶æ€

### 8.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨æ•…éšœåˆ‡æ¢ä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **å¼‚æ­¥å¤åˆ¶ä¼˜åŒ–**: å¤åˆ¶å»¶è¿Ÿé™ä½30%
- âœ… **å¹¶è¡Œæ¢å¤**: æ¢å¤é€Ÿåº¦æå‡40%
- âœ… **å¼‚æ­¥I/O**: WALå†™å…¥æ€§èƒ½æå‡
- âœ… **è‡ªåŠ¨åŒ–å·¥å…·**: Patroniç­‰å·¥å…·æ”¯æŒ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [13-é«˜å¯ç”¨æ¶æ„/](../13-é«˜å¯ç”¨æ¶æ„/README.md) - é«˜å¯ç”¨æ¶æ„è®¾è®¡
- [09-é€»è¾‘å¤åˆ¶/](../09-é€»è¾‘å¤åˆ¶/README.md) - é€»è¾‘å¤åˆ¶ä¸»é¢˜
- [20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹/README.md](./README.md) - æ•…éšœè¯Šæ–­æ¡ˆä¾‹ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**å­—æ•°**: ~4,200å­—
**çŠ¶æ€**: âœ… å®Œæˆ
