---

> **📋 文档来源**: `PostgreSQL\runbook\06-日志与可观测性-落地指南.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 日志与可观测性-落地指南（Runbook）

对齐：`04-部署运维/04.04-监控与诊断.md`

## 1. 日志配置建议

```text
log_line_prefix = '%m [%p] %u@%d %r %a '
log_min_duration_statement = 500ms
log_checkpoints = on
log_autovacuum_min_duration = 1s
log_lock_waits = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

## 2. 日志采集

- Filebeat/Vector → Loki/Elastic；建立索引/生命周期策略；
- 慢SQL归一化（fingerprint）用于TopN 聚合与画像。

## 3. 面板与告警

- 连接/事务、命中率/WAL速率、检查点、Autovacuum、锁等待、慢SQL；
- 告警：连接>80%、命中率<95%、WAL 暴涨、检查点频繁、Vacuum 滞后、死锁事件。

## 4. 关联追踪

- 通过 `log_line_prefix` 注入 `application_name`/请求ID，打通应用追踪；
- 将 TopN 语句映射回服务/接口，形成优化闭环。
