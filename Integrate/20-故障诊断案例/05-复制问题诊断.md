---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\05-å¤åˆ¶é—®é¢˜è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤åˆ¶é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**
> **æµå¤åˆ¶ã€é€»è¾‘å¤åˆ¶ã€å»¶è¿Ÿ**

---

## æ¡ˆä¾‹1ï¼šå¤åˆ¶å»¶è¿Ÿé«˜

### ç—‡çŠ¶

```text
ä¸»ä»å»¶è¿ŸæŒç»­å¢é•¿
ä»åº“æŸ¥è¯¢æ•°æ®æ»å
ç›‘æ§æ˜¾ç¤ºreplay_lag > 1åˆ†é’Ÿ
```

### è¯Šæ–­

```sql
-- åœ¨ä¸»åº“æ£€æŸ¥å¤åˆ¶çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    client_addr,
    usename,
    application_name,
    state,
    sync_state,
    write_lag,
    flush_lag,
    replay_lag,
    sync_priority,
    sync_state
FROM pg_stat_replication
LIMIT 100;

/*
replay_lag: 00:05:23.456789 (5åˆ†é’Ÿå»¶è¿Ÿï¼)
state: streaming
*/

-- æ£€æŸ¥WALç”Ÿæˆé€Ÿåº¦ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        '0/0'
    )) AS total_wal_size;

-- æ£€æŸ¥ä»åº“çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_is_in_recovery() AS is_replica,
    pg_last_wal_receive_lsn() AS receive_lsn,
    pg_last_wal_replay_lsn() AS replay_lsn,
    pg_wal_lsn_diff(
        pg_last_wal_receive_lsn(),
        pg_last_wal_replay_lsn()
    ) AS lag_bytes;

-- æ£€æŸ¥ä»åº“åº”ç”¨å»¶è¿ŸåŸå› ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE backend_type = 'walreceiver'
   OR backend_type = 'walsender'
LIMIT 100;
```

### è§£å†³

```sql
-- 1. æ£€æŸ¥ç½‘ç»œå¸¦å®½ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
-- ä»åº“æ‰§è¡Œ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_size_pretty(
    pg_wal_lsn_diff(
        pg_last_wal_receive_lsn(),
        pg_last_wal_replay_lsn()
    )
) AS lag_size;

-- 2. ä¼˜åŒ–ä»åº“é…ç½®
-- postgresql.conf (ä»åº“)
-- max_connections = 200
-- shared_buffers = 8GB
-- wal_receiver_timeout = 60s
-- wal_receiver_status_interval = 10s

-- 3. æ£€æŸ¥ä»åº“æŸ¥è¯¢è´Ÿè½½ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    count(*) AS active_queries,
    sum(EXTRACT(EPOCH FROM (now() - query_start))) AS total_query_time
FROM pg_stat_activity
WHERE state = 'active'
  AND pid != pg_backend_pid();

-- 4. ä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼ˆå¦‚æœå»¶è¿Ÿä¸å¯æ¥å—ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- ä¸»åº“é…ç½®
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser')::boolean THEN
            -- æ³¨æ„ï¼šè¿™äº›é…ç½®éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
            -- ALTER SYSTEM SET synchronous_standby_names = 'ANY 1 (standby1, standby2)';
            -- ALTER SYSTEM SET synchronous_commit = on;
            -- PERFORM pg_reload_conf();
            RAISE NOTICE 'åŒæ­¥å¤åˆ¶é…ç½®éœ€è¦æ‰‹åŠ¨åœ¨postgresql.confä¸­è®¾ç½®';
        ELSE
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®åŒæ­¥å¤åˆ¶é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. ä¼˜åŒ–WALç”Ÿæˆ
-- å‡å°‘ä¸å¿…è¦çš„WAL
-- ä½¿ç”¨UNLOGGEDè¡¨ï¼ˆå¦‚æœå…è®¸ï¼‰
-- æ‰¹é‡æäº¤äº‹åŠ¡
```

---

## æ¡ˆä¾‹2ï¼šå¤åˆ¶ä¸­æ–­

### ç—‡çŠ¶

```text
ä»åº“çŠ¶æ€ï¼šnot streaming
ä¸»åº“æ—¥å¿—ï¼šcould not receive data from WAL stream
ä»åº“æ— æ³•æ¥æ”¶WAL
```

### è¯Šæ–­

```sql
-- ä¸»åº“æ£€æŸ¥å¤åˆ¶è¿æ¥ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    write_lag,
    flush_lag,
    replay_lag
FROM pg_stat_replication
LIMIT 100;

-- å¦‚æœæŸ¥è¯¢è¿”å›ç©ºï¼Œè¯´æ˜å¤åˆ¶è¿æ¥æ–­å¼€

-- æ£€æŸ¥ä¸»åº“WALé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    wal_level_value text;
    max_wal_senders_value text;
BEGIN
    BEGIN
        SHOW wal_level INTO wal_level_value;
        SHOW max_wal_senders INTO max_wal_senders_value;
        RAISE NOTICE 'wal_level: %, max_wal_senders: %', wal_level_value, max_wal_senders_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–WALé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä»åº“æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event
FROM pg_stat_activity
WHERE backend_type = 'walreceiver'
LIMIT 100;

-- æ£€æŸ¥ä»åº“é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    primary_conninfo_value text;
    primary_slot_name_value text;
BEGIN
    BEGIN
        SHOW primary_conninfo INTO primary_conninfo_value;
        SHOW primary_slot_name INTO primary_slot_name_value;
        RAISE NOTICE 'primary_conninfo: %, primary_slot_name: %', primary_conninfo_value, primary_slot_name_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–ä»åº“é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### è§£å†³

```sql
-- 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
-- ä»åº“æ‰§è¡Œ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery() AS is_replica;  -- åº”è¯¥è¿”å› true

-- 2. æ£€æŸ¥å¤åˆ¶æ§½ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
-- ä¸»åº“
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    slot_name,
    slot_type,
    active,
    restart_lsn,
    confirmed_flush_lsn
FROM pg_replication_slots
LIMIT 100;

-- å¦‚æœslotä¸å­˜åœ¨æˆ–inactiveï¼Œé‡æ–°åˆ›å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_replication_slots WHERE slot_name = 'standby1_slot'
        ) THEN
            PERFORM pg_create_physical_replication_slot('standby1_slot');
            RAISE NOTICE 'å¤åˆ¶æ§½ standby1_slot åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å¤åˆ¶æ§½ standby1_slot å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'å¤åˆ¶æ§½å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤åˆ¶æ§½å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æ£€æŸ¥ä»åº“recoveryé…ç½®
-- postgresql.conf (ä»åº“)
-- primary_conninfo = 'host=primary_host port=5432 user=replicator password=xxx'
-- primary_slot_name = 'standby1_slot'
-- restore_command = 'cp /path/to/archive/%f %p'

-- 4. é‡å¯ä»åº“WALæ¥æ”¶è¿›ç¨‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- ä»åº“æ‰§è¡Œ
DO $$
BEGIN
    BEGIN
        IF pg_is_in_recovery() THEN
            PERFORM pg_wal_replay_resume();  -- å¦‚æœæš‚åœäº†
            RAISE NOTICE 'WALé‡æ”¾å·²æ¢å¤';
        ELSE
            RAISE NOTICE 'å½“å‰ä¸åœ¨æ¢å¤æ¨¡å¼ï¼Œè·³è¿‡WALé‡æ”¾æ¢å¤';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¢å¤WALé‡æ”¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. é‡æ–°åŒæ­¥ï¼ˆå¦‚æœæ•°æ®ä¸ä¸€è‡´ï¼‰
-- ä½¿ç”¨pg_basebackupé‡æ–°åŒæ­¥ï¼ˆéœ€è¦åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼‰
-- pg_basebackup -h primary_host -D /var/lib/postgresql/data -U replicator -v -P -W
```

---

## æ¡ˆä¾‹3ï¼šé€»è¾‘å¤åˆ¶å»¶è¿Ÿ

### ç—‡çŠ¶

```text
é€»è¾‘å¤åˆ¶è®¢é˜…å»¶è¿Ÿ
pg_stat_subscriptionæ˜¾ç¤ºå»¶è¿Ÿ
æ•°æ®ä¸åŒæ­¥
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥è®¢é˜…çŠ¶æ€
SELECT
    subid,
    subname,
    pid,
    relid,
    received_lsn,
    last_msg_send_time,
    last_msg_receipt_time,
    latest_end_lsn,
    latest_end_time
FROM pg_stat_subscription;

-- æ£€æŸ¥å¤åˆ¶æ§½çŠ¶æ€
SELECT
    slot_name,
    slot_type,
    database,
    active,
    restart_lsn,
    confirmed_flush_lsn,
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            confirmed_flush_lsn
        )
    ) AS lag_size
FROM pg_replication_slots
WHERE slot_type = 'logical';

-- æ£€æŸ¥å‘å¸ƒç«¯çŠ¶æ€
SELECT
    pubname,
    puballtables,
    pubinsert,
    pubupdate,
    pubdelete,
    pubtruncate
FROM pg_publication;

-- æ£€æŸ¥è®¢é˜…ç«¯çŠ¶æ€
SELECT
    subname,
    subenabled,
    subpublications
FROM pg_subscription;
```

### è§£å†³

```sql
-- 1. æ£€æŸ¥è®¢é˜…è¿›ç¨‹
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE backend_type = 'logical replication worker';

-- 2. ä¼˜åŒ–é€»è¾‘å¤åˆ¶é…ç½®
-- å‘å¸ƒç«¯
max_replication_slots = 10
max_wal_senders = 10
wal_level = logical

-- è®¢é˜…ç«¯
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2

-- 3. æ£€æŸ¥è¡¨å¤§å°ï¼ˆå¤§è¡¨å¯èƒ½å»¶è¿Ÿï¼‰
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 4. é‡æ–°åŒæ­¥ç‰¹å®šè¡¨
ALTER SUBSCRIPTION my_subscription REFRESH PUBLICATION;
ALTER SUBSCRIPTION my_subscription SET (synchronous_commit = off);

-- 5. ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
CREATE VIEW replication_lag AS
SELECT
    slot_name,
    pg_size_pretty(
        pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            confirmed_flush_lsn
        )
    ) AS lag_size,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        confirmed_flush_lsn
    ) / 1024 / 1024 AS lag_mb
FROM pg_replication_slots
WHERE slot_type = 'logical';
```

---

## æ¡ˆä¾‹4ï¼šå¤åˆ¶å†²çª

### ç—‡çŠ¶

```text
ä»åº“æ—¥å¿—ï¼šconflict with recovery
æŸ¥è¯¢è¢«å–æ¶ˆ
æ•°æ®ä¸ä¸€è‡´
```

### è¯Šæ–­

```sql
-- æ£€æŸ¥å†²çªç»Ÿè®¡
SELECT
    datname,
    confl_tablespace,
    confl_lock,
    confl_snapshot,
    confl_bufferpin,
    confl_deadlock
FROM pg_stat_database_conflicts;

-- æ£€æŸ¥ä»åº“æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    state,
    query,
    query_start
FROM pg_stat_activity
WHERE datname = current_database()
  AND state = 'active';
```

### è§£å†³

```sql
-- 1. è®¾ç½®å†²çªå¤„ç†ç­–ç•¥
-- postgresql.conf (ä»åº“)
max_standby_streaming_delay = 30s  -- å…è®¸å»¶è¿Ÿ30ç§’
hot_standby_feedback = on  -- å‘ä¸»åº“åé¦ˆæŸ¥è¯¢ä¿¡æ¯

-- 2. å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
-- ä»åº“æ‰§è¡Œ
SELECT pg_cancel_backend(pid)
FROM pg_stat_activity
WHERE state = 'active'
  AND now() - query_start > interval '30 seconds';

-- 3. ä½¿ç”¨åªè¯»æŸ¥è¯¢ï¼ˆé¿å…å†²çªï¼‰
-- è®¾ç½®äº‹åŠ¡ä¸ºåªè¯»
SET TRANSACTION READ ONLY;

-- 4. æ£€æŸ¥è¡¨é”å†²çª
SELECT
    l.pid,
    l.mode,
    l.granted,
    a.query,
    a.state
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.relation = 'problematic_table'::regclass;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
