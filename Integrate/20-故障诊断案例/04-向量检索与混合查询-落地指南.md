---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\04-å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

å¯¹é½ï¼š`03-é«˜çº§ç‰¹æ€§/03.05-å‘é‡æ•°æ®åº“æ”¯æŒ.md`

## 1. ç›®æ ‡

- å»ºç«‹â€œå‘é‡å¬å› + ç»“æ„åŒ–è¿‡æ»¤ + å…¨æ–‡æƒé‡â€çš„æ··åˆæ£€ç´¢æµæ°´çº¿ï¼Œæ”¯æŒåœ¨çº¿æŸ¥è¯¢ä¸ç¦»çº¿é‡æ’ã€‚

## 2. å‰ç½®

- å®‰è£… `pgvector`ï¼›å‡†å¤‡ `docs(id, text, embedding vector(n))`ï¼›
- é€‰æ‹©ç´¢å¼•ï¼ˆHNSW/IVFFlat/PQï¼‰å¹¶ ANALYZEã€‚

## 3. æ­¥éª¤

1) åˆ›å»ºç´¢å¼•ï¼š

    ```sql
    CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
    ```

2) åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰ï¼š

    ```sql
    SELECT id, text
    FROM docs
    WHERE created_at >= now() - interval '7 day'
    ORDER BY embedding <-> $1
    LIMIT 50;
    ```

3) å…¨æ–‡ + å‘é‡èåˆï¼š

    ```sql
    WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
    ORDER BY tr DESC LIMIT 500
    ), v AS (
    SELECT id, embedding <-> $1 AS dist FROM docs WHERE id IN (SELECT id FROM s) ORDER BY dist ASC LIMIT 100
    )
    SELECT d.id, d.text, 0.6*(1.0/v.dist) + 0.4*s.tr AS score
    FROM v d JOIN s ON d.id = s.id
    ORDER BY score DESC LIMIT 50;
    ```

## 4. è¿è¡Œå‚æ•°

- `SET ivfflat.probes = 10;` æŸ¥è¯¢é«˜å¬å›æ—¶è°ƒå¤§ï¼›
- æ§åˆ¶ `work_mem`ï¼Œé¿å…ANNä¸æ’åºå†…å­˜çˆ†ï¼›
- ç›‘æ§å»¶è¿ŸTP95/TP99 ä¸å¬å›æŒ‡æ ‡ã€‚

## 5. éªŒè¯

- ä¸æš´åŠ›çœŸå€¼å¯¹æ¯” Recall@kï¼›æ€§èƒ½åŸºçº¿è®°å½•ä¸å›å½’æ£€æŸ¥ã€‚
