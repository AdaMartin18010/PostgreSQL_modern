---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹åº“\01-æ…¢æŸ¥è¯¢è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿](./æ•…éšœè¯Šæ–­é€šç”¨æ¨¡æ¿.md) - é€šç”¨è¯Šæ–­æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºæ…¢æŸ¥è¯¢è¯Šæ–­çš„è¯¦ç»†æ¡ˆä¾‹å‚è€ƒã€‚

---

# æ…¢æŸ¥è¯¢è¯Šæ–­æ¡ˆä¾‹

> **PostgreSQL 18**

---

## æ¡ˆä¾‹1ï¼šç¼ºå¤±ç´¢å¼•

### ç—‡çŠ¶

```sql
-- æŸ¥è¯¢æ…¢ï¼ˆ15ç§’ï¼‰
SELECT * FROM orders WHERE customer_id = 12345;
```

### è¯Šæ–­

```sql
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders WHERE customer_id = 12345;

/*
Seq Scan on orders (cost=0.00..150000.00 rows=1250 width=120)
                   (actual time=0.5..15000ms rows=1250 loops=1)
  Filter: (customer_id = 12345)
  Rows Removed by Filter: 9998750
  Buffers: shared hit=75000
*/

-- é—®é¢˜ï¼šå…¨è¡¨æ‰«æï¼Œæ‰«æ1000ä¸‡è¡Œ
```

### è§£å†³

```sql
-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_customer ON orders(customer_id);

-- æŸ¥è¯¢æ—¶é—´ï¼š15ç§’ â†’ 8msï¼ˆ-99.9%ï¼‰
```

---

## æ¡ˆä¾‹2ï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ

### ç—‡çŠ¶

```sql
-- JOINæŸ¥è¯¢æ…¢ï¼ˆ45ç§’ï¼‰
SELECT *
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date = '2025-12-04';
```

### è¯Šæ–­

```sql
EXPLAIN ANALYZE ...

/*
Hash Join (cost=... rows=100 width=...)  -- ä¼°è®¡100è¡Œ
           (actual time=... rows=125000 ...)  -- å®é™…125000è¡Œ
  -- åŸºæ•°ä¼°è®¡ä¸¥é‡åç¦»
*/

-- æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'orders';
```

### è§£å†³

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- â­ PostgreSQL 18ï¼šåˆ›å»ºå¤šå˜é‡ç»Ÿè®¡
CREATE STATISTICS orders_stats (dependencies, ndistinct)
ON customer_id, order_date FROM orders;

ANALYZE orders;

-- æŸ¥è¯¢æ—¶é—´ï¼š45ç§’ â†’ 6ç§’ï¼ˆ-87%ï¼‰
```

---

## æ¡ˆä¾‹3ï¼šN+1æŸ¥è¯¢

### ç—‡çŠ¶

```python
# åº”ç”¨ä»£ç 
for order in orders:
    customer = db.query("SELECT * FROM customers WHERE id = ?", order.customer_id)
    # æ‰§è¡Œ1000æ¬¡æŸ¥è¯¢ï¼
```

### è¯Šæ–­

```sql
-- pg_stat_statementsæ˜¾ç¤º
SELECT query, calls FROM pg_stat_statements
WHERE query LIKE '%customers WHERE id%';

-- calls = 1000ï¼ˆå¼‚å¸¸é«˜ï¼‰
```

### è§£å†³

```python
# ä½¿ç”¨JOINä¸€æ¬¡æŸ¥è¯¢
orders_with_customers = db.query("""
    SELECT o.*, c.*
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
    WHERE o.order_date = '2025-12-04'
""")

# æŸ¥è¯¢æ¬¡æ•°ï¼š1000 â†’ 1
# æ—¶é—´ï¼š10ç§’ â†’ 0.5ç§’ï¼ˆ-95%ï¼‰
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
