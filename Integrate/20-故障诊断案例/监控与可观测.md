---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\ç›‘æ§ä¸å¯è§‚æµ‹.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šç›‘æ§ä¸å¯è§‚æµ‹ï¼ˆPostgreSQL 18+ï¼‰

> **æ–‡æ¡£ç¼–å·**: RUNBOOK-ç›‘æ§å¯è§‚æµ‹
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **ç”¨é€”**: PostgreSQLç›‘æ§ä¸å¯è§‚æµ‹æ€§ç”Ÿäº§æŒ‡å—

## ğŸ“‘ ç›®å½•

- [Runbookï¼šç›‘æ§ä¸å¯è§‚æµ‹ï¼ˆPostgreSQL 18+ï¼‰](#runbookç›‘æ§ä¸å¯è§‚æµ‹postgresql-18)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. æŒ‡æ ‡åŸºçº¿](#2-æŒ‡æ ‡åŸºçº¿)
    - [2.1 å®ä¾‹æŒ‡æ ‡](#21-å®ä¾‹æŒ‡æ ‡)
    - [2.2 å­˜å‚¨/IOæŒ‡æ ‡](#22-å­˜å‚¨ioæŒ‡æ ‡)
    - [2.3 æŸ¥è¯¢æŒ‡æ ‡](#23-æŸ¥è¯¢æŒ‡æ ‡)
    - [2.4 è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡](#24-è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡)
    - [3.2 æ¦‚è§ˆé¢æ¿](#32-æ¦‚è§ˆé¢æ¿)
    - [3.3 æŸ¥è¯¢é¢æ¿](#33-æŸ¥è¯¢é¢æ¿)
    - [3.4 å­˜å‚¨é¢æ¿](#34-å­˜å‚¨é¢æ¿)
  - [4. æ•…éšœå®šä½è·¯å¾„](#4-æ•…éšœå®šä½è·¯å¾„)
    - [4.1 è´Ÿè½½é£™å‡å®šä½](#41-è´Ÿè½½é£™å‡å®šä½)
    - [4.2 å¡é¡¿å®šä½](#42-å¡é¡¿å®šä½)
    - [4.3 è†¨èƒ€å®šä½](#43-è†¨èƒ€å®šä½)
  - [5. å‘Šè­¦é—¨é™](#5-å‘Šè­¦é—¨é™)
    - [5.1 å‘Šè­¦è§„åˆ™](#51-å‘Šè­¦è§„åˆ™)
    - [5.2 å‘Šè­¦åˆ†çº§](#52-å‘Šè­¦åˆ†çº§)
  - [6. æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µ](#6-æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µ)
    - [6.1 Top SQLæŸ¥è¯¢](#61-top-sqlæŸ¥è¯¢)
    - [6.2 ç­‰å¾…äº‹ä»¶åˆ†å¸ƒ](#62-ç­‰å¾…äº‹ä»¶åˆ†å¸ƒ)
    - [6.3 Autovacuumç§¯å‹](#63-autovacuumç§¯å‹)
  - [7. å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±](#7-å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±)
    - [7.1 æŒ‡æ ‡ï¼ˆMetricsï¼‰](#71-æŒ‡æ ‡metrics)
    - [7.2 æ—¥å¿—ï¼ˆLogsï¼‰](#72-æ—¥å¿—logs)
    - [7.3 è¿½è¸ªï¼ˆTracesï¼‰](#73-è¿½è¸ªtraces)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 ç›‘æ§æœ€ä½³å®è·µ](#81-ç›‘æ§æœ€ä½³å®è·µ)
    - [8.2 å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ](#82-å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ)

---

## 1. ç›®æ ‡

**ç›‘æ§ç›®æ ‡**ï¼š

- âœ… å»ºç«‹æ€§èƒ½ä¸å¥åº·ç›‘æ§åŸºçº¿
- âœ… è¦†ç›–æŒ‡æ ‡ã€å‘Šè­¦ä¸æ•…éšœå®šä½è·¯å¾„
- âœ… å®ç°å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰
- âœ… æ”¯æŒå¿«é€Ÿæ•…éšœå®šä½å’Œæ¢å¤

**å¯è§‚æµ‹æ€§å®šä¹‰**ï¼š

- **æŒ‡æ ‡ï¼ˆMetricsï¼‰**ï¼šæ•°å€¼å‹æ•°æ®ï¼Œåæ˜ ç³»ç»ŸçŠ¶æ€
- **æ—¥å¿—ï¼ˆLogsï¼‰**ï¼šäº‹ä»¶è®°å½•ï¼Œæä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯
- **è¿½è¸ªï¼ˆTracesï¼‰**ï¼šè¯·æ±‚é“¾è·¯ï¼Œç«¯åˆ°ç«¯è¿½è¸ª

---

## 2. æŒ‡æ ‡åŸºçº¿

### 2.1 å®ä¾‹æŒ‡æ ‡

**è¿æ¥æŒ‡æ ‡**ï¼š

```sql
-- å½“å‰è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) AS total_connections FROM pg_stat_activity;

-- æ´»åŠ¨è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) AS active_connections
FROM pg_stat_activity
WHERE state = 'active';

-- ç­‰å¾…è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT count(*) AS waiting_connections
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL;

-- è¿æ¥ä½¿ç”¨ç‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    count(*)::float / current_setting('max_connections')::float * 100 AS connection_usage_percent
FROM pg_stat_activity
LIMIT 100;
```

**äº‹åŠ¡æŒ‡æ ‡**ï¼š

```sql
-- äº‹åŠ¡æäº¤ç‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    xact_commit,
    xact_rollback,
    round(100.0 * xact_commit / NULLIF(xact_commit + xact_rollback, 0), 2) AS commit_rate
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
LIMIT 100;
```

**æ£€æŸ¥ç‚¹æŒ‡æ ‡**ï¼š

```sql
-- æ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean
FROM pg_stat_bgwriter
LIMIT 100;
```

**WALæŒ‡æ ‡**ï¼š

```sql
-- WALç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    xlog_bytes,
    xlog_bytes_written
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
LIMIT 100;
```

### 2.2 å­˜å‚¨/IOæŒ‡æ ‡

**I/Oç»Ÿè®¡ï¼ˆPostgreSQL 18ï¼‰**ï¼š

```sql
-- I/Oç»Ÿè®¡ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    fsync_write_time,
    write_time
FROM pg_stat_io
ORDER BY reads + writes DESC
LIMIT 100;
```

**è¡¨/ç´¢å¼•è†¨èƒ€**ï¼š

```sql
-- è¡¨è†¨èƒ€ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_tuple_ratio
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;
```

### 2.3 æŸ¥è¯¢æŒ‡æ ‡

**æŸ¥è¯¢ç»Ÿè®¡ï¼ˆpg_stat_statementsï¼‰**ï¼š

```sql
-- Topæ…¢æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 20;
```

**æŸ¥è¯¢è®¡åˆ’å˜åŒ–**ï¼š

```sql
-- æŸ¥è¯¢è®¡åˆ’ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) AS query_preview,
    plans,
    total_plan_time,
    mean_plan_time,
    calls,
    total_exec_time
FROM pg_stat_statements
WHERE plans > 1
ORDER BY total_plan_time DESC
LIMIT 20;
```

### 2.4 è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡

**VACUUM/ANALYZEè¿›åº¦**ï¼š

```sql
-- Autovacuumè¿›åº¦ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    CASE
        WHEN last_autovacuum IS NULL THEN 'Never'
        WHEN last_autovacuum < NOW() - INTERVAL '7 days' THEN 'Stale'
        ELSE 'Recent'
    END AS vacuum_status
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC
LIMIT 20;
```

**Autovacuumç§¯å‹**ï¼š

```sql
-- Autovacuumç§¯å‹ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    CASE
        WHEN n_dead_tup > 1000000 THEN 'Critical'
        WHEN n_dead_tup > 100000 THEN 'Warning'
        ELSE 'Normal'
    END AS backlog_level
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 100;
```

```

---

## 3. ä»ªè¡¨æ¿å»ºè®®

### 3.1 ä»ªè¡¨æ¿ç»“æ„

**å…­å¤§æ¿å—**ï¼š

```mermaid
graph TB
    Overview[æ¦‚è§ˆé¢æ¿]
    Query[æŸ¥è¯¢é¢æ¿]
    Storage[å­˜å‚¨é¢æ¿]
    Replication[å¤åˆ¶é¢æ¿]
    Backup[å¤‡ä»½é¢æ¿]
    Alert[å‘Šè­¦é¢æ¿]

    Overview --> Query
    Overview --> Storage
    Overview --> Replication
    Overview --> Backup
    Overview --> Alert

    style Overview fill:#4a90e2,color:#fff
```

### 3.2 æ¦‚è§ˆé¢æ¿

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | PromQLæŸ¥è¯¢ | è¯´æ˜ |
|------|-----------|------|
| **è¿æ¥æ•°** | `sum(pg_stat_database_numbackends)` | å½“å‰è¿æ¥æ•° |
| **QPS** | `sum(rate(pg_stat_database_xact_commit[5m]))` | æ¯ç§’æŸ¥è¯¢æ•° |
| **ç¼“å­˜å‘½ä¸­ç‡** | `(sum(rate(pg_stat_database_blks_hit[5m])) / sum(rate(pg_stat_database_blks_hit[5m] + pg_stat_database_blks_read[5m]))) * 100` | ç¼“å­˜å‘½ä¸­ç‡ |
| **TPS** | `sum(rate(pg_stat_database_xact_commit[5m]))` | æ¯ç§’äº‹åŠ¡æ•° |

### 3.3 æŸ¥è¯¢é¢æ¿

**æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡**ï¼š

```promql
# Top 10æ…¢æŸ¥è¯¢
topk(10,
  sum(rate(pg_stat_statements_total_exec_time[5m])) by (queryid)
)

# æŸ¥è¯¢å»¶è¿Ÿåˆ†å¸ƒ
histogram_quantile(0.95,
  sum(rate(pg_stat_statements_exec_time_bucket[5m])) by (le, queryid)
)

# æŸ¥è¯¢é”™è¯¯ç‡
sum(rate(pg_stat_statements_calls{state="error"}[5m]))
/ sum(rate(pg_stat_statements_calls[5m]))
```

### 3.4 å­˜å‚¨é¢æ¿

**å­˜å‚¨æŒ‡æ ‡**ï¼š

```promql
# æ•°æ®åº“å¤§å°
sum(pg_database_size_bytes) by (datname)

# è¡¨å¤§å°Top 10
topk(10,
  sum(pg_table_size_bytes) by (schemaname, tablename)
)

# ç´¢å¼•å¤§å°
sum(pg_index_size_bytes) by (schemaname, indexname)
```

---

## 4. æ•…éšœå®šä½è·¯å¾„

### 4.1 è´Ÿè½½é£™å‡å®šä½

**å®šä½æµç¨‹**ï¼š

```mermaid
graph TD
    A[è´Ÿè½½é£™å‡] --> B[æ£€æŸ¥æ´»åŠ¨ä¼šè¯]
    B --> C{æ´»åŠ¨ä¼šè¯å¤š?}
    C -->|æ˜¯| D[æ£€æŸ¥ç­‰å¾…äº‹ä»¶]
    C -->|å¦| E[æ£€æŸ¥æ…¢æŸ¥è¯¢]
    D --> F[æ£€æŸ¥é¡¶å±‚SQL]
    E --> F
    F --> G[æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’]
    G --> H[æ£€æŸ¥é”]
    H --> I[å®šä½é—®é¢˜]
```

**è¯Šæ–­SQL**ï¼š

```sql
-- 1. æ£€æŸ¥æ´»åŠ¨ä¼šè¯ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query_start,
    now() - query_start AS duration,
    LEFT(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY duration DESC
LIMIT 100;

-- 2. æ£€æŸ¥ç­‰å¾…äº‹ä»¶åˆ†å¸ƒï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wait_event_type,
    wait_event,
    count(*) AS count
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC
LIMIT 100;

-- 3. æ£€æŸ¥é¡¶å±‚SQLï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 200) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 4.2 å¡é¡¿å®šä½

**å®šä½æµç¨‹**ï¼š

```mermaid
graph TD
    A[ç³»ç»Ÿå¡é¡¿] --> B[æ£€æŸ¥pg_locks]
    B --> C{æœ‰é”ç­‰å¾…?}
    C -->|æ˜¯| D[æ£€æŸ¥é”å†²çª]
    C -->|å¦| E[æ£€æŸ¥wait_event]
    D --> F[æ£€æŸ¥çƒ­ç‚¹ç´¢å¼•/è¡¨]
    E --> F
    F --> G[å®šä½é—®é¢˜]
```

**è¯Šæ–­SQL**ï¼š

```sql
-- 1. æ£€æŸ¥é”ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
LIMIT 100;

-- 2. æ£€æŸ¥çƒ­ç‚¹è¡¨ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
ORDER BY seq_scan DESC
LIMIT 20;
```

### 4.3 è†¨èƒ€å®šä½

**å®šä½æµç¨‹**ï¼š

```mermaid
graph TD
    A[æ€§èƒ½ä¸‹é™] --> B[æ£€æŸ¥è¡¨è†¨èƒ€]
    B --> C{è†¨èƒ€ä¸¥é‡?}
    C -->|æ˜¯| D[æ£€æŸ¥VACUUMçŠ¶æ€]
    C -->|å¦| E[æ£€æŸ¥ç´¢å¼•è†¨èƒ€]
    D --> F[é‡å»ºç´¢å¼•/è¡¨]
    E --> F
    F --> G[ç»´æŠ¤çª—å£]
```

**è¯Šæ–­SQL**ï¼š

```sql
-- 1. æ£€æŸ¥è¡¨è†¨èƒ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 100;

-- 2. æ£€æŸ¥VACUUMçŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE last_autovacuum < NOW() - INTERVAL '7 days'
ORDER BY n_dead_tup DESC
LIMIT 100;
```

---

## 5. å‘Šè­¦é—¨é™

### 5.1 å‘Šè­¦è§„åˆ™

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š

```yaml
groups:
  - name: postgresql_critical
    interval: 30s
    rules:
      # è¿æ¥ä½¿ç”¨ç‡å‘Šè­¦
      - alert: PostgreSQLHighConnectionUsage
        expr: |
          (sum(pg_stat_database_numbackends{datname!~"template.*|postgres"})
          / on() pg_settings_max_connections) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥ä½¿ç”¨ç‡è¿‡é«˜"
          description: "è¿æ¥ä½¿ç”¨ç‡: {{ $value }}%"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: PostgreSQLReplicationLag
        expr: |
          pg_replication_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
          description: "å¤åˆ¶å»¶è¿Ÿ: {{ $value }}ç§’"

      # WALç§¯å‹å‘Šè­¦
      - alert: PostgreSQLWALBacklog
        expr: |
          pg_wal_lsn_diff(pg_current_wal_lsn(), pg_replication_slots_confirmed_flush_lsn) > 1073741824
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WALç§¯å‹"
          description: "WALç§¯å‹: {{ $value }} bytes"

      # æ…¢æŸ¥è¯¢æ¯”ä¾‹å‘Šè­¦
      - alert: PostgreSQLHighSlowQueryRatio
        expr: |
          (sum(rate(pg_stat_statements_calls{mean_exec_time>1000}[5m]))
          / sum(rate(pg_stat_statements_calls[5m]))) * 100 > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢æ¯”ä¾‹è¿‡é«˜"
          description: "æ…¢æŸ¥è¯¢æ¯”ä¾‹: {{ $value }}%"

      # ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: PostgreSQLHighDiskUsage
        expr: |
          (pg_database_size_bytes / pg_database_size_limit_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "ç£ç›˜ä½¿ç”¨ç‡: {{ $value }}%"
```

### 5.2 å‘Šè­¦åˆ†çº§

**å‘Šè­¦çº§åˆ«**ï¼š

| çº§åˆ« | é˜ˆå€¼ | å“åº”æ—¶é—´ | å¤„ç†æ–¹å¼ |
|------|------|---------|---------|
| **Critical** | ä¸¥é‡é—®é¢˜ | ç«‹å³ | 24/7å¾…å‘½ |
| **Warning** | æ½œåœ¨é—®é¢˜ | 1å°æ—¶å†… | å·¥ä½œæ—¶é—´ |
| **Info** | ä¿¡æ¯æç¤º | 24å°æ—¶å†… | å®šæœŸå®¡æŸ¥ |

---

## 6. æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µ

### 6.1 Top SQLæŸ¥è¯¢

**Topæ…¢æŸ¥è¯¢**ï¼š

```sql
-- Top SQLï¼ˆéœ€å¯ç”¨pg_stat_statementsï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 200) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat_statements%'
ORDER BY total_exec_time DESC
LIMIT 20;
```

**TopæŸ¥è¯¢ï¼ˆæŒ‰è°ƒç”¨æ¬¡æ•°ï¼‰**ï¼š

```sql
-- TopæŸ¥è¯¢ï¼ˆæŒ‰è°ƒç”¨æ¬¡æ•°ï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 200) AS query_preview,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 20;
```

### 6.2 ç­‰å¾…äº‹ä»¶åˆ†å¸ƒ

**ç­‰å¾…äº‹ä»¶ç»Ÿè®¡**ï¼š

```sql
-- ç­‰å¾…äº‹ä»¶åˆ†å¸ƒï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wait_event_type,
    wait_event,
    count(*) AS count,
    round(100.0 * count(*) / (SELECT count(*) FROM pg_stat_activity), 2) AS percentage
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC
LIMIT 100;
```

**æ´»åŠ¨ä¼šè¯ç­‰å¾…**ï¼š

```sql
-- æ´»åŠ¨ä¼šè¯ç­‰å¾…ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    wait_event_type,
    wait_event,
    state,
    query_start,
    now() - query_start AS wait_duration
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
ORDER BY wait_duration DESC
LIMIT 100;
```

### 6.3 Autovacuumç§¯å‹

**Autovacuumç§¯å‹æ£€æŸ¥**ï¼š

```sql
-- Autovacuumç§¯å‹ï¼ˆç¤ºæ„ï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum,
    CASE
        WHEN last_autovacuum IS NULL THEN 'Never'
        WHEN last_autovacuum < NOW() - INTERVAL '7 days' THEN 'Stale'
        ELSE 'Recent'
    END AS vacuum_status
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 100;
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 20;
```

---

## 7. å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

### 7.1 æŒ‡æ ‡ï¼ˆMetricsï¼‰

**PrometheusæŒ‡æ ‡**ï¼š

```promql
# è¿æ¥æ•°
pg_stat_database_numbackends

# äº‹åŠ¡ç»Ÿè®¡
pg_stat_database_xact_commit
pg_stat_database_xact_rollback

# æŸ¥è¯¢ç»Ÿè®¡
pg_stat_statements_total_exec_time
pg_stat_statements_calls

# I/Oç»Ÿè®¡ï¼ˆPostgreSQL 18ï¼‰
pg_stat_io_reads
pg_stat_io_writes
```

### 7.2 æ—¥å¿—ï¼ˆLogsï¼‰

**Lokiæ—¥å¿—æŸ¥è¯¢**ï¼š

```logql
# PostgreSQLæ—¥å¿—
{job="postgresql"}

# é”™è¯¯æ—¥å¿—
{job="postgresql", level="ERROR"}

# æ…¢æŸ¥è¯¢æ—¥å¿—
{job="postgresql"} |~ "duration: [5-9][0-9]{3,}"
```

### 7.3 è¿½è¸ªï¼ˆTracesï¼‰

**OpenTelemetryè¿½è¸ª**ï¼š

```python
# Pythonåº”ç”¨è¿½è¸ª
from opentelemetry import trace
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor

tracer = trace.get_tracer(__name__)
Psycopg2Instrumentor().instrument()

with tracer.start_as_current_span("database_query"):
    cursor.execute("SELECT * FROM documents")
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ç›‘æ§æœ€ä½³å®è·µ

**æŒ‡æ ‡é€‰æ‹©**ï¼š

- âœ… æ ¸å¿ƒæŒ‡æ ‡ä¼˜å…ˆ
- âœ… ä¸šåŠ¡æŒ‡æ ‡ç»“åˆ
- âœ… é¿å…æŒ‡æ ‡çˆ†ç‚¸
- âœ… å®šæœŸå®¡æŸ¥æŒ‡æ ‡

**å‘Šè­¦è®¾ç½®**ï¼š

- âœ… åˆç†é˜ˆå€¼
- âœ… é¿å…å‘Šè­¦é£æš´
- âœ… åˆ†çº§å‘Šè­¦
- âœ… å‘Šè­¦å…³è”

### 8.2 å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ

**ä¸‰å¤§æ”¯æŸ±æ•´åˆ**ï¼š

- âœ… æŒ‡æ ‡+æ—¥å¿—å…³è”
- âœ… æ—¥å¿—+è¿½è¸ªå…³è”
- âœ… ç«¯åˆ°ç«¯è¿½è¸ª
- âœ… ç»Ÿä¸€è§†å›¾

**æ•…éšœå®šä½**ï¼š

- âœ… å¿«é€Ÿå®šä½
- âœ… æ ¹å› åˆ†æ
- âœ… é—®é¢˜è§£å†³
- âœ… ç»éªŒæ€»ç»“

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: RUNBOOK-ç›‘æ§å¯è§‚æµ‹
