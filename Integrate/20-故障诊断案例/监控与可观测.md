---

> **📋 文档来源**: `PostgreSQL\runbook\监控与可观测.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# Runbook：监控与可观测（PostgreSQL 17.x 占位）

## 目标

建立性能与健康监控基线，覆盖指标、告警与故障定位路径。

## 指标基线

- 实例：连接数、活动/等待会话、检查点、WAL 速率
- 存储/IO：`pg_stat_io`、表/索引膨胀、膨胀比
- 查询：`pg_stat_statements`、TopN 慢查询、计划变化
- 自治任务：VACUUM/ANALYZE 进度与积压

## 仪表板建议

- 概览、查询、存储、复制、备份、错误与告警六板块

## 故障定位路径（示意）

1) 负载飙升 → 活动会话/等待事件 → 顶层 SQL → 计划/锁
2) 卡顿 → `pg_locks`、`wait_event`、热点索引/表
3) 膨胀 → 重建索引/表维护窗口 → 风险评估

## 告警门限（占位）

- 连接使用率、复制延迟、WAL 积压、慢查询比例、磁盘使用率

## 标准查询片段（占位）

```sql
-- Top SQL（需启用 pg_stat_statements）
SELECT queryid, calls, total_exec_time, mean_exec_time, rows
FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20;

-- 等待事件分布
SELECT wait_event_type, wait_event, count(*)
FROM pg_stat_activity WHERE state = 'active' GROUP BY 1,2 ORDER BY 3 DESC;

-- Autovacuum backlog（示意）
SELECT relname, n_dead_tup FROM pg_stat_all_tables ORDER BY n_dead_tup DESC LIMIT 20;
```
