---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\runbook\01-æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯ï¼ˆRunbookï¼‰

## 1. ç›®æ ‡

- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä»¥æœ€å°é£é™©å®Œæˆå‚æ•°/SQL/ç»“æ„ä¼˜åŒ–ï¼Œå½¢æˆâ€œç›‘æµ‹â†’è¯Šæ–­â†’å®šä½â†’å˜æ›´â†’éªŒè¯â†’å›æ»š/å›ºåŒ–â€çš„é—­ç¯ã€‚
- å¯¹é½æ–‡æ¡£ï¼š`04-éƒ¨ç½²è¿ç»´/04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md`ã€`04.04-ç›‘æ§ä¸è¯Šæ–­.md`ã€‚

## 2. å‰ç½®æ£€æŸ¥

- ä¸šåŠ¡çª—å£ï¼šç¡®è®¤ç°åº¦èŒƒå›´ä¸ä½å³°æ—¶æ®µï¼›
- å¤‡ä»½/å›æ»šï¼šé…ç½®å¤‡ä»½ç‚¹/å¿«ç…§ï¼›å‡†å¤‡å›æ»šè„šæœ¬ï¼ˆå‚æ•°æ—§å€¼ã€DDL å›æ»šæ–¹æ¡ˆï¼‰ã€‚
- æŒ‡æ ‡é¢æ¿ï¼šP95/P99ã€TPS/QPSã€å‘½ä¸­ç‡ã€WAL é€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€é”ç­‰å¾…ã€Autovacuum æ»åã€‚

## 3. è¯Šæ–­å…¥å£

1) æ…¢æŸ¥è¯¢/ååä¸‹é™/å»¶è¿Ÿå‡é«˜å‘Šè­¦è§¦å‘ï¼›
2) æ‰§è¡Œ `sql/diagnostics.sql` ä¸­ TopN + ç­‰å¾…äº‹ä»¶ï¼›
3) å¯¹ç–‘ä¼¼è¯­å¥ `EXPLAIN (ANALYZE, BUFFERS, TIMING)`ï¼›
4) è¯„ä¼°ç­–ç•¥ï¼šç´¢å¼•/ç»Ÿè®¡/SQL/å‚æ•°/æ¶æ„ã€‚

## 4. å˜æ›´ç¥¨æ®æ¨¡æ¿

```text
å˜æ›´é¡¹ï¼š<å‚æ•°/SQL/ç´¢å¼•/ç»“æ„>
å¯¹è±¡/èŒƒå›´ï¼š<åº“/è¡¨/ç´¢å¼•/æœåŠ¡>
æ—§å€¼â†’æ–°å€¼ï¼š<ä»> â†’ <åˆ°>
é¢„æœŸå½±å“ï¼š<å»¶è¿Ÿ/åå/èµ„æº>
éªŒè¯çª—å£ï¼š<èµ·æ­¢æ—¶é—´/ç°åº¦æ¯”ä¾‹>
å›æ»šæ¡ä»¶ï¼š<P95 æ¶åŒ–>10% / é”™è¯¯ç‡å‡ / é”å†²çªå‡>
è´Ÿè´£äºº/å®¡æ‰¹ï¼š<Owner/Reviewer>
```

## 5. æ‰§è¡Œæ­¥éª¤

1) å»ºç«‹å®¡è®¡ï¼šè®°å½•å‚æ•°æ—§å€¼ï¼ˆ`SHOW`/`pg_file_settings`ï¼‰ä¸è®¡åˆ’åŸºçº¿ï¼›
2) å•å˜é‡å°æ­¥å˜æ›´ï¼›
3) è§‚å¯Ÿ 15â€“30 åˆ†é’Ÿç¨³å®šçª—å£ï¼›
4) è¾¾æ ‡åˆ™å›ºåŒ–ä¸æ–‡æ¡£åŒ–ï¼›ä¸è¾¾æ ‡åˆ™å›æ»šã€‚

## 6. å¸¸ç”¨å‚æ•°å»ºè®®ï¼ˆæ‘˜ï¼‰

- è¿æ¥ä¸å¹¶å‘ï¼š`max_connections`ã€`work_mem`ï¼›
- ç¼“å†²ï¼š`shared_buffers`ã€`effective_cache_size`ï¼›
- å¹¶è¡Œ/JITï¼š`max_parallel_workers_per_gather`ã€`jit`ï¼›
- I/Oï¼š`random_page_cost`ã€`effective_io_concurrency`ï¼›
- æ£€æŸ¥ç‚¹/WALï¼š`checkpoint_timeout`ã€`max_wal_size`ã€`checkpoint_completion_target`ã€`wal_compression`ï¼›
- ç»´æŠ¤ï¼š`autovacuum_*`ã€`maintenance_work_mem`ã€‚

## 7. éªŒè¯æ¸…å•

- æŒ‡æ ‡å¯¹æ¯”ï¼šè°ƒä¼˜å‰/å P95ã€TPS/QPSã€å‘½ä¸­ç‡ã€WALã€æ£€æŸ¥ç‚¹ï¼›
- SQL å¯¹æ¯”ï¼šTopN æ˜¯å¦ä¸‹é™ã€ä¼°ç®—åå·®æ˜¯å¦ç¼“è§£ï¼›
- èµ„æºï¼šCPU/IO/å†…å­˜æ˜¯å¦åœ¨é˜ˆå€¼å†…ï¼›
- ä¸šåŠ¡ï¼šé”™è¯¯ç‡/è¶…æ—¶æ˜¯å¦æ­£å¸¸ã€‚

## 8. å›æ»šä¸å¤ç›˜

- ç«‹å³æ¢å¤å‚æ•°æ—§å€¼/æ’¤é”€ç´¢å¼•æˆ–é‡å†™ï¼›
- é™„åŠ è¯æ®ï¼šæ—¥å¿—ã€æ…¢SQLã€EXPLAINã€é¢æ¿æˆªå›¾ï¼›
- å¤ç›˜æ¡ç›®ï¼šé—®é¢˜æ ¹å› ã€æ— æ•ˆå°è¯•ã€æœ‰æ•ˆæ‰‹æ®µã€å¯å¤ç”¨è„šæœ¬ã€‚

---

## 9. å˜æ›´é—­ç¯è¯¦ç»†å®ç°

### 9.1 ç›‘æµ‹é˜¶æ®µ

**ç›‘æµ‹å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æµ‹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'performance_monitoring') THEN
            CREATE TABLE performance_monitoring (
                id SERIAL PRIMARY KEY,
                check_time TIMESTAMPTZ DEFAULT NOW(),
                metric_name TEXT,
                metric_value NUMERIC,
                threshold_warning NUMERIC,
                threshold_critical NUMERIC,
                alert_level TEXT  -- 'INFO', 'WARNING', 'CRITICAL'
            );
            RAISE NOTICE 'è¡¨ performance_monitoring åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ performance_monitoring å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æŒ‡æ ‡ç›‘æµ‹å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION monitor_performance_metrics()
RETURNS TABLE (
    metric_name TEXT,
    current_value NUMERIC,
    threshold_warning NUMERIC,
    threshold_critical NUMERIC,
    alert_level TEXT
) AS $$
BEGIN
    BEGIN
        -- æ£€æŸ¥æ‰©å±•æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œéƒ¨åˆ†æŒ‡æ ‡æ— æ³•ç›‘æµ‹';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æ‰©å±•å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        -- P95å»¶è¿Ÿç›‘æµ‹
        RETURN QUERY
        SELECT
            'P95å»¶è¿Ÿ(ms)'::TEXT,
            (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY mean_exec_time)
             FROM pg_stat_statements)::NUMERIC,
            1000.0::NUMERIC,  -- è­¦å‘Šé˜ˆå€¼
            2000.0::NUMERIC,  -- ä¸¥é‡é˜ˆå€¼
            CASE
                WHEN (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY mean_exec_time)
                      FROM pg_stat_statements) > 2000 THEN 'CRITICAL'
                WHEN (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY mean_exec_time)
                      FROM pg_stat_statements) > 1000 THEN 'WARNING'
                ELSE 'INFO'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'P95å»¶è¿Ÿç›‘æµ‹å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        -- TPSç›‘æµ‹
        RETURN QUERY
        SELECT
            'TPS'::TEXT,
            (SELECT SUM(calls) / NULLIF(EXTRACT(EPOCH FROM (NOW() - stats_reset)), 0)
             FROM pg_stat_database WHERE datname = current_database())::NUMERIC,
            1000.0::NUMERIC,  -- è­¦å‘Šé˜ˆå€¼
            500.0::NUMERIC,   -- ä¸¥é‡é˜ˆå€¼
            CASE
                WHEN (SELECT SUM(calls) / NULLIF(EXTRACT(EPOCH FROM (NOW() - stats_reset)), 0)
                      FROM pg_stat_database WHERE datname = current_database()) < 500 THEN 'CRITICAL'
                WHEN (SELECT SUM(calls) / NULLIF(EXTRACT(EPOCH FROM (NOW() - stats_reset)), 0)
                      FROM pg_stat_database WHERE datname = current_database()) < 1000 THEN 'WARNING'
                ELSE 'INFO'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'TPSç›‘æµ‹å¤±è´¥: %', SQLERRM;
    END;

    RETURN;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'monitor_performance_metrics') THEN
            RAISE WARNING 'å‡½æ•° monitor_performance_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç›‘æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ€§èƒ½ç›‘æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM monitor_performance_metrics();
```

### 9.2 è¯Šæ–­é˜¶æ®µ

**è¯Šæ–­å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ…¢æŸ¥è¯¢è¯Šæ–­ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION diagnose_slow_queries(
    p_limit INT DEFAULT 10
)
RETURNS TABLE (
    query_id BIGINT,
    query_text TEXT,
    calls BIGINT,
    mean_exec_time NUMERIC,
    max_exec_time NUMERIC,
    total_exec_time NUMERIC,
    diagnosis TEXT
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        -- æ£€æŸ¥æ‰©å±•æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE EXCEPTION 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œæ…¢æŸ¥è¯¢è¯Šæ–­';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯Šæ–­å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        SELECT
            s.queryid,
            LEFT(s.query, 200) AS query_text,
            s.calls,
            s.mean_exec_time,
            s.max_exec_time,
            s.total_exec_time,
            CASE
                WHEN s.mean_exec_time > 1000 THEN 'éœ€è¦ä¼˜åŒ–'
                WHEN s.mean_exec_time > 500 THEN 'å»ºè®®ä¼˜åŒ–'
                ELSE 'æ­£å¸¸'
            END AS diagnosis
        FROM pg_stat_statements s
        WHERE s.mean_exec_time > 100
        ORDER BY s.mean_exec_time DESC
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ…¢æŸ¥è¯¢è¯Šæ–­å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ…¢æŸ¥è¯¢è¯Šæ–­ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œæ…¢æŸ¥è¯¢è¯Šæ–­';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'diagnose_slow_queries') THEN
            RAISE WARNING 'å‡½æ•° diagnose_slow_queries ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¯Šæ–­';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ…¢æŸ¥è¯¢è¯Šæ–­';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯Šæ–­å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM diagnose_slow_queries(10);

-- ç­‰å¾…äº‹ä»¶è¯Šæ–­ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION diagnose_wait_events()
RETURNS TABLE (
    wait_event_type TEXT,
    wait_event TEXT,
    count BIGINT,
    diagnosis TEXT
) AS $$
BEGIN
    BEGIN
        RETURN QUERY
        SELECT
            wait_event_type,
            wait_event,
            COUNT(*)::BIGINT,
            CASE
                WHEN wait_event_type = 'Lock' THEN 'é”ç­‰å¾…ï¼Œéœ€è¦æ£€æŸ¥äº‹åŠ¡å’Œé”å†²çª'
                WHEN wait_event_type = 'IO' THEN 'I/Oç­‰å¾…ï¼Œéœ€è¦ä¼˜åŒ–I/Oæ€§èƒ½'
                WHEN wait_event_type = 'CPU' THEN 'CPUç­‰å¾…ï¼Œéœ€è¦ä¼˜åŒ–æŸ¥è¯¢'
                ELSE 'å…¶ä»–ç­‰å¾…äº‹ä»¶'
            END AS diagnosis
        FROM pg_stat_activity
        WHERE wait_event_type IS NOT NULL
        GROUP BY wait_event_type, wait_event
        ORDER BY COUNT(*) DESC;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç­‰å¾…äº‹ä»¶è¯Šæ–­å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç­‰å¾…äº‹ä»¶è¯Šæ–­ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'diagnose_wait_events') THEN
            RAISE WARNING 'å‡½æ•° diagnose_wait_events ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¯Šæ–­';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç­‰å¾…äº‹ä»¶è¯Šæ–­';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯Šæ–­å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM diagnose_wait_events();
```

### 9.3 å˜æ›´æ‰§è¡Œ

**å˜æ›´æ‰§è¡Œå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºå˜æ›´è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'change_executions') THEN
            CREATE TABLE change_executions (
                id SERIAL PRIMARY KEY,
                change_type TEXT,  -- 'parameter', 'index', 'ddl', 'sql'
                change_description TEXT,
                old_value TEXT,
                new_value TEXT,
                execution_time TIMESTAMPTZ DEFAULT NOW(),
                rollback_script TEXT,
                status TEXT DEFAULT 'pending'  -- 'pending', 'executing', 'completed', 'rolled_back'
            );
            RAISE NOTICE 'è¡¨ change_executions åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ change_executions å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰§è¡Œå‚æ•°å˜æ›´ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION execute_parameter_change(
    p_parameter_name TEXT,
    p_new_value TEXT,
    p_change_description TEXT DEFAULT NULL
)
RETURNS TABLE (
    change_id INT,
    execution_status TEXT,
    rollback_value TEXT
) AS $$
DECLARE
    new_change_id INT;
    old_value TEXT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_parameter_name IS NULL OR p_parameter_name = '' THEN
            RAISE EXCEPTION 'å‚æ•°åä¸èƒ½ä¸ºç©º';
        END IF;

        IF p_new_value IS NULL OR p_new_value = '' THEN
            RAISE EXCEPTION 'æ–°å€¼ä¸èƒ½ä¸ºç©º';
        END IF;

        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'change_executions') THEN
            RAISE EXCEPTION 'è¡¨ change_executions ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
        END IF;

        -- è·å–æ—§å€¼
        SELECT setting INTO old_value
        FROM pg_settings
        WHERE name = p_parameter_name;

        IF old_value IS NULL THEN
            RAISE EXCEPTION 'å‚æ•° % ä¸å­˜åœ¨', p_parameter_name;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- è®°å½•å˜æ›´
        INSERT INTO change_executions (
            change_type,
            change_description,
            old_value,
            new_value,
            rollback_script,
            status
        )
        VALUES (
            'parameter',
            COALESCE(p_change_description, format('å˜æ›´å‚æ•°: %s', p_parameter_name)),
            old_value,
            p_new_value,
            format('ALTER SYSTEM SET %s = %L', p_parameter_name, old_value),
            'executing'
        )
        RETURNING id INTO new_change_id;

        IF new_change_id IS NULL THEN
            RAISE EXCEPTION 'æ— æ³•åˆ›å»ºå˜æ›´è®°å½•';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•å˜æ›´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- æ£€æŸ¥æƒé™
        IF NOT current_setting('is_superuser')::boolean THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿå‚æ•°';
        END IF;

        -- æ‰§è¡Œå˜æ›´
        EXECUTE format('ALTER SYSTEM SET %s = %L', p_parameter_name, p_new_value);
        PERFORM pg_reload_conf();

        -- æ›´æ–°çŠ¶æ€
        UPDATE change_executions
        SET status = 'completed'
        WHERE id = new_change_id;

        IF NOT FOUND THEN
            RAISE WARNING 'æ›´æ–°å˜æ›´è®°å½•çŠ¶æ€å¤±è´¥';
        END IF;

        RETURN QUERY SELECT new_change_id, 'completed'::TEXT, old_value;
    EXCEPTION
        WHEN insufficient_privilege THEN
            UPDATE change_executions SET status = 'failed' WHERE id = new_change_id;
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            UPDATE change_executions SET status = 'failed' WHERE id = new_change_id;
            RAISE WARNING 'æ‰§è¡Œå˜æ›´å¤±è´¥: %', SQLERRM;
            RETURN QUERY SELECT new_change_id, format('failed: %', SQLERRM)::TEXT, old_value;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 9.4 éªŒè¯é˜¶æ®µ

**éªŒè¯å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å˜æ›´æ•ˆæœéªŒè¯ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION verify_change_effect(
    p_change_id INT,
    p_observation_window_minutes INT DEFAULT 30
)
RETURNS TABLE (
    metric_name TEXT,
    before_value NUMERIC,
    after_value NUMERIC,
    improvement_percent NUMERIC,
    verification_status TEXT
) AS $$
DECLARE
    change_rec RECORD;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_change_id IS NULL OR p_change_id <= 0 THEN
            RAISE EXCEPTION 'å˜æ›´IDæ— æ•ˆ: %', p_change_id;
        END IF;

        IF p_observation_window_minutes IS NULL OR p_observation_window_minutes <= 0 THEN
            RAISE EXCEPTION 'è§‚å¯Ÿçª—å£å¿…é¡»å¤§äº0';
        END IF;

        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'change_executions') THEN
            RAISE EXCEPTION 'è¡¨ change_executions ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'performance_monitoring') THEN
            RAISE EXCEPTION 'è¡¨ performance_monitoring ä¸å­˜åœ¨';
        END IF;

        -- è·å–å˜æ›´è®°å½•
        SELECT * INTO change_rec
        FROM change_executions
        WHERE id = p_change_id;

        IF change_rec IS NULL THEN
            RAISE EXCEPTION 'å˜æ›´è®°å½•ä¸å­˜åœ¨: %', p_change_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- å¯¹æ¯”å˜æ›´å‰åçš„æ€§èƒ½æŒ‡æ ‡
        RETURN QUERY
        SELECT
            'P95å»¶è¿Ÿ(ms)'::TEXT,
            (SELECT AVG(metric_value) FROM performance_monitoring
             WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
               AND check_time < change_rec.execution_time
               AND check_time > change_rec.execution_time - INTERVAL '1 hour')::NUMERIC AS before_value,
            (SELECT AVG(metric_value) FROM performance_monitoring
             WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
               AND check_time > change_rec.execution_time
               AND check_time < change_rec.execution_time + (p_observation_window_minutes || ' minutes')::INTERVAL)::NUMERIC AS after_value,
            CASE
                WHEN (SELECT AVG(metric_value) FROM performance_monitoring
                      WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                        AND check_time < change_rec.execution_time
                        AND check_time > change_rec.execution_time - INTERVAL '1 hour') > 0
                THEN ROUND(
                    ((SELECT AVG(metric_value) FROM performance_monitoring
                      WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                        AND check_time < change_rec.execution_time
                        AND check_time > change_rec.execution_time - INTERVAL '1 hour') -
                     (SELECT AVG(metric_value) FROM performance_monitoring
                      WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                        AND check_time > change_rec.execution_time
                        AND check_time < change_rec.execution_time + (p_observation_window_minutes || ' minutes')::INTERVAL)) /
                    (SELECT AVG(metric_value) FROM performance_monitoring
                     WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                       AND check_time < change_rec.execution_time
                       AND check_time > change_rec.execution_time - INTERVAL '1 hour') * 100,
                    2
                )
                ELSE NULL
            END AS improvement_percent,
            CASE
                WHEN (SELECT AVG(metric_value) FROM performance_monitoring
                      WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                        AND check_time > change_rec.execution_time
                        AND check_time < change_rec.execution_time + (p_observation_window_minutes || ' minutes')::INTERVAL) <
                     (SELECT AVG(metric_value) FROM performance_monitoring
                      WHERE metric_name = 'P95å»¶è¿Ÿ(ms)'
                        AND check_time < change_rec.execution_time
                        AND check_time > change_rec.execution_time - INTERVAL '1 hour') * 0.9
                THEN 'é€šè¿‡'
                ELSE 'æœªé€šè¿‡'
            END AS verification_status;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å˜æ›´æ•ˆæœå¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    RETURN;
END;
$$ LANGUAGE plpgsql;
```

### 9.5 å›æ»šæœºåˆ¶

**å›æ»šå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å›æ»šå˜æ›´ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION rollback_change(
    p_change_id INT
)
RETURNS TABLE (
    change_id INT,
    rollback_status TEXT,
    rollback_time TIMESTAMPTZ
) AS $$
DECLARE
    change_rec RECORD;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_change_id IS NULL OR p_change_id <= 0 THEN
            RAISE EXCEPTION 'å˜æ›´IDæ— æ•ˆ: %', p_change_id;
        END IF;

        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'change_executions') THEN
            RAISE EXCEPTION 'è¡¨ change_executions ä¸å­˜åœ¨';
        END IF;

        -- è·å–å˜æ›´è®°å½•
        SELECT * INTO change_rec
        FROM change_executions
        WHERE id = p_change_id;

        IF change_rec IS NULL THEN
            RAISE EXCEPTION 'å˜æ›´è®°å½•ä¸å­˜åœ¨: %', p_change_id;
        END IF;

        IF change_rec.rollback_script IS NULL OR change_rec.rollback_script = '' THEN
            RAISE EXCEPTION 'å›æ»šè„šæœ¬ä¸å­˜åœ¨æˆ–ä¸ºç©º';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å›æ»šå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- æ£€æŸ¥æƒé™
        IF NOT current_setting('is_superuser')::boolean THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½æ‰§è¡Œå›æ»š';
        END IF;

        -- æ‰§è¡Œå›æ»šè„šæœ¬
        EXECUTE change_rec.rollback_script;
        PERFORM pg_reload_conf();

        -- æ›´æ–°çŠ¶æ€
        UPDATE change_executions
        SET status = 'rolled_back'
        WHERE id = p_change_id;

        IF NOT FOUND THEN
            RAISE WARNING 'æ›´æ–°å˜æ›´è®°å½•çŠ¶æ€å¤±è´¥';
        END IF;

        RETURN QUERY SELECT p_change_id, 'å›æ»šæˆåŠŸ'::TEXT, NOW();
    EXCEPTION
        WHEN insufficient_privilege THEN
            UPDATE change_executions SET status = 'rollback_failed' WHERE id = p_change_id;
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œå›æ»š';
        WHEN OTHERS THEN
            UPDATE change_executions SET status = 'rollback_failed' WHERE id = p_change_id;
            RAISE WARNING 'å›æ»šå¤±è´¥: %', SQLERRM;
            RETURN QUERY SELECT p_change_id, format('å›æ»šå¤±è´¥: %', SQLERRM)::TEXT, NOW();
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [30-æ€§èƒ½è°ƒä¼˜/](../30-æ€§èƒ½è°ƒä¼˜/README.md) - æ€§èƒ½è°ƒä¼˜ä¸»é¢˜
- [12-ç›‘æ§ä¸è¯Šæ–­/](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç›‘æ§ä¸è¯Šæ–­ä¸»é¢˜
- [20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹/README.md](./README.md) - æ•…éšœè¯Šæ–­æ¡ˆä¾‹ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
