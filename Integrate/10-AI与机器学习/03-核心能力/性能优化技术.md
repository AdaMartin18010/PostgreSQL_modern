---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\01-æ ¸å¿ƒåŸºç¡€\æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

> **æ–‡æ¡£ç¼–å·**: AI-03-05
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 01-æ ¸å¿ƒåŸºç¡€
> **å­ä¸»é¢˜**: 05-æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

## ğŸ“‘ ç›®å½•

- [æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](#æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
    - [1.1 æ€§èƒ½ä¼˜åŒ–æ€ç»´å¯¼å›¾](#11-æ€§èƒ½ä¼˜åŒ–æ€ç»´å¯¼å›¾)
    - [1.2 æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘](#12-æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘)
  - [2. ç´¢å¼•ä¼˜åŒ–](#2-ç´¢å¼•ä¼˜åŒ–)
    - [2.1 å‘é‡ç´¢å¼•ä¼˜åŒ–](#21-å‘é‡ç´¢å¼•ä¼˜åŒ–)
    - [2.2 å¤åˆç´¢å¼•ä¼˜åŒ–](#22-å¤åˆç´¢å¼•ä¼˜åŒ–)
    - [2.3 éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–](#23-éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–)
  - [3. æŸ¥è¯¢ä¼˜åŒ–](#3-æŸ¥è¯¢ä¼˜åŒ–)
    - [3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#31-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
    - [3.2 æŸ¥è¯¢é‡å†™](#32-æŸ¥è¯¢é‡å†™)
    - [3.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°](#33-ç»Ÿè®¡ä¿¡æ¯æ›´æ–°)
  - [4. è¿æ¥æ± ä¼˜åŒ–](#4-è¿æ¥æ± ä¼˜åŒ–)
    - [4.1 PgBounceré…ç½®](#41-pgbounceré…ç½®)
    - [4.2 è¿æ¥æ± æ¨¡å¼](#42-è¿æ¥æ± æ¨¡å¼)
    - [4.3 è¿æ¥æ± è°ƒä¼˜](#43-è¿æ¥æ± è°ƒä¼˜)
  - [5. ç¡¬ä»¶é…ç½®ä¼˜åŒ–](#5-ç¡¬ä»¶é…ç½®ä¼˜åŒ–)
    - [5.1 CPUé€‰å‹](#51-cpué€‰å‹)
    - [5.2 å†…å­˜é…ç½®](#52-å†…å­˜é…ç½®)
    - [5.3 å­˜å‚¨é…ç½®](#53-å­˜å‚¨é…ç½®)
    - [5.4 ç½‘ç»œé…ç½®](#54-ç½‘ç»œé…ç½®)
  - [6. PostgreSQLå‚æ•°è°ƒä¼˜](#6-postgresqlå‚æ•°è°ƒä¼˜)
    - [6.1 å†…å­˜å‚æ•°](#61-å†…å­˜å‚æ•°)
    - [6.2 å¹¶å‘å‚æ•°](#62-å¹¶å‘å‚æ•°)
    - [6.3 å‘é‡æŸ¥è¯¢å‚æ•°](#63-å‘é‡æŸ¥è¯¢å‚æ•°)
  - [7. æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­](#7-æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­)
    - [7.1 æ€§èƒ½ç›‘æ§](#71-æ€§èƒ½ç›‘æ§)
    - [7.2 æ…¢æŸ¥è¯¢åˆ†æ](#72-æ…¢æŸ¥è¯¢åˆ†æ)
    - [7.3 ç“¶é¢ˆè¯Šæ–­](#73-ç“¶é¢ˆè¯Šæ–­)
  - [2. ç´¢å¼•ä¼˜åŒ–](#2-ç´¢å¼•ä¼˜åŒ–-1)
    - [2.1 å‘é‡ç´¢å¼•ä¼˜åŒ–](#21-å‘é‡ç´¢å¼•ä¼˜åŒ–-1)
    - [2.2 å¤åˆç´¢å¼•ä¼˜åŒ–](#22-å¤åˆç´¢å¼•ä¼˜åŒ–-1)
    - [2.3 éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–](#23-éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–-1)
  - [3. æŸ¥è¯¢ä¼˜åŒ–](#3-æŸ¥è¯¢ä¼˜åŒ–-1)
    - [3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#31-æŸ¥è¯¢è®¡åˆ’åˆ†æ-1)
    - [3.2 æŸ¥è¯¢é‡å†™](#32-æŸ¥è¯¢é‡å†™-1)
    - [3.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°](#33-ç»Ÿè®¡ä¿¡æ¯æ›´æ–°-1)
  - [4. è¿æ¥æ± ä¼˜åŒ–](#4-è¿æ¥æ± ä¼˜åŒ–-1)
    - [4.1 PgBounceré…ç½®](#41-pgbounceré…ç½®-1)
    - [4.2 è¿æ¥æ± æ¨¡å¼](#42-è¿æ¥æ± æ¨¡å¼-1)
    - [4.3 è¿æ¥æ± è°ƒä¼˜](#43-è¿æ¥æ± è°ƒä¼˜-1)
  - [5. ç¡¬ä»¶é…ç½®ä¼˜åŒ–](#5-ç¡¬ä»¶é…ç½®ä¼˜åŒ–-1)
    - [5.1 CPUé€‰å‹](#51-cpué€‰å‹-1)
    - [5.2 å†…å­˜é…ç½®](#52-å†…å­˜é…ç½®-1)
    - [5.3 å­˜å‚¨é…ç½®](#53-å­˜å‚¨é…ç½®-1)
    - [5.4 ç½‘ç»œé…ç½®](#54-ç½‘ç»œé…ç½®-1)
  - [6. PostgreSQLå‚æ•°è°ƒä¼˜](#6-postgresqlå‚æ•°è°ƒä¼˜-1)
    - [6.1 å†…å­˜å‚æ•°](#61-å†…å­˜å‚æ•°-1)
    - [6.2 å¹¶å‘å‚æ•°](#62-å¹¶å‘å‚æ•°-1)
    - [6.3 å‘é‡æŸ¥è¯¢å‚æ•°](#63-å‘é‡æŸ¥è¯¢å‚æ•°-1)
  - [7. æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­](#7-æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­-1)
    - [7.1 æ€§èƒ½ç›‘æ§](#71-æ€§èƒ½ç›‘æ§-1)
    - [7.2 æ…¢æŸ¥è¯¢åˆ†æ](#72-æ…¢æŸ¥è¯¢åˆ†æ-1)
    - [7.3 ç“¶é¢ˆè¯Šæ–­](#73-ç“¶é¢ˆè¯Šæ–­-1)

---

## 1. æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°

### 1.1 æ€§èƒ½ä¼˜åŒ–æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯))
    ç´¢å¼•ä¼˜åŒ–
      å‘é‡ç´¢å¼•
        HNSWå‚æ•°è°ƒä¼˜
        IVFFlatå‚æ•°è°ƒä¼˜
      å¤åˆç´¢å¼•
        å‘é‡+ç»“æ„åŒ–
        å‘é‡+å…¨æ–‡
      éƒ¨åˆ†ç´¢å¼•
        æ¡ä»¶ç´¢å¼•
        è¡¨è¾¾å¼ç´¢å¼•
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢è®¡åˆ’
        EXPLAINåˆ†æ
        è®¡åˆ’ç¼“å­˜
      æŸ¥è¯¢é‡å†™
        SQLä¼˜åŒ–
        å­æŸ¥è¯¢ä¼˜åŒ–
      ç»Ÿè®¡ä¿¡æ¯
        è‡ªåŠ¨æ›´æ–°
        æ‰‹åŠ¨æ›´æ–°
    ç³»ç»Ÿä¼˜åŒ–
      è¿æ¥æ± 
        PgBouncer
        è¿æ¥å¤ç”¨
      ç¡¬ä»¶é…ç½®
        CPUé€‰å‹
        å†…å­˜é…ç½®
        å­˜å‚¨ä¼˜åŒ–
    å‚æ•°è°ƒä¼˜
      å†…å­˜å‚æ•°
        shared_buffers
        work_mem
      å¹¶å‘å‚æ•°
        max_connections
        max_worker_processes
      å‘é‡å‚æ•°
        hnsw.ef_search
        ivfflat.probes
```

### 1.2 æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜?] --> B{é—®é¢˜ç±»å‹?}
    B -->|æŸ¥è¯¢æ…¢| C{æŸ¥è¯¢ç±»å‹?}
    B -->|å†™å…¥æ…¢| D[ç´¢å¼•ä¼˜åŒ–]
    B -->|è¿æ¥é—®é¢˜| E[è¿æ¥æ± ä¼˜åŒ–]

    C -->|å‘é‡æŸ¥è¯¢| F{æ•°æ®è§„æ¨¡?}
    C -->|æ··åˆæŸ¥è¯¢| G[å¤åˆç´¢å¼•]
    C -->|å…¨æ–‡æœç´¢| H[å…¨æ–‡ç´¢å¼•ä¼˜åŒ–]

    F -->|å°è§„æ¨¡<100ä¸‡| I[HNSWç´¢å¼•<br/>m=16, ef=64]
    F -->|å¤§è§„æ¨¡>1000ä¸‡| J[IVFFlatç´¢å¼•<br/>lists=100]

    I --> K{å¬å›ç‡è¦æ±‚?}
    K -->|é«˜>0.95| L[å¢åŠ ef_search=100]
    K -->|ä¸­0.85-0.95| M[é»˜è®¤ef_search=40]
```

---

## 2. ç´¢å¼•ä¼˜åŒ–

### 2.1 å‘é‡ç´¢å¼•ä¼˜åŒ–

**HNSWç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- 1. é«˜å¬å›ç‡åœºæ™¯ï¼ˆæ¨èç³»ç»Ÿã€RAGï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (
    m = 32,              -- å¢åŠ è¿æ¥æ•°ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
    ef_construction = 128  -- å¢åŠ æ„å»ºèŒƒå›´ï¼Œæå‡ç´¢å¼•è´¨é‡
);

-- æŸ¥è¯¢æ—¶æå‡å¬å›ç‡
SET hnsw.ef_search = 100;  -- é»˜è®¤40ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- 2. å¹³è¡¡æ€§èƒ½åœºæ™¯ï¼ˆé€šç”¨ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (
    m = 16,              -- é»˜è®¤å€¼ï¼Œå¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨
    ef_construction = 64  -- é»˜è®¤å€¼ï¼Œå¹³è¡¡è´¨é‡å’Œæ„å»ºæ—¶é—´
);
```

**IVFFlatç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- å¤§è§„æ¨¡æ•°æ®ï¼ˆ>1000ä¸‡å‘é‡ï¼‰
CREATE INDEX ON documents
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 100);  -- lists = rows / 1000 åˆ° rows / 10000

-- æŸ¥è¯¢æ—¶æå‡å¬å›ç‡
SET ivfflat.probes = 10;  -- é»˜è®¤1ï¼Œå¢åŠ å¯æå‡å¬å›ç‡ä½†é™ä½æ€§èƒ½
```

### 2.2 å¤åˆç´¢å¼•ä¼˜åŒ–

**å‘é‡+ç»“æ„åŒ–å¤åˆç´¢å¼•**ï¼š

```sql
-- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼ˆç‰¹å®šç±»åˆ«ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE category_id = 1;  -- åªä¸ºç‰¹å®šç±»åˆ«åˆ›å»ºç´¢å¼•

-- è¡¨è¾¾å¼ç´¢å¼•ï¼ˆå‘é‡+è®¡ç®—å­—æ®µï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE created_at > NOW() - INTERVAL '1 year';  -- åªç´¢å¼•æœ€è¿‘ä¸€å¹´çš„æ•°æ®
```

### 2.3 éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–

**æ¡ä»¶ç´¢å¼•**ï¼š

```sql
-- åªä¸ºæ´»è·ƒæ•°æ®åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE created_at > NOW() - INTERVAL '1 year';

-- åªä¸ºç‰¹å®šç±»åˆ«åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE category_id IN (1, 2, 3);
```

---

## 3. æŸ¥è¯¢ä¼˜åŒ–

### 3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

**EXPLAINåˆ†æ**ï¼š

```sql
-- è¯¦ç»†EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;
```

### 3.2 æŸ¥è¯¢é‡å†™

**SQLä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨LIMITæå‰ç»ˆæ­¢
SELECT * FROM documents
ORDER BY embedding <=> query_vec
LIMIT 10;  -- æå‰ç»ˆæ­¢ï¼Œåªè¿”å›Top 10

-- 2. è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼æå‰è¿‡æ»¤
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3  -- æå‰è¿‡æ»¤
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 3. é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
-- ä¼˜åŒ–å‰ï¼šå‡½æ•°è®¡ç®—
SELECT * FROM documents
WHERE 1 - (embedding <=> query_vec) > 0.7;

-- ä¼˜åŒ–åï¼šç›´æ¥ä½¿ç”¨è·ç¦»
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3;  -- ç­‰ä»·ä½†æ›´å¿«
```

### 3.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°

**ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–**ï¼š

```sql
-- æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents(embedding, category_id);

-- å¢åŠ ç»Ÿè®¡ä¿¡æ¯é‡‡æ ·
ALTER TABLE documents
ALTER COLUMN embedding SET STATISTICS 1000;
```

---

## 4. è¿æ¥æ± ä¼˜åŒ–

### 4.1 PgBounceré…ç½®

**PgBounceré…ç½®ç¤ºä¾‹**ï¼š

```ini
[pgbouncer]
pool_mode = transaction  # äº‹åŠ¡çº§è¿æ¥æ± ï¼ˆæ¨èï¼‰
max_client_conn = 1000    # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥
default_pool_size = 25   # é»˜è®¤è¿æ¥æ± å¤§å°
min_pool_size = 5        # æœ€å°è¿æ¥æ± å¤§å°
max_db_connections = 100 # æ¯ä¸ªæ•°æ®åº“æœ€å¤§è¿æ¥
```

### 4.2 è¿æ¥æ± æ¨¡å¼

**è¿æ¥æ± æ¨¡å¼å¯¹æ¯”**ï¼š

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | é™åˆ¶ |
|------|------|---------|------|
| **session** | ä¼šè¯çº§è¿æ¥æ±  | éœ€è¦ä¼šè¯çŠ¶æ€ | è¿æ¥æ•°=å®¢æˆ·ç«¯æ•° |
| **transaction** | äº‹åŠ¡çº§è¿æ¥æ± ï¼ˆæ¨èï¼‰ | å¤§å¤šæ•°åœºæ™¯ | è¿æ¥æ•°<å®¢æˆ·ç«¯æ•° |
| **statement** | è¯­å¥çº§è¿æ¥æ±  | ç®€å•æŸ¥è¯¢ | ä¸æ”¯æŒäº‹åŠ¡ |

### 4.3 è¿æ¥æ± è°ƒä¼˜

**è¿æ¥æ± å¤§å°è®¡ç®—**ï¼š

```text
è¿æ¥æ± å¤§å° = (max_connections - superuser_reserved_connections) /
            (å¹³å‡å¹¶å‘äº‹åŠ¡æ•° * 1.2)

ç¤ºä¾‹ï¼š
- max_connections = 100
- å¹³å‡å¹¶å‘äº‹åŠ¡æ•° = 20
- è¿æ¥æ± å¤§å° = (100 - 3) / (20 * 1.2) â‰ˆ 4
- æ¨èå€¼ï¼š25ï¼ˆè€ƒè™‘å³°å€¼ï¼‰
```

---

## 5. ç¡¬ä»¶é…ç½®ä¼˜åŒ–

### 5.1 CPUé€‰å‹

**CPUé€‰å‹æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èCPU | è¯´æ˜ |
|------|---------|------|
| **å‘é‡æŸ¥è¯¢å¯†é›†** | é«˜ä¸»é¢‘CPUï¼ˆ>3.5GHzï¼‰ | å•çº¿ç¨‹æ€§èƒ½é‡è¦ |
| **å¹¶å‘æŸ¥è¯¢å¤š** | å¤šæ ¸CPUï¼ˆ>16æ ¸ï¼‰ | å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ› |
| **æ··åˆè´Ÿè½½** | å¹³è¡¡å‹CPU | å…¼é¡¾å•æ ¸å’Œå¤šæ ¸ |

### 5.2 å†…å­˜é…ç½®

**å†…å­˜é…ç½®åŸåˆ™**ï¼ˆ32GB RAMç¤ºä¾‹ï¼‰ï¼š

```sql
ALTER SYSTEM SET shared_buffers = '8GB';  -- RAMçš„25%
ALTER SYSTEM SET effective_cache_size = '24GB';  -- RAMçš„75%
ALTER SYSTEM SET work_mem = '64MB';  -- å‡è®¾max_connections=100
ALTER SYSTEM SET maintenance_work_mem = '2GB';
```

### 5.3 å­˜å‚¨é…ç½®

**å­˜å‚¨é€‰å‹**ï¼š

| å­˜å‚¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | IOPS | å»¶è¿Ÿ |
|---------|---------|------|------|
| **NVMe SSD** | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | 100K+ | <1ms |
| **SATA SSD** | å¼€å‘æµ‹è¯• | 10K+ | <5ms |
| **HDD** | å½’æ¡£æ•°æ® | 100+ | 10ms+ |

**å­˜å‚¨ä¼˜åŒ–**ï¼š

```sql
-- è°ƒæ•´éšæœºIOæˆæœ¬ï¼ˆSSDç¯å¢ƒï¼‰
ALTER SYSTEM SET random_page_cost = 1.1;  -- é»˜è®¤4.0
ALTER SYSTEM SET effective_io_concurrency = 200;  -- SSDç¯å¢ƒ
```

### 5.4 ç½‘ç»œé…ç½®

**ç½‘ç»œä¼˜åŒ–**ï¼š

```sql
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET listen_addresses = '*';
```

---

## 6. PostgreSQLå‚æ•°è°ƒä¼˜

### 6.1 å†…å­˜å‚æ•°

**æ ¸å¿ƒå†…å­˜å‚æ•°**ï¼š

```sql
-- 1. å…±äº«å†…å­˜ï¼ˆæœ€é‡è¦ï¼‰
ALTER SYSTEM SET shared_buffers = '8GB';  -- RAMçš„25%

-- 2. å·¥ä½œå†…å­˜
ALTER SYSTEM SET work_mem = '64MB';  -- æ¯ä¸ªæ“ä½œçš„å†…å­˜

-- 3. æœ‰æ•ˆç¼“å­˜å¤§å°
ALTER SYSTEM SET effective_cache_size = '24GB';  -- RAMçš„75%
```

### 6.2 å¹¶å‘å‚æ•°

**å¹¶å‘é…ç½®**ï¼š

```sql
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET max_worker_processes = 8;  -- CPUæ ¸å¿ƒæ•°
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;
```

### 6.3 å‘é‡æŸ¥è¯¢å‚æ•°

**pgvectorå‚æ•°è°ƒä¼˜**ï¼š

```sql
-- HNSWæŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- é»˜è®¤40ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- IVFFlatæŸ¥è¯¢å‚æ•°
SET ivfflat.probes = 10;  -- é»˜è®¤1ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- å‘é‡æ“ä½œç¬¦æˆæœ¬
SET cpu_operator_cost = 0.0025;  -- é™ä½å‘é‡æ“ä½œæˆæœ¬
```

---

## 7. æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­

### 7.1 æ€§èƒ½ç›‘æ§

**pg_stat_statementsç›‘æ§**ï¼š

```sql
-- å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´>100ms
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æŸ¥çœ‹å‘é‡æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%'
ORDER BY mean_exec_time DESC;
```

### 7.2 æ…¢æŸ¥è¯¢åˆ†æ

**æ…¢æŸ¥è¯¢è¯†åˆ«**ï¼š

```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- è®°å½•>1sçš„æŸ¥è¯¢
SELECT pg_reload_conf();

-- åˆ†ææ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    (mean_exec_time * calls) AS total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_time DESC
LIMIT 20;
```

### 7.3 ç“¶é¢ˆè¯Šæ–­

**ç³»ç»Ÿèµ„æºç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;

-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active,
    count(*) FILTER (WHERE state = 'idle') AS idle
FROM pg_stat_activity;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-03-05

    ç´¢å¼•ä¼˜åŒ–
      å‘é‡ç´¢å¼•
        HNSWå‚æ•°è°ƒä¼˜
        IVFFlatå‚æ•°è°ƒä¼˜
      å¤åˆç´¢å¼•
        å‘é‡+ç»“æ„åŒ–
        å‘é‡+å…¨æ–‡
      éƒ¨åˆ†ç´¢å¼•
        æ¡ä»¶ç´¢å¼•
        è¡¨è¾¾å¼ç´¢å¼•
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢è®¡åˆ’
        EXPLAINåˆ†æ
        è®¡åˆ’ç¼“å­˜
      æŸ¥è¯¢é‡å†™
        SQLä¼˜åŒ–
        å­æŸ¥è¯¢ä¼˜åŒ–
      ç»Ÿè®¡ä¿¡æ¯
        è‡ªåŠ¨æ›´æ–°
        æ‰‹åŠ¨æ›´æ–°
    ç³»ç»Ÿä¼˜åŒ–
      è¿æ¥æ± 
        PgBouncer
        è¿æ¥å¤ç”¨
      ç¡¬ä»¶é…ç½®
        CPUé€‰å‹
        å†…å­˜é…ç½®
        å­˜å‚¨ä¼˜åŒ–
    å‚æ•°è°ƒä¼˜
      å†…å­˜å‚æ•°
        shared_buffers
        work_mem
      å¹¶å‘å‚æ•°
        max_connections
        max_worker_processes
      å‘é‡å‚æ•°
        hnsw.ef_search
        ivfflat.probes

```

### 1.2 æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜?] --> B{é—®é¢˜ç±»å‹?}
    B -->|æŸ¥è¯¢æ…¢| C{æŸ¥è¯¢ç±»å‹?}
    B -->|å†™å…¥æ…¢| D[ç´¢å¼•ä¼˜åŒ–]
    B -->|è¿æ¥é—®é¢˜| E[è¿æ¥æ± ä¼˜åŒ–]

    C -->|å‘é‡æŸ¥è¯¢| F{æ•°æ®è§„æ¨¡?}
    C -->|æ··åˆæŸ¥è¯¢| G[å¤åˆç´¢å¼•]
    C -->|å…¨æ–‡æœç´¢| H[å…¨æ–‡ç´¢å¼•ä¼˜åŒ–]

    F -->|å°è§„æ¨¡<100ä¸‡| I[HNSWç´¢å¼•<br/>m=16, ef=64]
    F -->|å¤§è§„æ¨¡>1000ä¸‡| J[IVFFlatç´¢å¼•<br/>lists=100]

    I --> K{å¬å›ç‡è¦æ±‚?}
    K -->|é«˜>0.95| L[å¢åŠ ef_search=100]
    K -->|ä¸­0.85-0.95| M[é»˜è®¤ef_search=40]

    style I fill:#50c878,color:#fff
    style J fill:#50c878,color:#fff
```

---

## 2. ç´¢å¼•ä¼˜åŒ–

### 2.1 å‘é‡ç´¢å¼•ä¼˜åŒ–

**HNSWç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- 1. é«˜å¬å›ç‡åœºæ™¯ï¼ˆæ¨èç³»ç»Ÿã€RAGï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (
    m = 32,              -- å¢åŠ è¿æ¥æ•°ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
    ef_construction = 128  -- å¢åŠ æ„å»ºèŒƒå›´ï¼Œæå‡ç´¢å¼•è´¨é‡
);

-- æŸ¥è¯¢æ—¶æå‡å¬å›ç‡
SET hnsw.ef_search = 100;  -- é»˜è®¤40ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- 2. å¹³è¡¡æ€§èƒ½åœºæ™¯ï¼ˆé€šç”¨ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (
    m = 16,              -- é»˜è®¤å€¼ï¼Œå¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨
    ef_construction = 64  -- é»˜è®¤å€¼ï¼Œå¹³è¡¡è´¨é‡å’Œæ„å»ºæ—¶é—´
);

-- 3. å†™å…¥é¢‘ç¹åœºæ™¯
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (
    m = 8,               -- å‡å°‘è¿æ¥æ•°ï¼Œæå‡å†™å…¥æ€§èƒ½
    ef_construction = 32  -- å‡å°‘æ„å»ºèŒƒå›´ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
);
```

**IVFFlatç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- 1. å¤§è§„æ¨¡æ•°æ®ï¼ˆ>1000ä¸‡å‘é‡ï¼‰
CREATE INDEX ON documents
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 100);  -- lists = rows / 1000 åˆ° rows / 10000

-- æŸ¥è¯¢æ—¶æå‡å¬å›ç‡
SET ivfflat.probes = 10;  -- é»˜è®¤1ï¼Œå¢åŠ å¯æå‡å¬å›ç‡ä½†é™ä½æ€§èƒ½

-- 2. è¶…å¤§è§„æ¨¡æ•°æ®ï¼ˆ>1äº¿å‘é‡ï¼‰
CREATE INDEX ON documents
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 1000);  -- å¢åŠ listsæ•°é‡

SET ivfflat.probes = 20;  -- å¢åŠ probesæ•°é‡
```

**ç´¢å¼•é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èç´¢å¼• | å‚æ•°é…ç½® | æ€§èƒ½æŒ‡æ ‡ |
|------|---------|---------|----------|
| **å°è§„æ¨¡ï¼ˆ<100ä¸‡ï¼‰** | HNSW | m=16, ef_construction=64 | QPS>10K, P95<5ms |
| **ä¸­ç­‰è§„æ¨¡ï¼ˆ100ä¸‡-1000ä¸‡ï¼‰** | HNSW | m=16, ef_construction=64 | QPS>5K, P95<10ms |
| **å¤§è§„æ¨¡ï¼ˆ>1000ä¸‡ï¼‰** | IVFFlat | lists=100 | QPS>2K, P95<20ms |
| **é«˜å¬å›ç‡ï¼ˆ>0.98ï¼‰** | HNSW | m=32, ef_search=100 | å¬å›ç‡>0.98 |
| **å†™å…¥é¢‘ç¹** | IVFFlat | lists=50 | å†™å…¥æ€§èƒ½æ›´å¥½ |

### 2.2 å¤åˆç´¢å¼•ä¼˜åŒ–

**å‘é‡+ç»“æ„åŒ–å¤åˆç´¢å¼•**ï¼š

```sql
-- 1. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå‘é‡+ç±»åˆ«ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
INCLUDE (category_id, created_at);

-- 2. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼ˆç‰¹å®šç±»åˆ«ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE category_id = 1;  -- åªä¸ºç‰¹å®šç±»åˆ«åˆ›å»ºç´¢å¼•

-- 3. è¡¨è¾¾å¼ç´¢å¼•ï¼ˆå‘é‡+è®¡ç®—å­—æ®µï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE created_at > NOW() - INTERVAL '1 year';  -- åªç´¢å¼•æœ€è¿‘ä¸€å¹´çš„æ•°æ®
```

**å‘é‡+å…¨æ–‡æœç´¢å¤åˆç´¢å¼•**ï¼š

```sql
-- 1. å‘é‡ç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops);

-- 2. å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX ON documents
USING GIN(to_tsvector('english', content));

-- 3. ç»„åˆä½¿ç”¨
SELECT
    id,
    content,
    1 - (embedding <=> query_vec) AS vector_score,
    ts_rank(to_tsvector('english', content), query_ts) AS text_score
FROM documents,
     plainto_tsquery('english', 'keywords') AS query_ts
WHERE
    to_tsvector('english', content) @@ query_ts  -- å…¨æ–‡ç´¢å¼•
    AND embedding <=> query_vec < 0.3  -- å‘é‡ç´¢å¼•
ORDER BY (vector_score * 0.7 + text_score * 0.3) DESC;
```

### 2.3 éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–

**æ¡ä»¶ç´¢å¼•**ï¼š

```sql
-- 1. åªä¸ºæ´»è·ƒæ•°æ®åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE created_at > NOW() - INTERVAL '1 year';

-- 2. åªä¸ºç‰¹å®šç±»åˆ«åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE category_id IN (1, 2, 3);

-- 3. åªä¸ºé«˜è´¨é‡æ•°æ®åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE quality_score > 0.8;
```

**è¡¨è¾¾å¼ç´¢å¼•**ï¼š

```sql
-- 1. åŸºäºè¡¨è¾¾å¼çš„å‘é‡ç´¢å¼•
CREATE INDEX ON documents
USING hnsw((embedding::float[]::vector) vector_cosine_ops);

-- 2. åŸºäºå‡½æ•°çš„ç´¢å¼•
CREATE INDEX ON documents
USING hnsw(normalize(embedding) vector_cosine_ops);
```

---

## 3. æŸ¥è¯¢ä¼˜åŒ–

### 3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

**EXPLAINåˆ†æ**ï¼š

```sql
-- 1. åŸºç¡€EXPLAIN
EXPLAIN SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 2. è¯¦ç»†EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 3. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE
    category_id = 1
    AND embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;
```

**æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–**ï¼š

```sql
-- 1. å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•
SET enable_seqscan = off;  -- ç¦ç”¨é¡ºåºæ‰«æ
SET enable_indexscan = on;  -- å¯ç”¨ç´¢å¼•æ‰«æ

-- 2. è°ƒæ•´æˆæœ¬å‚æ•°
SET random_page_cost = 1.1;  -- SSDç¯å¢ƒé™ä½éšæœºIOæˆæœ¬
SET cpu_index_tuple_cost = 0.005;  -- é™ä½ç´¢å¼•æ‰«ææˆæœ¬

-- 3. æŸ¥çœ‹è®¡åˆ’ç¼“å­˜
SELECT * FROM pg_prepared_statements;
```

### 3.2 æŸ¥è¯¢é‡å†™

**SQLä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨LIMITæå‰ç»ˆæ­¢
-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æåæ’åº
SELECT * FROM documents
ORDER BY embedding <=> query_vec;

-- ä¼˜åŒ–åï¼šä½¿ç”¨ç´¢å¼•+LIMIT
SELECT * FROM documents
ORDER BY embedding <=> query_vec
LIMIT 10;  -- æå‰ç»ˆæ­¢ï¼Œåªè¿”å›Top 10

-- 2. è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼æå‰è¿‡æ»¤
-- ä¼˜åŒ–å‰ï¼šè®¡ç®—æ‰€æœ‰ç›¸ä¼¼åº¦
SELECT * FROM documents
ORDER BY embedding <=> query_vec;

-- ä¼˜åŒ–åï¼šæå‰è¿‡æ»¤
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3  -- æå‰è¿‡æ»¤
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 3. é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
-- ä¼˜åŒ–å‰ï¼šå‡½æ•°è®¡ç®—
SELECT * FROM documents
WHERE 1 - (embedding <=> query_vec) > 0.7;

-- ä¼˜åŒ–åï¼šç›´æ¥ä½¿ç”¨è·ç¦»
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3;  -- ç­‰ä»·ä½†æ›´å¿«
```

**å­æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- 1. ä½¿ç”¨CTEä¼˜åŒ–å¤æ‚æŸ¥è¯¢
WITH query_vec AS (
    SELECT ai.embedding_openai('text-embedding-3-small', 'query') AS vec
),
filtered_docs AS (
    SELECT id, content, embedding
    FROM documents
    WHERE category_id = 1
)
SELECT
    fd.id,
    fd.content,
    1 - (fd.embedding <=> qv.vec) AS similarity
FROM filtered_docs fd, query_vec qv
ORDER BY fd.embedding <=> qv.vec
LIMIT 10;

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW popular_documents AS
SELECT id, content, embedding
FROM documents
WHERE view_count > 1000;

CREATE INDEX ON popular_documents
USING hnsw(embedding vector_cosine_ops);

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY popular_documents;
```

### 3.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°

**è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯**ï¼š

```sql
-- 1. é…ç½®è‡ªåŠ¨æ›´æ–°
ALTER TABLE documents
SET (autovacuum_analyze_scale_factor = 0.05);  -- 5%å˜åŒ–æ—¶æ›´æ–°

-- 2. æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- 3. æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents(embedding, category_id);
```

**ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–**ï¼š

```sql
-- 1. å¢åŠ ç»Ÿè®¡ä¿¡æ¯é‡‡æ ·
ALTER TABLE documents
SET (n_distinct = 1000000);  -- æŒ‡å®šå”¯ä¸€å€¼æ•°é‡

-- 2. è®¾ç½®ç»Ÿè®¡ç›®æ ‡
ALTER TABLE documents
ALTER COLUMN embedding SET STATISTICS 1000;  -- å¢åŠ ç»Ÿè®¡ä¿¡æ¯é‡‡æ ·

-- 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE tablename = 'documents';
```

---

## 4. è¿æ¥æ± ä¼˜åŒ–

### 4.1 PgBounceré…ç½®

**PgBouncerå®‰è£…é…ç½®**ï¼š

```bash
# Ubuntu/Debian
sudo apt install pgbouncer

# é…ç½®æ–‡ä»¶ï¼š/etc/pgbouncer/pgbouncer.ini
```

**PgBounceré…ç½®ç¤ºä¾‹**ï¼š

```ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction  # äº‹åŠ¡çº§è¿æ¥æ± 
max_client_conn = 1000    # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥
default_pool_size = 25   # é»˜è®¤è¿æ¥æ± å¤§å°
min_pool_size = 5        # æœ€å°è¿æ¥æ± å¤§å°
reserve_pool_size = 5    # ä¿ç•™è¿æ¥æ± 
reserve_pool_timeout = 3 # ä¿ç•™è¿æ¥è¶…æ—¶
max_db_connections = 100 # æ¯ä¸ªæ•°æ®åº“æœ€å¤§è¿æ¥
max_user_connections = 100 # æ¯ä¸ªç”¨æˆ·æœ€å¤§è¿æ¥
```

### 4.2 è¿æ¥æ± æ¨¡å¼

**è¿æ¥æ± æ¨¡å¼å¯¹æ¯”**ï¼š

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | é™åˆ¶ |
|------|------|---------|------|
| **session** | ä¼šè¯çº§è¿æ¥æ±  | éœ€è¦ä¼šè¯çŠ¶æ€ | è¿æ¥æ•°=å®¢æˆ·ç«¯æ•° |
| **transaction** | äº‹åŠ¡çº§è¿æ¥æ± ï¼ˆæ¨èï¼‰ | å¤§å¤šæ•°åœºæ™¯ | è¿æ¥æ•°<å®¢æˆ·ç«¯æ•° |
| **statement** | è¯­å¥çº§è¿æ¥æ±  | ç®€å•æŸ¥è¯¢ | ä¸æ”¯æŒäº‹åŠ¡ |

**æ¨èé…ç½®**ï¼š

```ini
# äº‹åŠ¡çº§è¿æ¥æ± ï¼ˆæ¨èï¼‰
pool_mode = transaction
default_pool_size = 25
max_client_conn = 1000
```

### 4.3 è¿æ¥æ± è°ƒä¼˜

**è¿æ¥æ± å¤§å°è®¡ç®—**ï¼š

```text
è¿æ¥æ± å¤§å° = (max_connections - superuser_reserved_connections) /
            (å¹³å‡å¹¶å‘äº‹åŠ¡æ•° * 1.2)

ç¤ºä¾‹ï¼š
- max_connections = 100
- superuser_reserved_connections = 3
- å¹³å‡å¹¶å‘äº‹åŠ¡æ•° = 20

è¿æ¥æ± å¤§å° = (100 - 3) / (20 * 1.2) â‰ˆ 4
æ¨èå€¼ï¼š25ï¼ˆè€ƒè™‘å³°å€¼ï¼‰
```

**è¿æ¥æ± ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
SELECT * FROM pgbouncer.pools;
SELECT * FROM pgbouncer.stats;
SELECT * FROM pgbouncer.clients;
```

---

## 5. ç¡¬ä»¶é…ç½®ä¼˜åŒ–

### 5.1 CPUé€‰å‹

**CPUé€‰å‹æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èCPU | è¯´æ˜ |
|------|---------|------|
| **å‘é‡æŸ¥è¯¢å¯†é›†** | é«˜ä¸»é¢‘CPUï¼ˆ>3.5GHzï¼‰ | å•çº¿ç¨‹æ€§èƒ½é‡è¦ |
| **å¹¶å‘æŸ¥è¯¢å¤š** | å¤šæ ¸CPUï¼ˆ>16æ ¸ï¼‰ | å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ› |
| **æ··åˆè´Ÿè½½** | å¹³è¡¡å‹CPU | å…¼é¡¾å•æ ¸å’Œå¤šæ ¸ |

**CPUé…ç½®å»ºè®®**ï¼š

- âœ… **ä¸»é¢‘ä¼˜å…ˆ**ï¼šå‘é‡è®¡ç®—ä¾èµ–CPUä¸»é¢‘
- âœ… **ç¼“å­˜é‡è¦**ï¼šå¤§L3ç¼“å­˜æå‡æ€§èƒ½
- âœ… **AVXæ”¯æŒ**ï¼šå‘é‡æŒ‡ä»¤åŠ é€Ÿè®¡ç®—

### 5.2 å†…å­˜é…ç½®

**å†…å­˜é…ç½®åŸåˆ™**ï¼š

```text
shared_buffers = RAM * 25%  # PostgreSQLå…±äº«å†…å­˜
effective_cache_size = RAM * 75%  # æŸ¥è¯¢è§„åˆ’å™¨å‡è®¾çš„ç¼“å­˜
work_mem = (RAM - shared_buffers) / (max_connections * 2)  # å·¥ä½œå†…å­˜
```

**å†…å­˜é…ç½®ç¤ºä¾‹**ï¼ˆ32GB RAMï¼‰ï¼š

```sql
-- 32GB RAMæœåŠ¡å™¨é…ç½®
ALTER SYSTEM SET shared_buffers = '8GB';
ALTER SYSTEM SET effective_cache_size = '24GB';
ALTER SYSTEM SET work_mem = '64MB';  -- å‡è®¾max_connections=100
ALTER SYSTEM SET maintenance_work_mem = '2GB';
ALTER SYSTEM SET max_wal_size = '4GB';
```

### 5.3 å­˜å‚¨é…ç½®

**å­˜å‚¨é€‰å‹**ï¼š

| å­˜å‚¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | IOPS | å»¶è¿Ÿ |
|---------|---------|------|------|
| **NVMe SSD** | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | 100K+ | <1ms |
| **SATA SSD** | å¼€å‘æµ‹è¯• | 10K+ | <5ms |
| **HDD** | å½’æ¡£æ•°æ® | 100+ | 10ms+ |

**å­˜å‚¨ä¼˜åŒ–**ï¼š

```sql
-- 1. è°ƒæ•´éšæœºIOæˆæœ¬ï¼ˆSSDç¯å¢ƒï¼‰
ALTER SYSTEM SET random_page_cost = 1.1;  -- é»˜è®¤4.0

-- 2. è°ƒæ•´é¡ºåºIOæˆæœ¬
ALTER SYSTEM SET seq_page_cost = 1.0;  -- é»˜è®¤1.0

-- 3. è°ƒæ•´IOå¹¶å‘
ALTER SYSTEM SET effective_io_concurrency = 200;  -- SSDç¯å¢ƒ
```

### 5.4 ç½‘ç»œé…ç½®

**ç½‘ç»œä¼˜åŒ–**ï¼š

```sql
-- 1. è°ƒæ•´TCPå‚æ•°ï¼ˆæ“ä½œç³»ç»Ÿçº§åˆ«ï¼‰
# /etc/sysctl.conf
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096

-- 2. PostgreSQLç½‘ç»œé…ç½®
ALTER SYSTEM SET listen_addresses = '*';
ALTER SYSTEM SET max_connections = 200;
```

---

## 6. PostgreSQLå‚æ•°è°ƒä¼˜

### 6.1 å†…å­˜å‚æ•°

**æ ¸å¿ƒå†…å­˜å‚æ•°**ï¼š

```sql
-- 1. å…±äº«å†…å­˜ï¼ˆæœ€é‡è¦ï¼‰
ALTER SYSTEM SET shared_buffers = '8GB';  -- RAMçš„25%

-- 2. å·¥ä½œå†…å­˜
ALTER SYSTEM SET work_mem = '64MB';  -- æ¯ä¸ªæ“ä½œçš„å†…å­˜

-- 3. ç»´æŠ¤å·¥ä½œå†…å­˜
ALTER SYSTEM SET maintenance_work_mem = '2GB';  -- VACUUMç­‰æ“ä½œ

-- 4. æœ‰æ•ˆç¼“å­˜å¤§å°
ALTER SYSTEM SET effective_cache_size = '24GB';  -- RAMçš„75%

-- 5. WALç¼“å†²åŒº
ALTER SYSTEM SET wal_buffers = '16MB';
```

**å†…å­˜å‚æ•°è°ƒä¼˜æŒ‡å—**ï¼š

| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| **shared_buffers** | RAM * 25% | æ•°æ®åº“ç¼“å­˜ |
| **effective_cache_size** | RAM * 75% | æŸ¥è¯¢è§„åˆ’å™¨å‡è®¾ |
| **work_mem** | (RAM - shared_buffers) / (max_connections * 2) | æ¯ä¸ªæ“ä½œå†…å­˜ |
| **maintenance_work_mem** | RAM * 10% | ç»´æŠ¤æ“ä½œå†…å­˜ |

### 6.2 å¹¶å‘å‚æ•°

**å¹¶å‘é…ç½®**ï¼š

```sql
-- 1. æœ€å¤§è¿æ¥æ•°
ALTER SYSTEM SET max_connections = 200;

-- 2. å·¥ä½œè¿›ç¨‹æ•°
ALTER SYSTEM SET max_worker_processes = 8;  -- CPUæ ¸å¿ƒæ•°

-- 3. å¹¶è¡Œå·¥ä½œè¿›ç¨‹
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;

-- 4. å¹¶è¡ŒæŸ¥è¯¢é˜ˆå€¼
ALTER SYSTEM SET parallel_setup_cost = 1000;
ALTER SYSTEM SET parallel_tuple_cost = 0.01;
ALTER SYSTEM SET min_parallel_table_scan_size = '8MB';
ALTER SYSTEM SET min_parallel_index_scan_size = '512KB';
```

### 6.3 å‘é‡æŸ¥è¯¢å‚æ•°

**pgvectorå‚æ•°è°ƒä¼˜**ï¼š

```sql
-- 1. HNSWæŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- é»˜è®¤40ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- 2. IVFFlatæŸ¥è¯¢å‚æ•°
SET ivfflat.probes = 10;  -- é»˜è®¤1ï¼Œå¢åŠ å¯æå‡å¬å›ç‡

-- 3. å‘é‡æ“ä½œç¬¦æˆæœ¬
SET cpu_operator_cost = 0.0025;  -- é™ä½å‘é‡æ“ä½œæˆæœ¬
```

**æŸ¥è¯¢å‚æ•°ä¼˜åŒ–**ï¼š

```sql
-- 1. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 1000;

-- 2. è°ƒæ•´æˆæœ¬å‚æ•°
SET random_page_cost = 1.1;  -- SSDç¯å¢ƒ
SET cpu_index_tuple_cost = 0.005;

-- 3. å‘é‡æŸ¥è¯¢ä¼˜åŒ–
SET enable_seqscan = off;  -- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•
SET enable_indexscan = on;
```

---

## 7. æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­

### 7.1 æ€§èƒ½ç›‘æ§

**pg_stat_statementsç›‘æ§**ï¼š

```sql
-- 1. å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´>100ms
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. æŸ¥çœ‹å‘é‡æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    mean_exec_time,
    (shared_blks_hit + shared_blks_read) AS total_blocks
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%'
ORDER BY mean_exec_time DESC;
```

**ç´¢å¼•ä½¿ç”¨ç›‘æ§**ï¼š

```sql
-- 1. æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE indexname LIKE '%hnsw%' OR indexname LIKE '%ivfflat%'
ORDER BY idx_scan DESC;

-- 2. æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND indexname LIKE '%vector%';
```

### 7.2 æ…¢æŸ¥è¯¢åˆ†æ

**æ…¢æŸ¥è¯¢è¯†åˆ«**ï¼š

```sql
-- 1. å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- è®°å½•>1sçš„æŸ¥è¯¢
ALTER SYSTEM SET log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';
SELECT pg_reload_conf();

-- 2. åˆ†ææ…¢æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    (mean_exec_time * calls) AS total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_time DESC
LIMIT 20;
```

**æŸ¥è¯¢è®¡åˆ’åˆ†æ**ï¼š

```sql
-- 1. åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 2. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE category_id = 1
  AND embedding <=> query_vec < 0.3
ORDER BY embedding <=> query_vec
LIMIT 10;
```

### 7.3 ç“¶é¢ˆè¯Šæ–­

**æ€§èƒ½ç“¶é¢ˆè¯Šæ–­æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B{æ£€æŸ¥CPU?}
    B -->|CPUé«˜| C[æŸ¥è¯¢ä¼˜åŒ–<br/>ç´¢å¼•ä¼˜åŒ–]
    B -->|CPUä½| D{æ£€æŸ¥IO?}
    D -->|IOé«˜| E[å­˜å‚¨ä¼˜åŒ–<br/>ç¼“å­˜ä¼˜åŒ–]
    D -->|IOä½| F{æ£€æŸ¥å†…å­˜?}
    F -->|å†…å­˜ä¸è¶³| G[å¢åŠ å†…å­˜<br/>è°ƒæ•´å‚æ•°]
    F -->|å†…å­˜å……è¶³| H[è¿æ¥æ± ä¼˜åŒ–<br/>å¹¶å‘ä¼˜åŒ–]
```

**ç³»ç»Ÿèµ„æºç›‘æ§**ï¼š

```sql
-- 1. æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;

-- 2. æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 3. æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

**è¿æ¥ç›‘æ§**ï¼š

```sql
-- 1. æŸ¥çœ‹å½“å‰è¿æ¥
SELECT
    count(*) AS total_connections,
    count(*) FILTER (WHERE state = 'active') AS active,
    count(*) FILTER (WHERE state = 'idle') AS idle
FROM pg_stat_activity;

-- 2. æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT
    pid,
    now() - pg_stat_activity.query_start AS duration,
    query,
    state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes';
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-03-05
