---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\03-æ ¸å¿ƒèƒ½åŠ›\æ··åˆæŸ¥è¯¢èƒ½åŠ›.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ··åˆæŸ¥è¯¢èƒ½åŠ›

> **æ–‡æ¡£ç¼–å·**: AI-03-03
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 03-æ ¸å¿ƒèƒ½åŠ›
> **å­ä¸»é¢˜**: 03-æ··åˆæŸ¥è¯¢èƒ½åŠ›

## ğŸ“‘ ç›®å½•

- [æ··åˆæŸ¥è¯¢èƒ½åŠ›](#æ··åˆæŸ¥è¯¢èƒ½åŠ›)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ··åˆæŸ¥è¯¢æ¦‚è¿°](#1-æ··åˆæŸ¥è¯¢æ¦‚è¿°)
    - [1.1 æ··åˆæŸ¥è¯¢èƒ½åŠ›æ€ç»´å¯¼å›¾](#11-æ··åˆæŸ¥è¯¢èƒ½åŠ›æ€ç»´å¯¼å›¾)
    - [1.2 æ··åˆæŸ¥è¯¢æ¶æ„å›¾](#12-æ··åˆæŸ¥è¯¢æ¶æ„å›¾)
  - [2. æ··åˆæŸ¥è¯¢å®ç°](#2-æ··åˆæŸ¥è¯¢å®ç°)
    - [2.1 å‘é‡+SQLè”åˆæŸ¥è¯¢](#21-å‘é‡sqlè”åˆæŸ¥è¯¢)
    - [2.2 å‘é‡+å…¨æ–‡æœç´¢](#22-å‘é‡å…¨æ–‡æœç´¢)
    - [2.3 å‘é‡+åœ°ç†ç©ºé—´æŸ¥è¯¢](#23-å‘é‡åœ°ç†ç©ºé—´æŸ¥è¯¢)
    - [2.4 å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢](#24-å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢)
  - [3. ä¼˜åŒ–ç­–ç•¥](#3-ä¼˜åŒ–ç­–ç•¥)
    - [3.1 ç´¢å¼•ç»„åˆç­–ç•¥](#31-ç´¢å¼•ç»„åˆç­–ç•¥)
    - [3.2 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–](#32-æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–)
    - [3.3 ç»“æœèåˆç®—æ³•](#33-ç»“æœèåˆç®—æ³•)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#41-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
    - [4.2 ç´¢å¼•ä¼˜åŒ–](#42-ç´¢å¼•ä¼˜åŒ–)
    - [4.3 ç¼“å­˜ç­–ç•¥](#43-ç¼“å­˜ç­–ç•¥)

---

## 1. æ··åˆæŸ¥è¯¢æ¦‚è¿°

### 1.1 æ··åˆæŸ¥è¯¢èƒ½åŠ›æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ··åˆæŸ¥è¯¢èƒ½åŠ›))
    æŸ¥è¯¢ç±»å‹
      å‘é‡+SQL
        ç»“æ„åŒ–è¿‡æ»¤
        æ—¶é—´èŒƒå›´
        æ•°å€¼èŒƒå›´
      å‘é‡+å…¨æ–‡
        å…³é”®è¯åŒ¹é…
        è¯­ä¹‰æœç´¢
        ç›¸å…³æ€§æ’åº
      å‘é‡+ç©ºé—´
        åœ°ç†ä½ç½®
        ç©ºé—´èŒƒå›´
        è·ç¦»è®¡ç®—
      å¤šæ¨¡æ€
        æ–‡æœ¬+å›¾åƒ
        æ–‡æœ¬+éŸ³é¢‘
        è·¨æ¨¡æ€æ£€ç´¢
    ä¼˜åŒ–ç­–ç•¥
      ç´¢å¼•ç»„åˆ
        å‘é‡ç´¢å¼•
        å…¨æ–‡ç´¢å¼•
        ç©ºé—´ç´¢å¼•
      æŸ¥è¯¢è®¡åˆ’
        ç´¢å¼•é€‰æ‹©
        æ‰§è¡Œé¡ºåº
        å¹¶è¡ŒæŸ¥è¯¢
      ç»“æœèåˆ
        åŠ æƒèåˆ
        RRFç®—æ³•
        é‡æ’åº
```

### 1.2 æ··åˆæŸ¥è¯¢æ¶æ„å›¾

**æ··åˆæŸ¥è¯¢æ¶æ„**ï¼š

```mermaid
graph TB
    subgraph "æŸ¥è¯¢å±‚"
        Query[ç”¨æˆ·æŸ¥è¯¢]
        Query --> Vec[å‘é‡æŸ¥è¯¢]
        Query --> SQL[SQLè¿‡æ»¤]
        Query --> FullText[å…¨æ–‡æœç´¢]
        Query --> Spatial[ç©ºé—´æŸ¥è¯¢]
    end

    subgraph "ç´¢å¼•å±‚"
        Vec --> VecIdx[HNSW/IVFFlatç´¢å¼•]
        SQL --> BTree[BTreeç´¢å¼•]
        FullText --> GIN[GINå…¨æ–‡ç´¢å¼•]
        Spatial --> GIST[GISTç©ºé—´ç´¢å¼•]
    end

    subgraph "èåˆå±‚"
        VecIdx --> Fusion[ç»“æœèåˆ]
        BTree --> Fusion
        GIN --> Fusion
        GIST --> Fusion
    end

    Fusion --> Result[æœ€ç»ˆç»“æœ]

    style Fusion fill:#4a90e2,color:#fff
    style Result fill:#50c878,color:#fff
```

**æ ¸å¿ƒä»·å€¼**ï¼š

- âœ… **ç»Ÿä¸€æŸ¥è¯¢**ï¼šå•æ¡SQLå®Œæˆå¤šç§æŸ¥è¯¢
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ©ç”¨å¤šç§ç´¢å¼•åŠ é€Ÿ
- âœ… **ç»“æœå‡†ç¡®**ï¼šç»“åˆå¤šç§ä¿¡å·æå‡ç›¸å…³æ€§
- âœ… **å¼€å‘ç®€åŒ–**ï¼šæ— éœ€å¤šç³»ç»Ÿé›†æˆ

---

## 2. æ··åˆæŸ¥è¯¢å®ç°

### 2.1 å‘é‡+SQLè”åˆæŸ¥è¯¢

**åŸºç¡€æ··åˆæŸ¥è¯¢**ï¼š

```sql
-- å‘é‡æœç´¢ + ç»“æ„åŒ–è¿‡æ»¤
SELECT
    id,
    content,
    category_id,
    rating,
    1 - (embedding <=> query_vec) AS similarity
FROM documents
WHERE
    -- å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤
    1 - (embedding <=> query_vec) > 0.7
    -- ç»“æ„åŒ–è¿‡æ»¤
    AND category_id = 1
    AND rating > 4.0
    AND created_at > NOW() - INTERVAL '30 days'
ORDER BY embedding <=> query_vec
LIMIT 10;
```

**å¤æ‚æ··åˆæŸ¥è¯¢**ï¼š

```sql
-- å¤šæ¡ä»¶æ··åˆæŸ¥è¯¢
WITH query_vec AS (
    SELECT ai.embedding_openai('text-embedding-3-small', 'user query') AS vec
)
SELECT
    d.id,
    d.title,
    d.content,
    d.category_id,
    d.rating,
    d.price,
    -- å‘é‡ç›¸ä¼¼åº¦
    1 - (d.embedding <=> qv.vec) AS vector_score,
    -- ç»¼åˆå¾—åˆ†
    (1 - (d.embedding <=> qv.vec)) * 0.6 +  -- å‘é‡æƒé‡60%
    (d.rating / 5.0) * 0.3 +                  -- è¯„åˆ†æƒé‡30%
    CASE WHEN d.price BETWEEN 100 AND 500 THEN 0.1 ELSE 0 END  -- ä»·æ ¼æƒé‡10%
    AS final_score
FROM documents d, query_vec qv
WHERE
    -- å‘é‡è¿‡æ»¤
    1 - (d.embedding <=> qv.vec) > 0.7
    -- ç»“æ„åŒ–è¿‡æ»¤
    AND d.category_id IN (1, 2, 3)
    AND d.rating > 4.0
    AND d.price BETWEEN 100 AND 500
    AND d.status = 'active'
ORDER BY final_score DESC
LIMIT 20;
```

### 2.2 å‘é‡+å…¨æ–‡æœç´¢

**æ··åˆæ£€ç´¢å®ç°**ï¼š

```sql
-- 1. å‘é‡æ£€ç´¢ç»“æœ
WITH vector_results AS (
    SELECT
        id,
        content,
        1 - (embedding <=> query_vec) AS vector_score
    FROM documents
    WHERE 1 - (embedding <=> query_vec) > 0.7
    ORDER BY embedding <=> query_vec
    LIMIT 50
),
-- 2. å…¨æ–‡æ£€ç´¢ç»“æœ
text_results AS (
    SELECT
        id,
        content,
        ts_rank(
            to_tsvector('english', content),
            plainto_tsquery('english', 'search keywords')
        ) AS text_score
    FROM documents
    WHERE to_tsvector('english', content)
          @@ plainto_tsquery('english', 'search keywords')
    ORDER BY text_score DESC
    LIMIT 50
)
-- 3. ç»“æœèåˆï¼ˆRRFç®—æ³•ï¼‰
SELECT
    COALESCE(vr.id, tr.id) AS id,
    COALESCE(vr.content, tr.content) AS content,
    COALESCE(vr.vector_score, 0) AS vector_score,
    COALESCE(tr.text_score, 0) AS text_score,
    -- RRFèåˆå¾—åˆ†
    1.0 / (60 + COALESCE(vr.vector_rank, 100)) +
    1.0 / (60 + COALESCE(tr.text_rank, 100)) AS rrf_score
FROM vector_results vr
FULL OUTER JOIN text_results tr ON vr.id = tr.id
ORDER BY rrf_score DESC
LIMIT 10;
```

**ç®€åŒ–ç‰ˆæ··åˆæ£€ç´¢**ï¼š

```sql
-- ä½¿ç”¨åŠ æƒèåˆ
SELECT
    id,
    content,
    -- å‘é‡ç›¸ä¼¼åº¦
    1 - (embedding <=> query_vec) AS vector_score,
    -- å…¨æ–‡æœç´¢ç›¸å…³æ€§
    ts_rank(
        to_tsvector('english', content),
        plainto_tsquery('english', 'keywords')
    ) AS text_score,
    -- åŠ æƒèåˆ
    (1 - (embedding <=> query_vec)) * 0.7 +
    ts_rank(
        to_tsvector('english', content),
        plainto_tsquery('english', 'keywords')
    ) * 0.3 AS final_score
FROM documents
WHERE
    to_tsvector('english', content) @@ plainto_tsquery('english', 'keywords')
    AND 1 - (embedding <=> query_vec) > 0.7
ORDER BY final_score DESC
LIMIT 10;
```

### 2.3 å‘é‡+åœ°ç†ç©ºé—´æŸ¥è¯¢

**ç©ºé—´+å‘é‡æ··åˆæŸ¥è¯¢**ï¼š

```sql
-- å‘é‡æœç´¢ + åœ°ç†ä½ç½®è¿‡æ»¤
WITH query_vec AS (
    SELECT ai.embedding_openai('text-embedding-3-small', 'restaurant') AS vec
),
user_location AS (
    SELECT ST_Point(-122.4194, 37.7749)::geography AS loc
)
SELECT
    l.id,
    l.name,
    l.description,
    -- å‘é‡ç›¸ä¼¼åº¦
    1 - (l.description_vec <=> qv.vec) AS semantic_score,
    -- åœ°ç†è·ç¦»ï¼ˆç±³ï¼‰
    ST_Distance(l.location, ul.loc) AS distance_meters,
    -- ç»¼åˆå¾—åˆ†
    (1 - (l.description_vec <=> qv.vec)) * 0.6 +  -- è¯­ä¹‰æƒé‡60%
    CASE
        WHEN ST_Distance(l.location, ul.loc) < 1000 THEN 0.4  -- 1å…¬é‡Œå†…
        WHEN ST_Distance(l.location, ul.loc) < 5000 THEN 0.2  -- 5å…¬é‡Œå†…
        ELSE 0
    END AS final_score
FROM listings l,
     query_vec qv,
     user_location ul
WHERE
    -- å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤
    1 - (l.description_vec <=> qv.vec) > 0.7
    -- åœ°ç†ä½ç½®è¿‡æ»¤ï¼ˆ5å…¬é‡Œå†…ï¼‰
    AND ST_DWithin(l.location, ul.loc, 5000)
ORDER BY final_score DESC
LIMIT 20;
```

### 2.4 å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢

**æ–‡æœ¬+å›¾åƒæ··åˆæ£€ç´¢**ï¼š

```sql
-- æ–‡æœ¬å‘é‡ + å›¾åƒå‘é‡æ··åˆæŸ¥è¯¢
WITH text_query AS (
    SELECT ai.embedding_openai('text-embedding-3-small', 'sunset beach') AS vec
),
image_query AS (
    SELECT ai.embedding_image('clip-vit-base-patch32', image_data) AS vec
)
SELECT
    m.id,
    m.text_content,
    m.image_url,
    -- æ–‡æœ¬ç›¸ä¼¼åº¦
    1 - (m.text_vec <=> tq.vec) AS text_score,
    -- å›¾åƒç›¸ä¼¼åº¦
    1 - (m.image_vec <=> iq.vec) AS image_score,
    -- å¤šæ¨¡æ€èåˆå¾—åˆ†
    (1 - (m.text_vec <=> tq.vec)) * 0.5 +
    (1 - (m.image_vec <=> iq.vec)) * 0.5 AS multimodal_score
FROM multimodal_content m,
     text_query tq,
     image_query iq
WHERE
    (1 - (m.text_vec <=> tq.vec) > 0.7 OR
     1 - (m.image_vec <=> iq.vec) > 0.7)
ORDER BY multimodal_score DESC
LIMIT 10;
```

---

## 3. ä¼˜åŒ–ç­–ç•¥

### 3.1 ç´¢å¼•ç»„åˆç­–ç•¥

**å¤šç´¢å¼•ç»„åˆ**ï¼š

```sql
-- 1. å‘é‡ç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops);

-- 2. å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX ON documents
USING GIN(to_tsvector('english', content));

-- 3. BTreeç´¢å¼•ï¼ˆç»“æ„åŒ–å­—æ®µï¼‰
CREATE INDEX ON documents (category_id, rating DESC, created_at DESC);

-- 4. ç©ºé—´ç´¢å¼•ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
CREATE INDEX ON listings USING GIST(location);

-- 5. å¤åˆç´¢å¼•ï¼ˆå‘é‡+ç»“æ„åŒ–ï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
INCLUDE (category_id, rating);
```

### 3.2 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–

**æŸ¥è¯¢è®¡åˆ’åˆ†æ**ï¼š

```sql
-- åˆ†ææ··åˆæŸ¥è¯¢è®¡åˆ’ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    content,
    1 - (embedding <=> query_vec) AS vector_score,
    ts_rank(to_tsvector('english', content), query_ts) AS text_score
FROM documents,
     plainto_tsquery('english', 'keywords') AS query_ts
WHERE
    to_tsvector('english', content) @@ query_ts
    AND embedding <=> query_vec < 0.3
ORDER BY (vector_score * 0.7 + text_score * 0.3) DESC
LIMIT 10;
```

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨CTEä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
WITH vector_filtered AS (
    SELECT id, content, embedding
    FROM documents
    WHERE embedding <=> query_vec < 0.3
    LIMIT 100  -- å…ˆè¿‡æ»¤å‘é‡ï¼Œå‡å°‘åç»­å¤„ç†
),
text_filtered AS (
    SELECT id, content
    FROM vector_filtered
    WHERE to_tsvector('english', content) @@ query_ts
)
SELECT
    id,
    content,
    1 - (embedding <=> query_vec) AS vector_score,
    ts_rank(to_tsvector('english', content), query_ts) AS text_score
FROM text_filtered
ORDER BY (vector_score * 0.7 + text_score * 0.3) DESC
LIMIT 10;
```

### 3.3 ç»“æœèåˆç®—æ³•

**RRFï¼ˆReciprocal Rank Fusionï¼‰ç®—æ³•**ï¼š

```sql
-- RRFèåˆå®ç°
WITH vector_results AS (
    SELECT
        id,
        content,
        ROW_NUMBER() OVER (ORDER BY embedding <=> query_vec) AS vector_rank
    FROM documents
    WHERE embedding <=> query_vec < 0.3
    LIMIT 50
),
text_results AS (
    SELECT
        id,
        content,
        ROW_NUMBER() OVER (
            ORDER BY ts_rank(
                to_tsvector('english', content),
                plainto_tsquery('english', 'keywords')
            ) DESC
        ) AS text_rank
    FROM documents
    WHERE to_tsvector('english', content)
          @@ plainto_tsquery('english', 'keywords')
    LIMIT 50
)
SELECT
    COALESCE(vr.id, tr.id) AS id,
    COALESCE(vr.content, tr.content) AS content,
    -- RRFå¾—åˆ†ï¼ˆk=60ï¼‰
    1.0 / (60 + COALESCE(vr.vector_rank, 100)) +
    1.0 / (60 + COALESCE(tr.text_rank, 100)) AS rrf_score
FROM vector_results vr
FULL OUTER JOIN text_results tr ON vr.id = tr.id
ORDER BY rrf_score DESC
LIMIT 10;
```

**åŠ æƒèåˆç®—æ³•**ï¼š

```sql
-- åŠ æƒèåˆï¼ˆæ›´ç®€å•ï¼‰
SELECT
    id,
    content,
    -- å‘é‡å¾—åˆ†ï¼ˆå½’ä¸€åŒ–åˆ°0-1ï¼‰
    (1 - (embedding <=> query_vec)) AS vector_score,
    -- æ–‡æœ¬å¾—åˆ†ï¼ˆå½’ä¸€åŒ–ï¼‰
    ts_rank(
        to_tsvector('english', content),
        plainto_tsquery('english', 'keywords')
    ) / 10.0 AS text_score,  -- å‡è®¾æœ€å¤§rankä¸º10
    -- åŠ æƒèåˆ
    (1 - (embedding <=> query_vec)) * 0.7 +
    (ts_rank(...) / 10.0) * 0.3 AS final_score
FROM documents
WHERE
    to_tsvector('english', content) @@ plainto_tsquery('english', 'keywords')
    AND embedding <=> query_vec < 0.3
ORDER BY final_score DESC
LIMIT 10;
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨LIMITæå‰ç»ˆæ­¢
SELECT ... LIMIT 10;  -- åªè¿”å›Top 10

-- 2. è®¾ç½®é˜ˆå€¼æå‰è¿‡æ»¤
WHERE similarity > 0.7  -- æå‰è¿‡æ»¤ä½ç›¸ä¼¼åº¦ç»“æœ

-- 3. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW hybrid_search_cache AS
SELECT
    id,
    content,
    embedding,
    to_tsvector('english', content) AS content_tsvector
FROM documents
WHERE created_at > NOW() - INTERVAL '1 year';

CREATE INDEX ON hybrid_search_cache
USING hnsw(embedding vector_cosine_ops);
CREATE INDEX ON hybrid_search_cache
USING GIN(content_tsvector);
```

### 4.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•é€‰æ‹©ç­–ç•¥**ï¼š

| æŸ¥è¯¢æ¨¡å¼ | æ¨èç´¢å¼•ç»„åˆ | æ€§èƒ½æå‡ |
|---------|-------------|---------|
| **å‘é‡+ç±»åˆ«** | HNSW + BTree | 10x |
| **å‘é‡+å…¨æ–‡** | HNSW + GIN | 5x |
| **å‘é‡+ç©ºé—´** | HNSW + GIST | 8x |
| **å‘é‡+æ—¶é—´** | HNSW + BTree(æ—¶é—´) | 6x |

### 4.3 ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜**ï¼š

```sql
-- 1. PostgreSQLå†…ç½®ç¼“å­˜ï¼ˆè‡ªåŠ¨ï¼‰
-- 2. åº”ç”¨å±‚ç¼“å­˜ï¼ˆRedisï¼‰
-- 3. æŸ¥è¯¢ç»“æœç¼“å­˜

CREATE TABLE query_cache (
    query_hash TEXT PRIMARY KEY,
    results JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-03-03
