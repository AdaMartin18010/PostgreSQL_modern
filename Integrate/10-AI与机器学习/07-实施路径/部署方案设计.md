---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\07-å®æ–½è·¯å¾„\éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡

> **æ–‡æ¡£ç¼–å·**: AI-07-03
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 07-å®æ–½è·¯å¾„
> **å­ä¸»é¢˜**: 03-éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡

## ğŸ“‘ ç›®å½•

- [éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡](#éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. éƒ¨ç½²æ–¹æ¡ˆæ¦‚è¿°](#1-éƒ¨ç½²æ–¹æ¡ˆæ¦‚è¿°)
    - [1.1 éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾](#11-éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾)
    - [1.2 éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘](#12-éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘)
  - [2. éƒ¨ç½²æ¨¡å¼è¯¦è§£](#2-éƒ¨ç½²æ¨¡å¼è¯¦è§£)
    - [2.1 Serverlesséƒ¨ç½²](#21-serverlesséƒ¨ç½²)
    - [2.2 æ ‡å‡†éƒ¨ç½²](#22-æ ‡å‡†éƒ¨ç½²)
    - [2.3 é«˜å¯ç”¨éƒ¨ç½²](#23-é«˜å¯ç”¨éƒ¨ç½²)
  - [3. ç¯å¢ƒè¦æ±‚](#3-ç¯å¢ƒè¦æ±‚)
    - [3.1 ç¡¬ä»¶è¦æ±‚](#31-ç¡¬ä»¶è¦æ±‚)
    - [3.2 è½¯ä»¶è¦æ±‚](#32-è½¯ä»¶è¦æ±‚)
    - [3.3 ç½‘ç»œé…ç½®](#33-ç½‘ç»œé…ç½®)
  - [4. å®‰è£…é…ç½®](#4-å®‰è£…é…ç½®)
    - [4.1 PostgreSQLå®‰è£…](#41-postgresqlå®‰è£…)
    - [4.2 æ‰©å±•å®‰è£…](#42-æ‰©å±•å®‰è£…)
    - [4.3 å‚æ•°é…ç½®](#43-å‚æ•°é…ç½®)
  - [5. é«˜å¯ç”¨é…ç½®](#5-é«˜å¯ç”¨é…ç½®)
    - [5.1 ä¸»ä»å¤åˆ¶](#51-ä¸»ä»å¤åˆ¶)
    - [5.2 è‡ªåŠ¨æ•…éšœè½¬ç§»](#52-è‡ªåŠ¨æ•…éšœè½¬ç§»)
    - [5.3 è´Ÿè½½å‡è¡¡](#53-è´Ÿè½½å‡è¡¡)
  - [6. ç›‘æ§å‘Šè­¦](#6-ç›‘æ§å‘Šè­¦)
    - [6.1 ç›‘æ§æŒ‡æ ‡](#61-ç›‘æ§æŒ‡æ ‡)
    - [6.2 å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
    - [6.3 æ—¥å¿—ç®¡ç†](#63-æ—¥å¿—ç®¡ç†)
  - [7. å¤‡ä»½æ¢å¤](#7-å¤‡ä»½æ¢å¤)
    - [7.1 å¤‡ä»½ç­–ç•¥](#71-å¤‡ä»½ç­–ç•¥)
    - [7.2 æ¢å¤æµ‹è¯•](#72-æ¢å¤æµ‹è¯•)
    - [7.3 ç¾éš¾æ¢å¤](#73-ç¾éš¾æ¢å¤)
  - [8. å®‰å…¨é…ç½®](#8-å®‰å…¨é…ç½®)
    - [8.1 è®¿é—®æ§åˆ¶](#81-è®¿é—®æ§åˆ¶)
    - [8.2 æ•°æ®åŠ å¯†](#82-æ•°æ®åŠ å¯†)
    - [8.3 å®¡è®¡æ—¥å¿—](#83-å®¡è®¡æ—¥å¿—)

---

## 1. éƒ¨ç½²æ–¹æ¡ˆæ¦‚è¿°

### 1.1 éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL AIéƒ¨ç½²æ–¹æ¡ˆ))
    éƒ¨ç½²æ¨¡å¼
      Serverless
        æŒ‰éœ€ä»˜è´¹
        Scale-to-Zero
        å¿«é€Ÿå¯åŠ¨
      æ ‡å‡†éƒ¨ç½²
        å•æœºéƒ¨ç½²
        å®¹å™¨åŒ–éƒ¨ç½²
        Kuberneteséƒ¨ç½²
      é«˜å¯ç”¨éƒ¨ç½²
        ä¸»ä»å¤åˆ¶
        è‡ªåŠ¨æ•…éšœè½¬ç§»
        è´Ÿè½½å‡è¡¡
    éƒ¨ç½²ç¯å¢ƒ
      äº‘åŸç”Ÿ
        Kubernetes
        Docker
        Cloud Native
      ä¼ ç»Ÿç¯å¢ƒ
        ç‰©ç†æœº
        è™šæ‹Ÿæœº
        æ··åˆäº‘
    æ ¸å¿ƒç»„ä»¶
      PostgreSQL 18
      pgvectoræ‰©å±•
      pg_aiæ‰©å±•
      PostgresMLæ‰©å±•
```

### 1.2 éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```mermaid
graph TD
    Start[å¼€å§‹é€‰æ‹©éƒ¨ç½²æ–¹æ¡ˆ] --> Q1{æ˜¯å¦éœ€è¦é«˜å¯ç”¨?}
    Q1 -->|æ˜¯| Q2{æ˜¯å¦éœ€è¦è‡ªåŠ¨æ‰©ç¼©å®¹?}
    Q1 -->|å¦| Q3{æ•°æ®é‡è§„æ¨¡?}
    Q2 -->|æ˜¯| Serverless[Serverlesséƒ¨ç½²<br/>Neon/Supabase]
    Q2 -->|å¦| HA[é«˜å¯ç”¨éƒ¨ç½²<br/>ä¸»ä»+è‡ªåŠ¨æ•…éšœè½¬ç§»]
    Q3 -->|å°è§„æ¨¡<1TB| Standard[æ ‡å‡†éƒ¨ç½²<br/>å•æœº/å®¹å™¨]
    Q3 -->|å¤§è§„æ¨¡>1TB| Scale[é«˜å¯ç”¨+åˆ†ç‰‡<br/>Kubernetes]

    style Serverless fill:#50c878,color:#fff
    style HA fill:#4a90e2,color:#fff
    style Standard fill:#f39c12,color:#fff
```

---

## 2. éƒ¨ç½²æ¨¡å¼è¯¦è§£

### 2.1 Serverlesséƒ¨ç½²

**é€‚ç”¨åœºæ™¯**ï¼š

- å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- ä¸­å°å‹åº”ç”¨ï¼ˆ<100GBæ•°æ®ï¼‰
- éœ€è¦æŒ‰éœ€ä»˜è´¹çš„åœºæ™¯
- å¿«é€Ÿå¯åŠ¨éœ€æ±‚

**Serverlessæ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **Neon** | PostgreSQL Serverlessï¼Œæ•°æ®åº“åˆ†æ”¯ | AI Agentåº”ç”¨ |
| **Supabase** | å…¨æ ˆServerlesså¹³å° | å¿«é€ŸåŸå‹å¼€å‘ |
| **AWS RDS Serverless** | è‡ªåŠ¨æ‰©ç¼©å®¹ | AWSç”Ÿæ€åº”ç”¨ |
| **Azure Database Flexible Server** | æŒ‰éœ€ä»˜è´¹ | Azureç”Ÿæ€åº”ç”¨ |

**Neonéƒ¨ç½²ç¤ºä¾‹**ï¼š

```bash
# 1. å®‰è£…Neon CLI
npm install -g neonctl

# 2. åˆ›å»ºé¡¹ç›®
neonctl projects create --name ai-app

# 3. åˆ›å»ºæ•°æ®åº“åˆ†æ”¯
neonctl branches create --name main

# 4. å®‰è£…æ‰©å±•
neonctl sql "CREATE EXTENSION vector;"
neonctl sql "CREATE EXTENSION pg_ai;"
```

**Supabaseéƒ¨ç½²ç¤ºä¾‹**ï¼š

```bash
# 1. åˆ›å»ºSupabaseé¡¹ç›®
supabase init

# 2. å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
supabase start

# 3. å®‰è£…æ‰©å±•ï¼ˆåœ¨SQL Editorä¸­ï¼‰
CREATE EXTENSION vector;
CREATE EXTENSION pg_ai;
```

### 2.2 æ ‡å‡†éƒ¨ç½²

**å•æœºéƒ¨ç½²**ï¼š

```bash
# 1. å®‰è£…PostgreSQL 18
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install postgresql-18

# CentOS/RHEL
sudo yum install postgresql18-server

# macOS
brew install postgresql@18

# 2. åˆå§‹åŒ–æ•°æ®åº“
sudo postgresql-18-setup initdb

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18
```

**Dockeréƒ¨ç½²**ï¼š

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg18
    container_name: postgres-ai
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ai_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=vector,pg_ai"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

**Kuberneteséƒ¨ç½²**ï¼š

```yaml
# postgresql-deployment.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-ai
spec:
  serviceName: postgres-ai
  replicas: 1
  selector:
    matchLabels:
      app: postgres-ai
  template:
    metadata:
      labels:
        app: postgres-ai
    spec:
      containers:
      - name: postgres
        image: pgvector/pgvector:pg18
        env:
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: POSTGRES_DB
          value: ai_db
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        command:
        - "postgres"
        - "-c"
        - "shared_preload_libraries=vector,pg_ai"
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
```

### 2.3 é«˜å¯ç”¨éƒ¨ç½²

**ä¸»ä»å¤åˆ¶æ¶æ„**ï¼š

```mermaid
graph TB
    App[åº”ç”¨å±‚]
    LB[è´Ÿè½½å‡è¡¡å™¨<br/>PgBouncer]
    Primary[(ä¸»åº“<br/>PostgreSQL)]
    Standby1[(ä»åº“1<br/>PostgreSQL)]
    Standby2[(ä»åº“2<br/>PostgreSQL)]

    App --> LB
    LB --> Primary
    LB --> Standby1
    LB --> Standby2
    Primary -.->|æµå¤åˆ¶| Standby1
    Primary -.->|æµå¤åˆ¶| Standby2

    style Primary fill:#4a90e2,color:#fff
    style Standby1 fill:#50c878,color:#fff
    style Standby2 fill:#50c878,color:#fff
```

**é…ç½®ä¸»ä»å¤åˆ¶**ï¼š

```sql
-- ä¸»åº“é…ç½® (postgresql.conf)
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3

-- ä¸»åº“åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'password';

-- ä¸»åº“é…ç½® (pg_hba.conf)
host replication replicator 0.0.0.0/0 md5

-- ä»åº“é…ç½® (postgresql.conf)
primary_conninfo = 'host=primary_host port=5432 user=replicator password=password'
```

**è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆPatroniï¼‰**ï¼š

```yaml
# patroni.yml
scope: postgres-cluster
namespace: /postgres/
name: postgres-node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: localhost:8008

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        max_connections: 100
        max_wal_senders: 10
        max_replication_slots: 10

postgresql:
  listen: 0.0.0.0:5432
  connect_address: localhost:5432
  data_dir: /var/lib/postgresql/data
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: password
    superuser:
      username: postgres
      password: password
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```

---

## 3. ç¯å¢ƒè¦æ±‚

### 3.1 ç¡¬ä»¶è¦æ±‚

**æœ€å°é…ç½®**ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰ï¼š

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **CPU** | 2æ ¸å¿ƒ | åŸºç¡€æŸ¥è¯¢å¤„ç† |
| **å†…å­˜** | 4GB | åŸºæœ¬ç¼“å­˜éœ€æ±‚ |
| **å­˜å‚¨** | 50GB SSD | æ•°æ®å­˜å‚¨ |
| **ç½‘ç»œ** | 100Mbps | åŸºç¡€ç½‘ç»œéœ€æ±‚ |

**æ¨èé…ç½®**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **CPU** | 8æ ¸å¿ƒ+ | é«˜å¹¶å‘æŸ¥è¯¢ |
| **å†…å­˜** | 32GB+ | å‘é‡ç´¢å¼•ç¼“å­˜ |
| **å­˜å‚¨** | 500GB+ NVMe SSD | é«˜æ€§èƒ½å­˜å‚¨ |
| **ç½‘ç»œ** | 1Gbps+ | é«˜ååé‡ |

**å¤§è§„æ¨¡é…ç½®**ï¼ˆç™¾ä¸‡çº§å‘é‡ï¼‰ï¼š

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **CPU** | 32æ ¸å¿ƒ+ | å¤§è§„æ¨¡å¹¶å‘ |
| **å†…å­˜** | 128GB+ | å¤§å‹å‘é‡ç´¢å¼• |
| **å­˜å‚¨** | 2TB+ NVMe SSD | æµ·é‡æ•°æ®å­˜å‚¨ |
| **ç½‘ç»œ** | 10Gbps | é«˜å¸¦å®½éœ€æ±‚ |

### 3.2 è½¯ä»¶è¦æ±‚

**PostgreSQLç‰ˆæœ¬**ï¼š

- **æ¨è**ï¼šPostgreSQL 18ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼ŒI/Oæ€§èƒ½æå‡3å€ï¼‰
- **æœ€ä½**ï¼šPostgreSQL 15ï¼ˆæ”¯æŒpgvector 0.5+ï¼‰

**å¿…éœ€æ‰©å±•**ï¼š

- `vector` (pgvector) >= 0.8.0
- `pg_ai` >= 0.1.0ï¼ˆå¯é€‰ï¼ŒAIåŸç”Ÿè°ƒç”¨ï¼‰
- `pgml` >= 3.0ï¼ˆå¯é€‰ï¼Œå†…ç½®æœºå™¨å­¦ä¹ ï¼‰

**æ“ä½œç³»ç»Ÿ**ï¼š

- Linux: Ubuntu 22.04+, CentOS 8+, RHEL 8+
- macOS: macOS 12+
- Windows: Windows Server 2019+ï¼ˆé€šè¿‡Dockerï¼‰

### 3.3 ç½‘ç»œé…ç½®

**ç½‘ç»œæ¶æ„**ï¼š

```mermaid
graph TB
    Internet[äº’è”ç½‘]
    LB[è´Ÿè½½å‡è¡¡å™¨]
    App[åº”ç”¨æœåŠ¡å™¨]
    DB[(PostgreSQL)]
    Backup[å¤‡ä»½å­˜å‚¨]

    Internet --> LB
    LB --> App
    App --> DB
    DB --> Backup

    style DB fill:#4a90e2,color:#fff
```

**é˜²ç«å¢™é…ç½®**ï¼š

```bash
# å…è®¸PostgreSQLç«¯å£ï¼ˆä»…å†…ç½‘ï¼‰
sudo ufw allow from 10.0.0.0/8 to any port 5432
sudo ufw allow from 172.16.0.0/12 to any port 5432

# å…è®¸PgBouncerç«¯å£ï¼ˆåº”ç”¨æœåŠ¡å™¨ï¼‰
sudo ufw allow from 10.0.1.0/24 to any port 6432
```

---

## 4. å®‰è£…é…ç½®

### 4.1 PostgreSQLå®‰è£…

**Ubuntu/Debianå®‰è£…**ï¼š

```bash
# 1. æ·»åŠ PostgreSQLå®˜æ–¹ä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# 2. å®‰è£…PostgreSQL 18
sudo apt-get install postgresql-18 postgresql-contrib-18

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18

# 4. éªŒè¯å®‰è£…
sudo -u postgres psql -c "SELECT version();"
```

**CentOS/RHELå®‰è£…**ï¼š

```bash
# 1. å®‰è£…PostgreSQLä»“åº“
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# 2. å®‰è£…PostgreSQL 18
sudo yum install -y postgresql18-server postgresql18

# 3. åˆå§‹åŒ–æ•°æ®åº“
sudo /usr/pgsql-18/bin/postgresql-18-setup initdb

# 4. å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18
```

### 4.2 æ‰©å±•å®‰è£…

**å®‰è£…pgvector**ï¼š

```bash
# 1. å®‰è£…ä¾èµ–
sudo apt-get install -y build-essential git postgresql-server-dev-18

# 2. å…‹éš†pgvectorä»“åº“
git clone --branch v0.8.0 https://github.com/pgvector/pgvector.git
cd pgvector

# 3. ç¼–è¯‘å®‰è£…
make
sudo make install

# 4. åœ¨æ•°æ®åº“ä¸­å¯ç”¨æ‰©å±•
sudo -u postgres psql -d postgres -c "CREATE EXTENSION vector;"
```

**å®‰è£…pg_ai**ï¼š

```bash
# 1. å…‹éš†pg_aiä»“åº“
git clone https://github.com/cloudquery/pg_ai.git
cd pg_ai

# 2. ç¼–è¯‘å®‰è£…
make
sudo make install

# 3. é…ç½®APIå¯†é’¥ï¼ˆåœ¨postgresql.confä¸­ï¼‰
# pg_ai.openai_api_key = 'your-api-key'

# 4. åœ¨æ•°æ®åº“ä¸­å¯ç”¨æ‰©å±•
sudo -u postgres psql -d postgres -c "CREATE EXTENSION pg_ai;"
```

**å®‰è£…PostgresML**ï¼š

```bash
# 1. ä½¿ç”¨Dockerï¼ˆæ¨èï¼‰
docker run -d \
  --name postgresml \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  ghcr.io/postgresml/postgresml:latest

# 2. æˆ–ä»æºç å®‰è£…
git clone https://github.com/postgresml/postgresml.git
cd postgresml/pgml
make install
```

### 4.3 å‚æ•°é…ç½®

**PostgreSQL 18ä¼˜åŒ–é…ç½®**ï¼š

```conf
# postgresql.conf

# å†…å­˜é…ç½®
shared_buffers = 8GB                    # 25% of RAM
effective_cache_size = 24GB             # 75% of RAM
work_mem = 64MB                         # ç”¨äºæ’åºå’Œå“ˆå¸Œ
maintenance_work_mem = 1GB              # ç”¨äºVACUUMç­‰ç»´æŠ¤æ“ä½œ

# è¿æ¥é…ç½®
max_connections = 200
superuser_reserved_connections = 3

# WALé…ç½®ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
wal_buffers = 16MB
min_wal_size = 1GB
max_wal_size = 4GB
wal_compression = lz4                   # PostgreSQL 18æ–°ç‰¹æ€§

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1                  # SSDä¼˜åŒ–
effective_io_concurrency = 200           # SSDå¹¶å‘I/O
default_statistics_target = 100

# å‘é‡æ‰©å±•é…ç½®
shared_preload_libraries = 'vector,pg_ai'

# æ—¥å¿—é…ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000       # è®°å½•æ…¢æŸ¥è¯¢ï¼ˆ>1ç§’ï¼‰
```

---

## 5. é«˜å¯ç”¨é…ç½®

### 5.1 ä¸»ä»å¤åˆ¶

**æµå¤åˆ¶é…ç½®**ï¼š

```sql
-- ä¸»åº“é…ç½®
-- postgresql.conf
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on

-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'password';

-- pg_hba.conf
host replication replicator 0.0.0.0/0 md5

-- åˆ›å»ºå¤åˆ¶æ§½
SELECT pg_create_physical_replication_slot('standby1');
SELECT pg_create_physical_replication_slot('standby2');
```

**ä»åº“é…ç½®**ï¼š

```bash
# 1. åŸºç¡€å¤‡ä»½
pg_basebackup -h primary_host -D /var/lib/postgresql/data \
  -U replicator -P -v -R -W

# 2. é…ç½®recovery.confï¼ˆPostgreSQL 12+ä½¿ç”¨postgresql.confï¼‰
# primary_conninfo = 'host=primary_host port=5432 user=replicator password=password'
# primary_slot_name = 'standby1'
```

### 5.2 è‡ªåŠ¨æ•…éšœè½¬ç§»

**ä½¿ç”¨Patroniå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼š

```bash
# 1. å®‰è£…Patroni
pip install patroni[etcd]

# 2. å¯åŠ¨etcdï¼ˆåè°ƒå™¨ï¼‰
docker run -d --name etcd \
  -p 2379:2379 \
  quay.io/coreos/etcd:v3.5.0 \
  etcd -name etcd0 \
  -advertise-client-urls http://0.0.0.0:2379 \
  -listen-client-urls http://0.0.0.0:2379

# 3. å¯åŠ¨Patroni
patroni patroni.yml
```

**ä½¿ç”¨pg_auto_failover**ï¼š

```bash
# 1. å®‰è£…pg_auto_failover
sudo apt-get install postgresql-auto-failover-18

# 2. åˆå§‹åŒ–monitorèŠ‚ç‚¹
pg_autoctl create monitor --pgdata /var/lib/postgresql/monitor

# 3. åˆå§‹åŒ–ä¸»èŠ‚ç‚¹
pg_autoctl create postgres --pgdata /var/lib/postgresql/data \
  --monitor 'postgres://monitor@monitor_host:5432/pg_auto_failover'

# 4. æ·»åŠ ä»èŠ‚ç‚¹
pg_autoctl create postgres --pgdata /var/lib/postgresql/data \
  --monitor 'postgres://monitor@monitor_host:5432/pg_auto_failover' \
  --name standby1
```

### 5.3 è´Ÿè½½å‡è¡¡

**PgBounceré…ç½®**ï¼š

```ini
# pgbouncer.ini
[databases]
ai_db = host=primary_host port=5432 dbname=ai_db
ai_db_standby = host=standby_host port=5432 dbname=ai_db

[pgbouncer]
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
reserve_pool_timeout = 3
max_db_connections = 100
```

**HAProxyé…ç½®**ï¼š

```conf
# haproxy.cfg
global
    log /dev/log local0
    maxconn 1000

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend postgres_frontend
    bind *:5432
    default_backend postgres_backend

backend postgres_backend
    balance roundrobin
    option pgsql-check user postgres
    server postgres1 primary_host:5432 check
    server postgres2 standby_host:5432 check backup
```

---

## 6. ç›‘æ§å‘Šè­¦

### 6.1 ç›‘æ§æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT count(*) FROM pg_stat_activity;

-- 2. æ…¢æŸ¥è¯¢ç›‘æ§
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes';

-- 3. æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size('ai_db'));

-- 4. è¡¨å¤§å°
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 5. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

**Prometheusç›‘æ§é…ç½®**ï¼š

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']
```

**PostgreSQL Exporteré…ç½®**ï¼š

```bash
# å®‰è£…postgres_exporter
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz
tar xvfz postgres_exporter-0.15.0.linux-amd64.tar.gz
./postgres_exporter --extend.query-path=queries.yaml
```

### 6.2 å‘Šè­¦è§„åˆ™

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š

```yaml
# alerts.yml
groups:
  - name: postgres_alerts
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        annotations:
          summary: "PostgreSQL instance is down"

      - alert: HighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        annotations:
          summary: "High number of database connections"

      - alert: SlowQueries
        expr: pg_stat_statements_mean_exec_time > 5000
        for: 5m
        annotations:
          summary: "Slow queries detected"

      - alert: DatabaseSize
        expr: pg_database_size_bytes > 100000000000
        for: 1h
        annotations:
          summary: "Database size exceeds 100GB"
```

### 6.3 æ—¥å¿—ç®¡ç†

**æ—¥å¿—é…ç½®**ï¼š

```conf
# postgresql.conf
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
```

**æ—¥å¿—è½®è½¬ï¼ˆlogrotateï¼‰**ï¼š

```conf
# /etc/logrotate.d/postgresql
/var/lib/postgresql/18/data/log/postgresql-*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 postgres postgres
    sharedscripts
    postrotate
        systemctl reload postgresql-18 > /dev/null 2>&1 || true
    endscript
}
```

---

## 7. å¤‡ä»½æ¢å¤

### 7.1 å¤‡ä»½ç­–ç•¥

**ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰**ï¼š

```bash
# å®Œæ•´å¤‡ä»½
pg_basebackup -D /backup/postgresql/full_$(date +%Y%m%d) \
  -Ft -z -P -U postgres

# å¢é‡å¤‡ä»½ï¼ˆä½¿ç”¨WALå½’æ¡£ï¼‰
# postgresql.conf
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

**é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰**ï¼š

```bash
# å®Œæ•´å¤‡ä»½
pg_dump -Fc -f /backup/ai_db_$(date +%Y%m%d).dump ai_db

# ä»…æ•°æ®å¤‡ä»½
pg_dump -Fc -a -f /backup/ai_db_data_$(date +%Y%m%d).dump ai_db

# ä»…ç»“æ„å¤‡ä»½
pg_dump -Fc -s -f /backup/ai_db_schema_$(date +%Y%m%d).dump ai_db
```

**è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬**ï¼š

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="ai_db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# é€»è¾‘å¤‡ä»½
pg_dump -Fc -f $BACKUP_DIR/${DB_NAME}_${DATE}.dump $DB_NAME

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.dump" -mtime +7 -delete

# å‘é€å¤‡ä»½åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $BACKUP_DIR/${DB_NAME}_${DATE}.dump s3://backup-bucket/
```

### 7.2 æ¢å¤æµ‹è¯•

**æ¢å¤æµ‹è¯•æµç¨‹**ï¼š

```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb test_restore

# 2. æ¢å¤å¤‡ä»½
pg_restore -d test_restore /backup/ai_db_20250101.dump

# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
psql -d test_restore -c "SELECT COUNT(*) FROM documents;"
psql -d test_restore -c "SELECT COUNT(*) FROM document_chunks;"

# 4. æ¸…ç†æµ‹è¯•æ•°æ®åº“
dropdb test_restore
```

### 7.3 ç¾éš¾æ¢å¤

**PITRï¼ˆPoint-in-Time Recoveryï¼‰**ï¼š

```bash
# 1. åŸºç¡€å¤‡ä»½
pg_basebackup -D /backup/base -Ft -z

# 2. é…ç½®æ¢å¤ï¼ˆpostgresql.confï¼‰
recovery_target_time = '2025-01-15 14:30:00'
restore_command = 'cp /backup/wal/%f %p'

# 3. åˆ›å»ºrecovery.signalæ–‡ä»¶
touch /var/lib/postgresql/data/recovery.signal

# 4. å¯åŠ¨PostgreSQLï¼ˆè‡ªåŠ¨æ¢å¤ï¼‰
systemctl start postgresql-18
```

---

## 8. å®‰å…¨é…ç½®

### 8.1 è®¿é—®æ§åˆ¶

**ç”¨æˆ·æƒé™ç®¡ç†**ï¼š

```sql
-- 1. åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER app_user WITH PASSWORD 'strong_password';

-- 2. æˆäºˆæœ€å°æƒé™
GRANT CONNECT ON DATABASE ai_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;

-- 3. è®¾ç½®é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;

-- 4. é™åˆ¶è¿æ¥æ•°
ALTER USER app_user WITH CONNECTION LIMIT 50;
```

**pg_hba.confé…ç½®**ï¼š

```conf
# ä»…å…è®¸å†…ç½‘è¿æ¥
host    ai_db    app_user    10.0.0.0/8    md5
host    ai_db    app_user    172.16.0.0/12 md5

# æ‹’ç»å…¶ä»–è¿æ¥
host    all      all         0.0.0.0/0     reject
```

### 8.2 æ•°æ®åŠ å¯†

**ä¼ è¾“åŠ å¯†ï¼ˆSSLï¼‰**ï¼š

```conf
# postgresql.conf
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'
```

**é™æ€åŠ å¯†ï¼ˆé€æ˜æ•°æ®åŠ å¯†ï¼‰**ï¼š

```bash
# ä½¿ç”¨LUKSåŠ å¯†ç£ç›˜
sudo cryptsetup luksFormat /dev/sdb
sudo cryptsetup luksOpen /dev/sdb encrypted_postgres
sudo mkfs.ext4 /dev/mapper/encrypted_postgres
```

### 8.3 å®¡è®¡æ—¥å¿—

**å¯ç”¨å®¡è®¡æ—¥å¿—**ï¼š

```sql
-- å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION pgaudit;

-- postgresql.conf
shared_preload_libraries = 'pgaudit'
pgaudit.log = 'all'
pgaudit.log_catalog = off
pgaudit.log_parameter = on
pgaudit.log_statement_once = off
```

**å®¡è®¡å…³é”®æ“ä½œ**ï¼š

```sql
-- å®¡è®¡DDLæ“ä½œ
ALTER DATABASE ai_db SET pgaudit.log = 'ddl';

-- å®¡è®¡æ•°æ®ä¿®æ”¹
ALTER DATABASE ai_db SET pgaudit.log = 'write';
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-03
