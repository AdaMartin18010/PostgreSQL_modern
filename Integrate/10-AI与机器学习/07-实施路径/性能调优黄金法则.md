---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\07-å®æ–½è·¯å¾„\æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™

> **æ–‡æ¡£ç¼–å·**: AI-07-02
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 07-å®æ–½è·¯å¾„
> **å­ä¸»é¢˜**: 02-æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™

## ğŸ“‘ ç›®å½•

- [æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™](#æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾](#11-æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾)
  - [äºŒã€è°ƒä¼˜åŸåˆ™](#äºŒè°ƒä¼˜åŸåˆ™)
    - [2.1 æµ‹é‡ä¼˜å…ˆ](#21-æµ‹é‡ä¼˜å…ˆ)
    - [2.2 ç“¶é¢ˆè¯†åˆ«](#22-ç“¶é¢ˆè¯†åˆ«)
    - [2.3 æ¸è¿›ä¼˜åŒ–](#23-æ¸è¿›ä¼˜åŒ–)
  - [ä¸‰ã€å‘é‡æŸ¥è¯¢ä¼˜åŒ–](#ä¸‰å‘é‡æŸ¥è¯¢ä¼˜åŒ–)
    - [3.1 ç´¢å¼•å‚æ•°è°ƒä¼˜](#31-ç´¢å¼•å‚æ•°è°ƒä¼˜)
    - [3.2 æŸ¥è¯¢å‚æ•°ä¼˜åŒ–](#32-æŸ¥è¯¢å‚æ•°ä¼˜åŒ–)
    - [3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–](#33-æ··åˆæŸ¥è¯¢ä¼˜åŒ–)
  - [å››ã€SQLæŸ¥è¯¢ä¼˜åŒ–](#å››sqlæŸ¥è¯¢ä¼˜åŒ–)
    - [4.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#41-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
    - [4.2 ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–](#42-ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–)
    - [4.3 è¿æ¥ä¼˜åŒ–](#43-è¿æ¥ä¼˜åŒ–)
  - [äº”ã€ç³»ç»Ÿå‚æ•°ä¼˜åŒ–](#äº”ç³»ç»Ÿå‚æ•°ä¼˜åŒ–)
    - [5.1 å†…å­˜å‚æ•°](#51-å†…å­˜å‚æ•°)
    - [5.2 å¹¶å‘å‚æ•°](#52-å¹¶å‘å‚æ•°)
    - [5.3 å‘é‡ä¸“ç”¨å‚æ•°](#53-å‘é‡ä¸“ç”¨å‚æ•°)
  - [å…­ã€ç¡¬ä»¶ä¼˜åŒ–](#å…­ç¡¬ä»¶ä¼˜åŒ–)
    - [6.1 CPUä¼˜åŒ–](#61-cpuä¼˜åŒ–)
    - [6.2 å†…å­˜ä¼˜åŒ–](#62-å†…å­˜ä¼˜åŒ–)
    - [6.3 å­˜å‚¨ä¼˜åŒ–](#63-å­˜å‚¨ä¼˜åŒ–)
  - [ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­](#ä¸ƒç›‘æ§ä¸è¯Šæ–­)
    - [7.1 æ€§èƒ½ç›‘æ§](#71-æ€§èƒ½ç›‘æ§)
    - [7.2 ç“¶é¢ˆè¯Šæ–­](#72-ç“¶é¢ˆè¯Šæ–­)
    - [7.3 æŒç»­ä¼˜åŒ–](#73-æŒç»­ä¼˜åŒ–)
  - [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
  - [ä¹ã€å…³è”ä¸»é¢˜](#ä¹å…³è”ä¸»é¢˜)
  - [åã€å¯¹æ ‡èµ„æº](#åå¯¹æ ‡èµ„æº)
    - [æŠ€æœ¯æ–‡æ¡£](#æŠ€æœ¯æ–‡æ¡£)
    - [åŸºå‡†æµ‹è¯•](#åŸºå‡†æµ‹è¯•)

## ä¸€ã€æ¦‚è¿°

PostgreSQL AIåº”ç”¨çš„æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™ï¼Œæä¾›ç³»ç»ŸåŒ–çš„ä¼˜åŒ–æ–¹æ³•å’Œæœ€ä½³å®è·µï¼Œç¡®ä¿AIåº”ç”¨åœ¨é«˜å¹¶å‘ã€å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æœ€ä½³æ€§èƒ½ã€‚

### 1.1 æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½è°ƒä¼˜))
    ç´¢å¼•ä¼˜åŒ–
      å‘é‡ç´¢å¼•
        HNSWå‚æ•°è°ƒä¼˜
        IVFFlatå‚æ•°è°ƒä¼˜
      å¤åˆç´¢å¼•
        å¤šåˆ—ç´¢å¼•
        éƒ¨åˆ†ç´¢å¼•
    è¿æ¥æ± 
      PgBouncer
        è¿æ¥å¤ç”¨
        è¿æ¥æ•°æ§åˆ¶
      é…ç½®ä¼˜åŒ–
        pool_mode
        max_client_conn
    ç¡¬ä»¶é€‰å‹
      CPU
        å¤šæ ¸å¤„ç†å™¨
        AVXæŒ‡ä»¤é›†
      å†…å­˜
        å……è¶³å†…å­˜
        shared_buffers
      å­˜å‚¨
        SSDå­˜å‚¨
        NVMe SSD
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢è®¡åˆ’
        EXPLAINåˆ†æ
        ç´¢å¼•ä½¿ç”¨
      æ‰¹é‡æ“ä½œ
        æ‰¹é‡æ’å…¥
        æ‰¹é‡æ›´æ–°
```

## äºŒã€è°ƒä¼˜åŸåˆ™

### 2.1 æµ‹é‡ä¼˜å…ˆ

**åŸåˆ™**: å…ˆæµ‹é‡ï¼Œåä¼˜åŒ–

```sql
-- å¯ç”¨æ€§èƒ½ç›‘æ§
CREATE EXTENSION pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- è¶…è¿‡100ms
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 2.2 ç“¶é¢ˆè¯†åˆ«

**åŸåˆ™**: è¯†åˆ«çœŸæ­£çš„ç“¶é¢ˆ

```sql
-- æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- æ£€æŸ¥I/Oç“¶é¢ˆ
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    ROUND(100.0 * heap_blks_hit / NULLIF(heap_blks_read + heap_blks_hit, 0), 2) AS hit_ratio
FROM pg_statio_user_tables
ORDER BY heap_blks_read DESC;
```

### 2.3 æ¸è¿›ä¼˜åŒ–

**åŸåˆ™**: é€æ­¥ä¼˜åŒ–ï¼ŒéªŒè¯æ•ˆæœ

1. åŸºçº¿æµ‹é‡
2. è¯†åˆ«ç“¶é¢ˆ
3. åº”ç”¨ä¼˜åŒ–
4. éªŒè¯æ•ˆæœ
5. é‡å¤è¿­ä»£

## ä¸‰ã€å‘é‡æŸ¥è¯¢ä¼˜åŒ–

### 3.1 ç´¢å¼•å‚æ•°è°ƒä¼˜

```sql
-- å°è§„æ¨¡æ•°æ®ï¼ˆ<100ä¸‡å‘é‡ï¼‰
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,              -- æ¯ä¸ªèŠ‚ç‚¹è¿æ¥æ•°
    ef_construction = 100  -- æ„å»ºæ—¶æœç´¢å®½åº¦
);

-- å¤§è§„æ¨¡æ•°æ®ï¼ˆ>100ä¸‡å‘é‡ï¼‰
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 32,              -- å¢åŠ è¿æ¥æ•°æå‡å¬å›ç‡
    ef_construction = 200  -- å¢åŠ æ„å»ºå®½åº¦æå‡è´¨é‡
);

-- æŸ¥è¯¢æ—¶ä¼˜åŒ–
SET hnsw.ef_search = 200;  -- æå‡å¬å›ç‡ï¼ˆé»˜è®¤40ï¼‰
```

### 3.2 æŸ¥è¯¢å‚æ•°ä¼˜åŒ–

```sql
-- ä¼˜åŒ–æŸ¥è¯¢é¡ºåº
-- å…ˆè¿‡æ»¤æ¡ä»¶ï¼Œå†å‘é‡æœç´¢
SELECT * FROM (
    SELECT * FROM products
    WHERE category = 'electronics'
      AND price < 1000
) filtered
WHERE embedding <=> query_vector < 0.8
ORDER BY embedding <=> query_vector
LIMIT 20;

-- ä½¿ç”¨LIMITå‡å°‘è®¡ç®—
-- å‘é‡è·ç¦»è®¡ç®—æˆæœ¬é«˜ï¼Œå°½æ—©ä½¿ç”¨LIMIT
SELECT * FROM documents
WHERE embedding <=> query_vector < 0.8
ORDER BY embedding <=> query_vector
LIMIT 10;  -- å°½æ—©é™åˆ¶ç»“æœé›†
```

### 3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW product_search_cache AS
SELECT
    p.id,
    p.title,
    p.category,
    p.price,
    p.embedding <=> query_vector AS distance
FROM products p
CROSS JOIN (SELECT ai.embedding('text-embedding-3-small', 'electronics') AS query_vector) q
WHERE p.category = 'electronics'
ORDER BY p.embedding <=> q.query_vector
LIMIT 100;

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY product_search_cache;
```

## å››ã€SQLæŸ¥è¯¢ä¼˜åŒ–

### 4.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM documents
WHERE category = 'technology'
  AND embedding <=> query_vector < 0.8
ORDER BY embedding <=> query_vector
LIMIT 20;

-- å…³é”®æŒ‡æ ‡ï¼š
-- - Seq Scan vs Index Scan
-- - è¿‡æ»¤æ¡ä»¶é¡ºåº
-- - è¿æ¥æ–¹å¼
-- - ç¼“å†²åŒºä½¿ç”¨
```

### 4.2 ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–

```sql
-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX ON products
USING btree (category, price, (embedding <=> query_vector))
INCLUDE (title, description);

-- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WHERE status = 'active'
  AND created_at > NOW() - INTERVAL '1 year';

-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 4.3 è¿æ¥ä¼˜åŒ–

```sql
-- ä¼˜åŒ–JOINé¡ºåº
-- å°è¡¨åœ¨å‰ï¼Œå¤§è¡¨åœ¨å
SELECT * FROM small_table s
JOIN large_table l ON s.id = l.small_id;

-- ä½¿ç”¨INNER JOINæ›¿ä»£WHEREå­å¥
-- ä¼˜åŒ–å‰
SELECT * FROM a, b WHERE a.id = b.id;

-- ä¼˜åŒ–å
SELECT * FROM a INNER JOIN b ON a.id = b.id;
```

## äº”ã€ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

### 5.1 å†…å­˜å‚æ•°

```sql
-- postgresql.confä¼˜åŒ–
shared_buffers = 25% of RAM          # å…±äº«ç¼“å†²åŒº
effective_cache_size = 75% of RAM    # æœ‰æ•ˆç¼“å­˜å¤§å°
work_mem = 256MB                    # å·¥ä½œå†…å­˜ï¼ˆæ¯ä¸ªæ“ä½œï¼‰
maintenance_work_mem = 1GB          # ç»´æŠ¤æ“ä½œå†…å­˜

-- å‘é‡æŸ¥è¯¢ä¸“ç”¨
-- å¤§è§„æ¨¡å‘é‡æŸ¥è¯¢éœ€è¦æ›´å¤šå†…å­˜
SET work_mem = '512MB';
```

### 5.2 å¹¶å‘å‚æ•°

```sql
-- å¹¶å‘é…ç½®
max_connections = 200
max_worker_processes = 16
max_parallel_workers_per_gather = 4
max_parallel_workers = 8

-- å‘é‡æŸ¥è¯¢å¹¶è¡Œ
SET max_parallel_workers_per_gather = 4;
```

### 5.3 å‘é‡ä¸“ç”¨å‚æ•°

```sql
-- HNSWæŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 200;  -- æå‡å¬å›ç‡ï¼ˆé»˜è®¤40ï¼‰

-- IVFFlatæŸ¥è¯¢å‚æ•°
SET ivfflat.probes = 10;  -- æœç´¢èšç±»æ•°ï¼ˆé»˜è®¤1ï¼‰

-- å‘é‡è·ç¦»è®¡ç®—
-- ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆé»˜è®¤ï¼‰
-- ä½¿ç”¨æ¬§æ°è·ç¦»ï¼š<-> æ“ä½œç¬¦
-- ä½¿ç”¨å†…ç§¯ï¼š<#> æ“ä½œç¬¦
```

## å…­ã€ç¡¬ä»¶ä¼˜åŒ–

### 6.1 CPUä¼˜åŒ–

| åœºæ™¯ | CPUæ ¸å¿ƒæ•° | æ¨èé…ç½® |
|------|:---------:|:--------|
| OLTP+å‘é‡ | 16+ | Intel Xeon / AMD EPYC |
| çº¯å‘é‡æ£€ç´¢ | 8+ | Intel Xeon |
| AIè®­ç»ƒ | 32+ | Intel Xeon / NVIDIA GPU |

### 6.2 å†…å­˜ä¼˜åŒ–

```sql
-- å†…å­˜é…ç½®å»ºè®®
-- å‘é‡æ•°æ®éœ€è¦å¤§é‡å†…å­˜
-- å»ºè®®ï¼šè‡³å°‘32GB RAMï¼ˆä¸­ç­‰è§„æ¨¡ï¼‰
-- å¤§è§„æ¨¡åœºæ™¯ï¼š128GB+

-- ç›‘æ§å†…å­˜ä½¿ç”¨
SELECT
    setting,
    unit,
    source
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'effective_cache_size');
```

### 6.3 å­˜å‚¨ä¼˜åŒ–

| åœºæ™¯ | å­˜å‚¨ç±»å‹ | IOPSè¦æ±‚ |
|------|:--------:|:--------|
| å‘é‡æ•°æ® | NVMe SSD | 10,000+ |
| æ—¥å¿—æ–‡ä»¶ | SSD | 5,000+ |
| å¤‡ä»½ | å¯¹è±¡å­˜å‚¨ | - |

## ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­

### 7.1 æ€§èƒ½ç›‘æ§

```sql
-- å¯ç”¨pg_stat_statements
CREATE EXTENSION pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_exec_time DESC
LIMIT 10;

-- å‘é‡æŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%<=>%'  -- å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢
ORDER BY mean_exec_time DESC;
```

### 7.2 ç“¶é¢ˆè¯Šæ–­

```sql
-- æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- æ£€æŸ¥I/Oç“¶é¢ˆ
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    ROUND(100.0 * heap_blks_hit / NULLIF(heap_blks_read + heap_blks_hit, 0), 2) AS hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read > 1000
ORDER BY heap_blks_read DESC;
```

### 7.3 æŒç»­ä¼˜åŒ–

```sql
-- å®šæœŸåˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯
ALTER TABLE documents
ALTER COLUMN embedding SET STATISTICS 1000;

ANALYZE documents (embedding);

-- ç›‘æ§ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;
```

## å…«ã€æœ€ä½³å®è·µ

1. **æµ‹é‡ä¼˜å…ˆ**:
   - å…ˆæµ‹é‡æ€§èƒ½åŸºçº¿
   - è¯†åˆ«çœŸæ­£çš„ç“¶é¢ˆ
   - éªŒè¯ä¼˜åŒ–æ•ˆæœ

2. **ç´¢å¼•ç­–ç•¥**:
   - å°è§„æ¨¡æ•°æ®ä½¿ç”¨IVFFlat
   - å¤§è§„æ¨¡æ•°æ®ä½¿ç”¨HNSW
   - åˆç†è®¾ç½®ç´¢å¼•å‚æ•°

3. **æŸ¥è¯¢ä¼˜åŒ–**:
   - å…ˆè¿‡æ»¤æ¡ä»¶ï¼Œå†å‘é‡æœç´¢
   - ä½¿ç”¨LIMITå‡å°‘è®¡ç®—
   - åˆç†ä½¿ç”¨ç‰©åŒ–è§†å›¾

4. **ç³»ç»Ÿè°ƒä¼˜**:
   - æ ¹æ®ç¡¬ä»¶é…ç½®å‚æ•°
   - ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
   - æŒç»­ä¼˜åŒ–è°ƒæ•´

5. **ç¡¬ä»¶é€‰å‹**:
   - ä¼˜å…ˆè€ƒè™‘å†…å­˜å®¹é‡
   - ä½¿ç”¨NVMe SSDå­˜å‚¨
   - æ ¹æ®åœºæ™¯é€‰æ‹©CPU

## ä¹ã€å…³è”ä¸»é¢˜

- [æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](../03-æ ¸å¿ƒèƒ½åŠ›/æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯.md) - è¯¦ç»†ä¼˜åŒ–æŠ€æœ¯
- [æ··åˆæŸ¥è¯¢èƒ½åŠ›](../03-æ ¸å¿ƒèƒ½åŠ›/æ··åˆæŸ¥è¯¢èƒ½åŠ›.md) - æ··åˆæŸ¥è¯¢ä¼˜åŒ–
- [æ¸è¿›å¼æ¼”è¿›è·¯çº¿](./æ¸è¿›å¼æ¼”è¿›è·¯çº¿.md) - å®æ–½è·¯å¾„

## åã€å¯¹æ ‡èµ„æº

### æŠ€æœ¯æ–‡æ¡£

- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://www.postgresql.org/docs/current/performance-tips.html)
- [pgvectoræ€§èƒ½ä¼˜åŒ–](https://github.com/pgvector/pgvector#performance)

### åŸºå‡†æµ‹è¯•

- [TPC Benchmarks](http://www.tpc.org/)
- [pgvectoråŸºå‡†æµ‹è¯•](https://github.com/pgvector/pgvector/tree/master/bench)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-02
