---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\07-å®æ–½è·¯å¾„\æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™

> **æ–‡æ¡£ç¼–å·**: AI-07-02
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 07-å®æ–½è·¯å¾„
> **å­ä¸»é¢˜**: 02-æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™

## ğŸ“‘ ç›®å½•

- [æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™](#æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ€§èƒ½è°ƒä¼˜æ¦‚è¿°](#1-æ€§èƒ½è°ƒä¼˜æ¦‚è¿°)
    - [1.1 æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾](#11-æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾)
  - [2. æ ¸å¿ƒåŸåˆ™](#2-æ ¸å¿ƒåŸåˆ™)
    - [2.1 æµ‹é‡ä¼˜å…ˆ](#21-æµ‹é‡ä¼˜å…ˆ)
    - [2.2 ç“¶é¢ˆè¯†åˆ«](#22-ç“¶é¢ˆè¯†åˆ«)
    - [2.3 æ¸è¿›ä¼˜åŒ–](#23-æ¸è¿›ä¼˜åŒ–)
  - [3. ç´¢å¼•ä¼˜åŒ–](#3-ç´¢å¼•ä¼˜åŒ–)
    - [3.1 ç´¢å¼•å‚æ•°è°ƒä¼˜](#31-ç´¢å¼•å‚æ•°è°ƒä¼˜)
    - [3.2 æŸ¥è¯¢å‚æ•°ä¼˜åŒ–](#32-æŸ¥è¯¢å‚æ•°ä¼˜åŒ–)
    - [3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–](#33-æ··åˆæŸ¥è¯¢ä¼˜åŒ–)
  - [4. æŸ¥è¯¢ä¼˜åŒ–](#4-æŸ¥è¯¢ä¼˜åŒ–)
    - [4.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#41-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
    - [4.2 ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–](#42-ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–)
    - [4.3 è¿æ¥ä¼˜åŒ–](#43-è¿æ¥ä¼˜åŒ–)
  - [5. ç³»ç»Ÿå‚æ•°ä¼˜åŒ–](#5-ç³»ç»Ÿå‚æ•°ä¼˜åŒ–)
    - [5.1 å†…å­˜å‚æ•°](#51-å†…å­˜å‚æ•°)
    - [5.2 å¹¶å‘å‚æ•°](#52-å¹¶å‘å‚æ•°)
    - [5.3 å‘é‡ä¸“ç”¨å‚æ•°](#53-å‘é‡ä¸“ç”¨å‚æ•°)
  - [6. ç¡¬ä»¶ä¼˜åŒ–](#6-ç¡¬ä»¶ä¼˜åŒ–)
    - [6.1 CPUä¼˜åŒ–](#61-cpuä¼˜åŒ–)
    - [6.2 å†…å­˜ä¼˜åŒ–](#62-å†…å­˜ä¼˜åŒ–)
    - [6.3 å­˜å‚¨ä¼˜åŒ–](#63-å­˜å‚¨ä¼˜åŒ–)
  - [7. ç›‘æ§ä¸è¯Šæ–­](#7-ç›‘æ§ä¸è¯Šæ–­)
    - [7.1 æ€§èƒ½ç›‘æ§](#71-æ€§èƒ½ç›‘æ§)
    - [7.2 ç“¶é¢ˆè¯Šæ–­](#72-ç“¶é¢ˆè¯Šæ–­)
    - [7.3 æŒç»­ä¼˜åŒ–](#73-æŒç»­ä¼˜åŒ–)

---

## 1. æ€§èƒ½è°ƒä¼˜æ¦‚è¿°

### 1.1 æ€§èƒ½è°ƒä¼˜æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™))
    æ ¸å¿ƒåŸåˆ™
      æµ‹é‡ä¼˜å…ˆ
        åŸºå‡†æµ‹è¯•
        æ€§èƒ½ç›‘æ§
        æŒ‡æ ‡æ”¶é›†
      ç“¶é¢ˆè¯†åˆ«
        CPUç“¶é¢ˆ
        å†…å­˜ç“¶é¢ˆ
        I/Oç“¶é¢ˆ
        ç½‘ç»œç“¶é¢ˆ
      æ¸è¿›ä¼˜åŒ–
        ä¸€æ¬¡ä¸€ä¸ªå˜æ›´
        A/Bæµ‹è¯•
        å›æ»šå‡†å¤‡
    ä¼˜åŒ–ç»´åº¦
      ç´¢å¼•ä¼˜åŒ–
        HNSWå‚æ•°
        IVFFlatå‚æ•°
        å¤åˆç´¢å¼•
      æŸ¥è¯¢ä¼˜åŒ–
        æŸ¥è¯¢è®¡åˆ’
        SQLé‡å†™
        ç»Ÿè®¡ä¿¡æ¯
      ç³»ç»Ÿä¼˜åŒ–
        å†…å­˜é…ç½®
        å¹¶å‘é…ç½®
        I/Oé…ç½®
    PostgreSQL 18ç‰¹æ€§
      å¼‚æ­¥I/O
        æ€§èƒ½æå‡3x
        io_uringæ”¯æŒ
      è·³è¿‡æ‰«æ
        å¤šåˆ—ç´¢å¼•ä¼˜åŒ–
      å¹¶è¡ŒGINæ„å»º
        ç´¢å¼•åˆ›å»ºåŠ é€Ÿ
```

---

## 2. æ ¸å¿ƒåŸåˆ™

### 2.1 æµ‹é‡ä¼˜å…ˆ

**é»„é‡‘æ³•åˆ™**ï¼š**æ°¸è¿œå…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–**

**æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼š

```sql
-- 1. åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE performance_test (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- 2. æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO performance_test (content, embedding)
SELECT
    'Test content ' || generate_series(1, 100000),
    (SELECT array_agg(random())::vector(1536) FROM generate_series(1, 1536))
FROM generate_series(1, 100000);

-- 3. åŸºå‡†æµ‹è¯•æŸ¥è¯¢
\timing on
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, content, embedding <=> query_vec AS distance
FROM performance_test
ORDER BY embedding <=> query_vec
LIMIT 10;
```

**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

```sql
-- 1. æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- 3. è¡¨è®¿é—®ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;
```

### 2.2 ç“¶é¢ˆè¯†åˆ«

**å¸¸è§ç“¶é¢ˆç±»å‹**ï¼š

| ç“¶é¢ˆç±»å‹ | ç—‡çŠ¶ | è¯Šæ–­æ–¹æ³• |
|---------|------|---------|
| **CPUç“¶é¢ˆ** | CPUä½¿ç”¨ç‡>80% | `top`, `htop`, `pg_stat_activity` |
| **å†…å­˜ç“¶é¢ˆ** | é¢‘ç¹swap | `free -h`, `vmstat` |
| **I/Oç“¶é¢ˆ** | ç£ç›˜I/Oç­‰å¾…é«˜ | `iostat`, `iotop` |
| **ç½‘ç»œç“¶é¢ˆ** | ç½‘ç»œå»¶è¿Ÿé«˜ | `ping`, `traceroute` |
| **é”ç«äº‰** | å¤§é‡ç­‰å¾…é” | `pg_locks`, `pg_stat_activity` |

**ç“¶é¢ˆè¯Šæ–­SQL**ï¼š

```sql
-- 1. è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    pid,
    now() - pg_stat_activity.query_start AS duration,
    query,
    state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes'
ORDER BY duration DESC;

-- 2. é”ç­‰å¾…åˆ†æ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 3. I/Oç»Ÿè®¡
SELECT
    datname,
    blks_read,
    blks_hit,
    round(100.0 * blks_hit / (blks_hit + blks_read), 2) AS cache_hit_ratio
FROM pg_stat_database
WHERE blks_read > 0;
```

### 2.3 æ¸è¿›ä¼˜åŒ–

**ä¼˜åŒ–æµç¨‹**ï¼š

```mermaid
graph LR
    A[æµ‹é‡åŸºå‡†] --> B[è¯†åˆ«ç“¶é¢ˆ]
    B --> C[åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ]
    C --> D[å®æ–½ä¼˜åŒ–]
    D --> E[æµ‹é‡æ•ˆæœ]
    E --> F{æ€§èƒ½æå‡?}
    F -->|æ˜¯| G[ä¿ç•™ä¼˜åŒ–]
    F -->|å¦| H[å›æ»šå˜æ›´]
    G --> I[ç»§ç»­ä¼˜åŒ–]
    H --> I
    I --> B
```

**ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

1. âœ… **å»ºç«‹åŸºå‡†**ï¼šè®°å½•ä¼˜åŒ–å‰çš„æ€§èƒ½æŒ‡æ ‡
2. âœ… **ä¸€æ¬¡ä¸€ä¸ªå˜æ›´**ï¼šé¿å…åŒæ—¶è¿›è¡Œå¤šä¸ªä¼˜åŒ–
3. âœ… **A/Bæµ‹è¯•**ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ•ˆæœ
4. âœ… **å‡†å¤‡å›æ»š**ï¼šç¡®ä¿å¯ä»¥å¿«é€Ÿå›æ»š
5. âœ… **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ä¼˜åŒ–è¿‡ç¨‹å’Œæ•ˆæœ

---

## 3. ç´¢å¼•ä¼˜åŒ–

### 3.1 ç´¢å¼•å‚æ•°è°ƒä¼˜

**HNSWç´¢å¼•å‚æ•°ä¼˜åŒ–**ï¼š

```sql
-- 1. åŸºç¡€HNSWç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. é«˜æ€§èƒ½HNSWç´¢å¼•ï¼ˆæŸ¥è¯¢ä¼˜å…ˆï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);

-- 3. å¿«é€Ÿæ„å»ºHNSWç´¢å¼•ï¼ˆæ„å»ºä¼˜å…ˆï¼‰
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- 4. æŸ¥è¯¢æ—¶è°ƒæ•´ef_search
SET hnsw.ef_search = 100;  -- é»˜è®¤40ï¼Œæé«˜å¬å›ç‡
```

**å‚æ•°é€‰æ‹©æŒ‡å—**ï¼š

| å‚æ•° | é»˜è®¤å€¼ | æ¨èèŒƒå›´ | è¯´æ˜ |
|------|--------|---------|------|
| **m** | 16 | 16-64 | æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼Œè¶Šå¤§ç´¢å¼•è¶Šå¤§ä½†æŸ¥è¯¢æ›´å¿« |
| **ef_construction** | 64 | 32-200 | æ„å»ºæ—¶çš„å€™é€‰æ•°ï¼Œè¶Šå¤§æ„å»ºè¶Šæ…¢ä½†è´¨é‡æ›´é«˜ |
| **ef_search** | 40 | 40-200 | æŸ¥è¯¢æ—¶çš„å€™é€‰æ•°ï¼Œè¶Šå¤§æŸ¥è¯¢è¶Šæ…¢ä½†å¬å›ç‡æ›´é«˜ |

**IVFFlatç´¢å¼•å‚æ•°ä¼˜åŒ–**ï¼š

```sql
-- 1. åŸºç¡€IVFFlatç´¢å¼•
CREATE INDEX ON documents
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 100);

-- 2. ä¼˜åŒ–listså‚æ•°
-- lists = sqrt(rows) / 1000 (æ¨è)
-- ä¾‹å¦‚ï¼š100ä¸‡è¡Œ -> lists = 1000
CREATE INDEX ON documents
USING ivfflat(embedding vector_cosine_ops)
WITH (lists = 1000);
```

### 3.2 æŸ¥è¯¢å‚æ•°ä¼˜åŒ–

**å‘é‡æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- 1. ä½¿ç”¨LIMITå‡å°‘è®¡ç®—é‡
SELECT id, content, embedding <=> query_vec AS distance
FROM documents
ORDER BY embedding <=> query_vec
LIMIT 10;  -- åªè¿”å›Top 10

-- 2. ä½¿ç”¨é˜ˆå€¼è¿‡æ»¤
SELECT id, content, embedding <=> query_vec AS distance
FROM documents
WHERE embedding <=> query_vec < 0.3  -- æå‰è¿‡æ»¤
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 3. è°ƒæ•´ef_searchå‚æ•°
SET LOCAL hnsw.ef_search = 100;
SELECT id, content, embedding <=> query_vec AS distance
FROM documents
ORDER BY embedding <=> query_vec
LIMIT 10;
```

**PostgreSQL 18è·³è¿‡æ‰«æä¼˜åŒ–**ï¼š

```sql
-- å¤šåˆ—ç´¢å¼•è·³è¿‡æ‰«æï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
CREATE INDEX idx_multi ON documents (category_id, status, embedding vector_cosine_ops);

-- å³ä½¿çœç•¥category_idï¼Œä»å¯ä½¿ç”¨ç´¢å¼•
SELECT id, content
FROM documents
WHERE status = 'active'
ORDER BY embedding <=> query_vec
LIMIT 10;
```

### 3.3 æ··åˆæŸ¥è¯¢ä¼˜åŒ–

**å‘é‡+SQLè¿‡æ»¤ä¼˜åŒ–**ï¼š

```sql
-- 1. å…ˆSQLè¿‡æ»¤ï¼Œå†å‘é‡æœç´¢ï¼ˆæ¨èï¼‰
WITH filtered AS (
    SELECT id, content, embedding
    FROM documents
    WHERE category_id = 1
      AND status = 'active'
      AND created_at > NOW() - INTERVAL '30 days'
    LIMIT 10000  -- é™åˆ¶å€™é€‰é›†
)
SELECT id, content, embedding <=> query_vec AS distance
FROM filtered
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 2. ä½¿ç”¨å¤åˆç´¢å¼•
CREATE INDEX ON documents (category_id, status, created_at, embedding vector_cosine_ops);
```

**å‘é‡+å…¨æ–‡æœç´¢ä¼˜åŒ–**ï¼š

```sql
-- 1. åˆ†åˆ«æŸ¥è¯¢ï¼Œç„¶åèåˆ
WITH vector_results AS (
    SELECT id, 1 - (embedding <=> query_vec) AS vector_score
    FROM documents
    WHERE embedding <=> query_vec < 0.3
    ORDER BY embedding <=> query_vec
    LIMIT 20
),
text_results AS (
    SELECT id, ts_rank(to_tsvector('english', content), query) AS text_score
    FROM documents
    WHERE to_tsvector('english', content) @@ query
    ORDER BY text_score DESC
    LIMIT 20
)
SELECT
    COALESCE(v.id, t.id) AS id,
    COALESCE(v.vector_score, 0) * 0.7 + COALESCE(t.text_score, 0) * 0.3 AS combined_score
FROM vector_results v
FULL OUTER JOIN text_results t ON v.id = t.id
ORDER BY combined_score DESC
LIMIT 10;
```

---

## 4. æŸ¥è¯¢ä¼˜åŒ–

### 4.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

**EXPLAIN (ANALYZE, BUFFERS, TIMING)è¯¦è§£**ï¼š

```sql
-- 1. åŸºç¡€æŸ¥è¯¢è®¡åˆ’
EXPLAIN SELECT * FROM documents WHERE embedding <=> query_vec < 0.3 LIMIT 10;

-- 2. è¯¦ç»†æŸ¥è¯¢è®¡åˆ’ï¼ˆæ¨èï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
SELECT id, content, embedding <=> query_vec AS distance
FROM documents
ORDER BY embedding <=> query_vec
LIMIT 10;

-- 3. JSONæ ¼å¼æŸ¥è¯¢è®¡åˆ’ï¼ˆä¾¿äºåˆ†æï¼‰
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON)
SELECT * FROM documents WHERE embedding <=> query_vec < 0.3 LIMIT 10;
```

**æŸ¥è¯¢è®¡åˆ’å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ä¼˜åŒ–ç›®æ ‡ |
|------|------|---------|
| **Execution Time** | æ‰§è¡Œæ—¶é—´ | <100ms |
| **Planning Time** | è®¡åˆ’æ—¶é—´ | <10ms |
| **Buffers: shared hit** | ç¼“å­˜å‘½ä¸­ | >90% |
| **Buffers: shared read** | ç£ç›˜è¯»å– | æœ€å°åŒ– |
| **Rows Removed by Filter** | è¿‡æ»¤è¡Œæ•° | æœ€å°åŒ– |

### 4.2 ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–

**å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•**ï¼š

```sql
-- 1. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents WHERE embedding <=> query_vec < 0.3 LIMIT 10;

-- 2. å¦‚æœæœªä½¿ç”¨ç´¢å¼•ï¼Œæ£€æŸ¥åŸå› 
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename = 'documents';

-- 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- 4. å¦‚æœä»ä¸ä½¿ç”¨ç´¢å¼•ï¼Œæ£€æŸ¥æŸ¥è¯¢æ¡ä»¶
-- ç¡®ä¿æŸ¥è¯¢æ¡ä»¶ä¸ç´¢å¼•åŒ¹é…
```

**éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- 1. åªå¯¹æ´»è·ƒæ•°æ®åˆ›å»ºç´¢å¼•
CREATE INDEX ON documents
USING hnsw(embedding vector_cosine_ops)
WHERE status = 'active' AND created_at > NOW() - INTERVAL '30 days';

-- 2. å‡å°‘ç´¢å¼•å¤§å°ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
```

### 4.3 è¿æ¥ä¼˜åŒ–

**è¿æ¥æ± é…ç½®ï¼ˆPgBouncerï¼‰**ï¼š

```ini
# pgbouncer.ini
[databases]
ai_db = host=localhost port=5432 dbname=ai_db

[pgbouncer]
pool_mode = transaction  # äº‹åŠ¡çº§è¿æ¥æ± 
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
```

**è¿æ¥æ•°ä¼˜åŒ–**ï¼š

```sql
-- 1. æ£€æŸ¥è¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity;

-- 2. æ£€æŸ¥è¿æ¥æ•°æŒ‰çŠ¶æ€
SELECT state, count(*)
FROM pg_stat_activity
GROUP BY state;

-- 3. é™åˆ¶è¿æ¥æ•°
ALTER SYSTEM SET max_connections = 200;
SELECT pg_reload_conf();
```

---

## 5. ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

### 5.1 å†…å­˜å‚æ•°

**PostgreSQL 18å†…å­˜é…ç½®**ï¼š

```conf
# postgresql.conf

# å…±äº«å†…å­˜ï¼ˆ25% of RAMï¼‰
shared_buffers = 8GB

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆ75% of RAMï¼‰
effective_cache_size = 24GB

# å·¥ä½œå†…å­˜ï¼ˆç”¨äºæ’åºå’Œå“ˆå¸Œï¼‰
work_mem = 64MB

# ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç”¨äºVACUUMç­‰ï¼‰
maintenance_work_mem = 1GB

# WALç¼“å†²åŒºï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
wal_buffers = 16MB
```

**å†…å­˜å‚æ•°è®¡ç®—**ï¼š

```bash
# 1. è·å–ç³»ç»Ÿå†…å­˜
free -h

# 2. è®¡ç®—æ¨èé…ç½®
# shared_buffers = RAM * 0.25
# effective_cache_size = RAM * 0.75
# work_mem = (RAM - shared_buffers) / (max_connections * 2)
```

### 5.2 å¹¶å‘å‚æ•°

**å¹¶å‘é…ç½®**ï¼š

```conf
# postgresql.conf

# æœ€å¤§è¿æ¥æ•°
max_connections = 200

# å¹¶è¡Œå·¥ä½œè¿›ç¨‹
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4  # PostgreSQL 18ï¼šæ”¯æŒGINå¹¶è¡Œæ„å»º

# å¹¶è¡ŒæŸ¥è¯¢é˜ˆå€¼
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512KB
```

### 5.3 å‘é‡ä¸“ç”¨å‚æ•°

**å‘é‡æŸ¥è¯¢ä¼˜åŒ–å‚æ•°**ï¼š

```sql
-- 1. HNSWæŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- æé«˜å¬å›ç‡

-- 2. å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–
-- PostgreSQL 18å¼‚æ­¥I/Oå¯ä»¥åŠ é€Ÿå‘é‡è®¡ç®—
ALTER SYSTEM SET io_method = 'io_uring';  -- Linux only
```

---

## 6. ç¡¬ä»¶ä¼˜åŒ–

### 6.1 CPUä¼˜åŒ–

**CPUé…ç½®**ï¼š

```bash
# 1. æ£€æŸ¥CPUä¿¡æ¯
lscpu

# 2. CPUäº²å’Œæ€§è®¾ç½®ï¼ˆPostgreSQL 18æ”¯æŒï¼‰
# ç»‘å®šPostgreSQLè¿›ç¨‹åˆ°ç‰¹å®šCPUæ ¸å¿ƒ
taskset -c 0-7 /usr/bin/postgres

# 3. CPUé¢‘ç‡ä¼˜åŒ–
# è®¾ç½®ä¸ºæ€§èƒ½æ¨¡å¼
sudo cpupower frequency-set -g performance
```

**PostgreSQL 18ç¡¬ä»¶åŠ é€Ÿ**ï¼š

```sql
-- ARM NEONå’ŒSVEæ”¯æŒï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
-- è‡ªåŠ¨å¯ç”¨ï¼Œæ— éœ€é…ç½®
-- ä¼˜åŒ–popcountç­‰å‡½æ•°æ€§èƒ½
```

### 6.2 å†…å­˜ä¼˜åŒ–

**å†…å­˜é…ç½®**ï¼š

```bash
# 1. æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# 2. ç¦ç”¨swapï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
sudo swapoff -a

# 3. é…ç½®é€æ˜å¤§é¡µï¼ˆTHPï¼‰
echo never > /sys/kernel/mm/transparent_hugepage/enabled
```

**NUMAä¼˜åŒ–**ï¼š

```bash
# 1. æ£€æŸ¥NUMAé…ç½®
numactl --hardware

# 2. ç»‘å®šPostgreSQLåˆ°ç‰¹å®šNUMAèŠ‚ç‚¹
numactl --cpunodebind=0 --membind=0 /usr/bin/postgres
```

### 6.3 å­˜å‚¨ä¼˜åŒ–

**PostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–**ï¼š

```conf
# postgresql.conf
# PostgreSQL 18æ–°ç‰¹æ€§ï¼šå¼‚æ­¥I/Oå­ç³»ç»Ÿ
io_method = 'io_uring'  # Linux onlyï¼Œæ€§èƒ½æå‡3x

# å¦‚æœio_uringä¸å¯ç”¨ï¼Œä½¿ç”¨worker-basedå®ç°
# io_method = 'worker'  # æ‰€æœ‰å¹³å°æ”¯æŒ
```

**å­˜å‚¨é…ç½®**ï¼š

```bash
# 1. ä½¿ç”¨NVMe SSDï¼ˆæ¨èï¼‰
# 2. é…ç½®I/Oè°ƒåº¦å™¨
echo deadline > /sys/block/nvme0n1/queue/scheduler

# 3. æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–ï¼ˆext4ï¼‰
# mounté€‰é¡¹ï¼šnoatime,data=writeback
mount -o noatime,data=writeback /dev/nvme0n1 /var/lib/postgresql
```

---

## 7. ç›‘æ§ä¸è¯Šæ–­

### 7.1 æ€§èƒ½ç›‘æ§

**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

```sql
-- 1. æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆpg_stat_statementsï¼‰
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
WHERE query LIKE '%embedding%'
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. è¡¨è®¿é—®ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;

-- 3. ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

**Prometheusç›‘æ§**ï¼š

```yaml
# postgres_exporteré…ç½®
- name: pg_stat_statements
  help: PostgreSQL query statistics
  values:
    - total_exec_time
    - mean_exec_time
    - calls
```

### 7.2 ç“¶é¢ˆè¯Šæ–­

**è¯Šæ–­å·¥å…·**ï¼š

```sql
-- 1. å½“å‰æ´»åŠ¨æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    wait_event_type,
    wait_event,
    query_start,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY duration DESC;

-- 2. é”ç­‰å¾…åˆ†æ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 3. I/Oç»Ÿè®¡
SELECT
    datname,
    blks_read,
    blks_hit,
    round(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio
FROM pg_stat_database
WHERE datname = current_database();
```

### 7.3 æŒç»­ä¼˜åŒ–

**ä¼˜åŒ–æµç¨‹**ï¼š

```mermaid
graph TD
    A[å»ºç«‹æ€§èƒ½åŸºå‡†] --> B[æŒç»­ç›‘æ§]
    B --> C{å‘ç°æ€§èƒ½é—®é¢˜?}
    C -->|æ˜¯| D[åˆ†æç“¶é¢ˆ]
    C -->|å¦| B
    D --> E[åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ]
    E --> F[å®æ–½ä¼˜åŒ–]
    F --> G[æµ‹é‡æ•ˆæœ]
    G --> H{æ€§èƒ½æå‡?}
    H -->|æ˜¯| I[ä¿ç•™ä¼˜åŒ–]
    H -->|å¦| J[å›æ»šå˜æ›´]
    I --> B
    J --> B
```

**ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

1. âœ… **å®šæœŸæ€§èƒ½å®¡æŸ¥**ï¼šæ¯å‘¨/æ¯æœˆå®¡æŸ¥æ€§èƒ½æŒ‡æ ‡
2. âœ… **æ…¢æŸ¥è¯¢åˆ†æ**ï¼šè¯†åˆ«å¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢
3. âœ… **ç´¢å¼•ç»´æŠ¤**ï¼šå®šæœŸé‡å»ºç´¢å¼•ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
4. âœ… **å®¹é‡è§„åˆ’**ï¼šé¢„æµ‹æœªæ¥æ€§èƒ½éœ€æ±‚
5. âœ… **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ä¼˜åŒ–è¿‡ç¨‹å’Œæ•ˆæœ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-02
