---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\07-å®æ–½è·¯å¾„\æˆæœ¬ä¼˜åŒ–æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æˆæœ¬ä¼˜åŒ–æŒ‡å—

> **æ–‡æ¡£ç¼–å·**: AI-07-05
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 07-å®æ–½è·¯å¾„
> **å­ä¸»é¢˜**: 05-æˆæœ¬ä¼˜åŒ–æŒ‡å—

## ğŸ“‘ ç›®å½•

- [æˆæœ¬ä¼˜åŒ–æŒ‡å—](#æˆæœ¬ä¼˜åŒ–æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æˆæœ¬ä¼˜åŒ–æ¦‚è¿°](#1-æˆæœ¬ä¼˜åŒ–æ¦‚è¿°)
  - [2. æˆæœ¬åˆ†æ](#2-æˆæœ¬åˆ†æ)
    - [2.1 åŸºç¡€è®¾æ–½æˆæœ¬](#21-åŸºç¡€è®¾æ–½æˆæœ¬)
    - [2.2 å¼€å‘æˆæœ¬](#22-å¼€å‘æˆæœ¬)
    - [2.3 è¿ç»´æˆæœ¬](#23-è¿ç»´æˆæœ¬)
    - [2.4 APIè°ƒç”¨æˆæœ¬](#24-apiè°ƒç”¨æˆæœ¬)
  - [3. åŸºç¡€è®¾æ–½æˆæœ¬ä¼˜åŒ–](#3-åŸºç¡€è®¾æ–½æˆæœ¬ä¼˜åŒ–)
    - [3.1 Serverlessæ–¹æ¡ˆ](#31-serverlessæ–¹æ¡ˆ)
    - [3.2 èµ„æºè°ƒåº¦ä¼˜åŒ–](#32-èµ„æºè°ƒåº¦ä¼˜åŒ–)
    - [3.3 å­˜å‚¨ä¼˜åŒ–](#33-å­˜å‚¨ä¼˜åŒ–)
  - [4. å¼€å‘æˆæœ¬ä¼˜åŒ–](#4-å¼€å‘æˆæœ¬ä¼˜åŒ–)
    - [4.1 è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨](#41-è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨)
    - [4.2 ä»£ç å¤ç”¨](#42-ä»£ç å¤ç”¨)
    - [4.3 å¼€å‘æ•ˆç‡æå‡](#43-å¼€å‘æ•ˆç‡æå‡)
  - [5. è¿ç»´æˆæœ¬ä¼˜åŒ–](#5-è¿ç»´æˆæœ¬ä¼˜åŒ–)
    - [5.1 è‡ªåŠ¨åŒ–è¿ç»´](#51-è‡ªåŠ¨åŒ–è¿ç»´)
    - [5.2 ç›‘æ§å‘Šè­¦](#52-ç›‘æ§å‘Šè­¦)
    - [5.3 æ•…éšœè‡ªæ„ˆ](#53-æ•…éšœè‡ªæ„ˆ)
  - [6. APIè°ƒç”¨æˆæœ¬ä¼˜åŒ–](#6-apiè°ƒç”¨æˆæœ¬ä¼˜åŒ–)
    - [6.1 ç¼“å­˜ç­–ç•¥](#61-ç¼“å­˜ç­–ç•¥)
    - [6.2 æ‰¹é‡å¤„ç†](#62-æ‰¹é‡å¤„ç†)
    - [6.3 æ¨¡å‹é€‰æ‹©](#63-æ¨¡å‹é€‰æ‹©)
  - [7. æˆæœ¬è¿½è¸ªä¸åˆ†æ](#7-æˆæœ¬è¿½è¸ªä¸åˆ†æ)
    - [7.1 æˆæœ¬è¿½è¸ª](#71-æˆæœ¬è¿½è¸ª)
    - [7.2 æˆæœ¬å‘Šè­¦](#72-æˆæœ¬å‘Šè­¦)
    - [7.3 æˆæœ¬åˆ†æ](#73-æˆæœ¬åˆ†æ)

---

## 1. æˆæœ¬ä¼˜åŒ–æ¦‚è¿°

**æˆæœ¬æ„æˆ**ï¼š

```mermaid
pie title PostgreSQL AIç³»ç»Ÿæˆæœ¬æ„æˆ
    "åŸºç¡€è®¾æ–½" : 40
    "å¼€å‘æˆæœ¬" : 25
    "è¿ç»´æˆæœ¬" : 20
    "APIè°ƒç”¨" : 15
```

**ä¼˜åŒ–ç›®æ ‡**ï¼š

- âœ… åŸºç¡€è®¾æ–½æˆæœ¬é™ä½40-60%
- âœ… å¼€å‘æˆæœ¬é™ä½30-50%
- âœ… è¿ç»´æˆæœ¬é™ä½50-70%
- âœ… APIè°ƒç”¨æˆæœ¬é™ä½60-80%

---

## 2. æˆæœ¬åˆ†æ

### 2.1 åŸºç¡€è®¾æ–½æˆæœ¬

**æˆæœ¬æ„æˆ**ï¼š

| æˆæœ¬é¡¹ | å æ¯” | ä¼˜åŒ–ç©ºé—´ |
|-------|------|---------|
| **è®¡ç®—èµ„æº** | 50% | 40-60% |
| **å­˜å‚¨èµ„æº** | 30% | 30-50% |
| **ç½‘ç»œå¸¦å®½** | 15% | 20-40% |
| **å…¶ä»–** | 5% | 10-20% |

**æˆæœ¬ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **ä½¿ç”¨Serverlessæ–¹æ¡ˆ**ï¼š
   - Neonã€Supabaseç­‰Serverless PostgreSQL
   - æŒ‰éœ€ä»˜è´¹ï¼ŒScale-to-Zero
   - æˆæœ¬é™ä½60-90%

2. **èµ„æºè‡ªåŠ¨æ‰©ç¼©å®¹**ï¼š

   ```yaml
   # Kubernetes HPAé…ç½®
   apiVersion: autoscaling/v2
   kind: HorizontalPodAutoscaler
   metadata:
     name: postgres-hpa
   spec:
     scaleTargetRef:
       apiVersion: apps/v1
       kind: StatefulSet
       name: postgres
     minReplicas: 1
     maxReplicas: 10
     metrics:
     - type: Resource
       resource:
         name: cpu
         target:
           type: Utilization
           averageUtilization: 70
   ```

3. **å­˜å‚¨åˆ†å±‚**ï¼š
   - çƒ­æ•°æ®ï¼šNVMe SSD
   - æ¸©æ•°æ®ï¼šæ ‡å‡†SSD
   - å†·æ•°æ®ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰

### 2.2 å¼€å‘æˆæœ¬

**æˆæœ¬æ„æˆ**ï¼š

| æˆæœ¬é¡¹ | å æ¯” | ä¼˜åŒ–ç©ºé—´ |
|-------|------|---------|
| **äººåŠ›æˆæœ¬** | 70% | 30-50% |
| **å·¥å…·æˆæœ¬** | 20% | 40-60% |
| **åŸ¹è®­æˆæœ¬** | 10% | 20-30% |

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **ä½¿ç”¨PostgreSQLåŸç”ŸAIèƒ½åŠ›**ï¼š
   - pgvectorï¼šæ— éœ€é¢å¤–å‘é‡æ•°æ®åº“
   - pg_aiï¼šæ— éœ€å¤–éƒ¨AIæœåŠ¡é›†æˆ
   - PostgresMLï¼šæ•°æ®åº“å†…æœºå™¨å­¦ä¹ 
   - **æˆæœ¬é™ä½**ï¼šå‡å°‘ç³»ç»Ÿå¤æ‚åº¦ï¼Œé™ä½å¼€å‘æ—¶é—´50%+

2. **ä»£ç å¤ç”¨**ï¼š

   ```sql
   -- åˆ›å»ºé€šç”¨å‘é‡æœç´¢å‡½æ•°
   CREATE OR REPLACE FUNCTION vector_search(
       p_query_vec vector(1536),
       p_limit INT DEFAULT 10,
       p_threshold FLOAT DEFAULT 0.3
   )
   RETURNS TABLE(id INT, content TEXT, similarity FLOAT) AS $$
   BEGIN
       RETURN QUERY
       SELECT d.id, d.content, 1 - (d.embedding <=> p_query_vec) AS similarity
       FROM documents d
       WHERE d.embedding <=> p_query_vec < p_threshold
       ORDER BY d.embedding <=> p_query_vec
       LIMIT p_limit;
   END;
   $$ LANGUAGE plpgsql;

   -- æ€§èƒ½æµ‹è¯•ï¼šå‘é‡æœç´¢å‡½æ•°æŸ¥è¯¢
   EXPLAIN (ANALYZE, BUFFERS, TIMING)
   SELECT * FROM vector_search(
       '[0.1, 0.2, ..., 0.1536]'::vector(1536),
       10,
       0.3
   );
   $$ LANGUAGE plpgsql;
   ```

3. **è‡ªåŠ¨åŒ–å·¥å…·**ï¼š
   - pg_ai Vectorizerï¼šè‡ªåŠ¨å‘é‡åŒ–
   - è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šå‡å°‘äººå·¥æµ‹è¯•æ—¶é—´
   - CI/CDï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²

### 2.3 è¿ç»´æˆæœ¬

**æˆæœ¬æ„æˆ**ï¼š

| æˆæœ¬é¡¹ | å æ¯” | ä¼˜åŒ–ç©ºé—´ |
|-------|------|---------|
| **äººåŠ›æˆæœ¬** | 60% | 50-70% |
| **ç›‘æ§å·¥å…·** | 25% | 30-50% |
| **å¤‡ä»½å­˜å‚¨** | 15% | 40-60% |

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **è‡ªåŠ¨åŒ–è¿ç»´**ï¼š

   ```bash
   # è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
   #!/bin/bash
   BACKUP_DIR="/backup/postgresql"
   DATE=$(date +%Y%m%d_%H%M%S)

   # è‡ªåŠ¨å¤‡ä»½
   pg_dump -Fc -f $BACKUP_DIR/backup_$DATE.dump ai_db

   # è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„å¤‡ä»½
   find $BACKUP_DIR -name "*.dump" -mtime +7 -delete

   # è‡ªåŠ¨ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
   aws s3 cp $BACKUP_DIR/backup_$DATE.dump s3://backup-bucket/
   ```

2. **ç›‘æ§å‘Šè­¦è‡ªåŠ¨åŒ–**ï¼š

   ```yaml
   # Prometheuså‘Šè­¦è§„åˆ™
   groups:
     - name: cost_alerts
       rules:
         - alert: HighDatabaseCost
           expr: database_cost_per_hour > 10
           for: 1h
           annotations:
             summary: "Database cost exceeds threshold"
   ```

3. **æ•…éšœè‡ªæ„ˆ**ï¼š
   - è‡ªåŠ¨é‡å¯å¤±è´¥æœåŠ¡
   - è‡ªåŠ¨æ•…éšœè½¬ç§»
   - è‡ªåŠ¨æ‰©å®¹

### 2.4 APIè°ƒç”¨æˆæœ¬

**æˆæœ¬æ„æˆ**ï¼š

| APIç±»å‹ | æˆæœ¬/1000æ¬¡ | ä¼˜åŒ–ç©ºé—´ |
|---------|------------|---------|
| **OpenAI Embedding** | $0.02 | 60-80% |
| **OpenAI Chat** | $0.10-2.00 | 50-70% |
| **å…¶ä»–AI API** | å˜åŒ– | 40-60% |

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **ç¼“å­˜Embeddingç»“æœ**ï¼š

   ```sql
   -- ç¼“å­˜å·²ç”Ÿæˆçš„Embedding
   CREATE TABLE embedding_cache (
       text_hash TEXT PRIMARY KEY,
       embedding vector(1536),
       created_at TIMESTAMPTZ DEFAULT NOW()
   );

   CREATE OR REPLACE FUNCTION get_embedding(p_text TEXT)
   RETURNS vector(1536) AS $$
   DECLARE
       v_hash TEXT;
       v_embedding vector(1536);
   BEGIN
       v_hash = md5(p_text);

       -- æ£€æŸ¥ç¼“å­˜
       SELECT embedding INTO v_embedding
       FROM embedding_cache
       WHERE text_hash = v_hash;

       IF v_embedding IS NULL THEN
           -- è°ƒç”¨APIç”ŸæˆEmbedding
           SELECT ai.embedding_openai('text-embedding-3-small', p_text)
           INTO v_embedding;

           -- å­˜å…¥ç¼“å­˜
           INSERT INTO embedding_cache (text_hash, embedding)
           VALUES (v_hash, v_embedding);
       END IF;

       RETURN v_embedding;
   END;
   $$ LANGUAGE plpgsql;
   ```

2. **æ‰¹é‡å¤„ç†**ï¼š

   ```sql
   -- æ‰¹é‡ç”ŸæˆEmbeddingï¼ˆpg_ai Vectorizerï¼‰
   SELECT ai.create_vectorizer(
       'documents'::regclass,
       destination => 'document_embeddings',
       embedding => ai.embedding_openai('text-embedding-3-small', 'content'),
       chunking => ai.chunking_recursive_character_text_splitter('content')
   );
   ```

3. **æ¨¡å‹é€‰æ‹©ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹ï¼ˆtext-embedding-3-small vs text-embedding-3-largeï¼‰
   - æˆæœ¬é™ä½75%ï¼Œæ€§èƒ½æŸå¤±<5%

---

## 3. åŸºç¡€è®¾æ–½æˆæœ¬ä¼˜åŒ–

### 3.1 Serverlessæ–¹æ¡ˆ

**Serverlessæ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æˆæœ¬/æœˆï¼ˆ100GBæ•°æ®ï¼‰ | ç‰¹ç‚¹ |
|------|-------------------|------|
| **Neon** | $50-200 | Scale-to-Zeroï¼ŒæŒ‰éœ€ä»˜è´¹ |
| **Supabase** | $25-100 | å…¨æ ˆå¹³å°ï¼Œå…è´¹é¢åº¦ |
| **AWS RDS Serverless** | $100-300 | AWSç”Ÿæ€ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹ |
| **è‡ªå»ºPostgreSQL** | $500-1000 | å›ºå®šæˆæœ¬ï¼Œéœ€è¦è¿ç»´ |

**Neonæˆæœ¬ä¼˜åŒ–**ï¼š

```bash
# 1. ä½¿ç”¨æ•°æ®åº“åˆ†æ”¯ï¼ˆå…è´¹ï¼‰
neonctl branches create --name dev

# 2. é…ç½®è‡ªåŠ¨åœæ­¢
ALTER BRANCH SET auto_suspend_seconds = 300;  # 5åˆ†é’Ÿæ— è¯·æ±‚è‡ªåŠ¨åœæ­¢

# 3. ç›‘æ§æˆæœ¬
neonctl projects list
```

### 3.2 èµ„æºè°ƒåº¦ä¼˜åŒ–

**Kubernetesèµ„æºä¼˜åŒ–**ï¼š

```yaml
# èµ„æºè¯·æ±‚å’Œé™åˆ¶
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      containers:
      - name: postgres
        resources:
          requests:
            cpu: "2"
            memory: "8Gi"
          limits:
            cpu: "4"
            memory: "16Gi"
```

**è‡ªåŠ¨æ‰©ç¼©å®¹**ï¼š

```yaml
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 3.3 å­˜å‚¨ä¼˜åŒ–

**å­˜å‚¨åˆ†å±‚ç­–ç•¥**ï¼š

```sql
-- 1. çƒ­æ•°æ®ï¼šNVMe SSDï¼ˆä¸»è¡¨ï¼‰
CREATE TABLE documents_hot (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536),
    created_at TIMESTAMPTZ DEFAULT NOW()
) TABLESPACE fast_ssd;

-- 2. æ¸©æ•°æ®ï¼šæ ‡å‡†SSDï¼ˆå½’æ¡£è¡¨ï¼‰
CREATE TABLE documents_warm (
    LIKE documents_hot INCLUDING ALL
) TABLESPACE standard_ssd;

-- 3. å†·æ•°æ®ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆå¤–éƒ¨è¡¨ï¼‰
CREATE FOREIGN TABLE documents_cold (
    id INT,
    content TEXT,
    embedding vector(1536),
    created_at TIMESTAMPTZ
) SERVER s3_server
OPTIONS (bucket 'cold-data');
```

**æ•°æ®å‹ç¼©**ï¼š

```sql
-- PostgreSQL 18 WALå‹ç¼©
ALTER SYSTEM SET wal_compression = lz4;

-- è¡¨å‹ç¼©ï¼ˆTOASTï¼‰
ALTER TABLE documents SET (
    toast_tuple_target = 128
);
```

---

## 4. å¼€å‘æˆæœ¬ä¼˜åŒ–

### 4.1 è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨

**pg_ai Vectorizerè‡ªåŠ¨åŒ–**ï¼š

```sql
-- è‡ªåŠ¨å‘é‡åŒ–ï¼Œæ— éœ€ç¼–å†™ä»£ç 
SELECT ai.create_vectorizer(
    'documents'::regclass,
    destination => 'document_embeddings',
    embedding => ai.embedding_openai('text-embedding-3-small', 'content'),
    chunking => ai.chunking_recursive_character_text_splitter('content')
);

-- æ’å…¥æ•°æ®æ—¶è‡ªåŠ¨ç”Ÿæˆå‘é‡
INSERT INTO documents (content) VALUES ('New document');
-- è‡ªåŠ¨ç”Ÿæˆembeddingåˆ°document_embeddingsè¡¨
```

**CI/CDè‡ªåŠ¨åŒ–**ï¼š

```yaml
# .github/workflows/deploy.yml
name: Deploy PostgreSQL
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy migrations
        run: |
          psql $DATABASE_URL -f migrations/001_init.sql
```

### 4.2 ä»£ç å¤ç”¨

**é€šç”¨å‡½æ•°åº“**ï¼š

```sql
-- 1. å‘é‡æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION vector_search(
    p_query_vec vector(1536),
    p_table_name TEXT,
    p_limit INT DEFAULT 10
)
RETURNS TABLE(id INT, similarity FLOAT) AS $$
BEGIN
    RETURN QUERY
    EXECUTE format('
        SELECT id, 1 - (embedding <=> $1) AS similarity
        FROM %I
        ORDER BY embedding <=> $1
        LIMIT $2
    ', p_table_name) USING p_query_vec, p_limit;
END;
$$ LANGUAGE plpgsql;

-- 2. RAGæ£€ç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION rag_retrieve(
    p_query TEXT,
    p_limit INT DEFAULT 5
)
RETURNS TABLE(content TEXT, similarity FLOAT) AS $$
DECLARE
    v_query_vec vector(1536);
BEGIN
    -- ç”ŸæˆæŸ¥è¯¢å‘é‡
    SELECT ai.embedding_openai('text-embedding-3-small', p_query)
    INTO v_query_vec;

    -- æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£
    RETURN QUERY
    SELECT dc.chunk_text, 1 - (dc.embedding <=> v_query_vec) AS similarity
    FROM document_chunks dc
    ORDER BY dc.embedding <=> v_query_vec
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### 4.3 å¼€å‘æ•ˆç‡æå‡

**å¼€å‘å·¥å…·**ï¼š

1. **pgAdmin / DBeaver**ï¼šå¯è§†åŒ–æ•°æ®åº“ç®¡ç†
2. **PostgreSQL Extensions**ï¼šä¸°å¯Œçš„æ‰©å±•ç”Ÿæ€
3. **æ–‡æ¡£ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£

**å¼€å‘æœ€ä½³å®è·µ**ï¼š

- âœ… ä½¿ç”¨PostgreSQLåŸç”ŸåŠŸèƒ½ï¼Œå‡å°‘å¤–éƒ¨ä¾èµ–
- âœ… ä»£ç å¤ç”¨ï¼Œé¿å…é‡å¤å¼€å‘
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå‡å°‘bugä¿®å¤æ—¶é—´

---

## 5. è¿ç»´æˆæœ¬ä¼˜åŒ–

### 5.1 è‡ªåŠ¨åŒ–è¿ç»´

**è‡ªåŠ¨åŒ–å¤‡ä»½**ï¼š

```bash
#!/bin/bash
# auto_backup.sh

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# å¤‡ä»½
pg_dump -Fc -f $BACKUP_DIR/backup_$DATE.dump ai_db

# æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -name "*.dump" -mtime +$RETENTION_DAYS -delete

# ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
aws s3 cp $BACKUP_DIR/backup_$DATE.dump s3://backup-bucket/
```

**è‡ªåŠ¨åŒ–ç›‘æ§**ï¼š

```yaml
# Prometheus + Grafana
# è‡ªåŠ¨ç›‘æ§å…³é”®æŒ‡æ ‡
# è‡ªåŠ¨å‘Šè­¦
# è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
```

### 5.2 ç›‘æ§å‘Šè­¦

**æˆæœ¬ç›‘æ§**ï¼š

```sql
-- 1. æ•°æ®åº“å¤§å°ç›‘æ§
SELECT
    pg_size_pretty(pg_database_size('ai_db')) AS database_size;

-- 2. è¡¨å¤§å°ç›‘æ§
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 3. ç´¢å¼•å¤§å°ç›‘æ§
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 5.3 æ•…éšœè‡ªæ„ˆ

**è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼š

```yaml
# Patroniè‡ªåŠ¨æ•…éšœè½¬ç§»
# ä¸»åº“æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä»åº“
# æ— éœ€äººå·¥å¹²é¢„
```

**è‡ªåŠ¨æ‰©å®¹**ï¼š

```yaml
# Kubernetesè‡ªåŠ¨æ‰©å®¹
# æ ¹æ®è´Ÿè½½è‡ªåŠ¨å¢åŠ /å‡å°‘å®ä¾‹
# é™ä½æˆæœ¬
```

---

## 6. APIè°ƒç”¨æˆæœ¬ä¼˜åŒ–

### 6.1 ç¼“å­˜ç­–ç•¥

**Embeddingç¼“å­˜**ï¼š

```sql
-- åˆ›å»ºç¼“å­˜è¡¨
CREATE TABLE embedding_cache (
    text_hash TEXT PRIMARY KEY,
    embedding vector(1536),
    model_name TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç¼“å­˜å‡½æ•°
CREATE OR REPLACE FUNCTION get_cached_embedding(
    p_text TEXT,
    p_model TEXT DEFAULT 'text-embedding-3-small'
)
RETURNS vector(1536) AS $$
DECLARE
    v_hash TEXT;
    v_embedding vector(1536);
BEGIN
    v_hash = md5(p_text || p_model);

    -- æ£€æŸ¥ç¼“å­˜
    SELECT embedding INTO v_embedding
    FROM embedding_cache
    WHERE text_hash = v_hash;

    IF v_embedding IS NULL THEN
        -- è°ƒç”¨API
        SELECT ai.embedding_openai(p_model, p_text)
        INTO v_embedding;

        -- å­˜å…¥ç¼“å­˜
        INSERT INTO embedding_cache (text_hash, embedding, model_name)
        VALUES (v_hash, v_embedding, p_model);
    END IF;

    RETURN v_embedding;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 æ‰¹é‡å¤„ç†

**æ‰¹é‡Embeddingç”Ÿæˆ**ï¼š

```sql
-- ä½¿ç”¨pg_ai Vectorizeræ‰¹é‡å¤„ç†
SELECT ai.create_vectorizer(
    'documents'::regclass,
    destination => 'document_embeddings',
    embedding => ai.embedding_openai('text-embedding-3-small', 'content'),
    chunking => NULL
);

-- æ‰¹é‡æ’å…¥æ—¶è‡ªåŠ¨ç”Ÿæˆå‘é‡
INSERT INTO documents (content)
SELECT 'Document ' || generate_series(1, 1000);
-- è‡ªåŠ¨ç”Ÿæˆ1000ä¸ªEmbedding
```

### 6.3 æ¨¡å‹é€‰æ‹©

**æ¨¡å‹æˆæœ¬å¯¹æ¯”**ï¼š

| æ¨¡å‹ | æˆæœ¬/1M tokens | æ€§èƒ½ | æ¨èåœºæ™¯ |
|------|---------------|------|---------|
| **text-embedding-3-small** | $0.02 | 95% | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ |
| **text-embedding-3-large** | $0.13 | 100% | é«˜ç²¾åº¦éœ€æ±‚ |
| **text-embedding-ada-002** | $0.10 | 90% | æ—§ç‰ˆæœ¬å…¼å®¹ |

**ä¼˜åŒ–å»ºè®®**ï¼š

- âœ… ä½¿ç”¨text-embedding-3-smallï¼ˆæˆæœ¬é™ä½75%ï¼‰
- âœ… æ‰¹é‡å¤„ç†ï¼ˆæˆæœ¬é™ä½50%ï¼‰
- âœ… ç¼“å­˜ç»“æœï¼ˆæˆæœ¬é™ä½80%+ï¼‰

---

## 7. æˆæœ¬è¿½è¸ªä¸åˆ†æ

### 7.1 æˆæœ¬è¿½è¸ª

**æˆæœ¬è¿½è¸ªè¡¨**ï¼š

```sql
CREATE TABLE cost_tracking (
    id SERIAL PRIMARY KEY,
    cost_type TEXT NOT NULL,  -- 'infrastructure', 'development', 'api'
    cost_item TEXT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    unit TEXT NOT NULL,  -- 'USD', 'hours', 'calls'
    date DATE NOT NULL,
    metadata JSONB
);

-- è®°å½•APIè°ƒç”¨æˆæœ¬
INSERT INTO cost_tracking (cost_type, cost_item, amount, unit, date)
VALUES (
    'api',
    'openai_embedding',
    10.50,
    'USD',
    CURRENT_DATE
);
```

### 7.2 æˆæœ¬å‘Šè­¦

**æˆæœ¬å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦
groups:
  - name: cost_alerts
    rules:
      - alert: HighAPICost
        expr: api_cost_per_day > 100
        for: 1h
        annotations:
          summary: "API cost exceeds $100/day"

      - alert: HighInfrastructureCost
        expr: infrastructure_cost_per_month > 1000
        for: 24h
        annotations:
          summary: "Infrastructure cost exceeds $1000/month"
```

### 7.3 æˆæœ¬åˆ†æ

**æˆæœ¬åˆ†ææŸ¥è¯¢**ï¼š

```sql
-- 1. æŒ‰ç±»å‹ç»Ÿè®¡æˆæœ¬
SELECT
    cost_type,
    SUM(amount) AS total_cost,
    AVG(amount) AS avg_cost
FROM cost_tracking
WHERE date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY cost_type;

-- 2. æˆæœ¬è¶‹åŠ¿åˆ†æ
SELECT
    date,
    cost_type,
    SUM(amount) AS daily_cost
FROM cost_tracking
WHERE date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY date, cost_type
ORDER BY date DESC;

-- 3. æˆæœ¬ä¼˜åŒ–å»ºè®®
SELECT
    cost_type,
    cost_item,
    SUM(amount) AS total_cost,
    CASE
        WHEN cost_type = 'api' AND cost_item LIKE '%embedding%' THEN 'Consider caching'
        WHEN cost_type = 'infrastructure' AND amount > 500 THEN 'Consider Serverless'
        ELSE 'Review optimization opportunities'
    END AS recommendation
FROM cost_tracking
WHERE date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY cost_type, cost_item
ORDER BY total_cost DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-05
