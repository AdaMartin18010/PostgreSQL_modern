---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\21-æœ€ä½³å®è·µ\é£é™©åº”å¯¹æªæ–½.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é£é™©åº”å¯¹æªæ–½

> **æ–‡æ¡£ç¼–å·**: AI-07-04
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 21-æœ€ä½³å®è·µ
> **å­ä¸»é¢˜**: 04-é£é™©åº”å¯¹æªæ–½

## ğŸ“‘ ç›®å½•

- [é£é™©åº”å¯¹æªæ–½](#é£é™©åº”å¯¹æªæ–½)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. é£é™©æ¦‚è¿°](#1-é£é™©æ¦‚è¿°)
  - [2. æŠ€æœ¯é£é™©](#2-æŠ€æœ¯é£é™©)
    - [2.1 å‘é‡ç´¢å¼•é£é™©](#21-å‘é‡ç´¢å¼•é£é™©)
    - [2.2 æ€§èƒ½é£é™©](#22-æ€§èƒ½é£é™©)
    - [2.3 æ•°æ®è¿ç§»é£é™©](#23-æ•°æ®è¿ç§»é£é™©)
    - [2.4 æ‰©å±•å…¼å®¹æ€§é£é™©](#24-æ‰©å±•å…¼å®¹æ€§é£é™©)
  - [3. ä¸šåŠ¡é£é™©](#3-ä¸šåŠ¡é£é™©)
    - [3.1 æœåŠ¡ä¸­æ–­é£é™©](#31-æœåŠ¡ä¸­æ–­é£é™©)
    - [3.2 æ•°æ®ä¸¢å¤±é£é™©](#32-æ•°æ®ä¸¢å¤±é£é™©)
    - [3.3 æˆæœ¬è¶…æ”¯é£é™©](#33-æˆæœ¬è¶…æ”¯é£é™©)
    - [3.4 åˆè§„é£é™©](#34-åˆè§„é£é™©)
  - [4. é£é™©åº”å¯¹ç­–ç•¥](#4-é£é™©åº”å¯¹ç­–ç•¥)
    - [4.1 é¢„é˜²æªæ–½](#41-é¢„é˜²æªæ–½)
    - [4.2 ç›‘æ§å‘Šè­¦](#42-ç›‘æ§å‘Šè­¦)
    - [4.3 åº”æ€¥é¢„æ¡ˆ](#43-åº”æ€¥é¢„æ¡ˆ)
    - [4.4 å›æ»šæ–¹æ¡ˆ](#44-å›æ»šæ–¹æ¡ˆ)
  - [5. å‡çº§ä¸è¿ç§»](#5-å‡çº§ä¸è¿ç§»)
    - [5.1 ç‰ˆæœ¬å…¼å®¹æ€§](#51-ç‰ˆæœ¬å…¼å®¹æ€§)
    - [5.2 é›¶åœæœºå‡çº§](#52-é›¶åœæœºå‡çº§)
    - [5.3 æ•°æ®è¿ç§»æ–¹æ¡ˆ](#53-æ•°æ®è¿ç§»æ–¹æ¡ˆ)
    - [5.4 å›æ»šç­–ç•¥](#54-å›æ»šç­–ç•¥)

---

## 1. é£é™©æ¦‚è¿°

**é£é™©åˆ†ç±»**ï¼š

```mermaid
mindmap
  root((PostgreSQL AIé£é™©))
    æŠ€æœ¯é£é™©
      å‘é‡ç´¢å¼•é£é™©
        ç´¢å¼•æ„å»ºå¤±è´¥
        ç´¢å¼•æŸå
        æŸ¥è¯¢æ€§èƒ½ä¸‹é™
      æ€§èƒ½é£é™©
        æŸ¥è¯¢æ…¢
        èµ„æºè€—å°½
        å¹¶å‘ç“¶é¢ˆ
      æ•°æ®è¿ç§»é£é™©
        æ•°æ®ä¸¢å¤±
        è¿ç§»å¤±è´¥
        å…¼å®¹æ€§é—®é¢˜
      æ‰©å±•å…¼å®¹æ€§é£é™©
        ç‰ˆæœ¬ä¸å…¼å®¹
        åŠŸèƒ½ç¼ºå¤±
        æ€§èƒ½é—®é¢˜
    ä¸šåŠ¡é£é™©
      æœåŠ¡ä¸­æ–­é£é™©
        å‡çº§ä¸­æ–­
        æ•…éšœä¸­æ–­
        ç»´æŠ¤ä¸­æ–­
      æ•°æ®ä¸¢å¤±é£é™©
        å¤‡ä»½å¤±è´¥
        æ¢å¤å¤±è´¥
        äººä¸ºé”™è¯¯
      æˆæœ¬è¶…æ”¯é£é™©
        APIè°ƒç”¨è¶…æ”¯
        èµ„æºè¶…æ”¯
        è¿ç»´è¶…æ”¯
      åˆè§„é£é™©
        æ•°æ®éšç§
        å®‰å…¨åˆè§„
        å®¡è®¡è¦æ±‚
```

---

## 2. æŠ€æœ¯é£é™©

### 2.1 å‘é‡ç´¢å¼•é£é™©

**é£é™©æè¿°**ï¼š

- ç´¢å¼•æ„å»ºå¤±è´¥
- ç´¢å¼•æŸå
- æŸ¥è¯¢æ€§èƒ½ä¸è¾¾æ ‡

**é¢„é˜²æªæ–½**ï¼š

```sql
-- 1. ä½¿ç”¨CONCURRENTLYåˆ›å»ºç´¢å¼•ï¼ˆé¿å…é”è¡¨ï¼‰
CREATE INDEX CONCURRENTLY ON documents
USING hnsw(embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. æ£€æŸ¥ç´¢å¼•çŠ¶æ€
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'documents';

-- 3. éªŒè¯ç´¢å¼•å®Œæ•´æ€§
SELECT * FROM pg_stat_user_indexes
WHERE indexrelname = 'documents_embedding_idx';
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```sql
-- 1. ç´¢å¼•æŸåæ—¶é‡å»º
DROP INDEX CONCURRENTLY documents_embedding_idx;
CREATE INDEX CONCURRENTLY documents_embedding_idx
ON documents USING hnsw(embedding vector_cosine_ops);

-- 2. ä½¿ç”¨REINDEXé‡å»º
REINDEX INDEX CONCURRENTLY documents_embedding_idx;
```

### 2.2 æ€§èƒ½é£é™©

**é£é™©æè¿°**ï¼š

- æŸ¥è¯¢å“åº”æ—¶é—´è¿‡é•¿
- ç³»ç»Ÿèµ„æºè€—å°½
- å¹¶å‘æ€§èƒ½ä¸‹é™

**é¢„é˜²æªæ–½**ï¼š

```sql
-- 1. ç›‘æ§æ…¢æŸ¥è¯¢
SELECT
    pid,
    now() - query_start AS duration,
    query,
    state
FROM pg_stat_activity
WHERE (now() - query_start) > interval '5 minutes'
ORDER BY duration DESC;

-- 2. è®¾ç½®æŸ¥è¯¢è¶…æ—¶
SET statement_timeout = '30s';

-- 3. é™åˆ¶è¿æ¥æ•°
ALTER SYSTEM SET max_connections = 200;
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```sql
-- 1. ç»ˆæ­¢æ…¢æŸ¥è¯¢
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE (now() - query_start) > interval '10 minutes'
  AND state = 'active';

-- 2. ç´§æ€¥æ‰©å®¹
-- å¢åŠ è®¡ç®—èµ„æº
-- ä½¿ç”¨è¿æ¥æ± 
```

### 2.3 æ•°æ®è¿ç§»é£é™©

**é£é™©æè¿°**ï¼š

- æ•°æ®ä¸¢å¤±
- è¿ç§»å¤±è´¥
- æ•°æ®ä¸ä¸€è‡´

**é¢„é˜²æªæ–½**ï¼š

```bash
# 1. å®Œæ•´å¤‡ä»½
pg_dump -Fc -f backup_$(date +%Y%m%d).dump ai_db

# 2. éªŒè¯å¤‡ä»½
pg_restore --list backup_20250101.dump

# 3. æµ‹è¯•æ¢å¤
pg_restore -d test_db backup_20250101.dump
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```bash
# 1. å›æ»šåˆ°å¤‡ä»½
pg_restore -d ai_db backup_20250101.dump

# 2. å¢é‡æ¢å¤
pg_restore -d ai_db --data-only backup_20250101.dump
```

### 2.4 æ‰©å±•å…¼å®¹æ€§é£é™©

**é£é™©æè¿°**ï¼š

- pgvector/pg_aiç‰ˆæœ¬ä¸å…¼å®¹
- PostgreSQLç‰ˆæœ¬ä¸å…¼å®¹
- åŠŸèƒ½ç¼ºå¤±

**é¢„é˜²æªæ–½**ï¼š

```sql
-- 1. æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬
SELECT
    extname,
    extversion
FROM pg_extension
WHERE extname IN ('vector', 'pg_ai');

-- 2. æ£€æŸ¥PostgreSQLç‰ˆæœ¬
SELECT version();

-- 3. æµ‹è¯•å…¼å®¹æ€§
-- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```sql
-- 1. é™çº§æ‰©å±•ç‰ˆæœ¬
ALTER EXTENSION vector UPDATE TO '0.7.0';

-- 2. ç¦ç”¨æ‰©å±•ï¼ˆå¦‚å¿…è¦ï¼‰
DROP EXTENSION IF EXISTS vector CASCADE;
```

---

## 3. ä¸šåŠ¡é£é™©

### 3.1 æœåŠ¡ä¸­æ–­é£é™©

**é£é™©æè¿°**ï¼š

- å‡çº§è¿‡ç¨‹ä¸­æœåŠ¡ä¸­æ–­
- æ•…éšœå¯¼è‡´æœåŠ¡ä¸­æ–­
- ç»´æŠ¤å¯¼è‡´æœåŠ¡ä¸­æ–­

**é¢„é˜²æªæ–½**ï¼š

```bash
# 1. ä½¿ç”¨é›¶åœæœºå‡çº§ï¼ˆPostgreSQL 18 pg_upgradeï¼‰
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data \
  --check

# 2. ä¸»ä»åˆ‡æ¢ï¼ˆé«˜å¯ç”¨ï¼‰
# ä½¿ç”¨Patroniæˆ–pg_auto_failover
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```bash
# 1. å¿«é€Ÿå›æ»š
# åˆ‡æ¢åˆ°ä»åº“
pg_ctl promote -D /var/lib/postgresql/standby

# 2. æ¢å¤ä¸»åº“
pg_ctl start -D /var/lib/postgresql/data
```

### 3.2 æ•°æ®ä¸¢å¤±é£é™©

**é£é™©æè¿°**ï¼š

- å¤‡ä»½å¤±è´¥
- æ¢å¤å¤±è´¥
- äººä¸ºè¯¯æ“ä½œ

**é¢„é˜²æªæ–½**ï¼š

```bash
# 1. è‡ªåŠ¨åŒ–å¤‡ä»½
#!/bin/bash
BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

# å®Œæ•´å¤‡ä»½
pg_dump -Fc -f $BACKUP_DIR/backup_$DATE.dump ai_db

# WALå½’æ¡£
# postgresql.conf
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```bash
# 1. PITRæ¢å¤
# æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
recovery_target_time = '2025-01-15 14:30:00'
restore_command = 'cp /backup/wal/%f %p'
```

### 3.3 æˆæœ¬è¶…æ”¯é£é™©

**é£é™©æè¿°**ï¼š

- AI APIè°ƒç”¨æˆæœ¬è¶…æ”¯
- åŸºç¡€è®¾æ–½æˆæœ¬è¶…æ”¯
- è¿ç»´æˆæœ¬è¶…æ”¯

**é¢„é˜²æªæ–½**ï¼š

```sql
-- 1. æˆæœ¬ç›‘æ§
CREATE TABLE cost_tracking (
    id SERIAL PRIMARY KEY,
    cost_type TEXT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    date DATE NOT NULL
);

-- 2. APIè°ƒç”¨ç›‘æ§
SELECT
    COUNT(*) AS api_calls,
    SUM(cost) AS total_cost
FROM api_call_log
WHERE date >= CURRENT_DATE - INTERVAL '1 day';
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```sql
-- 1. é™åˆ¶APIè°ƒç”¨
ALTER SYSTEM SET pg_ai.rate_limit = 1000;  -- æ¯å°æ—¶1000æ¬¡

-- 2. å¯ç”¨ç¼“å­˜
-- ä½¿ç”¨embedding_cacheè¡¨
```

### 3.4 åˆè§„é£é™©

**é£é™©æè¿°**ï¼š

- æ•°æ®éšç§è¿è§„
- å®‰å…¨åˆè§„é—®é¢˜
- å®¡è®¡è¦æ±‚ä¸æ»¡è¶³

**é¢„é˜²æªæ–½**ï¼š

```sql
-- 1. æ•°æ®åŠ å¯†
-- ä¼ è¾“åŠ å¯†ï¼ˆSSLï¼‰
ALTER SYSTEM SET ssl = on;

-- 2. å®¡è®¡æ—¥å¿—
CREATE EXTENSION pgaudit;
ALTER SYSTEM SET pgaudit.log = 'all';

-- 3. è®¿é—®æ§åˆ¶
-- pg_hba.conf
host all all 10.0.0.0/8 md5
```

**åº”æ€¥é¢„æ¡ˆ**ï¼š

```sql
-- 1. ç´§æ€¥ç¦ç”¨è®¿é—®
-- ä¿®æ”¹pg_hba.conf
host all all 0.0.0.0/0 reject

-- 2. å®¡è®¡æ£€æŸ¥
SELECT * FROM pg_stat_statements
WHERE query LIKE '%sensitive_data%';
```

---

## 4. é£é™©åº”å¯¹ç­–ç•¥

### 4.1 é¢„é˜²æªæ–½

**æŠ€æœ¯é¢„é˜²**ï¼š

- âœ… å……åˆ†æµ‹è¯•
- âœ… åˆ†é˜¶æ®µå®æ–½
- âœ… ç›‘æ§å‘Šè­¦
- âœ… è‡ªåŠ¨åŒ–å¤‡ä»½

**æµç¨‹é¢„é˜²**ï¼š

- âœ… å˜æ›´ç®¡ç†æµç¨‹
- âœ… ä»£ç å®¡æŸ¥
- âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•
- âœ… å›æ»šå‡†å¤‡

### 4.2 ç›‘æ§å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- 1. æ€§èƒ½ç›‘æ§
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname = 'ai_db';

-- 2. è¿æ¥ç›‘æ§
SELECT count(*) FROM pg_stat_activity;

-- 3. é”ç›‘æ§
SELECT * FROM pg_locks WHERE NOT granted;
```

**å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦
groups:
  - name: postgres_alerts
    rules:
      - alert: HighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m

      - alert: SlowQueries
        expr: pg_stat_statements_mean_exec_time > 5000
        for: 5m

      - alert: HighAPICost
        expr: api_cost_per_day > 100
        for: 1h
```

### 4.3 åº”æ€¥é¢„æ¡ˆ

**æ•…éšœå¤„ç†æµç¨‹**ï¼š

```mermaid
graph TD
    A[å‘ç°æ•…éšœ] --> B{æ•…éšœç±»å‹?}
    B -->|æ€§èƒ½é—®é¢˜| C[æ€§èƒ½ä¼˜åŒ–]
    B -->|æ•°æ®é—®é¢˜| D[æ•°æ®æ¢å¤]
    B -->|æœåŠ¡ä¸­æ–­| E[æœåŠ¡æ¢å¤]
    C --> F[éªŒè¯ä¿®å¤]
    D --> F
    E --> F
    F --> G{ä¿®å¤æˆåŠŸ?}
    G -->|æ˜¯| H[å®Œæˆ]
    G -->|å¦| I[å›æ»š]
    I --> J[é‡æ–°è¯„ä¼°]
```

**åº”æ€¥è”ç³»äºº**ï¼š

- DBAï¼š24/7å¾…å‘½
- å¼€å‘å›¢é˜Ÿï¼šå·¥ä½œæ—¶é—´
- è¿ç»´å›¢é˜Ÿï¼š24/7å¾…å‘½

### 4.4 å›æ»šæ–¹æ¡ˆ

**å›æ»šæ£€æŸ¥æ¸…å•**ï¼š

1. âœ… å¤‡ä»½éªŒè¯
2. âœ… å›æ»šè„šæœ¬å‡†å¤‡
3. âœ… å›æ»šæµ‹è¯•
4. âœ… å›æ»šæ—¶é—´çª—å£
5. âœ… å›æ»šå½±å“è¯„ä¼°

**å›æ»šæ­¥éª¤**ï¼š

```bash
# 1. åœæ­¢æœåŠ¡
systemctl stop postgresql-18

# 2. æ¢å¤å¤‡ä»½
pg_restore -d ai_db backup_20250101.dump

# 3. éªŒè¯æ•°æ®
psql -d ai_db -c "SELECT COUNT(*) FROM documents;"

# 4. é‡å¯æœåŠ¡
systemctl start postgresql-18
```

---

## 5. å‡çº§ä¸è¿ç§»

### 5.1 ç‰ˆæœ¬å…¼å®¹æ€§

**PostgreSQL 18å…¼å®¹æ€§**ï¼š

| æ‰©å±• | æœ€ä½ç‰ˆæœ¬ | æ¨èç‰ˆæœ¬ | çŠ¶æ€ |
|------|---------|---------|------|
| **pgvector** | 0.5.0 | 0.8.0 | âœ… å…¼å®¹ |
| **pg_ai** | 0.1.0 | æœ€æ–° | âœ… å…¼å®¹ |
| **PostgresML** | 3.0 | 3.0+ | âœ… å…¼å®¹ |

**å…¼å®¹æ€§æ£€æŸ¥**ï¼š

```bash
# 1. æ£€æŸ¥æ‰©å±•å…¼å®¹æ€§
pg_upgrade --check

# 2. æ£€æŸ¥æ•°æ®å…¼å®¹æ€§
pg_upgrade --check --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin
```

### 5.2 é›¶åœæœºå‡çº§

**PostgreSQL 18å‡çº§**ï¼š

```bash
# 1. ä½¿ç”¨pg_upgradeï¼ˆPostgreSQL 18ä¿ç•™ç»Ÿè®¡ä¿¡æ¯ï¼‰
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data \
  --check

# 2. æ‰§è¡Œå‡çº§
pg_upgrade \
  --old-bindir /usr/lib/postgresql/17/bin \
  --new-bindir /usr/lib/postgresql/18/bin \
  --old-datadir /var/lib/postgresql/17/data \
  --new-datadir /var/lib/postgresql/18/data
```

**é«˜å¯ç”¨å‡çº§**ï¼š

```bash
# 1. å‡çº§ä»åº“
# 2. åˆ‡æ¢ä¸»ä»
# 3. å‡çº§åŸä¸»åº“
# 4. åˆ‡æ¢å›æ¥
```

### 5.3 æ•°æ®è¿ç§»æ–¹æ¡ˆ

**è¿ç§»ç­–ç•¥**ï¼š

1. **å…¨é‡è¿ç§»**ï¼š
   - é€‚ç”¨äºå°æ•°æ®é‡
   - åœæœºæ—¶é—´çŸ­
   - é£é™©ä½

2. **å¢é‡è¿ç§»**ï¼š
   - é€‚ç”¨äºå¤§æ•°æ®é‡
   - åœæœºæ—¶é—´çŸ­
   - éœ€è¦CDC

3. **åŒå†™è¿ç§»**ï¼š
   - é›¶åœæœº
   - é£é™©æœ€ä½
   - å¤æ‚åº¦é«˜

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å‡†å¤‡é˜¶æ®µ
# - å¤‡ä»½æ•°æ®
# - éªŒè¯ç¯å¢ƒ
# - å‡†å¤‡è¿ç§»è„šæœ¬

# 2. æ‰§è¡Œé˜¶æ®µ
# - åœæ­¢å†™å…¥
# - è¿ç§»æ•°æ®
# - éªŒè¯æ•°æ®

# 3. åˆ‡æ¢é˜¶æ®µ
# - åˆ‡æ¢åº”ç”¨
# - éªŒè¯åŠŸèƒ½
# - ç›‘æ§æ€§èƒ½
```

### 5.4 å›æ»šç­–ç•¥

**å›æ»šæ¡ä»¶**ï¼š

- æ•°æ®ä¸¢å¤±
- æ€§èƒ½ä¸¥é‡ä¸‹é™
- åŠŸèƒ½å¼‚å¸¸
- å®‰å…¨æ¼æ´

**å›æ»šæ­¥éª¤**ï¼š

```bash
# 1. è¯„ä¼°å½±å“
# 2. å‡†å¤‡å›æ»š
# 3. æ‰§è¡Œå›æ»š
# 4. éªŒè¯æ¢å¤
# 5. æ€»ç»“é—®é¢˜
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-04
