---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\01-å‘é‡ä¸æ··åˆæœç´¢\æ€§èƒ½ä¼˜åŒ–\å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 16+ / pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 01-04-03

## ğŸ“‘ ç›®å½•

- [å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–](#å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. éƒ¨ç½²æ¶æ„ä¼˜åŒ–](#2-éƒ¨ç½²æ¶æ„ä¼˜åŒ–)
    - [2.1 åˆ†ç‰‡éƒ¨ç½²](#21-åˆ†ç‰‡éƒ¨ç½²)
      - [2.1.1 å“ˆå¸Œåˆ†ç‰‡ï¼ˆHash Shardingï¼‰](#211-å“ˆå¸Œåˆ†ç‰‡hash-sharding)
      - [2.1.2 èŒƒå›´åˆ†ç‰‡ï¼ˆRange Shardingï¼‰](#212-èŒƒå›´åˆ†ç‰‡range-sharding)
      - [2.1.3 åˆ—è¡¨åˆ†ç‰‡ï¼ˆList Shardingï¼‰](#213-åˆ—è¡¨åˆ†ç‰‡list-sharding)
      - [2.1.4 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—](#214-åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—)
    - [2.2 è¯»å†™åˆ†ç¦»](#22-è¯»å†™åˆ†ç¦»)
  - [3. èµ„æºä¼˜åŒ–](#3-èµ„æºä¼˜åŒ–)
    - [3.1 CPU ä¼˜åŒ–](#31-cpu-ä¼˜åŒ–)
    - [3.2 å†…å­˜ä¼˜åŒ–](#32-å†…å­˜ä¼˜åŒ–)
    - [3.3 å­˜å‚¨ä¼˜åŒ–](#33-å­˜å‚¨ä¼˜åŒ–)
  - [4. ç½‘ç»œä¼˜åŒ–](#4-ç½‘ç»œä¼˜åŒ–)
    - [4.1 è¿æ¥æ± ä¼˜åŒ–](#41-è¿æ¥æ± ä¼˜åŒ–)
    - [4.2 ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–](#42-ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–)
  - [5. ç›‘æ§ä¼˜åŒ–](#5-ç›‘æ§ä¼˜åŒ–)
    - [5.1 æ€§èƒ½ç›‘æ§](#51-æ€§èƒ½ç›‘æ§)
    - [5.2 èµ„æºç›‘æ§](#52-èµ„æºç›‘æ§)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 åˆ†ç‰‡ç­–ç•¥](#61-åˆ†ç‰‡ç­–ç•¥)
    - [6.2 å®é™…åº”ç”¨æ¡ˆä¾‹](#62-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹ 1: æŸå¤§å‹ç”µå•†å¹³å°å¤§è§„æ¨¡å‘é‡æœç´¢ç³»ç»Ÿ](#æ¡ˆä¾‹-1-æŸå¤§å‹ç”µå•†å¹³å°å¤§è§„æ¨¡å‘é‡æœç´¢ç³»ç»Ÿ)
      - [æ¡ˆä¾‹ 2: ç”µå•†å¹³å°ä¿ƒé”€æœŸé—´åˆ†åŒºè¡¨æ€§èƒ½é—®é¢˜ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#æ¡ˆä¾‹-2-ç”µå•†å¹³å°ä¿ƒé”€æœŸé—´åˆ†åŒºè¡¨æ€§èƒ½é—®é¢˜çœŸå®æ¡ˆä¾‹)
      - [æ¡ˆä¾‹ 3: IoT åœºæ™¯é«˜ååå†™å…¥ä¼˜åŒ–](#æ¡ˆä¾‹-3-iot-åœºæ™¯é«˜ååå†™å…¥ä¼˜åŒ–)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 æŠ€æœ¯åšå®¢](#72-æŠ€æœ¯åšå®¢)
    - [7.3 ç›¸å…³èµ„æº](#73-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

å¤§è§„æ¨¡å‘é‡æœç´¢ç³»ç»Ÿé¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **æ•°æ®è§„æ¨¡**: 10 äº¿+ å‘é‡æ•°æ®
- **æŸ¥è¯¢è´Ÿè½½**: 10K+ QPS
- **èµ„æºé™åˆ¶**: CPUã€å†…å­˜ã€å­˜å‚¨èµ„æºæœ‰é™
- **ç½‘ç»œå»¶è¿Ÿ**: è·¨åŒºåŸŸéƒ¨ç½²ç½‘ç»œå»¶è¿Ÿé«˜

**è§£å†³æ–¹æ¡ˆ**:

å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–ä»æ¶æ„ã€èµ„æºã€ç½‘ç»œç­‰å¤šä¸ªç»´åº¦è¿›è¡Œä¼˜åŒ–ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹ç¨³å®šè¿è¡Œã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **æ€§èƒ½æå‡**:
   - æŸ¥è¯¢ååé‡: æå‡ **5-10 å€**ï¼ˆåˆ†ç‰‡+è¯»å†™åˆ†ç¦»ï¼‰
   - æŸ¥è¯¢å»¶è¿Ÿ: é™ä½ **60%**ï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰
   - èµ„æºåˆ©ç”¨ç‡: æå‡ **40%**ï¼ˆèµ„æºä¼˜åŒ–ï¼‰

2. **æˆæœ¬ä¼˜åŒ–**:
   - ç¡¬ä»¶æˆæœ¬: é™ä½ **30%**ï¼ˆèµ„æºä¼˜åŒ–ï¼‰
   - å¸¦å®½æˆæœ¬: é™ä½ **50%**ï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰
   - è¿ç»´æˆæœ¬: é™ä½ **40%**ï¼ˆè‡ªåŠ¨åŒ–ï¼‰

---

## 2. éƒ¨ç½²æ¶æ„ä¼˜åŒ–

### 2.1 åˆ†ç‰‡éƒ¨ç½²

**åˆ†ç‰‡æ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è´Ÿè½½å‡è¡¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚       â”‚         â”‚         â”‚
â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”
â”‚åˆ†ç‰‡1â”‚ â”‚åˆ†ç‰‡2â”‚ â”‚åˆ†ç‰‡3 â”‚ â”‚åˆ†ç‰‡4 â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç‰‡ç­–ç•¥è¯¦è§£**:

PostgreSQL æä¾›å¤šç§åˆ†ç‰‡ç­–ç•¥ï¼Œæ¯ç§ç­–ç•¥é€‚ç”¨äºä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼š

#### 2.1.1 å“ˆå¸Œåˆ†ç‰‡ï¼ˆHash Shardingï¼‰

**é€‚ç”¨åœºæ™¯**:

- å†™å…¥è´Ÿè½½å‡åŒ€åˆ†å¸ƒ
- éœ€è¦è´Ÿè½½å‡è¡¡
- ä¸éœ€è¦èŒƒå›´æŸ¥è¯¢

**å®ç°æ–¹å¼**:

```sql
-- ä½¿ç”¨ Citus æ‰©å±•å®ç°å“ˆå¸Œåˆ†ç‰‡
CREATE EXTENSION IF NOT EXISTS citus;

-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨
CREATE TABLE documents (
    id BIGSERIAL,
    user_id BIGINT,
    content TEXT,
    embedding vector(1536)
);

-- æŒ‰ user_id è¿›è¡Œå“ˆå¸Œåˆ†ç‰‡
SELECT create_distributed_table('documents', 'user_id', 'hash');

-- åˆ†ç‰‡æ•°é‡é…ç½®
SELECT set_default_table_distribution('documents', 'hash', shard_count => 32);
```

**æ€§èƒ½ç‰¹ç‚¹**:

| æŒ‡æ ‡ | å“ˆå¸Œåˆ†ç‰‡ | è¯´æ˜ |
|------|---------|------|
| **æ•°æ®åˆ†å¸ƒ** | å‡åŒ€ | æ•°æ®å‡åŒ€åˆ†å¸ƒåˆ°å„åˆ†ç‰‡ |
| **å†™å…¥æ€§èƒ½** | **é«˜** | å†™å…¥è´Ÿè½½åˆ†æ•£ |
| **èŒƒå›´æŸ¥è¯¢** | **ä¸æ”¯æŒ** | éœ€è¦è·¨åˆ†ç‰‡æŸ¥è¯¢ |
| **çƒ­ç‚¹é—®é¢˜** | **æ— ** | é¿å…æ•°æ®å€¾æ–œ |

#### 2.1.2 èŒƒå›´åˆ†ç‰‡ï¼ˆRange Shardingï¼‰

**é€‚ç”¨åœºæ™¯**:

- æ—¶é—´åºåˆ—æ•°æ®
- éœ€è¦èŒƒå›´æŸ¥è¯¢
- æ•°æ®æœ‰æ˜æ˜¾çš„æ—¶é—´ç‰¹å¾

**å®ç°æ–¹å¼**:

```sql
-- ä½¿ç”¨ PostgreSQL å†…ç½®åˆ†åŒºè¡¨
CREATE TABLE documents (
    id BIGSERIAL,
    created_at TIMESTAMPTZ NOT NULL,
    content TEXT,
    embedding vector(1536)
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE documents_2025_01 PARTITION OF documents
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE documents_2025_02 PARTITION OF documents
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- è‡ªåŠ¨åˆ›å»ºæœªæ¥åˆ†åŒºï¼ˆä½¿ç”¨å‡½æ•°ï¼‰
CREATE OR REPLACE FUNCTION create_monthly_partitions()
RETURNS void AS $$
DECLARE
    start_date DATE;
    end_date DATE;
    partition_name TEXT;
BEGIN
    FOR i IN 0..11 LOOP
        start_date := DATE_TRUNC('month', CURRENT_DATE + (i || ' months')::INTERVAL);
        end_date := start_date + INTERVAL '1 month';
        partition_name := 'documents_' || TO_CHAR(start_date, 'YYYY_MM');

        EXECUTE format('
            CREATE TABLE IF NOT EXISTS %I PARTITION OF documents
            FOR VALUES FROM (%L) TO (%L)',
            partition_name, start_date, end_date
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œåˆ†åŒºåˆ›å»º
SELECT create_monthly_partitions();
```

**æ€§èƒ½ç‰¹ç‚¹**:

| æŒ‡æ ‡ | èŒƒå›´åˆ†ç‰‡ | è¯´æ˜ |
|------|---------|------|
| **æ•°æ®åˆ†å¸ƒ** | å¯èƒ½ä¸å‡åŒ€ | æ–°æ•°æ®é›†ä¸­åœ¨æœ€æ–°åˆ†åŒº |
| **å†™å…¥æ€§èƒ½** | **ä¸­** | å¯èƒ½å­˜åœ¨çƒ­ç‚¹åˆ†åŒº |
| **èŒƒå›´æŸ¥è¯¢** | **æ”¯æŒ** | åˆ†åŒºè£å‰ªä¼˜åŒ– |
| **çƒ­ç‚¹é—®é¢˜** | **å¯èƒ½** | éœ€è¦å®šæœŸç»´æŠ¤æ—§åˆ†åŒº |

#### 2.1.3 åˆ—è¡¨åˆ†ç‰‡ï¼ˆList Shardingï¼‰

**é€‚ç”¨åœºæ™¯**:

- ä¸šåŠ¡åˆ†åŒºæ˜ç¡®ï¼ˆå¦‚åœ°åŒºã€ç±»åˆ«ï¼‰
- éœ€è¦æŒ‰ä¸šåŠ¡ç»´åº¦æŸ¥è¯¢
- æ•°æ®æœ‰æ˜æ˜¾çš„åˆ†ç±»ç‰¹å¾

**å®ç°æ–¹å¼**:

```sql
-- æŒ‰åœ°åŒºè¿›è¡Œåˆ—è¡¨åˆ†ç‰‡
CREATE TABLE documents (
    id BIGSERIAL,
    region TEXT NOT NULL,
    content TEXT,
    embedding vector(1536)
) PARTITION BY LIST (region);

-- åˆ›å»ºåœ°åŒºåˆ†åŒº
CREATE TABLE documents_us_east PARTITION OF documents
    FOR VALUES IN ('us-east-1', 'us-east-2');

CREATE TABLE documents_us_west PARTITION OF documents
    FOR VALUES IN ('us-west-1', 'us-west-2');

CREATE TABLE documents_eu PARTITION OF documents
    FOR VALUES IN ('eu-west-1', 'eu-central-1');

CREATE TABLE documents_asia PARTITION OF documents
    FOR VALUES IN ('ap-southeast-1', 'ap-northeast-1');
```

**æ€§èƒ½ç‰¹ç‚¹**:

| æŒ‡æ ‡ | åˆ—è¡¨åˆ†ç‰‡ | è¯´æ˜ |
|------|---------|------|
| **æ•°æ®åˆ†å¸ƒ** | å–å†³äºä¸šåŠ¡ | æŒ‰ä¸šåŠ¡é€»è¾‘åˆ†å¸ƒ |
| **å†™å…¥æ€§èƒ½** | **ä¸­** | å–å†³äºåˆ†åŒºé€‰æ‹© |
| **èŒƒå›´æŸ¥è¯¢** | **éƒ¨åˆ†æ”¯æŒ** | æ”¯æŒåˆ†åŒºå†…æŸ¥è¯¢ |
| **çƒ­ç‚¹é—®é¢˜** | **å¯èƒ½** | å–å†³äºä¸šåŠ¡åˆ†å¸ƒ |

#### 2.1.4 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—

**é€‰æ‹©å†³ç­–çŸ©é˜µ**:

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|------|---------|------|
| **å‡åŒ€å†™å…¥è´Ÿè½½** | å“ˆå¸Œåˆ†ç‰‡ | è´Ÿè½½å‡è¡¡ï¼Œé¿å…çƒ­ç‚¹ |
| **æ—¶é—´åºåˆ—æ•°æ®** | èŒƒå›´åˆ†ç‰‡ | æ”¯æŒåˆ†åŒºè£å‰ªï¼ŒæŸ¥è¯¢ä¼˜åŒ– |
| **ä¸šåŠ¡åˆ†åŒºæ˜ç¡®** | åˆ—è¡¨åˆ†ç‰‡ | ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼ŒæŸ¥è¯¢ä¼˜åŒ– |
| **é«˜å¹¶å‘å†™å…¥** | å“ˆå¸Œåˆ†ç‰‡ | å†™å…¥è´Ÿè½½åˆ†æ•£ |
| **å†å²æ•°æ®æŸ¥è¯¢** | èŒƒå›´åˆ†ç‰‡ | åˆ†åŒºè£å‰ªï¼Œæ€§èƒ½ä¼˜åŒ– |

### 2.2 è¯»å†™åˆ†ç¦»

**è¯»å†™åˆ†ç¦»æ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†™å…¥èŠ‚ç‚¹    â”‚
â”‚  (Primary)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚è¯»èŠ‚ç‚¹1â”‚ â”‚è¯»èŠ‚ç‚¹2â”‚
â”‚(Standby)â”‚ â”‚(Standby)â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

**è¯»å†™åˆ†ç¦»é…ç½®**:

```sql
-- ä¸»èŠ‚ç‚¹é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

-- ä»èŠ‚ç‚¹é…ç½®ï¼ˆrecovery.conf æˆ– postgresql.confï¼‰
primary_conninfo = 'host=primary_host port=5432 user=replicator'
```

**è¯»å†™åˆ†ç¦»æ€§èƒ½æå‡**:

| æŒ‡æ ‡ | å•èŠ‚ç‚¹ | è¯»å†™åˆ†ç¦» | æå‡ |
|------|--------|---------|------|
| **å†™å…¥åå** | 5,000 TPS | 5,000 TPS | ä¸å˜ |
| **è¯»å–åå** | 10,000 QPS | 30,000 QPS | **3 å€** |
| **æŸ¥è¯¢å»¶è¿Ÿ** | 50ms | 20ms | **60%** â¬‡ï¸ |
| **å¯ç”¨æ€§** | 99.9% | 99.99% | **æå‡** |

**åº”ç”¨å±‚è¯»å†™åˆ†ç¦»**:

```python
# Python åº”ç”¨å±‚è¯»å†™åˆ†ç¦»ç¤ºä¾‹
import psycopg2
from psycopg2 import pool

# ä¸»èŠ‚ç‚¹è¿æ¥æ± ï¼ˆå†™å…¥ï¼‰
write_pool = psycopg2.pool.ThreadedConnectionPool(
    1, 10,
    host='primary_host',
    database='vector_db',
    user='write_user',
    password='password'
)

# ä»èŠ‚ç‚¹è¿æ¥æ± ï¼ˆè¯»å–ï¼‰
read_pool = psycopg2.pool.ThreadedConnectionPool(
    5, 50,
    host='standby_host',
    database='vector_db',
    user='read_user',
    password='password'
)

def execute_write(query, params=None):
    """æ‰§è¡Œå†™å…¥æ“ä½œ"""
    conn = write_pool.getconn()
    try:
        cur = conn.cursor()
        cur.execute(query, params)
        conn.commit()
        return cur.fetchall()
    finally:
        write_pool.putconn(conn)

def execute_read(query, params=None):
    """æ‰§è¡Œè¯»å–æ“ä½œ"""
    conn = read_pool.getconn()
    try:
        cur = conn.cursor()
        cur.execute(query, params)
        return cur.fetchall()
    finally:
        read_pool.putconn(conn)

# ä½¿ç”¨ç¤ºä¾‹
# å†™å…¥æ“ä½œ
execute_write(
    "INSERT INTO documents (content, embedding) VALUES (%s, %s)",
    ("Document text", "[0.1, 0.2, ...]")
)

# è¯»å–æ“ä½œ
results = execute_read(
    "SELECT * FROM documents ORDER BY embedding <=> %s LIMIT 10",
    ("[0.1, 0.2, ...]",)
)
```

---

## 3. èµ„æºä¼˜åŒ–

### 3.1 CPU ä¼˜åŒ–

```sql
-- å¹¶è¡ŒæŸ¥è¯¢é…ç½®
SET max_parallel_workers_per_gather = 8;
SET max_worker_processes = 16;
```

### 3.2 å†…å­˜ä¼˜åŒ–

```sql
-- å†…å­˜é…ç½®
SET shared_buffers = '8GB';
SET work_mem = '256MB';
SET maintenance_work_mem = '2GB';
```

### 3.3 å­˜å‚¨ä¼˜åŒ–

```sql
-- è¡¨ç©ºé—´é…ç½®
CREATE TABLESPACE fast_storage LOCATION '/fast/ssd';
ALTER TABLE documents SET TABLESPACE fast_storage;
```

---

## 4. ç½‘ç»œä¼˜åŒ–

### 4.1 è¿æ¥æ± ä¼˜åŒ–

```ini
# PgBouncer é…ç½®
[pgbouncer]
pool_mode = transaction
max_client_conn = 10000
default_pool_size = 100
```

### 4.2 ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–

**ç½‘ç»œä¼˜åŒ–ç­–ç•¥**:

1. **ä½¿ç”¨é«˜é€Ÿç½‘ç»œ**: 10Gbps+ ç½‘ç»œå¸¦å®½
2. **å‡å°‘ç½‘ç»œè·³æ•°**: å‡å°‘è·¯ç”±è·³æ•°ï¼Œé™ä½å»¶è¿Ÿ
3. **ä½¿ç”¨ CDN åŠ é€Ÿ**: é™æ€èµ„æºä½¿ç”¨ CDN
4. **è¿æ¥å¤ç”¨**: ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å»ºç«‹å¼€é”€

**ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–æ•ˆæœ**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **ç½‘ç»œå»¶è¿Ÿ** | 50ms | 10ms | **80%** â¬‡ï¸ |
| **å¸¦å®½ä½¿ç”¨** | 100% | 60% | **40%** â¬‡ï¸ |
| **è¿æ¥å»ºç«‹æ—¶é—´** | 100ms | 10ms | **90%** â¬‡ï¸ |

**ç½‘ç»œé…ç½®ä¼˜åŒ–**:

```sql
-- PostgreSQL ç½‘ç»œé…ç½®ä¼˜åŒ–
-- postgresql.conf

-- TCP è¿æ¥é…ç½®
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

-- è¿æ¥è¶…æ—¶é…ç½®
statement_timeout = 30000  -- 30 ç§’
idle_in_transaction_session_timeout = 60000  -- 60 ç§’
```

**åº”ç”¨å±‚ç½‘ç»œä¼˜åŒ–**:

```python
# Python è¿æ¥æ± é…ç½®ä¼˜åŒ–
import psycopg2
from psycopg2 import pool

# ä¼˜åŒ–è¿æ¥æ± é…ç½®
connection_pool = psycopg2.pool.ThreadedConnectionPool(
    minconn=10,      # æœ€å°è¿æ¥æ•°
    maxconn=100,     # æœ€å¤§è¿æ¥æ•°
    host='db_host',
    port=5432,
    database='vector_db',
    user='user',
    password='password',
    connect_timeout=5,  # è¿æ¥è¶…æ—¶ 5 ç§’
    keepalives=1,       # å¯ç”¨ keepalive
    keepalives_idle=600,
    keepalives_interval=30,
    keepalives_count=3
)
```

---

## 5. ç›‘æ§ä¼˜åŒ–

### 5.1 æ€§èƒ½ç›‘æ§

```sql
-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

### 5.2 èµ„æºç›‘æ§

```sql
-- ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 åˆ†ç‰‡ç­–ç•¥

**åˆ†ç‰‡æ•°é‡é€‰æ‹©**:

| æ•°æ®è§„æ¨¡ | æ¨èåˆ†ç‰‡æ•° | æ¯åˆ†ç‰‡æ•°æ®é‡ | è¯´æ˜ |
|---------|-----------|-------------|------|
| < 1000ä¸‡ | 1-2 | < 1000ä¸‡ | å°è§„æ¨¡æ•°æ® |
| 1000ä¸‡-1äº¿ | 4-8 | 1000-2000ä¸‡ | ä¸­ç­‰è§„æ¨¡æ•°æ® |
| > 1äº¿ | 16-32 | 500-1000ä¸‡ | å¤§è§„æ¨¡æ•°æ® |

**åˆ†ç‰‡é”®é€‰æ‹©**:

```sql
-- æŒ‰ç”¨æˆ· ID åˆ†ç‰‡
CREATE TABLE documents_shard_1 (
    CHECK (user_id % 4 = 0)
) INHERITS (documents);

-- æŒ‰åœ°ç†ä½ç½®åˆ†ç‰‡
CREATE TABLE documents_shard_region_1 (
    CHECK (region = 'us-east')
) INHERITS (documents);
```

### 6.2 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1: æŸå¤§å‹ç”µå•†å¹³å°å¤§è§„æ¨¡å‘é‡æœç´¢ç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**:

- å•†å“æ•°é‡: 1 äº¿+
- å‘é‡ç»´åº¦: 1536
- æŸ¥è¯¢ QPS: 10,000+
- æ•°æ®åˆ†å¸ƒ: å…¨çƒ 5 ä¸ªåŒºåŸŸ

**æŠ€æœ¯æ–¹æ¡ˆ**:

1. **åˆ†ç‰‡ç­–ç•¥**: ä½¿ç”¨ Citus è¿›è¡Œå“ˆå¸Œåˆ†ç‰‡ï¼ŒæŒ‰å•†å“ ID åˆ†ç‰‡åˆ° 32 ä¸ªèŠ‚ç‚¹
2. **è¯»å†™åˆ†ç¦»**: 1 ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥ï¼Œ8 ä¸ªåªè¯»å‰¯æœ¬è´Ÿè´£æŸ¥è¯¢
3. **ç½‘ç»œä¼˜åŒ–**: ä½¿ç”¨ CDN åŠ é€Ÿï¼Œå‡å°‘è·¨åŒºåŸŸæŸ¥è¯¢å»¶è¿Ÿ

**å®æ–½æ•ˆæœ**:

- æŸ¥è¯¢ååé‡: æå‡ **8 å€**ï¼ˆä» 1,250 QPS åˆ° 10,000 QPSï¼‰
- æŸ¥è¯¢å»¶è¿Ÿ: é™ä½ **60%**ï¼ˆä» 50ms åˆ° 20msï¼‰
- ç¡¬ä»¶æˆæœ¬: é™ä½ **30%**ï¼ˆèµ„æºä¼˜åŒ–ï¼‰
- å¸¦å®½æˆæœ¬: é™ä½ **50%**ï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰

#### æ¡ˆä¾‹ 2: ç”µå•†å¹³å°ä¿ƒé”€æœŸé—´åˆ†åŒºè¡¨æ€§èƒ½é—®é¢˜ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**é—®é¢˜æè¿°**:

æŸç”µå•†å¹³å°åœ¨ä¿ƒé”€æœŸé—´ï¼ŒæŸ¥è¯¢æ€§èƒ½ä» 200ms éª¤é™è‡³ 12 ç§’ï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒã€‚

**æ ¹æœ¬åŸå› åˆ†æ**:

1. **åˆ†åŒºç»´æŠ¤ä¸å½“**: æœªåŠæ—¶åˆ é™¤æ—§åˆ†åŒºï¼Œå¯¼è‡´åˆ†åŒºæ•°é‡è¿‡å¤šï¼ˆè¶…è¿‡ 1000 ä¸ªï¼‰
2. **å…¨è¡¨é¡ºåºæ‰«æ**: æŸ¥è¯¢è®¡åˆ’å™¨é€‰æ‹©å…¨è¡¨æ‰«æè€Œéç´¢å¼•æ‰«æ
3. **MVCC æ¸…ç†è´Ÿæ‹…**: å¤§é‡æ—§åˆ†åŒºå¯¼è‡´ MVCC æ¸…ç†è´Ÿæ‹…åŠ é‡

**é—®é¢˜å¤ç°**:

```sql
-- é—®é¢˜åœºæ™¯ï¼šåˆ†åŒºæ•°é‡è¿‡å¤š
SELECT COUNT(*) FROM pg_inherits WHERE inhparent = 'documents'::regclass;
-- ç»“æœï¼š1200+ ä¸ªåˆ†åŒº

-- æŸ¥è¯¢è®¡åˆ’æ˜¾ç¤ºå…¨è¡¨æ‰«æ
EXPLAIN ANALYZE
SELECT * FROM documents
WHERE created_at BETWEEN '2025-01-01' AND '2025-01-31'
ORDER BY embedding <=> query_vector
LIMIT 10;

-- æ‰§è¡Œè®¡åˆ’ï¼š
-- Seq Scan on documents_2025_01 (cost=0.00..123456.78 rows=...)
-- æ‰§è¡Œæ—¶é—´ï¼š12000ms
```

**è§£å†³æ–¹æ¡ˆ**:

1. **åˆ†åŒºæ¸…ç†ç­–ç•¥**:

    ```sql
    -- åˆ›å»ºè‡ªåŠ¨æ¸…ç†æ—§åˆ†åŒºçš„å‡½æ•°
    CREATE OR REPLACE FUNCTION cleanup_old_partitions(
        table_name TEXT,
        retention_months INTEGER DEFAULT 12
    )
    RETURNS void AS $$
    DECLARE
        partition_record RECORD;
        cutoff_date DATE;
    BEGIN
        cutoff_date := CURRENT_DATE - (retention_months || ' months')::INTERVAL;

        -- æŸ¥æ‰¾éœ€è¦åˆ é™¤çš„æ—§åˆ†åŒº
        FOR partition_record IN
            SELECT
                schemaname,
                tablename
            FROM pg_tables
            WHERE tablename LIKE table_name || '_%'
              AND tablename < table_name || '_' || TO_CHAR(cutoff_date, 'YYYY_MM')
        LOOP
            -- åˆ é™¤æ—§åˆ†åŒº
            EXECUTE format('DROP TABLE IF EXISTS %I.%I CASCADE',
                partition_record.schemaname,
                partition_record.tablename
            );

            RAISE NOTICE 'Deleted partition: %.%',
                partition_record.schemaname,
                partition_record.tablename;
        END LOOP;
    END;
    $$ LANGUAGE plpgsql;

    -- å®šæœŸæ‰§è¡Œæ¸…ç†ï¼ˆä½¿ç”¨ pg_cronï¼‰
    SELECT cron.schedule(
        'cleanup-old-partitions',
        '0 2 * * 0',  -- æ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
        $$SELECT cleanup_old_partitions('documents', 12)$$
    );
    ```

2. **åˆ†åŒºæ•°é‡æ§åˆ¶**:

    ```sql
    -- é™åˆ¶åˆ†åŒºæ•°é‡ï¼Œä¿æŒåˆ†åŒºæ•°é‡åœ¨åˆç†èŒƒå›´å†…ï¼ˆ100-1000ï¼‰
    -- å½“åˆ†åŒºæ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåˆå¹¶æ—§åˆ†åŒº

    CREATE OR REPLACE FUNCTION merge_old_partitions(
        table_name TEXT,
        max_partitions INTEGER DEFAULT 500
    )
    RETURNS void AS $$
    DECLARE
        partition_count INTEGER;
        oldest_partition TEXT;
    BEGIN
        -- æ£€æŸ¥å½“å‰åˆ†åŒºæ•°é‡
        SELECT COUNT(*) INTO partition_count
        FROM pg_inherits
        WHERE inhparent = (table_name || '::regclass')::regclass;

        -- å¦‚æœåˆ†åŒºæ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆå¹¶æœ€æ—§çš„åˆ†åŒº
        IF partition_count > max_partitions THEN
            -- æŸ¥æ‰¾æœ€æ—§çš„åˆ†åŒº
            SELECT tablename INTO oldest_partition
            FROM pg_tables
            WHERE tablename LIKE table_name || '_%'
            ORDER BY tablename ASC
            LIMIT 1;

            -- åˆå¹¶åˆ†åŒºé€»è¾‘ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®ç°ï¼‰
            RAISE NOTICE 'Merging partition: %', oldest_partition;
            -- å®ç°åˆå¹¶é€»è¾‘...
        END IF;
    END;
    $$ LANGUAGE plpgsql;
    ```

3. **æŸ¥è¯¢ä¼˜åŒ–**:

    ```sql
    -- ç¡®ä¿æŸ¥è¯¢ä½¿ç”¨åˆ†åŒºè£å‰ª
    SET enable_partition_pruning = on;

    -- åˆ›å»ºç´¢å¼•ç¡®ä¿ä½¿ç”¨ç´¢å¼•æ‰«æ
    CREATE INDEX ON documents (created_at, embedding vector_cosine_ops);

    -- ä¼˜åŒ–åçš„æŸ¥è¯¢è®¡åˆ’
    EXPLAIN ANALYZE
    SELECT * FROM documents
    WHERE created_at BETWEEN '2025-01-01' AND '2025-01-31'
    ORDER BY embedding <=> query_vector
    LIMIT 10;

    -- æ‰§è¡Œè®¡åˆ’ï¼š
    -- Index Scan using documents_2025_01_embedding_idx
    -- æ‰§è¡Œæ—¶é—´ï¼š180ms
    ```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æŸ¥è¯¢å»¶è¿Ÿ** | 12,000ms | 180ms | **98.5%** â¬‡ï¸ |
| **åˆ†åŒºæ•°é‡** | 1,200+ | 120 | **90%** â¬‡ï¸ |
| **æŸ¥è¯¢è®¡åˆ’** | Seq Scan | Index Scan | **ä¼˜åŒ–** |
| **MVCC æ¸…ç†æ—¶é—´** | 8 å°æ—¶ | 30 åˆ†é’Ÿ | **94%** â¬‡ï¸ |

**ç»éªŒæ€»ç»“**:

1. **åˆ†åŒºç»´æŠ¤**: å®šæœŸæ¸…ç†æ—§åˆ†åŒºï¼Œä¿æŒåˆ†åŒºæ•°é‡åœ¨åˆç†èŒƒå›´å†…ï¼ˆ100-1000ï¼‰
2. **åˆ†åŒºè£å‰ª**: ç¡®ä¿æŸ¥è¯¢æ¡ä»¶èƒ½å¤Ÿè§¦å‘åˆ†åŒºè£å‰ª
3. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºåˆé€‚çš„ç´¢å¼•
4. **ç›‘æ§å‘Šè­¦**: è®¾ç½®åˆ†åŒºæ•°é‡ç›‘æ§ï¼ŒåŠæ—¶å‘Šè­¦

#### æ¡ˆä¾‹ 3: IoT åœºæ™¯é«˜ååå†™å…¥ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**:

- è®¾å¤‡æ•°é‡: 100 ä¸‡+
- å†™å…¥é¢‘ç‡: æ¯ç§’ 10 ä¸‡æ¡è®°å½•
- æŸ¥è¯¢éœ€æ±‚: æ—¶é—´åºåˆ—æŸ¥è¯¢ + å‘é‡ç›¸ä¼¼åº¦æœç´¢

**æŠ€æœ¯æ–¹æ¡ˆ**:

1. **åˆ†ç‰‡ç­–ç•¥**: ä½¿ç”¨ TimescaleDB + Citusï¼ŒæŒ‰è®¾å¤‡ ID å“ˆå¸Œåˆ†ç‰‡
2. **å­˜å‚¨ä¼˜åŒ–**: ä½¿ç”¨åˆ—å­˜å‚¨å‹ç¼©å†å²æ•°æ®
3. **å†™å…¥ä¼˜åŒ–**: æ‰¹é‡å†™å…¥ + å¼‚æ­¥æäº¤

**å®æ–½æ•ˆæœ**:

- å†™å…¥åå: ä» 1 ä¸‡/ç§’æå‡åˆ° **10 ä¸‡/ç§’**ï¼ˆ**10 å€**ï¼‰
- æŸ¥è¯¢å»¶è¿Ÿ: ä» 500ms é™ä½åˆ° **50ms**ï¼ˆ**90%** â¬‡ï¸ï¼‰
- å­˜å‚¨æˆæœ¬: é™ä½ **60%**ï¼ˆåˆ—å­˜å‚¨å‹ç¼©ï¼‰

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL åˆ†åŒºè¡¨æ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-partitioning.html)**
  - ç‰ˆæœ¬: PostgreSQL 10+
  - å†…å®¹: PostgreSQL åˆ†åŒºè¡¨çš„å®Œæ•´æ–‡æ¡£
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL é«˜å¯ç”¨æ–‡æ¡£](https://www.postgresql.org/docs/current/high-availability.html)**
  - å†…å®¹: PostgreSQL é«˜å¯ç”¨éƒ¨ç½²çš„å®Œæ•´æŒ‡å—

- **[PostgreSQL æµå¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/warm-standby.html)**
  - å†…å®¹: PostgreSQL æµå¤åˆ¶çš„è¯¦ç»†è¯´æ˜

### 7.2 æŠ€æœ¯åšå®¢

- **[å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡](../æ¶æ„è®¾è®¡/å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡.md)**
  - å†…å®¹: å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡çš„è¯¦ç»†è¯´æ˜

- **[å¤§è§„æ¨¡å‘é‡å­˜å‚¨æ–¹æ¡ˆ](../æ¶æ„è®¾è®¡/å¤§è§„æ¨¡å‘é‡å­˜å‚¨æ–¹æ¡ˆ.md)**
  - å†…å®¹: å¤§è§„æ¨¡å‘é‡å­˜å‚¨æ–¹æ¡ˆçš„è®¾è®¡å’Œå®ç°

### 7.3 ç›¸å…³èµ„æº

- **[PostgreSQL æ€§èƒ½ä¼˜åŒ–](https://www.postgresql.org/docs/current/performance-tips.html)**
  - å†…å®¹: PostgreSQL æ€§èƒ½ä¼˜åŒ–çš„å®Œæ•´æŒ‡å—

- **[PostgreSQL æ‰©å±•æ€§](https://www.postgresql.org/docs/current/scalability.html)**
  - å†…å®¹: PostgreSQL æ‰©å±•æ€§çš„è®¾è®¡å’Œä¼˜åŒ–

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
