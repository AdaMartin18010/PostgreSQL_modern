---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\04-åº”ç”¨åœºæ™¯\é‡‘èé£æ§ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èé£æ§ç³»ç»Ÿ

> **æ–‡æ¡£ç¼–å·**: AI-04-03
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 04-åº”ç”¨åœºæ™¯
> **å­ä¸»é¢˜**: 03-é‡‘èé£æ§ç³»ç»Ÿ

## ğŸ“‘ ç›®å½•

- [é‡‘èé£æ§ç³»ç»Ÿ](#é‡‘èé£æ§ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°](#1-é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°)
    - [1.1 é‡‘èé£æ§ç³»ç»Ÿæ€ç»´å¯¼å›¾](#11-é‡‘èé£æ§ç³»ç»Ÿæ€ç»´å¯¼å›¾)
    - [1.2 ç³»ç»Ÿä»·å€¼](#12-ç³»ç»Ÿä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 ç³»ç»Ÿæ¶æ„](#21-ç³»ç»Ÿæ¶æ„)
    - [2.2 æ•°æ®æµ](#22-æ•°æ®æµ)
  - [3. æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
    - [3.1 äº¤æ˜“è¡¨](#31-äº¤æ˜“è¡¨)
    - [3.2 ç”¨æˆ·è¡Œä¸ºè¡¨](#32-ç”¨æˆ·è¡Œä¸ºè¡¨)
    - [3.3 é£é™©ç‰¹å¾è¡¨](#33-é£é™©ç‰¹å¾è¡¨)
    - [3.4 é£é™©å†³ç­–è¡¨](#34-é£é™©å†³ç­–è¡¨)
  - [4. æ ¸å¿ƒåŠŸèƒ½å®ç°](#4-æ ¸å¿ƒåŠŸèƒ½å®ç°)
    - [4.1 å®æ—¶é£é™©æ£€æµ‹](#41-å®æ—¶é£é™©æ£€æµ‹)
    - [4.2 è¡Œä¸ºæ¨¡å¼åˆ†æ](#42-è¡Œä¸ºæ¨¡å¼åˆ†æ)
    - [4.3 æ¬ºè¯ˆæ£€æµ‹æ¨¡å‹](#43-æ¬ºè¯ˆæ£€æµ‹æ¨¡å‹)
    - [4.4 å†³ç­–å¼•æ“](#44-å†³ç­–å¼•æ“)
  - [5. å®æ—¶å¤„ç†](#5-å®æ—¶å¤„ç†)
    - [5.1 å®æ—¶ç‰¹å¾è®¡ç®—](#51-å®æ—¶ç‰¹å¾è®¡ç®—)
    - [5.2 å®æ—¶é£é™©è¯„ä¼°](#52-å®æ—¶é£é™©è¯„ä¼°)
    - [5.3 å®æ—¶å†³ç­–æ‰§è¡Œ](#53-å®æ—¶å†³ç­–æ‰§è¡Œ)
  - [6. æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
    - [6.1 æŸ¥è¯¢ä¼˜åŒ–](#61-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.2 ç´¢å¼•ä¼˜åŒ–](#62-ç´¢å¼•ä¼˜åŒ–)
    - [6.3 ç¼“å­˜ç­–ç•¥](#63-ç¼“å­˜ç­–ç•¥)
  - [7. ç›‘æ§ä¸å‘Šè­¦](#7-ç›‘æ§ä¸å‘Šè­¦)
    - [7.1 æ€§èƒ½ç›‘æ§](#71-æ€§èƒ½ç›‘æ§)
    - [7.2 é£é™©ç›‘æ§](#72-é£é™©ç›‘æ§)
    - [7.3 å‘Šè­¦æœºåˆ¶](#73-å‘Šè­¦æœºåˆ¶)

---

## 1. é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°

### 1.1 é‡‘èé£æ§ç³»ç»Ÿæ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é‡‘èé£æ§ç³»ç»Ÿ))
    æ ¸å¿ƒåŠŸèƒ½
      å®æ—¶é£é™©æ£€æµ‹
        äº¤æ˜“ç›‘æ§
        è¡Œä¸ºåˆ†æ
        å¼‚å¸¸è¯†åˆ«
      æ¬ºè¯ˆæ£€æµ‹
        æœºå™¨å­¦ä¹ æ¨¡å‹
        è§„åˆ™å¼•æ“
        è¯„åˆ†ç³»ç»Ÿ
      å†³ç­–å¼•æ“
        é£é™©è¯„åˆ†
        è‡ªåŠ¨å†³ç­–
        äººå·¥å®¡æ ¸
    æŠ€æœ¯å®ç°
      PostgreSQL
        PostgresMLæ¨¡å‹è®­ç»ƒ
        pgvectorè¡Œä¸ºåˆ†æ
        ACIDäº‹åŠ¡ä¿è¯
      å®æ—¶å¤„ç†
        æµå¼å¤„ç†
        ç‰¹å¾è®¡ç®—
        å†³ç­–æ‰§è¡Œ
```

### 1.2 ç³»ç»Ÿä»·å€¼

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

- âœ… **å®æ—¶æ£€æµ‹**ï¼šæ¯«ç§’çº§é£é™©æ£€æµ‹
- âœ… **é«˜å‡†ç¡®ç‡**ï¼šæœºå™¨å­¦ä¹ æ¨¡å‹å‡†ç¡®ç‡95%+
- âœ… **å¼ºä¸€è‡´æ€§**ï¼šACIDäº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… **æˆæœ¬é™ä½**ï¼šå‡å°‘æ¬ºè¯ˆæŸå¤±70%+

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 ç³»ç»Ÿæ¶æ„

**é‡‘èé£æ§ç³»ç»Ÿæ¶æ„**ï¼š

```mermaid
graph TB
    subgraph "æ•°æ®é‡‡é›†å±‚"
        Transaction[äº¤æ˜“æ•°æ®]
        Behavior[è¡Œä¸ºæ•°æ®]
        History[å†å²æ•°æ®]
    end

    subgraph "å®æ—¶å¤„ç†å±‚"
        Stream[æµå¼å¤„ç†]
        Feature[ç‰¹å¾è®¡ç®—]
        Model[æ¨¡å‹æ¨ç†]
    end

    subgraph "PostgreSQLæ ¸å¿ƒ"
        PG[(PostgreSQL)]
        ML[PostgresMLæ¨¡å‹]
        Vec[pgvectorè¡Œä¸ºå‘é‡]
        Rule[è§„åˆ™å¼•æ“]
    end

    subgraph "å†³ç­–å±‚"
        Score[é£é™©è¯„åˆ†]
        Decision[å†³ç­–å¼•æ“]
        Alert[å‘Šè­¦ç³»ç»Ÿ]
    end

    Transaction --> Stream
    Behavior --> Stream
    Stream --> Feature
    Feature --> PG
    PG --> ML
    PG --> Vec
    PG --> Rule
    ML --> Score
    Vec --> Score
    Rule --> Score
    Score --> Decision
    Decision --> Alert

    style PG fill:#4a90e2,color:#fff
    style ML fill:#50c878,color:#fff
```

### 2.2 æ•°æ®æµ

**é£æ§ç³»ç»Ÿæ•°æ®æµ**ï¼š

```text
1. äº¤æ˜“æ•°æ®é‡‡é›† â†’ å®æ—¶æµå¼å¤„ç†
2. ç‰¹å¾æå– â†’ PostgreSQLå®æ—¶è®¡ç®—
3. è¡Œä¸ºå‘é‡åŒ– â†’ pgvectorç›¸ä¼¼åº¦åˆ†æ
4. æ¨¡å‹æ¨ç† â†’ PostgresMLå®æ—¶é¢„æµ‹
5. é£é™©è¯„åˆ† â†’ ç»¼åˆè¯„åˆ†è®¡ç®—
6. å†³ç­–æ‰§è¡Œ â†’ é€šè¿‡/æ‹’ç»/äººå·¥å®¡æ ¸
7. ç»“æœå­˜å‚¨ â†’ PostgreSQLäº‹åŠ¡ä¿è¯
```

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 äº¤æ˜“è¡¨

**äº¤æ˜“è¡¨ç»“æ„**ï¼š

```sql
-- 1. äº¤æ˜“ä¸»è¡¨
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    merchant_id INT,
    transaction_type TEXT,  -- payment, transfer, withdrawal
    payment_method TEXT,  -- card, mobile, online
    location GEOGRAPHY(POINT, 4326),  -- PostGISåœ°ç†ä½ç½®
    device_id TEXT,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    risk_score DECIMAL(5, 4),  -- é£é™©è¯„åˆ†
    status TEXT DEFAULT 'pending'  -- pending, approved, rejected, reviewed
);

-- 2. äº¤æ˜“ç‰¹å¾è¡¨
CREATE TABLE transaction_features (
    transaction_id INT PRIMARY KEY REFERENCES transactions(id),
    -- æ—¶é—´ç‰¹å¾
    hour_of_day INT,
    day_of_week INT,
    is_weekend BOOLEAN,
    -- é‡‘é¢ç‰¹å¾
    amount_normalized DECIMAL(10, 4),
    amount_deviation DECIMAL(10, 4),  -- åç¦»å¹³å‡å€¼çš„ç¨‹åº¦
    -- è¡Œä¸ºç‰¹å¾
    transaction_count_24h INT,
    transaction_count_7d INT,
    avg_amount_30d DECIMAL(15, 2),
    -- å‘é‡ç‰¹å¾
    behavior_vec vector(768),  -- ç”¨æˆ·è¡Œä¸ºå‘é‡
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX ON transactions (user_id, created_at DESC);
CREATE INDEX ON transactions (status, created_at DESC);
CREATE INDEX ON transactions USING GIST(location);
CREATE INDEX ON transaction_features USING hnsw(behavior_vec vector_cosine_ops);
```

### 3.2 ç”¨æˆ·è¡Œä¸ºè¡¨

**ç”¨æˆ·è¡Œä¸ºè¡¨ç»“æ„**ï¼š

```sql
-- ç”¨æˆ·è¡Œä¸ºè¡¨
CREATE TABLE user_behaviors (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    behavior_type TEXT,  -- login, transaction, query, etc.
    behavior_data JSONB,  -- è¡Œä¸ºæ•°æ®
    behavior_vec vector(768),  -- è¡Œä¸ºå‘é‡
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- ç”¨æˆ·è¡Œä¸ºå‘é‡è¡¨ï¼ˆç”¨äºç›¸ä¼¼åº¦åˆ†æï¼‰
CREATE TABLE user_behavior_vectors (
    user_id INT PRIMARY KEY,
    behavior_vec vector(768),  -- ç”¨æˆ·è¡Œä¸ºå‘é‡
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON user_behaviors (user_id, timestamp DESC);
CREATE INDEX ON user_behaviors USING hnsw(behavior_vec vector_cosine_ops);
CREATE INDEX ON user_behavior_vectors USING hnsw(behavior_vec vector_cosine_ops);
```

### 3.3 é£é™©ç‰¹å¾è¡¨

**é£é™©ç‰¹å¾è¡¨ç»“æ„**ï¼š

```sql
-- é£é™©ç‰¹å¾è¡¨
CREATE TABLE risk_features (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    feature_name TEXT NOT NULL,
    feature_value DECIMAL(15, 4),
    feature_type TEXT,  -- statistical, behavioral, temporal
    calculated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, feature_name, calculated_at)
);

-- é£é™©ç‰¹å¾ç´¢å¼•
CREATE INDEX ON risk_features (user_id, calculated_at DESC);
CREATE INDEX ON risk_features (feature_name, calculated_at DESC);
```

### 3.4 é£é™©å†³ç­–è¡¨

**é£é™©å†³ç­–è¡¨ç»“æ„**ï¼š

```sql
-- é£é™©å†³ç­–è¡¨
CREATE TABLE risk_decisions (
    id SERIAL PRIMARY KEY,
    transaction_id INT REFERENCES transactions(id),
    user_id INT NOT NULL,
    risk_score DECIMAL(5, 4) NOT NULL,
    model_score DECIMAL(5, 4),  -- æ¨¡å‹è¯„åˆ†
    rule_score DECIMAL(5, 4),  -- è§„åˆ™è¯„åˆ†
    behavior_score DECIMAL(5, 4),  -- è¡Œä¸ºè¯„åˆ†
    decision TEXT NOT NULL,  -- approved, rejected, review
    decision_reason TEXT,
    reviewed_by INT,  -- å®¡æ ¸äººå‘˜ID
    reviewed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å†³ç­–ç´¢å¼•
CREATE INDEX ON risk_decisions (transaction_id);
CREATE INDEX ON risk_decisions (user_id, created_at DESC);
CREATE INDEX ON risk_decisions (decision, created_at DESC);
```

---

## 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 å®æ—¶é£é™©æ£€æµ‹

**å®æ—¶é£é™©æ£€æµ‹æµç¨‹**ï¼š

```sql
-- 1. å®æ—¶ç‰¹å¾è®¡ç®—
CREATE OR REPLACE FUNCTION calculate_risk_features(
    p_transaction_id INT,
    p_user_id INT,
    p_amount DECIMAL,
    p_timestamp TIMESTAMPTZ
)
RETURNS void AS $$
DECLARE
    v_transaction_count_24h INT;
    v_avg_amount_30d DECIMAL;
    v_amount_deviation DECIMAL;
BEGIN
    -- è®¡ç®—24å°æ—¶å†…äº¤æ˜“æ¬¡æ•°
    SELECT COUNT(*) INTO v_transaction_count_24h
    FROM transactions
    WHERE user_id = p_user_id
      AND created_at > p_timestamp - INTERVAL '24 hours';

    -- è®¡ç®—30å¤©å¹³å‡é‡‘é¢
    SELECT AVG(amount) INTO v_avg_amount_30d
    FROM transactions
    WHERE user_id = p_user_id
      AND created_at > p_timestamp - INTERVAL '30 days'
      AND status = 'approved';

    -- è®¡ç®—é‡‘é¢åç¦»åº¦
    v_amount_deviation = ABS(p_amount - COALESCE(v_avg_amount_30d, 0)) /
                         NULLIF(v_avg_amount_30d, 0);

    -- ä¿å­˜ç‰¹å¾
    INSERT INTO transaction_features (
        transaction_id,
        hour_of_day,
        day_of_week,
        is_weekend,
        amount_normalized,
        amount_deviation,
        transaction_count_24h,
        avg_amount_30d
    )
    VALUES (
        p_transaction_id,
        EXTRACT(HOUR FROM p_timestamp),
        EXTRACT(DOW FROM p_timestamp),
        EXTRACT(DOW FROM p_timestamp) IN (0, 6),
        p_amount / NULLIF(v_avg_amount_30d, 1),
        v_amount_deviation,
        v_transaction_count_24h,
        v_avg_amount_30d
    );
END;
$$ LANGUAGE plpgsql;
```

### 4.2 è¡Œä¸ºæ¨¡å¼åˆ†æ

**è¡Œä¸ºæ¨¡å¼ç›¸ä¼¼åº¦åˆ†æ**ï¼š

```sql
-- æ£€æµ‹å¼‚å¸¸è¡Œä¸ºæ¨¡å¼
WITH current_user_behavior AS (
    SELECT behavior_vec
    FROM user_behavior_vectors
    WHERE user_id = $1
),
similar_users AS (
    SELECT
        ubv.user_id,
        1 - (ubv.behavior_vec <=> cub.behavior_vec) AS similarity
    FROM user_behavior_vectors ubv, current_user_behavior cub
    WHERE ubv.user_id != $1
      AND 1 - (ubv.behavior_vec <=> cub.behavior_vec) > 0.8
    ORDER BY ubv.behavior_vec <=> cub.behavior_vec
    LIMIT 100
),
fraud_rate AS (
    SELECT
        AVG(CASE WHEN rd.decision = 'rejected' THEN 1.0 ELSE 0.0 END) AS fraud_rate
    FROM similar_users su
    JOIN risk_decisions rd ON rd.user_id = su.user_id
    WHERE rd.created_at > NOW() - INTERVAL '30 days'
)
SELECT
    CASE
        WHEN fraud_rate > 0.3 THEN 'high_risk'
        WHEN fraud_rate > 0.1 THEN 'medium_risk'
        ELSE 'low_risk'
    END AS risk_level
FROM fraud_rate;

-- æ€§èƒ½æµ‹è¯•ï¼šè¡Œä¸ºæ¨¡å¼ç›¸ä¼¼åº¦åˆ†ææŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH current_user_behavior AS (
    SELECT behavior_vec
    FROM user_behavior_vectors
    WHERE user_id = $1
),
similar_users AS (
    SELECT
        ubv.user_id,
        1 - (ubv.behavior_vec <=> cub.behavior_vec) AS similarity
    FROM user_behavior_vectors ubv, current_user_behavior cub
    WHERE ubv.user_id != $1
      AND 1 - (ubv.behavior_vec <=> cub.behavior_vec) > 0.8
    ORDER BY ubv.behavior_vec <=> cub.behavior_vec
    LIMIT 100
),
fraud_rate AS (
    SELECT
        AVG(CASE WHEN rd.decision = 'rejected' THEN 1.0 ELSE 0.0 END) AS fraud_rate
    FROM similar_users su
    JOIN risk_decisions rd ON rd.user_id = su.user_id
    WHERE rd.created_at > NOW() - INTERVAL '30 days'
)
SELECT
    CASE
        WHEN fraud_rate > 0.3 THEN 'high_risk'
        WHEN fraud_rate > 0.1 THEN 'medium_risk'
        ELSE 'low_risk'
    END AS risk_level
FROM fraud_rate;
```

### 4.3 æ¬ºè¯ˆæ£€æµ‹æ¨¡å‹

**PostgresMLæ¬ºè¯ˆæ£€æµ‹æ¨¡å‹**ï¼š

```sql
-- 1. è®­ç»ƒæ¬ºè¯ˆæ£€æµ‹æ¨¡å‹
SELECT * FROM pgml.train(
    project_name => 'fraud_detection',
    task => 'classification',
    relation_name => 'transactions',
    y_column_name => 'is_fraud',
    algorithm => 'xgboost',
    hyperparams => '{
        "n_estimators": 100,
        "max_depth": 6,
        "learning_rate": 0.1
    }'
);

-- 2. å®æ—¶æ¬ºè¯ˆæ£€æµ‹
SELECT
    transaction_id,
    amount,
    pgml.predict(
        'fraud_detection',
        ARRAY[
            amount,
            hour_of_day,
            day_of_week,
            transaction_count_24h,
            amount_deviation
        ]
    ) AS fraud_probability
FROM transactions t
JOIN transaction_features tf ON tf.transaction_id = t.id
WHERE t.id = $1;
```

### 4.4 å†³ç­–å¼•æ“

**ç»¼åˆå†³ç­–å¼•æ“**ï¼š

```sql
CREATE OR REPLACE FUNCTION risk_decision_engine(
    p_transaction_id INT
)
RETURNS TEXT AS $$
DECLARE
    v_model_score DECIMAL;
    v_rule_score DECIMAL;
    v_behavior_score DECIMAL;
    v_final_score DECIMAL;
    v_decision TEXT;
BEGIN
    -- 1. æ¨¡å‹è¯„åˆ†
-- æ€§èƒ½æµ‹è¯•ï¼šå®æ—¶æ¬ºè¯ˆæ£€æµ‹æ¨ç†æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    transaction_id,
    amount,
    pgml.predict_proba(
        'fraud_detection',
        (SELECT ARRAY[
            amount,
            hour_of_day,
            day_of_week,
            transaction_count_24h,
            amount_deviation
        ] FROM transactions t
         JOIN transaction_features tf ON tf.transaction_id = t.id
         WHERE t.id = p_transaction_id)
    ) INTO v_model_score;

    -- 2. è§„åˆ™è¯„åˆ†
    SELECT CASE
        WHEN amount > 10000 THEN 0.8
        WHEN transaction_count_24h > 10 THEN 0.7
        WHEN amount_deviation > 3 THEN 0.6
        ELSE 0.1
    END INTO v_rule_score
    FROM transaction_features
    WHERE transaction_id = p_transaction_id;

    -- 3. è¡Œä¸ºè¯„åˆ†ï¼ˆåŸºäºç›¸ä¼¼ç”¨æˆ·ï¼‰
    -- ... çœç•¥è¡Œä¸ºè¯„åˆ†è®¡ç®— ...

    -- 4. ç»¼åˆè¯„åˆ†
    v_final_score = v_model_score * 0.6 + v_rule_score * 0.3 + v_behavior_score * 0.1;

    -- 5. å†³ç­–
    IF v_final_score > 0.8 THEN
        v_decision = 'rejected';
    ELSIF v_final_score > 0.5 THEN
        v_decision = 'review';
    ELSE
        v_decision = 'approved';
    END IF;

    -- 6. ä¿å­˜å†³ç­–
    INSERT INTO risk_decisions (
        transaction_id,
        user_id,
        risk_score,
        model_score,
        rule_score,
        behavior_score,
        decision
    )
    SELECT
        p_transaction_id,
        user_id,
        v_final_score,
        v_model_score,
        v_rule_score,
        v_behavior_score,
        v_decision
    FROM transactions
    WHERE id = p_transaction_id;

    -- 7. æ›´æ–°äº¤æ˜“çŠ¶æ€
    UPDATE transactions
    SET status = v_decision, risk_score = v_final_score
    WHERE id = p_transaction_id;

    RETURN v_decision;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. å®æ—¶å¤„ç†

### 5.1 å®æ—¶ç‰¹å¾è®¡ç®—

**å®æ—¶ç‰¹å¾è®¡ç®—è§¦å‘å™¨**ï¼š

```sql
-- äº¤æ˜“æ’å…¥æ—¶è‡ªåŠ¨è®¡ç®—ç‰¹å¾
CREATE OR REPLACE FUNCTION auto_calculate_features()
RETURNS TRIGGER AS $$
BEGIN
    PERFORM calculate_risk_features(
        NEW.id,
        NEW.user_id,
        NEW.amount,
        NEW.created_at
    );

    -- æ›´æ–°ç”¨æˆ·è¡Œä¸ºå‘é‡
    UPDATE user_behavior_vectors
    SET behavior_vec = (
        SELECT AVG(behavior_vec)
        FROM user_behaviors
        WHERE user_id = NEW.user_id
          AND timestamp > NOW() - INTERVAL '30 days'
    ),
    updated_at = NOW()
    WHERE user_id = NEW.user_id;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER transaction_features_trigger
AFTER INSERT ON transactions
FOR EACH ROW
EXECUTE FUNCTION auto_calculate_features();
```

### 5.2 å®æ—¶é£é™©è¯„ä¼°

**å®æ—¶é£é™©è¯„ä¼°æµç¨‹**ï¼š

```sql
-- å®æ—¶é£é™©è¯„ä¼°å‡½æ•°
CREATE OR REPLACE FUNCTION realtime_risk_assessment(
    p_transaction_id INT
)
RETURNS TABLE(risk_score DECIMAL, decision TEXT) AS $$
BEGIN
    -- 1. è®¡ç®—ç‰¹å¾
    PERFORM calculate_risk_features(
        (SELECT user_id FROM transactions WHERE id = p_transaction_id),
        (SELECT amount FROM transactions WHERE id = p_transaction_id),
        (SELECT created_at FROM transactions WHERE id = p_transaction_id)
    );

    -- 2. æ‰§è¡Œå†³ç­–
    RETURN QUERY
    SELECT
        rd.risk_score,
        rd.decision
    FROM risk_decision_engine(p_transaction_id) AS decision_result
    JOIN risk_decisions rd ON rd.transaction_id = p_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 å®æ—¶å†³ç­–æ‰§è¡Œ

**å®æ—¶å†³ç­–æ‰§è¡Œ**ï¼š

```sql
-- äº¤æ˜“å¤„ç†æµç¨‹
BEGIN;
    -- 1. æ’å…¥äº¤æ˜“
    INSERT INTO transactions (user_id, amount, merchant_id, ...)
    VALUES ($1, $2, $3, ...)
    RETURNING id INTO transaction_id;

    -- 2. å®æ—¶é£é™©è¯„ä¼°
    SELECT * INTO risk_result
    FROM realtime_risk_assessment(transaction_id);

    -- 3. æ ¹æ®å†³ç­–æ‰§è¡Œ
    IF risk_result.decision = 'approved' THEN
        -- æ‰§è¡Œäº¤æ˜“
        UPDATE transactions SET status = 'approved' WHERE id = transaction_id;
    ELSIF risk_result.decision = 'rejected' THEN
        -- æ‹’ç»äº¤æ˜“
        UPDATE transactions SET status = 'rejected' WHERE id = transaction_id;
        -- å‘é€å‘Šè­¦
        PERFORM send_alert(transaction_id, 'fraud_detected');
    ELSE
        -- äººå·¥å®¡æ ¸
        UPDATE transactions SET status = 'pending_review' WHERE id = transaction_id;
    END IF;
COMMIT;
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- 1. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—ç‰¹å¾
CREATE MATERIALIZED VIEW user_risk_profiles AS
SELECT
    user_id,
    AVG(risk_score) AS avg_risk_score,
    COUNT(*) FILTER (WHERE decision = 'rejected') AS rejection_count,
    MAX(created_at) AS last_transaction_at
FROM risk_decisions
GROUP BY user_id;

CREATE INDEX ON user_risk_profiles (user_id);

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY user_risk_profiles;
```

### 6.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- 1. å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX ON transactions (user_id, created_at DESC, status);

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•å¾…å¤„ç†äº¤æ˜“ï¼‰
CREATE INDEX ON transactions (id, risk_score)
WHERE status = 'pending';

-- 3. è¡¨è¾¾å¼ç´¢å¼•ï¼ˆæ—¶é—´ç‰¹å¾ï¼‰
CREATE INDEX ON transactions ((EXTRACT(HOUR FROM created_at)));
```

### 6.3 ç¼“å­˜ç­–ç•¥

**ç¼“å­˜ç­–ç•¥**ï¼š

```sql
-- 1. ç”¨æˆ·é£é™©ç”»åƒç¼“å­˜
CREATE TABLE user_risk_cache (
    user_id INT PRIMARY KEY,
    risk_profile JSONB,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);

-- 2. æ¨¡å‹é¢„æµ‹ç»“æœç¼“å­˜
CREATE TABLE model_prediction_cache (
    feature_hash TEXT PRIMARY KEY,
    prediction DECIMAL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 7. ç›‘æ§ä¸å‘Šè­¦

### 7.1 æ€§èƒ½ç›‘æ§

**æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- 1. æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE query LIKE '%risk%' OR query LIKE '%fraud%'
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. äº¤æ˜“å¤„ç†å»¶è¿Ÿ
SELECT
    DATE(created_at) AS date,
    AVG(EXTRACT(EPOCH FROM (decision_time - created_at))) AS avg_delay_ms
FROM transactions t
JOIN risk_decisions rd ON rd.transaction_id = t.id
WHERE t.created_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at);
```

### 7.2 é£é™©ç›‘æ§

**é£é™©ç›‘æ§**ï¼š

```sql
-- 1. é£é™©è¶‹åŠ¿ç›‘æ§
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS total_transactions,
    COUNT(*) FILTER (WHERE decision = 'rejected') AS rejected_count,
    AVG(risk_score) AS avg_risk_score
FROM risk_decisions
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 2. é«˜é£é™©ç”¨æˆ·ç›‘æ§
SELECT
    user_id,
    COUNT(*) AS transaction_count,
    AVG(risk_score) AS avg_risk_score,
    COUNT(*) FILTER (WHERE decision = 'rejected') AS rejection_count
FROM risk_decisions
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY user_id
HAVING AVG(risk_score) > 0.7
ORDER BY avg_risk_score DESC;
```

### 7.3 å‘Šè­¦æœºåˆ¶

**å‘Šè­¦æœºåˆ¶**ï¼š

```sql
-- 1. é«˜é£é™©äº¤æ˜“å‘Šè­¦
CREATE OR REPLACE FUNCTION check_high_risk_transactions()
RETURNS void AS $$
DECLARE
    high_risk_count INT;
BEGIN
    SELECT COUNT(*) INTO high_risk_count
    FROM risk_decisions
    WHERE risk_score > 0.8
      AND created_at > NOW() - INTERVAL '1 hour';

    IF high_risk_count > 10 THEN
        -- å‘é€å‘Šè­¦
        PERFORM pg_notify('high_risk_alert',
            json_build_object(
                'count', high_risk_count,
                'timestamp', NOW()
            )::text
        );
    END IF;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶æ£€æŸ¥ï¼ˆä½¿ç”¨pg_cronï¼‰
SELECT cron.schedule(
    'check-high-risk',
    '*/5 * * * *',  -- æ¯5åˆ†é’Ÿ
    'SELECT check_high_risk_transactions();'
);
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-04-03
