---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_AI\04-åº”ç”¨åœºæ™¯\æ™ºèƒ½æ¨èç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½æ¨èç³»ç»Ÿ

> **æ–‡æ¡£ç¼–å·**: AI-04-02
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 04-åº”ç”¨åœºæ™¯
> **å­ä¸»é¢˜**: 02-æ™ºèƒ½æ¨èç³»ç»Ÿ

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½æ¨èç³»ç»Ÿ](#æ™ºèƒ½æ¨èç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¨èç³»ç»Ÿæ¦‚è¿°](#1-æ¨èç³»ç»Ÿæ¦‚è¿°)
    - [1.1 æ¨èç³»ç»Ÿæ€ç»´å¯¼å›¾](#11-æ¨èç³»ç»Ÿæ€ç»´å¯¼å›¾)
    - [1.2 æ¨èç³»ç»Ÿç®€ä»‹](#12-æ¨èç³»ç»Ÿç®€ä»‹)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 ç³»ç»Ÿæ¶æ„](#21-ç³»ç»Ÿæ¶æ„)
    - [2.2 æ•°æ®æµ](#22-æ•°æ®æµ)
  - [3. æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
    - [3.1 ç”¨æˆ·è¡Œä¸ºè¡¨](#31-ç”¨æˆ·è¡Œä¸ºè¡¨)
    - [3.2 å•†å“/å†…å®¹è¡¨](#32-å•†å“å†…å®¹è¡¨)
    - [3.3 æ¨èç»“æœè¡¨](#33-æ¨èç»“æœè¡¨)
  - [4. æ¨èç®—æ³•å®ç°](#4-æ¨èç®—æ³•å®ç°)
    - [4.1 ååŒè¿‡æ»¤](#41-ååŒè¿‡æ»¤)
    - [4.2 å†…å®¹æ¨è](#42-å†…å®¹æ¨è)
  - [5. å®æ—¶æ¨è](#5-å®æ—¶æ¨è)
    - [5.1 å®æ—¶ç‰¹å¾è®¡ç®—](#51-å®æ—¶ç‰¹å¾è®¡ç®—)
    - [5.2 å®æ—¶æ¨èç”Ÿæˆ](#52-å®æ—¶æ¨èç”Ÿæˆ)
    - [5.3 æ¨èç»“æœç¼“å­˜](#53-æ¨èç»“æœç¼“å­˜)
  - [6. æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
    - [6.1 å‘é‡ç´¢å¼•ä¼˜åŒ–](#61-å‘é‡ç´¢å¼•ä¼˜åŒ–)
    - [6.2 æŸ¥è¯¢ä¼˜åŒ–](#62-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.3 ç¼“å­˜ç­–ç•¥](#63-ç¼“å­˜ç­–ç•¥)
  - [7. è¯„ä¼°ä¸ä¼˜åŒ–](#7-è¯„ä¼°ä¸ä¼˜åŒ–)
    - [7.1 è¯„ä¼°æŒ‡æ ‡](#71-è¯„ä¼°æŒ‡æ ‡)
    - [7.2 A/Bæµ‹è¯•](#72-abæµ‹è¯•)

---

## 1. æ¨èç³»ç»Ÿæ¦‚è¿°

### 1.1 æ¨èç³»ç»Ÿæ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½æ¨èç³»ç»Ÿ))
    æ¨èç®—æ³•
      ååŒè¿‡æ»¤
        ç”¨æˆ·ååŒè¿‡æ»¤
        ç‰©å“ååŒè¿‡æ»¤
      å†…å®¹æ¨è
        ç‰¹å¾åŒ¹é…
        ç›¸ä¼¼åº¦è®¡ç®—
      æ··åˆæ¨è
        åŠ æƒèåˆ
        åˆ‡æ¢ç­–ç•¥
    æŠ€æœ¯å®ç°
      PostgreSQL
        pgvectorå‘é‡æœç´¢
        PostgresMLæ¨¡å‹è®­ç»ƒ
        JSONBç‰¹å¾å­˜å‚¨
      å®æ—¶è®¡ç®—
        æµå¼å¤„ç†
        å¢é‡æ›´æ–°
    åº”ç”¨åœºæ™¯
      ç”µå•†æ¨è
      å†…å®¹æ¨è
      ç¤¾äº¤æ¨è
```

### 1.2 æ¨èç³»ç»Ÿç®€ä»‹

**æ™ºèƒ½æ¨èç³»ç»Ÿ**æ˜¯åŸºäºç”¨æˆ·å†å²è¡Œä¸ºã€å†…å®¹ç‰¹å¾å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æ¨èå¯èƒ½æ„Ÿå…´è¶£çš„å•†å“ã€å†…å®¹æˆ–æœåŠ¡çš„ç³»ç»Ÿã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š

- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼šä¸ªæ€§åŒ–æ¨è
- âœ… å¢åŠ è½¬åŒ–ç‡ï¼šç²¾å‡†è¥é”€
- âœ… æé«˜ç•™å­˜ç‡ï¼šç”¨æˆ·ç²˜æ€§
- âœ… æ•°æ®é©±åŠ¨ï¼šåŸºäºçœŸå®è¡Œä¸ºæ•°æ®

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 ç³»ç»Ÿæ¶æ„

**æ¨èç³»ç»Ÿæ¶æ„å›¾**ï¼š

```mermaid
graph TB
    subgraph "æ•°æ®å±‚"
        User[ç”¨æˆ·æ•°æ®]
        Item[å•†å“/å†…å®¹æ•°æ®]
        Behavior[è¡Œä¸ºæ•°æ®]
    end

    subgraph "ç‰¹å¾å±‚"
        UserVec[ç”¨æˆ·å‘é‡]
        ItemVec[å•†å“å‘é‡]
        Features[ç‰¹å¾å·¥ç¨‹]
    end

    subgraph "æ¨¡å‹å±‚"
        CF[ååŒè¿‡æ»¤]
        Content[å†…å®¹æ¨è]
        Hybrid[æ··åˆæ¨è]
    end

    subgraph "æœåŠ¡å±‚"
        API[æ¨èAPI]
        Cache[ç¼“å­˜å±‚]
    end

    User --> UserVec
    Item --> ItemVec
    Behavior --> Features
    UserVec --> CF
    ItemVec --> Content
    CF --> Hybrid
    Content --> Hybrid
    Hybrid --> API
    API --> Cache

    style Hybrid fill:#4a90e2,color:#fff
    style API fill:#50c878,color:#fff
```

### 2.2 æ•°æ®æµ

**æ¨èç³»ç»Ÿæ•°æ®æµ**ï¼š

```text
1. æ•°æ®æ”¶é›†ï¼š
   ç”¨æˆ·è¡Œä¸º â†’ å®æ—¶é‡‡é›† â†’ PostgreSQLå­˜å‚¨

2. ç‰¹å¾è®¡ç®—ï¼š
   åŸå§‹æ•°æ® â†’ ç‰¹å¾å·¥ç¨‹ â†’ å‘é‡åŒ– â†’ pgvectorå­˜å‚¨

3. æ¨¡å‹è®­ç»ƒï¼š
   å†å²æ•°æ® â†’ PostgresMLè®­ç»ƒ â†’ æ¨¡å‹éƒ¨ç½²

4. æ¨èç”Ÿæˆï¼š
   ç”¨æˆ·è¯·æ±‚ â†’ ç‰¹å¾æå– â†’ æ¨¡å‹æ¨ç† â†’ ç»“æœæ’åº â†’ æ¨èè¿”å›
```

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 ç”¨æˆ·è¡Œä¸ºè¡¨

**æ ¸å¿ƒè¡¨ç»“æ„**ï¼š

```sql
-- 1. ç”¨æˆ·è¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    profile JSONB,  -- ç”¨æˆ·ç”»åƒ
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. å•†å“/å†…å®¹è¡¨
CREATE TABLE items (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    category_id INT,
    feature_vec vector(768),  -- å•†å“ç‰¹å¾å‘é‡
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. ç”¨æˆ·è¡Œä¸ºè¡¨
CREATE TABLE user_behaviors (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    item_id INT REFERENCES items(id),
    behavior_type TEXT,  -- view, click, purchase, rating
    rating INT,  -- 1-5è¯„åˆ†
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    context JSONB  -- ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆè®¾å¤‡ã€ä½ç½®ç­‰ï¼‰
);

-- 4. ç”¨æˆ·è¡Œä¸ºå‘é‡è¡¨ï¼ˆç”¨äºååŒè¿‡æ»¤ï¼‰
CREATE TABLE user_behavior_vectors (
    user_id INT PRIMARY KEY REFERENCES users(id),
    behavior_vec vector(768),  -- ç”¨æˆ·è¡Œä¸ºå‘é‡
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. åˆ›å»ºç´¢å¼•
CREATE INDEX ON items USING hnsw(feature_vec vector_cosine_ops);
CREATE INDEX ON user_behaviors (user_id, timestamp DESC);
CREATE INDEX ON user_behaviors (item_id, timestamp DESC);
```

### 3.2 å•†å“/å†…å®¹è¡¨

**å•†å“ç‰¹å¾å‘é‡ç”Ÿæˆ**ï¼š

```sql
-- ä½¿ç”¨pg_aiè‡ªåŠ¨ç”Ÿæˆå•†å“ç‰¹å¾å‘é‡
SELECT ai.create_vectorizer(
    'items'::regclass,
    destination => 'item_feature_vectors',
    embedding => ai.embedding_openai('text-embedding-3-small', 'title || description'),
    chunking => NULL  -- å•†å“æè¿°è¾ƒçŸ­ï¼Œä¸éœ€è¦åˆ†å—
);

-- æ’å…¥å•†å“ï¼Œè‡ªåŠ¨ç”Ÿæˆå‘é‡
INSERT INTO items(title, description, category_id)
VALUES (
    'PostgreSQL Performance Guide',
    'Complete guide to optimizing PostgreSQL...',
    1
);
-- è‡ªåŠ¨ç”Ÿæˆfeature_vec
```

### 3.3 æ¨èç»“æœè¡¨

**æ¨èç»“æœå­˜å‚¨**ï¼š

```sql
-- æ¨èç»“æœè¡¨
CREATE TABLE recommendations (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    item_id INT REFERENCES items(id),
    score DECIMAL(5, 4),  -- æ¨èåˆ†æ•°
    algorithm TEXT,  -- ä½¿ç”¨çš„ç®—æ³•
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ  -- æ¨èè¿‡æœŸæ—¶é—´
);

-- ç´¢å¼•
CREATE INDEX ON recommendations (user_id, score DESC, created_at DESC);
CREATE INDEX ON recommendations (expires_at) WHERE expires_at < NOW();
```

---

## 4. æ¨èç®—æ³•å®ç°

### 4.1 ååŒè¿‡æ»¤

**ç”¨æˆ·ååŒè¿‡æ»¤**ï¼š

```sql
-- 1. è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦
WITH target_user AS (
    SELECT behavior_vec FROM user_behavior_vectors WHERE user_id = 123
),
similar_users AS (
    SELECT
        ubv.user_id,
        1 - (ubv.behavior_vec <=> tu.behavior_vec) AS similarity
    FROM user_behavior_vectors ubv, target_user tu
    WHERE ubv.user_id != 123
      AND 1 - (ubv.behavior_vec <=> tu.behavior_vec) > 0.7
    ORDER BY ubv.behavior_vec <=> tu.behavior_vec
    LIMIT 100
)
-- 2. æ¨èç›¸ä¼¼ç”¨æˆ·å–œæ¬¢çš„å•†å“
SELECT
    ub.item_id,
    i.title,
    SUM(su.similarity * CASE ub.behavior_type
        WHEN 'purchase' THEN 3
        WHEN 'click' THEN 2
        WHEN 'view' THEN 1
        ELSE 0
    END) AS recommendation_score
FROM similar_users su
JOIN user_behaviors ub ON ub.user_id = su.user_id
JOIN items i ON i.id = ub.item_id
WHERE ub.item_id NOT IN (
    SELECT item_id FROM user_behaviors WHERE user_id = 123
)
GROUP BY ub.item_id, i.title
ORDER BY recommendation_score DESC
LIMIT 20;
```

**ç‰©å“ååŒè¿‡æ»¤**ï¼š

```sql
-- åŸºäºå•†å“ç›¸ä¼¼åº¦çš„æ¨è
WITH user_items AS (
    SELECT DISTINCT item_id
    FROM user_behaviors
    WHERE user_id = 123
),
similar_items AS (
    SELECT
        i2.id AS item_id,
        AVG(1 - (i1.feature_vec <=> i2.feature_vec)) AS similarity
    FROM items i1
    CROSS JOIN items i2
    WHERE i1.id IN (SELECT item_id FROM user_items)
      AND i2.id NOT IN (SELECT item_id FROM user_items)
      AND 1 - (i1.feature_vec <=> i2.feature_vec) > 0.7
    GROUP BY i2.id
)
SELECT
    si.item_id,
    i.title,
    si.similarity AS recommendation_score
FROM similar_items si
JOIN items i ON i.id = si.item_id
ORDER BY si.similarity DESC
LIMIT 20;
```

### 4.2 å†…å®¹æ¨è

**åŸºäºå†…å®¹ç‰¹å¾çš„æ¨è**ï¼š

```sql
-- 1. ç”Ÿæˆç”¨æˆ·åå¥½å‘é‡
WITH user_preference AS (
    SELECT AVG(i.feature_vec) AS preference_vec
    FROM user_behaviors ub
    JOIN items i ON i.id = ub.item_id
    WHERE ub.user_id = 123
      AND ub.behavior_type IN ('purchase', 'click')
      AND ub.timestamp > NOW() - INTERVAL '30 days'
)
-- 2. æ¨èç›¸ä¼¼å•†å“
SELECT
    i.id,
    i.title,
    1 - (i.feature_vec <=> up.preference_vec) AS similarity
FROM items i, user_preference up
WHERE i.id NOT IN (
    SELECT item_id FROM user_behaviors WHERE user_id = 123
)
  AND 1 - (i.feature_vec <=> up.preference_vec) > 0.7
ORDER BY i.feature_vec <=> up.preference_vec;

-- æ€§èƒ½æµ‹è¯•ï¼šåŸºäºå†…å®¹çš„æ¨èæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH user_preference AS (
    SELECT preference_vec FROM user_preferences WHERE user_id = 123
)
SELECT
    i.id,
    i.title,
    1 - (i.feature_vec <=> up.preference_vec) AS similarity
FROM items i, user_preference up
WHERE i.id NOT IN (
    SELECT item_id FROM user_behaviors WHERE user_id = 123
)
  AND 1 - (i.feature_vec <=> up.preference_vec) > 0.7
ORDER BY i.feature_vec <=> up.preference_vec
LIMIT 20;
```

LIMIT 20;

```

### 4.3 æ··åˆæ¨è

**åŠ æƒèåˆæ¨è**ï¼š

```sql
-- ç»“åˆååŒè¿‡æ»¤å’Œå†…å®¹æ¨è
WITH cf_recommendations AS (
    -- ååŒè¿‡æ»¤æ¨èï¼ˆæƒé‡0.6ï¼‰
    SELECT item_id, score * 0.6 AS weighted_score
    FROM collaborative_filtering_results
    WHERE user_id = 123
),
content_recommendations AS (
    -- å†…å®¹æ¨èï¼ˆæƒé‡0.4ï¼‰
    SELECT item_id, similarity * 0.4 AS weighted_score
    FROM content_based_results
    WHERE user_id = 123
)
SELECT
    COALESCE(cf.item_id, cr.item_id) AS item_id,
    i.title,
    COALESCE(cf.weighted_score, 0) + COALESCE(cr.weighted_score, 0) AS final_score
FROM cf_recommendations cf
FULL OUTER JOIN content_recommendations cr ON cf.item_id = cr.item_id
JOIN items i ON i.id = COALESCE(cf.item_id, cr.item_id)
ORDER BY final_score DESC
LIMIT 20;
```

---

## 5. å®æ—¶æ¨è

### 5.1 å®æ—¶ç‰¹å¾è®¡ç®—

**å®æ—¶ç”¨æˆ·ç‰¹å¾æ›´æ–°**ï¼š

```sql
-- ä½¿ç”¨è§¦å‘å™¨å®æ—¶æ›´æ–°ç”¨æˆ·è¡Œä¸ºå‘é‡
CREATE OR REPLACE FUNCTION update_user_behavior_vector()
RETURNS TRIGGER AS $$
BEGIN
    -- é‡æ–°è®¡ç®—ç”¨æˆ·è¡Œä¸ºå‘é‡
    INSERT INTO user_behavior_vectors (user_id, behavior_vec)
    SELECT
        NEW.user_id,
        AVG(i.feature_vec) AS behavior_vec
    FROM user_behaviors ub
    JOIN items i ON i.id = ub.item_id
    WHERE ub.user_id = NEW.user_id
      AND ub.timestamp > NOW() - INTERVAL '30 days'
    GROUP BY ub.user_id
    ON CONFLICT (user_id) DO UPDATE
    SET behavior_vec = EXCLUDED.behavior_vec,
        updated_at = NOW();

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_user_vector
AFTER INSERT OR UPDATE ON user_behaviors
FOR EACH ROW
EXECUTE FUNCTION update_user_behavior_vector();
```

### 5.2 å®æ—¶æ¨èç”Ÿæˆ

**å®æ—¶æ¨èæŸ¥è¯¢**ï¼š

```sql
-- å®æ—¶ç”Ÿæˆæ¨èï¼ˆç»“åˆå®æ—¶ç‰¹å¾ï¼‰
WITH user_preference AS (
    SELECT AVG(i.feature_vec) AS preference_vec
    FROM user_behaviors ub
    JOIN items i ON i.id = ub.item_id
    WHERE ub.user_id = $1
      AND ub.timestamp > NOW() - INTERVAL '7 days'  -- æœ€è¿‘7å¤©
),
category_preference AS (
    SELECT category_id, COUNT(*) AS view_count
    FROM user_behaviors ub
    JOIN items i ON i.id = ub.item_id
    WHERE ub.user_id = $1
      AND ub.timestamp > NOW() - INTERVAL '30 days'
    GROUP BY category_id
    ORDER BY view_count DESC
    LIMIT 3
)
SELECT
    i.id,
    i.title,
    i.category_id,
    -- å†…å®¹ç›¸ä¼¼åº¦
    1 - (i.feature_vec <=> up.preference_vec) AS content_score,
    -- ç±»åˆ«åå¥½
    CASE WHEN i.category_id IN (SELECT category_id FROM category_preference)
         THEN 0.3 ELSE 0 END AS category_bonus,
    -- ç»¼åˆå¾—åˆ†
    (1 - (i.feature_vec <=> up.preference_vec)) * 0.7 +
    CASE WHEN i.category_id IN (SELECT category_id FROM category_preference)
         THEN 0.3 ELSE 0 END AS final_score
FROM items i, user_preference up
WHERE i.id NOT IN (
    SELECT item_id FROM user_behaviors WHERE user_id = $1
)
ORDER BY final_score DESC
LIMIT 20;
```

### 5.3 æ¨èç»“æœç¼“å­˜

**ç¼“å­˜ç­–ç•¥**ï¼š

```sql
-- 1. åˆ›å»ºæ¨èç¼“å­˜è¡¨
CREATE TABLE recommendation_cache (
    user_id INT PRIMARY KEY REFERENCES users(id),
    recommendations JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);

-- 2. ç¼“å­˜æ¨èç»“æœ
CREATE OR REPLACE FUNCTION get_cached_recommendations(p_user_id INT)
RETURNS JSONB AS $$
DECLARE
    cached_result JSONB;
BEGIN
    -- æ£€æŸ¥ç¼“å­˜
    SELECT recommendations INTO cached_result
    FROM recommendation_cache
    WHERE user_id = p_user_id
      AND expires_at > NOW();

    IF cached_result IS NOT NULL THEN
        RETURN cached_result;
    END IF;

    -- ç”Ÿæˆæ–°æ¨èï¼ˆè°ƒç”¨æ¨èç®—æ³•ï¼‰
    -- ... çœç•¥æ¨èç”Ÿæˆé€»è¾‘ ...

    -- ç¼“å­˜ç»“æœï¼ˆ1å°æ—¶æœ‰æ•ˆæœŸï¼‰
    INSERT INTO recommendation_cache (user_id, recommendations, expires_at)
    VALUES (p_user_id, cached_result, NOW() + INTERVAL '1 hour')
    ON CONFLICT (user_id) DO UPDATE
    SET recommendations = EXCLUDED.recommendations,
        expires_at = EXCLUDED.expires_at;

    RETURN cached_result;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 å‘é‡ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥**ï¼š

```sql
-- 1. HNSWç´¢å¼•ï¼ˆé«˜å¬å›ç‡ï¼‰
CREATE INDEX ON items USING hnsw(feature_vec vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. ç”¨æˆ·è¡Œä¸ºå‘é‡ç´¢å¼•
CREATE INDEX ON user_behavior_vectors USING hnsw(behavior_vec vector_cosine_ops);

-- 3. æŸ¥è¯¢æ—¶ä¼˜åŒ–
SET hnsw.ef_search = 100;  -- æå‡å¬å›ç‡
```

### 6.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨LIMITæå‰ç»ˆæ­¢
SELECT ... ORDER BY similarity DESC LIMIT 20;

-- 2. è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
WHERE similarity > 0.7  -- æå‰è¿‡æ»¤

-- 3. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW user_recommendations AS
SELECT user_id, item_id, score
FROM recommendation_algorithm_results;

CREATE INDEX ON user_recommendations (user_id, score DESC);

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY user_recommendations;
```

### 6.3 ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜**ï¼š

```sql
-- 1. PostgreSQLå†…ç½®ç¼“å­˜ï¼ˆè‡ªåŠ¨ï¼‰
-- 2. åº”ç”¨å±‚ç¼“å­˜ï¼ˆRedisï¼‰
-- 3. CDNç¼“å­˜ï¼ˆé™æ€æ¨èï¼‰

-- ç¼“å­˜é¢„çƒ­
SELECT get_cached_recommendations(user_id)
FROM users
WHERE last_active > NOW() - INTERVAL '7 days';
```

---

## 7. è¯„ä¼°ä¸ä¼˜åŒ–

### 7.1 è¯„ä¼°æŒ‡æ ‡

**æ¨èç³»ç»Ÿè¯„ä¼°æŒ‡æ ‡**ï¼š

```sql
-- 1. å‡†ç¡®ç‡ï¼ˆPrecisionï¼‰
SELECT
    COUNT(*) FILTER (WHERE behavior_type = 'click')::float /
    COUNT(*) AS precision
FROM recommendations r
LEFT JOIN user_behaviors ub ON ub.user_id = r.user_id AND ub.item_id = r.item_id
WHERE r.created_at > NOW() - INTERVAL '7 days';

-- 2. å¬å›ç‡ï¼ˆRecallï¼‰
SELECT
    COUNT(DISTINCT r.item_id) FILTER (WHERE ub.behavior_type = 'click')::float /
    COUNT(DISTINCT ub.item_id) AS recall
FROM recommendations r
LEFT JOIN user_behaviors ub ON ub.user_id = r.user_id
WHERE r.created_at > NOW() - INTERVAL '7 days';

-- 3. ç‚¹å‡»ç‡ï¼ˆCTRï¼‰
SELECT
    COUNT(*) FILTER (WHERE clicked = true)::float /
    COUNT(*) AS ctr
FROM recommendation_impressions
WHERE created_at > NOW() - INTERVAL '7 days';
```

### 7.2 A/Bæµ‹è¯•

**A/Bæµ‹è¯•å®ç°**ï¼š

```sql
-- 1. ç”¨æˆ·åˆ†ç»„
CREATE TABLE user_experiments (
    user_id INT PRIMARY KEY REFERENCES users(id),
    experiment_name TEXT,
    variant TEXT,  -- A or B
    assigned_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. ä¸åŒç®—æ³•æ¨è
CREATE OR REPLACE FUNCTION get_recommendations(p_user_id INT)
RETURNS TABLE(item_id INT, score DECIMAL) AS $$
DECLARE
    variant TEXT;
BEGIN
    SELECT ue.variant INTO variant
    FROM user_experiments ue
    WHERE ue.user_id = p_user_id
      AND ue.experiment_name = 'recommendation_algorithm';

    IF variant = 'A' THEN
        -- ç®—æ³•Aï¼šååŒè¿‡æ»¤
        RETURN QUERY SELECT * FROM collaborative_filtering(p_user_id);
    ELSE
        -- ç®—æ³•Bï¼šå†…å®¹æ¨è
        RETURN QUERY SELECT * FROM content_based(p_user_id);
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 3. å¯¹æ¯”åˆ†æ
SELECT
    ue.variant,
    COUNT(*) AS total_recommendations,
    COUNT(*) FILTER (WHERE ub.behavior_type = 'click') AS clicks,
    COUNT(*) FILTER (WHERE ub.behavior_type = 'click')::float /
    COUNT(*) AS ctr
FROM user_experiments ue
JOIN recommendations r ON r.user_id = ue.user_id
LEFT JOIN user_behaviors ub ON ub.user_id = r.user_id AND ub.item_id = r.item_id
WHERE ue.experiment_name = 'recommendation_algorithm'
GROUP BY ue.variant;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-04-02
