---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\01-PostgreSQL18\41-å®æ—¶æ•°æ®åº“å®Œå…¨æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å®æ—¶æ•°æ®åº“å®Œå…¨æŒ‡å—

PostgreSQL LISTEN/NOTIFYæœºåˆ¶å®ç°å®æ—¶æ•°æ®æ¨é€ï¼Œæ„å»ºå®æ—¶åº”ç”¨ã€‚

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL 18 å®æ—¶æ•°æ®åº“å®Œå…¨æŒ‡å—](#postgresql-18-å®æ—¶æ•°æ®åº“å®Œå…¨æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [LISTEN/NOTIFYåŸºç¡€](#listennotifyåŸºç¡€)
    - [åŸºæœ¬æ¦‚å¿µ](#åŸºæœ¬æ¦‚å¿µ)
    - [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
  - [å®æ—¶é€šçŸ¥æœºåˆ¶](#å®æ—¶é€šçŸ¥æœºåˆ¶)
    - [1. åŸºç¡€ä½¿ç”¨](#1-åŸºç¡€ä½¿ç”¨)
    - [2. å¤šé€šé“ç›‘å¬](#2-å¤šé€šé“ç›‘å¬)
    - [3. Payloadé™åˆ¶](#3-payloadé™åˆ¶)
  - [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: å®æ—¶è®¢å•ç›‘æ§](#æ¡ˆä¾‹1-å®æ—¶è®¢å•ç›‘æ§)
      - [æ•°æ®åº“ç«¯](#æ•°æ®åº“ç«¯)
      - [Pythonç›‘å¬ç«¯](#pythonç›‘å¬ç«¯)
      - [Node.jsç›‘å¬ç«¯](#nodejsç›‘å¬ç«¯)
    - [æ¡ˆä¾‹2: å®æ—¶èŠå¤©ç³»ç»Ÿ](#æ¡ˆä¾‹2-å®æ—¶èŠå¤©ç³»ç»Ÿ)
    - [æ¡ˆä¾‹3: ç¼“å­˜å¤±æ•ˆé€šçŸ¥](#æ¡ˆä¾‹3-ç¼“å­˜å¤±æ•ˆé€šçŸ¥)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
    - [1. é€šçŸ¥é¢‘ç‡æ§åˆ¶](#1-é€šçŸ¥é¢‘ç‡æ§åˆ¶)
    - [2. æ¡ä»¶é€šçŸ¥](#2-æ¡ä»¶é€šçŸ¥)
    - [3. ç›‘å¬è¿æ¥ç®¡ç†](#3-ç›‘å¬è¿æ¥ç®¡ç†)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…çš„åšæ³•](#-é¿å…çš„åšæ³•)
  - [å®Œæ•´å®æˆ˜é¡¹ç›®](#å®Œæ•´å®æˆ˜é¡¹ç›®)
    - [å®æ—¶ä»ªè¡¨æ¿](#å®æ—¶ä»ªè¡¨æ¿)
  - [ç›‘æ§ä¸è°ƒè¯•](#ç›‘æ§ä¸è°ƒè¯•)
    - [æŸ¥çœ‹æ´»è·ƒç›‘å¬](#æŸ¥çœ‹æ´»è·ƒç›‘å¬)
    - [æ€§èƒ½ç›‘æ§](#æ€§èƒ½ç›‘æ§)
  - [æ€»ç»“](#æ€»ç»“)
    - [ä¼˜åŠ¿](#ä¼˜åŠ¿)
    - [é™åˆ¶](#é™åˆ¶)
    - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯)

---

## LISTEN/NOTIFYåŸºç¡€

### åŸºæœ¬æ¦‚å¿µ

PostgreSQLæä¾›è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼š

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šä¼šè¯Aï¼šç›‘å¬é€šé“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DO $$
BEGIN
    PERFORM pg_listen('my_channel');
    RAISE NOTICE 'å·²ç›‘å¬é€šé“: my_channel';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ç›‘å¬é€šé“å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
COMMIT;

-- æ€§èƒ½æµ‹è¯•ï¼šä¼šè¯Bï¼šå‘é€é€šçŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DO $$
BEGIN
    PERFORM pg_notify('my_channel', '{"event": "new_order", "order_id": 123}');
    RAISE NOTICE 'é€šçŸ¥å·²å‘é€';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å‘é€é€šçŸ¥å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
COMMIT;
-- ä¼šè¯Aä¼šæ”¶åˆ°é€šçŸ¥
```

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
| --- | --- |
| **å¼‚æ­¥é€šçŸ¥** | éé˜»å¡ï¼Œä¸å½±å“äº‹åŠ¡ |
| **å¤šå¯¹å¤š** | å¤šä¸ªç›‘å¬è€…ï¼Œå¤šä¸ªå‘é€è€… |
| **è½»é‡çº§** | å†…å­˜ä¸­ä¼ é€’ï¼Œæ— æŒä¹…åŒ– |
| **äº‹åŠ¡æ„ŸçŸ¥** | COMMITåæ‰å‘é€ |

---

## å®æ—¶é€šçŸ¥æœºåˆ¶

### 1. åŸºç¡€ä½¿ç”¨

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºé€šçŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
-- é€šçŸ¥è®¢å•å˜æ›´è§¦å‘å™¨å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION notify_order_change()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_payload TEXT;
    v_order_id INTEGER;
    v_user_id INTEGER;
BEGIN
    -- æ£€æŸ¥NEW/OLDè®°å½•
    IF TG_OP = 'DELETE' THEN
        IF OLD IS NULL THEN
            RAISE WARNING 'OLDè®°å½•ä¸ºç©ºï¼ˆDELETEæ“ä½œï¼‰ï¼Œæ— æ³•å‘é€é€šçŸ¥';
            RETURN NULL;
        END IF;
        v_order_id := OLD.id;
        v_user_id := OLD.user_id;
    ELSE
        IF NEW IS NULL THEN
            RAISE WARNING 'NEWè®°å½•ä¸ºç©ºï¼ˆ%æ“ä½œï¼‰ï¼Œæ— æ³•å‘é€é€šçŸ¥', TG_OP;
            RETURN NULL;
        END IF;
        v_order_id := NEW.id;
        v_user_id := NEW.user_id;
    END IF;

    -- æ„å»ºå¹¶å‘é€é€šçŸ¥
    BEGIN
        v_payload := json_build_object(
            'action', TG_OP,
            'order_id', v_order_id,
            'user_id', v_user_id,
            'timestamp', NOW()
        )::text;

        PERFORM pg_notify('order_events', v_payload);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é€é€šçŸ¥å¤±è´¥: % (æ“ä½œ: %, order_id: %)', SQLERRM, TG_OP, v_order_id;
    END;

    RETURN COALESCE(NEW, OLD);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'notify_order_changeè§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RETURN COALESCE(NEW, OLD);  -- å³ä½¿å‡ºé”™ä¹Ÿè¿”å›ï¼Œé¿å…é˜»å¡ä¸»æ“ä½œ
END;
$$;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºé€šçŸ¥å‡½æ•°å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DROP TRIGGER IF EXISTS order_change_trigger ON orders;
CREATE TRIGGER order_change_trigger
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW
EXECUTE FUNCTION notify_order_change();
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 2. å¤šé€šé“ç›‘å¬

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šç›‘å¬å¤šä¸ªé€šé“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DO $$
BEGIN
    PERFORM pg_listen('orders');
    PERFORM pg_listen('payments');
    PERFORM pg_listen('shipments');
    RAISE NOTICE 'å·²ç›‘å¬å¤šä¸ªé€šé“';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ç›‘å¬é€šé“å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
COMMIT;

-- æ€§èƒ½æµ‹è¯•ï¼šå–æ¶ˆç›‘å¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DO $$
BEGIN
    PERFORM pg_unlisten('orders');
    RAISE NOTICE 'å·²å–æ¶ˆç›‘å¬ordersé€šé“';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å–æ¶ˆç›‘å¬å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
COMMIT;

-- æ€§èƒ½æµ‹è¯•ï¼šå–æ¶ˆæ‰€æœ‰ç›‘å¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DO $$
BEGIN
    PERFORM pg_unlisten_all();
    RAISE NOTICE 'å·²å–æ¶ˆæ‰€æœ‰ç›‘å¬';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å–æ¶ˆæ‰€æœ‰ç›‘å¬å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
COMMIT;
```

### 3. Payloadé™åˆ¶

```sql
-- Payloadæœ€å¤§8000å­—èŠ‚
SELECT length('very long string'::text);

-- è¶…è¿‡é™åˆ¶éœ€è¦ä¼ é€’IDï¼Œå†æŸ¥è¯¢
PERFORM pg_notify(
    'large_data_event',
    json_build_object('id', NEW.id)::text
);
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: å®æ—¶è®¢å•ç›‘æ§

#### æ•°æ®åº“ç«¯

```sql
-- è®¢å•è¡¨
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL,
    total_amount NUMERIC(10, 2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- é€šçŸ¥å‡½æ•°
-- é€šçŸ¥è®¢å•äº‹ä»¶è§¦å‘å™¨å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION notify_order_event()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_payload JSON;
    v_payload_text TEXT;
BEGIN
    -- æ£€æŸ¥NEW/OLDè®°å½•å¹¶æ„å»ºpayload
    BEGIN
        IF TG_OP = 'DELETE' THEN
            IF OLD IS NULL THEN
                RAISE WARNING 'OLDè®°å½•ä¸ºç©ºï¼ˆDELETEæ“ä½œï¼‰ï¼Œæ— æ³•å‘é€é€šçŸ¥';
                RETURN NULL;
            END IF;

            v_payload := json_build_object(
                'action', 'delete',
                'order_id', OLD.id,
                'timestamp', EXTRACT(EPOCH FROM NOW())
            );
        ELSE
            IF NEW IS NULL THEN
                RAISE WARNING 'NEWè®°å½•ä¸ºç©ºï¼ˆ%æ“ä½œï¼‰ï¼Œæ— æ³•å‘é€é€šçŸ¥', TG_OP;
                RETURN NULL;
            END IF;

            v_payload := json_build_object(
                'action', LOWER(TG_OP),
                'order_id', NEW.id,
                'user_id', COALESCE(NEW.user_id, NULL),
                'status', COALESCE(NEW.status::TEXT, NULL),
                'total_amount', COALESCE(NEW.total_amount, NULL),
                'timestamp', EXTRACT(EPOCH FROM NOW())
            );
        END IF;

        IF v_payload IS NULL THEN
            RAISE WARNING 'æ„å»ºpayloadå¤±è´¥';
            RETURN COALESCE(NEW, OLD);
        END IF;

        -- è½¬æ¢ä¸ºæ–‡æœ¬
        BEGIN
            v_payload_text := v_payload::text;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è½¬æ¢payloadä¸ºæ–‡æœ¬å¤±è´¥: %', SQLERRM;
                RETURN COALESCE(NEW, OLD);
        END;

        -- å‘é€é€šçŸ¥
        BEGIN
            PERFORM pg_notify('order_events', v_payload_text);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'å‘é€é€šçŸ¥å¤±è´¥: %', SQLERRM;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ„å»ºæˆ–å‘é€é€šçŸ¥å¤±è´¥: %', SQLERRM;
    END;

    RETURN COALESCE(NEW, OLD);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'notify_order_eventè§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RETURN COALESCE(NEW, OLD);  -- å³ä½¿å‡ºé”™ä¹Ÿè¿”å›ï¼Œé¿å…é˜»å¡ä¸»æ“ä½œ
END;
$$;

-- è§¦å‘å™¨
CREATE TRIGGER order_event_trigger
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW
EXECUTE FUNCTION notify_order_event();
```

#### Pythonç›‘å¬ç«¯

```python
import psycopg2
import json
import select

def listen_orders():
    """ç›‘å¬è®¢å•äº‹ä»¶"""

    conn = psycopg2.connect(
        host='localhost',
        database='mydb',
        user='postgres'
    )

    conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)

    cursor = conn.cursor()
    cursor.execute("LISTEN order_events;")

    print("âœ“ å¼€å§‹ç›‘å¬è®¢å•äº‹ä»¶...")

    try:
        while True:
            # ç­‰å¾…é€šçŸ¥ï¼ˆ10ç§’è¶…æ—¶ï¼‰
            if select.select([conn], [], [], 10) == ([], [], []):
                print(".", end='', flush=True)
            else:
                conn.poll()

                while conn.notifies:
                    notify = conn.notifies.pop(0)

                    # è§£æpayload
                    payload = json.loads(notify.payload)

                    # å¤„ç†äº‹ä»¶
                    handle_order_event(payload)

    except KeyboardInterrupt:
        print("\nç›‘å¬å·²åœæ­¢")

    finally:
        cursor.close()
        conn.close()

def handle_order_event(payload):
    """å¤„ç†è®¢å•äº‹ä»¶"""

    action = payload['action']
    order_id = payload['order_id']

    if action == 'insert':
        print(f"\nğŸ“¦ æ–°è®¢å•: #{order_id}")
        print(f"   ç”¨æˆ·: {payload['user_id']}")
        print(f"   é‡‘é¢: ${payload['total_amount']}")

        # å‘é€æ¨é€é€šçŸ¥
        # send_push_notification(payload)

    elif action == 'update':
        print(f"\nğŸ”„ è®¢å•æ›´æ–°: #{order_id}")
        print(f"   çŠ¶æ€: {payload['status']}")

        # æ›´æ–°å‰ç«¯
        # update_frontend(payload)

    elif action == 'delete':
        print(f"\nâŒ è®¢å•åˆ é™¤: #{order_id}")

if __name__ == '__main__':
    listen_orders()
```

#### Node.jsç›‘å¬ç«¯

```javascript
const { Client } = require('pg');

async function listenOrders() {
    const client = new Client({
        host: 'localhost',
        database: 'mydb',
        user: 'postgres'
    });

    await client.connect();

    // ç›‘å¬é€šçŸ¥
    client.on('notification', (msg) => {
        const payload = JSON.parse(msg.payload);
        handleOrderEvent(payload);
    });

    // è®¢é˜…é€šé“
    await client.query('LISTEN order_events');

    console.log('âœ“ å¼€å§‹ç›‘å¬è®¢å•äº‹ä»¶...');
}

function handleOrderEvent(payload) {
    const { action, order_id } = payload;

    if (action === 'insert') {
        console.log(`ğŸ“¦ æ–°è®¢å•: #${order_id}`);
        // WebSocketæ¨é€åˆ°å‰ç«¯
        io.emit('new_order', payload);
    } else if (action === 'update') {
        console.log(`ğŸ”„ è®¢å•æ›´æ–°: #${order_id}`);
        io.emit('order_updated', payload);
    }
}

listenOrders().catch(console.error);
```

### æ¡ˆä¾‹2: å®æ—¶èŠå¤©ç³»ç»Ÿ

```sql
-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id BIGSERIAL PRIMARY KEY,
    room_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- é€šçŸ¥å‡½æ•°
-- é€šçŸ¥æ–°æ¶ˆæ¯è§¦å‘å™¨å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION notify_new_message()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_channel_name TEXT;
    v_payload JSON;
    v_payload_text TEXT;
BEGIN
    -- æ£€æŸ¥NEWè®°å½•
    IF NEW IS NULL THEN
        RAISE WARNING 'NEWè®°å½•ä¸ºç©ºï¼Œæ— æ³•å‘é€æ¶ˆæ¯é€šçŸ¥';
        RETURN NULL;
    END IF;

    IF NEW.room_id IS NULL THEN
        RAISE WARNING 'æˆ¿é—´IDä¸ºç©ºï¼Œæ— æ³•å‘é€é€šçŸ¥';
        RETURN NEW;
    END IF;

    -- æ„å»ºé€šé“åç§°
    BEGIN
        v_channel_name := 'room_' || NEW.room_id::TEXT;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ„å»ºé€šé“åç§°å¤±è´¥: %', SQLERRM;
            RETURN NEW;
    END;

    -- æ„å»ºpayload
    BEGIN
        v_payload := json_build_object(
            'message_id', COALESCE(NEW.id, NULL),
            'user_id', COALESCE(NEW.user_id, NULL),
            'content', COALESCE(NEW.content, ''),
            'timestamp', EXTRACT(EPOCH FROM COALESCE(NEW.created_at, NOW()))
        );

        IF v_payload IS NULL THEN
            RAISE WARNING 'æ„å»ºpayloadå¤±è´¥';
            RETURN NEW;
        END IF;

        -- è½¬æ¢ä¸ºæ–‡æœ¬
        BEGIN
            v_payload_text := v_payload::text;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è½¬æ¢payloadä¸ºæ–‡æœ¬å¤±è´¥: %', SQLERRM;
                RETURN NEW;
        END;

        -- å‘é€é€šçŸ¥
        BEGIN
            PERFORM pg_notify(v_channel_name, v_payload_text);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'å‘é€é€šçŸ¥å¤±è´¥: % (é€šé“: %)', SQLERRM, v_channel_name;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ„å»ºæˆ–å‘é€é€šçŸ¥å¤±è´¥: %', SQLERRM;
    END;

    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'notify_new_messageè§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RETURN NEW;  -- å³ä½¿å‡ºé”™ä¹Ÿè¿”å›NEWï¼Œé¿å…é˜»å¡ä¸»æ“ä½œ
END;
$$;

CREATE TRIGGER new_message_trigger
AFTER INSERT ON messages
FOR EACH ROW
EXECUTE FUNCTION notify_new_message();
```

```python
def join_room(room_id: int):
    """åŠ å…¥èŠå¤©å®¤"""

    cursor.execute(f"LISTEN room_{room_id};")
    print(f"âœ“ åŠ å…¥æˆ¿é—´ {room_id}")

def leave_room(room_id: int):
    """ç¦»å¼€èŠå¤©å®¤"""

    cursor.execute(f"UNLISTEN room_{room_id};")
    print(f"âœ“ ç¦»å¼€æˆ¿é—´ {room_id}")
```

### æ¡ˆä¾‹3: ç¼“å­˜å¤±æ•ˆé€šçŸ¥

```sql
-- ç¼“å­˜å¤±æ•ˆé€šçŸ¥
CREATE OR REPLACE FUNCTION notify_cache_invalidation()
RETURNS TRIGGER AS $$
BEGIN
    PERFORM pg_notify(
        'cache_invalidation',
        json_build_object(
            'table', TG_TABLE_NAME,
            'id', COALESCE(NEW.id, OLD.id),
            'action', TG_OP
        )::text
    );

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨åˆ°å¤šä¸ªè¡¨
CREATE TRIGGER cache_invalidation_trigger
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION notify_cache_invalidation();

CREATE TRIGGER cache_invalidation_trigger
AFTER INSERT OR UPDATE OR DELETE ON products
FOR EACH ROW
EXECUTE FUNCTION notify_cache_invalidation();
```

```python
import redis

redis_client = redis.Redis()

def handle_cache_invalidation(payload):
    """å¤„ç†ç¼“å­˜å¤±æ•ˆ"""

    table = payload['table']
    id = payload['id']

    # åˆ é™¤Redisç¼“å­˜
    cache_key = f"{table}:{id}"
    redis_client.delete(cache_key)

    print(f"âœ“ ç¼“å­˜å¤±æ•ˆ: {cache_key}")
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é€šçŸ¥é¢‘ç‡æ§åˆ¶

```sql
-- æ‰¹é‡é€šçŸ¥ï¼ˆé¿å…æ¯è¡Œè§¦å‘ï¼‰
CREATE OR REPLACE FUNCTION notify_batch_changes()
RETURNS TRIGGER AS $$
BEGIN
    -- åªåœ¨äº‹åŠ¡ç»“æŸæ—¶é€šçŸ¥
    PERFORM pg_notify(
        'batch_changes',
        json_build_object(
            'table', TG_TABLE_NAME,
            'timestamp', extract(epoch from now())
        )::text
    );

    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨AFTERè¯­å¥çº§è§¦å‘å™¨
CREATE TRIGGER batch_changes_trigger
AFTER INSERT OR UPDATE OR DELETE ON large_table
FOR EACH STATEMENT
EXECUTE FUNCTION notify_batch_changes();
```

### 2. æ¡ä»¶é€šçŸ¥

```sql
-- åªåœ¨é‡è¦å˜æ›´æ—¶é€šçŸ¥
CREATE OR REPLACE FUNCTION notify_important_changes()
RETURNS TRIGGER AS $$
BEGIN
    -- åªæœ‰çŠ¶æ€å˜æ›´æ—¶é€šçŸ¥
    IF NEW.status != OLD.status THEN
        PERFORM pg_notify('order_status_changes',
            json_build_object('order_id', NEW.id, 'new_status', NEW.status)::text
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 3. ç›‘å¬è¿æ¥ç®¡ç†

```python
from psycopg2.pool import SimpleConnectionPool

# ä½¿ç”¨è¿æ¥æ± 
pool = SimpleConnectionPool(
    minconn=1,
    maxconn=5,
    host='localhost',
    database='mydb'
)

# ä¸“ç”¨ç›‘å¬è¿æ¥
listen_conn = pool.getconn()
listen_conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)

# ä¸šåŠ¡è¿æ¥ä½¿ç”¨å…¶ä»–è¿æ¥
business_conn = pool.getconn()
```

---

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **Payloadä¿æŒå°å·§**

   ```sql
   -- âœ… åªä¼ é€’ID
   PERFORM pg_notify('event', json_build_object('id', NEW.id)::text);

   -- âŒ ä¼ é€’æ•´è¡Œæ•°æ®
   PERFORM pg_notify('event', row_to_json(NEW)::text);
   ```

2. **äº‹åŠ¡æ„ŸçŸ¥**

   ```sql
   BEGIN;
   INSERT INTO orders VALUES (...);
   -- é€šçŸ¥åœ¨COMMITåæ‰å‘é€
   COMMIT;
   ```

3. **é”™è¯¯å¤„ç†**

   ```python
   try:
       conn.poll()
       # å¤„ç†é€šçŸ¥
   except psycopg2.DatabaseError as e:
       print(f"æ•°æ®åº“é”™è¯¯: {e}")
       # é‡æ–°è¿æ¥
       reconnect()
   ```

4. **å¿ƒè·³æ£€æµ‹**

   ```python
   import time

   last_notify_time = time.time()

   while True:
       # 10ç§’è¶…æ—¶
       if select.select([conn], [], [], 10) == ([], [], []):
           # å‘é€å¿ƒè·³æŸ¥è¯¢
           cursor.execute("SELECT 1;")

           if time.time() - last_notify_time > 60:
               print("âš ï¸  é•¿æ—¶é—´æœªæ”¶åˆ°é€šçŸ¥")
       else:
           last_notify_time = time.time()
           # å¤„ç†é€šçŸ¥
   ```

### âŒ é¿å…çš„åšæ³•

1. âŒ ä½¿ç”¨LISTENåšä»»åŠ¡é˜Ÿåˆ—
   - é€šçŸ¥ä¸æŒä¹…åŒ–
   - ç›‘å¬è€…æ–­å¼€ä¼šä¸¢å¤±é€šçŸ¥
   - ä½¿ç”¨ä¸“é—¨çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚RabbitMQï¼‰

2. âŒ ä¼ é€’å¤§é‡æ•°æ®
   - Payloadé™åˆ¶8KB
   - åº”ä¼ é€’IDï¼Œå†æŸ¥è¯¢

3. âŒ åœ¨é•¿äº‹åŠ¡ä¸­NOTIFY
   - é€šçŸ¥å»¶è¿Ÿåˆ°COMMIT
   - å¯èƒ½å¾ˆä¹…æ‰å‘é€

---

## å®Œæ•´å®æˆ˜é¡¹ç›®

### å®æ—¶ä»ªè¡¨æ¿

```sql
-- ç»Ÿè®¡è¡¨
CREATE TABLE dashboard_stats (
    id BIGSERIAL PRIMARY KEY,
    metric_name VARCHAR(50) NOT NULL,
    metric_value NUMERIC NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION notify_dashboard_update()
RETURNS TRIGGER AS $$
BEGIN
    PERFORM pg_notify(
        'dashboard_updates',
        json_build_object(
            'metric', NEW.metric_name,
            'value', NEW.metric_value,
            'timestamp', extract(epoch from NEW.updated_at)
        )::text
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER dashboard_update_trigger
AFTER INSERT OR UPDATE ON dashboard_stats
FOR EACH ROW
EXECUTE FUNCTION notify_dashboard_update();
```

```javascript
// WebSocketæœåŠ¡å™¨
const WebSocket = require('ws');
const { Client } = require('pg');

const wss = new WebSocket.Server({ port: 8080 });
const pgClient = new Client({ /* ... */ });

await pgClient.connect();
await pgClient.query('LISTEN dashboard_updates');

// è½¬å‘é€šçŸ¥åˆ°WebSocketå®¢æˆ·ç«¯
pgClient.on('notification', (msg) => {
    const payload = JSON.parse(msg.payload);

    // å¹¿æ’­åˆ°æ‰€æœ‰WebSocketå®¢æˆ·ç«¯
    wss.clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify(payload));
        }
    });
});

console.log('âœ“ WebSocketæœåŠ¡å™¨å¯åŠ¨åœ¨ :8080');
```

```html
<!-- å‰ç«¯é¡µé¢ -->
<script>
const ws = new WebSocket('ws://localhost:8080');

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    // æ›´æ–°ä»ªè¡¨æ¿
    updateDashboard(data.metric, data.value);
};

function updateDashboard(metric, value) {
    document.getElementById(metric).textContent = value;
}
</script>
```

---

## ç›‘æ§ä¸è°ƒè¯•

### æŸ¥çœ‹æ´»è·ƒç›‘å¬

```sql
-- æŸ¥çœ‹å½“å‰ç›‘å¬çš„é€šé“
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state
FROM pg_stat_activity
WHERE backend_type = 'client backend'
  AND query LIKE '%LISTEN%';
```

### æ€§èƒ½ç›‘æ§

```sql
-- é€šçŸ¥ç»Ÿè®¡ï¼ˆéœ€è¦è‡ªå®šä¹‰ï¼‰
CREATE TABLE notify_stats (
    channel_name VARCHAR(100),
    notify_count BIGINT,
    last_notify TIMESTAMPTZ
);

-- åœ¨é€šçŸ¥å‡½æ•°ä¸­è®°å½•
UPDATE notify_stats
SET notify_count = notify_count + 1,
    last_notify = now()
WHERE channel_name = 'order_events';
```

---

## æ€»ç»“

### ä¼˜åŠ¿

- âœ… è½»é‡çº§å®æ—¶é€šçŸ¥
- âœ… ä¸æ•°æ®åº“äº‹åŠ¡é›†æˆ
- âœ… ç®€å•æ˜“ç”¨
- âœ… æ”¯æŒå¤šå¯¹å¤š

### é™åˆ¶

- âš ï¸ ä¸æŒä¹…åŒ–ï¼ˆç›‘å¬è€…æ–­å¼€ä¼šä¸¢å¤±ï¼‰
- âš ï¸ Payloadé™åˆ¶8KB
- âš ï¸ ä¸é€‚åˆåšä»»åŠ¡é˜Ÿåˆ—
- âš ï¸ éœ€è¦ä¿æŒè¿æ¥

### é€‚ç”¨åœºæ™¯

- âœ… å®æ—¶ä»ªè¡¨æ¿
- âœ… ç¼“å­˜å¤±æ•ˆ
- âœ… å®æ—¶èŠå¤©
- âœ… çŠ¶æ€é€šçŸ¥
- âœ… äº‹ä»¶é©±åŠ¨æ¶æ„

---

**PostgreSQL LISTEN/NOTIFY - æ„å»ºé«˜æ•ˆå®æ—¶åº”ç”¨ï¼**
