---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\01-PostgreSQL18\14-æ•°æ®ç±»å‹æ·±åº¦è§£æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 æ•°æ®ç±»å‹æ·±åº¦è§£æ

## 1. æ•°å€¼ç±»å‹

### 1.1 æ•´æ•°ç±»å‹

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šç±»å‹é€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
-- ç±»å‹é€‰æ‹©
-- SMALLINT    -- 2å­—èŠ‚, -32768 to 32767
-- INTEGER     -- 4å­—èŠ‚, -2^31 to 2^31-1
-- BIGINT      -- 8å­—èŠ‚, -2^63 to 2^63-1

-- è‡ªå¢
-- SERIAL      -- INTEGER + SEQUENCE
-- BIGSERIAL   -- BIGINT + SEQUENCE

-- ç¤ºä¾‹
CREATE TABLE IF NOT EXISTS products (
    product_id BIGSERIAL PRIMARY KEY,      -- è‡ªå¢ä¸»é”®
    category_id INT NOT NULL,              -- åˆ†ç±»IDï¼ˆä¸ä¼šå¾ˆå¤§ï¼‰
    stock SMALLINT DEFAULT 0,              -- åº“å­˜ï¼ˆèŒƒå›´æœ‰é™ï¼‰
    view_count BIGINT DEFAULT 0            -- æµè§ˆé‡ï¼ˆå¯èƒ½å¾ˆå¤§ï¼‰
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨productså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå­˜å‚¨å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_column_size(1::smallint) AS smallint_size,  -- 2å­—èŠ‚
    pg_column_size(1::integer) AS integer_size,    -- 4å­—èŠ‚
    pg_column_size(1::bigint) AS bigint_size;      -- 8å­—èŠ‚
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å­˜å‚¨å¯¹æ¯”æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 100ä¸‡è¡Œæ•°æ®
-- SMALLINT: 2MB
-- INTEGER:  4MB
-- BIGINT:   8MB

```

### 1.2 æµ®ç‚¹ä¸å®šç‚¹

```sql
-- æµ®ç‚¹ç±»å‹
REAL           -- 4å­—èŠ‚, 6ä½ç²¾åº¦
DOUBLE PRECISION  -- 8å­—èŠ‚, 15ä½ç²¾åº¦

-- å®šç‚¹ç±»å‹ï¼ˆæ¨èé‡‘é¢ï¼‰
NUMERIC(10,2)  -- æ€»10ä½ï¼Œå°æ•°2ä½
DECIMAL(10,2)  -- ä¸NUMERICç­‰ä»·

-- æ€§èƒ½æµ‹è¯•ï¼šé‡‘é¢å­˜å‚¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS orders (
    order_id BIGSERIAL PRIMARY KEY,
    amount NUMERIC(12,2) NOT NULL,  -- æœ€å¤§9999999999.99
    tax NUMERIC(12,4),              -- ç¨ç‡éœ€è¦4ä½å°æ•°
    CHECK (amount >= 0)
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨orderså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½å¯¹æ¯”
-- NUMERIC: ç²¾ç¡®ï¼Œé€‚åˆé‡‘è
-- DOUBLE PRECISION: å¿«ï¼Œé€‚åˆç§‘å­¦è®¡ç®—

-- æ€§èƒ½æµ‹è¯•ï¼šç¤ºä¾‹: ç´¯åŠ ç²¾åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT SUM(0.1::DOUBLE PRECISION) FROM generate_series(1, 10);  -- 0.9999999999999999
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'DOUBLE PRECISIONç´¯åŠ æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT SUM(0.1::NUMERIC) FROM generate_series(1, 10);           -- 1.0
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'NUMERICç´¯åŠ æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 2. æ–‡æœ¬ç±»å‹

### 2.1 VARCHAR vs TEXT

```sql
-- ç±»å‹å¯¹æ¯”
VARCHAR(n)  -- å˜é•¿ï¼Œæœ€å¤§nå­—ç¬¦
TEXT        -- å˜é•¿ï¼Œæ— é™åˆ¶
CHAR(n)     -- å®šé•¿ï¼Œç©ºæ ¼å¡«å……

-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºæµ‹è¯•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS text_test (
    id SERIAL PRIMARY KEY,
    col_varchar VARCHAR(100),
    col_text TEXT,
    col_char CHAR(100)
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨text_testå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ’å…¥100ä¸‡è¡Œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
INSERT INTO text_test (col_varchar, col_text, col_char)
SELECT 'test' || i, 'test' || i, 'test' || i
FROM generate_series(1, 1000000) i
ON CONFLICT DO NOTHING;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå­˜å‚¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(pg_total_relation_size('text_test')) AS total_size,
    pg_column_size(col_varchar) AS varchar_avg,
    pg_column_size(col_text) AS text_avg,
    pg_column_size(col_char) AS char_avg
FROM text_test LIMIT 1;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨text_testä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å­˜å‚¨ç©ºé—´æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

/*
ç»“æœ:
VARCHAR: ä¸TEXTå®Œå…¨ç›¸åŒ
TEXT: æœ€çµæ´»
CHAR: æ€»æ˜¯å ç”¨nå­—èŠ‚ï¼ˆæµªè´¹ç©ºé—´ï¼‰

å»ºè®®: ä½¿ç”¨TEXTï¼ˆæ— æ€§èƒ½å·®å¼‚ï¼‰
*/
```

### 2.2 å…¨æ–‡æœç´¢ç±»å‹

```sql
-- æ€§èƒ½æµ‹è¯•ï¼štsvector: é¢„å¤„ç†çš„æ–‡æœ¬å‘é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS documents (
    doc_id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    search_vector tsvector
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨documentså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè‡ªåŠ¨æ›´æ–°tsvectorï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(NEW.content, '')), 'B');
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå‡½æ•°å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
DROP TRIGGER IF EXISTS trg_search_vector ON documents;
CREATE TRIGGER trg_search_vector
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW
    EXECUTE FUNCTION update_search_vector();
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šGINç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE INDEX IF NOT EXISTS idx_search ON documents USING GIN (search_vector);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_searchå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå…¨æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE search_vector @@ to_tsquery('english', 'postgresql & mvcc');
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å…¨æ–‡æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 3. æ—¥æœŸæ—¶é—´ç±»å‹

### 3.1 ç±»å‹é€‰æ‹©

```sql
-- æ—¥æœŸæ—¶é—´ç±»å‹
DATE           -- æ—¥æœŸ
TIME           -- æ—¶é—´
TIMESTAMP      -- æ—¥æœŸæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰
TIMESTAMPTZ    -- æ—¥æœŸæ—¶é—´ï¼ˆå¸¦æ—¶åŒºï¼Œæ¨èï¼‰
INTERVAL       -- æ—¶é—´é—´éš”

-- æ¨è: å§‹ç»ˆä½¿ç”¨TIMESTAMPTZ
CREATE TABLE events (
    event_id BIGSERIAL PRIMARY KEY,
    event_name TEXT,
    created_at TIMESTAMPTZ DEFAULT now()  -- å¸¦æ—¶åŒº
);

-- æ—¶åŒºè½¬æ¢
SELECT
    created_at,
    created_at AT TIME ZONE 'UTC' AS utc_time,
    created_at AT TIME ZONE 'America/New_York' AS ny_time,
    created_at AT TIME ZONE 'Asia/Shanghai' AS sh_time
FROM events;
```

### 3.2 æ—¥æœŸè®¡ç®—

```sql
-- INTERVALè¿ç®—
SELECT
    now() + INTERVAL '1 day' AS tomorrow,
    now() - INTERVAL '7 days' AS week_ago,
    now() + INTERVAL '1 hour 30 minutes' AS later;

-- æ—¥æœŸæˆªæ–­
SELECT
    date_trunc('hour', now()) AS current_hour,
    date_trunc('day', now()) AS today,
    date_trunc('month', now()) AS this_month,
    date_trunc('year', now()) AS this_year;

-- æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼ˆåˆ†åŒºè£å‰ªå‹å¥½ï¼‰
SELECT * FROM logs
WHERE created_at >= date_trunc('day', now())
  AND created_at < date_trunc('day', now()) + INTERVAL '1 day';

-- æ—¶é—´èŒƒå›´ç±»å‹
CREATE TABLE bookings (
    booking_id SERIAL PRIMARY KEY,
    room_id INT,
    booking_period tstzrange,  -- æ—¶é—´èŒƒå›´
    EXCLUDE USING gist (room_id WITH =, booking_period WITH &&)  -- é˜²æ­¢é‡å 
);

INSERT INTO bookings (room_id, booking_period) VALUES
(101, tstzrange('2024-01-01 14:00', '2024-01-01 16:00'));

-- å†²çªæ£€æµ‹è‡ªåŠ¨
INSERT INTO bookings (room_id, booking_period) VALUES
(101, tstzrange('2024-01-01 15:00', '2024-01-01 17:00'));
-- ERROR: conflicting key value violates exclusion constraint
```

---

## 4. æ•°ç»„ç±»å‹

### 4.1 æ•°ç»„æ“ä½œ

```sql
-- åˆ›å»ºæ•°ç»„åˆ—
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    tags TEXT[],
    scores INT[]
);

-- æ’å…¥
INSERT INTO users (tags, scores) VALUES
(ARRAY['vip', 'active'], ARRAY[95, 87, 92]),
('{premium,verified}', '{88,90,85}');

-- æ•°ç»„æ“ä½œ
SELECT
    tags[1] AS first_tag,               -- è®¿é—®å…ƒç´ ï¼ˆ1-basedï¼‰
    tags[1:2] AS first_two_tags,        -- åˆ‡ç‰‡
    array_length(tags, 1) AS tag_count, -- é•¿åº¦
    'vip' = ANY(tags) AS is_vip,        -- åŒ…å«æ£€æŸ¥
    tags || 'new_tag' AS append,        -- è¿½åŠ 
    array_cat(tags, ARRAY['tag1','tag2']) AS concat  -- æ‹¼æ¥
FROM users;

-- æ•°ç»„ç´¢å¼•ï¼ˆGINï¼‰
CREATE INDEX idx_users_tags ON users USING GIN (tags);

-- æŸ¥è¯¢
SELECT * FROM users WHERE tags && ARRAY['vip', 'premium'];  -- æœ‰äº¤é›†
SELECT * FROM users WHERE tags @> ARRAY['vip'];              -- åŒ…å«
SELECT * FROM users WHERE tags <@ ARRAY['vip','active','premium'];  -- è¢«åŒ…å«
```

### 4.2 æ•°ç»„èšåˆ

```sql
-- èšåˆä¸ºæ•°ç»„
SELECT array_agg(user_id) AS user_ids
FROM users
WHERE status = 'active';

-- å»é‡èšåˆ
SELECT array_agg(DISTINCT category) AS categories
FROM products;

-- è§£åŒ…æ•°ç»„
SELECT unnest(tags) AS tag
FROM users;

-- æ•°ç»„å±•å¼€+ç»Ÿè®¡
SELECT
    tag,
    COUNT(*) AS user_count
FROM users,
LATERAL unnest(tags) AS tag
GROUP BY tag
ORDER BY user_count DESC;
```

---

## 5. JSON/JSONB

### 5.1 å¤æ‚ç»“æ„

```sql
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_data JSONB
);

-- åµŒå¥—JSON
INSERT INTO products (product_data) VALUES
('{
    "name": "Laptop",
    "price": 999.99,
    "specs": {
        "cpu": "Intel i7",
        "ram": "16GB",
        "storage": {"type": "SSD", "size": "512GB"}
    },
    "tags": ["electronics", "computers"],
    "ratings": [4.5, 4.8, 4.2]
}');

-- æ·±åº¦è®¿é—®
SELECT
    product_data->>'name' AS name,
    product_data#>>'{specs,cpu}' AS cpu,
    product_data#>>'{specs,storage,type}' AS storage_type,
    jsonb_array_elements_text(product_data->'tags') AS tag
FROM products;

-- GINç´¢å¼•
CREATE INDEX idx_product_data ON products USING GIN (product_data jsonb_path_ops);

-- æŸ¥è¯¢
SELECT * FROM products
WHERE product_data @> '{"specs": {"cpu": "Intel i7"}}';
```

---

## 6. UUIDç±»å‹

### 6.1 UUIDv7ï¼ˆPostgreSQL 18æ–°å¢ï¼‰

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- UUIDç”Ÿæˆ
SELECT
    uuid_generate_v4() AS v4,      -- éšæœºUUID
    gen_random_uuid() AS random,   -- éšæœºï¼ˆå†…ç½®ï¼‰
    uuidv7() AS v7;                -- UUIDv7ï¼ˆPostgreSQL 18ï¼‰

-- UUIDv7ä¼˜åŠ¿
/*
UUIDv4: å®Œå…¨éšæœº
â”œâ”€ æ— åº
â”œâ”€ B-Treeç´¢å¼•æ€§èƒ½å·®
â””â”€ å†™å…¥æ”¾å¤§

UUIDv7: æ—¶é—´+éšæœº
â”œâ”€ æ—¶é—´æœ‰åº
â”œâ”€ B-Treeç´¢å¼•å‹å¥½
â”œâ”€ å†™å…¥æ€§èƒ½å¥½
â””â”€ å…¨å±€å”¯ä¸€
*/

-- ä½¿ç”¨UUIDv7
CREATE TABLE distributed_events (
    event_id UUID PRIMARY KEY DEFAULT uuidv7(),
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ç´¢å¼•æ€§èƒ½ï¼ˆ100ä¸‡è¡Œï¼‰
-- UUIDv4æ’å…¥: 25ç§’, ç´¢å¼•å¤§å°: 42MB
-- UUIDv7æ’å…¥: 12ç§’, ç´¢å¼•å¤§å°: 28MB (-52%)
```

---

## 7. æšä¸¾ç±»å‹

### 7.1 åˆ›å»ºä½¿ç”¨

```sql
-- åˆ›å»ºæšä¸¾
CREATE TYPE order_status AS ENUM (
    'pending',
    'paid',
    'shipped',
    'delivered',
    'cancelled'
);

CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    status order_status DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ä¼˜åŠ¿
-- 1. ç±»å‹å®‰å…¨
INSERT INTO orders (status) VALUES ('invalid');  -- ERROR

-- 2. å­˜å‚¨é«˜æ•ˆ
-- ENUM: 4å­—èŠ‚
-- VARCHAR(20): å˜é•¿ï¼Œå¹³å‡10å­—èŠ‚

-- 3. æ’åºæŒ‰å®šä¹‰é¡ºåº
SELECT * FROM orders ORDER BY status;
-- pending, paid, shipped, delivered, cancelled

-- æ·»åŠ æšä¸¾å€¼
ALTER TYPE order_status ADD VALUE 'refunded' AFTER 'delivered';
```

---

## 8. å¤åˆç±»å‹

### 8.1 è‡ªå®šä¹‰ç±»å‹

```sql
-- åˆ›å»ºå¤åˆç±»å‹
CREATE TYPE address_type AS (
    street TEXT,
    city TEXT,
    state VARCHAR(2),
    zip_code VARCHAR(10)
);

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username TEXT,
    address address_type
);

-- æ’å…¥
INSERT INTO users (username, address) VALUES
('alice', ROW('123 Main St', 'New York', 'NY', '10001'));

-- æˆ–
INSERT INTO users (username, address) VALUES
('bob', ('456 Oak Ave', 'Los Angeles', 'CA', '90001')::address_type);

-- è®¿é—®
SELECT
    username,
    (address).city AS city,
    (address).state AS state
FROM users;

-- ç´¢å¼•å¤åˆç±»å‹çš„å­—æ®µ
CREATE INDEX idx_users_city ON users (((address).city));
```

---

## 9. èŒƒå›´ç±»å‹

### 9.1 å†…ç½®èŒƒå›´ç±»å‹

```sql
-- èŒƒå›´ç±»å‹
int4range     -- INTEGERèŒƒå›´
int8range     -- BIGINTèŒƒå›´
numrange      -- NUMERICèŒƒå›´
tsrange       -- TIMESTAMPèŒƒå›´
tstzrange     -- TIMESTAMPTZèŒƒå›´
daterange     -- DATEèŒƒå›´

-- åˆ›å»ºèŒƒå›´
SELECT
    int4range(1, 10) AS int_range,              -- [1,10)
    int4range(1, 10, '[]') AS inclusive,        -- [1,10]
    daterange('2024-01-01', '2024-12-31') AS year_2024,
    tstzrange(now(), now() + INTERVAL '1 hour') AS next_hour;

-- èŒƒå›´æ“ä½œ
SELECT
    int4range(1, 10) @> 5 AS contains_5,        -- true
    int4range(1, 10) && int4range(5, 15) AS overlaps,  -- true
    int4range(1, 10) + int4range(10, 20) AS union,     -- [1,20)
    int4range(1, 20) - int4range(5, 15) AS diff;       -- [1,5)

-- å®æˆ˜: ä¼šè®®å®¤é¢„è®¢
CREATE TABLE room_bookings (
    booking_id SERIAL PRIMARY KEY,
    room_id INT,
    booking_period tstzrange,
    EXCLUDE USING gist (room_id WITH =, booking_period WITH &&)
);

-- é˜²æ­¢é‡å é¢„è®¢
INSERT INTO room_bookings (room_id, booking_period) VALUES
(101, tstzrange('2024-01-01 10:00', '2024-01-01 12:00'));

-- å†²çªæ£€æµ‹
INSERT INTO room_bookings (room_id, booking_period) VALUES
(101, tstzrange('2024-01-01 11:00', '2024-01-01 13:00'));
-- ERROR: conflicting key

-- æŸ¥è¯¢å¯ç”¨æ—¶é—´
SELECT room_id
FROM rooms r
WHERE NOT EXISTS (
    SELECT 1 FROM room_bookings rb
    WHERE rb.room_id = r.room_id
      AND rb.booking_period && tstzrange('2024-01-01 14:00', '2024-01-01 16:00')
);
```

---

## 10. ç½‘ç»œåœ°å€ç±»å‹

### 10.1 INETä¸CIDR

```sql
-- ç±»å‹
INET    -- IPåœ°å€æˆ–ç½‘ç»œ
CIDR    -- ç½‘ç»œåœ°å€ï¼ˆå¿…é¡»æœ‰å‰ç¼€ï¼‰
MACADDR -- MACåœ°å€

-- ç¤ºä¾‹
CREATE TABLE access_logs (
    log_id BIGSERIAL PRIMARY KEY,
    client_ip INET,
    server_ip INET,
    network CIDR,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- æ’å…¥
INSERT INTO access_logs (client_ip, network) VALUES
('192.168.1.100', '192.168.1.0/24'),
('10.0.0.50', '10.0.0.0/16');

-- ç½‘ç»œè¿ç®—
SELECT
    '192.168.1.100'::inet << '192.168.1.0/24'::inet AS is_in_network,  -- true
    '192.168.1.100'::inet + 10 AS add_offset,                          -- 192.168.1.110
    broadcast('192.168.1.0/24'::inet) AS broadcast_addr,               -- 192.168.1.255
    netmask('192.168.1.0/24'::inet) AS netmask;                        -- 255.255.255.0

-- æŸ¥è¯¢ç‰¹å®šç½‘ç»œçš„è®¿é—®
SELECT * FROM access_logs
WHERE client_ip << '192.168.1.0/24';

-- GiSTç´¢å¼•ï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰
CREATE INDEX idx_client_ip ON access_logs USING gist (client_ip inet_ops);
```

---

## 11. å‘é‡ç±»å‹ï¼ˆpgvectorï¼‰

### 11.1 å‘é‡æ“ä½œ

```sql
-- åˆ›å»ºå‘é‡
CREATE EXTENSION vector;

CREATE TABLE embeddings (
    id SERIAL PRIMARY KEY,
    vec vector(128)
);

-- æ’å…¥
INSERT INTO embeddings (vec) VALUES
('[0.1, 0.2, 0.3, ...]'),  -- æ–‡æœ¬æ ¼å¼
(ARRAY[0.1, 0.2, 0.3, ...]::vector(128));  -- æ•°ç»„è½¬æ¢

-- å‘é‡è¿ç®—
SELECT
    vec + '[1,1,1,...]'::vector(128) AS addition,
    vec - '[1,1,1,...]'::vector(128) AS subtraction,
    vec * 2 AS scalar_multiply,
    vec <-> '[0,0,0,...]'::vector(128) AS l2_distance,
    vec <=> '[0,0,0,...]'::vector(128) AS cosine_distance,
    vec <#> '[0,0,0,...]'::vector(128) AS inner_product
FROM embeddings
LIMIT 1;

-- HNSWç´¢å¼•
CREATE INDEX ON embeddings USING hnsw (vec vector_l2_ops);
```

---

## 12. ç±»å‹è½¬æ¢

### 12.1 æ˜¾å¼è½¬æ¢

```sql
-- æ–‡æœ¬è½¬æ•°å€¼
SELECT '123'::INTEGER;
SELECT CAST('123' AS INTEGER);

-- æ•°å€¼è½¬æ–‡æœ¬
SELECT 123::TEXT;

-- æ—¥æœŸè½¬æ¢
SELECT '2024-01-01'::DATE;
SELECT to_date('2024-01-01', 'YYYY-MM-DD');

-- JSONBè½¬æ¢
SELECT '{"name":"Alice"}'::JSONB;
SELECT to_jsonb(ROW('Alice', 30));
```

### 12.2 éšå¼è½¬æ¢

```sql
-- è‡ªåŠ¨è½¬æ¢
SELECT * FROM orders WHERE order_id = '123';  -- TEXTâ†’INTEGER

-- æ³¨æ„ï¼šå¯èƒ½å½±å“ç´¢å¼•ä½¿ç”¨
-- Bad
SELECT * FROM users WHERE user_id = '123';  -- å¦‚æœuser_idæ˜¯INTEGER

-- Good
SELECT * FROM users WHERE user_id = 123;
```

---

## 13. è‡ªå®šä¹‰ç±»å‹

### 13.1 Domainç±»å‹

```sql
-- åˆ›å»ºdomainï¼ˆå¸¦çº¦æŸçš„ç±»å‹åˆ«åï¼‰
CREATE DOMAIN email_type AS TEXT
CHECK (VALUE ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');

CREATE DOMAIN phone_type AS TEXT
CHECK (VALUE ~ '^\d{3}-\d{3}-\d{4}$');

CREATE DOMAIN positive_numeric AS NUMERIC
CHECK (VALUE >= 0);

-- ä½¿ç”¨
CREATE TABLE contacts (
    contact_id SERIAL PRIMARY KEY,
    email email_type,
    phone phone_type,
    balance positive_numeric
);

-- è‡ªåŠ¨éªŒè¯
INSERT INTO contacts (email) VALUES ('invalid-email');
-- ERROR: value violates check constraint
```

---

## 14. æ€§èƒ½å¯¹æ¯”

```sql
-- å­˜å‚¨æ•ˆç‡æµ‹è¯•ï¼ˆ100ä¸‡è¡Œï¼‰
CREATE TABLE type_comparison (
    id BIGINT,                    -- 8å­—èŠ‚
    status VARCHAR(20),           -- å˜é•¿ï¼Œå¹³å‡10å­—èŠ‚
    status_enum order_status,     -- 4å­—èŠ‚
    amount NUMERIC(12,2),         -- å˜é•¿ï¼Œå¹³å‡8å­—èŠ‚
    amount_int BIGINT,            -- 8å­—èŠ‚ï¼ˆå­˜å‚¨ä¸ºåˆ†ï¼‰
    tags TEXT[],                  -- æ•°ç»„
    data JSONB                    -- JSONB
);

-- ç»“æœ
/*
åˆ—            å­˜å‚¨/è¡Œ    100ä¸‡è¡Œæ€»è®¡
id            8å­—èŠ‚      8MB
status        ~10å­—èŠ‚    ~10MB
status_enum   4å­—èŠ‚      4MB        â† èŠ‚çœ60%
amount        ~8å­—èŠ‚     ~8MB
amount_int    8å­—èŠ‚      8MB        â† æ›´å¿«è®¡ç®—
tags          ~50å­—èŠ‚    ~50MB
data          ~200å­—èŠ‚   ~200MB
*/
```

---

**å®Œæˆ**: PostgreSQL 18æ•°æ®ç±»å‹æ·±åº¦è§£æ
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: æ•°å€¼ã€æ–‡æœ¬ã€æ—¥æœŸã€æ•°ç»„ã€JSONã€UUIDã€æšä¸¾ã€èŒƒå›´ã€ç½‘ç»œã€å‘é‡
