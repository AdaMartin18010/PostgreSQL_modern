---

> **📋 文档来源**: `docs\01-PostgreSQL18\31-连接管理深度优化.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# PostgreSQL 18 连接管理深度优化

## 📑 目录

- [PostgreSQL 18 连接管理深度优化](#postgresql-18-连接管理深度优化)
  - [📑 目录](#-目录)
  - [2. 连接限制](#2-连接限制)
    - [2.1 全局限制](#21-全局限制)
    - [2.2 用户/数据库限制](#22-用户数据库限制)
  - [3. 空闲连接管理](#3-空闲连接管理)
    - [3.1 自动断开空闲连接](#31-自动断开空闲连接)
  - [4. 连接池配置](#4-连接池配置)
    - [4.1 应用层连接池](#41-应用层连接池)
  - [5. 连接泄漏检测](#5-连接泄漏检测)
    - [5.1 检测工具](#51-检测工具)
  - [6. 连接故障排查](#6-连接故障排查)
    - [6.1 常见问题](#61-常见问题)

---

## 2. 连接限制

### 2.1 全局限制

```sql
-- 性能测试：查看配置（带错误处理）
BEGIN;
DO $$
BEGIN
    PERFORM current_setting('max_connections');  -- 默认100
    RAISE NOTICE 'max_connections查询成功';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询配置失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;

-- 性能测试：修改（带错误处理）
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET max_connections = 200;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'max_connections已更新，需要重启PostgreSQL生效';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '修改配置失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;

-- 性能测试：当前连接数（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM pg_stat_activity;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询连接数失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 性能测试：保留连接（带错误处理）
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET superuser_reserved_connections = 3;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'superuser_reserved_connections已更新';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '设置保留连接失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

### 2.2 用户/数据库限制

```sql
-- 性能测试：限制用户连接数（带错误处理）
BEGIN;
ALTER USER app_user CONNECTION LIMIT 50;
COMMIT;
EXCEPTION
    WHEN undefined_object THEN
        RAISE NOTICE '用户app_user不存在';
    WHEN OTHERS THEN
        RAISE NOTICE '限制用户连接数失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 性能测试：限制数据库连接数（带错误处理）
BEGIN;
ALTER DATABASE mydb CONNECTION LIMIT 100;
COMMIT;
EXCEPTION
    WHEN undefined_database THEN
        RAISE NOTICE '数据库mydb不存在';
    WHEN OTHERS THEN
        RAISE NOTICE '限制数据库连接数失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 性能测试：查看限制（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    rolname,
    rolconnlimit
FROM pg_roles
WHERE rolconnlimit != -1;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询用户连接限制失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    datconnlimit
FROM pg_database
WHERE datconnlimit != -1;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询数据库连接限制失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 3. 空闲连接管理

### 3.1 自动断开空闲连接

```sql
-- 性能测试：PostgreSQL 14+: idle_session_timeout（带错误处理）
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET idle_session_timeout = '10min';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'idle_session_timeout已更新';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '设置idle_session_timeout失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;

-- 性能测试：idle_in_transaction_session_timeout（带错误处理）
BEGIN;
DO $$
BEGIN
    ALTER SYSTEM SET idle_in_transaction_session_timeout = '5min';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'idle_in_transaction_session_timeout已更新';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '设置idle_in_transaction_session_timeout失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;

-- 性能测试：手动终止空闲连接（带错误处理）
BEGIN;
DO $$
DECLARE
    terminated_count INT := 0;
BEGIN
    SELECT COUNT(*) INTO terminated_count
    FROM pg_stat_activity
    WHERE state = 'idle'
      AND state_change < now() - INTERVAL '30 minutes'
      AND pid != pg_backend_pid();

    PERFORM pg_terminate_backend(pid)
    FROM pg_stat_activity
    WHERE state = 'idle'
      AND state_change < now() - INTERVAL '30 minutes'
      AND pid != pg_backend_pid();

    RAISE NOTICE '已终止 % 个空闲连接', terminated_count;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '终止空闲连接失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
END $$;
COMMIT;
```

---

## 4. 连接池配置

### 4.1 应用层连接池

```python
# 性能测试：Python: SQLAlchemy连接池（带错误处理）
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool
from sqlalchemy.exc import SQLAlchemyError

try:
    engine = create_engine(
        'postgresql://user:pass@localhost/mydb',
        poolclass=QueuePool,
        pool_size=20,              # 核心连接数
        max_overflow=10,           # 额外连接数
        pool_timeout=30,           # 获取连接超时
        pool_recycle=3600,         # 连接回收时间
        pool_pre_ping=True,        # 使用前检查连接
        echo_pool=True             # 日志
    )

    # 使用
    with engine.connect() as conn:
        result = conn.execute("SELECT * FROM users")
        rows = result.fetchall()
        print(f"查询结果: {len(rows)} 行")

except SQLAlchemyError as e:
    print(f"数据库操作失败: {e}")
except Exception as e:
    print(f"未知错误: {e}")
finally:
    engine.dispose()
```

---

## 5. 连接泄漏检测

### 5.1 检测工具

```sql
-- 性能测试：创建监控视图（带错误处理）
BEGIN;
CREATE OR REPLACE VIEW connection_leaks AS
SELECT
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    now() - backend_start AS connection_age,
    now() - state_change AS idle_duration,
    query
FROM pg_stat_activity
WHERE state = 'idle'
  AND now() - state_change > INTERVAL '10 minutes'
ORDER BY state_change;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '创建监控视图失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 性能测试：查询泄漏（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM connection_leaks;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE '视图connection_leaks不存在';
    WHEN OTHERS THEN
        RAISE NOTICE '查询连接泄漏失败: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 性能测试：按应用统计（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    COUNT(*) AS leak_count,
    AVG(EXTRACT(EPOCH FROM idle_duration)) AS avg_idle_seconds
FROM connection_leaks
GROUP BY application_name
ORDER BY leak_count DESC;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE '视图connection_leaks不存在';
    WHEN OTHERS THEN
        RAISE NOTICE '统计连接泄漏失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 6. 连接故障排查

### 6.1 常见问题

```sql
-- 性能测试：问题1: 连接数满（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) AS current,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max,
    ROUND(COUNT(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) AS usage_pct
FROM pg_stat_activity;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询连接数失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- 解决方案
-- 1. 使用连接池
-- 2. 增加max_connections
-- 3. 终止空闲连接

-- 性能测试：问题2: 连接建立慢（带错误处理和性能分析）
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) FILTER (WHERE state = 'active') AS active,
    COUNT(*) FILTER (WHERE state LIKE 'idle%') AS idle
FROM pg_stat_activity;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '查询连接状态失败: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- 如果idle连接多，使用连接池复用
```

---

**完成**: PostgreSQL 18连接管理深度优化
**字数**: ~8,000字
**涵盖**: 连接生命周期、限制、空闲管理、连接池、泄漏检测、故障排查
