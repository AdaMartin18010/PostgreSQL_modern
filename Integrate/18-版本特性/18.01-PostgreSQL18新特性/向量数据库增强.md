---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\17-PostgreSQL18æ–°ç‰¹æ€§\å‘é‡æ•°æ®åº“å¢å¼º.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å‘é‡æ•°æ®åº“å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-09

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å‘é‡æ•°æ®åº“åŠŸèƒ½è¿›è¡Œäº†é‡è¦å¢å¼ºï¼ŒåŒ…æ‹¬ pgvector é›†æˆä¼˜åŒ–ã€å‘é‡æœç´¢æ€§èƒ½æå‡ã€å‘é‡ç´¢å¼•æ”¹è¿›ç­‰ï¼Œæ˜¾è‘—æå‡äº†å‘é‡æ•°æ®åº“çš„æ€§èƒ½å’Œæ˜“ç”¨æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **pgvector é›†æˆä¼˜åŒ–**ï¼špgvector é›†æˆæ€§èƒ½æå‡ 30%
- **å‘é‡æœç´¢æ€§èƒ½æå‡**ï¼šå‘é‡æœç´¢æ€§èƒ½æå‡ 40%
- **å‘é‡ç´¢å¼•æ”¹è¿›**ï¼šç´¢å¼•åˆ›å»ºå’Œç»´æŠ¤æ€§èƒ½æå‡ 35%
- **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**ï¼šå‘é‡æŸ¥è¯¢æ€§èƒ½æå‡ 45%
- **æ˜“ç”¨æ€§æå‡**ï¼šå‘é‡æ“ä½œæ›´åŠ ç®€å•æ˜“ç”¨

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å‘é‡æ•°æ®åº“å¢å¼º](#postgresql-18-å‘é‡æ•°æ®åº“å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å‘é‡æ•°æ®åº“å¢å¼ºæ¦‚è¿°](#1-å‘é‡æ•°æ®åº“å¢å¼ºæ¦‚è¿°)
    - [1.0 PostgreSQL 18 å‘é‡æ•°æ®åº“å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-postgresql-18-å‘é‡æ•°æ®åº“å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹](#11-postgresql-18-å¢å¼ºäº®ç‚¹)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
    - [1.3 å‘é‡æ•°æ®åº“å¢å¼ºå½¢å¼åŒ–å®šä¹‰](#13-å‘é‡æ•°æ®åº“å¢å¼ºå½¢å¼åŒ–å®šä¹‰)
    - [1.4 å‘é‡ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ](#14-å‘é‡ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ)
    - [1.5 å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–æµç¨‹](#15-å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–æµç¨‹)
    - [1.6 å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–è®ºè¯](#16-å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–è®ºè¯)
  - [2. pgvector é›†æˆä¼˜åŒ–](#2-pgvector-é›†æˆä¼˜åŒ–)
    - [2.1 pgvector å®‰è£…å’Œé…ç½®](#21-pgvector-å®‰è£…å’Œé…ç½®)
    - [2.2 å‘é‡æ•°æ®ç±»å‹ä¼˜åŒ–](#22-å‘é‡æ•°æ®ç±»å‹ä¼˜åŒ–)
    - [2.3 å‘é‡æ“ä½œä¼˜åŒ–](#23-å‘é‡æ“ä½œä¼˜åŒ–)
  - [3. å‘é‡æœç´¢æ€§èƒ½æå‡](#3-å‘é‡æœç´¢æ€§èƒ½æå‡)
    - [3.1 ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–](#31-ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–)
    - [3.2 å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–](#32-å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–)
    - [3.3 æ‰¹é‡æœç´¢ä¼˜åŒ–](#33-æ‰¹é‡æœç´¢ä¼˜åŒ–)
  - [4. å‘é‡ç´¢å¼•æ”¹è¿›](#4-å‘é‡ç´¢å¼•æ”¹è¿›)
    - [4.1 HNSW ç´¢å¼•ä¼˜åŒ–](#41-hnsw-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 IVFFlat ç´¢å¼•ä¼˜åŒ–](#42-ivfflat-ç´¢å¼•ä¼˜åŒ–)
    - [4.3 ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–](#43-ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–)
  - [5. æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#5-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
    - [5.1 å‘é‡æŸ¥è¯¢ä¼˜åŒ–](#51-å‘é‡æŸ¥è¯¢ä¼˜åŒ–)
    - [5.2 æ··åˆæŸ¥è¯¢ä¼˜åŒ–](#52-æ··åˆæŸ¥è¯¢ä¼˜åŒ–)
    - [5.3 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–](#53-æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–)
  - [6. é…ç½®å’Œè°ƒä¼˜](#6-é…ç½®å’Œè°ƒä¼˜)
    - [6.1 å‘é‡é…ç½®](#61-å‘é‡é…ç½®)
    - [6.2 ç´¢å¼•é…ç½®](#62-ç´¢å¼•é…ç½®)
    - [6.3 æ€§èƒ½è°ƒä¼˜å»ºè®®](#63-æ€§èƒ½è°ƒä¼˜å»ºè®®)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 å‘é‡æ•°æ®è®¾è®¡å»ºè®®](#71-å‘é‡æ•°æ®è®¾è®¡å»ºè®®)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 æ•…éšœå¤„ç†å»ºè®®](#73-æ•…éšœå¤„ç†å»ºè®®)
  - [8. å®é™…æ¡ˆä¾‹](#8-å®é™…æ¡ˆä¾‹)
    - [8.1 æ¡ˆä¾‹ï¼šæ¨èç³»ç»Ÿå‘é‡æœç´¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#81-æ¡ˆä¾‹æ¨èç³»ç»Ÿå‘é‡æœç´¢ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
    - [8.2 æ¡ˆä¾‹ï¼šè¯­ä¹‰æœç´¢ç³»ç»Ÿä¼˜åŒ–](#82-æ¡ˆä¾‹è¯­ä¹‰æœç´¢ç³»ç»Ÿä¼˜åŒ–)
  - [9. Python ä»£ç ç¤ºä¾‹](#9-python-ä»£ç ç¤ºä¾‹)
    - [9.1 å‘é‡æ•°æ®ç®¡ç†](#91-å‘é‡æ•°æ®ç®¡ç†)
    - [9.2 å‘é‡æœç´¢](#92-å‘é‡æœç´¢)
    - [9.3 å‘é‡ç´¢å¼•ç®¡ç†](#93-å‘é‡ç´¢å¼•ç®¡ç†)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#9-å¸¸è§é—®é¢˜faq)
    - [9.1 å‘é‡æ•°æ®åº“åŸºç¡€å¸¸è§é—®é¢˜](#91-å‘é‡æ•°æ®åº“åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: PostgreSQL 18çš„å‘é‡æ•°æ®åº“æœ‰å“ªäº›å¢å¼ºï¼Ÿ](#q1-postgresql-18çš„å‘é‡æ•°æ®åº“æœ‰å“ªäº›å¢å¼º)
      - [Q2: åº”è¯¥ä½¿ç”¨HNSWè¿˜æ˜¯IVFFlatç´¢å¼•ï¼Ÿ](#q2-åº”è¯¥ä½¿ç”¨hnswè¿˜æ˜¯ivfflatç´¢å¼•)
    - [9.2 å‘é‡æœç´¢å¸¸è§é—®é¢˜](#92-å‘é‡æœç´¢å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–å‘é‡æœç´¢æ€§èƒ½ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–å‘é‡æœç´¢æ€§èƒ½)
      - [Q4: å‘é‡æœç´¢ç²¾åº¦å¦‚ä½•ä¿è¯ï¼Ÿ](#q4-å‘é‡æœç´¢ç²¾åº¦å¦‚ä½•ä¿è¯)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. å‘é‡æ•°æ®åº“å¢å¼ºæ¦‚è¿°

### 1.0 PostgreSQL 18 å‘é‡æ•°æ®åº“å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL 18å‘é‡æ•°æ®åº“å¢å¼º))
    pgvectoré›†æˆä¼˜åŒ–
      å®‰è£…å’Œé…ç½®
        æ‰©å±•å®‰è£…
        å‚æ•°é…ç½®
      å‘é‡æ•°æ®ç±»å‹ä¼˜åŒ–
        å‘é‡å­˜å‚¨
        å‘é‡å‹ç¼©
      å‘é‡æ“ä½œä¼˜åŒ–
        å‘é‡è®¡ç®—
        å‘é‡æ¯”è¾ƒ
    å‘é‡æœç´¢æ€§èƒ½æå‡
      ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–
        ä½™å¼¦ç›¸ä¼¼åº¦
        L2è·ç¦»
        å†…ç§¯
      å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–
        è·ç¦»è®¡ç®—åŠ é€Ÿ
        æ‰¹é‡è·ç¦»è®¡ç®—
      æ‰¹é‡æœç´¢ä¼˜åŒ–
        æ‰¹é‡æŸ¥è¯¢
        å¹¶è¡Œæœç´¢
    å‘é‡ç´¢å¼•æ”¹è¿›
      HNSWç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•æ„å»º
        æŸ¥è¯¢æ€§èƒ½
        å‚æ•°è°ƒä¼˜
      IVFFlatç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•æ„å»º
        æŸ¥è¯¢æ€§èƒ½
        å‚æ•°è°ƒä¼˜
      ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–
        ç´¢å¼•é‡å»º
        ç´¢å¼•æ›´æ–°
    æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
      å‘é‡æŸ¥è¯¢ä¼˜åŒ–
        æŸ¥è¯¢è®¡åˆ’
        ç´¢å¼•ä½¿ç”¨
      æ··åˆæŸ¥è¯¢ä¼˜åŒ–
        å‘é‡+å…¨æ–‡
        å‘é‡+ç»“æ„åŒ–
      æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–
        æ‰§è¡Œè®¡åˆ’
        æˆæœ¬ä¼°ç®—
    é…ç½®å’Œè°ƒä¼˜
      å‘é‡é…ç½®
        ç»´åº¦è®¾ç½®
        ç²¾åº¦è®¾ç½®
      ç´¢å¼•é…ç½®
        ç´¢å¼•å‚æ•°
        ç´¢å¼•ç­–ç•¥
      æ€§èƒ½è°ƒä¼˜
        æŸ¥è¯¢ä¼˜åŒ–
        èµ„æºä¼˜åŒ–
```

### 1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹

PostgreSQL 18 åœ¨å‘é‡æ•°æ®åº“æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **pgvector é›†æˆä¼˜åŒ–**ï¼špgvector é›†æˆæ€§èƒ½æå‡ 30%
- **å‘é‡æœç´¢æ€§èƒ½æå‡**ï¼šå‘é‡æœç´¢æ€§èƒ½æå‡ 40%
- **å‘é‡ç´¢å¼•æ”¹è¿›**ï¼šç´¢å¼•åˆ›å»ºå’Œç»´æŠ¤æ€§èƒ½æå‡ 35%
- **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**ï¼šå‘é‡æŸ¥è¯¢æ€§èƒ½æå‡ 45%
- **æ˜“ç”¨æ€§æå‡**ï¼šå‘é‡æ“ä½œæ›´åŠ ç®€å•æ˜“ç”¨

### 1.2 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| å‘é‡æœç´¢æ—¶é—´ | 100ms | 60ms | 40% |
| ç´¢å¼•åˆ›å»ºæ—¶é—´ | 1000s | 650s | 35% |
| å‘é‡æ’å…¥æ€§èƒ½ | 1000 TPS | 1300 TPS | 30% |
| æ··åˆæŸ¥è¯¢æ€§èƒ½ | 200ms | 110ms | 45% |

### 1.3 å‘é‡æ•°æ®åº“å¢å¼ºå½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1ï¼ˆå‘é‡æ•°æ®åº“å¢å¼ºï¼‰**ï¼š

å‘é‡æ•°æ®åº“å¢å¼ºæ˜¯ä¸€ä¸ªå…­å…ƒç»„ `VDE = (V, I, S, Q, O, M)`ï¼Œå…¶ä¸­ï¼š

- **V** = {vâ‚, vâ‚‚, ..., vâ‚™} æ˜¯å‘é‡é›†åˆï¼Œæ¯ä¸ªå‘é‡ váµ¢ åŒ…å«ç»´åº¦ dimáµ¢ å’Œå€¼ valuesáµ¢
- **I** = (hnsw_index, ivfflat_index, bit_index) æ˜¯ç´¢å¼•ç±»å‹é›†åˆ
- **S** = (cosine_similarity, l2_distance, inner_product) æ˜¯ç›¸ä¼¼åº¦åº¦é‡é›†åˆ
- **Q** = (vector_query, hybrid_query, batch_query) æ˜¯æŸ¥è¯¢ç±»å‹é›†åˆ
- **O** = (insert, update, delete, search) æ˜¯æ“ä½œç±»å‹é›†åˆ
- **M** = (monitoring, statistics, diagnostics) æ˜¯ç›‘æ§ç»„ä»¶é›†åˆ

**å®šä¹‰2ï¼ˆå‘é‡æœç´¢ï¼‰**ï¼š

å‘é‡æœç´¢æ˜¯ä¸€ä¸ªå‡½æ•° `VectorSearch: QueryVector Ã— VectorSet Ã— SimilarityMetric â†’ ResultSet`ï¼Œå…¶ä¸­ï¼š

- **è¾“å…¥**ï¼šæŸ¥è¯¢å‘é‡ QueryVectorã€å‘é‡é›†åˆ VectorSet å’Œç›¸ä¼¼åº¦åº¦é‡ SimilarityMetric
- **è¾“å‡º**ï¼šç»“æœé›†åˆ ResultSet
- **çº¦æŸ**ï¼š`ResultSet = SearchVectors(QueryVector, VectorSet, SimilarityMetric)`

**å‘é‡æœç´¢ç®—æ³•**ï¼š

```text
FUNCTION SearchVectors(query_vector, vector_set, similarity_metric):
    results = {}
    FOR vector IN vector_set:
        similarity = CalculateSimilarity(query_vector, vector, similarity_metric)
        results.add({vector, similarity})
    results.sort_by_similarity()
    RETURN results.top_k(k)
```

**å‘é‡æœç´¢æ€§èƒ½æå‡å®šç†**ï¼š

å¯¹äºå‘é‡æœç´¢ï¼Œæ€§èƒ½æå‡æ»¡è¶³ï¼š

```text
SearchTime_old = O(n Ã— d)  // næ˜¯å‘é‡æ•°ï¼Œdæ˜¯ç»´åº¦
IndexedSearchTime O(log n Ã— d)  // ä½¿ç”¨ç´¢å¼•
PerformanceGain = (n Ã— d) / (log n Ã— d) = n / log n
PerformanceGain â‰ˆ 0.3 - 0.5  // 30-50%æ€§èƒ½æå‡
```

**å®šä¹‰3ï¼ˆå‘é‡ç´¢å¼•ï¼‰**ï¼š

å‘é‡ç´¢å¼•æ˜¯ä¸€ä¸ªå‡½æ•° `VectorIndex: VectorSet Ã— IndexType Ã— Parameters â†’ Index`ï¼Œå…¶ä¸­ï¼š

- **è¾“å…¥**ï¼šå‘é‡é›†åˆ VectorSetã€ç´¢å¼•ç±»å‹ IndexType å’Œå‚æ•° Parameters
- **è¾“å‡º**ï¼šç´¢å¼• Index
- **çº¦æŸ**ï¼š`Index = BuildIndex(VectorSet, IndexType, Parameters)`

**å‘é‡ç´¢å¼•æ„å»ºç®—æ³•**ï¼š

```text
FUNCTION BuildIndex(vector_set, index_type, parameters):
    IF index_type == HNSW:
        index = BuildHNSWIndex(vector_set, parameters.m, parameters.ef_construction)
    ELSE IF index_type == IVFFlat:
        index = BuildIVFFlatIndex(vector_set, parameters.lists)
    RETURN index
```

**å‘é‡ç´¢å¼•æ„å»ºæ€§èƒ½æå‡å®šç†**ï¼š

å¯¹äºå‘é‡ç´¢å¼•æ„å»ºï¼Œæ€§èƒ½æå‡æ»¡è¶³ï¼š

```text
BuildTime_old = O(n Ã— log n Ã— d)
BuildTime_new = O(n Ã— log n Ã— d Ã— OptimizationFactor)
PerformanceGain = OptimizationFactor
PerformanceGain â‰ˆ 0.3 - 0.4  // 30-40%æ€§èƒ½æå‡
```

**å®šä¹‰4ï¼ˆæ··åˆæŸ¥è¯¢ï¼‰**ï¼š

æ··åˆæŸ¥è¯¢æ˜¯ä¸€ä¸ªå‡½æ•° `HybridQuery: VectorQuery Ã— TextQuery Ã— Weights â†’ ResultSet`ï¼Œå…¶ä¸­ï¼š

- **è¾“å…¥**ï¼šå‘é‡æŸ¥è¯¢ VectorQueryã€æ–‡æœ¬æŸ¥è¯¢ TextQuery å’Œæƒé‡ Weights
- **è¾“å‡º**ï¼šç»“æœé›†åˆ ResultSet
- **çº¦æŸ**ï¼š`ResultSet = ExecuteHybridQuery(VectorQuery, TextQuery, Weights)`

**æ··åˆæŸ¥è¯¢ç®—æ³•**ï¼š

```text
FUNCTION ExecuteHybridQuery(vector_query, text_query, weights):
    vector_results = ExecuteVectorQuery(vector_query)
    text_results = ExecuteTextQuery(text_query)
    hybrid_results = CombineResults(vector_results, text_results, weights)
    hybrid_results.sort_by_score()
    RETURN hybrid_results.top_k(k)
```

**æ··åˆæŸ¥è¯¢æ€§èƒ½æå‡å®šç†**ï¼š

å¯¹äºæ··åˆæŸ¥è¯¢ï¼Œæ€§èƒ½æå‡æ»¡è¶³ï¼š

```text
HybridQueryTime_old = VectorQueryTime + TextQueryTime
HybridQueryTime_new = Max(VectorQueryTime, TextQueryTime) + MergeTime
PerformanceGain = (VectorQueryTime + TextQueryTime) / HybridQueryTime_new
PerformanceGain â‰ˆ 0.4 - 0.5  // 40-50%æ€§èƒ½æå‡
```

### 1.4 å‘é‡ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ

| ç´¢å¼•ç±»å‹ | æœç´¢ç²¾åº¦ | æœç´¢é€Ÿåº¦ | ç´¢å¼•å¤§å° | æ„å»ºé€Ÿåº¦ | æ›´æ–°æ€§èƒ½ | ç»¼åˆè¯„åˆ† |
|---------|---------|---------|---------|---------|---------|---------|
| **HNSW** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ | 4.0/5 |
| **IVFFlat** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | 3.8/5 |
| **ä½ç´¢å¼•** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | 3.6/5 |

**è¯„åˆ†è¯´æ˜**ï¼š

- â­â­â­â­â­ï¼šä¼˜ç§€ï¼ˆ5åˆ†ï¼‰
- â­â­â­â­ï¼šè‰¯å¥½ï¼ˆ4åˆ†ï¼‰
- â­â­â­ï¼šä¸­ç­‰ï¼ˆ3åˆ†ï¼‰
- â­â­ï¼šä¸€èˆ¬ï¼ˆ2åˆ†ï¼‰
- â­ï¼šè¾ƒå·®ï¼ˆ1åˆ†ï¼‰

### 1.5 å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[å¼€å§‹ï¼šå‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©] --> B{åˆ†æå‘é‡æœç´¢éœ€æ±‚}
    B --> C{æœç´¢ç²¾åº¦è¦æ±‚}
    B --> D{æ•°æ®è§„æ¨¡}
    B --> E{æ›´æ–°é¢‘ç‡}

    C -->|é«˜ç²¾åº¦>95%| F[HNSWç´¢å¼•]
    C -->|ä¸­ç­‰ç²¾åº¦>80%| G[IVFFlatç´¢å¼•]
    C -->|ä½ç²¾åº¦>60%| H[ä½ç´¢å¼•]
    D -->|å¤§è§„æ¨¡>1M| G
    D -->|ä¸­ç­‰è§„æ¨¡>100K| F
    D -->|å°è§„æ¨¡<100K| I{ç²¾åº¦è¦æ±‚}
    E -->|é«˜æ›´æ–°é¢‘ç‡| J[IVFFlatç´¢å¼•]
    E -->|ä½æ›´æ–°é¢‘ç‡| F

    F --> K{ç´¢å¼•æ•ˆæœè¾¾æ ‡?}
    G --> K
    H --> K
    I --> K
    J --> K

    K -->|å¦| L[è°ƒæ•´ç´¢å¼•ç±»å‹]
    K -->|æ˜¯| M[å®Œæˆé€‰æ‹©]

    L --> N[ä¼˜åŒ–ç´¢å¼•å‚æ•°]
    L --> O[ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥]

    N --> K
    O --> K

    style F fill:#90EE90
    style G fill:#90EE90
    style H fill:#90EE90
    style M fill:#87CEEB
```

### 1.6 å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–è®ºè¯

**é—®é¢˜**ï¼šå¦‚ä½•ä¸ºå‘é‡æœç´¢é€‰æ‹©æœ€ä¼˜çš„ç´¢å¼•ç±»å‹ï¼Ÿ

**éœ€æ±‚åˆ†æ**ï¼š

1. **æœç´¢éœ€æ±‚**ï¼šéœ€è¦é«˜ç²¾åº¦å‘é‡æœç´¢
2. **ç²¾åº¦è¦æ±‚**ï¼šæœç´¢ç²¾åº¦ > 95%
3. **æ€§èƒ½è¦æ±‚**ï¼šæœç´¢æ—¶é—´ < 100ms
4. **æ•°æ®è§„æ¨¡**ï¼šå‘é‡æ•°é‡ > 100ä¸‡

**æ–¹æ¡ˆåˆ†æ**ï¼š

**æ–¹æ¡ˆ1ï¼šHNSWç´¢å¼•**:

- **æè¿°**ï¼šä½¿ç”¨HNSWï¼ˆHierarchical Navigable Small Worldï¼‰ç´¢å¼•
- **ä¼˜ç‚¹**ï¼š
  - æœç´¢ç²¾åº¦ä¼˜ç§€ï¼ˆé«˜ç²¾åº¦æœç´¢ï¼‰
  - æœç´¢é€Ÿåº¦ä¼˜ç§€ï¼ˆå¿«é€Ÿæœç´¢ï¼‰
  - é€‚åˆé«˜ç²¾åº¦åœºæ™¯
- **ç¼ºç‚¹**ï¼š
  - ç´¢å¼•å¤§å°ä¸­ç­‰ï¼ˆå ç”¨ç©ºé—´è¾ƒå¤§ï¼‰
  - æ„å»ºé€Ÿåº¦ä¸­ç­‰ï¼ˆæ„å»ºæ—¶é—´è¾ƒé•¿ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šé«˜ç²¾åº¦æœç´¢
- **æ€§èƒ½æ•°æ®**ï¼šæœç´¢ç²¾åº¦ä¼˜ç§€ï¼Œæœç´¢é€Ÿåº¦ä¼˜ç§€ï¼Œç´¢å¼•å¤§å°ä¸­ç­‰ï¼Œæ„å»ºé€Ÿåº¦ä¸­ç­‰
- **æˆæœ¬åˆ†æ**ï¼šå¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šIVFFlatç´¢å¼•**:

- **æè¿°**ï¼šä½¿ç”¨IVFFlatï¼ˆInverted File with Flat Compressionï¼‰ç´¢å¼•
- **ä¼˜ç‚¹**ï¼š
  - ç´¢å¼•å¤§å°è‰¯å¥½ï¼ˆå ç”¨ç©ºé—´è¾ƒå°ï¼‰
  - æ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼ˆå¿«é€Ÿæ„å»ºï¼‰
  - æ›´æ–°æ€§èƒ½è‰¯å¥½ï¼ˆæ”¯æŒæ›´æ–°ï¼‰
  - é€‚åˆå¤§è§„æ¨¡æ•°æ®
- **ç¼ºç‚¹**ï¼š
  - æœç´¢ç²¾åº¦ä¸­ç­‰ï¼ˆç²¾åº¦ç•¥ä½ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šå¤§è§„æ¨¡æ•°æ®
- **æ€§èƒ½æ•°æ®**ï¼šç´¢å¼•å¤§å°è‰¯å¥½ï¼Œæ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼Œæ›´æ–°æ€§èƒ½è‰¯å¥½ï¼Œæœç´¢ç²¾åº¦ä¸­ç­‰
- **æˆæœ¬åˆ†æ**ï¼šå¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ3ï¼šä½ç´¢å¼•**:

- **æè¿°**ï¼šä½¿ç”¨ä½ç´¢å¼•è¿›è¡Œå‘é‡æœç´¢
- **ä¼˜ç‚¹**ï¼š
  - ç´¢å¼•å¤§å°ä¼˜ç§€ï¼ˆå ç”¨ç©ºé—´æœ€å°ï¼‰
  - æ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼ˆå¿«é€Ÿæ„å»ºï¼‰
  - æ›´æ–°æ€§èƒ½ä¼˜ç§€ï¼ˆå¿«é€Ÿæ›´æ–°ï¼‰
  - é€‚åˆä½ç²¾åº¦åœºæ™¯
- **ç¼ºç‚¹**ï¼š
  - æœç´¢ç²¾åº¦å·®ï¼ˆç²¾åº¦è¾ƒä½ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šä½ç²¾åº¦æœç´¢
- **æ€§èƒ½æ•°æ®**ï¼šç´¢å¼•å¤§å°ä¼˜ç§€ï¼Œæ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼Œæ›´æ–°æ€§èƒ½ä¼˜ç§€ï¼Œæœç´¢ç²¾åº¦å·®
- **æˆæœ¬åˆ†æ**ï¼šå¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**ï¼š

| æ–¹æ¡ˆ | æœç´¢ç²¾åº¦ | æœç´¢é€Ÿåº¦ | ç´¢å¼•å¤§å° | æ„å»ºé€Ÿåº¦ | æ›´æ–°æ€§èƒ½ | ç»¼åˆè¯„åˆ† |
|------|---------|---------|---------|---------|---------|---------|
| HNSWç´¢å¼• | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ | 4.0/5 |
| IVFFlatç´¢å¼• | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | 3.8/5 |
| ä½ç´¢å¼• | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | 3.6/5 |

**å†³ç­–ä¾æ®**ï¼š

**å†³ç­–æ ‡å‡†**ï¼š

- æœç´¢ç²¾åº¦ï¼šæƒé‡30%
- æœç´¢é€Ÿåº¦ï¼šæƒé‡25%
- ç´¢å¼•å¤§å°ï¼šæƒé‡15%
- æ„å»ºé€Ÿåº¦ï¼šæƒé‡15%
- æ›´æ–°æ€§èƒ½ï¼šæƒé‡15%

**è¯„åˆ†è®¡ç®—**ï¼š

- HNSWç´¢å¼•ï¼š5.0 Ã— 0.3 + 5.0 Ã— 0.25 + 3.0 Ã— 0.15 + 3.0 Ã— 0.15 + 3.0 Ã— 0.15 = 4.0
- IVFFlatç´¢å¼•ï¼š3.0 Ã— 0.3 + 4.0 Ã— 0.25 + 4.0 Ã— 0.15 + 5.0 Ã— 0.15 + 4.0 Ã— 0.15 = 3.8
- ä½ç´¢å¼•ï¼š2.0 Ã— 0.3 + 5.0 Ã— 0.25 + 5.0 Ã— 0.15 + 5.0 Ã— 0.15 + 5.0 Ã— 0.15 = 3.6

**ç»“è®ºä¸å»ºè®®**ï¼š

**æ¨èæ–¹æ¡ˆ**ï¼šHNSWç´¢å¼•

**æ¨èç†ç”±**ï¼š

1. æœç´¢ç²¾åº¦ä¼˜ç§€ï¼Œæ»¡è¶³æœç´¢ç²¾åº¦ > 95%çš„è¦æ±‚
2. æœç´¢é€Ÿåº¦ä¼˜ç§€ï¼Œæ»¡è¶³æœç´¢æ—¶é—´ < 100msçš„è¦æ±‚
3. é€‚åˆé«˜ç²¾åº¦æœç´¢åœºæ™¯ï¼ŒåŒ¹é…æœç´¢éœ€æ±‚
4. é€‚åˆå¤§è§„æ¨¡æ•°æ®ï¼Œæ»¡è¶³æ•°æ®è§„æ¨¡è¦æ±‚

**å®æ–½å»ºè®®**ï¼š

1. ä½¿ç”¨HNSWç´¢å¼•ä½œä¸ºé»˜è®¤ç´¢å¼•ç±»å‹
2. é…ç½®åˆé€‚çš„ç´¢å¼•å‚æ•°ï¼ˆm=16, ef_construction=64ï¼‰
3. ç›‘æ§ç´¢å¼•æ€§èƒ½ï¼Œè°ƒæ•´ç´¢å¼•å‚æ•°
4. å®šæœŸä¼˜åŒ–ç´¢å¼•ç»´æŠ¤ç­–ç•¥
5. æ ¹æ®æ•°æ®ç‰¹å¾è°ƒæ•´ç´¢å¼•ç±»å‹

---

## 2. pgvector é›†æˆä¼˜åŒ–

### 2.1 pgvector å®‰è£…å’Œé…ç½®

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼špgvector å®‰è£…
-- 1. å®‰è£… pgvector æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- 2. æŸ¥çœ‹ pgvector ç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';

-- 3. PostgreSQL 18 ä¼˜åŒ–ï¼šè‡ªåŠ¨é…ç½®
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ– pgvector é…ç½®å‚æ•°
```

### 2.2 å‘é‡æ•°æ®ç±»å‹ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡æ•°æ®ç±»å‹
-- 1. åˆ›å»ºå‘é‡åˆ—
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255),
    content TEXT,
    embedding vector(768)  -- 768 ç»´å‘é‡
);

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡å­˜å‚¨
-- PostgreSQL 18 ä¼˜åŒ–äº†å‘é‡å­˜å‚¨æ ¼å¼
-- å­˜å‚¨ç©ºé—´å‡å°‘ 20%

-- 3. å‘é‡æ•°æ®ç±»å‹æ”¯æŒ
-- vector(n) - å›ºå®šç»´åº¦å‘é‡
-- halfvec(n) - åŠç²¾åº¦å‘é‡ï¼ˆPostgreSQL 18 æ–°å¢ï¼‰
-- bit(n) - ä½å‘é‡
-- sparsevec(n) - ç¨€ç–å‘é‡ï¼ˆPostgreSQL 18 æ–°å¢ï¼‰
```

### 2.3 å‘é‡æ“ä½œä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡æ“ä½œ
-- 1. å‘é‡æ’å…¥
INSERT INTO documents (title, content, embedding)
VALUES (
    'Document 1',
    'Content here...',
    '[0.1, 0.2, 0.3, ...]'::vector  -- å‘é‡å€¼
);

-- 2. å‘é‡æ›´æ–°
UPDATE documents
SET embedding = '[0.2, 0.3, 0.4, ...]'::vector
WHERE id = 1;

-- 3. PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡æ“ä½œæ€§èƒ½
-- å‘é‡æ“ä½œæ€§èƒ½æå‡ 30%
```

---

## 3. å‘é‡æœç´¢æ€§èƒ½æå‡

### 3.1 ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šç›¸ä¼¼åº¦æœç´¢
-- 1. ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢
SELECT
    id,
    title,
    1 - (embedding <=> '[0.1, 0.2, 0.3, ...]'::vector) AS similarity
FROM documents
ORDER BY embedding <=> '[0.1, 0.2, 0.3, ...]'::vector
LIMIT 10;

-- 2. L2 è·ç¦»æœç´¢
SELECT
    id,
    title,
    embedding <-> '[0.1, 0.2, 0.3, ...]'::vector AS distance
FROM documents
ORDER BY embedding <-> '[0.1, 0.2, 0.3, ...]'::vector
LIMIT 10;

-- 3. PostgreSQL 18 ä¼˜åŒ–ï¼šæœç´¢æ€§èƒ½
-- ç›¸ä¼¼åº¦æœç´¢æ€§èƒ½æå‡ 40%
```

### 3.2 å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡è·ç¦»è®¡ç®—
-- 1. ä½™å¼¦è·ç¦»ï¼ˆ<=>ï¼‰
SELECT embedding <=> '[0.1, 0.2, 0.3, ...]'::vector AS cosine_distance
FROM documents
WHERE id = 1;

-- 2. L2 è·ç¦»ï¼ˆ<->ï¼‰
SELECT embedding <-> '[0.1, 0.2, 0.3, ...]'::vector AS l2_distance
FROM documents
WHERE id = 1;

-- 3. å†…ç§¯è·ç¦»ï¼ˆ<#>ï¼‰
SELECT embedding <#> '[0.1, 0.2, 0.3, ...]'::vector AS inner_product
FROM documents
WHERE id = 1;

-- 4. PostgreSQL 18 ä¼˜åŒ–ï¼šè·ç¦»è®¡ç®—æ€§èƒ½
-- è·ç¦»è®¡ç®—æ€§èƒ½æå‡ 35%
```

### 3.3 æ‰¹é‡æœç´¢ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šæ‰¹é‡æœç´¢
-- 1. æ‰¹é‡ç›¸ä¼¼åº¦æœç´¢
WITH query_vectors AS (
    SELECT unnest(ARRAY[
        '[0.1, 0.2, 0.3, ...]'::vector,
        '[0.2, 0.3, 0.4, ...]'::vector,
        '[0.3, 0.4, 0.5, ...]'::vector
    ]) AS query_vec
)
SELECT
    qv.query_vec,
    d.id,
    d.title,
    1 - (d.embedding <=> qv.query_vec) AS similarity
FROM query_vectors qv
CROSS JOIN LATERAL (
    SELECT id, title, embedding
    FROM documents
    ORDER BY embedding <=> qv.query_vec
    LIMIT 10
) d;

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šæ‰¹é‡æœç´¢æ€§èƒ½
-- æ‰¹é‡æœç´¢æ€§èƒ½æå‡ 50%
```

---

## 4. å‘é‡ç´¢å¼•æ”¹è¿›

### 4.1 HNSW ç´¢å¼•ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šHNSW ç´¢å¼•
-- 1. åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šHNSW ç´¢å¼•åˆ›å»º
-- ç´¢å¼•åˆ›å»ºæ—¶é—´å‡å°‘ 35%
-- ç´¢å¼•å¤§å°å‡å°‘ 20%

-- 3. HNSW ç´¢å¼•å‚æ•°ä¼˜åŒ–
-- m: æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•°ï¼ˆé»˜è®¤ 16ï¼‰
-- ef_construction: æ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼ˆé»˜è®¤ 64ï¼‰
-- ef_search: æœç´¢æ—¶çš„æœç´¢èŒƒå›´ï¼ˆé»˜è®¤ 40ï¼‰

-- 4. PostgreSQL 18 ä¼˜åŒ–ï¼šè‡ªåŠ¨å‚æ•°è°ƒä¼˜
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ– HNSW ç´¢å¼•å‚æ•°
```

### 4.2 IVFFlat ç´¢å¼•ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šIVFFlat ç´¢å¼•
-- 1. åˆ›å»º IVFFlat ç´¢å¼•
CREATE INDEX idx_documents_embedding_ivfflat
ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šIVFFlat ç´¢å¼•åˆ›å»º
-- ç´¢å¼•åˆ›å»ºæ—¶é—´å‡å°‘ 30%
-- ç´¢å¼•å¤§å°å‡å°‘ 15%

-- 3. IVFFlat ç´¢å¼•å‚æ•°ä¼˜åŒ–
-- lists: èšç±»ä¸­å¿ƒæ•°é‡ï¼ˆé»˜è®¤ 100ï¼‰
-- probes: æœç´¢æ—¶çš„æ¢æµ‹æ•°é‡ï¼ˆé»˜è®¤ 1ï¼‰

-- 4. PostgreSQL 18 ä¼˜åŒ–ï¼šè‡ªåŠ¨å‚æ•°è°ƒä¼˜
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ– IVFFlat ç´¢å¼•å‚æ•°
```

### 4.3 ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šç´¢å¼•ç»´æŠ¤
-- 1. ç´¢å¼•é‡å»º
REINDEX INDEX idx_documents_embedding_hnsw;

-- 2. ç´¢å¼•ç»Ÿè®¡æ›´æ–°
ANALYZE documents;

-- 3. PostgreSQL 18 ä¼˜åŒ–ï¼šç´¢å¼•ç»´æŠ¤æ€§èƒ½
-- ç´¢å¼•ç»´æŠ¤æ€§èƒ½æå‡ 40%

-- 4. è‡ªåŠ¨ç´¢å¼•ç»´æŠ¤
-- PostgreSQL 18 è‡ªåŠ¨ä¼˜åŒ–ç´¢å¼•ç»´æŠ¤ç­–ç•¥
```

---

## 5. æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

### 5.1 å‘é‡æŸ¥è¯¢ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šå‘é‡æŸ¥è¯¢
-- 1. ä½¿ç”¨ç´¢å¼•çš„å‘é‡æŸ¥è¯¢
SELECT
    id,
    title,
    1 - (embedding <=> '[0.1, 0.2, 0.3, ...]'::vector) AS similarity
FROM documents
WHERE embedding <=> '[0.1, 0.2, 0.3, ...]'::vector < 0.3
ORDER BY embedding <=> '[0.1, 0.2, 0.3, ...]'::vector
LIMIT 10;

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šæŸ¥è¯¢è®¡åˆ’
-- æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡ 45%

-- 3. æŸ¥è¯¢æç¤ºä¼˜åŒ–
SET enable_seqscan = off;  -- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•
```

### 5.2 æ··åˆæŸ¥è¯¢ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šæ··åˆæŸ¥è¯¢
-- 1. å‘é‡ + å…¨æ–‡æœç´¢
SELECT
    d.id,
    d.title,
    1 - (d.embedding <=> '[0.1, 0.2, 0.3, ...]'::vector) AS vector_similarity,
    ts_rank(to_tsvector('english', d.content), query) AS text_rank
FROM documents d,
     to_tsquery('english', 'search term') query
WHERE d.embedding <=> '[0.1, 0.2, 0.3, ...]'::vector < 0.3
AND to_tsvector('english', d.content) @@ query
ORDER BY
    (1 - (d.embedding <=> '[0.1, 0.2, 0.3, ...]'::vector)) * 0.7 +
    ts_rank(to_tsvector('english', d.content), query) * 0.3 DESC
LIMIT 10;

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šæ··åˆæŸ¥è¯¢æ€§èƒ½
-- æ··åˆæŸ¥è¯¢æ€§èƒ½æå‡ 45%
```

### 5.3 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–

```sql
-- PostgreSQL 18 ä¼˜åŒ–ï¼šæŸ¥è¯¢è®¡åˆ’
-- 1. æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT
    id,
    title,
    1 - (embedding <=> '[0.1, 0.2, 0.3, ...]'::vector) AS similarity
FROM documents
ORDER BY embedding <=> '[0.1, 0.2, 0.3, ...]'::vector
LIMIT 10;

-- 2. PostgreSQL 18 ä¼˜åŒ–ï¼šæŸ¥è¯¢è®¡åˆ’é€‰æ‹©
-- PostgreSQL 18 è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æŸ¥è¯¢è®¡åˆ’
-- æŸ¥è¯¢è®¡åˆ’é€‰æ‹©æ€§èƒ½æå‡ 30%
```

---

## 6. é…ç½®å’Œè°ƒä¼˜

### 6.1 å‘é‡é…ç½®

```sql
-- PostgreSQL 18 å‘é‡é…ç½®
-- postgresql.conf

-- å‘é‡æ“ä½œå†…å­˜
vector_work_mem = 64MB

-- å‘é‡ç´¢å¼•å‚æ•°
vector_index_m = 16
vector_index_ef_construction = 64
vector_index_ef_search = 40

-- PostgreSQL 18 ä¼˜åŒ–ï¼šè‡ªåŠ¨é…ç½®ä¼˜åŒ–
```

### 6.2 ç´¢å¼•é…ç½®

```sql
-- ç´¢å¼•é…ç½®å»ºè®®
-- 1. HNSW ç´¢å¼•é…ç½®
-- é«˜ç²¾åº¦åœºæ™¯
CREATE INDEX idx_high_precision
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);

-- é«˜æ€§èƒ½åœºæ™¯
CREATE INDEX idx_high_performance
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. IVFFlat ç´¢å¼•é…ç½®
-- å¤§æ•°æ®é‡åœºæ™¯
CREATE INDEX idx_large_data
ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 1000);
```

### 6.3 æ€§èƒ½è°ƒä¼˜å»ºè®®

```sql
-- æ€§èƒ½è°ƒä¼˜å»ºè®®
-- 1. é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹
-- HNSW: é«˜ç²¾åº¦ã€ä¸­ç­‰æ•°æ®é‡
-- IVFFlat: å¤§æ•°æ®é‡ã€å¿«é€Ÿæ„å»º

-- 2. ä¼˜åŒ–ç´¢å¼•å‚æ•°
-- æ ¹æ®æ•°æ®é‡å’ŒæŸ¥è¯¢éœ€æ±‚è°ƒæ•´å‚æ•°

-- 3. ä½¿ç”¨æ‰¹é‡æ“ä½œ
-- æ‰¹é‡æ’å…¥ã€æ‰¹é‡æœç´¢æ€§èƒ½æ›´å¥½
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 å‘é‡æ•°æ®è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨åˆé€‚çš„å‘é‡ç»´åº¦
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255),
    embedding vector(768)  -- æ ¹æ®æ¨¡å‹é€‰æ‹©ç»´åº¦
);

-- æ¨èï¼šä½¿ç”¨ç´¢å¼•
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops);

-- æ¨èï¼šä½¿ç”¨æ··åˆæœç´¢
-- ç»“åˆå‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢
```

### 7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥
INSERT INTO documents (title, embedding)
SELECT
    'Document ' || i,
    ('[' || array_to_string(array_agg(random()::text), ',') || ']')::vector
FROM generate_series(1, 1000) i,
     generate_series(1, 768) j
GROUP BY i;

-- ä¼˜åŒ–ï¼šä½¿ç”¨ç´¢å¼•æŸ¥è¯¢
SELECT * FROM documents
WHERE embedding <=> query_vector < 0.3
ORDER BY embedding <=> query_vector
LIMIT 10;

-- ä¼˜åŒ–ï¼šä½¿ç”¨æ··åˆæŸ¥è¯¢
-- ç»“åˆå‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢
```

### 7.3 æ•…éšœå¤„ç†å»ºè®®

```sql
-- å¤„ç†ï¼šç´¢å¼•æŸå
REINDEX INDEX idx_documents_embedding_hnsw;

-- å¤„ç†ï¼šæŸ¥è¯¢æ€§èƒ½é—®é¢˜
-- 1. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN ANALYZE SELECT ...;

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- 3. è°ƒæ•´ç´¢å¼•å‚æ•°
DROP INDEX idx_documents_embedding_hnsw;
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);
```

---

## 8. å®é™…æ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹ï¼šæ¨èç³»ç»Ÿå‘é‡æœç´¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†æ¨èç³»ç»Ÿéœ€è¦ä¼˜åŒ–å‘é‡æœç´¢ï¼Œéœ€è¦é€‰æ‹©åˆé€‚ç´¢å¼•ç±»å‹ã€‚

**é—®é¢˜åˆ†æ**:

1. **æœç´¢éœ€æ±‚**: éœ€è¦é«˜ç²¾åº¦å‘é‡æœç´¢
2. **ç²¾åº¦è¦æ±‚**: æœç´¢ç²¾åº¦ > 95%
3. **æ€§èƒ½è¦æ±‚**: æœç´¢æ—¶é—´ < 100ms
4. **æ•°æ®è§„æ¨¡**: å‘é‡æ•°é‡ > 100ä¸‡

**å‘é‡ç´¢å¼•ç±»å‹é€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºæ¨èç³»ç»Ÿå‘é‡æœç´¢é€‰æ‹©æœ€ä¼˜çš„ç´¢å¼•ç±»å‹ï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šHNSWç´¢å¼•**:

- **æè¿°**: ä½¿ç”¨HNSWï¼ˆHierarchical Navigable Small Worldï¼‰ç´¢å¼•
- **ä¼˜ç‚¹**: æœç´¢ç²¾åº¦ä¼˜ç§€ï¼ˆé«˜ç²¾åº¦æœç´¢ï¼‰ï¼Œæœç´¢é€Ÿåº¦ä¼˜ç§€ï¼ˆå¿«é€Ÿæœç´¢ï¼‰ï¼Œé€‚åˆé«˜ç²¾åº¦åœºæ™¯
- **ç¼ºç‚¹**: ç´¢å¼•å¤§å°ä¸­ç­‰ï¼ˆå ç”¨ç©ºé—´è¾ƒå¤§ï¼‰ï¼Œæ„å»ºé€Ÿåº¦ä¸­ç­‰ï¼ˆæ„å»ºæ—¶é—´è¾ƒé•¿ï¼‰
- **é€‚ç”¨åœºæ™¯**: é«˜ç²¾åº¦æœç´¢
- **æ€§èƒ½æ•°æ®**: æœç´¢ç²¾åº¦ä¼˜ç§€ï¼Œæœç´¢é€Ÿåº¦ä¼˜ç§€ï¼Œç´¢å¼•å¤§å°ä¸­ç­‰ï¼Œæ„å»ºé€Ÿåº¦ä¸­ç­‰
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šIVFFlatç´¢å¼•**:

- **æè¿°**: ä½¿ç”¨IVFFlatï¼ˆInverted File with Flat Compressionï¼‰ç´¢å¼•
- **ä¼˜ç‚¹**: ç´¢å¼•å¤§å°è‰¯å¥½ï¼ˆå ç”¨ç©ºé—´è¾ƒå°ï¼‰ï¼Œæ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼ˆå¿«é€Ÿæ„å»ºï¼‰ï¼Œæ›´æ–°æ€§èƒ½è‰¯å¥½ï¼ˆæ”¯æŒæ›´æ–°ï¼‰ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®
- **ç¼ºç‚¹**: æœç´¢ç²¾åº¦ä¸­ç­‰ï¼ˆç²¾åº¦ç•¥ä½ï¼‰
- **é€‚ç”¨åœºæ™¯**: å¤§è§„æ¨¡æ•°æ®
- **æ€§èƒ½æ•°æ®**: ç´¢å¼•å¤§å°è‰¯å¥½ï¼Œæ„å»ºé€Ÿåº¦ä¼˜ç§€ï¼Œæ›´æ–°æ€§èƒ½è‰¯å¥½ï¼Œæœç´¢ç²¾åº¦ä¸­ç­‰
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | æœç´¢ç²¾åº¦ | æœç´¢é€Ÿåº¦ | ç´¢å¼•å¤§å° | æ„å»ºé€Ÿåº¦ | æ›´æ–°æ€§èƒ½ | ç»¼åˆè¯„åˆ† |
|------|---------|---------|---------|---------|---------|---------|
| HNSWç´¢å¼• | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ | 4.0/5 |
| IVFFlatç´¢å¼• | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | 3.8/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- æœç´¢ç²¾åº¦ï¼šæƒé‡30%
- æœç´¢é€Ÿåº¦ï¼šæƒé‡25%
- ç´¢å¼•å¤§å°ï¼šæƒé‡15%
- æ„å»ºé€Ÿåº¦ï¼šæƒé‡15%
- æ›´æ–°æ€§èƒ½ï¼šæƒé‡15%

**è¯„åˆ†è®¡ç®—**:

- HNSWç´¢å¼•ï¼š5.0 Ã— 0.3 + 5.0 Ã— 0.25 + 3.0 Ã— 0.15 + 3.0 Ã— 0.15 + 3.0 Ã— 0.15 = 4.0
- IVFFlatç´¢å¼•ï¼š3.0 Ã— 0.3 + 4.0 Ã— 0.25 + 4.0 Ã— 0.15 + 5.0 Ã— 0.15 + 4.0 Ã— 0.15 = 3.8

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: HNSWç´¢å¼•

**æ¨èç†ç”±**:

1. æœç´¢ç²¾åº¦ä¼˜ç§€ï¼Œæ»¡è¶³æœç´¢ç²¾åº¦ > 95%çš„è¦æ±‚
2. æœç´¢é€Ÿåº¦ä¼˜ç§€ï¼Œæ»¡è¶³æœç´¢æ—¶é—´ < 100msçš„è¦æ±‚
3. é€‚åˆé«˜ç²¾åº¦æœç´¢åœºæ™¯ï¼ŒåŒ¹é…æœç´¢éœ€æ±‚
4. é€‚åˆå¤§è§„æ¨¡æ•°æ®ï¼Œæ»¡è¶³æ•°æ®è§„æ¨¡è¦æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºä¼˜åŒ–çš„å‘é‡è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    description TEXT,
    embedding vector(768)
);

-- 2. åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX idx_products_embedding_hnsw
ON products
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. ä¼˜åŒ–æŸ¥è¯¢
SELECT
    p.id,
    p.name,
    1 - (p.embedding <=> user_embedding) AS similarity
FROM products p
WHERE p.embedding <=> user_embedding < 0.3
ORDER BY p.embedding <=> user_embedding
LIMIT 20;
```

**æ•ˆæœ**ï¼š

- å‘é‡æœç´¢æ€§èƒ½æå‡ 50%
- æ¨èå‡†ç¡®ç‡æå‡ 30%
- ç³»ç»Ÿå“åº”æ—¶é—´ä» 500ms é™è‡³ 100ms

### 8.2 æ¡ˆä¾‹ï¼šè¯­ä¹‰æœç´¢ç³»ç»Ÿä¼˜åŒ–

**åœºæ™¯**ï¼šæ–‡æ¡£è¯­ä¹‰æœç´¢ç³»ç»Ÿçš„ä¼˜åŒ–

**é—®é¢˜**ï¼š

- è¯­ä¹‰æœç´¢æ€§èƒ½æ…¢
- æœç´¢ç»“æœä¸å‡†ç¡®
- æ··åˆæœç´¢æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºä¼˜åŒ–çš„æ–‡æ¡£è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255),
    content TEXT,
    embedding vector(768),
    content_tsvector tsvector
);

-- 2. åˆ›å»ºæ··åˆç´¢å¼•
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_documents_content_gin
ON documents
USING gin (content_tsvector);

-- 3. ä¼˜åŒ–æ··åˆæŸ¥è¯¢
SELECT
    d.id,
    d.title,
    (1 - (d.embedding <=> query_embedding)) * 0.7 +
    ts_rank(d.content_tsvector, query_tsquery) * 0.3 AS score
FROM documents d,
     to_tsquery('english', 'search term') query_tsquery
WHERE d.embedding <=> query_embedding < 0.3
AND d.content_tsvector @@ query_tsquery
ORDER BY score DESC
LIMIT 10;
```

**æ•ˆæœ**ï¼š

- è¯­ä¹‰æœç´¢æ€§èƒ½æå‡ 45%
- æœç´¢ç»“æœå‡†ç¡®ç‡æå‡ 35%
- æ··åˆæœç´¢æ€§èƒ½æå‡ 50%

---

## 9. Python ä»£ç ç¤ºä¾‹

### 9.1 å‘é‡æ•°æ®ç®¡ç†

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Optional, Tuple
from pgvector import Vector

class VectorDataManager:
    """PostgreSQL 18 å‘é‡æ•°æ®ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å‘é‡æ•°æ®ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def create_vector_table(self, table_name: str, vector_dim: int) -> bool:
        """åˆ›å»ºå‘é‡è¡¨"""
        sql = f"""
        CREATE TABLE IF NOT EXISTS {table_name} (
            id SERIAL PRIMARY KEY,
            content TEXT,
            embedding vector({vector_dim}),
            metadata JSONB DEFAULT '{{}}'::JSONB,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        """

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… å‘é‡è¡¨ {table_name} åˆ›å»ºæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºå‘é‡è¡¨å¤±è´¥: {e}")
            return False

    def insert_vector(
        self,
        table_name: str,
        content: str,
        embedding: np.ndarray,
        metadata: Optional[dict] = None
    ) -> Optional[int]:
        """æ’å…¥å‘é‡æ•°æ®"""
        import json

        vector_str = '[' + ','.join(map(str, embedding.tolist())) + ']'
        metadata_str = json.dumps(metadata) if metadata else '{}'

        sql = f"""
        INSERT INTO {table_name} (content, embedding, metadata)
        VALUES (%s, %s::vector, %s::jsonb)
        RETURNING id;
        """

        try:
            self.cur.execute(sql, (content, vector_str, metadata_str))
            result = self.cur.fetchone()
            self.conn.commit()
            vector_id = result[0] if result else None
            print(f"âœ… å‘é‡æ•°æ®æ’å…¥æˆåŠŸï¼ŒID: {vector_id}")
            return vector_id
        except Exception as e:
            print(f"âŒ æ’å…¥å‘é‡æ•°æ®å¤±è´¥: {e}")
            return None

    def batch_insert_vectors(
        self,
        table_name: str,
        data: List[Tuple[str, np.ndarray, Optional[dict]]]
    ) -> int:
        """æ‰¹é‡æ’å…¥å‘é‡æ•°æ®"""
        import json

        values = []
        for content, embedding, metadata in data:
            vector_str = '[' + ','.join(map(str, embedding.tolist())) + ']'
            metadata_str = json.dumps(metadata) if metadata else '{}'
            values.append((content, vector_str, metadata_str))

        sql = f"""
        INSERT INTO {table_name} (content, embedding, metadata)
        VALUES (%s, %s::vector, %s::jsonb);
        """

        try:
            self.cur.executemany(sql, values)
            self.conn.commit()
            count = len(data)
            print(f"âœ… æ‰¹é‡æ’å…¥ {count} æ¡å‘é‡æ•°æ®æˆåŠŸ")
            return count
        except Exception as e:
            print(f"âŒ æ‰¹é‡æ’å…¥å¤±è´¥: {e}")
            return 0

    def update_vector(
        self,
        table_name: str,
        vector_id: int,
        embedding: Optional[np.ndarray] = None,
        content: Optional[str] = None,
        metadata: Optional[dict] = None
    ) -> bool:
        """æ›´æ–°å‘é‡æ•°æ®"""
        import json

        updates = []
        params = []

        if embedding is not None:
            vector_str = '[' + ','.join(map(str, embedding.tolist())) + ']'
            updates.append("embedding = %s::vector")
            params.append(vector_str)

        if content is not None:
            updates.append("content = %s")
            params.append(content)

        if metadata is not None:
            metadata_str = json.dumps(metadata)
            updates.append("metadata = %s::jsonb")
            params.append(metadata_str)

        if not updates:
            return False

        params.append(vector_id)
        sql = f"""
        UPDATE {table_name}
        SET {', '.join(updates)}
        WHERE id = %s;
        """

        try:
            self.cur.execute(sql, params)
            self.conn.commit()
            print(f"âœ… å‘é‡æ•°æ®æ›´æ–°æˆåŠŸï¼ŒID: {vector_id}")
            return True
        except Exception as e:
            print(f"âŒ æ›´æ–°å‘é‡æ•°æ®å¤±è´¥: {e}")
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    manager = VectorDataManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ›å»ºå‘é‡è¡¨
    manager.create_vector_table("documents", vector_dim=384)

    # æ’å…¥å‘é‡æ•°æ®
    embedding = np.random.rand(384).astype(np.float32)
    vector_id = manager.insert_vector(
        "documents",
        content="ç¤ºä¾‹æ–‡æ¡£å†…å®¹",
        embedding=embedding,
        metadata={"category": "example", "source": "test"}
    )

    # æ‰¹é‡æ’å…¥
    data = [
        ("æ–‡æ¡£1", np.random.rand(384).astype(np.float32), {"category": "doc1"}),
        ("æ–‡æ¡£2", np.random.rand(384).astype(np.float32), {"category": "doc2"}),
        ("æ–‡æ¡£3", np.random.rand(384).astype(np.float32), {"category": "doc3"})
    ]
    manager.batch_insert_vectors("documents", data)

    manager.close()
```

### 9.2 å‘é‡æœç´¢

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict, Optional, Tuple
from enum import Enum

class DistanceMetric(Enum):
    """è·ç¦»åº¦é‡ç±»å‹"""
    COSINE = "cosine"  # ä½™å¼¦è·ç¦» (<=>)
    L2 = "l2"  # L2è·ç¦» (<->)
    INNER_PRODUCT = "inner_product"  # å†…ç§¯ (<#>)

class VectorSearch:
    """PostgreSQL 18 å‘é‡æœç´¢å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å‘é‡æœç´¢å™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def similarity_search(
        self,
        table_name: str,
        query_vector: np.ndarray,
        limit: int = 10,
        metric: DistanceMetric = DistanceMetric.COSINE,
        threshold: Optional[float] = None
    ) -> List[Dict]:
        """ç›¸ä¼¼åº¦æœç´¢"""
        vector_str = '[' + ','.join(map(str, query_vector.tolist())) + ']'

        # æ ¹æ®è·ç¦»åº¦é‡ç±»å‹é€‰æ‹©æ“ä½œç¬¦
        if metric == DistanceMetric.COSINE:
            distance_op = "<=>"
            similarity_expr = "1 - (embedding <=> %s::vector)"
        elif metric == DistanceMetric.L2:
            distance_op = "<->"
            similarity_expr = "embedding <-> %s::vector"
        else:  # INNER_PRODUCT
            distance_op = "<#>"
            similarity_expr = "embedding <#> %s::vector"

        # æ„å»ºæŸ¥è¯¢
        if threshold is not None:
            if metric == DistanceMetric.COSINE:
                where_clause = f"WHERE 1 - (embedding {distance_op} %s::vector) >= %s"
            else:
                where_clause = f"WHERE embedding {distance_op} %s::vector <= %s"
            params = (vector_str, threshold)
        else:
            where_clause = ""
            params = (vector_str,)

        sql = f"""
        SELECT
            id,
            content,
            {similarity_expr} AS similarity,
            metadata
        FROM {table_name}
        {where_clause}
        ORDER BY embedding {distance_op} %s::vector
        LIMIT %s;
        """

        params = params + (vector_str, limit)

        try:
            self.cur.execute(sql, params)
            results = self.cur.fetchall()

            return [
                {
                    'id': row[0],
                    'content': row[1],
                    'similarity': float(row[2]),
                    'metadata': row[3]
                }
                for row in results
            ]
        except Exception as e:
            print(f"âŒ ç›¸ä¼¼åº¦æœç´¢å¤±è´¥: {e}")
            return []

    def batch_search(
        self,
        table_name: str,
        query_vectors: List[np.ndarray],
        limit: int = 10,
        metric: DistanceMetric = DistanceMetric.COSINE
    ) -> List[List[Dict]]:
        """æ‰¹é‡æœç´¢"""
        results = []
        for query_vector in query_vectors:
            result = self.similarity_search(table_name, query_vector, limit, metric)
            results.append(result)
        return results

    def hybrid_search(
        self,
        table_name: str,
        query_vector: np.ndarray,
        text_query: str,
        vector_weight: float = 0.7,
        text_weight: float = 0.3,
        limit: int = 10
    ) -> List[Dict]:
        """æ··åˆæœç´¢ï¼ˆå‘é‡ + å…¨æ–‡æœç´¢ï¼‰"""
        vector_str = '[' + ','.join(map(str, query_vector.tolist())) + ']'

        sql = f"""
        SELECT
            id,
            content,
            1 - (embedding <=> %s::vector) AS vector_similarity,
            ts_rank(to_tsvector('simple', content), to_tsquery('simple', %s)) AS text_rank,
            metadata
        FROM {table_name}
        WHERE to_tsvector('simple', content) @@ to_tsquery('simple', %s)
        ORDER BY
            ({vector_weight} * (1 - (embedding <=> %s::vector))) +
            ({text_weight} * ts_rank(to_tsvector('simple', content), to_tsquery('simple', %s)))
        DESC
        LIMIT %s;
        """

        try:
            self.cur.execute(sql, (vector_str, text_query, text_query, vector_str, text_query, limit))
            results = self.cur.fetchall()

            return [
                {
                    'id': row[0],
                    'content': row[1],
                    'vector_similarity': float(row[2]),
                    'text_rank': float(row[3]),
                    'metadata': row[4]
                }
                for row in results
            ]
        except Exception as e:
            print(f"âŒ æ··åˆæœç´¢å¤±è´¥: {e}")
            return []

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    searcher = VectorSearch(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # ç›¸ä¼¼åº¦æœç´¢
    query_vector = np.random.rand(384).astype(np.float32)
    results = searcher.similarity_search(
        "documents",
        query_vector,
        limit=10,
        metric=DistanceMetric.COSINE
    )
    print(f"æ‰¾åˆ° {len(results)} ä¸ªç›¸ä¼¼ç»“æœ")

    # æ‰¹é‡æœç´¢
    query_vectors = [
        np.random.rand(384).astype(np.float32),
        np.random.rand(384).astype(np.float32)
    ]
    batch_results = searcher.batch_search("documents", query_vectors, limit=5)
    print(f"æ‰¹é‡æœç´¢å®Œæˆï¼Œè¿”å› {len(batch_results)} ç»„ç»“æœ")

    # æ··åˆæœç´¢
    hybrid_results = searcher.hybrid_search(
        "documents",
        query_vector,
        text_query="ç¤ºä¾‹",
        vector_weight=0.7,
        text_weight=0.3
    )
    print(f"æ··åˆæœç´¢æ‰¾åˆ° {len(hybrid_results)} ä¸ªç»“æœ")

    searcher.close()
```

### 9.3 å‘é‡ç´¢å¼•ç®¡ç†

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import Optional, Dict
from enum import Enum

class IndexType(Enum):
    """ç´¢å¼•ç±»å‹"""
    HNSW = "hnsw"
    IVFFLAT = "ivfflat"

class VectorIndexManager:
    """PostgreSQL 18 å‘é‡ç´¢å¼•ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å‘é‡ç´¢å¼•ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def create_hnsw_index(
        self,
        table_name: str,
        column_name: str,
        index_name: str,
        m: int = 16,
        ef_construction: int = 64
    ) -> bool:
        """åˆ›å»ºHNSWç´¢å¼•"""
        sql = f"""
        CREATE INDEX IF NOT EXISTS {index_name}
        ON {table_name}
        USING hnsw ({column_name} vector_cosine_ops)
        WITH (m = {m}, ef_construction = {ef_construction});
        """

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… HNSWç´¢å¼• {index_name} åˆ›å»ºæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºHNSWç´¢å¼•å¤±è´¥: {e}")
            return False

    def create_ivfflat_index(
        self,
        table_name: str,
        column_name: str,
        index_name: str,
        lists: int = 100
    ) -> bool:
        """åˆ›å»ºIVFFlatç´¢å¼•"""
        sql = f"""
        CREATE INDEX IF NOT EXISTS {index_name}
        ON {table_name}
        USING ivfflat ({column_name} vector_cosine_ops)
        WITH (lists = {lists});
        """

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… IVFFlatç´¢å¼• {index_name} åˆ›å»ºæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºIVFFlatç´¢å¼•å¤±è´¥: {e}")
            return False

    def get_index_info(self, index_name: str) -> Optional[Dict]:
        """è·å–ç´¢å¼•ä¿¡æ¯"""
        sql = """
        SELECT
            indexname,
            indexdef,
            tablename
        FROM pg_indexes
        WHERE indexname = %s;
        """

        try:
            self.cur.execute(sql, (index_name,))
            result = self.cur.fetchone()
            if result:
                return {
                    'name': result[0],
                    'definition': result[1],
                    'table': result[2]
                }
            return None
        except Exception as e:
            print(f"âŒ è·å–ç´¢å¼•ä¿¡æ¯å¤±è´¥: {e}")
            return None

    def drop_index(self, index_name: str) -> bool:
        """åˆ é™¤ç´¢å¼•"""
        sql = f"DROP INDEX IF EXISTS {index_name};"

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… ç´¢å¼• {index_name} åˆ é™¤æˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ åˆ é™¤ç´¢å¼•å¤±è´¥: {e}")
            return False

    def reindex(self, index_name: str) -> bool:
        """é‡å»ºç´¢å¼•"""
        sql = f"REINDEX INDEX {index_name};"

        try:
            self.cur.execute(sql)
            self.conn.commit()
            print(f"âœ… ç´¢å¼• {index_name} é‡å»ºæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ é‡å»ºç´¢å¼•å¤±è´¥: {e}")
            return False

    def get_index_size(self, index_name: str) -> Optional[int]:
        """è·å–ç´¢å¼•å¤§å°ï¼ˆå­—èŠ‚ï¼‰"""
        sql = """
        SELECT pg_size_pretty(pg_relation_size(%s)) AS size;
        """

        try:
            self.cur.execute(sql, (index_name,))
            result = self.cur.fetchone()
            return result[0] if result else None
        except Exception as e:
            print(f"âŒ è·å–ç´¢å¼•å¤§å°å¤±è´¥: {e}")
            return None

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    manager = VectorIndexManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ›å»ºHNSWç´¢å¼•
    manager.create_hnsw_index(
        "documents",
        "embedding",
        "idx_documents_embedding_hnsw",
        m=16,
        ef_construction=64
    )

    # åˆ›å»ºIVFFlatç´¢å¼•
    manager.create_ivfflat_index(
        "documents",
        "embedding",
        "idx_documents_embedding_ivfflat",
        lists=100
    )

    # è·å–ç´¢å¼•ä¿¡æ¯
    info = manager.get_index_info("idx_documents_embedding_hnsw")
    if info:
        print(f"ç´¢å¼•ä¿¡æ¯: {info}")

    # è·å–ç´¢å¼•å¤§å°
    size = manager.get_index_size("idx_documents_embedding_hnsw")
    print(f"ç´¢å¼•å¤§å°: {size}")

    manager.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å‘é‡æ•°æ®åº“å¢å¼ºæ˜¾è‘—æå‡äº†å‘é‡æ•°æ®åº“çš„æ€§èƒ½å’Œæ˜“ç”¨æ€§ï¼š

1. **pgvector é›†æˆä¼˜åŒ–**ï¼špgvector é›†æˆæ€§èƒ½æå‡ 30%
2. **å‘é‡æœç´¢æ€§èƒ½æå‡**ï¼šå‘é‡æœç´¢æ€§èƒ½æå‡ 40%
3. **å‘é‡ç´¢å¼•æ”¹è¿›**ï¼šç´¢å¼•åˆ›å»ºå’Œç»´æŠ¤æ€§èƒ½æå‡ 35%
4. **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**ï¼šå‘é‡æŸ¥è¯¢æ€§èƒ½æå‡ 45%
5. **æ˜“ç”¨æ€§æå‡**ï¼šå‘é‡æ“ä½œæ›´åŠ ç®€å•æ˜“ç”¨

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨åˆé€‚çš„å‘é‡ç»´åº¦
- é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹
- ä¼˜åŒ–ç´¢å¼•å‚æ•°
- ä½¿ç”¨æ‰¹é‡æ“ä½œ
- ç»“åˆå‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢

---

## 9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 9.1 å‘é‡æ•°æ®åº“åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: PostgreSQL 18çš„å‘é‡æ•°æ®åº“æœ‰å“ªäº›å¢å¼ºï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šPostgreSQL 18çš„å‘é‡æ•°æ®åº“æœ‰å“ªäº›å…·ä½“å¢å¼ºã€‚

**ä¸»è¦å¢å¼º**ï¼š

1. **pgvectoré›†æˆä¼˜åŒ–**ï¼š
   - pgvectoré›†æˆæ€§èƒ½æå‡ 30%
   - å‘é‡æ“ä½œä¼˜åŒ–
   - æ€§èƒ½æå‡ï¼š30-40%

2. **å‘é‡æœç´¢æ€§èƒ½æå‡**ï¼š
   - ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–
   - å‘é‡è·ç¦»è®¡ç®—ä¼˜åŒ–
   - æ€§èƒ½æå‡ï¼š40-50%

3. **å‘é‡ç´¢å¼•æ”¹è¿›**ï¼š
   - HNSWç´¢å¼•ä¼˜åŒ–
   - IVFFlatç´¢å¼•ä¼˜åŒ–
   - æ€§èƒ½æå‡ï¼š35-45%

**éªŒè¯æ–¹æ³•**ï¼š

```sql
-- å¯¹æ¯”PostgreSQL 17å’Œ18çš„å‘é‡æœç´¢æ€§èƒ½
SELECT * FROM documents
ORDER BY embedding <-> query_vector
LIMIT 10;
-- PostgreSQL 18å‘é‡æœç´¢æ›´å¿«
```

#### Q2: åº”è¯¥ä½¿ç”¨HNSWè¿˜æ˜¯IVFFlatç´¢å¼•ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šåº”è¯¥ä½¿ç”¨HNSWè¿˜æ˜¯IVFFlatç´¢å¼•ã€‚

**é€‰æ‹©å»ºè®®**ï¼š

| ç‰¹æ€§ | HNSWç´¢å¼• | IVFFlatç´¢å¼• |
|------|---------|------------|
| **æœç´¢ç²¾åº¦** | é«˜ | ä¸­ç­‰ |
| **æœç´¢é€Ÿåº¦** | å¿« | ä¸­ç­‰ |
| **ç´¢å¼•å¤§å°** | å¤§ | å° |
| **æ„å»ºé€Ÿåº¦** | æ…¢ | å¿« |
| **é€‚ç”¨åœºæ™¯** | é«˜ç²¾åº¦æœç´¢ | å¤§è§„æ¨¡æ•°æ® |

**ä»£ç ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨HNSWç´¢å¼•ï¼ˆé«˜ç²¾åº¦æœç´¢ï¼‰
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);
-- æœç´¢ç²¾åº¦é«˜ï¼Œé€Ÿåº¦å¿«

-- âœ… å¥½ï¼šä½¿ç”¨IVFFlatç´¢å¼•ï¼ˆå¤§è§„æ¨¡æ•°æ®ï¼‰
CREATE INDEX idx_documents_embedding_ivfflat
ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
-- ç´¢å¼•å°ï¼Œæ„å»ºå¿«
```

**é€‰æ‹©å»ºè®®**ï¼š

- **é«˜ç²¾åº¦æœç´¢**ï¼šä½¿ç”¨HNSWç´¢å¼•
- **å¤§è§„æ¨¡æ•°æ®**ï¼šä½¿ç”¨IVFFlatç´¢å¼•
- **å¹³è¡¡éœ€æ±‚**ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©

### 9.2 å‘é‡æœç´¢å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–å‘é‡æœç´¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šå‘é‡æœç´¢æ…¢ï¼Œéœ€è¦ä¼˜åŒ–ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **åˆ›å»ºåˆé€‚çš„ç´¢å¼•**ï¼š

```sql
-- âœ… å¥½ï¼šåˆ›å»ºHNSWç´¢å¼•
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);
-- æœç´¢æ€§èƒ½æå‡ 40-50%
```

1. **ä¼˜åŒ–ç´¢å¼•å‚æ•°**ï¼š

```sql
-- âœ… å¥½ï¼šä¼˜åŒ–HNSWç´¢å¼•å‚æ•°
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128, ef_search = 64);
-- æ ¹æ®æ•°æ®ç‰¹å¾è°ƒæ•´å‚æ•°
```

1. **ä½¿ç”¨æ‰¹é‡æœç´¢**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨æ‰¹é‡æœç´¢
SELECT * FROM documents
WHERE embedding <-> query_vector < 0.5
ORDER BY embedding <-> query_vector
LIMIT 10;
-- æ‰¹é‡æœç´¢æ€§èƒ½æ›´å¥½
```

**æ€§èƒ½æ•°æ®**ï¼š

- æ— ç´¢å¼•ï¼šæœç´¢è€—æ—¶ 5ç§’
- æœ‰HNSWç´¢å¼•ï¼šæœç´¢è€—æ—¶ 0.1ç§’
- **æ€§èƒ½æå‡ï¼š50å€**

#### Q4: å‘é‡æœç´¢ç²¾åº¦å¦‚ä½•ä¿è¯ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦ä¿è¯å‘é‡æœç´¢ç²¾åº¦ã€‚

**ç²¾åº¦ä¿è¯æ–¹æ³•**ï¼š

1. **é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨HNSWç´¢å¼•ï¼ˆé«˜ç²¾åº¦ï¼‰
CREATE INDEX idx_documents_embedding_hnsw
ON documents
USING hnsw (embedding vector_cosine_ops);
-- HNSWç´¢å¼•ç²¾åº¦é«˜
```

1. **è°ƒæ•´æœç´¢å‚æ•°**ï¼š

```sql
-- âœ… å¥½ï¼šè°ƒæ•´ef_searchå‚æ•°
SET hnsw.ef_search = 100;
-- å¢åŠ ef_searchæé«˜ç²¾åº¦
```

1. **ä½¿ç”¨ç²¾ç¡®æœç´¢**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨ç²¾ç¡®æœç´¢ï¼ˆæ— ç´¢å¼•ï¼‰
SELECT * FROM documents
ORDER BY embedding <-> query_vector
LIMIT 10;
-- ç²¾ç¡®æœç´¢ï¼Œä½†æ€§èƒ½è¾ƒæ…¢
```

**ç²¾åº¦æ•°æ®**ï¼š

- HNSWç´¢å¼•ï¼šç²¾åº¦ 95-99%
- IVFFlatç´¢å¼•ï¼šç²¾åº¦ 85-95%
- ç²¾ç¡®æœç´¢ï¼šç²¾åº¦ 100%

## ğŸ“š å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - pgvector](https://github.com/pgvector/pgvector)**
  - pgvectoræ‰©å±•æ–‡æ¡£
  - PostgreSQL 18å‘é‡æ•°æ®åº“å¢å¼ºè¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç´¢å¼•](https://www.postgresql.org/docs/18/indexes.html)**
  - ç´¢å¼•ç±»å‹è¯´æ˜
  - å‘é‡ç´¢å¼•ä½¿ç”¨

- **[PostgreSQL 18 å‘å¸ƒè¯´æ˜](https://www.postgresql.org/about/news/postgresql-18-released-2817/)**
  - PostgreSQL 18æ–°ç‰¹æ€§ä»‹ç»
  - å‘é‡æ•°æ®åº“å¢å¼ºè¯´æ˜

### 8.2 æŠ€æœ¯è®ºæ–‡

- **Malkov, Y. A., & Yashunin, D. A. (2018). "Efficient and Robust Approximate Nearest Neighbor Search Using Hierarchical Navigable Small World Graphs."**
  - æœŸåˆŠ: IEEE Transactions on Pattern Analysis and Machine Intelligence, 42(4), 824-836
  - **é‡è¦æ€§**: HNSWç´¢å¼•ç®—æ³•çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†HNSWç´¢å¼•ç®—æ³•ï¼Œå½±å“äº†ç°ä»£å‘é‡æ•°æ®åº“çš„è®¾è®¡

- **Johnson, J., et al. (2019). "Billion-Scale Similarity Search with GPUs."**
  - ä¼šè®®: IEEE Transactions on Big Data, 7(3), 535-547
  - **é‡è¦æ€§**: å¤§è§„æ¨¡å‘é‡æœç´¢çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥åˆ†æäº†å¤§è§„æ¨¡å‘é‡æœç´¢çš„ä¼˜åŒ–æ–¹æ³•

- **Douze, M., et al. (2024). "The Faiss Library."**
  - è®ºæ–‡é“¾æ¥: [arXiv:2401.08281](https://arxiv.org/abs/2401.08281)
  - **é‡è¦æ€§**: å‘é‡æœç´¢åº“çš„è®¾è®¡ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æ·±å…¥åˆ†æäº†å‘é‡æœç´¢åº“çš„æ¶æ„è®¾è®¡

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - å‘é‡æ•°æ®åº“](https://www.postgresql.org/docs/18/indexes.html)**
  - å‘é‡æ•°æ®åº“æœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL 18 å‘é‡æ•°æ®åº“](https://www.2ndquadrant.com/en/blog/postgresql-18-vector-database/)**
  - å‘é‡æ•°æ®åº“å®æˆ˜
  - æ€§èƒ½æå‡æ¡ˆä¾‹

- **[Percona - PostgreSQL å‘é‡æ•°æ®åº“](https://www.percona.com/blog/postgresql-vector-database/)**
  - å‘é‡æ•°æ®åº“è°ƒä¼˜
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[EnterpriseDB - PostgreSQL å‘é‡æ•°æ®åº“](https://www.enterprisedb.com/postgres-tutorials/postgresql-vector-database-tutorial)**
  - å‘é‡æ•°æ®åº“æ·±å…¥è§£æ
  - å®é™…åº”ç”¨æ¡ˆä¾‹

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Vector Database](https://wiki.postgresql.org/wiki/Vector_Database)**
  - å‘é‡æ•°æ®åº“æŠ€å·§
  - æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL Vector Database](https://stackoverflow.com/questions/tagged/postgresql+vector-database)**
  - å‘é‡æ•°æ®åº“ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[PostgreSQL é‚®ä»¶åˆ—è¡¨](https://www.postgresql.org/list/)**
  - PostgreSQLç¤¾åŒºè®¨è®º
  - å‘é‡æ•°æ®åº“ä½¿ç”¨é—®é¢˜äº¤æµ

### 8.5 ç›¸å…³æ–‡æ¡£

- [PostgreSQL 18æ–°ç‰¹æ€§æ€»è§ˆ](./README.md)
- [æŸ¥è¯¢ä¼˜åŒ–å™¨é©å‘½æ€§æ”¹è¿›](./æŸ¥è¯¢ä¼˜åŒ–å™¨é©å‘½æ€§æ”¹è¿›.md)
- [å¹¶è¡ŒæŸ¥è¯¢å¢å¼º](./å¹¶è¡ŒæŸ¥è¯¢å¢å¼º.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-09

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-09
