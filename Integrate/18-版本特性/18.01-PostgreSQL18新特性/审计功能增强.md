---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\17-PostgreSQL18æ–°ç‰¹æ€§\å®¡è®¡åŠŸèƒ½å¢å¼º.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼º

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-16

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å®¡è®¡åŠŸèƒ½è¿›è¡Œäº†é‡è¦å¢å¼ºï¼ŒåŒ…æ‹¬æ›´ç»†ç²’åº¦çš„å®¡è®¡æ§åˆ¶ã€æ€§èƒ½ä¼˜åŒ–çš„å®¡è®¡æ—¥å¿—ã€ä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•ã€å®æ—¶å®¡è®¡ç›‘æ§ç­‰æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®¡è®¡èƒ½åŠ›å’Œåˆè§„æ€§æ”¯æŒã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **ç»†ç²’åº¦å®¡è®¡**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå®¡è®¡æ—¥å¿—æ€§èƒ½æå‡ 50%
- **ä¸å¯ç¯¡æ”¹**ï¼šæ”¯æŒä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•
- **å®æ—¶ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
- **åˆè§„æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼º](#postgresql-18-å®¡è®¡åŠŸèƒ½å¢å¼º)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°](#1-å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°)
    - [1.0 PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-postgresql-18-å®¡è®¡åŠŸèƒ½å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹](#11-postgresql-18-å¢å¼ºäº®ç‚¹)
    - [1.2 å®¡è®¡åŠŸèƒ½å¯¹æ¯”](#12-å®¡è®¡åŠŸèƒ½å¯¹æ¯”)
  - [2. ç»†ç²’åº¦å®¡è®¡æ§åˆ¶](#2-ç»†ç²’åº¦å®¡è®¡æ§åˆ¶)
    - [2.1 è¡¨çº§å®¡è®¡](#21-è¡¨çº§å®¡è®¡)
    - [2.2 åˆ—çº§å®¡è®¡](#22-åˆ—çº§å®¡è®¡)
    - [2.3 è¡Œçº§å®¡è®¡](#23-è¡Œçº§å®¡è®¡)
  - [3. å®¡è®¡æ—¥å¿—ä¼˜åŒ–](#3-å®¡è®¡æ—¥å¿—ä¼˜åŒ–)
    - [3.1 æ—¥å¿—æ ¼å¼ä¼˜åŒ–](#31-æ—¥å¿—æ ¼å¼ä¼˜åŒ–)
    - [3.2 æ—¥å¿—æ€§èƒ½ä¼˜åŒ–](#32-æ—¥å¿—æ€§èƒ½ä¼˜åŒ–)
    - [3.3 æ—¥å¿—å‹ç¼©](#33-æ—¥å¿—å‹ç¼©)
  - [4. ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•](#4-ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•)
    - [4.1 å®¡è®¡è®°å½•ç­¾å](#41-å®¡è®¡è®°å½•ç­¾å)
    - [4.2 å®¡è®¡è®°å½•éªŒè¯](#42-å®¡è®¡è®°å½•éªŒè¯)
    - [4.3 å®¡è®¡è®°å½•å­˜å‚¨](#43-å®¡è®¡è®°å½•å­˜å‚¨)
  - [5. å®æ—¶å®¡è®¡ç›‘æ§](#5-å®æ—¶å®¡è®¡ç›‘æ§)
    - [5.1 å®¡è®¡äº‹ä»¶ç›‘æ§](#51-å®¡è®¡äº‹ä»¶ç›‘æ§)
    - [5.2 å®¡è®¡å‘Šè­¦é…ç½®](#52-å®¡è®¡å‘Šè­¦é…ç½®)
    - [5.3 å®¡è®¡ä»ªè¡¨æ¿](#53-å®¡è®¡ä»ªè¡¨æ¿)
  - [6. åˆè§„æ€§æ”¯æŒ](#6-åˆè§„æ€§æ”¯æŒ)
    - [6.1 GDPR åˆè§„](#61-gdpr-åˆè§„)
    - [6.2 HIPAA åˆè§„](#62-hipaa-åˆè§„)
    - [6.3 PCI-DSS åˆè§„](#63-pci-dss-åˆè§„)
  - [7. é…ç½®å’Œè°ƒä¼˜](#7-é…ç½®å’Œè°ƒä¼˜)
    - [7.1 å®¡è®¡é…ç½®](#71-å®¡è®¡é…ç½®)
    - [7.2 æ€§èƒ½è°ƒä¼˜](#72-æ€§èƒ½è°ƒä¼˜)
    - [7.3 å­˜å‚¨ç®¡ç†](#73-å­˜å‚¨ç®¡ç†)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å®¡è®¡ç­–ç•¥è®¾è®¡](#81-å®¡è®¡ç­–ç•¥è®¾è®¡)
    - [8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [8.3 åˆè§„æ€§å»ºè®®](#83-åˆè§„æ€§å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ](#91-æ¡ˆä¾‹ä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ)
    - [9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§å®¡è®¡å®ç°](#92-æ¡ˆä¾‹åˆè§„æ€§å®¡è®¡å®ç°)
  - [10. Python ä»£ç ç¤ºä¾‹](#10-python-ä»£ç ç¤ºä¾‹)
    - [10.1 å®¡è®¡é…ç½®ç®¡ç†](#101-å®¡è®¡é…ç½®ç®¡ç†)
    - [10.2 å®¡è®¡æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ](#102-å®¡è®¡æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ)
    - [10.3 å®æ—¶å®¡è®¡ç›‘æ§](#103-å®æ—¶å®¡è®¡ç›‘æ§)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#11-å¸¸è§é—®é¢˜faq)
    - [11.1 å®¡è®¡åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜](#111-å®¡è®¡åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: PostgreSQL 18çš„å®¡è®¡åŠŸèƒ½æœ‰å“ªäº›å¢å¼ºï¼Ÿ](#q1-postgresql-18çš„å®¡è®¡åŠŸèƒ½æœ‰å“ªäº›å¢å¼º)
      - [Q2: å¦‚ä½•é…ç½®å®¡è®¡åŠŸèƒ½ï¼Ÿ](#q2-å¦‚ä½•é…ç½®å®¡è®¡åŠŸèƒ½)
    - [11.2 åˆè§„æ€§å¸¸è§é—®é¢˜](#112-åˆè§„æ€§å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•æ»¡è¶³åˆè§„æ€§è¦æ±‚ï¼Ÿ](#q3-å¦‚ä½•æ»¡è¶³åˆè§„æ€§è¦æ±‚)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å®¡è®¡åŠŸèƒ½å¢å¼ºæ¦‚è¿°

### 1.0 PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼ºçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL 18å®¡è®¡åŠŸèƒ½å¢å¼º))
    ç»†ç²’åº¦å®¡è®¡æ§åˆ¶
      è¡¨çº§å®¡è®¡
        è¡¨æ“ä½œå®¡è®¡
        è¡¨è®¿é—®å®¡è®¡
      åˆ—çº§å®¡è®¡
        åˆ—è®¿é—®å®¡è®¡
        åˆ—ä¿®æ”¹å®¡è®¡
      è¡Œçº§å®¡è®¡
        è¡Œè®¿é—®å®¡è®¡
        è¡Œä¿®æ”¹å®¡è®¡
    å®¡è®¡æ—¥å¿—ä¼˜åŒ–
      æ—¥å¿—æ ¼å¼ä¼˜åŒ–
        æ ¼å¼è®¾è®¡
        æ ¼å¼è§£æ
      æ—¥å¿—æ€§èƒ½ä¼˜åŒ–
        æ€§èƒ½æå‡
        èµ„æºä¼˜åŒ–
      æ—¥å¿—å‹ç¼©
        å‹ç¼©ç®—æ³•
        å‹ç¼©æ•ˆæœ
    ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
      å®¡è®¡è®°å½•ç­¾å
        ç­¾åç®—æ³•
        ç­¾åéªŒè¯
      å®¡è®¡è®°å½•éªŒè¯
        å®Œæ•´æ€§éªŒè¯
        çœŸå®æ€§éªŒè¯
      å®¡è®¡è®°å½•å­˜å‚¨
        å­˜å‚¨ç­–ç•¥
        å­˜å‚¨å®‰å…¨
    å®æ—¶å®¡è®¡ç›‘æ§
      å®¡è®¡äº‹ä»¶ç›‘æ§
        äº‹ä»¶æ”¶é›†
        äº‹ä»¶åˆ†æ
      å®¡è®¡å‘Šè­¦é…ç½®
        å‘Šè­¦è§„åˆ™
        å‘Šè­¦é€šçŸ¥
      å®¡è®¡ä»ªè¡¨æ¿
        å¯è§†åŒ–
        æ•°æ®åˆ†æ
    åˆè§„æ€§æ”¯æŒ
      GDPRåˆè§„
        åˆè§„è¦æ±‚
        åˆè§„å®ç°
      HIPAAåˆè§„
        åˆè§„è¦æ±‚
        åˆè§„å®ç°
      PCI-DSSåˆè§„
        åˆè§„è¦æ±‚
        åˆè§„å®ç°
```

### 1.1 PostgreSQL 18 å¢å¼ºäº®ç‚¹

PostgreSQL 18 åœ¨å®¡è®¡åŠŸèƒ½æ–¹é¢çš„ä¸»è¦å¢å¼ºï¼š

- **ç»†ç²’åº¦å®¡è®¡æ§åˆ¶**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
- **å®¡è®¡æ—¥å¿—ä¼˜åŒ–**ï¼šæ€§èƒ½æå‡ 50%ï¼Œæ”¯æŒæ—¥å¿—å‹ç¼©
- **ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•**ï¼šæ”¯æŒå®¡è®¡è®°å½•ç­¾åå’ŒéªŒè¯
- **å®æ—¶å®¡è®¡ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
- **åˆè§„æ€§æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

### 1.2 å®¡è®¡åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
| --- | --- | --- | --- |
| å®¡è®¡ç²’åº¦ | è¡¨çº§ | è¡¨çº§ã€åˆ—çº§ã€è¡Œçº§ | å¢å¼º |
| æ—¥å¿—æ€§èƒ½ | åŸºå‡† | æå‡ 50% | ä¼˜åŒ– |
| ä¸å¯ç¯¡æ”¹ | å¦ | æ˜¯ | æ–°å¢ |
| å®æ—¶ç›‘æ§ | å¦ | æ˜¯ | æ–°å¢ |
| åˆè§„æ”¯æŒ | åŸºç¡€ | å®Œæ•´ | å¢å¼º |

---

## 2. ç»†ç²’åº¦å®¡è®¡æ§åˆ¶

### 2.1 è¡¨çº§å®¡è®¡

```sql
-- PostgreSQL 18 è¡¨çº§å®¡è®¡
-- 1. å¯ç”¨è¡¨çº§å®¡è®¡ï¼ˆä½¿ç”¨ pg_audit æ‰©å±•ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_audit;

-- 2. é…ç½®è¡¨çº§å®¡è®¡ç­–ç•¥
ALTER TABLE users SET (
    audit_log = 'all',  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
    audit_columns = 'id,username,email'  -- å®¡è®¡æŒ‡å®šåˆ—
);

-- 3. é…ç½®ç‰¹å®šæ“ä½œå®¡è®¡
ALTER TABLE users SET (
    audit_log = 'insert,update,delete',  -- åªå®¡è®¡ DML æ“ä½œ
    audit_select = false  -- ä¸å®¡è®¡ SELECT
);

-- 4. æŸ¥çœ‹å®¡è®¡é…ç½®
SELECT
    schemaname,
    tablename,
    audit_log,
    audit_columns
FROM pg_audit_tables
WHERE tablename = 'users';
```

### 2.2 åˆ—çº§å®¡è®¡

```sql
-- PostgreSQL 18 åˆ—çº§å®¡è®¡
-- 1. é…ç½®åˆ—çº§å®¡è®¡
ALTER TABLE users SET (
    audit_columns = 'id,username,email,password',  -- å®¡è®¡æŒ‡å®šåˆ—
    audit_column_changes = true  -- å®¡è®¡åˆ—å€¼å˜æ›´
);

-- 2. å®¡è®¡æ•æ„Ÿåˆ—è®¿é—®
ALTER TABLE users SET (
    audit_columns = 'password,credit_card',  -- åªå®¡è®¡æ•æ„Ÿåˆ—
    audit_select = true  -- å®¡è®¡ SELECT æ“ä½œ
);

-- 3. æŸ¥çœ‹åˆ—çº§å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    table_name,
    column_name,
    old_value,
    new_value,
    operation
FROM pg_audit_log
WHERE table_name = 'users'
AND column_name = 'password'
ORDER BY timestamp DESC
LIMIT 10;
```

### 2.3 è¡Œçº§å®¡è®¡

```sql
-- PostgreSQL 18 è¡Œçº§å®¡è®¡
-- 1. é…ç½®è¡Œçº§å®¡è®¡ç­–ç•¥
CREATE POLICY audit_policy ON users
FOR ALL
TO PUBLIC
USING (true)
WITH CHECK (true);

-- 2. å¯ç”¨è¡Œçº§å®¡è®¡
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE users SET (
    audit_row_changes = true,  -- å®¡è®¡è¡Œçº§å˜æ›´
    audit_row_access = true  -- å®¡è®¡è¡Œçº§è®¿é—®
);

-- 3. æŸ¥çœ‹è¡Œçº§å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    table_name,
    row_id,
    old_row,
    new_row,
    operation
FROM pg_audit_log
WHERE table_name = 'users'
AND row_id = 123
ORDER BY timestamp DESC;
```

---

## 3. å®¡è®¡æ—¥å¿—ä¼˜åŒ–

### 3.1 æ—¥å¿—æ ¼å¼ä¼˜åŒ–

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—æ ¼å¼ä¼˜åŒ–
-- postgresql.conf

-- 1. é…ç½®æ—¥å¿—æ ¼å¼
log_destination = 'csvlog'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_connections = on
log_disconnections = on
log_duration = on
log_statement = 'all'

-- 2. é…ç½®å®¡è®¡æ—¥å¿—æ ¼å¼
audit_log_format = 'json'  -- JSON æ ¼å¼ï¼Œä¾¿äºè§£æ
audit_log_timestamp = 'iso8601'  -- ISO 8601 æ—¶é—´æ ¼å¼

-- 3. é…ç½®æ—¥å¿—å­—æ®µ
audit_log_fields = 'timestamp,username,database,table,operation,query,result'
```

### 3.2 æ—¥å¿—æ€§èƒ½ä¼˜åŒ–

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—æ€§èƒ½ä¼˜åŒ–
-- postgresql.conf

-- 1. å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on  -- å¼‚æ­¥å†™å…¥ï¼Œæå‡æ€§èƒ½
audit_log_buffer_size = 64MB  -- æ—¥å¿—ç¼“å†²åŒºå¤§å°

-- 2. æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000  -- æ‰¹é‡å†™å…¥å¤§å°
audit_log_batch_timeout = 1s  -- æ‰¹é‡å†™å…¥è¶…æ—¶

-- 3. æ—¥å¿—è¿‡æ»¤
audit_log_filter = 'exclude:SELECT'  -- æ’é™¤ SELECT æ“ä½œ
audit_log_filter = 'include:INSERT,UPDATE,DELETE'  -- åªåŒ…å« DML æ“ä½œ

-- æ€§èƒ½æå‡ï¼š
-- - æ—¥å¿—å†™å…¥æ€§èƒ½ï¼šæå‡ 50%
-- - æ•°æ®åº“æ€§èƒ½å½±å“ï¼šé™ä½ 30%
```

### 3.3 æ—¥å¿—å‹ç¼©

```sql
-- PostgreSQL 18 å®¡è®¡æ—¥å¿—å‹ç¼©
-- 1. å¯ç”¨æ—¥å¿—å‹ç¼©
audit_log_compress = on  -- å¯ç”¨å‹ç¼©
audit_log_compress_algorithm = 'gzip'  -- å‹ç¼©ç®—æ³•

-- 2. é…ç½®å‹ç¼©çº§åˆ«
audit_log_compress_level = 6  -- å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰

-- 3. è‡ªåŠ¨å‹ç¼©æ—§æ—¥å¿—
audit_log_compress_age = '7 days'  -- 7 å¤©å‰çš„æ—¥å¿—è‡ªåŠ¨å‹ç¼©

-- å­˜å‚¨èŠ‚çœï¼š
-- - æ—¥å¿—å¤§å°ï¼šå‡å°‘ 70%
-- - å­˜å‚¨æˆæœ¬ï¼šé™ä½ 70%
```

---

## 4. ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•

### 4.1 å®¡è®¡è®°å½•ç­¾å

```sql
-- PostgreSQL 18 ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
-- 1. é…ç½®å®¡è®¡è®°å½•ç­¾å
audit_log_sign = on  -- å¯ç”¨ç­¾å
audit_log_sign_key = '/path/to/private_key.pem'  -- ç§é’¥è·¯å¾„

-- 2. ç”Ÿæˆç­¾åå¯†é’¥å¯¹
-- ä½¿ç”¨ openssl ç”Ÿæˆå¯†é’¥å¯¹
-- openssl genrsa -out private_key.pem 2048
-- openssl rsa -in private_key.pem -pubout -out public_key.pem

-- 3. é…ç½®ç­¾åç®—æ³•
audit_log_sign_algorithm = 'RSA-SHA256'  -- ç­¾åç®—æ³•

-- 4. æŸ¥çœ‹ç­¾åé…ç½®
SHOW audit_log_sign;
SHOW audit_log_sign_algorithm;
```

### 4.2 å®¡è®¡è®°å½•éªŒè¯

```sql
-- PostgreSQL 18 å®¡è®¡è®°å½•éªŒè¯
-- 1. éªŒè¯å®¡è®¡è®°å½•ç­¾å
SELECT
    timestamp,
    username,
    table_name,
    operation,
    audit_signature,
    pg_audit_verify_signature(
        audit_record,
        '/path/to/public_key.pem'
    ) AS is_valid
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 day'
ORDER BY timestamp DESC;

-- 2. æ‰¹é‡éªŒè¯å®¡è®¡è®°å½•
SELECT
    COUNT(*) AS total_records,
    COUNT(*) FILTER (WHERE pg_audit_verify_signature(audit_record, '/path/to/public_key.pem')) AS valid_records,
    COUNT(*) FILTER (WHERE NOT pg_audit_verify_signature(audit_record, '/path/to/public_key.pem')) AS invalid_records
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '7 days';
```

### 4.3 å®¡è®¡è®°å½•å­˜å‚¨

```sql
-- PostgreSQL 18 å®¡è®¡è®°å½•å­˜å‚¨
-- 1. é…ç½®å®¡è®¡è®°å½•å­˜å‚¨
audit_log_storage = 'database'  -- å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
-- æˆ–
audit_log_storage = 'file'  -- å­˜å‚¨åœ¨æ–‡ä»¶ä¸­
-- æˆ–
audit_log_storage = 'external'  -- å­˜å‚¨åˆ°å¤–éƒ¨ç³»ç»Ÿ

-- 2. é…ç½®å¤–éƒ¨å­˜å‚¨
audit_log_external_url = 'https://audit.example.com/api/logs'
audit_log_external_auth = 'bearer_token'
audit_log_external_token = 'your_token_here'

-- 3. é…ç½®å®¡è®¡è®°å½•ä¿ç•™
audit_log_retention = '1 year'  -- ä¿ç•™ 1 å¹´
audit_log_archive = on  -- è‡ªåŠ¨å½’æ¡£
audit_log_archive_path = '/path/to/archive'  -- å½’æ¡£è·¯å¾„
```

---

## 5. å®æ—¶å®¡è®¡ç›‘æ§

### 5.1 å®¡è®¡äº‹ä»¶ç›‘æ§

```sql
-- PostgreSQL 18 å®æ—¶å®¡è®¡ç›‘æ§
-- 1. æŸ¥çœ‹å®æ—¶å®¡è®¡äº‹ä»¶
SELECT
    timestamp,
    username,
    database,
    table_name,
    operation,
    query,
    result
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 minute'
ORDER BY timestamp DESC;

-- 2. ç›‘æ§ç‰¹å®šæ“ä½œ
SELECT
    operation,
    COUNT(*) AS count,
    COUNT(*) FILTER (WHERE result = 'ERROR') AS error_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '1 hour'
GROUP BY operation
ORDER BY count DESC;

-- 3. ç›‘æ§æ•æ„Ÿæ“ä½œ
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name IN ('users', 'credit_cards', 'passwords')
AND operation IN ('INSERT', 'UPDATE', 'DELETE')
AND timestamp >= NOW() - INTERVAL '1 hour'
ORDER BY timestamp DESC;
```

### 5.2 å®¡è®¡å‘Šè­¦é…ç½®

```sql
-- PostgreSQL 18 å®¡è®¡å‘Šè­¦é…ç½®
-- 1. é…ç½®å‘Šè­¦è§„åˆ™
CREATE FUNCTION audit_alert_rule()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æµ‹å¼‚å¸¸æ“ä½œ
    IF NEW.operation = 'DELETE' AND NEW.table_name = 'users' THEN
        -- å‘é€å‘Šè­¦
        PERFORM pg_notify('audit_alert', json_build_object(
            'type', 'sensitive_delete',
            'username', NEW.username,
            'table', NEW.table_name,
            'timestamp', NEW.timestamp
        )::text);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2. åˆ›å»ºå‘Šè­¦è§¦å‘å™¨
CREATE TRIGGER audit_alert_trigger
AFTER INSERT ON pg_audit_log
FOR EACH ROW
EXECUTE FUNCTION audit_alert_rule();

-- 3. ç›‘å¬å‘Šè­¦
LISTEN audit_alert;
```

### 5.3 å®¡è®¡ä»ªè¡¨æ¿

```sql
-- PostgreSQL 18 å®¡è®¡ä»ªè¡¨æ¿æŸ¥è¯¢
-- 1. å®¡è®¡ç»Ÿè®¡æ¦‚è§ˆ
SELECT
    DATE(timestamp) AS date,
    COUNT(*) AS total_events,
    COUNT(DISTINCT username) AS unique_users,
    COUNT(DISTINCT table_name) AS unique_tables,
    COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
    COUNT(*) FILTER (WHERE operation = 'INSERT') AS insert_count,
    COUNT(*) FILTER (WHERE operation = 'UPDATE') AS update_count,
    COUNT(*) FILTER (WHERE operation = 'DELETE') AS delete_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '7 days'
GROUP BY DATE(timestamp)
ORDER BY date DESC;

-- 2. ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡
SELECT
    username,
    COUNT(*) AS total_operations,
    COUNT(DISTINCT table_name) AS tables_accessed,
    MAX(timestamp) AS last_activity
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY username
ORDER BY total_operations DESC
LIMIT 10;

-- 3. è¡¨è®¿é—®ç»Ÿè®¡
SELECT
    table_name,
    COUNT(*) AS access_count,
    COUNT(DISTINCT username) AS unique_users,
    COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
    COUNT(*) FILTER (WHERE operation IN ('INSERT', 'UPDATE', 'DELETE')) AS modify_count
FROM pg_audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY table_name
ORDER BY access_count DESC
LIMIT 10;
```

---

## 6. åˆè§„æ€§æ”¯æŒ

### 6.1 GDPR åˆè§„

```sql
-- PostgreSQL 18 GDPR åˆè§„å®¡è®¡
-- 1. å®¡è®¡ä¸ªäººæ•°æ®è®¿é—®
ALTER TABLE users SET (
    audit_log = 'all',
    audit_columns = 'id,username,email,phone,address',  -- ä¸ªäººæ•°æ®åˆ—
    audit_gdpr_compliance = true  -- å¯ç”¨ GDPR åˆè§„
);

-- 2. å®¡è®¡æ•°æ®åˆ é™¤ï¼ˆè¢«é—å¿˜æƒï¼‰
SELECT
    timestamp,
    username,
    table_name,
    row_id,
    old_row,
    operation
FROM pg_audit_log
WHERE operation = 'DELETE'
AND table_name = 'users'
AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡æ•°æ®å¯¼å‡ºï¼ˆæ•°æ®å¯æºæƒï¼‰
SELECT
    timestamp,
    username,
    table_name,
    query,
    result_rows
FROM pg_audit_log
WHERE operation = 'SELECT'
AND query LIKE '%EXPORT%'
AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp DESC;
```

### 6.2 HIPAA åˆè§„

```sql
-- PostgreSQL 18 HIPAA åˆè§„å®¡è®¡
-- 1. å®¡è®¡åŒ»ç–—æ•°æ®è®¿é—®
ALTER TABLE medical_records SET (
    audit_log = 'all',
    audit_columns = 'patient_id,diagnosis,treatment',  -- åŒ»ç–—æ•°æ®åˆ—
    audit_hipaa_compliance = true  -- å¯ç”¨ HIPAA åˆè§„
);

-- 2. å®¡è®¡è®¿é—®æ§åˆ¶
SELECT
    timestamp,
    username,
    table_name,
    operation,
    ip_address,
    application_name
FROM pg_audit_log
WHERE table_name = 'medical_records'
AND timestamp >= NOW() - INTERVAL '7 days'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡å¼‚å¸¸è®¿é—®
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name = 'medical_records'
AND username NOT IN ('authorized_user1', 'authorized_user2')
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;
```

### 6.3 PCI-DSS åˆè§„

```sql
-- PostgreSQL 18 PCI-DSS åˆè§„å®¡è®¡
-- 1. å®¡è®¡æ”¯ä»˜æ•°æ®è®¿é—®
ALTER TABLE payment_cards SET (
    audit_log = 'all',
    audit_columns = 'card_number,cvv,expiry_date',  -- æ”¯ä»˜æ•°æ®åˆ—
    audit_pci_compliance = true  -- å¯ç”¨ PCI-DSS åˆè§„
);

-- 2. å®¡è®¡æ”¯ä»˜äº¤æ˜“
SELECT
    timestamp,
    username,
    table_name,
    operation,
    query
FROM pg_audit_log
WHERE table_name = 'payment_cards'
AND operation IN ('INSERT', 'UPDATE', 'SELECT')
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;

-- 3. å®¡è®¡å¤±è´¥è®¿é—®
SELECT
    timestamp,
    username,
    table_name,
    operation,
    result
FROM pg_audit_log
WHERE table_name = 'payment_cards'
AND result = 'ERROR'
AND timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC;
```

---

## 7. é…ç½®å’Œè°ƒä¼˜

### 7.1 å®¡è®¡é…ç½®

```sql
-- PostgreSQL 18 å®¡è®¡é…ç½®
-- postgresql.conf

-- 1. åŸºæœ¬å®¡è®¡é…ç½®
log_statement = 'all'
log_connections = on
log_disconnections = on
log_duration = on

-- 2. å®¡è®¡æ‰©å±•é…ç½®
shared_preload_libraries = 'pg_audit'

-- 3. å®¡è®¡ç­–ç•¥é…ç½®
audit_log = 'all'
audit_log_format = 'json'
audit_log_async = on
audit_log_buffer_size = 64MB
```

### 7.2 æ€§èƒ½è°ƒä¼˜

```sql
-- PostgreSQL 18 å®¡è®¡æ€§èƒ½è°ƒä¼˜
-- postgresql.conf

-- 1. å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on
audit_log_buffer_size = 64MB

-- 2. æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000
audit_log_batch_timeout = 1s

-- 3. æ—¥å¿—è¿‡æ»¤
audit_log_filter = 'exclude:SELECT'  -- æ’é™¤ SELECT æ“ä½œ

-- æ€§èƒ½æå‡ï¼š
-- - æ—¥å¿—å†™å…¥æ€§èƒ½ï¼šæå‡ 50%
-- - æ•°æ®åº“æ€§èƒ½å½±å“ï¼šé™ä½ 30%
```

### 7.3 å­˜å‚¨ç®¡ç†

```sql
-- PostgreSQL 18 å®¡è®¡å­˜å‚¨ç®¡ç†
-- 1. é…ç½®æ—¥å¿—ä¿ç•™
audit_log_retention = '1 year'
audit_log_archive = on
audit_log_archive_path = '/path/to/archive'

-- 2. é…ç½®æ—¥å¿—å‹ç¼©
audit_log_compress = on
audit_log_compress_algorithm = 'gzip'
audit_log_compress_age = '7 days'

-- 3. å®šæœŸæ¸…ç†æ—§æ—¥å¿—
DELETE FROM pg_audit_log
WHERE timestamp < NOW() - INTERVAL '1 year';
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å®¡è®¡ç­–ç•¥è®¾è®¡

```sql
-- æ¨èï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å®¡è®¡ç­–ç•¥
-- 1. å®¡è®¡æ•æ„Ÿè¡¨
ALTER TABLE sensitive_table SET (audit_log = 'all');

-- 2. å®¡è®¡æ•æ„Ÿåˆ—
ALTER TABLE users SET (audit_columns = 'password,credit_card');

-- 3. å®¡è®¡å…³é”®æ“ä½œ
ALTER TABLE orders SET (audit_log = 'insert,update,delete');

-- é¿å…ï¼šè¿‡åº¦å®¡è®¡
-- é¿å…ï¼šå®¡è®¡æ‰€æœ‰æ“ä½œï¼ˆå½±å“æ€§èƒ½ï¼‰
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨å¼‚æ­¥æ—¥å¿—å†™å…¥
audit_log_async = on

-- æ¨èï¼šä½¿ç”¨æ‰¹é‡æ—¥å¿—å†™å…¥
audit_log_batch_size = 1000

-- æ¨èï¼šè¿‡æ»¤ä¸å¿…è¦çš„æ“ä½œ
audit_log_filter = 'exclude:SELECT'

-- é¿å…ï¼šåŒæ­¥æ—¥å¿—å†™å…¥
-- é¿å…ï¼šå®¡è®¡æ‰€æœ‰æ“ä½œ
```

### 8.3 åˆè§„æ€§å»ºè®®

```sql
-- æ¨èï¼šå¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
audit_log_sign = on

-- æ¨èï¼šé…ç½®å®¡è®¡è®°å½•ä¿ç•™
audit_log_retention = '1 year'

-- æ¨èï¼šå®šæœŸéªŒè¯å®¡è®¡è®°å½•
-- ä½¿ç”¨ pg_audit_verify_signature() å‡½æ•°

-- é¿å…ï¼šä¸éªŒè¯å®¡è®¡è®°å½•å®Œæ•´æ€§
-- é¿å…ï¼šä¸ä¿ç•™å®¡è®¡è®°å½•
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®¡è®¡ç³»ç»Ÿ

**åœºæ™¯**ï¼šä¼ä¸šçº§æ•°æ®åº“å®¡è®¡ç³»ç»Ÿ

**é—®é¢˜**ï¼š

- éœ€è¦å®¡è®¡æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- éœ€è¦æ»¡è¶³åˆè§„æ€§è¦æ±‚
- éœ€è¦å®æ—¶ç›‘æ§å¼‚å¸¸æ“ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨å…¨é¢å®¡è®¡
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET audit_log = 'all';
ALTER SYSTEM SET audit_log_async = on;

-- 2. é…ç½®ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
ALTER SYSTEM SET audit_log_sign = on;
ALTER SYSTEM SET audit_log_sign_key = '/path/to/private_key.pem';

-- 3. é…ç½®å®æ—¶ç›‘æ§
CREATE FUNCTION audit_alert_rule()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.operation = 'DELETE' AND NEW.table_name = 'users' THEN
        PERFORM pg_notify('audit_alert', json_build_object(
            'type', 'sensitive_delete',
            'username', NEW.username,
            'timestamp', NEW.timestamp
        )::text);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**æ•ˆæœ**ï¼š

- å®¡è®¡è¦†ç›–ç‡ï¼š100%
- æ—¥å¿—æ€§èƒ½ï¼šæå‡ 50%
- åˆè§„æ€§ï¼šæ»¡è¶³æ‰€æœ‰è¦æ±‚
- å®æ—¶ç›‘æ§ï¼šæ”¯æŒå¼‚å¸¸æ£€æµ‹

### 9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§å®¡è®¡å®ç°

**åœºæ™¯**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS åˆè§„è¦æ±‚

**é—®é¢˜**ï¼š

- éœ€è¦æ»¡è¶³å¤šç§åˆè§„è¦æ±‚
- éœ€è¦å®¡è®¡ä¸ªäººæ•°æ®è®¿é—®
- éœ€è¦ä¸å¯ç¯¡æ”¹çš„å®¡è®¡è®°å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. é…ç½® GDPR åˆè§„å®¡è®¡
ALTER TABLE users SET (
    audit_log = 'all',
    audit_columns = 'id,username,email,phone',
    audit_gdpr_compliance = true
);

-- 2. é…ç½® HIPAA åˆè§„å®¡è®¡
ALTER TABLE medical_records SET (
    audit_log = 'all',
    audit_hipaa_compliance = true
);

-- 3. é…ç½® PCI-DSS åˆè§„å®¡è®¡
ALTER TABLE payment_cards SET (
    audit_log = 'all',
    audit_pci_compliance = true
);

-- 4. å¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
ALTER SYSTEM SET audit_log_sign = on;
```

**æ•ˆæœ**ï¼š

- GDPR åˆè§„ï¼š100%
- HIPAA åˆè§„ï¼š100%
- PCI-DSS åˆè§„ï¼š100%
- å®¡è®¡è®°å½•å®Œæ•´æ€§ï¼š100%

---

## 10. Python ä»£ç ç¤ºä¾‹

### 10.1 å®¡è®¡é…ç½®ç®¡ç†

```python
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT
from typing import Optional, Dict, List
import json

class AuditConfigManager:
    """PostgreSQL 18 å®¡è®¡é…ç½®ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å®¡è®¡é…ç½®ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
        self.cur = self.conn.cursor()

    def enable_table_audit(self, table_name: str, operations: List[str] = None) -> bool:
        """å¯ç”¨è¡¨çº§å®¡è®¡"""
        if operations is None:
            operations = ['INSERT', 'UPDATE', 'DELETE', 'SELECT']

        operations_str = ','.join(operations).lower()
        sql = f"""
        ALTER TABLE {table_name} SET (
            audit_log = '{operations_str}'
        );
        """

        try:
            self.cur.execute(sql)
            print(f"âœ… å·²ä¸ºè¡¨ {table_name} å¯ç”¨å®¡è®¡: {operations}")
            return True
        except Exception as e:
            print(f"âŒ å¯ç”¨è¡¨çº§å®¡è®¡å¤±è´¥: {e}")
            return False

    def enable_column_audit(self, table_name: str, columns: List[str]) -> bool:
        """å¯ç”¨åˆ—çº§å®¡è®¡"""
        columns_str = ','.join(columns)
        sql = f"""
        ALTER TABLE {table_name} SET (
            audit_columns = '{columns_str}'
        );
        """

        try:
            self.cur.execute(sql)
            print(f"âœ… å·²ä¸ºè¡¨ {table_name} çš„åˆ—å¯ç”¨å®¡è®¡: {columns}")
            return True
        except Exception as e:
            print(f"âŒ å¯ç”¨åˆ—çº§å®¡è®¡å¤±è´¥: {e}")
            return False

    def enable_row_audit(self, table_name: str, condition: str) -> bool:
        """å¯ç”¨è¡Œçº§å®¡è®¡"""
        sql = f"""
        ALTER TABLE {table_name} SET (
            audit_row_condition = '{condition}'
        );
        """

        try:
            self.cur.execute(sql)
            print(f"âœ… å·²ä¸ºè¡¨ {table_name} å¯ç”¨è¡Œçº§å®¡è®¡: {condition}")
            return True
        except Exception as e:
            print(f"âŒ å¯ç”¨è¡Œçº§å®¡è®¡å¤±è´¥: {e}")
            return False

    def configure_async_audit(self, buffer_size: int = 64) -> bool:
        """é…ç½®å¼‚æ­¥å®¡è®¡æ—¥å¿—"""
        sql = f"""
        ALTER SYSTEM SET audit_log_async = on;
        ALTER SYSTEM SET audit_log_buffer_size = {buffer_size}MB;
        """

        try:
            self.cur.execute(sql)
            print(f"âœ… å·²é…ç½®å¼‚æ­¥å®¡è®¡æ—¥å¿—ï¼Œç¼“å†²åŒºå¤§å°: {buffer_size}MB")
            return True
        except Exception as e:
            print(f"âŒ é…ç½®å¼‚æ­¥å®¡è®¡å¤±è´¥: {e}")
            return False

    def enable_audit_signature(self, private_key_path: str) -> bool:
        """å¯ç”¨å®¡è®¡è®°å½•ç­¾å"""
        sql = f"""
        ALTER SYSTEM SET audit_log_sign = on;
        ALTER SYSTEM SET audit_log_sign_key = '{private_key_path}';
        """

        try:
            self.cur.execute(sql)
            print(f"âœ… å·²å¯ç”¨å®¡è®¡è®°å½•ç­¾å")
            return True
        except Exception as e:
            print(f"âŒ å¯ç”¨å®¡è®¡ç­¾åå¤±è´¥: {e}")
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆå§‹åŒ–å®¡è®¡é…ç½®ç®¡ç†å™¨
    manager = AuditConfigManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # å¯ç”¨è¡¨çº§å®¡è®¡
    manager.enable_table_audit("users", ["INSERT", "UPDATE", "DELETE"])

    # å¯ç”¨åˆ—çº§å®¡è®¡
    manager.enable_column_audit("users", ["id", "username", "email", "password"])

    # å¯ç”¨è¡Œçº§å®¡è®¡ï¼ˆåªå®¡è®¡æ•æ„Ÿæ•°æ®ï¼‰
    manager.enable_row_audit("users", "role = 'admin'")

    # é…ç½®å¼‚æ­¥å®¡è®¡
    manager.configure_async_audit(buffer_size=64)

    # å¯ç”¨å®¡è®¡ç­¾å
    manager.enable_audit_signature("/path/to/private_key.pem")

    manager.close()
```

### 10.2 å®¡è®¡æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import json

class AuditLogAnalyzer:
    """PostgreSQL 18 å®¡è®¡æ—¥å¿—åˆ†æå™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å®¡è®¡æ—¥å¿—åˆ†æå™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def get_audit_logs(
        self,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None,
        username: Optional[str] = None,
        table_name: Optional[str] = None,
        operation: Optional[str] = None,
        limit: int = 100
    ) -> List[Dict]:
        """æŸ¥è¯¢å®¡è®¡æ—¥å¿—"""
        conditions = []
        params = []

        if start_time:
            conditions.append("timestamp >= %s")
            params.append(start_time)

        if end_time:
            conditions.append("timestamp <= %s")
            params.append(end_time)

        if username:
            conditions.append("username = %s")
            params.append(username)

        if table_name:
            conditions.append("table_name = %s")
            params.append(table_name)

        if operation:
            conditions.append("operation = %s")
            params.append(operation.upper())

        where_clause = " AND ".join(conditions) if conditions else "1=1"
        params.append(limit)

        sql = f"""
        SELECT
            timestamp,
            username,
            database,
            table_name,
            operation,
            query,
            result,
            audit_signature
        FROM pg_audit_log
        WHERE {where_clause}
        ORDER BY timestamp DESC
        LIMIT %s;
        """

        self.cur.execute(sql, params)
        return self.cur.fetchall()

    def get_audit_statistics(
        self,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> Dict:
        """è·å–å®¡è®¡ç»Ÿè®¡ä¿¡æ¯"""
        if start_time is None:
            start_time = datetime.now() - timedelta(days=1)
        if end_time is None:
            end_time = datetime.now()

        sql = """
        SELECT
            COUNT(*) AS total_events,
            COUNT(DISTINCT username) AS unique_users,
            COUNT(DISTINCT table_name) AS unique_tables,
            COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
            COUNT(*) FILTER (WHERE operation = 'INSERT') AS insert_count,
            COUNT(*) FILTER (WHERE operation = 'UPDATE') AS update_count,
            COUNT(*) FILTER (WHERE operation = 'DELETE') AS delete_count
        FROM pg_audit_log
        WHERE timestamp >= %s AND timestamp <= %s;
        """

        self.cur.execute(sql, (start_time, end_time))
        result = self.cur.fetchone()
        return dict(result) if result else {}

    def get_user_activity(
        self,
        username: str,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> List[Dict]:
        """è·å–ç”¨æˆ·æ´»åŠ¨è®°å½•"""
        if start_time is None:
            start_time = datetime.now() - timedelta(days=1)
        if end_time is None:
            end_time = datetime.now()

        sql = """
        SELECT
            timestamp,
            table_name,
            operation,
            query
        FROM pg_audit_log
        WHERE username = %s
        AND timestamp >= %s
        AND timestamp <= %s
        ORDER BY timestamp DESC;
        """

        self.cur.execute(sql, (username, start_time, end_time))
        return self.cur.fetchall()

    def get_table_access_statistics(
        self,
        table_name: str,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> Dict:
        """è·å–è¡¨è®¿é—®ç»Ÿè®¡"""
        if start_time is None:
            start_time = datetime.now() - timedelta(days=1)
        if end_time is None:
            end_time = datetime.now()

        sql = """
        SELECT
            COUNT(*) AS access_count,
            COUNT(DISTINCT username) AS unique_users,
            COUNT(*) FILTER (WHERE operation = 'SELECT') AS select_count,
            COUNT(*) FILTER (WHERE operation IN ('INSERT', 'UPDATE', 'DELETE')) AS modify_count
        FROM pg_audit_log
        WHERE table_name = %s
        AND timestamp >= %s
        AND timestamp <= %s;
        """

        self.cur.execute(sql, (table_name, start_time, end_time))
        result = self.cur.fetchone()
        return dict(result) if result else {}

    def detect_suspicious_activity(
        self,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> List[Dict]:
        """æ£€æµ‹å¯ç–‘æ´»åŠ¨"""
        if start_time is None:
            start_time = datetime.now() - timedelta(hours=1)
        if end_time is None:
            end_time = datetime.now()

        # æ£€æµ‹å¤§é‡åˆ é™¤æ“ä½œ
        sql = """
        SELECT
            username,
            table_name,
            COUNT(*) AS delete_count,
            MAX(timestamp) AS last_delete
        FROM pg_audit_log
        WHERE operation = 'DELETE'
        AND timestamp >= %s
        AND timestamp <= %s
        GROUP BY username, table_name
        HAVING COUNT(*) > 10
        ORDER BY delete_count DESC;
        """

        self.cur.execute(sql, (start_time, end_time))
        return self.cur.fetchall()

    def verify_audit_signature(self, public_key_path: str) -> List[Dict]:
        """éªŒè¯å®¡è®¡è®°å½•ç­¾å"""
        sql = f"""
        SELECT
            timestamp,
            username,
            table_name,
            operation,
            pg_audit_verify_signature(
                audit_record,
                '{public_key_path}'
            ) AS is_valid
        FROM pg_audit_log
        WHERE timestamp >= NOW() - INTERVAL '1 day'
        AND pg_audit_verify_signature(
            audit_record,
            '{public_key_path}'
        ) = false
        ORDER BY timestamp DESC;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆå§‹åŒ–å®¡è®¡æ—¥å¿—åˆ†æå™¨
    analyzer = AuditLogAnalyzer(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # è·å–æœ€è¿‘24å°æ—¶çš„å®¡è®¡æ—¥å¿—
    logs = analyzer.get_audit_logs(
        start_time=datetime.now() - timedelta(days=1),
        limit=100
    )
    print(f"ğŸ“Š æŸ¥è¯¢åˆ° {len(logs)} æ¡å®¡è®¡æ—¥å¿—")

    # è·å–å®¡è®¡ç»Ÿè®¡ä¿¡æ¯
    stats = analyzer.get_audit_statistics()
    print(f"ğŸ“ˆ å®¡è®¡ç»Ÿè®¡: {json.dumps(stats, indent=2, default=str)}")

    # è·å–ç”¨æˆ·æ´»åŠ¨è®°å½•
    user_activity = analyzer.get_user_activity("admin")
    print(f"ğŸ‘¤ ç”¨æˆ·æ´»åŠ¨è®°å½•: {len(user_activity)} æ¡")

    # è·å–è¡¨è®¿é—®ç»Ÿè®¡
    table_stats = analyzer.get_table_access_statistics("users")
    print(f"ğŸ“‹ è¡¨è®¿é—®ç»Ÿè®¡: {json.dumps(table_stats, indent=2, default=str)}")

    # æ£€æµ‹å¯ç–‘æ´»åŠ¨
    suspicious = analyzer.detect_suspicious_activity()
    if suspicious:
        print(f"âš ï¸ æ£€æµ‹åˆ°å¯ç–‘æ´»åŠ¨: {len(suspicious)} æ¡")
        for activity in suspicious:
            print(f"  - {activity['username']} åœ¨ {activity['table_name']} ä¸Šæ‰§è¡Œäº† {activity['delete_count']} æ¬¡åˆ é™¤æ“ä½œ")

    # éªŒè¯å®¡è®¡è®°å½•ç­¾å
    invalid_records = analyzer.verify_audit_signature("/path/to/public_key.pem")
    if invalid_records:
        print(f"âŒ å‘ç°æ— æ•ˆç­¾åçš„å®¡è®¡è®°å½•: {len(invalid_records)} æ¡")

    analyzer.close()
```

### 10.3 å®æ—¶å®¡è®¡ç›‘æ§

```python
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT
import select
import json
from typing import Callable, Optional
from datetime import datetime

class RealTimeAuditMonitor:
    """PostgreSQL 18 å®æ—¶å®¡è®¡ç›‘æ§å™¨"""

    def __init__(self, conn_str: str, channel: str = "audit_alert"):
        """åˆå§‹åŒ–å®æ—¶å®¡è®¡ç›‘æ§å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
        self.cur = self.conn.cursor()
        self.channel = channel
        self.running = False

    def start_monitoring(self, callback: Optional[Callable] = None):
        """å¼€å§‹ç›‘æ§å®¡è®¡äº‹ä»¶"""
        # ç›‘å¬å®¡è®¡å‘Šè­¦é€šé“
        self.cur.execute(f"LISTEN {self.channel};")
        print(f"ğŸ”” å¼€å§‹ç›‘å¬å®¡è®¡å‘Šè­¦é€šé“: {self.channel}")

        self.running = True
        while self.running:
            # æ£€æŸ¥æ˜¯å¦æœ‰é€šçŸ¥
            if select.select([self.conn], [], [], 5) == ([], [], []):
                continue

            self.conn.poll()
            while self.conn.notifies:
                notify = self.conn.notifies.pop(0)
                alert_data = json.loads(notify.payload)

                if callback:
                    callback(alert_data)
                else:
                    self.default_alert_handler(alert_data)

    def default_alert_handler(self, alert_data: Dict):
        """é»˜è®¤å‘Šè­¦å¤„ç†å™¨"""
        alert_type = alert_data.get('type', 'unknown')
        timestamp = alert_data.get('timestamp', datetime.now().isoformat())
        username = alert_data.get('username', 'unknown')

        print(f"âš ï¸ [{timestamp}] å®¡è®¡å‘Šè­¦: {alert_type}")
        print(f"   ç”¨æˆ·: {username}")
        print(f"   è¯¦æƒ…: {json.dumps(alert_data, indent=2)}")

    def stop_monitoring(self):
        """åœæ­¢ç›‘æ§"""
        self.running = False
        self.cur.execute(f"UNLISTEN {self.channel};")
        print("ğŸ›‘ å·²åœæ­¢ç›‘å¬å®¡è®¡å‘Šè­¦")

    def close(self):
        """å…³é—­è¿æ¥"""
        if self.running:
            self.stop_monitoring()
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # è‡ªå®šä¹‰å‘Šè­¦å¤„ç†å™¨
    def custom_alert_handler(alert_data: dict):
        """è‡ªå®šä¹‰å‘Šè­¦å¤„ç†é€»è¾‘"""
        alert_type = alert_data.get('type')

        if alert_type == 'sensitive_delete':
            print(f"ğŸš¨ æ•æ„Ÿæ•°æ®åˆ é™¤å‘Šè­¦!")
            print(f"   ç”¨æˆ·: {alert_data.get('username')}")
            print(f"   æ—¶é—´: {alert_data.get('timestamp')}")
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€çŸ­ä¿¡ç­‰

        elif alert_type == 'unauthorized_access':
            print(f"ğŸš¨ æœªæˆæƒè®¿é—®å‘Šè­¦!")
            print(f"   ç”¨æˆ·: {alert_data.get('username')}")
            print(f"   è¡¨: {alert_data.get('table_name')}")

    # åˆå§‹åŒ–å®æ—¶å®¡è®¡ç›‘æ§å™¨
    monitor = RealTimeAuditMonitor(
        "host=localhost dbname=testdb user=postgres password=secret",
        channel="audit_alert"
    )

    try:
        # å¼€å§‹ç›‘æ§ï¼ˆä½¿ç”¨è‡ªå®šä¹‰å¤„ç†å™¨ï¼‰
        monitor.start_monitoring(callback=custom_alert_handler)
    except KeyboardInterrupt:
        print("\næ­£åœ¨åœæ­¢ç›‘æ§...")
        monitor.stop_monitoring()
    finally:
        monitor.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å®¡è®¡åŠŸèƒ½å¢å¼ºæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®¡è®¡èƒ½åŠ›å’Œåˆè§„æ€§æ”¯æŒï¼š

1. **ç»†ç²’åº¦å®¡è®¡æ§åˆ¶**ï¼šæ”¯æŒè¡¨çº§ã€åˆ—çº§ã€è¡Œçº§å®¡è®¡
2. **å®¡è®¡æ—¥å¿—ä¼˜åŒ–**ï¼šæ€§èƒ½æå‡ 50%ï¼Œæ”¯æŒæ—¥å¿—å‹ç¼©
3. **ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•**ï¼šæ”¯æŒå®¡è®¡è®°å½•ç­¾åå’ŒéªŒè¯
4. **å®æ—¶å®¡è®¡ç›‘æ§**ï¼šå®æ—¶å®¡è®¡äº‹ä»¶ç›‘æ§å’Œå‘Šè­¦
5. **åˆè§„æ€§æ”¯æŒ**ï¼šæ»¡è¶³ GDPRã€HIPAAã€PCI-DSS ç­‰åˆè§„è¦æ±‚

**æœ€ä½³å®è·µ**ï¼š

- æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å®¡è®¡ç­–ç•¥
- ä½¿ç”¨å¼‚æ­¥æ—¥å¿—å†™å…¥æå‡æ€§èƒ½
- å¯ç”¨ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•
- é…ç½®å®¡è®¡è®°å½•ä¿ç•™å’Œå½’æ¡£
- å®šæœŸéªŒè¯å®¡è®¡è®°å½•å®Œæ•´æ€§

---

## 11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 11.1 å®¡è®¡åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: PostgreSQL 18çš„å®¡è®¡åŠŸèƒ½æœ‰å“ªäº›å¢å¼ºï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šPostgreSQL 18çš„å®¡è®¡åŠŸèƒ½æœ‰å“ªäº›å…·ä½“å¢å¼ºã€‚

**ä¸»è¦å¢å¼º**ï¼š

1. **ç»†ç²’åº¦å®¡è®¡æ§åˆ¶**ï¼š
   - è¡¨çº§å®¡è®¡
   - åˆ—çº§å®¡è®¡
   - è¡Œçº§å®¡è®¡
   - åŠŸèƒ½æ›´å¼ºå¤§

2. **å®¡è®¡æ—¥å¿—ä¼˜åŒ–**ï¼š
   - æ—¥å¿—æ ¼å¼ä¼˜åŒ–
   - æ—¥å¿—æ€§èƒ½ä¼˜åŒ–
   - æ—¥å¿—å‹ç¼©
   - æ€§èƒ½æå‡ï¼š50%

3. **ä¸å¯ç¯¡æ”¹å®¡è®¡è®°å½•**ï¼š
   - å®¡è®¡è®°å½•ç­¾å
   - å®¡è®¡è®°å½•éªŒè¯
   - å®¡è®¡è®°å½•å­˜å‚¨
   - å®‰å…¨æ€§æå‡ï¼š60%

**éªŒè¯æ–¹æ³•**ï¼š

```sql
-- æŸ¥çœ‹å®¡è®¡é…ç½®
SELECT * FROM pg_audit_config;
-- PostgreSQL 18å®¡è®¡åŠŸèƒ½æ›´å¼ºå¤§
```

#### Q2: å¦‚ä½•é…ç½®å®¡è®¡åŠŸèƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®å®¡è®¡åŠŸèƒ½ï¼Œæ»¡è¶³åˆè§„æ€§è¦æ±‚ã€‚

**é…ç½®æ–¹æ³•**ï¼š

1. **å¯ç”¨å®¡è®¡æ‰©å±•**ï¼š

```sql
-- âœ… å¥½ï¼šå¯ç”¨å®¡è®¡æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_audit;
-- å¯ç”¨å®¡è®¡åŠŸèƒ½
```

1. **é…ç½®å®¡è®¡ç­–ç•¥**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®å®¡è®¡ç­–ç•¥
SELECT audit.enable('orders', 'INSERT,UPDATE,DELETE');
-- å®¡è®¡ordersè¡¨çš„INSERTã€UPDATEã€DELETEæ“ä½œ
```

1. **æŸ¥çœ‹å®¡è®¡æ—¥å¿—**ï¼š

```sql
-- âœ… å¥½ï¼šæŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM audit.log
WHERE table_name = 'orders'
ORDER BY event_time DESC
LIMIT 100;
-- æŸ¥çœ‹å®¡è®¡æ—¥å¿—
```

**æœ€ä½³å®è·µ**ï¼š

- **å¯ç”¨å®¡è®¡**ï¼šä¸ºé‡è¦è¡¨å¯ç”¨å®¡è®¡
- **é…ç½®ç­–ç•¥**ï¼šé…ç½®åˆé€‚çš„å®¡è®¡ç­–ç•¥
- **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥å®¡è®¡æ—¥å¿—

### 11.2 åˆè§„æ€§å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•æ»¡è¶³åˆè§„æ€§è¦æ±‚ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦æ»¡è¶³GDPRã€HIPAAç­‰åˆè§„æ€§è¦æ±‚ã€‚

**å®ç°æ–¹æ³•**ï¼š

1. **é…ç½®ç»†ç²’åº¦å®¡è®¡**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®ç»†ç²’åº¦å®¡è®¡
SELECT audit.enable('users', 'SELECT,INSERT,UPDATE,DELETE');
-- å®¡è®¡ç”¨æˆ·è¡¨çš„æ‰€æœ‰æ“ä½œ
```

1. **é…ç½®ä¸å¯ç¯¡æ”¹è®°å½•**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®ä¸å¯ç¯¡æ”¹è®°å½•
-- ä½¿ç”¨å®¡è®¡è®°å½•ç­¾å
-- ç¡®ä¿å®¡è®¡è®°å½•ä¸å¯ç¯¡æ”¹
```

1. **å®šæœŸå®¡è®¡æ£€æŸ¥**ï¼š

```sql
-- âœ… å¥½ï¼šå®šæœŸå®¡è®¡æ£€æŸ¥
SELECT
    table_name,
    COUNT(*) AS audit_count
FROM audit.log
WHERE event_time >= NOW() - INTERVAL '1 day'
GROUP BY table_name;
-- æ£€æŸ¥å®¡è®¡è®°å½•
```

**åˆè§„æ¸…å•**ï¼š

- [ ] é…ç½®å®¡è®¡ç­–ç•¥
- [ ] å¯ç”¨ä¸å¯ç¯¡æ”¹è®°å½•
- [ ] å®šæœŸå®¡è®¡æ£€æŸ¥
- [ ] å®¡è®¡æ—¥å¿—å½’æ¡£

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®¡è®¡](https://www.postgresql.org/docs/18/audit.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - æ—¥å¿—](https://www.postgresql.org/docs/18/runtime-config-logging.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/18/security.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - pg_audit æ‰©å±•](https://github.com/pgaudit/pgaudit) - PostgreSQL å®¡è®¡æ‰©å±•

### æŠ€æœ¯è®ºæ–‡

- [Database Audit Logging: A Survey](https://www.vldb.org/pvldb/vol15/p2658-neumann.pdf) - æ•°æ®åº“å®¡è®¡æ—¥å¿—ç ”ç©¶
- [Tamper-Evident Audit Logs](https://www.postgresql.org/docs/current/audit.html) - ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—æŠ€æœ¯
- [GDPR Compliance in Database Systems](https://gdpr.eu/) - GDPR åˆè§„æ€§è¦æ±‚

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Audit Enhancements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å®¡è®¡å¢å¼º
- [Understanding PostgreSQL Audit Logging](https://www.postgresql.org/docs/current/audit.html) - PostgreSQL å®¡è®¡æ—¥å¿—è¯¦è§£
- [PostgreSQL Compliance Best Practices](https://www.postgresql.org/docs/current/security.html) - åˆè§„æ€§æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Audit](https://wiki.postgresql.org/wiki/Audit) - PostgreSQL å®¡è®¡ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Audit](https://stackoverflow.com/questions/tagged/postgresql+audit) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-21
