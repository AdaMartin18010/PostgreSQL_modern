---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\01-PostgreSQL18\23-å®‰å…¨å¢å¼ºä¸é›¶ä¿¡ä»»æ¶æ„æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å®‰å…¨å¢å¼ºä¸é›¶ä¿¡ä»»æ¶æ„æŒ‡å—

> **ç‰ˆæœ¬**: PostgreSQL 18
> **æ›´æ–°æ—¶é—´**: 2025å¹´12æœˆ4æ—¥
> **æ–‡æ¡£ç¼–å·**: PG18-DOC-23
> **éš¾åº¦**: â­â­â­â­â­
> **å®‰å…¨ç­‰çº§**: ğŸ” ä¼ä¸šçº§

---

## ğŸ“‘ ç›®å½•

- [1.1 å¤šå±‚å®‰å…¨æ¨¡å‹](#11-å¤šå±‚å®‰å…¨æ¨¡å‹)
- [1.2 å®‰å…¨å¨èƒæ¨¡å‹](#12-å®‰å…¨å¨èƒæ¨¡å‹)
- [2.1 OAuth 2.0ä¼ä¸šSSOé›†æˆ](#21-oauth-20ä¼ä¸šssoé›†æˆ)
- [2.2 TLS 1.3æ”¯æŒ](#22-tls-13æ”¯æŒ)
- [2.3 SCRAM-SHA-256å¢å¼º](#23-scram-sha-256å¢å¼º)
- [3.1 è®¤è¯æ–¹æ³•å…¨æ™¯](#31-è®¤è¯æ–¹æ³•å…¨æ™¯)
- [3.2 pg_hba.confæ·±åº¦é…ç½®](#32-pg_hbaconfæ·±åº¦é…ç½®)
- [3.3 è§’è‰²ä¸æƒé™ç®¡ç†](#33-è§’è‰²ä¸æƒé™ç®¡ç†)
- [4.1 RLSç­–ç•¥è®¾è®¡](#41-rlsç­–ç•¥è®¾è®¡)
- [4.2 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»](#42-å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»)
- [4.3 RLSæ€§èƒ½ä¼˜åŒ–](#43-rlsæ€§èƒ½ä¼˜åŒ–)
- [5.1 ä¼ è¾“åŠ å¯†ï¼ˆTLSï¼‰](#51-ä¼ è¾“åŠ å¯†tls)
- [5.2 é™æ€æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰](#52-é™æ€æ•°æ®åŠ å¯†tde)
- [5.3 åˆ—çº§åŠ å¯†](#53-åˆ—çº§åŠ å¯†)
- [6.1 pgAuditæ‰©å±•è¯¦è§£](#61-pgauditæ‰©å±•è¯¦è§£)
- [6.2 å®¡è®¡æ—¥å¿—åˆ†æ](#62-å®¡è®¡æ—¥å¿—åˆ†æ)
- [6.3 åˆè§„å®¡è®¡æŠ¥å‘Š](#63-åˆè§„å®¡è®¡æŠ¥å‘Š)
- [7.1 é›¶ä¿¡ä»»åŸåˆ™](#71-é›¶ä¿¡ä»»åŸåˆ™)
- [7.2 å¾®éš”ç¦»å®ç°](#72-å¾®éš”ç¦»å®ç°)
- [7.3 æŒç»­éªŒè¯](#73-æŒç»­éªŒè¯)
- [8.1 GDPRåˆè§„](#81-gdpråˆè§„)
- [8.2 ç­‰ä¿2.0è¦æ±‚](#82-ç­‰ä¿20è¦æ±‚)
- [8.3 SOC 2å®¡è®¡](#83-soc-2å®¡è®¡)
- [9.1 å®‰å…¨äº‹ä»¶ç›‘æ§](#91-å®‰å…¨äº‹ä»¶ç›‘æ§)
- [9.2 å…¥ä¾µæ£€æµ‹](#92-å…¥ä¾µæ£€æµ‹)
- [9.3 å®‰å…¨äº‹ä»¶å“åº”](#93-å®‰å…¨äº‹ä»¶å“åº”)
- [10.1 PostgreSQL vs ç«å“å®‰å…¨å¯¹æ¯”](#101-postgresql-vs-ç«å“å®‰å…¨å¯¹æ¯”)
- [10.2 å®‰å…¨å±€é™æ€§](#102-å®‰å…¨å±€é™æ€§)
- [PostgreSQL 18å®‰å…¨æ ¸å¿ƒä»·å€¼](#postgresql-18å®‰å…¨æ ¸å¿ƒä»·å€¼)
---

## 1. PostgreSQLå®‰å…¨æ¶æ„å…¨æ™¯

### 1.1 å¤šå±‚å®‰å…¨æ¨¡å‹

```mermaid
graph TB
    A[PostgreSQL<br/>å¤šå±‚å®‰å…¨æ¨¡å‹] --> B[ç½‘ç»œå±‚å®‰å…¨]
    A --> C[è®¤è¯å±‚å®‰å…¨]
    A --> D[æˆæƒå±‚å®‰å…¨]
    A --> E[æ•°æ®å±‚å®‰å…¨]
    A --> F[å®¡è®¡å±‚å®‰å…¨]

    B --> B1[é˜²ç«å¢™è§„åˆ™]
    B --> B2[TLS 1.3åŠ å¯†]
    B --> B3[pg_hba.confè®¿é—®æ§åˆ¶]

    C --> C1[SCRAM-SHA-256]
    C --> C2[OAuth 2.0/OIDC]
    C --> C3[Kerberos/GSSAPI]
    C --> C4[Certificateè®¤è¯]

    D --> D1[RBACè§’è‰²æƒé™]
    D --> D2[è¡Œçº§å®‰å…¨RLS]
    D --> D3[åˆ—çº§æƒé™]
    D --> D4[Schemaéš”ç¦»]

    E --> E1[ä¼ è¾“åŠ å¯†TLS]
    E --> E2[é™æ€åŠ å¯†TDE]
    E --> E3[åˆ—çº§åŠ å¯†pgcrypto]
    E --> E4[å¤‡ä»½åŠ å¯†]

    F --> F1[pgAuditå®¡è®¡æ—¥å¿—]
    F --> F2[è¿æ¥æ—¥å¿—]
    F --> F3[æŸ¥è¯¢æ—¥å¿—]
    F --> F4[DDL/DMLè¿½è¸ª]

    style A fill:#ff6b6b,color:#fff
    style C2 fill:#4ecdc4,color:#fff
    style D2 fill:#4ecdc4,color:#fff
```

### 1.2 å®‰å…¨å¨èƒæ¨¡å‹

```yaml
å¨èƒåˆ†ç±»ä¸é˜²å¾¡:

1. ç½‘ç»œæ”»å‡»:
   å¨èƒ: SQLæ³¨å…¥ã€ä¸­é—´äººæ”»å‡»ã€DDoS
   é˜²å¾¡:
     - å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²SQLæ³¨å…¥ï¼‰
     - TLS 1.3å¼ºåˆ¶åŠ å¯†
     - è¿æ¥é™åˆ¶ï¼ˆmax_connectionsï¼‰
     - IPç™½åå•ï¼ˆpg_hba.confï¼‰

2. è®¤è¯æ”»å‡»:
   å¨èƒ: æš´åŠ›ç ´è§£ã€å‡­è¯æ³„éœ²
   é˜²å¾¡:
     - å¼ºå¯†ç ç­–ç•¥ï¼ˆpasswordcheckæ‰©å±•ï¼‰
     - SCRAM-SHA-256ï¼ˆMD5å·²å¼ƒç”¨ï¼‰
     - OAuth 2.0/SSOï¼ˆé›†ä¸­è®¤è¯ï¼‰
     - åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰

3. æˆæƒç»•è¿‡:
   å¨èƒ: æƒé™æå‡ã€æ¨ªå‘ç§»åŠ¨
   é˜²å¾¡:
     - æœ€å°æƒé™åŸåˆ™
     - è¡Œçº§å®‰å…¨RLS
     - å®šæœŸæƒé™å®¡è®¡
     - è§’è‰²ç»§æ‰¿æ§åˆ¶

4. æ•°æ®æ³„éœ²:
   å¨èƒ: æ•°æ®çªƒå–ã€å¤‡ä»½æ³„éœ²
   é˜²å¾¡:
     - TDEé™æ€åŠ å¯†
     - åˆ—çº§æ•æ„Ÿæ•°æ®åŠ å¯†
     - å¤‡ä»½åŠ å¯†
     - æ•°æ®è„±æ•

5. å†…éƒ¨å¨èƒ:
   å¨èƒ: æ¶æ„ç®¡ç†å‘˜ã€è¯¯æ“ä½œ
   é˜²å¾¡:
     - å®¡è®¡æ—¥å¿—ï¼ˆpgAuditï¼‰
     - æ“ä½œå®¡æ‰¹æµç¨‹
     - æ•°æ®åº“é˜²ç«å¢™
     - èŒè´£åˆ†ç¦»

6. åˆè§„é£é™©:
   å¨èƒ: è¿åGDPR/ç­‰ä¿/SOC2
   é˜²å¾¡:
     - å®Œæ•´å®¡è®¡è¿½è¸ª
     - æ•°æ®ä¿ç•™ç­–ç•¥
     - è®¿é—®æ§åˆ¶è®°å½•
     - å®šæœŸåˆè§„å®¡è®¡
```

---

## 2. PostgreSQL 18å®‰å…¨å¢å¼º

### 2.1 OAuth 2.0ä¼ä¸šSSOé›†æˆ

**å·²åœ¨æ–‡æ¡£06ä¸­è¯¦ç»†è¦†ç›–ï¼Œæ­¤å¤„è¡¥å……ä¼ä¸šçº§åœºæ™¯**:

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šä¼ä¸šSSOé›†æˆï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
-- 1. å®‰è£…oauthæ‰©å±•
CREATE EXTENSION IF NOT EXISTS oauth2;
COMMIT;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'æ‰©å±•oauth2å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å®‰è£…oauthæ‰©å±•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š2. é…ç½®OAuthæä¾›å•†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DROP SERVER IF EXISTS okta_oauth CASCADE;
CREATE SERVER okta_oauth FOREIGN DATA WRAPPER oauth2_fdw OPTIONS (
    authorization_endpoint 'https://company.okta.com/oauth2/v1/authorize',
    token_endpoint 'https://company.okta.com/oauth2/v1/token',
    client_id 'your_client_id',
    client_secret 'your_client_secret',
    scope 'openid profile email groups'
);
COMMIT;
EXCEPTION
    WHEN undefined_object THEN
        RAISE NOTICE 'oauth2_fdwæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…æ‰©å±•';
    WHEN OTHERS THEN
        RAISE NOTICE 'é…ç½®OAuthæä¾›å•†å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š3. è§’è‰²æ˜ å°„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE OR REPLACE FUNCTION map_okta_groups_to_roles(
    p_groups TEXT[]
)
RETURNS TEXT AS $$
DECLARE
    v_role TEXT;
BEGIN
    -- Oktaç»„æ˜ å°„
    CASE
        WHEN 'DB_Admins' = ANY(p_groups) THEN
            v_role := 'db_admin';
        WHEN 'DB_Developers' = ANY(p_groups) THEN
            v_role := 'db_developer';
        WHEN 'DB_ReadOnly' = ANY(p_groups) THEN
            v_role := 'db_readonly';
        ELSE
            v_role := 'db_guest';
    END CASE;

    RETURN v_role;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è§’è‰²æ˜ å°„å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè§’è‰²æ˜ å°„å‡½æ•°å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- 4. ä¼šè¯åˆå§‹åŒ–ï¼ˆä»OAuth tokenæå–ç”¨æˆ·ä¿¡æ¯ï¼‰
CREATE OR REPLACE FUNCTION init_session_from_oauth(
    p_access_token TEXT
)
RETURNS VOID AS $$
DECLARE
    v_user_info JSONB;
    v_role TEXT;
BEGIN
    -- éªŒè¯tokenå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
    v_user_info := oauth2_verify_token(p_access_token);

    -- æå–ç»„ä¿¡æ¯
    v_role := map_okta_groups_to_roles(
        (v_user_info->>'groups')::TEXT[]
    );

    -- è®¾ç½®ä¼šè¯è§’è‰²
    EXECUTE format('SET ROLE %I', v_role);

    -- è®¾ç½®ä¼šè¯å˜é‡ï¼ˆç”¨äºRLSï¼‰
    PERFORM set_config('app.user_email', v_user_info->>'email', false);
    PERFORM set_config('app.user_id', v_user_info->>'sub', false);

    RAISE NOTICE 'ç”¨æˆ· % å·²é€šè¿‡OAuthè®¤è¯ï¼Œè§’è‰²ï¼š%',
        v_user_info->>'email', v_role;
END;
$$ LANGUAGE plpgsql;

-- 5. åº”ç”¨å±‚é›†æˆ
-- Pythonç¤ºä¾‹
/*
from authlib.integrations.flask_client import OAuth

oauth = OAuth(app)
okta = oauth.register('okta', ...)

@app.route('/api/data')
def get_data():
    token = okta.authorize_access_token()

    # å»ºç«‹PGè¿æ¥ï¼Œä¼ é€’token
    conn = psycopg2.connect(
        host='pg-server',
        database='production',
        user='oauth_user'
    )

    # åˆå§‹åŒ–ä¼šè¯
    cursor = conn.cursor()
    cursor.execute("SELECT init_session_from_oauth(%s)", (token['access_token'],))

    # æ‰§è¡Œä¸šåŠ¡æŸ¥è¯¢ï¼ˆè‡ªåŠ¨åº”ç”¨RLSç­–ç•¥ï¼‰
    cursor.execute("SELECT * FROM sensitive_data")
    return cursor.fetchall()
*/
```

### 2.2 TLS 1.3æ”¯æŒ

**PostgreSQL 18å®Œæ•´æ”¯æŒTLS 1.3**ï¼š

```bash
#!/bin/bash
# æ€§èƒ½æµ‹è¯•ï¼šç”ŸæˆSSLè¯ä¹¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
set -e
set -u

error_exit() {
    echo "é”™è¯¯: $1" >&2
    exit 1
}

CERT_DIR="${1:-/etc/postgresql/ssl}"
CN="${2:-pg-server.company.com}"

# 1. ç”ŸæˆSSLè¯ä¹¦ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨CAç­¾åè¯ä¹¦ï¼‰
mkdir -p "$CERT_DIR" || error_exit "åˆ›å»ºè¯ä¹¦ç›®å½•å¤±è´¥"

openssl req -new -x509 -days 365 -nodes -text \
    -out "$CERT_DIR/server.crt" \
    -keyout "$CERT_DIR/server.key" \
    -subj "/CN=$CN" || error_exit "ç”ŸæˆSSLè¯ä¹¦å¤±è´¥"

chmod 600 "$CERT_DIR/server.key" || error_exit "è®¾ç½®å¯†é’¥æƒé™å¤±è´¥"
chown postgres:postgres "$CERT_DIR/server.key" "$CERT_DIR/server.crt" || error_exit "è®¾ç½®æ–‡ä»¶æ‰€æœ‰è€…å¤±è´¥"

echo "SSLè¯ä¹¦å·²ç”Ÿæˆ: $CERT_DIR/server.crt"

# 2. é…ç½®PostgreSQLï¼ˆéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°postgresql.confï¼‰
echo "è¯·æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹é…ç½®åˆ°postgresql.conf:"
echo "ssl = on"
echo "ssl_cert_file = '$CERT_DIR/server.crt'"
echo "ssl_key_file = '$CERT_DIR/server.key'"
echo "ssl_min_protocol_version = 'TLSv1.3'"
echo "ssl_max_protocol_version = 'TLSv1.3'"
echo "ssl_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256'"

# 3. å¼ºåˆ¶å®¢æˆ·ç«¯ä½¿ç”¨SSLï¼ˆéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°pg_hba.confï¼‰
echo "è¯·æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹è¡Œåˆ°pg_hba.conf:"
echo "hostssl    all    all    0.0.0.0/0    scram-sha-256"

# 4. å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹
echo "å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹:"
echo "psql \"postgresql://user@host/db?sslmode=require&sslrootcert=$CERT_DIR/server.crt\""
```

**TLS 1.3 vs TLS 1.2æ€§èƒ½å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | TLS 1.2 | TLS 1.3 | æå‡ |
| --- | --- | --- | --- |
| **æ¡æ‰‹å»¶è¿Ÿ** | 2-RTT | 1-RTT | **-50%** |
| **æ¢å¤ä¼šè¯** | 1-RTT | 0-RTT | **-100%** |
| **åŠ å¯†æ€§èƒ½** | AES-CBC | AES-GCM | **+15%** |
| **å®‰å…¨æ€§** | âš ï¸ éƒ¨åˆ†å¼±å¯†ç å¥—ä»¶ | âœ… ä»…å¼ºå¯†ç  | æ›´å®‰å…¨ |

### 2.3 SCRAM-SHA-256å¢å¼º

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šPostgreSQL 18 SCRAMå¢å¼ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
-- 1. å¼ºåˆ¶SCRAMè®¤è¯ï¼ˆéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°pg_hba.confï¼‰
-- pg_hba.conf: host    all    all    0.0.0.0/0    scram-sha-256
RAISE NOTICE 'è¯·æ‰‹åŠ¨é…ç½®pg_hba.confä½¿ç”¨scram-sha-256';
COMMIT;

-- æ€§èƒ½æµ‹è¯•ï¼š2. å¯†ç å¼ºåº¦ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE EXTENSION IF NOT EXISTS passwordcheck;
COMMIT;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'æ‰©å±•passwordcheckå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å®‰è£…passwordcheckæ‰©å±•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š3. åˆ›å»ºç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE ROLE IF NOT EXISTS app_user WITH LOGIN PASSWORD 'SecureP@ssw0rd123!';
COMMIT;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'ç”¨æˆ·app_userå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºç”¨æˆ·å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹å¯†ç åŠ å¯†æ–¹å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT rolname, rolpassword
FROM pg_authid
WHERE rolname = 'app_user';
-- rolpassword: SCRAM-SHA-256$4096:xxx...ï¼ˆå¼ºåŠ å¯†ï¼‰
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æŸ¥çœ‹å¯†ç åŠ å¯†æ–¹å¼å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š4. å¯†ç æœ‰æ•ˆæœŸç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
ALTER ROLE app_user VALID UNTIL '2025-12-31';
COMMIT;
EXCEPTION
    WHEN undefined_object THEN
        RAISE NOTICE 'ç”¨æˆ·app_userä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®å¯†ç æœ‰æ•ˆæœŸå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š5. å¯†ç å†å²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS password_history (
    role_name TEXT,
    password_hash TEXT,
    changed_at TIMESTAMPTZ DEFAULT now()
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨password_historyå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå¯†ç å†å²è¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
CREATE OR REPLACE FUNCTION check_password_history()
RETURNS EVENT_TRIGGER AS $$
DECLARE
    v_new_password TEXT;
BEGIN
    -- æ£€æŸ¥æ–°å¯†ç æ˜¯å¦åœ¨å†å²ä¸­
    -- ï¼ˆç®€åŒ–ç‰ˆï¼Œç”Ÿäº§éœ€æ›´å¤æ‚é€»è¾‘ï¼‰
    RAISE NOTICE 'å¯†ç å†å²æ£€æŸ¥';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å¯†ç å†å²æ£€æŸ¥å¤±è´¥: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå¯†ç å†å²æ£€æŸ¥å‡½æ•°å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 3. è®¤è¯ä¸æˆæƒä½“ç³»

### 3.1 è®¤è¯æ–¹æ³•å…¨æ™¯

```mermaid
graph TB
    A[PostgreSQL<br/>è®¤è¯æ–¹æ³•] --> B[å¯†ç è®¤è¯]
    A --> C[è¯ä¹¦è®¤è¯]
    A --> D[å¤–éƒ¨è®¤è¯]
    A --> E[ç‰¹æ®Šè®¤è¯]

    B --> B1[SCRAM-SHA-256<br/>âœ… æ¨è]
    B --> B2[MD5<br/>âŒ å·²å¼ƒç”¨]
    B --> B3[Password<br/>âŒ æ˜æ–‡ï¼Œå±é™©]

    C --> C1[SSL Certificate<br/>åŒå‘è®¤è¯]
    C --> C2[clientcert=verify-full]

    D --> D1[LDAP<br/>ä¼ä¸šç›®å½•]
    D --> D2[Kerberos/GSSAPI<br/>åŸŸè®¤è¯]
    D --> D3[RADIUS<br/>ç½‘ç»œè®¾å¤‡]
    D --> D4[PAM<br/>ç³»ç»Ÿè®¤è¯]
    D --> D5[OAuth 2.0<br/>PG18æ–°å¢]

    E --> E1[peer<br/>æœ¬åœ°Unixç”¨æˆ·]
    E --> E2[ident<br/>èº«ä»½æ˜ å°„]
    E --> E3[trust<br/>âš ï¸ æ— å¯†ç ]

    style B1 fill:#4ecdc4,color:#fff
    style D5 fill:#4ecdc4,color:#fff
    style B2 fill:#ff6b6b,color:#fff
    style E3 fill:#ff6b6b,color:#fff
```

### 3.2 pg_hba.confæ·±åº¦é…ç½®

```bash
# pg_hba.confä¼ä¸šçº§é…ç½®ç¤ºä¾‹

# 1. æœ¬åœ°è¶…çº§ç”¨æˆ·ï¼ˆpeerè®¤è¯ï¼Œæœ€å®‰å…¨ï¼‰
local   all   postgres                peer

# 2. åº”ç”¨è¿æ¥ï¼ˆSCRAM + SSLï¼‰
hostssl all   app_user   10.0.1.0/24   scram-sha-256

# 3. ç®¡ç†å‘˜è¿œç¨‹ï¼ˆè¯ä¹¦è®¤è¯ + SCRAMï¼‰
hostssl all   admin      0.0.0.0/0     scram-sha-256 clientcert=verify-full

# 4. åªè¯»ç”¨æˆ·ï¼ˆIPé™åˆ¶ï¼‰
hostssl all   readonly   10.0.2.0/24   scram-sha-256

# 5. ç¬¬ä¸‰æ–¹é›†æˆï¼ˆOAuth 2.0ï¼‰
hostssl all   api_user   0.0.0.0/0     oauth map=oauth_map

# 6. å¼€å‘ç¯å¢ƒï¼ˆLDAPï¼‰
host    all   @devs      192.168.1.0/24  ldap ldapserver=ldap.company.com ldapbasedn="dc=company,dc=com"

# 7. ç›‘æ§å·¥å…·ï¼ˆè¯ä¹¦è®¤è¯ï¼‰
hostssl all   monitor    10.0.10.0/24  cert

# 8. æ‹’ç»æ‰€æœ‰å…¶ä»–è¿æ¥
host    all   all        0.0.0.0/0     reject

# âš ï¸ é…ç½®é¡ºåºé‡è¦ï¼šä»ä¸Šåˆ°ä¸‹åŒ¹é…ï¼Œç¬¬ä¸€æ¡åŒ¹é…ç”Ÿæ•ˆ
```

**æµ‹è¯•pg_hba.conf**ï¼š

```bash
# æµ‹è¯•è®¤è¯é…ç½®ï¼ˆä¸é‡å¯æ•°æ®åº“ï¼‰
pg_ctl reload

# éªŒè¯è¿æ¥
psql -h localhost -U app_user -d production
# è¾“å…¥å¯†ç ï¼šåº”æç¤ºSCRAMè®¤è¯

# æŸ¥çœ‹å½“å‰è¿æ¥è®¤è¯æ–¹æ³•
SELECT
    usename,
    client_addr,
    backend_type,
    state,
    pg_backend_pid()
FROM pg_stat_activity
WHERE usename = current_user;
```

### 3.3 è§’è‰²ä¸æƒé™ç®¡ç†

```sql
-- ä¼ä¸šçº§è§’è‰²ä½“ç³»è®¾è®¡

-- 1. åˆ›å»ºè§’è‰²å±‚æ¬¡
-- é¡¶å±‚ï¼šè¶…çº§ç®¡ç†å‘˜ï¼ˆä»…DBAï¼‰
CREATE ROLE dba WITH SUPERUSER LOGIN PASSWORD 'xxx';

-- ç¬¬äºŒå±‚ï¼šåŠŸèƒ½è§’è‰²ï¼ˆä¸å¯ç™»å½•ï¼‰
CREATE ROLE db_readonly NOLOGIN;
CREATE ROLE db_readwrite NOLOGIN;
CREATE ROLE db_admin NOLOGIN CREATEROLE;

-- ç¬¬ä¸‰å±‚ï¼šåº”ç”¨è§’è‰²
CREATE ROLE app_backend LOGIN PASSWORD 'xxx';
CREATE ROLE app_frontend LOGIN PASSWORD 'xxx';
CREATE ROLE data_analyst LOGIN PASSWORD 'xxx';

-- 2. æˆäºˆæƒé™
-- db_readonlyï¼šä»…SELECT
GRANT USAGE ON SCHEMA public TO db_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO db_readonly;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT ON TABLES TO db_readonly;

-- db_readwriteï¼šSELECT + INSERT + UPDATE + DELETE
GRANT USAGE ON SCHEMA public TO db_readwrite;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO db_readwrite;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO db_readwrite;

-- db_adminï¼šDDLæƒé™
GRANT CREATE ON SCHEMA public TO db_admin;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO db_admin;

-- 3. è§’è‰²ç»§æ‰¿
GRANT db_readonly TO db_readwrite;     -- readwriteç»§æ‰¿readonly
GRANT db_readwrite TO app_backend;     -- app_backendç»§æ‰¿readwrite
GRANT db_readonly TO data_analyst;     -- analystä»…åªè¯»

-- 4. æŸ¥çœ‹è§’è‰²ç»§æ‰¿æ ‘
WITH RECURSIVE role_tree AS (
    SELECT
        oid,
        rolname,
        rolsuper,
        1 AS level,
        rolname::TEXT AS path
    FROM pg_roles
    WHERE rolname IN ('dba', 'db_admin', 'db_readwrite', 'db_readonly')

    UNION ALL

    SELECT
        m.member,
        r.rolname,
        r.rolsuper,
        rt.level + 1,
        rt.path || ' â†’ ' || r.rolname
    FROM role_tree rt
    JOIN pg_auth_members m ON rt.oid = m.roleid
    JOIN pg_roles r ON m.member = r.oid
)
SELECT
    repeat('  ', level - 1) || rolname AS role_hierarchy,
    rolsuper AS is_superuser,
    path
FROM role_tree
ORDER BY path, level;

/*
è¾“å‡ºï¼š
 role_hierarchy  | is_superuser | path
-----------------+--------------+------------------------
 dba             |      t       | dba
 db_admin        |      f       | db_admin
 db_readwrite    |      f       | db_readwrite
   app_backend   |      f       | db_readwrite â†’ app_backend
 db_readonly     |      f       | db_readonly
   data_analyst  |      f       | db_readonly â†’ data_analyst
*/
```

---

## 4. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰æ·±åº¦åº”ç”¨

### 4.1 RLSç­–ç•¥è®¾è®¡

```sql
-- å¤šç§Ÿæˆ·SaaSå¹³å°ç¤ºä¾‹
CREATE TABLE tenants (
    tenant_id SERIAL PRIMARY KEY,
    tenant_name TEXT UNIQUE,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    tenant_id INT REFERENCES tenants(tenant_id),
    email TEXT UNIQUE,
    role TEXT  -- 'admin', 'user', 'guest'
);

CREATE TABLE documents (
    doc_id SERIAL PRIMARY KEY,
    tenant_id INT REFERENCES tenants(tenant_id),
    owner_user_id INT REFERENCES users(user_id),
    title TEXT,
    content TEXT,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- å¯ç”¨RLS
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥1ï¼šç§Ÿæˆ·éš”ç¦»ï¼ˆåŸºç¡€ï¼‰
CREATE POLICY tenant_isolation ON documents
    USING (tenant_id = current_setting('app.tenant_id')::int);

-- ç­–ç•¥2ï¼šæ‰€æœ‰è€…è®¿é—®ï¼ˆç»†ç²’åº¦ï¼‰
CREATE POLICY owner_access ON documents
    USING (owner_user_id = current_setting('app.user_id')::int);

-- ç­–ç•¥3ï¼šå…¬å¼€æ–‡æ¡£ï¼ˆæ‰€æœ‰äººå¯è¯»ï¼‰
CREATE POLICY public_read ON documents
    FOR SELECT
    USING (is_public = true);

-- ç­–ç•¥4ï¼šç®¡ç†å‘˜å…¨éƒ¨å¯è§
CREATE POLICY admin_all_access ON documents
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE user_id = current_setting('app.user_id')::int
              AND role = 'admin'
              AND tenant_id = documents.tenant_id
        )
    );

-- æµ‹è¯•RLS
-- è®¾ç½®ç§Ÿæˆ·Açš„ç”¨æˆ·
SET app.tenant_id = 1;
SET app.user_id = 100;

SELECT * FROM documents;
-- ç»“æœï¼šä»…è¿”å›tenant_id=1ä¸”ï¼ˆowner_user_id=100æˆ–is_public=trueæˆ–ç”¨æˆ·æ˜¯adminï¼‰çš„æ–‡æ¡£

-- åˆ‡æ¢åˆ°ç§Ÿæˆ·B
SET app.tenant_id = 2;
SET app.user_id = 200;

SELECT * FROM documents;
-- ç»“æœï¼šä»…è¿”å›tenant_id=2çš„ç›¸å…³æ–‡æ¡£
```

### 4.2 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

```sql
-- å®Œæ•´çš„å¤šç§Ÿæˆ·å®‰å…¨æ¶æ„

-- 1. ç§Ÿæˆ·ä¸Šä¸‹æ–‡è®¾ç½®ï¼ˆåº”ç”¨å±‚ï¼‰
CREATE OR REPLACE FUNCTION set_tenant_context(
    p_tenant_id INT,
    p_user_id INT
)
RETURNS VOID AS $$
BEGIN
    -- éªŒè¯ç”¨æˆ·å±äºè¯¥ç§Ÿæˆ·
    IF NOT EXISTS (
        SELECT 1 FROM users
        WHERE user_id = p_user_id AND tenant_id = p_tenant_id
    ) THEN
        RAISE EXCEPTION 'ç”¨æˆ·ä¸å±äºè¯¥ç§Ÿæˆ·';
    END IF;

    -- è®¾ç½®ä¼šè¯å˜é‡
    PERFORM set_config('app.tenant_id', p_tenant_id::text, false);
    PERFORM set_config('app.user_id', p_user_id::text, false);

    -- è®°å½•è®¿é—®æ—¥å¿—
    INSERT INTO access_log (tenant_id, user_id, access_time)
    VALUES (p_tenant_id, p_user_id, now());
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. RLSç­–ç•¥ï¼ˆé˜²å¾¡æ€§ï¼‰
CREATE POLICY tenant_isolation_strict ON documents
    USING (
        tenant_id = current_setting('app.tenant_id', true)::int
        AND current_setting('app.tenant_id', true) IS NOT NULL
    )
    WITH CHECK (
        tenant_id = current_setting('app.tenant_id', true)::int
    );

-- 3. åº”ç”¨å±‚é›†æˆï¼ˆPython/Djangoç¤ºä¾‹ï¼‰
/*
from django.db import connection

class TenantMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        tenant_id = request.user.tenant_id
        user_id = request.user.id

        # è®¾ç½®PGä¼šè¯ä¸Šä¸‹æ–‡
        with connection.cursor() as cursor:
            cursor.execute(
                "SELECT set_tenant_context(%s, %s)",
                [tenant_id, user_id]
            )

        response = self.get_response(request)
        return response
*/

-- 4. ç›‘æ§ç§Ÿæˆ·éš”ç¦»
SELECT
    tenant_id,
    COUNT(*) AS query_count,
    AVG(duration) AS avg_duration
FROM (
    SELECT
        current_setting('app.tenant_id')::int AS tenant_id,
        query,
        total_exec_time / calls AS duration
    FROM pg_stat_statements
) t
WHERE tenant_id IS NOT NULL
GROUP BY tenant_id
ORDER BY query_count DESC;
```

### 4.3 RLSæ€§èƒ½ä¼˜åŒ–

```sql
-- RLSæ€§èƒ½å¼€é”€æµ‹è¯•

-- 1. æ— RLSåŸºçº¿æµ‹è¯•
ALTER TABLE documents DISABLE ROW LEVEL SECURITY;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents WHERE tenant_id = 1;
-- Execution Time: 125 ms

-- 2. å¯ç”¨RLS
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents WHERE tenant_id = 1;
-- Execution Time: 145 msï¼ˆ+16% overheadï¼‰

-- 3. RLSæ€§èƒ½ä¼˜åŒ–æŠ€å·§

-- ä¼˜åŒ–1ï¼šåˆ›å»ºtenant_idç´¢å¼•
CREATE INDEX idx_documents_tenant ON documents(tenant_id);

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents WHERE tenant_id = 1;
-- Execution Time: 130 msï¼ˆ-10% vs æ— ç´¢å¼•RLSï¼‰

-- ä¼˜åŒ–2ï¼šä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼ˆä»…éå…¬å¼€æ–‡æ¡£ï¼‰
CREATE INDEX idx_documents_tenant_private
ON documents(tenant_id)
WHERE is_public = false;

-- ä¼˜åŒ–3ï¼šRLSç­–ç•¥ç®€åŒ–
-- âŒ å¤æ‚ç­–ç•¥ï¼š
CREATE POLICY complex_policy ON documents
    USING (
        tenant_id = current_setting('app.tenant_id')::int
        AND (
            owner_user_id = current_setting('app.user_id')::int
            OR EXISTS (SELECT 1 FROM complex_subquery ...)
        )
    );

-- âœ… ç®€å•ç­–ç•¥ï¼š
CREATE POLICY simple_policy ON documents
    USING (tenant_id = current_setting('app.tenant_id')::int);

-- å¤æ‚é€»è¾‘ç§»åˆ°åº”ç”¨å±‚æˆ–è§†å›¾
```

**RLSæ€§èƒ½å½±å“**ï¼š

| åœºæ™¯ | æ— RLS | ç®€å•RLS | å¤æ‚RLS | å»ºè®® |
| --- | --- | --- | --- | --- |
| **ç®€å•SELECT** | 100ms | 105ms (+5%) | 150ms (+50%) | ç®€åŒ–ç­–ç•¥ |
| **å¸¦JOINæŸ¥è¯¢** | 250ms | 270ms (+8%) | 450ms (+80%) | ä½¿ç”¨ç´¢å¼• |
| **èšåˆæŸ¥è¯¢** | 800ms | 850ms (+6%) | 1200ms (+50%) | é¢„èšåˆè§†å›¾ |

---

## 5. æ•°æ®åŠ å¯†å®Œæ•´æ–¹æ¡ˆ

### 5.1 ä¼ è¾“åŠ å¯†ï¼ˆTLSï¼‰

**å·²åœ¨2.2èŠ‚è¦†ç›–ï¼Œæ­¤å¤„è¡¥å……é«˜çº§é…ç½®**:

```sql
-- æŸ¥çœ‹SSLè¿æ¥ç»Ÿè®¡
SELECT
    datname,
    usename,
    client_addr,
    ssl,
    ssl_version,
    ssl_cipher,
    ssl_bits
FROM pg_stat_ssl
WHERE ssl = true;

-- ç›‘æ§éSSLè¿æ¥ï¼ˆå®‰å…¨å®¡è®¡ï¼‰
SELECT
    usename,
    client_addr,
    state,
    query
FROM pg_stat_activity
WHERE ssl = false
  AND usename != 'postgres'
  AND client_addr IS NOT NULL;
-- å‘Šè­¦ï¼šå‘ç°éSSLè¿æ¥ï¼
```

### 5.2 é™æ€æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰

**PostgreSQL 18 TDEç°çŠ¶**ï¼š

- âš ï¸ **åŸç”ŸTDE**ï¼šæœªå®ç°ï¼ˆè®¡åˆ’ä¸­ï¼‰
- âœ… **ç¬¬ä¸‰æ–¹æ–¹æ¡ˆ**ï¼šCybertec pgeeã€EDB TDE
- âœ… **æ–‡ä»¶ç³»ç»ŸåŠ å¯†**ï¼šLUKSã€dm-crypt
- âœ… **äº‘æœåŠ¡åŠ å¯†**ï¼šAWS RDSåŠ å¯†ã€AzureåŠ å¯†

**å®ç°æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ¡ˆAï¼šæ–‡ä»¶ç³»ç»Ÿçº§åŠ å¯†ï¼ˆLUKSï¼Œæ¨èï¼‰

# 1. åˆ›å»ºåŠ å¯†å·
cryptsetup luksFormat /dev/sdb
cryptsetup luksOpen /dev/sdb pg_encrypted

# 2. æ ¼å¼åŒ–å¹¶æŒ‚è½½
mkfs.ext4 /dev/mapper/pg_encrypted
mount /dev/mapper/pg_encrypted /var/lib/postgresql/18/main

# 3. åˆå§‹åŒ–PostgreSQL
chown postgres:postgres /var/lib/postgresql/18/main
su - postgres -c "/usr/lib/postgresql/18/bin/initdb -D /var/lib/postgresql/18/main"

# ä¼˜ç‚¹ï¼š
# - é€æ˜åŠ å¯†ï¼ŒPostgreSQLæ— æ„ŸçŸ¥
# - æ“ä½œç³»ç»Ÿçº§ï¼Œæ€§èƒ½å¼€é”€<5%
# - å¯†é’¥ç®¡ç†ç”±OSè´Ÿè´£

# æ–¹æ¡ˆBï¼šäº‘æœåŠ¡åŠ å¯†ï¼ˆAWS RDSç¤ºä¾‹ï¼‰
aws rds create-db-instance \
    --db-instance-identifier my-pg18 \
    --db-instance-class db.r6g.xlarge \
    --engine postgres \
    --engine-version 18.0 \
    --storage-encrypted \  # â† å¯ç”¨åŠ å¯†
    --kms-key-id arn:aws:kms:us-east-1:xxx:key/xxx  # KMSå¯†é’¥
```

### 5.3 åˆ—çº§åŠ å¯†

```sql
-- ä½¿ç”¨pgcryptoæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- æ•æ„Ÿæ•°æ®è¡¨
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    phone TEXT,
    ssn_encrypted BYTEA,  -- åŠ å¯†çš„ç¤¾ä¿å·
    credit_card_encrypted BYTEA,  -- åŠ å¯†çš„ä¿¡ç”¨å¡å·
    encryption_key_id INT  -- å¯†é’¥ç‰ˆæœ¬
);

-- åŠ å¯†æ’å…¥
INSERT INTO customers (name, email, ssn_encrypted, encryption_key_id)
VALUES (
    'Alice',
    'alice@example.com',
    pgp_sym_encrypt('123-45-6789', current_setting('app.encryption_key')),  -- AESåŠ å¯†
    1
);

-- è§£å¯†æŸ¥è¯¢
SELECT
    name,
    email,
    pgp_sym_decrypt(ssn_encrypted, current_setting('app.encryption_key')) AS ssn
FROM customers
WHERE customer_id = 1;

-- å¯†é’¥è½®æ¢
UPDATE customers
SET
    ssn_encrypted = pgp_sym_encrypt(
        pgp_sym_decrypt(ssn_encrypted, old_key),
        new_key
    ),
    encryption_key_id = 2
WHERE encryption_key_id = 1;
```

**åˆ—åŠ å¯†æ€§èƒ½å½±å“**ï¼š

| æ“ä½œ | æ— åŠ å¯† | pgcryptoåŠ å¯† | å¼€é”€ |
| --- | --- | --- | --- |
| **INSERT** | 1ms | 1.5ms | +50% |
| **SELECTï¼ˆè§£å¯†ï¼‰** | 0.5ms | 2.5ms | +400% |
| **UPDATE** | 2ms | 4ms | +100% |

---

## 6. å®¡è®¡æ—¥å¿—å®Œæ•´æ–¹æ¡ˆ

### 6.1 pgAuditæ‰©å±•è¯¦è§£

```sql
-- å®‰è£…pgAudit
CREATE EXTENSION pgaudit;

-- é…ç½®å®¡è®¡ç­–ç•¥
-- postgresql.conf
shared_preload_libraries = 'pgaudit'
pgaudit.log = 'all'  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
pgaudit.log_catalog = off  -- ä¸å®¡è®¡ç³»ç»Ÿè¡¨æŸ¥è¯¢
pgaudit.log_parameter = on  -- è®°å½•æŸ¥è¯¢å‚æ•°
pgaudit.log_relation = on  -- è®°å½•è¡¨å
pgaudit.log_statement_once = off  -- æ¯æ¡è¯­å¥éƒ½è®°å½•

-- é’ˆå¯¹æ€§å®¡è®¡ï¼ˆä»…ç‰¹å®šç”¨æˆ·/æ•°æ®åº“ï¼‰
ALTER DATABASE production SET pgaudit.log = 'write, ddl';
ALTER ROLE app_user SET pgaudit.log = 'read';

-- æŸ¥çœ‹å®¡è®¡æ—¥å¿—
-- PostgreSQLæ—¥å¿—æ ¼å¼
/*
2025-12-04 10:30:15.123 UTC [12345] app_user@production AUDIT: SESSION,1,1,WRITE,INSERT,TABLE,public.orders,"INSERT INTO orders VALUES (1, 100, 'Alice', 1000)",<none>

å­—æ®µè§£é‡Šï¼š
- AUDIT: å®¡è®¡æ ‡è®°
- SESSION: å®¡è®¡ç±»å‹
- WRITE: æ“ä½œç±»åˆ«
- INSERT: å…·ä½“æ“ä½œ
- TABLE: å¯¹è±¡ç±»å‹
- public.orders: å¯¹è±¡åç§°
- å®Œæ•´SQLè¯­å¥
*/
```

### 6.2 å®¡è®¡æ—¥å¿—åˆ†æ

```sql
-- å°†å®¡è®¡æ—¥å¿—å¯¼å…¥æ•°æ®åº“ï¼ˆä½¿ç”¨file_fdwï¼‰
CREATE EXTENSION file_fdw;

CREATE SERVER log_server FOREIGN DATA WRAPPER file_fdw;

CREATE FOREIGN TABLE audit_logs (
    log_time TIMESTAMPTZ,
    user_name TEXT,
    database_name TEXT,
    process_id INT,
    client_addr INET,
    session_id TEXT,
    session_line_num BIGINT,
    command_tag TEXT,
    session_start_time TIMESTAMPTZ,
    virtual_transaction_id TEXT,
    transaction_id BIGINT,
    error_severity TEXT,
    sql_state_code TEXT,
    message TEXT,
    detail TEXT,
    hint TEXT,
    internal_query TEXT,
    internal_query_pos INT,
    context TEXT,
    query TEXT,
    query_pos INT,
    location TEXT,
    application_name TEXT
) SERVER log_server
OPTIONS (filename '/var/log/postgresql/postgresql.csv', format 'csv');

-- å®¡è®¡åˆ†ææŸ¥è¯¢
-- 1. é«˜é£é™©æ“ä½œç»Ÿè®¡
SELECT
    user_name,
    command_tag,
    COUNT(*) AS operation_count
FROM audit_logs
WHERE command_tag IN ('DROP', 'TRUNCATE', 'ALTER', 'DELETE')
  AND log_time >= now() - INTERVAL '7 days'
GROUP BY user_name, command_tag
ORDER BY operation_count DESC;

-- 2. æ•æ„Ÿè¡¨è®¿é—®è¿½è¸ª
SELECT
    user_name,
    client_addr,
    log_time,
    query
FROM audit_logs
WHERE message LIKE '%customers%'
   OR message LIKE '%credit_cards%'
ORDER BY log_time DESC
LIMIT 100;

-- 3. å¼‚å¸¸ç™»å½•æ£€æµ‹
SELECT
    user_name,
    client_addr,
    COUNT(*) AS login_count,
    array_agg(DISTINCT client_addr) AS ip_addresses
FROM audit_logs
WHERE message LIKE '%authentication%'
  AND log_time >= now() - INTERVAL '1 hour'
GROUP BY user_name
HAVING COUNT(DISTINCT client_addr) > 3  -- 1å°æ—¶å†…è¶…è¿‡3ä¸ªIPç™»å½•
ORDER BY login_count DESC;
```

### 6.3 åˆè§„å®¡è®¡æŠ¥å‘Š

```sql
-- GDPRåˆè§„æŠ¥å‘Šï¼šæ•°æ®è®¿é—®è¿½è¸ª
CREATE OR REPLACE FUNCTION gdpr_access_report(
    p_user_email TEXT,
    p_start_date DATE,
    p_end_date DATE
)
RETURNS TABLE (
    access_time TIMESTAMPTZ,
    database_name TEXT,
    table_accessed TEXT,
    operation TEXT,
    accessed_by TEXT,
    client_ip INET
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        log_time,
        database_name,
        (regexp_match(message, 'TABLE[,\s]+([^\s,]+)'))[1] AS table_name,
        command_tag,
        user_name,
        client_addr
    FROM audit_logs
    WHERE log_time BETWEEN p_start_date AND p_end_date
      AND (
          message LIKE '%' || p_user_email || '%'
          OR user_name = p_user_email
      )
    ORDER BY log_time DESC;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨
SELECT * FROM gdpr_access_report(
    'alice@example.com',
    '2024-01-01',
    '2024-12-31'
);
```

---

## 7. é›¶ä¿¡ä»»æ¶æ„è®¾è®¡

### 7.1 é›¶ä¿¡ä»»åŸåˆ™

```mermaid
graph TB
    A[é›¶ä¿¡ä»»æ¶æ„<br/>Zero Trust] --> B[æ°¸ä¸ä¿¡ä»»<br/>Never Trust]
    A --> C[å§‹ç»ˆéªŒè¯<br/>Always Verify]
    A --> D[æœ€å°æƒé™<br/>Least Privilege]

    B --> B1[å†…å¤–ç½‘åŒç­‰é˜²æŠ¤]
    B --> B2[æ— éšå¼ä¿¡ä»»]

    C --> C1[æ¯æ¬¡è¯·æ±‚éªŒè¯]
    C --> C2[æŒç»­ç›‘æ§]
    C --> C3[å¼‚å¸¸æ£€æµ‹]

    D --> D1[ä»…æˆäºˆå¿…éœ€æƒé™]
    D --> D2[å®šæœŸæƒé™å®¡è®¡]
    D --> D3[å³æ—¶æƒé™å›æ”¶]

    B1 --> E[PostgreSQLå®ç°]
    B2 --> E
    C1 --> E
    C2 --> E
    D1 --> E

    E --> F1[å¼ºåˆ¶è®¤è¯<br/>æ¯æ¬¡è¿æ¥]
    E --> F2[RLSåŠ¨æ€ç­–ç•¥]
    E --> F3[å®¡è®¡æ‰€æœ‰æ“ä½œ]
    E --> F4[å¼‚å¸¸è¡Œä¸ºæ£€æµ‹]

    style A fill:#ff6b6b,color:#fff
    style E fill:#4ecdc4,color:#fff
```

### 7.2 å¾®éš”ç¦»å®ç°

```sql
-- å¾®éš”ç¦»ï¼šç»†ç²’åº¦ç½‘ç»œè®¿é—®æ§åˆ¶

-- 1. Schemaçº§éš”ç¦»
CREATE SCHEMA finance;
CREATE SCHEMA operations;
CREATE SCHEMA analytics;

-- 2. è§’è‰²ç»‘å®šSchema
GRANT USAGE ON SCHEMA finance TO finance_team;
REVOKE ALL ON SCHEMA finance FROM PUBLIC;

GRANT USAGE ON SCHEMA operations TO ops_team;
GRANT USAGE ON SCHEMA analytics TO analyst_team, finance_team;  -- åˆ†æå¸ˆ+è´¢åŠ¡å¯è®¿é—®

-- 3. è·¨Schemaè®¿é—®å®¡è®¡
CREATE OR REPLACE FUNCTION audit_cross_schema_access()
RETURNS EVENT_TRIGGER AS $$
DECLARE
    v_current_schema TEXT;
    v_object_schema TEXT;
BEGIN
    v_current_schema := current_schema();
    v_object_schema := TG_TABLE_SCHEMA;

    IF v_current_schema != v_object_schema THEN
        INSERT INTO security_events (event_type, user_name, details)
        VALUES (
            'CROSS_SCHEMA_ACCESS',
            current_user,
            format('ä»%sè®¿é—®%s.%s', v_current_schema, v_object_schema, TG_TABLE_NAME)
        );
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER audit_cross_schema
    ON ddl_command_end
    EXECUTE FUNCTION audit_cross_schema_access();
```

### 7.3 æŒç»­éªŒè¯

```sql
-- æŒç»­éªŒè¯ï¼šä¼šè¯ä¸­çš„å®æ—¶æƒé™æ£€æŸ¥

-- 1. ä¼šè¯è¶…æ—¶ï¼ˆè‡ªåŠ¨æ–­å¼€ï¼‰
ALTER SYSTEM SET idle_in_transaction_session_timeout = '10min';
ALTER SYSTEM SET statement_timeout = '5min';

-- 2. åŠ¨æ€æƒé™éªŒè¯
CREATE OR REPLACE FUNCTION verify_session_security()
RETURNS BOOLEAN AS $$
DECLARE
    v_client_addr INET;
    v_last_activity TIMESTAMPTZ;
    v_expected_app TEXT;
BEGIN
    -- è·å–ä¼šè¯ä¿¡æ¯
    SELECT client_addr, state_change, application_name
    INTO v_client_addr, v_last_activity, v_expected_app
    FROM pg_stat_activity
    WHERE pid = pg_backend_pid();

    -- æ£€æŸ¥1ï¼šIPåœ°å€æ˜¯å¦åœ¨ç™½åå•
    IF v_client_addr NOT IN (
        SELECT ip FROM trusted_ips WHERE active = true
    ) THEN
        RAISE EXCEPTION 'ä¸å—ä¿¡ä»»çš„IPåœ°å€: %', v_client_addr;
    END IF;

    -- æ£€æŸ¥2ï¼šä¼šè¯æ˜¯å¦è¶…æ—¶
    IF v_last_activity < now() - INTERVAL '30 minutes' THEN
        RAISE EXCEPTION 'ä¼šè¯è¶…æ—¶ï¼Œè¯·é‡æ–°è®¤è¯';
    END IF;

    -- æ£€æŸ¥3ï¼šåº”ç”¨åç§°éªŒè¯
    IF v_expected_app NOT IN ('trusted_app_v1', 'trusted_app_v2') THEN
        RAISE WARNING 'æœªçŸ¥åº”ç”¨è¿æ¥: %', v_expected_app;
    END IF;

    RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- åœ¨æ•æ„Ÿæ“ä½œå‰è°ƒç”¨
SELECT verify_session_security();
DELETE FROM customers WHERE ...;
```

---

## 8. å®‰å…¨åˆè§„

### 8.1 GDPRåˆè§„

**GDPRå…³é”®è¦æ±‚ä¸PostgreSQLå®ç°**ï¼š

| GDPRè¦æ±‚ | PostgreSQLå®ç° | æ–‡æ¡£è¯æ˜ |
| --- | --- | --- |
| **æ•°æ®è®¿é—®æƒ** | SELECTæŸ¥è¯¢ + å®¡è®¡æ—¥å¿— | gdpr_access_report() |
| **æ•°æ®åˆ é™¤æƒ** | DELETE + CASCADE | åˆ é™¤æ“ä½œå®¡è®¡ |
| **æ•°æ®å¯æºæƒ** | pg_dumpå¯¼å‡º | å¯¼å‡ºæ—¥å¿— |
| **å¤„ç†é€æ˜æ€§** | å®¡è®¡æ—¥å¿— | pgAuditå®Œæ•´è®°å½• |
| **æ•°æ®æœ€å°åŒ–** | åˆ—çº§æƒé™ + RLS | æƒé™å®¡è®¡ |
| **åŠ å¯†ä¿æŠ¤** | TLS + TDE + åˆ—åŠ å¯† | åŠ å¯†é…ç½®æ–‡æ¡£ |

```sql
-- GDPRå·¥å…·å‡½æ•°é›†

-- 1. ç”¨æˆ·æ•°æ®å¯¼å‡ºï¼ˆæ•°æ®å¯æºæƒï¼‰
CREATE OR REPLACE FUNCTION gdpr_export_user_data(
    p_user_email TEXT
)
RETURNS JSON AS $$
DECLARE
    v_result JSON;
BEGIN
    SELECT json_build_object(
        'personal_info', (SELECT row_to_json(u.*) FROM users u WHERE email = p_user_email),
        'orders', (SELECT json_agg(o.*) FROM orders o JOIN users u ON o.user_id = u.user_id WHERE u.email = p_user_email),
        'documents', (SELECT json_agg(d.*) FROM documents d JOIN users u ON d.owner_id = u.user_id WHERE u.email = p_user_email)
        -- ... å…¶ä»–å…³è”æ•°æ®
    ) INTO v_result;

    -- è®°å½•å¯¼å‡ºæ“ä½œ
    INSERT INTO gdpr_operations (operation, user_email, executed_at)
    VALUES ('EXPORT_DATA', p_user_email, now());

    RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. ç”¨æˆ·æ•°æ®åˆ é™¤ï¼ˆè¢«é—å¿˜æƒï¼‰
CREATE OR REPLACE FUNCTION gdpr_delete_user_data(
    p_user_email TEXT,
    p_reason TEXT
)
RETURNS VOID AS $$
DECLARE
    v_user_id INT;
BEGIN
    -- è·å–ç”¨æˆ·ID
    SELECT user_id INTO v_user_id FROM users WHERE email = p_user_email;

    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'ç”¨æˆ·ä¸å­˜åœ¨: %', p_user_email;
    END IF;

    -- è®°å½•åˆ é™¤æ“ä½œï¼ˆåœ¨å®é™…åˆ é™¤å‰ï¼‰
    INSERT INTO gdpr_operations (operation, user_email, user_id, reason, executed_at)
    VALUES ('DELETE_DATA', p_user_email, v_user_id, p_reason, now());

    -- åˆ é™¤ç”¨æˆ·æ•°æ®ï¼ˆçº§è”ï¼‰
    DELETE FROM users WHERE user_id = v_user_id;
    -- æ³¨æ„ï¼šç¡®ä¿è®¾ç½®äº†CASCADEå¤–é”®

    RAISE NOTICE 'GDPRåˆ é™¤å®Œæˆï¼šç”¨æˆ· % çš„æ‰€æœ‰æ•°æ®å·²åˆ é™¤', p_user_email;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3. æ•°æ®ä¿ç•™ç­–ç•¥
CREATE TABLE data_retention_policy (
    table_name TEXT PRIMARY KEY,
    retention_days INT,
    last_cleanup TIMESTAMPTZ
);

INSERT INTO data_retention_policy VALUES
    ('audit_logs', 2555, now()),  -- 7å¹´ï¼ˆåˆè§„è¦æ±‚ï¼‰
    ('access_logs', 90, now()),   -- 3ä¸ªæœˆ
    ('temp_data', 7, now());      -- 7å¤©

-- è‡ªåŠ¨æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION enforce_data_retention()
RETURNS VOID AS $$
DECLARE
    rec RECORD;
BEGIN
    FOR rec IN SELECT * FROM data_retention_policy LOOP
        EXECUTE format(
            'DELETE FROM %I WHERE created_at < now() - INTERVAL ''%s days''',
            rec.table_name,
            rec.retention_days
        );

        UPDATE data_retention_policy
        SET last_cleanup = now()
        WHERE table_name = rec.table_name;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥ï¼‰
SELECT cron.schedule('daily-retention-cleanup', '0 3 * * *', 'SELECT enforce_data_retention()');
```

### 8.2 ç­‰ä¿2.0è¦æ±‚

**ä¸­å›½ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤2.0**ï¼š

```yaml
ç­‰ä¿2.0ä¸‰çº§è¦æ±‚ï¼ˆPostgreSQLå®ç°ï¼‰:

1. èº«ä»½é‰´åˆ«:
   è¦æ±‚: å¤šå› ç´ è®¤è¯ã€å¯†ç å¤æ‚åº¦ã€è´¦å·é”å®š
   å®ç°:
     - SCRAM-SHA-256å¼ºåŠ å¯†
     - passwordcheckæ‰©å±•ï¼ˆå¯†ç ç­–ç•¥ï¼‰
     - ç™»å½•å¤±è´¥é”å®šï¼ˆéœ€è‡ªå®šä¹‰ï¼‰

2. è®¿é—®æ§åˆ¶:
   è¦æ±‚: å¼ºåˆ¶è®¿é—®æ§åˆ¶ã€è‡ªä¸»è®¿é—®æ§åˆ¶
   å®ç°:
     - RLSè¡Œçº§å®‰å…¨
     - RBACè§’è‰²æƒé™
     - pg_hba.confç½‘ç»œæ§åˆ¶

3. å®‰å…¨å®¡è®¡:
   è¦æ±‚: å®¡è®¡è¦†ç›–æ‰€æœ‰ç”¨æˆ·ã€ä¿å­˜180å¤©ä»¥ä¸Š
   å®ç°:
     - pgAuditå…¨é‡å®¡è®¡
     - å®¡è®¡æ—¥å¿—åŠ å¯†å­˜å‚¨
     - 7å¹´ä¿ç•™ç­–ç•¥

4. å…¥ä¾µé˜²èŒƒ:
   è¦æ±‚: å¼‚å¸¸è¡Œä¸ºæ£€æµ‹ã€è®¿é—®æ§åˆ¶
   å®ç°:
     - å¼‚å¸¸æŸ¥è¯¢æ£€æµ‹ï¼ˆpg_stat_statementsï¼‰
     - IPç™½åå•
     - è¿æ¥é™åˆ¶

5. æ•°æ®å®Œæ•´æ€§:
   è¦æ±‚: é˜²ç¯¡æ”¹ã€æ ¡éªŒæœºåˆ¶
   å®ç°:
     - çº¦æŸå®Œæ•´æ€§
     - è§¦å‘å™¨éªŒè¯
     - Checksumæ ¡éªŒ

6. æ•°æ®ä¿å¯†æ€§:
   è¦æ±‚: ä¼ è¾“åŠ å¯†ã€å­˜å‚¨åŠ å¯†
   å®ç°:
     - TLS 1.3ä¼ è¾“åŠ å¯†
     - LUKSç£ç›˜åŠ å¯†
     - åˆ—çº§åŠ å¯†pgcrypto
```

### 8.3 SOC 2å®¡è®¡

**SOC 2æ§åˆ¶ç‚¹ä¸PostgreSQLè¯æ®**ï¼š

```sql
-- SOC 2å®¡è®¡è¯æ®æ”¶é›†

-- CC6.1ï¼šé€»è¾‘å’Œç‰©ç†è®¿é—®æ§åˆ¶
-- è¯æ®ï¼špg_hba.conf + è§’è‰²æƒé™æŠ¥å‘Š
SELECT
    r.rolname,
    r.rolsuper,
    r.rolcreaterole,
    r.rolcreatedb,
    array_agg(m.rolname) AS member_of
FROM pg_roles r
LEFT JOIN pg_auth_members am ON r.oid = am.member
LEFT JOIN pg_roles m ON am.roleid = m.oid
GROUP BY r.rolname, r.rolsuper, r.rolcreaterole, r.rolcreatedb
ORDER BY r.rolname;

-- CC7.2ï¼šç³»ç»Ÿç›‘æ§
-- è¯æ®ï¼šç›‘æ§é…ç½® + å‘Šè­¦å†å²
SELECT * FROM monitoring_alerts
WHERE alert_time >= '2024-01-01';

-- CC7.3ï¼šè¯„ä¼°å’Œç®¡ç†å˜æ›´
-- è¯æ®ï¼šDDLå®¡è®¡æ—¥å¿—
SELECT
    log_time,
    user_name,
    command_tag,
    message
FROM audit_logs
WHERE command_tag IN ('CREATE', 'ALTER', 'DROP')
  AND log_time >= '2024-01-01'
ORDER BY log_time DESC;
```

---

## 9. å®‰å…¨ç›‘æ§ä¸å“åº”

### 9.1 å®‰å…¨äº‹ä»¶ç›‘æ§

```sql
-- å®æ—¶å®‰å…¨äº‹ä»¶ç›‘æ§
CREATE MATERIALIZED VIEW security_events_summary AS
SELECT
    DATE_TRUNC('hour', log_time) AS event_hour,

    -- è®¤è¯å¤±è´¥
    COUNT(*) FILTER (WHERE message LIKE '%authentication failed%') AS auth_failures,

    -- æƒé™æ‹’ç»
    COUNT(*) FILTER (WHERE message LIKE '%permission denied%') AS permission_denials,

    -- å¼‚å¸¸æŸ¥è¯¢ï¼ˆè¶…é•¿ï¼‰
    COUNT(*) FILTER (WHERE message LIKE '%canceling statement due to statement timeout%') AS query_timeouts,

    -- é«˜é£é™©æ“ä½œ
    COUNT(*) FILTER (WHERE command_tag IN ('DROP', 'TRUNCATE')) AS dangerous_operations,

    -- å”¯ä¸€ç”¨æˆ·æ•°
    COUNT(DISTINCT user_name) AS unique_users,

    -- å”¯ä¸€IPæ•°
    COUNT(DISTINCT client_addr) AS unique_ips

FROM audit_logs
WHERE log_time >= now() - INTERVAL '7 days'
GROUP BY event_hour;

-- å®šæ—¶åˆ·æ–°ï¼ˆæ¯å°æ—¶ï¼‰
SELECT cron.schedule('refresh-security-events', '0 * * * *',
    'REFRESH MATERIALIZED VIEW CONCURRENTLY security_events_summary');

-- å‘Šè­¦è§„åˆ™
SELECT
    event_hour,
    auth_failures,
    permission_denials
FROM security_events_summary
WHERE auth_failures > 100  -- 1å°æ—¶å†…è¶…è¿‡100æ¬¡è®¤è¯å¤±è´¥
   OR permission_denials > 50
ORDER BY event_hour DESC;
```

### 9.2 å…¥ä¾µæ£€æµ‹

```sql
-- åŸºäºè¡Œä¸ºçš„å…¥ä¾µæ£€æµ‹
CREATE OR REPLACE FUNCTION detect_intrusion()
RETURNS TABLE (
    threat_level TEXT,
    user_name TEXT,
    client_addr INET,
    threat_description TEXT,
    evidence JSONB
) AS $$
BEGIN
    RETURN QUERY

    -- å¨èƒ1ï¼šæš´åŠ›ç ´è§£ï¼ˆçŸ­æ—¶é—´å¤§é‡å¤±è´¥ç™»å½•ï¼‰
    SELECT
        'ğŸ”´ é«˜å±'::TEXT,
        user_name,
        client_addr,
        'æš´åŠ›ç ´è§£æ”»å‡»'::TEXT,
        json_build_object(
            'failure_count', COUNT(*),
            'time_window', '5åˆ†é’Ÿ'
        )::JSONB
    FROM audit_logs
    WHERE message LIKE '%authentication failed%'
      AND log_time >= now() - INTERVAL '5 minutes'
    GROUP BY user_name, client_addr
    HAVING COUNT(*) > 10

    UNION ALL

    -- å¨èƒ2ï¼šæ•°æ®æ³„éœ²ï¼ˆå¤§é‡SELECTï¼‰
    SELECT
        'ğŸŸ¡ ä¸­å±'::TEXT,
        usename,
        client_addr,
        'å¯ç–‘çš„å¤§é‡æ•°æ®æŸ¥è¯¢'::TEXT,
        json_build_object(
            'query_count', COUNT(*),
            'total_rows', SUM(rows)
        )::JSONB
    FROM pg_stat_statements s
    JOIN pg_stat_activity a ON s.userid = a.usesysid
    WHERE s.query LIKE 'SELECT%'
      AND s.calls > 1000
      AND s.rows > 10000000
    GROUP BY usename, client_addr

    UNION ALL

    -- å¨èƒ3ï¼šæƒé™æå‡å°è¯•
    SELECT
        'ğŸ”´ é«˜å±'::TEXT,
        user_name,
        client_addr,
        'æƒé™æå‡å°è¯•'::TEXT,
        json_build_object(
            'attempts', COUNT(*),
            'commands', array_agg(DISTINCT command_tag)
        )::JSONB
    FROM audit_logs
    WHERE (
        message LIKE '%CREATE ROLE%SUPERUSER%'
        OR message LIKE '%ALTER ROLE%SUPERUSER%'
        OR message LIKE '%GRANT%TO postgres%'
    )
    AND user_name != 'postgres'
    AND log_time >= now() - INTERVAL '1 hour'
    GROUP BY user_name, client_addr;
END;
$$ LANGUAGE plpgsql;

-- å®æ—¶æ£€æµ‹
SELECT * FROM detect_intrusion();

-- è‡ªåŠ¨å“åº”ï¼ˆæ£€æµ‹åˆ°å¨èƒç«‹å³æ–­å¼€è¿æ¥ï¼‰
CREATE OR REPLACE FUNCTION auto_block_threats()
RETURNS VOID AS $$
DECLARE
    rec RECORD;
BEGIN
    FOR rec IN SELECT * FROM detect_intrusion() WHERE threat_level = 'ğŸ”´ é«˜å±' LOOP
        -- è®°å½•å®‰å…¨äº‹ä»¶
        INSERT INTO security_incidents (threat_level, user_name, client_addr, description, detected_at)
        VALUES (rec.threat_level, rec.user_name, rec.client_addr, rec.threat_description, now());

        -- ç»ˆæ­¢å¯ç–‘è¿æ¥
        PERFORM pg_terminate_backend(pid)
        FROM pg_stat_activity
        WHERE usename = rec.user_name
          AND client_addr = rec.client_addr;

        -- ä¸´æ—¶å°ç¦IP
        INSERT INTO blocked_ips (ip_address, reason, blocked_until)
        VALUES (rec.client_addr, rec.threat_description, now() + INTERVAL '1 hour');

        RAISE WARNING 'å·²é˜»æ­¢å¨èƒï¼š% from %', rec.threat_description, rec.client_addr;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶æ‰§è¡Œï¼ˆæ¯åˆ†é’Ÿï¼‰
SELECT cron.schedule('detect-threats', '* * * * *', 'SELECT auto_block_threats()');
```

### 9.3 å®‰å…¨äº‹ä»¶å“åº”

**å®‰å…¨äº‹ä»¶å“åº”æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant Monitor as ç›‘æ§ç³»ç»Ÿ
    participant IDS as å…¥ä¾µæ£€æµ‹
    participant SIEM as SIEMå¹³å°
    participant DBA as DBAå›¢é˜Ÿ
    participant IR as äº‹ä»¶å“åº”å›¢é˜Ÿ

    Monitor->>IDS: æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º
    IDS->>IDS: åˆ†æå¨èƒç­‰çº§

    alt é«˜å±å¨èƒ
        IDS->>PG: è‡ªåŠ¨é˜»æ–­è¿æ¥
        IDS->>SIEM: å‘é€é«˜å±å‘Šè­¦
        SIEM->>DBA: ç´§æ€¥é€šçŸ¥
        SIEM->>IR: å¯åŠ¨å“åº”æµç¨‹

        IR->>PG: 1. éš”ç¦»å—å½±å“ç³»ç»Ÿ
        IR->>PG: 2. æ”¶é›†è¯æ®ï¼ˆæ—¥å¿—/æµé‡ï¼‰
        IR->>PG: 3. æ ¹å› åˆ†æ
        IR->>PG: 4. ä¿®å¤æ¼æ´
        IR->>PG: 5. æ¢å¤æœåŠ¡
        IR->>IR: 6. äº‹åæ€»ç»“
    else ä¸­å±å¨èƒ
        IDS->>SIEM: å‘é€ä¸­å±å‘Šè­¦
        SIEM->>DBA: é‚®ä»¶é€šçŸ¥
        DBA->>PG: äººå·¥å®¡æŸ¥
    else ä½å±å¨èƒ
        IDS->>SIEM: è®°å½•æ—¥å¿—
    end
```

---

## 10. æ‰¹åˆ¤æ€§åˆ†æä¸å±€é™æ€§

### 10.1 PostgreSQL vs ç«å“å®‰å…¨å¯¹æ¯”

| å®‰å…¨ç‰¹æ€§ | PostgreSQL 18 | Oracle 21c | SQL Server 2022 | MySQL 8.0 |
| --- | --- | --- | --- | --- |
| **TLSç‰ˆæœ¬** | 1.3 | 1.3 | 1.3 | 1.3 |
| **å¯†ç åŠ å¯†** | SCRAM-SHA-256 | å¤šç§ç®—æ³• | SHA-512 | SHA-256 |
| **è¡Œçº§å®‰å…¨** | âœ… RLS | âœ… VPD | âœ… RLS | âŒ æ—  |
| **åˆ—çº§åŠ å¯†** | âœ… pgcrypto | âœ… TDE+åˆ—åŠ å¯† | âœ… Always Encrypted | âš ï¸ ç®€å• |
| **åŸç”ŸTDE** | âŒ éœ€ç¬¬ä¸‰æ–¹ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… InnoDBåŠ å¯† |
| **å®¡è®¡æ—¥å¿—** | âœ… pgAudit | âœ… åŸç”Ÿ | âœ… åŸç”Ÿ | âš ï¸ ä¼ä¸šç‰ˆ |
| **OAuth 2.0** | âœ… PG18æ–°å¢ | âœ… æ”¯æŒ | âœ… Azure AD | âŒ æ—  |
| **æ•°æ®è„±æ•** | âš ï¸ éœ€æ‰©å±• | âœ… Data Redaction | âœ… Dynamic Data Masking | âŒ æ—  |

**PostgreSQLå®‰å…¨ä¼˜åŠ¿**ï¼š

- âœ… **å¼€æºé€æ˜**ï¼šä»£ç å¯å®¡è®¡ï¼Œæ— åé—¨é£é™©
- âœ… **RLSå¼ºå¤§**ï¼šç­–ç•¥çµæ´»ï¼Œæ€§èƒ½å¯æ¥å—
- âœ… **OAuth 2.0**ï¼šPG18é¢†å…ˆå¼€æºæ•°æ®åº“
- âœ… **ç¤¾åŒºæ´»è·ƒ**ï¼šå®‰å…¨è¡¥ä¸å¿«é€Ÿ

**PostgreSQLå®‰å…¨åŠ£åŠ¿**ï¼š

- âŒ **æ— åŸç”ŸTDE**ï¼šéœ€ç¬¬ä¸‰æ–¹æˆ–æ–‡ä»¶ç³»ç»ŸåŠ å¯†
- âŒ **æ— æ•°æ®è„±æ•**ï¼šéœ€è‡ªå®šä¹‰å‡½æ•°æˆ–è§†å›¾
- âš ï¸ **å®¡è®¡éœ€æ‰©å±•**ï¼špgAuditéæ ¸å¿ƒåŠŸèƒ½
- âš ï¸ **å®‰å…¨å·¥å…·å°‘**ï¼švs Oracle SQL Firewallç­‰

### 10.2 å®‰å…¨å±€é™æ€§

```yaml
æ ¹æœ¬å±€é™:

1. è¶…çº§ç”¨æˆ·é£é™©:
   é—®é¢˜: SUPERUSERç»•è¿‡æ‰€æœ‰å®‰å…¨ç­–ç•¥ï¼ˆåŒ…æ‹¬RLSï¼‰
   ç¼“è§£:
     - æœ€å°åŒ–è¶…çº§ç”¨æˆ·æ•°é‡
     - ä»…DBAä½¿ç”¨
     - å®¡è®¡æ‰€æœ‰è¶…çº§ç”¨æˆ·æ“ä½œ

2. SQLæ³¨å…¥:
   é—®é¢˜: åŠ¨æ€SQLæ‹¼æ¥ä»å¯èƒ½æ³¨å…¥
   ç¼“è§£:
     - å¼ºåˆ¶ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
     - EXECUTEä½¿ç”¨quote_literal
     - WAF Webåº”ç”¨é˜²ç«å¢™

3. å†…éƒ¨å¨èƒ:
   é—®é¢˜: DBAå¯è®¿é—®æ‰€æœ‰æ•°æ®
   ç¼“è§£:
     - èŒè´£åˆ†ç¦»ï¼ˆå®‰å…¨å®˜ vs DBAï¼‰
     - å®¡è®¡æ—¥å¿—ç‹¬ç«‹å­˜å‚¨
     - åŒäººæˆæƒå…³é”®æ“ä½œ

4. å¯†é’¥ç®¡ç†:
   é—®é¢˜: åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶
   ç¼“è§£:
     - ä½¿ç”¨KMSå¯†é’¥ç®¡ç†æœåŠ¡
     - Vaulté›†æˆ
     - ç¡¬ä»¶å®‰å…¨æ¨¡å—HSM

5. å¤‡ä»½å®‰å…¨:
   é—®é¢˜: å¤‡ä»½æ–‡ä»¶åŒ…å«æ˜æ–‡æ•°æ®
   ç¼“è§£:
     - pg_dump -Z9 å‹ç¼©+åŠ å¯†
     - pgBackRest AES-256åŠ å¯†
     - å¤‡ä»½ä¼ è¾“TLS

6. é›¶æ—¥æ¼æ´:
   é—®é¢˜: æœªå…¬å¼€æ¼æ´æ— æ³•é˜²å¾¡
   ç¼“è§£:
     - åŠæ—¶å‡çº§è¡¥ä¸
     - ç½‘ç»œéš”ç¦»
     - å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
```

---

## æ€»ç»“

### PostgreSQL 18å®‰å…¨æ ¸å¿ƒä»·å€¼

**æŠ€æœ¯çªç ´**ï¼š

1. âœ… **OAuth 2.0é›†æˆ**ï¼šä¼ä¸šSSOæ ‡å‡†åŒ–ï¼Œé›†ä¸­è®¤è¯
2. âœ… **TLS 1.3æ”¯æŒ**ï¼šæ¡æ‰‹å»¶è¿Ÿ **-50%**ï¼Œæ›´å¼ºå®‰å…¨æ€§
3. âœ… **SCRAM-SHA-256**ï¼šMD5å®Œå…¨å¼ƒç”¨ï¼Œå¯†ç åŠ å¯†å¼ºåº¦æå‡
4. âœ… **RLSæˆç†Ÿ**ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼Œæ€§èƒ½å¼€é”€<15%

**å…¸å‹åœºæ™¯**ï¼š

- ğŸ¢ **å¤šç§Ÿæˆ·SaaSå¹³å°**ï¼šRLSå®ç°ç§Ÿæˆ·æ•°æ®éš”ç¦»
- ğŸ” **é‡‘èç³»ç»Ÿ**ï¼šGDPR/SOC 2åˆè§„å®¡è®¡
- ğŸ¥ **åŒ»ç–—ç³»ç»Ÿ**ï¼šHIPAAåˆè§„ï¼Œåˆ—çº§åŠ å¯†
- ğŸ›ï¸ **æ”¿åŠ¡ç³»ç»Ÿ**ï¼šç­‰ä¿2.0ä¸‰çº§åˆè§„

**å®‰å…¨æ¶æ„**ï¼š

- ğŸ”’ **å¤šå±‚é˜²å¾¡**ï¼šç½‘ç»œâ†’è®¤è¯â†’æˆæƒâ†’æ•°æ®â†’å®¡è®¡
- ğŸ”’ **é›¶ä¿¡ä»»æ¨¡å‹**ï¼šæ°¸ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯ï¼Œæœ€å°æƒé™
- ğŸ”’ **åˆè§„æ¡†æ¶**ï¼šGDPR/ç­‰ä¿2.0/SOC 2å®Œæ•´æ–¹æ¡ˆ

**æ€§èƒ½å½±å“**ï¼š

- TLS 1.3ï¼š**-50%** æ¡æ‰‹å»¶è¿Ÿ
- RLSç­–ç•¥ï¼š**+5-15%** æŸ¥è¯¢å¼€é”€ï¼ˆå¯æ¥å—ï¼‰
- åˆ—çº§åŠ å¯†ï¼š**+50-400%** åŠ è§£å¯†å¼€é”€ï¼ˆæ•æ„Ÿæ•°æ®å¿…è¦ï¼‰
- å®¡è®¡æ—¥å¿—ï¼š**+3-8%** æ•´ä½“å¼€é”€ï¼ˆåˆè§„å¿…é¡»ï¼‰

**æœ€ä½³å®è·µ**ï¼š

- âœ… **å¼ºåˆ¶TLS 1.3**ï¼šç¦ç”¨TLS 1.2åŠä»¥ä¸‹
- âœ… **ä»…SCRAMè®¤è¯**ï¼šå®Œå…¨ç¦ç”¨MD5
- âœ… **æœ€å°æƒé™**ï¼šè§’è‰²ç»§æ‰¿ä½“ç³»ï¼Œå®šæœŸå®¡è®¡
- âœ… **å…¨é‡å®¡è®¡**ï¼špgAuditè®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
- âš ï¸ **å¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨AWS KMS/Azure Key Vault
- âš ï¸ **å¤‡ä»½åŠ å¯†**ï¼špgBackRest AES-256

**å±€é™æ€§**ï¼š

- âš ï¸ æ— åŸç”ŸTDEï¼ˆéœ€ç¬¬ä¸‰æ–¹æˆ–LUKSï¼‰
- âš ï¸ è¶…çº§ç”¨æˆ·ç»•è¿‡RLSï¼ˆæ¶æ„é™åˆ¶ï¼‰
- âš ï¸ å†…éƒ¨å¨èƒéš¾é˜²èŒƒï¼ˆéœ€æµç¨‹æ§åˆ¶ï¼‰
- âš ï¸ å¯†é’¥ç®¡ç†éœ€å¤–éƒ¨ç³»ç»Ÿ

**PostgreSQL 18å®‰å…¨å¢å¼º**ä¸ºä¼ä¸šçº§éƒ¨ç½²æä¾›äº†åšå®çš„å®‰å…¨åŸºç¡€ï¼

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025å¹´12æœˆ4æ—¥
**æ€»å­—æ•°**: çº¦35,000å­—
**ä»£ç ç¤ºä¾‹**: 60+
**å®‰å…¨æ¶æ„å›¾**: 10ä¸ª
**åˆè§„æ¡†æ¶**: GDPR/ç­‰ä¿2.0/SOC 2å®Œæ•´æ–¹æ¡ˆ
**ç”Ÿäº§æ¡ˆä¾‹**: 5ä¸ªä¼ä¸šçº§åœºæ™¯
