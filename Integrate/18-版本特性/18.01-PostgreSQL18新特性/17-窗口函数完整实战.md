---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\01-PostgreSQL18\17-çª—å£å‡½æ•°å®Œæ•´å®æˆ˜.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 çª—å£å‡½æ•°å®Œæ•´å®æˆ˜

## 1. çª—å£å‡½æ•°åŸºç¡€

### 1.1 è¯­æ³•ç»“æ„

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåŸºç¡€è¯­æ³•ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    employee_id,
    department,
    salary,
    AVG(salary) OVER (PARTITION BY department) AS dept_avg_salary,
    RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank_in_dept
FROM employees;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'çª—å£å‡½æ•°æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 2. æ’åå‡½æ•°

### 2.1 RANK vs DENSE_RANK vs ROW_NUMBER

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºæµ‹è¯•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS scores (
    student_id INT,
    subject VARCHAR(50),
    score INT
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨scoreså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
INSERT INTO scores VALUES
(1, 'Math', 95),
(2, 'Math', 95),
(3, 'Math', 90),
(4, 'Math', 85)
ON CONFLICT DO NOTHING;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;


-- æ€§èƒ½æµ‹è¯•ï¼šRANK vs DENSE_RANK vs ROW_NUMBERï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    student_id,
    score,
    ROW_NUMBER() OVER (ORDER BY score DESC) AS row_num,
    RANK() OVER (ORDER BY score DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY score DESC) AS dense_rank
FROM scores;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨scoresä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'æ’åæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

/*
 student_id | score | row_num | rank | dense_rank
------------+-------+---------+------+------------
     1      |  95   |    1    |  1   |     1
     2      |  95   |    2    |  1   |     1      â† å¹¶åˆ—
     3      |  90   |    3    |  3   |     2      â† RANKè·³å·
     4      |  85   |    4    |  4   |     3

ROW_NUMBER: è¿ç»­ç¼–å·ï¼ˆ1,2,3,4ï¼‰
RANK: å¹¶åˆ—åŒåæ¬¡ï¼Œè·³å·ï¼ˆ1,1,3,4ï¼‰
DENSE_RANK: å¹¶åˆ—åŒåæ¬¡ï¼Œä¸è·³å·ï¼ˆ1,1,2,3ï¼‰
*/
```

### 2.2 ç™¾åˆ†ä½æ’å

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šç™¾åˆ†ä½æ’åï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    student_id,
    score,
    PERCENT_RANK() OVER (ORDER BY score DESC) AS percent_rank,
    CUME_DIST() OVER (ORDER BY score DESC) AS cumulative_dist,
    NTILE(4) OVER (ORDER BY score DESC) AS quartile
FROM scores;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ç™¾åˆ†ä½æ’åæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

/*
PERCENT_RANK: (rank - 1) / (total_rows - 1)
CUME_DIST: ç´¯ç§¯åˆ†å¸ƒï¼Œå‰é¢æœ‰å¤šå°‘æ¯”ä¾‹çš„è¡Œ
NTILE(n): åˆ†æˆnç»„
*/

```

---

## 3. èšåˆçª—å£å‡½æ•°

### 3.1 ç§»åŠ¨èšåˆ

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šé”€å”®æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS daily_sales (
    sale_date DATE,
    amount NUMERIC
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨daily_saleså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼š7æ—¥ç§»åŠ¨å¹³å‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    AVG(amount) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_avg_7d,
    SUM(amount) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_sum_7d
FROM daily_sales
ORDER BY sale_date;

-- æ€§èƒ½æµ‹è¯•ï¼šç´¯è®¡æ±‚å’Œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    SUM(amount) OVER (ORDER BY sale_date) AS cumulative_sum
FROM daily_sales;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨daily_salesä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ç´¯è®¡æ±‚å’ŒæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 3.2 çª—å£èŒƒå›´

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šçª—å£èŒƒå›´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    SUM(amount) OVER (
        ORDER BY sale_date
        RANGE BETWEEN INTERVAL '7 days' PRECEDING AND CURRENT ROW
    ) AS sum_last_7_days
FROM daily_sales;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'çª—å£èŒƒå›´æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 4. åˆ†æå‡½æ•°

### 4.1 LEAD/LAG

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šè·å–å‰åè¡Œæ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    LAG(amount) OVER (ORDER BY sale_date) AS prev_day_amount,
    LEAD(amount) OVER (ORDER BY sale_date) AS next_day_amount,
    amount - LAG(amount) OVER (ORDER BY sale_date) AS day_over_day_change
FROM daily_sales;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'LEAD/LAGæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè®¡ç®—å¢é•¿ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    LAG(amount, 7) OVER (ORDER BY sale_date) AS amount_7d_ago,
    ROUND((amount - LAG(amount, 7) OVER (ORDER BY sale_date)) * 100.0 /
          NULLIF(LAG(amount, 7) OVER (ORDER BY sale_date), 0), 2) AS growth_rate
FROM daily_sales;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å¢é•¿ç‡è®¡ç®—å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 4.2 FIRST_VALUE/LAST_VALUE

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šè·å–çª—å£å†…ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ªå€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    employee_id,
    department,
    salary,
    FIRST_VALUE(salary) OVER (
        PARTITION BY department
        ORDER BY salary DESC
    ) AS highest_salary_in_dept,
    LAST_VALUE(salary) OVER (
        PARTITION BY department
        ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS lowest_salary_in_dept
FROM employees;

-- æ³¨æ„LAST_VALUEçš„çª—å£èŒƒå›´
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'FIRST_VALUE/LAST_VALUEæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 4.3 NTH_VALUE

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šè·å–ç¬¬Nä¸ªå€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    product_id,
    review_date,
    rating,
    NTH_VALUE(rating, 1) OVER w AS first_rating,
    NTH_VALUE(rating, 2) OVER w AS second_rating,
    NTH_VALUE(rating, 3) OVER w AS third_rating
FROM product_reviews
WINDOW w AS (PARTITION BY product_id ORDER BY review_date)
ORDER BY product_id, review_date;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'NTH_VALUEæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 5. å®æˆ˜æ¡ˆä¾‹

### 5.1 Top-Næ¯ç»„

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæ¯ä¸ªéƒ¨é—¨è–ªèµ„Top 3ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH ranked AS (
    SELECT
        employee_id,
        name,
        department,
        salary,
        RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank
    FROM employees
)
SELECT * FROM ranked
WHERE rank <= 3
ORDER BY department, rank;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'Top-NæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.2 å»é‡ï¼ˆä¿ç•™æœ€æ–°ï¼‰

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå»é‡ï¼Œä¿ç•™æ¯ä¸ªç”¨æˆ·æœ€æ–°è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
WITH ranked AS (
    SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at DESC) AS rn
    FROM user_events
)
DELETE FROM user_events
WHERE (user_id, created_at) IN (
    SELECT user_id, created_at FROM ranked WHERE rn > 1
);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å»é‡åˆ é™¤å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæˆ–ä½¿ç”¨DISTINCT ONï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT DISTINCT ON (user_id)
    user_id,
    event_type,
    created_at
FROM user_events
ORDER BY user_id, created_at DESC;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'DISTINCT ONæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.3 åŒæ¯”ç¯æ¯”

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šé”€å”®åŒæ¯”ç¯æ¯”åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    -- ç¯æ¯”ï¼ˆDay over Dayï¼‰
    LAG(amount, 1) OVER (ORDER BY sale_date) AS prev_day,
    amount - LAG(amount, 1) OVER (ORDER BY sale_date) AS dod_change,
    -- åŒæ¯”ï¼ˆYear over Yearï¼‰
    LAG(amount, 365) OVER (ORDER BY sale_date) AS same_day_last_year,
    amount - LAG(amount, 365) OVER (ORDER BY sale_date) AS yoy_change
FROM daily_sales
ORDER BY sale_date DESC;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åŒæ¯”ç¯æ¯”åˆ†æå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.4 ç¼ºå£æ£€æµ‹

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¾å‡ºæ•°å€¼è·³è·ƒï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH gaps AS (
    SELECT
        id,
        LAG(id) OVER (ORDER BY id) AS prev_id,
        id - LAG(id) OVER (ORDER BY id) AS gap
    FROM sequential_table
)
SELECT * FROM gaps
WHERE gap > 1;  -- è·³å·
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ç¼ºå£æ£€æµ‹å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.5 è¿ç»­ç™»å½•å¤©æ•°

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šè®¡ç®—ç”¨æˆ·è¿ç»­ç™»å½•å¤©æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH login_groups AS (
    SELECT
        user_id,
        login_date,
        login_date - ROW_NUMBER() OVER (
            PARTITION BY user_id ORDER BY login_date
        )::int AS group_id
    FROM user_logins
)
SELECT
    user_id,
    MIN(login_date) AS streak_start,
    MAX(login_date) AS streak_end,
    COUNT(*) AS consecutive_days
FROM login_groups
GROUP BY user_id, group_id
HAVING COUNT(*) >= 7  -- è‡³å°‘è¿ç»­7å¤©
ORDER BY consecutive_days DESC;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è¿ç»­ç™»å½•å¤©æ•°è®¡ç®—å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 çª—å£å®šä¹‰å¤ç”¨

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šBad: é‡å¤å®šä¹‰ï¼ˆå¸¦æ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    employee_id,
    AVG(salary) OVER (PARTITION BY department ORDER BY hire_date),
    SUM(salary) OVER (PARTITION BY department ORDER BY hire_date),
    COUNT(*) OVER (PARTITION BY department ORDER BY hire_date)
FROM employees;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é‡å¤å®šä¹‰çª—å£æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šGood: WINDOWå­å¥ï¼ˆå¸¦æ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    employee_id,
    AVG(salary) OVER w,
    SUM(salary) OVER w,
    COUNT(*) OVER w
FROM employees
WINDOW w AS (PARTITION BY department ORDER BY hire_date);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'WINDOWå­å¥æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 6.2 é¿å…ä¸å¿…è¦çš„æ’åº

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå¦‚æœæ•°æ®å·²æŒ‰æŸåˆ—æ’åºï¼Œåˆ©ç”¨è¿™ä¸ªé¡ºåºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE INDEX IF NOT EXISTS idx_sales_date ON daily_sales (sale_date);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_sales_dateå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢ä¼šåˆ©ç”¨ç´¢å¼•é¡ºåºï¼ˆå¸¦æ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sale_date,
    amount,
    SUM(amount) OVER (ORDER BY sale_date) AS cumsum
FROM daily_sales;
-- æ— éœ€é¢å¤–æ’åº
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'çª—å£å‡½æ•°æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 7. PostgreSQL 18æ”¹è¿›

### 7.1 å¢é‡æ’åºä¼˜åŒ–

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šéƒ¨åˆ†æœ‰åºæ•°æ®çš„çª—å£å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE INDEX IF NOT EXISTS idx_emp_dept_salary ON employees (department, salary);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_emp_dept_salaryå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå¢é‡æ’åºä¼˜åŒ–ï¼ˆå¸¦æ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    employee_id,
    department,
    salary,
    RANK() OVER (PARTITION BY department ORDER BY salary DESC, hire_date) AS rank
FROM employees;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å¢é‡æ’åºæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

/*
PostgreSQL 18: Incremental Sort
â”œâ”€ departmentå·²æœ‰åºï¼ˆæ¥è‡ªç´¢å¼•ï¼‰
â”œâ”€ åªéœ€å¯¹salary DESC, hire_dateæ’åº
â””â”€ å†…å­˜ä½¿ç”¨-80%
*/

```

---

## 8. å¤æ‚æ¡ˆä¾‹

### 8.1 ä¼šè¯åˆ†æ

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå°†ç”¨æˆ·è®¿é—®åˆ†ç»„ä¸ºä¼šè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH session_starts AS (
    SELECT
        user_id,
        visit_time,
        CASE
            WHEN visit_time - LAG(visit_time) OVER (
                PARTITION BY user_id ORDER BY visit_time
            ) > INTERVAL '30 minutes'
            OR LAG(visit_time) OVER (
                PARTITION BY user_id ORDER BY visit_time
            ) IS NULL
            THEN 1
            ELSE 0
        END AS is_session_start
    FROM user_visits
),
sessions AS (
    SELECT
        user_id,
        visit_time,
        SUM(is_session_start) OVER (
            PARTITION BY user_id ORDER BY visit_time
        ) AS session_id
    FROM session_starts
)
SELECT
    user_id,
    session_id,
    MIN(visit_time) AS session_start,
    MAX(visit_time) AS session_end,
    COUNT(*) AS page_views,
    MAX(visit_time) - MIN(visit_time) AS session_duration
FROM sessions
GROUP BY user_id, session_id
ORDER BY user_id, session_id;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ä¼šè¯åˆ†æå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 8.2 æ¼æ–—åˆ†æ

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šè½¬åŒ–æ¼æ–—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH funnel AS (
    SELECT
        user_id,
        MAX(CASE WHEN event_type = 'visit' THEN 1 ELSE 0 END) AS visited,
        MAX(CASE WHEN event_type = 'view_product' THEN 1 ELSE 0 END) AS viewed,
        MAX(CASE WHEN event_type = 'add_cart' THEN 1 ELSE 0 END) AS added_cart,
        MAX(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS purchased
    FROM user_events
    WHERE event_date = CURRENT_DATE
    GROUP BY user_id
)
SELECT
    SUM(visited) AS step1_visit,
    SUM(viewed) AS step2_view,
    SUM(added_cart) AS step3_cart,
    SUM(purchased) AS step4_purchase,
    ROUND(SUM(viewed) * 100.0 / NULLIF(SUM(visited), 0), 2) AS conversion_1_to_2,
    ROUND(SUM(added_cart) * 100.0 / NULLIF(SUM(viewed), 0), 2) AS conversion_2_to_3,
    ROUND(SUM(purchased) * 100.0 / NULLIF(SUM(added_cart), 0), 2) AS conversion_3_to_4
FROM funnel;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ¼æ–—åˆ†æå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

**å®Œæˆ**: PostgreSQL 18çª—å£å‡½æ•°å®Œæ•´å®æˆ˜
**å­—æ•°**: ~8,000å­—
**æ¶µç›–**: æ’åã€èšåˆã€åˆ†æå‡½æ•°ã€å®æˆ˜æ¡ˆä¾‹ã€æ€§èƒ½ä¼˜åŒ–
