---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\01-PostgreSQL18\24-å…¨æ–‡æ£€ç´¢æ·±åº¦å®æˆ˜.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å…¨æ–‡æ£€ç´¢æ·±åº¦å®æˆ˜

## 1. å…¨æ–‡æ£€ç´¢åŸºç¡€

### 1.1 tsvectorä¸tsquery

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæ–‡æœ¬è½¬å‘é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsvector('english', 'PostgreSQL is a powerful database');
-- ç»“æœ: 'databas':5 'postgresql':1 'power':4
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ–‡æœ¬è½¬å‘é‡å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsquery('english', 'postgresql & database');
-- ç»“æœ: 'postgresql' & 'databas'
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šåŒ¹é…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsvector('english', 'PostgreSQL is powerful') @@
       to_tsquery('english', 'postgresql & powerful');
-- ç»“æœ: true
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å…¨æ–‡æ£€ç´¢åŒ¹é…å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 1.2 ä¸­æ–‡åˆ†è¯

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå®‰è£…zhparserï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE EXTENSION IF NOT EXISTS zhparser;
COMMIT;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'æ‰©å±•zhparserå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºä¸­æ–‡é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TEXT SEARCH CONFIGURATION IF NOT EXISTS chinese (PARSER = zhparser);
ALTER TEXT SEARCH CONFIGURATION chinese ADD MAPPING FOR n,v,a,i,e,l WITH simple;
COMMIT;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE NOTICE 'ä¸­æ–‡é…ç½®å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºä¸­æ–‡é…ç½®å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¸­æ–‡åˆ†è¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsvector('chinese', 'æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ');
-- ç»“æœ: 'æ•°æ®åº“':1 'ç®¡ç†':2 'ç³»ç»Ÿ':3
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ä¸­æ–‡åˆ†è¯å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¸­æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsvector('chinese', 'PostgreSQLæ˜¯å¼ºå¤§çš„æ•°æ®åº“') @@
       to_tsquery('chinese', 'æ•°æ®åº“');
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ä¸­æ–‡æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 2. å…¨æ–‡ç´¢å¼•

### 2.1 GINç´¢å¼•

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåˆ›å»ºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS documents (
    doc_id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    search_vector tsvector
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨documentså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šç”Ÿæˆæœç´¢å‘é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
UPDATE documents
SET search_vector =
    setweight(to_tsvector('english', COALESCE(title, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(content, '')), 'B');
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'ç”Ÿæˆæœç´¢å‘é‡å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šGINç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE INDEX IF NOT EXISTS idx_search_vector ON documents USING gin(search_vector);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_search_vectorå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè‡ªåŠ¨æ›´æ–°è§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(NEW.content, '')), 'B');
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_search_vector ON documents;
CREATE TRIGGER trg_search_vector
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION update_search_vector();
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 3. ç›¸å…³æ€§æ’åº

### 3.1 ts_rankå‡½æ•°

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåŸºç¡€æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    doc_id,
    title,
    ts_rank(search_vector, query) AS rank
FROM documents,
     to_tsquery('english', 'postgresql & database') query
WHERE search_vector @@ query
ORDER BY rank DESC
LIMIT 20;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åŸºç¡€æ’åºæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šts_rank_cdï¼ˆè€ƒè™‘è¦†ç›–å¯†åº¦ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    doc_id,
    title,
    ts_rank_cd(search_vector, query) AS rank
FROM documents,
     to_tsquery('english', 'postgresql & database') query
WHERE search_vector @@ query
ORDER BY rank DESC;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ts_rank_cdæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè‡ªå®šä¹‰æƒé‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    doc_id,
    title,
    ts_rank(
        search_vector,
        query,
        1  -- å½’ä¸€åŒ–æ–¹æ³•
    ) AS rank
FROM documents,
     to_tsquery('english', 'postgresql') query
WHERE search_vector @@ query
ORDER BY rank DESC;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'è‡ªå®šä¹‰æƒé‡æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 4. é«˜äº®æ˜¾ç¤º

### 4.1 ts_headline

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šé«˜äº®åŒ¹é…å†…å®¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    doc_id,
    title,
    ts_headline(
        'english',
        content,
        to_tsquery('english', 'postgresql & mvcc'),
        'StartSel=<b>, StopSel=</b>, MaxWords=50, MinWords=30'
    ) AS snippet
FROM documents
WHERE search_vector @@ to_tsquery('english', 'postgresql & mvcc')
LIMIT 10;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'é«˜äº®æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- ç»“æœç¤ºä¾‹:
-- "<b>PostgreSQL</b> uses <b>MVCC</b> for concurrency control..."
```

---

## 5. é«˜çº§æŸ¥è¯¢

### 5.1 çŸ­è¯­æœç´¢

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šç²¾ç¡®çŸ­è¯­ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE search_vector @@ phraseto_tsquery('english', 'database management system');
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ç²¾ç¡®çŸ­è¯­æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šé‚»è¿‘æœç´¢ï¼ˆè¯è·ç¦»<3ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE search_vector @@ to_tsquery('english', 'postgresql <3> mvcc');
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'é‚»è¿‘æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.2 å‰ç¼€æœç´¢

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå‰ç¼€åŒ¹é…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE search_vector @@ to_tsquery('english', 'postgre:*');
-- åŒ¹é…: postgres, postgresql, postgresconfç­‰
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨documentsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å‰ç¼€åŒ¹é…æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 5.3 å¸ƒå°”æŸ¥è¯¢

```sql
-- AND
to_tsquery('postgresql & database')

-- OR
to_tsquery('postgresql | mysql')

-- NOT
to_tsquery('database & !oracle')

-- ç»„åˆ
to_tsquery('(postgresql | mysql) & database & !oracle')
```

---

## 6. å¤šè¯­è¨€æ”¯æŒ

### 6.1 å¤šè¯­è¨€è¡¨

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå¤šè¯­è¨€è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TABLE IF NOT EXISTS multilang_docs (
    doc_id SERIAL PRIMARY KEY,
    title_en TEXT,
    content_en TEXT,
    title_zh TEXT,
    content_zh TEXT,
    search_vector_en tsvector,
    search_vector_zh tsvector
);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'è¡¨multilang_docså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå¤šè¯­è¨€è¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šåŒç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE INDEX IF NOT EXISTS idx_multilang_en ON multilang_docs USING gin(search_vector_en);
CREATE INDEX IF NOT EXISTS idx_multilang_zh ON multilang_docs USING gin(search_vector_zh);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨multilang_docsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå¤šè¯­è¨€ç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE OR REPLACE FUNCTION update_multilang_vectors()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector_en :=
        setweight(to_tsvector('english', COALESCE(NEW.title_en, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(NEW.content_en, '')), 'B');

    NEW.search_vector_zh :=
        setweight(to_tsvector('chinese', COALESCE(NEW.title_zh, '')), 'A') ||
        setweight(to_tsvector('chinese', COALESCE(NEW.content_zh, '')), 'B');

    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_multilang_vectors ON multilang_docs;
CREATE TRIGGER trg_multilang_vectors
    BEFORE INSERT OR UPDATE ON multilang_docs
    FOR EACH ROW EXECUTE FUNCTION update_multilang_vectors();
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºå¤šè¯­è¨€è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå¤šè¯­è¨€æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM multilang_docs
WHERE search_vector_en @@ to_tsquery('english', 'database')
   OR search_vector_zh @@ to_tsquery('chinese', 'æ•°æ®åº“');
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨multilang_docsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å¤šè¯­è¨€æœç´¢å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 GIN vs GiST

```sql
-- GINç´¢å¼•ï¼ˆæ¨èï¼‰
CREATE INDEX idx_gin ON documents USING gin(search_vector);
-- æ„å»ºæ…¢ï¼ŒæŸ¥è¯¢å¿«ï¼Œæ›´æ–°æ…¢

-- GiSTç´¢å¼•
CREATE INDEX idx_gist ON documents USING gist(search_vector);
-- æ„å»ºå¿«ï¼ŒæŸ¥è¯¢è¾ƒå¿«ï¼Œæ›´æ–°å¿«

-- æ€§èƒ½å¯¹æ¯”ï¼ˆ100ä¸‡æ–‡æ¡£ï¼‰
/*
ç´¢å¼•ç±»å‹  æ„å»ºæ—¶é—´  ç´¢å¼•å¤§å°  æŸ¥è¯¢å»¶è¿Ÿ  æ›´æ–°æ€§èƒ½
GIN      15åˆ†é’Ÿ    450MB    8ms      æ…¢
GiST     5åˆ†é’Ÿ     380MB    25ms     å¿«

å»ºè®®: è¯»å¤šå†™å°‘ç”¨GINï¼Œå†™å¤šè¯»å°‘ç”¨GiST
*/
```

### 7.2 PostgreSQL 18 GINå¹¶è¡Œæ„å»º

```sql
-- å¯ç”¨å¹¶è¡Œæ„å»º
SET max_parallel_maintenance_workers = 8;

CREATE INDEX idx_search_parallel ON documents
USING gin(search_vector);

-- æ—¶é—´: 15åˆ†é’Ÿ â†’ 4åˆ†é’Ÿ (-73%)
```

---

## 8. æœç´¢å»ºè®®

### 8.1 è‡ªåŠ¨è¡¥å…¨

```sql
-- æœç´¢è¯è¡¨
CREATE TABLE search_terms (
    term VARCHAR(100) PRIMARY KEY,
    frequency INT DEFAULT 0,
    last_searched TIMESTAMPTZ DEFAULT now()
);

-- è®°å½•æœç´¢
INSERT INTO search_terms (term, frequency)
VALUES ('postgresql', 1)
ON CONFLICT (term) DO UPDATE
SET frequency = search_terms.frequency + 1,
    last_searched = now();

-- è‡ªåŠ¨è¡¥å…¨
SELECT term
FROM search_terms
WHERE term LIKE 'post%'
ORDER BY frequency DESC
LIMIT 10;

-- æˆ–ä½¿ç”¨pg_trgmï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
CREATE EXTENSION pg_trgm;
CREATE INDEX ON search_terms USING gin(term gin_trgm_ops);

SELECT term
FROM search_terms
WHERE term % 'postgre'  -- ç›¸ä¼¼åº¦åŒ¹é…
ORDER BY similarity(term, 'postgre') DESC
LIMIT 10;
```

---

## 9. ä¸å‘é‡æ£€ç´¢ç»“åˆ

### 9.1 æ··åˆæ£€ç´¢

```sql
-- è¡¨ç»“æ„
CREATE TABLE hybrid_docs (
    doc_id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    search_vector tsvector,
    embedding vector(768)
);

-- åŒç´¢å¼•
CREATE INDEX ON hybrid_docs USING gin(search_vector);
CREATE INDEX ON hybrid_docs USING hnsw(embedding vector_cosine_ops);

-- æ··åˆæ£€ç´¢
WITH keyword_results AS (
    SELECT
        doc_id,
        ts_rank_cd(search_vector, query) AS text_score
    FROM hybrid_docs,
         to_tsquery('english', 'postgresql & mvcc') query
    WHERE search_vector @@ query
),
vector_results AS (
    SELECT
        doc_id,
        1 - (embedding <=> query_vec) AS vec_score
    FROM hybrid_docs
    ORDER BY embedding <=> query_vec
    LIMIT 100
)
SELECT
    d.doc_id,
    d.title,
    COALESCE(kr.text_score, 0) * 0.4 + COALESCE(vr.vec_score, 0) * 0.6 AS final_score
FROM hybrid_docs d
LEFT JOIN keyword_results kr ON d.doc_id = kr.doc_id
LEFT JOIN vector_results vr ON d.doc_id = vr.doc_id
WHERE kr.doc_id IS NOT NULL OR vr.doc_id IS NOT NULL
ORDER BY final_score DESC
LIMIT 20;
```

---

**å®Œæˆ**: PostgreSQL 18å…¨æ–‡æ£€ç´¢æ·±åº¦å®æˆ˜
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: tsvectorã€ä¸­æ–‡åˆ†è¯ã€GINç´¢å¼•ã€æ’åºã€é«˜äº®ã€å¤šè¯­è¨€ã€æ··åˆæ£€ç´¢
