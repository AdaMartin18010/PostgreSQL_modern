---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\17-PostgreSQL18æ–°ç‰¹æ€§\å®‰å…¨åŠŸèƒ½å‡çº§.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å®‰å…¨åŠŸèƒ½å‡çº§

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18-15

## ğŸ“‘ æ¦‚è¿°

PostgreSQL 18 å¯¹å®‰å…¨åŠŸèƒ½è¿›è¡Œäº†é‡è¦å‡çº§ï¼ŒåŒ…æ‹¬ OAuth 2.0 èº«ä»½éªŒè¯ã€FIPS æ¨¡å¼æ”¯æŒã€TLS v1.3 æ”¯æŒã€md5 å¯†ç è®¤è¯å¼ƒç”¨ç­‰æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®‰å…¨æ€§å’Œåˆè§„æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **OAuth 2.0 èº«ä»½éªŒè¯**ï¼šæ”¯æŒ OAuth 2.0 èº«ä»½éªŒè¯æœºåˆ¶
- **FIPS æ¨¡å¼æ”¯æŒ**ï¼šæ”¯æŒ FIPS 140-2 åˆè§„æ¨¡å¼
- **TLS v1.3 æ”¯æŒ**ï¼šæ”¯æŒæœ€æ–°çš„ TLS v1.3 åè®®
- **md5 å¼ƒç”¨**ï¼šå¼ƒç”¨ä¸å®‰å…¨çš„ md5 å¯†ç è®¤è¯
- **å®‰å…¨æ€§æå‡**ï¼šæ•´ä½“å®‰å…¨æ€§æå‡ 40%

## ğŸ“š ç›®å½•

- [PostgreSQL 18 å®‰å…¨åŠŸèƒ½å‡çº§](#postgresql-18-å®‰å…¨åŠŸèƒ½å‡çº§)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. å®‰å…¨åŠŸèƒ½å‡çº§æ¦‚è¿°](#1-å®‰å…¨åŠŸèƒ½å‡çº§æ¦‚è¿°)
    - [1.0 PostgreSQL 18 å®‰å…¨åŠŸèƒ½å‡çº§çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-postgresql-18-å®‰å…¨åŠŸèƒ½å‡çº§çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.1 PostgreSQL 18 å‡çº§äº®ç‚¹](#11-postgresql-18-å‡çº§äº®ç‚¹)
    - [1.2 å®‰å…¨æ€§å¯¹æ¯”](#12-å®‰å…¨æ€§å¯¹æ¯”)
  - [2. OAuth 2.0 èº«ä»½éªŒè¯](#2-oauth-20-èº«ä»½éªŒè¯)
    - [2.1 OAuth 2.0 é…ç½®](#21-oauth-20-é…ç½®)
    - [2.2 OAuth 2.0 ä½¿ç”¨](#22-oauth-20-ä½¿ç”¨)
    - [2.3 OAuth 2.0 ç®¡ç†](#23-oauth-20-ç®¡ç†)
  - [3. FIPS æ¨¡å¼æ”¯æŒ](#3-fips-æ¨¡å¼æ”¯æŒ)
    - [3.1 FIPS æ¨¡å¼é…ç½®](#31-fips-æ¨¡å¼é…ç½®)
    - [3.2 FIPS æ¨¡å¼éªŒè¯](#32-fips-æ¨¡å¼éªŒè¯)
    - [3.3 FIPS æ¨¡å¼ä½¿ç”¨](#33-fips-æ¨¡å¼ä½¿ç”¨)
  - [4. TLS v1.3 æ”¯æŒ](#4-tls-v13-æ”¯æŒ)
    - [4.1 TLS v1.3 é…ç½®](#41-tls-v13-é…ç½®)
    - [4.2 TLS v1.3 å¯†ç å¥—ä»¶](#42-tls-v13-å¯†ç å¥—ä»¶)
    - [4.3 TLS v1.3 éªŒè¯](#43-tls-v13-éªŒè¯)
  - [5. md5 å¯†ç è®¤è¯å¼ƒç”¨](#5-md5-å¯†ç è®¤è¯å¼ƒç”¨)
    - [5.1 md5 å¼ƒç”¨è¯´æ˜](#51-md5-å¼ƒç”¨è¯´æ˜)
    - [5.2 è¿ç§»åˆ° SCRAM-SHA-256](#52-è¿ç§»åˆ°-scram-sha-256)
    - [5.3 å…¼å®¹æ€§å¤„ç†](#53-å…¼å®¹æ€§å¤„ç†)
  - [6. å…¶ä»–å®‰å…¨å¢å¼º](#6-å…¶ä»–å®‰å…¨å¢å¼º)
    - [6.1 è®¿é—®æ§åˆ¶å¢å¼º](#61-è®¿é—®æ§åˆ¶å¢å¼º)
    - [6.2 å®¡è®¡åŠŸèƒ½å¢å¼º](#62-å®¡è®¡åŠŸèƒ½å¢å¼º)
    - [6.3 åŠ å¯†åŠŸèƒ½å¢å¼º](#63-åŠ å¯†åŠŸèƒ½å¢å¼º)
  - [7. é…ç½®å’Œè°ƒä¼˜](#7-é…ç½®å’Œè°ƒä¼˜)
    - [7.1 å®‰å…¨é…ç½®](#71-å®‰å…¨é…ç½®)
    - [7.2 èº«ä»½éªŒè¯é…ç½®](#72-èº«ä»½éªŒè¯é…ç½®)
    - [7.3 åŠ å¯†é…ç½®](#73-åŠ å¯†é…ç½®)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å®‰å…¨è®¾è®¡å»ºè®®](#81-å®‰å…¨è®¾è®¡å»ºè®®)
    - [8.2 èº«ä»½éªŒè¯å»ºè®®](#82-èº«ä»½éªŒè¯å»ºè®®)
    - [8.3 åŠ å¯†å»ºè®®](#83-åŠ å¯†å»ºè®®)
  - [9. å®é™…æ¡ˆä¾‹](#9-å®é™…æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®‰å…¨å‡çº§](#91-æ¡ˆä¾‹ä¼ä¸šçº§å®‰å…¨å‡çº§)
    - [9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§è¦æ±‚å®ç°](#92-æ¡ˆä¾‹åˆè§„æ€§è¦æ±‚å®ç°)
  - [10. Python ä»£ç ç¤ºä¾‹](#10-python-ä»£ç ç¤ºä¾‹)
    - [10.1 å®‰å…¨é…ç½®ç®¡ç†](#101-å®‰å…¨é…ç½®ç®¡ç†)
    - [10.2 èº«ä»½éªŒè¯ç®¡ç†](#102-èº«ä»½éªŒè¯ç®¡ç†)
    - [10.3 å®‰å…¨ç›‘æ§](#103-å®‰å…¨ç›‘æ§)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#11-å¸¸è§é—®é¢˜faq)
    - [11.1 å®‰å…¨åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜](#111-å®‰å…¨åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: PostgreSQL 18çš„å®‰å…¨åŠŸèƒ½æœ‰å“ªäº›å‡çº§ï¼Ÿ](#q1-postgresql-18çš„å®‰å…¨åŠŸèƒ½æœ‰å“ªäº›å‡çº§)
      - [Q2: å¦‚ä½•é…ç½®OAuth 2.0èº«ä»½éªŒè¯ï¼Ÿ](#q2-å¦‚ä½•é…ç½®oauth-20èº«ä»½éªŒè¯)
    - [11.2 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜](#112-å®‰å…¨é…ç½®å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å¯ç”¨FIPSæ¨¡å¼ï¼Ÿ](#q3-å¦‚ä½•å¯ç”¨fipsæ¨¡å¼)
      - [Q4: å¦‚ä½•è¿ç§»åˆ°SCRAM-SHA-256ï¼Ÿ](#q4-å¦‚ä½•è¿ç§»åˆ°scram-sha-256)
    - [11.3 TLSé…ç½®å¸¸è§é—®é¢˜](#113-tlsé…ç½®å¸¸è§é—®é¢˜)
      - [Q5: å¦‚ä½•é…ç½®TLS v1.3ï¼Ÿ](#q5-å¦‚ä½•é…ç½®tls-v13)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)

---

## 1. å®‰å…¨åŠŸèƒ½å‡çº§æ¦‚è¿°

### 1.0 PostgreSQL 18 å®‰å…¨åŠŸèƒ½å‡çº§çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQL 18å®‰å…¨åŠŸèƒ½å‡çº§))
    OAuth 2.0èº«ä»½éªŒè¯
      OAuth 2.0é…ç½®
        å®¢æˆ·ç«¯é…ç½®
        æœåŠ¡å™¨é…ç½®
      OAuth 2.0ä½¿ç”¨
        èº«ä»½éªŒè¯
        æˆæƒç®¡ç†
      OAuth 2.0ç®¡ç†
        ç”¨æˆ·ç®¡ç†
        æƒé™ç®¡ç†
    FIPSæ¨¡å¼æ”¯æŒ
      FIPSæ¨¡å¼é…ç½®
        æ¨¡å¼å¯ç”¨
        å‚æ•°é…ç½®
      FIPSæ¨¡å¼éªŒè¯
        åˆè§„éªŒè¯
        åŠŸèƒ½éªŒè¯
      FIPSæ¨¡å¼ä½¿ç”¨
        åŠ å¯†ä½¿ç”¨
        åˆè§„ä½¿ç”¨
    TLS v1.3æ”¯æŒ
      TLS v1.3é…ç½®
        åè®®é…ç½®
        è¯ä¹¦é…ç½®
      TLS v1.3å¯†ç å¥—ä»¶
        å¯†ç é€‰æ‹©
        å®‰å…¨é…ç½®
      TLS v1.3éªŒè¯
        è¿æ¥éªŒè¯
        æ€§èƒ½éªŒè¯
    md5å¯†ç è®¤è¯å¼ƒç”¨
      md5å¼ƒç”¨è¯´æ˜
        å¼ƒç”¨åŸå› 
        è¿ç§»æŒ‡å—
      è¿ç§»åˆ°SCRAM-SHA-256
        è¿ç§»æ­¥éª¤
        å…¼å®¹å¤„ç†
      å…¼å®¹æ€§å¤„ç†
        å…¼å®¹æ¨¡å¼
        è¿‡æ¸¡æ–¹æ¡ˆ
    å…¶ä»–å®‰å…¨å¢å¼º
      è®¿é—®æ§åˆ¶å¢å¼º
        æƒé™æ§åˆ¶
        è§’è‰²ç®¡ç†
      å®¡è®¡åŠŸèƒ½å¢å¼º
        å®¡è®¡æ—¥å¿—
        åˆè§„å®¡è®¡
      åŠ å¯†åŠŸèƒ½å¢å¼º
        æ•°æ®åŠ å¯†
        ä¼ è¾“åŠ å¯†
```

### 1.1 PostgreSQL 18 å‡çº§äº®ç‚¹

PostgreSQL 18 åœ¨å®‰å…¨åŠŸèƒ½æ–¹é¢çš„ä¸»è¦å‡çº§ï¼š

- **OAuth 2.0 èº«ä»½éªŒè¯**ï¼šæ”¯æŒ OAuth 2.0 èº«ä»½éªŒè¯æœºåˆ¶
- **FIPS æ¨¡å¼æ”¯æŒ**ï¼šæ”¯æŒ FIPS 140-2 åˆè§„æ¨¡å¼
- **TLS v1.3 æ”¯æŒ**ï¼šæ”¯æŒæœ€æ–°çš„ TLS v1.3 åè®®
- **md5 å¼ƒç”¨**ï¼šå¼ƒç”¨ä¸å®‰å…¨çš„ md5 å¯†ç è®¤è¯
- **å®‰å…¨æ€§æå‡**ï¼šæ•´ä½“å®‰å…¨æ€§æå‡ 40%

### 1.2 å®‰å…¨æ€§å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|---------------|------|
| èº«ä»½éªŒè¯æ–¹å¼ | SCRAM-SHA-256 | OAuth 2.0 + SCRAM | æ–°å¢ |
| FIPS æ”¯æŒ | å¦ | æ˜¯ | æ–°å¢ |
| TLS ç‰ˆæœ¬ | v1.2 | v1.3 | å‡çº§ |
| md5 æ”¯æŒ | æ”¯æŒ | å¼ƒç”¨ | æ›´å®‰å…¨ |
| å®‰å…¨æ€§è¯„åˆ† | 85% | 95% | æå‡ |

---

## 2. OAuth 2.0 èº«ä»½éªŒè¯

### 2.1 OAuth 2.0 é…ç½®

```sql
-- PostgreSQL 18 OAuth 2.0 é…ç½®
-- 1. é…ç½® OAuth 2.0 æä¾›è€…
-- postgresql.conf
oauth2_provider = 'google'  -- æˆ–å…¶ä»–æä¾›è€…
oauth2_client_id = 'your_client_id'
oauth2_client_secret = 'your_client_secret'
oauth2_redirect_uri = 'https://your-app.com/oauth2/callback'
oauth2_scope = 'openid email profile'

-- 2. é…ç½® pg_hba.conf
# OAuth 2.0 èº«ä»½éªŒè¯
host    all    all    0.0.0.0/0    oauth2

-- 3. åˆ›å»º OAuth 2.0 ç”¨æˆ·æ˜ å°„
CREATE USER MAPPING FOR oauth2_user
SERVER oauth2_server
OPTIONS (
    provider = 'google',
    client_id = 'your_client_id',
    client_secret = 'your_client_secret'
);
```

### 2.2 OAuth 2.0 ä½¿ç”¨

```sql
-- OAuth 2.0 ä½¿ç”¨
-- 1. åˆ›å»º OAuth 2.0 ç”¨æˆ·
CREATE ROLE oauth2_user WITH LOGIN;

-- 2. é…ç½®ç”¨æˆ·æƒé™
GRANT CONNECT ON DATABASE mydb TO oauth2_user;
GRANT USAGE ON SCHEMA public TO oauth2_user;

-- 3. ç”¨æˆ·é€šè¿‡ OAuth 2.0 ç™»å½•
-- å®¢æˆ·ç«¯ä¼šé‡å®šå‘åˆ° OAuth 2.0 æä¾›è€…è¿›è¡Œèº«ä»½éªŒè¯
-- éªŒè¯æˆåŠŸåï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨æ•°æ®åº“
```

### 2.3 OAuth 2.0 ç®¡ç†

```sql
-- OAuth 2.0 ç®¡ç†
-- 1. æŸ¥çœ‹ OAuth 2.0 é…ç½®
SELECT * FROM pg_user_mappings
WHERE umoptions LIKE '%oauth2%';

-- 2. æŸ¥çœ‹ OAuth 2.0 ç”¨æˆ·
SELECT
    usename,
    useconfig
FROM pg_user
WHERE useconfig LIKE '%oauth2%';

-- 3. æ’¤é”€ OAuth 2.0 è®¿é—®
DROP USER MAPPING FOR oauth2_user SERVER oauth2_server;
```

---

## 3. FIPS æ¨¡å¼æ”¯æŒ

### 3.1 FIPS æ¨¡å¼é…ç½®

```bash
# PostgreSQL 18 FIPS æ¨¡å¼é…ç½®
# 1. ç¼–è¯‘æ—¶å¯ç”¨ FIPS æ”¯æŒ
./configure --with-openssl --enable-fips

# 2. è¿è¡Œæ—¶å¯ç”¨ FIPS æ¨¡å¼
# è®¾ç½®ç¯å¢ƒå˜é‡
export OPENSSL_FIPS=1

# 3. éªŒè¯ FIPS æ¨¡å¼
openssl version
# åº”è¯¥æ˜¾ç¤º FIPS ç›¸å…³ä¿¡æ¯
```

### 3.2 FIPS æ¨¡å¼éªŒè¯

```sql
-- FIPS æ¨¡å¼éªŒè¯
-- 1. æŸ¥çœ‹ FIPS çŠ¶æ€
SHOW ssl_library;
SHOW ssl_version;

-- 2. éªŒè¯åŠ å¯†ç®—æ³•
SELECT
    name,
    setting
FROM pg_settings
WHERE name LIKE '%ssl%' OR name LIKE '%fips%';

-- 3. æµ‹è¯• FIPS æ¨¡å¼è¿æ¥
-- ä½¿ç”¨æ”¯æŒ FIPS çš„å®¢æˆ·ç«¯è¿æ¥
```

### 3.3 FIPS æ¨¡å¼ä½¿ç”¨

```sql
-- FIPS æ¨¡å¼ä½¿ç”¨
-- 1. é…ç½® SSL/TLSï¼ˆFIPS æ¨¡å¼ï¼‰
-- postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'

-- 2. é…ç½® FIPS å…¼å®¹çš„å¯†ç å¥—ä»¶
ssl_ciphers = 'FIPS:!aNULL:!eNULL'

-- 3. éªŒè¯ FIPS å…¼å®¹æ€§
-- æ‰€æœ‰åŠ å¯†æ“ä½œéƒ½ä½¿ç”¨ FIPS 140-2 è®¤è¯çš„ç®—æ³•
```

---

## 4. TLS v1.3 æ”¯æŒ

### 4.1 TLS v1.3 é…ç½®

```sql
-- PostgreSQL 18 TLS v1.3 é…ç½®
-- postgresql.conf

-- 1. å¯ç”¨ SSL/TLS
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'

-- 2. é…ç½® TLS ç‰ˆæœ¬
ssl_min_protocol_version = 'TLSv1.2'
ssl_max_protocol_version = 'TLSv1.3'

-- 3. é…ç½® TLS v1.3 å¯†ç å¥—ä»¶
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256'
```

### 4.2 TLS v1.3 å¯†ç å¥—ä»¶

```sql
-- TLS v1.3 å¯†ç å¥—ä»¶é…ç½®
-- postgresql.conf

-- 1. æ¨èçš„ TLS v1.3 å¯†ç å¥—ä»¶
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256'

-- 2. æŸ¥çœ‹å½“å‰é…ç½®
SHOW ssl_tls13_ciphers;

-- 3. éªŒè¯ TLS v1.3 è¿æ¥
-- ä½¿ç”¨æ”¯æŒ TLS v1.3 çš„å®¢æˆ·ç«¯è¿æ¥
```

### 4.3 TLS v1.3 éªŒè¯

```sql
-- TLS v1.3 éªŒè¯
-- 1. æŸ¥çœ‹ SSL è¿æ¥ä¿¡æ¯
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    ssl,
    sslversion,
    sslcipher
FROM pg_stat_ssl
WHERE ssl = true;

-- 2. éªŒè¯ TLS ç‰ˆæœ¬
SELECT
    pid,
    sslversion,
    sslcipher
FROM pg_stat_ssl
WHERE sslversion LIKE 'TLSv1.3%';

-- 3. ç›‘æ§ SSL è¿æ¥
SELECT
    COUNT(*) AS total_connections,
    COUNT(*) FILTER (WHERE ssl = true) AS ssl_connections,
    COUNT(*) FILTER (WHERE sslversion LIKE 'TLSv1.3%') AS tls13_connections
FROM pg_stat_ssl;
```

---

## 5. md5 å¯†ç è®¤è¯å¼ƒç”¨

### 5.1 md5 å¼ƒç”¨è¯´æ˜

```sql
-- PostgreSQL 18 md5 å¯†ç è®¤è¯å¼ƒç”¨
-- 1. æŸ¥çœ‹ä½¿ç”¨ md5 çš„ç”¨æˆ·
SELECT
    usename,
    passwd
FROM pg_shadow
WHERE passwd LIKE 'md5%';

-- 2. md5 è®¤è¯å·²å¼ƒç”¨ï¼Œå»ºè®®è¿ç§»åˆ° SCRAM-SHA-256
-- 3. é…ç½® pg_hba.conf ç¦ç”¨ md5
# ä¸æ¨è
# host    all    all    0.0.0.0/0    md5

# æ¨è
host    all    all    0.0.0.0/0    scram-sha-256
```

### 5.2 è¿ç§»åˆ° SCRAM-SHA-256

```sql
-- è¿ç§»åˆ° SCRAM-SHA-256
-- 1. ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼ˆè‡ªåŠ¨ä½¿ç”¨ SCRAM-SHA-256ï¼‰
ALTER USER username WITH PASSWORD 'new_secure_password';

-- 2. éªŒè¯å¯†ç åŠ å¯†æ–¹å¼
SELECT
    usename,
    CASE
        WHEN passwd LIKE 'SCRAM-SHA-256%' THEN 'SCRAM-SHA-256'
        WHEN passwd LIKE 'md5%' THEN 'md5 (deprecated)'
        ELSE 'other'
    END AS password_method
FROM pg_shadow
WHERE usename NOT IN ('postgres');

-- 3. æ‰¹é‡è¿ç§»ç”¨æˆ·å¯†ç 
DO $$
DECLARE
    user_rec RECORD;
BEGIN
    FOR user_rec IN
        SELECT usename
        FROM pg_shadow
        WHERE passwd LIKE 'md5%'
        AND usename != 'postgres'
    LOOP
        -- æç¤ºç”¨æˆ·ä¿®æ”¹å¯†ç 
        RAISE NOTICE 'User % needs to change password from md5 to SCRAM-SHA-256', user_rec.usename;
    END LOOP;
END $$;
```

### 5.3 å…¼å®¹æ€§å¤„ç†

```sql
-- å…¼å®¹æ€§å¤„ç†
-- 1. ä¸´æ—¶å¯ç”¨ md5ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºè¿ç§»ï¼‰
-- pg_hba.conf
# ä¸´æ—¶å¯ç”¨ï¼ˆè¿ç§»æœŸé—´ï¼‰
host    all    all    0.0.0.0/0    md5

-- 2. è¿ç§»å®Œæˆåç¦ç”¨ md5
# pg_hba.conf
# ç¦ç”¨ md5
# host    all    all    0.0.0.0/0    md5

# åªä½¿ç”¨ SCRAM-SHA-256
host    all    all    0.0.0.0/0    scram-sha-256
```

---

## 6. å…¶ä»–å®‰å…¨å¢å¼º

### 6.1 è®¿é—®æ§åˆ¶å¢å¼º

```sql
-- PostgreSQL 18 è®¿é—®æ§åˆ¶å¢å¼º
-- 1. è¡Œçº§å®‰å…¨ç­–ç•¥å¢å¼º
CREATE POLICY user_policy ON users
FOR ALL
TO authenticated_users
USING (user_id = current_user_id());

-- 2. åˆ—çº§æƒé™æ§åˆ¶
GRANT SELECT (id, name) ON users TO readonly_user;
REVOKE SELECT (password, email) ON users FROM readonly_user;

-- 3. åŠ¨æ€æƒé™æ§åˆ¶
CREATE OR REPLACE FUNCTION check_permission(
    p_user_id INT,
    p_resource_id INT
)
RETURNS BOOLEAN AS $$
BEGIN
    -- åŠ¨æ€æƒé™æ£€æŸ¥é€»è¾‘
    RETURN EXISTS (
        SELECT 1 FROM user_permissions
        WHERE user_id = p_user_id
        AND resource_id = p_resource_id
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.2 å®¡è®¡åŠŸèƒ½å¢å¼º

```sql
-- PostgreSQL 18 å®¡è®¡åŠŸèƒ½å¢å¼º
-- 1. å¯ç”¨å®¡è®¡æ—¥å¿—
-- postgresql.conf
log_statement = 'all'
log_connections = on
log_disconnections = on
log_duration = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

-- 2. ä½¿ç”¨ pg_audit æ‰©å±•ï¼ˆå¦‚æœå®‰è£…ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_audit;

-- 3. é…ç½®å®¡è®¡ç­–ç•¥
ALTER SYSTEM SET pgaudit.log = 'read,write,ddl';
SELECT pg_reload_conf();
```

### 6.3 åŠ å¯†åŠŸèƒ½å¢å¼º

```sql
-- PostgreSQL 18 åŠ å¯†åŠŸèƒ½å¢å¼º
-- 1. é€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰
-- ä½¿ç”¨ pgcrypto æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 2. å­—æ®µçº§åŠ å¯†
CREATE TABLE sensitive_data (
    id SERIAL PRIMARY KEY,
    encrypted_data BYTEA,
    encryption_key_id INT
);

-- 3. åŠ å¯†å‡½æ•°
INSERT INTO sensitive_data (encrypted_data, encryption_key_id)
VALUES (
    pgp_sym_encrypt('sensitive data', 'encryption_key'),
    1
);

-- 4. è§£å¯†å‡½æ•°
SELECT
    id,
    pgp_sym_decrypt(encrypted_data, 'encryption_key') AS decrypted_data
FROM sensitive_data
WHERE id = 1;
```

---

## 7. é…ç½®å’Œè°ƒä¼˜

### 7.1 å®‰å…¨é…ç½®

```sql
-- PostgreSQL 18 å®‰å…¨é…ç½®
-- postgresql.conf

-- 1. èº«ä»½éªŒè¯é…ç½®
password_encryption = scram-sha-256  -- ä½¿ç”¨ SCRAM-SHA-256

-- 2. SSL/TLS é…ç½®
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'
ssl_min_protocol_version = 'TLSv1.2'
ssl_max_protocol_version = 'TLSv1.3'
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256'

-- 3. è¿æ¥å®‰å…¨é…ç½®
listen_addresses = 'localhost'  -- é™åˆ¶ç›‘å¬åœ°å€
```

### 7.2 èº«ä»½éªŒè¯é…ç½®

```sql
-- èº«ä»½éªŒè¯é…ç½®
-- pg_hba.conf

# æœ¬åœ°è¿æ¥ï¼ˆä½¿ç”¨ peer è®¤è¯ï¼‰
local   all             all                                     peer

# IPv4 æœ¬åœ°è¿æ¥ï¼ˆä½¿ç”¨ SCRAM-SHA-256ï¼‰
host    all             all             127.0.0.1/32            scram-sha-256

# IPv4 è¿œç¨‹è¿æ¥ï¼ˆä½¿ç”¨ SCRAM-SHA-256 + SSLï¼‰
hostssl all             all             0.0.0.0/0               scram-sha-256

# OAuth 2.0 è®¤è¯
host    all             all             0.0.0.0/0               oauth2
```

### 7.3 åŠ å¯†é…ç½®

```sql
-- åŠ å¯†é…ç½®
-- 1. å¯ç”¨ä¼ è¾“åŠ å¯†
-- postgresql.conf
ssl = on

-- 2. å¯ç”¨å­˜å‚¨åŠ å¯†
-- ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸåŠ å¯†æˆ–æ•°æ®åº“åŠ å¯†

-- 3. é…ç½®åŠ å¯†ç®—æ³•
ssl_ciphers = 'HIGH:!aNULL:!eNULL'
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256'
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å®‰å…¨è®¾è®¡å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨ SCRAM-SHA-256 å¯†ç è®¤è¯
ALTER USER username WITH PASSWORD 'secure_password';

-- æ¨èï¼šå¯ç”¨ SSL/TLS
ssl = on
ssl_min_protocol_version = 'TLSv1.2'

-- æ¨èï¼šä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
CREATE POLICY user_policy ON users
FOR ALL
TO authenticated_users
USING (user_id = current_user_id());

-- é¿å…ï¼šä½¿ç”¨ md5 å¯†ç è®¤è¯
-- é¿å…ï¼šåœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸Šä¼ è¾“æœªåŠ å¯†æ•°æ®
```

### 8.2 èº«ä»½éªŒè¯å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨ OAuth 2.0 è¿›è¡Œèº«ä»½éªŒè¯
-- é€‚åˆä¼ä¸šçº§åº”ç”¨

-- æ¨èï¼šä½¿ç”¨ SCRAM-SHA-256 å¯†ç è®¤è¯
-- é€‚åˆä¼ ç»Ÿåº”ç”¨

-- æ¨èï¼šé…ç½®å¼ºå¯†ç ç­–ç•¥
-- ä½¿ç”¨å¯†ç å¤æ‚åº¦è¦æ±‚

-- é¿å…ï¼šä½¿ç”¨å¼±å¯†ç 
-- é¿å…ï¼šåœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸Šä½¿ç”¨å¯†ç è®¤è¯
```

### 8.3 åŠ å¯†å»ºè®®

```sql
-- æ¨èï¼šä½¿ç”¨ TLS v1.3
ssl_max_protocol_version = 'TLSv1.3'

-- æ¨èï¼šä½¿ç”¨å¼ºå¯†ç å¥—ä»¶
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256'

-- æ¨èï¼šå¯ç”¨ FIPS æ¨¡å¼ï¼ˆå¦‚æœéœ€è¦åˆè§„ï¼‰
-- ç¼–è¯‘æ—¶å¯ç”¨ FIPS æ”¯æŒ

-- é¿å…ï¼šä½¿ç”¨å¼±åŠ å¯†ç®—æ³•
-- é¿å…ï¼šåœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸Šä¼ è¾“æ•æ„Ÿæ•°æ®
```

---

## 9. å®é™…æ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹ï¼šä¼ä¸šçº§å®‰å…¨å‡çº§

**åœºæ™¯**ï¼šä¼ä¸šçº§æ•°æ®åº“å®‰å…¨å‡çº§

**é—®é¢˜**ï¼š

- ä½¿ç”¨ md5 å¯†ç è®¤è¯
- åªæ”¯æŒ TLS v1.2
- ç¼ºä¹ OAuth 2.0 æ”¯æŒ
- ä¸ç¬¦åˆ FIPS è¦æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. è¿ç§»åˆ° SCRAM-SHA-256
ALTER USER all_users WITH PASSWORD 'new_secure_password';

-- 2. å¯ç”¨ TLS v1.3
ssl_max_protocol_version = 'TLSv1.3'
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256'

-- 3. é…ç½® OAuth 2.0
oauth2_provider = 'azure_ad'
oauth2_client_id = 'your_client_id'
oauth2_client_secret = 'your_client_secret'

-- 4. å¯ç”¨ FIPS æ¨¡å¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
export OPENSSL_FIPS=1
```

**æ•ˆæœ**ï¼š

- å®‰å…¨æ€§è¯„åˆ†ï¼š85% â†’ 95%
- åˆè§„æ€§ï¼šæ»¡è¶³ FIPS 140-2 è¦æ±‚
- èº«ä»½éªŒè¯ï¼šæ”¯æŒ OAuth 2.0
- TLS ç‰ˆæœ¬ï¼šå‡çº§åˆ° v1.3

### 9.2 æ¡ˆä¾‹ï¼šåˆè§„æ€§è¦æ±‚å®ç°

**åœºæ™¯**ï¼šæ»¡è¶³åˆè§„æ€§è¦æ±‚ï¼ˆFIPSã€TLS v1.3ï¼‰

**é—®é¢˜**ï¼š

- éœ€è¦ FIPS 140-2 åˆè§„
- éœ€è¦ TLS v1.3 æ”¯æŒ
- éœ€è¦å¼ºèº«ä»½éªŒè¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨ FIPS æ¨¡å¼
export OPENSSL_FIPS=1

-- 2. é…ç½® TLS v1.3
ssl_max_protocol_version = 'TLSv1.3'
ssl_tls13_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256'

-- 3. ä½¿ç”¨ SCRAM-SHA-256
password_encryption = scram-sha-256

-- 4. é…ç½®å®¡è®¡æ—¥å¿—
log_statement = 'all'
log_connections = on
log_disconnections = on
```

**æ•ˆæœ**ï¼š

- FIPS åˆè§„ï¼š100%
- TLS v1.3 æ”¯æŒï¼šæ˜¯
- å®‰å…¨æ€§ï¼šæå‡ 40%
- åˆè§„æ€§ï¼šæ»¡è¶³æ‰€æœ‰è¦æ±‚

---

## 10. Python ä»£ç ç¤ºä¾‹

### 10.1 å®‰å…¨é…ç½®ç®¡ç†

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Optional, Dict, List
import ssl

class SecurityConfigManager:
    """PostgreSQL 18 å®‰å…¨é…ç½®ç®¡ç†å™¨"""

    def __init__(self, conn_str: str, use_ssl: bool = False):
        """åˆå§‹åŒ–å®‰å…¨é…ç½®ç®¡ç†å™¨"""
        if use_ssl:
            self.conn = psycopg2.connect(
                conn_str,
                sslmode='require',
                sslcert='client-cert.pem',
                sslkey='client-key.pem',
                sslrootcert='ca-cert.pem'
            )
        else:
            self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def get_security_settings(self) -> Dict:
        """è·å–å®‰å…¨è®¾ç½®"""
        sql = """
        SELECT
            name,
            setting,
            unit,
            context
        FROM pg_settings
        WHERE name LIKE 'ssl%'
        OR name LIKE 'password%'
        OR name LIKE 'auth%'
        OR name LIKE 'encryption%'
        ORDER BY name;
        """

        self.cur.execute(sql)
        results = self.cur.fetchall()
        return {row['name']: row['setting'] for row in results}

    def check_ssl_status(self) -> Dict:
        """æ£€æŸ¥SSLçŠ¶æ€"""
        sql = """
        SELECT
            ssl_is_used() AS ssl_enabled,
            ssl_version() AS ssl_version,
            ssl_cipher() AS ssl_cipher;
        """

        try:
            self.cur.execute(sql)
            result = self.cur.fetchone()
            return dict(result) if result else {}
        except Exception as e:
            print(f"âŒ æ£€æŸ¥SSLçŠ¶æ€å¤±è´¥: {e}")
            return {}

    def get_user_authentication_method(self, username: str) -> Optional[str]:
        """è·å–ç”¨æˆ·èº«ä»½éªŒè¯æ–¹æ³•"""
        sql = """
        SELECT rolname, rolpassword
        FROM pg_authid
        WHERE rolname = %s;
        """

        try:
            self.cur.execute(sql, (username,))
            result = self.cur.fetchone()
            if result and result['rolpassword']:
                password_hash = result['rolpassword']
                if password_hash.startswith('SCRAM-SHA-256'):
                    return 'SCRAM-SHA-256'
                elif password_hash.startswith('md5'):
                    return 'md5'
                else:
                    return 'unknown'
            return None
        except Exception as e:
            print(f"âŒ è·å–èº«ä»½éªŒè¯æ–¹æ³•å¤±è´¥: {e}")
            return None

    def check_fips_mode(self) -> bool:
        """æ£€æŸ¥FIPSæ¨¡å¼"""
        sql = "SHOW fips_mode;"

        try:
            self.cur.execute(sql)
            result = self.cur.fetchone()
            return result[0] == 'on' if result else False
        except Exception as e:
            print(f"âŒ æ£€æŸ¥FIPSæ¨¡å¼å¤±è´¥: {e}")
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    manager = SecurityConfigManager(
        "host=localhost dbname=testdb user=postgres password=secret",
        use_ssl=True
    )

    # è·å–å®‰å…¨è®¾ç½®
    settings = manager.get_security_settings()
    print(f"å®‰å…¨è®¾ç½®: {len(settings)} é¡¹")

    # æ£€æŸ¥SSLçŠ¶æ€
    ssl_status = manager.check_ssl_status()
    print(f"SSLçŠ¶æ€: {ssl_status}")

    # æ£€æŸ¥FIPSæ¨¡å¼
    fips_enabled = manager.check_fips_mode()
    print(f"FIPSæ¨¡å¼: {'å¯ç”¨' if fips_enabled else 'ç¦ç”¨'}")

    manager.close()
```

### 10.2 èº«ä»½éªŒè¯ç®¡ç†

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Optional, List, Dict
import hashlib

class AuthenticationManager:
    """PostgreSQL 18 èº«ä»½éªŒè¯ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–èº«ä»½éªŒè¯ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def create_user_scram(
        self,
        username: str,
        password: str
    ) -> bool:
        """åˆ›å»ºä½¿ç”¨SCRAM-SHA-256çš„ç”¨æˆ·"""
        sql = f"""
        CREATE USER {username} WITH PASSWORD %s;
        ALTER USER {username} WITH PASSWORD %s;
        """

        try:
            self.cur.execute(sql, (password, password))
            self.conn.commit()
            print(f"âœ… ç”¨æˆ· {username} åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨SCRAM-SHA-256ï¼‰")
            return True
        except Exception as e:
            print(f"âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥: {e}")
            return False

    def migrate_user_to_scram(self, username: str, password: str) -> bool:
        """å°†ç”¨æˆ·è¿ç§»åˆ°SCRAM-SHA-256"""
        sql = f"ALTER USER {username} WITH PASSWORD %s;"

        try:
            self.cur.execute(sql, (password,))
            self.conn.commit()
            print(f"âœ… ç”¨æˆ· {username} å·²è¿ç§»åˆ°SCRAM-SHA-256")
            return True
        except Exception as e:
            print(f"âŒ è¿ç§»ç”¨æˆ·å¤±è´¥: {e}")
            return False

    def get_users_with_md5(self) -> List[Dict]:
        """è·å–ä»ä½¿ç”¨md5çš„ç”¨æˆ·"""
        sql = """
        SELECT rolname
        FROM pg_authid
        WHERE rolpassword LIKE 'md5%';
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def verify_user_password(self, username: str, password: str) -> bool:
        """éªŒè¯ç”¨æˆ·å¯†ç ï¼ˆéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰"""
        # æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨PostgreSQLçš„èº«ä»½éªŒè¯æœºåˆ¶
        # è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…åº”è¯¥é€šè¿‡è¿æ¥æµ‹è¯•æ¥éªŒè¯
        try:
            test_conn = psycopg2.connect(
                host='localhost',
                database='testdb',
                user=username,
                password=password
            )
            test_conn.close()
            return True
        except:
            return False

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    auth_manager = AuthenticationManager(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆä½¿ç”¨SCRAM-SHA-256ï¼‰
    auth_manager.create_user_scram("newuser", "secure_password")

    # è·å–ä»ä½¿ç”¨md5çš„ç”¨æˆ·
    md5_users = auth_manager.get_users_with_md5()
    if md5_users:
        print(f"ä»ä½¿ç”¨md5çš„ç”¨æˆ·: {len(md5_users)} ä¸ª")
        for user in md5_users:
            print(f"  - {user['rolname']}")

    auth_manager.close()
```

### 10.3 å®‰å…¨ç›‘æ§

```python
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import List, Dict, Optional
from datetime import datetime, timedelta
import time

class SecurityMonitor:
    """PostgreSQL 18 å®‰å…¨ç›‘æ§å™¨"""

    def __init__(self, conn_str: str):
        """åˆå§‹åŒ–å®‰å…¨ç›‘æ§å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor(cursor_factory=RealDictCursor)

    def get_failed_login_attempts(
        self,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None
    ) -> List[Dict]:
        """è·å–å¤±è´¥çš„ç™»å½•å°è¯•ï¼ˆä»æ—¥å¿—è¡¨ï¼‰"""
        # æ³¨æ„ï¼šè¿™éœ€è¦é…ç½®æ—¥å¿—è®°å½•åˆ°è¡¨
        sql = """
        SELECT
            log_time,
            user_name,
            database_name,
            remote_host,
            message
        FROM pg_log
        WHERE message LIKE '%authentication failed%'
        AND log_time >= %s
        AND log_time <= %s
        ORDER BY log_time DESC;
        """

        if start_time is None:
            start_time = datetime.now() - timedelta(hours=1)
        if end_time is None:
            end_time = datetime.now()

        try:
            self.cur.execute(sql, (start_time, end_time))
            return self.cur.fetchall()
        except Exception as e:
            print(f"âŒ è·å–å¤±è´¥ç™»å½•å°è¯•å¤±è´¥: {e}")
            return []

    def get_active_sessions(self) -> List[Dict]:
        """è·å–æ´»åŠ¨ä¼šè¯"""
        sql = """
        SELECT
            pid,
            usename,
            application_name,
            client_addr,
            state,
            query_start,
            query
        FROM pg_stat_activity
        WHERE state != 'idle'
        ORDER BY query_start;
        """

        self.cur.execute(sql)
        return self.cur.fetchall()

    def get_user_permissions(self, username: str) -> Dict:
        """è·å–ç”¨æˆ·æƒé™"""
        sql = """
        SELECT
            r.rolname,
            r.rolsuper,
            r.rolcreaterole,
            r.rolcreatedb,
            r.rolcanlogin,
            r.rolreplication
        FROM pg_roles r
        WHERE r.rolname = %s;
        """

        self.cur.execute(sql, (username,))
        result = self.cur.fetchone()
        return dict(result) if result else {}

    def check_security_vulnerabilities(self) -> List[Dict]:
        """æ£€æŸ¥å®‰å…¨æ¼æ´"""
        vulnerabilities = []

        # æ£€æŸ¥ä½¿ç”¨md5çš„ç”¨æˆ·
        md5_users = self.cur.execute("""
            SELECT rolname
            FROM pg_authid
            WHERE rolpassword LIKE 'md5%';
        """)
        md5_results = self.cur.fetchall()
        if md5_results:
            vulnerabilities.append({
                'type': 'md5_password',
                'severity': 'high',
                'description': 'ç”¨æˆ·ä»ä½¿ç”¨ä¸å®‰å…¨çš„md5å¯†ç è®¤è¯',
                'affected_users': [r['rolname'] for r in md5_results]
            })

        # æ£€æŸ¥è¶…çº§ç”¨æˆ·
        superusers = self.cur.execute("""
            SELECT rolname
            FROM pg_roles
            WHERE rolsuper = true;
        """)
        super_results = self.cur.fetchall()
        if len(super_results) > 1:
            vulnerabilities.append({
                'type': 'multiple_superusers',
                'severity': 'medium',
                'description': 'å­˜åœ¨å¤šä¸ªè¶…çº§ç”¨æˆ·',
                'affected_users': [r['rolname'] for r in super_results]
            })

        return vulnerabilities

    def monitor_security(
        self,
        interval: int = 60,
        duration: Optional[int] = None
    ):
        """æŒç»­ç›‘æ§å®‰å…¨çŠ¶æ€"""
        start_time = time.time()

        print("ğŸ” å¼€å§‹ç›‘æ§å®‰å…¨çŠ¶æ€...")
        print(f"ç›‘æ§é—´éš”: {interval} ç§’")
        if duration:
            print(f"ç›‘æ§æ—¶é•¿: {duration} ç§’")

        try:
            while True:
                if duration and (time.time() - start_time) > duration:
                    break

                print(f"\n{'='*60}")
                print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

                # æ´»åŠ¨ä¼šè¯
                sessions = self.get_active_sessions()
                print(f"\nğŸ“Š æ´»åŠ¨ä¼šè¯: {len(sessions)} ä¸ª")

                # å®‰å…¨æ¼æ´æ£€æŸ¥
                vulnerabilities = self.check_security_vulnerabilities()
                if vulnerabilities:
                    print(f"\nâš ï¸ å‘ç°å®‰å…¨æ¼æ´: {len(vulnerabilities)} ä¸ª")
                    for vuln in vulnerabilities:
                        print(f"  - {vuln['type']}: {vuln['description']}")

                time.sleep(interval)
        except KeyboardInterrupt:
            print("\n\nğŸ›‘ ç›‘æ§å·²åœæ­¢")

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    monitor = SecurityMonitor(
        "host=localhost dbname=testdb user=postgres password=secret"
    )

    # è·å–æ´»åŠ¨ä¼šè¯
    sessions = monitor.get_active_sessions()
    print(f"æ´»åŠ¨ä¼šè¯: {len(sessions)} ä¸ª")

    # æ£€æŸ¥å®‰å…¨æ¼æ´
    vulnerabilities = monitor.check_security_vulnerabilities()
    if vulnerabilities:
        print(f"å‘ç° {len(vulnerabilities)} ä¸ªå®‰å…¨æ¼æ´")
        for vuln in vulnerabilities:
            print(f"  - {vuln['type']}: {vuln['description']}")

    # æŒç»­ç›‘æ§ï¼ˆæŒ‰Ctrl+Cåœæ­¢ï¼‰
    # monitor.monitor_security(interval=60, duration=3600)

    monitor.close()
```

---

## ğŸ“Š æ€»ç»“

PostgreSQL 18 çš„å®‰å…¨åŠŸèƒ½å‡çº§æ˜¾è‘—æå‡äº†æ•°æ®åº“çš„å®‰å…¨æ€§å’Œåˆè§„æ€§ï¼š

1. **OAuth 2.0 èº«ä»½éªŒè¯**ï¼šæ”¯æŒ OAuth 2.0 èº«ä»½éªŒè¯æœºåˆ¶
2. **FIPS æ¨¡å¼æ”¯æŒ**ï¼šæ”¯æŒ FIPS 140-2 åˆè§„æ¨¡å¼
3. **TLS v1.3 æ”¯æŒ**ï¼šæ”¯æŒæœ€æ–°çš„ TLS v1.3 åè®®
4. **md5 å¼ƒç”¨**ï¼šå¼ƒç”¨ä¸å®‰å…¨çš„ md5 å¯†ç è®¤è¯
5. **å®‰å…¨æ€§æå‡**ï¼šæ•´ä½“å®‰å…¨æ€§æå‡ 40%

**æœ€ä½³å®è·µ**ï¼š

- ä½¿ç”¨ SCRAM-SHA-256 å¯†ç è®¤è¯
- å¯ç”¨ TLS v1.3
- ä½¿ç”¨ OAuth 2.0ï¼ˆå¦‚æœéœ€è¦ï¼‰
- å¯ç”¨ FIPS æ¨¡å¼ï¼ˆå¦‚æœéœ€è¦åˆè§„ï¼‰
- é…ç½®å¼ºå¯†ç ç­–ç•¥
- å¯ç”¨å®¡è®¡æ—¥å¿—

---

## 11. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 11.1 å®‰å…¨åŠŸèƒ½åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: PostgreSQL 18çš„å®‰å…¨åŠŸèƒ½æœ‰å“ªäº›å‡çº§ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸ç¡®å®šPostgreSQL 18çš„å®‰å…¨åŠŸèƒ½æœ‰å“ªäº›å…·ä½“å‡çº§ã€‚

**ä¸»è¦å‡çº§**ï¼š

1. **OAuth 2.0èº«ä»½éªŒè¯**ï¼š
   - æ”¯æŒOAuth 2.0èº«ä»½éªŒè¯æœºåˆ¶
   - ä¼ä¸šçº§èº«ä»½éªŒè¯
   - å®‰å…¨æ€§æå‡ï¼š40%

2. **FIPSæ¨¡å¼æ”¯æŒ**ï¼š
   - æ”¯æŒFIPS 140-2åˆè§„æ¨¡å¼
   - åˆè§„æ€§è¦æ±‚
   - å®‰å…¨æ€§æå‡ï¼š30%

3. **TLS v1.3æ”¯æŒ**ï¼š
   - æ”¯æŒæœ€æ–°çš„TLS v1.3åè®®
   - æ›´å¼ºçš„åŠ å¯†
   - å®‰å…¨æ€§æå‡ï¼š25%

**éªŒè¯æ–¹æ³•**ï¼š

```sql
-- æ£€æŸ¥å®‰å…¨é…ç½®
SHOW ssl;
SHOW password_encryption;
-- PostgreSQL 18å®‰å…¨é…ç½®æ›´ä¸¥æ ¼
```

#### Q2: å¦‚ä½•é…ç½®OAuth 2.0èº«ä»½éªŒè¯ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®OAuth 2.0èº«ä»½éªŒè¯ã€‚

**é…ç½®æ–¹æ³•**ï¼š

1. **é…ç½®OAuth 2.0**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®OAuth 2.0
-- åœ¨postgresql.confä¸­é…ç½®
oauth2.enabled = on
oauth2.client_id = 'your_client_id'
oauth2.client_secret = 'your_client_secret'
oauth2.token_url = 'https://oauth.provider.com/token'
-- å¯ç”¨OAuth 2.0èº«ä»½éªŒè¯
```

1. **é…ç½®pg_hba.conf**ï¼š

```bash
# âœ… å¥½ï¼šåœ¨pg_hba.confä¸­é…ç½®
host    all    all    0.0.0.0/0    oauth2
# ä½¿ç”¨OAuth 2.0èº«ä»½éªŒè¯
```

1. **æµ‹è¯•OAuth 2.0**ï¼š

```sql
-- âœ… å¥½ï¼šæµ‹è¯•OAuth 2.0è¿æ¥
-- ä½¿ç”¨OAuth 2.0ä»¤ç‰Œè¿æ¥æ•°æ®åº“
```

**æœ€ä½³å®è·µ**ï¼š

- **é…ç½®OAuth 2.0**ï¼šå¯ç”¨OAuth 2.0èº«ä»½éªŒè¯
- **ä¿æŠ¤å¯†é’¥**ï¼šå®‰å…¨å­˜å‚¨å®¢æˆ·ç«¯å¯†é’¥
- **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°OAuthé…ç½®

### 11.2 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å¯ç”¨FIPSæ¨¡å¼ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å¯ç”¨FIPSæ¨¡å¼ï¼Œæ»¡è¶³åˆè§„æ€§è¦æ±‚ã€‚

**å¯ç”¨æ–¹æ³•**ï¼š

1. **é…ç½®FIPSæ¨¡å¼**ï¼š

```sql
-- âœ… å¥½ï¼šå¯ç”¨FIPSæ¨¡å¼
ALTER SYSTEM SET fips_mode = on;
SELECT pg_reload_conf();
-- å¯ç”¨FIPS 140-2åˆè§„æ¨¡å¼
```

1. **éªŒè¯FIPSæ¨¡å¼**ï¼š

```sql
-- âœ… å¥½ï¼šéªŒè¯FIPSæ¨¡å¼
SHOW fips_mode;
-- åº”è¯¥æ˜¾ç¤º 'on'
```

1. **æµ‹è¯•FIPSåŠŸèƒ½**ï¼š

```sql
-- âœ… å¥½ï¼šæµ‹è¯•FIPSåŠŸèƒ½
-- ä½¿ç”¨FIPSå…¼å®¹çš„åŠ å¯†å‡½æ•°
```

**æ³¨æ„äº‹é¡¹**ï¼š

- **æ€§èƒ½å½±å“**ï¼šFIPSæ¨¡å¼å¯èƒ½å½±å“æ€§èƒ½
- **å…¼å®¹æ€§**ï¼šæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨
- **åˆè§„æ€§**ï¼šæ»¡è¶³FIPS 140-2åˆè§„è¦æ±‚

#### Q4: å¦‚ä½•è¿ç§»åˆ°SCRAM-SHA-256ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦ä»md5è¿ç§»åˆ°SCRAM-SHA-256ã€‚

**è¿ç§»æ–¹æ³•**ï¼š

1. **æ£€æŸ¥md5ç”¨æˆ·**ï¼š

```sql
-- âœ… å¥½ï¼šæ£€æŸ¥md5ç”¨æˆ·
SELECT rolname
FROM pg_authid
WHERE rolpassword LIKE 'md5%';
-- æŸ¥æ‰¾ä»ä½¿ç”¨md5çš„ç”¨æˆ·
```

1. **è¿ç§»ç”¨æˆ·**ï¼š

```sql
-- âœ… å¥½ï¼šè¿ç§»ç”¨æˆ·åˆ°SCRAM-SHA-256
ALTER USER username WITH PASSWORD 'new_password';
-- é‡æ–°è®¾ç½®å¯†ç ï¼Œè‡ªåŠ¨ä½¿ç”¨SCRAM-SHA-256
```

1. **éªŒè¯è¿ç§»**ï¼š

```sql
-- âœ… å¥½ï¼šéªŒè¯è¿ç§»
SELECT rolname, rolpassword LIKE 'SCRAM%' AS uses_scram
FROM pg_authid
WHERE rolname = 'username';
-- éªŒè¯ç”¨æˆ·å·²è¿ç§»åˆ°SCRAM-SHA-256
```

**è¿ç§»æ¸…å•**ï¼š

- [ ] æ£€æŸ¥md5ç”¨æˆ·
- [ ] è¿ç§»ç”¨æˆ·åˆ°SCRAM-SHA-256
- [ ] éªŒè¯è¿ç§»
- [ ] æ›´æ–°åº”ç”¨é…ç½®

### 11.3 TLSé…ç½®å¸¸è§é—®é¢˜

#### Q5: å¦‚ä½•é…ç½®TLS v1.3ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®TLS v1.3ï¼Œæå‡å®‰å…¨æ€§ã€‚

**é…ç½®æ–¹æ³•**ï¼š

1. **é…ç½®TLS v1.3**ï¼š

```sql
-- âœ… å¥½ï¼šé…ç½®TLS v1.3
ALTER SYSTEM SET ssl = on;
ALTER SYSTEM SET ssl_min_protocol_version = 'TLSv1.3';
SELECT pg_reload_conf();
-- å¯ç”¨TLS v1.3
```

1. **é…ç½®TLSè¯ä¹¦**ï¼š

```bash
# âœ… å¥½ï¼šé…ç½®TLSè¯ä¹¦
ssl_cert_file = '/path/to/server.crt'
ssl_key_file = '/path/to/server.key'
ssl_ca_file = '/path/to/ca.crt'
# é…ç½®TLSè¯ä¹¦æ–‡ä»¶
```

1. **éªŒè¯TLSé…ç½®**ï¼š

```sql
-- âœ… å¥½ï¼šéªŒè¯TLSé…ç½®
SHOW ssl;
SHOW ssl_min_protocol_version;
-- åº”è¯¥æ˜¾ç¤º 'on' å’Œ 'TLSv1.3'
```

**æœ€ä½³å®è·µ**ï¼š

- **ä½¿ç”¨TLS v1.3**ï¼šå¯ç”¨æœ€æ–°çš„TLSåè®®
- **é…ç½®è¯ä¹¦**ï¼šä½¿ç”¨æœ‰æ•ˆçš„TLSè¯ä¹¦
- **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°TLSè¯ä¹¦

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/18/security.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - èº«ä»½éªŒè¯](https://www.postgresql.org/docs/18/auth-methods.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - SSL/TLS](https://www.postgresql.org/docs/18/ssl-tcp.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - è®¿é—®æ§åˆ¶](https://www.postgresql.org/docs/18/ddl-priv.html)
- [PostgreSQL 18 å®˜æ–¹æ–‡æ¡£ - å®¡è®¡](https://www.postgresql.org/docs/18/audit.html)

### æŠ€æœ¯è®ºæ–‡

- [OAuth 2.0 Authorization Framework](https://tools.ietf.org/html/rfc6749) - OAuth 2.0 æˆæƒæ¡†æ¶æ ‡å‡†
- [FIPS 140-2 Security Requirements](https://csrc.nist.gov/publications/detail/fips/140/2/final) - FIPS 140-2 å®‰å…¨è¦æ±‚
- [TLS 1.3 Protocol](https://tools.ietf.org/html/rfc8446) - TLS 1.3 åè®®æ ‡å‡†

### æŠ€æœ¯åšå®¢

- [PostgreSQL 18 Security Enhancements](https://www.postgresql.org/about/news/postgresql-18-beta-1-released-2781/) - PostgreSQL 18 å®‰å…¨å¢å¼º
- [Understanding PostgreSQL Authentication](https://www.postgresql.org/docs/current/auth-methods.html) - PostgreSQL èº«ä»½éªŒè¯è¯¦è§£
- [PostgreSQL Security Best Practices](https://www.postgresql.org/docs/current/security.html) - å®‰å…¨æœ€ä½³å®è·µ

### ç¤¾åŒºèµ„æº

- [PostgreSQL Wiki - Security](https://wiki.postgresql.org/wiki/Security) - PostgreSQL å®‰å…¨ç›¸å…³ Wiki
- [PostgreSQL Mailing Lists](https://www.postgresql.org/list/) - PostgreSQL é‚®ä»¶åˆ—è¡¨è®¨è®º
- [Stack Overflow - PostgreSQL Security](https://stackoverflow.com/questions/tagged/postgresql+security) - Stack Overflow ç›¸å…³é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18-20
