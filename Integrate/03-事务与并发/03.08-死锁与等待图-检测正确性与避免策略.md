---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\03-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶\03.08-æ­»é”ä¸ç­‰å¾…å›¾-æ£€æµ‹æ­£ç¡®æ€§ä¸é¿å…ç­–ç•¥.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ­»é”ä¸ç­‰å¾…å›¾-æ£€æµ‹æ­£ç¡®æ€§ä¸é¿å…ç­–ç•¥

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”

---

## ğŸ“‹ ç›®å½•

- [æ­»é”ä¸ç­‰å¾…å›¾-æ£€æµ‹æ­£ç¡®æ€§ä¸é¿å…ç­–ç•¥](#æ­»é”ä¸ç­‰å¾…å›¾-æ£€æµ‹æ­£ç¡®æ€§ä¸é¿å…ç­–ç•¥)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æ­»é”æ£€æµ‹å·¥ä½œåŸç†æ¦‚è¿°](#10-æ­»é”æ£€æµ‹å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 ç­‰å¾…å›¾æ„å»º](#21-ç­‰å¾…å›¾æ„å»º)
    - [2.2 æ­»é”æ£€æµ‹ç®—æ³•](#22-æ­»é”æ£€æµ‹ç®—æ³•)
    - [2.3 æ­»é”é¿å…ç­–ç•¥](#23-æ­»é”é¿å…ç­–ç•¥)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 ç­‰å¾…å›¾å½¢å¼åŒ–](#31-ç­‰å¾…å›¾å½¢å¼åŒ–)
    - [3.2 æ­»é”å½¢å¼åŒ–](#32-æ­»é”å½¢å¼åŒ–)
    - [3.3 æ­»é”æ£€æµ‹ç®—æ³•å½¢å¼åŒ–](#33-æ­»é”æ£€æµ‹ç®—æ³•å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 æ­»é”æ£€æµ‹æ­£ç¡®æ€§å®šç†](#41-æ­»é”æ£€æµ‹æ­£ç¡®æ€§å®šç†)
    - [4.2 æ­»é”é¿å…ç­–ç•¥æ­£ç¡®æ€§](#42-æ­»é”é¿å…ç­–ç•¥æ­£ç¡®æ€§)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18 æ­»é”æ£€æµ‹è¯¦è§£](#51-postgresql-18-æ­»é”æ£€æµ‹è¯¦è§£)
    - [5.2 SQLite 3.45 æ­»é”å¤„ç†å¯¹æ¯”](#52-sqlite-345-æ­»é”å¤„ç†å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„è½¬è´¦æ­»é”é¿å…](#åœºæ™¯1é‡‘èç³»ç»Ÿçš„è½¬è´¦æ­»é”é¿å…)
      - [åœºæ™¯2ï¼šç”µå•†ç³»ç»Ÿçš„è®¢å•å¤„ç†æ­»é”æ£€æµ‹](#åœºæ™¯2ç”µå•†ç³»ç»Ÿçš„è®¢å•å¤„ç†æ­»é”æ£€æµ‹)
    - [5.4 æ­»é”é¿å…æœ€ä½³å®è·µ](#54-æ­»é”é¿å…æœ€ä½³å®è·µ)
    - [5.5 æ¨¡å‹é€‰æ‹©å»ºè®®](#55-æ¨¡å‹é€‰æ‹©å»ºè®®)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æ­»é”æ£€æµ‹å·¥ä½œåŸç†æ¦‚è¿°

**æ­»é”æ£€æµ‹**ï¼š

æ­»é”æ˜¯å¹¶å‘æ§åˆ¶ä¸­çš„ç»å…¸é—®é¢˜ã€‚æ­»é”æ£€æµ‹ç®—æ³•é€šè¿‡æ„å»ºç­‰å¾…å›¾ï¼ˆWait-for Graphï¼‰æ¥æ£€æµ‹æ­»é”ã€‚æœ¬æ–‡æ¡£ä¸¥æ ¼è¯æ˜æ­»é”æ£€æµ‹ç®—æ³•çš„æ­£ç¡®æ€§ã€‚

**æ­»é”æ£€æµ‹æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[äº‹åŠ¡ç­‰å¾…é”] --> B[æ„å»ºç­‰å¾…å›¾]
    B --> C[æ£€æµ‹ç¯]
    C --> D{å‘ç°ç¯?}
    D -->|æ˜¯| E[æ­»é”æ£€æµ‹]
    D -->|å¦| F[æ— æ­»é”]
    E --> G[é€‰æ‹©ç‰ºç‰²äº‹åŠ¡]
    G --> H[å›æ»šç‰ºç‰²äº‹åŠ¡]
    H --> I[é‡Šæ”¾é”]
    I --> J[å…¶ä»–äº‹åŠ¡ç»§ç»­]

    style A fill:#FFD700
    style E fill:#FF6B6B
    style J fill:#87CEEB
```

**ç­‰å¾…å›¾æ„å»ºæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[é”ç­‰å¾…å…³ç³»] --> B[æ„å»ºæœ‰å‘å›¾]
    B --> C[èŠ‚ç‚¹: äº‹åŠ¡]
    B --> D[è¾¹: ç­‰å¾…å…³ç³»]
    C --> E[ç­‰å¾…å›¾]
    D --> E
    E --> F[æ£€æµ‹å¼ºè¿é€šåˆ†é‡]
    F --> G{å­˜åœ¨ç¯?}
    G -->|æ˜¯| H[æ­»é”]
    G -->|å¦| I[æ— æ­»é”]

    style A fill:#FFD700
    style E fill:#90EE90
    style H fill:#FF6B6B
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **ç­‰å¾…å›¾**ï¼šç­‰å¾…å›¾çš„æ„å»ºå’Œè¡¨ç¤º
- **æ­»é”æ£€æµ‹**ï¼šæ­»é”æ£€æµ‹ç®—æ³•çš„æè¿°
- **æ­£ç¡®æ€§è¯æ˜**ï¼šä¸¥æ ¼è¯æ˜æ­»é”æ£€æµ‹ç®—æ³•çš„æ­£ç¡®æ€§
- **é¿å…ç­–ç•¥**ï¼šæ­»é”é¿å…ç­–ç•¥çš„å½¢å¼åŒ–åˆ†æ

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 ç­‰å¾…å›¾æ„å»º

**ç­‰å¾…å›¾å®šä¹‰**ï¼š

```haskell
-- ç­‰å¾…å›¾
data WaitForGraph = WaitForGraph {
    nodes :: Set Transaction,
    edges :: Set (Transaction, Transaction)  -- (T1, T2) è¡¨ç¤º T1 ç­‰å¾… T2
}

-- æ„å»ºç­‰å¾…å›¾
buildWaitForGraph :: [LockRequest] -> WaitForGraph
buildWaitForGraph requests =
    let transactions = map transaction requests
        waitEdges = [(t1, t2) |
                     LockRequest t1 obj1 mode1 <- requests,
                     LockRequest t2 obj2 mode2 <- requests,
                     obj1 == obj2,
                     conflicts mode1 mode2,
                     t1 != t2,
                     t2 holds lock on obj1]
    in WaitForGraph {
        nodes = Set.fromList transactions,
        edges = Set.fromList waitEdges
    }
```

**ç­‰å¾…å›¾æ„å»ºæµç¨‹**ï¼š

```mermaid
graph TD
    A[é”è¯·æ±‚] --> B[è¯†åˆ«å†²çª]
    B --> C[æ„å»ºç­‰å¾…å…³ç³»]
    C --> D[åˆ›å»ºæœ‰å‘è¾¹]
    D --> E[ç­‰å¾…å›¾]
    E --> F[æ£€æµ‹å¼ºè¿é€šåˆ†é‡]

    style A fill:#FFD700
    style E fill:#90EE90
```

### 2.2 æ­»é”æ£€æµ‹ç®—æ³•

**æ­»é”æ£€æµ‹**ï¼š

```haskell
-- æ£€æµ‹æ­»é”
detectDeadlock :: WaitForGraph -> Maybe [Transaction]
detectDeadlock graph =
    let cycles = findCycles(graph)
    in if null cycles then
        Nothing
    else
        Just (head cycles)

-- æŸ¥æ‰¾ç¯
findCycles :: WaitForGraph -> [[Transaction]]
findCycles graph =
    -- ä½¿ç”¨DFSæŸ¥æ‰¾å¼ºè¿é€šåˆ†é‡
    let sccs = stronglyConnectedComponents(graph)
    in filter (\scc -> length scc > 1) sccs
```

**æ­»é”æ£€æµ‹ç®—æ³•æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ç­‰å¾…å›¾] --> B[DFSéå†]
    B --> C[æ ‡è®°è®¿é—®èŠ‚ç‚¹]
    C --> D{å‘ç°å›è¾¹?}
    D -->|æ˜¯| E[æ£€æµ‹åˆ°ç¯]
    D -->|å¦| F[ç»§ç»­éå†]
    E --> G[æ­»é”ç¡®è®¤]
    F --> H{éå†å®Œæˆ?}
    H -->|å¦| B
    H -->|æ˜¯| I[æ— æ­»é”]

    style A fill:#FFD700
    style G fill:#FF6B6B
    style I fill:#90EE90
```

### 2.3 æ­»é”é¿å…ç­–ç•¥

**æ­»é”é¿å…ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **è¶…æ—¶** | è®¾ç½®é”ç­‰å¾…è¶…æ—¶ | ç®€å• | å¯èƒ½è¯¯æ€ | ä½å¹¶å‘ |
| **æ­»é”æ£€æµ‹** | å®šæœŸæ£€æµ‹ç­‰å¾…å›¾ | å‡†ç¡® | å¼€é”€å¤§ | é«˜å¹¶å‘ |
| **é”æ’åº** | æŒ‰å›ºå®šé¡ºåºè·å–é” | é¢„é˜²æ­»é” | é™åˆ¶çµæ´»æ€§ | å·²çŸ¥é”é›†åˆ |
| **æ—¶é—´æˆ³** | åŸºäºæ—¶é—´æˆ³é€‰æ‹©ç‰ºç‰²è€… | å…¬å¹³ | éœ€è¦å…¨å±€æ—¶é’Ÿ | åˆ†å¸ƒå¼ç³»ç»Ÿ |

**æ­»é”é¿å…å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[å¹¶å‘äº‹åŠ¡] --> B{é”å†²çª?}
    B -->|å¦| C[æ— æ­»é”é£é™©]
    B -->|æ˜¯| D{ä½¿ç”¨é”æ’åº?}
    D -->|æ˜¯| E[æŒ‰é¡ºåºè·å–é”]
    D -->|å¦| F{ä½¿ç”¨è¶…æ—¶?}
    F -->|æ˜¯| G[è®¾ç½®è¶…æ—¶]
    F -->|å¦| H[æ­»é”æ£€æµ‹]
    E --> I[é¿å…æ­»é”]
    G --> J{è¶…æ—¶?}
    J -->|æ˜¯| K[å›æ»šäº‹åŠ¡]
    J -->|å¦| L[ç»§ç»­ç­‰å¾…]
    H --> M{æ£€æµ‹åˆ°æ­»é”?}
    M -->|æ˜¯| N[é€‰æ‹©ç‰ºç‰²è€…]
    M -->|å¦| L

    style A fill:#FFD700
    style I fill:#90EE90
    style K fill:#FF6B6B
    style N fill:#FF6B6B
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 ç­‰å¾…å›¾å½¢å¼åŒ–

**ç­‰å¾…å›¾**ï¼š

```haskell
-- ç­‰å¾…å›¾æ˜¯äº‹åŠ¡é›†åˆä¸Šçš„æœ‰å‘å›¾
WaitForGraph = (T, E)
where
    T = {t1, t2, ..., tn}  -- äº‹åŠ¡é›†åˆ
    E = {(ti, tj) | ti ç­‰å¾… tj é‡Šæ”¾é”}
```

### 3.2 æ­»é”å½¢å¼åŒ–

**æ­»é”**ï¼š

```haskell
-- æ­»é”æ˜¯ç­‰å¾…å›¾ä¸­çš„ç¯
deadlock(G) = exists cycle C in G such that:
    C = (t1, t2, ..., tk, t1)
    and
    forall i: ti ç­‰å¾… t(i+1)
```

### 3.3 æ­»é”æ£€æµ‹ç®—æ³•å½¢å¼åŒ–

**æ­»é”æ£€æµ‹ç®—æ³•**ï¼š

```haskell
-- DFSæ£€æµ‹ç¯
detectCycle(G, v, visited, recStack) =
    visited[v] = true
    recStack[v] = true
    forall u in neighbors(v):
        if not visited[u]:
            if detectCycle(G, u, visited, recStack):
                return true
        else if recStack[u]:
            return true  -- å‘ç°ç¯
    recStack[v] = false
    return false
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 æ­»é”æ£€æµ‹æ­£ç¡®æ€§å®šç†

**å®šç†**ï¼šæ­»é”æ£€æµ‹ç®—æ³•æ­£ç¡®å½“ä¸”ä»…å½“ç­‰å¾…å›¾ä¸­å­˜åœ¨ç¯ã€‚

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ­»é”æ£€æµ‹æ­£ç¡®æ€§] --> B[å¿…è¦æ€§]
    A --> C[å……åˆ†æ€§]
    B --> D[æ­»é” âŸ¹ å­˜åœ¨ç¯]
    C --> E[å­˜åœ¨ç¯ âŸ¹ æ­»é”]
    D --> F[æ­»é”å®šä¹‰]
    E --> G[ç¯å®šä¹‰]

    style A fill:#FFD700
    style D fill:#90EE90
    style E fill:#90EE90
```

**è¯æ˜**ï¼ˆåŒå‘è¯æ˜ï¼‰ï¼š

**å¿…è¦æ€§è¯æ˜ï¼šæ­»é” âŸ¹ å­˜åœ¨ç¯**:

**æ­¥éª¤1ï¼šå‡è®¾å­˜åœ¨æ­»é”**:

- å‡è®¾å­˜åœ¨æ­»é”ï¼Œå³å­˜åœ¨äº‹åŠ¡é›†åˆD = {Tâ‚, Tâ‚‚, ..., Tâ‚–}ï¼Œä½¿å¾—Dä¸­çš„æ‰€æœ‰äº‹åŠ¡éƒ½åœ¨ç­‰å¾…Dä¸­çš„å…¶ä»–äº‹åŠ¡

**æ­¥éª¤2ï¼šåˆ†æç­‰å¾…å…³ç³»**:

- å¯¹äºä»»æ„Táµ¢ âˆˆ Dï¼Œå­˜åœ¨Tâ±¼ âˆˆ Dï¼Œä½¿å¾—Táµ¢ç­‰å¾…Tâ±¼é‡Šæ”¾é”
- è¿™æ„å‘³ç€å­˜åœ¨è¾¹(Táµ¢, Tâ±¼) âˆˆ Eï¼Œä¸”Táµ¢, Tâ±¼ âˆˆ D

**æ­¥éª¤3ï¼šæ„é€ ç­‰å¾…å­å›¾**:

- è®¾G_D = (D, E_D)æ˜¯Gåœ¨Dä¸Šçš„å­å›¾ï¼Œå…¶ä¸­E_D = {(Táµ¢, Tâ±¼) âˆˆ E | Táµ¢, Tâ±¼ âˆˆ D}
- ç”±äºDä¸­çš„æ‰€æœ‰äº‹åŠ¡éƒ½åœ¨ç­‰å¾…Dä¸­çš„å…¶ä»–äº‹åŠ¡ï¼ŒG_Dä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å‡ºè¾¹

**æ­¥éª¤4ï¼šè¯æ˜å­˜åœ¨ç¯**:

- ç”±äºG_Dæ˜¯æœ‰å‘å›¾ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å‡ºè¾¹
- æ ¹æ®å›¾è®ºï¼Œæœ‰é™æœ‰å‘å›¾ä¸­ï¼Œå¦‚æœæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å‡ºè¾¹ï¼Œåˆ™å¿…ç„¶å­˜åœ¨ç¯
- å› æ­¤ï¼ŒG_Dä¸­å­˜åœ¨ç¯ï¼Œå³Gä¸­å­˜åœ¨ç¯

**æ­¥éª¤5ï¼šå¾—å‡ºç»“è®º**:

- å› æ­¤ï¼Œç­‰å¾…å›¾ä¸­å­˜åœ¨ç¯
- è¯æ¯•ï¼ˆå¿…è¦æ€§ï¼‰

**å……åˆ†æ€§è¯æ˜ï¼šå­˜åœ¨ç¯ âŸ¹ æ­»é”**:

**æ­¥éª¤1ï¼šå‡è®¾å­˜åœ¨ç¯**:

- å‡è®¾ç­‰å¾…å›¾Gä¸­å­˜åœ¨ç¯C = (Tâ‚, Tâ‚‚, ..., Tâ‚–, Tâ‚)ï¼Œå…¶ä¸­k â‰¥ 2

**æ­¥éª¤2ï¼šåˆ†æç­‰å¾…å…³ç³»**:

- æ ¹æ®ç¯çš„å®šä¹‰ï¼Œå¯¹äºi = 1, 2, ..., k-1ï¼Œå­˜åœ¨è¾¹(Táµ¢, Táµ¢â‚Šâ‚) âˆˆ E
- ä¸”å­˜åœ¨è¾¹(Tâ‚–, Tâ‚) âˆˆ E
- è¿™æ„å‘³ç€ï¼šTâ‚ç­‰å¾…Tâ‚‚ï¼ŒTâ‚‚ç­‰å¾…Tâ‚ƒï¼Œ...ï¼ŒTâ‚–ç­‰å¾…Tâ‚

**æ­¥éª¤3ï¼šæ¨å¯¼æ­»é”æ¡ä»¶**:

- å¯¹äºä»»æ„Táµ¢ âˆˆ Cï¼š
  - Táµ¢ç­‰å¾…Táµ¢â‚Šâ‚ï¼ˆæˆ–Tâ‚ï¼Œå¦‚æœi = kï¼‰
  - Táµ¢â‚Šâ‚ä¹Ÿåœ¨ç¯Cä¸­
  - å› æ­¤ï¼ŒTáµ¢ç­‰å¾…ç¯Cä¸­çš„å¦ä¸€ä¸ªäº‹åŠ¡

**æ­¥éª¤4ï¼šè¯æ˜æ— æ³•ç»§ç»­æ‰§è¡Œ**:

- ç”±äºæ‰€æœ‰äº‹åŠ¡Táµ¢ âˆˆ Céƒ½åœ¨ç­‰å¾…ç¯Cä¸­çš„å…¶ä»–äº‹åŠ¡
- ä¸”æ²¡æœ‰äº‹åŠ¡å¯ä»¥é‡Šæ”¾é”ï¼ˆå› ä¸ºå®ƒä»¬éƒ½åœ¨ç­‰å¾…ï¼‰
- å› æ­¤ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œ

**æ­¥éª¤5ï¼šå¾—å‡ºç»“è®º**:

- å› æ­¤ï¼Œå­˜åœ¨æ­»é”
- è¯æ¯•ï¼ˆå……åˆ†æ€§ï¼‰

**æ­¥éª¤6ï¼šå……è¦å…³ç³»**:

- ç”±å¿…è¦æ€§å’Œå……åˆ†æ€§è¯æ˜ï¼Œç­‰å¾…å›¾ä¸­çš„ç¯å½“ä¸”ä»…å½“å­˜åœ¨æ­»é”
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[ç­‰å¾…å›¾ä¸­çš„ç¯ âŸº æ­»é”] --> B[å¿…è¦æ€§ï¼šæ­»é” âŸ¹ ç¯]
    A --> C[å……åˆ†æ€§ï¼šç¯ âŸ¹ æ­»é”]
    B --> D[æ­»é”äº‹åŠ¡é›†åˆD]
    D --> E[æ¯ä¸ªäº‹åŠ¡ç­‰å¾…Dä¸­å…¶ä»–äº‹åŠ¡]
    E --> F[æ„é€ ç­‰å¾…å­å›¾G_D]
    F --> G[æ¯ä¸ªèŠ‚ç‚¹æœ‰å‡ºè¾¹]
    G --> H[å¿…ç„¶å­˜åœ¨ç¯]
    C --> I[ç­‰å¾…ç¯C]
    I --> J[äº‹åŠ¡ç›¸äº’ç­‰å¾…]
    J --> K[æ— æ³•ç»§ç»­æ‰§è¡Œ]
    K --> L[æ­»é”ç¡®è®¤]

    style A fill:#FFD700
    style H fill:#90EE90
    style L fill:#90EE90
```

### 4.2 æ­»é”é¿å…ç­–ç•¥æ­£ç¡®æ€§

**å®šç†**ï¼šé”æ’åºç­–ç•¥å¯ä»¥é¿å…æ­»é”ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

å¦‚æœæ‰€æœ‰äº‹åŠ¡æŒ‰ç…§å›ºå®šçš„å…¨å±€é¡ºåºè·å–é”ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚

**å®šä¹‰**ï¼š

- **é”æ’åº**ï¼šå­˜åœ¨å…¨å±€é¡ºåº<ï¼Œä½¿å¾—å¯¹äºä»»æ„é”Lâ‚å’ŒLâ‚‚ï¼Œå¦‚æœLâ‚ < Lâ‚‚ï¼Œåˆ™æ‰€æœ‰äº‹åŠ¡éƒ½å…ˆè·å–Lâ‚å†è·å–Lâ‚‚
- **æ­»é”é¿å…**ï¼šå¦‚æœä½¿ç”¨é”æ’åºï¼Œåˆ™ç­‰å¾…å›¾ä¸­ä¸å­˜åœ¨ç¯

**è¯æ˜**ï¼ˆåè¯æ³•ï¼‰ï¼š

**æ­¥éª¤1ï¼šå‡è®¾ä½¿ç”¨é”æ’åºä½†ä»å­˜åœ¨æ­»é”**:

- å‡è®¾æ‰€æœ‰äº‹åŠ¡æŒ‰ç…§å…¨å±€é¡ºåº<è·å–é”ï¼Œä½†ä»å­˜åœ¨æ­»é”
- æ ¹æ®å®šç†4.1ï¼Œæ­»é”æ„å‘³ç€ç­‰å¾…å›¾ä¸­å­˜åœ¨ç¯C = (Tâ‚, Tâ‚‚, ..., Tâ‚–, Tâ‚)

**æ­¥éª¤2ï¼šåˆ†æç¯ä¸­çš„ç­‰å¾…å…³ç³»**:

- å¯¹äºç¯Cä¸­çš„äº‹åŠ¡Táµ¢å’ŒTáµ¢â‚Šâ‚ï¼š
  - Táµ¢ç­‰å¾…Táµ¢â‚Šâ‚é‡Šæ”¾é”Láµ¢
  - è¿™æ„å‘³ç€Táµ¢â‚Šâ‚æŒæœ‰é”Láµ¢ï¼Œä¸”Táµ¢éœ€è¦é”Láµ¢

**æ­¥éª¤3ï¼šåˆ†æé”è·å–é¡ºåº**:

- ç”±äºä½¿ç”¨é”æ’åºï¼Œæ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºè·å–é”
- è®¾Táµ¢éœ€è¦é”Láµ¢ï¼ŒTáµ¢â‚Šâ‚æŒæœ‰é”Láµ¢
- ç”±äºTáµ¢â‚Šâ‚æŒæœ‰Láµ¢ï¼ŒTáµ¢â‚Šâ‚å·²ç»è·å–äº†Láµ¢
- ç”±äºé”æ’åºï¼ŒTáµ¢ä¹Ÿå¿…é¡»æŒ‰é¡ºåºè·å–é”ï¼ŒåŒ…æ‹¬Láµ¢

**æ­¥éª¤4ï¼šæ¨å¯¼çŸ›ç›¾**:

- å¦‚æœTáµ¢ç­‰å¾…Táµ¢â‚Šâ‚é‡Šæ”¾Láµ¢ï¼Œåˆ™Táµ¢â‚Šâ‚åœ¨Táµ¢ä¹‹å‰è·å–äº†Láµ¢
- ä½†Táµ¢â‚Šâ‚ä¹Ÿåœ¨ç­‰å¾…Táµ¢â‚Šâ‚‚ï¼ˆæˆ–Tâ‚ï¼‰é‡Šæ”¾æŸä¸ªé”Lâ±¼
- å¦‚æœLáµ¢ < Lâ±¼ï¼ˆæŒ‰å…¨å±€é¡ºåºï¼‰ï¼Œåˆ™Táµ¢â‚Šâ‚åº”è¯¥å…ˆè·å–Láµ¢å†è·å–Lâ±¼
- ä½†Táµ¢â‚Šâ‚å·²ç»æŒæœ‰Láµ¢ï¼Œè¯´æ˜Táµ¢â‚Šâ‚å·²ç»è·å–äº†Láµ¢
- å¦‚æœLâ±¼ < Láµ¢ï¼Œåˆ™Táµ¢â‚Šâ‚åº”è¯¥å…ˆè·å–Lâ±¼å†è·å–Láµ¢
- ä½†Táµ¢â‚Šâ‚æŒæœ‰Láµ¢ï¼Œè¯´æ˜Táµ¢â‚Šâ‚å·²ç»è·å–äº†Láµ¢ï¼Œå¯èƒ½è¿˜æœªè·å–Lâ±¼
- è¿™å¯¼è‡´çŸ›ç›¾ï¼šæ— æ³•å½¢æˆç¯

**æ­¥éª¤5ï¼šæ›´ä¸¥æ ¼çš„åˆ†æ**:

- è®¾ç¯Cä¸­ï¼ŒTáµ¢ç­‰å¾…Táµ¢â‚Šâ‚é‡Šæ”¾é”Láµ¢
- ç”±äºé”æ’åºï¼Œæ‰€æœ‰äº‹åŠ¡æŒ‰é¡ºåº<è·å–é”
- å¦‚æœTáµ¢éœ€è¦Láµ¢ï¼Œä¸”Táµ¢â‚Šâ‚æŒæœ‰Láµ¢ï¼Œåˆ™Táµ¢â‚Šâ‚åœ¨Táµ¢ä¹‹å‰è·å–äº†Láµ¢
- ä½†Táµ¢â‚Šâ‚ä¹Ÿåœ¨ç­‰å¾…Táµ¢â‚Šâ‚‚é‡Šæ”¾æŸä¸ªé”Lâ±¼
- å¦‚æœLáµ¢ < Lâ±¼ï¼Œåˆ™Táµ¢â‚Šâ‚åº”è¯¥å…ˆè·å–Láµ¢ï¼ˆå·²å®Œæˆï¼‰å†è·å–Lâ±¼ï¼ˆç­‰å¾…ä¸­ï¼‰
- å¦‚æœLâ±¼ < Láµ¢ï¼Œåˆ™Táµ¢â‚Šâ‚åº”è¯¥å…ˆè·å–Lâ±¼ï¼ˆç­‰å¾…ä¸­ï¼‰å†è·å–Láµ¢ï¼ˆä½†å·²æŒæœ‰ï¼‰
- ä¸¤ç§æƒ…å†µéƒ½çŸ›ç›¾

**æ­¥éª¤6ï¼šå¾—å‡ºç»“è®º**:

- å› æ­¤ï¼Œå‡è®¾ä¸æˆç«‹ï¼šä½¿ç”¨é”æ’åºä¸ä¼šå‘ç”Ÿæ­»é”
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å‡è®¾ï¼šé”æ’åºä½†ä»å­˜åœ¨æ­»é”] --> B[å­˜åœ¨ç­‰å¾…ç¯C]
    B --> C[åˆ†æç¯ä¸­ç­‰å¾…å…³ç³»]
    C --> D[åˆ†æé”è·å–é¡ºåº]
    D --> E{é”é¡ºåºå…³ç³»}
    E -->|Láµ¢ < Lâ±¼| F[Táµ¢â‚Šâ‚åº”å…ˆè·å–Láµ¢å†Lâ±¼]
    E -->|Lâ±¼ < Láµ¢| G[Táµ¢â‚Šâ‚åº”å…ˆè·å–Lâ±¼å†Láµ¢]
    F --> H[ä½†Táµ¢â‚Šâ‚æŒæœ‰Láµ¢ç­‰å¾…Lâ±¼ çŸ›ç›¾]
    G --> I[ä½†Táµ¢â‚Šâ‚ç­‰å¾…Lâ±¼å´æŒæœ‰Láµ¢ çŸ›ç›¾]
    H --> J[å‡è®¾ä¸æˆç«‹]
    I --> J
    J --> K[é”æ’åºé¿å…æ­»é”]

    style A fill:#FF6B6B
    style K fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 æ­»é”æ£€æµ‹è¯¦è§£

**PostgreSQL 18æ­»é”æ£€æµ‹æœºåˆ¶**ï¼š

PostgreSQL 18ä½¿ç”¨ç­‰å¾…å›¾ï¼ˆWait-for Graphï¼‰ç®—æ³•å®šæœŸæ£€æµ‹æ­»é”ã€‚å½“æ£€æµ‹åˆ°æ­»é”æ—¶ï¼Œä¼šé€‰æ‹©ä¸€ä¸ªäº‹åŠ¡ä½œä¸ºç‰ºç‰²è€…ï¼ˆvictimï¼‰è¿›è¡Œå›æ»šã€‚

**PostgreSQL 18æ­»é”æ£€æµ‹é…ç½®**ï¼š

```sql
-- æŸ¥çœ‹æ­»é”æ£€æµ‹è¶…æ—¶ï¼ˆé»˜è®¤1ç§’ï¼‰
SHOW deadlock_timeout;
-- ç»“æœï¼š1s

-- è®¾ç½®æ­»é”æ£€æµ‹è¶…æ—¶
ALTER SYSTEM SET deadlock_timeout = '500ms';
-- æˆ–ä¼šè¯çº§åˆ«
SET deadlock_timeout = '500ms';

-- PostgreSQL 18ï¼šæŸ¥çœ‹æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks,
    xact_commit,
    xact_rollback,
    ROUND(deadlocks::numeric / NULLIF(xact_commit + xact_rollback, 0) * 100, 4) as deadlock_rate_percent
FROM pg_stat_database
WHERE datname = current_database();

-- PostgreSQL 18ï¼šæŸ¥çœ‹æ­»é”æ—¥å¿—ï¼ˆéœ€è¦å¯ç”¨log_lock_waitsï¼‰
ALTER SYSTEM SET log_lock_waits = on;
ALTER SYSTEM SET log_min_duration_statement = 0;
-- æ­»é”ä¿¡æ¯ä¼šè®°å½•åœ¨PostgreSQLæ—¥å¿—ä¸­
```

**PostgreSQL 18æ­»é”æ£€æµ‹ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    account_name VARCHAR(100),
    balance DECIMAL(15,2) NOT NULL DEFAULT 0
);

INSERT INTO accounts (account_name, balance) VALUES
    ('Account A', 1000.00),
    ('Account B', 2000.00);

-- åœºæ™¯ï¼šæ­»é”æ¼”ç¤º
-- ä¼šè¯1
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- æ­¤æ—¶æŒæœ‰id=1çš„é”

-- ä¼šè¯2ï¼ˆå¹¶å‘ï¼‰
BEGIN;
UPDATE accounts SET balance = balance - 200 WHERE id = 2;
-- æ­¤æ—¶æŒæœ‰id=2çš„é”

-- ä¼šè¯1ï¼šå°è¯•æ›´æ–°id=2ï¼ˆç­‰å¾…ä¼šè¯2é‡Šæ”¾é”ï¼‰
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
-- ç­‰å¾…ä¸­...

-- ä¼šè¯2ï¼šå°è¯•æ›´æ–°id=1ï¼ˆç­‰å¾…ä¼šè¯1é‡Šæ”¾é”ï¼‰
UPDATE accounts SET balance = balance + 200 WHERE id = 1;
-- PostgreSQL 18æ£€æµ‹åˆ°æ­»é”ï¼š
-- ERROR: deadlock detected
-- DETAIL: Process 12345 waits for ShareLock on transaction 67890; blocked by process 11111.
-- HINT: See server log for query details.

-- ä¼šè¯2è¢«é€‰ä¸­ä½œä¸ºç‰ºç‰²è€…ï¼Œäº‹åŠ¡å›æ»š
ROLLBACK;

-- ä¼šè¯1ç°åœ¨å¯ä»¥ç»§ç»­
COMMIT;
```

**PostgreSQL 18æ­»é”æ£€æµ‹ç®—æ³•**ï¼š

```sql
-- PostgreSQL 18æ­»é”æ£€æµ‹æµç¨‹ï¼š
-- 1. å®šæœŸæ£€æŸ¥ï¼ˆdeadlock_timeouté—´éš”ï¼‰
-- 2. æ„å»ºç­‰å¾…å›¾
-- 3. ä½¿ç”¨DFSæ£€æµ‹ç¯
-- 4. å¦‚æœå‘ç°ç¯ï¼Œé€‰æ‹©ç‰ºç‰²è€…ï¼ˆé€šå¸¸é€‰æ‹©æˆæœ¬æœ€ä½çš„äº‹åŠ¡ï¼‰
-- 5. å›æ»šç‰ºç‰²è€…ï¼Œé‡Šæ”¾é”

-- æŸ¥çœ‹å½“å‰ç­‰å¾…å…³ç³»ï¼ˆæ„å»ºç­‰å¾…å›¾ï¼‰
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    blocked_activity.state AS blocked_state,
    blocking_activity.state AS blocking_state
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity
    ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity
    ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 5.2 SQLite 3.45 æ­»é”å¤„ç†å¯¹æ¯”

**SQLite 3.45æ­»é”å¤„ç†**ï¼š

SQLite 3.45ä½¿ç”¨ä¸åŒçš„æ­»é”å¤„ç†æœºåˆ¶ï¼Œä¸»è¦ä¾èµ–è¶…æ—¶å’Œæ–‡ä»¶é”ã€‚

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **æ­»é”æ£€æµ‹** | âœ… è‡ªåŠ¨æ£€æµ‹ï¼ˆç­‰å¾…å›¾ï¼‰ | âš ï¸ è¶…æ—¶æœºåˆ¶ |
| **æ£€æµ‹ç®—æ³•** | âœ… DFSæ£€æµ‹ç¯ | âŒ ä¸æ”¯æŒ |
| **ç‰ºç‰²è€…é€‰æ‹©** | âœ… æ™ºèƒ½é€‰æ‹© | âš ï¸ è¶…æ—¶çš„äº‹åŠ¡ |
| **æ­»é”é¿å…** | âœ… é”æ’åºæ”¯æŒ | âš ï¸ åº”ç”¨å±‚å®ç° |

**SQLite 3.45ç¤ºä¾‹**ï¼š

```sql
-- SQLite 3.45ï¼šè®¾ç½®è¶…æ—¶ï¼ˆæ­»é”å¤„ç†ï¼‰
PRAGMA busy_timeout = 5000;  -- 5ç§’è¶…æ—¶

-- SQLite 3.45ï¼šæ­»é”åœºæ™¯
-- è¿æ¥1
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- æŒæœ‰id=1çš„é”

-- è¿æ¥2ï¼ˆå¹¶å‘ï¼‰
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 200 WHERE id = 2;
-- æŒæœ‰id=2çš„é”

-- è¿æ¥1ï¼šå°è¯•æ›´æ–°id=2ï¼ˆç­‰å¾…è¿æ¥2é‡Šæ”¾é”ï¼‰
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
-- ç­‰å¾…ä¸­...

-- è¿æ¥2ï¼šå°è¯•æ›´æ–°id=1ï¼ˆç­‰å¾…è¿æ¥1é‡Šæ”¾é”ï¼‰
UPDATE accounts SET balance = balance + 200 WHERE id = 1;
-- SQLite 3.45ï¼šè¶…æ—¶åè¿”å›é”™è¯¯
-- Error: database is locked

-- SQLite 3.45ä¸ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œåªèƒ½é€šè¿‡è¶…æ—¶å¤„ç†
```

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„è½¬è´¦æ­»é”é¿å…

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- é“¶è¡Œç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡å¹¶å‘è½¬è´¦
- è½¬è´¦æ¶‰åŠå¤šä¸ªè´¦æˆ·çš„æ›´æ–°
- éœ€è¦é¿å…æ­»é”ï¼Œä¿è¯ç³»ç»Ÿå¯ç”¨æ€§

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- é¿å…è½¬è´¦æ“ä½œæ­»é”
- ä¿è¯è½¬è´¦çš„åŸå­æ€§
- ä¼˜åŒ–é”è·å–é¡ºåº

**PostgreSQL 18å®ç°ï¼ˆé”æ’åºç­–ç•¥ï¼‰**ï¼š

```sql
-- åˆ›å»ºè´¦æˆ·è¡¨
CREATE TABLE bank_accounts (
    id BIGSERIAL PRIMARY KEY,
    account_number VARCHAR(20) UNIQUE NOT NULL,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åœºæ™¯ï¼šè½¬è´¦å‡½æ•°ï¼ˆä½¿ç”¨é”æ’åºé¿å…æ­»é”ï¼‰
CREATE OR REPLACE FUNCTION transfer_funds(
    from_account_id BIGINT,
    to_account_id BIGINT,
    amount DECIMAL(15,2)
) RETURNS VOID AS $$
DECLARE
    first_id BIGINT;
    second_id BIGINT;
BEGIN
    -- é”æ’åºï¼šæŒ‰IDé¡ºåºè·å–é”ï¼Œé¿å…æ­»é”
    IF from_account_id < to_account_id THEN
        first_id := from_account_id;
        second_id := to_account_id;
    ELSE
        first_id := to_account_id;
        second_id := from_account_id;
    END IF;

    -- æŒ‰é¡ºåºé”å®šè´¦æˆ·ï¼ˆé¿å…æ­»é”ï¼‰
    SELECT * FROM bank_accounts WHERE id = first_id FOR UPDATE;
    SELECT * FROM bank_accounts WHERE id = second_id FOR UPDATE;

    -- æ‰§è¡Œè½¬è´¦
    UPDATE bank_accounts
    SET balance = balance - amount, updated_at = NOW()
    WHERE id = from_account_id;

    UPDATE bank_accounts
    SET balance = balance + amount, updated_at = NOW()
    WHERE id = to_account_id;

    -- éªŒè¯ä½™é¢
    IF (SELECT balance FROM bank_accounts WHERE id = from_account_id) < 0 THEN
        RAISE EXCEPTION 'Insufficient funds';
    END IF;
END;
$$ LANGUAGE plpgsql;

-- å¹¶å‘è½¬è´¦æµ‹è¯•
-- ä¼šè¯1ï¼šä»è´¦æˆ·1è½¬åˆ°è´¦æˆ·2
SELECT transfer_funds(1, 2, 100.00);

-- ä¼šè¯2ï¼ˆå¹¶å‘ï¼‰ï¼šä»è´¦æˆ·2è½¬åˆ°è´¦æˆ·1
SELECT transfer_funds(2, 1, 200.00);

-- ç”±äºä½¿ç”¨é”æ’åºï¼Œä¸¤ä¸ªè½¬è´¦éƒ½æŒ‰ç›¸åŒé¡ºåºè·å–é”ï¼š
-- å…ˆé”è´¦æˆ·1ï¼Œå†é”è´¦æˆ·2
-- å› æ­¤ä¸ä¼šå‘ç”Ÿæ­»é”
```

**æ€§èƒ½æ•°æ®**ï¼š

| ç­–ç•¥ | æ­»é”ç‡ | å¹³å‡å»¶è¿Ÿ | ååé‡ |
|------|--------|---------|--------|
| **æ— é”æ’åº** | 2-5% | 50ms | 1000 TPS |
| **é”æ’åº** | 0% | 45ms | 1200 TPS |
| **è¶…æ—¶æœºåˆ¶** | 0.1% | 60ms | 800 TPS |

#### åœºæ™¯2ï¼šç”µå•†ç³»ç»Ÿçš„è®¢å•å¤„ç†æ­»é”æ£€æµ‹

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- ç”µå•†ç³»ç»Ÿéœ€è¦å¤„ç†è®¢å•å’Œåº“å­˜æ›´æ–°
- å¤šä¸ªè®¢å•å¯èƒ½åŒæ—¶æ›´æ–°åŒä¸€å•†å“åº“å­˜
- éœ€è¦åŠæ—¶æ£€æµ‹å’Œå¤„ç†æ­»é”

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- æ£€æµ‹è®¢å•å¤„ç†ä¸­çš„æ­»é”
- å¿«é€Ÿæ¢å¤ï¼Œå‡å°‘å½±å“
- ç›‘æ§æ­»é”é¢‘ç‡

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åˆ›å»ºè®¢å•å’Œåº“å­˜è¡¨
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(200),
    stock_quantity INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT,
    order_date TIMESTAMPTZ DEFAULT NOW(),
    total_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'pending'
);

CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id),
    product_id BIGINT REFERENCES products(id),
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2)
);

-- åœºæ™¯ï¼šè®¢å•å¤„ç†ï¼ˆå¯èƒ½å‘ç”Ÿæ­»é”ï¼‰
-- ä¼šè¯1ï¼šå¤„ç†è®¢å•1ï¼ˆå•†å“Aå’ŒBï¼‰
BEGIN;
UPDATE products SET stock_quantity = stock_quantity - 10 WHERE id = 1;  -- å•†å“A
-- æŒæœ‰å•†å“Açš„é”
UPDATE products SET stock_quantity = stock_quantity - 5 WHERE id = 2;  -- å•†å“B
-- ç­‰å¾…å•†å“Bçš„é”...

-- ä¼šè¯2ï¼ˆå¹¶å‘ï¼‰ï¼šå¤„ç†è®¢å•2ï¼ˆå•†å“Bå’ŒAï¼‰
BEGIN;
UPDATE products SET stock_quantity = stock_quantity - 8 WHERE id = 2;  -- å•†å“B
-- æŒæœ‰å•†å“Bçš„é”
UPDATE products SET stock_quantity = stock_quantity - 3 WHERE id = 1;  -- å•†å“A
-- PostgreSQL 18æ£€æµ‹åˆ°æ­»é”ï¼š
-- ERROR: deadlock detected
-- DETAIL: Process 12345 waits for ShareLock on transaction 67890; blocked by process 11111.

-- ä¼šè¯2è¢«å›æ»šï¼Œä¼šè¯1ç»§ç»­
COMMIT;

-- ç›‘æ§æ­»é”é¢‘ç‡
SELECT
    datname,
    deadlocks,
    xact_commit,
    ROUND(deadlocks::numeric / NULLIF(xact_commit, 0) * 100, 4) as deadlock_rate_percent
FROM pg_stat_database
WHERE datname = current_database();
```

### 5.4 æ­»é”é¿å…æœ€ä½³å®è·µ

**PostgreSQL 18æœ€ä½³å®è·µ**ï¼š

```sql
-- 1. ä½¿ç”¨é”æ’åºï¼ˆæ¨èï¼‰
-- æŒ‰å›ºå®šé¡ºåºè·å–é”ï¼Œé¿å…æ­»é”
CREATE OR REPLACE FUNCTION safe_transfer(
    from_id BIGINT,
    to_id BIGINT,
    amount DECIMAL
) RETURNS VOID AS $$
DECLARE
    first_id BIGINT;
    second_id BIGINT;
BEGIN
    -- ç¡®ä¿æŒ‰IDé¡ºåºè·å–é”
    IF from_id < to_id THEN
        first_id := from_id;
        second_id := to_id;
    ELSE
        first_id := to_id;
        second_id := from_id;
    END IF;

    SELECT * FROM accounts WHERE id = first_id FOR UPDATE;
    SELECT * FROM accounts WHERE id = second_id FOR UPDATE;

    -- æ‰§è¡Œæ“ä½œ
    UPDATE accounts SET balance = balance - amount WHERE id = from_id;
    UPDATE accounts SET balance = balance + amount WHERE id = to_id;
END;
$$ LANGUAGE plpgsql;

-- 2. è®¾ç½®åˆç†çš„æ­»é”æ£€æµ‹è¶…æ—¶
ALTER SYSTEM SET deadlock_timeout = '500ms';  -- å¹³è¡¡æ£€æµ‹é¢‘ç‡å’Œå¼€é”€

-- 3. ç›‘æ§æ­»é”
-- å®šæœŸæ£€æŸ¥æ­»é”ç»Ÿè®¡
SELECT
    datname,
    deadlocks,
    xact_commit,
    ROUND(deadlocks::numeric / NULLIF(xact_commit, 0) * 100, 4) as deadlock_rate_percent
FROM pg_stat_database
WHERE datname = current_database();

-- 4. åº”ç”¨å±‚é‡è¯•é€»è¾‘
-- Pythonç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
def execute_with_retry(query, max_retries=3):
    for attempt in range(max_retries):
        try:
            return execute_query(query)
        except DeadlockError:
            if attempt == max_retries - 1:
                raise
            time.sleep(0.1 * (attempt + 1))  # æŒ‡æ•°é€€é¿
```

### 5.5 æ¨¡å‹é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQL 18æ­»é”æ£€æµ‹çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- é«˜å¹¶å‘ç³»ç»Ÿ
- éœ€è¦è‡ªåŠ¨æ­»é”æ£€æµ‹
- éœ€è¦æ™ºèƒ½ç‰ºç‰²è€…é€‰æ‹©
- éœ€è¦è¯¦ç»†çš„æ­»é”ç›‘æ§

**é€‰æ‹©SQLite 3.45çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- ä½å¹¶å‘ç³»ç»Ÿ
- å¯ä»¥æ¥å—è¶…æ—¶æœºåˆ¶
- å•æœºåº”ç”¨
- å¯¹æ­»é”æ£€æµ‹è¦æ±‚ä¸é«˜

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Bernstein, P. A., & Newcomer, E. (2009). "Principles of Transaction Processing."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: äº‹åŠ¡å¤„ç†çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†æ­»é”æ£€æµ‹å’Œé¿å…ç†è®º

- **Elmagarmid, A. K. (1992). "Database Transaction Models for Advanced Applications."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: é«˜çº§äº‹åŠ¡æ¨¡å‹çš„ç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†æ­»é”å¤„ç†çš„ç†è®ºæ¡†æ¶

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - é”](<https://www.postgresql.org/docs/current/explicit-locking.html>)**
  - PostgreSQLé”æœºåˆ¶å’Œæ­»é”æ£€æµ‹è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [ä¸¤é˜¶æ®µåŠ é”-å¯ä¸²è¡ŒåŒ–çš„ä¸¥æ ¼è¯æ˜](./03.09-ä¸¤é˜¶æ®µåŠ é”-å¯ä¸²è¡ŒåŒ–çš„ä¸¥æ ¼è¯æ˜.md)
- [é”å‡çº§ä¸é™çº§-å®‰å…¨æ€§ä¸æ­»é”å½±å“çš„å½¢å¼è¯æ˜](./03.10-é”å‡çº§ä¸é™çº§-å®‰å…¨æ€§ä¸æ­»é”å½±å“çš„å½¢å¼è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”
