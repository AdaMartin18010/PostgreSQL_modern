---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `MVCC-ACID-CAP\03-åœºæ™¯å®è·µ\ç”µå•†ç³»ç»Ÿ\åº“å­˜æ‰£å‡å®Œæ•´æ¡ˆä¾‹.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡å®Œæ•´æ¡ˆä¾‹

> **æ–‡æ¡£ç¼–å·**: SCENARIO-ECOMMERCE-001
> **ä¸»é¢˜**: ç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ğŸ“‘ ç›®å½•

- [ç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡å®Œæ•´æ¡ˆä¾‹](#ç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡å®Œæ•´æ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸šåŠ¡åœºæ™¯åˆ†æ](#-ç¬¬ä¸€éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯åˆ†æ)
    - [1.1 ä¸šåŠ¡éœ€æ±‚](#11-ä¸šåŠ¡éœ€æ±‚)
      - [æ ¸å¿ƒéœ€æ±‚](#æ ¸å¿ƒéœ€æ±‚)
      - [æ€§èƒ½è¦æ±‚](#æ€§èƒ½è¦æ±‚)
      - [ä¸€è‡´æ€§è¦æ±‚](#ä¸€è‡´æ€§è¦æ±‚)
    - [1.2 å¹¶å‘åœºæ™¯](#12-å¹¶å‘åœºæ™¯)
      - [é«˜å¹¶å‘ä¸‹å•](#é«˜å¹¶å‘ä¸‹å•)
      - [åº“å­˜è¶…å–é—®é¢˜](#åº“å­˜è¶…å–é—®é¢˜)
      - [æ­»é”é£é™©](#æ­»é”é£é™©)
  - [ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“è®¾è®¡](#-ç¬¬äºŒéƒ¨åˆ†æ•°æ®åº“è®¾è®¡)
    - [2.1 è¡¨ç»“æ„è®¾è®¡](#21-è¡¨ç»“æ„è®¾è®¡)
      - [å•†å“è¡¨è®¾è®¡](#å•†å“è¡¨è®¾è®¡)
      - [åº“å­˜è¡¨è®¾è®¡](#åº“å­˜è¡¨è®¾è®¡)
      - [è®¢å•è¡¨è®¾è®¡](#è®¢å•è¡¨è®¾è®¡)
    - [2.2 ç´¢å¼•è®¾è®¡](#22-ç´¢å¼•è®¾è®¡)
      - [ä¸»é”®ç´¢å¼•](#ä¸»é”®ç´¢å¼•)
      - [å”¯ä¸€ç´¢å¼•](#å”¯ä¸€ç´¢å¼•)
      - [æŸ¥è¯¢ç´¢å¼•](#æŸ¥è¯¢ç´¢å¼•)
    - [2.3 MVCCä¼˜åŒ–è®¾è®¡](#23-mvccä¼˜åŒ–è®¾è®¡)
      - [fillfactorè®¾ç½®](#fillfactorè®¾ç½®)
      - [è¡¨çº§VACUUMé…ç½®](#è¡¨çº§vacuumé…ç½®)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹åŠ¡å®ç°æ–¹æ¡ˆ](#-ç¬¬ä¸‰éƒ¨åˆ†äº‹åŠ¡å®ç°æ–¹æ¡ˆ)
    - [3.1 æ–¹æ¡ˆ1ï¼šSELECT FOR UPDATEï¼ˆæ‚²è§‚é”ï¼‰](#31-æ–¹æ¡ˆ1select-for-updateæ‚²è§‚é”)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç )
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
      - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯)
    - [3.2 æ–¹æ¡ˆ2ï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰](#32-æ–¹æ¡ˆ2ä¹è§‚é”ç‰ˆæœ¬å·)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç -1)
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ-1)
      - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯-1)
    - [3.3 æ–¹æ¡ˆ3ï¼šåŸå­æ“ä½œï¼ˆUPDATE WHEREï¼‰](#33-æ–¹æ¡ˆ3åŸå­æ“ä½œupdate-where)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç -2)
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ-2)
      - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯-2)
  - [ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¯­è¨€å®ç°](#-ç¬¬å››éƒ¨åˆ†å¤šè¯­è¨€å®ç°)
    - [4.1 Pythonå®ç°](#41-pythonå®ç°)
      - [psycopg2å®ç°](#psycopg2å®ç°)
      - [asyncpgå®ç°](#asyncpgå®ç°)
    - [4.2 Javaå®ç°](#42-javaå®ç°)
      - [JDBCå®ç°](#jdbcå®ç°)
      - [Springå®ç°](#springå®ç°)
    - [4.3 Goå®ç°](#43-goå®ç°)
      - [pgxå®ç°](#pgxå®ç°)
  - [ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–](#-ç¬¬äº”éƒ¨åˆ†æ€§èƒ½ä¼˜åŒ–)
    - [5.1 è¿æ¥æ± ä¼˜åŒ–](#51-è¿æ¥æ± ä¼˜åŒ–)
    - [5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–](#52-æ‰¹é‡æ“ä½œä¼˜åŒ–)
    - [5.3 æŸ¥è¯¢ä¼˜åŒ–](#53-æŸ¥è¯¢ä¼˜åŒ–)
  - [ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§å’Œå‘Šè­¦](#-ç¬¬å…­éƒ¨åˆ†ç›‘æ§å’Œå‘Šè­¦)
    - [6.1 å…³é”®æŒ‡æ ‡ç›‘æ§](#61-å…³é”®æŒ‡æ ‡ç›‘æ§)
    - [6.2 å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
    - [6.3 æ•…éšœå¤„ç†](#63-æ•…éšœå¤„ç†)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒæ–¹æ¡ˆ](#æ ¸å¿ƒæ–¹æ¡ˆ)
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ“‹ æ¦‚è¿°

ç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡æ˜¯å…¸å‹çš„å¹¶å‘æ§åˆ¶åœºæ™¯ï¼Œéœ€è¦åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œæ€§èƒ½ã€‚
æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–æ•°æ®åº“è®¾è®¡ã€äº‹åŠ¡å®ç°ã€å¤šè¯­è¨€å®ç°ã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§å‘Šè­¦ã€‚

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸šåŠ¡åœºæ™¯åˆ†æ

### 1.1 ä¸šåŠ¡éœ€æ±‚

#### æ ¸å¿ƒéœ€æ±‚

```sql
-- ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•æ—¶æ‰£å‡åº“å­˜
-- è¦æ±‚ï¼š
-- 1. é˜²æ­¢è¶…å–ï¼ˆåº“å­˜ä¸èƒ½ä¸ºè´Ÿï¼‰
-- 2. é«˜å¹¶å‘æ”¯æŒï¼ˆ1000+ QPSï¼‰
-- 3. æ•°æ®ä¸€è‡´æ€§ï¼ˆACIDä¿è¯ï¼‰
-- 4. ä½å»¶è¿Ÿï¼ˆ<100msï¼‰
```

#### æ€§èƒ½è¦æ±‚

- **QPS**: 1000+ å¹¶å‘ä¸‹å•
- **å»¶è¿Ÿ**: P99 < 100ms
- **å¯ç”¨æ€§**: 99.9%
- **æ•°æ®ä¸€è‡´æ€§**: 100%ï¼ˆä¸å…è®¸è¶…å–ï¼‰

#### ä¸€è‡´æ€§è¦æ±‚

- **åŸå­æ€§**: åº“å­˜æ‰£å‡å’Œè®¢å•åˆ›å»ºå¿…é¡»åŒæ—¶æˆåŠŸæˆ–å¤±è´¥
- **ä¸€è‡´æ€§**: åº“å­˜æ•°é‡å¿…é¡»å‡†ç¡®
- **éš”ç¦»æ€§**: å¹¶å‘ä¸‹å•ä¸èƒ½ç›¸äº’å¹²æ‰°
- **æŒä¹…æ€§**: æ‰£å‡ç»“æœå¿…é¡»æŒä¹…åŒ–

### 1.2 å¹¶å‘åœºæ™¯

#### é«˜å¹¶å‘ä¸‹å•

```sql
-- åœºæ™¯ï¼š1000ä¸ªç”¨æˆ·åŒæ—¶ä¸‹å•åŒä¸€å•†å“
-- å•†å“åº“å­˜ï¼š100ä»¶
-- é—®é¢˜ï¼šå¦‚ä½•ä¿è¯åªæœ‰100ä¸ªè®¢å•æˆåŠŸï¼Ÿ
```

#### åº“å­˜è¶…å–é—®é¢˜

```sql
-- é—®é¢˜åœºæ™¯ï¼š
-- æ—¶é—´T1: ç”¨æˆ·AæŸ¥è¯¢åº“å­˜=100
-- æ—¶é—´T2: ç”¨æˆ·BæŸ¥è¯¢åº“å­˜=100
-- æ—¶é—´T3: ç”¨æˆ·Aæ‰£å‡1ï¼Œåº“å­˜=99
-- æ—¶é—´T4: ç”¨æˆ·Bæ‰£å‡1ï¼Œåº“å­˜=99
-- ç»“æœï¼šå®é™…å–å‡º2ä»¶ï¼Œä½†åº“å­˜åªå‡å°‘1ï¼ˆè¶…å–ï¼‰
```

#### æ­»é”é£é™©

```sql
-- æ­»é”åœºæ™¯ï¼š
-- äº‹åŠ¡1: æ‰£å‡å•†å“Aåº“å­˜ï¼Œç„¶åæ‰£å‡å•†å“Båº“å­˜
-- äº‹åŠ¡2: æ‰£å‡å•†å“Båº“å­˜ï¼Œç„¶åæ‰£å‡å•†å“Aåº“å­˜
-- ç»“æœï¼šå¯èƒ½å‘ç”Ÿæ­»é”
```

---

## ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„è®¾è®¡

#### å•†å“è¡¨è®¾è®¡

```sql
-- å•†å“è¡¨
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    sku VARCHAR(100) UNIQUE NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_status ON products(status);
```

#### åº“å­˜è¡¨è®¾è®¡

```sql
-- åº“å­˜è¡¨ï¼ˆå…³é”®è¡¨ï¼‰
CREATE TABLE inventory (
    product_id BIGINT PRIMARY KEY REFERENCES products(id),
    stock INT NOT NULL DEFAULT 0,
    reserved_stock INT NOT NULL DEFAULT 0,  -- é¢„ç•™åº“å­˜ï¼ˆå·²ä¸‹å•æœªæ”¯ä»˜ï¼‰
    version INT NOT NULL DEFAULT 0,  -- ä¹è§‚é”ç‰ˆæœ¬å·
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- çº¦æŸï¼šåº“å­˜ä¸èƒ½ä¸ºè´Ÿ
    CONSTRAINT chk_stock_non_negative CHECK (stock >= 0),
    CONSTRAINT chk_reserved_stock_non_negative CHECK (reserved_stock >= 0)
);

-- ç´¢å¼•
CREATE INDEX idx_inventory_stock ON inventory(stock) WHERE stock > 0;
```

#### è®¢å•è¡¨è®¾è®¡

```sql
-- è®¢å•è¡¨
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL REFERENCES products(id),
    quantity INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, paid, cancelled
    created_at TIMESTAMP DEFAULT NOW(),
    paid_at TIMESTAMP,
    cancelled_at TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_product_id ON orders(product_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
```

### 2.2 ç´¢å¼•è®¾è®¡

#### ä¸»é”®ç´¢å¼•

```sql
-- ä¸»é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•
-- products.id, inventory.product_id, orders.id
```

#### å”¯ä¸€ç´¢å¼•

```sql
-- SKUå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_products_sku_unique ON products(sku);
```

#### æŸ¥è¯¢ç´¢å¼•

```sql
-- å¸¸ç”¨æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_inventory_stock_low ON inventory(stock) WHERE stock < 10;  -- ä½åº“å­˜å‘Šè­¦
CREATE INDEX idx_orders_user_status ON orders(user_id, status);  -- ç”¨æˆ·è®¢å•æŸ¥è¯¢
```

### 2.3 MVCCä¼˜åŒ–è®¾è®¡

#### fillfactorè®¾ç½®

```sql
-- åº“å­˜è¡¨ï¼šé¢„ç•™æ›´æ–°ç©ºé—´
ALTER TABLE inventory SET (fillfactor = 80);

-- è®¢å•è¡¨ï¼šåªæ’å…¥ï¼Œä¸æ›´æ–°
ALTER TABLE orders SET (fillfactor = 100);
```

#### è¡¨çº§VACUUMé…ç½®

```sql
-- åº“å­˜è¡¨ï¼šæ›´æ–°é¢‘ç¹ï¼Œéœ€è¦é¢‘ç¹VACUUM
ALTER TABLE inventory SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- 5%æ­»äº¡å…ƒç»„è§¦å‘
    autovacuum_analyze_scale_factor = 0.02  -- 2%å˜åŒ–è§¦å‘ANALYZE
);

-- è®¢å•è¡¨ï¼šæ’å…¥ä¸ºä¸»ï¼Œè¾ƒå°‘VACUUM
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_scale_factor = 0.05
);
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹åŠ¡å®ç°æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆ1ï¼šSELECT FOR UPDATEï¼ˆæ‚²è§‚é”ï¼‰

#### å®ç°ä»£ç 

```sql
-- æ‚²è§‚é”å®ç°ï¼šæ‰£å‡åº“å­˜
BEGIN;

-- 1. é”å®šåº“å­˜è¡Œ
SELECT stock, reserved_stock
FROM inventory
WHERE product_id = $1
FOR UPDATE;

-- 2. æ£€æŸ¥åº“å­˜
-- å¦‚æœ stock - reserved_stock < quantityï¼Œåˆ™å›æ»š

-- 3. æ‰£å‡åº“å­˜
UPDATE inventory
SET stock = stock - $2,
    updated_at = NOW()
WHERE product_id = $1
  AND stock >= $2;

-- 4. åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, product_id, quantity, price, total_amount)
VALUES ($3, $1, $2, $4, $4 * $2);

COMMIT;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. ä¿è¯å¼ºä¸€è‡´æ€§
-- 2. å®ç°ç®€å•
-- 3. ä¸ä¼šè¶…å–
--
-- ç¼ºç‚¹ï¼š
-- 1. é”ç«äº‰æ¿€çƒˆï¼ˆé«˜å¹¶å‘ä¸‹ï¼‰
-- 2. å¯èƒ½æ­»é”
-- 3. æ€§èƒ½è¾ƒä½ï¼ˆä¸²è¡ŒåŒ–ï¼‰
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 500-800ï¼ˆå•å®ä¾‹ï¼‰
-- P99å»¶è¿Ÿ: 50-100ms
```

#### é€‚ç”¨åœºæ™¯

- åº“å­˜æ•°é‡è¾ƒå°‘ï¼ˆ<1000ï¼‰
- å¹¶å‘é‡ä¸­ç­‰ï¼ˆ<500 QPSï¼‰
- å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜

### 3.2 æ–¹æ¡ˆ2ï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰

#### å®ç°ä»£ç 

```sql
-- ä¹è§‚é”å®ç°ï¼šæ‰£å‡åº“å­˜
DO $$
DECLARE
    current_stock INT;
    current_version INT;
    update_count INT;
BEGIN
    -- 1. è¯»å–å½“å‰åº“å­˜å’Œç‰ˆæœ¬å·
    SELECT stock, version INTO current_stock, current_version
    FROM inventory
    WHERE product_id = $1;

    -- 2. æ£€æŸ¥åº“å­˜
    IF current_stock < $2 THEN
        RAISE EXCEPTION 'Insufficient stock';
    END IF;

    -- 3. æ›´æ–°åº“å­˜ï¼ˆç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
    UPDATE inventory
    SET stock = stock - $2,
        version = version + 1,
        updated_at = NOW()
    WHERE product_id = $1
      AND version = current_version;

    GET DIAGNOSTICS update_count = ROW_COUNT;

    -- 4. æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
    IF update_count = 0 THEN
        RAISE EXCEPTION 'Version mismatch, please retry';
    END IF;

    -- 5. åˆ›å»ºè®¢å•
    INSERT INTO orders (user_id, product_id, quantity, price, total_amount)
    VALUES ($3, $1, $2, $4, $4 * $2);
END $$;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. é«˜å¹¶å‘æ€§èƒ½å¥½
-- 2. æ— é”ç«äº‰
-- 3. ä¸ä¼šæ­»é”
--
-- ç¼ºç‚¹ï¼š
-- 1. éœ€è¦é‡è¯•æœºåˆ¶
-- 2. å†²çªæ—¶æ€§èƒ½ä¸‹é™
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 2000-3000ï¼ˆä½å†²çªï¼‰
-- P99å»¶è¿Ÿ: 20-50msï¼ˆæ— å†²çªï¼‰
-- é‡è¯•ç‡: 5-10%ï¼ˆé«˜å¹¶å‘ï¼‰
```

#### é€‚ç”¨åœºæ™¯

- åº“å­˜æ•°é‡è¾ƒå¤§ï¼ˆ>1000ï¼‰
- é«˜å¹¶å‘ï¼ˆ>1000 QPSï¼‰
- å¯ä»¥æ¥å—é‡è¯•

### 3.3 æ–¹æ¡ˆ3ï¼šåŸå­æ“ä½œï¼ˆUPDATE WHEREï¼‰

#### å®ç°ä»£ç 

```sql
-- åŸå­æ“ä½œå®ç°ï¼šæ‰£å‡åº“å­˜ï¼ˆæ¨èï¼‰
BEGIN;

-- 1. åŸå­æ‰£å‡åº“å­˜
UPDATE inventory
SET stock = stock - $2,
    updated_at = NOW()
WHERE product_id = $1
  AND stock >= $2;

-- 2. æ£€æŸ¥æ›´æ–°ç»“æœ
-- å¦‚æœ ROW_COUNT = 0ï¼Œè¯´æ˜åº“å­˜ä¸è¶³ï¼Œå›æ»š

-- 3. åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, product_id, quantity, price, total_amount)
VALUES ($3, $1, $2, $4, $4 * $2);

COMMIT;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. æ€§èƒ½æœ€ä¼˜
-- 2. å®ç°æœ€ç®€å•
-- 3. æ— é”ç«äº‰
-- 4. ä¸ä¼šæ­»é”
--
-- ç¼ºç‚¹ï¼š
-- 1. éœ€è¦æ£€æŸ¥æ›´æ–°ç»“æœ
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 3000-5000ï¼ˆå•å®ä¾‹ï¼‰
-- P99å»¶è¿Ÿ: 10-30ms
```

#### é€‚ç”¨åœºæ™¯

- **æ¨èæ–¹æ¡ˆ**ï¼šé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯
- é«˜å¹¶å‘ï¼ˆ>1000 QPSï¼‰
- ç®€å•å¯é 

---

## ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¯­è¨€å®ç°

### 4.1 Pythonå®ç°

#### psycopg2å®ç°

```python
import psycopg2
from psycopg2 import pool
from contextlib import contextmanager

# è¿æ¥æ± 
connection_pool = psycopg2.pool.ThreadedConnectionPool(
    minconn=5,
    maxconn=20,
    host="localhost",
    database="ecommerce",
    user="postgres",
    password="password"
)

def deduct_inventory(product_id, quantity, user_id, price):
    """æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œæ–¹æ¡ˆï¼‰"""
    conn = connection_pool.getconn()
    try:
        cur = conn.cursor()

        # åŸå­æ‰£å‡åº“å­˜
        cur.execute("""
            UPDATE inventory
            SET stock = stock - %s,
                updated_at = NOW()
            WHERE product_id = %s
              AND stock >= %s
        """, (quantity, product_id, quantity))

        if cur.rowcount == 0:
            raise ValueError("Insufficient stock")

        # åˆ›å»ºè®¢å•
        cur.execute("""
            INSERT INTO orders (user_id, product_id, quantity, price, total_amount)
            VALUES (%s, %s, %s, %s, %s)
        """, (user_id, product_id, quantity, price, price * quantity))

        conn.commit()
        return True

    except Exception as e:
        conn.rollback()
        raise
    finally:
        cur.close()
        connection_pool.putconn(conn)
```

#### asyncpgå®ç°

```python
import asyncpg
import asyncio

async def deduct_inventory_async(pool, product_id, quantity, user_id, price):
    """å¼‚æ­¥æ‰£å‡åº“å­˜"""
    async with pool.acquire() as conn:
        async with conn.transaction():
            # åŸå­æ‰£å‡åº“å­˜
            result = await conn.execute("""
                UPDATE inventory
                SET stock = stock - $1,
                    updated_at = NOW()
                WHERE product_id = $2
                  AND stock >= $1
            """, quantity, product_id)

            if result == "UPDATE 0":
                raise ValueError("Insufficient stock")

            # åˆ›å»ºè®¢å•
            await conn.execute("""
                INSERT INTO orders (user_id, product_id, quantity, price, total_amount)
                VALUES ($1, $2, $3, $4, $5)
            """, user_id, product_id, quantity, price, price * quantity)

            return True
```

### 4.2 Javaå®ç°

#### JDBCå®ç°

```java
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import javax.sql.DataSource;

public class InventoryService {
    private final DataSource dataSource;

    public boolean deductInventory(long productId, int quantity,
                                   long userId, double price) throws SQLException {
        Connection conn = dataSource.getConnection();
        try {
            conn.setAutoCommit(false);

            PreparedStatement stmt = conn.prepareStatement(
                "UPDATE inventory SET stock = stock - ?, updated_at = NOW() " +
                "WHERE product_id = ? AND stock >= ?"
            );
            stmt.setInt(1, quantity);
            stmt.setLong(2, productId);
            stmt.setInt(3, quantity);

            int rows = stmt.executeUpdate();
            if (rows == 0) {
                conn.rollback();
                throw new SQLException("Insufficient stock");
            }

            // åˆ›å»ºè®¢å•
            PreparedStatement orderStmt = conn.prepareStatement(
                "INSERT INTO orders (user_id, product_id, quantity, price, total_amount) " +
                "VALUES (?, ?, ?, ?, ?)"
            );
            orderStmt.setLong(1, userId);
            orderStmt.setLong(2, productId);
            orderStmt.setInt(3, quantity);
            orderStmt.setDouble(4, price);
            orderStmt.setDouble(5, price * quantity);
            orderStmt.executeUpdate();

            conn.commit();
            return true;

        } catch (SQLException e) {
            conn.rollback();
            throw e;
        } finally {
            conn.setAutoCommit(true);
            conn.close();
        }
    }
}
```

#### Springå®ç°

```java
import org.springframework.transaction.annotation.Transactional;
import org.springframework.stereotype.Service;

@Service
public class InventoryService {

    @Transactional
    public boolean deductInventory(long productId, int quantity,
                                   long userId, double price) {
        // åŸå­æ‰£å‡åº“å­˜
        int rows = inventoryRepository.deductStock(productId, quantity);
        if (rows == 0) {
            throw new InsufficientStockException();
        }

        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(userId);
        order.setProductId(productId);
        order.setQuantity(quantity);
        order.setPrice(price);
        order.setTotalAmount(price * quantity);
        orderRepository.save(order);

        return true;
    }
}

// Repositoryæ–¹æ³•
public interface InventoryRepository extends JpaRepository<Inventory, Long> {
    @Modifying
    @Query("UPDATE Inventory i SET i.stock = i.stock - :quantity, i.updatedAt = NOW() " +
           "WHERE i.productId = :productId AND i.stock >= :quantity")
    int deductStock(@Param("productId") long productId, @Param("quantity") int quantity);
}
```

### 4.3 Goå®ç°

#### pgxå®ç°

```go
package main

import (
    "context"
    "github.com/jackc/pgx/v5/pgxpool"
)

func DeductInventory(ctx context.Context, pool *pgxpool.Pool,
                     productID int64, quantity int, userID int64, price float64) error {
    tx, err := pool.Begin(ctx)
    if err != nil {
        return err
    }
    defer tx.Rollback(ctx)

    // åŸå­æ‰£å‡åº“å­˜
    result, err := tx.Exec(ctx,
        "UPDATE inventory SET stock = stock - $1, updated_at = NOW() "+
        "WHERE product_id = $2 AND stock >= $1",
        quantity, productID)
    if err != nil {
        return err
    }

    if result.RowsAffected() == 0 {
        return fmt.Errorf("insufficient stock")
    }

    // åˆ›å»ºè®¢å•
    _, err = tx.Exec(ctx,
        "INSERT INTO orders (user_id, product_id, quantity, price, total_amount) "+
        "VALUES ($1, $2, $3, $4, $5)",
        userID, productID, quantity, price, price*float64(quantity))
    if err != nil {
        return err
    }

    return tx.Commit(ctx)
}
```

---

## ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–

### 5.1 è¿æ¥æ± ä¼˜åŒ–

```python
# Pythonè¿æ¥æ± ä¼˜åŒ–
connection_pool = psycopg2.pool.ThreadedConnectionPool(
    minconn=10,      # æœ€å°è¿æ¥æ•°
    maxconn=50,      # æœ€å¤§è¿æ¥æ•°ï¼ˆæ ¹æ®å¹¶å‘è°ƒæ•´ï¼‰
    host="localhost",
    database="ecommerce",
    user="postgres",
    password="password",
    # MVCCä¼˜åŒ–å‚æ•°
    connect_timeout=10,
    keepalives=1,
    keepalives_idle=30,
)
```

### 5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```python
# æ‰¹é‡æ‰£å‡åº“å­˜ï¼ˆå¤šä¸ªå•†å“ï¼‰
def batch_deduct_inventory(deductions):
    """æ‰¹é‡æ‰£å‡åº“å­˜"""
    conn = connection_pool.getconn()
    try:
        cur = conn.cursor()

        # æ‰¹é‡æ›´æ–°
        for product_id, quantity in deductions:
            cur.execute("""
                UPDATE inventory
                SET stock = stock - %s
                WHERE product_id = %s AND stock >= %s
            """, (quantity, product_id, quantity))

            if cur.rowcount == 0:
                raise ValueError(f"Insufficient stock for product {product_id}")

        conn.commit()
        return True

    except Exception as e:
        conn.rollback()
        raise
    finally:
        cur.close()
        connection_pool.putconn(conn)
```

### 5.3 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–åº“å­˜æŸ¥è¯¢
CREATE INDEX idx_inventory_product_stock ON inventory(product_id, stock);

-- æŸ¥è¯¢æ—¶ä½¿ç”¨ç´¢å¼•
EXPLAIN SELECT stock FROM inventory WHERE product_id = 1;
-- ä½¿ç”¨ç´¢å¼•æ‰«æï¼Œé¿å…è¡¨æ‰«æ
```

---

## ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§å’Œå‘Šè­¦

### 6.1 å…³é”®æŒ‡æ ‡ç›‘æ§

```sql
-- ç›‘æ§åº“å­˜æ‰£å‡æˆåŠŸç‡
SELECT
    COUNT(*) FILTER (WHERE status = 'success') * 100.0 / COUNT(*) as success_rate
FROM order_logs
WHERE created_at > NOW() - interval '1 minute';

-- ç›‘æ§ä½åº“å­˜å•†å“
SELECT
    product_id,
    stock,
    reserved_stock,
    stock - reserved_stock as available_stock
FROM inventory
WHERE stock - reserved_stock < 10
ORDER BY available_stock;
```

### 6.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
- alert: LowInventory
  expr: inventory_available_stock < 10
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Low inventory alert"
    description: "Product {{ $labels.product_id }} has only {{ $value }} items left"

- alert: InventoryDeductionFailure
  expr: rate(inventory_deduction_failures[5m]) > 0.1
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "High inventory deduction failure rate"
    description: "Failure rate: {{ $value }}"
```

### 6.3 æ•…éšœå¤„ç†

```sql
-- æ•…éšœåœºæ™¯1ï¼šåº“å­˜æ‰£å‡å¤±è´¥
-- å¤„ç†ï¼šæ£€æŸ¥åº“å­˜æ˜¯å¦çœŸçš„ä¸è¶³ï¼Œå¦‚æœæ˜¯ï¼Œæç¤ºç”¨æˆ·ï¼›å¦‚æœæ˜¯ç³»ç»Ÿé”™è¯¯ï¼Œé‡è¯•

-- æ•…éšœåœºæ™¯2ï¼šæ­»é”
-- å¤„ç†ï¼šè‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

-- æ•…éšœåœºæ™¯3ï¼šåº“å­˜ä¸ä¸€è‡´
-- å¤„ç†ï¼šå®šæœŸå¯¹è´¦ï¼Œä¿®æ­£åº“å­˜
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ–¹æ¡ˆ

1. **æ¨èæ–¹æ¡ˆ**ï¼šåŸå­æ“ä½œï¼ˆUPDATE WHEREï¼‰
   - æ€§èƒ½æœ€ä¼˜
   - å®ç°ç®€å•
   - æ— é”ç«äº‰

2. **å¤‡é€‰æ–¹æ¡ˆ**ï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰
   - é«˜å¹¶å‘æ€§èƒ½å¥½
   - éœ€è¦é‡è¯•æœºåˆ¶

3. **ä¿å®ˆæ–¹æ¡ˆ**ï¼šSELECT FOR UPDATE
   - å¼ºä¸€è‡´æ€§
   - æ€§èƒ½è¾ƒä½

### æœ€ä½³å®è·µ

1. **æ•°æ®åº“è®¾è®¡**ï¼šåˆç†è®¾ç½®fillfactorå’ŒVACUUMå‚æ•°
2. **äº‹åŠ¡è®¾è®¡**ï¼šä½¿ç”¨åŸå­æ“ä½œï¼Œé¿å…é•¿äº‹åŠ¡
3. **è¿æ¥æ± **ï¼šåˆç†é…ç½®è¿æ¥æ± å¤§å°
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘Šè­¦
5. **æ•…éšœå¤„ç†**ï¼šå®ç°é‡è¯•æœºåˆ¶å’Œæ•…éšœæ¢å¤

### æ€§èƒ½æŒ‡æ ‡

- **QPS**: 3000-5000ï¼ˆå•å®ä¾‹ï¼‰
- **P99å»¶è¿Ÿ**: 10-30ms
- **æˆåŠŸç‡**: >99.9%
- **è¶…å–ç‡**: 0%

PostgreSQL 17/18çš„MVCCæœºåˆ¶åœ¨ç”µå•†åº“å­˜æ‰£å‡åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œé€šè¿‡åˆç†çš„æ•°æ®åº“è®¾è®¡å’Œäº‹åŠ¡å®ç°ï¼Œå¯ä»¥å®ç°é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„åº“å­˜ç®¡ç†ç³»ç»Ÿã€‚
