---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\03-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶\11-é”æœºåˆ¶æ·±åº¦è§£æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLé”æœºåˆ¶æ·±åº¦è§£æ

## 1. é”å±‚æ¬¡

```text
PostgreSQLé”å±‚æ¬¡ï¼ˆä»ç²—åˆ°ç»†ï¼‰:
â”œâ”€ 1. è¡¨é”ï¼ˆTable Lockï¼‰
â”‚  â”œâ”€ ACCESS SHARE
â”‚  â”œâ”€ ROW SHARE
â”‚  â”œâ”€ ROW EXCLUSIVE
â”‚  â”œâ”€ SHARE UPDATE EXCLUSIVE
â”‚  â”œâ”€ SHARE
â”‚  â”œâ”€ SHARE ROW EXCLUSIVE
â”‚  â”œâ”€ EXCLUSIVE
â”‚  â””â”€ ACCESS EXCLUSIVE
â”œâ”€ 2. è¡Œé”ï¼ˆRow Lockï¼‰
â”‚  â”œâ”€ FOR UPDATE
â”‚  â”œâ”€ FOR NO KEY UPDATE
â”‚  â”œâ”€ FOR SHARE
â”‚  â””â”€ FOR KEY SHARE
â”œâ”€ 3. é¡µé”ï¼ˆPage Lockï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰
â””â”€ 4. Advisory Lockï¼ˆå»ºè®®é”ï¼‰
```

---

## 2. è¡¨é”è¯¦è§£

### 2.1 é”æ¨¡å¼ä¸å†²çª

```sql
-- é”å†²çªçŸ©é˜µ
/*
                AS  RS  RE  SUE  S  SRE  E  AE
ACCESS SHARE     -   -   -   -   -   -   -   âœ—
ROW SHARE        -   -   -   -   -   -   âœ—   âœ—
ROW EXCLUSIVE    -   -   -   -   âœ—   âœ—   âœ—   âœ—
SHARE UPD EXCL   -   -   -   âœ—   âœ—   âœ—   âœ—   âœ—
SHARE            -   -   âœ—   âœ—   -   âœ—   âœ—   âœ—
SHARE ROW EXCL   -   -   âœ—   âœ—   âœ—   âœ—   âœ—   âœ—
EXCLUSIVE        -   âœ—   âœ—   âœ—   âœ—   âœ—   âœ—   âœ—
ACCESS EXCLUSIVE âœ—   âœ—   âœ—   âœ—   âœ—   âœ—   âœ—   âœ—

- = ä¸å†²çª
âœ— = å†²çª
*/

-- å¸¸è§æ“ä½œçš„é”çº§åˆ«
SELECT            -- ACCESS SHARE
SELECT FOR SHARE  -- ROW SHARE
INSERT/UPDATE/DELETE  -- ROW EXCLUSIVE
CREATE INDEX CONCURRENTLY  -- SHARE UPDATE EXCLUSIVE
CREATE INDEX      -- SHARE
VACUUM FULL       -- ACCESS EXCLUSIVE
ALTER TABLE       -- ACCESS EXCLUSIVE
DROP TABLE        -- ACCESS EXCLUSIVE
```

### 2.2 æ˜¾å¼é”è¡¨

```sql
-- é”æ•´ä¸ªè¡¨
BEGIN;
LOCK TABLE accounts IN EXCLUSIVE MODE;
-- åªæœ‰å½“å‰äº‹åŠ¡å¯ä»¥ä¿®æ”¹è¡¨
UPDATE accounts SET balance = balance + 100;
COMMIT;

-- NOWAITï¼šç«‹å³å¤±è´¥è€Œä¸ç­‰å¾…
BEGIN;
LOCK TABLE accounts IN EXCLUSIVE MODE NOWAIT;
-- å¦‚æœæ— æ³•ç«‹å³è·å–é”ï¼Œè¿”å›é”™è¯¯
COMMIT;
```

---

## 3. è¡Œé”è¯¦è§£

### 3.1 å››ç§è¡Œé”

```sql
-- FOR UPDATEï¼šæ’ä»–é”
BEGIN;
SELECT * FROM accounts WHERE account_id = 1 FOR UPDATE;
-- å…¶ä»–äº‹åŠ¡æ— æ³•UPDATE/DELETE/FOR UPDATEè¯¥è¡Œ
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
COMMIT;

-- FOR NO KEY UPDATEï¼šå…è®¸å¤–é”®
BEGIN;
SELECT * FROM users WHERE user_id = 1 FOR NO KEY UPDATE;
-- å…è®¸å…¶ä»–äº‹åŠ¡æ’å…¥orders(user_id=1)
UPDATE users SET email = 'new@example.com' WHERE user_id = 1;
COMMIT;

-- FOR SHAREï¼šå…±äº«é”
BEGIN;
SELECT * FROM products WHERE product_id = 1 FOR SHARE;
-- å…¶ä»–äº‹åŠ¡å¯ä»¥FOR SHAREï¼Œä½†ä¸èƒ½ä¿®æ”¹
COMMIT;

-- FOR KEY SHAREï¼šæœ€å¼±çš„é”
BEGIN;
SELECT * FROM users WHERE user_id = 1 FOR KEY SHARE;
-- å…è®¸UPDATEéé”®åˆ—
COMMIT;
```

### 3.2 SKIP LOCKED

```sql
-- ä»»åŠ¡é˜Ÿåˆ—ï¼šè·³è¿‡å·²é”å®šçš„è¡Œ
SELECT * FROM tasks
WHERE status = 'pending'
ORDER BY priority DESC, created_at
LIMIT 10
FOR UPDATE SKIP LOCKED;

-- å¤šWorkerå¹¶å‘å¤„ç†ï¼Œæ— é”ç­‰å¾…
```

---

## 4. æ­»é”æ£€æµ‹

### 4.1 æ­»é”ç¤ºä¾‹

```sql
-- ä¼šè¯1
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
-- æŒæœ‰account_id=1çš„é”
UPDATE accounts SET balance = balance + 100 WHERE account_id = 2;
-- ç­‰å¾…account_id=2çš„é”

-- ä¼šè¯2
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE account_id = 2;
-- æŒæœ‰account_id=2çš„é”
UPDATE accounts SET balance = balance + 50 WHERE account_id = 1;
-- ç­‰å¾…account_id=1çš„é”

-- PostgreSQLæ£€æµ‹åˆ°æ­»é”ï¼ˆé»˜è®¤1ç§’åï¼‰
-- ERROR: deadlock detected
-- DETAIL: Process 1234 waits for ShareLock on transaction 5678
-- Process 5679 waits for ShareLock on transaction 1234
```

### 4.2 æ­»é”é¢„é˜²

```sql
-- ç­–ç•¥1: å›ºå®šé¡ºåºåŠ é”
-- Good
BEGIN;
SELECT * FROM accounts
WHERE account_id IN (1, 2, 5, 10)
ORDER BY account_id  -- æŒ‰é¡ºåº
FOR UPDATE;
COMMIT;

-- ç­–ç•¥2: ä½¿ç”¨NOWAIT
BEGIN;
SELECT * FROM accounts WHERE account_id = 1 FOR UPDATE NOWAIT;
-- ç«‹å³å¤±è´¥ï¼Œåº”ç”¨å±‚é‡è¯•
COMMIT;

-- ç­–ç•¥3: å‡å°‘æŒé”æ—¶é—´
BEGIN;
SELECT * FROM accounts WHERE account_id = 1 FOR UPDATE;
-- å¿«é€Ÿå¤„ç†
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
COMMIT;  -- å°½å¿«æäº¤
```

---

## 5. Advisory Lock

### 5.1 åº”ç”¨å±‚é”

```sql
-- ä¼šè¯çº§é”
SELECT pg_advisory_lock(12345);
-- æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
SELECT pg_advisory_unlock(12345);

-- äº‹åŠ¡çº§é”ï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰
BEGIN;
SELECT pg_advisory_xact_lock(12345);
-- æ‰§è¡Œæ“ä½œ
COMMIT;  -- è‡ªåŠ¨é‡Šæ”¾

-- å°è¯•è·å–ï¼ˆéé˜»å¡ï¼‰
SELECT pg_try_advisory_lock(12345);  -- true/false

-- åº”ç”¨: åˆ†å¸ƒå¼é”ã€ä»»åŠ¡å»é‡
```

### 5.2 å®æˆ˜ï¼šé˜²æ­¢é‡å¤æ‰§è¡Œ

```sql
CREATE OR REPLACE FUNCTION process_once(task_id BIGINT)
RETURNS BOOLEAN AS $$
BEGIN
    -- å°è¯•è·å–é”
    IF NOT pg_try_advisory_lock(task_id) THEN
        RAISE NOTICE 'ä»»åŠ¡%æ­£åœ¨æ‰§è¡Œä¸­', task_id;
        RETURN false;
    END IF;

    BEGIN
        -- æ‰§è¡Œä»»åŠ¡
        PERFORM expensive_operation(task_id);

        -- é‡Šæ”¾é”
        PERFORM pg_advisory_unlock(task_id);

        RETURN true;
    EXCEPTION
        WHEN OTHERS THEN
            PERFORM pg_advisory_unlock(task_id);
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. é”ç›‘æ§

### 6.1 å®æ—¶ç›‘æ§

```sql
-- å½“å‰é”ç­‰å¾…
SELECT
    blocked.pid AS blocked_pid,
    blocked.usename AS blocked_user,
    blocked.query AS blocked_query,
    now() - blocked.query_start AS blocked_duration,
    blocking.pid AS blocking_pid,
    blocking.usename AS blocking_user,
    blocking.query AS blocking_query,
    blocking.state AS blocking_state
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked ON blocked.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON
    blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_stat_activity blocking ON blocking.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
  AND blocking_locks.granted;

-- é”ç­‰å¾…é“¾
WITH RECURSIVE lock_chain AS (
    SELECT
        pid,
        usename,
        query,
        0 AS depth,
        ARRAY[pid] AS chain
    FROM pg_stat_activity
    WHERE pid IN (
        SELECT pid FROM pg_locks WHERE NOT granted
    )

    UNION ALL

    SELECT
        blocking.pid,
        blocking.usename,
        blocking.query,
        lc.depth + 1,
        lc.chain || blocking.pid
    FROM lock_chain lc
    JOIN pg_locks blocked_locks ON lc.pid = blocked_locks.pid
    JOIN pg_locks blocking_locks ON
        blocking_locks.locktype = blocked_locks.locktype
        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
        AND blocking_locks.granted
        AND blocked_locks.pid != blocking_locks.pid
    JOIN pg_stat_activity blocking ON blocking.pid = blocking_locks.pid
    WHERE NOT EXISTS (
        SELECT 1 FROM lock_chain WHERE pid = blocking.pid
    )
)
SELECT * FROM lock_chain
ORDER BY depth, pid;
```

---

**å®Œæˆ**: PostgreSQLé”æœºåˆ¶æ·±åº¦è§£æ
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: é”å±‚æ¬¡ã€è¡¨é”ã€è¡Œé”ã€æ­»é”ã€Advisory Lockã€ç›‘æ§
