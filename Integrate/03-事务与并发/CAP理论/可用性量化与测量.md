---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `MVCC-ACID-CAP\01-ç†è®ºåŸºç¡€\CAPç†è®º\å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡

> **æ–‡æ¡£ç¼–å·**: CAP-THEORY-004
> **ä¸»é¢˜**: å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡](#å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“Š ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯ç”¨æ€§æŒ‡æ ‡å®šä¹‰](#-ç¬¬ä¸€éƒ¨åˆ†å¯ç”¨æ€§æŒ‡æ ‡å®šä¹‰)
    - [1.1 SLAå®šä¹‰](#11-slaå®šä¹‰)
    - [1.2 SLOå®šä¹‰](#12-sloå®šä¹‰)
    - [1.3 SLIå®šä¹‰](#13-sliå®šä¹‰)
  - [ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šå¯ç”¨æ€§æµ‹é‡æ–¹æ³•](#-ç¬¬äºŒéƒ¨åˆ†å¯ç”¨æ€§æµ‹é‡æ–¹æ³•)
    - [2.1 æ•…éšœæ£€æµ‹æœºåˆ¶](#21-æ•…éšœæ£€æµ‹æœºåˆ¶)
    - [2.2 æ•…éšœæ¢å¤æ—¶é—´](#22-æ•…éšœæ¢å¤æ—¶é—´)
    - [2.3 å¯ç”¨æ€§è®¡ç®—å…¬å¼](#23-å¯ç”¨æ€§è®¡ç®—å…¬å¼)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šPostgreSQLé«˜å¯ç”¨å®ç°](#-ç¬¬ä¸‰éƒ¨åˆ†postgresqlé«˜å¯ç”¨å®ç°)
    - [3.1 æµå¤åˆ¶é«˜å¯ç”¨](#31-æµå¤åˆ¶é«˜å¯ç”¨)
    - [3.2 é€»è¾‘å¤åˆ¶é«˜å¯ç”¨](#32-é€»è¾‘å¤åˆ¶é«˜å¯ç”¨)
    - [3.3 æ•…éšœè½¬ç§»æœºåˆ¶](#33-æ•…éšœè½¬ç§»æœºåˆ¶)
  - [ğŸ“Š ç¬¬å››éƒ¨åˆ†ï¼šå¯ç”¨æ€§ç›‘æ§ä¸å‘Šè­¦](#-ç¬¬å››éƒ¨åˆ†å¯ç”¨æ€§ç›‘æ§ä¸å‘Šè­¦)
    - [4.1 ç›‘æ§æŒ‡æ ‡](#41-ç›‘æ§æŒ‡æ ‡)
    - [4.3 å¯ç”¨æ€§Dashboard](#43-å¯ç”¨æ€§dashboard)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒç»“è®º](#æ ¸å¿ƒç»“è®º)
    - [å®è·µå»ºè®®](#å®è·µå»ºè®®)
  - [ğŸ“š å¤–éƒ¨èµ„æºå¼•ç”¨](#-å¤–éƒ¨èµ„æºå¼•ç”¨)
    - [Wikipediaèµ„æº](#wikipediaèµ„æº)
    - [å­¦æœ¯è®ºæ–‡](#å­¦æœ¯è®ºæ–‡)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)

---

## ğŸ“‹ æ¦‚è¿°

å¯ç”¨æ€§æ˜¯CAPå®šç†ä¸­çš„æ ¸å¿ƒå±æ€§ä¹‹ä¸€ï¼Œå®ƒå®šä¹‰äº†ç³»ç»Ÿåœ¨ä»»æ„æ—¶åˆ»éƒ½èƒ½å“åº”è¯·æ±‚çš„èƒ½åŠ›ã€‚ç†è§£å¯ç”¨æ€§çš„é‡åŒ–æŒ‡æ ‡å’Œæµ‹é‡æ–¹æ³•ï¼Œå¯¹äºç³»ç»Ÿè®¾è®¡å’Œè¿ç»´è‡³å…³é‡è¦ã€‚

æœ¬æ–‡æ¡£ä»å¯ç”¨æ€§æŒ‡æ ‡å®šä¹‰ã€æµ‹é‡æ–¹æ³•ã€PostgreSQLå®ç°å’Œç›‘æ§å‘Šè­¦å››ä¸ªç»´åº¦ï¼Œå…¨é¢é˜è¿°å¯ç”¨æ€§é‡åŒ–ä¸æµ‹é‡çš„å®Œæ•´ä½“ç³»ã€‚

**æ ¸å¿ƒè§‚ç‚¹**ï¼š

- **SLA/SLO/SLI**ï¼šå®šä¹‰å¯ç”¨æ€§çš„ä¸‰ä¸ªå±‚æ¬¡æŒ‡æ ‡
- **æ•…éšœæ£€æµ‹ä¸æ¢å¤**ï¼šå¯ç”¨æ€§çš„å…³é”®æµ‹é‡ç»´åº¦
- **PostgreSQLé«˜å¯ç”¨**ï¼šé€šè¿‡æµå¤åˆ¶å’Œæ•…éšœè½¬ç§»å®ç°é«˜å¯ç”¨æ€§
- **ç›‘æ§ä¸å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å¯ç”¨æ€§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

---

## ğŸ“Š ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯ç”¨æ€§æŒ‡æ ‡å®šä¹‰

### 1.1 SLAå®šä¹‰

**SLAï¼ˆService Level Agreementï¼‰æœåŠ¡çº§åˆ«åè®®**ï¼š

SLAæ˜¯æœåŠ¡æä¾›è€…å’Œç”¨æˆ·ä¹‹é—´çš„åè®®ï¼Œå®šä¹‰äº†æœåŠ¡çš„å¯ç”¨æ€§ç›®æ ‡ã€‚

**å¸¸è§SLAçº§åˆ«**ï¼š

| SLAçº§åˆ« | å¯ç”¨æ€§ç™¾åˆ†æ¯” | å¹´åœæœºæ—¶é—´ | æœˆåœæœºæ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|---------|-------------|-----------|-----------|---------|
| **99%** | 99% | 87.6å°æ—¶ | 7.3å°æ—¶ | ä¸€èˆ¬æœåŠ¡ |
| **99.9%** | 99.9% | 8.76å°æ—¶ | 43.8åˆ†é’Ÿ | ä¼ä¸šæœåŠ¡ |
| **99.99%** | 99.99% | 52.56åˆ†é’Ÿ | 4.38åˆ†é’Ÿ | å…³é”®æœåŠ¡ |
| **99.999%** | 99.999% | 5.26åˆ†é’Ÿ | 26.3ç§’ | å…³é”®åŸºç¡€è®¾æ–½ |

**PostgreSQL SLAç›®æ ‡**ï¼š

```sql
-- PostgreSQLé«˜å¯ç”¨é…ç½®ï¼ˆ99.99% SLAï¼‰
-- ç›®æ ‡ï¼šå¹´åœæœºæ—¶é—´ < 52.56åˆ†é’Ÿ
-- å®ç°ï¼šæµå¤åˆ¶ + è‡ªåŠ¨æ•…éšœè½¬ç§»
```

### 1.2 SLOå®šä¹‰

**SLOï¼ˆService Level Objectiveï¼‰æœåŠ¡çº§åˆ«ç›®æ ‡**ï¼š

SLOæ˜¯SLAä¸­çš„å…·ä½“ç›®æ ‡ï¼Œå®šä¹‰äº†å¯æµ‹é‡çš„æœåŠ¡æŒ‡æ ‡ã€‚

**PostgreSQL SLOæŒ‡æ ‡**ï¼š

| SLOæŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|---------|--------|---------|
| **æ•°æ®åº“å¯ç”¨æ€§** | 99.99% | ç›‘æ§æ•°æ®åº“è¿æ¥æˆåŠŸç‡ |
| **æŸ¥è¯¢å“åº”æ—¶é—´** | P95 < 100ms | ç›‘æ§æŸ¥è¯¢å»¶è¿Ÿ |
| **æ•…éšœæ¢å¤æ—¶é—´** | RTO < 5åˆ†é’Ÿ | ç›‘æ§æ•…éšœè½¬ç§»æ—¶é—´ |
| **æ•°æ®ä¸¢å¤±çª—å£** | RPO < 1åˆ†é’Ÿ | ç›‘æ§å¤åˆ¶å»¶è¿Ÿ |

### 1.3 SLIå®šä¹‰

**SLIï¼ˆService Level Indicatorï¼‰æœåŠ¡çº§åˆ«æŒ‡æ ‡**ï¼š

SLIæ˜¯SLOçš„å…·ä½“æµ‹é‡æŒ‡æ ‡ï¼Œç”¨äºè¯„ä¼°æœåŠ¡æ˜¯å¦è¾¾åˆ°SLOç›®æ ‡ã€‚

**PostgreSQL SLIæŒ‡æ ‡**ï¼š

```sql
-- æ•°æ®åº“è¿æ¥æˆåŠŸç‡SLIï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_connection_success_rate NUMERIC;
BEGIN
    BEGIN
        BEGIN
            EXPLAIN (ANALYZE, BUFFERS, TIMING)
            SELECT
                COUNT(*) FILTER (WHERE state = 'active')::float / COUNT(*)::float * 100 AS connection_success_rate
            INTO v_connection_success_rate
            FROM pg_stat_activity;

            IF v_connection_success_rate IS NOT NULL THEN
                RAISE NOTICE 'æ•°æ®åº“è¿æ¥æˆåŠŸç‡SLI: %%%', v_connection_success_rate;
            ELSE
                RAISE WARNING 'æ— æ³•è®¡ç®—è¿æ¥æˆåŠŸç‡';
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—è¿æ¥æˆåŠŸç‡å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæ•°æ®åº“è¿æ¥æˆåŠŸç‡SLI
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) FILTER (WHERE state = 'active')::float / COUNT(*)::float * 100 AS connection_success_rate
FROM pg_stat_activity;

-- æŸ¥è¯¢å“åº”æ—¶é—´SLIï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_p95_latency NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'æ‰©å±• pg_stat_statements æœªå®‰è£…ï¼Œæ— æ³•è®¡ç®—æŸ¥è¯¢å“åº”æ—¶é—´SLI';
            RETURN;
        END IF;

        BEGIN
            EXPLAIN (ANALYZE, BUFFERS, TIMING)
            SELECT
                percentile_cont(0.95) WITHIN GROUP (ORDER BY mean_exec_time) AS p95_latency
            INTO v_p95_latency
            FROM pg_stat_statements;

            IF v_p95_latency IS NOT NULL THEN
                RAISE NOTICE 'æŸ¥è¯¢å“åº”æ—¶é—´SLI (P95): % ms', v_p95_latency;
            ELSE
                RAISE WARNING 'æ— æ³•è®¡ç®—æŸ¥è¯¢å“åº”æ—¶é—´';
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—æŸ¥è¯¢å“åº”æ—¶é—´å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢å“åº”æ—¶é—´SLI
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    percentile_cont(0.95) WITHIN GROUP (ORDER BY mean_exec_time) AS p95_latency
FROM pg_stat_statements;
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šå¯ç”¨æ€§æµ‹é‡æ–¹æ³•

### 2.1 æ•…éšœæ£€æµ‹æœºåˆ¶

**æ•…éšœæ£€æµ‹æ–¹æ³•**ï¼š

1. **å¿ƒè·³æ£€æµ‹**
   - å®šæœŸå‘é€å¿ƒè·³åŒ…
   - æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜æ´»
   - è¶…æ—¶åˆ¤å®šæ•…éšœ

2. **å¥åº·æ£€æŸ¥**
   - å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥æŸ¥è¯¢
   - æ£€æµ‹æ•°æ®åº“æ˜¯å¦æ­£å¸¸
   - è¿”å›å¥åº·çŠ¶æ€

**PostgreSQLå®ç°**ï¼š

```sql
-- å¥åº·æ£€æŸ¥æŸ¥è¯¢ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_health_check INTEGER;
BEGIN
    BEGIN
        BEGIN
            EXPLAIN (ANALYZE, BUFFERS, TIMING)
            SELECT 1 INTO v_health_check;

            IF v_health_check = 1 THEN
                RAISE NOTICE 'å¥åº·æ£€æŸ¥é€šè¿‡';
            ELSE
                RAISE WARNING 'å¥åº·æ£€æŸ¥å¤±è´¥';
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'å¥åº·æ£€æŸ¥å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šå¥åº·æ£€æŸ¥æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT 1;

-- ç›‘æ§æŸ¥è¯¢ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_is_standby BOOLEAN;
    v_receive_lsn TEXT;
    v_replay_lsn TEXT;
BEGIN
    BEGIN
        BEGIN
            EXPLAIN (ANALYZE, BUFFERS, TIMING)
            SELECT
                pg_is_in_recovery() AS is_standby,
                pg_last_wal_receive_lsn()::text AS receive_lsn,
                pg_last_wal_replay_lsn()::text AS replay_lsn
            INTO v_is_standby, v_receive_lsn, v_replay_lsn;

            IF v_is_standby THEN
                RAISE NOTICE 'å½“å‰èŠ‚ç‚¹æ˜¯å¤‡åº“: receive_lsn=%, replay_lsn=%', v_receive_lsn, v_replay_lsn;
            ELSE
                RAISE NOTICE 'å½“å‰èŠ‚ç‚¹æ˜¯ä¸»åº“';
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'ç›‘æ§æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šç›‘æ§æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_is_in_recovery() AS is_standby,
    pg_last_wal_receive_lsn() AS receive_lsn,
    pg_last_wal_replay_lsn() AS replay_lsn;
```

### 2.2 æ•…éšœæ¢å¤æ—¶é—´

**æ•…éšœæ¢å¤æ—¶é—´æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | å®šä¹‰ | PostgreSQLå®ç° |
|------|------|---------------|
| **MTTR** | å¹³å‡æ•…éšœæ¢å¤æ—¶é—´ | æ•…éšœè½¬ç§»æ—¶é—´ |
| **MTBF** | å¹³å‡æ•…éšœé—´éš”æ—¶é—´ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´ |
| **RTO** | æ¢å¤æ—¶é—´ç›®æ ‡ | æ•…éšœè½¬ç§»ç›®æ ‡æ—¶é—´ |
| **RPO** | æ¢å¤ç‚¹ç›®æ ‡ | æ•°æ®ä¸¢å¤±çª—å£ |

**PostgreSQL RTO/RPOé…ç½®**ï¼š

```sql
-- RTOé…ç½®ï¼šæ•…éšœè½¬ç§»æ—¶é—´ < 5åˆ†é’Ÿ
-- å®ç°ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§» + å¿«é€Ÿæ£€æµ‹

-- RPOé…ç½®ï¼šæ•°æ®ä¸¢å¤±çª—å£ < 1åˆ†é’Ÿ
-- å®ç°ï¼šåŒæ­¥å¤åˆ¶æˆ–ä½å»¶è¿Ÿå¼‚æ­¥å¤åˆ¶
ALTER SYSTEM SET synchronous_standby_names = 'standby1';
ALTER SYSTEM SET synchronous_commit = 'remote_write';
```

### 2.3 å¯ç”¨æ€§è®¡ç®—å…¬å¼

**å¯ç”¨æ€§è®¡ç®—å…¬å¼**ï¼š

$$
\text{Availability} = \frac{\text{Uptime}}{\text{Uptime} + \text{Downtime}} \times 100\%
$$

**MTTRå’ŒMTBFå…³ç³»**ï¼š

$$
\text{Availability} = \frac{\text{MTBF}}{\text{MTBF} + \text{MTTR}} \times 100\%
$$

**PostgreSQLå¯ç”¨æ€§è®¡ç®—**ï¼š

```sql
-- è®¡ç®—æ•°æ®åº“å¯ç”¨æ€§ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_availability_percent NUMERIC;
    v_uptime NUMERIC;
    v_downtime NUMERIC;
BEGIN
    BEGIN
        BEGIN
            -- æ£€æŸ¥downtime_logè¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'downtime_log') THEN
                RAISE WARNING 'è¡¨ downtime_log ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç®€åŒ–è®¡ç®—ï¼ˆä»…åŸºäºå¯åŠ¨æ—¶é—´ï¼‰';

                BEGIN
                    EXPLAIN (ANALYZE, BUFFERS, TIMING)
                    SELECT
                        EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time()))::float AS uptime
                    INTO v_uptime;

                    IF v_uptime > 0 THEN
                        v_availability_percent := 100.0;  -- å‡è®¾æ— åœæœºæ—¶é—´
                        RAISE NOTICE 'æ•°æ®åº“å¯ç”¨æ€§ï¼ˆç®€åŒ–è®¡ç®—ï¼‰: %%% (è¿è¡Œæ—¶é—´: % ç§’)', v_availability_percent, v_uptime;
                    ELSE
                        RAISE WARNING 'æ— æ³•è®¡ç®—å¯ç”¨æ€§';
                    END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        RAISE WARNING 'è®¡ç®—å¯ç”¨æ€§å¤±è´¥: %', SQLERRM;
                        RAISE;
                END;
            ELSE
                BEGIN
                    EXPLAIN (ANALYZE, BUFFERS, TIMING)
                    SELECT
                        (EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time())) -
                         COALESCE((SELECT SUM(downtime) FROM downtime_log), 0))::float /
                        EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time()))::float * 100 AS availability_percent
                    INTO v_availability_percent;

                    IF v_availability_percent IS NOT NULL THEN
                        RAISE NOTICE 'æ•°æ®åº“å¯ç”¨æ€§: %%%', v_availability_percent;
                    ELSE
                        RAISE WARNING 'æ— æ³•è®¡ç®—å¯ç”¨æ€§';
                    END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        RAISE WARNING 'è®¡ç®—å¯ç”¨æ€§å¤±è´¥: %', SQLERRM;
                        RAISE;
                END;
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šè®¡ç®—æ•°æ®åº“å¯ç”¨æ€§
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    CASE
        WHEN EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'downtime_log') THEN
            (EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time())) -
             COALESCE((SELECT SUM(downtime) FROM downtime_log), 0))::float /
            EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time()))::float * 100
        ELSE
            100.0  -- ç®€åŒ–è®¡ç®—
    END AS availability_percent;
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šPostgreSQLé«˜å¯ç”¨å®ç°

### 3.1 æµå¤åˆ¶é«˜å¯ç”¨

**æµå¤åˆ¶é«˜å¯ç”¨é…ç½®**ï¼š

```sql
-- ä¸»åº“é…ç½®
wal_level = replica
max_wal_senders = 10
synchronous_standby_names = 'standby1'  -- è‡³å°‘ä¸€ä¸ªåŒæ­¥å¤‡åº“

-- å¤‡åº“é…ç½®
primary_conninfo = 'host=primary_host port=5432 user=replicator'
```

**é«˜å¯ç”¨ç‰¹å¾**ï¼š

- âœ… **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šä¸»åº“æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡åº“
- âœ… **æ•°æ®åŒæ­¥**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… **å¿«é€Ÿæ¢å¤**ï¼šRTO < 5åˆ†é’Ÿ

### 3.2 é€»è¾‘å¤åˆ¶é«˜å¯ç”¨

**é€»è¾‘å¤åˆ¶é«˜å¯ç”¨é…ç½®**ï¼š

```sql
-- ä¸»åº“ï¼šåˆ›å»ºå‘å¸ƒï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'mypub') THEN
            RAISE NOTICE 'å‘å¸ƒ mypub å·²å­˜åœ¨';
        ELSE
            BEGIN
                CREATE PUBLICATION mypub FOR ALL TABLES;
                RAISE NOTICE 'å‘å¸ƒ mypub åˆ›å»ºæˆåŠŸï¼ˆåŒ…å«æ‰€æœ‰è¡¨ï¼‰';
            EXCEPTION
                WHEN duplicate_object THEN
                    RAISE WARNING 'å‘å¸ƒ mypub å·²å­˜åœ¨';
                WHEN OTHERS THEN
                    RAISE WARNING 'åˆ›å»ºå‘å¸ƒå¤±è´¥: %', SQLERRM;
                    RAISE;
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤‡åº“ï¼šåˆ›å»ºè®¢é˜…ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'mypub') THEN
            RAISE WARNING 'å‘å¸ƒ mypub ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè®¢é˜…';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_subscription WHERE subname = 'mysub') THEN
            RAISE NOTICE 'è®¢é˜… mysub å·²å­˜åœ¨';
        ELSE
            BEGIN
                CREATE SUBSCRIPTION mysub
                CONNECTION 'host=primary_host port=5432 dbname=mydb user=replicator'
                PUBLICATION mypub;
                RAISE NOTICE 'è®¢é˜… mysub åˆ›å»ºæˆåŠŸ';
            EXCEPTION
                WHEN duplicate_object THEN
                    RAISE WARNING 'è®¢é˜… mysub å·²å­˜åœ¨';
                WHEN sqlclient_unable_to_establish_sqlconnection THEN
                    RAISE WARNING 'æ— æ³•è¿æ¥åˆ°ä¸»åº“ï¼Œè¯·æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²';
                WHEN OTHERS THEN
                    RAISE WARNING 'åˆ›å»ºè®¢é˜…å¤±è´¥: %', SQLERRM;
                    RAISE;
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**é«˜å¯ç”¨ç‰¹å¾**ï¼š

- âœ… **è¡¨çº§å¤åˆ¶**ï¼šå¯ä»¥é€‰æ‹©æ€§å¤åˆ¶è¡¨
- âœ… **è·¨ç‰ˆæœ¬æ”¯æŒ**ï¼šæ”¯æŒä¸åŒPostgreSQLç‰ˆæœ¬
- âœ… **çµæ´»é…ç½®**ï¼šå¯ä»¥è‡ªå®šä¹‰å¤åˆ¶è§„åˆ™

### 3.3 æ•…éšœè½¬ç§»æœºåˆ¶

**æ•…éšœè½¬ç§»æµç¨‹**ï¼š

```text
1. æ£€æµ‹ä¸»åº“æ•…éšœ
   â”‚
2. é€‰æ‹©æœ€ä½³å¤‡åº“
   â”‚
3. æå‡å¤‡åº“ä¸ºä¸»åº“
   â”‚
4. æ›´æ–°è¿æ¥é…ç½®
   â”‚
5. æ¢å¤æœåŠ¡
```

**PostgreSQLæ•…éšœè½¬ç§»å·¥å…·**ï¼š

- **pg_auto_failover**ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»
- **Patroni**ï¼šé«˜å¯ç”¨ç®¡ç†å·¥å…·
- **repmgr**ï¼šå¤åˆ¶ç®¡ç†å™¨

---

## ğŸ“Š ç¬¬å››éƒ¨åˆ†ï¼šå¯ç”¨æ€§ç›‘æ§ä¸å‘Šè­¦

### 4.1 ç›‘æ§æŒ‡æ ‡

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- æ•°æ®åº“è¿æ¥æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_active_connections INTEGER;
BEGIN
    BEGIN
        BEGIN
            EXPLAIN (ANALYZE, BUFFERS, TIMING)
            SELECT COUNT(*) INTO v_active_connections
            FROM pg_stat_activity WHERE state = 'active';

            RAISE NOTICE 'å½“å‰æ´»è·ƒè¿æ¥æ•°: %', v_active_connections;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥è¯¢è¿æ¥æ•°å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæ•°æ®åº“è¿æ¥æ•°
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active';
```

-- å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes
FROM pg_stat_replication;

-- æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size(current_database()));

-- äº‹åŠ¡ç»Ÿè®¡
SELECT
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname = current_database();

```


### 4.2 å‘Šè­¦è§„åˆ™

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: postgresql_availability
    rules:
      - alert: DatabaseDown
        expr: up{job="postgresql"} == 0
        for: 1m
        annotations:
          summary: "PostgreSQLæ•°æ®åº“ä¸å¯ç”¨"

      - alert: HighReplicationLag
        expr: pg_replication_lag_bytes > 104857600  # 100MB
        for: 5m
        annotations:
          summary: "å¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
```

### 4.3 å¯ç”¨æ€§Dashboard

**Grafana Dashboardé…ç½®**ï¼š

- **å¯ç”¨æ€§æŒ‡æ ‡**ï¼šæ•°æ®åº“è¿æ¥æˆåŠŸç‡ã€æŸ¥è¯¢æˆåŠŸç‡
- **æ€§èƒ½æŒ‡æ ‡**ï¼šæŸ¥è¯¢å»¶è¿Ÿã€ååé‡
- **å¤åˆ¶æŒ‡æ ‡**ï¼šå¤åˆ¶å»¶è¿Ÿã€åŒæ­¥çŠ¶æ€
- **æ•…éšœæŒ‡æ ‡**ï¼šæ•…éšœæ¬¡æ•°ã€æ¢å¤æ—¶é—´

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒç»“è®º

1. **SLA/SLO/SLI**ï¼šå®šä¹‰å¯ç”¨æ€§çš„ä¸‰ä¸ªå±‚æ¬¡æŒ‡æ ‡
2. **æ•…éšœæ£€æµ‹ä¸æ¢å¤**ï¼šå¯ç”¨æ€§çš„å…³é”®æµ‹é‡ç»´åº¦
3. **PostgreSQLé«˜å¯ç”¨**ï¼šé€šè¿‡æµå¤åˆ¶å’Œæ•…éšœè½¬ç§»å®ç°é«˜å¯ç”¨æ€§
4. **ç›‘æ§ä¸å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å¯ç”¨æ€§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

### å®è·µå»ºè®®

1. **å®šä¹‰å¯ç”¨æ€§ç›®æ ‡**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šä¹‰SLA/SLO
2. **å®ç°é«˜å¯ç”¨æ¶æ„**ï¼šä½¿ç”¨æµå¤åˆ¶å’Œæ•…éšœè½¬ç§»
3. **ç›‘æ§å¯ç”¨æ€§æŒ‡æ ‡**ï¼šå®æ—¶ç›‘æ§æ•°æ®åº“å¯ç”¨æ€§
4. **è®¾ç½®å‘Šè­¦è§„åˆ™**ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†æ•…éšœ

---

## ğŸ“š å¤–éƒ¨èµ„æºå¼•ç”¨

### Wikipediaèµ„æº

1. **å¯ç”¨æ€§ç›¸å…³**ï¼š
   - [High Availability](https://en.wikipedia.org/wiki/High_availability)
   - [Availability](https://en.wikipedia.org/wiki/Availability)
   - [Service Level Agreement](https://en.wikipedia.org/wiki/Service-level_agreement)
   - [Service Level Objective](https://en.wikipedia.org/wiki/Service-level_objective)

2. **æ•…éšœå¤„ç†**ï¼š
   - [Fault Tolerance](https://en.wikipedia.org/wiki/Fault_tolerance)
   - [Failover](https://en.wikipedia.org/wiki/Failover)
   - [Disaster Recovery](https://en.wikipedia.org/wiki/Disaster_recovery)

3. **ç›‘æ§ç›¸å…³**ï¼š
   - [Monitoring (computer science)](https://en.wikipedia.org/wiki/Monitoring_(computer_science))
   - [Application Performance Management](https://en.wikipedia.org/wiki/Application_performance_management)

### å­¦æœ¯è®ºæ–‡

1. **å¯ç”¨æ€§ç†è®º**ï¼š
   - Gray, J., & Siewiorek, D. P. (1991). "High-Availability Computer Systems"
   - Patterson, D. A., et al. (1988). "A Case for Redundant Arrays of Inexpensive Disks (RAID)"

2. **SLA/SLO**ï¼š
   - Harchol-Balter, M. (2013). "Performance Modeling and Design of Computer Systems"
   - Almeida, J., et al. (2000). "Resource Management in the Automated Service Factory"

### å®˜æ–¹æ–‡æ¡£

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£**ï¼š
   - [High Availability](https://www.postgresql.org/docs/current/high-availability.html)
   - [Streaming Replication](https://www.postgresql.org/docs/current/high-availability.html)
   - [Failover](https://www.postgresql.org/docs/current/high-availability.html)

2. **ç›‘æ§å·¥å…·æ–‡æ¡£**ï¼š
   - [Prometheus Documentation](https://prometheus.io/docs/)
   - [Grafana Documentation](https://grafana.com/docs/)

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… å·²å®Œæˆ
```
