# PostgreSQLå¢é•¿é¢„æµ‹æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLå¢é•¿é¢„æµ‹æŒ‡å—](#postgresqlå¢é•¿é¢„æµ‹æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ•°æ®å¢é•¿é¢„æµ‹](#2-æ•°æ®å¢é•¿é¢„æµ‹)
    - [2.1 å†å²å¢é•¿åˆ†æ](#21-å†å²å¢é•¿åˆ†æ)
    - [2.2 å¢é•¿è¶‹åŠ¿](#22-å¢é•¿è¶‹åŠ¿)
  - [3. è´Ÿè½½å¢é•¿é¢„æµ‹](#3-è´Ÿè½½å¢é•¿é¢„æµ‹)
    - [3.1 æŸ¥è¯¢å¢é•¿](#31-æŸ¥è¯¢å¢é•¿)
    - [3.2 è¿æ¥å¢é•¿](#32-è¿æ¥å¢é•¿)
  - [4. é¢„æµ‹æ¨¡å‹](#4-é¢„æµ‹æ¨¡å‹)
    - [4.1 çº¿æ€§æ¨¡å‹](#41-çº¿æ€§æ¨¡å‹)
    - [4.2 æŒ‡æ•°æ¨¡å‹](#42-æŒ‡æ•°æ¨¡å‹)
  - [5. é¢„æµ‹éªŒè¯](#5-é¢„æµ‹éªŒè¯)
    - [5.1 é¢„æµ‹å‡†ç¡®æ€§](#51-é¢„æµ‹å‡†ç¡®æ€§)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å¢é•¿é¢„æµ‹æ˜¯å®¹é‡è§„åˆ’çš„å…³é”®ï¼Œéœ€è¦å‡†ç¡®é¢„æµ‹æœªæ¥å¢é•¿è¶‹åŠ¿ã€‚

**é¢„æµ‹å†…å®¹**:

- æ•°æ®å¢é•¿
- è´Ÿè½½å¢é•¿
- ç”¨æˆ·å¢é•¿
- æŸ¥è¯¢å¢é•¿

---

## 2. æ•°æ®å¢é•¿é¢„æµ‹

### 2.1 å†å²å¢é•¿åˆ†æ

```sql
-- è®¡ç®—è¡¨å¢é•¿ç‡ï¼ˆéœ€è¦å†å²æ•°æ®ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    current_size bigint;
    one_year_size bigint;
    growth_rate numeric := 0.1;  -- æ¯æœˆå¢é•¿10%
    months int := 12;
    total_current_size bigint := 0;
    total_one_year_size bigint := 0;
BEGIN
    RAISE NOTICE 'å¼€å§‹è®¡ç®—è¡¨å¢é•¿ç‡...';

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = 'public'
        ORDER BY tablename
    LOOP
        BEGIN
            current_size := pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);
            one_year_size := current_size * POWER(1 + growth_rate, months);

            total_current_size := total_current_size + current_size;
            total_one_year_size := total_one_year_size + one_year_size;

            RAISE NOTICE 'è¡¨ %.% - å½“å‰å¤§å°: %, ä¸€å¹´åé¢„æµ‹: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(current_size),
                pg_size_pretty(one_year_size);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—è¡¨ %.% å¢é•¿ç‡å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'æ‰€æœ‰è¡¨å½“å‰æ€»å¤§å°: %', pg_size_pretty(total_current_size);
    RAISE NOTICE 'æ‰€æœ‰è¡¨ä¸€å¹´åé¢„æµ‹æ€»å¤§å°: %', pg_size_pretty(total_one_year_size);
    RAISE NOTICE 'é¢„æµ‹å¢é•¿ç‡: %%', ROUND((total_one_year_size::numeric / NULLIF(total_current_size, 0)::numeric - 1) * 100, 2);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®¡ç®—è¡¨å¢é•¿ç‡å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢è¡¨å¢é•¿ç‡
EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS current_size,
    pg_total_relation_size(schemaname||'.'||tablename) AS current_size_bytes,
    -- å‡è®¾æ¯æœˆå¢é•¿10%
    pg_total_relation_size(schemaname||'.'||tablename) * POWER(1.1, 12) AS one_year_size_bytes,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) * POWER(1.1, 12)) AS one_year_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY current_size_bytes DESC;
```

### 2.2 å¢é•¿è¶‹åŠ¿

```text
- çº¿æ€§å¢é•¿ï¼šç¨³å®šå¢é•¿
- æŒ‡æ•°å¢é•¿ï¼šå¿«é€Ÿå¢é•¿
- å‘¨æœŸæ€§å¢é•¿ï¼šå­£èŠ‚æ€§å˜åŒ–
```

---

## 3. è´Ÿè½½å¢é•¿é¢„æµ‹

### 3.1 æŸ¥è¯¢å¢é•¿

```sql
-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡ï¼ˆéœ€è¦pg_stat_statementsï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    ext_exists boolean;
    query_record RECORD;
    total_calls bigint := 0;
BEGIN
    -- æ£€æŸ¥æ‰©å±•æ˜¯å¦å­˜åœ¨
    SELECT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) INTO ext_exists;

    IF NOT ext_exists THEN
        RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢ç»Ÿè®¡';
        RAISE NOTICE 'è¯·å…ˆè¿è¡Œ: CREATE EXTENSION pg_stat_statements;';
        RETURN;
    END IF;

    RAISE NOTICE 'æŸ¥è¯¢ç»Ÿè®¡ï¼ˆå‰10ä¸ªæœ€é¢‘ç¹çš„æŸ¥è¯¢ï¼‰:';

    FOR query_record IN
        SELECT
            LEFT(query, 100) as query_preview,
            calls,
            total_exec_time,
            mean_exec_time
        FROM pg_stat_statements
        ORDER BY calls DESC
        LIMIT 10
    LOOP
        total_calls := total_calls + query_record.calls;
        RAISE NOTICE 'æŸ¥è¯¢: % | è°ƒç”¨æ¬¡æ•°: % | æ€»æ‰§è¡Œæ—¶é—´: % ms | å¹³å‡æ‰§è¡Œæ—¶é—´: % ms',
            query_record.query_preview,
            query_record.calls,
            ROUND(query_record.total_exec_time, 2),
            ROUND(query_record.mean_exec_time, 2);
    END LOOP;

    RAISE NOTICE 'å‰10ä¸ªæŸ¥è¯¢æ€»è°ƒç”¨æ¬¡æ•°: %', total_calls;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥è¯¢ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢ç»Ÿè®¡
EXPLAIN ANALYZE
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    ROUND(total_exec_time / NULLIF(calls, 0), 2) as avg_time_per_call
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 10;
```

### 3.2 è¿æ¥å¢é•¿

```text
ç›‘æ§è¿æ¥æ•°å¢é•¿è¶‹åŠ¿
- å½“å‰è¿æ¥æ•°
- å³°å€¼è¿æ¥æ•°
- è¿æ¥æ•°å¢é•¿è¶‹åŠ¿
```

---

## 4. é¢„æµ‹æ¨¡å‹

### 4.1 çº¿æ€§æ¨¡å‹

```text
æœªæ¥å®¹é‡ = å½“å‰å®¹é‡ Ã— (1 + å¢é•¿ç‡ Ã— æ—¶é—´å‘¨æœŸ)
```

### 4.2 æŒ‡æ•°æ¨¡å‹

```text
æœªæ¥å®¹é‡ = å½“å‰å®¹é‡ Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
```

---

## 5. é¢„æµ‹éªŒè¯

### 5.1 é¢„æµ‹å‡†ç¡®æ€§

```text
- å®šæœŸéªŒè¯é¢„æµ‹å‡†ç¡®æ€§
- è°ƒæ•´é¢„æµ‹æ¨¡å‹
- æ›´æ–°é¢„æµ‹å‚æ•°
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—.md](./å®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—.md) - å®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—
- [èµ„æºè§„åˆ’.md](./èµ„æºè§„åˆ’.md) - èµ„æºè§„åˆ’æŒ‡å—
- [31-å®¹é‡è§„åˆ’/README.md](./README.md) - å®¹é‡è§„åˆ’ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
