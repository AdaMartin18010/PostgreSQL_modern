# PostgreSQL容量监控指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL容量监控指南](#postgresql容量监控指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 存储监控](#2-存储监控)
    - [2.1 存储使用监控](#21-存储使用监控)
    - [2.2 表大小监控](#22-表大小监控)
  - [3. 计算监控](#3-计算监控)
    - [3.1 CPU监控](#31-cpu监控)
    - [3.2 内存监控](#32-内存监控)
  - [4. 告警设置](#4-告警设置)
    - [4.1 告警阈值](#41-告警阈值)
    - [4.2 告警通知](#42-告警通知)
  - [5. 监控报告](#5-监控报告)
    - [5.1 监控报告内容](#51-监控报告内容)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

容量监控是容量规划的重要组成部分，需要建立完善的监控体系。

**监控内容**:

- 存储容量监控
- 计算容量监控
- 网络容量监控
- 连接容量监控

---

## 2. 存储监控

### 2.1 存储使用监控

```sql
-- 监控数据库大小
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size,
    round(100.0 * pg_database_size(datname) /
          (SELECT sum(pg_database_size(datname)) FROM pg_database), 2) AS percent
FROM pg_database
ORDER BY pg_database_size(datname) DESC;
```

### 2.2 表大小监控

```sql
-- 监控表大小增长
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

---

## 3. 计算监控

### 3.1 CPU监控

```sql
-- 监控CPU使用（需要pg_stat_statements）
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 3.2 内存监控

```sql
-- 监控内存使用
SELECT
    name,
    setting,
    unit
FROM pg_settings
WHERE name IN ('shared_buffers', 'effective_cache_size', 'work_mem');
```

---

## 4. 告警设置

### 4.1 告警阈值

```text
- 存储使用率 > 80%：警告
- 存储使用率 > 90%：严重
- CPU使用率 > 80%：警告
- 连接数使用率 > 80%：警告
```

### 4.2 告警通知

```text
- 邮件通知
- 短信通知
- 企业微信/钉钉通知
```

---

## 5. 监控报告

### 5.1 监控报告内容

```text
- 当前容量使用情况
- 容量使用趋势
- 容量告警情况
- 容量规划建议
```

---

## 📚 相关文档

- [容量规划完整指南.md](./容量规划完整指南.md) - 容量规划完整指南
- [容量评估方法.md](./容量评估方法.md) - 容量评估方法详解
- [31-容量规划/README.md](./README.md) - 容量规划主题

---

**最后更新**: 2025年1月
