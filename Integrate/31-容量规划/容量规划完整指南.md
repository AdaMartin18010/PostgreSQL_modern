# PostgreSQLå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—](#postgresqlå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å®¹é‡è§„åˆ’æµç¨‹](#2-å®¹é‡è§„åˆ’æµç¨‹)
    - [2.1 è§„åˆ’æ­¥éª¤](#21-è§„åˆ’æ­¥éª¤)
    - [2.2 è§„åˆ’å‘¨æœŸ](#22-è§„åˆ’å‘¨æœŸ)
  - [3. å®¹é‡è¯„ä¼°](#3-å®¹é‡è¯„ä¼°)
    - [3.1 å­˜å‚¨å®¹é‡](#31-å­˜å‚¨å®¹é‡)
    - [3.2 è®¡ç®—å®¹é‡](#32-è®¡ç®—å®¹é‡)
  - [4. å¢é•¿é¢„æµ‹](#4-å¢é•¿é¢„æµ‹)
    - [4.1 æ•°æ®å¢é•¿é¢„æµ‹](#41-æ•°æ®å¢é•¿é¢„æµ‹)
    - [4.2 å¢é•¿è¶‹åŠ¿åˆ†æ](#42-å¢é•¿è¶‹åŠ¿åˆ†æ)
  - [5. èµ„æºè§„åˆ’](#5-èµ„æºè§„åˆ’)
    - [5.1 å­˜å‚¨è§„åˆ’](#51-å­˜å‚¨è§„åˆ’)
    - [5.2 è®¡ç®—è§„åˆ’](#52-è®¡ç®—è§„åˆ’)
  - [6. å®æˆ˜æ¡ˆä¾‹](#6-å®æˆ˜æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿå®¹é‡è§„åˆ’](#61-æ¡ˆä¾‹1ç”µå•†ç³»ç»Ÿå®¹é‡è§„åˆ’)
    - [6.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—ç³»ç»Ÿå®¹é‡è§„åˆ’](#62-æ¡ˆä¾‹2æ—¥å¿—ç³»ç»Ÿå®¹é‡è§„åˆ’)
    - [6.3 æ¡ˆä¾‹3ï¼šåˆ†æç³»ç»Ÿå®¹é‡è§„åˆ’](#63-æ¡ˆä¾‹3åˆ†æç³»ç»Ÿå®¹é‡è§„åˆ’)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âš ï¸ æ³¨æ„äº‹é¡¹](#ï¸-æ³¨æ„äº‹é¡¹)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å®¹é‡è§„åˆ’æ˜¯ç¡®ä¿æ•°æ®åº“ç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³æœªæ¥éœ€æ±‚çš„å…³é”®æ´»åŠ¨ã€‚

**è§„åˆ’ç›®æ ‡**:

- é¢„æµ‹æœªæ¥å®¹é‡éœ€æ±‚
- è§„åˆ’èµ„æºå¢é•¿
- é¿å…å®¹é‡ç“¶é¢ˆ
- ä¼˜åŒ–èµ„æºä½¿ç”¨

---

## 2. å®¹é‡è§„åˆ’æµç¨‹

### 2.1 è§„åˆ’æ­¥éª¤

```text
1. å½“å‰å®¹é‡è¯„ä¼°
   â†“
2. å¢é•¿è¶‹åŠ¿åˆ†æ
   â†“
3. æœªæ¥éœ€æ±‚é¢„æµ‹
   â†“
4. èµ„æºè§„åˆ’åˆ¶å®š
   â†“
5. æ‰©å®¹ç­–ç•¥åˆ¶å®š
   â†“
6. å®¹é‡ç›‘æ§å»ºç«‹
```

### 2.2 è§„åˆ’å‘¨æœŸ

```text
- çŸ­æœŸè§„åˆ’ï¼š1-3ä¸ªæœˆ
- ä¸­æœŸè§„åˆ’ï¼š3-12ä¸ªæœˆ
- é•¿æœŸè§„åˆ’ï¼š1-3å¹´
```

---

## 3. å®¹é‡è¯„ä¼°

### 3.1 å­˜å‚¨å®¹é‡

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_record RECORD;
    total_size bigint := 0;
    db_count int := 0;
BEGIN
    RAISE NOTICE 'å¼€å§‹è¯„ä¼°æ•°æ®åº“å¤§å°...';

    FOR db_record IN
        SELECT datname
        FROM pg_database
        WHERE datistemplate = false
        ORDER BY pg_database_size(datname) DESC
    LOOP
        BEGIN
            db_count := db_count + 1;
            total_size := total_size + pg_database_size(db_record.datname);

            RAISE NOTICE 'æ•°æ®åº“ % å¤§å°: %',
                db_record.datname,
                pg_size_pretty(pg_database_size(db_record.datname));
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è¯„ä¼°æ•°æ®åº“ % å¤§å°å¤±è´¥: %', db_record.datname, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'è¯„ä¼°å®Œæˆ: % ä¸ªæ•°æ®åº“ï¼Œæ€»å¤§å°: %', db_count, pg_size_pretty(total_size);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ•°æ®åº“å¤§å°è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size,
    pg_database_size(datname) AS size_bytes
FROM pg_database
WHERE datistemplate = false
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    schema_name text := 'public';
    total_size bigint := 0;
    table_count int := 0;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹è¯„ä¼°Schema % ä¸­çš„è¡¨å¤§å°...', schema_name;

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
    LOOP
        BEGIN
            table_count := table_count + 1;
            total_size := total_size + pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);

            RAISE NOTICE 'è¡¨ %.% å¤§å°: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename));
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è¯„ä¼°è¡¨ %.% å¤§å°å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'è¯„ä¼°å®Œæˆ: % ä¸ªè¡¨ï¼Œæ€»å¤§å°: %', table_count, pg_size_pretty(total_size);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¡¨å¤§å°è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 è®¡ç®—å®¹é‡

```sql
-- æŸ¥çœ‹è¿æ¥æ•°ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_connections int;
    max_connections int;
    usage_percent numeric;
    warning_threshold numeric := 80.0;
    critical_threshold numeric := 90.0;
BEGIN
    -- è·å–å½“å‰è¿æ¥æ•°
    SELECT COUNT(*) INTO current_connections
    FROM pg_stat_activity;

    -- è·å–æœ€å¤§è¿æ¥æ•°
    SELECT setting::int INTO max_connections
    FROM pg_settings
    WHERE name = 'max_connections';

    IF max_connections IS NULL OR max_connections = 0 THEN
        RAISE EXCEPTION 'æ— æ³•è·å–æœ€å¤§è¿æ¥æ•°é…ç½®';
    END IF;

    -- è®¡ç®—ä½¿ç”¨ç‡
    usage_percent := ROUND(100.0 * current_connections / NULLIF(max_connections, 0), 2);

    RAISE NOTICE 'å½“å‰è¿æ¥æ•°: % / % (ä½¿ç”¨ç‡: %%)',
        current_connections, max_connections, usage_percent;

    -- æ£€æŸ¥é˜ˆå€¼
    IF usage_percent >= critical_threshold THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (ä¸¥é‡å‘Šè­¦ï¼Œè¶…è¿‡%%)',
            usage_percent, critical_threshold;
    ELSIF usage_percent >= warning_threshold THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (è­¦å‘Šï¼Œè¶…è¿‡%%)',
            usage_percent, warning_threshold;
    ELSE
        RAISE NOTICE 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (æ­£å¸¸)', usage_percent;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    COUNT(*) AS current_connections,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max_connections,
    ROUND(100.0 * COUNT(*) / NULLIF((SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 0), 2) AS usage_percent
FROM pg_stat_activity;
```

---

## 4. å¢é•¿é¢„æµ‹

### 4.1 æ•°æ®å¢é•¿é¢„æµ‹

```sql
-- è®¡ç®—è¡¨å¢é•¿ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    schema_name text := 'public';
    current_size bigint;
    next_month_size bigint;
    growth_rate numeric := 0.1;  -- æ¯æœˆå¢é•¿10%
    total_current_size bigint := 0;
    total_next_month_size bigint := 0;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹è®¡ç®—è¡¨å¢é•¿ç‡ï¼ˆå‡è®¾æ¯æœˆå¢é•¿10%%ï¼‰...';

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY tablename
    LOOP
        BEGIN
            current_size := pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);
            next_month_size := current_size * (1 + growth_rate);

            total_current_size := total_current_size + current_size;
            total_next_month_size := total_next_month_size + next_month_size;

            RAISE NOTICE 'è¡¨ %.% - å½“å‰å¤§å°: %, ä¸‹æœˆé¢„æµ‹: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(current_size),
                pg_size_pretty(next_month_size);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—è¡¨ %.% å¢é•¿ç‡å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'æ±‡æ€» - å½“å‰æ€»å¤§å°: %, ä¸‹æœˆé¢„æµ‹æ€»å¤§å°: %',
        pg_size_pretty(total_current_size),
        pg_size_pretty(total_next_month_size);
    RAISE NOTICE 'é¢„æµ‹å¢é•¿ç‡: %%', ROUND((total_next_month_size::numeric / NULLIF(total_current_size, 0)::numeric - 1) * 100, 2);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¡¨å¢é•¿ç‡è®¡ç®—å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_total_relation_size(schemaname||'.'||tablename) AS current_size_bytes,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS current_size,
    -- å‡è®¾æ¯æœˆå¢é•¿10%
    pg_total_relation_size(schemaname||'.'||tablename) * 1.1 AS next_month_size_bytes,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) * 1.1) AS next_month_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 4.2 å¢é•¿è¶‹åŠ¿åˆ†æ

**å¢é•¿æ¨¡å¼è¯†åˆ«**ï¼š

```sql
-- åˆ†ææ•°æ®å¢é•¿è¶‹åŠ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    growth_record RECORD;
    schema_name text := 'public';
    current_size bigint;
    previous_size bigint;
    growth_rate numeric;
    growth_pattern text;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹åˆ†ææ•°æ®å¢é•¿è¶‹åŠ¿...';

    FOR growth_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY tablename
    LOOP
        BEGIN
            current_size := pg_total_relation_size(growth_record.schemaname||'.'||growth_record.tablename);

            -- å‡è®¾previous_sizeä¸ºå½“å‰å¤§å°çš„90%ï¼ˆæ¨¡æ‹Ÿå†å²æ•°æ®ï¼‰
            previous_size := current_size * 0.9;

            -- è®¡ç®—å¢é•¿ç‡
            growth_rate := ROUND((current_size::numeric / NULLIF(previous_size, 0)::numeric - 1) * 100, 2);

            -- åˆ¤æ–­å¢é•¿æ¨¡å¼
            IF growth_rate < 5 THEN
                growth_pattern := 'ç¨³å®šå¢é•¿';
            ELSIF growth_rate < 20 THEN
                growth_pattern := 'çº¿æ€§å¢é•¿';
            ELSIF growth_rate < 50 THEN
                growth_pattern := 'å¿«é€Ÿå¢é•¿';
            ELSE
                growth_pattern := 'æŒ‡æ•°å¢é•¿';
            END IF;

            RAISE NOTICE 'è¡¨ %.% - å½“å‰å¤§å°: % | å¢é•¿ç‡: %% | å¢é•¿æ¨¡å¼: %',
                growth_record.schemaname,
                growth_record.tablename,
                pg_size_pretty(current_size),
                growth_rate,
                growth_pattern;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'åˆ†æè¡¨ %.% å¢é•¿è¶‹åŠ¿å¤±è´¥: %',
                    growth_record.schemaname, growth_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'å¢é•¿è¶‹åŠ¿åˆ†æå®Œæˆ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'å¢é•¿è¶‹åŠ¿åˆ†æå¤±è´¥: %', SQLERRM;
END $$;
```

**å¢é•¿æ¨¡å¼è¯´æ˜**ï¼š

```text
1. çº¿æ€§å¢é•¿ï¼ˆLinear Growthï¼‰
   - ç‰¹ç‚¹ï¼šç¨³å®šå¢é•¿ï¼Œå¢é•¿ç‡ç›¸å¯¹å›ºå®š
   - é€‚ç”¨ï¼šä¸šåŠ¡ç¨³å®šå¢é•¿åœºæ™¯
   - é¢„æµ‹ï¼šä½¿ç”¨çº¿æ€§å›å½’æ¨¡å‹

2. æŒ‡æ•°å¢é•¿ï¼ˆExponential Growthï¼‰
   - ç‰¹ç‚¹ï¼šå¿«é€Ÿå¢é•¿ï¼Œå¢é•¿ç‡æŒç»­å¢åŠ 
   - é€‚ç”¨ï¼šä¸šåŠ¡å¿«é€Ÿæ‰©å¼ åœºæ™¯
   - é¢„æµ‹ï¼šä½¿ç”¨æŒ‡æ•°å¢é•¿æ¨¡å‹

3. å‘¨æœŸæ€§å¢é•¿ï¼ˆCyclical Growthï¼‰
   - ç‰¹ç‚¹ï¼šå­£èŠ‚æ€§å˜åŒ–ï¼Œæœ‰å‘¨æœŸæ€§æ³¢åŠ¨
   - é€‚ç”¨ï¼šå­£èŠ‚æ€§ä¸šåŠ¡åœºæ™¯
   - é¢„æµ‹ï¼šä½¿ç”¨æ—¶é—´åºåˆ—åˆ†ææ¨¡å‹

4. ç¨³å®šå¢é•¿ï¼ˆStable Growthï¼‰
   - ç‰¹ç‚¹ï¼šå¢é•¿ç¼“æ…¢ï¼Œå˜åŒ–ä¸å¤§
   - é€‚ç”¨ï¼šæˆç†Ÿä¸šåŠ¡åœºæ™¯
   - é¢„æµ‹ï¼šä½¿ç”¨ç§»åŠ¨å¹³å‡æ¨¡å‹
```

---

## 5. èµ„æºè§„åˆ’

### 5.1 å­˜å‚¨è§„åˆ’

**å­˜å‚¨éœ€æ±‚è®¡ç®—å…¬å¼**ï¼š

```sql
-- è®¡ç®—æœªæ¥å­˜å‚¨éœ€æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_size bigint;
    growth_rate numeric := 0.1;  -- æ¯æœˆå¢é•¿10%
    months int := 12;  -- é¢„æµ‹12ä¸ªæœˆ
    future_size bigint;
    reserved_size bigint;
    schema_name text := 'public';
    total_current_size bigint := 0;
    total_future_size bigint := 0;
    total_reserved_size bigint := 0;
    table_record RECORD;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹è®¡ç®—æœªæ¥å­˜å‚¨éœ€æ±‚ï¼ˆé¢„æµ‹%ä¸ªæœˆï¼Œå¢é•¿ç‡ï¼š%%ï¼‰...', months, growth_rate * 100;

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY tablename
    LOOP
        BEGIN
            current_size := pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);
            -- å­˜å‚¨éœ€æ±‚ = å½“å‰å¤§å° Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
            future_size := current_size * POWER(1 + growth_rate, months);
            -- é¢„ç•™ç©ºé—´ = å­˜å‚¨éœ€æ±‚ Ã— 1.2ï¼ˆ20%é¢„ç•™ï¼‰
            reserved_size := future_size * 1.2;

            total_current_size := total_current_size + current_size;
            total_future_size := total_future_size + future_size;
            total_reserved_size := total_reserved_size + reserved_size;

            RAISE NOTICE 'è¡¨ %.% - å½“å‰: % | %ä¸ªæœˆå: % | é¢„ç•™ç©ºé—´: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(current_size),
                months,
                pg_size_pretty(future_size),
                pg_size_pretty(reserved_size);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—è¡¨ %.% å­˜å‚¨éœ€æ±‚å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'æ±‡æ€» - å½“å‰æ€»å¤§å°: % | %ä¸ªæœˆåæ€»å¤§å°: % | é¢„ç•™ç©ºé—´: %',
        pg_size_pretty(total_current_size),
        months,
        pg_size_pretty(total_future_size),
        pg_size_pretty(total_reserved_size);
    RAISE NOTICE 'å¢é•¿ç‡: %%', ROUND((total_future_size::numeric / NULLIF(total_current_size, 0)::numeric - 1) * 100, 2);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®¡ç®—å­˜å‚¨éœ€æ±‚å¤±è´¥: %', SQLERRM;
END $$;
```

**å­˜å‚¨è§„åˆ’å»ºè®®**ï¼š

```text
å­˜å‚¨è§„åˆ’åŸåˆ™ï¼š
1. é¢„ç•™20-30%çš„é¢å¤–ç©ºé—´ï¼ˆç”¨äºä¸´æ—¶æ•°æ®ã€ç´¢å¼•ã€WALç­‰ï¼‰
2. è€ƒè™‘æ•°æ®å‹ç¼©ï¼ˆPostgreSQLæ”¯æŒè¡¨å‹ç¼©ï¼‰
3. è€ƒè™‘æ•°æ®å½’æ¡£ï¼ˆå°†å†å²æ•°æ®å½’æ¡£åˆ°å†·å­˜å‚¨ï¼‰
4. è€ƒè™‘åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼Œä¾¿äºç®¡ç†ï¼‰

å­˜å‚¨ç±»å‹é€‰æ‹©ï¼š
- SSDï¼šé€‚åˆé«˜IOPSéœ€æ±‚ï¼Œä½å»¶è¿Ÿåœºæ™¯
- NVMeï¼šé€‚åˆæé«˜IOPSéœ€æ±‚ï¼Œè¶…ä½å»¶è¿Ÿåœºæ™¯
- HDDï¼šé€‚åˆå¤§å®¹é‡ã€ä½æˆæœ¬åœºæ™¯
- äº‘å­˜å‚¨ï¼šé€‚åˆå¼¹æ€§æ‰©å±•ã€æŒ‰éœ€ä»˜è´¹åœºæ™¯
```

### 5.2 è®¡ç®—è§„åˆ’

**è®¡ç®—éœ€æ±‚è®¡ç®—å…¬å¼**ï¼š

```sql
-- è®¡ç®—æœªæ¥è®¡ç®—éœ€æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_cpu_usage numeric := 50.0;  -- å½“å‰CPUä½¿ç”¨ç‡50%
    current_memory_usage numeric := 60.0;  -- å½“å‰å†…å­˜ä½¿ç”¨ç‡60%
    growth_rate numeric := 0.1;  -- æ¯æœˆå¢é•¿10%
    months int := 12;  -- é¢„æµ‹12ä¸ªæœˆ
    future_cpu_usage numeric;
    future_memory_usage numeric;
    cpu_cores_needed numeric;
    memory_gb_needed numeric;
    current_cpu_cores numeric := 8;  -- å½“å‰8æ ¸
    current_memory_gb numeric := 32;  -- å½“å‰32GB
BEGIN
    RAISE NOTICE 'å¼€å§‹è®¡ç®—æœªæ¥è®¡ç®—éœ€æ±‚ï¼ˆé¢„æµ‹%ä¸ªæœˆï¼Œå¢é•¿ç‡ï¼š%%ï¼‰...', months, growth_rate * 100;

    -- CPUéœ€æ±‚ = å½“å‰CPUä½¿ç”¨ç‡ Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
    future_cpu_usage := current_cpu_usage * POWER(1 + growth_rate, months);

    -- å†…å­˜éœ€æ±‚ = å½“å‰å†…å­˜ä½¿ç”¨ç‡ Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
    future_memory_usage := current_memory_usage * POWER(1 + growth_rate, months);

    -- è®¡ç®—éœ€è¦çš„CPUæ ¸å¿ƒæ•°ï¼ˆå‡è®¾ç›®æ ‡ä½¿ç”¨ç‡80%ï¼‰
    cpu_cores_needed := CEIL((future_cpu_usage / 80.0) * current_cpu_cores);

    -- è®¡ç®—éœ€è¦çš„å†…å­˜GBæ•°ï¼ˆå‡è®¾ç›®æ ‡ä½¿ç”¨ç‡80%ï¼‰
    memory_gb_needed := CEIL((future_memory_usage / 80.0) * current_memory_gb);

    RAISE NOTICE 'å½“å‰çŠ¶æ€ - CPU: %% (%æ ¸) | å†…å­˜: %% (%GB)',
        current_cpu_usage, current_cpu_cores,
        current_memory_usage, current_memory_gb;
    RAISE NOTICE '%ä¸ªæœˆåé¢„æµ‹ - CPU: %% | å†…å­˜: %%',
        months,
        ROUND(future_cpu_usage, 2),
        ROUND(future_memory_usage, 2);
    RAISE NOTICE 'å»ºè®®é…ç½® - CPU: %æ ¸ | å†…å­˜: %GB',
        cpu_cores_needed,
        memory_gb_needed;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®¡ç®—è®¡ç®—éœ€æ±‚å¤±è´¥: %', SQLERRM;
END $$;
```

**è®¡ç®—è§„åˆ’å»ºè®®**ï¼š

```text
CPUè§„åˆ’åŸåˆ™ï¼š
1. é¢„ç•™20-30%çš„CPUä½™é‡ï¼ˆç”¨äºå³°å€¼è´Ÿè½½ï¼‰
2. è€ƒè™‘CPUå¯†é›†å‹æŸ¥è¯¢ï¼ˆå¦‚å¤æ‚åˆ†ææŸ¥è¯¢ï¼‰
3. è€ƒè™‘å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQLæ”¯æŒå¹¶è¡ŒæŸ¥è¯¢ï¼‰
4. è€ƒè™‘CPUäº²å’Œæ€§ï¼ˆç»‘å®šCPUæ ¸å¿ƒï¼‰

å†…å­˜è§„åˆ’åŸåˆ™ï¼š
1. shared_buffersï¼šå»ºè®®è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„25%
2. effective_cache_sizeï¼šå»ºè®®è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%
3. work_memï¼šæ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´
4. é¢„ç•™20-30%çš„å†…å­˜ä½™é‡ï¼ˆç”¨äºæ“ä½œç³»ç»Ÿå’Œå…¶ä»–åº”ç”¨ï¼‰

PostgreSQL 18ä¼˜åŒ–ï¼š
- å¼‚æ­¥I/Oï¼šå‡å°‘CPUç­‰å¾…æ—¶é—´ï¼Œæå‡I/Oæ€§èƒ½
- è·³è¿‡æ‰«æï¼šå‡å°‘CPUè®¡ç®—é‡ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
```

---

## 6. å®æˆ˜æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿå®¹é‡è§„åˆ’

**åœºæ™¯æè¿°**ï¼š

- ä¸šåŠ¡ç±»å‹ï¼šç”µå•†è®¢å•ç³»ç»Ÿ
- å½“å‰æ•°æ®é‡ï¼š500GB
- æœˆå¢é•¿ç‡ï¼š15%
- é¢„æµ‹å‘¨æœŸï¼š12ä¸ªæœˆ

**å®¹é‡è§„åˆ’**ï¼š

```sql
-- ç”µå•†ç³»ç»Ÿå®¹é‡è§„åˆ’è®¡ç®—
DO $$
DECLARE
    current_size_gb numeric := 500;
    growth_rate numeric := 0.15;  -- æ¯æœˆå¢é•¿15%
    months int := 12;
    future_size_gb numeric;
    reserved_size_gb numeric;
    cpu_cores_needed int;
    memory_gb_needed int;
BEGIN
    -- è®¡ç®—æœªæ¥å­˜å‚¨éœ€æ±‚
    future_size_gb := current_size_gb * POWER(1 + growth_rate, months);
    reserved_size_gb := future_size_gb * 1.3;  -- é¢„ç•™30%

    -- è®¡ç®—è®¡ç®—èµ„æºéœ€æ±‚ï¼ˆå‡è®¾æ¯100GBéœ€è¦2æ ¸CPUå’Œ8GBå†…å­˜ï¼‰
    cpu_cores_needed := CEIL(future_size_gb / 100.0 * 2);
    memory_gb_needed := CEIL(future_size_gb / 100.0 * 8);

    RAISE NOTICE '=== ç”µå•†ç³»ç»Ÿå®¹é‡è§„åˆ’ ===';
    RAISE NOTICE 'å½“å‰æ•°æ®é‡: % GB', current_size_gb;
    RAISE NOTICE '%ä¸ªæœˆåé¢„æµ‹æ•°æ®é‡: % GB', months, ROUND(future_size_gb, 2);
    RAISE NOTICE 'å»ºè®®å­˜å‚¨å®¹é‡: % GB (é¢„ç•™30%%)', ROUND(reserved_size_gb, 2);
    RAISE NOTICE 'å»ºè®®CPUæ ¸å¿ƒæ•°: %æ ¸', cpu_cores_needed;
    RAISE NOTICE 'å»ºè®®å†…å­˜å®¹é‡: %GB', memory_gb_needed;
END $$;
```

**è§„åˆ’ç»“æœ**ï¼š

- 12ä¸ªæœˆåæ•°æ®é‡ï¼šçº¦2,700GB
- å»ºè®®å­˜å‚¨å®¹é‡ï¼šçº¦3,500GBï¼ˆé¢„ç•™30%ï¼‰
- å»ºè®®CPUæ ¸å¿ƒæ•°ï¼š54æ ¸
- å»ºè®®å†…å­˜å®¹é‡ï¼š216GB

### 6.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—ç³»ç»Ÿå®¹é‡è§„åˆ’

**åœºæ™¯æè¿°**ï¼š

- ä¸šåŠ¡ç±»å‹ï¼šåº”ç”¨æ—¥å¿—ç³»ç»Ÿ
- å½“å‰æ•°æ®é‡ï¼š2TB
- æ—¥å¢é•¿ç‡ï¼š1%
- é¢„æµ‹å‘¨æœŸï¼š6ä¸ªæœˆ

**å®¹é‡è§„åˆ’**ï¼š

```sql
-- æ—¥å¿—ç³»ç»Ÿå®¹é‡è§„åˆ’è®¡ç®—
DO $$
DECLARE
    current_size_gb numeric := 2048;  -- 2TB
    daily_growth_rate numeric := 0.01;  -- æ¯æ—¥å¢é•¿1%
    days int := 180;  -- 6ä¸ªæœˆ
    future_size_gb numeric;
    reserved_size_gb numeric;
    archive_size_gb numeric;
BEGIN
    -- è®¡ç®—æœªæ¥å­˜å‚¨éœ€æ±‚
    future_size_gb := current_size_gb * POWER(1 + daily_growth_rate, days);
    reserved_size_gb := future_size_gb * 1.2;  -- é¢„ç•™20%

    -- è€ƒè™‘æ•°æ®å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªæœˆï¼Œå½’æ¡£3ä¸ªæœˆå‰çš„æ•°æ®ï¼‰
    archive_size_gb := future_size_gb * 0.5;  -- 50%éœ€è¦å½’æ¡£

    RAISE NOTICE '=== æ—¥å¿—ç³»ç»Ÿå®¹é‡è§„åˆ’ ===';
    RAISE NOTICE 'å½“å‰æ•°æ®é‡: % GB (2TB)', current_size_gb;
    RAISE NOTICE '%å¤©åé¢„æµ‹æ•°æ®é‡: % GB', days, ROUND(future_size_gb, 2);
    RAISE NOTICE 'å»ºè®®å­˜å‚¨å®¹é‡: % GB (é¢„ç•™20%%)', ROUND(reserved_size_gb, 2);
    RAISE NOTICE 'å»ºè®®å½’æ¡£å®¹é‡: % GB (å½’æ¡£50%%)', ROUND(archive_size_gb, 2);
    RAISE NOTICE 'å»ºè®®æ€»å®¹é‡: % GB', ROUND(reserved_size_gb + archive_size_gb, 2);
END $$;
```

**è§„åˆ’ç»“æœ**ï¼š

- 6ä¸ªæœˆåæ•°æ®é‡ï¼šçº¦12,000GB
- å»ºè®®å­˜å‚¨å®¹é‡ï¼šçº¦14,400GBï¼ˆé¢„ç•™20%ï¼‰
- å»ºè®®å½’æ¡£å®¹é‡ï¼šçº¦6,000GB
- å»ºè®®æ€»å®¹é‡ï¼šçº¦20,400GB

### 6.3 æ¡ˆä¾‹3ï¼šåˆ†æç³»ç»Ÿå®¹é‡è§„åˆ’

**åœºæ™¯æè¿°**ï¼š

- ä¸šåŠ¡ç±»å‹ï¼šæ•°æ®åˆ†æç³»ç»Ÿ
- å½“å‰æ•°æ®é‡ï¼š10TB
- æœˆå¢é•¿ç‡ï¼š5%
- é¢„æµ‹å‘¨æœŸï¼š24ä¸ªæœˆ

**å®¹é‡è§„åˆ’**ï¼š

```sql
-- åˆ†æç³»ç»Ÿå®¹é‡è§„åˆ’è®¡ç®—
DO $$
DECLARE
    current_size_gb numeric := 10240;  -- 10TB
    growth_rate numeric := 0.05;  -- æ¯æœˆå¢é•¿5%
    months int := 24;
    future_size_gb numeric;
    reserved_size_gb numeric;
    cpu_cores_needed int;
    memory_gb_needed int;
BEGIN
    -- è®¡ç®—æœªæ¥å­˜å‚¨éœ€æ±‚
    future_size_gb := current_size_gb * POWER(1 + growth_rate, months);
    reserved_size_gb := future_size_gb * 1.25;  -- é¢„ç•™25%

    -- åˆ†æç³»ç»Ÿéœ€è¦æ›´å¤šè®¡ç®—èµ„æºï¼ˆæ¯50GBéœ€è¦1æ ¸CPUå’Œ4GBå†…å­˜ï¼‰
    cpu_cores_needed := CEIL(future_size_gb / 50.0);
    memory_gb_needed := CEIL(future_size_gb / 50.0 * 4);

    RAISE NOTICE '=== åˆ†æç³»ç»Ÿå®¹é‡è§„åˆ’ ===';
    RAISE NOTICE 'å½“å‰æ•°æ®é‡: % GB (10TB)', current_size_gb;
    RAISE NOTICE '%ä¸ªæœˆåé¢„æµ‹æ•°æ®é‡: % GB', months, ROUND(future_size_gb, 2);
    RAISE NOTICE 'å»ºè®®å­˜å‚¨å®¹é‡: % GB (é¢„ç•™25%%)', ROUND(reserved_size_gb, 2);
    RAISE NOTICE 'å»ºè®®CPUæ ¸å¿ƒæ•°: %æ ¸', cpu_cores_needed;
    RAISE NOTICE 'å»ºè®®å†…å­˜å®¹é‡: %GB', memory_gb_needed;
END $$;
```

**è§„åˆ’ç»“æœ**ï¼š

- 24ä¸ªæœˆåæ•°æ®é‡ï¼šçº¦33,000GB
- å»ºè®®å­˜å‚¨å®¹é‡ï¼šçº¦41,250GBï¼ˆé¢„ç•™25%ï¼‰
- å»ºè®®CPUæ ¸å¿ƒæ•°ï¼š660æ ¸
- å»ºè®®å†…å­˜å®¹é‡ï¼š2,640GB

## 7. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å®šæœŸå®¹é‡è¯„ä¼°** - å»ºè®®æ¯æœˆè¿›è¡Œä¸€æ¬¡å®¹é‡è¯„ä¼°
2. **å»ºç«‹å®¹é‡åŸºçº¿** - è®°å½•å†å²å®¹é‡æ•°æ®ï¼Œå»ºç«‹å®¹é‡åŸºçº¿
3. **è®¾ç½®å‘Šè­¦é˜ˆå€¼** - è®¾ç½®å®¹é‡å‘Šè­¦é˜ˆå€¼ï¼ˆå»ºè®®80%ï¼‰
4. **åˆ¶å®šæ‰©å®¹è®¡åˆ’** - æå‰åˆ¶å®šæ‰©å®¹è®¡åˆ’ï¼Œé¿å…å®¹é‡ç“¶é¢ˆ
5. **è€ƒè™‘æˆæœ¬ä¼˜åŒ–** - åœ¨å®¹é‡è§„åˆ’ä¸­è€ƒè™‘æˆæœ¬ä¼˜åŒ–ï¼ˆFinOpsï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦è¿‡åº¦é¢„ç•™** - é¢„ç•™ç©ºé—´åº”è¯¥åˆç†ï¼Œé¿å…èµ„æºæµªè´¹
2. **è€ƒè™‘æ•°æ®å‹ç¼©** - ä½¿ç”¨æ•°æ®å‹ç¼©å¯ä»¥å‡å°‘å­˜å‚¨éœ€æ±‚
3. **è€ƒè™‘æ•°æ®å½’æ¡£** - å°†å†å²æ•°æ®å½’æ¡£åˆ°å†·å­˜å‚¨ï¼Œé™ä½æˆæœ¬
4. **ç›‘æ§å®é™…ä½¿ç”¨** - æŒç»­ç›‘æ§å®é™…ä½¿ç”¨æƒ…å†µï¼Œè°ƒæ•´è§„åˆ’

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®¹é‡è¯„ä¼°æ–¹æ³•.md](./å®¹é‡è¯„ä¼°æ–¹æ³•.md) - å®¹é‡è¯„ä¼°æ–¹æ³•è¯¦è§£
- [å¢é•¿é¢„æµ‹.md](./å¢é•¿é¢„æµ‹.md) - å¢é•¿é¢„æµ‹æŒ‡å—
- [èµ„æºè§„åˆ’.md](./èµ„æºè§„åˆ’.md) - èµ„æºè§„åˆ’æŒ‡å—
- [æ‰©å®¹ç­–ç•¥.md](./æ‰©å®¹ç­–ç•¥.md) - æ‰©å®¹ç­–ç•¥æŒ‡å—
- [å®¹é‡ç›‘æ§.md](./å®¹é‡ç›‘æ§.md) - å®¹é‡ç›‘æ§æŒ‡å—
- [PostgreSQLæˆæœ¬ä¼˜åŒ–ï¼ˆFinOpsï¼‰æŒ‡å—.md](./PostgreSQLæˆæœ¬ä¼˜åŒ–ï¼ˆFinOpsï¼‰æŒ‡å—.md) - æˆæœ¬ä¼˜åŒ–æŒ‡å—
- [31-å®¹é‡è§„åˆ’/README.md](./README.md) - å®¹é‡è§„åˆ’ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
