# PostgreSQLå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—](#postgresqlå®¹é‡è§„åˆ’å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å®¹é‡è§„åˆ’æµç¨‹](#2-å®¹é‡è§„åˆ’æµç¨‹)
    - [2.1 è§„åˆ’æ­¥éª¤](#21-è§„åˆ’æ­¥éª¤)
    - [2.2 è§„åˆ’å‘¨æœŸ](#22-è§„åˆ’å‘¨æœŸ)
  - [3. å®¹é‡è¯„ä¼°](#3-å®¹é‡è¯„ä¼°)
    - [3.1 å­˜å‚¨å®¹é‡](#31-å­˜å‚¨å®¹é‡)
    - [3.2 è®¡ç®—å®¹é‡](#32-è®¡ç®—å®¹é‡)
  - [4. å¢é•¿é¢„æµ‹](#4-å¢é•¿é¢„æµ‹)
    - [4.1 æ•°æ®å¢é•¿é¢„æµ‹](#41-æ•°æ®å¢é•¿é¢„æµ‹)
    - [4.2 å¢é•¿è¶‹åŠ¿åˆ†æ](#42-å¢é•¿è¶‹åŠ¿åˆ†æ)
  - [5. èµ„æºè§„åˆ’](#5-èµ„æºè§„åˆ’)
    - [5.1 å­˜å‚¨è§„åˆ’](#51-å­˜å‚¨è§„åˆ’)
    - [5.2 è®¡ç®—è§„åˆ’](#52-è®¡ç®—è§„åˆ’)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å®¹é‡è§„åˆ’æ˜¯ç¡®ä¿æ•°æ®åº“ç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³æœªæ¥éœ€æ±‚çš„å…³é”®æ´»åŠ¨ã€‚

**è§„åˆ’ç›®æ ‡**:

- é¢„æµ‹æœªæ¥å®¹é‡éœ€æ±‚
- è§„åˆ’èµ„æºå¢é•¿
- é¿å…å®¹é‡ç“¶é¢ˆ
- ä¼˜åŒ–èµ„æºä½¿ç”¨

---

## 2. å®¹é‡è§„åˆ’æµç¨‹

### 2.1 è§„åˆ’æ­¥éª¤

```text
1. å½“å‰å®¹é‡è¯„ä¼°
   â†“
2. å¢é•¿è¶‹åŠ¿åˆ†æ
   â†“
3. æœªæ¥éœ€æ±‚é¢„æµ‹
   â†“
4. èµ„æºè§„åˆ’åˆ¶å®š
   â†“
5. æ‰©å®¹ç­–ç•¥åˆ¶å®š
   â†“
6. å®¹é‡ç›‘æ§å»ºç«‹
```

### 2.2 è§„åˆ’å‘¨æœŸ

```text
- çŸ­æœŸè§„åˆ’ï¼š1-3ä¸ªæœˆ
- ä¸­æœŸè§„åˆ’ï¼š3-12ä¸ªæœˆ
- é•¿æœŸè§„åˆ’ï¼š1-3å¹´
```

---

## 3. å®¹é‡è¯„ä¼°

### 3.1 å­˜å‚¨å®¹é‡

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_record RECORD;
    total_size bigint := 0;
    db_count int := 0;
BEGIN
    RAISE NOTICE 'å¼€å§‹è¯„ä¼°æ•°æ®åº“å¤§å°...';

    FOR db_record IN
        SELECT datname
        FROM pg_database
        WHERE datistemplate = false
        ORDER BY pg_database_size(datname) DESC
    LOOP
        BEGIN
            db_count := db_count + 1;
            total_size := total_size + pg_database_size(db_record.datname);

            RAISE NOTICE 'æ•°æ®åº“ % å¤§å°: %',
                db_record.datname,
                pg_size_pretty(pg_database_size(db_record.datname));
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è¯„ä¼°æ•°æ®åº“ % å¤§å°å¤±è´¥: %', db_record.datname, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'è¯„ä¼°å®Œæˆ: % ä¸ªæ•°æ®åº“ï¼Œæ€»å¤§å°: %', db_count, pg_size_pretty(total_size);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ•°æ®åº“å¤§å°è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size,
    pg_database_size(datname) AS size_bytes
FROM pg_database
WHERE datistemplate = false
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    schema_name text := 'public';
    total_size bigint := 0;
    table_count int := 0;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹è¯„ä¼°Schema % ä¸­çš„è¡¨å¤§å°...', schema_name;

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
    LOOP
        BEGIN
            table_count := table_count + 1;
            total_size := total_size + pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);

            RAISE NOTICE 'è¡¨ %.% å¤§å°: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename));
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è¯„ä¼°è¡¨ %.% å¤§å°å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'è¯„ä¼°å®Œæˆ: % ä¸ªè¡¨ï¼Œæ€»å¤§å°: %', table_count, pg_size_pretty(total_size);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¡¨å¤§å°è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 è®¡ç®—å®¹é‡

```sql
-- æŸ¥çœ‹è¿æ¥æ•°ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_connections int;
    max_connections int;
    usage_percent numeric;
    warning_threshold numeric := 80.0;
    critical_threshold numeric := 90.0;
BEGIN
    -- è·å–å½“å‰è¿æ¥æ•°
    SELECT COUNT(*) INTO current_connections
    FROM pg_stat_activity;

    -- è·å–æœ€å¤§è¿æ¥æ•°
    SELECT setting::int INTO max_connections
    FROM pg_settings
    WHERE name = 'max_connections';

    IF max_connections IS NULL OR max_connections = 0 THEN
        RAISE EXCEPTION 'æ— æ³•è·å–æœ€å¤§è¿æ¥æ•°é…ç½®';
    END IF;

    -- è®¡ç®—ä½¿ç”¨ç‡
    usage_percent := ROUND(100.0 * current_connections / NULLIF(max_connections, 0), 2);

    RAISE NOTICE 'å½“å‰è¿æ¥æ•°: % / % (ä½¿ç”¨ç‡: %%)',
        current_connections, max_connections, usage_percent;

    -- æ£€æŸ¥é˜ˆå€¼
    IF usage_percent >= critical_threshold THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (ä¸¥é‡å‘Šè­¦ï¼Œè¶…è¿‡%%)',
            usage_percent, critical_threshold;
    ELSIF usage_percent >= warning_threshold THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (è­¦å‘Šï¼Œè¶…è¿‡%%)',
            usage_percent, warning_threshold;
    ELSE
        RAISE NOTICE 'è¿æ¥æ•°ä½¿ç”¨ç‡: %% (æ­£å¸¸)', usage_percent;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¿æ¥æ•°ä½¿ç”¨è¯„ä¼°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    COUNT(*) AS current_connections,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max_connections,
    ROUND(100.0 * COUNT(*) / NULLIF((SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 0), 2) AS usage_percent
FROM pg_stat_activity;
```

---

## 4. å¢é•¿é¢„æµ‹

### 4.1 æ•°æ®å¢é•¿é¢„æµ‹

```sql
-- è®¡ç®—è¡¨å¢é•¿ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    schema_name text := 'public';
    current_size bigint;
    next_month_size bigint;
    growth_rate numeric := 0.1;  -- æ¯æœˆå¢é•¿10%
    total_current_size bigint := 0;
    total_next_month_size bigint := 0;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹è®¡ç®—è¡¨å¢é•¿ç‡ï¼ˆå‡è®¾æ¯æœˆå¢é•¿10%%ï¼‰...';

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY tablename
    LOOP
        BEGIN
            current_size := pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);
            next_month_size := current_size * (1 + growth_rate);

            total_current_size := total_current_size + current_size;
            total_next_month_size := total_next_month_size + next_month_size;

            RAISE NOTICE 'è¡¨ %.% - å½“å‰å¤§å°: %, ä¸‹æœˆé¢„æµ‹: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(current_size),
                pg_size_pretty(next_month_size);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è®¡ç®—è¡¨ %.% å¢é•¿ç‡å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'æ±‡æ€» - å½“å‰æ€»å¤§å°: %, ä¸‹æœˆé¢„æµ‹æ€»å¤§å°: %',
        pg_size_pretty(total_current_size),
        pg_size_pretty(total_next_month_size);
    RAISE NOTICE 'é¢„æµ‹å¢é•¿ç‡: %%', ROUND((total_next_month_size::numeric / NULLIF(total_current_size, 0)::numeric - 1) * 100, 2);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è¡¨å¢é•¿ç‡è®¡ç®—å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_total_relation_size(schemaname||'.'||tablename) AS current_size_bytes,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS current_size,
    -- å‡è®¾æ¯æœˆå¢é•¿10%
    pg_total_relation_size(schemaname||'.'||tablename) * 1.1 AS next_month_size_bytes,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) * 1.1) AS next_month_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 4.2 å¢é•¿è¶‹åŠ¿åˆ†æ

```text
- çº¿æ€§å¢é•¿ï¼šç¨³å®šå¢é•¿
- æŒ‡æ•°å¢é•¿ï¼šå¿«é€Ÿå¢é•¿
- å‘¨æœŸæ€§å¢é•¿ï¼šå­£èŠ‚æ€§å˜åŒ–
```

---

## 5. èµ„æºè§„åˆ’

### 5.1 å­˜å‚¨è§„åˆ’

```text
å­˜å‚¨éœ€æ±‚ = å½“å‰å¤§å° Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
é¢„ç•™ç©ºé—´ = å­˜å‚¨éœ€æ±‚ Ã— 1.2ï¼ˆ20%é¢„ç•™ï¼‰
```

### 5.2 è®¡ç®—è§„åˆ’

```text
CPUéœ€æ±‚ = å½“å‰CPUä½¿ç”¨ç‡ Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
å†…å­˜éœ€æ±‚ = å½“å‰å†…å­˜ä½¿ç”¨ç‡ Ã— (1 + å¢é•¿ç‡) ^ æ—¶é—´å‘¨æœŸ
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®¹é‡è¯„ä¼°æ–¹æ³•.md](./å®¹é‡è¯„ä¼°æ–¹æ³•.md) - å®¹é‡è¯„ä¼°æ–¹æ³•è¯¦è§£
- [å¢é•¿é¢„æµ‹.md](./å¢é•¿é¢„æµ‹.md) - å¢é•¿é¢„æµ‹æŒ‡å—
- [31-å®¹é‡è§„åˆ’/README.md](./README.md) - å®¹é‡è§„åˆ’ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
