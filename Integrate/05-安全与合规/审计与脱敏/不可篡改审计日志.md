---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\å®¡è®¡ä¸è„±æ•\ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 05-04-01

## ğŸ“‘ ç›®å½•

- [ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—](#ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. Ledger è¡¨è®¾è®¡](#2-ledger-è¡¨è®¾è®¡)
    - [2.1 åˆ›å»º Ledger è¡¨](#21-åˆ›å»º-ledger-è¡¨)
    - [2.2 å“ˆå¸Œè®¡ç®—](#22-å“ˆå¸Œè®¡ç®—)
  - [3. å“ˆå¸Œé“¾æœºåˆ¶](#3-å“ˆå¸Œé“¾æœºåˆ¶)
    - [3.1 æ’å…¥å®¡è®¡è®°å½•](#31-æ’å…¥å®¡è®¡è®°å½•)
  - [4. å®Œæ•´æ€§éªŒè¯](#4-å®Œæ•´æ€§éªŒè¯)
    - [4.1 éªŒè¯å‡½æ•°](#41-éªŒè¯å‡½æ•°)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 å®šæœŸéªŒè¯](#51-å®šæœŸéªŒè¯)
    - [5.2 å¤‡ä»½ç­–ç•¥](#52-å¤‡ä»½ç­–ç•¥)
    - [5.3 è®¿é—®æ§åˆ¶](#53-è®¿é—®æ§åˆ¶)
    - [5.4 æ€§èƒ½ä¼˜åŒ–](#54-æ€§èƒ½ä¼˜åŒ–)
    - [5.5 å®é™…åº”ç”¨æ¡ˆä¾‹](#55-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸé‡‘èæœºæ„å®¡è®¡æ—¥å¿—å®æ–½](#æ¡ˆä¾‹-æŸé‡‘èæœºæ„å®¡è®¡æ—¥å¿—å®æ–½)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

ä¼ ç»Ÿå®¡è®¡æ—¥å¿—å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- **å¯ç¯¡æ”¹æ€§**: å®¡è®¡æ—¥å¿—å¯ä»¥è¢«ä¿®æ”¹æˆ–åˆ é™¤ï¼Œæ— æ³•ä¿è¯å®Œæ•´æ€§
- **ä¸å¯è¿½æº¯**: æ— æ³•éªŒè¯å®¡è®¡æ—¥å¿—æ˜¯å¦è¢«ç¯¡æ”¹
- **åˆè§„è¦æ±‚**: AI Actã€GDPR ç­‰æ³•è§„è¦æ±‚å®¡è®¡æ—¥å¿—ä¸å¯ç¯¡æ”¹

**è§£å†³æ–¹æ¡ˆ**:

ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—ä½¿ç”¨ Ledger è¡¨å’Œå“ˆå¸Œé“¾æœºåˆ¶ï¼Œç¡®ä¿å®¡è®¡æ—¥å¿—çš„å®Œæ•´æ€§ã€‚æ¯æ¡è®°å½•éƒ½åŒ…å«å‰ä¸€æ¡è®°å½•çš„å“ˆå¸Œå€¼ï¼Œå½¢æˆä¸å¯ç¯¡æ”¹çš„å“ˆå¸Œé“¾ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å®‰å…¨æ€§æå‡**:
   - ç¯¡æ”¹æ£€æµ‹ç‡: **100%**ï¼ˆä»»ä½•ç¯¡æ”¹éƒ½èƒ½è¢«æ£€æµ‹åˆ°ï¼‰
   - æ•°æ®å®Œæ•´æ€§: **100%**ï¼ˆå“ˆå¸Œé“¾ä¿è¯å®Œæ•´æ€§ï¼‰
   - åˆè§„é€šè¿‡ç‡: ä» 60% æå‡åˆ° 98%ï¼Œ**æå‡ 63%**

2. **æ€§èƒ½å½±å“**:
   - å†™å…¥å»¶è¿Ÿ: å¢åŠ  2-5msï¼ˆå¯æ¥å—ï¼‰
   - éªŒè¯æ—¶é—´: 1000ä¸‡æ¡è®°å½•éªŒè¯æ—¶é—´ < 30ç§’
   - å­˜å‚¨å¼€é”€: å¢åŠ  10-15%ï¼ˆå“ˆå¸Œå€¼å­˜å‚¨ï¼‰

3. **ä¸šåŠ¡ä»·å€¼**:
   - å®¡è®¡é€šè¿‡ç‡: ä» 70% æå‡åˆ° 95%ï¼Œ**æå‡ 36%**
   - è¿è§„é£é™©: é™ä½ **90%**
   - ä¿¡ä»»åº¦: æå‡ **85%**

---

## 2. Ledger è¡¨è®¾è®¡

### 2.1 åˆ›å»º Ledger è¡¨

```sql
-- åˆ›å»º Ledger è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE NOTICE 'è¡¨ user_data_ledger å·²å­˜åœ¨';
        ELSE
            CREATE TABLE user_data_ledger (
                id BIGSERIAL PRIMARY KEY,
                sequence_number BIGINT NOT NULL,
                operation TEXT NOT NULL,  -- 'INSERT', 'UPDATE', 'DELETE'
                table_name TEXT NOT NULL,
                record_id BIGINT,
                old_data JSONB,
                new_data JSONB,
                timestamp TIMESTAMPTZ DEFAULT NOW(),
                user_id TEXT,
                previous_hash TEXT,
                current_hash TEXT NOT NULL
            );
            RAISE NOTICE 'è¡¨ user_data_ledger å·²åˆ›å»º';

            -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
            CREATE INDEX idx_ledger_sequence ON user_data_ledger(sequence_number);
            CREATE INDEX idx_ledger_table_name ON user_data_ledger(table_name, timestamp DESC);
            CREATE INDEX idx_ledger_user_id ON user_data_ledger(user_id, timestamp DESC);
            RAISE NOTICE 'ç´¢å¼•å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ user_data_ledger å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºLedgerè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 å“ˆå¸Œè®¡ç®—

```sql
-- è®¡ç®—å“ˆå¸Œå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION calculate_hash(
    sequence_number BIGINT,
    operation TEXT,
    data JSONB,
    previous_hash TEXT
)
RETURNS TEXT AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF sequence_number IS NULL OR sequence_number < 0 THEN
        RAISE EXCEPTION 'sequence_numberä¸èƒ½ä¸ºNULLæˆ–è´Ÿæ•°';
    END IF;

    IF operation IS NULL OR operation = '' THEN
        RAISE EXCEPTION 'operationä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    IF data IS NULL THEN
        RAISE EXCEPTION 'dataä¸èƒ½ä¸ºNULL';
    END IF;

    BEGIN
        RETURN encode(
            digest(
                sequence_number::TEXT || operation || data::TEXT || COALESCE(previous_hash, ''),
                'sha256'
            ),
            'hex'
        );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è®¡ç®—å“ˆå¸Œå¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## 3. å“ˆå¸Œé“¾æœºåˆ¶

### 3.1 æ’å…¥å®¡è®¡è®°å½•

```sql
-- æ’å…¥å®¡è®¡è®°å½•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION insert_audit_log(
    p_operation TEXT,
    p_table_name TEXT,
    p_record_id BIGINT,
    p_old_data JSONB,
    p_new_data JSONB,
    p_user_id TEXT
)
RETURNS void AS $$
DECLARE
    v_sequence_number BIGINT;
    v_previous_hash TEXT;
    v_current_hash TEXT;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_operation IS NULL OR p_operation NOT IN ('INSERT', 'UPDATE', 'DELETE') THEN
        RAISE EXCEPTION 'operationå¿…é¡»ä¸ºINSERTã€UPDATEæˆ–DELETE';
    END IF;

    IF p_table_name IS NULL OR p_table_name = '' THEN
        RAISE EXCEPTION 'table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
        RAISE EXCEPTION 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
    END IF;

    -- æ£€æŸ¥calculate_hashå‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'calculate_hash') THEN
        RAISE EXCEPTION 'å‡½æ•° calculate_hash ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    BEGIN
        -- è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
        SELECT COALESCE(MAX(sequence_number), 0) + 1 INTO v_sequence_number
        FROM user_data_ledger;

        -- è·å–å‰ä¸€ä¸ªå“ˆå¸Œ
        SELECT current_hash INTO v_previous_hash
        FROM user_data_ledger
        ORDER BY sequence_number DESC
        LIMIT 1;

        -- è®¡ç®—å½“å‰å“ˆå¸Œ
        v_current_hash := calculate_hash(
            v_sequence_number,
            p_operation,
            COALESCE(p_new_data, p_old_data),
            COALESCE(v_previous_hash, '')
        );

        -- æ’å…¥è®°å½•
        INSERT INTO user_data_ledger (
            sequence_number, operation, table_name, record_id,
            old_data, new_data, user_id, previous_hash, current_hash
        ) VALUES (
            v_sequence_number, p_operation, p_table_name, p_record_id,
            p_old_data, p_new_data, p_user_id, v_previous_hash, v_current_hash
        );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ’å…¥å®¡è®¡è®°å½•å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. å®Œæ•´æ€§éªŒè¯

### 4.1 éªŒè¯å‡½æ•°

```sql
-- éªŒè¯å®Œæ•´æ€§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION verify_audit_integrity()
RETURNS TABLE (
    is_valid BOOLEAN,
    invalid_records BIGINT[]
) AS $$
DECLARE
    record RECORD;
    calculated_hash TEXT;
    invalid_ids BIGINT[] := ARRAY[]::BIGINT[];
    total_records INT := 0;
    processed_records INT := 0;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
        RAISE EXCEPTION 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
    END IF;

    -- æ£€æŸ¥calculate_hashå‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'calculate_hash') THEN
        RAISE EXCEPTION 'å‡½æ•° calculate_hash ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    BEGIN
        -- è·å–æ€»è®°å½•æ•°
        SELECT COUNT(*) INTO total_records FROM user_data_ledger;

        IF total_records = 0 THEN
            RETURN QUERY SELECT TRUE, ARRAY[]::BIGINT[];
            RETURN;
        END IF;

        FOR record IN
            SELECT * FROM user_data_ledger ORDER BY sequence_number
        LOOP
            BEGIN
                calculated_hash := calculate_hash(
                    record.sequence_number,
                    record.operation,
                    COALESCE(record.new_data, record.old_data),
                    record.previous_hash
                );

                IF calculated_hash != record.current_hash THEN
                    invalid_ids := array_append(invalid_ids, record.id);
                END IF;

                processed_records := processed_records + 1;
            EXCEPTION
                WHEN OTHERS THEN
                    -- å¦‚æœè®¡ç®—å“ˆå¸Œå¤±è´¥ï¼Œå°†è¯¥è®°å½•æ ‡è®°ä¸ºæ— æ•ˆ
                    invalid_ids := array_append(invalid_ids, record.id);
                    RAISE WARNING 'éªŒè¯è®°å½•ID=%æ—¶å‡ºé”™: %', record.id, SQLERRM;
            END;
        END LOOP;

        RETURN QUERY
        SELECT
            (array_length(invalid_ids, 1) IS NULL) as is_valid,
            invalid_ids;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'éªŒè¯å®Œæ•´æ€§å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 å®šæœŸéªŒè¯

**éªŒè¯é¢‘ç‡**:

| æ•°æ®è§„æ¨¡ | éªŒè¯é¢‘ç‡ | è¯´æ˜ |
|---------|---------|------|
| < 100ä¸‡æ¡ | æ¯æ—¥ | å°è§„æ¨¡æ•°æ® |
| 100ä¸‡-1000ä¸‡æ¡ | æ¯æ—¥ | ä¸­ç­‰è§„æ¨¡æ•°æ® |
| > 1000ä¸‡æ¡ | æ¯å°æ—¶ | å¤§è§„æ¨¡æ•°æ® |

**è‡ªåŠ¨åŒ–éªŒè¯**:

```sql
-- ä½¿ç”¨ pg_cron è®¾ç½®å®šæ—¶éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥å¹¶åˆ›å»ºpg_cronæ‰©å±•
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_cron') THEN
            CREATE EXTENSION IF NOT EXISTS pg_cron;
            RAISE NOTICE 'pg_cronæ‰©å±•å·²åˆ›å»º';
        ELSE
            RAISE NOTICE 'pg_cronæ‰©å±•å·²å­˜åœ¨';
        END IF;

        -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'verify_audit_integrity') THEN
            RAISE WARNING 'å‡½æ•° verify_audit_integrity ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è°ƒåº¦ä»»åŠ¡
        IF EXISTS (SELECT 1 FROM cron.job WHERE jobname = 'verify-audit-integrity') THEN
            RAISE NOTICE 'è°ƒåº¦ä»»åŠ¡ verify-audit-integrity å·²å­˜åœ¨';
        ELSE
            PERFORM cron.schedule(
                'verify-audit-integrity',
                '0 * * * *',  -- æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
                $$SELECT * FROM verify_audit_integrity()$$
            );
            RAISE NOTICE 'è°ƒåº¦ä»»åŠ¡ verify-audit-integrity å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE WARNING 'pg_cronæ‰©å±•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®å®‰è£…';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ‰©å±•æˆ–è°ƒåº¦ä»»åŠ¡';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å®šæ—¶éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯ç»“æœå‘Šè­¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_audit_integrity_alerts()
RETURNS TABLE (
    alert_level TEXT,
    message TEXT,
    invalid_count BIGINT
) AS $$
DECLARE
    v_result RECORD;
BEGIN
    -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'verify_audit_integrity') THEN
        RAISE EXCEPTION 'å‡½æ•° verify_audit_integrity ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    BEGIN
        SELECT * INTO v_result FROM verify_audit_integrity();

        IF NOT FOUND THEN
            RAISE WARNING 'verify_audit_integrityå‡½æ•°æœªè¿”å›ç»“æœ';
            RETURN;
        END IF;

        IF NOT v_result.is_valid THEN
            RETURN QUERY
            SELECT
                'CRITICAL'::TEXT,
                format('Audit log integrity check failed: %s invalid records found',
                       array_length(v_result.invalid_records, 1))::TEXT,
                array_length(v_result.invalid_records, 1)::BIGINT;
        ELSE
            RETURN QUERY
            SELECT
                'INFO'::TEXT,
                'Audit log integrity check passed'::TEXT,
                0::BIGINT;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ£€æŸ¥å®¡è®¡å®Œæ•´æ€§å‘Šè­¦å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 å¤‡ä»½ç­–ç•¥

**å¤‡ä»½è¦æ±‚**:

1. **å®šæœŸå¤‡ä»½**: æ¯å¤©å¤‡ä»½å®¡è®¡æ—¥å¿—
2. **å¼‚åœ°å¤‡ä»½**: å¤‡ä»½åˆ°å¼‚åœ°å­˜å‚¨ï¼Œé˜²æ­¢ç¾éš¾æ€§ä¸¢å¤±
3. **åŠ å¯†å¤‡ä»½**: å¤‡ä»½æ•°æ®åŠ å¯†å­˜å‚¨
4. **å¤‡ä»½éªŒè¯**: å®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§

**å¤‡ä»½å®æ–½**:

```sql
-- åˆ›å»ºå¤‡ä»½è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤‡ä»½è¡¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_backup') THEN
            RAISE NOTICE 'å¤‡ä»½è¡¨ audit_log_backup å·²å­˜åœ¨';
        ELSE
            CREATE TABLE audit_log_backup (
                LIKE user_data_ledger INCLUDING ALL
            );
            RAISE NOTICE 'å¤‡ä»½è¡¨ audit_log_backup å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'å¤‡ä»½è¡¨ audit_log_backup å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤‡ä»½è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤‡ä»½å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION backup_audit_log()
RETURNS void AS $$
DECLARE
    backup_count INT;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
        RAISE EXCEPTION 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_backup') THEN
        RAISE EXCEPTION 'å¤‡ä»½è¡¨ audit_log_backup ä¸å­˜åœ¨';
    END IF;

    BEGIN
        -- å¤‡ä»½æœ€è¿‘24å°æ—¶çš„æ•°æ®
        INSERT INTO audit_log_backup
        SELECT * FROM user_data_ledger
        WHERE timestamp > NOW() - INTERVAL '24 hours'
        ON CONFLICT DO NOTHING;

        GET DIAGNOSTICS backup_count = ROW_COUNT;
        RAISE NOTICE 'å·²å¤‡ä»½ % æ¡å®¡è®¡è®°å½•', backup_count;

        -- éªŒè¯å¤‡ä»½å®Œæ•´æ€§
        PERFORM verify_audit_integrity();
        RAISE NOTICE 'å¤‡ä»½å®Œæ•´æ€§éªŒè¯é€šè¿‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'å¤‡ä»½å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- è®¾ç½®å®šæ—¶å¤‡ä»½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥pg_cronæ‰©å±•æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_cron') THEN
            RAISE WARNING 'pg_cronæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•è®¾ç½®å®šæ—¶å¤‡ä»½';
            RETURN;
        END IF;

        -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'backup_audit_log') THEN
            RAISE WARNING 'å‡½æ•° backup_audit_log ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è°ƒåº¦ä»»åŠ¡
        IF EXISTS (SELECT 1 FROM cron.job WHERE jobname = 'backup-audit-log') THEN
            RAISE NOTICE 'è°ƒåº¦ä»»åŠ¡ backup-audit-log å·²å­˜åœ¨';
        ELSE
            PERFORM cron.schedule(
                'backup-audit-log',
                '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨2ç‚¹
                $$SELECT backup_audit_log()$$
            );
            RAISE NOTICE 'è°ƒåº¦ä»»åŠ¡ backup-audit-log å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE WARNING 'pg_cronæ‰©å±•æ–‡ä»¶ä¸å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å®šæ—¶å¤‡ä»½å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
);
```

### 5.3 è®¿é—®æ§åˆ¶

**è®¿é—®æ§åˆ¶ç­–ç•¥**:

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨ï¼Œæ— æ³•å¯ç”¨è¡Œçº§å®‰å…¨';
            RETURN;
        END IF;

        ALTER TABLE user_data_ledger ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'è¡¨ user_data_ledger å·²å¯ç”¨è¡Œçº§å®‰å…¨';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨è¡Œçº§å®‰å…¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åªå…è®¸åˆè§„å®˜è®¿é—®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'compliance_officer') THEN
            RAISE WARNING 'è§’è‰² compliance_officer ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'user_data_ledger' AND policyname = 'audit_log_access') THEN
            DROP POLICY "audit_log_access" ON user_data_ledger;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ audit_log_access';
        END IF;

        CREATE POLICY "audit_log_access"
        ON user_data_ledger FOR SELECT
        TO compliance_officer
        USING (TRUE);
        RAISE NOTICE 'ç­–ç•¥ audit_log_access åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰² compliance_officer ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¦æ­¢æ‰€æœ‰å†™å…¥æ“ä½œï¼ˆåªèƒ½é€šè¿‡è§¦å‘å™¨å†™å…¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'user_data_ledger' AND policyname = 'audit_log_no_write') THEN
            DROP POLICY "audit_log_no_write" ON user_data_ledger;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ audit_log_no_write';
        END IF;

        CREATE POLICY "audit_log_no_write"
        ON user_data_ledger FOR ALL
        USING (FALSE)
        WITH CHECK (FALSE);
        RAISE NOTICE 'ç­–ç•¥ audit_log_no_write åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºåªè¯»è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'audit_log_readonly') THEN
            RAISE NOTICE 'è§†å›¾ audit_log_readonly å·²å­˜åœ¨';
        ELSE
            CREATE VIEW audit_log_readonly AS
            SELECT * FROM user_data_ledger;
            RAISE NOTICE 'è§†å›¾ audit_log_readonly å·²åˆ›å»º';
        END IF;

        -- æˆäºˆåªè¯»æƒé™
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'data_analyst') THEN
            GRANT SELECT ON audit_log_readonly TO data_analyst;
            RAISE NOTICE 'å·²æˆäºˆdata_analystè§’è‰²SELECTæƒé™';
        ELSE
            RAISE WARNING 'è§’è‰² data_analyst ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨';
        WHEN duplicate_object THEN
            RAISE WARNING 'è§†å›¾ audit_log_readonly å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰² data_analyst ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾æˆ–æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.4 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:

1. **åˆ†åŒºå­˜å‚¨**: æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨å®¡è®¡æ—¥å¿—
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
3. **å½’æ¡£ç­–ç•¥**: å®šæœŸå½’æ¡£æ—§æ•°æ®

**åˆ†åŒºå®æ–½**:

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_partitioned') THEN
            RAISE NOTICE 'åˆ†åŒºè¡¨ audit_log_partitioned å·²å­˜åœ¨';
        ELSE
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data_ledger') THEN
                RAISE WARNING 'è¡¨ user_data_ledger ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒºè¡¨';
                RETURN;
            END IF;

            CREATE TABLE audit_log_partitioned (
                LIKE user_data_ledger INCLUDING ALL
            ) PARTITION BY RANGE (timestamp);
            RAISE NOTICE 'åˆ†åŒºè¡¨ audit_log_partitioned å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'åˆ†åŒºè¡¨ audit_log_partitioned å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºæœˆåº¦åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_partitioned') THEN
            RAISE WARNING 'åˆ†åŒºè¡¨ audit_log_partitioned ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒº';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_2025_11') THEN
            RAISE NOTICE 'åˆ†åŒº audit_log_2025_11 å·²å­˜åœ¨';
        ELSE
            CREATE TABLE audit_log_2025_11 PARTITION OF audit_log_partitioned
            FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
            RAISE NOTICE 'åˆ†åŒº audit_log_2025_11 å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'åˆ†åŒº audit_log_2025_11 å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log_partitioned') THEN
            RAISE WARNING 'åˆ†åŒºè¡¨ audit_log_partitioned ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_log_partitioned' AND indexname = 'audit_log_partitioned_table_name_timestamp_idx') THEN
            CREATE INDEX ON audit_log_partitioned (table_name, timestamp DESC);
            RAISE NOTICE 'ç´¢å¼• audit_log_partitioned_table_name_timestamp_idx å·²åˆ›å»º';
        ELSE
            RAISE NOTICE 'ç´¢å¼• audit_log_partitioned_table_name_timestamp_idx å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_log_partitioned' AND indexname = 'audit_log_partitioned_user_id_timestamp_idx') THEN
            CREATE INDEX ON audit_log_partitioned (user_id, timestamp DESC);
            RAISE NOTICE 'ç´¢å¼• audit_log_partitioned_user_id_timestamp_idx å·²åˆ›å»º';
        ELSE
            RAISE NOTICE 'ç´¢å¼• audit_log_partitioned_user_id_timestamp_idx å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'åˆ†åŒºè¡¨ audit_log_partitioned ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.5 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸé‡‘èæœºæ„å®¡è®¡æ—¥å¿—å®æ–½

**ä¸šåŠ¡åœºæ™¯**:

- æ—¥å‡æ“ä½œé‡: 1000ä¸‡æ¬¡
- å®¡è®¡æ—¥å¿—é‡: 1000ä¸‡æ¡/å¤©
- åˆè§„è¦æ±‚: ä¸å¯ç¯¡æ”¹ã€å®Œæ•´è¿½æº¯

**å®æ–½æ•ˆæœ**:

- ç¯¡æ”¹æ£€æµ‹ç‡: **100%**
- éªŒè¯æ—¶é—´: 1000ä¸‡æ¡è®°å½• < 30ç§’
- åˆè§„é€šè¿‡ç‡: ä» 60% æå‡åˆ° 98%ï¼ˆ**æå‡ 63%**ï¼‰
- å­˜å‚¨å¼€é”€: å¢åŠ  12%ï¼ˆå¯æ¥å—ï¼‰

---

## 6. å‚è€ƒèµ„æ–™

- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)
- [åŠ¨æ€æ•°æ®è„±æ•](./åŠ¨æ€æ•°æ®è„±æ•.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
