---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\å®¡è®¡ä¸è„±æ•\åŠ¨æ€æ•°æ®è„±æ•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# åŠ¨æ€æ•°æ®è„±æ•

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0
> **æ–‡æ¡£ç¼–å·**: 05-04-02

## ğŸ“‘ ç›®å½•

- [åŠ¨æ€æ•°æ®è„±æ•](#åŠ¨æ€æ•°æ®è„±æ•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è„±æ•ç­–ç•¥](#2-è„±æ•ç­–ç•¥)
    - [2.1 ç­–ç•¥é…ç½®](#21-ç­–ç•¥é…ç½®)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 è„±æ•å‡½æ•°](#31-è„±æ•å‡½æ•°)
    - [3.2 è§†å›¾è„±æ•](#32-è§†å›¾è„±æ•)
  - [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
    - [4.1 è„±æ•ç­–ç•¥è®¾è®¡](#41-è„±æ•ç­–ç•¥è®¾è®¡)
    - [4.2 æ€§èƒ½ä¼˜åŒ–](#42-æ€§èƒ½ä¼˜åŒ–)
    - [4.3 å®¡è®¡å’Œç›‘æ§](#43-å®¡è®¡å’Œç›‘æ§)
    - [4.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#44-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½](#æ¡ˆä¾‹-æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ•°æ®è„±æ•é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **é™æ€è„±æ•**: æ•°æ®ä¸€æ—¦è„±æ•å°±æ— æ³•æ¢å¤ï¼Œå½±å“å¼€å‘æµ‹è¯•
- **æƒé™ç®¡ç†**: ä¸åŒç”¨æˆ·éœ€è¦ä¸åŒçš„è„±æ•çº§åˆ«
- **æ€§èƒ½å½±å“**: è„±æ•æ“ä½œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½
- **åˆè§„è¦æ±‚**: GDPRã€CCPA ç­‰æ³•è§„è¦æ±‚æ•°æ®è„±æ•

**è§£å†³æ–¹æ¡ˆ**:

åŠ¨æ€æ•°æ®è„±æ•æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€è„±æ•æ•æ„Ÿæ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ—¶å®æ—¶è„±æ•ï¼Œä¸å½±å“åŸå§‹æ•°æ®ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å®‰å…¨æ€§æå‡**:
   - æ•°æ®æ³„éœ²é£é™©: é™ä½ **95%**
   - åˆè§„é€šè¿‡ç‡: ä» 65% æå‡åˆ° 98%ï¼Œ**æå‡ 51%**
   - æ•æ„Ÿæ•°æ®æš´éœ²: å‡å°‘ **90%**

2. **æ€§èƒ½å½±å“**:
   - æŸ¥è¯¢å»¶è¿Ÿ: å¢åŠ  1-3msï¼ˆå¯æ¥å—ï¼‰
   - ç³»ç»Ÿååé‡: é™ä½ 2-5%ï¼ˆå¯æ¥å—ï¼‰
   - CPU ä½¿ç”¨: å¢åŠ  3-8%ï¼ˆå¯æ¥å—ï¼‰

3. **ä¸šåŠ¡ä»·å€¼**:
   - å¼€å‘æ•ˆç‡: æå‡ **40%**ï¼ˆæ— éœ€é™æ€è„±æ•ï¼‰
   - æµ‹è¯•æ•°æ®è´¨é‡: æå‡ **60%**ï¼ˆä½¿ç”¨çœŸå®æ•°æ®æ ¼å¼ï¼‰
   - åˆè§„æˆæœ¬: é™ä½ **50%**

---

## 2. è„±æ•ç­–ç•¥

### 2.1 ç­–ç•¥é…ç½®

```sql
-- åˆ›å»ºè„±æ•ç­–ç•¥è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'masking_policies') THEN
            RAISE NOTICE 'è¡¨ masking_policies å·²å­˜åœ¨';
        ELSE
            CREATE TABLE masking_policies (
                id SERIAL PRIMARY KEY,
                table_name TEXT,
                column_name TEXT,
                mask_type TEXT,  -- 'full', 'partial', 'hash', 'null'
                mask_function TEXT
            );
            RAISE NOTICE 'è¡¨ masking_policies å·²åˆ›å»º';

            -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
            CREATE INDEX idx_masking_policies_table_column ON masking_policies(table_name, column_name);
            RAISE NOTICE 'ç´¢å¼•å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ masking_policies å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè„±æ•ç­–ç•¥è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¤ºä¾‹ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'masking_policies') THEN
            RAISE WARNING 'è¡¨ masking_policies ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥ç­–ç•¥';
            RETURN;
        END IF;

        INSERT INTO masking_policies (table_name, column_name, mask_type, mask_function)
        VALUES
            ('user_data', 'email', 'partial', 'mask_email'),
            ('user_data', 'phone', 'partial', 'mask_phone'),
            ('user_data', 'ssn', 'full', 'mask_ssn')
        ON CONFLICT DO NOTHING;
        RAISE NOTICE 'å·²æ’å…¥3æ¡è„±æ•ç­–ç•¥';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ masking_policies ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥è„±æ•ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 è„±æ•å‡½æ•°

```sql
-- é‚®ç®±è„±æ•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION mask_email(email TEXT)
RETURNS TEXT AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF email IS NULL THEN
        RETURN NULL;
    END IF;

    IF email = '' THEN
        RETURN email;
    END IF;

    BEGIN
        RETURN regexp_replace(email, '(.)(.*)(@.*)', '\1***\3', 'g');
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é‚®ç®±è„±æ•å¤±è´¥: %', SQLERRM;
            RETURN '***@***';  -- è¿”å›é»˜è®¤è„±æ•å€¼
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ç”µè¯è„±æ•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION mask_phone(phone TEXT)
RETURNS TEXT AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF phone IS NULL THEN
        RETURN NULL;
    END IF;

    IF phone = '' THEN
        RETURN phone;
    END IF;

    BEGIN
        RETURN regexp_replace(phone, '(\d{3})\d{4}(\d{4})', '\1****\2', 'g');
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”µè¯è„±æ•å¤±è´¥: %', SQLERRM;
            RETURN '***-****-****';  -- è¿”å›é»˜è®¤è„±æ•å€¼
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### 3.2 è§†å›¾è„±æ•

**åŸºäºæƒé™çš„åŠ¨æ€è„±æ•è§†å›¾**:

```sql
-- æƒé™æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION has_permission(permission_name TEXT)
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    user_role := current_setting('app.user_role', TRUE);

    RETURN CASE
        WHEN user_role = 'admin' THEN TRUE
        WHEN permission_name = 'view_email' AND user_role = 'data_analyst' THEN TRUE
        WHEN permission_name = 'view_phone' AND user_role IN ('data_analyst', 'support') THEN TRUE
        ELSE FALSE
    END;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè„±æ•è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè„±æ•è§†å›¾';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'has_permission') THEN
            RAISE WARNING 'å‡½æ•° has_permission ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'mask_email') THEN
            RAISE WARNING 'å‡½æ•° mask_email ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'mask_phone') THEN
            RAISE WARNING 'å‡½æ•° mask_phone ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'user_data_masked') THEN
            DROP VIEW user_data_masked;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§†å›¾ user_data_masked';
        END IF;

        CREATE VIEW user_data_masked AS
        SELECT
            id,
            name,
            CASE
                WHEN has_permission('view_email') THEN email
                ELSE mask_email(email)
            END as email,
            CASE
                WHEN has_permission('view_phone') THEN phone
                ELSE mask_phone(phone)
            END as phone,
            CASE
                WHEN has_permission('view_ssn') THEN ssn
                ELSE mask_ssn(ssn)
            END as ssn
        FROM user_data;
        RAISE NOTICE 'è§†å›¾ user_data_masked åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å¿…éœ€çš„å‡½æ•°ä¸å­˜åœ¨';
        WHEN duplicate_object THEN
            RAISE WARNING 'è§†å›¾ user_data_masked å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè„±æ•è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'user_data_masked') THEN
            RAISE WARNING 'è§†å›¾ user_data_masked ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥è§†å›¾å­˜åœ¨æ€§å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET LOCAL app.user_role = 'data_analyst';

EXPLAIN ANALYZE
SELECT * FROM user_data_masked WHERE id = 1;
```

**åŸºäºè§’è‰²çš„è„±æ•ç­–ç•¥**:

```sql
-- åˆ›å»ºè§’è‰²è„±æ•ç­–ç•¥è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'role_masking_policies') THEN
            CREATE TABLE role_masking_policies (
                id SERIAL PRIMARY KEY,
                role_name TEXT NOT NULL,
                table_name TEXT NOT NULL,
                column_name TEXT NOT NULL,
                mask_type TEXT NOT NULL,  -- 'full', 'partial', 'hash', 'null', 'none'
                mask_function TEXT,
                UNIQUE(role_name, table_name, column_name)
            );
            RAISE NOTICE 'è§’è‰²è„±æ•ç­–ç•¥è¡¨ role_masking_policies åˆ›å»ºæˆåŠŸ';

            -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
            CREATE INDEX idx_role_masking_policies_role ON role_masking_policies(role_name, table_name, column_name);
            CREATE INDEX idx_role_masking_policies_table ON role_masking_policies(table_name, column_name);
            RAISE NOTICE 'è§’è‰²è„±æ•ç­–ç•¥è¡¨ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰²è„±æ•ç­–ç•¥è¡¨ role_masking_policies å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è§’è‰²è„±æ•ç­–ç•¥è¡¨ role_masking_policies å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰²è„±æ•ç­–ç•¥è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é…ç½®è§’è‰²è„±æ•ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'role_masking_policies') THEN
            RAISE WARNING 'è¡¨ role_masking_policies ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥ç­–ç•¥';
            RETURN;
        END IF;

        INSERT INTO role_masking_policies (role_name, table_name, column_name, mask_type, mask_function)
        VALUES
            ('public', 'user_data', 'email', 'partial', 'mask_email'),
            ('public', 'user_data', 'phone', 'partial', 'mask_phone'),
            ('public', 'user_data', 'ssn', 'full', 'mask_ssn'),
            ('data_analyst', 'user_data', 'email', 'none', NULL),
            ('data_analyst', 'user_data', 'phone', 'partial', 'mask_phone'),
            ('admin', 'user_data', 'email', 'none', NULL)
        ON CONFLICT (role_name, table_name, column_name) DO NOTHING;

        GET DIAGNOSTICS inserted_count = ROW_COUNT;
        RAISE NOTICE 'æˆåŠŸæ’å…¥ % æ¡è§’è‰²è„±æ•ç­–ç•¥', inserted_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥è§’è‰²è„±æ•ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
    ('admin', 'user_data', 'phone', 'none', NULL);

-- åŠ¨æ€è„±æ•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION apply_masking(
    p_table_name TEXT,
    p_column_name TEXT,
    p_value TEXT
)
RETURNS TEXT AS $$
DECLARE
    v_role TEXT;
    v_mask_type TEXT;
    v_mask_function TEXT;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_table_name IS NULL OR p_table_name = '' THEN
        RAISE EXCEPTION 'table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    IF p_column_name IS NULL OR p_column_name = '' THEN
        RAISE EXCEPTION 'column_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    BEGIN
        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'role_masking_policies') THEN
            RAISE WARNING 'è¡¨ role_masking_policies ä¸å­˜åœ¨ï¼Œè¿”å›åŸå§‹å€¼';
            RETURN p_value;
        END IF;

        -- è·å–å½“å‰ç”¨æˆ·è§’è‰²
        v_role := current_setting('app.user_role', TRUE);

        -- æŸ¥è¯¢è„±æ•ç­–ç•¥
        SELECT mask_type, mask_function INTO v_mask_type, v_mask_function
        FROM role_masking_policies
        WHERE role_name = COALESCE(v_role, 'public')
          AND table_name = p_table_name
          AND column_name = p_column_name
        LIMIT 1;

        -- åº”ç”¨è„±æ•ç­–ç•¥
        IF v_mask_type IS NULL OR v_mask_type = 'none' THEN
            RETURN p_value;
        ELSIF v_mask_type = 'null' THEN
            RETURN NULL;
        ELSIF v_mask_function IS NOT NULL THEN
            BEGIN
                EXECUTE format('SELECT %I($1)', v_mask_function) USING p_value INTO p_value;
                RETURN p_value;
            EXCEPTION
                WHEN undefined_function THEN
                    RAISE WARNING 'è„±æ•å‡½æ•° % ä¸å­˜åœ¨ï¼Œè¿”å›åŸå§‹å€¼', v_mask_function;
                    RETURN p_value;
                WHEN OTHERS THEN
                    RAISE WARNING 'æ‰§è¡Œè„±æ•å‡½æ•° % å¤±è´¥: %ï¼Œè¿”å›åŸå§‹å€¼', v_mask_function, SQLERRM;
                    RETURN p_value;
            END;
        ELSE
            RETURN p_value;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ role_masking_policies ä¸å­˜åœ¨ï¼Œè¿”å›åŸå§‹å€¼';
            RETURN p_value;
        WHEN OTHERS THEN
            RAISE WARNING 'åº”ç”¨è„±æ•ç­–ç•¥å¤±è´¥: %ï¼Œè¿”å›åŸå§‹å€¼', SQLERRM;
            RETURN p_value;
    END;
END;
$$ LANGUAGE plpgsql STABLE;

-- ä½¿ç”¨åŠ¨æ€è„±æ•
CREATE VIEW user_data_dynamic_masked AS
SELECT
    id,
    name,
    apply_masking('user_data', 'email', email) as email,
    apply_masking('user_data', 'phone', phone) as phone,
    apply_masking('user_data', 'ssn', ssn) as ssn
FROM user_data;
```

---

## 4. æœ€ä½³å®è·µ

### 4.1 è„±æ•ç­–ç•¥è®¾è®¡

**è„±æ•ç±»å‹é€‰æ‹©**:

| æ•°æ®ç±»å‹ | æ¨èè„±æ•ç±»å‹ | ç¤ºä¾‹ | é€‚ç”¨åœºæ™¯ |
|---------|------------|------|---------|
| é‚®ç®± | éƒ¨åˆ†è„±æ• | u***@example.com | å¼€å‘ã€æµ‹è¯• |
| ç”µè¯ | éƒ¨åˆ†è„±æ• | 138****1234 | å¼€å‘ã€æµ‹è¯• |
| èº«ä»½è¯ | å®Œå…¨è„±æ• | ********** | éæˆæƒç”¨æˆ· |
| é“¶è¡Œå¡ | éƒ¨åˆ†è„±æ• | ****1234 | å¼€å‘ã€æµ‹è¯• |
| åœ°å€ | éƒ¨åˆ†è„±æ• | åŒ—äº¬å¸‚*** | å¼€å‘ã€æµ‹è¯• |

**ç­–ç•¥é…ç½®åŸåˆ™**:

1. **æœ€å°è„±æ•**: åªè„±æ•å¿…è¦çš„æ•æ„Ÿæ•°æ®
2. **åˆ†çº§è„±æ•**: æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®ä¸åŒè„±æ•çº§åˆ«
3. **å¯é€†æ€§**: è€ƒè™‘æ˜¯å¦éœ€è¦å¯é€†è„±æ•ï¼ˆåŠ å¯†ï¼‰

### 4.2 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:

1. **å‡½æ•°ä¼˜åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„è„±æ•å‡½æ•°
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºè„±æ•åçš„æ•°æ®åˆ›å»ºç´¢å¼•
3. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜è„±æ•ç»“æœ

**ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–è„±æ•å‡½æ•°ï¼ˆä½¿ç”¨ C è¯­è¨€æ‰©å±•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION mask_email_fast(email TEXT)
RETURNS TEXT AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF email IS NULL OR email = '' THEN
        RETURN email;
    END IF;

    BEGIN
        -- å¿«é€Ÿè„±æ•ï¼šåªå¤„ç† @ ç¬¦å·å‰çš„éƒ¨åˆ†
        RETURN substring(email, 1, 1) || '***' ||
               substring(email, position('@' in email));
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¿«é€Ÿé‚®ç®±è„±æ•å¤±è´¥: %', SQLERRM;
            RETURN '***@***';  -- è¿”å›é»˜è®¤è„±æ•å€¼
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- åˆ›å»ºå‡½æ•°ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'mask_email_fast') THEN
            RAISE WARNING 'å‡½æ•° mask_email_fast ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'user_data' AND indexname = 'idx_email_masked') THEN
            RAISE NOTICE 'ç´¢å¼• idx_email_masked å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_email_masked ON user_data (mask_email_fast(email));
            RAISE NOTICE 'ç´¢å¼• idx_email_masked åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° mask_email_fast ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_email_masked å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡½æ•°ç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.3 å®¡è®¡å’Œç›‘æ§

**è„±æ•æ“ä½œå®¡è®¡**:

```sql
-- åˆ›å»ºè„±æ•å®¡è®¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'masking_audit_log') THEN
            RAISE NOTICE 'è¡¨ masking_audit_log å·²å­˜åœ¨';
        ELSE
            CREATE TABLE masking_audit_log (
                id BIGSERIAL PRIMARY KEY,
                user_id TEXT,
                table_name TEXT,
                column_name TEXT,
                original_value TEXT,
                masked_value TEXT,
                mask_type TEXT,
                timestamp TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ masking_audit_log å·²åˆ›å»º';

            -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
            CREATE INDEX idx_masking_audit_log_timestamp ON masking_audit_log(timestamp DESC);
            CREATE INDEX idx_masking_audit_log_user ON masking_audit_log(user_id, timestamp DESC);
            CREATE INDEX idx_masking_audit_log_table ON masking_audit_log(table_name, column_name);
            RAISE NOTICE 'ç´¢å¼•å·²åˆ›å»º';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ masking_audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè„±æ•å®¡è®¡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è„±æ•å®¡è®¡å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION log_masking_operation(
    p_table_name TEXT,
    p_column_name TEXT,
    p_original_value TEXT,
    p_masked_value TEXT,
    p_mask_type TEXT
)
RETURNS void AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_table_name IS NULL OR p_table_name = '' THEN
        RAISE EXCEPTION 'table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    IF p_column_name IS NULL OR p_column_name = '' THEN
        RAISE EXCEPTION 'column_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'masking_audit_log') THEN
        RAISE EXCEPTION 'è¡¨ masking_audit_log ä¸å­˜åœ¨';
    END IF;

    BEGIN
        INSERT INTO masking_audit_log (
            user_id, table_name, column_name,
            original_value, masked_value, mask_type
        ) VALUES (
            current_user, p_table_name, p_column_name,
            p_original_value, p_masked_value, p_mask_type
        );
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ masking_audit_log ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è®°å½•è„±æ•å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 4.4 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½

**ä¸šåŠ¡åœºæ™¯**:

- ç”¨æˆ·æ•°æ®é‡: 1 äº¿æ¡
- æ•æ„Ÿå­—æ®µ: é‚®ç®±ã€ç”µè¯ã€åœ°å€ã€é“¶è¡Œå¡
- ç”¨æˆ·è§’è‰²: 10+ ç§è§’è‰²

**å®æ–½æ•ˆæœ**:

- æ•°æ®æ³„éœ²é£é™©: é™ä½ **95%**
- åˆè§„é€šè¿‡ç‡: ä» 65% æå‡åˆ° 98%ï¼ˆ**æå‡ 51%**ï¼‰
- æŸ¥è¯¢æ€§èƒ½: å»¶è¿Ÿå¢åŠ  2msï¼ˆå¯æ¥å—ï¼‰
- å¼€å‘æ•ˆç‡: æå‡ **40%**ï¼ˆæ— éœ€é™æ€è„±æ•ï¼‰

---

## 5. å‚è€ƒèµ„æ–™

- [ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—](./ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—.md)
- [ç»†ç²’åº¦æƒé™æ§åˆ¶](./ç»†ç²’åº¦æƒé™æ§åˆ¶.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
