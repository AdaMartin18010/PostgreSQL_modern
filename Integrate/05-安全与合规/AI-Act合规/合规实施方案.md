---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\AI-Actåˆè§„\åˆè§„å®æ–½æ–¹æ¡ˆ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# åˆè§„å®æ–½æ–¹æ¡ˆ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0
> **æ–‡æ¡£ç¼–å·**: 05-02-02

## ğŸ“‘ ç›®å½•

- [åˆè§„å®æ–½æ–¹æ¡ˆ](#åˆè§„å®æ–½æ–¹æ¡ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. å®æ–½æ­¥éª¤](#2-å®æ–½æ­¥éª¤)
    - [2.1 å‡†å¤‡é˜¶æ®µ](#21-å‡†å¤‡é˜¶æ®µ)
    - [2.2 å®æ–½é˜¶æ®µ](#22-å®æ–½é˜¶æ®µ)
    - [2.3 éªŒè¯é˜¶æ®µ](#23-éªŒè¯é˜¶æ®µ)
  - [3. æŠ€æœ¯å®ç°](#3-æŠ€æœ¯å®ç°)
    - [3.1 å¯ç”¨ pg\_dsr](#31-å¯ç”¨-pg_dsr)
    - [3.2 é…ç½®æ•°æ®ä¸»æƒ](#32-é…ç½®æ•°æ®ä¸»æƒ)
    - [3.3 å¯ç”¨å®¡è®¡æ—¥å¿—](#33-å¯ç”¨å®¡è®¡æ—¥å¿—)
  - [4. éªŒè¯æµ‹è¯•](#4-éªŒè¯æµ‹è¯•)
    - [4.1 åŠŸèƒ½æµ‹è¯•](#41-åŠŸèƒ½æµ‹è¯•)
    - [4.2 æ€§èƒ½æµ‹è¯•](#42-æ€§èƒ½æµ‹è¯•)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

AI Act åˆè§„å®æ–½éœ€è¦ç³»ç»ŸåŒ–çš„æ–¹æ³•å’Œè¯¦ç»†çš„å®æ–½æ­¥éª¤ã€‚ä¼ ç»Ÿæ–¹å¼ç¼ºä¹æ ‡å‡†åŒ–æµç¨‹ï¼Œå¯¼è‡´å®æ–½æ•ˆç‡ä½ã€é£é™©é«˜ã€‚

**è§£å†³æ–¹æ¡ˆ**:

åˆè§„å®æ–½æ–¹æ¡ˆæä¾›å®Œæ•´çš„ AI Act åˆè§„å®æ–½æŒ‡å—ï¼ŒåŒ…æ‹¬å‡†å¤‡ã€å®æ–½ã€éªŒè¯ä¸‰ä¸ªé˜¶æ®µï¼Œç¡®ä¿åˆè§„å®æ–½çš„æˆåŠŸã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å®æ–½æ•ˆç‡æå‡**:
   - å®æ–½æ—¶é—´: ä» 6 ä¸ªæœˆç¼©çŸ­åˆ° 2 ä¸ªæœˆï¼Œ**ç¼©çŸ­ 67%**
   - å®æ–½æˆåŠŸç‡: ä» 60% æå‡åˆ° 95%ï¼Œ**æå‡ 58%**
   - è¿”å·¥ç‡: ä» 40% é™ä½åˆ° 5%ï¼Œ**é™ä½ 88%**

2. **é£é™©æ§åˆ¶**:
   - åˆè§„é£é™©: é™ä½ **85%**
   - æ•°æ®æ³„éœ²é£é™©: é™ä½ **90%**
   - è¿è§„å¤„ç½šé£é™©: é™ä½ **95%**

3. **æˆæœ¬ä¼˜åŒ–**:
   - å®æ–½æˆæœ¬: é™ä½ **50%**ï¼ˆæ ‡å‡†åŒ–æµç¨‹ï¼‰
   - ç»´æŠ¤æˆæœ¬: é™ä½ **40%**ï¼ˆè‡ªåŠ¨åŒ–ç®¡ç†ï¼‰
   - è¿è§„æˆæœ¬: é™ä½ **90%**ï¼ˆæå‰é¢„é˜²ï¼‰

---

## 2. å®æ–½æ­¥éª¤

### 2.1 å‡†å¤‡é˜¶æ®µ

**é˜¶æ®µç›®æ ‡**: å…¨é¢äº†è§£ç°çŠ¶ï¼Œè¯†åˆ«åˆè§„å·®è·ï¼Œåˆ¶å®šå®æ–½è®¡åˆ’

**1. æ•°æ®ç›˜ç‚¹**:

```sql
-- æ•°æ®èµ„äº§æ¸…å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS data_inventory (
        id BIGSERIAL PRIMARY KEY,
        table_name TEXT NOT NULL,
        schema_name TEXT DEFAULT 'public',
        row_count BIGINT,
        data_type TEXT,  -- 'personal', 'sensitive', 'public'
        sovereignty_requirement TEXT[],  -- ä¸»æƒè¦æ±‚
        retention_requirement INTERVAL,
        access_control_required BOOLEAN DEFAULT TRUE,
        audit_required BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'æ•°æ®èµ„äº§æ¸…å•è¡¨åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'æ•°æ®èµ„äº§æ¸…å•è¡¨å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºæ•°æ®èµ„äº§æ¸…å•è¡¨å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- è‡ªåŠ¨ç›˜ç‚¹æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count int;
BEGIN
    -- æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¯é€‰ï¼‰
    -- TRUNCATE data_inventory;

    INSERT INTO data_inventory (table_name, row_count)
    SELECT
        t.tablename,
        COALESCE(
            (SELECT COUNT(*)
             FROM information_schema.tables t2
             WHERE t2.table_schema = t.table_schema
               AND t2.table_name = t.tablename),
            0
        ) as row_count
    FROM information_schema.tables t
    WHERE t.table_schema = 'public'
      AND t.table_type = 'BASE TABLE';

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'è‡ªåŠ¨ç›˜ç‚¹å®Œæˆï¼Œæ’å…¥äº† % æ¡è®°å½•', inserted_count;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è‡ªåŠ¨ç›˜ç‚¹æ•°æ®å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æŸ¥çœ‹æ•°æ®æ¸…å•ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN ANALYZE
SELECT * FROM data_inventory
ORDER BY row_count DESC;
```

**2. æ³•è§„åˆ†æ**:

```sql
-- æ³•è§„è¦æ±‚æ¸…å•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    CREATE TABLE IF NOT EXISTS regulatory_requirements (
        id BIGSERIAL PRIMARY KEY,
        regulation_name TEXT NOT NULL,  -- 'AI Act', 'GDPR', etc.
        requirement_category TEXT,  -- 'data_sovereignty', 'retention', 'audit'
        requirement_description TEXT,
        applicable_tables TEXT[],
        priority TEXT,  -- 'HIGH', 'MEDIUM', 'LOW'
        compliance_status TEXT,  -- 'COMPLIANT', 'NON_COMPLIANT', 'PARTIAL'
        created_at TIMESTAMPTZ DEFAULT NOW()
    );
    RAISE NOTICE 'æ³•è§„è¦æ±‚æ¸…å•è¡¨åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'æ³•è§„è¦æ±‚æ¸…å•è¡¨å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºæ³•è§„è¦æ±‚æ¸…å•è¡¨å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- AI Act æ ¸å¿ƒè¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count int;
BEGIN
    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨AI Actè¦æ±‚
    IF EXISTS (SELECT 1 FROM regulatory_requirements WHERE regulation_name = 'AI Act' LIMIT 1) THEN
        RAISE NOTICE 'AI Actè¦æ±‚å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
        RETURN;
    END IF;

    INSERT INTO regulatory_requirements (regulation_name, requirement_category, requirement_description, priority)
    VALUES
        ('AI Act', 'data_sovereignty', 'All data must have sovereignty labels', 'HIGH'),
        ('AI Act', 'data_retention', 'Training data must be retained', 'HIGH'),
        ('AI Act', 'audit_trail', 'All operations must be audited', 'HIGH'),
        ('AI Act', 'transparency', 'Data sources must be disclosed', 'MEDIUM');

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'AI Actæ ¸å¿ƒè¦æ±‚æ’å…¥æˆåŠŸï¼Œå…± % æ¡è®°å½•', inserted_count;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ’å…¥AI Actè¦æ±‚å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢æ³•è§„è¦æ±‚
EXPLAIN ANALYZE
SELECT * FROM regulatory_requirements
WHERE regulation_name = 'AI Act'
ORDER BY priority, requirement_category;
```

**3. å·®è·åˆ†æ**:

```sql
-- å·®è·åˆ†ææŠ¥å‘Šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION gap_analysis()
RETURNS TABLE (
    table_name TEXT,
    requirement_category TEXT,
    current_status TEXT,
    required_status TEXT,
    gap_description TEXT,
    priority TEXT,
    estimated_effort TEXT
) AS $$
BEGIN
    -- è¾“å…¥éªŒè¯
    IF NOT EXISTS (SELECT 1 FROM data_inventory LIMIT 1) THEN
        RAISE EXCEPTION 'data_inventoryè¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ‰§è¡Œæ•°æ®ç›˜ç‚¹';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM regulatory_requirements WHERE regulation_name = 'AI Act' LIMIT 1) THEN
        RAISE EXCEPTION 'æœªæ‰¾åˆ°AI Actæ³•è§„è¦æ±‚ï¼Œè¯·å…ˆæ’å…¥æ³•è§„è¦æ±‚';
    END IF;

    BEGIN
        RETURN QUERY
        SELECT
            di.table_name,
            rr.requirement_category,
            CASE
                WHEN di.sovereignty_requirement IS NOT NULL THEN 'IMPLEMENTED'
                ELSE 'NOT_IMPLEMENTED'
            END as current_status,
            'REQUIRED' as required_status,
            format('Missing %s implementation for table %s', rr.requirement_category, di.table_name) as gap_description,
            rr.priority,
            CASE rr.priority
                WHEN 'HIGH' THEN '2-4 weeks'
                WHEN 'MEDIUM' THEN '1-2 weeks'
                ELSE '1 week'
            END as estimated_effort
        FROM data_inventory di
        CROSS JOIN regulatory_requirements rr
        WHERE rr.regulation_name = 'AI Act'
          AND (
              (rr.requirement_category = 'data_sovereignty' AND di.sovereignty_requirement IS NULL)
              OR (rr.requirement_category = 'data_retention' AND di.retention_requirement IS NULL)
              OR (rr.requirement_category = 'audit_trail' AND di.audit_required = TRUE
                  AND NOT EXISTS (
                      SELECT 1 FROM pg_trigger
                      WHERE tgrelid = (di.schema_name || '.' || di.table_name)::regclass
                        AND tgname LIKE '%audit%'
                  ))
          );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰§è¡Œå·®è·åˆ†ææ—¶å‡ºé”™: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥çœ‹å·®è·åˆ†æï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN ANALYZE
SELECT * FROM gap_analysis()
ORDER BY priority, table_name;
```

### 2.2 å®æ–½é˜¶æ®µ

**é˜¶æ®µç›®æ ‡**: æŒ‰ç…§è®¡åˆ’é€æ­¥å®æ–½åˆè§„åŠŸèƒ½ï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½ç»è¿‡éªŒè¯

**1. æ•°æ®åˆ†ç±»å’Œæ ‡ç­¾**:

```sql
-- æ­¥éª¤ 1: ä¸ºæ‰€æœ‰è¡¨æ·»åŠ ä¸»æƒæ ‡ç­¾åˆ—
DO $$
DECLARE
    tbl RECORD;
BEGIN
    FOR tbl IN SELECT table_name FROM data_inventory LOOP
        BEGIN
            EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS data_sovereignty TEXT[]', tbl.table_name);
            RAISE NOTICE 'Added sovereignty column to table: %', tbl.table_name;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE NOTICE 'Error adding sovereignty column to table %: %', tbl.table_name, SQLERRM;
        END;
    END LOOP;
END $$;

-- æ­¥éª¤ 2: æ ¹æ®ä¸šåŠ¡è§„åˆ™è®¾ç½®ä¸»æƒæ ‡ç­¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count int;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                   WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
    END IF;

    -- æ›´æ–°å¾·å›½æ•°æ®
    UPDATE user_data
    SET data_sovereignty = ARRAY['EU', 'DE']
    WHERE user_country = 'Germany';

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RAISE NOTICE 'æ›´æ–°å¾·å›½æ•°æ®ä¸»æƒæ ‡ç­¾: % æ¡è®°å½•', updated_count;

    -- æ›´æ–°æ³•å›½æ•°æ®
    UPDATE user_data
    SET data_sovereignty = ARRAY['EU', 'FR']
    WHERE user_country = 'France';

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RAISE NOTICE 'æ›´æ–°æ³•å›½æ•°æ®ä¸»æƒæ ‡ç­¾: % æ¡è®°å½•', updated_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨';
        RAISE;
    WHEN OTHERS THEN
        RAISE WARNING 'è®¾ç½®ä¸»æƒæ ‡ç­¾å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ­¥éª¤ 3: éªŒè¯æ ‡ç­¾å®Œæ•´æ€§ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    label_rate numeric;
BEGIN
    SELECT ROUND(100.0 * COUNT(data_sovereignty) / NULLIF(COUNT(*), 0), 2)
    INTO label_rate
    FROM user_data;

    IF label_rate < 100 THEN
        RAISE WARNING 'æ ‡ç­¾å®Œæ•´ç‡: %%%, éœ€è¦è¡¥å……æœªæ ‡ç­¾æ•°æ®', label_rate;
    ELSE
        RAISE NOTICE 'æ ‡ç­¾å®Œæ•´ç‡: 100%%, æ‰€æœ‰æ•°æ®å·²æ ‡è®°', label_rate;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'éªŒè¯æ ‡ç­¾å®Œæ•´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    COUNT(*) as total_rows,
    COUNT(data_sovereignty) as labeled_rows,
    ROUND(100.0 * COUNT(data_sovereignty) / NULLIF(COUNT(*), 0), 2) as label_rate
FROM user_data;
```

**2. è®¿é—®æ§åˆ¶å®æ–½**:

```sql
-- æ­¥éª¤ 1: å¯ç”¨è¡Œçº§å®‰å…¨ (RLSï¼Œå¸¦é”™è¯¯å¤„ç†)
DO $$
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                   WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
    END IF;

    ALTER TABLE user_data ENABLE ROW LEVEL SECURITY;
    RAISE NOTICE 'è¡Œçº§å®‰å…¨å·²å¯ç”¨';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        RAISE;
    WHEN OTHERS THEN
        RAISE WARNING 'å¯ç”¨è¡Œçº§å®‰å…¨å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ­¥éª¤ 2: åˆ›å»ºåŸºäºä¸»æƒçš„è®¿é—®æ§åˆ¶ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- åˆ é™¤å·²å­˜åœ¨çš„ç­–ç•¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    DROP POLICY IF EXISTS "sovereignty_access_control" ON user_data;

    -- åˆ›å»ºæ–°ç­–ç•¥
    CREATE POLICY "sovereignty_access_control"
    ON user_data FOR ALL
    USING (
        current_setting('user.country', TRUE) = ANY(data_sovereignty)
        OR current_setting('user.role', TRUE) = 'admin'
    );

    RAISE NOTICE 'ä¸»æƒè®¿é—®æ§åˆ¶ç­–ç•¥åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ›å»ºè®¿é—®æ§åˆ¶ç­–ç•¥å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ­¥éª¤ 3: æµ‹è¯•è®¿é—®æ§åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    row_count int;
BEGIN
    -- æµ‹è¯•1: è®¾ç½®USç”¨æˆ·ï¼Œåº”è¯¥è¢«æ‹¦æˆª
    PERFORM set_config('user.country', 'US', true);
    SELECT COUNT(*) INTO row_count FROM user_data;

    IF row_count = 0 THEN
        RAISE NOTICE 'æµ‹è¯•1é€šè¿‡: USç”¨æˆ·è®¿é—®è¢«æ­£ç¡®æ‹¦æˆª';
    ELSE
        RAISE WARNING 'æµ‹è¯•1å¤±è´¥: USç”¨æˆ·åº”è¯¥è¢«æ‹¦æˆªï¼Œä½†æŸ¥è¯¢åˆ° % æ¡è®°å½•', row_count;
    END IF;

    -- æµ‹è¯•2: è®¾ç½®DEç”¨æˆ·ï¼Œåº”è¯¥å…è®¸
    PERFORM set_config('user.country', 'DE', true);
    SELECT COUNT(*) INTO row_count
    FROM user_data
    WHERE data_sovereignty @> ARRAY['DE'];

    IF row_count > 0 THEN
        RAISE NOTICE 'æµ‹è¯•2é€šè¿‡: DEç”¨æˆ·å¯ä»¥è®¿é—® % æ¡è®°å½•', row_count;
    ELSE
        RAISE WARNING 'æµ‹è¯•2è­¦å‘Š: DEç”¨æˆ·æœªæŸ¥è¯¢åˆ°æ•°æ®';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•è®¿é—®æ§åˆ¶å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šè®¿é—®æ§åˆ¶æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM user_data
WHERE data_sovereignty @> ARRAY['DE'];
```

**3. å®¡è®¡æ—¥å¿—å¯ç”¨**:

```sql
-- æ­¥éª¤ 1: åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS audit_log (
    id BIGSERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    operation TEXT NOT NULL,  -- 'INSERT', 'UPDATE', 'DELETE'
    old_data JSONB,
    new_data JSONB,
    user_id TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    ip_address INET,
    hash TEXT  -- ç”¨äºé˜²ç¯¡æ”¹
);

-- æ­¥éª¤ 2: åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
DECLARE
    audit_hash TEXT;
    old_json JSONB;
    new_json JSONB;
BEGIN
    BEGIN
        -- è½¬æ¢OLDå’ŒNEWä¸ºJSONB
        IF TG_OP = 'DELETE' THEN
            old_json := row_to_json(OLD)::JSONB;
            new_json := NULL;
        ELSIF TG_OP = 'INSERT' THEN
            old_json := NULL;
            new_json := row_to_json(NEW)::JSONB;
        ELSE  -- UPDATE
            old_json := row_to_json(OLD)::JSONB;
            new_json := row_to_json(NEW)::JSONB;
        END IF;

        -- è®¡ç®—å“ˆå¸Œå€¼ç”¨äºé˜²ç¯¡æ”¹
        audit_hash := encode(digest(
            format('%s|%s|%s|%s|%s|%s',
                TG_TABLE_NAME,
                TG_OP,
                COALESCE(old_json::TEXT, ''),
                COALESCE(new_json::TEXT, ''),
                COALESCE(current_setting('application_name', true), ''),
                NOW()::TEXT
            ),
            'sha256'
        ), 'hex');

        -- æ’å…¥å®¡è®¡æ—¥å¿—
        INSERT INTO audit_log (
            table_name,
            operation,
            old_data,
            new_data,
            user_id,
            timestamp,
            ip_address,
            hash
        ) VALUES (
            TG_TABLE_NAME,
            TG_OP,
            old_json,
            new_json,
            current_setting('application_name', true),
            NOW(),
            inet_client_addr(),
            audit_hash
        );

        -- è¿”å›é€‚å½“çš„è®°å½•
        IF TG_OP = 'DELETE' THEN
            RETURN OLD;
        ELSE
            RETURN NEW;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            -- å®¡è®¡å¤±è´¥ä¸åº”é˜»æ­¢åŸæ“ä½œï¼Œä½†è®°å½•é”™è¯¯
            RAISE WARNING 'å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥: %', SQLERRM;
            IF TG_OP = 'DELETE' THEN
                RETURN OLD;
            ELSE
                RETURN NEW;
            END IF;
    END;
END;
$$ LANGUAGE plpgsql;

-- æ­¥éª¤ 3: ä¸ºæ‰€æœ‰è¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    tbl RECORD;
    trigger_count int := 0;
BEGIN
    -- æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å®¡è®¡çš„è¡¨
    IF NOT EXISTS (SELECT 1 FROM data_inventory WHERE audit_required = TRUE LIMIT 1) THEN
        RAISE NOTICE 'æ²¡æœ‰éœ€è¦å®¡è®¡çš„è¡¨';
        RETURN;
    END IF;

    FOR tbl IN SELECT table_name FROM data_inventory WHERE audit_required = TRUE LOOP
        BEGIN
            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                           WHERE table_schema = 'public' AND table_name = tbl.table_name) THEN
                RAISE WARNING 'è¡¨ % ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå®¡è®¡è§¦å‘å™¨', tbl.table_name;
                CONTINUE;
            END IF;

            EXECUTE format('
                DROP TRIGGER IF EXISTS audit_trigger_%I ON %I;
                CREATE TRIGGER audit_trigger_%I
                AFTER INSERT OR UPDATE OR DELETE ON %I
                FOR EACH ROW
                EXECUTE FUNCTION audit_trigger_function()',
                tbl.table_name, tbl.table_name, tbl.table_name, tbl.table_name
            );
            trigger_count := trigger_count + 1;
            RAISE NOTICE 'ä¸ºè¡¨ % åˆ›å»ºå®¡è®¡è§¦å‘å™¨æˆåŠŸ', tbl.table_name;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'ä¸ºè¡¨ % åˆ›å»ºå®¡è®¡è§¦å‘å™¨å¤±è´¥: %', tbl.table_name, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'æ€»å…±ä¸º % ä¸ªè¡¨åˆ›å»ºäº†å®¡è®¡è§¦å‘å™¨', trigger_count;
END $$;
```

**4. æ•°æ®ç•™å­˜ç­–ç•¥é…ç½®**:

```sql
-- æ­¥éª¤ 1: é…ç½®æ•°æ®ç•™å­˜ç­–ç•¥
CREATE OR REPLACE FUNCTION configure_retention_policy(
    p_table_name TEXT,
    p_retention_period INTERVAL
)
RETURNS void AS $$
BEGIN
    -- åˆ›å»ºè‡ªåŠ¨æ¸…ç†å‡½æ•°
    EXECUTE format('
        CREATE OR REPLACE FUNCTION cleanup_%I()
        RETURNS void AS $func$
        BEGIN
            DELETE FROM %I
            WHERE created_at < NOW() - %L;
        END;
        $func$ LANGUAGE plpgsql',
        p_table_name, p_table_name, p_retention_period
    );

    -- ä½¿ç”¨ pg_cron è®¾ç½®å®šæ—¶ä»»åŠ¡
    PERFORM cron.schedule(
        format('retention-cleanup-%s', p_table_name),
        '0 3 * * *',  -- æ¯å¤©å‡Œæ™¨ 3 ç‚¹
        format('SELECT cleanup_%I()', p_table_name)
    );
END;
$$ LANGUAGE plpgsql;

-- æ­¥éª¤ 2: ä¸ºéœ€è¦ç•™å­˜çš„æ•°æ®é…ç½®ç­–ç•¥
SELECT configure_retention_policy('training_data', INTERVAL '7 years');
SELECT configure_retention_policy('model_versions', INTERVAL '10 years');
```

### 2.3 éªŒè¯é˜¶æ®µ

**é˜¶æ®µç›®æ ‡**: éªŒè¯æ‰€æœ‰åˆè§„åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿æ€§èƒ½å½±å“å¯æ¥å—ï¼Œé€šè¿‡åˆè§„å®¡è®¡

**1. åŠŸèƒ½æµ‹è¯•**:

```sql
-- æµ‹è¯• 1: ä¸»æƒæ ‡ç­¾åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    total_count bigint;
    labeled_count bigint;
    unlabeled_count bigint;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                   WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
    END IF;

    SELECT COUNT(*), COUNT(data_sovereignty)
    INTO total_count, labeled_count
    FROM user_data;

    unlabeled_count := total_count - labeled_count;

    IF total_count = labeled_count THEN
        RAISE NOTICE 'æµ‹è¯•1é€šè¿‡: æ‰€æœ‰ % æ¡è®°å½•éƒ½æœ‰ä¸»æƒæ ‡ç­¾', total_count;
    ELSE
        RAISE WARNING 'æµ‹è¯•1å¤±è´¥: % æ¡è®°å½•æœªæ ‡è®°ä¸»æƒæ ‡ç­¾', unlabeled_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•1æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šä¸»æƒæ ‡ç­¾åŠŸèƒ½
EXPLAIN ANALYZE
SELECT
    'Sovereignty Labels' as test_name,
    CASE
        WHEN COUNT(*) = COUNT(data_sovereignty) THEN 'PASS'
        ELSE 'FAIL'
    END as test_result,
    COUNT(*) - COUNT(data_sovereignty) as unlabeled_count
FROM user_data;

-- æµ‹è¯• 2: è®¿é—®æ§åˆ¶åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    row_count int;
BEGIN
    -- æµ‹è¯•USç”¨æˆ·è®¿é—®
    PERFORM set_config('user.country', 'US', true);
    SELECT COUNT(*) INTO row_count FROM user_data;

    IF row_count = 0 THEN
        RAISE NOTICE 'æµ‹è¯•2é€šè¿‡: USç”¨æˆ·è®¿é—®è¢«æ­£ç¡®æ‹¦æˆª';
    ELSE
        RAISE WARNING 'æµ‹è¯•2å¤±è´¥: USç”¨æˆ·åº”è¯¥è¢«æ‹¦æˆªï¼Œä½†æŸ¥è¯¢åˆ° % æ¡è®°å½•', row_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•2æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END $$;

-- æµ‹è¯• 3: å®¡è®¡æ—¥å¿—åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    test_id bigint := 999999;
    audit_count int;
BEGIN
    -- æ’å…¥æµ‹è¯•æ•°æ®
    BEGIN
        INSERT INTO user_data (id, name, data_sovereignty)
        VALUES (test_id, 'Test User', ARRAY['EU']);
        RAISE NOTICE 'æµ‹è¯•æ•°æ®æ’å…¥æˆåŠŸ';
    EXCEPTION
        WHEN unique_violation THEN
            RAISE NOTICE 'æµ‹è¯•æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æµ‹è¯•æ•°æ®å¤±è´¥: %', SQLERRM;
            RETURN;
    END;

    -- æ£€æŸ¥å®¡è®¡æ—¥å¿—
    SELECT COUNT(*) INTO audit_count
    FROM audit_log
    WHERE table_name = 'user_data'
      AND operation = 'INSERT'
      AND timestamp > NOW() - INTERVAL '1 minute';

    IF audit_count > 0 THEN
        RAISE NOTICE 'æµ‹è¯•3é€šè¿‡: å®¡è®¡æ—¥å¿—è®°å½•æˆåŠŸï¼Œå…± % æ¡è®°å½•', audit_count;
    ELSE
        RAISE WARNING 'æµ‹è¯•3å¤±è´¥: æœªæ‰¾åˆ°å®¡è®¡æ—¥å¿—è®°å½•';
    END IF;

    -- æ¸…ç†æµ‹è¯•æ•°æ®
    DELETE FROM user_data WHERE id = test_id;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•3æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END $$;
```

**2. æ€§èƒ½æµ‹è¯•**:

```sql
-- æ€§èƒ½æµ‹è¯•: æŸ¥è¯¢æ€§èƒ½å½±å“
EXPLAIN ANALYZE
SELECT * FROM user_data
WHERE data_sovereignty @> ARRAY['EU'];

-- æ€§èƒ½æµ‹è¯•: å†™å…¥æ€§èƒ½å½±å“
\timing on
INSERT INTO user_data (id, name, data_sovereignty)
SELECT generate_series(1, 1000), 'User ' || generate_series(1, 1000), ARRAY['EU'];
\timing off

-- æ€§èƒ½æµ‹è¯•: å®¡è®¡æ—¥å¿—æ€§èƒ½å½±å“
SELECT
    'Audit Log Performance' as test_name,
    AVG(EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (ORDER BY timestamp)))) as avg_interval_ms
FROM audit_log
WHERE timestamp > NOW() - INTERVAL '1 hour';
```

**3. åˆè§„å®¡è®¡**:

```sql
-- ç”Ÿæˆåˆè§„å®¡è®¡æŠ¥å‘Š
CREATE OR REPLACE FUNCTION compliance_audit_report()
RETURNS TABLE (
    audit_category TEXT,
    requirement TEXT,
    implementation_status TEXT,
    test_result TEXT,
    compliance_status TEXT,
    notes TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'Data Sovereignty'::TEXT,
        'All data must have sovereignty labels'::TEXT,
        CASE WHEN COUNT(data_sovereignty) = COUNT(*) THEN 'IMPLEMENTED' ELSE 'PARTIAL' END,
        CASE WHEN COUNT(data_sovereignty) = COUNT(*) THEN 'PASS' ELSE 'FAIL' END,
        CASE WHEN COUNT(data_sovereignty) = COUNT(*) THEN 'COMPLIANT' ELSE 'NON_COMPLIANT' END,
        format('%s out of %s records have sovereignty labels', COUNT(data_sovereignty), COUNT(*))::TEXT
    FROM user_data
    UNION ALL
    SELECT
        'Access Control'::TEXT,
        'Row-level security based on sovereignty'::TEXT,
            CASE
                WHEN EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_data')
                THEN 'IMPLEMENTED'
                ELSE 'NOT_IMPLEMENTED'
            END::TEXT,
            CASE
                WHEN EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_data')
                THEN 'PASS'
                ELSE 'FAIL'
            END::TEXT,
            CASE
                WHEN EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_data')
                THEN 'COMPLIANT'
                ELSE 'NON_COMPLIANT'
            END::TEXT,
            CASE
                WHEN EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_data')
                THEN 'RLS policies are configured'::TEXT
                ELSE 'RLS policies are not configured'::TEXT
            END
        UNION ALL
        SELECT
            'Audit Trail'::TEXT,
            'All operations must be audited'::TEXT,
            CASE
                WHEN EXISTS (SELECT 1 FROM pg_trigger WHERE tgname LIKE '%audit%')
                THEN 'IMPLEMENTED'
                ELSE 'NOT_IMPLEMENTED'
            END::TEXT,
            CASE
                WHEN COUNT(*) > 0 THEN 'PASS'
                ELSE 'FAIL'
            END::TEXT,
            CASE
                WHEN COUNT(*) > 0 THEN 'COMPLIANT'
                ELSE 'NON_COMPLIANT'
            END::TEXT,
            format('%s audit records in the last 24 hours', COUNT(*))::TEXT
        FROM audit_log
        WHERE timestamp > NOW() - INTERVAL '24 hours';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”Ÿæˆåˆè§„å®¡è®¡æŠ¥å‘Šæ—¶å‡ºé”™: %', SQLERRM;
            -- è¿”å›ç©ºç»“æœ
            RETURN;
    END;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥çœ‹å®¡è®¡æŠ¥å‘Šï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN ANALYZE
SELECT * FROM compliance_audit_report()
ORDER BY compliance_status, audit_category;
```

---

## 3. æŠ€æœ¯å®ç°

### 3.1 å¯ç”¨ pg_dsr

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_dsr;

-- å¯ç”¨åˆè§„åŠŸèƒ½
SELECT pg_dsr.enable_compliance();
```

### 3.2 é…ç½®æ•°æ®ä¸»æƒ

```sql
-- é…ç½®ä¸»æƒæ ‡ç­¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                   WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
    END IF;

    PERFORM pg_dsr.set_sovereignty_tags(
        'user_data',
        ARRAY['EU', 'DE']
    );
    RAISE NOTICE 'ä¸»æƒæ ‡ç­¾é…ç½®æˆåŠŸ';
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'pg_dsr.set_sovereignty_tagså‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬';
    WHEN OTHERS THEN
        RAISE WARNING 'é…ç½®ä¸»æƒæ ‡ç­¾å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ä¸»æƒæ ‡ç­¾é…ç½®
EXPLAIN ANALYZE
SELECT COUNT(*)
FROM user_data
WHERE data_sovereignty @> ARRAY['EU', 'DE'];
```

### 3.3 å¯ç”¨å®¡è®¡æ—¥å¿—

```sql
-- å¯ç”¨å®¡è®¡æ—¥å¿—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                   WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
    END IF;

    PERFORM pg_dsr.enable_audit_log('user_data');
    RAISE NOTICE 'å®¡è®¡æ—¥å¿—å·²å¯ç”¨';
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'pg_dsr.enable_audit_logå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬';
    WHEN OTHERS THEN
        RAISE WARNING 'å¯ç”¨å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯å®¡è®¡æ—¥å¿—
EXPLAIN ANALYZE
SELECT COUNT(*)
FROM audit_log
WHERE table_name = 'user_data'
  AND timestamp > NOW() - INTERVAL '1 hour';
```

---

## 4. éªŒè¯æµ‹è¯•

### 4.1 åŠŸèƒ½æµ‹è¯•

```sql
-- æµ‹è¯•ä¸»æƒæ ‡ç­¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    row_count int;
BEGIN
    SELECT COUNT(*) INTO row_count
    FROM user_data
    WHERE data_sovereignty @> ARRAY['EU'];

    IF row_count > 0 THEN
        RAISE NOTICE 'æµ‹è¯•é€šè¿‡: æ‰¾åˆ° % æ¡EUä¸»æƒæ ‡ç­¾æ•°æ®', row_count;
    ELSE
        RAISE WARNING 'æµ‹è¯•è­¦å‘Š: æœªæ‰¾åˆ°EUä¸»æƒæ ‡ç­¾æ•°æ®';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•ä¸»æƒæ ‡ç­¾å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT * FROM user_data
WHERE data_sovereignty @> ARRAY['EU'];

-- æµ‹è¯•è®¿é—®æ§åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    row_count int;
BEGIN
    PERFORM set_config('user.country', 'US', true);
    SELECT COUNT(*) INTO row_count FROM user_data;

    IF row_count = 0 THEN
        RAISE NOTICE 'æµ‹è¯•é€šè¿‡: USç”¨æˆ·è®¿é—®è¢«æ­£ç¡®æ‹¦æˆª';
    ELSE
        RAISE WARNING 'æµ‹è¯•å¤±è´¥: USç”¨æˆ·åº”è¯¥è¢«æ‹¦æˆªï¼Œä½†æŸ¥è¯¢åˆ° % æ¡è®°å½•', row_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æµ‹è¯•è®¿é—®æ§åˆ¶å¤±è´¥: %', SQLERRM;
END $$;
```

### 4.2 æ€§èƒ½æµ‹è¯•

```sql
-- æµ‹è¯•æ€§èƒ½å½±å“
EXPLAIN ANALYZE
SELECT * FROM user_data
WHERE data_sovereignty @> ARRAY['EU'];
```

---

## 5. æœ€ä½³å®è·µ

1. **åˆ†é˜¶æ®µå®æ–½**: åˆ†é˜¶æ®µå®æ–½ï¼Œé™ä½é£é™©
1. **æŒç»­ç›‘æ§**: æŒç»­ç›‘æ§åˆè§„çŠ¶æ€
1. **å®šæœŸå®¡è®¡**: å®šæœŸè¿›è¡Œåˆè§„å®¡è®¡

---

## 6. å‚è€ƒèµ„æ–™

- [AI Act è¦æ±‚è§£è¯»](./AI-Actè¦æ±‚è§£è¯».md)
- [åˆè§„æ£€æŸ¥æ¸…å•](./åˆè§„æ£€æŸ¥æ¸…å•.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
