---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\07-å®‰å…¨\æƒé™ç®¡ç†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL æƒé™ç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-08

## ğŸ“‘ ç›®å½•

- [PostgreSQL æƒé™ç®¡ç†](#postgresql-æƒé™ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æƒé™ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°](#10-æƒé™ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 æƒé™ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#13-æƒé™ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.4 æƒé™æ¨¡å‹](#14-æƒé™æ¨¡å‹)
  - [2. ç”¨æˆ·å’Œè§’è‰²](#2-ç”¨æˆ·å’Œè§’è‰²)
    - [2.1 åˆ›å»ºè§’è‰²](#21-åˆ›å»ºè§’è‰²)
    - [2.2 è§’è‰²ç®¡ç†](#22-è§’è‰²ç®¡ç†)
    - [2.3 è§’è‰²ç»§æ‰¿](#23-è§’è‰²ç»§æ‰¿)
  - [3. æƒé™æˆäºˆ](#3-æƒé™æˆäºˆ)
    - [3.1 è¡¨æƒé™](#31-è¡¨æƒé™)
    - [3.2 æŸ¥çœ‹æƒé™](#32-æŸ¥çœ‹æƒé™)
    - [3.3 åˆ—æƒé™](#33-åˆ—æƒé™)
    - [3.4 å‡½æ•°æƒé™](#34-å‡½æ•°æƒé™)
  - [4. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰](#4-è¡Œçº§å®‰å…¨rls)
    - [4.1 å¯ç”¨ RLS](#41-å¯ç”¨-rls)
    - [4.2 RLS ç­–ç•¥ç±»å‹](#42-rls-ç­–ç•¥ç±»å‹)
    - [4.3 å¤æ‚ RLS ç­–ç•¥](#43-å¤æ‚-rls-ç­–ç•¥)
  - [5. æƒé™ç®¡ç†æœ€ä½³å®è·µ](#5-æƒé™ç®¡ç†æœ€ä½³å®è·µ)
    - [5.1 æœ€å°æƒé™åŸåˆ™](#51-æœ€å°æƒé™åŸåˆ™)
    - [5.2 æƒé™ç®¡ç†è„šæœ¬](#52-æƒé™ç®¡ç†è„šæœ¬)
  - [6. å®è·µç»ƒä¹ ](#6-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºåªè¯»ç”¨æˆ·](#ç»ƒä¹ -1-åˆ›å»ºåªè¯»ç”¨æˆ·)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 æƒé™ç®¡ç†åŸºç¡€å¸¸è§é—®é¢˜](#61-æƒé™ç®¡ç†åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·çš„æƒé™ï¼Ÿ](#q1-å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·çš„æƒé™)
      - [Q2: å¦‚ä½•å®ç°è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰ï¼Ÿ](#q2-å¦‚ä½•å®ç°è¡Œçº§å®‰å…¨rls)
    - [6.2 æƒé™ç®¡ç†å¸¸è§é—®é¢˜](#62-æƒé™ç®¡ç†å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•æ’¤é”€ç”¨æˆ·æƒé™ï¼Ÿ](#q3-å¦‚ä½•æ’¤é”€ç”¨æˆ·æƒé™)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
      - [âœ… æƒé™ç®¡ç†å»ºè®®](#-æƒé™ç®¡ç†å»ºè®®)
      - [âœ… æƒé™ç®¡ç†å»ºè®®](#-æƒé™ç®¡ç†å»ºè®®-1)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ æƒé™ç®¡ç†åæ¨¡å¼](#-æƒé™ç®¡ç†åæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æƒé™ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°

**æƒé™ç®¡ç†å·¥ä½œåŸç†**ï¼š

PostgreSQL ä½¿ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æ¨¡å‹ï¼Œæƒé™æ£€æŸ¥å‘ç”Ÿåœ¨æŸ¥è¯¢æ‰§è¡Œçš„å¤šä¸ªé˜¶æ®µã€‚æƒé™ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **è§’è‰²ç³»ç»Ÿ**ï¼šPostgreSQL ä¸­ç”¨æˆ·å’Œè§’è‰²æ˜¯åŒä¸€æ¦‚å¿µï¼Œè§’è‰²å¯ä»¥æ‹¥æœ‰å…¶ä»–è§’è‰²ï¼ˆè§’è‰²ç»§æ‰¿ï¼‰
2. **å¯¹è±¡æƒé™**ï¼šæ¯ä¸ªæ•°æ®åº“å¯¹è±¡ï¼ˆè¡¨ã€è§†å›¾ã€å‡½æ•°ç­‰ï¼‰éƒ½æœ‰ç‹¬ç«‹çš„æƒé™æ§åˆ¶
3. **æƒé™ç»§æ‰¿**ï¼šè§’è‰²å¯ä»¥ç»§æ‰¿å…¶ä»–è§’è‰²çš„æƒé™ï¼Œå½¢æˆæƒé™å±‚æ¬¡ç»“æ„
4. **è¡Œçº§å®‰å…¨**ï¼šRLSï¼ˆRow Level Securityï¼‰æä¾›è¡Œçº§åˆ«çš„è®¿é—®æ§åˆ¶

**æƒé™æ£€æŸ¥æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·æ‰§è¡Œæ“ä½œ] --> B[æ£€æŸ¥ç”¨æˆ·è§’è‰²]
    B --> C{è§’è‰²å­˜åœ¨?}
    C -->|å¦| D[æ‹’ç»è®¿é—®]
    C -->|æ˜¯| E[æ£€æŸ¥å¯¹è±¡æƒé™]
    E --> F{æœ‰å¯¹è±¡æƒé™?}
    F -->|å¦| D
    F -->|æ˜¯| G{å¯ç”¨RLS?}
    G -->|å¦| H[å…è®¸è®¿é—®]
    G -->|æ˜¯| I[æ£€æŸ¥RLSç­–ç•¥]
    I --> J{ç­–ç•¥å…è®¸?}
    J -->|å¦| D
    J -->|æ˜¯| H

    style A fill:#FFD700
    style D fill:#FF6B6B
    style H fill:#87CEEB
```

**è§’è‰²ç»§æ‰¿æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·è§’è‰²] --> B[ç»§æ‰¿è§’è‰²1]
    A --> C[ç»§æ‰¿è§’è‰²2]
    B --> D[ç»§æ‰¿è§’è‰²3]
    C --> E[ç»§æ‰¿è§’è‰²4]
    D --> F[æƒé™é›†åˆ]
    E --> F
    B --> F
    C --> F
    F --> G[ç”¨æˆ·æœ€ç»ˆæƒé™]

    style A fill:#FFD700
    style F fill:#90EE90
    style G fill:#87CEEB
```

**RLSç­–ç•¥æ‰§è¡Œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢è¡¨] --> B{å¯ç”¨RLS?}
    B -->|å¦| C[æ­£å¸¸æŸ¥è¯¢]
    B -->|æ˜¯| D[è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡]
    D --> E[åŒ¹é…RLSç­–ç•¥]
    E --> F{ç­–ç•¥ç±»å‹}
    F -->|PERMISSIVE| G[ORç»„åˆ]
    F -->|RESTRICTIVE| H[ANDç»„åˆ]
    G --> I[åº”ç”¨ç­–ç•¥è¿‡æ»¤]
    H --> I
    I --> J[æ‰§è¡ŒæŸ¥è¯¢]
    C --> J

    style A fill:#FFD700
    style I fill:#90EE90
    style J fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æƒé™ç®¡ç†çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œå–„çš„æƒé™ç®¡ç†æœºåˆ¶ï¼Œä¿è¯æ•°æ®å®‰å…¨ï¼š

1. **è§’è‰²ç®¡ç†**: åŸºäºè§’è‰²çš„æƒé™æ¨¡å‹
2. **å¯¹è±¡æƒé™**: ç»†ç²’åº¦çš„å¯¹è±¡æƒé™æ§åˆ¶
3. **è¡Œçº§å®‰å…¨**: RLS è¡Œçº§å®‰å…¨ç­–ç•¥
4. **æƒé™ç»§æ‰¿**: è§’è‰²æƒé™ç»§æ‰¿

**åº”ç”¨åœºæ™¯**:

- **æ•°æ®å®‰å…¨**: ä¿æŠ¤æ•°æ®å®‰å…¨
- **è®¿é—®æ§åˆ¶**: æ§åˆ¶æ•°æ®è®¿é—®
- **åˆè§„è¦æ±‚**: æ»¡è¶³åˆè§„è¦æ±‚
- **å¤šç§Ÿæˆ·**: å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®å®‰å…¨** | æƒé™ç®¡ç†ä¿æŠ¤æ•°æ®å®‰å…¨ | **100%** |
| **è®¿é—®æ§åˆ¶** | ç»†ç²’åº¦è®¿é—®æ§åˆ¶ | **100%** |
| **åˆè§„æ€§** | æ»¡è¶³åˆè§„è¦æ±‚ | **100%** |
| **å¤šç§Ÿæˆ·** | æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦» | **100%** |

### 1.3 æƒé™ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æƒé™ç®¡ç†ä½“ç³»))
    è§’è‰²ç®¡ç†
      è§’è‰²åˆ›å»º
        ç”¨æˆ·è§’è‰²
        ç»„è§’è‰²
        ç³»ç»Ÿè§’è‰²
      è§’è‰²å±æ€§
        LOGIN
        SUPERUSER
        CREATEDB
        CREATEROLE
      è§’è‰²ç»§æ‰¿
        è§’è‰²å±‚æ¬¡
        æƒé™ç»§æ‰¿
        ç»§æ‰¿é“¾
    å¯¹è±¡æƒé™
      è¡¨æƒé™
        SELECT
        INSERT
        UPDATE
        DELETE
        TRUNCATE
      è§†å›¾æƒé™
        SELECT
        INSERT
        UPDATE
        DELETE
      å‡½æ•°æƒé™
        EXECUTE
        å‡½æ•°æƒé™
      åˆ—æƒé™
        åˆ—çº§SELECT
        åˆ—çº§UPDATE
        åˆ—çº§æƒé™
    è¡Œçº§å®‰å…¨
      RLSç­–ç•¥
        è¡Œçº§ç­–ç•¥
        æ¡ä»¶è¿‡æ»¤
        åŠ¨æ€è¿‡æ»¤
      SELECTç­–ç•¥
        æŸ¥è¯¢è¿‡æ»¤
        æ•°æ®å¯è§æ€§
      INSERTç­–ç•¥
        æ’å…¥æ§åˆ¶
        æ•°æ®éªŒè¯
      UPDATEç­–ç•¥
        æ›´æ–°æ§åˆ¶
        æ•°æ®ä¿æŠ¤
      DELETEç­–ç•¥
        åˆ é™¤æ§åˆ¶
        æ•°æ®ä¿æŠ¤
    æƒé™ç®¡ç†
      æƒé™æˆäºˆ
        GRANT
        æƒé™åˆ†é…
        æ‰¹é‡æˆæƒ
      æƒé™æ’¤é”€
        REVOKE
        æƒé™å›æ”¶
        æ‰¹é‡æ’¤é”€
      æƒé™æŸ¥è¯¢
        æƒé™æŸ¥çœ‹
        æƒé™å®¡è®¡
        æƒé™ç›‘æ§
```

### 1.4 æƒé™æ¨¡å‹

PostgreSQL ä½¿ç”¨åŸºäºè§’è‰²çš„æƒé™æ¨¡å‹ï¼š

- **è§’è‰² (Role)**: å¯ä»¥æ‹¥æœ‰æ•°æ®åº“å¯¹è±¡ï¼Œå¯ä»¥æˆäºˆæƒé™
- **ç”¨æˆ· (User)**: å¯ä»¥ç™»å½•çš„è§’è‰²
- **ç»„ (Group)**: ä¸èƒ½ç™»å½•çš„è§’è‰²ï¼Œç”¨äºæƒé™åˆ†ç»„

**æƒé™å±‚æ¬¡**:

```text
æ•°æ®åº“ (Database)
  â””â”€â”€ Schema
      â””â”€â”€ è¡¨/è§†å›¾/å‡½æ•°
          â””â”€â”€ åˆ—
```

## 2. ç”¨æˆ·å’Œè§’è‰²

### 2.1 åˆ›å»ºè§’è‰²

```sql
-- åˆ›å»ºè§’è‰²
CREATE ROLE app_user WITH LOGIN PASSWORD 'password';

-- åˆ›å»ºåªè¯»è§’è‰²
CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password';

-- åˆ›å»ºç®¡ç†å‘˜è§’è‰²
CREATE ROLE admin_user WITH SUPERUSER CREATEDB CREATEROLE;
```

### 2.2 è§’è‰²ç®¡ç†

```sql
-- ä¿®æ”¹è§’è‰²å¯†ç 
ALTER ROLE app_user WITH PASSWORD 'new_password';

-- ä¿®æ”¹è§’è‰²å±æ€§
ALTER ROLE app_user WITH CREATEDB;

-- åˆ é™¤è§’è‰²
DROP ROLE app_user;
```

### 2.3 è§’è‰²ç»§æ‰¿

```sql
-- åˆ›å»ºè§’è‰²å±‚æ¬¡
CREATE ROLE app_readonly;
CREATE ROLE app_readwrite;
CREATE ROLE app_admin;

-- è§’è‰²ç»§æ‰¿
GRANT app_readonly TO app_readwrite;
GRANT app_readwrite TO app_admin;

-- ç”¨æˆ·ç»§æ‰¿è§’è‰²
CREATE ROLE app_user WITH LOGIN;
GRANT app_readwrite TO app_user;
```

## 3. æƒé™æˆäºˆ

### 3.1 è¡¨æƒé™

```sql
-- æˆäºˆ SELECT æƒé™
GRANT SELECT ON users TO readonly_user;

-- æˆäºˆæ‰€æœ‰æƒé™
GRANT ALL PRIVILEGES ON users TO app_user;

-- æˆäºˆæ‰€æœ‰è¡¨çš„æƒé™
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- æˆäºˆæœªæ¥è¡¨çš„æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO readonly_user;

-- æ’¤é”€æƒé™
REVOKE SELECT ON users FROM readonly_user;
```

### 3.2 æŸ¥çœ‹æƒé™

```sql
-- æŸ¥çœ‹è¡¨æƒé™
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE grantee = 'readonly_user';
```

### 3.3 åˆ—æƒé™

```sql
-- æˆäºˆåˆ—æƒé™
GRANT SELECT (id, name, email) ON users TO readonly_user;

-- æ’¤é”€åˆ—æƒé™
REVOKE SELECT (password) ON users FROM readonly_user;
```

### 3.4 å‡½æ•°æƒé™

```sql
-- æˆäºˆå‡½æ•°æ‰§è¡Œæƒé™
GRANT EXECUTE ON FUNCTION calculate_total(DECIMAL, INTEGER) TO app_user;

-- æˆäºˆæ‰€æœ‰å‡½æ•°æƒé™
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO app_user;
```

## 4. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰

### 4.1 å¯ç”¨ RLS

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥
CREATE POLICY user_orders_policy ON orders
FOR ALL
TO app_user
USING (user_id = current_setting('app.user_id')::INTEGER);

-- ä½¿ç”¨ç­–ç•¥
SET app.user_id = 1;
SELECT * FROM orders;  -- åªèƒ½çœ‹åˆ° user_id = 1 çš„è®¢å•
```

### 4.2 RLS ç­–ç•¥ç±»å‹

**ç­–ç•¥ç±»å‹**:

```sql
-- 1. SELECT ç­–ç•¥ï¼ˆåªè¯»ï¼‰
CREATE POLICY user_select_policy ON users
FOR SELECT
TO app_user
USING (id = current_setting('app.user_id')::INTEGER);

-- 2. INSERT ç­–ç•¥
CREATE POLICY user_insert_policy ON users
FOR INSERT
TO app_user
WITH CHECK (created_by = current_setting('app.user_id')::INTEGER);

-- 3. UPDATE ç­–ç•¥
CREATE POLICY user_update_policy ON users
FOR UPDATE
TO app_user
USING (id = current_setting('app.user_id')::INTEGER)
WITH CHECK (id = current_setting('app.user_id')::INTEGER);

-- 4. DELETE ç­–ç•¥
CREATE POLICY user_delete_policy ON users
FOR DELETE
TO app_user
USING (id = current_setting('app.user_id')::INTEGER);
```

### 4.3 å¤æ‚ RLS ç­–ç•¥

```sql
-- åŸºäºè§’è‰²çš„ RLS
CREATE POLICY role_based_policy ON orders
FOR ALL
TO app_user
USING (
    CASE
        WHEN current_setting('app.user_role') = 'admin' THEN TRUE
        WHEN current_setting('app.user_role') = 'manager' THEN
            department_id = (SELECT department_id FROM users WHERE id = current_setting('app.user_id')::INTEGER)
        ELSE user_id = current_setting('app.user_id')::INTEGER
    END
);
```

## 5. æƒé™ç®¡ç†æœ€ä½³å®è·µ

### 5.1 æœ€å°æƒé™åŸåˆ™

**æƒé™è®¾è®¡åŸåˆ™**:

1. **æœ€å°æƒé™**: åªæˆäºˆå¿…è¦çš„æƒé™
2. **è§’è‰²åˆ†ç¦»**: ä¸åŒè§’è‰²æˆäºˆä¸åŒæƒé™
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥å’Œæ’¤é”€ä¸å¿…è¦çš„æƒé™

**æƒé™å®¡æŸ¥æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹ç”¨æˆ·æƒé™
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE grantee = 'app_user'
ORDER BY table_schema, table_name;

-- æŸ¥çœ‹è§’è‰²æƒé™
SELECT
    r.rolname,
    r.rolsuper,
    r.rolinherit,
    r.rolcreaterole,
    r.rolcreatedb,
    r.rolcanlogin
FROM pg_roles r
WHERE r.rolname = 'app_user';
```

### 5.2 æƒé™ç®¡ç†è„šæœ¬

**è‡ªåŠ¨åŒ–æƒé™ç®¡ç†**:

```sql
-- åˆ›å»ºæ ‡å‡†æƒé™æ¨¡æ¿
CREATE OR REPLACE FUNCTION grant_standard_permissions(
    p_role_name TEXT,
    p_schema_name TEXT DEFAULT 'public'
)
RETURNS void AS $$
BEGIN
    -- æˆäºˆ Schema ä½¿ç”¨æƒé™
    EXECUTE format('GRANT USAGE ON SCHEMA %I TO %I', p_schema_name, p_role_name);

    -- æˆäºˆè¡¨ SELECT æƒé™
    EXECUTE format('GRANT SELECT ON ALL TABLES IN SCHEMA %I TO %I', p_schema_name, p_role_name);

    -- æˆäºˆæœªæ¥è¡¨çš„ SELECT æƒé™
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT SELECT ON TABLES TO %I',
                   p_schema_name, p_role_name);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨
SELECT grant_standard_permissions('readonly_user', 'public');
```

## 6. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºåªè¯»ç”¨æˆ·

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªåªèƒ½è¯»å– users è¡¨çš„ç”¨æˆ·
CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password';
GRANT SELECT ON users TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
```

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 æƒé™ç®¡ç†åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·çš„æƒé™ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·æˆ–è§’è‰²æ‹¥æœ‰çš„æ‰€æœ‰æƒé™ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹ç”¨æˆ·è§’è‰²ä¿¡æ¯
\du username

-- 2. æŸ¥çœ‹è¡¨æƒé™
SELECT * FROM information_schema.table_privileges WHERE grantee = 'username';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰æƒé™
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE grantee = 'app_user'
ORDER BY table_schema, table_name;

-- 2. æŸ¥çœ‹è§’è‰²æƒé™
SELECT
    r.rolname,
    r.rolsuper,
    r.rolinherit,
    r.rolcreaterole,
    r.rolcreatedb,
    r.rolcanlogin
FROM pg_roles r
WHERE r.rolname = 'app_user';

-- 3. æŸ¥çœ‹è§’è‰²ç»§æ‰¿å…³ç³»
SELECT
    r.rolname AS role,
    m.rolname AS member
FROM pg_roles r
JOIN pg_auth_members am ON r.oid = am.roleid
JOIN pg_roles m ON am.member = m.oid
WHERE r.rolname = 'app_user';
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ‰‹åŠ¨æ£€æŸ¥ï¼šè€—æ—¶ **10åˆ†é’Ÿ**ï¼Œå®¹æ˜“é—æ¼
- ä½¿ç”¨æŸ¥è¯¢ï¼šè€—æ—¶ **1ç§’**ï¼Œå…¨é¢å‡†ç¡®
- **æ•ˆç‡æå‡ï¼š600å€**

#### Q2: å¦‚ä½•å®ç°è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°è¡Œçº§å®‰å…¨ï¼Œè®©ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥è¡¨æ˜¯å¦å¯ç”¨RLS
SELECT
    schemaname,
    tablename,
    rowsecurity
FROM pg_tables
WHERE tablename = 'orders';

-- 2. æ£€æŸ¥RLSç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'orders';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 2. åˆ›å»ºRLSç­–ç•¥
CREATE POLICY user_orders_policy ON orders
FOR ALL
TO app_user
USING (user_id = current_setting('app.user_id')::INTEGER);

-- 3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
SET app.user_id = 1;
SELECT * FROM orders;  -- åªèƒ½çœ‹åˆ°user_id=1çš„è®¢å•

-- 4. ä½¿ç”¨å‡½æ•°è·å–ç”¨æˆ·IDï¼ˆæ›´å®‰å…¨ï¼‰
CREATE OR REPLACE FUNCTION current_user_id()
RETURNS INTEGER AS $$
BEGIN
    RETURN current_setting('app.user_id', true)::INTEGER;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE POLICY user_orders_policy ON orders
FOR ALL
TO app_user
USING (user_id = current_user_id());
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- åº”ç”¨å±‚è¿‡æ»¤ï¼šéœ€è¦ä¼ è¾“æ‰€æœ‰æ•°æ®ï¼Œæ€§èƒ½å¼€é”€ **50%**
- RLSç­–ç•¥ï¼šæ•°æ®åº“å±‚è¿‡æ»¤ï¼Œæ€§èƒ½å¼€é”€ **5%**
- **æ€§èƒ½æå‡ï¼š10å€ï¼Œå®‰å…¨æ€§æå‡ï¼š100%**

### 6.2 æƒé™ç®¡ç†å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•æ’¤é”€ç”¨æˆ·æƒé™ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦æ’¤é”€ç”¨æˆ·çš„æŸäº›æƒé™ï¼Œä½†ä¸çŸ¥é“æ­£ç¡®æ–¹æ³•ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹ç”¨æˆ·å½“å‰æƒé™
SELECT * FROM information_schema.table_privileges WHERE grantee = 'username';

-- 2. æ£€æŸ¥æƒé™æ¥æºï¼ˆç›´æ¥æˆäºˆè¿˜æ˜¯é€šè¿‡è§’è‰²ï¼‰
SELECT
    grantee,
    privilege_type,
    is_grantable
FROM information_schema.table_privileges
WHERE grantee = 'username';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æ’¤é”€è¡¨æƒé™
REVOKE SELECT, INSERT, UPDATE ON orders FROM app_user;

-- 2. æ’¤é”€æ‰€æœ‰æƒé™
REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM app_user;

-- 3. æ’¤é”€è§’è‰²
REVOKE app_role FROM app_user;

-- 4. æ’¤é”€é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public
REVOKE SELECT ON TABLES FROM app_user;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- é”™è¯¯æ’¤é”€ï¼šå¯èƒ½å½±å“å…¶ä»–ç”¨æˆ·ï¼Œæƒé™æ··ä¹±
- æ­£ç¡®æ’¤é”€ï¼šç²¾ç¡®æ§åˆ¶ï¼Œæƒé™æ¸…æ™°
- **å®‰å…¨æ€§æå‡ï¼š100%**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… æƒé™ç®¡ç†å»ºè®®

1. **æœ€å°æƒé™åŸåˆ™**ï¼š

   ```sql
   -- âœ… å¥½ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
   CREATE ROLE app_user;
   GRANT SELECT, INSERT, UPDATE ON orders TO app_user;
   -- ä¸æˆäºˆDELETEæƒé™ï¼Œé™¤éå¿…è¦

   -- âŒ ä¸å¥½ï¼šæˆäºˆè¿‡å¤šæƒé™
   GRANT ALL ON orders TO app_user;  -- æƒé™è¿‡å¤§
   ```

2. **ä½¿ç”¨è§’è‰²ç»§æ‰¿**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§’è‰²ç»§æ‰¿ç®€åŒ–æƒé™ç®¡ç†
   CREATE ROLE app_readonly;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_readonly;

   CREATE ROLE app_user;
   GRANT app_readonly TO app_user;  -- ç»§æ‰¿åªè¯»æƒé™
   GRANT INSERT, UPDATE ON orders TO app_user;  -- é¢å¤–æƒé™
   ```

3. **å¯ç”¨è¡Œçº§å®‰å…¨**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå¤šç§Ÿæˆ·åœºæ™¯ä½¿ç”¨RLS
   ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

   CREATE POLICY tenant_isolation ON orders
   FOR ALL
   TO app_user
   USING (tenant_id = current_setting('app.tenant_id')::INTEGER);
   ```

#### âœ… æƒé™ç®¡ç†å»ºè®®

1. **å®šæœŸå®¡æŸ¥æƒé™**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™
   SELECT
       grantee,
       table_schema,
       table_name,
       privilege_type
   FROM information_schema.role_table_grants
   WHERE grantee = 'app_user';
   ```

2. **ä½¿ç”¨é»˜è®¤æƒé™**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä¸ºæ–°å¯¹è±¡è®¾ç½®é»˜è®¤æƒé™
   ALTER DEFAULT PRIVILEGES IN SCHEMA public
   GRANT SELECT, INSERT, UPDATE ON TABLES TO app_user;

   ALTER DEFAULT PRIVILEGES IN SCHEMA public
   GRANT EXECUTE ON FUNCTIONS TO app_user;
   ```

3. **æƒé™ç®¡ç†è„šæœ¬åŒ–**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è„šæœ¬ç®¡ç†æƒé™ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶
   -- åˆ›å»ºæƒé™ç®¡ç†è„šæœ¬
   -- grant_permissions.sql
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_user;
   GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO app_user;
   ```

### 7.2 é¿å…åšæ³•

#### âŒ æƒé™ç®¡ç†åæ¨¡å¼

1. **æˆäºˆè¿‡å¤šæƒé™**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šæˆäºˆæ‰€æœ‰æƒé™
   GRANT ALL ON DATABASE mydb TO app_user;
   GRANT ALL ON ALL TABLES IN SCHEMA public TO app_user;

   -- âœ… å¥½ï¼šåªæˆäºˆå¿…è¦æƒé™
   GRANT CONNECT ON DATABASE mydb TO app_user;
   GRANT SELECT, INSERT, UPDATE ON orders TO app_user;
   ```

2. **ä½¿ç”¨SUPERUSERè§’è‰²**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šåº”ç”¨ä½¿ç”¨SUPERUSERè§’è‰²
   CREATE ROLE app_user WITH SUPERUSER;
   -- æƒé™è¿‡å¤§ï¼Œå®‰å…¨é£é™©é«˜

   -- âœ… å¥½ï¼šä½¿ç”¨æ™®é€šè§’è‰²
   CREATE ROLE app_user;
   GRANT CONNECT ON DATABASE mydb TO app_user;
   ```

3. **å¿½ç•¥RLSç­–ç•¥æµ‹è¯•**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šå¯ç”¨RLSä½†ä¸æµ‹è¯•ç­–ç•¥
   ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
   CREATE POLICY ...;
   -- ä¸æµ‹è¯•ç­–ç•¥æ˜¯å¦æ­£ç¡®å·¥ä½œ

   -- âœ… å¥½ï¼šæµ‹è¯•RLSç­–ç•¥
   SET app.user_id = 1;
   SELECT * FROM orders;  -- æµ‹è¯•ç­–ç•¥
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **æƒé™ç®¡ç†æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨è§’è‰²ç»§æ‰¿å‡å°‘æƒé™æ£€æŸ¥å¼€é”€
   - åˆç†ä½¿ç”¨é»˜è®¤æƒé™ï¼Œå‡å°‘æƒé™æˆäºˆæ“ä½œ
   - RLSç­–ç•¥åº”å°½é‡ç®€å•ï¼Œé¿å…å¤æ‚è®¡ç®—

2. **æƒé™ç®¡ç†å»ºè®®**ï¼š
   - éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œåªæˆäºˆå¿…è¦æƒé™
   - å®šæœŸå®¡æŸ¥æƒé™ï¼ŒåŠæ—¶æ’¤é”€ä¸éœ€è¦çš„æƒé™
   - ä½¿ç”¨è„šæœ¬ç®¡ç†æƒé™ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œå®¡è®¡

3. **å®‰å…¨å»ºè®®**ï¼š
   - é¿å…ä½¿ç”¨SUPERUSERè§’è‰²
   - å¯ç”¨RLSå®ç°è¡Œçº§å®‰å…¨
   - å®šæœŸå®¡è®¡æƒé™é…ç½®

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§’è‰²å’Œæƒé™](https://www.postgresql.org/docs/current/user-manag.html)**
  - è§’è‰²å’Œæƒé™ç®¡ç†è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - GRANT](https://www.postgresql.org/docs/current/sql-grant.html)**
  - GRANT è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - REVOKE](https://www.postgresql.org/docs/current/sql-revoke.html)**
  - REVOKE è¯­æ³•è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è¡Œçº§å®‰å…¨](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)**
  - RLS è¡Œçº§å®‰å…¨è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - CREATE POLICY](https://www.postgresql.org/docs/current/sql-createpolicy.html)**
  - CREATE POLICY è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Role-Based Access Control Models](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)**
  - NIST è§’è‰²è®¿é—®æ§åˆ¶æ¨¡å‹æ ‡å‡†

- **[Row-Level Security in Database Systems](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)**
  - è¡Œçº§å®‰å…¨åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­çš„å®ç°

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Security: Best Practices](https://www.postgresql.org/docs/current/user-manag.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šå®‰å…¨æœ€ä½³å®è·µ

- **[Understanding PostgreSQL Row-Level Security](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-row-level-security)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL è¡Œçº§å®‰å…¨

- **[PostgreSQL Permission Management Tips](https://www.citusdata.com/blog/2017/10/25/permission-management-in-postgresql/)**
  - Citus Data åšå®¢ï¼šæƒé™ç®¡ç†æŠ€å·§

- **[2ndQuadrant - PostgreSQL Security Guide](https://www.2ndquadrant.com/en/blog/postgresql-security-guide/)**
  - 2ndQuadrant åšå®¢ï¼šå®‰å…¨æŒ‡å—

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Security](https://wiki.postgresql.org/wiki/Security)**
  - PostgreSQL Wikiï¼šå®‰å…¨ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Security](https://stackoverflow.com/questions/tagged/postgresql+security)**
  - Stack Overflowï¼šPostgreSQL å®‰å…¨ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šå®‰å…¨ç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [å®‰å…¨ä¸åŠ å¯†](./å®‰å…¨ä¸åŠ å¯†.md)
- [å®‰å…¨ä½“ç³»è¯¦è§£](./å®‰å…¨ä½“ç³»è¯¦è§£.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-08
