---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\07-å®‰å…¨\å®‰å…¨ä½“ç³»è¯¦è§£.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL å®‰å…¨ä½“ç³»è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-57

## ğŸ“‘ ç›®å½•

- [PostgreSQL å®‰å…¨ä½“ç³»è¯¦è§£](#postgresql-å®‰å…¨ä½“ç³»è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 å®‰å…¨ä½“ç³»å·¥ä½œåŸç†æ¦‚è¿°](#10-å®‰å…¨ä½“ç³»å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾](#2-å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.1 å®‰å…¨ä½“ç³»æ¶æ„](#21-å®‰å…¨ä½“ç³»æ¶æ„)
    - [2.2 å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹](#22-å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹)
  - [3. å®‰å…¨æœºåˆ¶è¯¦è§£](#3-å®‰å…¨æœºåˆ¶è¯¦è§£)
    - [3.1 èº«ä»½è®¤è¯æœºåˆ¶](#31-èº«ä»½è®¤è¯æœºåˆ¶)
    - [3.2 æƒé™ç®¡ç†æœºåˆ¶](#32-æƒé™ç®¡ç†æœºåˆ¶)
    - [3.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰æœºåˆ¶](#33-è¡Œçº§å®‰å…¨rlsæœºåˆ¶)
    - [3.4 æ•°æ®åŠ å¯†æœºåˆ¶](#34-æ•°æ®åŠ å¯†æœºåˆ¶)
    - [3.5 å®¡è®¡æ—¥å¿—æœºåˆ¶](#35-å®¡è®¡æ—¥å¿—æœºåˆ¶)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
    - [4.2 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆçœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 å®‰å…¨é…ç½®åŸåˆ™](#51-å®‰å…¨é…ç½®åŸåˆ™)
    - [5.2 å®‰å…¨å»ºè®®](#52-å®‰å…¨å»ºè®®)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜](#61-å®‰å…¨é…ç½®å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼Ÿ](#q1-å¦‚ä½•å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»)
      - [Q2: å¦‚ä½•é…ç½®ä¼ä¸šçº§å®‰å…¨ç­–ç•¥ï¼Ÿ](#q2-å¦‚ä½•é…ç½®ä¼ä¸šçº§å®‰å…¨ç­–ç•¥)
    - [6.2 æƒé™ç®¡ç†å¸¸è§é—®é¢˜](#62-æƒé™ç®¡ç†å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Ÿ](#q3-å¦‚ä½•å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
      - [âœ… å®‰å…¨é…ç½®åŸåˆ™](#-å®‰å…¨é…ç½®åŸåˆ™)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ å®‰å…¨åæ¨¡å¼](#-å®‰å…¨åæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 å®‰å…¨ä½“ç³»å·¥ä½œåŸç†æ¦‚è¿°

**å®‰å…¨ä½“ç³»æ¶æ„**ï¼š

PostgreSQL å®‰å…¨ä½“ç³»é‡‡ç”¨å¤šå±‚é˜²å¾¡æ¶æ„ï¼ŒåŒ…æ‹¬èº«ä»½è®¤è¯ã€è®¿é—®æ§åˆ¶ã€æ•°æ®åŠ å¯†ã€å®¡è®¡æ—¥å¿—ç­‰å¤šä¸ªå±‚æ¬¡ï¼Œå½¢æˆçºµæ·±é˜²å¾¡ä½“ç³»ã€‚

**å®‰å…¨ä½“ç³»æ¶æ„æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[èº«ä»½è®¤è¯å±‚]
    B --> C{è®¤è¯æˆåŠŸ?}
    C -->|å¦| D[æ‹’ç»è®¿é—®]
    C -->|æ˜¯| E[è®¿é—®æ§åˆ¶å±‚]
    E --> F{æœ‰å¯¹è±¡æƒé™?}
    F -->|å¦| D
    F -->|æ˜¯| G{å¯ç”¨RLS?}
    G -->|å¦| H[å…è®¸è®¿é—®]
    G -->|æ˜¯| I[è¡Œçº§å®‰å…¨å±‚]
    I --> J{ç­–ç•¥å…è®¸?}
    J -->|å¦| D
    J -->|æ˜¯| K[æ•°æ®åŠ å¯†å±‚]
    K --> L[æ‰§è¡Œæ“ä½œ]
    L --> M[å®¡è®¡æ—¥å¿—å±‚]
    M --> N[è®°å½•æ“ä½œ]
    N --> H

    style A fill:#FFD700
    style D fill:#FF6B6B
    style H fill:#87CEEB
```

**å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å®‰å…¨éœ€æ±‚åˆ†æ] --> B{å®‰å…¨çº§åˆ«}
    B -->|åŸºç¡€| C[åŸºæœ¬å®‰å…¨é…ç½®]
    B -->|æ ‡å‡†| D[æ ‡å‡†å®‰å…¨é…ç½®]
    B -->|é«˜çº§| E[é«˜çº§å®‰å…¨é…ç½®]
    C --> C1[å¯†ç è®¤è¯]
    C --> C2[åŸºæœ¬æƒé™]
    D --> D1[SSL/TLSåŠ å¯†]
    D --> D2[ç»†ç²’åº¦æƒé™]
    D --> D3[å®¡è®¡æ—¥å¿—]
    E --> E1[åŒå‘SSLè®¤è¯]
    E --> E2[è¡Œçº§å®‰å…¨]
    E --> E3[æ•°æ®åŠ å¯†]
    E --> E4[å®Œæ•´å®¡è®¡]
    C1 --> F[å®æ–½é…ç½®]
    C2 --> F
    D1 --> F
    D2 --> F
    D3 --> F
    E1 --> F
    E2 --> F
    E3 --> F
    E4 --> F
    F --> G[éªŒè¯é…ç½®]
    G --> H{æ»¡è¶³è¦æ±‚?}
    H -->|å¦| I[è°ƒæ•´é…ç½®]
    I --> F
    H -->|æ˜¯| J[å®Œæˆé…ç½®]

    style A fill:#FFD700
    style F fill:#90EE90
    style J fill:#87CEEB
```

**å¤šç§Ÿæˆ·å®‰å…¨éš”ç¦»æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ç§Ÿæˆ·è¯·æ±‚] --> B[èº«ä»½è®¤è¯]
    B --> C[è·å–ç§Ÿæˆ·ID]
    C --> D[æ£€æŸ¥RLSç­–ç•¥]
    D --> E{ç­–ç•¥åŒ¹é…?}
    E -->|å¦| F[æ‹’ç»è®¿é—®]
    E -->|æ˜¯| G[åº”ç”¨ç§Ÿæˆ·è¿‡æ»¤]
    G --> H[æ‰§è¡ŒæŸ¥è¯¢]
    H --> I[è¿”å›ç§Ÿæˆ·æ•°æ®]

    style A fill:#FFD700
    style G fill:#90EE90
    style I fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**å®‰å…¨ä½“ç³»çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œæ•´çš„å®‰å…¨æœºåˆ¶ï¼š

1. **èº«ä»½è®¤è¯**: å¤šç§è®¤è¯æ–¹å¼
2. **æƒé™ç®¡ç†**: ç»†ç²’åº¦æƒé™æ§åˆ¶
3. **æ•°æ®åŠ å¯†**: ä¼ è¾“åŠ å¯†å’Œå­˜å‚¨åŠ å¯†
4. **è¡Œçº§å®‰å…¨**: è¡Œçº§å®‰å…¨ç­–ç•¥
5. **å®¡è®¡æ—¥å¿—**: æ“ä½œå®¡è®¡

**åº”ç”¨åœºæ™¯**:

- **æ•°æ®å®‰å…¨**: ä¿æŠ¤æ•°æ®å®‰å…¨
- **è®¿é—®æ§åˆ¶**: æ§åˆ¶æ•°æ®è®¿é—®
- **åˆè§„è¦æ±‚**: æ»¡è¶³åˆè§„è¦æ±‚
- **å®¡è®¡è¿½è¸ª**: è¿½è¸ªæ“ä½œè®°å½•

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æ•°æ®å®‰å…¨** | å¤šå±‚å®‰å…¨ä¿æŠ¤ | **100%** |
| **è®¿é—®æ§åˆ¶** | ç»†ç²’åº¦æƒé™æ§åˆ¶ | **100%** |
| **åˆè§„æ€§** | æ»¡è¶³åˆè§„è¦æ±‚ | **100%** |
| **å®¡è®¡èƒ½åŠ›** | å®Œæ•´å®¡è®¡è¿½è¸ª | **100%** |

## 2. å®‰å…¨ä½“ç³»æ€ç»´å¯¼å›¾

### 2.1 å®‰å…¨ä½“ç³»æ¶æ„

```mermaid
mindmap
  root((å®‰å…¨ä½“ç³»))
    èº«ä»½è®¤è¯
      å¯†ç è®¤è¯
        MD5
        SCRAM-SHA-256
        å¯†ç ç­–ç•¥
      SSL/TLS
        ä¼ è¾“åŠ å¯†
        è¯ä¹¦è®¤è¯
        åŒå‘è®¤è¯
      LDAPè®¤è¯
        LDAPé›†æˆ
        ä¼ä¸šè®¤è¯
        å•ç‚¹ç™»å½•
      Kerberosè®¤è¯
        Kerberosé›†æˆ
        ä¼ä¸šè®¤è¯
        å•ç‚¹ç™»å½•
      PAMè®¤è¯
        PAMé›†æˆ
        ç³»ç»Ÿè®¤è¯
        çµæ´»è®¤è¯
    æƒé™ç®¡ç†
      è§’è‰²ç®¡ç†
        è§’è‰²åˆ›å»º
        è§’è‰²ç»§æ‰¿
        è§’è‰²æƒé™
      å¯¹è±¡æƒé™
        SELECT
        INSERT
        UPDATE
        DELETE
        TRUNCATE
        REFERENCES
        TRIGGER
        CREATE
        CONNECT
        TEMPORARY
      æ¨¡å¼æƒé™
        æ¨¡å¼åˆ›å»º
        æ¨¡å¼ä½¿ç”¨
        æ¨¡å¼æƒé™
      æ•°æ®åº“æƒé™
        æ•°æ®åº“åˆ›å»º
        æ•°æ®åº“è¿æ¥
        æ•°æ®åº“æƒé™
    è¡Œçº§å®‰å…¨
      RLSç­–ç•¥
        è¡Œçº§ç­–ç•¥
        æ¡ä»¶è¿‡æ»¤
        åŠ¨æ€è¿‡æ»¤
      SELECTç­–ç•¥
        æŸ¥è¯¢è¿‡æ»¤
        æ•°æ®å¯è§æ€§
      INSERTç­–ç•¥
        æ’å…¥æ§åˆ¶
        æ•°æ®éªŒè¯
      UPDATEç­–ç•¥
        æ›´æ–°æ§åˆ¶
        æ•°æ®ä¿æŠ¤
      DELETEç­–ç•¥
        åˆ é™¤æ§åˆ¶
        æ•°æ®ä¿æŠ¤
    æ•°æ®åŠ å¯†
      ä¼ è¾“åŠ å¯†
        SSL/TLS
        è¯ä¹¦ç®¡ç†
        åŠ å¯†å¼ºåº¦
      å­˜å‚¨åŠ å¯†
        é€æ˜åŠ å¯†
        å­—æ®µåŠ å¯†
        å¯†é’¥ç®¡ç†
      pgcryptoæ‰©å±•
        å“ˆå¸Œå‡½æ•°
        åŠ å¯†å‡½æ•°
        ç­¾åå‡½æ•°
    å®¡è®¡æ—¥å¿—
      æ“ä½œå®¡è®¡
        ç™»å½•å®¡è®¡
        æ“ä½œå®¡è®¡
        é”™è¯¯å®¡è®¡
      pgAuditæ‰©å±•
        è¯¦ç»†å®¡è®¡
        åˆè§„å®¡è®¡
        æ€§èƒ½å®¡è®¡
    å®‰å…¨é…ç½®
      å¯†ç ç­–ç•¥
        å¯†ç å¤æ‚åº¦
        å¯†ç è¿‡æœŸ
        å¯†ç å†å²
      è¿æ¥é™åˆ¶
        max_connections
        è¿æ¥è¶…æ—¶
        IPé™åˆ¶
      å®‰å…¨å‚æ•°
        sslå‚æ•°
        åŠ å¯†å‚æ•°
        å®‰å…¨å‚æ•°
```

### 2.2 å®‰å…¨ç­–ç•¥å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[å®‰å…¨éœ€æ±‚] --> B{è®¤è¯æ–¹å¼?}
    B -->|å¯†ç | C[SCRAM-SHA-256]
    B -->|è¯ä¹¦| D[SSL/TLS]
    B -->|ä¼ä¸š| E[LDAP/Kerberos]
    C --> F{æƒé™æ§åˆ¶?}
    D --> F
    E --> F
    F -->|å¯¹è±¡çº§| G[å¯¹è±¡æƒé™]
    F -->|è¡Œçº§| H[RLSç­–ç•¥]
    F -->|åˆ—çº§| I[åˆ—æƒé™]
    G --> J{æ•°æ®åŠ å¯†?}
    H --> J
    I --> J
    J -->|ä¼ è¾“| K[SSL/TLS]
    J -->|å­˜å‚¨| L[pgcrypto]
    K --> M{å®¡è®¡éœ€æ±‚?}
    L --> M
    M -->|æ˜¯| N[pgAudit]
    M -->|å¦| O[åŸºç¡€æ—¥å¿—]
    N --> P[å®‰å…¨é…ç½®å®Œæˆ]
    O --> P
```

## 3. å®‰å…¨æœºåˆ¶è¯¦è§£

### 3.1 èº«ä»½è®¤è¯æœºåˆ¶

**è®¤è¯æ–¹å¼å¯¹æ¯”**:

| è®¤è¯æ–¹å¼ | å®‰å…¨æ€§ | æ˜“ç”¨æ€§ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|--------|--------|---------|--------|
| **SCRAM-SHA-256** | â­â­â­â­â­ | â­â­â­â­ | é»˜è®¤æ¨è | â­â­â­â­â­ |
| **MD5** | â­â­ | â­â­â­â­â­ | å…¼å®¹æ—§ç³»ç»Ÿ | â­ |
| **SSL/TLS** | â­â­â­â­â­ | â­â­â­ | é«˜å®‰å…¨è¦æ±‚ | â­â­â­â­â­ |
| **LDAP** | â­â­â­â­ | â­â­â­ | ä¼ä¸šç¯å¢ƒ | â­â­â­â­ |
| **Kerberos** | â­â­â­â­â­ | â­â­ | ä¼ä¸šç¯å¢ƒ | â­â­â­ |

**è®¤è¯é…ç½®ç¤ºä¾‹**:

```sql
-- 1. åˆ›å»ºç”¨æˆ·ï¼ˆSCRAM-SHA-256ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE NOTICE 'ç”¨æˆ· app_user å·²å­˜åœ¨';
        ELSE
            CREATE USER app_user WITH PASSWORD 'secure_password';
            RAISE NOTICE 'ç”¨æˆ· app_user åˆ›å»ºæˆåŠŸï¼ˆSCRAM-SHA-256ï¼‰';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç”¨æˆ· app_user å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç”¨æˆ·å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é…ç½®SSLè®¤è¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- postgresql.conf
-- ssl = on
-- ssl_cert_file = 'server.crt'
-- ssl_key_file = 'server.key'
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥SSLæ˜¯å¦å·²å¯ç”¨
        IF current_setting('ssl') = 'on' THEN
            RAISE NOTICE 'SSLå·²å¯ç”¨';
        ELSE
            RAISE WARNING 'SSLæœªå¯ç”¨ï¼Œéœ€è¦åœ¨postgresql.confä¸­è®¾ç½® ssl = on';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥SSLé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- pg_hba.confé…ç½®ï¼ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ ï¼‰
-- hostssl    all    all    0.0.0.0/0    cert

-- 3. é…ç½®LDAPè®¤è¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- pg_hba.confé…ç½®ï¼ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ ï¼‰
-- host    all    all    0.0.0.0/0    ldap ldapserver=ldap.example.com ldapprefix="uid=" ldapsuffix=",ou=people,dc=example,dc=com"
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'LDAPè®¤è¯é…ç½®éœ€è¦åœ¨pg_hba.confæ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ ';
        RAISE NOTICE 'é…ç½®åéœ€è¦é‡æ–°åŠ è½½PostgreSQLé…ç½®ï¼šSELECT pg_reload_conf();';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'LDAPé…ç½®æ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.2 æƒé™ç®¡ç†æœºåˆ¶

**æƒé™ç±»å‹å¯¹æ¯”**:

| æƒé™ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | é‡è¦æ€§ |
|---------|------|---------|--------|
| **SELECT** | æŸ¥è¯¢æƒé™ | åªè¯»è®¿é—® | â­â­â­â­â­ |
| **INSERT** | æ’å…¥æƒé™ | æ•°æ®å†™å…¥ | â­â­â­â­â­ |
| **UPDATE** | æ›´æ–°æƒé™ | æ•°æ®ä¿®æ”¹ | â­â­â­â­â­ |
| **DELETE** | åˆ é™¤æƒé™ | æ•°æ®åˆ é™¤ | â­â­â­â­â­ |
| **TRUNCATE** | æ¸…ç©ºæƒé™ | è¡¨æ¸…ç©º | â­â­â­ |
| **REFERENCES** | å¤–é”®æƒé™ | å¤–é”®çº¦æŸ | â­â­â­ |
| **TRIGGER** | è§¦å‘å™¨æƒé™ | è§¦å‘å™¨åˆ›å»º | â­â­â­ |
| **CREATE** | åˆ›å»ºæƒé™ | å¯¹è±¡åˆ›å»º | â­â­â­â­ |

**æƒé™ç®¡ç†ç¤ºä¾‹**:

```sql
-- 1. åˆ›å»ºè§’è‰²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            CREATE ROLE app_readonly;
            RAISE NOTICE 'è§’è‰² app_readonly åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰² app_readonly å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readwrite') THEN
            CREATE ROLE app_readwrite;
            RAISE NOTICE 'è§’è‰² app_readwrite åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰² app_readwrite å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_admin') THEN
            CREATE ROLE app_admin;
            RAISE NOTICE 'è§’è‰² app_admin åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰² app_admin å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'éƒ¨åˆ†è§’è‰²å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰²å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æˆäºˆæƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åªè¯»æƒé™
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            RAISE WARNING 'è§’è‰² app_readonly ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'public') THEN
            RAISE WARNING 'schema public ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_readonly;
        GRANT USAGE ON SCHEMA public TO app_readonly;
        RAISE NOTICE 'åªè¯»æƒé™æˆäºˆæˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆåªè¯»æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è¯»å†™æƒé™
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readwrite') THEN
            RAISE WARNING 'è§’è‰² app_readwrite ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
            RETURN;
        END IF;

        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_readwrite;
        GRANT USAGE ON SCHEMA public TO app_readwrite;
        RAISE NOTICE 'è¯»å†™æƒé™æˆäºˆæˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆè¯»å†™æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç®¡ç†å‘˜æƒé™
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_admin') THEN
            RAISE WARNING 'è§’è‰² app_admin ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
            RETURN;
        END IF;

        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_admin;
        GRANT ALL PRIVILEGES ON SCHEMA public TO app_admin;
        RAISE NOTICE 'ç®¡ç†å‘˜æƒé™æˆäºˆæˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•æˆäºˆæƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆç®¡ç†å‘˜æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æˆäºˆè§’è‰²ç»™ç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_auth_members WHERE roleid = (SELECT oid FROM pg_roles WHERE rolname = 'app_readonly') AND member = (SELECT oid FROM pg_roles WHERE rolname = 'readonly_user')) THEN
                GRANT app_readonly TO readonly_user;
                RAISE NOTICE 'è§’è‰² app_readonly å·²æˆäºˆç»™ readonly_user';
            ELSE
                RAISE NOTICE 'è§’è‰² app_readonly å·²æˆäºˆç»™ readonly_user';
            END IF;
        ELSE
            RAISE WARNING 'ç”¨æˆ· readonly_user ä¸å­˜åœ¨';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readwrite_user') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_auth_members WHERE roleid = (SELECT oid FROM pg_roles WHERE rolname = 'app_readwrite') AND member = (SELECT oid FROM pg_roles WHERE rolname = 'readwrite_user')) THEN
                GRANT app_readwrite TO readwrite_user;
                RAISE NOTICE 'è§’è‰² app_readwrite å·²æˆäºˆç»™ readwrite_user';
            ELSE
                RAISE NOTICE 'è§’è‰² app_readwrite å·²æˆäºˆç»™ readwrite_user';
            END IF;
        ELSE
            RAISE WARNING 'ç”¨æˆ· readwrite_user ä¸å­˜åœ¨';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'admin_user') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_auth_members WHERE roleid = (SELECT oid FROM pg_roles WHERE rolname = 'app_admin') AND member = (SELECT oid FROM pg_roles WHERE rolname = 'admin_user')) THEN
                GRANT app_admin TO admin_user;
                RAISE NOTICE 'è§’è‰² app_admin å·²æˆäºˆç»™ admin_user';
            ELSE
                RAISE NOTICE 'è§’è‰² app_admin å·²æˆäºˆç»™ admin_user';
            END IF;
        ELSE
            RAISE WARNING 'ç”¨æˆ· admin_user ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'ç”¨æˆ·æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆè§’è‰²å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. åˆ—çº§æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆåˆ—çº§æƒé™';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            RAISE WARNING 'è§’è‰² app_readonly ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT (id, name, email) ON users TO app_readonly;
        RAISE NOTICE 'åˆ—çº§åªè¯»æƒé™æˆäºˆæˆåŠŸ';

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readwrite') THEN
            RAISE WARNING 'è§’è‰² app_readwrite ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT, UPDATE (name, email) ON users TO app_readwrite;
        RAISE NOTICE 'åˆ—çº§è¯»å†™æƒé™æˆäºˆæˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•æˆäºˆåˆ—çº§æƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆåˆ—çº§æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰æœºåˆ¶

**RLSç­–ç•¥ç±»å‹**:

| ç­–ç•¥ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½ |
|---------|------|---------|------|
| **SELECTç­–ç•¥** | æŸ¥è¯¢è¿‡æ»¤ | æ•°æ®å¯è§æ€§æ§åˆ¶ | â­â­â­â­ |
| **INSERTç­–ç•¥** | æ’å…¥æ§åˆ¶ | æ•°æ®æ’å…¥éªŒè¯ | â­â­â­â­ |
| **UPDATEç­–ç•¥** | æ›´æ–°æ§åˆ¶ | æ•°æ®æ›´æ–°éªŒè¯ | â­â­â­â­ |
| **DELETEç­–ç•¥** | åˆ é™¤æ§åˆ¶ | æ•°æ®åˆ é™¤éªŒè¯ | â­â­â­â­ |

**RLSé…ç½®ç¤ºä¾‹**:

```sql
-- 1. å¯ç”¨RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•å¯ç”¨RLS';
            RETURN;
        END IF;

        ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'RLSå·²å¯ç”¨';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åˆ›å»ºSELECTç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºSELECTç­–ç•¥';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_select_policy') THEN
            RAISE NOTICE 'ç­–ç•¥ orders_select_policy å·²å­˜åœ¨';
        ELSE
            CREATE POLICY orders_select_policy ON orders
                FOR SELECT
                USING (user_id = current_user_id());
            RAISE NOTICE 'SELECTç­–ç•¥åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç­–ç•¥ orders_select_policy å·²å­˜åœ¨';
        WHEN syntax_error THEN
            RAISE WARNING 'ç­–ç•¥è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥current_user_id()å‡½æ•°æ˜¯å¦å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºSELECTç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. åˆ›å»ºINSERTç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®¢å•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºINSERTç­–ç•¥';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_insert_policy') THEN
            RAISE NOTICE 'ç­–ç•¥ orders_insert_policy å·²å­˜åœ¨';
        ELSE
            CREATE POLICY orders_insert_policy ON orders
                FOR INSERT
                WITH CHECK (user_id = current_user_id());
            RAISE NOTICE 'INSERTç­–ç•¥åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç­–ç•¥ orders_insert_policy å·²å­˜åœ¨';
        WHEN syntax_error THEN
            RAISE WARNING 'ç­–ç•¥è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥current_user_id()å‡½æ•°æ˜¯å¦å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºINSERTç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. åˆ›å»ºUPDATEç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è®¢å•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºUPDATEç­–ç•¥';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_update_policy') THEN
            RAISE NOTICE 'ç­–ç•¥ orders_update_policy å·²å­˜åœ¨';
        ELSE
            CREATE POLICY orders_update_policy ON orders
                FOR UPDATE
                USING (user_id = current_user_id())
                WITH CHECK (user_id = current_user_id());
            RAISE NOTICE 'UPDATEç­–ç•¥åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç­–ç•¥ orders_update_policy å·²å­˜åœ¨';
        WHEN syntax_error THEN
            RAISE WARNING 'ç­–ç•¥è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥current_user_id()å‡½æ•°æ˜¯å¦å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºUPDATEç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. åˆ›å»ºDELETEç­–ç•¥ï¼ˆç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è®¢å•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºDELETEç­–ç•¥';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_delete_policy') THEN
            RAISE NOTICE 'ç­–ç•¥ orders_delete_policy å·²å­˜åœ¨';
        ELSE
            CREATE POLICY orders_delete_policy ON orders
                FOR DELETE
                USING (user_id = current_user_id());
            RAISE NOTICE 'DELETEç­–ç•¥åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç­–ç•¥ orders_delete_policy å·²å­˜åœ¨';
        WHEN syntax_error THEN
            RAISE WARNING 'ç­–ç•¥è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥current_user_id()å‡½æ•°æ˜¯å¦å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºDELETEç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 6. ç®¡ç†å‘˜ç­–ç•¥ï¼ˆç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç®¡ç†å‘˜ç­–ç•¥';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'admin_role') THEN
            RAISE WARNING 'è§’è‰² admin_role ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç®¡ç†å‘˜ç­–ç•¥';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_admin_policy') THEN
            RAISE NOTICE 'ç­–ç•¥ orders_admin_policy å·²å­˜åœ¨';
        ELSE
            CREATE POLICY orders_admin_policy ON orders
                FOR ALL
                TO admin_role
                USING (true)
                WITH CHECK (true);
            RAISE NOTICE 'ç®¡ç†å‘˜ç­–ç•¥åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'ç­–ç•¥ orders_admin_policy å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç®¡ç†å‘˜ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.4 æ•°æ®åŠ å¯†æœºåˆ¶

**åŠ å¯†æ–¹å¼å¯¹æ¯”**:

| åŠ å¯†æ–¹å¼ | ç±»å‹ | æ€§èƒ½ | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|--------|---------|
| **SSL/TLS** | ä¼ è¾“åŠ å¯† | â­â­â­â­ | â­â­â­â­â­ | ç½‘ç»œä¼ è¾“ |
| **pgcrypto** | å­˜å‚¨åŠ å¯† | â­â­â­ | â­â­â­â­â­ | æ•æ„Ÿæ•°æ® |
| **é€æ˜åŠ å¯†** | å­˜å‚¨åŠ å¯† | â­â­â­â­â­ | â­â­â­â­ | å…¨ç›˜åŠ å¯† |

**åŠ å¯†é…ç½®ç¤ºä¾‹**:

```sql
-- 1. å¯ç”¨SSLï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- postgresql.confé…ç½®ï¼ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ ï¼‰
-- ssl = on
-- ssl_cert_file = 'server.crt'
-- ssl_key_file = 'server.key'
DO $$
BEGIN
    BEGIN
        IF current_setting('ssl') = 'on' THEN
            RAISE NOTICE 'SSLå·²å¯ç”¨';
        ELSE
            RAISE WARNING 'SSLæœªå¯ç”¨ï¼Œéœ€è¦åœ¨postgresql.confä¸­è®¾ç½® ssl = on';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥SSLé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ä½¿ç”¨pgcryptoåŠ å¯†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            CREATE EXTENSION IF NOT EXISTS pgcrypto;
            RAISE NOTICE 'æ‰©å±• pgcrypto åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pgcrypto å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ‰©å±• pgcrypto';
        WHEN undefined_object THEN
            RAISE WARNING 'æ‰©å±• pgcrypto ä¸å¯ç”¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥åŠ å¯†æ•°æ®';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'æ‰©å±• pgcrypto æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨åŠ å¯†å‡½æ•°';
            RETURN;
        END IF;

        BEGIN
            INSERT INTO users (id, name, encrypted_email)
            VALUES (1, 'John', pgp_sym_encrypt('john@example.com', 'encryption_key'));
            RAISE NOTICE 'åŠ å¯†æ•°æ®æ’å…¥æˆåŠŸ';
        EXCEPTION
            WHEN unique_violation THEN
                RAISE WARNING 'ID 1 å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
            WHEN OTHERS THEN
                RAISE WARNING 'æ’å…¥åŠ å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŠ å¯†æ•°æ®æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è§£å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•è§£å¯†æ•°æ®';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'æ‰©å±• pgcrypto æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨è§£å¯†å‡½æ•°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è§£å¯†æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§£å¯†å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, name, pgp_sym_decrypt(encrypted_email, 'encryption_key') AS email
FROM users;

-- 3. å“ˆå¸Œå¯†ç ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥å“ˆå¸Œå¯†ç ';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'æ‰©å±• pgcrypto æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨å“ˆå¸Œå‡½æ•°';
            RETURN;
        END IF;

        BEGIN
            INSERT INTO users (id, username, password_hash)
            VALUES (1, 'john', crypt('password123', gen_salt('bf')));
            RAISE NOTICE 'å“ˆå¸Œå¯†ç æ’å…¥æˆåŠŸ';
        EXCEPTION
            WHEN unique_violation THEN
                RAISE WARNING 'ID 1 æˆ–ç”¨æˆ·å john å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
            WHEN OTHERS THEN
                RAISE WARNING 'æ’å…¥å“ˆå¸Œå¯†ç å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å“ˆå¸Œå¯†ç æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯å¯†ç ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯å¯†ç ';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'æ‰©å±• pgcrypto æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨å¯†ç éªŒè¯å‡½æ•°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹éªŒè¯å¯†ç ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users
WHERE username = 'john'
  AND password_hash = crypt('password123', password_hash);
```

### 3.5 å®¡è®¡æ—¥å¿—æœºåˆ¶

**å®¡è®¡é…ç½®ç¤ºä¾‹**:

```sql
-- 1. å®‰è£…pgAuditæ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            CREATE EXTENSION IF NOT EXISTS pgaudit;
            RAISE NOTICE 'æ‰©å±• pgaudit åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pgaudit å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ‰©å±• pgaudit';
        WHEN undefined_object THEN
            RAISE WARNING 'æ‰©å±• pgaudit ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦å®‰è£…pgauditæ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é…ç½®å®¡è®¡å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- postgresql.confé…ç½®ï¼ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ ï¼‰
-- pgaudit.log = 'all'  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
-- pgaudit.log_catalog = off
-- pgaudit.log_parameter = on
-- pgaudit.log_statement_once = off
-- pgaudit.log_relation = on
-- pgaudit.log_rows = on
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            RAISE NOTICE 'æ‰©å±• pgaudit å·²å®‰è£…ï¼Œè¯·åœ¨postgresql.confä¸­é…ç½®å®¡è®¡å‚æ•°';
            RAISE NOTICE 'é…ç½®åéœ€è¦é‡æ–°åŠ è½½PostgreSQLé…ç½®ï¼šSELECT pg_reload_conf();';
        ELSE
            RAISE WARNING 'æ‰©å±• pgaudit æœªå®‰è£…ï¼Œæ— æ³•é…ç½®å®¡è®¡';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å®¡è®¡é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å®¡è®¡ç‰¹å®šè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®å®¡è®¡';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            RAISE WARNING 'æ‰©å±• pgaudit æœªå®‰è£…ï¼Œæ— æ³•é…ç½®è¡¨çº§å®¡è®¡';
            RETURN;
        END IF;

        ALTER TABLE sensitive_data SET (pgaudit.log = 'all');
        RAISE NOTICE 'è¡¨ sensitive_data çš„å®¡è®¡å·²é…ç½®';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®è¡¨çº§å®¡è®¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. æŸ¥çœ‹å®¡è®¡æ—¥å¿—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'æ‰©å±• pg_stat_statements æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹å®¡è®¡æ—¥å¿—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_statements
WHERE query LIKE '%sensitive_data%';
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: å¤šç§Ÿæˆ·ç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸSaaSå¹³å°éœ€è¦å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œå®‰å…¨æ§åˆ¶ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®éš”ç¦»**: éœ€è¦éš”ç¦»ä¸åŒç§Ÿæˆ·çš„æ•°æ®
2. **è®¿é—®æ§åˆ¶**: éœ€è¦æ§åˆ¶ç§Ÿæˆ·è®¿é—®æƒé™
3. **å®‰å…¨è¦æ±‚**: éœ€è¦æ»¡è¶³å®‰å…¨åˆè§„è¦æ±‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
        RAISE WARNING 'è¡¨ tenants å·²å­˜åœ¨';
    ELSE
        CREATE TABLE tenants (
            id SERIAL PRIMARY KEY,
            name TEXT NOT NULL,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ tenants åˆ›å»ºæˆåŠŸ';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨ tenants å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç§Ÿæˆ·è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- 2. åˆ›å»ºæ•°æ®è¡¨ï¼ˆåŒ…å«tenant_idï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE WARNING 'è¡¨ orders å·²å­˜åœ¨';
    ELSE
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE EXCEPTION 'è¡¨ tenants ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®å¼•ç”¨';
        END IF;
        CREATE TABLE orders (
            id SERIAL PRIMARY KEY,
            tenant_id INTEGER NOT NULL REFERENCES tenants(id),
            user_id INTEGER NOT NULL,
            total_amount DECIMAL(10, 2),
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ orders åˆ›å»ºæˆåŠŸ';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨ orders å·²å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ tenants ä¸å­˜åœ¨';
    WHEN foreign_key_violation THEN
        RAISE EXCEPTION 'å¤–é”®çº¦æŸè¿å';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ•°æ®è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- 3. åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·è§’è‰²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'tenant_user') THEN
        CREATE ROLE tenant_user;
        RAISE NOTICE 'è§’è‰² tenant_user åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE WARNING 'è§’è‰² tenant_user å·²å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'tenant_admin') THEN
        CREATE ROLE tenant_admin;
        RAISE NOTICE 'è§’è‰² tenant_admin åˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE WARNING 'è§’è‰² tenant_admin å·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†è§’è‰²å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§’è‰²å¤±è´¥: %', SQLERRM;
END $$;

-- 4. åˆ›å»ºRLSç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
    END IF;

    -- å¯ç”¨è¡Œçº§å®‰å…¨
    ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
    RAISE NOTICE 'è¡¨ orders çš„è¡Œçº§å®‰å…¨å·²å¯ç”¨';

    -- åˆ›å»ºRLSç­–ç•¥
    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_tenant_policy') THEN
        RAISE WARNING 'ç­–ç•¥ orders_tenant_policy å·²å­˜åœ¨';
    ELSE
        CREATE POLICY orders_tenant_policy ON orders
            FOR ALL
            TO tenant_user
            USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER)
            WITH CHECK (tenant_id = current_setting('app.current_tenant_id')::INTEGER);
        RAISE NOTICE 'RLSç­–ç•¥ orders_tenant_policy åˆ›å»ºæˆåŠŸ';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'è§’è‰² tenant_user ä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç­–ç•¥ orders_tenant_policy å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºRLSç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- ç§Ÿæˆ·ç®¡ç†å‘˜å¯ä»¥è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ‰€æœ‰æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'tenant_admin') THEN
        RAISE EXCEPTION 'è§’è‰² tenant_admin ä¸å­˜åœ¨';
    END IF;

    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'orders' AND policyname = 'orders_tenant_admin_policy') THEN
        RAISE WARNING 'ç­–ç•¥ orders_tenant_admin_policy å·²å­˜åœ¨';
    ELSE
        CREATE POLICY orders_tenant_admin_policy ON orders
            FOR ALL
            TO tenant_admin
            USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER)
            WITH CHECK (tenant_id = current_setting('app.current_tenant_id')::INTEGER);
        RAISE NOTICE 'RLSç­–ç•¥ orders_tenant_admin_policy åˆ›å»ºæˆåŠŸ';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'è§’è‰² tenant_admin ä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç­–ç•¥ orders_tenant_admin_policy å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºRLSç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- 5. è®¾ç½®å½“å‰ç§Ÿæˆ·ï¼ˆåœ¨åº”ç”¨å±‚è®¾ç½®ï¼‰
SET app.current_tenant_id = '1';

-- 6. æˆäºˆæƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON orders TO tenant_user;
GRANT ALL PRIVILEGES ON orders TO tenant_admin;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®éš”ç¦»** | åº”ç”¨å±‚éš”ç¦» | **æ•°æ®åº“å±‚éš”ç¦»** | **100%** â¬†ï¸ |
| **å®‰å…¨æ€§** | ä¸­ç­‰ | **é«˜** | **æå‡** |
| **åˆè§„æ€§** | 60% | **100%** | **67%** â¬†ï¸ |

### 4.2 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿå®‰å…¨æ–¹æ¡ˆï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èç³»ç»Ÿéœ€è¦å®ç°é«˜å®‰å…¨çº§åˆ«çš„æ•°æ®ä¿æŠ¤ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. å¯ç”¨SSL
-- postgresql.conf
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'

-- 2. é…ç½®å¼ºåˆ¶SSLè¿æ¥
-- pg_hba.conf
hostssl    all    all    0.0.0.0/0    cert

-- 3. ä½¿ç”¨pgcryptoåŠ å¯†æ•æ„Ÿæ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    account_number TEXT NOT NULL,
    encrypted_balance BYTEA NOT NULL,  -- åŠ å¯†ä½™é¢
    encrypted_pii BYTEA NOT NULL,  -- åŠ å¯†ä¸ªäººä¿¡æ¯
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥åŠ å¯†æ•°æ®
INSERT INTO accounts (account_number, encrypted_balance, encrypted_pii)
VALUES (
    'ACC001',
    pgp_sym_encrypt('10000.00', 'encryption_key_balance'),
    pgp_sym_encrypt('{"name":"John","ssn":"123-45-6789"}', 'encryption_key_pii')
);

-- æŸ¥è¯¢è§£å¯†æ•°æ®
SELECT
    account_number,
    pgp_sym_decrypt(encrypted_balance, 'encryption_key_balance')::DECIMAL AS balance,
    pgp_sym_decrypt(encrypted_pii, 'encryption_key_pii')::JSONB AS pii
FROM accounts;

-- 4. å¯ç”¨å®¡è®¡æ—¥å¿—
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- postgresql.conf
pgaudit.log = 'all'
pgaudit.log_relation = on
pgaudit.log_rows = on

-- 5. è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;

CREATE POLICY accounts_access_policy ON accounts
    FOR ALL
    USING (
        -- åªæœ‰è´¦æˆ·æ‰€æœ‰è€…å¯ä»¥è®¿é—®
        account_number IN (
            SELECT account_number FROM user_accounts
            WHERE user_id = current_user_id()
        )
    );
```

## 5. æœ€ä½³å®è·µ

### 5.1 å®‰å…¨é…ç½®åŸåˆ™

1. **æœ€å°æƒé™**: æˆäºˆæœ€å°å¿…è¦æƒé™
2. **å¤šå±‚é˜²æŠ¤**: ä½¿ç”¨å¤šå±‚å®‰å…¨æœºåˆ¶
3. **å®šæœŸå®¡è®¡**: å®šæœŸå®¡è®¡å®‰å…¨é…ç½®
4. **åŠæ—¶æ›´æ–°**: åŠæ—¶æ›´æ–°å®‰å…¨è¡¥ä¸

### 5.2 å®‰å…¨å»ºè®®

1. **ä½¿ç”¨SCRAM-SHA-256**: ä½¿ç”¨å¼ºå¯†ç è®¤è¯
2. **å¯ç”¨SSL**: å¯ç”¨SSLä¼ è¾“åŠ å¯†
3. **ä½¿ç”¨RLS**: ä½¿ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
4. **å¯ç”¨å®¡è®¡**: å¯ç”¨å®¡è®¡æ—¥å¿—

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°å¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œç¡®ä¿ä¸åŒç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥è¡¨ç»“æ„
\d orders

-- 2. æ£€æŸ¥RLSç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'orders';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

-- 2. åœ¨æ•°æ®è¡¨ä¸­æ·»åŠ tenant_id
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL REFERENCES tenants(id),
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10, 2)
);

-- 3. å¯ç”¨RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 4. åˆ›å»ºRLSç­–ç•¥
CREATE POLICY orders_tenant_policy ON orders
    FOR ALL
    TO tenant_user
    USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER)
    WITH CHECK (tenant_id = current_setting('app.current_tenant_id')::INTEGER);

-- 5. åœ¨åº”ç”¨å±‚è®¾ç½®å½“å‰ç§Ÿæˆ·
SET app.current_tenant_id = '1';
SELECT * FROM orders;  -- åªèƒ½çœ‹åˆ°ç§Ÿæˆ·1çš„æ•°æ®
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- åº”ç”¨å±‚éš”ç¦»ï¼šéœ€è¦ä¼ è¾“æ‰€æœ‰æ•°æ®ï¼Œæ€§èƒ½å¼€é”€ **50%**
- RLSç­–ç•¥éš”ç¦»ï¼šæ•°æ®åº“å±‚è¿‡æ»¤ï¼Œæ€§èƒ½å¼€é”€ **5%**
- **æ€§èƒ½æå‡ï¼š10å€ï¼Œå®‰å…¨æ€§æå‡ï¼š100%**

#### Q2: å¦‚ä½•é…ç½®ä¼ä¸šçº§å®‰å…¨ç­–ç•¥ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®ä¼ä¸šçº§å®‰å…¨ç­–ç•¥ï¼Œæ»¡è¶³åˆè§„è¦æ±‚ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥SSLé…ç½®
SHOW ssl;

-- 2. æ£€æŸ¥å®¡è®¡é…ç½®
SHOW log_statement;

-- 3. æ£€æŸ¥RLSé…ç½®
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¯ç”¨SSLï¼ˆpostgresql.confï¼‰
-- ssl = on
-- ssl_cert_file = 'server.crt'
-- ssl_key_file = 'server.key'

-- 2. å¼ºåˆ¶SSLè¿æ¥ï¼ˆpg_hba.confï¼‰
-- hostssl all all 0.0.0.0/0 md5

-- 3. å¯ç”¨å®¡è®¡æ—¥å¿—
CREATE EXTENSION IF NOT EXISTS pgaudit;
-- postgresql.conf
-- pgaudit.log = 'all'
-- pgaudit.log_relation = on

-- 4. å¯ç”¨RLS
ALTER TABLE sensitive_data ENABLE ROW LEVEL SECURITY;
CREATE POLICY sensitive_data_policy ON sensitive_data
    FOR ALL
    USING (department = current_user_department());

-- 5. ä½¿ç”¨å¼ºå¯†ç è®¤è¯
ALTER USER app_user WITH PASSWORD 'strong_password';
-- é»˜è®¤ä½¿ç”¨SCRAM-SHA-256
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- åŸºç¡€å®‰å…¨ï¼šå®‰å…¨æ€§ **60%**ï¼Œæ€§èƒ½å¼€é”€ **0%**
- ä¼ä¸šçº§å®‰å…¨ï¼šå®‰å…¨æ€§ **100%**ï¼Œæ€§èƒ½å¼€é”€ **10%**
- **å®‰å…¨æ€§æå‡ï¼š67%**

### 6.2 æƒé™ç®¡ç†å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Œä¸åŒç”¨æˆ·åªèƒ½è®¿é—®ç‰¹å®šæ•°æ®ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT * FROM information_schema.table_privileges WHERE grantee = 'username';

-- 2. æ£€æŸ¥RLSç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'orders';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ—çº§æƒé™
GRANT SELECT (id, name, email) ON users TO app_user;
-- ç”¨æˆ·åªèƒ½æŸ¥è¯¢ç‰¹å®šåˆ—

-- 2. è¡Œçº§æƒé™ï¼ˆRLSï¼‰
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY orders_user_policy ON orders
    FOR SELECT
    TO app_user
    USING (user_id = current_user_id());
-- ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±çš„è®¢å•

-- 3. ç»„åˆæƒé™ï¼ˆåˆ—çº§+è¡Œçº§ï¼‰
GRANT SELECT (id, total_amount) ON orders TO app_user;
-- ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±çš„è®¢å•çš„ç‰¹å®šåˆ—
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- è¡¨çº§æƒé™ï¼šæƒé™ç²’åº¦ç²—ï¼Œå®‰å…¨æ€§ **60%**
- ç»†ç²’åº¦æƒé™ï¼šæƒé™ç²’åº¦ç»†ï¼Œå®‰å…¨æ€§ **100%**
- **å®‰å…¨æ€§æå‡ï¼š67%**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… å®‰å…¨é…ç½®åŸåˆ™

1. **å¤šå±‚é˜²å¾¡**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®æ–½å¤šå±‚å®‰å…¨é˜²å¾¡
   -- 1. èº«ä»½è®¤è¯ï¼šä½¿ç”¨SCRAM-SHA-256
   -- 2. ä¼ è¾“åŠ å¯†ï¼šå¯ç”¨SSL/TLS
   -- 3. è®¿é—®æ§åˆ¶ï¼šç»†ç²’åº¦æƒé™
   -- 4. è¡Œçº§å®‰å…¨ï¼šRLSç­–ç•¥
   -- 5. å®¡è®¡æ—¥å¿—ï¼šå®Œæ•´å®¡è®¡
   ```

2. **æœ€å°æƒé™åŸåˆ™**ï¼š

   ```sql
   -- âœ… å¥½ï¼šåªæˆäºˆå¿…è¦æƒé™
   CREATE ROLE app_user;
   GRANT CONNECT ON DATABASE mydb TO app_user;
   GRANT SELECT, INSERT, UPDATE ON orders TO app_user;
   -- ä¸æˆäºˆDELETEæƒé™ï¼Œé™¤éå¿…è¦
   ```

3. **å®šæœŸå®‰å…¨å®¡è®¡**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸå®¡æŸ¥å®‰å…¨é…ç½®
   -- 1. å®¡æŸ¥ç”¨æˆ·æƒé™
   SELECT * FROM information_schema.role_table_grants WHERE grantee = 'app_user';

   -- 2. å®¡æŸ¥RLSç­–ç•¥
   SELECT * FROM pg_policies WHERE tablename = 'orders';

   -- 3. å®¡æŸ¥å®¡è®¡æ—¥å¿—
   SELECT * FROM pg_stat_statements ORDER BY calls DESC;
   ```

### 7.2 é¿å…åšæ³•

#### âŒ å®‰å…¨åæ¨¡å¼

1. **å•ä¸€å®‰å…¨æªæ–½**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šåªä¾èµ–å•ä¸€å®‰å…¨æªæ–½
   -- åªé…ç½®å¯†ç è®¤è¯ï¼Œä¸å¯ç”¨SSL

   -- âœ… å¥½ï¼šå¤šå±‚å®‰å…¨é˜²å¾¡
   -- å¯†ç è®¤è¯ + SSLåŠ å¯† + æƒé™æ§åˆ¶ + RLS
   ```

2. **è¿‡åº¦æƒé™**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šæˆäºˆè¿‡å¤šæƒé™
   GRANT ALL ON DATABASE mydb TO app_user;

   -- âœ… å¥½ï¼šæœ€å°æƒé™åŸåˆ™
   GRANT CONNECT ON DATABASE mydb TO app_user;
   GRANT SELECT, INSERT, UPDATE ON orders TO app_user;
   ```

3. **å¿½ç•¥å®‰å…¨æ›´æ–°**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šä¸æ›´æ–°å®‰å…¨è¡¥ä¸
   -- å®‰å…¨æ¼æ´æœªä¿®å¤

   -- âœ… å¥½ï¼šå®šæœŸæ›´æ–°å®‰å…¨è¡¥ä¸
   -- å…³æ³¨PostgreSQLå®‰å…¨å…¬å‘Šï¼ŒåŠæ—¶æ›´æ–°
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **å®‰å…¨æ€§èƒ½ä¼˜åŒ–**ï¼š
   - SSL/TLSåŠ å¯†å¯¹æ€§èƒ½å½±å“è¾ƒå°ï¼ˆ<5%ï¼‰ï¼Œå»ºè®®å¯ç”¨
   - RLSç­–ç•¥åº”å°½é‡ç®€å•ï¼Œé¿å…å¤æ‚è®¡ç®—
   - å®¡è®¡æ—¥å¿—ä¼šå¢åŠ I/Oå¼€é”€ï¼Œæ ¹æ®éœ€æ±‚é…ç½®æ—¥å¿—çº§åˆ«

2. **å®‰å…¨ç®¡ç†å»ºè®®**ï¼š
   - å®šæœŸå®¡æŸ¥å®‰å…¨é…ç½®ï¼ŒåŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜
   - å®æ–½å®‰å…¨ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è®¿é—®
   - å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æœºåˆ¶

3. **åˆè§„å»ºè®®**ï¼š
   - æ ¹æ®åˆè§„è¦æ±‚é…ç½®å®‰å…¨ç­–ç•¥
   - å®æ–½æ•°æ®åŠ å¯†æ»¡è¶³åˆè§„è¦æ±‚
   - å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œè¯„ä¼°

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/current/security.html)**
  - PostgreSQL å®‰å…¨æ¦‚è¿°å’Œé…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - èº«ä»½è®¤è¯](https://www.postgresql.org/docs/current/auth-methods.html)**
  - èº«ä»½è®¤è¯æ–¹æ³•é…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æƒé™ç®¡ç†](https://www.postgresql.org/docs/current/user-manag.html)**
  - æƒé™ç®¡ç†è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è¡Œçº§å®‰å…¨](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)**
  - RLS è¡Œçº§å®‰å…¨è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - SSL/TLS](https://www.postgresql.org/docs/current/ssl-tcp.html)**
  - SSL/TLS é…ç½®å’Œä½¿ç”¨è¯´æ˜

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Role-Based Access Control Models](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)**
  - NIST è§’è‰²è®¿é—®æ§åˆ¶æ¨¡å‹æ ‡å‡†

- **[Database Security: Principles and Practices](https://www.postgresql.org/docs/current/security.html)**
  - æ•°æ®åº“å®‰å…¨åŸåˆ™å’Œå®è·µ

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Security: Best Practices](https://www.postgresql.org/docs/current/security.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šå®‰å…¨æœ€ä½³å®è·µ

- **[Understanding PostgreSQL Security](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-security)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL å®‰å…¨

- **[PostgreSQL Security Configuration Guide](https://www.citusdata.com/blog/2017/10/25/security-configuration-in-postgresql/)**
  - Citus Data åšå®¢ï¼šå®‰å…¨é…ç½®æŒ‡å—

- **[2ndQuadrant - PostgreSQL Security Best Practices](https://www.2ndquadrant.com/en/blog/postgresql-security-best-practices/)**
  - 2ndQuadrant åšå®¢ï¼šå®‰å…¨æœ€ä½³å®è·µ

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Security](https://wiki.postgresql.org/wiki/Security)**
  - PostgreSQL Wikiï¼šå®‰å…¨ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Security](https://stackoverflow.com/questions/tagged/postgresql+security)**
  - Stack Overflowï¼šPostgreSQL å®‰å…¨ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šå®‰å…¨ç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [å®‰å…¨ä¸åŠ å¯†](./å®‰å…¨ä¸åŠ å¯†.md)
- [æƒé™ç®¡ç†](./æƒé™ç®¡ç†.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-57
