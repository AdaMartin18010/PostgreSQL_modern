---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\07-å®‰å…¨ä¸åˆè§„\07.05-æ•°æ®åº“å®¡è®¡ä¸åˆè§„-å®Œæ•´æ€§çº¦æŸä¸å®¡è®¡è½¨è¿¹çš„å½¢å¼åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ•°æ®åº“å®¡è®¡ä¸åˆè§„-å®Œæ•´æ€§çº¦æŸä¸å®¡è®¡è½¨è¿¹çš„å½¢å¼åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“å®¡è®¡ä¸åˆè§„-å®Œæ•´æ€§çº¦æŸä¸å®¡è®¡è½¨è¿¹çš„å½¢å¼åŒ–](#æ•°æ®åº“å®¡è®¡ä¸åˆè§„-å®Œæ•´æ€§çº¦æŸä¸å®¡è®¡è½¨è¿¹çš„å½¢å¼åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æ•°æ®åº“å®¡è®¡ä¸åˆè§„å·¥ä½œåŸç†æ¦‚è¿°](#10-æ•°æ®åº“å®¡è®¡ä¸åˆè§„å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 å®¡è®¡è½¨è¿¹](#21-å®¡è®¡è½¨è¿¹)
    - [2.2 å®Œæ•´æ€§çº¦æŸ](#22-å®Œæ•´æ€§çº¦æŸ)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å®¡è®¡è½¨è¿¹å½¢å¼åŒ–](#31-å®¡è®¡è½¨è¿¹å½¢å¼åŒ–)
    - [3.2 å®Œæ•´æ€§çº¦æŸå½¢å¼åŒ–](#32-å®Œæ•´æ€§çº¦æŸå½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 å®¡è®¡è½¨è¿¹å®Œæ•´æ€§å®šç†](#41-å®¡è®¡è½¨è¿¹å®Œæ•´æ€§å®šç†)
    - [4.2 å®Œæ•´æ€§çº¦æŸæ­£ç¡®æ€§å®šç†](#42-å®Œæ•´æ€§çº¦æŸæ­£ç¡®æ€§å®šç†)
    - [4.3 å®¡è®¡è½¨è¿¹ä¸å¯ç¯¡æ”¹æ€§å®šç†](#43-å®¡è®¡è½¨è¿¹ä¸å¯ç¯¡æ”¹æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18 å®¡è®¡ä¸åˆè§„å®ç°è¯¦è§£](#51-postgresql-18-å®¡è®¡ä¸åˆè§„å®ç°è¯¦è§£)
    - [5.2 SQLite 3.45 å®¡è®¡ä¸åˆè§„å¯¹æ¯”](#52-sqlite-345-å®¡è®¡ä¸åˆè§„å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„å®¡è®¡ä¸åˆè§„](#åœºæ™¯1é‡‘èç³»ç»Ÿçš„å®¡è®¡ä¸åˆè§„)
      - [åœºæ™¯2ï¼šåŒ»ç–—ç³»ç»Ÿçš„HIPAAåˆè§„å®¡è®¡](#åœºæ™¯2åŒ»ç–—ç³»ç»Ÿçš„hipaaåˆè§„å®¡è®¡)
    - [5.4 å®¡è®¡ä¸åˆè§„ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ](#54-å®¡è®¡ä¸åˆè§„ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ)
    - [5.5 æ¨¡å‹é€‰æ‹©å»ºè®®](#55-æ¨¡å‹é€‰æ‹©å»ºè®®)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#61-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [6.2 PostgreSQLå®ç°ç›¸å…³](#62-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æ•°æ®åº“å®¡è®¡ä¸åˆè§„å·¥ä½œåŸç†æ¦‚è¿°

**å®¡è®¡ä¸åˆè§„**ï¼š

æ•°æ®åº“å®¡è®¡è®°å½•æ‰€æœ‰æ•°æ®è®¿é—®å’Œä¿®æ”¹æ“ä½œï¼Œç¡®ä¿åˆè§„æ€§å’Œå¯è¿½æº¯æ€§ã€‚

**å®¡è®¡æ¨¡å‹æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((å®¡è®¡åˆè§„))
    å®¡è®¡è½¨è¿¹
      æ“ä½œè®°å½•
      æ—¶é—´æˆ³
      ç”¨æˆ·æ ‡è¯†
    å®Œæ•´æ€§çº¦æŸ
      å®ä½“å®Œæ•´æ€§
      å‚ç…§å®Œæ•´æ€§
      ç”¨æˆ·å®šä¹‰å®Œæ•´æ€§
    åˆè§„æ€§
      GDPRåˆè§„
      SOXåˆè§„
      HIPAAåˆè§„
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **å®¡è®¡è½¨è¿¹**ï¼šæ“ä½œè®°å½•å’Œå®¡è®¡æ—¥å¿—
- **å®Œæ•´æ€§çº¦æŸ**ï¼šçº¦æŸçš„å½¢å¼åŒ–å®šä¹‰
- **åˆè§„æ€§**ï¼šæ³•è§„åˆè§„çš„å®ç°
- **å®é™…åº”ç”¨**ï¼šPostgreSQLå®¡è®¡å®ç°

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 å®¡è®¡è½¨è¿¹

**å®¡è®¡è®°å½•**ï¼š

```haskell
-- å®¡è®¡è®°å½•
data AuditRecord = AuditRecord {
    timestamp :: Timestamp,
    user :: User,
    action :: Action,
    object :: Object,
    result :: Result
}
```

### 2.2 å®Œæ•´æ€§çº¦æŸ

**çº¦æŸç±»å‹**ï¼š

| ç±»å‹ | å®šä¹‰ | æ£€æŸ¥æ—¶æœº | ç¤ºä¾‹ |
|------|------|---------|------|
| **å®ä½“å®Œæ•´æ€§** | ä¸»é”®å”¯ä¸€ | æ’å…¥/æ›´æ–° | PRIMARY KEY |
| **å‚ç…§å®Œæ•´æ€§** | å¤–é”®çº¦æŸ | æ’å…¥/æ›´æ–°/åˆ é™¤ | FOREIGN KEY |
| **ç”¨æˆ·å®šä¹‰** | è‡ªå®šä¹‰è§„åˆ™ | æ’å…¥/æ›´æ–° | CHECKçº¦æŸ |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å®¡è®¡è½¨è¿¹å½¢å¼åŒ–

**å®¡è®¡è½¨è¿¹**ï¼š

```haskell
-- å®¡è®¡è½¨è¿¹å½¢å¼åŒ–
AuditTrail = [AuditRecord]
where
    AuditRecord = (t, u, a, o, r)
```

### 3.2 å®Œæ•´æ€§çº¦æŸå½¢å¼åŒ–

**å®Œæ•´æ€§çº¦æŸ**ï¼š

```haskell
-- å®Œæ•´æ€§çº¦æŸå½¢å¼åŒ–
IntegrityConstraint = (type, condition, check_time)
where
    type = PrimaryKey | ForeignKey | Check | Unique
    condition: State â†’ Bool
    check_time = Before | After | Deferred
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 å®¡è®¡è½¨è¿¹å®Œæ•´æ€§å®šç†

**å®šç†**ï¼šå¦‚æœå®¡è®¡ç³»ç»Ÿæ­£ç¡®å®ç°ï¼Œåˆ™æ‰€æœ‰æ•°æ®æ“ä½œéƒ½ä¼šè¢«è®°å½•åœ¨å®¡è®¡è½¨è¿¹ä¸­ï¼Œä¸”å®¡è®¡è½¨è¿¹æ˜¯å®Œæ•´çš„å’Œä¸å¯ç¯¡æ”¹çš„ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾å®¡è®¡ç³»ç»ŸA = (record, verify, store)ï¼Œå¯¹äºä»»æ„æ•°æ®æ“ä½œopï¼Œå¦‚æœopè¢«æ‰§è¡Œï¼Œåˆ™å­˜åœ¨å®¡è®¡è®°å½•r âˆˆ AuditTrailï¼Œä½¿å¾—r.action = opï¼Œä¸”ræ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šå®¡è®¡è®°å½•å®šä¹‰**:

- å¯¹äºä»»æ„æ•°æ®æ“ä½œopï¼Œå®¡è®¡ç³»ç»Ÿåœ¨æ“ä½œæ‰§è¡Œæ—¶åˆ›å»ºå®¡è®¡è®°å½•r = (timestamp, user, op, object, result)
- å®¡è®¡è®°å½•åŒ…å«æ“ä½œçš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯

**æ­¥éª¤2ï¼šå®Œæ•´æ€§ä¿è¯**:

- å®¡è®¡ç³»ç»Ÿåœ¨æ“ä½œæ‰§è¡Œå‰æˆ–æ‰§è¡Œåç«‹å³è®°å½•æ“ä½œ
- å¦‚æœæ“ä½œè¢«æ‰§è¡Œï¼Œåˆ™å®¡è®¡è®°å½•è¢«åˆ›å»º
- å› æ­¤ï¼Œæ‰€æœ‰æ‰§è¡Œçš„æ“ä½œéƒ½æœ‰å¯¹åº”çš„å®¡è®¡è®°å½•

**æ­¥éª¤3ï¼šä¸å¯ç¯¡æ”¹æ€§**:

- å®¡è®¡è®°å½•å­˜å‚¨åœ¨åªè¿½åŠ ï¼ˆappend-onlyï¼‰çš„å­˜å‚¨ä¸­
- å®¡è®¡è®°å½•ä½¿ç”¨æ•°å­—ç­¾åæˆ–å“ˆå¸Œé“¾ä¿æŠ¤
- ä¿®æ”¹å®¡è®¡è®°å½•ä¼šç ´åç­¾åæˆ–å“ˆå¸Œé“¾
- å› æ­¤ï¼Œå®¡è®¡è®°å½•æ˜¯ä¸å¯ç¯¡æ”¹çš„

**æ­¥éª¤4ï¼šå¯è¿½æº¯æ€§**:

- å®¡è®¡è½¨è¿¹åŒ…å«æ—¶é—´æˆ³ã€ç”¨æˆ·æ ‡è¯†ç­‰ä¿¡æ¯
- å¯ä»¥é€šè¿‡å®¡è®¡è½¨è¿¹è¿½æº¯æ‰€æœ‰æ“ä½œ
- å› æ­¤ï¼Œå®¡è®¡è½¨è¿¹æä¾›å®Œæ•´çš„å¯è¿½æº¯æ€§

**æ­¥éª¤5ï¼šç»“è®º**:

- å¦‚æœå®¡è®¡ç³»ç»Ÿæ­£ç¡®å®ç°ï¼Œåˆ™æ‰€æœ‰æ•°æ®æ“ä½œéƒ½ä¼šè¢«è®°å½•
- å®¡è®¡è½¨è¿¹æ˜¯å®Œæ•´çš„å’Œä¸å¯ç¯¡æ”¹çš„
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å®¡è®¡è½¨è¿¹å®Œæ•´æ€§] --> B[å®¡è®¡è®°å½•å®šä¹‰]
    B --> C[å®Œæ•´æ€§ä¿è¯]
    C --> D[ä¸å¯ç¯¡æ”¹æ€§]
    D --> E[å¯è¿½æº¯æ€§]
    E --> F[å®¡è®¡è½¨è¿¹å®Œæ•´]

    style A fill:#FFD700
    style F fill:#90EE90
```

### 4.2 å®Œæ•´æ€§çº¦æŸæ­£ç¡®æ€§å®šç†

**å®šç†**ï¼šå¦‚æœå®Œæ•´æ€§çº¦æŸåœ¨äº‹åŠ¡æäº¤å‰è¢«æ£€æŸ¥ï¼Œåˆ™æ•°æ®åº“çŠ¶æ€å§‹ç»ˆæ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æ•°æ®åº“çŠ¶æ€Dï¼Œå®Œæ•´æ€§çº¦æŸé›†åˆC = {câ‚, câ‚‚, ..., câ‚™}ã€‚å¦‚æœå¯¹äºä»»æ„äº‹åŠ¡Tï¼Œåœ¨Tæäº¤å‰æ£€æŸ¥æ‰€æœ‰çº¦æŸcáµ¢ âˆˆ Cï¼Œä¸”æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œåˆ™æäº¤åçš„æ•°æ®åº“çŠ¶æ€D'æ»¡è¶³æ‰€æœ‰çº¦æŸcáµ¢ âˆˆ Cã€‚

**è¯æ˜**ï¼ˆå½’çº³æ³•ï¼‰ï¼š

**æ­¥éª¤1ï¼šåŸºç¡€æƒ…å†µï¼ˆåˆå§‹çŠ¶æ€ï¼‰**:

- åˆå§‹æ•°æ®åº“çŠ¶æ€Dâ‚€æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸ
- è¿™æ˜¯æ•°æ®åº“åˆå§‹åŒ–çš„è¦æ±‚

**æ­¥éª¤2ï¼šå½’çº³å‡è®¾**:

- å‡è®¾åœ¨äº‹åŠ¡Táµ¢æäº¤å‰ï¼Œæ•°æ®åº“çŠ¶æ€Dáµ¢æ»¡è¶³æ‰€æœ‰çº¦æŸ
- äº‹åŠ¡Táµ¢æ‰§è¡Œæ“ä½œï¼Œäº§ç”Ÿæ–°çŠ¶æ€Dáµ¢'

**æ­¥éª¤3ï¼šçº¦æŸæ£€æŸ¥**:

- åœ¨Táµ¢æäº¤å‰ï¼Œæ£€æŸ¥æ‰€æœ‰çº¦æŸcáµ¢ âˆˆ C
- å¦‚æœæ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œåˆ™Dáµ¢'æ»¡è¶³æ‰€æœ‰çº¦æŸ

**æ­¥éª¤4ï¼šäº‹åŠ¡æäº¤**:

- å¦‚æœæ‰€æœ‰çº¦æŸæ£€æŸ¥é€šè¿‡ï¼Œåˆ™æäº¤äº‹åŠ¡Táµ¢
- æäº¤åçš„çŠ¶æ€Dáµ¢'æ»¡è¶³æ‰€æœ‰çº¦æŸ

**æ­¥éª¤5ï¼šç»“è®º**:

- å¯¹äºæ‰€æœ‰äº‹åŠ¡ï¼Œå¦‚æœçº¦æŸæ£€æŸ¥é€šè¿‡ï¼Œåˆ™æäº¤åçš„çŠ¶æ€æ»¡è¶³æ‰€æœ‰çº¦æŸ
- å› æ­¤ï¼Œæ•°æ®åº“çŠ¶æ€å§‹ç»ˆæ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸ
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å®Œæ•´æ€§çº¦æŸæ­£ç¡®æ€§] --> B[åŸºç¡€æƒ…å†µ]
    B --> C[å½’çº³å‡è®¾]
    C --> D[çº¦æŸæ£€æŸ¥]
    D --> E[äº‹åŠ¡æäº¤]
    E --> F[çŠ¶æ€æ»¡è¶³çº¦æŸ]

    style A fill:#FFD700
    style F fill:#90EE90
```

### 4.3 å®¡è®¡è½¨è¿¹ä¸å¯ç¯¡æ”¹æ€§å®šç†

**å®šç†**ï¼šå¦‚æœå®¡è®¡è½¨è¿¹ä½¿ç”¨æ•°å­—ç­¾åæˆ–å“ˆå¸Œé“¾ä¿æŠ¤ï¼Œåˆ™å®¡è®¡è½¨è¿¹æ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾å®¡è®¡è½¨è¿¹T = [râ‚, râ‚‚, ..., râ‚™]ï¼Œå…¶ä¸­æ¯ä¸ªè®°å½•ráµ¢ä½¿ç”¨æ•°å­—ç­¾åæˆ–å“ˆå¸Œé“¾ä¿æŠ¤ã€‚å¦‚æœæ”»å‡»è€…è¯•å›¾ä¿®æ”¹è®°å½•ráµ¢ï¼Œåˆ™ç­¾åéªŒè¯æˆ–å“ˆå¸Œé“¾éªŒè¯ä¼šå¤±è´¥ã€‚

**è¯æ˜**ï¼ˆå¯†ç å­¦å®‰å…¨æ€§ï¼‰ï¼š

**æ­¥éª¤1ï¼šæ•°å­—ç­¾åä¿æŠ¤**:

- æ¯ä¸ªå®¡è®¡è®°å½•ráµ¢ä½¿ç”¨ç§é’¥ç­¾åï¼šsigáµ¢ = Sign(sk, ráµ¢)
- éªŒè¯æ—¶ä½¿ç”¨å…¬é’¥ï¼šVerify(pk, ráµ¢, sigáµ¢)
- å¦‚æœráµ¢è¢«ä¿®æ”¹ï¼Œåˆ™ç­¾åéªŒè¯å¤±è´¥

**æ­¥éª¤2ï¼šå“ˆå¸Œé“¾ä¿æŠ¤**:

- å®¡è®¡è®°å½•ä½¿ç”¨å“ˆå¸Œé“¾ï¼šháµ¢ = Hash(ráµ¢ || háµ¢â‚‹â‚)
- æ¯ä¸ªè®°å½•åŒ…å«å‰ä¸€ä¸ªè®°å½•çš„å“ˆå¸Œå€¼
- å¦‚æœráµ¢è¢«ä¿®æ”¹ï¼Œåˆ™háµ¢æ”¹å˜ï¼Œå¯¼è‡´åç»­æ‰€æœ‰è®°å½•çš„å“ˆå¸Œå€¼æ”¹å˜

**æ­¥éª¤3ï¼šç¯¡æ”¹æ£€æµ‹**:

- éªŒè¯æ—¶æ£€æŸ¥ç­¾åæˆ–å“ˆå¸Œé“¾
- å¦‚æœä»»ä½•è®°å½•è¢«ç¯¡æ”¹ï¼ŒéªŒè¯ä¼šå¤±è´¥
- å› æ­¤ï¼Œå¯ä»¥æ£€æµ‹åˆ°ç¯¡æ”¹

**æ­¥éª¤4ï¼šç»“è®º**:

- å¦‚æœå®¡è®¡è½¨è¿¹ä½¿ç”¨æ•°å­—ç­¾åæˆ–å“ˆå¸Œé“¾ä¿æŠ¤ï¼Œåˆ™å®¡è®¡è½¨è¿¹æ˜¯ä¸å¯ç¯¡æ”¹çš„
- ä»»ä½•ç¯¡æ”¹éƒ½ä¼šè¢«æ£€æµ‹åˆ°
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å®¡è®¡è½¨è¿¹ä¸å¯ç¯¡æ”¹æ€§] --> B[æ•°å­—ç­¾åä¿æŠ¤]
    A --> C[å“ˆå¸Œé“¾ä¿æŠ¤]
    B --> D[ç­¾åéªŒè¯]
    C --> E[å“ˆå¸Œé“¾éªŒè¯]
    D --> F[ç¯¡æ”¹æ£€æµ‹]
    E --> F
    F --> G[ä¸å¯ç¯¡æ”¹]

    style A fill:#FFD700
    style G fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 å®¡è®¡ä¸åˆè§„å®ç°è¯¦è§£

**PostgreSQL 18å®¡è®¡æœºåˆ¶**ï¼š

PostgreSQL 18æ”¯æŒå¤šç§å®¡è®¡æ–¹å¼ï¼ŒåŒ…æ‹¬æ—¥å¿—å®¡è®¡ã€æ‰©å±•å®¡è®¡ï¼ˆå¦‚pgAuditï¼‰å’Œåº”ç”¨å±‚å®¡è®¡ã€‚PostgreSQL 18è¿˜æ”¯æŒå®Œæ•´æ€§çº¦æŸï¼ŒåŒ…æ‹¬ä¸»é”®ã€å¤–é”®ã€CHECKçº¦æŸç­‰ã€‚

**PostgreSQL 18æ—¥å¿—å®¡è®¡**ï¼š

```sql
-- PostgreSQL 18ï¼šå¯ç”¨æ—¥å¿—å®¡è®¡
ALTER SYSTEM SET log_statement = 'all';
-- å¯é€‰å€¼ï¼šnone, ddl, mod, all
-- allï¼šè®°å½•æ‰€æœ‰è¯­å¥

ALTER SYSTEM SET log_min_duration_statement = 0;
-- è®°å½•æ‰€æœ‰è¯­å¥çš„æ‰§è¡Œæ—¶é—´

ALTER SYSTEM SET log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';
-- é…ç½®æ—¥å¿—å‰ç¼€ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€è¿›ç¨‹IDã€ç”¨æˆ·ã€æ•°æ®åº“ç­‰ä¿¡æ¯

-- PostgreSQL 18ï¼šæŸ¥çœ‹æ—¥å¿—
-- æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼špostgresql.confä¸­çš„log_directoryé…ç½®
SELECT pg_read_file('log/postgresql-2025-01-16.log', 0, 1000);
```

**PostgreSQL 18 pgAuditæ‰©å±•**ï¼š

```sql
-- PostgreSQL 18ï¼šå®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- PostgreSQL 18ï¼šé…ç½®pgAudit
ALTER SYSTEM SET pgaudit.log = 'all';
-- å¯é€‰å€¼ï¼šread, write, function, role, ddl, misc, all

ALTER SYSTEM SET pgaudit.log_catalog = 'off';
-- æ˜¯å¦è®°å½•ç³»ç»Ÿç›®å½•è®¿é—®

ALTER SYSTEM SET pgaudit.log_parameter = 'on';
-- æ˜¯å¦è®°å½•å‚æ•°å€¼

ALTER SYSTEM SET pgaudit.log_statement_once = 'off';
-- æ˜¯å¦åªè®°å½•ä¸€æ¬¡è¯­å¥

-- PostgreSQL 18ï¼šæŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

**PostgreSQL 18å®Œæ•´æ€§çº¦æŸ**ï¼š

```sql
-- PostgreSQL 18ï¼šä¸»é”®çº¦æŸï¼ˆå®ä½“å®Œæ•´æ€§ï¼‰
CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,  -- ä¸»é”®çº¦æŸ
    account_number VARCHAR(20) UNIQUE,  -- å”¯ä¸€çº¦æŸ
    balance DECIMAL(15,2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- PostgreSQL 18ï¼šå¤–é”®çº¦æŸï¼ˆå‚ç…§å®Œæ•´æ€§ï¼‰
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    account_id INTEGER NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    transaction_type VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT fk_account
        FOREIGN KEY (account_id)
        REFERENCES accounts(id)
        ON DELETE CASCADE  -- çº§è”åˆ é™¤
        ON UPDATE CASCADE  -- çº§è”æ›´æ–°
);

-- PostgreSQL 18ï¼šCHECKçº¦æŸï¼ˆç”¨æˆ·å®šä¹‰å®Œæ•´æ€§ï¼‰
ALTER TABLE accounts
ADD CONSTRAINT balance_check
CHECK (balance >= 0);

ALTER TABLE transactions
ADD CONSTRAINT amount_check
CHECK (amount != 0);

-- PostgreSQL 18ï¼šNOT NULLçº¦æŸ
ALTER TABLE accounts
ALTER COLUMN account_number SET NOT NULL;

-- PostgreSQL 18ï¼šæŸ¥çœ‹çº¦æŸ
SELECT
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'accounts'::regclass;
```

**PostgreSQL 18å®¡è®¡è¡¨å®ç°**ï¼š

```sql
-- PostgreSQL 18ï¼šåˆ›å»ºå®¡è®¡è¡¨
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    username VARCHAR(100),
    database_name VARCHAR(100),
    table_name VARCHAR(100),
    operation VARCHAR(20),  -- INSERT, UPDATE, DELETE, SELECT
    old_values JSONB,
    new_values JSONB,
    query_text TEXT,
    client_ip INET,
    application_name VARCHAR(100)
);

-- PostgreSQL 18ï¼šåˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO audit_log (
            username, database_name, table_name, operation,
            new_values, query_text
        ) VALUES (
            current_user,
            current_database(),
            TG_TABLE_NAME,
            'INSERT',
            row_to_json(NEW),
            current_query()
        );
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO audit_log (
            username, database_name, table_name, operation,
            old_values, new_values, query_text
        ) VALUES (
            current_user,
            current_database(),
            TG_TABLE_NAME,
            'UPDATE',
            row_to_json(OLD),
            row_to_json(NEW),
            current_query()
        );
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO audit_log (
            username, database_name, table_name, operation,
            old_values, query_text
        ) VALUES (
            current_user,
            current_database(),
            TG_TABLE_NAME,
            'DELETE',
            row_to_json(OLD),
            current_query()
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- PostgreSQL 18ï¼šåˆ›å»ºå®¡è®¡è§¦å‘å™¨
CREATE TRIGGER accounts_audit_trigger
AFTER INSERT OR UPDATE OR DELETE ON accounts
FOR EACH ROW
EXECUTE FUNCTION audit_trigger_function();

-- PostgreSQL 18ï¼šæŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    table_name,
    operation,
    old_values,
    new_values
FROM audit_log
ORDER BY timestamp DESC
LIMIT 100;
```

### 5.2 SQLite 3.45 å®¡è®¡ä¸åˆè§„å¯¹æ¯”

**SQLite 3.45å®¡è®¡æ”¯æŒ**ï¼š

SQLite 3.45çš„å®¡è®¡æ”¯æŒä¸PostgreSQL 18ä¸åŒã€‚

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **æ—¥å¿—å®¡è®¡** | âœ… æ”¯æŒ | âš ï¸ æœ‰é™æ”¯æŒ |
| **æ‰©å±•å®¡è®¡** | âœ… æ”¯æŒï¼ˆpgAuditï¼‰ | âŒ ä¸æ”¯æŒ |
| **å®Œæ•´æ€§çº¦æŸ** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å®¡è®¡è§¦å‘å™¨** | âœ… æ”¯æŒ | âš ï¸ æœ‰é™æ”¯æŒ |

**SQLite 3.45å®¡è®¡**ï¼š

```sql
-- SQLite 3.45ï¼šå®Œæ•´æ€§çº¦æŸ
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY,
    account_number TEXT UNIQUE NOT NULL,
    balance REAL NOT NULL CHECK (balance >= 0)
);

-- SQLite 3.45ï¼šå¤–é”®çº¦æŸï¼ˆéœ€è¦å¯ç”¨ï¼‰
PRAGMA foreign_keys = ON;

CREATE TABLE transactions (
    id INTEGER PRIMARY KEY,
    account_id INTEGER NOT NULL,
    amount REAL NOT NULL,
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);

-- SQLite 3.45ï¼šå®¡è®¡ï¼ˆéœ€è¦åœ¨åº”ç”¨å±‚å®ç°ï¼‰
-- ä½¿ç”¨è§¦å‘å™¨è®°å½•å®¡è®¡ä¿¡æ¯
```

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„å®¡è®¡ä¸åˆè§„

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- é‡‘èç³»ç»Ÿï¼Œéœ€è¦æ»¡è¶³SOXåˆè§„è¦æ±‚
- éœ€è¦è®°å½•æ‰€æœ‰æ•°æ®è®¿é—®å’Œä¿®æ”¹
- éœ€è¦ä¿è¯å®¡è®¡è½¨è¿¹çš„å®Œæ•´æ€§

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å®ç°å®Œæ•´å®¡è®¡
- ä¿è¯å®¡è®¡è½¨è¿¹ä¸å¯ç¯¡æ”¹
- æ»¡è¶³åˆè§„è¦æ±‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šé‡‘èç³»ç»Ÿå®¡è®¡ä¸åˆè§„
-- 1. å¯ç”¨pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

ALTER SYSTEM SET pgaudit.log = 'all';
ALTER SYSTEM SET pgaudit.log_parameter = 'on';

-- 2. åˆ›å»ºé‡‘èæ•°æ®è¡¨
CREATE TABLE financial_records (
    id SERIAL PRIMARY KEY,
    account_id INTEGER NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,
    amount DECIMAL(15,2) NOT NULL CHECK (amount != 0),
    balance DECIMAL(15,2) NOT NULL CHECK (balance >= 0),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT fk_account
        FOREIGN KEY (account_id)
        REFERENCES accounts(id)
);

-- 3. åˆ›å»ºå®¡è®¡è¡¨
CREATE TABLE financial_audit_log (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    username VARCHAR(100),
    operation VARCHAR(20),
    table_name VARCHAR(100),
    record_id INTEGER,
    old_values JSONB,
    new_values JSONB,
    query_text TEXT,
    client_ip INET
);

-- 4. åˆ›å»ºå®¡è®¡è§¦å‘å™¨
CREATE TRIGGER financial_audit_trigger
AFTER INSERT OR UPDATE OR DELETE ON financial_records
FOR EACH ROW
EXECUTE FUNCTION audit_trigger_function();

-- 5. æµ‹è¯•å®¡è®¡
INSERT INTO financial_records (account_id, transaction_type, amount, balance)
VALUES (1, 'deposit', 1000.00, 1000.00);

-- æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    operation,
    old_values,
    new_values
FROM financial_audit_log
WHERE table_name = 'financial_records'
ORDER BY timestamp DESC;

-- 6. å®¡è®¡è½¨è¿¹å®Œæ•´æ€§éªŒè¯
-- ä½¿ç”¨å“ˆå¸Œé“¾ä¿æŠ¤å®¡è®¡è½¨è¿¹
CREATE TABLE audit_hash_chain (
    id BIGSERIAL PRIMARY KEY,
    audit_log_id BIGINT REFERENCES financial_audit_log(id),
    hash_value BYTEA,
    previous_hash BYTEA
);

-- åˆ›å»ºå“ˆå¸Œé“¾å‡½æ•°
CREATE OR REPLACE FUNCTION update_audit_hash_chain()
RETURNS TRIGGER AS $$
DECLARE
    prev_hash BYTEA;
BEGIN
    SELECT hash_value INTO prev_hash
    FROM audit_hash_chain
    ORDER BY id DESC
    LIMIT 1;

    INSERT INTO audit_hash_chain (audit_log_id, hash_value, previous_hash)
    VALUES (
        NEW.id,
        digest(NEW.id::TEXT || COALESCE(prev_hash::TEXT, ''), 'sha256'),
        prev_hash
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_hash_chain_trigger
AFTER INSERT ON financial_audit_log
FOR EACH ROW
EXECUTE FUNCTION update_audit_hash_chain();
```

**æ€§èƒ½æ•°æ®**ï¼š

| æŒ‡æ ‡ | æ— å®¡è®¡ | æœ‰å®¡è®¡ | è¯´æ˜ |
|------|--------|--------|------|
| **æ’å…¥æ€§èƒ½** | 5ms | 8ms | å®¡è®¡å¢åŠ å¼€é”€ |
| **æŸ¥è¯¢æ€§èƒ½** | 10ms | 10ms | æŸ¥è¯¢ä¸å—å½±å“ |
| **å®¡è®¡å®Œæ•´æ€§** | âŒ æ—  | âœ… ä¿è¯ | å®¡è®¡ä¿è¯å®Œæ•´æ€§ |
| **åˆè§„æ€§** | âŒ ä¸ç¬¦åˆ | âœ… ç¬¦åˆ | æ»¡è¶³SOXè¦æ±‚ |

#### åœºæ™¯2ï¼šåŒ»ç–—ç³»ç»Ÿçš„HIPAAåˆè§„å®¡è®¡

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- åŒ»ç–—ç³»ç»Ÿï¼Œéœ€è¦æ»¡è¶³HIPAAåˆè§„è¦æ±‚
- éœ€è¦è®°å½•æ‰€æœ‰æ‚£è€…æ•°æ®è®¿é—®
- éœ€è¦ä¿è¯æ•°æ®å®Œæ•´æ€§

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å®ç°HIPAAåˆè§„å®¡è®¡
- ä¿è¯æ•°æ®å®Œæ•´æ€§
- ä¿æŠ¤æ‚£è€…éšç§

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šåŒ»ç–—ç³»ç»ŸHIPAAåˆè§„å®¡è®¡
-- 1. åˆ›å»ºæ‚£è€…æ•°æ®è¡¨
CREATE TABLE patient_records (
    id SERIAL PRIMARY KEY,
    patient_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    date_of_birth DATE NOT NULL,
    diagnosis TEXT,
    treatment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºHIPAAå®¡è®¡è¡¨
CREATE TABLE hipaa_audit_log (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    username VARCHAR(100),
    user_role VARCHAR(50),
    operation VARCHAR(20),
    table_name VARCHAR(100),
    patient_id VARCHAR(50),
    access_reason TEXT,
    query_text TEXT,
    client_ip INET,
    application_name VARCHAR(100)
);

-- 3. åˆ›å»ºHIPAAå®¡è®¡è§¦å‘å™¨
CREATE OR REPLACE FUNCTION hipaa_audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO hipaa_audit_log (
        username, user_role, operation, table_name,
        patient_id, access_reason, query_text
    ) VALUES (
        current_user,
        current_setting('app.user_role', true),
        TG_OP,
        TG_TABLE_NAME,
        COALESCE(NEW.patient_id, OLD.patient_id),
        current_setting('app.access_reason', true),
        current_query()
    );

    IF TG_OP = 'DELETE' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER hipaa_audit_trigger
AFTER INSERT OR UPDATE OR DELETE ON patient_records
FOR EACH ROW
EXECUTE FUNCTION hipaa_audit_trigger_function();

-- 4. æµ‹è¯•HIPAAå®¡è®¡
SET app.user_role = 'doctor';
SET app.access_reason = 'Patient care';

SELECT * FROM patient_records WHERE patient_id = 'P001';

-- æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT
    timestamp,
    username,
    user_role,
    operation,
    patient_id,
    access_reason
FROM hipaa_audit_log
WHERE patient_id = 'P001'
ORDER BY timestamp DESC;
```

**æ€§èƒ½æ•°æ®**ï¼š

| æŒ‡æ ‡ | æ— å®¡è®¡ | æœ‰å®¡è®¡ | è¯´æ˜ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ€§èƒ½** | 8ms | 10ms | å®¡è®¡å¢åŠ å¼€é”€ |
| **æ•°æ®å®Œæ•´æ€§** | âœ… ä¿è¯ | âœ… ä¿è¯ | çº¦æŸä¿è¯å®Œæ•´æ€§ |
| **åˆè§„æ€§** | âŒ ä¸ç¬¦åˆ | âœ… ç¬¦åˆ | æ»¡è¶³HIPAAè¦æ±‚ |

### 5.4 å®¡è®¡ä¸åˆè§„ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ

**PostgreSQL 18æœ€ä½³å®è·µ**ï¼š

```sql
-- 1. å®¡è®¡é…ç½®
-- ä½¿ç”¨pgAuditæ‰©å±•è¿›è¡Œç»†ç²’åº¦å®¡è®¡
CREATE EXTENSION IF NOT EXISTS pgaudit;
ALTER SYSTEM SET pgaudit.log = 'all';

-- 2. å®Œæ•´æ€§çº¦æŸ
-- ä½¿ç”¨çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
-- ä¸»é”®ã€å¤–é”®ã€CHECKçº¦æŸ

-- 3. å®¡è®¡è¡¨è®¾è®¡
-- è®°å½•æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼šæ—¶é—´æˆ³ã€ç”¨æˆ·ã€æ“ä½œã€å¯¹è±¡ã€ç»“æœ

-- 4. å®¡è®¡è½¨è¿¹ä¿æŠ¤
-- ä½¿ç”¨å“ˆå¸Œé“¾æˆ–æ•°å­—ç­¾åä¿æŠ¤å®¡è®¡è½¨è¿¹
-- å®šæœŸéªŒè¯å®¡è®¡è½¨è¿¹å®Œæ•´æ€§

-- 5. åˆè§„æ€§æ£€æŸ¥
-- å®šæœŸæ£€æŸ¥å®¡è®¡æ—¥å¿—
-- ç¡®ä¿æ»¡è¶³åˆè§„è¦æ±‚ï¼ˆSOXã€HIPAAã€GDPRç­‰ï¼‰
```

### 5.5 æ¨¡å‹é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQL 18å®¡è®¡ä¸åˆè§„çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- éœ€è¦åˆè§„å®¡è®¡
- éœ€è¦æ•°æ®å®Œæ•´æ€§
- éœ€è¦å¯è¿½æº¯æ€§
- ä¼ä¸šç³»ç»Ÿ

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- ç®€å•åº”ç”¨
- ä¸éœ€è¦å®¡è®¡
- ä¸éœ€è¦åˆè§„

**é€‰æ‹©SQLite 3.45çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- å•æœºåº”ç”¨
- åº”ç”¨å±‚å®ç°å®¡è®¡
- å°æ•°æ®é‡

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- éœ€è¦å®Œæ•´å®¡è®¡
- éœ€è¦åˆè§„
- å¤§æ•°æ®é‡

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)
- [æ•°æ®åº“å®‰å…¨æ¨¡å‹-è®¿é—®æ§åˆ¶ä¸ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–](./07.04-æ•°æ®åº“å®‰å…¨æ¨¡å‹-è®¿é—®æ§åˆ¶ä¸ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Date, C. J. (2003). "An Introduction to Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: æ•°æ®åº“ç³»ç»Ÿç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†å®Œæ•´æ€§çº¦æŸ

- **Sandhu, R. S., & Jajodia, S. (1993). "Integrity Mechanisms in Database Management Systems."**
  - ä¼šè®®: IFIP WG 11.3 1993
  - **é‡è¦æ€§**: æ•°æ®åº“å®Œæ•´æ€§æœºåˆ¶
  - **æ ¸å¿ƒè´¡çŒ®**: æ€»ç»“äº†å®Œæ•´æ€§çº¦æŸæ–¹æ³•

### 6.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - çº¦æŸ](<https://www.postgresql.org/docs/current/ddl-constraints.html>)**
  - PostgreSQLçº¦æŸå®ç°è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)
- [æ•°æ®åº“å®‰å…¨æ¨¡å‹-è®¿é—®æ§åˆ¶ä¸ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–](./07.04-æ•°æ®åº“å®‰å…¨æ¨¡å‹-è®¿é—®æ§åˆ¶ä¸ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”
