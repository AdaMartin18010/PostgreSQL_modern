---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\07-å®‰å…¨\ã€æ·±å…¥ã€‘æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¶é—´**: 2025 å¹´ 12 æœˆ 4 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ with ProvSQL
> **æ–‡æ¡£ç¼–å·**: 07-SEC-PROVENANCE

---

## ğŸ“‘ ç›®å½•

- [æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—](#æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æå®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº](#11-ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº)
    - [1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ](#12-ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
    - [1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#14-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [äºŒã€åŸç†ä¸ç†è®º](#äºŒåŸç†ä¸ç†è®º)
    - [2.1 æ•°æ®æº¯æºç†è®º](#21-æ•°æ®æº¯æºç†è®º)
      - [**æº¯æºçš„ä¸‰ç§ç±»å‹**](#æº¯æºçš„ä¸‰ç§ç±»å‹)
    - [2.2 æº¯æºæ¨¡å‹](#22-æº¯æºæ¨¡å‹)
      - [**PROV-DMï¼ˆW3Cæ ‡å‡†ï¼‰**](#prov-dmw3cæ ‡å‡†)
    - [2.3 è¡€ç¼˜åˆ†æåŸç†](#23-è¡€ç¼˜åˆ†æåŸç†)
      - [**è¡€ç¼˜ç±»å‹**](#è¡€ç¼˜ç±»å‹)
    - [2.4 å‰æ²¿ç ”ç©¶ ProvSQL](#24-å‰æ²¿ç ”ç©¶-provsql)
  - [ä¸‰ã€æ¶æ„è®¾è®¡](#ä¸‰æ¶æ„è®¾è®¡)
    - [3.1 æ•´ä½“æ¶æ„](#31-æ•´ä½“æ¶æ„)
    - [3.2 æº¯æºæ•°æ®å­˜å‚¨](#32-æº¯æºæ•°æ®å­˜å‚¨)
    - [3.3 è¡€ç¼˜è¿½è¸ªæœºåˆ¶](#33-è¡€ç¼˜è¿½è¸ªæœºåˆ¶)
    - [3.4 å¯è§†åŒ–ç³»ç»Ÿ](#34-å¯è§†åŒ–ç³»ç»Ÿ)
  - [å››ã€ç¨‹åºè®¾è®¡](#å››ç¨‹åºè®¾è®¡)
    - [4.1 ç¯å¢ƒå‡†å¤‡](#41-ç¯å¢ƒå‡†å¤‡)
    - [4.2 åŸºç¡€æº¯æºå®ç°](#42-åŸºç¡€æº¯æºå®ç°)
    - [4.3 ProvSQLé›†æˆ](#43-provsqlé›†æˆ)
    - [4.4 è¡€ç¼˜åˆ†æå·¥å…·](#44-è¡€ç¼˜åˆ†æå·¥å…·)
  - [äº”ã€è¿ç»´ç®¡ç†](#äº”è¿ç»´ç®¡ç†)
    - [5.1 æ€§èƒ½ä¼˜åŒ–](#51-æ€§èƒ½ä¼˜åŒ–)
    - [5.2 å­˜å‚¨ç®¡ç†](#52-å­˜å‚¨ç®¡ç†)
    - [5.3 å¯è§†åŒ–ä¸æŠ¥è¡¨](#53-å¯è§†åŒ–ä¸æŠ¥è¡¨)
    - [5.4 æœ€ä½³å®è·µ](#54-æœ€ä½³å®è·µ)
  - [å…­ã€æ¡ˆä¾‹å®æˆ˜](#å…­æ¡ˆä¾‹å®æˆ˜)
    - [6.1 æ•°æ®è´¨é‡è¿½è¸ª](#61-æ•°æ®è´¨é‡è¿½è¸ª)
    - [6.2 åˆè§„æ€§å®¡è®¡](#62-åˆè§„æ€§å®¡è®¡)
    - [6.3 å½±å“åˆ†æ](#63-å½±å“åˆ†æ)
  - [ä¸ƒã€æ€»ç»“ä¸å±•æœ›](#ä¸ƒæ€»ç»“ä¸å±•æœ›)
    - [æ ¸å¿ƒæ”¶è·](#æ ¸å¿ƒæ”¶è·)
    - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯)
  - [å…«ã€å‚è€ƒèµ„æ–™](#å…«å‚è€ƒèµ„æ–™)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®æº¯æº

**æ•°æ®æº¯æº**ï¼ˆData Provenanceï¼‰æ˜¯è®°å½•æ•°æ®çš„æ¥æºã€å†å²å’Œè½¬æ¢è¿‡ç¨‹çš„æŠ€æœ¯ï¼Œå›ç­”"è¿™ä¸ªæ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿç»è¿‡äº†ä»€ä¹ˆå¤„ç†ï¼Ÿ"

**æ ¸å¿ƒé—®é¢˜**ï¼š

- ğŸ“ **Where**: æ•°æ®æ¥è‡ªå“ªä¸ªæºç³»ç»Ÿï¼Ÿ
- ğŸ• **When**: æ•°æ®åœ¨ä»€ä¹ˆæ—¶é—´äº§ç”Ÿï¼Ÿ
- ğŸ‘¤ **Who**: è°åˆ›å»ºæˆ–ä¿®æ”¹äº†æ•°æ®ï¼Ÿ
- ğŸ”§ **How**: æ•°æ®ç»è¿‡äº†ä»€ä¹ˆè½¬æ¢ï¼Ÿ
- ğŸ¯ **Why**: æ•°æ®ä¸ºä»€ä¹ˆå˜åŒ–ï¼Ÿ

**ç¤ºä¾‹**ï¼š

```text
æ•°æ®è¡€ç¼˜å›¾ï¼š
-----------
[æºè¡¨A] â”€â”
         â”œâ”€â†’ [ETLè½¬æ¢1] â”€â†’ [ä¸­é—´è¡¨B] â”€â†’ [èšåˆè®¡ç®—] â”€â†’ [æŠ¥è¡¨C]
[æºè¡¨D] â”€â”˜                    â†“
                        [æ•°æ®è´¨é‡æ£€æŸ¥]

æº¯æºæŸ¥è¯¢ï¼š
---------
æŠ¥è¡¨Cä¸­çš„æŸä¸ªå€¼ â†’ è¿½æº¯åˆ°
  - ä¸­é—´è¡¨Bçš„ç¬¬123è¡Œ
  - æ¥è‡ªæºè¡¨Açš„ç¬¬456è¡Œå’Œæºè¡¨Dçš„ç¬¬789è¡Œ
  - ç»è¿‡ETLè½¬æ¢1ï¼ˆè¿æ¥ã€è¿‡æ»¤ã€èšåˆï¼‰
  - ç”±ç”¨æˆ·Johnåœ¨2024-12-01 10:30:00æ‰§è¡Œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æ

æ•°æ®è¡€ç¼˜åˆ†ææ˜¯ç°ä»£æ•°æ®ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒå¸®åŠ©ç»„ç»‡ç†è§£æ•°æ®çš„æ¥æºã€æµè½¬å’Œä¾èµ–å…³ç³»ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦è¡€ç¼˜åˆ†æä»¥åŠå®ƒåœ¨å®é™…ä¸šåŠ¡ä¸­çš„ä»·å€¼ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

| åœºæ™¯ | éœ€æ±‚ | ä»·å€¼ | è¯¦ç»†è¯´æ˜ |
| --- | --- | --- | --- |
| **æ•°æ®è´¨é‡** | è¿½è¸ªé”™è¯¯æ•°æ®çš„æ¥æº | å¿«é€Ÿå®šä½é—®é¢˜æ ¹å›  | å½“å‘ç°æ•°æ®é”™è¯¯æ—¶ï¼Œé€šè¿‡è¡€ç¼˜åˆ†æå¯ä»¥å¿«é€Ÿè¿½æº¯åˆ°æ•°æ®æºå¤´ï¼Œå®šä½é—®é¢˜å‘ç”Ÿçš„å…·ä½“ç¯èŠ‚ï¼Œå‡å°‘é—®é¢˜æ’æŸ¥æ—¶é—´ |
| **åˆè§„æ€§** | è¯æ˜æ•°æ®å¤„ç†è¿‡ç¨‹ | GDPR "è¢«é—å¿˜æƒ" | æ»¡è¶³GDPRç­‰åˆè§„è¦æ±‚ï¼Œéœ€è¦è¯æ˜æ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œè¡€ç¼˜åˆ†ææä¾›äº†å®Œæ•´çš„æ•°æ®å¤„ç†è½¨è¿¹ |
| **å½±å“åˆ†æ** | è¯„ä¼°è¡¨ç»“æ„å˜æ›´å½±å“ | é™ä½å˜æ›´é£é™© | åœ¨ä¿®æ”¹è¡¨ç»“æ„æˆ–åˆ é™¤æ•°æ®æ—¶ï¼Œé€šè¿‡è¡€ç¼˜åˆ†æå¯ä»¥è¯„ä¼°å½±å“èŒƒå›´ï¼Œé¿å…å½±å“ä¸‹æ¸¸ç³»ç»Ÿ |
| **å®¡è®¡è¿½è¸ª** | è®°å½•æ•°æ®è®¿é—®å†å² | æ»¡è¶³å®¡è®¡è¦æ±‚ | è®°å½•æ•°æ®çš„è®¿é—®ã€ä¿®æ”¹å†å²ï¼Œæ»¡è¶³SOXã€HIPAAç­‰å®¡è®¡è¦æ±‚ |
| **æ•°æ®æ²»ç†** | ç†è§£æ•°æ®æµè½¬ | ä¼˜åŒ–æ•°æ®æ¶æ„ | é€šè¿‡è¡€ç¼˜åˆ†æç†è§£æ•°æ®çš„æµè½¬è·¯å¾„ï¼Œå‘ç°æ•°æ®å†—ä½™ã€ä¼˜åŒ–æ•°æ®æ¶æ„ |
| **è°ƒè¯•åˆ†æ** | è¿½è¸ªè®¡ç®—è¿‡ç¨‹ | æå‡å¼€å‘æ•ˆç‡ | åœ¨æ•°æ®è®¡ç®—å‡ºç°é—®é¢˜æ—¶ï¼Œé€šè¿‡è¡€ç¼˜åˆ†æå¯ä»¥è¿½è¸ªè®¡ç®—è¿‡ç¨‹ï¼Œå¿«é€Ÿå®šä½é—®é¢˜ |

**å®é™…åº”ç”¨åœºæ™¯**ï¼š

**åœºæ™¯1ï¼šæ•°æ®è´¨é‡é—®é¢˜æ’æŸ¥**

```sql
-- å‘ç°æŠ¥è¡¨æ•°æ®å¼‚å¸¸
-- é€šè¿‡è¡€ç¼˜åˆ†æè¿½è¸ªåˆ°é—®é¢˜æºå¤´

-- 1. æŸ¥è¯¢æŠ¥è¡¨æ•°æ®çš„è¡€ç¼˜å…³ç³»
SELECT
    source_table,
    source_column,
    transformation_type,
    transformation_details
FROM data_lineage
WHERE target_table = 'monthly_report'
  AND target_column = 'total_revenue';

-- 2. è¿½æº¯åˆ°æºæ•°æ®
-- å‘ç°æ•°æ®æ¥è‡ªsalesè¡¨ï¼Œç»è¿‡èšåˆè®¡ç®—
-- è¿›ä¸€æ­¥æ£€æŸ¥salesè¡¨çš„æ•°æ®è´¨é‡
SELECT
    COUNT(*) AS total_records,
    COUNT(DISTINCT order_id) AS unique_orders,
    SUM(amount) AS total_amount
FROM sales
WHERE order_date >= '2024-01-01'
  AND order_date < '2024-02-01';

-- 3. å‘ç°é—®é¢˜ï¼šsalesè¡¨å­˜åœ¨é‡å¤æ•°æ®
-- ä¿®å¤æ•°æ®è´¨é‡é—®é¢˜
```

**åœºæ™¯2ï¼šåˆè§„æ€§å®¡è®¡**

```sql
-- GDPRåˆè§„ï¼šè¿½è¸ªä¸ªäººæ•°æ®å¤„ç†
-- æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ•°æ®å¤„ç†è½¨è¿¹

SELECT
    entity_id,
    activity_type,
    activity_time,
    agent_id,
    used_entity_id
FROM provenance_entities e
JOIN provenance_activities a ON e.entity_id = a.generated_entity_id
WHERE e.entity_type = 'user_data'
  AND e.entity_attributes->>'user_id' = '12345'
ORDER BY activity_time;
```

**åœºæ™¯3ï¼šå½±å“åˆ†æ**

```sql
-- è¯„ä¼°åˆ é™¤æŸä¸ªè¡¨çš„å½±å“èŒƒå›´
-- æŸ¥è¯¢æ‰€æœ‰ä¾èµ–è¯¥è¡¨çš„ä¸‹æ¸¸å¯¹è±¡

WITH RECURSIVE lineage_tree AS (
    -- èµ·å§‹èŠ‚ç‚¹
    SELECT
        target_table AS table_name,
        target_column AS column_name,
        1 AS level
    FROM data_lineage
    WHERE source_table = 'orders'

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ä¸‹æ¸¸ä¾èµ–
    SELECT
        dl.target_table,
        dl.target_column,
        lt.level + 1
    FROM data_lineage dl
    JOIN lineage_tree lt ON dl.source_table = lt.table_name
    WHERE lt.level < 10  -- é™åˆ¶é€’å½’æ·±åº¦
)
SELECT DISTINCT table_name, column_name, level
FROM lineage_tree
ORDER BY level, table_name;
```

**æŠ€æœ¯éœ€æ±‚**ï¼š

- **æ•°æ®è¿½è¸ª**ï¼šéœ€è¦è¿½è¸ªæ•°æ®çš„æ¥æºå’Œè½¬æ¢è¿‡ç¨‹
- **ä¾èµ–åˆ†æ**ï¼šéœ€è¦åˆ†ææ•°æ®ä¹‹é—´çš„ä¾èµ–å…³ç³»
- **å½±å“è¯„ä¼°**ï¼šéœ€è¦è¯„ä¼°æ•°æ®å˜æ›´çš„å½±å“èŒƒå›´
- **åˆè§„å®¡è®¡**ï¼šéœ€è¦è®°å½•æ•°æ®çš„å¤„ç†å†å²
- **å¯è§†åŒ–å±•ç¤º**ï¼šéœ€è¦å¯è§†åŒ–å±•ç¤ºæ•°æ®è¡€ç¼˜å…³ç³»

### 1.3 æ ¸å¿ƒä»·å€¼

æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æçš„æ ¸å¿ƒä»·å€¼åœ¨äºæä¾›å®Œæ•´çš„æ•°æ®è¿½è¸ªèƒ½åŠ›ï¼Œå¸®åŠ©ç»„ç»‡ç†è§£æ•°æ®çš„æ¥æºã€æµè½¬å’Œä¾èµ–å…³ç³»ï¼Œä»è€Œæå‡æ•°æ®è´¨é‡ã€æ»¡è¶³åˆè§„è¦æ±‚ã€ä¼˜åŒ–æ•°æ®æ¶æ„ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æçš„æ ¸å¿ƒä»·å€¼ã€‚

**æŠ€æœ¯ä»·å€¼**ï¼š

- ğŸ¯ **å¯è¿½æº¯æ€§**: ä»»ä½•æ•°æ®éƒ½èƒ½è¿½æº¯åˆ°æºå¤´
  - **è¯´æ˜**ï¼šæ•°æ®æº¯æºæä¾›äº†å®Œæ•´çš„æ•°æ®è¿½è¸ªèƒ½åŠ›ï¼Œå¯ä»¥ä»ä»»ä½•æ•°æ®ç‚¹è¿½æº¯åˆ°å…¶æºå¤´
  - **ä»·å€¼**ï¼šå¿«é€Ÿå®šä½æ•°æ®é—®é¢˜ï¼Œç†è§£æ•°æ®çš„ç”Ÿæˆè¿‡ç¨‹
  - **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®è´¨é‡æ’æŸ¥ã€é—®é¢˜è¯Šæ–­ã€æ•°æ®éªŒè¯

- ğŸ” **é€æ˜æ€§**: æ•°æ®å¤„ç†è¿‡ç¨‹å®Œå…¨é€æ˜
  - **è¯´æ˜**ï¼šæ•°æ®è¡€ç¼˜åˆ†æä½¿å¾—æ•°æ®å¤„ç†è¿‡ç¨‹å®Œå…¨é€æ˜ï¼Œå¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ•°æ®ç»è¿‡äº†å“ªäº›è½¬æ¢
  - **ä»·å€¼**ï¼šæå‡æ•°æ®å¯ä¿¡åº¦ï¼Œä¾¿äºæ•°æ®æ²»ç†
  - **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®æ²»ç†ã€æ•°æ®æ¶æ„ä¼˜åŒ–ã€æ•°æ®è´¨é‡æå‡

- ğŸ›¡ï¸ **å¯å®¡è®¡æ€§**: æ»¡è¶³åˆè§„æ€§è¦æ±‚
  - **è¯´æ˜**ï¼šæ•°æ®æº¯æºæä¾›äº†å®Œæ•´çš„æ•°æ®å¤„ç†å†å²è®°å½•ï¼Œæ»¡è¶³å„ç§åˆè§„æ€§è¦æ±‚
  - **ä»·å€¼**ï¼šæ»¡è¶³GDPRã€SOXã€HIPAAç­‰åˆè§„è¦æ±‚ï¼Œé™ä½åˆè§„é£é™©
  - **åº”ç”¨åœºæ™¯**ï¼šåˆè§„å®¡è®¡ã€å®‰å…¨å®¡è®¡ã€æ•°æ®ä¿æŠ¤

- ğŸ“Š **å¯è§†åŒ–**: ç›´è§‚å±•ç¤ºæ•°æ®æµè½¬
  - **è¯´æ˜**ï¼šæ•°æ®è¡€ç¼˜åˆ†æå¯ä»¥å¯è§†åŒ–å±•ç¤ºæ•°æ®çš„æµè½¬è·¯å¾„å’Œä¾èµ–å…³ç³»
  - **ä»·å€¼**ï¼šç›´è§‚ç†è§£æ•°æ®æ¶æ„ï¼Œä¾¿äºæ•°æ®æ²»ç†å’Œä¼˜åŒ–
  - **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®æ¶æ„å¯è§†åŒ–ã€å½±å“åˆ†æã€ä¾èµ–åˆ†æ

**ä¸šåŠ¡ä»·å€¼**ï¼š

- ğŸ’° **é™ä½é£é™©**: å¿«é€Ÿå®šä½æ•°æ®é—®é¢˜
  - **è¯´æ˜**ï¼šé€šè¿‡æ•°æ®è¡€ç¼˜åˆ†æå¯ä»¥å¿«é€Ÿå®šä½æ•°æ®é—®é¢˜çš„æ ¹æºï¼Œé™ä½ä¸šåŠ¡é£é™©
  - **ä»·å€¼**ï¼šå‡å°‘é—®é¢˜æ’æŸ¥æ—¶é—´ï¼Œé™ä½ä¸šåŠ¡æŸå¤±
  - **é‡åŒ–æ•ˆæœ**ï¼šé—®é¢˜æ’æŸ¥æ—¶é—´å‡å°‘60-80%

- ğŸš€ **æå‡æ•ˆç‡**: åŠ é€Ÿé—®é¢˜è¯Šæ–­
  - **è¯´æ˜**ï¼šæ•°æ®æº¯æºæä¾›äº†å¿«é€Ÿçš„é—®é¢˜è¯Šæ–­èƒ½åŠ›ï¼ŒåŠ é€Ÿé—®é¢˜è§£å†³
  - **ä»·å€¼**ï¼šæå‡å¼€å‘æ•ˆç‡ï¼Œå‡å°‘è¿ç»´æˆæœ¬
  - **é‡åŒ–æ•ˆæœ**ï¼šé—®é¢˜è¯Šæ–­æ—¶é—´å‡å°‘50-70%

- ğŸ” **æ»¡è¶³åˆè§„**: GDPRã€SOXã€HIPAA
  - **è¯´æ˜**ï¼šæ•°æ®æº¯æºæ»¡è¶³å„ç§åˆè§„æ€§è¦æ±‚ï¼Œæä¾›å®Œæ•´çš„æ•°æ®å¤„ç†è®°å½•
  - **ä»·å€¼**ï¼šæ»¡è¶³åˆè§„è¦æ±‚ï¼Œé™ä½åˆè§„é£é™©
  - **é‡åŒ–æ•ˆæœ**ï¼šåˆè§„é€šè¿‡ç‡æå‡åˆ°95%+

- ğŸ“ˆ **ä¼˜åŒ–æ²»ç†**: æ•°æ®æ¶æ„ä¼˜åŒ–ä¾æ®
  - **è¯´æ˜**ï¼šæ•°æ®è¡€ç¼˜åˆ†ææä¾›äº†æ•°æ®æ¶æ„ä¼˜åŒ–çš„ä¾æ®ï¼Œå¯ä»¥å‘ç°æ•°æ®å†—ä½™ã€ä¼˜åŒ–æ•°æ®æµè½¬
  - **ä»·å€¼**ï¼šä¼˜åŒ–æ•°æ®æ¶æ„ï¼Œæå‡æ•°æ®è´¨é‡
  - **é‡åŒ–æ•ˆæœ**ï¼šæ•°æ®å†—ä½™å‡å°‘30-50%ï¼Œæ•°æ®è´¨é‡æå‡20-40%

**ä»·å€¼é‡åŒ–**ï¼š

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ | åº”ç”¨åœºæ™¯ |
|--------|------|------|---------|
| **é—®é¢˜æ’æŸ¥æ•ˆç‡** | å¿«é€Ÿå®šä½æ•°æ®é—®é¢˜ | **60-80%** | æ•°æ®è´¨é‡æ’æŸ¥ã€é—®é¢˜è¯Šæ–­ |
| **åˆè§„é€šè¿‡ç‡** | æ»¡è¶³åˆè§„è¦æ±‚ | **95%+** | GDPRã€SOXã€HIPAAåˆè§„ |
| **æ•°æ®è´¨é‡æå‡** | æå‡æ•°æ®è´¨é‡ | **20-40%** | æ•°æ®æ²»ç†ã€æ•°æ®ä¼˜åŒ– |
| **æ¶æ„ä¼˜åŒ–** | ä¼˜åŒ–æ•°æ®æ¶æ„ | **30-50%** | æ•°æ®æ¶æ„ä¼˜åŒ–ã€å†—ä½™æ¶ˆé™¤ |

### 1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®æº¯æºä¸è¡€ç¼˜))
    åŸç†ä¸ç†è®º
      æº¯æºç†è®º
        Whyæº¯æº
        Whereæº¯æº
        Howæº¯æº
      æº¯æºæ¨¡å‹
        PROV-DM
        Open Provenance
        W3Cæ ‡å‡†
      è¡€ç¼˜åˆ†æ
        è¡¨çº§è¡€ç¼˜
        å­—æ®µçº§è¡€ç¼˜
        è®¡ç®—è¡€ç¼˜
      ProvSQL
        åŠç¯è¯­ä¹‰
        æ¦‚ç‡æº¯æº
        whyæº¯æº
    æ¶æ„è®¾è®¡
      æ•´ä½“æ¶æ„
        æ•è·å±‚
        å­˜å‚¨å±‚
        æŸ¥è¯¢å±‚
        å¯è§†åŒ–å±‚
      å­˜å‚¨è®¾è®¡
        æº¯æºè¡¨
        è¡€ç¼˜å›¾
        å…ƒæ•°æ®
      è¿½è¸ªæœºåˆ¶
        è§¦å‘å™¨
        æ—¥å¿—è§£æ
        Hookæœºåˆ¶
      å¯è§†åŒ–
        è¡€ç¼˜å›¾
        ä¾èµ–å…³ç³»
        å½±å“åˆ†æ
    ç¨‹åºè®¾è®¡
      åŸºç¡€å®ç°
        è§¦å‘å™¨æº¯æº
        æ—¥å¿—æº¯æº
        åº”ç”¨å±‚æº¯æº
      ProvSQLé›†æˆ
        å®‰è£…é…ç½®
        æº¯æºæŸ¥è¯¢
        æ¦‚ç‡è®¡ç®—
      è¡€ç¼˜å·¥å…·
        è§£æå™¨
        å›¾æ„å»º
        æŸ¥è¯¢API
      å¯è§†åŒ–
        D3.js
        GraphViz
        Neo4j Browser
    è¿ç»´ç®¡ç†
      æ€§èƒ½ä¼˜åŒ–
        æº¯æºå¼€é”€
        å­˜å‚¨å‹ç¼©
        æŸ¥è¯¢ä¼˜åŒ–
      å­˜å‚¨ç®¡ç†
        æ¸…ç†ç­–ç•¥
        å½’æ¡£æ–¹æ¡ˆ
        å‹ç¼©å­˜å‚¨
      ç›‘æ§æŠ¥è¡¨
        æº¯æºç»Ÿè®¡
        ä½¿ç”¨åˆ†æ
        åˆè§„æŠ¥å‘Š
    æ¡ˆä¾‹å®æˆ˜
      è´¨é‡è¿½è¸ª
        é”™è¯¯å®šä½
        æ ¹å› åˆ†æ
        ä¿®å¤éªŒè¯
      åˆè§„å®¡è®¡
        GDPR
        æ•°æ®è®¿é—®è®°å½•
        å˜æ›´è¿½è¸ª
      å½±å“åˆ†æ
        è¡¨å˜æ›´å½±å“
        å­—æ®µä¾èµ–
        ä¸‹æ¸¸å½±å“
```

---

## äºŒã€åŸç†ä¸ç†è®º

### 2.1 æ•°æ®æº¯æºç†è®º

#### **æº¯æºçš„ä¸‰ç§ç±»å‹**

**1. Why-Provenanceï¼ˆä¸ºä»€ä¹ˆæº¯æºï¼‰**:

```sql
-- æŸ¥è¯¢ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªç»“æœåœ¨ç»“æœé›†ä¸­ï¼Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒWhyæº¯æºæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders WHERE amount > 1000;

-- ç»“æœï¼šè®¢å•ID=123
-- Whyæº¯æºï¼šå› ä¸ºè®¢å•123çš„amount=1500ï¼Œæ»¡è¶³amount > 1000

-- æ•°å­¦è¡¨ç¤ºï¼š
-- å¦‚æœ tuple t âˆˆ Q(D)ï¼Œé‚£ä¹ˆ why(t) = å¯¼è‡´tå‡ºç°çš„æ‰€æœ‰è¾“å…¥å…ƒç»„é›†åˆ
```

**2. Where-Provenanceï¼ˆå“ªé‡Œæº¯æºï¼‰**:

```sql
-- æŸ¥è¯¢ï¼šç»“æœä¸­çš„æ¯ä¸ªå€¼æ¥è‡ªå“ªé‡Œï¼Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE EXCEPTION 'è¡¨ users ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒWhereæº¯æºæŸ¥è¯¢';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨ï¼ˆè¯·æ£€æŸ¥userså’Œordersè¡¨ï¼‰';
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT user_name, order_total FROM users u JOIN orders o ON u.id = o.user_id;

-- ç»“æœï¼š('Alice', 1500)
-- Whereæº¯æºï¼š
--   'Alice' æ¥è‡ª usersè¡¨ç¬¬3è¡Œçš„nameåˆ—
--   1500 æ¥è‡ª ordersè¡¨ç¬¬5è¡Œçš„totalåˆ—
```

**3. How-Provenanceï¼ˆå¦‚ä½•æº¯æºï¼‰**:

```sql
-- æŸ¥è¯¢ï¼šç»“æœæ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„ï¼Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒHowæº¯æºæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT user_id, SUM(amount) FROM orders GROUP BY user_id;

-- ç»“æœï¼š(1, 3500)
-- Howæº¯æºï¼š3500 = 1000 + 1500 + 1000
--   æ¥è‡ªè®¢å•ID: 101, 102, 103
```

### 2.2 æº¯æºæ¨¡å‹

#### **PROV-DMï¼ˆW3Cæ ‡å‡†ï¼‰**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PROV-DM æ ¸å¿ƒæ¦‚å¿µ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  å®ä½“ (Entity)                            â”‚
â”‚    - æ•°æ®ã€æ–‡æ¡£ã€è¡¨                       â”‚
â”‚                                            â”‚
â”‚  æ´»åŠ¨ (Activity)                          â”‚
â”‚    - æŸ¥è¯¢ã€è½¬æ¢ã€è®¡ç®—                     â”‚
â”‚                                            â”‚
â”‚  ä»£ç† (Agent)                             â”‚
â”‚    - ç”¨æˆ·ã€ç¨‹åºã€ç³»ç»Ÿ                     â”‚
â”‚                                            â”‚
â”‚  å…³ç³» (Relations)                         â”‚
â”‚    - wasGeneratedBy: å®ä½“ç”±æ´»åŠ¨ç”Ÿæˆ       â”‚
â”‚    - used: æ´»åŠ¨ä½¿ç”¨äº†å®ä½“                 â”‚
â”‚    - wasAttributedTo: å®ä½“å½’å±äºä»£ç†      â”‚
â”‚    - wasDerivedFrom: å®ä½“æ´¾ç”Ÿè‡ªå®ä½“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PostgreSQLå®ç°**ï¼š

```sql
-- PROV-DMæ•°æ®æ¨¡å‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'prov_entities') THEN
            RAISE NOTICE 'è¡¨ prov_entities å·²å­˜åœ¨';
        ELSE
            CREATE TABLE prov_entities (
                entity_id SERIAL PRIMARY KEY,
                entity_type VARCHAR(50),  -- 'table', 'row', 'column'
                entity_name TEXT,
                attributes JSONB,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ prov_entities åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ prov_entities å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'prov_activities') THEN
            RAISE NOTICE 'è¡¨ prov_activities å·²å­˜åœ¨';
        ELSE
            CREATE TABLE prov_activities (
                activity_id SERIAL PRIMARY KEY,
                activity_type VARCHAR(50),  -- 'SELECT', 'INSERT', 'UPDATE', 'DELETE'
                description TEXT,
                started_at TIMESTAMPTZ,
                ended_at TIMESTAMPTZ
            );
            RAISE NOTICE 'è¡¨ prov_activities åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ prov_activities å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'prov_agents') THEN
            RAISE NOTICE 'è¡¨ prov_agents å·²å­˜åœ¨';
        ELSE
            CREATE TABLE prov_agents (
                agent_id SERIAL PRIMARY KEY,
                agent_type VARCHAR(50),  -- 'user', 'application', 'system'
    agent_name VARCHAR(100),
    metadata JSONB
);

-- å…³ç³»è¡¨
CREATE TABLE prov_was_generated_by (
    entity_id INT REFERENCES prov_entities(entity_id),
    activity_id INT REFERENCES prov_activities(activity_id),
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (entity_id, activity_id)
);

CREATE TABLE prov_used (
    activity_id INT REFERENCES prov_activities(activity_id),
    entity_id INT REFERENCES prov_entities(entity_id),
    used_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (activity_id, entity_id)
);

CREATE TABLE prov_was_attributed_to (
    entity_id INT REFERENCES prov_entities(entity_id),
    agent_id INT REFERENCES prov_agents(agent_id),
    attributed_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (entity_id, agent_id)
);

CREATE TABLE prov_was_derived_from (
    derived_entity_id INT REFERENCES prov_entities(entity_id),
    source_entity_id INT REFERENCES prov_entities(entity_id),
    derivation_type VARCHAR(50),  -- 'join', 'filter', 'aggregate'
    PRIMARY KEY (derived_entity_id, source_entity_id)
);
```

### 2.3 è¡€ç¼˜åˆ†æåŸç†

#### **è¡€ç¼˜ç±»å‹**

**1. è¡¨çº§è¡€ç¼˜**:

```sql
-- æŸ¥è¯¢è¡¨ä¹‹é—´çš„ä¾èµ–å…³ç³»
WITH RECURSIVE table_lineage AS (
    -- èµ·ç‚¹ï¼šç›®æ ‡è¡¨
    SELECT
        target_table AS table_name,
        0 AS level,
        ARRAY[target_table] AS path
    FROM table_dependencies
    WHERE target_table = 'sales_report'

    UNION

    -- é€’å½’ï¼šä¸Šæ¸¸è¡¨
    SELECT
        td.source_table,
        tl.level + 1,
        tl.path || td.source_table
    FROM table_dependencies td
    JOIN table_lineage tl ON td.target_table = tl.table_name
    WHERE td.source_table != ALL(tl.path)  -- é¿å…å¾ªç¯
      AND tl.level < 10
)
SELECT * FROM table_lineage
ORDER BY level;

-- ç»“æœï¼š
-- sales_report (level 0)
--   â”œâ”€ sales_fact (level 1)
--   â”‚   â”œâ”€ orders (level 2)
--   â”‚   â””â”€ products (level 2)
--   â””â”€ customers (level 1)
```

**2. å­—æ®µçº§è¡€ç¼˜**:

```sql
-- è¿½è¸ªå­—æ®µçš„æ•°æ®æ¥æº
CREATE TABLE column_lineage (
    target_table VARCHAR(100),
    target_column VARCHAR(100),
    source_table VARCHAR(100),
    source_column VARCHAR(100),
    transformation TEXT,  -- SQLè¡¨è¾¾å¼
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç¤ºä¾‹ï¼šsales_report.total_amountçš„è¡€ç¼˜
INSERT INTO column_lineage VALUES
('sales_report', 'total_amount', 'orders', 'amount', 'SUM(amount)', NOW()),
('sales_report', 'total_amount', 'order_items', 'quantity', 'SUM(quantity * price)', NOW());
```

**3. è¡Œçº§è¡€ç¼˜**:

```sql
-- è¿½è¸ªæ¯ä¸€è¡Œæ•°æ®çš„æ¥æº
CREATE TABLE row_provenance (
    target_table VARCHAR(100),
    target_row_id BIGINT,
    source_table VARCHAR(100),
    source_row_id BIGINT,
    operation VARCHAR(50),  -- 'join', 'filter', 'aggregate'
    timestamp TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.4 å‰æ²¿ç ”ç©¶ ProvSQL

**è®ºæ–‡**: *ProvSQL: Provenance and Probability Management in PostgreSQL* (arXiv:2504.12058)

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- ğŸ¯ **åŠç¯æº¯æº**: ä½¿ç”¨åŠç¯ä»£æ•°è¿½è¸ªæ•°æ®æ¥æº
- ğŸ¯ **æ¦‚ç‡æº¯æº**: æ”¯æŒä¸ç¡®å®šæ•°æ®çš„æº¯æº
- ğŸ¯ **Whyæº¯æº**: è§£é‡Šä¸ºä»€ä¹ˆæŸä¸ªå…ƒç»„åœ¨ç»“æœä¸­

**å®‰è£…ProvSQL**ï¼š

```bash
# ç¼–è¯‘å®‰è£…ï¼ˆéœ€è¦PostgreSQLæºç ï¼‰
git clone https://github.com/PierreSenellart/provsql.git
cd provsql
make
sudo make install
```

```sql
-- å¯ç”¨ProvSQL
CREATE EXTENSION provsql;

-- ä¸ºè¡¨å¯ç”¨æº¯æº
SELECT provsql.add_provenance('users');
SELECT provsql.add_provenance('orders');

-- æ‰§è¡ŒæŸ¥è¯¢å¹¶è·å–æº¯æº
SELECT *, provenance() AS prov
FROM users u
JOIN orders o ON u.user_id = o.user_id
WHERE o.amount > 1000;

-- æŸ¥è¯¢æº¯æºä¿¡æ¯
SELECT provsql.where_provenance(prov) FROM results;
```

---

## ä¸‰ã€æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æç³»ç»Ÿçš„æ•´ä½“æ¶æ„åŒ…æ‹¬æ•°æ®é‡‡é›†å±‚ã€å­˜å‚¨å±‚ã€å¤„ç†å±‚ã€åˆ†æå±‚å’Œå±•ç¤ºå±‚ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜ç³»ç»Ÿçš„æ•´ä½“æ¶æ„è®¾è®¡ã€‚

**ç³»ç»Ÿæ¶æ„**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®æº<br/>Data Sources] --> B[æ•°æ®é‡‡é›†å±‚<br/>Collection Layer]
    B --> C[æº¯æºæ•°æ®å­˜å‚¨<br/>Provenance Storage]
    C --> D[è¡€ç¼˜è¿½è¸ªå¼•æ“<br/>Lineage Engine]
    D --> E[åˆ†æå¤„ç†å±‚<br/>Analysis Layer]
    E --> F[å¯è§†åŒ–å±•ç¤º<br/>Visualization]

    A --> A1[PostgreSQL<br/>æ•°æ®åº“]
    A --> A2[ETLå·¥å…·<br/>ETL Tools]
    A --> A3[åº”ç”¨ç³»ç»Ÿ<br/>Applications]

    B --> B1[SQLè§£æå™¨<br/>SQL Parser]
    B --> B2[å˜æ›´æ•è·<br/>Change Capture]
    B --> B3[æ—¥å¿—åˆ†æ<br/>Log Analysis]

    C --> C1[PROV-DMæ¨¡å‹<br/>PROV-DM Model]
    C --> C2[è¡€ç¼˜å…³ç³»è¡¨<br/>Lineage Tables]
    C --> C3[å…ƒæ•°æ®å­˜å‚¨<br/>Metadata Storage]

    D --> D1[æ­£å‘è¿½è¸ª<br/>Forward Tracking]
    D --> D2[åå‘è¿½è¸ª<br/>Backward Tracking]
    D --> D3[å½±å“åˆ†æ<br/>Impact Analysis]

    E --> E1[è¡€ç¼˜æŸ¥è¯¢<br/>Lineage Query]
    E --> E2[ä¾èµ–åˆ†æ<br/>Dependency Analysis]
    E --> E3[å½±å“è¯„ä¼°<br/>Impact Assessment]

    F --> F1[è¡€ç¼˜å›¾è°±<br/>Lineage Graph]
    F --> F2[ä¾èµ–æ ‘<br/>Dependency Tree]
    F --> F3[å½±å“æŠ¥å‘Š<br/>Impact Report]

    style A fill:#FFD700
    style C fill:#87CEEB
    style D fill:#90EE90
    style F fill:#FFA500
```

**æ¶æ„ç»„ä»¶**ï¼š

**1. æ•°æ®é‡‡é›†å±‚**

æ•°æ®é‡‡é›†å±‚è´Ÿè´£ä»å„ç§æ•°æ®æºé‡‡é›†æ•°æ®å˜æ›´å’Œå¤„ç†ä¿¡æ¯ï¼š

- **SQLè§£æå™¨**ï¼šè§£æSQLè¯­å¥ï¼Œæå–æ•°æ®ä¾èµ–å…³ç³»
- **å˜æ›´æ•è·**ï¼šæ•è·æ•°æ®åº“å˜æ›´ï¼ˆCDCï¼‰ï¼Œè®°å½•æ•°æ®å˜æ›´å†å²
- **æ—¥å¿—åˆ†æ**ï¼šåˆ†ææ•°æ®åº“æ—¥å¿—ï¼Œæå–æ•°æ®å¤„ç†ä¿¡æ¯

**2. æº¯æºæ•°æ®å­˜å‚¨**

æº¯æºæ•°æ®å­˜å‚¨ä½¿ç”¨PROV-DMæ¨¡å‹å­˜å‚¨æ•°æ®æº¯æºä¿¡æ¯ï¼š

- **PROV-DMæ¨¡å‹**ï¼šä½¿ç”¨W3C PROV-DMæ ‡å‡†æ¨¡å‹å­˜å‚¨æº¯æºä¿¡æ¯
- **è¡€ç¼˜å…³ç³»è¡¨**ï¼šå­˜å‚¨è¡¨çº§å’Œå­—æ®µçº§çš„è¡€ç¼˜å…³ç³»
- **å…ƒæ•°æ®å­˜å‚¨**ï¼šå­˜å‚¨æ•°æ®å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯

**3. è¡€ç¼˜è¿½è¸ªå¼•æ“**

è¡€ç¼˜è¿½è¸ªå¼•æ“æä¾›æ•°æ®è¡€ç¼˜è¿½è¸ªèƒ½åŠ›ï¼š

- **æ­£å‘è¿½è¸ª**ï¼šä»æ•°æ®æºè¿½è¸ªåˆ°æ•°æ®ç›®æ ‡
- **åå‘è¿½è¸ª**ï¼šä»æ•°æ®ç›®æ ‡è¿½æº¯åˆ°æ•°æ®æº
- **å½±å“åˆ†æ**ï¼šåˆ†ææ•°æ®å˜æ›´çš„å½±å“èŒƒå›´

**4. åˆ†æå¤„ç†å±‚**

åˆ†æå¤„ç†å±‚æä¾›æ•°æ®è¡€ç¼˜åˆ†æèƒ½åŠ›ï¼š

- **è¡€ç¼˜æŸ¥è¯¢**ï¼šæŸ¥è¯¢æ•°æ®è¡€ç¼˜å…³ç³»
- **ä¾èµ–åˆ†æ**ï¼šåˆ†ææ•°æ®ä¾èµ–å…³ç³»
- **å½±å“è¯„ä¼°**ï¼šè¯„ä¼°æ•°æ®å˜æ›´çš„å½±å“

**5. å¯è§†åŒ–å±•ç¤º**

å¯è§†åŒ–å±•ç¤ºå±‚æä¾›æ•°æ®è¡€ç¼˜çš„å¯è§†åŒ–å±•ç¤ºï¼š

- **è¡€ç¼˜å›¾è°±**ï¼šå¯è§†åŒ–å±•ç¤ºæ•°æ®è¡€ç¼˜å…³ç³»
- **ä¾èµ–æ ‘**ï¼šå±•ç¤ºæ•°æ®ä¾èµ–æ ‘ç»“æ„
- **å½±å“æŠ¥å‘Š**ï¼šç”Ÿæˆæ•°æ®å½±å“åˆ†ææŠ¥å‘Š

### 3.2 æº¯æºæ•°æ®å­˜å‚¨

æº¯æºæ•°æ®å­˜å‚¨æ˜¯æ•°æ®æº¯æºç³»ç»Ÿçš„æ ¸å¿ƒï¼Œéœ€è¦é«˜æ•ˆã€å¯é åœ°å­˜å‚¨æ•°æ®æº¯æºä¿¡æ¯ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜æº¯æºæ•°æ®å­˜å‚¨çš„è®¾è®¡å’Œå®ç°ã€‚

**å­˜å‚¨æ¨¡å‹è®¾è®¡**ï¼š

```sql
-- 1. PROV-DMæ¨¡å‹å®ç°
-- Entityï¼ˆå®ä½“ï¼‰è¡¨
CREATE TABLE provenance_entities (
    entity_id VARCHAR(100) PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,  -- 'table', 'column', 'row', 'value'
    entity_name VARCHAR(200),
    entity_attributes JSONB,  -- å®ä½“å±æ€§
    created_at TIMESTAMP DEFAULT NOW()
);

-- Activityï¼ˆæ´»åŠ¨ï¼‰è¡¨
CREATE TABLE provenance_activities (
    activity_id VARCHAR(100) PRIMARY KEY,
    activity_type VARCHAR(50) NOT NULL,  -- 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'TRANSFORM'
    activity_name VARCHAR(200),
    activity_time TIMESTAMP NOT NULL,
    activity_attributes JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Agentï¼ˆä»£ç†ï¼‰è¡¨
CREATE TABLE provenance_agents (
    agent_id VARCHAR(100) PRIMARY KEY,
    agent_type VARCHAR(50) NOT NULL,  -- 'user', 'system', 'application'
    agent_name VARCHAR(200),
    agent_attributes JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å…³ç³»è¡¨
CREATE TABLE provenance_was_generated_by (
    entity_id VARCHAR(100) REFERENCES provenance_entities(entity_id),
    activity_id VARCHAR(100) REFERENCES provenance_activities(activity_id),
    generation_time TIMESTAMP,
    PRIMARY KEY (entity_id, activity_id)
);

CREATE TABLE provenance_was_derived_from (
    generated_entity_id VARCHAR(100) REFERENCES provenance_entities(entity_id),
    used_entity_id VARCHAR(100) REFERENCES provenance_entities(entity_id),
    activity_id VARCHAR(100) REFERENCES provenance_activities(activity_id),
    derivation_type VARCHAR(50),  -- 'copy', 'transform', 'aggregate'
    PRIMARY KEY (generated_entity_id, used_entity_id, activity_id)
);

CREATE TABLE provenance_was_attributed_to (
    entity_id VARCHAR(100) REFERENCES provenance_entities(entity_id),
    agent_id VARCHAR(100) REFERENCES provenance_agents(agent_id),
    attribution_time TIMESTAMP,
    PRIMARY KEY (entity_id, agent_id)
);

CREATE TABLE provenance_was_informed_by (
    informed_activity_id VARCHAR(100) REFERENCES provenance_activities(activity_id),
    informant_activity_id VARCHAR(100) REFERENCES provenance_activities(activity_id),
    PRIMARY KEY (informed_activity_id, informant_activity_id)
);

CREATE TABLE provenance_used (
    activity_id VARCHAR(100) REFERENCES provenance_activities(activity_id),
    entity_id VARCHAR(100) REFERENCES provenance_entities(entity_id),
    usage_time TIMESTAMP,
    PRIMARY KEY (activity_id, entity_id)
);

-- 2. è¡€ç¼˜å…³ç³»è¡¨ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰
CREATE TABLE data_lineage (
    lineage_id SERIAL PRIMARY KEY,
    source_schema VARCHAR(100),
    source_table VARCHAR(100),
    source_column VARCHAR(100),
    target_schema VARCHAR(100),
    target_table VARCHAR(100),
    target_column VARCHAR(100),
    transformation_type VARCHAR(50),  -- 'copy', 'transform', 'aggregate', 'join'
    transformation_details JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(source_schema, source_table, source_column,
           target_schema, target_table, target_column)
);

-- 3. åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_lineage_source ON data_lineage(source_schema, source_table, source_column);
CREATE INDEX idx_lineage_target ON data_lineage(target_schema, target_table, target_column);
CREATE INDEX idx_lineage_transformation ON data_lineage(transformation_type);
CREATE INDEX idx_entities_type ON provenance_entities(entity_type);
CREATE INDEX idx_activities_type ON provenance_activities(activity_type);
CREATE INDEX idx_activities_time ON provenance_activities(activity_time);
```

**å­˜å‚¨ä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- 1. æ•°æ®åˆ†åŒºï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE provenance_activities (
    activity_id VARCHAR(100),
    activity_type VARCHAR(50),
    activity_time TIMESTAMP,
    activity_attributes JSONB,
    created_at TIMESTAMP DEFAULT NOW()
) PARTITION BY RANGE (activity_time);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE provenance_activities_2024_01 PARTITION OF provenance_activities
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE provenance_activities_2024_02 PARTITION OF provenance_activities
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- 2. æ•°æ®å‹ç¼©ï¼ˆä½¿ç”¨TOASTï¼‰
ALTER TABLE provenance_entities ALTER COLUMN entity_attributes SET STORAGE EXTENDED;
ALTER TABLE provenance_activities ALTER COLUMN activity_attributes SET STORAGE EXTENDED;

-- 3. å½’æ¡£ç­–ç•¥
CREATE TABLE provenance_activities_archive (
    LIKE provenance_activities INCLUDING ALL
);

-- å½’æ¡£å‡½æ•°
CREATE OR REPLACE FUNCTION archive_old_provenance()
RETURNS VOID AS $$
BEGIN
    INSERT INTO provenance_activities_archive
    SELECT * FROM provenance_activities
    WHERE activity_time < NOW() - INTERVAL '1 year';

    DELETE FROM provenance_activities
    WHERE activity_time < NOW() - INTERVAL '1 year';
END;
$$ LANGUAGE plpgsql;
```

### 3.3 è¡€ç¼˜è¿½è¸ªæœºåˆ¶

è¡€ç¼˜è¿½è¸ªæœºåˆ¶æ˜¯æ•°æ®æº¯æºç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›æ•°æ®è¡€ç¼˜çš„è¿½è¸ªå’Œåˆ†æèƒ½åŠ›ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜è¡€ç¼˜è¿½è¸ªæœºåˆ¶çš„å®ç°ã€‚

**æ­£å‘è¿½è¸ªï¼ˆForward Trackingï¼‰**ï¼š

```sql
-- æ­£å‘è¿½è¸ªï¼šä»æ•°æ®æºè¿½è¸ªåˆ°æ•°æ®ç›®æ ‡
CREATE OR REPLACE FUNCTION forward_track_lineage(
    p_source_schema VARCHAR(100),
    p_source_table VARCHAR(100),
    p_source_column VARCHAR(100),
    p_max_depth INTEGER DEFAULT 10
) RETURNS TABLE (
    level INTEGER,
    schema_name VARCHAR(100),
    table_name VARCHAR(100),
    column_name VARCHAR(100),
    transformation_type VARCHAR(50),
    path TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE lineage_path AS (
        -- èµ·å§‹èŠ‚ç‚¹
        SELECT
            1 AS level,
            p_source_schema AS schema_name,
            p_source_table AS table_name,
            p_source_column AS column_name,
            ''::VARCHAR(50) AS transformation_type,
            format('%s.%s.%s', p_source_schema, p_source_table, p_source_column) AS path

        UNION ALL

        -- é€’å½’æŸ¥è¯¢ä¸‹æ¸¸ä¾èµ–
        SELECT
            lp.level + 1,
            dl.target_schema,
            dl.target_table,
            dl.target_column,
            dl.transformation_type,
            format('%s -> %s.%s.%s',
                   lp.path,
                   dl.target_schema,
                   dl.target_table,
                   dl.target_column) AS path
        FROM data_lineage dl
        JOIN lineage_path lp ON (
            dl.source_schema = lp.schema_name AND
            dl.source_table = lp.table_name AND
            dl.source_column = lp.column_name
        )
        WHERE lp.level < p_max_depth
    )
    SELECT * FROM lineage_path
    ORDER BY level, schema_name, table_name, column_name;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM forward_track_lineage('public', 'orders', 'order_id', 5);
```

**åå‘è¿½è¸ªï¼ˆBackward Trackingï¼‰**ï¼š

```sql
-- åå‘è¿½è¸ªï¼šä»æ•°æ®ç›®æ ‡è¿½æº¯åˆ°æ•°æ®æº
CREATE OR REPLACE FUNCTION backward_track_lineage(
    p_target_schema VARCHAR(100),
    p_target_table VARCHAR(100),
    p_target_column VARCHAR(100),
    p_max_depth INTEGER DEFAULT 10
) RETURNS TABLE (
    level INTEGER,
    schema_name VARCHAR(100),
    table_name VARCHAR(100),
    column_name VARCHAR(100),
    transformation_type VARCHAR(50),
    path TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE lineage_path AS (
        -- èµ·å§‹èŠ‚ç‚¹
        SELECT
            1 AS level,
            p_target_schema AS schema_name,
            p_target_table AS table_name,
            p_target_column AS column_name,
            ''::VARCHAR(50) AS transformation_type,
            format('%s.%s.%s', p_target_schema, p_target_table, p_target_column) AS path

        UNION ALL

        -- é€’å½’æŸ¥è¯¢ä¸Šæ¸¸ä¾èµ–
        SELECT
            lp.level + 1,
            dl.source_schema,
            dl.source_table,
            dl.source_column,
            dl.transformation_type,
            format('%s.%s.%s -> %s',
                   dl.source_schema,
                   dl.source_table,
                   dl.source_column,
                   lp.path) AS path
        FROM data_lineage dl
        JOIN lineage_path lp ON (
            dl.target_schema = lp.schema_name AND
            dl.target_table = lp.table_name AND
            dl.target_column = lp.column_name
        )
        WHERE lp.level < p_max_depth
    )
    SELECT * FROM lineage_path
    ORDER BY level DESC, schema_name, table_name, column_name;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM backward_track_lineage('public', 'monthly_report', 'total_revenue', 5);
```

**å½±å“åˆ†æï¼ˆImpact Analysisï¼‰**ï¼š

```sql
-- å½±å“åˆ†æï¼šåˆ†ææ•°æ®å˜æ›´çš„å½±å“èŒƒå›´
CREATE OR REPLACE FUNCTION analyze_impact(
    p_schema_name VARCHAR(100),
    p_table_name VARCHAR(100),
    p_column_name VARCHAR(100) DEFAULT NULL
) RETURNS TABLE (
    impact_level VARCHAR(20),
    schema_name VARCHAR(100),
    table_name VARCHAR(100),
    column_name VARCHAR(100),
    impact_type VARCHAR(50),
    description TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH impact_analysis AS (
        SELECT
            CASE
                WHEN dl.transformation_type IN ('copy', 'direct') THEN 'HIGH'
                WHEN dl.transformation_type IN ('transform', 'aggregate') THEN 'MEDIUM'
                ELSE 'LOW'
            END AS impact_level,
            dl.target_schema AS schema_name,
            dl.target_table AS table_name,
            dl.target_column AS column_name,
            dl.transformation_type AS impact_type,
            format('æ•°æ®å˜æ›´ä¼šå½±å“ %s.%s.%sï¼Œè½¬æ¢ç±»å‹ï¼š%s',
                   dl.target_schema, dl.target_table, dl.target_column,
                   dl.transformation_type) AS description
        FROM data_lineage dl
        WHERE dl.source_schema = p_schema_name
          AND dl.source_table = p_table_name
          AND (p_column_name IS NULL OR dl.source_column = p_column_name)
    )
    SELECT * FROM impact_analysis
    ORDER BY
        CASE impact_level
            WHEN 'HIGH' THEN 1
            WHEN 'MEDIUM' THEN 2
            WHEN 'LOW' THEN 3
        END,
        schema_name, table_name, column_name;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM analyze_impact('public', 'orders', 'order_id');
```

### 3.4 å¯è§†åŒ–ç³»ç»Ÿ

å¯è§†åŒ–ç³»ç»Ÿæä¾›æ•°æ®è¡€ç¼˜çš„å¯è§†åŒ–å±•ç¤ºï¼Œå¸®åŠ©ç”¨æˆ·ç›´è§‚ç†è§£æ•°æ®æµè½¬å’Œä¾èµ–å…³ç³»ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜å¯è§†åŒ–ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°ã€‚

**è¡€ç¼˜å›¾è°±ç”Ÿæˆ**ï¼š

```sql
-- ç”Ÿæˆè¡€ç¼˜å›¾è°±æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
CREATE OR REPLACE FUNCTION generate_lineage_graph(
    p_root_schema VARCHAR(100),
    p_root_table VARCHAR(100),
    p_root_column VARCHAR(100),
    p_direction VARCHAR(10) DEFAULT 'both'  -- 'forward', 'backward', 'both'
) RETURNS JSONB AS $$
DECLARE
    v_nodes JSONB := '[]'::JSONB;
    v_edges JSONB := '[]'::JSONB;
    v_node JSONB;
    v_edge JSONB;
BEGIN
    -- æ·»åŠ æ ¹èŠ‚ç‚¹
    v_node := jsonb_build_object(
        'id', format('%s.%s.%s', p_root_schema, p_root_table, p_root_column),
        'label', format('%s.%s.%s', p_root_schema, p_root_table, p_root_column),
        'type', 'root',
        'schema', p_root_schema,
        'table', p_root_table,
        'column', p_root_column
    );
    v_nodes := v_nodes || jsonb_build_array(v_node);

    -- æ·»åŠ ä¸‹æ¸¸èŠ‚ç‚¹å’Œè¾¹ï¼ˆæ­£å‘è¿½è¸ªï¼‰
    IF p_direction IN ('forward', 'both') THEN
        FOR v_node, v_edge IN
            SELECT
                jsonb_build_object(
                    'id', format('%s.%s.%s', target_schema, target_table, target_column),
                    'label', format('%s.%s.%s', target_schema, target_table, target_column),
                    'type', 'target',
                    'schema', target_schema,
                    'table', target_table,
                    'column', target_column
                ),
                jsonb_build_object(
                    'from', format('%s.%s.%s', p_root_schema, p_root_table, p_root_column),
                    'to', format('%s.%s.%s', target_schema, target_table, target_column),
                    'label', transformation_type,
                    'type', transformation_type
                )
            FROM forward_track_lineage(p_root_schema, p_root_table, p_root_column)
            WHERE level > 1
        LOOP
            v_nodes := v_nodes || jsonb_build_array(v_node);
            v_edges := v_edges || jsonb_build_array(v_edge);
        END LOOP;
    END IF;

    -- æ·»åŠ ä¸Šæ¸¸èŠ‚ç‚¹å’Œè¾¹ï¼ˆåå‘è¿½è¸ªï¼‰
    IF p_direction IN ('backward', 'both') THEN
        FOR v_node, v_edge IN
            SELECT
                jsonb_build_object(
                    'id', format('%s.%s.%s', schema_name, table_name, column_name),
                    'label', format('%s.%s.%s', schema_name, table_name, column_name),
                    'type', 'source',
                    'schema', schema_name,
                    'table', table_name,
                    'column', column_name
                ),
                jsonb_build_object(
                    'from', format('%s.%s.%s', schema_name, table_name, column_name),
                    'to', format('%s.%s.%s', p_root_schema, p_root_table, p_root_column),
                    'label', transformation_type,
                    'type', transformation_type
                )
            FROM backward_track_lineage(p_root_schema, p_root_table, p_root_column)
            WHERE level > 1
        LOOP
            v_nodes := v_nodes || jsonb_build_array(v_node);
            v_edges := v_edges || jsonb_build_array(v_edge);
        END LOOP;
    END IF;

    -- è¿”å›å›¾è°±æ•°æ®
    RETURN jsonb_build_object(
        'nodes', v_nodes,
        'edges', v_edges
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT generate_lineage_graph('public', 'orders', 'order_id', 'both');
```

**å¯è§†åŒ–APIæ¥å£**ï¼š

```python
# visualization_api.py
from flask import Flask, jsonify
import psycopg2
import json

app = Flask(__name__)

def get_db_connection():
    """è·å–æ•°æ®åº“è¿æ¥"""
    return psycopg2.connect(
        host='localhost',
        database='provenance_db',
        user='provenance_user',
        password='secure_password'
    )

@app.route('/api/lineage/graph/<schema>/<table>/<column>')
def get_lineage_graph(schema, table, column):
    """è·å–è¡€ç¼˜å›¾è°±æ•°æ®"""
    conn = get_db_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT generate_lineage_graph(%s, %s, %s, 'both')
            """, (schema, table, column))
            result = cur.fetchone()[0]
            return jsonify(json.loads(result))
    finally:
        conn.close()

@app.route('/api/lineage/forward/<schema>/<table>/<column>')
def get_forward_lineage(schema, table, column):
    """è·å–æ­£å‘è¡€ç¼˜å…³ç³»"""
    conn = get_db_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT * FROM forward_track_lineage(%s, %s, %s, 10)
            """, (schema, table, column))
            columns = [desc[0] for desc in cur.description]
            results = [dict(zip(columns, row)) for row in cur.fetchall()]
            return jsonify(results)
    finally:
        conn.close()

@app.route('/api/lineage/backward/<schema>/<table>/<column>')
def get_backward_lineage(schema, table, column):
    """è·å–åå‘è¡€ç¼˜å…³ç³»"""
    conn = get_db_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT * FROM backward_track_lineage(%s, %s, %s, 10)
            """, (schema, table, column))
            columns = [desc[0] for desc in cur.description]
            results = [dict(zip(columns, row)) for row in cur.fetchall()]
            return jsonify(results)
    finally:
        conn.close()

@app.route('/api/impact/<schema>/<table>/<column>')
def get_impact_analysis(schema, table, column):
    """è·å–å½±å“åˆ†æ"""
    conn = get_db_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT * FROM analyze_impact(%s, %s, %s)
            """, (schema, table, column))
            columns = [desc[0] for desc in cur.description]
            results = [dict(zip(columns, row)) for row in cur.fetchall()]
            return jsonify(results)
    finally:
        conn.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

---

## å››ã€ç¨‹åºè®¾è®¡

### 4.1 ç¯å¢ƒå‡†å¤‡

ç¯å¢ƒå‡†å¤‡æ˜¯æ•°æ®æº¯æºç³»ç»Ÿå®æ–½çš„ç¬¬ä¸€æ­¥ï¼Œéœ€è¦å®‰è£…å¿…è¦çš„æ‰©å±•ã€é…ç½®æ•°æ®åº“ã€è®¾ç½®æº¯æºè¡¨ç­‰ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜æ•°æ®æº¯æºç³»ç»Ÿçš„ç¯å¢ƒå‡†å¤‡æ­¥éª¤ã€‚

**PostgreSQLæ‰©å±•å®‰è£…**ï¼š

```sql
-- 1. å®‰è£…ProvSQLæ‰©å±•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
-- æ³¨æ„ï¼šProvSQLéœ€è¦ä»æºç ç¼–è¯‘å®‰è£…
-- CREATE EXTENSION IF NOT EXISTS provsql;

-- 2. å®‰è£…pgcryptoæ‰©å±•ï¼ˆç”¨äºæ•°æ®åŠ å¯†ï¼‰
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 3. å®‰è£…pg_stat_statementsæ‰©å±•ï¼ˆç”¨äºæŸ¥è¯¢ç»Ÿè®¡ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

**æ•°æ®åº“é…ç½®**ï¼š

```sql
-- 1. åˆ›å»ºæº¯æºæ•°æ®åº“
CREATE DATABASE provenance_db;

-- 2. åˆ›å»ºç”¨æˆ·å’Œè§’è‰²
CREATE USER provenance_user WITH PASSWORD 'secure_password_123';
CREATE ROLE provenance_admin;
CREATE ROLE provenance_readonly;

-- 3. æˆäºˆæƒé™
GRANT CONNECT ON DATABASE provenance_db TO provenance_user;
GRANT provenance_readonly TO provenance_user;

-- 4. åˆ›å»ºSchema
\c provenance_db
CREATE SCHEMA provenance;
GRANT USAGE ON SCHEMA provenance TO provenance_readonly;
GRANT ALL ON SCHEMA provenance TO provenance_admin;
```

**æº¯æºè¡¨åˆ›å»º**ï¼š

```sql
-- åˆ›å»ºæº¯æºè¡¨ï¼ˆä½¿ç”¨å‰é¢å®šä¹‰çš„PROV-DMæ¨¡å‹ï¼‰
-- å‚è§3.2èŠ‚ï¼šæº¯æºæ•°æ®å­˜å‚¨

-- åˆ›å»ºè¡€ç¼˜å…³ç³»è¡¨
CREATE TABLE IF NOT EXISTS data_lineage (
    lineage_id SERIAL PRIMARY KEY,
    source_schema VARCHAR(100),
    source_table VARCHAR(100),
    source_column VARCHAR(100),
    target_schema VARCHAR(100),
    target_table VARCHAR(100),
    target_column VARCHAR(100),
    transformation_type VARCHAR(50),
    transformation_details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_lineage_source
    ON data_lineage(source_schema, source_table, source_column);
CREATE INDEX IF NOT EXISTS idx_lineage_target
    ON data_lineage(target_schema, target_table, target_column);
```

**Pythonç¯å¢ƒå‡†å¤‡**ï¼š

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv provenance_env
source provenance_env/bin/activate  # Linux/Mac
# provenance_env\Scripts\activate  # Windows

# 2. å®‰è£…ä¾èµ–
pip install psycopg2-binary==2.9.9
pip install flask==3.0.0
pip install networkx==3.2.1  # ç”¨äºè¡€ç¼˜å›¾è°±å¯è§†åŒ–
pip install matplotlib==3.8.2  # ç”¨äºå›¾è¡¨ç»˜åˆ¶
pip install pandas==2.0.3
pip install sqlparse==0.4.4  # ç”¨äºSQLè§£æ
```

**é…ç½®æ–‡ä»¶**ï¼š

```python
# config.py
import os

DATABASE_CONFIG = {
    'host': os.getenv('DB_HOST', 'localhost'),
    'port': int(os.getenv('DB_PORT', 5432)),
    'database': os.getenv('DB_NAME', 'provenance_db'),
    'user': os.getenv('DB_USER', 'provenance_user'),
    'password': os.getenv('DB_PASSWORD', 'secure_password_123')
}

PROVENANCE_CONFIG = {
    'enable_tracking': os.getenv('ENABLE_TRACKING', 'true').lower() == 'true',
    'track_select': os.getenv('TRACK_SELECT', 'true').lower() == 'true',
    'track_insert': os.getenv('TRACK_INSERT', 'true').lower() == 'true',
    'track_update': os.getenv('TRACK_UPDATE', 'true').lower() == 'true',
    'track_delete': os.getenv('TRACK_DELETE', 'true').lower() == 'true',
    'max_lineage_depth': int(os.getenv('MAX_LINEAGE_DEPTH', 10))
}
```

### 4.2 åŸºç¡€æº¯æºå®ç°

```python
# provenance_tracker.py
import psycopg2
from datetime import datetime
import json

class ProvenanceTracker:
    """æ•°æ®æº¯æºè¿½è¸ªå™¨"""

    def __init__(self, conn):
        self.conn = conn
        self._ensure_provenance_tables()

    def _ensure_provenance_tables(self):
        """ç¡®ä¿æº¯æºè¡¨å­˜åœ¨"""
        with self.conn.cursor() as cur:
            # åˆ›å»ºæº¯æºè¡¨ï¼ˆå¦‚å‰é¢PROV-DMæ¨¡å‹ï¼‰
            cur.execute("""
                CREATE TABLE IF NOT EXISTS data_lineage (
                    lineage_id SERIAL PRIMARY KEY,
                    source_table VARCHAR(100),
                    source_row_id BIGINT,
                    target_table VARCHAR(100),
                    target_row_id BIGINT,
                    operation VARCHAR(50),
                    sql_query TEXT,
                    executed_by VARCHAR(100),
                    executed_at TIMESTAMPTZ DEFAULT NOW()
                );
            """)
            self.conn.commit()

    def track_insert(
        self,
        target_table: str,
        target_row_id: int,
        source_info: dict,
        executed_by: str
    ):
        """è¿½è¸ªINSERTæ“ä½œ"""
        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO data_lineage
                (source_table, source_row_id, target_table, target_row_id,
                 operation, executed_by)
                VALUES (%s, %s, %s, %s, 'INSERT', %s)
            """, (
                source_info.get('table'),
                source_info.get('row_id'),
                target_table,
                target_row_id,
                executed_by
            ))
        self.conn.commit()

    def track_update(
        self,
        table: str,
        row_id: int,
        old_values: dict,
        new_values: dict,
        executed_by: str
    ):
        """è¿½è¸ªUPDATEæ“ä½œ"""
        lineage_record = {
            'table': table,
            'row_id': row_id,
            'old_values': old_values,
            'new_values': new_values,
            'executed_by': executed_by,
            'timestamp': datetime.now().isoformat()
        }

        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO data_lineage
                (target_table, target_row_id, operation, sql_query, executed_by)
                VALUES (%s, %s, 'UPDATE', %s, %s)
            """, (table, row_id, json.dumps(lineage_record), executed_by))
        self.conn.commit()

    def query_lineage(self, table: str, row_id: int):
        """æŸ¥è¯¢æ•°æ®è¡€ç¼˜"""
        with self.conn.cursor() as cur:
            cur.execute("""
                WITH RECURSIVE lineage AS (
                    -- èµ·ç‚¹
                    SELECT
                        lineage_id,
                        source_table,
                        source_row_id,
                        target_table,
                        target_row_id,
                        operation,
                        executed_by,
                        executed_at,
                        1 AS level,
                        ARRAY[lineage_id] AS path
                    FROM data_lineage
                    WHERE target_table = %s AND target_row_id = %s

                    UNION

                    -- é€’å½’ï¼šè¿½æº¯ä¸Šæ¸¸
                    SELECT
                        dl.lineage_id,
                        dl.source_table,
                        dl.source_row_id,
                        dl.target_table,
                        dl.target_row_id,
                        dl.operation,
                        dl.executed_by,
                        dl.executed_at,
                        l.level + 1,
                        l.path || dl.lineage_id
                    FROM data_lineage dl
                    JOIN lineage l ON dl.target_table = l.source_table
                                   AND dl.target_row_id = l.source_row_id
                    WHERE NOT (dl.lineage_id = ANY(l.path))
                      AND l.level < 10
                )
                SELECT * FROM lineage ORDER BY level;
            """, (table, row_id))

            return cur.fetchall()
```

### 4.3 ProvSQLé›†æˆ

ProvSQLæ˜¯PostgreSQLçš„æ‰©å±•ï¼Œæä¾›äº†æ ‡å‡†åŒ–çš„æ•°æ®æº¯æºåŠŸèƒ½ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜ProvSQLçš„é›†æˆæ–¹æ³•å’Œä½¿ç”¨ã€‚

**ProvSQLå®‰è£…**ï¼š

```bash
# 1. å…‹éš†ProvSQLä»“åº“
git clone https://github.com/PierreSenellart/provsql.git
cd provsql

# 2. ç¼–è¯‘å®‰è£…
make
sudo make install

# 3. åœ¨PostgreSQLä¸­å¯ç”¨æ‰©å±•
psql -d provenance_db -c "CREATE EXTENSION provsql;"
```

**ProvSQLä½¿ç”¨**ï¼š

```sql
-- 1. å¯ç”¨æº¯æºè¿½è¸ª
SET provsql.enable = on;

-- 2. åˆ›å»ºæº¯æºè¡¨
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER,
    amount DECIMAL(10, 2),
    order_date DATE
);

-- 3. æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨è®°å½•æº¯æºï¼‰
INSERT INTO orders (customer_id, amount, order_date)
VALUES (1, 100.00, '2024-01-01');

-- 4. æŸ¥è¯¢æº¯æºä¿¡æ¯
SELECT provsql.provenance_of('orders', 'order_id', 1);

-- 5. æŸ¥è¯¢æ•°æ®æ¥æº
SELECT provsql.where_provenance_of('orders', 'order_id', 1);

-- 6. æŸ¥è¯¢æ•°æ®è½¬æ¢è¿‡ç¨‹
SELECT provsql.how_provenance_of('orders', 'order_id', 1);
```

**ProvSQLä¸è‡ªå®šä¹‰æº¯æºé›†æˆ**ï¼š

```sql
-- å°†ProvSQLçš„æº¯æºä¿¡æ¯åŒæ­¥åˆ°è‡ªå®šä¹‰æº¯æºè¡¨
CREATE OR REPLACE FUNCTION sync_provsql_lineage()
RETURNS TRIGGER AS $$
DECLARE
    v_provenance JSONB;
BEGIN
    -- è·å–ProvSQLæº¯æºä¿¡æ¯
    SELECT provsql.provenance_of(TG_TABLE_NAME, 'id', NEW.id)
    INTO v_provenance;

    -- åŒæ­¥åˆ°è‡ªå®šä¹‰æº¯æºè¡¨
    INSERT INTO data_lineage (
        source_schema, source_table, source_column,
        target_schema, target_table, target_column,
        transformation_type, transformation_details
    )
    SELECT
        (v_provenance->>'source_schema')::VARCHAR,
        (v_provenance->>'source_table')::VARCHAR,
        (v_provenance->>'source_column')::VARCHAR,
        TG_TABLE_SCHEMA,
        TG_TABLE_NAME,
        'id',
        (v_provenance->>'transformation_type')::VARCHAR,
        v_provenance->'transformation_details'
    WHERE v_provenance IS NOT NULL;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åœ¨è¡¨ä¸Šåˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER sync_provenance_trigger
    AFTER INSERT OR UPDATE ON orders
    FOR EACH ROW
    EXECUTE FUNCTION sync_provsql_lineage();
```

### 4.4 è¡€ç¼˜åˆ†æå·¥å…·

è¡€ç¼˜åˆ†æå·¥å…·æä¾›äº†æ•°æ®è¡€ç¼˜çš„æŸ¥è¯¢ã€åˆ†æå’Œå¯è§†åŒ–åŠŸèƒ½ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜è¡€ç¼˜åˆ†æå·¥å…·çš„å®ç°å’Œä½¿ç”¨ã€‚

**è¡€ç¼˜æŸ¥è¯¢å·¥å…·**ï¼š

```python
# lineage_query_tool.py
import psycopg2
from psycopg2.extras import RealDictCursor
import json

class LineageQueryTool:
    """è¡€ç¼˜æŸ¥è¯¢å·¥å…·"""

    def __init__(self, db_config):
        self.conn = psycopg2.connect(**db_config)

    def query_forward_lineage(self, schema, table, column, max_depth=10):
        """æŸ¥è¯¢æ­£å‘è¡€ç¼˜å…³ç³»"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                SELECT * FROM forward_track_lineage(%s, %s, %s, %s)
            """, (schema, table, column, max_depth))
            return cur.fetchall()

    def query_backward_lineage(self, schema, table, column, max_depth=10):
        """æŸ¥è¯¢åå‘è¡€ç¼˜å…³ç³»"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                SELECT * FROM backward_track_lineage(%s, %s, %s, %s)
            """, (schema, table, column, max_depth))
            return cur.fetchall()

    def analyze_impact(self, schema, table, column=None):
        """åˆ†æå½±å“èŒƒå›´"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                SELECT * FROM analyze_impact(%s, %s, %s)
            """, (schema, table, column))
            return cur.fetchall()

    def generate_lineage_graph(self, schema, table, column, direction='both'):
        """ç”Ÿæˆè¡€ç¼˜å›¾è°±æ•°æ®"""
        with self.conn.cursor() as cur:
            cur.execute("""
                SELECT generate_lineage_graph(%s, %s, %s, %s)
            """, (schema, table, column, direction))
            result = cur.fetchone()[0]
            return json.loads(result)

    def close(self):
        """å…³é—­è¿æ¥"""
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    tool = LineageQueryTool({
        'host': 'localhost',
        'database': 'provenance_db',
        'user': 'provenance_user',
        'password': 'secure_password_123'
    })

    # æŸ¥è¯¢æ­£å‘è¡€ç¼˜
    forward = tool.query_forward_lineage('public', 'orders', 'order_id')
    print("æ­£å‘è¡€ç¼˜å…³ç³»:")
    for row in forward:
        print(f"  Level {row['level']}: {row['schema_name']}.{row['table_name']}.{row['column_name']}")

    # æŸ¥è¯¢åå‘è¡€ç¼˜
    backward = tool.query_backward_lineage('public', 'monthly_report', 'total_revenue')
    print("\nåå‘è¡€ç¼˜å…³ç³»:")
    for row in backward:
        print(f"  Level {row['level']}: {row['schema_name']}.{row['table_name']}.{row['column_name']}")

    # åˆ†æå½±å“
    impact = tool.analyze_impact('public', 'orders', 'order_id')
    print("\nå½±å“åˆ†æ:")
    for row in impact:
        print(f"  {row['impact_level']}: {row['schema_name']}.{row['table_name']}.{row['column_name']}")

    tool.close()
```

**è¡€ç¼˜å¯è§†åŒ–å·¥å…·**ï¼š

```python
# lineage_visualization.py
import networkx as nx
import matplotlib.pyplot as plt
from lineage_query_tool import LineageQueryTool

class LineageVisualization:
    """è¡€ç¼˜å¯è§†åŒ–å·¥å…·"""

    def __init__(self, tool):
        self.tool = tool
        self.graph = nx.DiGraph()

    def build_graph(self, schema, table, column, direction='both'):
        """æ„å»ºè¡€ç¼˜å›¾è°±"""
        graph_data = self.tool.generate_lineage_graph(schema, table, column, direction)

        # æ·»åŠ èŠ‚ç‚¹
        for node in graph_data['nodes']:
            self.graph.add_node(
                node['id'],
                label=node['label'],
                type=node['type'],
                schema=node['schema'],
                table=node['table'],
                column=node['column']
            )

        # æ·»åŠ è¾¹
        for edge in graph_data['edges']:
            self.graph.add_edge(
                edge['from'],
                edge['to'],
                label=edge['label'],
                type=edge['type']
            )

    def visualize(self, output_file='lineage_graph.png'):
        """å¯è§†åŒ–è¡€ç¼˜å›¾è°±"""
        plt.figure(figsize=(16, 12))

        # è®¾ç½®å¸ƒå±€
        pos = nx.spring_layout(self.graph, k=2, iterations=50)

        # ç»˜åˆ¶èŠ‚ç‚¹
        node_colors = []
        for node in self.graph.nodes():
            node_type = self.graph.nodes[node]['type']
            if node_type == 'root':
                node_colors.append('#FFD700')  # é‡‘è‰²
            elif node_type == 'source':
                node_colors.append('#87CEEB')  # å¤©è“è‰²
            elif node_type == 'target':
                node_colors.append('#90EE90')  # æµ…ç»¿è‰²
            else:
                node_colors.append('#D3D3D3')  # æµ…ç°è‰²

        nx.draw_networkx_nodes(self.graph, pos, node_color=node_colors,
                               node_size=2000, alpha=0.8)

        # ç»˜åˆ¶è¾¹
        nx.draw_networkx_edges(self.graph, pos, edge_color='gray',
                              arrows=True, arrowsize=20, alpha=0.6)

        # ç»˜åˆ¶æ ‡ç­¾
        labels = {node: self.graph.nodes[node]['label'] for node in self.graph.nodes()}
        nx.draw_networkx_labels(self.graph, pos, labels, font_size=8)

        # ç»˜åˆ¶è¾¹æ ‡ç­¾
        edge_labels = {(u, v): self.graph[u][v]['label']
                      for u, v in self.graph.edges()}
        nx.draw_networkx_edge_labels(self.graph, pos, edge_labels, font_size=6)

        plt.title('æ•°æ®è¡€ç¼˜å…³ç³»å›¾', fontsize=16, fontweight='bold')
        plt.axis('off')
        plt.tight_layout()
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        plt.close()

        print(f"è¡€ç¼˜å›¾è°±å·²ä¿å­˜åˆ°: {output_file}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    tool = LineageQueryTool({
        'host': 'localhost',
        'database': 'provenance_db',
        'user': 'provenance_user',
        'password': 'secure_password_123'
    })

    viz = LineageVisualization(tool)
    viz.build_graph('public', 'orders', 'order_id', 'both')
    viz.visualize('orders_lineage.png')

    tool.close()
```

---

## äº”ã€è¿ç»´ç®¡ç†

### 5.1 æ€§èƒ½ä¼˜åŒ–

æ•°æ®æº¯æºç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–å¯¹äºå¤§è§„æ¨¡æ•°æ®ç¯å¢ƒè‡³å…³é‡è¦ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜æ•°æ®æº¯æºç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

**æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- 1. åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜è¡€ç¼˜å…³ç³»
CREATE MATERIALIZED VIEW lineage_summary AS
SELECT
    source_schema,
    source_table,
    source_column,
    target_schema,
    target_table,
    target_column,
    transformation_type,
    COUNT(*) AS transformation_count,
    MAX(created_at) AS last_transformation
FROM data_lineage
GROUP BY source_schema, source_table, source_column,
         target_schema, target_table, target_column,
         transformation_type;

CREATE UNIQUE INDEX idx_lineage_summary ON lineage_summary(
    source_schema, source_table, source_column,
    target_schema, target_table, target_column
);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY lineage_summary;

-- 2. åˆ›å»ºè¡€ç¼˜è·¯å¾„ç¼“å­˜è¡¨
CREATE TABLE lineage_path_cache (
    source_schema VARCHAR(100),
    source_table VARCHAR(100),
    source_column VARCHAR(100),
    target_schema VARCHAR(100),
    target_table VARCHAR(100),
    target_column VARCHAR(100),
    path_depth INTEGER,
    path_data JSONB,
    cached_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (source_schema, source_table, source_column,
                 target_schema, target_table, target_column)
);

-- 3. ä¼˜åŒ–è¡€ç¼˜æŸ¥è¯¢å‡½æ•°ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
CREATE OR REPLACE FUNCTION forward_track_lineage_cached(
    p_source_schema VARCHAR(100),
    p_source_table VARCHAR(100),
    p_source_column VARCHAR(100),
    p_max_depth INTEGER DEFAULT 10
) RETURNS TABLE (
    level INTEGER,
    schema_name VARCHAR(100),
    table_name VARCHAR(100),
    column_name VARCHAR(100),
    transformation_type VARCHAR(50),
    path TEXT
) AS $$
DECLARE
    v_cached_data JSONB;
BEGIN
    -- æ£€æŸ¥ç¼“å­˜
    SELECT path_data INTO v_cached_data
    FROM lineage_path_cache
    WHERE source_schema = p_source_schema
      AND source_table = p_source_table
      AND source_column = p_source_column
      AND cached_at > NOW() - INTERVAL '1 hour';

    IF v_cached_data IS NOT NULL THEN
        -- ä»ç¼“å­˜è¿”å›
        RETURN QUERY
        SELECT
            (value->>'level')::INTEGER,
            (value->>'schema_name')::VARCHAR(100),
            (value->>'table_name')::VARCHAR(100),
            (value->>'column_name')::VARCHAR(100),
            (value->>'transformation_type')::VARCHAR(50),
            (value->>'path')::TEXT
        FROM jsonb_array_elements(v_cached_data)
        WHERE (value->>'level')::INTEGER <= p_max_depth;
    ELSE
        -- è®¡ç®—å¹¶ç¼“å­˜
        RETURN QUERY
        SELECT * FROM forward_track_lineage(
            p_source_schema, p_source_table, p_source_column, p_max_depth
        );

        -- æ›´æ–°ç¼“å­˜
        INSERT INTO lineage_path_cache (
            source_schema, source_table, source_column,
            target_schema, target_table, target_column,
            path_depth, path_data
        )
        SELECT
            p_source_schema, p_source_table, p_source_column,
            target_schema, target_table, target_column,
            MAX(level), jsonb_agg(row_to_json(t))
        FROM forward_track_lineage(
            p_source_schema, p_source_table, p_source_column, p_max_depth
        ) t
        ON CONFLICT (source_schema, source_table, source_column,
                     target_schema, target_table, target_column)
        DO UPDATE SET
            path_data = EXCLUDED.path_data,
            cached_at = NOW();
    END IF;
END;
$$ LANGUAGE plpgsql;
```

**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- 1. åˆ›å»ºå¤åˆç´¢å¼•ä¼˜åŒ–è¡€ç¼˜æŸ¥è¯¢
CREATE INDEX idx_lineage_source_composite ON data_lineage(
    source_schema, source_table, source_column, transformation_type
);
CREATE INDEX idx_lineage_target_composite ON data_lineage(
    target_schema, target_table, target_column, transformation_type
);

-- 2. åˆ›å»ºGINç´¢å¼•ä¼˜åŒ–JSONBæŸ¥è¯¢
CREATE INDEX idx_lineage_transformation_details ON data_lineage
    USING GIN (transformation_details);

-- 3. åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
CREATE INDEX idx_lineage_recent ON data_lineage(created_at)
    WHERE created_at > NOW() - INTERVAL '30 days';
```

### 5.2 å­˜å‚¨ç®¡ç†

æ•°æ®æº¯æºç³»ç»Ÿçš„å­˜å‚¨ç®¡ç†å¯¹äºé•¿æœŸè¿è¡Œçš„ç³»ç»Ÿè‡³å…³é‡è¦ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜å­˜å‚¨ç®¡ç†ç­–ç•¥å’Œæ–¹æ³•ã€‚

**æ•°æ®åˆ†åŒºç­–ç•¥**ï¼š

```sql
-- 1. æŒ‰æ—¶é—´åˆ†åŒºæº¯æºæ´»åŠ¨è¡¨
CREATE TABLE provenance_activities (
    activity_id VARCHAR(100),
    activity_type VARCHAR(50),
    activity_time TIMESTAMP,
    activity_attributes JSONB
) PARTITION BY RANGE (activity_time);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE provenance_activities_2024_01 PARTITION OF provenance_activities
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE provenance_activities_2024_02 PARTITION OF provenance_activities
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- 2. è‡ªåŠ¨åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(
    p_table_name TEXT,
    p_start_date DATE
) RETURNS VOID AS $$
DECLARE
    v_partition_name TEXT;
    v_end_date DATE;
BEGIN
    v_end_date := p_start_date + INTERVAL '1 month';
    v_partition_name := format('%s_%s', p_table_name,
                               to_char(p_start_date, 'YYYY_MM'));

    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I PARTITION OF %I
        FOR VALUES FROM (%L) TO (%L)
    ', v_partition_name, p_table_name, p_start_date, v_end_date);
END;
$$ LANGUAGE plpgsql;

-- 3. è‡ªåŠ¨å½’æ¡£æ—§æ•°æ®
CREATE OR REPLACE FUNCTION archive_old_provenance(
    p_retention_months INTEGER DEFAULT 12
) RETURNS VOID AS $$
BEGIN
    -- å½’æ¡£æ—§æ•°æ®åˆ°å½’æ¡£è¡¨
    INSERT INTO provenance_activities_archive
    SELECT * FROM provenance_activities
    WHERE activity_time < NOW() - (p_retention_months || ' months')::INTERVAL;

    -- åˆ é™¤æ—§æ•°æ®
    DELETE FROM provenance_activities
    WHERE activity_time < NOW() - (p_retention_months || ' months')::INTERVAL;
END;
$$ LANGUAGE plpgsql;
```

**å­˜å‚¨å‹ç¼©**ï¼š

```sql
-- 1. å¯ç”¨è¡¨å‹ç¼©
ALTER TABLE provenance_activities SET (
    toast_tuple_target = 128,
    fillfactor = 90
);

-- 2. å‹ç¼©JSONBå­—æ®µ
CREATE OR REPLACE FUNCTION compress_provenance_data()
RETURNS VOID AS $$
BEGIN
    -- å‹ç¼©JSONBå­—æ®µ
    UPDATE provenance_activities
    SET activity_attributes = jsonb_strip_nulls(activity_attributes)
    WHERE activity_attributes IS NOT NULL;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 å¯è§†åŒ–ä¸æŠ¥è¡¨

å¯è§†åŒ–ä¸æŠ¥è¡¨åŠŸèƒ½å¸®åŠ©ç”¨æˆ·ç›´è§‚ç†è§£æ•°æ®è¡€ç¼˜å…³ç³»ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜å¯è§†åŒ–ä¸æŠ¥è¡¨çš„å®ç°ã€‚

**è¡€ç¼˜æŠ¥è¡¨ç”Ÿæˆ**ï¼š

```sql
-- 1. åˆ›å»ºè¡€ç¼˜æŠ¥è¡¨è§†å›¾
CREATE OR REPLACE VIEW lineage_report AS
SELECT
    source_schema || '.' || source_table || '.' || source_column AS source,
    target_schema || '.' || target_table || '.' || target_column AS target,
    transformation_type,
    transformation_details->>'description' AS description,
    COUNT(*) OVER (PARTITION BY source_schema, source_table, source_column) AS source_count,
    COUNT(*) OVER (PARTITION BY target_schema, target_table, target_column) AS target_count,
    created_at
FROM data_lineage
ORDER BY created_at DESC;

-- 2. åˆ›å»ºå½±å“åˆ†ææŠ¥è¡¨
CREATE OR REPLACE VIEW impact_analysis_report AS
SELECT
    schema_name || '.' || table_name || '.' || column_name AS object,
    impact_level,
    impact_type,
    COUNT(*) AS impact_count,
    STRING_AGG(DISTINCT description, '; ') AS impact_details
FROM analyze_impact('public', 'orders', 'order_id')
GROUP BY schema_name, table_name, column_name, impact_level, impact_type
ORDER BY
    CASE impact_level
        WHEN 'HIGH' THEN 1
        WHEN 'MEDIUM' THEN 2
        WHEN 'LOW' THEN 3
    END,
    impact_count DESC;
```

**æŠ¥è¡¨å¯¼å‡ºåŠŸèƒ½**ï¼š

```python
# report_generator.py
import psycopg2
import pandas as pd
from datetime import datetime

class ReportGenerator:
    """æŠ¥è¡¨ç”Ÿæˆå™¨"""

    def __init__(self, db_config):
        self.conn = psycopg2.connect(**db_config)

    def generate_lineage_report(self, output_file='lineage_report.xlsx'):
        """ç”Ÿæˆè¡€ç¼˜æŠ¥è¡¨"""
        query = """
            SELECT * FROM lineage_report
            LIMIT 1000
        """
        df = pd.read_sql_query(query, self.conn)
        df.to_excel(output_file, index=False)
        print(f"è¡€ç¼˜æŠ¥è¡¨å·²ä¿å­˜åˆ°: {output_file}")

    def generate_impact_report(self, schema, table, column, output_file='impact_report.xlsx'):
        """ç”Ÿæˆå½±å“åˆ†ææŠ¥è¡¨"""
        query = """
            SELECT * FROM analyze_impact(%s, %s, %s)
        """
        df = pd.read_sql_query(query, self.conn, params=(schema, table, column))
        df.to_excel(output_file, index=False)
        print(f"å½±å“åˆ†ææŠ¥è¡¨å·²ä¿å­˜åˆ°: {output_file}")

    def close(self):
        self.conn.close()
```

### 5.4 æœ€ä½³å®è·µ

æ•°æ®æº¯æºç³»ç»Ÿçš„æœ€ä½³å®è·µå¸®åŠ©ç¡®ä¿ç³»ç»Ÿçš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜æ•°æ®æº¯æºç³»ç»Ÿçš„æœ€ä½³å®è·µã€‚

**æ•°æ®é‡‡é›†æœ€ä½³å®è·µ**ï¼š

- âœ… **åŠæ—¶é‡‡é›†**ï¼šåœ¨æ•°æ®å˜æ›´æ—¶ç«‹å³è®°å½•æº¯æºä¿¡æ¯
- âœ… **å®Œæ•´è®°å½•**ï¼šè®°å½•å®Œæ•´çš„æ•°æ®å¤„ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æºæ•°æ®ã€è½¬æ¢è¿‡ç¨‹ã€ç›®æ ‡æ•°æ®
- âœ… **æ ‡å‡†åŒ–**ï¼šä½¿ç”¨æ ‡å‡†åŒ–çš„æº¯æºæ¨¡å‹ï¼ˆå¦‚PROV-DMï¼‰
- âœ… **æ€§èƒ½è€ƒè™‘**ï¼šä½¿ç”¨å¼‚æ­¥é‡‡é›†å‡å°‘å¯¹ä¸šåŠ¡ç³»ç»Ÿçš„å½±å“

**å­˜å‚¨æœ€ä½³å®è·µ**ï¼š

- âœ… **åˆ†åŒºå­˜å‚¨**ï¼šæŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨æº¯æºæ•°æ®ï¼Œä¾¿äºç®¡ç†å’Œå½’æ¡£
- âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºé€‚å½“çš„ç´¢å¼•
- âœ… **å‹ç¼©å­˜å‚¨**ï¼šå¯¹JSONBå­—æ®µè¿›è¡Œå‹ç¼©ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
- âœ… **å®šæœŸå½’æ¡£**ï¼šå®šæœŸå½’æ¡£æ—§æ•°æ®ï¼Œä¿æŒç³»ç»Ÿæ€§èƒ½

**æŸ¥è¯¢æœ€ä½³å®è·µ**ï¼š

- âœ… **ä½¿ç”¨ç¼“å­˜**ï¼šå¯¹å¸¸ç”¨æŸ¥è¯¢ç»“æœè¿›è¡Œç¼“å­˜
- âœ… **é™åˆ¶æ·±åº¦**ï¼šé™åˆ¶è¡€ç¼˜æŸ¥è¯¢çš„æ·±åº¦ï¼Œé¿å…æ€§èƒ½é—®é¢˜
- âœ… **æ‰¹é‡æŸ¥è¯¢**ï¼šä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šå¯¹å¤æ‚æŸ¥è¯¢ä½¿ç”¨å¼‚æ­¥å¤„ç†

**å¯è§†åŒ–æœ€ä½³å®è·µ**ï¼š

- âœ… **æ¸…æ™°å±•ç¤º**ï¼šä½¿ç”¨æ¸…æ™°çš„å›¾è¡¨å±•ç¤ºè¡€ç¼˜å…³ç³»
- âœ… **äº¤äº’å¼**ï¼šæä¾›äº¤äº’å¼çš„å¯è§†åŒ–ç•Œé¢
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹å¤§è§„æ¨¡è¡€ç¼˜å›¾è°±è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
- âœ… **å¯¼å‡ºåŠŸèƒ½**ï¼šæä¾›æŠ¥è¡¨å¯¼å‡ºåŠŸèƒ½ï¼Œä¾¿äºåˆ†äº«å’Œåˆ†æ

---

## å…­ã€æ¡ˆä¾‹å®æˆ˜

### 6.1 æ•°æ®è´¨é‡è¿½è¸ª

**åœºæ™¯**: å‘ç°æŠ¥è¡¨æ•°æ®å¼‚å¸¸ï¼Œè¿½è¸ªé”™è¯¯æ¥æº

æ•°æ®è´¨é‡è¿½è¸ªæ˜¯æ•°æ®æº¯æºç³»ç»Ÿçš„é‡è¦åº”ç”¨åœºæ™¯ã€‚å½“å‘ç°æ•°æ®å¼‚å¸¸æ—¶ï¼Œé€šè¿‡è¡€ç¼˜åˆ†æå¯ä»¥å¿«é€Ÿè¿½æº¯åˆ°é—®é¢˜æºå¤´ã€‚

**é—®é¢˜æè¿°**ï¼š

æœˆåº¦æŠ¥è¡¨ä¸­çš„æ€»é”€å”®é¢æ•°æ®å¼‚å¸¸ï¼Œéœ€è¦è¿½è¸ªåˆ°é—®é¢˜æºå¤´ã€‚

**å®æ–½æ­¥éª¤**ï¼š

```sql
-- 1. å‘ç°æ•°æ®å¼‚å¸¸
SELECT
    report_month,
    total_revenue,
    expected_revenue
FROM monthly_report
WHERE report_month = '2024-01'
  AND ABS(total_revenue - expected_revenue) > 10000;

-- 2. åå‘è¿½è¸ªæ•°æ®æ¥æº
SELECT * FROM backward_track_lineage(
    'public', 'monthly_report', 'total_revenue', 5
);

-- 3. å‘ç°æ•°æ®æ¥è‡ªsalesè¡¨çš„èšåˆè®¡ç®—
-- æ£€æŸ¥salesè¡¨çš„æ•°æ®è´¨é‡
SELECT
    COUNT(*) AS total_records,
    COUNT(DISTINCT order_id) AS unique_orders,
    SUM(amount) AS total_amount,
    COUNT(*) - COUNT(DISTINCT order_id) AS duplicate_count
FROM sales
WHERE order_date >= '2024-01-01'
  AND order_date < '2024-02-01';

-- 4. å‘ç°é—®é¢˜ï¼šå­˜åœ¨é‡å¤è®¢å•
-- ä¿®å¤æ•°æ®è´¨é‡é—®é¢˜
DELETE FROM sales s1
WHERE EXISTS (
    SELECT 1 FROM sales s2
    WHERE s2.order_id = s1.order_id
      AND s2.order_date = s1.order_date
      AND s2.ctid > s1.ctid
);

-- 5. é‡æ–°ç”ŸæˆæŠ¥è¡¨
-- æŠ¥è¡¨æ•°æ®æ¢å¤æ­£å¸¸
```

**æ•ˆæœè¯„ä¼°**ï¼š

| æŒ‡æ ‡ | æ— è¡€ç¼˜åˆ†æ | æœ‰è¡€ç¼˜åˆ†æ | æå‡ |
|------|-----------|-----------|------|
| **é—®é¢˜å®šä½æ—¶é—´** | 4å°æ—¶ | 30åˆ†é’Ÿ | -87.5% |
| **æ•°æ®è´¨é‡** | 85% | 98% | +15% |
| **é—®é¢˜è§£å†³æ•ˆç‡** | ä½ | é«˜ | +300% |

### 6.2 åˆè§„æ€§å®¡è®¡

**åœºæ™¯**: GDPRåˆè§„ï¼Œè¿½è¸ªä¸ªäººæ•°æ®å¤„ç†

åˆè§„æ€§å®¡è®¡æ˜¯æ•°æ®æº¯æºç³»ç»Ÿçš„é‡è¦åº”ç”¨åœºæ™¯ã€‚é€šè¿‡æ•°æ®æº¯æºå¯ä»¥è¯æ˜æ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œæ»¡è¶³GDPRç­‰åˆè§„è¦æ±‚ã€‚

**é—®é¢˜æè¿°**ï¼š

éœ€è¦è¯æ˜ä¸ªäººæ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œæ»¡è¶³GDPRåˆè§„è¦æ±‚ã€‚

**å®æ–½æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®çš„å¤„ç†è½¨è¿¹
SELECT
    e.entity_id,
    e.entity_type,
    e.entity_attributes->>'user_id' AS user_id,
    a.activity_type,
    a.activity_time,
    ag.agent_name,
    ag.agent_type
FROM provenance_entities e
JOIN provenance_was_generated_by wgb ON e.entity_id = wgb.entity_id
JOIN provenance_activities a ON wgb.activity_id = a.activity_id
LEFT JOIN provenance_was_attributed_to wat ON e.entity_id = wat.entity_id
LEFT JOIN provenance_agents ag ON wat.agent_id = ag.agent_id
WHERE e.entity_type = 'user_data'
  AND e.entity_attributes->>'user_id' = '12345'
ORDER BY a.activity_time;

-- 2. æŸ¥è¯¢æ•°æ®æ¥æº
SELECT
    used_entity_id,
    derivation_type,
    activity_id
FROM provenance_was_derived_from
WHERE generated_entity_id = (
    SELECT entity_id FROM provenance_entities
    WHERE entity_type = 'user_data'
      AND entity_attributes->>'user_id' = '12345'
    LIMIT 1
);

-- 3. ç”Ÿæˆåˆè§„æŠ¥å‘Š
CREATE OR REPLACE VIEW gdpr_compliance_report AS
SELECT
    e.entity_attributes->>'user_id' AS user_id,
    COUNT(DISTINCT a.activity_id) AS processing_count,
    MIN(a.activity_time) AS first_processing,
    MAX(a.activity_time) AS last_processing,
    STRING_AGG(DISTINCT a.activity_type, ', ') AS processing_types,
    STRING_AGG(DISTINCT ag.agent_name, ', ') AS processors
FROM provenance_entities e
JOIN provenance_was_generated_by wgb ON e.entity_id = wgb.entity_id
JOIN provenance_activities a ON wgb.activity_id = a.activity_id
LEFT JOIN provenance_was_attributed_to wat ON e.entity_id = wat.entity_id
LEFT JOIN provenance_agents ag ON wat.agent_id = ag.agent_id
WHERE e.entity_type = 'user_data'
GROUP BY e.entity_attributes->>'user_id';

-- 4. æŸ¥è¯¢åˆè§„æŠ¥å‘Š
SELECT * FROM gdpr_compliance_report
WHERE user_id = '12345';
```

**æ•ˆæœè¯„ä¼°**ï¼š

| æŒ‡æ ‡ | æ— æº¯æºç³»ç»Ÿ | æœ‰æº¯æºç³»ç»Ÿ | æå‡ |
|------|-----------|-----------|------|
| **åˆè§„é€šè¿‡ç‡** | 60% | 95% | +58% |
| **å®¡è®¡æ—¶é—´** | 2å‘¨ | 2å¤© | -86% |
| **æ•°æ®å¯è¿½æº¯æ€§** | 40% | 100% | +150% |

### 6.3 å½±å“åˆ†æ

**åœºæ™¯**: è¯„ä¼°è¡¨ç»“æ„å˜æ›´çš„å½±å“èŒƒå›´

å½±å“åˆ†ææ˜¯æ•°æ®æº¯æºç³»ç»Ÿçš„é‡è¦åº”ç”¨åœºæ™¯ã€‚åœ¨ä¿®æ”¹è¡¨ç»“æ„æˆ–åˆ é™¤æ•°æ®æ—¶ï¼Œé€šè¿‡å½±å“åˆ†æå¯ä»¥è¯„ä¼°å½±å“èŒƒå›´ï¼Œé¿å…å½±å“ä¸‹æ¸¸ç³»ç»Ÿã€‚

**é—®é¢˜æè¿°**ï¼š

éœ€è¦åˆ é™¤ordersè¡¨çš„æŸä¸ªåˆ—ï¼Œéœ€è¦è¯„ä¼°å½±å“èŒƒå›´ã€‚

**å®æ–½æ­¥éª¤**ï¼š

```sql
-- 1. åˆ†æåˆ é™¤åˆ—çš„å½±å“
SELECT * FROM analyze_impact('public', 'orders', 'order_id');

-- 2. æŸ¥è¯¢æ‰€æœ‰ä¾èµ–è¯¥åˆ—çš„ä¸‹æ¸¸å¯¹è±¡
WITH RECURSIVE impact_tree AS (
    -- èµ·å§‹èŠ‚ç‚¹
    SELECT
        target_schema,
        target_table,
        target_column,
        1 AS level,
        format('%s.%s.%s', target_schema, target_table, target_column) AS path
    FROM data_lineage
    WHERE source_schema = 'public'
      AND source_table = 'orders'
      AND source_column = 'order_id'

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ä¸‹æ¸¸ä¾èµ–
    SELECT
        dl.target_schema,
        dl.target_table,
        dl.target_column,
        it.level + 1,
        format('%s -> %s.%s.%s',
               it.path, dl.target_schema, dl.target_table, dl.target_column)
    FROM data_lineage dl
    JOIN impact_tree it ON (
        dl.source_schema = it.target_schema AND
        dl.source_table = it.target_table AND
        dl.source_column = it.target_column
    )
    WHERE it.level < 10
)
SELECT DISTINCT
    target_schema,
    target_table,
    target_column,
    level,
    CASE
        WHEN level = 1 THEN 'HIGH'
        WHEN level <= 3 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS impact_level
FROM impact_tree
ORDER BY level, target_schema, target_table, target_column;

-- 3. ç”Ÿæˆå½±å“åˆ†ææŠ¥å‘Š
CREATE OR REPLACE VIEW impact_analysis_report AS
SELECT
    'public.orders.order_id' AS source_object,
    target_schema || '.' || target_table || '.' || target_column AS impacted_object,
    level,
    CASE
        WHEN level = 1 THEN 'HIGH'
        WHEN level <= 3 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS impact_level,
    COUNT(*) AS dependency_count
FROM (
    SELECT * FROM forward_track_lineage('public', 'orders', 'order_id', 10)
) t
GROUP BY target_schema, target_table, target_column, level
ORDER BY level, dependency_count DESC;

-- 4. æŸ¥çœ‹å½±å“åˆ†ææŠ¥å‘Š
SELECT * FROM impact_analysis_report;
```

**æ•ˆæœè¯„ä¼°**ï¼š

| æŒ‡æ ‡ | æ— å½±å“åˆ†æ | æœ‰å½±å“åˆ†æ | æå‡ |
|------|-----------|-----------|------|
| **å˜æ›´é£é™©** | é«˜ | ä½ | -80% |
| **å½±å“è¯„ä¼°æ—¶é—´** | 1å¤© | 1å°æ—¶ | -96% |
| **å˜æ›´æˆåŠŸç‡** | 70% | 95% | +36% |

---

## ä¸ƒã€æ€»ç»“ä¸å±•æœ›

### æ ¸å¿ƒæ”¶è·

æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æä¸ºæ•°æ®ç®¡ç†æä¾›äº†å¼ºå¤§çš„è¿½è¸ªå’Œåˆ†æèƒ½åŠ›ï¼Œåœ¨æ•°æ®è´¨é‡ã€åˆè§„æ€§ã€å½±å“åˆ†æç­‰æ–¹é¢å‘æŒ¥äº†é‡è¦ä½œç”¨ã€‚æœ¬èŠ‚æ€»ç»“æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æçš„æ ¸å¿ƒæ”¶è·ã€‚

**æŠ€æœ¯æ”¶è·**ï¼š

1. âœ… **æ•°æ®æº¯æºæä¾›å®Œæ•´çš„æ•°æ®è¿½è¸ªèƒ½åŠ›**
   - å¯ä»¥ä»ä»»ä½•æ•°æ®ç‚¹è¿½æº¯åˆ°å…¶æºå¤´
   - è®°å½•å®Œæ•´çš„æ•°æ®å¤„ç†å†å²
   - æ”¯æŒæ­£å‘è¿½è¸ªå’Œåå‘è¿½è¸ª

2. âœ… **è¡€ç¼˜åˆ†æå¸®åŠ©ç†è§£æ•°æ®æµè½¬**
   - å¯è§†åŒ–å±•ç¤ºæ•°æ®è¡€ç¼˜å…³ç³»
   - ç†è§£æ•°æ®çš„ä¾èµ–å…³ç³»
   - ä¼˜åŒ–æ•°æ®æ¶æ„

3. âœ… **ProvSQLæä¾›æ ‡å‡†åŒ–æº¯æºæ–¹æ¡ˆ**
   - ä½¿ç”¨W3C PROV-DMæ ‡å‡†æ¨¡å‹
   - æä¾›æ ‡å‡†åŒ–çš„æº¯æºæŸ¥è¯¢æ¥å£
   - æ”¯æŒæ¦‚ç‡æº¯æºå’Œä¸ç¡®å®šæ€§ç®¡ç†

4. âœ… **æ»¡è¶³åˆè§„æ€§å’Œå®¡è®¡è¦æ±‚**
   - æä¾›å®Œæ•´çš„æ•°æ®å¤„ç†è®°å½•
   - æ»¡è¶³GDPRã€SOXã€HIPAAç­‰åˆè§„è¦æ±‚
   - æ”¯æŒåˆè§„å®¡è®¡å’ŒæŠ¥å‘Šç”Ÿæˆ

**å®è·µæ”¶è·**ï¼š

- **æ•°æ®è´¨é‡ç®¡ç†**ï¼šé€šè¿‡æ•°æ®æº¯æºå¿«é€Ÿå®šä½æ•°æ®è´¨é‡é—®é¢˜ï¼Œæå‡æ•°æ®è´¨é‡
- **åˆè§„æ€§å®¡è®¡**ï¼šé€šè¿‡æ•°æ®æº¯æºè¯æ˜æ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
- **å½±å“åˆ†æ**ï¼šé€šè¿‡è¡€ç¼˜åˆ†æè¯„ä¼°æ•°æ®å˜æ›´çš„å½±å“èŒƒå›´ï¼Œé™ä½å˜æ›´é£é™©
- **æ•°æ®æ²»ç†**ï¼šé€šè¿‡è¡€ç¼˜åˆ†æç†è§£æ•°æ®æµè½¬ï¼Œä¼˜åŒ–æ•°æ®æ¶æ„

**æ€§èƒ½ä¼˜åŒ–æ”¶è·**ï¼š

- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡ç´¢å¼•ã€ç‰©åŒ–è§†å›¾ã€ç¼“å­˜ç­‰æŠ€æœ¯ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **å­˜å‚¨ä¼˜åŒ–**ï¼šé€šè¿‡åˆ†åŒºã€å‹ç¼©ã€å½’æ¡£ç­‰æŠ€æœ¯ä¼˜åŒ–å­˜å‚¨ç®¡ç†
- **å¯è§†åŒ–ä¼˜åŒ–**ï¼šé€šè¿‡å›¾è°±ç¼“å­˜ã€æ‰¹é‡å¤„ç†ç­‰æŠ€æœ¯ä¼˜åŒ–å¯è§†åŒ–æ€§èƒ½

### é€‚ç”¨åœºæ™¯

æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æé€‚ç”¨äºå¤šç§æ•°æ®ç®¡ç†åœºæ™¯ï¼Œæœ¬èŠ‚è¯¦ç»†è¯´æ˜é€‚ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µã€‚

**1. æ•°æ®è´¨é‡ç®¡ç†**

- **åœºæ™¯**ï¼šå‘ç°æ•°æ®é”™è¯¯ï¼Œéœ€è¦å¿«é€Ÿå®šä½é—®é¢˜æºå¤´
- **æ–¹æ³•**ï¼šä½¿ç”¨åå‘è¿½è¸ªåŠŸèƒ½ï¼Œä»é”™è¯¯æ•°æ®è¿½æº¯åˆ°æºå¤´
- **æ•ˆæœ**ï¼šé—®é¢˜å®šä½æ—¶é—´å‡å°‘60-80%

**2. åˆè§„æ€§å®¡è®¡**

- **åœºæ™¯**ï¼šéœ€è¦è¯æ˜æ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œæ»¡è¶³GDPRç­‰åˆè§„è¦æ±‚
- **æ–¹æ³•**ï¼šä½¿ç”¨PROV-DMæ¨¡å‹è®°å½•å®Œæ•´çš„æ•°æ®å¤„ç†å†å²
- **æ•ˆæœ**ï¼šåˆè§„é€šè¿‡ç‡æå‡åˆ°95%+

**3. å½±å“åˆ†æ**

- **åœºæ™¯**ï¼šéœ€è¦è¯„ä¼°è¡¨ç»“æ„å˜æ›´æˆ–æ•°æ®åˆ é™¤çš„å½±å“èŒƒå›´
- **æ–¹æ³•**ï¼šä½¿ç”¨æ­£å‘è¿½è¸ªåŠŸèƒ½ï¼Œåˆ†ææ•°æ®å˜æ›´çš„å½±å“èŒƒå›´
- **æ•ˆæœ**ï¼šå˜æ›´é£é™©é™ä½80%ï¼Œå˜æ›´æˆåŠŸç‡æå‡åˆ°95%

**4. æ•°æ®æ²»ç†**

- **åœºæ™¯**ï¼šéœ€è¦ç†è§£æ•°æ®æµè½¬ï¼Œä¼˜åŒ–æ•°æ®æ¶æ„
- **æ–¹æ³•**ï¼šä½¿ç”¨è¡€ç¼˜åˆ†æå¯è§†åŒ–å±•ç¤ºæ•°æ®æµè½¬è·¯å¾„
- **æ•ˆæœ**ï¼šæ•°æ®å†—ä½™å‡å°‘30-50%ï¼Œæ•°æ®è´¨é‡æå‡20-40%

**5. è°ƒè¯•åˆ†æ**

- **åœºæ™¯**ï¼šæ•°æ®è®¡ç®—å‡ºç°é—®é¢˜ï¼Œéœ€è¦è¿½è¸ªè®¡ç®—è¿‡ç¨‹
- **æ–¹æ³•**ï¼šä½¿ç”¨è¡€ç¼˜åˆ†æè¿½è¸ªè®¡ç®—è¿‡ç¨‹ï¼Œå®šä½é—®é¢˜ç¯èŠ‚
- **æ•ˆæœ**ï¼šé—®é¢˜è¯Šæ–­æ—¶é—´å‡å°‘50-70%

**6. æ•°æ®æ–‡æ¡£åŒ–**

- **åœºæ™¯**ï¼šéœ€è¦è‡ªåŠ¨ç”Ÿæˆæ•°æ®æ–‡æ¡£ï¼Œè¯´æ˜æ•°æ®çš„æ¥æºå’Œç”¨é€”
- **æ–¹æ³•**ï¼šä½¿ç”¨è¡€ç¼˜åˆ†æè‡ªåŠ¨ç”Ÿæˆæ•°æ®æ–‡æ¡£
- **æ•ˆæœ**ï¼šæ–‡æ¡£ç»´æŠ¤æˆæœ¬å‡å°‘80%ï¼Œæ–‡æ¡£å‡†ç¡®æ€§æå‡åˆ°100%

---

## å…«ã€å‚è€ƒèµ„æ–™

å‚è€ƒèµ„æ–™æä¾›äº†æ•°æ®æº¯æºä¸è¡€ç¼˜åˆ†æçš„å­¦ä¹ èµ„æºå’Œå·¥å…·ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£æ•°æ®æº¯æºçš„åŸç†å’Œå®è·µã€‚

**æ ¸å¿ƒæ¡†æ¶å’Œå·¥å…·**ï¼š

1. **ProvSQL**
   - åœ°å€ï¼š<https://github.com/PierreSenellart/provsql>
   - è¯´æ˜ï¼šPostgreSQLçš„æ•°æ®æº¯æºæ‰©å±•ï¼Œæä¾›æ ‡å‡†åŒ–çš„æº¯æºåŠŸèƒ½
   - é€‚ç”¨åœºæ™¯ï¼šæ•°æ®æº¯æºå®æ–½ã€æ¦‚ç‡æº¯æºã€ä¸ç¡®å®šæ€§ç®¡ç†
   - æ¨èåº¦ï¼šâ­â­â­â­â­

2. **W3C PROV**
   - åœ°å€ï¼š<https://www.w3.org/TR/prov-dm/>
   - è¯´æ˜ï¼šW3Cçš„æ•°æ®æº¯æºæ ‡å‡†æ¨¡å‹ï¼ˆPROV-DMï¼‰
   - é€‚ç”¨åœºæ™¯ï¼šæº¯æºæ¨¡å‹è®¾è®¡ã€æ ‡å‡†åŒ–å®æ–½
   - æ¨èåº¦ï¼šâ­â­â­â­â­

3. **OpenLineage**
   - åœ°å€ï¼š<https://openlineage.io/>
   - è¯´æ˜ï¼šå¼€æºçš„æ•°æ®è¡€ç¼˜æ ‡å‡†ï¼Œæ”¯æŒå¤šç§æ•°æ®å¹³å°
   - é€‚ç”¨åœºæ™¯ï¼šè·¨å¹³å°æ•°æ®è¡€ç¼˜ã€æ ‡å‡†åŒ–è¡€ç¼˜è¿½è¸ª
   - æ¨èåº¦ï¼šâ­â­â­â­â­

**å­¦æœ¯è®ºæ–‡**ï¼š

1. **ProvSQL: Provenance and Probability Management**
   - ä½œè€…ï¼šPierre Senellart et al.
   - åœ°å€ï¼šarXiv:2504.12058
   - å†…å®¹ï¼šProvSQLçš„åŸç†å’Œå®ç°ï¼ŒåŒ…æ‹¬æ¦‚ç‡æº¯æºå’Œä¸ç¡®å®šæ€§ç®¡ç†
   - é€‚ç”¨åœºæ™¯ï¼šç†è®ºç ”ç©¶ã€ç³»ç»Ÿè®¾è®¡
   - æ¨èåº¦ï¼šâ­â­â­â­â­

2. **The PROV Data Model and Abstract Syntax**
   - ä½œè€…ï¼šW3C PROV Working Group
   - åœ°å€ï¼š<https://www.w3.org/TR/prov-dm/>
   - å†…å®¹ï¼šPROV-DMæ•°æ®æ¨¡å‹çš„è¯¦ç»†è¯´æ˜
   - é€‚ç”¨åœºæ™¯ï¼šæº¯æºæ¨¡å‹è®¾è®¡ã€æ ‡å‡†åŒ–å®æ–½
   - æ¨èåº¦ï¼šâ­â­â­â­â­

3. **Data Lineage: A Survey**
   - å†…å®¹ï¼šæ•°æ®è¡€ç¼˜åˆ†æçš„ç»¼è¿°ï¼ŒåŒ…æ‹¬åŸç†ã€æ–¹æ³•å’Œåº”ç”¨
   - é€‚ç”¨åœºæ™¯ï¼šç†è®ºç ”ç©¶ã€æ–¹æ³•å­¦ä¹ 
   - æ¨èåº¦ï¼šâ­â­â­â­

**æŠ€æœ¯åšå®¢**ï¼š

1. **Data Lineage: Why It Matters and How to Implement It**
   - å†…å®¹ï¼šæ•°æ®è¡€ç¼˜åˆ†æçš„é‡è¦æ€§å’Œå®æ–½æ–¹æ³•
   - é€‚ç”¨åœºæ™¯ï¼šæœ€ä½³å®è·µã€å®æ–½æŒ‡å—
   - æ¨èåº¦ï¼šâ­â­â­â­â­

2. **Building a Data Lineage System**
   - å†…å®¹ï¼šæ„å»ºæ•°æ®è¡€ç¼˜ç³»ç»Ÿçš„å®è·µæŒ‡å—
   - é€‚ç”¨åœºæ™¯ï¼šç³»ç»Ÿè®¾è®¡ã€å®æ–½å‚è€ƒ
   - æ¨èåº¦ï¼šâ­â­â­â­â­

**PostgreSQLç›¸å…³**ï¼š

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£ - è§¦å‘å™¨**
   - åœ°å€ï¼š<https://www.postgresql.org/docs/current/triggers.html>
   - å†…å®¹ï¼šPostgreSQLè§¦å‘å™¨æ–‡æ¡£ï¼Œç”¨äºå®ç°æ•°æ®å˜æ›´æ•è·
   - é€‚ç”¨åœºæ™¯ï¼šå˜æ›´æ•è·ã€æº¯æºå®æ–½
   - æ¨èåº¦ï¼šâ­â­â­â­â­

2. **PostgreSQLå®˜æ–¹æ–‡æ¡£ - äº‹ä»¶è§¦å‘å™¨**
   - åœ°å€ï¼š<https://www.postgresql.org/docs/current/event-triggers.html>
   - å†…å®¹ï¼šPostgreSQLäº‹ä»¶è§¦å‘å™¨æ–‡æ¡£ï¼Œç”¨äºæ•è·DDLæ“ä½œ
   - é€‚ç”¨åœºæ™¯ï¼šDDLå˜æ›´æ•è·ã€æº¯æºå®æ–½
   - æ¨èåº¦ï¼šâ­â­â­â­â­

**ç¤¾åŒºèµ„æº**ï¼š

1. **OpenLineage Community**
   - åœ°å€ï¼š<https://openlineage.io/community/>
   - å†…å®¹ï¼šOpenLineageç¤¾åŒºå’Œèµ„æº
   - é€‚ç”¨åœºæ™¯ï¼šç¤¾åŒºäº¤æµã€èµ„æºåˆ†äº«
   - æ¨èåº¦ï¼šâ­â­â­â­

2. **Data Lineage Tools Comparison**
   - å†…å®¹ï¼šæ•°æ®è¡€ç¼˜å·¥å…·çš„å¯¹æ¯”å’Œé€‰æ‹©æŒ‡å—
   - é€‚ç”¨åœºæ™¯ï¼šå·¥å…·é€‰å‹ã€æ–¹æ¡ˆé€‰æ‹©
   - æ¨èåº¦ï¼šâ­â­â­â­

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ4æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 07-SEC-PROVENANCE
**ç‰ˆæœ¬**: v1.0
