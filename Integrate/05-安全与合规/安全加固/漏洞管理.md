# æ¼æ´ç®¡ç†

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [æ¼æ´ç®¡ç†](#æ¼æ´ç®¡ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ¼æ´å‘ç°](#2-æ¼æ´å‘ç°)
    - [2.1 ç‰ˆæœ¬æ£€æŸ¥](#21-ç‰ˆæœ¬æ£€æŸ¥)
    - [2.2 å®‰å…¨å…¬å‘Šç›‘æ§](#22-å®‰å…¨å…¬å‘Šç›‘æ§)
    - [2.3 å®‰å…¨æ‰«æå·¥å…·](#23-å®‰å…¨æ‰«æå·¥å…·)
  - [3. æ¼æ´è¯„ä¼°](#3-æ¼æ´è¯„ä¼°)
    - [3.1 ä¸¥é‡ç¨‹åº¦åˆ†ç±»](#31-ä¸¥é‡ç¨‹åº¦åˆ†ç±»)
    - [3.2 é£é™©è¯„ä¼°](#32-é£é™©è¯„ä¼°)
  - [4. æ¼æ´ä¿®å¤](#4-æ¼æ´ä¿®å¤)
    - [4.1 è¡¥ä¸ç®¡ç†](#41-è¡¥ä¸ç®¡ç†)
    - [4.2 å‡çº§PostgreSQL](#42-å‡çº§postgresql)
    - [4.3 ä¸´æ—¶ç¼“è§£æªæ–½](#43-ä¸´æ—¶ç¼“è§£æªæ–½)
  - [5. æ¼æ´è·Ÿè¸ª](#5-æ¼æ´è·Ÿè¸ª)
    - [5.1 æ¼æ´è·Ÿè¸ªè¡¨](#51-æ¼æ´è·Ÿè¸ªè¡¨)
    - [5.2 è·Ÿè¸ªæµç¨‹](#52-è·Ÿè¸ªæµç¨‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æ¼æ´ç®¡ç†æ˜¯PostgreSQLå®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚åŒ…æ‹¬ï¼š

- **æ¼æ´å‘ç°** - è¯†åˆ«å®‰å…¨æ¼æ´
- **æ¼æ´è¯„ä¼°** - è¯„ä¼°æ¼æ´ä¸¥é‡ç¨‹åº¦
- **æ¼æ´ä¿®å¤** - ä¿®å¤å®‰å…¨æ¼æ´
- **æ¼æ´è·Ÿè¸ª** - è·Ÿè¸ªæ¼æ´çŠ¶æ€

---

## 2. æ¼æ´å‘ç°

### 2.1 ç‰ˆæœ¬æ£€æŸ¥

```sql
-- æ£€æŸ¥PostgreSQLç‰ˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    pg_version TEXT;
    ext_count INT;
BEGIN
    BEGIN
        SELECT version() INTO pg_version;
        RAISE NOTICE 'PostgreSQLç‰ˆæœ¬: %', pg_version;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–PostgreSQLç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        SELECT COUNT(*) INTO ext_count FROM pg_extension;
        RAISE NOTICE 'å·²å®‰è£…æ‰©å±•æ•°é‡: %', ext_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–æ‰©å±•æ•°é‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    ext_record RECORD;
    total_exts INT := 0;
BEGIN
    BEGIN
        FOR ext_record IN
            SELECT extname, extversion
            FROM pg_extension
            ORDER BY extname
        LOOP
            total_exts := total_exts + 1;
            RAISE NOTICE 'æ‰©å±•: %, ç‰ˆæœ¬: %', ext_record.extname, ext_record.extversion;
        END LOOP;

        RAISE NOTICE 'å…±æ‰¾åˆ° % ä¸ªæ‰©å±•', total_exts;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT extname, extversion
FROM pg_extension
ORDER BY extname;
```

### 2.2 å®‰å…¨å…¬å‘Šç›‘æ§

```bash
# è®¢é˜…PostgreSQLå®‰å…¨å…¬å‘Š
# https://www.postgresql.org/support/security/

# æ£€æŸ¥å·²çŸ¥æ¼æ´
# CVEæ•°æ®åº“: https://cve.mitre.org/
```

### 2.3 å®‰å…¨æ‰«æå·¥å…·

```bash
# ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·
# - pgAudit
# - pg_security
# - ç¬¬ä¸‰æ–¹å®‰å…¨æ‰«æå·¥å…·
```

---

## 3. æ¼æ´è¯„ä¼°

### 3.1 ä¸¥é‡ç¨‹åº¦åˆ†ç±»

| çº§åˆ« | è¯´æ˜ | å“åº”æ—¶é—´ |
|------|------|---------|
| **ä¸¥é‡** | è¿œç¨‹ä»£ç æ‰§è¡Œã€æ•°æ®æ³„éœ² | 24å°æ—¶å†… |
| **é«˜** | æƒé™æå‡ã€æ‹’ç»æœåŠ¡ | 7å¤©å†… |
| **ä¸­** | ä¿¡æ¯æ³„éœ²ã€é…ç½®é”™è¯¯ | 30å¤©å†… |
| **ä½** | ä¿¡æ¯æ³„éœ²ã€é…ç½®å»ºè®® | 90å¤©å†… |

### 3.2 é£é™©è¯„ä¼°

```sql
-- è¯„ä¼°æ¼æ´å½±å“èŒƒå›´
-- 1. å—å½±å“çš„æ•°æ®
-- 2. å—å½±å“çš„ç”¨æˆ·
-- 3. ä¸šåŠ¡å½±å“
-- 4. åˆè§„å½±å“
```

---

## 4. æ¼æ´ä¿®å¤

### 4.1 è¡¥ä¸ç®¡ç†

```bash
#!/bin/bash
# è¡¥ä¸ç®¡ç†è„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
set -e
set -u

error_exit() {
    echo "é”™è¯¯: $1" >&2
    exit 1
}

# æ£€æŸ¥pg_dumpæ˜¯å¦å¯ç”¨
if ! command -v pg_dump &> /dev/null; then
    error_exit "pg_dumpå‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿PostgreSQLå®¢æˆ·ç«¯å·²å®‰è£…"
fi

# 1. å¤‡ä»½æ•°æ®åº“
DB_NAME="${DB_NAME:-mydb}"
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).dump"

if pg_dump -Fc "$DB_NAME" > "$BACKUP_FILE"; then
    echo "æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
else
    error_exit "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
fi

# 2. æµ‹è¯•è¡¥ä¸ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒï¼‰
echo "è¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­æµ‹è¯•è¡¥ä¸"

# 3. åº”ç”¨è¡¥ä¸
echo "åº”ç”¨è¡¥ä¸..."

# 4. éªŒè¯ä¿®å¤
echo "éªŒè¯ä¿®å¤..."

# 5. ç›‘æ§ç³»ç»Ÿ
echo "ç›‘æ§ç³»ç»ŸçŠ¶æ€..."
```

### 4.2 å‡çº§PostgreSQL

```bash
# å°ç‰ˆæœ¬å‡çº§ï¼ˆå¦‚17.1 -> 17.2ï¼‰
# é€šå¸¸åªéœ€è¦é‡å¯

# å¤§ç‰ˆæœ¬å‡çº§ï¼ˆå¦‚16 -> 17ï¼‰
# éœ€è¦ä½¿ç”¨pg_upgradeæˆ–é€»è¾‘å¤åˆ¶
```

### 4.3 ä¸´æ—¶ç¼“è§£æªæ–½

```sql
-- å¦‚æœæ— æ³•ç«‹å³ä¿®å¤ï¼Œå®æ–½ä¸´æ—¶ç¼“è§£æªæ–½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰
DO $$
DECLARE
    current_user_super BOOLEAN;
BEGIN
    BEGIN
        -- æ£€æŸ¥æ˜¯å¦æœ‰è¶…çº§ç”¨æˆ·æƒé™
        SELECT rolsuper INTO current_user_super
        FROM pg_roles
        WHERE rolname = current_user;

        IF NOT current_user_super THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;

        -- ç¦ç”¨å—å½±å“çš„åŠŸèƒ½ï¼ˆç¤ºä¾‹ï¼šæ¸…ç©ºshared_preload_librariesï¼‰
        ALTER SYSTEM SET shared_preload_libraries = '';

        -- é‡æ–°åŠ è½½é…ç½®
        PERFORM pg_reload_conf();

        RAISE NOTICE 'ä¸´æ—¶ç¼“è§£æªæ–½å·²å®æ–½ï¼Œshared_preload_librarieså·²æ¸…ç©º';
        RAISE WARNING 'æ³¨æ„ï¼šè¿™æ˜¯ä¸´æ—¶æªæ–½ï¼Œè¯·å°½å¿«åº”ç”¨æ­£å¼è¡¥ä¸';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'å®æ–½ä¸´æ—¶ç¼“è§£æªæ–½å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. æ¼æ´è·Ÿè¸ª

### 5.1 æ¼æ´è·Ÿè¸ªè¡¨

```sql
-- åˆ›å»ºæ¼æ´è·Ÿè¸ªè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'vulnerability_tracking') THEN
            RAISE NOTICE 'è¡¨ vulnerability_tracking å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
            RETURN;
        END IF;

        CREATE TABLE vulnerability_tracking (
            id SERIAL PRIMARY KEY,
            cve_id TEXT UNIQUE,
            description TEXT NOT NULL,
            severity TEXT NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low')),
            affected_version TEXT NOT NULL,
            fixed_version TEXT,
            status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'fixed', 'mitigated')),
            discovered_at TIMESTAMPTZ DEFAULT NOW(),
            fixed_at TIMESTAMPTZ,
            notes TEXT,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );

        RAISE NOTICE 'æ¼æ´è·Ÿè¸ªè¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ vulnerability_tracking å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ¼æ´è·Ÿè¸ªè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- åˆ›å»ºç´¢å¼•
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'vuln_tracking_status_idx') THEN
            CREATE INDEX vuln_tracking_status_idx ON vulnerability_tracking (status);
            RAISE NOTICE 'ç´¢å¼• vuln_tracking_status_idx åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• vuln_tracking_status_idx å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'vuln_tracking_severity_idx') THEN
            CREATE INDEX vuln_tracking_severity_idx ON vulnerability_tracking (severity);
            RAISE NOTICE 'ç´¢å¼• vuln_tracking_severity_idx åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• vuln_tracking_severity_idx å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'vuln_tracking_cve_id_idx') THEN
            CREATE INDEX vuln_tracking_cve_id_idx ON vulnerability_tracking (cve_id);
            RAISE NOTICE 'ç´¢å¼• vuln_tracking_cve_id_idx åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 è·Ÿè¸ªæµç¨‹

```sql
-- è®°å½•æ–°æ¼æ´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'vulnerability_tracking') THEN
            RAISE EXCEPTION 'è¡¨ vulnerability_tracking ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¯¥è¡¨';
        END IF;

        INSERT INTO vulnerability_tracking (
            cve_id, description, severity, affected_version, status
        ) VALUES (
            'CVE-2024-XXXX',
            'PostgreSQLå®‰å…¨æ¼æ´æè¿°',
            'high',
            '17.0',
            'open'
        )
        ON CONFLICT (cve_id) DO UPDATE
        SET description = EXCLUDED.description,
            severity = EXCLUDED.severity,
            affected_version = EXCLUDED.affected_version
        RETURNING id INTO inserted_id;

        RAISE NOTICE 'æ¼æ´è®°å½•æˆåŠŸï¼Œè®°å½•ID: %', inserted_id;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ vulnerability_tracking ä¸å­˜åœ¨';
            RAISE;
        WHEN check_violation THEN
            RAISE WARNING 'æ•°æ®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥severityæˆ–statusçš„å€¼';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•æ–°æ¼æ´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ›´æ–°çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'vulnerability_tracking') THEN
            RAISE EXCEPTION 'è¡¨ vulnerability_tracking ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¯¥è¡¨';
        END IF;

        UPDATE vulnerability_tracking
        SET status = 'fixed',
            fixed_at = NOW(),
            fixed_version = '17.1'
        WHERE cve_id = 'CVE-2024-XXXX';

        GET DIAGNOSTICS updated_count = ROW_COUNT;

        IF updated_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°CVE IDä¸º CVE-2024-XXXX çš„æ¼æ´è®°å½•';
        ELSE
            RAISE NOTICE 'æ¼æ´çŠ¶æ€æ›´æ–°æˆåŠŸï¼Œå½±å“è¡Œæ•°: %', updated_count;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ vulnerability_tracking ä¸å­˜åœ¨';
            RAISE;
        WHEN check_violation THEN
            RAISE WARNING 'çŠ¶æ€å€¼æ— æ•ˆï¼Œå¿…é¡»æ˜¯: open, in_progress, fixed, mitigated';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°æ¼æ´çŠ¶æ€å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢æ¼æ´çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT cve_id, severity, status, affected_version, fixed_version
FROM vulnerability_tracking
WHERE status IN ('open', 'in_progress')
ORDER BY
    CASE severity
        WHEN 'critical' THEN 1
        WHEN 'high' THEN 2
        WHEN 'medium' THEN 3
        WHEN 'low' THEN 4
    END,
    discovered_at DESC;
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å®šæœŸæ£€æŸ¥** - å®šæœŸæ£€æŸ¥å®‰å…¨å…¬å‘Š
2. **åŠæ—¶ä¿®å¤** - æ ¹æ®ä¸¥é‡ç¨‹åº¦åŠæ—¶ä¿®å¤
3. **æµ‹è¯•è¡¥ä¸** - åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•è¡¥ä¸
4. **è·Ÿè¸ªæ¼æ´** - è®°å½•æ‰€æœ‰æ¼æ´å’Œä¿®å¤çŠ¶æ€
5. **ç›‘æ§ç³»ç»Ÿ** - ä¿®å¤åç›‘æ§ç³»ç»ŸçŠ¶æ€

### âŒ é¿å…åšæ³•

1. **å¿½ç•¥æ¼æ´** - å®‰å…¨æ¼æ´å¿…é¡»ä¿®å¤
2. **ä¸æµ‹è¯•è¡¥ä¸** - å¯èƒ½å¯¼è‡´ç³»ç»Ÿé—®é¢˜
3. **ä¸å¤‡ä»½** - ä¿®å¤å‰å¿…é¡»å¤‡ä»½
4. **ä¸è·Ÿè¸ª** - æ— æ³•ç®¡ç†æ¼æ´çŠ¶æ€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md](./PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md) - å®Œæ•´åŠ å›ºæŒ‡å—
- [å®‰å…¨åŠ å›ºæ¸…å•.md](./å®‰å…¨åŠ å›ºæ¸…å•.md) - å®‰å…¨æ£€æŸ¥æ¸…å•
- [05-å®‰å…¨ä¸åˆè§„/README.md](../README.md) - å®‰å…¨ä¸åˆè§„ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
