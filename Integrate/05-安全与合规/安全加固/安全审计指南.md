# å®‰å…¨å®¡è®¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [å®‰å…¨å®¡è®¡æŒ‡å—](#å®‰å…¨å®¡è®¡æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. pgAudité…ç½®](#2-pgaudité…ç½®)
    - [2.1 å®‰è£…å’Œé…ç½®](#21-å®‰è£…å’Œé…ç½®)
    - [2.2 å®¡è®¡çº§åˆ«](#22-å®¡è®¡çº§åˆ«)
  - [3. è‡ªå®šä¹‰å®¡è®¡](#3-è‡ªå®šä¹‰å®¡è®¡)
    - [3.1 åˆ›å»ºå®¡è®¡è¡¨](#31-åˆ›å»ºå®¡è®¡è¡¨)
    - [3.2 åˆ›å»ºå®¡è®¡è§¦å‘å™¨](#32-åˆ›å»ºå®¡è®¡è§¦å‘å™¨)
    - [3.3 åº”ç”¨å®¡è®¡è§¦å‘å™¨](#33-åº”ç”¨å®¡è®¡è§¦å‘å™¨)
  - [4. å®¡è®¡æ—¥å¿—åˆ†æ](#4-å®¡è®¡æ—¥å¿—åˆ†æ)
    - [4.1 æŸ¥è¯¢å®¡è®¡æ—¥å¿—](#41-æŸ¥è¯¢å®¡è®¡æ—¥å¿—)
    - [4.2 ç»Ÿè®¡åˆ†æ](#42-ç»Ÿè®¡åˆ†æ)
  - [5. åˆè§„å®¡è®¡](#5-åˆè§„å®¡è®¡)
    - [5.1 GDPRåˆè§„](#51-gdpråˆè§„)
    - [5.2 æ•°æ®ä¿ç•™ç­–ç•¥](#52-æ•°æ®ä¿ç•™ç­–ç•¥)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å®‰å…¨å®¡è®¡æ˜¯PostgreSQLå®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡å®¡è®¡å¯ä»¥ï¼š

- è·Ÿè¸ªæ‰€æœ‰æ•°æ®åº“æ“ä½œ
- å‘ç°å®‰å…¨äº‹ä»¶
- æ»¡è¶³åˆè§„è¦æ±‚
- è¿›è¡Œå®‰å…¨åˆ†æ

---

## 2. pgAudité…ç½®

### 2.1 å®‰è£…å’Œé…ç½®

```sql
-- å®‰è£…pgAuditæ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥å®‰è£…æ‰©å±•';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            -- æ³¨æ„ï¼špgauditéœ€è¦åœ¨shared_preload_librariesä¸­é…ç½®åæ‰èƒ½åˆ›å»ºæ‰©å±•
            CREATE EXTENSION pgaudit;
            RAISE NOTICE 'pgAuditæ‰©å±•å®‰è£…æˆåŠŸ';
        ELSE
            RAISE NOTICE 'pgAuditæ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE WARNING 'pgAuditæ‰©å±•ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦åœ¨shared_preload_librariesä¸­é…ç½®';
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥å®‰è£…æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'å®‰è£…pgAuditæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é…ç½®å®¡è®¡çº§åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥ä¿®æ”¹ç³»ç»Ÿé…ç½®';
        END IF;

        -- é…ç½®å®¡è®¡çº§åˆ«ï¼ˆå®¡è®¡æ‰€æœ‰æ“ä½œï¼‰
        ALTER SYSTEM SET pgaudit.log = 'all';

        -- é…ç½®å®¡è®¡é€‰é¡¹
        ALTER SYSTEM SET pgaudit.log_catalog = off;
        ALTER SYSTEM SET pgaudit.log_parameter = on;
        ALTER SYSTEM SET pgaudit.log_statement_once = on;

        -- é‡æ–°åŠ è½½é…ç½®
        PERFORM pg_reload_conf();

        RAISE NOTICE 'pgAudité…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®pgAuditå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ³¨æ„ï¼šä¹Ÿå¯ä»¥é…ç½®ä¸ºåªå®¡è®¡DDLå’Œå†™å…¥æ“ä½œ
-- ALTER SYSTEM SET pgaudit.log = 'ddl,write';
```

### 2.2 å®¡è®¡çº§åˆ«

```sql
-- å®¡è®¡æ‰€æœ‰æ“ä½œ
ALTER SYSTEM SET pgaudit.log = 'all';

-- åªå®¡è®¡DDL
ALTER SYSTEM SET pgaudit.log = 'ddl';

-- åªå®¡è®¡å†™å…¥æ“ä½œ
ALTER SYSTEM SET pgaudit.log = 'write';

-- ç»„åˆå®¡è®¡
ALTER SYSTEM SET pgaudit.log = 'ddl,write';
```

---

## 3. è‡ªå®šä¹‰å®¡è®¡

### 3.1 åˆ›å»ºå®¡è®¡è¡¨

```sql
-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE NOTICE 'è¡¨ audit_log å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
            RETURN;
        END IF;

        CREATE TABLE audit_log (
            id BIGSERIAL PRIMARY KEY,
            table_name TEXT NOT NULL,
            operation TEXT NOT NULL,
            user_name TEXT NOT NULL,
            old_data JSONB,
            new_data JSONB,
            changed_fields TEXT[],
            ip_address INET,
            application_name TEXT,
            timestamp TIMESTAMPTZ DEFAULT NOW()
        );

        RAISE NOTICE 'å®¡è®¡æ—¥å¿—è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- åˆ›å»ºç´¢å¼•
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'audit_log_table_idx') THEN
            CREATE INDEX audit_log_table_idx ON audit_log (table_name);
            RAISE NOTICE 'ç´¢å¼• audit_log_table_idx åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'audit_log_user_idx') THEN
            CREATE INDEX audit_log_user_idx ON audit_log (user_name);
            RAISE NOTICE 'ç´¢å¼• audit_log_user_idx åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'audit_log_timestamp_idx') THEN
            CREATE INDEX audit_log_timestamp_idx ON audit_log (timestamp);
            RAISE NOTICE 'ç´¢å¼• audit_log_timestamp_idx åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.2 åˆ›å»ºå®¡è®¡è§¦å‘å™¨

```sql
-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
DECLARE
    old_data JSONB;
    new_data JSONB;
    changed_fields TEXT[];
BEGIN
    BEGIN
        -- æ£€æŸ¥audit_logè¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE EXCEPTION 'å®¡è®¡æ—¥å¿—è¡¨ audit_log ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¯¥è¡¨';
        END IF;

        IF TG_OP = 'DELETE' THEN
            old_data := to_jsonb(OLD);
            INSERT INTO audit_log (
                table_name, operation, user_name,
                old_data, ip_address, application_name
            ) VALUES (
                TG_TABLE_NAME, TG_OP, current_user,
                old_data, inet_client_addr(), current_setting('application_name', true)
            );
            RETURN OLD;
        ELSIF TG_OP = 'UPDATE' THEN
            old_data := to_jsonb(OLD);
            new_data := to_jsonb(NEW);

            -- è®¡ç®—å˜æ›´å­—æ®µ
            BEGIN
                SELECT array_agg(key)
                INTO changed_fields
                FROM jsonb_each(old_data)
                WHERE (old_data->>key) IS DISTINCT FROM (new_data->>key);
            EXCEPTION
                WHEN OTHERS THEN
                    changed_fields := NULL;
                    RAISE WARNING 'è®¡ç®—å˜æ›´å­—æ®µå¤±è´¥: %', SQLERRM;
            END;

            INSERT INTO audit_log (
                table_name, operation, user_name,
                old_data, new_data, changed_fields,
                ip_address, application_name
            ) VALUES (
                TG_TABLE_NAME, TG_OP, current_user,
                old_data, new_data, changed_fields,
                inet_client_addr(), current_setting('application_name', true)
            );
            RETURN NEW;
        ELSIF TG_OP = 'INSERT' THEN
            new_data := to_jsonb(NEW);
            INSERT INTO audit_log (
                table_name, operation, user_name,
                new_data, ip_address, application_name
            ) VALUES (
                TG_TABLE_NAME, TG_OP, current_user,
                new_data, inet_client_addr(), current_setting('application_name', true)
            );
            RETURN NEW;
        ELSE
            RAISE EXCEPTION 'ä¸æ”¯æŒçš„è§¦å‘å™¨æ“ä½œ: %', TG_OP;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'å®¡è®¡æ—¥å¿—è¡¨ä¸å­˜åœ¨';
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE WARNING 'å®¡è®¡è§¦å‘å™¨å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
            -- è§¦å‘å™¨å‡½æ•°ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ä¼šå½±å“åŸæ“ä½œï¼Œæ‰€ä»¥è¿”å›é€‚å½“çš„å€¼
            IF TG_OP = 'DELETE' THEN
                RETURN OLD;
            ELSE
                RETURN NEW;
            END IF;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 åº”ç”¨å®¡è®¡è§¦å‘å™¨

```sql
-- ä¸ºè¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'public' AND p.proname = 'audit_trigger_function'
        ) THEN
            RAISE EXCEPTION 'å‡½æ•° audit_trigger_function ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¯¥å‡½æ•°';
        END IF;

        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºè§¦å‘å™¨';
        ELSE
            -- åˆ é™¤å·²å­˜åœ¨çš„è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            DROP TRIGGER IF EXISTS audit_users ON users;

            -- åˆ›å»ºè§¦å‘å™¨
            CREATE TRIGGER audit_users
            AFTER INSERT OR UPDATE OR DELETE ON users
            FOR EACH ROW
            EXECUTE FUNCTION audit_trigger_function();

            RAISE NOTICE 'è¡¨ users çš„å®¡è®¡è§¦å‘å™¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_function ä¸å­˜åœ¨';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸º users è¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºè§¦å‘å™¨';
        ELSE
            -- åˆ é™¤å·²å­˜åœ¨çš„è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            DROP TRIGGER IF EXISTS audit_orders ON orders;

            -- åˆ›å»ºè§¦å‘å™¨
            CREATE TRIGGER audit_orders
            AFTER INSERT OR UPDATE OR DELETE ON orders
            FOR EACH ROW
            EXECUTE FUNCTION audit_trigger_function();

            RAISE NOTICE 'è¡¨ orders çš„å®¡è®¡è§¦å‘å™¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_function ä¸å­˜åœ¨';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸º orders è¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. å®¡è®¡æ—¥å¿—åˆ†æ

### 4.1 æŸ¥è¯¢å®¡è®¡æ—¥å¿—

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„å®¡è®¡è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    record_count INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
        RAISE WARNING 'å®¡è®¡æ—¥å¿—è¡¨ audit_log ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO record_count FROM audit_log;
    RAISE NOTICE 'å®¡è®¡æ—¥å¿—è¡¨ä¸­å…±æœ‰ % æ¡è®°å½•', record_count;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥è¯¢å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM audit_log
ORDER BY timestamp DESC
LIMIT 100;

-- æŸ¥çœ‹ç‰¹å®šè¡¨çš„æ“ä½œï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM audit_log
WHERE table_name = 'users'
ORDER BY timestamp DESC;

-- æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ“ä½œï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM audit_log
WHERE user_name = 'app_user'
ORDER BY timestamp DESC;
```

### 4.2 ç»Ÿè®¡åˆ†æ

```sql
-- æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_result RECORD;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
        RAISE WARNING 'å®¡è®¡æ—¥å¿—è¡¨ audit_log ä¸å­˜åœ¨';
        RETURN;
    END IF;

    RAISE NOTICE 'æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰:';
    FOR stat_result IN
        SELECT
            operation,
            COUNT(*) AS count
        FROM audit_log
        WHERE timestamp >= NOW() - INTERVAL '24 hours'
        GROUP BY operation
        ORDER BY count DESC
    LOOP
        RAISE NOTICE 'æ“ä½œ: %, æ¬¡æ•°: %', stat_result.operation, stat_result.count;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç»Ÿè®¡æ“ä½œç±»å‹å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    operation,
    COUNT(*) AS count
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY operation
ORDER BY count DESC;

-- æŒ‰ç”¨æˆ·ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    user_stat RECORD;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
        RAISE WARNING 'å®¡è®¡æ—¥å¿—è¡¨ audit_log ä¸å­˜åœ¨';
        RETURN;
    END IF;

    RAISE NOTICE 'æŒ‰ç”¨æˆ·ç»Ÿè®¡ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰:';
    FOR user_stat IN
        SELECT
            user_name,
            COUNT(*) AS count
        FROM audit_log
        WHERE timestamp >= NOW() - INTERVAL '24 hours'
        GROUP BY user_name
        ORDER BY count DESC
    LOOP
        RAISE NOTICE 'ç”¨æˆ·: %, æ¬¡æ•°: %', user_stat.user_name, user_stat.count;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŒ‰ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    user_name,
    COUNT(*) AS count
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_name
ORDER BY count DESC;
```

---

## 5. åˆè§„å®¡è®¡

### 5.1 GDPRåˆè§„

```sql
-- è®°å½•æ•°æ®è®¿é—®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_access_log') THEN
            RAISE NOTICE 'è¡¨ data_access_log å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        ELSE
            CREATE TABLE data_access_log (
                id BIGSERIAL PRIMARY KEY,
                user_name TEXT NOT NULL,
                table_name TEXT NOT NULL,
                record_id BIGINT,
                access_type TEXT CHECK (access_type IN ('read', 'export', 'delete', 'update')),
                timestamp TIMESTAMPTZ DEFAULT NOW()
            );

            CREATE INDEX idx_data_access_log_user ON data_access_log (user_name);
            CREATE INDEX idx_data_access_log_table ON data_access_log (table_name);
            CREATE INDEX idx_data_access_log_timestamp ON data_access_log (timestamp);

            RAISE NOTICE 'æ•°æ®è®¿é—®æ—¥å¿—è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ data_access_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ•°æ®è®¿é—®æ—¥å¿—è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè®¿é—®æ—¥å¿—è§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION data_access_trigger()
RETURNS TRIGGER AS $$
BEGIN
    BEGIN
        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_access_log') THEN
            RAISE EXCEPTION 'æ•°æ®è®¿é—®æ—¥å¿—è¡¨ data_access_log ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¯¥è¡¨';
        END IF;

        -- ç¡®ä¿NEWå­˜åœ¨ï¼ˆå¯¹äºINSERTå’ŒUPDATEæ“ä½œï¼‰
        IF TG_OP IN ('INSERT', 'UPDATE') AND NEW IS NULL THEN
            RAISE EXCEPTION 'NEWè®°å½•ä¸ºç©ºï¼Œæ— æ³•è®°å½•è®¿é—®æ—¥å¿—';
        END IF;

        INSERT INTO data_access_log (
            user_name, table_name, record_id, access_type
        ) VALUES (
            current_user, TG_TABLE_NAME,
            CASE WHEN TG_OP = 'DELETE' THEN OLD.id ELSE NEW.id END,
            CASE
                WHEN TG_OP = 'INSERT' THEN 'read'
                WHEN TG_OP = 'UPDATE' THEN 'update'
                WHEN TG_OP = 'DELETE' THEN 'delete'
                ELSE 'read'
            END
        );

        RETURN COALESCE(NEW, OLD);
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'æ•°æ®è®¿é—®æ—¥å¿—è¡¨ä¸å­˜åœ¨';
            RETURN COALESCE(NEW, OLD);
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•æ•°æ®è®¿é—®æ—¥å¿—å¤±è´¥: %', SQLERRM;
            RETURN COALESCE(NEW, OLD);
    END;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 æ•°æ®ä¿ç•™ç­–ç•¥

```sql
-- è‡ªåŠ¨æ¸…ç†æ—§å®¡è®¡æ—¥å¿—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION cleanup_audit_log()
RETURNS VOID AS $$
DECLARE
    deleted_count INT;
    retention_period INTERVAL := INTERVAL '7 years';  -- GDPRè¦æ±‚
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE EXCEPTION 'å®¡è®¡æ—¥å¿—è¡¨ audit_log ä¸å­˜åœ¨';
        END IF;

        -- åˆ é™¤æ—§è®°å½•
        DELETE FROM audit_log
        WHERE timestamp < NOW() - retention_period;

        GET DIAGNOSTICS deleted_count = ROW_COUNT;

        RAISE NOTICE 'æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† % æ¡è¶…è¿‡ % çš„å®¡è®¡è®°å½•', deleted_count, retention_period;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'å®¡è®¡æ—¥å¿—è¡¨ä¸å­˜åœ¨';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'æ¸…ç†å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸæ‰§è¡Œï¼ˆä½¿ç”¨pg_cronï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    extension_exists BOOLEAN;
    job_id INT;
BEGIN
    -- æ£€æŸ¥pg_cronæ‰©å±•æ˜¯å¦å·²å®‰è£…
    SELECT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_cron'
    ) INTO extension_exists;

    IF NOT extension_exists THEN
        BEGIN
            CREATE EXTENSION IF NOT EXISTS pg_cron;
            RAISE NOTICE 'pg_cronæ‰©å±•å®‰è£…æˆåŠŸ';
        EXCEPTION
            WHEN insufficient_privilege THEN
                RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥å®‰è£…pg_cronæ‰©å±•';
            WHEN OTHERS THEN
                RAISE WARNING 'å®‰è£…pg_cronæ‰©å±•å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    ELSE
        RAISE NOTICE 'pg_cronæ‰©å±•å·²å­˜åœ¨';
    END IF;

    -- åˆ é™¤å·²å­˜åœ¨çš„ä»»åŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    BEGIN
        PERFORM cron.unschedule('cleanup_audit') WHERE EXISTS (
            SELECT 1 FROM cron.job WHERE jobname = 'cleanup_audit'
        );
    EXCEPTION
        WHEN OTHERS THEN
            NULL;  -- å¿½ç•¥é”™è¯¯
    END;

    -- åˆ›å»ºå®šæ—¶ä»»åŠ¡
    BEGIN
        SELECT cron.schedule('cleanup_audit', '0 3 * * *', 'SELECT cleanup_audit_log()') INTO job_id;
        RAISE NOTICE 'å®šæ—¶æ¸…ç†ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: %', job_id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å¯ç”¨pgAudit** - ä½¿ç”¨æ ‡å‡†å®¡è®¡æ‰©å±•
2. **è‡ªå®šä¹‰å®¡è®¡** - ä¸ºå…³é”®è¡¨åˆ›å»ºè‡ªå®šä¹‰å®¡è®¡
3. **å®šæœŸåˆ†æ** - å®šæœŸåˆ†æå®¡è®¡æ—¥å¿—
4. **æ•°æ®ä¿ç•™** - æ ¹æ®åˆè§„è¦æ±‚ä¿ç•™å®¡è®¡æ—¥å¿—
5. **ç›‘æ§å¼‚å¸¸** - è®¾ç½®å‘Šè­¦ç›‘æ§å¼‚å¸¸æ“ä½œ

### âŒ é¿å…åšæ³•

1. **ä¸å¯ç”¨å®¡è®¡** - æ— æ³•è¿½è¸ªå®‰å…¨äº‹ä»¶
2. **å®¡è®¡è¿‡å¤š** - å½±å“æ€§èƒ½
3. **ä¸åˆ†ææ—¥å¿—** - å®¡è®¡æ—¥å¿—éœ€è¦åˆ†ææ‰æœ‰ä»·å€¼
4. **ä¸ä¿ç•™æ—¥å¿—** - æ— æ³•æ»¡è¶³åˆè§„è¦æ±‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md](./PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md) - å®Œæ•´åŠ å›ºæŒ‡å—
- [å®‰å…¨åŠ å›ºæ¸…å•.md](./å®‰å…¨åŠ å›ºæ¸…å•.md) - å®‰å…¨æ£€æŸ¥æ¸…å•
- [05-å®‰å…¨ä¸åˆè§„/README.md](../README.md) - å®‰å…¨ä¸åˆè§„ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
