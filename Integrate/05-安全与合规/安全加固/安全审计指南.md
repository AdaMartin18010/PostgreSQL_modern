# å®‰å…¨å®¡è®¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [å®‰å…¨å®¡è®¡æŒ‡å—](#å®‰å…¨å®¡è®¡æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. pgAudité…ç½®](#2-pgaudité…ç½®)
    - [2.1 å®‰è£…å’Œé…ç½®](#21-å®‰è£…å’Œé…ç½®)
    - [2.2 å®¡è®¡çº§åˆ«](#22-å®¡è®¡çº§åˆ«)
  - [3. è‡ªå®šä¹‰å®¡è®¡](#3-è‡ªå®šä¹‰å®¡è®¡)
    - [3.1 åˆ›å»ºå®¡è®¡è¡¨](#31-åˆ›å»ºå®¡è®¡è¡¨)
    - [3.2 åˆ›å»ºå®¡è®¡è§¦å‘å™¨](#32-åˆ›å»ºå®¡è®¡è§¦å‘å™¨)
    - [3.3 åº”ç”¨å®¡è®¡è§¦å‘å™¨](#33-åº”ç”¨å®¡è®¡è§¦å‘å™¨)
  - [4. å®¡è®¡æ—¥å¿—åˆ†æ](#4-å®¡è®¡æ—¥å¿—åˆ†æ)
    - [4.1 æŸ¥è¯¢å®¡è®¡æ—¥å¿—](#41-æŸ¥è¯¢å®¡è®¡æ—¥å¿—)
    - [4.2 ç»Ÿè®¡åˆ†æ](#42-ç»Ÿè®¡åˆ†æ)
  - [5. åˆè§„å®¡è®¡](#5-åˆè§„å®¡è®¡)
    - [5.1 GDPRåˆè§„](#51-gdpråˆè§„)
    - [5.2 æ•°æ®ä¿ç•™ç­–ç•¥](#52-æ•°æ®ä¿ç•™ç­–ç•¥)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å®‰å…¨å®¡è®¡æ˜¯PostgreSQLå®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡å®¡è®¡å¯ä»¥ï¼š

- è·Ÿè¸ªæ‰€æœ‰æ•°æ®åº“æ“ä½œ
- å‘ç°å®‰å…¨äº‹ä»¶
- æ»¡è¶³åˆè§„è¦æ±‚
- è¿›è¡Œå®‰å…¨åˆ†æ

---

## 2. pgAudité…ç½®

### 2.1 å®‰è£…å’Œé…ç½®

```sql
-- å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- é…ç½®å®¡è®¡çº§åˆ«
ALTER SYSTEM SET pgaudit.log = 'all';  -- å®¡è®¡æ‰€æœ‰æ“ä½œ
-- æˆ–
ALTER SYSTEM SET pgaudit.log = 'ddl,write';  -- åªå®¡è®¡DDLå’Œå†™å…¥æ“ä½œ

-- é…ç½®å®¡è®¡é€‰é¡¹
ALTER SYSTEM SET pgaudit.log_catalog = off;
ALTER SYSTEM SET pgaudit.log_parameter = on;
ALTER SYSTEM SET pgaudit.log_statement_once = on;

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

### 2.2 å®¡è®¡çº§åˆ«

```sql
-- å®¡è®¡æ‰€æœ‰æ“ä½œ
ALTER SYSTEM SET pgaudit.log = 'all';

-- åªå®¡è®¡DDL
ALTER SYSTEM SET pgaudit.log = 'ddl';

-- åªå®¡è®¡å†™å…¥æ“ä½œ
ALTER SYSTEM SET pgaudit.log = 'write';

-- ç»„åˆå®¡è®¡
ALTER SYSTEM SET pgaudit.log = 'ddl,write';
```

---

## 3. è‡ªå®šä¹‰å®¡è®¡

### 3.1 åˆ›å»ºå®¡è®¡è¡¨

```sql
-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    operation TEXT NOT NULL,
    user_name TEXT NOT NULL,
    old_data JSONB,
    new_data JSONB,
    changed_fields TEXT[],
    ip_address INET,
    application_name TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX audit_log_table_idx ON audit_log (table_name);
CREATE INDEX audit_log_user_idx ON audit_log (user_name);
CREATE INDEX audit_log_timestamp_idx ON audit_log (timestamp);
```

### 3.2 åˆ›å»ºå®¡è®¡è§¦å‘å™¨

```sql
-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
DECLARE
    old_data JSONB;
    new_data JSONB;
    changed_fields TEXT[];
BEGIN
    IF TG_OP = 'DELETE' THEN
        old_data := to_jsonb(OLD);
        INSERT INTO audit_log (
            table_name, operation, user_name,
            old_data, ip_address, application_name
        ) VALUES (
            TG_TABLE_NAME, TG_OP, current_user,
            old_data, inet_client_addr(), current_setting('application_name', true)
        );
        RETURN OLD;
    ELSIF TG_OP = 'UPDATE' THEN
        old_data := to_jsonb(OLD);
        new_data := to_jsonb(NEW);
        -- è®¡ç®—å˜æ›´å­—æ®µ
        SELECT array_agg(key)
        INTO changed_fields
        FROM jsonb_each(old_data)
        WHERE value IS DISTINCT FROM new_data->key;

        INSERT INTO audit_log (
            table_name, operation, user_name,
            old_data, new_data, changed_fields,
            ip_address, application_name
        ) VALUES (
            TG_TABLE_NAME, TG_OP, current_user,
            old_data, new_data, changed_fields,
            inet_client_addr(), current_setting('application_name', true)
        );
        RETURN NEW;
    ELSIF TG_OP = 'INSERT' THEN
        new_data := to_jsonb(NEW);
        INSERT INTO audit_log (
            table_name, operation, user_name,
            new_data, ip_address, application_name
        ) VALUES (
            TG_TABLE_NAME, TG_OP, current_user,
            new_data, inet_client_addr(), current_setting('application_name', true)
        );
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 åº”ç”¨å®¡è®¡è§¦å‘å™¨

```sql
-- ä¸ºè¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨
CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER audit_orders
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW
EXECUTE FUNCTION audit_trigger_function();
```

---

## 4. å®¡è®¡æ—¥å¿—åˆ†æ

### 4.1 æŸ¥è¯¢å®¡è®¡æ—¥å¿—

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„å®¡è®¡è®°å½•
SELECT * FROM audit_log
ORDER BY timestamp DESC
LIMIT 100;

-- æŸ¥çœ‹ç‰¹å®šè¡¨çš„æ“ä½œ
SELECT * FROM audit_log
WHERE table_name = 'users'
ORDER BY timestamp DESC;

-- æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ“ä½œ
SELECT * FROM audit_log
WHERE user_name = 'app_user'
ORDER BY timestamp DESC;
```

### 4.2 ç»Ÿè®¡åˆ†æ

```sql
-- æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡
SELECT
    operation,
    COUNT(*) AS count
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY operation
ORDER BY count DESC;

-- æŒ‰ç”¨æˆ·ç»Ÿè®¡
SELECT
    user_name,
    COUNT(*) AS count
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_name
ORDER BY count DESC;
```

---

## 5. åˆè§„å®¡è®¡

### 5.1 GDPRåˆè§„

```sql
-- è®°å½•æ•°æ®è®¿é—®
CREATE TABLE data_access_log (
    id BIGSERIAL PRIMARY KEY,
    user_name TEXT NOT NULL,
    table_name TEXT NOT NULL,
    record_id BIGINT,
    access_type TEXT,  -- 'read', 'export', 'delete'
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºè®¿é—®æ—¥å¿—è§¦å‘å™¨
CREATE OR REPLACE FUNCTION data_access_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO data_access_log (
        user_name, table_name, record_id, access_type
    ) VALUES (
        current_user, TG_TABLE_NAME, NEW.id, 'read'
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 æ•°æ®ä¿ç•™ç­–ç•¥

```sql
-- è‡ªåŠ¨æ¸…ç†æ—§å®¡è®¡æ—¥å¿—
CREATE OR REPLACE FUNCTION cleanup_audit_log()
RETURNS VOID AS $$
BEGIN
    DELETE FROM audit_log
    WHERE timestamp < NOW() - INTERVAL '7 years';  -- GDPRè¦æ±‚
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸæ‰§è¡Œï¼ˆä½¿ç”¨pg_cronï¼‰
SELECT cron.schedule('cleanup_audit', '0 3 * * *', 'SELECT cleanup_audit_log()');
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å¯ç”¨pgAudit** - ä½¿ç”¨æ ‡å‡†å®¡è®¡æ‰©å±•
2. **è‡ªå®šä¹‰å®¡è®¡** - ä¸ºå…³é”®è¡¨åˆ›å»ºè‡ªå®šä¹‰å®¡è®¡
3. **å®šæœŸåˆ†æ** - å®šæœŸåˆ†æå®¡è®¡æ—¥å¿—
4. **æ•°æ®ä¿ç•™** - æ ¹æ®åˆè§„è¦æ±‚ä¿ç•™å®¡è®¡æ—¥å¿—
5. **ç›‘æ§å¼‚å¸¸** - è®¾ç½®å‘Šè­¦ç›‘æ§å¼‚å¸¸æ“ä½œ

### âŒ é¿å…åšæ³•

1. **ä¸å¯ç”¨å®¡è®¡** - æ— æ³•è¿½è¸ªå®‰å…¨äº‹ä»¶
2. **å®¡è®¡è¿‡å¤š** - å½±å“æ€§èƒ½
3. **ä¸åˆ†ææ—¥å¿—** - å®¡è®¡æ—¥å¿—éœ€è¦åˆ†ææ‰æœ‰ä»·å€¼
4. **ä¸ä¿ç•™æ—¥å¿—** - æ— æ³•æ»¡è¶³åˆè§„è¦æ±‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md](./PostgreSQLå®‰å…¨åŠ å›ºå®Œæ•´æŒ‡å—.md) - å®Œæ•´åŠ å›ºæŒ‡å—
- [å®‰å…¨åŠ å›ºæ¸…å•.md](./å®‰å…¨åŠ å›ºæ¸…å•.md) - å®‰å…¨æ£€æŸ¥æ¸…å•
- [05-å®‰å…¨ä¸åˆè§„/README.md](../README.md) - å®‰å…¨ä¸åˆè§„ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
