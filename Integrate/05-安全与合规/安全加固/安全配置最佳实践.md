# 安全配置最佳实践

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [安全配置最佳实践](#安全配置最佳实践)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 认证配置](#2-认证配置)
    - [2.1 pg\_hba.conf配置](#21-pg_hbaconf配置)
    - [2.2 密码策略](#22-密码策略)
  - [3. 权限配置](#3-权限配置)
    - [3.1 最小权限原则](#31-最小权限原则)
    - [3.2 禁用PUBLIC权限](#32-禁用public权限)
  - [4. 加密配置](#4-加密配置)
    - [4.1 SSL/TLS配置](#41-ssltls配置)
    - [4.2 强制SSL连接](#42-强制ssl连接)
  - [5. 审计配置](#5-审计配置)
    - [5.1 pgAudit配置](#51-pgaudit配置)
    - [5.2 日志配置](#52-日志配置)
  - [6. 网络配置](#6-网络配置)
    - [6.1 连接限制](#61-连接限制)
    - [6.2 超时配置](#62-超时配置)
  - [7. 系统配置](#7-系统配置)
    - [7.1 禁用危险函数](#71-禁用危险函数)
    - [7.2 文件权限](#72-文件权限)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

安全配置是PostgreSQL安全的基础。本文档提供系统化的安全配置最佳实践。

---

## 2. 认证配置

### 2.1 pg_hba.conf配置

```bash
# 推荐配置
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# 本地连接（Unix socket）
local   all             all                                     scram-sha-256

# IPv4本地连接
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6本地连接
host    all             all             ::1/128                 scram-sha-256

# SSL连接（生产环境）
hostssl all             all             0.0.0.0/0                scram-sha-256

# 拒绝其他连接
host    all             all             0.0.0.0/0               reject
```

### 2.2 密码策略

```sql
-- 安装passwordcheck扩展（如果可用）
CREATE EXTENSION IF NOT EXISTS passwordcheck;

-- 配置密码复杂度（在postgresql.conf中）
-- passwordcheck.min_length = 12
-- passwordcheck.max_length = 128
```

---

## 3. 权限配置

### 3.1 最小权限原则

```sql
-- 创建应用用户（非超级用户）
CREATE USER app_user WITH PASSWORD 'strong_password';

-- 授予最小必要权限
GRANT CONNECT ON DATABASE mydb TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;

-- 限制连接数
ALTER USER app_user WITH CONNECTION LIMIT 10;
```

### 3.2 禁用PUBLIC权限

```sql
-- 撤销PUBLIC权限
REVOKE ALL ON DATABASE postgres FROM PUBLIC;
REVOKE ALL ON SCHEMA public FROM PUBLIC;
```

---

## 4. 加密配置

### 4.1 SSL/TLS配置

```sql
-- postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on
```

### 4.2 强制SSL连接

```sql
-- 在pg_hba.conf中只允许hostssl
# hostssl all all 0.0.0.0/0 scram-sha-256
```

---

## 5. 审计配置

### 5.1 pgAudit配置

```sql
-- 安装pgAudit
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- 配置审计日志
ALTER SYSTEM SET pgaudit.log = 'all';
ALTER SYSTEM SET pgaudit.log_catalog = off;
ALTER SYSTEM SET pgaudit.log_parameter = on;
ALTER SYSTEM SET pgaudit.log_statement_once = on;
```

### 5.2 日志配置

```sql
-- 记录所有DDL
ALTER SYSTEM SET log_statement = 'ddl';

-- 记录连接
ALTER SYSTEM SET log_connections = on;
ALTER SYSTEM SET log_disconnections = on;

-- 慢查询日志
ALTER SYSTEM SET log_min_duration_statement = 1000;
```

---

## 6. 网络配置

### 6.1 连接限制

```sql
-- 限制最大连接数
ALTER SYSTEM SET max_connections = 100;

-- 限制每个用户的连接数
ALTER USER app_user WITH CONNECTION LIMIT 10;
```

### 6.2 超时配置

```sql
-- 连接超时
ALTER SYSTEM SET tcp_keepalives_idle = 600;
ALTER SYSTEM SET tcp_keepalives_interval = 30;
ALTER SYSTEM SET tcp_keepalives_count = 3;
```

---

## 7. 系统配置

### 7.1 禁用危险函数

```sql
-- 撤销危险函数的PUBLIC权限
REVOKE EXECUTE ON FUNCTION pg_read_file(text) FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION pg_ls_dir(text) FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION pg_stat_file(text) FROM PUBLIC;
```

### 7.2 文件权限

```bash
# 配置文件权限
chmod 600 postgresql.conf
chmod 600 pg_hba.conf
chmod 600 server.key

# 数据目录权限
chmod 700 $PGDATA
```

---

## 📚 相关文档

- [PostgreSQL安全加固完整指南.md](./PostgreSQL安全加固完整指南.md) - 完整加固指南
- [安全加固清单.md](./安全加固清单.md) - 安全检查清单
- [05-安全与合规/README.md](../README.md) - 安全与合规主题

---

**最后更新**: 2025年1月
