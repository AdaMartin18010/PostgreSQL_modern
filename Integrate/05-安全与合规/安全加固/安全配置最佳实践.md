# 安全配置最佳实践

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [安全配置最佳实践](#安全配置最佳实践)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 认证配置](#2-认证配置)
    - [2.1 pg\_hba.conf配置](#21-pg_hbaconf配置)
    - [2.2 密码策略](#22-密码策略)
  - [3. 权限配置](#3-权限配置)
    - [3.1 最小权限原则](#31-最小权限原则)
    - [3.2 禁用PUBLIC权限](#32-禁用public权限)
  - [4. 加密配置](#4-加密配置)
    - [4.1 SSL/TLS配置](#41-ssltls配置)
    - [4.2 强制SSL连接](#42-强制ssl连接)
  - [5. 审计配置](#5-审计配置)
    - [5.1 pgAudit配置](#51-pgaudit配置)
    - [5.2 日志配置](#52-日志配置)
  - [6. 网络配置](#6-网络配置)
    - [6.1 连接限制](#61-连接限制)
    - [6.2 超时配置](#62-超时配置)
  - [7. 系统配置](#7-系统配置)
    - [7.1 禁用危险函数](#71-禁用危险函数)
    - [7.2 文件权限](#72-文件权限)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

安全配置是PostgreSQL安全的基础。本文档提供系统化的安全配置最佳实践。

---

## 2. 认证配置

### 2.1 pg_hba.conf配置

```bash
# 推荐配置
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# 本地连接（Unix socket）
local   all             all                                     scram-sha-256

# IPv4本地连接
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6本地连接
host    all             all             ::1/128                 scram-sha-256

# SSL连接（生产环境）
hostssl all             all             0.0.0.0/0                scram-sha-256

# 拒绝其他连接
host    all             all             0.0.0.0/0               reject
```

### 2.2 密码策略

```sql
-- 安装passwordcheck扩展（如果可用，带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'passwordcheck') THEN
            CREATE EXTENSION passwordcheck;
            RAISE NOTICE 'passwordcheck扩展安装成功';
        ELSE
            RAISE NOTICE 'passwordcheck扩展已存在';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE WARNING 'passwordcheck扩展不可用，需要先安装';
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限来安装扩展';
        WHEN OTHERS THEN
            RAISE WARNING '安装passwordcheck扩展失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 配置密码复杂度（在postgresql.conf中设置，需要超级用户权限）
-- passwordcheck.min_length = 12
-- passwordcheck.max_length = 128
-- 设置后需要重启PostgreSQL或执行: SELECT pg_reload_conf();
```

---

## 3. 权限配置

### 3.1 最小权限原则

```sql
-- 创建应用用户（非超级用户，带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            CREATE USER app_user WITH PASSWORD 'strong_password';
            RAISE NOTICE '应用用户创建成功';
        ELSE
            RAISE NOTICE '应用用户已存在';
        END IF;

        -- 授予最小必要权限
        IF EXISTS (SELECT 1 FROM pg_database WHERE datname = 'mydb') THEN
            GRANT CONNECT ON DATABASE mydb TO app_user;
            GRANT USAGE ON SCHEMA public TO app_user;
            GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;
            RAISE NOTICE '应用用户权限授予成功';
        ELSE
            RAISE WARNING '数据库 mydb 不存在，跳过权限授予';
        END IF;

        -- 限制连接数
        ALTER USER app_user WITH CONNECTION LIMIT 10;
        RAISE NOTICE '应用用户连接数限制已设置为10';
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE '应用用户已存在';
        WHEN undefined_database THEN
            RAISE WARNING '数据库 mydb 不存在';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '创建应用用户失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.2 禁用PUBLIC权限

```sql
-- 撤销PUBLIC权限（带错误处理）
DO $$
BEGIN
    BEGIN
        -- 检查数据库是否存在
        IF EXISTS (SELECT 1 FROM pg_database WHERE datname = 'postgres') THEN
            REVOKE ALL ON DATABASE postgres FROM PUBLIC;
            RAISE NOTICE '已撤销PUBLIC对postgres数据库的权限';
        ELSE
            RAISE WARNING '数据库 postgres 不存在';
        END IF;

        -- 撤销schema权限
        IF EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = 'public') THEN
            REVOKE ALL ON SCHEMA public FROM PUBLIC;
            RAISE NOTICE '已撤销PUBLIC对public schema的权限';
        ELSE
            RAISE WARNING 'schema public 不存在';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '撤销PUBLIC权限失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. 加密配置

### 4.1 SSL/TLS配置

```sql
-- SSL/TLS配置（带错误处理，需要超级用户权限）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来修改系统配置';
        END IF;

        -- 设置SSL配置
        ALTER SYSTEM SET ssl = on;
        ALTER SYSTEM SET ssl_cert_file = 'server.crt';
        ALTER SYSTEM SET ssl_key_file = 'server.key';
        ALTER SYSTEM SET ssl_ca_file = 'ca.crt';
        ALTER SYSTEM SET ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL';
        ALTER SYSTEM SET ssl_prefer_server_ciphers = on;

        -- 重新加载配置
        PERFORM pg_reload_conf();

        RAISE NOTICE 'SSL/TLS配置已设置并重新加载';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限';
        WHEN OTHERS THEN
            RAISE WARNING '设置SSL/TLS配置失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 注意：某些SSL配置可能需要重启PostgreSQL才能完全生效
```

### 4.2 强制SSL连接

```sql
-- 在pg_hba.conf中只允许hostssl
# hostssl all all 0.0.0.0/0 scram-sha-256
```

---

## 5. 审计配置

### 5.1 pgAudit配置

```sql
-- 安装pgAudit（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来安装扩展';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            -- 注意：pgaudit需要在shared_preload_libraries中配置后才能创建扩展
            CREATE EXTENSION pgaudit;
            RAISE NOTICE 'pgAudit扩展安装成功';
        ELSE
            RAISE NOTICE 'pgAudit扩展已存在';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE WARNING 'pgAudit扩展不可用，可能需要在shared_preload_libraries中配置';
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限来安装扩展';
        WHEN OTHERS THEN
            RAISE WARNING '安装pgAudit扩展失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 配置审计日志（带错误处理，需要超级用户权限）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来修改系统配置';
        END IF;

        ALTER SYSTEM SET pgaudit.log = 'all';
        ALTER SYSTEM SET pgaudit.log_catalog = off;
        ALTER SYSTEM SET pgaudit.log_parameter = on;
        ALTER SYSTEM SET pgaudit.log_statement_once = on;

        -- 重新加载配置
        PERFORM pg_reload_conf();

        RAISE NOTICE '审计日志配置已设置';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限';
        WHEN OTHERS THEN
            RAISE WARNING '配置审计日志失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 日志配置

```sql
-- 日志配置（带错误处理，需要超级用户权限）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来修改系统配置';
        END IF;

        -- 记录所有DDL
        ALTER SYSTEM SET log_statement = 'ddl';

        -- 记录连接
        ALTER SYSTEM SET log_connections = on;
        ALTER SYSTEM SET log_disconnections = on;

        -- 慢查询日志（1秒）
        ALTER SYSTEM SET log_min_duration_statement = 1000;

        -- 重新加载配置
        PERFORM pg_reload_conf();

        RAISE NOTICE '日志配置已设置';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限';
        WHEN OTHERS THEN
            RAISE WARNING '设置日志配置失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 6. 网络配置

### 6.1 连接限制

```sql
-- 连接限制配置（带错误处理，需要超级用户权限）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来修改系统配置';
        END IF;

        -- 限制最大连接数
        ALTER SYSTEM SET max_connections = 100;

        -- 注意：max_connections需要重启PostgreSQL才能生效
        RAISE NOTICE '最大连接数限制已设置（需要重启PostgreSQL生效）';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限';
        WHEN OTHERS THEN
            RAISE WARNING '设置连接数限制失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 限制每个用户的连接数（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE EXCEPTION '用户 app_user 不存在，请先创建该用户';
        END IF;

        ALTER USER app_user WITH CONNECTION LIMIT 10;
        RAISE NOTICE '用户 app_user 连接数限制已设置为10';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING '用户 app_user 不存在';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING '设置用户连接数限制失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 6.2 超时配置

```sql
-- 超时配置（带错误处理，需要超级用户权限）
DO $$
BEGIN
    BEGIN
        IF NOT (SELECT rolsuper FROM pg_roles WHERE rolname = current_user) THEN
            RAISE EXCEPTION '需要超级用户权限来修改系统配置';
        END IF;

        -- 连接超时配置
        ALTER SYSTEM SET tcp_keepalives_idle = 600;
        ALTER SYSTEM SET tcp_keepalives_interval = 30;
        ALTER SYSTEM SET tcp_keepalives_count = 3;

        -- 重新加载配置
        PERFORM pg_reload_conf();

        RAISE NOTICE '超时配置已设置';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION '需要超级用户权限';
        WHEN OTHERS THEN
            RAISE WARNING '设置超时配置失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 7. 系统配置

### 7.1 禁用危险函数

```sql
-- 撤销危险函数的PUBLIC权限（带错误处理）
DO $$
BEGIN
    BEGIN
        -- 检查函数是否存在并撤销PUBLIC权限
        IF EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'pg_catalog' AND p.proname = 'pg_read_file'
              AND pg_get_function_identity_arguments(p.oid) = 'text'
        ) THEN
            REVOKE EXECUTE ON FUNCTION pg_read_file(text) FROM PUBLIC;
            RAISE NOTICE '已撤销 pg_read_file(text) 的PUBLIC执行权限';
        ELSE
            RAISE NOTICE '函数 pg_read_file(text) 不存在或已撤销权限';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '撤销 pg_read_file 权限失败: %', SQLERRM;
    END;

    BEGIN
        IF EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'pg_catalog' AND p.proname = 'pg_ls_dir'
              AND pg_get_function_identity_arguments(p.oid) = 'text'
        ) THEN
            REVOKE EXECUTE ON FUNCTION pg_ls_dir(text) FROM PUBLIC;
            RAISE NOTICE '已撤销 pg_ls_dir(text) 的PUBLIC执行权限';
        ELSE
            RAISE NOTICE '函数 pg_ls_dir(text) 不存在或已撤销权限';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '撤销 pg_ls_dir 权限失败: %', SQLERRM;
    END;

    BEGIN
        IF EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'pg_catalog' AND p.proname = 'pg_stat_file'
              AND pg_get_function_identity_arguments(p.oid) = 'text'
        ) THEN
            REVOKE EXECUTE ON FUNCTION pg_stat_file(text) FROM PUBLIC;
            RAISE NOTICE '已撤销 pg_stat_file(text) 的PUBLIC执行权限';
        ELSE
            RAISE NOTICE '函数 pg_stat_file(text) 不存在或已撤销权限';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '撤销 pg_stat_file 权限失败: %', SQLERRM;
    END;
END $$;
```

### 7.2 文件权限

```bash
# 配置文件权限
chmod 600 postgresql.conf
chmod 600 pg_hba.conf
chmod 600 server.key

# 数据目录权限
chmod 700 $PGDATA
```

---

## 📚 相关文档

- [PostgreSQL安全加固完整指南.md](./PostgreSQL安全加固完整指南.md) - 完整加固指南
- [安全加固清单.md](./安全加固清单.md) - 安全检查清单
- [05-安全与合规/README.md](../README.md) - 安全与合规主题

---

**最后更新**: 2025年1月
