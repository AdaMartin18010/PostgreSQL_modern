# 安全事件响应

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [安全事件响应](#安全事件响应)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 事件分类](#2-事件分类)
    - [2.1 事件类型](#21-事件类型)
    - [2.2 事件严重程度](#22-事件严重程度)
  - [3. 响应流程](#3-响应流程)
    - [3.1 响应步骤](#31-响应步骤)
    - [3.2 响应团队](#32-响应团队)
  - [4. 事件处理](#4-事件处理)
    - [4.1 立即响应](#41-立即响应)
    - [4.2 数据保护](#42-数据保护)
    - [4.3 日志分析](#43-日志分析)
  - [5. 事件恢复](#5-事件恢复)
    - [5.1 系统恢复](#51-系统恢复)
    - [5.2 预防措施](#52-预防措施)
  - [6. 最佳实践](#6-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

安全事件响应是PostgreSQL安全的重要组成部分。包括：

- **事件检测** - 发现安全事件
- **事件分析** - 分析事件原因和影响
- **事件处理** - 处理安全事件
- **事件恢复** - 恢复系统正常状态

---

## 2. 事件分类

### 2.1 事件类型

| 类型 | 说明 | 严重程度 |
|------|------|---------|
| **数据泄露** | 未授权数据访问 | 严重 |
| **权限提升** | 未授权权限获取 | 严重 |
| **拒绝服务** | 系统不可用 | 高 |
| **恶意代码** | SQL注入、恶意脚本 | 严重 |
| **配置错误** | 安全配置错误 | 中 |

### 2.2 事件严重程度

| 级别 | 说明 | 响应时间 |
|------|------|---------|
| **P0** | 数据泄露、系统被攻破 | 立即 |
| **P1** | 严重安全威胁 | 1小时内 |
| **P2** | 中等安全威胁 | 4小时内 |
| **P3** | 低风险事件 | 24小时内 |

---

## 3. 响应流程

### 3.1 响应步骤

```text
1. 事件检测
   ↓
2. 事件确认
   ↓
3. 事件分析
   ↓
4. 事件处理
   ↓
5. 事件恢复
   ↓
6. 事件总结
```

### 3.2 响应团队

- **安全团队** - 负责事件分析和处理
- **DBA团队** - 负责数据库操作
- **开发团队** - 负责应用修复
- **管理层** - 负责决策和沟通

---

## 4. 事件处理

### 4.1 立即响应

```sql
-- 1. 断开可疑连接（带错误处理）
DO $$
DECLARE
    terminated_count INT := 0;
    conn_record RECORD;
BEGIN
    BEGIN
        FOR conn_record IN
            SELECT pid, usename, application_name, client_addr, state, query_start
            FROM pg_stat_activity
            WHERE usename = 'suspicious_user'
              AND pid != pg_backend_pid()  -- 不终止当前连接
        LOOP
            BEGIN
                PERFORM pg_terminate_backend(conn_record.pid);
                terminated_count := terminated_count + 1;
                RAISE NOTICE '已终止连接: PID=%, 用户=%, 应用=%, IP=%',
                    conn_record.pid, conn_record.usename,
                    conn_record.application_name, conn_record.client_addr;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING '终止连接失败 (PID=%): %', conn_record.pid, SQLERRM;
            END;
        END LOOP;

        RAISE NOTICE '共终止 % 个可疑连接', terminated_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '断开可疑连接失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. 禁用可疑用户（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'suspicious_user') THEN
            RAISE WARNING '用户 suspicious_user 不存在';
            RETURN;
        END IF;

        ALTER USER suspicious_user WITH NOLOGIN;
        RAISE NOTICE '用户 suspicious_user 已禁用登录';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING '用户 suspicious_user 不存在';
        WHEN OTHERS THEN
            RAISE WARNING '禁用用户失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. 撤销可疑权限（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'suspicious_user') THEN
            RAISE WARNING '用户 suspicious_user 不存在';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_database WHERE datname = 'mydb') THEN
            REVOKE ALL PRIVILEGES ON DATABASE mydb FROM suspicious_user;
            RAISE NOTICE '已撤销用户 suspicious_user 对数据库 mydb 的所有权限';
        ELSE
            RAISE WARNING '数据库 mydb 不存在';
        END IF;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING '用户或数据库不存在';
        WHEN OTHERS THEN
            RAISE WARNING '撤销权限失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. 检查异常活动（带错误处理和性能测试）
DO $$
DECLARE
    active_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO active_count
        FROM pg_stat_activity
        WHERE state = 'active'
          AND pid != pg_backend_pid();

        RAISE NOTICE '当前有 % 个活动连接', active_count;

        IF active_count > 0 THEN
            RAISE WARNING '发现异常活动，请检查以下连接:';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '检查异常活动失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    pid, usename, application_name, client_addr, state,
    query_start, query
FROM pg_stat_activity
WHERE state = 'active'
  AND pid != pg_backend_pid()
ORDER BY query_start;
```

### 4.2 数据保护

```sql
-- 1. 备份当前状态（使用Bash脚本，带错误处理）
-- 注意：pg_dump需要在Bash中执行，这里提供SQL检查脚本

-- 检查数据库是否存在
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'mydb') THEN
        RAISE EXCEPTION '数据库 mydb 不存在';
    END IF;
    RAISE NOTICE '数据库 mydb 存在，可以执行备份';
END $$;

-- 2. 检查数据完整性（带错误处理）
DO $$
DECLARE
    table_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_table') THEN
            RAISE WARNING '表 sensitive_table 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO table_count FROM sensitive_table;
        RAISE NOTICE '表 sensitive_table 中有 % 条记录', table_count;

        -- 检查是否有数据丢失
        IF table_count = 0 THEN
            RAISE WARNING '警告：表 sensitive_table 为空，可能存在数据丢失';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING '表 sensitive_table 不存在';
        WHEN OTHERS THEN
            RAISE WARNING '检查数据完整性失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT COUNT(*) FROM sensitive_table;

-- 3. 检查最近的数据变更（带错误处理和性能测试）
DO $$
DECLARE
    change_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING '审计日志表 audit_log 不存在，无法检查数据变更';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO change_count
        FROM audit_log
        WHERE timestamp >= NOW() - INTERVAL '24 hours';

        RAISE NOTICE '最近24小时内有 % 条数据变更记录', change_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '检查数据变更失败: %', SQLERRM;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC
LIMIT 100;
```

### 4.3 日志分析

```sql
-- 分析审计日志（带错误处理和性能测试）
DO $$
DECLARE
    stat_result RECORD;
    total_operations INT := 0;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING '审计日志表 audit_log 不存在，无法分析';
            RETURN;
        END IF;

        RAISE NOTICE '分析最近24小时的审计日志...';

        FOR stat_result IN
            SELECT
                user_name,
                table_name,
                operation,
                COUNT(*) AS count
            FROM audit_log
            WHERE timestamp >= NOW() - INTERVAL '24 hours'
            GROUP BY user_name, table_name, operation
            ORDER BY count DESC
        LOOP
            total_operations := total_operations + stat_result.count;
            RAISE NOTICE '用户: %, 表: %, 操作: %, 次数: %',
                stat_result.user_name, stat_result.table_name,
                stat_result.operation, stat_result.count;
        END LOOP;

        RAISE NOTICE '总计: % 次操作', total_operations;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '分析审计日志失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    user_name,
    table_name,
    operation,
    COUNT(*) AS count
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY user_name, table_name, operation
ORDER BY count DESC;

-- 查找异常IP（带错误处理和性能测试）
DO $$
DECLARE
    ip_record RECORD;
    ip_count INT := 0;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING '审计日志表 audit_log 不存在，无法查找异常IP';
            RETURN;
        END IF;

        RAISE NOTICE '查找最近24小时的异常IP地址...';

        FOR ip_record IN
            SELECT DISTINCT ip_address
            FROM audit_log
            WHERE timestamp >= NOW() - INTERVAL '24 hours'
              AND ip_address IS NOT NULL
            ORDER BY ip_address
        LOOP
            ip_count := ip_count + 1;
            RAISE NOTICE '发现IP: %', ip_record.ip_address;
        END LOOP;

        RAISE NOTICE '共发现 % 个不同的IP地址', ip_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '查找异常IP失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT DISTINCT ip_address
FROM audit_log
WHERE timestamp >= NOW() - INTERVAL '24 hours'
  AND ip_address IS NOT NULL
ORDER BY ip_address;
```

---

## 5. 事件恢复

### 5.1 系统恢复

```sql
-- 系统恢复步骤（带错误处理）
DO $$
BEGIN
    RAISE NOTICE '开始系统恢复流程...';

    -- 1. 修复安全漏洞
    BEGIN
        RAISE NOTICE '步骤1: 修复安全漏洞';
        -- 这里应该执行具体的修复操作，例如：
        -- - 应用安全补丁
        -- - 修复配置错误
        -- - 更新密码策略
        RAISE NOTICE '安全漏洞修复完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '修复安全漏洞失败: %', SQLERRM;
            RAISE;
    END;

    -- 2. 恢复数据（如需要）
    BEGIN
        RAISE NOTICE '步骤2: 检查是否需要恢复数据';
        -- 检查数据完整性
        -- 如果需要，从备份恢复数据
        RAISE NOTICE '数据恢复检查完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '数据恢复失败: %', SQLERRM;
            RAISE;
    END;

    -- 3. 重新启用服务
    BEGIN
        RAISE NOTICE '步骤3: 重新启用服务';
        -- 重新启用被禁用的用户
        -- 恢复正常的访问权限
        RAISE NOTICE '服务重新启用完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '重新启用服务失败: %', SQLERRM;
            RAISE;
    END;

    -- 4. 验证系统正常
    BEGIN
        RAISE NOTICE '步骤4: 验证系统正常';
        -- 检查数据库连接
        -- 检查关键表数据
        -- 检查系统性能
        RAISE NOTICE '系统验证完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '系统验证失败: %', SQLERRM;
            RAISE;
    END;

    RAISE NOTICE '系统恢复流程完成';
END $$;
```

### 5.2 预防措施

```sql
-- 预防措施实施（带错误处理）
DO $$
BEGIN
    RAISE NOTICE '开始实施预防措施...';

    -- 1. 加强安全配置
    BEGIN
        RAISE NOTICE '步骤1: 加强安全配置';
        -- 启用更严格的安全策略
        -- 更新pg_hba.conf配置
        -- 启用SSL/TLS
        RAISE NOTICE '安全配置已加强';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '加强安全配置失败: %', SQLERRM;
    END;

    -- 2. 更新补丁
    BEGIN
        RAISE NOTICE '步骤2: 检查并更新补丁';
        -- 检查PostgreSQL版本
        -- 应用安全补丁
        -- 更新扩展版本
        RAISE NOTICE '补丁更新检查完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '更新补丁失败: %', SQLERRM;
    END;

    -- 3. 加强监控
    BEGIN
        RAISE NOTICE '步骤3: 加强监控';
        -- 启用更详细的审计日志
        -- 设置告警规则
        -- 配置监控工具
        RAISE NOTICE '监控已加强';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '加强监控失败: %', SQLERRM;
    END;

    -- 4. 培训团队
    BEGIN
        RAISE NOTICE '步骤4: 团队培训';
        -- 组织安全培训
        -- 更新安全文档
        -- 建立响应流程
        RAISE NOTICE '团队培训计划已制定';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '培训计划制定失败: %', SQLERRM;
    END;

    RAISE NOTICE '预防措施实施完成';
END $$;
```

---

## 6. 最佳实践

### ✅ 推荐做法

1. **建立响应流程** - 制定标准响应流程
2. **定期演练** - 定期进行安全演练
3. **快速响应** - 根据严重程度快速响应
4. **详细记录** - 记录所有事件和处理过程
5. **持续改进** - 从事件中学习改进

### ❌ 避免做法

1. **忽视事件** - 安全事件必须处理
2. **不记录** - 无法分析和改进
3. **不沟通** - 需要及时沟通
4. **不恢复** - 事件后必须恢复系统

---

## 📚 相关文档

- [PostgreSQL安全加固完整指南.md](./PostgreSQL安全加固完整指南.md) - 完整加固指南
- [安全加固清单.md](./安全加固清单.md) - 安全检查清单
- [安全审计指南.md](./安全审计指南.md) - 审计指南
- [05-安全与合规/README.md](../README.md) - 安全与合规主题

---

**最后更新**: 2025年1月
