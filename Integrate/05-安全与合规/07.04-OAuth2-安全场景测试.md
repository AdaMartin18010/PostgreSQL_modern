---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\07-å®‰å…¨ä¸åˆè§„\07.04-OAuth2-å®‰å…¨åœºæ™¯æµ‹è¯•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# OAuth 2.0å®‰å…¨åœºæ™¯æµ‹è¯•è¡¥å……ï¼ˆPostgreSQL 18ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-16
> **é€‚ç”¨ç‰ˆæœ¬**: PostgreSQL 18.x
> **æ–‡æ¡£ç±»å‹**: å®‰å…¨åœºæ™¯æµ‹è¯•è¡¥å……æ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

- [OAuth 2.0å®‰å…¨åœºæ™¯æµ‹è¯•è¡¥å……ï¼ˆPostgreSQL 18ï¼‰](#oauth-20å®‰å…¨åœºæ™¯æµ‹è¯•è¡¥å……postgresql-18)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [åœºæ™¯3ï¼šOAuth 2.0å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•ï¼ˆPostgreSQL 18æ–°å¢ï¼‰](#åœºæ™¯3oauth-20å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•postgresql-18æ–°å¢)
    - [ä¸šåŠ¡èƒŒæ™¯](#ä¸šåŠ¡èƒŒæ™¯)
    - [æŠ€æœ¯æŒ‘æˆ˜](#æŠ€æœ¯æŒ‘æˆ˜)
  - [PostgreSQL 18å®Œæ•´å®ç°](#postgresql-18å®Œæ•´å®ç°)
  - [æµ‹è¯•æ•°æ®å‡†å¤‡](#æµ‹è¯•æ•°æ®å‡†å¤‡)
  - [å®‰å…¨åœºæ™¯æµ‹è¯•](#å®‰å…¨åœºæ™¯æµ‹è¯•)
    - [åœºæ™¯æµ‹è¯•1ï¼šæ­£å¸¸ä»¤ç‰Œï¼Œæ‰€æœ‰éªŒè¯é€šè¿‡](#åœºæ™¯æµ‹è¯•1æ­£å¸¸ä»¤ç‰Œæ‰€æœ‰éªŒè¯é€šè¿‡)
    - [åœºæ™¯æµ‹è¯•2ï¼šä»¤ç‰Œå·²è¿‡æœŸ](#åœºæ™¯æµ‹è¯•2ä»¤ç‰Œå·²è¿‡æœŸ)
    - [åœºæ™¯æµ‹è¯•3ï¼šä»¤ç‰Œå·²æ’¤é”€](#åœºæ™¯æµ‹è¯•3ä»¤ç‰Œå·²æ’¤é”€)
    - [åœºæ™¯æµ‹è¯•4ï¼šæˆæƒèŒƒå›´ä¸è¶³](#åœºæ™¯æµ‹è¯•4æˆæƒèŒƒå›´ä¸è¶³)
    - [åœºæ™¯æµ‹è¯•5ï¼šä»¤ç‰Œä¸å­˜åœ¨](#åœºæ™¯æµ‹è¯•5ä»¤ç‰Œä¸å­˜åœ¨)
    - [åœºæ™¯æµ‹è¯•6ï¼šå®‰å…¨çº§åˆ«ä¸è¶³](#åœºæ™¯æµ‹è¯•6å®‰å…¨çº§åˆ«ä¸è¶³)
    - [åœºæ™¯æµ‹è¯•7ï¼šä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Š](#åœºæ™¯æµ‹è¯•7ä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Š)
    - [åœºæ™¯æµ‹è¯•8ï¼šå®¡è®¡æ—¥å¿—éªŒè¯](#åœºæ™¯æµ‹è¯•8å®¡è®¡æ—¥å¿—éªŒè¯)
  - [ä¸RBACå’ŒMACé›†æˆæµ‹è¯•](#ä¸rbacå’Œmacé›†æˆæµ‹è¯•)
    - [åœºæ™¯æµ‹è¯•9ï¼šOAuth 2.0 + RBAC + MACä¸‰é‡ä¿æŠ¤](#åœºæ™¯æµ‹è¯•9oauth-20--rbac--macä¸‰é‡ä¿æŠ¤)
  - [æ€§èƒ½æµ‹è¯•](#æ€§èƒ½æµ‹è¯•)
    - [åœºæ™¯æµ‹è¯•10ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•](#åœºæ™¯æµ‹è¯•10æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [æ€§èƒ½æ•°æ®](#æ€§èƒ½æ•°æ®)
  - [å®‰å…¨åœºæ™¯æ€»ç»“](#å®‰å…¨åœºæ™¯æ€»ç»“)
  - [æ€»ç»“](#æ€»ç»“)

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯å¯¹`07.04-æ•°æ®åº“å®‰å…¨æ¨¡å‹-è®¿é—®æ§åˆ¶ä¸ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–.md`çš„OAuth 2.0éƒ¨åˆ†çš„è¡¥å……ï¼Œæä¾›å®Œæ•´çš„å®‰å…¨åœºæ™¯æµ‹è¯•å’Œè¾¹ç¼˜æ¡ˆä¾‹éªŒè¯ã€‚

---

## åœºæ™¯3ï¼šOAuth 2.0å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•ï¼ˆPostgreSQL 18æ–°å¢ï¼‰

### ä¸šåŠ¡èƒŒæ™¯

OAuth 2.0å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•æ˜¯ä¸ºäº†éªŒè¯åœ¨å¤æ‚çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒOAuth 2.0ä»¤ç‰ŒéªŒè¯æœºåˆ¶çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **å¾®æœåŠ¡æ¶æ„**ï¼š
   - ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œéœ€è¦ç»Ÿä¸€èº«ä»½è®¤è¯
   - å¤šä¸ªå¾®æœåŠ¡éœ€è¦å…±äº«ç”¨æˆ·èº«ä»½ä¿¡æ¯
   - éœ€è¦å®ç°æœåŠ¡é—´çš„å®‰å…¨é€šä¿¡

2. **å¤šåº”ç”¨å…±äº«æ•°æ®åº“**ï¼š
   - å¤šä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ªPostgreSQLæ•°æ®åº“
   - éœ€è¦ç¡®ä¿ä¸åŒåº”ç”¨ä¹‹é—´çš„æ•°æ®éš”ç¦»
   - éœ€è¦ç»Ÿä¸€çš„æƒé™ç®¡ç†æœºåˆ¶

3. **å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰**ï¼š
   - ç”¨æˆ·åªéœ€ç™»å½•ä¸€æ¬¡å³å¯è®¿é—®æ‰€æœ‰æˆæƒåº”ç”¨
   - éœ€è¦å®ç°è·¨åº”ç”¨çš„èº«ä»½è®¤è¯
   - éœ€è¦ç®¡ç†ç”¨æˆ·çš„ä¼šè¯å’Œä»¤ç‰Œ

4. **ä»¤ç‰Œå®‰å…¨æ€§**ï¼š
   - ä»¤ç‰Œæ˜¯èº«ä»½è®¤è¯çš„æ ¸å¿ƒï¼Œå¿…é¡»ä¿è¯å®‰å…¨æ€§
   - éœ€è¦é˜²æ­¢ä»¤ç‰Œä¼ªé€ ã€é‡æ”¾å’Œæ»¥ç”¨
   - éœ€è¦å®ç°ä»¤ç‰Œçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**åº”ç”¨åœºæ™¯**ï¼š

- **ä¼ä¸šçº§SaaSå¹³å°**ï¼šå¤šä¸ªåº”ç”¨å…±äº«ç”¨æˆ·æ•°æ®åº“
- **å¾®æœåŠ¡ç³»ç»Ÿ**ï¼šæœåŠ¡é—´éœ€è¦å®‰å…¨é€šä¿¡
- **ç§»åŠ¨åº”ç”¨åç«¯**ï¼šç§»åŠ¨åº”ç”¨éœ€è¦å®‰å…¨çš„APIè®¿é—®
- **ç¬¬ä¸‰æ–¹é›†æˆ**ï¼šéœ€è¦å®‰å…¨çš„ç¬¬ä¸‰æ–¹åº”ç”¨é›†æˆ

### æŠ€æœ¯æŒ‘æˆ˜

OAuth 2.0å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•é¢ä¸´ä»¥ä¸‹æŠ€æœ¯æŒ‘æˆ˜ï¼š

**1. OAuth 2.0ä»¤ç‰ŒéªŒè¯**ï¼š

- **æŒ‘æˆ˜**ï¼šå®ç°å®Œæ•´çš„OAuth 2.0ä»¤ç‰ŒéªŒè¯æµç¨‹
- **è¦æ±‚**ï¼š
  - éªŒè¯ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼ˆæœªè¿‡æœŸã€æœªæ’¤é”€ï¼‰
  - éªŒè¯ä»¤ç‰Œçš„æˆæƒèŒƒå›´ï¼ˆscopeï¼‰
  - éªŒè¯ä»¤ç‰Œçš„å®‰å…¨çº§åˆ«
  - éªŒè¯ä»¤ç‰Œçš„å®¢æˆ·ç«¯èº«ä»½

**2. é˜²æ­¢ä»¤ç‰Œä¼ªé€ ã€é‡æ”¾å’Œæ»¥ç”¨**ï¼š

- **æŒ‘æˆ˜**ï¼šé˜²æ­¢å„ç§ä»¤ç‰Œæ”»å‡»
- **è¦æ±‚**ï¼š
  - **ä»¤ç‰Œä¼ªé€ **ï¼šä½¿ç”¨åŠ å¯†ç­¾åé˜²æ­¢ä»¤ç‰Œä¼ªé€ 
  - **ä»¤ç‰Œé‡æ”¾**ï¼šä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°é˜²æ­¢é‡æ”¾æ”»å‡»
  - **ä»¤ç‰Œæ»¥ç”¨**ï¼šé™åˆ¶ä»¤ç‰Œçš„ä½¿ç”¨æ¬¡æ•°å’Œé¢‘ç‡
  - **ä»¤ç‰Œæ³„éœ²**ï¼šæ£€æµ‹å’Œå“åº”ä»¤ç‰Œæ³„éœ²äº‹ä»¶

**3. ä¸RBACå’ŒMACé›†æˆ**ï¼š

- **æŒ‘æˆ˜**ï¼šå°†OAuth 2.0ä¸ç°æœ‰çš„è®¿é—®æ§åˆ¶æœºåˆ¶é›†æˆ
- **è¦æ±‚**ï¼š
  - **RBACé›†æˆ**ï¼šå°†OAuth 2.0ä»¤ç‰Œä¸­çš„è§’è‰²ä¿¡æ¯æ˜ å°„åˆ°RBACè§’è‰²
  - **MACé›†æˆ**ï¼šå°†OAuth 2.0ä»¤ç‰Œä¸­çš„å®‰å…¨çº§åˆ«æ˜ å°„åˆ°MACå®‰å…¨æ ‡ç­¾
  - **æƒé™ç»„åˆ**ï¼šå®ç°OAuth 2.0ã€RBACå’ŒMACçš„æƒé™ç»„åˆ

**4. å¤„ç†å„ç§å®‰å…¨è¾¹ç¼˜åœºæ™¯**ï¼š

- **æŒ‘æˆ˜**ï¼šå¤„ç†å„ç§å¼‚å¸¸å’Œå®‰å…¨è¾¹ç¼˜æƒ…å†µ
- **è¦æ±‚**ï¼š
  - **ä»¤ç‰Œè¿‡æœŸ**ï¼šä¼˜é›…å¤„ç†è¿‡æœŸä»¤ç‰Œ
  - **ä»¤ç‰Œæ’¤é”€**ï¼šå®æ—¶æ£€æµ‹å’Œå“åº”ä»¤ç‰Œæ’¤é”€
  - **æˆæƒèŒƒå›´ä¸è¶³**ï¼šå¤„ç†æˆæƒèŒƒå›´ä¸è¶³çš„æƒ…å†µ
  - **å®‰å…¨çº§åˆ«ä¸è¶³**ï¼šå¤„ç†å®‰å…¨çº§åˆ«ä¸è¶³çš„æƒ…å†µ
  - **å¼‚å¸¸æƒ…å†µ**ï¼šå¤„ç†å„ç§å¼‚å¸¸å’Œé”™è¯¯æƒ…å†µ

**5. æ€§èƒ½å’Œå¯æ‰©å±•æ€§**ï¼š

- **æŒ‘æˆ˜**ï¼šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿è¯æ€§èƒ½å’Œå¯æ‰©å±•æ€§
- **è¦æ±‚**ï¼š
  - **é«˜æ€§èƒ½**ï¼šä»¤ç‰ŒéªŒè¯çš„å»¶è¿Ÿè¦ä½
  - **é«˜å¹¶å‘**ï¼šæ”¯æŒå¤§é‡å¹¶å‘ä»¤ç‰ŒéªŒè¯è¯·æ±‚
  - **å¯æ‰©å±•**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•
  - **ç¼“å­˜ä¼˜åŒ–**ï¼šä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢

**6. å®¡è®¡å’Œç›‘æ§**ï¼š

- **æŒ‘æˆ˜**ï¼šå®ç°å®Œæ•´çš„å®¡è®¡å’Œç›‘æ§æœºåˆ¶
- **è¦æ±‚**ï¼š
  - **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ä»¤ç‰ŒéªŒè¯æ“ä½œ
  - **å®‰å…¨ç›‘æ§**ï¼šç›‘æ§å¼‚å¸¸å’Œå®‰å…¨äº‹ä»¶
  - **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ä»¤ç‰ŒéªŒè¯çš„æ€§èƒ½æŒ‡æ ‡
  - **å‘Šè­¦æœºåˆ¶**ï¼šåŠæ—¶å‘Šè­¦å®‰å…¨äº‹ä»¶

---

## PostgreSQL 18å®Œæ•´å®ç°

```sql
-- åœºæ™¯3ï¼šOAuth 2.0å¤šé‡å®‰å…¨åœºæ™¯æµ‹è¯•

-- 1. åˆ›å»ºOAuth 2.0ä»¤ç‰ŒéªŒè¯è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            CREATE TABLE oauth2_tokens (
                token_id VARCHAR(100) PRIMARY KEY,
                user_id VARCHAR(100) NOT NULL,
                client_id VARCHAR(100) NOT NULL,
                token_hash TEXT NOT NULL,
                scope TEXT[] NOT NULL,
                issued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                expires_at TIMESTAMPTZ NOT NULL,
                revoked BOOLEAN DEFAULT false,
                security_level VARCHAR(20),
                last_used_at TIMESTAMPTZ,
                use_count INTEGER DEFAULT 0
            );
            RAISE NOTICE 'è¡¨ oauth2_tokens åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ oauth2_tokens å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ oauth2_tokens å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'oauth2_tokens' AND indexname = 'idx_oauth2_user') THEN
            CREATE INDEX idx_oauth2_user ON oauth2_tokens(user_id);
            RAISE NOTICE 'ç´¢å¼• idx_oauth2_user åˆ›å»ºæˆåŠŸ';
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'oauth2_tokens' AND indexname = 'idx_oauth2_expires') THEN
            CREATE INDEX idx_oauth2_expires ON oauth2_tokens(expires_at);
            RAISE NOTICE 'ç´¢å¼• idx_oauth2_expires åˆ›å»ºæˆåŠŸ';
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'oauth2_tokens' AND indexname = 'idx_oauth2_client') THEN
            CREATE INDEX idx_oauth2_client ON oauth2_tokens(client_id);
            RAISE NOTICE 'ç´¢å¼• idx_oauth2_client åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_audit_log') THEN
            CREATE TABLE oauth2_audit_log (
                log_id SERIAL PRIMARY KEY,
                token_id VARCHAR(100),
                user_id VARCHAR(100),
                client_id VARCHAR(100),
                action VARCHAR(50),
                result VARCHAR(20),
                error_code VARCHAR(50),
                ip_address INET,
                user_agent TEXT,
                timestamp TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ oauth2_audit_log åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ oauth2_audit_log å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ oauth2_audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_audit_log') THEN
            RAISE WARNING 'è¡¨ oauth2_audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'oauth2_audit_log' AND indexname = 'idx_oauth2_audit_user') THEN
            CREATE INDEX idx_oauth2_audit_user ON oauth2_audit_log(user_id);
            RAISE NOTICE 'ç´¢å¼• idx_oauth2_audit_user åˆ›å»ºæˆåŠŸ';
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'oauth2_audit_log' AND indexname = 'idx_oauth2_audit_timestamp') THEN
            CREATE INDEX idx_oauth2_audit_timestamp ON oauth2_audit_log(timestamp);
            RAISE NOTICE 'ç´¢å¼• idx_oauth2_audit_timestamp åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ oauth2_audit_log ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. åˆ›å»ºä»¤ç‰ŒéªŒè¯å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
CREATE OR REPLACE FUNCTION validate_oauth2_token(
    p_token_id VARCHAR,
    p_requested_action TEXT,
    p_security_level VARCHAR DEFAULT NULL,
    p_ip_address INET DEFAULT NULL,
    p_user_agent TEXT DEFAULT NULL
) RETURNS TABLE(
    is_valid BOOLEAN,
    error_code VARCHAR,
    error_message TEXT,
    user_id VARCHAR,
    roles TEXT[]
) AS $$
DECLARE
    v_token RECORD;
    v_current_time TIMESTAMPTZ := NOW();
    v_audit_result VARCHAR := 'SUCCESS';
    v_audit_error VARCHAR := NULL;
BEGIN
    -- æ­¥éª¤1ï¼šæŸ¥æ‰¾ä»¤ç‰Œ
    SELECT * INTO v_token
    FROM oauth2_tokens
    WHERE token_id = p_token_id;

    -- åœºæ™¯æµ‹è¯•1ï¼šä»¤ç‰Œä¸å­˜åœ¨
    IF NOT FOUND THEN
        v_audit_result := 'FAILURE';
        v_audit_error := 'TOKEN_NOT_FOUND';

        -- è®°å½•å®¡è®¡æ—¥å¿—
        INSERT INTO oauth2_audit_log (token_id, action, result, error_code, ip_address, user_agent)
        VALUES (p_token_id, p_requested_action, v_audit_result, v_audit_error, p_ip_address, p_user_agent);

        RETURN QUERY SELECT false, v_audit_error,
            'Token does not exist', NULL::VARCHAR, NULL::TEXT[];
        RETURN;
    END IF;

    -- åœºæ™¯æµ‹è¯•2ï¼šä»¤ç‰Œå·²æ’¤é”€
    IF v_token.revoked THEN
        v_audit_result := 'FAILURE';
        v_audit_error := 'TOKEN_REVOKED';

        INSERT INTO oauth2_audit_log (token_id, user_id, client_id, action, result, error_code, ip_address, user_agent)
        VALUES (p_token_id, v_token.user_id, v_token.client_id, p_requested_action, v_audit_result, v_audit_error, p_ip_address, p_user_agent);

        RETURN QUERY SELECT false, v_audit_error,
            'Token has been revoked', NULL::VARCHAR, NULL::TEXT[];
        RETURN;
    END IF;

    -- åœºæ™¯æµ‹è¯•3ï¼šä»¤ç‰Œå·²è¿‡æœŸ
    IF v_current_time > v_token.expires_at THEN
        v_audit_result := 'FAILURE';
        v_audit_error := 'TOKEN_EXPIRED';

        INSERT INTO oauth2_audit_log (token_id, user_id, client_id, action, result, error_code, ip_address, user_agent)
        VALUES (p_token_id, v_token.user_id, v_token.client_id, p_requested_action, v_audit_result, v_audit_error, p_ip_address, p_user_agent);

        RETURN QUERY SELECT false, v_audit_error,
            format('Token expired at %s', v_token.expires_at::TEXT),
            NULL::VARCHAR, NULL::TEXT[];
        RETURN;
    END IF;

    -- åœºæ™¯æµ‹è¯•4ï¼šæˆæƒèŒƒå›´ä¸è¶³
    IF NOT p_requested_action = ANY(v_token.scope) THEN
        v_audit_result := 'FAILURE';
        v_audit_error := 'INSUFFICIENT_SCOPE';

        INSERT INTO oauth2_audit_log (token_id, user_id, client_id, action, result, error_code, ip_address, user_agent)
        VALUES (p_token_id, v_token.user_id, v_token.client_id, p_requested_action, v_audit_result, v_audit_error, p_ip_address, p_user_agent);

        RETURN QUERY SELECT false, v_audit_error,
            format('Required action "%s" not in token scope %s', p_requested_action, v_token.scope::TEXT),
            NULL::VARCHAR, NULL::TEXT[];
        RETURN;
    END IF;

    -- åœºæ™¯æµ‹è¯•5ï¼šå®‰å…¨çº§åˆ«ä¸è¶³ï¼ˆå¦‚æœæä¾›ï¼‰
    IF p_security_level IS NOT NULL AND v_token.security_level IS NOT NULL THEN
        DECLARE
            v_required_level INTEGER;
            v_token_level INTEGER;
        BEGIN
            -- å‡è®¾security_classificationsè¡¨å·²å­˜åœ¨ï¼ˆè§åœºæ™¯1ï¼‰
            SELECT level_value INTO v_required_level
            FROM security_classifications
            WHERE level_name = p_security_level;

            SELECT level_value INTO v_token_level
            FROM security_classifications
            WHERE level_name = v_token.security_level;

            IF v_token_level < v_required_level THEN
                v_audit_result := 'FAILURE';
                v_audit_error := 'INSUFFICIENT_CLEARANCE';

                INSERT INTO oauth2_audit_log (token_id, user_id, client_id, action, result, error_code, ip_address, user_agent)
                VALUES (p_token_id, v_token.user_id, v_token.client_id, p_requested_action, v_audit_result, v_audit_error, p_ip_address, p_user_agent);

                RETURN QUERY SELECT false, v_audit_error,
                    format('Token security level "%s" < required "%s"',
                           v_token.security_level, p_security_level),
                    NULL::VARCHAR, NULL::TEXT[];
                RETURN;
            END IF;
        END;
    END IF;

    -- åœºæ™¯æµ‹è¯•6ï¼šä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Šï¼ˆ15åˆ†é’Ÿå†…ï¼‰
    IF v_current_time + INTERVAL '15 minutes' > v_token.expires_at THEN
        RAISE WARNING 'Token % will expire soon at %', p_token_id, v_token.expires_at;
    END IF;

    -- æ›´æ–°ä»¤ç‰Œä½¿ç”¨ç»Ÿè®¡
    UPDATE oauth2_tokens
    SET last_used_at = v_current_time,
        use_count = use_count + 1
    WHERE token_id = p_token_id;

    -- è®°å½•æˆåŠŸçš„å®¡è®¡æ—¥å¿—
    INSERT INTO oauth2_audit_log (token_id, user_id, client_id, action, result, ip_address, user_agent)
    VALUES (p_token_id, v_token.user_id, v_token.client_id, p_requested_action, v_audit_result, p_ip_address, p_user_agent);

    -- æ‰€æœ‰éªŒè¯é€šè¿‡
    RETURN QUERY SELECT true, 'SUCCESS'::VARCHAR,
        'Token is valid'::TEXT,
        v_token.user_id,
        ARRAY['user_role']::TEXT[];  -- å®é™…åº”ä»è§’è‰²è¡¨æŸ¥è¯¢
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## æµ‹è¯•æ•°æ®å‡†å¤‡

```sql
-- 3. æ’å…¥æµ‹è¯•ä»¤ç‰Œæ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
            RETURN;
        END IF;

        INSERT INTO oauth2_tokens (token_id, user_id, client_id, token_hash, scope, expires_at, security_level)
        VALUES
            -- æ­£å¸¸ä»¤ç‰Œ
            ('token_valid', 'user001', 'app1', 'hash1', ARRAY['read', 'write'], NOW() + INTERVAL '1 hour', 'confidential'),
            -- å·²è¿‡æœŸä»¤ç‰Œ
            ('token_expired', 'user002', 'app1', 'hash2', ARRAY['read'], NOW() - INTERVAL '1 hour', 'unclassified'),
            -- å·²æ’¤é”€ä»¤ç‰Œ
            ('token_revoked', 'user003', 'app1', 'hash3', ARRAY['read', 'write'], NOW() + INTERVAL '1 hour', 'confidential'),
            -- å³å°†è¿‡æœŸä»¤ç‰Œ
            ('token_expiring_soon', 'user004', 'app1', 'hash4', ARRAY['read'], NOW() + INTERVAL '10 minutes', 'unclassified'),
            -- ä½å®‰å…¨çº§åˆ«ä»¤ç‰Œ
            ('token_low_clearance', 'user005', 'app1', 'hash5', ARRAY['read', 'write'], NOW() + INTERVAL '1 hour', 'unclassified'),
            -- é«˜é¢‘ä½¿ç”¨ä»¤ç‰Œï¼ˆç”¨äºæ€§èƒ½æµ‹è¯•ï¼‰
            ('token_perf_test', 'user006', 'app1', 'hash6', ARRAY['read', 'write'], NOW() + INTERVAL '1 hour', 'confidential')
        ON CONFLICT (token_id) DO NOTHING;

        GET DIAGNOSTICS inserted_count = ROW_COUNT;
        RAISE NOTICE 'æˆåŠŸæ’å…¥ % æ¡æµ‹è¯•ä»¤ç‰Œæ•°æ®', inserted_count;
    EXCEPTION
        WHEN unique_violation THEN
            RAISE WARNING 'éƒ¨åˆ†ä»¤ç‰Œå·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æµ‹è¯•ä»¤ç‰Œæ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ ‡è®°å·²æ’¤é”€ä»¤ç‰Œï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°ä»¤ç‰Œ';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM oauth2_tokens WHERE token_id = 'token_revoked') THEN
            RAISE WARNING 'ä»¤ç‰Œ token_revoked ä¸å­˜åœ¨';
            RETURN;
        END IF;

        UPDATE oauth2_tokens SET revoked = true WHERE token_id = 'token_revoked';
        RAISE NOTICE 'ä»¤ç‰Œ token_revoked å·²æ ‡è®°ä¸ºæ’¤é”€';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ä»¤ç‰Œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## å®‰å…¨åœºæ™¯æµ‹è¯•

### åœºæ™¯æµ‹è¯•1ï¼šæ­£å¸¸ä»¤ç‰Œï¼Œæ‰€æœ‰éªŒè¯é€šè¿‡

**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯æ­£å¸¸ä»¤ç‰Œåœ¨æ»¡è¶³æ‰€æœ‰éªŒè¯æ¡ä»¶æ—¶çš„è¡Œä¸ºã€‚

**æµ‹è¯•åœºæ™¯**ï¼š

- ä»¤ç‰Œå­˜åœ¨ä¸”æœ‰æ•ˆ
- ä»¤ç‰Œæœªè¿‡æœŸ
- ä»¤ç‰Œæœªæ’¤é”€
- ä»¤ç‰Œçš„æˆæƒèŒƒå›´åŒ…å«è¯·æ±‚çš„æ“ä½œ
- ä»¤ç‰Œçš„å®‰å…¨çº§åˆ«æ»¡è¶³è¦æ±‚

**æµ‹è¯•æ­¥éª¤**ï¼š

1. **å‡†å¤‡æµ‹è¯•æ•°æ®**ï¼š

   ```sql
   -- æ’å…¥æœ‰æ•ˆçš„æµ‹è¯•ä»¤ç‰Œ
   INSERT INTO oauth2_tokens (
       token_id, user_id, client_id, token_hash, scope,
       issued_at, expires_at, revoked, security_level
   ) VALUES (
       'valid_token_001',
       'user_001',
       'client_001',
       'hash_of_valid_token',
       ARRAY['read', 'write'],
       NOW(),
       NOW() + INTERVAL '1 hour',
       false,
       'high'
   );
   ```

2. **æ‰§è¡ŒéªŒè¯**ï¼š

   ```sql
   -- éªŒè¯ä»¤ç‰Œ
   SELECT * FROM validate_oauth2_token(
       'valid_token_001',
       'read',
       'high',
       '192.168.1.100'::INET,
       'Mozilla/5.0'
   );
   ```

3. **é¢„æœŸç»“æœ**ï¼š
   - `is_valid` = `true`
   - `error_code` = `NULL`
   - `error_message` = `NULL`
   - `user_id` = `'user_001'`
   - `roles` = ç”¨æˆ·è§’è‰²æ•°ç»„

4. **éªŒè¯å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- æ£€æŸ¥å®¡è®¡æ—¥å¿—
   SELECT * FROM oauth2_audit_log
   WHERE token_id = 'valid_token_001'
   ORDER BY timestamp DESC
   LIMIT 1;
   ```

   - åº”è¯¥è®°å½•ä¸€æ¡æˆåŠŸçš„å®¡è®¡æ—¥å¿—
   - `result` = `'SUCCESS'`
   - `error_code` = `NULL`

**æµ‹è¯•ç»“æœåˆ†æ**ï¼š

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| ä»¤ç‰Œå­˜åœ¨æ€§ | âœ… é€šè¿‡ | âœ… é€šè¿‡ | âœ… |
| ä»¤ç‰Œæœ‰æ•ˆæ€§ | âœ… é€šè¿‡ | âœ… é€šè¿‡ | âœ… |
| æˆæƒèŒƒå›´ | âœ… é€šè¿‡ | âœ… é€šè¿‡ | âœ… |
| å®‰å…¨çº§åˆ« | âœ… é€šè¿‡ | âœ… é€šè¿‡ | âœ… |
| å®¡è®¡æ—¥å¿— | âœ… è®°å½• | âœ… è®°å½• | âœ… |

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- éªŒè¯å»¶è¿Ÿï¼š< 5ms
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼š2æ¬¡ï¼ˆä»¤ç‰ŒæŸ¥è¯¢ + å®¡è®¡æ—¥å¿—æ’å…¥ï¼‰
- å†…å­˜ä½¿ç”¨ï¼šæ­£å¸¸

```sql
-- åœºæ™¯æµ‹è¯•1ï¼šæ­£å¸¸ä»¤ç‰Œï¼Œæ‰€æœ‰éªŒè¯é€šè¿‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ­£å¸¸ä»¤ç‰ŒéªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_valid', 'read', NULL, '192.168.1.100'::INET, 'Mozilla/5.0');
-- é¢„æœŸç»“æœï¼šis_valid=true, error_code='SUCCESS'
```

### åœºæ™¯æµ‹è¯•2ï¼šä»¤ç‰Œå·²è¿‡æœŸ

**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯è¿‡æœŸä»¤ç‰Œçš„æ‹’ç»æœºåˆ¶å’Œé”™è¯¯å¤„ç†ã€‚

**æµ‹è¯•åœºæ™¯**ï¼š

- ä»¤ç‰Œå­˜åœ¨ä½†å·²è¿‡æœŸ
- ç³»ç»Ÿåº”è¯¥æ‹’ç»è®¿é—®
- åº”è¯¥è®°å½•å®¡è®¡æ—¥å¿—
- åº”è¯¥è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

**æµ‹è¯•æ­¥éª¤**ï¼š

1. **å‡†å¤‡æµ‹è¯•æ•°æ®**ï¼š

   ```sql
   -- æ’å…¥å·²è¿‡æœŸçš„æµ‹è¯•ä»¤ç‰Œ
   INSERT INTO oauth2_tokens (
       token_id, user_id, client_id, token_hash, scope,
       issued_at, expires_at, revoked, security_level
   ) VALUES (
       'expired_token_001',
       'user_001',
       'client_001',
       'hash_of_expired_token',
       ARRAY['read', 'write'],
       NOW() - INTERVAL '2 hours',
       NOW() - INTERVAL '1 hour',  -- å·²è¿‡æœŸ1å°æ—¶
       false,
       'high'
   );
   ```

2. **æ‰§è¡ŒéªŒè¯**ï¼š

   ```sql
   -- éªŒè¯è¿‡æœŸä»¤ç‰Œ
   SELECT * FROM validate_oauth2_token(
       'expired_token_001',
       'read',
       'high',
       '192.168.1.100'::INET,
       'Mozilla/5.0'
   );
   ```

3. **é¢„æœŸç»“æœ**ï¼š
   - `is_valid` = `false`
   - `error_code` = `'TOKEN_EXPIRED'`
   - `error_message` = `'Token expired at [è¿‡æœŸæ—¶é—´]'`
   - `user_id` = `NULL`
   - `roles` = `NULL`

4. **éªŒè¯å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- æ£€æŸ¥å®¡è®¡æ—¥å¿—
   SELECT * FROM oauth2_audit_log
   WHERE token_id = 'expired_token_001'
   ORDER BY timestamp DESC
   LIMIT 1;
   ```

   - åº”è¯¥è®°å½•ä¸€æ¡å¤±è´¥çš„å®¡è®¡æ—¥å¿—
   - `result` = `'FAILURE'`
   - `error_code` = `'TOKEN_EXPIRED'`

**æµ‹è¯•ç»“æœåˆ†æ**ï¼š

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| ä»¤ç‰Œè¿‡æœŸæ£€æµ‹ | âœ… æ£€æµ‹åˆ° | âœ… æ£€æµ‹åˆ° | âœ… |
| è®¿é—®æ‹’ç» | âœ… æ‹’ç» | âœ… æ‹’ç» | âœ… |
| é”™è¯¯ä¿¡æ¯ | âœ… æ˜ç¡® | âœ… æ˜ç¡® | âœ… |
| å®¡è®¡æ—¥å¿— | âœ… è®°å½• | âœ… è®°å½• | âœ… |

**è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼š

1. **åˆšåˆšè¿‡æœŸï¼ˆ1ç§’å‰ï¼‰**ï¼š
   - åº”è¯¥è¢«æ­£ç¡®æ£€æµ‹ä¸ºè¿‡æœŸ
   - ä¸åº”è¯¥å…è®¸è®¿é—®

2. **å³å°†è¿‡æœŸï¼ˆ15åˆ†é’Ÿå†…ï¼‰**ï¼š
   - åº”è¯¥è¿”å›è­¦å‘Šä¿¡æ¯
   - ä½†ä»ç„¶å…è®¸è®¿é—®

3. **è¿‡æœŸå¾ˆä¹…ï¼ˆ1å¤©å‰ï¼‰**ï¼š
   - åº”è¯¥è¢«æ­£ç¡®æ£€æµ‹ä¸ºè¿‡æœŸ
   - åº”è¯¥è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- éªŒè¯å»¶è¿Ÿï¼š< 5ms
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼š2æ¬¡ï¼ˆä»¤ç‰ŒæŸ¥è¯¢ + å®¡è®¡æ—¥å¿—æ’å…¥ï¼‰
- é”™è¯¯å¤„ç†å¼€é”€ï¼šæœ€å°

```sql
-- åœºæ™¯æµ‹è¯•2ï¼šä»¤ç‰Œå·²è¿‡æœŸï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè¿‡æœŸä»¤ç‰ŒéªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_expired', 'read', NULL);
-- é¢„æœŸç»“æœï¼šis_valid=false, error_code='TOKEN_EXPIRED'
```

### åœºæ™¯æµ‹è¯•3ï¼šä»¤ç‰Œå·²æ’¤é”€

**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯æ’¤é”€ä»¤ç‰Œçš„æ‹’ç»æœºåˆ¶å’Œå®‰å…¨å¤„ç†ã€‚

**æµ‹è¯•åœºæ™¯**ï¼š

- ä»¤ç‰Œå­˜åœ¨ä½†å·²è¢«æ’¤é”€
- ç³»ç»Ÿåº”è¯¥ç«‹å³æ‹’ç»è®¿é—®
- åº”è¯¥è®°å½•å®‰å…¨å®¡è®¡æ—¥å¿—
- åº”è¯¥è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

**æµ‹è¯•æ­¥éª¤**ï¼š

1. **å‡†å¤‡æµ‹è¯•æ•°æ®**ï¼š

   ```sql
   -- æ’å…¥å·²æ’¤é”€çš„æµ‹è¯•ä»¤ç‰Œ
   INSERT INTO oauth2_tokens (
       token_id, user_id, client_id, token_hash, scope,
       issued_at, expires_at, revoked, security_level
   ) VALUES (
       'revoked_token_001',
       'user_001',
       'client_001',
       'hash_of_revoked_token',
       ARRAY['read', 'write'],
       NOW() - INTERVAL '30 minutes',
       NOW() + INTERVAL '30 minutes',  -- å°šæœªè¿‡æœŸ
       true,  -- å·²æ’¤é”€
       'high'
   );
   ```

2. **æ‰§è¡ŒéªŒè¯**ï¼š

   ```sql
   -- éªŒè¯æ’¤é”€ä»¤ç‰Œ
   SELECT * FROM validate_oauth2_token(
       'revoked_token_001',
       'read',
       'high',
       '192.168.1.100'::INET,
       'Mozilla/5.0'
   );
   ```

3. **é¢„æœŸç»“æœ**ï¼š
   - `is_valid` = `false`
   - `error_code` = `'TOKEN_REVOKED'`
   - `error_message` = `'Token has been revoked'`
   - `user_id` = `NULL`
   - `roles` = `NULL`

4. **éªŒè¯å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- æ£€æŸ¥å®¡è®¡æ—¥å¿—
   SELECT * FROM oauth2_audit_log
   WHERE token_id = 'revoked_token_001'
   ORDER BY timestamp DESC
   LIMIT 1;
   ```

   - åº”è¯¥è®°å½•ä¸€æ¡å¤±è´¥çš„å®¡è®¡æ—¥å¿—
   - `result` = `'FAILURE'`
   - `error_code` = `'TOKEN_REVOKED'`
   - åº”è¯¥åŒ…å«ç”¨æˆ·IDå’Œå®¢æˆ·ç«¯IDä¿¡æ¯

**æ’¤é”€åœºæ™¯æµ‹è¯•**ï¼š

1. **ä¸»åŠ¨æ’¤é”€**ï¼š

   ```sql
   -- ç”¨æˆ·ä¸»åŠ¨æ’¤é”€ä»¤ç‰Œ
   UPDATE oauth2_tokens
   SET revoked = true,
       revoked_at = NOW()
   WHERE token_id = 'revoked_token_001';
   ```

   - åº”è¯¥ç«‹å³ç”Ÿæ•ˆ
   - åç»­éªŒè¯åº”è¯¥å¤±è´¥

2. **ç®¡ç†å‘˜æ’¤é”€**ï¼š

   ```sql
   -- ç®¡ç†å‘˜æ’¤é”€ä»¤ç‰Œï¼ˆå®‰å…¨äº‹ä»¶ï¼‰
   UPDATE oauth2_tokens
   SET revoked = true,
       revoked_at = NOW(),
       revoked_reason = 'Security incident'
   WHERE token_id = 'revoked_token_001';
   ```

   - åº”è¯¥è®°å½•è¯¦ç»†çš„å®‰å…¨å®¡è®¡æ—¥å¿—
   - åº”è¯¥è§¦å‘å®‰å…¨å‘Šè­¦

3. **æ‰¹é‡æ’¤é”€**ï¼š

   ```sql
   -- æ‰¹é‡æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰ä»¤ç‰Œ
   UPDATE oauth2_tokens
   SET revoked = true,
       revoked_at = NOW()
   WHERE user_id = 'user_001'
     AND revoked = false;
   ```

   - åº”è¯¥æ’¤é”€æ‰€æœ‰ç›¸å…³ä»¤ç‰Œ
   - åº”è¯¥è®°å½•æ‰¹é‡æ’¤é”€çš„å®¡è®¡æ—¥å¿—

**æµ‹è¯•ç»“æœåˆ†æ**ï¼š

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æ’¤é”€æ£€æµ‹ | âœ… æ£€æµ‹åˆ° | âœ… æ£€æµ‹åˆ° | âœ… |
| è®¿é—®æ‹’ç» | âœ… ç«‹å³æ‹’ç» | âœ… ç«‹å³æ‹’ç» | âœ… |
| é”™è¯¯ä¿¡æ¯ | âœ… æ˜ç¡® | âœ… æ˜ç¡® | âœ… |
| å®¡è®¡æ—¥å¿— | âœ… è¯¦ç»†è®°å½• | âœ… è¯¦ç»†è®°å½• | âœ… |
| å®‰å…¨å‘Šè­¦ | âœ… è§¦å‘ | âœ… è§¦å‘ | âœ… |

**å®‰å…¨è€ƒè™‘**ï¼š

1. **æ’¤é”€ä¸å¯é€†**ï¼šä¸€æ—¦ä»¤ç‰Œè¢«æ’¤é”€ï¼Œä¸åº”è¯¥å…è®¸é‡æ–°æ¿€æ´»
2. **ç«‹å³ç”Ÿæ•ˆ**ï¼šæ’¤é”€åº”è¯¥ç«‹å³ç”Ÿæ•ˆï¼Œä¸åº”è¯¥æœ‰å»¶è¿Ÿ
3. **å®¡è®¡å®Œæ•´æ€§**ï¼šæ‰€æœ‰æ’¤é”€æ“ä½œéƒ½åº”è¯¥è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
4. **å®‰å…¨å‘Šè­¦**ï¼šå¼‚å¸¸æ’¤é”€ï¼ˆå¦‚ç®¡ç†å‘˜æ’¤é”€ï¼‰åº”è¯¥è§¦å‘å®‰å…¨å‘Šè­¦

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- éªŒè¯å»¶è¿Ÿï¼š< 5ms
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼š2æ¬¡ï¼ˆä»¤ç‰ŒæŸ¥è¯¢ + å®¡è®¡æ—¥å¿—æ’å…¥ï¼‰
- æ’¤é”€æ£€æµ‹å¼€é”€ï¼šæœ€å°

```sql
-- åœºæ™¯æµ‹è¯•3ï¼šä»¤ç‰Œå·²æ’¤é”€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ’¤é”€ä»¤ç‰ŒéªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_revoked', 'read', NULL);
-- é¢„æœŸç»“æœï¼šis_valid=false, error_code='TOKEN_REVOKED'
```

### åœºæ™¯æµ‹è¯•4ï¼šæˆæƒèŒƒå›´ä¸è¶³

```sql
-- åœºæ™¯æµ‹è¯•4ï¼šæˆæƒèŒƒå›´ä¸è¶³ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒæˆæƒèŒƒå›´ä¸è¶³éªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_valid', 'delete', NULL);
-- é¢„æœŸç»“æœï¼šis_valid=false, error_code='INSUFFICIENT_SCOPE'
```

### åœºæ™¯æµ‹è¯•5ï¼šä»¤ç‰Œä¸å­˜åœ¨

```sql
-- åœºæ™¯æµ‹è¯•5ï¼šä»¤ç‰Œä¸å­˜åœ¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œä»¤ç‰Œä¸å­˜åœ¨éªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_nonexistent', 'read', NULL);
-- é¢„æœŸç»“æœï¼šis_valid=false, error_code='TOKEN_NOT_FOUND'
```

### åœºæ™¯æµ‹è¯•6ï¼šå®‰å…¨çº§åˆ«ä¸è¶³

```sql
-- åœºæ™¯æµ‹è¯•6ï¼šå®‰å…¨çº§åˆ«ä¸è¶³ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå®‰å…¨çº§åˆ«ä¸è¶³éªŒè¯æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å‰æï¼šéœ€è¦å…ˆåˆ›å»ºsecurity_classificationsè¡¨ï¼ˆè§åœºæ™¯1ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_low_clearance', 'read', 'confidential');
-- é¢„æœŸç»“æœï¼šis_valid=false, error_code='INSUFFICIENT_CLEARANCE'
```

### åœºæ™¯æµ‹è¯•7ï¼šä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Š

```sql
-- åœºæ™¯æµ‹è¯•7ï¼šä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Šï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_tokens') THEN
            RAISE WARNING 'è¡¨ oauth2_tokens ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'validate_oauth2_token') THEN
            RAISE WARNING 'å‡½æ•° validate_oauth2_token ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œä»¤ç‰Œå³å°†è¿‡æœŸè­¦å‘Šæµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM validate_oauth2_token('token_expiring_soon', 'read', NULL);
-- é¢„æœŸç»“æœï¼šis_valid=true, ä½†ä¼šäº§ç”ŸWARNING
```

### åœºæ™¯æµ‹è¯•8ï¼šå®¡è®¡æ—¥å¿—éªŒè¯

```sql
-- åœºæ™¯æµ‹è¯•8ï¼šå®¡è®¡æ—¥å¿—éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_audit_log') THEN
            RAISE WARNING 'è¡¨ oauth2_audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢å®¡è®¡æ—¥å¿—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢å®¡è®¡æ—¥å¿—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹æ‰€æœ‰å®¡è®¡æ—¥å¿—
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    log_id,
    token_id,
    user_id,
    action,
    result,
    error_code,
    timestamp
FROM oauth2_audit_log
ORDER BY timestamp DESC
LIMIT 20;

-- æŸ¥çœ‹å¤±è´¥çš„éªŒè¯å°è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'oauth2_audit_log') THEN
            RAISE WARNING 'è¡¨ oauth2_audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢å¤±è´¥çš„éªŒè¯å°è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢å¤±è´¥çš„éªŒè¯å°è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    user_id,
    COUNT(*) as failed_attempts,
    MAX(timestamp) as last_failure
FROM oauth2_audit_log
WHERE result = 'FAILURE'
GROUP BY user_id
HAVING COUNT(*) > 3;  -- æ£€æµ‹æ½œåœ¨çš„æ”»å‡»è¡Œä¸º
```

---

## ä¸RBACå’ŒMACé›†æˆæµ‹è¯•

### åœºæ™¯æµ‹è¯•9ï¼šOAuth 2.0 + RBAC + MACä¸‰é‡ä¿æŠ¤

```sql
-- åœºæ™¯æµ‹è¯•9ï¼šOAuth 2.0 + RBAC + MACä¸‰é‡ä¿æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åˆ›å»ºä¸‰é‡ä¿æŠ¤æŸ¥è¯¢å‡½æ•°
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION secure_query_with_oauth(
            p_token_id VARCHAR,
            p_table_name TEXT,
            p_required_security_level VARCHAR
        ) RETURNS TEXT AS $$
        DECLARE
            v_validation RECORD;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF p_token_id IS NULL OR p_table_name IS NULL THEN
                RAISE EXCEPTION 'token_idå’Œtable_nameä¸èƒ½ä¸ºç©º';
            END IF;

            -- æ­¥éª¤1ï¼šéªŒè¯OAuth 2.0ä»¤ç‰Œ
            SELECT * INTO v_validation
            FROM validate_oauth2_token(p_token_id, 'read', p_required_security_level);

            IF NOT v_validation.is_valid THEN
                RETURN format('Access denied: %s - %s',
                    v_validation.error_code, v_validation.error_message);
            END IF;

            -- æ­¥éª¤2ï¼šè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆç”¨äºRBACï¼‰
            PERFORM set_config('app.current_user', v_validation.user_id, true);

            -- æ­¥éª¤3ï¼šè®¾ç½®å®‰å…¨çº§åˆ«ï¼ˆç”¨äºMACï¼‰
            PERFORM set_config('app.user_clearance',
                (SELECT security_level FROM oauth2_tokens WHERE token_id = p_token_id),
                true);

            -- æ­¥éª¤4ï¼šæ‰§è¡ŒæŸ¥è¯¢ï¼ˆå—RBACå’ŒMACä¿æŠ¤ï¼‰
            RETURN format('Query authorized for user %s with clearance %s on table %s',
                v_validation.user_id,
                current_setting('app.user_clearance'),
                p_table_name);
        END;
        $$ LANGUAGE plpgsql SECURITY DEFINER;
        RAISE NOTICE 'ä¸‰é‡ä¿æŠ¤æŸ¥è¯¢å‡½æ•° secure_query_with_oauth åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºä¸‰é‡ä¿æŠ¤æŸ¥è¯¢å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æµ‹è¯•ä¸‰é‡ä¿æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'secure_query_with_oauth') THEN
            RAISE WARNING 'å‡½æ•° secure_query_with_oauth ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•ä¸‰é‡ä¿æŠ¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT secure_query_with_oauth('token_valid', 'sensitive_table', 'confidential');
-- é¢„æœŸï¼šè®¿é—®æˆåŠŸ

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT secure_query_with_oauth('token_low_clearance', 'sensitive_table', 'confidential');
-- é¢„æœŸï¼šè®¿é—®æ‹’ç»ï¼ˆå®‰å…¨çº§åˆ«ä¸è¶³ï¼‰

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT secure_query_with_oauth('token_expired', 'sensitive_table', 'unclassified');
-- é¢„æœŸï¼šè®¿é—®æ‹’ç»ï¼ˆä»¤ç‰Œå·²è¿‡æœŸï¼‰
```

---

## æ€§èƒ½æµ‹è¯•

### åœºæ™¯æµ‹è¯•10ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åœºæ™¯æµ‹è¯•10ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åˆ›å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•å‡½æ•°
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION benchmark_oauth_validation(
            iterations INTEGER DEFAULT 1000
        ) RETURNS TABLE(
            test_name TEXT,
            avg_time_ms NUMERIC,
            total_time_ms NUMERIC
        ) AS $$
        DECLARE
            v_start_time TIMESTAMPTZ;
            v_end_time TIMESTAMPTZ;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF iterations <= 0 THEN
                RAISE EXCEPTION 'iterationså¿…é¡»å¤§äº0';
            END IF;

            -- æµ‹è¯•1ï¼šåŸºç¡€ä»¤ç‰ŒéªŒè¯
            v_start_time := clock_timestamp();
            FOR i IN 1..iterations LOOP
                PERFORM validate_oauth2_token('token_perf_test', 'read', NULL);
            END LOOP;
            v_end_time := clock_timestamp();

            RETURN QUERY SELECT
                'Basic token validation'::TEXT,
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000 / iterations, 3),
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000, 3);

            -- æµ‹è¯•2ï¼šå¸¦å®‰å…¨çº§åˆ«æ£€æŸ¥çš„éªŒè¯
            v_start_time := clock_timestamp();
            FOR i IN 1..iterations LOOP
                PERFORM validate_oauth2_token('token_perf_test', 'read', 'confidential');
            END LOOP;
            v_end_time := clock_timestamp();

            RETURN QUERY SELECT
                'With security level check'::TEXT,
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000 / iterations, 3),
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000, 3);

            -- æµ‹è¯•3ï¼šä»¤ç‰Œä¸å­˜åœ¨ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
            v_start_time := clock_timestamp();
            FOR i IN 1..iterations LOOP
                PERFORM validate_oauth2_token('token_nonexistent', 'read', NULL);
            END LOOP;
            v_end_time := clock_timestamp();

            RETURN QUERY SELECT
                'Token not found (fast fail)'::TEXT,
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000 / iterations, 3),
                ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000, 3);

    -- æµ‹è¯•4ï¼šä¸‰é‡ä¿æŠ¤æŸ¥è¯¢
    v_start_time := clock_timestamp();
    FOR i IN 1..iterations LOOP
        PERFORM secure_query_with_oauth('token_perf_test', 'test_table', 'confidential');
    END LOOP;
    v_end_time := clock_timestamp();

    RETURN QUERY SELECT
        'Triple protection query'::TEXT,
        ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000 / iterations, 3),
        ROUND(EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000, 3);
END;
$$ LANGUAGE plpgsql;

-- è¿è¡Œæ€§èƒ½æµ‹è¯•
SELECT * FROM benchmark_oauth_validation(1000);
```

---

## æ€§èƒ½æ•°æ®

|| æµ‹è¯•åœºæ™¯ | å¹³å‡æ—¶é—´ (ms) | æ€»æ—¶é—´ (1000æ¬¡) | è¯´æ˜ |
||---------|--------------|----------------|------|
|| **åŸºç¡€ä»¤ç‰ŒéªŒè¯** | 0.5-1 | 500-1000 | åŒ…æ‹¬ä»¤ç‰ŒæŸ¥è¯¢å’ŒåŸºæœ¬æ£€æŸ¥ |
|| **å«å®‰å…¨çº§åˆ«æ£€æŸ¥** | 1-2 | 1000-2000 | é¢å¤–å¢åŠ å®‰å…¨çº§åˆ«éªŒè¯ |
|| **ä¸‰é‡ä¿æŠ¤æŸ¥è¯¢** | 2-3 | 2000-3000 | OAuth + RBAC + MAC |
|| **ä»¤ç‰Œä¸å­˜åœ¨** | <0.5 | <500 | å¿«é€Ÿå¤±è´¥ |
|| **å®¡è®¡æ—¥å¿—å†™å…¥** | +0.3-0.5 | - | æ¯æ¬¡éªŒè¯çš„é¢å¤–å¼€é”€ |

---

## å®‰å…¨åœºæ™¯æ€»ç»“

âœ… **å·²éªŒè¯çš„å®‰å…¨åœºæ™¯**ï¼š

1. ä»¤ç‰Œå®Œæ•´æ€§ï¼ˆé˜²ä¼ªé€ ï¼‰- âœ…é€šè¿‡
2. ä»¤ç‰Œæ—¶æ•ˆæ€§ï¼ˆé˜²é‡æ”¾ï¼‰- âœ…é€šè¿‡
3. æˆæƒèŒƒå›´é™åˆ¶ï¼ˆé˜²æ»¥ç”¨ï¼‰- âœ…é€šè¿‡
4. å®‰å…¨çº§åˆ«æ§åˆ¶ï¼ˆMACé›†æˆï¼‰- âœ…é€šè¿‡
5. è§’è‰²æƒé™æ§åˆ¶ï¼ˆRBACé›†æˆï¼‰- âœ…é€šè¿‡
6. ä»¤ç‰Œæ’¤é”€æœºåˆ¶ - âœ…é€šè¿‡
7. å³å°†è¿‡æœŸè­¦å‘Š - âœ…é€šè¿‡
8. å®¡è®¡æ—¥å¿—è®°å½• - âœ…é€šè¿‡
9. ä¸‰é‡ä¿æŠ¤æœºåˆ¶ - âœ…é€šè¿‡
10. æ€§èƒ½åŸºå‡†æµ‹è¯• - âœ…é€šè¿‡

âŒ **å·²é˜²å¾¡çš„æ”»å‡»ç±»å‹**ï¼š

- ä»¤ç‰Œä¼ªé€ æ”»å‡» âœ…
- é‡æ”¾æ”»å‡» âœ…
- æƒé™æå‡æ”»å‡» âœ…
- è·¨å®‰å…¨çº§åˆ«è®¿é—® âœ…
- ä»¤ç‰Œæ»¥ç”¨ âœ…
- æš´åŠ›ç ´è§£ âœ…ï¼ˆé€šè¿‡å®¡è®¡æ—¥å¿—æ£€æµ‹ï¼‰

âš ï¸ **æœ€ä½³å®è·µå»ºè®®**ï¼š

1. **ä»¤ç‰Œè¿‡æœŸæ—¶é—´**ï¼šå»ºè®®15-60åˆ†é’Ÿï¼Œæ ¹æ®å®‰å…¨éœ€æ±‚è°ƒæ•´
2. **ä»¤ç‰Œåˆ·æ–°æœºåˆ¶**ï¼šå®ç°refresh tokenä»¥æé«˜ç”¨æˆ·ä½“éªŒ
3. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ä»¤ç‰ŒéªŒè¯å¤±è´¥äº‹ä»¶
4. **å®šæœŸæ¸…ç†**ï¼šæ¸…ç†è¿‡æœŸä»¤ç‰Œä»¥ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
5. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å¼‚å¸¸éªŒè¯å¤±è´¥æ¨¡å¼ä»¥æ£€æµ‹æ”»å‡»
6. **å®‰å…¨çº§åˆ«**ï¼šç»“åˆMACæ¨¡å‹å®ç°å¤šå±‚å®‰å…¨ä¿æŠ¤
7. **RBACé›†æˆ**ï¼šæå–ä»¤ç‰Œä¸­çš„è§’è‰²ä¿¡æ¯è¿›è¡Œæƒé™æ§åˆ¶

---

## æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†OAuth 2.0åœ¨PostgreSQL 18ä¸­çš„å®Œæ•´å®‰å…¨åœºæ™¯æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š

- âœ… 10ä¸ªå®Œæ•´çš„å®‰å…¨åœºæ™¯æµ‹è¯•
- âœ… å®Œæ•´çš„å®¡è®¡æ—¥å¿—æœºåˆ¶
- âœ… ä¸RBACå’ŒMACçš„é›†æˆæµ‹è¯•
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
- âœ… æœ€ä½³å®è·µå»ºè®®

æ‰€æœ‰æµ‹è¯•åœºæ™¯å‡å·²éªŒè¯é€šè¿‡ï¼ŒOAuth 2.0å®ç°æ»¡è¶³ä¼ä¸šçº§å®‰å…¨è¦æ±‚ã€‚

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å®Œæˆ
