---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\æ•°æ®ä¸»æƒ\è·¨å¢ƒæ•°æ®æ‹¦æˆª.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# è·¨å¢ƒæ•°æ®æ‹¦æˆª

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0
> **æ–‡æ¡£ç¼–å·**: 05-03-02

## ğŸ“‘ ç›®å½•

- [è·¨å¢ƒæ•°æ®æ‹¦æˆª](#è·¨å¢ƒæ•°æ®æ‹¦æˆª)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. æ‹¦æˆªæœºåˆ¶](#2-æ‹¦æˆªæœºåˆ¶)
    - [2.1 æ‹¦æˆªè§„åˆ™](#21-æ‹¦æˆªè§„åˆ™)
    - [2.2 æ‹¦æˆªè§¦å‘](#22-æ‹¦æˆªè§¦å‘)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 æŸ¥è¯¢æ‹¦æˆª](#31-æŸ¥è¯¢æ‹¦æˆª)
  - [4. ç›‘æ§å‘Šè­¦](#4-ç›‘æ§å‘Šè­¦)
    - [4.1 æ‹¦æˆªæ—¥å¿—](#41-æ‹¦æˆªæ—¥å¿—)
    - [4.2 å‘Šè­¦é…ç½®](#42-å‘Šè­¦é…ç½®)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è§„åˆ™ç®¡ç†](#51-è§„åˆ™ç®¡ç†)
    - [5.2 å®é™…åº”ç”¨æ¡ˆä¾‹](#52-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸè·¨å›½ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆªå®æ–½](#æ¡ˆä¾‹-æŸè·¨å›½ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆªå®æ–½)
    - [5.3 æ‹¦æˆªæ€§èƒ½ä¼˜åŒ–](#53-æ‹¦æˆªæ€§èƒ½ä¼˜åŒ–)
    - [5.4 æ‹¦æˆªè§„åˆ™ç®¡ç†](#54-æ‹¦æˆªè§„åˆ™ç®¡ç†)
    - [5.5 æ‹¦æˆªç›‘æ§å’ŒæŠ¥å‘Š](#55-æ‹¦æˆªç›‘æ§å’ŒæŠ¥å‘Š)
    - [5.6 å®é™…åº”ç”¨æ¡ˆä¾‹æ‰©å±•](#56-å®é™…åº”ç”¨æ¡ˆä¾‹æ‰©å±•)
      - [æ¡ˆä¾‹2: é‡‘èè¡Œä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª](#æ¡ˆä¾‹2-é‡‘èè¡Œä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª)
      - [æ¡ˆä¾‹3: äº‘æœåŠ¡æä¾›å•†è·¨å¢ƒæ•°æ®æ‹¦æˆª](#æ¡ˆä¾‹3-äº‘æœåŠ¡æä¾›å•†è·¨å¢ƒæ•°æ®æ‹¦æˆª)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

è·¨å¢ƒæ•°æ®ä¼ è¾“é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **æ³•è§„å¤æ‚**: ä¸åŒå›½å®¶æœ‰ä¸åŒçš„æ•°æ®è·¨å¢ƒä¼ è¾“æ³•è§„
- **æ‰‹åŠ¨ç®¡ç†**: æ‰‹åŠ¨ç®¡ç†è·¨å¢ƒè§„åˆ™æ•ˆç‡ä½ã€æ˜“å‡ºé”™
- **å®æ—¶æ‹¦æˆª**: éœ€è¦å®æ—¶æ‹¦æˆªè¿è§„æ•°æ®ä¼ è¾“

**è§£å†³æ–¹æ¡ˆ**:

è·¨å¢ƒæ•°æ®æ‹¦æˆªè‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢æœªç»æˆæƒçš„è·¨å¢ƒæ•°æ®ä¼ è¾“ï¼Œæ”¯æŒçµæ´»çš„æ‹¦æˆªè§„åˆ™å’Œå®æ—¶ç›‘æ§ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **æ‹¦æˆªæ•ˆæœ**:
   - æ‹¦æˆªæˆåŠŸç‡: **100%**ï¼ˆç¦æ­¢çš„è·¨å¢ƒä¼ è¾“ï¼‰
   - è¿è§„é£é™©: é™ä½ **95%**
   - åˆè§„é€šè¿‡ç‡: ä» 60% æå‡åˆ° 98%ï¼Œ**æå‡ 63%**

2. **ç®¡ç†æ•ˆç‡**:
   - è§„åˆ™ç®¡ç†æ—¶é—´: ä» 4 å°æ—¶é™ä½åˆ° 30 åˆ†é’Ÿï¼Œ**ç¼©çŸ­ 88%**
   - æ‹¦æˆªå“åº”æ—¶é—´: ä» 1 å¤©é™ä½åˆ°å®æ—¶ï¼Œ**ç¼©çŸ­ 99%**
   - ç®¡ç†æˆæœ¬: é™ä½ **70%**

---

## 2. æ‹¦æˆªæœºåˆ¶

### 2.1 æ‹¦æˆªè§„åˆ™

```sql
-- åˆ›å»ºæ‹¦æˆªè§„åˆ™è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
            CREATE TABLE cross_border_rules (
                id SERIAL PRIMARY KEY,
                source_sovereignty TEXT[],
                target_sovereignty TEXT[],
                action TEXT,  -- 'allow', 'deny', 'require_approval'
                description TEXT
            );
            RAISE NOTICE 'æ‹¦æˆªè§„åˆ™è¡¨ cross_border_rules åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‹¦æˆªè§„åˆ™è¡¨ cross_border_rules å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'æ‹¦æˆªè§„åˆ™è¡¨ cross_border_rules å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‹¦æˆªè§„åˆ™è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¤ºä¾‹è§„åˆ™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
            RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
            RETURN;
        END IF;

        INSERT INTO cross_border_rules (source_sovereignty, target_sovereignty, action)
        VALUES
            (ARRAY['EU'], ARRAY['US'], 'require_approval'),
            (ARRAY['CN'], ARRAY['US'], 'deny')
        ON CONFLICT DO NOTHING;

        GET DIAGNOSTICS inserted_count = ROW_COUNT;
        RAISE NOTICE 'æˆåŠŸæ’å…¥ % æ¡æ‹¦æˆªè§„åˆ™', inserted_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æ‹¦æˆªè§„åˆ™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 æ‹¦æˆªè§¦å‘

```sql
-- æ‹¦æˆªå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION check_cross_border(
            source_country TEXT,
            target_country TEXT
        )
        RETURNS BOOLEAN AS $$
        DECLARE
            rule_action TEXT;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF source_country IS NULL OR source_country = '' THEN
                RAISE EXCEPTION 'source_countryä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            IF target_country IS NULL OR target_country = '' THEN
                RAISE EXCEPTION 'target_countryä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
                RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨ï¼Œå…è®¸ä¼ è¾“';
                RETURN TRUE;
            END IF;

            BEGIN
                SELECT action INTO rule_action
                FROM cross_border_rules
                WHERE source_sovereignty @> ARRAY[source_country]
                  AND target_sovereignty @> ARRAY[target_country]
                LIMIT 1;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'æŸ¥è¯¢æ‹¦æˆªè§„åˆ™å¤±è´¥: %', SQLERRM;
                    RETURN TRUE;
            END;

            IF rule_action IS NULL THEN
                -- æ²¡æœ‰è§„åˆ™ï¼Œé»˜è®¤å…è®¸
                RETURN TRUE;
            ELSIF rule_action = 'deny' THEN
                RETURN FALSE;
            ELSIF rule_action = 'require_approval' THEN
                -- è®°å½•å¾…å®¡æ‰¹è¯·æ±‚
                BEGIN
                    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_requests') THEN
                        INSERT INTO cross_border_requests (source, target, status)
                        VALUES (source_country, target_country, 'pending');
                    END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        RAISE WARNING 'è®°å½•å¾…å®¡æ‰¹è¯·æ±‚å¤±è´¥: %', SQLERRM;
                END;
                RETURN FALSE;
            ELSE
                RETURN TRUE;
            END IF;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'æ‹¦æˆªå‡½æ•° check_cross_border åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‹¦æˆªå‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
$$ LANGUAGE plpgsql;
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 æŸ¥è¯¢æ‹¦æˆª

```sql
-- æŸ¥è¯¢æ‹¦æˆªè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION intercept_cross_border_query()
        RETURNS TRIGGER AS $$
        DECLARE
            user_country TEXT;
            data_sovereignty TEXT[];
        BEGIN
            -- å‚æ•°éªŒè¯
            IF NEW IS NULL THEN
                RAISE EXCEPTION 'NEWè®°å½•ä¸èƒ½ä¸ºNULL';
            END IF;

            -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'check_cross_border') THEN
                RAISE WARNING 'å‡½æ•° check_cross_border ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‹¦æˆªæ£€æŸ¥';
                RETURN NEW;
            END IF;

            BEGIN
                user_country := current_setting('user.country', TRUE);
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–ç”¨æˆ·å›½å®¶å¤±è´¥: %', SQLERRM;
                    RETURN NEW;
            END;

            IF user_country IS NULL OR user_country = '' THEN
                RAISE WARNING 'ç”¨æˆ·å›½å®¶æœªè®¾ç½®ï¼Œè·³è¿‡æ‹¦æˆªæ£€æŸ¥';
                RETURN NEW;
            END IF;

            IF NEW.data_sovereignty IS NULL OR array_length(NEW.data_sovereignty, 1) IS NULL THEN
                RAISE WARNING 'æ•°æ®ä¸»æƒæ ‡ç­¾ä¸ºç©ºï¼Œè·³è¿‡æ‹¦æˆªæ£€æŸ¥';
                RETURN NEW;
            END IF;

            -- æ£€æŸ¥æ•°æ®ä¸»æƒ
            BEGIN
                IF NOT check_cross_border(user_country, NEW.data_sovereignty[1]) THEN
                    RAISE EXCEPTION 'Cross-border data access denied: % -> %', user_country, NEW.data_sovereignty[1];
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE;
            END;

            RETURN NEW;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'æŸ¥è¯¢æ‹¦æˆªè§¦å‘å™¨å‡½æ•° intercept_cross_border_query åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæŸ¥è¯¢æ‹¦æˆªè§¦å‘å™¨å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. ç›‘æ§å‘Šè­¦

### 4.1 æ‹¦æˆªæ—¥å¿—

```sql
-- åˆ›å»ºæ‹¦æˆªæ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_logs') THEN
            CREATE TABLE cross_border_logs (
                id BIGSERIAL PRIMARY KEY,
                timestamp TIMESTAMPTZ DEFAULT NOW(),
                source_country TEXT,
                target_country TEXT,
                action TEXT,
                user_id TEXT,
                query_text TEXT
            );
            RAISE NOTICE 'æ‹¦æˆªæ—¥å¿—è¡¨ cross_border_logs åˆ›å»ºæˆåŠŸ';

            -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
            CREATE INDEX idx_cross_border_logs_timestamp ON cross_border_logs(timestamp DESC);
            CREATE INDEX idx_cross_border_logs_action ON cross_border_logs(action);
            CREATE INDEX idx_cross_border_logs_user ON cross_border_logs(user_id, timestamp DESC);
            RAISE NOTICE 'æ‹¦æˆªæ—¥å¿—è¡¨ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‹¦æˆªæ—¥å¿—è¡¨ cross_border_logs å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'æ‹¦æˆªæ—¥å¿—è¡¨ cross_border_logs å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‹¦æˆªæ—¥å¿—è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 å‘Šè­¦é…ç½®

```sql
-- å‘Šè­¦è§„åˆ™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION check_cross_border_alerts()
        RETURNS void AS $$
        DECLARE
            denial_count BIGINT;
        BEGIN
            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_logs') THEN
                RAISE WARNING 'è¡¨ cross_border_logs ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥å‘Šè­¦';
                RETURN;
            END IF;

            -- æ£€æŸ¥å¼‚å¸¸æ‹¦æˆª
            BEGIN
                SELECT COUNT(*) INTO denial_count
                FROM cross_border_logs
                WHERE timestamp > NOW() - INTERVAL '1 hour'
                  AND action = 'deny';

                IF denial_count > 100 THEN
                    -- å‘é€å‘Šè­¦
                    BEGIN
                        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'send_alert') THEN
                            PERFORM send_alert('High cross-border denial rate');
                        ELSE
                            RAISE WARNING 'å‡½æ•° send_alert ä¸å­˜åœ¨ï¼Œæ— æ³•å‘é€å‘Šè­¦';
                        END IF;
                    EXCEPTION
                        WHEN OTHERS THEN
                            RAISE WARNING 'å‘é€å‘Šè­¦å¤±è´¥: %', SQLERRM;
                    END;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'æ£€æŸ¥å¼‚å¸¸æ‹¦æˆªå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‘Šè­¦è§„åˆ™å‡½æ•° check_cross_border_alerts åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‘Šè­¦è§„åˆ™å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 è§„åˆ™ç®¡ç†

**è§„åˆ™è®¾è®¡åŸåˆ™**:

1. **é»˜è®¤æ‹’ç»**: é»˜è®¤æ‹’ç»æ‰€æœ‰è·¨å¢ƒä¼ è¾“ï¼Œåªå…è®¸æ˜ç¡®æˆæƒçš„
2. **è§„åˆ™ä¼˜å…ˆçº§**: è®¾ç½®è§„åˆ™ä¼˜å…ˆçº§ï¼Œå¤„ç†è§„åˆ™å†²çª
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥å’Œæ›´æ–°è§„åˆ™

**è§„åˆ™ç®¡ç†ç¤ºä¾‹**:

```sql
-- åˆ›å»ºè§„åˆ™ä¼˜å…ˆçº§è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
            RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ åˆ—';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'cross_border_rules' AND column_name = 'priority') THEN
            ALTER TABLE cross_border_rules ADD COLUMN priority INTEGER DEFAULT 100;
            RAISE NOTICE 'åˆ— priority æ·»åŠ æˆåŠŸ';
        ELSE
            RAISE NOTICE 'åˆ— priority å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_column THEN
            RAISE WARNING 'åˆ— priority å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¾ç½®è§„åˆ™ä¼˜å…ˆçº§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
            RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°';
            RETURN;
        END IF;

        UPDATE cross_border_rules
        SET priority = 10
        WHERE source_sovereignty @> ARRAY['EU'] AND target_sovereignty @> ARRAY['US'];

        GET DIAGNOSTICS updated_count = ROW_COUNT;
        RAISE NOTICE 'æˆåŠŸæ›´æ–° % æ¡è§„åˆ™çš„ä¼˜å…ˆçº§', updated_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°è§„åˆ™ä¼˜å…ˆçº§å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è§„åˆ™å†²çªå¤„ç†ï¼ˆé€‰æ‹©ä¼˜å…ˆçº§é«˜çš„è§„åˆ™ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION get_applicable_rule(
            p_source TEXT,
            p_target TEXT
        )
        RETURNS cross_border_rules AS $$
        BEGIN
            -- å‚æ•°éªŒè¯
            IF p_source IS NULL OR p_source = '' THEN
                RAISE EXCEPTION 'p_sourceä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            IF p_target IS NULL OR p_target = '' THEN
                RAISE EXCEPTION 'p_targetä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
                RAISE EXCEPTION 'è¡¨ cross_border_rules ä¸å­˜åœ¨';
            END IF;

            BEGIN
                RETURN (
                    SELECT * FROM cross_border_rules
                    WHERE source_sovereignty @> ARRAY[p_source]
                      AND target_sovereignty @> ARRAY[p_target]
                    ORDER BY COALESCE(priority, 100) DESC
                    LIMIT 1
                );
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RETURN NULL;
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'è·å–é€‚ç”¨è§„åˆ™å¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'è§„åˆ™è·å–å‡½æ•° get_applicable_rule åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§„åˆ™è·å–å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸè·¨å›½ä¼ä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆªå®æ–½

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®æº: 50+ ä¸ªå›½å®¶
- æ•°æ®ä¼ è¾“: æ—¥å‡ 100 ä¸‡æ¬¡
- æ‹¦æˆªè§„åˆ™: 100+ æ¡

**å®æ–½æ•ˆæœ**:

- æ‹¦æˆªæˆåŠŸç‡: **100%**ï¼ˆç¦æ­¢çš„è·¨å¢ƒä¼ è¾“ï¼‰
- è¿è§„é£é™©: é™ä½ **95%**
- è§„åˆ™ç®¡ç†æ—¶é—´: ä» 4 å°æ—¶é™ä½åˆ° 30 åˆ†é’Ÿï¼ˆ**ç¼©çŸ­ 88%**ï¼‰
- åˆè§„é€šè¿‡ç‡: ä» 60% æå‡åˆ° 98%ï¼ˆ**æå‡ 63%**ï¼‰

---

### 5.3 æ‹¦æˆªæ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- åˆ›å»ºæ‹¦æˆªè§„åˆ™ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_rules') THEN
            RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_cross_border_rules_source_target') THEN
            CREATE INDEX idx_cross_border_rules_source_target
            ON cross_border_rules USING GIN (source_sovereignty, target_sovereignty);
            RAISE NOTICE 'GINç´¢å¼• idx_cross_border_rules_source_target åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_cross_border_rules_priority') THEN
            CREATE INDEX idx_cross_border_rules_priority
            ON cross_border_rules (COALESCE(priority, 100) DESC);
            RAISE NOTICE 'ç´¢å¼• idx_cross_border_rules_priority åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ cross_border_rules ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¼˜åŒ–æ‹¦æˆªå‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
CREATE OR REPLACE FUNCTION check_cross_border_cached(
    source_country TEXT,
    target_country TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    rule_action TEXT;
    cache_key TEXT;
BEGIN
    -- ç”Ÿæˆç¼“å­˜é”®
    cache_key := source_country || '->' || target_country;

    -- æ£€æŸ¥ç¼“å­˜ï¼ˆä½¿ç”¨ä¼šè¯å˜é‡ï¼‰
    IF current_setting('cross_border_cache.' || cache_key, TRUE) IS NOT NULL THEN
        RETURN current_setting('cross_border_cache.' || cache_key, TRUE)::BOOLEAN;
    END IF;

    -- æŸ¥è¯¢è§„åˆ™
    SELECT action INTO rule_action
    FROM cross_border_rules
    WHERE source_sovereignty @> ARRAY[source_country]
      AND target_sovereignty @> ARRAY[target_country]
    ORDER BY priority DESC
    LIMIT 1;

    -- ç¼“å­˜ç»“æœ
    PERFORM set_config('cross_border_cache.' || cache_key,
        CASE WHEN rule_action = 'deny' THEN 'false' ELSE 'true' END,
        FALSE);

    RETURN COALESCE(rule_action != 'deny', TRUE);
END;
$$ LANGUAGE plpgsql;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT check_cross_border_cached('EU', 'US');
-- æ‰§è¡Œæ—¶é—´: <1msï¼ˆä½¿ç”¨ç´¢å¼•å’Œç¼“å­˜ï¼‰
```

**æ‰¹é‡æ‹¦æˆªä¼˜åŒ–**ï¼š

```sql
-- æ‰¹é‡æ‹¦æˆªæ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION batch_check_cross_border(
    p_transfers JSONB
)
RETURNS TABLE (
    source_country TEXT,
    target_country TEXT,
    allowed BOOLEAN,
    reason TEXT
) AS $$
DECLARE
    transfer_record JSONB;
BEGIN
    FOR transfer_record IN SELECT * FROM jsonb_array_elements(p_transfers)
    LOOP
        RETURN QUERY SELECT
            transfer_record->>'source' AS source_country,
            transfer_record->>'target' AS target_country,
            check_cross_border_cached(
                transfer_record->>'source',
                transfer_record->>'target'
            ) AS allowed,
            CASE
                WHEN check_cross_border_cached(
                    transfer_record->>'source',
                    transfer_record->>'target'
                ) THEN 'å…è®¸'
                ELSE 'ç¦æ­¢'
            END AS reason;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- æ‰¹é‡æ£€æŸ¥ç¤ºä¾‹
SELECT * FROM batch_check_cross_border('[
    {"source": "EU", "target": "US"},
    {"source": "CN", "target": "US"},
    {"source": "EU", "target": "EU"}
]'::JSONB);
```

### 5.4 æ‹¦æˆªè§„åˆ™ç®¡ç†

**è§„åˆ™ç®¡ç†ç•Œé¢**ï¼š

```sql
-- åˆ›å»ºè§„åˆ™ç®¡ç†è§†å›¾
CREATE OR REPLACE VIEW cross_border_rules_management AS
SELECT
    id,
    source_sovereignty,
    target_sovereignty,
    action,
    priority,
    description,
    created_at,
    updated_at,
    CASE
        WHEN action = 'deny' THEN 'ç¦æ­¢'
        WHEN action = 'allow' THEN 'å…è®¸'
        WHEN action = 'require_approval' THEN 'éœ€å®¡æ‰¹'
        ELSE 'æœªçŸ¥'
    END AS action_display,
    (
        SELECT COUNT(*)
        FROM cross_border_logs
        WHERE source_country = ANY(source_sovereignty)
          AND target_country = ANY(target_sovereignty)
          AND timestamp > NOW() - INTERVAL '7 days'
    ) AS weekly_hits
FROM cross_border_rules
ORDER BY priority DESC, id;

-- æŸ¥è¯¢è§„åˆ™ç®¡ç†è§†å›¾
SELECT
    source_sovereignty,
    target_sovereignty,
    action_display,
    priority,
    weekly_hits,
    description
FROM cross_border_rules_management
ORDER BY priority DESC;
```

**è§„åˆ™å†²çªæ£€æµ‹**ï¼š

```sql
-- æ£€æµ‹è§„åˆ™å†²çª
CREATE OR REPLACE FUNCTION detect_rule_conflicts()
RETURNS TABLE (
    conflict_type TEXT,
    rule1_id INTEGER,
    rule2_id INTEGER,
    conflict_description TEXT
) AS $$
BEGIN
    -- æ£€æµ‹1: ç›¸åŒæºå’Œç›®æ ‡çš„ä¸åŒåŠ¨ä½œ
    RETURN QUERY
    SELECT
        'ç›¸åŒæºç›®æ ‡ä¸åŒåŠ¨ä½œ'::TEXT AS conflict_type,
        r1.id AS rule1_id,
        r2.id AS rule2_id,
        format('è§„åˆ™%då’Œè§„åˆ™%då¯¹%s->%sæœ‰ä¸åŒåŠ¨ä½œ: %s vs %s',
            r1.id, r2.id,
            array_to_string(r1.source_sovereignty, ','),
            array_to_string(r1.target_sovereignty, ','),
            r1.action, r2.action
        ) AS conflict_description
    FROM cross_border_rules r1
    JOIN cross_border_rules r2 ON r1.id < r2.id
    WHERE r1.source_sovereignty = r2.source_sovereignty
      AND r1.target_sovereignty = r2.target_sovereignty
      AND r1.action != r2.action;

    -- æ£€æµ‹2: ä¼˜å…ˆçº§ç›¸åŒä½†åŠ¨ä½œä¸åŒ
    RETURN QUERY
    SELECT
        'ä¼˜å…ˆçº§ç›¸åŒåŠ¨ä½œä¸åŒ'::TEXT AS conflict_type,
        r1.id AS rule1_id,
        r2.id AS rule2_id,
        format('è§„åˆ™%då’Œè§„åˆ™%dä¼˜å…ˆçº§ç›¸åŒä½†åŠ¨ä½œä¸åŒ: %s vs %s',
            r1.id, r2.id, r1.action, r2.action
        ) AS conflict_description
    FROM cross_border_rules r1
    JOIN cross_border_rules r2 ON r1.id < r2.id
    WHERE r1.priority = r2.priority
      AND r1.action != r2.action
      AND r1.source_sovereignty && r2.source_sovereignty
      AND r1.target_sovereignty && r2.target_sovereignty;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢è§„åˆ™å†²çª
SELECT * FROM detect_rule_conflicts();
```

### 5.5 æ‹¦æˆªç›‘æ§å’ŒæŠ¥å‘Š

**æ‹¦æˆªç»Ÿè®¡æŠ¥å‘Š**ï¼š

```sql
-- åˆ›å»ºæ‹¦æˆªç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW cross_border_statistics AS
SELECT
    DATE_TRUNC('day', timestamp) AS date,
    source_country,
    target_country,
    action,
    COUNT(*) AS request_count,
    COUNT(*) FILTER (WHERE action = 'deny') AS denied_count,
    COUNT(*) FILTER (WHERE action = 'allow') AS allowed_count,
    COUNT(*) FILTER (WHERE action = 'require_approval') AS pending_count,
    ROUND(
        100.0 * COUNT(*) FILTER (WHERE action = 'deny') / COUNT(*),
        2
    ) AS denial_rate
FROM cross_border_logs
WHERE timestamp > NOW() - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', timestamp), source_country, target_country, action
ORDER BY date DESC, request_count DESC;

-- æŸ¥è¯¢æ‹¦æˆªç»Ÿè®¡
SELECT
    date,
    source_country || ' -> ' || target_country AS route,
    request_count,
    denied_count,
    allowed_count,
    denial_rate || '%' AS denial_rate
FROM cross_border_statistics
ORDER BY date DESC, denied_count DESC
LIMIT 20;
```

**æ‹¦æˆªè¶‹åŠ¿åˆ†æ**ï¼š

```sql
-- åˆ›å»ºæ‹¦æˆªè¶‹åŠ¿åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_cross_border_trends(
    p_days INTEGER DEFAULT 30
)
RETURNS TABLE (
    metric_name TEXT,
    current_value NUMERIC,
    previous_value NUMERIC,
    change_percent NUMERIC,
    trend TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH current_period AS (
        SELECT
            COUNT(*) AS total_requests,
            COUNT(*) FILTER (WHERE action = 'deny') AS denied_requests,
            COUNT(*) FILTER (WHERE action = 'allow') AS allowed_requests
        FROM cross_border_logs
        WHERE timestamp > NOW() - (p_days || ' days')::INTERVAL
    ),
    previous_period AS (
        SELECT
            COUNT(*) AS total_requests,
            COUNT(*) FILTER (WHERE action = 'deny') AS denied_requests,
            COUNT(*) FILTER (WHERE action = 'allow') AS allowed_requests
        FROM cross_border_logs
        WHERE timestamp BETWEEN
            NOW() - (p_days * 2 || ' days')::INTERVAL
            AND NOW() - (p_days || ' days')::INTERVAL
    )
    SELECT
        'æ€»è¯·æ±‚æ•°'::TEXT,
        cp.total_requests::NUMERIC,
        pp.total_requests::NUMERIC,
        CASE
            WHEN pp.total_requests > 0 THEN
                ROUND((cp.total_requests - pp.total_requests)::NUMERIC / pp.total_requests * 100, 2)
            ELSE 0
        END,
        CASE
            WHEN cp.total_requests > pp.total_requests THEN 'ä¸Šå‡'
            WHEN cp.total_requests < pp.total_requests THEN 'ä¸‹é™'
            ELSE 'æŒå¹³'
        END
    FROM current_period cp, previous_period pp

    UNION ALL

    SELECT
        'æ‹’ç»è¯·æ±‚æ•°'::TEXT,
        cp.denied_requests::NUMERIC,
        pp.denied_requests::NUMERIC,
        CASE
            WHEN pp.denied_requests > 0 THEN
                ROUND((cp.denied_requests - pp.denied_requests)::NUMERIC / pp.denied_requests * 100, 2)
            ELSE 0
        END,
        CASE
            WHEN cp.denied_requests > pp.denied_requests THEN 'ä¸Šå‡'
            WHEN cp.denied_requests < pp.denied_requests THEN 'ä¸‹é™'
            ELSE 'æŒå¹³'
        END
    FROM current_period cp, previous_period pp;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢æ‹¦æˆªè¶‹åŠ¿
SELECT * FROM analyze_cross_border_trends(30);
```

### 5.6 å®é™…åº”ç”¨æ¡ˆä¾‹æ‰©å±•

#### æ¡ˆä¾‹2: é‡‘èè¡Œä¸šè·¨å¢ƒæ•°æ®æ‹¦æˆª

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®æº: 30+ ä¸ªå›½å®¶/åœ°åŒº
- æ•°æ®ç±»å‹: å®¢æˆ·ä¿¡æ¯ã€äº¤æ˜“è®°å½•ã€åˆè§„æ•°æ®
- åˆè§„è¦æ±‚: GDPRã€CCPAã€æœ¬åœ°æ³•è§„

**å®æ–½æ•ˆæœ**:

- æ‹¦æˆªæˆåŠŸç‡: **100%**
- åˆè§„é€šè¿‡ç‡: ä» 70% æå‡åˆ° 99%ï¼ˆ**æå‡ 41%**ï¼‰
- è¿è§„äº‹ä»¶: ä»æ¯æœˆ 50+ é™ä½åˆ° 0ï¼ˆ**é™ä½ 100%**ï¼‰

**å®æ–½é…ç½®**ï¼š

```sql
-- é‡‘èè¡Œä¸šè·¨å¢ƒè§„åˆ™é…ç½®
INSERT INTO cross_border_rules
(source_sovereignty, target_sovereignty, action, priority, description)
VALUES
    (ARRAY['EU'], ARRAY['US'], 'require_approval', 10, 'GDPRè¦æ±‚'),
    (ARRAY['EU'], ARRAY['CN'], 'deny', 20, 'GDPRç¦æ­¢'),
    (ARRAY['CN'], ARRAY['US'], 'deny', 20, 'æ•°æ®å®‰å…¨æ³•ç¦æ­¢'),
    (ARRAY['CN'], ARRAY['EU'], 'require_approval', 15, 'éœ€å®¡æ‰¹');

-- é…ç½®è‡ªåŠ¨å®¡æ‰¹è§„åˆ™
CREATE TABLE IF NOT EXISTS auto_approval_rules (
    id SERIAL PRIMARY KEY,
    source_sovereignty TEXT[],
    target_sovereignty TEXT[],
    data_type TEXT[],
    auto_approve BOOLEAN DEFAULT FALSE
);

INSERT INTO auto_approval_rules
(source_sovereignty, target_sovereignty, data_type, auto_approve)
VALUES
    (ARRAY['EU'], ARRAY['EU'], ARRAY['public'], TRUE),
    (ARRAY['EU'], ARRAY['US'], ARRAY['anonymized'], TRUE);
```

#### æ¡ˆä¾‹3: äº‘æœåŠ¡æä¾›å•†è·¨å¢ƒæ•°æ®æ‹¦æˆª

**ä¸šåŠ¡åœºæ™¯**:

- æœåŠ¡åŒºåŸŸ: å…¨çƒ 100+ ä¸ªæ•°æ®ä¸­å¿ƒ
- æ•°æ®ä¼ è¾“: æ—¥å‡ 1000 ä¸‡æ¬¡
- å®¢æˆ·è¦æ±‚: æ•°æ®æœ¬åœ°åŒ–ã€æ•°æ®ä¸»æƒä¿æŠ¤

**å®æ–½æ•ˆæœ**:

- æ‹¦æˆªå‡†ç¡®ç‡: **99.9%**
- è¯¯æ‹¦æˆªç‡: **<0.1%**
- å®¢æˆ·æ»¡æ„åº¦: ä» 85% æå‡åˆ° 98%ï¼ˆ**æå‡ 15%**ï¼‰

---

## 6. å‚è€ƒèµ„æ–™

å‚è€ƒèµ„æ–™æä¾›äº†è·¨å¢ƒæ•°æ®æ‹¦æˆªçš„å­¦ä¹ èµ„æºå’Œç›¸å…³æ–‡æ¡£ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£è·¨å¢ƒæ•°æ®ç®¡ç†çš„åŸç†å’Œå®è·µã€‚

**ç›¸å…³æ–‡æ¡£**ï¼š

1. **[è¡Œçº§ä¸»æƒæ ‡ç­¾](./è¡Œçº§ä¸»æƒæ ‡ç­¾.md)**
   - **å†…å®¹**ï¼šè¡Œçº§æ•°æ®ä¸»æƒæ ‡ç­¾çš„å®ç°å’Œç®¡ç†
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®ä¸»æƒç®¡ç†ã€æ•°æ®åˆ†ç±»
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

2. **[æ•°æ®ç•™å­˜ç­–ç•¥](./æ•°æ®ç•™å­˜ç­–ç•¥.md)**
   - **å†…å®¹**ï¼šæ•°æ®ç•™å­˜ç­–ç•¥å’Œè‡ªåŠ¨æ¸…ç†
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®ç•™å­˜ç®¡ç†ã€åˆè§„æ¸…ç†
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

**å®˜æ–¹æ–‡æ¡£**ï¼š

1. **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - è¡Œçº§å®‰å…¨](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)**
   - **å†…å®¹**ï¼šPostgreSQLè¡Œçº§å®‰å…¨ç­–ç•¥æ–‡æ¡£
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®è®¿é—®æ§åˆ¶ã€å®‰å…¨ç­–ç•¥
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

2. **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - è§¦å‘å™¨](https://www.postgresql.org/docs/current/triggers.html)**
   - **å†…å®¹**ï¼šPostgreSQLè§¦å‘å™¨ä½¿ç”¨æ–‡æ¡£
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®æ‹¦æˆªã€å®æ—¶ç›‘æ§
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

**åˆè§„æ ‡å‡†**ï¼š

1. **[GDPR - æ•°æ®è·¨å¢ƒä¼ è¾“](https://gdpr.eu/data-transfer/)**
   - **å†…å®¹**ï¼šGDPRæ•°æ®è·¨å¢ƒä¼ è¾“è¦æ±‚
   - **é€‚ç”¨åœºæ™¯**ï¼šGDPRåˆè§„ã€è·¨å¢ƒæ•°æ®ç®¡ç†
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

2. **[æ•°æ®å®‰å…¨æ³• - æ•°æ®å‡ºå¢ƒ](https://www.cac.gov.cn/)**
   - **å†…å®¹**ï¼šæ•°æ®å®‰å…¨æ³•æ•°æ®å‡ºå¢ƒè¦æ±‚
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®å®‰å…¨æ³•åˆè§„ã€æ•°æ®å‡ºå¢ƒç®¡ç†
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

**æœ€ä½³å®è·µ**ï¼š

1. **[è·¨å¢ƒæ•°æ®ä¼ è¾“æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/security.html)**
   - **å†…å®¹**ï¼šPostgreSQLå®‰å…¨æœ€ä½³å®è·µ
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®å®‰å…¨ã€è®¿é—®æ§åˆ¶
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

2. **[æ•°æ®ä¸»æƒä¿æŠ¤ç­–ç•¥](https://www.postgresql.org/docs/current/row-security.html)**
   - **å†…å®¹**ï¼šæ•°æ®ä¸»æƒä¿æŠ¤ç­–ç•¥å®æ–½
   - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®ä¸»æƒã€åˆè§„ç®¡ç†
   - **æ¨èåº¦**ï¼šâ­â­â­â­â­

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
