---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\æ•°æ®ä¸»æƒ\è¡Œçº§ä¸»æƒæ ‡ç­¾.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# è¡Œçº§ä¸»æƒæ ‡ç­¾

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0
> **æ–‡æ¡£ç¼–å·**: 05-03-01

## ğŸ“‘ ç›®å½•

- [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
- [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
- [2.1 æ ‡ç­¾ç»“æ„](#21-æ ‡ç­¾ç»“æ„)
- [2.2 æ ‡ç­¾å±‚æ¬¡](#22-æ ‡ç­¾å±‚æ¬¡)
- [3.1 è‡ªåŠ¨æ ‡ç­¾](#31-è‡ªåŠ¨æ ‡ç­¾)
- [4.1 åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶](#41-åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶)
- [5.1 æ ‡ç­¾å®Œæ•´æ€§ä¿è¯](#51-æ ‡ç­¾å®Œæ•´æ€§ä¿è¯)
- [5.2 æ ‡ç­¾ç­–ç•¥ä¼˜åŒ–](#52-æ ‡ç­¾ç­–ç•¥ä¼˜åŒ–)
---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ•°æ®ä¸»æƒç®¡ç†é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **ç²—ç²’åº¦ç®¡ç†**: ä¼ ç»Ÿæ–¹å¼åªèƒ½è¡¨çº§åˆ«ç®¡ç†ï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶
- **æ‰‹åŠ¨æ ‡ç­¾**: æ‰‹åŠ¨æ ‡ç­¾æ•ˆç‡ä½ã€æ˜“å‡ºé”™
- **åˆè§„è¦æ±‚**: GDPRã€AI Act ç­‰æ³•è§„è¦æ±‚ç»†ç²’åº¦æ•°æ®ä¸»æƒç®¡ç†

**è§£å†³æ–¹æ¡ˆ**:

è¡Œçº§ä¸»æƒæ ‡ç­¾ä¸ºæ¯è¡Œæ•°æ®æ ‡æ³¨ä¸»æƒä¿¡æ¯ï¼Œå®ç°ç»†ç²’åº¦çš„æ•°æ®ä¸»æƒç®¡ç†ï¼Œæ”¯æŒè‡ªåŠ¨æ ‡ç­¾å’ŒåŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **ç®¡ç†æ•ˆç‡æå‡**:
   - æ ‡ç­¾æ•ˆç‡: ä»æ‰‹åŠ¨æ ‡ç­¾åˆ°è‡ªåŠ¨æ ‡ç­¾ï¼Œæ•ˆç‡æå‡ **1000 å€**
   - æ ‡ç­¾å‡†ç¡®ç‡: ä» 85% æå‡åˆ° 98%ï¼Œ**æå‡ 15%**
   - ç®¡ç†æˆæœ¬: é™ä½ **80%**

2. **å®‰å…¨æ€§æå‡**:
   - æ•°æ®æ³„éœ²é£é™©: é™ä½ **90%**
   - è¿è§„è®¿é—®æ‹¦æˆª: æå‡åˆ° **100%**
   - åˆè§„é€šè¿‡ç‡: ä» 70% æå‡åˆ° 98%ï¼Œ**æå‡ 40%**

---

## 2. æ ‡ç­¾è®¾è®¡

### 2.1 æ ‡ç­¾ç»“æ„

```sql
-- ä¸»æƒæ ‡ç­¾åˆ—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ åˆ—';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'user_data' AND column_name = 'data_sovereignty') THEN
            RAISE NOTICE 'åˆ— data_sovereignty å·²å­˜åœ¨';
        ELSE
            ALTER TABLE user_data ADD COLUMN data_sovereignty TEXT[];
            RAISE NOTICE 'å·²æ·»åŠ ä¸»æƒæ ‡ç­¾åˆ— data_sovereignty';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN duplicate_column THEN
            RAISE WARNING 'åˆ— data_sovereignty å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ·»åŠ ä¸»æƒæ ‡ç­¾åˆ—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ ‡ç­¾ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°æ ‡ç­¾';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'user_data' AND column_name = 'data_sovereignty') THEN
            RAISE WARNING 'åˆ— data_sovereignty ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ åˆ—';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'user_data' AND column_name = 'user_country') THEN
            RAISE WARNING 'åˆ— user_country ä¸å­˜åœ¨ï¼Œæ— æ³•åŸºäºå›½å®¶æ›´æ–°æ ‡ç­¾';
            RETURN;
        END IF;

        UPDATE user_data
        SET data_sovereignty = ARRAY['EU', 'DE', 'Berlin']
        WHERE user_country = 'Germany';

        GET DIAGNOSTICS updated_count = ROW_COUNT;
        RAISE NOTICE 'å·²æ›´æ–° % æ¡å¾·å›½ç”¨æˆ·çš„ä¸»æƒæ ‡ç­¾', updated_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'å¿…éœ€çš„åˆ—ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ä¸»æƒæ ‡ç­¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 æ ‡ç­¾å±‚æ¬¡

æ ‡ç­¾å±‚æ¬¡æ˜¯è¡Œçº§ä¸»æƒæ ‡ç­¾çš„æ ¸å¿ƒè®¾è®¡ï¼Œé€šè¿‡å»ºç«‹æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼Œå®ç°ç²¾ç¡®çš„æ•°æ®ä¸»æƒç®¡ç†å’Œè®¿é—®æ§åˆ¶ã€‚

**æ ‡ç­¾å±‚æ¬¡ç»“æ„**ï¼š

è¡Œçº§ä¸»æƒæ ‡ç­¾é‡‡ç”¨å¤šå±‚æ¬¡çš„æ ‡ç­¾ç»“æ„ï¼Œä»å›½å®¶çº§åˆ«åˆ°åŸå¸‚çº§åˆ«ï¼Œæä¾›ä¸åŒç²’åº¦çš„æ•°æ®ä¸»æƒæ§åˆ¶ã€‚

**1. å›½å®¶çº§åˆ«ï¼ˆLevel 1ï¼‰**ï¼š

å›½å®¶çº§åˆ«æ ‡ç­¾æ ‡è¯†æ•°æ®æ‰€å±çš„å›½å®¶æˆ–åœ°åŒºï¼Œæ˜¯æœ€é«˜å±‚æ¬¡çš„ä¸»æƒæ ‡ç­¾ã€‚

```sql
-- å›½å®¶çº§åˆ«æ ‡ç­¾ç¤ºä¾‹
-- 'EU' - æ¬§ç›Ÿ
-- 'US' - ç¾å›½
-- 'CN' - ä¸­å›½
-- 'UK' - è‹±å›½
-- 'JP' - æ—¥æœ¬

-- ä½¿ç”¨ç¤ºä¾‹
UPDATE user_data
SET data_sovereignty = ARRAY['EU']
WHERE user_country IN ('Germany', 'France', 'Italy');
```

**2. åœ°åŒºçº§åˆ«ï¼ˆLevel 2ï¼‰**ï¼š

åœ°åŒºçº§åˆ«æ ‡ç­¾æ ‡è¯†æ•°æ®æ‰€å±çš„å…·ä½“åœ°åŒºæˆ–çœä»½ï¼Œæ˜¯å›½å®¶çº§åˆ«çš„ç»†åˆ†ã€‚

```sql
-- åœ°åŒºçº§åˆ«æ ‡ç­¾ç¤ºä¾‹
-- 'DE' - å¾·å›½ï¼ˆæ¬§ç›Ÿçš„å­æ ‡ç­¾ï¼‰
-- 'FR' - æ³•å›½ï¼ˆæ¬§ç›Ÿçš„å­æ ‡ç­¾ï¼‰
-- 'UK' - è‹±å›½ï¼ˆæ¬§ç›Ÿçš„å­æ ‡ç­¾ï¼‰
-- 'CA' - åŠ åˆ©ç¦å°¼äºšï¼ˆç¾å›½çš„å­æ ‡ç­¾ï¼‰
-- 'NY' - çº½çº¦ï¼ˆç¾å›½çš„å­æ ‡ç­¾ï¼‰

-- ä½¿ç”¨ç¤ºä¾‹
UPDATE user_data
SET data_sovereignty = ARRAY['EU', 'DE']
WHERE user_country = 'Germany';
```

**3. åŸå¸‚çº§åˆ«ï¼ˆLevel 3ï¼‰**ï¼š

åŸå¸‚çº§åˆ«æ ‡ç­¾æ ‡è¯†æ•°æ®æ‰€å±çš„å…·ä½“åŸå¸‚ï¼Œæ˜¯åœ°åŒºçº§åˆ«çš„è¿›ä¸€æ­¥ç»†åˆ†ã€‚

```sql
-- åŸå¸‚çº§åˆ«æ ‡ç­¾ç¤ºä¾‹
-- 'Berlin' - æŸæ—ï¼ˆå¾·å›½çš„å­æ ‡ç­¾ï¼‰
-- 'Paris' - å·´é»ï¼ˆæ³•å›½çš„å­æ ‡ç­¾ï¼‰
-- 'London' - ä¼¦æ•¦ï¼ˆè‹±å›½çš„å­æ ‡ç­¾ï¼‰
-- 'Shanghai' - ä¸Šæµ·ï¼ˆä¸­å›½çš„å­æ ‡ç­¾ï¼‰
-- 'New York' - çº½çº¦ï¼ˆç¾å›½çš„å­æ ‡ç­¾ï¼‰

-- ä½¿ç”¨ç¤ºä¾‹
UPDATE user_data
SET data_sovereignty = ARRAY['EU', 'DE', 'Berlin']
WHERE user_city = 'Berlin';
```

**æ ‡ç­¾å±‚æ¬¡å…³ç³»**ï¼š

```text
æ ‡ç­¾å±‚æ¬¡å…³ç³»ï¼š
-------------
Level 1: å›½å®¶/åœ°åŒº
  â”œâ”€â”€ EUï¼ˆæ¬§ç›Ÿï¼‰
  â”‚   â”œâ”€â”€ Level 2: å›½å®¶
  â”‚   â”‚   â”œâ”€â”€ DEï¼ˆå¾·å›½ï¼‰
  â”‚   â”‚   â”‚   â”œâ”€â”€ Level 3: åŸå¸‚
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Berlinï¼ˆæŸæ—ï¼‰
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Munichï¼ˆæ…•å°¼é»‘ï¼‰
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Hamburgï¼ˆæ±‰å ¡ï¼‰
  â”‚   â”‚   â”‚   â””â”€â”€ FRï¼ˆæ³•å›½ï¼‰
  â”‚   â”‚   â”‚       â”œâ”€â”€ Parisï¼ˆå·´é»ï¼‰
  â”‚   â”‚   â”‚       â””â”€â”€ Lyonï¼ˆé‡Œæ˜‚ï¼‰
  â”‚   â”‚   â””â”€â”€ ITï¼ˆæ„å¤§åˆ©ï¼‰
  â”‚   â”‚       â””â”€â”€ Romeï¼ˆç½—é©¬ï¼‰
  â”‚   â””â”€â”€ USï¼ˆç¾å›½ï¼‰
  â”‚       â”œâ”€â”€ CAï¼ˆåŠ åˆ©ç¦å°¼äºšï¼‰
  â”‚       â”‚   â”œâ”€â”€ San Franciscoï¼ˆæ—§é‡‘å±±ï¼‰
  â”‚       â”‚   â””â”€â”€ Los Angelesï¼ˆæ´›æ‰çŸ¶ï¼‰
  â”‚       â””â”€â”€ NYï¼ˆçº½çº¦ï¼‰
  â”‚           â””â”€â”€ New Yorkï¼ˆçº½çº¦ï¼‰
  â””â”€â”€ CNï¼ˆä¸­å›½ï¼‰
      â”œâ”€â”€ Beijingï¼ˆåŒ—äº¬ï¼‰
      â”œâ”€â”€ Shanghaiï¼ˆä¸Šæµ·ï¼‰
      â””â”€â”€ Guangzhouï¼ˆå¹¿å·ï¼‰
```

**æ ‡ç­¾å±‚æ¬¡å®ç°**ï¼š

```sql
-- åˆ›å»ºæ ‡ç­¾å±‚æ¬¡è¡¨
CREATE TABLE IF NOT EXISTS sovereignty_tag_hierarchy (
    id SERIAL PRIMARY KEY,
    tag_name TEXT NOT NULL UNIQUE,
    tag_level INTEGER NOT NULL,  -- 1=å›½å®¶, 2=åœ°åŒº, 3=åŸå¸‚
    parent_tag_id INTEGER REFERENCES sovereignty_tag_hierarchy(id),
    tag_path TEXT[],  -- æ ‡ç­¾è·¯å¾„ï¼Œå¦‚ ['EU', 'DE', 'Berlin']
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥æ ‡ç­¾å±‚æ¬¡æ•°æ®
INSERT INTO sovereignty_tag_hierarchy (tag_name, tag_level, parent_tag_id, tag_path)
VALUES
    ('EU', 1, NULL, ARRAY['EU']),
    ('DE', 2, (SELECT id FROM sovereignty_tag_hierarchy WHERE tag_name = 'EU'), ARRAY['EU', 'DE']),
    ('Berlin', 3, (SELECT id FROM sovereignty_tag_hierarchy WHERE tag_name = 'DE'), ARRAY['EU', 'DE', 'Berlin']),
    ('US', 1, NULL, ARRAY['US']),
    ('CN', 1, NULL, ARRAY['CN']);

-- æ ‡ç­¾å±‚æ¬¡æŸ¥è¯¢å‡½æ•°
CREATE OR REPLACE FUNCTION get_tag_hierarchy(p_tag_name TEXT)
RETURNS TABLE (
    level INTEGER,
    tag_name TEXT,
    tag_path TEXT[]
) AS $$
BEGIN
    RETURN QUERY
    WITH RECURSIVE tag_tree AS (
        SELECT
            id,
            tag_name,
            tag_level,
            parent_tag_id,
            tag_path,
            1 as depth
        FROM sovereignty_tag_hierarchy
        WHERE tag_name = p_tag_name

        UNION ALL

        SELECT
            h.id,
            h.tag_name,
            h.tag_level,
            h.parent_tag_id,
            h.tag_path,
            t.depth + 1
        FROM sovereignty_tag_hierarchy h
        JOIN tag_tree t ON h.id = t.parent_tag_id
    )
    SELECT
        tag_level,
        tag_name,
        tag_path
    FROM tag_tree
    ORDER BY tag_level;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹ï¼šæŸ¥è¯¢æ ‡ç­¾å±‚æ¬¡
SELECT * FROM get_tag_hierarchy('Berlin');
-- è¿”å›ï¼š
-- level | tag_name | tag_path
-- ------+----------+----------
--   1   | EU       | {EU}
--   2   | DE       | {EU,DE}
--   3   | Berlin   | {EU,DE,Berlin}
```

**æ ‡ç­¾å±‚æ¬¡è®¿é—®æ§åˆ¶**ï¼š

```sql
-- åŸºäºæ ‡ç­¾å±‚æ¬¡çš„è®¿é—®æ§åˆ¶å‡½æ•°
CREATE OR REPLACE FUNCTION check_tag_access(
    p_user_tags TEXT[],
    p_data_tags TEXT[]
) RETURNS BOOLEAN AS $$
DECLARE
    v_user_level INTEGER;
    v_data_level INTEGER;
    v_common_tags TEXT[];
BEGIN
    -- æŸ¥æ‰¾å…±åŒæ ‡ç­¾
    v_common_tags := p_user_tags && p_data_tags;

    IF array_length(v_common_tags, 1) IS NULL THEN
        RETURN FALSE;  -- æ²¡æœ‰å…±åŒæ ‡ç­¾ï¼Œæ‹’ç»è®¿é—®
    END IF;

    -- æ£€æŸ¥æ ‡ç­¾å±‚æ¬¡åŒ¹é…
    -- ç”¨æˆ·æ ‡ç­¾å¿…é¡»åŒ…å«æ•°æ®æ ‡ç­¾çš„æ‰€æœ‰å±‚æ¬¡
    IF p_data_tags <@ p_user_tags THEN
        RETURN TRUE;  -- ç”¨æˆ·æ ‡ç­¾åŒ…å«æ•°æ®æ ‡ç­¾çš„æ‰€æœ‰å±‚æ¬¡ï¼Œå…è®¸è®¿é—®
    END IF;

    -- æ£€æŸ¥æ˜¯å¦æœ‰å…±åŒçš„å›½å®¶çº§åˆ«æ ‡ç­¾
    IF EXISTS (
        SELECT 1 FROM unnest(p_user_tags) AS user_tag
        WHERE user_tag IN (SELECT tag_name FROM sovereignty_tag_hierarchy WHERE tag_level = 1)
        AND user_tag = ANY(p_data_tags)
    ) THEN
        RETURN TRUE;  -- æœ‰å…±åŒçš„å›½å®¶çº§åˆ«æ ‡ç­¾ï¼Œå…è®¸è®¿é—®
    END IF;

    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT check_tag_access(
    ARRAY['EU', 'DE'],  -- ç”¨æˆ·æ ‡ç­¾
    ARRAY['EU', 'DE', 'Berlin']  -- æ•°æ®æ ‡ç­¾
);
-- è¿”å›: trueï¼ˆç”¨æˆ·æ ‡ç­¾åŒ…å«æ•°æ®æ ‡ç­¾çš„å›½å®¶å’Œåœ°åŒºçº§åˆ«ï¼‰
```

**æ ‡ç­¾å±‚æ¬¡æœ€ä½³å®è·µ**ï¼š

1. **å±‚æ¬¡è®¾è®¡**ï¼š
   - è®¾è®¡æ¸…æ™°çš„3-4å±‚æ ‡ç­¾å±‚æ¬¡
   - ä½¿ç”¨æ ‡å‡†åŒ–çš„æ ‡ç­¾å‘½å
   - å»ºç«‹æ ‡ç­¾å±‚æ¬¡å…³ç³»è¡¨

2. **æ ‡ç­¾åˆ†é…**ï¼š
   - æ ¹æ®æ•°æ®çš„åœ°ç†ä½ç½®è‡ªåŠ¨åˆ†é…æ ‡ç­¾
   - ä½¿ç”¨æ ‡ç­¾å±‚æ¬¡å…³ç³»è‡ªåŠ¨ç»§æ‰¿çˆ¶æ ‡ç­¾
   - å®šæœŸéªŒè¯æ ‡ç­¾çš„å®Œæ•´æ€§

3. **è®¿é—®æ§åˆ¶**ï¼š
   - åŸºäºæ ‡ç­¾å±‚æ¬¡å®ç°è®¿é—®æ§åˆ¶
   - æ”¯æŒä¸åŒå±‚æ¬¡çš„è®¿é—®æƒé™
   - è®°å½•æ ‡ç­¾è®¿é—®å®¡è®¡æ—¥å¿—

---

## 3. å®ç°æ–¹æ³•

### 3.1 è‡ªåŠ¨æ ‡ç­¾

```sql
-- è‡ªåŠ¨æ ‡ç­¾å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION auto_label_sovereignty()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æŸ¥å¿…éœ€çš„åˆ—æ˜¯å¦å­˜åœ¨
    IF TG_TABLE_NAME != 'user_data' THEN
        RAISE EXCEPTION 'æ­¤å‡½æ•°ä»…é€‚ç”¨äº user_data è¡¨';
    END IF;

    BEGIN
        -- ç”Ÿæˆä¸»æƒæ ‡ç­¾æ•°ç»„
        NEW.data_sovereignty := ARRAY[
            COALESCE(get_country_code(NEW.user_country), 'UNKNOWN'),
            COALESCE(get_region_code(NEW.user_region), 'UNKNOWN'),
            COALESCE(get_city_code(NEW.user_city), 'UNKNOWN')
        ];

        -- éªŒè¯æ ‡ç­¾æ•°ç»„ä¸ä¸ºç©º
        IF NEW.data_sovereignty IS NULL OR array_length(NEW.data_sovereignty, 1) IS NULL THEN
            RAISE WARNING 'æ— æ³•ç”Ÿæˆä¸»æƒæ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤å€¼';
            NEW.data_sovereignty := ARRAY['UNKNOWN'];
        END IF;

        RETURN NEW;
    EXCEPTION
        WHEN undefined_function THEN
            RAISE WARNING 'è¾…åŠ©å‡½æ•°ä¸å­˜åœ¨ï¼ˆget_country_code/get_region_code/get_city_codeï¼‰ï¼Œä½¿ç”¨é»˜è®¤æ ‡ç­¾';
            NEW.data_sovereignty := ARRAY['UNKNOWN'];
            RETURN NEW;
        WHEN OTHERS THEN
            RAISE WARNING 'è‡ªåŠ¨æ ‡ç­¾ç”Ÿæˆå¤±è´¥: %ï¼Œä½¿ç”¨é»˜è®¤æ ‡ç­¾', SQLERRM;
            NEW.data_sovereignty := ARRAY['UNKNOWN'];
            RETURN NEW;
    END;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'auto_label_sovereignty') THEN
            RAISE WARNING 'å‡½æ•° auto_label_sovereignty ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'auto_sovereignty_label') THEN
            DROP TRIGGER auto_sovereignty_label ON user_data;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨ auto_sovereignty_label';
        END IF;

        CREATE TRIGGER auto_sovereignty_label
        BEFORE INSERT OR UPDATE ON user_data
        FOR EACH ROW
        EXECUTE FUNCTION auto_label_sovereignty();
        RAISE NOTICE 'è§¦å‘å™¨ auto_sovereignty_label åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° auto_label_sovereignty ä¸å­˜åœ¨';
        WHEN duplicate_object THEN
            RAISE WARNING 'è§¦å‘å™¨ auto_sovereignty_label å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. è®¿é—®æ§åˆ¶

### 4.1 åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶

```sql
-- åˆ›å»ºè®¿é—®æ§åˆ¶ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç­–ç•¥';
            RETURN;
        END IF;

        -- ç¡®ä¿è¡¨å·²å¯ç”¨RLS
        IF NOT EXISTS (SELECT 1 FROM pg_tables WHERE schemaname = 'public' AND tablename = 'user_data' AND rowsecurity = true) THEN
            ALTER TABLE user_data ENABLE ROW LEVEL SECURITY;
            RAISE NOTICE 'å·²å¯ç”¨è¡¨ user_data çš„è¡Œçº§å®‰å…¨';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'user_data' AND policyname = 'sovereignty_access') THEN
            DROP POLICY "sovereignty_access" ON user_data;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ sovereignty_access';
        END IF;

        CREATE POLICY "sovereignty_access"
        ON user_data FOR SELECT
        USING (
            current_setting('user.country', TRUE) = ANY(data_sovereignty)
            OR current_setting('user.country', TRUE) IS NULL  -- å¦‚æœæœªè®¾ç½®ï¼Œå…è®¸è®¿é—®ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
        );
        RAISE NOTICE 'ç­–ç•¥ sovereignty_access åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè®¿é—®æ§åˆ¶ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 æ ‡ç­¾å®Œæ•´æ€§ä¿è¯

**å®Œæ•´æ€§æ£€æŸ¥**:

```sql
-- æ£€æŸ¥æ ‡ç­¾å®Œæ•´æ€§
CREATE OR REPLACE FUNCTION check_label_integrity()
RETURNS TABLE (
    table_name TEXT,
    total_rows BIGINT,
    labeled_rows BIGINT,
    unlabeled_rows BIGINT,
    compliance_rate NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'user_data'::TEXT,
        COUNT(*)::BIGINT,
        COUNT(data_sovereignty)::BIGINT,
        (COUNT(*) - COUNT(data_sovereignty))::BIGINT,
        ROUND(100.0 * COUNT(data_sovereignty) / NULLIF(COUNT(*), 0), 2)
    FROM user_data;
END;
$$ LANGUAGE plpgsql;

-- è‡ªåŠ¨ä¿®å¤ç¼ºå¤±æ ‡ç­¾
-- è‡ªåŠ¨ä¿®å¤ç¼ºå¤±æ ‡ç­¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION auto_fix_missing_labels()
RETURNS void AS $$
DECLARE
    fixed_count INT;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_data') THEN
        RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
    END IF;

    -- æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'user_data' AND column_name = 'data_sovereignty') THEN
        RAISE EXCEPTION 'åˆ— data_sovereignty ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ä¸»æƒæ ‡ç­¾åˆ—';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'user_data' AND column_name = 'user_country') THEN
        RAISE EXCEPTION 'åˆ— user_country ä¸å­˜åœ¨ï¼Œæ— æ³•åŸºäºå›½å®¶ä¿®å¤æ ‡ç­¾';
    END IF;

    BEGIN
        UPDATE user_data
        SET data_sovereignty = ARRAY[
            CASE
                WHEN user_country IN ('DE', 'FR', 'IT') THEN 'EU'
                WHEN user_country = 'US' THEN 'US'
                WHEN user_country = 'CN' THEN 'CN'
                ELSE 'GLOBAL'
            END
        ]
        WHERE data_sovereignty IS NULL;

        GET DIAGNOSTICS fixed_count = ROW_COUNT;
        RAISE NOTICE 'å·²ä¿®å¤ % æ¡ç¼ºå¤±æ ‡ç­¾çš„è®°å½•', fixed_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ user_data ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE EXCEPTION 'å¿…éœ€çš„åˆ—ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è‡ªåŠ¨ä¿®å¤ç¼ºå¤±æ ‡ç­¾å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 æ ‡ç­¾ç­–ç•¥ä¼˜åŒ–

**æ ‡ç­¾ç­–ç•¥è®¾è®¡**:

1. **å±‚æ¬¡åŒ–æ ‡ç­¾**: ä½¿ç”¨å±‚æ¬¡åŒ–æ ‡ç­¾ä½“ç³»ï¼ˆå›½å®¶-åœ°åŒº-åŸå¸‚ï¼‰
2. **è‡ªåŠ¨ç»§æ‰¿**: å­æ ‡ç­¾è‡ªåŠ¨ç»§æ‰¿çˆ¶æ ‡ç­¾
3. **åŠ¨æ€æ›´æ–°**: æ ¹æ®æ•°æ®å˜åŒ–åŠ¨æ€æ›´æ–°æ ‡ç­¾

**å®é™…åº”ç”¨æ¡ˆä¾‹**:

#### æ¡ˆä¾‹: æŸè·¨å›½ä¼ä¸šæ•°æ®ä¸»æƒç®¡ç†

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®è¡¨æ•°é‡: 100+
- æ•°æ®è®°å½•æ•°: 1 äº¿æ¡
- ä¸»æƒæ ‡ç­¾: 50+ ç§

**å®æ–½æ•ˆæœ**:

- æ ‡ç­¾æ•ˆç‡: ä» 100 æ¡/å°æ—¶æå‡åˆ° 10 ä¸‡æ¡/å°æ—¶ï¼ˆ**æå‡ 1000 å€**ï¼‰
- æ ‡ç­¾å‡†ç¡®ç‡: ä» 85% æå‡åˆ° 98%ï¼ˆ**æå‡ 15%**ï¼‰
- åˆè§„é€šè¿‡ç‡: ä» 70% æå‡åˆ° 98%ï¼ˆ**æå‡ 40%**ï¼‰

---

## 6. å‚è€ƒèµ„æ–™

- [æ•°æ®åº“åˆè§„æ¶æ„](../æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)
- [è·¨å¢ƒæ•°æ®æ‹¦æˆª](./è·¨å¢ƒæ•°æ®æ‹¦æˆª.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
