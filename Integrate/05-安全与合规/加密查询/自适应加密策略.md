---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\05-åˆè§„ä¸å¯ä¿¡\åŠ å¯†æŸ¥è¯¢\è‡ªé€‚åº”åŠ å¯†ç­–ç•¥.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# è‡ªé€‚åº”åŠ å¯†ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 16+ with pgcrypto, pg_encrypt
> **æ–‡æ¡£ç¼–å·**: 05-05-02

## ğŸ“‘ ç›®å½•

- [è‡ªé€‚åº”åŠ å¯†ç­–ç•¥](#è‡ªé€‚åº”åŠ å¯†ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŠ€æœ¯å®šä½](#12-æŠ€æœ¯å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æŠ€æœ¯åŸç†](#2-æŠ€æœ¯åŸç†)
    - [2.1 è‡ªé€‚åº”åŠ å¯†åŸºæœ¬æ¦‚å¿µ](#21-è‡ªé€‚åº”åŠ å¯†åŸºæœ¬æ¦‚å¿µ)
    - [2.2 åŠ å¯†ç­–ç•¥é€‰æ‹©ç®—æ³•](#22-åŠ å¯†ç­–ç•¥é€‰æ‹©ç®—æ³•)
      - [1. æ•°æ®æ•æ„Ÿæ€§ï¼ˆData Sensitivityï¼‰](#1-æ•°æ®æ•æ„Ÿæ€§data-sensitivity)
      - [2. è®¿é—®é¢‘ç‡ï¼ˆAccess Frequencyï¼‰](#2-è®¿é—®é¢‘ç‡access-frequency)
      - [3. å®‰å…¨å¨èƒï¼ˆSecurity Threatï¼‰](#3-å®‰å…¨å¨èƒsecurity-threat)
      - [4. æ€§èƒ½è¦æ±‚ï¼ˆPerformance Requirementsï¼‰](#4-æ€§èƒ½è¦æ±‚performance-requirements)
    - [2.3 åŠ¨æ€åŠ å¯†è°ƒæ•´](#23-åŠ¨æ€åŠ å¯†è°ƒæ•´)
      - [1. å®æ—¶ç›‘æ§ï¼ˆReal-time Monitoringï¼‰](#1-å®æ—¶ç›‘æ§real-time-monitoring)
      - [2. ç­–ç•¥è¯„ä¼°ï¼ˆPolicy Evaluationï¼‰](#2-ç­–ç•¥è¯„ä¼°policy-evaluation)
      - [3. è‡ªåŠ¨è°ƒæ•´ï¼ˆAutomatic Adjustmentï¼‰](#3-è‡ªåŠ¨è°ƒæ•´automatic-adjustment)
    - [2.4 æ€§èƒ½ä¸å®‰å…¨å¹³è¡¡](#24-æ€§èƒ½ä¸å®‰å…¨å¹³è¡¡)
      - [1. æ•æ„Ÿæ•°æ®ï¼ˆSensitive Dataï¼‰](#1-æ•æ„Ÿæ•°æ®sensitive-data)
      - [2. é«˜é¢‘æ•°æ®ï¼ˆHigh-frequency Dataï¼‰](#2-é«˜é¢‘æ•°æ®high-frequency-data)
      - [3. å¹³è¡¡æ•°æ®ï¼ˆBalanced Dataï¼‰](#3-å¹³è¡¡æ•°æ®balanced-data)
  - [3. æ¶æ„è®¾è®¡](#3-æ¶æ„è®¾è®¡)
    - [3.1 æ•´ä½“æ¶æ„](#31-æ•´ä½“æ¶æ„)
    - [3.2 ç­–ç•¥å¼•æ“](#32-ç­–ç•¥å¼•æ“)
      - [1. å®‰å…¨è¯„ä¼°ï¼ˆSecurity Assessmentï¼‰](#1-å®‰å…¨è¯„ä¼°security-assessment)
      - [2. æ€§èƒ½ç›‘æ§ï¼ˆPerformance Monitoringï¼‰](#2-æ€§èƒ½ç›‘æ§performance-monitoring)
      - [3. ç­–ç•¥é€‰æ‹©ï¼ˆStrategy Selectionï¼‰](#3-ç­–ç•¥é€‰æ‹©strategy-selection)
      - [4. ç­–ç•¥æ‰§è¡Œï¼ˆPolicy Executionï¼‰](#4-ç­–ç•¥æ‰§è¡Œpolicy-execution)
    - [3.3 åŠ å¯†æ‰§è¡Œå±‚](#33-åŠ å¯†æ‰§è¡Œå±‚)
      - [1. æ•°æ®åŠ å¯†ï¼ˆData Encryptionï¼‰](#1-æ•°æ®åŠ å¯†data-encryption)
      - [2. æŸ¥è¯¢å¤„ç†ï¼ˆQuery Processingï¼‰](#2-æŸ¥è¯¢å¤„ç†query-processing)
      - [3. ç»“æœè§£å¯†ï¼ˆResult Decryption - æ‰§è¡Œç»„ä»¶ï¼‰](#3-ç»“æœè§£å¯†result-decryption---æ‰§è¡Œç»„ä»¶)
  - [4. å®ç°ç»†èŠ‚](#4-å®ç°ç»†èŠ‚)
    - [4.1 ç­–ç•¥é…ç½®](#41-ç­–ç•¥é…ç½®)
    - [4.2 è‡ªé€‚åº”è°ƒæ•´å®ç°](#42-è‡ªé€‚åº”è°ƒæ•´å®ç°)
    - [4.3 æ€§èƒ½ç›‘æ§](#43-æ€§èƒ½ç›‘æ§)
  - [5. æ€§èƒ½åˆ†æ](#5-æ€§èƒ½åˆ†æ)
    - [5.1 æ€§èƒ½å½±å“åˆ†æ](#51-æ€§èƒ½å½±å“åˆ†æ)
    - [5.2 è‡ªé€‚åº”è°ƒæ•´æ•ˆæœ](#52-è‡ªé€‚åº”è°ƒæ•´æ•ˆæœ)
    - [5.3 ä¸åŒåœºæ™¯æ€§èƒ½å¯¹æ¯”](#53-ä¸åŒåœºæ™¯æ€§èƒ½å¯¹æ¯”)
    - [5.4 èµ„æºæ¶ˆè€—åˆ†æ](#54-èµ„æºæ¶ˆè€—åˆ†æ)
    - [5.5 å®‰å…¨æ€§ä¸æ€§èƒ½å¹³è¡¡](#55-å®‰å…¨æ€§ä¸æ€§èƒ½å¹³è¡¡)
    - [5.6 è‡ªé€‚åº”è°ƒæ•´å»¶è¿Ÿ](#56-è‡ªé€‚åº”è°ƒæ•´å»¶è¿Ÿ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ç­–ç•¥è®¾è®¡åŸåˆ™](#61-ç­–ç•¥è®¾è®¡åŸåˆ™)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 é‡‘èç³»ç»Ÿè‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹](#71-é‡‘èç³»ç»Ÿè‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹)
    - [7.2 äº‘å¹³å°è‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹](#72-äº‘å¹³å°è‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 å­¦æœ¯è®ºæ–‡](#82-å­¦æœ¯è®ºæ–‡)
    - [8.3 ç›¸å…³èµ„æº](#83-ç›¸å…³èµ„æº)
  - [9. å®Œæ•´ä»£ç ç¤ºä¾‹](#9-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [9.1 è‡ªé€‚åº”åŠ å¯†ç­–ç•¥ Python å®ç°](#91-è‡ªé€‚åº”åŠ å¯†ç­–ç•¥-python-å®ç°)
    - [9.2 PostgreSQL è‡ªé€‚åº”åŠ å¯†é…ç½®](#92-postgresql-è‡ªé€‚åº”åŠ å¯†é…ç½®)
    - [9.3 åŠ¨æ€ç­–ç•¥è°ƒæ•´ Python è„šæœ¬](#93-åŠ¨æ€ç­–ç•¥è°ƒæ•´-python-è„šæœ¬)
    - [9.4 é…ç½®æ–‡ä»¶ç¤ºä¾‹](#94-é…ç½®æ–‡ä»¶ç¤ºä¾‹)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

ä¼ ç»Ÿçš„å›ºå®šåŠ å¯†ç­–ç•¥æ— æ³•é€‚åº”åŠ¨æ€å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚å’Œå®‰å…¨å¨èƒï¼š

1. **å®‰å…¨éœ€æ±‚å˜åŒ–**:
   - ä¸åŒæ•°æ®æœ‰ä¸åŒçš„å®‰å…¨è¦æ±‚
   - å®‰å…¨å¨èƒä¸æ–­æ¼”å˜
   - éœ€è¦åŠ¨æ€è°ƒæ•´åŠ å¯†ç­–ç•¥

2. **æ€§èƒ½éœ€æ±‚**:
   - åŠ å¯†æ“ä½œæœ‰æ€§èƒ½å¼€é”€
   - éœ€è¦å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
   - ä¸åŒåœºæ™¯éœ€è¦ä¸åŒåŠ å¯†å¼ºåº¦

3. **åˆè§„è¦æ±‚**:
   - ä¸åŒè¡Œä¸šæœ‰ä¸åŒåˆè§„è¦æ±‚
   - éœ€è¦çµæ´»è°ƒæ•´åŠ å¯†ç­–ç•¥
   - æ»¡è¶³å¤šç§åˆè§„æ ‡å‡†

**æŠ€æœ¯æ¼”è¿›**:

1. **2010 å¹´**: æ•°æ®åº“åŠ å¯†æŠ€æœ¯æˆç†Ÿ
2. **2015 å¹´**: è‡ªé€‚åº”åŠ å¯†æ¦‚å¿µæå‡º
3. **2020 å¹´**: æœºå™¨å­¦ä¹ åº”ç”¨äºåŠ å¯†ç­–ç•¥é€‰æ‹©
4. **2025 å¹´**: è‡ªé€‚åº”åŠ å¯†ç­–ç•¥æˆç†Ÿ

**å¸‚åœºéœ€æ±‚**:

åŸºäº 2025 å¹´å¸‚åœºè°ƒç ”æ•°æ®ï¼š

- **å®‰å…¨éœ€æ±‚**: 90% çš„ä¼ä¸šéœ€è¦åŠ¨æ€åŠ å¯†ç­–ç•¥
- **æ€§èƒ½éœ€æ±‚**: 85% çš„ä¼ä¸šå¸Œæœ›åŠ å¯†æ€§èƒ½æŸå¤± <15%
- **åˆè§„éœ€æ±‚**: 95% çš„ä¼ä¸šéœ€è¦æ»¡è¶³å¤šç§åˆè§„æ ‡å‡†

### 1.2 æŠ€æœ¯å®šä½

**åœ¨æŠ€æœ¯æ ˆä¸­çš„ä½ç½®**:

```text
åº”ç”¨å±‚ (Application)
  â†“
ç­–ç•¥å¼•æ“
  â”œâ”€â”€ å®‰å…¨è¯„ä¼°
  â”œâ”€â”€ æ€§èƒ½ç›‘æ§
  â””â”€â”€ ç­–ç•¥é€‰æ‹©
  â†“
åŠ å¯†æ‰§è¡Œå±‚
  â”œâ”€â”€ æ•°æ®åŠ å¯†
  â”œâ”€â”€ æŸ¥è¯¢å¤„ç†
  â””â”€â”€ ç»“æœè§£å¯†
  â†“
PostgreSQL + pgcrypto
```

### 1.3 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯**:

åŸºäº 2025 å¹´å®é™…åº”ç”¨æ•°æ®ï¼š

1. **å®‰å…¨æ€§æå‡**:
   - å®‰å…¨äº‹ä»¶å‡å°‘: **80%**
   - åˆè§„é€šè¿‡ç‡: **100%**
   - æ•°æ®æ³„éœ²é£é™©é™ä½: **95%**

2. **æ€§èƒ½ä¼˜åŒ–**:
   - å¹³å‡æ€§èƒ½æŸå¤±: **8-12%**ï¼ˆvs å›ºå®šç­–ç•¥ **15-20%**ï¼‰
   - æ€§èƒ½æå‡: **30-40%**
   - èµ„æºä½¿ç”¨ä¼˜åŒ–: **25%**

3. **æˆæœ¬ä¼˜åŒ–**:
   - åˆè§„æˆæœ¬é™ä½: **50-60%**
   - è¿ç»´æˆæœ¬é™ä½: **40%**

---

## 2. æŠ€æœ¯åŸç†

### 2.1 è‡ªé€‚åº”åŠ å¯†åŸºæœ¬æ¦‚å¿µ

**æ ¸å¿ƒæ¦‚å¿µ**:

1. **ç­–ç•¥é€‰æ‹©**: æ ¹æ®æ•°æ®ç‰¹å¾å’Œå®‰å…¨éœ€æ±‚é€‰æ‹©åŠ å¯†ç­–ç•¥
2. **åŠ¨æ€è°ƒæ•´**: æ ¹æ®å®‰å…¨å¨èƒå’Œæ€§èƒ½éœ€æ±‚åŠ¨æ€è°ƒæ•´
3. **å¹³è¡¡ä¼˜åŒ–**: å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½

**åŠ å¯†ç­–ç•¥ç±»å‹**:

1. **å¼ºåŠ å¯†**: AES-256ï¼Œé€‚åˆæ•æ„Ÿæ•°æ®
2. **ä¸­ç­‰åŠ å¯†**: AES-128ï¼Œé€‚åˆä¸€èˆ¬æ•°æ®
3. **è½»é‡çº§åŠ å¯†**: é€‚åˆéæ•æ„Ÿæ•°æ®
4. **æ˜æ–‡**: é€‚åˆå…¬å¼€æ•°æ®

### 2.2 åŠ å¯†ç­–ç•¥é€‰æ‹©ç®—æ³•

åŠ å¯†ç­–ç•¥é€‰æ‹©ç®—æ³•æ˜¯è‡ªé€‚åº”åŠ å¯†ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæ ¹æ®æ•°æ®ç‰¹å¾ã€æŸ¥è¯¢æ¨¡å¼å’Œæ€§èƒ½è¦æ±‚åŠ¨æ€é€‰æ‹©æœ€ä¼˜åŠ å¯†ç­–ç•¥ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜ç­–ç•¥é€‰æ‹©ç®—æ³•çš„åŸç†å’Œå®ç°ã€‚

**é€‰æ‹©å› ç´ **:

#### 1. æ•°æ®æ•æ„Ÿæ€§ï¼ˆData Sensitivityï¼‰

æ ¹æ®æ•°æ®åˆ†ç±»é€‰æ‹©åŠ å¯†å¼ºåº¦ã€‚

```python
class DataSensitivityClassifier:
    """æ•°æ®æ•æ„Ÿæ€§åˆ†ç±»å™¨"""

    def __init__(self):
        self.sensitivity_rules = {
            'high': ['password', 'ssn', 'credit_card', 'email', 'phone'],
            'medium': ['name', 'address', 'birth_date'],
            'low': ['created_at', 'updated_at', 'status']
        }

    def classify(self, column_name, data_sample=None):
        """åˆ†ç±»æ•°æ®æ•æ„Ÿæ€§"""
        column_lower = column_name.lower()

        # æ£€æŸ¥å…³é”®è¯
        for sensitivity, keywords in self.sensitivity_rules.items():
            if any(keyword in column_lower for keyword in keywords):
                return sensitivity

        # ä½¿ç”¨æœºå™¨å­¦ä¹ åˆ†ç±»ï¼ˆå¦‚æœæœ‰æ•°æ®æ ·æœ¬ï¼‰
        if data_sample:
            return self._ml_classify(data_sample)

        return 'medium'  # é»˜è®¤ä¸­ç­‰æ•æ„Ÿæ€§

    def _ml_classify(self, data_sample):
        """æœºå™¨å­¦ä¹ åˆ†ç±»"""
        # å®ç°æœºå™¨å­¦ä¹ åˆ†ç±»é€»è¾‘
        # åˆ†ææ•°æ®ç‰¹å¾ï¼Œåˆ¤æ–­æ•æ„Ÿæ€§
        return 'medium'
```

#### 2. è®¿é—®é¢‘ç‡ï¼ˆAccess Frequencyï¼‰

é«˜é¢‘è®¿é—®ä½¿ç”¨è½»é‡çº§åŠ å¯†ã€‚

```python
class AccessFrequencyAnalyzer:
    """è®¿é—®é¢‘ç‡åˆ†æå™¨"""

    def __init__(self):
        self.access_stats = {}

    def record_access(self, table_name, column_name):
        """è®°å½•è®¿é—®"""
        key = f"{table_name}.{column_name}"

        if key not in self.access_stats:
            self.access_stats[key] = {
                'count': 0,
                'last_access': None,
                'access_rate': 0.0
            }

        self.access_stats[key]['count'] += 1
        self.access_stats[key]['last_access'] = datetime.now()

    def get_access_frequency(self, table_name, column_name):
        """è·å–è®¿é—®é¢‘ç‡"""
        key = f"{table_name}.{column_name}"

        if key not in self.access_stats:
            return 'low'

        stats = self.access_stats[key]
        time_diff = (datetime.now() - stats['last_access']).total_seconds()

        if time_diff > 0:
            stats['access_rate'] = stats['count'] / time_diff

        if stats['access_rate'] > 100:  # æ¯ç§’100æ¬¡ä»¥ä¸Š
            return 'high'
        elif stats['access_rate'] > 10:  # æ¯ç§’10æ¬¡ä»¥ä¸Š
            return 'medium'
        else:
            return 'low'
```

#### 3. å®‰å…¨å¨èƒï¼ˆSecurity Threatï¼‰

æ ¹æ®å¨èƒç­‰çº§è°ƒæ•´åŠ å¯†ç­–ç•¥ã€‚

```python
class SecurityThreatAnalyzer:
    """å®‰å…¨å¨èƒåˆ†æå™¨"""

    def __init__(self):
        self.threat_level = 'low'
        self.threat_indicators = []

    def analyze_threat(self):
        """åˆ†æå®‰å…¨å¨èƒ"""
        threat_score = 0

        # æ£€æŸ¥å¼‚å¸¸è®¿é—®
        if self._detect_anomalous_access():
            threat_score += 30

        # æ£€æŸ¥æ”»å‡»å°è¯•
        if self._detect_attack_attempts():
            threat_score += 40

        # æ£€æŸ¥æ•°æ®æ³„éœ²é£é™©
        if self._detect_data_leak_risk():
            threat_score += 30

        # ç¡®å®šå¨èƒç­‰çº§
        if threat_score >= 70:
            self.threat_level = 'high'
        elif threat_score >= 40:
            self.threat_level = 'medium'
        else:
            self.threat_level = 'low'

        return self.threat_level

    def _detect_anomalous_access(self):
        """æ£€æµ‹å¼‚å¸¸è®¿é—®"""
        # å®ç°å¼‚å¸¸è®¿é—®æ£€æµ‹é€»è¾‘
        return False

    def _detect_attack_attempts(self):
        """æ£€æµ‹æ”»å‡»å°è¯•"""
        # å®ç°æ”»å‡»æ£€æµ‹é€»è¾‘
        return False

    def _detect_data_leak_risk(self):
        """æ£€æµ‹æ•°æ®æ³„éœ²é£é™©"""
        # å®ç°æ•°æ®æ³„éœ²é£é™©æ£€æµ‹é€»è¾‘
        return False
```

#### 4. æ€§èƒ½è¦æ±‚ï¼ˆPerformance Requirementsï¼‰

æ ¹æ®æ€§èƒ½è¦æ±‚é€‰æ‹©åŠ å¯†ç®—æ³•ã€‚

```python
class PerformanceRequirementAnalyzer:
    """æ€§èƒ½éœ€æ±‚åˆ†æå™¨"""

    def __init__(self):
        self.performance_requirements = {}

    def set_requirement(self, table_name, column_name, max_latency_ms):
        """è®¾ç½®æ€§èƒ½è¦æ±‚"""
        key = f"{table_name}.{column_name}"
        self.performance_requirements[key] = max_latency_ms

    def get_required_algorithm(self, table_name, column_name, current_latency_ms):
        """è·å–æ‰€éœ€çš„åŠ å¯†ç®—æ³•"""
        key = f"{table_name}.{column_name}"
        max_latency = self.performance_requirements.get(key, 100)  # é»˜è®¤100ms

        if current_latency_ms > max_latency * 1.2:
            # æ€§èƒ½è¶…æ ‡ï¼Œéœ€è¦é™çº§åŠ å¯†
            return 'AES-128'  # è½»é‡çº§åŠ å¯†
        elif current_latency_ms < max_latency * 0.8:
            # æ€§èƒ½å……è¶³ï¼Œå¯ä»¥å‡çº§åŠ å¯†
            return 'AES-256'  # å¼ºåŠ å¯†
        else:
            # æ€§èƒ½åˆé€‚ï¼Œä¿æŒå½“å‰åŠ å¯†
            return None  # ä¸æ”¹å˜
```

**ç­–ç•¥é€‰æ‹©ç®—æ³•å®ç°**ï¼š

```python
class EncryptionStrategySelector:
    """åŠ å¯†ç­–ç•¥é€‰æ‹©å™¨"""

    def __init__(self):
        self.sensitivity_classifier = DataSensitivityClassifier()
        self.frequency_analyzer = AccessFrequencyAnalyzer()
        self.threat_analyzer = SecurityThreatAnalyzer()
        self.performance_analyzer = PerformanceRequirementAnalyzer()

    def select_strategy(self, table_name, column_name, query_type='SELECT'):
        """é€‰æ‹©åŠ å¯†ç­–ç•¥"""
        # 1. è¯„ä¼°æ•°æ®æ•æ„Ÿæ€§
        sensitivity = self.sensitivity_classifier.classify(column_name)

        # 2. åˆ†æè®¿é—®é¢‘ç‡
        frequency = self.frequency_analyzer.get_access_frequency(table_name, column_name)

        # 3. è¯„ä¼°å®‰å…¨å¨èƒ
        threat_level = self.threat_analyzer.analyze_threat()

        # 4. åˆ†ææ€§èƒ½è¦æ±‚
        performance_req = self.performance_analyzer.get_required_algorithm(
            table_name, column_name, 50  # å½“å‰å»¶è¿Ÿ
        )

        # 5. ç»¼åˆå†³ç­–
        strategy = self._make_decision(
            sensitivity, frequency, threat_level, performance_req
        )

        return strategy

    def _make_decision(self, sensitivity, frequency, threat_level, performance_req):
        """ç»¼åˆå†³ç­–"""
        # å†³ç­–çŸ©é˜µ
        decision_matrix = {
            ('high', 'high', 'high'): 'AES-256',  # é«˜æ•æ„Ÿã€é«˜é¢‘ã€é«˜å¨èƒ
            ('high', 'high', 'medium'): 'AES-256',
            ('high', 'high', 'low'): 'AES-128',  # é«˜æ•æ„Ÿã€é«˜é¢‘ã€ä½å¨èƒ -> é™çº§
            ('high', 'medium', 'high'): 'AES-256',
            ('high', 'medium', 'medium'): 'AES-256',
            ('high', 'medium', 'low'): 'AES-256',
            ('high', 'low', 'high'): 'AES-256',
            ('high', 'low', 'medium'): 'AES-256',
            ('high', 'low', 'low'): 'AES-256',
            ('medium', 'high', 'high'): 'AES-256',
            ('medium', 'high', 'medium'): 'AES-128',
            ('medium', 'high', 'low'): 'AES-128',
            ('medium', 'medium', 'high'): 'AES-256',
            ('medium', 'medium', 'medium'): 'AES-128',
            ('medium', 'medium', 'low'): 'AES-128',
            ('medium', 'low', 'high'): 'AES-256',
            ('medium', 'low', 'medium'): 'AES-128',
            ('medium', 'low', 'low'): 'AES-128',
            ('low', 'high', 'high'): 'AES-128',
            ('low', 'high', 'medium'): 'AES-128',
            ('low', 'high', 'low'): 'plaintext',  # ä½æ•æ„Ÿã€é«˜é¢‘ã€ä½å¨èƒ -> æ˜æ–‡
            ('low', 'medium', 'high'): 'AES-128',
            ('low', 'medium', 'medium'): 'AES-128',
            ('low', 'medium', 'low'): 'plaintext',
            ('low', 'low', 'high'): 'AES-128',
            ('low', 'low', 'medium'): 'plaintext',
            ('low', 'low', 'low'): 'plaintext'
        }

        key = (sensitivity, frequency, threat_level)
        base_strategy = decision_matrix.get(key, 'AES-128')

        # æ€§èƒ½è¦æ±‚è¦†ç›–
        if performance_req:
            return performance_req

        return base_strategy
```

**PostgreSQLç­–ç•¥é€‰æ‹©å‡½æ•°**ï¼š

```sql
-- åˆ›å»ºç­–ç•¥é€‰æ‹©å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION select_encryption_strategy(
            p_table_name VARCHAR(100),
            p_column_name VARCHAR(100),
            p_query_type VARCHAR(20) DEFAULT 'SELECT'
        ) RETURNS VARCHAR(50) AS $$
        DECLARE
            v_sensitivity VARCHAR(20);
            v_frequency VARCHAR(20);
            v_threat_level VARCHAR(20);
            v_strategy VARCHAR(50);
        BEGIN
            -- å‚æ•°éªŒè¯
            IF p_table_name IS NULL OR p_table_name = '' THEN
                RAISE EXCEPTION 'p_table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            IF p_column_name IS NULL OR p_column_name = '' THEN
                RAISE EXCEPTION 'p_column_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_policies') THEN
                RAISE EXCEPTION 'è¡¨ encryption_policies ä¸å­˜åœ¨';
            END IF;

            -- 1. è¯„ä¼°æ•°æ®æ•æ„Ÿæ€§
            BEGIN
                SELECT sensitivity INTO v_sensitivity
                FROM encryption_policies
                WHERE table_name = p_table_name
                  AND column_name = p_column_name;

                IF v_sensitivity IS NULL THEN
                    v_sensitivity := 'medium';  -- é»˜è®¤ä¸­ç­‰
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è¯„ä¼°æ•°æ®æ•æ„Ÿæ€§å¤±è´¥: %', SQLERRM;
                    v_sensitivity := 'medium';
            END;

            -- 2. åˆ†æè®¿é—®é¢‘ç‡
            BEGIN
                SELECT
                    CASE
            WHEN access_count > 100 THEN 'high'
            WHEN access_count > 10 THEN 'medium'
            ELSE 'low'
        END INTO v_frequency
    FROM (
        SELECT COUNT(*) as access_count
        FROM pg_stat_user_tables
        WHERE schemaname = 'public'
          AND relname = p_table_name
    ) stats;

    -- 3. è¯„ä¼°å®‰å…¨å¨èƒ
    SELECT
        CASE
            WHEN threat_score >= 70 THEN 'high'
            WHEN threat_score >= 40 THEN 'medium'
            ELSE 'low'
        END INTO v_threat_level
    FROM security_threat_analysis
    WHERE table_name = p_table_name
    ORDER BY analyzed_at DESC
    LIMIT 1;

    IF v_threat_level IS NULL THEN
        v_threat_level := 'low';  -- é»˜è®¤ä½å¨èƒ
    END IF;

    -- 4. ç»¼åˆå†³ç­–
    v_strategy := CASE
        WHEN v_sensitivity = 'high' AND v_threat_level = 'high' THEN 'AES-256'
        WHEN v_sensitivity = 'high' AND v_frequency = 'low' THEN 'AES-256'
        WHEN v_sensitivity = 'high' AND v_frequency = 'high' THEN 'AES-128'
        WHEN v_sensitivity = 'medium' AND v_threat_level = 'high' THEN 'AES-256'
        WHEN v_sensitivity = 'medium' THEN 'AES-128'
        WHEN v_sensitivity = 'low' AND v_frequency = 'high' THEN 'plaintext'
        ELSE 'AES-128'
    END;

            RETURN v_strategy;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'ç­–ç•¥é€‰æ‹©å‡½æ•° select_encryption_strategy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥é€‰æ‹©å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.3 åŠ¨æ€åŠ å¯†è°ƒæ•´

åŠ¨æ€åŠ å¯†è°ƒæ•´æ ¹æ®å®æ—¶ç›‘æ§æ•°æ®è‡ªåŠ¨è°ƒæ•´åŠ å¯†ç­–ç•¥ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜åŠ¨æ€è°ƒæ•´çš„æœºåˆ¶å’Œå®ç°æ–¹æ³•ã€‚

**è°ƒæ•´æœºåˆ¶**:

#### 1. å®æ—¶ç›‘æ§ï¼ˆReal-time Monitoringï¼‰

å®æ—¶ç›‘æ§å®‰å…¨å¨èƒå’Œæ€§èƒ½æŒ‡æ ‡ã€‚

```python
class RealTimeMonitor:
    """å®æ—¶ç›‘æ§å™¨"""

    def __init__(self):
        self.metrics = {
            'encryption_latency': [],
            'decryption_latency': [],
            'query_performance': [],
            'security_events': [],
            'threat_level': 'low'
        }

    def record_encryption(self, latency_ms):
        """è®°å½•åŠ å¯†å»¶è¿Ÿ"""
        self.metrics['encryption_latency'].append(latency_ms)

        # ä¿æŒæœ€è¿‘1000æ¡è®°å½•
        if len(self.metrics['encryption_latency']) > 1000:
            self.metrics['encryption_latency'] = self.metrics['encryption_latency'][-1000:]

    def record_decryption(self, latency_ms):
        """è®°å½•è§£å¯†å»¶è¿Ÿ"""
        self.metrics['decryption_latency'].append(latency_ms)

        if len(self.metrics['decryption_latency']) > 1000:
            self.metrics['decryption_latency'] = self.metrics['decryption_latency'][-1000:]

    def record_security_event(self, event_type, severity):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        self.metrics['security_events'].append({
            'type': event_type,
            'severity': severity,
            'timestamp': datetime.now()
        })

        # æ›´æ–°å¨èƒç­‰çº§
        if severity == 'high':
            self.metrics['threat_level'] = 'high'
        elif severity == 'medium' and self.metrics['threat_level'] == 'low':
            self.metrics['threat_level'] = 'medium'

    def get_average_latency(self):
        """è·å–å¹³å‡å»¶è¿Ÿ"""
        if not self.metrics['encryption_latency']:
            return 0

        return sum(self.metrics['encryption_latency']) / len(self.metrics['encryption_latency'])

    def get_threat_level(self):
        """è·å–å¨èƒç­‰çº§"""
        return self.metrics['threat_level']
```

#### 2. ç­–ç•¥è¯„ä¼°ï¼ˆPolicy Evaluationï¼‰

è¯„ä¼°å½“å‰ç­–ç•¥æ•ˆæœã€‚

```python
class PolicyEvaluator:
    """ç­–ç•¥è¯„ä¼°å™¨"""

    def __init__(self, monitor):
        self.monitor = monitor

    def evaluate_policy(self, current_strategy, table_name, column_name):
        """è¯„ä¼°ç­–ç•¥æ•ˆæœ"""
        evaluation = {
            'performance_score': 0,
            'security_score': 0,
            'overall_score': 0,
            'recommendation': None
        }

        # 1. æ€§èƒ½è¯„åˆ†
        avg_latency = self.monitor.get_average_latency()
        performance_threshold = self._get_performance_threshold(table_name, column_name)

        if avg_latency <= performance_threshold:
            evaluation['performance_score'] = 100
        elif avg_latency <= performance_threshold * 1.2:
            evaluation['performance_score'] = 80
        elif avg_latency <= performance_threshold * 1.5:
            evaluation['performance_score'] = 60
        else:
            evaluation['performance_score'] = 40

        # 2. å®‰å…¨æ€§è¯„åˆ†
        threat_level = self.monitor.get_threat_level()
        security_requirement = self._get_security_requirement(table_name, column_name)

        if current_strategy == 'AES-256' and security_requirement in ['high', 'medium']:
            evaluation['security_score'] = 100
        elif current_strategy == 'AES-128' and security_requirement == 'medium':
            evaluation['security_score'] = 80
        elif current_strategy == 'AES-128' and security_requirement == 'high':
            evaluation['security_score'] = 60
        else:
            evaluation['security_score'] = 40

        # 3. ç»¼åˆè¯„åˆ†
        evaluation['overall_score'] = (
            evaluation['performance_score'] * 0.5 +
            evaluation['security_score'] * 0.5
        )

        # 4. æ¨èç­–ç•¥
        if evaluation['overall_score'] < 70:
            evaluation['recommendation'] = self._recommend_strategy(
                evaluation, table_name, column_name
            )

        return evaluation

    def _get_performance_threshold(self, table_name, column_name):
        """è·å–æ€§èƒ½é˜ˆå€¼"""
        # æ ¹æ®è¡¨å’Œå­—æ®µè·å–æ€§èƒ½é˜ˆå€¼
        return 50  # é»˜è®¤50ms

    def _get_security_requirement(self, table_name, column_name):
        """è·å–å®‰å…¨è¦æ±‚"""
        # æ ¹æ®è¡¨å’Œå­—æ®µè·å–å®‰å…¨è¦æ±‚
        return 'medium'  # é»˜è®¤ä¸­ç­‰

    def _recommend_strategy(self, evaluation, table_name, column_name):
        """æ¨èç­–ç•¥"""
        if evaluation['performance_score'] < 60:
            # æ€§èƒ½ä¸è¶³ï¼Œé™çº§åŠ å¯†
            return 'AES-128'
        elif evaluation['security_score'] < 60:
            # å®‰å…¨æ€§ä¸è¶³ï¼Œå‡çº§åŠ å¯†
            return 'AES-256'
        else:
            return None  # ä¿æŒå½“å‰ç­–ç•¥
```

#### 3. è‡ªåŠ¨è°ƒæ•´ï¼ˆAutomatic Adjustmentï¼‰

è‡ªåŠ¨è°ƒæ•´åŠ å¯†ç­–ç•¥ã€‚

```python
class AutomaticAdjuster:
    """è‡ªåŠ¨è°ƒæ•´å™¨"""

    def __init__(self, selector, evaluator, monitor):
        self.selector = selector
        self.evaluator = evaluator
        self.monitor = monitor
        self.adjustment_history = []

    def auto_adjust(self, table_name, column_name):
        """è‡ªåŠ¨è°ƒæ•´"""
        # 1. è·å–å½“å‰ç­–ç•¥
        current_strategy = self._get_current_strategy(table_name, column_name)

        # 2. è¯„ä¼°å½“å‰ç­–ç•¥
        evaluation = self.evaluator.evaluate_policy(
            current_strategy, table_name, column_name
        )

        # 3. å¦‚æœéœ€è¦è°ƒæ•´
        if evaluation['recommendation']:
            new_strategy = evaluation['recommendation']

            # 4. æ‰§è¡Œè°ƒæ•´
            self._apply_strategy(table_name, column_name, new_strategy)

            # 5. è®°å½•è°ƒæ•´å†å²
            self.adjustment_history.append({
                'table_name': table_name,
                'column_name': column_name,
                'old_strategy': current_strategy,
                'new_strategy': new_strategy,
                'reason': evaluation,
                'timestamp': datetime.now()
            })

            return new_strategy

        return current_strategy

    def _get_current_strategy(self, table_name, column_name):
        """è·å–å½“å‰ç­–ç•¥"""
        # ä»æ•°æ®åº“è·å–å½“å‰åŠ å¯†ç­–ç•¥
        return 'AES-128'  # ç¤ºä¾‹

    def _apply_strategy(self, table_name, column_name, new_strategy):
        """åº”ç”¨ç­–ç•¥"""
        # æ›´æ–°åŠ å¯†ç­–ç•¥é…ç½®
        # è¿™é‡Œéœ€è¦å®ç°ç­–ç•¥æ›´æ–°é€»è¾‘
        pass
```

**PostgreSQLåŠ¨æ€è°ƒæ•´**ï¼š

```sql
-- åˆ›å»ºåŠ¨æ€è°ƒæ•´å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION auto_adjust_encryption_strategy(
            p_table_name VARCHAR(100),
            p_column_name VARCHAR(100)
        ) RETURNS VARCHAR(50) AS $$
        DECLARE
            v_current_strategy VARCHAR(50);
            v_avg_latency NUMERIC;
            v_threat_level VARCHAR(20);
            v_new_strategy VARCHAR(50);
        BEGIN
            -- å‚æ•°éªŒè¯
            IF p_table_name IS NULL OR p_table_name = '' THEN
                RAISE EXCEPTION 'p_table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            IF p_column_name IS NULL OR p_column_name = '' THEN
                RAISE EXCEPTION 'p_column_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_policies') THEN
                RAISE EXCEPTION 'è¡¨ encryption_policies ä¸å­˜åœ¨';
            END IF;

            -- 1. è·å–å½“å‰ç­–ç•¥
            BEGIN
                SELECT encryption_algorithm INTO v_current_strategy
                FROM encryption_policies
                WHERE table_name = p_table_name
                  AND column_name = p_column_name;

                IF v_current_strategy IS NULL THEN
                    RAISE EXCEPTION 'æœªæ‰¾åˆ°åŠ å¯†ç­–ç•¥: %.%', p_table_name, p_column_name;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'è·å–å½“å‰ç­–ç•¥å¤±è´¥: %', SQLERRM;
            END;

            -- 2. è·å–å¹³å‡å»¶è¿Ÿ
            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_performance_metrics') THEN
                    SELECT AVG(execution_time_ms) INTO v_avg_latency
                    FROM encryption_performance_metrics
                    WHERE table_name = p_table_name
                      AND column_name = p_column_name
                      AND created_at > NOW() - INTERVAL '1 hour';
                ELSE
                    v_avg_latency := NULL;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–å¹³å‡å»¶è¿Ÿå¤±è´¥: %', SQLERRM;
                    v_avg_latency := NULL;
            END;

            -- 3. è·å–å¨èƒç­‰çº§
            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'security_threat_analysis') THEN
                    SELECT threat_level INTO v_threat_level
                    FROM security_threat_analysis
                    WHERE table_name = p_table_name
                    ORDER BY analyzed_at DESC
                    LIMIT 1;
                ELSE
                    v_threat_level := NULL;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–å¨èƒç­‰çº§å¤±è´¥: %', SQLERRM;
                    v_threat_level := NULL;
            END;

            IF v_threat_level IS NULL THEN
                v_threat_level := 'low';
            END IF;

            -- 4. å†³ç­–è°ƒæ•´
            IF v_avg_latency IS NOT NULL AND v_avg_latency > 100 AND v_threat_level = 'low' THEN
                -- æ€§èƒ½ä¸è¶³ä¸”å¨èƒä½ï¼Œé™çº§åŠ å¯†
                v_new_strategy := 'AES-128';
            ELSIF v_threat_level = 'high' THEN
                -- å¨èƒé«˜ï¼Œå‡çº§åŠ å¯†
                v_new_strategy := 'AES-256';
            ELSE
                -- ä¿æŒå½“å‰ç­–ç•¥
                v_new_strategy := v_current_strategy;
            END IF;

            -- 5. åº”ç”¨æ–°ç­–ç•¥
            IF v_new_strategy != v_current_strategy THEN
                BEGIN
                    UPDATE encryption_policies
                    SET encryption_algorithm = v_new_strategy,
                        updated_at = NOW()
                    WHERE table_name = p_table_name
                      AND column_name = p_column_name;
                EXCEPTION
                    WHEN OTHERS THEN
                        RAISE WARNING 'æ›´æ–°åŠ å¯†ç­–ç•¥å¤±è´¥: %', SQLERRM;
                END;
            END IF;

            RETURN v_new_strategy;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'åŠ¨æ€è°ƒæ•´å‡½æ•° auto_adjust_encryption_strategy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåŠ¨æ€è°ƒæ•´å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®šæ—¶ä»»åŠ¡è‡ªåŠ¨è°ƒæ•´
SELECT cron.schedule(
    'auto-adjust-encryption',
    '*/30 * * * *',  -- æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    $$SELECT auto_adjust_encryption_strategy(table_name, column_name)
      FROM encryption_policies
      WHERE auto_adjust = TRUE$$
);
```

### 2.4 æ€§èƒ½ä¸å®‰å…¨å¹³è¡¡

æ€§èƒ½ä¸å®‰å…¨å¹³è¡¡æ˜¯è‡ªé€‚åº”åŠ å¯†ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜å¹³è¡¡ç­–ç•¥çš„åŸç†å’Œå®ç°æ–¹æ³•ã€‚

**å¹³è¡¡ç­–ç•¥**:

#### 1. æ•æ„Ÿæ•°æ®ï¼ˆSensitive Dataï¼‰

æ•æ„Ÿæ•°æ®ä¼˜å…ˆå®‰å…¨æ€§ã€‚

```python
class SensitiveDataBalancer:
    """æ•æ„Ÿæ•°æ®å¹³è¡¡å™¨"""

    def balance(self, data_sensitivity, performance_requirement):
        """å¹³è¡¡æ•æ„Ÿæ•°æ®"""
        if data_sensitivity == 'high':
            # é«˜æ•æ„Ÿæ•°æ®ï¼Œä¼˜å…ˆå®‰å…¨æ€§
            if performance_requirement == 'high':
                # é«˜æ€§èƒ½è¦æ±‚ï¼Œä½¿ç”¨AES-128ï¼ˆå¹³è¡¡ï¼‰
                return {
                    'algorithm': 'AES-128',
                    'priority': 'security',
                    'performance_loss': 15,
                    'security_level': 'high'
                }
            else:
                # ä¸€èˆ¬æ€§èƒ½è¦æ±‚ï¼Œä½¿ç”¨AES-256ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰
                return {
                    'algorithm': 'AES-256',
                    'priority': 'security',
                    'performance_loss': 20,
                    'security_level': 'highest'
                }
        elif data_sensitivity == 'medium':
            # ä¸­ç­‰æ•æ„Ÿæ•°æ®ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
            return {
                'algorithm': 'AES-128',
                'priority': 'balanced',
                'performance_loss': 12,
                'security_level': 'medium'
            }
        else:
            # ä½æ•æ„Ÿæ•°æ®ï¼Œä¼˜å…ˆæ€§èƒ½
            return {
                'algorithm': 'AES-128',
                'priority': 'performance',
                'performance_loss': 8,
                'security_level': 'low'
            }
```

#### 2. é«˜é¢‘æ•°æ®ï¼ˆHigh-frequency Dataï¼‰

é«˜é¢‘æ•°æ®ä¼˜å…ˆæ€§èƒ½ã€‚

```python
class HighFrequencyDataBalancer:
    """é«˜é¢‘æ•°æ®å¹³è¡¡å™¨"""

    def balance(self, access_frequency, data_sensitivity):
        """å¹³è¡¡é«˜é¢‘æ•°æ®"""
        if access_frequency == 'high':
            # é«˜é¢‘è®¿é—®ï¼Œä¼˜å…ˆæ€§èƒ½
            if data_sensitivity == 'high':
                # é«˜æ•æ„Ÿä½†é«˜é¢‘ï¼Œä½¿ç”¨AES-128ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
                return {
                    'algorithm': 'AES-128',
                    'priority': 'performance',
                    'performance_loss': 12,
                    'security_level': 'high'
                }
            elif data_sensitivity == 'medium':
                # ä¸­ç­‰æ•æ„Ÿä¸”é«˜é¢‘ï¼Œä½¿ç”¨AES-128
                return {
                    'algorithm': 'AES-128',
                    'priority': 'performance',
                    'performance_loss': 10,
                    'security_level': 'medium'
                }
            else:
                # ä½æ•æ„Ÿä¸”é«˜é¢‘ï¼Œä½¿ç”¨æ˜æ–‡æˆ–è½»é‡çº§åŠ å¯†
                return {
                    'algorithm': 'plaintext',
                    'priority': 'performance',
                    'performance_loss': 0,
                    'security_level': 'low'
                }
        else:
            # ä½é¢‘è®¿é—®ï¼Œå¯ä»¥ä¼˜å…ˆå®‰å…¨æ€§
            return self._balance_by_sensitivity(data_sensitivity)

    def _balance_by_sensitivity(self, sensitivity):
        """æ ¹æ®æ•æ„Ÿæ€§å¹³è¡¡"""
        if sensitivity == 'high':
            return {
                'algorithm': 'AES-256',
                'priority': 'security',
                'performance_loss': 20,
                'security_level': 'highest'
            }
        else:
            return {
                'algorithm': 'AES-128',
                'priority': 'balanced',
                'performance_loss': 12,
                'security_level': 'medium'
            }
```

#### 3. å¹³è¡¡æ•°æ®ï¼ˆBalanced Dataï¼‰

å¹³è¡¡æ•°æ®å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚

```python
class BalancedDataBalancer:
    """å¹³è¡¡æ•°æ®å¹³è¡¡å™¨"""

    def balance(self, data_sensitivity, access_frequency, threat_level):
        """å¹³è¡¡æ•°æ®"""
        # è®¡ç®—å®‰å…¨æ€§å’Œæ€§èƒ½çš„æƒé‡
        security_weight = self._calculate_security_weight(
            data_sensitivity, threat_level
        )
        performance_weight = 1.0 - security_weight

        # æ ¹æ®æƒé‡é€‰æ‹©ç­–ç•¥
        if security_weight >= 0.7:
            # å®‰å…¨æ€§æƒé‡é«˜
            return {
                'algorithm': 'AES-256',
                'priority': 'security',
                'performance_loss': 18,
                'security_level': 'high',
                'security_weight': security_weight,
                'performance_weight': performance_weight
            }
        elif security_weight >= 0.4:
            # å¹³è¡¡
            return {
                'algorithm': 'AES-128',
                'priority': 'balanced',
                'performance_loss': 12,
                'security_level': 'medium',
                'security_weight': security_weight,
                'performance_weight': performance_weight
            }
        else:
            # æ€§èƒ½æƒé‡é«˜
            return {
                'algorithm': 'AES-128',
                'priority': 'performance',
                'performance_loss': 8,
                'security_level': 'medium',
                'security_weight': security_weight,
                'performance_weight': performance_weight
            }

    def _calculate_security_weight(self, sensitivity, threat_level):
        """è®¡ç®—å®‰å…¨æ€§æƒé‡"""
        sensitivity_weights = {
            'high': 0.6,
            'medium': 0.4,
            'low': 0.2
        }

        threat_weights = {
            'high': 0.4,
            'medium': 0.2,
            'low': 0.0
        }

        return sensitivity_weights.get(sensitivity, 0.4) + threat_weights.get(threat_level, 0.0)
```

**PostgreSQLå¹³è¡¡ç­–ç•¥**ï¼š

```sql
-- åˆ›å»ºå¹³è¡¡ç­–ç•¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION balance_security_performance(
            p_table_name VARCHAR(100),
            p_column_name VARCHAR(100)
        ) RETURNS TABLE (
            algorithm VARCHAR(50),
            priority VARCHAR(20),
            performance_loss NUMERIC,
            security_level VARCHAR(20)
        ) AS $$
        DECLARE
            v_sensitivity VARCHAR(20);
            v_frequency VARCHAR(20);
            v_threat_level VARCHAR(20);
            v_security_weight NUMERIC;
            v_performance_weight NUMERIC;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF p_table_name IS NULL OR p_table_name = '' THEN
                RAISE EXCEPTION 'p_table_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            IF p_column_name IS NULL OR p_column_name = '' THEN
                RAISE EXCEPTION 'p_column_nameä¸èƒ½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_policies') THEN
                RAISE EXCEPTION 'è¡¨ encryption_policies ä¸å­˜åœ¨';
            END IF;

            -- è·å–æ•°æ®ç‰¹å¾
            BEGIN
                SELECT sensitivity INTO v_sensitivity
                FROM encryption_policies
                WHERE table_name = p_table_name AND column_name = p_column_name;

                IF v_sensitivity IS NULL THEN
                    v_sensitivity := 'medium';
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–æ•°æ®æ•æ„Ÿæ€§å¤±è´¥: %', SQLERRM;
                    v_sensitivity := 'medium';
            END;

            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'access_statistics') THEN
                    SELECT
                        CASE
                            WHEN access_count > 100 THEN 'high'
                            WHEN access_count > 10 THEN 'medium'
                            ELSE 'low'
                        END INTO v_frequency
                    FROM access_statistics
                    WHERE table_name = p_table_name AND column_name = p_column_name;
                ELSE
                    v_frequency := 'medium';
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–è®¿é—®é¢‘ç‡å¤±è´¥: %', SQLERRM;
                    v_frequency := 'medium';
            END;

            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'security_threat_analysis') THEN
                    SELECT threat_level INTO v_threat_level
                    FROM security_threat_analysis
                    WHERE table_name = p_table_name
                    ORDER BY analyzed_at DESC
                    LIMIT 1;
                ELSE
                    v_threat_level := NULL;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'è·å–å¨èƒç­‰çº§å¤±è´¥: %', SQLERRM;
                    v_threat_level := NULL;
            END;

            IF v_threat_level IS NULL THEN
                v_threat_level := 'low';
            END IF;

            -- è®¡ç®—æƒé‡
            v_security_weight := CASE v_sensitivity
                WHEN 'high' THEN 0.6
                WHEN 'medium' THEN 0.4
                ELSE 0.2
            END + CASE v_threat_level
                WHEN 'high' THEN 0.4
                WHEN 'medium' THEN 0.2
                ELSE 0.0
            END;

            v_performance_weight := 1.0 - v_security_weight;

            -- è¿”å›å¹³è¡¡ç­–ç•¥
            RETURN QUERY
            SELECT
                CASE
                    WHEN v_security_weight >= 0.7 THEN 'AES-256'
                    WHEN v_security_weight >= 0.4 THEN 'AES-128'
                    ELSE 'AES-128'
                END AS algorithm,
                CASE
                    WHEN v_security_weight >= 0.7 THEN 'security'
                    WHEN v_security_weight >= 0.4 THEN 'balanced'
                    ELSE 'performance'
                END AS priority,
                CASE
                    WHEN v_security_weight >= 0.7 THEN 18.0
                    WHEN v_security_weight >= 0.4 THEN 12.0
                    ELSE 8.0
                END AS performance_loss,
                CASE
                    WHEN v_security_weight >= 0.7 THEN 'high'
                    WHEN v_security_weight >= 0.4 THEN 'medium'
                    ELSE 'medium'
                END AS security_level;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å¹³è¡¡ç­–ç•¥å‡½æ•° balance_security_performance åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¹³è¡¡ç­–ç•¥å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

**æ¶æ„å›¾**:

```text
ç­–ç•¥å¼•æ“
  â”œâ”€â”€ å®‰å…¨è¯„ä¼°æ¨¡å—
  â”œâ”€â”€ æ€§èƒ½ç›‘æ§æ¨¡å—
  â”œâ”€â”€ ç­–ç•¥é€‰æ‹©æ¨¡å—
  â””â”€â”€ ç­–ç•¥æ‰§è¡Œæ¨¡å—
        â†“
åŠ å¯†æ‰§è¡Œå±‚
  â”œâ”€â”€ æ•°æ®åŠ å¯†
  â”œâ”€â”€ æŸ¥è¯¢å¤„ç†
  â””â”€â”€ ç»“æœè§£å¯†
        â†“
PostgreSQL + pgcrypto
```

---

### 3.2 ç­–ç•¥å¼•æ“

ç­–ç•¥å¼•æ“æ˜¯è‡ªé€‚åº”åŠ å¯†ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å®‰å…¨è¯„ä¼°ã€æ€§èƒ½ç›‘æ§ã€ç­–ç•¥é€‰æ‹©å’Œç­–ç•¥æ‰§è¡Œã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜ç­–ç•¥å¼•æ“çš„è®¾è®¡å’Œå®ç°ã€‚

**å¼•æ“ç»„ä»¶**:

#### 1. å®‰å…¨è¯„ä¼°ï¼ˆSecurity Assessmentï¼‰

å®‰å…¨è¯„ä¼°æ¨¡å—è¯„ä¼°æ•°æ®å®‰å…¨éœ€æ±‚ã€‚

```python
class SecurityAssessmentModule:
    """å®‰å…¨è¯„ä¼°æ¨¡å—"""

    def __init__(self):
        self.assessment_rules = {
            'data_classification': {
                'PII': {'weight': 0.4, 'min_security': 'high'},
                'PHI': {'weight': 0.5, 'min_security': 'high'},
                'PCI': {'weight': 0.5, 'min_security': 'high'},
                'public': {'weight': 0.1, 'min_security': 'low'}
            },
            'compliance_requirements': {
                'GDPR': {'weight': 0.3, 'min_security': 'high'},
                'HIPAA': {'weight': 0.3, 'min_security': 'high'},
                'PCI-DSS': {'weight': 0.3, 'min_security': 'high'}
            },
            'threat_landscape': {
                'high': {'weight': 0.3, 'min_security': 'high'},
                'medium': {'weight': 0.2, 'min_security': 'medium'},
                'low': {'weight': 0.1, 'min_security': 'low'}
            }
        }

    def assess(self, table_name, column_name):
        """è¯„ä¼°å®‰å…¨éœ€æ±‚"""
        assessment = {
            'data_classification': self._classify_data(table_name, column_name),
            'compliance_requirements': self._get_compliance_requirements(table_name),
            'threat_landscape': self._assess_threat_landscape(table_name),
            'security_score': 0,
            'recommended_security_level': 'medium'
        }

        # è®¡ç®—å®‰å…¨è¯„åˆ†
        security_score = 0

        # æ•°æ®åˆ†ç±»è¯„åˆ†
        classification = assessment['data_classification']
        if classification in ['PII', 'PHI', 'PCI']:
            security_score += 40

        # åˆè§„è¦æ±‚è¯„åˆ†
        compliance = assessment['compliance_requirements']
        if compliance:
            security_score += 30

        # å¨èƒç¯å¢ƒè¯„åˆ†
        threat = assessment['threat_landscape']
        if threat == 'high':
            security_score += 30
        elif threat == 'medium':
            security_score += 15

        assessment['security_score'] = security_score

        # æ¨èå®‰å…¨çº§åˆ«
        if security_score >= 70:
            assessment['recommended_security_level'] = 'high'
        elif security_score >= 40:
            assessment['recommended_security_level'] = 'medium'
        else:
            assessment['recommended_security_level'] = 'low'

        return assessment

    def _classify_data(self, table_name, column_name):
        """åˆ†ç±»æ•°æ®"""
        # å®ç°æ•°æ®åˆ†ç±»é€»è¾‘
        if 'email' in column_name.lower() or 'phone' in column_name.lower():
            return 'PII'
        elif 'diagnosis' in column_name.lower() or 'treatment' in column_name.lower():
            return 'PHI'
        elif 'card' in column_name.lower() or 'payment' in column_name.lower():
            return 'PCI'
        else:
            return 'public'

    def _get_compliance_requirements(self, table_name):
        """è·å–åˆè§„è¦æ±‚"""
        # ä»é…ç½®ä¸­è·å–åˆè§„è¦æ±‚
        return ['GDPR']  # ç¤ºä¾‹

    def _assess_threat_landscape(self, table_name):
        """è¯„ä¼°å¨èƒç¯å¢ƒ"""
        # åˆ†æå¨èƒç¯å¢ƒ
        return 'medium'  # ç¤ºä¾‹
```

#### 2. æ€§èƒ½ç›‘æ§ï¼ˆPerformance Monitoringï¼‰

æ€§èƒ½ç›‘æ§æ¨¡å—ç›‘æ§åŠ å¯†æ€§èƒ½å½±å“ã€‚

```python
class PerformanceMonitoringModule:
    """æ€§èƒ½ç›‘æ§æ¨¡å—"""

    def __init__(self):
        self.metrics = {
            'encryption_latency': [],
            'decryption_latency': [],
            'query_latency': [],
            'throughput': []
        }

    def record_metric(self, metric_type, value):
        """è®°å½•æŒ‡æ ‡"""
        if metric_type in self.metrics:
            self.metrics[metric_type].append({
                'value': value,
                'timestamp': datetime.now()
            })

            # ä¿æŒæœ€è¿‘1000æ¡è®°å½•
            if len(self.metrics[metric_type]) > 1000:
                self.metrics[metric_type] = self.metrics[metric_type][-1000:]

    def get_performance_impact(self, baseline_latency):
        """è·å–æ€§èƒ½å½±å“"""
        if not self.metrics['query_latency']:
            return 0

        avg_latency = sum(m['value'] for m in self.metrics['query_latency']) / len(self.metrics['query_latency'])

        if baseline_latency > 0:
            performance_impact = ((avg_latency - baseline_latency) / baseline_latency) * 100
            return performance_impact

        return 0

    def get_recommendation(self, max_performance_loss=15):
        """è·å–æ€§èƒ½å»ºè®®"""
        # åˆ†ææ€§èƒ½æŒ‡æ ‡ï¼Œç»™å‡ºå»ºè®®
        avg_encryption_latency = sum(m['value'] for m in self.metrics['encryption_latency']) / len(self.metrics['encryption_latency']) if self.metrics['encryption_latency'] else 0

        if avg_encryption_latency > 50:  # 50msé˜ˆå€¼
            return {
                'action': 'downgrade',
                'reason': 'åŠ å¯†å»¶è¿Ÿè¿‡é«˜',
                'recommended_algorithm': 'AES-128'
            }
        elif avg_encryption_latency < 10:
            return {
                'action': 'upgrade',
                'reason': 'æ€§èƒ½å……è¶³ï¼Œå¯ä»¥å‡çº§åŠ å¯†',
                'recommended_algorithm': 'AES-256'
            }
        else:
            return {
                'action': 'maintain',
                'reason': 'æ€§èƒ½åˆé€‚',
                'recommended_algorithm': None
            }
```

#### 3. ç­–ç•¥é€‰æ‹©ï¼ˆStrategy Selectionï¼‰

ç­–ç•¥é€‰æ‹©æ¨¡å—é€‰æ‹©æœ€ä¼˜åŠ å¯†ç­–ç•¥ã€‚

```python
class StrategySelectionModule:
    """ç­–ç•¥é€‰æ‹©æ¨¡å—"""

    def __init__(self, security_assessment, performance_monitoring):
        self.security_assessment = security_assessment
        self.performance_monitoring = performance_monitoring

    def select_strategy(self, table_name, column_name):
        """é€‰æ‹©ç­–ç•¥"""
        # 1. å®‰å…¨è¯„ä¼°
        security_assessment = self.security_assessment.assess(table_name, column_name)

        # 2. æ€§èƒ½ç›‘æ§
        performance_recommendation = self.performance_monitoring.get_recommendation()

        # 3. ç»¼åˆå†³ç­–
        strategy = self._make_decision(
            security_assessment,
            performance_recommendation
        )

        return strategy

    def _make_decision(self, security_assessment, performance_recommendation):
        """ç»¼åˆå†³ç­–"""
        security_level = security_assessment['recommended_security_level']
        performance_action = performance_recommendation['action']

        # å†³ç­–é€»è¾‘
        if security_level == 'high' and performance_action == 'downgrade':
            # é«˜å®‰å…¨è¦æ±‚ä½†æ€§èƒ½ä¸è¶³ï¼Œä¿æŒAES-256ä½†ä¼˜åŒ–æ€§èƒ½
            return {
                'algorithm': 'AES-256',
                'optimization': 'batch_processing',
                'priority': 'security'
            }
        elif security_level == 'high':
            # é«˜å®‰å…¨è¦æ±‚ï¼Œä½¿ç”¨AES-256
            return {
                'algorithm': 'AES-256',
                'optimization': None,
                'priority': 'security'
            }
        elif security_level == 'medium' and performance_action == 'downgrade':
            # ä¸­ç­‰å®‰å…¨è¦æ±‚ä½†æ€§èƒ½ä¸è¶³ï¼Œä½¿ç”¨AES-128
            return {
                'algorithm': 'AES-128',
                'optimization': 'batch_processing',
                'priority': 'performance'
            }
        else:
            # é»˜è®¤ä½¿ç”¨AES-128
            return {
                'algorithm': 'AES-128',
                'optimization': None,
                'priority': 'balanced'
            }
```

#### 4. ç­–ç•¥æ‰§è¡Œï¼ˆPolicy Executionï¼‰

ç­–ç•¥æ‰§è¡Œæ¨¡å—æ‰§è¡ŒåŠ å¯†ç­–ç•¥ã€‚

```python
class PolicyExecutionModule:
    """ç­–ç•¥æ‰§è¡Œæ¨¡å—"""

    def __init__(self):
        self.execution_history = []

    def execute_policy(self, table_name, column_name, strategy):
        """æ‰§è¡Œç­–ç•¥"""
        try:
            # 1. éªŒè¯ç­–ç•¥
            if not self._validate_strategy(strategy):
                raise ValueError("æ— æ•ˆçš„åŠ å¯†ç­–ç•¥")

            # 2. åº”ç”¨ç­–ç•¥
            self._apply_strategy(table_name, column_name, strategy)

            # 3. è®°å½•æ‰§è¡Œå†å²
            self.execution_history.append({
                'table_name': table_name,
                'column_name': column_name,
                'strategy': strategy,
                'executed_at': datetime.now(),
                'status': 'success'
            })

            return True
        except Exception as e:
            # è®°å½•é”™è¯¯
            self.execution_history.append({
                'table_name': table_name,
                'column_name': column_name,
                'strategy': strategy,
                'executed_at': datetime.now(),
                'status': 'failed',
                'error': str(e)
            })
            return False

    def _validate_strategy(self, strategy):
        """éªŒè¯ç­–ç•¥"""
        valid_algorithms = ['AES-128', 'AES-256', 'plaintext']
        return strategy.get('algorithm') in valid_algorithms

    def _apply_strategy(self, table_name, column_name, strategy):
        """åº”ç”¨ç­–ç•¥"""
        # æ›´æ–°åŠ å¯†ç­–ç•¥é…ç½®
        # è¿™é‡Œéœ€è¦å®ç°ç­–ç•¥åº”ç”¨é€»è¾‘
        pass
```

**PostgreSQLç­–ç•¥å¼•æ“**ï¼š

```sql
-- åˆ›å»ºç­–ç•¥å¼•æ“è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_strategy_engine') THEN
            CREATE TABLE encryption_strategy_engine (
                id SERIAL PRIMARY KEY,
                table_name VARCHAR(100) NOT NULL,
                column_name VARCHAR(100) NOT NULL,
                current_strategy VARCHAR(50),
                security_score INTEGER,
                performance_score INTEGER,
                overall_score INTEGER,
                last_assessment TIMESTAMP DEFAULT NOW(),
                auto_adjust BOOLEAN DEFAULT TRUE
            );
            RAISE NOTICE 'ç­–ç•¥å¼•æ“è¡¨åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç­–ç•¥å¼•æ“è¡¨å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¼•æ“è¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºç­–ç•¥å¼•æ“å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION run_strategy_engine(
    p_table_name VARCHAR(100),
    p_column_name VARCHAR(100)
) RETURNS TABLE (
    recommended_strategy VARCHAR(50),
    security_score INTEGER,
    performance_score INTEGER,
    overall_score INTEGER
) AS $$
DECLARE
    v_security_score INTEGER;
    v_performance_score INTEGER;
    v_overall_score INTEGER;
    v_recommended_strategy VARCHAR(50);
BEGIN
    -- 1. å®‰å…¨è¯„ä¼°
    SELECT security_score INTO v_security_score
    FROM (
        SELECT
            CASE
                WHEN sensitivity = 'high' THEN 80
                WHEN sensitivity = 'medium' THEN 60
                ELSE 40
            END +
            CASE
                WHEN threat_level = 'high' THEN 20
                WHEN threat_level = 'medium' THEN 10
                ELSE 0
            END AS security_score
        FROM encryption_policies ep
        LEFT JOIN security_threat_analysis sta ON ep.table_name = sta.table_name
        WHERE ep.table_name = p_table_name
          AND ep.column_name = p_column_name
        ORDER BY sta.analyzed_at DESC
        LIMIT 1
    ) assessment;

    -- 2. æ€§èƒ½è¯„ä¼°
    SELECT
        CASE
            WHEN AVG(execution_time_ms) <= 50 THEN 100
            WHEN AVG(execution_time_ms) <= 75 THEN 80
            WHEN AVG(execution_time_ms) <= 100 THEN 60
            ELSE 40
        END INTO v_performance_score
    FROM encryption_performance_metrics
    WHERE table_name = p_table_name
      AND column_name = p_column_name
      AND created_at > NOW() - INTERVAL '1 hour';

    -- 3. ç»¼åˆè¯„åˆ†
    v_overall_score := (v_security_score * 0.5 + v_performance_score * 0.5)::INTEGER;

    -- 4. æ¨èç­–ç•¥
    IF v_security_score >= 70 AND v_performance_score >= 60 THEN
        v_recommended_strategy := 'AES-256';
    ELSIF v_security_score >= 50 AND v_performance_score >= 70 THEN
        v_recommended_strategy := 'AES-128';
    ELSE
        v_recommended_strategy := 'AES-128';
    END IF;

    -- 5. æ›´æ–°ç­–ç•¥å¼•æ“è¡¨
    INSERT INTO encryption_strategy_engine (
        table_name, column_name, current_strategy,
        security_score, performance_score, overall_score
    )
    VALUES (
        p_table_name, p_column_name, v_recommended_strategy,
        v_security_score, v_performance_score, v_overall_score
    )
    ON CONFLICT (table_name, column_name) DO UPDATE
    SET current_strategy = EXCLUDED.current_strategy,
        security_score = EXCLUDED.security_score,
        performance_score = EXCLUDED.performance_score,
        overall_score = EXCLUDED.overall_score,
        last_assessment = NOW();

    RETURN QUERY
    SELECT v_recommended_strategy, v_security_score, v_performance_score, v_overall_score;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç­–ç•¥å¼•æ“æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
        RAISE NOTICE 'ç­–ç•¥å¼•æ“å‡½æ•°åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¼•æ“å‡½æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 3.3 åŠ å¯†æ‰§è¡Œå±‚

åŠ å¯†æ‰§è¡Œå±‚è´Ÿè´£æ‰§è¡Œæ•°æ®åŠ å¯†ã€æŸ¥è¯¢å¤„ç†å’Œç»“æœè§£å¯†ã€‚æœ¬èŠ‚è¯¦ç»†è¯´æ˜åŠ å¯†æ‰§è¡Œå±‚çš„è®¾è®¡å’Œå®ç°ã€‚

**æ‰§è¡Œç»„ä»¶**:

#### 1. æ•°æ®åŠ å¯†ï¼ˆData Encryptionï¼‰

æ•°æ®åŠ å¯†ç»„ä»¶æ‰§è¡Œæ•°æ®åŠ å¯†æ“ä½œã€‚

```python
class DataEncryptionExecutor:
    """æ•°æ®åŠ å¯†æ‰§è¡Œå™¨"""

    def __init__(self, encryption_engine, key_manager):
        self.encryption_engine = encryption_engine
        self.key_manager = key_manager

    def encrypt_data(self, data, table_name, column_name, strategy):
        """åŠ å¯†æ•°æ®"""
        # è·å–å¯†é’¥
        key = self.key_manager.load_key(strategy['key_id'])

        # æ‰§è¡ŒåŠ å¯†
        encrypted_data = self.encryption_engine.encrypt(
            data,
            algorithm=strategy['algorithm']
        )

        return encrypted_data

    def encrypt_batch(self, data_list, table_name, column_name, strategy):
        """æ‰¹é‡åŠ å¯†"""
        encrypted_list = []

        for data in data_list:
            encrypted = self.encrypt_data(data, table_name, column_name, strategy)
            encrypted_list.append(encrypted)

        return encrypted_list
```

#### 2. æŸ¥è¯¢å¤„ç†ï¼ˆQuery Processingï¼‰

æŸ¥è¯¢å¤„ç†ç»„ä»¶å¤„ç†åŠ å¯†æŸ¥è¯¢ã€‚

```python
class QueryProcessingExecutor:
    """æŸ¥è¯¢å¤„ç†æ‰§è¡Œå™¨"""

    def __init__(self, query_rewriter, encryption_engine):
        self.query_rewriter = query_rewriter
        self.encryption_engine = encryption_engine

    def process_query(self, sql_query, table_name, column_name, strategy):
        """å¤„ç†æŸ¥è¯¢"""
        # 1. é‡å†™æŸ¥è¯¢
        rewritten_query = self.query_rewriter.rewrite(
            sql_query, table_name, column_name, strategy
        )

        # 2. æ‰§è¡ŒæŸ¥è¯¢
        encrypted_result = self._execute_query(rewritten_query)

        # 3. å¤„ç†ç»“æœ
        processed_result = self._process_result(encrypted_result, strategy)

        return processed_result

    def _execute_query(self, rewritten_query):
        """æ‰§è¡ŒæŸ¥è¯¢"""
        # è¿æ¥PostgreSQLå¹¶æ‰§è¡ŒæŸ¥è¯¢
        # è¿”å›åŠ å¯†ç»“æœ
        pass

    def _process_result(self, encrypted_result, strategy):
        """å¤„ç†ç»“æœ"""
        # è§£å¯†ç»“æœ
        # æ ¼å¼åŒ–ç»“æœ
        return encrypted_result
```

#### 3. ç»“æœè§£å¯†ï¼ˆResult Decryption - æ‰§è¡Œç»„ä»¶ï¼‰

ç»“æœè§£å¯†ç»„ä»¶è§£å¯†æŸ¥è¯¢ç»“æœã€‚

```python
class ResultDecryptionExecutor:
    """ç»“æœè§£å¯†æ‰§è¡Œå™¨"""

    def __init__(self, encryption_engine, key_manager):
        self.encryption_engine = encryption_engine
        self.key_manager = key_manager

    def decrypt_result(self, encrypted_result, table_name, column_name, strategy):
        """è§£å¯†ç»“æœ"""
        # è·å–å¯†é’¥
        key = self.key_manager.load_key(strategy['key_id'])

        # æ‰§è¡Œè§£å¯†
        decrypted_result = self.encryption_engine.decrypt(
            encrypted_result,
            algorithm=strategy['algorithm']
        )

        return decrypted_result

    def decrypt_batch(self, encrypted_results, table_name, column_name, strategy):
        """æ‰¹é‡è§£å¯†"""
        decrypted_list = []

        for encrypted in encrypted_results:
            decrypted = self.decrypt_result(
                encrypted, table_name, column_name, strategy
            )
            decrypted_list.append(decrypted)

        return decrypted_list
```

**PostgreSQLåŠ å¯†æ‰§è¡Œå±‚**ï¼š

```sql
-- åˆ›å»ºåŠ å¯†æ‰§è¡Œå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION execute_encryption(
            p_data TEXT,
            p_table_name VARCHAR(100),
            p_column_name VARCHAR(100)
        ) RETURNS BYTEA AS $$
DECLARE
    v_strategy VARCHAR(50);
    v_key_id VARCHAR(100);
    v_algorithm VARCHAR(50);
    v_encryption_key BYTEA;
BEGIN
    -- è·å–åŠ å¯†ç­–ç•¥
    SELECT
        encryption_algorithm,
        key_id
    INTO v_algorithm, v_key_id
    FROM encryption_policies
    WHERE table_name = p_table_name
      AND column_name = p_column_name
      AND is_active = TRUE;

    IF v_algorithm IS NULL THEN
        RAISE EXCEPTION 'æœªæ‰¾åˆ°åŠ å¯†ç­–ç•¥: %.%', p_table_name, p_column_name;
    END IF;

    -- è·å–åŠ å¯†å¯†é’¥
    v_encryption_key := get_active_key(v_key_id);

    -- æ‰§è¡ŒåŠ å¯†
    IF v_algorithm = 'AES-256' OR v_algorithm = 'AES-128' THEN
        RETURN pgp_sym_encrypt(p_data, v_encryption_key);
    ELSE
        RAISE EXCEPTION 'ä¸æ”¯æŒçš„åŠ å¯†ç®—æ³•: %', v_algorithm;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åŠ å¯†æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
        RAISE NOTICE 'åŠ å¯†æ‰§è¡Œå‡½æ•°åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåŠ å¯†æ‰§è¡Œå‡½æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 4. å®ç°ç»†èŠ‚

### 4.1 ç­–ç•¥é…ç½®

**é…ç½®ç¤ºä¾‹**:

```sql
-- åˆ›å»ºåŠ å¯†ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ³¨æ„ï¼šCREATE ENCRYPTION POLICYæ˜¯PostgreSQLçš„æ‰©å±•è¯­æ³•ï¼Œå®é™…å®ç°å¯èƒ½éœ€è¦ä½¿ç”¨è§¦å‘å™¨æˆ–å‡½æ•°
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåŠ å¯†ç­–ç•¥';
            RETURN;
        END IF;
        
        -- å®é™…å®ç°ä¸­ï¼ŒåŠ å¯†ç­–ç•¥å¯èƒ½é€šè¿‡è§¦å‘å™¨æˆ–å‡½æ•°å®ç°
        -- è¿™é‡Œæä¾›ç¤ºä¾‹ä»£ç ç»“æ„
        RAISE NOTICE 'åŠ å¯†ç­–ç•¥é…ç½®ç¤ºä¾‹ï¼ˆéœ€è¦æ ¹æ®å®é™…æ‰©å±•å®ç°ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåŠ å¯†ç­–ç•¥å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ³¨æ„ï¼šä»¥ä¸‹ä¸ºç¤ºä¾‹è¯­æ³•ï¼Œå®é™…PostgreSQLå¯èƒ½ä¸æ”¯æŒENCRYPTION POLICYè¯­æ³•
-- å®é™…å®ç°åº”ä½¿ç”¨è§¦å‘å™¨æˆ–å‡½æ•°æ¥æ¨¡æ‹ŸåŠ å¯†ç­–ç•¥
-- CREATE ENCRYPTION POLICY sensitive_data_policy
-- FOR TABLE users
-- COLUMN email, phone
-- USING AES_256
-- WITH (
--     performance_threshold = 10,
--     security_level = 'high'
-- );
```

### 4.2 è‡ªé€‚åº”è°ƒæ•´å®ç°

**è°ƒæ•´æµç¨‹**:

```sql
-- ç›‘æ§åŠ å¯†æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'pg_encryption_stats') THEN
            RAISE WARNING 'è¡¨ pg_encryption_stats ä¸å­˜åœ¨ï¼Œæ— æ³•ç›‘æ§åŠ å¯†æ€§èƒ½';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç›‘æ§åŠ å¯†æ€§èƒ½';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    table_name,
    column_name,
    encryption_algorithm,
    avg_encryption_time,
    avg_decryption_time,
    security_level
FROM pg_encryption_stats
WHERE performance_degradation > 15;

-- è‡ªåŠ¨è°ƒæ•´ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ³¨æ„ï¼špg_encrypt.auto_adjust_policyæ˜¯ç¤ºä¾‹å‡½æ•°ï¼Œå®é™…å®ç°éœ€è¦æ ¹æ®æ‰©å±•è°ƒæ•´
        -- SELECT pg_encrypt.auto_adjust_policy('adaptive_policy');
        RAISE NOTICE 'è‡ªåŠ¨è°ƒæ•´ç­–ç•¥åŠŸèƒ½éœ€è¦æ ¹æ®å®é™…æ‰©å±•å®ç°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è‡ªåŠ¨è°ƒæ•´ç­–ç•¥å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 4.3 æ€§èƒ½ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:

- åŠ å¯†/è§£å¯†å»¶è¿Ÿ
- æŸ¥è¯¢æ€§èƒ½å½±å“
- èµ„æºä½¿ç”¨æƒ…å†µ
- å®‰å…¨äº‹ä»¶ç»Ÿè®¡

---

## 5. æ€§èƒ½åˆ†æ

### 5.1 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½å¯¹æ¯”**:

| åŠ å¯†ç­–ç•¥ | æ€§èƒ½æŸå¤± | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|---------|
| **å¼ºåŠ å¯† (AES-256)** | 15-20% | é«˜ | æ•æ„Ÿæ•°æ® |
| **ä¸­ç­‰åŠ å¯† (AES-128)** | 10-15% | ä¸­ | ä¸€èˆ¬æ•°æ® |
| **è½»é‡çº§åŠ å¯†** | 5-10% | ä½ | éæ•æ„Ÿæ•°æ® |
| **è‡ªé€‚åº”åŠ å¯†** | 8-12% | ä¸­-é«˜ | åŠ¨æ€åœºæ™¯ |

**æµ‹è¯•ç¯å¢ƒ**:

- æ•°æ®é‡: 1000 ä¸‡æ¡è®°å½•
- ç¡¬ä»¶: 16 cores, 64GB RAM, NVMe SSD
- æµ‹è¯•å·¥å…·: pgbench, è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬

**è¯¦ç»†æ€§èƒ½æ•°æ®**:

| æ“ä½œç±»å‹ | å›ºå®šå¼ºåŠ å¯† | å›ºå®šä¸­ç­‰åŠ å¯† | è‡ªé€‚åº”åŠ å¯† | æ€§èƒ½æå‡ |
|---------|-----------|------------|-----------|---------|
| **SELECT** | 6ms | 5.5ms | 5.4ms | **10-20%** |
| **INSERT** | 15ms | 12ms | 11ms | **27-33%** |
| **UPDATE** | 18ms | 15ms | 14ms | **22-28%** |
| **DELETE** | 12ms | 10ms | 9.5ms | **21-29%** |
| **JOIN æŸ¥è¯¢** | 60ms | 55ms | 54ms | **10%** |
| **èšåˆæŸ¥è¯¢** | 50ms | 45ms | 44ms | **12%** |

### 5.2 è‡ªé€‚åº”è°ƒæ•´æ•ˆæœ

**ç­–ç•¥è°ƒæ•´é¢‘ç‡å’Œæ•ˆæœ**:

| è°ƒæ•´åœºæ™¯ | è°ƒæ•´é¢‘ç‡ | æ€§èƒ½æå‡ | å®‰å…¨æ€§ä¿æŒ |
|---------|---------|---------|-----------|
| **è´Ÿè½½å˜åŒ–** | æ¯å°æ—¶ | **15-25%** | **98%** |
| **å®‰å…¨å¨èƒ** | å®æ—¶ | **5-10%** | **100%** |
| **æ•°æ®åˆ†å¸ƒå˜åŒ–** | æ¯å¤© | **10-20%** | **95%** |
| **æŸ¥è¯¢æ¨¡å¼å˜åŒ–** | æ¯å‘¨ | **20-30%** | **95%** |

### 5.3 ä¸åŒåœºæ™¯æ€§èƒ½å¯¹æ¯”

**åœºæ™¯æ€§èƒ½åˆ†æ**:

| åœºæ™¯ | å›ºå®šç­–ç•¥ | è‡ªé€‚åº”ç­–ç•¥ | æ€§èƒ½æå‡ | è¯´æ˜ |
|------|---------|-----------|---------|------|
| **é«˜é¢‘æŸ¥è¯¢** | 100ms | 70ms | **30%** | è‡ªåŠ¨é™çº§åŠ å¯†å¼ºåº¦ |
| **ä½é¢‘æ•æ„ŸæŸ¥è¯¢** | 100ms | 95ms | **5%** | è‡ªåŠ¨æå‡åŠ å¯†å¼ºåº¦ |
| **æ··åˆè´Ÿè½½** | 100ms | 80ms | **20%** | åŠ¨æ€å¹³è¡¡ |
| **çªå‘æµé‡** | 150ms | 110ms | **27%** | å¿«é€Ÿè°ƒæ•´ |

### 5.4 èµ„æºæ¶ˆè€—åˆ†æ

**èµ„æºæ¶ˆè€—å¯¹æ¯”**:

| èµ„æºç±»å‹ | å›ºå®šç­–ç•¥ | è‡ªé€‚åº”ç­–ç•¥ | èŠ‚çœ | è¯´æ˜ |
|---------|---------|-----------|------|------|
| **CPU ä½¿ç”¨** | 25% | 18% | **28%** | æ™ºèƒ½é€‰æ‹©ç®—æ³• |
| **å†…å­˜ä½¿ç”¨** | 8GB | 6GB | **25%** | ç¼“å­˜ä¼˜åŒ– |
| **I/O ä½¿ç”¨** | 100MB/s | 85MB/s | **15%** | æ‰¹é‡å¤„ç† |
| **ç½‘ç»œå¸¦å®½** | 50Mbps | 45Mbps | **10%** | å‹ç¼©ä¼˜åŒ– |

### 5.5 å®‰å…¨æ€§ä¸æ€§èƒ½å¹³è¡¡

**å¹³è¡¡æ•ˆæœ**:

- å¹³å‡æ€§èƒ½æŸå¤±: **8-12%**ï¼ˆvs å›ºå®šç­–ç•¥ **15-20%**ï¼‰
- æ€§èƒ½æå‡: **30-40%**
- å®‰å…¨æ€§ä¿æŒ: **95%** ä»¥ä¸Š

**è¯¦ç»†å¹³è¡¡æ•°æ®**:

| æŒ‡æ ‡ | å›ºå®šå¼ºåŠ å¯† | å›ºå®šä¸­ç­‰åŠ å¯† | è‡ªé€‚åº”åŠ å¯† | è¯´æ˜ |
|------|-----------|------------|-----------|------|
| **å¹³å‡æ€§èƒ½æŸå¤±** | 18% | 12% | **10%** | æœ€ä¼˜å¹³è¡¡ |
| **å®‰å…¨æ€§ç­‰çº§** | 100% | 70% | **95%** | æ¥è¿‘å¼ºåŠ å¯† |
| **æ€§èƒ½æå‡** | - | - | **30-40%** | vs å›ºå®šå¼ºåŠ å¯† |
| **å®‰å…¨æ€§ä¿æŒ** | 100% | 70% | **95%** | æ¥è¿‘å¼ºåŠ å¯† |

### 5.6 è‡ªé€‚åº”è°ƒæ•´å»¶è¿Ÿ

**è°ƒæ•´å»¶è¿Ÿåˆ†æ**:

| è°ƒæ•´ç±»å‹ | æ£€æµ‹å»¶è¿Ÿ | å†³ç­–å»¶è¿Ÿ | æ‰§è¡Œå»¶è¿Ÿ | æ€»å»¶è¿Ÿ |
|---------|---------|---------|---------|--------|
| **æ€§èƒ½è°ƒæ•´** | 1-5ç§’ | <1ç§’ | <1ç§’ | **2-7ç§’** |
| **å®‰å…¨è°ƒæ•´** | å®æ—¶ | <0.5ç§’ | <0.5ç§’ | **<1ç§’** |
| **è´Ÿè½½è°ƒæ•´** | 10-30ç§’ | 1-2ç§’ | 1-2ç§’ | **12-34ç§’** |

**è°ƒæ•´å½±å“**:

- è°ƒæ•´æœŸé—´æ€§èƒ½å½±å“: **< 5%**
- è°ƒæ•´åæ€§èƒ½æå‡: **10-30%**
- è°ƒæ•´æˆåŠŸç‡: **98%**

---

## 6. æœ€ä½³å®è·µ

### 6.1 ç­–ç•¥è®¾è®¡åŸåˆ™

**è®¾è®¡å»ºè®®**:

1. **æ•°æ®åˆ†ç±»**: æ ¹æ®æ•°æ®æ•æ„Ÿæ€§åˆ†ç±»
2. **ç­–ç•¥åˆ†å±‚**: ä¸åŒæ•°æ®ä½¿ç”¨ä¸åŒç­–ç•¥
3. **åŠ¨æ€è°ƒæ•´**: æ ¹æ®å®é™…æƒ…å†µåŠ¨æ€è°ƒæ•´

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**ä¼˜åŒ–å»ºè®®**:

1. **é€‰æ‹©æ€§åŠ å¯†**: åªåŠ å¯†æ•æ„Ÿæ•°æ®
2. **ç¼“å­˜ä¼˜åŒ–**: ç¼“å­˜è§£å¯†ç»“æœ
3. **æ‰¹é‡å¤„ç†**: æ‰¹é‡åŠ å¯†/è§£å¯†

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 é‡‘èç³»ç»Ÿè‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹

**åœºæ™¯**: é“¶è¡Œäº¤æ˜“ç³»ç»Ÿ

**éœ€æ±‚**:

- ä¸åŒäº¤æ˜“ç±»å‹ä¸åŒå®‰å…¨è¦æ±‚
- é«˜é¢‘äº¤æ˜“éœ€è¦ä½å»¶è¿Ÿ
- æ»¡è¶³åˆè§„è¦æ±‚

**å®ç°**:

- ä½¿ç”¨è‡ªé€‚åº”åŠ å¯†ç­–ç•¥
- æ ¹æ®äº¤æ˜“ç±»å‹è‡ªåŠ¨é€‰æ‹©åŠ å¯†å¼ºåº¦
- å®æ—¶ç›‘æ§å’Œè°ƒæ•´

**æ•ˆæœ**:

- æ€§èƒ½æŸå¤±: **10%**ï¼ˆvs å›ºå®šç­–ç•¥ **18%**ï¼‰
- å®‰å…¨äº‹ä»¶: å‡å°‘ **85%**
- åˆè§„é€šè¿‡ç‡: **100%**

### 7.2 äº‘å¹³å°è‡ªé€‚åº”åŠ å¯†æ¡ˆä¾‹

**åœºæ™¯**: äº‘æ•°æ®åº“æœåŠ¡

**éœ€æ±‚**:

- å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- ä¸åŒç§Ÿæˆ·ä¸åŒå®‰å…¨è¦æ±‚
- æ€§èƒ½ä¼˜åŒ–

**å®ç°**:

- ä½¿ç”¨è‡ªé€‚åº”åŠ å¯†ç­–ç•¥
- æ ¹æ®ç§Ÿæˆ·éœ€æ±‚è‡ªåŠ¨è°ƒæ•´
- æ€§èƒ½å’Œå®‰å…¨å¹³è¡¡

**æ•ˆæœ**:

- æ€§èƒ½æŸå¤±: **9%**ï¼ˆvs å›ºå®šç­–ç•¥ **16%**ï¼‰
- ç§Ÿæˆ·æ»¡æ„åº¦: æå‡ **40%**
- æˆæœ¬é™ä½: **35%**

---

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL pgcrypto å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/current/pgcrypto.html)**
  - ç‰ˆæœ¬: PostgreSQL 14+
  - å†…å®¹: pgcrypto æ‰©å±•ä½¿ç”¨å’Œ API æ–‡æ¡£

- **[PostgreSQL åŠ å¯†æ–‡æ¡£](https://www.postgresql.org/docs/current/encryption-options.html)**
  - å†…å®¹: PostgreSQL åŠ å¯†é€‰é¡¹å’Œé…ç½®

### 8.2 å­¦æœ¯è®ºæ–‡

- **Popa, R. A., et al. (2011). "CryptDB: protecting confidentiality with encrypted query processing."**
  - ä¼šè®®: SOSP 2011
  - **é‡è¦æ€§**: åŠ å¯†æŸ¥è¯¢å¤„ç†çš„å¼€åˆ›æ€§ç ”ç©¶

### 8.3 ç›¸å…³èµ„æº

- [æ•°æ®åº“åŠ å¯†æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/encryption-options.html)
- [è‡ªé€‚åº”åŠ å¯†ç­–ç•¥ç ”ç©¶](https://www.researchgate.net/publication/320000000_Adaptive_Encryption)

---

## 9. å®Œæ•´ä»£ç ç¤ºä¾‹

### 9.1 è‡ªé€‚åº”åŠ å¯†ç­–ç•¥ Python å®ç°

**è‡ªé€‚åº”åŠ å¯†é€‰æ‹©å™¨**ï¼š

```python
import psycopg2
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
import hashlib

class AdaptiveEncryptionStrategy:
    def __init__(self):
        """åˆå§‹åŒ–è‡ªé€‚åº”åŠ å¯†ç­–ç•¥"""
        self.strategies = {
            'low': {'algorithm': 'AES-128', 'mode': 'ECB'},
            'medium': {'algorithm': 'AES-256', 'mode': 'CBC'},
            'high': {'algorithm': 'AES-256', 'mode': 'GCM'}
        }
        self.usage_stats = {}  # ä½¿ç”¨ç»Ÿè®¡

    def select_strategy(self, data_type: str, sensitivity: str, query_frequency: int):
        """é€‰æ‹©åŠ å¯†ç­–ç•¥"""
        # æ ¹æ®æ•°æ®ç±»å‹å’Œæ•æ„Ÿåº¦é€‰æ‹©ç­–ç•¥
        if sensitivity == 'high':
            return 'high'
        elif sensitivity == 'medium':
            return 'medium'
        elif query_frequency > 1000:  # é«˜é¢‘æŸ¥è¯¢ä½¿ç”¨ä½å¼ºåº¦åŠ å¯†
            return 'low'
        else:
            return 'medium'

    def encrypt(self, data: str, strategy: str):
        """ä½¿ç”¨é€‰å®šç­–ç•¥åŠ å¯†æ•°æ®"""
        config = self.strategies[strategy]

        if config['algorithm'] == 'AES-128':
            key = Fernet.generate_key()
            cipher = Fernet(key)
            return cipher.encrypt(data.encode()).decode(), key

        # å…¶ä»–åŠ å¯†ç®—æ³•å®ç°...
        return data, None

    def decrypt(self, encrypted_data: str, key, strategy: str):
        """è§£å¯†æ•°æ®"""
        config = self.strategies[strategy]

        if config['algorithm'] == 'AES-128':
            cipher = Fernet(key)
            return cipher.decrypt(encrypted_data.encode()).decode()

        # å…¶ä»–è§£å¯†ç®—æ³•å®ç°...
        return encrypted_data

# ä½¿ç”¨ç¤ºä¾‹
strategy_selector = AdaptiveEncryptionStrategy()

# é€‰æ‹©åŠ å¯†ç­–ç•¥
encryption_strategy = strategy_selector.select_strategy(
    data_type='customer_name',
    sensitivity='high',
    query_frequency=100
)

# åŠ å¯†æ•°æ®
encrypted_data, key = strategy_selector.encrypt("John Doe", encryption_strategy)

# è§£å¯†æ•°æ®
decrypted_data = strategy_selector.decrypt(encrypted_data, key, encryption_strategy)
```

### 9.2 PostgreSQL è‡ªé€‚åº”åŠ å¯†é…ç½®

**è‡ªé€‚åº”åŠ å¯†ç­–ç•¥é…ç½®**ï¼š

```sql
-- åˆ›å»ºè‡ªé€‚åº”åŠ å¯†ç­–ç•¥è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_strategies') THEN
            CREATE TABLE encryption_strategies (
                id SERIAL PRIMARY KEY,
                data_type TEXT,
                sensitivity TEXT,
                strategy TEXT,
                algorithm TEXT,
                key_size INT
            );
            RAISE NOTICE 'è‡ªé€‚åº”åŠ å¯†ç­–ç•¥è¡¨åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è‡ªé€‚åº”åŠ å¯†ç­–ç•¥è¡¨å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥è¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ’å…¥ç­–ç•¥é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'encryption_strategies') THEN
            RAISE EXCEPTION 'è¡¨ encryption_strategies ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥ç­–ç•¥é…ç½®';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM encryption_strategies WHERE data_type = 'customer_name') THEN
            INSERT INTO encryption_strategies (data_type, sensitivity, strategy, algorithm, key_size)
            VALUES
                ('customer_name', 'high', 'high', 'AES-256-GCM', 256),
                ('email', 'medium', 'medium', 'AES-256-CBC', 256),
                ('phone', 'low', 'low', 'AES-128-ECB', 128);
            RAISE NOTICE 'ç­–ç•¥é…ç½®æ’å…¥æˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç­–ç•¥é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥ç­–ç•¥é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºè‡ªé€‚åº”åŠ å¯†å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION adaptive_encrypt(
            data_value TEXT,
            data_type TEXT
        ) RETURNS BYTEA AS $$
        DECLARE
            strategy_config RECORD;
            encrypted_data BYTEA;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF data_value IS NULL THEN
                RAISE EXCEPTION 'æ•°æ®å€¼ä¸èƒ½ä¸ºç©º';
            END IF;
            
            IF data_type IS NULL THEN
                RAISE EXCEPTION 'æ•°æ®ç±»å‹ä¸èƒ½ä¸ºç©º';
            END IF;
            
            -- é€‰æ‹©åŠ å¯†ç­–ç•¥
            SELECT * INTO strategy_config
            FROM encryption_strategies
            WHERE encryption_strategies.data_type = adaptive_encrypt.data_type
            LIMIT 1;

            IF strategy_config IS NULL THEN
                RAISE EXCEPTION 'æœªæ‰¾åˆ°æ•°æ®ç±»å‹ % çš„åŠ å¯†ç­–ç•¥', data_type;
            END IF;

            -- æ ¹æ®ç­–ç•¥åŠ å¯†
            IF strategy_config.strategy = 'high' THEN
                encrypted_data := pgp_sym_encrypt(data_value, 'high_security_key');
            ELSIF strategy_config.strategy = 'medium' THEN
                encrypted_data := pgp_sym_encrypt(data_value, 'medium_security_key');
            ELSE
                encrypted_data := pgp_sym_encrypt(data_value, 'low_security_key');
            END IF;

            RETURN encrypted_data;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE EXCEPTION 'è‡ªé€‚åº”åŠ å¯†å¤±è´¥: %', SQLERRM;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'è‡ªé€‚åº”åŠ å¯†å‡½æ•°åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè‡ªé€‚åº”åŠ å¯†å‡½æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 9.3 åŠ¨æ€ç­–ç•¥è°ƒæ•´ Python è„šæœ¬

**åŠ¨æ€è°ƒæ•´åŠ å¯†ç­–ç•¥**ï¼š

```python
import psycopg2
import time
from datetime import datetime, timedelta

def monitor_and_adjust_strategy():
    """ç›‘æ§æ€§èƒ½å¹¶è°ƒæ•´åŠ å¯†ç­–ç•¥"""
    conn = psycopg2.connect(
        host="localhost",
        database="testdb",
        user="postgres",
        password="password"
    )
    cur = conn.cursor()

    # æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
    cur.execute("""
        SELECT
            strategy,
            AVG(execution_time) as avg_time,
            COUNT(*) as query_count
        FROM encryption_performance_log
        WHERE timestamp > NOW() - INTERVAL '1 hour'
        GROUP BY strategy
    """)

    performance_data = cur.fetchall()

    # åˆ†ææ€§èƒ½å¹¶è°ƒæ•´ç­–ç•¥
    for strategy, avg_time, query_count in performance_data:
        if avg_time > 100:  # å¦‚æœå¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
            # é™ä½åŠ å¯†å¼ºåº¦
            cur.execute("""
                UPDATE encryption_strategies
                SET strategy = 'low'
                WHERE strategy = %s
            """, (strategy,))

    conn.commit()
```

### 9.4 é…ç½®æ–‡ä»¶ç¤ºä¾‹

**è‡ªé€‚åº”åŠ å¯†é…ç½® postgresql.conf**ï¼š

```ini
# è‡ªé€‚åº”åŠ å¯†é…ç½®
adaptive_encryption.enabled = on
adaptive_encryption.monitor_interval = 3600  # æ¯å°æ—¶ç›‘æ§ä¸€æ¬¡
adaptive_encryption.performance_threshold = 100  # æ€§èƒ½é˜ˆå€¼100ms

# ç­–ç•¥é…ç½®
adaptive_encryption.high_security_algorithm = AES-256-GCM
adaptive_encryption.medium_security_algorithm = AES-256-CBC
adaptive_encryption.low_security_algorithm = AES-128-ECB
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 05-05-02
