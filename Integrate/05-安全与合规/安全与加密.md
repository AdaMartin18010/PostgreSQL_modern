---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\07-å®‰å…¨\å®‰å…¨ä¸åŠ å¯†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL å®‰å…¨ä¸åŠ å¯†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-22

## ğŸ“‘ ç›®å½•

- [PostgreSQL å®‰å…¨ä¸åŠ å¯†](#postgresql-å®‰å…¨ä¸åŠ å¯†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 å®‰å…¨ä¸åŠ å¯†å·¥ä½œåŸç†æ¦‚è¿°](#10-å®‰å…¨ä¸åŠ å¯†å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 å®‰å…¨ä¸åŠ å¯†ä½“ç³»æ€ç»´å¯¼å›¾](#14-å®‰å…¨ä¸åŠ å¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. è®¿é—®æ§åˆ¶](#2-è®¿é—®æ§åˆ¶)
    - [2.1 ç”¨æˆ·å’Œè§’è‰²](#21-ç”¨æˆ·å’Œè§’è‰²)
    - [2.2 æƒé™ç®¡ç†](#22-æƒé™ç®¡ç†)
    - [2.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰](#23-è¡Œçº§å®‰å…¨rls)
  - [3. æ•°æ®åŠ å¯†](#3-æ•°æ®åŠ å¯†)
    - [3.1 ä¼ è¾“åŠ å¯†ï¼ˆSSL/TLSï¼‰](#31-ä¼ è¾“åŠ å¯†ssltls)
    - [3.2 å­˜å‚¨åŠ å¯†](#32-å­˜å‚¨åŠ å¯†)
    - [4.2 å®¡è®¡è§¦å‘å™¨](#42-å®¡è®¡è§¦å‘å™¨)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: ä¼ä¸šçº§å®‰å…¨é…ç½®ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-ä¼ä¸šçº§å®‰å…¨é…ç½®çœŸå®æ¡ˆä¾‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 è®¿é—®æ§åˆ¶](#61-è®¿é—®æ§åˆ¶)
    - [6.2 æ•°æ®åŠ å¯†](#62-æ•°æ®åŠ å¯†)
    - [6.3 å®¡è®¡æ—¥å¿—](#63-å®¡è®¡æ—¥å¿—)
  - [7. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#7-å¸¸è§é—®é¢˜faq)
    - [7.1 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜](#71-å®‰å…¨é…ç½®å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•é…ç½®SSL/TLSåŠ å¯†ï¼Ÿ](#q1-å¦‚ä½•é…ç½®ssltlsåŠ å¯†)
      - [Q2: å¦‚ä½•åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Ÿ](#q2-å¦‚ä½•åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 æ¨èåšæ³•](#81-æ¨èåšæ³•)
      - [âœ… å®‰å…¨é…ç½®å»ºè®®](#-å®‰å…¨é…ç½®å»ºè®®)
      - [âœ… æ•°æ®åŠ å¯†å»ºè®®](#-æ•°æ®åŠ å¯†å»ºè®®)
    - [8.2 é¿å…åšæ³•](#82-é¿å…åšæ³•)
      - [âŒ å®‰å…¨åæ¨¡å¼](#-å®‰å…¨åæ¨¡å¼)
    - [8.3 æ€§èƒ½å»ºè®®](#83-æ€§èƒ½å»ºè®®)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [9.1 å®˜æ–¹æ–‡æ¡£](#91-å®˜æ–¹æ–‡æ¡£)
    - [9.2 æŠ€æœ¯è®ºæ–‡](#92-æŠ€æœ¯è®ºæ–‡)
    - [9.3 æŠ€æœ¯åšå®¢](#93-æŠ€æœ¯åšå®¢)
    - [9.4 ç¤¾åŒºèµ„æº](#94-ç¤¾åŒºèµ„æº)
    - [9.5 ç›¸å…³æ–‡æ¡£](#95-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 å®‰å…¨ä¸åŠ å¯†å·¥ä½œåŸç†æ¦‚è¿°

**å®‰å…¨ä½“ç³»æ¶æ„**ï¼š

PostgreSQL å®‰å…¨ä½“ç³»åŒ…æ‹¬èº«ä»½è®¤è¯ã€è®¿é—®æ§åˆ¶ã€æ•°æ®åŠ å¯†ã€å®¡è®¡æ—¥å¿—ç­‰å¤šä¸ªå±‚æ¬¡ï¼Œå½¢æˆçºµæ·±é˜²å¾¡ä½“ç³»ã€‚

**èº«ä»½è®¤è¯æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¿æ¥] --> B[è¯»å–pg_hba.conf]
    B --> C{è®¤è¯æ–¹æ³•}
    C -->|trust| D[ç›´æ¥å…è®¸]
    C -->|md5| E[MD5å¯†ç è®¤è¯]
    C -->|scram-sha-256| F[SCRAM-SHA-256è®¤è¯]
    C -->|cert| G[SSLè¯ä¹¦è®¤è¯]
    E --> H{å¯†ç æ­£ç¡®?}
    F --> H
    G --> I{è¯ä¹¦æœ‰æ•ˆ?}
    H -->|æ˜¯| J[è®¤è¯æˆåŠŸ]
    H -->|å¦| K[è®¤è¯å¤±è´¥]
    I -->|æ˜¯| J
    I -->|å¦| K
    D --> J

    style A fill:#FFD700
    style J fill:#87CEEB
    style K fill:#FF6B6B
```

**SSL/TLSåŠ å¯†æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¿æ¥] --> B[å‘é€SSLè¯·æ±‚]
    B --> C{æœåŠ¡å™¨æ”¯æŒSSL?}
    C -->|å¦| D[æ‹’ç»è¿æ¥]
    C -->|æ˜¯| E[å‘é€æœåŠ¡å™¨è¯ä¹¦]
    E --> F[å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦]
    F --> G{è¯ä¹¦æœ‰æ•ˆ?}
    G -->|å¦| D
    G -->|æ˜¯| H[åå•†åŠ å¯†ç®—æ³•]
    H --> I[å»ºç«‹åŠ å¯†è¿æ¥]
    I --> J[æ•°æ®ä¼ è¾“åŠ å¯†]

    style A fill:#FFD700
    style I fill:#90EE90
    style J fill:#87CEEB
```

**å®¡è®¡æ—¥å¿—æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®åº“æ“ä½œ] --> B{å¯ç”¨å®¡è®¡?}
    B -->|å¦| C[æ­£å¸¸æ‰§è¡Œ]
    B -->|æ˜¯| D[è®°å½•æ“ä½œä¿¡æ¯]
    D --> E[å†™å…¥å®¡è®¡æ—¥å¿—]
    E --> F{æ—¥å¿—ç±»å‹}
    F -->|DDL| G[è®°å½•DDLæ“ä½œ]
    F -->|DML| H[è®°å½•DMLæ“ä½œ]
    F -->|è¿æ¥| I[è®°å½•è¿æ¥ä¿¡æ¯]
    G --> J[å†™å…¥æ—¥å¿—æ–‡ä»¶]
    H --> J
    I --> J
    C --> K[å®Œæˆæ“ä½œ]
    J --> K

    style A fill:#FFD700
    style D fill:#90EE90
    style K fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**å®‰å…¨ä¸åŠ å¯†çš„ä»·å€¼**:

PostgreSQL æä¾›äº†å®Œå–„çš„å®‰å…¨å’ŒåŠ å¯†æœºåˆ¶ï¼š

1. **è®¿é—®æ§åˆ¶**: ç”¨æˆ·æƒé™å’Œè§’è‰²ç®¡ç†
2. **æ•°æ®åŠ å¯†**: ä¼ è¾“åŠ å¯†å’Œå­˜å‚¨åŠ å¯†
3. **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„å®¡è®¡æ—¥å¿—
4. **è¡Œçº§å®‰å…¨**: è¡Œçº§å®‰å…¨ç­–ç•¥

**åº”ç”¨åœºæ™¯**:

- **æ•°æ®ä¿æŠ¤**: ä¿æŠ¤æ•æ„Ÿæ•°æ®
- **åˆè§„è¦æ±‚**: æ»¡è¶³åˆè§„è¦æ±‚
- **è®¿é—®æ§åˆ¶**: æ§åˆ¶æ•°æ®è®¿é—®
- **å®‰å…¨å®¡è®¡**: å®¡è®¡æ•°æ®è®¿é—®å’Œæ“ä½œ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æ•°æ®å®‰å…¨** | åŠ å¯†ä¿æŠ¤æ•°æ®å®‰å…¨ | **100%** |
| **åˆè§„æ€§** | æ»¡è¶³åˆè§„è¦æ±‚ | **100%** |
| **è®¿é—®æ§åˆ¶** | ç»†ç²’åº¦è®¿é—®æ§åˆ¶ | **100%** |
| **å®¡è®¡èƒ½åŠ›** | å®Œæ•´å®¡è®¡èƒ½åŠ› | **100%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®å®‰å…¨**: åŠ å¯†ä¿æŠ¤æ•°æ®å®‰å…¨ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
- **åˆè§„æ€§**: æ»¡è¶³ GDPRã€HIPAA ç­‰åˆè§„è¦æ±‚
- **è®¿é—®æ§åˆ¶**: ç»†ç²’åº¦è®¿é—®æ§åˆ¶ï¼Œä¿æŠ¤æ•°æ®éšç§
- **å®¡è®¡èƒ½åŠ›**: å®Œæ•´å®¡è®¡èƒ½åŠ›ï¼Œè¿½è¸ªæ•°æ®è®¿é—®

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†
- ç†è§£æ•°æ®åŠ å¯†æœºåˆ¶
- å­¦ä¼šé…ç½®å®¡è®¡æ—¥å¿—
- æŒæ¡è¡Œçº§å®‰å…¨ç­–ç•¥

### 1.4 å®‰å…¨ä¸åŠ å¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å®‰å…¨ä¸åŠ å¯†ä½“ç³»))
    èº«ä»½è®¤è¯
      å¯†ç è®¤è¯
        MD5
        SCRAM-SHA-256
        å¯†ç ç­–ç•¥
      SSL/TLS
        ä¼ è¾“åŠ å¯†
        è¯ä¹¦è®¤è¯
        åŒå‘è®¤è¯
      LDAPè®¤è¯
        LDAPé›†æˆ
        ä¼ä¸šè®¤è¯
        å•ç‚¹ç™»å½•
    æƒé™ç®¡ç†
      è§’è‰²ç®¡ç†
        è§’è‰²åˆ›å»º
        è§’è‰²ç»§æ‰¿
        è§’è‰²æƒé™
      å¯¹è±¡æƒé™
        è¡¨æƒé™
        è§†å›¾æƒé™
        å‡½æ•°æƒé™
        åˆ—æƒé™
      è¡Œçº§å®‰å…¨
        RLSç­–ç•¥
        æ¡ä»¶è¿‡æ»¤
        åŠ¨æ€è¿‡æ»¤
    æ•°æ®åŠ å¯†
      ä¼ è¾“åŠ å¯†
        SSL/TLS
        è¯ä¹¦ç®¡ç†
        åŠ å¯†å¼ºåº¦
      å­˜å‚¨åŠ å¯†
        é€æ˜åŠ å¯†
        å­—æ®µåŠ å¯†
        å¯†é’¥ç®¡ç†
      pgcryptoæ‰©å±•
        å“ˆå¸Œå‡½æ•°
        åŠ å¯†å‡½æ•°
        ç­¾åå‡½æ•°
    å®¡è®¡æ—¥å¿—
      æ“ä½œå®¡è®¡
        ç™»å½•å®¡è®¡
        æ“ä½œå®¡è®¡
        é”™è¯¯å®¡è®¡
      pgAuditæ‰©å±•
        è¯¦ç»†å®¡è®¡
        åˆè§„å®¡è®¡
        æ€§èƒ½å®¡è®¡
```

## 2. è®¿é—®æ§åˆ¶

### 2.1 ç”¨æˆ·å’Œè§’è‰²

**åˆ›å»ºç”¨æˆ·å’Œè§’è‰²**:

```sql
-- åˆ›å»ºè§’è‰²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE NOTICE 'è§’è‰² app_user å·²å­˜åœ¨';
        ELSE
            CREATE ROLE app_user WITH LOGIN PASSWORD 'password';
            RAISE NOTICE 'è§’è‰² app_user åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è§’è‰² app_user å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰² app_user å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            RAISE NOTICE 'è§’è‰² readonly_user å·²å­˜åœ¨';
        ELSE
            CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password';
            RAISE NOTICE 'è§’è‰² readonly_user åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è§’è‰² readonly_user å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰² readonly_user å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æˆäºˆæƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE WARNING 'è§’è‰² app_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'mydb') THEN
            RAISE WARNING 'æ•°æ®åº“ mydb ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT CONNECT ON DATABASE mydb TO app_user;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: CONNECT ON mydb -> app_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰²æˆ–æ•°æ®åº“ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            RAISE WARNING 'è§’è‰² readonly_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'public') THEN
            RAISE WARNING 'Schema public ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: SELECT ON public.* -> readonly_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰²æˆ–Schemaä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ’¤é”€æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            RAISE WARNING 'è§’è‰² readonly_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        REVOKE SELECT ON TABLE users FROM readonly_user;
        RAISE NOTICE 'æƒé™æ’¤é”€æˆåŠŸ: SELECT ON users <- readonly_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’¤é”€æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 æƒé™ç®¡ç†

**è¡¨çº§æƒé™**:

```sql
-- æˆäºˆè¡¨æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE WARNING 'è§’è‰² app_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT, INSERT, UPDATE ON TABLE users TO app_user;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: SELECT, INSERT, UPDATE ON users -> app_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆè¡¨æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'admin_user') THEN
            RAISE WARNING 'è§’è‰² admin_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT ALL PRIVILEGES ON TABLE users TO admin_user;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: ALL PRIVILEGES ON users -> admin_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆè¡¨æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æˆäºˆåˆ—æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            RAISE WARNING 'è§’è‰² readonly_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT (id, name) ON TABLE users TO readonly_user;
        RAISE NOTICE 'åˆ—æƒé™æˆäºˆæˆåŠŸ: SELECT(id, name) ON users -> readonly_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆåˆ—æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æˆäºˆåºåˆ—æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_class c
            JOIN pg_namespace n ON c.relnamespace = n.oid
            WHERE n.nspname = 'public' AND c.relname = 'users_id_seq' AND c.relkind = 'S'
        ) THEN
            RAISE WARNING 'åºåˆ— users_id_seq ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
            RAISE WARNING 'è§’è‰² app_user ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT USAGE, SELECT ON SEQUENCE users_id_seq TO app_user;
        RAISE NOTICE 'åºåˆ—æƒé™æˆäºˆæˆåŠŸ: USAGE, SELECT ON users_id_seq -> app_user';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'åºåˆ—æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆåºåˆ—æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.3 è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰

**RLS ç­–ç•¥**:

```sql
-- å¯ç”¨ RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE users ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'è¡¨ users å·²å¯ç”¨è¡Œçº§å®‰å…¨';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'public' AND p.proname = 'current_user_id'
        ) THEN
            RAISE WARNING 'å‡½æ•° current_user_id() ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'users' AND policyname = 'user_policy') THEN
            DROP POLICY user_policy ON users;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ user_policy';
        END IF;

        CREATE POLICY user_policy ON users
            FOR SELECT
            USING (id = current_user_id());
        RAISE NOTICE 'ç­–ç•¥ user_policy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'å‡½æ•° current_user_id() ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'public' AND p.proname = 'current_user_id'
        ) THEN
            RAISE WARNING 'å‡½æ•° current_user_id() ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'users' AND policyname = 'user_update_policy') THEN
            DROP POLICY user_update_policy ON users;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ user_update_policy';
        END IF;

        CREATE POLICY user_update_policy ON users
            FOR UPDATE
            USING (id = current_user_id())
            WITH CHECK (id = current_user_id());
        RAISE NOTICE 'ç­–ç•¥ user_update_policy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'å‡½æ•° current_user_id() ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 3. æ•°æ®åŠ å¯†

### 3.1 ä¼ è¾“åŠ å¯†ï¼ˆSSL/TLSï¼‰

**SSL é…ç½®** (postgresql.conf):

```conf
# å¯ç”¨ SSL
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'

# å¼ºåˆ¶ SSL è¿æ¥
hostssl all all 0.0.0.0/0 md5
```

### 3.2 å­˜å‚¨åŠ å¯†

**ä½¿ç”¨ pgcrypto æ‰©å±•**:

```sql
-- å®‰è£… pgcrypto æ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            CREATE EXTENSION pgcrypto;
            RAISE NOTICE 'pgcrypto æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pgcrypto æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pgcrypto æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pgcrypto æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        INSERT INTO users (email, password_hash)
        VALUES (
            'user@example.com',
            crypt('password', gen_salt('bf'))
        );
        RAISE NOTICE 'ç”¨æˆ·æ•°æ®æ’å…¥æˆåŠŸï¼Œå¯†ç å·²åŠ å¯†';
    EXCEPTION
        WHEN unique_violation THEN
            RAISE WARNING 'ç”¨æˆ· email user@example.com å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥åŠ å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯å¯†ç ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    user_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        SELECT COUNT(*) INTO user_count
        FROM users
        WHERE email = 'user@example.com'
          AND password_hash = crypt('password', password_hash);

        IF user_count > 0 THEN
            RAISE NOTICE 'å¯†ç éªŒè¯æˆåŠŸï¼Œæ‰¾åˆ° % ä¸ªåŒ¹é…ç”¨æˆ·', user_count;
        ELSE
            RAISE WARNING 'å¯†ç éªŒè¯å¤±è´¥ï¼Œæœªæ‰¾åˆ°åŒ¹é…ç”¨æˆ·';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å¯†ç å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM users
WHERE email = 'user@example.com'
  AND password_hash = crypt('password', password_hash);

-- åŠ å¯†åˆ—æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE NOTICE 'è¡¨ sensitive_data å·²å­˜åœ¨';
        ELSE
            CREATE TABLE sensitive_data (
                id SERIAL PRIMARY KEY,
                data_encrypted BYTEA
            );
            RAISE NOTICE 'è¡¨ sensitive_data åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ sensitive_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ’å…¥åŠ å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        INSERT INTO sensitive_data (data_encrypted)
        VALUES (pgp_sym_encrypt('sensitive data', 'encryption_key'));
        RAISE NOTICE 'åŠ å¯†æ•°æ®æ’å…¥æˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥åŠ å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

-- è§£å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        RAISE NOTICE 'è§£å¯†æ•°æ®éœ€è¦æ­£ç¡®çš„åŠ å¯†å¯†é’¥';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è§£å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ³¨æ„ï¼šå®é™…è§£å¯†éœ€è¦æä¾›æ­£ç¡®çš„åŠ å¯†å¯†é’¥
-- SELECT pgp_sym_decrypt(data_encrypted, 'encryption_key')
-- FROM sensitive_data;

```


## 4. å®¡è®¡æ—¥å¿—

### 4.1 å®¡è®¡æ—¥å¿—é…ç½®

**é…ç½®å®¡è®¡æ—¥å¿—** (postgresql.conf):

```conf
# å¯ç”¨å®¡è®¡æ—¥å¿—
logging_collector = on
log_destination = 'csvlog'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# è®°å½•æ‰€æœ‰ DDL è¯­å¥
log_statement = 'ddl'

# è®°å½•æ‰€æœ‰æ•°æ®ä¿®æ”¹
log_statement = 'mod'

# è®°å½•æ‰€æœ‰è¯­å¥
log_statement = 'all'

# è®°å½•è¿æ¥å’Œæ–­å¼€
log_connections = on
log_disconnections = on
```

### 4.2 å®¡è®¡è§¦å‘å™¨

**åˆ›å»ºå®¡è®¡è§¦å‘å™¨**:

```sql
-- åˆ›å»ºå®¡è®¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE NOTICE 'è¡¨ audit_log å·²å­˜åœ¨';
        ELSE
            CREATE TABLE audit_log (
                id SERIAL PRIMARY KEY,
                table_name TEXT,
                operation TEXT,
                old_data JSONB,
                new_data JSONB,
                user_name TEXT,
                timestamp TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ audit_log åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºå®¡è®¡å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'audit_trigger') THEN
            RAISE NOTICE 'å‡½æ•° audit_trigger å·²å­˜åœ¨';
        ELSE
            CREATE OR REPLACE FUNCTION audit_trigger()
            RETURNS TRIGGER AS $$
            BEGIN
                INSERT INTO audit_log (table_name, operation, old_data, new_data, user_name)
                VALUES (
                    TG_TABLE_NAME,
                    TG_OP,
                    row_to_json(OLD),
                    row_to_json(NEW),
                    current_user
                );
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
            RAISE NOTICE 'å‡½æ•° audit_trigger åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'audit_trigger') THEN
            RAISE WARNING 'å‡½æ•° audit_trigger ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'users_audit_trigger') THEN
            RAISE NOTICE 'è§¦å‘å™¨ users_audit_trigger å·²å­˜åœ¨';
        ELSE
            CREATE TRIGGER users_audit_trigger
                AFTER INSERT OR UPDATE OR DELETE ON users
                FOR EACH ROW
                EXECUTE FUNCTION audit_trigger();
            RAISE NOTICE 'è§¦å‘å™¨ users_audit_trigger åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è§¦å‘å™¨ users_audit_trigger å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: ä¼ä¸šçº§å®‰å…¨é…ç½®ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦é…ç½® PostgreSQL å®‰å…¨ç­–ç•¥ï¼Œä¿æŠ¤æ•æ„Ÿæ•°æ®ï¼Œæ»¡è¶³åˆè§„è¦æ±‚ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®å®‰å…¨**: éœ€è¦ä¿æŠ¤æ•æ„Ÿæ•°æ®
2. **åˆè§„è¦æ±‚**: éœ€è¦æ»¡è¶³ GDPR ç­‰åˆè§„è¦æ±‚
3. **è®¿é—®æ§åˆ¶**: éœ€è¦ç»†ç²’åº¦è®¿é—®æ§åˆ¶
4. **å®¡è®¡è¦æ±‚**: éœ€è¦å®Œæ•´çš„å®¡è®¡æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºè§’è‰²å’Œç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'data_admin') THEN
            CREATE ROLE data_admin WITH LOGIN PASSWORD 'strong_password';
            RAISE NOTICE 'è§’è‰² data_admin åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰² data_admin å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è§’è‰² data_admin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰² data_admin å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            CREATE ROLE app_readonly WITH LOGIN PASSWORD 'password';
            RAISE NOTICE 'è§’è‰² app_readonly åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è§’è‰² app_readonly å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è§’è‰² app_readonly å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§’è‰² app_readonly å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é…ç½®æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'mydb') THEN
            RAISE WARNING 'æ•°æ®åº“ mydb ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'data_admin') OR
           NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            RAISE WARNING 'è§’è‰²ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
            RETURN;
        END IF;

        GRANT CONNECT ON DATABASE mydb TO data_admin, app_readonly;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: CONNECT ON mydb -> data_admin, app_readonly';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'æ•°æ®åº“æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'public') THEN
            RAISE WARNING 'Schema public ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'data_admin') THEN
            RAISE WARNING 'è§’è‰² data_admin ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO data_admin;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: ALL PRIVILEGES ON public.* -> data_admin';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'Schema æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_readonly') THEN
            RAISE WARNING 'è§’è‰² app_readonly ä¸å­˜åœ¨';
            RETURN;
        END IF;

        GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_readonly;
        RAISE NOTICE 'æƒé™æˆäºˆæˆåŠŸ: SELECT ON public.* -> app_readonly';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'Schema æˆ–è§’è‰²ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å¯ç”¨ RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE users ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'è¡¨ users å·²å¯ç”¨è¡Œçº§å®‰å…¨';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'public' AND p.proname = 'current_user_department'
        ) THEN
            RAISE WARNING 'å‡½æ•° current_user_department() ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'users' AND policyname = 'users_rls_policy') THEN
            DROP POLICY users_rls_policy ON users;
        END IF;

        CREATE POLICY users_rls_policy ON users
            FOR SELECT
            USING (department = current_user_department());
        RAISE NOTICE 'ç­–ç•¥ users_rls_policy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'å‡½æ•° current_user_department() ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. é…ç½® SSLï¼ˆéœ€è¦åœ¨postgresql.confå’Œpg_hba.confä¸­é…ç½®ï¼‰
-- æ³¨æ„ï¼šè¿™äº›é…ç½®éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨è®¾ç½®ï¼Œæ— æ³•é€šè¿‡SQLç›´æ¥ä¿®æ”¹
-- postgresql.conf: ssl = on, ssl_cert_file = 'server.crt', ssl_key_file = 'server.key'
-- pg_hba.conf: hostssl all all 0.0.0.0/0 md5

-- 5. å¯ç”¨å®¡è®¡æ—¥å¿—ï¼ˆéœ€è¦åœ¨postgresql.confä¸­é…ç½®ï¼‰
-- æ³¨æ„ï¼šå®¡è®¡æ—¥å¿—é…ç½®éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨è®¾ç½®
-- postgresql.conf: logging_collector = on, log_statement = 'all', log_connections = on
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®å®‰å…¨** | ä¸­ | **é«˜** | **æå‡** |
| **åˆè§„æ€§** | ä¸æ»¡è¶³ | **æ»¡è¶³** | **æå‡** |
| **è®¿é—®æ§åˆ¶** | ç²—ç²’åº¦ | **ç»†ç²’åº¦** | **æå‡** |
| **å®¡è®¡èƒ½åŠ›** | æ—  | **å®Œæ•´** | **æå‡** |

## 6. æœ€ä½³å®è·µ

### 6.1 è®¿é—®æ§åˆ¶

1. **æœ€å°æƒé™åŸåˆ™**: æˆäºˆæœ€å°å¿…è¦æƒé™
2. **è§’è‰²ç®¡ç†**: ä½¿ç”¨è§’è‰²ç®¡ç†æƒé™
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™

### 6.2 æ•°æ®åŠ å¯†

1. **ä¼ è¾“åŠ å¯†**: ä½¿ç”¨ SSL/TLS åŠ å¯†ä¼ è¾“
2. **å­˜å‚¨åŠ å¯†**: å¯¹æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
3. **å¯†é’¥ç®¡ç†**: å®‰å…¨ç®¡ç†åŠ å¯†å¯†é’¥

### 6.3 å®¡è®¡æ—¥å¿—

1. **å®Œæ•´è®°å½•**: è®°å½•æ‰€æœ‰é‡è¦æ“ä½œ
2. **æ—¥å¿—ä¿æŠ¤**: ä¿æŠ¤å®¡è®¡æ—¥å¿—ä¸è¢«ç¯¡æ”¹
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥å®¡è®¡æ—¥å¿—

## 7. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 7.1 å®‰å…¨é…ç½®å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•é…ç½®SSL/TLSåŠ å¯†ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®SSL/TLSåŠ å¯†ï¼Œä¿æŠ¤æ•°æ®ä¼ è¾“å®‰å…¨ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥SSLæ˜¯å¦å¯ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    ssl_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO ssl_setting FROM pg_settings WHERE name = 'ssl';
        IF ssl_setting = 'on' THEN
            RAISE NOTICE 'SSL å·²å¯ç”¨';
        ELSE
            RAISE WARNING 'SSL æœªå¯ç”¨ï¼Œå½“å‰è®¾ç½®: %', ssl_setting;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥SSLè®¾ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW ssl;

-- 2. æ£€æŸ¥å½“å‰è¿æ¥æ˜¯å¦ä½¿ç”¨SSLï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    ssl_used BOOLEAN;
BEGIN
    BEGIN
        -- æ³¨æ„ï¼šssl_is_used() å‡½æ•°å¯èƒ½ä¸å­˜åœ¨ï¼Œéœ€è¦pgcryptoæ‰©å±•æˆ–è‡ªå®šä¹‰å‡½æ•°
        SELECT ssl_is_used() INTO ssl_used;
        IF ssl_used THEN
            RAISE NOTICE 'å½“å‰è¿æ¥ä½¿ç”¨SSL';
        ELSE
            RAISE WARNING 'å½“å‰è¿æ¥æœªä½¿ç”¨SSL';
        END IF;
    EXCEPTION
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° ssl_is_used() ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦å®‰è£…æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥SSLè¿æ¥çŠ¶æ€å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æ£€æŸ¥SSLé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    ssl_cert_file TEXT;
    ssl_key_file TEXT;
BEGIN
    BEGIN
        SELECT setting INTO ssl_cert_file FROM pg_settings WHERE name = 'ssl_cert_file';
        SELECT setting INTO ssl_key_file FROM pg_settings WHERE name = 'ssl_key_file';

        RAISE NOTICE 'SSL è¯ä¹¦æ–‡ä»¶: %', ssl_cert_file;
        RAISE NOTICE 'SSL å¯†é’¥æ–‡ä»¶: %', ssl_key_file;

        IF ssl_cert_file IS NULL OR ssl_key_file IS NULL THEN
            RAISE WARNING 'SSL é…ç½®æ–‡ä»¶æœªè®¾ç½®';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥SSLé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW ssl_cert_file;
SHOW ssl_key_file;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç”ŸæˆSSLè¯ä¹¦ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
-- openssl req -new -x509 -days 365 -nodes -text -out server.crt -keyout server.key

-- 2. é…ç½®postgresql.conf
-- ssl = on
-- ssl_cert_file = 'server.crt'
-- ssl_key_file = 'server.key'

-- 3. é…ç½®pg_hba.confï¼ˆå¼ºåˆ¶SSLï¼‰
-- hostssl all all 0.0.0.0/0 md5

-- 4. é‡å¯PostgreSQL
-- systemctl restart postgresql

-- 5. éªŒè¯SSLè¿æ¥
-- psql "host=localhost port=5432 dbname=mydb user=myuser sslmode=require"
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— SSLï¼šä¼ è¾“é€Ÿåº¦ **100 MB/s**ï¼Œæ•°æ®æ˜æ–‡ä¼ è¾“
- æœ‰SSLï¼šä¼ è¾“é€Ÿåº¦ **95 MB/s**ï¼Œæ•°æ®åŠ å¯†ä¼ è¾“
- **å®‰å…¨æ€§æå‡ï¼š100%ï¼Œæ€§èƒ½å½±å“ï¼š5%**

#### Q2: å¦‚ä½•åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç ã€ä¿¡ç”¨å¡å·ï¼‰ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥pgcryptoæ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    ext_exists BOOLEAN;
BEGIN
    BEGIN
        SELECT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') INTO ext_exists;
        IF ext_exists THEN
            RAISE NOTICE 'pgcrypto æ‰©å±•å·²å®‰è£…';
        ELSE
            RAISE WARNING 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥pgcryptoæ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥pgcryptoæ‰©å±•ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_extension WHERE extname = 'pgcrypto';

-- 2. æ£€æŸ¥åŠ å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    data_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•è§£å¯†æ•°æ®';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥åŠ å¯†æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæ£€æŸ¥åŠ å¯†æ•°æ®
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM sensitive_data;

-- æ³¨æ„ï¼šå®é™…è§£å¯†æ“ä½œéœ€è¦çŸ¥é“åŠ å¯†å¯†é’¥ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, pgp_sym_decrypt(data_encrypted, 'encryption_key')
FROM sensitive_data
LIMIT 1;

-- æ³¨æ„ï¼šå®é™…è§£å¯†éœ€è¦æä¾›æ­£ç¡®çš„åŠ å¯†å¯†é’¥
-- SELECT id, pgp_sym_decrypt(data_encrypted, 'encryption_key') FROM sensitive_data LIMIT 1;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å®‰è£…pgcryptoæ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            CREATE EXTENSION pgcrypto;
            RAISE NOTICE 'pgcrypto æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pgcrypto æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pgcrypto æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pgcrypto æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åŠ å¯†å¯†ç ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        INSERT INTO users (email, password_hash)
        VALUES (
            'user@example.com',
            crypt('password', gen_salt('bf'))
        );
        RAISE NOTICE 'ç”¨æˆ·å¯†ç å·²åŠ å¯†å¹¶æ’å…¥';
    EXCEPTION
        WHEN unique_violation THEN
            RAISE WARNING 'ç”¨æˆ· email user@example.com å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åŠ å¯†å¯†ç å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. éªŒè¯å¯†ç ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    user_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        SELECT COUNT(*) INTO user_count
        FROM users
        WHERE email = 'user@example.com'
          AND password_hash = crypt('password', password_hash);

        IF user_count > 0 THEN
            RAISE NOTICE 'å¯†ç éªŒè¯æˆåŠŸ';
        ELSE
            RAISE WARNING 'å¯†ç éªŒè¯å¤±è´¥';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å¯†ç å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM users
WHERE email = 'user@example.com'
  AND password_hash = crypt('password', password_hash);

-- 4. åŠ å¯†æ•æ„Ÿæ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE NOTICE 'è¡¨ sensitive_data å·²å­˜åœ¨';
        ELSE
            CREATE TABLE sensitive_data (
                id SERIAL PRIMARY KEY,
                data_encrypted BYTEA
            );
            RAISE NOTICE 'è¡¨ sensitive_data åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ sensitive_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        INSERT INTO sensitive_data (data_encrypted)
        VALUES (pgp_sym_encrypt('sensitive data', 'encryption_key'));
        RAISE NOTICE 'æ•æ„Ÿæ•°æ®å·²åŠ å¯†å¹¶æ’å…¥';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥åŠ å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. è§£å¯†æ•°æ®ï¼ˆéœ€è¦æƒé™ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        RAISE NOTICE 'è§£å¯†æ•°æ®éœ€è¦æ­£ç¡®çš„åŠ å¯†å¯†é’¥';
        -- SELECT id, pgp_sym_decrypt(data_encrypted, 'encryption_key') FROM sensitive_data LIMIT 1;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è§£å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

-- è§£å¯†æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_data') THEN
            RAISE WARNING 'è¡¨ sensitive_data ä¸å­˜åœ¨ï¼Œæ— æ³•è§£å¯†æ•°æ®';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'æ‰©å±• pgcrypto æœªå®‰è£…ï¼Œæ— æ³•è§£å¯†æ•°æ®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è§£å¯†æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§£å¯†å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pgp_sym_decrypt(data_encrypted, 'encryption_key')
FROM sensitive_data;

```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ˜æ–‡å­˜å‚¨ï¼šå­˜å‚¨ç©ºé—´ **100MB**ï¼ŒæŸ¥è¯¢é€Ÿåº¦ **1ms**
- åŠ å¯†å­˜å‚¨ï¼šå­˜å‚¨ç©ºé—´ **120MB**ï¼ŒæŸ¥è¯¢é€Ÿåº¦ **2ms**
- **å®‰å…¨æ€§æå‡ï¼š100%ï¼Œæ€§èƒ½å½±å“ï¼š2å€**

### 7.2 å®¡è®¡æ—¥å¿—å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•é…ç½®å®¡è®¡æ—¥å¿—ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é…ç½®å®¡è®¡æ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰é‡è¦æ“ä½œã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ—¥å¿—é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    log_statement_setting TEXT;
    log_connections_setting TEXT;
    log_disconnections_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO log_statement_setting FROM pg_settings WHERE name = 'log_statement';
        SELECT setting INTO log_connections_setting FROM pg_settings WHERE name = 'log_connections';
        SELECT setting INTO log_disconnections_setting FROM pg_settings WHERE name = 'log_disconnections';

        RAISE NOTICE 'æ—¥å¿—é…ç½®:';
        RAISE NOTICE '  log_statement: %', log_statement_setting;
        RAISE NOTICE '  log_connections: %', log_connections_setting;
        RAISE NOTICE '  log_disconnections: %', log_disconnections_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æ—¥å¿—é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW log_statement;
SHOW log_connections;
SHOW log_disconnections;

-- 2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    log_directory_setting TEXT;
    log_filename_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO log_directory_setting FROM pg_settings WHERE name = 'log_directory';
        SELECT setting INTO log_filename_setting FROM pg_settings WHERE name = 'log_filename';

        RAISE NOTICE 'æ—¥å¿—æ–‡ä»¶ä½ç½®:';
        RAISE NOTICE '  log_directory: %', log_directory_setting;
        RAISE NOTICE '  log_filename: %', log_filename_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä½ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW log_directory;
SHOW log_filename;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. é…ç½®postgresql.confï¼ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨è®¾ç½®ï¼‰
-- æ³¨æ„ï¼šä»¥ä¸‹é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®ï¼Œæ— æ³•é€šè¿‡SQLç›´æ¥ä¿®æ”¹
-- logging_collector = on
-- log_destination = 'csvlog'
-- log_directory = 'log'
-- log_statement = 'all'  -- è®°å½•æ‰€æœ‰è¯­å¥
-- log_connections = on
-- log_disconnections = on

-- 2. ä½¿ç”¨pgauditæ‰©å±•ï¼ˆæ›´å¼ºå¤§çš„å®¡è®¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            CREATE EXTENSION pgaudit;
            RAISE NOTICE 'pgaudit æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pgaudit æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pgaudit æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pgaudit æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET pgaudit.log = 'all';
        ALTER SYSTEM SET pgaudit.log_catalog = off;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'pgaudit é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•é…ç½® pgaudit';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½® pgaudit å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. åˆ›å»ºå®¡è®¡è§¦å‘å™¨ï¼ˆç»†ç²’åº¦å®¡è®¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE NOTICE 'å®¡è®¡è¡¨ audit_log å·²å­˜åœ¨';
        ELSE
            CREATE TABLE audit_log (
                id SERIAL PRIMARY KEY,
                table_name TEXT,
                operation TEXT,
                old_data JSONB,
                new_data JSONB,
                user_name TEXT,
                timestamp TIMESTAMPTZ DEFAULT NOW()
            );

            CREATE INDEX idx_audit_log_table_name ON audit_log(table_name);
            CREATE INDEX idx_audit_log_timestamp ON audit_log(timestamp);
            CREATE INDEX idx_audit_log_user_name ON audit_log(user_name);

            RAISE NOTICE 'å®¡è®¡è¡¨ audit_log åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'å®¡è®¡è¡¨ audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå®¡è®¡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨ï¼ˆå¦‚æœå‡½æ•°ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºå‡½æ•°ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING 'è¡¨ audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'audit_trigger') THEN
            RAISE NOTICE 'å‡½æ•° audit_trigger å·²å­˜åœ¨';
        ELSE
            CREATE OR REPLACE FUNCTION audit_trigger()
            RETURNS TRIGGER AS $$
            BEGIN
                BEGIN
                    INSERT INTO audit_log (table_name, operation, old_data, new_data, user_name)
                    VALUES (
                        TG_TABLE_NAME,
                        TG_OP,
                        CASE WHEN TG_OP = 'DELETE' THEN row_to_json(OLD) ELSE NULL END,
                        CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN row_to_json(NEW) ELSE NULL END,
                        current_user
                    );
                    RETURN COALESCE(NEW, OLD);
                EXCEPTION
                    WHEN OTHERS THEN
                        RAISE WARNING 'å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥: %', SQLERRM;
                        RETURN COALESCE(NEW, OLD);
                END;
            END;
            $$ LANGUAGE plpgsql;
            RAISE NOTICE 'å‡½æ•° audit_trigger åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'audit_trigger') THEN
            DROP TRIGGER audit_trigger ON users;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨ audit_trigger';
        END IF;

        CREATE TRIGGER audit_trigger
            AFTER INSERT OR UPDATE OR DELETE ON users
            FOR EACH ROW
            EXECUTE FUNCTION audit_trigger();
        RAISE NOTICE 'è§¦å‘å™¨ audit_trigger åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger() ä¸å­˜åœ¨';
        WHEN duplicate_object THEN
            RAISE WARNING 'è§¦å‘å™¨ audit_trigger å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— å®¡è®¡ï¼šæ€§èƒ½å¼€é”€ **0%**ï¼Œæ— å®¡è®¡èƒ½åŠ›
- åŸºç¡€å®¡è®¡ï¼šæ€§èƒ½å¼€é”€ **5%**ï¼ŒåŸºæœ¬å®¡è®¡èƒ½åŠ›
- å®Œæ•´å®¡è®¡ï¼šæ€§èƒ½å¼€é”€ **10%**ï¼Œå®Œæ•´å®¡è®¡èƒ½åŠ›
- **å®‰å…¨æ€§æå‡ï¼š100%ï¼Œæ€§èƒ½å½±å“ï¼š10%**

## 8. æœ€ä½³å®è·µ

### 8.1 æ¨èåšæ³•

#### âœ… å®‰å…¨é…ç½®å»ºè®®

1. **å¯ç”¨SSL/TLSåŠ å¯†**ï¼š

   ```sql
   -- âœ… å¥½ï¼šé…ç½®SSL/TLSåŠ å¯†
   -- postgresql.conf:
   ssl = on
   ssl_cert_file = 'server.crt'
   ssl_key_file = 'server.key'

   -- pg_hba.conf:
   hostssl all all 0.0.0.0/0 scram-sha-256
   ```

2. **ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨SCRAM-SHA-256è®¤è¯
   -- pg_hba.conf:
   host all all 0.0.0.0/0 scram-sha-256

   -- âœ… å¥½ï¼šè®¾ç½®å¯†ç å¤æ‚åº¦è¦æ±‚
   -- ä½¿ç”¨passwordcheckæ‰©å±•
   CREATE EXTENSION passwordcheck;
   ```

3. **å¯ç”¨å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- âœ… å¥½ï¼šé…ç½®å®¡è®¡æ—¥å¿—
   -- postgresql.conf:
   logging_collector = on
   log_destination = 'csvlog'
   log_directory = 'log'
   log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
   log_statement = 'all'  -- è®°å½•æ‰€æœ‰SQLè¯­å¥
   ```

#### âœ… æ•°æ®åŠ å¯†å»ºè®®

1. **ä¼ è¾“åŠ å¯†**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå¼ºåˆ¶ä½¿ç”¨SSLè¿æ¥
   -- pg_hba.conf:
   hostssl all all 0.0.0.0/0 scram-sha-256
   ```

2. **å­˜å‚¨åŠ å¯†**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•æ„Ÿæ•°æ®
   CREATE EXTENSION pgcrypto;

   CREATE TABLE users (
       id SERIAL PRIMARY KEY,
       email TEXT,
       password_hash TEXT,  -- å­˜å‚¨åŠ å¯†åçš„å¯†ç 
       credit_card_encrypted BYTEA  -- åŠ å¯†å­˜å‚¨
   );

   -- åŠ å¯†æ•°æ®
   INSERT INTO users (email, password_hash, credit_card_encrypted)
   VALUES (
       'user@example.com',
       crypt('password', gen_salt('bf')),
       pgp_sym_encrypt('1234-5678-9012-3456', 'encryption_key')
   );
   ```

3. **å¯†é’¥ç®¡ç†**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
   -- ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
   -- ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚AWS KMSã€Azure Key Vaultï¼‰
   ```

### 8.2 é¿å…åšæ³•

#### âŒ å®‰å…¨åæ¨¡å¼

1. **ä½¿ç”¨å¼±å¯†ç **ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šä½¿ç”¨å¼±å¯†ç 
   CREATE USER app_user WITH PASSWORD '123456';

   -- âœ… å¥½ï¼šä½¿ç”¨å¼ºå¯†ç 
   CREATE USER app_user WITH PASSWORD 'StrongP@ssw0rd!2024';
   ```

2. **ç¦ç”¨SSL**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šç¦ç”¨SSLï¼Œæ•°æ®æ˜æ–‡ä¼ è¾“
   -- postgresql.conf:
   ssl = off

   -- âœ… å¥½ï¼šå¯ç”¨SSLåŠ å¯†
   ssl = on
   ```

3. **å¿½ç•¥å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šä¸é…ç½®å®¡è®¡æ—¥å¿—
   -- æ— æ³•è¿½è¸ªæ•°æ®è®¿é—®å’Œæ“ä½œ

   -- âœ… å¥½ï¼šé…ç½®å®¡è®¡æ—¥å¿—
   log_statement = 'all'
   log_connections = on
   log_disconnections = on
   ```

### 8.3 æ€§èƒ½å»ºè®®

1. **å®‰å…¨æ€§èƒ½ä¼˜åŒ–**ï¼š
   - SSL/TLSåŠ å¯†å¯¹æ€§èƒ½å½±å“è¾ƒå°ï¼ˆ<5%ï¼‰ï¼Œå»ºè®®å¯ç”¨
   - å®¡è®¡æ—¥å¿—ä¼šå¢åŠ I/Oå¼€é”€ï¼Œæ ¹æ®éœ€æ±‚é…ç½®æ—¥å¿—çº§åˆ«
   - RLSç­–ç•¥åº”å°½é‡ç®€å•ï¼Œé¿å…å¤æ‚è®¡ç®—å½±å“æ€§èƒ½

2. **å®‰å…¨ç®¡ç†å»ºè®®**ï¼š
   - å®šæœŸæ›´æ–°å¯†ç å’Œè¯ä¹¦
   - å®šæœŸå®¡æŸ¥å®¡è®¡æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è®¿é—®
   - ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼Œé¿å…å¯†é’¥æ³„éœ²

3. **åˆè§„å»ºè®®**ï¼š
   - æ ¹æ®åˆè§„è¦æ±‚é…ç½®å®¡è®¡æ—¥å¿—
   - å®æ–½æ•°æ®åŠ å¯†æ»¡è¶³åˆè§„è¦æ±‚
   - å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œè¯„ä¼°

## 9. å‚è€ƒèµ„æ–™

### 9.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å®‰å…¨](https://www.postgresql.org/docs/current/security.html)**
  - PostgreSQL å®‰å…¨æ¦‚è¿°å’Œé…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - SSL/TLS](https://www.postgresql.org/docs/current/ssl-tcp.html)**
  - SSL/TLS é…ç½®å’Œä½¿ç”¨è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è®¤è¯](https://www.postgresql.org/docs/current/auth-methods.html)**
  - è®¤è¯æ–¹æ³•é…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å®¡è®¡æ—¥å¿—](https://www.postgresql.org/docs/current/runtime-config-logging.html)**
  - å®¡è®¡æ—¥å¿—é…ç½®è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - pgcrypto](https://www.postgresql.org/docs/current/pgcrypto.html)**
  - pgcrypto æ‰©å±•ä½¿ç”¨è¯´æ˜

### 9.2 æŠ€æœ¯è®ºæ–‡

- **[SSL/TLS Protocol Security](https://tools.ietf.org/html/rfc8446)**
  - TLS 1.3 åè®®è§„èŒƒ

- **[Database Security: Principles and Practices](https://www.postgresql.org/docs/current/security.html)**
  - æ•°æ®åº“å®‰å…¨åŸåˆ™å’Œå®è·µ

### 9.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Security: Best Practices](https://www.postgresql.org/docs/current/security.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šå®‰å…¨æœ€ä½³å®è·µ

- **[Understanding PostgreSQL SSL/TLS](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-ssl-tls)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL SSL/TLS

- **[PostgreSQL Security Configuration Tips](https://www.citusdata.com/blog/2017/10/25/security-configuration-in-postgresql/)**
  - Citus Data åšå®¢ï¼šå®‰å…¨é…ç½®æŠ€å·§

- **[2ndQuadrant - PostgreSQL Security Guide](https://www.2ndquadrant.com/en/blog/postgresql-security-guide/)**
  - 2ndQuadrant åšå®¢ï¼šå®‰å…¨æŒ‡å—

### 9.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Security](https://wiki.postgresql.org/wiki/Security)**
  - PostgreSQL Wikiï¼šå®‰å…¨ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Security](https://stackoverflow.com/questions/tagged/postgresql+security)**
  - Stack Overflowï¼šPostgreSQL å®‰å…¨ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šå®‰å…¨ç›¸å…³è®¨è®º

### 9.5 ç›¸å…³æ–‡æ¡£

- [æƒé™ç®¡ç†](./æƒé™ç®¡ç†.md)
- [å®‰å…¨ä½“ç³»è¯¦è§£](./å®‰å…¨ä½“ç³»è¯¦è§£.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-22
