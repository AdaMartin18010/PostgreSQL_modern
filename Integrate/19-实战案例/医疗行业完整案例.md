# PostgreSQLåŒ»ç–—è¡Œä¸šå®Œæ•´æ¡ˆä¾‹

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **è¡Œä¸š**: åŒ»ç–—
> **ç‰¹ç‚¹**: æ•°æ®å®‰å…¨ã€åˆè§„æ€§ã€çŸ¥è¯†å›¾è°±ã€ä¸´åºŠå†³ç­–
> **å‚è€ƒæ¡ˆä¾‹**: [åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ](./åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ.md), [åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±](./åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±.md)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLåŒ»ç–—è¡Œä¸šå®Œæ•´æ¡ˆä¾‹](#postgresqlåŒ»ç–—è¡Œä¸šå®Œæ•´æ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 åŒ»ç–—è¡Œä¸šç‰¹ç‚¹](#11-åŒ»ç–—è¡Œä¸šç‰¹ç‚¹)
    - [1.2 æ ¸å¿ƒåœºæ™¯](#12-æ ¸å¿ƒåœºæ™¯)
  - [2. åŒ»ç–—è¡Œä¸šæ ¸å¿ƒåœºæ™¯](#2-åŒ»ç–—è¡Œä¸šæ ¸å¿ƒåœºæ™¯)
    - [2.1 ç”µå­ç—…å†ç³»ç»Ÿ](#21-ç”µå­ç—…å†ç³»ç»Ÿ)
    - [2.2 ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ](#22-ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ)
    - [2.3 åŒ»å­¦çŸ¥è¯†å›¾è°±](#23-åŒ»å­¦çŸ¥è¯†å›¾è°±)
  - [3. æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
    - [3.1 å®‰å…¨æ¶æ„](#31-å®‰å…¨æ¶æ„)
    - [3.2 æ•°æ®å®‰å…¨](#32-æ•°æ®å®‰å…¨)
  - [4. æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
    - [4.1 æ‚£è€…è¡¨è®¾è®¡](#41-æ‚£è€…è¡¨è®¾è®¡)
    - [4.2 ç—…å†è¡¨è®¾è®¡](#42-ç—…å†è¡¨è®¾è®¡)
  - [5. å®‰å…¨ä¸åˆè§„](#5-å®‰å…¨ä¸åˆè§„)
    - [5.1 HIPAAåˆè§„](#51-hipaaåˆè§„)
    - [5.2 æ•°æ®åŠ å¯†](#52-æ•°æ®åŠ å¯†)
    - [5.3 æ•°æ®è„±æ•](#53-æ•°æ®è„±æ•)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ•°æ®å®‰å…¨](#61-æ•°æ®å®‰å…¨)
    - [6.2 åˆè§„æ€§](#62-åˆè§„æ€§)
    - [6.3 çŸ¥è¯†ç®¡ç†](#63-çŸ¥è¯†ç®¡ç†)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 åŒ»ç–—è¡Œä¸šç‰¹ç‚¹

åŒ»ç–—è¡Œä¸šå¯¹æ•°æ®åº“çš„è¦æ±‚ï¼š

- âœ… **æ•°æ®å®‰å…¨**: HIPAAåˆè§„ã€æ•°æ®åŠ å¯†
- âœ… **å¼ºä¸€è‡´æ€§**: åŒ»ç–—æ•°æ®å‡†ç¡®æ€§
- âœ… **çŸ¥è¯†å›¾è°±**: åŒ»å­¦çŸ¥è¯†ç®¡ç†
- âœ… **ä¸´åºŠå†³ç­–**: å®æ—¶å†³ç­–æ”¯æŒ
- âœ… **æ•°æ®éšç§**: æ‚£è€…éšç§ä¿æŠ¤

### 1.2 æ ¸å¿ƒåœºæ™¯

- **ç”µå­ç—…å†**: æ‚£è€…ç—…å†ç®¡ç†
- **ä¸´åºŠå†³ç­–**: ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ
- **çŸ¥è¯†å›¾è°±**: åŒ»å­¦çŸ¥è¯†å›¾è°±
- **è¯ç‰©ç®¡ç†**: è¯ç‰©ä¿¡æ¯ç®¡ç†
- **å®éªŒæ•°æ®**: å®éªŒæ•°æ®ç®¡ç†

---

## 2. åŒ»ç–—è¡Œä¸šæ ¸å¿ƒåœºæ™¯

### 2.1 ç”µå­ç—…å†ç³»ç»Ÿ

**æ ¸å¿ƒéœ€æ±‚**:

- æ‚£è€…æ•°æ®ç®¡ç†
- æ•°æ®åŠ å¯†å­˜å‚¨
- è®¿é—®æ§åˆ¶
- å®¡è®¡è¿½è¸ª

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- æ‚£è€…è¡¨
CREATE TABLE patients (
    patient_id BIGSERIAL PRIMARY KEY,
    patient_code TEXT UNIQUE NOT NULL,
    name_encrypted BYTEA,  -- åŠ å¯†å­˜å‚¨
    birth_date DATE,
    gender TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç—…å†è¡¨
CREATE TABLE medical_records (
    record_id BIGSERIAL PRIMARY KEY,
    patient_id BIGINT NOT NULL REFERENCES patients(patient_id),
    doctor_id BIGINT NOT NULL,
    diagnosis TEXT,
    treatment TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¯ç”¨RLS
ALTER TABLE medical_records ENABLE ROW LEVEL SECURITY;

-- è®¿é—®æ§åˆ¶ç­–ç•¥
CREATE POLICY doctor_access ON medical_records
    FOR ALL
    USING (
        doctor_id = current_setting('app.user_id')::BIGINT
        OR patient_id IN (
            SELECT patient_id
            FROM authorized_access
            WHERE user_id = current_setting('app.user_id')::BIGINT
        )
    );
```

### 2.2 ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ

**å‚è€ƒ**: [åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ](./åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ.md)

**æ ¸å¿ƒéœ€æ±‚**:

- å®æ—¶å†³ç­–æ”¯æŒ
- çŸ¥è¯†åº“æŸ¥è¯¢
- è§„åˆ™å¼•æ“
- æœºå™¨å­¦ä¹ é›†æˆ

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- ä¸´åºŠè§„åˆ™è¡¨
CREATE TABLE clinical_rules (
    rule_id SERIAL PRIMARY KEY,
    rule_name TEXT NOT NULL,
    condition JSONB,
    recommendation TEXT,
    evidence_level TEXT,
    enabled BOOLEAN DEFAULT true
);

-- å†³ç­–æ”¯æŒå‡½æ•°
CREATE OR REPLACE FUNCTION clinical_decision_support(
    p_patient_id BIGINT,
    p_symptoms JSONB,
    p_lab_results JSONB
)
RETURNS TABLE (
    recommendation TEXT,
    confidence NUMERIC,
    evidence TEXT
) AS $$
DECLARE
    v_rule RECORD;
BEGIN
    -- æ£€æŸ¥æ‰€æœ‰ç›¸å…³è§„åˆ™
    FOR v_rule IN
        SELECT * FROM clinical_rules
        WHERE enabled = true
    LOOP
        -- è§„åˆ™åŒ¹é…é€»è¾‘
        IF match_rule(v_rule.condition, p_symptoms, p_lab_results) THEN
            RETURN QUERY
            SELECT
                v_rule.recommendation,
                0.8::NUMERIC as confidence,
                v_rule.evidence_level;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 2.3 åŒ»å­¦çŸ¥è¯†å›¾è°±

**å‚è€ƒ**: [åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±](./åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±.md)

**æ ¸å¿ƒéœ€æ±‚**:

- çŸ¥è¯†å›¾è°±å­˜å‚¨
- å…³ç³»æŸ¥è¯¢
- æ¨ç†æŸ¥è¯¢
- çŸ¥è¯†æ›´æ–°

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨Apache AGEå›¾æ•°æ®åº“
CREATE EXTENSION age;

-- åˆ›å»ºå›¾
SELECT create_graph('medical_knowledge');

-- ç–¾ç—…èŠ‚ç‚¹
SELECT * FROM cypher('medical_knowledge', $$
    CREATE (d:Disease {
        name: 'Diabetes',
        code: 'E11',
        description: 'Type 2 diabetes'
    })
$$) AS (result agtype);

-- ç—‡çŠ¶èŠ‚ç‚¹
SELECT * FROM cypher('medical_knowledge', $$
    CREATE (s:Symptom {
        name: 'Increased thirst',
        severity: 'moderate'
    })
$$) AS (result agtype);

-- å…³ç³»
SELECT * FROM cypher('medical_knowledge', $$
    MATCH (d:Disease {name: 'Diabetes'})
    MATCH (s:Symptom {name: 'Increased thirst'})
    CREATE (d)-[:HAS_SYMPTOM]->(s)
$$) AS (result agtype);

-- æŸ¥è¯¢
SELECT * FROM cypher('medical_knowledge', $$
    MATCH (d:Disease)-[:HAS_SYMPTOM]->(s:Symptom)
    WHERE d.name = 'Diabetes'
    RETURN s.name
$$) AS (symptom agtype);
```

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 å®‰å…¨æ¶æ„

```text
åº”ç”¨å±‚ (åŠ å¯†ä¼ è¾“)
    â†“
APIç½‘å…³ (è®¤è¯æˆæƒ)
    â†“
PostgreSQLé›†ç¾¤
â”œâ”€â”€ ä¸»åº“ (åŠ å¯†å­˜å‚¨)
â”œâ”€â”€ ä»åº“1 (åªè¯» - åˆ†æ)
â””â”€â”€ ä»åº“2 (åªè¯» - æŠ¥è¡¨)
    â†“
å¤‡ä»½å±‚ (åŠ å¯†å¤‡ä»½)
```

### 3.2 æ•°æ®å®‰å…¨

```text
æ•°æ®åŠ å¯†:
1. ä¼ è¾“åŠ å¯† (SSL/TLS)
2. å­˜å‚¨åŠ å¯† (TDE)
3. åˆ—çº§åŠ å¯† (pgcrypto)
4. å¤‡ä»½åŠ å¯†
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ‚£è€…è¡¨è®¾è®¡

```sql
-- æ‚£è€…è¡¨ï¼ˆåŠ å¯†ï¼‰
CREATE TABLE patients (
    patient_id BIGSERIAL PRIMARY KEY,
    patient_code TEXT UNIQUE NOT NULL,
    name_encrypted BYTEA,
    phone_encrypted BYTEA,
    email_encrypted BYTEA,
    birth_date DATE,
    gender TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_patient_data(data TEXT)
RETURNS BYTEA AS $$
BEGIN
    RETURN pgp_sym_encrypt(data, current_setting('app.encryption_key'));
END;
$$ LANGUAGE plpgsql;
```

### 4.2 ç—…å†è¡¨è®¾è®¡

```sql
-- ç—…å†è¡¨ï¼ˆRLSä¿æŠ¤ï¼‰
CREATE TABLE medical_records (
    record_id BIGSERIAL PRIMARY KEY,
    patient_id BIGINT NOT NULL REFERENCES patients(patient_id),
    doctor_id BIGINT NOT NULL,
    diagnosis TEXT,
    treatment TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLSç­–ç•¥
ALTER TABLE medical_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY doctor_patient_access ON medical_records
    FOR ALL
    USING (
        doctor_id = current_setting('app.user_id')::BIGINT
        OR EXISTS (
            SELECT 1 FROM authorized_access
            WHERE user_id = current_setting('app.user_id')::BIGINT
            AND patient_id = medical_records.patient_id
        )
    );
```

---

## 5. å®‰å…¨ä¸åˆè§„

### 5.1 HIPAAåˆè§„

```sql
-- å®¡è®¡æ—¥å¿—
CREATE EXTENSION pgaudit;

ALTER DATABASE medical_db SET pgaudit.log = 'all';

-- è®¿é—®å®¡è®¡
CREATE TABLE access_audit (
    audit_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    patient_id BIGINT,
    action TEXT,
    access_time TIMESTAMPTZ DEFAULT NOW(),
    ip_address INET
);
```

### 5.2 æ•°æ®åŠ å¯†

```sql
-- ä½¿ç”¨pgcryptoåŠ å¯†
CREATE EXTENSION pgcrypto;

-- åŠ å¯†å­˜å‚¨
INSERT INTO patients (patient_code, name_encrypted)
VALUES ('P001', encrypt_patient_data('John Doe'));

-- è§£å¯†æŸ¥è¯¢
SELECT
    patient_code,
    pgp_sym_decrypt(name_encrypted, current_setting('app.encryption_key')) as name
FROM patients;
```

### 5.3 æ•°æ®è„±æ•

```sql
-- è„±æ•è§†å›¾
CREATE VIEW patients_masked AS
SELECT
    patient_id,
    patient_code,
    '***' as name,
    '***' as phone,
    '***' as email,
    birth_date,
    gender
FROM patients;

-- æˆäºˆè„±æ•è§†å›¾è®¿é—®æƒé™
GRANT SELECT ON patients_masked TO readonly_user;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ•°æ®å®‰å…¨

- âœ… **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- âœ… **è®¿é—®æ§åˆ¶**: RLSç­–ç•¥æ§åˆ¶è®¿é—®
- âœ… **å®¡è®¡æ—¥å¿—**: å®Œæ•´å®¡è®¡è¿½è¸ª
- âœ… **æ•°æ®è„±æ•**: éç”Ÿäº§ç¯å¢ƒä½¿ç”¨è„±æ•æ•°æ®

### 6.2 åˆè§„æ€§

- âœ… **HIPAAåˆè§„**: ç¬¦åˆHIPAAè¦æ±‚
- âœ… **æ•°æ®ä¿ç•™**: ç¬¦åˆæ•°æ®ä¿ç•™è¦æ±‚
- âœ… **è®¿é—®æ§åˆ¶**: ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶
- âœ… **å®¡è®¡è¿½è¸ª**: å®Œæ•´çš„å®¡è®¡è¿½è¸ª

### 6.3 çŸ¥è¯†ç®¡ç†

- âœ… **çŸ¥è¯†å›¾è°±**: ä½¿ç”¨å›¾æ•°æ®åº“ç®¡ç†çŸ¥è¯†
- âœ… **è§„åˆ™å¼•æ“**: çµæ´»çš„è§„åˆ™å¼•æ“
- âœ… **å®æ—¶æŸ¥è¯¢**: å®æ—¶çŸ¥è¯†æŸ¥è¯¢
- âœ… **çŸ¥è¯†æ›´æ–°**: åŠæ—¶æ›´æ–°çŸ¥è¯†åº“

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ](./åŒ»ç–—åœºæ™¯/ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ.md) - ä¸´åºŠå†³ç­–æ”¯æŒ
- [åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±](./åŒ»ç–—åœºæ™¯/åŒ»å­¦çŸ¥è¯†å›¾è°±.md) - åŒ»å­¦çŸ¥è¯†å›¾è°±
- [32-ä¼ä¸šçº§ç‰¹æ€§/åˆè§„æ€§ç®¡ç†](../32-ä¼ä¸šçº§ç‰¹æ€§/åˆè§„æ€§ç®¡ç†.md) - åˆè§„æ€§ç®¡ç†
- [32-ä¼ä¸šçº§ç‰¹æ€§/ä¼ä¸šçº§å®‰å…¨æ·±åŒ–](../32-ä¼ä¸šçº§ç‰¹æ€§/ä¼ä¸šçº§å®‰å…¨æ·±åŒ–.md) - ä¼ä¸šçº§å®‰å…¨

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
