# PostgreSQL医疗行业完整案例

> **PostgreSQL版本**: 18.x
> **行业**: 医疗
> **特点**: 数据安全、合规性、知识图谱、临床决策
> **参考案例**: [医疗场景/临床决策支持系统](./医疗场景/临床决策支持系统.md), [医疗场景/医学知识图谱](./医疗场景/医学知识图谱.md)

---

## 📋 目录

- [PostgreSQL医疗行业完整案例](#postgresql医疗行业完整案例)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 医疗行业特点](#11-医疗行业特点)
    - [1.2 核心场景](#12-核心场景)
  - [2. 医疗行业核心场景](#2-医疗行业核心场景)
    - [2.1 电子病历系统](#21-电子病历系统)
    - [2.2 临床决策支持系统](#22-临床决策支持系统)
    - [2.3 医学知识图谱](#23-医学知识图谱)
  - [3. 技术架构](#3-技术架构)
    - [3.1 安全架构](#31-安全架构)
    - [3.2 数据安全](#32-数据安全)
  - [4. 数据库设计](#4-数据库设计)
    - [4.1 患者表设计](#41-患者表设计)
    - [4.2 病历表设计](#42-病历表设计)
  - [5. 安全与合规](#5-安全与合规)
    - [5.1 HIPAA合规](#51-hipaa合规)
    - [5.2 数据加密](#52-数据加密)
    - [5.3 数据脱敏](#53-数据脱敏)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 数据安全](#61-数据安全)
    - [6.2 合规性](#62-合规性)
    - [6.3 知识管理](#63-知识管理)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

### 1.1 医疗行业特点

医疗行业对数据库的要求：

- ✅ **数据安全**: HIPAA合规、数据加密
- ✅ **强一致性**: 医疗数据准确性
- ✅ **知识图谱**: 医学知识管理
- ✅ **临床决策**: 实时决策支持
- ✅ **数据隐私**: 患者隐私保护

### 1.2 核心场景

- **电子病历**: 患者病历管理
- **临床决策**: 临床决策支持系统
- **知识图谱**: 医学知识图谱
- **药物管理**: 药物信息管理
- **实验数据**: 实验数据管理

---

## 2. 医疗行业核心场景

### 2.1 电子病历系统

**核心需求**:

- 患者数据管理
- 数据加密存储
- 访问控制
- 审计追踪

**技术方案**:

```sql
-- 患者表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'patients') THEN
            CREATE TABLE patients (
                patient_id BIGSERIAL PRIMARY KEY,
                patient_code TEXT UNIQUE NOT NULL,
                name_encrypted BYTEA,  -- 加密存储
                birth_date DATE,
                gender TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '表 patients 创建成功';
        ELSE
            RAISE NOTICE '表 patients 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 patients 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 病历表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'medical_records') THEN
            CREATE TABLE medical_records (
                record_id BIGSERIAL PRIMARY KEY,
                patient_id BIGINT NOT NULL REFERENCES patients(patient_id),
                doctor_id BIGINT NOT NULL,
                diagnosis TEXT,
                treatment TEXT,
                notes TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '表 medical_records 创建成功';
        ELSE
            RAISE NOTICE '表 medical_records 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 medical_records 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 启用RLS（带错误处理）
DO $$
BEGIN
    BEGIN
        ALTER TABLE medical_records ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE '行级安全已启用';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '启用行级安全失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 访问控制策略（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'medical_records' AND policyname = 'doctor_access') THEN
            CREATE POLICY doctor_access ON medical_records
                FOR ALL
                USING (
                    doctor_id = current_setting('app.user_id')::BIGINT
                    OR patient_id IN (
                        SELECT patient_id
                        FROM authorized_access
                        WHERE user_id = current_setting('app.user_id')::BIGINT
                    )
                );
            RAISE NOTICE 'RLS策略创建成功';
        ELSE
            RAISE NOTICE 'RLS策略已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'RLS策略已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建RLS策略失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM medical_records WHERE patient_id = 1;
```

### 2.2 临床决策支持系统

**参考**: [医疗场景/临床决策支持系统](./医疗场景/临床决策支持系统.md)

**核心需求**:

- 实时决策支持
- 知识库查询
- 规则引擎
- 机器学习集成

**技术方案**:

```sql
-- 临床规则表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'clinical_rules') THEN
            CREATE TABLE clinical_rules (
                rule_id SERIAL PRIMARY KEY,
                rule_name TEXT NOT NULL,
                condition JSONB,
                recommendation TEXT,
                evidence_level TEXT,
                enabled BOOLEAN DEFAULT true
            );
            RAISE NOTICE '表 clinical_rules 创建成功';
        ELSE
            RAISE NOTICE '表 clinical_rules 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 clinical_rules 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM clinical_rules WHERE enabled = true;

-- 决策支持函数
CREATE OR REPLACE FUNCTION clinical_decision_support(
    p_patient_id BIGINT,
    p_symptoms JSONB,
    p_lab_results JSONB
)
RETURNS TABLE (
    recommendation TEXT,
    confidence NUMERIC,
    evidence TEXT
) AS $$
DECLARE
    v_rule RECORD;
BEGIN
    -- 检查所有相关规则
    FOR v_rule IN
        SELECT * FROM clinical_rules
        WHERE enabled = true
    LOOP
        -- 规则匹配逻辑
        IF match_rule(v_rule.condition, p_symptoms, p_lab_results) THEN
            RETURN QUERY
            SELECT
                v_rule.recommendation,
                0.8::NUMERIC as confidence,
                v_rule.evidence_level;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 2.3 医学知识图谱

**参考**: [医疗场景/医学知识图谱](./医疗场景/医学知识图谱.md)

**核心需求**:

- 知识图谱存储
- 关系查询
- 推理查询
- 知识更新

**技术方案**:

```sql
-- 使用Apache AGE图数据库（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'age') THEN
            CREATE EXTENSION age;
            RAISE NOTICE '扩展 age 创建成功';
        ELSE
            RAISE NOTICE '扩展 age 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE '扩展 age 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建扩展失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 创建图（带错误处理）
DO $$
DECLARE
    v_graph_exists BOOLEAN;
BEGIN
    BEGIN
        -- 检查图是否已存在
        SELECT EXISTS(
            SELECT 1 FROM ag_graph WHERE graphname = 'medical_knowledge'
        ) INTO v_graph_exists;

        IF NOT v_graph_exists THEN
            PERFORM create_graph('medical_knowledge');
            RAISE NOTICE '图 medical_knowledge 创建成功';
        ELSE
            RAISE NOTICE '图 medical_knowledge 已存在';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建图失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 疾病节点（带错误处理）
DO $$
BEGIN
    BEGIN
        PERFORM * FROM cypher('medical_knowledge', $$
            CREATE (d:Disease {
                name: 'Diabetes',
                code: 'E11',
                description: 'Type 2 diabetes'
            })
        $$) AS (result agtype);
        RAISE NOTICE '疾病节点创建成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建疾病节点失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM cypher('medical_knowledge', $$
    MATCH (d:Disease)
    RETURN d
$$) AS (result agtype);

-- 症状节点
SELECT * FROM cypher('medical_knowledge', $$
    CREATE (s:Symptom {
        name: 'Increased thirst',
        severity: 'moderate'
    })
$$) AS (result agtype);

-- 关系
SELECT * FROM cypher('medical_knowledge', $$
    MATCH (d:Disease {name: 'Diabetes'})
    MATCH (s:Symptom {name: 'Increased thirst'})
    CREATE (d)-[:HAS_SYMPTOM]->(s)
$$) AS (result agtype);

-- 查询
SELECT * FROM cypher('medical_knowledge', $$
    MATCH (d:Disease)-[:HAS_SYMPTOM]->(s:Symptom)
    WHERE d.name = 'Diabetes'
    RETURN s.name
$$) AS (symptom agtype);
```

---

## 3. 技术架构

### 3.1 安全架构

```text
应用层 (加密传输)
    ↓
API网关 (认证授权)
    ↓
PostgreSQL集群
├── 主库 (加密存储)
├── 从库1 (只读 - 分析)
└── 从库2 (只读 - 报表)
    ↓
备份层 (加密备份)
```

### 3.2 数据安全

```text
数据加密:
1. 传输加密 (SSL/TLS)
2. 存储加密 (TDE)
3. 列级加密 (pgcrypto)
4. 备份加密
```

---

## 4. 数据库设计

### 4.1 患者表设计

```sql
-- 患者表（加密）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'patients' AND table_schema = 'public') THEN
            CREATE TABLE patients (
                patient_id BIGSERIAL PRIMARY KEY,
                patient_code TEXT UNIQUE NOT NULL,
                name_encrypted BYTEA,
                phone_encrypted BYTEA,
                email_encrypted BYTEA,
                birth_date DATE,
                gender TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '表 patients 创建成功';
        ELSE
            RAISE NOTICE '表 patients 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 patients 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 加密函数（带错误处理）
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE FUNCTION encrypt_patient_data(data TEXT)
        RETURNS BYTEA AS $$
        BEGIN
            IF data IS NULL THEN
                RETURN NULL;
            END IF;
            RETURN pgp_sym_encrypt(data, current_setting('app.encryption_key'));
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING '加密数据失败: %', SQLERRM;
                RETURN NULL;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE '函数 encrypt_patient_data 创建成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建函数失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT patient_id, patient_code FROM patients WHERE patient_code = 'P001';
```

### 4.2 病历表设计

```sql
-- 病历表（RLS保护）（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'medical_records' AND table_schema = 'public') THEN
            CREATE TABLE medical_records (
                record_id BIGSERIAL PRIMARY KEY,
                patient_id BIGINT NOT NULL REFERENCES patients(patient_id),
                doctor_id BIGINT NOT NULL,
                diagnosis TEXT,
                treatment TEXT,
                notes TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '表 medical_records 创建成功';
        ELSE
            RAISE NOTICE '表 medical_records 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 medical_records 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- RLS策略（带错误处理）
DO $$
BEGIN
    BEGIN
        ALTER TABLE medical_records ENABLE ROW LEVEL SECURITY;

        IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'medical_records' AND policyname = 'doctor_patient_access') THEN
            CREATE POLICY doctor_patient_access ON medical_records
                FOR ALL
                USING (
                    doctor_id = current_setting('app.user_id')::BIGINT
                    OR EXISTS (
                        SELECT 1 FROM authorized_access
                        WHERE user_id = current_setting('app.user_id')::BIGINT
                        AND patient_id = medical_records.patient_id
                    )
                );
            RAISE NOTICE 'RLS策略创建成功';
        ELSE
            RAISE NOTICE 'RLS策略已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'RLS策略已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建RLS策略失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM medical_records WHERE patient_id = 1;
```

---

## 5. 安全与合规

### 5.1 HIPAA合规

```sql
-- 审计日志（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgaudit') THEN
            CREATE EXTENSION pgaudit;
            RAISE NOTICE '扩展 pgaudit 创建成功';
        ELSE
            RAISE NOTICE '扩展 pgaudit 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE '扩展 pgaudit 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建扩展失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 设置审计日志（带错误处理）
DO $$
BEGIN
    BEGIN
        ALTER DATABASE current_database() SET pgaudit.log = 'all';
        RAISE NOTICE '审计日志配置成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '设置审计日志失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 访问审计（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'access_audit') THEN
            CREATE TABLE access_audit (
                audit_id BIGSERIAL PRIMARY KEY,
                user_id BIGINT,
                patient_id BIGINT,
                action TEXT,
                access_time TIMESTAMPTZ DEFAULT NOW(),
                ip_address INET
            );
            RAISE NOTICE '表 access_audit 创建成功';
        ELSE
            RAISE NOTICE '表 access_audit 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '表 access_audit 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM access_audit WHERE user_id = 1 ORDER BY access_time DESC LIMIT 10;
```

### 5.2 数据加密

```sql
-- 使用pgcrypto加密（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            CREATE EXTENSION pgcrypto;
            RAISE NOTICE '扩展 pgcrypto 创建成功';
        ELSE
            RAISE NOTICE '扩展 pgcrypto 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE '扩展 pgcrypto 已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建扩展失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 加密存储（带错误处理）
DO $$
BEGIN
    BEGIN
        INSERT INTO patients (patient_code, name_encrypted)
        VALUES ('P001', encrypt_patient_data('John Doe'))
        ON CONFLICT (patient_code) DO NOTHING;
        RAISE NOTICE '患者数据插入成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '插入患者数据失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 解密查询（带错误处理和性能测试）
DO $$
DECLARE
    v_patient_record RECORD;
BEGIN
    BEGIN
        FOR v_patient_record IN
            SELECT
                patient_code,
                pgp_sym_decrypt(name_encrypted, current_setting('app.encryption_key')) as name
            FROM patients
            WHERE patient_code = 'P001'
        LOOP
            RAISE NOTICE '患者代码: %, 姓名: %', v_patient_record.patient_code, v_patient_record.name;
        END LOOP;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '解密查询失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    patient_code,
    pgp_sym_decrypt(name_encrypted, current_setting('app.encryption_key')) as name
FROM patients
WHERE patient_code = 'P001';
```

### 5.3 数据脱敏

```sql
-- 脱敏视图（带错误处理）
DO $$
BEGIN
    BEGIN
        DROP VIEW IF EXISTS patients_masked;
        CREATE VIEW patients_masked AS
        SELECT
            patient_id,
            patient_code,
            '***' as name,
            '***' as phone,
            '***' as email,
            birth_date,
            gender
        FROM patients;
        RAISE NOTICE '脱敏视图创建成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建脱敏视图失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 授予脱敏视图访问权限（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'readonly_user') THEN
            GRANT SELECT ON patients_masked TO readonly_user;
            RAISE NOTICE '权限授予成功';
        ELSE
            RAISE NOTICE '用户 readonly_user 不存在，跳过权限授予';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '授予权限失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM patients_masked WHERE patient_code = 'P001';
```

---

## 6. 最佳实践

### 6.1 数据安全

- ✅ **数据加密**: 敏感数据加密存储
- ✅ **访问控制**: RLS策略控制访问
- ✅ **审计日志**: 完整审计追踪
- ✅ **数据脱敏**: 非生产环境使用脱敏数据

### 6.2 合规性

- ✅ **HIPAA合规**: 符合HIPAA要求
- ✅ **数据保留**: 符合数据保留要求
- ✅ **访问控制**: 严格的访问控制
- ✅ **审计追踪**: 完整的审计追踪

### 6.3 知识管理

- ✅ **知识图谱**: 使用图数据库管理知识
- ✅ **规则引擎**: 灵活的规则引擎
- ✅ **实时查询**: 实时知识查询
- ✅ **知识更新**: 及时更新知识库

---

## 📚 相关文档

- [医疗场景/临床决策支持系统](./医疗场景/临床决策支持系统.md) - 临床决策支持
- [医疗场景/医学知识图谱](./医疗场景/医学知识图谱.md) - 医学知识图谱
- [32-企业级特性/合规性管理](../32-企业级特性/合规性管理.md) - 合规性管理
- [32-企业级特性/企业级安全深化](../32-企业级特性/企业级安全深化.md) - 企业级安全

---

**最后更新**: 2025年1月
**状态**: ✅ 完成
