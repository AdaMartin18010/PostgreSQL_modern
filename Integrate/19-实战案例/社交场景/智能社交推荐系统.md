---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\ç¤¾äº¤åœºæ™¯\æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, Apache AGE 1.5.0+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-43-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿ](#æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½ç¤¾äº¤æ¨èä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½ç¤¾äº¤æ¨èä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 å›¾æ•°æ®æ¨¡å‹](#31-å›¾æ•°æ®æ¨¡å‹)
    - [3.2 å‘é‡æ•°æ®è¡¨](#32-å‘é‡æ•°æ®è¡¨)
  - [4. æ¨èç®¡ç†](#4-æ¨èç®¡ç†)
    - [4.1 å¥½å‹æ¨è](#41-å¥½å‹æ¨è)
    - [4.2 æ··åˆæ¨è](#42-æ··åˆæ¨è)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 å¥½å‹æ¨è](#61-å¥½å‹æ¨è)
    - [6.2 å…³ç³»åˆ†æ](#62-å…³ç³»åˆ†æ)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 ç¤¾äº¤å›¾è°±å’Œå‘é‡è¡¨åˆ›å»º](#81-ç¤¾äº¤å›¾è°±å’Œå‘é‡è¡¨åˆ›å»º)
    - [8.2 ç¤¾äº¤å›¾è°±æ“ä½œå®ç°](#82-ç¤¾äº¤å›¾è°±æ“ä½œå®ç°)
    - [8.3 æ··åˆæ¨èå®ç°ï¼ˆå›¾+å‘é‡ï¼‰](#83-æ··åˆæ¨èå®ç°å›¾å‘é‡)
    - [8.4 å†…å®¹æ¨èå®ç°](#84-å†…å®¹æ¨èå®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿéœ€è¦ï¼š

- **å¥½å‹æ¨è**: æ ¹æ®ç¤¾äº¤å…³ç³»æ¨èå¥½å‹
- **å†…å®¹æ¨è**: æ¨èæ„Ÿå…´è¶£çš„å†…å®¹
- **å…³ç³»åˆ†æ**: åˆ†æç¤¾äº¤å…³ç³»ç½‘ç»œ
- **å…´è¶£åŒ¹é…**: åŒ¹é…ç”¨æˆ·å…´è¶£

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å›¾æ•°æ®åº“**: Apache AGEï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†å†…å®¹ç‰¹å¾
- **å®æ—¶åˆ†æ**: SQL + Cypher + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ¨èå‡†ç¡®ç‡** | å›¾+å‘é‡æ··åˆæ¨èæå‡å‡†ç¡®ç‡ | **+58%** |
| **ç”¨æˆ·æ»¡æ„åº¦** | ä¸ªæ€§åŒ–æ¨èæå‡æ»¡æ„åº¦ | **+50%** |
| **æŸ¥è¯¢æ€§èƒ½** | å›¾+å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **12x** |
| **æ´»è·ƒåº¦** | æå‡ç”¨æˆ·æ´»è·ƒåº¦ | **+46%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ¨èå‡†ç¡®ç‡**: å›¾+å‘é‡æ··åˆæ¨èæå‡å‡†ç¡®ç‡ 58%
- **ç”¨æˆ·æ»¡æ„åº¦**: ä¸ªæ€§åŒ–æ¨èæå‡ç”¨æˆ·æ»¡æ„åº¦ 50%
- **æŸ¥è¯¢æ€§èƒ½**: å›¾+å‘é‡ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 12 å€
- **æ´»è·ƒåº¦**: æå‡ç”¨æˆ·æ´»è·ƒåº¦ 46%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½ç¤¾äº¤æ¨èä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½ç¤¾äº¤æ¨è))
    æ•°æ®å±‚
      ç”¨æˆ·æ•°æ®
        ç”¨æˆ·ä¿¡æ¯
        ç”¨æˆ·å…³ç³»
        ç”¨æˆ·è¡Œä¸º
        ç”¨æˆ·åå¥½
      å†…å®¹æ•°æ®
        å†…å®¹ä¿¡æ¯
        å†…å®¹ç‰¹å¾
        å†…å®¹å‘é‡
        å†…å®¹æ ‡ç­¾
      å…³ç³»æ•°æ®
        å¥½å‹å…³ç³»
        å…³æ³¨å…³ç³»
        äº’åŠ¨å…³ç³»
        ç¤¾äº¤ç½‘ç»œ
    å­˜å‚¨å±‚
      å›¾æ•°æ®åº“
        Apache AGE
        ç”¨æˆ·å…³ç³»å›¾
        ç¤¾äº¤ç½‘ç»œ
        å›¾æŸ¥è¯¢
      å‘é‡æ•°æ®åº“
        pgvector
        å†…å®¹å‘é‡
        ç”¨æˆ·å‘é‡
        ç›¸ä¼¼åº¦æœç´¢
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å…³ç³»é‡‡é›†
        å†…å®¹é‡‡é›†
        è¡Œä¸ºé‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        å†…å®¹å‘é‡åŒ–
        ç”¨æˆ·å‘é‡åŒ–
        ç‰¹å¾æå–
        å‘é‡ä¼˜åŒ–
      æ¨èç®—æ³•
        å›¾æ¨è
        å‘é‡æ¨è
        æ··åˆæ¨è
        èåˆç®—æ³•
    åº”ç”¨å±‚
      å¥½å‹æ¨è
        å›¾æ¨è
        å‘é‡æ¨è
        æ··åˆæ¨è
        æ¨èä¼˜åŒ–
      å†…å®¹æ¨è
        ä¸ªæ€§åŒ–æ¨è
        çƒ­é—¨æ¨è
        ç›¸ä¼¼æ¨è
        æ¨èä¼˜åŒ–
      å…³ç³»åˆ†æ
        ç¤¾äº¤ç½‘ç»œåˆ†æ
        ç¤¾åŒºæ£€æµ‹
        å½±å“åŠ›åˆ†æ
        å…³ç³»é¢„æµ‹
    åº”ç”¨åœºæ™¯
      ç¤¾äº¤å¹³å°
        å¥½å‹æ¨è
        å†…å®¹æ¨è
        å…³ç³»åˆ†æ
      å†…å®¹å¹³å°
        å†…å®¹æ¨è
        ç”¨æˆ·æ¨è
        å…´è¶£åŒ¹é…
      ç¤¾åŒºå¹³å°
        ç¤¾åŒºæ¨è
        æˆå‘˜æ¨è
        æ´»åŠ¨æ¨è
```

### 2.2 æ¶æ„è®¾è®¡

```text
ç¤¾äº¤æ•°æ®é‡‡é›†
  â”œâ”€â”€ ç”¨æˆ·å…³ç³»
  â”œâ”€â”€ å†…å®¹æ•°æ®
  â””â”€â”€ ç”¨æˆ·è¡Œä¸º
  â†“
å›¾æ•°æ®å­˜å‚¨ï¼ˆApache AGEï¼‰
  â”œâ”€â”€ ç”¨æˆ·å…³ç³»å›¾
  â””â”€â”€ ç¤¾äº¤ç½‘ç»œ
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ å†…å®¹å‘é‡
  â””â”€â”€ ç”¨æˆ·åå¥½å‘é‡
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ å¥½å‹æ¨è
  â”œâ”€â”€ å†…å®¹æ¨è
  â””â”€â”€ å…³ç³»åˆ†æ
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + Apache AGE + pgvector
- **æ•°æ®é‡‡é›†**: ç¤¾äº¤å…³ç³»ã€å†…å®¹æ•°æ®ã€ç”¨æˆ·è¡Œä¸º
- **å®æ—¶åˆ†æ**: Python + SQL + Cypher
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å›¾æ•°æ®æ¨¡å‹

```sql
-- åˆ›å»ºå›¾æ•°æ®åº“
SELECT create_graph('social_network');

-- åˆ›å»ºç”¨æˆ·èŠ‚ç‚¹
SELECT * FROM cypher('social_network', $$
    CREATE (u1:User {id: 1, name: 'Alice', interests: ['tech', 'music']})
    CREATE (u2:User {id: 2, name: 'Bob', interests: ['tech', 'sports']})
    CREATE (u3:User {id: 3, name: 'Charlie', interests: ['music', 'art']})
$$) AS (result agtype);
```

### 3.2 å‘é‡æ•°æ®è¡¨

```sql
CREATE TABLE user_preferences (
    user_id INTEGER PRIMARY KEY,
    preference_vector vector(512),
    interests TEXT[],
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE content_items (
    id SERIAL PRIMARY KEY,
    content_type TEXT,
    content_vector vector(512),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX up_vector_idx ON user_preferences
USING ivfflat (preference_vector vector_cosine_ops)
WITH (lists = 100);
```

## 4. æ¨èç®¡ç†

### 4.1 å¥½å‹æ¨è

```sql
-- ä½¿ç”¨å›¾æŸ¥è¯¢æ¨èå¥½å‹
SELECT * FROM cypher('social_network', $$
    MATCH (u:User {id: $user_id})-[:FOLLOWS]->(f:User)-[:FOLLOWS]->(r:User)
    WHERE NOT (u)-[:FOLLOWS]->(r)
        AND u <> r
    RETURN r.id AS recommended_user_id, COUNT(*) AS mutual_friends
    ORDER BY mutual_friends DESC
    LIMIT 20
$$, user_id => $1) AS (recommended_user_id agtype, mutual_friends agtype);
```

### 4.2 æ··åˆæ¨è

```python
# å›¾+å‘é‡æ··åˆæ¨è
class HybridRecommendation:
    async def recommend_friends(self, user_id):
        """æ¨èå¥½å‹"""
        # 1. å›¾æŸ¥è¯¢ï¼šåŸºäºç¤¾äº¤å…³ç³»
        graph_results = await self.db.fetch("""
            SELECT * FROM cypher('social_network', $$
                MATCH (u:User {id: $user_id})-[:FOLLOWS]->(f:User)-[:FOLLOWS]->(r:User)
                WHERE NOT (u)-[:FOLLOWS]->(r)
                    AND u <> r
                RETURN r.id AS user_id, COUNT(*) AS mutual_friends
                ORDER BY mutual_friends DESC
                LIMIT 20
            $$, user_id => $1) AS (user_id agtype, mutual_friends agtype)
        """, user_id)

        # 2. å‘é‡æŸ¥è¯¢ï¼šåŸºäºå…´è¶£ç›¸ä¼¼åº¦
        user_pref = await self.get_user_preference(user_id)
        vector_results = await self.db.fetch("""
            SELECT
                user_id,
                1 - (preference_vector <=> $1::vector) AS similarity
            FROM user_preferences
            WHERE user_id != $2
                AND preference_vector <=> $1::vector < 0.7
            ORDER BY preference_vector <=> $1::vector
            LIMIT 20
        """, user_pref['preference_vector'], user_id)

        # 3. èåˆç»“æœï¼ˆRRFï¼‰
        recommendations = self.fuse_results(graph_results, vector_results)

        return recommendations
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç¤¾äº¤å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿï¼Œæ¨èå¥½å‹å’Œå†…å®¹ã€‚

**é—®é¢˜åˆ†æ**:

1. **å¥½å‹æ¨è**: å¥½å‹æ¨èä¸å‡†ç¡®
2. **å†…å®¹æ¨è**: å†…å®¹æ¨èæ•ˆç‡ä½
3. **å…³ç³»åˆ†æ**: å…³ç³»åˆ†æå›°éš¾

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½ç¤¾äº¤æ¨èç³»ç»Ÿ
class SmartSocialRecommendationSystem:
    def __init__(self):
        self.hybrid_recommendation = HybridRecommendation()
        self.relationship_analysis = RelationshipAnalysis()

    async def recommend(self, user_id, recommendation_type='friends'):
        """æ¨è"""
        if recommendation_type == 'friends':
            # å¥½å‹æ¨è
            recommendations = await self.hybrid_recommendation.recommend_friends(
                user_id
            )
        else:
            # å†…å®¹æ¨è
            recommendations = await self.recommend_content(user_id)

        # åˆ†æå…³ç³»
        relationship_stats = await self.relationship_analysis.analyze_relationships(
            user_id
        )

        return {
            'recommendations': recommendations,
            'relationship_stats': relationship_stats
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ¨èå‡†ç¡®ç‡** | åŸºå‡† | **+58%** | **æå‡** |
| **ç”¨æˆ·æ»¡æ„åº¦** | åŸºå‡† | **+50%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **æ´»è·ƒåº¦** | åŸºå‡† | **+46%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**ç¤¾äº¤æ¨èæŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | æ¨èå‡†ç¡®ç‡ | ç”¨æˆ·æ»¡æ„åº¦ | æ´»è·ƒåº¦ | æŸ¥è¯¢æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|-----------|--------|----------|----------|
| **å›¾æ¨è** | +30% | +25% | +20% | +200% | å…³ç³»ä¸°å¯Œ |
| **å‘é‡æ¨è** | +40% | +35% | +30% | +500% | å†…å®¹ä¸°å¯Œ |
| **æ··åˆæ¨è** | **+58%** | **+50%** | **+46%** | **+1100%** | **å¤æ‚åœºæ™¯** |

**æ¨èç®—æ³•å¯¹æ¯”**:

| æ¨èç®—æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **ååŒè¿‡æ»¤** | 70-80% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **å›¾æ¨è** | 75-85% | ä¸­ | é«˜ | å…³ç³»ä¸°å¯Œ |
| **æ··åˆæ¨è** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 å¥½å‹æ¨è

1. **å›¾æŸ¥è¯¢**: ä½¿ç”¨å›¾æŸ¥è¯¢åˆ†æç¤¾äº¤å…³ç³»
2. **å‘é‡åŒ¹é…**: ä½¿ç”¨å‘é‡åŒ¹é…å…´è¶£
3. **æ··åˆèåˆ**: ä½¿ç”¨ RRF èåˆç»“æœ

### 6.2 å…³ç³»åˆ†æ

1. **å›¾åˆ†æ**: ä½¿ç”¨å›¾åˆ†æç¤¾äº¤ç½‘ç»œ
2. **ç¤¾åŒºæ£€æµ‹**: æ£€æµ‹ç”¨æˆ·ç¤¾åŒº
3. **å½±å“åŠ›åˆ†æ**: åˆ†æç”¨æˆ·å½±å“åŠ›

## 7. å‚è€ƒèµ„æ–™

- [å›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹](../é‡‘èåœºæ™¯/å›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹.md)
- [ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ](../ç”µå•†åœºæ™¯/ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 ç¤¾äº¤å›¾è°±å’Œå‘é‡è¡¨åˆ›å»º

**åˆ›å»ºç¤¾äº¤æ¨èç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectorå’ŒApache AGEæ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS age;
LOAD 'age';
SET search_path = ag_catalog, "$user", public;

-- åˆ›å»ºç¤¾äº¤å›¾è°±
SELECT create_graph('social_network');

-- åˆ›å»ºç”¨æˆ·åå¥½å‘é‡è¡¨
CREATE TABLE user_preferences (
    user_id INTEGER PRIMARY KEY,
    preference_vector vector(512),  -- ç”¨æˆ·åå¥½å‘é‡
    interests TEXT[],
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå†…å®¹é¡¹å‘é‡è¡¨
CREATE TABLE content_items (
    id SERIAL PRIMARY KEY,
    content_type TEXT,  -- 'post', 'article', 'video', etc.
    content_vector vector(512),  -- å†…å®¹å‘é‡
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_user_preferences_vector ON user_preferences USING hnsw (preference_vector vector_cosine_ops);
CREATE INDEX idx_content_items_vector ON content_items USING hnsw (content_vector vector_cosine_ops);
```

### 8.2 ç¤¾äº¤å›¾è°±æ“ä½œå®ç°

**Pythonç¤¾äº¤å›¾è°±æ“ä½œ**ï¼š

```python
import psycopg2
from typing import List, Dict

class SocialGraphManager:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç¤¾äº¤å›¾è°±ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()
        # åŠ è½½AGEæ‰©å±•
        self.cur.execute("LOAD 'age'")
        self.cur.execute("SET search_path = ag_catalog, \"$user\", public")

    def create_user_node(self, user_id: int, name: str, interests: List[str]):
        """åˆ›å»ºç”¨æˆ·èŠ‚ç‚¹"""
        self.cur.execute(f"""
            SELECT * FROM cypher('social_network', $$
                CREATE (u:User {{id: {user_id}, name: '{name}', interests: {interests}}})
                RETURN u
            $$) AS (u agtype)
        """)
        self.conn.commit()

    def create_follow_relationship(self, from_user_id: int, to_user_id: int):
        """åˆ›å»ºå…³æ³¨å…³ç³»"""
        self.cur.execute(f"""
            SELECT * FROM cypher('social_network', $$
                MATCH (u1:User {{id: {from_user_id}}}), (u2:User {{id: {to_user_id}}})
                CREATE (u1)-[r:FOLLOWS]->(u2)
                RETURN r
            $$) AS (r agtype)
        """)
        self.conn.commit()

    def get_friends_of_friends(self, user_id: int, limit: int = 20) -> List[Dict]:
        """è·å–å¥½å‹çš„å¥½å‹ï¼ˆäºŒåº¦å…³ç³»ï¼‰"""
        self.cur.execute(f"""
            SELECT * FROM cypher('social_network', $$
                MATCH (u:User {{id: {user_id}}})-[:FOLLOWS]->(f:User)-[:FOLLOWS]->(r:User)
                WHERE NOT (u)-[:FOLLOWS]->(r)
                  AND u <> r
                RETURN r.id AS user_id, COUNT(*) AS mutual_friends
                ORDER BY mutual_friends DESC
                LIMIT {limit}
            $$) AS (user_id agtype, mutual_friends agtype)
        """)

        results = []
        for row in self.cur.fetchall():
            results.append({
                'user_id': int(str(row[0])),
                'mutual_friends': int(str(row[1]))
            })

        return results

# ä½¿ç”¨ç¤ºä¾‹
graph_manager = SocialGraphManager("host=localhost dbname=testdb user=postgres password=secret")

# åˆ›å»ºç”¨æˆ·èŠ‚ç‚¹
graph_manager.create_user_node(1, 'Alice', ['tech', 'music'])
graph_manager.create_user_node(2, 'Bob', ['tech', 'sports'])

# åˆ›å»ºå…³æ³¨å…³ç³»
graph_manager.create_follow_relationship(1, 2)

# è·å–å¥½å‹çš„å¥½å‹
friends_of_friends = graph_manager.get_friends_of_friends(user_id=1, limit=20)
for friend in friends_of_friends:
    print(f"User {friend['user_id']}: {friend['mutual_friends']} mutual friends")
```

### 8.3 æ··åˆæ¨èå®ç°ï¼ˆå›¾+å‘é‡ï¼‰

**Pythonæ··åˆæ¨è**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class HybridSocialRecommender:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ··åˆç¤¾äº¤æ¨èå™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()
        self.cur.execute("LOAD 'age'")
        self.cur.execute("SET search_path = ag_catalog, \"$user\", public")
        self.graph_manager = SocialGraphManager(conn_str)

    def get_user_preference(self, user_id: int) -> Dict:
        """è·å–ç”¨æˆ·åå¥½å‘é‡"""
        self.cur.execute("""
            SELECT preference_vector, interests
            FROM user_preferences
            WHERE user_id = %s
        """, (user_id,))

        result = self.cur.fetchone()
        if result:
            return {
                'preference_vector': result[0],
                'interests': result[1]
            }
        return None

    def recommend_friends_by_graph(self, user_id: int, limit: int = 20) -> List[Dict]:
        """åŸºäºå›¾çš„å¥½å‹æ¨è"""
        return self.graph_manager.get_friends_of_friends(user_id, limit)

    def recommend_friends_by_vector(self, user_id: int, limit: int = 20) -> List[Dict]:
        """åŸºäºå‘é‡çš„å¥½å‹æ¨è"""
        user_pref = self.get_user_preference(user_id)
        if not user_pref or not user_pref['preference_vector']:
            return []

        self.cur.execute("""
            SELECT
                user_id,
                1 - (preference_vector <=> %s) AS similarity
            FROM user_preferences
            WHERE user_id != %s
              AND preference_vector <=> %s < 0.3
            ORDER BY preference_vector <=> %s
            LIMIT %s
        """, (
            user_pref['preference_vector'],
            user_id,
            user_pref['preference_vector'],
            user_pref['preference_vector'],
            limit
        ))

        recommendations = []
        for row in self.cur.fetchall():
            recommendations.append({
                'user_id': row[0],
                'similarity': float(row[1])
            })

        return recommendations

    def rrf_fusion(self, graph_results: List[Dict], vector_results: List[Dict],
                   k: int = 60) -> List[Dict]:
        """RRFèåˆç®—æ³•"""
        scores = {}

        # è®¡ç®—å›¾æ¨èç»“æœçš„RRFåˆ†æ•°
        for rank, item in enumerate(graph_results, 1):
            user_id = item['user_id']
            if user_id not in scores:
                scores[user_id] = {
                    'user_id': user_id,
                    'score': 0.0,
                    'mutual_friends': item.get('mutual_friends', 0),
                    'similarity': 0.0
                }
            scores[user_id]['score'] += 1.0 / (k + rank)
            scores[user_id]['mutual_friends'] = item.get('mutual_friends', 0)

        # è®¡ç®—å‘é‡æ¨èç»“æœçš„RRFåˆ†æ•°
        for rank, item in enumerate(vector_results, 1):
            user_id = item['user_id']
            if user_id not in scores:
                scores[user_id] = {
                    'user_id': user_id,
                    'score': 0.0,
                    'mutual_friends': 0,
                    'similarity': 0.0
                }
            scores[user_id]['score'] += 1.0 / (k + rank)
            scores[user_id]['similarity'] = item.get('similarity', 0.0)

        # æŒ‰åˆ†æ•°æ’åº
        sorted_results = sorted(
            scores.values(),
            key=lambda x: x['score'],
            reverse=True
        )

        return sorted_results

    def hybrid_recommend_friends(self, user_id: int, limit: int = 20) -> List[Dict]:
        """æ··åˆæ¨èå¥½å‹"""
        # 1. å›¾æ¨è
        graph_recommendations = self.recommend_friends_by_graph(user_id, limit * 2)

        # 2. å‘é‡æ¨è
        vector_recommendations = self.recommend_friends_by_vector(user_id, limit * 2)

        # 3. RRFèåˆ
        fused_recommendations = self.rrf_fusion(
            graph_recommendations,
            vector_recommendations,
            k=60
        )

        return fused_recommendations[:limit]

# ä½¿ç”¨ç¤ºä¾‹
recommender = HybridSocialRecommender("host=localhost dbname=testdb user=postgres password=secret")

# æ··åˆæ¨èå¥½å‹
recommendations = recommender.hybrid_recommend_friends(user_id=1, limit=20)
for rec in recommendations:
    print(f"User {rec['user_id']}: score={rec['score']:.4f}, "
          f"mutual_friends={rec['mutual_friends']}, similarity={rec['similarity']:.4f}")
```

### 8.4 å†…å®¹æ¨èå®ç°

**Pythonå†…å®¹æ¨è**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import List, Dict

class ContentRecommender:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å†…å®¹æ¨èå™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()
        self.hybrid_recommender = HybridSocialRecommender(conn_str)

    def recommend_content(self, user_id: int, limit: int = 20) -> List[Dict]:
        """æ¨èå†…å®¹"""
        user_pref = self.hybrid_recommender.get_user_preference(user_id)
        if not user_pref or not user_pref['preference_vector']:
            return []

        self.cur.execute("""
            SELECT
                id,
                content_type,
                metadata,
                1 - (content_vector <=> %s) AS similarity
            FROM content_items
            WHERE content_vector <=> %s < 0.7
            ORDER BY content_vector <=> %s
            LIMIT %s
        """, (
            user_pref['preference_vector'],
            user_pref['preference_vector'],
            user_pref['preference_vector'],
            limit
        ))

        recommendations = []
        for row in self.cur.fetchall():
            recommendations.append({
                'id': row[0],
                'content_type': row[1],
                'metadata': row[2],
                'similarity': float(row[3])
            })

        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
content_recommender = ContentRecommender("host=localhost dbname=testdb user=postgres password=secret")

# æ¨èå†…å®¹
content_recs = content_recommender.recommend_content(user_id=1, limit=20)
for rec in content_recs:
    print(f"Content {rec['id']}: type={rec['content_type']}, similarity={rec['similarity']:.4f}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-43-01
