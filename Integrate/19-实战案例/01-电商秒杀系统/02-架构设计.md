---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\01-ç”µå•†ç§’æ€ç³»ç»Ÿ\02-æ¶æ„è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç”µå•†ç§’æ€ç³»ç»Ÿ - æ¶æ„è®¾è®¡

> **æ¡ˆä¾‹ç±»å‹**: é«˜å¹¶å‘OLTPç³»ç»Ÿ
> **éš¾åº¦ç­‰çº§**: â­â­â­â­â­
> **PostgreSQLç‰ˆæœ¬**: 18.x
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-04

---

## ğŸ“‹ ç›®å½•

- [ç”µå•†ç§’æ€ç³»ç»Ÿ - æ¶æ„è®¾è®¡](#ç”µå•†ç§’æ€ç³»ç»Ÿ---æ¶æ„è®¾è®¡)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ•´ä½“æ¶æ„](#ä¸€æ•´ä½“æ¶æ„)
    - [1.1 æ¶æ„æ€»è§ˆ](#11-æ¶æ„æ€»è§ˆ)
    - [1.2 æ¶æ„ç‰¹ç‚¹](#12-æ¶æ„ç‰¹ç‚¹)
    - [1.3 è¯·æ±‚æµç¨‹](#13-è¯·æ±‚æµç¨‹)
  - [äºŒã€åˆ†å±‚æ¶æ„è®¾è®¡](#äºŒåˆ†å±‚æ¶æ„è®¾è®¡)
    - [2.1 æ¥å…¥å±‚è®¾è®¡](#21-æ¥å…¥å±‚è®¾è®¡)
    - [2.2 åº”ç”¨å±‚è®¾è®¡](#22-åº”ç”¨å±‚è®¾è®¡)
    - [2.3 ç¼“å­˜å±‚è®¾è®¡](#23-ç¼“å­˜å±‚è®¾è®¡)
    - [2.4 æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡](#24-æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡)
  - [ä¸‰ã€æ ¸å¿ƒç»„ä»¶è®¾è®¡](#ä¸‰æ ¸å¿ƒç»„ä»¶è®¾è®¡)
    - [3.1 åº“å­˜æ‰£å‡è®¾è®¡](#31-åº“å­˜æ‰£å‡è®¾è®¡)
    - [3.2 é˜²è¶…å–è®¾è®¡](#32-é˜²è¶…å–è®¾è®¡)
    - [3.3 é˜²é‡å¤æŠ¢è´­è®¾è®¡](#33-é˜²é‡å¤æŠ¢è´­è®¾è®¡)
  - [å››ã€PostgreSQL 18ç‰¹æ€§åº”ç”¨](#å››postgresql-18ç‰¹æ€§åº”ç”¨)
    - [4.1 å†…ç½®è¿æ¥æ± ](#41-å†…ç½®è¿æ¥æ± )
    - [4.2 å¼‚æ­¥I/O](#42-å¼‚æ­¥io)
    - [4.3 æ”¹è¿›çš„VACUUM](#43-æ”¹è¿›çš„vacuum)
    - [4.4 æ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯](#44-æ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯)
    - [4.5 pg\_statç›‘æ§å¢å¼º](#45-pg_statç›‘æ§å¢å¼º)
  - [äº”ã€é«˜å¯ç”¨è®¾è®¡](#äº”é«˜å¯ç”¨è®¾è®¡)
    - [5.1 æ•°æ®åº“é«˜å¯ç”¨](#51-æ•°æ®åº“é«˜å¯ç”¨)
    - [5.2 è¯»å†™åˆ†ç¦»](#52-è¯»å†™åˆ†ç¦»)
    - [5.3 å®¹ç¾è®¾è®¡](#53-å®¹ç¾è®¾è®¡)
  - [å…­ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#å…­æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
    - [6.1 æ•°æ®åº“å±‚ä¼˜åŒ–](#61-æ•°æ®åº“å±‚ä¼˜åŒ–)
    - [6.2 æŸ¥è¯¢ä¼˜åŒ–](#62-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.3 é…ç½®ä¼˜åŒ–](#63-é…ç½®ä¼˜åŒ–)
  - [ä¸ƒã€ç›‘æ§ä¸å‘Šè­¦](#ä¸ƒç›‘æ§ä¸å‘Šè­¦)
    - [7.1 å…³é”®æŒ‡æ ‡](#71-å…³é”®æŒ‡æ ‡)
    - [7.2 å‘Šè­¦è§„åˆ™](#72-å‘Šè­¦è§„åˆ™)

---

## ä¸€ã€æ•´ä½“æ¶æ„

### 1.1 æ¶æ„æ€»è§ˆ

```mermaid
graph TB
    subgraph "ç”¨æˆ·å±‚"
        Mobile[ç§»åŠ¨ç«¯]
        Web[Webç«¯]
        H5[H5é¡µé¢]
    end

    subgraph "CDNå±‚"
        CDN[CDNé™æ€èµ„æº]
        PageCache[é¡µé¢ç¼“å­˜]
    end

    subgraph "æ¥å…¥å±‚"
        LB[è´Ÿè½½å‡è¡¡<br/>Nginx/LVS]
        API[APIç½‘å…³<br/>é™æµ/ç†”æ–­]
    end

    subgraph "åº”ç”¨å±‚"
        App1[åº”ç”¨æœåŠ¡å™¨1]
        App2[åº”ç”¨æœåŠ¡å™¨2]
        App10[åº”ç”¨æœåŠ¡å™¨10]
    end

    subgraph "ç¼“å­˜å±‚"
        Redis1[(Redisä¸»1)]
        Redis2[(Redisä¸»2)]
        Redis3[(Redisä¸»3)]
        RedisS1[(Redisä»1)]
        RedisS2[(Redisä»2)]
        RedisS3[(Redisä»3)]
    end

    subgraph "æ¶ˆæ¯é˜Ÿåˆ—"
        MQ[Kafka/RabbitMQ<br/>å¼‚æ­¥å¤„ç†]
    end

    subgraph "æ•°æ®åº“å±‚"
        PGM[(PostgreSQL 18<br/>ä¸»åº“<br/>å†™)]
        PGS1[(PostgreSQL 18<br/>ä»åº“1<br/>è¯»)]
        PGS2[(PostgreSQL 18<br/>ä»åº“2<br/>è¯»)]
    end

    Mobile --> CDN
    Web --> CDN
    H5 --> CDN
    CDN --> LB
    LB --> API
    API --> App1
    API --> App2
    API --> App10

    App1 --> Redis1
    App1 --> Redis2
    App1 --> Redis3
    App2 --> Redis1
    App2 --> Redis2

    App1 --> MQ
    App2 --> MQ

    App1 --> PGM
    App1 --> PGS1
    App1 --> PGS2
    App2 --> PGM
    App2 --> PGS1

    Redis1 --> RedisS1
    Redis2 --> RedisS2
    Redis3 --> RedisS3

    PGM --> PGS1
    PGM --> PGS2

    style PGM fill:#ff6b6b
    style PGS1 fill:#90ee90
    style PGS2 fill:#90ee90
    style Redis1 fill:#ffd700
    style Redis2 fill:#ffd700
    style Redis3 fill:#ffd700
```

### 1.2 æ¶æ„ç‰¹ç‚¹

| å±‚æ¬¡ | ä½œç”¨ | å…³é”®æŠ€æœ¯ | PostgreSQL 18ç‰¹æ€§ |
| --- | --- | --- | --- |
| **CDNå±‚** | é™æ€èµ„æºåŠ é€Ÿ | CDN | - |
| **æ¥å…¥å±‚** | æµé‡æ§åˆ¶ | Nginxé™æµã€APIç½‘å…³ | - |
| **åº”ç”¨å±‚** | ä¸šåŠ¡é€»è¾‘ | å¾®æœåŠ¡ã€é™æµç†”æ–­ | å†…ç½®è¿æ¥æ±  |
| **ç¼“å­˜å±‚** | çƒ­ç‚¹æ•°æ® | Redisé›†ç¾¤ | - |
| **æ¶ˆæ¯é˜Ÿåˆ—** | å¼‚æ­¥è§£è€¦ | Kafka | - |
| **æ•°æ®åº“å±‚** | æŒä¹…åŒ–å­˜å‚¨ | PostgreSQL 18 | å¼‚æ­¥I/Oã€è¿æ¥æ± ã€MVCC |

### 1.3 è¯·æ±‚æµç¨‹

**æ­£å¸¸ç§’æ€æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant CDN as CDN
    participant API as APIç½‘å…³
    participant APP as åº”ç”¨æœåŠ¡
    participant Redis as Redis
    participant MQ as æ¶ˆæ¯é˜Ÿåˆ—
    participant PG as PostgreSQL 18

    U->>CDN: 1. è®¿é—®ç§’æ€é¡µé¢
    CDN-->>U: è¿”å›é™æ€é¡µé¢

    U->>API: 2. ç‚¹å‡»ç§’æ€æŒ‰é’®
    API->>API: é™æµæ£€æŸ¥
    API->>APP: 3. è½¬å‘è¯·æ±‚

    APP->>Redis: 4. æ£€æŸ¥Redisåº“å­˜
    alt Redisåº“å­˜å……è¶³
        APP->>Redis: 5. é¢„æ‰£Redisåº“å­˜
        Redis-->>APP: æ‰£å‡æˆåŠŸ

        APP->>MQ: 6. å‘é€è®¢å•æ¶ˆæ¯
        MQ-->>APP: ACK

        APP-->>U: 7. è¿”å›"æŠ¢è´­æˆåŠŸ"

        Note over MQ,PG: å¼‚æ­¥å¤„ç†
        MQ->>APP: 8. æ¶ˆè´¹æ¶ˆæ¯
        APP->>PG: 9. åˆ›å»ºè®¢å•+æ‰£å‡åº“å­˜
        PG-->>APP: 10. äº‹åŠ¡æäº¤
    else Redisåº“å­˜ä¸è¶³
        Redis-->>APP: åº“å­˜ä¸è¶³
        APP-->>U: è¿”å›"å·²å”®ç½„"
    end
```

---

## äºŒã€åˆ†å±‚æ¶æ„è®¾è®¡

### 2.1 æ¥å…¥å±‚è®¾è®¡

**é™æµç­–ç•¥**ï¼š

```nginx
# Nginxé…ç½®
http {
    # é™åˆ¶æ¯ç§’è¯·æ±‚æ•°
    limit_req_zone $binary_remote_addr zone=seckill:10m rate=10r/s;

    # é™åˆ¶è¿æ¥æ•°
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    upstream seckill_backend {
        server app1:8080 weight=1 max_fails=3 fail_timeout=30s;
        server app2:8080 weight=1 max_fails=3 fail_timeout=30s;
        server app3:8080 weight=1 max_fails=3 fail_timeout=30s;
        # ... 10å°åº”ç”¨æœåŠ¡å™¨

        keepalive 1000;  # è¿æ¥æ± 
    }

    server {
        listen 80;

        location /api/seckill {
            # é™æµï¼šæ¯ç§’10ä¸ªè¯·æ±‚ï¼Œçªå‘20ä¸ª
            limit_req zone=seckill burst=20 nodelay;

            # é™åˆ¶å¹¶å‘è¿æ¥
            limit_conn addr 10;

            proxy_pass http://seckill_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
}
```

**APIç½‘å…³é…ç½®**ï¼š

```yaml
# API Gatewayé…ç½®ï¼ˆSpring Cloud Gatewayç¤ºä¾‹ï¼‰
spring:
  cloud:
    gateway:
      routes:
        - id: seckill
          uri: lb://seckill-service
          predicates:
            - Path=/api/seckill/**
          filters:
            # é™æµ
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10000  # ä»¤ç‰Œæ¡¶ï¼šæ¯ç§’10000ä¸ªä»¤ç‰Œ
                redis-rate-limiter.burstCapacity: 20000  # æ¡¶å®¹é‡

            # ç†”æ–­
            - name: CircuitBreaker
              args:
                name: seckillCircuitBreaker
                fallbackUri: forward:/fallback/seckill

            # é‡è¯•
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY
```

### 2.2 åº”ç”¨å±‚è®¾è®¡

**æ ¸å¿ƒæœåŠ¡**ï¼š

```mermaid
graph TB
    subgraph "ç§’æ€æœåŠ¡"
        SeckillAPI[ç§’æ€API]
        InventoryCheck[åº“å­˜æ£€æŸ¥]
        OrderCreate[è®¢å•åˆ›å»º]
        PaymentProcess[æ”¯ä»˜å¤„ç†]
    end

    subgraph "åŸºç¡€æœåŠ¡"
        UserService[ç”¨æˆ·æœåŠ¡]
        ProductService[å•†å“æœåŠ¡]
        NotificationService[é€šçŸ¥æœåŠ¡]
    end

    SeckillAPI --> InventoryCheck
    SeckillAPI --> OrderCreate
    OrderCreate --> PaymentProcess

    SeckillAPI --> UserService
    SeckillAPI --> ProductService
    OrderCreate --> NotificationService
```

**ç§’æ€æœåŠ¡æ ¸å¿ƒä»£ç **ï¼ˆJavaç¤ºä¾‹ï¼‰ï¼š

```java
@Service
public class SeckillService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    @Autowired
    private KafkaTemplate<String, SeckillOrder> kafkaTemplate;

    @Autowired
    private SeckillMapper seckillMapper;

    /**
     * ç§’æ€æ¥å£ï¼ˆåŒæ­¥éƒ¨åˆ†ï¼‰
     */
    public SeckillResult seckill(Long saleId, Long userId) {
        // 1. åŸºç¡€æ ¡éªŒ
        if (!validateUser(userId)) {
            return SeckillResult.fail("ç”¨æˆ·æœªç™»å½•");
        }

        // 2. æ£€æŸ¥æ˜¯å¦å·²æŠ¢è´­
        String userKey = "seckill:user:" + saleId + ":" + userId;
        if (redisTemplate.hasKey(userKey)) {
            return SeckillResult.fail("å·²æŠ¢è´­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ");
        }

        // 3. Redisé¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        String stockKey = "seckill:stock:" + saleId;
        Long remaining = (Long) redisTemplate.execute(
            stockDeductScript,  // Luaè„šæœ¬
            Collections.singletonList(stockKey),
            1  // æ‰£å‡æ•°é‡
        );

        if (remaining == null || remaining < 0) {
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }

        // 4. è®°å½•ç”¨æˆ·å·²æŠ¢è´­ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        redisTemplate.opsForValue().set(userKey, "1", 30, TimeUnit.MINUTES);

        // 5. å‘é€æ¶ˆæ¯åˆ°Kafkaï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
        SeckillOrder order = new SeckillOrder(saleId, userId);
        kafkaTemplate.send("seckill-orders", order);

        // 6. ç«‹å³è¿”å›
        return SeckillResult.success("æŠ¢è´­æˆåŠŸï¼Œè¯·åœ¨30åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜");
    }

    /**
     * Luaè„šæœ¬ï¼šåŸå­æ€§æ‰£å‡åº“å­˜
     */
    private static final String LUA_STOCK_DEDUCT =
        "local stock = redis.call('get', KEYS[1])\n" +
        "if stock == false or tonumber(stock) < tonumber(ARGV[1]) then\n" +
        "    return -1\n" +
        "end\n" +
        "return redis.call('decrby', KEYS[1], ARGV[1])";

    /**
     * å¼‚æ­¥æ¶ˆè´¹ï¼šåˆ›å»ºè®¢å•å¹¶æ‰£å‡æ•°æ®åº“åº“å­˜
     */
    @KafkaListener(topics = "seckill-orders")
    public void consumeOrder(SeckillOrder order) {
        try {
            // åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®¢å•å¹¶æ‰£å‡åº“å­˜ï¼ˆä¸€ä¸ªäº‹åŠ¡ï¼‰
            seckillMapper.createOrderAndDeductStock(order);

            // å‘é€é€šçŸ¥
            notifyUser(order.getUserId(), "æŠ¢è´­æˆåŠŸ");
        } catch (Exception e) {
            // å¤±è´¥å›æ»šRedisåº“å­˜
            String stockKey = "seckill:stock:" + order.getSaleId();
            redisTemplate.opsForValue().increment(stockKey, 1);

            log.error("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
}
```

### 2.3 ç¼“å­˜å±‚è®¾è®¡

**Redisæ¶æ„**ï¼š

```text
Redisé›†ç¾¤ï¼ˆ3ä¸»3ä»ï¼‰
â”œâ”€â”€ ä¸»èŠ‚ç‚¹1ï¼ˆåº“å­˜æ•°æ®ï¼‰
â”‚   â””â”€â”€ ä»èŠ‚ç‚¹1
â”œâ”€â”€ ä¸»èŠ‚ç‚¹2ï¼ˆç”¨æˆ·æ•°æ®ï¼‰
â”‚   â””â”€â”€ ä»èŠ‚ç‚¹2
â””â”€â”€ ä¸»èŠ‚ç‚¹3ï¼ˆå•†å“æ•°æ®ï¼‰
    â””â”€â”€ ä»èŠ‚ç‚¹3

æ•°æ®åˆ†ç‰‡ç­–ç•¥ï¼šæŒ‰sale_idå“ˆå¸Œ
```

**ç¼“å­˜æ•°æ®ç»“æ„**ï¼š

```redis
# åº“å­˜æ•°æ®ï¼ˆStringç±»å‹ï¼‰
seckill:stock:{sale_id} = 1000

# ç”¨æˆ·æŠ¢è´­è®°å½•ï¼ˆStringç±»å‹ï¼Œ30åˆ†é’Ÿè¿‡æœŸï¼‰
seckill:user:{sale_id}:{user_id} = 1

# ç§’æ€æ´»åŠ¨ä¿¡æ¯ï¼ˆHashç±»å‹ï¼‰
seckill:info:{sale_id}
  - product_id: 12345
  - price: 99.00
  - start_time: 1733299200
  - end_time: 1733302800
  - status: active

# åº“å­˜é¢„è­¦ï¼ˆSorted Setï¼‰
seckill:stock:monitor
  score: å½“å‰åº“å­˜, member: sale_id
```

**ç¼“å­˜é¢„çƒ­è„šæœ¬**ï¼š

```python
import redis
import psycopg2

# è¿æ¥Rediså’ŒPostgreSQL
r = redis.Redis(host='localhost', port=6379, db=0)
conn = psycopg2.connect("dbname=seckill user=postgres")

def preheat_cache():
    """æ´»åŠ¨å¼€å§‹å‰é¢„çƒ­ç¼“å­˜"""
    cur = conn.cursor()

    # æŸ¥è¯¢å³å°†å¼€å§‹çš„ç§’æ€æ´»åŠ¨
    cur.execute("""
        SELECT sale_id, product_id, flash_price, total_stock, start_time, end_time
        FROM flash_sales
        WHERE status = 'pending'
          AND start_time > NOW()
          AND start_time < NOW() + INTERVAL '1 hour'
    """)

    for row in cur.fetchall():
        sale_id, product_id, price, stock, start_time, end_time = row

        # è®¾ç½®åº“å­˜
        r.set(f"seckill:stock:{sale_id}", stock)

        # è®¾ç½®æ´»åŠ¨ä¿¡æ¯
        r.hset(f"seckill:info:{sale_id}", mapping={
            'product_id': product_id,
            'price': str(price),
            'start_time': int(start_time.timestamp()),
            'end_time': int(end_time.timestamp()),
            'status': 'active'
        })

        # æ·»åŠ åˆ°ç›‘æ§é˜Ÿåˆ—
        r.zadd('seckill:stock:monitor', {sale_id: stock})

        print(f"é¢„çƒ­å®Œæˆ: sale_id={sale_id}, stock={stock}")

    cur.close()

if __name__ == '__main__':
    preheat_cache()
```

### 2.4 æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

**Kafkaé…ç½®**ï¼š

```yaml
# Kafka Topicsè®¾è®¡
topics:
  # ç§’æ€è®¢å•ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
  - name: seckill-orders
    partitions: 32  # 32ä¸ªåˆ†åŒºï¼Œæ”¯æŒé«˜å¹¶å‘
    replication-factor: 3
    retention-ms: 86400000  # ä¿ç•™1å¤©

  # è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥
  - name: order-paid
    partitions: 16
    replication-factor: 3

  # è®¢å•è¶…æ—¶æœªæ”¯ä»˜
  - name: order-timeout
    partitions: 8
    replication-factor: 3
```

**æ¶ˆè´¹è€…é…ç½®**ï¼š

```java
@Configuration
public class KafkaConsumerConfig {

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, SeckillOrder>
        kafkaListenerContainerFactory() {

        ConcurrentKafkaListenerContainerFactory<String, SeckillOrder> factory =
            new ConcurrentKafkaListenerContainerFactory<>();

        factory.setConsumerFactory(consumerFactory());

        // å¹¶å‘æ¶ˆè´¹è€…æ•°é‡ï¼ˆæ¯ä¸ªåˆ†åŒº1ä¸ªï¼‰
        factory.setConcurrency(32);

        // æ‰¹é‡æ¶ˆè´¹
        factory.setBatchListener(true);
        factory.getContainerProperties().setAckMode(AckMode.BATCH);

        // é”™è¯¯å¤„ç†
        factory.setErrorHandler(new SeekToCurrentErrorHandler(
            new DeadLetterPublishingRecoverer(kafkaTemplate()),
            new FixedBackOff(1000L, 3L)  // é‡è¯•3æ¬¡
        ));

        return factory;
    }
}
```

---

## ä¸‰ã€æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 åº“å­˜æ‰£å‡è®¾è®¡

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- |
| **Redisé¢„æ‰£+å¼‚æ­¥** | æ€§èƒ½é«˜ã€å“åº”å¿« | éœ€è¦æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ | â­æ¨èï¼ˆç§’æ€ï¼‰ |
| **æ•°æ®åº“æ‚²è§‚é”** | å¼ºä¸€è‡´æ€§ | æ€§èƒ½ä½ã€é”ç«äº‰ä¸¥é‡ | ä½å¹¶å‘åœºæ™¯ |
| **æ•°æ®åº“ä¹è§‚é”** | æ— é”ç­‰å¾… | é«˜å¹¶å‘ä¸‹å¤±è´¥ç‡é«˜ | ä¸­å¹¶å‘åœºæ™¯ |

**æ¨èæ–¹æ¡ˆï¼šRedisé¢„æ‰£+å¼‚æ­¥å…¥åº“**:

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as åº”ç”¨
    participant Redis as Redis
    participant MQ as Kafka
    participant Worker as å¼‚æ­¥Worker
    participant PG as PostgreSQL 18

    User->>App: ç§’æ€è¯·æ±‚
    App->>Redis: é¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ï¼‰
    Redis-->>App: æ‰£å‡æˆåŠŸ
    App-->>User: ç«‹å³è¿”å›"æˆåŠŸ"ï¼ˆ100mså†…ï¼‰

    App->>MQ: å‘é€è®¢å•æ¶ˆæ¯

    Note over Worker,PG: å¼‚æ­¥å¤„ç†ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰

    MQ->>Worker: æ¶ˆè´¹æ¶ˆæ¯
    Worker->>PG: BEGIN TRANSACTION
    Worker->>PG: åˆ›å»ºè®¢å•
    Worker->>PG: æ‰£å‡æ•°æ®åº“åº“å­˜
    Worker->>PG: COMMIT

    alt æ•°æ®åº“æ‰£å‡å¤±è´¥
        Worker->>Redis: å›æ»šRedisåº“å­˜
        Worker->>User: å‘é€å¤±è´¥é€šçŸ¥
    end
```

**Luaè„šæœ¬ï¼ˆåŸå­æ€§æ‰£å‡ï¼‰**ï¼š

```lua
-- deduct_stock.lua
-- KEYS[1]: åº“å­˜key
-- ARGV[1]: æ‰£å‡æ•°é‡
-- ARGV[2]: ç”¨æˆ·keyï¼ˆé˜²é‡å¤ï¼‰

local stock_key = KEYS[1]
local user_key = KEYS[2]
local deduct_count = tonumber(ARGV[1])

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æŠ¢è´­
if redis.call('exists', user_key) == 1 then
    return -2  -- å·²æŠ¢è´­
end

-- è·å–å½“å‰åº“å­˜
local stock = redis.call('get', stock_key)
if stock == false then
    return -1  -- æ´»åŠ¨ä¸å­˜åœ¨
end

stock = tonumber(stock)
if stock < deduct_count then
    return 0  -- åº“å­˜ä¸è¶³
end

-- æ‰£å‡åº“å­˜
redis.call('decrby', stock_key, deduct_count)

-- æ ‡è®°ç”¨æˆ·å·²æŠ¢è´­ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
redis.call('setex', user_key, 1800, '1')

-- è¿”å›å‰©ä½™åº“å­˜
return stock - deduct_count
```

### 3.2 é˜²è¶…å–è®¾è®¡

**å¤šé‡ä¿éšœ**ï¼š

```mermaid
graph TB
    A[ç§’æ€è¯·æ±‚] --> B{Redisåº“å­˜æ£€æŸ¥}
    B -->|ä¸è¶³| C[ç›´æ¥è¿”å›å¤±è´¥]
    B -->|å……è¶³| D{RedisåŸå­æ‰£å‡}
    D -->|å¤±è´¥| C
    D -->|æˆåŠŸ| E[å‘é€MQæ¶ˆæ¯]
    E --> F{æ•°æ®åº“äº‹åŠ¡}
    F --> G{åº“å­˜çº¦æŸæ£€æŸ¥}
    G -->|å¤±è´¥| H[å›æ»šRedis<br/>è¿”å›å¤±è´¥]
    G -->|æˆåŠŸ| I[æäº¤äº‹åŠ¡]

    style G fill:#ff6b6b
    style D fill:#ffd700
```

**æ•°æ®åº“å±‚çº¦æŸ**ï¼š

```sql
-- 1. CHECKçº¦æŸï¼šåº“å­˜ä¸èƒ½ä¸ºè´Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ çº¦æŸ';
            RETURN;
        END IF;
        
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.table_constraints
            WHERE table_name = 'flash_sales' AND constraint_name = 'check_remaining_stock_non_negative'
        ) THEN
            ALTER TABLE flash_sales
            ADD CONSTRAINT check_remaining_stock_non_negative
            CHECK (remaining_stock >= 0);
            RAISE NOTICE 'CHECKçº¦æŸæ·»åŠ æˆåŠŸ';
        ELSE
            RAISE NOTICE 'CHECKçº¦æŸå·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'çº¦æŸå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ·»åŠ CHECKçº¦æŸå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ä¹è§‚é”ï¼šversionå­—æ®µï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ åˆ—';
            RETURN;
        END IF;
        
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'flash_sales' AND column_name = 'version'
        ) THEN
            ALTER TABLE flash_sales
            ADD COLUMN version INT DEFAULT 0;
            RAISE NOTICE 'versionåˆ—æ·»åŠ æˆåŠŸ';
        ELSE
            RAISE NOTICE 'versionåˆ—å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_column THEN
            RAISE NOTICE 'åˆ—å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ·»åŠ versionåˆ—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æ‰£å‡åº“å­˜çš„SQLï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_sale_id BIGINT := $1;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_version INT := $2;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_affected_rows INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œåº“å­˜æ‰£å‡';
            RETURN;
        END IF;
        
        UPDATE flash_sales
        SET remaining_stock = remaining_stock - 1,
            version = version + 1,
            updated_at = NOW()
        WHERE sale_id = v_sale_id
          AND remaining_stock > 0  -- åŒé‡æ£€æŸ¥
          AND version = v_version;  -- ä¹è§‚é”
        
        GET DIAGNOSTICS v_affected_rows = ROW_COUNT;
        
        IF v_affected_rows = 0 THEN
            RAISE WARNING 'åº“å­˜æ‰£å‡å¤±è´¥ï¼šåº“å­˜ä¸è¶³æˆ–ç‰ˆæœ¬å†²çª';
        ELSE
            RAISE NOTICE 'åº“å­˜æ‰£å‡æˆåŠŸï¼Œå½±å“è¡Œæ•°: %', v_affected_rows;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åº“å­˜æ‰£å‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. å¦‚æœUPDATEå½±å“è¡Œæ•°=0ï¼Œè¯´æ˜åº“å­˜ä¸è¶³æˆ–ç‰ˆæœ¬å†²çª
-- åº”ç”¨å±‚éœ€è¦æ£€æŸ¥å¹¶å›æ»šRedis
```

### 3.3 é˜²é‡å¤æŠ¢è´­è®¾è®¡

**ä¸‰å±‚é˜²æŠ¤**ï¼š

```java
public boolean checkDuplicate(Long saleId, Long userId) {
    // ç¬¬1å±‚ï¼šRediså¿«é€Ÿæ£€æŸ¥ï¼ˆç¼“å­˜ï¼‰
    String userKey = "seckill:user:" + saleId + ":" + userId;
    if (redisTemplate.hasKey(userKey)) {
        return true;  // å·²æŠ¢è´­
    }

    // ç¬¬2å±‚ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ
    // UNIQUE(sale_id, user_id) åœ¨è¡¨å®šä¹‰ä¸­

    // ç¬¬3å±‚ï¼šåˆ†å¸ƒå¼é”ï¼ˆå¯é€‰ï¼Œç”¨äºæç«¯åœºæ™¯ï¼‰
    String lockKey = "seckill:lock:" + saleId + ":" + userId;
    Boolean acquired = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "1", 5, TimeUnit.SECONDS);

    if (Boolean.FALSE.equals(acquired)) {
        return true;  // æœ‰å…¶ä»–è¯·æ±‚æ­£åœ¨å¤„ç†
    }

    return false;
}
```

---

## å››ã€PostgreSQL 18ç‰¹æ€§åº”ç”¨

### 4.1 å†…ç½®è¿æ¥æ± 

**é—®é¢˜**ï¼šç¬æ—¶10ä¸‡è¯·æ±‚ï¼Œä¼ ç»Ÿè¿æ¥æ± ï¼ˆPgBouncerï¼‰ä»æœ‰å¼€é”€

**PostgreSQL 18è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- postgresql.confé…ç½®ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
-- æ³¨æ„ï¼šä»¥ä¸‹é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®ï¼Œç„¶åé‡å¯PostgreSQL
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE WARNING 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°ï¼Œè·³è¿‡é…ç½®';
            RETURN;
        END IF;

        -- å®é™…é…ç½®éœ€è¦åœ¨postgresql.confä¸­è®¾ç½®ï¼š
        -- builtin_connection_pool = on
        -- max_pool_size = 2000
        -- pool_mode = 'transaction'  -- äº‹åŠ¡çº§è¿æ¥æ± 
        -- pool_connection_timeout = 5000  -- 5ç§’
        -- pool_idle_timeout = 60000  -- 60ç§’

        RAISE NOTICE 'å†…ç½®è¿æ¥æ± é…ç½®è¯´æ˜ï¼šéœ€è¦åœ¨postgresql.confä¸­è®¾ç½®ä¸Šè¿°å‚æ•°';
        RAISE NOTICE 'å†…ç½®è¿æ¥æ± ç‰¹ç‚¹ï¼š1. å‡å°‘è¿æ¥å¼€é”€ 2. æé«˜å¹¶å‘èƒ½åŠ› 3. äº‹åŠ¡çº§è¿æ¥æ± ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®æ£€æŸ¥å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

**æ•ˆæœ**ï¼š

- è¿æ¥å»ºç«‹æ—¶é—´ï¼šä»30msé™åˆ°<1ms
- è¿æ¥å¤ç”¨ç‡ï¼š>95%
- æ”¯æŒå¹¶å‘ï¼š10ä¸‡è¿æ¥â†’2000ç‰©ç†è¿æ¥

### 4.2 å¼‚æ­¥I/O

**åº”ç”¨åœºæ™¯**ï¼šè®¢å•æ‰¹é‡æ’å…¥

```sql
-- æ‰¹é‡åˆ›å»ºè®¢å•ï¼ˆåˆ©ç”¨å¼‚æ­¥I/Oï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_sale_ids BIGINT[] := $1;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_user_ids BIGINT[] := $2;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_product_ids BIGINT[] := $3;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_prices NUMERIC[] := $4;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
    v_inserted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰¹é‡æ’å…¥è®¢å•';
            RETURN;
        END IF;
        
        IF array_length(v_sale_ids, 1) IS NULL OR array_length(v_user_ids, 1) IS NULL THEN
            RAISE EXCEPTION 'æ•°ç»„å‚æ•°ä¸èƒ½ä¸ºç©º';
        END IF;
        
        IF array_length(v_sale_ids, 1) != array_length(v_user_ids, 1) THEN
            RAISE EXCEPTION 'æ•°ç»„é•¿åº¦å¿…é¡»ä¸€è‡´';
        END IF;
        
        INSERT INTO flash_orders (sale_id, user_id, product_id, price, status)
        SELECT
            unnest(v_sale_ids),
            unnest(v_user_ids),
            unnest(v_product_ids),
            unnest(v_prices),
            'pending'
        RETURNING order_id;
        
        GET DIAGNOSTICS v_inserted_count = ROW_COUNT;
        RAISE NOTICE 'æ‰¹é‡æ’å…¥æˆåŠŸï¼Œæ’å…¥è¡Œæ•°: %', v_inserted_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡æ’å…¥è®¢å•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- PostgreSQL 18è‡ªåŠ¨ä½¿ç”¨å¼‚æ­¥I/O
-- æ‰¹é‡æ’å…¥10000è¡Œï¼šä»5ç§’é™åˆ°1.5ç§’ï¼ˆ-70%ï¼‰
```

### 4.3 æ”¹è¿›çš„VACUUM

**é—®é¢˜**ï¼šç§’æ€åå¤§é‡è®¢å•åˆ é™¤/æ›´æ–°ï¼Œè¡¨è†¨èƒ€

**PostgreSQL 18ä¼˜åŒ–**ï¼š

```sql
-- é…ç½®è‡ªåŠ¨VACUUMï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®VACUUM';
            RETURN;
        END IF;
        
        ALTER TABLE flash_orders SET (
            autovacuum_vacuum_scale_factor = 0.01,  -- 1%å˜æ›´è§¦å‘
            autovacuum_vacuum_threshold = 1000,
            autovacuum_vacuum_cost_delay = 10  -- é™ä½å½±å“
        );
        
        RAISE NOTICE 'VACUUMé…ç½®æˆåŠŸ';
        RAISE NOTICE 'PostgreSQL 18: VACUUMæ€§èƒ½æå‡30-40%ï¼Œè¡¨è†¨èƒ€ç‡ä»20%é™åˆ°5%';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®VACUUMå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.4 æ”¹è¿›çš„ç»Ÿè®¡ä¿¡æ¯

```sql
-- PostgreSQL 18ï¼šå¤šå˜é‡ç»Ÿè®¡è‡ªåŠ¨æ¨èï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ¨è';
            RETURN;
        END IF;
        
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stats_ext_recommendations
LIMIT 100;

-- åˆ›å»ºæ¨èçš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        
        IF NOT EXISTS (
            SELECT 1 FROM pg_statistic_ext WHERE stxname = 'flash_orders_stats'
        ) THEN
            CREATE STATISTICS flash_orders_stats (dependencies, ndistinct)
            ON sale_id, created_at FROM flash_orders;
            RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯å·²å­˜åœ¨';
        END IF;
        
        ANALYZE flash_orders;
        RAISE NOTICE 'ANALYZEæ‰§è¡ŒæˆåŠŸï¼Œå¤æ‚æŸ¥è¯¢è®¡åˆ’è´¨é‡æå‡20-40%';
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.5 pg_statç›‘æ§å¢å¼º

```sql
-- PostgreSQL 18æ–°å¢çš„ç›‘æ§æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹PostgreSQL 18æ–°å¢çš„ç›‘æ§æŒ‡æ ‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    relname,
    last_autovacuum,
    autovacuum_count,
    autovacuum_elapsed_time,  -- PostgreSQL 18æ–°å¢
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup
FROM pg_stat_all_tables
WHERE schemaname = 'public'
  AND relname LIKE 'flash_%'
LIMIT 100;

-- å®æ—¶ç›‘æ§ç§’æ€æ´»åŠ¨çš„æ•°æ®åº“çŠ¶æ€
```

---

## äº”ã€é«˜å¯ç”¨è®¾è®¡

### 5.1 æ•°æ®åº“é«˜å¯ç”¨

**æ¶æ„**ï¼š

```text
ä¸»åº“ï¼ˆå†™ï¼‰
  â”œâ”€â”€ æµå¤åˆ¶ â†’ ä»åº“1ï¼ˆè¯»ï¼‰
  â”œâ”€â”€ æµå¤åˆ¶ â†’ ä»åº“2ï¼ˆè¯»ï¼‰
  â””â”€â”€ é€»è¾‘å¤åˆ¶ â†’ å¤‡ç”¨åº“ï¼ˆå¼‚åœ°ï¼‰

è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šPatroni + etcd
```

**Patronié…ç½®**ï¼š

```yaml
# patroni.yml
scope: seckill-cluster
name: pg-node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: pg-node1:8008

etcd:
  hosts: etcd1:2379,etcd2:2379,etcd3:2379

bootstrap:
  dcs:
    postgresql:
      use_pg_rewind: true
      parameters:
        max_connections: 2000
        shared_buffers: 64GB
        effective_cache_size: 192GB
        maintenance_work_mem: 2GB

        # PostgreSQL 18ç‰¹æ€§
        builtin_connection_pool: on
        aio_enabled: on

  initdb:
    - encoding: UTF8
    - locale: C

postgresql:
  listen: 0.0.0.0:5432
  connect_address: pg-node1:5432
  data_dir: /var/lib/postgresql/18/main

  authentication:
    replication:
      username: replicator
      password: xxx
    superuser:
      username: postgres
      password: xxx

  parameters:
    wal_level: replica
    max_wal_senders: 10
    max_replication_slots: 10
```

### 5.2 è¯»å†™åˆ†ç¦»

**è¿æ¥è·¯ç”±**ï¼š

```java
@Configuration
public class DataSourceConfig {

    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();

        // å†™åº“ï¼ˆä¸»åº“ï¼‰
        config.setJdbcUrl("jdbc:postgresql://pg-master:5432/seckill");
        config.setMaximumPoolSize(500);

        return new HikariDataSource(config);
    }

    @Bean
    public DataSource readDataSource() {
        HikariConfig config = new HikariConfig();

        // è¯»åº“ï¼ˆä»åº“ï¼Œè´Ÿè½½å‡è¡¡ï¼‰
        config.setJdbcUrl("jdbc:postgresql://pg-slave-lb:5432/seckill");
        config.setMaximumPoolSize(1000);
        config.setReadOnly(true);

        return new HikariDataSource(config);
    }

    @Bean
    public DataSource routingDataSource() {
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("write", dataSource());
        targetDataSources.put("read", readDataSource());

        RoutingDataSource routing = new RoutingDataSource();
        routing.setTargetDataSources(targetDataSources);
        routing.setDefaultTargetDataSource(dataSource());

        return routing;
    }
}
```

### 5.3 å®¹ç¾è®¾è®¡

**RPO/RTOç›®æ ‡**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡ | å®ç°æ–¹å¼ |
| --- | --- | --- |
| RPO | 0ç§’ | åŒæ­¥æµå¤åˆ¶ |
| RTO | <30ç§’ | è‡ªåŠ¨æ•…éšœè½¬ç§» |
| æ•°æ®ä¸­å¿ƒæ•…éšœ | <5åˆ†é’Ÿ | å¼‚åœ°é€»è¾‘å¤åˆ¶ |

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 æ•°æ®åº“å±‚ä¼˜åŒ–

```sql
-- 1. ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œè·³è¿‡ç´¢å¼•åˆ›å»º';
        ELSIF NOT EXISTS (
            SELECT 1 FROM pg_indexes WHERE indexname = 'idx_flash_sales_time'
        ) THEN
            CREATE INDEX CONCURRENTLY idx_flash_sales_time
            ON flash_sales(start_time, end_time)
            WHERE status IN ('pending', 'active');
            RAISE NOTICE 'ç´¢å¼• idx_flash_sales_time åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_flash_sales_time å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œè·³è¿‡ç´¢å¼•åˆ›å»º';
        ELSIF NOT EXISTS (
            SELECT 1 FROM pg_indexes WHERE indexname = 'idx_flash_orders_user'
        ) THEN
            CREATE INDEX CONCURRENTLY idx_flash_orders_user
            ON flash_orders(user_id, created_at DESC);
            RAISE NOTICE 'ç´¢å¼• idx_flash_orders_user åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_flash_orders_user å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¥æœŸåˆ†åŒºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'è¡¨ flash_orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒºè¡¨';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders_partitioned') THEN
            CREATE TABLE flash_orders_partitioned (
                LIKE flash_orders INCLUDING ALL
            ) PARTITION BY RANGE (created_at);
            RAISE NOTICE 'åˆ†åŒºè¡¨ flash_orders_partitioned åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'åˆ†åŒºè¡¨ flash_orders_partitioned å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders_2025_12') THEN
            CREATE TABLE flash_orders_2025_12 PARTITION OF flash_orders_partitioned
                FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
            RAISE NOTICE 'åˆ†åŒº flash_orders_2025_12 åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'åˆ†åŒº flash_orders_2025_12 å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨æˆ–åˆ†åŒºå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. è¡¨ç©ºé—´åˆ†ç¦»ï¼ˆçƒ­æ•°æ®vså†·æ•°æ®ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'hot') THEN
            -- æ³¨æ„ï¼šéœ€è¦ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æƒé™
            CREATE TABLESPACE hot LOCATION '/data/nvme/hot';
            RAISE NOTICE 'è¡¨ç©ºé—´ hot åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ hot å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'cold') THEN
            CREATE TABLESPACE cold LOCATION '/data/ssd/cold';
            RAISE NOTICE 'è¡¨ç©ºé—´ cold åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ cold å·²å­˜åœ¨';
        END IF;
        
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            ALTER TABLE flash_sales SET TABLESPACE hot;
            RAISE NOTICE 'è¡¨ flash_sales å·²ç§»åŠ¨åˆ° hot è¡¨ç©ºé—´';
        END IF;
        
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders_2025_12') THEN
            ALTER TABLE flash_orders_2025_12 SET TABLESPACE hot;
            RAISE NOTICE 'è¡¨ flash_orders_2025_12 å·²ç§»åŠ¨åˆ° hot è¡¨ç©ºé—´';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´æˆ–ç§»åŠ¨è¡¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è¡¨ç©ºé—´æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 6.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨PostgreSQL 18çš„å‡†å¤‡è¯­å¥ç¼“å­˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œæ— æ³•å‡†å¤‡è¯­å¥';
            RETURN;
        END IF;
        
        -- å‡†å¤‡è¯­å¥ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰
        PREPARE get_sale_info (bigint) AS
        SELECT sale_id, product_id, flash_price, remaining_stock, status
        FROM flash_sales
        WHERE sale_id = $1 AND status = 'active';
        
        RAISE NOTICE 'å‡†å¤‡è¯­å¥ get_sale_info åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_prepared_statement THEN
            RAISE NOTICE 'å‡†å¤‡è¯­å¥å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡†å¤‡è¯­å¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰§è¡Œï¼ˆåˆ©ç”¨è®¡åˆ’ç¼“å­˜ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXECUTE get_sale_info(12345);

-- æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_sale_ids BIGINT[] := $1;  -- å®é™…ä½¿ç”¨æ—¶ä»å‚æ•°ä¼ å…¥
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') THEN
            RAISE WARNING 'è¡¨ flash_sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ‰¹é‡æŸ¥è¯¢';
            RETURN;
        END IF;
        
        IF v_sale_ids IS NULL OR array_length(v_sale_ids, 1) IS NULL THEN
            RAISE EXCEPTION 'sale_idsæ•°ç»„ä¸èƒ½ä¸ºç©º';
        END IF;
        
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ‰¹é‡æŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM flash_sales
WHERE sale_id = ANY($1::bigint[])  -- æ•°ç»„å‚æ•°
  AND status = 'active';
```

### 6.3 é…ç½®ä¼˜åŒ–

```ini
# postgresql.conf - ç§’æ€åœºæ™¯ä¼˜åŒ–

# è¿æ¥
max_connections = 2000
builtin_connection_pool = on  # PostgreSQL 18

# å†…å­˜
shared_buffers = 64GB
effective_cache_size = 192GB
work_mem = 32MB
maintenance_work_mem = 2GB

# å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
aio_enabled = on
max_aio_events = 1000

# WAL
wal_level = replica
max_wal_size = 16GB
min_wal_size = 4GB
checkpoint_completion_target = 0.9

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1  # NVMe SSD
effective_io_concurrency = 200
max_parallel_workers = 16
max_parallel_workers_per_gather = 4

# ç»Ÿè®¡ä¿¡æ¯
default_statistics_target = 100
```

---

## ä¸ƒã€ç›‘æ§ä¸å‘Šè­¦

### 7.1 å…³é”®æŒ‡æ ‡

```sql
-- ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_sales') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'flash_orders') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç›‘æ§è§†å›¾';
            RETURN;
        END IF;
        
        DROP VIEW IF EXISTS seckill_monitor;
        CREATE VIEW seckill_monitor AS
        SELECT
            s.sale_id,
            s.remaining_stock,
            s.total_stock,
            (s.total_stock - s.remaining_stock) as sold_count,
            COUNT(o.order_id) as order_count,
            COUNT(o.order_id) FILTER (WHERE o.status = 'paid') as paid_count,
            AVG(EXTRACT(EPOCH FROM (o.paid_at - o.created_at))) as avg_pay_time
        FROM flash_sales s
        LEFT JOIN flash_orders o ON s.sale_id = o.sale_id
        WHERE s.status = 'active'
        GROUP BY s.sale_id, s.remaining_stock, s.total_stock;
        
        RAISE NOTICE 'ç›‘æ§è§†å›¾ seckill_monitor åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç›‘æ§è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM seckill_monitor
LIMIT 100;
GROUP BY s.sale_id, s.remaining_stock, s.total_stock;
```

### 7.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: seckill
    rules:
      # æ•°æ®åº“è¿æ¥æ•°å‘Šè­¦
      - alert: HighDatabaseConnections
        expr: pg_stat_database_numbackends > 1800
        for: 1m
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"

      # Redisåº“å­˜ä¸ä¸€è‡´å‘Šè­¦
      - alert: StockInconsistency
        expr: abs(redis_stock - pg_stock) > 10
        for: 30s
        annotations:
          summary: "Redisä¸æ•°æ®åº“åº“å­˜ä¸ä¸€è‡´"

      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: SlowResponse
        expr: http_request_duration_p99 > 500
        for: 1m
        annotations:
          summary: "å“åº”æ—¶é—´è¶…è¿‡500ms"
```

---

**ä¸‹ä¸€æ­¥**: [03-æ•°æ®åº“è®¾è®¡.md](./03-æ•°æ®åº“è®¾è®¡.md)

**æ–‡æ¡£åˆ›å»º**: 2025-12-04
**ç»´æŠ¤è€…**: DataBaseTheoryå›¢é˜Ÿ
