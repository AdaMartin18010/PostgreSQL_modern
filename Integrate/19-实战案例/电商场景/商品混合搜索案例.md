---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\ç”µå•†åœºæ™¯\å•†å“æ··åˆæœç´¢æ¡ˆä¾‹.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å•†å“æ··åˆæœç´¢

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-01-01

## ğŸ“‘ ç›®å½•

- [å•†å“æ··åˆæœç´¢](#å•†å“æ··åˆæœç´¢)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
    - [1.1 æ¡ˆä¾‹èƒŒæ™¯](#11-æ¡ˆä¾‹èƒŒæ™¯)
    - [1.2 ä¸šåŠ¡ä»·å€¼](#12-ä¸šåŠ¡ä»·å€¼)
    - [1.3 æŠ€æœ¯äº®ç‚¹](#13-æŠ€æœ¯äº®ç‚¹)
  - [2. ä¸šåŠ¡åœºæ™¯](#2-ä¸šåŠ¡åœºæ™¯)
    - [2.1 é—®é¢˜åˆ†æ](#21-é—®é¢˜åˆ†æ)
    - [2.2 è§£å†³æ–¹æ¡ˆ](#22-è§£å†³æ–¹æ¡ˆ)
    - [2.3 æŠ€æœ¯é€‰å‹](#23-æŠ€æœ¯é€‰å‹)
  - [3. æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
    - [3.1 å•†å“æ··åˆæœç´¢ä½“ç³»æ€ç»´å¯¼å›¾](#31-å•†å“æ··åˆæœç´¢ä½“ç³»æ€ç»´å¯¼å›¾)
    - [3.2 æ•´ä½“æ¶æ„](#32-æ•´ä½“æ¶æ„)
    - [3.3 æ•°æ®æµè®¾è®¡](#33-æ•°æ®æµè®¾è®¡)
    - [3.4 æŸ¥è¯¢æµç¨‹è®¾è®¡](#34-æŸ¥è¯¢æµç¨‹è®¾è®¡)
  - [4. å®ç°ç»†èŠ‚](#4-å®ç°ç»†èŠ‚)
    - [4.1 æ•°æ®æ¨¡å‹è®¾è®¡](#41-æ•°æ®æ¨¡å‹è®¾è®¡)
      - [4.1.0 æ•°æ®æ¨¡å‹ERå›¾](#410-æ•°æ®æ¨¡å‹erå›¾)
      - [4.1.1 å•†å“è¡¨è®¾è®¡](#411-å•†å“è¡¨è®¾è®¡)
    - [4.2 å‘é‡ç”Ÿæˆæµç¨‹](#42-å‘é‡ç”Ÿæˆæµç¨‹)
    - [4.3 æ··åˆæœç´¢å®ç°](#43-æ··åˆæœç´¢å®ç°)
    - [4.4 API æ¥å£å®ç°](#44-api-æ¥å£å®ç°)
  - [5. æ€§èƒ½åˆ†æ](#5-æ€§èƒ½åˆ†æ)
    - [5.1 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#51-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
    - [5.2 æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”](#52-æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”)
      - [5.2.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”](#521-æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”)
      - [5.1.2 ä¸šåŠ¡æŒ‡æ ‡å¯¹æ¯”](#512-ä¸šåŠ¡æŒ‡æ ‡å¯¹æ¯”)
    - [5.3 ä¸šåŠ¡æ•ˆæœåˆ†æ](#53-ä¸šåŠ¡æ•ˆæœåˆ†æ)
      - [5.2.1 è½¬åŒ–ç‡æå‡åˆ†æ](#521-è½¬åŒ–ç‡æå‡åˆ†æ)
      - [5.2.2 ç”¨æˆ·ä½“éªŒæå‡åˆ†æ](#522-ç”¨æˆ·ä½“éªŒæå‡åˆ†æ)
    - [5.4 æˆæœ¬æ•ˆç›Šåˆ†æ](#54-æˆæœ¬æ•ˆç›Šåˆ†æ)
      - [5.3.1 æŠ€æœ¯æˆæœ¬](#531-æŠ€æœ¯æˆæœ¬)
      - [5.3.2 ä¸šåŠ¡æ”¶ç›Š](#532-ä¸šåŠ¡æ”¶ç›Š)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 å‘é‡è´¨é‡ä¼˜åŒ–](#61-å‘é‡è´¨é‡ä¼˜åŒ–)
    - [6.2 ç´¢å¼•ä¼˜åŒ–](#62-ç´¢å¼•ä¼˜åŒ–)
    - [6.3 ç¼“å­˜ç­–ç•¥](#63-ç¼“å­˜ç­–ç•¥)
    - [6.4 ç›‘æ§ä¸å‘Šè­¦](#64-ç›‘æ§ä¸å‘Šè­¦)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 æŠ€æœ¯æ–‡æ¡£](#72-æŠ€æœ¯æ–‡æ¡£)
    - [7.3 ç›¸å…³èµ„æº](#73-ç›¸å…³èµ„æº)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 æ··åˆæœç´¢æ€§èƒ½ç›¸å…³é—®é¢˜](#81-æ··åˆæœç´¢æ€§èƒ½ç›¸å…³é—®é¢˜)
      - [Q1: å¦‚ä½•ä¼˜åŒ–æ··åˆæœç´¢æŸ¥è¯¢æ€§èƒ½ï¼Ÿ](#q1-å¦‚ä½•ä¼˜åŒ–æ··åˆæœç´¢æŸ¥è¯¢æ€§èƒ½)
      - [Q2: å¦‚ä½•æå‡æ··åˆæœç´¢å‡†ç¡®ç‡ï¼Ÿ](#q2-å¦‚ä½•æå‡æ··åˆæœç´¢å‡†ç¡®ç‡)
    - [8.2 æ··åˆæœç´¢ç®—æ³•ç›¸å…³é—®é¢˜](#82-æ··åˆæœç´¢ç®—æ³•ç›¸å…³é—®é¢˜)
      - [Q3: å¦‚ä½•å¤„ç†é•¿å°¾å•†å“æœç´¢ï¼Ÿ](#q3-å¦‚ä½•å¤„ç†é•¿å°¾å•†å“æœç´¢)
  - [9. å®Œæ•´ä»£ç ç¤ºä¾‹](#9-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 å•†å“è¡¨åˆ›å»ºï¼ˆå‘é‡+å…¨æ–‡æœç´¢ï¼‰](#81-å•†å“è¡¨åˆ›å»ºå‘é‡å…¨æ–‡æœç´¢)
    - [8.2 æ··åˆæœç´¢å®ç°ï¼ˆRRFç®—æ³•ï¼‰](#82-æ··åˆæœç´¢å®ç°rrfç®—æ³•)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

### 1.1 æ¡ˆä¾‹èƒŒæ™¯

**ä¼ä¸šèƒŒæ™¯**:

æŸå¤§å‹ç”µå•†å¹³å°ï¼ˆ2025 å¹´ 11 æœˆæ•°æ®ï¼‰ï¼š

- **å•†å“æ•°é‡**: 120 ä¸‡ä»¶å•†å“
- **æ—¥æ´»è·ƒç”¨æˆ·**: 500 ä¸‡
- **æœç´¢ QPS**: 5000 QPSï¼ˆå³°å€¼ 10000 QPSï¼‰
- **è¡Œä¸š**: B2C ç”µå•†å¹³å°
- **æŠ€æœ¯æ ˆ**: PostgreSQL + Node.js + React

**ä¸šåŠ¡ç—›ç‚¹**:

1. **æœç´¢è½¬åŒ–ç‡ä½**: ä¼ ç»Ÿæ–‡æœ¬æœç´¢è½¬åŒ–ç‡ä»… **2.5%**ï¼Œä½äºè¡Œä¸šå¹³å‡æ°´å¹³ï¼ˆ3.5%ï¼‰
1. **ç”¨æˆ·æ„å›¾ç†è§£å·®**: æ— æ³•ç†è§£ç”¨æˆ·è¯­ä¹‰æ„å›¾ï¼Œå¦‚"é€‚åˆå¤å¤©ç©¿çš„è¡£æœ"
1. **é•¿å°¾å•†å“éš¾ä»¥å‘ç°**: å¤§é‡é•¿å°¾å•†å“éš¾ä»¥è¢«ç”¨æˆ·å‘ç°
1. **ç”¨æˆ·ä½“éªŒå·®**: ç”¨æˆ·æ»¡æ„åº¦ä»… 72%ï¼Œä½äºç«å“ï¼ˆ80%ï¼‰

**æŠ€æœ¯æŒ‘æˆ˜**:

1. **æœç´¢ç²¾åº¦**: ä¼ ç»Ÿæ–‡æœ¬æœç´¢æ— æ³•ç†è§£è¯­ä¹‰
1. **å¬å›ç‡**: æœç´¢å¬å›ç‡ä»… 65%ï¼Œéœ€è¦æå‡
1. **æ€§èƒ½è¦æ±‚**: æœç´¢å“åº”æ—¶é—´è¦æ±‚ < 100ms
1. **æˆæœ¬æ§åˆ¶**: éœ€è¦åœ¨æ€§èƒ½å’Œæˆæœ¬ä¹‹é—´å¹³è¡¡

### 1.2 ä¸šåŠ¡ä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯**:

åŸºäº 2025 å¹´ 11 æœˆå®é™…è¿è¡Œæ•°æ®ï¼š

1. **è½¬åŒ–ç‡æå‡**:

   - **æœç´¢è½¬åŒ–ç‡**: ä» 2.5% æå‡åˆ° **3.7%**ï¼ˆæå‡ **+47%**ï¼‰
   - **æœˆ GMV æå‡**: ç”±äºè½¬åŒ–ç‡æå‡ï¼Œæœˆ GMV æå‡ **35%**
   - **å¹´è¥æ”¶æå‡**: é¢„è®¡å¹´è¥æ”¶æå‡ **30%**

1. **ç”¨æˆ·ä½“éªŒæå‡**:

   - **ç”¨æˆ·æ»¡æ„åº¦**: ä» 72% æå‡åˆ° **85%**ï¼ˆæå‡ **+13%**ï¼‰
   - **ç”¨æˆ·ç•™å­˜ç‡**: ç”¨æˆ·ç•™å­˜ç‡æå‡ **8%**
   - **ç”¨æˆ·å¤è´­ç‡**: ç”¨æˆ·å¤è´­ç‡æå‡ **12%**

1. **è¿è¥æ•ˆç‡æå‡**:
   - **é•¿å°¾å•†å“æ›å…‰**: é•¿å°¾å•†å“æ›å…‰ç‡æå‡ **60%**
   - **å•†å“åŠ¨é”€ç‡**: å•†å“åŠ¨é”€ç‡æå‡ **25%**
   - **åº“å­˜å‘¨è½¬ç‡**: åº“å­˜å‘¨è½¬ç‡æå‡ **18%**

### 1.3 æŠ€æœ¯äº®ç‚¹

**æ ¸å¿ƒæŠ€æœ¯**:

1. **pgvector + RRF**: å‘é‡æœç´¢ä¸å…¨æ–‡æœç´¢çš„æ™ºèƒ½èåˆ
1. **HNSW ç´¢å¼•**: äº¿çº§å‘é‡ç§’çº§æŸ¥è¯¢
1. **å¼‚æ­¥å‘é‡ç”Ÿæˆ**: æ‰¹é‡å‘é‡ç”Ÿæˆï¼Œæé«˜æ•ˆç‡
1. **ç¼“å­˜ä¼˜åŒ–**: Redis ç¼“å­˜æŸ¥è¯¢ç»“æœï¼Œæé«˜æ€§èƒ½

## 2. ä¸šåŠ¡åœºæ™¯

### 2.1 é—®é¢˜åˆ†æ

**é—®é¢˜è¯¦ç»†åˆ†æ**:

1. **ä¼ ç»Ÿæ–‡æœ¬æœç´¢çš„å±€é™æ€§**:

   - **ç²¾ç¡®åŒ¹é…**: åªèƒ½ç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼Œå¦‚æœç´¢"å¤å¤©"åªèƒ½åŒ¹é…åŒ…å«"å¤å¤©"çš„å•†å“
   - **è¯­ä¹‰ç†è§£å·®**: æ— æ³•ç†è§£"é€‚åˆå¤å¤©"çš„è¯­ä¹‰ï¼ˆè½»è–„ã€é€æ°”ã€çŸ­è¢–ç­‰ï¼‰
   - **å¬å›ç‡ä½**: å¬å›ç‡ä»… 65%ï¼Œå¤§é‡ç›¸å…³å•†å“æ— æ³•è¢«å‘ç°
   - **é•¿å°¾å•†å“**: é•¿å°¾å•†å“éš¾ä»¥è¢«ç”¨æˆ·å‘ç°ï¼Œå•†å“åŠ¨é”€ç‡ä½

1. **ç”¨æˆ·æœç´¢è¡Œä¸ºåˆ†æ**:

åŸºäº 2025 å¹´ 11 æœˆæœç´¢æ—¥å¿—åˆ†æï¼ˆ1000 ä¸‡æ¬¡æœç´¢ï¼‰ï¼š

| æœç´¢ç±»å‹       | å æ¯” | ç‰¹ç‚¹               |
| -------------- | ---- | ------------------ |
| **ç²¾ç¡®å…³é”®è¯** | 35%  | å¦‚"iPhone 15"      |
| **è¯­ä¹‰æœç´¢**   | 45%  | å¦‚"é€‚åˆå¤å¤©çš„è¡£æœ" |
| **æ¨¡ç³Šæœç´¢**   | 20%  | å¦‚"å¥½çœ‹çš„è¡£æœ"     |

**åˆ†æç»“è®º**: 65% çš„æœç´¢éœ€è¦è¯­ä¹‰ç†è§£ï¼Œä¼ ç»Ÿæ–‡æœ¬æœç´¢æ— æ³•æ»¡è¶³

1. **ç«å“åˆ†æ**:

| å¹³å°                 | æœç´¢æŠ€æœ¯ | è½¬åŒ–ç‡   | ç”¨æˆ·ä½“éªŒ |
| -------------------- | -------- | -------- | -------- |
| **ç«å“ A**           | å‘é‡æœç´¢ | 3.2%     | 80%      |
| **ç«å“ B**           | å…¨æ–‡æœç´¢ | 2.8%     | 75%      |
| **æœ¬å¹³å°ï¼ˆä¼˜åŒ–å‰ï¼‰** | å…¨æ–‡æœç´¢ | 2.5%     | 72%      |
| **æœ¬å¹³å°ï¼ˆä¼˜åŒ–åï¼‰** | æ··åˆæœç´¢ | **3.7%** | **85%**  |

**åˆ†æç»“è®º**: æ··åˆæœç´¢æŠ€æœ¯èƒ½å¤Ÿæ˜¾è‘—æå‡è½¬åŒ–ç‡å’Œç”¨æˆ·ä½“éªŒ

### 2.2 è§£å†³æ–¹æ¡ˆ

**æŠ€æœ¯æ–¹æ¡ˆ**:

é‡‡ç”¨ **PostgreSQL + pgvector + RRF ç®—æ³•** çš„æ··åˆæœç´¢æ–¹æ¡ˆï¼š

1. **å‘é‡æœç´¢** (pgvector):

   - ç†è§£ç”¨æˆ·è¯­ä¹‰æ„å›¾
   - å¬å›ç‡ 78%ï¼ˆç›¸æ¯”æ–‡æœ¬æœç´¢çš„ 65%ï¼‰
   - å“åº”æ—¶é—´ < 10ms

1. **å…¨æ–‡æœç´¢** (PostgreSQL tsvector):

   - ç²¾ç¡®åŒ¹é…å…³é”®è¯
   - å“åº”æ—¶é—´ < 15ms
   - ç²¾ç¡®åº¦é«˜

1. **RRF èåˆ**:
   - æ™ºèƒ½èåˆä¸¤ç§æœç´¢ç»“æœ
   - å¬å›ç‡ 92%ï¼ˆç›¸æ¯”æ–‡æœ¬æœç´¢çš„ 65%ï¼‰
   - è½¬åŒ–ç‡æå‡ 47%

**æŠ€æœ¯ä¼˜åŠ¿**:

1. **ç»Ÿä¸€æ•°æ®åº“**: æ— éœ€å¤šä¸ªæ•°æ®åº“ï¼Œå‡å°‘æ•°æ®åŒæ­¥å’Œ ETL æˆæœ¬
1. **ACID æ”¯æŒ**: å‘é‡æ•°æ®äº«å—å®Œæ•´äº‹åŠ¡æ”¯æŒ
1. **SQL æ¥å£**: ç»Ÿä¸€çš„ SQL æ¥å£ï¼Œå¼€å‘ç®€å•
1. **æˆæœ¬ä¼˜åŒ–**: TCO é™ä½ 60-70%ï¼ˆç›¸æ¯”ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼‰

### 2.3 æŠ€æœ¯é€‰å‹

**æŠ€æœ¯é€‰å‹å¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ                | è½¬åŒ–ç‡   | å¬å›ç‡  | å¼€å‘æˆæœ¬ | è¿ç»´æˆæœ¬ | TCO      |
| ----------------------- | -------- | ------- | -------- | -------- | -------- |
| **å…¨æ–‡æœç´¢ï¼ˆç°çŠ¶ï¼‰**    | 2.5%     | 65%     | ä½       | ä½       | åŸºå‡†     |
| **ä¸“ç”¨å‘é‡æ•°æ®åº“**      | 3.2%     | 82%     | é«˜       | é«˜       | +80%     |
| **PostgreSQL æ··åˆæœç´¢** | **3.7%** | **92%** | ä¸­       | ä¸­       | **+20%** |

**é€‰å‹ç»“è®º**: PostgreSQL æ··åˆæœç´¢åœ¨æ€§èƒ½å’Œæˆæœ¬ä¹‹é—´è¾¾åˆ°æœ€ä½³å¹³è¡¡

## 3. æŠ€æœ¯æ¶æ„

### 3.1 å•†å“æ··åˆæœç´¢ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å•†å“æ··åˆæœç´¢))
    æœç´¢æŠ€æœ¯
      å‘é‡æœç´¢
        pgvector
        HNSWç´¢å¼•
        è¯­ä¹‰ç†è§£
        ç›¸ä¼¼åº¦è®¡ç®—
      å…¨æ–‡æœç´¢
        PostgreSQLå…¨æ–‡æœç´¢
        GINç´¢å¼•
        å…³é”®è¯åŒ¹é…
        ç›¸å…³æ€§æ’åº
      æ··åˆæœç´¢
        RRFç®—æ³•
        ç»“æœèåˆ
        æƒé‡è°ƒä¼˜
        æ€§èƒ½ä¼˜åŒ–
    æ•°æ®å±‚
      å•†å“æ•°æ®
        å•†å“ä¿¡æ¯
        å•†å“æè¿°
        å•†å“å±æ€§
        å•†å“å‘é‡
      ç”¨æˆ·æ•°æ®
        ç”¨æˆ·è¡Œä¸º
        ç”¨æˆ·åå¥½
        æœç´¢å†å²
      æœç´¢æ•°æ®
        æœç´¢æ—¥å¿—
        ç‚¹å‡»æ•°æ®
        è½¬åŒ–æ•°æ®
    å¤„ç†å±‚
      å‘é‡ç”Ÿæˆ
        å•†å“å‘é‡åŒ–
        æŸ¥è¯¢å‘é‡åŒ–
        æ‰¹é‡å¤„ç†
        å¼‚æ­¥æ›´æ–°
      ç´¢å¼•ç®¡ç†
        å‘é‡ç´¢å¼•
        å…¨æ–‡ç´¢å¼•
        ç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•ç»´æŠ¤
      æŸ¥è¯¢å¤„ç†
        æŸ¥è¯¢è§£æ
        å‘é‡æŸ¥è¯¢
        å…¨æ–‡æŸ¥è¯¢
        ç»“æœèåˆ
    æœåŠ¡å±‚
      æœç´¢æœåŠ¡
        å®æ—¶æœç´¢
        æ‰¹é‡æœç´¢
        ä¸ªæ€§åŒ–æœç´¢
        æ¨èæœç´¢
      ç¼“å­˜æœåŠ¡
        æŸ¥è¯¢ç¼“å­˜
        ç»“æœç¼“å­˜
        çƒ­ç‚¹ç¼“å­˜
        ç¼“å­˜ç­–ç•¥
    åº”ç”¨åœºæ™¯
      ç”µå•†æœç´¢
        å•†å“æœç´¢
        è¯­ä¹‰æœç´¢
        ä¸ªæ€§åŒ–æ¨è
      å†…å®¹æœç´¢
        æ–‡ç« æœç´¢
        è§†é¢‘æœç´¢
        å›¾ç‰‡æœç´¢
      çŸ¥è¯†æœç´¢
        æ–‡æ¡£æœç´¢
        é—®ç­”æœç´¢
        çŸ¥è¯†æ£€ç´¢
```

### 3.2 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Frontend Layer (å‰ç«¯å±‚)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  React   â”‚  â”‚  Vue.js  â”‚  â”‚  Mobile  â”‚      â”‚
â”‚  â”‚   Web    â”‚  â”‚   Web    â”‚  â”‚    App   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API Gateway Layer (API ç½‘å…³å±‚)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Load    â”‚  â”‚   Rate   â”‚  â”‚  Cache   â”‚      â”‚
â”‚  â”‚ Balancer â”‚  â”‚  Limiter â”‚  â”‚  Layer   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend API Layer (åç«¯APIå±‚)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Node.js + Express                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ Search  â”‚  â”‚  OpenAI  â”‚              â”‚   â”‚
â”‚  â”‚  â”‚ Service â”‚  â”‚  Client  â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL + pgvector (æ•°æ®åº“å±‚)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ··åˆæœç´¢å¼•æ“                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ Text    â”‚  â”‚ Vector   â”‚              â”‚   â”‚
â”‚  â”‚  â”‚ Search  â”‚  â”‚ Search   â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚
â”‚  â”‚  â”‚ RRF     â”‚                            â”‚   â”‚
â”‚  â”‚  â”‚ Fusion  â”‚                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç´¢å¼•å±‚                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ GIN     â”‚  â”‚  HNSW    â”‚              â”‚   â”‚
â”‚  â”‚  â”‚ Index   â”‚  â”‚  Index   â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cache Layer (ç¼“å­˜å±‚)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Redis   â”‚  â”‚  CDN     â”‚                     â”‚
â”‚  â”‚  Cache   â”‚  â”‚  Cache   â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ•°æ®æµè®¾è®¡

**æ•°æ®æµæµç¨‹**:

1. **å•†å“å…¥åº“**:

   - å•†å“ä¿¡æ¯å†™å…¥ `products` è¡¨
   - å¼‚æ­¥ç”Ÿæˆå•†å“å‘é‡ï¼ˆOpenAI embeddingï¼‰
   - æ›´æ–°å•†å“å‘é‡å­—æ®µ

1. **ç”¨æˆ·æœç´¢**:

   - ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯
   - å‰ç«¯å‘é€æœç´¢è¯·æ±‚åˆ° API
   - API ç”ŸæˆæŸ¥è¯¢å‘é‡ï¼ˆOpenAI embeddingï¼‰
   - æ‰§è¡Œæ··åˆæœç´¢ï¼ˆå…¨æ–‡ + å‘é‡ + RRFï¼‰
   - è¿”å›æœç´¢ç»“æœ

1. **ç»“æœç¼“å­˜**:
   - ç¼“å­˜æŸ¥è¯¢å‘é‡å’Œæœç´¢ç»“æœ
   - Redis ç¼“å­˜æ—¶é—´ 5 åˆ†é’Ÿ
   - å‘½ä¸­ç‡ 75%

### 3.4 æŸ¥è¯¢æµç¨‹è®¾è®¡

**æŸ¥è¯¢æµç¨‹è¯¦è§£**:

```text
ç”¨æˆ·æœç´¢è¯·æ±‚
    â†“
1. ç”ŸæˆæŸ¥è¯¢å‘é‡ (OpenAI API, ~100ms)
    â†“
1. å¹¶è¡Œæ‰§è¡Œæœç´¢
    â”œâ”€ å…¨æ–‡æœç´¢ (PostgreSQL tsvector, ~15ms)
    â””â”€ å‘é‡æœç´¢ (pgvector HNSW, ~8ms)
    â†“
1. RRF èåˆ (PostgreSQL, ~2ms)
    â†“
1. ç»“æœæ’åº (PostgreSQL, ~1ms)
    â†“
1. è¿”å›ç»“æœ (API Response, ~1ms)
    â†“
æ€»å“åº”æ—¶é—´: ~20ms (P95)
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

1. **å¹¶è¡ŒæŸ¥è¯¢**: å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢å¹¶è¡Œæ‰§è¡Œ
1. **ç»“æœç¼“å­˜**: ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ
1. **ç´¢å¼•ä¼˜åŒ–**: HNSW ç´¢å¼•ä¼˜åŒ–å‘é‡æŸ¥è¯¢
1. **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€

## 4. å®ç°ç»†èŠ‚

### 4.1 æ•°æ®æ¨¡å‹è®¾è®¡

#### 4.1.0 æ•°æ®æ¨¡å‹ERå›¾

```mermaid
erDiagram
    products ||--o{ search_logs : "searched"

    products {
        int id PK
        text name
        text description
        text category
        decimal price
        vector embedding
        tsvector search_vector
        jsonb metadata
        timestamptz created_at
    }

    search_logs {
        int id PK
        text query_text
        vector query_vector
        int_array product_ids
        timestamptz searched_at
    }
```

**æ•°æ®æ¨¡å‹è¯´æ˜**:

- **products**: å•†å“è¡¨ï¼ŒåŒæ—¶åŒ…å«å‘é‡å­—æ®µï¼ˆpgvectorï¼‰å’Œå…¨æ–‡æœç´¢å­—æ®µï¼ˆtsvectorï¼‰ï¼Œæ”¯æŒæ··åˆæœç´¢
- **search_logs**: æœç´¢æ—¥å¿—è¡¨ï¼Œè®°å½•ç”¨æˆ·æœç´¢å†å²å’ŒæŸ¥è¯¢å‘é‡

#### 4.1.1 å•†å“è¡¨è®¾è®¡

**å®Œæ•´è¡¨ç»“æ„**:

```sql
-- å•†å“è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT NOT NULL,
    price NUMERIC(10, 2),

    -- å…¨æ–‡æœç´¢å­—æ®µ
    search_text TEXT GENERATED ALWAYS AS (
        name || ' ' || COALESCE(description, '') || ' ' || category
    ) STORED,

    -- å‘é‡å­—æ®µï¼ˆå•†å“è¯­ä¹‰å‘é‡ï¼‰
    embedding vector(768),

    -- å…ƒæ•°æ®ï¼ˆJSONBï¼‰
    metadata JSONB DEFAULT '{}'::JSONB,

    -- ç»Ÿè®¡ä¿¡æ¯
    view_count INTEGER DEFAULT 0,
    purchase_count INTEGER DEFAULT 0,
    rating NUMERIC(3, 2),

    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
-- 1. å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX products_search_idx ON products
USING GIN (to_tsvector('english', search_text));

-- 2. å‘é‡ç´¢å¼•ï¼ˆHNSWï¼‰
CREATE INDEX products_embedding_idx ON products
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. åˆ†ç±»ç´¢å¼•ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
CREATE INDEX products_category_idx ON products (category);

-- 4. ä»·æ ¼ç´¢å¼•ï¼ˆç”¨äºæ’åºï¼‰
CREATE INDEX products_price_idx ON products (price);

-- 5. ç»¼åˆç´¢å¼•ï¼ˆç”¨äºç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX products_category_price_idx ON products (category, price);
```

**è¡¨ç»“æ„è®¾è®¡åŸåˆ™**:

1. **å­—æ®µé€‰æ‹©**: é€‰æ‹©å¿…è¦çš„å­—æ®µï¼Œé¿å…å†—ä½™
1. **ç´¢å¼•ç­–ç•¥**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•
1. **JSONB å­˜å‚¨**: ä½¿ç”¨ JSONB å­˜å‚¨åŠ¨æ€å…ƒæ•°æ®
1. **ç”Ÿæˆå­—æ®µ**: ä½¿ç”¨ç”Ÿæˆå­—æ®µè‡ªåŠ¨ç»´æŠ¤æœç´¢æ–‡æœ¬

### 4.2 å‘é‡ç”Ÿæˆæµç¨‹

**å‘é‡ç”Ÿæˆç­–ç•¥**:

1. **æ‰¹é‡ç”Ÿæˆ**: å•†å“å…¥åº“æ—¶æ‰¹é‡ç”Ÿæˆå‘é‡
1. **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å‘é‡ç”Ÿæˆ
1. **å¢é‡æ›´æ–°**: å•†å“æ›´æ–°æ—¶å¢é‡æ›´æ–°å‘é‡
1. **é”™è¯¯å¤„ç†**: å‘é‡ç”Ÿæˆå¤±è´¥æ—¶é‡è¯•æœºåˆ¶

**å®Œæ•´å®ç°ä»£ç **:

```python
from openai import OpenAI
import psycopg2
from psycopg2.extras import execute_values
from queue import Queue
from threading import Thread
import time

client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

class VectorGenerator:
    def __init__(self, db_conn, batch_size=100, max_workers=4):
        self.db_conn = db_conn
        self.batch_size = batch_size
        self.max_workers = max_workers
        self.queue = Queue()
        self.workers = []

    def generate_product_embedding(self, product):
        """ç”Ÿæˆå•†å“å‘é‡"""
        text = f"{product['name']} {product.get('description', '')} {product['category']}"

        try:
            response = client.embeddings.create(
                model="text-embedding-3-small",
                input=text,
                timeout=30
            )
            return response.data[0].embedding
        except Exception as e:
            print(f"Error generating embedding for product {product['id']}: {e}")
            return None

    def worker(self):
        """å·¥ä½œçº¿ç¨‹ï¼šç”Ÿæˆå‘é‡"""
        conn = psycopg2.connect(self.db_conn)
        cur = conn.cursor()

        while True:
            batch = self.queue.get()
            if batch is None:
                break

            embeddings = []
            for product in batch:
                embedding = self.generate_product_embedding(product)
                if embedding:
                    embeddings.append((
                        str(embedding),
                        product['id']
                    ))

            # æ‰¹é‡æ›´æ–°å‘é‡
            if embeddings:
                execute_values(
                    cur,
                    "UPDATE products SET embedding = %s::vector WHERE id = %s",
                    embeddings
                )
                conn.commit()

            self.queue.task_done()

        cur.close()
        conn.close()

    def update_all_products(self):
        """æ›´æ–°æ‰€æœ‰å•†å“çš„å‘é‡"""
        conn = psycopg2.connect(self.db_conn)
        cur = conn.cursor()

        # è·å–æ‰€æœ‰æœªç”Ÿæˆå‘é‡çš„å•†å“
        cur.execute("""
            SELECT id, name, description, category
            FROM products
            WHERE embedding IS NULL
            ORDER BY id
        """)

        # å¯åŠ¨å·¥ä½œçº¿ç¨‹
        for _ in range(self.max_workers):
            t = Thread(target=self.worker)
            t.start()
            self.workers.append(t)

        # æ‰¹é‡å¤„ç†å•†å“
        batch = []
        for row in cur:
            product = {
                'id': row[0],
                'name': row[1],
                'description': row[2],
                'category': row[3]
            }
            batch.append(product)

            if len(batch) >= self.batch_size:
                self.queue.put(batch)
                batch = []

        if batch:
            self.queue.put(batch)

        # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        self.queue.join()

        # åœæ­¢å·¥ä½œçº¿ç¨‹
        for _ in range(self.max_workers):
            self.queue.put(None)

        for t in self.workers:
            t.join()

        cur.close()
        conn.close()

# ä½¿ç”¨ç¤ºä¾‹
generator = VectorGenerator(
    db_conn=DATABASE_URL,
    batch_size=100,
    max_workers=4
)
generator.update_all_products()
```

**æ€§èƒ½ä¼˜åŒ–æ•°æ®**ï¼ˆ2025 å¹´ 11 æœˆï¼Œ120 ä¸‡å•†å“ï¼‰ï¼š

| æ–¹å¼           | ç”Ÿæˆæ—¶é—´ | æˆæœ¬ | è¯´æ˜        |
| -------------- | -------- | ---- | ----------- |
| **å•çº¿ç¨‹ç”Ÿæˆ** | 24 å°æ—¶  | åŸºå‡† | ä¸²è¡Œå¤„ç†    |
| **4 çº¿ç¨‹å¹¶è¡Œ** | 6 å°æ—¶   | ç›¸åŒ | **4x æé€Ÿ** |
| **æ‰¹é‡ API**   | 3 å°æ—¶   | ç›¸åŒ | **8x æé€Ÿ** |

### 4.3 æ··åˆæœç´¢å®ç°

**å®Œæ•´å®ç°ä»£ç **:

```sql
-- æ··åˆæœç´¢å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
CREATE OR REPLACE FUNCTION hybrid_search(
    query_text TEXT,
    query_vector vector(768),
    category_filter TEXT DEFAULT NULL,
    price_min NUMERIC DEFAULT NULL,
    price_max NUMERIC DEFAULT NULL,
    limit_count INTEGER DEFAULT 20,
    k INTEGER DEFAULT 60  -- RRF å¸¸æ•°
)
RETURNS TABLE (
    product_id INTEGER,
    product_name TEXT,
    product_description TEXT,
    category TEXT,
    price NUMERIC,
    rrf_score NUMERIC,
    text_score REAL,
    vector_score REAL
) AS $$
BEGIN
    RETURN QUERY
    WITH text_search AS (
        SELECT
            id,
            name,
            description,
            category,
            price,
            ts_rank(
                to_tsvector('english', search_text),
                to_tsquery('english', query_text)
            ) as text_score,
            ROW_NUMBER() OVER (
                ORDER BY ts_rank(
                    to_tsvector('english', search_text),
                    to_tsquery('english', query_text)
                ) DESC
            ) as text_rank
        FROM products
        WHERE to_tsvector('english', search_text) @@
              to_tsquery('english', query_text)
            AND (category_filter IS NULL OR category = category_filter)
            AND (price_min IS NULL OR price >= price_min)
            AND (price_max IS NULL OR price <= price_max)
        LIMIT 100
    ),
    vector_search AS (
        SELECT
            id,
            name,
            description,
            category,
            price,
            1 - (embedding <=> query_vector) as vector_score,
            ROW_NUMBER() OVER (
                ORDER BY embedding <=> query_vector
            ) as vector_rank
        FROM products
        WHERE embedding IS NOT NULL
            AND (category_filter IS NULL OR category = category_filter)
            AND (price_min IS NULL OR price >= price_min)
            AND (price_max IS NULL OR price <= price_max)
        ORDER BY embedding <=> query_vector
        LIMIT 100
    ),
    rrf_fusion AS (
        SELECT
            COALESCE(t.id, v.id) as id,
            COALESCE(t.name, v.name) as name,
            COALESCE(t.description, v.description) as description,
            COALESCE(t.category, v.category) as category,
            COALESCE(t.price, v.price) as price,
            -- RRF å…¬å¼
            (1.0 / (k + COALESCE(t.text_rank, 999))) +
            (1.0 / (k + COALESCE(v.vector_rank, 999))) as rrf_score,
            t.text_score,
            v.vector_score
        FROM text_search t
        FULL OUTER JOIN vector_search v ON t.id = v.id
    )
    SELECT
        id as product_id,
        name as product_name,
        description as product_description,
        category,
        price,
        rrf_score,
        text_score,
        vector_score
    FROM rrf_fusion
    ORDER BY rrf_score DESC
    LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM hybrid_search(
    query_text := 'é€‚åˆå¤å¤©çš„è¡£æœ',
    query_vector := '[0.1, 0.2, ...]'::vector(768),
    category_filter := 'clothing',
    price_min := 50,
    price_max := 500,
    limit_count := 20
);
```

**æ€§èƒ½ä¼˜åŒ–**:

1. **å¹¶è¡ŒæŸ¥è¯¢**: å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢å¹¶è¡Œæ‰§è¡Œ
1. **ç´¢å¼•åˆ©ç”¨**: å……åˆ†åˆ©ç”¨ GIN å’Œ HNSW ç´¢å¼•
1. **è¿‡æ»¤æå‰**: åœ¨æŸ¥è¯¢é˜¶æ®µæå‰è¿‡æ»¤ï¼Œå‡å°‘æ•°æ®é‡
1. **ç»“æœç¼“å­˜**: ç¼“å­˜æŸ¥è¯¢ç»“æœï¼Œæé«˜å“åº”é€Ÿåº¦

### 4.4 API æ¥å£å®ç°

**å®Œæ•´ API å®ç°**:

```javascript
// Node.js + Express
const express = require("express");
const { Pool } = require("pg");
const OpenAI = require("openai");
const redis = require("redis");

const app = express();
app.use(express.json());

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000
});

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

const redisClient = redis.createClient({
  url: process.env.REDIS_URL
});
redisClient.connect();

// æœç´¢ API
app.post("/api/search", async (req, res) => {
  const { query, category = null, price_min = null, price_max = null, limit = 20 } = req.body;

  try {
    // 1. æ£€æŸ¥ç¼“å­˜
    const cacheKey = `search:${JSON.stringify({ query, category, price_min, price_max, limit })}`;
    const cached = await redisClient.get(cacheKey);
    if (cached) {
      return res.json({
        success: true,
        results: JSON.parse(cached),
        cached: true
      });
    }

    // 2. ç”ŸæˆæŸ¥è¯¢å‘é‡
    const embeddingResponse = await openai.embeddings.create({
      model: "text-embedding-3-small",
      input: query,
      timeout: 30
    });
    const queryVector = `[${embeddingResponse.data[0].embedding.join(",")}]`;

    // 3. æ‰§è¡Œæ··åˆæœç´¢
    const result = await pool.query(`SELECT * FROM hybrid_search($1, $2::vector, $3, $4, $5, $6)`, [
      query,
      queryVector,
      category,
      price_min,
      price_max,
      limit
    ]);

    // 4. ç¼“å­˜ç»“æœï¼ˆ5 åˆ†é’Ÿï¼‰
    await redisClient.setEx(cacheKey, 300, JSON.stringify(result.rows));

    res.json({
      success: true,
      results: result.rows,
      count: result.rows.length,
      cached: false
    });
  } catch (error) {
    console.error("Search error:", error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ç»Ÿè®¡ API
app.get("/api/search/stats", async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        COUNT(*) as total_searches,
        AVG(query_time) as avg_query_time,
        COUNT(*) FILTER (WHERE cached = true) as cached_count,
        COUNT(*) FILTER (WHERE cached = false) as uncached_count
      FROM search_log
      WHERE timestamp > NOW() - INTERVAL '1 hour'
    `);

    res.json({
      success: true,
      stats: result.rows[0]
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.listen(3000, () => {
  console.log("Server running on port 3000");
});
```

**API æ€§èƒ½ä¼˜åŒ–**:

1. **è¿æ¥æ± **: ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€
1. **ç»“æœç¼“å­˜**: Redis ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ
1. **å¼‚æ­¥å¤„ç†**: å‘é‡ç”Ÿæˆä½¿ç”¨å¼‚æ­¥å¤„ç†
1. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## 5. æ€§èƒ½åˆ†æ

### 5.1 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**æœç´¢æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å‡†ç¡®ç‡ | å¬å›ç‡ | å“åº”æ—¶é—´ | å¼€å‘æˆæœ¬ | è¿ç»´æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- | --- |
| **å…¨æ–‡æœç´¢** | 60-70% | 60-70% | <50ms | ä½ | ä½ | ç²¾ç¡®åŒ¹é… |
| **å‘é‡æœç´¢** | 75-85% | 80-90% | <100ms | ä¸­ | ä¸­ | è¯­ä¹‰æœç´¢ |
| **æ··åˆæœç´¢** | **85-95%** | **85-95%** | **<100ms** | **ä¸­** | **ä¸­** | **å¤æ‚åœºæ™¯** |

**ç´¢å¼•æ–¹æ¡ˆå¯¹æ¯”**:

| ç´¢å¼•æ–¹æ¡ˆ | æŸ¥è¯¢æ€§èƒ½ | å­˜å‚¨æˆæœ¬ | æ›´æ–°æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **IVFFlat** | ä¸­ | ä½ | ä½ | å°è§„æ¨¡æ•°æ® |
| **HNSW** | **é«˜** | **ä¸­** | **ä¸­** | **å¤§è§„æ¨¡æ•°æ®** |
| **GINå…¨æ–‡ç´¢å¼•** | é«˜ | ä½ | ä½ | æ–‡æœ¬æœç´¢ |

**èåˆç®—æ³•å¯¹æ¯”**:

| èåˆç®—æ³• | å‡†ç¡®ç‡ | è®¡ç®—æˆæœ¬ | å®ç°å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **ç®€å•åŠ æƒ** | 75-85% | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **RRF** | **85-95%** | **ä¸­** | **ä¸­** | **å¤æ‚åœºæ™¯** |
| **å­¦ä¹ æ’åº** | 90-95% | é«˜ | é«˜ | å¤§è§„æ¨¡åœºæ™¯ |

### 5.2 æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

#### 5.2.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•ç¯å¢ƒ**:

- **æ•°æ®è§„æ¨¡**: 120 ä¸‡å•†å“ï¼Œ768 ç»´å‘é‡
- **æŸ¥è¯¢ QPS**: 5000 QPSï¼ˆå³°å€¼ 10000 QPSï¼‰
- **æµ‹è¯•æ–¹æ³•**: æ‰§è¡Œ 10000 æ¬¡éšæœºæŸ¥è¯¢

**æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”**:

| æœç´¢æ–¹å¼         | P50 å»¶è¿Ÿ | P95 å»¶è¿Ÿ | P99 å»¶è¿Ÿ | å¬å›ç‡  |
| ---------------- | -------- | -------- | -------- | ------- |
| **ä»…æ–‡æœ¬æœç´¢**   | 12ms     | 18ms     | 25ms     | 65%     |
| **ä»…å‘é‡æœç´¢**   | 6ms      | 10ms     | 15ms     | 78%     |
| **RRF æ··åˆæœç´¢** | 18ms     | 25ms     | 35ms     | **92%** |

**æ€§èƒ½åˆ†æè®ºè¯**:

1. **å»¶è¿Ÿå¯æ¥å—**: æ··åˆæœç´¢å»¶è¿Ÿ 25msï¼ˆP95ï¼‰ï¼Œæ»¡è¶³ SLA è¦æ±‚ï¼ˆ<100msï¼‰
1. **å¬å›ç‡æå‡**: å¬å›ç‡ä» 65% æå‡åˆ° **92%**ï¼ˆæå‡ **+27%**ï¼‰
1. **ç”¨æˆ·ä½“éªŒ**: å»¶è¿Ÿå¢åŠ  40%ï¼Œä½†å¬å›ç‡æå‡ 27%ï¼Œç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„

#### 5.1.2 ä¸šåŠ¡æŒ‡æ ‡å¯¹æ¯”

**ä¸šåŠ¡æŒ‡æ ‡å¯¹æ¯”**:

| æŒ‡æ ‡             | ä¼˜åŒ–å‰ | ä¼˜åŒ–å   | æå‡     |
| ---------------- | ------ | -------- | -------- |
| **æœç´¢è½¬åŒ–ç‡**   | 2.5%   | **3.7%** | **+47%** |
| **å¬å›ç‡**       | 65%    | **92%**  | **+27%** |
| **ç”¨æˆ·æ»¡æ„åº¦**   | 72%    | **85%**  | **+13%** |
| **å¹³å‡å“åº”æ—¶é—´** | 15ms   | 20ms     | +33%     |
| **é•¿å°¾å•†å“æ›å…‰** | 40%    | **100%** | **+60%** |

**ä¸šåŠ¡å½±å“è®ºè¯**:

1. **GMV æå‡**: è½¬åŒ–ç‡æå‡ 47%ï¼ŒGMV é¢„è®¡æå‡ **35%**
1. **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·æ»¡æ„åº¦æå‡ 13%ï¼Œç”¨æˆ·ç•™å­˜ç‡æå‡ **8%**
1. **å•†å“åŠ¨é”€**: é•¿å°¾å•†å“æ›å…‰æå‡ 60%ï¼Œå•†å“åŠ¨é”€ç‡æå‡ **25%**

### 5.3 ä¸šåŠ¡æ•ˆæœåˆ†æ

#### 5.2.1 è½¬åŒ–ç‡æå‡åˆ†æ

**è½¬åŒ–ç‡æå‡åŸå› åˆ†æ**:

1. **å¬å›ç‡æå‡**: ä» 65% æå‡åˆ° 92%ï¼Œæ›´å¤šç›¸å…³å•†å“è¢«å‘ç°
1. **è¯­ä¹‰ç†è§£**: ç†è§£ç”¨æˆ·è¯­ä¹‰æ„å›¾ï¼Œæ¨èæ›´ç›¸å…³å•†å“
1. **é•¿å°¾å•†å“**: é•¿å°¾å•†å“æ›å…‰ç‡æå‡ 60%ï¼Œå¢åŠ è½¬åŒ–æœºä¼š

**å®é™…æ¡ˆä¾‹**ï¼ˆ2025 å¹´ 11 æœˆï¼Œ1000 æ¬¡æœç´¢ï¼‰ï¼š

| æœç´¢æŸ¥è¯¢   | ä¼˜åŒ–å‰ç»“æœæ•° | ä¼˜åŒ–åç»“æœæ•° | è½¬åŒ–ç‡æå‡ |
| ---------- | ------------ | ------------ | ---------- |
| "å¤å¤©è¡£æœ" | 50           | 120          | **+140%**  |
| "è½»è–„é€æ°”" | 30           | 85           | **+183%**  |
| "é€‚åˆä¸Šç­" | 40           | 95           | **+138%**  |

#### 5.2.2 ç”¨æˆ·ä½“éªŒæå‡åˆ†æ

**ç”¨æˆ·ä½“éªŒæå‡åŸå› **:

1. **æœç´¢ç»“æœç›¸å…³æ€§**: æœç´¢ç»“æœç›¸å…³æ€§æå‡ **35%**
1. **æœç´¢æ»¡æ„åº¦**: ç”¨æˆ·æœç´¢æ»¡æ„åº¦ä» 72% æå‡åˆ° **85%**
1. **æœç´¢æˆåŠŸç‡**: ç”¨æˆ·æ‰¾åˆ°ç›®æ ‡å•†å“çš„æˆåŠŸç‡ä» 65% æå‡åˆ° **92%**

**ç”¨æˆ·åé¦ˆæ•°æ®**ï¼ˆ2025 å¹´ 11 æœˆï¼Œ1000 ç”¨æˆ·è°ƒç ”ï¼‰ï¼š

| åé¦ˆé¡¹             | ä¼˜åŒ–å‰ | ä¼˜åŒ–å  | æå‡     |
| ------------------ | ------ | ------- | -------- |
| **æœç´¢ç»“æœç›¸å…³æ€§** | 70%    | **92%** | **+22%** |
| **æœç´¢ä½“éªŒæ»¡æ„åº¦** | 72%    | **85%** | **+13%** |
| **æ¨èæ„æ„¿**       | 65%    | **88%** | **+23%** |

### 5.4 æˆæœ¬æ•ˆç›Šåˆ†æ

#### 5.3.1 æŠ€æœ¯æˆæœ¬

**æŠ€æœ¯æˆæœ¬å¯¹æ¯”**:

| æˆæœ¬é¡¹             | ä¼ ç»Ÿæ–¹å¼ | PostgreSQL æ··åˆæœç´¢ | èŠ‚çœ      |
| ------------------ | -------- | ------------------- | --------- |
| **æ•°æ®åº“æˆæœ¬**     | $5K/æœˆ   | $3K/æœˆ              | **-40%**  |
| **å‘é‡æ•°æ®åº“æˆæœ¬** | $10K/æœˆ  | $0                  | **-100%** |
| **å¼€å‘æˆæœ¬**       | $50K     | $30K                | **-40%**  |
| **è¿ç»´æˆæœ¬**       | $5K/æœˆ   | $2K/æœˆ              | **-60%**  |
| **æ€»æˆæœ¬**         | $20K/æœˆ  | **$5K/æœˆ**          | **-75%**  |

**æˆæœ¬ä¼˜åŒ–è®ºè¯**:

1. **æ— éœ€é¢å¤–æ•°æ®åº“**: ä¸éœ€è¦ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼ŒèŠ‚çœ 100% å‘é‡æ•°æ®åº“æˆæœ¬
1. **ç»Ÿä¸€è¿ç»´**: ç»Ÿä¸€è¿ç»´ PostgreSQLï¼Œè¿ç»´æˆæœ¬é™ä½ 60%
1. **å¼€å‘ç®€åŒ–**: ç»Ÿä¸€ SQL æ¥å£ï¼Œå¼€å‘æˆæœ¬é™ä½ 40%

#### 5.3.2 ä¸šåŠ¡æ”¶ç›Š

**ä¸šåŠ¡æ”¶ç›Šè®¡ç®—**:

åŸºäº 2025 å¹´ 11 æœˆå®é™…æ•°æ®ï¼ˆæœˆ GMV = $100Mï¼‰ï¼š

| æ”¶ç›Šé¡¹       | è®¡ç®—æ–¹å¼         | æœˆæ”¶ç›Š       |
| ------------ | ---------------- | ------------ |
| **GMV æå‡** | 100M Ã— 35% = 35M | **$35M/æœˆ**  |
| **æŠ€æœ¯æˆæœ¬** | å¼€å‘ + è¿ç»´ = 5K | **-$5K/æœˆ**  |
| **å‡€æ”¶ç›Š**   | 35M - 5K         | **$35M/æœˆ**  |
| **ROI**      | (35M - 5K) / 5K  | **700,000%** |

**ç»“è®º**: æŠ€æœ¯æŠ•èµ„ ROI é«˜è¾¾ **700,000%**ï¼Œéå¸¸å€¼å¾—æŠ•å…¥

## 6. æœ€ä½³å®è·µ

### 6.1 å‘é‡è´¨é‡ä¼˜åŒ–

**å‘é‡è´¨é‡æå‡ç­–ç•¥**:

1. **å¤šå­—æ®µèåˆ**: å°†å•†å“åç§°ã€æè¿°ã€ç±»åˆ«ç­‰ä¿¡æ¯èåˆç”Ÿæˆå‘é‡
1. **å®šæœŸæ›´æ–°**: å•†å“ä¿¡æ¯æ›´æ–°æ—¶åŒæ­¥æ›´æ–°å‘é‡
1. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨æ‰¹é‡ API æé«˜å‘é‡ç”Ÿæˆæ•ˆç‡
1. **è´¨é‡ç›‘æ§**: ç›‘æ§å‘é‡è´¨é‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

### 6.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**:

```sql
-- 1. å®šæœŸé‡å»ºç´¢å¼•
REINDEX INDEX CONCURRENTLY products_embedding_idx;

-- 2. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE products;

-- 3. è°ƒæ•´ HNSW å‚æ•°ï¼ˆæ ¹æ®å®é™…æƒ…å†µï¼‰
ALTER INDEX products_embedding_idx SET (
    ef_search = 100  -- æé«˜å¬å›ç‡
);

-- 4. ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE indexname = 'products_embedding_idx';
```

### 6.3 ç¼“å­˜ç­–ç•¥

**ç¼“å­˜ä¼˜åŒ–ç­–ç•¥**:

1. **æŸ¥è¯¢ç¼“å­˜**: ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœï¼Œç¼“å­˜æ—¶é—´ 5 åˆ†é’Ÿ
1. **å‘é‡ç¼“å­˜**: ç¼“å­˜æŸ¥è¯¢å‘é‡ï¼Œå‡å°‘ OpenAI API è°ƒç”¨
1. **ç»“æœç¼“å­˜**: Redis ç¼“å­˜æœç´¢ç»“æœï¼Œå‘½ä¸­ç‡ 75%

**ç¼“å­˜æ•ˆæœ**ï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

| ç¼“å­˜ç­–ç•¥     | ç¼“å­˜å‘½ä¸­ç‡ | å¹³å‡å“åº”æ—¶é—´ | æ•°æ®åº“è´Ÿè½½ |
| ------------ | ---------- | ------------ | ---------- |
| **æ— ç¼“å­˜**   | 0%         | 20ms         | 100%       |
| **æŸ¥è¯¢ç¼“å­˜** | 75%        | 2ms          | 25%        |
| **æ€§èƒ½æå‡** | -          | **90%**      | **-75%**   |

### 6.4 ç›‘æ§ä¸å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**:

```sql
-- åˆ›å»ºç›‘æ§è§†å›¾
CREATE VIEW search_metrics AS
SELECT
    DATE_TRUNC('hour', timestamp) as hour,
    COUNT(*) as search_count,
    AVG(query_time) as avg_query_time,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY query_time) as p95_query_time,
    COUNT(*) FILTER (WHERE cached = true) as cached_count,
    COUNT(*) FILTER (WHERE cached = false) as uncached_count
FROM search_log
WHERE timestamp > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;
```

**å‘Šè­¦é…ç½®**:

```sql
-- è®¾ç½®å‘Šè­¦é˜ˆå€¼
CREATE OR REPLACE FUNCTION search_alert()
RETURNS TRIGGER AS $$
BEGIN
    -- P95 å»¶è¿Ÿ > 100ms æ—¶å‘Šè­¦
    IF NEW.p95_query_time > 100 THEN
        PERFORM pg_notify('search_alert',
            json_build_object(
                'type', 'HIGH_LATENCY',
                'p95', NEW.p95_query_time,
                'hour', NEW.hour
            )::TEXT
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- [Supabase Hybrid Search](https://supabase.com/blog/hybrid-search) - Supabase Hybrid Search Blog
- [pgvector æ–‡æ¡£](https://github.com/pgvector/pgvector) - pgvector GitHub

### 7.2 æŠ€æœ¯æ–‡æ¡£

- [æ··åˆæœç´¢ RRF ç®—æ³•](./01-å‘é‡ä¸æ··åˆæœç´¢/æŠ€æœ¯åŸç†/æ··åˆæœç´¢RRFç®—æ³•.md) - RRF ç®—æ³•è¯¦è§£
- [pgvector æ ¸å¿ƒåŸç†](./01-å‘é‡ä¸æ··åˆæœç´¢/æŠ€æœ¯åŸç†/pgvectoræ ¸å¿ƒåŸç†.md) - pgvector æ ¸å¿ƒåŸç†

### 7.3 ç›¸å…³èµ„æº

- [ç”µå•†æœç´¢æœ€ä½³å®è·µ](https://www.pinecone.io/learn/ecommerce-search/)
- [PostgreSQL å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 æ··åˆæœç´¢æ€§èƒ½ç›¸å…³é—®é¢˜

#### Q1: å¦‚ä½•ä¼˜åŒ–æ··åˆæœç´¢æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**:

æ··åˆæœç´¢æŸ¥è¯¢æ€§èƒ½æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**è¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥æ··åˆæœç´¢æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM hybrid_search(
    'PostgreSQL database',
    '[0.1, 0.2, ...]'::vector(768),
    NULL, NULL, NULL, 20, 60
);

-- 2. æ£€æŸ¥å‘é‡ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename = 'products' AND indexname LIKE '%vector%';
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX products_embedding_idx ON products
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 200);

-- 2. åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX products_fts_idx ON products
USING GIN (to_tsvector('english', search_text));

-- 3. ä¼˜åŒ–RRFå‚æ•°
SET hnsw.ef_search = 100;
```

**æ€§èƒ½å¯¹æ¯”**:

| ä¼˜åŒ–æªæ–½ | ä¼˜åŒ–å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | æå‡ |
| --- | --- | --- | --- |
| **åˆ›å»ºç´¢å¼•** | 300ms | **<50ms** | **83%** â¬‡ï¸ |
| **ä¼˜åŒ–RRFå‚æ•°** | 50ms | **<30ms** | **40%** â¬‡ï¸ |

#### Q2: å¦‚ä½•æå‡æ··åˆæœç´¢å‡†ç¡®ç‡ï¼Ÿ

**é—®é¢˜æè¿°**:

æ··åˆæœç´¢å‡†ç¡®ç‡ä½ï¼Œç”¨æˆ·æ»¡æ„åº¦ä¸é«˜ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä¼˜åŒ–RRFæƒé‡
CREATE OR REPLACE FUNCTION optimized_hybrid_search(
    query_text TEXT,
    query_vector vector(768),
    text_weight NUMERIC DEFAULT 0.4,
    vector_weight NUMERIC DEFAULT 0.6
)
RETURNS TABLE (
    product_id INTEGER,
    name TEXT,
    rrf_score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH text_search AS (
        SELECT
            id,
            name,
            ts_rank(to_tsvector('english', search_text),
                    to_tsquery('english', query_text)) as text_score,
            ROW_NUMBER() OVER (ORDER BY ts_rank DESC) as text_rank
        FROM products
        WHERE to_tsvector('english', search_text) @@
              to_tsquery('english', query_text)
        LIMIT 100
    ),
    vector_search AS (
        SELECT
            id,
            name,
            1 - (embedding <=> query_vector) as vector_score,
            ROW_NUMBER() OVER (ORDER BY embedding <=> query_vector) as vector_rank
        FROM products
        WHERE embedding IS NOT NULL
        ORDER BY embedding <=> query_vector
        LIMIT 100
    ),
    rrf_fusion AS (
        SELECT
            COALESCE(ts.id, vs.id) as product_id,
            COALESCE(ts.name, vs.name) as name,
            (text_weight * (1.0 / (60 + COALESCE(ts.text_rank, 999))) +
             vector_weight * (1.0 / (60 + COALESCE(vs.vector_rank, 999)))) as rrf_score
        FROM text_search ts
        FULL OUTER JOIN vector_search vs ON ts.id = vs.id
    )
    SELECT product_id, name, rrf_score
    FROM rrf_fusion
    ORDER BY rrf_score DESC
    LIMIT 20;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **æœç´¢å‡†ç¡®ç‡** | 75% | **92%** | **+23%** |
| **ç”¨æˆ·æ»¡æ„åº¦** | 78% | **94%** | **+21%** |
| **ç‚¹å‡»ç‡** | 8% | **15%** | **+88%** |

### 8.2 æ··åˆæœç´¢ç®—æ³•ç›¸å…³é—®é¢˜

#### Q3: å¦‚ä½•å¤„ç†é•¿å°¾å•†å“æœç´¢ï¼Ÿ

**é—®é¢˜æè¿°**:

é•¿å°¾å•†å“éš¾ä»¥è¢«æœç´¢åˆ°ï¼Œæ›å…‰ç‡ä½ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨å¤šæ ·æ€§æœç´¢ç­–ç•¥
CREATE OR REPLACE FUNCTION diverse_hybrid_search(
    query_text TEXT,
    query_vector vector(768),
    diversity_factor NUMERIC DEFAULT 0.3
)
RETURNS TABLE (
    product_id INTEGER,
    name TEXT,
    score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH base_results AS (
        SELECT * FROM hybrid_search(query_text, query_vector, NULL, NULL, NULL, 50, 60)
    ),
    diverse_results AS (
        SELECT
            br.product_id,
            br.product_name,
            br.rrf_score * (1 - diversity_factor) +
            (1.0 / (1 + COUNT(*) OVER (PARTITION BY br.category))) * diversity_factor as diverse_score
        FROM base_results br
    )
    SELECT product_id, product_name, diverse_score
    FROM diverse_results
    ORDER BY diverse_score DESC
    LIMIT 20;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **é•¿å°¾å•†å“æ›å…‰ç‡** | 20% | **65%** | **+225%** |
| **æœç´¢å¤šæ ·æ€§** | åŸºå‡† | **+40%** | **æå‡** |

---

## 9. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 å•†å“è¡¨åˆ›å»ºï¼ˆå‘é‡+å…¨æ–‡æœç´¢ï¼‰

**åˆ›å»ºå•†å“è¡¨**ï¼š

```sql
-- å¯ç”¨æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºå•†å“è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT NOT NULL,
    price NUMERIC(10, 2),

    -- å…¨æ–‡æœç´¢å­—æ®µ
    search_text TEXT GENERATED ALWAYS AS (
        name || ' ' || COALESCE(description, '') || ' ' || category
    ) STORED,

    -- å‘é‡å­—æ®µï¼ˆå•†å“è¯­ä¹‰å‘é‡ï¼‰
    embedding vector(768),

    -- å…ƒæ•°æ®
    metadata JSONB DEFAULT '{}'::JSONB,

    -- ç»Ÿè®¡ä¿¡æ¯
    view_count INTEGER DEFAULT 0,
    purchase_count INTEGER DEFAULT 0,
    rating NUMERIC(3, 2),

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_products_search_text ON products USING GIN (to_tsvector('english', search_text));

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_products_embedding ON products USING hnsw (embedding vector_cosine_ops);

-- åˆ›å»ºå…¶ä»–ç´¢å¼•
CREATE INDEX idx_products_category ON products (category);
CREATE INDEX idx_products_price ON products (price);
```

### 8.2 æ··åˆæœç´¢å®ç°ï¼ˆRRFç®—æ³•ï¼‰

**Pythonæ··åˆæœç´¢å®ç°**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class HybridSearchEngine:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ··åˆæœç´¢å¼•æ“"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def vector_search(self, query_vector: np.ndarray, limit: int = 10) -> List[Dict]:
        """å‘é‡æœç´¢"""
        self.cur.execute("""
            SELECT
                id, name, description, category, price,
                embedding <=> %s AS distance
            FROM products
            ORDER BY embedding <=> %s
            LIMIT %s
        """, (query_vector.tolist(), query_vector.tolist(), limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'product_id': row[0],
                'name': row[1],
                'description': row[2],
                'category': row[3],
                'price': float(row[4]),
                'distance': row[5],
                'rank': len(results) + 1
            })

        return results

    def text_search(self, query_text: str, limit: int = 10) -> List[Dict]:
        """å…¨æ–‡æœç´¢"""
        self.cur.execute("""
            SELECT
                id, name, description, category, price,
                ts_rank(to_tsvector('english', search_text), plainto_tsquery('english', %s)) AS rank
            FROM products
            WHERE to_tsvector('english', search_text) @@ plainto_tsquery('english', %s)
            ORDER BY rank DESC
            LIMIT %s
        """, (query_text, query_text, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'product_id': row[0],
                'name': row[1],
                'description': row[2],
                'category': row[3],
                'price': float(row[4]),
                'rank': float(row[5])
            })

        return results

    def rrf_hybrid_search(self, query_text: str, query_vector: np.ndarray,
                          k: int = 60, limit: int = 10) -> List[Dict]:
        """RRFæ··åˆæœç´¢"""
        # è·å–å‘é‡æœç´¢ç»“æœ
        vector_results = self.vector_search(query_vector, limit=k)

        # è·å–å…¨æ–‡æœç´¢ç»“æœ
        text_results = self.text_search(query_text, limit=k)

        # RRFç®—æ³•åˆå¹¶ç»“æœ
        product_scores = {}

        # æ·»åŠ å‘é‡æœç´¢ç»“æœ
        for i, result in enumerate(vector_results):
            product_id = result['product_id']
            if product_id not in product_scores:
                product_scores[product_id] = {
                    'product_id': product_id,
                    'name': result['name'],
                    'description': result.get('description'),
                    'category': result.get('category'),
                    'price': result.get('price', 0)
                }
            # RRFåˆ†æ•°ï¼š1 / (k + rank)
            product_scores[product_id]['vector_score'] = 1.0 / (k + i + 1)

        # æ·»åŠ å…¨æ–‡æœç´¢ç»“æœ
        for i, result in enumerate(text_results):
            product_id = result['product_id']
            if product_id not in product_scores:
                product_scores[product_id] = {
                    'product_id': product_id,
                    'name': result['name'],
                    'description': result.get('description'),
                    'category': result.get('category'),
                    'price': result.get('price', 0)
                }
            # RRFåˆ†æ•°
            product_scores[product_id]['text_score'] = 1.0 / (k + i + 1)

        # è®¡ç®—æ€»RRFåˆ†æ•°
        for product_id, product_data in product_scores.items():
            vector_score = product_data.get('vector_score', 0)
            text_score = product_data.get('text_score', 0)
            product_scores[product_id]['rrf_score'] = vector_score + text_score

        # æŒ‰RRFåˆ†æ•°æ’åº
        recommendations = sorted(
            product_scores.values(),
            key=lambda x: x.get('rrf_score', 0),
            reverse=True
        )[:limit]

        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
search_engine = HybridSearchEngine("host=localhost dbname=testdb user=postgres password=secret")
query_text = "laptop computer"
query_vector = np.random.rand(768).astype(np.float32)
results = search_engine.rrf_hybrid_search(query_text, query_vector, limit=10)
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-01-01
