# é€šç”¨æ¨èç³»ç»Ÿæ¶æ„

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **ç”¨é€”**: ç»Ÿä¸€æ¨èç³»ç»Ÿæ¶æ„æ–‡æ¡£ï¼Œé€‚ç”¨äºè§†é¢‘ã€éŸ³ä¹ã€å†…å®¹ç­‰å¤šç§æ¨èåœºæ™¯
> **æ¥æº**: åˆå¹¶è‡ªæ™ºèƒ½è§†é¢‘æ¨èç³»ç»Ÿå’Œæ™ºèƒ½éŸ³ä¹æ¨èç³»ç»Ÿ

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ•´åˆäº†æ™ºèƒ½è§†é¢‘æ¨èç³»ç»Ÿå’Œæ™ºèƒ½éŸ³ä¹æ¨èç³»ç»Ÿçš„é€šç”¨æ¶æ„å’Œæœ€ä½³å®è·µï¼Œé€‚ç”¨äºå„ç§æ¨èåœºæ™¯ã€‚

**åŸå§‹æ–‡æ¡£æ¥æº**:

- `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\è§†é¢‘åœºæ™¯\æ™ºèƒ½è§†é¢‘æ¨èç³»ç»Ÿ.md`
- `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\éŸ³ä¹åœºæ™¯\æ™ºèƒ½éŸ³ä¹æ¨èç³»ç»Ÿ.md`

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½æ¨èç³»ç»Ÿéœ€è¦ï¼š

- **ä¸ªæ€§åŒ–æ¨è**: æ ¹æ®ç”¨æˆ·å†å²è¡Œä¸ºæ¨èå†…å®¹
- **ç›¸ä¼¼åº¦åŒ¹é…**: åŒ¹é…ç›¸ä¼¼å†…å®¹
- **æ’­æ”¾åˆ—è¡¨**: ç”Ÿæˆä¸ªæ€§åŒ–åˆ—è¡¨
- **è¶‹åŠ¿åˆ†æ**: åˆ†æå†…å®¹è¶‹åŠ¿

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†å†…å®¹ç‰¹å¾
- **ç›¸ä¼¼åº¦æœç´¢**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ¨èå‡†ç¡®ç‡** | æ™ºèƒ½æ¨èæå‡å‡†ç¡®ç‡ | **+50-54%** |
| **ç”¨æˆ·æ»¡æ„åº¦** | ä¸ªæ€§åŒ–æ¨èæå‡æ»¡æ„åº¦ | **+46-48%** |
| **æŸ¥è¯¢æ€§èƒ½** | å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **10-11x** |
| **ç”¨æˆ·æ—¶é•¿** | æå‡ç”¨æˆ·ä½¿ç”¨æ—¶é•¿ | **+42-45%** |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ¨èç³»ç»Ÿæ¶æ„æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½æ¨èç³»ç»Ÿ))
    æ•°æ®å±‚
      å†…å®¹æ•°æ®
        å†…å®¹ä¿¡æ¯
        å†…å®¹ç‰¹å¾å‘é‡
        å†…å®¹æ ‡ç­¾
      ç”¨æˆ·æ•°æ®
        ç”¨æˆ·ä¿¡æ¯
        ç”¨æˆ·è¡Œä¸ºå†å²
        ç”¨æˆ·åå¥½å‘é‡
    æ¨èå±‚
      ä¸ªæ€§åŒ–æ¨è
        åŸºäºå†å²
        åŸºäºååŒè¿‡æ»¤
        åŸºäºå†…å®¹
      ç›¸ä¼¼åº¦åŒ¹é…
        å‘é‡ç›¸ä¼¼åº¦
        è¯­ä¹‰ç›¸ä¼¼åº¦
    åº”ç”¨å±‚
      æ¨èAPI
      å®æ—¶æ¨è
      æ‰¹é‡æ¨è
```

### 2.2 æ¶æ„è®¾è®¡

**æ ¸å¿ƒç»„ä»¶**:

1. **æ•°æ®å­˜å‚¨å±‚**
   - PostgreSQL + pgvector
   - å†…å®¹ç‰¹å¾å‘é‡å­˜å‚¨
   - ç”¨æˆ·è¡Œä¸ºå†å²å­˜å‚¨

2. **æ¨èç®—æ³•å±‚**
   - ä¸ªæ€§åŒ–æ¨èç®—æ³•
   - ç›¸ä¼¼åº¦åŒ¹é…ç®—æ³•
   - å®æ—¶æ¨èå¼•æ“

3. **åº”ç”¨æœåŠ¡å±‚**
   - RESTful API
   - å®æ—¶æ¨èæœåŠ¡
   - æ‰¹é‡æ¨èæœåŠ¡

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL 14+ with pgvector
- **å‘é‡å¤„ç†**: pgvector 0.7.0+
- **åº”ç”¨æ¡†æ¶**: Python/Node.js
- **éƒ¨ç½²**: Docker/Kubernetes

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å†…å®¹è¡¨ï¼ˆé€šç”¨ï¼‰

```sql
-- å†…å®¹è¡¨ï¼ˆé€‚ç”¨äºè§†é¢‘ã€éŸ³ä¹ã€æ–‡ç« ç­‰ï¼‰
CREATE TABLE content (
    content_id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    content_type VARCHAR(50), -- 'video', 'music', 'article', etc.
    feature_vector vector(1536), -- å†…å®¹ç‰¹å¾å‘é‡
    tags TEXT[],
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX ON content
USING ivfflat (feature_vector vector_cosine_ops)
WITH (lists = 100);
```

### 3.2 ç”¨æˆ·è¡Œä¸ºå†å²è¡¨ï¼ˆé€šç”¨ï¼‰

```sql
-- ç”¨æˆ·è¡Œä¸ºå†å²è¡¨
CREATE TABLE user_behavior (
    behavior_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_id BIGINT NOT NULL REFERENCES content(content_id),
    behavior_type VARCHAR(50), -- 'view', 'play', 'like', 'share', etc.
    behavior_time TIMESTAMP DEFAULT NOW(),
    duration INTEGER, -- è§‚çœ‹/æ’­æ”¾æ—¶é•¿ï¼ˆç§’ï¼‰
    metadata JSONB
);

CREATE INDEX idx_user_behavior_user ON user_behavior(user_id, behavior_time DESC);
CREATE INDEX idx_user_behavior_content ON user_behavior(content_id);
```

### 3.3 ç”¨æˆ·åå¥½å‘é‡è¡¨

```sql
-- ç”¨æˆ·åå¥½å‘é‡è¡¨
CREATE TABLE user_preference (
    user_id BIGINT PRIMARY KEY,
    preference_vector vector(1536), -- ç”¨æˆ·åå¥½å‘é‡
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ON user_preference
USING ivfflat (preference_vector vector_cosine_ops)
WITH (lists = 100);
```

---

## 4. æ¨èç®—æ³•

### 4.1 ä¸ªæ€§åŒ–æ¨è

åŸºäºç”¨æˆ·å†å²è¡Œä¸ºå’Œåå¥½å‘é‡çš„ä¸ªæ€§åŒ–æ¨èï¼š

```sql
-- ä¸ªæ€§åŒ–æ¨èæŸ¥è¯¢
WITH user_history AS (
    SELECT content_id, behavior_type, behavior_time
    FROM user_behavior
    WHERE user_id = $1
    ORDER BY behavior_time DESC
    LIMIT 100
),
user_pref AS (
    SELECT preference_vector
    FROM user_preference
    WHERE user_id = $1
)
SELECT
    c.content_id,
    c.title,
    c.description,
    1 - (c.feature_vector <=> up.preference_vector) AS similarity
FROM content c
CROSS JOIN user_pref up
WHERE c.content_id NOT IN (SELECT content_id FROM user_history)
ORDER BY similarity DESC
LIMIT 20;
```

### 4.2 ç›¸ä¼¼å†…å®¹æ¨è

åŸºäºå†…å®¹ç‰¹å¾å‘é‡çš„ç›¸ä¼¼åº¦åŒ¹é…ï¼š

```sql
-- ç›¸ä¼¼å†…å®¹æ¨è
SELECT
    c2.content_id,
    c2.title,
    c2.description,
    1 - (c1.feature_vector <=> c2.feature_vector) AS similarity
FROM content c1
CROSS JOIN content c2
WHERE c1.content_id = $1
  AND c2.content_id != $1
  AND c2.content_type = c1.content_type
ORDER BY similarity DESC
LIMIT 20;
```

### 4.3 ååŒè¿‡æ»¤æ¨è

åŸºäºç”¨æˆ·è¡Œä¸ºçš„ååŒè¿‡æ»¤ï¼š

```sql
-- ååŒè¿‡æ»¤æ¨è
WITH similar_users AS (
    SELECT
        ub2.user_id,
        COUNT(*) AS common_items,
        COUNT(*)::FLOAT /
            (SELECT COUNT(*) FROM user_behavior WHERE user_id = $1) AS similarity
    FROM user_behavior ub1
    JOIN user_behavior ub2 ON ub1.content_id = ub2.content_id
    WHERE ub1.user_id = $1
      AND ub2.user_id != $1
    GROUP BY ub2.user_id
    HAVING COUNT(*) >= 5
    ORDER BY similarity DESC
    LIMIT 10
)
SELECT DISTINCT
    c.content_id,
    c.title,
    c.description,
    COUNT(*) AS recommendation_score
FROM similar_users su
JOIN user_behavior ub ON su.user_id = ub.user_id
JOIN content c ON ub.content_id = c.content_id
WHERE c.content_id NOT IN (
    SELECT content_id FROM user_behavior WHERE user_id = $1
)
GROUP BY c.content_id, c.title, c.description
ORDER BY recommendation_score DESC
LIMIT 20;
```

---

## 5. åœºæ™¯ç‰¹å®šå®ç°

### 5.1 è§†é¢‘æ¨èåœºæ™¯

**ç‰¹æ®Šè€ƒè™‘**:

- è§†é¢‘æ—¶é•¿åˆ†æ
- è§‚çœ‹å®Œæˆç‡
- è§†é¢‘åˆ†ç±»æ ‡ç­¾

**å®ç°ç¤ºä¾‹**:

```sql
-- è§†é¢‘æ¨èï¼ˆè€ƒè™‘è§‚çœ‹å®Œæˆç‡ï¼‰
SELECT
    c.content_id,
    c.title,
    AVG(ub.duration::FLOAT / c.metadata->>'duration') AS avg_completion_rate,
    1 - (c.feature_vector <=> up.preference_vector) AS similarity
FROM content c
CROSS JOIN user_preference up
LEFT JOIN user_behavior ub ON c.content_id = ub.content_id
    AND ub.user_id = up.user_id
WHERE c.content_type = 'video'
  AND up.user_id = $1
GROUP BY c.content_id, c.title, c.feature_vector, up.preference_vector
ORDER BY (similarity * COALESCE(avg_completion_rate, 0.5)) DESC
LIMIT 20;
```

### 5.2 éŸ³ä¹æ¨èåœºæ™¯

**ç‰¹æ®Šè€ƒè™‘**:

- éŸ³ä¹é£æ ¼åŒ¹é…
- æ’­æ”¾æ¬¡æ•°
- æ’­æ”¾åˆ—è¡¨ç”Ÿæˆ

**å®ç°ç¤ºä¾‹**:

```sql
-- éŸ³ä¹æ¨èï¼ˆè€ƒè™‘æ’­æ”¾æ¬¡æ•°ï¼‰
SELECT
    c.content_id,
    c.title,
    COUNT(ub.behavior_id) AS play_count,
    1 - (c.feature_vector <=> up.preference_vector) AS similarity
FROM content c
CROSS JOIN user_preference up
LEFT JOIN user_behavior ub ON c.content_id = ub.content_id
    AND ub.user_id = up.user_id
    AND ub.behavior_type = 'play'
WHERE c.content_type = 'music'
  AND up.user_id = $1
GROUP BY c.content_id, c.title, c.feature_vector, up.preference_vector
ORDER BY (similarity * (1 + LOG(1 + play_count))) DESC
LIMIT 20;
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 å‘é‡ç´¢å¼•ä¼˜åŒ–

```sql
-- ä½¿ç”¨HNSWç´¢å¼•æå‡æ€§èƒ½
CREATE INDEX ON content
USING hnsw (feature_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- æŸ¥è¯¢æ—¶è®¾ç½®ef_searchå‚æ•°
SET hnsw.ef_search = 100;
```

### 6.2 å®æ—¶æ¨èä¼˜åŒ–

- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨å†…å®¹
- ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·åå¥½å‘é‡
- å¼‚æ­¥æ›´æ–°ç”¨æˆ·åå¥½å‘é‡

### 6.3 æ€§èƒ½è°ƒä¼˜

- é™åˆ¶æ¨èç»“æœæ•°é‡
- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯

---

## 7. å®Œæ•´ä»£ç ç¤ºä¾‹

### 7.1 å†…å®¹å‘é‡è¡¨åˆ›å»º

```sql
-- åˆ›å»ºå†…å®¹è¡¨
CREATE TABLE content (
    content_id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    content_type VARCHAR(50),
    feature_vector vector(1536),
    tags TEXT[],
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX ON content
USING ivfflat (feature_vector vector_cosine_ops)
WITH (lists = 100);
```

### 7.2 ä¸ªæ€§åŒ–æ¨èå®ç°

```sql
-- ä¸ªæ€§åŒ–æ¨èå‡½æ•°
CREATE OR REPLACE FUNCTION get_personalized_recommendations(
    p_user_id BIGINT,
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    content_id BIGINT,
    title VARCHAR,
    similarity FLOAT
) AS $$
BEGIN
    RETURN QUERY
    WITH user_pref AS (
        SELECT preference_vector
        FROM user_preference
        WHERE user_id = p_user_id
    )
    SELECT
        c.content_id,
        c.title,
        1 - (c.feature_vector <=> up.preference_vector) AS similarity
    FROM content c
    CROSS JOIN user_pref up
    WHERE c.content_id NOT IN (
        SELECT content_id
        FROM user_behavior
        WHERE user_id = p_user_id
    )
    ORDER BY similarity DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### 7.3 ç›¸ä¼¼å†…å®¹æ¨èå®ç°

```sql
-- ç›¸ä¼¼å†…å®¹æ¨èå‡½æ•°
CREATE OR REPLACE FUNCTION get_similar_content(
    p_content_id BIGINT,
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    content_id BIGINT,
    title VARCHAR,
    similarity FLOAT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        c2.content_id,
        c2.title,
        1 - (c1.feature_vector <=> c2.feature_vector) AS similarity
    FROM content c1
    CROSS JOIN content c2
    WHERE c1.content_id = p_content_id
      AND c2.content_id != p_content_id
      AND c2.content_type = c1.content_type
    ORDER BY similarity DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

## 8. åœºæ™¯ç‰¹å®šæ–‡æ¡£

å¯¹äºç‰¹å®šåœºæ™¯çš„è¯¦ç»†å®ç°ï¼Œè¯·å‚è€ƒï¼š

- **è§†é¢‘æ¨è**: `19-å®æˆ˜æ¡ˆä¾‹/è§†é¢‘åœºæ™¯/æ™ºèƒ½è§†é¢‘æ¨èç³»ç»Ÿ-è¯¦ç»†å®ç°.md`
- **éŸ³ä¹æ¨è**: `19-å®æˆ˜æ¡ˆä¾‹/éŸ³ä¹åœºæ™¯/æ™ºèƒ½éŸ³ä¹æ¨èç³»ç»Ÿ-è¯¦ç»†å®ç°.md`

è¿™äº›æ–‡æ¡£åŒ…å«åœºæ™¯ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å’Œå®ç°ç»†èŠ‚ã€‚

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: é€šç”¨æ¶æ„æ–‡æ¡£ï¼Œé€‚ç”¨äºæ‰€æœ‰æ¨èåœºæ™¯
