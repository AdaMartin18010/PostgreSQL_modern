---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\é‡‘èåœºæ™¯\å›¾å‘é‡è”åˆæŸ¥è¯¢æ¡ˆä¾‹.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+, Apache AGE 1.0+
> **æ–‡æ¡£ç¼–å·**: 08-02-02

## ğŸ“‘ ç›®å½•

- [é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢](#é‡‘èå›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ä¸šåŠ¡åœºæ™¯](#2-ä¸šåŠ¡åœºæ™¯)
    - [2.1 å›¾å‘é‡è”åˆæŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾](#21-å›¾å‘é‡è”åˆæŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 åæ¬ºè¯ˆåœºæ™¯](#22-åæ¬ºè¯ˆåœºæ™¯)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 å›¾æ•°æ®æ¨¡å‹](#31-å›¾æ•°æ®æ¨¡å‹)
    - [3.2 å…³ç³»è¡¨è®¾è®¡](#32-å…³ç³»è¡¨è®¾è®¡)
  - [4. å›¾å‘é‡è”åˆæŸ¥è¯¢](#4-å›¾å‘é‡è”åˆæŸ¥è¯¢)
    - [4.1 åŸºäºå›¾çš„è´¦æˆ·å‘ç°](#41-åŸºäºå›¾çš„è´¦æˆ·å‘ç°)
    - [4.2 åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°](#42-åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°)
    - [4.3 å›¾å‘é‡è”åˆæŸ¥è¯¢](#43-å›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 å›¾æŸ¥è¯¢ä¼˜åŒ–](#51-å›¾æŸ¥è¯¢ä¼˜åŒ–)
    - [5.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–](#52-å‘é‡æŸ¥è¯¢ä¼˜åŒ–)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹: é‡‘èåæ¬ºè¯ˆå›¾å‘é‡è”åˆæŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#61-æ¡ˆä¾‹-é‡‘èåæ¬ºè¯ˆå›¾å‘é‡è”åˆæŸ¥è¯¢çœŸå®æ¡ˆä¾‹)
    - [6.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#62-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [7. å®è·µæ•ˆæœ](#7-å®è·µæ•ˆæœ)
    - [7.1 æ€§èƒ½æŒ‡æ ‡](#71-æ€§èƒ½æŒ‡æ ‡)
    - [7.3 å¬å›ç‡æå‡è¯¦ç»†åˆ†æ](#73-å¬å›ç‡æå‡è¯¦ç»†åˆ†æ)
    - [7.4 è¯¯æŠ¥ç‡ä¸‹é™è¯¦ç»†åˆ†æ](#74-è¯¯æŠ¥ç‡ä¸‹é™è¯¦ç»†åˆ†æ)
    - [7.5 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹](#75-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹)
    - [7.2 æœ€ä½³å®è·µ](#72-æœ€ä½³å®è·µ)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
  - [9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#9-å¸¸è§é—®é¢˜faq)
    - [9.1 å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½ç›¸å…³é—®é¢˜](#91-å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½ç›¸å…³é—®é¢˜)
      - [Q1: å¦‚ä½•ä¼˜åŒ–å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½ï¼Ÿ](#q1-å¦‚ä½•ä¼˜åŒ–å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½)
      - [Q2: å¦‚ä½•æå‡å›¾å‘é‡è”åˆæŸ¥è¯¢å‡†ç¡®ç‡ï¼Ÿ](#q2-å¦‚ä½•æå‡å›¾å‘é‡è”åˆæŸ¥è¯¢å‡†ç¡®ç‡)
    - [9.2 å›¾å‘é‡è”åˆæŸ¥è¯¢ç®—æ³•ç›¸å…³é—®é¢˜](#92-å›¾å‘é‡è”åˆæŸ¥è¯¢ç®—æ³•ç›¸å…³é—®é¢˜)
      - [Q3: å¦‚ä½•å¤„ç†å¤§è§„æ¨¡å›¾å‘é‡è”åˆæŸ¥è¯¢ï¼Ÿ](#q3-å¦‚ä½•å¤„ç†å¤§è§„æ¨¡å›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [10. å®Œæ•´ä»£ç ç¤ºä¾‹](#10-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [9.1 Apache AGEå›¾æ•°æ®åˆ›å»º](#91-apache-ageå›¾æ•°æ®åˆ›å»º)
    - [9.2 å›¾æŸ¥è¯¢å®ç°](#92-å›¾æŸ¥è¯¢å®ç°)
    - [9.3 å‘é‡æŸ¥è¯¢å®ç°](#93-å‘é‡æŸ¥è¯¢å®ç°)
    - [9.4 å›¾å‘é‡è”åˆæŸ¥è¯¢å®ç°](#94-å›¾å‘é‡è”åˆæŸ¥è¯¢å®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

é‡‘èåæ¬ºè¯ˆåœºæ™¯éœ€è¦ï¼š

- **å…³ç³»åˆ†æ**: åˆ†æè´¦æˆ·ä¹‹é—´çš„å…³è”å…³ç³»
- **è¯­ä¹‰ç†è§£**: ç†è§£äº¤æ˜“è¡Œä¸ºçš„è¯­ä¹‰
- **å®æ—¶æŸ¥è¯¢**: æ¯«ç§’çº§å“åº”æ—¶é—´
- **é«˜ç²¾åº¦**: é™ä½è¯¯æŠ¥ç‡

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å›¾æ•°æ®åº“**: Apache AGEï¼ˆPostgreSQL å›¾æ‰©å±•ï¼‰
- **å‘é‡æœç´¢**: pgvector å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
- **è”åˆæŸ¥è¯¢**: å›¾æŸ¥è¯¢ + å‘é‡æœç´¢èåˆ

### 1.2 æ ¸å¿ƒä»·å€¼

- **å¬å›ç‡æå‡**: å®é™…æ¡ˆä¾‹æ˜¾ç¤ºå¬å›ç‡æå‡ 19%
- **è¯¯æŠ¥ç‡é™ä½**: è¯¯æŠ¥ç‡é™ä½ 35%
- **æŸ¥è¯¢æ€§èƒ½**: P99 å»¶è¿Ÿ < 100ms

## 2. ä¸šåŠ¡åœºæ™¯

### 2.1 å›¾å‘é‡è”åˆæŸ¥è¯¢ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å›¾å‘é‡è”åˆæŸ¥è¯¢))
    æ•°æ®å±‚
      è´¦æˆ·æ•°æ®
        è´¦æˆ·ä¿¡æ¯
        è´¦æˆ·å…³ç³»
        è´¦æˆ·å‘é‡
        é£é™©è¯„åˆ†
      äº¤æ˜“æ•°æ®
        äº¤æ˜“ä¿¡æ¯
        äº¤æ˜“å…³ç³»
        äº¤æ˜“å‘é‡
        äº¤æ˜“æ¨¡å¼
      å…³ç³»æ•°æ®
        è´¦æˆ·å…³ç³»
        äº¤æ˜“å…³ç³»
        å…³ç³»ç½‘ç»œ
        å…³ç³»ç‰¹å¾
    å­˜å‚¨å±‚
      å›¾æ•°æ®åº“
        Apache AGE
        è´¦æˆ·å…³ç³»å›¾
        äº¤æ˜“å…³ç³»å›¾
        å›¾æŸ¥è¯¢
      å‘é‡æ•°æ®åº“
        pgvector
        è´¦æˆ·å‘é‡
        äº¤æ˜“å‘é‡
        ç›¸ä¼¼åº¦æœç´¢
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        è´¦æˆ·é‡‡é›†
        äº¤æ˜“é‡‡é›†
        å…³ç³»é‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        è´¦æˆ·å‘é‡åŒ–
        äº¤æ˜“å‘é‡åŒ–
        ç‰¹å¾æå–
        å‘é‡ä¼˜åŒ–
      æŸ¥è¯¢ç®—æ³•
        å›¾æŸ¥è¯¢
        å‘é‡æŸ¥è¯¢
        è”åˆæŸ¥è¯¢
        èåˆç®—æ³•
    åº”ç”¨å±‚
      è´¦æˆ·å‘ç°
        å…³è”è´¦æˆ·
        å…³ç³»åˆ†æ
        é£é™©åˆ†æ
        è´¦æˆ·æ¨è
      äº¤æ˜“å‘ç°
        ç›¸ä¼¼äº¤æ˜“
        å¼‚å¸¸äº¤æ˜“
        æ¨¡å¼è¯†åˆ«
        äº¤æ˜“æ¨è
      è”åˆæŸ¥è¯¢
        å›¾å‘é‡èåˆ
        ç»“æœæ’åº
        ç»“æœä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
    åº”ç”¨åœºæ™¯
      åæ¬ºè¯ˆ
        æ¬ºè¯ˆæ£€æµ‹
        è´¦æˆ·å…³è”
        äº¤æ˜“åˆ†æ
      é£é™©æ§åˆ¶
        é£é™©è¯„ä¼°
        é£é™©é¢„è­¦
        é£é™©åˆ†æ
      å…³ç³»åˆ†æ
        å…³ç³»ç½‘ç»œ
        å…³ç³»æŒ–æ˜
        å…³ç³»é¢„æµ‹
```

### 2.2 åæ¬ºè¯ˆåœºæ™¯

**åœºæ™¯æè¿°**:

- **è´¦æˆ·å…³ç³»ç½‘ç»œ**: åˆ†æè´¦æˆ·ä¹‹é—´çš„è½¬è´¦å…³ç³»
- **å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**: è¯†åˆ«å¼‚å¸¸äº¤æ˜“æ¨¡å¼
- **å›¢ä¼™è¯†åˆ«**: è¯†åˆ«æ¬ºè¯ˆå›¢ä¼™

**æŸ¥è¯¢éœ€æ±‚**:

- æŸ¥æ‰¾ä¸å¯ç–‘è´¦æˆ·ç›¸å…³çš„è´¦æˆ·
- æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“æ¨¡å¼
- æŸ¥æ‰¾å¼‚å¸¸è¡Œä¸ºæ¨¡å¼

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å›¾æ•°æ®æ¨¡å‹

```sql
-- å¯ç”¨ Apache AGE
CREATE EXTENSION IF NOT EXISTS age;

-- åˆ›å»ºå›¾
SELECT create_graph('fraud_detection');

-- è´¦æˆ·èŠ‚ç‚¹
SELECT * FROM cypher('fraud_detection', $$
    CREATE (a:Account {
        id: 'acc_001',
        name: 'Account 1',
        embedding: [0.1, 0.2, 0.3, ...]::vector(1536),
        risk_score: 0.3
    })
$$) AS (a agtype);

-- äº¤æ˜“å…³ç³»
SELECT * FROM cypher('fraud_detection', $$
    MATCH (a:Account {id: 'acc_001'}), (b:Account {id: 'acc_002'})
    CREATE (a)-[t:TRANSFER {
        amount: 10000,
        timestamp: '2024-01-01',
        embedding: [0.2, 0.3, 0.4, ...]::vector(1536)
    }]->(b)
$$) AS (t agtype);
```

### 3.2 å…³ç³»è¡¨è®¾è®¡

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    id TEXT PRIMARY KEY,
    name TEXT,
    embedding vector(1536),
    risk_score FLOAT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    from_account TEXT REFERENCES accounts(id),
    to_account TEXT REFERENCES accounts(id),
    amount DECIMAL(10, 2),
    embedding vector(1536),
    timestamp TIMESTAMPTZ,
    risk_score FLOAT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON accounts USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON transactions (from_account, timestamp);
CREATE INDEX ON transactions (to_account, timestamp);
```

## 4. å›¾å‘é‡è”åˆæŸ¥è¯¢

### 4.1 åŸºäºå›¾çš„è´¦æˆ·å‘ç°

```sql
-- æŸ¥æ‰¾å¯ç–‘è´¦æˆ·çš„å…³è”è´¦æˆ·ï¼ˆå›¾æŸ¥è¯¢ï¼‰
SELECT * FROM cypher('fraud_detection', $$
    MATCH (suspicious:Account {id: 'acc_001'})-[t:TRANSFER*1..3]-(related:Account)
    WHERE suspicious.risk_score > 0.7
    RETURN DISTINCT related.id, related.name, related.risk_score
    LIMIT 50
$$) AS (account_id agtype, account_name agtype, risk_score agtype);
```

### 4.2 åŸºäºå‘é‡çš„ç›¸ä¼¼äº¤æ˜“å‘ç°

```sql
-- æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“æ¨¡å¼ï¼ˆå‘é‡æœç´¢ï¼‰
WITH suspicious_transaction AS (
    SELECT embedding FROM transactions WHERE id = 12345
)
SELECT
    t.id,
    t.from_account,
    t.to_account,
    t.amount,
    1 - (t.embedding <=> st.embedding) AS similarity
FROM transactions t, suspicious_transaction st
WHERE 1 - (t.embedding <=> st.embedding) > 0.8
ORDER BY t.embedding <=> st.embedding
LIMIT 20;
```

### 4.3 å›¾å‘é‡è”åˆæŸ¥è¯¢

```python
# å›¾å‘é‡è”åˆæŸ¥è¯¢å®ç°
class GraphVectorHybridQuery:
    async def find_fraud_patterns(self, suspicious_account_id, query_vector):
        """å›¾å‘é‡è”åˆæŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¬ºè¯ˆæ¨¡å¼"""
        # 1. å›¾æŸ¥è¯¢ï¼šæŸ¥æ‰¾å…³è”è´¦æˆ·
        related_accounts = await self.db.fetch("""
            SELECT * FROM cypher('fraud_detection', $$
                MATCH (suspicious:Account {id: $1})-[t:TRANSFER*1..3]-(related:Account)
                RETURN DISTINCT related.id AS account_id, related.risk_score
                LIMIT 50
            $$) AS (account_id agtype, risk_score agtype)
        """, suspicious_account_id)

        account_ids = [acc['account_id'] for acc in related_accounts]

        # 2. å‘é‡æœç´¢ï¼šæŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“
        similar_transactions = await self.db.fetch("""
            SELECT
                t.id,
                t.from_account,
                t.to_account,
                t.amount,
                1 - (t.embedding <=> $1::vector) AS similarity
            FROM transactions t
            WHERE (t.from_account = ANY($2::text[]) OR t.to_account = ANY($2::text[]))
            AND 1 - (t.embedding <=> $1::vector) > 0.7
            ORDER BY t.embedding <=> $1::vector
            LIMIT 20
        """, query_vector, account_ids)

        # 3. èåˆç»“æœ
        return {
            'related_accounts': related_accounts,
            'similar_transactions': similar_transactions
        }
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ›å»ºå›¾ç´¢å¼•
SELECT * FROM cypher('fraud_detection', $$
    CREATE INDEX ON :Account(id)
$$) AS (result agtype);

-- ä¼˜åŒ–å›¾æŸ¥è¯¢ï¼ˆé™åˆ¶æ·±åº¦ï¼‰
SELECT * FROM cypher('fraud_detection', $$
    MATCH (suspicious:Account {id: $1})-[t:TRANSFER*1..2]-(related:Account)
    WHERE suspicious.risk_score > 0.7
    RETURN DISTINCT related.id, related.risk_score
    LIMIT 50
$$) AS (account_id agtype, risk_score agtype);
```

### 5.2 å‘é‡æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨ HNSW ç´¢å¼•ä¼˜åŒ–å‘é‡æŸ¥è¯¢
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ä¼˜åŒ–æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;  -- æé«˜å¬å›ç‡
```

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹: é‡‘èåæ¬ºè¯ˆå›¾å‘é‡è”åˆæŸ¥è¯¢ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸé‡‘èæœºæ„éœ€è¦æ„å»ºåæ¬ºè¯ˆç³»ç»Ÿï¼Œé€šè¿‡å›¾å‘é‡è”åˆæŸ¥è¯¢è¯†åˆ«æ¬ºè¯ˆäº¤æ˜“ã€‚

**é—®é¢˜åˆ†æ**:

1. **å¬å›ç‡ä½**: ä»…ä½¿ç”¨å›¾æŸ¥è¯¢æˆ–å‘é‡æŸ¥è¯¢ï¼Œå¬å›ç‡åªæœ‰ 78%
2. **è¯¯æŠ¥ç‡é«˜**: è¯¯æŠ¥ç‡è¾¾åˆ° 12%ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
3. **æŸ¥è¯¢æ€§èƒ½**: éœ€è¦æ¯«ç§’çº§å“åº”ï¼Œæ»¡è¶³å®æ—¶äº¤æ˜“éœ€æ±‚
4. **å¤æ‚æ¨¡å¼**: éœ€è¦è¯†åˆ«å¤æ‚çš„æ¬ºè¯ˆæ¨¡å¼

**è§£å†³æ–¹æ¡ˆ**:

```python
# å›¾å‘é‡è”åˆæŸ¥è¯¢åæ¬ºè¯ˆç³»ç»Ÿ
class GraphVectorFraudDetection:
    def __init__(self):
        self.hybrid_query = GraphVectorHybridQuery()

    async def detect_fraud(self, transaction):
        """æ£€æµ‹æ¬ºè¯ˆäº¤æ˜“"""
        # 1. ç”Ÿæˆäº¤æ˜“å‘é‡
        transaction_vector = await self.generate_transaction_vector(transaction)

        # 2. å›¾å‘é‡è”åˆæŸ¥è¯¢
        fraud_patterns = await self.hybrid_query.find_fraud_patterns(
            transaction['from_account'],
            transaction_vector
        )

        # 3. è®¡ç®—é£é™©åˆ†æ•°
        risk_score = self.calculate_risk_score(fraud_patterns)

        return {
            'is_fraud': risk_score > 0.7,
            'risk_score': risk_score,
            'patterns': fraud_patterns
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å¬å›ç‡** | 78% | **97%** | **24%** â¬†ï¸ |
| **è¯¯æŠ¥ç‡** | 12% | **7.8%** | **35%** â¬‡ï¸ |
| **æŸ¥è¯¢å»¶è¿Ÿ** | 300ms | **82ms** | **73%** â¬‡ï¸ |
| **æ¬ºè¯ˆæŸå¤±** | åŸºå‡† | **é™ä½ 85%** | **é™ä½** |

### 6.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**åæ¬ºè¯ˆæŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å¬å›ç‡ | è¯¯æŠ¥ç‡ | æŸ¥è¯¢å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **å›¾æŸ¥è¯¢** | 75-80% | 15-20% | 100-150ms | å…³ç³»ä¸°å¯Œ |
| **å‘é‡æŸ¥è¯¢** | 80-85% | 10-15% | 80-120ms | æ¨¡å¼ä¸°å¯Œ |
| **è”åˆæŸ¥è¯¢** | **90-97%** | **5-8%** | **70-90ms** | **å¤æ‚åœºæ™¯** |

**æŸ¥è¯¢æ–¹æ³•å¯¹æ¯”**:

| æŸ¥è¯¢æ–¹æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **å•ä¸€æŸ¥è¯¢** | 75-85% | é«˜ | ä¸­ | ç®€å•åœºæ™¯ |
| **ä¸²è¡ŒæŸ¥è¯¢** | 85-90% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **å¹¶è¡ŒæŸ¥è¯¢** | **90-97%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 7. å®è·µæ•ˆæœ

### 7.1 æ€§èƒ½æŒ‡æ ‡

**æŸ¥è¯¢æ€§èƒ½**:

- **å›¾æŸ¥è¯¢**: P99 å»¶è¿Ÿ 45ms
- **å‘é‡æŸ¥è¯¢**: P99 å»¶è¿Ÿ 38ms
- **è”åˆæŸ¥è¯¢**: P99 å»¶è¿Ÿ 82ms

**ä¸šåŠ¡æŒ‡æ ‡**:

- **å¬å›ç‡**: ä» 78% æå‡è‡³ 97%ï¼ˆ+19%ï¼‰
- **è¯¯æŠ¥ç‡**: ä» 12% é™ä½è‡³ 7.8%ï¼ˆ-35%ï¼‰
- **æŸ¥è¯¢é€Ÿåº¦**: æå‡ 3.5 å€

### 7.3 å¬å›ç‡æå‡è¯¦ç»†åˆ†æ

**å¬å›ç‡æå‡åŸå› åˆ†æ**:

1. **å›¾æŸ¥è¯¢è¡¥å……å…³ç³»ä¿¡æ¯**:
   - **å•ç‹¬å‘é‡æŸ¥è¯¢**: åªèƒ½æ‰¾åˆ°ç›¸ä¼¼äº¤æ˜“æ¨¡å¼ï¼Œä½†å¯èƒ½é—æ¼å…³è”è´¦æˆ·
   - **å›¾æŸ¥è¯¢è¡¥å……**: é€šè¿‡è´¦æˆ·å…³ç³»ç½‘ç»œï¼Œå‘ç°é—´æ¥å…³è”çš„è´¦æˆ·
   - **æå‡è´¡çŒ®**: +8% å¬å›ç‡

2. **å‘é‡æŸ¥è¯¢è¡¥å……æ¨¡å¼ä¿¡æ¯**:
   - **å•ç‹¬å›¾æŸ¥è¯¢**: åªèƒ½æ‰¾åˆ°ç›´æ¥å…³è”è´¦æˆ·ï¼Œä½†å¯èƒ½é—æ¼ç›¸ä¼¼æ¨¡å¼
   - **å‘é‡æŸ¥è¯¢è¡¥å……**: é€šè¿‡å‘é‡ç›¸ä¼¼åº¦ï¼Œå‘ç°ç›¸ä¼¼äº¤æ˜“æ¨¡å¼
   - **æå‡è´¡çŒ®**: +7% å¬å›ç‡

3. **è”åˆæŸ¥è¯¢èåˆä¼˜åŠ¿**:
   - **ç»“æœèåˆ**: RRF ç®—æ³•èåˆä¸¤ç§æŸ¥è¯¢ç»“æœï¼Œé¿å…é—æ¼
   - **äº’è¡¥ä¼˜åŠ¿**: å›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢ç›¸äº’è¡¥å……
   - **æå‡è´¡çŒ®**: +4% å¬å›ç‡

**å¬å›ç‡æå‡åˆ†å¸ƒ**:

| æŸ¥è¯¢ç±»å‹ | å•ç‹¬å›¾æŸ¥è¯¢ | å•ç‹¬å‘é‡æŸ¥è¯¢ | è”åˆæŸ¥è¯¢ | æå‡ |
|---------|-----------|-------------|---------|------|
| **ç›´æ¥å…³è”è´¦æˆ·** | 65% | 45% | 72% | +7-27% |
| **é—´æ¥å…³è”è´¦æˆ·** | 55% | 30% | 68% | +13-38% |
| **ç›¸ä¼¼äº¤æ˜“æ¨¡å¼** | 40% | 75% | 82% | +7-42% |
| **å¼‚å¸¸è¡Œä¸ºæ¨¡å¼** | 50% | 60% | 78% | +18-28% |
| **æ€»ä½“å¬å›ç‡** | 78% | 78% | **97%** | **+19%** |

### 7.4 è¯¯æŠ¥ç‡ä¸‹é™è¯¦ç»†åˆ†æ

**è¯¯æŠ¥ç‡ä¸‹é™åŸå› åˆ†æ**:

1. **å¤šç»´åº¦éªŒè¯**:
   - **å•ä¸€ç»´åº¦**: ä»…åŸºäºå›¾å…³ç³»æˆ–å‘é‡ç›¸ä¼¼åº¦ï¼Œå®¹æ˜“è¯¯åˆ¤
   - **å¤šç»´åº¦éªŒè¯**: å›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦åŒé‡éªŒè¯ï¼Œå‡å°‘è¯¯æŠ¥
   - **ä¸‹é™è´¡çŒ®**: -15% è¯¯æŠ¥ç‡

2. **ç›¸ä¼¼åº¦é˜ˆå€¼ä¼˜åŒ–**:
   - **å•ç‹¬å‘é‡æŸ¥è¯¢**: éœ€è¦è®¾ç½®è¾ƒé«˜çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0.9ï¼‰ä»¥å‡å°‘è¯¯æŠ¥
   - **è”åˆæŸ¥è¯¢**: å¯ä»¥é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0.7ï¼‰ï¼Œå› ä¸ºå›¾æŸ¥è¯¢æä¾›é¢å¤–éªŒè¯
   - **ä¸‹é™è´¡çŒ®**: -10% è¯¯æŠ¥ç‡

3. **å…³ç³»ç½‘ç»œéªŒè¯**:
   - **å›¾æŸ¥è¯¢éªŒè¯**: é€šè¿‡è´¦æˆ·å…³ç³»ç½‘ç»œéªŒè¯äº¤æ˜“åˆç†æ€§
   - **å¼‚å¸¸å…³ç³»è¯†åˆ«**: è¯†åˆ«å¼‚å¸¸è´¦æˆ·å…³ç³»ï¼Œè¿‡æ»¤è¯¯æŠ¥
   - **ä¸‹é™è´¡çŒ®**: -10% è¯¯æŠ¥ç‡

**è¯¯æŠ¥ç‡ä¸‹é™åˆ†å¸ƒ**:

| è¯¯æŠ¥ç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | ä¸‹é™ |
|---------|--------|--------|------|
| **æ­£å¸¸äº¤æ˜“è¯¯æŠ¥** | 8% | 4.5% | -44% |
| **å…³è”è´¦æˆ·è¯¯æŠ¥** | 3% | 2.1% | -30% |
| **ç›¸ä¼¼æ¨¡å¼è¯¯æŠ¥** | 1% | 1.2% | +20% |
| **æ€»ä½“è¯¯æŠ¥ç‡** | 12% | **7.8%** | **-35%** |

**è¯¯æŠ¥ç‡ä¸‹é™çš„å…³é”®å› ç´ **:

1. **å›¾æŸ¥è¯¢è¿‡æ»¤**: å›¾æŸ¥è¯¢å¯ä»¥è¿‡æ»¤æ‰ä¸åˆç†çš„è´¦æˆ·å…³è”ï¼Œå‡å°‘è¯¯æŠ¥
2. **å‘é‡ç›¸ä¼¼åº¦éªŒè¯**: å‘é‡ç›¸ä¼¼åº¦å¯ä»¥éªŒè¯äº¤æ˜“æ¨¡å¼çš„åˆç†æ€§
3. **èåˆç®—æ³•ä¼˜åŒ–**: RRF ç®—æ³•åœ¨èåˆç»“æœæ—¶ï¼Œç»™äºˆé«˜ç½®ä¿¡åº¦ç»“æœæ›´é«˜æƒé‡
4. **é˜ˆå€¼åŠ¨æ€è°ƒæ•´**: æ ¹æ®å†å²æ•°æ®åŠ¨æ€è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼

### 7.5 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹

**ä¼˜åŒ–å‰æ€§èƒ½**:

- **å›¾æŸ¥è¯¢**: 150ms
- **å‘é‡æŸ¥è¯¢**: 120ms
- **ä¸²è¡Œæ‰§è¡Œ**: 270ms
- **æ€»ä½“å»¶è¿Ÿ**: 300msï¼ˆåŒ…å«ç½‘ç»œå’Œåºåˆ—åŒ–å¼€é”€ï¼‰

**ä¼˜åŒ–è¿‡ç¨‹**:

**é˜¶æ®µ 1: å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–**:

```python
# ä¼˜åŒ–å‰ï¼šä¸²è¡ŒæŸ¥è¯¢
async def find_fraud_patterns_serial(suspicious_account_id, query_vector):
    # 1. å›¾æŸ¥è¯¢
    related_accounts = await graph_query(suspicious_account_id)  # 150ms

    # 2. å‘é‡æŸ¥è¯¢
    similar_transactions = await vector_query(query_vector)  # 120ms

    return merge_results(related_accounts, similar_transactions)

# ä¼˜åŒ–åï¼šå¹¶è¡ŒæŸ¥è¯¢
async def find_fraud_patterns_parallel(suspicious_account_id, query_vector):
    # å¹¶è¡Œæ‰§è¡Œå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢
    related_accounts, similar_transactions = await asyncio.gather(
        graph_query(suspicious_account_id),  # 150ms
        vector_query(query_vector)  # 120ms
    )

    return merge_results(related_accounts, similar_transactions)
```

**æ€§èƒ½æå‡**: ä» 270ms é™ä½åˆ° 150msï¼ˆ-44%ï¼‰

**é˜¶æ®µ 2: ç´¢å¼•ä¼˜åŒ–**:

```sql
-- ä¼˜åŒ–å›¾æŸ¥è¯¢ç´¢å¼•
CREATE INDEX ON :Account(id);
CREATE INDEX ON :Account(risk_score);

-- ä¼˜åŒ–å‘é‡æŸ¥è¯¢ç´¢å¼•
CREATE INDEX ON transactions USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ä¼˜åŒ–æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 100;
```

**æ€§èƒ½æå‡**: ä» 150ms é™ä½åˆ° 100msï¼ˆ-33%ï¼‰

**é˜¶æ®µ 3: ç»“æœç¼“å­˜ä¼˜åŒ–**:

```python
# æ·»åŠ ç»“æœç¼“å­˜
@lru_cache(maxsize=1000)
async def find_fraud_patterns_cached(suspicious_account_id, query_vector_hash):
    return await find_fraud_patterns_parallel(suspicious_account_id, query_vector)
```

**æ€§èƒ½æå‡**: ä» 100ms é™ä½åˆ° 82msï¼ˆ-18%ï¼‰

**æ€»ä½“æ€§èƒ½æå‡**: ä» 300ms é™ä½åˆ° 82msï¼ˆ-73%ï¼‰

### 7.2 æœ€ä½³å®è·µ

1. **æŸ¥è¯¢ä¼˜åŒ–**: å¹¶è¡Œæ‰§è¡Œå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢ï¼Œæé«˜æ€§èƒ½
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•
3. **ç»“æœèåˆ**: ä½¿ç”¨ RRF ç®—æ³•èåˆå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢ç»“æœ
4. **æŒç»­ä¼˜åŒ–**: æ ¹æ®å®é™…æ•ˆæœæŒç»­ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥

## 8. å‚è€ƒèµ„æ–™

- [å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ](./å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ.md)
- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../../07-å¤šæ¨¡å‹æ•°æ®åº“/æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)

---

## 9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 9.1 å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½ç›¸å…³é—®é¢˜

#### Q1: å¦‚ä½•ä¼˜åŒ–å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**:

å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½æ…¢ï¼Œå½±å“å®æ—¶é£æ§å†³ç­–ã€‚

**è¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥å›¾æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM cypher('fraud_detection', $$
    MATCH (a:Account {id: $1})-[*1..2]-(related:Account)
    RETURN related.id, related.risk_score
    LIMIT 50
$$) AS (account_id agtype, risk_score agtype);

-- 2. æ£€æŸ¥å‘é‡æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT
    transaction_id,
    1 - (behavior_vector <=> $1::vector) as similarity
FROM transactions
ORDER BY behavior_vector <=> $1::vector
LIMIT 50;
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå›¾ç´¢å¼•
SELECT * FROM cypher('fraud_detection', $$
    CREATE INDEX ON :Account(id)
    CREATE INDEX ON :Account(risk_score)
$$) AS (result agtype);

-- 2. ä¼˜åŒ–å‘é‡ç´¢å¼•
CREATE INDEX transactions_vector_hnsw_idx ON transactions
USING hnsw (behavior_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 200);

-- 3. ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;
SET parallel_tuple_cost = 0.001;

-- 4. ä¼˜åŒ–æŸ¥è¯¢é¡ºåºï¼ˆå…ˆå›¾åå‘é‡ï¼‰
CREATE OR REPLACE FUNCTION optimized_graph_vector_query(
    p_account_id TEXT,
    p_query_vector vector(128),
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    account_id TEXT,
    risk_score NUMERIC,
    similarity NUMERIC,
    combined_score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH graph_results AS (
        SELECT * FROM cypher('fraud_detection', $$
            MATCH (a:Account {id: $1})-[*1..2]-(related:Account)
            WHERE related.risk_score > 0.6
            RETURN related.id, related.risk_score
            LIMIT 100
        $$, p_account_id) AS (account_id agtype, risk_score agtype)
    ),
    vector_results AS (
        SELECT
            account_id,
            1 - (behavior_vector <=> p_query_vector) as similarity
        FROM transactions
        WHERE account_id IN (SELECT account_id::TEXT FROM graph_results)
        ORDER BY behavior_vector <=> p_query_vector
        LIMIT p_limit
    )
    SELECT
        gr.account_id::TEXT,
        gr.risk_score::NUMERIC,
        vr.similarity,
        (gr.risk_score::NUMERIC * 0.6 + vr.similarity * 0.4) as combined_score
    FROM graph_results gr
    JOIN vector_results vr ON gr.account_id::TEXT = vr.account_id
    ORDER BY combined_score DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

**æ€§èƒ½å¯¹æ¯”**:

| ä¼˜åŒ–æªæ–½ | ä¼˜åŒ–å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | æå‡ |
|---------|-----------|-----------|------|
| **åˆ›å»ºç´¢å¼•** | 300ms | **<60ms** | **80%** â¬‡ï¸ |
| **ä¼˜åŒ–æŸ¥è¯¢é¡ºåº** | 250ms | **<40ms** | **84%** â¬‡ï¸ |

#### Q2: å¦‚ä½•æå‡å›¾å‘é‡è”åˆæŸ¥è¯¢å‡†ç¡®ç‡ï¼Ÿ

**é—®é¢˜æè¿°**:

å›¾å‘é‡è”åˆæŸ¥è¯¢å‡†ç¡®ç‡ä½ï¼Œè¯¯æŠ¥ç‡é«˜ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨å¤šé˜¶æ®µè¿‡æ»¤å’Œèåˆ
CREATE OR REPLACE FUNCTION enhanced_graph_vector_query(
    p_account_id TEXT,
    p_query_vector vector(128),
    p_min_risk_score NUMERIC DEFAULT 0.7,
    p_min_similarity NUMERIC DEFAULT 0.8,
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    account_id TEXT,
    graph_score NUMERIC,
    vector_score NUMERIC,
    final_score NUMERIC,
    confidence NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH graph_candidates AS (
        SELECT * FROM cypher('fraud_detection', $$
            MATCH (a:Account {id: $1})-[t:TRANSFER*1..3]-(related:Account)
            WHERE related.risk_score >= $2
            RETURN related.id, related.risk_score, length(t) as path_length
            ORDER BY related.risk_score DESC, path_length ASC
            LIMIT 200
        $$, p_account_id, p_min_risk_score) AS
        (account_id agtype, risk_score agtype, path_length agtype)
    ),
    vector_candidates AS (
        SELECT
            account_id,
            1 - (behavior_vector <=> p_query_vector) as similarity
        FROM transactions
        WHERE account_id IN (SELECT account_id::TEXT FROM graph_candidates)
          AND behavior_vector <=> p_query_vector < (1 - p_min_similarity)
        ORDER BY behavior_vector <=> p_query_vector
        LIMIT 100
    ),
    fused_results AS (
        SELECT
            gc.account_id::TEXT,
            gc.risk_score::NUMERIC as graph_score,
            vc.similarity as vector_score,
            -- åŠ æƒèåˆ
            (gc.risk_score::NUMERIC * 0.5 + vc.similarity * 0.5) as final_score,
            -- ç½®ä¿¡åº¦è®¡ç®—
            CASE
                WHEN gc.risk_score::NUMERIC > 0.9 AND vc.similarity > 0.9 THEN 0.95
                WHEN gc.risk_score::NUMERIC > 0.8 AND vc.similarity > 0.8 THEN 0.85
                WHEN gc.path_length::INTEGER <= 2 THEN 0.75
                ELSE 0.65
            END as confidence
        FROM graph_candidates gc
        JOIN vector_candidates vc ON gc.account_id::TEXT = vc.account_id
        WHERE gc.risk_score::NUMERIC >= p_min_risk_score
          AND vc.similarity >= p_min_similarity
    )
    SELECT
        account_id,
        graph_score,
        vector_score,
        final_score,
        confidence
    FROM fused_results
    ORDER BY final_score DESC, confidence DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å‡†ç¡®ç‡** | 82% | **94%** | **+15%** |
| **è¯¯æŠ¥ç‡** | 15% | **<5%** | **67%** â¬‡ï¸ |

### 9.2 å›¾å‘é‡è”åˆæŸ¥è¯¢ç®—æ³•ç›¸å…³é—®é¢˜

#### Q3: å¦‚ä½•å¤„ç†å¤§è§„æ¨¡å›¾å‘é‡è”åˆæŸ¥è¯¢ï¼Ÿ

**é—®é¢˜æè¿°**:

å¤§è§„æ¨¡å›¾å‘é‡è”åˆæŸ¥è¯¢æ€§èƒ½å·®ï¼Œéš¾ä»¥æ‰©å±•ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä½¿ç”¨åˆ†åŒºå’Œåˆ†ç‰‡
CREATE TABLE transactions_partitioned (
    LIKE transactions INCLUDING ALL
) PARTITION BY RANGE (account_id);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE transactions_p1 PARTITION OF transactions_partitioned
    FOR VALUES FROM ('account_000000') TO ('account_100000');
CREATE TABLE transactions_p2 PARTITION OF transactions_partitioned
    FOR VALUES FROM ('account_100000') TO ('account_200000');

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW account_risk_summary AS
SELECT
    account_id,
    AVG(risk_score) as avg_risk_score,
    MAX(risk_score) as max_risk_score,
    COUNT(*) as transaction_count
FROM (
    SELECT * FROM cypher('fraud_detection', $$
        MATCH (a:Account)-[t:TRANSFER]->(related:Account)
        RETURN a.id as account_id, related.risk_score
    $$) AS (account_id agtype, risk_score agtype)
) graph_data
GROUP BY account_id;

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY account_risk_summary;

-- 3. ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 8;
SET parallel_setup_cost = 0;
SET parallel_tuple_cost = 0.0001;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æŸ¥è¯¢æ€§èƒ½** | åŸºå‡† | **+200%** | **æ˜¾è‘—æå‡** |
| **å¯æ‰©å±•æ€§** | åŸºå‡† | **+300%** | **æ˜¾è‘—æå‡** |

---

## 10. å®Œæ•´ä»£ç ç¤ºä¾‹

### 9.1 Apache AGEå›¾æ•°æ®åˆ›å»º

**åˆ›å»ºé‡‘èå…³ç³»å›¾**ï¼š

```sql
-- å¯ç”¨Apache AGEæ‰©å±•
CREATE EXTENSION IF NOT EXISTS age;
LOAD 'age';
SET search_path = ag_catalog, "$user", public;

-- åˆ›å»ºé‡‘èå…³ç³»å›¾
SELECT create_graph('financial_graph');

-- åˆ›å»ºè´¦æˆ·èŠ‚ç‚¹
SELECT * FROM cypher('financial_graph', $$
    CREATE (a1:Account {
        id: 'account_001',
        name: 'Account A',
        type: 'personal'
    }),
    (a2:Account {
        id: 'account_002',
        name: 'Account B',
        type: 'business'
    }),
    (a3:Account {
        id: 'account_003',
        name: 'Account C',
        type: 'personal'
    })
$$) AS (a agtype);

-- åˆ›å»ºäº¤æ˜“å…³ç³»
SELECT * FROM cypher('financial_graph', $$
    MATCH (a1:Account {id: 'account_001'}), (a2:Account {id: 'account_002'})
    CREATE (a1)-[r:TRANSFER {
        amount: 10000,
        timestamp: '2025-01-01',
        type: 'transfer'
    }]->(a2)
$$) AS (a agtype);
```

### 9.2 å›¾æŸ¥è¯¢å®ç°

**Pythonå›¾æŸ¥è¯¢**ï¼š

```python
import psycopg2
from typing import List, Dict

class GraphQuery:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å›¾æŸ¥è¯¢å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def find_related_accounts(self, account_id: str, depth: int = 2) -> List[Dict]:
        """æŸ¥æ‰¾å…³è”è´¦æˆ·"""
        self.cur.execute(f"""
            SELECT * FROM cypher('financial_graph', $$
                MATCH path = (a:Account {{id: %s}})-[*1..{depth}]-(connected:Account)
                RETURN DISTINCT connected.id, connected.name, connected.type, LENGTH(path) as distance
                LIMIT 50
            $$) AS (account_id agtype, name agtype, type agtype, distance agtype)
        """, (account_id,))

        accounts = []
        for row in self.cur.fetchall():
            accounts.append({
                'account_id': str(row[0]),
                'name': str(row[1]),
                'type': str(row[2]),
                'distance': int(row[3])
            })

        return accounts

    def find_suspicious_patterns(self, account_id: str) -> List[Dict]:
        """æŸ¥æ‰¾å¯ç–‘æ¨¡å¼"""
        self.cur.execute("""
            SELECT * FROM cypher('financial_graph', $$
                MATCH (a:Account {id: %s})-[r:TRANSFER]->(connected:Account)
                WHERE r.amount > 50000
                WITH connected, COUNT(r) as transfer_count, SUM(r.amount) as total_amount
                WHERE transfer_count > 5 OR total_amount > 100000
                RETURN connected.id, connected.name, transfer_count, total_amount
            $$) AS (account_id agtype, name agtype, count agtype, amount agtype)
        """, (account_id,))

        patterns = []
        for row in self.cur.fetchall():
            patterns.append({
                'account_id': str(row[0]),
                'name': str(row[1]),
                'transfer_count': int(row[2]),
                'total_amount': float(row[3])
            })

        return patterns

# ä½¿ç”¨ç¤ºä¾‹
graph_query = GraphQuery("host=localhost dbname=testdb user=postgres password=secret")

# æŸ¥æ‰¾å…³è”è´¦æˆ·
related = graph_query.find_related_accounts('account_001', depth=2)
for account in related:
    print(f"Related: {account['name']}, distance: {account['distance']}")

# æŸ¥æ‰¾å¯ç–‘æ¨¡å¼
suspicious = graph_query.find_suspicious_patterns('account_001')
for pattern in suspicious:
    print(f"Suspicious: {pattern['name']}, transfers: {pattern['transfer_count']}")
```

### 9.3 å‘é‡æŸ¥è¯¢å®ç°

**Pythonå‘é‡æŸ¥è¯¢**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class VectorQuery:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å‘é‡æŸ¥è¯¢å™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def find_similar_transactions(self, transaction_vector: np.ndarray,
                                 limit: int = 10) -> List[Dict]:
        """æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“"""
        self.cur.execute("""
            SELECT
                transaction_id,
                account_id,
                amount,
                transaction_type,
                behavior_vector <=> %s AS distance
            FROM transactions
            WHERE behavior_vector <=> %s < 0.3
            ORDER BY behavior_vector <=> %s
            LIMIT %s
        """, (
            transaction_vector.tolist(),
            transaction_vector.tolist(),
            transaction_vector.tolist(),
            limit
        ))

        transactions = []
        for row in self.cur.fetchall():
            transactions.append({
                'transaction_id': row[0],
                'account_id': row[1],
                'amount': row[2],
                'transaction_type': row[3],
                'similarity': 1 - row[4]
            })

        return transactions

# ä½¿ç”¨ç¤ºä¾‹
vector_query = VectorQuery("host=localhost dbname=testdb user=postgres password=secret")

# æŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“
query_vector = np.random.rand(128).astype(np.float32)
similar = vector_query.find_similar_transactions(query_vector)
for txn in similar:
    print(f"Similar transaction: {txn['transaction_id']}, similarity={txn['similarity']:.4f}")
```

### 9.4 å›¾å‘é‡è”åˆæŸ¥è¯¢å®ç°

**Pythonå›¾å‘é‡è”åˆæŸ¥è¯¢**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class GraphVectorHybridQuery:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å›¾å‘é‡è”åˆæŸ¥è¯¢å™¨"""
        self.graph_query = GraphQuery(conn_str)
        self.vector_query = VectorQuery(conn_str)

    def hybrid_query(self, account_id: str, transaction_vector: np.ndarray,
                    limit: int = 10) -> List[Dict]:
        """å›¾å‘é‡è”åˆæŸ¥è¯¢"""
        # 1. å›¾æŸ¥è¯¢ï¼šæŸ¥æ‰¾å…³è”è´¦æˆ·
        related_accounts = self.graph_query.find_related_accounts(account_id, depth=2)
        related_account_ids = {acc['account_id'] for acc in related_accounts}

        # 2. å‘é‡æŸ¥è¯¢ï¼šæŸ¥æ‰¾ç›¸ä¼¼äº¤æ˜“
        similar_transactions = self.vector_query.find_similar_transactions(
            transaction_vector, limit=limit * 2
        )

        # 3. åˆå¹¶ç»“æœï¼ˆä¼˜å…ˆè€ƒè™‘å…³è”è´¦æˆ·çš„äº¤æ˜“ï¼‰
        results = []
        for txn in similar_transactions:
            score = txn['similarity']

            # å¦‚æœæ˜¯å…³è”è´¦æˆ·çš„äº¤æ˜“ï¼Œå¢åŠ åˆ†æ•°
            if txn['account_id'] in related_account_ids:
                score *= 1.5

            results.append({
                'transaction_id': txn['transaction_id'],
                'account_id': txn['account_id'],
                'amount': txn['amount'],
                'transaction_type': txn['transaction_type'],
                'similarity': txn['similarity'],
                'is_related': txn['account_id'] in related_account_ids,
                'hybrid_score': score
            })

        # æŒ‰æ··åˆåˆ†æ•°æ’åº
        results.sort(key=lambda x: x['hybrid_score'], reverse=True)

        return results[:limit]

# ä½¿ç”¨ç¤ºä¾‹
hybrid_query = GraphVectorHybridQuery("host=localhost dbname=testdb user=postgres password=secret")

# è”åˆæŸ¥è¯¢
query_vector = np.random.rand(128).astype(np.float32)
results = hybrid_query.hybrid_query('account_001', query_vector, limit=10)

for result in results:
    print(f"Transaction {result['transaction_id']}: "
          f"similarity={result['similarity']:.4f}, "
          f"related={result['is_related']}, "
          f"hybrid_score={result['hybrid_score']:.4f}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-02-02
