# PostgreSQLç”µå•†è¡Œä¸šå®Œæ•´æ¡ˆä¾‹

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **è¡Œä¸š**: ç”µå•†
> **ç‰¹ç‚¹**: é«˜å¹¶å‘ã€ç§’æ€ã€æ¨èç³»ç»Ÿã€æœç´¢
> **å‚è€ƒæ¡ˆä¾‹**: [01-ç”µå•†ç§’æ€ç³»ç»Ÿ](./01-ç”µå•†ç§’æ€ç³»ç»Ÿ/README.md)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLç”µå•†è¡Œä¸šå®Œæ•´æ¡ˆä¾‹](#postgresqlç”µå•†è¡Œä¸šå®Œæ•´æ¡ˆä¾‹)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç”µå•†è¡Œä¸šæ ¸å¿ƒåœºæ™¯](#2-ç”µå•†è¡Œä¸šæ ¸å¿ƒåœºæ™¯)
  - [3. æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
  - [4. æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

---

## 1. æ¦‚è¿°

### 1.1 ç”µå•†è¡Œä¸šç‰¹ç‚¹

ç”µå•†è¡Œä¸šå¯¹æ•°æ®åº“çš„è¦æ±‚ï¼š

- âœ… **é«˜å¹¶å‘**: 10ä¸‡+ QPSï¼ˆç§’æ€åœºæ™¯ï¼‰
- âœ… **ä½å»¶è¿Ÿ**: P99 < 100ms
- âœ… **é«˜å¯ç”¨**: 99.99%+å¯ç”¨æ€§
- âœ… **æ¨èç³»ç»Ÿ**: ä¸ªæ€§åŒ–æ¨è
- âœ… **æœç´¢ç³»ç»Ÿ**: å…¨æ–‡æœç´¢

### 1.2 æ ¸å¿ƒåœºæ™¯

- **ç§’æ€ç³»ç»Ÿ**: é«˜å¹¶å‘ç§’æ€
- **å•†å“æœç´¢**: å…¨æ–‡æœç´¢
- **æ¨èç³»ç»Ÿ**: ä¸ªæ€§åŒ–æ¨è
- **è®¢å•ç³»ç»Ÿ**: è®¢å•å¤„ç†
- **åº“å­˜ç®¡ç†**: åº“å­˜æ‰£å‡

---

## 2. ç”µå•†è¡Œä¸šæ ¸å¿ƒåœºæ™¯

### 2.1 ç§’æ€ç³»ç»Ÿ

**å‚è€ƒ**: [01-ç”µå•†ç§’æ€ç³»ç»Ÿ](./01-ç”µå•†ç§’æ€ç³»ç»Ÿ/README.md)

**æ ¸å¿ƒéœ€æ±‚**:
- 10ä¸‡+ QPS
- é›¶è¶…å–
- ä½å»¶è¿Ÿ
- é«˜å¯ç”¨

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- å•†å“è¡¨
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    stock INT NOT NULL,
    price NUMERIC(10,2) NOT NULL
);

-- ç§’æ€è®¢å•è¡¨
CREATE TABLE seckill_orders (
    order_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç§’æ€æ‰£åº“å­˜ï¼ˆä½¿ç”¨SERIALIZABLEï¼‰
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
UPDATE products 
SET stock = stock - 1
WHERE product_id = 12345 
AND stock > 0;
INSERT INTO seckill_orders (user_id, product_id)
VALUES (67890, 12345);
COMMIT;
```

### 2.2 å•†å“æœç´¢

**æ ¸å¿ƒéœ€æ±‚**:
- å…¨æ–‡æœç´¢
- å¤šæ¡ä»¶ç­›é€‰
- æ’åºä¼˜åŒ–
- æœç´¢å»ºè®®

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- å•†å“è¡¨ï¼ˆå…¨æ–‡æœç´¢ï¼‰
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category_id INT,
    price NUMERIC(10,2),
    search_vector tsvector
);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_products_search ON products USING GIN(search_vector);

-- æ›´æ–°æœç´¢å‘é‡
CREATE TRIGGER products_search_update
BEFORE INSERT OR UPDATE ON products
FOR EACH ROW EXECUTE FUNCTION
tsvector_update_trigger(search_vector, 'pg_catalog.english', name, description);

-- å…¨æ–‡æœç´¢æŸ¥è¯¢
SELECT 
    product_id,
    name,
    price,
    ts_rank(search_vector, query) as rank
FROM products, to_tsquery('english', 'laptop') query
WHERE search_vector @@ query
ORDER BY rank DESC
LIMIT 20;
```

### 2.3 æ¨èç³»ç»Ÿ

**æ ¸å¿ƒéœ€æ±‚**:
- ä¸ªæ€§åŒ–æ¨è
- å®æ—¶æ›´æ–°
- å‘é‡æœç´¢
- æ··åˆæ¨è

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- ç”¨æˆ·å‘é‡è¡¨
CREATE TABLE user_vectors (
    user_id BIGINT PRIMARY KEY,
    preference_vector vector(128),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å•†å“å‘é‡è¡¨
CREATE TABLE product_vectors (
    product_id BIGINT PRIMARY KEY,
    embedding vector(128),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å‘é‡ç´¢å¼•
CREATE INDEX idx_user_vectors ON user_vectors USING hnsw (preference_vector vector_l2_ops);
CREATE INDEX idx_product_vectors ON product_vectors USING hnsw (embedding vector_l2_ops);

-- å‘é‡ç›¸ä¼¼åº¦æœç´¢
SELECT 
    p.product_id,
    p.name,
    p.price,
    1 - (u.preference_vector <=> p.embedding) as similarity
FROM user_vectors u
CROSS JOIN product_vectors p
WHERE u.user_id = 12345
ORDER BY similarity DESC
LIMIT 20;
```

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 é«˜å¹¶å‘æ¶æ„

```text
åº”ç”¨å±‚ (å¤šå®ä¾‹)
    â†“
è´Ÿè½½å‡è¡¡
    â†“
è¿æ¥æ±  (PgBouncer)
    â†“
PostgreSQLé›†ç¾¤
â”œâ”€â”€ ä¸»åº“ (è¯»å†™)
â”œâ”€â”€ ä»åº“1 (åªè¯» - æœç´¢)
â”œâ”€â”€ ä»åº“2 (åªè¯» - æ¨è)
â””â”€â”€ ä»åº“3 (åªè¯» - æŠ¥è¡¨)
    â†“
ç¼“å­˜å±‚ (Redis)
```

### 3.2 ç¼“å­˜ç­–ç•¥

```text
ç¼“å­˜å±‚æ¬¡:
1. åº”ç”¨å±‚ç¼“å­˜ (Redis) - çƒ­ç‚¹å•†å“
2. è¿æ¥æ± ç¼“å­˜ - è¿æ¥å¤ç”¨
3. PostgreSQLå…±äº«ç¼“å†²åŒº - æ•°æ®ç¼“å­˜
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 å•†å“è¡¨è®¾è®¡

```sql
-- å•†å“è¡¨
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category_id INT,
    price NUMERIC(10,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    sales_count INT DEFAULT 0,
    rating NUMERIC(3,2),
    search_vector tsvector,
    embedding vector(128),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_search ON products USING GIN(search_vector);
CREATE INDEX idx_products_embedding ON products USING hnsw (embedding vector_l2_ops);
```

### 4.2 è®¢å•è¡¨è®¾è®¡

```sql
-- è®¢å•è¡¨ï¼ˆåˆ†åŒºï¼‰
CREATE TABLE orders (
    order_id BIGSERIAL,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (order_id, created_at)
) PARTITION BY RANGE (created_at);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE orders_2025_01 PARTITION OF orders
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç§’æ€ä¼˜åŒ–

```sql
-- ä½¿ç”¨PostgreSQL 18å†…ç½®è¿æ¥æ± 
ALTER SYSTEM SET enable_builtin_connection_pooling = on;
ALTER SYSTEM SET connection_pool_size = 200;

-- ä½¿ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_direct = 'data,wal';
```

### 5.2 æœç´¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å…¨æ–‡æœç´¢
CREATE INDEX idx_products_search ON products USING GIN(search_vector);

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„èšåˆ
CREATE MATERIALIZED VIEW mv_product_stats AS
SELECT 
    product_id,
    COUNT(*) as order_count,
    SUM(amount) as total_amount
FROM orders
GROUP BY product_id;

CREATE UNIQUE INDEX ON mv_product_stats(product_id);
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 ç§’æ€ç³»ç»Ÿ

- âœ… **ä½¿ç”¨SERIALIZABLEéš”ç¦»çº§åˆ«**: ä¿è¯é›¶è¶…å–
- âœ… **è¿æ¥æ± **: å‡å°‘è¿æ¥å¼€é”€
- âœ… **ç¼“å­˜é¢„çƒ­**: é¢„çƒ­çƒ­ç‚¹å•†å“
- âœ… **é™æµ**: é˜²æ­¢ç³»ç»Ÿè¿‡è½½

### 6.2 æœç´¢ç³»ç»Ÿ

- âœ… **å…¨æ–‡æœç´¢ç´¢å¼•**: GINç´¢å¼•
- âœ… **å‘é‡æœç´¢**: HNSWç´¢å¼•
- âœ… **æ··åˆæœç´¢**: å…¨æ–‡+å‘é‡
- âœ… **æœç´¢å»ºè®®**: è‡ªåŠ¨è¡¥å…¨

### 6.3 æ¨èç³»ç»Ÿ

- âœ… **å‘é‡æœç´¢**: ç›¸ä¼¼åº¦è®¡ç®—
- âœ… **å®æ—¶æ›´æ–°**: å®æ—¶æ›´æ–°ç”¨æˆ·å‘é‡
- âœ… **æ··åˆæ¨è**: ååŒè¿‡æ»¤+å†…å®¹æ¨è
- âœ… **A/Bæµ‹è¯•**: ä¼˜åŒ–æ¨èæ•ˆæœ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01-ç”µå•†ç§’æ€ç³»ç»Ÿ](./01-ç”µå•†ç§’æ€ç³»ç»Ÿ/README.md) - ç§’æ€ç³»ç»Ÿæ¡ˆä¾‹
- [02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.07-å…¨æ–‡æœç´¢](../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.07-å…¨æ–‡æœç´¢/README.md) - å…¨æ–‡æœç´¢
- [10-AIä¸æœºå™¨å­¦ä¹ ](../10-AIä¸æœºå™¨å­¦ä¹ /README.md) - AIä¸æœºå™¨å­¦ä¹ 

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ

