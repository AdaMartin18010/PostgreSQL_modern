---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\å»ºç­‘åœºæ™¯\æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+, PostGIS 3.0+
> **æ–‡æ¡£ç¼–å·**: 08-25-01

## ğŸ“‘ ç›®å½•

- [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
- [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
- [2.1 æ™ºæ…§å·¥åœ°ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºæ…§å·¥åœ°ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
- [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
- [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
- [3.1 äººå‘˜ä½ç½®æ—¶åºè¡¨](#31-äººå‘˜ä½ç½®æ—¶åºè¡¨)
- [3.2 è®¾å¤‡æ•°æ®æ—¶åºè¡¨](#32-è®¾å¤‡æ•°æ®æ—¶åºè¡¨)
- [4.1 äººå‘˜ç®¡ç†](#41-äººå‘˜ç®¡ç†)
- [4.2 è®¾å¤‡ç®¡ç†](#42-è®¾å¤‡ç®¡ç†)
- [5.1 æ¡ˆä¾‹: æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
- [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
- [6.1 äººå‘˜ç®¡ç†](#61-äººå‘˜ç®¡ç†)
- [6.2 è®¾å¤‡ç®¡ç†](#62-è®¾å¤‡ç®¡ç†)
- [8.1 å·¥åœ°æ•°æ®æ—¶åºè¡¨åˆ›å»º](#81-å·¥åœ°æ•°æ®æ—¶åºè¡¨åˆ›å»º)
- [8.2 äººå‘˜ä½ç½®ç®¡ç†å®ç°](#82-äººå‘˜ä½ç½®ç®¡ç†å®ç°)
- [8.3 è®¾å¤‡ç®¡ç†å®ç°](#83-è®¾å¤‡ç®¡ç†å®ç°)
- [8.4 å®‰å…¨ç®¡ç†å®ç°](#84-å®‰å…¨ç®¡ç†å®ç°)
---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿéœ€è¦ï¼š

- **äººå‘˜ç®¡ç†**: ç®¡ç†å·¥åœ°äººå‘˜
- **è®¾å¤‡ç›‘æ§**: ç›‘æ§æ–½å·¥è®¾å¤‡
- **å®‰å…¨ç›‘æ§**: å®‰å…¨ç›‘æ§å’Œé¢„è­¦
- **è¿›åº¦ç®¡ç†**: ç®¡ç†æ–½å·¥è¿›åº¦

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **ç©ºé—´æ•°æ®åº“**: PostGIS å¤„ç†åœ°ç†ä½ç½®æ•°æ®
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å®‰å…¨ç®¡ç†** | å®æ—¶ç›‘æ§æå‡å®‰å…¨ | **+55%** |
| **æ•ˆç‡æå‡** | æ•°æ®é©±åŠ¨æå‡æ•ˆç‡ | **+40%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **12x** |
| **æˆæœ¬èŠ‚çº¦** | ä¼˜åŒ–ç®¡ç†èŠ‚çº¦æˆæœ¬ | **-25%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **å®‰å…¨ç®¡ç†**: å®æ—¶ç›‘æ§æå‡å®‰å…¨ç®¡ç†æ°´å¹³ 55%
- **æ•ˆç‡æå‡**: æ•°æ®é©±åŠ¨æå‡æ–½å·¥æ•ˆç‡ 40%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 12 å€
- **æˆæœ¬èŠ‚çº¦**: ä¼˜åŒ–ç®¡ç†èŠ‚çº¦æˆæœ¬ 25%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºæ…§å·¥åœ°ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºæ…§å·¥åœ°ç®¡ç†))
    æ•°æ®å±‚
      äººå‘˜æ•°æ®
        äººå‘˜ä¿¡æ¯
        ä½ç½®æ•°æ®
        è€ƒå‹¤æ•°æ®
        å®‰å…¨æ•°æ®
      è®¾å¤‡æ•°æ®
        è®¾å¤‡ä¿¡æ¯
        è¿è¡Œæ•°æ®
        ç»´æŠ¤æ•°æ®
        æ•…éšœæ•°æ®
      ç¯å¢ƒæ•°æ®
        ç¯å¢ƒç›‘æµ‹
        æ°”è±¡æ•°æ®
        å™ªéŸ³æ•°æ®
        ç©ºæ°”è´¨é‡
    å­˜å‚¨å±‚
      æ—¶åºæ•°æ®åº“
        TimescaleDB
        äººå‘˜æ—¶åº
        è®¾å¤‡æ—¶åº
        ç¯å¢ƒæ—¶åº
        æ•°æ®å‹ç¼©
      ç©ºé—´æ•°æ®åº“
        PostGIS
        å·¥åœ°åœ°å›¾
        åŒºåŸŸåˆ’åˆ†
        ä½ç½®ä¿¡æ¯
        è·¯å¾„åˆ†æ
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        è¶‹åŠ¿åˆ†æ
        å¼‚å¸¸æ£€æµ‹
        æ¨¡å¼è¯†åˆ«
      å®‰å…¨ç®¡ç†
        å®‰å…¨ç›‘æ§
        é£é™©åˆ†æ
        é¢„è­¦ç³»ç»Ÿ
        åº”æ€¥å¤„ç†
    åº”ç”¨å±‚
      äººå‘˜ç®¡ç†
        äººå‘˜å®šä½
        è€ƒå‹¤ç®¡ç†
        å®‰å…¨ç›‘æ§
        äººå‘˜ç»Ÿè®¡
      è®¾å¤‡ç®¡ç†
        è®¾å¤‡ç›‘æ§
        ç»´æŠ¤ç®¡ç†
        æ•…éšœé¢„è­¦
        ä½¿ç”¨ç»Ÿè®¡
      å®‰å…¨ç®¡ç†
        å®‰å…¨ç›‘æ§
        é£é™©é¢„è­¦
        äº‹æ•…å¤„ç†
        å®‰å…¨æŠ¥å‘Š
      è¿›åº¦ç®¡ç†
        è¿›åº¦è·Ÿè¸ª
        ä»»åŠ¡ç®¡ç†
        èµ„æºç®¡ç†
        è¿›åº¦åˆ†æ
    åº”ç”¨åœºæ™¯
      å»ºç­‘æ–½å·¥
        äººå‘˜ç®¡ç†
        è®¾å¤‡ç®¡ç†
        å®‰å…¨ç®¡ç†
      åŸºç¡€è®¾æ–½
        å·¥ç¨‹ç®¡ç†
        è´¨é‡ç›‘æ§
        è¿›åº¦ç®¡ç†
      æ™ºæ…§åŸå¸‚
        å·¥åœ°ç›‘æ§
        å®‰å…¨ç®¡ç†
        æ•°æ®ç®¡ç†
```

### 2.2 æ¶æ„è®¾è®¡

```text
å·¥åœ°æ•°æ®é‡‡é›†
  â”œâ”€â”€ äººå‘˜å®šä½
  â”œâ”€â”€ è®¾å¤‡ç›‘æ§
  â””â”€â”€ ç¯å¢ƒç›‘æµ‹
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ äººå‘˜æ•°æ®
  â”œâ”€â”€ è®¾å¤‡æ•°æ®
  â””â”€â”€ ç¯å¢ƒæ•°æ®
  â†“
ç©ºé—´æ•°æ®å­˜å‚¨ï¼ˆPostGISï¼‰
  â”œâ”€â”€ å·¥åœ°åœ°å›¾
  â””â”€â”€ åŒºåŸŸä¿¡æ¯
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ äººå‘˜ç®¡ç†
  â”œâ”€â”€ è®¾å¤‡ç®¡ç†
  â”œâ”€â”€ å®‰å…¨ç®¡ç†
  â””â”€â”€ è¿›åº¦ç®¡ç†
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + PostGIS
- **æ•°æ®é‡‡é›†**: ä¼ æ„Ÿå™¨ã€å®šä½è®¾å¤‡ã€ç›‘æ§è®¾å¤‡
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 äººå‘˜ä½ç½®æ—¶åºè¡¨

```sql
-- åˆ›å»ºäººå‘˜ä½ç½®æ—¶åºè¡¨
CREATE TABLE personnel_location (
    time TIMESTAMPTZ NOT NULL,
    personnel_id TEXT NOT NULL,
    name TEXT,
    role TEXT,
    location GEOGRAPHY(POINT, 4326),
    zone_id TEXT,
    status TEXT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('personnel_location', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX pl_personnel_time_idx ON personnel_location (personnel_id, time DESC);
CREATE INDEX pl_location_idx ON personnel_location USING GIST (location);
```

### 3.2 è®¾å¤‡æ•°æ®æ—¶åºè¡¨

```sql
CREATE TABLE equipment_data (
    time TIMESTAMPTZ NOT NULL,
    equipment_id TEXT NOT NULL,
    equipment_type TEXT,
    location GEOGRAPHY(POINT, 4326),
    status TEXT,
    usage_hours DECIMAL(10, 2),
    fuel_level DECIMAL(10, 2),
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('equipment_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ed_equipment_time_idx ON equipment_data (equipment_id, time DESC);
CREATE INDEX ed_location_idx ON equipment_data USING GIST (location);
```

## 4. å·¥åœ°ç®¡ç†

### 4.1 äººå‘˜ç®¡ç†

```sql
-- å®æ—¶äººå‘˜ä½ç½®æŸ¥è¯¢
SELECT
    personnel_id,
    name,
    role,
    time_bucket('5 minutes', time) AS bucket,
    ST_AsText(location) AS location,
    zone_id,
    status
FROM personnel_location
WHERE time > NOW() - INTERVAL '1 hour'
ORDER BY time DESC;
```

### 4.2 è®¾å¤‡ç®¡ç†

```python
# è®¾å¤‡ç®¡ç†
class EquipmentManagement:
    async def monitor_equipment(self, equipment_id):
        """ç›‘æ§è®¾å¤‡"""
        # 1. è·å–è®¾å¤‡æœ€æ–°çŠ¶æ€
        status = await self.db.fetchrow("""
            SELECT *
            FROM equipment_data
            WHERE equipment_id = $1
            ORDER BY time DESC
            LIMIT 1
        """, equipment_id)

        # 2. è®¡ç®—ä½¿ç”¨æ—¶é—´
        usage_stats = await self.db.fetchrow("""
            SELECT
                SUM(usage_hours) AS total_hours,
                AVG(fuel_level) AS avg_fuel_level
            FROM equipment_data
            WHERE equipment_id = $1
                AND time > NOW() - INTERVAL '24 hours'
        """, equipment_id)

        return {
            'status': status,
            'usage_stats': usage_stats
        }
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸå»ºç­‘å…¬å¸éœ€è¦æ„å»ºæ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿï¼Œç®¡ç†äººå‘˜ã€è®¾å¤‡ï¼Œç¡®ä¿å®‰å…¨æ–½å·¥ã€‚

**é—®é¢˜åˆ†æ**:

1. **ç®¡ç†å›°éš¾**: å·¥åœ°ç®¡ç†å›°éš¾
2. **å®‰å…¨é£é™©**: å®‰å…¨é£é™©é«˜
3. **æ•ˆç‡ä½**: æ–½å·¥æ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿ
class SmartConstructionSiteManagementSystem:
    def __init__(self):
        self.equipment_mgmt = EquipmentManagement()
        self.safety_monitoring = SafetyMonitoring()

    async def manage_site(self, site_id):
        """ç®¡ç†å·¥åœ°"""
        # 1. ç›‘æ§äººå‘˜
        personnel_status = await self.get_personnel_status(site_id)

        # 2. ç›‘æ§è®¾å¤‡
        equipment_status = []
        equipment_list = await self.get_equipment_list(site_id)
        for equipment in equipment_list:
            status = await self.equipment_mgmt.monitor_equipment(
                equipment['id']
            )
            equipment_status.append(status)

        # 3. å®‰å…¨æ£€æŸ¥
        safety_alerts = await self.safety_monitoring.check_safety(
            site_id, personnel_status, equipment_status
        )

        return {
            'personnel': personnel_status,
            'equipment': equipment_status,
            'alerts': safety_alerts
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å®‰å…¨ç®¡ç†** | åŸºå‡† | **+55%** | **æå‡** |
| **æ–½å·¥æ•ˆç‡** | åŸºå‡† | **+40%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 3 ç§’ | **< 150ms** | **95%** â¬‡ï¸ |
| **æˆæœ¬èŠ‚çº¦** | åŸºå‡† | **-25%** | **é™ä½** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**å·¥åœ°ç®¡ç†æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å®‰å…¨ç®¡ç† | æ•ˆç‡ | æˆæœ¬ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|----------|------|------|----------|----------|
| **äººå·¥ç®¡ç†** | åŸºå‡† | åŸºå‡† | é«˜ | ä½ | å°è§„æ¨¡ |
| **æ•°å­—åŒ–ç®¡ç†** | +30% | +25% | ä¸­ | ä¸­ | ä¸­ç­‰è§„æ¨¡ |
| **æ™ºæ…§ç®¡ç†** | **+55%** | **+40%** | **ä½** | **é«˜** | **å¤§è§„æ¨¡** |

**æ•°æ®æ¨¡å‹å¯¹æ¯”**:

| æ•°æ®æ¨¡å‹ | æ—¶åºåˆ†æ | ç©ºé—´åˆ†æ | æŸ¥è¯¢æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|----------|----------|----------|----------|
| **å…³ç³»æ¨¡å‹** | ä½ | ä½ | ä¸­ | ç®€å•åœºæ™¯ |
| **æ—¶åºæ¨¡å‹** | é«˜ | ä½ | é«˜ | æ—¶åºåˆ†æ |
| **ç©ºé—´æ¨¡å‹** | ä½ | é«˜ | ä¸­ | ä½ç½®ç®¡ç† |
| **æ··åˆæ¨¡å‹** | **é«˜** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 äººå‘˜ç®¡ç†

1. **å®æ—¶å®šä½**: å®æ—¶å®šä½äººå‘˜ä½ç½®
2. **åŒºåŸŸç®¡ç†**: å®šä¹‰å®‰å…¨åŒºåŸŸå’Œé™åˆ¶åŒºåŸŸ
3. **è€ƒå‹¤ç®¡ç†**: è‡ªåŠ¨è€ƒå‹¤ç®¡ç†

### 6.2 è®¾å¤‡ç®¡ç†

1. **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§è®¾å¤‡çŠ¶æ€
2. **é¢„é˜²ç»´æŠ¤**: é¢„é˜²æ€§ç»´æŠ¤
3. **ä½¿ç”¨ç»Ÿè®¡**: ç»Ÿè®¡è®¾å¤‡ä½¿ç”¨æƒ…å†µ

## 7. å‚è€ƒèµ„æ–™

- [æ™ºèƒ½æ¥¼å®‡ç®¡ç†ç³»ç»Ÿ](../æˆ¿åœ°äº§åœºæ™¯/æ™ºèƒ½æ¥¼å®‡ç®¡ç†ç³»ç»Ÿ.md)
- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 å·¥åœ°æ•°æ®æ—¶åºè¡¨åˆ›å»º

**åˆ›å»ºæ™ºæ…§å·¥åœ°ç®¡ç†ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBå’ŒPostGISæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS postgis;

-- åˆ›å»ºäººå‘˜ä½ç½®æ—¶åºè¡¨
CREATE TABLE personnel_location (
    time TIMESTAMPTZ NOT NULL,
    personnel_id TEXT NOT NULL,
    name TEXT,
    role TEXT,  -- 'worker', 'supervisor', 'visitor'
    location GEOGRAPHY(POINT, 4326),  -- äººå‘˜ä½ç½®
    zone_id TEXT,  -- æ‰€åœ¨åŒºåŸŸID
    status TEXT,  -- 'working', 'resting', 'offline'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºè®¾å¤‡æ•°æ®æ—¶åºè¡¨
CREATE TABLE equipment_data (
    time TIMESTAMPTZ NOT NULL,
    equipment_id TEXT NOT NULL,
    equipment_type TEXT,  -- 'crane', 'excavator', 'truck', etc.
    location GEOGRAPHY(POINT, 4326),  -- è®¾å¤‡ä½ç½®
    status TEXT,  -- 'running', 'idle', 'maintenance', 'offline'
    usage_hours DECIMAL(10, 2),
    fuel_level DECIMAL(5, 2),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå®‰å…¨åŒºåŸŸè¡¨
CREATE TABLE safety_zones (
    id SERIAL PRIMARY KEY,
    zone_name TEXT NOT NULL,
    zone_type TEXT,  -- 'safe', 'restricted', 'dangerous'
    boundary GEOGRAPHY(POLYGON, 4326),  -- åŒºåŸŸè¾¹ç•Œ
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå®‰å…¨äº‹ä»¶è¡¨
CREATE TABLE safety_events (
    id SERIAL PRIMARY KEY,
    event_type TEXT NOT NULL,  -- 'unauthorized_access', 'equipment_fault', 'safety_violation'
    personnel_id TEXT,
    equipment_id TEXT,
    zone_id TEXT,
    location GEOGRAPHY(POINT, 4326),
    severity TEXT,  -- 'low', 'medium', 'high', 'critical'
    event_time TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'active',
    description TEXT,
    metadata JSONB DEFAULT '{}'::JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆç”¨äºæ—¶åºæ•°æ®ï¼‰
SELECT create_hypertable('personnel_location', 'time');
SELECT create_hypertable('equipment_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_personnel_location_personnel_time ON personnel_location (personnel_id, time DESC);
CREATE INDEX idx_personnel_location_location ON personnel_location USING GIST (location);
CREATE INDEX idx_equipment_data_equipment_time ON equipment_data (equipment_id, time DESC);
CREATE INDEX idx_equipment_data_location ON equipment_data USING GIST (location);
CREATE INDEX idx_safety_zones_boundary ON safety_zones USING GIST (boundary);
CREATE INDEX idx_safety_events_time ON safety_events (event_time DESC);
```

### 8.2 äººå‘˜ä½ç½®ç®¡ç†å®ç°

**Pythonäººå‘˜ä½ç½®ç®¡ç†**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import Optional
from shapely.geometry import Point

class PersonnelLocationManager:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–äººå‘˜ä½ç½®ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def update_personnel_location(self, personnel_id: str, name: str, role: str,
                                  location: Point, zone_id: Optional[str] = None,
                                  status: str = 'working'):
        """æ›´æ–°äººå‘˜ä½ç½®"""
        lon, lat = location.x, location.y

        self.cur.execute("""
            INSERT INTO personnel_location
            (time, personnel_id, name, role, location, zone_id, status)
            VALUES (%s, %s, %s, %s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s, %s)
        """, (
            datetime.now(), personnel_id, name, role, lon, lat, zone_id, status
        ))

        self.conn.commit()

    def get_personnel_current_location(self, personnel_id: str) -> Optional[Dict]:
        """è·å–äººå‘˜å½“å‰ä½ç½®"""
        self.cur.execute("""
            SELECT
                time, personnel_id, name, role,
                ST_X(location::geometry) AS lon,
                ST_Y(location::geometry) AS lat,
                zone_id, status
            FROM personnel_location
            WHERE personnel_id = %s
            ORDER BY time DESC
            LIMIT 1
        """, (personnel_id,))

        result = self.cur.fetchone()
        if result:
            return {
                'time': result[0],
                'personnel_id': result[1],
                'name': result[2],
                'role': result[3],
                'location': Point(result[4], result[5]),
                'zone_id': result[6],
                'status': result[7]
            }
        return None

    def get_personnel_in_zone(self, zone_id: str) -> List[Dict]:
        """è·å–åŒºåŸŸå†…çš„äººå‘˜"""
        self.cur.execute("""
            SELECT DISTINCT ON (pl.personnel_id)
                pl.personnel_id,
                pl.name,
                pl.role,
                ST_X(pl.location::geometry) AS lon,
                ST_Y(pl.location::geometry) AS lat,
                pl.status
            FROM personnel_location pl
            WHERE pl.zone_id = %s
              AND pl.time > NOW() - INTERVAL '5 minutes'
            ORDER BY pl.personnel_id, pl.time DESC
        """, (zone_id,))

        personnel = []
        for row in self.cur.fetchall():
            personnel.append({
                'personnel_id': row[0],
                'name': row[1],
                'role': row[2],
                'location': Point(row[3], row[4]),
                'status': row[5]
            })

        return personnel

# ä½¿ç”¨ç¤ºä¾‹
from shapely.geometry import Point

location_manager = PersonnelLocationManager("host=localhost dbname=testdb user=postgres password=secret")

# æ›´æ–°äººå‘˜ä½ç½®
personnel_location = Point(116.3974, 39.9093)
location_manager.update_personnel_location(
    personnel_id='worker_001',
    name='å¼ ä¸‰',
    role='worker',
    location=personnel_location,
    zone_id='zone_A',
    status='working'
)

# è·å–äººå‘˜å½“å‰ä½ç½®
current_location = location_manager.get_personnel_current_location('worker_001')
if current_location:
    print(f"{current_location['name']} is at ({current_location['location'].x}, {current_location['location'].y})")
```

### 8.3 è®¾å¤‡ç®¡ç†å®ç°

**Pythonè®¾å¤‡ç®¡ç†**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import Optional
from shapely.geometry import Point

class EquipmentManager:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–è®¾å¤‡ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def update_equipment_status(self, equipment_id: str, equipment_type: str,
                               location: Point, status: str,
                               usage_hours: Optional[float] = None,
                               fuel_level: Optional[float] = None):
        """æ›´æ–°è®¾å¤‡çŠ¶æ€"""
        lon, lat = location.x, location.y

        self.cur.execute("""
            INSERT INTO equipment_data
            (time, equipment_id, equipment_type, location, status, usage_hours, fuel_level)
            VALUES (%s, %s, %s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s, %s, %s)
        """, (
            datetime.now(), equipment_id, equipment_type, lon, lat,
            status, usage_hours, fuel_level
        ))

        self.conn.commit()

    def get_equipment_status(self, equipment_id: str) -> Optional[Dict]:
        """è·å–è®¾å¤‡çŠ¶æ€"""
        self.cur.execute("""
            SELECT
                time, equipment_id, equipment_type,
                ST_X(location::geometry) AS lon,
                ST_Y(location::geometry) AS lat,
                status, usage_hours, fuel_level
            FROM equipment_data
            WHERE equipment_id = %s
            ORDER BY time DESC
            LIMIT 1
        """, (equipment_id,))

        result = self.cur.fetchone()
        if result:
            return {
                'time': result[0],
                'equipment_id': result[1],
                'equipment_type': result[2],
                'location': Point(result[3], result[4]),
                'status': result[5],
                'usage_hours': float(result[6]) if result[6] else None,
                'fuel_level': float(result[7]) if result[7] else None
            }
        return None

    def get_equipment_usage_statistics(self, equipment_id: str, days: int = 7) -> Dict:
        """è·å–è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡"""
        self.cur.execute("""
            SELECT
                COUNT(*) AS total_records,
                SUM(CASE WHEN status = 'running' THEN 1 ELSE 0 END) AS running_count,
                AVG(usage_hours) AS avg_usage_hours,
                AVG(fuel_level) AS avg_fuel_level
            FROM equipment_data
            WHERE equipment_id = %s
              AND time > NOW() - INTERVAL '%s days'
        """, (equipment_id, days))

        result = self.cur.fetchone()
        if result:
            return {
                'total_records': result[0],
                'running_count': result[1],
                'avg_usage_hours': float(result[2]) if result[2] else None,
                'avg_fuel_level': float(result[3]) if result[3] else None
            }
        return {}

# ä½¿ç”¨ç¤ºä¾‹
from shapely.geometry import Point

equipment_manager = EquipmentManager("host=localhost dbname=testdb user=postgres password=secret")

# æ›´æ–°è®¾å¤‡çŠ¶æ€
equipment_location = Point(116.3974, 39.9093)
equipment_manager.update_equipment_status(
    equipment_id='crane_001',
    equipment_type='crane',
    location=equipment_location,
    status='running',
    usage_hours=120.5,
    fuel_level=75.0
)

# è·å–è®¾å¤‡çŠ¶æ€
status = equipment_manager.get_equipment_status('crane_001')
if status:
    print(f"Equipment {status['equipment_id']}: {status['status']}, "
          f"usage={status['usage_hours']} hours, fuel={status['fuel_level']}%")
```

### 8.4 å®‰å…¨ç®¡ç†å®ç°

**Pythonå®‰å…¨ç®¡ç†**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import List, Dict
from shapely.geometry import Point

class SafetyManager:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å®‰å…¨ç®¡ç†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()
        self.location_manager = PersonnelLocationManager(conn_str)
        self.equipment_manager = EquipmentManager(conn_str)

    def check_zone_access(self, personnel_id: str, zone_id: str) -> bool:
        """æ£€æŸ¥åŒºåŸŸè®¿é—®æƒé™"""
        # è·å–äººå‘˜ä¿¡æ¯
        location = self.location_manager.get_personnel_current_location(personnel_id)
        if not location:
            return False

        # è·å–åŒºåŸŸä¿¡æ¯
        self.cur.execute("""
            SELECT zone_type, boundary
            FROM safety_zones
            WHERE id = %s
        """, (zone_id,))

        zone = self.cur.fetchone()
        if not zone:
            return False

        zone_type, boundary = zone[0], zone[1]

        # æ£€æŸ¥äººå‘˜è§’è‰²å’ŒåŒºåŸŸç±»å‹
        if zone_type == 'restricted' and location['role'] not in ['supervisor', 'admin']:
            # è®°å½•æœªæˆæƒè®¿é—®
            self.record_safety_event(
                event_type='unauthorized_access',
                personnel_id=personnel_id,
                zone_id=zone_id,
                location=location['location'],
                severity='high',
                description=f"Personnel {personnel_id} attempted to access restricted zone {zone_id}"
            )
            return False

        return True

    def record_safety_event(self, event_type: str, personnel_id: Optional[str] = None,
                           equipment_id: Optional[str] = None, zone_id: Optional[str] = None,
                           location: Optional[Point] = None, severity: str = 'medium',
                           description: str = ''):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        lon, lat = location.x, location.y if location else (None, None)

        self.cur.execute("""
            INSERT INTO safety_events
            (event_type, personnel_id, equipment_id, zone_id, location, severity, event_time, description)
            VALUES (%s, %s, %s, %s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s, %s, %s)
        """, (
            event_type, personnel_id, equipment_id, zone_id,
            lon, lat, severity, datetime.now(), description
        ))

        self.conn.commit()

    def get_safety_events(self, hours: int = 24, severity: Optional[str] = None) -> List[Dict]:
        """è·å–å®‰å…¨äº‹ä»¶"""
        if severity:
            self.cur.execute("""
                SELECT
                    id, event_type, personnel_id, equipment_id, zone_id,
                    ST_X(location::geometry) AS lon,
                    ST_Y(location::geometry) AS lat,
                    severity, event_time, description, status
                FROM safety_events
                WHERE event_time > NOW() - INTERVAL '%s hours'
                  AND severity = %s
                ORDER BY event_time DESC
            """, (hours, severity))
        else:
            self.cur.execute("""
                SELECT
                    id, event_type, personnel_id, equipment_id, zone_id,
                    ST_X(location::geometry) AS lon,
                    ST_Y(location::geometry) AS lat,
                    severity, event_time, description, status
                FROM safety_events
                WHERE event_time > NOW() - INTERVAL '%s hours'
                ORDER BY
                    CASE severity
                        WHEN 'critical' THEN 1
                        WHEN 'high' THEN 2
                        WHEN 'medium' THEN 3
                        ELSE 4
                    END,
                    event_time DESC
            """, (hours,))

        events = []
        for row in self.cur.fetchall():
            events.append({
                'id': row[0],
                'event_type': row[1],
                'personnel_id': row[2],
                'equipment_id': row[3],
                'zone_id': row[4],
                'location': Point(row[5], row[6]) if row[5] and row[6] else None,
                'severity': row[7],
                'event_time': row[8],
                'description': row[9],
                'status': row[10]
            })

        return events

# ä½¿ç”¨ç¤ºä¾‹
from shapely.geometry import Point

safety_manager = SafetyManager("host=localhost dbname=testdb user=postgres password=secret")

# æ£€æŸ¥åŒºåŸŸè®¿é—®
has_access = safety_manager.check_zone_access('worker_001', 'restricted_zone_A')
if not has_access:
    print("Access denied: Unauthorized access to restricted zone")

# è·å–å®‰å…¨äº‹ä»¶
safety_events = safety_manager.get_safety_events(hours=24, severity='high')
for event in safety_events:
    print(f"[{event['severity']}] {event['event_type']}: {event['description']}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-25-01
