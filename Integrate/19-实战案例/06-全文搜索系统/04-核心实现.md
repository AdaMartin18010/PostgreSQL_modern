---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\06-å…¨æ–‡æœç´¢ç³»ç»Ÿ\04-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹6ï¼šå…¨æ–‡æœç´¢ç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **æŠ€æœ¯æ ˆ**: PostgreSQL 18 + Python + FastAPI
- **æ€§èƒ½**: msçº§æœç´¢å“åº”

---

## 1. æœç´¢å¼•æ“æ¨¡å—

```python
"""
å…¨æ–‡æœç´¢å¼•æ“
"""

import psycopg2
from psycopg2.extras import RealDictCursor
from fastapi import FastAPI, Query
import time

app = FastAPI()

DB_CONFIG = {
    'dbname': 'search_db',
    'user': 'postgres',
    'host': 'localhost'
}

def get_connection():
    return psycopg2.connect(**DB_CONFIG, cursor_factory=RealDictCursor)

@app.get("/api/search")
async def search(
    q: str = Query(..., description="æœç´¢å…³é”®è¯"),
    category: str = Query(None, description="åˆ†ç±»è¿‡æ»¤"),
    limit: int = Query(20, le=100),
    offset: int = Query(0, ge=0)
):
    """
    å…¨æ–‡æœç´¢API

    æ”¯æŒ:
    - ä¸­æ–‡åˆ†è¯
    - ç›¸å…³æ€§æ’åº
    - é«˜äº®æ˜¾ç¤º
    - åˆ†ç±»è¿‡æ»¤
    """

    start_time = time.time()

    conn = get_connection()
    cursor = conn.cursor()

    try:
        # æ„å»ºæŸ¥è¯¢
        if category:
            query = """
                SELECT
                    doc_id,
                    title,
                    ts_headline('zh_parser', content, query,
                        'MaxWords=50, MinWords=30, StartSel=<b>, StopSel=</b>') AS snippet,
                    ts_rank_cd(search_vector, query) AS rank
                FROM documents,
                     to_tsquery('zh_parser', %s) query
                WHERE search_vector @@ query
                  AND category = %s
                ORDER BY rank DESC, created_at DESC
                LIMIT %s OFFSET %s;
            """
            cursor.execute(query, (q, category, limit, offset))
        else:
            query = """
                SELECT
                    doc_id,
                    title,
                    ts_headline('zh_parser', content, query,
                        'MaxWords=50, MinWords=30, StartSel=<b>, StopSel=</b>') AS snippet,
                    ts_rank_cd(search_vector, query) AS rank
                FROM documents,
                     to_tsquery('zh_parser', %s) query
                WHERE search_vector @@ query
                ORDER BY rank DESC, created_at DESC
                LIMIT %s OFFSET %s;
            """
            cursor.execute(query, (q, limit, offset))

        results = cursor.fetchall()
        duration = (time.time() - start_time) * 1000

        # è®°å½•æœç´¢æ—¥å¿—
        cursor.execute("""
            INSERT INTO search_logs (query_text, result_count, duration_ms)
            VALUES (%s, %s, %s);
        """, (q, len(results), duration))
        conn.commit()

        return {
            'success': True,
            'results': results,
            'count': len(results),
            'duration_ms': duration
        }

    finally:
        cursor.close()
        conn.close()

@app.get("/api/search/suggest")
async def search_suggest(q: str = Query(..., min_length=2)):
    """æœç´¢å»ºè®®"""

    conn = get_connection()
    cursor = conn.cursor()

    try:
        # åŸºäºå†å²æœç´¢çš„å»ºè®®
        cursor.execute("""
            SELECT DISTINCT query_text, COUNT(*) as freq
            FROM search_logs
            WHERE query_text LIKE %s
            GROUP BY query_text
            ORDER BY freq DESC
            LIMIT 10;
        """, (f'{q}%',))

        suggestions = cursor.fetchall()

        return {
            'success': True,
            'suggestions': [s['query_text'] for s in suggestions]
        }

    finally:
        cursor.close()
        conn.close()

if __name__ == '__main__':
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8002)
```

---

## 2. ç´¢å¼•ç®¡ç†æ¨¡å—

```python
class SearchIndexManager:
    """æœç´¢ç´¢å¼•ç®¡ç†å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def rebuild_search_index(self):
        """é‡å»ºæœç´¢ç´¢å¼•"""

        # 1. åˆ é™¤æ—§ç´¢å¼•
        self.cursor.execute("DROP INDEX IF EXISTS idx_documents_search;")

        # 2. é‡æ–°åˆ›å»ºï¼ˆPostgreSQL 18å¹¶è¡Œæ„å»ºï¼‰
        self.cursor.execute("""
            CREATE INDEX idx_documents_search
            ON documents
            USING GIN (search_vector);
        """)

        self.conn.commit()
        print("âœ… æœç´¢ç´¢å¼•é‡å»ºå®Œæˆ")

    def get_index_stats(self):
        """è·å–ç´¢å¼•ç»Ÿè®¡"""

        self.cursor.execute("""
            SELECT
                pg_size_pretty(pg_relation_size('idx_documents_search')) AS index_size,
                pg_stat_get_numscans('idx_documents_search'::regclass) AS scan_count
        """)

        return self.cursor.fetchone()
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**æœç´¢å¼•æ“**: PostgreSQLå†…ç½®
**å“åº”æ—¶é—´**: <100ms

**è¿”å›**: [æ¡ˆä¾‹6ä¸»é¡µ](./README.md)
