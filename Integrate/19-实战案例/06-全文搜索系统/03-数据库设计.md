---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\06-å…¨æ–‡æœç´¢ç³»ç»Ÿ\03-æ•°æ®åº“è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹6ï¼šå…¨æ–‡æœç´¢ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **ç´¢å¼•**: GINç´¢å¼•
- **åˆ†è¯**: zhparser (ä¸­æ–‡)

---

## 1. Schemaè®¾è®¡

```sql
-- 1. æ–‡æ¡£è¡¨
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    doc_length INT,  -- æ–‡æ¡£é•¿åº¦ï¼ˆåˆ†è¯åï¼‰
    search_vector tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 2. åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_documents_search
ON documents
USING GIN (search_vector);

-- 3. è‡ªåŠ¨æ›´æ–°search_vectorè§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('zh_parser', COALESCE(NEW.title, '')), 'A') ||
        setweight(to_tsvector('zh_parser', COALESCE(NEW.content, '')), 'B');

    NEW.doc_length := array_length(
        string_to_array(to_tsvector('zh_parser', NEW.content)::text, ' '), 1
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_search_vector
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION update_search_vector();

-- 4. æœç´¢ç»Ÿè®¡è¡¨
CREATE TABLE search_logs (
    log_id BIGSERIAL PRIMARY KEY,
    query_text VARCHAR(500),
    result_count INT,
    duration_ms FLOAT,
    user_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_search_logs_query ON search_logs (query_text);
CREATE INDEX idx_search_logs_created ON search_logs (created_at);
```

---

## 2. æœç´¢æŸ¥è¯¢å‡½æ•°

```sql
-- åŸºç¡€æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_documents(
    p_query TEXT,
    p_limit INT DEFAULT 20,
    p_offset INT DEFAULT 0
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    content_snippet TEXT,
    rank REAL,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query, 'MaxWords=50, MinWords=30') AS content_snippet,
        ts_rank_cd(d.search_vector, query) AS rank,
        d.created_at
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;

-- é«˜çº§æœç´¢ï¼ˆå¸¦è¿‡æ»¤ï¼‰
CREATE OR REPLACE FUNCTION search_documents_advanced(
    p_query TEXT,
    p_category VARCHAR DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_limit INT DEFAULT 20
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    rank REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_rank_cd(d.search_vector, query) AS rank
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
      AND (p_category IS NULL OR d.category = p_category)
      AND (p_tags IS NULL OR d.tags && p_tags)
    ORDER BY rank DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**ç´¢å¼•ç±»å‹**: GIN
**åˆ†è¯å™¨**: zhparser

**è¿”å›**: [æ¡ˆä¾‹6ä¸»é¡µ](./README.md)
