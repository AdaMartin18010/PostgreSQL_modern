---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\06-å…¨æ–‡æœç´¢ç³»ç»Ÿ\03-æ•°æ®åº“è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹6ï¼šå…¨æ–‡æœç´¢ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **ç´¢å¼•**: GINç´¢å¼•
- **åˆ†è¯**: zhparser (ä¸­æ–‡)

---

## 1. Schemaè®¾è®¡

```sql
-- 1. æ–‡æ¡£è¡¨
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    doc_length INT,  -- æ–‡æ¡£é•¿åº¦ï¼ˆåˆ†è¯åï¼‰
    search_vector tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 2. åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_documents_search
ON documents
USING GIN (search_vector);

-- 3. è‡ªåŠ¨æ›´æ–°search_vectorè§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('zh_parser', COALESCE(NEW.title, '')), 'A') ||
        setweight(to_tsvector('zh_parser', COALESCE(NEW.content, '')), 'B');

    NEW.doc_length := array_length(
        string_to_array(to_tsvector('zh_parser', NEW.content)::text, ' '), 1
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_search_vector
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION update_search_vector();

-- 4. æœç´¢ç»Ÿè®¡è¡¨
CREATE TABLE search_logs (
    log_id BIGSERIAL PRIMARY KEY,
    query_text VARCHAR(500),
    result_count INT,
    duration_ms FLOAT,
    user_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_search_logs_query ON search_logs (query_text);
CREATE INDEX idx_search_logs_created ON search_logs (created_at);
```

---

## 2. æœç´¢æŸ¥è¯¢å‡½æ•°

```sql
-- åŸºç¡€æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_documents(
    p_query TEXT,
    p_limit INT DEFAULT 20,
    p_offset INT DEFAULT 0
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    content_snippet TEXT,
    rank REAL,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query, 'MaxWords=50, MinWords=30') AS content_snippet,
        ts_rank_cd(d.search_vector, query) AS rank,
        d.created_at
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;

-- é«˜çº§æœç´¢ï¼ˆå¸¦è¿‡æ»¤ï¼‰
CREATE OR REPLACE FUNCTION search_documents_advanced(
    p_query TEXT,
    p_category VARCHAR DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_limit INT DEFAULT 20
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    rank REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_rank_cd(d.search_vector, query) AS rank
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
      AND (p_category IS NULL OR d.category = p_category)
      AND (p_tags IS NULL OR d.tags && p_tags)
    ORDER BY rank DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

---

## 3. æ€§èƒ½ä¼˜åŒ–

### 3.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. GINç´¢å¼•ä¼˜åŒ–ï¼ˆPostgreSQL 18å¹¶è¡Œæ„å»ºï¼‰
CREATE INDEX CONCURRENTLY idx_documents_search_optimized
ON documents
USING GIN (search_vector)
WITH (fastupdate = off);  -- æ‰¹é‡æ›´æ–°æ—¶å…³é—­fastupdate

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æœ€è¿‘æ–‡æ¡£ï¼‰
CREATE INDEX idx_documents_recent_search
ON documents
USING GIN (search_vector)
WHERE created_at > NOW() - INTERVAL '1 year';

-- 3. è¡¨è¾¾å¼ç´¢å¼•ï¼ˆæ ‡é¢˜æƒé‡æ›´é«˜ï¼‰
CREATE INDEX idx_documents_title_search
ON documents
USING GIN (to_tsvector('zh_parser', title));
```

### 3.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ä¼˜åŒ–æœç´¢å‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
CREATE OR REPLACE FUNCTION search_documents_optimized(
    p_query TEXT,
    p_limit INT DEFAULT 20,
    p_offset INT DEFAULT 0,
    p_min_rank REAL DEFAULT 0.1
)
RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    content_snippet TEXT,
    rank REAL,
    created_at TIMESTAMPTZ
) AS $$
DECLARE
    query_vector tsquery;
BEGIN
    -- è§£ææŸ¥è¯¢
    query_vector := to_tsquery('zh_parser', p_query);

    IF query_vector IS NULL THEN
        RAISE EXCEPTION 'æ— æ•ˆçš„æœç´¢æŸ¥è¯¢: %', p_query;
    END IF;

    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query_vector,
                    'MaxWords=50, MinWords=30, StartSel=<mark>, StopSel=</mark>') AS content_snippet,
        ts_rank_cd(d.search_vector, query_vector, 32) AS rank,
        d.created_at
    FROM documents d
    WHERE d.search_vector @@ query_vector
      AND ts_rank_cd(d.search_vector, query_vector, 32) >= p_min_rank
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit OFFSET p_offset;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM search_documents_optimized('PostgreSQL å…¨æ–‡æœç´¢', 20, 0);
```

### 3.3 æœç´¢ç»Ÿè®¡ä¼˜åŒ–

**æœç´¢ç»Ÿè®¡ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æœç´¢çƒ­è¯ç»Ÿè®¡
CREATE OR REPLACE FUNCTION get_search_hotwords(
    p_days INT DEFAULT 7,
    p_limit INT DEFAULT 20
)
RETURNS TABLE (
    query_text TEXT,
    search_count BIGINT,
    avg_duration_ms NUMERIC,
    avg_result_count NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        query_text,
        COUNT(*)::BIGINT AS search_count,
        ROUND(AVG(duration_ms), 2) AS avg_duration_ms,
        ROUND(AVG(result_count), 2) AS avg_result_count
    FROM search_logs
    WHERE created_at > NOW() - (p_days || ' days')::INTERVAL
    GROUP BY query_text
    ORDER BY search_count DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–æœç´¢çƒ­è¯å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. ä¸­æ–‡åˆ†è¯ä¼˜åŒ–

### 4.1 zhparseré…ç½®

**zhparseré…ç½®ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ£€æŸ¥zhparserå®‰è£…
SELECT * FROM pg_ts_config WHERE cfgname = 'zh_parser';

-- é…ç½®ä¸­æ–‡åˆ†è¯è¯å…¸
-- éœ€è¦åœ¨postgresql.confä¸­é…ç½®ï¼š
-- zhparser.zh_dicts = 'simple,english'

-- æµ‹è¯•åˆ†è¯æ•ˆæœ
SELECT to_tsvector('zh_parser', 'PostgreSQLæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¼€æºæ•°æ®åº“');
```

### 4.2 è‡ªå®šä¹‰è¯å…¸

**è‡ªå®šä¹‰è¯å…¸é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºè‡ªå®šä¹‰è¯å…¸è¡¨
CREATE TABLE IF NOT EXISTS custom_dictionary (
    word TEXT PRIMARY KEY,
    weight REAL DEFAULT 1.0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ·»åŠ ä¸“ä¸šæœ¯è¯­
INSERT INTO custom_dictionary (word, weight)
VALUES
    ('PostgreSQL', 2.0),
    ('å…¨æ–‡æœç´¢', 1.5),
    ('GINç´¢å¼•', 1.5)
ON CONFLICT (word) DO UPDATE
SET weight = EXCLUDED.weight;

-- ä½¿ç”¨è‡ªå®šä¹‰è¯å…¸ï¼ˆéœ€è¦åœ¨åº”ç”¨å±‚å®ç°ï¼‰
```

---

## 5. ç›‘æ§ä¸è¯Šæ–­

### 5.1 æœç´¢æ€§èƒ½ç›‘æ§

**æœç´¢æ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºæœç´¢æ€§èƒ½ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW v_search_performance AS
SELECT
    date_trunc('hour', created_at) AS hour,
    COUNT(*) AS search_count,
    ROUND(AVG(duration_ms), 2) AS avg_duration_ms,
    ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms), 2) AS p95_duration_ms,
    ROUND(AVG(result_count), 2) AS avg_result_count
FROM search_logs
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY date_trunc('hour', created_at)
ORDER BY hour DESC;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM v_search_performance;
```

### 5.2 ç´¢å¼•ä½¿ç”¨æƒ…å†µ

**ç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç´¢å¼•ä½¿ç”¨æƒ…å†µ
CREATE OR REPLACE FUNCTION monitor_index_usage()
RETURNS TABLE (
    index_name TEXT,
    table_name TEXT,
    index_size TEXT,
    index_scans BIGINT,
    tuples_read BIGINT,
    tuples_fetched BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        i.indexrelname::TEXT,
        i.schemaname||'.'||i.tablename::TEXT,
        pg_size_pretty(pg_relation_size(i.indexrelid))::TEXT,
        i.idx_scan::BIGINT,
        i.idx_tup_read::BIGINT,
        i.idx_tup_fetch::BIGINT
    FROM pg_stat_user_indexes i
    WHERE i.schemaname = 'public'
      AND i.tablename = 'documents'
    ORDER BY i.idx_scan DESC;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æ§
SELECT * FROM monitor_index_usage();
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**ç´¢å¼•ç±»å‹**: GIN
**åˆ†è¯å™¨**: zhparser

**è¿”å›**: [æ¡ˆä¾‹6ä¸»é¡µ](./README.md)
