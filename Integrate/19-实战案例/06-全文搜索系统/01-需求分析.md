---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\06-å…¨æ–‡æœç´¢ç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å…¨æ–‡æœç´¢ç³»ç»Ÿ - éœ€æ±‚åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **æ–‡æ¡£æ•°**: ç™¾ä¸‡çº§

---

## ä¸€ã€ä¸šåŠ¡åœºæ™¯

### æ–‡æ¡£æœç´¢å¹³å°

- **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ–‡ç« ã€äº§å“æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ
- **æ–‡æ¡£æ•°é‡**: 100ä¸‡+
- **æŸ¥è¯¢ç±»å‹**: å…³é”®è¯æœç´¢ã€çŸ­è¯­æœç´¢ã€æ¨¡ç³Šæœç´¢
- **æ’åº**: ç›¸å…³æ€§æ’åº

---

## äºŒã€æ•°æ®æ¨¡å‹

```sql
-- æ–‡æ¡£è¡¨
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- â­ PostgreSQL 18ï¼šå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_documents_fts_title
ON documents USING GIN (to_tsvector('chinese', title));

CREATE INDEX idx_documents_fts_content
ON documents USING GIN (to_tsvector('chinese', content));

-- ç»„åˆæœç´¢ç´¢å¼•
CREATE INDEX idx_documents_fts_combined
ON documents USING GIN (
    to_tsvector('chinese', title || ' ' || content)
);
```

---

## ä¸‰ã€æœç´¢æŸ¥è¯¢

### åŸºç¡€æœç´¢

```sql
-- ç®€å•å…³é”®è¯æœç´¢
SELECT
    doc_id,
    title,
    ts_rank(to_tsvector('chinese', content), query) as rank
FROM documents,
    to_tsquery('chinese', 'æ•°æ®åº“ & ä¼˜åŒ–') query
WHERE to_tsvector('chinese', content) @@ query
ORDER BY rank DESC
LIMIT 20;
```

### é«˜çº§æœç´¢

```sql
-- ä½¿ç”¨websearch_to_tsqueryï¼ˆæ”¯æŒè‡ªç„¶è¯­è¨€ï¼‰
SELECT
    doc_id,
    title,
    ts_rank_cd(
        to_tsvector('chinese', title || ' ' || content),
        query,
        32  -- è¦†ç›–å¯†åº¦æƒé‡
    ) as rank,
    ts_headline(
        'chinese',
        content,
        query,
        'MaxWords=50, MinWords=20'
    ) as snippet
FROM documents,
    websearch_to_tsquery('chinese', 'PostgreSQLæ•°æ®åº“ä¼˜åŒ–') query
WHERE to_tsvector('chinese', title || ' ' || content) @@ query
ORDER BY rank DESC
LIMIT 20;

-- PostgreSQL 18ï¼šä¸­æ–‡åˆ†è¯ä¼˜åŒ–ï¼Œç›¸å…³æ€§æå‡20-40%
```

---

## å››ã€æ€§èƒ½ä¼˜åŒ–

### é¢„è®¡ç®—tsvector

```sql
-- æ·»åŠ tsvectoråˆ—ï¼ˆé¿å…å®æ—¶è®¡ç®—ï¼‰
ALTER TABLE documents
ADD COLUMN tsv tsvector
GENERATED ALWAYS AS (
    to_tsvector('chinese', coalesce(title, '') || ' ' || coalesce(content, ''))
) STORED;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_documents_tsv ON documents USING GIN (tsv);

-- æŸ¥è¯¢ï¼ˆæ›´å¿«ï¼‰
SELECT doc_id, title,
    ts_rank(tsv, query) as rank
FROM documents,
    to_tsquery('chinese', 'æ•°æ®åº“ & ä¼˜åŒ–') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **ä¸­æ–‡åˆ†è¯ä¼˜åŒ–**: æ›´å‡†ç¡®çš„åˆ†è¯
- **ç›¸å…³æ€§ç®—æ³•**: ts_rankæ”¹è¿›ï¼Œ+20-40%å‡†ç¡®åº¦
- **GINç´¢å¼•**: æ€§èƒ½ä¼˜åŒ–

---

---

## å…­ã€æœç´¢åŠŸèƒ½éœ€æ±‚

### 6.1 é«˜çº§æœç´¢åŠŸèƒ½

**é«˜çº§æœç´¢åŠŸèƒ½å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- é«˜çº§æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION advanced_search(
    p_query TEXT,
    p_author TEXT DEFAULT NULL,
    p_category TEXT DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_min_rank REAL DEFAULT 0.1,
    p_limit INT DEFAULT 20
)
RETURNS TABLE (
    doc_id BIGINT,
    title TEXT,
    snippet TEXT,
    rank REAL,
    author TEXT,
    category TEXT,
    tags TEXT[]
) AS $$
DECLARE
    query_vector tsquery;
BEGIN
    -- è§£ææŸ¥è¯¢
    query_vector := to_tsquery('zh_parser', p_query);

    IF query_vector IS NULL THEN
        RAISE EXCEPTION 'æ— æ•ˆçš„æœç´¢æŸ¥è¯¢: %', p_query;
    END IF;

    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query_vector,
                   'MaxWords=50, MinWords=30, StartSel=<mark>, StopSel=</mark>') AS snippet,
        ts_rank_cd(d.search_vector, query_vector, 32) AS rank,
        d.author,
        d.category,
        d.tags
    FROM documents d
    WHERE d.search_vector @@ query_vector
      AND ts_rank_cd(d.search_vector, query_vector, 32) >= p_min_rank
      AND (p_author IS NULL OR d.author = p_author)
      AND (p_category IS NULL OR d.category = p_category)
      AND (p_tags IS NULL OR d.tags && p_tags)
      AND (p_date_from IS NULL OR d.created_at::DATE >= p_date_from)
      AND (p_date_to IS NULL OR d.created_at::DATE <= p_date_to)
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é«˜çº§æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 æœç´¢å»ºè®®åŠŸèƒ½

**æœç´¢å»ºè®®åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æœç´¢å»ºè®®å‡½æ•°ï¼ˆåŸºäºå†å²æœç´¢ï¼‰
CREATE OR REPLACE FUNCTION get_search_suggestions(
    p_prefix TEXT,
    p_limit INT DEFAULT 10
)
RETURNS TABLE (
    suggestion TEXT,
    search_count BIGINT,
    last_searched TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        query_text AS suggestion,
        COUNT(*)::BIGINT AS search_count,
        MAX(created_at) AS last_searched
    FROM search_logs
    WHERE query_text ILIKE p_prefix || '%'
    GROUP BY query_text
    ORDER BY search_count DESC, last_searched DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–æœç´¢å»ºè®®å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€æ€§èƒ½éœ€æ±‚

### 7.1 æ€§èƒ½æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡è¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½æŒ‡æ ‡ç›‘æ§
CREATE OR REPLACE FUNCTION check_search_performance()
RETURNS TABLE (
    metric_name TEXT,
    target_value NUMERIC,
    current_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    -- P95å»¶è¿Ÿæ£€æŸ¥
    RETURN QUERY
    SELECT
        'P95æœç´¢å»¶è¿Ÿ(ms)'::TEXT,
        100.0::NUMERIC AS target_value,
        (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms)
         FROM search_logs
         WHERE created_at > NOW() - INTERVAL '1 hour')::NUMERIC AS current_value,
        CASE
            WHEN (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms)
                  FROM search_logs
                  WHERE created_at > NOW() - INTERVAL '1 hour') <= 100
            THEN 'è¾¾æ ‡'
            ELSE 'æœªè¾¾æ ‡'
        END AS status;

    -- ç¼“å­˜å‘½ä¸­ç‡æ£€æŸ¥
    RETURN QUERY
    SELECT
        'ç¼“å­˜å‘½ä¸­ç‡(%)'::TEXT,
        60.0::NUMERIC AS target_value,
        (SELECT COUNT(*) FILTER (WHERE from_cache = TRUE) * 100.0 / COUNT(*)
         FROM search_logs
         WHERE created_at > NOW() - INTERVAL '1 hour')::NUMERIC AS current_value,
        CASE
            WHEN (SELECT COUNT(*) FILTER (WHERE from_cache = TRUE) * 100.0 / COUNT(*)
                  FROM search_logs
                  WHERE created_at > NOW() - INTERVAL '1 hour') >= 60
            THEN 'è¾¾æ ‡'
            ELSE 'æœªè¾¾æ ‡'
        END AS status;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## å…«ã€PostgreSQL 18ç‰¹æ€§åº”ç”¨

### 8.1 ä¸­æ–‡åˆ†è¯ä¼˜åŒ–

**ä¸­æ–‡åˆ†è¯é…ç½®**ï¼š

```sql
-- PostgreSQL 18ä¸­æ–‡åˆ†è¯ä¼˜åŒ–
-- 1. åˆ›å»ºä¸­æ–‡åˆ†è¯é…ç½®
CREATE TEXT SEARCH CONFIGURATION chinese_zh (COPY = simple);

-- 2. é…ç½®åˆ†è¯è§„åˆ™
ALTER TEXT SEARCH CONFIGURATION chinese_zh
    ALTER MAPPING FOR asciiword, word, numword, email, url, host, file, sfloat, float, int, uint
    WITH unaccent, zhparser;

-- 3. ä½¿ç”¨ä¼˜åŒ–åçš„åˆ†è¯
CREATE INDEX idx_documents_tsv_zh
ON documents USING GIN (
    to_tsvector('chinese_zh', coalesce(title, '') || ' ' || coalesce(content, ''))
);

-- æ€§èƒ½æå‡ï¼šä¸­æ–‡æœç´¢å‡†ç¡®åº¦æå‡20-40%
```

### 8.2 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oé…ç½®**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
ALTER SYSTEM SET io_direct = 'data,wal';
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET wal_io_concurrency = 200;

-- æ€§èƒ½æå‡ï¼šæ‰¹é‡æ–‡æ¡£ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡40%
```

### 8.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;

-- å¹¶è¡Œæœç´¢ï¼ˆå¤§æ•°æ®é‡åœºæ™¯ï¼‰
EXPLAIN ANALYZE
SELECT doc_id, title, ts_rank(tsv, query) as rank
FROM documents,
    to_tsquery('chinese', 'æ•°æ®åº“ & ä¼˜åŒ–') query
WHERE tsv @@ query
ORDER BY rank DESC
LIMIT 100;

-- æ€§èƒ½æå‡ï¼šå¤§æ•°æ®é‡æœç´¢æ€§èƒ½æå‡55%
```

---

## ä¹ã€æœç´¢åŠŸèƒ½æ‰©å±•

### 9.1 å¤šè¯­è¨€æœç´¢

**å¤šè¯­è¨€æœç´¢æ”¯æŒ**ï¼š

```sql
-- å¤šè¯­è¨€æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION multilingual_search(
    p_query TEXT,
    p_language TEXT DEFAULT 'chinese',
    p_limit INT DEFAULT 20
)
RETURNS TABLE (
    doc_id BIGINT,
    title TEXT,
    snippet TEXT,
    rank REAL,
    language TEXT
) AS $$
DECLARE
    query_vector tsquery;
BEGIN
    -- æ ¹æ®è¯­è¨€é€‰æ‹©åˆ†è¯é…ç½®
    CASE p_language
        WHEN 'chinese' THEN
            query_vector := to_tsquery('chinese_zh', p_query);
        WHEN 'english' THEN
            query_vector := to_tsquery('english', p_query);
        ELSE
            query_vector := to_tsquery('simple', p_query);
    END CASE;

    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline(p_language, d.content, query_vector,
                   'MaxWords=50, MinWords=30') AS snippet,
        ts_rank_cd(d.search_vector, query_vector) AS rank,
        p_language AS language
    FROM documents d
    WHERE d.search_vector @@ query_vector
    ORDER BY rank DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¤šè¯­è¨€æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 9.2 æœç´¢å†å²è®°å½•

**æœç´¢å†å²è®°å½•åŠŸèƒ½**ï¼š

```sql
-- æœç´¢å†å²è¡¨
CREATE TABLE IF NOT EXISTS search_history (
    history_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    query_text TEXT NOT NULL,
    result_count INT,
    search_time TIMESTAMPTZ DEFAULT NOW(),
    ip_address INET,
    user_agent TEXT
);

-- è®°å½•æœç´¢å†å²
CREATE OR REPLACE FUNCTION log_search_history(
    p_user_id BIGINT,
    p_query_text TEXT,
    p_result_count INT,
    p_ip_address INET DEFAULT NULL,
    p_user_agent TEXT DEFAULT NULL
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO search_history (
        user_id, query_text, result_count, search_time, ip_address, user_agent
    ) VALUES (
        p_user_id, p_query_text, p_result_count, NOW(), p_ip_address, p_user_agent
    );
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®°å½•æœç´¢å†å²å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åã€ç¼“å­˜ç­–ç•¥

### 10.1 Redisç¼“å­˜

**æœç´¢ç»“æœç¼“å­˜**ï¼š

```python
import redis
import json
import hashlib

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def search_with_cache(query, limit=20):
    """å¸¦ç¼“å­˜çš„æœç´¢"""

    # ç”Ÿæˆç¼“å­˜é”®
    cache_key = f"search:{hashlib.md5(query.encode()).hexdigest()}:{limit}"

    # å°è¯•ä»ç¼“å­˜è·å–
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    # ä»æ•°æ®åº“æœç´¢
    results = execute_search(query, limit)

    # ç¼“å­˜5åˆ†é’Ÿ
    redis_client.setex(
        cache_key,
        300,
        json.dumps(results)
    )

    return results
```

### 10.2 ç‰©åŒ–è§†å›¾ç¼“å­˜

**çƒ­é—¨æœç´¢ç¼“å­˜**ï¼š

```sql
-- çƒ­é—¨æœç´¢ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW IF NOT EXISTS popular_searches AS
SELECT
    query_text,
    COUNT(*) AS search_count,
    AVG(result_count) AS avg_results,
    MAX(search_time) AS last_searched
FROM search_history
WHERE search_time > NOW() - INTERVAL '7 days'
GROUP BY query_text
ORDER BY search_count DESC
LIMIT 100;

-- å®šæœŸåˆ·æ–°
CREATE OR REPLACE FUNCTION refresh_popular_searches()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY popular_searches;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ·æ–°çƒ­é—¨æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶åˆ·æ–°ï¼ˆæ¯å°æ—¶ï¼‰
SELECT cron.schedule('refresh-popular-searches', '0 * * * *',
    'SELECT refresh_popular_searches()');
```

---

## åä¸€ã€ç›‘æ§å‘Šè­¦éœ€æ±‚

### 11.1 æœç´¢æ€§èƒ½ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**ï¼š

- âœ… **æœç´¢å»¶è¿Ÿ**: P50, P95, P99å»¶è¿Ÿ
- âœ… **QPS**: æ¯ç§’æœç´¢è¯·æ±‚æ•°
- âœ… **ç¼“å­˜å‘½ä¸­ç‡**: ç¼“å­˜å‘½ä¸­ç‡
- âœ… **é”™è¯¯ç‡**: æœç´¢é”™è¯¯ç‡
- âœ… **ç´¢å¼•å¤§å°**: GINç´¢å¼•å¤§å°

### 11.2 å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: search_system_alerts
  rules:
  - alert: HighSearchLatency
    expr: histogram_quantile(0.95, rate(search_latency_bucket[5m])) > 100
    for: 5m
    annotations:
      summary: "æœç´¢å»¶è¿Ÿè¿‡é«˜"
      description: "P95å»¶è¿Ÿè¶…è¿‡100ms: {{ $value }}ms"

  - alert: LowCacheHitRate
    expr: rate(search_cache_hits_total[5m]) / rate(search_requests_total[5m]) < 0.6
    for: 10m
    annotations:
      summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
      description: "ç¼“å­˜å‘½ä¸­ç‡: {{ $value | humanizePercentage }}"
```

---

## åäºŒã€æ‰©å±•æ€§éœ€æ±‚

### 12.1 æ°´å¹³æ‰©å±•

**åˆ†ç‰‡ç­–ç•¥**ï¼š

- âœ… **æŒ‰æ–‡æ¡£IDåˆ†ç‰‡**: æ”¯æŒæ°´å¹³æ‰©å±•
- âœ… **æŒ‰åˆ†ç±»åˆ†ç‰‡**: æŒ‰æ–‡æ¡£åˆ†ç±»åˆ†ç‰‡
- âœ… **è¯»å†™åˆ†ç¦»**: ä¸»ä»å¤åˆ¶ï¼Œè¯»æµé‡åˆ†æ•£

### 12.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ç»´æŠ¤**ï¼š

```sql
-- ç´¢å¼•ç»´æŠ¤å‡½æ•°
CREATE OR REPLACE FUNCTION maintain_search_indexes()
RETURNS TABLE (
    index_name TEXT,
    index_size TEXT,
    last_vacuum TIMESTAMPTZ,
    last_analyze TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        schemaname||'.'||indexname AS index_name,
        pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
        last_vacuum,
        last_analyze
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public'
      AND indexname LIKE 'idx_documents%'
    ORDER BY pg_relation_size(indexrelid) DESC;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç´¢å¼•ç»´æŠ¤æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åä¸‰ã€å®‰å…¨éœ€æ±‚

### 13.1 æœç´¢æƒé™æ§åˆ¶

**æƒé™æ§åˆ¶**ï¼š

```sql
-- æ–‡æ¡£æƒé™è¡¨
CREATE TABLE IF NOT EXISTS document_permissions (
    doc_id BIGINT NOT NULL,
    user_id BIGINT,
    role TEXT,
    permission TEXT,  -- read, write, delete
    PRIMARY KEY (doc_id, user_id, role)
);

-- å¸¦æƒé™çš„æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_with_permissions(
    p_user_id BIGINT,
    p_query TEXT,
    p_limit INT DEFAULT 20
)
RETURNS TABLE (
    doc_id BIGINT,
    title TEXT,
    snippet TEXT,
    rank REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('chinese', d.content, to_tsquery('chinese', p_query)) AS snippet,
        ts_rank(d.search_vector, to_tsquery('chinese', p_query)) AS rank
    FROM documents d
    WHERE d.search_vector @@ to_tsquery('chinese', p_query)
      AND (
          -- å…¬å¼€æ–‡æ¡£
          d.is_public = TRUE
          OR
          -- ç”¨æˆ·æœ‰æƒé™çš„æ–‡æ¡£
          EXISTS (
              SELECT 1 FROM document_permissions dp
              WHERE dp.doc_id = d.doc_id
                AND dp.user_id = p_user_id
                AND dp.permission = 'read'
          )
      )
    ORDER BY rank DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æƒé™æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åå››ã€æ€»ç»“

### 14.1 æ ¸å¿ƒéœ€æ±‚æ€»ç»“

**å…¨æ–‡æœç´¢ç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚**ï¼š

1. âœ… **é«˜æ€§èƒ½æœç´¢**: P95å»¶è¿Ÿ < 100ms
2. âœ… **é«˜å‡†ç¡®åº¦**: ä¸­æ–‡æœç´¢å‡†ç¡®åº¦æå‡20-40%
3. âœ… **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸­è‹±æ–‡ç­‰å¤šè¯­è¨€æœç´¢
4. âœ… **ç¼“å­˜ä¼˜åŒ–**: ç¼“å­˜å‘½ä¸­ç‡ > 60%
5. âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒç™¾ä¸‡çº§æ–‡æ¡£æœç´¢
6. âœ… **å®‰å…¨æ§åˆ¶**: æƒé™æ§åˆ¶ã€æœç´¢å®¡è®¡

### 14.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨å…¨æ–‡æœç´¢ç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **ä¸­æ–‡åˆ†è¯ä¼˜åŒ–**: æœç´¢å‡†ç¡®åº¦æå‡20-40%
- âœ… **å¼‚æ­¥I/O**: ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡40%
- âœ… **å¹¶è¡ŒæŸ¥è¯¢**: å¤§æ•°æ®é‡æœç´¢æ€§èƒ½æå‡55%
- âœ… **GINç´¢å¼•ä¼˜åŒ–**: æŸ¥è¯¢æ€§èƒ½æå‡30%

---

**è¿”å›**: [æ¡ˆä¾‹6ä¸»é¡µ](./README.md)
**å­—æ•°**: ~4,200å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
