---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\06-å…¨æ–‡æœç´¢ç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å…¨æ–‡æœç´¢ç³»ç»Ÿ - éœ€æ±‚åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **æ–‡æ¡£æ•°**: ç™¾ä¸‡çº§

---

## ä¸€ã€ä¸šåŠ¡åœºæ™¯

### æ–‡æ¡£æœç´¢å¹³å°

- **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ–‡ç« ã€äº§å“æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ
- **æ–‡æ¡£æ•°é‡**: 100ä¸‡+
- **æŸ¥è¯¢ç±»å‹**: å…³é”®è¯æœç´¢ã€çŸ­è¯­æœç´¢ã€æ¨¡ç³Šæœç´¢
- **æ’åº**: ç›¸å…³æ€§æ’åº

---

## äºŒã€æ•°æ®æ¨¡å‹

```sql
-- æ–‡æ¡£è¡¨
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- â­ PostgreSQL 18ï¼šå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_documents_fts_title
ON documents USING GIN (to_tsvector('chinese', title));

CREATE INDEX idx_documents_fts_content
ON documents USING GIN (to_tsvector('chinese', content));

-- ç»„åˆæœç´¢ç´¢å¼•
CREATE INDEX idx_documents_fts_combined
ON documents USING GIN (
    to_tsvector('chinese', title || ' ' || content)
);
```

---

## ä¸‰ã€æœç´¢æŸ¥è¯¢

### åŸºç¡€æœç´¢

```sql
-- ç®€å•å…³é”®è¯æœç´¢
SELECT
    doc_id,
    title,
    ts_rank(to_tsvector('chinese', content), query) as rank
FROM documents,
    to_tsquery('chinese', 'æ•°æ®åº“ & ä¼˜åŒ–') query
WHERE to_tsvector('chinese', content) @@ query
ORDER BY rank DESC
LIMIT 20;
```

### é«˜çº§æœç´¢

```sql
-- ä½¿ç”¨websearch_to_tsqueryï¼ˆæ”¯æŒè‡ªç„¶è¯­è¨€ï¼‰
SELECT
    doc_id,
    title,
    ts_rank_cd(
        to_tsvector('chinese', title || ' ' || content),
        query,
        32  -- è¦†ç›–å¯†åº¦æƒé‡
    ) as rank,
    ts_headline(
        'chinese',
        content,
        query,
        'MaxWords=50, MinWords=20'
    ) as snippet
FROM documents,
    websearch_to_tsquery('chinese', 'PostgreSQLæ•°æ®åº“ä¼˜åŒ–') query
WHERE to_tsvector('chinese', title || ' ' || content) @@ query
ORDER BY rank DESC
LIMIT 20;

-- PostgreSQL 18ï¼šä¸­æ–‡åˆ†è¯ä¼˜åŒ–ï¼Œç›¸å…³æ€§æå‡20-40%
```

---

## å››ã€æ€§èƒ½ä¼˜åŒ–

### é¢„è®¡ç®—tsvector

```sql
-- æ·»åŠ tsvectoråˆ—ï¼ˆé¿å…å®æ—¶è®¡ç®—ï¼‰
ALTER TABLE documents
ADD COLUMN tsv tsvector
GENERATED ALWAYS AS (
    to_tsvector('chinese', coalesce(title, '') || ' ' || coalesce(content, ''))
) STORED;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_documents_tsv ON documents USING GIN (tsv);

-- æŸ¥è¯¢ï¼ˆæ›´å¿«ï¼‰
SELECT doc_id, title,
    ts_rank(tsv, query) as rank
FROM documents,
    to_tsquery('chinese', 'æ•°æ®åº“ & ä¼˜åŒ–') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **ä¸­æ–‡åˆ†è¯ä¼˜åŒ–**: æ›´å‡†ç¡®çš„åˆ†è¯
- **ç›¸å…³æ€§ç®—æ³•**: ts_rankæ”¹è¿›ï¼Œ+20-40%å‡†ç¡®åº¦
- **GINç´¢å¼•**: æ€§èƒ½ä¼˜åŒ–

---

---

## å…­ã€æœç´¢åŠŸèƒ½éœ€æ±‚

### 6.1 é«˜çº§æœç´¢åŠŸèƒ½

**é«˜çº§æœç´¢åŠŸèƒ½å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- é«˜çº§æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION advanced_search(
    p_query TEXT,
    p_author TEXT DEFAULT NULL,
    p_category TEXT DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_min_rank REAL DEFAULT 0.1,
    p_limit INT DEFAULT 20
)
RETURNS TABLE (
    doc_id BIGINT,
    title TEXT,
    snippet TEXT,
    rank REAL,
    author TEXT,
    category TEXT,
    tags TEXT[]
) AS $$
DECLARE
    query_vector tsquery;
BEGIN
    -- è§£ææŸ¥è¯¢
    query_vector := to_tsquery('zh_parser', p_query);

    IF query_vector IS NULL THEN
        RAISE EXCEPTION 'æ— æ•ˆçš„æœç´¢æŸ¥è¯¢: %', p_query;
    END IF;

    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query_vector,
                   'MaxWords=50, MinWords=30, StartSel=<mark>, StopSel=</mark>') AS snippet,
        ts_rank_cd(d.search_vector, query_vector, 32) AS rank,
        d.author,
        d.category,
        d.tags
    FROM documents d
    WHERE d.search_vector @@ query_vector
      AND ts_rank_cd(d.search_vector, query_vector, 32) >= p_min_rank
      AND (p_author IS NULL OR d.author = p_author)
      AND (p_category IS NULL OR d.category = p_category)
      AND (p_tags IS NULL OR d.tags && p_tags)
      AND (p_date_from IS NULL OR d.created_at::DATE >= p_date_from)
      AND (p_date_to IS NULL OR d.created_at::DATE <= p_date_to)
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é«˜çº§æœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 æœç´¢å»ºè®®åŠŸèƒ½

**æœç´¢å»ºè®®åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æœç´¢å»ºè®®å‡½æ•°ï¼ˆåŸºäºå†å²æœç´¢ï¼‰
CREATE OR REPLACE FUNCTION get_search_suggestions(
    p_prefix TEXT,
    p_limit INT DEFAULT 10
)
RETURNS TABLE (
    suggestion TEXT,
    search_count BIGINT,
    last_searched TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        query_text AS suggestion,
        COUNT(*)::BIGINT AS search_count,
        MAX(created_at) AS last_searched
    FROM search_logs
    WHERE query_text ILIKE p_prefix || '%'
    GROUP BY query_text
    ORDER BY search_count DESC, last_searched DESC
    LIMIT p_limit;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–æœç´¢å»ºè®®å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€æ€§èƒ½éœ€æ±‚

### 7.1 æ€§èƒ½æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡è¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½æŒ‡æ ‡ç›‘æ§
CREATE OR REPLACE FUNCTION check_search_performance()
RETURNS TABLE (
    metric_name TEXT,
    target_value NUMERIC,
    current_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    -- P95å»¶è¿Ÿæ£€æŸ¥
    RETURN QUERY
    SELECT
        'P95æœç´¢å»¶è¿Ÿ(ms)'::TEXT,
        100.0::NUMERIC AS target_value,
        (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms)
         FROM search_logs
         WHERE created_at > NOW() - INTERVAL '1 hour')::NUMERIC AS current_value,
        CASE
            WHEN (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms)
                  FROM search_logs
                  WHERE created_at > NOW() - INTERVAL '1 hour') <= 100
            THEN 'è¾¾æ ‡'
            ELSE 'æœªè¾¾æ ‡'
        END AS status;

    -- ç¼“å­˜å‘½ä¸­ç‡æ£€æŸ¥
    RETURN QUERY
    SELECT
        'ç¼“å­˜å‘½ä¸­ç‡(%)'::TEXT,
        60.0::NUMERIC AS target_value,
        (SELECT COUNT(*) FILTER (WHERE from_cache = TRUE) * 100.0 / COUNT(*)
         FROM search_logs
         WHERE created_at > NOW() - INTERVAL '1 hour')::NUMERIC AS current_value,
        CASE
            WHEN (SELECT COUNT(*) FILTER (WHERE from_cache = TRUE) * 100.0 / COUNT(*)
                  FROM search_logs
                  WHERE created_at > NOW() - INTERVAL '1 hour') >= 60
            THEN 'è¾¾æ ‡'
            ELSE 'æœªè¾¾æ ‡'
        END AS status;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
