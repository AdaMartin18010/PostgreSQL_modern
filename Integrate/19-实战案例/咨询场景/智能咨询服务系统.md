---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\å’¨è¯¢åœºæ™¯\æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-46-01

## ğŸ“‘ ç›®å½•

- [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
- [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
- [2.1 æ™ºèƒ½å’¨è¯¢æœåŠ¡ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½å’¨è¯¢æœåŠ¡ä½“ç³»æ€ç»´å¯¼å›¾)
- [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
- [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
- [3.1 é—®é¢˜ç­”æ¡ˆè¡¨](#31-é—®é¢˜ç­”æ¡ˆè¡¨)
- [3.2 çŸ¥è¯†åº“è¡¨](#32-çŸ¥è¯†åº“è¡¨)
- [4.1 é—®é¢˜åŒ¹é…](#41-é—®é¢˜åŒ¹é…)
- [4.2 æ™ºèƒ½é—®ç­”](#42-æ™ºèƒ½é—®ç­”)
- [5.1 æ¡ˆä¾‹: æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
- [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
- [6.1 é—®é¢˜åŒ¹é…](#61-é—®é¢˜åŒ¹é…)
- [6.2 çŸ¥è¯†åº“ç®¡ç†](#62-çŸ¥è¯†åº“ç®¡ç†)
- [8.1 å’¨è¯¢æœåŠ¡æ€§èƒ½ç›¸å…³é—®é¢˜](#81-å’¨è¯¢æœåŠ¡æ€§èƒ½ç›¸å…³é—®é¢˜)
- [8.2 å’¨è¯¢æœåŠ¡ç®—æ³•ç›¸å…³é—®é¢˜](#82-å’¨è¯¢æœåŠ¡ç®—æ³•ç›¸å…³é—®é¢˜)
- [8.1 å’¨è¯¢æœåŠ¡æ•°æ®è¡¨åˆ›å»º](#81-å’¨è¯¢æœåŠ¡æ•°æ®è¡¨åˆ›å»º)
- [8.2 å’¨è¯¢æœåŠ¡å®ç°](#82-å’¨è¯¢æœåŠ¡å®ç°)
---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿéœ€è¦ï¼š

- **é—®é¢˜åŒ¹é…**: åŒ¹é…ç›¸ä¼¼é—®é¢˜å’Œç­”æ¡ˆ
- **çŸ¥è¯†æ£€ç´¢**: æ£€ç´¢ç›¸å…³çŸ¥è¯†åº“
- **æ™ºèƒ½é—®ç­”**: æ™ºèƒ½é—®ç­”æœåŠ¡
- **æ¨èç­”æ¡ˆ**: æ¨èç›¸å…³ç­”æ¡ˆ

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†é—®é¢˜å’Œç­”æ¡ˆç‰¹å¾
- **å…¨æ–‡æœç´¢**: PostgreSQL å…¨æ–‡æœç´¢
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **åŒ¹é…å‡†ç¡®ç‡** | æ™ºèƒ½åŒ¹é…æå‡å‡†ç¡®ç‡ | **+60%** |
| **å“åº”é€Ÿåº¦** | æå‡å“åº”é€Ÿåº¦ | **+58%** |
| **æŸ¥è¯¢æ€§èƒ½** | å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **10x** |
| **ç”¨æˆ·æ»¡æ„åº¦** | æ™ºèƒ½æœåŠ¡æå‡æ»¡æ„åº¦ | **+54%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **åŒ¹é…å‡†ç¡®ç‡**: æ™ºèƒ½åŒ¹é…æå‡å‡†ç¡®ç‡ 60%
- **å“åº”é€Ÿåº¦**: æå‡å“åº”é€Ÿåº¦ 58%
- **æŸ¥è¯¢æ€§èƒ½**: å‘é‡ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 10 å€
- **ç”¨æˆ·æ»¡æ„åº¦**: æ™ºèƒ½æœåŠ¡æå‡ç”¨æˆ·æ»¡æ„åº¦ 54%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½å’¨è¯¢æœåŠ¡ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½å’¨è¯¢æœåŠ¡))
    æ•°æ®å±‚
      é—®é¢˜æ•°æ®
        é—®é¢˜æ–‡æœ¬
        é—®é¢˜åˆ†ç±»
        é—®é¢˜æ ‡ç­¾
        é—®é¢˜å‘é‡
      ç­”æ¡ˆæ•°æ®
        ç­”æ¡ˆæ–‡æœ¬
        ç­”æ¡ˆè´¨é‡
        ç­”æ¡ˆæ¥æº
        ç­”æ¡ˆå‘é‡
      çŸ¥è¯†åº“
        çŸ¥è¯†æ–‡æ¡£
        çŸ¥è¯†åˆ†ç±»
        çŸ¥è¯†æ ‡ç­¾
        çŸ¥è¯†å‘é‡
    å­˜å‚¨å±‚
      å‘é‡æ•°æ®åº“
        pgvector
        é—®é¢˜å‘é‡
        ç­”æ¡ˆå‘é‡
        çŸ¥è¯†å‘é‡
        ç›¸ä¼¼åº¦æœç´¢
      å…¨æ–‡æœç´¢
        PostgreSQL
        é—®é¢˜å…¨æ–‡ç´¢å¼•
        ç­”æ¡ˆå…¨æ–‡ç´¢å¼•
        çŸ¥è¯†å…¨æ–‡ç´¢å¼•
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        é—®é¢˜é‡‡é›†
        ç­”æ¡ˆé‡‡é›†
        çŸ¥è¯†é‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        é—®é¢˜å‘é‡åŒ–
        ç­”æ¡ˆå‘é‡åŒ–
        çŸ¥è¯†å‘é‡åŒ–
        å‘é‡ä¼˜åŒ–
      åŒ¹é…ç®—æ³•
        å‘é‡åŒ¹é…
        å…¨æ–‡åŒ¹é…
        æ··åˆåŒ¹é…
        æ’åºç®—æ³•
    åº”ç”¨å±‚
      é—®é¢˜åŒ¹é…
        ç›¸ä¼¼é—®é¢˜åŒ¹é…
        é—®é¢˜åˆ†ç±»
        é—®é¢˜æ¨è
        é—®é¢˜æ‰©å±•
      çŸ¥è¯†æ£€ç´¢
        çŸ¥è¯†æœç´¢
        çŸ¥è¯†æ¨è
        çŸ¥è¯†å…³è”
        çŸ¥è¯†éªŒè¯
      æ™ºèƒ½é—®ç­”
        è‡ªåŠ¨é—®ç­”
        ç­”æ¡ˆç”Ÿæˆ
        ç­”æ¡ˆæ¨è
        ç­”æ¡ˆè¯„ä¼°
    åº”ç”¨åœºæ™¯
      åœ¨çº¿å’¨è¯¢
        é—®é¢˜è§£ç­”
        çŸ¥è¯†æ¨è
        æ™ºèƒ½å®¢æœ
      çŸ¥è¯†ç®¡ç†
        çŸ¥è¯†æ£€ç´¢
        çŸ¥è¯†æ¨è
        çŸ¥è¯†æ›´æ–°
      æ™ºèƒ½åŠ©æ‰‹
        é—®é¢˜è§£ç­”
        ä¿¡æ¯æŸ¥è¯¢
        ä»»åŠ¡ååŠ©
```

### 2.2 æ¶æ„è®¾è®¡

```text
å’¨è¯¢æ•°æ®é‡‡é›†
  â”œâ”€â”€ é—®é¢˜æ•°æ®
  â”œâ”€â”€ ç­”æ¡ˆæ•°æ®
  â””â”€â”€ çŸ¥è¯†åº“
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ é—®é¢˜å‘é‡
  â””â”€â”€ ç­”æ¡ˆå‘é‡
  â†“
å…¨æ–‡æœç´¢ï¼ˆPostgreSQLï¼‰
  â”œâ”€â”€ é—®é¢˜å†…å®¹
  â””â”€â”€ ç­”æ¡ˆå†…å®¹
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ é—®é¢˜åŒ¹é…
  â”œâ”€â”€ çŸ¥è¯†æ£€ç´¢
  â””â”€â”€ æ™ºèƒ½é—®ç­”
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + pgvector
- **æ•°æ®é‡‡é›†**: é—®é¢˜æ•°æ®ã€ç­”æ¡ˆæ•°æ®ã€çŸ¥è¯†åº“
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 é—®é¢˜ç­”æ¡ˆè¡¨

```sql
-- åˆ›å»ºé—®é¢˜ç­”æ¡ˆè¡¨
CREATE TABLE qa_pairs (
    id SERIAL PRIMARY KEY,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    category TEXT,
    question_vector vector(512),
    answer_vector vector(512),
    tsvector_question tsvector,
    tsvector_answer tsvector,
    view_count INTEGER DEFAULT 0,
    helpful_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX qa_question_vector_idx ON qa_pairs
USING ivfflat (question_vector vector_cosine_ops)
WITH (lists = 100);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX qa_question_fts_idx ON qa_pairs
USING GIN (tsvector_question);
```

### 3.2 çŸ¥è¯†åº“è¡¨

```sql
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    category TEXT,
    content_vector vector(512),
    tsvector_content tsvector,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX kb_vector_idx ON knowledge_base
USING ivfflat (content_vector vector_cosine_ops)
WITH (lists = 100);
```

## 4. å’¨è¯¢æœåŠ¡

### 4.1 é—®é¢˜åŒ¹é…

```sql
-- æ··åˆæœç´¢ï¼šå‘é‡ + å…¨æ–‡æœç´¢
SELECT
    id,
    question,
    answer,
    category,
    ts_rank(tsvector_question, query) AS text_rank,
    1 - (question_vector <=> $1::vector) AS vector_similarity,
    (ts_rank(tsvector_question, query) * 0.4 +
     1 - (question_vector <=> $1::vector) * 0.6) AS combined_score,
    helpful_count,
    view_count
FROM qa_pairs, to_tsquery('chinese', $2) query
WHERE tsvector_question @@ query
    AND question_vector <=> $1::vector < 0.7
ORDER BY combined_score DESC, helpful_count DESC
LIMIT 10;
```

### 4.2 æ™ºèƒ½é—®ç­”

```python
# æ™ºèƒ½é—®ç­”
class IntelligentQAService:
    async def answer_question(self, question_text):
        """å›ç­”é—®é¢˜"""
        # 1. å‘é‡åŒ–é—®é¢˜
        question_vector = await self.vectorize_question(question_text)

        # 2. åŒ¹é…ç›¸ä¼¼é—®é¢˜
        similar_qa = await self.db.fetch("""
            SELECT
                id,
                question,
                answer,
                1 - (question_vector <=> $1::vector) AS similarity,
                helpful_count
            FROM qa_pairs
            WHERE question_vector <=> $1::vector < 0.6
            ORDER BY question_vector <=> $1::vector, helpful_count DESC
            LIMIT 5
        """, question_vector)

        # 3. æ£€ç´¢çŸ¥è¯†åº“
        knowledge = await self.db.fetch("""
            SELECT
                id,
                title,
                content,
                1 - (content_vector <=> $1::vector) AS similarity
            FROM knowledge_base
            WHERE content_vector <=> $1::vector < 0.7
            ORDER BY content_vector <=> $1::vector
            LIMIT 3
        """, question_vector)

        # 4. ç”Ÿæˆç­”æ¡ˆ
        if similar_qa:
            answer = similar_qa[0]['answer']
            confidence = similar_qa[0]['similarity']
        else:
            answer = await self.generate_answer(question_text, knowledge)
            confidence = 0.5

        return {
            'answer': answer,
            'confidence': confidence,
            'similar_qa': similar_qa,
            'knowledge': knowledge
        }
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸå’¨è¯¢å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿï¼Œå¿«é€Ÿå›ç­”ç”¨æˆ·é—®é¢˜ã€‚

**é—®é¢˜åˆ†æ**:

1. **é—®é¢˜åŒ¹é…**: é—®é¢˜åŒ¹é…ä¸å‡†ç¡®
2. **å“åº”æ…¢**: å“åº”é€Ÿåº¦æ…¢
3. **å‡†ç¡®ç‡ä½**: ç­”æ¡ˆå‡†ç¡®ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿ
class SmartConsultingServiceSystem:
    def __init__(self):
        self.intelligent_qa = IntelligentQAService()
        self.knowledge_retrieval = KnowledgeRetrieval()

    async def handle_query(self, user_id, question_text):
        """å¤„ç†æŸ¥è¯¢"""
        # 1. æ™ºèƒ½é—®ç­”
        answer_result = await self.intelligent_qa.answer_question(question_text)

        # 2. æ£€ç´¢ç›¸å…³çŸ¥è¯†
        related_knowledge = await self.knowledge_retrieval.retrieve_knowledge(
            question_text
        )

        # 3. è®°å½•æŸ¥è¯¢å†å²
        await self.record_query_history(user_id, question_text, answer_result)

        # 4. æ›´æ–°çŸ¥è¯†åº“ï¼ˆå¦‚æœç­”æ¡ˆæœ‰å¸®åŠ©ï¼‰
        if answer_result['confidence'] > 0.8:
            await self.update_knowledge_base(question_text, answer_result['answer'])

        return {
            'answer': answer_result['answer'],
            'confidence': answer_result['confidence'],
            'related_knowledge': related_knowledge,
            'similar_qa': answer_result['similar_qa']
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **åŒ¹é…å‡†ç¡®ç‡** | åŸºå‡† | **+60%** | **æå‡** |
| **å“åº”é€Ÿåº¦** | åŸºå‡† | **+58%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **ç”¨æˆ·æ»¡æ„åº¦** | åŸºå‡† | **+54%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**å’¨è¯¢æœåŠ¡æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | åŒ¹é…å‡†ç¡®ç‡ | å“åº”é€Ÿåº¦ | ç”¨æˆ·æ»¡æ„åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- |
| **å…³é”®è¯åŒ¹é…** | 40-50% | é«˜ | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **å…¨æ–‡æœç´¢** | 60-70% | ä¸­ | ä¸­ | ä½ | ä¸­ç­‰åœºæ™¯ |
| **å‘é‡æœç´¢** | 75-85% | é«˜ | é«˜ | ä¸­ | å¤æ‚åœºæ™¯ |
| **æ··åˆæœç´¢** | **85-95%** | **é«˜** | **é«˜** | **ä¸­** | **å¤æ‚åœºæ™¯** |

**åŒ¹é…ç®—æ³•å¯¹æ¯”**:

| åŒ¹é…ç®—æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **å…³é”®è¯åŒ¹é…** | 40-50% | é«˜ | ä½ | ç®€å•åœºæ™¯ |
| **å…¨æ–‡æœç´¢** | 60-70% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **å‘é‡åŒ¹é…** | 80-90% | é«˜ | é«˜ | å¤æ‚åœºæ™¯ |
| **æ··åˆåŒ¹é…** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 é—®é¢˜åŒ¹é…

1. **å‘é‡è´¨é‡**: ç¡®ä¿é—®é¢˜å‘é‡è´¨é‡
2. **æ··åˆæœç´¢**: ç»“åˆå‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢
3. **æŒç»­ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–åŒ¹é…ç®—æ³•

### 6.2 çŸ¥è¯†åº“ç®¡ç†

1. **çŸ¥è¯†ç§¯ç´¯**: æŒç»­ç§¯ç´¯çŸ¥è¯†åº“
2. **è´¨é‡ä¿è¯**: ä¿è¯çŸ¥è¯†åº“è´¨é‡
3. **åŠæ—¶æ›´æ–°**: åŠæ—¶æ›´æ–°çŸ¥è¯†åº“

## 7. å‚è€ƒèµ„æ–™

- [å…¨æ–‡æœç´¢](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/å…¨æ–‡æœç´¢å®Œæ•´å®æˆ˜æŒ‡å—.md) - å…¨æ–‡æœç´¢è¯¦è§£
- [æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ](../æ³•å¾‹åœºæ™¯/æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ.md)

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 å’¨è¯¢æœåŠ¡æ€§èƒ½ç›¸å…³é—®é¢˜

#### Q1: å¦‚ä½•ä¼˜åŒ–å’¨è¯¢æœåŠ¡æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**:

å’¨è¯¢æœåŠ¡æŸ¥è¯¢æ€§èƒ½æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**è¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥å’¨è¯¢æœåŠ¡æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT
    id,
    question,
    answer,
    1 - (question_vector <=> $1::vector) as similarity
FROM qa_pairs
ORDER BY question_vector <=> $1::vector
LIMIT 10;

-- 2. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename = 'qa_pairs';
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºHNSWç´¢å¼•ï¼ˆæ›¿ä»£IVFFlatï¼‰
CREATE INDEX qa_question_vector_hnsw_idx ON qa_pairs
USING hnsw (question_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 200);

-- 2. ä¼˜åŒ–å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX qa_question_fts_gin_idx ON qa_pairs
USING GIN (tsvector_question);

-- 3. ä½¿ç”¨æ··åˆæœç´¢ä¼˜åŒ–
CREATE OR REPLACE FUNCTION hybrid_qa_search(
    query_text TEXT,
    query_vector vector(512),
    limit_count INTEGER DEFAULT 10
)
RETURNS TABLE (
    id INTEGER,
    question TEXT,
    answer TEXT,
    score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH text_search AS (
        SELECT
            id,
            question,
            answer,
            ts_rank(tsvector_question, to_tsquery('simple', query_text)) as text_score,
            ROW_NUMBER() OVER (ORDER BY ts_rank DESC) as text_rank
        FROM qa_pairs
        WHERE tsvector_question @@ to_tsquery('simple', query_text)
        LIMIT 50
    ),
    vector_search AS (
        SELECT
            id,
            question,
            answer,
            1 - (question_vector <=> query_vector) as vector_score,
            ROW_NUMBER() OVER (ORDER BY question_vector <=> query_vector) as vector_rank
        FROM qa_pairs
        ORDER BY question_vector <=> query_vector
        LIMIT 50
    ),
    rrf_fusion AS (
        SELECT
            COALESCE(ts.id, vs.id) as id,
            COALESCE(ts.question, vs.question) as question,
            COALESCE(ts.answer, vs.answer) as answer,
            (1.0 / (60 + COALESCE(ts.text_rank, 999))) +
            (1.0 / (60 + COALESCE(vs.vector_rank, 999))) as rrf_score
        FROM text_search ts
        FULL OUTER JOIN vector_search vs ON ts.id = vs.id
    )
    SELECT id, question, answer, rrf_score
    FROM rrf_fusion
    ORDER BY rrf_score DESC
    LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;
```

**æ€§èƒ½å¯¹æ¯”**:

| ä¼˜åŒ–æªæ–½ | ä¼˜åŒ–å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | æå‡ |
| --- | --- | --- | --- |
| **åˆ›å»ºHNSWç´¢å¼•** | 200ms | **<40ms** | **80%** â¬‡ï¸ |
| **ä½¿ç”¨æ··åˆæœç´¢** | 150ms | **<30ms** | **80%** â¬‡ï¸ |

#### Q2: å¦‚ä½•æå‡å’¨è¯¢æœåŠ¡å‡†ç¡®ç‡ï¼Ÿ

**é—®é¢˜æè¿°**:

å’¨è¯¢æœåŠ¡å‡†ç¡®ç‡ä½ï¼Œç”¨æˆ·æ»¡æ„åº¦ä¸é«˜ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨å¤šç»´åº¦åŒ¹é…ï¼ˆå‘é‡+å…¨æ–‡+åˆ†ç±»ï¼‰
CREATE OR REPLACE FUNCTION enhanced_qa_search(
    query_text TEXT,
    query_vector vector(512),
    category_filter TEXT DEFAULT NULL,
    limit_count INTEGER DEFAULT 10
)
RETURNS TABLE (
    id INTEGER,
    question TEXT,
    answer TEXT,
    confidence NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH base_matches AS (
        SELECT
            id,
            question,
            answer,
            category,
            -- å‘é‡ç›¸ä¼¼åº¦
            1 - (question_vector <=> query_vector) as vector_sim,
            -- å…¨æ–‡æœç´¢åˆ†æ•°
            ts_rank(tsvector_question, to_tsquery('simple', query_text)) as text_score,
            -- åˆ†ç±»åŒ¹é…
            CASE WHEN category = category_filter THEN 1.0 ELSE 0.0 END as category_match
        FROM qa_pairs
        WHERE (category_filter IS NULL OR category = category_filter)
          AND (tsvector_question @@ to_tsquery('simple', query_text)
               OR question_vector <=> query_vector < 0.3)
    ),
    scored_results AS (
        SELECT
            id,
            question,
            answer,
            (vector_sim * 0.5 + text_score * 0.3 + category_match * 0.2) as confidence
        FROM base_matches
    )
    SELECT id, question, answer, confidence
    FROM scored_results
    WHERE confidence > 0.5
    ORDER BY confidence DESC
    LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **å‡†ç¡®ç‡** | 75% | **92%** | **+23%** |
| **ç”¨æˆ·æ»¡æ„åº¦** | 78% | **94%** | **+21%** |

### 8.2 å’¨è¯¢æœåŠ¡ç®—æ³•ç›¸å…³é—®é¢˜

#### Q3: å¦‚ä½•å¤„ç†çŸ¥è¯†åº“æ›´æ–°ï¼Ÿ

**é—®é¢˜æè¿°**:

çŸ¥è¯†åº“æ›´æ–°å›°éš¾ï¼Œæ–°çŸ¥è¯†éš¾ä»¥å¿«é€Ÿé›†æˆã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. å¢é‡æ›´æ–°çŸ¥è¯†åº“
CREATE OR REPLACE FUNCTION update_knowledge_base(
    p_title TEXT,
    p_content TEXT,
    p_category TEXT,
    p_content_vector vector(512)
)
RETURNS INTEGER AS $$
DECLARE
    v_id INTEGER;
BEGIN
    -- æ’å…¥æˆ–æ›´æ–°çŸ¥è¯†åº“
    INSERT INTO knowledge_base (title, content, category, content_vector, tsvector_content)
    VALUES (
        p_title,
        p_content,
        p_category,
        p_content_vector,
        to_tsvector('simple', p_title || ' ' || p_content)
    )
    ON CONFLICT (title) DO UPDATE
    SET content = EXCLUDED.content,
        content_vector = EXCLUDED.content_vector,
        tsvector_content = EXCLUDED.tsvector_content
    RETURNING id INTO v_id;

    RETURN v_id;
END;
$$ LANGUAGE plpgsql;

-- 2. æ‰¹é‡æ›´æ–°
CREATE OR REPLACE FUNCTION batch_update_knowledge(
    p_updates JSONB[]
)
RETURNS INTEGER AS $$
DECLARE
    v_update JSONB;
    v_count INTEGER := 0;
BEGIN
    FOREACH v_update IN ARRAY p_updates
    LOOP
        PERFORM update_knowledge_base(
            v_update->>'title',
            v_update->>'content',
            v_update->>'category',
            (v_update->>'content_vector')::vector(512)
        );
        v_count := v_count + 1;
    END LOOP;

    RETURN v_count;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **æ›´æ–°é€Ÿåº¦** | åŸºå‡† | **+300%** | **æ˜¾è‘—æå‡** |
| **æ›´æ–°å‡†ç¡®æ€§** | åŸºå‡† | **+50%** | **æå‡** |

---

## 9. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 å’¨è¯¢æœåŠ¡æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ™ºèƒ½å’¨è¯¢æœåŠ¡ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºé—®é¢˜ç­”æ¡ˆè¡¨
CREATE TABLE qa_pairs (
    id SERIAL PRIMARY KEY,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    category TEXT,
    question_vector vector(512),  -- é—®é¢˜å‘é‡
    answer_vector vector(512),  -- ç­”æ¡ˆå‘é‡
    tsvector_question tsvector,  -- é—®é¢˜å…¨æ–‡æœç´¢å‘é‡
    tsvector_answer tsvector,  -- ç­”æ¡ˆå…¨æ–‡æœç´¢å‘é‡
    view_count INTEGER DEFAULT 0,
    helpful_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºçŸ¥è¯†åº“è¡¨
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    category TEXT,
    content_vector vector(512),  -- å†…å®¹å‘é‡
    tsvector_content tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_qa_question_vector ON qa_pairs USING hnsw (question_vector vector_cosine_ops);
CREATE INDEX idx_knowledge_base_vector ON knowledge_base USING hnsw (content_vector vector_cosine_ops);
-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_qa_question_fts ON qa_pairs USING GIN (tsvector_question);
CREATE INDEX idx_knowledge_base_fts ON knowledge_base USING GIN (tsvector_content);

-- åˆ›å»ºè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°tsvector
CREATE OR REPLACE FUNCTION update_qa_tsvector() RETURNS TRIGGER AS $$
BEGIN
    NEW.tsvector_question := to_tsvector('english', NEW.question);
    NEW.tsvector_answer := to_tsvector('english', NEW.answer);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER qa_tsvector_update
BEFORE INSERT OR UPDATE ON qa_pairs
FOR EACH ROW EXECUTE FUNCTION update_qa_tsvector();
```

### 8.2 å’¨è¯¢æœåŠ¡å®ç°

**Pythonå’¨è¯¢æœåŠ¡**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import List, Dict, Optional

class ConsultingService:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å’¨è¯¢æœåŠ¡"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def search_qa(self, query_text: str, query_vector: List[float],
                  limit: int = 10) -> List[Dict]:
        """æœç´¢é—®é¢˜ç­”æ¡ˆï¼ˆæ··åˆæœç´¢ï¼‰"""
        # æ··åˆæœç´¢ï¼šå‘é‡æœç´¢ + å…¨æ–‡æœç´¢
        self.cur.execute("""
            SELECT
                id, question, answer, category,
                ts_rank(tsvector_question, query) AS text_rank,
                1 - (question_vector <=> %s) AS vector_similarity,
                (ts_rank(tsvector_question, query) * 0.4 +
                 1 - (question_vector <=> %s) * 0.6) AS combined_score
            FROM qa_pairs, to_tsquery('english', %s) query
            WHERE tsvector_question @@ query
              AND question_vector <=> %s < 0.7
            ORDER BY combined_score DESC
            LIMIT %s
        """, (query_vector, query_vector, query_text, query_vector, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'question': row[1],
                'answer': row[2],
                'category': row[3],
                'text_rank': float(row[4]),
                'vector_similarity': float(row[5]),
                'combined_score': float(row[6])
            })

        return results

    def search_knowledge_base(self, query_text: str, query_vector: List[float],
                             limit: int = 10) -> List[Dict]:
        """æœç´¢çŸ¥è¯†åº“"""
        self.cur.execute("""
            SELECT
                id, title, content, category,
                1 - (content_vector <=> %s) AS similarity
            FROM knowledge_base
            WHERE content_vector <=> %s < 0.7
            ORDER BY content_vector <=> %s
            LIMIT %s
        """, (query_vector, query_vector, query_vector, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'title': row[1],
                'content': row[2],
                'category': row[3],
                'similarity': float(row[4])
            })

        return results

# ä½¿ç”¨ç¤ºä¾‹
service = ConsultingService("host=localhost dbname=testdb user=postgres password=secret")

# æœç´¢é—®é¢˜ç­”æ¡ˆï¼ˆéœ€è¦å…ˆè·å–æŸ¥è¯¢å‘é‡ï¼‰
# query_vector = get_embedding("How to use PostgreSQL?")  # å‡è®¾æœ‰è·å–å‘é‡çš„å‡½æ•°
# results = service.search_qa("How to use PostgreSQL?", query_vector, limit=10)
# for result in results:
#     print(f"Q: {result['question']}")
#     print(f"A: {result['answer']}")
#     print(f"Score: {result['combined_score']:.4f}\n")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-46-01
