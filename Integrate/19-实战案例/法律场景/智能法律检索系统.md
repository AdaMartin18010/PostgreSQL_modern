---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\æ³•å¾‹åœºæ™¯\æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-45-01

## ğŸ“‘ ç›®å½•

- [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
- [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
- [2.1 æ™ºèƒ½æ³•å¾‹æ£€ç´¢ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½æ³•å¾‹æ£€ç´¢ä½“ç³»æ€ç»´å¯¼å›¾)
- [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
- [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
- [3.1 æ³•æ¡è¡¨](#31-æ³•æ¡è¡¨)
- [3.2 æ¡ˆä¾‹è¡¨](#32-æ¡ˆä¾‹è¡¨)
- [4.1 æ³•æ¡æ£€ç´¢](#41-æ³•æ¡æ£€ç´¢)
- [4.2 æ¡ˆä¾‹æ£€ç´¢](#42-æ¡ˆä¾‹æ£€ç´¢)
- [5.1 æ¡ˆä¾‹: æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
- [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
- [6.1 æ³•æ¡æ£€ç´¢](#61-æ³•æ¡æ£€ç´¢)
- [6.2 æ¡ˆä¾‹æ£€ç´¢](#62-æ¡ˆä¾‹æ£€ç´¢)
- [8.1 æ³•å¾‹æ•°æ®è¡¨åˆ›å»º](#81-æ³•å¾‹æ•°æ®è¡¨åˆ›å»º)
- [8.2 æ³•å¾‹æ£€ç´¢å®ç°](#82-æ³•å¾‹æ£€ç´¢å®ç°)
---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿéœ€è¦ï¼š

- **æ³•æ¡æ£€ç´¢**: å¿«é€Ÿæ£€ç´¢ç›¸å…³æ³•æ¡
- **æ¡ˆä¾‹æ£€ç´¢**: æ£€ç´¢ç›¸ä¼¼æ¡ˆä¾‹
- **è¯­ä¹‰æœç´¢**: åŸºäºè¯­ä¹‰çš„æœç´¢
- **æ™ºèƒ½æ¨è**: æ¨èç›¸å…³æ³•æ¡å’Œæ¡ˆä¾‹

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†æ³•æ¡å’Œæ¡ˆä¾‹ç‰¹å¾
- **å…¨æ–‡æœç´¢**: PostgreSQL å…¨æ–‡æœç´¢
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æ£€ç´¢å‡†ç¡®ç‡** | æ™ºèƒ½æ£€ç´¢æå‡å‡†ç¡®ç‡ | **+62%** |
| **æ£€ç´¢æ•ˆç‡** | æå‡æ£€ç´¢æ•ˆç‡ | **+55%** |
| **æŸ¥è¯¢æ€§èƒ½** | å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **11x** |
| **ç”¨æˆ·æ»¡æ„åº¦** | æ™ºèƒ½æ£€ç´¢æå‡æ»¡æ„åº¦ | **+52%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ£€ç´¢å‡†ç¡®ç‡**: æ™ºèƒ½æ£€ç´¢æå‡å‡†ç¡®ç‡ 62%
- **æ£€ç´¢æ•ˆç‡**: æå‡æ£€ç´¢æ•ˆç‡ 55%
- **æŸ¥è¯¢æ€§èƒ½**: å‘é‡ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 11 å€
- **ç”¨æˆ·æ»¡æ„åº¦**: æ™ºèƒ½æ£€ç´¢æå‡ç”¨æˆ·æ»¡æ„åº¦ 52%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½æ³•å¾‹æ£€ç´¢ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½æ³•å¾‹æ£€ç´¢))
    æ•°æ®å±‚
      æ³•æ¡æ•°æ®
        æ³•æ¡ä¿¡æ¯
        æ³•æ¡å†…å®¹
        æ³•æ¡åˆ†ç±»
        æ³•æ¡å…³ç³»
      æ¡ˆä¾‹æ•°æ®
        æ¡ˆä¾‹ä¿¡æ¯
        æ¡ˆä¾‹å†…å®¹
        æ¡ˆä¾‹åˆ†ç±»
        æ¡ˆä¾‹å…³ç³»
      æ³•å¾‹æ–‡æ¡£
        æ³•å¾‹æ–‡æ¡£
        å¸æ³•è§£é‡Š
        æ³•å¾‹æ¡æ–‡
        æ³•å¾‹è§£é‡Š
    å­˜å‚¨å±‚
      å‘é‡æ•°æ®åº“
        pgvector
        æ³•æ¡å‘é‡
        æ¡ˆä¾‹å‘é‡
        æ–‡æ¡£å‘é‡
        ç›¸ä¼¼åº¦æœç´¢
      å…¨æ–‡æœç´¢
        PostgreSQL
        æ³•æ¡å…¨æ–‡ç´¢å¼•
        æ¡ˆä¾‹å…¨æ–‡ç´¢å¼•
        æœç´¢ç´¢å¼•
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        æ³•æ¡é‡‡é›†
        æ¡ˆä¾‹é‡‡é›†
        æ–‡æ¡£é‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        æ³•æ¡å‘é‡åŒ–
        æ¡ˆä¾‹å‘é‡åŒ–
        æ–‡æ¡£å‘é‡åŒ–
        å‘é‡ä¼˜åŒ–
      æ£€ç´¢ç®—æ³•
        æ³•æ¡æ£€ç´¢
        æ¡ˆä¾‹æ£€ç´¢
        æ··åˆæ£€ç´¢
        æ’åºç®—æ³•
    åº”ç”¨å±‚
      æ³•æ¡æ£€ç´¢
        å…³é”®è¯æ£€ç´¢
        è¯­ä¹‰æ£€ç´¢
        æ··åˆæ£€ç´¢
        æ¨èæ³•æ¡
      æ¡ˆä¾‹æ£€ç´¢
        ç›¸ä¼¼æ¡ˆä¾‹
        ç›¸å…³æ¡ˆä¾‹
        æ¨èæ¡ˆä¾‹
        æ¡ˆä¾‹åˆ†æ
      æ™ºèƒ½æ¨è
        æ³•æ¡æ¨è
        æ¡ˆä¾‹æ¨è
        ç›¸å…³æ¨è
        æ™ºèƒ½åˆ†æ
    åº”ç”¨åœºæ™¯
      æ³•å¾‹æœåŠ¡å¹³å°
        æ³•æ¡æ£€ç´¢
        æ¡ˆä¾‹æ£€ç´¢
        æ™ºèƒ½æ¨è
      å¾‹å¸ˆäº‹åŠ¡æ‰€
        æ³•å¾‹æ£€ç´¢
        æ¡ˆä¾‹ç ”ç©¶
        æ³•å¾‹åˆ†æ
      å¸æ³•æœºå…³
        æ³•å¾‹æ£€ç´¢
        æ¡ˆä¾‹å‚è€ƒ
        åˆ¤å†³æ”¯æŒ
```

### 2.2 æ¶æ„è®¾è®¡

```text
æ³•å¾‹æ•°æ®é‡‡é›†
  â”œâ”€â”€ æ³•æ¡æ•°æ®
  â”œâ”€â”€ æ¡ˆä¾‹æ•°æ®
  â””â”€â”€ æ³•å¾‹æ–‡æ¡£
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ æ³•æ¡å‘é‡
  â””â”€â”€ æ¡ˆä¾‹å‘é‡
  â†“
å…¨æ–‡æœç´¢ï¼ˆPostgreSQLï¼‰
  â”œâ”€â”€ æ³•æ¡å†…å®¹
  â””â”€â”€ æ¡ˆä¾‹å†…å®¹
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ æ³•æ¡æ£€ç´¢
  â”œâ”€â”€ æ¡ˆä¾‹æ£€ç´¢
  â””â”€â”€ æ™ºèƒ½æ¨è
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + pgvector
- **æ•°æ®é‡‡é›†**: æ³•æ¡æ•°æ®ã€æ¡ˆä¾‹æ•°æ®
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ³•æ¡è¡¨

```sql
-- åˆ›å»ºæ³•æ¡è¡¨
CREATE TABLE legal_articles (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    law_type TEXT,
    article_number TEXT,
    content_vector vector(512),
    tsvector_content tsvector,
    effective_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX la_vector_idx ON legal_articles
USING ivfflat (content_vector vector_cosine_ops)
WITH (lists = 100);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX la_fts_idx ON legal_articles
USING GIN (tsvector_content);
```

### 3.2 æ¡ˆä¾‹è¡¨

```sql
CREATE TABLE legal_cases (
    id SERIAL PRIMARY KEY,
    case_number TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    case_type TEXT,
    content_vector vector(512),
    tsvector_content tsvector,
    judgment_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX lc_vector_idx ON legal_cases
USING ivfflat (content_vector vector_cosine_ops)
WITH (lists = 100);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX lc_fts_idx ON legal_cases
USING GIN (tsvector_content);
```

## 4. æ£€ç´¢ç®¡ç†

### 4.1 æ³•æ¡æ£€ç´¢

```sql
-- æ··åˆæœç´¢ï¼šå‘é‡ + å…¨æ–‡æœç´¢
SELECT
    id,
    title,
    article_number,
    ts_rank(tsvector_content, query) AS text_rank,
    1 - (content_vector <=> $1::vector) AS vector_similarity,
    (ts_rank(tsvector_content, query) * 0.4 +
     1 - (content_vector <=> $1::vector) * 0.6) AS combined_score
FROM legal_articles, to_tsquery('chinese', $2) query
WHERE tsvector_content @@ query
    AND content_vector <=> $1::vector < 0.8
ORDER BY combined_score DESC
LIMIT 20;
```

### 4.2 æ¡ˆä¾‹æ£€ç´¢

```python
# æ¡ˆä¾‹æ£€ç´¢
class CaseRetrieval:
    async def search_cases(self, query_vector, query_text):
        """æ£€ç´¢æ¡ˆä¾‹"""
        # 1. æ··åˆæœç´¢
        cases = await self.db.fetch("""
            SELECT
                id,
                case_number,
                title,
                ts_rank(tsvector_content, query) AS text_rank,
                1 - (content_vector <=> $1::vector) AS vector_similarity,
                (ts_rank(tsvector_content, query) * 0.4 +
                 1 - (content_vector <=> $1::vector) * 0.6) AS combined_score
            FROM legal_cases, to_tsquery('chinese', $2) query
            WHERE tsvector_content @@ query
                AND content_vector <=> $1::vector < 0.8
            ORDER BY combined_score DESC
            LIMIT 20
        """, query_vector, query_text)

        return cases
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸæ³•å¾‹æœåŠ¡å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿï¼Œå¿«é€Ÿæ£€ç´¢æ³•æ¡å’Œæ¡ˆä¾‹ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ£€ç´¢å›°éš¾**: æ³•æ¡å’Œæ¡ˆä¾‹æ£€ç´¢å›°éš¾
2. **å‡†ç¡®ç‡ä½**: æ£€ç´¢å‡†ç¡®ç‡ä½
3. **æ•ˆç‡ä½**: æ£€ç´¢æ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ
class SmartLegalRetrievalSystem:
    def __init__(self):
        self.case_retrieval = CaseRetrieval()
        self.article_retrieval = ArticleRetrieval()

    async def search(self, query_text, search_type='both'):
        """æ£€ç´¢"""
        # 1. å‘é‡åŒ–æŸ¥è¯¢
        query_vector = await self.vectorize_query(query_text)

        # 2. æ£€ç´¢æ³•æ¡
        if search_type in ['articles', 'both']:
            articles = await self.article_retrieval.search_articles(
                query_vector, query_text
            )

        # 3. æ£€ç´¢æ¡ˆä¾‹
        if search_type in ['cases', 'both']:
            cases = await self.case_retrieval.search_cases(
                query_vector, query_text
            )

        # 4. æ¨èç›¸å…³æ³•æ¡å’Œæ¡ˆä¾‹
        if search_type == 'both':
            recommendations = await self.recommend_related(
                articles, cases
            )

        return {
            'articles': articles if search_type in ['articles', 'both'] else [],
            'cases': cases if search_type in ['cases', 'both'] else [],
            'recommendations': recommendations if search_type == 'both' else []
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **æ£€ç´¢å‡†ç¡®ç‡** | åŸºå‡† | **+62%** | **æå‡** |
| **æ£€ç´¢æ•ˆç‡** | åŸºå‡† | **+55%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 2 ç§’ | **< 180ms** | **91%** â¬‡ï¸ |
| **ç”¨æˆ·æ»¡æ„åº¦** | åŸºå‡† | **+52%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**æ³•å¾‹æ£€ç´¢æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å‡†ç¡®ç‡ | æ•ˆç‡ | ç”¨æˆ·æ»¡æ„åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- |
| **å…³é”®è¯æ£€ç´¢** | 50-60% | ä½ | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **å…¨æ–‡æœç´¢** | 65-75% | ä¸­ | ä¸­ | ä½ | ä¸­ç­‰åœºæ™¯ |
| **å‘é‡æœç´¢** | 80-85% | é«˜ | é«˜ | ä¸­ | å¤æ‚åœºæ™¯ |
| **æ··åˆæœç´¢** | **85-95%** | **é«˜** | **é«˜** | **ä¸­** | **å¤æ‚åœºæ™¯** |

**æ£€ç´¢ç®—æ³•å¯¹æ¯”**:

| æ£€ç´¢ç®—æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **å…³é”®è¯åŒ¹é…** | 50-60% | é«˜ | ä½ | ç®€å•åœºæ™¯ |
| **å…¨æ–‡æœç´¢** | 65-75% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **å‘é‡æ£€ç´¢** | 80-90% | é«˜ | é«˜ | å¤æ‚åœºæ™¯ |
| **æ··åˆæ£€ç´¢** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ³•æ¡æ£€ç´¢

1. **å‘é‡è´¨é‡**: ç¡®ä¿æ³•æ¡å‘é‡è´¨é‡
2. **æ··åˆæœç´¢**: ç»“åˆå‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢
3. **æŒç»­ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–æ£€ç´¢ç®—æ³•

### 6.2 æ¡ˆä¾‹æ£€ç´¢

1. **ç‰¹å¾æå–**: å‡†ç¡®æå–æ¡ˆä¾‹ç‰¹å¾
2. **ç›¸ä¼¼åº¦åŒ¹é…**: ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦åŒ¹é…
3. **ç»“æœæ’åº**: åˆç†æ’åºæ£€ç´¢ç»“æœ

## 7. å‚è€ƒèµ„æ–™

- [å…¨æ–‡æœç´¢](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/å…¨æ–‡æœç´¢å®Œæ•´å®æˆ˜æŒ‡å—.md) - å…¨æ–‡æœç´¢è¯¦è§£
- [å•†å“æ··åˆæœç´¢æ¡ˆä¾‹](../ç”µå•†åœºæ™¯/å•†å“æ··åˆæœç´¢æ¡ˆä¾‹.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 æ³•å¾‹æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºæ³•æ¡è¡¨
CREATE TABLE legal_articles (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    law_type TEXT,  -- 'constitution', 'civil', 'criminal', etc.
    article_number TEXT,
    content_vector vector(512),  -- æ³•æ¡å†…å®¹å‘é‡
    tsvector_content tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    effective_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºæ¡ˆä¾‹è¡¨
CREATE TABLE legal_cases (
    id SERIAL PRIMARY KEY,
    case_number TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    case_type TEXT,  -- 'civil', 'criminal', 'administrative', etc.
    content_vector vector(512),  -- æ¡ˆä¾‹å†…å®¹å‘é‡
    tsvector_content tsvector,  -- å…¨æ–‡æœç´¢å‘é‡
    judgment_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºtsvectorè§¦å‘å™¨å‡½æ•°ï¼ˆè‡ªåŠ¨æ›´æ–°å…¨æ–‡æœç´¢å‘é‡ï¼‰
CREATE OR REPLACE FUNCTION update_legal_cases_tsvector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.tsvector_content := to_tsvector('simple', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.content, ''));
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_update_legal_cases_tsvector
    BEFORE INSERT OR UPDATE ON legal_cases
    FOR EACH ROW
    EXECUTE FUNCTION update_legal_cases_tsvector();

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_legal_articles_vector ON legal_articles USING hnsw (content_vector vector_cosine_ops);
CREATE INDEX idx_legal_cases_vector ON legal_cases USING hnsw (content_vector vector_cosine_ops);
-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_legal_articles_fts ON legal_articles USING GIN (tsvector_content);
CREATE INDEX idx_legal_cases_fts ON legal_cases USING GIN (tsvector_content);
```

### 8.2 æ³•å¾‹æ£€ç´¢å®ç°

**Pythonæ³•å¾‹æ£€ç´¢**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import List, Dict, Optional
from datetime import date

class LegalSearchService:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ³•å¾‹æ£€ç´¢æœåŠ¡"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def search_articles(self, query_text: str, query_vector: List[float],
                       law_type: Optional[str] = None, limit: int = 20) -> List[Dict]:
        """æ£€ç´¢æ³•æ¡ï¼ˆæ··åˆæœç´¢ï¼‰"""
        if law_type:
            self.cur.execute("""
                SELECT
                    id, title, content, law_type, article_number,
                    ts_rank(tsvector_content, query) AS text_rank,
                    1 - (content_vector <=> %s) AS vector_similarity,
                    (ts_rank(tsvector_content, query) * 0.4 +
                     1 - (content_vector <=> %s) * 0.6) AS combined_score
                FROM legal_articles, to_tsquery('simple', %s) query
                WHERE tsvector_content @@ query
                  AND content_vector <=> %s < 0.7
                  AND law_type = %s
                ORDER BY combined_score DESC
                LIMIT %s
            """, (query_vector, query_vector, query_text, query_vector, law_type, limit))
        else:
            self.cur.execute("""
                SELECT
                    id, title, content, law_type, article_number,
                    ts_rank(tsvector_content, query) AS text_rank,
                    1 - (content_vector <=> %s) AS vector_similarity,
                    (ts_rank(tsvector_content, query) * 0.4 +
                     1 - (content_vector <=> %s) * 0.6) AS combined_score
                FROM legal_articles, to_tsquery('simple', %s) query
                WHERE tsvector_content @@ query
                  AND content_vector <=> %s < 0.7
                ORDER BY combined_score DESC
                LIMIT %s
            """, (query_vector, query_vector, query_text, query_vector, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'title': row[1],
                'content': row[2],
                'law_type': row[3],
                'article_number': row[4],
                'text_rank': float(row[5]),
                'vector_similarity': float(row[6]),
                'combined_score': float(row[7])
            })

        return results

    def search_cases(self, query_text: str, query_vector: List[float],
                    case_type: Optional[str] = None, limit: int = 20) -> List[Dict]:
        """æ£€ç´¢æ¡ˆä¾‹"""
        if case_type:
            self.cur.execute("""
                SELECT
                    id, case_number, title, content, case_type,
                    1 - (content_vector <=> %s) AS similarity
                FROM legal_cases
                WHERE content_vector <=> %s < 0.7
                  AND case_type = %s
                ORDER BY content_vector <=> %s
                LIMIT %s
            """, (query_vector, query_vector, case_type, query_vector, limit))
        else:
            self.cur.execute("""
                SELECT
                    id, case_number, title, content, case_type,
                    1 - (content_vector <=> %s) AS similarity
                FROM legal_cases
                WHERE content_vector <=> %s < 0.7
                ORDER BY content_vector <=> %s
                LIMIT %s
            """, (query_vector, query_vector, query_vector, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'case_number': row[1],
                'title': row[2],
                'content': row[3],
                'case_type': row[4],
                'similarity': float(row[5])
            })

        return results

    def insert_article(self, title: str, content: str, law_type: str,
                      article_number: str, content_vector: List[float],
                      effective_date: Optional[date] = None) -> int:
        """æ’å…¥æ³•æ¡"""
        self.cur.execute("""
            INSERT INTO legal_articles
            (title, content, law_type, article_number, content_vector, effective_date)
            VALUES (%s, %s, %s, %s, %s, %s)
            RETURNING id
        """, (title, content, law_type, article_number, content_vector, effective_date))

        article_id = self.cur.fetchone()[0]
        self.conn.commit()
        return article_id

    def insert_case(self, case_number: str, title: str, content: str,
                   case_type: str, content_vector: List[float],
                   judgment_date: Optional[date] = None) -> int:
        """æ’å…¥æ¡ˆä¾‹"""
        self.cur.execute("""
            INSERT INTO legal_cases
            (case_number, title, content, case_type, content_vector, judgment_date)
            VALUES (%s, %s, %s, %s, %s, %s)
            RETURNING id
        """, (case_number, title, content, case_type, content_vector, judgment_date))

        case_id = self.cur.fetchone()[0]
        self.conn.commit()
        return case_id

# ä½¿ç”¨ç¤ºä¾‹
service = LegalSearchService("host=localhost dbname=testdb user=postgres password=secret")

# ç¤ºä¾‹1ï¼šæ’å…¥æ³•æ¡
# query_vector = get_embedding("åˆåŒè¿çº¦")  # å‡è®¾æœ‰è·å–å‘é‡çš„å‡½æ•°
# article_id = service.insert_article(
#     title="åˆåŒæ³•ç¬¬ä¸€ç™¾é›¶ä¸ƒæ¡",
#     content="å½“äº‹äººä¸€æ–¹ä¸å±¥è¡ŒåˆåŒä¹‰åŠ¡æˆ–è€…å±¥è¡ŒåˆåŒä¹‰åŠ¡ä¸ç¬¦åˆçº¦å®šçš„ï¼Œåº”å½“æ‰¿æ‹…ç»§ç»­å±¥è¡Œã€é‡‡å–è¡¥æ•‘æªæ–½æˆ–è€…èµ”å¿æŸå¤±ç­‰è¿çº¦è´£ä»»ã€‚",
#     law_type="civil",
#     article_number="107",
#     content_vector=query_vector,
#     effective_date=date(1999, 10, 1)
# )

# ç¤ºä¾‹2ï¼šæ£€ç´¢æ³•æ¡ï¼ˆæ··åˆæœç´¢ï¼‰
# query_vector = get_embedding("åˆåŒè¿çº¦")  # å‡è®¾æœ‰è·å–å‘é‡çš„å‡½æ•°
# articles = service.search_articles("åˆåŒè¿çº¦", query_vector, limit=20)
# for article in articles:
#     print(f"{article['law_type']} Article {article['article_number']}: {article['title']}")
#     print(f"  ç›¸ä¼¼åº¦: {article['vector_similarity']:.3f}, ç»¼åˆå¾—åˆ†: {article['combined_score']:.3f}")

# ç¤ºä¾‹3ï¼šæ£€ç´¢æ¡ˆä¾‹
# cases = service.search_cases("åˆåŒè¿çº¦", query_vector, limit=20)
# for case in cases:
#     print(f"{case['case_type']} Case {case['case_number']}: {case['title']}")
#     print(f"  ç›¸ä¼¼åº¦: {case['similarity']:.3f}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-45-01
