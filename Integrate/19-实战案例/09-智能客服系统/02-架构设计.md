---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\09-æ™ºèƒ½å®¢æœç³»ç»Ÿ\02-æ¶æ„è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿](../æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿.md) - é€šç”¨æ¡ˆä¾‹æ–‡æ¡£æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºæ™ºèƒ½å®¢æœç³»ç»Ÿçš„æ¶æ„è®¾è®¡å‚è€ƒã€‚

---

# æ¡ˆä¾‹9ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ - æ¶æ„è®¾è®¡

## æ€»ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ™ºèƒ½å®¢æœç³»ç»Ÿæ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  [ç”¨æˆ·] â†’ [å¯¹è¯API] â†’ [æ„å›¾è¯†åˆ«]              â”‚
â”‚                â”‚            â”‚               â”‚
â”‚                â†“            â†“                â”‚
â”‚         [RAGæ£€ç´¢] â†’ [LLM] â†’ [ç­”æ¡ˆ]            â”‚
â”‚                â”‚                             â”‚
â”‚         [PostgreSQL 18]                      â”‚
â”‚          â”œâ”€ pgvector (FAQ)                   â”‚
â”‚          â”œâ”€ å¯¹è¯å†å²                          â”‚
â”‚          â””â”€ å·¥å•ç³»ç»Ÿ                          â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—

### 1. å‘é‡æ£€ç´¢

```python
# è¯­ä¹‰æ£€ç´¢Top-K
SELECT
    faq_id,
    question,
    answer,
    1 - (embedding <-> query_vec) AS similarity
FROM faqs
ORDER BY embedding <-> query_vec
LIMIT 5;
```

### 2. å¯¹è¯ä¸Šä¸‹æ–‡

```python
# æœ€è¿‘Nè½®å¯¹è¯
SELECT * FROM conversations
WHERE session_id = ?
ORDER BY created_at DESC
LIMIT 10;
```

### 3. LLMç”Ÿæˆ

```python
context = retrieve_faqs(question)
history = get_conversation_history(session_id)

prompt = f"""
ä¸Šä¸‹æ–‡: {context}
å†å²: {history}
é—®é¢˜: {question}

å›ç­”:
"""

answer = llm.generate(prompt)
```

---

---

## 4. è¯¦ç»†æ¶æ„ç»„ä»¶

### 4.1 å¯¹è¯ç®¡ç†æœåŠ¡

**å¯¹è¯ç®¡ç†æœåŠ¡è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
"""
å¯¹è¯ç®¡ç†æœåŠ¡
æŠ€æœ¯æ ˆ: FastAPI + PostgreSQL 18 + pgvector
"""

from fastapi import FastAPI, Query
from typing import Optional, List
import psycopg2
from psycopg2.extras import RealDictCursor
import numpy as np

app = FastAPI()

class ConversationService:
    """å¯¹è¯ç®¡ç†æœåŠ¡"""

    def __init__(self, conn_str):
        self.conn = psycopg2.connect(conn_str, cursor_factory=RealDictCursor)
        self.cursor = self.conn.cursor()

    def create_session(self, user_id: int):
        """åˆ›å»ºå¯¹è¯ä¼šè¯"""

        self.cursor.execute("""
            INSERT INTO conversation_sessions (user_id, created_at)
            VALUES (%s, NOW())
            RETURNING session_id
        """, (user_id,))

        session_id = self.cursor.fetchone()['session_id']
        self.conn.commit()

        return {'session_id': session_id, 'user_id': user_id}

    def add_message(
        self,
        session_id: int,
        role: str,
        content: str,
        embedding: Optional[List[float]] = None
    ):
        """æ·»åŠ å¯¹è¯æ¶ˆæ¯"""

        self.cursor.execute("""
            INSERT INTO conversation_messages (
                session_id, role, content, embedding, created_at
            )
            VALUES (%s, %s, %s, %s::vector, NOW())
            RETURNING message_id
        """, (session_id, role, content, str(embedding) if embedding else None))

        message_id = self.cursor.fetchone()['message_id']
        self.conn.commit()

        return {'message_id': message_id, 'session_id': session_id}

    def get_conversation_history(self, session_id: int, limit: int = 10):
        """è·å–å¯¹è¯å†å²"""

        self.cursor.execute("""
            SELECT message_id, role, content, created_at
            FROM conversation_messages
            WHERE session_id = %s
            ORDER BY created_at DESC
            LIMIT %s
        """, (session_id, limit))

        messages = self.cursor.fetchall()
        return [dict(msg) for msg in reversed(messages)]

# APIæ¥å£
conversation_service = ConversationService("dbname=customer_service_db user=postgres")

@app.post("/api/conversation/session")
async def create_session(user_id: int):
    """åˆ›å»ºä¼šè¯æ¥å£"""
    return conversation_service.create_session(user_id)

@app.post("/api/conversation/message")
async def add_message(
    session_id: int,
    role: str,
    content: str,
    embedding: Optional[List[float]] = None
):
    """æ·»åŠ æ¶ˆæ¯æ¥å£"""
    return conversation_service.add_message(session_id, role, content, embedding)

@app.get("/api/conversation/{session_id}/history")
async def get_history(session_id: int, limit: int = 10):
    """è·å–å†å²æ¥å£"""
    return conversation_service.get_conversation_history(session_id, limit)
```

### 4.2 FAQæ£€ç´¢æœåŠ¡

**FAQæ£€ç´¢æœåŠ¡è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- FAQæ£€ç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION search_faqs(
    p_query_vector vector(1536),
    p_limit INT DEFAULT 5,
    p_threshold NUMERIC DEFAULT 0.7
)
RETURNS TABLE (
    faq_id BIGINT,
    question TEXT,
    answer TEXT,
    similarity NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        f.faq_id,
        f.question,
        f.answer,
        (1 - (f.embedding <=> p_query_vector))::NUMERIC AS similarity
    FROM faqs f
    WHERE 1 - (f.embedding <=> p_query_vector) >= p_threshold
    ORDER BY f.embedding <=> p_query_vector
    LIMIT p_limit;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'FAQæ£€ç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. æ„å›¾è¯†åˆ«æ¨¡å—

### 5.1 æ„å›¾åˆ†ç±»

**æ„å›¾åˆ†ç±»å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ„å›¾åˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS intent_categories (
    intent_id SERIAL PRIMARY KEY,
    intent_name TEXT UNIQUE NOT NULL,
    description TEXT,
    examples TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ„å›¾åˆ†ç±»å‡½æ•°
CREATE OR REPLACE FUNCTION classify_intent(
    p_query_text TEXT,
    p_query_vector vector(1536)
)
RETURNS TABLE (
    intent_id INT,
    intent_name TEXT,
    confidence NUMERIC
) AS $$
BEGIN
    -- ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦åŒ¹é…æ„å›¾
    RETURN QUERY
    SELECT
        ic.intent_id,
        ic.intent_name,
        (1 - (ic.embedding <=> p_query_vector))::NUMERIC AS confidence
    FROM intent_categories ic
    ORDER BY ic.embedding <=> p_query_vector
    LIMIT 1;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ„å›¾åˆ†ç±»å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. å·¥å•ç³»ç»Ÿé›†æˆ

### 6.1 å·¥å•åˆ›å»º

**å·¥å•åˆ›å»ºå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å·¥å•è¡¨
CREATE TABLE IF NOT EXISTS support_tickets (
    ticket_id SERIAL PRIMARY KEY,
    session_id INT REFERENCES conversation_sessions(session_id),
    user_id INT NOT NULL,
    subject TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'open',
    priority TEXT DEFAULT 'normal',
    assigned_to INT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å·¥å•åˆ›å»ºå‡½æ•°
CREATE OR REPLACE FUNCTION create_ticket(
    p_session_id INT,
    p_user_id INT,
    p_subject TEXT,
    p_description TEXT,
    p_priority TEXT DEFAULT 'normal'
)
RETURNS TABLE (
    ticket_id INT,
    status TEXT
) AS $$
DECLARE
    new_ticket_id INT;
BEGIN
    INSERT INTO support_tickets (
        session_id, user_id, subject, description, priority
    )
    VALUES (p_session_id, p_user_id, p_subject, p_description, p_priority)
    RETURNING ticket_id INTO new_ticket_id;

    RETURN QUERY SELECT new_ticket_id, 'open'::TEXT;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå·¥å•å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å‘é‡æ£€ç´¢ä¼˜åŒ–

**å‘é‡æ£€ç´¢ä¼˜åŒ–é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºHNSWç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_faqs_embedding
ON faqs USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
SET hnsw.ef_search = 100;  -- æé«˜å¬å›ç‡

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT faq_id, question, answer,
       1 - (embedding <=> %s::vector) AS similarity
FROM faqs
ORDER BY embedding <=> %s::vector
LIMIT 5;
```

---

## 8. ç›‘æ§ä¸è¯Šæ–­

### 8.1 å¯¹è¯è´¨é‡ç›‘æ§

**å¯¹è¯è´¨é‡ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å¯¹è¯è´¨é‡ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW v_conversation_quality AS
SELECT
    date_trunc('hour', created_at) AS hour,
    COUNT(*) AS conversation_count,
    COUNT(*) FILTER (WHERE resolved = TRUE) AS resolved_count,
    ROUND(AVG(message_count), 2) AS avg_messages_per_session,
    ROUND(AVG(EXTRACT(EPOCH FROM (ended_at - created_at))), 2) AS avg_duration_seconds,
    ROUND(COUNT(*) FILTER (WHERE resolved = TRUE) * 100.0 / COUNT(*), 2) AS resolution_rate
FROM conversation_sessions
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY date_trunc('hour', created_at)
ORDER BY hour DESC;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM v_conversation_quality;
```

---

**è¿”å›**: [æ¡ˆä¾‹9ä¸»é¡µ](./README.md)
