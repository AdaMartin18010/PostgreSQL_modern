---
> **📋 文档来源**: `DataBaseTheory\19-场景案例库\09-智能客服系统\01-需求分析.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 案例9：智能客服系统 - 需求分析

> **文档编号**: CASE-09-01
> **最后更新**: 2025年1月
> **技术版本**: PostgreSQL 18+ / pgvector 0.8.0+

## 📑 目录

- [案例9：智能客服系统 - 需求分析](#案例9智能客服系统---需求分析)
  - [📑 目录](#-目录)
  - [1. 业务背景](#1-业务背景)
    - [1.1 业务概述](#11-业务概述)
    - [1.2 业务价值](#12-业务价值)
  - [2. 核心需求](#2-核心需求)
    - [2.1 智能问答](#21-智能问答)
    - [2.2 知识库管理](#22-知识库管理)
    - [2.3 对话管理](#23-对话管理)
  - [3. 功能需求](#3-功能需求)
    - [3.1 对话管理功能](#31-对话管理功能)
    - [3.2 知识库功能](#32-知识库功能)
    - [3.3 RAG架构](#33-rag架构)
  - [4. 非功能需求](#4-非功能需求)
    - [4.1 性能要求](#41-性能要求)
    - [4.2 可用性要求](#42-可用性要求)
    - [4.3 可扩展性要求](#43-可扩展性要求)
  - [5. 技术需求](#5-技术需求)
    - [5.1 数据库需求](#51-数据库需求)
    - [5.2 AI能力需求](#52-ai能力需求)
    - [5.3 集成需求](#53-集成需求)
  - [6. 约束条件](#6-约束条件)
    - [6.1 技术约束](#61-技术约束)
    - [6.2 业务约束](#62-业务约束)
    - [6.3 合规约束](#63-合规约束)

---

## 1. 业务背景

### 1.1 业务概述

**AI驱动的智能客服系统**：

**核心功能**：

- ✅ 智能问答（基于知识库）
- ✅ 工单管理
- ✅ 知识库检索
- ✅ 多轮对话

**服务渠道**：

- Web端
- 移动App
- 微信小程序
- 电话系统（语音转文本）

**业务规模**：

- 1000+在线并发会话
- 日均10万+咨询量
- 7x24小时服务

### 1.2 业务价值

**价值目标**：

- ✅ 提升客服效率（减少人工客服50%+）
- ✅ 提升响应速度（<3秒响应）
- ✅ 提升用户满意度（>90%）
- ✅ 降低运营成本（减少60%+）

---

## 2. 核心需求

### 2.1 智能问答

**需求描述**：

- 基于知识库的智能问答
- 语义理解用户问题
- 返回准确答案
- 支持多轮对话

**关键指标**：

- 答案准确率 > 85%
- 响应时间 < 3秒
- 用户满意度 > 90%

### 2.2 知识库管理

**需求描述**：

- 知识库内容管理
- 知识库更新
- 知识库检索
- 知识库版本控制

**知识库类型**：

- FAQ（常见问题）
- 产品文档
- 操作手册
- 政策法规

### 2.3 对话管理

**需求描述**：

- 会话管理
- 对话历史
- 上下文理解
- 意图识别

**对话特性**：

- 多轮对话
- 上下文记忆
- 意图切换
- 情感分析

---

## 3. 功能需求

### 3.1 对话管理功能

**会话管理**：

```sql
-- 会话表设计（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'conversations') THEN
            CREATE TABLE conversations (
                id SERIAL PRIMARY KEY,
                user_id INT NOT NULL,
                session_id TEXT NOT NULL,
                started_at TIMESTAMPTZ DEFAULT NOW(),
                ended_at TIMESTAMPTZ,
                status TEXT DEFAULT 'active'
            );
            RAISE NOTICE '会话表 conversations 创建成功';
        ELSE
            RAISE NOTICE '会话表 conversations 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '会话表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建会话表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 对话历史表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'conversation_messages') THEN
            CREATE TABLE conversation_messages (
                id SERIAL PRIMARY KEY,
                conversation_id INT REFERENCES conversations(id),
                role TEXT NOT NULL,  -- 'user' or 'assistant'
                content TEXT NOT NULL,
                intent TEXT,
                sentiment_score DECIMAL(3, 2),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '对话历史表 conversation_messages 创建成功';
        ELSE
            RAISE NOTICE '对话历史表 conversation_messages 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '对话历史表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建对话历史表失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**用户信息**：

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    user_id TEXT UNIQUE NOT NULL,
    name TEXT,
    email TEXT,
    phone TEXT,
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**对话历史（上下文）**：

```sql
-- 获取对话历史（带错误处理和性能测试）
DO $$
DECLARE
    v_conversation_id INT := $1;  -- 示例：实际使用时从参数传入
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'conversation_messages') THEN
            RAISE WARNING '表 conversation_messages 不存在，无法获取对话历史';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM conversations WHERE id = v_conversation_id) THEN
            RAISE WARNING '会话 ID % 不存在', v_conversation_id;
            RETURN;
        END IF;

        RAISE NOTICE '开始获取对话历史，会话ID: %', v_conversation_id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '查询准备失败: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    role,
    content,
    created_at
FROM conversation_messages
WHERE conversation_id = $1
ORDER BY created_at ASC
LIMIT 20;  -- 最近20轮对话
```

**意图识别**：

```sql
-- 意图表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'intents') THEN
            CREATE TABLE intents (
                id SERIAL PRIMARY KEY,
                intent_name TEXT UNIQUE NOT NULL,
                description TEXT,
                examples TEXT[]
            );
            RAISE NOTICE '意图表 intents 创建成功';
        ELSE
            RAISE NOTICE '意图表 intents 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '意图表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建意图表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 意图识别（使用pg_ai，带错误处理）
DO $$
DECLARE
    v_user_message TEXT := '示例消息';  -- 实际使用时从参数传入
    v_intent TEXT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_ai') THEN
            RAISE WARNING 'pg_ai扩展未安装，无法使用意图识别';
            RETURN;
        END IF;

        IF v_user_message IS NULL OR v_user_message = '' THEN
            RAISE EXCEPTION '用户消息不能为空';
        END IF;

        SELECT ai.chat_complete(
            'gpt-4',
            'Classify intent: ' || v_user_message
        ) INTO v_intent;

        RAISE NOTICE '意图识别结果: %', v_intent;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '意图识别失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**情感分析**：

```sql
-- 情感分析（使用pg_ai，带错误处理）
DO $$
DECLARE
    v_user_message TEXT := '示例消息';  -- 实际使用时从参数传入
    v_sentiment_score DECIMAL(3, 2);
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_ai') THEN
            RAISE WARNING 'pg_ai扩展未安装，无法使用情感分析';
            RETURN;
        END IF;

        IF v_user_message IS NULL OR v_user_message = '' THEN
            RAISE EXCEPTION '用户消息不能为空';
        END IF;

        SELECT ai.chat_complete(
            'gpt-4',
            'Analyze sentiment (0-1): ' || v_user_message
        )::DECIMAL INTO v_sentiment_score;

        RAISE NOTICE '情感分析结果: %', v_sentiment_score;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '情感分析失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.2 知识库功能

**向量检索**：

**FAQ向量化**：

```sql
-- FAQ表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'faqs') THEN
            CREATE TABLE faqs (
                id SERIAL PRIMARY KEY,
                question TEXT NOT NULL,
                answer TEXT NOT NULL,
                category TEXT,
                embedding vector(768),  -- 768维向量
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'FAQ表 faqs 创建成功';
        ELSE
            RAISE NOTICE 'FAQ表 faqs 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'FAQ表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建FAQ表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 创建向量索引（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'faqs') THEN
            RAISE WARNING '表 faqs 不存在，无法创建向量索引';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE WARNING 'pgvector扩展未安装，无法创建向量索引';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'faqs' AND indexname LIKE '%embedding%') THEN
            CREATE INDEX ON faqs
            USING hnsw(embedding vector_cosine_ops)
            WITH (m = 16, ef_construction = 64);
            RAISE NOTICE '向量索引创建成功';
        ELSE
            RAISE NOTICE '向量索引已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '向量索引已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建向量索引失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**语义相似度匹配**：

```sql
-- 语义检索（带错误处理和性能测试）
DO $$
DECLARE
    v_query_text TEXT := $1;  -- 实际使用时从参数传入
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'faqs') THEN
            RAISE WARNING '表 faqs 不存在，无法执行语义检索';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_ai') THEN
            RAISE WARNING 'pg_ai扩展未安装，无法生成查询向量';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE WARNING 'pgvector扩展未安装，无法执行向量检索';
            RETURN;
        END IF;

        IF v_query_text IS NULL OR v_query_text = '' THEN
            RAISE EXCEPTION '查询文本不能为空';
        END IF;

        RAISE NOTICE '开始执行语义检索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '查询准备失败: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH query_vec AS (
    SELECT ai.embedding_openai('text-embedding-3-small', $1)::vector(768) AS vec
)
SELECT
    id,
    question,
    answer,
    1 - (embedding <=> query_vec.vec) AS similarity
FROM faqs, query_vec
WHERE embedding <=> query_vec.vec < 0.3
ORDER BY embedding <=> query_vec.vec
LIMIT 5;
```

**结构化知识**：

```sql
-- 产品文档表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'product_docs') THEN
            CREATE TABLE product_docs (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                category TEXT,
                version TEXT,
                embedding vector(768),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '产品文档表 product_docs 创建成功';
        ELSE
            RAISE NOTICE '产品文档表 product_docs 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '产品文档表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建产品文档表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 操作手册表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'manuals') THEN
            CREATE TABLE manuals (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                section TEXT,
                embedding vector(768),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '操作手册表 manuals 创建成功';
        ELSE
            RAISE NOTICE '操作手册表 manuals 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '操作手册表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建操作手册表失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 常见问题表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'common_questions') THEN
            CREATE TABLE common_questions (
                id SERIAL PRIMARY KEY,
                question TEXT NOT NULL,
                answer TEXT NOT NULL,
                category TEXT,
                frequency INT DEFAULT 0,
                embedding vector(768),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE '常见问题表 common_questions 创建成功';
        ELSE
            RAISE NOTICE '常见问题表 common_questions 已存在';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE '常见问题表已存在';
        WHEN OTHERS THEN
            RAISE WARNING '创建常见问题表失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.3 RAG架构

**RAG流程**：

```text
用户问题 → 向量检索（Top-K） → LLM生成答案
            ↓
      PostgreSQL + pgvector
```

**RAG实现**：

```sql
-- RAG检索函数（带完整错误处理）
CREATE OR REPLACE FUNCTION rag_retrieve(
    p_query TEXT,
    p_limit INT DEFAULT 5
)
RETURNS TABLE(content TEXT, similarity FLOAT) AS $$
DECLARE
    v_query_vec vector(768);
BEGIN
    BEGIN
        -- 参数验证
        IF p_query IS NULL OR p_query = '' THEN
            RAISE EXCEPTION '查询文本不能为空';
        END IF;

        IF p_limit IS NULL OR p_limit <= 0 OR p_limit > 100 THEN
            RAISE EXCEPTION 'limit参数必须在1-100之间';
        END IF;

        -- 检查扩展
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_ai') THEN
            RAISE EXCEPTION 'pg_ai扩展未安装，无法生成查询向量';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE EXCEPTION 'pgvector扩展未安装，无法执行向量检索';
        END IF;

        -- 检查表
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'faqs') THEN
            RAISE EXCEPTION '表 faqs 不存在';
        END IF;

        -- 生成查询向量
        SELECT ai.embedding_openai('text-embedding-3-small', p_query)::vector(768)
        INTO v_query_vec;

        IF v_query_vec IS NULL THEN
            RAISE EXCEPTION '生成查询向量失败';
        END IF;

        -- 检索相似内容
        RETURN QUERY
        SELECT
            faq.answer,
            1 - (faq.embedding <=> v_query_vec) AS similarity
        FROM faqs faq
        WHERE faq.embedding <=> v_query_vec < 0.3
        ORDER BY faq.embedding <=> v_query_vec
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'RAG检索失败: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

-- 使用RAG生成答案（带完整错误处理）
CREATE OR REPLACE FUNCTION generate_answer(
    p_query TEXT,
    p_conversation_history TEXT DEFAULT ''
)
RETURNS TEXT AS $$
DECLARE
    v_context TEXT;
    v_answer TEXT;
BEGIN
    BEGIN
        -- 参数验证
        IF p_query IS NULL OR p_query = '' THEN
            RAISE EXCEPTION '查询文本不能为空';
        END IF;

        -- 检查扩展
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_ai') THEN
            RAISE EXCEPTION 'pg_ai扩展未安装，无法使用LLM功能';
        END IF;

        -- 检索相关上下文
        SELECT string_agg(content, '\n\n')
        INTO v_context
        FROM rag_retrieve(p_query, 5);

        IF v_context IS NULL OR v_context = '' THEN
            RAISE WARNING '未找到相关上下文，将使用空上下文';
            v_context := 'No relevant context found.';
        END IF;

        -- 使用LLM生成答案
        SELECT ai.chat_complete(
            'gpt-4',
            format('Context:\n%s\n\nConversation History:\n%s\n\nQuestion: %s\n\nAnswer:',
                   v_context, COALESCE(p_conversation_history, ''), p_query)
        ) INTO v_answer;

        IF v_answer IS NULL OR v_answer = '' THEN
            RAISE EXCEPTION 'LLM生成答案失败';
        END IF;

        RETURN v_answer;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '生成答案失败: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. 非功能需求

### 4.1 性能要求

**性能指标**：

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **向量检索延迟** | <50ms | P95延迟 |
| **LLM响应时间** | <2s | 包含API调用 |
| **总响应时间** | <3s | 端到端延迟 |
| **并发会话** | 1000+ | 同时在线会话 |
| **QPS** | 500+ | 每秒查询数 |

**性能优化**：

- ✅ 向量索引优化（HNSW）
- ✅ 查询缓存
- ✅ 连接池
- ✅ LLM调用优化

### 4.2 可用性要求

**可用性指标**：

- 系统可用性 > 99.9%
- 故障恢复时间 < 5分钟
- 数据一致性 100%

**高可用架构**：

- 主从复制
- 自动故障转移
- 负载均衡

### 4.3 可扩展性要求

**扩展性指标**：

- 支持10万+知识条目
- 支持1000+并发会话
- 支持水平扩展

---

## 5. 技术需求

### 5.1 数据库需求

**PostgreSQL版本**：

- PostgreSQL 18+（推荐）
- pgvector 0.8.0+
- pg_ai扩展

**数据库功能**：

- 向量搜索
- 全文搜索
- JSONB支持
- 事务支持

### 5.2 AI能力需求

**LLM集成**：

- OpenAI GPT-4（答案生成）
- OpenAI text-embedding-3-small（向量化）
- 支持其他LLM（Claude、Gemini等）

**AI功能**：

- 自然语言理解
- 意图识别
- 情感分析
- 答案生成

### 5.3 集成需求

**外部系统集成**：

- 客服系统集成
- 工单系统集成
- 用户系统集成
- 监控系统集成

---

## 6. 约束条件

### 6.1 技术约束

**技术限制**：

- PostgreSQL版本 >= 15
- pgvector版本 >= 0.8.0
- LLM API可用性依赖

### 6.2 业务约束

**业务限制**：

- 成本控制（API调用成本）
- 响应时间要求
- 数据隐私要求

### 6.3 合规约束

**合规要求**：

- 数据隐私保护
- 数据安全
- 审计日志

---

**最后更新**: 2025年1月
**文档编号**: CASE-09-01
**维护者**: PostgreSQL Modern Team
**返回**: [案例9主页](./README.md)
