---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\06-ç”Ÿäº§éƒ¨ç½².md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - ç”Ÿäº§éƒ¨ç½²

## 1. éƒ¨ç½²æ¶æ„

### 1.1 ç”Ÿäº§ç¯å¢ƒæ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è´Ÿè½½å‡è¡¡å±‚                          â”‚
â”‚         HAProxy / Nginx                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ App-1  â”‚         â”‚ App-2  â”‚    åº”ç”¨å±‚ï¼ˆæ°´å¹³æ‰©å±•ï¼‰
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    pgBouncer      â”‚         è¿æ¥æ± å±‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Primary DB      â”‚         ä¸»æ•°æ®åº“
    â”‚  (Write + Read)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Replica1â”‚         â”‚Replica2â”‚    ä»æ•°æ®åº“ï¼ˆåªè¯»ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Kuberneteséƒ¨ç½²

### 2.1 StatefulSeté…ç½®

```yaml
# postgresql-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-saas
spec:
  serviceName: postgres-saas
  replicas: 3
  selector:
    matchLabels:
      app: postgres-saas
  template:
    metadata:
      labels:
        app: postgres-saas
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: POSTGRES_DB
          value: "saas_db"

        # PostgreSQL 18ä¼˜åŒ–é…ç½®
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF8 --locale=en_US.UTF-8"

        ports:
        - containerPort: 5432
          name: postgres

        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
        - name: config
          mountPath: /etc/postgresql

        resources:
          requests:
            memory: "8Gi"
            cpu: "2"
          limits:
            memory: "16Gi"
            cpu: "4"

        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 10

        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 5
          periodSeconds: 5

  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 500Gi
```

### 2.2 Serviceé…ç½®

```yaml
# postgresql-service.yaml
---
# ä¸»æœåŠ¡ï¼ˆè¯»å†™ï¼‰
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
spec:
  type: ClusterIP
  selector:
    app: postgres-saas
    role: primary
  ports:
  - port: 5432
    targetPort: 5432

---
# ä»æœåŠ¡ï¼ˆåªè¯»ï¼‰
apiVersion: v1
kind: Service
metadata:
  name: postgres-replica
spec:
  type: ClusterIP
  selector:
    app: postgres-saas
    role: replica
  ports:
  - port: 5432
    targetPort: 5432
```

---

## 3. Docker Composeéƒ¨ç½²

### 3.1 å®Œæ•´ç¼–æ’

```yaml
# docker-compose-saas.yml
version: '3.8'

services:
  postgres-primary:
    image: postgres:18
    container_name: saas-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: saas_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
      - ./configs/postgresql.conf:/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    networks:
      - saas-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-replica1:
    image: postgres:18
    container_name: saas-replica1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/replica
    volumes:
      - postgres_replica1_data:/var/lib/postgresql/data
      - ./recovery.conf:/var/lib/postgresql/data/recovery.conf
    ports:
      - "5433:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - saas-network

  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: saas-pgbouncer
    environment:
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@postgres-primary:5432/saas_db
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 5000
      DEFAULT_POOL_SIZE: 100
    ports:
      - "6432:5432"
    depends_on:
      - postgres-primary
    networks:
      - saas-network

  redis:
    image: redis:7-alpine
    container_name: saas-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - saas-network

  app:
    build: ./app
    container_name: saas-app
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@pgbouncer:5432/saas_db
      REDIS_URL: redis://redis:6379
    ports:
      - "8000:8000"
    depends_on:
      - pgbouncer
      - redis
    networks:
      - saas-network
    deploy:
      replicas: 3

networks:
  saas-network:
    driver: bridge

volumes:
  postgres_primary_data:
  postgres_replica1_data:
  redis_data:
```

---

## 4. åˆå§‹åŒ–è„šæœ¬

### 4.1 ç§Ÿæˆ·åˆå§‹åŒ–

```sql
-- init-tenant.sql
-- ä¸ºæ–°ç§Ÿæˆ·åˆå§‹åŒ–schemaå’Œæ•°æ®

CREATE OR REPLACE FUNCTION init_tenant(tenant_name TEXT)
RETURNS VOID AS $$
DECLARE
    tenant_schema TEXT;
BEGIN
    tenant_schema := 'tenant_' || tenant_name;

    -- åˆ›å»ºschema
    EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', tenant_schema);

    -- åˆ›å»ºè¡¨
    EXECUTE format('CREATE TABLE %I.users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(100),
        email VARCHAR(255),
        created_at TIMESTAMPTZ DEFAULT now()
    )', tenant_schema);

    EXECUTE format('CREATE TABLE %I.data (
        id BIGSERIAL PRIMARY KEY,
        user_id BIGINT,
        content JSONB,
        created_at TIMESTAMPTZ DEFAULT now()
    )', tenant_schema);

    -- åˆ›å»ºç´¢å¼•
    EXECUTE format('CREATE INDEX idx_%I_users_email ON %I.users(email)',
                   tenant_name, tenant_schema);
    EXECUTE format('CREATE INDEX idx_%I_data_user ON %I.data(user_id)',
                   tenant_name, tenant_schema);

    -- åˆ›å»ºè§’è‰²
    EXECUTE format('CREATE ROLE %I LOGIN PASSWORD %L',
                   tenant_name, md5(random()::TEXT));
    EXECUTE format('GRANT USAGE ON SCHEMA %I TO %I',
                   tenant_schema, tenant_name);
    EXECUTE format('GRANT ALL ON ALL TABLES IN SCHEMA %I TO %I',
                   tenant_schema, tenant_name);

    RAISE NOTICE 'ç§Ÿæˆ· % åˆå§‹åŒ–å®Œæˆ', tenant_name;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨
SELECT init_tenant('company_abc');
SELECT init_tenant('company_xyz');
```

---

## 5. ç›‘æ§é…ç½®

### 5.1 Prometheusé…ç½®

```yaml
# prometheus-saas.yml
scrape_configs:
  - job_name: 'postgresql-saas'
    static_configs:
      - targets: ['postgres-exporter:9187']
    metrics_path: /metrics
    scrape_interval: 15s

    relabel_configs:
      # ç§Ÿæˆ·çº§åˆ«ç›‘æ§
      - source_labels: [tenant_id]
        target_label: tenant

  - job_name: 'app-metrics'
    static_configs:
      - targets: ['app:8000']
    metrics_path: /metrics
```

### 5.2 ç§Ÿæˆ·çº§åˆ«å‘Šè­¦

```yaml
# alerts-saas.yml
groups:
  - name: tenant_alerts
    rules:
      # ç§Ÿæˆ·è¿æ¥æ•°è¿‡å¤š
      - alert: TenantConnectionsHigh
        expr: |
          pg_stat_activity_count{tenant="{{$labels.tenant}}"} > 100
        for: 5m
        annotations:
          summary: "ç§Ÿæˆ·{{ $labels.tenant }}è¿æ¥æ•°è¿‡å¤š"

      # ç§Ÿæˆ·å­˜å‚¨è¶…é™
      - alert: TenantStorageLimit
        expr: |
          pg_database_size_bytes{tenant="{{$labels.tenant}}"} > 10*1024*1024*1024
        for: 10m
        annotations:
          summary: "ç§Ÿæˆ·{{ $labels.tenant }}å­˜å‚¨è¶…è¿‡10GB"

      # ç§Ÿæˆ·æŸ¥è¯¢æ€§èƒ½ä¸‹é™
      - alert: TenantQuerySlow
        expr: |
          rate(pg_stat_statements_mean_exec_time_seconds{tenant="{{$labels.tenant}}"}[5m]) > 1
        for: 10m
        annotations:
          summary: "ç§Ÿæˆ·{{ $labels.tenant }}æŸ¥è¯¢å˜æ…¢"
```

---

## 6. å¤‡ä»½ç­–ç•¥

### 6.1 ç§Ÿæˆ·çº§åˆ«å¤‡ä»½

```bash
#!/bin/bash
# backup-tenant.sh - å¤‡ä»½å•ä¸ªç§Ÿæˆ·

TENANT_NAME=$1
BACKUP_DIR=/backup/tenants

if [ -z "$TENANT_NAME" ]; then
    echo "ç”¨æ³•: $0 <tenant_name>"
    exit 1
fi

SCHEMA="tenant_${TENANT_NAME}"
BACKUP_FILE="${BACKUP_DIR}/${TENANT_NAME}_$(date +%Y%m%d_%H%M%S).dump"

# å¤‡ä»½ç§Ÿæˆ·schema
pg_dump \
    -h localhost \
    -U postgres \
    -n $SCHEMA \
    -Fc \
    -f $BACKUP_FILE \
    saas_db

echo "ç§Ÿæˆ· $TENANT_NAME å¤‡ä»½å®Œæˆ: $BACKUP_FILE"

# ä¿ç•™æœ€è¿‘30å¤©å¤‡ä»½
find $BACKUP_DIR -name "${TENANT_NAME}_*.dump" -mtime +30 -delete
```

### 6.2 å®šæ—¶å¤‡ä»½

```bash
# crontab
# æ¯æ—¥å‡Œæ™¨2ç‚¹å¤‡ä»½æ‰€æœ‰ç§Ÿæˆ·
0 2 * * * /scripts/backup-all-tenants.sh

# æ¯å‘¨æ—¥å¤‡ä»½æ•´ä¸ªæ•°æ®åº“
0 3 * * 0 pg_dump -Fc saas_db > /backup/full_$(date +\%Y\%m\%d).dump
```

---

## 7. æ‰©å®¹ç­–ç•¥

### 7.1 å‚ç›´æ‰©å®¹

```bash
# å¢åŠ èµ„æºé…ç½®
# kubernetes
kubectl edit statefulset postgres-saas

# ä¿®æ”¹resources
resources:
  requests:
    memory: "16Gi"  # 8Gi â†’ 16Gi
    cpu: "4"        # 2 â†’ 4
  limits:
    memory: "32Gi"  # 16Gi â†’ 32Gi
    cpu: "8"        # 4 â†’ 8

# æ»šåŠ¨æ›´æ–°
kubectl rollout status statefulset/postgres-saas
```

### 7.2 æ°´å¹³æ‰©å®¹ï¼ˆæ·»åŠ åªè¯»å‰¯æœ¬ï¼‰

```bash
# å¢åŠ replicaæ•°é‡
kubectl scale statefulset postgres-saas --replicas=5

# é…ç½®è¯»è´Ÿè½½å‡è¡¡
# HAProxyé…ç½®è¯»å†™åˆ†ç¦»
```

---

## 8. ç¾éš¾æ¢å¤

### 8.1 ç§Ÿæˆ·æ¢å¤

```bash
#!/bin/bash
# restore-tenant.sh - æ¢å¤å•ä¸ªç§Ÿæˆ·

TENANT_NAME=$1
BACKUP_FILE=$2

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <tenant_name> <backup_file>"
    exit 1
fi

SCHEMA="tenant_${TENANT_NAME}"

# 1. åˆ é™¤æ—§schemaï¼ˆè°¨æ…ï¼ï¼‰
psql -c "DROP SCHEMA IF EXISTS $SCHEMA CASCADE;"

# 2. æ¢å¤å¤‡ä»½
pg_restore -n $SCHEMA -d saas_db $BACKUP_FILE

# 3. éªŒè¯
psql -c "SELECT COUNT(*) FROM ${SCHEMA}.users;"

echo "ç§Ÿæˆ· $TENANT_NAME æ¢å¤å®Œæˆ"
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 è¿æ¥æ± é…ç½®

```ini
# pgbouncer.ini - SaaSä¼˜åŒ–é…ç½®
[databases]
saas_db = host=postgres-primary port=5432 dbname=saas_db

[pgbouncer]
listen_addr = *
listen_port = 6432
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

# è¿æ¥æ± é…ç½®
pool_mode = transaction
max_client_conn = 5000
default_pool_size = 100
reserve_pool_size = 20
reserve_pool_timeout = 5

# è¶…æ—¶é…ç½®
server_idle_timeout = 600
server_lifetime = 3600
query_timeout = 120

# æ—¥å¿—
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
```

### 9.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ç§Ÿæˆ·æŸ¥è¯¢ä¼˜åŒ–
-- 1. ç¡®ä¿tenant_idæœ‰ç´¢å¼•
CREATE INDEX idx_users_tenant ON users(tenant_id);
CREATE INDEX idx_data_tenant ON data(tenant_id);

-- 2. åˆ†åŒºè¡¨ï¼ˆæŒ‰ç§Ÿæˆ·ï¼‰
CREATE TABLE data_partitioned (
    id BIGSERIAL,
    tenant_id INT NOT NULL,
    content JSONB,
    created_at TIMESTAMPTZ
) PARTITION BY HASH (tenant_id);

-- åˆ›å»º32ä¸ªåˆ†åŒº
DO $$
BEGIN
    FOR i IN 0..31 LOOP
        EXECUTE format('CREATE TABLE data_part_%s PARTITION OF data_partitioned FOR VALUES WITH (MODULUS 32, REMAINDER %s)', i, i);
    END LOOP;
END $$;
```

---

## 10. æˆæœ¬ä¼˜åŒ–

### 10.1 å­˜å‚¨åˆ†å±‚

```sql
-- çƒ­æ•°æ®ï¼ˆSSDï¼Œè¿‘3ä¸ªæœˆï¼‰
CREATE TABLESPACE hot_data
    LOCATION '/mnt/ssd/pgdata';

-- æ¸©æ•°æ®ï¼ˆSSDï¼Œ3-12ä¸ªæœˆï¼‰
CREATE TABLESPACE warm_data
    LOCATION '/mnt/ssd2/pgdata';

-- å†·æ•°æ®ï¼ˆHDDï¼Œ12ä¸ªæœˆå‰ï¼‰
CREATE TABLESPACE cold_data
    LOCATION '/mnt/hdd/pgdata';

-- è‡ªåŠ¨åˆ†å±‚ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
-- æ¯æœˆ1æ—¥æ‰§è¡Œ
DO $$
DECLARE
    tenant_rec RECORD;
BEGIN
    FOR tenant_rec IN
        SELECT DISTINCT tenant_id FROM users
    LOOP
        -- ç§»åŠ¨å†·æ•°æ®åˆ°HDD
        EXECUTE format('ALTER TABLE tenant_%s.data_archive SET TABLESPACE cold_data', tenant_rec.tenant_id);
    END LOOP;
END $$;
```

---

## 11. å®‰å…¨åŠ å›º

### 11.1 ç§Ÿæˆ·éš”ç¦»éªŒè¯

```python
def test_tenant_isolation():
    """æµ‹è¯•ç§Ÿæˆ·éš”ç¦»"""

    # ç§Ÿæˆ·Aè¿æ¥
    conn_a = psycopg2.connect(
        "dbname=saas_db user=tenant_a password=xxx"
    )
    cursor_a = conn_a.cursor()

    # è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
    cursor_a.execute("SET app.tenant_id = 1")

    # å°è¯•è®¿é—®ç§Ÿæˆ·Bçš„æ•°æ®
    try:
        cursor_a.execute("SELECT * FROM users WHERE tenant_id = 2")
        results = cursor_a.fetchall()

        if len(results) > 0:
            print("âŒ ç§Ÿæˆ·éš”ç¦»å¤±è´¥ï¼ç§Ÿæˆ·Aå¯ä»¥è®¿é—®ç§Ÿæˆ·Bæ•°æ®")
            return False
        else:
            print("âœ… ç§Ÿæˆ·éš”ç¦»æ­£å¸¸")
            return True

    except Exception as e:
        print(f"âœ… ç§Ÿæˆ·éš”ç¦»æ­£å¸¸ï¼ˆç­–ç•¥é˜»æ­¢ï¼‰: {e}")
        return True
```

---

## 12. éƒ¨ç½²æ£€æŸ¥æ¸…å•

```text
éƒ¨ç½²å‰æ£€æŸ¥:
â–¡ é…ç½®æ–‡ä»¶å®¡æ ¸
  â–¡ postgresql.confä¼˜åŒ–
  â–¡ pg_hba.confå®‰å…¨é…ç½®
  â–¡ pgbouncer.iniè¿æ¥æ± é…ç½®

â–¡ ç½‘ç»œé…ç½®
  â–¡ é˜²ç«å¢™è§„åˆ™
  â–¡ è´Ÿè½½å‡è¡¡é…ç½®
  â–¡ SSLè¯ä¹¦é…ç½®

â–¡ èµ„æºé…ç½®
  â–¡ CPU/å†…å­˜å……è¶³
  â–¡ å­˜å‚¨å®¹é‡è§„åˆ’
  â–¡ IOPSæ€§èƒ½æ»¡è¶³

â–¡ é«˜å¯ç”¨é…ç½®
  â–¡ ä¸»ä»å¤åˆ¶é…ç½®
  â–¡ æ•…éšœè½¬ç§»æµ‹è¯•
  â–¡ å¤‡ä»½ç­–ç•¥é…ç½®

â–¡ ç›‘æ§å‘Šè­¦
  â–¡ Prometheusé…ç½®
  â–¡ Grafanaä»ªè¡¨æ¿
  â–¡ å‘Šè­¦è§„åˆ™é…ç½®
  â–¡ é€šçŸ¥æ¸ é“é…ç½®

â–¡ å®‰å…¨æ£€æŸ¥
  â–¡ å¯†ç å¼ºåº¦
  â–¡ æƒé™æœ€å°åŒ–
  â–¡ RLSç­–ç•¥æµ‹è¯•
  â–¡ ç§Ÿæˆ·éš”ç¦»éªŒè¯

â–¡ æ€§èƒ½æµ‹è¯•
  â–¡ åŸºå‡†æµ‹è¯•
  â–¡ å‹åŠ›æµ‹è¯•
  â–¡ æ•…éšœæ¢å¤æµ‹è¯•
```

---

**å®Œæˆ**: å¤šç§Ÿæˆ·SaaSç³»ç»Ÿç”Ÿäº§éƒ¨ç½²
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: éƒ¨ç½²æ¶æ„ã€Kubernetesã€Dockerã€åˆå§‹åŒ–ã€ç›‘æ§ã€å¤‡ä»½ã€æ‰©å®¹ã€ç¾éš¾æ¢å¤ã€æ€§èƒ½ä¼˜åŒ–ã€æˆæœ¬ä¼˜åŒ–ã€å®‰å…¨åŠ å›ºã€æ£€æŸ¥æ¸…å•
