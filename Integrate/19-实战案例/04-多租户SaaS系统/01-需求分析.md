---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - éœ€æ±‚åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **ç§Ÿæˆ·æ•°**: 1000+

---

## ä¸€ã€ä¸šåŠ¡èƒŒæ™¯

### å…¸å‹åœºæ™¯

**ä¼ä¸šçº§SaaSå¹³å°**ï¼ˆCRM/ERP/åä½œå·¥å…·ï¼‰

- **ç§Ÿæˆ·æ•°é‡**: 1000+ä¼ä¸šå®¢æˆ·
- **ç”¨æˆ·æ•°**: 50ä¸‡+ï¼ˆå¹³å‡æ¯ç§Ÿæˆ·500ç”¨æˆ·ï¼‰
- **æ•°æ®éš”ç¦»**: ä¸¥æ ¼éš”ç¦»ï¼Œäº’ä¸å¯è§
- **ç§Ÿæˆ·é…é¢**: ä¸åŒå¥—é¤ä¸åŒé…é¢

---

## äºŒã€æ•°æ®éš”ç¦»æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éš”ç¦»æ€§ | æ€§èƒ½ | æˆæœ¬ | ç»´æŠ¤ |
| --- | --- | --- | --- | --- |
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | â­â­ | â­ | â­ |
| **ç‹¬ç«‹Schema** | â­â­â­â­ | â­â­â­ | â­â­ | â­â­ |
| **å…±äº«è¡¨+RLS** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

**æ¨è**: å…±äº«è¡¨+RLSï¼ˆæ€§èƒ½æœ€ä¼˜ï¼Œæˆæœ¬æœ€ä½ï¼‰

---

## ä¸‰ã€æ ¸å¿ƒè®¾è®¡

### RLSç­–ç•¥è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    username VARCHAR(100),
    email VARCHAR(200),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¯ç”¨RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ç§Ÿæˆ·éš”ç¦»ç­–ç•¥
CREATE POLICY tenant_isolation ON users
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- â­ PostgreSQL 18ï¼šRLSæ€§èƒ½ä¼˜åŒ–
-- ç­–ç•¥ä¸‹æ¨+ç¼“å­˜ï¼ŒæŸ¥è¯¢æ—¶é—´é™ä½30-60%
```

### ä½¿ç”¨æ–¹å¼

```sql
-- è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.tenant_id = 1001;

-- æŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¿‡æ»¤ï¼‰
SELECT * FROM users;
-- åªè¿”å›tenant_id=1001çš„æ•°æ®

-- æ’å…¥ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
CREATE POLICY tenant_insert ON users
    FOR INSERT
    WITH CHECK (tenant_id = current_setting('app.tenant_id')::INT);
```

---

## å››ã€ç§Ÿæˆ·é…é¢ç®¡ç†

```sql
CREATE TABLE tenant_quotas (
    tenant_id INT PRIMARY KEY,
    plan_type VARCHAR(20),  -- basic/pro/enterprise
    max_users INT,
    max_storage_gb INT,
    max_api_calls_per_day INT,
    current_users INT DEFAULT 0,
    current_storage_gb NUMERIC(10,2) DEFAULT 0
);

-- é…é¢æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_quota_before_insert()
RETURNS TRIGGER AS $$
DECLARE
    v_current_users INT;
    v_max_users INT;
BEGIN
    SELECT current_users, max_users
    INTO v_current_users, v_max_users
    FROM tenant_quotas
    WHERE tenant_id = NEW.tenant_id;

    IF v_current_users >= v_max_users THEN
        RAISE EXCEPTION 'ç”¨æˆ·æ•°è¶…è¿‡é…é¢é™åˆ¶';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_quota
    BEFORE INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION check_quota_before_insert();
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **RLSæ€§èƒ½ä¼˜åŒ–**: ç­–ç•¥è®¡ç®—å¼€é”€-40%
- **å†…ç½®è¿æ¥æ± **: æ”¯æŒå¤§é‡ç§Ÿæˆ·è¿æ¥
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„ç§Ÿæˆ·æ“ä½œå®¡è®¡

---

---

## å…­ã€æ‰©å±•æ€§éœ€æ±‚

### 6.1 æ°´å¹³æ‰©å±•

**æ°´å¹³æ‰©å±•è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·åˆ†ç‰‡è¡¨ï¼ˆç”¨äºæ°´å¹³æ‰©å±•ï¼‰
CREATE TABLE IF NOT EXISTS tenant_shards (
    tenant_id INT PRIMARY KEY,
    shard_id INT NOT NULL,
    shard_host TEXT,
    shard_port INT DEFAULT 5432,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ†ç‰‡è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_tenant_shard(
    p_tenant_id INT
)
RETURNS TABLE (
    shard_id INT,
    shard_host TEXT,
    shard_port INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        shard_id,
        shard_host,
        shard_port
    FROM tenant_shards
    WHERE tenant_id = p_tenant_id;

    IF NOT FOUND THEN
        -- é»˜è®¤åˆ†ç‰‡
        RETURN QUERY SELECT
            0 AS shard_id,
            'localhost'::TEXT AS shard_host,
            5432 AS shard_port;
    END IF;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–ç§Ÿæˆ·åˆ†ç‰‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 ç§Ÿæˆ·è¿ç§»

**ç§Ÿæˆ·è¿ç§»éœ€æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·è¿ç§»å‡†å¤‡å‡½æ•°
CREATE OR REPLACE FUNCTION prepare_tenant_migration(
    p_tenant_id INT,
    p_target_shard_id INT
)
RETURNS TABLE (
    preparation_status TEXT,
    data_size_bytes BIGINT,
    estimated_duration_minutes NUMERIC
) AS $$
DECLARE
    total_size BIGINT;
BEGIN
    -- è®¡ç®—æ•°æ®å¤§å°
    SELECT SUM(pg_total_relation_size(schemaname||'.'||tablename))
    INTO total_size
    FROM pg_tables
    WHERE schemaname = 'public'
      AND tablename IN ('users', 'documents', 'tenant_configs');

    -- ä¼°ç®—è¿ç§»æ—¶é—´ï¼ˆå‡è®¾100MB/åˆ†é’Ÿï¼‰
    RETURN QUERY SELECT
        'å‡†å¤‡å®Œæˆ'::TEXT,
        total_size,
        ROUND(total_size / 1024.0 / 1024.0 / 100.0, 2);  -- 100MB/åˆ†é’Ÿ

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‡†å¤‡ç§Ÿæˆ·è¿ç§»å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€åˆè§„æ€§éœ€æ±‚

### 7.1 æ•°æ®éš”ç¦»åˆè§„

**æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_data_isolation_compliance(
    p_tenant_id_1 INT,
    p_tenant_id_2 INT
)
RETURNS TABLE (
    check_type TEXT,
    check_result TEXT,
    compliance_status TEXT
) AS $$
DECLARE
    tenant_1_count BIGINT;
    tenant_2_count BIGINT;
BEGIN
    -- è®¾ç½®ç§Ÿæˆ·1ä¸Šä¸‹æ–‡
    PERFORM set_config('app.current_tenant', p_tenant_id_1::TEXT, false);

    SELECT COUNT(*) INTO tenant_1_count FROM users;

    -- è®¾ç½®ç§Ÿæˆ·2ä¸Šä¸‹æ–‡
    PERFORM set_config('app.current_tenant', p_tenant_id_2::TEXT, false);

    SELECT COUNT(*) INTO tenant_2_count FROM users;

    -- éªŒè¯éš”ç¦»æ€§
    RETURN QUERY SELECT
        'æ•°æ®éš”ç¦»æ€§'::TEXT,
        format('ç§Ÿæˆ·1: %sæ¡, ç§Ÿæˆ·2: %sæ¡', tenant_1_count, tenant_2_count)::TEXT,
        CASE
            WHEN tenant_1_count != tenant_2_count THEN 'åˆè§„'
            ELSE 'ä¸åˆè§„'
        END;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
