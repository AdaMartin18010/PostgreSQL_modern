---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - éœ€æ±‚åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **ç§Ÿæˆ·æ•°**: 1000+

---

## ä¸€ã€ä¸šåŠ¡èƒŒæ™¯

### å…¸å‹åœºæ™¯

**ä¼ä¸šçº§SaaSå¹³å°**ï¼ˆCRM/ERP/åä½œå·¥å…·ï¼‰

- **ç§Ÿæˆ·æ•°é‡**: 1000+ä¼ä¸šå®¢æˆ·
- **ç”¨æˆ·æ•°**: 50ä¸‡+ï¼ˆå¹³å‡æ¯ç§Ÿæˆ·500ç”¨æˆ·ï¼‰
- **æ•°æ®éš”ç¦»**: ä¸¥æ ¼éš”ç¦»ï¼Œäº’ä¸å¯è§
- **ç§Ÿæˆ·é…é¢**: ä¸åŒå¥—é¤ä¸åŒé…é¢

---

## äºŒã€æ•°æ®éš”ç¦»æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éš”ç¦»æ€§ | æ€§èƒ½ | æˆæœ¬ | ç»´æŠ¤ |
| --- | --- | --- | --- | --- |
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | â­â­ | â­ | â­ |
| **ç‹¬ç«‹Schema** | â­â­â­â­ | â­â­â­ | â­â­ | â­â­ |
| **å…±äº«è¡¨+RLS** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

**æ¨è**: å…±äº«è¡¨+RLSï¼ˆæ€§èƒ½æœ€ä¼˜ï¼Œæˆæœ¬æœ€ä½ï¼‰

---

## ä¸‰ã€æ ¸å¿ƒè®¾è®¡

### RLSç­–ç•¥è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    username VARCHAR(100),
    email VARCHAR(200),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¯ç”¨RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ç§Ÿæˆ·éš”ç¦»ç­–ç•¥
CREATE POLICY tenant_isolation ON users
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- â­ PostgreSQL 18ï¼šRLSæ€§èƒ½ä¼˜åŒ–
-- ç­–ç•¥ä¸‹æ¨+ç¼“å­˜ï¼ŒæŸ¥è¯¢æ—¶é—´é™ä½30-60%
```

### ä½¿ç”¨æ–¹å¼

```sql
-- è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.tenant_id = 1001;

-- æŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¿‡æ»¤ï¼‰
SELECT * FROM users;
-- åªè¿”å›tenant_id=1001çš„æ•°æ®

-- æ’å…¥ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
CREATE POLICY tenant_insert ON users
    FOR INSERT
    WITH CHECK (tenant_id = current_setting('app.tenant_id')::INT);
```

---

## å››ã€ç§Ÿæˆ·é…é¢ç®¡ç†

```sql
CREATE TABLE tenant_quotas (
    tenant_id INT PRIMARY KEY,
    plan_type VARCHAR(20),  -- basic/pro/enterprise
    max_users INT,
    max_storage_gb INT,
    max_api_calls_per_day INT,
    current_users INT DEFAULT 0,
    current_storage_gb NUMERIC(10,2) DEFAULT 0
);

-- é…é¢æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_quota_before_insert()
RETURNS TRIGGER AS $$
DECLARE
    v_current_users INT;
    v_max_users INT;
BEGIN
    SELECT current_users, max_users
    INTO v_current_users, v_max_users
    FROM tenant_quotas
    WHERE tenant_id = NEW.tenant_id;

    IF v_current_users >= v_max_users THEN
        RAISE EXCEPTION 'ç”¨æˆ·æ•°è¶…è¿‡é…é¢é™åˆ¶';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_quota
    BEFORE INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION check_quota_before_insert();
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **RLSæ€§èƒ½ä¼˜åŒ–**: ç­–ç•¥è®¡ç®—å¼€é”€-40%
- **å†…ç½®è¿æ¥æ± **: æ”¯æŒå¤§é‡ç§Ÿæˆ·è¿æ¥
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„ç§Ÿæˆ·æ“ä½œå®¡è®¡

---

---

## å…­ã€æ‰©å±•æ€§éœ€æ±‚

### 6.1 æ°´å¹³æ‰©å±•

**æ°´å¹³æ‰©å±•è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·åˆ†ç‰‡è¡¨ï¼ˆç”¨äºæ°´å¹³æ‰©å±•ï¼‰
CREATE TABLE IF NOT EXISTS tenant_shards (
    tenant_id INT PRIMARY KEY,
    shard_id INT NOT NULL,
    shard_host TEXT,
    shard_port INT DEFAULT 5432,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ†ç‰‡è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_tenant_shard(
    p_tenant_id INT
)
RETURNS TABLE (
    shard_id INT,
    shard_host TEXT,
    shard_port INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        shard_id,
        shard_host,
        shard_port
    FROM tenant_shards
    WHERE tenant_id = p_tenant_id;

    IF NOT FOUND THEN
        -- é»˜è®¤åˆ†ç‰‡
        RETURN QUERY SELECT
            0 AS shard_id,
            'localhost'::TEXT AS shard_host,
            5432 AS shard_port;
    END IF;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–ç§Ÿæˆ·åˆ†ç‰‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 ç§Ÿæˆ·è¿ç§»

**ç§Ÿæˆ·è¿ç§»éœ€æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·è¿ç§»å‡†å¤‡å‡½æ•°
CREATE OR REPLACE FUNCTION prepare_tenant_migration(
    p_tenant_id INT,
    p_target_shard_id INT
)
RETURNS TABLE (
    preparation_status TEXT,
    data_size_bytes BIGINT,
    estimated_duration_minutes NUMERIC
) AS $$
DECLARE
    total_size BIGINT;
BEGIN
    -- è®¡ç®—æ•°æ®å¤§å°
    SELECT SUM(pg_total_relation_size(schemaname||'.'||tablename))
    INTO total_size
    FROM pg_tables
    WHERE schemaname = 'public'
      AND tablename IN ('users', 'documents', 'tenant_configs');

    -- ä¼°ç®—è¿ç§»æ—¶é—´ï¼ˆå‡è®¾100MB/åˆ†é’Ÿï¼‰
    RETURN QUERY SELECT
        'å‡†å¤‡å®Œæˆ'::TEXT,
        total_size,
        ROUND(total_size / 1024.0 / 1024.0 / 100.0, 2);  -- 100MB/åˆ†é’Ÿ

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‡†å¤‡ç§Ÿæˆ·è¿ç§»å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€åˆè§„æ€§éœ€æ±‚

### 7.1 æ•°æ®éš”ç¦»åˆè§„

**æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_data_isolation_compliance(
    p_tenant_id_1 INT,
    p_tenant_id_2 INT
)
RETURNS TABLE (
    check_type TEXT,
    check_result TEXT,
    compliance_status TEXT
) AS $$
DECLARE
    tenant_1_count BIGINT;
    tenant_2_count BIGINT;
BEGIN
    -- è®¾ç½®ç§Ÿæˆ·1ä¸Šä¸‹æ–‡
    PERFORM set_config('app.current_tenant', p_tenant_id_1::TEXT, false);

    SELECT COUNT(*) INTO tenant_1_count FROM users;

    -- è®¾ç½®ç§Ÿæˆ·2ä¸Šä¸‹æ–‡
    PERFORM set_config('app.current_tenant', p_tenant_id_2::TEXT, false);

    SELECT COUNT(*) INTO tenant_2_count FROM users;

    -- éªŒè¯éš”ç¦»æ€§
    RETURN QUERY SELECT
        'æ•°æ®éš”ç¦»æ€§'::TEXT,
        format('ç§Ÿæˆ·1: %sæ¡, ç§Ÿæˆ·2: %sæ¡', tenant_1_count, tenant_2_count)::TEXT,
        CASE
            WHEN tenant_1_count != tenant_2_count THEN 'åˆè§„'
            ELSE 'ä¸åˆè§„'
        END;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®éš”ç¦»åˆè§„æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## å…«ã€æ€§èƒ½éœ€æ±‚

### 8.1 æ€§èƒ½æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡è¦æ±‚**ï¼š

- âœ… **æŸ¥è¯¢å»¶è¿Ÿ**: P95 < 100ms
- âœ… **å†™å…¥å»¶è¿Ÿ**: P95 < 50ms
- âœ… **å¹¶å‘ç§Ÿæˆ·**: æ”¯æŒ1000+ç§Ÿæˆ·åŒæ—¶åœ¨çº¿
- âœ… **QPS**: å•ç§Ÿæˆ·QPS > 1000
- âœ… **å¯ç”¨æ€§**: 99.9%+

### 8.2 æ€§èƒ½ç›‘æ§

**æ€§èƒ½ç›‘æ§é…ç½®**ï¼š

```sql
-- ç§Ÿæˆ·æ€§èƒ½ç›‘æ§è¡¨
CREATE TABLE IF NOT EXISTS tenant_performance_metrics (
    tenant_id INT NOT NULL,
    metric_name TEXT NOT NULL,
    metric_value NUMERIC,
    recorded_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (tenant_id, metric_name, recorded_at)
);

-- æ€§èƒ½æŒ‡æ ‡è®°å½•å‡½æ•°
CREATE OR REPLACE FUNCTION record_tenant_metric(
    p_tenant_id INT,
    p_metric_name TEXT,
    p_metric_value NUMERIC
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO tenant_performance_metrics (
        tenant_id, metric_name, metric_value, recorded_at
    ) VALUES (
        p_tenant_id, p_metric_name, p_metric_value, NOW()
    );
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®°å½•æ€§èƒ½æŒ‡æ ‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¹ã€å®‰å…¨éœ€æ±‚

### 9.1 æ•°æ®å®‰å…¨

**æ•°æ®å®‰å…¨è¦æ±‚**ï¼š

- âœ… **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- âœ… **ä¼ è¾“åŠ å¯†**: TLS/SSLåŠ å¯†ä¼ è¾“
- âœ… **è®¿é—®æ§åˆ¶**: ä¸¥æ ¼çš„æƒé™ç®¡ç†
- âœ… **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„æ“ä½œå®¡è®¡

### 9.2 ç§Ÿæˆ·æ•°æ®å®‰å…¨

**ç§Ÿæˆ·æ•°æ®å®‰å…¨é…ç½®**ï¼š

```sql
-- ç§Ÿæˆ·è®¿é—®æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS tenant_access_logs (
    log_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    user_id BIGINT,
    action_type TEXT,
    resource_type TEXT,
    resource_id BIGINT,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è®¿é—®æ—¥å¿—è®°å½•å‡½æ•°
CREATE OR REPLACE FUNCTION log_tenant_access(
    p_tenant_id INT,
    p_user_id BIGINT,
    p_action_type TEXT,
    p_resource_type TEXT,
    p_resource_id BIGINT,
    p_ip_address INET,
    p_user_agent TEXT
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO tenant_access_logs (
        tenant_id, user_id, action_type, resource_type,
        resource_id, ip_address, user_agent, created_at
    ) VALUES (
        p_tenant_id, p_user_id, p_action_type, p_resource_type,
        p_resource_id, p_ip_address, p_user_agent, NOW()
    );
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®°å½•è®¿é—®æ—¥å¿—å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åã€PostgreSQL 18ç‰¹æ€§åº”ç”¨

### 10.1 RLSæ€§èƒ½ä¼˜åŒ–

**RLSæ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š

```sql
-- PostgreSQL 18 RLSä¼˜åŒ–
-- 1. ç­–ç•¥ä¸‹æ¨ä¼˜åŒ–
ALTER TABLE users ALTER COLUMN tenant_id SET STATISTICS 1000;

-- 2. ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
ANALYZE users;

-- 3. ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_users_tenant_id ON users(tenant_id);

-- æ€§èƒ½æå‡ï¼šæŸ¥è¯¢æ—¶é—´é™ä½30-60%
```

### 10.2 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oé…ç½®**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
ALTER SYSTEM SET io_direct = 'data,wal';
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET wal_io_concurrency = 200;

-- æ€§èƒ½æå‡ï¼šæ‰¹é‡å†™å…¥æ€§èƒ½æå‡40%
```

### 10.3 è¿æ¥æ± ä¼˜åŒ–

**è¿æ¥æ± é…ç½®**ï¼š

```ini
# pgBounceré…ç½®
[pgbouncer]
pool_mode = transaction
max_client_conn = 10000
default_pool_size = 100
min_pool_size = 20
reserve_pool_size = 10

# ç§Ÿæˆ·çº§è¿æ¥æ± 
[databases]
saas_db = host=localhost port=5432 dbname=saas_db
```

---

## åä¸€ã€ç›‘æ§å‘Šè­¦éœ€æ±‚

### 11.1 ç§Ÿæˆ·ç›‘æ§

**ç§Ÿæˆ·ç›‘æ§æŒ‡æ ‡**ï¼š

- âœ… **èµ„æºä½¿ç”¨**: CPUã€å†…å­˜ã€å­˜å‚¨ä½¿ç”¨ç‡
- âœ… **æ€§èƒ½æŒ‡æ ‡**: æŸ¥è¯¢å»¶è¿Ÿã€å†™å…¥å»¶è¿Ÿ
- âœ… **é…é¢ä½¿ç”¨**: ç”¨æˆ·æ•°ã€å­˜å‚¨ä½¿ç”¨ç‡
- âœ… **é”™è¯¯ç‡**: é”™è¯¯è¯·æ±‚ç‡

### 11.2 å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: tenant_alerts
  rules:
  - alert: TenantQuotaExceeded
    expr: tenant_quota_usage > 0.9
    for: 5m
    annotations:
      summary: "ç§Ÿæˆ·é…é¢ä½¿ç”¨ç‡è¿‡é«˜"
      description: "ç§Ÿæˆ·{{ $labels.tenant_id }}é…é¢ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"

  - alert: TenantHighLatency
    expr: histogram_quantile(0.95, rate(tenant_query_latency_bucket[5m])) > 100
    for: 5m
    annotations:
      summary: "ç§Ÿæˆ·æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜"
      description: "ç§Ÿæˆ·{{ $labels.tenant_id }} P95å»¶è¿Ÿ: {{ $value }}ms"
```

---

## åäºŒã€å¤‡ä»½æ¢å¤éœ€æ±‚

### 12.1 ç§Ÿæˆ·æ•°æ®å¤‡ä»½

**ç§Ÿæˆ·æ•°æ®å¤‡ä»½ç­–ç•¥**ï¼š

- âœ… **å…¨é‡å¤‡ä»½**: æ¯å¤©ä¸€æ¬¡
- âœ… **å¢é‡å¤‡ä»½**: æ¯å°æ—¶ä¸€æ¬¡
- âœ… **ç§Ÿæˆ·çº§å¤‡ä»½**: æ”¯æŒæŒ‰ç§Ÿæˆ·å¤‡ä»½
- âœ… **å¼‚åœ°å¤‡ä»½**: å¤šåœ°åŸŸå¤‡ä»½

### 12.2 ç§Ÿæˆ·æ•°æ®æ¢å¤

**ç§Ÿæˆ·æ•°æ®æ¢å¤æµç¨‹**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®æ¢å¤å‡½æ•°
CREATE OR REPLACE FUNCTION restore_tenant_data(
    p_tenant_id INT,
    p_backup_file TEXT
)
RETURNS TABLE (
    restore_status TEXT,
    restored_tables TEXT[],
    restored_rows BIGINT
) AS $$
DECLARE
    table_name TEXT;
    restored_count BIGINT;
    restored_tables_list TEXT[] := ARRAY[]::TEXT[];
    total_rows BIGINT := 0;
BEGIN
    -- æ¢å¤ç”¨æˆ·è¡¨
    PERFORM pg_restore(
        '-d', current_database(),
        '-t', 'users',
        '--where', format('tenant_id=%s', p_tenant_id),
        p_backup_file
    );

    SELECT COUNT(*) INTO restored_count
    FROM users
    WHERE tenant_id = p_tenant_id;

    restored_tables_list := restored_tables_list || 'users';
    total_rows := total_rows + restored_count;

    -- æ¢å¤å…¶ä»–è¡¨...

    RETURN QUERY SELECT
        'æ¢å¤å®Œæˆ'::TEXT,
        restored_tables_list,
        total_rows;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·æ•°æ®æ¢å¤å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åä¸‰ã€ä¸šåŠ¡åœºæ™¯æ‰©å±•

### 13.1 ç§Ÿæˆ·å‡çº§/é™çº§

**ç§Ÿæˆ·å¥—é¤å˜æ›´**ï¼š

```sql
-- ç§Ÿæˆ·å¥—é¤å˜æ›´å‡½æ•°
CREATE OR REPLACE FUNCTION change_tenant_plan(
    p_tenant_id INT,
    p_new_plan_type VARCHAR(20)
)
RETURNS BOOLEAN AS $$
DECLARE
    old_plan VARCHAR(20);
BEGIN
    -- è·å–å½“å‰å¥—é¤
    SELECT plan_type INTO old_plan
    FROM tenant_quotas
    WHERE tenant_id = p_tenant_id;

    -- æ›´æ–°å¥—é¤
    UPDATE tenant_quotas
    SET plan_type = p_new_plan_type,
        max_users = CASE p_new_plan_type
            WHEN 'basic' THEN 50
            WHEN 'pro' THEN 500
            WHEN 'enterprise' THEN 5000
            ELSE max_users
        END,
        max_storage_gb = CASE p_new_plan_type
            WHEN 'basic' THEN 10
            WHEN 'pro' THEN 100
            WHEN 'enterprise' THEN 1000
            ELSE max_storage_gb
        END
    WHERE tenant_id = p_tenant_id;

    -- è®°å½•å˜æ›´æ—¥å¿—
    INSERT INTO tenant_plan_changes (
        tenant_id, old_plan, new_plan, changed_at
    ) VALUES (
        p_tenant_id, old_plan, p_new_plan_type, NOW()
    );

    RETURN FOUND;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·å¥—é¤å˜æ›´å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 13.2 ç§Ÿæˆ·æ•°æ®å¯¼å‡º

**ç§Ÿæˆ·æ•°æ®å¯¼å‡º**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®å¯¼å‡ºå‡½æ•°
CREATE OR REPLACE FUNCTION export_tenant_data(
    p_tenant_id INT,
    p_export_format TEXT DEFAULT 'json'
)
RETURNS TEXT AS $$
DECLARE
    export_file TEXT;
    export_data JSONB;
BEGIN
    -- è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
    PERFORM set_config('app.current_tenant', p_tenant_id::TEXT, false);

    -- å¯¼å‡ºæ•°æ®
    SELECT jsonb_build_object(
        'users', (SELECT jsonb_agg(row_to_json(u)) FROM users u),
        'documents', (SELECT jsonb_agg(row_to_json(d)) FROM documents d),
        'configs', (SELECT jsonb_agg(row_to_json(c)) FROM tenant_configs c)
    ) INTO export_data;

    -- ä¿å­˜åˆ°æ–‡ä»¶
    export_file := format('/exports/tenant_%s_%s.json',
        p_tenant_id,
        to_char(NOW(), 'YYYYMMDD_HH24MISS')
    );

    PERFORM pg_file_write(export_file, export_data::TEXT);

    RETURN export_file;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·æ•°æ®å¯¼å‡ºå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## åå››ã€æ€»ç»“

### 14.1 æ ¸å¿ƒéœ€æ±‚æ€»ç»“

**å¤šç§Ÿæˆ·SaaSç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚**ï¼š

1. âœ… **æ•°æ®éš”ç¦»**: ä¸¥æ ¼çš„ç§Ÿæˆ·æ•°æ®éš”ç¦»
2. âœ… **æ€§èƒ½ä¼˜åŒ–**: æ”¯æŒ1000+ç§Ÿæˆ·ï¼Œä½å»¶è¿Ÿ
3. âœ… **é…é¢ç®¡ç†**: çµæ´»çš„ç§Ÿæˆ·é…é¢ç®¡ç†
4. âœ… **å®‰å…¨åˆè§„**: æ•°æ®å®‰å…¨ã€è®¿é—®æ§åˆ¶ã€å®¡è®¡
5. âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•å’Œå‚ç›´æ‰©å±•
6. âœ… **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

### 14.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨å¤šç§Ÿæˆ·SaaSç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **RLSæ€§èƒ½ä¼˜åŒ–**: æŸ¥è¯¢æ—¶é—´é™ä½30-60%
- âœ… **å¼‚æ­¥I/O**: æ‰¹é‡å†™å…¥æ€§èƒ½æå‡40%
- âœ… **è¿æ¥æ± **: æ”¯æŒå¤§é‡ç§Ÿæˆ·è¿æ¥
- âœ… **å®¡è®¡å¢å¼º**: JSONæ ¼å¼å®¡è®¡æ—¥å¿—

---

**è¿”å›**: [æ¡ˆä¾‹4ä¸»é¡µ](./README.md)
**å­—æ•°**: ~4,100å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
