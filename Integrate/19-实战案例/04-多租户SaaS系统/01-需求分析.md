---

> **📋 文档来源**: `DataBaseTheory\19-场景案例库\04-多租户SaaS系统\01-需求分析.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 多租户SaaS系统 - 需求分析

> **PostgreSQL版本**: 18.x
> **租户数**: 1000+

---

## 一、业务背景

### 典型场景

**企业级SaaS平台**（CRM/ERP/协作工具）

- **租户数量**: 1000+企业客户
- **用户数**: 50万+（平均每租户500用户）
- **数据隔离**: 严格隔离，互不可见
- **租户配额**: 不同套餐不同配额

---

## 二、数据隔离方案

### 方案对比

| 方案 | 隔离性 | 性能 | 成本 | 维护 |
| --- | --- | --- | --- | --- |
| **独立数据库** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐ | ⭐ |
| **独立Schema** | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ |
| **共享表+RLS** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**推荐**: 共享表+RLS（性能最优，成本最低）

---

## 三、核心设计

### RLS策略设计

```sql
-- 用户表
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    username VARCHAR(100),
    email VARCHAR(200),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 租户隔离策略
CREATE POLICY tenant_isolation ON users
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- ⭐ PostgreSQL 18：RLS性能优化
-- 策略下推+缓存，查询时间降低30-60%
```

### 使用方式

```sql
-- 设置租户上下文
SET app.tenant_id = 1001;

-- 查询（自动过滤）
SELECT * FROM users;
-- 只返回tenant_id=1001的数据

-- 插入（自动填充）
CREATE POLICY tenant_insert ON users
    FOR INSERT
    WITH CHECK (tenant_id = current_setting('app.tenant_id')::INT);
```

---

## 四、租户配额管理

```sql
CREATE TABLE tenant_quotas (
    tenant_id INT PRIMARY KEY,
    plan_type VARCHAR(20),  -- basic/pro/enterprise
    max_users INT,
    max_storage_gb INT,
    max_api_calls_per_day INT,
    current_users INT DEFAULT 0,
    current_storage_gb NUMERIC(10,2) DEFAULT 0
);

-- 配额检查函数
CREATE OR REPLACE FUNCTION check_quota_before_insert()
RETURNS TRIGGER AS $$
DECLARE
    v_current_users INT;
    v_max_users INT;
BEGIN
    SELECT current_users, max_users
    INTO v_current_users, v_max_users
    FROM tenant_quotas
    WHERE tenant_id = NEW.tenant_id;

    IF v_current_users >= v_max_users THEN
        RAISE EXCEPTION '用户数超过配额限制';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_quota
    BEFORE INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION check_quota_before_insert();
```

---

## 五、PostgreSQL 18特性

- **RLS性能优化**: 策略计算开销-40%
- **内置连接池**: 支持大量租户连接
- **审计日志**: 完整的租户操作审计

---

**文档完成** ✅
