---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\03-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹4ï¼šå¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **æŠ€æœ¯æ ˆ**: FastAPI + PostgreSQL 18 + RLS
- **ä»£ç é‡**: ~1,800è¡Œ

---

## 1. ç§Ÿæˆ·ç®¡ç†æ¨¡å—

```python
"""
å¤šç§Ÿæˆ·ç®¡ç†æ¨¡å—
"""

import psycopg2
from fastapi import FastAPI, Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
import jwt
from datetime import datetime, timedelta

app = FastAPI()
security = HTTPBearer()

# JWTé…ç½®
JWT_SECRET = "your-secret-key"
JWT_ALGORITHM = "HS256"

class TenantManager:
    """ç§Ÿæˆ·ç®¡ç†å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def create_tenant(self, tenant_name, plan_type='free'):
        """
        åˆ›å»ºæ–°ç§Ÿæˆ·ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯ï¼‰

        Args:
            tenant_name: ç§Ÿæˆ·åç§°
            plan_type: å¥—é¤ç±»å‹ (free/pro/enterprise)
        """
        import psycopg2

        # å‚æ•°éªŒè¯
        if not tenant_name or not tenant_name.strip():
            raise ValueError("tenant_nameä¸èƒ½ä¸ºç©º")
        if plan_type not in ['free', 'pro', 'enterprise']:
            raise ValueError(f"plan_typeæ— æ•ˆ: {plan_type}ï¼Œå¿…é¡»æ˜¯free/pro/enterpriseä¹‹ä¸€")

        try:
            # æ ¹æ®å¥—é¤è®¾ç½®é…é¢
            quotas = {
                'free': {'storage_gb': 1, 'connections': 5},
                'pro': {'storage_gb': 10, 'connections': 20},
                'enterprise': {'storage_gb': 100, 'connections': 100}
            }

            quota = quotas.get(plan_type, quotas['free'])

            self.cursor.execute("""
                INSERT INTO tenants (tenant_name, plan_type, storage_quota_gb, connection_quota)
                VALUES (%s, %s, %s, %s)
                RETURNING tenant_id;
            """, (tenant_name, plan_type, quota['storage_gb'], quota['connections']))

            tenant_id = self.cursor.fetchone()[0]
            self.conn.commit()

            # åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®
            try:
                self._initialize_tenant_data(tenant_id)
            except Exception as e:
                print(f"åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®å¤±è´¥: {e}")
                # å›æ»šç§Ÿæˆ·åˆ›å»º
                self.conn.rollback()
                raise

            return tenant_id
        except psycopg2.IntegrityError as e:
            print(f"åˆ›å»ºç§Ÿæˆ·å¤±è´¥ï¼ˆæ•°æ®å®Œæ•´æ€§é”™è¯¯ï¼‰: {e}")
            self.conn.rollback()
            raise
        except psycopg2.OperationalError as e:
            print(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
            self.conn.rollback()
            raise
        except psycopg2.Error as e:
            print(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
            self.conn.rollback()
            raise
        except Exception as e:
            print(f"æœªçŸ¥é”™è¯¯: {e}")
            self.conn.rollback()
            raise

    def _initialize_tenant_data(self, tenant_id):
        """åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯ï¼‰"""
        import psycopg2

        # å‚æ•°éªŒè¯
        if tenant_id is None or tenant_id <= 0:
            raise ValueError(f"tenant_idæ— æ•ˆ: {tenant_id}")

        try:
            # è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥ï¼‰
            self.cursor.execute("SET app.current_tenant = %s;", (tenant_id,))

            # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
            self.cursor.execute("""
                INSERT INTO users (tenant_id, username, email, password_hash)
                VALUES (%s, 'admin', 'admin@example.com', 'hashed_password');
            """, (tenant_id,))

            self.conn.commit()
            print(f"âœ… ç§Ÿæˆ· {tenant_id} åˆå§‹åŒ–å®Œæˆ")
        except psycopg2.IntegrityError as e:
            print(f"åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®å¤±è´¥ï¼ˆæ•°æ®å®Œæ•´æ€§é”™è¯¯ï¼‰: {e}")
            self.conn.rollback()
            raise
        except psycopg2.Error as e:
            print(f"åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®å¤±è´¥: {e}")
            self.conn.rollback()
            raise
        except Exception as e:
            print(f"åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®æœªçŸ¥é”™è¯¯: {e}")
            self.conn.rollback()
            raise
```

---

## 2. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶

```python
from contextvars import ContextVar

# å½“å‰ç§Ÿæˆ·IDä¸Šä¸‹æ–‡
current_tenant_id = ContextVar('current_tenant_id', default=None)

def get_current_tenant() -> int:
    """è·å–å½“å‰ç§Ÿæˆ·ID"""
    tenant_id = current_tenant_id.get()
    if tenant_id is None:
        raise HTTPException(status_code=401, detail="æœªè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡")
    return tenant_id

async def set_tenant_context(credentials: HTTPAuthorizationCredentials = Depends(security)):
    """
    ä»JWT Tokenè§£æç§Ÿæˆ·IDå¹¶è®¾ç½®ä¸Šä¸‹æ–‡
    """

    try:
        token = credentials.credentials
        payload = jwt.decode(token, JWT_SECRET, algorithms=[JWT_ALGORITHM])
        tenant_id = payload.get('tenant_id')

        if not tenant_id:
            raise HTTPException(status_code=401, detail="Tokenä¸­æ— ç§Ÿæˆ·ä¿¡æ¯")

        # è®¾ç½®ä¸Šä¸‹æ–‡
        current_tenant_id.set(tenant_id)

        return tenant_id

    except jwt.JWTError:
        raise HTTPException(status_code=401, detail="Tokenæ— æ•ˆ")

# æ•°æ®åº“è¿æ¥ + è®¾ç½®RLSä¸Šä¸‹æ–‡ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
def get_db_with_tenant():
    """è·å–å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„æ•°æ®åº“è¿æ¥ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
    import psycopg2

    try:
        tenant_id = get_current_tenant()
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è·å–ç§Ÿæˆ·ä¸Šä¸‹æ–‡å¤±è´¥: {str(e)}")

    try:
        conn = psycopg2.connect("dbname=saas_db user=postgres")
        cursor = conn.cursor()

        # è®¾ç½®ç§Ÿæˆ·IDï¼ˆRLSä½¿ç”¨ï¼‰
        cursor.execute(f"SET app.current_tenant = {tenant_id};")
        conn.commit()

        return conn
    except psycopg2.OperationalError as e:
        raise HTTPException(status_code=503, detail=f"æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}")
    except psycopg2.Error as e:
        raise HTTPException(status_code=500, detail=f"æ•°æ®åº“é”™è¯¯: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æœªçŸ¥é”™è¯¯: {str(e)}")
```

---

## 3. APIå®ç°

```python
@app.post("/api/documents")
async def create_document(
    document: dict,
    tenant_id: int = Depends(set_tenant_context),
    conn = Depends(get_db_with_tenant)
):
    """
    åˆ›å»ºæ–‡æ¡£ï¼ˆè‡ªåŠ¨åº”ç”¨RLSï¼‰
    """

    cursor = None
    try:
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT INTO documents (tenant_id, user_id, title, content, size_bytes)
            VALUES (%s, %s, %s, %s, %s)
            RETURNING id;
        """, (tenant_id, document['user_id'], document['title'],
              document['content'], len(document['content'])))

        doc_id = cursor.fetchone()[0]
        conn.commit()

        return {"success": True, "document_id": doc_id}

    except psycopg2.IntegrityError as e:
        conn.rollback()
        raise HTTPException(status_code=400, detail=f"æ•°æ®å®Œæ•´æ€§é”™è¯¯: {str(e)}")
    except psycopg2.OperationalError as e:
        conn.rollback()
        raise HTTPException(status_code=503, detail=f"æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}")
    except psycopg2.Error as e:
        conn.rollback()
        raise HTTPException(status_code=500, detail=f"æ•°æ®åº“æ“ä½œå¤±è´¥: {str(e)}")
    except Exception as e:
        conn.rollback()
        raise HTTPException(status_code=400, detail=str(e))
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()

@app.get("/api/documents")
async def list_documents(
    tenant_id: int = Depends(set_tenant_context),
    conn = Depends(get_db_with_tenant)
):
    """
    åˆ—å‡ºæ–‡æ¡£ï¼ˆRLSè‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®ï¼‰
    """

    cursor = None
    try:
        cursor = conn.cursor()
        
        # RLSä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œåªè¿”å›å½“å‰ç§Ÿæˆ·çš„æ•°æ®
        cursor.execute("""
            SELECT id, title, size_bytes, created_at
            FROM documents
            ORDER BY created_at DESC
            LIMIT 100;
        """)

        results = cursor.fetchall()

        return {
            "success": True,
            "documents": [
                {"id": r[0], "title": r[1], "size_bytes": r[2], "created_at": r[3]}
                for r in results
            ]
        }

    except psycopg2.OperationalError as e:
        raise HTTPException(status_code=503, detail=f"æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}")
    except psycopg2.Error as e:
        raise HTTPException(status_code=500, detail=f"æ•°æ®åº“æ“ä½œå¤±è´¥: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æœªçŸ¥é”™è¯¯: {str(e)}")
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
```

---

## 4. é…é¢æ£€æŸ¥æ¨¡å—

```python
class QuotaChecker:
    """é…é¢æ£€æŸ¥å™¨"""

    def __init__(self, conn, tenant_id):
        self.conn = conn
        self.cursor = conn.cursor()
        self.tenant_id = tenant_id

    def check_storage_quota(self) -> bool:
        """æ£€æŸ¥å­˜å‚¨é…é¢ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        import psycopg2

        try:
            self.cursor.execute("""
                SELECT
                    COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 AS used_gb,
                    t.storage_quota_gb
                FROM tenants t
                LEFT JOIN documents d ON t.tenant_id = d.tenant_id
                WHERE t.tenant_id = %s
            GROUP BY t.storage_quota_gb;
        """, (self.tenant_id,))

        result = self.cursor.fetchone()
        if not result:
            return True

        used_gb, quota_gb = result
        return used_gb < quota_gb

    def get_quota_usage(self):
        """è·å–é…é¢ä½¿ç”¨æƒ…å†µï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        import psycopg2

        try:
            self.cursor.execute("""
                SELECT
                    t.storage_quota_gb,
                    COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 AS used_gb,
                    COUNT(DISTINCT d.id) AS document_count,
                    COUNT(DISTINCT u.id) AS user_count
                FROM tenants t
            LEFT JOIN documents d ON t.tenant_id = d.tenant_id
            LEFT JOIN users u ON t.tenant_id = u.tenant_id
            WHERE t.tenant_id = %s
            GROUP BY t.storage_quota_gb;
        """, (self.tenant_id,))

            result = self.cursor.fetchone()

            if not result:
                return {
                    'quota_gb': 0,
                    'used_gb': 0,
                    'usage_percent': 0,
                    'document_count': 0,
                    'user_count': 0
                }

            return {
                'quota_gb': result[0],
                'used_gb': float(result[1]),
                'usage_percent': (float(result[1]) / result[0] * 100) if result[0] > 0 else 0,
                'document_count': result[2],
                'user_count': result[3]
            }
        except psycopg2.OperationalError as e:
            print(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
            raise
        except psycopg2.Error as e:
            print(f"è·å–é…é¢ä½¿ç”¨æƒ…å†µå¤±è´¥: {e}")
            raise
        except Exception as e:
            print(f"æœªçŸ¥é”™è¯¯: {e}")
            raise
```

---

---

## 5. ç§Ÿæˆ·æ•°æ®è¿ç§»

### 5.1 ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°

**ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class TenantDataMigrator:
    """ç§Ÿæˆ·æ•°æ®è¿ç§»å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def migrate_tenant_data(self, source_tenant_id, target_tenant_id):
        """
        è¿ç§»ç§Ÿæˆ·æ•°æ®

        Args:
            source_tenant_id: æºç§Ÿæˆ·ID
            target_tenant_id: ç›®æ ‡ç§Ÿæˆ·ID
        """

        try:
            # 1. è¿ç§»ç”¨æˆ·æ•°æ®
            self.cursor.execute("""
                INSERT INTO users (tenant_id, username, email, password_hash, created_at)
                SELECT %s, username, email, password_hash, created_at
                FROM users
                WHERE tenant_id = %s
            """, (target_tenant_id, source_tenant_id))

            user_count = self.cursor.rowcount

            # 2. è¿ç§»æ–‡æ¡£æ•°æ®
            self.cursor.execute("""
                INSERT INTO documents (tenant_id, user_id, title, content, size_bytes, created_at)
                SELECT %s,
                       (SELECT id FROM users WHERE tenant_id = %s AND username = u.username LIMIT 1),
                       d.title, d.content, d.size_bytes, d.created_at
                FROM documents d
                JOIN users u ON d.user_id = u.id
                WHERE d.tenant_id = %s
            """, (target_tenant_id, target_tenant_id, source_tenant_id))

            doc_count = self.cursor.rowcount

            self.conn.commit()

            return {
                'success': True,
                'users_migrated': user_count,
                'documents_migrated': doc_count
            }

        except Exception as e:
            self.conn.rollback()
            raise Exception(f"æ•°æ®è¿ç§»å¤±è´¥: {str(e)}")
```

---

## 6. ç§Ÿæˆ·éš”ç¦»éªŒè¯

### 6.1 éš”ç¦»æ€§æµ‹è¯•

**éš”ç¦»æ€§æµ‹è¯•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class TenantIsolationTester:
    """ç§Ÿæˆ·éš”ç¦»æµ‹è¯•å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def test_isolation(self, tenant_id_1, tenant_id_2):
        """
        æµ‹è¯•ç§Ÿæˆ·éš”ç¦»æ€§

        Args:
            tenant_id_1: ç§Ÿæˆ·1 ID
            tenant_id_2: ç§Ÿæˆ·2 ID
        """

        results = {}

        # æµ‹è¯•1: ç§Ÿæˆ·1åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®
        self.cursor.execute(f"SET app.current_tenant = {tenant_id_1};")
        self.cursor.execute("SELECT COUNT(*) FROM documents;")
        count_1 = self.cursor.fetchone()[0]
        results['tenant_1_document_count'] = count_1

        # æµ‹è¯•2: ç§Ÿæˆ·2åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®
        self.cursor.execute(f"SET app.current_tenant = {tenant_id_2};")
        self.cursor.execute("SELECT COUNT(*) FROM documents;")
        count_2 = self.cursor.fetchone()[0]
        results['tenant_2_document_count'] = count_2

        # æµ‹è¯•3: éªŒè¯éš”ç¦»æ€§
        if count_1 != count_2:
            results['isolation_status'] = 'é€šè¿‡'
        else:
            results['isolation_status'] = 'å¤±è´¥'

        return results
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 RLSæ€§èƒ½ä¼˜åŒ–

**RLSæ€§èƒ½ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- RLSæ€§èƒ½ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION optimize_rls_performance()
RETURNS TABLE (
    table_name TEXT,
    rls_enabled BOOLEAN,
    index_exists BOOLEAN,
    recommendation TEXT
) AS $$
BEGIN
    BEGIN
        -- æ£€æŸ¥å¿…è¦çš„ç³»ç»Ÿè¡¨/è§†å›¾æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'pg_catalog' AND table_name = 'pg_class') THEN
            RAISE EXCEPTION 'ç³»ç»Ÿè¡¨ pg_class ä¸å¯è®¿é—®';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        SELECT
            t.tablename::TEXT,
            (SELECT relrowsecurity FROM pg_class WHERE relname = t.tablename) AS rls_enabled,
            EXISTS (
                SELECT 1 FROM pg_indexes
                WHERE tablename = t.tablename
                  AND indexname LIKE '%tenant%'
            ) AS index_exists,
            CASE
                WHEN NOT EXISTS (
                    SELECT 1 FROM pg_indexes
                    WHERE tablename = t.tablename
                      AND indexname LIKE '%tenant%'
                ) THEN 'å»ºè®®åœ¨tenant_idä¸Šåˆ›å»ºç´¢å¼•'
                ELSE 'ç´¢å¼•å·²å­˜åœ¨'
            END
        FROM pg_tables t
        WHERE schemaname = 'public'
          AND tablename IN ('users', 'documents', 'tenant_usage_stats');
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'RLSæ€§èƒ½ä¼˜åŒ–æ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 æŸ¥è¯¢ç¼“å­˜ä¼˜åŒ–

**æŸ¥è¯¢ç¼“å­˜ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
from functools import lru_cache
import hashlib

class QueryCache:
    """æŸ¥è¯¢ç¼“å­˜"""

    def __init__(self, maxsize=128):
        self.cache = {}
        self.maxsize = maxsize

    def get_cache_key(self, query, tenant_id, params):
        """ç”Ÿæˆç¼“å­˜é”®"""
        cache_str = f"{query}_{tenant_id}_{str(params)}"
        return hashlib.md5(cache_str.encode()).hexdigest()

    def get(self, query, tenant_id, params):
        """è·å–ç¼“å­˜"""
        cache_key = self.get_cache_key(query, tenant_id, params)
        return self.cache.get(cache_key)

    def set(self, query, tenant_id, params, result):
        """è®¾ç½®ç¼“å­˜"""
        cache_key = self.get_cache_key(query, tenant_id, params)

        # LRUæ·˜æ±°
        if len(self.cache) >= self.maxsize:
            # åˆ é™¤æœ€æ—§çš„é¡¹ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            oldest_key = next(iter(self.cache))
            del self.cache[oldest_key]

        self.cache[cache_key] = result

    def clear_tenant_cache(self, tenant_id):
        """æ¸…é™¤ç§Ÿæˆ·ç¼“å­˜"""
        keys_to_remove = [
            key for key in self.cache.keys()
            if key.startswith(hashlib.md5(str(tenant_id).encode()).hexdigest()[:8])
        ]
        for key in keys_to_remove:
            del self.cache[key]
```

---

## 8. ç›‘æ§ä¸è¯Šæ–­

### 8.1 ç§Ÿæˆ·èµ„æºç›‘æ§

**ç§Ÿæˆ·èµ„æºç›‘æ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·èµ„æºç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE WARNING 'è¡¨ tenants ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        CREATE OR REPLACE VIEW v_tenant_resource_usage AS
        SELECT
            t.tenant_id,
            t.tenant_name,
            t.plan_type,
            t.storage_quota_gb,
            COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 AS storage_used_gb,
            ROUND(
                COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 * 100.0 / NULLIF(t.storage_quota_gb, 0),
                2
            ) AS storage_usage_percent,
            COUNT(DISTINCT u.id) AS user_count,
            COUNT(DISTINCT d.id) AS document_count,
            t.connection_quota,
            (
                SELECT COUNT(*)
                FROM pg_stat_activity
                WHERE application_name LIKE 'tenant_' || t.tenant_id || '%'
            ) AS current_connections,
            CASE
                WHEN COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 >= t.storage_quota_gb THEN 'é…é¢å·²æ»¡'
                WHEN COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 >= t.storage_quota_gb * 0.8 THEN 'æ¥è¿‘é…é¢'
                ELSE 'æ­£å¸¸'
            END AS quota_status
        FROM tenants t
        LEFT JOIN users u ON t.tenant_id = u.tenant_id
        LEFT JOIN documents d ON t.tenant_id = d.tenant_id
        WHERE t.is_active = true
        GROUP BY t.tenant_id, t.tenant_name, t.plan_type, t.storage_quota_gb, t.connection_quota;
        RAISE NOTICE 'è§†å›¾ v_tenant_resource_usage åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_resource_usage') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_resource_usage ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·èµ„æºç›‘æ§æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·èµ„æºä½¿ç”¨æƒ…å†µï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_resource_usage') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_resource_usage ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·èµ„æºä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_tenant_resource_usage
ORDER BY storage_usage_percent DESC;
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**RLSç­–ç•¥**: tenant_idéš”ç¦»
**é…é¢**: å­˜å‚¨ + è¿æ¥ + API

---

## 7. PostgreSQL 18å¤šç§Ÿæˆ·ä¼˜åŒ–

### 7.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE WARNING 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°ï¼Œè·³è¿‡é…ç½®';
            RAISE NOTICE 'å®é™…é…ç½®éœ€è¦åœ¨postgresql.confä¸­è®¾ç½®æˆ–ä½¿ç”¨ALTER SYSTEMï¼š';
            RAISE NOTICE 'ALTER SYSTEM SET io_direct = ''data'';';
            RAISE NOTICE 'ALTER SYSTEM SET io_combine_limit = ''256kB'';';
            RAISE NOTICE 'ç„¶åæ‰§è¡Œï¼šSELECT pg_reload_conf();';
            RETURN;
        END IF;

        -- å®é™…é…ç½®éœ€è¦åœ¨postgresql.confä¸­è®¾ç½®æˆ–ä½¿ç”¨ALTER SYSTEMï¼š
        -- ALTER SYSTEM SET io_direct = 'data';
        -- ALTER SYSTEM SET io_combine_limit = '256kB';
        -- ç„¶åæ‰§è¡Œï¼šSELECT pg_reload_conf();
        RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²è®¾ç½®ï¼ˆéœ€è¦é‡å¯æˆ–reloadé…ç½®ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®å¼‚æ­¥I/Oå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ€§èƒ½æå‡:
-- RLSæŸ¥è¯¢æ€§èƒ½: +20-25%
-- å¤šç§Ÿæˆ·æ•°æ®æŸ¥è¯¢: +15-20%
-- ç§Ÿæˆ·æ•°æ®è¿ç§»: +30-35%
```

### 7.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET LOCAL max_parallel_workers_per_gather = 4;
        SET LOCAL parallel_setup_cost = 1000;
        SET LOCAL parallel_tuple_cost = 0.01;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å·²è®¾ç½®ï¼ˆä¼šè¯çº§åˆ«ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å¹¶è¡Œå¤šç§Ÿæˆ·æŸ¥è¯¢ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œå¤šç§Ÿæˆ·æŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·èšåˆç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç§Ÿæˆ·èšåˆç»Ÿè®¡æŸ¥è¯¢ï¼ˆPostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    tenant_id,
    COUNT(*) AS user_count,
    SUM(storage_used_bytes) AS total_storage
FROM users
GROUP BY tenant_id;

-- æ€§èƒ½æå‡:
-- å¤šç§Ÿæˆ·èšåˆæŸ¥è¯¢: +40-50%
```

---

## 8. å¤šç§Ÿæˆ·ç³»ç»Ÿç›‘æ§

### 8.1 ç§Ÿæˆ·æ€§èƒ½ç›‘æ§

**ç§Ÿæˆ·æ€§èƒ½ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·æ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenant_query_logs') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        CREATE OR REPLACE VIEW v_tenant_performance AS
        SELECT
            tenant_id,
            tenant_name,
            plan_type,
            COUNT(DISTINCT user_id) AS user_count,
            COUNT(*) AS query_count,
            AVG(query_duration_ms) AS avg_query_duration_ms,
            PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY query_duration_ms) AS p95_query_duration_ms,
            SUM(storage_used_bytes) AS total_storage_bytes,
            pg_size_pretty(SUM(storage_used_bytes)) AS total_storage
        FROM tenant_query_logs tql
        JOIN tenants t ON tql.tenant_id = t.tenant_id
        WHERE tql.created_at > NOW() - INTERVAL '24 hours'
        GROUP BY tenant_id, tenant_name, plan_type
        ORDER BY query_count DESC;
        RAISE NOTICE 'è§†å›¾ v_tenant_performance åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_performance') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_performance ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·æ€§èƒ½ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_performance') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_performance ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·æ€§èƒ½ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_tenant_performance
LIMIT 20;
```

### 8.2 ç§Ÿæˆ·é…é¢ç›‘æ§

**ç§Ÿæˆ·é…é¢ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç§Ÿæˆ·é…é¢ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE WARNING 'è¡¨ tenants ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        CREATE OR REPLACE VIEW v_tenant_quota_usage AS
        SELECT
            tenant_id,
            tenant_name,
            plan_type,
            storage_quota_gb,
            ROUND(storage_used_bytes / 1073741824.0, 2) AS storage_used_gb,
            ROUND((storage_used_bytes / 1073741824.0) * 100.0 / NULLIF(storage_quota_gb, 0), 2) AS storage_usage_pct,
            connection_quota,
            current_connections,
            ROUND(current_connections * 100.0 / NULLIF(connection_quota, 0), 2) AS connection_usage_pct,
            CASE
                WHEN (storage_used_bytes / 1073741824.0) > storage_quota_gb * 0.9 THEN 'warning'
                WHEN current_connections > connection_quota * 0.9 THEN 'warning'
                ELSE 'normal'
            END AS quota_status
        FROM tenants t
        LEFT JOIN (
            SELECT
                tenant_id,
                SUM(size_bytes) AS storage_used_bytes
            FROM documents
            GROUP BY tenant_id
        ) d ON t.tenant_id = d.tenant_id
        LEFT JOIN (
            SELECT
                tenant_id,
                COUNT(*) AS current_connections
            FROM pg_stat_activity
            WHERE application_name LIKE 'tenant_%'
            GROUP BY tenant_id
        ) c ON t.tenant_id = c.tenant_id;
        RAISE NOTICE 'è§†å›¾ v_tenant_quota_usage åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·é…é¢ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_quota_usage') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_quota_usage ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·é…é¢ä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ç§Ÿæˆ·é…é¢ä½¿ç”¨æƒ…å†µï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_tenant_quota_usage') THEN
            RAISE WARNING 'è§†å›¾ v_tenant_quota_usage ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢ç§Ÿæˆ·é…é¢ä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_tenant_quota_usage
WHERE quota_status = 'warning';
```

---

## 9. å¤šç§Ÿæˆ·ç³»ç»Ÿæœ€ä½³å®è·µ

### 9.1 RLSç­–ç•¥æœ€ä½³å®è·µ

**RLSç­–ç•¥æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ä½¿ç”¨ç´¢å¼•åŠ é€ŸRLSæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        CREATE INDEX IF NOT EXISTS idx_documents_tenant_user ON documents(tenant_id, user_id);
        CREATE INDEX IF NOT EXISTS idx_users_tenant ON users(tenant_id);
        CREATE INDEX IF NOT EXISTS idx_documents_tenant_created ON documents(tenant_id, created_at)
        WHERE tenant_id IS NOT NULL;
        RAISE NOTICE 'RLSåŠ é€Ÿç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 2. å®šæœŸåˆ†æRLSç­–ç•¥æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒRLSæ€§èƒ½åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒRLSç­–ç•¥æ€§èƒ½åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢æ–‡æ¡£ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒRLSç­–ç•¥æ€§èƒ½åˆ†ææŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE tenant_id = current_setting('app.current_tenant')::INT;

-- 3. ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆé¢„è®¡ç®—ç§Ÿæˆ·ç»Ÿè®¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç‰©åŒ–è§†å›¾';
            RETURN;
        END IF;
        DROP MATERIALIZED VIEW IF EXISTS mv_tenant_statistics;
        CREATE MATERIALIZED VIEW mv_tenant_statistics AS
        SELECT
            tenant_id,
            COUNT(DISTINCT user_id) AS user_count,
            COUNT(*) AS document_count,
            SUM(size_bytes) AS total_storage
        FROM documents
        GROUP BY tenant_id;
        CREATE UNIQUE INDEX ON mv_tenant_statistics(tenant_id);
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾ mv_tenant_statistics åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'mv_tenant_statistics') THEN
            RAISE WARNING 'ç‰©åŒ–è§†å›¾ mv_tenant_statistics ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°';
            RETURN;
        END IF;
        REFRESH MATERIALIZED VIEW CONCURRENTLY mv_tenant_statistics;
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾åˆ·æ–°æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ·æ–°ç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 9.2 ç§Ÿæˆ·æ•°æ®ç®¡ç†æœ€ä½³å®è·µ

**ç§Ÿæˆ·æ•°æ®ç®¡ç†æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ç§Ÿæˆ·æ•°æ®å½’æ¡£ï¼ˆå†·çƒ­åˆ†ç¦»ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå½’æ¡£è¡¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents_archive') THEN
            RAISE NOTICE 'å½’æ¡£è¡¨ documents_archive å·²å­˜åœ¨';
        ELSE
            CREATE TABLE documents_archive (
                LIKE documents INCLUDING ALL
            ) PARTITION BY RANGE (created_at);
            RAISE NOTICE 'å½’æ¡£è¡¨ documents_archive åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents_archive_2024') THEN
            RAISE NOTICE 'åˆ†åŒº documents_archive_2024 å·²å­˜åœ¨';
        ELSE
            CREATE TABLE documents_archive_2024 PARTITION OF documents_archive
            FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
            RAISE NOTICE 'åˆ†åŒº documents_archive_2024 åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨æˆ–åˆ†åŒºå·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'æºè¡¨ documents ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå½’æ¡£è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å½’æ¡£æ—§æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents_archive') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå½’æ¡£';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹å½’æ¡£æ—§æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å½’æ¡£å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ‰§è¡Œå½’æ¡£æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_inserted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents_archive') THEN
            RAISE WARNING 'è¡¨ documents_archive ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå½’æ¡£';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå½’æ¡£';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå½’æ¡£æ“ä½œï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å½’æ¡£å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ‰§è¡Œå½’æ¡£æ“ä½œï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents_archive') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå½’æ¡£';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ•°æ®å½’æ¡£æ“ä½œï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å½’æ¡£å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
INSERT INTO documents_archive
SELECT * FROM documents
WHERE created_at < NOW() - INTERVAL '1 year'
    AND tenant_id = current_setting('app.current_tenant')::INT;

DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œåˆ é™¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ é™¤å·²å½’æ¡£æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ é™¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_deleted_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œåˆ é™¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ é™¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
DELETE FROM documents
WHERE created_at < NOW() - INTERVAL '1 year'
    AND tenant_id = current_setting('app.current_tenant')::INT;

-- 2. ç§Ÿæˆ·æ•°æ®å¤‡ä»½ï¼ˆæŒ‰ç§Ÿæˆ·å¤‡ä»½ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION backup_tenant_data(p_tenant_id INT)
RETURNS TEXT AS $$
DECLARE
    v_backup_file TEXT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_tenant_id IS NULL OR p_tenant_id <= 0 THEN
            RAISE EXCEPTION 'tenant_idå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') OR
           NOT EXISTS (SELECT 1 FROM tenants WHERE tenant_id = p_tenant_id) THEN
            RAISE EXCEPTION 'ç§Ÿæˆ· % ä¸å­˜åœ¨', p_tenant_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        v_backup_file := format('/backups/tenant_%s_%s.dump', p_tenant_id, to_char(NOW(), 'YYYYMMDD'));

        -- æ³¨æ„ï¼špg_dumpæ˜¯å¤–éƒ¨å‘½ä»¤ï¼Œä¸èƒ½åœ¨PL/pgSQLä¸­ç›´æ¥è°ƒç”¨
        -- å®é™…å®ç°éœ€è¦ä½¿ç”¨PL/shæˆ–å¤–éƒ¨è„šæœ¬
        RAISE NOTICE 'å¤‡ä»½æ–‡ä»¶è·¯å¾„: %', v_backup_file;
        RAISE NOTICE 'æç¤ºï¼šå®é™…å¤‡ä»½éœ€è¦ä½¿ç”¨å¤–éƒ¨å·¥å…·ï¼ˆå¦‚pg_dumpå‘½ä»¤è¡Œå·¥å…·ï¼‰æˆ–PL/shæ‰©å±•';

        RETURN v_backup_file;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”Ÿæˆå¤‡ä»½æ–‡ä»¶è·¯å¾„å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 3. ç§Ÿæˆ·æ•°æ®æ¸…ç†ï¼ˆå®šæœŸæ¸…ç†ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION cleanup_tenant_data(
    p_tenant_id INT,
    p_retention_days INT DEFAULT 90
)
RETURNS TABLE (
    deleted_count BIGINT,
    freed_space TEXT
) AS $$
DECLARE
    v_deleted BIGINT;
    v_size_before BIGINT;
    v_size_after BIGINT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_tenant_id IS NULL OR p_tenant_id <= 0 THEN
            RAISE EXCEPTION 'tenant_idå¿…é¡»å¤§äº0';
        END IF;

        IF p_retention_days IS NULL OR p_retention_days <= 0 THEN
            RAISE EXCEPTION 'retention_dayså¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') OR
           NOT EXISTS (SELECT 1 FROM tenants WHERE tenant_id = p_tenant_id) THEN
            RAISE EXCEPTION 'ç§Ÿæˆ· % ä¸å­˜åœ¨', p_tenant_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- è®°å½•åˆ é™¤å‰å¤§å°
        SELECT pg_total_relation_size('documents') INTO v_size_before;

        IF v_size_before IS NULL THEN
            v_size_before := 0;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ¸…ç†ç§Ÿæˆ· % çš„æ•°æ®ï¼ˆä¿ç•™ % å¤©ï¼‰', p_tenant_id, p_retention_days;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•åˆ é™¤å‰å¤§å°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- åˆ é™¤æ—§æ•°æ®
        DELETE FROM documents
        WHERE tenant_id = p_tenant_id
            AND created_at < NOW() - (p_retention_days || ' days')::INTERVAL;

        GET DIAGNOSTICS v_deleted = ROW_COUNT;

        RAISE NOTICE 'åˆ é™¤äº† % æ¡è®°å½•', v_deleted;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ é™¤æ—§æ•°æ®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- è®°å½•åˆ é™¤åå¤§å°
        SELECT pg_total_relation_size('documents') INTO v_size_after;

        IF v_size_after IS NULL THEN
            v_size_after := 0;
        END IF;

        -- VACUUMå›æ”¶ç©ºé—´ï¼ˆæ³¨æ„ï¼šVACUUMä¸èƒ½åœ¨å‡½æ•°ä¸­æ‰§è¡Œï¼Œéœ€è¦å¤–éƒ¨è°ƒç”¨ï¼‰
        RAISE NOTICE 'å»ºè®®åœ¨å‡½æ•°å¤–éƒ¨æ‰§è¡Œ VACUUM documents ä»¥å›æ”¶ç©ºé—´';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•åˆ é™¤åå¤§å°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY SELECT
            v_deleted,
            pg_size_pretty(GREATEST(v_size_before - v_size_after, 0));
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¿”å›æ¸…ç†ç»“æœå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

**è¿”å›**: [æ¡ˆä¾‹4ä¸»é¡µ](./README.md)
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: ç§Ÿæˆ·ç®¡ç†ã€ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€RLSç­–ç•¥ã€æ•°æ®è¿ç§»ã€éš”ç¦»éªŒè¯ã€PostgreSQL 18ä¼˜åŒ–ã€ç›‘æ§ã€æœ€ä½³å®è·µ
