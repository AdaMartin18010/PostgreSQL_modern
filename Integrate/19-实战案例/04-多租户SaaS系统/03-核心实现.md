---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\03-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹4ï¼šå¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **æŠ€æœ¯æ ˆ**: FastAPI + PostgreSQL 18 + RLS
- **ä»£ç é‡**: ~1,800è¡Œ

---

## 1. ç§Ÿæˆ·ç®¡ç†æ¨¡å—

```python
"""
å¤šç§Ÿæˆ·ç®¡ç†æ¨¡å—
"""

import psycopg2
from fastapi import FastAPI, Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
import jwt
from datetime import datetime, timedelta

app = FastAPI()
security = HTTPBearer()

# JWTé…ç½®
JWT_SECRET = "your-secret-key"
JWT_ALGORITHM = "HS256"

class TenantManager:
    """ç§Ÿæˆ·ç®¡ç†å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def create_tenant(self, tenant_name, plan_type='free'):
        """
        åˆ›å»ºæ–°ç§Ÿæˆ·

        Args:
            tenant_name: ç§Ÿæˆ·åç§°
            plan_type: å¥—é¤ç±»å‹ (free/pro/enterprise)
        """

        # æ ¹æ®å¥—é¤è®¾ç½®é…é¢
        quotas = {
            'free': {'storage_gb': 1, 'connections': 5},
            'pro': {'storage_gb': 10, 'connections': 20},
            'enterprise': {'storage_gb': 100, 'connections': 100}
        }

        quota = quotas.get(plan_type, quotas['free'])

        self.cursor.execute("""
            INSERT INTO tenants (tenant_name, plan_type, storage_quota_gb, connection_quota)
            VALUES (%s, %s, %s, %s)
            RETURNING tenant_id;
        """, (tenant_name, plan_type, quota['storage_gb'], quota['connections']))

        tenant_id = self.cursor.fetchone()[0]
        self.conn.commit()

        # åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®
        self._initialize_tenant_data(tenant_id)

        return tenant_id

    def _initialize_tenant_data(self, tenant_id):
        """åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®"""

        # è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        self.cursor.execute(f"SET app.current_tenant = {tenant_id};")

        # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
        self.cursor.execute("""
            INSERT INTO users (tenant_id, username, email, password_hash)
            VALUES (%s, 'admin', 'admin@example.com', 'hashed_password');
        """, (tenant_id,))

        self.conn.commit()
        print(f"âœ… ç§Ÿæˆ· {tenant_id} åˆå§‹åŒ–å®Œæˆ")
```

---

## 2. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶

```python
from contextvars import ContextVar

# å½“å‰ç§Ÿæˆ·IDä¸Šä¸‹æ–‡
current_tenant_id = ContextVar('current_tenant_id', default=None)

def get_current_tenant() -> int:
    """è·å–å½“å‰ç§Ÿæˆ·ID"""
    tenant_id = current_tenant_id.get()
    if tenant_id is None:
        raise HTTPException(status_code=401, detail="æœªè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡")
    return tenant_id

async def set_tenant_context(credentials: HTTPAuthorizationCredentials = Depends(security)):
    """
    ä»JWT Tokenè§£æç§Ÿæˆ·IDå¹¶è®¾ç½®ä¸Šä¸‹æ–‡
    """

    try:
        token = credentials.credentials
        payload = jwt.decode(token, JWT_SECRET, algorithms=[JWT_ALGORITHM])
        tenant_id = payload.get('tenant_id')

        if not tenant_id:
            raise HTTPException(status_code=401, detail="Tokenä¸­æ— ç§Ÿæˆ·ä¿¡æ¯")

        # è®¾ç½®ä¸Šä¸‹æ–‡
        current_tenant_id.set(tenant_id)

        return tenant_id

    except jwt.JWTError:
        raise HTTPException(status_code=401, detail="Tokenæ— æ•ˆ")

# æ•°æ®åº“è¿æ¥ + è®¾ç½®RLSä¸Šä¸‹æ–‡
def get_db_with_tenant():
    """è·å–å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„æ•°æ®åº“è¿æ¥"""

    tenant_id = get_current_tenant()

    conn = psycopg2.connect("dbname=saas_db user=postgres")
    cursor = conn.cursor()

    # è®¾ç½®ç§Ÿæˆ·IDï¼ˆRLSä½¿ç”¨ï¼‰
    cursor.execute(f"SET app.current_tenant = {tenant_id};")

    return conn
```

---

## 3. APIå®ç°

```python
@app.post("/api/documents")
async def create_document(
    document: dict,
    tenant_id: int = Depends(set_tenant_context),
    conn = Depends(get_db_with_tenant)
):
    """
    åˆ›å»ºæ–‡æ¡£ï¼ˆè‡ªåŠ¨åº”ç”¨RLSï¼‰
    """

    cursor = conn.cursor()

    try:
        cursor.execute("""
            INSERT INTO documents (tenant_id, user_id, title, content, size_bytes)
            VALUES (%s, %s, %s, %s, %s)
            RETURNING id;
        """, (tenant_id, document['user_id'], document['title'],
              document['content'], len(document['content'])))

        doc_id = cursor.fetchone()[0]
        conn.commit()

        return {"success": True, "document_id": doc_id}

    except Exception as e:
        conn.rollback()
        raise HTTPException(status_code=400, detail=str(e))

    finally:
        cursor.close()
        conn.close()

@app.get("/api/documents")
async def list_documents(
    tenant_id: int = Depends(set_tenant_context),
    conn = Depends(get_db_with_tenant)
):
    """
    åˆ—å‡ºæ–‡æ¡£ï¼ˆRLSè‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®ï¼‰
    """

    cursor = conn.cursor()

    try:
        # RLSä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œåªè¿”å›å½“å‰ç§Ÿæˆ·çš„æ•°æ®
        cursor.execute("""
            SELECT id, title, size_bytes, created_at
            FROM documents
            ORDER BY created_at DESC
            LIMIT 100;
        """)

        results = cursor.fetchall()

        return {
            "success": True,
            "documents": [
                {"id": r[0], "title": r[1], "size_bytes": r[2], "created_at": r[3]}
                for r in results
            ]
        }

    finally:
        cursor.close()
        conn.close()
```

---

## 4. é…é¢æ£€æŸ¥æ¨¡å—

```python
class QuotaChecker:
    """é…é¢æ£€æŸ¥å™¨"""

    def __init__(self, conn, tenant_id):
        self.conn = conn
        self.cursor = conn.cursor()
        self.tenant_id = tenant_id

    def check_storage_quota(self) -> bool:
        """æ£€æŸ¥å­˜å‚¨é…é¢"""

        self.cursor.execute("""
            SELECT
                COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 AS used_gb,
                t.storage_quota_gb
            FROM tenants t
            LEFT JOIN documents d ON t.tenant_id = d.tenant_id
            WHERE t.tenant_id = %s
            GROUP BY t.storage_quota_gb;
        """, (self.tenant_id,))

        result = self.cursor.fetchone()
        if not result:
            return True

        used_gb, quota_gb = result
        return used_gb < quota_gb

    def get_quota_usage(self):
        """è·å–é…é¢ä½¿ç”¨æƒ…å†µ"""

        self.cursor.execute("""
            SELECT
                t.storage_quota_gb,
                COALESCE(SUM(d.size_bytes), 0) / 1024.0 / 1024.0 / 1024.0 AS used_gb,
                COUNT(DISTINCT d.id) AS document_count,
                COUNT(DISTINCT u.id) AS user_count
            FROM tenants t
            LEFT JOIN documents d ON t.tenant_id = d.tenant_id
            LEFT JOIN users u ON t.tenant_id = u.tenant_id
            WHERE t.tenant_id = %s
            GROUP BY t.storage_quota_gb;
        """, (self.tenant_id,))

        result = self.cursor.fetchone()

        return {
            'quota_gb': result[0],
            'used_gb': float(result[1]),
            'usage_percent': (float(result[1]) / result[0] * 100) if result[0] > 0 else 0,
            'document_count': result[2],
            'user_count': result[3]
        }
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**RLSç­–ç•¥**: tenant_idéš”ç¦»
**é…é¢**: å­˜å‚¨ + è¿æ¥ + API

**è¿”å›**: [æ¡ˆä¾‹4ä¸»é¡µ](./README.md)
