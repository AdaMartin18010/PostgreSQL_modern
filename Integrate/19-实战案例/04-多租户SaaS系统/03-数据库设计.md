---

> **📋 文档来源**: `DataBaseTheory\19-场景案例库\04-多租户SaaS系统\03-数据库设计.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 案例4：多租户SaaS系统 - 数据库设计

## 元数据

- **创建日期**: 2025-12-04
- **隔离策略**: Row Level Security (RLS)
- **租户数**: 1000+

---

## 1. Schema设计

```sql
-- 1. 租户表
CREATE TABLE tenants (
    tenant_id SERIAL PRIMARY KEY,
    tenant_name VARCHAR(100) NOT NULL UNIQUE,
    plan_type VARCHAR(50) NOT NULL,  -- free/pro/enterprise
    storage_quota_gb INT DEFAULT 10,
    connection_quota INT DEFAULT 10,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT true
);

-- 2. 用户表（多租户）
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (tenant_id, email)
);

-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- RLS策略
CREATE POLICY tenant_isolation_policy ON users
    USING (tenant_id = current_setting('app.current_tenant', true)::integer);

-- 租户ID索引（RLS性能关键）
CREATE INDEX idx_users_tenant ON users (tenant_id);

-- 3. 业务数据表（示例：文档表）
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    title VARCHAR(255) NOT NULL,
    content TEXT,
    size_bytes BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 启用RLS
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

-- RLS策略
CREATE POLICY tenant_isolation_policy ON documents
    USING (tenant_id = current_setting('app.current_tenant', true)::integer);

-- 索引
CREATE INDEX idx_documents_tenant ON documents (tenant_id);
CREATE INDEX idx_documents_user ON documents (user_id);
CREATE INDEX idx_documents_created ON documents (created_at);

-- 4. 资源使用统计表
CREATE TABLE tenant_usage_stats (
    id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
    stat_date DATE NOT NULL,
    storage_used_gb NUMERIC(10,2),
    api_calls INT,
    active_users INT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (tenant_id, stat_date)
);
```

---

## 2. 资源配额实现

```sql
-- 存储配额检查函数
CREATE OR REPLACE FUNCTION check_storage_quota()
RETURNS TRIGGER AS $$
DECLARE
    current_usage_gb NUMERIC;
    quota_gb INT;
BEGIN
    -- 查询当前租户的存储使用量
    SELECT
        COALESCE(SUM(size_bytes), 0) / 1024.0 / 1024.0 / 1024.0,
        t.storage_quota_gb
    INTO current_usage_gb, quota_gb
    FROM documents d
    JOIN tenants t ON d.tenant_id = t.tenant_id
    WHERE d.tenant_id = NEW.tenant_id
    GROUP BY t.storage_quota_gb;

    -- 检查是否超配额
    IF current_usage_gb + (NEW.size_bytes / 1024.0 / 1024.0 / 1024.0) > quota_gb THEN
        RAISE EXCEPTION '存储配额已满: 当前%.2fGB, 配额%GB', current_usage_gb, quota_gb;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 绑定触发器
CREATE TRIGGER trg_check_storage_quota
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION check_storage_quota();
```

---

## 3. 性能优化

```sql
-- 分区表（提升RLS性能）
CREATE TABLE users_partitioned (
    id BIGSERIAL,
    tenant_id INT NOT NULL,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
) PARTITION BY HASH (tenant_id);

-- 创建16个分区
DO $$
BEGIN
    FOR i IN 0..15 LOOP
        EXECUTE format('
            CREATE TABLE users_p%s PARTITION OF users_partitioned
            FOR VALUES WITH (MODULUS 16, REMAINDER %s);
        ', i, i);
    END LOOP;
END $$;

-- 每个分区独立索引
-- 自动创建，无需手动
```

---

**完成日期**: 2025-12-04
**隔离策略**: RLS + 分区表
**配额**: 存储 + 连接 + API

**返回**: [案例4主页](./README.md)
