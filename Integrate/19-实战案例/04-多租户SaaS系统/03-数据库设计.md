---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ\03-æ•°æ®åº“è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹4ï¼šå¤šç§Ÿæˆ·SaaSç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **éš”ç¦»ç­–ç•¥**: Row Level Security (RLS)
- **ç§Ÿæˆ·æ•°**: 1000+

---

## 1. Schemaè®¾è®¡

```sql
-- 1. ç§Ÿæˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            CREATE TABLE tenants (
                tenant_id SERIAL PRIMARY KEY,
                tenant_name VARCHAR(100) NOT NULL UNIQUE,
                plan_type VARCHAR(50) NOT NULL,  -- free/pro/enterprise
                storage_quota_gb INT DEFAULT 10,
                connection_quota INT DEFAULT 10,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT true
            );
            RAISE NOTICE 'ç§Ÿæˆ·è¡¨ tenants åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç§Ÿæˆ·è¡¨ tenants å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç§Ÿæˆ·è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç§Ÿæˆ·è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ç”¨æˆ·è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            CREATE TABLE users (
                id BIGSERIAL PRIMARY KEY,
                tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
                username VARCHAR(100) NOT NULL,
                email VARCHAR(255) NOT NULL,
                password_hash TEXT NOT NULL,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                UNIQUE (tenant_id, email)
            );
            RAISE NOTICE 'ç”¨æˆ·è¡¨ users åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç”¨æˆ·è¡¨ users å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç”¨æˆ·è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç”¨æˆ·è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¯ç”¨RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            ALTER TABLE users ENABLE ROW LEVEL SECURITY;
            RAISE NOTICE 'RLSå·²å¯ç”¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- RLSç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºRLSç­–ç•¥';
            RETURN;
        END IF;
        
        DROP POLICY IF EXISTS tenant_isolation_policy ON users;
        CREATE POLICY tenant_isolation_policy ON users
            USING (tenant_id = current_setting('app.current_tenant', true)::integer);
        RAISE NOTICE 'RLSç­–ç•¥ tenant_isolation_policy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºRLSç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç§Ÿæˆ·IDç´¢å¼•ï¼ˆRLSæ€§èƒ½å…³é”®ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_users_tenant') THEN
            CREATE INDEX idx_users_tenant ON users (tenant_id);
            RAISE NOTICE 'ç´¢å¼• idx_users_tenant åˆ›å»ºæˆåŠŸï¼ˆRLSæ€§èƒ½å…³é”®ï¼‰';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_users_tenant å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä¸šåŠ¡æ•°æ®è¡¨ï¼ˆç¤ºä¾‹ï¼šæ–‡æ¡£è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            CREATE TABLE documents (
                id BIGSERIAL PRIMARY KEY,
                tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
                user_id BIGINT NOT NULL REFERENCES users(id),
                title VARCHAR(255) NOT NULL,
                content TEXT,
                size_bytes BIGINT,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            );
            RAISE NOTICE 'æ–‡æ¡£è¡¨ documents åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ–‡æ¡£è¡¨ documents å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'æ–‡æ¡£è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ–‡æ¡£è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¯ç”¨RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            ALTER TABLE documents ENABLE ROW LEVEL SECURITY;
            RAISE NOTICE 'RLSå·²å¯ç”¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- RLSç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºRLSç­–ç•¥';
            RETURN;
        END IF;
        
        DROP POLICY IF EXISTS tenant_isolation_policy ON documents;
        CREATE POLICY tenant_isolation_policy ON documents
            USING (tenant_id = current_setting('app.current_tenant', true)::integer);
        RAISE NOTICE 'RLSç­–ç•¥ tenant_isolation_policy åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºRLSç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œè·³è¿‡ç´¢å¼•åˆ›å»º';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_documents_tenant') THEN
            CREATE INDEX idx_documents_tenant ON documents (tenant_id);
            RAISE NOTICE 'ç´¢å¼• idx_documents_tenant åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_documents_tenant å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_documents_user') THEN
            CREATE INDEX idx_documents_user ON documents (user_id);
            RAISE NOTICE 'ç´¢å¼• idx_documents_user åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_documents_user å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_documents_created') THEN
            CREATE INDEX idx_documents_created ON documents (created_at);
            RAISE NOTICE 'ç´¢å¼• idx_documents_created åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_documents_created å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. èµ„æºä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenant_usage_stats') THEN
            CREATE TABLE tenant_usage_stats (
                id BIGSERIAL PRIMARY KEY,
                tenant_id INT NOT NULL REFERENCES tenants(tenant_id),
                stat_date DATE NOT NULL,
                storage_used_gb NUMERIC(10,2),
                api_calls INT,
                active_users INT,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                UNIQUE (tenant_id, stat_date)
            );
            RAISE NOTICE 'èµ„æºä½¿ç”¨ç»Ÿè®¡è¡¨ tenant_usage_stats åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'èµ„æºä½¿ç”¨ç»Ÿè®¡è¡¨ tenant_usage_stats å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'èµ„æºä½¿ç”¨ç»Ÿè®¡è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºèµ„æºä½¿ç”¨ç»Ÿè®¡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. èµ„æºé…é¢å®ç°

```sql
-- å­˜å‚¨é…é¢æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_storage_quota()
RETURNS TRIGGER AS $$
DECLARE
    current_usage_gb NUMERIC;
    quota_gb INT;
BEGIN
    BEGIN
        IF NEW.tenant_id IS NULL THEN
            RAISE EXCEPTION 'tenant_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NEW.size_bytes IS NULL OR NEW.size_bytes < 0 THEN
            RAISE EXCEPTION 'size_byteså¿…é¡»å¤§äºç­‰äº0';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
        
        -- æŸ¥è¯¢å½“å‰ç§Ÿæˆ·çš„å­˜å‚¨ä½¿ç”¨é‡
        SELECT
            COALESCE(SUM(size_bytes), 0) / 1024.0 / 1024.0 / 1024.0,
            t.storage_quota_gb
        INTO current_usage_gb, quota_gb
        FROM documents d
        JOIN tenants t ON d.tenant_id = t.tenant_id
        WHERE d.tenant_id = NEW.tenant_id
        GROUP BY t.storage_quota_gb;

        -- æ£€æŸ¥æ˜¯å¦è¶…é…é¢
        IF current_usage_gb + (NEW.size_bytes / 1024.0 / 1024.0 / 1024.0) > quota_gb THEN
            RAISE EXCEPTION 'å­˜å‚¨é…é¢å·²æ»¡: å½“å‰%.2fGB, é…é¢%GB', current_usage_gb, quota_gb;
        END IF;

        RETURN NEW;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å­˜å‚¨é…é¢æ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- ç»‘å®šè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;
        
        DROP TRIGGER IF EXISTS trg_check_storage_quota ON documents;
        CREATE TRIGGER trg_check_storage_quota
            BEFORE INSERT OR UPDATE ON documents
            FOR EACH ROW EXECUTE FUNCTION check_storage_quota();
        
        RAISE NOTICE 'è§¦å‘å™¨ trg_check_storage_quota åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. æ€§èƒ½ä¼˜åŒ–

```sql
-- åˆ†åŒºè¡¨ï¼ˆæå‡RLSæ€§èƒ½ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users_partitioned') THEN
            CREATE TABLE users_partitioned (
                id BIGSERIAL,
                tenant_id INT NOT NULL,
                username VARCHAR(100) NOT NULL,
                email VARCHAR(255) NOT NULL,
                password_hash TEXT NOT NULL,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            ) PARTITION BY HASH (tenant_id);
            RAISE NOTICE 'åˆ†åŒºè¡¨ users_partitioned åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'åˆ†åŒºè¡¨ users_partitioned å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'åˆ†åŒºè¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»º16ä¸ªåˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    partition_name TEXT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users_partitioned') THEN
            RAISE WARNING 'è¡¨ users_partitioned ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒº';
            RETURN;
        END IF;
        
        FOR i IN 0..15 LOOP
            partition_name := 'users_p' || i;
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = partition_name) THEN
                EXECUTE format('
                    CREATE TABLE %I PARTITION OF users_partitioned
                    FOR VALUES WITH (MODULUS 16, REMAINDER %s);
                ', partition_name, i);
                RAISE NOTICE 'åˆ†åŒº % åˆ›å»ºæˆåŠŸ', partition_name;
            ELSE
                RAISE NOTICE 'åˆ†åŒº % å·²å­˜åœ¨', partition_name;
            END IF;
        END LOOP;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'åˆ†åŒºå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ¯ä¸ªåˆ†åŒºç‹¬ç«‹ç´¢å¼•
-- è‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨
```

---

---

## 4. RLSç­–ç•¥ä¼˜åŒ–

### 4.1 RLSæ€§èƒ½ä¼˜åŒ–

**RLSæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ä¼˜åŒ–RLSç­–ç•¥ï¼ˆä½¿ç”¨ç´¢å¼•å‹å¥½çš„è°“è¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•ä¼˜åŒ–RLSç­–ç•¥';
            RETURN;
        END IF;
        
        DROP POLICY IF EXISTS tenant_isolation_policy ON users;
        CREATE POLICY tenant_isolation_policy ON users
            USING (tenant_id = current_setting('app.current_tenant', true)::integer)
            WITH CHECK (tenant_id = current_setting('app.current_tenant', true)::integer);
        
        RAISE NOTICE 'RLSç­–ç•¥ tenant_isolation_policy ä¼˜åŒ–æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¼˜åŒ–RLSç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ç¡®ä¿tenant_idä¸Šæœ‰ç´¢å¼•ï¼ˆå·²åœ¨å‰é¢åˆ›å»ºï¼‰
-- CREATE INDEX idx_users_tenant ON users (tenant_id);

-- 3. ä½¿ç”¨å®‰å…¨å®šä¹‰è€…å‡½æ•°ç»•è¿‡RLSï¼ˆåªè¯»æŠ¥è¡¨ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION get_tenant_stats(p_tenant_id INT)
RETURNS TABLE (
    user_count BIGINT,
    document_count BIGINT,
    storage_used_gb NUMERIC
)
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    BEGIN
        IF p_tenant_id IS NULL THEN
            RAISE EXCEPTION 'tenant_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
        
        RETURN QUERY
        SELECT
            (SELECT COUNT(*) FROM users WHERE tenant_id = p_tenant_id)::BIGINT,
            (SELECT COUNT(*) FROM documents WHERE tenant_id = p_tenant_id)::BIGINT,
            (SELECT COALESCE(SUM(size_bytes), 0) / 1024.0 / 1024.0 / 1024.0
             FROM documents WHERE tenant_id = p_tenant_id)::NUMERIC;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–ç§Ÿæˆ·ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 4.2 è¿æ¥é…é¢ç®¡ç†

**è¿æ¥é…é¢ç®¡ç†å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è¿æ¥é…é¢æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_connection_quota(
    p_tenant_id INT
)
RETURNS TABLE (
    current_connections INT,
    quota INT,
    available_connections INT,
    status TEXT
) AS $$
DECLARE
    current_conn INT;
    quota_val INT;
BEGIN
    BEGIN
        IF p_tenant_id IS NULL THEN
            RAISE EXCEPTION 'tenant_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenants') THEN
            RAISE EXCEPTION 'è¡¨ tenants ä¸å­˜åœ¨';
        END IF;
        
        -- è·å–å½“å‰è¿æ¥æ•°ï¼ˆç®€åŒ–å¤„ç†ï¼‰
        SELECT COUNT(*) INTO current_conn
        FROM pg_stat_activity
        WHERE application_name LIKE 'tenant_' || p_tenant_id || '%';

        -- è·å–é…é¢
        SELECT connection_quota INTO quota_val
        FROM tenants
        WHERE tenant_id = p_tenant_id;
        
        IF quota_val IS NULL THEN
            RAISE EXCEPTION 'ç§Ÿæˆ· % ä¸å­˜åœ¨', p_tenant_id;
        END IF;

        RETURN QUERY SELECT
            current_conn,
            quota_val,
            quota_val - current_conn,
            CASE
                WHEN current_conn >= quota_val THEN 'é…é¢å·²æ»¡'
                WHEN current_conn >= quota_val * 0.8 THEN 'æ¥è¿‘é…é¢'
                ELSE 'æ­£å¸¸'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ£€æŸ¥è¿æ¥é…é¢å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- è°ƒç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM check_connection_quota(1)
LIMIT 100;
```

---

## 5. èµ„æºä½¿ç”¨ç»Ÿè®¡

### 5.1 èµ„æºä½¿ç”¨ç»Ÿè®¡å‡½æ•°

**èµ„æºä½¿ç”¨ç»Ÿè®¡å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ›´æ–°èµ„æºä½¿ç”¨ç»Ÿè®¡ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_tenant_usage_stats(
    p_tenant_id INT,
    p_stat_date DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
    tenant_id INT,
    storage_used_gb NUMERIC,
    api_calls INT,
    active_users INT
) AS $$
DECLARE
    storage_val NUMERIC;
    api_calls_val INT;
    active_users_val INT;
BEGIN
    BEGIN
        IF p_tenant_id IS NULL THEN
            RAISE EXCEPTION 'tenant_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF p_stat_date IS NULL THEN
            RAISE EXCEPTION 'stat_dateä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tenant_usage_stats') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
        
        -- è®¡ç®—å­˜å‚¨ä½¿ç”¨é‡
        SELECT COALESCE(SUM(size_bytes), 0) / 1024.0 / 1024.0 / 1024.0
        INTO storage_val
        FROM documents
        WHERE tenant_id = p_tenant_id;

        -- è®¡ç®—APIè°ƒç”¨æ•°ï¼ˆç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»APIæ—¥å¿—è¡¨è·å–ï¼‰
        SELECT COALESCE(COUNT(*), 0) INTO api_calls_val
        FROM search_logs
        WHERE created_at::DATE = p_stat_date;

        -- è®¡ç®—æ´»è·ƒç”¨æˆ·æ•°
        SELECT COUNT(DISTINCT user_id) INTO active_users_val
        FROM documents
        WHERE tenant_id = p_tenant_id
          AND updated_at > NOW() - INTERVAL '7 days';

        -- æ’å…¥æˆ–æ›´æ–°ç»Ÿè®¡
        INSERT INTO tenant_usage_stats (
            tenant_id, stat_date, storage_used_gb, api_calls, active_users
        )
        VALUES (
            p_tenant_id, p_stat_date, storage_val, api_calls_val, active_users_val
        )
        ON CONFLICT (tenant_id, stat_date) DO UPDATE
        SET storage_used_gb = EXCLUDED.storage_used_gb,
            api_calls = EXCLUDED.api_calls,
            active_users = EXCLUDED.active_users;

        RETURN QUERY SELECT
            p_tenant_id,
            storage_val,
            api_calls_val,
            active_users_val;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°èµ„æºä½¿ç”¨ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆä½¿ç”¨pg_cronï¼‰
SELECT cron.schedule(
    'update-tenant-stats',
    '0 1 * * *',  -- æ¯å¤©å‡Œæ™¨1ç‚¹
    'SELECT update_tenant_usage_stats(tenant_id) FROM tenants WHERE is_active = true'
);
```

---

## 6. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»éªŒè¯

### 6.1 éš”ç¦»æ€§æµ‹è¯•

**éš”ç¦»æ€§æµ‹è¯•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æµ‹è¯•æ•°æ®éš”ç¦»ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION test_tenant_isolation(
    p_tenant_id_1 INT,
    p_tenant_id_2 INT
)
RETURNS TABLE (
    test_item TEXT,
    tenant_1_count BIGINT,
    tenant_2_count BIGINT,
    isolation_status TEXT
) AS $$
DECLARE
    count_1 BIGINT;
    count_2 BIGINT;
BEGIN
    BEGIN
        IF p_tenant_id_1 IS NULL OR p_tenant_id_2 IS NULL THEN
            RAISE EXCEPTION 'tenant_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF p_tenant_id_1 = p_tenant_id_2 THEN
            RAISE EXCEPTION 'ä¸¤ä¸ªtenant_idå¿…é¡»ä¸åŒ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE EXCEPTION 'è¡¨ users ä¸å­˜åœ¨';
        END IF;
        
        -- è®¾ç½®ç§Ÿæˆ·1ä¸Šä¸‹æ–‡
        PERFORM set_config('app.current_tenant', p_tenant_id_1::TEXT, false);

        -- è·å–ç§Ÿæˆ·1çš„ç”¨æˆ·æ•°
        SELECT COUNT(*) INTO count_1 FROM users;

        -- è®¾ç½®ç§Ÿæˆ·2ä¸Šä¸‹æ–‡
        PERFORM set_config('app.current_tenant', p_tenant_id_2::TEXT, false);

        -- è·å–ç§Ÿæˆ·2çš„ç”¨æˆ·æ•°
        SELECT COUNT(*) INTO count_2 FROM users;

        -- éªŒè¯éš”ç¦»æ€§
        RETURN QUERY
        SELECT
            'ç”¨æˆ·æ•°'::TEXT,
            count_1,
            count_2,
            CASE
                WHEN count_1 != count_2 THEN 'éš”ç¦»æ­£å¸¸'
                ELSE 'éš”ç¦»å¼‚å¸¸'
            END;

        RETURN;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'éš”ç¦»æ€§æµ‹è¯•å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- è°ƒç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM test_tenant_isolation(1, 2)
LIMIT 100;
```

---

## 7. PostgreSQL 18ä¼˜åŒ–è®¾è®¡

### 7.1 RLSæ€§èƒ½ä¼˜åŒ–

**RLSæ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š

```sql
-- PostgreSQL 18 RLSä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡RLSä¼˜åŒ–';
            RETURN;
        END IF;
        
        -- 1. ç­–ç•¥ä¸‹æ¨ä¼˜åŒ–
        IF EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'users' AND column_name = 'tenant_id'
        ) THEN
            ALTER TABLE users ALTER COLUMN tenant_id SET STATISTICS 1000;
            RAISE NOTICE 'users.tenant_idç»Ÿè®¡ä¿¡æ¯è®¾ç½®æˆåŠŸ';
        END IF;
        
        IF EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'documents' AND column_name = 'tenant_id'
        ) THEN
            ALTER TABLE documents ALTER COLUMN tenant_id SET STATISTICS 1000;
            RAISE NOTICE 'documents.tenant_idç»Ÿè®¡ä¿¡æ¯è®¾ç½®æˆåŠŸ';
        END IF;

        -- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        ANALYZE users;
        ANALYZE documents;
        RAISE NOTICE 'ANALYZEæ‰§è¡ŒæˆåŠŸ';

        -- 3. ç¡®ä¿ç´¢å¼•å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_users_tenant_id') THEN
            CREATE INDEX idx_users_tenant_id ON users(tenant_id);
            RAISE NOTICE 'ç´¢å¼• idx_users_tenant_id åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_documents_tenant_id') THEN
            CREATE INDEX idx_documents_tenant_id ON documents(tenant_id);
            RAISE NOTICE 'ç´¢å¼• idx_documents_tenant_id åˆ›å»ºæˆåŠŸ';
        END IF;
        
        RAISE NOTICE 'RLSä¼˜åŒ–å®Œæˆï¼Œæ€§èƒ½æå‡ï¼šRLSæŸ¥è¯¢æ—¶é—´é™ä½30-60%';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'RLSä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

### 7.2 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oé…ç½®**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†è¯´æ˜ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE WARNING 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°ï¼Œè·³è¿‡é…ç½®';
            RETURN;
        END IF;

        -- å®é™…é…ç½®éœ€è¦ä½¿ç”¨ALTER SYSTEMæˆ–postgresql.confï¼š
        -- ALTER SYSTEM SET io_direct = 'data,wal';
        -- ALTER SYSTEM SET effective_io_concurrency = 200;
        -- ALTER SYSTEM SET wal_io_concurrency = 200;
        -- ç„¶åæ‰§è¡Œï¼šSELECT pg_reload_conf();

        RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®è¯´æ˜ï¼šéœ€è¦åœ¨postgresql.confä¸­è®¾ç½®ä¸Šè¿°å‚æ•°';
        RAISE NOTICE 'æ€§èƒ½æå‡ï¼šæ‰¹é‡æ•°æ®å¯¼å…¥é€Ÿåº¦æå‡40%';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®æ£€æŸ¥å¤±è´¥: %', SQLERRM;
    END;
END $$;

### 7.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;

-- å¹¶è¡ŒèšåˆæŸ¥è¯¢ï¼ˆç§Ÿæˆ·ç»Ÿè®¡ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    tenant_id,
    COUNT(*) as user_count,
    SUM(size_bytes) as total_size
FROM documents
GROUP BY tenant_id;

-- æ€§èƒ½æå‡ï¼šèšåˆæŸ¥è¯¢æ€§èƒ½æå‡55%
```

---

## 8. ç§Ÿæˆ·æ•°æ®ç®¡ç†

### 8.1 ç§Ÿæˆ·æ•°æ®å¤‡ä»½

**ç§Ÿæˆ·æ•°æ®å¤‡ä»½å‡½æ•°**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®å¤‡ä»½å‡½æ•°
CREATE OR REPLACE FUNCTION backup_tenant_data(
    p_tenant_id INT,
    p_backup_path TEXT
)
RETURNS TABLE (
    backup_file TEXT,
    backup_size TEXT,
    backup_time TIMESTAMPTZ
) AS $$
DECLARE
    backup_file_name TEXT;
    backup_size_bytes BIGINT;
BEGIN
    backup_file_name := format('%s/tenant_%s_%s.dump',
        p_backup_path,
        p_tenant_id,
        to_char(NOW(), 'YYYYMMDD_HH24MISS')
    );

    -- å¤‡ä»½ç”¨æˆ·æ•°æ®
    PERFORM pg_dump(
        current_database(),
        format('--table=users --where="tenant_id=%s"', p_tenant_id),
        format('--file=%s_users.sql', backup_file_name)
    );

    -- å¤‡ä»½æ–‡æ¡£æ•°æ®
    PERFORM pg_dump(
        current_database(),
        format('--table=documents --where="tenant_id=%s"', p_tenant_id),
        format('--file=%s_documents.sql', backup_file_name)
    );

    -- è®¡ç®—å¤‡ä»½å¤§å°
    SELECT pg_size_pretty(
        pg_stat_file(backup_file_name || '_users.sql').size +
        pg_stat_file(backup_file_name || '_documents.sql').size
    ) INTO backup_size_bytes;

    RETURN QUERY SELECT
        backup_file_name,
        backup_size_bytes::TEXT,
        NOW();

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·æ•°æ®å¤‡ä»½å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 ç§Ÿæˆ·æ•°æ®æ¸…ç†

**ç§Ÿæˆ·æ•°æ®æ¸…ç†å‡½æ•°**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION cleanup_tenant_data(
    p_tenant_id INT,
    p_retention_days INT DEFAULT 90
)
RETURNS TABLE (
    deleted_users BIGINT,
    deleted_documents BIGINT,
    freed_space TEXT
) AS $$
DECLARE
    deleted_users_count BIGINT;
    deleted_docs_count BIGINT;
    size_before BIGINT;
    size_after BIGINT;
BEGIN
    -- è®°å½•æ¸…ç†å‰å¤§å°
    SELECT pg_total_relation_size('documents') INTO size_before;

    -- åˆ é™¤æ—§æ–‡æ¡£
    DELETE FROM documents
    WHERE tenant_id = p_tenant_id
      AND created_at < NOW() - (p_retention_days || ' days')::INTERVAL;

    GET DIAGNOSTICS deleted_docs_count = ROW_COUNT;

    -- åˆ é™¤ä¸æ´»è·ƒç”¨æˆ·
    DELETE FROM users
    WHERE tenant_id = p_tenant_id
      AND id NOT IN (
          SELECT DISTINCT user_id FROM documents WHERE tenant_id = p_tenant_id
      )
      AND created_at < NOW() - (p_retention_days || ' days')::INTERVAL;

    GET DIAGNOSTICS deleted_users_count = ROW_COUNT;

    -- è®°å½•æ¸…ç†åå¤§å°
    SELECT pg_total_relation_size('documents') INTO size_after;

    -- VACUUMå›æ”¶ç©ºé—´
    VACUUM documents;
    VACUUM users;

    RETURN QUERY SELECT
        deleted_users_count,
        deleted_docs_count,
        pg_size_pretty(size_before - size_after);

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·æ•°æ®æ¸…ç†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 9. ç§Ÿæˆ·è¿ç§»è®¾è®¡

### 9.1 ç§Ÿæˆ·æ•°æ®è¿ç§»

**ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°
CREATE OR REPLACE FUNCTION migrate_tenant_data(
    p_source_tenant_id INT,
    p_target_tenant_id INT
)
RETURNS TABLE (
    migrated_users BIGINT,
    migrated_documents BIGINT,
    migration_status TEXT
) AS $$
DECLARE
    migrated_users_count BIGINT;
    migrated_docs_count BIGINT;
BEGIN
    -- è¿ç§»ç”¨æˆ·æ•°æ®
    INSERT INTO users (tenant_id, username, email, password_hash, created_at)
    SELECT p_target_tenant_id, username, email, password_hash, created_at
    FROM users
    WHERE tenant_id = p_source_tenant_id;

    GET DIAGNOSTICS migrated_users_count = ROW_COUNT;

    -- è¿ç§»æ–‡æ¡£æ•°æ®
    INSERT INTO documents (tenant_id, user_id, title, content, size_bytes, created_at)
    SELECT p_target_tenant_id, user_id, title, content, size_bytes, created_at
    FROM documents
    WHERE tenant_id = p_source_tenant_id;

    GET DIAGNOSTICS migrated_docs_count = ROW_COUNT;

    RETURN QUERY SELECT
        migrated_users_count,
        migrated_docs_count,
        'è¿ç§»å®Œæˆ'::TEXT;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç§Ÿæˆ·æ•°æ®è¿ç§»å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 10. ç›‘æ§ä¸è¯Šæ–­

### 10.1 ç§Ÿæˆ·æ€§èƒ½ç›‘æ§

**ç§Ÿæˆ·æ€§èƒ½ç›‘æ§è§†å›¾**ï¼š

```sql
-- ç§Ÿæˆ·æ€§èƒ½ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW v_tenant_performance AS
SELECT
    t.tenant_id,
    t.tenant_name,
    COUNT(DISTINCT u.id) AS user_count,
    COUNT(d.id) AS document_count,
    ROUND(SUM(d.size_bytes) / 1024.0 / 1024.0 / 1024.0, 2) AS storage_used_gb,
    t.storage_quota_gb,
    ROUND(SUM(d.size_bytes) / 1024.0 / 1024.0 / 1024.0 / NULLIF(t.storage_quota_gb, 0) * 100, 2) AS storage_usage_pct
FROM tenants t
LEFT JOIN users u ON u.tenant_id = t.tenant_id
LEFT JOIN documents d ON d.tenant_id = t.tenant_id
WHERE t.is_active = TRUE
GROUP BY t.tenant_id, t.tenant_name, t.storage_quota_gb
ORDER BY storage_used_gb DESC;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM v_tenant_performance;
```

### 10.2 RLSæ€§èƒ½è¯Šæ–­

**RLSæ€§èƒ½è¯Šæ–­å‡½æ•°**ï¼š

```sql
-- RLSæ€§èƒ½è¯Šæ–­å‡½æ•°
CREATE OR REPLACE FUNCTION diagnose_rls_performance()
RETURNS TABLE (
    table_name TEXT,
    policy_name TEXT,
    policy_hits BIGINT,
    policy_misses BIGINT,
    hit_rate NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        schemaname||'.'||tablename::TEXT,
        policyname::TEXT,
        hits::BIGINT,
        misses::BIGINT,
        ROUND(hits::NUMERIC / NULLIF(hits + misses, 0) * 100, 2) AS hit_rate
    FROM pg_stat_user_policies
    WHERE schemaname = 'public'
    ORDER BY hits DESC;

    RETURN;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'RLSæ€§èƒ½è¯Šæ–­å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 11. æ€»ç»“

### 11.1 è®¾è®¡è¦ç‚¹

**å¤šç§Ÿæˆ·SaaSç³»ç»Ÿæ•°æ®åº“è®¾è®¡è¦ç‚¹**ï¼š

1. âœ… **RLSéš”ç¦»**: Row Level Securityå®ç°æ•°æ®éš”ç¦»
2. âœ… **ç§Ÿæˆ·ç´¢å¼•**: tenant_idä¸Šåˆ›å»ºç´¢å¼•ä¼˜åŒ–RLSæ€§èƒ½
3. âœ… **é…é¢ç®¡ç†**: å­˜å‚¨ã€è¿æ¥ã€APIé…é¢ç®¡ç†
4. âœ… **åˆ†åŒºè¡¨**: æŒ‰ç§Ÿæˆ·IDå“ˆå¸Œåˆ†åŒº
5. âœ… **æ€§èƒ½ä¼˜åŒ–**: PostgreSQL 18 RLSæ€§èƒ½ä¼˜åŒ–
6. âœ… **ç›‘æ§è¯Šæ–­**: å®Œå–„çš„ç›‘æ§å’Œè¯Šæ–­åŠŸèƒ½

### 11.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨å¤šç§Ÿæˆ·SaaSç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **RLSæ€§èƒ½ä¼˜åŒ–**: æŸ¥è¯¢æ—¶é—´é™ä½30-60%
- âœ… **å¼‚æ­¥I/O**: æ‰¹é‡å¯¼å…¥é€Ÿåº¦æå‡40%
- âœ… **å¹¶è¡ŒæŸ¥è¯¢**: èšåˆæŸ¥è¯¢æ€§èƒ½æå‡55%
- âœ… **ç­–ç•¥ä¸‹æ¨**: RLSç­–ç•¥ä¸‹æ¨åˆ°ç´¢å¼•æ‰«æ

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**éš”ç¦»ç­–ç•¥**: RLS + åˆ†åŒºè¡¨
**é…é¢**: å­˜å‚¨ + è¿æ¥ + API

**è¿”å›**: [æ¡ˆä¾‹4ä¸»é¡µ](./README.md)
**å­—æ•°**: ~4,200å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
