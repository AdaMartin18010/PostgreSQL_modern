---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\04-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹5ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
**æŠ€æœ¯æ ˆ**: PostgreSQL 18 + Python 3.11+
- **TPSç›®æ ‡**: 10,000+

---

## 1. äº¤æ˜“å¤„ç†æ¨¡å—

```python
"""
é‡‘èäº¤æ˜“æ ¸å¿ƒæ¨¡å—
ç‰¹ç‚¹: ACIDä¿è¯ã€ä¹è§‚é”ã€å®Œæ•´å®¡è®¡
"""

import psycopg2
from decimal import Decimal
import logging

class TransactionProcessor:
    """äº¤æ˜“å¤„ç†å™¨"""

    def __init__(self, conn_str):
        """åˆå§‹åŒ–äº¤æ˜“å¤„ç†å™¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        try:
            self.conn = psycopg2.connect(conn_str)
            self.cursor = self.conn.cursor()
        except psycopg2.OperationalError as e:
            raise ConnectionError(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        except Exception as e:
            raise RuntimeError(f"åˆå§‹åŒ–å¤±è´¥: {e}")
        
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)

    def transfer(self, from_account, to_account, amount, user_id, max_retries=3):
        """
        è½¬è´¦ï¼ˆå¸¦é‡è¯•å’Œå®Œæ•´å‚æ•°éªŒè¯ï¼‰

        Args:
            from_account: æºè´¦æˆ·ID
            to_account: ç›®æ ‡è´¦æˆ·ID
            amount: é‡‘é¢
            user_id: æ“ä½œç”¨æˆ·ID
            max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
        """
        
        # å‚æ•°éªŒè¯
        if from_account is None or from_account <= 0:
            raise ValueError(f"from_accountæ— æ•ˆ: {from_account}")
        if to_account is None or to_account <= 0:
            raise ValueError(f"to_accountæ— æ•ˆ: {to_account}")
        if from_account == to_account:
            raise ValueError("æºè´¦æˆ·å’Œç›®æ ‡è´¦æˆ·ä¸èƒ½ç›¸åŒ")
        if amount is None or amount <= 0:
            raise ValueError(f"amountå¿…é¡»å¤§äº0: {amount}")
        if user_id is None or user_id <= 0:
            raise ValueError(f"user_idæ— æ•ˆ: {user_id}")
        if max_retries < 1 or max_retries > 10:
            max_retries = 3

        for attempt in range(max_retries):
            try:
                # è°ƒç”¨æ•°æ®åº“å‡½æ•°
                self.cursor.execute("""
                    SELECT transfer_money(%s, %s, %s, %s);
                """, (from_account, to_account, amount, user_id))

                transaction_id = self.cursor.fetchone()[0]
                self.conn.commit()

                self.logger.info(f"âœ… è½¬è´¦æˆåŠŸ: {transaction_id}")
                return transaction_id

            except psycopg2.Error as e:
                self.conn.rollback()

                # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
                if 'ç‰ˆæœ¬å†²çª' in str(e):
                    self.logger.warning(f"ç‰ˆæœ¬å†²çªï¼Œé‡è¯• {attempt + 1}/{max_retries}")
                    continue
                else:
                    # å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡º
                    self.logger.error(f"âŒ è½¬è´¦å¤±è´¥: {e}")
                    raise

        # é‡è¯•è€—å°½
        raise Exception("è½¬è´¦å¤±è´¥: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")

    def get_account_balance(self, account_id):
        """æŸ¥è¯¢è´¦æˆ·ä½™é¢ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯ï¼‰"""
        
        # å‚æ•°éªŒè¯
        if account_id is None or account_id <= 0:
            raise ValueError(f"account_idæ— æ•ˆ: {account_id}")

        try:
            self.cursor.execute("""
                SELECT balance, currency
                FROM accounts
                WHERE account_id = %s;
            """, (account_id,))

            result = self.cursor.fetchone()
            if not result:
                raise ValueError("è´¦æˆ·ä¸å­˜åœ¨")

            return {'balance': float(result[0]), 'currency': result[1]}
        except psycopg2.OperationalError as e:
            self.logger.error(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
            raise
        except psycopg2.Error as e:
            self.logger.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
            raise
        except Exception as e:
            self.logger.error(f"æŸ¥è¯¢è´¦æˆ·ä½™é¢å¤±è´¥: {e}")
            raise

    def get_transaction_history(self, account_id, limit=100):
        """æŸ¥è¯¢äº¤æ˜“å†å²ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯ï¼‰"""
        
        # å‚æ•°éªŒè¯
        if account_id is None or account_id <= 0:
            raise ValueError(f"account_idæ— æ•ˆ: {account_id}")
        if limit <= 0 or limit > 10000:
            limit = 100

        try:
            self.cursor.execute("""
                SELECT
                    transaction_id,
                    CASE
                        WHEN from_account_id = %s THEN 'debit'
                        ELSE 'credit'
                    END AS type,
                    amount,
                    CASE
                        WHEN from_account_id = %s THEN to_account_id
                        ELSE from_account_id
                    END AS other_account,
                    status,
                    created_at
                FROM transactions
                WHERE from_account_id = %s OR to_account_id = %s
                ORDER BY created_at DESC
                LIMIT %s;
            """, (account_id, account_id, account_id, account_id, limit))

            return self.cursor.fetchall()
        except psycopg2.OperationalError as e:
            self.logger.error(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
            raise
        except psycopg2.Error as e:
            self.logger.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
            raise
        except Exception as e:
            self.logger.error(f"æŸ¥è¯¢äº¤æ˜“å†å²å¤±è´¥: {e}")
            raise
```

---

## 2. å¯¹è´¦æ¨¡å—

```python
class ReconciliationService:
    """å¯¹è´¦æœåŠ¡"""

    def __init__(self, conn):
        """åˆå§‹åŒ–å¯¹è´¦æœåŠ¡ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        import logging
        try:
            self.conn = conn
            self.cursor = conn.cursor()
        except Exception as e:
            raise RuntimeError(f"åˆå§‹åŒ–å¤±è´¥: {e}")
        
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)

    def daily_reconciliation(self, date):
        """æ—¥ç»ˆå¯¹è´¦ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""

        try:
            # 1. æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
            inconsistencies = self._check_balance_consistency(date)

            if inconsistencies:
                self.logger.error(f"å‘ç°{len(inconsistencies)}ä¸ªè´¦æˆ·ä½™é¢ä¸ä¸€è‡´")
                return False

            # 2. æ£€æŸ¥äº¤æ˜“å®Œæ•´æ€§
            incomplete_txs = self._check_transaction_completeness(date)

            if incomplete_txs:
                self.logger.error(f"å‘ç°{len(incomplete_txs)}ä¸ªæœªå®Œæˆäº¤æ˜“")
                return False

            # 3. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
            report = self._generate_report(date)

            self.logger.info(f"âœ… {date}å¯¹è´¦å®Œæˆ")
            return True
        except psycopg2.Error as e:
            self.logger.error(f"å¯¹è´¦è¿‡ç¨‹æ•°æ®åº“é”™è¯¯: {e}")
            self.conn.rollback()
            return False
        except Exception as e:
            self.logger.error(f"å¯¹è´¦è¿‡ç¨‹æœªçŸ¥é”™è¯¯: {e}")
            return False

    def _check_balance_consistency(self, date):
        """æ£€æŸ¥ä½™é¢ä¸€è‡´æ€§ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""

        try:
            self.cursor.execute("""
                WITH calculated_balance AS (
                    SELECT
                        account_id,
                        COALESCE(SUM(
                            CASE
                                WHEN to_account_id = account_id THEN amount
                                WHEN from_account_id = account_id THEN -amount
                                ELSE 0
                            END
                        ), 0) AS calc_balance
                    FROM accounts a
                    LEFT JOIN transactions t ON (
                        (t.from_account_id = a.account_id OR t.to_account_id = a.account_id)
                        AND t.status = 'success'
                        AND DATE(t.completed_at) <= %s
                    )
                    GROUP BY account_id
                )
                SELECT
                    a.account_id,
                    a.balance AS actual_balance,
                    cb.calc_balance AS calculated_balance,
                    a.balance - cb.calc_balance AS diff
                FROM accounts a
                JOIN calculated_balance cb ON a.account_id = cb.account_id
                WHERE ABS(a.balance - cb.calc_balance) > 0.01;  -- å®¹å·®0.01å…ƒ
            """, (date,))

            return self.cursor.fetchall()
        except psycopg2.Error as e:
            self.logger.error(f"æ£€æŸ¥ä½™é¢ä¸€è‡´æ€§å¤±è´¥: {e}")
            return []
        except Exception as e:
            self.logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
            return []
```

---

---

## 3. å®¡è®¡ä¸ç›‘æ§æ¨¡å—

### 3.1 å®¡è®¡æ—¥å¿—è®°å½•

**å®¡è®¡æ—¥å¿—è®°å½•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class AuditLogger:
    """å®¡è®¡æ—¥å¿—è®°å½•å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def log_transaction(self, transaction_id, account_id, action, old_value, new_value, user_id, ip_address):
        """è®°å½•äº¤æ˜“å®¡è®¡æ—¥å¿—ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        import json
        import psycopg2

        try:
            self.cursor.execute("""
                INSERT INTO audit_logs (
                    transaction_id, account_id, action,
                    old_value, new_value, user_id, ip_address
                )
                VALUES (%s, %s, %s, %s::jsonb, %s::jsonb, %s, %s);
            """, (
                transaction_id, account_id, action,
                json.dumps(old_value), json.dumps(new_value),
                user_id, ip_address
            ))

            self.conn.commit()
            return True

        except psycopg2.IntegrityError as e:
            print(f"è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥ï¼ˆæ•°æ®å®Œæ•´æ€§é”™è¯¯ï¼‰: {e}")
            self.conn.rollback()
            return False
        except psycopg2.OperationalError as e:
            print(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
            self.conn.rollback()
            return False
        except psycopg2.Error as e:
            print(f"è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥: {e}")
            self.conn.rollback()
            return False
        except Exception as e:
            print(f"æœªçŸ¥é”™è¯¯: {e}")
            self.conn.rollback()
            return False
            self.logger.error(f"å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥: {e}")
            return False

    def query_audit_logs(self, account_id=None, start_date=None, end_date=None, limit=100):
        """æŸ¥è¯¢å®¡è®¡æ—¥å¿—ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰"""
        import psycopg2

        try:
            query = """
                SELECT
                    log_id, transaction_id, account_id, action,
                    old_value, new_value, user_id, ip_address, created_at
                FROM audit_logs
                WHERE 1=1
            """
            params = []

            if account_id:
                query += " AND account_id = %s"
                params.append(account_id)

            if start_date:
                query += " AND created_at >= %s"
                params.append(start_date)

            if end_date:
                query += " AND created_at <= %s"
                params.append(end_date)

            query += " ORDER BY created_at DESC LIMIT %s"
            params.append(limit)

            self.cursor.execute(query, params)
            return self.cursor.fetchall()
        except psycopg2.OperationalError as e:
            self.logger.error(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
            raise
        except psycopg2.Error as e:
            self.logger.error(f"æŸ¥è¯¢å®¡è®¡æ—¥å¿—å¤±è´¥: {e}")
            raise
        except Exception as e:
            self.logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
            raise
```

### 3.2 äº‹ä»¶æº¯æºå®ç°

**äº‹ä»¶æº¯æºå®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class EventStore:
    """äº‹ä»¶å­˜å‚¨ï¼ˆEvent Sourcingï¼‰"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def append_event(self, account_id, event_type, event_data):
        """è¿½åŠ äº‹ä»¶"""

        try:
            # è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
            self.cursor.execute("""
                SELECT COALESCE(MAX(sequence_number), 0) + 1
                FROM account_events
                WHERE account_id = %s;
            """, (account_id,))

            sequence_number = self.cursor.fetchone()[0]

            # æ’å…¥äº‹ä»¶
            self.cursor.execute("""
                INSERT INTO account_events (
                    account_id, event_type, event_data, sequence_number
                )
                VALUES (%s, %s, %s::jsonb, %s);
            """, (account_id, event_type, json.dumps(event_data), sequence_number))

            self.conn.commit()
            return sequence_number

        except Exception as e:
            self.conn.rollback()
            raise Exception(f"äº‹ä»¶è¿½åŠ å¤±è´¥: {e}")

    def replay_events(self, account_id, up_to_sequence=None):
        """é‡æ”¾äº‹ä»¶ï¼ˆé‡å»ºè´¦æˆ·çŠ¶æ€ï¼‰"""

        query = """
            SELECT event_type, event_data, sequence_number
            FROM account_events
            WHERE account_id = %s
        """
        params = [account_id]

        if up_to_sequence:
            query += " AND sequence_number <= %s"
            params.append(up_to_sequence)

        query += " ORDER BY sequence_number"

        self.cursor.execute(query, params)
        events = self.cursor.fetchall()

        # é‡å»ºè´¦æˆ·çŠ¶æ€
        balance = Decimal('0.00')
        for event in events:
            event_data = json.loads(event['event_data'])
            if event['event_type'] == 'deposit':
                balance += Decimal(str(event_data['amount']))
            elif event['event_type'] == 'withdraw':
                balance -= Decimal(str(event_data['amount']))
            elif event['event_type'] == 'transfer_out':
                balance -= Decimal(str(event_data['amount']))
            elif event['event_type'] == 'transfer_in':
                balance += Decimal(str(event_data['amount']))

        return balance
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 è¿æ¥æ± ç®¡ç†

**è¿æ¥æ± ç®¡ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
from psycopg2 import pool

class ConnectionPoolManager:
    """è¿æ¥æ± ç®¡ç†å™¨"""

    def __init__(self, conn_str, min_conn=5, max_conn=20):
        self.pool = pool.ThreadedConnectionPool(
            min_conn, max_conn, conn_str
        )

    def get_connection(self):
        """è·å–è¿æ¥"""
        return self.pool.getconn()

    def return_connection(self, conn):
        """å½’è¿˜è¿æ¥"""
        self.pool.putconn(conn)

    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        self.pool.closeall()
```

### 4.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–

**æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class BatchProcessor:
    """æ‰¹é‡å¤„ç†å™¨"""

    def __init__(self, conn, batch_size=1000):
        self.conn = conn
        self.cursor = conn.cursor()
        self.batch_size = batch_size
        self.batch = []

    def add_transaction(self, from_account, to_account, amount, user_id):
        """æ·»åŠ äº¤æ˜“åˆ°æ‰¹æ¬¡"""
        self.batch.append((from_account, to_account, amount, user_id))

        if len(self.batch) >= self.batch_size:
            self.flush()

    def flush(self):
        """åˆ·æ–°æ‰¹æ¬¡"""
        if not self.batch:
            return

        try:
            # ä½¿ç”¨æ‰¹é‡æ’å…¥
            self.cursor.executemany("""
                SELECT transfer_money(%s, %s, %s, %s);
            """, self.batch)

            self.conn.commit()
            self.batch = []

        except Exception as e:
            self.conn.rollback()
            raise Exception(f"æ‰¹é‡å¤„ç†å¤±è´¥: {e}")
```

---

## 5. ç›‘æ§ä¸å‘Šè­¦

### 5.1 æ€§èƒ½ç›‘æ§

**æ€§èƒ½ç›‘æ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class PerformanceMonitor:
    """æ€§èƒ½ç›‘æ§å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def get_transaction_stats(self, time_window_minutes=5):
        """è·å–äº¤æ˜“ç»Ÿè®¡"""

        self.cursor.execute("""
            SELECT
                COUNT(*) AS total_transactions,
                COUNT(*) FILTER (WHERE status = 'success') AS success_count,
                COUNT(*) FILTER (WHERE status = 'failed') AS failed_count,
                AVG(EXTRACT(EPOCH FROM (completed_at - created_at))) AS avg_duration_seconds,
                PERCENTILE_CONT(0.95) WITHIN GROUP (
                    ORDER BY EXTRACT(EPOCH FROM (completed_at - created_at))
                ) AS p95_duration_seconds
            FROM transactions
            WHERE created_at > NOW() - INTERVAL '%s minutes'
        """, (time_window_minutes,))

        return self.cursor.fetchone()

    def get_account_stats(self):
        """è·å–è´¦æˆ·ç»Ÿè®¡"""

        self.cursor.execute("""
            SELECT
                COUNT(*) AS total_accounts,
                COUNT(*) FILTER (WHERE status = 'active') AS active_accounts,
                SUM(balance) AS total_balance,
                AVG(balance) AS avg_balance
            FROM accounts
        """)

        return self.cursor.fetchone()
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**è¡¨ç»“æ„**: è´¦æˆ· + äº¤æ˜“ + å®¡è®¡ + äº‹ä»¶
**å®Œæ•´æ€§**: ä¹è§‚é” + çº¦æŸ

---

## 6. PostgreSQL 18é‡‘èäº¤æ˜“ä¼˜åŒ–

### 6.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser') = 'off' THEN
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼Œè¯·åœ¨postgresql.confä¸­è®¾ç½®: io_direct = data,wal; io_combine_limit = 256kB';
            RETURN;
        END IF;
        ALTER SYSTEM SET io_direct = 'data,wal';
        ALTER SYSTEM SET io_combine_limit = '256kB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ€§èƒ½æå‡:
-- äº¤æ˜“å†™å…¥æ€§èƒ½: +30-35%
-- WALå†™å…¥æ€§èƒ½: +25-30%
-- æŸ¥è¯¢æ€§èƒ½: +20-25%
```

### 6.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET LOCAL max_parallel_workers_per_gather = 4;
        SET LOCAL parallel_setup_cost = 1000;
        SET LOCAL parallel_tuple_cost = 0.01;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å·²è®¾ç½®ï¼ˆä¼šè¯çº§åˆ«ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å¹¶è¡ŒæŠ¥è¡¨æŸ¥è¯¢ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡ŒæŠ¥è¡¨æŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    DATE_TRUNC('day', created_at) AS day,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount
FROM transactions
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY day
ORDER BY day;

-- æ€§èƒ½æå‡:
-- æŠ¥è¡¨æŸ¥è¯¢: +50-60%
```

---

## 7. é‡‘èäº¤æ˜“ç³»ç»Ÿç›‘æ§

### 7.1 äº¤æ˜“æ€§èƒ½ç›‘æ§

**äº¤æ˜“æ€§èƒ½ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- äº¤æ˜“æ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        DROP VIEW IF EXISTS v_transaction_performance;
        CREATE OR REPLACE VIEW v_transaction_performance AS
SELECT
    DATE_TRUNC('hour', created_at) AS hour,
    COUNT(*) AS transaction_count,
    AVG(processing_time_ms) AS avg_processing_time_ms,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY processing_time_ms) AS p95_processing_time_ms,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY processing_time_ms) AS p99_processing_time_ms,
    COUNT(*) FILTER (WHERE status = 'success') AS success_count,
    COUNT(*) FILTER (WHERE status = 'failed') AS failed_count
FROM transactions
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;

        RAISE NOTICE 'è§†å›¾ v_transaction_performance åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢äº¤æ˜“æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_transaction_performance') THEN
            RAISE WARNING 'è§†å›¾ v_transaction_performance ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢äº¤æ˜“æ€§èƒ½ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢äº¤æ˜“æ€§èƒ½è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_transaction_performance') THEN
            RAISE WARNING 'è§†å›¾ v_transaction_performance ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢äº¤æ˜“æ€§èƒ½è§†å›¾';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_transaction_performance LIMIT 100;
```

### 7.2 è´¦æˆ·ä½™é¢ç›‘æ§

**è´¦æˆ·ä½™é¢ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è´¦æˆ·ä½™é¢ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        DROP VIEW IF EXISTS v_account_balance_monitoring;
        CREATE OR REPLACE VIEW v_account_balance_monitoring AS
SELECT
    account_id,
    balance,
    currency,
    last_transaction_time,
    transaction_count_24h,
    CASE
        WHEN balance < 0 THEN 'overdraft'
        WHEN balance < 100 THEN 'low_balance'
        ELSE 'normal'
    END AS balance_status
FROM accounts
WHERE last_transaction_time > NOW() - INTERVAL '24 hours'
ORDER BY last_transaction_time DESC;

        RAISE NOTICE 'è§†å›¾ v_account_balance_monitoring åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢è´¦æˆ·ä½™é¢ç›‘æ§ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
-- æŸ¥è¯¢è´¦æˆ·ä½™é¢ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_account_balance_monitoring') THEN
            RAISE WARNING 'è§†å›¾ v_account_balance_monitoring ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢è´¦æˆ·ä½™é¢ç›‘æ§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢è´¦æˆ·ä½™é¢ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'v_account_balance_monitoring') THEN
            RAISE WARNING 'è§†å›¾ v_account_balance_monitoring ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢è´¦æˆ·ä½™é¢ç›‘æ§è§†å›¾';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_account_balance_monitoring LIMIT 100;
```

---

## 8. é‡‘èäº¤æ˜“ç³»ç»Ÿæœ€ä½³å®è·µ

### 8.1 äº‹åŠ¡è®¾è®¡æœ€ä½³å®è·µ

**äº‹åŠ¡è®¾è®¡æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ä½¿ç”¨ä¹è§‚é”ï¼ˆå‡å°‘é”ç«äº‰ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            CREATE TABLE accounts (
    account_id BIGSERIAL PRIMARY KEY,
    balance NUMERIC(15,2) NOT NULL,
                version INTEGER NOT NULL DEFAULT 0  -- ç‰ˆæœ¬å·
            );
            RAISE NOTICE 'è¡¨ accounts åˆ›å»ºæˆåŠŸï¼ˆå¸¦ä¹è§‚é”ï¼‰';
        ELSE
            RAISE NOTICE 'è¡¨ accounts å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_account_id BIGINT := 1;
    v_current_version INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨';
            RETURN;
        END IF;
        
        SELECT version INTO v_current_version FROM accounts WHERE account_id = v_account_id;
        
        IF v_current_version IS NULL THEN
            RAISE WARNING 'è´¦æˆ·ä¸å­˜åœ¨';
            RETURN;
        END IF;
        
        RAISE NOTICE 'å¼€å§‹ä¹è§‚é”æ›´æ–°ï¼ˆå½“å‰ç‰ˆæœ¬: %ï¼‰', v_current_version;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;
-- ä¹è§‚é”æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_current_version INT := :current_version;  -- å‡è®¾ä»åº”ç”¨ä¼ å…¥
    v_updated_rows INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ›´æ–°';
            RETURN;
        END IF;

        UPDATE accounts
        SET balance = balance - 100,
            version = version + 1
        WHERE account_id = 1
            AND version = v_current_version;  -- ç‰ˆæœ¬æ£€æŸ¥

        GET DIAGNOSTICS v_updated_rows = ROW_COUNT;
        
        IF v_updated_rows = 0 THEN
            RAISE EXCEPTION 'ç‰ˆæœ¬å†²çªï¼šè´¦æˆ·ç‰ˆæœ¬å·²å˜æ›´ï¼Œè¯·é‡è¯•';
        ELSE
            RAISE NOTICE 'è´¦æˆ·æ›´æ–°æˆåŠŸï¼Œç‰ˆæœ¬å·²é€’å¢';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°è´¦æˆ·å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ä½¿ç”¨ä¿å­˜ç‚¹ï¼ˆéƒ¨åˆ†å›æ»šï¼‰
BEGIN;
SAVEPOINT sp1;
-- æ‰§è¡Œæ“ä½œ1
SAVEPOINT sp2;
-- æ‰§è¡Œæ“ä½œ2
ROLLBACK TO SAVEPOINT sp1;  -- åªå›æ»šæ“ä½œ2
COMMIT;  -- æäº¤æ“ä½œ1
```

### 8.2 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

**æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆé¢„è®¡ç®—æŠ¥è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç‰©åŒ–è§†å›¾';
            RETURN;
        END IF;
        DROP MATERIALIZED VIEW IF EXISTS mv_daily_transactions;
        CREATE MATERIALIZED VIEW mv_daily_transactions AS
SELECT
    DATE_TRUNC('day', created_at) AS day,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM transactions
GROUP BY day;

        CREATE UNIQUE INDEX ON mv_daily_transactions(day);
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾ mv_daily_transactions åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†è¯´æ˜ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'mv_daily_transactions') THEN
            RAISE WARNING 'ç‰©åŒ–è§†å›¾ mv_daily_transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°';
            RETURN;
        END IF;
        RAISE NOTICE 'æ³¨æ„ï¼šREFRESH MATERIALIZED VIEW CONCURRENTLYéœ€è¦åœ¨äº‹åŠ¡å¤–æ‰§è¡Œ';
        RAISE NOTICE 'å®é™…æ‰§è¡Œï¼šREFRESH MATERIALIZED VIEW CONCURRENTLY mv_daily_transactions;';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ·æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 2. ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆå†å²æ•°æ®ç®¡ç†ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE NOTICE 'è¡¨ transactions å·²å­˜åœ¨ï¼Œå¦‚éœ€åˆ†åŒºè¯·å…ˆå¤‡ä»½æ•°æ®';
            RETURN;
        END IF;
        CREATE TABLE transactions (
            transaction_id BIGSERIAL,
            account_id BIGINT,
            amount NUMERIC(15,2),
            created_at TIMESTAMPTZ NOT NULL
        ) PARTITION BY RANGE (created_at);
        CREATE TABLE transactions_2025_01 PARTITION OF transactions
        FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
        RAISE NOTICE 'åˆ†åŒºè¡¨ transactions åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨æˆ–åˆ†åŒºå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

**è¿”å›**: [æ¡ˆä¾‹5ä¸»é¡µ](./README.md)
**å­—æ•°**: ~8,000å­—
**æ¶µç›–**: äº¤æ˜“å¤„ç†ã€è´¦æˆ·ç®¡ç†ã€å®¡è®¡æ—¥å¿—ã€PostgreSQL 18ä¼˜åŒ–ã€ç›‘æ§ã€æœ€ä½³å®è·µ
