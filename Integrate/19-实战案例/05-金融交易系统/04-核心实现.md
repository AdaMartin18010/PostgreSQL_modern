---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\04-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹5ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
**æŠ€æœ¯æ ˆ**: PostgreSQL 18 + Python 3.11+
- **TPSç›®æ ‡**: 10,000+

---

## 1. äº¤æ˜“å¤„ç†æ¨¡å—

```python
"""
é‡‘èäº¤æ˜“æ ¸å¿ƒæ¨¡å—
ç‰¹ç‚¹: ACIDä¿è¯ã€ä¹è§‚é”ã€å®Œæ•´å®¡è®¡
"""

import psycopg2
from decimal import Decimal
import logging

class TransactionProcessor:
    """äº¤æ˜“å¤„ç†å™¨"""

    def __init__(self, conn_str):
        self.conn = psycopg2.connect(conn_str)
        self.cursor = self.conn.cursor()
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)

    def transfer(self, from_account, to_account, amount, user_id, max_retries=3):
        """
        è½¬è´¦ï¼ˆå¸¦é‡è¯•ï¼‰

        Args:
            from_account: æºè´¦æˆ·ID
            to_account: ç›®æ ‡è´¦æˆ·ID
            amount: é‡‘é¢
            user_id: æ“ä½œç”¨æˆ·ID
            max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
        """

        for attempt in range(max_retries):
            try:
                # è°ƒç”¨æ•°æ®åº“å‡½æ•°
                self.cursor.execute("""
                    SELECT transfer_money(%s, %s, %s, %s);
                """, (from_account, to_account, amount, user_id))

                transaction_id = self.cursor.fetchone()[0]
                self.conn.commit()

                self.logger.info(f"âœ… è½¬è´¦æˆåŠŸ: {transaction_id}")
                return transaction_id

            except psycopg2.Error as e:
                self.conn.rollback()

                # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
                if 'ç‰ˆæœ¬å†²çª' in str(e):
                    self.logger.warning(f"ç‰ˆæœ¬å†²çªï¼Œé‡è¯• {attempt + 1}/{max_retries}")
                    continue
                else:
                    # å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡º
                    self.logger.error(f"âŒ è½¬è´¦å¤±è´¥: {e}")
                    raise

        # é‡è¯•è€—å°½
        raise Exception("è½¬è´¦å¤±è´¥: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")

    def get_account_balance(self, account_id):
        """æŸ¥è¯¢è´¦æˆ·ä½™é¢"""

        self.cursor.execute("""
            SELECT balance, currency
            FROM accounts
            WHERE account_id = %s;
        """, (account_id,))

        result = self.cursor.fetchone()
        if not result:
            raise ValueError("è´¦æˆ·ä¸å­˜åœ¨")

        return {'balance': float(result[0]), 'currency': result[1]}

    def get_transaction_history(self, account_id, limit=100):
        """æŸ¥è¯¢äº¤æ˜“å†å²"""

        self.cursor.execute("""
            SELECT
                transaction_id,
                CASE
                    WHEN from_account_id = %s THEN 'debit'
                    ELSE 'credit'
                END AS type,
                amount,
                CASE
                    WHEN from_account_id = %s THEN to_account_id
                    ELSE from_account_id
                END AS other_account,
                status,
                created_at
            FROM transactions
            WHERE from_account_id = %s OR to_account_id = %s
            ORDER BY created_at DESC
            LIMIT %s;
        """, (account_id, account_id, account_id, account_id, limit))

        return self.cursor.fetchall()
```

---

## 2. å¯¹è´¦æ¨¡å—

```python
class ReconciliationService:
    """å¯¹è´¦æœåŠ¡"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def daily_reconciliation(self, date):
        """æ—¥ç»ˆå¯¹è´¦"""

        # 1. æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
        inconsistencies = self._check_balance_consistency(date)

        if inconsistencies:
            self.logger.error(f"å‘ç°{len(inconsistencies)}ä¸ªè´¦æˆ·ä½™é¢ä¸ä¸€è‡´")
            return False

        # 2. æ£€æŸ¥äº¤æ˜“å®Œæ•´æ€§
        incomplete_txs = self._check_transaction_completeness(date)

        if incomplete_txs:
            self.logger.error(f"å‘ç°{len(incomplete_txs)}ä¸ªæœªå®Œæˆäº¤æ˜“")
            return False

        # 3. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
        report = self._generate_report(date)

        self.logger.info(f"âœ… {date}å¯¹è´¦å®Œæˆ")
        return True

    def _check_balance_consistency(self, date):
        """æ£€æŸ¥ä½™é¢ä¸€è‡´æ€§"""

        self.cursor.execute("""
            WITH calculated_balance AS (
                SELECT
                    account_id,
                    COALESCE(SUM(
                        CASE
                            WHEN to_account_id = account_id THEN amount
                            WHEN from_account_id = account_id THEN -amount
                            ELSE 0
                        END
                    ), 0) AS calc_balance
                FROM accounts a
                LEFT JOIN transactions t ON (
                    (t.from_account_id = a.account_id OR t.to_account_id = a.account_id)
                    AND t.status = 'success'
                    AND DATE(t.completed_at) <= %s
                )
                GROUP BY account_id
            )
            SELECT
                a.account_id,
                a.balance AS actual_balance,
                cb.calc_balance AS calculated_balance,
                a.balance - cb.calc_balance AS diff
            FROM accounts a
            JOIN calculated_balance cb ON a.account_id = cb.account_id
            WHERE ABS(a.balance - cb.calc_balance) > 0.01;  -- å®¹å·®0.01å…ƒ
        """, (date,))

        return self.cursor.fetchall()
```

---

---

## 3. å®¡è®¡ä¸ç›‘æ§æ¨¡å—

### 3.1 å®¡è®¡æ—¥å¿—è®°å½•

**å®¡è®¡æ—¥å¿—è®°å½•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class AuditLogger:
    """å®¡è®¡æ—¥å¿—è®°å½•å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def log_transaction(self, transaction_id, account_id, action, old_value, new_value, user_id, ip_address):
        """è®°å½•äº¤æ˜“å®¡è®¡æ—¥å¿—"""

        try:
            self.cursor.execute("""
                INSERT INTO audit_logs (
                    transaction_id, account_id, action,
                    old_value, new_value, user_id, ip_address
                )
                VALUES (%s, %s, %s, %s::jsonb, %s::jsonb, %s, %s);
            """, (
                transaction_id, account_id, action,
                json.dumps(old_value), json.dumps(new_value),
                user_id, ip_address
            ))

            self.conn.commit()
            return True

        except Exception as e:
            self.conn.rollback()
            self.logger.error(f"å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥: {e}")
            return False

    def query_audit_logs(self, account_id=None, start_date=None, end_date=None, limit=100):
        """æŸ¥è¯¢å®¡è®¡æ—¥å¿—"""

        query = """
            SELECT
                log_id, transaction_id, account_id, action,
                old_value, new_value, user_id, ip_address, created_at
            FROM audit_logs
            WHERE 1=1
        """
        params = []

        if account_id:
            query += " AND account_id = %s"
            params.append(account_id)

        if start_date:
            query += " AND created_at >= %s"
            params.append(start_date)

        if end_date:
            query += " AND created_at <= %s"
            params.append(end_date)

        query += " ORDER BY created_at DESC LIMIT %s"
        params.append(limit)

        self.cursor.execute(query, params)
        return self.cursor.fetchall()
```

### 3.2 äº‹ä»¶æº¯æºå®ç°

**äº‹ä»¶æº¯æºå®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class EventStore:
    """äº‹ä»¶å­˜å‚¨ï¼ˆEvent Sourcingï¼‰"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def append_event(self, account_id, event_type, event_data):
        """è¿½åŠ äº‹ä»¶"""

        try:
            # è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
            self.cursor.execute("""
                SELECT COALESCE(MAX(sequence_number), 0) + 1
                FROM account_events
                WHERE account_id = %s;
            """, (account_id,))

            sequence_number = self.cursor.fetchone()[0]

            # æ’å…¥äº‹ä»¶
            self.cursor.execute("""
                INSERT INTO account_events (
                    account_id, event_type, event_data, sequence_number
                )
                VALUES (%s, %s, %s::jsonb, %s);
            """, (account_id, event_type, json.dumps(event_data), sequence_number))

            self.conn.commit()
            return sequence_number

        except Exception as e:
            self.conn.rollback()
            raise Exception(f"äº‹ä»¶è¿½åŠ å¤±è´¥: {e}")

    def replay_events(self, account_id, up_to_sequence=None):
        """é‡æ”¾äº‹ä»¶ï¼ˆé‡å»ºè´¦æˆ·çŠ¶æ€ï¼‰"""

        query = """
            SELECT event_type, event_data, sequence_number
            FROM account_events
            WHERE account_id = %s
        """
        params = [account_id]

        if up_to_sequence:
            query += " AND sequence_number <= %s"
            params.append(up_to_sequence)

        query += " ORDER BY sequence_number"

        self.cursor.execute(query, params)
        events = self.cursor.fetchall()

        # é‡å»ºè´¦æˆ·çŠ¶æ€
        balance = Decimal('0.00')
        for event in events:
            event_data = json.loads(event['event_data'])
            if event['event_type'] == 'deposit':
                balance += Decimal(str(event_data['amount']))
            elif event['event_type'] == 'withdraw':
                balance -= Decimal(str(event_data['amount']))
            elif event['event_type'] == 'transfer_out':
                balance -= Decimal(str(event_data['amount']))
            elif event['event_type'] == 'transfer_in':
                balance += Decimal(str(event_data['amount']))

        return balance
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 è¿æ¥æ± ç®¡ç†

**è¿æ¥æ± ç®¡ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
from psycopg2 import pool

class ConnectionPoolManager:
    """è¿æ¥æ± ç®¡ç†å™¨"""

    def __init__(self, conn_str, min_conn=5, max_conn=20):
        self.pool = pool.ThreadedConnectionPool(
            min_conn, max_conn, conn_str
        )

    def get_connection(self):
        """è·å–è¿æ¥"""
        return self.pool.getconn()

    def return_connection(self, conn):
        """å½’è¿˜è¿æ¥"""
        self.pool.putconn(conn)

    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        self.pool.closeall()
```

### 4.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–

**æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class BatchProcessor:
    """æ‰¹é‡å¤„ç†å™¨"""

    def __init__(self, conn, batch_size=1000):
        self.conn = conn
        self.cursor = conn.cursor()
        self.batch_size = batch_size
        self.batch = []

    def add_transaction(self, from_account, to_account, amount, user_id):
        """æ·»åŠ äº¤æ˜“åˆ°æ‰¹æ¬¡"""
        self.batch.append((from_account, to_account, amount, user_id))

        if len(self.batch) >= self.batch_size:
            self.flush()

    def flush(self):
        """åˆ·æ–°æ‰¹æ¬¡"""
        if not self.batch:
            return

        try:
            # ä½¿ç”¨æ‰¹é‡æ’å…¥
            self.cursor.executemany("""
                SELECT transfer_money(%s, %s, %s, %s);
            """, self.batch)

            self.conn.commit()
            self.batch = []

        except Exception as e:
            self.conn.rollback()
            raise Exception(f"æ‰¹é‡å¤„ç†å¤±è´¥: {e}")
```

---

## 5. ç›‘æ§ä¸å‘Šè­¦

### 5.1 æ€§èƒ½ç›‘æ§

**æ€§èƒ½ç›‘æ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
class PerformanceMonitor:
    """æ€§èƒ½ç›‘æ§å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def get_transaction_stats(self, time_window_minutes=5):
        """è·å–äº¤æ˜“ç»Ÿè®¡"""

        self.cursor.execute("""
            SELECT
                COUNT(*) AS total_transactions,
                COUNT(*) FILTER (WHERE status = 'success') AS success_count,
                COUNT(*) FILTER (WHERE status = 'failed') AS failed_count,
                AVG(EXTRACT(EPOCH FROM (completed_at - created_at))) AS avg_duration_seconds,
                PERCENTILE_CONT(0.95) WITHIN GROUP (
                    ORDER BY EXTRACT(EPOCH FROM (completed_at - created_at))
                ) AS p95_duration_seconds
            FROM transactions
            WHERE created_at > NOW() - INTERVAL '%s minutes'
        """, (time_window_minutes,))

        return self.cursor.fetchone()

    def get_account_stats(self):
        """è·å–è´¦æˆ·ç»Ÿè®¡"""

        self.cursor.execute("""
            SELECT
                COUNT(*) AS total_accounts,
                COUNT(*) FILTER (WHERE status = 'active') AS active_accounts,
                SUM(balance) AS total_balance,
                AVG(balance) AS avg_balance
            FROM accounts
        """)

        return self.cursor.fetchone()
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**è¡¨ç»“æ„**: è´¦æˆ· + äº¤æ˜“ + å®¡è®¡ + äº‹ä»¶
**å®Œæ•´æ€§**: ä¹è§‚é” + çº¦æŸ

**è¿”å›**: [æ¡ˆä¾‹5ä¸»é¡µ](./README.md)
