---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\04-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹5ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿ - æ ¸å¿ƒå®ç°

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
**æŠ€æœ¯æ ˆ**: PostgreSQL 18 + Python 3.11+
- **TPSç›®æ ‡**: 10,000+

---

## 1. äº¤æ˜“å¤„ç†æ¨¡å—

```python
"""
é‡‘èäº¤æ˜“æ ¸å¿ƒæ¨¡å—
ç‰¹ç‚¹: ACIDä¿è¯ã€ä¹è§‚é”ã€å®Œæ•´å®¡è®¡
"""

import psycopg2
from decimal import Decimal
import logging

class TransactionProcessor:
    """äº¤æ˜“å¤„ç†å™¨"""

    def __init__(self, conn_str):
        self.conn = psycopg2.connect(conn_str)
        self.cursor = self.conn.cursor()
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)

    def transfer(self, from_account, to_account, amount, user_id, max_retries=3):
        """
        è½¬è´¦ï¼ˆå¸¦é‡è¯•ï¼‰

        Args:
            from_account: æºè´¦æˆ·ID
            to_account: ç›®æ ‡è´¦æˆ·ID
            amount: é‡‘é¢
            user_id: æ“ä½œç”¨æˆ·ID
            max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
        """

        for attempt in range(max_retries):
            try:
                # è°ƒç”¨æ•°æ®åº“å‡½æ•°
                self.cursor.execute("""
                    SELECT transfer_money(%s, %s, %s, %s);
                """, (from_account, to_account, amount, user_id))

                transaction_id = self.cursor.fetchone()[0]
                self.conn.commit()

                self.logger.info(f"âœ… è½¬è´¦æˆåŠŸ: {transaction_id}")
                return transaction_id

            except psycopg2.Error as e:
                self.conn.rollback()

                # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
                if 'ç‰ˆæœ¬å†²çª' in str(e):
                    self.logger.warning(f"ç‰ˆæœ¬å†²çªï¼Œé‡è¯• {attempt + 1}/{max_retries}")
                    continue
                else:
                    # å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡º
                    self.logger.error(f"âŒ è½¬è´¦å¤±è´¥: {e}")
                    raise

        # é‡è¯•è€—å°½
        raise Exception("è½¬è´¦å¤±è´¥: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")

    def get_account_balance(self, account_id):
        """æŸ¥è¯¢è´¦æˆ·ä½™é¢"""

        self.cursor.execute("""
            SELECT balance, currency
            FROM accounts
            WHERE account_id = %s;
        """, (account_id,))

        result = self.cursor.fetchone()
        if not result:
            raise ValueError("è´¦æˆ·ä¸å­˜åœ¨")

        return {'balance': float(result[0]), 'currency': result[1]}

    def get_transaction_history(self, account_id, limit=100):
        """æŸ¥è¯¢äº¤æ˜“å†å²"""

        self.cursor.execute("""
            SELECT
                transaction_id,
                CASE
                    WHEN from_account_id = %s THEN 'debit'
                    ELSE 'credit'
                END AS type,
                amount,
                CASE
                    WHEN from_account_id = %s THEN to_account_id
                    ELSE from_account_id
                END AS other_account,
                status,
                created_at
            FROM transactions
            WHERE from_account_id = %s OR to_account_id = %s
            ORDER BY created_at DESC
            LIMIT %s;
        """, (account_id, account_id, account_id, account_id, limit))

        return self.cursor.fetchall()
```

---

## 2. å¯¹è´¦æ¨¡å—

```python
class ReconciliationService:
    """å¯¹è´¦æœåŠ¡"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def daily_reconciliation(self, date):
        """æ—¥ç»ˆå¯¹è´¦"""

        # 1. æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
        inconsistencies = self._check_balance_consistency(date)

        if inconsistencies:
            self.logger.error(f"å‘ç°{len(inconsistencies)}ä¸ªè´¦æˆ·ä½™é¢ä¸ä¸€è‡´")
            return False

        # 2. æ£€æŸ¥äº¤æ˜“å®Œæ•´æ€§
        incomplete_txs = self._check_transaction_completeness(date)

        if incomplete_txs:
            self.logger.error(f"å‘ç°{len(incomplete_txs)}ä¸ªæœªå®Œæˆäº¤æ˜“")
            return False

        # 3. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
        report = self._generate_report(date)

        self.logger.info(f"âœ… {date}å¯¹è´¦å®Œæˆ")
        return True

    def _check_balance_consistency(self, date):
        """æ£€æŸ¥ä½™é¢ä¸€è‡´æ€§"""

        self.cursor.execute("""
            WITH calculated_balance AS (
                SELECT
                    account_id,
                    COALESCE(SUM(
                        CASE
                            WHEN to_account_id = account_id THEN amount
                            WHEN from_account_id = account_id THEN -amount
                            ELSE 0
                        END
                    ), 0) AS calc_balance
                FROM accounts a
                LEFT JOIN transactions t ON (
                    (t.from_account_id = a.account_id OR t.to_account_id = a.account_id)
                    AND t.status = 'success'
                    AND DATE(t.completed_at) <= %s
                )
                GROUP BY account_id
            )
            SELECT
                a.account_id,
                a.balance AS actual_balance,
                cb.calc_balance AS calculated_balance,
                a.balance - cb.calc_balance AS diff
            FROM accounts a
            JOIN calculated_balance cb ON a.account_id = cb.account_id
            WHERE ABS(a.balance - cb.calc_balance) > 0.01;  -- å®¹å·®0.01å…ƒ
        """, (date,))

        return self.cursor.fetchall()
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**è¡¨ç»“æ„**: è´¦æˆ· + äº¤æ˜“ + å®¡è®¡ + äº‹ä»¶
**å®Œæ•´æ€§**: ä¹è§‚é” + çº¦æŸ

**è¿”å›**: [æ¡ˆä¾‹5ä¸»é¡µ](./README.md)
