---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èäº¤æ˜“ç³»ç»Ÿ - éœ€æ±‚åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **éš”ç¦»çº§åˆ«**: Serializable

---

## ä¸€ã€æ ¸å¿ƒéœ€æ±‚

### ACIDä¸¥æ ¼ä¿è¯

**è½¬è´¦æ“ä½œå¿…é¡»æ»¡è¶³**:

1. **åŸå­æ€§(A)**: å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
2. **ä¸€è‡´æ€§(C)**: è´¦æˆ·æ€»é¢ä¸å˜
3. **éš”ç¦»æ€§(I)**: Serializableéš”ç¦»çº§åˆ«
4. **æŒä¹…æ€§(D)**: å·²æäº¤æ•°æ®æ°¸ä¸ä¸¢å¤±

---

## äºŒã€å…¸å‹ä¸šåŠ¡åœºæ™¯

### è½¬è´¦æµç¨‹

```sql
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- 1. æ‰£å‡æºè´¦æˆ·
UPDATE accounts
SET balance = balance - 1000,
    updated_at = NOW()
WHERE account_id = 'A001'
  AND balance >= 1000;  -- ä½™é¢æ£€æŸ¥

IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'ä½™é¢ä¸è¶³';
END IF;

-- 2. å¢åŠ ç›®æ ‡è´¦æˆ·
UPDATE accounts
SET balance = balance + 1000,
    updated_at = NOW()
WHERE account_id = 'A002';

-- 3. è®°å½•äº¤æ˜“
INSERT INTO transactions (
    from_account, to_account, amount, type, status
) VALUES (
    'A001', 'A002', 1000, 'TRANSFER', 'SUCCESS'
);

COMMIT;
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    account_id VARCHAR(50) PRIMARY KEY,
    customer_id BIGINT,
    balance NUMERIC(18,2) NOT NULL CHECK (balance >= 0),
    currency VARCHAR(3) DEFAULT 'CNY',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
    transaction_id BIGSERIAL PRIMARY KEY,
    from_account VARCHAR(50),
    to_account VARCHAR(50),
    amount NUMERIC(18,2),
    currency VARCHAR(3),
    type VARCHAR(20),
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (from_account) REFERENCES accounts(account_id),
    FOREIGN KEY (to_account) REFERENCES accounts(account_id)
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
    audit_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    old_values JSONB,
    new_values JSONB,
    user_id BIGINT,
    client_ip INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## å››ã€å¹‚ç­‰æ€§è®¾è®¡

```sql
-- äº¤æ˜“è¯·æ±‚è¡¨ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰
CREATE TABLE transaction_requests (
    request_id VARCHAR(100) PRIMARY KEY,  -- å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€ID
    transaction_id BIGINT,
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (request_id)
);

-- è½¬è´¦å‡½æ•°ï¼ˆå¹‚ç­‰ï¼‰
CREATE OR REPLACE FUNCTION transfer_money(
    p_request_id VARCHAR(100),
    p_from_account VARCHAR(50),
    p_to_account VARCHAR(50),
    p_amount NUMERIC(18,2)
) RETURNS BIGINT AS $$
DECLARE
    v_transaction_id BIGINT;
BEGIN
    -- æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    SELECT transaction_id INTO v_transaction_id
    FROM transaction_requests
    WHERE request_id = p_request_id;

    IF FOUND THEN
        RETURN v_transaction_id;  -- è¿”å›å·²æœ‰äº¤æ˜“ID
    END IF;

    -- æ‰§è¡Œè½¬è´¦
    -- ... è½¬è´¦é€»è¾‘ ...

    -- è®°å½•è¯·æ±‚
    INSERT INTO transaction_requests (request_id, transaction_id, status)
    VALUES (p_request_id, v_transaction_id, 'SUCCESS');

    RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **äº‹åŠ¡æäº¤ä¼˜åŒ–**: TPS+30%
- **å®¡è®¡æ—¥å¿—å¢å¼º**: JSONæ ¼å¼ï¼Œå¼‚æ­¥å†™å…¥
- **WALä¼˜åŒ–**: ç¡®ä¿é›¶æ•°æ®ä¸¢å¤±
- **Serializableä¼˜åŒ–**: å‡å°‘false positive

---

**æ–‡æ¡£å®Œæˆ** âœ…
