---

> **ðŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èžäº¤æ˜“ç³»ç»Ÿ\01-éœ€æ±‚åˆ†æž.md`
> **ðŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŽŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èžäº¤æ˜“ç³»ç»Ÿ - éœ€æ±‚åˆ†æž

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **éš”ç¦»çº§åˆ«**: Serializable

---

## ä¸€ã€æ ¸å¿ƒéœ€æ±‚

### ACIDä¸¥æ ¼ä¿è¯

**è½¬è´¦æ“ä½œå¿…é¡»æ»¡è¶³**:

1. **åŽŸå­æ€§(A)**: å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
2. **ä¸€è‡´æ€§(C)**: è´¦æˆ·æ€»é¢ä¸å˜
3. **éš”ç¦»æ€§(I)**: Serializableéš”ç¦»çº§åˆ«
4. **æŒä¹…æ€§(D)**: å·²æäº¤æ•°æ®æ°¸ä¸ä¸¢å¤±

---

## äºŒã€å…¸åž‹ä¸šåŠ¡åœºæ™¯

### è½¬è´¦æµç¨‹

```sql
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- 1. æ‰£å‡æºè´¦æˆ·
UPDATE accounts
SET balance = balance - 1000,
    updated_at = NOW()
WHERE account_id = 'A001'
  AND balance >= 1000;  -- ä½™é¢æ£€æŸ¥

IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'ä½™é¢ä¸è¶³';
END IF;

-- 2. å¢žåŠ ç›®æ ‡è´¦æˆ·
UPDATE accounts
SET balance = balance + 1000,
    updated_at = NOW()
WHERE account_id = 'A002';

-- 3. è®°å½•äº¤æ˜“
INSERT INTO transactions (
    from_account, to_account, amount, type, status
) VALUES (
    'A001', 'A002', 1000, 'TRANSFER', 'SUCCESS'
);

COMMIT;
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    account_id VARCHAR(50) PRIMARY KEY,
    customer_id BIGINT,
    balance NUMERIC(18,2) NOT NULL CHECK (balance >= 0),
    currency VARCHAR(3) DEFAULT 'CNY',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
    transaction_id BIGSERIAL PRIMARY KEY,
    from_account VARCHAR(50),
    to_account VARCHAR(50),
    amount NUMERIC(18,2),
    currency VARCHAR(3),
    type VARCHAR(20),
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (from_account) REFERENCES accounts(account_id),
    FOREIGN KEY (to_account) REFERENCES accounts(account_id)
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
    audit_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    old_values JSONB,
    new_values JSONB,
    user_id BIGINT,
    client_ip INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## å››ã€å¹‚ç­‰æ€§è®¾è®¡

```sql
-- äº¤æ˜“è¯·æ±‚è¡¨ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰
CREATE TABLE transaction_requests (
    request_id VARCHAR(100) PRIMARY KEY,  -- å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€ID
    transaction_id BIGINT,
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (request_id)
);

-- è½¬è´¦å‡½æ•°ï¼ˆå¹‚ç­‰ï¼‰
CREATE OR REPLACE FUNCTION transfer_money(
    p_request_id VARCHAR(100),
    p_from_account VARCHAR(50),
    p_to_account VARCHAR(50),
    p_amount NUMERIC(18,2)
) RETURNS BIGINT AS $$
DECLARE
    v_transaction_id BIGINT;
BEGIN
    -- æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    SELECT transaction_id INTO v_transaction_id
    FROM transaction_requests
    WHERE request_id = p_request_id;

    IF FOUND THEN
        RETURN v_transaction_id;  -- è¿”å›žå·²æœ‰äº¤æ˜“ID
    END IF;

    -- æ‰§è¡Œè½¬è´¦
    -- ... è½¬è´¦é€»è¾‘ ...

    -- è®°å½•è¯·æ±‚
    INSERT INTO transaction_requests (request_id, transaction_id, status)
    VALUES (p_request_id, v_transaction_id, 'SUCCESS');

    RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

---

## äº”ã€PostgreSQL 18ç‰¹æ€§

- **äº‹åŠ¡æäº¤ä¼˜åŒ–**: TPS+30%
- **å®¡è®¡æ—¥å¿—å¢žå¼º**: JSONæ ¼å¼ï¼Œå¼‚æ­¥å†™å…¥
- **WALä¼˜åŒ–**: ç¡®ä¿é›¶æ•°æ®ä¸¢å¤±
- **Serializableä¼˜åŒ–**: å‡å°‘false positive

---

---

## å…­ã€æ€§èƒ½éœ€æ±‚

### 6.1 æ€§èƒ½æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡è¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½æŒ‡æ ‡ç›‘æŽ§è¡¨
CREATE TABLE IF NOT EXISTS performance_requirements (
    id SERIAL PRIMARY KEY,
    metric_name TEXT UNIQUE,
    target_value NUMERIC,
    unit TEXT,
    measurement_method TEXT
);

-- æ’å…¥æ€§èƒ½æŒ‡æ ‡
INSERT INTO performance_requirements (metric_name, target_value, unit, measurement_method)
VALUES
    ('TPS', 10000, 'transactions/second', 'pg_stat_database'),
    ('P95å»¶è¿Ÿ', 50, 'milliseconds', 'pg_stat_statements'),
    ('P99å»¶è¿Ÿ', 100, 'milliseconds', 'pg_stat_statements'),
    ('å¯ç”¨æ€§', 99.99, 'percent', 'uptimeç›‘æŽ§')
ON CONFLICT (metric_name) DO UPDATE
SET target_value = EXCLUDED.target_value;

-- æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_performance_requirements()
RETURNS TABLE (
    metric_name TEXT,
    target_value NUMERIC,
    current_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        pr.metric_name,
        pr.target_value,
        CASE pr.metric_name
            WHEN 'TPS' THEN
                (SELECT SUM(xact_commit) / EXTRACT(EPOCH FROM (NOW() - stats_reset))
                 FROM pg_stat_database WHERE datname = current_database())
            WHEN 'P95å»¶è¿Ÿ' THEN
                (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY mean_exec_time)
                 FROM pg_stat_statements)
            ELSE NULL
        END AS current_value,
        CASE pr.metric_name
            WHEN 'TPS' THEN
                CASE
                    WHEN (SELECT SUM(xact_commit) / EXTRACT(EPOCH FROM (NOW() - stats_reset))
                          FROM pg_stat_database WHERE datname = current_database()) >= pr.target_value
                    THEN 'è¾¾æ ‡'
                    ELSE 'æœªè¾¾æ ‡'
                END
            WHEN 'P95å»¶è¿Ÿ' THEN
                CASE
                    WHEN (SELECT PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY mean_exec_time)
                          FROM pg_stat_statements) <= pr.target_value
                    THEN 'è¾¾æ ‡'
                    ELSE 'æœªè¾¾æ ‡'
                END
            ELSE 'å¾…æ£€æŸ¥'
        END AS status
    FROM performance_requirements pr;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€å®‰å…¨éœ€æ±‚

### 7.1 å®‰å…¨å®¡è®¡

**å®‰å…¨å®¡è®¡é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- å¯ç”¨å®¡è®¡æ—¥å¿—
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET log_connections = on;
ALTER SYSTEM SET log_disconnections = on;
ALTER SYSTEM SET log_duration = on;
ALTER SYSTEM SET log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';
SELECT pg_reload_conf();

-- å®¡è®¡æ—¥å¿—æŸ¥è¯¢å‡½æ•°
CREATE OR REPLACE FUNCTION query_audit_logs(
    p_start_time TIMESTAMPTZ DEFAULT NOW() - INTERVAL '1 day',
    p_end_time TIMESTAMPTZ DEFAULT NOW(),
    p_user_name TEXT DEFAULT NULL
)
RETURNS TABLE (
    log_time TIMESTAMPTZ,
    user_name TEXT,
    database_name TEXT,
    application_name TEXT,
    client_address INET,
    query_text TEXT
) AS $$
BEGIN
    -- å®žé™…åº”è¯¥ä»Žpg_logæˆ–å¤–éƒ¨æ—¥å¿—ç³»ç»ŸæŸ¥è¯¢
    -- è¿™é‡Œç®€åŒ–å¤„ç†
    RETURN QUERY
    SELECT
        NOW() AS log_time,
        usename::TEXT,
        datname::TEXT,
        application_name::TEXT,
        client_addr,
        LEFT(query, 200)::TEXT
    FROM pg_stat_activity
    WHERE (p_user_name IS NULL OR usename = p_user_name)
      AND state = 'active'
    LIMIT 100;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
