---

> **üìã ÊñáÊ°£Êù•Ê∫ê**: `DataBaseTheory\19-Âú∫ÊôØÊ°à‰æãÂ∫ì\05-ÈáëËûç‰∫§ÊòìÁ≥ªÁªü\03-Êï∞ÊçÆÂ∫ìËÆæËÆ°.md`
> **üìÖ Â§çÂà∂Êó•Êúü**: 2025-12-22
> **‚ö†Ô∏è Ê≥®ÊÑè**: Êú¨ÊñáÊ°£‰∏∫Â§çÂà∂ÁâàÊú¨ÔºåÂéüÊñá‰ª∂‰øùÊåÅ‰∏çÂèò

---

# Ê°à‰æã5ÔºöÈáëËûç‰∫§ÊòìÁ≥ªÁªü - Êï∞ÊçÆÂ∫ìËÆæËÆ°

## ÂÖÉÊï∞ÊçÆ

- **ÂàõÂª∫Êó•Êúü**: 2025-12-04
- **ÈöîÁ¶ªÁ∫ßÂà´**: SERIALIZABLE
- **ÂÆ°ËÆ°**: ÂÆåÊï¥ÂÆ°ËÆ°ËΩ®Ëøπ

---

## 1. Ê†∏ÂøÉË°®ËÆæËÆ°

```sql
-- 1. Ë¥¶Êà∑Ë°®
CREATE TABLE accounts (
    account_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    account_number VARCHAR(32) UNIQUE NOT NULL,
    balance NUMERIC(20, 2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(3) NOT NULL DEFAULT 'CNY',
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/frozen/closed
    version INT NOT NULL DEFAULT 0,  -- ‰πêËßÇÈîÅÁâàÊú¨Âè∑
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_balance_non_negative CHECK (balance >= 0)
);

CREATE INDEX idx_accounts_user ON accounts (user_id);
CREATE INDEX idx_accounts_number ON accounts (account_number);

-- 2. ‰∫§ÊòìË°®
CREATE TABLE transactions (
    transaction_id BIGSERIAL PRIMARY KEY,
    from_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    to_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    amount NUMERIC(20, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,  -- transfer/deposit/withdraw
    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending/success/failed
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    CONSTRAINT chk_amount_positive CHECK (amount > 0),
    CONSTRAINT chk_different_accounts CHECK (from_account_id != to_account_id)
);

CREATE INDEX idx_transactions_from ON transactions (from_account_id, created_at);
CREATE INDEX idx_transactions_to ON transactions (to_account_id, created_at);
CREATE INDEX idx_transactions_status ON transactions (status);

-- 3. ÂÆ°ËÆ°Êó•ÂøóË°®
CREATE TABLE audit_logs (
    log_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT REFERENCES transactions(transaction_id),
    account_id BIGINT REFERENCES accounts(account_id),
    action VARCHAR(50) NOT NULL,
    old_value JSONB,
    new_value JSONB,
    user_id BIGINT,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_transaction ON audit_logs (transaction_id);
CREATE INDEX idx_audit_account ON audit_logs (account_id);
CREATE INDEX idx_audit_created ON audit_logs (created_at);

-- 4. ‰∫ã‰ª∂Ë°®ÔºàEvent SourcingÔºâ
CREATE TABLE account_events (
    event_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    event_type VARCHAR(50) NOT NULL,
    event_data JSONB NOT NULL,
    sequence_number BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (account_id, sequence_number)
);

CREATE INDEX idx_events_account ON account_events (account_id, sequence_number);
```

---

## 2. Ê†∏ÂøÉ‰∏öÂä°ÂáΩÊï∞

```sql
-- ËΩ¨Ë¥¶ÂáΩÊï∞ÔºàÂ∏¶‰πêËßÇÈîÅÔºâ
CREATE OR REPLACE FUNCTION transfer_money(
    p_from_account BIGINT,
    p_to_account BIGINT,
    p_amount NUMERIC,
    p_user_id BIGINT
) RETURNS BIGINT AS $$
DECLARE
    v_from_version INT;
    v_to_version INT;
    v_transaction_id BIGINT;
BEGIN
    -- 1. ÈîÅÂÆöÂπ∂Ê£ÄÊü•Ê∫êË¥¶Êà∑
    SELECT version, balance INTO v_from_version
    FROM accounts
    WHERE account_id = p_from_account
    FOR UPDATE;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Ê∫êË¥¶Êà∑‰∏çÂ≠òÂú®';
    END IF;

    IF (SELECT balance FROM accounts WHERE account_id = p_from_account) < p_amount THEN
        RAISE EXCEPTION '‰ΩôÈ¢ù‰∏çË∂≥';
    END IF;

    -- 2. ÈîÅÂÆöÁõÆÊ†áË¥¶Êà∑
    SELECT version INTO v_to_version
    FROM accounts
    WHERE account_id = p_to_account
    FOR UPDATE;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'ÁõÆÊ†áË¥¶Êà∑‰∏çÂ≠òÂú®';
    END IF;

    -- 3. ÂàõÂª∫‰∫§ÊòìËÆ∞ÂΩï
    INSERT INTO transactions (from_account_id, to_account_id, amount, currency, transaction_type)
    VALUES (p_from_account, p_to_account, p_amount, 'CNY', 'transfer')
    RETURNING transaction_id INTO v_transaction_id;

    -- 4. Êâ£Ê¨æÔºà‰πêËßÇÈîÅÔºâ
    UPDATE accounts
    SET balance = balance - p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_from_account
      AND version = v_from_version;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Ê∫êË¥¶Êà∑ÁâàÊú¨ÂÜ≤Á™ÅÔºåËØ∑ÈáçËØï';
    END IF;

    -- 5. ÂÖ•Ë¥¶
    UPDATE accounts
    SET balance = balance + p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_to_account
      AND version = v_to_version;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'ÁõÆÊ†áË¥¶Êà∑ÁâàÊú¨ÂÜ≤Á™ÅÔºåËØ∑ÈáçËØï';
    END IF;

    -- 6. Êõ¥Êñ∞‰∫§ÊòìÁä∂ÊÄÅ
    UPDATE transactions
    SET status = 'success',
        completed_at = CURRENT_TIMESTAMP
    WHERE transaction_id = v_transaction_id;

    -- 7. ËÆ∞ÂΩïÂÆ°ËÆ°Êó•Âøó
    INSERT INTO audit_logs (transaction_id, account_id, action, user_id)
    VALUES (v_transaction_id, p_from_account, 'debit', p_user_id),
           (v_transaction_id, p_to_account, 'credit', p_user_id);

    RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

---

**ÂÆåÊàêÊó•Êúü**: 2025-12-04
**‰∫ãÂä°Ê®°Âûã**: ACID + ‰πêËßÇÈîÅ
**ÂÆ°ËÆ°**: ÂÆåÊï¥ÂÆ°ËÆ°Êó•Âøó

**ËøîÂõû**: [Ê°à‰æã5‰∏ªÈ°µ](./README.md)
