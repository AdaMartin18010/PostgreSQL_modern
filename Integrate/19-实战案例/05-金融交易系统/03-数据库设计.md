---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\03-æ•°æ®åº“è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹5ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **éš”ç¦»çº§åˆ«**: SERIALIZABLE
- **å®¡è®¡**: å®Œæ•´å®¡è®¡è½¨è¿¹

---

## 1. æ ¸å¿ƒè¡¨è®¾è®¡

```sql
-- 1. è´¦æˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            CREATE TABLE accounts (
                account_id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL,
                account_number VARCHAR(32) UNIQUE NOT NULL,
                balance NUMERIC(20, 2) NOT NULL DEFAULT 0.00,
                currency VARCHAR(3) NOT NULL DEFAULT 'CNY',
                status VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/frozen/closed
                version INT NOT NULL DEFAULT 0,  -- ä¹è§‚é”ç‰ˆæœ¬å·
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT chk_balance_non_negative CHECK (balance >= 0)
            );
            RAISE NOTICE 'è´¦æˆ·è¡¨ accounts åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è´¦æˆ·è¡¨ accounts å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è´¦æˆ·è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè´¦æˆ·è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è´¦æˆ·è¡¨ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_accounts_user') THEN
            CREATE INDEX idx_accounts_user ON accounts (user_id);
            RAISE NOTICE 'ç´¢å¼• idx_accounts_user åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_accounts_number') THEN
            CREATE INDEX idx_accounts_number ON accounts (account_number);
            RAISE NOTICE 'ç´¢å¼• idx_accounts_number åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. äº¤æ˜“è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
                RAISE EXCEPTION 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºäº¤æ˜“è¡¨ï¼ˆéœ€è¦å¤–é”®å¼•ç”¨ï¼‰';
            END IF;
            
            CREATE TABLE transactions (
                transaction_id BIGSERIAL PRIMARY KEY,
                from_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
                to_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
                amount NUMERIC(20, 2) NOT NULL,
                currency VARCHAR(3) NOT NULL,
                transaction_type VARCHAR(20) NOT NULL,  -- transfer/deposit/withdraw
                status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending/success/failed
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMPTZ,
                CONSTRAINT chk_amount_positive CHECK (amount > 0),
                CONSTRAINT chk_different_accounts CHECK (from_account_id != to_account_id)
            );
            RAISE NOTICE 'äº¤æ˜“è¡¨ transactions åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'äº¤æ˜“è¡¨ transactions å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'äº¤æ˜“è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºäº¤æ˜“è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äº¤æ˜“è¡¨ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_from') THEN
            CREATE INDEX idx_transactions_from ON transactions (from_account_id, created_at);
            RAISE NOTICE 'ç´¢å¼• idx_transactions_from åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_to') THEN
            CREATE INDEX idx_transactions_to ON transactions (to_account_id, created_at);
            RAISE NOTICE 'ç´¢å¼• idx_transactions_to åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_status') THEN
            CREATE INDEX idx_transactions_status ON transactions (status);
            RAISE NOTICE 'ç´¢å¼• idx_transactions_status åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å®¡è®¡æ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_logs') THEN
            CREATE TABLE audit_logs (
                log_id BIGSERIAL PRIMARY KEY,
                transaction_id BIGINT REFERENCES transactions(transaction_id),
                account_id BIGINT REFERENCES accounts(account_id),
                action VARCHAR(50) NOT NULL,
                old_value JSONB,
                new_value JSONB,
                user_id BIGINT,
                ip_address INET,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            );
            RAISE NOTICE 'å®¡è®¡æ—¥å¿—è¡¨ audit_logs åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å®¡è®¡æ—¥å¿—è¡¨ audit_logs å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'å®¡è®¡æ—¥å¿—è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®¡è®¡æ—¥å¿—è¡¨ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_logs') THEN
            RAISE WARNING 'è¡¨ audit_logs ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_audit_transaction') THEN
            CREATE INDEX idx_audit_transaction ON audit_logs (transaction_id);
            RAISE NOTICE 'ç´¢å¼• idx_audit_transaction åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_audit_account') THEN
            CREATE INDEX idx_audit_account ON audit_logs (account_id);
            RAISE NOTICE 'ç´¢å¼• idx_audit_account åˆ›å»ºæˆåŠŸ';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_audit_created') THEN
            CREATE INDEX idx_audit_created ON audit_logs (created_at);
            RAISE NOTICE 'ç´¢å¼• idx_audit_created åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. äº‹ä»¶è¡¨ï¼ˆEvent Sourcingï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'account_events') THEN
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
                RAISE EXCEPTION 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºäº‹ä»¶è¡¨ï¼ˆéœ€è¦å¤–é”®å¼•ç”¨ï¼‰';
            END IF;
            
            CREATE TABLE account_events (
                event_id BIGSERIAL PRIMARY KEY,
                account_id BIGINT NOT NULL REFERENCES accounts(account_id),
                event_type VARCHAR(50) NOT NULL,
                event_data JSONB NOT NULL,
                sequence_number BIGINT NOT NULL,
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                UNIQUE (account_id, sequence_number)
            );
            RAISE NOTICE 'äº‹ä»¶è¡¨ account_events åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'äº‹ä»¶è¡¨ account_events å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'äº‹ä»¶è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºäº‹ä»¶è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äº‹ä»¶è¡¨ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'account_events') THEN
            RAISE WARNING 'è¡¨ account_events ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_events_account') THEN
            CREATE INDEX idx_events_account ON account_events (account_id, sequence_number);
            RAISE NOTICE 'ç´¢å¼• idx_events_account åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. æ ¸å¿ƒä¸šåŠ¡å‡½æ•°

```sql
-- è½¬è´¦å‡½æ•°ï¼ˆå¸¦ä¹è§‚é”å’Œå®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION transfer_money(
    p_from_account BIGINT,
    p_to_account BIGINT,
    p_amount NUMERIC,
    p_user_id BIGINT
) RETURNS BIGINT AS $$
DECLARE
    v_from_version INT;
    v_to_version INT;
    v_transaction_id BIGINT;
    v_from_balance NUMERIC;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_from_account IS NULL OR p_to_account IS NULL THEN
            RAISE EXCEPTION 'è´¦æˆ·IDä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF p_from_account = p_to_account THEN
            RAISE EXCEPTION 'æºè´¦æˆ·å’Œç›®æ ‡è´¦æˆ·ä¸èƒ½ç›¸åŒ';
        END IF;
        
        IF p_amount IS NULL OR p_amount <= 0 THEN
            RAISE EXCEPTION 'è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0';
        END IF;
        
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'ç”¨æˆ·IDä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_logs') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
        
        -- 1. é”å®šå¹¶æ£€æŸ¥æºè´¦æˆ·
        SELECT version, balance INTO v_from_version, v_from_balance
        FROM accounts
        WHERE account_id = p_from_account
        FOR UPDATE;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'æºè´¦æˆ·ä¸å­˜åœ¨';
        END IF;

        IF v_from_balance < p_amount THEN
            RAISE EXCEPTION 'ä½™é¢ä¸è¶³: å½“å‰ä½™é¢%, è½¬è´¦é‡‘é¢%', v_from_balance, p_amount;
        END IF;

        -- 2. é”å®šç›®æ ‡è´¦æˆ·
        SELECT version INTO v_to_version
        FROM accounts
        WHERE account_id = p_to_account
        FOR UPDATE;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'ç›®æ ‡è´¦æˆ·ä¸å­˜åœ¨';
        END IF;

        -- 3. åˆ›å»ºäº¤æ˜“è®°å½•
        INSERT INTO transactions (from_account_id, to_account_id, amount, currency, transaction_type)
        VALUES (p_from_account, p_to_account, p_amount, 'CNY', 'transfer')
        RETURNING transaction_id INTO v_transaction_id;

        -- 4. æ‰£æ¬¾ï¼ˆä¹è§‚é”ï¼‰
        UPDATE accounts
        SET balance = balance - p_amount,
            version = version + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE account_id = p_from_account
          AND version = v_from_version;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'æºè´¦æˆ·ç‰ˆæœ¬å†²çªï¼Œè¯·é‡è¯•';
        END IF;

        -- 5. å…¥è´¦
        UPDATE accounts
        SET balance = balance + p_amount,
            version = version + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE account_id = p_to_account
          AND version = v_to_version;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'ç›®æ ‡è´¦æˆ·ç‰ˆæœ¬å†²çªï¼Œè¯·é‡è¯•';
        END IF;

        -- 6. æ›´æ–°äº¤æ˜“çŠ¶æ€
        UPDATE transactions
        SET status = 'success',
            completed_at = CURRENT_TIMESTAMP
        WHERE transaction_id = v_transaction_id;

        -- 7. è®°å½•å®¡è®¡æ—¥å¿—
        INSERT INTO audit_logs (transaction_id, account_id, action, user_id)
        VALUES (v_transaction_id, p_from_account, 'debit', p_user_id),
               (v_transaction_id, p_to_account, 'credit', p_user_id);

        RETURN v_transaction_id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è½¬è´¦å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

---

## 3. äº‹ä»¶æº¯æºå®ç°

### 3.1 äº‹ä»¶å­˜å‚¨

**äº‹ä»¶å­˜å‚¨å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- äº‹ä»¶å­˜å‚¨å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION store_account_event(
    p_account_id BIGINT,
    p_event_type TEXT,
    p_event_data JSONB
)
RETURNS BIGINT AS $$
DECLARE
    v_sequence_number BIGINT;
    v_event_id BIGINT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_account_id IS NULL THEN
            RAISE EXCEPTION 'account_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF p_event_type IS NULL OR p_event_type = '' THEN
            RAISE EXCEPTION 'event_typeä¸èƒ½ä¸ºç©º';
        END IF;
        
        IF p_event_data IS NULL THEN
            RAISE EXCEPTION 'event_dataä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'account_events') THEN
            RAISE EXCEPTION 'è¡¨ account_events ä¸å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') OR
           NOT EXISTS (SELECT 1 FROM accounts WHERE account_id = p_account_id) THEN
            RAISE EXCEPTION 'è´¦æˆ· % ä¸å­˜åœ¨', p_account_id;
        END IF;
        
        -- è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
        SELECT COALESCE(MAX(sequence_number), 0) + 1
        INTO v_sequence_number
        FROM account_events
        WHERE account_id = p_account_id;

        -- æ’å…¥äº‹ä»¶
        INSERT INTO account_events (
            account_id, event_type, event_data, sequence_number
        )
        VALUES (
            p_account_id, p_event_type, p_event_data, v_sequence_number
        )
        RETURNING event_id INTO v_event_id;

        RETURN v_event_id;
    EXCEPTION
        WHEN unique_violation THEN
            RAISE EXCEPTION 'äº‹ä»¶åºåˆ—å·å†²çª: account_id=%, sequence=%', p_account_id, v_sequence_number;
        WHEN OTHERS THEN
            RAISE EXCEPTION 'å­˜å‚¨äº‹ä»¶å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 è´¦æˆ·çŠ¶æ€é‡å»º

**è´¦æˆ·çŠ¶æ€é‡å»ºå‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è´¦æˆ·çŠ¶æ€é‡å»ºå‡½æ•°ï¼ˆä»äº‹ä»¶é‡å»ºï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION rebuild_account_state(
    p_account_id BIGINT
)
RETURNS TABLE (
    account_id BIGINT,
    balance NUMERIC,
    version INT,
    last_event_id BIGINT
) AS $$
DECLARE
    v_balance NUMERIC := 0;
    v_version INT := 0;
    v_last_event_id BIGINT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_account_id IS NULL THEN
            RAISE EXCEPTION 'account_idä¸èƒ½ä¸ºNULL';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'account_events') THEN
            RAISE EXCEPTION 'è¡¨ account_events ä¸å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') OR
           NOT EXISTS (SELECT 1 FROM accounts WHERE account_id = p_account_id) THEN
            RAISE EXCEPTION 'è´¦æˆ· % ä¸å­˜åœ¨', p_account_id;
        END IF;
        
        -- ä»äº‹ä»¶é‡å»ºè´¦æˆ·çŠ¶æ€
        SELECT
            COALESCE(SUM(
                CASE
                    WHEN event_type = 'deposit' THEN (event_data->>'amount')::NUMERIC
                    WHEN event_type = 'withdraw' THEN -(event_data->>'amount')::NUMERIC
                    WHEN event_type = 'transfer_out' THEN -(event_data->>'amount')::NUMERIC
                    WHEN event_type = 'transfer_in' THEN (event_data->>'amount')::NUMERIC
                    ELSE 0
                END
            ), 0),
            MAX(event_id)
        INTO v_balance, v_last_event_id
        FROM account_events
        WHERE account_id = p_account_id;

        v_version := (SELECT COUNT(*) FROM account_events WHERE account_id = p_account_id);

        RETURN QUERY SELECT
            p_account_id,
            v_balance,
            v_version,
            v_last_event_id;

        RETURN;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'é‡å»ºè´¦æˆ·çŠ¶æ€å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- è°ƒç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM rebuild_account_state(1)
LIMIT 100;
```

---

## 4. å¯¹è´¦ä¸ä¸€è‡´æ€§æ£€æŸ¥

### 4.1 è´¦æˆ·ä½™é¢ä¸€è‡´æ€§æ£€æŸ¥

**è´¦æˆ·ä½™é¢ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è´¦æˆ·ä½™é¢ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_account_consistency(
    p_account_id BIGINT DEFAULT NULL
)
RETURNS TABLE (
    account_id BIGINT,
    current_balance NUMERIC,
    calculated_balance NUMERIC,
    difference NUMERIC,
    status TEXT
) AS $$
DECLARE
    account_record RECORD;
    calculated_balance_val NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'account_events') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
        
        FOR account_record IN
            SELECT a.account_id, a.balance
            FROM accounts a
            WHERE (p_account_id IS NULL OR a.account_id = p_account_id)
        LOOP
            -- ä»äº‹ä»¶è®¡ç®—ä½™é¢
            SELECT COALESCE(SUM(
                CASE
                    WHEN event_type = 'deposit' THEN (event_data->>'amount')::NUMERIC
                    WHEN event_type = 'withdraw' THEN -(event_data->>'amount')::NUMERIC
                    WHEN event_type = 'transfer_out' THEN -(event_data->>'amount')::NUMERIC
                    WHEN event_type = 'transfer_in' THEN (event_data->>'amount')::NUMERIC
                    ELSE 0
                END
            ), 0)
            INTO calculated_balance_val
            FROM account_events
            WHERE account_id = account_record.account_id;

            RETURN QUERY SELECT
                account_record.account_id,
                account_record.balance,
                calculated_balance_val,
                ABS(account_record.balance - calculated_balance_val),
                CASE
                    WHEN ABS(account_record.balance - calculated_balance_val) < 0.01 THEN 'ä¸€è‡´'
                    ELSE 'ä¸ä¸€è‡´'
                END;
        END LOOP;

        RETURN;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è´¦æˆ·ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- è°ƒç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM check_account_consistency(NULL)
LIMIT 100;
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_coverage') THEN
            CREATE INDEX idx_transactions_coverage
            ON transactions (from_account_id, created_at)
            INCLUDE (to_account_id, amount, status);
            RAISE NOTICE 'è¦†ç›–ç´¢å¼• idx_transactions_coverage åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¦†ç›–ç´¢å¼• idx_transactions_coverage å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_active') THEN
            CREATE INDEX idx_transactions_active
            ON transactions (status, created_at)
            WHERE status IN ('pending', 'success');
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_transactions_active åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_transactions_active å·²å­˜åœ¨';
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_date') THEN
            CREATE INDEX idx_transactions_date
            ON transactions ((created_at::DATE));
            RAISE NOTICE 'è¡¨è¾¾å¼ç´¢å¼• idx_transactions_date åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨è¾¾å¼ç´¢å¼• idx_transactions_date å·²å­˜åœ¨';
        END IF;
        
        RAISE NOTICE 'PostgreSQL 18ï¼šSkip Scanä¼˜åŒ–å¤šåˆ—ç´¢å¼•ï¼Œè‡ªåŠ¨ä¼˜åŒ–å¤šåˆ—ç´¢å¼•æŸ¥è¯¢';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ä¼˜åŒ–è´¦æˆ·æŸ¥è¯¢ï¼ˆä½¿ç”¨å‡†å¤‡è¯­å¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•å‡†å¤‡è¯­å¥';
            RETURN;
        END IF;
        
        -- å‡†å¤‡è¯­å¥ï¼ˆPostgreSQL 18è‡ªåŠ¨ç¼“å­˜ï¼‰
        PREPARE get_account_balance (BIGINT) AS
        SELECT account_id, balance, version, updated_at
        FROM accounts
        WHERE account_id = $1;
        
        RAISE NOTICE 'å‡†å¤‡è¯­å¥ get_account_balance åˆ›å»ºæˆåŠŸï¼ˆPostgreSQL 18è‡ªåŠ¨ç¼“å­˜ï¼‰';
    EXCEPTION
        WHEN duplicate_prepared_statement THEN
            RAISE NOTICE 'å‡†å¤‡è¯­å¥å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡†å¤‡è¯­å¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¼˜åŒ–äº¤æ˜“å†å²æŸ¥è¯¢ï¼ˆä½¿ç”¨å‡†å¤‡è¯­å¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•å‡†å¤‡è¯­å¥';
            RETURN;
        END IF;
        
        PREPARE get_transaction_history (BIGINT, INT, INT) AS
        SELECT
            transaction_id,
            from_account_id,
            to_account_id,
            amount,
            status,
            created_at
        FROM transactions
        WHERE from_account_id = $1 OR to_account_id = $1
        ORDER BY created_at DESC
        LIMIT $2 OFFSET $3;
        
        RAISE NOTICE 'å‡†å¤‡è¯­å¥ get_transaction_history åˆ›å»ºæˆåŠŸï¼ˆPostgreSQL 18è‡ªåŠ¨ç¼“å­˜ï¼‰';
    EXCEPTION
        WHEN duplicate_prepared_statement THEN
            RAISE NOTICE 'å‡†å¤‡è¯­å¥å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡†å¤‡è¯­å¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰§è¡Œï¼ˆåˆ©ç”¨è®¡åˆ’ç¼“å­˜ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXECUTE get_account_balance(12345);

EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXECUTE get_transaction_history(12345, 20, 0);
```

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**äº‹åŠ¡æ¨¡å‹**: ACID + ä¹è§‚é”
**å®¡è®¡**: å®Œæ•´å®¡è®¡æ—¥å¿—

**è¿”å›**: [æ¡ˆä¾‹5ä¸»é¡µ](./README.md)
