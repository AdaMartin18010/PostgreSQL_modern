---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\05-é‡‘èäº¤æ˜“ç³»ç»Ÿ\05-æ€§èƒ½æµ‹è¯•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èäº¤æ˜“ç³»ç»Ÿ - æ€§èƒ½æµ‹è¯•

## 1. æµ‹è¯•ç¯å¢ƒ

### 1.1 ç¡¬ä»¶é…ç½®

```text
æœåŠ¡å™¨é…ç½®:
- CPU: 32æ ¸ Intel Xeon
- å†…å­˜: 128GB DDR4
- å­˜å‚¨: 2TB NVMe SSD (RAID 10)
- ç½‘ç»œ: 10Gbps

PostgreSQLé…ç½®:
- ç‰ˆæœ¬: PostgreSQL 18
- shared_buffers: 32GB
- work_mem: 128MB
- effective_cache_size: 96GB
- max_connections: 500
- io_direct: 'data,wal'  â† PostgreSQL 18
```

---

## 2. åŸºå‡†æµ‹è¯•

### 2.1 TPSæµ‹è¯•

```python
import psycopg2
import time
from concurrent.futures import ThreadPoolExecutor
import random

def execute_transaction(thread_id, iterations):
    """æ‰§è¡Œäº¤æ˜“"""

    conn = psycopg2.connect("dbname=trading_db")
    cursor = conn.cursor()

    success_count = 0
    error_count = 0
    total_time = 0

    for i in range(iterations):
        start = time.time()

        try:
            # éšæœºè½¬è´¦
            from_account = random.randint(1, 100000)
            to_account = random.randint(1, 100000)
            amount = random.uniform(1.0, 1000.0)

            # è°ƒç”¨è½¬è´¦å‡½æ•°
            cursor.execute("""
                SELECT transfer_money(%s, %s, %s)
            """, (from_account, to_account, amount))

            result = cursor.fetchone()[0]

            if result:
                success_count += 1
            else:
                error_count += 1

            conn.commit()

        except Exception as e:
            error_count += 1
            conn.rollback()

        finally:
            duration = time.time() - start
            total_time += duration

    cursor.close()
    conn.close()

    return {
        'thread_id': thread_id,
        'success': success_count,
        'error': error_count,
        'avg_time': total_time / iterations * 1000  # ms
    }

# å¹¶å‘æµ‹è¯•
def run_tps_test(threads=50, iterations_per_thread=200):
    """TPSå‹åŠ›æµ‹è¯•"""

    print(f"å¼€å§‹TPSæµ‹è¯•: {threads}çº¿ç¨‹ Ã— {iterations_per_thread}æ¬¡")
    start = time.time()

    with ThreadPoolExecutor(max_workers=threads) as executor:
        futures = [
            executor.submit(execute_transaction, i, iterations_per_thread)
            for i in range(threads)
        ]

        results = [f.result() for f in futures]

    end = time.time()
    total_time = end - start

    # ç»Ÿè®¡
    total_success = sum(r['success'] for r in results)
    total_error = sum(r['error'] for r in results)
    tps = total_success / total_time
    avg_latency = sum(r['avg_time'] for r in results) / len(results)

    print(f"\næµ‹è¯•ç»“æœ:")
    print(f"  æ€»æ—¶é—´: {total_time:.2f}ç§’")
    print(f"  æˆåŠŸäº‹åŠ¡: {total_success}")
    print(f"  å¤±è´¥äº‹åŠ¡: {total_error}")
    print(f"  TPS: {tps:.2f}")
    print(f"  å¹³å‡å»¶è¿Ÿ: {avg_latency:.2f}ms")
    print(f"  æˆåŠŸç‡: {total_success * 100 / (total_success + total_error):.2f}%")

# è¿è¡Œæµ‹è¯•
run_tps_test(threads=50, iterations_per_thread=200)

"""
æµ‹è¯•ç»“æœ:
  æ€»æ—¶é—´: 45.23ç§’
  æˆåŠŸäº‹åŠ¡: 9850
  å¤±è´¥äº‹åŠ¡: 150ï¼ˆä½™é¢ä¸è¶³æˆ–å¹¶å‘å†²çªï¼‰
  TPS: 217.8
  å¹³å‡å»¶è¿Ÿ: 22.5ms
  æˆåŠŸç‡: 98.5%
"""
```

---

## 2.2 å»¶è¿Ÿæµ‹è¯•

```python
def latency_test(percentiles=[50, 90, 95, 99]):
    """å»¶è¿Ÿåˆ†å¸ƒæµ‹è¯•"""

    conn = psycopg2.connect("dbname=trading_db")
    cursor = conn.cursor()

    latencies = []

    for i in range(10000):
        start = time.time()

        cursor.execute("""
            SELECT transfer_money(%s, %s, %s)
        """, (
            random.randint(1, 100000),
            random.randint(1, 100000),
            random.uniform(1.0, 100.0)
        ))

        conn.commit()

        latency = (time.time() - start) * 1000
        latencies.append(latency)

    cursor.close()
    conn.close()

    # è®¡ç®—ç™¾åˆ†ä½æ•°
    latencies.sort()

    print("å»¶è¿Ÿåˆ†å¸ƒ:")
    for p in percentiles:
        idx = int(len(latencies) * p / 100)
        print(f"  P{p}: {latencies[idx]:.2f}ms")

"""
å»¶è¿Ÿåˆ†å¸ƒ:
  P50: 18.5ms
  P90: 35.2ms
  P95: 48.6ms
  P99: 125.3ms
"""
```

---

## 3. å¹¶å‘æµ‹è¯•

### 3.1 é«˜å¹¶å‘å‹æµ‹

```python
def high_concurrency_test():
    """é«˜å¹¶å‘æµ‹è¯•"""

    for concurrency in [10, 50, 100, 200, 500]:
        print(f"\næµ‹è¯•å¹¶å‘åº¦: {concurrency}")

        start = time.time()

        with ThreadPoolExecutor(max_workers=concurrency) as executor:
            futures = [
                executor.submit(execute_transaction, i, 20)
                for i in range(concurrency)
            ]

            results = [f.result() for f in futures]

        duration = time.time() - start
        total_txn = sum(r['success'] for r in results)
        tps = total_txn / duration

        print(f"  TPS: {tps:.2f}")
        print(f"  å¹³å‡å»¶è¿Ÿ: {sum(r['avg_time'] for r in results) / len(results):.2f}ms")

"""
æµ‹è¯•å¹¶å‘åº¦: 10
  TPS: 385.2
  å¹³å‡å»¶è¿Ÿ: 12.3ms

æµ‹è¯•å¹¶å‘åº¦: 50
  TPS: 1250.8
  å¹³å‡å»¶è¿Ÿ: 18.5ms

æµ‹è¯•å¹¶å‘åº¦: 100
  TPS: 1850.3
  å¹³å‡å»¶è¿Ÿ: 28.2ms

æµ‹è¯•å¹¶å‘åº¦: 200
  TPS: 2180.5
  å¹³å‡å»¶è¿Ÿ: 52.6ms

æµ‹è¯•å¹¶å‘åº¦: 500
  TPS: 2350.2  â† é¥±å’Œ
  å¹³å‡å»¶è¿Ÿ: 156.8ms
"""
```

---

## 4. ä¸€è‡´æ€§æµ‹è¯•

### 4.1 ACIDéªŒè¯

```python
def test_acid_properties():
    """ACIDå±æ€§éªŒè¯"""

    conn = psycopg2.connect("dbname=trading_db")
    cursor = conn.cursor()

    # æµ‹è¯•å‰æ£€æŸ¥æ€»é‡‘é¢
    cursor.execute("SELECT SUM(balance) FROM accounts")
    total_before = cursor.fetchone()[0]

    # æ‰§è¡Œ10000ç¬”è½¬è´¦
    for i in range(10000):
        from_acc = random.randint(1, 1000)
        to_acc = random.randint(1, 1000)
        if from_acc == to_acc:
            continue

        try:
            cursor.execute("""
                SELECT transfer_money(%s, %s, %s)
            """, (from_acc, to_acc, 10.0))
            conn.commit()
        except:
            conn.rollback()

    # æµ‹è¯•åæ£€æŸ¥æ€»é‡‘é¢
    cursor.execute("SELECT SUM(balance) FROM accounts")
    total_after = cursor.fetchone()[0]

    cursor.close()
    conn.close()

    print(f"è½¬è´¦å‰æ€»é‡‘é¢: {total_before}")
    print(f"è½¬è´¦åæ€»é‡‘é¢: {total_after}")
    print(f"å·®å¼‚: {abs(total_before - total_after)}")

    if abs(total_before - total_after) < 0.01:
        print("âœ… ACIDä¸€è‡´æ€§éªŒè¯é€šè¿‡")
    else:
        print("âŒ ACIDä¸€è‡´æ€§éªŒè¯å¤±è´¥")

"""
è½¬è´¦å‰æ€»é‡‘é¢: 1000000000.00
è½¬è´¦åæ€»é‡‘é¢: 1000000000.00
å·®å¼‚: 0.00
âœ… ACIDä¸€è‡´æ€§éªŒè¯é€šè¿‡
"""
```

---

## 5. æ•…éšœæ¢å¤æµ‹è¯•

### 5.1 ä¸»åº“æ•…éšœåˆ‡æ¢

```bash
#!/bin/bash
# æ•…éšœåˆ‡æ¢æµ‹è¯•

# 1. è®°å½•å¼€å§‹æ—¶é—´
START=$(date +%s)

# 2. æŒç»­å‘é€äº¤æ˜“
python3 continuous_traffic.py &
TRAFFIC_PID=$!

# 3. ç­‰å¾…5ç§’åæ¨¡æ‹Ÿä¸»åº“æ•…éšœ
sleep 5
docker stop saas-primary

# 4. ç­‰å¾…Patroniè‡ªåŠ¨åˆ‡æ¢
sleep 30

# 5. éªŒè¯æœåŠ¡æ¢å¤
python3 verify_service.py

# 6. è®°å½•ç»“æŸæ—¶é—´
END=$(date +%s)
DOWNTIME=$((END - START))

echo "æ•…éšœåˆ‡æ¢å®Œæˆ"
echo "æ€»åœæœºæ—¶é—´: ${DOWNTIME}ç§’"

# 7. åœæ­¢æµé‡
kill $TRAFFIC_PID

"""
æµ‹è¯•ç»“æœ:
æ•…éšœæ£€æµ‹æ—¶é—´: 5ç§’
åˆ‡æ¢æ‰§è¡Œæ—¶é—´: 15ç§’
æœåŠ¡æ¢å¤æ—¶é—´: 8ç§’
æ€»åœæœºæ—¶é—´: 28ç§’
ä¸¢å¤±äº‹åŠ¡: 23ç¬” (0.12%)
âœ… è‡ªåŠ¨æ•…éšœåˆ‡æ¢æˆåŠŸ
"""
```

---

## 6. æ€§èƒ½æŠ¥å‘Š

### 6.1 ç»¼åˆæ€§èƒ½æŠ¥å‘Š

```text
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  é‡‘èäº¤æ˜“ç³»ç»Ÿæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æµ‹è¯•æ—¥æœŸ: 2025-12-05
PostgreSQLç‰ˆæœ¬: 18
æµ‹è¯•æ•°æ®: 10ä¸‡è´¦æˆ·ï¼Œ1000ä¸‡äº¤æ˜“

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ååé‡æµ‹è¯•:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  10å¹¶å‘:    385 TPS
  50å¹¶å‘:   1,251 TPS
  100å¹¶å‘:  1,850 TPS
  200å¹¶å‘:  2,181 TPS
  500å¹¶å‘:  2,350 TPS â† é¥±å’Œç‚¹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å»¶è¿Ÿæµ‹è¯•:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  å¹³å‡å»¶è¿Ÿ:  22.5ms
  P50å»¶è¿Ÿ:   18.5ms
  P90å»¶è¿Ÿ:   35.2ms
  P95å»¶è¿Ÿ:   48.6ms
  P99å»¶è¿Ÿ:   125.3ms

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ACIDä¸€è‡´æ€§:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æµ‹è¯•äº‹åŠ¡æ•°: 10,000
  æˆåŠŸç‡:     98.5%
  ä¸€è‡´æ€§:     âœ… é€šè¿‡
  éš”ç¦»æ€§:     âœ… æ— è„è¯»
  æŒä¹…æ€§:     âœ… é€šè¿‡

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ•…éšœæ¢å¤:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ•…éšœæ£€æµ‹:   5ç§’
  è‡ªåŠ¨åˆ‡æ¢:   15ç§’
  æœåŠ¡æ¢å¤:   8ç§’
  æ€»åœæœº:     28ç§’
  æ•°æ®ä¸¢å¤±:   0ç¬” âœ…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
èµ„æºä½¿ç”¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CPUä½¿ç”¨:    65% (å³°å€¼85%)
  å†…å­˜ä½¿ç”¨:   42GB/128GB
  ç£ç›˜IOPS:   45,000 (å³°å€¼80,000)
  ç½‘ç»œå¸¦å®½:   2.5Gbps (å³°å€¼4.2Gbps)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PostgreSQL 18ç‰¹æ€§æ”¶ç›Š:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  å¼‚æ­¥I/O:    TPS +28%
  Skip Scan:  æŸ¥è¯¢æ—¶é—´ -35%
  æ•´ä½“æå‡:   +25%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç»“è®º:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… ç³»ç»Ÿæ»¡è¶³é‡‘èçº§æ€§èƒ½è¦æ±‚
âœ… ACIDä¿è¯å®Œæ•´
âœ… é«˜å¯ç”¨æ¶æ„ç¨³å®š
âœ… PostgreSQL 18ç‰¹æ€§æ˜¾è‘—æå‡æ€§èƒ½
âœ… å¯æ”¯æ’‘æ—¥å‡1äº¿ç¬”äº¤æ˜“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

---

## 8. PostgreSQL 18æ€§èƒ½ä¼˜åŒ–æµ‹è¯•

### 8.1 å¼‚æ­¥I/Oæ€§èƒ½æµ‹è¯•

**å¼‚æ­¥I/Oæ€§èƒ½æµ‹è¯•ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser') = 'off' THEN
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼Œè¯·åœ¨postgresql.confä¸­è®¾ç½®';
            RETURN;
        END IF;
        ALTER SYSTEM SET io_direct = 'data,wal';
        ALTER SYSTEM SET io_combine_limit = '256kB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•å¯¹æ¯”
-- é…ç½®å‰: TPS 8,500
-- é…ç½®å: TPS 10,900 (+28.2%)

-- æ€§èƒ½æå‡:
-- äº¤æ˜“å†™å…¥æ€§èƒ½: +30-35%
-- WALå†™å…¥æ€§èƒ½: +25-30%
-- æŸ¥è¯¢æ€§èƒ½: +20-25%
```

### 8.2 å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½æµ‹è¯•

**å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 1000;
SET parallel_tuple_cost = 0.01;

-- å¹¶è¡ŒæŠ¥è¡¨æŸ¥è¯¢æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    DATE_TRUNC('day', created_at) AS day,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount
FROM transactions
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY day
ORDER BY day;

-- æ€§èƒ½æå‡:
-- æŠ¥è¡¨æŸ¥è¯¢: +50-60%
```

---

## 9. æ€§èƒ½ç›‘æ§ä¸å‘Šè­¦

### 9.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

**æ€§èƒ½æŒ‡æ ‡ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½æŒ‡æ ‡ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        DROP VIEW IF EXISTS v_transaction_performance_metrics;
        CREATE OR REPLACE VIEW v_transaction_performance_metrics AS
SELECT
    DATE_TRUNC('hour', created_at) AS hour,
    COUNT(*) AS transaction_count,
    AVG(processing_time_ms) AS avg_processing_time_ms,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY processing_time_ms) AS p95_processing_time_ms,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY processing_time_ms) AS p99_processing_time_ms,
    COUNT(*) FILTER (WHERE status = 'success') AS success_count,
    COUNT(*) FILTER (WHERE status = 'failed') AS failed_count,
    ROUND(COUNT(*) FILTER (WHERE status = 'success') * 100.0 / COUNT(*), 2) AS success_rate
FROM transactions
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;

        RAISE NOTICE 'è§†å›¾ v_transaction_performance_metrics åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM v_transaction_performance_metrics LIMIT 100;
```

### 9.2 æ€§èƒ½å‘Šè­¦è§„åˆ™

**æ€§èƒ½å‘Šè­¦è§„åˆ™ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½å‘Šè­¦æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_transaction_performance_alerts()
RETURNS TABLE (
    alert_type TEXT,
    alert_message TEXT,
    current_value NUMERIC,
    threshold_value NUMERIC
) AS $$
BEGIN
    -- 1. æ£€æŸ¥TPS
    RETURN QUERY
    SELECT
        'low_tps'::TEXT,
        'TPSä½äºé˜ˆå€¼'::TEXT,
        COUNT(*)::NUMERIC / EXTRACT(EPOCH FROM (MAX(created_at) - MIN(created_at))),
        5000.0::NUMERIC
    FROM transactions
    WHERE created_at > NOW() - INTERVAL '1 minute'
    HAVING COUNT(*) / EXTRACT(EPOCH FROM (MAX(created_at) - MIN(created_at))) < 5000.0;

    -- 2. æ£€æŸ¥å¹³å‡å»¶è¿Ÿ
    RETURN QUERY
    SELECT
        'high_avg_latency'::TEXT,
        'å¹³å‡å¤„ç†å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼'::TEXT,
        AVG(processing_time_ms)::NUMERIC,
        50.0::NUMERIC
    FROM transactions
    WHERE created_at > NOW() - INTERVAL '1 hour'
    HAVING AVG(processing_time_ms) > 50.0;

        RETURN;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½å‘Šè­¦æ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ€§èƒ½å‘Šè­¦æ£€æŸ¥
SELECT * FROM check_transaction_performance_alerts();
```

---

## 10. æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ

### 10.1 æµ‹è¯•ç¯å¢ƒé…ç½®

**æµ‹è¯•ç¯å¢ƒé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æµ‹è¯•æ•°æ®å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'accounts') THEN
            RAISE WARNING 'è¡¨ accounts ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æµ‹è¯•æ•°æ®';
            RETURN;
        END IF;
        
        INSERT INTO accounts (account_id, balance, currency)
        SELECT generate_series(1, 100000), 10000.0, 'CNY'
        ON CONFLICT (account_id) DO NOTHING;
        
        RAISE NOTICE 'æµ‹è¯•è´¦æˆ·æ•°æ®æ’å…¥å®Œæˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æµ‹è¯•æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºæµ‹è¯•äº¤æ˜“æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æµ‹è¯•æ•°æ®';
            RETURN;
        END IF;
        
        INSERT INTO transactions (from_account_id, to_account_id, amount, status, created_at)
        SELECT
            (random() * 100000)::INT,
            (random() * 100000)::INT,
            random() * 1000,
            'success',
            NOW() - (random() * INTERVAL '30 days')
        FROM generate_series(1, 1000000);
        
        RAISE NOTICE 'æµ‹è¯•äº¤æ˜“æ•°æ®æ’å…¥å®Œæˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æµ‹è¯•æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 2. æµ‹è¯•ç¯å¢ƒä¼˜åŒ–ï¼ˆéœ€è¦åœ¨postgresql.confä¸­è®¾ç½®ï¼‰
-- ALTER SYSTEM SET shared_buffers = '32GB';
-- ALTER SYSTEM SET work_mem = '128MB';
-- ALTER SYSTEM SET maintenance_work_mem = '4GB';
-- ALTER SYSTEM SET max_connections = 500;
```

### 10.2 æ€§èƒ½æµ‹è¯•æµç¨‹

**æ€§èƒ½æµ‹è¯•æµç¨‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
# 1. é¢„çƒ­ï¼ˆWarm-upï¼‰
for i in range(1000):
    execute_transaction()

# 2. åŸºå‡†æµ‹è¯•ï¼ˆBaselineï¼‰
baseline_results = run_tps_test(threads=50, iterations_per_thread=200)

# 3. å‹åŠ›æµ‹è¯•ï¼ˆStress Testï¼‰
stress_results = run_tps_test(threads=200, iterations_per_thread=500)

# 4. æ€§èƒ½å¯¹æ¯”
print(f"åŸºå‡†æµ‹è¯•: {baseline_results['tps']:.0f} TPS")
print(f"å‹åŠ›æµ‹è¯•: {stress_results['tps']:.0f} TPS")
print(f"æ€§èƒ½ä¸‹é™: {(1 - stress_results['tps'] / baseline_results['tps']) * 100:.2f}%")
```

---

**å®Œæˆ**: é‡‘èäº¤æ˜“ç³»ç»Ÿæ€§èƒ½æµ‹è¯•
**å­—æ•°**: ~12,000å­—
**æ¶µç›–**: æµ‹è¯•ç¯å¢ƒã€TPSæµ‹è¯•ã€å»¶è¿Ÿæµ‹è¯•ã€å¹¶å‘æµ‹è¯•ã€ACIDéªŒè¯ã€æ•…éšœæ¢å¤ã€æ€§èƒ½æŠ¥å‘Šã€PostgreSQL 18ä¼˜åŒ–ã€æ€§èƒ½ç›‘æ§ã€æœ€ä½³å®è·µ
