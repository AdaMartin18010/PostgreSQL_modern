---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\cases\æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“

ç»“æ„ï¼šé—®é¢˜ â†’ è¯æ® â†’ å˜æ›´ â†’ æ•ˆæœ â†’ é˜²å†å‘

## æ¡ˆä¾‹1ï¼šä¼°ç®—åå·®å¯¼è‡´é”™è¯¯è¿æ¥é¡ºåº

- è¯æ®ï¼š`pg_stat_statements` TopNã€EXPLAIN æ˜¾ç¤º Seq Scan + é«˜å›è¡¨ï¼›
- å˜æ›´ï¼š`SET STATISTICS 2000`ã€æ‰©å±•ç»Ÿè®¡ï¼ˆdependenciesï¼‰ï¼Œæ–°å¢è¡¨è¾¾å¼ç´¢å¼•ï¼›
- æ•ˆæœï¼šP95 â†“ 45%ï¼ŒCPU é™ä½ 20%ï¼›
- é˜²å†å‘ï¼šå®šæœŸ ANALYZEã€æ–°å¢å­—æ®µå˜æ›´çº³å…¥ç»Ÿè®¡ç­–ç•¥ã€‚

## æ¡ˆä¾‹2ï¼šé”ç­‰å¾…é“¾å¯¼è‡´å»¶è¿Ÿå°–åˆº

- è¯æ®ï¼š`pg_locks` æœªæˆäºˆé”ã€é•¿äº‹åŠ¡æŒé”ï¼›
- å˜æ›´ï¼šæ‹†åˆ† DDLã€æ‰¹é‡å†™åºåŒ–ã€åˆç†ç´¢å¼•é¿å…çƒ­ç‚¹æ‰«æï¼›
- æ•ˆæœï¼šè¶…æ—¶ç‡ä» 2% é™è‡³ 0.1%ï¼›
- é˜²å†å‘ï¼šé”ç­‰å¾…å‘Šè­¦ã€DDL å˜æ›´çª—å£å®¡æ‰¹ã€‚

## æ¡ˆä¾‹3ï¼šæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹

- è¯æ®ï¼š`log_checkpoints`ã€WAL æš´æ¶¨ã€å»¶è¿Ÿå°–åˆºï¼›
- å˜æ›´ï¼šæå‡ `max_wal_size`ã€`checkpoint_timeout`ã€`checkpoint_completion_target`ï¼›
- æ•ˆæœï¼šP95 ç¨³å®šï¼Œç£ç›˜å†™çªåˆºé™ä½ï¼›
- é˜²å†å‘ï¼šé˜ˆå€¼å‘Šè­¦ä¸å®¹é‡è§„åˆ’ã€‚

## æ¡ˆä¾‹4ï¼šåˆ†åŒºè£å‰ªä¸ç”Ÿæ•ˆ

- è¯æ®ï¼šè®¡åˆ’æ˜¾ç¤ºæ‰«ææ‰€æœ‰åˆ†åŒºï¼›è°“è¯éåˆ†åŒºé”®è¡¨è¾¾å¼ï¼›
- å˜æ›´ï¼šæ”¹å†™è°“è¯ä½¿å¯è£å‰ªã€å¢åŠ åˆ†åŒºé”®å†—ä½™åˆ—æˆ–ç”Ÿæˆåˆ—ï¼›
- æ•ˆæœï¼šè®¡åˆ’æ—¶é—´ä¸‹é™ï¼ŒI/O æ˜¾è‘—é™ä½ï¼›
- é˜²å†å‘ï¼šåˆ†åŒºè®¾è®¡è¯„å®¡ä¸æŸ¥è¯¢è§„èŒƒã€‚

## æ¡ˆä¾‹5ï¼šç»Ÿè®¡ä¿¡æ¯ç¼ºå¤±å¯¼è‡´Bitmapå †ä½æ•ˆ

- è¯æ®ï¼šä¼°ç®—åå·®ã€Bitmap Heap Recheck è¿‡å¤šï¼›
- å˜æ›´ï¼šæå‡ `default_statistics_target`ï¼Œé’ˆå¯¹åˆ—è®¾ç½®æ›´é«˜ç»Ÿè®¡ï¼›
- æ•ˆæœï¼šå›è¡¨å‡å°‘ï¼ŒP95 ä¸‹é™ï¼›
- é˜²å†å‘ï¼šæ‰¹é‡å¯¼å…¥å ANALYZEã€å®šæœŸç»Ÿè®¡ç»´æŠ¤ã€‚

## æ¡ˆä¾‹6ï¼šRLS ç­–ç•¥è¯¯é…å½±å“è®¡åˆ’

- è¯æ®ï¼šæ¯æ¬¡è®¿é—®é™„å¸¦å¤æ‚ç­–ç•¥è¿‡æ»¤ï¼Œè®¡åˆ’å˜æ…¢ï¼›
- å˜æ›´ï¼šä¼˜åŒ–ç­–ç•¥ä¸ºå¯ç´¢å¼•è°“è¯ï¼Œå¿…è¦æ—¶ç­–ç•¥åˆ†å±‚æˆ–ç»•è¿‡åªè¯»æŠ¥è¡¨ï¼›
- æ•ˆæœï¼šTP95 æ˜æ˜¾ä¸‹é™ï¼›
- é˜²å†å‘ï¼šRLS å˜æ›´è¯„å®¡ä¸è®¡åˆ’å¯¹æ¯”ã€‚

## æ¡ˆä¾‹7ï¼šå¤–é”®ç¼ºç´¢å¼•å¯¼è‡´å†™æ”¾å¤§

- è¯æ®ï¼šæ’å…¥/æ›´æ–°å¤–é”®è¡Œæ—¶é˜»å¡ä¸å…¨è¡¨æ‰«æï¼›
- å˜æ›´ï¼šä¸ºå¤–é”®åˆ—è¡¥å……ç´¢å¼•ï¼›
- æ•ˆæœï¼šå†™å»¶è¿Ÿä¸‹é™ï¼Œé”ç­‰å¾…å‡å°‘ï¼›
- é˜²å†å‘ï¼šDDL å®¡è®¡è§„åˆ™å¼ºåˆ¶å¤–é”®å»ºç´¢å¼•ã€‚

## æ¡ˆä¾‹8ï¼šé¡ºåºé”®æ’å…¥çƒ­ç‚¹é¡µå¯¼è‡´B-Treeåˆ†è£‚

- è¯æ®ï¼šæ’å…¥çƒ­ç‚¹é›†ä¸­ï¼Œç´¢å¼•åˆ†è£‚ä¸é¡µæŠ–åŠ¨ï¼›
- å˜æ›´ï¼šä½¿ç”¨ `fillfactor`ã€åè½¬IDæˆ–å“ˆå¸Œåˆ†å¸ƒã€åˆ†åŒºï¼›
- æ•ˆæœï¼šå†™æŠ–åŠ¨ä¸‹é™ï¼›
- é˜²å†å‘ï¼šå»ºæ¨¡é˜¶æ®µè¯„å®¡è‡ªå¢/é¡ºåºé”®ç­–ç•¥ã€‚

---

## 9. æ¡ˆä¾‹è¯¦ç»†åˆ†æ

### 9.1 æ¡ˆä¾‹1è¯¦ç»†åˆ†æï¼šä¼°ç®—åå·®å¯¼è‡´é”™è¯¯è¿æ¥é¡ºåº

**é—®é¢˜æè¿°**ï¼š

æŸ¥è¯¢æ€§èƒ½å·®ï¼ŒP95å»¶è¿Ÿé«˜ï¼ŒCPUä½¿ç”¨ç‡é«˜ã€‚

**è¯Šæ–­æ­¥éª¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE o.created_at >= '2024-01-01'
  AND c.region = 'North';

-- å‘ç°é—®é¢˜ï¼š
-- - Seq Scan on ordersï¼ˆåº”è¯¥ä½¿ç”¨ç´¢å¼•ï¼‰
-- - è¿æ¥é¡ºåºä¸å½“ï¼ˆåº”è¯¥å…ˆè¿‡æ»¤ordersï¼‰
-- - ä¼°ç®—è¡Œæ•°åå·®å¤§
```

**è§£å†³æ–¹æ¡ˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æå‡ç»Ÿè®¡ä¿¡æ¯ç²¾åº¦
ALTER TABLE orders ALTER COLUMN created_at SET STATISTICS 2000;
ALTER TABLE customers ALTER COLUMN region SET STATISTICS 2000;

-- 2. åˆ›å»ºæ‰©å±•ç»Ÿè®¡ï¼ˆç›¸å…³æ€§ï¼‰
CREATE STATISTICS orders_customer_correlation (
    dependencies
) ON created_at, customer_id
FROM orders;

-- 3. åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_orders_created_at_customer ON orders (created_at, customer_id)
WHERE created_at >= '2024-01-01';

-- 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;
ANALYZE customers;

-- 5. éªŒè¯ä¼˜åŒ–æ•ˆæœ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT *
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE o.created_at >= '2024-01-01'
  AND c.region = 'North';
```

**æ•ˆæœéªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ€§èƒ½å¯¹æ¯”æŸ¥è¯¢
CREATE OR REPLACE FUNCTION compare_query_performance()
RETURNS TABLE (
    metric_name TEXT,
    before_value NUMERIC,
    after_value NUMERIC,
    improvement_percent NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'P95å»¶è¿Ÿ(ms)'::TEXT,
        1000.0::NUMERIC,  -- ä¼˜åŒ–å‰
        550.0::NUMERIC,   -- ä¼˜åŒ–åï¼ˆé™ä½45%ï¼‰
        -45.0::NUMERIC
    UNION ALL
    SELECT
        'CPUä½¿ç”¨ç‡(%)'::TEXT,
        80.0::NUMERIC,    -- ä¼˜åŒ–å‰
        64.0::NUMERIC,    -- ä¼˜åŒ–åï¼ˆé™ä½20%ï¼‰
        -20.0::NUMERIC;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½å¯¹æ¯”å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 9.2 æ¡ˆä¾‹2è¯¦ç»†åˆ†æï¼šé”ç­‰å¾…é“¾å¯¼è‡´å»¶è¿Ÿå°–åˆº

**é—®é¢˜æè¿°**ï¼š

æŸ¥è¯¢è¶…æ—¶ç‡é«˜ï¼Œå‡ºç°é”ç­‰å¾…ï¼Œå»¶è¿Ÿå°–åˆºã€‚

**è¯Šæ–­æ­¥éª¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    blocked_locks.locktype,
    blocked_locks.mode
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
  AND blocking_locks.granted;

-- 2. æŸ¥çœ‹é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    NOW() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND NOW() - query_start > INTERVAL '5 minutes'
ORDER BY duration DESC;
```

**è§£å†³æ–¹æ¡ˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. æ‹†åˆ†DDLæ“ä½œ
-- åŸæ“ä½œï¼šALTER TABLE orders ADD COLUMN col1, ADD COLUMN col2, ADD COLUMN col3;
-- æ‹†åˆ†ä¸ºï¼š
ALTER TABLE orders ADD COLUMN col1;
ALTER TABLE orders ADD COLUMN col2;
ALTER TABLE orders ADD COLUMN col3;

-- 2. æ‰¹é‡å†™åºåŒ–ï¼ˆä½¿ç”¨äº‹åŠ¡æ‰¹å¤„ç†ï¼‰
BEGIN;
INSERT INTO orders (...) VALUES (...);
INSERT INTO orders (...) VALUES (...);
INSERT INTO orders (...) VALUES (...);
COMMIT;

-- 3. åˆ›å»ºåˆç†ç´¢å¼•é¿å…çƒ­ç‚¹æ‰«æ
CREATE INDEX idx_orders_customer_created ON orders (customer_id, created_at)
WHERE status = 'active';
```

**æ•ˆæœéªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è¶…æ—¶ç‡ç›‘æ§
CREATE OR REPLACE FUNCTION monitor_timeout_rate()
RETURNS TABLE (
    time_window TIMESTAMPTZ,
    timeout_count BIGINT,
    total_queries BIGINT,
    timeout_rate NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        date_trunc('hour', NOW()) AS time_window,
        COUNT(*) FILTER (WHERE state = 'active' AND wait_event_type = 'Lock') AS timeout_count,
        COUNT(*) AS total_queries,
        ROUND(100.0 * COUNT(*) FILTER (WHERE state = 'active' AND wait_event_type = 'Lock') / COUNT(*), 2) AS timeout_rate
    FROM pg_stat_activity
    WHERE state != 'idle'
    GROUP BY date_trunc('hour', NOW());

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æ§è¶…æ—¶ç‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 10. é˜²å†å‘æœºåˆ¶

### 10.1 è‡ªåŠ¨åŒ–ç›‘æ§

**è‡ªåŠ¨åŒ–ç›‘æ§é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è¡¨
CREATE TABLE IF NOT EXISTS performance_monitoring (
    id SERIAL PRIMARY KEY,
    check_time TIMESTAMPTZ DEFAULT NOW(),
    check_type TEXT,  -- 'slow_query', 'lock_wait', 'statistics'
    check_result JSONB,
    alert_level TEXT  -- 'INFO', 'WARNING', 'CRITICAL'
);

-- æ…¢æŸ¥è¯¢ç›‘æ§å‡½æ•°
CREATE OR REPLACE FUNCTION monitor_slow_queries()
RETURNS TABLE (
    alert_count BIGINT,
    alert_level TEXT
) AS $$
DECLARE
    slow_query_count BIGINT;
BEGIN
    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements
    WHERE mean_exec_time > 1000  -- 1ç§’ä»¥ä¸Š
      AND calls > 10;

    IF slow_query_count > 5 THEN
        INSERT INTO performance_monitoring (check_type, check_result, alert_level)
        VALUES (
            'slow_query',
            json_build_object('count', slow_query_count),
            'CRITICAL'
        );

        RETURN QUERY SELECT slow_query_count, 'CRITICAL'::TEXT;
    ELSIF slow_query_count > 0 THEN
        RETURN QUERY SELECT slow_query_count, 'WARNING'::TEXT;
    ELSE
        RETURN QUERY SELECT 0::BIGINT, 'INFO'::TEXT;
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æ§æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ç›‘æ§ï¼ˆä½¿ç”¨pg_cronï¼‰
SELECT cron.schedule(
    'monitor-slow-queries',
    '*/5 * * * *',  -- æ¯5åˆ†é’Ÿ
    'SELECT * FROM monitor_slow_queries();'
);
```

### 10.2 å˜æ›´å®¡æ‰¹æµç¨‹

**å˜æ›´å®¡æ‰¹æµç¨‹è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- åˆ›å»ºå˜æ›´å®¡æ‰¹è¡¨
CREATE TABLE IF NOT EXISTS change_approvals (
    id SERIAL PRIMARY KEY,
    change_type TEXT,  -- 'parameter', 'index', 'ddl', 'sql'
    change_description TEXT,
    old_value TEXT,
    new_value TEXT,
    expected_impact TEXT,
    validation_window TEXT,
    rollback_conditions TEXT,
    owner TEXT,
    reviewer TEXT,
    status TEXT DEFAULT 'pending',  -- 'pending', 'approved', 'rejected', 'completed'
    created_at TIMESTAMPTZ DEFAULT NOW(),
    approved_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ
);

-- å˜æ›´å®¡æ‰¹å‡½æ•°
CREATE OR REPLACE FUNCTION submit_change_request(
    p_change_type TEXT,
    p_change_description TEXT,
    p_old_value TEXT,
    p_new_value TEXT,
    p_expected_impact TEXT,
    p_owner TEXT
)
RETURNS TABLE (
    request_id INT,
    status TEXT
) AS $$
DECLARE
    new_request_id INT;
BEGIN
    INSERT INTO change_approvals (
        change_type,
        change_description,
        old_value,
        new_value,
        expected_impact,
        owner
    )
    VALUES (
        p_change_type,
        p_change_description,
        p_old_value,
        p_new_value,
        p_expected_impact,
        p_owner
    )
    RETURNING id INTO new_request_id;

    RETURN QUERY SELECT new_request_id, 'pending'::TEXT;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æäº¤å˜æ›´è¯·æ±‚å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹/](./../20-æ•…éšœè¯Šæ–­æ¡ˆä¾‹/README.md) - æ•…éšœè¯Šæ–­æ¡ˆä¾‹ä¸»é¢˜
- [12-ç›‘æ§ä¸è¯Šæ–­/](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç›‘æ§ä¸è¯Šæ–­ä¸»é¢˜
- [19-å®æˆ˜æ¡ˆä¾‹/README.md](./README.md) - å®æˆ˜æ¡ˆä¾‹ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
