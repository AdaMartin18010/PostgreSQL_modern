---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\cases\é‡‘èè´¦åŠ¡ä¸€è‡´æ€§.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹ï¼šé‡‘èè´¦åŠ¡ä¸€è‡´æ€§ï¼ˆå ä½ï¼‰

## æ¶æ„

- åˆ†åŒºè´¦åŠ¡è¡¨ã€å®¡è®¡è½¨è¿¹ã€é€»è¾‘å¤åˆ¶åˆ°å®¡è®¡åº“

## å…³é”®ç‚¹

- äº‹åŠ¡è¾¹ç•Œã€å¹‚ç­‰è¡¥å¿ã€å¯¹è´¦ä¸å›æ”¾

## éªŒè¯

- ç«¯åˆ°ç«¯å¯¹è´¦ä¸€è‡´ã€æ¢å¤æ¼”ç»ƒé€šè¿‡ï¼ˆRTO/RPO è®°å½•ï¼‰

## æœ€å°å¯å¤ç°ï¼ˆå ä½ï¼‰

```sql
CREATE TABLE accounts(id bigint primary key, balance numeric);
CREATE TABLE ledger(id bigserial primary key, account_id bigint, delta numeric, ts timestamptz);

-- äº‹åŠ¡è¾¹ç•Œä¿è¯ä¸€è‡´æ€§
BEGIN;
UPDATE accounts SET balance = balance + :delta WHERE id = :account_id;
INSERT INTO ledger(account_id, delta, ts) VALUES(:account_id, :delta, now());
COMMIT;

-- å¯¹è´¦æ£€æŸ¥ï¼ˆç¤ºæ„ï¼‰ï¼š
-- SELECT a.id, a.balance, SUM(l.delta) FROM accounts a JOIN ledger l ON l.account_id=a.id GROUP BY a.id HAVING a.balance <> SUM(l.delta);
```
