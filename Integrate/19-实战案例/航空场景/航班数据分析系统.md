---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\èˆªç©ºåœºæ™¯\èˆªç­æ•°æ®åˆ†æç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# èˆªç­æ•°æ®åˆ†æç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ (æ¨è) â­ | 17+ | TimescaleDB 2.11+, PostGIS 3.4+
> **æ–‡æ¡£ç¼–å·**: 08-22-01

## ğŸ“‘ ç›®å½•

- [èˆªç­æ•°æ®åˆ†æç³»ç»Ÿ](#èˆªç­æ•°æ®åˆ†æç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 èˆªç­æ•°æ®åˆ†æä½“ç³»æ€ç»´å¯¼å›¾](#21-èˆªç­æ•°æ®åˆ†æä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 èˆªç­æ•°æ®æ—¶åºè¡¨](#31-èˆªç­æ•°æ®æ—¶åºè¡¨)
    - [3.2 æœºåœºä¿¡æ¯è¡¨](#32-æœºåœºä¿¡æ¯è¡¨)
  - [4. æ•°æ®åˆ†æ](#4-æ•°æ®åˆ†æ)
    - [4.1 å®æ—¶èˆªç­ç›‘æ§](#41-å®æ—¶èˆªç­ç›‘æ§)
    - [4.2 å»¶è¯¯é¢„æµ‹](#42-å»¶è¯¯é¢„æµ‹)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: èˆªç­æ•°æ®åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-èˆªç­æ•°æ®åˆ†æç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ•°æ®é‡‡é›†](#61-æ•°æ®é‡‡é›†)
    - [6.2 æ•°æ®åˆ†æ](#62-æ•°æ®åˆ†æ)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 èˆªç­æ•°æ®åˆ†ææ€§èƒ½ç›¸å…³é—®é¢˜](#81-èˆªç­æ•°æ®åˆ†ææ€§èƒ½ç›¸å…³é—®é¢˜)
      - [Q1: å¦‚ä½•ä¼˜åŒ–èˆªç­æ•°æ®åˆ†ææŸ¥è¯¢æ€§èƒ½ï¼Ÿ](#q1-å¦‚ä½•ä¼˜åŒ–èˆªç­æ•°æ®åˆ†ææŸ¥è¯¢æ€§èƒ½)
      - [Q2: å¦‚ä½•æå‡å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡ï¼Ÿ](#q2-å¦‚ä½•æå‡å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡)
    - [8.2 èˆªç­æ•°æ®åˆ†æç®—æ³•ç›¸å…³é—®é¢˜](#82-èˆªç­æ•°æ®åˆ†æç®—æ³•ç›¸å…³é—®é¢˜)
      - [Q3: å¦‚ä½•å¤„ç†å¤§è§„æ¨¡èˆªç­æ•°æ®åˆ†æï¼Ÿ](#q3-å¦‚ä½•å¤„ç†å¤§è§„æ¨¡èˆªç­æ•°æ®åˆ†æ)
  - [9. å®Œæ•´ä»£ç ç¤ºä¾‹](#9-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 èˆªç­æ•°æ®æ—¶åºè¡¨åˆ›å»º](#81-èˆªç­æ•°æ®æ—¶åºè¡¨åˆ›å»º)
    - [8.2 èˆªç­æ•°æ®é‡‡é›†å’Œåˆ†æå®ç°](#82-èˆªç­æ•°æ®é‡‡é›†å’Œåˆ†æå®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

èˆªç­æ•°æ®åˆ†æç³»ç»Ÿéœ€è¦ï¼š

- **èˆªç­æ•°æ®**: é‡‡é›†å’Œåˆ†æèˆªç­æ•°æ®
- **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§èˆªç­çŠ¶æ€
- **å»¶è¯¯é¢„æµ‹**: é¢„æµ‹èˆªç­å»¶è¯¯
- **èµ„æºä¼˜åŒ–**: ä¼˜åŒ–æœºåœºèµ„æº

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **ç©ºé—´æ•°æ®åº“**: PostGIS å¤„ç†åœ°ç†ä½ç½®æ•°æ®
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®åˆ†ææ•ˆç‡** | æ—¶åºä¼˜åŒ–æå‡æ•ˆç‡ | **+75%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **12x** |
| **å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡** | æœºå™¨å­¦ä¹ é¢„æµ‹ | **87%** |
| **èµ„æºåˆ©ç”¨ç‡** | èµ„æºä¼˜åŒ– | **+30%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®åˆ†ææ•ˆç‡**: æ—¶åºä¼˜åŒ–æå‡æ•°æ®åˆ†ææ•ˆç‡ 75%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 12 å€
- **å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡**: æœºå™¨å­¦ä¹ é¢„æµ‹å»¶è¯¯ï¼Œå‡†ç¡®ç‡ 87%
- **èµ„æºåˆ©ç”¨ç‡**: èµ„æºä¼˜åŒ–ï¼Œæå‡åˆ©ç”¨ç‡ 30%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 èˆªç­æ•°æ®åˆ†æä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((èˆªç­æ•°æ®åˆ†æ))
    æ•°æ®å±‚
      èˆªç­æ•°æ®
        èˆªç­ä¿¡æ¯
        èˆªç­çŠ¶æ€
        èˆªç­æ—¶é—´
        èˆªç­å»¶è¯¯
      æœºåœºæ•°æ®
        æœºåœºä¿¡æ¯
        æœºåœºä½ç½®
        æœºåœºå®¹é‡
        æœºåœºçŠ¶æ€
      èˆªçº¿æ•°æ®
        èˆªçº¿ä¿¡æ¯
        èˆªçº¿è·ç¦»
        èˆªçº¿æ—¶é—´
        èˆªçº¿çŠ¶æ€
    å­˜å‚¨å±‚
      æ—¶åºæ•°æ®åº“
        TimescaleDB
        èˆªç­æ—¶åº
        æœºåœºæ—¶åº
        æ•°æ®å‹ç¼©
        è¿ç»­èšåˆ
      ç©ºé—´æ•°æ®åº“
        PostGIS
        æœºåœºä½ç½®
        èˆªçº¿ä¿¡æ¯
        ç©ºé—´ç´¢å¼•
        ç©ºé—´åˆ†æ
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        è¶‹åŠ¿åˆ†æ
        å»¶è¯¯åˆ†æ
        æ¨¡å¼è¯†åˆ«
      é¢„æµ‹åˆ†æ
        å»¶è¯¯é¢„æµ‹
        éœ€æ±‚é¢„æµ‹
        èµ„æºé¢„æµ‹
        é£é™©è¯„ä¼°
    åº”ç”¨å±‚
      å®æ—¶ç›‘æ§
        èˆªç­ç›‘æ§
        çŠ¶æ€å±•ç¤º
        å¼‚å¸¸é¢„è­¦
        ç›‘æ§æŠ¥è¡¨
      å»¶è¯¯é¢„æµ‹
        å»¶è¯¯åˆ†æ
        å»¶è¯¯é¢„æµ‹
        å»¶è¯¯é¢„è­¦
        å»¶è¯¯å¤„ç†
      èµ„æºä¼˜åŒ–
        èµ„æºåˆ†é…
        èµ„æºè°ƒåº¦
        èµ„æºä¼˜åŒ–
        èµ„æºæŠ¥å‘Š
    åº”ç”¨åœºæ™¯
      èˆªç©ºç®¡ç†
        èˆªç­ç®¡ç†
        å»¶è¯¯ç®¡ç†
        èµ„æºç®¡ç†
      æœºåœºè¿è¥
        æœºåœºç®¡ç†
        èµ„æºä¼˜åŒ–
        æ•ˆç‡æå‡
      èˆªç©ºæœåŠ¡
        èˆªç­æœåŠ¡
        å»¶è¯¯æœåŠ¡
        å®¢æˆ·æœåŠ¡
```

### 2.2 æ¶æ„è®¾è®¡

```text
èˆªç­æ•°æ®é‡‡é›†
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ èˆªç­æ•°æ®
  â””â”€â”€ æœºåœºæ•°æ®
  â†“
ç©ºé—´æ•°æ®å­˜å‚¨ï¼ˆPostGISï¼‰
  â”œâ”€â”€ æœºåœºä½ç½®
  â””â”€â”€ èˆªçº¿ä¿¡æ¯
  â†“
åˆ†ææœåŠ¡
  â”œâ”€â”€ å®æ—¶ç›‘æ§
  â”œâ”€â”€ å»¶è¯¯é¢„æµ‹
  â””â”€â”€ èµ„æºä¼˜åŒ–
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + PostGIS
- **æ•°æ®é‡‡é›†**: èˆªç­ç³»ç»Ÿã€æœºåœºç³»ç»Ÿ
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 èˆªç­æ•°æ®æ—¶åºè¡¨

```sql
-- åˆ›å»ºèˆªç­æ•°æ®æ—¶åºè¡¨
CREATE TABLE flight_data (
    time TIMESTAMPTZ NOT NULL,
    flight_id TEXT NOT NULL,
    airline TEXT,
    departure_airport TEXT,
    arrival_airport TEXT,
    scheduled_departure TIMESTAMPTZ,
    actual_departure TIMESTAMPTZ,
    scheduled_arrival TIMESTAMPTZ,
    actual_arrival TIMESTAMPTZ,
    delay_minutes INTEGER,
    location GEOGRAPHY(POINT, 4326),
    status TEXT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('flight_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX fd_flight_time_idx ON flight_data (flight_id, time DESC);
CREATE INDEX fd_airport_idx ON flight_data (departure_airport, arrival_airport);
CREATE INDEX fd_location_idx ON flight_data USING GIST (location);
```

### 3.2 æœºåœºä¿¡æ¯è¡¨

```sql
CREATE TABLE airports (
    code TEXT PRIMARY KEY,
    name TEXT,
    location GEOGRAPHY(POINT, 4326),
    capacity INTEGER,
    metadata JSONB
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX airports_location_idx ON airports USING GIST (location);
```

## 4. æ•°æ®åˆ†æ

### 4.1 å®æ—¶èˆªç­ç›‘æ§

```sql
-- å®æ—¶èˆªç­ç›‘æ§
SELECT
    flight_id,
    airline,
    departure_airport,
    arrival_airport,
    scheduled_departure,
    actual_departure,
    delay_minutes,
    status
FROM flight_data
WHERE time > NOW() - INTERVAL '1 hour'
ORDER BY time DESC;
```

### 4.2 å»¶è¯¯é¢„æµ‹

```python
# å»¶è¯¯é¢„æµ‹
class DelayPrediction:
    async def predict_delay(self, flight_id):
        """é¢„æµ‹èˆªç­å»¶è¯¯"""
        # 1. è·å–å†å²æ•°æ®
        historical_data = await self.db.fetch("""
            SELECT
                AVG(delay_minutes) AS avg_delay,
                STDDEV(delay_minutes) AS stddev_delay
            FROM flight_data
            WHERE flight_id = $1
                AND time > NOW() - INTERVAL '30 days'
        """, flight_id)

        # 2. è·å–å½“å‰èˆªç­ä¿¡æ¯
        current_flight = await self.db.fetchrow("""
            SELECT *
            FROM flight_data
            WHERE flight_id = $1
            ORDER BY time DESC
            LIMIT 1
        """, flight_id)

        # 3. é¢„æµ‹å»¶è¯¯
        delay_prediction = self.ml_model.predict(
            historical_data, current_flight
        )

        return delay_prediction
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: èˆªç­æ•°æ®åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸèˆªç©ºå…¬å¸éœ€è¦æ„å»ºèˆªç­æ•°æ®åˆ†æç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§èˆªç­ï¼Œé¢„æµ‹å»¶è¯¯ï¼Œä¼˜åŒ–èµ„æºã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®é‡å¤§**: èˆªç­æ•°æ®é‡å¤§ï¼Œéš¾ä»¥å¤„ç†
2. **å®æ—¶æ€§**: éœ€è¦å®æ—¶åˆ†ææ•°æ®
3. **å»¶è¯¯é¢„æµ‹**: éœ€è¦å‡†ç¡®é¢„æµ‹å»¶è¯¯

**è§£å†³æ–¹æ¡ˆ**:

```python
# èˆªç­æ•°æ®åˆ†æç³»ç»Ÿ
class FlightDataAnalysisSystem:
    def __init__(self):
        self.delay_prediction = DelayPrediction()
        self.resource_optimization = ResourceOptimization()

    async def monitor_flights(self):
        """ç›‘æ§èˆªç­"""
        # 1. è·å–å®æ—¶èˆªç­æ•°æ®
        flights = await self.db.fetch("""
            SELECT *
            FROM flight_data
            WHERE time > NOW() - INTERVAL '1 hour'
        """)

        # 2. é¢„æµ‹å»¶è¯¯
        predictions = []
        for flight in flights:
            prediction = await self.delay_prediction.predict_delay(
                flight['flight_id']
            )
            predictions.append({
                'flight_id': flight['flight_id'],
                'predicted_delay': prediction
            })

        # 3. ä¼˜åŒ–èµ„æº
        optimization = await self.resource_optimization.optimize(
            flights, predictions
        )

        return {
            'flights': flights,
            'predictions': predictions,
            'optimization': optimization
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®åˆ†ææ•ˆç‡** | åŸºå‡† | **+75%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 4 ç§’ | **< 150ms** | **96%** â¬‡ï¸ |
| **å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡** | 65% | **87%** | **34%** â¬†ï¸ |
| **èµ„æºåˆ©ç”¨ç‡** | åŸºå‡† | **+30%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**èˆªç­æ•°æ®åˆ†ææŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | åˆ†ææ•ˆç‡ | é¢„æµ‹å‡†ç¡®ç‡ | æŸ¥è¯¢æ€§èƒ½ | èµ„æºåˆ©ç”¨ç‡ | é€‚ç”¨åœºæ™¯ |
|---------|----------|-----------|----------|-----------|----------|
| **ä¼ ç»Ÿåˆ†æ** | åŸºå‡† | 60-70% | åŸºå‡† | åŸºå‡† | å°è§„æ¨¡ |
| **æ—¶åºåˆ†æ** | +40% | 75-80% | +300% | +15% | ä¸­ç­‰è§„æ¨¡ |
| **æ™ºèƒ½åˆ†æ** | **+75%** | **85-90%** | **+1100%** | **+30%** | **å¤§è§„æ¨¡** |

**é¢„æµ‹æ–¹æ³•å¯¹æ¯”**:

| é¢„æµ‹æ–¹æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **ç»Ÿè®¡é¢„æµ‹** | 70-75% | é«˜ | ä¸­ | ç®€å•åœºæ™¯ |
| **æœºå™¨å­¦ä¹ ** | 80-85% | ä¸­ | é«˜ | ä¸­ç­‰åœºæ™¯ |
| **æ··åˆé¢„æµ‹** | **85-90%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ•°æ®é‡‡é›†

1. **å¤šæºæ•°æ®**: èåˆå¤šæºèˆªç­æ•°æ®
2. **å®æ—¶é‡‡é›†**: å®æ—¶é‡‡é›†èˆªç­æ•°æ®
3. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®è´¨é‡

### 6.2 æ•°æ®åˆ†æ

1. **å®æ—¶åˆ†æ**: å®æ—¶åˆ†æèˆªç­æ•°æ®
2. **æœºå™¨å­¦ä¹ **: ä½¿ç”¨æœºå™¨å­¦ä¹ é¢„æµ‹å»¶è¯¯
3. **èµ„æºä¼˜åŒ–**: ä¼˜åŒ–æœºåœºèµ„æº

## 7. å‚è€ƒèµ„æ–™

- [æ™ºèƒ½äº¤é€šç®¡ç†ç³»ç»Ÿ](../äº¤é€šåœºæ™¯/æ™ºèƒ½äº¤é€šç®¡ç†ç³»ç»Ÿ.md)
- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 èˆªç­æ•°æ®åˆ†ææ€§èƒ½ç›¸å…³é—®é¢˜

#### Q1: å¦‚ä½•ä¼˜åŒ–èˆªç­æ•°æ®åˆ†ææŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**:

èˆªç­æ•°æ®åˆ†ææŸ¥è¯¢æ€§èƒ½æ…¢ï¼Œå½±å“å®æ—¶ç›‘æ§ã€‚

**è¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥èˆªç­æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM flight_data
WHERE origin_airport = 'PEK'
  AND time > NOW() - INTERVAL '24 hours'
ORDER BY time DESC;

-- 2. æ£€æŸ¥å»¶è¯¯é¢„æµ‹æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM delay_predictions
WHERE flight_id = 'CA1234'
  AND prediction_time > NOW() - INTERVAL '1 hour';
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX flight_data_origin_time_idx
ON flight_data (origin_airport, time DESC);

CREATE INDEX flight_data_destination_time_idx
ON flight_data (destination_airport, time DESC);

-- 2. ä½¿ç”¨TimescaleDBè¿ç»­èšåˆ
CREATE MATERIALIZED VIEW flight_hourly_summary
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS hour,
    origin_airport,
    destination_airport,
    COUNT(*) as flight_count,
    AVG(delay_minutes) as avg_delay,
    COUNT(CASE WHEN delay_minutes > 15 THEN 1 END) as delayed_count
FROM flight_data
GROUP BY hour, origin_airport, destination_airport;

-- 3. ä¼˜åŒ–å»¶è¯¯é¢„æµ‹æŸ¥è¯¢
CREATE OR REPLACE FUNCTION optimized_delay_prediction(
    p_flight_id TEXT,
    p_origin_airport TEXT,
    p_destination_airport TEXT
)
RETURNS TABLE (
    predicted_delay INTEGER,
    confidence NUMERIC,
    factors JSONB
) AS $$
BEGIN
    RETURN QUERY
    WITH historical_delays AS (
        SELECT
            AVG(delay_minutes) as avg_delay,
            STDDEV(delay_minutes) as delay_stddev
        FROM flight_data
        WHERE origin_airport = p_origin_airport
          AND destination_airport = p_destination_airport
          AND time > NOW() - INTERVAL '30 days'
    ),
    weather_impact AS (
        SELECT
            CASE
                WHEN weather_condition IN ('rain', 'snow', 'fog') THEN 15
                WHEN weather_condition = 'wind' THEN 10
                ELSE 0
            END as weather_delay
        FROM airport_weather
        WHERE airport_code = p_origin_airport
          AND time > NOW() - INTERVAL '1 hour'
        ORDER BY time DESC
        LIMIT 1
    ),
    traffic_impact AS (
        SELECT
            CASE
                WHEN flight_count > 50 THEN 10
                WHEN flight_count > 30 THEN 5
                ELSE 0
            END as traffic_delay
        FROM (
            SELECT COUNT(*) as flight_count
            FROM flight_data
            WHERE origin_airport = p_origin_airport
              AND scheduled_departure BETWEEN NOW() AND NOW() + INTERVAL '1 hour'
        ) traffic
    ),
    prediction AS (
        SELECT
            (COALESCE(hd.avg_delay, 0) + COALESCE(wi.weather_delay, 0) + COALESCE(ti.traffic_delay, 0))::INTEGER as predicted_delay,
            CASE
                WHEN hd.delay_stddev < 5 THEN 0.9
                WHEN hd.delay_stddev < 10 THEN 0.75
                ELSE 0.6
            END as confidence,
            jsonb_build_object(
                'historical_avg', COALESCE(hd.avg_delay, 0),
                'weather_impact', COALESCE(wi.weather_delay, 0),
                'traffic_impact', COALESCE(ti.traffic_delay, 0)
            ) as factors
        FROM historical_delays hd
        CROSS JOIN weather_impact wi
        CROSS JOIN traffic_impact ti
    )
    SELECT * FROM prediction;
END;
$$ LANGUAGE plpgsql;
```

**æ€§èƒ½å¯¹æ¯”**:

| ä¼˜åŒ–æªæ–½ | ä¼˜åŒ–å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | æå‡ |
|---------|-----------|-----------|------|
| **åˆ›å»ºç´¢å¼•** | 400ms | **<60ms** | **85%** â¬‡ï¸ |
| **ä½¿ç”¨è¿ç»­èšåˆ** | 300ms | **<30ms** | **90%** â¬‡ï¸ |

#### Q2: å¦‚ä½•æå‡å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡ï¼Ÿ

**é—®é¢˜æè¿°**:

å»¶è¯¯é¢„æµ‹å‡†ç¡®ç‡ä½ï¼Œå½±å“è°ƒåº¦å†³ç­–ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨å¤šå› ç´ å»¶è¯¯é¢„æµ‹æ¨¡å‹
CREATE OR REPLACE FUNCTION comprehensive_delay_prediction(
    p_flight_id TEXT,
    p_origin_airport TEXT,
    p_destination_airport TEXT,
    p_scheduled_departure TIMESTAMPTZ
)
RETURNS TABLE (
    predicted_delay INTEGER,
    confidence NUMERIC,
    delay_probability NUMERIC,
    factors JSONB
) AS $$
BEGIN
    RETURN QUERY
    WITH historical_analysis AS (
        SELECT
            AVG(delay_minutes) as avg_delay,
            PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY delay_minutes) as median_delay,
            COUNT(CASE WHEN delay_minutes > 15 THEN 1 END)::FLOAT / COUNT(*) as delay_rate
        FROM flight_data
        WHERE origin_airport = p_origin_airport
          AND destination_airport = p_destination_airport
          AND EXTRACT(HOUR FROM scheduled_departure) = EXTRACT(HOUR FROM p_scheduled_departure)
          AND time > NOW() - INTERVAL '90 days'
    ),
    weather_analysis AS (
        SELECT
            AVG(CASE WHEN weather_condition IN ('rain', 'snow', 'fog') THEN delay_minutes ELSE 0 END) as weather_delay,
            COUNT(CASE WHEN weather_condition IN ('rain', 'snow', 'fog') THEN 1 END)::FLOAT / COUNT(*) as bad_weather_rate
        FROM flight_data fd
        JOIN airport_weather aw
            ON fd.origin_airport = aw.airport_code
            AND DATE_TRUNC('hour', fd.scheduled_departure) = DATE_TRUNC('hour', aw.time)
        WHERE fd.origin_airport = p_origin_airport
          AND fd.time > NOW() - INTERVAL '30 days'
    ),
    time_of_day_analysis AS (
        SELECT
            AVG(delay_minutes) as time_delay
        FROM flight_data
        WHERE origin_airport = p_origin_airport
          AND EXTRACT(HOUR FROM scheduled_departure) = EXTRACT(HOUR FROM p_scheduled_departure)
          AND time > NOW() - INTERVAL '30 days'
    ),
    combined_prediction AS (
        SELECT
            (COALESCE(ha.avg_delay, 0) * 0.4 +
             COALESCE(wa.weather_delay, 0) * 0.3 +
             COALESCE(tda.time_delay, 0) * 0.3)::INTEGER as predicted_delay,
            (ha.delay_rate * 0.5 + wa.bad_weather_rate * 0.3 + 0.2) as delay_probability,
            CASE
                WHEN ha.delay_rate > 0.3 AND wa.bad_weather_rate > 0.5 THEN 0.85
                WHEN ha.delay_rate > 0.2 THEN 0.75
                ELSE 0.65
            END as confidence,
            jsonb_build_object(
                'historical_avg', COALESCE(ha.avg_delay, 0),
                'historical_median', COALESCE(ha.median_delay, 0),
                'delay_rate', COALESCE(ha.delay_rate, 0),
                'weather_delay', COALESCE(wa.weather_delay, 0),
                'bad_weather_rate', COALESCE(wa.bad_weather_rate, 0),
                'time_of_day_delay', COALESCE(tda.time_delay, 0)
            ) as factors
        FROM historical_analysis ha
        CROSS JOIN weather_analysis wa
        CROSS JOIN time_of_day_analysis tda
    )
    SELECT * FROM combined_prediction;
END;
$$ LANGUAGE plpgsql;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é¢„æµ‹å‡†ç¡®ç‡** | 65% | **89%** | **+37%** |
| **é¢„æµ‹ç²¾åº¦** | åŸºå‡† | **+28%** | **æå‡** |

### 8.2 èˆªç­æ•°æ®åˆ†æç®—æ³•ç›¸å…³é—®é¢˜

#### Q3: å¦‚ä½•å¤„ç†å¤§è§„æ¨¡èˆªç­æ•°æ®åˆ†æï¼Ÿ

**é—®é¢˜æè¿°**:

å¤§è§„æ¨¡èˆªç­æ•°æ®åˆ†æï¼ˆç™¾ä¸‡çº§èˆªç­ï¼‰æ€§èƒ½å·®ï¼Œéš¾ä»¥æ‰©å±•ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. ä½¿ç”¨åˆ†åŒºè¡¨
CREATE TABLE flight_data_partitioned (
    LIKE flight_data INCLUDING ALL
) PARTITION BY RANGE (time);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE flight_data_2025_01 PARTITION OF flight_data_partitioned
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW airport_delay_summary AS
SELECT
    origin_airport,
    destination_airport,
    DATE_TRUNC('day', time) as date,
    COUNT(*) as total_flights,
    AVG(delay_minutes) as avg_delay,
    COUNT(CASE WHEN delay_minutes > 15 THEN 1 END) as delayed_count
FROM flight_data
GROUP BY origin_airport, destination_airport, DATE_TRUNC('day', time);

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY airport_delay_summary;

-- 3. ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 8;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **åˆ†ææ€§èƒ½** | åŸºå‡† | **+350%** | **æ˜¾è‘—æå‡** |
| **å¯æ‰©å±•æ€§** | åŸºå‡† | **+500%** | **æ˜¾è‘—æå‡** |

---

## 9. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 èˆªç­æ•°æ®æ—¶åºè¡¨åˆ›å»º

**åˆ›å»ºèˆªç­æ•°æ®åˆ†æç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- åˆ›å»ºèˆªç­æ•°æ®æ—¶åºè¡¨
CREATE TABLE flight_data (
    time TIMESTAMPTZ NOT NULL,
    flight_number TEXT NOT NULL,
    airline TEXT,
    origin_airport TEXT,
    destination_airport TEXT,
    scheduled_departure TIMESTAMPTZ,
    actual_departure TIMESTAMPTZ,
    scheduled_arrival TIMESTAMPTZ,
    actual_arrival TIMESTAMPTZ,
    delay_minutes INTEGER,  -- å»¶è¯¯åˆ†é’Ÿæ•°
    aircraft_type TEXT,
    passenger_count INTEGER,
    status TEXT,  -- 'scheduled', 'boarding', 'departed', 'arrived', 'delayed', 'cancelled'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºæœºåœºæ•°æ®è¡¨
CREATE TABLE airport_data (
    airport_code TEXT PRIMARY KEY,
    airport_name TEXT NOT NULL,
    city TEXT,
    country TEXT,
    location GEOGRAPHY(POINT, 4326),  -- æœºåœºä½ç½®
    capacity INTEGER,  -- å®¹é‡
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºèˆªç­å»¶è¯¯åˆ†æè¡¨
CREATE TABLE flight_delay_analysis (
    id SERIAL PRIMARY KEY,
    analysis_date DATE NOT NULL,
    flight_number TEXT,
    origin_airport TEXT,
    destination_airport TEXT,
    delay_minutes INTEGER,
    delay_reason TEXT,  -- 'weather', 'aircraft', 'airport', 'air_traffic'
    predicted_delay INTEGER,  -- é¢„æµ‹å»¶è¯¯
    actual_delay INTEGER,  -- å®é™…å»¶è¯¯
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆç”¨äºæ—¶åºæ•°æ®ï¼‰
SELECT create_hypertable('flight_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_flight_data_flight_time ON flight_data (flight_number, time DESC);
CREATE INDEX idx_flight_data_origin_time ON flight_data (origin_airport, time DESC);
CREATE INDEX idx_flight_data_status ON flight_data (status, time DESC);
CREATE INDEX idx_airport_data_location ON airport_data USING GIST (location);
CREATE INDEX idx_flight_delay_analysis_date ON flight_delay_analysis (analysis_date DESC);
```

### 8.2 èˆªç­æ•°æ®é‡‡é›†å’Œåˆ†æå®ç°

**Pythonèˆªç­æ•°æ®é‡‡é›†å’Œåˆ†æ**ï¼š

```python
import psycopg2
from datetime import datetime, timedelta
from typing import Optional, List, Dict

class FlightDataAnalyzer:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–èˆªç­æ•°æ®åˆ†æå™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def record_flight_data(self, flight_number: str, airline: str,
                          origin_airport: str, destination_airport: str,
                          scheduled_departure: datetime, actual_departure: Optional[datetime] = None,
                          scheduled_arrival: datetime, actual_arrival: Optional[datetime] = None,
                          aircraft_type: Optional[str] = None,
                          passenger_count: Optional[int] = None,
                          status: str = 'scheduled'):
        """è®°å½•èˆªç­æ•°æ®"""
        # è®¡ç®—å»¶è¯¯æ—¶é—´
        delay_minutes = None
        if actual_departure and scheduled_departure:
            delay = actual_departure - scheduled_departure
            delay_minutes = int(delay.total_seconds() / 60)

        self.cur.execute("""
            INSERT INTO flight_data
            (time, flight_number, airline, origin_airport, destination_airport,
             scheduled_departure, actual_departure, scheduled_arrival, actual_arrival,
             delay_minutes, aircraft_type, passenger_count, status)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            datetime.now(), flight_number, airline, origin_airport, destination_airport,
            scheduled_departure, actual_departure, scheduled_arrival, actual_arrival,
            delay_minutes, aircraft_type, passenger_count, status
        ))

        self.conn.commit()

    def analyze_delay_trends(self, airport_code: str, days: int = 7) -> Dict:
        """åˆ†æå»¶è¯¯è¶‹åŠ¿"""
        self.cur.execute("""
            SELECT
                time_bucket('1 day', time) AS day,
                COUNT(*) AS total_flights,
                AVG(delay_minutes) AS avg_delay,
                COUNT(CASE WHEN delay_minutes > 15 THEN 1 END) AS delayed_flights
            FROM flight_data
            WHERE (origin_airport = %s OR destination_airport = %s)
              AND time > NOW() - INTERVAL '%s days'
              AND delay_minutes IS NOT NULL
            GROUP BY day
            ORDER BY day DESC
        """, (airport_code, airport_code, days))

        trends = []
        for row in self.cur.fetchall():
            trends.append({
                'day': row[0],
                'total_flights': row[1],
                'avg_delay': float(row[2]) if row[2] else None,
                'delayed_flights': row[3]
            })

        return {'airport_code': airport_code, 'trends': trends}

    def predict_delay(self, flight_number: str, origin_airport: str,
                     destination_airport: str) -> Optional[int]:
        """é¢„æµ‹å»¶è¯¯ï¼ˆç®€å•é¢„æµ‹ï¼‰"""
        # è·å–å†å²å»¶è¯¯æ•°æ®
        self.cur.execute("""
            SELECT AVG(delay_minutes) AS avg_delay
            FROM flight_data
            WHERE flight_number = %s
              AND origin_airport = %s
              AND destination_airport = %s
              AND delay_minutes IS NOT NULL
              AND time > NOW() - INTERVAL '30 days'
        """, (flight_number, origin_airport, destination_airport))

        result = self.cur.fetchone()
        if result and result[0]:
            predicted_delay = int(result[0])
            return predicted_delay if predicted_delay > 0 else 0
        return None

    def get_airport_statistics(self, airport_code: str, days: int = 7) -> Dict:
        """è·å–æœºåœºç»Ÿè®¡"""
        self.cur.execute("""
            SELECT
                COUNT(*) AS total_flights,
                COUNT(CASE WHEN status = 'delayed' THEN 1 END) AS delayed_count,
                COUNT(CASE WHEN status = 'cancelled' THEN 1 END) AS cancelled_count,
                AVG(delay_minutes) AS avg_delay,
                AVG(passenger_count) AS avg_passengers
            FROM flight_data
            WHERE (origin_airport = %s OR destination_airport = %s)
              AND time > NOW() - INTERVAL '%s days'
        """, (airport_code, airport_code, days))

        result = self.cur.fetchone()
        if result:
            return {
                'total_flights': result[0],
                'delayed_count': result[1],
                'cancelled_count': result[2],
                'avg_delay': float(result[3]) if result[3] else None,
                'avg_passengers': float(result[4]) if result[4] else None
            }
        return {}

# ä½¿ç”¨ç¤ºä¾‹
analyzer = FlightDataAnalyzer("host=localhost dbname=testdb user=postgres password=secret")

# è®°å½•èˆªç­æ•°æ®
scheduled_dep = datetime(2025, 1, 15, 10, 0, 0)
actual_dep = datetime(2025, 1, 15, 10, 15, 0)
scheduled_arr = datetime(2025, 1, 15, 12, 30, 0)

analyzer.record_flight_data(
    flight_number='CA1234',
    airline='Air China',
    origin_airport='PEK',
    destination_airport='PVG',
    scheduled_departure=scheduled_dep,
    actual_departure=actual_dep,
    scheduled_arrival=scheduled_arr,
    aircraft_type='Boeing 737',
    passenger_count=150,
    status='departed'
)

# åˆ†æå»¶è¯¯è¶‹åŠ¿
trends = analyzer.analyze_delay_trends('PEK', days=7)
print(f"Delay trends for {trends['airport_code']}")

# è·å–æœºåœºç»Ÿè®¡
stats = analyzer.get_airport_statistics('PEK', days=7)
print(f"Airport statistics: {stats}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-22-01
