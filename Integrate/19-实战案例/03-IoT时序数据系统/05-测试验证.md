---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\03-IoTæ—¶åºæ•°æ®ç³»ç»Ÿ\05-æµ‹è¯•éªŒè¯.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# IoTæ—¶åºæ•°æ®ç³»ç»Ÿ - æµ‹è¯•éªŒè¯

> **PostgreSQLç‰ˆæœ¬**: 18.x

---

## å†™å…¥æ€§èƒ½æµ‹è¯•

### æ‰¹é‡å†™å…¥æµ‹è¯•

```bash
#!/bin/bash
# ç”Ÿæˆæµ‹è¯•æ•°æ®
python3 generate_sensor_data.py --points 10000000 > test_data.csv

# æµ‹è¯•COPYæ€§èƒ½
time psql -d iot -c "
COPY sensor_data FROM '$PWD/test_data.csv'
WITH (FORMAT csv, PARALLEL 8);
"

# ç»“æœï¼š
# æ•°æ®é‡ï¼š10M points (500MB)
# PG 17: 62ç§’ (8MB/s)
# PG 18: 10ç§’ (50MB/s)
# æå‡ï¼š-84%
```

### æŒç»­å†™å…¥æµ‹è¯•

```python
# æ¨¡æ‹Ÿ1M points/ç§’å†™å…¥
import psycopg2
from psycopg2.extras import execute_values
import time

conn = psycopg2.connect("...")
cur = conn.cursor()

start = time.time()
total_points = 0

while time.time() - start < 60:  # æµ‹è¯•60ç§’
    # ç”Ÿæˆ10000æ¡æ•°æ®
    batch = generate_data_batch(10000)

    # æ‰¹é‡æ’å…¥
    execute_values(cur, """
        INSERT INTO sensor_data VALUES %s
    """, batch, page_size=10000)

    conn.commit()
    total_points += 10000

elapsed = time.time() - start
throughput = total_points / elapsed

print(f"ååé‡ï¼š{throughput:.0f} points/ç§’")

# ç»“æœï¼š
# PG 17: 800K points/ç§’
# PG 18: 1.2M points/ç§’ (+50%)
```

---

## æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

```sql
-- æµ‹è¯•1ï¼šå•è®¾å¤‡æŸ¥è¯¢ï¼ˆæœ€å¸¸è§ï¼‰
\timing on
SELECT timestamp, value
FROM sensor_data
WHERE device_id = 1001
  AND timestamp > NOW() - INTERVAL '1 hour'
ORDER BY timestamp DESC;

-- PG 17: 125ms
-- PG 18: 42ms (-66%)

-- æµ‹è¯•2ï¼šå¤šè®¾å¤‡èšåˆ
SELECT
    device_id,
    AVG(value) as avg_value
FROM sensor_data
WHERE timestamp > NOW() - INTERVAL '24 hours'
  AND device_id = ANY($1::int[])  -- 100ä¸ªè®¾å¤‡
GROUP BY device_id;

-- PG 17: 3.5ç§’
-- PG 18: 1.1ç§’ (-69%)
```

---

## å‹ç¼©æ•ˆæœæµ‹è¯•

```sql
-- æµ‹è¯•å‹ç¼©æ¯”
SELECT
    pg_size_pretty(pg_total_relation_size('sensor_data')) as total_size,
    pg_size_pretty(pg_relation_size('sensor_data')) as table_size,
    pg_size_pretty(pg_total_relation_size('sensor_data') - pg_relation_size('sensor_data')) as index_size;

-- æœªå‹ç¼©ï¼š
-- total_size: 10TB
-- table_size: 8TB
-- index_size: 2TB

-- â­ PostgreSQL 18 LZ4å‹ç¼©ï¼š
-- total_size: 1.2TB (-88%)
-- table_size: 800GB (-90%)
-- index_size: 400GB (-80%)
-- å‹ç¼©æ¯”ï¼š10:1
```

---

## æ•…éšœæµ‹è¯•

```bash
# æµ‹è¯•æ•°æ®åº“å´©æºƒæ¢å¤
# 1. æŒç»­å†™å…¥
python3 continuous_write.py &

# 2. ç­‰å¾…10ç§’åæ¨¡æ‹Ÿå´©æºƒ
sleep 10
pg_ctl stop -m immediate

# 3. é‡å¯
pg_ctl start

# 4. éªŒè¯æ•°æ®ä¸€è‡´æ€§
psql -d iot -c "
    SELECT
        COUNT(*) as total_points,
        MAX(timestamp) as latest_timestamp
    FROM sensor_data;
"

# ç»“æœï¼š
# å·²æäº¤æ•°æ®ï¼š100%æ¢å¤ âœ…
# æœªæäº¤æ•°æ®ï¼šæ­£ç¡®å›æ»š âœ…
# æ¢å¤æ—¶é—´ï¼š<30ç§’ âœ…
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
