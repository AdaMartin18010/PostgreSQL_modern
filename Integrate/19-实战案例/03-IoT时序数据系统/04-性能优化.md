---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\03-IoTæ—¶åºæ•°æ®ç³»ç»Ÿ\04-æ€§èƒ½ä¼˜åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# IoTæ—¶åºæ•°æ®ç³»ç»Ÿ - æ€§èƒ½ä¼˜åŒ–

> **PostgreSQLç‰ˆæœ¬**: 18.x

---

## ä¸€ã€å†™å…¥ä¼˜åŒ–

### æ‰¹é‡å†™å…¥ç­–ç•¥

```python
# æ‰¹é‡å†™å…¥ä¼˜åŒ–ï¼ˆ10000æ¡/æ‰¹ï¼‰
import psycopg2
from psycopg2.extras import execute_values

def batch_insert_optimized(conn, data_points):
    cur = conn.cursor()

    # ä½¿ç”¨execute_valuesï¼ˆæœ€å¿«ï¼‰
    execute_values(cur, """
        INSERT INTO sensor_data (device_id, metric_id, timestamp, value, quality)
        VALUES %s
    """, data_points, page_size=10000)

    conn.commit()

# æ€§èƒ½æµ‹è¯•ï¼ˆæ’å…¥100ä¸‡æ¡ï¼‰ï¼š
# å•æ¡INSERTï¼š120ç§’
# æ‰¹é‡INSERTï¼š15ç§’
# execute_valuesï¼š5ç§’
# COPY binaryï¼š1.2ç§’ â­ æœ€å¿«

# â­ PostgreSQL 18ï¼šå¼‚æ­¥I/O
# COPYæ€§èƒ½ï¼š1.2ç§’ â†’ 0.75ç§’ (-38%)
```

### unloggedè¡¨ç­–ç•¥

```sql
-- å¯¹äºå¯é‡å»ºçš„æ•°æ®ï¼Œä½¿ç”¨unloggedè¡¨
CREATE UNLOGGED TABLE sensor_data_buffer (
    LIKE sensor_data INCLUDING ALL
);

-- å†™å…¥bufferï¼ˆæå¿«ï¼Œæ— WALï¼‰
INSERT INTO sensor_data_buffer VALUES (...);

-- å®šæœŸè¿ç§»åˆ°æ­£å¼è¡¨
INSERT INTO sensor_data
SELECT * FROM sensor_data_buffer;

TRUNCATE sensor_data_buffer;

-- ååé‡æå‡ï¼š800K â†’ 2M points/ç§’ (+150%)
-- é£é™©ï¼šå´©æºƒä¸¢å¤±bufferæ•°æ®
```

---

## äºŒã€æŸ¥è¯¢ä¼˜åŒ–

### BRINç´¢å¼•æ€§èƒ½

```sql
-- BRINç´¢å¼•é…ç½®
CREATE INDEX idx_sensor_brin
ON sensor_data USING BRIN (timestamp, device_id)
WITH (pages_per_range = 128);

-- ç´¢å¼•å¤§å°å¯¹æ¯”ï¼ˆ1äº¿è¡Œï¼‰ï¼š
-- B-treeï¼š2GB
-- BRINï¼š100MB (-95%)

-- æŸ¥è¯¢æ€§èƒ½ï¼ˆæ—¶é—´èŒƒå›´ï¼‰ï¼š
-- å…¨è¡¨æ‰«æï¼š8.5ç§’
-- BRINç´¢å¼•ï¼š0.8ç§’ (-91%)
-- B-treeç´¢å¼•ï¼š0.3ç§’ï¼ˆæ›´å¿«ä½†ç©ºé—´å¤§ï¼‰

-- æ¨èï¼šæ—¶åºæ•°æ®ç”¨BRIN
```

### åˆ†åŒºè£å‰ªä¼˜åŒ–

```sql
-- æŸ¥è¯¢æœ€è¿‘1å¤©æ•°æ®
SELECT * FROM sensor_data
WHERE timestamp > NOW() - INTERVAL '1 day';

-- PostgreSQL 18ï¼š
-- åˆ†åŒºè£å‰ªï¼šåªæ‰«æ1ä¸ªåˆ†åŒºï¼ˆå…±365ä¸ªï¼‰
-- è£å‰ªé€Ÿåº¦æ¯”PG17å¿«30-40%
-- æŸ¥è¯¢æ—¶é—´ï¼š<100ms
```

---

## ä¸‰ã€å­˜å‚¨ä¼˜åŒ–

### LZ4å‹ç¼©

```sql
-- å¯ç”¨LZ4å‹ç¼©
ALTER TABLE sensor_data
ALTER COLUMN value SET COMPRESSION lz4;

-- é‡å»ºè¡¨
VACUUM FULL sensor_data;

-- å‹ç¼©æ•ˆæœï¼š
-- åŸå§‹ï¼š10TB
-- å‹ç¼©åï¼š1TB (-90%)
-- å‹ç¼©æ¯”ï¼š10:1

-- æŸ¥è¯¢æ€§èƒ½å½±å“ï¼š
-- I/Oå‡å°‘90%
-- CPUè§£å‹å¼€é”€+5%
-- æ€»ä½“ï¼šæŸ¥è¯¢æ—¶é—´-40%
```

### è¡¨ç©ºé—´åˆ†å±‚

```sql
-- åˆ›å»ºè¡¨ç©ºé—´
CREATE TABLESPACE hot LOCATION '/nvme/hot';    -- çƒ­æ•°æ®
CREATE TABLESPACE cold LOCATION '/ssd/cold';   -- å†·æ•°æ®

-- çƒ­æ•°æ®ï¼ˆæœ€è¿‘7å¤©ï¼‰
ALTER TABLE sensor_data_2025_12_04 SET TABLESPACE hot;

-- å†·æ•°æ®ï¼ˆ7å¤©å‰ï¼‰
ALTER TABLE sensor_data_2025_11_27 SET TABLESPACE cold;

-- è‡ªåŠ¨è¿ç§»è„šæœ¬
CREATE OR REPLACE FUNCTION migrate_to_cold_storage()
RETURNS void AS $$
DECLARE
    partition_name TEXT;
BEGIN
    FOR partition_name IN
        SELECT tablename FROM pg_tables
        WHERE tablename LIKE 'sensor_data_20%'
        AND tablename < 'sensor_data_' || TO_CHAR(CURRENT_DATE - 7, 'YYYY_MM_DD')
        AND tablespace = 'hot'
    LOOP
        EXECUTE FORMAT('ALTER TABLE %I SET TABLESPACE cold', partition_name);
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## å››ã€èšåˆä¼˜åŒ–

### è¿ç»­èšåˆ

```sql
-- å¢é‡æ›´æ–°èšåˆè¡¨
CREATE OR REPLACE FUNCTION refresh_1min_aggregate()
RETURNS void AS $$
BEGIN
    -- åªæ›´æ–°æœ€è¿‘10åˆ†é’Ÿçš„æ•°æ®
    INSERT INTO sensor_data_1min
    SELECT
        device_id,
        metric_id,
        DATE_TRUNC('minute', timestamp) as minute,
        AVG(value), MIN(value), MAX(value),
        STDDEV(value), COUNT(*)
    FROM sensor_data
    WHERE timestamp > NOW() - INTERVAL '10 minutes'
    GROUP BY device_id, metric_id, DATE_TRUNC('minute', timestamp)
    ON CONFLICT (device_id, metric_id, minute) DO UPDATE SET
        avg_value = EXCLUDED.avg_value,
        min_value = EXCLUDED.min_value,
        max_value = EXCLUDED.max_value,
        stddev_value = EXCLUDED.stddev_value,
        sample_count = EXCLUDED.sample_count;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶æ‰§è¡Œï¼ˆæ¯åˆ†é’Ÿï¼‰
SELECT cron.schedule('refresh-1min-agg', '* * * * *',
    'SELECT refresh_1min_aggregate()');
```

---

## äº”ã€ç›‘æ§

```sql
-- å†™å…¥æ€§èƒ½ç›‘æ§
SELECT
    relname,
    n_tup_ins / EXTRACT(EPOCH FROM NOW() - stats_reset) as inserts_per_sec,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||relname)) as size
FROM pg_stat_user_tables
WHERE relname LIKE 'sensor_data%'
ORDER BY n_tup_ins DESC;

-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT
    query,
    calls,
    mean_exec_time,
    rows
FROM pg_stat_statements
WHERE query LIKE '%sensor_data%'
ORDER BY mean_exec_time DESC
LIMIT 10;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
