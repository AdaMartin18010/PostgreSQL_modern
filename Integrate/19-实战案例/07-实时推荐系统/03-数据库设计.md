---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\07-å®æ—¶æ¨èç³»ç»Ÿ\03-æ•°æ®åº“è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿](../æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿.md) - é€šç”¨æ¡ˆä¾‹æ–‡æ¡£æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºå®æ—¶æ¨èç³»ç»Ÿçš„æ•°æ®åº“è®¾è®¡å‚è€ƒã€‚

---

# æ¡ˆä¾‹7ï¼šå®æ—¶æ¨èç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## Schemaè®¾è®¡

```sql
-- 1. ç”¨æˆ·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
                RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œå°†åˆ›å»ºè¡¨ä½†ä¸åŒ…å«å‘é‡åˆ—';
            END IF;

            CREATE TABLE users (
                user_id BIGSERIAL PRIMARY KEY,
                age_group INT,
                gender VARCHAR(10),
                city_level INT,
                register_date DATE,
                active_days INT DEFAULT 0,
                purchase_count INT DEFAULT 0,
                avg_price NUMERIC(10,2),
                preference_vector vector(128),  -- pgvector
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            );
            RAISE NOTICE 'ç”¨æˆ·è¡¨ users åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç”¨æˆ·è¡¨ users å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç”¨æˆ·è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç”¨æˆ·è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·è¡¨å‘é‡ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•åˆ›å»ºå‘é‡ç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_users_vector') THEN
            CREATE INDEX idx_users_vector ON users USING hnsw (preference_vector vector_l2_ops);
            RAISE NOTICE 'å‘é‡ç´¢å¼• idx_users_vector åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å‘é‡ç´¢å¼• idx_users_vector å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‘é‡ç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. å•†å“è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
                RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œå°†åˆ›å»ºè¡¨ä½†ä¸åŒ…å«å‘é‡åˆ—';
            END IF;

            CREATE TABLE items (
                item_id BIGSERIAL PRIMARY KEY,
                title VARCHAR(500),
                category_id INT,
                brand_id INT,
                price NUMERIC(10,2),
                sales_count INT DEFAULT 0,
                rating NUMERIC(3,2),
                ctr_7d NUMERIC(5,4),
                cvr_7d NUMERIC(5,4),
                embedding vector(128),  -- å•†å“å‘é‡
                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            );
            RAISE NOTICE 'å•†å“è¡¨ items åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å•†å“è¡¨ items å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'å•†å“è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå•†å“è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å•†å“è¡¨ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            RAISE WARNING 'è¡¨ items ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_items_category') THEN
            CREATE INDEX idx_items_category ON items (category_id);
            RAISE NOTICE 'ç´¢å¼• idx_items_category åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_items_embedding') THEN
                CREATE INDEX idx_items_embedding ON items USING hnsw (embedding vector_l2_ops);
                RAISE NOTICE 'å‘é‡ç´¢å¼• idx_items_embedding åˆ›å»ºæˆåŠŸ';
            END IF;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_items_sales') THEN
            CREATE INDEX idx_items_sales ON items (sales_count DESC);
            RAISE NOTICE 'ç´¢å¼• idx_items_sales åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ç”¨æˆ·è¡Œä¸ºè¡¨ï¼ˆåˆ†åŒºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') THEN
            CREATE TABLE user_behavior (
                behavior_id BIGSERIAL,
                user_id BIGINT NOT NULL,
                item_id BIGINT NOT NULL,
                behavior_type VARCHAR(20) NOT NULL,  -- view/click/cart/buy
                timestamp TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (behavior_id, timestamp)
            ) PARTITION BY RANGE (timestamp);
            RAISE NOTICE 'åˆ†åŒºè¡¨ user_behavior åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'åˆ†åŒºè¡¨ user_behavior å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'åˆ†åŒºè¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºåˆ†åŒºï¼ˆæœ€è¿‘30å¤©ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    partition_date DATE;
    partition_name TEXT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') THEN
            RAISE WARNING 'è¡¨ user_behavior ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒº';
            RETURN;
        END IF;

        FOR i IN 0..29 LOOP
            partition_date := CURRENT_DATE - i;
            partition_name := 'user_behavior_' || to_char(partition_date, 'YYYYMMDD');

            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = partition_name) THEN
                EXECUTE format('
                    CREATE TABLE %I
                    PARTITION OF user_behavior
                    FOR VALUES FROM (%L) TO (%L);
                ', partition_name, partition_date, partition_date + 1);
                RAISE NOTICE 'åˆ†åŒº % åˆ›å»ºæˆåŠŸ', partition_name;
            END IF;

            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_behavior_' || to_char(partition_date, 'YYYYMMDD') || '_user') THEN
                EXECUTE format('
                    CREATE INDEX idx_behavior_%s_user
                    ON %I (user_id, timestamp);
                ', to_char(partition_date, 'YYYYMMDD'), partition_name);
            END IF;

            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_behavior_' || to_char(partition_date, 'YYYYMMDD') || '_item') THEN
                EXECUTE format('
                    CREATE INDEX idx_behavior_%s_item
                    ON %I (item_id, timestamp);
                ', to_char(partition_date, 'YYYYMMDD'), partition_name);
            END IF;
        END LOOP;

        RAISE NOTICE '30ä¸ªåˆ†åŒºåˆ›å»ºå®Œæˆ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'åˆ†åŒºå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. ç”¨æˆ·-å•†å“äº¤äº’ç»Ÿè®¡ï¼ˆç‰©åŒ–è§†å›¾ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') THEN
            RAISE WARNING 'è¡¨ user_behavior ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç‰©åŒ–è§†å›¾';
            RETURN;
        END IF;

        DROP MATERIALIZED VIEW IF EXISTS user_item_stats;
        CREATE MATERIALIZED VIEW user_item_stats AS
        SELECT
            user_id,
            item_id,
            COUNT(*) FILTER (WHERE behavior_type = 'view') AS view_count,
    COUNT(*) FILTER (WHERE behavior_type = 'click') AS click_count,
    COUNT(*) FILTER (WHERE behavior_type = 'cart') AS cart_count,
    COUNT(*) FILTER (WHERE behavior_type = 'buy') AS buy_count,
    MAX(timestamp) AS last_interaction
FROM user_behavior
WHERE timestamp > CURRENT_TIMESTAMP - INTERVAL '30 days'
GROUP BY user_id, item_id;

        -- åˆ›å»ºç‰©åŒ–è§†å›¾ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_user_item_stats_user') THEN
            CREATE INDEX idx_user_item_stats_user ON user_item_stats (user_id);
            RAISE NOTICE 'ç´¢å¼• idx_user_item_stats_user åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_user_item_stats_user å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_user_item_stats_item') THEN
            CREATE INDEX idx_user_item_stats_item ON user_item_stats (item_id);
            RAISE NOTICE 'ç´¢å¼• idx_user_item_stats_item åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_user_item_stats_item å·²å­˜åœ¨';
        END IF;

-- å®šæ—¶åˆ·æ–°ï¼ˆæ¯å°æ—¶ï¼‰
CREATE OR REPLACE FUNCTION refresh_user_item_stats()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY user_item_stats;
END;
$$ LANGUAGE plpgsql;

-- 5. å•†å“ç›¸ä¼¼åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'item_similarity') THEN
            CREATE TABLE item_similarity (
                item_id BIGINT NOT NULL,
                similar_item_id BIGINT NOT NULL,
                similarity_score NUMERIC(5,4),
                PRIMARY KEY (item_id, similar_item_id)
            );
            RAISE NOTICE 'å•†å“ç›¸ä¼¼åº¦è¡¨ item_similarity åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å•†å“ç›¸ä¼¼åº¦è¡¨ item_similarity å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_item_similarity_score') THEN
            CREATE INDEX idx_item_similarity_score ON item_similarity (item_id, similarity_score DESC);
            RAISE NOTICE 'ç´¢å¼• idx_item_similarity_score åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_item_similarity_score å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨æˆ–ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå•†å“ç›¸ä¼¼åº¦è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 6. ç”¨æˆ·ç›¸ä¼¼åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_similarity') THEN
            CREATE TABLE user_similarity (
                user_id BIGINT NOT NULL,
                similar_user_id BIGINT NOT NULL,
                similarity_score NUMERIC(5,4),
                PRIMARY KEY (user_id, similar_user_id)
            );
            RAISE NOTICE 'ç”¨æˆ·ç›¸ä¼¼åº¦è¡¨ user_similarity åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç”¨æˆ·ç›¸ä¼¼åº¦è¡¨ user_similarity å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_user_similarity_score') THEN
            CREATE INDEX idx_user_similarity_score ON user_similarity (user_id, similarity_score DESC);
            RAISE NOTICE 'ç´¢å¼• idx_user_similarity_score åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_user_similarity_score å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨æˆ–ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç”¨æˆ·ç›¸ä¼¼åº¦è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 7. æ¨èç»“æœç¼“å­˜è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'recommendation_cache') THEN
            CREATE TABLE recommendation_cache (
                user_id BIGINT PRIMARY KEY,
                recommended_items BIGINT[],
                scores NUMERIC[],
                generated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                expires_at TIMESTAMPTZ
            );
            RAISE NOTICE 'æ¨èç»“æœç¼“å­˜è¡¨ recommendation_cache åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ¨èç»“æœç¼“å­˜è¡¨ recommendation_cache å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_recommendation_expires') THEN
            CREATE INDEX idx_recommendation_expires ON recommendation_cache (expires_at);
            RAISE NOTICE 'ç´¢å¼• idx_recommendation_expires åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_recommendation_expires å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨æˆ–ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ¨èç»“æœç¼“å­˜è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## æ ¸å¿ƒå‡½æ•°

```sql
-- 1. ååŒè¿‡æ»¤æ¨èï¼ˆUser-Basedï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION recommend_user_cf(
    p_user_id BIGINT,
    p_limit INT DEFAULT 200
) RETURNS TABLE (
    item_id BIGINT,
    score NUMERIC
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM users WHERE user_id = p_user_id) THEN
            RAISE EXCEPTION 'ç”¨æˆ· % ä¸å­˜åœ¨', p_user_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        WITH similar_users AS (
        SELECT similar_user_id, similarity_score
        FROM user_similarity
        WHERE user_id = p_user_id
        ORDER BY similarity_score DESC
        LIMIT 50
    ),
    similar_user_items AS (
        SELECT
            ub.item_id,
            SUM(su.similarity_score) AS weighted_score
        FROM similar_users su
        JOIN user_behavior ub ON su.similar_user_id = ub.user_id
        WHERE ub.behavior_type IN ('buy', 'cart')
          AND ub.timestamp > CURRENT_TIMESTAMP - INTERVAL '30 days'
          AND ub.item_id NOT IN (
              SELECT item_id FROM user_behavior
              WHERE user_id = p_user_id AND behavior_type = 'buy'
          )
        GROUP BY ub.item_id
    )
        SELECT sui.item_id, sui.weighted_score
        FROM similar_user_items sui
        ORDER BY weighted_score DESC
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'User-Basedæ¨èè®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 2. ååŒè¿‡æ»¤æ¨èï¼ˆItem-Basedï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION recommend_item_cf(
    p_user_id BIGINT,
    p_limit INT DEFAULT 200
) RETURNS TABLE (
    item_id BIGINT,
    score NUMERIC
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'item_similarity') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        WITH user_history AS (
            SELECT DISTINCT item_id
            FROM user_behavior
            WHERE user_id = p_user_id
              AND behavior_type IN ('buy', 'cart', 'click')
              AND timestamp > CURRENT_TIMESTAMP - INTERVAL '30 days'
            LIMIT 20
        ),
        similar_items AS (
            SELECT
                isim.similar_item_id AS item_id,
                AVG(isim.similarity_score) AS avg_score
            FROM user_history uh
            JOIN item_similarity isim ON uh.item_id = isim.item_id
            WHERE isim.similar_item_id NOT IN (
                SELECT item_id FROM user_behavior
                WHERE user_id = p_user_id AND behavior_type = 'buy'
            )
            GROUP BY isim.similar_item_id
        )
        SELECT si.item_id, si.avg_score
        FROM similar_items si
        ORDER BY avg_score DESC
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Item-Basedæ¨èè®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 3. å‘é‡å¬å›ï¼ˆpgvectorï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION recommend_vector(
    p_user_id BIGINT,
    p_limit INT DEFAULT 200
) RETURNS TABLE (
    item_id BIGINT,
    score NUMERIC
) AS $$
DECLARE
    user_vec vector(128);
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        -- è·å–ç”¨æˆ·åå¥½å‘é‡
        SELECT preference_vector INTO user_vec
        FROM users WHERE user_id = p_user_id;

        IF user_vec IS NULL THEN
            RETURN;
        END IF;

        RETURN QUERY
        SELECT
            i.item_id,
            1 - (i.embedding <-> user_vec) AS similarity
        FROM items i
        WHERE i.item_id NOT IN (
            SELECT item_id FROM user_behavior
            WHERE user_id = p_user_id AND behavior_type = 'buy'
        )
        ORDER BY i.embedding <-> user_vec
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡æ¨èè®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 4. çƒ­é—¨æ¨èï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION recommend_popular(
    p_category_id INT DEFAULT NULL,
    p_limit INT DEFAULT 100
) RETURNS TABLE (
    item_id BIGINT,
    score NUMERIC
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            RAISE EXCEPTION 'è¡¨ items ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        SELECT
            i.item_id,
            (i.sales_count::NUMERIC / NULLIF(1000.0, 0) + COALESCE(i.ctr_7d, 0) * 10) AS popularity_score
        FROM items i
        WHERE (p_category_id IS NULL OR i.category_id = p_category_id)
          AND i.sales_count > 10
        ORDER BY popularity_score DESC
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çƒ­é—¨æ¨èè®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 5. ç»¼åˆæ¨èï¼ˆå¤šè·¯å¬å›ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION recommend_items(
    p_user_id BIGINT,
    p_limit INT DEFAULT 50
) RETURNS TABLE (
    item_id BIGINT,
    final_score NUMERIC
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_limit IS NULL OR p_limit <= 0 THEN
            RAISE EXCEPTION 'limitå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            RAISE EXCEPTION 'è¡¨ items ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°éªŒè¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        RETURN QUERY
        WITH all_candidates AS (
            -- è·¯å¾„1: User-Based CF
            SELECT item_id, score * 0.3 AS weighted_score, 'user_cf' AS source
            FROM recommend_user_cf(p_user_id, 200)

            UNION ALL

            -- è·¯å¾„2: Item-Based CF
            SELECT item_id, score * 0.3 AS weighted_score, 'item_cf' AS source
            FROM recommend_item_cf(p_user_id, 200)

            UNION ALL

            -- è·¯å¾„3: å‘é‡å¬å›
            SELECT item_id, score * 0.25 AS weighted_score, 'vector' AS source
            FROM recommend_vector(p_user_id, 200)

            UNION ALL

            -- è·¯å¾„4: çƒ­é—¨æ¨è
            SELECT item_id, score * 0.15 AS weighted_score, 'popular' AS source
            FROM recommend_popular(NULL, 100)
        ),
        merged AS (
            SELECT
                item_id,
                SUM(weighted_score) AS total_score
            FROM all_candidates
            GROUP BY item_id
        )
        SELECT
            m.item_id,
            m.total_score
        FROM merged m
        JOIN items i ON m.item_id = i.item_id
        WHERE i.sales_count > 0  -- è¿‡æ»¤æ— æ•ˆå•†å“
        ORDER BY total_score DESC
        LIMIT p_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆæ¨èè®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

---

## 8. æ•°æ®ç»´æŠ¤å‡½æ•°

### 8.1 ç›¸ä¼¼åº¦è®¡ç®—ç»´æŠ¤

**ç›¸ä¼¼åº¦è®¡ç®—ç»´æŠ¤å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'similarity_tasks') THEN
            CREATE TABLE similarity_tasks (
                task_id SERIAL PRIMARY KEY,
                task_type TEXT NOT NULL,  -- 'item' or 'user'
                status TEXT DEFAULT 'pending',  -- 'pending', 'running', 'completed', 'failed'
                started_at TIMESTAMPTZ,
                completed_at TIMESTAMPTZ,
                items_processed INT DEFAULT 0,
                items_total INT DEFAULT 0,
                error_message TEXT
            );
            RAISE NOTICE 'ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡è¡¨ similarity_tasks åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡è¡¨ similarity_tasks å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡ç®¡ç†å‡½æ•°
CREATE OR REPLACE FUNCTION manage_similarity_calculation(
    p_task_type TEXT,
    p_batch_size INT DEFAULT 1000
)
RETURNS TABLE (
    task_id INT,
    status TEXT,
    progress_percent NUMERIC
) AS $$
DECLARE
    new_task_id INT;
    total_items INT;
    processed_items INT;
BEGIN
    -- åˆ›å»ºä»»åŠ¡è®°å½•
    INSERT INTO similarity_tasks (task_type, status, started_at)
    VALUES (p_task_type, 'running', NOW())
    RETURNING task_id INTO new_task_id;

    -- è·å–æ€»æ•°é‡
    IF p_task_type = 'item' THEN
        SELECT COUNT(*) INTO total_items FROM items WHERE sales_count > 10;
    ELSIF p_task_type = 'user' THEN
        SELECT COUNT(DISTINCT user_id) INTO total_items
        FROM user_behavior
        WHERE timestamp > NOW() - INTERVAL '30 days';
    END IF;

    -- æ›´æ–°ä»»åŠ¡æ€»æ•°
    UPDATE similarity_tasks
    SET items_total = total_items
    WHERE task_id = new_task_id;

    -- æ‰§è¡Œç›¸ä¼¼åº¦è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥åˆ†æ‰¹å¤„ç†ï¼‰
    -- è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…è®¡ç®—é€»è¾‘åœ¨åº”ç”¨å±‚

    -- æ ‡è®°å®Œæˆ
    UPDATE similarity_tasks
    SET status = 'completed',
        completed_at = NOW(),
        items_processed = total_items
    WHERE task_id = new_task_id;

    RETURN QUERY SELECT
        new_task_id,
        'completed'::TEXT,
        100.0::NUMERIC;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        UPDATE similarity_tasks
        SET status = 'failed',
            error_message = SQLERRM
        WHERE task_id = new_task_id;

        RAISE EXCEPTION 'ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 æ•°æ®æ¸…ç†å‡½æ•°

**æ•°æ®æ¸…ç†å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ¸…ç†è¿‡æœŸè¡Œä¸ºæ•°æ®
CREATE OR REPLACE FUNCTION cleanup_old_behavior(
    p_retention_days INT DEFAULT 90
)
RETURNS TABLE (
    deleted_partitions INT,
    deleted_rows BIGINT
) AS $$
DECLARE
    partition_name TEXT;
    deleted_count BIGINT := 0;
    partition_count INT := 0;
    cutoff_date DATE;
BEGIN
    cutoff_date := CURRENT_DATE - (p_retention_days || ' days')::INTERVAL;

    -- åˆ é™¤æ—§åˆ†åŒº
    FOR partition_name IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
          AND tablename LIKE 'user_behavior_%'
          AND tablename < 'user_behavior_' || to_char(cutoff_date, 'YYYYMMDD')
    LOOP
        EXECUTE format('DROP TABLE IF EXISTS %I', partition_name);
        partition_count := partition_count + 1;
    END LOOP;

    -- ç»Ÿè®¡åˆ é™¤çš„è¡Œæ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
    SELECT COUNT(*) INTO deleted_count
    FROM user_behavior
    WHERE timestamp::DATE < cutoff_date;

    -- å®é™…åˆ é™¤æ•°æ®ï¼ˆå¦‚æœåˆ†åŒºå·²åˆ é™¤ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œï¼‰
    DELETE FROM user_behavior
    WHERE timestamp::DATE < cutoff_date;

    RETURN QUERY SELECT partition_count, deleted_count;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®æ¸…ç†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 9. ç›‘æ§ä¸è¯Šæ–­

### 9.1 æ¨èç³»ç»Ÿç›‘æ§

**æ¨èç³»ç»Ÿç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ¨èç³»ç»Ÿç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW v_recommendation_system_monitor AS
SELECT
    date_trunc('hour', generated_at) AS hour,
    COUNT(*) AS recommendation_count,
    ROUND(AVG(array_length(recommended_items, 1)), 2) AS avg_items_per_rec,
    COUNT(*) FILTER (WHERE expires_at > NOW()) AS cache_hit_count,
    COUNT(*) FILTER (WHERE expires_at <= NOW()) AS cache_miss_count,
    ROUND(COUNT(*) FILTER (WHERE expires_at > NOW()) * 100.0 / COUNT(*), 2) AS cache_hit_rate
FROM recommendation_cache
WHERE generated_at > NOW() - INTERVAL '24 hours'
GROUP BY date_trunc('hour', generated_at)
ORDER BY hour DESC;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM v_recommendation_system_monitor;
```

---

**è¿”å›**: [æ¡ˆä¾‹7ä¸»é¡µ](./README.md)
