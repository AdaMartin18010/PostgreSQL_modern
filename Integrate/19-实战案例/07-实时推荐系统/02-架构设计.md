---

> **📋 文档来源**: `DataBaseTheory\19-场景案例库\07-实时推荐系统\02-架构设计.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 案例7：实时推荐系统 - 架构设计

## 总体架构

```text
┌────────────────────────────────────────────────────────┐
│              实时推荐系统架构                           │
├────────────────────────────────────────────────────────┤
│                                                        │
│  [用户] → [推荐API] → [召回层] → [排序层] → [返回]       │
│                           │          │                 │
│                    [PostgreSQL 18]   │                 │
│                      ├─ 用户画像     │                  │
│                      ├─ 商品特征     │                  │
│                      ├─ 行为数据     │                  │
│                      └─ 向量索引     │                  │
│                                      │                 │
│                              [Redis缓存]               │
│                                ├─ 热门商品             │
│                                └─ 用户最近行为          │
│                                                        │
│  [行为流] → [Kafka] → [实时写入Worker]                  │
│                              ↓                         │
│                       [PostgreSQL]                     │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

## 召回策略

### 多路召回

```sql
-- 路径1: 协同过滤（User-Based）
相似用户喜欢的商品 → 200个候选

-- 路径2: 协同过滤（Item-Based）
用户历史商品的相似商品 → 200个候选

-- 路径3: 向量召回
用户偏好向量 × 商品向量 → 200个候选

-- 路径4: 热门推荐
品类Top商品 → 100个候选

-- 路径5: 新品推荐
最新上架高质量商品 → 50个候选

总候选池: ~750个
```

### 召回去重与合并

```sql
-- 去重
DISTINCT ON (item_id)

-- 合并分数
score = w1*cf_score + w2*vector_score + w3*popular_score
```

---

## 排序模型

### 特征工程

**用户特征** (15维):

```python
[
    user_age_group,      # 年龄段
    user_gender,         # 性别
    user_city_level,     # 城市等级
    user_active_days,    # 活跃天数
    user_purchase_count, # 购买次数
    user_avg_price,      # 平均客单价
    ...
]
```

**商品特征** (20维):

```python
[
    item_category,       # 类目
    item_price,          # 价格
    item_sales,          # 销量
    item_rating,         # 评分
    item_ctr_7d,         # 7日CTR
    item_cvr_7d,         # 7日CVR
    ...
]
```

**交叉特征** (10维):

```python
[
    user_category_affinity,  # 用户-品类亲和度
    price_match_score,       # 价格匹配度
    ...
]
```

### CTR预估

```python
# 逻辑回归模型
P(click) = sigmoid(w^T * x)

# 多目标
score = α*P(click) + β*P(buy)
```

---

## 数据库设计要点

### 1. 分区策略

```sql
-- 行为表按时间分区（日分区）
CREATE TABLE user_behavior (
    user_id BIGINT,
    item_id BIGINT,
    behavior_type VARCHAR(20),
    timestamp TIMESTAMPTZ
) PARTITION BY RANGE (timestamp);
```

### 2. 索引策略

```sql
-- 用户维度查询
CREATE INDEX ON user_behavior (user_id, timestamp);

-- 商品维度查询
CREATE INDEX ON user_behavior (item_id, timestamp);

-- 向量相似度（HNSW）
CREATE INDEX ON items USING hnsw (embedding vector_l2_ops);
```

---

## 性能优化

### 1. 缓存分层

```text
L1: Redis (热门商品, TTL=5min)
L2: PostgreSQL shared_buffers (用户画像)
L3: 磁盘
```

### 2. 查询优化

```sql
-- 并行多路召回
WITH RECURSIVE ...
UNION ALL
-- 各路召回结果合并
```

### 3. 批处理

```python
# 批量用户推荐（夜间预计算）
for user_batch in users:
    precompute_recommendations(user_batch)
    store_to_cache()
```

---

**返回**: [案例7主页](./README.md)
