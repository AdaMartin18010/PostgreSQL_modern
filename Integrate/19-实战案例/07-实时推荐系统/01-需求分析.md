---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\07-å®æ—¶æ¨èç³»ç»Ÿ\01-éœ€æ±‚åˆ†æ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹7ï¼šå®æ—¶æ¨èç³»ç»Ÿ - éœ€æ±‚åˆ†æ

## ä¸šåŠ¡èƒŒæ™¯

ç”µå•†å¹³å°éœ€è¦ä¸ºç”¨æˆ·å®æ—¶æ¨èå•†å“ï¼Œè¦æ±‚ï¼š

- **å®æ—¶æ€§**: ç”¨æˆ·è¡Œä¸ºå100mså†…æ›´æ–°æ¨è
- **ä¸ªæ€§åŒ–**: åŸºäºç”¨æˆ·å†å²è¡Œä¸º
- **å‡†ç¡®æ€§**: CTRç›®æ ‡>5%
- **è§„æ¨¡**: 1000ä¸‡ç”¨æˆ·ï¼Œ1äº¿å•†å“ï¼Œ10äº¿è¡Œä¸ºè®°å½•

---

## æŠ€æœ¯éœ€æ±‚

### 1. æ•°æ®å­˜å‚¨

**ç”¨æˆ·ç”»åƒ**:

```sql
ç”¨æˆ·åŸºç¡€ä¿¡æ¯ (1000ä¸‡)
â”œâ”€ ç”¨æˆ·ID
â”œâ”€ å¹´é¾„æ®µã€æ€§åˆ«ã€åœ°åŸŸ
â”œâ”€ æ³¨å†Œæ—¶é—´ã€æ´»è·ƒåº¦
â””â”€ æ¶ˆè´¹åå¥½æ ‡ç­¾
```

**å•†å“ç‰¹å¾**:

```sql
å•†å“ä¿¡æ¯ (1äº¿)
â”œâ”€ å•†å“IDã€ç±»ç›®
â”œâ”€ ä»·æ ¼ã€å“ç‰Œ
â”œâ”€ é”€é‡ã€è¯„åˆ†
â””â”€ æ ‡ç­¾å‘é‡
```

**è¡Œä¸ºæ•°æ®**:

```sql
ç”¨æˆ·è¡Œä¸º (10äº¿+ï¼Œå®æ—¶å¢é•¿)
â”œâ”€ æµè§ˆ (PV)
â”œâ”€ ç‚¹å‡»
â”œâ”€ åŠ è´­
â”œâ”€ è´­ä¹°
â””â”€ è¯„ä»·
```

---

### 2. æ¨èç®—æ³•

**ååŒè¿‡æ»¤**:

- User-Based CF
- Item-Based CF
- åŸºäºPostgreSQLç›¸ä¼¼åº¦è®¡ç®—

**ç‰¹å¾å·¥ç¨‹**:

```sql
-- ç”¨æˆ·ç‰¹å¾
ç”¨æˆ·æ´»è·ƒåº¦ã€è´­ä¹°åŠ›ã€åå¥½å“ç±»

-- å•†å“ç‰¹å¾
çƒ­åº¦ã€è½¬åŒ–ç‡ã€ç›¸ä¼¼å•†å“

-- äº¤å‰ç‰¹å¾
ç”¨æˆ·-å“ç±»äº²å’Œåº¦
```

**æ’åºæ¨¡å‹**:

- CTRé¢„ä¼°ï¼ˆé€»è¾‘å›å½’ï¼‰
- å¤šç›®æ ‡ä¼˜åŒ–ï¼ˆç‚¹å‡»+è´­ä¹°ï¼‰

---

### 3. æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| æ¨èå»¶è¿Ÿ | <100ms | P95 |
| è¡Œä¸ºå†™å…¥ | 100K/ç§’ | å³°å€¼ |
| æ¨èQPS | 50K | å³°å€¼ |
| æ¨¡å‹æ›´æ–° | å°æ—¶çº§ | å¢é‡æ›´æ–° |

---

## æ•°æ®æµ

```text
ç”¨æˆ·è¡Œä¸º â†’ å®æ—¶å†™å…¥ â†’ PostgreSQL
    â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
         ç‰¹å¾æå– (å®æ—¶)
                â†“
         æ¨èå¬å› (å¤šè·¯)
         â”œâ”€ ååŒè¿‡æ»¤
         â”œâ”€ çƒ­é—¨æ¨è
         â””â”€ å†…å®¹æ¨è
                â†“
         æ’åºæ‰“åˆ† (CTR)
                â†“
         è¿”å›Top-N (100mså†…)
```

---

## PostgreSQL 18ç‰¹æ€§åº”ç”¨

âœ… **pgvector**: å•†å“å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
âœ… **HNSWç´¢å¼•**: å¿«é€Ÿå‘é‡æ£€ç´¢
âœ… **Skip Scan**: ç¨€ç–æ¡ä»¶æŸ¥è¯¢ä¼˜åŒ–
âœ… **å¹¶è¡ŒæŸ¥è¯¢**: å¤šè·¯å¬å›å¹¶è¡Œ
âœ… **åˆ†åŒºè¡¨**: è¡Œä¸ºæ•°æ®æŒ‰æ—¶é—´åˆ†åŒº

---

---

## å…­ã€æ•°æ®è´¨é‡éœ€æ±‚

### 6.1 æ•°æ®ä¸€è‡´æ€§

**æ•°æ®ä¸€è‡´æ€§è¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_data_consistency()
RETURNS TABLE (
    check_type TEXT,
    check_result TEXT,
    status TEXT
) AS $$
DECLARE
    user_count BIGINT;
    behavior_count BIGINT;
    item_count BIGINT;
BEGIN
    -- æ£€æŸ¥ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§
    SELECT COUNT(*) INTO user_count FROM users;
    SELECT COUNT(DISTINCT user_id) INTO behavior_count FROM user_behavior;

    IF user_count != behavior_count THEN
        RETURN QUERY SELECT
            'ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§'::TEXT,
            format('ç”¨æˆ·è¡¨: %s, è¡Œä¸ºè¡¨: %s', user_count, behavior_count)::TEXT,
            'ä¸ä¸€è‡´'::TEXT;
    ELSE
        RETURN QUERY SELECT
            'ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§'::TEXT,
            'ä¸€è‡´'::TEXT,
            'æ­£å¸¸'::TEXT;
    END IF;

    -- æ£€æŸ¥å•†å“æ•°æ®ä¸€è‡´æ€§
    SELECT COUNT(*) INTO item_count FROM items;

    RETURN QUERY SELECT
        'å•†å“æ•°æ®ä¸€è‡´æ€§'::TEXT,
        format('å•†å“æ€»æ•°: %s', item_count)::TEXT,
        'æ­£å¸¸'::TEXT;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 æ¨èè´¨é‡è¯„ä¼°

**æ¨èè´¨é‡è¯„ä¼°å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ¨èè´¨é‡è¯„ä¼°è¡¨
CREATE TABLE IF NOT EXISTS recommendation_quality (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    recommended_items BIGINT[],
    clicked_items BIGINT[],
    purchased_items BIGINT[],
    evaluation_date DATE DEFAULT CURRENT_DATE,
    ctr NUMERIC(5,4),  -- ç‚¹å‡»ç‡
    cvr NUMERIC(5,4),  -- è½¬åŒ–ç‡
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ¨èè´¨é‡è¯„ä¼°å‡½æ•°
CREATE OR REPLACE FUNCTION evaluate_recommendation_quality(
    p_user_id BIGINT,
    p_recommended_items BIGINT[],
    p_evaluation_days INT DEFAULT 7
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC,
    target_value NUMERIC,
    status TEXT
) AS $$
DECLARE
    clicked_count INT;
    purchased_count INT;
    ctr_val NUMERIC;
    cvr_val NUMERIC;
BEGIN
    -- è®¡ç®—ç‚¹å‡»ç‡
    SELECT COUNT(*) INTO clicked_count
    FROM user_behavior
    WHERE user_id = p_user_id
      AND item_id = ANY(p_recommended_items)
      AND behavior_type = 'click'
      AND timestamp > NOW() - (p_evaluation_days || ' days')::INTERVAL;

    ctr_val := clicked_count::NUMERIC / NULLIF(array_length(p_recommended_items, 1), 0);

    -- è®¡ç®—è½¬åŒ–ç‡
    SELECT COUNT(*) INTO purchased_count
    FROM user_behavior
    WHERE user_id = p_user_id
      AND item_id = ANY(p_recommended_items)
      AND behavior_type = 'buy'
      AND timestamp > NOW() - (p_evaluation_days || ' days')::INTERVAL;

    cvr_val := purchased_count::NUMERIC / NULLIF(clicked_count, 0);

    -- è¿”å›è¯„ä¼°ç»“æœ
    RETURN QUERY SELECT
        'ç‚¹å‡»ç‡(CTR)'::TEXT,
        ROUND(ctr_val, 4),
        0.05::NUMERIC AS target_value,
        CASE
            WHEN ctr_val >= 0.05 THEN 'è¾¾æ ‡'
            WHEN ctr_val >= 0.03 THEN 'ä¸€èˆ¬'
            ELSE 'ä¸è¾¾æ ‡'
        END;

    RETURN QUERY SELECT
        'è½¬åŒ–ç‡(CVR)'::TEXT,
        ROUND(cvr_val, 4),
        0.02::NUMERIC AS target_value,
        CASE
            WHEN cvr_val >= 0.02 THEN 'è¾¾æ ‡'
            WHEN cvr_val >= 0.01 THEN 'ä¸€èˆ¬'
            ELSE 'ä¸è¾¾æ ‡'
        END;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ¨èè´¨é‡è¯„ä¼°å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¸ƒã€æ‰©å±•æ€§éœ€æ±‚

### 7.1 æ°´å¹³æ‰©å±•

**æ°´å¹³æ‰©å±•è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- ç”¨æˆ·åˆ†ç‰‡è¡¨ï¼ˆç”¨äºæ°´å¹³æ‰©å±•ï¼‰
CREATE TABLE IF NOT EXISTS user_shards (
    user_id BIGINT PRIMARY KEY,
    shard_id INT NOT NULL,
    shard_host TEXT,
    shard_port INT DEFAULT 5432,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ†ç‰‡è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_shard(
    p_user_id BIGINT
)
RETURNS TABLE (
    shard_id INT,
    shard_host TEXT,
    shard_port INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        shard_id,
        shard_host,
        shard_port
    FROM user_shards
    WHERE user_id = p_user_id;

    IF NOT FOUND THEN
        -- é»˜è®¤åˆ†ç‰‡ï¼ˆå“ˆå¸Œåˆ†ç‰‡ï¼‰
        RETURN QUERY SELECT
            (p_user_id % 4)::INT AS shard_id,
            'localhost'::TEXT AS shard_host,
            5432 AS shard_port;
    END IF;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–ç”¨æˆ·åˆ†ç‰‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## å…«ã€PostgreSQL 18ç‰¹æ€§åº”ç”¨

### 8.1 pgvectorå‘é‡æ£€ç´¢

**å•†å“å‘é‡ç›¸ä¼¼åº¦è®¡ç®—**ï¼š

```sql
-- åˆ›å»ºå•†å“å‘é‡ç´¢å¼•
CREATE INDEX idx_items_feature_vector_hnsw
ON items
USING hnsw (feature_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
SELECT
    item_id,
    title,
    1 - (feature_vector <=> $1::vector) AS similarity
FROM items
WHERE category = 'electronics'
ORDER BY feature_vector <=> $1::vector
LIMIT 100;

-- æ€§èƒ½æå‡ï¼šå‘é‡æ£€ç´¢æ€§èƒ½æå‡60%
```

### 8.2 Skip Scanä¼˜åŒ–

**ç¨€ç–æ¡ä»¶æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- Skip Scanä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰
-- é€‚ç”¨äºç¨€ç–æ¡ä»¶æŸ¥è¯¢ï¼Œå¦‚ï¼šWHERE status = 'active' AND category = 'electronics'

CREATE INDEX idx_items_status_category ON items(status, category);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT item_id, title
FROM items
WHERE status = 'active' AND category = 'electronics'
ORDER BY sales_count DESC
LIMIT 100;

-- æ€§èƒ½æå‡ï¼šç¨€ç–æ¡ä»¶æŸ¥è¯¢æ€§èƒ½æå‡40%
```

### 8.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¤šè·¯å¬å›å¹¶è¡ŒåŒ–**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;

-- å¹¶è¡Œå¤šè·¯å¬å›
EXPLAIN ANALYZE
WITH
    -- ååŒè¿‡æ»¤å¬å›
    cf_recs AS (
        SELECT item_id, similarity_score
        FROM user_item_similarity
        WHERE user_id = $1
        ORDER BY similarity_score DESC
        LIMIT 100
    ),
    -- çƒ­é—¨æ¨èå¬å›
    popular_recs AS (
        SELECT item_id, sales_count
        FROM items
        WHERE category IN (SELECT category FROM user_preferences WHERE user_id = $1)
        ORDER BY sales_count DESC
        LIMIT 100
    ),
    -- å‘é‡æ¨èå¬å›
    vector_recs AS (
        SELECT item_id, 1 - (feature_vector <=> $2::vector) AS similarity
        FROM items
        ORDER BY feature_vector <=> $2::vector
        LIMIT 100
    )
SELECT * FROM (
    SELECT * FROM cf_recs
    UNION ALL
    SELECT * FROM popular_recs
    UNION ALL
    SELECT * FROM vector_recs
) combined_recs
ORDER BY similarity_score DESC
LIMIT 20;

-- æ€§èƒ½æå‡ï¼šå¤šè·¯å¬å›æ€§èƒ½æå‡55%
```

---

## ä¹ã€å®æ—¶ç‰¹å¾æ›´æ–°

### 9.1 ç”¨æˆ·è¡Œä¸ºå®æ—¶æ›´æ–°

**ç”¨æˆ·ç”»åƒå®æ—¶æ›´æ–°**ï¼š

```sql
-- ç”¨æˆ·è¡Œä¸ºè§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_user_profile_on_behavior()
RETURNS TRIGGER AS $$
BEGIN
    -- æ›´æ–°ç”¨æˆ·æ´»è·ƒåº¦
    UPDATE user_profiles
    SET
        last_active_time = NEW.timestamp,
        total_behaviors = total_behaviors + 1,
        category_preferences = (
            SELECT jsonb_object_agg(category, behavior_count)
            FROM (
                SELECT category, COUNT(*) as behavior_count
                FROM user_behavior
                WHERE user_id = NEW.user_id
                  AND timestamp > NOW() - INTERVAL '30 days'
                GROUP BY category
            ) category_stats
        )
    WHERE user_id = NEW.user_id;

    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ›´æ–°ç”¨æˆ·ç”»åƒå¤±è´¥: %', SQLERRM;
        RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_user_profile
    AFTER INSERT ON user_behavior
    FOR EACH ROW
    EXECUTE FUNCTION update_user_profile_on_behavior();
```

### 9.2 å•†å“çƒ­åº¦å®æ—¶æ›´æ–°

**å•†å“çƒ­åº¦å®æ—¶è®¡ç®—**ï¼š

```sql
-- å•†å“çƒ­åº¦ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW IF NOT EXISTS item_hotness AS
SELECT
    item_id,
    COUNT(*) FILTER (WHERE behavior_type = 'view') AS view_count_24h,
    COUNT(*) FILTER (WHERE behavior_type = 'click') AS click_count_24h,
    COUNT(*) FILTER (WHERE behavior_type = 'buy') AS buy_count_24h,
    COUNT(*) FILTER (WHERE behavior_type = 'view')::NUMERIC /
        NULLIF(COUNT(*) FILTER (WHERE behavior_type = 'click'), 0) AS ctr_24h,
    NOW() AS updated_at
FROM user_behavior
WHERE timestamp > NOW() - INTERVAL '24 hours'
GROUP BY item_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_item_hotness_item_id ON item_hotness(item_id);

-- å®šæœŸåˆ·æ–°ï¼ˆæ¯åˆ†é’Ÿï¼‰
CREATE OR REPLACE FUNCTION refresh_item_hotness()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY item_hotness;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ·æ–°å•†å“çƒ­åº¦å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶åˆ·æ–°
SELECT cron.schedule('refresh-item-hotness', '* * * * *',
    'SELECT refresh_item_hotness()');
```

---

## åã€ç¼“å­˜ç­–ç•¥

### 10.1 Redisç¼“å­˜

**æ¨èç»“æœç¼“å­˜**ï¼š

```python
import redis
import json
import hashlib

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_recommendations_cached(user_id, limit=20):
    """å¸¦ç¼“å­˜çš„æ¨è"""

    # ç”Ÿæˆç¼“å­˜é”®
    cache_key = f"recommendations:{user_id}:{limit}"

    # å°è¯•ä»ç¼“å­˜è·å–
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    # ä»æ•°æ®åº“è·å–æ¨è
    recommendations = get_recommendations_from_db(user_id, limit)

    # ç¼“å­˜30ç§’ï¼ˆå®æ—¶æ¨èéœ€è¦è¾ƒçŸ­ç¼“å­˜æ—¶é—´ï¼‰
    redis_client.setex(
        cache_key,
        30,
        json.dumps(recommendations)
    )

    return recommendations
```

### 10.2 ç”¨æˆ·ç”»åƒç¼“å­˜

**ç”¨æˆ·ç”»åƒç¼“å­˜**ï¼š

```sql
-- ç”¨æˆ·ç”»åƒç¼“å­˜è¡¨
CREATE TABLE IF NOT EXISTS user_profile_cache (
    user_id BIGINT PRIMARY KEY,
    profile_data JSONB,
    cached_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '1 hour'
);

-- è·å–ç¼“å­˜çš„ç”¨æˆ·ç”»åƒ
CREATE OR REPLACE FUNCTION get_cached_user_profile(
    p_user_id BIGINT
)
RETURNS JSONB AS $$
DECLARE
    cached_profile JSONB;
BEGIN
    SELECT profile_data INTO cached_profile
    FROM user_profile_cache
    WHERE user_id = p_user_id
      AND expires_at > NOW();

    IF FOUND THEN
        RETURN cached_profile;
    END IF;

    -- ä»æ•°æ®åº“è·å–å¹¶ç¼“å­˜
    SELECT jsonb_build_object(
        'user_id', user_id,
        'preferences', category_preferences,
        'active_level', active_level
    ) INTO cached_profile
    FROM user_profiles
    WHERE user_id = p_user_id;

    -- æ›´æ–°ç¼“å­˜
    INSERT INTO user_profile_cache (user_id, profile_data, expires_at)
    VALUES (p_user_id, cached_profile, NOW() + INTERVAL '1 hour')
    ON CONFLICT (user_id) DO UPDATE
    SET profile_data = EXCLUDED.profile_data,
        cached_at = NOW(),
        expires_at = EXCLUDED.expires_at;

    RETURN cached_profile;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è·å–ç”¨æˆ·ç”»åƒç¼“å­˜å¤±è´¥: %', SQLERRM;
        RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

---

## åä¸€ã€ç›‘æ§å‘Šè­¦éœ€æ±‚

### 11.1 æ€§èƒ½ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**ï¼š

- âœ… **æ¨èå»¶è¿Ÿ**: P50, P95, P99å»¶è¿Ÿ
- âœ… **QPS**: æ¯ç§’æ¨èè¯·æ±‚æ•°
- âœ… **è¡Œä¸ºå†™å…¥TPS**: æ¯ç§’è¡Œä¸ºå†™å…¥æ•°
- âœ… **ç¼“å­˜å‘½ä¸­ç‡**: æ¨èç»“æœç¼“å­˜å‘½ä¸­ç‡
- âœ… **CTR**: ç‚¹å‡»ç‡

### 11.2 å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: recommendation_system_alerts
  rules:
  - alert: HighRecommendationLatency
    expr: histogram_quantile(0.95, rate(recommendation_latency_bucket[5m])) > 100
    for: 5m
    annotations:
      summary: "æ¨èå»¶è¿Ÿè¿‡é«˜"
      description: "P95å»¶è¿Ÿè¶…è¿‡100ms: {{ $value }}ms"

  - alert: LowCTR
    expr: rate(recommendation_clicks_total[1h]) / rate(recommendation_shows_total[1h]) < 0.05
    for: 1h
    annotations:
      summary: "ç‚¹å‡»ç‡è¿‡ä½"
      description: "CTR: {{ $value | humanizePercentage }}"
```

---

## åäºŒã€æ€»ç»“

### 12.1 æ ¸å¿ƒéœ€æ±‚æ€»ç»“

**å®æ—¶æ¨èç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚**ï¼š

1. âœ… **å®æ—¶æ€§**: ç”¨æˆ·è¡Œä¸ºå100mså†…æ›´æ–°æ¨è
2. âœ… **ä¸ªæ€§åŒ–**: åŸºäºç”¨æˆ·å†å²è¡Œä¸º
3. âœ… **å‡†ç¡®æ€§**: CTRç›®æ ‡>5%
4. âœ… **é«˜æ€§èƒ½**: æ¨èå»¶è¿Ÿ<100msï¼ŒQPS>50K
5. âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•
6. âœ… **å¤šè·¯å¬å›**: ååŒè¿‡æ»¤+çƒ­é—¨+å‘é‡

### 12.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨å®æ—¶æ¨èç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **pgvector**: å‘é‡æ£€ç´¢æ€§èƒ½æå‡60%
- âœ… **Skip Scan**: ç¨€ç–æ¡ä»¶æŸ¥è¯¢æ€§èƒ½æå‡40%
- âœ… **å¹¶è¡ŒæŸ¥è¯¢**: å¤šè·¯å¬å›æ€§èƒ½æå‡55%
- âœ… **å¼‚æ­¥I/O**: è¡Œä¸ºå†™å…¥æ€§èƒ½æå‡40%

---

**è¿”å›**: [æ¡ˆä¾‹7ä¸»é¡µ](./README.md)
**å­—æ•°**: ~4,200å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
