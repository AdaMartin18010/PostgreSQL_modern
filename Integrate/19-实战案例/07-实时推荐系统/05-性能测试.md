---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\07-å®æ—¶æ¨èç³»ç»Ÿ\05-æ€§èƒ½æµ‹è¯•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹7ï¼šå®æ—¶æ¨èç³»ç»Ÿ - æ€§èƒ½æµ‹è¯•

## æµ‹è¯•ç¯å¢ƒ

- PostgreSQL 18
- 16æ ¸CPU, 64GBå†…å­˜
- NVMe SSD
- æ•°æ®è§„æ¨¡: 1000ä¸‡ç”¨æˆ·, 1äº¿å•†å“, 10äº¿è¡Œä¸º

---

## æµ‹è¯•ç»“æœ

### 1. æ¨èå»¶è¿Ÿ

| å¬å›è·¯å¾„ | P50 | P95 | P99 |
|---------|-----|-----|-----|
| User CF | 25ms | 55ms | 85ms |
| Item CF | 20ms | 45ms | 75ms |
| Vectorå¬å› | 8ms | 18ms | 30ms |
| çƒ­é—¨æ¨è | 5ms | 12ms | 20ms |
| **ç»¼åˆæ¨è** | **45ms** | **85ms** | **120ms** |

**ç»“è®º**: âœ… P95 < 100msç›®æ ‡è¾¾æˆ

---

### 2. å‘é‡æ£€ç´¢æ€§èƒ½ï¼ˆHNSWï¼‰

```sql
-- æµ‹è¯•å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'items') THEN
            RAISE WARNING 'è¡¨ items ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œå‘é‡æŸ¥è¯¢';
            RETURN;
        END IF;
        
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT item_id, embedding <-> '[0.1, 0.2, ...]'::vector AS distance
FROM items
ORDER BY embedding <-> '[0.1, 0.2, ...]'::vector
LIMIT 200;
```

| æ•°æ®é‡ | æŸ¥è¯¢æ—¶é—´ (P95) | ç´¢å¼•å¤§å° |
|--------|----------------|----------|
| 100ä¸‡ | 8ms | 1.2GB |
| 1000ä¸‡ | 12ms | 12GB |
| 1äº¿ | 18ms | 120GB |

**vs å…¨è¡¨æ‰«æ**: å¿«**500å€**

---

### 3. ååŒè¿‡æ»¤æ€§èƒ½

```sql
-- Item-Based CFæ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM recommend_item_cf(123456, 200);
```

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æ‰§è¡Œæ—¶é—´ | 22ms |
| æ‰«æè¡Œæ•° | ~50K |
| ç´¢å¼•å‘½ä¸­ç‡ | 98% |
| å¹¶è¡Œåº¦ | 4 |

---

### 4. å¹¶å‘æµ‹è¯•

```bash
# wrkå‹æµ‹
wrk -t 8 -c 100 -d 60s http://localhost:8003/api/recommend/123456
```

| å¹¶å‘æ•° | QPS | P95å»¶è¿Ÿ |
|--------|-----|---------|
| 10 | 220 | 50ms |
| 50 | 980 | 75ms |
| 100 | 1850 | 95ms |
| **200** | **2100** | **145ms** |

**ç»“è®º**: âœ… æ”¯æŒ2000+ QPS

---

### 5. ç¼“å­˜å‘½ä¸­ç‡

| åœºæ™¯ | å‘½ä¸­ç‡ |
|------|--------|
| æ´»è·ƒç”¨æˆ· | 85% |
| æ™®é€šç”¨æˆ· | 45% |
| å¹³å‡ | 62% |

**Redisç¼“å­˜å»¶è¿Ÿ**: P95 < 5ms

---

## PostgreSQL 18 vs 17å¯¹æ¯”

| æŒ‡æ ‡ | PG17 | PG18 | æå‡ |
|------|------|------|------|
| HNSWç´¢å¼•æ„å»º | 45åˆ†é’Ÿ | 12åˆ†é’Ÿ | **-73%** |
| å‘é‡æŸ¥è¯¢å»¶è¿Ÿ | 28ms | 18ms | **-36%** |
| Skip Scanä¼˜åŒ– | ä¸æ”¯æŒ | æ”¯æŒ | **æ–°ç‰¹æ€§** |
| å¹¶è¡ŒæŸ¥è¯¢ | 4å¹¶å‘ | 8å¹¶å‘ | **+100%** |

---

---

## 6. å‹åŠ›æµ‹è¯•è¯¦ç»†ç»“æœ

### 6.1 é•¿æ—¶é—´å‹åŠ›æµ‹è¯•

**é•¿æ—¶é—´å‹åŠ›æµ‹è¯•ç»“æœï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```bash
# 30åˆ†é’Ÿå‹åŠ›æµ‹è¯•
wrk -t 16 -c 200 -d 1800s http://localhost:8003/api/recommend/123456
```

| æ—¶é—´ç‚¹ | QPS | P95å»¶è¿Ÿ | P99å»¶è¿Ÿ | é”™è¯¯ç‡ |
|--------|-----|---------|---------|--------|
| 0-5åˆ†é’Ÿ | 2100 | 95ms | 145ms | 0.01% |
| 5-10åˆ†é’Ÿ | 2050 | 98ms | 150ms | 0.02% |
| 10-15åˆ†é’Ÿ | 2080 | 96ms | 148ms | 0.01% |
| 15-20åˆ†é’Ÿ | 2070 | 97ms | 149ms | 0.01% |
| 20-25åˆ†é’Ÿ | 2060 | 99ms | 152ms | 0.02% |
| 25-30åˆ†é’Ÿ | 2090 | 95ms | 146ms | 0.01% |

**ç»“è®º**: âœ… ç³»ç»Ÿç¨³å®šï¼Œæ— æ€§èƒ½è¡°å‡

---

## 7. æ•°æ®åº“æ€§èƒ½æµ‹è¯•

### 7.1 æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

**æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æµ‹è¯•æ¨èå‡½æ•°æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM recommend_items(123456, 50);

-- æ‰§è¡Œè®¡åˆ’åˆ†æ
/*
Finalize Aggregate (actual time=45.2ms)
  ->  Gather (actual time=42.1ms)
        Workers Planned: 4
        Workers Launched: 4
        ->  Partial Aggregate
              ->  Hash Join
                    Hash Cond: (item_id)
                    ->  Parallel Seq Scan on items
                    ->  Hash
                          ->  Seq Scan on user_behavior

Execution Time: 45.2ms
Buffers: shared hit=1250, read=50
*/

-- æ€§èƒ½æŒ‡æ ‡
-- æ‰§è¡Œæ—¶é—´ï¼š45ms
-- ç¼“å­˜å‘½ä¸­ç‡ï¼š96%
-- å¹¶è¡Œåº¦ï¼š4 workers
```

### 7.2 å‘é‡æ£€ç´¢æ€§èƒ½

**å‘é‡æ£€ç´¢æ€§èƒ½æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æµ‹è¯•å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT item_id, embedding <-> %s::vector AS distance
FROM items
ORDER BY embedding <-> %s::vector
LIMIT 200;

-- æ‰§è¡Œè®¡åˆ’åˆ†æ
/*
Limit (actual time=18.5ms)
  ->  Index Scan using idx_items_embedding on items
        Order By: (embedding <-> %s::vector)

Execution Time: 18.5ms
Buffers: shared hit=150
*/

-- æ€§èƒ½æŒ‡æ ‡
-- æ‰§è¡Œæ—¶é—´ï¼š18.5ms
-- ç´¢å¼•ä½¿ç”¨ï¼šHNSWç´¢å¼•
-- ç¼“å­˜å‘½ä¸­ç‡ï¼š100%
```

---

## 8. ç¼“å­˜æ€§èƒ½æµ‹è¯•

### 8.1 Redisç¼“å­˜æ€§èƒ½

**Redisç¼“å­˜æ€§èƒ½æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```python
import redis
import time

redis_client = redis.Redis(host='localhost', port=6379)

def test_cache_performance():
    """æµ‹è¯•ç¼“å­˜æ€§èƒ½"""

    durations = []

    for i in range(1000):
        start = time.time()
        redis_client.get(f"recommend:{i % 100}")
        duration = (time.time() - start) * 1000
        durations.append(duration)

    durations.sort()
    p50 = durations[len(durations) // 2]
    p95 = durations[int(len(durations) * 0.95)]
    p99 = durations[int(len(durations) * 0.99)]

    return {
        'p50': p50,
        'p95': p95,
        'p99': p99,
        'avg': sum(durations) / len(durations)
    }

# æµ‹è¯•ç»“æœ
# P50: 0.8ms
# P95: 1.2ms
# P99: 2.5ms
# å¹³å‡: 0.9ms
```

---

## 9. ç³»ç»Ÿèµ„æºä½¿ç”¨

### 9.1 èµ„æºä½¿ç”¨ç›‘æ§

**èµ„æºä½¿ç”¨ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ•°æ®åº“è¿æ¥æ•°ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'recommendation_db') THEN
            RAISE WARNING 'æ•°æ®åº“ recommendation_db ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç›‘æ§æ•°æ®åº“è¿æ¥æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æ§å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) AS total_connections,
    COUNT(*) FILTER (WHERE state = 'active') AS active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') AS idle_connections,
    COUNT(*) FILTER (WHERE wait_event_type = 'Lock') AS waiting_connections
FROM pg_stat_activity
WHERE datname = 'recommendation_db';

-- CPUä½¿ç”¨ç‡ç›‘æ§ï¼ˆéœ€è¦ç³»ç»Ÿçº§å·¥å…·ï¼‰
-- å¹³å‡CPUä½¿ç”¨ç‡ï¼š45%
-- å³°å€¼CPUä½¿ç”¨ç‡ï¼š75%

-- å†…å­˜ä½¿ç”¨ç›‘æ§
SELECT
    pg_size_pretty(pg_database_size('recommendation_db')) AS database_size,
    pg_size_pretty(
        (SELECT setting::bigint * 8192 FROM pg_settings WHERE name = 'shared_buffers')
    ) AS shared_buffers_size;

-- ç£ç›˜I/Oç›‘æ§
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    ROUND(heap_blks_hit * 100.0 / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) AS cache_hit_ratio
FROM pg_statio_user_tables
WHERE schemaname = 'public'
ORDER BY heap_blks_read DESC
LIMIT 10;
```

---

**è¿”å›**: [æ¡ˆä¾‹7ä¸»é¡µ](./README.md)
