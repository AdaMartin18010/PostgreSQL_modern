---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\10-é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ\04-æ ¸å¿ƒå®ç°.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ - æ ¸å¿ƒå®ç°

> **æ¡ˆä¾‹ç±»å‹**: å®æ—¶æ¬ºè¯ˆæ£€æµ‹ç³»ç»Ÿ
> **éš¾åº¦ç­‰çº§**: â­â­â­â­â­
> **PostgreSQLç‰ˆæœ¬**: 18.x
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ

---

## ğŸ“‹ ç›®å½•

- [é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ - æ ¸å¿ƒå®ç°](#é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ---æ ¸å¿ƒå®ç°)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ ¸å¿ƒæ£€æµ‹å‡½æ•°](#ä¸€æ ¸å¿ƒæ£€æµ‹å‡½æ•°)
    - [1.1 ä¸»æ£€æµ‹å‡½æ•° (detect\_fraud)](#11-ä¸»æ£€æµ‹å‡½æ•°-detect_fraud)
  - [äºŒã€è§„åˆ™å¼•æ“å®ç°](#äºŒè§„åˆ™å¼•æ“å®ç°)
    - [2.1 è§„åˆ™åŒ¹é…å‡½æ•° (match\_rules)](#21-è§„åˆ™åŒ¹é…å‡½æ•°-match_rules)
    - [2.2 è§„åˆ™æ¡ä»¶è¯„ä¼°å‡½æ•° (evaluate\_rule\_conditions)](#22-è§„åˆ™æ¡ä»¶è¯„ä¼°å‡½æ•°-evaluate_rule_conditions)
  - [ä¸‰ã€ç‰¹å¾æå–å‡½æ•°](#ä¸‰ç‰¹å¾æå–å‡½æ•°)
    - [3.1 ä¸»ç‰¹å¾æå–å‡½æ•° (extract\_features)](#31-ä¸»ç‰¹å¾æå–å‡½æ•°-extract_features)
    - [3.2 ç”¨æˆ·ç‰¹å¾æå– (extract\_user\_features)](#32-ç”¨æˆ·ç‰¹å¾æå–-extract_user_features)
    - [3.3 è®¾å¤‡ç‰¹å¾æå– (extract\_device\_features)](#33-è®¾å¤‡ç‰¹å¾æå–-extract_device_features)
    - [3.4 ç‰¹å¾æ›´æ–°å‡½æ•° (update\_user\_features)](#34-ç‰¹å¾æ›´æ–°å‡½æ•°-update_user_features)
  - [å››ã€å†³ç­–èåˆå‡½æ•°](#å››å†³ç­–èåˆå‡½æ•°)
    - [4.1 èåˆå†³ç­–å‡½æ•° (fuse\_decision)](#41-èåˆå†³ç­–å‡½æ•°-fuse_decision)
  - [äº”ã€è¾…åŠ©å‡½æ•°](#äº”è¾…åŠ©å‡½æ•°)
    - [5.1 è§„åˆ™å‘½ä¸­ç»Ÿè®¡æ›´æ–°](#51-è§„åˆ™å‘½ä¸­ç»Ÿè®¡æ›´æ–°)
    - [5.2 è§„åˆ™ç®¡ç†å‡½æ•°](#52-è§„åˆ™ç®¡ç†å‡½æ•°)
    - [5.3 å®¡è®¡æ—¥å¿—è®°å½•](#53-å®¡è®¡æ—¥å¿—è®°å½•)
  - [å…­ã€ä½¿ç”¨ç¤ºä¾‹](#å…­ä½¿ç”¨ç¤ºä¾‹)
    - [6.1 æ£€æµ‹å•ç¬”äº¤æ˜“](#61-æ£€æµ‹å•ç¬”äº¤æ˜“)
    - [6.2 åˆ›å»ºè§„åˆ™](#62-åˆ›å»ºè§„åˆ™)
    - [6.3 æŸ¥è¯¢æ£€æµ‹ç»“æœ](#63-æŸ¥è¯¢æ£€æµ‹ç»“æœ)
  - [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–](#ä¸ƒæ€§èƒ½ä¼˜åŒ–)
    - [7.1 å‡½æ•°ä¼˜åŒ–æŠ€å·§](#71-å‡½æ•°ä¼˜åŒ–æŠ€å·§)
    - [7.2 PostgreSQL 18ç‰¹æ€§åº”ç”¨](#72-postgresql-18ç‰¹æ€§åº”ç”¨)
  - [å…«ã€PostgreSQL 18åæ¬ºè¯ˆä¼˜åŒ–](#å…«postgresql-18åæ¬ºè¯ˆä¼˜åŒ–)
    - [8.1 å¼‚æ­¥I/Oä¼˜åŒ–](#81-å¼‚æ­¥ioä¼˜åŒ–)
    - [8.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#82-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
  - [ä¹ã€åæ¬ºè¯ˆç³»ç»Ÿç›‘æ§](#ä¹åæ¬ºè¯ˆç³»ç»Ÿç›‘æ§)
    - [9.1 æ£€æµ‹æ€§èƒ½ç›‘æ§](#91-æ£€æµ‹æ€§èƒ½ç›‘æ§)
    - [9.2 è§„åˆ™å‘½ä¸­ç›‘æ§](#92-è§„åˆ™å‘½ä¸­ç›‘æ§)
  - [åã€åæ¬ºè¯ˆç³»ç»Ÿæœ€ä½³å®è·µ](#ååæ¬ºè¯ˆç³»ç»Ÿæœ€ä½³å®è·µ)
    - [10.1 è§„åˆ™è®¾è®¡æœ€ä½³å®è·µ](#101-è§„åˆ™è®¾è®¡æœ€ä½³å®è·µ)
    - [10.2 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#102-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)

---

## ä¸€ã€æ ¸å¿ƒæ£€æµ‹å‡½æ•°

### 1.1 ä¸»æ£€æµ‹å‡½æ•° (detect_fraud)

```sql
-- æ¬ºè¯ˆæ£€æµ‹ä¸»å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION detect_fraud(
    p_user_id BIGINT,
    p_amount NUMERIC,
    p_merchant_id BIGINT,
    p_device_id VARCHAR(100),
    p_ip_address INET
) RETURNS TABLE (
    risk_score NUMERIC,
    final_decision VARCHAR(20),
    decision_reason TEXT,
    matched_rules JSONB
) AS $$
DECLARE
    v_transaction_id BIGINT;
    v_rule_score NUMERIC := 0;
    v_ml_score NUMERIC := 0;
    v_final_score NUMERIC;
    v_decision VARCHAR(20);
    v_reason TEXT;
    v_matched_rules JSONB := '[]'::jsonb;
    v_features JSONB;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_amount IS NULL OR p_amount <= 0 THEN
            RAISE EXCEPTION 'amountå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'detection_results') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;

        -- 1. åˆ›å»ºäº¤æ˜“è®°å½•
    INSERT INTO transactions (
        user_id, amount, merchant_id, device_id, ip_address, status
    ) VALUES (
        p_user_id, p_amount, p_merchant_id, p_device_id, p_ip_address, 'pending'
    )
    RETURNING transaction_id INTO v_transaction_id;

    -- 2. æå–ç‰¹å¾
    v_features := extract_features(p_user_id, p_device_id);

    -- 3. è§„åˆ™å¼•æ“åŒ¹é…ï¼ˆå¼‚æ­¥I/Oæ‰¹é‡æŸ¥è¯¢ï¼‰
    SELECT
        COALESCE(SUM(score), 0),
        jsonb_agg(rule_info)
    INTO
        v_rule_score,
        v_matched_rules
    FROM match_rules(p_user_id, p_amount, p_merchant_id, p_device_id, v_features);

    -- 4. MLæ¨¡å‹è¯„åˆ†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    -- v_ml_score := ml_predict_fraud(v_features);

    -- 5. å†³ç­–èåˆ
    v_final_score := (v_rule_score * 0.6) + (COALESCE(v_ml_score, 0) * 0.4);
    v_decision := CASE
        WHEN v_final_score >= 80 THEN 'reject'
        WHEN v_final_score >= 60 THEN 'review'
        ELSE 'pass'
    END;
    v_reason := format('è§„åˆ™åˆ†æ•°: %s, MLåˆ†æ•°: %s, æœ€ç»ˆåˆ†æ•°: %s',
                       v_rule_score, v_ml_score, v_final_score);

    -- 6. è®°å½•æ£€æµ‹ç»“æœ
    INSERT INTO detection_results (
        transaction_id, risk_score, final_decision, decision_reason,
        matched_rules, rule_score, ml_score, feature_snapshot
    ) VALUES (
        v_transaction_id, v_final_score, v_decision, v_reason,
        v_matched_rules, v_rule_score, v_ml_score, v_features
    );

    -- 7. æ›´æ–°äº¤æ˜“çŠ¶æ€
    UPDATE transactions
    SET status = CASE
        WHEN v_decision = 'reject' THEN 'failed'
        ELSE 'success'
    END,
    completed_at = CURRENT_TIMESTAMP
    WHERE transaction_id = v_transaction_id;

        -- 8. è¿”å›ç»“æœ
        RETURN QUERY SELECT
            v_final_score,
            v_decision,
            v_reason,
            v_matched_rules;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¬ºè¯ˆæ£€æµ‹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## äºŒã€è§„åˆ™å¼•æ“å®ç°

### 2.1 è§„åˆ™åŒ¹é…å‡½æ•° (match_rules)

```sql
-- è§„åˆ™åŒ¹é…å‡½æ•°ï¼ˆæ‰¹é‡åŒ¹é…ï¼‰
CREATE OR REPLACE FUNCTION match_rules(
    p_user_id BIGINT,
    p_amount NUMERIC,
    p_merchant_id BIGINT,
    p_device_id VARCHAR(100),
    p_features JSONB
) RETURNS TABLE (
    rule_id VARCHAR(50),
    rule_name VARCHAR(200),
    score NUMERIC,
    reason TEXT,
    rule_info JSONB
) AS $$
BEGIN
    RETURN QUERY
    WITH matched AS (
        SELECT
            fr.rule_id,
            fr.rule_name,
            (fr.actions->>'score')::NUMERIC as score,
            fr.actions->>'reason' as reason,
            jsonb_build_object(
                'rule_id', fr.rule_id,
                'rule_name', fr.rule_name,
                'score', (fr.actions->>'score')::NUMERIC,
                'reason', fr.actions->>'reason'
            ) as rule_info
        FROM fraud_rules fr
        WHERE fr.is_active = true
          AND evaluate_rule_conditions(fr.conditions, p_user_id, p_amount,
                                      p_merchant_id, p_device_id, p_features)
            ORDER BY fr.priority DESC
        )
        SELECT * FROM matched;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§„åˆ™åŒ¹é…å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 2.2 è§„åˆ™æ¡ä»¶è¯„ä¼°å‡½æ•° (evaluate_rule_conditions)

```sql
-- è§„åˆ™æ¡ä»¶è¯„ä¼°å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION evaluate_rule_conditions(
    p_conditions JSONB,
    p_user_id BIGINT,
    p_amount NUMERIC,
    p_merchant_id BIGINT,
    p_device_id VARCHAR(100),
    p_features JSONB
) RETURNS BOOLEAN AS $$
DECLARE
    v_result BOOLEAN := true;
    v_condition JSONB;
BEGIN
    BEGIN
        IF p_conditions IS NULL THEN
            RETURN false;
        END IF;

        -- é‡‘é¢æ¡ä»¶
    IF p_conditions ? 'amount' THEN
        v_condition := p_conditions->'amount';
        IF v_condition ? '$gt' THEN
            v_result := v_result AND (p_amount > (v_condition->>'$gt')::NUMERIC);
        END IF;
        IF v_condition ? '$lt' THEN
            v_result := v_result AND (p_amount < (v_condition->>'$lt')::NUMERIC);
        END IF;
    END IF;

    -- æ—¶é—´æ¡ä»¶
    IF p_conditions ? 'time' THEN
        v_condition := p_conditions->'time';
        IF v_condition ? 'hour' THEN
            v_result := v_result AND (EXTRACT(HOUR FROM NOW()) = ANY(
                ARRAY(SELECT jsonb_array_elements_text(v_condition->'hour'))::INT[]
            ));
        END IF;
    END IF;

    -- è®¾å¤‡æ¡ä»¶
    IF p_conditions ? 'device' THEN
        v_condition := p_conditions->'device';
        IF v_condition ? 'new_device' AND (v_condition->>'new_device')::BOOLEAN THEN
            v_result := v_result AND (
                SELECT COUNT(*) = 0
                FROM transactions
                WHERE device_id = p_device_id
                  AND created_at >= NOW() - INTERVAL '7 days'
            );
        END IF;
    END IF;

    -- ç”¨æˆ·ç‰¹å¾æ¡ä»¶
    IF p_conditions ? 'user_features' THEN
        v_condition := p_conditions->'user_features';
        IF v_condition ? 'tx_count_24h' THEN
            v_result := v_result AND (
                (p_features->>'tx_count_24h')::INT >=
                (v_condition->>'tx_count_24h')::INT
            );
        END IF;
        END IF;

        RETURN v_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§„åˆ™æ¡ä»¶è¯„ä¼°å¤±è´¥: %', SQLERRM;
            RETURN false;
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

---

## ä¸‰ã€ç‰¹å¾æå–å‡½æ•°

### 3.1 ä¸»ç‰¹å¾æå–å‡½æ•° (extract_features)

```sql
-- ç‰¹å¾æå–å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION extract_features(
    p_user_id BIGINT,
    p_device_id VARCHAR(100)
) RETURNS JSONB AS $$
DECLARE
    v_features JSONB;
    v_user_features JSONB;
    v_device_features JSONB;
BEGIN
    BEGIN
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        -- æå–ç”¨æˆ·ç‰¹å¾
    v_user_features := extract_user_features(p_user_id);

    -- æå–è®¾å¤‡ç‰¹å¾
    v_device_features := extract_device_features(p_device_id);

    -- åˆå¹¶ç‰¹å¾
    v_features := jsonb_build_object(
        'user_features', v_user_features,
        'device_features', v_device_features,
            'timestamp', EXTRACT(EPOCH FROM NOW())
        );

        RETURN v_features;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç‰¹å¾æå–å¤±è´¥: %', SQLERRM;
            RETURN '{}'::jsonb;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 ç”¨æˆ·ç‰¹å¾æå– (extract_user_features)

```sql
-- ç”¨æˆ·ç‰¹å¾æå–ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION extract_user_features(
    p_user_id BIGINT
) RETURNS JSONB AS $$
DECLARE
    v_features JSONB;
BEGIN
    BEGIN
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_features') THEN
            RAISE WARNING 'è¡¨ user_features ä¸å­˜åœ¨';
            RETURN '{}'::jsonb;
        END IF;

        SELECT jsonb_build_object(
        'tx_count_1h', COALESCE(tx_count_1h, 0),
        'tx_amount_1h', COALESCE(tx_amount_1h, 0),
        'tx_count_24h', COALESCE(tx_count_24h, 0),
        'tx_amount_24h', COALESCE(tx_amount_24h, 0),
        'tx_count_7d', COALESCE(tx_count_7d, 0),
        'avg_amount_24h', COALESCE(avg_amount_24h, 0),
        'top_merchants', COALESCE(top_merchants, '[]'::jsonb)
    )
    INTO v_features
    FROM user_features
    WHERE user_id = p_user_id;

    -- å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤å€¼
    IF v_features IS NULL THEN
        v_features := jsonb_build_object(
            'tx_count_1h', 0,
            'tx_amount_1h', 0,
            'tx_count_24h', 0,
            'tx_amount_24h', 0,
            'tx_count_7d', 0,
            'avg_amount_24h', 0,
                'top_merchants', '[]'::jsonb
            );
        END IF;

        RETURN v_features;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·ç‰¹å¾æå–å¤±è´¥: %', SQLERRM;
            RETURN '{}'::jsonb;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 è®¾å¤‡ç‰¹å¾æå– (extract_device_features)

```sql
-- è®¾å¤‡ç‰¹å¾æå–ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION extract_device_features(
    p_device_id VARCHAR(100)
) RETURNS JSONB AS $$
DECLARE
    v_features JSONB;
BEGIN
    BEGIN
        IF p_device_id IS NULL OR p_device_id = '' THEN
            RAISE EXCEPTION 'device_idä¸èƒ½ä¸ºç©º';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'device_features') THEN
            RAISE WARNING 'è¡¨ device_features ä¸å­˜åœ¨';
            RETURN '{}'::jsonb;
        END IF;

        SELECT jsonb_build_object(
        'user_count', COALESCE(user_count, 0),
        'tx_count_24h', COALESCE(tx_count_24h, 0),
        'tx_amount_24h', COALESCE(tx_amount_24h, 0),
        'risk_score', COALESCE(risk_score, 0),
        'is_blacklisted', COALESCE(is_blacklisted, false),
        'first_seen', first_seen,
        'last_seen', last_seen
    )
    INTO v_features
    FROM device_features
    WHERE device_id = p_device_id;

    -- å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
    IF v_features IS NULL THEN
        INSERT INTO device_features (device_id, first_seen, last_seen)
        VALUES (p_device_id, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        ON CONFLICT (device_id) DO NOTHING;

        v_features := jsonb_build_object(
            'user_count', 0,
            'tx_count_24h', 0,
            'tx_amount_24h', 0,
            'risk_score', 0,
            'is_blacklisted', false,
            'first_seen', CURRENT_TIMESTAMP,
                'last_seen', CURRENT_TIMESTAMP
            );
        END IF;

        RETURN v_features;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾å¤‡ç‰¹å¾æå–å¤±è´¥: %', SQLERRM;
            RETURN '{}'::jsonb;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 3.4 ç‰¹å¾æ›´æ–°å‡½æ•° (update_user_features)

```sql
-- ç”¨æˆ·ç‰¹å¾æ›´æ–°ï¼ˆæ–°äº¤æ˜“å®Œæˆåè°ƒç”¨ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_user_features(
    p_user_id BIGINT,
    p_amount NUMERIC,
    p_merchant_id BIGINT
) RETURNS VOID AS $$
BEGIN
    BEGIN
        IF p_user_id IS NULL THEN
            RAISE EXCEPTION 'user_idä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_amount IS NULL OR p_amount <= 0 THEN
            RAISE EXCEPTION 'amountå¿…é¡»å¤§äº0';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_features') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE EXCEPTION 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        END IF;

        -- ä½¿ç”¨UPSERTæ›´æ–°ç‰¹å¾
    INSERT INTO user_features (
        user_id,
        tx_count_1h, tx_amount_1h,
        tx_count_24h, tx_amount_24h,
        tx_count_7d, avg_amount_24h,
        last_updated
    )
    SELECT
        p_user_id,
        COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '1 hour'),
        COALESCE(SUM(amount) FILTER (WHERE created_at >= NOW() - INTERVAL '1 hour'), 0),
        COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours'),
        COALESCE(SUM(amount) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours'), 0),
        COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days'),
        COALESCE(AVG(amount) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours'), 0),
        CURRENT_TIMESTAMP
    FROM transactions
    WHERE user_id = p_user_id
    GROUP BY user_id
    ON CONFLICT (user_id) DO UPDATE SET
        tx_count_1h = EXCLUDED.tx_count_1h,
        tx_amount_1h = EXCLUDED.tx_amount_1h,
        tx_count_24h = EXCLUDED.tx_count_24h,
        tx_amount_24h = EXCLUDED.tx_amount_24h,
            tx_count_7d = EXCLUDED.tx_count_7d,
            avg_amount_24h = EXCLUDED.avg_amount_24h,
            last_updated = EXCLUDED.last_updated;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ç”¨æˆ·ç‰¹å¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

---

## å››ã€å†³ç­–èåˆå‡½æ•°

### 4.1 èåˆå†³ç­–å‡½æ•° (fuse_decision)

```sql
-- å†³ç­–èåˆå‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION fuse_decision(
    p_rule_score NUMERIC,
    p_ml_score NUMERIC DEFAULT NULL,
    p_rule_weight NUMERIC DEFAULT 0.6,
    p_ml_weight NUMERIC DEFAULT 0.4
) RETURNS TABLE (
    final_score NUMERIC,
    decision VARCHAR(20),
    reason TEXT
) AS $$
DECLARE
    v_final_score NUMERIC;
    v_decision VARCHAR(20);
    v_reason TEXT;
BEGIN
    BEGIN
        IF p_rule_score IS NULL THEN
            RAISE EXCEPTION 'rule_scoreä¸èƒ½ä¸ºNULL';
        END IF;

        IF p_rule_weight < 0 OR p_rule_weight > 1 OR p_ml_weight < 0 OR p_ml_weight > 1 THEN
            RAISE EXCEPTION 'æƒé‡å¿…é¡»åœ¨0-1ä¹‹é—´';
        END IF;

        -- è®¡ç®—èåˆåˆ†æ•°
    v_final_score := (p_rule_score * p_rule_weight) +
                     (COALESCE(p_ml_score, 0) * p_ml_weight);

    -- å†³ç­–é€»è¾‘
    v_decision := CASE
        WHEN v_final_score >= 80 THEN 'reject'
        WHEN v_final_score >= 60 THEN 'review'
        ELSE 'pass'
    END;

    -- ç”ŸæˆåŸå› 
    v_reason := format(
        'è§„åˆ™åˆ†æ•°: %s (æƒé‡: %s%%) + MLåˆ†æ•°: %s (æƒé‡: %s%%) = æœ€ç»ˆåˆ†æ•°: %s',
        p_rule_score, p_rule_weight * 100,
        COALESCE(p_ml_score, 0), p_ml_weight * 100,
            v_final_score
        );

        RETURN QUERY SELECT v_final_score, v_decision, v_reason;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å†³ç­–èåˆå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

---

## äº”ã€è¾…åŠ©å‡½æ•°

### 5.1 è§„åˆ™å‘½ä¸­ç»Ÿè®¡æ›´æ–°

```sql
-- æ›´æ–°è§„åˆ™å‘½ä¸­ç»Ÿè®¡ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_rule_statistics(
    p_rule_id VARCHAR(50)
) RETURNS VOID AS $$
BEGIN
    BEGIN
        IF p_rule_id IS NULL OR p_rule_id = '' THEN
            RAISE EXCEPTION 'rule_idä¸èƒ½ä¸ºç©º';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'fraud_rules') THEN
            RAISE EXCEPTION 'è¡¨ fraud_rules ä¸å­˜åœ¨';
        END IF;

        -- æ‰§è¡ŒUPSERT
        INSERT INTO fraud_rules (
            rule_id, rule_name, conditions, actions, priority, rule_type, created_by
        ) VALUES (
            p_rule_id, p_rule_name, p_conditions, p_actions, p_priority, p_rule_type, p_created_by
        )
        ON CONFLICT (rule_id) DO UPDATE SET
            rule_name = EXCLUDED.rule_name,
            conditions = EXCLUDED.conditions,
            actions = EXCLUDED.actions,
            priority = EXCLUDED.priority,
            rule_type = EXCLUDED.rule_type,
            updated_at = CURRENT_TIMESTAMP;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º/æ›´æ–°è§„åˆ™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

        UPDATE fraud_rules
        SET
            hit_count = hit_count + 1,
            last_hit_time = CURRENT_TIMESTAMP
        WHERE rule_id = p_rule_id;

        IF NOT FOUND THEN
            RAISE WARNING 'è§„åˆ™ % ä¸å­˜åœ¨', p_rule_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°è§„åˆ™ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 è§„åˆ™ç®¡ç†å‡½æ•°

```sql
-- åˆ›å»º/æ›´æ–°è§„åˆ™
CREATE OR REPLACE FUNCTION upsert_fraud_rule(
    p_rule_id VARCHAR(50),
    p_rule_name VARCHAR(200),
    p_conditions JSONB,
    p_actions JSONB,
    p_priority INTEGER DEFAULT 0,
    p_rule_type VARCHAR(50) DEFAULT NULL,
    p_created_by VARCHAR(100) DEFAULT CURRENT_USER
) RETURNS VOID AS $$
BEGIN
    INSERT INTO fraud_rules (
        rule_id, rule_name, conditions, actions,
        priority, rule_type, created_by, version
    ) VALUES (
        p_rule_id, p_rule_name, p_conditions, p_actions,
        p_priority, p_rule_type, p_created_by, 1
    )
    ON CONFLICT (rule_id) DO UPDATE SET
        rule_name = EXCLUDED.rule_name,
        conditions = EXCLUDED.conditions,
        actions = EXCLUDED.actions,
        priority = EXCLUDED.priority,
        rule_type = EXCLUDED.rule_type,
        version = fraud_rules.version + 1,
        updated_at = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- å¯ç”¨/ç¦ç”¨è§„åˆ™
CREATE OR REPLACE FUNCTION toggle_rule(
    p_rule_id VARCHAR(50),
    p_is_active BOOLEAN
) RETURNS VOID AS $$
BEGIN
    UPDATE fraud_rules
    SET is_active = p_is_active,
        updated_at = CURRENT_TIMESTAMP
    WHERE rule_id = p_rule_id;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 å®¡è®¡æ—¥å¿—è®°å½•

```sql
-- è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION log_audit(
    p_transaction_id BIGINT,
    p_result_id BIGINT,
    p_action_type VARCHAR(50),
    p_action_details JSONB DEFAULT '{}'::jsonb,
    p_user_id BIGINT DEFAULT NULL,
    p_ip_address INET DEFAULT NULL
) RETURNS VOID AS $$
BEGIN
    BEGIN
        IF p_action_type IS NULL OR p_action_type = '' THEN
            RAISE EXCEPTION 'action_typeä¸èƒ½ä¸ºç©º';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_logs') THEN
            RAISE EXCEPTION 'è¡¨ audit_logs ä¸å­˜åœ¨';
        END IF;

        INSERT INTO audit_logs (
            transaction_id, result_id, action_type, action_details, user_id, ip_address
        ) VALUES (
            p_transaction_id, p_result_id, p_action_type, p_action_details, p_user_id, p_ip_address
        );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
    INSERT INTO audit_logs (
        transaction_id, result_id, action_type,
        action_details, user_id, ip_address
    ) VALUES (
        p_transaction_id, p_result_id, p_action_type,
        p_action_details, p_user_id, p_ip_address
    );
END;
$$ LANGUAGE plpgsql;
```

---

## å…­ã€ä½¿ç”¨ç¤ºä¾‹

### 6.1 æ£€æµ‹å•ç¬”äº¤æ˜“

```sql
-- æ£€æµ‹äº¤æ˜“ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_user_id BIGINT := 12345;
    v_amount NUMERIC := 15000.00;
    v_merchant_id BIGINT := 1001;
    v_device_id VARCHAR(100) := 'device_abc123';
    v_ip_address INET := '192.168.1.100'::INET;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¬ºè¯ˆæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM detect_fraud(
    p_user_id := 12345,
    p_amount := 15000.00,
    p_merchant_id := 1001,
    p_device_id := 'device_abc123',
    p_ip_address := '192.168.1.100'::INET
);
```

### 6.2 åˆ›å»ºè§„åˆ™

```sql
-- åˆ›å»ºå¤§é¢äº¤æ˜“è§„åˆ™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'fraud_rules') THEN
            RAISE WARNING 'è¡¨ fraud_rules ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§„åˆ™';
            RETURN;
        END IF;

        PERFORM upsert_fraud_rule(
            p_rule_id := 'R001',
            p_rule_name := 'å¤§é¢äº¤æ˜“æ£€æµ‹',
            p_conditions := '{"amount": {"$gt": 10000}}'::jsonb,
            p_actions := '{"score": 80, "reason": "å¤§é¢äº¤æ˜“"}'::jsonb,
            p_priority := 1,
            p_rule_type := 'amount'
        );

        RAISE NOTICE 'è§„åˆ™ R001 åˆ›å»º/æ›´æ–°æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§„åˆ™å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 6.3 æŸ¥è¯¢æ£€æµ‹ç»“æœ

```sql
-- æŸ¥è¯¢é«˜é£é™©äº¤æ˜“ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'detection_results') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢é«˜é£é™©äº¤æ˜“';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    dr.result_id,
    dr.transaction_id,
    dr.risk_score,
    dr.final_decision,
    dr.decision_reason,
    t.amount,
    t.user_id
FROM detection_results dr
JOIN transactions t ON dr.transaction_id = t.transaction_id
WHERE dr.risk_score > 80
  AND dr.detection_time >= NOW() - INTERVAL '24 hours'
ORDER BY dr.risk_score DESC
LIMIT 100;
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 å‡½æ•°ä¼˜åŒ–æŠ€å·§

1. **ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢**: ç‰¹å¾æå–ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
2. **ç¼“å­˜ç»“æœ**: ç”¨æˆ·ç‰¹å¾ä½¿ç”¨ç‰©åŒ–è§†å›¾
3. **æ‰¹é‡æ“ä½œ**: è§„åˆ™åŒ¹é…ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
4. **ç´¢å¼•ä¼˜åŒ–**: ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨ç´¢å¼•

### 7.2 PostgreSQL 18ç‰¹æ€§åº”ç”¨

- **å¼‚æ­¥I/O**: æ‰¹é‡è§„åˆ™æŸ¥è¯¢
- **å¹¶è¡ŒæŸ¥è¯¢**: ç‰¹å¾æå–å¹¶è¡ŒåŒ–
- **ç‰©åŒ–è§†å›¾**: å®æ—¶ç‰¹å¾èšåˆ
- **JSONBç´¢å¼•**: åŠ é€Ÿè§„åˆ™åŒ¹é…

---

---

## å…«ã€PostgreSQL 18åæ¬ºè¯ˆä¼˜åŒ–

### 8.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF current_setting('is_superuser') = 'off' THEN
            RAISE NOTICE 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼Œè¯·åœ¨postgresql.confä¸­è®¾ç½®';
            RETURN;
        END IF;
        ALTER SYSTEM SET io_direct = 'data';
        ALTER SYSTEM SET io_combine_limit = '256kB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ€§èƒ½æå‡:
-- ç‰¹å¾æå–æŸ¥è¯¢: +25-30%
-- è§„åˆ™åŒ¹é…æŸ¥è¯¢: +20-25%
-- å†³ç­–èåˆæŸ¥è¯¢: +15-20%
```

### 8.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼‰**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆéœ€è¦åœ¨ä¼šè¯çº§åˆ«è®¾ç½®ï¼‰
-- SET max_parallel_workers_per_gather = 4;
-- SET parallel_setup_cost = 1000;
-- SET parallel_tuple_cost = 0.01;

-- å¹¶è¡Œç‰¹å¾æå–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œç‰¹å¾æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    user_id,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM transactions
WHERE user_id IN (SELECT user_id FROM users WHERE created_at > NOW() - INTERVAL '30 days')
GROUP BY user_id;

-- æ€§èƒ½æå‡:
-- å¤§è§„æ¨¡ç‰¹å¾æå–: +40-50%
```

---

## ä¹ã€åæ¬ºè¯ˆç³»ç»Ÿç›‘æ§

### 9.1 æ£€æµ‹æ€§èƒ½ç›‘æ§

**æ£€æµ‹æ€§èƒ½ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- æ£€æµ‹æ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'fraud_detection_logs') THEN
            RAISE WARNING 'è¡¨ fraud_detection_logs ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        DROP VIEW IF EXISTS v_fraud_detection_performance;
        CREATE OR REPLACE VIEW v_fraud_detection_performance AS
SELECT
    DATE_TRUNC('hour', created_at) AS hour,
    COUNT(*) AS detection_count,
    AVG(detection_latency_ms) AS avg_latency_ms,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY detection_latency_ms) AS p95_latency_ms,
    COUNT(*) FILTER (WHERE final_decision = 'fraud') AS fraud_count,
    COUNT(*) FILTER (WHERE final_decision = 'approve') AS approve_count
FROM fraud_detection_logs
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;

-- æŸ¥è¯¢æ£€æµ‹æ€§èƒ½ç»Ÿè®¡
SELECT * FROM v_fraud_detection_performance;
```

### 9.2 è§„åˆ™å‘½ä¸­ç›‘æ§

**è§„åˆ™å‘½ä¸­ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- è§„åˆ™å‘½ä¸­ç»Ÿè®¡è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'fraud_detection_logs') THEN
            RAISE WARNING 'è¡¨ fraud_detection_logs ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;
        DROP VIEW IF EXISTS v_rule_hit_statistics;
        CREATE OR REPLACE VIEW v_rule_hit_statistics AS
SELECT
    rule_id,
    rule_name,
    COUNT(*) AS hit_count,
    AVG(score) AS avg_score,
    COUNT(*) FILTER (WHERE final_decision = 'fraud') AS fraud_count,
    ROUND(COUNT(*) FILTER (WHERE final_decision = 'fraud') * 100.0 / COUNT(*), 2) AS fraud_rate
        FROM fraud_detection_logs,
     jsonb_array_elements(matched_rules) AS rule_elem
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY rule_id, rule_name
ORDER BY hit_count DESC;

-- æŸ¥è¯¢è§„åˆ™å‘½ä¸­ç»Ÿè®¡
SELECT * FROM v_rule_hit_statistics
LIMIT 20;
```

---

## åã€åæ¬ºè¯ˆç³»ç»Ÿæœ€ä½³å®è·µ

### 10.1 è§„åˆ™è®¾è®¡æœ€ä½³å®è·µ

**è§„åˆ™è®¾è®¡æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. è§„åˆ™ä¼˜å…ˆçº§è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'fraud_rules') THEN
            RAISE WARNING 'è¡¨ fraud_rules ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_fraud_rules_priority') THEN
            CREATE INDEX idx_fraud_rules_priority ON fraud_rules(is_active, priority DESC, rule_id)
            WHERE is_active = true;
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_fraud_rules_priority åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 2. è§„åˆ™æ¡ä»¶ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_user_amount') THEN
            CREATE INDEX idx_transactions_user_amount ON transactions(user_id, amount);
            RAISE NOTICE 'ç´¢å¼• idx_transactions_user_amount åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_transactions_device') THEN
            CREATE INDEX idx_transactions_device ON transactions(device_id);
            RAISE NOTICE 'ç´¢å¼• idx_transactions_device åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 3. è§„åˆ™ç¼“å­˜ï¼ˆåº”ç”¨å±‚ï¼‰
-- ç¼“å­˜å¸¸ç”¨è§„åˆ™ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
```

### 10.2 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

**æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**ï¼š

```sql
-- 1. ç‰¹å¾é¢„è®¡ç®—ï¼ˆç‰©åŒ–è§†å›¾ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transactions') THEN
            RAISE WARNING 'è¡¨ transactions ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç‰©åŒ–è§†å›¾';
            RETURN;
        END IF;
        DROP MATERIALIZED VIEW IF EXISTS mv_user_features;
        CREATE MATERIALIZED VIEW mv_user_features AS
SELECT
    user_id,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount,
    MAX(created_at) AS last_transaction_time
        FROM transactions
        GROUP BY user_id;

        CREATE UNIQUE INDEX ON mv_user_features (user_id);
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾ mv_user_features åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
    END;
END $$;

CREATE UNIQUE INDEX ON mv_user_features(user_id);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_user_features;

-- 2. æ‰¹é‡æ£€æµ‹ï¼ˆæé«˜ååé‡ï¼‰
-- ä½¿ç”¨æ‰¹é‡INSERTå’Œæ‰¹é‡æ£€æµ‹å‡½æ•°

-- 3. å¼‚æ­¥å¤„ç†ï¼ˆé™ä½å»¶è¿Ÿï¼‰
-- éå…³é”®è§„åˆ™å¼‚æ­¥åŒ¹é…
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
**å­—æ•°**: ~12,000å­—
**æ¶µç›–**: æ ¸å¿ƒæ£€æµ‹å‡½æ•°ã€è§„åˆ™å¼•æ“ã€ç‰¹å¾æå–ã€å†³ç­–èåˆã€PostgreSQL 18ä¼˜åŒ–ã€ç›‘æ§ã€æœ€ä½³å®è·µ
