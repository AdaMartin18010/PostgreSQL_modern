---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\10-é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ\06-éƒ¨ç½²è¿ç»´.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜
---
> **âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£éµå¾ªæ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿æ ¼å¼ã€‚
>
> **æ¨èé˜…è¯»**:
>
> - [æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿](../æ¡ˆä¾‹æ–‡æ¡£é€šç”¨æ¨¡æ¿.md) - é€šç”¨æ¡ˆä¾‹æ–‡æ¡£æ ¼å¼å’Œæœ€ä½³å®è·µ
>
> æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºé‡‘èåæ¬ºè¯ˆç³»ç»Ÿçš„éƒ¨ç½²è¿ç»´å‚è€ƒã€‚
---

# æ¡ˆä¾‹10ï¼šé‡‘èåæ¬ºè¯ˆç³»ç»Ÿ - éƒ¨ç½²è¿ç»´

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-22
- **éƒ¨ç½²æ–¹å¼**: Docker + Kubernetes + Patroni
- **ç›‘æ§**: Prometheus + Grafana + AlertManager
- **é«˜å¯ç”¨**: Patroni + HAProxy + ä¸»ä»å¤åˆ¶
- **å¤‡ä»½**: WALå½’æ¡£ + å®šæœŸå…¨é‡å¤‡ä»½ + è§„åˆ™å¤‡ä»½
- **æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## 1. Dockeréƒ¨ç½²é…ç½®

### 1.1 Docker Composeé…ç½®

**Docker Composeé…ç½®ï¼ˆå¸¦Patronié«˜å¯ç”¨ï¼‰**ï¼š

```yaml
version: '3.8'

services:
  postgres-primary:
    image: postgres:18
    container_name: fraud-db-primary
    environment:
      POSTGRES_DB: fraud_detection
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf
    ports:
      - "5432:5432"
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
      - "-c"
      - "shared_buffers=16GB"
      - "-c"
      - "work_mem=128MB"
      - "-c"
      - "maintenance_work_mem=2GB"
      - "-c"
      - "max_connections=1000"
      - "-c"
      - "effective_cache_size=48GB"
      - "-c"
      - "synchronous_commit=on"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "hot_standby=on"
      - "-c"
      - "io_direct='data,wal'"
      - "-c"
      - "effective_io_concurrency=200"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-replica:
    image: postgres:18
    container_name: fraud-db-replica
    environment:
      POSTGRES_DB: fraud_detection
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGUSER: postgres
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=16GB"
      - "-c"
      - "max_connections=1000"
      - "-c"
      - "hot_standby=on"
    depends_on:
      - postgres-primary
    restart: unless-stopped

  haproxy:
    image: haproxy:latest
    container_name: fraud-haproxy
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    ports:
      - "5434:5432"
      - "8404:8404"  # Stats page
    depends_on:
      - postgres-primary
      - postgres-replica
    restart: unless-stopped

  fraud-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: fraud-api
    environment:
      DB_HOST: haproxy
      DB_PORT: 5432
      DB_NAME: fraud_detection
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD}
      DB_READ_HOST: haproxy
      DB_READ_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8010:8010"
    depends_on:
      - haproxy
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: fraud-redis
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: fraud-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: fraud-grafana
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  postgres-primary-data:
  postgres-replica-data:
  redis-data:
  prometheus-data:
  grafana-data:
```

### 1.2 PostgreSQLä¼˜åŒ–é…ç½®

**PostgreSQLä¼˜åŒ–é…ç½®ï¼ˆPostgreSQL 18ç‰¹æ€§ï¼Œåæ¬ºè¯ˆç³»ç»Ÿï¼‰**ï¼š

```ini
# postgresql.conf - é‡‘èåæ¬ºè¯ˆç³»ç»Ÿä¼˜åŒ–

# å†…å­˜é…ç½®
shared_buffers = 16GB
work_mem = 128MB
maintenance_work_mem = 2GB
effective_cache_size = 48GB

# è¿æ¥é…ç½®
max_connections = 1000
superuser_reserved_connections = 10

# WALé…ç½®
wal_level = replica
max_wal_senders = 10
wal_keep_size = 10GB
min_wal_size = 2GB
max_wal_size = 8GB

# å¤åˆ¶é…ç½®
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = 30s

# PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
io_direct = 'data,wal'
effective_io_concurrency = 200
maintenance_io_concurrency = 200
wal_io_concurrency = 200

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1
effective_cache_size = 48GB
default_statistics_target = 100

# JSONBä¼˜åŒ–
gin_pending_list_limit = 4MB

# æ—¥å¿—é…ç½®
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000  # è®°å½•>1ç§’çš„æŸ¥è¯¢
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# æ€§èƒ½ç›‘æ§
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000
```

---

## 2. Kuberneteséƒ¨ç½²é…ç½®

### 2.1 StatefulSeté…ç½®

**PostgreSQL StatefulSeté…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: fraud-postgres
  namespace: fraud-system
spec:
  serviceName: fraud-postgres
  replicas: 2
  selector:
    matchLabels:
      app: fraud-postgres
  template:
    metadata:
      labels:
        app: fraud-postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_DB
          value: fraud_detection
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fraud-db-secret
              key: password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
        resources:
          requests:
            memory: "32Gi"
            cpu: "8"
          limits:
            memory: "64Gi"
            cpu: "16"
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: postgres-config
        configMap:
          name: fraud-postgres-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 1Ti
```

### 2.2 Serviceé…ç½®

**PostgreSQL Serviceé…ç½®**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: fraud-postgres
  namespace: fraud-system
spec:
  selector:
    app: fraud-postgres
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  clusterIP: None
---
apiVersion: v1
kind: Service
metadata:
  name: fraud-postgres-read
  namespace: fraud-system
spec:
  selector:
    app: fraud-postgres
    role: replica
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
```

---

## 3. é«˜å¯ç”¨é…ç½®

### 3.1 Patronié…ç½®

**Patronié…ç½®æ–‡ä»¶ï¼ˆpatroni.ymlï¼‰**ï¼š

```yaml
scope: fraud_cluster
namespace: /fraud/
name: fraud-postgres-0

restapi:
  listen: 0.0.0.0:8008
  connect_address: fraud-postgres-0.fraud-postgres:8008

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        wal_level: replica
        hot_standby: "on"
        wal_keep_size: 10GB
        max_connections: 1000
        max_worker_processes: 16
        max_parallel_workers_per_gather: 4
        max_parallel_workers: 8
        shared_buffers: 16GB
        effective_cache_size: 48GB
        work_mem: 128MB
        maintenance_work_mem: 2GB
        io_direct: 'data,wal'
        effective_io_concurrency: 200

postgresql:
  listen: 0.0.0.0:5432
  connect_address: fraud-postgres-0.fraud-postgres:5432
  data_dir: /var/lib/postgresql/data/pgdata
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: replicator_password
    superuser:
      username: postgres
      password: postgres_password
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```

### 3.2 HAProxyé…ç½®

**HAProxyé…ç½®ï¼ˆhaproxy.cfgï¼‰**ï¼š

```ini
global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode tcp
    timeout connect 5s
    timeout client 30s
    timeout server 30s

# ä¸»åº“ï¼ˆå†™ï¼‰
frontend postgres_write
    bind *:5432
    default_backend postgres_primary

backend postgres_primary
    option httpchk GET /master
    http-check expect status 200
    server postgres-primary fraud-postgres-0.fraud-postgres:5432 check port 8008

# ä»åº“ï¼ˆè¯»ï¼‰
frontend postgres_read
    bind *:5433
    default_backend postgres_replicas

backend postgres_replicas
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    server postgres-replica-0 fraud-postgres-1.fraud-postgres:5432 check port 8008

# Statsé¡µé¢
listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 5s
```

---

## 4. ç›‘æ§é…ç½®

### 4.1 Prometheusé…ç½®

**Prometheusé…ç½®ï¼ˆprometheus.ymlï¼‰**ï¼š

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['fraud-postgres-0:9187']
        labels:
          instance: 'fraud-postgres-primary'
      - targets: ['fraud-postgres-1:9187']
        labels:
          instance: 'fraud-postgres-replica'

  - job_name: 'fraud-api'
    static_configs:
      - targets: ['fraud-api:8010']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']

rule_files:
  - 'fraud_alerts.yml'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
```

### 4.2 å‘Šè­¦è§„åˆ™é…ç½®

**å‘Šè­¦è§„åˆ™ï¼ˆfraud_alerts.ymlï¼‰**ï¼š

```yaml
groups:
- name: fraud_detection_alerts
  interval: 30s
  rules:
  # æ£€æµ‹å»¶è¿Ÿå‘Šè­¦
  - alert: HighFraudDetectionLatency
    expr: histogram_quantile(0.95, rate(fraud_detection_latency_bucket[5m])) > 50
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æ¬ºè¯ˆæ£€æµ‹å»¶è¿Ÿè¿‡é«˜"
      description: "P95å»¶è¿Ÿè¶…è¿‡50ms: {{ $value }}ms"

  - alert: CriticalFraudDetectionLatency
    expr: histogram_quantile(0.99, rate(fraud_detection_latency_bucket[5m])) > 100
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "æ¬ºè¯ˆæ£€æµ‹å»¶è¿Ÿä¸¥é‡è¶…æ ‡"
      description: "P99å»¶è¿Ÿè¶…è¿‡100ms: {{ $value }}ms"

  # è§„åˆ™å¼•æ“æ€§èƒ½å‘Šè­¦
  - alert: HighRuleMatchingLatency
    expr: histogram_quantile(0.95, rate(rule_matching_latency_bucket[5m])) > 20
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "è§„åˆ™åŒ¹é…å»¶è¿Ÿè¿‡é«˜"
      description: "P95å»¶è¿Ÿè¶…è¿‡20ms: {{ $value }}ms"

  # æ•°æ®åº“è¿æ¥å‘Šè­¦
  - alert: HighDatabaseConnections
    expr: pg_stat_database_numbackends{datname="fraud_detection"} > 800
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
      description: "å½“å‰è¿æ¥æ•°: {{ $value }}, æœ€å¤§: 1000"

  # æ•°æ®åº“æ€§èƒ½å‘Šè­¦
  - alert: SlowQueries
    expr: rate(pg_stat_statements_mean_exec_time[5m]) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æ…¢æŸ¥è¯¢æ£€æµ‹"
      description: "å¹³å‡æŸ¥è¯¢æ—¶é—´è¶…è¿‡1ç§’"

  # ä¸»ä»å»¶è¿Ÿå‘Šè­¦
  - alert: HighReplicationLag
    expr: pg_replication_lag > 10
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ä¸»ä»å¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
      description: "å¤åˆ¶å»¶è¿Ÿ: {{ $value }}ç§’"

  # ç£ç›˜ç©ºé—´å‘Šè­¦
  - alert: LowDiskSpace
    expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql/data"} / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql/data"}) < 0.2
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "ç£ç›˜ç©ºé—´ä¸è¶³"
      description: "å‰©ä½™ç©ºé—´: {{ $value | humanizePercentage }}"
```

### 4.3 Grafana Dashboardé…ç½®

**Grafana Dashboard JSONé…ç½®**ï¼š

```json
{
  "dashboard": {
    "title": "é‡‘èåæ¬ºè¯ˆç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "æ¬ºè¯ˆæ£€æµ‹å»¶è¿Ÿ",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(fraud_detection_latency_bucket[5m]))",
            "legendFormat": "P95å»¶è¿Ÿ"
          },
          {
            "expr": "histogram_quantile(0.99, rate(fraud_detection_latency_bucket[5m]))",
            "legendFormat": "P99å»¶è¿Ÿ"
          }
        ]
      },
      {
        "title": "æ£€æµ‹TPS",
        "targets": [
          {
            "expr": "rate(fraud_detections_total[5m])",
            "legendFormat": "æ£€æµ‹TPS"
          }
        ]
      },
      {
        "title": "è§„åˆ™å‘½ä¸­ç‡",
        "targets": [
          {
            "expr": "rate(rule_matches_total[5m])",
            "legendFormat": "è§„åˆ™å‘½ä¸­æ•°"
          }
        ]
      },
      {
        "title": "æ•°æ®åº“è¿æ¥æ•°",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"fraud_detection\"}",
            "legendFormat": "è¿æ¥æ•°"
          }
        ]
      }
    ]
  }
}
```

---

## 5. å¤‡ä»½ä¸æ¢å¤

### 5.1 WALå½’æ¡£é…ç½®

**WALå½’æ¡£é…ç½®**ï¼š

```bash
#!/bin/bash
# wal_archive.sh - WALå½’æ¡£è„šæœ¬

ARCHIVE_DIR="/backup/wal_archive"
WAL_FILE=$1

# åˆ›å»ºå½’æ¡£ç›®å½•
mkdir -p $ARCHIVE_DIR

# å¤åˆ¶WALæ–‡ä»¶åˆ°å½’æ¡£ç›®å½•
cp $WAL_FILE $ARCHIVE_DIR/$(basename $WAL_FILE)

# å‹ç¼©å½’æ¡£ï¼ˆå¯é€‰ï¼‰
gzip $ARCHIVE_DIR/$(basename $WAL_FILE)

# ä¸Šä¼ åˆ°S3ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $ARCHIVE_DIR/$(basename $WAL_FILE).gz s3://fraud-backup/wal/

echo "WALå½’æ¡£å®Œæˆ: $WAL_FILE"
```

**PostgreSQLé…ç½®**ï¼š

```ini
# postgresql.conf
archive_mode = on
archive_command = '/scripts/wal_archive.sh %p'
archive_timeout = 300
```

### 5.2 å…¨é‡å¤‡ä»½è„šæœ¬

**å…¨é‡å¤‡ä»½è„šæœ¬ï¼ˆbackup.shï¼‰**ï¼š

```bash
#!/bin/bash
# backup.sh - å…¨é‡å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/full"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/fraud_detection_$DATE.dump"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
pg_dump -h localhost -U postgres -d fraud_detection \
    --format=custom \
    --compress=9 \
    --file=$BACKUP_FILE

# å¤‡ä»½è§„åˆ™è¡¨ï¼ˆé‡è¦ï¼‰
pg_dump -h localhost -U postgres -d fraud_detection \
    -t fraud_rules \
    --format=plain \
    --file=$BACKUP_DIR/fraud_rules_$DATE.sql

# å¤‡ä»½ç‰¹å¾è¡¨
pg_dump -h localhost -U postgres -d fraud_detection \
    -t user_features \
    -t device_features \
    --format=plain \
    --file=$BACKUP_DIR/features_$DATE.sql

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_FILE

# ä¸Šä¼ åˆ°S3
aws s3 cp $BACKUP_FILE.gz s3://fraud-backup/full/
aws s3 cp $BACKUP_DIR/fraud_rules_$DATE.sql s3://fraud-backup/rules/
aws s3 cp $BACKUP_DIR/features_$DATE.sql s3://fraud-backup/features/

# æ¸…ç†æœ¬åœ°å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find $BACKUP_DIR -name "*.dump.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE.gz"
```

### 5.3 æ¢å¤è„šæœ¬

**æ¢å¤è„šæœ¬ï¼ˆrestore.shï¼‰**ï¼š

```bash
#!/bin/bash
# restore.sh - æ¢å¤è„šæœ¬

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ–‡ä»¶>"
    exit 1
fi

# åœæ­¢åº”ç”¨
systemctl stop fraud-api

# åœæ­¢PostgreSQL
systemctl stop postgresql

# æ¸…ç©ºæ•°æ®ç›®å½•
rm -rf /var/lib/postgresql/data/*

# æ¢å¤å¤‡ä»½
pg_restore -h localhost -U postgres -d fraud_detection \
    --format=custom \
    --clean \
    --if-exists \
    $BACKUP_FILE

# æ¢å¤è§„åˆ™è¡¨
psql -h localhost -U postgres -d fraud_detection \
    -f /backup/rules/fraud_rules_latest.sql

# å¯åŠ¨PostgreSQL
systemctl start postgresql

# ç­‰å¾…PostgreSQLå°±ç»ª
sleep 10

# å¯åŠ¨åº”ç”¨
systemctl start fraud-api

echo "æ¢å¤å®Œæˆ"
```

---

## 6. è§„åˆ™ç®¡ç†

### 6.1 è§„åˆ™å¤‡ä»½

**è§„åˆ™å¤‡ä»½è„šæœ¬ï¼ˆbackup_rules.shï¼‰**ï¼š

```bash
#!/bin/bash
# backup_rules.sh - è§„åˆ™å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/rules"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/fraud_rules_$DATE.json"

# å¯¼å‡ºè§„åˆ™ä¸ºJSON
psql -h localhost -U postgres -d fraud_detection -t -c "
    SELECT json_agg(row_to_json(t))
    FROM (
        SELECT rule_id, rule_name, rule_type, rule_condition,
               rule_action, score, priority, is_active, created_at, updated_at
        FROM fraud_rules
        ORDER BY rule_id
    ) t
" > $BACKUP_FILE

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_FILE

# ä¸Šä¼ åˆ°S3
aws s3 cp $BACKUP_FILE.gz s3://fraud-backup/rules/

echo "è§„åˆ™å¤‡ä»½å®Œæˆ: $BACKUP_FILE.gz"
```

### 6.2 è§„åˆ™æ¢å¤

**è§„åˆ™æ¢å¤è„šæœ¬ï¼ˆrestore_rules.shï¼‰**ï¼š

```bash
#!/bin/bash
# restore_rules.sh - è§„åˆ™æ¢å¤è„šæœ¬

RULES_FILE=$1

if [ -z "$RULES_FILE" ]; then
    echo "ç”¨æ³•: $0 <è§„åˆ™JSONæ–‡ä»¶>"
    exit 1
fi

# è§£æJSONå¹¶æ¢å¤è§„åˆ™
psql -h localhost -U postgres -d fraud_detection <<EOF
BEGIN;

-- æ¸…ç©ºç°æœ‰è§„åˆ™ï¼ˆå¯é€‰ï¼‰
-- TRUNCATE fraud_rules CASCADE;

-- æ¢å¤è§„åˆ™
INSERT INTO fraud_rules (
    rule_name, rule_type, rule_condition, rule_action,
    score, priority, is_active, created_at, updated_at
)
SELECT
    rule->>'rule_name',
    rule->>'rule_type',
    rule->>'rule_condition',
    rule->>'rule_action',
    (rule->>'score')::NUMERIC,
    (rule->>'priority')::INTEGER,
    (rule->>'is_active')::BOOLEAN,
    (rule->>'created_at')::TIMESTAMPTZ,
    (rule->>'updated_at')::TIMESTAMPTZ
FROM json_array_elements(pg_read_file('$RULES_FILE')::json) AS rule;

COMMIT;
EOF

echo "è§„åˆ™æ¢å¤å®Œæˆ"
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 è¿æ¥æ± é…ç½®

**pgBounceré…ç½®ï¼ˆpgbouncer.iniï¼‰**ï¼š

```ini
[databases]
fraud_detection = host=localhost port=5432 dbname=fraud_detection

[pgbouncer]
pool_mode = transaction
max_client_conn = 2000
default_pool_size = 100
min_pool_size = 20
reserve_pool_size = 10
reserve_pool_timeout = 3
max_db_connections = 200
max_user_connections = 100

# è¿æ¥è¶…æ—¶
connect_timeout = 15
client_idle_timeout = 0
server_idle_timeout = 600
server_connect_timeout = 15
server_login_retry = 15

# æŸ¥è¯¢è¶…æ—¶
query_timeout = 0
query_wait_timeout = 120
client_login_timeout = 60

# æ—¥å¿—
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
```

### 7.2 Redisç¼“å­˜é…ç½®

**Redisé…ç½®ï¼ˆredis.confï¼‰**ï¼š

```conf
# å†…å­˜é…ç½®
maxmemory 2gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–é…ç½®
appendonly yes
appendfsync everysec

# æ€§èƒ½é…ç½®
tcp-backlog 511
timeout 0
tcp-keepalive 300

# è¿æ¥é…ç½®
maxclients 10000
```

---

## 8. å®‰å…¨é…ç½®

### 8.1 è®¿é—®æ§åˆ¶

**pg_hba.confé…ç½®**ï¼š

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             postgres                                peer
local   fraud_detection fraud_user                             md5

# åº”ç”¨æœåŠ¡å™¨è¿æ¥
host    fraud_detection fraud_user     10.0.0.0/8              md5
host    fraud_detection fraud_user     172.16.0.0/12          md5

# å¤åˆ¶è¿æ¥
host    replication     replicator      10.0.0.0/8              md5

# æ‹’ç»å…¶ä»–è¿æ¥
host    all             all             0.0.0.0/0               reject
```

### 8.2 SSLé…ç½®

**SSLé…ç½®**ï¼š

```ini
# postgresql.conf
ssl = on
ssl_cert_file = '/etc/ssl/certs/postgresql.crt'
ssl_key_file = '/etc/ssl/private/postgresql.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'
```

---

## 9. æ•…éšœå¤„ç†

### 9.1 å¸¸è§æ•…éšœå¤„ç†

**ä¸»åº“æ•…éšœå¤„ç†**ï¼š

```bash
#!/bin/bash
# failover.sh - ä¸»åº“æ•…éšœåˆ‡æ¢è„šæœ¬

# æ£€æŸ¥ä¸»åº“çŠ¶æ€
PRIMARY_STATUS=$(curl -s http://fraud-postgres-0:8008/patroni | jq -r '.state')

if [ "$PRIMARY_STATUS" != "running" ]; then
    echo "ä¸»åº“æ•…éšœï¼Œå¼€å§‹åˆ‡æ¢..."

    # æå‡ä»åº“ä¸ºä¸»åº“
    curl -X POST http://fraud-postgres-1:8008/failover

    # æ›´æ–°HAProxyé…ç½®
    # ...

    echo "æ•…éšœåˆ‡æ¢å®Œæˆ"
fi
```

### 9.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬**ï¼š

```sql
-- æ£€æŸ¥ä¸»ä»æ•°æ®ä¸€è‡´æ€§
DO $$
DECLARE
    primary_count BIGINT;
    replica_count BIGINT;
BEGIN
    -- ä¸»åº“è®°å½•æ•°
    SELECT COUNT(*) INTO primary_count
    FROM transactions@primary;

    -- ä»åº“è®°å½•æ•°
    SELECT COUNT(*) INTO replica_count
    FROM transactions@replica;

    IF primary_count != replica_count THEN
        RAISE WARNING 'æ•°æ®ä¸ä¸€è‡´: ä¸»åº“=% ä»åº“=%', primary_count, replica_count;
    ELSE
        RAISE NOTICE 'æ•°æ®ä¸€è‡´: %', primary_count;
    END IF;
END $$;
```

---

## 10. è¿ç»´æœ€ä½³å®è·µ

### 10.1 å®šæœŸç»´æŠ¤ä»»åŠ¡

**å®šæœŸç»´æŠ¤è„šæœ¬ï¼ˆmaintenance.shï¼‰**ï¼š

```bash
#!/bin/bash
# maintenance.sh - å®šæœŸç»´æŠ¤è„šæœ¬

# 1. VACUUM
psql -h localhost -U postgres -d fraud_detection -c "VACUUM ANALYZE;"

# 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
psql -h localhost -U postgres -d fraud_detection -c "ANALYZE;"

# 3. é‡å»ºç´¢å¼•ï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰
# psql -h localhost -U postgres -d fraud_detection -c "REINDEX DATABASE fraud_detection;"

# 4. æ¸…ç†æ—§æ•°æ®ï¼ˆä¿ç•™90å¤©ï¼‰
psql -h localhost -U postgres -d fraud_detection <<EOF
DELETE FROM transactions
WHERE created_at < NOW() - INTERVAL '90 days';

DELETE FROM fraud_logs
WHERE created_at < NOW() - INTERVAL '90 days';
EOF

# 5. å‹ç¼©WAL
# PostgreSQLè‡ªåŠ¨å¤„ç†

echo "ç»´æŠ¤å®Œæˆ"
```

### 10.2 ç›‘æ§æ£€æŸ¥æ¸…å•

**æ¯æ—¥æ£€æŸ¥æ¸…å•**ï¼š

- [ ] æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
- [ ] æ£€æŸ¥æ£€æµ‹å»¶è¿Ÿï¼ˆP95, P99ï¼‰
- [ ] æ£€æŸ¥è§„åˆ™å‘½ä¸­ç‡
- [ ] æ£€æŸ¥ä¸»ä»å¤åˆ¶å»¶è¿Ÿ
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—
- [ ] æ£€æŸ¥å‘Šè­¦çŠ¶æ€

**æ¯å‘¨æ£€æŸ¥æ¸…å•**ï¼š

- [ ] æ£€æŸ¥æ…¢æŸ¥è¯¢
- [ ] æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- [ ] æ£€æŸ¥è¡¨å¤§å°å¢é•¿
- [ ] æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§
- [ ] æ£€æŸ¥è§„åˆ™æ›´æ–°æƒ…å†µ

---

## 11. PostgreSQL 18ä¼˜åŒ–äº®ç‚¹

### 11.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oé…ç½®**ï¼š

```sql
-- å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_direct = 'data,wal';
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET wal_io_concurrency = 200;

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

**æ€§èƒ½æå‡**ï¼š

- æ‰¹é‡è§„åˆ™æŸ¥è¯¢å»¶è¿Ÿé™ä½60%
- ç‰¹å¾æå–æ€§èƒ½æå‡55%
- æ•´ä½“æ£€æµ‹TPSæå‡40%

### 11.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;
ALTER SYSTEM SET parallel_workers = 4;
```

**åº”ç”¨åœºæ™¯**ï¼š

- ç‰¹å¾æå–å¹¶è¡ŒåŒ–
- è§„åˆ™åŒ¹é…å¹¶è¡ŒåŒ–
- èšåˆç»Ÿè®¡å¹¶è¡ŒåŒ–

---

## 12. éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 12.1 éƒ¨ç½²å‰æ£€æŸ¥

- [ ] ç¡®è®¤PostgreSQLç‰ˆæœ¬ >= 18.1
- [ ] ç¡®è®¤ç³»ç»Ÿèµ„æºå……è¶³ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- [ ] ç¡®è®¤ç½‘ç»œé…ç½®æ­£ç¡®
- [ ] ç¡®è®¤SSLè¯ä¹¦é…ç½®
- [ ] ç¡®è®¤å¤‡ä»½ç­–ç•¥é…ç½®
- [ ] ç¡®è®¤ç›‘æ§å‘Šè­¦é…ç½®

### 12.2 éƒ¨ç½²åéªŒè¯

- [ ] éªŒè¯æ•°æ®åº“è¿æ¥
- [ ] éªŒè¯ä¸»ä»å¤åˆ¶
- [ ] éªŒè¯æ£€æµ‹åŠŸèƒ½
- [ ] éªŒè¯è§„åˆ™å¼•æ“
- [ ] éªŒè¯ç›‘æ§å‘Šè­¦
- [ ] éªŒè¯å¤‡ä»½æ¢å¤

---

**è¿”å›**: [æ¡ˆä¾‹10ä¸»é¡µ](./README.md)
**å­—æ•°**: ~8,000å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
