# PostgreSQLæ•™è‚²è¡Œä¸šå®Œæ•´æ¡ˆä¾‹

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **è¡Œä¸š**: æ•™è‚²
> **ç‰¹ç‚¹**: ä¸ªæ€§åŒ–å­¦ä¹ ã€æ¨èç³»ç»Ÿã€å­¦ä¹ åˆ†æ
> **å‚è€ƒæ¡ˆä¾‹**: [æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ](./æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ.md)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ•™è‚²è¡Œä¸šå®Œæ•´æ¡ˆä¾‹](#postgresqlæ•™è‚²è¡Œä¸šå®Œæ•´æ¡ˆä¾‹)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ•™è‚²è¡Œä¸šæ ¸å¿ƒåœºæ™¯](#2-æ•™è‚²è¡Œä¸šæ ¸å¿ƒåœºæ™¯)
  - [3. æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
  - [4. æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

---

## 1. æ¦‚è¿°

### 1.1 æ•™è‚²è¡Œä¸šç‰¹ç‚¹

æ•™è‚²è¡Œä¸šå¯¹æ•°æ®åº“çš„è¦æ±‚ï¼š

- âœ… **ä¸ªæ€§åŒ–å­¦ä¹ **: ä¸ªæ€§åŒ–æ¨è
- âœ… **å­¦ä¹ åˆ†æ**: å­¦ä¹ è¡Œä¸ºåˆ†æ
- âœ… **å†…å®¹ç®¡ç†**: è¯¾ç¨‹å†…å®¹ç®¡ç†
- âœ… **æ¨èç³»ç»Ÿ**: æ™ºèƒ½æ¨è
- âœ… **æ•°æ®åˆ†æ**: å­¦ä¹ æ•°æ®åˆ†æ

### 1.2 æ ¸å¿ƒåœºæ™¯

- **åœ¨çº¿å­¦ä¹ å¹³å°**: è¯¾ç¨‹å­¦ä¹ 
- **å­¦ä¹ æ¨è**: ä¸ªæ€§åŒ–æ¨è
- **å­¦ä¹ åˆ†æ**: å­¦ä¹ è¡Œä¸ºåˆ†æ
- **æˆç»©ç®¡ç†**: æˆç»©ç»Ÿè®¡
- **å†…å®¹ç®¡ç†**: è¯¾ç¨‹å†…å®¹ç®¡ç†

---

## 2. æ•™è‚²è¡Œä¸šæ ¸å¿ƒåœºæ™¯

### 2.1 åœ¨çº¿å­¦ä¹ å¹³å°

**æ ¸å¿ƒéœ€æ±‚**:
- è¯¾ç¨‹ç®¡ç†
- å­¦ä¹ è¿›åº¦è·Ÿè¸ª
- ä½œä¸šç®¡ç†
- æˆç»©ç»Ÿè®¡

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- è¯¾ç¨‹è¡¨
CREATE TABLE courses (
    course_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    instructor_id BIGINT,
    category_id INT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å­¦ç”Ÿè¡¨
CREATE TABLE students (
    student_id BIGSERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    email TEXT,
    level INT DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å­¦ä¹ è¿›åº¦è¡¨
CREATE TABLE learning_progress (
    progress_id BIGSERIAL PRIMARY KEY,
    student_id BIGINT NOT NULL REFERENCES students(student_id),
    course_id BIGINT NOT NULL REFERENCES courses(course_id),
    lesson_id BIGINT,
    progress_percent NUMERIC(5,2) DEFAULT 0,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(student_id, course_id, lesson_id)
);

-- ç´¢å¼•
CREATE INDEX idx_progress_student ON learning_progress(student_id);
CREATE INDEX idx_progress_course ON learning_progress(course_id);
```

### 2.2 æ™ºèƒ½å­¦ä¹ æ¨è

**å‚è€ƒ**: [æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ](./æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ.md)

**æ ¸å¿ƒéœ€æ±‚**:
- ä¸ªæ€§åŒ–æ¨è
- å‘é‡æœç´¢
- ååŒè¿‡æ»¤
- å†…å®¹æ¨è

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- å­¦ç”Ÿå‘é‡è¡¨
CREATE TABLE student_vectors (
    student_id BIGINT PRIMARY KEY REFERENCES students(student_id),
    preference_vector vector(128),
    learning_style TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- è¯¾ç¨‹å‘é‡è¡¨
CREATE TABLE course_vectors (
    course_id BIGINT PRIMARY KEY REFERENCES courses(course_id),
    embedding vector(128),
    difficulty_level INT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å‘é‡ç´¢å¼•
CREATE INDEX idx_student_vectors ON student_vectors USING hnsw (preference_vector vector_l2_ops);
CREATE INDEX idx_course_vectors ON course_vectors USING hnsw (embedding vector_l2_ops);

-- æ¨èæŸ¥è¯¢
SELECT 
    c.course_id,
    c.title,
    1 - (s.preference_vector <=> c.embedding) as similarity
FROM student_vectors s
CROSS JOIN course_vectors c
WHERE s.student_id = 12345
AND c.difficulty_level <= (
    SELECT level FROM students WHERE student_id = 12345
) + 1
ORDER BY similarity DESC
LIMIT 10;
```

### 2.3 å­¦ä¹ è¡Œä¸ºåˆ†æ

**æ ¸å¿ƒéœ€æ±‚**:
- è¡Œä¸ºæ•°æ®é‡‡é›†
- å®æ—¶åˆ†æ
- å­¦ä¹ è·¯å¾„åˆ†æ
- æ•ˆæœè¯„ä¼°

**æŠ€æœ¯æ–¹æ¡ˆ**:
```sql
-- å­¦ä¹ è¡Œä¸ºè¡¨ï¼ˆåˆ†åŒºï¼‰
CREATE TABLE learning_events (
    event_id BIGSERIAL,
    student_id BIGINT NOT NULL,
    event_type TEXT NOT NULL,
    course_id BIGINT,
    lesson_id BIGINT,
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (event_id, created_at)
) PARTITION BY RANGE (created_at);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE learning_events_2025_01 PARTITION OF learning_events
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- å­¦ä¹ åˆ†ææŸ¥è¯¢
SELECT 
    student_id,
    course_id,
    COUNT(*) as event_count,
    SUM((event_data->>'duration')::NUMERIC) as total_duration,
    AVG((event_data->>'score')::NUMERIC) as avg_score
FROM learning_events
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY student_id, course_id
ORDER BY total_duration DESC;
```

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 æ¨èç³»ç»Ÿæ¶æ„

```text
å­¦ä¹ å¹³å°
    â†“
æ¨èæœåŠ¡
    â†“
PostgreSQLé›†ç¾¤
â”œâ”€â”€ ä¸»åº“ (è¯»å†™ - å­¦ä¹ æ•°æ®)
â”œâ”€â”€ ä»åº“1 (åªè¯» - æ¨èè®¡ç®—)
â””â”€â”€ ä»åº“2 (åªè¯» - åˆ†æ)
    â†“
å‘é‡æ•°æ®åº“ (pgvector)
```

### 3.2 æ•°æ®æµ

```text
å­¦ä¹ è¡Œä¸º
    â†“
äº‹ä»¶é‡‡é›†
    â†“
å®æ—¶å¤„ç†
    â†“
å‘é‡æ›´æ–°
    â†“
æ¨èè®¡ç®—
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 è¯¾ç¨‹è¡¨è®¾è®¡

```sql
-- è¯¾ç¨‹è¡¨
CREATE TABLE courses (
    course_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    instructor_id BIGINT,
    category_id INT,
    difficulty_level INT,
    duration_minutes INT,
    embedding vector(128),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_courses_category ON courses(category_id);
CREATE INDEX idx_courses_embedding ON courses USING hnsw (embedding vector_l2_ops);
```

### 4.2 å­¦ä¹ è®°å½•è¡¨è®¾è®¡

```sql
-- å­¦ä¹ è®°å½•è¡¨
CREATE TABLE learning_records (
    record_id BIGSERIAL PRIMARY KEY,
    student_id BIGINT NOT NULL REFERENCES students(student_id),
    course_id BIGINT NOT NULL REFERENCES courses(course_id),
    lesson_id BIGINT,
    start_time TIMESTAMPTZ,
    end_time TIMESTAMPTZ,
    duration_minutes INT,
    score NUMERIC(5,2),
    completed BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_records_student ON learning_records(student_id, created_at DESC);
CREATE INDEX idx_records_course ON learning_records(course_id);
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 æ¨èä¼˜åŒ–

```sql
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW mv_student_course_similarity AS
SELECT 
    s.student_id,
    c.course_id,
    1 - (s.preference_vector <=> c.embedding) as similarity
FROM student_vectors s
CROSS JOIN course_vectors c;

CREATE UNIQUE INDEX ON mv_student_course_similarity(student_id, course_id);

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_student_course_similarity;
```

### 5.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å­¦ä¹ è¿›åº¦æŸ¥è¯¢
CREATE INDEX idx_progress_student_course ON learning_progress(student_id, course_id);

-- ä¼˜åŒ–è¡Œä¸ºåˆ†ææŸ¥è¯¢
CREATE INDEX idx_events_student_time ON learning_events(student_id, created_at DESC);
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¨èç³»ç»Ÿ

- âœ… **å‘é‡æœç´¢**: ä½¿ç”¨pgvectorè¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—
- âœ… **ååŒè¿‡æ»¤**: ç»“åˆç”¨æˆ·è¡Œä¸ºæ•°æ®
- âœ… **å†…å®¹æ¨è**: åŸºäºè¯¾ç¨‹å†…å®¹æ¨è
- âœ… **å®æ—¶æ›´æ–°**: å®æ—¶æ›´æ–°ç”¨æˆ·å‘é‡

### 6.2 å­¦ä¹ åˆ†æ

- âœ… **æ•°æ®é‡‡é›†**: å®Œæ•´é‡‡é›†å­¦ä¹ è¡Œä¸º
- âœ… **å®æ—¶åˆ†æ**: å®æ—¶åˆ†æå­¦ä¹ æ•ˆæœ
- âœ… **è·¯å¾„åˆ†æ**: åˆ†æå­¦ä¹ è·¯å¾„
- âœ… **æ•ˆæœè¯„ä¼°**: è¯„ä¼°å­¦ä¹ æ•ˆæœ

### 6.3 æ€§èƒ½ä¼˜åŒ–

- âœ… **ç´¢å¼•ä¼˜åŒ–**: åˆ›å»ºåˆé€‚ç´¢å¼•
- âœ… **ç‰©åŒ–è§†å›¾**: é¢„èšåˆæ•°æ®
- âœ… **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒº
- âœ… **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜çƒ­ç‚¹æ•°æ®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ](./æ•™è‚²åœºæ™¯/æ™ºèƒ½å­¦ä¹ æ¨èç³»ç»Ÿ.md) - å­¦ä¹ æ¨èç³»ç»Ÿæ¡ˆä¾‹
- [07-å®æ—¶æ¨èç³»ç»Ÿ](./07-å®æ—¶æ¨èç³»ç»Ÿ/README.md) - æ¨èç³»ç»Ÿ
- [10-AIä¸æœºå™¨å­¦ä¹ ](../10-AIä¸æœºå™¨å­¦ä¹ /README.md) - AIä¸æœºå™¨å­¦ä¹ 

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ

