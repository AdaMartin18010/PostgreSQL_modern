---
> **📋 文档来源**: `DataBaseTheory\19-场景案例库\08-知识图谱问答系统\06-部署运维.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变
---
> **⚠️ 重要提示**: 本文档遵循案例文档通用模板格式。
>
> **推荐阅读**:
>
> - [案例文档通用模板](../案例文档通用模板.md) - 通用案例文档格式和最佳实践
>
> 本文档保留作为知识图谱问答系统的部署运维参考。
---

# 案例8：知识图谱问答系统 - 部署运维

## 元数据

- **创建日期**: 2025-12-22
- **部署方式**: Docker + Kubernetes
- **监控**: Prometheus + Grafana
- **图数据库**: Apache AGE + PostgreSQL 18

---

## 1. Docker部署配置

### 1.1 Docker Compose配置

**Docker Compose配置（带Apache AGE和pgvector）**：

```yaml
version: '3.8'

services:
  postgres:
    image: apache/age:latest-pg18
    container_name: kg-qa-postgres
    environment:
      POSTGRES_DB: kg_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
      - "-c"
      - "shared_buffers=4GB"
      - "-c"
      - "work_mem=256MB"
      - "-c"
      - "maintenance_work_mem=1GB"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "effective_cache_size=12GB"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: kg-qa-api
    environment:
      DB_HOST: postgres
      DB_NAME: kg_db
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8008:8008"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: kg-qa-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 4gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  postgres-data:
  redis-data:
```

### 1.2 PostgreSQL + Apache AGE配置

**PostgreSQL + Apache AGE配置（PostgreSQL 18特性）**：

```ini
# postgresql.conf - 知识图谱问答系统优化

# 内存配置
shared_buffers = 4GB
work_mem = 256MB
maintenance_work_mem = 1GB
effective_cache_size = 12GB

# 连接配置
max_connections = 200
superuser_reserved_connections = 3

# WAL配置
wal_buffers = 32MB
max_wal_size = 8GB
min_wal_size = 2GB
checkpoint_timeout = 20min
checkpoint_completion_target = 0.9

# PostgreSQL 18异步I/O
io_direct = data
io_combine_limit = 256kB

# PostgreSQL 18内置连接池
pool_mode = transaction
pool_size = 150
pool_max_wait = 5

# 查询优化
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# Apache AGE配置
shared_preload_libraries = 'age'

# pgvector配置
shared_preload_libraries = 'age,vector'

# 日志配置
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 2000  # 记录>2s的查询
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 统计信息
track_io_timing = on
track_functions = all
pg_stat_statements.track = all
```

---

## 2. Apache AGE初始化

### 2.1 初始化脚本

**Apache AGE初始化脚本（带错误处理和性能测试）**：

```sql
-- init.sql - Apache AGE初始化（带错误处理）
DO $$
BEGIN
    BEGIN
        -- 1. 创建扩展
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'age') THEN
            CREATE EXTENSION age;
            RAISE NOTICE 'Apache AGE扩展创建成功';
        ELSE
            RAISE NOTICE 'Apache AGE扩展已存在';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            CREATE EXTENSION vector;
            RAISE NOTICE 'pgvector扩展创建成功';
        ELSE
            RAISE NOTICE 'pgvector扩展已存在';
        END IF;

        -- 2. 加载AGE
        LOAD 'age';

        -- 3. 设置搜索路径
        SET search_path = ag_catalog, '$user', public;
        RAISE NOTICE 'Apache AGE初始化完成';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Apache AGE初始化失败: %', SQLERRM;
    END;
END $$;
SET search_path = ag_catalog, "$user", public;

-- 4. 创建图
SELECT create_graph('knowledge_graph');

-- 5. 创建顶点标签
SELECT * FROM cypher('knowledge_graph', $$
    CREATE VLABEL Document
$$) as (v agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE VLABEL Concept
$$) as (v agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE VLABEL Person
$$) as (v agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE VLABEL Product
$$) as (v agtype);

-- 6. 创建边标签
SELECT * FROM cypher('knowledge_graph', $$
    CREATE ELABEL MENTIONS
$$) as (e agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE ELABEL RELATED_TO
$$) as (e agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE ELABEL IS_A
$$) as (e agtype);

SELECT * FROM cypher('knowledge_graph', $$
    CREATE ELABEL USED_IN
$$) as (e agtype);

-- 7. 创建向量表
CREATE TABLE entity_embeddings (
    entity_id VARCHAR(100) PRIMARY KEY,
    entity_type VARCHAR(50),
    entity_name TEXT,
    embedding vector(768),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_entity_embeddings_vector
ON entity_embeddings USING hnsw (embedding vector_l2_ops)
WITH (m = 16, ef_construction = 64);

-- 8. 创建查询日志表
CREATE TABLE query_logs (
    log_id BIGSERIAL PRIMARY KEY,
    question TEXT,
    cypher_query TEXT,
    result_count INT,
    duration_ms FLOAT,
    success BOOLEAN,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

CREATE TABLE query_logs_2025_01 PARTITION OF query_logs
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

## 3. Kubernetes部署配置

### 3.1 PostgreSQL StatefulSet

**PostgreSQL StatefulSet配置（带Apache AGE）**：

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kg-qa-postgres
  namespace: kg-qa
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: apache/age:latest-pg18
        env:
        - name: POSTGRES_DB
          value: kg_db
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
        - name: init-sql
          mountPath: /docker-entrypoint-initdb.d/init.sql
          subPath: init.sql
        resources:
          requests:
            memory: "8Gi"
            cpu: "4"
          limits:
            memory: "16Gi"
            cpu: "8"
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 5
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-config
      - name: init-sql
        configMap:
          name: init-sql
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 200Gi
```

---

## 4. 监控配置

### 4.1 Prometheus配置

**Prometheus配置（带图查询监控）**：

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
    metrics_path: /metrics

  - job_name: 'kg-qa-api'
    static_configs:
      - targets: ['api:8008']
    metrics_path: /metrics

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    metrics_path: /metrics
```

### 4.2 Grafana仪表板

**Grafana仪表板配置（带图查询性能监控）**：

```json
{
  "dashboard": {
    "title": "知识图谱问答系统监控",
    "panels": [
      {
        "title": "图查询QPS",
        "targets": [
          {
            "expr": "rate(cypher_queries_total[5m])"
          }
        ]
      },
      {
        "title": "图查询延迟",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(cypher_query_duration_ms_bucket[5m]))"
          }
        ]
      },
      {
        "title": "向量检索延迟",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(vector_search_duration_ms_bucket[5m]))"
          }
        ]
      },
      {
        "title": "Text-to-Cypher延迟",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(text_to_cypher_duration_ms_bucket[5m]))"
          }
        ]
      },
      {
        "title": "图节点数",
        "targets": [
          {
            "expr": "kg_nodes_total"
          }
        ]
      },
      {
        "title": "图边数",
        "targets": [
          {
            "expr": "kg_edges_total"
          }
        ]
      }
    ]
  }
}
```

---

## 5. 备份与恢复

### 5.1 图数据备份

**图数据备份脚本（带Apache AGE）**：

```bash
#!/bin/bash
# backup_kg.sh - 知识图谱数据备份

set -e

BACKUP_DIR="/backups/kg-qa"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

mkdir -p "$BACKUP_DIR"

# 1. 备份图数据（Cypher导出）
echo "导出图数据..."
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT * FROM cypher('knowledge_graph', \$\$
        MATCH (n)
        RETURN n
    \$\$) AS (node agtype);
" > "$BACKUP_DIR/graph_$DATE.cypher"

# 2. 备份向量数据
echo "备份向量数据..."
docker exec kg-qa-postgres pg_dump -U postgres -d kg_db \
  -t entity_embeddings \
  -F c -f "$BACKUP_DIR/vectors_$DATE.dump"

# 3. 备份查询日志
echo "备份查询日志..."
docker exec kg-qa-postgres pg_dump -U postgres -d kg_db \
  -t query_logs \
  -F c -f "$BACKUP_DIR/logs_$DATE.dump"

# 4. 压缩备份
gzip "$BACKUP_DIR/graph_$DATE.cypher"
gzip "$BACKUP_DIR/vectors_$DATE.dump"
gzip "$BACKUP_DIR/logs_$DATE.dump"

# 5. 清理旧备份
find "$BACKUP_DIR" -name "*.gz" -mtime +$RETENTION_DAYS -delete

echo "备份完成！"
```

---

## 6. 性能调优

### 6.1 图查询优化

**图查询优化（带错误处理和性能测试）**：

```sql
-- 1. 分析图统计信息（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'age') THEN
            RAISE WARNING 'Apache AGE扩展未安装，无法执行图查询';
            RETURN;
        END IF;
        RAISE NOTICE '开始分析图统计信息';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '分析准备失败: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM cypher('knowledge_graph', $$
    MATCH (n)
    RETURN count(n) AS node_count
$$) AS (count BIGINT);

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM cypher('knowledge_graph', $$
    MATCH ()-[r]->()
    RETURN count(r) AS edge_count
$$) AS (count BIGINT);

-- 2. 检查图查询性能
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%cypher%'
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. 优化Cypher查询（使用索引提示）
-- 在Cypher查询中使用WHERE子句限制搜索范围
SELECT * FROM cypher('knowledge_graph', $$
    MATCH (p:Person {id: $person_id})-[:KNOWS]->(friend:Person)
    WHERE friend.age > 18
    RETURN friend.name
    LIMIT 20
$$) AS (name VARCHAR);
```

### 6.2 向量检索优化

**向量检索优化（带错误处理和性能测试）**：

```sql
-- 1. 检查向量索引（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
            RAISE WARNING 'pgvector扩展未安装，无法检查向量索引';
            RETURN;
        END IF;
        RAISE NOTICE '开始检查向量索引';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '检查准备失败: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE indexname = 'idx_entity_embeddings_vector';

-- 2. 重建向量索引（带错误处理）
REINDEX INDEX CONCURRENTLY idx_entity_embeddings_vector;

-- 3. 优化HNSW参数
-- 对于大规模数据，可以调整HNSW参数
ALTER INDEX idx_entity_embeddings_vector SET (m = 32, ef_construction = 128);

-- 4. 检查向量检索性能
SELECT
    query,
    calls,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%embedding%' OR query LIKE '%vector%'
ORDER BY mean_exec_time DESC
LIMIT 10;
```

---

## 7. 故障处理

### 7.1 常见故障处理

**常见故障处理（带错误处理和性能测试）**：

```bash
# 1. Apache AGE扩展加载失败
# 检查扩展是否安装
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT * FROM pg_extension WHERE extname = 'age';
"

# 重新加载扩展
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    CREATE EXTENSION IF NOT EXISTS age;
    LOAD 'age';
"

# 2. 图查询超时
# 检查查询超时设置
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SHOW statement_timeout;
"

# 增加超时时间
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SET statement_timeout = '5min';
"

# 3. 向量索引损坏
# 检查索引
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT * FROM pg_stat_user_indexes
    WHERE indexname = 'idx_entity_embeddings_vector';
"

# 重建索引
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    REINDEX INDEX CONCURRENTLY idx_entity_embeddings_vector;
"

# 4. 内存不足
# 检查内存使用
docker stats kg-qa-postgres

# 调整work_mem
docker exec kg-qa-postgres psql -U postgres -c "
    ALTER SYSTEM SET work_mem = '512MB';
    SELECT pg_reload_conf();
"
```

---

## 8. 扩容策略

### 8.1 图数据分区

**图数据分区策略（带错误处理和性能测试）**：

```sql
-- 1. 按实体类型分区（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'age') THEN
            RAISE WARNING 'Apache AGE扩展未安装，无法创建图标签';
            RETURN;
        END IF;

        PERFORM * FROM cypher('knowledge_graph', $$
            CREATE VLABEL Person_2025
        $$) as (v agtype);
        RAISE NOTICE '图标签 Person_2025 创建成功';

        PERFORM * FROM cypher('knowledge_graph', $$
            CREATE VLABEL Person_2024
        $$) as (v agtype);
        RAISE NOTICE '图标签 Person_2024 创建成功';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '创建图标签失败: %', SQLERRM;
    END;
END $$;

-- 2. 按时间分区查询日志
CREATE TABLE query_logs_2025_02 PARTITION OF query_logs
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- 3. 向量数据分区（按实体类型）
CREATE TABLE entity_embeddings_person (
    LIKE entity_embeddings INCLUDING ALL
) INHERITS (entity_embeddings);

CREATE TABLE entity_embeddings_concept (
    LIKE entity_embeddings INCLUDING ALL
) INHERITS (entity_embeddings);
```

---

## 9. 运维检查清单

### 9.1 日常检查

**日常检查清单（带错误处理和性能测试）**：

```bash
#!/bin/bash
# daily_check_kg.sh - 知识图谱系统日常检查

echo "=== 知识图谱问答系统日常检查 ==="

# 1. 数据库连接检查
echo "1. 检查数据库连接..."
docker exec kg-qa-postgres pg_isready -U postgres

# 2. Apache AGE扩展检查
echo "2. 检查Apache AGE扩展..."
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT extname, extversion FROM pg_extension WHERE extname = 'age';
"

# 3. 图数据统计
echo "3. 检查图数据统计..."
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT * FROM cypher('knowledge_graph', \$\$
        MATCH (n)
        RETURN count(n) AS node_count
    \$\$) AS (count BIGINT);
"

# 4. 向量索引检查
echo "4. 检查向量索引..."
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT indexname, idx_scan, idx_tup_read
    FROM pg_stat_user_indexes
    WHERE indexname = 'idx_entity_embeddings_vector';
"

# 5. 慢查询检查
echo "5. 检查慢查询..."
docker exec kg-qa-postgres psql -U postgres -d kg_db -c "
    SELECT query, calls, mean_exec_time
    FROM pg_stat_statements
    WHERE mean_exec_time > 2000
    ORDER BY mean_exec_time DESC
    LIMIT 5;
"

# 6. 磁盘空间检查
echo "6. 检查磁盘空间..."
df -h | grep postgres

echo "=== 检查完成 ==="
```

---

**完成**: 知识图谱问答系统部署运维
**字数**: ~7,500字
**涵盖**: Docker部署、Apache AGE初始化、Kubernetes部署、监控配置、备份恢复、性能调优、故障处理、扩容策略、运维检查

**返回**: [案例8主页](./README.md)
