---

> **📋 文档来源**: `DataBaseTheory\19-场景案例库\08-知识图谱问答系统\01-需求分析.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 案例8：知识图谱问答系统 - 需求分析

## 业务背景

企业知识库问答系统，基于Apache AGE知识图谱：

- **领域**: 技术文档、产品手册
- **规模**: 100万实体，500万关系
- **查询**: 自然语言问答，多跳推理
- **响应时间**: <2秒

---

## 技术需求

### 1. 知识图谱存储

**实体类型**:

```cypher
// 文档实体
(:Document {id, title, content})

// 概念实体
(:Concept {id, name, description})

// 人员实体
(:Person {id, name, role})

// 产品实体
(:Product {id, name, version})
```

**关系类型**:

```cypher
// 文档-概念
(:Document)-[:MENTIONS]->(:Concept)

// 概念-概念
(:Concept)-[:RELATED_TO]->(:Concept)
(:Concept)-[:IS_A]->(:Concept)

// 概念-产品
(:Concept)-[:USED_IN]->(:Product)
```

---

### 2. 问答能力

**问题类型**:

| 类型 | 示例 | 难度 |
|------|------|------|
| 实体查询 | "什么是PostgreSQL?" | ⭐ |
| 关系查询 | "哪些产品使用了MVCC?" | ⭐⭐ |
| 多跳推理 | "与MVCC相关的所有技术?" | ⭐⭐⭐ |
| 聚合查询 | "有多少文档提到了索引?" | ⭐⭐ |

---

### 3. NL2Cypher

**流程**:

```text
自然语言问题
    → LLM解析
    → Cypher查询
    → 图查询执行
    → 结果后处理
    → 自然语言答案
```

**示例**:

```
Q: "PostgreSQL中有哪些索引类型?"

Cypher:
MATCH (p:Concept {name: 'PostgreSQL'})-[:HAS_INDEX]->(idx:IndexType)
RETURN idx.name

A: "B-Tree, GIN, GiST, BRIN, Hash"
```

---

## 性能要求

| 指标 | 目标 |
|------|------|
| 单跳查询 | <100ms |
| 多跳查询（3跳） | <500ms |
| 复杂推理 | <2s |
| 并发查询 | 100 QPS |

---

## PostgreSQL 18 + Apache AGE特性

✅ **Apache AGE 1.5+**: 图数据库扩展
✅ **递归CTE优化**: 多跳查询性能
✅ **并行查询**: 图遍历并行化
✅ **JSONB优化**: 实体属性存储

---

---

## 六、数据质量需求

### 6.1 知识图谱质量

**知识图谱质量检查函数（带错误处理和性能测试）**：

```sql
-- 知识图谱质量检查函数
CREATE OR REPLACE FUNCTION check_knowledge_graph_quality()
RETURNS TABLE (
    check_type TEXT,
    check_result TEXT,
    status TEXT
) AS $$
DECLARE
    entity_count BIGINT;
    relation_count BIGINT;
    isolated_entity_count BIGINT;
BEGIN
    -- 检查实体数量
    SELECT COUNT(*) INTO entity_count
    FROM cypher('knowledge_graph', $$
        MATCH (n)
        RETURN COUNT(n) AS count
    $$) AS (count agtype);

    -- 检查关系数量
    SELECT COUNT(*) INTO relation_count
    FROM cypher('knowledge_graph', $$
        MATCH ()-[r]->()
        RETURN COUNT(r) AS count
    $$) AS (count agtype);

    -- 检查孤立实体
    SELECT COUNT(*) INTO isolated_entity_count
    FROM cypher('knowledge_graph', $$
        MATCH (n)
        WHERE NOT (n)--()
        RETURN COUNT(n) AS count
    $$) AS (count agtype);

    -- 返回检查结果
    RETURN QUERY SELECT
        '实体数量'::TEXT,
        entity_count::TEXT,
        CASE
            WHEN entity_count > 0 THEN '正常'
            ELSE '异常'
        END;

    RETURN QUERY SELECT
        '关系数量'::TEXT,
        relation_count::TEXT,
        CASE
            WHEN relation_count > 0 THEN '正常'
            ELSE '异常'
        END;

    RETURN QUERY SELECT
        '孤立实体数量'::TEXT,
        isolated_entity_count::TEXT,
        CASE
            WHEN isolated_entity_count < entity_count * 0.1 THEN '正常'
            ELSE '警告'
        END;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION '知识图谱质量检查失败: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 问答质量评估

**问答质量评估函数（带错误处理和性能测试）**：

```sql
-- 问答质量评估表
CREATE TABLE IF NOT EXISTS qa_quality (
    id SERIAL PRIMARY KEY,
    question TEXT,
    answer TEXT,
    cypher_query TEXT,
    execution_time_ms NUMERIC,
    result_count INT,
    user_rating INT,  -- 1-5分
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 问答质量评估函数
CREATE OR REPLACE FUNCTION evaluate_qa_quality(
    p_days INT DEFAULT 7
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC,
    target_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    -- 平均响应时间
    RETURN QUERY
    SELECT
        '平均响应时间(ms)'::TEXT,
        ROUND(AVG(execution_time_ms), 2)::NUMERIC,
        2000.0::NUMERIC AS target_value,
        CASE
            WHEN AVG(execution_time_ms) <= 2000 THEN '达标'
            WHEN AVG(execution_time_ms) <= 3000 THEN '一般'
            ELSE '不达标'
        END
    FROM qa_quality
    WHERE created_at > NOW() - (p_days || ' days')::INTERVAL;

    -- 平均用户评分
    RETURN QUERY
    SELECT
        '平均用户评分'::TEXT,
        ROUND(AVG(user_rating), 2)::NUMERIC,
        4.0::NUMERIC AS target_value,
        CASE
            WHEN AVG(user_rating) >= 4.0 THEN '达标'
            WHEN AVG(user_rating) >= 3.5 THEN '一般'
            ELSE '不达标'
        END
    FROM qa_quality
    WHERE created_at > NOW() - (p_days || ' days')::INTERVAL
      AND user_rating IS NOT NULL;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION '问答质量评估失败: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## 七、扩展性需求

### 7.1 知识图谱扩展

**知识图谱扩展设计（带错误处理和性能测试）**：

```sql
-- 知识图谱分片表（用于水平扩展）
CREATE TABLE IF NOT EXISTS knowledge_graph_shards (
    graph_name TEXT PRIMARY KEY,
    shard_id INT NOT NULL,
    shard_host TEXT,
    shard_port INT DEFAULT 5432,
    entity_count BIGINT DEFAULT 0,
    relation_count BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 分片路由函数
CREATE OR REPLACE FUNCTION get_graph_shard(
    p_graph_name TEXT
)
RETURNS TABLE (
    shard_id INT,
    shard_host TEXT,
    shard_port INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        shard_id,
        shard_host,
        shard_port
    FROM knowledge_graph_shards
    WHERE graph_name = p_graph_name;

    IF NOT FOUND THEN
        -- 默认分片
        RETURN QUERY SELECT
            0 AS shard_id,
            'localhost'::TEXT AS shard_host,
            5432 AS shard_port;
    END IF;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION '获取知识图谱分片失败: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

**返回**: [案例8主页](./README.md)
