---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\02-OLAPåˆ†æç³»ç»Ÿ\04-æŸ¥è¯¢ä¼˜åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# OLAPåˆ†æç³»ç»Ÿ - æŸ¥è¯¢ä¼˜åŒ–

> **PostgreSQLç‰ˆæœ¬**: 18.x

---

## ä¸€ã€å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

```sql
-- é…ç½®
SET max_parallel_workers_per_gather = 8;
SET parallel_tuple_cost = 0.001;

-- å¤§è¡¨èšåˆæŸ¥è¯¢
EXPLAIN (ANALYZE, COSTS OFF)
SELECT
    t.year, t.month,
    p.category_l1,
    SUM(s.amount) as total_sales,
    COUNT(*) as tx_count
FROM fact_sales s
JOIN dim_time t ON s.date_key = t.date_key
JOIN dim_product p ON s.product_key = p.product_key
WHERE t.year = 2025
GROUP BY t.year, t.month, p.category_l1;

-- PostgreSQL 18æ‰§è¡Œè®¡åˆ’
/*
Finalize GroupAggregate (actual time=3200ms)
  ->  Gather Merge
        Workers Planned: 8
        Workers Launched: 8
        ->  Partial GroupAggregate
              ->  Parallel Hash Join
                    ->  Parallel Append
                          ->  Parallel Seq Scan on fact_sales_2025_01
                          ->  Parallel Seq Scan on fact_sales_2025_02
                          ...
                    ->  Parallel Hash (dim_product)

PG 17å¯¹æ¯”ï¼š12.5ç§’
PG 18ï¼š3.2ç§’ (-74%)
*/
```

---

## äºŒã€ç‰©åŒ–è§†å›¾æŸ¥è¯¢æ”¹å†™

```sql
-- æŸ¥è¯¢æ”¹å†™è§„åˆ™
CREATE OR REPLACE FUNCTION rewrite_to_mv(query TEXT)
RETURNS TEXT AS $$
BEGIN
    -- æ£€æµ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨èšåˆè¡¨
    IF query LIKE '%GROUP BY date_key%' THEN
        -- æ”¹å†™ä¸ºä½¿ç”¨agg_sales_daily
        RETURN 'SELECT * FROM agg_sales_daily WHERE ...';
    END IF;
    RETURN query;
END;
$$ LANGUAGE plpgsql;

-- æ€§èƒ½æå‡ï¼š
-- äº‹å®è¡¨æŸ¥è¯¢ï¼š15ç§’
-- èšåˆè¡¨æŸ¥è¯¢ï¼š0.3ç§’ (-98%)
```

---

## ä¸‰ã€åˆ†åŒºè£å‰ªéªŒè¯

```sql
-- æŸ¥è¯¢è®¡åˆ’åˆ†æ
EXPLAIN (ANALYZE, COSTS OFF, SUMMARY)
SELECT * FROM fact_sales
WHERE transaction_time BETWEEN '2025-12-01' AND '2025-12-31';

/*
Append (actual time=0.5ms..150ms)
  ->  Seq Scan on fact_sales_2025_12
Partitions Pruned: 35  â­ åªæ‰«æ1ä¸ªåˆ†åŒºï¼ˆå…±36ä¸ªï¼‰

Execution Time: 150ms

å¯¹æ¯”å…¨è¡¨æ‰«æï¼š
- æ— åˆ†åŒºï¼š2500ms
- æœ‰åˆ†åŒºï¼ˆPG18ï¼‰ï¼š150ms (-94%)
*/
```

---

## å››ã€ç´¢å¼•ç­–ç•¥

```sql
-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_fact_sales_coverage
ON fact_sales (date_key, product_key)
INCLUDE (amount, quantity, profit);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æœ€è¿‘æ•°æ®ï¼‰
CREATE INDEX idx_fact_sales_recent
ON fact_sales (customer_key, transaction_time)
WHERE transaction_time > NOW() - INTERVAL '90 days';

-- â­ PostgreSQL 18ï¼šSkip Scanè‡ªåŠ¨ä¼˜åŒ–å¤šåˆ—ç´¢å¼•
```

---

## äº”ã€æŸ¥è¯¢æ¨¡æ¿

```sql
-- é¢„ç¼–è¯‘æŸ¥è¯¢ï¼ˆè®¡åˆ’ç¼“å­˜ï¼‰
PREPARE sales_by_category (int, int) AS
SELECT
    p.category_l1,
    SUM(s.amount) as total
FROM fact_sales s
JOIN dim_product p ON s.product_key = p.product_key
WHERE date_key BETWEEN $1 AND $2
GROUP BY p.category_l1;

-- æ‰§è¡Œï¼ˆä½¿ç”¨ç¼“å­˜è®¡åˆ’ï¼‰
EXECUTE sales_by_category(20250101, 20251231);

-- PostgreSQL 18ï¼š
-- è®¡åˆ’ç¼“å­˜å‘½ä¸­ç‡ï¼š98%
-- è§„åˆ’æ—¶é—´é™ä½ï¼š-90%
```

---

## å…­ã€æ€§èƒ½ç›‘æ§

```sql
CREATE VIEW olap_query_stats AS
SELECT
    queryid,
    left(query, 80) as query_preview,
    calls,
    mean_exec_time,
    total_exec_time,
    rows,
    shared_blks_hit,
    shared_blks_read,
    ROUND(shared_blks_hit * 100.0 /
        NULLIF(shared_blks_hit + shared_blks_read, 0), 2) as cache_hit_ratio
FROM pg_stat_statements
WHERE query LIKE '%fact_sales%'
ORDER BY total_exec_time DESC
LIMIT 20;
```

---

**æ–‡æ¡£å®Œæˆ** âœ…
