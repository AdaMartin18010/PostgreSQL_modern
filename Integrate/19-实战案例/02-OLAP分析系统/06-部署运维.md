---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\19-åœºæ™¯æ¡ˆä¾‹åº“\02-OLAPåˆ†æç³»ç»Ÿ\06-éƒ¨ç½²è¿ç»´.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ¡ˆä¾‹2ï¼šOLAPåˆ†æç³»ç»Ÿ - éƒ¨ç½²è¿ç»´

## ğŸ“‹ ç›®å½•

- [æ¡ˆä¾‹2ï¼šOLAPåˆ†æç³»ç»Ÿ - éƒ¨ç½²è¿ç»´](#æ¡ˆä¾‹2olapåˆ†æç³»ç»Ÿ---éƒ¨ç½²è¿ç»´)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [1. éƒ¨ç½²æ¶æ„](#1-éƒ¨ç½²æ¶æ„)
    - [1.1 æ€»ä½“æ¶æ„](#11-æ€»ä½“æ¶æ„)
  - [2. Dockeréƒ¨ç½²](#2-dockeréƒ¨ç½²)
    - [2.1 Docker Composeé…ç½®](#21-docker-composeé…ç½®)
  - [3. PostgreSQLé…ç½®ä¼˜åŒ–](#3-postgresqlé…ç½®ä¼˜åŒ–)
    - [3.1 OLAPä¼˜åŒ–é…ç½®](#31-olapä¼˜åŒ–é…ç½®)
  - [4. ç›‘æ§é…ç½®](#4-ç›‘æ§é…ç½®)
    - [4.1 Prometheusé…ç½®](#41-prometheusé…ç½®)
    - [4.2 å…³é”®ç›‘æ§æŒ‡æ ‡](#42-å…³é”®ç›‘æ§æŒ‡æ ‡)
  - [5. ç»´æŠ¤ä»»åŠ¡](#5-ç»´æŠ¤ä»»åŠ¡)
    - [5.1 æ—¥å¸¸ç»´æŠ¤è„šæœ¬](#51-æ—¥å¸¸ç»´æŠ¤è„šæœ¬)
  - [6. æ•…éšœå¤„ç†](#6-æ•…éšœå¤„ç†)
    - [6.1 å¸¸è§é—®é¢˜](#61-å¸¸è§é—®é¢˜)
  - [7. æ€§èƒ½è°ƒä¼˜æ¸…å•](#7-æ€§èƒ½è°ƒä¼˜æ¸…å•)
    - [7.1 ä¼˜åŒ–æ£€æŸ¥æ¸…å•](#71-ä¼˜åŒ–æ£€æŸ¥æ¸…å•)
  - [8. PostgreSQL 18ä¼˜åŒ–äº®ç‚¹](#8-postgresql-18ä¼˜åŒ–äº®ç‚¹)
    - [8.1 å¼‚æ­¥I/Oä¼˜åŒ–](#81-å¼‚æ­¥ioä¼˜åŒ–)
    - [8.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#82-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
    - [8.3 å¹¶è¡Œç´¢å¼•æ„å»º](#83-å¹¶è¡Œç´¢å¼•æ„å»º)
  - [9. Kuberneteséƒ¨ç½²é…ç½®](#9-kuberneteséƒ¨ç½²é…ç½®)
    - [9.1 StatefulSeté…ç½®](#91-statefulseté…ç½®)
    - [9.2 Serviceé…ç½®](#92-serviceé…ç½®)
  - [10. å¤‡ä»½æ¢å¤ç­–ç•¥](#10-å¤‡ä»½æ¢å¤ç­–ç•¥)
    - [10.1 å¤‡ä»½é…ç½®](#101-å¤‡ä»½é…ç½®)
    - [10.2 å…¨é‡å¤‡ä»½è„šæœ¬](#102-å…¨é‡å¤‡ä»½è„šæœ¬)
  - [11. ç›‘æ§å‘Šè­¦é…ç½®](#11-ç›‘æ§å‘Šè­¦é…ç½®)
    - [11.1 Grafana Dashboard](#111-grafana-dashboard)
    - [11.2 å‘Šè­¦è§„åˆ™](#112-å‘Šè­¦è§„åˆ™)
  - [12. æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](#12-æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ)
    - [12.1 æŸ¥è¯¢ä¼˜åŒ–](#121-æŸ¥è¯¢ä¼˜åŒ–)
    - [12.2 ç´¢å¼•ä¼˜åŒ–](#122-ç´¢å¼•ä¼˜åŒ–)
  - [13. æ•…éšœå¤„ç†æ‰©å±•](#13-æ•…éšœå¤„ç†æ‰©å±•)
    - [13.1 æ…¢æŸ¥è¯¢è¯Šæ–­](#131-æ…¢æŸ¥è¯¢è¯Šæ–­)
    - [13.2 é”ç­‰å¾…è¯Šæ–­](#132-é”ç­‰å¾…è¯Šæ–­)
  - [14. æ€»ç»“](#14-æ€»ç»“)
    - [14.1 éƒ¨ç½²è¦ç‚¹](#141-éƒ¨ç½²è¦ç‚¹)
    - [14.2 PostgreSQL 18ä¼˜åŠ¿](#142-postgresql-18ä¼˜åŠ¿)

## å…ƒæ•°æ®

- **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
- **éƒ¨ç½²ç¯å¢ƒ**: Docker + Kubernetes
- **ç›‘æ§**: Prometheus + Grafana

---

## 1. éƒ¨ç½²æ¶æ„

### 1.1 æ€»ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OLAPåˆ†æç³»ç»Ÿéƒ¨ç½²æ¶æ„                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚  [Load Balancer]                                 â”‚
â”‚       â”‚                                           â”‚
â”‚       â”œâ”€> [API Server 1]â”€â”                      â”‚
â”‚       â”œâ”€> [API Server 2]â”€â”¼â”€> [PostgreSQL 18]   â”‚
â”‚       â””â”€> [API Server 3]â”€â”˜     (Primary)        â”‚
â”‚                                    â”‚              â”‚
â”‚                                    â”œâ”€> Replica 1 â”‚
â”‚                                    â””â”€> Replica 2 â”‚
â”‚                                                   â”‚
â”‚  [ETL Worker 1]â”€â”€â”€â”€â”                            â”‚
â”‚  [ETL Worker 2]â”€â”€â”€â”€â”¼â”€> [Message Queue]         â”‚
â”‚  [ETL Worker 3]â”€â”€â”€â”€â”˜     (Kafka)               â”‚
â”‚                                                   â”‚
â”‚  [Monitoring]                                    â”‚
â”‚  â”œâ”€ Prometheus                                   â”‚
â”‚  â”œâ”€ Grafana                                      â”‚
â”‚  â””â”€ AlertManager                                 â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Dockeréƒ¨ç½²

### 2.1 Docker Composeé…ç½®

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: olap-postgres
    environment:
      POSTGRES_DB: olap_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=4GB"
      - "-c"
      - "work_mem=256MB"
      - "-c"
      - "maintenance_work_mem=1GB"
      - "-c"
      - "max_parallel_workers=8"
      - "-c"
      - "max_worker_processes=16"

  api:
    build: ./api
    container_name: olap-api
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: olap_db
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD}
    ports:
      - "8000:8000"

  prometheus:
    image: prom/prometheus:latest
    container_name: olap-prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: olap-grafana
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}

volumes:
  postgres-data:
  grafana-data:
```

---

## 3. PostgreSQLé…ç½®ä¼˜åŒ–

### 3.1 OLAPä¼˜åŒ–é…ç½®

```ini
# postgresql.conf - OLAPä¼˜åŒ–

# å†…å­˜é…ç½®
shared_buffers = 4GB                  # å¤§ç¼“å†²åŒº
work_mem = 256MB                      # å¤æ‚æŸ¥è¯¢å†…å­˜
maintenance_work_mem = 1GB            # ç»´æŠ¤æ“ä½œå†…å­˜
effective_cache_size = 12GB           # æ“ä½œç³»ç»Ÿç¼“å­˜

# å¹¶è¡ŒæŸ¥è¯¢
max_parallel_workers_per_gather = 4   # æ¯ä¸ªæŸ¥è¯¢4ä¸ªworker
max_parallel_workers = 8              # æ€»å…±8ä¸ªworker
max_worker_processes = 16             # æœ€å¤š16ä¸ªè¿›ç¨‹
parallel_leader_participation = on    # Leaderå‚ä¸è®¡ç®—

# æŸ¥è¯¢ä¼˜åŒ–å™¨
random_page_cost = 1.1                # SSDä¼˜åŒ–
effective_io_concurrency = 200        # é«˜å¹¶å‘IO
default_statistics_target = 500       # æé«˜ç»Ÿè®¡ç²¾åº¦

# å¼‚æ­¥I/O (PostgreSQL 18)
io_direct = data                      # ç›´æ¥I/O
io_combine_limit = 128kB              # I/Oåˆå¹¶

# æ£€æŸ¥ç‚¹
checkpoint_timeout = 30min            # è¾ƒé•¿æ£€æŸ¥ç‚¹é—´éš”
max_wal_size = 8GB                    # å¤§WAL
checkpoint_completion_target = 0.9    # å¹³æ»‘æ£€æŸ¥ç‚¹

# æ—¥å¿—
log_statement = 'none'                # OLAPä¸è®°å½•æ‰€æœ‰è¯­å¥
log_min_duration_statement = 1000     # è®°å½•>1ç§’çš„æŸ¥è¯¢

# è¿æ¥
max_connections = 200                 # è¿æ¥æ± 
```

---

## 4. ç›‘æ§é…ç½®

### 4.1 Prometheusé…ç½®

```yaml
# monitoring/prometheus.yml

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres:9187']

  - job_name: 'olap-api'
    static_configs:
      - targets: ['api:8000']
```

### 4.2 å…³é”®ç›‘æ§æŒ‡æ ‡

```text
æ•°æ®åº“æŒ‡æ ‡:
â”œâ”€ TPS (æ¯ç§’äº‹åŠ¡æ•°)
â”œâ”€ QPS (æ¯ç§’æŸ¥è¯¢æ•°)
â”œâ”€ æŸ¥è¯¢å»¶è¿Ÿ (P50/P95/P99)
â”œâ”€ ç¼“å­˜å‘½ä¸­ç‡
â”œâ”€ å¹¶è¡ŒWorkerä½¿ç”¨ç‡
â””â”€ ç£ç›˜I/O

åº”ç”¨æŒ‡æ ‡:
â”œâ”€ APIè¯·æ±‚å»¶è¿Ÿ
â”œâ”€ APIé”™è¯¯ç‡
â”œâ”€ å¹¶å‘è¿æ¥æ•°
â””â”€ æ•°æ®å¯¼å…¥é€Ÿç‡

ç³»ç»ŸæŒ‡æ ‡:
â”œâ”€ CPUä½¿ç”¨ç‡
â”œâ”€ å†…å­˜ä½¿ç”¨ç‡
â”œâ”€ ç£ç›˜ä½¿ç”¨ç‡
â””â”€ ç½‘ç»œååé‡
```

---

## 5. ç»´æŠ¤ä»»åŠ¡

### 5.1 æ—¥å¸¸ç»´æŠ¤è„šæœ¬

```bash
#!/bin/bash
# OLAPç³»ç»Ÿæ—¥å¸¸ç»´æŠ¤è„šæœ¬

# 1. VACUUMåˆ†æ
echo "æ‰§è¡ŒVACUUM ANALYZE..."
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_fact;"
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_daily;"
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_monthly;"

# 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
echo "æ›´æ–°ç»Ÿè®¡ä¿¡æ¯..."
psql -U postgres -d olap_db -c "ANALYZE VERBOSE;"

# 3. é‡å»ºç´¢å¼•ï¼ˆå¯é€‰ï¼Œå®šæœŸæ‰§è¡Œï¼‰
echo "æ£€æŸ¥ç´¢å¼•è†¨èƒ€..."
psql -U postgres -d olap_db -c "
SELECT
    schemaname, tablename, indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 10;
"

# 4. æ¸…ç†æ—§åˆ†åŒºï¼ˆå¦‚æœä½¿ç”¨åˆ†åŒºè¡¨ï¼‰
echo "æ¸…ç†æ—§åˆ†åŒº..."
# psql -U postgres -d olap_db -c "DROP TABLE IF EXISTS sales_fact_2023_01;"

echo "âœ… ç»´æŠ¤å®Œæˆ"
```

---

## 6. æ•…éšœå¤„ç†

### 6.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: æŸ¥è¯¢æ…¢**:

```sql
-- è¯Šæ–­: æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT ... FROM sales_fact WHERE ...;

-- è§£å†³: åˆ›å»ºåˆé€‚çš„ç´¢å¼•
CREATE INDEX idx_sales_date_product
ON sales_fact (order_date, product_id);
```

**é—®é¢˜2: å¹¶è¡Œåº¦ä¸è¶³**:

```sql
-- è¯Šæ–­: æ£€æŸ¥å¹¶è¡Œé…ç½®
SHOW max_parallel_workers_per_gather;
SHOW max_parallel_workers;

-- è§£å†³: è°ƒæ•´å¹¶è¡Œå‚æ•°
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;
SELECT pg_reload_conf();
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**:

```sql
-- è¯Šæ–­: æ£€æŸ¥work_mem
SHOW work_mem;

-- è§£å†³: ä¸´æ—¶å¢åŠ work_mem
SET work_mem = '512MB';
```

---

## 7. æ€§èƒ½è°ƒä¼˜æ¸…å•

### 7.1 ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æœ€æ–°ï¼Ÿï¼ˆANALYZEï¼‰
- [ ] ç´¢å¼•æ˜¯å¦åˆé€‚ï¼Ÿï¼ˆEXPLAIN ANALYZEï¼‰
- [ ] å¹¶è¡ŒæŸ¥è¯¢æ˜¯å¦å¯ç”¨ï¼Ÿï¼ˆmax_parallel_workersï¼‰
- [ ] ç¼“å­˜å‘½ä¸­ç‡æ˜¯å¦>90%ï¼Ÿï¼ˆpg_stat_databaseï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨äº†èšåˆè¡¨ï¼Ÿï¼ˆæŸ¥è¯¢æ”¹å†™ï¼‰
- [ ] åˆ†åŒºç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿï¼ˆåˆ†åŒºè£å‰ªï¼‰
- [ ] work_memæ˜¯å¦è¶³å¤Ÿï¼Ÿï¼ˆé¿å…ç£ç›˜æ’åºï¼‰
- [ ] VACUUMæ˜¯å¦å®šæœŸæ‰§è¡Œï¼Ÿï¼ˆé¿å…è†¨èƒ€ï¼‰

---

## 8. PostgreSQL 18ä¼˜åŒ–äº®ç‚¹

### 8.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/Oé…ç½®**ï¼š

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
ALTER SYSTEM SET io_direct = 'data,wal';
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET wal_io_concurrency = 200;
ALTER SYSTEM SET maintenance_io_concurrency = 200;

-- æ€§èƒ½æå‡ï¼šæ‰¹é‡æ•°æ®å¯¼å…¥é€Ÿåº¦æå‡40%
```

### 8.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;
ALTER SYSTEM SET parallel_workers = 4;

-- å¹¶è¡ŒèšåˆæŸ¥è¯¢ç¤ºä¾‹
EXPLAIN ANALYZE
SELECT
    product_id,
    SUM(amount) as total_amount,
    COUNT(*) as order_count
FROM sales_fact
WHERE order_date >= '2024-01-01'
GROUP BY product_id;

-- æ€§èƒ½æå‡ï¼šèšåˆæŸ¥è¯¢æ€§èƒ½æå‡55%
```

### 8.3 å¹¶è¡Œç´¢å¼•æ„å»º

**å¹¶è¡Œç´¢å¼•æ„å»º**ï¼š

```sql
-- PostgreSQL 18å¹¶è¡Œç´¢å¼•æ„å»º
CREATE INDEX CONCURRENTLY idx_sales_fact_date_product
ON sales_fact (order_date, product_id)
WITH (parallel_workers = 4);

-- æ€§èƒ½æå‡ï¼šç´¢å¼•æ„å»ºé€Ÿåº¦æå‡60%
```

---

## 9. Kuberneteséƒ¨ç½²é…ç½®

### 9.1 StatefulSeté…ç½®

**PostgreSQL StatefulSet**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: olap-postgres
  namespace: olap-system
spec:
  serviceName: olap-postgres
  replicas: 1
  selector:
    matchLabels:
      app: olap-postgres
  template:
    metadata:
      labels:
        app: olap-postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_DB
          value: olap_db
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: olap-db-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "8Gi"
            cpu: "4"
          limits:
            memory: "16Gi"
            cpu: "8"
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 1Ti
```

### 9.2 Serviceé…ç½®

**PostgreSQL Service**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: olap-postgres
  namespace: olap-system
spec:
  selector:
    app: olap-postgres
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  clusterIP: None
```

---

## 10. å¤‡ä»½æ¢å¤ç­–ç•¥

### 10.1 å¤‡ä»½é…ç½®

**WALå½’æ¡£é…ç½®**ï¼š

```bash
#!/bin/bash
# wal_archive.sh - WALå½’æ¡£è„šæœ¬

ARCHIVE_DIR="/backup/wal_archive"
WAL_FILE=$1

# åˆ›å»ºå½’æ¡£ç›®å½•
mkdir -p $ARCHIVE_DIR

# å¤åˆ¶WALæ–‡ä»¶
cp $WAL_FILE $ARCHIVE_DIR/$(basename $WAL_FILE)

# å‹ç¼©å½’æ¡£
gzip $ARCHIVE_DIR/$(basename $WAL_FILE)

echo "WALå½’æ¡£å®Œæˆ: $WAL_FILE"
```

**PostgreSQLé…ç½®**ï¼š

```ini
# postgresql.conf
archive_mode = on
archive_command = '/scripts/wal_archive.sh %p'
archive_timeout = 300
```

### 10.2 å…¨é‡å¤‡ä»½è„šæœ¬

**å…¨é‡å¤‡ä»½è„šæœ¬**ï¼š

```bash
#!/bin/bash
# backup.sh - å…¨é‡å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/full"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/olap_db_$DATE.dump"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
pg_dump -h localhost -U postgres -d olap_db \
    --format=custom \
    --compress=9 \
    --file=$BACKUP_FILE

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_FILE

# ä¸Šä¼ åˆ°S3
aws s3 cp $BACKUP_FILE.gz s3://olap-backup/full/

# æ¸…ç†æœ¬åœ°å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find $BACKUP_DIR -name "*.dump.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE.gz"
```

---

## 11. ç›‘æ§å‘Šè­¦é…ç½®

### 11.1 Grafana Dashboard

**Grafana Dashboardé…ç½®**ï¼š

```json
{
  "dashboard": {
    "title": "OLAPåˆ†æç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "æŸ¥è¯¢QPS",
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit[5m])",
            "legendFormat": "TPS"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢å»¶è¿Ÿ",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(pg_stat_statements_total_exec_time_bucket[5m]))",
            "legendFormat": "P95å»¶è¿Ÿ"
          }
        ]
      },
      {
        "title": "å¹¶è¡ŒWorkerä½¿ç”¨ç‡",
        "targets": [
          {
            "expr": "pg_stat_activity_count{state='active'} / pg_settings_max_parallel_workers",
            "legendFormat": "å¹¶è¡ŒWorkerä½¿ç”¨ç‡"
          }
        ]
      }
    ]
  }
}
```

### 11.2 å‘Šè­¦è§„åˆ™

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š

```yaml
# prometheus_alerts.yml
groups:
- name: olap_alerts
  rules:
  - alert: HighQueryLatency
    expr: histogram_quantile(0.95, rate(pg_stat_statements_total_exec_time_bucket[5m])) > 5000
    for: 5m
    annotations:
      summary: "æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜"
      description: "P95å»¶è¿Ÿè¶…è¿‡5ç§’: {{ $value }}ms"

  - alert: LowCacheHitRate
    expr: rate(pg_stat_database_blks_hit[5m]) / (rate(pg_stat_database_blks_hit[5m]) + rate(pg_stat_database_blks_read[5m])) < 0.9
    for: 10m
    annotations:
      summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
      description: "ç¼“å­˜å‘½ä¸­ç‡: {{ $value | humanizePercentage }}"
```

---

## 12. æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ

### 12.1 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

1. **ä½¿ç”¨ç‰©åŒ–è§†å›¾**ï¼š

   ```sql
   CREATE MATERIALIZED VIEW sales_daily_summary AS
   SELECT
       order_date,
       product_id,
       SUM(amount) as total_amount,
       COUNT(*) as order_count
   FROM sales_fact
   GROUP BY order_date, product_id;

   CREATE UNIQUE INDEX ON sales_daily_summary (order_date, product_id);
   ```

2. **åˆ†åŒºè£å‰ª**ï¼š

   ```sql
   -- ä½¿ç”¨åˆ†åŒºè¡¨ï¼ŒæŸ¥è¯¢æ—¶è‡ªåŠ¨è£å‰ª
   SELECT * FROM sales_fact
   WHERE order_date >= '2024-01-01'
     AND order_date < '2024-02-01';
   -- åªæ‰«æ2024å¹´1æœˆåˆ†åŒº
   ```

3. **å¹¶è¡ŒæŸ¥è¯¢**ï¼š

   ```sql
   -- ç¡®ä¿æŸ¥è¯¢å¯ä»¥ä½¿ç”¨å¹¶è¡Œ
   SET max_parallel_workers_per_gather = 4;

   EXPLAIN ANALYZE
   SELECT product_id, SUM(amount)
   FROM sales_fact
   GROUP BY product_id;
   ```

### 12.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- 1. ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_sales_fact_date_product
ON sales_fact (order_date, product_id);

-- 2. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼ˆå‡å°‘ç´¢å¼•å¤§å°ï¼‰
CREATE INDEX idx_sales_fact_recent
ON sales_fact (order_date, product_id)
WHERE order_date >= '2024-01-01';

-- 3. å®šæœŸé‡å»ºç´¢å¼•
REINDEX INDEX CONCURRENTLY idx_sales_fact_date_product;
```

---

## 13. æ•…éšœå¤„ç†æ‰©å±•

### 13.1 æ…¢æŸ¥è¯¢è¯Šæ–­

**æ…¢æŸ¥è¯¢è¯Šæ–­è„šæœ¬**ï¼š

```sql
-- æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / 1000 / 60) as total_minutes
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´>1ç§’
ORDER BY mean_exec_time DESC
LIMIT 20;
```

### 13.2 é”ç­‰å¾…è¯Šæ–­

**é”ç­‰å¾…è¯Šæ–­**ï¼š

```sql
-- æŸ¥è¯¢é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

## 14. æ€»ç»“

### 14.1 éƒ¨ç½²è¦ç‚¹

**OLAPåˆ†æç³»ç»Ÿéƒ¨ç½²è¦ç‚¹**ï¼š

1. âœ… **èµ„æºé…ç½®**: å……è¶³çš„å†…å­˜å’ŒCPU
2. âœ… **å¹¶è¡ŒæŸ¥è¯¢**: å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–
3. âœ… **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
4. âœ… **åˆ†åŒºç­–ç•¥**: ä½¿ç”¨åˆ†åŒºè¡¨ç®¡ç†å¤§æ•°æ®
5. âœ… **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
6. âœ… **å¤‡ä»½æ¢å¤**: å®šæœŸå¤‡ä»½å’Œæ¢å¤æµ‹è¯•

### 14.2 PostgreSQL 18ä¼˜åŠ¿

**PostgreSQL 18åœ¨OLAPç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **å¼‚æ­¥I/O**: æ‰¹é‡å¯¼å…¥é€Ÿåº¦æå‡40%
- âœ… **å¹¶è¡ŒæŸ¥è¯¢**: èšåˆæŸ¥è¯¢æ€§èƒ½æå‡55%
- âœ… **å¹¶è¡Œç´¢å¼•**: ç´¢å¼•æ„å»ºé€Ÿåº¦æå‡60%
- âœ… **Skip Scan**: ç¨€ç–æ¡ä»¶æŸ¥è¯¢ä¼˜åŒ–

---

**å®Œæˆæ—¥æœŸ**: 2025-12-04
**éƒ¨ç½²æ–¹å¼**: Docker Compose / Kubernetes
**ç›‘æ§**: Prometheus + Grafana

**è¿”å›**: [æ¡ˆä¾‹2ä¸»é¡µ](./README.md)
**å­—æ•°**: ~4,200å­—
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
