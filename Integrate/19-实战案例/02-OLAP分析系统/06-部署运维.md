---

> **📋 文档来源**: `DataBaseTheory\19-场景案例库\02-OLAP分析系统\06-部署运维.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# 案例2：OLAP分析系统 - 部署运维

## 📋 目录

- [案例2：OLAP分析系统 - 部署运维](#案例2olap分析系统---部署运维)
  - [📋 目录](#-目录)
  - [元数据](#元数据)
  - [1. 部署架构](#1-部署架构)
    - [1.1 总体架构](#11-总体架构)
  - [2. Docker部署](#2-docker部署)
    - [2.1 Docker Compose配置](#21-docker-compose配置)
  - [3. PostgreSQL配置优化](#3-postgresql配置优化)
    - [3.1 OLAP优化配置](#31-olap优化配置)
  - [4. 监控配置](#4-监控配置)
    - [4.1 Prometheus配置](#41-prometheus配置)
    - [4.2 关键监控指标](#42-关键监控指标)
  - [5. 维护任务](#5-维护任务)
    - [5.1 日常维护脚本](#51-日常维护脚本)
  - [6. 故障处理](#6-故障处理)
    - [6.1 常见问题](#61-常见问题)
  - [7. 性能调优清单](#7-性能调优清单)
    - [7.1 优化检查清单](#71-优化检查清单)

## 元数据

- **创建日期**: 2025-12-04
- **部署环境**: Docker + Kubernetes
- **监控**: Prometheus + Grafana

---

## 1. 部署架构

### 1.1 总体架构

```text
┌─────────────────────────────────────────────────┐
│              OLAP分析系统部署架构                 │
├─────────────────────────────────────────────────┤
│                                                   │
│  [Load Balancer]                                 │
│       │                                           │
│       ├─> [API Server 1]─┐                      │
│       ├─> [API Server 2]─┼─> [PostgreSQL 18]   │
│       └─> [API Server 3]─┘     (Primary)        │
│                                    │              │
│                                    ├─> Replica 1 │
│                                    └─> Replica 2 │
│                                                   │
│  [ETL Worker 1]────┐                            │
│  [ETL Worker 2]────┼─> [Message Queue]         │
│  [ETL Worker 3]────┘     (Kafka)               │
│                                                   │
│  [Monitoring]                                    │
│  ├─ Prometheus                                   │
│  ├─ Grafana                                      │
│  └─ AlertManager                                 │
│                                                   │
└─────────────────────────────────────────────────┘
```

---

## 2. Docker部署

### 2.1 Docker Compose配置

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: olap-postgres
    environment:
      POSTGRES_DB: olap_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=4GB"
      - "-c"
      - "work_mem=256MB"
      - "-c"
      - "maintenance_work_mem=1GB"
      - "-c"
      - "max_parallel_workers=8"
      - "-c"
      - "max_worker_processes=16"

  api:
    build: ./api
    container_name: olap-api
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: olap_db
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD}
    ports:
      - "8000:8000"

  prometheus:
    image: prom/prometheus:latest
    container_name: olap-prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: olap-grafana
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}

volumes:
  postgres-data:
  grafana-data:
```

---

## 3. PostgreSQL配置优化

### 3.1 OLAP优化配置

```ini
# postgresql.conf - OLAP优化

# 内存配置
shared_buffers = 4GB                  # 大缓冲区
work_mem = 256MB                      # 复杂查询内存
maintenance_work_mem = 1GB            # 维护操作内存
effective_cache_size = 12GB           # 操作系统缓存

# 并行查询
max_parallel_workers_per_gather = 4   # 每个查询4个worker
max_parallel_workers = 8              # 总共8个worker
max_worker_processes = 16             # 最多16个进程
parallel_leader_participation = on    # Leader参与计算

# 查询优化器
random_page_cost = 1.1                # SSD优化
effective_io_concurrency = 200        # 高并发IO
default_statistics_target = 500       # 提高统计精度

# 异步I/O (PostgreSQL 18)
io_direct = data                      # 直接I/O
io_combine_limit = 128kB              # I/O合并

# 检查点
checkpoint_timeout = 30min            # 较长检查点间隔
max_wal_size = 8GB                    # 大WAL
checkpoint_completion_target = 0.9    # 平滑检查点

# 日志
log_statement = 'none'                # OLAP不记录所有语句
log_min_duration_statement = 1000     # 记录>1秒的查询

# 连接
max_connections = 200                 # 连接池
```

---

## 4. 监控配置

### 4.1 Prometheus配置

```yaml
# monitoring/prometheus.yml

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres:9187']

  - job_name: 'olap-api'
    static_configs:
      - targets: ['api:8000']
```

### 4.2 关键监控指标

```text
数据库指标:
├─ TPS (每秒事务数)
├─ QPS (每秒查询数)
├─ 查询延迟 (P50/P95/P99)
├─ 缓存命中率
├─ 并行Worker使用率
└─ 磁盘I/O

应用指标:
├─ API请求延迟
├─ API错误率
├─ 并发连接数
└─ 数据导入速率

系统指标:
├─ CPU使用率
├─ 内存使用率
├─ 磁盘使用率
└─ 网络吞吐量
```

---

## 5. 维护任务

### 5.1 日常维护脚本

```bash
#!/bin/bash
# OLAP系统日常维护脚本

# 1. VACUUM分析
echo "执行VACUUM ANALYZE..."
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_fact;"
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_daily;"
psql -U postgres -d olap_db -c "VACUUM ANALYZE sales_monthly;"

# 2. 更新统计信息
echo "更新统计信息..."
psql -U postgres -d olap_db -c "ANALYZE VERBOSE;"

# 3. 重建索引（可选，定期执行）
echo "检查索引膨胀..."
psql -U postgres -d olap_db -c "
SELECT
    schemaname, tablename, indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 10;
"

# 4. 清理旧分区（如果使用分区表）
echo "清理旧分区..."
# psql -U postgres -d olap_db -c "DROP TABLE IF EXISTS sales_fact_2023_01;"

echo "✅ 维护完成"
```

---

## 6. 故障处理

### 6.1 常见问题

**问题1: 查询慢**:

```sql
-- 诊断: 检查是否使用了正确的索引
EXPLAIN (ANALYZE, BUFFERS)
SELECT ... FROM sales_fact WHERE ...;

-- 解决: 创建合适的索引
CREATE INDEX idx_sales_date_product
ON sales_fact (order_date, product_id);
```

**问题2: 并行度不足**:

```sql
-- 诊断: 检查并行配置
SHOW max_parallel_workers_per_gather;
SHOW max_parallel_workers;

-- 解决: 调整并行参数
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_workers = 8;
SELECT pg_reload_conf();
```

**问题3: 内存不足**:

```sql
-- 诊断: 检查work_mem
SHOW work_mem;

-- 解决: 临时增加work_mem
SET work_mem = '512MB';
```

---

## 7. 性能调优清单

### 7.1 优化检查清单

- [ ] 统计信息是否最新？（ANALYZE）
- [ ] 索引是否合适？（EXPLAIN ANALYZE）
- [ ] 并行查询是否启用？（max_parallel_workers）
- [ ] 缓存命中率是否>90%？（pg_stat_database）
- [ ] 是否使用了聚合表？（查询改写）
- [ ] 分区策略是否合理？（分区裁剪）
- [ ] work_mem是否足够？（避免磁盘排序）
- [ ] VACUUM是否定期执行？（避免膨胀）

---

**完成日期**: 2025-12-04
**部署方式**: Docker Compose / Kubernetes
**监控**: Prometheus + Grafana

**返回**: [案例2主页](./README.md)
