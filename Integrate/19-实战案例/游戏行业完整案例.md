# PostgreSQL游戏行业完整案例

> **PostgreSQL版本**: 18.x
> **行业**: 游戏
> **特点**: 高并发、实时性、玩家行为分析、排行榜
> **参考案例**: [游戏场景/玩家行为分析系统](./游戏场景/玩家行为分析系统.md)

---

## 📋 目录

- [PostgreSQL游戏行业完整案例](#postgresql游戏行业完整案例)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 游戏行业特点](#11-游戏行业特点)
    - [1.2 核心场景](#12-核心场景)
  - [2. 游戏行业核心场景](#2-游戏行业核心场景)
    - [2.1 玩家系统](#21-玩家系统)
    - [2.2 排行榜系统](#22-排行榜系统)
    - [2.3 玩家行为分析](#23-玩家行为分析)
  - [3. 技术架构](#3-技术架构)
    - [3.1 高并发架构](#31-高并发架构)
    - [3.2 数据分层](#32-数据分层)
  - [4. 数据库设计](#4-数据库设计)
    - [4.1 玩家表设计](#41-玩家表设计)
    - [4.2 游戏数据表设计](#42-游戏数据表设计)
  - [5. 性能优化](#5-性能优化)
    - [5.1 查询优化](#51-查询优化)
    - [5.2 缓存策略](#52-缓存策略)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 玩家系统](#61-玩家系统)
    - [6.2 排行榜系统](#62-排行榜系统)
    - [6.3 行为分析](#63-行为分析)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

### 1.1 游戏行业特点

游戏行业对数据库的要求：

- ✅ **高并发**: 百万+在线玩家
- ✅ **低延迟**: P99 < 50ms
- ✅ **实时性**: 实时数据更新
- ✅ **排行榜**: 实时排行榜
- ✅ **数据分析**: 玩家行为分析

### 1.2 核心场景

- **玩家系统**: 玩家数据管理
- **游戏数据**: 游戏状态存储
- **排行榜**: 实时排行榜
- **行为分析**: 玩家行为分析
- **支付系统**: 游戏内支付

---

## 2. 游戏行业核心场景

### 2.1 玩家系统

**核心需求**:

- 玩家数据管理
- 实时数据同步
- 数据持久化
- 高并发读写

**技术方案**:

```sql
-- 玩家表
CREATE TABLE players (
    player_id BIGSERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    level INT DEFAULT 1,
    experience BIGINT DEFAULT 0,
    gold BIGINT DEFAULT 0,
    gems INT DEFAULT 0,
    last_login TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 玩家数据表（JSONB存储灵活数据）
CREATE TABLE player_data (
    player_id BIGINT PRIMARY KEY REFERENCES players(player_id),
    game_data JSONB,
    inventory JSONB,
    achievements JSONB,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_players_username ON players(username);
CREATE INDEX idx_player_data_gin ON player_data USING GIN(game_data);
```

### 2.2 排行榜系统

**核心需求**:

- 实时排行榜
- 多维度排行
- 高效查询
- 实时更新

**技术方案**:

```sql
-- 排行榜表
CREATE TABLE leaderboard (
    player_id BIGINT PRIMARY KEY REFERENCES players(player_id),
    score BIGINT NOT NULL,
    rank INT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_leaderboard_score ON leaderboard(score DESC);

-- 实时排行榜查询
SELECT
    p.player_id,
    p.username,
    l.score,
    l.rank
FROM leaderboard l
JOIN players p ON p.player_id = l.player_id
ORDER BY l.score DESC
LIMIT 100;

-- 使用窗口函数计算排名
UPDATE leaderboard
SET rank = subquery.rank
FROM (
    SELECT
        player_id,
        ROW_NUMBER() OVER (ORDER BY score DESC) as rank
    FROM leaderboard
) subquery
WHERE leaderboard.player_id = subquery.player_id;
```

### 2.3 玩家行为分析

**参考**: [游戏场景/玩家行为分析系统](./游戏场景/玩家行为分析系统.md)

**核心需求**:

- 行为数据采集
- 实时分析
- 用户画像
- 推荐系统

**技术方案**:

```sql
-- 玩家行为表（分区）
CREATE TABLE player_events (
    event_id BIGSERIAL,
    player_id BIGINT NOT NULL,
    event_type TEXT NOT NULL,
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (event_id, created_at)
) PARTITION BY RANGE (created_at);

-- 按月分区
CREATE TABLE player_events_2025_01 PARTITION OF player_events
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 行为分析查询
SELECT
    event_type,
    COUNT(*) as event_count,
    COUNT(DISTINCT player_id) as unique_players,
    AVG((event_data->>'duration')::NUMERIC) as avg_duration
FROM player_events
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY event_type
ORDER BY event_count DESC;
```

---

## 3. 技术架构

### 3.1 高并发架构

```text
游戏服务器 (多实例)
    ↓
负载均衡
    ↓
连接池 (PgBouncer)
    ↓
PostgreSQL集群
├── 主库 (读写 - 玩家数据)
├── 从库1 (只读 - 排行榜)
├── 从库2 (只读 - 分析)
└── 从库3 (只读 - 报表)
    ↓
缓存层 (Redis)
```

### 3.2 数据分层

```text
热数据 (Redis缓存)
    ↓
温数据 (PostgreSQL主库)
    ↓
冷数据 (PostgreSQL从库/归档)
```

---

## 4. 数据库设计

### 4.1 玩家表设计

```sql
-- 玩家表
CREATE TABLE players (
    player_id BIGSERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    email TEXT,
    level INT DEFAULT 1,
    experience BIGINT DEFAULT 0,
    gold BIGINT DEFAULT 0,
    gems INT DEFAULT 0,
    vip_level INT DEFAULT 0,
    last_login TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_players_username ON players(username);
CREATE INDEX idx_players_level ON players(level DESC);
CREATE INDEX idx_players_last_login ON players(last_login DESC);
```

### 4.2 游戏数据表设计

```sql
-- 游戏数据表（JSONB）
CREATE TABLE game_data (
    player_id BIGINT PRIMARY KEY REFERENCES players(player_id),
    game_state JSONB,
    inventory JSONB,
    achievements JSONB,
    quests JSONB,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- GIN索引
CREATE INDEX idx_game_data_state ON game_data USING GIN(game_state);
CREATE INDEX idx_game_data_inventory ON game_data USING GIN(inventory);
```

---

## 5. 性能优化

### 5.1 查询优化

```sql
-- 优化玩家查询
CREATE INDEX idx_players_level_score ON players(level DESC, experience DESC);

-- 优化排行榜查询
CREATE INDEX idx_leaderboard_score ON leaderboard(score DESC);

-- 使用物化视图预聚合
CREATE MATERIALIZED VIEW mv_player_stats AS
SELECT
    player_id,
    COUNT(*) as event_count,
    SUM((event_data->>'duration')::NUMERIC) as total_duration
FROM player_events
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY player_id;

CREATE UNIQUE INDEX ON mv_player_stats(player_id);
```

### 5.2 缓存策略

```text
缓存层次:
1. 应用层缓存 (Redis) - 热点玩家数据
2. 连接池缓存 - 连接复用
3. PostgreSQL共享缓冲区 - 数据缓存
```

---

## 6. 最佳实践

### 6.1 玩家系统

- ✅ **数据分离**: 热数据缓存，冷数据数据库
- ✅ **批量更新**: 批量更新减少写入次数
- ✅ **异步处理**: 非关键路径异步化
- ✅ **数据压缩**: JSONB数据压缩

### 6.2 排行榜系统

- ✅ **实时更新**: 使用触发器实时更新
- ✅ **索引优化**: 创建合适索引
- ✅ **分页查询**: 使用LIMIT/OFFSET分页
- ✅ **缓存策略**: 缓存热门排行榜

### 6.3 行为分析

- ✅ **分区表**: 按时间分区
- ✅ **批量写入**: 批量写入提高性能
- ✅ **物化视图**: 预聚合数据
- ✅ **异步分析**: 异步处理分析任务

---

## 📚 相关文档

- [游戏场景/玩家行为分析系统](./游戏场景/玩家行为分析系统.md) - 玩家行为分析案例
- [07-实时推荐系统](./07-实时推荐系统/README.md) - 推荐系统
- [10-AI与机器学习](../10-AI与机器学习/README.md) - AI与机器学习

---

**最后更新**: 2025年1月
**状态**: ✅ 完成
