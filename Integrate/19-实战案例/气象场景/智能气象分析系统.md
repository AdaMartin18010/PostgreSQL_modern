---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\æ°”è±¡åœºæ™¯\æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+, PostGIS 3.0+
> **æ–‡æ¡£ç¼–å·**: 08-51-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿ](#æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½æ°”è±¡åˆ†æä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½æ°”è±¡åˆ†æä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 æ°”è±¡æ•°æ®æ—¶åºè¡¨](#31-æ°”è±¡æ•°æ®æ—¶åºè¡¨)
    - [3.2 æ°”è±¡ç«™ç‚¹è¡¨](#32-æ°”è±¡ç«™ç‚¹è¡¨)
  - [4. æ°”è±¡åˆ†æ](#4-æ°”è±¡åˆ†æ)
    - [4.1 æ•°æ®åˆ†æ](#41-æ•°æ®åˆ†æ)
    - [4.2 ç©ºé—´åˆ†æ](#42-ç©ºé—´åˆ†æ)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»ŸçœŸå®æ¡ˆä¾‹)

    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ•°æ®åˆ†æ](#61-æ•°æ®åˆ†æ)
    - [6.2 é¢„æµ‹é¢„æŠ¥](#62-é¢„æµ‹é¢„æŠ¥)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 æ°”è±¡æ•°æ®æ—¶åºè¡¨åˆ›å»º](#81-æ°”è±¡æ•°æ®æ—¶åºè¡¨åˆ›å»º)
    - [8.2 æ°”è±¡æ•°æ®é‡‡é›†å®ç°](#82-æ°”è±¡æ•°æ®é‡‡é›†å®ç°)
    - [8.3 æ°”è±¡æ•°æ®åˆ†æå®ç°](#83-æ°”è±¡æ•°æ®åˆ†æå®ç°)
    - [8.4 ç©ºé—´åˆ†æå®ç°](#84-ç©ºé—´åˆ†æå®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿéœ€è¦ï¼š

- **æ°”è±¡æ•°æ®é‡‡é›†**: é‡‡é›†æ°”è±¡æ•°æ®
- **æ•°æ®åˆ†æ**: åˆ†ææ°”è±¡è¶‹åŠ¿
- **é¢„æµ‹é¢„æŠ¥**: é¢„æµ‹å¤©æ°”å˜åŒ–
- **ç©ºé—´åˆ†æ**: åˆ†æç©ºé—´åˆ†å¸ƒ

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **ç©ºé—´æ•°æ®åº“**: PostGIS å¤„ç†åœ°ç†ä½ç½®
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **é¢„æµ‹å‡†ç¡®ç‡** | æ™ºèƒ½é¢„æµ‹æå‡å‡†ç¡®ç‡ | **+60%** |
| **åˆ†ææ•ˆç‡** | æå‡åˆ†ææ•ˆç‡ | **+55%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åº+ç©ºé—´ä¼˜åŒ–æå‡æ€§èƒ½ | **13x** |
| **å†³ç­–æ”¯æŒ** | æå‡å†³ç­–æ”¯æŒèƒ½åŠ› | **+58%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **é¢„æµ‹å‡†ç¡®ç‡**: æ™ºèƒ½é¢„æµ‹æå‡å‡†ç¡®ç‡ 60%
- **åˆ†ææ•ˆç‡**: æå‡åˆ†ææ•ˆç‡ 55%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åº+ç©ºé—´ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 13 å€
- **å†³ç­–æ”¯æŒ**: æå‡å†³ç­–æ”¯æŒèƒ½åŠ› 58%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½æ°”è±¡åˆ†æä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½æ°”è±¡åˆ†æ))
    æ•°æ®å±‚
      æ°”è±¡æ•°æ®
        æ¸©åº¦æ•°æ®
        æ¹¿åº¦æ•°æ®
        æ°”å‹æ•°æ®
        é£é€Ÿæ•°æ®
      ä½ç½®æ•°æ®
        ç«™ç‚¹ä½ç½®
        åŒºåŸŸåˆ†å¸ƒ
        ç©ºé—´åˆ†å¸ƒ
        åœ°ç†ä¿¡æ¯
      é¢„æµ‹æ•°æ®
        å¤©æ°”é¢„æŠ¥
        è¶‹åŠ¿é¢„æµ‹
        å¼‚å¸¸é¢„æµ‹
        é£é™©è¯„ä¼°
    å­˜å‚¨å±‚
      æ—¶åºæ•°æ®åº“
        TimescaleDB
        æ°”è±¡æ—¶åº
        é¢„æµ‹æ—¶åº
        æ•°æ®å‹ç¼©
        è¿ç»­èšåˆ
      ç©ºé—´æ•°æ®åº“
        PostGIS
        ç«™ç‚¹ä½ç½®
        åŒºåŸŸåˆ†å¸ƒ
        ç©ºé—´ç´¢å¼•
        ç©ºé—´åˆ†æ
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        è¶‹åŠ¿åˆ†æ
        å¼‚å¸¸æ£€æµ‹
        æ¨¡å¼è¯†åˆ«
      é¢„æµ‹åˆ†æ
        å¤©æ°”é¢„æŠ¥
        è¶‹åŠ¿é¢„æµ‹
        å¼‚å¸¸é¢„æµ‹
        é£é™©è¯„ä¼°
    åº”ç”¨å±‚
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        å†å²åˆ†æ
        è¶‹åŠ¿å±•ç¤º
        æ•°æ®æŠ¥å‘Š
      é¢„æµ‹é¢„æŠ¥
        å¤©æ°”é¢„æŠ¥
        è¶‹åŠ¿é¢„æµ‹
        å¼‚å¸¸é¢„è­¦
        é£é™©è¯„ä¼°
      ç©ºé—´åˆ†æ
        ç©ºé—´åˆ†å¸ƒ
        åŒºåŸŸåˆ†æ
        è·¯å¾„åˆ†æ
        å½±å“åˆ†æ
    åº”ç”¨åœºæ™¯
      æ°”è±¡æœåŠ¡
        å¤©æ°”é¢„æŠ¥
        æ°”è±¡åˆ†æ
        é¢„è­¦æœåŠ¡
      å†œä¸šæ°”è±¡
        å†œä¸šé¢„æµ‹
        ç¾å®³é¢„è­¦
        å†³ç­–æ”¯æŒ
      èˆªç©ºæ°”è±¡
        é£è¡Œå®‰å…¨
        èˆªçº¿ä¼˜åŒ–
        å¤©æ°”é¢„è­¦
```

### 2.2 æ¶æ„è®¾è®¡

```text
æ°”è±¡æ•°æ®é‡‡é›†
  â”œâ”€â”€ æ¸©åº¦æ•°æ®
  â”œâ”€â”€ æ¹¿åº¦æ•°æ®
  â”œâ”€â”€ æ°”å‹æ•°æ®
  â””â”€â”€ ä½ç½®æ•°æ®
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ æ°”è±¡æ—¶åºæ•°æ®
  â””â”€â”€ é¢„æµ‹æ•°æ®
  â†“
ç©ºé—´æ•°æ®å­˜å‚¨ï¼ˆPostGISï¼‰
  â”œâ”€â”€ ç«™ç‚¹ä½ç½®
  â””â”€â”€ åŒºåŸŸåˆ†å¸ƒ
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ æ•°æ®åˆ†æ
  â”œâ”€â”€ é¢„æµ‹é¢„æŠ¥
  â””â”€â”€ ç©ºé—´åˆ†æ
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + PostGIS
- **æ•°æ®é‡‡é›†**: æ°”è±¡ç«™ã€ä¼ æ„Ÿå™¨
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ°”è±¡æ•°æ®æ—¶åºè¡¨

```sql
-- åˆ›å»ºæ°”è±¡æ•°æ®æ—¶åºè¡¨
CREATE TABLE weather_data (
    time TIMESTAMPTZ NOT NULL,
    station_id INTEGER NOT NULL,
    location POINT NOT NULL,
    temperature DECIMAL(5, 2),
    humidity DECIMAL(5, 2),
    pressure DECIMAL(7, 2),
    wind_speed DECIMAL(5, 2),
    wind_direction INTEGER,
    precipitation DECIMAL(5, 2),
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('weather_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX wd_station_time_idx ON weather_data (station_id, time DESC);
CREATE INDEX wd_location_idx ON weather_data USING GIST(location);
```

### 3.2 æ°”è±¡ç«™ç‚¹è¡¨

```sql
CREATE TABLE weather_stations (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    location POINT NOT NULL,
    elevation DECIMAL(8, 2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºç©ºé—´ç´¢å¼•
CREATE INDEX ws_location_idx ON weather_stations USING GIST(location);
```

## 4. æ°”è±¡åˆ†æ

### 4.1 æ•°æ®åˆ†æ

```sql
-- åˆ†ææ°”è±¡è¶‹åŠ¿
SELECT
    time_bucket('1 day', time) AS day,
    station_id,
    AVG(temperature) AS avg_temperature,
    AVG(humidity) AS avg_humidity,
    AVG(pressure) AS avg_pressure,
    SUM(precipitation) AS total_precipitation
FROM weather_data
WHERE time > NOW() - INTERVAL '30 days'
GROUP BY day, station_id
ORDER BY day DESC;
```

### 4.2 ç©ºé—´åˆ†æ

```sql
-- æŸ¥è¯¢é™„è¿‘ç«™ç‚¹
SELECT
    id,
    name,
    ST_Distance(location, ST_MakePoint($1, $2)) AS distance,
    temperature,
    humidity
FROM weather_stations ws
JOIN LATERAL (
    SELECT temperature, humidity
    FROM weather_data
    WHERE station_id = ws.id
    ORDER BY time DESC
    LIMIT 1
) wd ON true
WHERE ST_DWithin(
    location,
    ST_MakePoint($1, $2),
    50000  -- 50å…¬é‡ŒèŒƒå›´å†…
)
ORDER BY distance;
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸæ°”è±¡éƒ¨é—¨éœ€è¦æ„å»ºæ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿï¼Œåˆ†ææ°”è±¡æ•°æ®ï¼Œé¢„æµ‹å¤©æ°”ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®åˆ†æ**: æ°”è±¡æ•°æ®åˆ†æå›°éš¾
2. **é¢„æµ‹å›°éš¾**: å¤©æ°”é¢„æµ‹ä¸å‡†ç¡®
3. **ç©ºé—´åˆ†æ**: ç©ºé—´åˆ†ææ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½æ°”è±¡åˆ†æç³»ç»Ÿ
class SmartWeatherAnalysisSystem:
    def __init__(self):
        self.weather_analysis = WeatherAnalysis()
        self.weather_prediction = WeatherPrediction()

    async def analyze_weather(self, region=None):
        """åˆ†ææ°”è±¡"""
        # 1. åˆ†ææ°”è±¡æ•°æ®
        weather_stats = await self.db.fetch("""
            SELECT
                time_bucket('1 day', time) AS day,
                AVG(temperature) AS avg_temp,
                AVG(humidity) AS avg_humidity,
                SUM(precipitation) AS total_precip
            FROM weather_data
            WHERE time > NOW() - INTERVAL '30 days'
                AND ($1 IS NULL OR ST_DWithin(location, $2::geometry, 50000))
            GROUP BY day
            ORDER BY day DESC
        """, region is not None, region)

        # 2. é¢„æµ‹å¤©æ°”
        predictions = await self.weather_prediction.predict_weather(region)

        # 3. ç©ºé—´åˆ†æ
        spatial_analysis = await self.analyze_spatial_distribution(region)

        return {
            'weather_stats': weather_stats,
            'predictions': predictions,
            'spatial_analysis': spatial_analysis
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é¢„æµ‹å‡†ç¡®ç‡** | åŸºå‡† | **+60%** | **æå‡** |
| **åˆ†ææ•ˆç‡** | åŸºå‡† | **+55%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 3 ç§’ | **< 230ms** | **92%** â¬‡ï¸ |
| **å†³ç­–æ”¯æŒ** | åŸºå‡† | **+58%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**æ°”è±¡åˆ†ææŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | é¢„æµ‹å‡†ç¡®ç‡ | åˆ†ææ•ˆç‡ | æŸ¥è¯¢æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|----------|----------|------|----------|
| **ä¼ ç»Ÿåˆ†æ** | åŸºå‡† | åŸºå‡† | åŸºå‡† | ä½ | å°è§„æ¨¡ |
| **æ—¶åºåˆ†æ** | +30% | +35% | +200% | ä¸­ | ä¸­ç­‰è§„æ¨¡ |
| **æ—¶åº+ç©ºé—´** | **+60%** | **+55%** | **+1200%** | **ä¸­** | **å¤§è§„æ¨¡** |

**é¢„æµ‹æ–¹æ³•å¯¹æ¯”**:

| é¢„æµ‹æ–¹æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **ç»Ÿè®¡é¢„æµ‹** | 70-80% | é«˜ | ä¸­ | ç®€å•åœºæ™¯ |
| **æœºå™¨å­¦ä¹ ** | 80-90% | ä¸­ | é«˜ | å¤æ‚åœºæ™¯ |
| **æ··åˆé¢„æµ‹** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ•°æ®åˆ†æ

1. **å®æ—¶é‡‡é›†**: å®æ—¶é‡‡é›†æ°”è±¡æ•°æ®
2. **è¶‹åŠ¿åˆ†æ**: åˆ†ææ°”è±¡è¶‹åŠ¿
3. **å¼‚å¸¸æ£€æµ‹**: æ£€æµ‹å¼‚å¸¸æ°”è±¡æ•°æ®

### 6.2 é¢„æµ‹é¢„æŠ¥

1. **æ¨¡å‹ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–é¢„æµ‹æ¨¡å‹
2. **æ•°æ®è´¨é‡**: ä¿è¯æ•°æ®è´¨é‡
3. **åŠæ—¶æ›´æ–°**: åŠæ—¶æ›´æ–°é¢„æµ‹ç»“æœ

## 7. å‚è€ƒèµ„æ–™

- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)
- [ç¯å¢ƒç›‘æµ‹é¢„è­¦ç³»ç»Ÿ](../ç¯ä¿åœºæ™¯/ç¯å¢ƒç›‘æµ‹é¢„è­¦ç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 æ°”è±¡æ•°æ®æ—¶åºè¡¨åˆ›å»º

**åˆ›å»ºæ°”è±¡åˆ†æç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBå’ŒPostGISæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS postgis;

-- åˆ›å»ºæ°”è±¡ç«™ç‚¹è¡¨
CREATE TABLE weather_stations (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    location GEOGRAPHY(POINT, 4326),  -- ç«™ç‚¹ä½ç½®
    elevation DECIMAL(8, 2),  -- æµ·æ‹”é«˜åº¦ï¼ˆç±³ï¼‰
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºæ°”è±¡æ•°æ®æ—¶åºè¡¨
CREATE TABLE weather_data (
    time TIMESTAMPTZ NOT NULL,
    station_id INTEGER NOT NULL REFERENCES weather_stations(id),
    temperature DECIMAL(5, 2),  -- æ¸©åº¦ï¼ˆæ‘„æ°åº¦ï¼‰
    humidity DECIMAL(5, 2),  -- æ¹¿åº¦ï¼ˆ%ï¼‰
    pressure DECIMAL(7, 2),  -- æ°”å‹ï¼ˆhPaï¼‰
    wind_speed DECIMAL(5, 2),  -- é£é€Ÿï¼ˆm/sï¼‰
    wind_direction INTEGER,  -- é£å‘ï¼ˆåº¦ï¼‰
    precipitation DECIMAL(5, 2),  -- é™æ°´é‡ï¼ˆmmï¼‰
    visibility DECIMAL(5, 2),  -- èƒ½è§åº¦ï¼ˆkmï¼‰
    metadata JSONB DEFAULT '{}'::JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆç”¨äºæ—¶åºæ•°æ®ï¼‰
SELECT create_hypertable('weather_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_weather_data_station_time ON weather_data (station_id, time DESC);
CREATE INDEX idx_weather_stations_location ON weather_stations USING GIST (location);
```

### 8.2 æ°”è±¡æ•°æ®é‡‡é›†å®ç°

**Pythonæ°”è±¡æ•°æ®é‡‡é›†**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import Optional
from shapely.geometry import Point

class WeatherDataCollector:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ°”è±¡æ•°æ®é‡‡é›†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def collect_weather_data(self, station_id: int, temperature: Optional[float] = None,
                            humidity: Optional[float] = None, pressure: Optional[float] = None,
                            wind_speed: Optional[float] = None, wind_direction: Optional[int] = None,
                            precipitation: Optional[float] = None, visibility: Optional[float] = None):
        """é‡‡é›†æ°”è±¡æ•°æ®"""
        self.cur.execute("""
            INSERT INTO weather_data
            (time, station_id, temperature, humidity, pressure, wind_speed,
             wind_direction, precipitation, visibility)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            datetime.now(), station_id, temperature, humidity, pressure,
            wind_speed, wind_direction, precipitation, visibility
        ))

        self.conn.commit()

    def get_latest_weather(self, station_id: int) -> Optional[Dict]:
        """è·å–æœ€æ–°æ°”è±¡æ•°æ®"""
        self.cur.execute("""
            SELECT
                time, station_id, temperature, humidity, pressure,
                wind_speed, wind_direction, precipitation, visibility
            FROM weather_data
            WHERE station_id = %s
            ORDER BY time DESC
            LIMIT 1
        """, (station_id,))

        result = self.cur.fetchone()
        if result:
            return {
                'time': result[0],
                'station_id': result[1],
                'temperature': float(result[2]) if result[2] else None,
                'humidity': float(result[3]) if result[3] else None,
                'pressure': float(result[4]) if result[4] else None,
                'wind_speed': float(result[5]) if result[5] else None,
                'wind_direction': result[6],
                'precipitation': float(result[7]) if result[7] else None,
                'visibility': float(result[8]) if result[8] else None
            }
        return None

# ä½¿ç”¨ç¤ºä¾‹
collector = WeatherDataCollector("host=localhost dbname=testdb user=postgres password=secret")

# é‡‡é›†æ°”è±¡æ•°æ®
collector.collect_weather_data(
    station_id=1,
    temperature=25.5,
    humidity=65.0,
    pressure=1013.25,
    wind_speed=3.5,
    wind_direction=180,
    precipitation=0.0,
    visibility=10.0
)
```

### 8.3 æ°”è±¡æ•°æ®åˆ†æå®ç°

**Pythonæ°”è±¡æ•°æ®åˆ†æ**ï¼š

```python
import psycopg2
from typing import List, Dict
from datetime import datetime, timedelta

class WeatherAnalyzer:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ°”è±¡åˆ†æå™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def analyze_temperature_trend(self, station_id: int, days: int = 7) -> Dict:
        """åˆ†ææ¸©åº¦è¶‹åŠ¿"""
        self.cur.execute("""
            SELECT
                time_bucket('1 hour', time) AS hour,
                AVG(temperature) AS avg_temp,
                MAX(temperature) AS max_temp,
                MIN(temperature) AS min_temp
            FROM weather_data
            WHERE station_id = %s
              AND time > NOW() - INTERVAL '%s days'
              AND temperature IS NOT NULL
            GROUP BY hour
            ORDER BY hour DESC
        """, (station_id, days))

        trends = []
        for row in self.cur.fetchall():
            trends.append({
                'hour': row[0],
                'avg_temp': float(row[1]) if row[1] else None,
                'max_temp': float(row[2]) if row[2] else None,
                'min_temp': float(row[3]) if row[3] else None
            })

        return {'station_id': station_id, 'trends': trends}

    def predict_weather(self, station_id: int, hours: int = 24) -> Dict:
        """é¢„æµ‹å¤©æ°”ï¼ˆç®€å•çº¿æ€§é¢„æµ‹ï¼‰"""
        # è·å–æœ€è¿‘24å°æ—¶çš„æ•°æ®
        self.cur.execute("""
            SELECT
                time,
                temperature,
                humidity,
                pressure,
                wind_speed,
                precipitation
            FROM weather_data
            WHERE station_id = %s
              AND time > NOW() - INTERVAL '24 hours'
            ORDER BY time ASC
        """, (station_id,))

        historical_data = self.cur.fetchall()

        if len(historical_data) < 2:
            return {'error': 'Insufficient data for prediction'}

        # ç®€å•çº¿æ€§é¢„æµ‹ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å¤æ‚çš„æ¨¡å‹ï¼‰
        predictions = []
        for i in range(hours):
            # ä½¿ç”¨æœ€è¿‘çš„æ•°æ®ç‚¹è¿›è¡Œç®€å•é¢„æµ‹
            latest = historical_data[-1]
            predictions.append({
                'hour': i + 1,
                'predicted_temperature': float(latest[1]) if latest[1] else None,
                'predicted_humidity': float(latest[2]) if latest[2] else None,
                'predicted_pressure': float(latest[3]) if latest[3] else None,
                'predicted_wind_speed': float(latest[4]) if latest[4] else None,
                'predicted_precipitation': float(latest[5]) if latest[5] else None
            })

        return {'station_id': station_id, 'predictions': predictions}

    def detect_weather_anomalies(self, station_id: int, hours: int = 24) -> List[Dict]:
        """æ£€æµ‹å¤©æ°”å¼‚å¸¸"""
        # è·å–å†å²å¹³å‡å€¼å’Œæ ‡å‡†å·®
        self.cur.execute("""
            SELECT
                AVG(temperature) AS avg_temp,
                STDDEV(temperature) AS std_temp,
                AVG(humidity) AS avg_humidity,
                STDDEV(humidity) AS std_humidity,
                AVG(pressure) AS avg_pressure,
                STDDEV(pressure) AS std_pressure
            FROM weather_data
            WHERE station_id = %s
              AND time > NOW() - INTERVAL '30 days'
        """, (station_id,))

        stats = self.cur.fetchone()

        if not stats or not stats[0]:
            return []

        avg_temp, std_temp = float(stats[0]) if stats[0] else None, float(stats[1]) if stats[1] else None
        avg_humidity, std_humidity = float(stats[2]) if stats[2] else None, float(stats[3]) if stats[3] else None
        avg_pressure, std_pressure = float(stats[4]) if stats[4] else None, float(stats[5]) if stats[5] else None

        # è·å–æœ€è¿‘çš„æ•°æ®
        self.cur.execute("""
            SELECT
                time,
                temperature,
                humidity,
                pressure
            FROM weather_data
            WHERE station_id = %s
              AND time > NOW() - INTERVAL '%s hours'
            ORDER BY time DESC
        """, (station_id, hours))

        anomalies = []
        for row in self.cur.fetchall():
            time, temp, humidity, pressure = row
            anomaly_flags = []

            if temp and avg_temp and std_temp:
                if abs(temp - avg_temp) > 2 * std_temp:
                    anomaly_flags.append('temperature')

            if humidity and avg_humidity and std_humidity:
                if abs(humidity - avg_humidity) > 2 * std_humidity:
                    anomaly_flags.append('humidity')

            if pressure and avg_pressure and std_pressure:
                if abs(pressure - avg_pressure) > 2 * std_pressure:
                    anomaly_flags.append('pressure')

            if anomaly_flags:
                anomalies.append({
                    'time': time,
                    'temperature': float(temp) if temp else None,
                    'humidity': float(humidity) if humidity else None,
                    'pressure': float(pressure) if pressure else None,
                    'anomaly_types': anomaly_flags
                })

        return anomalies

# ä½¿ç”¨ç¤ºä¾‹
analyzer = WeatherAnalyzer("host=localhost dbname=testdb user=postgres password=secret")

# åˆ†ææ¸©åº¦è¶‹åŠ¿
trends = analyzer.analyze_temperature_trend(station_id=1, days=7)
print(f"Temperature trends for station {trends['station_id']}")

# é¢„æµ‹å¤©æ°”
predictions = analyzer.predict_weather(station_id=1, hours=24)
if 'predictions' in predictions:
    for pred in predictions['predictions'][:5]:
        print(f"Hour {pred['hour']}: temp={pred['predicted_temperature']}Â°C")

# æ£€æµ‹å¼‚å¸¸
anomalies = analyzer.detect_weather_anomalies(station_id=1, hours=24)
for anomaly in anomalies:
    print(f"Anomaly at {anomaly['time']}: {anomaly['anomaly_types']}")
```

### 8.4 ç©ºé—´åˆ†æå®ç°

**Pythonç©ºé—´åˆ†æ**ï¼š

```python
import psycopg2
from typing import List, Dict
from shapely.geometry import Point

class SpatialWeatherAnalyzer:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç©ºé—´æ°”è±¡åˆ†æå™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def find_nearby_stations(self, center_location: Point, radius_km: float = 50) -> List[Dict]:
        """æŸ¥æ‰¾é™„è¿‘æ°”è±¡ç«™"""
        lon, lat = center_location.x, center_location.y

        self.cur.execute("""
            SELECT
                id,
                name,
                elevation,
                ST_Distance(
                    location::geography,
                    ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography
                ) / 1000 AS distance_km
            FROM weather_stations
            WHERE ST_DWithin(
                location::geography,
                ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography,
                %s * 1000
            )
            ORDER BY distance_km ASC
        """, (lon, lat, lon, lat, radius_km))

        stations = []
        for row in self.cur.fetchall():
            stations.append({
                'id': row[0],
                'name': row[1],
                'elevation': float(row[2]) if row[2] else None,
                'distance_km': float(row[3])
            })

        return stations

    def analyze_regional_weather(self, center_location: Point, radius_km: float = 100,
                                 hours: int = 24) -> Dict:
        """åˆ†æåŒºåŸŸå¤©æ°”"""
        lon, lat = center_location.x, center_location.y

        self.cur.execute("""
            SELECT
                AVG(wd.temperature) AS avg_temp,
                AVG(wd.humidity) AS avg_humidity,
                AVG(wd.pressure) AS avg_pressure,
                AVG(wd.wind_speed) AS avg_wind_speed,
                SUM(wd.precipitation) AS total_precipitation,
                COUNT(*) AS data_points
            FROM weather_data wd
            JOIN weather_stations ws ON wd.station_id = ws.id
            WHERE ST_DWithin(
                ws.location::geography,
                ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography,
                %s * 1000
            )
              AND wd.time > NOW() - INTERVAL '%s hours'
        """, (lon, lat, radius_km, hours))

        result = self.cur.fetchone()
        if result:
            return {
                'avg_temperature': float(result[0]) if result[0] else None,
                'avg_humidity': float(result[1]) if result[1] else None,
                'avg_pressure': float(result[2]) if result[2] else None,
                'avg_wind_speed': float(result[3]) if result[3] else None,
                'total_precipitation': float(result[4]) if result[4] else None,
                'data_points': result[5]
            }
        return {}

# ä½¿ç”¨ç¤ºä¾‹
from shapely.geometry import Point

spatial_analyzer = SpatialWeatherAnalyzer("host=localhost dbname=testdb user=postgres password=secret")

# æŸ¥æ‰¾é™„è¿‘æ°”è±¡ç«™
center = Point(116.3974, 39.9093)  # åŒ—äº¬
nearby_stations = spatial_analyzer.find_nearby_stations(center, radius_km=100)
for station in nearby_stations:
    print(f"{station['name']}: {station['distance_km']:.2f}km away")

# åˆ†æåŒºåŸŸå¤©æ°”
regional_weather = spatial_analyzer.analyze_regional_weather(center, radius_km=100, hours=24)
print(f"Regional average temperature: {regional_weather.get('avg_temperature', 'N/A')}Â°C")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-51-01
