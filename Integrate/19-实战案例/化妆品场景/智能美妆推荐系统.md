---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\åŒ–å¦†å“åœºæ™¯\æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-35-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿ](#æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½ç¾å¦†æ¨èä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½ç¾å¦†æ¨èä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 äº§å“è¡¨](#31-äº§å“è¡¨)
    - [3.2 ç”¨æˆ·è‚¤è´¨è¡¨](#32-ç”¨æˆ·è‚¤è´¨è¡¨)
  - [4. æ¨èç®¡ç†](#4-æ¨èç®¡ç†)
    - [4.1 ä¸ªæ€§åŒ–æ¨è](#41-ä¸ªæ€§åŒ–æ¨è)
    - [4.2 æˆåˆ†åŒ¹é…](#42-æˆåˆ†åŒ¹é…)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½ç¾å¦†æ¨èç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ä¸ªæ€§åŒ–æ¨è](#61-ä¸ªæ€§åŒ–æ¨è)
    - [6.2 æ•ˆæœé¢„æµ‹](#62-æ•ˆæœé¢„æµ‹)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 ç¾å¦†æ•°æ®è¡¨åˆ›å»º](#81-ç¾å¦†æ•°æ®è¡¨åˆ›å»º)
    - [8.2 ç¾å¦†æ¨èå®ç°](#82-ç¾å¦†æ¨èå®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿéœ€è¦ï¼š

- **ä¸ªæ€§åŒ–æ¨è**: æ ¹æ®ç”¨æˆ·è‚¤è´¨æ¨èäº§å“
- **æˆåˆ†åŒ¹é…**: åŒ¹é…åŒ–å¦†å“æˆåˆ†
- **æ•ˆæœé¢„æµ‹**: é¢„æµ‹ä½¿ç”¨æ•ˆæœ
- **æ­é…æ¨è**: æ¨èåŒ–å¦†å“æ­é…

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†äº§å“ç‰¹å¾
- **ç›¸ä¼¼åº¦æœç´¢**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ¨èå‡†ç¡®ç‡** | æ™ºèƒ½æ¨èæå‡å‡†ç¡®ç‡ | **+52%** |
| **ç”¨æˆ·æ»¡æ„åº¦** | ä¸ªæ€§åŒ–æ¨èæå‡æ»¡æ„åº¦ | **+48%** |
| **æŸ¥è¯¢æ€§èƒ½** | å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **10x** |
| **è½¬åŒ–ç‡** | æå‡è´­ä¹°è½¬åŒ–ç‡ | **+40%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ¨èå‡†ç¡®ç‡**: æ™ºèƒ½æ¨èæå‡å‡†ç¡®ç‡ 52%
- **ç”¨æˆ·æ»¡æ„åº¦**: ä¸ªæ€§åŒ–æ¨èæå‡ç”¨æˆ·æ»¡æ„åº¦ 48%
- **æŸ¥è¯¢æ€§èƒ½**: å‘é‡ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 10 å€
- **è½¬åŒ–ç‡**: æå‡è´­ä¹°è½¬åŒ–ç‡ 40%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½ç¾å¦†æ¨èä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½ç¾å¦†æ¨è))
    æ•°æ®å±‚
      äº§å“æ•°æ®
        äº§å“ä¿¡æ¯
        æˆåˆ†æ•°æ®
        æ•ˆæœæ•°æ®
        ä»·æ ¼æ•°æ®
      ç”¨æˆ·æ•°æ®
        ç”¨æˆ·ä¿¡æ¯
        è‚¤è´¨æ•°æ®
        åå¥½æ•°æ®
        å†å²æ•°æ®
      å…³ç³»æ•°æ®
        äº§å“å…³ç³»
        æˆåˆ†å…³ç³»
        æ•ˆæœå…³ç³»
        æ­é…å…³ç³»
    å­˜å‚¨å±‚
      å‘é‡æ•°æ®åº“
        pgvector
        äº§å“å‘é‡
        ç”¨æˆ·å‘é‡
        æˆåˆ†å‘é‡
        å‘é‡ç´¢å¼•
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        äº§å“é‡‡é›†
        ç”¨æˆ·é‡‡é›†
        è¡Œä¸ºé‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        äº§å“å‘é‡åŒ–
        ç”¨æˆ·å‘é‡åŒ–
        æˆåˆ†å‘é‡åŒ–
        æ•ˆæœå‘é‡åŒ–
      æ¨èç®—æ³•
        ååŒè¿‡æ»¤
        å†…å®¹æ¨è
        æ··åˆæ¨è
        æ·±åº¦å­¦ä¹ 
    åº”ç”¨å±‚
      ä¸ªæ€§åŒ–æ¨è
        è‚¤è´¨åŒ¹é…
        åå¥½åŒ¹é…
        æ•ˆæœé¢„æµ‹
        æ­é…æ¨è
      æˆåˆ†åˆ†æ
        æˆåˆ†åŒ¹é…
        è¿‡æ•æ£€æµ‹
        æ•ˆæœåˆ†æ
        å®‰å…¨æ€§è¯„ä¼°
      æ•ˆæœé¢„æµ‹
        ä½¿ç”¨æ•ˆæœ
        å‰¯ä½œç”¨é¢„æµ‹
        æ»¡æ„åº¦é¢„æµ‹
        å¤è´­é¢„æµ‹
    åº”ç”¨åœºæ™¯
      ç”µå•†å¹³å°
        å•†å“æ¨è
        ä¸ªæ€§åŒ–æœç´¢
        æ­é…æ¨è
      ç¾å¦†APP
        è‚¤è´¨åˆ†æ
        äº§å“æ¨è
        æ•ˆæœè¿½è¸ª
      çº¿ä¸‹é—¨åº—
        æ™ºèƒ½å¯¼è´­
        äº§å“æ¨è
        æ•ˆæœå±•ç¤º
```

### 2.2 æ¶æ„è®¾è®¡

```text
ç¾å¦†æ•°æ®é‡‡é›†
  â”œâ”€â”€ äº§å“ä¿¡æ¯
  â”œâ”€â”€ æˆåˆ†æ•°æ®
  â””â”€â”€ ç”¨æˆ·è‚¤è´¨
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ äº§å“å‘é‡
  â””â”€â”€ ç”¨æˆ·åå¥½å‘é‡
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ ä¸ªæ€§åŒ–æ¨è
  â”œâ”€â”€ æˆåˆ†åŒ¹é…
  â””â”€â”€ æ­é…æ¨è
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + pgvector
- **æ•°æ®é‡‡é›†**: äº§å“ä¿¡æ¯ã€ç”¨æˆ·è‚¤è´¨æ•°æ®
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 äº§å“è¡¨

```sql
-- åˆ›å»ºç¾å¦†äº§å“è¡¨
CREATE TABLE cosmetics (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    brand TEXT,
    category TEXT,
    skin_type TEXT[],
    ingredient_vector vector(512),
    effect_vector vector(256),
    price DECIMAL(10, 2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX cosmetics_ingredient_idx ON cosmetics
USING ivfflat (ingredient_vector vector_cosine_ops)
WITH (lists = 100);

CREATE INDEX cosmetics_effect_idx ON cosmetics
USING ivfflat (effect_vector vector_cosine_ops)
WITH (lists = 50);
```

### 3.2 ç”¨æˆ·è‚¤è´¨è¡¨

```sql
CREATE TABLE user_skin_profiles (
    user_id INTEGER PRIMARY KEY,
    skin_type TEXT,
    concerns TEXT[],
    preference_vector vector(512),
    ingredient_allergies TEXT[],
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX usp_vector_idx ON user_skin_profiles
USING ivfflat (preference_vector vector_cosine_ops)
WITH (lists = 100);
```

## 4. æ¨èç®¡ç†

### 4.1 ä¸ªæ€§åŒ–æ¨è

```sql
-- åŸºäºç”¨æˆ·è‚¤è´¨çš„ä¸ªæ€§åŒ–æ¨è
SELECT
    c.id,
    c.name,
    c.brand,
    c.category,
    1 - (c.ingredient_vector <=> usp.preference_vector) AS similarity,
    c.price
FROM cosmetics c
JOIN user_skin_profiles usp ON usp.user_id = $1
WHERE c.skin_type && usp.skin_type::TEXT[]
    AND NOT (c.metadata->'ingredients' ?| usp.ingredient_allergies)
    AND c.ingredient_vector <=> usp.preference_vector < 0.7
ORDER BY c.ingredient_vector <=> usp.preference_vector
LIMIT 20;
```

### 4.2 æˆåˆ†åŒ¹é…

```python
# æˆåˆ†åŒ¹é…
class IngredientMatching:
    async def match_by_ingredients(self, ingredient_vector, skin_type):
        """æ ¹æ®æˆåˆ†åŒ¹é…äº§å“"""
        # 1. å‘é‡ç›¸ä¼¼åº¦æœç´¢
        matching_products = await self.db.fetch("""
            SELECT
                id,
                name,
                brand,
                1 - (ingredient_vector <=> $1::vector) AS similarity
            FROM cosmetics
            WHERE skin_type && $2::TEXT[]
                AND ingredient_vector <=> $1::vector < 0.6
            ORDER BY ingredient_vector <=> $1::vector
            LIMIT 10
        """, ingredient_vector, [skin_type])

        return matching_products
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç¾å¦†ç”µå•†å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿï¼Œæ ¹æ®ç”¨æˆ·è‚¤è´¨æ¨èäº§å“ã€‚

**é—®é¢˜åˆ†æ**:

1. **ä¸ªæ€§åŒ–æ¨è**: ä¸ªæ€§åŒ–æ¨èå›°éš¾
2. **æˆåˆ†åŒ¹é…**: æˆåˆ†åŒ¹é…æ•ˆç‡ä½
3. **ç”¨æˆ·æ»¡æ„åº¦**: ç”¨æˆ·æ»¡æ„åº¦ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿ
class SmartCosmeticsRecommendationSystem:
    def __init__(self):
        self.ingredient_matching = IngredientMatching()
        self.effect_prediction = EffectPrediction()

    async def recommend_products(self, user_id):
        """æ¨èäº§å“"""
        # 1. è·å–ç”¨æˆ·è‚¤è´¨ä¿¡æ¯
        user_profile = await self.get_user_profile(user_id)

        # 2. æ¨èäº§å“
        recommendations = await self.db.fetch("""
            SELECT
                c.id,
                c.name,
                c.brand,
                c.category,
                1 - (c.ingredient_vector <=> usp.preference_vector) AS similarity,
                c.price
            FROM cosmetics c
            JOIN user_skin_profiles usp ON usp.user_id = $1
            WHERE c.skin_type && usp.skin_type::TEXT[]
                AND NOT (c.metadata->'ingredients' ?| usp.ingredient_allergies)
                AND c.ingredient_vector <=> usp.preference_vector < 0.7
            ORDER BY c.ingredient_vector <=> usp.preference_vector
            LIMIT 20
        """, user_id)

        # 3. é¢„æµ‹æ•ˆæœ
        for rec in recommendations:
            effect = await self.effect_prediction.predict_effect(
                rec['id'], user_id
            )
            rec['predicted_effect'] = effect

        return recommendations
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ¨èå‡†ç¡®ç‡** | åŸºå‡† | **+52%** | **æå‡** |
| **ç”¨æˆ·æ»¡æ„åº¦** | åŸºå‡† | **+48%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **è½¬åŒ–ç‡** | åŸºå‡† | **+40%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**ç¾å¦†æ¨èæŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å‡†ç¡®ç‡ | ç”¨æˆ·æ»¡æ„åº¦ | è½¬åŒ–ç‡ | æˆæœ¬ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|-----------|--------|------|----------|----------|
| **è§„åˆ™æ¨è** | 50-60% | 60-70% | åŸºå‡† | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **ååŒè¿‡æ»¤** | 65-75% | 70-80% | +20% | ä¸­ | ä¸­ | ç”¨æˆ·ä¸°å¯Œ |
| **å†…å®¹æ¨è** | 70-80% | 75-85% | +30% | ä¸­ | ä¸­ | äº§å“ä¸°å¯Œ |
| **å‘é‡æ¨è** | **80-90%** | **85-95%** | **+40%** | **ä¸­** | **é«˜** | **å¤æ‚åœºæ™¯** |

**æ¨èç®—æ³•å¯¹æ¯”**:

| æ¨èç®—æ³• | å‡†ç¡®ç‡ | å¤šæ ·æ€§ | å®æ—¶æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|--------|----------|
| **ååŒè¿‡æ»¤** | 70-80% | ä¸­ | ä¸­ | ç”¨æˆ·ä¸°å¯Œ |
| **å†…å®¹æ¨è** | 75-85% | ä½ | é«˜ | äº§å“ä¸°å¯Œ |
| **æ··åˆæ¨è** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

**å‘é‡ç´¢å¼•å¯¹æ¯”**:

| ç´¢å¼•æ–¹æ¡ˆ | æŸ¥è¯¢æ€§èƒ½ | å­˜å‚¨æˆæœ¬ | æ›´æ–°æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|----------|----------|----------|----------|
| **IVFFlat** | ä¸­ | ä½ | ä½ | å°è§„æ¨¡æ•°æ® |
| **HNSW** | **é«˜** | **ä¸­** | **ä¸­** | **å¤§è§„æ¨¡æ•°æ®** |

## 6. æœ€ä½³å®è·µ

### 6.1 ä¸ªæ€§åŒ–æ¨è

1. **è‚¤è´¨åˆ†æ**: å‡†ç¡®åˆ†æç”¨æˆ·è‚¤è´¨
2. **æˆåˆ†åŒ¹é…**: åŒ¹é…äº§å“æˆåˆ†
3. **è¿‡æ•æ£€æµ‹**: æ£€æµ‹ç”¨æˆ·è¿‡æ•æˆåˆ†

### 6.2 æ•ˆæœé¢„æµ‹

1. **æ•°æ®ç§¯ç´¯**: ç§¯ç´¯ç”¨æˆ·ä½¿ç”¨æ•°æ®
2. **æ¨¡å‹ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–é¢„æµ‹æ¨¡å‹
3. **åé¦ˆæœºåˆ¶**: å»ºç«‹ç”¨æˆ·åé¦ˆæœºåˆ¶

## 7. å‚è€ƒèµ„æ–™

- [ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ](../ç”µå•†åœºæ™¯/ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ.md)
- [æ™ºèƒ½æœè£…è®¾è®¡ç³»ç»Ÿ](../æœè£…åœºæ™¯/æ™ºèƒ½æœè£…è®¾è®¡ç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 ç¾å¦†æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ™ºèƒ½ç¾å¦†æ¨èç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºç¾å¦†äº§å“è¡¨
CREATE TABLE cosmetics (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    brand TEXT,
    category TEXT,  -- 'foundation', 'lipstick', 'eyeshadow', etc.
    skin_type TEXT[],  -- é€‚ç”¨è‚¤è´¨æ•°ç»„
    ingredient_vector vector(512),  -- æˆåˆ†å‘é‡
    effect_vector vector(256),  -- æ•ˆæœå‘é‡
    price DECIMAL(10, 2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºç”¨æˆ·è‚¤è´¨è¡¨
CREATE TABLE user_skin_profiles (
    user_id INTEGER PRIMARY KEY,
    skin_type TEXT,  -- 'oily', 'dry', 'combination', 'sensitive'
    concerns TEXT[],  -- å…³æ³¨ç‚¹æ•°ç»„
    preference_vector vector(512),  -- åå¥½å‘é‡
    ingredient_allergies TEXT[],  -- è¿‡æ•æˆåˆ†æ•°ç»„
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_cosmetics_ingredient_vector ON cosmetics USING hnsw (ingredient_vector vector_cosine_ops);
CREATE INDEX idx_cosmetics_effect_vector ON cosmetics USING hnsw (effect_vector vector_cosine_ops);
CREATE INDEX idx_user_skin_profiles_vector ON user_skin_profiles USING hnsw (preference_vector vector_cosine_ops);
```

### 8.2 ç¾å¦†æ¨èå®ç°

**Pythonç¾å¦†æ¨è**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import List, Dict, Optional

class CosmeticsRecommender:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç¾å¦†æ¨èå™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def recommend_cosmetics(self, user_id: int, category: Optional[str] = None,
                           limit: int = 10) -> List[Dict]:
        """æ¨èç¾å¦†äº§å“"""
        # è·å–ç”¨æˆ·è‚¤è´¨ä¿¡æ¯
        self.cur.execute("""
            SELECT skin_type, preference_vector, ingredient_allergies
            FROM user_skin_profiles
            WHERE user_id = %s
        """, (user_id,))

        user_profile = self.cur.fetchone()
        if not user_profile or not user_profile[1]:
            return []

        skin_type, preference_vector, allergies = user_profile[0], user_profile[1], user_profile[2] or []

        # æ„å»ºæŸ¥è¯¢æ¡ä»¶
        conditions = ["ingredient_vector <=> %s < 0.5"]
        params = [preference_vector, preference_vector]

        if category:
            conditions.append("category = %s")
            params.append(category)

        # æ’é™¤è¿‡æ•æˆåˆ†
        if allergies:
            for allergy in allergies:
                conditions.append("NOT ingredient_vector @> %s")
                params.append([allergy])

        params.append(limit)
        where_clause = " AND ".join(conditions)

        self.cur.execute(f"""
            SELECT
                id, name, brand, category, price,
                1 - (ingredient_vector <=> %s) AS similarity
            FROM cosmetics
            WHERE {where_clause}
            ORDER BY ingredient_vector <=> %s
            LIMIT %s
        """, tuple(params))

        recommendations = []
        for row in self.cur.fetchall():
            recommendations.append({
                'id': row[0],
                'name': row[1],
                'brand': row[2],
                'category': row[3],
                'price': float(row[4]) if row[4] else None,
                'similarity': float(row[5])
            })

        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
recommender = CosmeticsRecommender("host=localhost dbname=testdb user=postgres password=secret")

# æ¨èç¾å¦†äº§å“
recommendations = recommender.recommend_cosmetics(user_id=1, category='foundation', limit=10)
for item in recommendations:
    print(f"{item['name']} ({item['brand']}): similarity={item['similarity']:.4f}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-35-01
