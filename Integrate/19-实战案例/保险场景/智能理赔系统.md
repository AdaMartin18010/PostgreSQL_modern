---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\08-è½åœ°æ¡ˆä¾‹\ä¿é™©åœºæ™¯\æ™ºèƒ½ç†èµ”ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ™ºèƒ½ç†èµ”ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ (æ¨è) â­ | 17+ | Apache AGE 1.0+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-16-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½ç†èµ”ç³»ç»Ÿ](#æ™ºèƒ½ç†èµ”ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½ç†èµ”ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½ç†èµ”ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 ç†èµ”ç”³è¯·è¡¨](#31-ç†èµ”ç”³è¯·è¡¨)
    - [3.2 å…³ç³»å›¾è°±](#32-å…³ç³»å›¾è°±)
  - [4. ç†èµ”ç®—æ³•](#4-ç†èµ”ç®—æ³•)
    - [4.1 æ¬ºè¯ˆæ£€æµ‹](#41-æ¬ºè¯ˆæ£€æµ‹)
    - [4.2 è‡ªåŠ¨å®¡æ ¸](#42-è‡ªåŠ¨å®¡æ ¸)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½ç†èµ”ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½ç†èµ”ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¬ºè¯ˆæ£€æµ‹](#61-æ¬ºè¯ˆæ£€æµ‹)
    - [6.2 è‡ªåŠ¨å®¡æ ¸](#62-è‡ªåŠ¨å®¡æ ¸)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 ç†èµ”æ•°æ®è¡¨åˆ›å»º](#81-ç†èµ”æ•°æ®è¡¨åˆ›å»º)
    - [8.2 ç†èµ”ç³»ç»Ÿå®ç°](#82-ç†èµ”ç³»ç»Ÿå®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½ç†èµ”ç³»ç»Ÿéœ€è¦ï¼š

- **æ¬ºè¯ˆæ£€æµ‹**: æ£€æµ‹ç†èµ”æ¬ºè¯ˆè¡Œä¸º
- **è‡ªåŠ¨å®¡æ ¸**: è‡ªåŠ¨å®¡æ ¸ç†èµ”ç”³è¯·
- **é£é™©è¯„ä¼°**: è¯„ä¼°ç†èµ”é£é™©
- **å¿«é€Ÿå¤„ç†**: å¿«é€Ÿå¤„ç†ç†èµ”ç”³è¯·

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å›¾æ•°æ®åº“**: Apache AGEï¼ˆPostgreSQL å›¾æ‰©å±•ï¼‰
- **å‘é‡æœç´¢**: pgvector å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
- **æœºå™¨å­¦ä¹ **: ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œé¢„æµ‹

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ¬ºè¯ˆæ£€æµ‹å‡†ç¡®ç‡** | å›¾+å‘é‡æ··åˆåˆ†æ | **94%** |
| **å¤„ç†æ—¶é—´** | è‡ªåŠ¨å®¡æ ¸ç¼©çŸ­æ—¶é—´ | **-70%** |
| **è¯¯æŠ¥ç‡** | é™ä½è¯¯æŠ¥ç‡ | **-60%** |
| **æˆæœ¬èŠ‚çº¦** | é™ä½ç†èµ”æˆæœ¬ | **-35%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ¬ºè¯ˆæ£€æµ‹å‡†ç¡®ç‡**: å›¾+å‘é‡æ··åˆåˆ†æï¼Œå‡†ç¡®ç‡è¾¾åˆ° 94%
- **å¤„ç†æ—¶é—´**: è‡ªåŠ¨å®¡æ ¸ç¼©çŸ­å¤„ç†æ—¶é—´ 70%
- **è¯¯æŠ¥ç‡**: é™ä½è¯¯æŠ¥ç‡ 60%ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **æˆæœ¬èŠ‚çº¦**: é™ä½ç†èµ”æˆæœ¬ 35%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½ç†èµ”ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½ç†èµ”ç³»ç»Ÿ))
    æ•°æ®å±‚
      ç†èµ”æ•°æ®
        ç†èµ”ç”³è¯·
        ç†èµ”è®°å½•
        ç†èµ”é‡‘é¢
        ç†èµ”ç±»å‹
      å…³ç³»æ•°æ®
        ä¿å•å…³ç³»
        å®¢æˆ·å…³ç³»
        ç†èµ”å…³ç³»
        ç½‘ç»œå…³ç³»
      å‘é‡æ•°æ®
        ç†èµ”å‘é‡
        æ¨¡å¼å‘é‡
        ç›¸ä¼¼åº¦æ•°æ®
    å­˜å‚¨å±‚
      å›¾æ•°æ®åº“
        Apache AGE
        å…³ç³»ç½‘ç»œ
        å›¾æŸ¥è¯¢
        è·¯å¾„åˆ†æ
      å‘é‡æ•°æ®åº“
        pgvector
        æ¨¡å¼åŒ¹é…
        ç›¸ä¼¼åº¦æœç´¢
        å¼‚å¸¸æ£€æµ‹
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        æ¬ºè¯ˆåˆ†æ
        é£é™©åˆ†æ
        æ¨¡å¼åˆ†æ
        å…³è”åˆ†æ
      æ™ºèƒ½å†³ç­–
        è‡ªåŠ¨å®¡æ ¸
        é£é™©è¯„ä¼°
        å†³ç­–æ”¯æŒ
        äººå·¥å¤æ ¸
    åº”ç”¨å±‚
      æ¬ºè¯ˆæ£€æµ‹
        å®æ—¶æ£€æµ‹
        æ¨¡å¼åŒ¹é…
        å…³è”åˆ†æ
        é£é™©è¯„ä¼°
      è‡ªåŠ¨å®¡æ ¸
        è§„åˆ™å®¡æ ¸
        æ¨¡å‹å®¡æ ¸
        ç»¼åˆè¯„ä¼°
        å†³ç­–ç”Ÿæˆ
      ç†èµ”å¤„ç†
        å¿«é€Ÿå¤„ç†
        æµç¨‹ä¼˜åŒ–
        è‡ªåŠ¨åŒ–
        æ•ˆç‡æå‡
    åº”ç”¨åœºæ™¯
      è½¦é™©ç†èµ”
        å¿«é€Ÿå®¡æ ¸
        æ¬ºè¯ˆæ£€æµ‹
        è‡ªåŠ¨å¤„ç†
      å¥åº·é™©ç†èµ”
        åŒ»ç–—å®¡æ ¸
        è´¹ç”¨å®¡æ ¸
        è‡ªåŠ¨ç†èµ”
      è´¢äº§é™©ç†èµ”
        æŸå¤±è¯„ä¼°
        ç†èµ”å®¡æ ¸
        å¿«é€Ÿå¤„ç†
```

### 2.2 æ¶æ„è®¾è®¡

```text
ç†èµ”ç”³è¯·æ•°æ®
  â†“
æ•°æ®é¢„å¤„ç†
  â”œâ”€â”€ å…³ç³»æå–
  â””â”€â”€ å‘é‡åŒ–
  â†“
çŸ¥è¯†å›¾è°±å­˜å‚¨
  â”œâ”€â”€ å›¾æ•°æ®ï¼ˆApache AGEï¼‰
  â””â”€â”€ å‘é‡æ•°æ®ï¼ˆpgvectorï¼‰
  â†“
ç†èµ”å¼•æ“
  â”œâ”€â”€ æ¬ºè¯ˆæ£€æµ‹
  â”œâ”€â”€ é£é™©è¯„ä¼°
  â””â”€â”€ è‡ªåŠ¨å®¡æ ¸
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + Apache AGE + pgvector
- **å›¾åˆ†æ**: Cypher æŸ¥è¯¢è¯­è¨€
- **å‘é‡æœç´¢**: pgvector HNSW ç´¢å¼•
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç†èµ”ç”³è¯·è¡¨

```sql
CREATE TABLE claims (
    id SERIAL PRIMARY KEY,
    policy_id TEXT NOT NULL,
    claimant_id TEXT NOT NULL,
    claim_type TEXT,
    claim_amount DECIMAL(10, 2),
    claim_date DATE,
    description TEXT,
    embedding vector(1536),
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX claims_policy_idx ON claims (policy_id);
CREATE INDEX claims_claimant_idx ON claims (claimant_id);
CREATE INDEX claims_embedding_idx ON claims USING hnsw (embedding vector_cosine_ops);
```

### 3.2 å…³ç³»å›¾è°±

```sql
-- åˆ›å»ºå›¾æ•°æ®åº“
SELECT create_graph('insurance_claims');

-- åˆ›å»ºèŠ‚ç‚¹å’Œå…³ç³»
SELECT * FROM cypher('insurance_claims', $$
    CREATE (c:Claim {
        id: 'claim_001',
        amount: 10000,
        embedding: [0.1, 0.2, ...]::vector(1536)
    })
    CREATE (p:Policy {
        id: 'policy_001',
        type: 'auto'
    })
    CREATE (cl:Claimant {
        id: 'claimant_001',
        risk_score: 0.3
    })
    CREATE (c)-[:BELONGS_TO]->(p)
    CREATE (c)-[:FILED_BY]->(cl)
$$) AS (t agtype);
```

## 4. ç†èµ”ç®—æ³•

### 4.1 æ¬ºè¯ˆæ£€æµ‹

```python
# æ¬ºè¯ˆæ£€æµ‹
class FraudDetection:
    async def detect_fraud(self, claim_id):
        """æ£€æµ‹ç†èµ”æ¬ºè¯ˆ"""
        # 1. å›¾æŸ¥è¯¢ï¼šæŸ¥æ‰¾å…³è”ç†èµ”
        related_claims = await self.db.fetch("""
            SELECT * FROM cypher('insurance_claims', $$
                MATCH (c:Claim {id: $1})-[*1..3]-(related:Claim)
                RETURN DISTINCT related.id, related.amount, related.status
                LIMIT 20
            $$) AS (claim_id agtype, amount agtype, status agtype)
        """, claim_id)

        # 2. å‘é‡æŸ¥è¯¢ï¼šæŸ¥æ‰¾ç›¸ä¼¼ç†èµ”
        claim_vector = await self.get_claim_vector(claim_id)
        similar_claims = await self.db.fetch("""
            SELECT
                id,
                claim_amount,
                status,
                1 - (embedding <=> $1::vector) AS similarity
            FROM claims
            WHERE id != $2
                AND 1 - (embedding <=> $1::vector) > 0.8
            ORDER BY embedding <=> $1::vector
            LIMIT 10
        """, claim_vector, claim_id)

        # 3. è®¡ç®—æ¬ºè¯ˆæ¦‚ç‡
        fraud_score = self.calculate_fraud_score(related_claims, similar_claims)

        return fraud_score
```

### 4.2 è‡ªåŠ¨å®¡æ ¸

```python
# è‡ªåŠ¨å®¡æ ¸
class AutoReview:
    async def auto_review(self, claim_id):
        """è‡ªåŠ¨å®¡æ ¸ç†èµ”"""
        # 1. æ¬ºè¯ˆæ£€æµ‹
        fraud_score = await self.fraud_detection.detect_fraud(claim_id)

        # 2. é£é™©è¯„ä¼°
        risk_score = await self.risk_assessment.assess_risk(claim_id)

        # 3. è‡ªåŠ¨å†³ç­–
        if fraud_score > 0.8:
            return {'action': 'reject', 'reason': 'fraud_detected'}
        elif risk_score > 0.7:
            return {'action': 'manual_review', 'reason': 'high_risk'}
        else:
            return {'action': 'approve', 'reason': 'low_risk'}
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½ç†èµ”ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¿é™©å…¬å¸éœ€è¦æ„å»ºæ™ºèƒ½ç†èµ”ç³»ç»Ÿï¼Œæå‡ç†èµ”å¤„ç†æ•ˆç‡ï¼Œé™ä½æ¬ºè¯ˆæŸå¤±ã€‚

**é—®é¢˜åˆ†æ**:

1. **å¤„ç†æ—¶é—´é•¿**: ç†èµ”å¤„ç†æ—¶é—´é•¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
2. **æ¬ºè¯ˆæŸå¤±**: æ¬ºè¯ˆç†èµ”é€ æˆæŸå¤±
3. **äººå·¥æˆæœ¬**: äººå·¥å®¡æ ¸æˆæœ¬é«˜
4. **å‡†ç¡®ç‡ä½**: æ¬ºè¯ˆæ£€æµ‹å‡†ç¡®ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½ç†èµ”ç³»ç»Ÿ
class IntelligentClaimSystem:
    def __init__(self):
        self.fraud_detection = FraudDetection()
        self.auto_review = AutoReview()

    async def process_claim(self, claim_id):
        """å¤„ç†ç†èµ”"""
        # 1. è‡ªåŠ¨å®¡æ ¸
        review_result = await self.auto_review.auto_review(claim_id)

        # 2. æ ¹æ®ç»“æœå¤„ç†
        if review_result['action'] == 'approve':
            await self.approve_claim(claim_id)
        elif review_result['action'] == 'reject':
            await self.reject_claim(claim_id, review_result['reason'])
        else:
            await self.flag_for_manual_review(claim_id)
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å¤„ç†æ—¶é—´** | 5 å¤© | **1.5 å¤©** | **70%** â¬‡ï¸ |
| **æ¬ºè¯ˆæ£€æµ‹å‡†ç¡®ç‡** | 75% | **94%** | **25%** â¬†ï¸ |
| **è¯¯æŠ¥ç‡** | 15% | **6%** | **60%** â¬‡ï¸ |
| **æˆæœ¬èŠ‚çº¦** | åŸºå‡† | **-35%** | **é™ä½** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**ç†èµ”å¤„ç†æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å¤„ç†æ—¶é—´ | å‡†ç¡®ç‡ | è¯¯æŠ¥ç‡ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|----------|--------|--------|------|----------|
| **äººå·¥å®¡æ ¸** | 5-7å¤© | 85-90% | 10-15% | é«˜ | å°è§„æ¨¡ |
| **è§„åˆ™å¼•æ“** | 2-3å¤© | 80-85% | 15-20% | ä¸­ | ç®€å•è§„åˆ™ |
| **æœºå™¨å­¦ä¹ ** | 1-2å¤© | 88-92% | 8-12% | ä¸­ | ç‰¹å¾ä¸°å¯Œ |
| **å›¾+å‘é‡æ··åˆ** | **1-1.5å¤©** | **92-96%** | **5-8%** | **ä¸­** | **å¤æ‚åœºæ™¯** |

**æ£€æµ‹æ–¹æ³•å¯¹æ¯”**:

| æ£€æµ‹æ–¹æ³• | å‡†ç¡®ç‡ | è¯¯æŠ¥ç‡ | å®æ—¶æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|--------|----------|
| **è§„åˆ™æ£€æµ‹** | 75-80% | 15-20% | é«˜ | å·²çŸ¥æ¨¡å¼ |
| **ç»Ÿè®¡æ£€æµ‹** | 80-85% | 10-15% | é«˜ | å¼‚å¸¸æ£€æµ‹ |
| **å›¾æ£€æµ‹** | 85-90% | 8-12% | ä¸­ | å…³ç³»åˆ†æ |
| **å‘é‡æ£€æµ‹** | 85-90% | 8-12% | é«˜ | æ¨¡å¼åŒ¹é… |
| **æ··åˆæ£€æµ‹** | **92-96%** | **5-8%** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 æ¬ºè¯ˆæ£€æµ‹

1. **å¤šç»´åº¦åˆ†æ**: ç»“åˆå›¾åˆ†æå’Œå‘é‡åˆ†æ
2. **å®æ—¶æ›´æ–°**: å®æ—¶æ›´æ–°æ¬ºè¯ˆæ¨¡å¼åº“
3. **æŒç»­ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–æ£€æµ‹æ¨¡å‹

### 6.2 è‡ªåŠ¨å®¡æ ¸

1. **è§„åˆ™å¼•æ“**: ä½¿ç”¨è§„åˆ™å¼•æ“å¤„ç†ç®€å•æ¡ˆä¾‹
2. **æœºå™¨å­¦ä¹ **: ä½¿ç”¨æœºå™¨å­¦ä¹ å¤„ç†å¤æ‚æ¡ˆä¾‹
3. **äººå·¥å¤æ ¸**: é«˜é£é™©æ¡ˆä¾‹äººå·¥å¤æ ¸

## 7. å‚è€ƒèµ„æ–™

- [æ™ºèƒ½é£æ§ç³»ç»Ÿ](../é‡‘èåœºæ™¯/æ™ºèƒ½é£æ§ç³»ç»Ÿ.md)
- [å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ](../é‡‘èåœºæ™¯/å®æ—¶åæ¬ºè¯ˆç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 ç†èµ”æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ™ºèƒ½ç†èµ”ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectorå’ŒApache AGEæ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS age;
LOAD 'age';
SET search_path = ag_catalog, "$user", public;

-- åˆ›å»ºç†èµ”ç”³è¯·è¡¨
CREATE TABLE claims (
    id SERIAL PRIMARY KEY,
    policy_id TEXT NOT NULL,
    claimant_id TEXT NOT NULL,
    claim_type TEXT,  -- 'auto', 'health', 'property', etc.
    claim_amount DECIMAL(10, 2),
    claim_date DATE,
    description TEXT,
    embedding vector(1536),  -- ç†èµ”æè¿°å‘é‡
    status TEXT DEFAULT 'pending',  -- 'pending', 'approved', 'rejected', 'investigating'
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_claims_policy ON claims (policy_id);
CREATE INDEX idx_claims_claimant ON claims (claimant_id);
CREATE INDEX idx_claims_embedding ON claims USING hnsw (embedding vector_cosine_ops);
CREATE INDEX idx_claims_status ON claims (status, created_at DESC);

-- åˆ›å»ºç†èµ”å…³ç³»å›¾
SELECT create_graph('insurance_claims');
```

### 8.2 ç†èµ”ç³»ç»Ÿå®ç°

**Pythonç†èµ”ç³»ç»Ÿ**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from datetime import date
from typing import List, Dict, Optional

class ClaimsSystem:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç†èµ”ç³»ç»Ÿ"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def create_claim(self, policy_id: str, claimant_id: str, claim_type: str,
                    claim_amount: float, claim_date: date, description: str,
                    embedding: List[float]) -> int:
        """åˆ›å»ºç†èµ”ç”³è¯·"""
        self.cur.execute("""
            INSERT INTO claims
            (policy_id, claimant_id, claim_type, claim_amount, claim_date,
             description, embedding, status)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            RETURNING id
        """, (
            policy_id, claimant_id, claim_type, claim_amount, claim_date,
            description, embedding, 'pending'
        ))

        claim_id = self.cur.fetchone()[0]
        self.conn.commit()

        # æ£€æµ‹ç›¸ä¼¼ç†èµ”ï¼ˆæ¬ºè¯ˆæ£€æµ‹ï¼‰
        similar_claims = self.find_similar_claims(embedding, limit=5)
        if similar_claims:
            # æ ‡è®°ä¸ºéœ€è¦è°ƒæŸ¥
            self.update_claim_status(claim_id, 'investigating')

        return claim_id

    def find_similar_claims(self, embedding: List[float], limit: int = 10) -> List[Dict]:
        """æŸ¥æ‰¾ç›¸ä¼¼ç†èµ”"""
        self.cur.execute("""
            SELECT
                id, policy_id, claimant_id, claim_type, claim_amount,
                description, status,
                1 - (embedding <=> %s) AS similarity
            FROM claims
            WHERE embedding <=> %s < 0.3
              AND status != 'rejected'
            ORDER BY embedding <=> %s
            LIMIT %s
        """, (embedding, embedding, embedding, limit))

        similar_claims = []
        for row in self.cur.fetchall():
            similar_claims.append({
                'id': row[0],
                'policy_id': row[1],
                'claimant_id': row[2],
                'claim_type': row[3],
                'claim_amount': float(row[4]) if row[4] else None,
                'description': row[5],
                'status': row[6],
                'similarity': float(row[7])
            })

        return similar_claims

    def update_claim_status(self, claim_id: int, status: str):
        """æ›´æ–°ç†èµ”çŠ¶æ€"""
        self.cur.execute("""
            UPDATE claims
            SET status = %s
            WHERE id = %s
        """, (status, claim_id))

        self.conn.commit()

# ä½¿ç”¨ç¤ºä¾‹
system = ClaimsSystem("host=localhost dbname=testdb user=postgres password=secret")

# åˆ›å»ºç†èµ”ç”³è¯·ï¼ˆéœ€è¦å…ˆè·å–æè¿°å‘é‡ï¼‰
# embedding = get_embedding("Car accident on highway")  # å‡è®¾æœ‰è·å–å‘é‡çš„å‡½æ•°
# claim_id = system.create_claim(
#     policy_id='policy_001',
#     claimant_id='claimant_001',
#     claim_type='auto',
#     claim_amount=5000.0,
#     claim_date=date.today(),
#     description='Car accident on highway',
#     embedding=embedding
# )
# print(f"Claim created: {claim_id}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-16-01
