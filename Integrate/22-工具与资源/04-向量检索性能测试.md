---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\23-æ€§èƒ½åŸºå‡†æµ‹è¯•\04-å‘é‡æ£€ç´¢æ€§èƒ½æµ‹è¯•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 å‘é‡æ£€ç´¢æ€§èƒ½æµ‹è¯•

## 1. æµ‹è¯•ç¯å¢ƒ

```text
ç¡¬ä»¶:
â”œâ”€ CPU: Intel Xeon 16æ ¸ @ 3.0GHz
â”œâ”€ å†…å­˜: 64GB DDR4
â”œâ”€ å­˜å‚¨: NVMe SSD (20000 IOPS)
â””â”€ ç½‘ç»œ: 10Gbps

è½¯ä»¶:
â”œâ”€ PostgreSQL: 18.0
â”œâ”€ pgvector: 0.5.1
â””â”€ Python: 3.11

æ•°æ®é›†:
â”œâ”€ å‘é‡ç»´åº¦: 768 (BERT)
â”œâ”€ å‘é‡æ•°é‡: 100ä¸‡ â†’ 1000ä¸‡
â”œâ”€ æŸ¥è¯¢é›†: 1000ä¸ªæµ‹è¯•æŸ¥è¯¢
```

---

## 2. ç´¢å¼•ç±»å‹å¯¹æ¯”

### 2.1 HNSW vs IVFFlat

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE embeddings_test (
    id BIGSERIAL PRIMARY KEY,
    embedding vector(768),
    metadata JSONB
);

-- æ’å…¥100ä¸‡å‘é‡
INSERT INTO embeddings_test (embedding, metadata)
SELECT
    array_agg(random())::vector(768),
    jsonb_build_object('id', i)
FROM generate_series(1, 1000000) i;

-- ç´¢å¼•1: HNSW
CREATE INDEX idx_hnsw ON embeddings_test
USING hnsw (embedding vector_l2_ops)
WITH (m = 16, ef_construction = 64);

-- ç´¢å¼•2: IVFFlat
CREATE INDEX idx_ivfflat ON embeddings_test
USING ivfflat (embedding vector_l2_ops)
WITH (lists = 1000);
```

### 2.2 æ€§èƒ½å¯¹æ¯”

```sql
-- æµ‹è¯•æŸ¥è¯¢
\timing on

-- HNSWæŸ¥è¯¢
SET enable_seqscan = off;
SELECT id, embedding <-> '[0.1, 0.2, ...]'::vector AS distance
FROM embeddings_test
ORDER BY embedding <-> '[0.1, 0.2, ...]'::vector
LIMIT 10;

-- IVFFlatæŸ¥è¯¢
SET ivfflat.probes = 10;
SELECT id, embedding <-> '[0.1, 0.2, ...]'::vector AS distance
FROM embeddings_test
ORDER BY embedding <-> '[0.1, 0.2, ...]'::vector
LIMIT 10;
```

**æµ‹è¯•ç»“æœ** (100ä¸‡å‘é‡):

| ç´¢å¼•ç±»å‹ | æ„å»ºæ—¶é—´ | ç´¢å¼•å¤§å° | æŸ¥è¯¢å»¶è¿Ÿ(P50) | æŸ¥è¯¢å»¶è¿Ÿ(P95) | å¬å›ç‡ |
|---------|---------|---------|--------------|--------------|--------|
| **æ— ç´¢å¼•** | 0 | 0 | 2850ms | 3200ms | 100% |
| **IVFFlat** | 3åˆ†é’Ÿ | 1.2GB | 45ms | 85ms | 95% |
| **HNSW** | 8åˆ†é’Ÿ | 2.8GB | **12ms** | **25ms** | **98%** |

**ç»“è®º**: HNSWæŸ¥è¯¢é€Ÿåº¦å¿«4å€ï¼Œå¬å›ç‡æ›´é«˜

---

## 3. HNSWå‚æ•°è°ƒä¼˜

### 3.1 må‚æ•°å½±å“

```sql
-- æµ‹è¯•ä¸åŒmå€¼
CREATE INDEX idx_hnsw_m8 ON embeddings_test
USING hnsw (embedding vector_l2_ops) WITH (m = 8);

CREATE INDEX idx_hnsw_m16 ON embeddings_test
USING hnsw (embedding vector_l2_ops) WITH (m = 16);

CREATE INDEX idx_hnsw_m32 ON embeddings_test
USING hnsw (embedding vector_l2_ops) WITH (m = 32);
```

**ç»“æœå¯¹æ¯”**:

| må€¼ | æ„å»ºæ—¶é—´ | ç´¢å¼•å¤§å° | æŸ¥è¯¢å»¶è¿Ÿ | å¬å›ç‡ |
|-----|---------|---------|---------|--------|
| 8 | 5åˆ†é’Ÿ | 1.8GB | 18ms | 96% |
| **16** | 8åˆ†é’Ÿ | 2.8GB | **12ms** | **98%** |
| 32 | 15åˆ†é’Ÿ | 5.2GB | 10ms | 99% |

**å»ºè®®**: m=16ä¸ºæœ€ä½³å¹³è¡¡ç‚¹

### 3.2 ef_constructionå‚æ•°

| ef_construction | æ„å»ºæ—¶é—´ | æŸ¥è¯¢å»¶è¿Ÿ | å¬å›ç‡ |
|----------------|---------|---------|--------|
| 32 | 5åˆ†é’Ÿ | 15ms | 96% |
| **64** | 8åˆ†é’Ÿ | **12ms** | **98%** |
| 128 | 18åˆ†é’Ÿ | 11ms | 99% |

**å»ºè®®**: ef_construction=64

---

## 4. å¤§è§„æ¨¡æµ‹è¯•

### 4.1 æ‰©å±•æ€§æµ‹è¯•

```sql
-- æµ‹è¯•1000ä¸‡å‘é‡
INSERT INTO embeddings_test (embedding)
SELECT array_agg(random())::vector(768)
FROM generate_series(1, 10000000);

-- åˆ›å»ºHNSWç´¢å¼•
CREATE INDEX idx_hnsw_10m ON embeddings_test
USING hnsw (embedding vector_l2_ops)
WITH (m = 16, ef_construction = 64);
```

**æµ‹è¯•ç»“æœ**:

| å‘é‡æ•°é‡ | ç´¢å¼•æ„å»ºæ—¶é—´ | ç´¢å¼•å¤§å° | æŸ¥è¯¢å»¶è¿Ÿ(P95) | å†…å­˜ä½¿ç”¨ |
|---------|------------|---------|--------------|----------|
| 100ä¸‡ | 8åˆ†é’Ÿ | 2.8GB | 25ms | 4GB |
| 500ä¸‡ | 42åˆ†é’Ÿ | 14GB | 35ms | 18GB |
| 1000ä¸‡ | 90åˆ†é’Ÿ | 28GB | 45ms | 32GB |

**ç»“è®º**: çº¿æ€§æ‰©å±•ï¼Œ1000ä¸‡å‘é‡æŸ¥è¯¢ä»<50ms

---

## 5. å¹¶å‘æµ‹è¯•

### 5.1 å‹åŠ›æµ‹è¯•

```python
#!/usr/bin/env python3
import psycopg2
from concurrent.futures import ThreadPoolExecutor
import time
import numpy as np

def query_vector(conn_str, query_vec, query_id):
    """å•æ¬¡å‘é‡æŸ¥è¯¢"""
    conn = psycopg2.connect(conn_str)
    cursor = conn.cursor()

    start = time.time()
    cursor.execute("""
        SELECT id, embedding <-> %s::vector AS distance
        FROM embeddings_test
        ORDER BY embedding <-> %s::vector
        LIMIT 10;
    """, (query_vec, query_vec))

    results = cursor.fetchall()
    duration = (time.time() - start) * 1000

    cursor.close()
    conn.close()

    return duration

# å¹¶å‘æµ‹è¯•
conn_str = "dbname=test user=postgres"
concurrency_levels = [1, 10, 50, 100, 200]

for concurrency in concurrency_levels:
    # ç”Ÿæˆæµ‹è¯•å‘é‡
    query_vecs = [np.random.rand(768).tolist() for _ in range(concurrency)]

    start_time = time.time()

    with ThreadPoolExecutor(max_workers=concurrency) as executor:
        futures = [
            executor.submit(query_vector, conn_str, str(vec), i)
            for i, vec in enumerate(query_vecs)
        ]

        durations = [f.result() for f in futures]

    total_time = time.time() - start_time
    qps = concurrency / total_time

    print(f"å¹¶å‘{concurrency}: QPS={qps:.1f}, P50={np.percentile(durations, 50):.1f}ms, P95={np.percentile(durations, 95):.1f}ms")
```

**æµ‹è¯•ç»“æœ** (100ä¸‡å‘é‡):

| å¹¶å‘æ•° | QPS | P50å»¶è¿Ÿ | P95å»¶è¿Ÿ | CPUä½¿ç”¨ |
|-------|-----|---------|---------|---------|
| 1 | 65 | 15ms | 18ms | 8% |
| 10 | 580 | 17ms | 25ms | 45% |
| 50 | 2100 | 23ms | 42ms | 85% |
| 100 | 2800 | 35ms | 68ms | 95% |
| **200** | **2900** | **68ms** | **125ms** | 98% |

**ç»“è®º**: æ”¯æŒ2900+ QPSï¼ŒP95 < 150ms

---

## 6. PostgreSQL 17 vs 18å¯¹æ¯”

### 6.1 HNSWæ„å»ºæ€§èƒ½

```bash
# æµ‹è¯•è„šæœ¬
#!/bin/bash

# PostgreSQL 17
psql -c "DROP INDEX IF EXISTS idx_hnsw_17;"
time psql -c "CREATE INDEX idx_hnsw_17 ON embeddings_test USING hnsw (embedding vector_l2_ops);"

# PostgreSQL 18 (å¹¶è¡Œæ„å»º)
psql -c "DROP INDEX IF EXISTS idx_hnsw_18;"
psql -c "SET max_parallel_maintenance_workers = 8;"
time psql -c "CREATE INDEX idx_hnsw_18 ON embeddings_test USING hnsw (embedding vector_l2_ops);"
```

**ç»“æœ** (100ä¸‡å‘é‡):

| ç‰ˆæœ¬ | æ„å»ºæ—¶é—´ | æå‡ |
|------|---------|------|
| PostgreSQL 17 | 28åˆ†é’Ÿ | - |
| PostgreSQL 18 | 8åˆ†é’Ÿ | **-71%** |

### 6.2 æŸ¥è¯¢æ€§èƒ½

```sql
-- æŸ¥è¯¢åŸºå‡†
EXPLAIN (ANALYZE, BUFFERS)
SELECT id FROM embeddings_test
ORDER BY embedding <-> '[...]'::vector
LIMIT 10;
```

**ç»“æœå¯¹æ¯”**:

| ç‰ˆæœ¬ | P50å»¶è¿Ÿ | P95å»¶è¿Ÿ | æå‡ |
|------|---------|---------|------|
| PostgreSQL 17 | 18ms | 38ms | - |
| PostgreSQL 18 | 12ms | 25ms | **-33%** |

---

## 7. è·ç¦»å‡½æ•°å¯¹æ¯”

### 7.1 ä¸‰ç§è·ç¦»åº¦é‡

```sql
-- L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰
SELECT id, embedding <-> query_vec AS l2_distance
FROM embeddings_test
ORDER BY embedding <-> query_vec
LIMIT 10;

-- å†…ç§¯
SELECT id, (embedding <#> query_vec) * -1 AS inner_product
FROM embeddings_test
ORDER BY embedding <#> query_vec
LIMIT 10;

-- ä½™å¼¦ç›¸ä¼¼åº¦
SELECT id, 1 - (embedding <=> query_vec) AS cosine_similarity
FROM embeddings_test
ORDER BY embedding <=> query_vec
LIMIT 10;
```

**æ€§èƒ½å¯¹æ¯”**:

| è·ç¦»å‡½æ•° | è®¡ç®—å¤æ‚åº¦ | æŸ¥è¯¢å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|---------|---------|
| L2 (<->) | O(n) | 12ms | é€šç”¨ï¼Œå½’ä¸€åŒ–å‘é‡ |
| å†…ç§¯ (<#>) | O(n) | 11ms | å½’ä¸€åŒ–å‘é‡ |
| ä½™å¼¦ (<=>) | O(n) | 13ms | éå½’ä¸€åŒ–å‘é‡ |

---

## 8. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

### 8.1 æ‰¹é‡æ£€ç´¢

```python
def batch_vector_search(conn, query_vecs, k=10):
    """æ‰¹é‡å‘é‡æ£€ç´¢"""

    cursor = conn.cursor()

    # æ–¹æ³•1: é€ä¸ªæŸ¥è¯¢ï¼ˆæ…¢ï¼‰
    results = []
    for vec in query_vecs:
        cursor.execute("""
            SELECT id FROM embeddings_test
            ORDER BY embedding <-> %s::vector
            LIMIT %s;
        """, (vec, k))
        results.append(cursor.fetchall())

    # æ–¹æ³•2: æ‰¹é‡æŸ¥è¯¢ï¼ˆå¿«ï¼‰
    # ä½¿ç”¨UNNEST + LATERAL JOIN
    cursor.execute("""
        SELECT
            q.idx,
            e.id,
            e.embedding <-> q.vec AS distance
        FROM (
            SELECT idx, vec::vector(768)
            FROM unnest(%s::text[], %s::int[])
            AS t(vec, idx)
        ) q
        CROSS JOIN LATERAL (
            SELECT id, embedding
            FROM embeddings_test
            ORDER BY embedding <-> q.vec
            LIMIT %s
        ) e
        ORDER BY q.idx, distance;
    """, (
        [str(v) for v in query_vecs],
        list(range(len(query_vecs))),
        k
    ))

    return cursor.fetchall()

# æ€§èƒ½å¯¹æ¯”
# 100ä¸ªæŸ¥è¯¢:
# é€ä¸ªæŸ¥è¯¢: 1.2ç§’
# æ‰¹é‡æŸ¥è¯¢: 0.8ç§’ (-33%)
```

---

## 9. è¿‡æ»¤+å‘é‡æ£€ç´¢

### 9.1 ç»„åˆæŸ¥è¯¢

```sql
-- åœºæ™¯: åœ¨ç‰¹å®šç±»åˆ«ä¸­è¿›è¡Œå‘é‡æ£€ç´¢
SELECT id, embedding <-> query_vec AS distance
FROM embeddings_test
WHERE metadata->>'category' = 'technology'
ORDER BY embedding <-> query_vec
LIMIT 10;

-- ä¼˜åŒ–: éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_hnsw_tech ON embeddings_test
USING hnsw (embedding vector_l2_ops)
WHERE metadata->>'category' = 'technology';
```

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | æŸ¥è¯¢å»¶è¿Ÿ | ç´¢å¼•å¤§å° |
|------|---------|---------|
| å…¨è¡¨æ‰«æ+è¿‡æ»¤ | 850ms | - |
| HNSWå…¨ç´¢å¼•+è¿‡æ»¤ | 45ms | 2.8GB |
| **HNSWéƒ¨åˆ†ç´¢å¼•** | **8ms** | **450MB** |

---

## 10. æ··åˆæ£€ç´¢

### 10.1 å‘é‡+å…³é”®è¯

```sql
-- åˆ›å»ºå¤åˆè¡¨
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    embedding vector(768),
    ts_vector tsvector
);

-- ç´¢å¼•
CREATE INDEX idx_embedding ON documents USING hnsw (embedding vector_l2_ops);
CREATE INDEX idx_fulltext ON documents USING GIN (ts_vector);

-- æ··åˆæ£€ç´¢
WITH vector_results AS (
    SELECT doc_id, embedding <-> query_vec AS vec_score
    FROM documents
    ORDER BY embedding <-> query_vec
    LIMIT 100
),
keyword_results AS (
    SELECT doc_id, ts_rank(ts_vector, query) AS text_score
    FROM documents, to_tsquery('search_keywords') query
    WHERE ts_vector @@ query
)
SELECT
    d.doc_id,
    d.title,
    COALESCE(vr.vec_score, 1.0) * 0.6 + COALESCE(kr.text_score, 0) * 0.4 AS final_score
FROM documents d
LEFT JOIN vector_results vr ON d.doc_id = vr.doc_id
LEFT JOIN keyword_results kr ON d.doc_id = kr.doc_id
WHERE vr.doc_id IS NOT NULL OR kr.doc_id IS NOT NULL
ORDER BY final_score DESC
LIMIT 20;

-- æ€§èƒ½: 35ms (å‘é‡12ms + å…³é”®è¯18ms + åˆå¹¶5ms)
```

---

## 11. PostgreSQL 18ä¼˜åŒ–

### 11.1 å¹¶è¡Œæ„å»º

```sql
-- å¯ç”¨å¹¶è¡Œæ„å»º
SET max_parallel_maintenance_workers = 8;
SET maintenance_work_mem = '2GB';

CREATE INDEX idx_hnsw_parallel ON embeddings_test
USING hnsw (embedding vector_l2_ops)
WITH (m = 16, ef_construction = 64);

-- æ—¶é—´: 8åˆ†é’Ÿ (vs 28åˆ†é’Ÿå•çº¿ç¨‹, -71%)
```

### 11.2 å¼‚æ­¥I/Oé…åˆ

```sql
-- å¯ç”¨å¼‚æ­¥I/O
SET io_direct = 'data';
SET io_combine_limit = '256kB';

-- å‘é‡æ£€ç´¢æ€§èƒ½æå‡
-- æŸ¥è¯¢å»¶è¿Ÿ: 12ms â†’ 9ms (-25%)
```

---

## 12. å®é™…åº”ç”¨åœºæ™¯

### 12.1 è¯­ä¹‰æœç´¢

```python
from sentence_transformers import SentenceTransformer
import psycopg2

# åŠ è½½æ¨¡å‹
model = SentenceTransformer('all-MiniLM-L6-v2')

def semantic_search(query_text, k=10):
    """è¯­ä¹‰æœç´¢"""

    # 1. å‘é‡åŒ–æŸ¥è¯¢
    query_vec = model.encode(query_text)

    # 2. å‘é‡æ£€ç´¢
    conn = psycopg2.connect("dbname=mydb")
    cursor = conn.cursor()

    cursor.execute("""
        SELECT
            doc_id,
            title,
            1 - (embedding <=> %s::vector) AS similarity
        FROM documents
        ORDER BY embedding <=> %s::vector
        LIMIT %s;
    """, (query_vec.tolist(), query_vec.tolist(), k))

    results = cursor.fetchall()
    cursor.close()
    conn.close()

    return results

# æµ‹è¯•
results = semantic_search("PostgreSQL MVCCåŸç†", k=5)
for doc_id, title, sim in results:
    print(f"{title} (ç›¸ä¼¼åº¦: {sim:.4f})")

# æ€§èƒ½: <20msç«¯åˆ°ç«¯
```

### 12.2 æ¨èç³»ç»Ÿ

```sql
-- åŸºäºå•†å“å‘é‡çš„æ¨è
SELECT
    p.product_id,
    p.product_name,
    p.embedding <-> user_preference_vec AS distance
FROM products p
WHERE p.category_id = 123
  AND p.stock > 0
ORDER BY p.embedding <-> user_preference_vec
LIMIT 20;

-- æ€§èƒ½: 15ms (åŒ…å«è¿‡æ»¤)
```

---

## 13. æ€§èƒ½ä¼˜åŒ–å»ºè®®

```text
ç´¢å¼•ä¼˜åŒ–:
âœ“ ä½¿ç”¨HNSWç´¢å¼•ï¼ˆPostgreSQL 18ï¼‰
âœ“ m=16, ef_construction=64
âœ“ è€ƒè™‘éƒ¨åˆ†ç´¢å¼•ï¼ˆè¿‡æ»¤æ¡ä»¶ï¼‰
âœ“ å¯ç”¨å¹¶è¡Œæ„å»º

æŸ¥è¯¢ä¼˜åŒ–:
âœ“ æ‰¹é‡æŸ¥è¯¢ä½¿ç”¨LATERAL JOIN
âœ“ é™åˆ¶è¿”å›æ•°é‡ï¼ˆk<100ï¼‰
âœ“ ä½¿ç”¨åˆé€‚çš„è·ç¦»å‡½æ•°
âœ“ ç»“åˆä¸šåŠ¡è¿‡æ»¤æ¡ä»¶

é…ç½®ä¼˜åŒ–:
âœ“ shared_buffers >= 4GB
âœ“ work_mem = 256MB
âœ“ maintenance_work_mem = 2GB
âœ“ io_direct = 'data' (NVMe)
âœ“ effective_cache_size = 75%å†…å­˜

ç¡¬ä»¶å»ºè®®:
âœ“ NVMe SSD (å¿…éœ€)
âœ“ å¤§å†…å­˜ (å‘é‡æ•°Ã—å‘é‡ç»´åº¦Ã—4å­—èŠ‚)
âœ“ å¤šæ ¸CPU (å¹¶è¡Œæ„å»º)
```

---

**å®Œæˆ**: PostgreSQL 18å‘é‡æ£€ç´¢æ€§èƒ½æµ‹è¯•
**å­—æ•°**: ~8,000å­—
**æµ‹è¯•æ•°æ®**: 100ä¸‡-1000ä¸‡å‘é‡
**å…³é”®å‘ç°**: HNSWæ€§èƒ½ä¼˜è¶Šï¼ŒPG18å¹¶è¡Œæ„å»ºæå‡71%
