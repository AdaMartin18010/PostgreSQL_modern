# 调试工具使用指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [调试工具使用指南](#调试工具使用指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. pgAdmin调试](#2-pgadmin调试)
    - [2.1 调试PL/pgSQL](#21-调试plpgsql)
    - [2.2 设置断点](#22-设置断点)
  - [3. 查询分析器](#3-查询分析器)
    - [3.1 EXPLAIN ANALYZE](#31-explain-analyze)
    - [3.2 分析结果](#32-分析结果)
  - [4. 执行计划分析](#4-执行计划分析)
    - [4.1 查看执行计划](#41-查看执行计划)
    - [4.2 优化建议](#42-优化建议)
  - [5. 性能分析](#5-性能分析)
    - [5.1 pg\_stat\_statements](#51-pg_stat_statements)
    - [5.2 性能监控](#52-性能监控)
  - [6. 日志分析](#6-日志分析)
    - [6.1 启用详细日志](#61-启用详细日志)
    - [6.2 日志分析工具](#62-日志分析工具)
  - [7. 调试技巧](#7-调试技巧)
    - [7.1 查询调试](#71-查询调试)
    - [7.2 函数调试](#72-函数调试)
  - [8. 性能优化建议](#8-性能优化建议)
    - [8.1 查询优化](#81-查询优化)
    - [8.2 监控指标](#82-监控指标)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

调试工具帮助开发者诊断和解决PostgreSQL开发中的问题。

**调试工具**:

- pgAdmin调试器
- 查询分析器
- 执行计划分析
- 性能分析工具

---

## 2. pgAdmin调试

### 2.1 调试PL/pgSQL

```sql
-- 创建测试函数
CREATE OR REPLACE FUNCTION test_function()
RETURNS VOID AS $$
DECLARE
    v_count INT;
BEGIN
    SELECT COUNT(*) INTO v_count FROM users;
    RAISE NOTICE 'Count: %', v_count;
END;
$$ LANGUAGE plpgsql;
```

### 2.2 设置断点

```
1. 打开函数编辑器
2. 设置断点
3. 启动调试
4. 单步执行
```

---

## 3. 查询分析器

### 3.1 EXPLAIN ANALYZE

```sql
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM users WHERE email = 'test@example.com';
```

### 3.2 分析结果

```text
- 执行时间
- 扫描行数
- 缓冲区使用
- 索引使用情况
```

---

## 4. 执行计划分析

### 4.1 查看执行计划

```sql
-- 详细执行计划
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, FORMAT JSON)
SELECT * FROM orders o
JOIN users u ON o.user_id = u.id
WHERE u.email = 'test@example.com';
```

### 4.2 优化建议

```text
1. 检查索引使用
2. 检查连接顺序
3. 检查过滤条件
4. 检查统计信息
```

---

## 5. 性能分析

### 5.1 pg_stat_statements

**启用扩展**：

```sql
-- 启用pg_stat_statements扩展
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 配置参数
ALTER SYSTEM SET pg_stat_statements.track = 'all';
ALTER SYSTEM SET pg_stat_statements.max = 10000;
SELECT pg_reload_conf();
```

**查看慢查询**：

```sql
-- 查看慢查询（带错误处理）
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) THEN
        RAISE NOTICE 'pg_stat_statements扩展已启用';
    ELSE
        RAISE WARNING 'pg_stat_statements扩展未启用';
    END IF;
END $$;

-- 查询慢查询
SELECT
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    ROUND(100.0 * total_exec_time / SUM(total_exec_time) OVER (), 2) AS pct_total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- 平均执行时间超过100ms
ORDER BY mean_exec_time DESC
LIMIT 20;
```

### 5.2 性能监控

**查看当前活动**：

```sql
-- 查看当前活动连接（带错误处理）
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    LEFT(query, 100) AS query_preview,
    state_change,
    NOW() - state_change AS state_duration
FROM pg_stat_activity
WHERE state = 'active'
  AND pid != pg_backend_pid()
ORDER BY state_change;
```

**监控长时间运行的查询**：

```sql
-- 监控长时间运行的查询
SELECT
    pid,
    usename,
    application_name,
    state,
    NOW() - query_start AS query_duration,
    LEFT(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state = 'active'
  AND NOW() - query_start > INTERVAL '5 minutes'
ORDER BY query_start;
```

## 6. 日志分析

### 6.1 启用详细日志

**PostgreSQL日志配置**：

```conf
# postgresql.conf
log_statement = 'all'  # 记录所有SQL语句
log_duration = on      # 记录执行时间
log_min_duration_statement = 1000  # 记录超过1秒的查询
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
```

### 6.2 日志分析工具

**使用pgBadger分析日志**：

```bash
# 安装pgBadger
apt-get install pgbadger

# 分析日志
pgbadger /var/log/postgresql/postgresql-*.log -o report.html

# 查看报告
open report.html
```

## 7. 调试技巧

### 7.1 查询调试

**使用EXPLAIN调试**：

```sql
-- 详细执行计划
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING, COSTS)
SELECT
    u.name,
    o.total
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email = 'test@example.com';

-- 分析执行计划
-- 1. 检查是否使用了索引
-- 2. 检查连接顺序
-- 3. 检查过滤条件
-- 4. 检查统计信息是否最新
```

### 7.2 函数调试

**PL/pgSQL调试技巧**：

```sql
-- 创建调试函数
CREATE OR REPLACE FUNCTION debug_function(param1 INTEGER)
RETURNS INTEGER AS $$
DECLARE
    result INTEGER;
    debug_info TEXT;
BEGIN
    -- 记录输入参数
    RAISE NOTICE '输入参数: %', param1;

    -- 执行逻辑
    result := param1 * 2;

    -- 记录中间结果
    RAISE NOTICE '计算结果: %', result;

    -- 返回结果
    RETURN result;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '错误: %', SQLERRM;
        RAISE;
END;
$$ LANGUAGE plpgsql;

-- 测试函数
SELECT debug_function(10);
```

## 8. 性能优化建议

### 8.1 查询优化

**优化建议**：

```sql
-- 1. 使用索引
CREATE INDEX idx_users_email ON users(email);

-- 2. 避免SELECT *
SELECT id, name, email FROM users;

-- 3. 使用LIMIT限制结果
SELECT * FROM users LIMIT 100;

-- 4. 使用EXISTS代替IN
SELECT * FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- 5. 定期更新统计信息
ANALYZE users;
```

### 8.2 监控指标

**关键监控指标**：

```sql
-- 创建监控视图
CREATE OR REPLACE VIEW performance_monitoring AS
SELECT
    '慢查询数' AS metric,
    COUNT(*) AS value
FROM pg_stat_statements
WHERE mean_exec_time > 1000

UNION ALL

SELECT
    '活跃连接数' AS metric,
    COUNT(*) AS value
FROM pg_stat_activity
WHERE state = 'active'

UNION ALL

SELECT
    '等待锁的连接数' AS metric,
    COUNT(*) AS value
FROM pg_stat_activity
WHERE wait_event_type = 'Lock';

-- 查询监控指标
SELECT * FROM performance_monitoring;
```

---

## 📚 相关文档

- [IDE配置指南.md](./IDE配置指南.md) - IDE配置完整指南
- [开发工具链.md](./开发工具链.md) - 开发工具链
- [代码生成工具.md](./代码生成工具.md) - 代码生成工具
- [22-工具与资源/README.md](../README.md) - 工具与资源主题

---

**最后更新**: 2025年1月
