# å¼€å‘å·¥å…·é“¾æ•´åˆ

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [å¼€å‘å·¥å…·é“¾æ•´åˆ](#å¼€å‘å·¥å…·é“¾æ•´åˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç‰ˆæœ¬æ§åˆ¶](#2-ç‰ˆæœ¬æ§åˆ¶)
    - [2.1 Gité…ç½®](#21-gité…ç½®)
    - [2.2 ç‰ˆæœ¬ç®¡ç†](#22-ç‰ˆæœ¬ç®¡ç†)
  - [3. ä»£ç æ ¼å¼åŒ–](#3-ä»£ç æ ¼å¼åŒ–)
    - [3.1 SQLæ ¼å¼åŒ–å·¥å…·](#31-sqlæ ¼å¼åŒ–å·¥å…·)
    - [3.2 æ ¼å¼åŒ–é…ç½®](#32-æ ¼å¼åŒ–é…ç½®)
  - [4. SQLæ£€æŸ¥](#4-sqlæ£€æŸ¥)
    - [4.1 SQLæ£€æŸ¥å·¥å…·](#41-sqlæ£€æŸ¥å·¥å…·)
    - [4.2 æ£€æŸ¥è§„åˆ™](#42-æ£€æŸ¥è§„åˆ™)
  - [5. æ•°æ®åº“è¿ç§»](#5-æ•°æ®åº“è¿ç§»)
    - [5.1 è¿ç§»å·¥å…·](#51-è¿ç§»å·¥å…·)
    - [5.2 è¿ç§»è„šæœ¬](#52-è¿ç§»è„šæœ¬)
  - [6. CI/CDé›†æˆ](#6-cicdé›†æˆ)
    - [6.1 GitHub Actionsé…ç½®](#61-github-actionsé…ç½®)
    - [6.2 GitLab CIé…ç½®](#62-gitlab-cié…ç½®)
  - [7. ä»£ç è´¨é‡æ£€æŸ¥](#7-ä»£ç è´¨é‡æ£€æŸ¥)
    - [7.1 Pre-commité’©å­](#71-pre-commité’©å­)
    - [7.2 ä»£ç å®¡æŸ¥æ¸…å•](#72-ä»£ç å®¡æŸ¥æ¸…å•)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 å·¥å…·é“¾é…ç½®](#81-å·¥å…·é“¾é…ç½®)
    - [8.2 å·¥ä½œæµç¨‹](#82-å·¥ä½œæµç¨‹)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å¼€å‘å·¥å…·é“¾æ•´åˆå¤šä¸ªå·¥å…·ï¼Œæä¾›å®Œæ•´çš„PostgreSQLå¼€å‘ç¯å¢ƒã€‚

**å·¥å…·é“¾ç»„ä»¶**:

- ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰
- ä»£ç æ ¼å¼åŒ–
- SQLæ£€æŸ¥
- æ•°æ®åº“è¿ç§»

---

## 2. ç‰ˆæœ¬æ§åˆ¶

### 2.1 Gité…ç½®

```bash
# åˆå§‹åŒ–Gitä»“åº“
git init

# æ·»åŠ .gitignore
echo "*.dump" >> .gitignore
echo "*.sql.bak" >> .gitignore
```

### 2.2 ç‰ˆæœ¬ç®¡ç†

```bash
# æäº¤SQLå˜æ›´
git add migrations/*.sql
git commit -m "Add user table migration"

# æŸ¥çœ‹å˜æ›´å†å²
git log --oneline
```

---

## 3. ä»£ç æ ¼å¼åŒ–

### 3.1 SQLæ ¼å¼åŒ–å·¥å…·

```bash
# å®‰è£…pg_format
npm install -g pg-formatter

# æ ¼å¼åŒ–SQLæ–‡ä»¶
pg_format input.sql > output.sql
```

### 3.2 æ ¼å¼åŒ–é…ç½®

```json
{
  "formatter": "pg_format",
  "options": {
    "keyword-case": "upper",
    "function-case": "lower",
    "indent": 2
  }
}
```

---

## 4. SQLæ£€æŸ¥

### 4.1 SQLæ£€æŸ¥å·¥å…·

```bash
# å®‰è£…sqlfluff
pip install sqlfluff

# æ£€æŸ¥SQLæ–‡ä»¶
sqlfluff lint queries.sql
```

### 4.2 æ£€æŸ¥è§„åˆ™

```toml
[sqlfluff]
dialect = postgres

[sqlfluff:rules]
max_line_length = 100
indent_unit = space
```

---

## 5. æ•°æ®åº“è¿ç§»

### 5.1 è¿ç§»å·¥å…·

**Flywayé…ç½®**ï¼š

```bash
# ä½¿ç”¨Flyway
flyway migrate

# Flywayé…ç½®æ–‡ä»¶ flyway.conf
flyway.url=jdbc:postgresql://localhost:5432/mydb
flyway.user=postgres
flyway.password=password
flyway.locations=filesystem:migrations
flyway.sqlMigrationPrefix=V
flyway.sqlMigrationSeparator=__
```

**Liquibaseé…ç½®**ï¼š

```bash
# ä½¿ç”¨Liquibase
liquibase update

# Liquibaseé…ç½®æ–‡ä»¶ liquibase.properties
changeLogFile=changelog.xml
url=jdbc:postgresql://localhost:5432/mydb
username=postgres
password=password
```

### 5.2 è¿ç§»è„šæœ¬

**Flywayè¿ç§»è„šæœ¬**ï¼š

```sql
-- migrations/V1__create_users.sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- migrations/V2__add_indexes.sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**Liquibaseå˜æ›´æ—¥å¿—**ï¼š

```xml
<!-- changelog.xml -->
<databaseChangeLog>
    <changeSet id="1" author="developer">
        <createTable tableName="users">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="TEXT">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>
```

## 6. CI/CDé›†æˆ

### 6.1 GitHub Actionsé…ç½®

```yaml
# .github/workflows/postgresql-ci.yml
name: PostgreSQL CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3
      - name: Run migrations
        run: |
          flyway migrate
      - name: Run tests
        run: |
          psql -h localhost -U postgres -d mydb -f tests/test.sql
```

### 6.2 GitLab CIé…ç½®

```yaml
# .gitlab-ci.yml
stages:
  - test
  - deploy

postgresql_test:
  stage: test
  image: postgres:18
  services:
    - postgres:18
  variables:
    POSTGRES_DB: mydb
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  script:
    - flyway migrate
    - psql -h postgres -U postgres -d mydb -f tests/test.sql
```

## 7. ä»£ç è´¨é‡æ£€æŸ¥

### 7.1 Pre-commité’©å­

```bash
# .git/hooks/pre-commit
#!/bin/bash

# SQLæ ¼å¼åŒ–æ£€æŸ¥
pg_format --check migrations/*.sql

# SQLæ£€æŸ¥
sqlfluff lint migrations/*.sql

# å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé˜»æ­¢æäº¤
if [ $? -ne 0 ]; then
    echo "SQLæ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
    exit 1
fi
```

### 7.2 ä»£ç å®¡æŸ¥æ¸…å•

**SQLä»£ç å®¡æŸ¥æ¸…å•**ï¼š

```text
â–¡ SQLè¯­æ³•æ­£ç¡®
â–¡ ä½¿ç”¨äº†é€‚å½“çš„ç´¢å¼•
â–¡ é¿å…äº†SELECT *
â–¡ ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢
â–¡ æ·»åŠ äº†é€‚å½“çš„æ³¨é‡Š
â–¡ éµå¾ªäº†å‘½åè§„èŒƒ
â–¡ æ€§èƒ½æµ‹è¯•é€šè¿‡
```

## 8. æœ€ä½³å®è·µ

### 8.1 å·¥å…·é“¾é…ç½®

**ç»Ÿä¸€é…ç½®ç®¡ç†**ï¼š

```json
{
  "toolchain": {
    "version": "1.0.0",
    "tools": {
      "git": {
        "version": "2.40+",
        "hooks": {
          "pre-commit": true,
          "pre-push": true
        }
      },
      "formatter": {
        "tool": "pg_format",
        "config": ".pg_format.json"
      },
      "linter": {
        "tool": "sqlfluff",
        "config": ".sqlfluff"
      },
      "migration": {
        "tool": "flyway",
        "config": "flyway.conf"
      }
    }
  }
}
```

### 8.2 å·¥ä½œæµç¨‹

**æ ‡å‡†å·¥ä½œæµç¨‹**ï¼š

```text
1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
   git checkout -b feature/new-table

2. ç¼–å†™è¿ç§»è„šæœ¬
   vim migrations/V3__create_orders.sql

3. æ ¼å¼åŒ–ä»£ç 
   pg_format migrations/V3__create_orders.sql

4. æ£€æŸ¥ä»£ç è´¨é‡
   sqlfluff lint migrations/V3__create_orders.sql

5. æµ‹è¯•è¿ç§»
   flyway migrate

6. æäº¤ä»£ç 
   git add migrations/
   git commit -m "Add orders table"

7. æ¨é€ä»£ç 
   git push origin feature/new-table
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [IDEé…ç½®æŒ‡å—.md](./IDEé…ç½®æŒ‡å—.md) - IDEé…ç½®å®Œæ•´æŒ‡å—
- [è°ƒè¯•å·¥å…·.md](./è°ƒè¯•å·¥å…·.md) - è°ƒè¯•å·¥å…·ä½¿ç”¨
- [ä»£ç ç”Ÿæˆå·¥å…·.md](./ä»£ç ç”Ÿæˆå·¥å…·.md) - ä»£ç ç”Ÿæˆå·¥å…·
- [22-å·¥å…·ä¸èµ„æº/README.md](../README.md) - å·¥å…·ä¸èµ„æºä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
