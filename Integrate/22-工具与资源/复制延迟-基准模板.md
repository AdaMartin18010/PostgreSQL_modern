---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\bench\å¤åˆ¶å»¶è¿Ÿ-åŸºå‡†æ¨¡æ¿.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤åˆ¶å»¶è¿Ÿ-åŸºå‡†æ¨¡æ¿

> **PostgreSQLç‰ˆæœ¬**: 18 â­ | 17 | 16
> **æœ€åæ›´æ–°**: 2025-11-12

---

## 1. ç›®æ ‡

- åœ¨ä¸»ä»æ¶æ„ä¸‹æµ‹é‡å†™è´Ÿè½½ä¸‹çš„å¤åˆ¶å»¶è¿Ÿï¼ˆbyte_lag / time_lagï¼‰ä¸ RPO å½±å“
- è¯„ä¼°ä¸åŒåŒæ­¥ç­–ç•¥ï¼ˆsync/asyncï¼‰å¯¹å»¶è¿Ÿçš„å½±å“
- æµ‹è¯•ä¸åŒå†™è´Ÿè½½ä¸‹çš„å¤åˆ¶æ€§èƒ½
- è¯„ä¼°ç½‘ç»œå¸¦å®½å’Œ IO å¯¹å¤åˆ¶å»¶è¿Ÿçš„å½±å“

---

## 2. ç¯å¢ƒå‡†å¤‡

### 2.1 å‰ç½®æ¡ä»¶

- å·²é…ç½®ä¸»ä»å¤åˆ¶ï¼ˆæµå¤åˆ¶ï¼‰
- ä¸»åº“å’Œä»åº“ç½‘ç»œè¿é€š
- æœ‰è¶³å¤Ÿçš„å†™è´Ÿè½½ç”Ÿæˆèƒ½åŠ›
- ç›‘æ§å·¥å…·å¯ç”¨ï¼ˆsarã€iostat ç­‰ï¼‰

### 2.2 å¤åˆ¶é…ç½®æ£€æŸ¥

```sql
-- åœ¨ä¸»åº“æ£€æŸ¥å¤åˆ¶é…ç½®
SELECT
    name,
    setting,
    unit,
    context
FROM pg_settings
WHERE name IN (
    'wal_level',
    'max_wal_senders',
    'max_replication_slots',
    'synchronous_commit',
    'synchronous_standby_names'
);

-- æ£€æŸ¥å¤åˆ¶è¿æ¥çŠ¶æ€
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority
FROM pg_stat_replication;
```

### 2.3 ä»åº“çŠ¶æ€æ£€æŸ¥

```sql
-- åœ¨ä»åº“æ£€æŸ¥æ¢å¤çŠ¶æ€
SELECT
    pg_is_in_recovery() AS is_standby,
    pg_last_wal_receive_lsn() AS last_receive_lsn,
    pg_last_wal_replay_lsn() AS last_replay_lsn,
    pg_wal_lsn_diff(
        pg_last_wal_receive_lsn(),
        pg_last_wal_replay_lsn()
    ) AS replay_lag_bytes;
```

---

## 3. æµ‹è¯•æ–¹æ³•

### 3.1 åŸºç¡€å»¶è¿Ÿç›‘æ§

åœ¨ä¸»åº“æŒç»­å†™å…¥ï¼Œä»åº“ç›‘æµ‹å¤åˆ¶å»¶è¿Ÿï¼š

```bash
# åœ¨ä¸»åº“è¿è¡Œå†™è´Ÿè½½ï¼ˆåªå†™æ¨¡å¼ï¼Œè·³è¿‡ SELECTï¼‰
pgbench -N -c 32 -j 32 -T 300 postgres
```

```sql
-- åœ¨ä¸»åº“ç›‘æ§å¤åˆ¶å»¶è¿Ÿï¼ˆå®šæœŸæ‰§è¡Œï¼Œå¦‚æ¯ 5 ç§’ï¼‰
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    -- å­—èŠ‚å»¶è¿Ÿ
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag_size,
    -- æ—¶é—´å»¶è¿Ÿ
    write_lag,
    flush_lag,
    replay_lag,
    -- WAL ä½ç½®
    pg_current_wal_lsn() AS current_lsn,
    replay_lsn
FROM pg_stat_replication
ORDER BY byte_lag DESC;
```

### 3.2 å»¶è¿Ÿè¶‹åŠ¿ç›‘æ§è„šæœ¬

åˆ›å»ºç›‘æ§è„šæœ¬æŒç»­è®°å½•å»¶è¿Ÿï¼š

```sql
-- monitor_replication_lag.sql
-- åœ¨ä¸»åº“æ‰§è¡Œï¼Œå®šæœŸè®°å½•å»¶è¿Ÿæ•°æ®

CREATE TABLE IF NOT EXISTS replication_lag_history (
    id bigserial PRIMARY KEY,
    recorded_at timestamptz DEFAULT now(),
    application_name text,
    client_addr inet,
    state text,
    sync_state text,
    byte_lag bigint,
    write_lag interval,
    flush_lag interval,
    replay_lag interval,
    current_lsn pg_lsn,
    replay_lsn pg_lsn
);

-- æ’å…¥å½“å‰å»¶è¿Ÿæ•°æ®
INSERT INTO replication_lag_history (
    application_name,
    client_addr,
    state,
    sync_state,
    byte_lag,
    write_lag,
    flush_lag,
    replay_lag,
    current_lsn,
    replay_lsn
)
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag,
    write_lag,
    flush_lag,
    replay_lag,
    pg_current_wal_lsn() AS current_lsn,
    replay_lsn
FROM pg_stat_replication;
```

```bash
# å®šæœŸæ‰§è¡Œç›‘æ§è„šæœ¬ï¼ˆæ¯ 5 ç§’ï¼‰
watch -n 5 'psql -d postgres -f monitor_replication_lag.sql'
```

---

## 4. æµ‹è¯•åœºæ™¯

### 4.1 ä¸åŒå†™è´Ÿè½½æµ‹è¯•

```bash
# ä½è´Ÿè½½ï¼ˆ8 å¹¶å‘ï¼‰
pgbench -N -c 8 -j 8 -T 300 postgres > write_low.log 2>&1 &

# ä¸­ç­‰è´Ÿè½½ï¼ˆ32 å¹¶å‘ï¼‰
pgbench -N -c 32 -j 32 -T 300 postgres > write_medium.log 2>&1 &

# é«˜è´Ÿè½½ï¼ˆ64 å¹¶å‘ï¼‰
pgbench -N -c 64 -j 64 -T 300 postgres > write_high.log 2>&1 &

# æé«˜è´Ÿè½½ï¼ˆ128 å¹¶å‘ï¼‰
pgbench -N -c 128 -j 128 -T 300 postgres > write_extreme.log 2>&1 &
```

### 4.2 ä¸åŒåŒæ­¥ç­–ç•¥æµ‹è¯•

#### å¼‚æ­¥å¤åˆ¶ï¼ˆasyncï¼‰

```sql
-- åœ¨ä¸»åº“è®¾ç½®å¼‚æ­¥å¤åˆ¶
ALTER SYSTEM SET synchronous_commit = 'off';
SELECT pg_reload_conf();

-- æˆ–é’ˆå¯¹ç‰¹å®šä¼šè¯
SET synchronous_commit = 'off';
```

#### åŒæ­¥å¤åˆ¶ï¼ˆsyncï¼‰

```sql
-- åœ¨ä¸»åº“è®¾ç½®åŒæ­¥å¤åˆ¶
ALTER SYSTEM SET synchronous_commit = 'on';
ALTER SYSTEM SET synchronous_standby_names = 'FIRST 1 (standby1)';
SELECT pg_reload_conf();
```

#### è¿œç¨‹åº”ç”¨ï¼ˆremote_applyï¼‰

```sql
-- ç­‰å¾…ä»åº“åº”ç”¨å®Œæˆ
ALTER SYSTEM SET synchronous_commit = 'remote_apply';
ALTER SYSTEM SET synchronous_standby_names = 'FIRST 1 (standby1)';
SELECT pg_reload_conf();
```

### 4.3 æ‰¹é‡å†™å…¥æµ‹è¯•

```sql
-- åˆ›å»ºæ‰¹é‡å†™å…¥è„šæœ¬
-- batch_write.sql
\set batch_size 1000
\set batches 100

DO $$
DECLARE
    i int;
BEGIN
    FOR i IN 1..:batches LOOP
        INSERT INTO test_table (data)
        SELECT md5(random()::text)
        FROM generate_series(1, :batch_size);
        COMMIT;
    END LOOP;
END $$;
```

```bash
# è¿è¡Œæ‰¹é‡å†™å…¥æµ‹è¯•
pgbench -f batch_write.sql -c 1 -j 1 -T 300 postgres
```

---

## 5. ç›‘æ§æŒ‡æ ‡

### 5.1 å¤åˆ¶å»¶è¿ŸæŒ‡æ ‡

```sql
-- å®æ—¶å»¶è¿ŸæŸ¥è¯¢
SELECT
    application_name,
    -- å­—èŠ‚å»¶è¿Ÿï¼ˆæœ€é‡è¦ï¼‰
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag_size,
    -- æ—¶é—´å»¶è¿Ÿ
    write_lag AS write_delay,
    flush_lag AS flush_delay,
    replay_lag AS replay_delay,
    -- å»¶è¿Ÿè¯„ä¼°
    CASE
        WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 1024*1024*1024 THEN 'HIGH'  -- > 1GB
        WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 100*1024*1024 THEN 'MEDIUM'  -- > 100MB
        ELSE 'LOW'
    END AS lag_severity
FROM pg_stat_replication
ORDER BY byte_lag DESC;
```

### 5.2 å»¶è¿Ÿè¶‹åŠ¿åˆ†æ

```sql
-- åˆ†æå»¶è¿Ÿè¶‹åŠ¿ï¼ˆä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„å†å²è¡¨ï¼‰
SELECT
    recorded_at,
    application_name,
    byte_lag,
    replay_lag,
    -- è®¡ç®—å»¶è¿Ÿå˜åŒ–ç‡
    byte_lag - LAG(byte_lag) OVER (PARTITION BY application_name ORDER BY recorded_at) AS byte_lag_delta,
    -- è®¡ç®—å¹³å‡å»¶è¿Ÿ
    AVG(byte_lag) OVER (
        PARTITION BY application_name
        ORDER BY recorded_at
        ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
    ) AS avg_byte_lag_10s
FROM replication_lag_history
WHERE recorded_at >= now() - interval '1 hour'
ORDER BY recorded_at DESC;
```

### 5.3 WAL ç”Ÿæˆé€Ÿç‡

```sql
-- ç›‘æ§ WAL ç”Ÿæˆé€Ÿç‡
SELECT
    pg_size_pretty(pg_current_wal_lsn() - '0/0') AS current_wal_size,
    pg_walfile_name(pg_current_wal_lsn()) AS current_wal_file;

-- å®šæœŸé‡‡æ ·è®¡ç®— WAL ç”Ÿæˆé€Ÿç‡
-- éœ€è¦å®šæœŸæ‰§è¡Œå¹¶è®°å½•æ—¶é—´æˆ³
```

### 5.4 ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# åœ¨ä¸»åº“ç›‘æ§
sar -u 1 300 > master_cpu.log &
sar -r 1 300 > master_memory.log &
iostat -x 1 300 > master_io.log &
sar -n DEV 1 300 > master_network.log &

# åœ¨ä»åº“ç›‘æ§
sar -u 1 300 > replica_cpu.log &
sar -r 1 300 > replica_memory.log &
iostat -x 1 300 > replica_io.log &
sar -n DEV 1 300 > replica_network.log &
```

### 5.5 PostgreSQL æŒ‡æ ‡

```sql
-- ä¸»åº“ WAL ç»Ÿè®¡
SELECT
    wal_records,
    wal_fpi,
    wal_bytes,
    wal_buffers_full,
    wal_write,
    wal_sync,
    wal_write_time,
    wal_sync_time
FROM pg_stat_wal;

-- ä»åº“æ¢å¤ç»Ÿè®¡
SELECT
    pg_stat_get_wal_receiver() AS wal_receiver_stats;

-- å¤åˆ¶æ§½çŠ¶æ€ï¼ˆå¦‚ä½¿ç”¨ï¼‰
SELECT
    slot_name,
    slot_type,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) AS retained_wal_bytes,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS retained_wal_size
FROM pg_replication_slots;
```

---

## 6. ç»“æœè®°å½•

### 6.1 å»¶è¿Ÿè®°å½•è¡¨

| æµ‹è¯•åœºæ™¯ | å†™è´Ÿè½½ (TPS) | å¹³å‡å­—èŠ‚å»¶è¿Ÿ (MB) | æœ€å¤§å­—èŠ‚å»¶è¿Ÿ (MB) | å¹³å‡æ—¶é—´å»¶è¿Ÿ (ms) | æœ€å¤§æ—¶é—´å»¶è¿Ÿ (ms) | åŒæ­¥ç­–ç•¥ |
|---------|-------------|-----------------|-----------------|-----------------|-----------------|---------|
| ä½è´Ÿè½½ (c=8) | | | | | | async |
| ä¸­ç­‰è´Ÿè½½ (c=32) | | | | | | async |
| é«˜è´Ÿè½½ (c=64) | | | | | | async |
| ä¸­ç­‰è´Ÿè½½ (c=32) | | | | | | sync |
| ä¸­ç­‰è´Ÿè½½ (c=32) | | | | | | remote_apply |

### 6.2 å»¶è¿Ÿæ›²çº¿æ•°æ®

è®°å½•ä¸åŒæ—¶é—´ç‚¹çš„å»¶è¿Ÿå€¼ï¼Œç”¨äºç»˜åˆ¶å»¶è¿Ÿæ›²çº¿ï¼š

```sql
-- å¯¼å‡ºå»¶è¿Ÿå†å²æ•°æ®
COPY (
    SELECT
        recorded_at,
        application_name,
        byte_lag,
        EXTRACT(EPOCH FROM replay_lag) * 1000 AS replay_lag_ms
    FROM replication_lag_history
    WHERE recorded_at >= now() - interval '1 hour'
    ORDER BY recorded_at
) TO '/tmp/replication_lag.csv' WITH CSV HEADER;
```

### 6.3 åŒæ­¥ç­–ç•¥å¯¹æ¯”

| åŒæ­¥ç­–ç•¥ | å¹³å‡å»¶è¿Ÿ (ms) | æœ€å¤§å»¶è¿Ÿ (ms) | TPS å½±å“ (%) | RPO | RTO |
|---------|--------------|--------------|-------------|-----|-----|
| async | | | 0% | å¯èƒ½ä¸¢å¤±æ•°æ® | è¾ƒå¿« |
| sync | | | -X% | æ— æ•°æ®ä¸¢å¤± | è¾ƒæ…¢ |
| remote_apply | | | -Y% | æ— æ•°æ®ä¸¢å¤± | æœ€æ…¢ |

### 6.4 è®°å½•æ¨¡æ¿

```markdown
## æµ‹è¯•ç¯å¢ƒ
- **ç¡¬ä»¶ï¼ˆä¸»åº“ï¼‰**: CPUå‹å·ã€å†…å­˜ã€å­˜å‚¨ç±»å‹
- **ç¡¬ä»¶ï¼ˆä»åº“ï¼‰**: CPUå‹å·ã€å†…å­˜ã€å­˜å‚¨ç±»å‹
- **ç½‘ç»œ**: å¸¦å®½ã€å»¶è¿Ÿ
- **ç³»ç»Ÿ**: OSç‰ˆæœ¬ã€å†…æ ¸ç‰ˆæœ¬
- **PostgreSQLç‰ˆæœ¬**: 18.x

## é…ç½®å‚æ•°
- **wal_level**:
- **max_wal_senders**:
- **synchronous_commit**:
- **synchronous_standby_names**:
- **wal_buffers**:
- **max_wal_size**:

## æµ‹è¯•ç»“æœ
- **æµ‹è¯•æ—¶é—´**:
- **å†™è´Ÿè½½**: TPS=
- **å¹³å‡å­—èŠ‚å»¶è¿Ÿ**:
- **æœ€å¤§å­—èŠ‚å»¶è¿Ÿ**:
- **å¹³å‡æ—¶é—´å»¶è¿Ÿ**:
- **æœ€å¤§æ—¶é—´å»¶è¿Ÿ**:
- **ç³»ç»Ÿèµ„æº**: CPU=%, Memory=%, IO=MB/s, Network=MB/s

## å…³é”®å‘ç°
-
-

## ä¼˜åŒ–å»ºè®®
-
-
```

---

## 7. æ€§èƒ½è°ƒä¼˜å»ºè®®

### 7.1 å‡å°‘å¤åˆ¶å»¶è¿Ÿ

1. **ä¼˜åŒ–ç½‘ç»œ**ï¼š
   - ä½¿ç”¨ä½å»¶è¿Ÿç½‘ç»œè¿æ¥
   - å¢åŠ ç½‘ç»œå¸¦å®½
   - å‡å°‘ç½‘ç»œè·³æ•°

2. **ä¼˜åŒ–ä»åº“æ€§èƒ½**ï¼š
   - æé«˜ä»åº“ CPU å’Œ IO æ€§èƒ½
   - ä¼˜åŒ– `max_wal_senders` å’Œ `wal_receiver_timeout`
   - ä½¿ç”¨ SSD å­˜å‚¨

3. **ä¼˜åŒ– WAL è®¾ç½®**ï¼š
   - è°ƒæ•´ `wal_buffers` å’Œ `max_wal_size`
   - è€ƒè™‘ä½¿ç”¨ `wal_compression`

### 7.2 åŒæ­¥ç­–ç•¥é€‰æ‹©

- **å¼‚æ­¥å¤åˆ¶ï¼ˆasyncï¼‰**ï¼šæ€§èƒ½æœ€å¥½ï¼Œä½†å¯èƒ½ä¸¢å¤±æ•°æ®
- **åŒæ­¥å¤åˆ¶ï¼ˆsyncï¼‰**ï¼šä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†å½±å“ä¸»åº“æ€§èƒ½
- **è¿œç¨‹åº”ç”¨ï¼ˆremote_applyï¼‰**ï¼šæœ€å®‰å…¨ï¼Œä½†å»¶è¿Ÿæœ€é«˜

### 7.3 ç›‘æ§å‘Šè­¦

```sql
-- åˆ›å»ºå»¶è¿Ÿå‘Šè­¦æŸ¥è¯¢
SELECT
    'REPLICATION_LAG_ALERT' AS alert_type,
    application_name,
    client_addr,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag_size
FROM pg_stat_replication
WHERE pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 100*1024*1024  -- > 100MB
ORDER BY byte_lag DESC;
```

---

## 8. æ•…éšœæ’æŸ¥

### 8.1 å»¶è¿Ÿçªç„¶å¢åŠ 

- æ£€æŸ¥ä»åº“æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥ä»åº“ IO æ€§èƒ½
- æ£€æŸ¥æ˜¯å¦æœ‰é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢é˜»å¡æ¢å¤

### 8.2 å¤åˆ¶è¿æ¥æ–­å¼€

```sql
-- æ£€æŸ¥å¤åˆ¶æ§½çŠ¶æ€
SELECT * FROM pg_replication_slots WHERE active = false;

-- æ£€æŸ¥ WAL ä¿ç•™
SELECT
    slot_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS retained_wal
FROM pg_replication_slots;
```

### 8.3 ä»åº“æ¢å¤æ…¢

```sql
-- åœ¨ä»åº“æ£€æŸ¥æ¢å¤è¿›åº¦
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag
FROM pg_stat_replication;
```

---

## 9. å‚è€ƒèµ„æº

- **SQL ç›‘æ§è„šæœ¬**: `../sql/ha_monitoring.sql`
- **é«˜å¯ç”¨éƒ¨ç½²**: `../04-éƒ¨ç½²è¿ç»´/`
- **PostgreSQL å®˜æ–¹æ–‡æ¡£**: <https://www.postgresql.org/docs/current/high-availability.html>
- **æµå¤åˆ¶é…ç½®**: <https://www.postgresql.org/docs/current/warm-standby.html>
