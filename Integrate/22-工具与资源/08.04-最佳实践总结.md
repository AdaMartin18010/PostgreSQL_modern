---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\08-å·¥å…·èµ„æº\08.04-æœ€ä½³å®è·µæ€»ç»“.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLæœ€ä½³å®è·µæ€»ç»“ï¼šä»å»ºæ¨¡åˆ°è¿ç»´çš„å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: æ•°æ®åº“è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€è¿ç»´ç®¡ç†ã€å®‰å…¨åŠ å›º

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLæœ€ä½³å®è·µæ€»ç»“ï¼šä»å»ºæ¨¡åˆ°è¿ç»´çš„å®Œæ•´æŒ‡å—](#postgresqlæœ€ä½³å®è·µæ€»ç»“ä»å»ºæ¨¡åˆ°è¿ç»´çš„å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æœ€ä½³å®è·µç›®æ ‡](#11-æœ€ä½³å®è·µç›®æ ‡)
    - [1.2 é€‚ç”¨èŒƒå›´](#12-é€‚ç”¨èŒƒå›´)
    - [1.3 å®è·µåŸåˆ™](#13-å®è·µåŸåˆ™)
  - [äºŒã€æ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ](#äºŒæ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ)
    - [2.1 æ•°æ®ç±»å‹é€‰æ‹©](#21-æ•°æ®ç±»å‹é€‰æ‹©)
    - [2.2 çº¦æŸè®¾è®¡](#22-çº¦æŸè®¾è®¡)
    - [2.3 åˆ†åŒºè®¾è®¡](#23-åˆ†åŒºè®¾è®¡)
    - [2.4 ç´¢å¼•è®¾è®¡](#24-ç´¢å¼•è®¾è®¡)
  - [ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ](#ä¸‰æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ)
    - [3.1 æŸ¥è¯¢ç¼–å†™è§„èŒƒ](#31-æŸ¥è¯¢ç¼–å†™è§„èŒƒ)
    - [3.2 æ‰§è¡Œè®¡åˆ’åˆ†æ](#32-æ‰§è¡Œè®¡åˆ’åˆ†æ)
    - [3.3 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#33-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
    - [3.4 çª—å£å‡½æ•°ä¼˜åŒ–](#34-çª—å£å‡½æ•°ä¼˜åŒ–)
  - [å››ã€å¹¶å‘æ§åˆ¶æœ€ä½³å®è·µ](#å››å¹¶å‘æ§åˆ¶æœ€ä½³å®è·µ)
    - [4.1 äº‹åŠ¡è®¾è®¡](#41-äº‹åŠ¡è®¾è®¡)
    - [4.2 é”ç®¡ç†](#42-é”ç®¡ç†)
    - [4.3 çƒ­ç‚¹å¤„ç†](#43-çƒ­ç‚¹å¤„ç†)
    - [4.4 éš”ç¦»çº§åˆ«é€‰æ‹©](#44-éš”ç¦»çº§åˆ«é€‰æ‹©)
  - [äº”ã€è¿ç»´ç®¡ç†æœ€ä½³å®è·µ](#äº”è¿ç»´ç®¡ç†æœ€ä½³å®è·µ)
    - [5.1 è‡ªåŠ¨åŒ–ç»´æŠ¤](#51-è‡ªåŠ¨åŒ–ç»´æŠ¤)
    - [5.2 ç›‘æ§ä½“ç³»](#52-ç›‘æ§ä½“ç³»)
    - [5.3 å¤‡ä»½æ¢å¤](#53-å¤‡ä»½æ¢å¤)
    - [5.4 å˜æ›´ç®¡ç†](#54-å˜æ›´ç®¡ç†)
  - [å…­ã€å®‰å…¨åŠ å›ºæœ€ä½³å®è·µ](#å…­å®‰å…¨åŠ å›ºæœ€ä½³å®è·µ)
    - [6.1 è®¿é—®æ§åˆ¶](#61-è®¿é—®æ§åˆ¶)
    - [6.2 æ•°æ®åŠ å¯†](#62-æ•°æ®åŠ å¯†)
    - [6.3 å®¡è®¡æ—¥å¿—](#63-å®¡è®¡æ—¥å¿—)
  - [ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¸ƒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [7.1 æ•°æ®ç±»å‹é€‰æ‹©å¯¹æ¯”](#71-æ•°æ®ç±»å‹é€‰æ‹©å¯¹æ¯”)
    - [7.2 ç´¢å¼•ç­–ç•¥å¯¹æ¯”](#72-ç´¢å¼•ç­–ç•¥å¯¹æ¯”)
    - [7.3 éš”ç¦»çº§åˆ«å¯¹æ¯”](#73-éš”ç¦»çº§åˆ«å¯¹æ¯”)
  - [å…«ã€å®è·µæ¡ˆä¾‹](#å…«å®è·µæ¡ˆä¾‹)
    - [8.1 é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡](#81-é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡)
    - [8.2 å¤§æ•°æ®é‡ç³»ç»Ÿè®¾è®¡](#82-å¤§æ•°æ®é‡ç³»ç»Ÿè®¾è®¡)
    - [8.3 é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡](#83-é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡)
  - [ä¹ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#ä¹å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [9.1 æ€§èƒ½é—®é¢˜](#91-æ€§èƒ½é—®é¢˜)
    - [9.2 æ•°æ®é—®é¢˜](#92-æ•°æ®é—®é¢˜)
    - [9.3 è¿ç»´é—®é¢˜](#93-è¿ç»´é—®é¢˜)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 å®˜æ–¹æ–‡æ¡£](#101-å®˜æ–¹æ–‡æ¡£)
    - [10.2 ç½‘ç»œèµ„æº](#102-ç½‘ç»œèµ„æº)
    - [10.3 ç›¸å…³æ–‡æ¡£](#103-ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 æœ€ä½³å®è·µç›®æ ‡

PostgreSQLæœ€ä½³å®è·µæ€»ç»“æ—¨åœ¨æä¾›ä»æ•°æ®å»ºæ¨¡åˆ°è¿ç»´ç®¡ç†çš„å®Œæ•´æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…å’Œè¿ç»´äººå‘˜æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å®‰å…¨çš„PostgreSQLç³»ç»Ÿã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šæå‡æ•°æ®åº“æŸ¥è¯¢å’Œå†™å…¥æ€§èƒ½
- **å¯é æ€§ä¿è¯**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šå¯é è¿è¡Œ
- **å®‰å…¨æ€§ä¿éšœ**ï¼šä¿æŠ¤æ•°æ®å®‰å…¨å’Œè®¿é—®æ§åˆ¶
- **å¯ç»´æŠ¤æ€§**ï¼šå»ºç«‹å¯ç»´æŠ¤çš„è¿ç»´ä½“ç³»

### 1.2 é€‚ç”¨èŒƒå›´

æœ¬æŒ‡å—é€‚ç”¨äºï¼š

- **æ•°æ®åº“è®¾è®¡**ï¼šæ–°ç³»ç»Ÿè®¾è®¡å’Œç°æœ‰ç³»ç»Ÿä¼˜åŒ–
- **æ€§èƒ½è°ƒä¼˜**ï¼šæŸ¥è¯¢ä¼˜åŒ–å’Œç³»ç»Ÿè°ƒä¼˜
- **è¿ç»´ç®¡ç†**ï¼šæ—¥å¸¸è¿ç»´å’Œæ•…éšœå¤„ç†
- **å®‰å…¨åŠ å›º**ï¼šå®‰å…¨ç­–ç•¥å’Œè®¿é—®æ§åˆ¶

### 1.3 å®è·µåŸåˆ™

**æœ€ä½³å®è·µæ ¸å¿ƒåŸåˆ™**ï¼š

1. **æ€§èƒ½ä¼˜å…ˆ**ï¼šåœ¨ä¿è¯åŠŸèƒ½çš„å‰æä¸‹ä¼˜åŒ–æ€§èƒ½
1. **å®‰å…¨ç¬¬ä¸€**ï¼šå®‰å…¨æ˜¯ç³»ç»Ÿè®¾è®¡çš„ç¬¬ä¸€è¦åŠ¡
1. **å¯ç»´æŠ¤æ€§**ï¼šè®¾è®¡è¦è€ƒè™‘é•¿æœŸç»´æŠ¤æˆæœ¬
1. **å¯æ‰©å±•æ€§**ï¼šè®¾è®¡è¦è€ƒè™‘æœªæ¥æ‰©å±•éœ€æ±‚

---

## äºŒã€æ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ

### 2.1 æ•°æ®ç±»å‹é€‰æ‹©

**é€‰æ‹©æ°å½“çš„æ•°æ®ç±»å‹**ï¼š

```sql
-- âœ… æ­£ç¡®ï¼šä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    age SMALLINT CHECK (age >= 0 AND age <= 150),
    balance NUMERIC(15, 2) NOT NULL DEFAULT 0,
    status user_status_enum DEFAULT 'active',
    tags TEXT[],
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸åˆé€‚çš„æ•°æ®ç±»å‹
CREATE TABLE users_bad (
    id INTEGER,  -- å¯èƒ½æº¢å‡º
    email TEXT,  -- æ²¡æœ‰é•¿åº¦é™åˆ¶
    age INTEGER,  -- èŒƒå›´è¿‡å¤§
    balance REAL,  -- ç²¾åº¦é—®é¢˜
    created_at TIMESTAMP  -- æ²¡æœ‰æ—¶åŒºä¿¡æ¯
);
```

**æ•°æ®ç±»å‹é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èç±»å‹ | åŸå›  |
|------|---------|------|
| **æ•´æ•°ID** | BIGSERIAL | é¿å…æº¢å‡º |
| **é‡‘é¢/ç²¾ç¡®æ•°å€¼** | NUMERIC | é¿å…ç²¾åº¦ä¸¢å¤± |
| **æ—¶é—´æˆ³** | TIMESTAMPTZ | æ”¯æŒæ—¶åŒº |
| **æšä¸¾å€¼** | ENUM | ç±»å‹å®‰å…¨ |
| **æ•°ç»„æ•°æ®** | ARRAY | åŸç”Ÿæ”¯æŒ |
| **JSONæ•°æ®** | JSONB | é«˜æ•ˆæŸ¥è¯¢ |
| **èŒƒå›´å€¼** | RANGE | åŸç”Ÿæ”¯æŒèŒƒå›´æ“ä½œ |

**èŒƒå›´ç±»å‹ä½¿ç”¨**ï¼š

```sql
-- ä½¿ç”¨èŒƒå›´ç±»å‹å­˜å‚¨æ—¶é—´æ®µ
CREATE TABLE reservations (
    id BIGSERIAL PRIMARY KEY,
    room_id INTEGER,
    period TSTZRANGE NOT NULL,
    EXCLUDE USING GIST (room_id WITH =, period WITH &&)  -- æ’ä»–çº¦æŸ
);

-- æŸ¥è¯¢é‡å æ—¶é—´æ®µ
SELECT * FROM reservations
WHERE period && '[2025-01-15 10:00, 2025-01-15 12:00]'::TSTZRANGE;
```

**JSONBä½¿ç”¨**ï¼š

```sql
-- ä½¿ç”¨JSONBå­˜å‚¨çµæ´»å±æ€§
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    attributes JSONB DEFAULT '{}'::jsonb
);

-- åˆ›å»ºGINç´¢å¼•æ”¯æŒJSONBæŸ¥è¯¢
CREATE INDEX idx_products_attributes ON products USING GIN (attributes);

-- JSONBæŸ¥è¯¢
SELECT * FROM products
WHERE attributes @> '{"color": "red", "size": "large"}'::jsonb;
```

### 2.2 çº¦æŸè®¾è®¡

**ä¸»å¤–é”®ä¸å”¯ä¸€çº¦æŸ**ï¼š

```sql
-- âœ… å®Œå–„çš„ä¸»å¤–é”®è®¾è®¡
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    total_amount NUMERIC(15, 2) NOT NULL CHECK (total_amount >= 0),
    status order_status_enum NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- âœ… æ’ä»–çº¦æŸï¼ˆé˜²æ­¢æ—¶é—´é‡å ï¼‰
CREATE TABLE bookings (
    id BIGSERIAL PRIMARY KEY,
    resource_id INTEGER NOT NULL,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    EXCLUDE USING GIST (
        resource_id WITH =,
        TSTZRANGE(start_time, end_time) WITH &&
    )
);
```

**çº¦æŸè®¾è®¡åŸåˆ™**ï¼š

- **ä¸»é”®**ï¼šæ¯ä¸ªè¡¨å¿…é¡»æœ‰ä¸»é”®
- **å¤–é”®**ï¼šå»ºç«‹è¡¨é—´å…³ç³»ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
- **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤æ•°æ®
- **æ£€æŸ¥çº¦æŸ**ï¼šä¿è¯æ•°æ®æœ‰æ•ˆæ€§
- **æ’ä»–çº¦æŸ**ï¼šé˜²æ­¢é€»è¾‘å†²çªï¼ˆå¦‚æ—¶é—´é‡å ï¼‰

### 2.3 åˆ†åŒºè®¾è®¡

**åˆ†åŒºç­–ç•¥**ï¼š

```sql
-- âœ… æŒ‰æ—¶é—´åˆ†åŒºï¼ˆæ¨èç”¨äºæ—¶åºæ•°æ®ï¼‰
CREATE TABLE events (
    id BIGSERIAL,
    event_type TEXT NOT NULL,
    event_data JSONB,
    created_at TIMESTAMPTZ NOT NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE events_2025_01 PARTITION OF events
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE events_2025_02 PARTITION OF events
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- âœ… æŒ‰èŒƒå›´åˆ†åŒºï¼ˆæ¨èç”¨äºæ•°å€¼èŒƒå›´ï¼‰
CREATE TABLE sales (
    id BIGSERIAL,
    region_id INTEGER NOT NULL,
    amount NUMERIC(15, 2),
    sale_date DATE NOT NULL,
    PRIMARY KEY (id, region_id)
) PARTITION BY RANGE (region_id);

CREATE TABLE sales_region_1_10 PARTITION OF sales
    FOR VALUES FROM (1) TO (11);
```

**åˆ†åŒºè®¾è®¡åŸåˆ™**ï¼š

- **åˆ†åŒºé”®é€‰æ‹©**ï¼šé€‰æ‹©æŸ¥è¯¢å¸¸ç”¨çš„åˆ—ä½œä¸ºåˆ†åŒºé”®
- **åˆ†åŒºæ•°é‡**ï¼šé¿å…è¿‡å¤šåˆ†åŒºï¼ˆå»ºè®® < 1000ï¼‰
- **åˆ†åŒºè£å‰ª**ï¼šç¡®ä¿æŸ¥è¯¢èƒ½åˆ©ç”¨åˆ†åŒºè£å‰ª
- **è‡ªåŠ¨ç®¡ç†**ï¼šä½¿ç”¨å‡½æ•°è‡ªåŠ¨åˆ›å»ºå’Œåˆ é™¤åˆ†åŒº

### 2.4 ç´¢å¼•è®¾è®¡

**é«˜é¢‘è·¯å¾„å†—ä½™åˆ— + è¡¨è¾¾å¼ç´¢å¼•**ï¼š

```sql
-- âœ… è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_orders_user_status_covering ON orders(user_id, status)
INCLUDE (order_no, total_amount, created_at);

-- âœ… è¡¨è¾¾å¼ç´¢å¼•ï¼ˆä¼˜åŒ–å‡½æ•°æŸ¥è¯¢ï¼‰
CREATE INDEX idx_users_email_lower ON users(LOWER(email));

-- âœ… éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰
CREATE INDEX idx_orders_active ON orders(user_id, created_at DESC)
WHERE status = 'active';

-- âœ… å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–å¤šåˆ—æŸ¥è¯¢ï¼‰
CREATE INDEX idx_orders_user_date_status ON orders(user_id, created_at DESC, status);
```

**ç´¢å¼•è®¾è®¡åŸåˆ™**ï¼š

- **è¦†ç›–ç´¢å¼•**ï¼šåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—
- **è¡¨è¾¾å¼ç´¢å¼•**ï¼šä¼˜åŒ–å‡½æ•°å’Œè¡¨è¾¾å¼æŸ¥è¯¢
- **éƒ¨åˆ†ç´¢å¼•**ï¼šåªç´¢å¼•éœ€è¦çš„æ•°æ®
- **å¤åˆç´¢å¼•**ï¼šä¼˜åŒ–å¤šåˆ—æŸ¥è¯¢
- **é¿å…è¿‡åº¦ç´¢å¼•**ï¼šç´¢å¼•ä¼šå¢åŠ å†™å…¥æˆæœ¬

---

## ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

### 3.1 æŸ¥è¯¢ç¼–å†™è§„èŒƒ

**é¿å…SELECT ***ï¼š

```sql
-- âŒ é”™è¯¯ï¼šä½¿ç”¨SELECT *
SELECT * FROM users WHERE id = 1;

-- âœ… æ­£ç¡®ï¼šåªé€‰æ‹©éœ€è¦çš„åˆ—
SELECT id, name, email FROM users WHERE id = 1;
```

**ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›†**ï¼š

```sql
-- âœ… ä½¿ç”¨LIMITå‡å°‘æ•°æ®ä¼ è¾“
SELECT id, name, email
FROM users
WHERE status = 'active'
ORDER BY created_at DESC
LIMIT 100;
```

**é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°**ï¼š

```sql
-- âŒ é”™è¯¯ï¼šå‡½æ•°é˜»æ­¢ç´¢å¼•ä½¿ç”¨
SELECT * FROM users WHERE LOWER(email) = 'user@example.com';

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_email_lower ON users(LOWER(email));
SELECT * FROM users WHERE LOWER(email) = 'user@example.com';
```

### 3.2 æ‰§è¡Œè®¡åˆ’åˆ†æ

**ä½¿ç”¨EXPLAIN ANALYZE**ï¼š

```sql
-- âœ… å®Œæ•´çš„æ‰§è¡Œè®¡åˆ’åˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
SELECT u.name, o.order_no, o.total_amount
FROM users u
JOIN orders o ON o.user_id = u.id
WHERE u.status = 'active'
  AND o.created_at >= NOW() - INTERVAL '30 days'
ORDER BY o.created_at DESC
LIMIT 100;
```

**æ‰§è¡Œè®¡åˆ’åˆ†æè¦ç‚¹**ï¼š

- **æ‰§è¡Œæ—¶é—´**ï¼šå…³æ³¨å®é™…æ‰§è¡Œæ—¶é—´
- **è¡Œæ•°ä¼°ç®—**ï¼šæ£€æŸ¥ä¼°ç®—è¡Œæ•°ä¸å®é™…è¡Œæ•°æ˜¯å¦æ¥è¿‘
- **ç´¢å¼•ä½¿ç”¨**ï¼šç¡®è®¤ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•
- **è¿æ¥é¡ºåº**ï¼šæ£€æŸ¥è¿æ¥é¡ºåºæ˜¯å¦åˆç†
- **ç¼“å†²åŒºä½¿ç”¨**ï¼šæ£€æŸ¥ç¼“å†²åŒºå‘½ä¸­ç‡

### 3.3 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

**ä¿æŒç»Ÿè®¡ä¿¡æ¯æ–°é²œ**ï¼š

```sql
-- âœ… å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;
ANALYZE orders;

-- âœ… æ›´æ–°ç‰¹å®šè¡¨çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE VERBOSE users;

-- âœ… è®¾ç½®è‡ªåŠ¨ANALYZE
ALTER TABLE users SET (autovacuum_analyze_scale_factor = 0.05);
```

**ç»Ÿè®¡ä¿¡æ¯ç®¡ç†åŸåˆ™**ï¼š

- **è‡ªåŠ¨ANALYZE**ï¼šå¯ç”¨autovacuumè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- **æ‰‹åŠ¨ANALYZE**ï¼šå¤§æ•°æ®å˜æ›´åæ‰‹åŠ¨æ›´æ–°
- **ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§**ï¼šç¡®ä¿ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®åæ˜ æ•°æ®åˆ†å¸ƒ

### 3.4 çª—å£å‡½æ•°ä¼˜åŒ–

**çª—å£å‡½æ•°æ’åºå”¯ä¸€æ€§**ï¼š

```sql
-- âŒ é”™è¯¯ï¼šæ’åºä¸å”¯ä¸€å¯èƒ½å¯¼è‡´ç»“æœä¸ç¨³å®š
SELECT
    user_id,
    order_no,
    ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at) AS rn
FROM orders;

-- âœ… æ­£ç¡®ï¼šç¡®ä¿æ’åºå”¯ä¸€æ€§
SELECT
    user_id,
    order_no,
    ROW_NUMBER() OVER (
        PARTITION BY user_id
        ORDER BY created_at, id  -- æ·»åŠ å”¯ä¸€åˆ—ç¡®ä¿æ’åºå”¯ä¸€
    ) AS rn
FROM orders;
```

---

## å››ã€å¹¶å‘æ§åˆ¶æœ€ä½³å®è·µ

### 4.1 äº‹åŠ¡è®¾è®¡

**çŸ­äº‹åŠ¡ã€å¹‚ç­‰é‡è¯•**ï¼š

```sql
-- âœ… çŸ­äº‹åŠ¡è®¾è®¡
BEGIN;
    UPDATE accounts SET balance = balance - 100 WHERE id = 1;
    INSERT INTO transactions (account_id, amount) VALUES (1, -100);
COMMIT;

-- âœ… å¹‚ç­‰é‡è¯•æœºåˆ¶
CREATE OR REPLACE FUNCTION transfer_money(
    p_transaction_id VARCHAR(50),
    p_from_account_id BIGINT,
    p_to_account_id BIGINT,
    p_amount NUMERIC
)
RETURNS void AS $$
BEGIN
    -- æ£€æŸ¥å¹‚ç­‰æ€§
    IF EXISTS (SELECT 1 FROM transactions WHERE transaction_id = p_transaction_id) THEN
        RETURN;  -- å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
    END IF;

    -- æ‰§è¡Œè½¬è´¦
    UPDATE accounts SET balance = balance - p_amount WHERE id = p_from_account_id;
    UPDATE accounts SET balance = balance + p_amount WHERE id = p_to_account_id;
    INSERT INTO transactions (transaction_id, from_account_id, to_account_id, amount)
    VALUES (p_transaction_id, p_from_account_id, p_to_account_id, p_amount);
END;
$$ LANGUAGE plpgsql;
```

**é¿å…é•¿æ—¶é—´æŒé”**ï¼š

```sql
-- âŒ é”™è¯¯ï¼šé•¿æ—¶é—´æŒé”
BEGIN;
    -- å¤æ‚è®¡ç®—ï¼ˆä¸æ¶‰åŠæ•°æ®åº“ï¼‰
    PERFORM complex_calculation();
    UPDATE accounts SET balance = balance + 100 WHERE id = 1;
COMMIT;

-- âœ… æ­£ç¡®ï¼šå…ˆè®¡ç®—ï¼Œåæ›´æ–°
DECLARE
    v_result NUMERIC;
BEGIN
    -- åœ¨äº‹åŠ¡å¤–è®¡ç®—
    v_result := complex_calculation();

    -- çŸ­äº‹åŠ¡æ›´æ–°
    BEGIN;
        UPDATE accounts SET balance = balance + v_result WHERE id = 1;
    COMMIT;
END;
```

### 4.2 é”ç®¡ç†

**è°¨æ…ä½¿ç”¨SKIP LOCKED**ï¼š

```sql
-- âœ… ä½¿ç”¨SKIP LOCKEDå¤„ç†é˜Ÿåˆ—
SELECT * FROM job_queue
WHERE status = 'pending'
ORDER BY priority DESC, created_at
FOR UPDATE SKIP LOCKED
LIMIT 1;

-- âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
-- 1. é…åˆç›‘æ§ä½¿ç”¨
-- 2. ç¡®ä¿ä¸ä¼šé—æ¼ä»»åŠ¡
-- 3. å¤„ç†æ­»é”æƒ…å†µ
```

**é”ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰é”ä¿¡æ¯
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    query
FROM pg_locks l
JOIN pg_stat_activity a ON a.pid = l.pid
WHERE NOT granted;

-- æŸ¥çœ‹ç­‰å¾…é”çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
  AND blocking_locks.granted;
```

### 4.3 çƒ­ç‚¹å¤„ç†

**çƒ­ç‚¹æ‹†åˆ†**ï¼š

```sql
-- âœ… çƒ­ç‚¹è´¦æˆ·æ‹†åˆ†
CREATE TABLE accounts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    shard_id INTEGER NOT NULL,  -- åˆ†ç‰‡ID
    balance NUMERIC(15, 2) NOT NULL,
    UNIQUE(user_id, shard_id)
) PARTITION BY LIST (shard_id);

-- åˆ›å»ºå¤šä¸ªåˆ†ç‰‡
CREATE TABLE accounts_shard_0 PARTITION OF accounts FOR VALUES IN (0);
CREATE TABLE accounts_shard_1 PARTITION OF accounts FOR VALUES IN (1);
CREATE TABLE accounts_shard_2 PARTITION OF accounts FOR VALUES IN (2);
```

**é˜Ÿåˆ—åŒ–å¤„ç†**ï¼š

```sql
-- âœ… ä½¿ç”¨é˜Ÿåˆ—å¤„ç†çƒ­ç‚¹å†™å…¥
CREATE TABLE write_queue (
    id BIGSERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    operation JSONB NOT NULL,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åå°å¤„ç†é˜Ÿåˆ—
CREATE OR REPLACE FUNCTION process_write_queue()
RETURNS void AS $$
DECLARE
    v_record RECORD;
BEGIN
    FOR v_record IN
        SELECT * FROM write_queue
        WHERE status = 'pending'
        ORDER BY created_at
        FOR UPDATE SKIP LOCKED
        LIMIT 100
    LOOP
        -- å¤„ç†å†™å…¥æ“ä½œ
        PERFORM execute_operation(v_record.operation);

        -- æ›´æ–°çŠ¶æ€
        UPDATE write_queue SET status = 'completed' WHERE id = v_record.id;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 4.4 éš”ç¦»çº§åˆ«é€‰æ‹©

**éœ€è¦å¯ä¸²è¡ŒåŒ–æ—¶ä¼˜å…ˆä½¿ç”¨SSI**ï¼š

```sql
-- âœ… ä½¿ç”¨SSIï¼ˆSerializable Snapshot Isolationï¼‰
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

BEGIN;
    -- å¤æ‚äº‹åŠ¡
    UPDATE accounts SET balance = balance - 100 WHERE id = 1;
    UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;

-- âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
-- 1. SSIå¯èƒ½å¯¼è‡´åºåˆ—åŒ–é”™è¯¯ï¼Œéœ€è¦é‡è¯•
-- 2. ç›‘æ§åºåˆ—åŒ–å¤±è´¥ç‡
-- 3. å¯¹äºç®€å•äº‹åŠ¡ï¼ŒREAD COMMITTEDé€šå¸¸è¶³å¤Ÿ
```

**éš”ç¦»çº§åˆ«é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èéš”ç¦»çº§åˆ« | åŸå›  |
|------|------------|------|
| **ä¸€èˆ¬äº‹åŠ¡** | READ COMMITTED | æ€§èƒ½å¥½ï¼Œæ»¡è¶³å¤§å¤šæ•°éœ€æ±‚ |
| **éœ€è¦å¯é‡å¤è¯»** | REPEATABLE READ | é¿å…å¹»è¯» |
| **éœ€è¦æœ€é«˜ä¸€è‡´æ€§** | SERIALIZABLE | ä¿è¯å¯ä¸²è¡ŒåŒ– |
| **åªè¯»æŸ¥è¯¢** | READ COMMITTED | æ€§èƒ½æœ€ä¼˜ |

---

## äº”ã€è¿ç»´ç®¡ç†æœ€ä½³å®è·µ

### 5.1 è‡ªåŠ¨åŒ–ç»´æŠ¤

**è‡ªåŠ¨åŒ–VACUUM/ANALYZE**ï¼š

```sql
-- âœ… é…ç½®è‡ªåŠ¨VACUUM
ALTER TABLE users SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_scale_factor = 0.05,
    autovacuum_vacuum_cost_delay = 10ms
);

-- âœ… æ‰‹åŠ¨VACUUMï¼ˆå¿…è¦æ—¶ï¼‰
VACUUM ANALYZE users;

-- âœ… å¹¶å‘VACUUMï¼ˆPostgreSQL 13+ï¼‰
VACUUM (ANALYZE, VERBOSE) users;
```

**VACUUMé…ç½®åŸåˆ™**ï¼š

- **è‡ªåŠ¨VACUUM**ï¼šå¯ç”¨autovacuumè‡ªåŠ¨ç»´æŠ¤
- **å‚æ•°è°ƒä¼˜**ï¼šæ ¹æ®æ•°æ®å˜æ›´é¢‘ç‡è°ƒæ•´å‚æ•°
- **ç›‘æ§VACUUM**ï¼šç›‘æ§VACUUMæ‰§è¡Œæƒ…å†µ
- **å®šæœŸç»´æŠ¤**ï¼šå®šæœŸæ‰§è¡ŒVACUUM FULLï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

### 5.2 ç›‘æ§ä½“ç³»

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    COUNT(*) AS total_connections,
    COUNT(*) FILTER (WHERE state = 'active') AS active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') AS idle_connections,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction
FROM pg_stat_activity;

-- 2. ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_ratio
FROM pg_statio_user_tables;

-- 3. WALç›‘æ§
SELECT
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS replication_lag
FROM pg_stat_replication;

-- 4. æ£€æŸ¥ç‚¹ç›‘æ§
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time
FROM pg_stat_bgwriter;

-- 5. Autovacuumç›‘æ§
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    n_dead_tup,
    n_live_tup
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

**ç›‘æ§å‘Šè­¦é˜ˆå€¼**ï¼š

| æŒ‡æ ‡ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| **è¿æ¥æ•°** | 80% max_connections | 90% max_connections | æ¥è¿‘æœ€å¤§è¿æ¥æ•° |
| **ç¼“å­˜å‘½ä¸­ç‡** | < 95% | < 90% | ç¼“å­˜å‘½ä¸­ç‡ä½ |
| **WALå»¶è¿Ÿ** | > 1GB | > 10GB | å¤åˆ¶å»¶è¿Ÿ |
| **æ­»å…ƒç»„æ¯”ä¾‹** | > 20% | > 50% | éœ€è¦VACUUM |
| **é•¿äº‹åŠ¡** | > 1åˆ†é’Ÿ | > 5åˆ†é’Ÿ | é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ |

### 5.3 å¤‡ä»½æ¢å¤

**å¤‡ä»½ç­–ç•¥ï¼šå…¨é‡ + WALå½’æ¡£**ï¼š

```bash
# 1. å…¨é‡å¤‡ä»½
pg_basebackup -D /backup/basebackup -Ft -z -P

# 2. WALå½’æ¡£é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'

# 3. å®šæœŸå¤‡ä»½è„šæœ¬
#!/bin/bash
# backup.sh
BACKUP_DIR="/backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
pg_basebackup -D $BACKUP_DIR/basebackup -Ft -z -P

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
find /backup -type d -mtime +30 -exec rm -rf {} \;
```

**æ¢å¤æ¼”ç»ƒ**ï¼š

```bash
# 1. æ¢å¤å…¨é‡å¤‡ä»½
pg_ctl stop
rm -rf $PGDATA/*
tar -xzf /backup/basebackup/base.tar.gz -C $PGDATA

# 2. é…ç½®æ¢å¤ï¼ˆpostgresql.confï¼‰
restore_command = 'cp /backup/wal/%f %p'
recovery_target_time = '2025-01-15 12:00:00'

# 3. å¯åŠ¨æ¢å¤
pg_ctl start
```

### 5.4 å˜æ›´ç®¡ç†

**ç‰ˆæœ¬ä¸å‚æ•°å˜æ›´æµç¨‹**ï¼š

```sql
-- âœ… å˜æ›´å‰æ£€æŸ¥
-- 1. æ£€æŸ¥å½“å‰é…ç½®
SHOW all;

-- 2. æ£€æŸ¥å‚æ•°å½±å“
SELECT name, setting, unit, context
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem');

-- 3. é¢„ç”Ÿäº§éªŒè¯
-- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å˜æ›´æ•ˆæœ

-- âœ… å˜æ›´æ‰§è¡Œ
-- 1. ä¿®æ”¹é…ç½®æ–‡ä»¶
ALTER SYSTEM SET shared_buffers = '4GB';

-- 2. é‡æ–°åŠ è½½é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
SELECT pg_reload_conf();

-- 3. éªŒè¯å˜æ›´
SHOW shared_buffers;
```

**å˜æ›´ç®¡ç†åŸåˆ™**ï¼š

- **ç°åº¦éªŒè¯**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- **é€æ­¥æ¨è¿›**ï¼šåˆ†é˜¶æ®µæ¨è¿›å˜æ›´
- **å›æ»šå‡†å¤‡**ï¼šå‡†å¤‡å›æ»šæ–¹æ¡ˆ
- **ç›‘æ§éªŒè¯**ï¼šå˜æ›´åç›‘æ§ç³»ç»ŸçŠ¶æ€

---

## å…­ã€å®‰å…¨åŠ å›ºæœ€ä½³å®è·µ

### 6.1 è®¿é—®æ§åˆ¶

**RLSä¸æœ€å°æƒé™**ï¼š

```sql
-- âœ… å¯ç”¨RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- âœ… åˆ›å»ºRLSç­–ç•¥
CREATE POLICY user_access_policy ON users
    FOR ALL
    TO app_user
    USING (user_id = current_setting('app.user_id')::BIGINT);

-- âœ… æœ€å°æƒé™åŸåˆ™
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER readonly_user WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE mydb TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆåªå…è®¸ç‰¹å®šæ“ä½œï¼‰
CREATE USER app_user WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE mydb TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE ON users TO app_user;
GRANT SELECT ON orders TO app_user;
```

### 6.2 æ•°æ®åŠ å¯†

**ä¼ è¾“åŠ å¯†**ï¼š

```conf
# postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'

# pg_hba.conf
hostssl    all    all    0.0.0.0/0    md5
```

**é™æ€åŠ å¯†**ï¼š

```sql
-- âœ… ä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•æ„Ÿæ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255),
    password_hash TEXT,  -- å­˜å‚¨å“ˆå¸Œå€¼ï¼Œä¸å­˜å‚¨æ˜æ–‡
    credit_card_encrypted BYTEA  -- åŠ å¯†å­˜å‚¨
);

-- åŠ å¯†æ•°æ®
INSERT INTO users (email, credit_card_encrypted)
VALUES (
    'user@example.com',
    pgp_sym_encrypt('1234-5678-9012-3456', 'encryption_key')
);

-- è§£å¯†æ•°æ®
SELECT email, pgp_sym_decrypt(credit_card_encrypted, 'encryption_key')
FROM users WHERE id = 1;
```

**æ•æ„Ÿæ•°æ®è„±æ•**ï¼š

```sql
-- âœ… åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW users_masked AS
SELECT
    id,
    email,
    SUBSTRING(email FROM 1 FOR 3) || '***' AS email_masked,
    '***' AS password_hash,
    created_at
FROM users;
```

### 6.3 å®¡è®¡æ—¥å¿—

**å®¡è®¡ä¸å‘Šè­¦ç•™ç—•**ï¼š

```sql
-- âœ… å¯ç”¨å®¡è®¡æ—¥å¿—
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
SELECT pg_reload_conf();

-- âœ… åˆ›å»ºå®¡è®¡è¡¨
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    operation_type TEXT NOT NULL,
    table_name TEXT,
    old_values JSONB,
    new_values JSONB,
    query_text TEXT,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- âœ… å®¡è®¡è§¦å‘å™¨
CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (
        username, operation_type, table_name,
        old_values, new_values, query_text
    ) VALUES (
        current_user,
        TG_OP,
        TG_TABLE_NAME,
        CASE WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD) ELSE NULL END,
        CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN to_jsonb(NEW) ELSE NULL END,
        current_query()
    );
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨å®¡è®¡è§¦å‘å™¨
CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger();
```

---

## ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 7.1 æ•°æ®ç±»å‹é€‰æ‹©å¯¹æ¯”

| åœºæ™¯ | æ¨èç±»å‹ | æ›¿ä»£æ–¹æ¡ˆ | é€‰æ‹©åŸå›  |
|------|---------|---------|---------|
| **æ•´æ•°ID** | BIGSERIAL | INTEGER | é¿å…æº¢å‡º |
| **é‡‘é¢** | NUMERIC | REAL/DOUBLE | ç²¾åº¦è¦æ±‚ |
| **æ—¶é—´æˆ³** | TIMESTAMPTZ | TIMESTAMP | æ—¶åŒºæ”¯æŒ |
| **æšä¸¾** | ENUM | VARCHAR | ç±»å‹å®‰å…¨ |
| **æ•°ç»„** | ARRAY | JSONB | åŸç”Ÿæ”¯æŒ |
| **JSON** | JSONB | JSON | æŸ¥è¯¢æ€§èƒ½ |
| **èŒƒå›´** | RANGE | ä¸¤ä¸ªå­—æ®µ | åŸç”Ÿæ“ä½œ |

### 7.2 ç´¢å¼•ç­–ç•¥å¯¹æ¯”

| åœºæ™¯ | æ¨èç´¢å¼• | æ€§èƒ½æå‡ | å­˜å‚¨æˆæœ¬ |
|------|---------|---------|---------|
| **å•åˆ—æŸ¥è¯¢** | B-Tree | â­â­â­â­â­ | â­â­â­ |
| **å…¨æ–‡æœç´¢** | GIN | â­â­â­â­â­ | â­â­ |
| **æ•°ç»„æŸ¥è¯¢** | GIN | â­â­â­â­â­ | â­â­ |
| **JSONBæŸ¥è¯¢** | GIN | â­â­â­â­â­ | â­â­ |
| **èŒƒå›´æŸ¥è¯¢** | GiST | â­â­â­â­ | â­â­â­ |
| **æ—¶åºæ•°æ®** | BRIN | â­â­â­â­ | â­â­â­â­â­ |
| **è¦†ç›–æŸ¥è¯¢** | INCLUDE | â­â­â­â­â­ | â­â­â­ |

### 7.3 éš”ç¦»çº§åˆ«å¯¹æ¯”

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | æ¨èåœºæ™¯ |
|---------|------|-----------|------|------|---------|
| **READ UNCOMMITTED** | âŒ | âŒ | âŒ | â­â­â­â­â­ | PostgreSQLä¸æ”¯æŒ |
| **READ COMMITTED** | âœ… | âŒ | âŒ | â­â­â­â­â­ | é»˜è®¤ï¼Œå¤§å¤šæ•°åœºæ™¯ |
| **REPEATABLE READ** | âœ… | âœ… | âŒ | â­â­â­â­ | éœ€è¦å¯é‡å¤è¯» |
| **SERIALIZABLE** | âœ… | âœ… | âœ… | â­â­â­ | æœ€é«˜ä¸€è‡´æ€§è¦æ±‚ |

---

## å…«ã€å®è·µæ¡ˆä¾‹

### 8.1 é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡

**åœºæ™¯**ï¼šç”µå•†è®¢å•ç³»ç»Ÿï¼Œæ”¯æŒé«˜å¹¶å‘ä¸‹å•

**è®¾è®¡è¦ç‚¹**ï¼š

```sql
-- 1. è¡¨è®¾è®¡
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    total_amount NUMERIC(15, 2) NOT NULL,
    status order_status_enum NOT NULL DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY RANGE (created_at);

-- 2. ç´¢å¼•è®¾è®¡
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);

-- 3. è¿æ¥æ± é…ç½®
-- max_connections = 200
-- shared_buffers = 4GB
-- work_mem = 16MB

-- 4. äº‹åŠ¡è®¾è®¡ï¼ˆçŸ­äº‹åŠ¡ï¼‰
BEGIN;
    INSERT INTO orders (order_no, user_id, total_amount) VALUES (...);
    UPDATE inventory SET stock = stock - 1 WHERE product_id = ...;
COMMIT;
```

### 8.2 å¤§æ•°æ®é‡ç³»ç»Ÿè®¾è®¡

**åœºæ™¯**ï¼šæ—¥å¿—åˆ†æç³»ç»Ÿï¼Œæ¯å¤©äº§ç”ŸTBçº§æ•°æ®

**è®¾è®¡è¦ç‚¹**ï¼š

```sql
-- 1. åˆ†åŒºè®¾è®¡
CREATE TABLE logs (
    id BIGSERIAL,
    log_level TEXT,
    message TEXT,
    created_at TIMESTAMPTZ NOT NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- 2. BRINç´¢å¼•
CREATE INDEX idx_logs_created_at ON logs USING BRIN (created_at)
WITH (pages_per_range = 128);

-- 3. å‹ç¼©ç­–ç•¥
ALTER TABLE logs_2024_01 SET (
    toast_tuple_target = 128,
    fillfactor = 100
);

-- 4. å½’æ¡£ç­–ç•¥
-- å®šæœŸå°†æ—§åˆ†åŒºç§»åŠ¨åˆ°å½’æ¡£å­˜å‚¨
```

### 8.3 é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡

**åœºæ™¯**ï¼šé‡‘èç³»ç»Ÿï¼Œè¦æ±‚99.99%å¯ç”¨æ€§

**è®¾è®¡è¦ç‚¹**ï¼š

```sql
-- 1. ä¸»ä»å¤åˆ¶
-- ä¸»åº“é…ç½®
wal_level = replica
max_wal_senders = 3
wal_keep_size = 1GB

-- ä»åº“é…ç½®
hot_standby = on
primary_conninfo = 'host=master port=5432 user=repl'

-- 2. è‡ªåŠ¨æ•…éšœè½¬ç§»
-- ä½¿ç”¨Patroniæˆ–pg_auto_failover

-- 3. å¤‡ä»½ç­–ç•¥
-- å…¨é‡å¤‡ä»½ï¼šæ¯å¤©
-- WALå½’æ¡£ï¼šå®æ—¶
-- å¤‡ä»½ä¿ç•™ï¼š30å¤©

-- 4. ç›‘æ§å‘Šè­¦
-- è¿æ¥æ•°ã€å¤åˆ¶å»¶è¿Ÿã€ç£ç›˜ç©ºé—´ç­‰
```

---

## ä¹ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 9.1 æ€§èƒ½é—®é¢˜

**é—®é¢˜1ï¼šæŸ¥è¯¢æ…¢**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- æ£€æŸ¥æ‰§è¡Œè®¡åˆ’
- åˆ›å»ºåˆé€‚çš„ç´¢å¼•
- ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

**é—®é¢˜2ï¼šè¿æ¥æ•°è¿‡å¤š**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨è¿æ¥æ± ï¼ˆpgBouncerï¼‰
- ä¼˜åŒ–åº”ç”¨è¿æ¥ç®¡ç†
- å¢åŠ max_connectionsï¼ˆè°¨æ…ï¼‰

**é—®é¢˜3ï¼šé”ç­‰å¾…**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ç¼©çŸ­äº‹åŠ¡æ—¶é—´
- ä¼˜åŒ–é”ç²’åº¦
- ä½¿ç”¨SKIP LOCKED
- é¿å…é•¿äº‹åŠ¡

### 9.2 æ•°æ®é—®é¢˜

**é—®é¢˜1ï¼šæ•°æ®ä¸ä¸€è‡´**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- æ·»åŠ çº¦æŸæ£€æŸ¥
- å®šæœŸæ•°æ®æ ¡éªŒ

**é—®é¢˜2ï¼šæ•°æ®ä¸¢å¤±**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- å®Œå–„å¤‡ä»½ç­–ç•¥
- å¯ç”¨WALå½’æ¡£
- å®šæœŸæ¢å¤æ¼”ç»ƒ

### 9.3 è¿ç»´é—®é¢˜

**é—®é¢˜1ï¼šVACUUMä¸åŠæ—¶**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- è°ƒæ•´autovacuumå‚æ•°
- æ‰‹åŠ¨æ‰§è¡ŒVACUUM
- ç›‘æ§æ­»å…ƒç»„æ•°é‡

**é—®é¢˜2ï¼šç£ç›˜ç©ºé—´ä¸è¶³**:

**è§£å†³æ–¹æ¡ˆ**ï¼š

- å®šæœŸæ¸…ç†æ—§æ•°æ®
- å‹ç¼©å†å²æ•°æ®
- æ‰©å±•å­˜å‚¨ç©ºé—´

---

## åã€å‚è€ƒèµ„æº

### 10.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [PostgreSQLæ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/performance-tips.html)
- [PostgreSQLè¿ç»´æŒ‡å—](https://www.postgresql.org/docs/current/admin.html)

### 10.2 ç½‘ç»œèµ„æº

- [PostgreSQLæœ€ä½³å®è·µ](https://wiki.postgresql.org/wiki/Don%27t_Do_This)
- [é«˜æ€§èƒ½PostgreSQLå®æˆ˜](https://www.postgresql.org/docs/current/high-availability.html)
- [PostgreSQLå®‰å…¨æŒ‡å—](https://www.postgresql.org/docs/current/security.html)

### 10.3 ç›¸å…³æ–‡æ¡£

- `04-éƒ¨ç½²è¿ç»´/04.04-ç›‘æ§ä¸è¯Šæ–­.md`
- `04-éƒ¨ç½²è¿ç»´/04.05-å¤‡ä»½ä¸æ¢å¤.md`
- `01-æ ¸å¿ƒåŸºç¡€/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md`
- `01-æ ¸å¿ƒåŸºç¡€/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md`

---

**ç»´æŠ¤è€…**: Data-Science Team
**æœ€åæ›´æ–°**: 2025-01-15
**ç‰ˆæœ¬**: 1.0
