---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\bench\æ··åˆæŸ¥è¯¢-åŸºå‡†æ¨¡æ¿.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ··åˆæŸ¥è¯¢-åŸºå‡†æ¨¡æ¿

> **PostgreSQLç‰ˆæœ¬**: 18 â­ | 17 | 16
> **pgvectorç‰ˆæœ¬**: 2.0 â­ | 0.7+
> **æœ€åæ›´æ–°**: 2025-11-12

---

## 1. ç›®æ ‡

- åŒæ—¶è¦†ç›–ç»“æ„åŒ–ç­›é€‰ã€å…¨æ–‡ã€å‘é‡å¬å›çš„ç»„åˆæ€§èƒ½ï¼Œåº¦é‡ TP50/TP95/TP99 ä¸ååã€‚
- è¯„ä¼°ä¸åŒæ··åˆæŸ¥è¯¢ç­–ç•¥ï¼ˆRRFã€åŠ æƒèåˆã€åˆ†é˜¶æ®µå¬å›ï¼‰çš„æ€§èƒ½å·®å¼‚ã€‚
- æµ‹è¯•ä¸åŒç´¢å¼•å‚æ•°ï¼ˆHNSWã€IVFFlatï¼‰å¯¹æ··åˆæŸ¥è¯¢æ€§èƒ½çš„å½±å“ã€‚

---

## 2. ç¯å¢ƒå‡†å¤‡

### 2.1 å‰ç½®æ¡ä»¶

- PostgreSQL 16+ with pgvector extension
- è¶³å¤Ÿçš„æµ‹è¯•æ•°æ®ï¼ˆå»ºè®® 100ä¸‡+ æ–‡æ¡£ï¼‰
- å…¨æ–‡ç´¢å¼•ï¼ˆGINï¼‰å’Œå‘é‡ç´¢å¼•ï¼ˆHNSW/IVFFlatï¼‰å·²åˆ›å»º

### 2.2 æ•°æ®å‡†å¤‡

å‚è€ƒ `sql/vector_examples.sql` åˆ›å»ºæµ‹è¯•è¡¨ï¼š

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE IF NOT EXISTS docs (
    id bigserial PRIMARY KEY,
    text text NOT NULL,
    embedding vector(768),  -- æ ¹æ®å®é™…æ¨¡å‹è°ƒæ•´ç»´åº¦
    category text,
    created_at timestamptz DEFAULT now()
);

-- åˆ›å»ºå…¨æ–‡ç´¢å¼•
CREATE INDEX IF NOT EXISTS docs_text_gin
ON docs USING gin (to_tsvector('simple', text));

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆHNSWï¼‰
CREATE INDEX IF NOT EXISTS docs_hnsw
ON docs USING hnsw (embedding vector_l2_ops)
WITH (m = 32, ef_construction = 200);

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆIVFFlatï¼Œå¯é€‰ï¼‰
CREATE INDEX IF NOT EXISTS docs_ivfflat
ON docs USING ivfflat (embedding vector_l2_ops)
WITH (lists = 100);

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE docs;
```

### 2.3 æ•°æ®ç”Ÿæˆï¼ˆç¤ºä¾‹ï¼‰

```sql
-- ç”Ÿæˆæµ‹è¯•æ•°æ®ï¼ˆç¤ºä¾‹ï¼Œå®é™…åº”ä½¿ç”¨çœŸå®æ•°æ®ï¼‰
INSERT INTO docs (text, embedding, category)
SELECT
    'Document ' || generate_series || ' about ' ||
    (ARRAY['postgres', 'database', 'vector', 'search', 'ai'])[floor(random() * 5 + 1)],
    (SELECT array_agg(random())::vector(768) FROM generate_series(1, 768)),
    (ARRAY['tech', 'ai', 'database'])[floor(random() * 3 + 1)]
FROM generate_series(1, 1000000);
```

---

## 3. æµ‹è¯•è„šæœ¬

### 3.1 åŸºç¡€æ··åˆæŸ¥è¯¢ï¼ˆå…¨æ–‡ + å‘é‡ï¼‰

```sql
-- mix_basic.sql
\set qv random(1, 1000)
\set kw random(1, 5)
\set keyword :kw
\set query_vector :qv

WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', :keyword)) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', :keyword)
  ORDER BY tr DESC LIMIT 500
), v AS (
  SELECT id, embedding <-> (SELECT embedding FROM docs WHERE id = :query_vector LIMIT 1) AS dist
  FROM docs
  WHERE id IN (SELECT id FROM s)
  ORDER BY dist ASC LIMIT 100
)
SELECT count(*) FROM v;
```

### 3.2 RRF èåˆæŸ¥è¯¢

```sql
-- mix_rrf.sql
\set qv random(1, 1000)
\set kw random(1, 5)
\set keyword :kw
\set query_vector :qv

WITH vector_results AS (
    SELECT id,
           ROW_NUMBER() OVER (ORDER BY embedding <-> (SELECT embedding FROM docs WHERE id = :query_vector LIMIT 1)) AS vec_rank
    FROM docs
    WHERE embedding IS NOT NULL
    ORDER BY embedding <-> (SELECT embedding FROM docs WHERE id = :query_vector LIMIT 1)
    LIMIT 50
),
fulltext_results AS (
    SELECT id,
           ROW_NUMBER() OVER (
               ORDER BY ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', :keyword)) DESC
           ) AS text_rank
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', :keyword)
    LIMIT 50
)
SELECT
    COALESCE(v.id, f.id) AS id,
    COALESCE(1.0 / (60 + v.vec_rank), 0) + COALESCE(1.0 / (60 + f.text_rank), 0) AS rrf_score
FROM vector_results v
FULL OUTER JOIN fulltext_results f ON v.id = f.id
ORDER BY rrf_score DESC
LIMIT 10;
```

### 3.3 åŠ æƒèåˆæŸ¥è¯¢

```sql
-- mix_weighted.sql
\set qv random(1, 1000)
\set kw random(1, 5)
\set keyword :kw
\set query_vector :qv

WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', :keyword)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', :keyword)
    ORDER BY tr DESC LIMIT 500
), v AS (
    SELECT id,
           embedding <-> (SELECT embedding FROM docs WHERE id = :query_vector LIMIT 1) AS dist,
           (SELECT tr FROM s WHERE s.id = docs.id) AS tr
    FROM docs
    WHERE id IN (SELECT id FROM s)
    ORDER BY dist ASC LIMIT 100
)
SELECT id, 0.6 * (1.0 / (dist + 0.001)) + 0.4 * tr AS combined_score
FROM v
ORDER BY combined_score DESC
LIMIT 50;
```

### 3.4 ç»“æ„åŒ–è¿‡æ»¤ + æ··åˆæŸ¥è¯¢

```sql
-- mix_filtered.sql
\set qv random(1, 1000)
\set kw random(1, 5)
\set keyword :kw
\set query_vector :qv

WITH filtered AS (
    SELECT id, text, embedding
    FROM docs
    WHERE created_at >= now() - interval '30 days'
      AND category = 'tech'
),
text_search AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', :keyword)) AS tr
    FROM filtered
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', :keyword)
    ORDER BY tr DESC LIMIT 500
),
vector_search AS (
    SELECT id, embedding <-> (SELECT embedding FROM docs WHERE id = :query_vector LIMIT 1) AS dist
    FROM filtered
    WHERE id IN (SELECT id FROM text_search)
    ORDER BY dist ASC LIMIT 100
)
SELECT count(*) FROM vector_search;
```

---

## 4. è¿è¡Œæµ‹è¯•

### 4.1 åŸºç¡€å‹æµ‹

```bash
# å•è„šæœ¬æµ‹è¯•
pgbench -c 32 -j 32 -T 300 -f mix_basic.sql postgres

# å¤šè„šæœ¬å¯¹æ¯”æµ‹è¯•
pgbench -c 32 -j 32 -T 300 -f mix_basic.sql postgres > result_basic.log 2>&1
pgbench -c 32 -j 32 -T 300 -f mix_rrf.sql postgres > result_rrf.log 2>&1
pgbench -c 32 -j 32 -T 300 -f mix_weighted.sql postgres > result_weighted.log 2>&1
```

### 4.2 å‚æ•°è°ƒä¼˜æµ‹è¯•

```sql
-- æµ‹è¯•ä¸åŒ HNSW ef_search å‚æ•°
SET hnsw.ef_search = 40;
\i mix_basic.sql

SET hnsw.ef_search = 100;
\i mix_basic.sql

SET hnsw.ef_search = 200;
\i mix_basic.sql
```

```sql
-- æµ‹è¯•ä¸åŒ IVFFlat probes å‚æ•°
SET ivfflat.probes = 10;
\i mix_basic.sql

SET ivfflat.probes = 50;
\i mix_basic.sql

SET ivfflat.probes = 100;
\i mix_basic.sql
```

### 4.3 å¹¶å‘åº¦æµ‹è¯•

```bash
# ä¸åŒå¹¶å‘åº¦æµ‹è¯•
for clients in 8 16 32 64 128; do
    pgbench -c $clients -j $clients -T 300 -f mix_basic.sql postgres > result_c${clients}.log 2>&1
done
```

---

## 5. ç›‘æ§æŒ‡æ ‡

### 5.1 PostgreSQL æŒ‡æ ‡

```sql
-- æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆéœ€å¯ç”¨ pg_stat_statementsï¼‰
SELECT
    queryid,
    calls,
    total_exec_time,
    mean_exec_time,
    stddev_exec_time,
    min_exec_time,
    max_exec_time,
    substring(query, 1, 100) AS query_preview
FROM pg_stat_statements
WHERE query LIKE '%mix%' OR query LIKE '%docs%'
ORDER BY total_exec_time DESC
LIMIT 10;

-- ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'docs'
ORDER BY idx_scan DESC;

-- è¡¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
WHERE tablename = 'docs';
```

### 5.2 ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# CPU å’Œå†…å­˜ç›‘æ§
sar -u 1 300 > cpu.log &
sar -r 1 300 > memory.log &

# IO ç›‘æ§
iostat -x 1 300 > io.log &

# ç½‘ç»œç›‘æ§ï¼ˆå¦‚é€‚ç”¨ï¼‰
sar -n DEV 1 300 > network.log &
```

### 5.3 æŸ¥è¯¢è®¡åˆ’åˆ†æ

```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, WAL, SUMMARY, VERBOSE)
WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', 'postgres')) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', 'postgres')
  ORDER BY tr DESC LIMIT 500
), v AS (
  SELECT id, embedding <-> (SELECT embedding FROM docs LIMIT 1) AS dist
  FROM docs
  WHERE id IN (SELECT id FROM s)
  ORDER BY dist ASC LIMIT 100
)
SELECT count(*) FROM v;
```

---

## 6. ç»“æœè®°å½•

### 6.1 æ€§èƒ½æŒ‡æ ‡è®°å½•è¡¨

| æµ‹è¯•åœºæ™¯ | TPS | TP50 (ms) | TP95 (ms) | TP99 (ms) | å¹³å‡å»¶è¿Ÿ (ms) | CPU (%) | IO (MB/s) |
|---------|-----|-----------|-----------|-----------|---------------|---------|-----------|
| åŸºç¡€æ··åˆæŸ¥è¯¢ | | | | | | | |
| RRF èåˆ | | | | | | | |
| åŠ æƒèåˆ | | | | | | | |
| ç»“æ„åŒ–è¿‡æ»¤+æ··åˆ | | | | | | | |

### 6.2 ç´¢å¼•å‚æ•°å¯¹æ¯”

| ç´¢å¼•ç±»å‹ | å‚æ•° | TPS | TP95 (ms) | å¬å›ç‡@100 | å¤‡æ³¨ |
|---------|------|-----|-----------|------------|------|
| HNSW | ef_search=40 | | | | |
| HNSW | ef_search=100 | | | | |
| HNSW | ef_search=200 | | | | |
| IVFFlat | probes=10 | | | | |
| IVFFlat | probes=50 | | | | |
| IVFFlat | probes=100 | | | | |

### 6.3 å¹¶å‘åº¦æµ‹è¯•ç»“æœ

| å¹¶å‘æ•° | TPS | TP95 (ms) | TP99 (ms) | é”™è¯¯ç‡ | å¤‡æ³¨ |
|--------|-----|-----------|-----------|--------|------|
| 8 | | | | | |
| 16 | | | | | |
| 32 | | | | | |
| 64 | | | | | |
| 128 | | | | | |

### 6.4 è®°å½•æ¨¡æ¿

```markdown
## æµ‹è¯•ç¯å¢ƒ
- **ç¡¬ä»¶**: CPUå‹å·ã€å†…å­˜ã€å­˜å‚¨ç±»å‹
- **ç³»ç»Ÿ**: OSç‰ˆæœ¬ã€å†…æ ¸ç‰ˆæœ¬
- **PostgreSQLç‰ˆæœ¬**: 18.x
- **pgvectorç‰ˆæœ¬**: 2.0.x
- **æ•°æ®è§„æ¨¡**: æ–‡æ¡£æ•°é‡ã€å‘é‡ç»´åº¦ã€ç´¢å¼•å¤§å°

## é…ç½®å‚æ•°
- **shared_buffers**:
- **work_mem**:
- **maintenance_work_mem**:
- **effective_cache_size**:
- **max_connections**:

## æµ‹è¯•ç»“æœ
- **æµ‹è¯•æ—¶é—´**:
- **æµ‹è¯•è„šæœ¬**:
- **TPS**:
- **å»¶è¿Ÿåˆ†ä½**: TP50=, TP95=, TP99=
- **ç³»ç»Ÿèµ„æº**: CPU=%, Memory=%, IO=MB/s

## å…³é”®å‘ç°
-
-

## ä¼˜åŒ–å»ºè®®
-
-
```

---

## 7. æ€§èƒ½è°ƒä¼˜å»ºè®®

### 7.1 ç´¢å¼•ä¼˜åŒ–

- **HNSW ç´¢å¼•**ï¼šé€‚åˆé«˜ç²¾åº¦ã€ä½å»¶è¿Ÿåœºæ™¯
  - `m`: æ§åˆ¶å›¾è¿æ¥æ•°ï¼Œå»ºè®® 16-32
  - `ef_construction`: æ„å»ºæ—¶ç²¾åº¦ï¼Œå»ºè®® 100-200
  - `ef_search`: æŸ¥è¯¢æ—¶ç²¾åº¦ï¼Œå»ºè®® 40-200ï¼ˆè¶Šå¤§è¶Šæ…¢ä½†è¶Šå‡†ï¼‰

- **IVFFlat ç´¢å¼•**ï¼šé€‚åˆå¤§è§„æ¨¡æ•°æ®ã€å¯æ¥å—è¿‘ä¼¼ç»“æœ
  - `lists`: æ§åˆ¶èšç±»æ•°ï¼Œå»ºè®® `sqrt(rows)`
  - `probes`: æŸ¥è¯¢æ—¶æ‰«æåˆ—è¡¨æ•°ï¼Œå»ºè®® 10-100

### 7.2 æŸ¥è¯¢ä¼˜åŒ–

- **åˆ†é˜¶æ®µå¬å›**ï¼šå…ˆç”¨å…¨æ–‡æœç´¢ç¼©å°å€™é€‰é›†ï¼Œå†ç”¨å‘é‡æœç´¢ç²¾æ’
- **é™åˆ¶å€™é€‰é›†å¤§å°**ï¼šå…¨æ–‡æœç´¢ LIMIT å»ºè®® 500-1000
- **ä½¿ç”¨ RRF**ï¼šæ— éœ€è°ƒå‚ï¼Œè‡ªåŠ¨èåˆå¤šè·¯å¬å›ç»“æœ
- **ç»“æ„åŒ–è¿‡æ»¤å‰ç½®**ï¼šåœ¨å‘é‡æœç´¢å‰åº”ç”¨æ—¶é—´ã€åˆ†ç±»ç­‰è¿‡æ»¤æ¡ä»¶

### 7.3 ç³»ç»Ÿå‚æ•°è°ƒä¼˜

```sql
-- å¢åŠ å·¥ä½œå†…å­˜ï¼ˆç”¨äºæ’åºå’Œå“ˆå¸Œï¼‰
SET work_mem = '256MB';

-- å¢åŠ ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç”¨äºç´¢å¼•æ„å»ºï¼‰
SET maintenance_work_mem = '2GB';

-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 100;
SET parallel_tuple_cost = 0.01;
```

---

## 8. éªŒè¯ä¸å›å½’

### 8.1 å¬å›ç‡éªŒè¯

```sql
-- å¯¹æ¯”æš´åŠ›æœç´¢ï¼ˆçœŸå€¼ï¼‰ä¸ç´¢å¼•æœç´¢çš„å¬å›ç‡
WITH brute_force AS (
    SELECT id, embedding <-> :query_vector AS dist
    FROM docs
    ORDER BY dist ASC
    LIMIT 100
),
index_search AS (
    SELECT id, embedding <-> :query_vector AS dist
    FROM docs
    ORDER BY embedding <-> :query_vector
    LIMIT 100
)
SELECT
    COUNT(DISTINCT bf.id) AS recall_count,
    COUNT(DISTINCT bf.id)::float / 100.0 AS recall_rate
FROM brute_force bf
INNER JOIN index_search idx ON bf.id = idx.id;
```

### 8.2 æ€§èƒ½åŸºçº¿

- å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œè®°å½•å…³é”®æŒ‡æ ‡
- æ¯æ¬¡é…ç½®å˜æ›´åå¯¹æ¯”åŸºçº¿ï¼Œç¡®ä¿æ— æ€§èƒ½å›å½’
- å®šæœŸè¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œç›‘æ§æ€§èƒ½è¶‹åŠ¿

---

## 9. å‚è€ƒèµ„æº

- **SQL ç¤ºä¾‹**: `sql/vector_examples.sql`
- **è½åœ°æŒ‡å—**: `runbook/04-å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—.md`
- **AI æ—¶ä»£ä¸“é¢˜**: `05-å‰æ²¿æŠ€æœ¯/AI-æ—¶ä»£/01-å‘é‡ä¸æ··åˆæœç´¢-pgvectorä¸RRF.md`
- **pgvector æ–‡æ¡£**: <https://github.com/pgvector/pgvector>
