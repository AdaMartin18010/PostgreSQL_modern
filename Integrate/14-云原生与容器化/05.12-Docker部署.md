---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\05-éƒ¨ç½²æ¶æ„\å®¹å™¨åŒ–éƒ¨ç½²\05.12-Dockeréƒ¨ç½².md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Docker éƒ¨ç½²æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [Docker éƒ¨ç½²æŒ‡å—](#docker-éƒ¨ç½²æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å•å®¹å™¨éƒ¨ç½²](#2-å•å®¹å™¨éƒ¨ç½²)
    - [2.1 åŸºæœ¬éƒ¨ç½²](#21-åŸºæœ¬éƒ¨ç½²)
    - [2.2 æ•°æ®æŒä¹…åŒ–](#22-æ•°æ®æŒä¹…åŒ–)
    - [2.3 è¿æ¥æµ‹è¯•](#23-è¿æ¥æµ‹è¯•)
  - [3. Docker Compose éƒ¨ç½²](#3-docker-compose-éƒ¨ç½²)
    - [3.1 åŸºæœ¬é…ç½®](#31-åŸºæœ¬é…ç½®)
    - [3.2 å®Œæ•´é…ç½®ç¤ºä¾‹](#32-å®Œæ•´é…ç½®ç¤ºä¾‹)
  - [4. æ•°æ®æŒä¹…åŒ–](#4-æ•°æ®æŒä¹…åŒ–)
    - [4.1 ä½¿ç”¨å‘½åå·ï¼ˆæ¨èï¼‰](#41-ä½¿ç”¨å‘½åå·æ¨è)
    - [4.2 ä½¿ç”¨ç»‘å®šæŒ‚è½½](#42-ä½¿ç”¨ç»‘å®šæŒ‚è½½)
    - [4.3 å¤‡ä»½æ•°æ®å·](#43-å¤‡ä»½æ•°æ®å·)
  - [5. ç½‘ç»œé…ç½®](#5-ç½‘ç»œé…ç½®)
    - [5.1 è‡ªå®šä¹‰ç½‘ç»œ](#51-è‡ªå®šä¹‰ç½‘ç»œ)
    - [5.2 è¿æ¥å…¶ä»–å®¹å™¨](#52-è¿æ¥å…¶ä»–å®¹å™¨)
  - [6. ç¯å¢ƒå˜é‡é…ç½®](#6-ç¯å¢ƒå˜é‡é…ç½®)
    - [6.1 å¸¸ç”¨ç¯å¢ƒå˜é‡](#61-å¸¸ç”¨ç¯å¢ƒå˜é‡)
    - [6.2 ä½¿ç”¨ .env æ–‡ä»¶](#62-ä½¿ç”¨-env-æ–‡ä»¶)
  - [7. è‡ªå®šä¹‰é…ç½®](#7-è‡ªå®šä¹‰é…ç½®)
    - [7.1 è‡ªå®šä¹‰ postgresql.conf](#71-è‡ªå®šä¹‰-postgresqlconf)
    - [7.2 åˆå§‹åŒ–è„šæœ¬](#72-åˆå§‹åŒ–è„šæœ¬)
  - [8. é«˜å¯ç”¨éƒ¨ç½²](#8-é«˜å¯ç”¨éƒ¨ç½²)
    - [8.1 ä¸»ä»å¤åˆ¶](#81-ä¸»ä»å¤åˆ¶)
  - [9. ç›‘æ§ä¸æ—¥å¿—](#9-ç›‘æ§ä¸æ—¥å¿—)
    - [9.1 æŸ¥çœ‹æ—¥å¿—](#91-æŸ¥çœ‹æ—¥å¿—)
    - [9.2 ä½¿ç”¨ Prometheus ç›‘æ§](#92-ä½¿ç”¨-prometheus-ç›‘æ§)
  - [9. ç”Ÿäº§çº§Docker Composeé…ç½®](#9-ç”Ÿäº§çº§docker-composeé…ç½®)
    - [9.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®](#91-å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®)
    - [9.2 å¤šå®¹å™¨ç¼–æ’é…ç½®](#92-å¤šå®¹å™¨ç¼–æ’é…ç½®)
    - [9.3 ç½‘ç»œå’Œå®‰å…¨é…ç½®](#93-ç½‘ç»œå’Œå®‰å…¨é…ç½®)
    - [9.4 èµ„æºé™åˆ¶å’Œä¼˜åŒ–](#94-èµ„æºé™åˆ¶å’Œä¼˜åŒ–)
  - [10. è‡ªå®šä¹‰é•œåƒæ„å»º](#10-è‡ªå®šä¹‰é•œåƒæ„å»º)
    - [10.1 å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–](#101-å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–)
    - [10.2 æ‰©å±•å®‰è£…å’Œé…ç½®](#102-æ‰©å±•å®‰è£…å’Œé…ç½®)
    - [10.3 æ€§èƒ½ä¼˜åŒ–é…ç½®](#103-æ€§èƒ½ä¼˜åŒ–é…ç½®)
    - [10.4 å®‰å…¨åŠ å›ºé…ç½®](#104-å®‰å…¨åŠ å›ºé…ç½®)
  - [11. å®¹å™¨ç›‘æ§å’Œæ—¥å¿—](#11-å®¹å™¨ç›‘æ§å’Œæ—¥å¿—)
    - [11.1 Dockeræ—¥å¿—æ”¶é›†é…ç½®](#111-dockeræ—¥å¿—æ”¶é›†é…ç½®)
    - [11.2 å®¹å™¨å¥åº·æ£€æŸ¥é…ç½®](#112-å®¹å™¨å¥åº·æ£€æŸ¥é…ç½®)
    - [11.3 Prometheusç›‘æ§é›†æˆ](#113-prometheusç›‘æ§é›†æˆ)
    - [11.4 æ—¥å¿—èšåˆå’Œåˆ†æ](#114-æ—¥å¿—èšåˆå’Œåˆ†æ)
  - [12. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­](#12-æ•…éšœæ’æŸ¥å’Œè¯Šæ–­)
    - [12.1 å®¹å™¨å¯åŠ¨é—®é¢˜æ’æŸ¥](#121-å®¹å™¨å¯åŠ¨é—®é¢˜æ’æŸ¥)
    - [12.2 æ•°æ®æŒä¹…åŒ–é—®é¢˜](#122-æ•°æ®æŒä¹…åŒ–é—®é¢˜)
    - [12.3 ç½‘ç»œè¿æ¥é—®é¢˜](#123-ç½‘ç»œè¿æ¥é—®é¢˜)
    - [12.4 æ€§èƒ½é—®é¢˜è¯Šæ–­](#124-æ€§èƒ½é—®é¢˜è¯Šæ–­)
  - [13. å¤‡ä»½å’Œæ¢å¤](#13-å¤‡ä»½å’Œæ¢å¤)
    - [13.1 æ•°æ®å·å¤‡ä»½](#131-æ•°æ®å·å¤‡ä»½)
    - [13.2 é€»è¾‘å¤‡ä»½](#132-é€»è¾‘å¤‡ä»½)
    - [13.3 è‡ªåŠ¨å¤‡ä»½è„šæœ¬](#133-è‡ªåŠ¨å¤‡ä»½è„šæœ¬)
  - [14. æ·±å…¥é˜…è¯»](#14-æ·±å…¥é˜…è¯»)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

ä½¿ç”¨ Docker éƒ¨ç½² PostgreSQL çš„ä¼˜åŠ¿ï¼š

- **å¿«é€Ÿéƒ¨ç½²**: ä¸€é”®å¯åŠ¨ PostgreSQL å®ä¾‹
- **ç¯å¢ƒéš”ç¦»**: å®¹å™¨åŒ–éƒ¨ç½²ï¼Œé¿å…ç¯å¢ƒå†²çª
- **æ˜“äºç®¡ç†**: ä½¿ç”¨ Docker Compose ç®¡ç†å¤šå®¹å™¨åº”ç”¨
- **ç‰ˆæœ¬æ§åˆ¶**: è½»æ¾åˆ‡æ¢ PostgreSQL ç‰ˆæœ¬

---

## 2. å•å®¹å™¨éƒ¨ç½²

### 2.1 åŸºæœ¬éƒ¨ç½²

```bash
# æ‹‰å–é•œåƒ
docker pull postgres:18

# è¿è¡Œå®¹å™¨
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  postgres:18
```

### 2.2 æ•°æ®æŒä¹…åŒ–

```bash
# ä½¿ç”¨å‘½åå·
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -v postgres_data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:18

# ä½¿ç”¨ç»‘å®šæŒ‚è½½
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -v /host/path:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:18
```

### 2.3 è¿æ¥æµ‹è¯•

```bash
# ä»å®¹å™¨å†…è¿æ¥
docker exec -it postgres psql -U postgres -d mydb

# ä»ä¸»æœºè¿æ¥
psql -h localhost -U postgres -d mydb
```

---

## 3. Docker Compose éƒ¨ç½²

### 3.1 åŸºæœ¬é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f postgres

# åœæ­¢æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

### 3.2 å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mysecretpassword}
      POSTGRES_DB: ${POSTGRES_DB:-mydb}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    networks:
      - postgres_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - postgres_network
    restart: unless-stopped

volumes:
  postgres_data:
  pgadmin_data:

networks:
  postgres_network:
    driver: bridge
```

---

## 4. æ•°æ®æŒä¹…åŒ–

### 4.1 ä½¿ç”¨å‘½åå·ï¼ˆæ¨èï¼‰

```yaml
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /host/path/to/data
```

### 4.2 ä½¿ç”¨ç»‘å®šæŒ‚è½½

```yaml
volumes:
  - /host/path:/var/lib/postgresql/data
```

### 4.3 å¤‡ä»½æ•°æ®å·

```bash
# å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres_backup.tar.gz /data

# æ¢å¤æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/postgres_backup.tar.gz -C /
```

---

## 5. ç½‘ç»œé…ç½®

### 5.1 è‡ªå®šä¹‰ç½‘ç»œ

```yaml
networks:
  postgres_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 5.2 è¿æ¥å…¶ä»–å®¹å™¨

```yaml
services:
  app:
    image: myapp:latest
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/mydb
    networks:
      - postgres_network
```

---

## 6. ç¯å¢ƒå˜é‡é…ç½®

### 6.1 å¸¸ç”¨ç¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `POSTGRES_USER` | æ•°æ®åº“è¶…çº§ç”¨æˆ· | `postgres` |
| `POSTGRES_PASSWORD` | æ•°æ®åº“å¯†ç  | éšæœºç”Ÿæˆ |
| `POSTGRES_DB` | åˆå§‹æ•°æ®åº“å | `POSTGRES_USER` |
| `POSTGRES_INITDB_ARGS` | initdb å‚æ•° | - |
| `POSTGRES_HOST_AUTH_METHOD` | è®¤è¯æ–¹æ³• | `scram-sha-256` |

### 6.2 ä½¿ç”¨ .env æ–‡ä»¶

```bash
# .env
POSTGRES_USER=postgres
POSTGRES_PASSWORD=mysecretpassword
POSTGRES_DB=mydb
POSTGRES_PORT=5432
```

```yaml
# docker-compose.yml
services:
  postgres:
    env_file:
      - .env
```

---

## 7. è‡ªå®šä¹‰é…ç½®

### 7.1 è‡ªå®šä¹‰ postgresql.conf

```bash
# åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
cat > postgresql.conf <<EOF
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB
EOF
```

```yaml
# docker-compose.yml
services:
  postgres:
    volumes:
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
```

### 7.2 åˆå§‹åŒ–è„šæœ¬

```sql
-- init.sql
CREATE DATABASE myapp;
CREATE USER myapp_user WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE myapp TO myapp_user;
```

```yaml
# docker-compose.yml
services:
  postgres:
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

---

## 8. é«˜å¯ç”¨éƒ¨ç½²

### 8.1 ä¸»ä»å¤åˆ¶

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres-primary:
    image: postgres:18
    container_name: postgres-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicator_password
    volumes:
      - primary_data:/var/lib/postgresql/data
      - ./primary.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    networks:
      - postgres_network

  postgres-replica:
    image: postgres:18
    container_name: postgres-replica
    environment:
      PGUSER: replicator
      PGPASSWORD: replicator_password
      POSTGRES_MASTER_SERVICE: postgres-primary
    volumes:
      - replica_data:/var/lib/postgresql/data
    depends_on:
      - postgres-primary
    ports:
      - "5433:5432"
    networks:
      - postgres_network

volumes:
  primary_data:
  replica_data:

networks:
  postgres_network:
```

---

## 9. ç›‘æ§ä¸æ—¥å¿—

### 9.1 æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs postgres

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs -f postgres

# æŸ¥çœ‹æœ€å100è¡Œ
docker logs --tail 100 postgres
```

### 9.2 ä½¿ç”¨ Prometheus ç›‘æ§

```yaml
# docker-compose.yml
services:
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:password@postgres:5432/postgres?sslmode=disable
    ports:
      - "9187:9187"
    depends_on:
      - postgres
    networks:
      - postgres_network
```

---

## 9. ç”Ÿäº§çº§Docker Composeé…ç½®

### 9.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®

**ç”Ÿäº§çº§docker-compose.ymlé…ç½®**:

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres-prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-mydb}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      # PostgreSQL 18æ–°ç‰¹æ€§ï¼šå¼‚æ­¥I/O
      POSTGRES_INITDB_WALDIR: /var/lib/postgresql/wal
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_wal:/var/lib/postgresql/wal
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ./scripts/init:/docker-entrypoint-initdb.d
      - ./scripts/backup:/backup
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - hba_file=/etc/postgresql/pg_hba.conf
      - -c
      - wal_dir=/var/lib/postgresql/wal
    restart: always
    networks:
      - postgres_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ${POSTGRES_DB:-mydb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp
      - /var/tmp

  # PgBouncerè¿æ¥æ± 
  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: pgbouncer
    environment:
      DATABASES_HOST: postgres
      DATABASES_PORT: 5432
      DATABASES_USER: postgres
      DATABASES_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASES_DBNAME: ${POSTGRES_DB:-mydb}
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 1000
      PGBOUNCER_DEFAULT_POOL_SIZE: 25
      PGBOUNCER_MIN_POOL_SIZE: 5
      PGBOUNCER_RESERVE_POOL_SIZE: 5
    ports:
      - "6432:6432"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - postgres_network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Exporterï¼ˆç›‘æ§ï¼‰
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-mydb}?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - postgres_network
    restart: always

  # Prometheusï¼ˆç›‘æ§ï¼‰
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
    ports:
      - "9090:9090"
    networks:
      - postgres_network
    restart: always

  # Grafanaï¼ˆå¯è§†åŒ–ï¼‰
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - postgres_network
    restart: always

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres/data
  postgres_wal:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres/wal
  prometheus_data:
  grafana_data:

networks:
  postgres_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

**ç”Ÿäº§çº§postgresql.confé…ç½®**:

```conf
# config/postgresql.conf - PostgreSQL 18ç”Ÿäº§çº§é…ç½®

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 500
superuser_reserved_connections = 10

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 16MB
maintenance_work_mem = 512MB
temp_buffers = 16MB

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 16MB

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1
effective_io_concurrency = 200
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 128              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 4          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 10                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
# ============================================
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 500
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
```

### 9.2 å¤šå®¹å™¨ç¼–æ’é…ç½®

**å¤šç¯å¢ƒé…ç½®ç¤ºä¾‹**:

```yaml
# docker-compose.dev.yml - å¼€å‘ç¯å¢ƒ
version: '3.8'

services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: dev_password
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    profiles:
      - dev

volumes:
  postgres_dev_data:

---
# docker-compose.test.yml - æµ‹è¯•ç¯å¢ƒ
version: '3.8'

services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: test_password
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    profiles:
      - test

volumes:
  postgres_test_data:

---
# docker-compose.prod.yml - ç”Ÿäº§ç¯å¢ƒ
version: '3.8'

services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: always
    profiles:
      - prod

volumes:
  postgres_prod_data:
```

**ä½¿ç”¨æ–¹å¼**:

```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose --profile dev -f docker-compose.dev.yml up -d

# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
docker-compose --profile test -f docker-compose.test.yml up -d

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
docker-compose --profile prod -f docker-compose.prod.yml up -d
```

### 9.3 ç½‘ç»œå’Œå®‰å…¨é…ç½®

**ç½‘ç»œéš”ç¦»é…ç½®**:

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    networks:
      - internal_network
    # ä¸æš´éœ²ç«¯å£åˆ°ä¸»æœºï¼ˆä»…å†…éƒ¨è®¿é—®ï¼‰
    # ports:
    #   - "5432:5432"

  app:
    image: myapp:latest
    networks:
      - internal_network
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/mydb

networks:
  internal_network:
    driver: bridge
    internal: true  # å†…éƒ¨ç½‘ç»œï¼Œæ— æ³•è®¿é—®å¤–éƒ¨
```

**å®‰å…¨é…ç½®**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # æ ¹æ®éœ€è¦è°ƒæ•´
    read_only: false
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    user: "999:999"  # postgresç”¨æˆ·ID
```

### 9.4 èµ„æºé™åˆ¶å’Œä¼˜åŒ–

**èµ„æºé™åˆ¶é…ç½®**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 32768
        hard: 32768
```

**æ€§èƒ½ä¼˜åŒ–é…ç½®**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    shm_size: 2gb  # å…±äº«å†…å­˜å¤§å°
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=1g
      - /var/tmp:rw,noexec,nosuid,size=1g
    sysctls:
      - net.core.somaxconn=4096
      - net.ipv4.tcp_max_syn_backlog=4096
```

## 10. è‡ªå®šä¹‰é•œåƒæ„å»º

### 10.1 å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

**ä¼˜åŒ–çš„Dockerfile**:

```dockerfile
# Dockerfile
# æ„å»ºé˜¶æ®µ
FROM postgres:18 AS builder

# å®‰è£…ç¼–è¯‘å·¥å…·å’Œä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    postgresql-server-dev-18 \
    git \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…æ‰©å±•
RUN git clone https://github.com/pgvector/pgvector.git /tmp/pgvector && \
    cd /tmp/pgvector && \
    make && \
    make install

# è¿è¡Œé˜¶æ®µ
FROM postgres:18

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ‰©å±•
COPY --from=builder /usr/lib/postgresql/18/lib/pgvector.so /usr/lib/postgresql/18/lib/
COPY --from=builder /usr/share/postgresql/18/extension/pgvector* /usr/share/postgresql/18/extension/

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    postgresql-18-pgvector \
    postgresql-18-pg-stat-statements \
    postgresql-18-pgaudit \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY config/postgresql.conf /etc/postgresql/postgresql.conf
COPY config/pg_hba.conf /etc/postgresql/pg_hba.conf

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY scripts/init/* /docker-entrypoint-initdb.d/

# è®¾ç½®æƒé™
RUN chown -R postgres:postgres /var/lib/postgresql/data && \
    chmod 600 /etc/postgresql/pg_hba.conf

# ä½¿ç”¨è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬
COPY scripts/docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
```

**æ„å»ºå’Œæ¨é€**:

```bash
# æ„å»ºé•œåƒ
docker build -t mypostgres:18-custom .

# æ ‡è®°é•œåƒ
docker tag mypostgres:18-custom registry.example.com/mypostgres:18-custom

# æ¨é€é•œåƒ
docker push registry.example.com/mypostgres:18-custom
```

### 10.2 æ‰©å±•å®‰è£…å’Œé…ç½®

**å®‰è£…å¸¸ç”¨æ‰©å±•**:

```dockerfile
# Dockerfile
FROM postgres:18

# å®‰è£…æ‰©å±•
RUN apt-get update && apt-get install -y \
    postgresql-18-pgvector \
    postgresql-18-pg-stat-statements \
    postgresql-18-pgaudit \
    postgresql-18-pg-cron \
    postgresql-18-postgis \
    && rm -rf /var/lib/apt/lists/*

# åˆå§‹åŒ–è„šæœ¬å¯ç”¨æ‰©å±•
COPY scripts/init-extensions.sql /docker-entrypoint-initdb.d/
```

**æ‰©å±•åˆå§‹åŒ–è„šæœ¬**:

```sql
-- scripts/init-extensions.sql
-- å¯ç”¨å¸¸ç”¨æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
CREATE EXTENSION IF NOT EXISTS pgvector;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- é…ç½®pg_stat_statements
ALTER SYSTEM SET pg_stat_statements.max = 10000;
ALTER SYSTEM SET pg_stat_statements.track = all;
SELECT pg_reload_conf();
```

### 10.3 æ€§èƒ½ä¼˜åŒ–é…ç½®

**æ€§èƒ½ä¼˜åŒ–Dockerfile**:

```dockerfile
# Dockerfile
FROM postgres:18

# ä¼˜åŒ–é•œåƒå¤§å°
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-18-pg-stat-statements \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# å¤åˆ¶ä¼˜åŒ–çš„é…ç½®æ–‡ä»¶
COPY config/postgresql.conf /etc/postgresql/postgresql.conf

# è®¾ç½®ç¯å¢ƒå˜é‡ä¼˜åŒ–
ENV POSTGRES_INITDB_ARGS="--encoding=UTF8 --locale=C --data-checksums"
ENV POSTGRES_HOST_AUTH_METHOD=scram-sha-256
```

### 10.4 å®‰å…¨åŠ å›ºé…ç½®

**å®‰å…¨åŠ å›ºDockerfile**:

```dockerfile
# Dockerfile
FROM postgres:18

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r postgres && useradd -r -g postgres postgres

# å¤åˆ¶å®‰å…¨é…ç½®
COPY config/pg_hba.conf /etc/postgresql/pg_hba.conf
RUN chmod 600 /etc/postgresql/pg_hba.conf
RUN chown postgres:postgres /etc/postgresql/pg_hba.conf

# å¤åˆ¶SSLè¯ä¹¦
COPY ssl/server.crt /etc/postgresql/ssl/server.crt
COPY ssl/server.key /etc/postgresql/ssl/server.key
RUN chmod 600 /etc/postgresql/ssl/server.key
RUN chown postgres:postgres /etc/postgresql/ssl/server.key /etc/postgresql/ssl/server.crt

# ä½¿ç”¨érootç”¨æˆ·è¿è¡Œ
USER postgres
```

## 11. å®¹å™¨ç›‘æ§å’Œæ—¥å¿—

### 11.1 Dockeræ—¥å¿—æ”¶é›†é…ç½®

**æ—¥å¿—é©±åŠ¨é…ç½®**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "production,postgres"
```

**ä½¿ç”¨Fluentdæ”¶é›†æ—¥å¿—**:

```yaml
# docker-compose.yml
services:
  fluentd:
    image: fluent/fluentd:latest
    volumes:
      - ./config/fluentd.conf:/fluentd/etc/fluent.conf
      - ./logs:/var/log/fluentd
    ports:
      - "24224:24224"
    networks:
      - postgres_network

  postgres:
    image: postgres:18
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: postgres.{{.Name}}
        labels: "production,postgres"
    networks:
      - postgres_network
```

**Fluentdé…ç½®**:

```conf
# config/fluentd.conf
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<match postgres.**>
  @type file
  path /var/log/fluentd/postgres
  compress gzip
  <buffer>
    @type file
    path /var/log/fluentd/buffer
    flush_interval 5s
  </buffer>
</match>
```

### 11.2 å®¹å™¨å¥åº·æ£€æŸ¥é…ç½®

**å¥åº·æ£€æŸ¥é…ç½®**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d mydb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
```

**è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬**:

```bash
#!/bin/bash
# scripts/healthcheck.sh
set -e

# æ£€æŸ¥PostgreSQLæ˜¯å¦å°±ç»ª
pg_isready -U postgres -d mydb

# æ£€æŸ¥è¿æ¥æ•°
CONNECTIONS=$(psql -U postgres -d mydb -t -c "SELECT count(*) FROM pg_stat_activity;")
if [ "$CONNECTIONS" -gt 500 ]; then
  echo "Too many connections: $CONNECTIONS"
  exit 1
fi

# æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿï¼ˆå¦‚æœæœ‰ä»åº“ï¼‰
if psql -U postgres -d mydb -t -c "SELECT count(*) FROM pg_stat_replication;" | grep -q "0"; then
  echo "No replication configured"
else
  LAG=$(psql -U postgres -d mydb -t -c "SELECT max(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) FROM pg_stat_replication;")
  if [ "$LAG" -gt 10485760 ]; then  # 10MB
    echo "Replication lag too high: $LAG"
    exit 1
  fi
fi

exit 0
```

### 11.3 Prometheusç›‘æ§é›†æˆ

**Prometheusé…ç½®**:

```yaml
# config/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
    metrics_path: /metrics

  - job_name: 'docker'
    static_configs:
      - targets: ['host.docker.internal:9323']
```

**Grafanaä»ªè¡¨æ¿é…ç½®**:

```json
{
  "dashboard": {
    "title": "PostgreSQL Dockerç›‘æ§",
    "panels": [
      {
        "title": "å®¹å™¨CPUä½¿ç”¨ç‡",
        "targets": [
          {
            "expr": "rate(container_cpu_usage_seconds_total{name=\"postgres\"}[5m]) * 100"
          }
        ]
      },
      {
        "title": "å®¹å™¨å†…å­˜ä½¿ç”¨",
        "targets": [
          {
            "expr": "container_memory_usage_bytes{name=\"postgres\"}"
          }
        ]
      },
      {
        "title": "PostgreSQLè¿æ¥æ•°",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"mydb\"}"
          }
        ]
      }
    ]
  }
}
```

### 11.4 æ—¥å¿—èšåˆå’Œåˆ†æ

**ä½¿ç”¨ELK Stack**:

```yaml
# docker-compose.yml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.0.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.0.0
    volumes:
      - ./config/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    depends_on:
      - elasticsearch

  kibana:
    image: docker.elastic.co/kibana/kibana:8.0.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  postgres:
    image: postgres:18
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://logstash:12201"
        tag: "postgres"
```

## 12. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­

### 12.1 å®¹å™¨å¯åŠ¨é—®é¢˜æ’æŸ¥

**å¸¸è§å¯åŠ¨é—®é¢˜**:

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a | grep postgres

# 2. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs postgres
docker logs --tail 100 -f postgres

# 3. æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats postgres

# 4. è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it postgres bash

# 5. æ£€æŸ¥é…ç½®æ–‡ä»¶
docker exec postgres cat /etc/postgresql/postgresql.conf

# 6. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
docker exec postgres ls -la /var/lib/postgresql/data

# 7. æ£€æŸ¥ç«¯å£å ç”¨
docker port postgres
netstat -tlnp | grep 5432
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

```bash
# é”™è¯¯1: "Error response from daemon: driver failed programming external connectivity"
# åŸå› : ç«¯å£å·²è¢«å ç”¨
# è§£å†³: æ›´æ”¹ç«¯å£æˆ–åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨
docker-compose down
docker-compose up -d

# é”™è¯¯2: "Permission denied" æ•°æ®ç›®å½•
# åŸå› : æ•°æ®ç›®å½•æƒé™é—®é¢˜
# è§£å†³: ä¿®å¤æƒé™
sudo chown -R 999:999 /data/postgres/data
sudo chmod 700 /data/postgres/data

# é”™è¯¯3: "Container keeps restarting"
# åŸå› : é…ç½®é”™è¯¯æˆ–å¯åŠ¨å¤±è´¥
# è§£å†³: æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºå…·ä½“é”™è¯¯
docker logs postgres
docker inspect postgres | grep -A 10 "State"
```

### 12.2 æ•°æ®æŒä¹…åŒ–é—®é¢˜

**æ•°æ®æŒä¹…åŒ–é—®é¢˜æ’æŸ¥**:

```bash
# 1. æ£€æŸ¥æ•°æ®å·
docker volume ls
docker volume inspect postgres_data

# 2. æ£€æŸ¥æ•°æ®å·æŒ‚è½½
docker inspect postgres | grep -A 10 "Mounts"

# 3. æ£€æŸ¥æ•°æ®ç›®å½•å†…å®¹
docker exec postgres ls -la /var/lib/postgresql/data

# 4. å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres_backup.tar.gz -C /data .

# 5. æ¢å¤æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine sh -c "cd /data && tar xzf /backup/postgres_backup.tar.gz"
```

**æ•°æ®è¿ç§»**:

```bash
# ä»æ—§å®¹å™¨è¿ç§»æ•°æ®åˆ°æ–°å®¹å™¨
# 1. å¤‡ä»½æ—§æ•°æ®
docker exec old_postgres pg_dump -U postgres mydb > backup.sql

# 2. åœ¨æ–°å®¹å™¨ä¸­æ¢å¤
docker exec -i new_postgres psql -U postgres mydb < backup.sql

# æˆ–ä½¿ç”¨æ•°æ®å·è¿ç§»
docker run --rm \
  -v old_postgres_data:/old_data \
  -v new_postgres_data:/new_data \
  alpine sh -c "cp -r /old_data/* /new_data/"
```

### 12.3 ç½‘ç»œè¿æ¥é—®é¢˜

**ç½‘ç»œé—®é¢˜æ’æŸ¥**:

```bash
# 1. æ£€æŸ¥ç½‘ç»œé…ç½®
docker network ls
docker network inspect postgres_network

# 2. æµ‹è¯•å®¹å™¨é—´è¿æ¥
docker exec postgres ping -c 3 app

# 3. æ£€æŸ¥DNSè§£æ
docker exec postgres nslookup app

# 4. æ£€æŸ¥ç«¯å£æ˜ å°„
docker port postgres

# 5. æµ‹è¯•å¤–éƒ¨è¿æ¥
psql -h localhost -U postgres -d mydb
telnet localhost 5432

# 6. æ£€æŸ¥é˜²ç«å¢™
sudo iptables -L -n | grep 5432
sudo firewall-cmd --list-all
```

**ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ**:

```yaml
# ä½¿ç”¨hostç½‘ç»œæ¨¡å¼ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºè°ƒè¯•ï¼‰
services:
  postgres:
    network_mode: host

# ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œ
networks:
  postgres_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
```

### 12.4 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# scripts/performance_diagnosis.sh

echo "=== PostgreSQLå®¹å™¨æ€§èƒ½è¯Šæ–­ ==="

# 1. å®¹å™¨èµ„æºä½¿ç”¨
echo "=== å®¹å™¨èµ„æºä½¿ç”¨ ==="
docker stats --no-stream postgres

# 2. æ•°æ®åº“è¿æ¥æ•°
echo "=== æ•°æ®åº“è¿æ¥æ•° ==="
docker exec postgres psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 3. æ…¢æŸ¥è¯¢
echo "=== æ…¢æŸ¥è¯¢Top 10 ==="
docker exec postgres psql -U postgres -c "SELECT query, calls, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# 4. è¡¨å¤§å°
echo "=== è¡¨å¤§å°Top 10 ==="
docker exec postgres psql -U postgres -c "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_stat_user_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;"

# 5. ç¼“å­˜å‘½ä¸­ç‡
echo "=== ç¼“å­˜å‘½ä¸­ç‡ ==="
docker exec postgres psql -U postgres -c "SELECT 'index hit rate' AS name, (sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read), 0) AS ratio FROM pg_statio_user_indexes UNION ALL SELECT 'table hit rate' AS name, sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) AS ratio FROM pg_statio_user_tables;"

# 6. I/Oç»Ÿè®¡ï¼ˆPostgreSQL 18ï¼‰
echo "=== I/Oç»Ÿè®¡ ==="
docker exec postgres psql -U postgres -c "SELECT object, context, reads, writes, read_time, write_time FROM pg_stat_io ORDER BY reads DESC LIMIT 10;"
```

## 13. å¤‡ä»½å’Œæ¢å¤

### 13.1 æ•°æ®å·å¤‡ä»½

**æ•°æ®å·å¤‡ä»½è„šæœ¬**:

```bash
#!/bin/bash
# scripts/backup_volume.sh

BACKUP_DIR=/backup
VOLUME_NAME=postgres_data
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v $VOLUME_NAME:/data \
  -v $BACKUP_DIR:/backup \
  alpine tar czf /backup/postgres_${DATE}.tar.gz -C /data .

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "postgres_*.tar.gz" -mtime +7 -delete

echo "Backup completed: postgres_${DATE}.tar.gz"
```

**å®šæ—¶å¤‡ä»½ï¼ˆCronï¼‰**:

```yaml
# docker-compose.yml
services:
  backup:
    image: alpine:latest
    volumes:
      - postgres_data:/data:ro
      - ./backup:/backup
      - ./scripts/backup_volume.sh:/backup_volume.sh
    command: /bin/sh -c "chmod +x /backup_volume.sh && /backup_volume.sh"
    restart: "no"
    depends_on:
      - postgres
```

### 13.2 é€»è¾‘å¤‡ä»½

**é€»è¾‘å¤‡ä»½è„šæœ¬**:

```bash
#!/bin/bash
# scripts/backup_logical.sh

BACKUP_DIR=/backup
DB_NAME=mydb
DB_USER=postgres
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# é€»è¾‘å¤‡ä»½
docker exec postgres pg_dump -U $DB_USER -F c -f /tmp/backup_${DATE}.dump $DB_NAME

# å¤åˆ¶å¤‡ä»½æ–‡ä»¶
docker cp postgres:/tmp/backup_${DATE}.dump $BACKUP_DIR/

# æ¸…ç†å®¹å™¨å†…ä¸´æ—¶æ–‡ä»¶
docker exec postgres rm /tmp/backup_${DATE}.dump

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.dump" -mtime +7 -delete

echo "Logical backup completed: backup_${DATE}.dump"
```

**æ¢å¤è„šæœ¬**:

```bash
#!/bin/bash
# scripts/restore_logical.sh

BACKUP_FILE=$1
DB_NAME=mydb
DB_USER=postgres

if [ -z "$BACKUP_FILE" ]; then
  echo "Usage: $0 <backup_file>"
  exit 1
fi

# å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°å®¹å™¨
docker cp $BACKUP_FILE postgres:/tmp/restore.dump

# æ¢å¤æ•°æ®åº“
docker exec postgres pg_restore -U $DB_USER -d $DB_NAME -c /tmp/restore.dump

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
docker exec postgres rm /tmp/restore.dump

echo "Database restored from $BACKUP_FILE"
```

### 13.3 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

**å®Œæ•´çš„è‡ªåŠ¨å¤‡ä»½æ–¹æ¡ˆ**:

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backup:/backup

  # ä½¿ç”¨pg_cronè¿›è¡Œå®šæ—¶å¤‡ä»½
  postgres-backup:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./scripts/backup.sh:/backup.sh
      - ./backup:/backup
    command: >
      bash -c "
      apt-get update && apt-get install -y cron &&
      chmod +x /backup.sh &&
      echo '0 2 * * * /backup.sh' | crontab - &&
      cron -f
      "
    depends_on:
      - postgres
```

**å¤‡ä»½è„šæœ¬**:

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR=/backup
DB_NAME=mydb
DB_USER=postgres
DB_PASSWORD=${POSTGRES_PASSWORD}
DB_HOST=postgres
DATE=$(date +%Y%m%d_%H%M%S)

# è®¾ç½®å¯†ç 
export PGPASSWORD=$DB_PASSWORD

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# é€»è¾‘å¤‡ä»½
pg_dump -h $DB_HOST -U $DB_USER -F c -f $BACKUP_DIR/backup_${DATE}.dump $DB_NAME

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/backup_${DATE}.dump

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.dump.gz" -mtime +7 -delete

# å‘é€å¤‡ä»½é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
# curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK \
#   -d "{\"text\":\"PostgreSQL backup completed: backup_${DATE}.dump.gz\"}"

echo "Backup completed: backup_${DATE}.dump.gz"
```

---

## 14. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [Kubernetes éƒ¨ç½²æŒ‡å—](./05.13-Kuberneteséƒ¨ç½².md) - Kuberneteséƒ¨ç½²
- â­â­ [äº‘åŸç”Ÿä¸å®¹å™¨åŒ–](./05.12-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–.md) - äº‘åŸç”Ÿæ¶æ„
- â­â­ [å•æœºéƒ¨ç½²ä¸é…ç½®](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.01-å•æœºéƒ¨ç½²ä¸é…ç½®.md) - å•æœºéƒ¨ç½²
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../../11-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

#### å®æˆ˜æ¡ˆä¾‹

- â­â­â­ [å®æˆ˜æ¡ˆä¾‹](../../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ

### å¤–éƒ¨èµ„æº

- [PostgreSQL Docker å®˜æ–¹é•œåƒ](https://hub.docker.com/_/postgres)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)

---

**æœ€åæ›´æ–°**: 2025-11-13
