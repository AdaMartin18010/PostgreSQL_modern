# Serverless PostgreSQLå®Œæ•´æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: äº‘åŽŸç”Ÿåº”ç”¨ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€æŒ‰éœ€ä»˜è´¹
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§
> **å‚è€ƒ**: [æŠ€æœ¯åŽŸç†/Serverlessæž¶æž„åŽŸç†.md](../æŠ€æœ¯åŽŸç†/Serverlessæž¶æž„åŽŸç†.md)

---

## ðŸ“‹ ç›®å½•

- [Serverless PostgreSQLå®Œæ•´æŒ‡å—](#serverless-postgresqlå®Œæ•´æŒ‡å—)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯Serverless PostgreSQLï¼Ÿ](#11-ä»€ä¹ˆæ˜¯serverless-postgresql)
    - [1.2 Serverless vs ä¼ ç»Ÿæ•°æ®åº“](#12-serverless-vs-ä¼ ç»Ÿæ•°æ®åº“)
  - [2. Serverlessæž¶æž„è®¾è®¡](#2-serverlessæž¶æž„è®¾è®¡)
    - [2.1 æž¶æž„æ¨¡å¼](#21-æž¶æž„æ¨¡å¼)
      - [2.1.1 æ— çŠ¶æ€è®¡ç®—å±‚](#211-æ— çŠ¶æ€è®¡ç®—å±‚)
      - [2.1.2 å­˜å‚¨ä¸Žè®¡ç®—åˆ†ç¦»](#212-å­˜å‚¨ä¸Žè®¡ç®—åˆ†ç¦»)
    - [2.2 æ ¸å¿ƒç»„ä»¶](#22-æ ¸å¿ƒç»„ä»¶)
      - [2.2.1 è‡ªåŠ¨æ‰©ç¼©å®¹æŽ§åˆ¶å™¨](#221-è‡ªåŠ¨æ‰©ç¼©å®¹æŽ§åˆ¶å™¨)
      - [2.2.2 è¿žæŽ¥æ± ç®¡ç†](#222-è¿žæŽ¥æ± ç®¡ç†)
  - [3. è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶](#3-è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶)
    - [3.1 æ‰©ç¼©å®¹ç­–ç•¥](#31-æ‰©ç¼©å®¹ç­–ç•¥)
      - [3.1.1 åŸºäºŽCPUä½¿ç”¨çŽ‡](#311-åŸºäºŽcpuä½¿ç”¨çŽ‡)
      - [3.1.2 åŸºäºŽè¿žæŽ¥æ•°](#312-åŸºäºŽè¿žæŽ¥æ•°)
      - [3.1.3 åŸºäºŽæŸ¥è¯¢è´Ÿè½½](#313-åŸºäºŽæŸ¥è¯¢è´Ÿè½½)
    - [3.2 Scale-to-Zeroæœºåˆ¶](#32-scale-to-zeroæœºåˆ¶)
      - [3.2.1 é›¶æµé‡æ£€æµ‹](#321-é›¶æµé‡æ£€æµ‹)
      - [3.2.2 å†·å¯åŠ¨ä¼˜åŒ–](#322-å†·å¯åŠ¨ä¼˜åŒ–)
  - [4. æˆæœ¬ä¼˜åŒ–ç­–ç•¥](#4-æˆæœ¬ä¼˜åŒ–ç­–ç•¥)
    - [4.1 æˆæœ¬åˆ†æž](#41-æˆæœ¬åˆ†æž)
      - [4.1.1 æˆæœ¬æž„æˆ](#411-æˆæœ¬æž„æˆ)
      - [4.1.2 æˆæœ¬ç›‘æŽ§](#412-æˆæœ¬ç›‘æŽ§)
    - [4.2 ä¼˜åŒ–ç­–ç•¥](#42-ä¼˜åŒ–ç­–ç•¥)
      - [4.2.1 æŸ¥è¯¢ä¼˜åŒ–](#421-æŸ¥è¯¢ä¼˜åŒ–)
      - [4.2.2 è¿žæŽ¥ä¼˜åŒ–](#422-è¿žæŽ¥ä¼˜åŒ–)
      - [4.2.3 å­˜å‚¨ä¼˜åŒ–](#423-å­˜å‚¨ä¼˜åŒ–)
  - [5. æœ€ä½³å®žè·µ](#5-æœ€ä½³å®žè·µ)
    - [5.1 æž¶æž„è®¾è®¡](#51-æž¶æž„è®¾è®¡)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
    - [5.3 æˆæœ¬æŽ§åˆ¶](#53-æˆæœ¬æŽ§åˆ¶)
    - [5.4 é«˜å¯ç”¨](#54-é«˜å¯ç”¨)
  - [ðŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯Serverless PostgreSQLï¼Ÿ

Serverless PostgreSQLæ˜¯ä¸€ç§æŒ‰éœ€è‡ªåŠ¨æ‰©ç¼©å®¹çš„æ•°æ®åº“æœåŠ¡æ¨¡å¼ï¼Œç”¨æˆ·æ— éœ€ç®¡ç†æœåŠ¡å™¨ï¼Œåªéœ€æŒ‰å®žé™…ä½¿ç”¨é‡ä»˜è´¹ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **è‡ªåŠ¨æ‰©ç¼©å®¹**: æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æº
- âœ… **æŒ‰éœ€ä»˜è´¹**: åªæ”¯ä»˜å®žé™…ä½¿ç”¨çš„èµ„æº
- âœ… **é›¶è¿ç»´**: æ— éœ€ç®¡ç†æœåŠ¡å™¨
- âœ… **é«˜å¯ç”¨**: è‡ªåŠ¨æ•…éšœæ¢å¤
- âœ… **Scale-to-Zero**: æ— æµé‡æ—¶è‡ªåŠ¨ç¼©å®¹åˆ°é›¶

### 1.2 Serverless vs ä¼ ç»Ÿæ•°æ®åº“

| ç‰¹æ€§ | Serverless | ä¼ ç»Ÿæ•°æ®åº“ |
|------|-----------|-----------|
| **èµ„æºç®¡ç†** | è‡ªåŠ¨ | æ‰‹åŠ¨ |
| **æˆæœ¬æ¨¡å¼** | æŒ‰ä½¿ç”¨é‡ | å›ºå®šæˆæœ¬ |
| **è¿ç»´å¤æ‚åº¦** | ä½Ž | é«˜ |
| **å¯åŠ¨æ—¶é—´** | ç§’çº§ | åˆ†é’Ÿçº§ |
| **é€‚ç”¨åœºæ™¯** | é—´æ­‡æ€§è´Ÿè½½ | æŒç»­è´Ÿè½½ |

---

## 2. Serverlessæž¶æž„è®¾è®¡

### 2.1 æž¶æž„æ¨¡å¼

#### 2.1.1 æ— çŠ¶æ€è®¡ç®—å±‚

```text
åº”ç”¨å±‚
    â†“
APIç½‘å…³
    â†“
æ— çŠ¶æ€è®¡ç®—å±‚ (è‡ªåŠ¨æ‰©ç¼©å®¹)
    â†“
è¿žæŽ¥æ± 
    â†“
PostgreSQLå®žä¾‹ (æŒ‰éœ€å¯åŠ¨)
```

#### 2.1.2 å­˜å‚¨ä¸Žè®¡ç®—åˆ†ç¦»

```text
è®¡ç®—å±‚ (æŒ‰éœ€å¯åŠ¨)
    â†“
ç½‘ç»œå±‚
    â†“
å­˜å‚¨å±‚ (æŒä¹…åŒ–)
    â†“
å¤‡ä»½å±‚ (è‡ªåŠ¨å¤‡ä»½)
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 è‡ªåŠ¨æ‰©ç¼©å®¹æŽ§åˆ¶å™¨

```yaml
# Kubernetes HPAé…ç½®ç¤ºä¾‹
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgresql-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: postgresql-serverless
  minReplicas: 0  # Scale-to-Zero
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

#### 2.2.2 è¿žæŽ¥æ± ç®¡ç†

```sql
-- ä½¿ç”¨PgBouncerå®žçŽ°è¿žæŽ¥æ± 
-- pgbouncer.ini
[databases]
serverless_db = host=postgresql-serverless port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
```

---

## 3. è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶

### 3.1 æ‰©ç¼©å®¹ç­–ç•¥

#### 3.1.1 åŸºäºŽCPUä½¿ç”¨çŽ‡

```yaml
# æ‰©ç¼©å®¹è§„åˆ™
metrics:
- type: Resource
  resource:
    name: cpu
    target:
      type: Utilization
      averageUtilization: 70
```

#### 3.1.2 åŸºäºŽè¿žæŽ¥æ•°

```sql
-- ç›‘æŽ§è¿žæŽ¥æ•°
SELECT
    count(*) as current_connections,
    (SELECT setting::INT FROM pg_settings WHERE name = 'max_connections') as max_connections
FROM pg_stat_activity
WHERE datname IS NOT NULL;

-- è§¦å‘æ‰©ç¼©å®¹
-- å½“è¿žæŽ¥æ•° > 80% max_connections æ—¶æ‰©å®¹
-- å½“è¿žæŽ¥æ•° < 20% max_connections æ—¶ç¼©å®¹
```

#### 3.1.3 åŸºäºŽæŸ¥è¯¢è´Ÿè½½

```sql
-- ç›‘æŽ§æŸ¥è¯¢è´Ÿè½½
SELECT
    count(*) as active_queries,
    avg(EXTRACT(EPOCH FROM (NOW() - query_start))) as avg_query_duration
FROM pg_stat_activity
WHERE state = 'active'
AND query_start IS NOT NULL;
```

### 3.2 Scale-to-Zeroæœºåˆ¶

#### 3.2.1 é›¶æµé‡æ£€æµ‹

```sql
-- æ£€æµ‹é›¶æµé‡
SELECT
    count(*) as active_connections,
    count(*) FILTER (WHERE state = 'active') as active_queries
FROM pg_stat_activity
WHERE datname = 'mydb';

-- å¦‚æžœ active_connections = 0 ä¸”æŒç»­5åˆ†é’Ÿï¼Œè§¦å‘Scale-to-Zero
```

#### 3.2.2 å†·å¯åŠ¨ä¼˜åŒ–

```yaml
# é¢„å¯åŠ¨é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-warmup
data:
  warmup.sql: |
    -- é¢„åŠ è½½å¸¸ç”¨æ•°æ®
    SELECT * FROM pg_stat_user_tables LIMIT 1;
    -- é¢„çƒ­è¿žæŽ¥æ± 
    SELECT 1;
```

---

## 4. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### 4.1 æˆæœ¬åˆ†æž

#### 4.1.1 æˆæœ¬æž„æˆ

```text
æ€»æˆæœ¬ = è®¡ç®—æˆæœ¬ + å­˜å‚¨æˆæœ¬ + ç½‘ç»œæˆæœ¬

è®¡ç®—æˆæœ¬ = CPUä½¿ç”¨æ—¶é—´ Ã— CPUå•ä»·
å­˜å‚¨æˆæœ¬ = å­˜å‚¨å¤§å° Ã— å­˜å‚¨å•ä»·
ç½‘ç»œæˆæœ¬ = æ•°æ®ä¼ è¾“é‡ Ã— ç½‘ç»œå•ä»·
```

#### 4.1.2 æˆæœ¬ç›‘æŽ§

```sql
-- ç›‘æŽ§èµ„æºä½¿ç”¨
SELECT
    datname,
    numbackends as connections,
    xact_commit + xact_rollback as transactions,
    blks_read + blks_hit as io_operations
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1', 'postgres');
```

### 4.2 ä¼˜åŒ–ç­–ç•¥

#### 4.2.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä¼˜åŒ–æ…¢æŸ¥è¯¢
EXPLAIN ANALYZE
SELECT * FROM large_table WHERE condition;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_large_table_condition ON large_table(condition);

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_summary AS
SELECT
    date_trunc('day', created_at) as date,
    count(*) as count
FROM large_table
GROUP BY date_trunc('day', created_at);
```

#### 4.2.2 è¿žæŽ¥ä¼˜åŒ–

```sql
-- ä½¿ç”¨è¿žæŽ¥æ± 
-- å‡å°‘è¿žæŽ¥æ•°ï¼Œé™ä½Žè®¡ç®—æˆæœ¬
-- PgBounceré…ç½®
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

#### 4.2.3 å­˜å‚¨ä¼˜åŒ–

```sql
-- æ•°æ®åŽ‹ç¼©
CREATE TABLE compressed_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) WITH (compression = 'pglz');

-- å†·çƒ­æ•°æ®åˆ†ç¦»
-- çƒ­æ•°æ®ï¼šSSDå­˜å‚¨
-- å†·æ•°æ®ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆS3ï¼‰
```

---

## 5. æœ€ä½³å®žè·µ

### 5.1 æž¶æž„è®¾è®¡

- âœ… **æ— çŠ¶æ€è®¾è®¡**: åº”ç”¨å±‚æ— çŠ¶æ€ï¼Œä¾¿äºŽæ‰©ç¼©å®¹
- âœ… **è¿žæŽ¥æ± **: ä½¿ç”¨è¿žæŽ¥æ± ç®¡ç†è¿žæŽ¥
- âœ… **ç¼“å­˜ç­–ç•¥**: ä½¿ç”¨Redisç­‰ç¼“å­˜å‡å°‘æ•°æ®åº“è´Ÿè½½
- âœ… **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡

### 5.2 æ€§èƒ½ä¼˜åŒ–

- âœ… **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œå‡å°‘è®¡ç®—æ—¶é—´
- âœ… **ç´¢å¼•ä¼˜åŒ–**: åˆ›å»ºåˆé€‚çš„ç´¢å¼•
- âœ… **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
- âœ… **é¢„åŠ è½½**: é¢„åŠ è½½å¸¸ç”¨æ•°æ®

### 5.3 æˆæœ¬æŽ§åˆ¶

- âœ… **ç›‘æŽ§æˆæœ¬**: å®žæ—¶ç›‘æŽ§èµ„æºä½¿ç”¨
- âœ… **è®¾ç½®é¢„ç®—**: è®¾ç½®æˆæœ¬é¢„ç®—å’Œå‘Šè­¦
- âœ… **ä¼˜åŒ–æŸ¥è¯¢**: å‡å°‘ä¸å¿…è¦çš„æŸ¥è¯¢
- âœ… **ä½¿ç”¨ç¼“å­˜**: å‡å°‘æ•°æ®åº“è®¿é—®

### 5.4 é«˜å¯ç”¨

- âœ… **è‡ªåŠ¨æ•…éšœæ¢å¤**: é…ç½®è‡ªåŠ¨æ•…éšœæ¢å¤
- âœ… **å¤šåŒºåŸŸéƒ¨ç½²**: å¤šåŒºåŸŸéƒ¨ç½²æé«˜å¯ç”¨æ€§
- âœ… **å¤‡ä»½ç­–ç•¥**: è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤
- âœ… **ç›‘æŽ§å‘Šè­¦**: å®žæ—¶ç›‘æŽ§å’Œå‘Šè­¦

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [Serverlessæž¶æž„è®¾è®¡](./Serverlessæž¶æž„è®¾è®¡.md) - æž¶æž„è®¾è®¡è¯¦ç»†æŒ‡å—
- [Serverlessè‡ªåŠ¨æ‰©ç¼©å®¹](./Serverlessè‡ªåŠ¨æ‰©ç¼©å®¹.md) - æ‰©ç¼©å®¹æœºåˆ¶
- [Serverlessæˆæœ¬ä¼˜åŒ–](./Serverlessæˆæœ¬ä¼˜åŒ–.md) - æˆæœ¬ä¼˜åŒ–è¯¦ç»†æŒ‡å—
- [æŠ€æœ¯åŽŸç†/Serverlessæž¶æž„åŽŸç†.md](../æŠ€æœ¯åŽŸç†/Serverlessæž¶æž„åŽŸç†.md) - æŠ€æœ¯åŽŸç†
- [æˆæœ¬åˆ†æž/Serverlessæˆæœ¬ä¼˜åŒ–æ·±åº¦åˆ†æž.md](../æˆæœ¬åˆ†æž/Serverlessæˆæœ¬ä¼˜åŒ–æ·±åº¦åˆ†æž.md) - æˆæœ¬åˆ†æž

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
