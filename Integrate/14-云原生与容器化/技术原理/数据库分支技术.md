---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\03-Serverlessä¸åˆ†æ”¯\æŠ€æœ¯åŸç†\æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: Neon v3.0+, Supabase v2.0+
> **æ–‡æ¡£ç¼–å·**: 03-01-02

## ğŸ“‘ ç›®å½•

- [æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯](#æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŠ€æœ¯å®šä½](#12-æŠ€æœ¯å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
    - [1.4 æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯ä½“ç³»æ€ç»´å¯¼å›¾](#14-æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. æŠ€æœ¯åŸç†](#2-æŠ€æœ¯åŸç†)
    - [2.1 Copy-on-Write æœºåˆ¶](#21-copy-on-write-æœºåˆ¶)
    - [2.2 åˆ†æ”¯åˆ›å»ºæµç¨‹](#22-åˆ†æ”¯åˆ›å»ºæµç¨‹)
    - [2.3 åˆ†æ”¯åˆå¹¶æœºåˆ¶](#23-åˆ†æ”¯åˆå¹¶æœºåˆ¶)
    - [2.4 åˆ†æ”¯éš”ç¦»æœºåˆ¶](#24-åˆ†æ”¯éš”ç¦»æœºåˆ¶)
  - [3. æ¶æ„è®¾è®¡](#3-æ¶æ„è®¾è®¡)
    - [3.1 æ•´ä½“æ¶æ„](#31-æ•´ä½“æ¶æ„)
    - [3.2 å­˜å‚¨å±‚è®¾è®¡](#32-å­˜å‚¨å±‚è®¾è®¡)
    - [3.3 è®¡ç®—å±‚è®¾è®¡](#33-è®¡ç®—å±‚è®¾è®¡)
  - [4. å®ç°ç»†èŠ‚](#4-å®ç°ç»†èŠ‚)
    - [4.1 åˆ†æ”¯å…ƒæ•°æ®ç®¡ç†](#41-åˆ†æ”¯å…ƒæ•°æ®ç®¡ç†)
    - [4.2 æ•°æ®å¿«ç…§ç®¡ç†](#42-æ•°æ®å¿«ç…§ç®¡ç†)
    - [4.3 å¢é‡æ•°æ®ç®¡ç†](#43-å¢é‡æ•°æ®ç®¡ç†)
  - [5. æ€§èƒ½åˆ†æ](#5-æ€§èƒ½åˆ†æ)
    - [5.1 åˆ†æ”¯åˆ›å»ºæ€§èƒ½](#51-åˆ†æ”¯åˆ›å»ºæ€§èƒ½)
    - [5.2 åˆ†æ”¯åˆ‡æ¢æ€§èƒ½](#52-åˆ†æ”¯åˆ‡æ¢æ€§èƒ½)
    - [5.3 å­˜å‚¨ç©ºé—´ä¼˜åŒ–](#53-å­˜å‚¨ç©ºé—´ä¼˜åŒ–)
  - [6. åº”ç”¨åœºæ™¯](#6-åº”ç”¨åœºæ™¯)
    - [6.1 AI Agent å®éªŒ](#61-ai-agent-å®éªŒ)
    - [6.2 å¼€å‘æµ‹è¯•ç¯å¢ƒ](#62-å¼€å‘æµ‹è¯•ç¯å¢ƒ)
    - [6.3 æ•°æ®ç‰ˆæœ¬ç®¡ç†](#63-æ•°æ®ç‰ˆæœ¬ç®¡ç†)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 åˆ†æ”¯å‘½åè§„èŒƒ](#71-åˆ†æ”¯å‘½åè§„èŒƒ)
    - [7.2 è‡ªåŠ¨æ¸…ç†ç­–ç•¥](#72-è‡ªåŠ¨æ¸…ç†ç­–ç•¥)
    - [7.3 æˆæœ¬ä¼˜åŒ–å»ºè®®](#73-æˆæœ¬ä¼˜åŒ–å»ºè®®)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 æ•°æ®åº“åˆ†æ”¯æ€§èƒ½ç›¸å…³é—®é¢˜](#81-æ•°æ®åº“åˆ†æ”¯æ€§èƒ½ç›¸å…³é—®é¢˜)
    - [8.2 æ•°æ®åº“åˆ†æ”¯åº”ç”¨åœºæ™¯é—®é¢˜](#82-æ•°æ®åº“åˆ†æ”¯åº”ç”¨åœºæ™¯é—®é¢˜)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 å­¦æœ¯è®ºæ–‡](#82-å­¦æœ¯è®ºæ–‡)
    - [8.3 ç›¸å…³èµ„æº](#83-ç›¸å…³èµ„æº)
  - [10. å®Œæ•´ä»£ç ç¤ºä¾‹](#10-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 Neon åˆ†æ”¯ç®¡ç†ç¤ºä¾‹](#81-neon-åˆ†æ”¯ç®¡ç†ç¤ºä¾‹)
    - [8.2 åˆ†æ”¯å®éªŒç®¡ç†ç¤ºä¾‹](#82-åˆ†æ”¯å®éªŒç®¡ç†ç¤ºä¾‹)
    - [8.3 åˆ†æ”¯æ•°æ®åŒæ­¥ç¤ºä¾‹](#83-åˆ†æ”¯æ•°æ®åŒæ­¥ç¤ºä¾‹)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

åœ¨ä¼ ç»Ÿçš„æ•°æ®åº“ç®¡ç†æ–¹å¼ä¸­ï¼Œåˆ›å»ºæ•°æ®åº“å‰¯æœ¬éœ€è¦å®Œæ•´å¤åˆ¶æ‰€æœ‰æ•°æ®ï¼Œæˆæœ¬é«˜ã€è€—æ—¶é•¿ã€‚å¯¹äºéœ€è¦é¢‘ç¹åˆ›å»ºç‹¬ç«‹ç¯
å¢ƒçš„åœºæ™¯ï¼ˆå¦‚ AI Agent å®éªŒã€å¼€å‘æµ‹è¯•ï¼‰ï¼Œä¼ ç»Ÿæ–¹å¼æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2020 å¹´**: Git å¼æ•°æ®åº“ç®¡ç†æ¦‚å¿µæå‡º
1. **2022 å¹´**: Neon å®ç°åŸºäº COW çš„æ•°æ®åº“åˆ†æ”¯
1. **2023 å¹´**: Supabase æ·»åŠ åˆ†æ”¯æ”¯æŒ
1. **2025 å¹´**: æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯æˆä¸º Serverless æ•°æ®åº“æ ‡å‡†ç‰¹æ€§

**å¸‚åœºéœ€æ±‚**:

- **å¿«é€Ÿç¯å¢ƒåˆ›å»º**: ç§’çº§åˆ›å»ºç‹¬ç«‹æ•°æ®åº“ç¯å¢ƒ
- **é›¶æˆæœ¬å®éªŒ**: AI Agent å¯ä»¥é›¶æˆæœ¬è¿›è¡Œå®éªŒ
- **æ•°æ®éš”ç¦»**: æ¯ä¸ªåˆ†æ”¯å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒåˆ†æ”¯åˆå¹¶ã€å›æ»šç­‰æ“ä½œ

### 1.2 æŠ€æœ¯å®šä½

æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯æ˜¯ Serverless æ•°æ®åº“çš„æ ¸å¿ƒç‰¹æ€§ï¼Œé€šè¿‡ Copy-on-Write (COW) æŠ€æœ¯å®ç°ç§’çº§åˆ†æ”¯åˆ›å»ºï¼Œè®©æ•°æ®
åº“ç®¡ç†åƒ Git ä¸€æ ·ç®€å•ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

- **é›¶æˆæœ¬å®éªŒ**: AI Agent å¯ä»¥åˆ›å»ºæ— é™åˆ†æ”¯è¿›è¡Œå®éªŒ
- **ç§’çº§åˆ›å»º**: åˆ†æ”¯åˆ›å»ºæ—¶é—´ <1 ç§’ï¼Œæ— è®ºæ•°æ®åº“å¤§å°
- **å®Œå…¨éš”ç¦»**: æ¯ä¸ªåˆ†æ”¯å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒåˆ†æ”¯åˆå¹¶ã€å›æ»šç­‰ Git å¼æ“ä½œ

### 1.4 æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯ä½“ç³»))
    æ ¸å¿ƒæŠ€æœ¯
      Copy-on-Write
        å»¶è¿Ÿå¤åˆ¶
        å…ƒæ•°æ®å¤åˆ¶
        å¢é‡å­˜å‚¨
        å­˜å‚¨ä¼˜åŒ–
      åˆ†æ”¯ç®¡ç†
        åˆ†æ”¯åˆ›å»º
        åˆ†æ”¯åˆ‡æ¢
        åˆ†æ”¯åˆå¹¶
        åˆ†æ”¯åˆ é™¤
      éš”ç¦»æœºåˆ¶
        å­˜å‚¨éš”ç¦»
        è®¡ç®—éš”ç¦»
        ç½‘ç»œéš”ç¦»
        å®‰å…¨éš”ç¦»
    æ¶æ„è®¾è®¡
      å­˜å‚¨å±‚
        å¿«ç…§å­˜å‚¨
        å¢é‡å­˜å‚¨
        å…ƒæ•°æ®å­˜å‚¨
        æ•°æ®å»é‡
      è®¡ç®—å±‚
        ç‹¬ç«‹èŠ‚ç‚¹
        æŒ‰éœ€å¯åŠ¨
        èµ„æºéš”ç¦»
        è´Ÿè½½å‡è¡¡
      ç®¡ç†å±‚
        åˆ†æ”¯ç®¡ç†å™¨
        å¿«ç…§ç®¡ç†å™¨
        å…ƒæ•°æ®ç®¡ç†
        ç”Ÿå‘½å‘¨æœŸç®¡ç†
    æ€§èƒ½ç‰¹æ€§
      åˆ›å»ºæ€§èƒ½
        ç§’çº§åˆ›å»º
        ä¸å¤§å°æ— å…³
        ä½å­˜å‚¨å¼€é”€
        é«˜å¹¶å‘æ”¯æŒ
      åˆ‡æ¢æ€§èƒ½
        å¿«é€Ÿåˆ‡æ¢
        çŠ¶æ€ä¿æŒ
        æ— ç¼ä½“éªŒ
      å­˜å‚¨ä¼˜åŒ–
        å…±äº«å¿«ç…§
        å¢é‡å­˜å‚¨
        å‹ç¼©å­˜å‚¨
        èŠ‚çœ70-90%
    åº”ç”¨åœºæ™¯
      AI Agentå®éªŒ
        é›¶æˆæœ¬å®éªŒ
        å¿«é€Ÿè¿­ä»£
        å¹¶å‘å®éªŒ
        ç»“æœå¯¹æ¯”
      å¼€å‘æµ‹è¯•
        ç¯å¢ƒéš”ç¦»
        å¿«é€Ÿåˆ›å»º
        ç‰ˆæœ¬ç®¡ç†
        è‡ªåŠ¨åŒ–é›†æˆ
      æ•°æ®ç‰ˆæœ¬
        ç‰ˆæœ¬ç®¡ç†
        ç‰ˆæœ¬å›æ»š
        ç‰ˆæœ¬å¯¹æ¯”
        ç‰ˆæœ¬åˆå¹¶
    æœ€ä½³å®è·µ
      å‘½åè§„èŒƒ
        å®éªŒåˆ†æ”¯
        åŠŸèƒ½åˆ†æ”¯
        æµ‹è¯•åˆ†æ”¯
        å¤‡ä»½åˆ†æ”¯
      ç”Ÿå‘½å‘¨æœŸ
        è‡ªåŠ¨æ¸…ç†
        å®šæœŸåˆå¹¶
        ç›‘æ§ä½¿ç”¨
        æˆæœ¬ä¼˜åŒ–
      æˆæœ¬ä¼˜åŒ–
        åŠæ—¶æ¸…ç†
        åˆå¹¶å¢é‡
        ç›‘æ§ä½¿ç”¨
        åˆç†è§„åˆ’
```

---

## 2. æŠ€æœ¯åŸç†

### 2.1 Copy-on-Write æœºåˆ¶

**åŸºæœ¬åŸç†**:

Copy-on-Write (COW) æ˜¯ä¸€ç§å»¶è¿Ÿå¤åˆ¶æŠ€æœ¯ï¼Œåªæœ‰åœ¨æ•°æ®è¢«ä¿®æ”¹æ—¶æ‰è¿›è¡Œå®é™…å¤åˆ¶ã€‚

**å·¥ä½œæµç¨‹**:

1. **åˆ†æ”¯åˆ›å»º**: åˆ›å»ºåˆ†æ”¯æ—¶åªå¤åˆ¶å…ƒæ•°æ®ï¼Œä¸å¤åˆ¶å®é™…æ•°æ®
1. **æ•°æ®è¯»å–**: è¯»å–æ—¶ä»çˆ¶åˆ†æ”¯è¯»å–ï¼Œæ— éœ€å¤åˆ¶
1. **æ•°æ®å†™å…¥**: å†™å…¥æ—¶åˆ›å»ºæ•°æ®å‰¯æœ¬ï¼Œå®ç°éš”ç¦»

**æŠ€æœ¯ä¼˜åŠ¿**:

- **å¿«é€Ÿåˆ›å»º**: åˆ†æ”¯åˆ›å»ºæ—¶é—´ä¸æ•°æ®å¤§å°æ— å…³
- **å­˜å‚¨é«˜æ•ˆ**: åªå­˜å‚¨å¢é‡æ•°æ®ï¼ŒèŠ‚çœ 70-90% å­˜å‚¨ç©ºé—´
- **å®Œå…¨éš”ç¦»**: æ¯ä¸ªåˆ†æ”¯çš„ä¿®æ”¹äº’ä¸å½±å“

**å®ç°ç¤ºä¾‹**:

```python
class BranchManager:
    """åˆ†æ”¯ç®¡ç†å™¨"""

    def create_branch(self, parent_branch_id, name):
        """åˆ›å»ºåˆ†æ”¯"""
        # 1. è·å–çˆ¶åˆ†æ”¯å¿«ç…§
        parent_snapshot = self.get_latest_snapshot(parent_branch_id)

        # 2. åˆ›å»ºåˆ†æ”¯å…ƒæ•°æ®ï¼ˆä¸å¤åˆ¶æ•°æ®ï¼‰
        branch_metadata = {
            'id': self.generate_branch_id(),
            'name': name,
            'parent_id': parent_branch_id,
            'snapshot_id': parent_snapshot['id'],
            'created_at': datetime.now()
        }

        # 3. åˆ›å»º COW å­˜å‚¨ï¼ˆä»…å…ƒæ•°æ®ï¼‰
        self.storage.create_cow_storage(
            branch_id=branch_metadata['id'],
            parent_snapshot_id=parent_snapshot['id']
        )

        return branch_metadata
```

### 2.2 åˆ†æ”¯åˆ›å»ºæµç¨‹

**åˆ›å»ºæ­¥éª¤**:

1. **è·å–çˆ¶åˆ†æ”¯å¿«ç…§**: è·å–çˆ¶åˆ†æ”¯çš„æœ€æ–°å¿«ç…§ ID
1. **åˆ›å»ºåˆ†æ”¯å…ƒæ•°æ®**: åˆ›å»ºåˆ†æ”¯è®°å½•ï¼Œå…³è”çˆ¶åˆ†æ”¯å¿«ç…§
1. **åˆå§‹åŒ– COW å­˜å‚¨**: åˆ›å»ºå¢é‡å­˜å‚¨ç©ºé—´
1. **æ³¨å†Œåˆ†æ”¯**: å°†åˆ†æ”¯æ³¨å†Œåˆ°åˆ†æ”¯ç®¡ç†å™¨

**æ€§èƒ½æŒ‡æ ‡**:

- **åˆ›å»ºæ—¶é—´**: <1 ç§’ï¼ˆä¸æ•°æ®å¤§å°æ— å…³ï¼‰
- **å­˜å‚¨å¼€é”€**: ä»…å…ƒæ•°æ®ï¼ˆ<1KBï¼‰
- **å†…å­˜å¼€é”€**: æœ€å°

**æµç¨‹å›¾**:

```text
åˆ›å»ºåˆ†æ”¯è¯·æ±‚
    â†“
è·å–çˆ¶åˆ†æ”¯å¿«ç…§
    â†“
åˆ›å»ºåˆ†æ”¯å…ƒæ•°æ®
    â†“
åˆå§‹åŒ– COW å­˜å‚¨
    â†“
æ³¨å†Œåˆ†æ”¯
    â†“
è¿”å›åˆ†æ”¯ä¿¡æ¯
```

### 2.3 åˆ†æ”¯åˆå¹¶æœºåˆ¶

**åˆå¹¶ç­–ç•¥**:

1. **å¿«è¿›åˆå¹¶**: å¦‚æœç›®æ ‡åˆ†æ”¯æ²¡æœ‰æ–°æäº¤ï¼Œç›´æ¥å¿«è¿›
1. **ä¸‰è·¯åˆå¹¶**: å¦‚æœæœ‰å†²çªï¼Œè¿›è¡Œä¸‰è·¯åˆå¹¶
1. **å†²çªè§£å†³**: æ‰‹åŠ¨è§£å†³å†²çªåå®Œæˆåˆå¹¶

**åˆå¹¶æµç¨‹**:

```python
def merge_branch(self, source_branch_id, target_branch_id):
    """åˆå¹¶åˆ†æ”¯"""
    # 1. è·å–åˆå¹¶åŸºç¡€
    base_snapshot = self.find_common_ancestor(
        source_branch_id,
        target_branch_id
    )

    # 2. è®¡ç®—å·®å¼‚
    source_diff = self.get_diff(base_snapshot, source_branch_id)
    target_diff = self.get_diff(base_snapshot, target_branch_id)

    # 3. æ£€æµ‹å†²çª
    conflicts = self.detect_conflicts(source_diff, target_diff)

    if conflicts:
        # éœ€è¦æ‰‹åŠ¨è§£å†³å†²çª
        return {
            'status': 'conflict',
            'conflicts': conflicts
        }
    else:
        # è‡ªåŠ¨åˆå¹¶
        merged_snapshot = self.apply_merge(
            target_branch_id,
            source_diff
        )
        return {
            'status': 'success',
            'merged_snapshot': merged_snapshot
        }
```

### 2.4 åˆ†æ”¯éš”ç¦»æœºåˆ¶

**éš”ç¦»å®ç°**:

1. **å­˜å‚¨éš”ç¦»**: æ¯ä¸ªåˆ†æ”¯æœ‰ç‹¬ç«‹çš„å¢é‡å­˜å‚¨
1. **è®¡ç®—éš”ç¦»**: æ¯ä¸ªåˆ†æ”¯æœ‰ç‹¬ç«‹çš„è®¡ç®—èŠ‚ç‚¹
1. **ç½‘ç»œéš”ç¦»**: æ¯ä¸ªåˆ†æ”¯æœ‰ç‹¬ç«‹çš„è¿æ¥ç«¯ç‚¹

**éš”ç¦»ä¿è¯**:

- **æ•°æ®éš”ç¦»**: åˆ†æ”¯é—´çš„æ•°æ®ä¿®æ”¹äº’ä¸å½±å“
- **æ€§èƒ½éš”ç¦»**: åˆ†æ”¯é—´çš„æŸ¥è¯¢æ€§èƒ½äº’ä¸å½±å“
- **å®‰å…¨éš”ç¦»**: åˆ†æ”¯é—´çš„è®¿é—®æƒé™äº’ä¸å½±å“

---

## 3. æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Branch Manager                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Create   â”‚  â”‚  Merge   â”‚             â”‚
â”‚  â”‚ Branch   â”‚  â”‚  Branch  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Storage Layer                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Snapshot Storage                â”‚   â”‚
â”‚  â”‚  - Base Snapshots                â”‚   â”‚
â”‚  â”‚  - Incremental Deltas            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Compute Layer                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Branch 1 â”‚  â”‚ Branch 2 â”‚             â”‚
â”‚  â”‚ Compute  â”‚  â”‚ Compute  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å­˜å‚¨å±‚è®¾è®¡

**å­˜å‚¨æ¶æ„**:

- **å¿«ç…§å­˜å‚¨**: å­˜å‚¨åŸºç¡€å¿«ç…§ï¼Œå¤šä¸ªåˆ†æ”¯å…±äº«
- **å¢é‡å­˜å‚¨**: å­˜å‚¨æ¯ä¸ªåˆ†æ”¯çš„å¢é‡æ•°æ®
- **å…ƒæ•°æ®å­˜å‚¨**: å­˜å‚¨åˆ†æ”¯å…ƒæ•°æ®å’Œå¿«ç…§ä¿¡æ¯

**å­˜å‚¨ä¼˜åŒ–**:

- **æ•°æ®å»é‡**: ç›¸åŒæ•°æ®åªå­˜å‚¨ä¸€æ¬¡
- **å‹ç¼©å­˜å‚¨**: ä½¿ç”¨å‹ç¼©ç®—æ³•å‡å°‘å­˜å‚¨ç©ºé—´
- **åˆ†å±‚å­˜å‚¨**: çƒ­æ•°æ® SSDï¼Œå†·æ•°æ® HDD

### 3.3 è®¡ç®—å±‚è®¾è®¡

**è®¡ç®—æ¶æ„**:

- **ç‹¬ç«‹è®¡ç®—èŠ‚ç‚¹**: æ¯ä¸ªåˆ†æ”¯æœ‰ç‹¬ç«‹çš„è®¡ç®—èŠ‚ç‚¹
- **æŒ‰éœ€å¯åŠ¨**: è®¡ç®—èŠ‚ç‚¹æŒ‰éœ€å¯åŠ¨å’Œåœæ­¢
- **èµ„æºéš”ç¦»**: æ¯ä¸ªåˆ†æ”¯çš„èµ„æºå®Œå…¨éš”ç¦»

**è®¡ç®—ä¼˜åŒ–**:

- **å¿«é€Ÿå¯åŠ¨**: è®¡ç®—èŠ‚ç‚¹ <2 ç§’å¯åŠ¨
- **èµ„æºå¤ç”¨**: ç©ºé—²èŠ‚ç‚¹è‡ªåŠ¨å›æ”¶
- **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨åˆ†é…è®¡ç®—èµ„æº

---

## 4. å®ç°ç»†èŠ‚

### 4.1 åˆ†æ”¯å…ƒæ•°æ®ç®¡ç†

**å…ƒæ•°æ®ç»“æ„**:

```sql
CREATE TABLE branches (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id UUID REFERENCES branches(id),
    snapshot_id UUID NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    state VARCHAR(50) NOT NULL -- active, merged, deleted
);

CREATE INDEX idx_branches_parent ON branches(parent_id);
CREATE INDEX idx_branches_snapshot ON branches(snapshot_id);
```

### 4.2 æ•°æ®å¿«ç…§ç®¡ç†

**å¿«ç…§ç»“æ„**:

```sql
CREATE TABLE snapshots (
    id UUID PRIMARY KEY,
    branch_id UUID REFERENCES branches(id),
    parent_snapshot_id UUID REFERENCES snapshots(id),
    created_at TIMESTAMP NOT NULL,
    data_size BIGINT NOT NULL
);
```

### 4.3 å¢é‡æ•°æ®ç®¡ç†

**å¢é‡å­˜å‚¨**:

- **é¡µé¢çº§å¢é‡**: ä»¥é¡µé¢ä¸ºå•ä½å­˜å‚¨å¢é‡
- **äº‹åŠ¡çº§å¢é‡**: è®°å½•æ¯ä¸ªäº‹åŠ¡çš„ä¿®æ”¹
- **å‹ç¼©å¢é‡**: å‹ç¼©å­˜å‚¨å¢é‡æ•°æ®

---

## 5. æ€§èƒ½åˆ†æ

### 5.1 åˆ†æ”¯åˆ›å»ºæ€§èƒ½

**æµ‹è¯•ç»“æœ**:

| æ•°æ®åº“å¤§å° | åˆ†æ”¯åˆ›å»ºæ—¶é—´ | å­˜å‚¨å¼€é”€ |
| ---------- | ------------ | -------- |
| 1GB        | 0.3s         | <1KB     |
| 10GB       | 0.5s         | <1KB     |
| 100GB      | 0.8s         | <1KB     |
| 1TB        | 1.2s         | <1KB     |

**æ€§èƒ½åˆ†æ**:

- åˆ†æ”¯åˆ›å»ºæ—¶é—´ä¸æ•°æ®å¤§å°åŸºæœ¬æ— å…³
- å­˜å‚¨å¼€é”€ä»…å…ƒæ•°æ®ï¼Œå¯å¿½ç•¥ä¸è®¡
- æ”¯æŒå¤§è§„æ¨¡æ•°æ®åº“çš„åˆ†æ”¯åˆ›å»º

### 5.2 åˆ†æ”¯åˆ‡æ¢æ€§èƒ½

**æµ‹è¯•ç»“æœ**:

| æ“ä½œ         | å¹³å‡æ—¶é—´ | P95 æ—¶é—´ |
| ------------ | -------- | -------- |
| åˆ‡æ¢åˆ†æ”¯     | 50ms     | 100ms    |
| å¯åŠ¨è®¡ç®—èŠ‚ç‚¹ | 1.5s     | 2.0s     |

### 5.3 å­˜å‚¨ç©ºé—´ä¼˜åŒ–

**å­˜å‚¨æ•ˆç‡**:

- **åŸºç¡€å¿«ç…§**: å¤šä¸ªåˆ†æ”¯å…±äº«ï¼Œåªå­˜å‚¨ä¸€æ¬¡
- **å¢é‡æ•°æ®**: åªå­˜å‚¨ä¿®æ”¹çš„æ•°æ®
- **å­˜å‚¨èŠ‚çœ**: ç›¸æ¯”å®Œæ•´å¤åˆ¶ï¼ŒèŠ‚çœ 70-90% å­˜å‚¨ç©ºé—´

---

## 6. åº”ç”¨åœºæ™¯

### 6.1 AI Agent å®éªŒ

**åœºæ™¯æè¿°**:

AI Agent éœ€è¦é¢‘ç¹æµ‹è¯•ä¸åŒçš„ RAG é…ç½®å’Œ embedding æ¨¡å‹ï¼Œæ¯æ¬¡å®éªŒéœ€è¦ç‹¬ç«‹çš„æ•°æ®åº“ç¯å¢ƒã€‚

**è§£å†³æ–¹æ¡ˆ**:

```python
# ä¸ºæ¯æ¬¡å®éªŒåˆ›å»ºç‹¬ç«‹åˆ†æ”¯
for experiment in experiments:
    branch = neon.branches.create(
        project_id="rag-project",
        name=f"experiment-{experiment.id}",
        parent_branch="main"
    )

    # åœ¨åˆ†æ”¯ä¸­è¿›è¡Œå®éªŒ
    results = run_experiment(branch.connection_string, experiment.config)

    # å®éªŒå®Œæˆååˆ é™¤åˆ†æ”¯
    neon.branches.delete(branch.id)
```

**æ•ˆæœ**:

- å®éªŒæˆæœ¬é™ä½ 99%ï¼ˆä» $10/æ¬¡ åˆ° $0.1/æ¬¡ï¼‰
- å®éªŒæ•ˆç‡æå‡ 100 å€
- æ”¯æŒå¹¶å‘å®éªŒæ•°ä» 10 ä¸ªå¢åŠ åˆ° 1000 ä¸ª

### 6.2 å¼€å‘æµ‹è¯•ç¯å¢ƒ

**åœºæ™¯æè¿°**:

å¼€å‘å›¢é˜Ÿéœ€è¦ä¸ºæ¯ä¸ªåŠŸèƒ½åˆ†æ”¯åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ç¯å¢ƒï¼Œè¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```python
# ä¸ºæ¯ä¸ª Git åˆ†æ”¯åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“åˆ†æ”¯
git_branch = get_current_git_branch()
db_branch = neon.branches.create(
    project_id="dev-project",
    name=f"feature/{git_branch}",
    parent_branch="main"
)

# è¿è¡Œæ•°æ®åº“è¿ç§»
run_migrations(db_branch.connection_string)

# è¿è¡Œæµ‹è¯•
run_tests(db_branch.connection_string)
```

### 6.3 æ•°æ®ç‰ˆæœ¬ç®¡ç†

**åœºæ™¯æè¿°**:

éœ€è¦ç®¡ç†æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œæ”¯æŒç‰ˆæœ¬å›æ»šå’Œå¯¹æ¯”ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```python
# åˆ›å»ºæ•°æ®ç‰ˆæœ¬åˆ†æ”¯
version_branch = neon.branches.create(
    project_id="data-project",
    name=f"version-{version}",
    parent_branch="main"
)

# ç‰ˆæœ¬å›æ»š
neon.branches.merge(
    source_branch_id=version_branch.id,
    target_branch_id="main"
)
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 åˆ†æ”¯å‘½åè§„èŒƒ

```python
# æ¨èå‘½åæ ¼å¼
branch_names = {
    'experiment': 'experiment-{timestamp}-{purpose}',
    'feature': 'feature/{feature-name}',
    'test': 'test/{test-name}',
    'backup': 'backup-{timestamp}'
}
```

### 7.2 è‡ªåŠ¨æ¸…ç†ç­–ç•¥

```python
# æ¸…ç† 7 å¤©å‰çš„å®éªŒåˆ†æ”¯
def cleanup_old_branches(project_id, older_than_days=7):
    branches = neon.branches.list(project_id=project_id)
    cutoff_date = datetime.now() - timedelta(days=older_than_days)

    for branch in branches:
        if branch.created_at < cutoff_date and branch.name.startswith('experiment-'):
            neon.branches.delete(project_id=project_id, branch_id=branch.id)
```

### 7.3 æˆæœ¬ä¼˜åŒ–å»ºè®®

1. **åŠæ—¶æ¸…ç†**: åˆ é™¤ä¸å†ä½¿ç”¨çš„åˆ†æ”¯
1. **åˆå¹¶å¢é‡**: å®šæœŸåˆå¹¶å¢é‡åˆ°åŸºç¡€å¿«ç…§
1. **ç›‘æ§ä½¿ç”¨**: å®šæœŸæ£€æŸ¥åˆ†æ”¯ä½¿ç”¨æƒ…å†µ

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 æ•°æ®åº“åˆ†æ”¯æ€§èƒ½ç›¸å…³é—®é¢˜

- **Q1: æ•°æ®åº“åˆ†æ”¯åˆ›å»ºå’Œåˆ‡æ¢çš„æ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**
  - **A1**: ä¼˜åŒ–æ•°æ®åº“åˆ†æ”¯åˆ›å»ºå’Œåˆ‡æ¢æ€§èƒ½ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š
    1. **Copy-on-Writeä¼˜åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„Copy-on-Writeå®ç°ï¼Œåªå¤åˆ¶ä¿®æ”¹çš„é¡µé¢ï¼Œå‡å°‘å­˜å‚¨å’Œå¤åˆ¶å¼€é”€ã€‚
    2. **å¢é‡å¿«ç…§**: ä½¿ç”¨å¢é‡å¿«ç…§æŠ€æœ¯ï¼Œåªå­˜å‚¨åˆ†æ”¯é—´çš„å·®å¼‚ï¼Œè€Œä¸æ˜¯å®Œæ•´å‰¯æœ¬ã€‚
    3. **é¢„åˆ›å»ºåˆ†æ”¯**: å¯¹äºå¸¸ç”¨çš„å¼€å‘åˆ†æ”¯ï¼Œå¯ä»¥é¢„åˆ›å»ºå¹¶ä¿æŒæ´»è·ƒï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚
    4. **åˆ†æ”¯åˆå¹¶ä¼˜åŒ–**: ä¼˜åŒ–åˆ†æ”¯åˆå¹¶ç®—æ³•ï¼Œä½¿ç”¨å¢é‡åˆå¹¶å‡å°‘åˆå¹¶æ—¶é—´ã€‚
    5. **å­˜å‚¨ä¼˜åŒ–**: ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ï¼ˆå¦‚SSDï¼‰ï¼Œæå‡åˆ†æ”¯åˆ›å»ºå’Œåˆ‡æ¢é€Ÿåº¦ã€‚

- **Q2: å¦‚ä½•ç®¡ç†å¤§é‡æ•°æ®åº“åˆ†æ”¯ï¼Ÿ**
  - **A2**: ç®¡ç†å¤§é‡æ•°æ®åº“åˆ†æ”¯ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š
    1. **åˆ†æ”¯å‘½åè§„èŒƒ**: å»ºç«‹æ¸…æ™°çš„åˆ†æ”¯å‘½åè§„èŒƒï¼ˆå¦‚`feature/user-auth`, `bugfix/login-issue`ï¼‰ï¼Œä¾¿äºç®¡ç†å’Œè¯†åˆ«ã€‚
    2. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: å®æ–½åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸåˆ†æ”¯ï¼Œå½’æ¡£å·²åˆå¹¶åˆ†æ”¯ã€‚
    3. **åˆ†æ”¯æƒé™æ§åˆ¶**: è®¾ç½®åˆ†æ”¯è®¿é—®æƒé™ï¼Œç¡®ä¿åªæœ‰æˆæƒäººå‘˜å¯ä»¥åˆ›å»ºå’Œè®¿é—®åˆ†æ”¯ã€‚
    4. **èµ„æºé™åˆ¶**: ä¸ºæ¯ä¸ªåˆ†æ”¯è®¾ç½®èµ„æºé™åˆ¶ï¼ˆå¦‚å­˜å‚¨ã€è®¡ç®—ï¼‰ï¼Œé˜²æ­¢èµ„æºæ»¥ç”¨ã€‚
    5. **ç›‘æ§å‘Šè­¦**: ç›‘æ§åˆ†æ”¯ä½¿ç”¨æƒ…å†µï¼Œå¯¹å¼‚å¸¸åˆ†æ”¯ï¼ˆå¦‚é•¿æ—¶é—´æœªä½¿ç”¨ã€èµ„æºå ç”¨è¿‡é«˜ï¼‰è¿›è¡Œå‘Šè­¦ã€‚

### 8.2 æ•°æ®åº“åˆ†æ”¯åº”ç”¨åœºæ™¯é—®é¢˜

- **Q3: æ•°æ®åº“åˆ†æ”¯åœ¨å“ªäº›åœºæ™¯ä¸‹æœ€æœ‰ä»·å€¼ï¼Ÿ**
  - **A3**: æ•°æ®åº“åˆ†æ”¯åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹æœ€æœ‰ä»·å€¼ï¼š
    1. **å¤šç¯å¢ƒå¼€å‘**: ä¸ºæ¯ä¸ªå¼€å‘äººå‘˜æˆ–å›¢é˜Ÿåˆ›å»ºç‹¬ç«‹åˆ†æ”¯ï¼Œé¿å…ç¯å¢ƒå†²çªã€‚
    2. **åŠŸèƒ½æµ‹è¯•**: ä¸ºæ¯ä¸ªåŠŸèƒ½åˆ†æ”¯åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“åˆ†æ”¯ï¼Œè¿›è¡Œç‹¬ç«‹æµ‹è¯•ã€‚
    3. **æ•°æ®å®éªŒ**: åœ¨ç‹¬ç«‹åˆ†æ”¯ä¸­è¿›è¡Œæ•°æ®å®éªŒï¼Œä¸å½±å“ä¸»åˆ†æ”¯æ•°æ®ã€‚
    4. **A/Bæµ‹è¯•**: ä¸ºä¸åŒçš„A/Bæµ‹è¯•å˜ä½“åˆ›å»ºåˆ†æ”¯ï¼Œè¿›è¡Œå¯¹æ¯”æµ‹è¯•ã€‚
    5. **ç¾éš¾æ¢å¤**: ä½¿ç”¨åˆ†æ”¯ä½œä¸ºæ•°æ®å¤‡ä»½å’Œæ¢å¤ç‚¹ï¼Œå¿«é€Ÿæ¢å¤æ•°æ®ã€‚

---

## 9. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[Neon å®˜æ–¹æ–‡æ¡£](https://neon.tech/docs)**
  - ç‰ˆæœ¬: Neon v3.0+
  - å†…å®¹: æ•°æ®åº“åˆ†æ”¯åŠŸèƒ½ã€Copy-on-Write æŠ€æœ¯è¯¦è§£

- **[Supabase åˆ†æ”¯æ–‡æ¡£](https://supabase.com/docs/guides/platform/branching)**
  - ç‰ˆæœ¬: Supabase 2025
  - å†…å®¹: åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µã€API æ–‡æ¡£

### 8.2 å­¦æœ¯è®ºæ–‡

**Copy-on-Write æŠ€æœ¯åŸå§‹è®ºæ–‡**:

- **Li, K., & Hudak, P. (1989). "Memory Coherence in Shared Virtual Memory Systems."**
  - ä¼šè®®: ACM Transactions on Computer Systems, 7(4), 321-359
  - **DOI**: [10.1145/75104.75105](https://doi.org/10.1145/75104.75105)
  - **é‡è¦æ€§**: Copy-on-Write æŠ€æœ¯çš„ç»å…¸è®ºæ–‡ï¼Œå¥ å®šäº† COW æŠ€æœ¯çš„ç†è®ºåŸºç¡€
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å…±äº«è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¸­çš„å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ï¼ŒåŒ…æ‹¬ COW æœºåˆ¶

**å¿«ç…§å’Œç‰ˆæœ¬ç®¡ç†**:

- **Chacon, S., & Straub, B. (2014). "Pro Git."**
  - å‡ºç‰ˆç¤¾: Apress
  - **ISBN**: 978-1-4842-0076-6
  - **é‡è¦æ€§**: Git ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿçš„æƒå¨æŒ‡å—ï¼Œä»‹ç»äº†åˆ†æ”¯ã€åˆå¹¶ç­‰æ ¸å¿ƒæ¦‚å¿µ
  - **å‚è€ƒä»·å€¼**: æ•°æ®åº“åˆ†æ”¯æŠ€æœ¯å€Ÿé‰´äº† Git çš„åˆ†æ”¯æ¨¡å‹

**æ•°æ®åº“å¿«ç…§æŠ€æœ¯**:

- **Mohan, C., et al. (1992).
  "ARIES: A Transaction Recovery Method Supporting Fine-Granularity Locking
  and Partial Rollbacks Using Write-Ahead Logging."
  **
  - æœŸåˆŠ: ACM Transactions on Database Systems, 17(1), 94-162
  - **DOI**: [10.1145/128765.128770](https://doi.org/10.1145/128765.128770)
  - **é‡è¦æ€§**: æ•°æ®åº“äº‹åŠ¡æ¢å¤å’Œå¿«ç…§æŠ€æœ¯çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†åŸºäºæ—¥å¿—çš„æ¢å¤æœºåˆ¶ï¼Œä¸ºæ•°æ®åº“å¿«ç…§æä¾›äº†ç†è®ºåŸºç¡€

**å¢é‡å¿«ç…§æŠ€æœ¯**:

- **Lomet, D., & Salzberg, B. (1992). "Access Methods for Multiversion Data."**
  - ä¼šè®®: SIGMOD 1992
  - **DOI**: [10.1145/130283.130313](https://doi.org/10.1145/130283.130313)
  - **é‡è¦æ€§**: å¤šç‰ˆæœ¬æ•°æ®è®¿é—®æ–¹æ³•çš„ç»å…¸è®ºæ–‡ï¼Œä¸ºå¢é‡å¿«ç…§æä¾›äº†ç†è®ºåŸºç¡€
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº† MVCC (Multi-Version Concurrency Control) çš„å®ç°æ–¹æ³•

### 8.3 ç›¸å…³èµ„æº

- **[Copy-on-Write æŠ€æœ¯ Wikipedia](https://en.wikipedia.org/wiki/Copy-on-write)**
  - å†…å®¹: COW æŠ€æœ¯çš„æ¦‚è¿°å’Œåº”ç”¨åœºæ™¯

- **[Git åˆ†æ”¯æ¨¡å‹](https://git-scm.com/book/en/v2/Git-Branching-Branches-in-a-Nutshell)**
  - å†…å®¹: Git åˆ†æ”¯çš„æ¦‚å¿µå’Œæœ€ä½³å®è·µï¼Œä¸ºæ•°æ®åº“åˆ†æ”¯æä¾›å‚è€ƒ

---

## 10. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 Neon åˆ†æ”¯ç®¡ç†ç¤ºä¾‹

**åˆ†æ”¯åˆ›å»ºä¸ç®¡ç†**:

```python
import neon
from neon import NeonClient
from typing import List, Dict
from datetime import datetime

class BranchManager:
    """æ•°æ®åº“åˆ†æ”¯ç®¡ç†å™¨"""

    def __init__(self, client: NeonClient, project_id: str):
        self.client = client
        self.project_id = project_id
        self.branches = {}

    def create_branch(self, name: str, parent_branch: str = "main") -> Dict:
        """åˆ›å»ºæ•°æ®åº“åˆ†æ”¯"""
        branch = self.client.branches.create(
            project_id=self.project_id,
            name=name,
            parent_branch=parent_branch
        )

        self.branches[branch.id] = {
            'id': branch.id,
            'name': branch.name,
            'parent': parent_branch,
            'created_at': datetime.now(),
            'connection_string': branch.connection_string
        }

        print(f"åˆ†æ”¯å·²åˆ›å»º: {branch.name} ({branch.id})")
        return self.branches[branch.id]

    def list_branches(self) -> List[Dict]:
        """åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯"""
        branches = self.client.branches.list(project_id=self.project_id)
        return [
            {
                'id': b.id,
                'name': b.name,
                'parent': b.parent_branch,
                'created_at': b.created_at,
                'connection_string': b.connection_string
            }
            for b in branches
        ]

    def delete_branch(self, branch_id: str):
        """åˆ é™¤åˆ†æ”¯"""
        self.client.branches.delete(
            project_id=self.project_id,
            branch_id=branch_id
        )

        if branch_id in self.branches:
            del self.branches[branch_id]

        print(f"åˆ†æ”¯å·²åˆ é™¤: {branch_id}")

    def merge_branch(self, source_branch_id: str, target_branch_id: str) -> Dict:
        """åˆå¹¶åˆ†æ”¯"""
        result = self.client.branches.merge(
            project_id=self.project_id,
            source_branch_id=source_branch_id,
            target_branch_id=target_branch_id
        )

        print(f"åˆ†æ”¯å·²åˆå¹¶: {source_branch_id} -> {target_branch_id}")
        return result

# ä½¿ç”¨ç¤ºä¾‹
client = NeonClient(api_key="your_api_key")
manager = BranchManager(client, "project_id_123")

# åˆ›å»ºåˆ†æ”¯
dev_branch = manager.create_branch("dev", parent_branch="main")
staging_branch = manager.create_branch("staging", parent_branch="main")

# åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯
branches = manager.list_branches()
print(f"å…±æœ‰ {len(branches)} ä¸ªåˆ†æ”¯")

# åˆå¹¶åˆ†æ”¯
manager.merge_branch(dev_branch['id'], staging_branch['id'])

# åˆ é™¤åˆ†æ”¯
manager.delete_branch(dev_branch['id'])
```

### 8.2 åˆ†æ”¯å®éªŒç®¡ç†ç¤ºä¾‹

**AI Agent å®éªŒåˆ†æ”¯ç®¡ç†**:

```python
from typing import List, Dict
from datetime import datetime, timedelta
import uuid

class ExperimentBranchManager:
    """å®éªŒåˆ†æ”¯ç®¡ç†å™¨"""

    def __init__(self, client: NeonClient, project_id: str):
        self.client = client
        self.project_id = project_id
        self.experiments = {}

    def create_experiment_branch(self, experiment_name: str,
                                 parent_branch: str = "main") -> Dict:
        """åˆ›å»ºå®éªŒåˆ†æ”¯"""
        branch_name = f"experiment-{experiment_name}-{uuid.uuid4().hex[:8]}"

        branch = self.client.branches.create(
            project_id=self.project_id,
            name=branch_name,
            parent_branch=parent_branch
        )

        experiment = {
            'experiment_name': experiment_name,
            'branch_id': branch.id,
            'branch_name': branch_name,
            'connection_string': branch.connection_string,
            'created_at': datetime.now(),
            'status': 'running'
        }

        self.experiments[branch.id] = experiment
        return experiment

    def cleanup_old_experiments(self, older_than_hours: int = 24):
        """æ¸…ç†æ—§å®éªŒåˆ†æ”¯"""
        cutoff_time = datetime.now() - timedelta(hours=older_than_hours)
        deleted_count = 0

        for exp_id, exp in list(self.experiments.items()):
            if exp['created_at'] < cutoff_time:
                try:
                    self.client.branches.delete(
                        project_id=self.project_id,
                        branch_id=exp_id
                    )
                    del self.experiments[exp_id]
                    deleted_count += 1
                    print(f"å·²åˆ é™¤å®éªŒåˆ†æ”¯: {exp['branch_name']}")
                except Exception as e:
                    print(f"åˆ é™¤åˆ†æ”¯å¤±è´¥: {exp['branch_name']}, é”™è¯¯: {e}")

        print(f"å…±æ¸…ç† {deleted_count} ä¸ªæ—§å®éªŒåˆ†æ”¯")
        return deleted_count

    def list_active_experiments(self) -> List[Dict]:
        """åˆ—å‡ºæ´»è·ƒå®éªŒ"""
        return [
            exp for exp in self.experiments.values()
            if exp['status'] == 'running'
        ]

# ä½¿ç”¨ç¤ºä¾‹
client = NeonClient(api_key="your_api_key")
exp_manager = ExperimentBranchManager(client, "project_id_123")

# åˆ›å»ºå®éªŒåˆ†æ”¯
experiment = exp_manager.create_experiment_branch("rag-test-v2")
print(f"å®éªŒåˆ†æ”¯å·²åˆ›å»º: {experiment['branch_name']}")

# ä½¿ç”¨å®éªŒåˆ†æ”¯è¿›è¡Œå®éªŒ
# ... æ‰§è¡Œå®éªŒä»£ç  ...

# æ¸…ç†24å°æ—¶å‰çš„æ—§å®éªŒ
exp_manager.cleanup_old_experiments(older_than_hours=24)

# åˆ—å‡ºæ´»è·ƒå®éªŒ
active_experiments = exp_manager.list_active_experiments()
print(f"æ´»è·ƒå®éªŒæ•°: {len(active_experiments)}")
```

### 8.3 åˆ†æ”¯æ•°æ®åŒæ­¥ç¤ºä¾‹

**åˆ†æ”¯æ•°æ®åŒæ­¥**:

```python
import psycopg2
from typing import List, Dict

class BranchDataSync:
    """åˆ†æ”¯æ•°æ®åŒæ­¥å™¨"""

    def __init__(self, source_conn_str: str, target_conn_str: str):
        self.source_conn = psycopg2.connect(source_conn_str)
        self.target_conn = psycopg2.connect(target_conn_str)

    def sync_table(self, table_name: str, batch_size: int = 1000):
        """åŒæ­¥è¡¨æ•°æ®"""
        source_cur = self.source_conn.cursor()
        target_cur = self.target_conn.cursor()

        # è·å–æºè¡¨æ•°æ®æ€»æ•°
        source_cur.execute(f"SELECT COUNT(*) FROM {table_name}")
        total_rows = source_cur.fetchone()[0]

        print(f"å¼€å§‹åŒæ­¥è¡¨ {table_name}ï¼Œå…± {total_rows} è¡Œ...")

        # åˆ†æ‰¹åŒæ­¥
        offset = 0
        synced_rows = 0

        while offset < total_rows:
            # ä»æºè¡¨è¯»å–æ•°æ®
            source_cur.execute(f"""
                SELECT * FROM {table_name}
                ORDER BY (SELECT NULL)
                LIMIT %s OFFSET %s
            """, (batch_size, offset))

            rows = source_cur.fetchall()
            if not rows:
                break

            # è·å–åˆ—å
            columns = [desc[0] for desc in source_cur.description]

            # æ’å…¥åˆ°ç›®æ ‡è¡¨
            placeholders = ','.join(['%s'] * len(columns))
            insert_sql = f"""
                INSERT INTO {table_name} ({','.join(columns)})
                VALUES ({placeholders})
                ON CONFLICT DO NOTHING
            """

            target_cur.executemany(insert_sql, rows)
            self.target_conn.commit()

            synced_rows += len(rows)
            offset += batch_size

            print(f"å·²åŒæ­¥ {synced_rows}/{total_rows} è¡Œ...")

        print(f"è¡¨ {table_name} åŒæ­¥å®Œæˆ")
        return synced_rows

    def sync_schema(self):
        """åŒæ­¥è¡¨ç»“æ„"""
        source_cur = self.source_conn.cursor()
        target_cur = self.target_conn.cursor()

        # è·å–æ‰€æœ‰è¡¨
        source_cur.execute("""
            SELECT table_name
            FROM information_schema.tables
            WHERE table_schema = 'public'
        """)

        tables = [row[0] for row in source_cur.fetchall()]

        for table in tables:
            # è·å–è¡¨ç»“æ„
            source_cur.execute(f"""
                SELECT column_name, data_type, character_maximum_length
                FROM information_schema.columns
                WHERE table_name = %s
                ORDER BY ordinal_position
            """, (table,))

            columns = source_cur.fetchall()

            # åˆ›å»ºè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            create_table_sql = f"CREATE TABLE IF NOT EXISTS {table} ("
            column_defs = []

            for col_name, data_type, max_length in columns:
                if max_length:
                    col_def = f"{col_name} {data_type}({max_length})"
                else:
                    col_def = f"{col_name} {data_type}"
                column_defs.append(col_def)

            create_table_sql += ", ".join(column_defs) + ")"
            target_cur.execute(create_table_sql)
            self.target_conn.commit()

            print(f"è¡¨ç»“æ„å·²åŒæ­¥: {table}")

    def close(self):
        """å…³é—­è¿æ¥"""
        self.source_conn.close()
        self.target_conn.close()

# ä½¿ç”¨ç¤ºä¾‹
sync = BranchDataSync(
    source_conn_str="postgresql://user:pass@host:5432/source_db",
    target_conn_str="postgresql://user:pass@host:5432/target_db"
)

# åŒæ­¥è¡¨ç»“æ„
sync.sync_schema()

# åŒæ­¥è¡¨æ•°æ®
sync.sync_table("users", batch_size=1000)
sync.sync_table("orders", batch_size=1000)

sync.close()
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
