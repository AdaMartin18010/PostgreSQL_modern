# PostgreSQLåˆè§„æ€§ç®¡ç†æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: é‡‘èã€åŒ»ç–—ã€æ”¿åºœç­‰åˆè§„æ€§è¦æ±‚é«˜çš„è¡Œä¸š
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((åˆè§„æ€§ç®¡ç†))
    GDPRåˆè§„
      æ•°æ®ä¸»ä½“æƒåˆ©
      æ•°æ®è®¿é—®æƒ
      æ•°æ®åˆ é™¤æƒ
      æ•°æ®å¯ç§»æ¤æƒ
      æ•°æ®å¤„ç†åˆæ³•æ€§
      æ•°æ®ä¿æŠ¤æªæ–½
      åŠ å¯†
      è®¿é—®æ§åˆ¶
      å®¡è®¡æ—¥å¿—
    HIPAAåˆè§„
      å—ä¿æŠ¤å¥åº·ä¿¡æ¯PHI
      PHIä¿æŠ¤
      è®¿é—®æ§åˆ¶
      å®¡è®¡è¦æ±‚
      åŠ å¯†è¦æ±‚
    SOC2åˆè§„
      è®¿é—®æ§åˆ¶
      å˜æ›´ç®¡ç†
      ç›‘æ§å’Œæ—¥å¿—
      å®‰å…¨æ§åˆ¶
    PCI DSSåˆè§„
      æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤
      ç½‘ç»œéš”ç¦»
      åŠ å¯†è¦æ±‚
      è®¿é—®æ§åˆ¶
    è¡Œä¸šç‰¹å®šåˆè§„
      é‡‘èè¡Œä¸š
      æ”¿åºœè¡Œä¸š
      åŒ»ç–—è¡Œä¸š
```

---

## ğŸ“Š åˆè§„æ€§æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦åˆè§„æ€§ç®¡ç†?] --> B{è¡Œä¸šç±»å‹?}
    B -->|æ¬§ç›Ÿ/é€šç”¨| C[GDPRåˆè§„]
    B -->|åŒ»ç–—| D[HIPAAåˆè§„]
    B -->|äº‘æœåŠ¡| E[SOC2åˆè§„]
    B -->|æ”¯ä»˜| F[PCI DSSåˆè§„]
    B -->|é‡‘è| G[é‡‘èè¡Œä¸šåˆè§„]
    B -->|æ”¿åºœ| H[æ”¿åºœè¡Œä¸šåˆè§„]

    C --> I[æ•°æ®ä¸»ä½“æƒåˆ©<br/>æ•°æ®ä¿æŠ¤æªæ–½]
    D --> J[PHIä¿æŠ¤<br/>è®¿é—®æ§åˆ¶]
    E --> K[è®¿é—®æ§åˆ¶<br/>ç›‘æ§æ—¥å¿—]
    F --> L[æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤<br/>ç½‘ç»œéš”ç¦»]
    G --> M[é‡‘èç›‘ç®¡è¦æ±‚]
    H --> N[æ”¿åºœå®‰å…¨è¦æ±‚]

    A --> O{éœ€è¦å¤šåˆè§„?}
    O -->|æ˜¯| P[ç»¼åˆåˆè§„æ–¹æ¡ˆ]
    O -->|å¦| Q[å•ä¸€åˆè§„æ–¹æ¡ˆ]
```

---

## ğŸ“Š åˆè§„æ€§æ ‡å‡†å¯¹æ¯”çŸ©é˜µ

| åˆè§„æ ‡å‡† | é€‚ç”¨èŒƒå›´ | æ ¸å¿ƒè¦æ±‚ | å®æ–½å¤æ‚åº¦ | å®¡è®¡è¦æ±‚ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- |
| **GDPR** | æ¬§ç›Ÿ/é€šç”¨ | æ•°æ®ä¸»ä½“æƒåˆ©ã€æ•°æ®ä¿æŠ¤ | â­â­â­ | é«˜ | âœ… æ”¯æŒ |
| **HIPAA** | åŒ»ç–—è¡Œä¸š | PHIä¿æŠ¤ã€è®¿é—®æ§åˆ¶ | â­â­â­â­ | é«˜ | âœ… æ”¯æŒ |
| **SOC2** | äº‘æœåŠ¡ | è®¿é—®æ§åˆ¶ã€ç›‘æ§æ—¥å¿— | â­â­â­ | ä¸­ | âœ… æ”¯æŒ |
| **PCI DSS** | æ”¯ä»˜è¡Œä¸š | æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤ | â­â­â­â­ | é«˜ | âœ… æ”¯æŒ |
| **é‡‘èç›‘ç®¡** | é‡‘èè¡Œä¸š | æ•°æ®ä¿æŠ¤ã€å®¡è®¡ | â­â­â­â­ | é«˜ | âœ… æ”¯æŒ |

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLåˆè§„æ€§ç®¡ç†æŒ‡å—](#postgresqlåˆè§„æ€§ç®¡ç†æŒ‡å—)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š åˆè§„æ€§æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘](#-åˆè§„æ€§æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š åˆè§„æ€§æ ‡å‡†å¯¹æ¯”çŸ©é˜µ](#-åˆè§„æ€§æ ‡å‡†å¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯åˆè§„æ€§ç®¡ç†ï¼Ÿ](#11-ä»€ä¹ˆæ˜¯åˆè§„æ€§ç®¡ç†)
    - [1.2 åˆè§„æ€§ç®¡ç†ç›®æ ‡](#12-åˆè§„æ€§ç®¡ç†ç›®æ ‡)
  - [2. GDPRåˆè§„](#2-gdpråˆè§„)
    - [2.1 GDPRæ ¸å¿ƒè¦æ±‚](#21-gdpræ ¸å¿ƒè¦æ±‚)
      - [2.1.1 æ•°æ®ä¸»ä½“æƒåˆ©](#211-æ•°æ®ä¸»ä½“æƒåˆ©)
      - [2.1.2 æ•°æ®å¤„ç†åˆæ³•æ€§](#212-æ•°æ®å¤„ç†åˆæ³•æ€§)
    - [2.2 æ•°æ®ä¿æŠ¤æªæ–½](#22-æ•°æ®ä¿æŠ¤æªæ–½)
      - [3.1.2 è®¿é—®æ§åˆ¶](#312-è®¿é—®æ§åˆ¶)
    - [3.2 å®¡è®¡è¦æ±‚](#32-å®¡è®¡è¦æ±‚)
  - [4. SOC2åˆè§„](#4-soc2åˆè§„)
    - [4.1 SOC2æ§åˆ¶è¦æ±‚](#41-soc2æ§åˆ¶è¦æ±‚)
      - [4.1.1 è®¿é—®æ§åˆ¶](#411-è®¿é—®æ§åˆ¶)
      - [4.1.2 å˜æ›´ç®¡ç†](#412-å˜æ›´ç®¡ç†)
    - [4.2 ç›‘æ§å’Œæ—¥å¿—](#42-ç›‘æ§å’Œæ—¥å¿—)
  - [5. PCI DSSåˆè§„](#5-pci-dssåˆè§„)
    - [5.1 æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤](#51-æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤)
    - [5.2 ç½‘ç»œéš”ç¦»](#52-ç½‘ç»œéš”ç¦»)
  - [6. è¡Œä¸šç‰¹å®šåˆè§„](#6-è¡Œä¸šç‰¹å®šåˆè§„)
    - [6.1 é‡‘èè¡Œä¸š](#61-é‡‘èè¡Œä¸š)
    - [6.2 æ”¿åºœè¡Œä¸š](#62-æ”¿åºœè¡Œä¸š)
  - [7. åˆè§„æ€§æ£€æŸ¥æ¸…å•](#7-åˆè§„æ€§æ£€æŸ¥æ¸…å•)
    - [7.1 GDPRæ£€æŸ¥æ¸…å•](#71-gdpræ£€æŸ¥æ¸…å•)
    - [7.2 HIPAAæ£€æŸ¥æ¸…å•](#72-hipaaæ£€æŸ¥æ¸…å•)
    - [7.3 SOC2æ£€æŸ¥æ¸…å•](#73-soc2æ£€æŸ¥æ¸…å•)
    - [7.4 PCI DSSæ£€æŸ¥æ¸…å•](#74-pci-dssæ£€æŸ¥æ¸…å•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯åˆè§„æ€§ç®¡ç†ï¼Ÿ

åˆè§„æ€§ç®¡ç†æ˜¯ç¡®ä¿æ•°æ®åº“ç³»ç»Ÿç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„ã€è¡Œä¸šæ ‡å‡†å’Œå†…éƒ¨æ”¿ç­–çš„è¿‡ç¨‹ã€‚

**ä¸»è¦åˆè§„æ ‡å‡†**:

- âœ… **GDPR**: æ¬§ç›Ÿé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹
- âœ… **HIPAA**: ç¾å›½å¥åº·ä¿é™©æµé€šä¸è´£ä»»æ³•æ¡ˆ
- âœ… **SOC2**: æœåŠ¡ç»„ç»‡æ§åˆ¶2
- âœ… **PCI DSS**: æ”¯ä»˜å¡è¡Œä¸šæ•°æ®å®‰å…¨æ ‡å‡†
- âœ… **è¡Œä¸šç‰¹å®š**: é‡‘èã€åŒ»ç–—ã€æ”¿åºœç­‰è¡Œä¸šæ ‡å‡†

### 1.2 åˆè§„æ€§ç®¡ç†ç›®æ ‡

- **æ•°æ®ä¿æŠ¤**: ä¿æŠ¤ä¸ªäººå’Œæ•æ„Ÿæ•°æ®
- **éšç§ä¿æŠ¤**: å°Šé‡ç”¨æˆ·éšç§æƒ
- **å®¡è®¡è¿½è¸ª**: å®Œæ•´çš„æ“ä½œå®¡è®¡
- **é£é™©æ§åˆ¶**: é™ä½åˆè§„é£é™©

---

## 2. GDPRåˆè§„

### 2.1 GDPRæ ¸å¿ƒè¦æ±‚

#### 2.1.1 æ•°æ®ä¸»ä½“æƒåˆ©

```sql
-- 1. æ•°æ®è®¿é—®æƒï¼ˆRight to Accessï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- è·å–ç”¨æˆ·æ•°æ®å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION get_user_data(p_user_id INT)
RETURNS TABLE (
    table_name TEXT,
    data JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_user_id IS NULL THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_user_id < 0 THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDæ— æ•ˆ: % (å¿…é¡»>=0)', p_user_id;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
        RAISE WARNING 'ordersè¡¨ä¸å­˜åœ¨ï¼Œå°†è·³è¿‡è®¢å•æ•°æ®';
    END IF;

    BEGIN
        RETURN QUERY
        -- è·å–ç”¨æˆ·æ•°æ®
        SELECT 'users'::TEXT, COALESCE(to_jsonb(u.*), '{}'::JSONB)
        FROM users u
        WHERE u.id = p_user_id
        UNION ALL
        -- è·å–è®¢å•æ•°æ®ï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
        SELECT 'orders'::TEXT, COALESCE(to_jsonb(o.*), '{}'::JSONB)
        FROM orders o
        WHERE o.user_id = p_user_id
          AND EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders');
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨usersæˆ–ordersä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END;
$$;

-- åˆ é™¤ç”¨æˆ·æ•°æ®å‡½æ•°ï¼ˆRight to Erasureï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION delete_user_data(p_user_id INT)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    v_deleted_orders_count INT := 0;
    v_deleted_users_count INT := 0;
    v_current_user TEXT;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_user_id IS NULL THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_user_id < 0 THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDæ— æ•ˆ: % (å¿…é¡»>=0)', p_user_id;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨';
    END IF;

    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM users WHERE id = p_user_id) THEN
        RAISE WARNING 'ç”¨æˆ·ID % ä¸å­˜åœ¨', p_user_id;
        RETURN;
    END IF;

    BEGIN
        -- è·å–å½“å‰ç”¨æˆ·
        BEGIN
            v_current_user := current_user;
        EXCEPTION
            WHEN OTHERS THEN
                v_current_user := 'system';
        END;

        -- åˆ é™¤è®¢å•æ•°æ®ï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            BEGIN
                DELETE FROM orders WHERE user_id = p_user_id;
                GET DIAGNOSTICS v_deleted_orders_count = ROW_COUNT;
            EXCEPTION
                WHEN foreign_key_violation THEN
                    RAISE WARNING 'åˆ é™¤è®¢å•æ—¶è¿åå¤–é”®çº¦æŸ';
                WHEN OTHERS THEN
                    RAISE WARNING 'åˆ é™¤è®¢å•æ•°æ®å¤±è´¥: %', SQLERRM;
            END;
        END IF;

        -- åˆ é™¤ç”¨æˆ·æ•°æ®
        BEGIN
            DELETE FROM users WHERE id = p_user_id;
            GET DIAGNOSTICS v_deleted_users_count = ROW_COUNT;

            IF v_deleted_users_count = 0 THEN
                RAISE WARNING 'ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼Œç”¨æˆ·IDå¯èƒ½ä¸å­˜åœ¨: %', p_user_id;
            END IF;
        EXCEPTION
            WHEN foreign_key_violation THEN
                RAISE EXCEPTION 'åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼šå­˜åœ¨å…³è”æ•°æ®ï¼Œè¯·å…ˆåˆ é™¤å…³è”æ•°æ®';
            WHEN OTHERS THEN
                RAISE EXCEPTION 'åˆ é™¤ç”¨æˆ·æ•°æ®å¤±è´¥: %', SQLERRM;
        END;

        RAISE NOTICE 'å·²åˆ é™¤ç”¨æˆ·æ•°æ®: è®¢å• % æ¡, ç”¨æˆ· % æ¡', v_deleted_orders_count, v_deleted_users_count;

        -- è®°å½•åˆ é™¤æ“ä½œï¼ˆå¦‚æœå­˜åœ¨å®¡è®¡æ—¥å¿—è¡¨ï¼‰
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            BEGIN
                INSERT INTO audit_log (username, operation, new_values, event_time)
                VALUES (
                    v_current_user,
                    'GDPR_DELETE',
                    jsonb_build_object(
                        'user_id', p_user_id,
                        'deleted_orders', v_deleted_orders_count,
                        'deleted_users', v_deleted_users_count
                    ),
                    NOW()
                );
            EXCEPTION
                WHEN unique_violation THEN
                    RAISE WARNING 'å®¡è®¡æ—¥å¿—è®°å½•å·²å­˜åœ¨';
                WHEN OTHERS THEN
                    RAISE WARNING 'è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥: %', SQLERRM;
            END;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨usersæˆ–ordersä¸å­˜åœ¨';
        WHEN foreign_key_violation THEN
            RAISE EXCEPTION 'å­˜åœ¨å¤–é”®çº¦æŸï¼Œæ— æ³•åˆ é™¤ç”¨æˆ·æ•°æ®';
        WHEN OTHERS THEN
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- 3. æ•°æ®å¯ç§»æ¤æƒï¼ˆRight to Data Portabilityï¼‰
CREATE OR REPLACE FUNCTION export_user_data(user_id INT)
RETURNS JSONB AS $$
DECLARE
    result JSONB;
BEGIN
    SELECT jsonb_build_object(
        'user', (SELECT to_jsonb(u.*) FROM users u WHERE u.id = user_id),
        'orders', (SELECT jsonb_agg(to_jsonb(o.*)) FROM orders o WHERE o.user_id = user_id)
    ) INTO result;

    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

#### 2.1.2 æ•°æ®å¤„ç†åˆæ³•æ€§

```sql
-- è®°å½•æ•°æ®å¤„ç†åˆæ³•æ€§åŸºç¡€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_processing_consent') THEN
            RAISE WARNING 'è¡¨ data_processing_consent å·²å­˜åœ¨';
        ELSE
            CREATE TABLE data_processing_consent (
                id SERIAL PRIMARY KEY,
                user_id INT NOT NULL,
                processing_purpose TEXT NOT NULL,
                legal_basis TEXT NOT NULL,  -- 'consent', 'contract', 'legal_obligation', etc.
                consent_given BOOLEAN DEFAULT false,
                consent_date TIMESTAMPTZ,
                withdrawal_date TIMESTAMPTZ
            );
            RAISE NOTICE 'è¡¨ data_processing_consent åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ data_processing_consent å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ data_processing_consent å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥æ•°æ®å¤„ç†åˆæ³•æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ£€æŸ¥å¤„ç†åŒæ„å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_processing_consent(
    p_user_id INT,
    p_purpose TEXT
)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
DECLARE
    v_consent BOOLEAN;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_user_id IS NULL THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_user_id < 0 THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDæ— æ•ˆ: % (å¿…é¡»>=0)', p_user_id;
    END IF;

    IF p_purpose IS NULL OR TRIM(p_purpose) = '' THEN
        RAISE EXCEPTION 'å¤„ç†ç›®çš„ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_processing_consent') THEN
        RAISE WARNING 'data_processing_consentè¡¨ä¸å­˜åœ¨ï¼Œé»˜è®¤è¿”å›false';
        RETURN false;
    END IF;

    BEGIN
        SELECT consent_given INTO v_consent
        FROM data_processing_consent
        WHERE user_id = p_user_id
          AND processing_purpose = p_purpose
          AND withdrawal_date IS NULL
          AND consent_given = true;

        RETURN COALESCE(v_consent, false);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å¤„ç†åŒæ„å¤±è´¥: %', SQLERRM;
            RETURN false;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'check_processing_consentæ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RETURN false;
END;
$$;
```

### 2.2 æ•°æ®ä¿æŠ¤æªæ–½

```sql
-- æ•°æ®åŠ å¯†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            CREATE EXTENSION pgcrypto;
            RAISE NOTICE 'pgcrypto æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pgcrypto æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pgcrypto æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pgcrypto æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ å¯†å­˜å‚¨ä¸ªäººæ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users å·²å­˜åœ¨';
        ELSE
            CREATE TABLE users (
                id SERIAL PRIMARY KEY,
                username TEXT,
                email_encrypted BYTEA,
                phone_encrypted BYTEA
            );
            RAISE NOTICE 'è¡¨ users åˆ›å»ºæˆåŠŸï¼ˆæ”¯æŒåŠ å¯†å­˜å‚¨ï¼‰';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ users å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ users å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ•°æ®è„±æ•ï¼ˆç”¨äºéç”Ÿäº§ç¯å¢ƒï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ©ç ä¸ªäººæ•°æ®å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
-- æ©ç ä¸ªäººæ•°æ®å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION mask_personal_data(p_data TEXT)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
    v_result TEXT;
    v_length INTEGER;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_data IS NULL THEN
        RETURN NULL;
    END IF;

    BEGIN
        v_length := LENGTH(p_data);

        IF v_length = 0 THEN
            RETURN '';
        END IF;

        -- æ•°æ®æ©ç ï¼šä¿ç•™ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå…¶ä½™æ›¿æ¢ä¸º***
        BEGIN
            v_result := regexp_replace(p_data, '(.)(.*)', '\1***', 'g');

            IF v_result IS NULL OR v_result = '' THEN
                RAISE WARNING 'æ©ç ç»“æœä¸ºç©ºï¼Œè¿”å›åŸå§‹æ•°æ®';
                RETURN p_data;
            END IF;

            RETURN v_result;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æ•°æ®æ©ç å¤±è´¥: %, è¿”å›åŸå§‹æ•°æ®', SQLERRM;
                RETURN p_data;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'mask_personal_dataæ‰§è¡Œå¤±è´¥: %, è¿”å›åŸå§‹æ•°æ®', SQLERRM;
            RETURN p_data;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RETURN p_data;  -- å³ä½¿å‡ºé”™ä¹Ÿè¿”å›åŸå§‹æ•°æ®
END;
$$;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®è„±æ•å¤±è´¥: %', SQLERRM;
            RETURN data;  -- å¤±è´¥æ—¶è¿”å›åŸæ•°æ®
    END;
END;
$$ LANGUAGE plpgsql;

---

## 3. HIPAAåˆè§„

### 3.1 HIPAAæ ¸å¿ƒè¦æ±‚

#### 3.1.1 å—ä¿æŠ¤å¥åº·ä¿¡æ¯ï¼ˆPHIï¼‰ä¿æŠ¤

```sql
-- åˆ›å»ºæ‚£è€…è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'patient_records') THEN
            RAISE WARNING 'è¡¨ patient_records å·²å­˜åœ¨';
        ELSE
            CREATE TABLE patient_records (
                id SERIAL PRIMARY KEY,
                patient_id TEXT NOT NULL,
                medical_record_number TEXT,
                diagnosis TEXT,
                treatment TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ patient_records åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ patient_records å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ patient_records å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¯ç”¨RLSï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'patient_records') THEN
            RAISE WARNING 'è¡¨ patient_records ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE patient_records ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'è¡¨ patient_records å·²å¯ç”¨è¡Œçº§å®‰å…¨';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ patient_records ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºæˆæƒçš„è®¿é—®æ§åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'patient_records') THEN
            RAISE WARNING 'è¡¨ patient_records ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'patient_records' AND policyname = 'hipaa_access') THEN
            DROP POLICY hipaa_access ON patient_records;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ hipaa_access';
        END IF;

        CREATE POLICY hipaa_access ON patient_records
            FOR ALL
            USING (
                current_user IN (
                    SELECT employee_id
                    FROM authorized_healthcare_providers
                    WHERE department = 'authorized'
                    AND access_level >= (
                        SELECT required_access_level
                        FROM access_requirements
                        WHERE record_type = 'patient_records'
                    )
                )
            );
        RAISE NOTICE 'HIPAAè®¿é—®ç­–ç•¥ hipaa_access åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç­–ç•¥';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºHIPAAè®¿é—®ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®¡è®¡æ‰€æœ‰PHIè®¿é—®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'patient_records') THEN
            RAISE WARNING 'è¡¨ patient_records ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'audit_trigger_func') THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_func ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'hipaa_audit_trigger') THEN
            DROP TRIGGER hipaa_audit_trigger ON patient_records;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨ hipaa_audit_trigger';
        END IF;

        CREATE TRIGGER hipaa_audit_trigger
        AFTER INSERT OR UPDATE OR DELETE ON patient_records
        FOR EACH ROW EXECUTE FUNCTION audit_trigger_func();
        RAISE NOTICE 'HIPAAå®¡è®¡è§¦å‘å™¨ hipaa_audit_trigger åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ patient_records ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_func ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºHIPAAå®¡è®¡è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### 3.1.2 è®¿é—®æ§åˆ¶

```sql
-- åˆ›å»ºæˆæƒåŒ»ç–—æä¾›è€…è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'authorized_healthcare_providers') THEN
            RAISE WARNING 'è¡¨ authorized_healthcare_providers å·²å­˜åœ¨';
        ELSE
            CREATE TABLE authorized_healthcare_providers (
                employee_id TEXT PRIMARY KEY,
                department TEXT,
                access_level INT,
                authorization_date DATE,
                expiration_date DATE
            );
            RAISE NOTICE 'è¡¨ authorized_healthcare_providers åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ authorized_healthcare_providers å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ authorized_healthcare_providers å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥è®¿é—®æˆæƒï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_hipaa_access(
    p_employee_id TEXT,
    p_record_type TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_authorized BOOLEAN;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_employee_id IS NULL OR p_record_type IS NULL THEN
            RAISE EXCEPTION 'å‚æ•°ä¸èƒ½ä¸ºNULL';
        END IF;

        SELECT EXISTS(
            SELECT 1
            FROM authorized_healthcare_providers
            WHERE employee_id = p_employee_id
            AND expiration_date > CURRENT_DATE
            AND access_level >= (
                SELECT required_access_level
                FROM access_requirements
            WHERE record_type = p_record_type
        )
    ) INTO v_authorized;

    RETURN v_authorized;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 å®¡è®¡è¦æ±‚

```sql
-- HIPAAè¦æ±‚å®Œæ•´çš„å®¡è®¡æ—¥å¿—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hipaa_audit_log') THEN
            RAISE WARNING 'è¡¨ hipaa_audit_log å·²å­˜åœ¨';
        ELSE
            CREATE TABLE hipaa_audit_log (
                id BIGSERIAL PRIMARY KEY,
                event_time TIMESTAMPTZ DEFAULT NOW(),
                user_id TEXT,
                patient_id TEXT,
                action TEXT,
                resource_type TEXT,
                resource_id TEXT,
                ip_address INET,
                success BOOLEAN
            );
            RAISE NOTICE 'è¡¨ hipaa_audit_log åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ hipaa_audit_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ hipaa_audit_log å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®°å½•æ‰€æœ‰PHIè®¿é—®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION log_hipaa_access(
    p_user_id TEXT,
    p_patient_id TEXT,
    p_action TEXT,
    p_resource_type TEXT,
    p_resource_id TEXT
)
RETURNS void AS $$
DECLARE
    v_ip_address INET;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_user_id IS NULL OR p_action IS NULL OR p_resource_type IS NULL THEN
            RAISE EXCEPTION 'å¿…éœ€å‚æ•°ä¸èƒ½ä¸ºNULL';
        END IF;

        -- è·å–å®¢æˆ·ç«¯IPåœ°å€ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        BEGIN
            SELECT inet_client_addr() INTO v_ip_address;
        EXCEPTION
            WHEN OTHERS THEN
                v_ip_address := NULL;
        END;

        INSERT INTO hipaa_audit_log (
            user_id,
            patient_id,
            action,
            resource_type,
            resource_id,
            ip_address,
            success
        )
        VALUES (
            p_user_id,
            p_patient_id,
            p_action,
            p_resource_type,
            p_resource_id,
            v_ip_address,
            true
        );

        RAISE NOTICE 'HIPAAè®¿é—®æ—¥å¿—å·²è®°å½•';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ hipaa_audit_log ä¸å­˜åœ¨';
        WHEN NOT_NULL_VIOLATION THEN
            RAISE EXCEPTION 'å¿…éœ€å­—æ®µä¸èƒ½ä¸ºNULL';
        WHEN OTHERS THEN
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
        patient_id,
        action,
        resource_type,
        resource_id,
        ip_address,
        success
    )
    VALUES (
        p_user_id,
        p_patient_id,
        p_action,
        p_resource_type,
        p_resource_id,
        inet_client_addr(),
        true
    );
END;
$$ LANGUAGE plpgsql;
```

---

## 4. SOC2åˆè§„

### 4.1 SOC2æ§åˆ¶è¦æ±‚

#### 4.1.1 è®¿é—®æ§åˆ¶

```sql
-- ç”¨æˆ·è®¿é—®ç®¡ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_access_management') THEN
            RAISE WARNING 'è¡¨ user_access_management å·²å­˜åœ¨';
        ELSE
            CREATE TABLE user_access_management (
                id SERIAL PRIMARY KEY,
                user_id TEXT NOT NULL,
                role TEXT NOT NULL,
                granted_date DATE,
                revoked_date DATE,
                granted_by TEXT,
                status TEXT DEFAULT 'active'
            );
            RAISE NOTICE 'è¡¨ user_access_management åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ user_access_management å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ user_access_management å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®šæœŸå®¡æŸ¥è®¿é—®æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION review_user_access()
RETURNS TABLE (
    user_id TEXT,
    role TEXT,
    last_review_date DATE,
    days_since_review INT
) AS $$
BEGIN
    BEGIN
        -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_access_management') THEN
            RAISE EXCEPTION 'è¡¨ user_access_management ä¸å­˜åœ¨';
        END IF;

        RETURN QUERY
        SELECT
            uam.user_id,
            uam.role,
            COALESCE(MAX(ar.review_date), uam.granted_date) as last_review_date,
            EXTRACT(DAY FROM (CURRENT_DATE - COALESCE(MAX(ar.review_date), uam.granted_date)))::INT as days_since_review
        FROM user_access_management uam
        LEFT JOIN access_reviews ar ON uam.user_id = ar.user_id AND uam.role = ar.role
        WHERE uam.status = 'active'
        GROUP BY uam.user_id, uam.role, uam.granted_date
        HAVING MAX(ar.review_date) IS NULL OR EXTRACT(DAY FROM (CURRENT_DATE - MAX(ar.review_date))) > 90
        ORDER BY days_since_review DESC;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ user_access_management æˆ– access_reviews ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
```

#### 4.1.2 å˜æ›´ç®¡ç†

```sql
-- å˜æ›´ç®¡ç†è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'change_management') THEN
            RAISE WARNING 'è¡¨ change_management å·²å­˜åœ¨';
        ELSE
            CREATE TABLE change_management (
                id SERIAL PRIMARY KEY,
                change_id TEXT UNIQUE,
                change_type TEXT,
                description TEXT,
                requested_by TEXT,
                approved_by TEXT,
                change_date TIMESTAMPTZ,
                status TEXT,
                rollback_plan TEXT
            );
            RAISE NOTICE 'è¡¨ change_management åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ change_management å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ change_management å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®°å½•æ‰€æœ‰æ•°æ®åº“å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION log_database_change(
    p_change_type TEXT,
    p_description TEXT
)
RETURNS TEXT AS $$
DECLARE
    v_change_id TEXT;
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF p_change_type IS NULL OR p_description IS NULL THEN
            RAISE EXCEPTION 'å‚æ•°ä¸èƒ½ä¸ºNULL';
        END IF;

        -- ç”Ÿæˆå˜æ›´ID
        v_change_id := gen_random_uuid()::TEXT;

        INSERT INTO change_management (
            change_id,
            change_type,
            description,
            requested_by,
            change_date,
            status
        )
        VALUES (
            v_change_id,
            p_change_type,
            p_description,
            current_user,
            NOW(),
            'pending'
        );

        RAISE NOTICE 'æ•°æ®åº“å˜æ›´å·²è®°å½•ï¼Œå˜æ›´ID: %', v_change_id;
        RETURN v_change_id;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ change_management ä¸å­˜åœ¨';
        WHEN unique_violation THEN
            RAISE EXCEPTION 'å˜æ›´IDå†²çªï¼Œè¯·é‡è¯•';
        WHEN NOT_NULL_VIOLATION THEN
            RAISE EXCEPTION 'å¿…éœ€å­—æ®µä¸èƒ½ä¸ºNULL';
        WHEN OTHERS THEN
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
        change_date,
        status
    )
    VALUES (
        gen_random_uuid()::TEXT,
        p_change_type,
        p_description,
        current_user,
        NOW(),
        'pending'
    );
END;
$$ LANGUAGE plpgsql;
```

### 4.2 ç›‘æ§å’Œæ—¥å¿—

```sql
-- SOC2è¦æ±‚å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    log_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING 'è¡¨ audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢ç›‘æ§æ—¥å¿—';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO log_count
        FROM audit_log
        WHERE event_time >= NOW() - INTERVAL '90 days';

        RAISE NOTICE 'æ‰¾åˆ° % æ¡å®¡è®¡æ—¥å¿—è®°å½•ï¼ˆæœ€è¿‘90å¤©ï¼‰', log_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ç›‘æ§æ—¥å¿—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    event_time,
    username,
    operation,
    table_name,
    ip_address
FROM audit_log
WHERE event_time >= NOW() - INTERVAL '90 days'
ORDER BY event_time DESC
LIMIT 1000;

-- å¼‚å¸¸æ´»åŠ¨æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    suspicious_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'audit_log') THEN
            RAISE WARNING 'è¡¨ audit_log ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹å¼‚å¸¸æ´»åŠ¨';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO suspicious_count
        FROM (
            SELECT username
            FROM audit_log
            WHERE event_time >= NOW() - INTERVAL '24 hours'
            GROUP BY username
            HAVING COUNT(*) > 100 OR COUNT(DISTINCT ip_address) > 5
        ) suspicious_users;

        IF suspicious_count > 0 THEN
            RAISE WARNING 'å‘ç° % ä¸ªå¯ç–‘ç”¨æˆ·æ´»åŠ¨', suspicious_count;
        ELSE
            RAISE NOTICE 'æœªå‘ç°å¼‚å¸¸æ´»åŠ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æµ‹å¼‚å¸¸æ´»åŠ¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    username,
    COUNT(*) as event_count,
    COUNT(DISTINCT ip_address) as unique_ips
FROM audit_log
WHERE event_time >= NOW() - INTERVAL '24 hours'
GROUP BY username
HAVING COUNT(*) > 100 OR COUNT(DISTINCT ip_address) > 5;
```

---

## 5. PCI DSSåˆè§„

### 5.1 æ”¯ä»˜å¡æ•°æ®ä¿æŠ¤

```sql
-- æ”¯ä»˜å¡æ•°æ®åŠ å¯†å­˜å‚¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'payment_cards') THEN
            RAISE WARNING 'è¡¨ payment_cards å·²å­˜åœ¨';
        ELSE
            CREATE TABLE payment_cards (
                id SERIAL PRIMARY KEY,
                card_number_encrypted BYTEA,
                cardholder_name TEXT,
                expiry_date TEXT,
                cvv_encrypted BYTEA,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ payment_cards åˆ›å»ºæˆåŠŸï¼ˆæ”¯æŒåŠ å¯†å­˜å‚¨ï¼‰';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ payment_cards å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ payment_cards å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ å¯†å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION encrypt_card_data(
    card_number TEXT,
    cvv TEXT,
    encryption_key TEXT
)
RETURNS TABLE (
    card_number_encrypted BYTEA,
    cvv_encrypted BYTEA
) AS $$
BEGIN
    BEGIN
        -- å‚æ•°éªŒè¯
        IF card_number IS NULL OR cvv IS NULL OR encryption_key IS NULL THEN
            RAISE EXCEPTION 'å‚æ•°ä¸èƒ½ä¸ºNULL';
        END IF;

        -- æ£€æŸ¥pgcryptoæ‰©å±•
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…';
        END IF;

        -- éªŒè¯å¡å·æ ¼å¼ï¼ˆç®€å•éªŒè¯ï¼‰
        IF LENGTH(card_number) < 13 OR LENGTH(card_number) > 19 THEN
            RAISE EXCEPTION 'å¡å·é•¿åº¦æ— æ•ˆ';
        END IF;

        -- éªŒè¯CVVæ ¼å¼
        IF LENGTH(cvv) < 3 OR LENGTH(cvv) > 4 THEN
            RAISE EXCEPTION 'CVVé•¿åº¦æ— æ•ˆ';
        END IF;

        RETURN QUERY
        SELECT
            pgp_sym_encrypt(card_number, encryption_key),
            pgp_sym_encrypt(cvv, encryption_key);
    EXCEPTION
        WHEN undefined_function THEN
            RAISE EXCEPTION 'pgcrypto æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨åŠ å¯†åŠŸèƒ½';
        WHEN OTHERS THEN
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;
END;
$$ LANGUAGE plpgsql;

-- è®¿é—®æ§åˆ¶
ALTER TABLE payment_cards ENABLE ROW LEVEL SECURITY;

CREATE POLICY pci_access ON payment_cards
    FOR SELECT
    USING (
        current_user IN (
            SELECT employee_id
            FROM authorized_payment_handlers
            WHERE department = 'payment_processing'
        )
    );
```

### 5.2 ç½‘ç»œéš”ç¦»

```sql
-- PCI DSSè¦æ±‚ç½‘ç»œéš”ç¦»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æˆ–Schemaéš”ç¦»æ”¯ä»˜æ•°æ®
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'payment_data') THEN
            CREATE SCHEMA payment_data;
            RAISE NOTICE 'Schema payment_data åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'Schema payment_data å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_schema THEN
            RAISE WARNING 'Schema payment_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºSchema payment_dataå¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'general_data') THEN
            CREATE SCHEMA general_data;
            RAISE NOTICE 'Schema general_data åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'Schema general_data å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_schema THEN
            RAISE WARNING 'Schema general_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºSchema general_dataå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é™åˆ¶è®¿é—®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'payment_data') THEN
            RAISE WARNING 'Schema payment_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        REVOKE ALL ON SCHEMA payment_data FROM PUBLIC;
        RAISE NOTICE 'å·²æ’¤é”€PUBLICå¯¹Schema payment_dataçš„æ‰€æœ‰æƒé™';
    EXCEPTION
        WHEN invalid_schema_name THEN
            RAISE WARNING 'Schema payment_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’¤é”€æƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'payment_processor_role') THEN
            RAISE WARNING 'è§’è‰² payment_processor_role ä¸å­˜åœ¨ï¼Œæ— æ³•æˆäºˆæƒé™';
            RETURN;
        END IF;

        GRANT USAGE ON SCHEMA payment_data TO payment_processor_role;
        RAISE NOTICE 'å·²æˆäºˆ payment_processor_role å¯¹Schema payment_dataçš„ä½¿ç”¨æƒé™';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰² payment_processor_role ä¸å­˜åœ¨';
        WHEN invalid_schema_name THEN
            RAISE WARNING 'Schema payment_data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æˆäºˆæƒé™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 6. è¡Œä¸šç‰¹å®šåˆè§„

### 6.1 é‡‘èè¡Œä¸š

```sql
-- é‡‘èæ•°æ®ä¿ç•™è¦æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'financial_transactions') THEN
            RAISE WARNING 'è¡¨ financial_transactions ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'financial_transactions' AND policyname = 'financial_data_retention') THEN
            DROP POLICY financial_data_retention ON financial_transactions;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ financial_data_retention';
        END IF;

        CREATE POLICY financial_data_retention ON financial_transactions
            FOR DELETE
            USING (transaction_date < NOW() - INTERVAL '7 years');
        RAISE NOTICE 'é‡‘èæ•°æ®ä¿ç•™ç­–ç•¥ financial_data_retention åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ financial_transactions ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºé‡‘èæ•°æ®ä¿ç•™ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äº¤æ˜“å®¡è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'financial_transactions') THEN
            RAISE WARNING 'è¡¨ financial_transactions ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'audit_trigger_func') THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_func ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'financial_audit_trigger') THEN
            DROP TRIGGER financial_audit_trigger ON financial_transactions;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨ financial_audit_trigger';
        END IF;

        CREATE TRIGGER financial_audit_trigger
        AFTER INSERT OR UPDATE OR DELETE ON financial_transactions
        FOR EACH ROW EXECUTE FUNCTION audit_trigger_func();
        RAISE NOTICE 'äº¤æ˜“å®¡è®¡è§¦å‘å™¨ financial_audit_trigger åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ financial_transactions ä¸å­˜åœ¨';
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° audit_trigger_func ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºäº¤æ˜“å®¡è®¡è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 6.2 æ”¿åºœè¡Œä¸š

```sql
-- æ•°æ®åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'classified_data') THEN
            RAISE WARNING 'è¡¨ classified_data å·²å­˜åœ¨';
        ELSE
            CREATE TABLE classified_data (
                id SERIAL PRIMARY KEY,
                classification_level TEXT,  -- 'public', 'internal', 'confidential', 'secret'
                data_content TEXT,
                access_control_list TEXT[]
            );
            RAISE NOTICE 'è¡¨ classified_data åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ classified_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ classified_data å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºåˆ†ç±»çš„è®¿é—®æ§åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'classified_data') THEN
            RAISE WARNING 'è¡¨ classified_data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        -- å¯ç”¨RLS
        ALTER TABLE classified_data ENABLE ROW LEVEL SECURITY;

        IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'classified_data' AND policyname = 'classified_access') THEN
            DROP POLICY classified_access ON classified_data;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥ classified_access';
        END IF;

        CREATE POLICY classified_access ON classified_data
            FOR ALL
            USING (
                classification_level = ANY(
                    SELECT security_clearance
                    FROM authorized_personnel
                    WHERE employee_id = current_user
                )
            );
        RAISE NOTICE 'åŸºäºåˆ†ç±»çš„è®¿é—®æ§åˆ¶ç­–ç•¥ classified_access åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ classified_data æˆ– authorized_personnel ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåŸºäºåˆ†ç±»çš„è®¿é—®æ§åˆ¶ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 7. åˆè§„æ€§æ£€æŸ¥æ¸…å•

### 7.1 GDPRæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®ä¸»ä½“æƒåˆ©å®ç°ï¼ˆè®¿é—®ã€åˆ é™¤ã€å¯ç§»æ¤ï¼‰
- [ ] æ•°æ®å¤„ç†åˆæ³•æ€§è®°å½•
- [ ] æ•°æ®ä¿æŠ¤æªæ–½ï¼ˆåŠ å¯†ã€è„±æ•ï¼‰
- [ ] æ•°æ®æ³„éœ²é€šçŸ¥æœºåˆ¶
- [ ] æ•°æ®å¤„ç†åè®®ï¼ˆDPAï¼‰

### 7.2 HIPAAæ£€æŸ¥æ¸…å•

- [ ] PHIè®¿é—®æ§åˆ¶
- [ ] æˆæƒåŒ»ç–—æä¾›è€…ç®¡ç†
- [ ] å®Œæ•´å®¡è®¡æ—¥å¿—
- [ ] æ•°æ®åŠ å¯†
- [ ] ä¸šåŠ¡ä¼™ä¼´åè®®ï¼ˆBAAï¼‰

### 7.3 SOC2æ£€æŸ¥æ¸…å•

- [ ] è®¿é—®æ§åˆ¶ç®¡ç†
- [ ] å˜æ›´ç®¡ç†æµç¨‹
- [ ] ç›‘æ§å’Œæ—¥å¿—
- [ ] å®‰å…¨äº‹ä»¶å“åº”
- [ ] å®šæœŸåˆè§„å®¡è®¡

### 7.4 PCI DSSæ£€æŸ¥æ¸…å•

- [ ] æ”¯ä»˜å¡æ•°æ®åŠ å¯†
- [ ] ç½‘ç»œéš”ç¦»
- [ ] è®¿é—®æ§åˆ¶
- [ ] å®‰å…¨ç›‘æ§
- [ ] æ¼æ´ç®¡ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¼ä¸šçº§å®‰å…¨æ·±åŒ–](./ä¼ä¸šçº§å®‰å…¨æ·±åŒ–.md) - ä¼ä¸šçº§å®‰å…¨æ·±åŒ–
- [æ•°æ®ä¸»æƒç®¡ç†](./æ•°æ®ä¸»æƒç®¡ç†.md) - æ•°æ®ä¸»æƒç®¡ç†
- [05-å®‰å…¨ä¸åˆè§„](../05-å®‰å…¨ä¸åˆè§„/README.md) - å®‰å…¨ä¸åˆè§„ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
