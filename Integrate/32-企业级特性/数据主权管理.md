# PostgreSQLæ•°æ®ä¸»æƒç®¡ç†æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: å¤šåŒºåŸŸéƒ¨ç½²ã€æ•°æ®æœ¬åœ°åŒ–è¦æ±‚
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®ä¸»æƒç®¡ç†))
    æ•°æ®ä¸»æƒåŸåˆ™
      æ•°æ®æœ¬åœ°åŒ–
      åŒºåŸŸåŒ–éƒ¨ç½²
      å¤šåŒºåŸŸæ¶æ„
      æ•°æ®è·¯ç”±
      æ•°æ®åˆ†ç±»
      æ•°æ®ç®¡è¾–æƒ
    æ•°æ®æœ¬åœ°åŒ–
      åŒºåŸŸåŒ–éƒ¨ç½²
      å¤šåŒºåŸŸæ•°æ®åº“æ¶æ„
      æ•°æ®è·¯ç”±
      æ•°æ®å¤åˆ¶é™åˆ¶
    è·¨å¢ƒæ•°æ®ä¼ è¾“
      ä¼ è¾“æ§åˆ¶
      ä¼ è¾“å®¡æ‰¹æµç¨‹
      ä¼ è¾“åŠ å¯†
      ä¼ è¾“ç›‘æ§
    æ•°æ®ä¸»æƒæœ€ä½³å®è·µ
      æ¶æ„è®¾è®¡
      åˆè§„æ€§ç®¡ç†
      ç›‘æ§å’Œå‘Šè­¦
```

---

## ğŸ“Š æ•°æ®ä¸»æƒæ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦æ•°æ®ä¸»æƒç®¡ç†?] --> B{æ•°æ®æœ¬åœ°åŒ–è¦æ±‚?}
    B -->|ä¸¥æ ¼æœ¬åœ°åŒ–| C[åŒºåŸŸåŒ–éƒ¨ç½² + ç¦æ­¢è·¨å¢ƒä¼ è¾“]
    B -->|å…è®¸è·¨å¢ƒä¼ è¾“| D[åŒºåŸŸåŒ–éƒ¨ç½² + ä¼ è¾“æ§åˆ¶]
    B -->|æ— ç‰¹æ®Šè¦æ±‚| E[æ ‡å‡†éƒ¨ç½²]

    C --> F[ä¼˜åŠ¿: å®Œå…¨åˆè§„<br/>é€‚ç”¨: ä¸¥æ ¼ç›‘ç®¡]
    D --> G[ä¼˜åŠ¿: çµæ´»å¯æ§<br/>é€‚ç”¨: ä¸€èˆ¬ç›‘ç®¡]
    E --> H[ä¼˜åŠ¿: ç®€å•é«˜æ•ˆ<br/>é€‚ç”¨: æ— ç›‘ç®¡è¦æ±‚]

    A --> I{å¤šåŒºåŸŸéƒ¨ç½²?}
    I -->|æ˜¯| J[å¤šåŒºåŸŸæ¶æ„ + æ•°æ®è·¯ç”±]
    I -->|å¦| K[å•åŒºåŸŸéƒ¨ç½²]
```

---

## ğŸ“Š æ•°æ®ä¸»æƒæ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ•°æ®ä¸»æƒæ–¹æ¡ˆ | æœ¬åœ°åŒ–çº§åˆ« | è·¨å¢ƒä¼ è¾“ | å®æ–½å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- |
| **ä¸¥æ ¼æœ¬åœ°åŒ–** | â­â­â­â­â­ | ç¦æ­¢ | â­â­â­â­ | é«˜ | ä¸¥æ ¼ç›‘ç®¡åœ°åŒº |
| **åŒºåŸŸåŒ–éƒ¨ç½²** | â­â­â­â­ | å—æ§ | â­â­â­ | ä¸­-é«˜ | ä¸€èˆ¬ç›‘ç®¡è¦æ±‚ |
| **æ ‡å‡†éƒ¨ç½²** | â­â­ | å…è®¸ | â­â­ | ä½ | æ— ç‰¹æ®Šè¦æ±‚ |
| **æ··åˆæ¨¡å¼** | â­â­â­â­ | éƒ¨åˆ†å…è®¸ | â­â­â­â­ | ä¸­-é«˜ | å¤æ‚åˆè§„éœ€æ±‚ |

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ•°æ®ä¸»æƒç®¡ç†æŒ‡å—](#postgresqlæ•°æ®ä¸»æƒç®¡ç†æŒ‡å—)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š æ•°æ®ä¸»æƒæ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘](#-æ•°æ®ä¸»æƒæ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š æ•°æ®ä¸»æƒæ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#-æ•°æ®ä¸»æƒæ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸»æƒï¼Ÿ](#11-ä»€ä¹ˆæ˜¯æ•°æ®ä¸»æƒ)
    - [1.2 æ•°æ®ä¸»æƒçš„é‡è¦æ€§](#12-æ•°æ®ä¸»æƒçš„é‡è¦æ€§)
  - [2. æ•°æ®ä¸»æƒæ¦‚å¿µ](#2-æ•°æ®ä¸»æƒæ¦‚å¿µ)
    - [2.1 æ•°æ®ä¸»æƒåŸåˆ™](#21-æ•°æ®ä¸»æƒåŸåˆ™)
      - [2.1.1 æ•°æ®æœ¬åœ°åŒ–](#211-æ•°æ®æœ¬åœ°åŒ–)
      - [2.1.2 æ•°æ®åˆ†ç±»](#212-æ•°æ®åˆ†ç±»)
    - [2.2 æ•°æ®ç®¡è¾–æƒ](#22-æ•°æ®ç®¡è¾–æƒ)
  - [3. æ•°æ®æœ¬åœ°åŒ–](#3-æ•°æ®æœ¬åœ°åŒ–)
    - [3.1 åŒºåŸŸåŒ–éƒ¨ç½²](#31-åŒºåŸŸåŒ–éƒ¨ç½²)
      - [3.1.1 å¤šåŒºåŸŸæ•°æ®åº“æ¶æ„](#311-å¤šåŒºåŸŸæ•°æ®åº“æ¶æ„)
      - [3.1.2 æ•°æ®è·¯ç”±](#312-æ•°æ®è·¯ç”±)
    - [3.2 æ•°æ®å¤åˆ¶é™åˆ¶](#32-æ•°æ®å¤åˆ¶é™åˆ¶)
  - [4. è·¨å¢ƒæ•°æ®ä¼ è¾“](#4-è·¨å¢ƒæ•°æ®ä¼ è¾“)
    - [4.1 ä¼ è¾“æ§åˆ¶](#41-ä¼ è¾“æ§åˆ¶)
      - [4.1.1 ä¼ è¾“å®¡æ‰¹æµç¨‹](#411-ä¼ è¾“å®¡æ‰¹æµç¨‹)
      - [4.1.2 ä¼ è¾“åŠ å¯†](#412-ä¼ è¾“åŠ å¯†)
    - [4.2 ä¼ è¾“ç›‘æ§](#42-ä¼ è¾“ç›‘æ§)
  - [5. æ•°æ®ä¸»æƒæœ€ä½³å®è·µ](#5-æ•°æ®ä¸»æƒæœ€ä½³å®è·µ)
    - [5.1 æ¶æ„è®¾è®¡](#51-æ¶æ„è®¾è®¡)
    - [5.2 åˆè§„æ€§ç®¡ç†](#52-åˆè§„æ€§ç®¡ç†)
    - [5.3 ç›‘æ§å’Œå‘Šè­¦](#53-ç›‘æ§å’Œå‘Šè­¦)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸»æƒï¼Ÿ

æ•°æ®ä¸»æƒæ˜¯æŒ‡å›½å®¶æˆ–åœ°åŒºå¯¹å…¶å¢ƒå†…æ•°æ®æ‹¥æœ‰æ§åˆ¶æƒå’Œç®¡è¾–æƒçš„æ¦‚å¿µã€‚

**æ•°æ®ä¸»æƒè¦æ±‚**:

- âœ… **æ•°æ®æœ¬åœ°åŒ–**: æ•°æ®å¿…é¡»å­˜å‚¨åœ¨ç‰¹å®šåœ°åŒº
- âœ… **è·¨å¢ƒä¼ è¾“é™åˆ¶**: é™åˆ¶æˆ–ç¦æ­¢æ•°æ®è·¨å¢ƒä¼ è¾“
- âœ… **æ•°æ®è®¿é—®æ§åˆ¶**: æ§åˆ¶è°å¯ä»¥è®¿é—®æ•°æ®
- âœ… **æ•°æ®ç®¡è¾–æƒ**: æ•°æ®å—å½“åœ°æ³•å¾‹ç®¡è¾–

### 1.2 æ•°æ®ä¸»æƒçš„é‡è¦æ€§

- **æ³•å¾‹åˆè§„**: éµå®ˆæ•°æ®ä¿æŠ¤æ³•è§„
- **å›½å®¶å®‰å…¨**: ä¿æŠ¤å›½å®¶é‡è¦æ•°æ®
- **éšç§ä¿æŠ¤**: ä¿æŠ¤ä¸ªäººéšç§
- **å•†ä¸šé£é™©**: é™ä½æ•°æ®æ³„éœ²é£é™©

---

## 2. æ•°æ®ä¸»æƒæ¦‚å¿µ

### 2.1 æ•°æ®ä¸»æƒåŸåˆ™

#### 2.1.1 æ•°æ®æœ¬åœ°åŒ–

```sql
-- æŒ‰åœ°åŒºåˆ›å»ºè¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'eu_tablespace') THEN
            CREATE TABLESPACE eu_tablespace LOCATION '/data/eu';
            RAISE NOTICE 'è¡¨ç©ºé—´ eu_tablespace åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ eu_tablespace å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ eu_tablespace å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´ eu_tablespace å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'us_tablespace') THEN
            CREATE TABLESPACE us_tablespace LOCATION '/data/us';
            RAISE NOTICE 'è¡¨ç©ºé—´ us_tablespace åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ us_tablespace å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ us_tablespace å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´ us_tablespace å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'asia_tablespace') THEN
            CREATE TABLESPACE asia_tablespace LOCATION '/data/asia';
            RAISE NOTICE 'è¡¨ç©ºé—´ asia_tablespace åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ asia_tablespace å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ asia_tablespace å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´ asia_tablespace å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŒ‰åœ°åŒºå­˜å‚¨æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'eu_tablespace') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ eu_tablespace ä¸å­˜åœ¨';
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'eu_users') THEN
            RAISE WARNING 'è¡¨ eu_users å·²å­˜åœ¨';
        ELSE
            CREATE TABLE eu_users (
                id SERIAL PRIMARY KEY,
                username TEXT,
                email TEXT,
                region TEXT DEFAULT 'EU'
            ) TABLESPACE eu_tablespace;
            RAISE NOTICE 'è¡¨ eu_users åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ eu_users å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ eu_tablespace ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ eu_users å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'us_tablespace') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ us_tablespace ä¸å­˜åœ¨';
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'us_users') THEN
            RAISE WARNING 'è¡¨ us_users å·²å­˜åœ¨';
        ELSE
            CREATE TABLE us_users (
                id SERIAL PRIMARY KEY,
                username TEXT,
                email TEXT,
                region TEXT DEFAULT 'US'
            ) TABLESPACE us_tablespace;
            RAISE NOTICE 'è¡¨ us_users åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ us_users å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ us_tablespace ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ us_users å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### 2.1.2 æ•°æ®åˆ†ç±»

```sql
-- æ•°æ®åˆ†ç±»è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_classification') THEN
            RAISE WARNING 'è¡¨ data_classification å·²å­˜åœ¨';
        ELSE
            CREATE TABLE data_classification (
                id SERIAL PRIMARY KEY,
                table_name TEXT NOT NULL,
                data_type TEXT,  -- 'personal', 'sensitive', 'public'
                region_requirement TEXT,  -- 'EU', 'US', 'ASIA', 'LOCAL'
                cross_border_allowed BOOLEAN DEFAULT false,
                encryption_required BOOLEAN DEFAULT true
            );
            RAISE NOTICE 'è¡¨ data_classification åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ data_classification å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ data_classification å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ’å…¥æ•°æ®åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_classification') THEN
            RAISE WARNING 'è¡¨ data_classification ä¸å­˜åœ¨';
            RETURN;
        END IF;

        INSERT INTO data_classification (table_name, data_type, region_requirement, cross_border_allowed, encryption_required)
        VALUES
            ('eu_users', 'personal', 'EU', false, true),
            ('us_users', 'personal', 'US', false, true),
            ('public_content', 'public', 'GLOBAL', true, false)
        ON CONFLICT DO NOTHING;
        RAISE NOTICE 'æ•°æ®åˆ†ç±»å·²æ’å…¥';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ data_classification ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æ•°æ®åˆ†ç±»å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 æ•°æ®ç®¡è¾–æƒ

```sql
-- æ•°æ®ç®¡è¾–æƒè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_jurisdiction') THEN
            RAISE WARNING 'è¡¨ data_jurisdiction å·²å­˜åœ¨';
        ELSE
            CREATE TABLE data_jurisdiction (
                id SERIAL PRIMARY KEY,
                data_region TEXT NOT NULL,
                jurisdiction_country TEXT NOT NULL,
                applicable_laws TEXT[],
                data_retention_period INTERVAL,
                cross_border_rules TEXT
            );
            RAISE NOTICE 'è¡¨ data_jurisdiction åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ data_jurisdiction å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ data_jurisdiction å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ’å…¥ç®¡è¾–æƒè§„åˆ™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_jurisdiction') THEN
            RAISE WARNING 'è¡¨ data_jurisdiction ä¸å­˜åœ¨';
            RETURN;
        END IF;

        INSERT INTO data_jurisdiction (data_region, jurisdiction_country, applicable_laws, data_retention_period, cross_border_rules)
        VALUES
            ('EU', 'Germany', ARRAY['GDPR'], INTERVAL '7 years', 'Requires explicit consent'),
            ('US', 'United States', ARRAY['CCPA', 'State Laws'], INTERVAL '5 years', 'Requires legal basis')
        ON CONFLICT DO NOTHING;
        RAISE NOTICE 'ç®¡è¾–æƒè§„åˆ™å·²æ’å…¥';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ data_jurisdiction ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥ç®¡è¾–æƒè§„åˆ™å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. æ•°æ®æœ¬åœ°åŒ–

### 3.1 åŒºåŸŸåŒ–éƒ¨ç½²

#### 3.1.1 å¤šåŒºåŸŸæ•°æ®åº“æ¶æ„

```sql
-- æ¬§æ´²åŒºåŸŸæ•°æ®åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'eu_production') THEN
            CREATE DATABASE eu_production;
            RAISE NOTICE 'æ•°æ®åº“ eu_production åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ•°æ®åº“ eu_production å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_database THEN
            RAISE WARNING 'æ•°æ®åº“ eu_production å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ•°æ®åº“';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ•°æ®åº“ eu_production å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¾å›½åŒºåŸŸæ•°æ®åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'us_production') THEN
            CREATE DATABASE us_production;
            RAISE NOTICE 'æ•°æ®åº“ us_production åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ•°æ®åº“ us_production å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_database THEN
            RAISE WARNING 'æ•°æ®åº“ us_production å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ•°æ®åº“';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ•°æ®åº“ us_production å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äºšæ´²åŒºåŸŸæ•°æ®åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'asia_production') THEN
            CREATE DATABASE asia_production;
            RAISE NOTICE 'æ•°æ®åº“ asia_production åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ•°æ®åº“ asia_production å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_database THEN
            RAISE WARNING 'æ•°æ®åº“ asia_production å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ•°æ®åº“';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ•°æ®åº“ asia_production å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ³¨æ„ï¼šåœ¨æ¯ä¸ªåŒºåŸŸåˆ›å»ºç›¸åŒçš„è¡¨ç»“æ„ï¼Œä½†æ•°æ®å­˜å‚¨åœ¨å„è‡ªçš„åŒºåŸŸ
```

#### 3.1.2 æ•°æ®è·¯ç”±

```sql
-- æ•°æ®è·¯ç”±å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- è·¯ç”±æ•°æ®åˆ°åŒºåŸŸå‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION route_data_by_region(
    p_user_region TEXT,
    p_data_type TEXT
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
    v_target_region TEXT;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_user_region IS NULL OR TRIM(p_user_region) = '' THEN
        RAISE EXCEPTION 'ç”¨æˆ·åŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_data_type IS NULL OR TRIM(p_data_type) = '' THEN
        RAISE EXCEPTION 'æ•°æ®ç±»å‹ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_classification') THEN
        RAISE EXCEPTION 'data_classificationè¡¨ä¸å­˜åœ¨';
    END IF;

    BEGIN
        -- æ ¹æ®ç”¨æˆ·åŒºåŸŸå’Œæ•°æ®ç±»å‹ç¡®å®šç›®æ ‡åŒºåŸŸ
        SELECT region_requirement INTO v_target_region
        FROM data_classification
        WHERE data_type = p_data_type;

        -- å¦‚æœæœªæ‰¾åˆ°æ•°æ®åˆ†ç±»ï¼Œè¿”å›é”™è¯¯
        IF v_target_region IS NULL OR TRIM(v_target_region) = '' THEN
            RAISE EXCEPTION 'æœªæ‰¾åˆ°æ•°æ®ç±»å‹ % çš„åˆ†ç±»ä¿¡æ¯', p_data_type;
        END IF;

        -- å¦‚æœç”¨æˆ·åŒºåŸŸä¸è¦æ±‚åŒºåŸŸä¸åŒ¹é…ï¼Œè¿”å›é”™è¯¯
        IF p_user_region != v_target_region AND v_target_region != 'GLOBAL' THEN
            RAISE EXCEPTION 'æ•°æ®å¿…é¡»å­˜å‚¨åœ¨åŒºåŸŸ % (ç”¨æˆ·åŒºåŸŸ: %)', v_target_region, p_user_region;
        END IF;

        RETURN v_target_region;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE EXCEPTION 'æœªæ‰¾åˆ°æ•°æ®ç±»å‹ % çš„åˆ†ç±»ä¿¡æ¯', p_data_type;
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è·¯ç”±æ•°æ®åˆ°åŒºåŸŸå¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'route_data_by_regionæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;
```

### 3.2 æ•°æ®å¤åˆ¶é™åˆ¶

```sql
-- æ£€æŸ¥æ•°æ®å¤åˆ¶æƒé™å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_replication_allowed(
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT
)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
DECLARE
    v_cross_border_allowed BOOLEAN;
    v_consent_exists BOOLEAN;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_source_region IS NULL OR TRIM(p_source_region) = '' THEN
        RAISE EXCEPTION 'æºåŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_target_region IS NULL OR TRIM(p_target_region) = '' THEN
        RAISE EXCEPTION 'ç›®æ ‡åŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_table_name IS NULL OR TRIM(p_table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_classification') THEN
        RAISE WARNING 'data_classificationè¡¨ä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸å…è®¸å¤åˆ¶';
        RETURN false;
    END IF;

    BEGIN
        -- æ£€æŸ¥æ˜¯å¦å…è®¸è·¨å¢ƒå¤åˆ¶
        SELECT cross_border_allowed INTO v_cross_border_allowed
        FROM data_classification
        WHERE table_name = p_table_name;

        -- å¦‚æœæœªæ‰¾åˆ°æ•°æ®åˆ†ç±»ï¼Œé»˜è®¤ä¸å…è®¸å¤åˆ¶
        IF v_cross_border_allowed IS NULL THEN
            RAISE WARNING 'æœªæ‰¾åˆ°è¡¨ % çš„åˆ†ç±»ä¿¡æ¯ï¼Œé»˜è®¤ä¸å…è®¸å¤åˆ¶', p_table_name;
            RETURN false;
        END IF;

        -- å¦‚æœæ˜¯åŒä¸€åŒºåŸŸï¼Œå…è®¸å¤åˆ¶
        IF p_source_region = p_target_region THEN
            RETURN true;
        END IF;

        -- å¦‚æœå…è®¸è·¨å¢ƒï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ³•å¾‹ä¾æ®
        IF v_cross_border_allowed THEN
            -- æ£€æŸ¥æ˜¯å¦æœ‰åˆæ³•çš„è·¨å¢ƒä¼ è¾“ä¾æ®
            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_consents') THEN
                    SELECT EXISTS(
                        SELECT 1
                        FROM cross_border_consents
                        WHERE table_name = p_table_name
                          AND consent_given = true
                          AND expiration_date IS NOT NULL
                          AND expiration_date > CURRENT_DATE
                    ) INTO v_consent_exists;

                    RETURN COALESCE(v_consent_exists, false);
                ELSE
                    RAISE WARNING 'è¡¨ cross_border_consents ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥æ³•å¾‹ä¾æ®';
                    RETURN false;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING 'æ£€æŸ¥æ³•å¾‹ä¾æ®å¤±è´¥: %', SQLERRM;
                    RETURN false;
            END;
        END IF;

        RETURN false;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å¤åˆ¶æƒé™å¤±è´¥: %', SQLERRM;
            RETURN false;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'check_replication_allowedæ‰§è¡Œå¤±è´¥: %', SQLERRM;
        RETURN false;
END;
$$;
```

---

## 4. è·¨å¢ƒæ•°æ®ä¼ è¾“

### 4.1 ä¼ è¾“æ§åˆ¶

#### 4.1.1 ä¼ è¾“å®¡æ‰¹æµç¨‹

```sql
-- è·¨å¢ƒä¼ è¾“ç”³è¯·è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_transfer_requests') THEN
            RAISE WARNING 'è¡¨ cross_border_transfer_requests å·²å­˜åœ¨';
        ELSE
            CREATE TABLE cross_border_transfer_requests (
                id SERIAL PRIMARY KEY,
                request_id TEXT UNIQUE,
                source_region TEXT NOT NULL,
                target_region TEXT NOT NULL,
                table_name TEXT NOT NULL,
                data_type TEXT,
                purpose TEXT,
                legal_basis TEXT,
                requested_by TEXT,
                approved_by TEXT,
                approval_date DATE,
                status TEXT DEFAULT 'pending',
                expiration_date DATE
            );
            RAISE NOTICE 'è¡¨ cross_border_transfer_requests åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ cross_border_transfer_requests å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ cross_border_transfer_requests å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè·¨å¢ƒä¼ è¾“è¯·æ±‚å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION request_cross_border_transfer(
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT,
    p_purpose TEXT,
    p_legal_basis TEXT
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
    v_request_id TEXT;
    v_current_user TEXT;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_source_region IS NULL OR TRIM(p_source_region) = '' THEN
        RAISE EXCEPTION 'æºåŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_target_region IS NULL OR TRIM(p_target_region) = '' THEN
        RAISE EXCEPTION 'ç›®æ ‡åŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_table_name IS NULL OR TRIM(p_table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_transfer_requests') THEN
        RAISE EXCEPTION 'cross_border_transfer_requestsè¡¨ä¸å­˜åœ¨';
    END IF;

    BEGIN
        -- ç”Ÿæˆè¯·æ±‚IDï¼ˆæœ€å¤šé‡è¯•3æ¬¡ä»¥é¿å…å†²çªï¼‰
        FOR i IN 1..3 LOOP
            BEGIN
                v_request_id := gen_random_uuid()::TEXT;
                EXIT;  -- æˆåŠŸç”Ÿæˆï¼Œé€€å‡ºå¾ªç¯
            EXCEPTION
                WHEN OTHERS THEN
                    IF i = 3 THEN
                        RAISE EXCEPTION 'ç”Ÿæˆè¯·æ±‚IDå¤±è´¥ï¼ˆé‡è¯•3æ¬¡åä»ç„¶å¤±è´¥ï¼‰';
                    END IF;
                    RAISE WARNING 'ç”Ÿæˆè¯·æ±‚IDå¤±è´¥ï¼Œé‡è¯• %/%', i, 3;
            END;
        END LOOP;

        IF v_request_id IS NULL OR LENGTH(v_request_id) < 32 THEN
            RAISE EXCEPTION 'ç”Ÿæˆçš„è¯·æ±‚IDæ— æ•ˆ';
        END IF;

        -- è·å–å½“å‰ç”¨æˆ·
        BEGIN
            v_current_user := current_user;
        EXCEPTION
            WHEN OTHERS THEN
                v_current_user := 'system';
        END;

        -- æ£€æŸ¥æ˜¯å¦å…è®¸è·¨å¢ƒä¼ è¾“
        IF NOT check_replication_allowed(p_source_region, p_target_region, p_table_name) THEN
            RAISE EXCEPTION 'ä¸å…è®¸è·¨å¢ƒä¼ è¾“: è¡¨=% (æºåŒºåŸŸ: %, ç›®æ ‡åŒºåŸŸ: %)',
                p_table_name, p_source_region, p_target_region;
        END IF;

        -- åˆ›å»ºä¼ è¾“è¯·æ±‚
        BEGIN
            INSERT INTO cross_border_transfer_requests (
                request_id,
                source_region,
                target_region,
                table_name,
                purpose,
                legal_basis,
                requested_by,
                status,
                request_date
            )
            VALUES (
                v_request_id,
                p_source_region,
                p_target_region,
                p_table_name,
                COALESCE(p_purpose, ''),
                COALESCE(p_legal_basis, ''),
                v_current_user,
                'pending',
                CURRENT_DATE
            );

            RAISE NOTICE 'è·¨å¢ƒä¼ è¾“è¯·æ±‚åˆ›å»ºæˆåŠŸ: request_id=%, table=%, source=%, target=%',
                v_request_id, p_table_name, p_source_region, p_target_region;
        EXCEPTION
            WHEN unique_violation THEN
                RAISE EXCEPTION 'è¯·æ±‚IDå†²çªï¼Œè¯·é‡è¯•';
            WHEN foreign_key_violation THEN
                RAISE EXCEPTION 'è¿åå¤–é”®çº¦æŸ';
            WHEN NOT_NULL_VIOLATION THEN
                RAISE EXCEPTION 'å¿…éœ€å­—æ®µä¸èƒ½ä¸ºNULL';
            WHEN OTHERS THEN
                RAISE EXCEPTION 'åˆ›å»ºä¼ è¾“è¯·æ±‚å¤±è´¥: %', SQLERRM;
        END;

        RETURN v_request_id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'request_cross_border_transferæ‰§è¡Œå¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'request_cross_border_transferæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;
```

#### 4.1.2 ä¼ è¾“åŠ å¯†

```sql
-- å¯¼å‡ºåŠ å¯†æ•°æ®å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION export_encrypted_data(
    p_table_name TEXT,
    p_region TEXT,
    p_encryption_key TEXT
)
RETURNS TABLE (
    encrypted_data BYTEA,
    metadata JSONB
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_row_count INTEGER;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_table_name IS NULL OR TRIM(p_table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_region IS NULL OR TRIM(p_region) = '' THEN
        RAISE EXCEPTION 'åŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_encryption_key IS NULL OR LENGTH(p_encryption_key) < 8 THEN
        RAISE EXCEPTION 'åŠ å¯†å¯†é’¥ä¸èƒ½ä¸ºç©ºä¸”é•¿åº¦è‡³å°‘8ä¸ªå­—ç¬¦';
    END IF;

    -- è¡¨åæ ¼å¼éªŒè¯ï¼ˆé˜²æ­¢SQLæ³¨å…¥ï¼‰
    IF p_table_name !~ '^[a-zA-Z_][a-zA-Z0-9_]*$' THEN
        RAISE EXCEPTION 'è¡¨åæ ¼å¼æ— æ•ˆ: %', p_table_name;
    END IF;

    -- æ£€æŸ¥pgcryptoæ‰©å±•
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
        RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨åŠ å¯†åŠŸèƒ½';
    END IF;

    -- æ£€æŸ¥pgp_sym_encryptå‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pgp_sym_encrypt') THEN
        RAISE EXCEPTION 'pgp_sym_encryptå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥pgcryptoæ‰©å±•';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = p_table_name) THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', p_table_name;
    END IF;

    BEGIN
        -- æ‰§è¡ŒåŠ å¯†æŸ¥è¯¢
        RETURN QUERY
        EXECUTE format('
            SELECT
                pgp_sym_encrypt(COALESCE(to_jsonb(t.*)::TEXT, ''''), %L) as encrypted_data,
                jsonb_build_object(
                    ''table_name'', %L,
                    ''region'', %L,
                    ''export_time'', NOW(),
                    ''row_count'', COUNT(*) OVER ()
                ) as metadata
            FROM %I t
            WHERE region = %L
            LIMIT 10000
        ', p_encryption_key, p_table_name, p_region, p_table_name, p_region);

        GET DIAGNOSTICS v_row_count = ROW_COUNT;
        RAISE NOTICE 'å¯¼å‡ºåŠ å¯†æ•°æ®å®Œæˆ: è¡¨=%, åŒºåŸŸ=%, è¡Œæ•°=%', p_table_name, p_region, v_row_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', p_table_name;
        WHEN undefined_function THEN
            RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…æˆ–å‡½æ•°ä¸å¯ç”¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'å¯¼å‡ºåŠ å¯†æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'export_encrypted_dataæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;
```

### 4.2 ä¼ è¾“ç›‘æ§

```sql
-- ä¼ è¾“æ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_transfer_log') THEN
            RAISE WARNING 'è¡¨ cross_border_transfer_log å·²å­˜åœ¨';
        ELSE
            CREATE TABLE cross_border_transfer_log (
                id BIGSERIAL PRIMARY KEY,
                transfer_time TIMESTAMPTZ DEFAULT NOW(),
                request_id TEXT,
                source_region TEXT,
                target_region TEXT,
                table_name TEXT,
                data_size BIGINT,
                transfer_status TEXT,
                error_message TEXT
            );
            RAISE NOTICE 'è¡¨ cross_border_transfer_log åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ cross_border_transfer_log å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ cross_border_transfer_log å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®°å½•è·¨å¢ƒä¼ è¾“æ—¥å¿—å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION log_cross_border_transfer(
    p_request_id TEXT,
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT,
    p_data_size BIGINT,
    p_status TEXT,
    p_error TEXT DEFAULT NULL
)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    v_inserted_count INTEGER;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_source_region IS NULL OR TRIM(p_source_region) = '' THEN
        RAISE EXCEPTION 'æºåŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_target_region IS NULL OR TRIM(p_target_region) = '' THEN
        RAISE EXCEPTION 'ç›®æ ‡åŒºåŸŸä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_table_name IS NULL OR TRIM(p_table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_status IS NULL OR TRIM(p_status) = '' THEN
        RAISE EXCEPTION 'ä¼ è¾“çŠ¶æ€ä¸èƒ½ä¸ºç©º';
    END IF;

    -- éªŒè¯çŠ¶æ€å€¼
    IF p_status NOT IN ('pending', 'approved', 'rejected', 'completed', 'failed') THEN
        RAISE WARNING 'æ— æ•ˆçš„ä¼ è¾“çŠ¶æ€: %, ä½¿ç”¨é»˜è®¤å€¼pending', p_status;
        p_status := 'pending';
    END IF;

    -- éªŒè¯æ•°æ®å¤§å°
    IF p_data_size IS NOT NULL AND p_data_size < 0 THEN
        RAISE WARNING 'æ•°æ®å¤§å°ä¸ºè´Ÿæ•°: %, è®¾ç½®ä¸ºNULL', p_data_size;
        p_data_size := NULL;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_transfer_log') THEN
        RAISE EXCEPTION 'cross_border_transfer_logè¡¨ä¸å­˜åœ¨';
    END IF;

    BEGIN
        INSERT INTO cross_border_transfer_log (
            request_id,
            source_region,
            target_region,
            table_name,
            data_size,
            transfer_status,
            error_message,
            transfer_time
        )
        VALUES (
            COALESCE(p_request_id, gen_random_uuid()::TEXT),
            p_source_region,
            p_target_region,
            p_table_name,
            p_data_size,
            p_status,
            p_error,
            NOW()
        );

        GET DIAGNOSTICS v_inserted_count = ROW_COUNT;
        RAISE NOTICE 'è·¨å¢ƒä¼ è¾“æ—¥å¿—è®°å½•æˆåŠŸ: request_id=%, status=%',
            COALESCE(p_request_id, 'NULL'), p_status;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨cross_border_transfer_logä¸å­˜åœ¨';
        WHEN NOT_NULL_VIOLATION THEN
            RAISE EXCEPTION 'å¿…éœ€å­—æ®µä¸èƒ½ä¸ºNULL';
        WHEN unique_violation THEN
            RAISE WARNING 'æ—¥å¿—è®°å½•å·²å­˜åœ¨ï¼ˆå¯èƒ½é‡å¤è®°å½•ï¼‰';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è®°å½•ä¼ è¾“æ—¥å¿—å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'log_cross_border_transferæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;
```

---

## 5. æ•°æ®ä¸»æƒæœ€ä½³å®è·µ

### 5.1 æ¶æ„è®¾è®¡

- âœ… **åŒºåŸŸåŒ–éƒ¨ç½²**: æŒ‰åœ°åŒºéƒ¨ç½²ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹
- âœ… **æ•°æ®åˆ†ç±»**: æ˜ç¡®æ•°æ®åˆ†ç±»å’ŒåŒºåŸŸè¦æ±‚
- âœ… **è®¿é—®æ§åˆ¶**: åŸºäºåŒºåŸŸçš„è®¿é—®æ§åˆ¶
- âœ… **åŠ å¯†å­˜å‚¨**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

### 5.2 åˆè§„æ€§ç®¡ç†

- âœ… **æ³•å¾‹ä¾æ®**: æ˜ç¡®è·¨å¢ƒä¼ è¾“çš„æ³•å¾‹ä¾æ®
- âœ… **å®¡æ‰¹æµç¨‹**: å»ºç«‹è·¨å¢ƒä¼ è¾“å®¡æ‰¹æµç¨‹
- âœ… **ä¼ è¾“åŠ å¯†**: æ‰€æœ‰è·¨å¢ƒä¼ è¾“åŠ å¯†
- âœ… **å®¡è®¡è¿½è¸ª**: å®Œæ•´è®°å½•æ‰€æœ‰æ•°æ®ä¼ è¾“

### 5.3 ç›‘æ§å’Œå‘Šè­¦

```sql
-- ç›‘æ§æ•°æ®ä½ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_classification') THEN
            RAISE WARNING 'è¡¨ data_classification ä¸å­˜åœ¨ï¼Œæ— æ³•ç›‘æ§æ•°æ®ä½ç½®';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO table_count FROM data_classification;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ•°æ®åˆ†ç±»è®°å½•', table_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æ§æ•°æ®ä½ç½®å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    region_requirement as region,
    COUNT(*) as table_count,
    SUM(pg_total_relation_size('public.'||table_name)) as total_size
FROM data_classification
GROUP BY region_requirement;

-- æ£€æµ‹è¿è§„ä¼ è¾“ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    unauthorized_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cross_border_transfer_log') THEN
            RAISE WARNING 'è¡¨ cross_border_transfer_log ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹è¿è§„ä¼ è¾“';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO unauthorized_count
        FROM cross_border_transfer_log
        WHERE transfer_status = 'unauthorized'
        AND transfer_time >= NOW() - INTERVAL '24 hours';

        IF unauthorized_count > 0 THEN
            RAISE WARNING 'å‘ç° % ä¸ªè¿è§„ä¼ è¾“è®°å½•ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰', unauthorized_count;
        ELSE
            RAISE NOTICE 'æœªå‘ç°è¿è§„ä¼ è¾“è®°å½•ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æµ‹è¿è§„ä¼ è¾“å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    transfer_time,
    source_region,
    target_region,
    table_name,
    transfer_status
FROM cross_border_transfer_log
WHERE transfer_status = 'unauthorized'
AND transfer_time >= NOW() - INTERVAL '24 hours';
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¼ä¸šçº§å®‰å…¨æ·±åŒ–](./ä¼ä¸šçº§å®‰å…¨æ·±åŒ–.md) - ä¼ä¸šçº§å®‰å…¨æ·±åŒ–
- [åˆè§„æ€§ç®¡ç†](./åˆè§„æ€§ç®¡ç†.md) - åˆè§„æ€§ç®¡ç†
- [å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—](./å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—.md) - å¤šç§Ÿæˆ·æ¶æ„

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
