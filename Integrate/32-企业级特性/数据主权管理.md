# PostgreSQL数据主权管理指南

> **PostgreSQL版本**: 17+/18+
> **适用场景**: 多区域部署、数据本地化要求
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL数据主权管理指南](#postgresql数据主权管理指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 什么是数据主权？](#11-什么是数据主权)
    - [1.2 数据主权的重要性](#12-数据主权的重要性)
  - [2. 数据主权概念](#2-数据主权概念)
    - [2.1 数据主权原则](#21-数据主权原则)
      - [2.1.1 数据本地化](#211-数据本地化)
      - [2.1.2 数据分类](#212-数据分类)
    - [2.2 数据管辖权](#22-数据管辖权)
  - [3. 数据本地化](#3-数据本地化)
    - [3.1 区域化部署](#31-区域化部署)
      - [3.1.1 多区域数据库架构](#311-多区域数据库架构)
      - [3.1.2 数据路由](#312-数据路由)
    - [3.2 数据复制限制](#32-数据复制限制)
  - [4. 跨境数据传输](#4-跨境数据传输)
    - [4.1 传输控制](#41-传输控制)
      - [4.1.1 传输审批流程](#411-传输审批流程)
      - [4.1.2 传输加密](#412-传输加密)
    - [4.2 传输监控](#42-传输监控)
  - [5. 数据主权最佳实践](#5-数据主权最佳实践)
    - [5.1 架构设计](#51-架构设计)
    - [5.2 合规性管理](#52-合规性管理)
    - [5.3 监控和告警](#53-监控和告警)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

### 1.1 什么是数据主权？

数据主权是指国家或地区对其境内数据拥有控制权和管辖权的概念。

**数据主权要求**:

- ✅ **数据本地化**: 数据必须存储在特定地区
- ✅ **跨境传输限制**: 限制或禁止数据跨境传输
- ✅ **数据访问控制**: 控制谁可以访问数据
- ✅ **数据管辖权**: 数据受当地法律管辖

### 1.2 数据主权的重要性

- **法律合规**: 遵守数据保护法规
- **国家安全**: 保护国家重要数据
- **隐私保护**: 保护个人隐私
- **商业风险**: 降低数据泄露风险

---

## 2. 数据主权概念

### 2.1 数据主权原则

#### 2.1.1 数据本地化

```sql
-- 按地区创建表空间
CREATE TABLESPACE eu_tablespace LOCATION '/data/eu';
CREATE TABLESPACE us_tablespace LOCATION '/data/us';
CREATE TABLESPACE asia_tablespace LOCATION '/data/asia';

-- 按地区存储数据
CREATE TABLE eu_users (
    id SERIAL PRIMARY KEY,
    username TEXT,
    email TEXT,
    region TEXT DEFAULT 'EU'
) TABLESPACE eu_tablespace;

CREATE TABLE us_users (
    id SERIAL PRIMARY KEY,
    username TEXT,
    email TEXT,
    region TEXT DEFAULT 'US'
) TABLESPACE us_tablespace;
```

#### 2.1.2 数据分类

```sql
-- 数据分类表
CREATE TABLE data_classification (
    id SERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    data_type TEXT,  -- 'personal', 'sensitive', 'public'
    region_requirement TEXT,  -- 'EU', 'US', 'ASIA', 'LOCAL'
    cross_border_allowed BOOLEAN DEFAULT false,
    encryption_required BOOLEAN DEFAULT true
);

-- 插入数据分类
INSERT INTO data_classification (table_name, data_type, region_requirement, cross_border_allowed, encryption_required)
VALUES
    ('eu_users', 'personal', 'EU', false, true),
    ('us_users', 'personal', 'US', false, true),
    ('public_content', 'public', 'GLOBAL', true, false);
```

### 2.2 数据管辖权

```sql
-- 数据管辖权表
CREATE TABLE data_jurisdiction (
    id SERIAL PRIMARY KEY,
    data_region TEXT NOT NULL,
    jurisdiction_country TEXT NOT NULL,
    applicable_laws TEXT[],
    data_retention_period INTERVAL,
    cross_border_rules TEXT
);

-- 插入管辖权规则
INSERT INTO data_jurisdiction (data_region, jurisdiction_country, applicable_laws, data_retention_period, cross_border_rules)
VALUES
    ('EU', 'Germany', ARRAY['GDPR'], INTERVAL '7 years', 'Requires explicit consent'),
    ('US', 'United States', ARRAY['CCPA', 'State Laws'], INTERVAL '5 years', 'Requires legal basis');
```

---

## 3. 数据本地化

### 3.1 区域化部署

#### 3.1.1 多区域数据库架构

```sql
-- 欧洲区域数据库
CREATE DATABASE eu_production;

-- 美国区域数据库
CREATE DATABASE us_production;

-- 亚洲区域数据库
CREATE DATABASE asia_production;

-- 在每个区域创建相同的表结构
-- 但数据存储在各自的区域
```

#### 3.1.2 数据路由

```sql
-- 数据路由函数
CREATE OR REPLACE FUNCTION route_data_by_region(
    p_user_region TEXT,
    p_data_type TEXT
)
RETURNS TEXT AS $$
DECLARE
    v_target_region TEXT;
BEGIN
    -- 根据用户区域和数据类型确定目标区域
    SELECT region_requirement INTO v_target_region
    FROM data_classification
    WHERE data_type = p_data_type;

    -- 如果用户区域与要求区域不匹配，返回错误
    IF p_user_region != v_target_region AND v_target_region != 'GLOBAL' THEN
        RAISE EXCEPTION 'Data must be stored in region: %', v_target_region;
    END IF;

    RETURN v_target_region;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 数据复制限制

```sql
-- 检查数据复制权限
CREATE OR REPLACE FUNCTION check_replication_allowed(
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_cross_border_allowed BOOLEAN;
BEGIN
    -- 检查是否允许跨境复制
    SELECT cross_border_allowed INTO v_cross_border_allowed
    FROM data_classification
    WHERE table_name = p_table_name;

    -- 如果是同一区域，允许复制
    IF p_source_region = p_target_region THEN
        RETURN true;
    END IF;

    -- 如果允许跨境，检查是否有法律依据
    IF v_cross_border_allowed THEN
        -- 检查是否有合法的跨境传输依据
        RETURN EXISTS(
            SELECT 1
            FROM cross_border_consents
            WHERE table_name = p_table_name
            AND consent_given = true
            AND expiration_date > CURRENT_DATE
        );
    END IF;

    RETURN false;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. 跨境数据传输

### 4.1 传输控制

#### 4.1.1 传输审批流程

```sql
-- 跨境传输申请表
CREATE TABLE cross_border_transfer_requests (
    id SERIAL PRIMARY KEY,
    request_id TEXT UNIQUE,
    source_region TEXT NOT NULL,
    target_region TEXT NOT NULL,
    table_name TEXT NOT NULL,
    data_type TEXT,
    purpose TEXT,
    legal_basis TEXT,
    requested_by TEXT,
    approved_by TEXT,
    approval_date DATE,
    status TEXT DEFAULT 'pending',
    expiration_date DATE
);

-- 创建传输请求
CREATE OR REPLACE FUNCTION request_cross_border_transfer(
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT,
    p_purpose TEXT,
    p_legal_basis TEXT
)
RETURNS TEXT AS $$
DECLARE
    v_request_id TEXT;
BEGIN
    -- 生成请求ID
    v_request_id := gen_random_uuid()::TEXT;

    -- 检查是否允许跨境传输
    IF NOT check_replication_allowed(p_source_region, p_target_region, p_table_name) THEN
        RAISE EXCEPTION 'Cross-border transfer not allowed for table: %', p_table_name;
    END IF;

    -- 创建传输请求
    INSERT INTO cross_border_transfer_requests (
        request_id,
        source_region,
        target_region,
        table_name,
        purpose,
        legal_basis,
        requested_by
    )
    VALUES (
        v_request_id,
        p_source_region,
        p_target_region,
        p_table_name,
        p_purpose,
        p_legal_basis,
        current_user
    );

    RETURN v_request_id;
END;
$$ LANGUAGE plpgsql;
```

#### 4.1.2 传输加密

```sql
-- 加密传输数据
CREATE OR REPLACE FUNCTION export_encrypted_data(
    p_table_name TEXT,
    p_region TEXT,
    p_encryption_key TEXT
)
RETURNS TABLE (
    encrypted_data BYTEA,
    metadata JSONB
) AS $$
BEGIN
    RETURN QUERY
    EXECUTE format('
        SELECT
            pgp_sym_encrypt(to_jsonb(t.*)::TEXT, %L) as encrypted_data,
            jsonb_build_object(
                ''table_name'', %L,
                ''region'', %L,
                ''export_time'', NOW()
            ) as metadata
        FROM %I t
        WHERE region = %L
    ', p_encryption_key, p_table_name, p_region, p_table_name, p_region);
END;
$$ LANGUAGE plpgsql;
```

### 4.2 传输监控

```sql
-- 传输日志表
CREATE TABLE cross_border_transfer_log (
    id BIGSERIAL PRIMARY KEY,
    transfer_time TIMESTAMPTZ DEFAULT NOW(),
    request_id TEXT,
    source_region TEXT,
    target_region TEXT,
    table_name TEXT,
    data_size BIGINT,
    transfer_status TEXT,
    error_message TEXT
);

-- 记录传输
CREATE OR REPLACE FUNCTION log_cross_border_transfer(
    p_request_id TEXT,
    p_source_region TEXT,
    p_target_region TEXT,
    p_table_name TEXT,
    p_data_size BIGINT,
    p_status TEXT,
    p_error TEXT DEFAULT NULL
)
RETURNS void AS $$
BEGIN
    INSERT INTO cross_border_transfer_log (
        request_id,
        source_region,
        target_region,
        table_name,
        data_size,
        transfer_status,
        error_message
    )
    VALUES (
        p_request_id,
        p_source_region,
        p_target_region,
        p_table_name,
        p_data_size,
        p_status,
        p_error
    );
END;
$$ LANGUAGE plpgsql;
```

---

## 5. 数据主权最佳实践

### 5.1 架构设计

- ✅ **区域化部署**: 按地区部署独立的数据库实例
- ✅ **数据分类**: 明确数据分类和区域要求
- ✅ **访问控制**: 基于区域的访问控制
- ✅ **加密存储**: 敏感数据加密存储

### 5.2 合规性管理

- ✅ **法律依据**: 明确跨境传输的法律依据
- ✅ **审批流程**: 建立跨境传输审批流程
- ✅ **传输加密**: 所有跨境传输加密
- ✅ **审计追踪**: 完整记录所有数据传输

### 5.3 监控和告警

```sql
-- 监控数据位置
SELECT
    region,
    COUNT(*) as table_count,
    SUM(pg_total_relation_size(schemaname||'.'||tablename)) as total_size
FROM pg_tables
JOIN data_classification ON pg_tables.tablename = data_classification.table_name
GROUP BY region;

-- 检测违规传输
SELECT
    transfer_time,
    source_region,
    target_region,
    table_name,
    transfer_status
FROM cross_border_transfer_log
WHERE transfer_status = 'unauthorized'
AND transfer_time >= NOW() - INTERVAL '24 hours';
```

---

## 📚 相关文档

- [企业级安全深化](./企业级安全深化.md) - 企业级安全深化
- [合规性管理](./合规性管理.md) - 合规性管理
- [多租户架构完整指南](./多租户架构完整指南.md) - 多租户架构

---

**最后更新**: 2025年1月
**状态**: ✅ 完成
