# PostgreSQLèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: å¤šç§Ÿæˆ·ç³»ç»Ÿã€äº‘æ•°æ®åº“æœåŠ¡
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†))
    èµ„æºéš”ç¦»
      è¿æ¥éš”ç¦»
      è¿æ¥æ± éš”ç¦»
      è¿æ¥é™åˆ¶
      CPUéš”ç¦»
      æŸ¥è¯¢ä¼˜å…ˆçº§
      å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶
      å†…å­˜éš”ç¦»
      å·¥ä½œå†…å­˜é™åˆ¶
      å…±äº«ç¼“å†²åŒºç›‘æ§
      I/Oéš”ç¦»
      è¡¨ç©ºé—´éš”ç¦»
      I/Oç›‘æ§
    é…é¢ç®¡ç†
      å­˜å‚¨é…é¢
      æ•°æ®åº“å¤§å°é™åˆ¶
      è¡¨å¤§å°é™åˆ¶
      è¿æ¥æ•°é…é¢
      æŸ¥è¯¢é…é¢
    èµ„æºé™åˆ¶é…ç½®
      è§’è‰²çº§åˆ«é™åˆ¶
      æ•°æ®åº“çº§åˆ«é™åˆ¶
      å…¨å±€é™åˆ¶
    ç›‘æ§ä¸å‘Šè­¦
      èµ„æºç›‘æ§æŸ¥è¯¢
      å‘Šè­¦é…ç½®
      è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬
    æœ€ä½³å®è·µ
      èµ„æºéš”ç¦»ç­–ç•¥
      é…é¢ç®¡ç†ç­–ç•¥
      ç›‘æ§ä¸å‘Šè­¦
      å¤šç§Ÿæˆ·æ¶æ„é›†æˆ
```

---

## ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦èµ„æºéš”ç¦»?] --> B{éš”ç¦»çº§åˆ«è¦æ±‚?}
    B -->|è¿æ¥çº§éš”ç¦»| C[è¿æ¥æ± éš”ç¦» + è¿æ¥é™åˆ¶]
    B -->|æŸ¥è¯¢çº§éš”ç¦»| D[CPUéš”ç¦» + å†…å­˜éš”ç¦»]
    B -->|å­˜å‚¨çº§éš”ç¦»| E[è¡¨ç©ºé—´éš”ç¦» + I/Oéš”ç¦»]
    B -->|å…¨é¢éš”ç¦»| F[å¤šç§Ÿæˆ·æ¶æ„ + èµ„æºéš”ç¦»]

    C --> G[ä¼˜åŠ¿: ç®€å•æœ‰æ•ˆ<br/>é€‚ç”¨: ä¸­å°è§„æ¨¡]
    D --> H[ä¼˜åŠ¿: ç²¾ç»†æ§åˆ¶<br/>é€‚ç”¨: æ€§èƒ½æ•æ„Ÿ]
    E --> I[ä¼˜åŠ¿: å­˜å‚¨éš”ç¦»<br/>é€‚ç”¨: å¤§è§„æ¨¡]
    F --> J[ä¼˜åŠ¿: å…¨é¢éš”ç¦»<br/>é€‚ç”¨: ä¼ä¸šçº§]

    A --> K{éœ€è¦é…é¢ç®¡ç†?}
    K -->|æ˜¯| L[å­˜å‚¨é…é¢ + è¿æ¥é…é¢ + æŸ¥è¯¢é…é¢]
    K -->|å¦| M[ä»…èµ„æºéš”ç¦»]
```

---

## ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| éš”ç¦»æ–¹æ¡ˆ | éš”ç¦»çº§åˆ« | å®ç°å¤æ‚åº¦ | æ€§èƒ½å½±å“ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- |
| **è¿æ¥æ± éš”ç¦»** | è¿æ¥çº§ | â­â­ | ä½ | ä¸­å°è§„æ¨¡å¤šç§Ÿæˆ· | âœ… PgBouncer |
| **è¿æ¥é™åˆ¶** | è¿æ¥çº§ | â­ | æä½ | åŸºç¡€éš”ç¦»éœ€æ±‚ | âœ… åŸç”Ÿæ”¯æŒ |
| **CPUéš”ç¦»** | æŸ¥è¯¢çº§ | â­â­â­ | ä¸­ | æ€§èƒ½æ•æ„Ÿåœºæ™¯ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **å†…å­˜éš”ç¦»** | æŸ¥è¯¢çº§ | â­â­ | ä½ | å†…å­˜æ•æ„Ÿåœºæ™¯ | âœ… åŸç”Ÿæ”¯æŒ |
| **è¡¨ç©ºé—´éš”ç¦»** | å­˜å‚¨çº§ | â­â­ | ä½ | å­˜å‚¨éš”ç¦»éœ€æ±‚ | âœ… åŸç”Ÿæ”¯æŒ |
| **å¤šç§Ÿæˆ·æ¶æ„** | å…¨é¢ | â­â­â­â­ | ä¸­ | ä¼ä¸šçº§å¤šç§Ÿæˆ· | âœ… RLS + éš”ç¦» |

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—](#postgresqlèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘](#-èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#-èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†ï¼Ÿ](#11-ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†)
    - [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
  - [2. èµ„æºéš”ç¦»æœºåˆ¶](#2-èµ„æºéš”ç¦»æœºåˆ¶)
    - [2.1 è¿æ¥éš”ç¦»](#21-è¿æ¥éš”ç¦»)
      - [2.1.1 è¿æ¥æ± éš”ç¦»](#211-è¿æ¥æ± éš”ç¦»)
      - [2.1.2 è¿æ¥é™åˆ¶](#212-è¿æ¥é™åˆ¶)
    - [2.2 CPUéš”ç¦»](#22-cpuéš”ç¦»)
      - [2.2.1 æŸ¥è¯¢ä¼˜å…ˆçº§](#221-æŸ¥è¯¢ä¼˜å…ˆçº§)
      - [2.2.2 å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶](#222-å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶)
    - [2.3 å†…å­˜éš”ç¦»](#23-å†…å­˜éš”ç¦»)
      - [2.3.1 å·¥ä½œå†…å­˜é™åˆ¶](#231-å·¥ä½œå†…å­˜é™åˆ¶)
      - [2.3.2 å…±äº«ç¼“å†²åŒºç›‘æ§](#232-å…±äº«ç¼“å†²åŒºç›‘æ§)
    - [2.4 I/Oéš”ç¦»](#24-ioéš”ç¦»)
      - [2.4.1 è¡¨ç©ºé—´éš”ç¦»](#241-è¡¨ç©ºé—´éš”ç¦»)
      - [2.4.2 I/Oç›‘æ§](#242-ioç›‘æ§)
  - [3. é…é¢ç®¡ç†ç­–ç•¥](#3-é…é¢ç®¡ç†ç­–ç•¥)
    - [3.1 å­˜å‚¨é…é¢](#31-å­˜å‚¨é…é¢)
      - [3.1.1 æ•°æ®åº“å¤§å°é™åˆ¶](#311-æ•°æ®åº“å¤§å°é™åˆ¶)
      - [3.1.2 è¡¨å¤§å°é™åˆ¶](#312-è¡¨å¤§å°é™åˆ¶)
    - [3.2 è¿æ¥æ•°é…é¢](#32-è¿æ¥æ•°é…é¢)
    - [3.3 æŸ¥è¯¢é…é¢](#33-æŸ¥è¯¢é…é¢)
  - [4. èµ„æºé™åˆ¶é…ç½®](#4-èµ„æºé™åˆ¶é…ç½®)
    - [4.1 è§’è‰²çº§åˆ«é™åˆ¶](#41-è§’è‰²çº§åˆ«é™åˆ¶)
    - [4.2 æ•°æ®åº“çº§åˆ«é™åˆ¶](#42-æ•°æ®åº“çº§åˆ«é™åˆ¶)
    - [4.3 å…¨å±€é™åˆ¶](#43-å…¨å±€é™åˆ¶)
  - [5. èµ„æºç›‘æ§ä¸å‘Šè­¦](#5-èµ„æºç›‘æ§ä¸å‘Šè­¦)
    - [5.1 èµ„æºç›‘æ§æŸ¥è¯¢](#51-èµ„æºç›‘æ§æŸ¥è¯¢)
    - [5.2 å‘Šè­¦é…ç½®](#52-å‘Šè­¦é…ç½®)
    - [5.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬](#53-è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 èµ„æºéš”ç¦»ç­–ç•¥](#61-èµ„æºéš”ç¦»ç­–ç•¥)
    - [6.2 é…é¢ç®¡ç†ç­–ç•¥](#62-é…é¢ç®¡ç†ç­–ç•¥)
    - [6.3 ç›‘æ§ä¸å‘Šè­¦](#63-ç›‘æ§ä¸å‘Šè­¦)
    - [6.4 å¤šç§Ÿæˆ·æ¶æ„é›†æˆ](#64-å¤šç§Ÿæˆ·æ¶æ„é›†æˆ)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†ï¼Ÿ

èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æ˜¯ç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿæˆ–äº‘æ•°æ®åº“æœåŠ¡ä¸­ï¼Œä¸åŒç§Ÿæˆ·æˆ–ç”¨æˆ·èƒ½å¤Ÿå…¬å¹³ã€å®‰å…¨åœ°ä½¿ç”¨æ•°æ®åº“èµ„æºçš„å…³é”®æœºåˆ¶ã€‚

**æ ¸å¿ƒç›®æ ‡**:

- âœ… **èµ„æºéš”ç¦»**: é˜²æ­¢ä¸€ä¸ªç§Ÿæˆ·çš„èµ„æºä½¿ç”¨å½±å“å…¶ä»–ç§Ÿæˆ·
- âœ… **é…é¢ç®¡ç†**: é™åˆ¶æ¯ä¸ªç§Ÿæˆ·çš„èµ„æºä½¿ç”¨ä¸Šé™
- âœ… **å…¬å¹³åˆ†é…**: ç¡®ä¿èµ„æºå…¬å¹³åˆ†é…
- âœ… **æ€§èƒ½ä¿éšœ**: ä¿éšœå…³é”®ç§Ÿæˆ·çš„æ€§èƒ½

### 1.2 é€‚ç”¨åœºæ™¯

- å¤šç§Ÿæˆ·SaaSåº”ç”¨
- äº‘æ•°æ®åº“æœåŠ¡
- å…±äº«æ•°æ®åº“ç¯å¢ƒ
- ä¼ä¸šå†…éƒ¨åˆ†éƒ¨é—¨èµ„æºç®¡ç†

---

## 2. èµ„æºéš”ç¦»æœºåˆ¶

### 2.1 è¿æ¥éš”ç¦»

#### 2.1.1 è¿æ¥æ± éš”ç¦»

```sql
-- ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± éš”ç¦»
-- pgbouncer.inié…ç½®
[databases]
tenant1 = host=localhost port=5432 dbname=mydb
tenant2 = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
```

#### 2.1.2 è¿æ¥é™åˆ¶

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®è¿æ¥é™åˆ¶
ALTER ROLE tenant1_user CONNECTION LIMIT 50;
ALTER ROLE tenant2_user CONNECTION LIMIT 50;

-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SELECT
    usename,
    count(*) as connection_count
FROM pg_stat_activity
WHERE datname = 'mydb'
GROUP BY usename;
```

### 2.2 CPUéš”ç¦»

#### 2.2.1 æŸ¥è¯¢ä¼˜å…ˆçº§

```sql
-- ä½¿ç”¨pg_stat_statementsç›‘æ§CPUä½¿ç”¨
CREATE EXTENSION pg_stat_statements;

-- æŸ¥çœ‹CPUå¯†é›†å‹æŸ¥è¯¢
SELECT
    userid::regrole,
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

#### 2.2.2 å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶

```sql
-- é™åˆ¶å¹¶è¡ŒæŸ¥è¯¢
ALTER ROLE tenant1_user SET max_parallel_workers_per_gather = 2;
ALTER ROLE tenant2_user SET max_parallel_workers_per_gather = 2;

-- å…¨å±€å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶
ALTER SYSTEM SET max_parallel_workers = 8;
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
```

### 2.3 å†…å­˜éš”ç¦»

#### 2.3.1 å·¥ä½œå†…å­˜é™åˆ¶

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®å·¥ä½œå†…å­˜
ALTER ROLE tenant1_user SET work_mem = '64MB';
ALTER ROLE tenant2_user SET work_mem = '64MB';

-- ç›‘æ§å†…å­˜ä½¿ç”¨
SELECT
    usename,
    state,
    query,
    query_start
FROM pg_stat_activity
WHERE state = 'active';
```

#### 2.3.2 å…±äº«ç¼“å†²åŒºç›‘æ§

```sql
-- æŸ¥çœ‹å…±äº«ç¼“å†²åŒºä½¿ç”¨
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

### 2.4 I/Oéš”ç¦»

#### 2.4.1 è¡¨ç©ºé—´éš”ç¦»

```sql
-- ä¸ºä¸åŒç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹è¡¨ç©ºé—´
CREATE TABLESPACE tenant1_tablespace
LOCATION '/data/tenant1';

CREATE TABLESPACE tenant2_tablespace
LOCATION '/data/tenant2';

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨
CREATE TABLE tenant1.orders (
    id SERIAL PRIMARY KEY,
    ...
) TABLESPACE tenant1_tablespace;
```

#### 2.4.2 I/Oç›‘æ§

```sql
-- ç›‘æ§I/Oä½¿ç”¨
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;
```

---

## 3. é…é¢ç®¡ç†ç­–ç•¥

### 3.1 å­˜å‚¨é…é¢

#### 3.1.1 æ•°æ®åº“å¤§å°é™åˆ¶

```sql
-- ç›‘æ§æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- è®¾ç½®è­¦å‘Šé˜ˆå€¼ï¼ˆé€šè¿‡ç›‘æ§ç³»ç»Ÿï¼‰
-- å½“æ•°æ®åº“å¤§å°è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
```

#### 3.1.2 è¡¨å¤§å°é™åˆ¶

```sql
-- ç›‘æ§è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'tenant1'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 è¿æ¥æ•°é…é¢

```sql
-- è®¾ç½®è¿æ¥æ•°é…é¢
ALTER ROLE tenant1_user CONNECTION LIMIT 50;
ALTER ROLE tenant2_user CONNECTION LIMIT 50;

-- ç›‘æ§è¿æ¥æ•°ä½¿ç”¨
SELECT
    usename,
    count(*) as current_connections,
    (SELECT rolconnlimit FROM pg_roles WHERE rolname = usename) as max_connections
FROM pg_stat_activity
WHERE datname = 'mydb'
GROUP BY usename;
```

### 3.3 æŸ¥è¯¢é…é¢

```sql
-- ä½¿ç”¨pg_stat_statementsç›‘æ§æŸ¥è¯¢
SELECT
    userid::regrole,
    count(*) as query_count,
    sum(calls) as total_calls
FROM pg_stat_statements
WHERE userid IN (
    SELECT oid FROM pg_roles WHERE rolname LIKE 'tenant%'
)
GROUP BY userid;
```

---

## 4. èµ„æºé™åˆ¶é…ç½®

### 4.1 è§’è‰²çº§åˆ«é™åˆ¶

```sql
-- åˆ›å»ºç§Ÿæˆ·è§’è‰²
CREATE ROLE tenant1_user WITH LOGIN PASSWORD 'password';
CREATE ROLE tenant2_user WITH LOGIN PASSWORD 'password';

-- è®¾ç½®èµ„æºé™åˆ¶
ALTER ROLE tenant1_user SET work_mem = '64MB';
ALTER ROLE tenant1_user SET maintenance_work_mem = '256MB';
ALTER ROLE tenant1_user SET max_parallel_workers_per_gather = 2;
ALTER ROLE tenant1_user CONNECTION LIMIT 50;
```

### 4.2 æ•°æ®åº“çº§åˆ«é™åˆ¶

```sql
-- ä¸ºç‰¹å®šæ•°æ®åº“è®¾ç½®é™åˆ¶
ALTER DATABASE tenant1_db SET work_mem = '64MB';
ALTER DATABASE tenant1_db SET max_connections = 100;
```

### 4.3 å…¨å±€é™åˆ¶

```sql
-- å…¨å±€èµ„æºé™åˆ¶
ALTER SYSTEM SET max_connections = 1000;
ALTER SYSTEM SET shared_buffers = '8GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET maintenance_work_mem = '1GB';
```

---

## 5. èµ„æºç›‘æ§ä¸å‘Šè­¦

### 5.1 èµ„æºç›‘æ§æŸ¥è¯¢

```sql
-- ç›‘æ§è¿æ¥æ•°
SELECT
    datname,
    count(*) as connections,
    max_conn_limit
FROM pg_stat_activity
JOIN pg_database ON pg_stat_activity.datname = pg_database.datname
GROUP BY datname, max_conn_limit;

-- ç›‘æ§å†…å­˜ä½¿ç”¨
SELECT
    usename,
    state,
    query,
    query_start,
    state_change
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;
```

### 5.2 å‘Šè­¦é…ç½®

```sql
-- åˆ›å»ºç›‘æ§å‡½æ•°
CREATE OR REPLACE FUNCTION check_resource_usage()
RETURNS TABLE (
    tenant_name TEXT,
    connection_count BIGINT,
    max_connections INT,
    usage_percent NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        r.rolname::TEXT,
        COUNT(a.pid)::BIGINT,
        r.rolconnlimit,
        CASE
            WHEN r.rolconnlimit > 0 THEN
                (COUNT(a.pid)::NUMERIC / r.rolconnlimit::NUMERIC * 100)
            ELSE 0
        END
    FROM pg_roles r
    LEFT JOIN pg_stat_activity a ON a.usename = r.rolname
    WHERE r.rolname LIKE 'tenant%'
    GROUP BY r.rolname, r.rolconnlimit
    HAVING COUNT(a.pid) > r.rolconnlimit * 0.8;  -- 80%é˜ˆå€¼
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æ§
SELECT * FROM check_resource_usage();
```

### 5.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# èµ„æºç›‘æ§è„šæœ¬

psql -d mydb -c "
SELECT
    usename,
    count(*) as connections,
    (SELECT rolconnlimit FROM pg_roles WHERE rolname = usename) as max_conn
FROM pg_stat_activity
WHERE datname = 'mydb'
GROUP BY usename
HAVING count(*) > (SELECT rolconnlimit FROM pg_roles WHERE rolname = usename) * 0.8;
" | mail -s "PostgreSQL Resource Alert" admin@example.com
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 èµ„æºéš”ç¦»ç­–ç•¥

| èµ„æºç±»å‹ | éš”ç¦»æ–¹æ³• | æ¨èé…ç½® |
| --- | --- | --- |
| **è¿æ¥** | è¿æ¥æ±  + è§’è‰²é™åˆ¶ | æ¯ä¸ªç§Ÿæˆ·50-100è¿æ¥ |
| **CPU** | æŸ¥è¯¢ä¼˜å…ˆçº§ + å¹¶è¡Œé™åˆ¶ | max_parallel_workers_per_gather = 2 |
| **å†…å­˜** | work_memé™åˆ¶ | æ¯ä¸ªç§Ÿæˆ·64-128MB |
| **I/O** | è¡¨ç©ºé—´éš”ç¦» | ç‹¬ç«‹è¡¨ç©ºé—´ |
| **å­˜å‚¨** | æ•°æ®åº“/è¡¨ç©ºé—´é…é¢ | ç›‘æ§ + å‘Šè­¦ |

### 6.2 é…é¢ç®¡ç†ç­–ç•¥

- âœ… **å­˜å‚¨é…é¢**: è®¾ç½®æ•°æ®åº“/è¡¨ç©ºé—´å¤§å°é™åˆ¶ï¼Œå®šæœŸç›‘æ§
- âœ… **è¿æ¥é…é¢**: æ ¹æ®ç§Ÿæˆ·è§„æ¨¡è®¾ç½®è¿æ¥æ•°é™åˆ¶
- âœ… **æŸ¥è¯¢é…é¢**: ç›‘æ§æŸ¥è¯¢é¢‘ç‡å’Œå¤æ‚åº¦
- âœ… **èµ„æºé¢„ç•™**: ä¸ºå…³é”®ç§Ÿæˆ·é¢„ç•™èµ„æº

### 6.3 ç›‘æ§ä¸å‘Šè­¦

- âœ… **å®æ—¶ç›‘æ§**: ä½¿ç”¨pg_stat_activityå’Œpg_stat_statements
- âœ… **å‘Šè­¦é˜ˆå€¼**: è®¾ç½®80%ä½¿ç”¨ç‡å‘Šè­¦
- âœ… **è‡ªåŠ¨åŒ–å“åº”**: è‡ªåŠ¨é™åˆ¶æˆ–æ‹’ç»è¶…é…é¢è¯·æ±‚
- âœ… **å®šæœŸæŠ¥å‘Š**: ç”Ÿæˆèµ„æºä½¿ç”¨æŠ¥å‘Š

### 6.4 å¤šç§Ÿæˆ·æ¶æ„é›†æˆ

```sql
-- ç»“åˆå¤šç§Ÿæˆ·æ¶æ„çš„èµ„æºéš”ç¦»
-- 1. ä½¿ç”¨RLSå®ç°æ•°æ®éš”ç¦»
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON orders
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- 2. ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®èµ„æºé™åˆ¶
ALTER ROLE tenant1_user SET work_mem = '64MB';
ALTER ROLE tenant1_user CONNECTION LIMIT 50;

-- 3. ç›‘æ§ç§Ÿæˆ·èµ„æºä½¿ç”¨
SELECT
    current_setting('app.tenant_id') as tenant_id,
    count(*) as connections,
    pg_size_pretty(sum(pg_total_relation_size(schemaname||'.'||tablename))) as storage
FROM pg_stat_activity
JOIN pg_tables ON pg_stat_activity.datname = current_database()
WHERE usename LIKE 'tenant%'
GROUP BY tenant_id;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—](./å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—.md) - å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡
- [SLAç®¡ç†å®Œæ•´æŒ‡å—](./SLAç®¡ç†å®Œæ•´æŒ‡å—.md) - SLAç®¡ç†
- [31-å®¹é‡è§„åˆ’](../31-å®¹é‡è§„åˆ’/README.md) - å®¹é‡è§„åˆ’
- [12-ç›‘æ§ä¸è¯Šæ–­](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç›‘æ§å’Œè¯Šæ–­

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
