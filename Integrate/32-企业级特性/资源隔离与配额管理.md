# PostgreSQLèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: å¤šç§Ÿæˆ·ç³»ç»Ÿã€äº‘æ•°æ®åº“æœåŠ¡
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†))
    èµ„æºéš”ç¦»
      è¿æ¥éš”ç¦»
      è¿æ¥æ± éš”ç¦»
      è¿æ¥é™åˆ¶
      CPUéš”ç¦»
      æŸ¥è¯¢ä¼˜å…ˆçº§
      å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶
      å†…å­˜éš”ç¦»
      å·¥ä½œå†…å­˜é™åˆ¶
      å…±äº«ç¼“å†²åŒºç›‘æ§
      I/Oéš”ç¦»
      è¡¨ç©ºé—´éš”ç¦»
      I/Oç›‘æ§
    é…é¢ç®¡ç†
      å­˜å‚¨é…é¢
      æ•°æ®åº“å¤§å°é™åˆ¶
      è¡¨å¤§å°é™åˆ¶
      è¿æ¥æ•°é…é¢
      æŸ¥è¯¢é…é¢
    èµ„æºé™åˆ¶é…ç½®
      è§’è‰²çº§åˆ«é™åˆ¶
      æ•°æ®åº“çº§åˆ«é™åˆ¶
      å…¨å±€é™åˆ¶
    ç›‘æ§ä¸å‘Šè­¦
      èµ„æºç›‘æ§æŸ¥è¯¢
      å‘Šè­¦é…ç½®
      è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬
    æœ€ä½³å®è·µ
      èµ„æºéš”ç¦»ç­–ç•¥
      é…é¢ç®¡ç†ç­–ç•¥
      ç›‘æ§ä¸å‘Šè­¦
      å¤šç§Ÿæˆ·æ¶æ„é›†æˆ
```

---

## ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦èµ„æºéš”ç¦»?] --> B{éš”ç¦»çº§åˆ«è¦æ±‚?}
    B -->|è¿æ¥çº§éš”ç¦»| C[è¿æ¥æ± éš”ç¦» + è¿æ¥é™åˆ¶]
    B -->|æŸ¥è¯¢çº§éš”ç¦»| D[CPUéš”ç¦» + å†…å­˜éš”ç¦»]
    B -->|å­˜å‚¨çº§éš”ç¦»| E[è¡¨ç©ºé—´éš”ç¦» + I/Oéš”ç¦»]
    B -->|å…¨é¢éš”ç¦»| F[å¤šç§Ÿæˆ·æ¶æ„ + èµ„æºéš”ç¦»]

    C --> G[ä¼˜åŠ¿: ç®€å•æœ‰æ•ˆ<br/>é€‚ç”¨: ä¸­å°è§„æ¨¡]
    D --> H[ä¼˜åŠ¿: ç²¾ç»†æ§åˆ¶<br/>é€‚ç”¨: æ€§èƒ½æ•æ„Ÿ]
    E --> I[ä¼˜åŠ¿: å­˜å‚¨éš”ç¦»<br/>é€‚ç”¨: å¤§è§„æ¨¡]
    F --> J[ä¼˜åŠ¿: å…¨é¢éš”ç¦»<br/>é€‚ç”¨: ä¼ä¸šçº§]

    A --> K{éœ€è¦é…é¢ç®¡ç†?}
    K -->|æ˜¯| L[å­˜å‚¨é…é¢ + è¿æ¥é…é¢ + æŸ¥è¯¢é…é¢]
    K -->|å¦| M[ä»…èµ„æºéš”ç¦»]
```

## ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| éš”ç¦»æ–¹æ¡ˆ | éš”ç¦»çº§åˆ« | å®ç°å¤æ‚åº¦ | æ€§èƒ½å½±å“ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- |
| **è¿æ¥æ± éš”ç¦»** | è¿æ¥çº§ | â­â­ | ä½ | ä¸­å°è§„æ¨¡å¤šç§Ÿæˆ· | âœ… PgBouncer |
| **è¿æ¥é™åˆ¶** | è¿æ¥çº§ | â­ | æä½ | åŸºç¡€éš”ç¦»éœ€æ±‚ | âœ… åŸç”Ÿæ”¯æŒ |
| **CPUéš”ç¦»** | æŸ¥è¯¢çº§ | â­â­â­ | ä¸­ | æ€§èƒ½æ•æ„Ÿåœºæ™¯ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **å†…å­˜éš”ç¦»** | æŸ¥è¯¢çº§ | â­â­ | ä½ | å†…å­˜æ•æ„Ÿåœºæ™¯ | âœ… åŸç”Ÿæ”¯æŒ |
| **è¡¨ç©ºé—´éš”ç¦»** | å­˜å‚¨çº§ | â­â­ | ä½ | å­˜å‚¨éš”ç¦»éœ€æ±‚ | âœ… åŸç”Ÿæ”¯æŒ |
| **å¤šç§Ÿæˆ·æ¶æ„** | å…¨é¢ | â­â­â­â­ | ä¸­ | ä¼ä¸šçº§å¤šç§Ÿæˆ· | âœ… RLS + éš”ç¦» |

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—](#postgresqlèµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æŒ‡å—)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘](#-èµ„æºéš”ç¦»æ–¹æ¡ˆé€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#-èµ„æºéš”ç¦»æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†ï¼Ÿ](#11-ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†)
    - [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
  - [2. èµ„æºéš”ç¦»æœºåˆ¶](#2-èµ„æºéš”ç¦»æœºåˆ¶)
    - [2.1 è¿æ¥éš”ç¦»](#21-è¿æ¥éš”ç¦»)
      - [2.1.1 è¿æ¥æ± éš”ç¦»](#211-è¿æ¥æ± éš”ç¦»)
      - [2.1.2 è¿æ¥é™åˆ¶](#212-è¿æ¥é™åˆ¶)
    - [2.2 CPUéš”ç¦»](#22-cpuéš”ç¦»)
      - [2.2.1 æŸ¥è¯¢ä¼˜å…ˆçº§](#221-æŸ¥è¯¢ä¼˜å…ˆçº§)
      - [2.2.2 å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶](#222-å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶)
    - [2.3 å†…å­˜éš”ç¦»](#23-å†…å­˜éš”ç¦»)
      - [2.3.1 å·¥ä½œå†…å­˜é™åˆ¶](#231-å·¥ä½œå†…å­˜é™åˆ¶)
      - [2.3.2 å…±äº«ç¼“å†²åŒºç›‘æ§](#232-å…±äº«ç¼“å†²åŒºç›‘æ§)
    - [2.4 I/Oéš”ç¦»](#24-ioéš”ç¦»)
      - [2.4.1 è¡¨ç©ºé—´éš”ç¦»](#241-è¡¨ç©ºé—´éš”ç¦»)
      - [2.4.2 I/Oç›‘æ§](#242-ioç›‘æ§)
  - [3. é…é¢ç®¡ç†ç­–ç•¥](#3-é…é¢ç®¡ç†ç­–ç•¥)
    - [3.1 å­˜å‚¨é…é¢](#31-å­˜å‚¨é…é¢)
      - [3.1.1 æ•°æ®åº“å¤§å°é™åˆ¶](#311-æ•°æ®åº“å¤§å°é™åˆ¶)
      - [3.1.2 è¡¨å¤§å°é™åˆ¶](#312-è¡¨å¤§å°é™åˆ¶)
    - [3.2 è¿æ¥æ•°é…é¢](#32-è¿æ¥æ•°é…é¢)
    - [3.3 æŸ¥è¯¢é…é¢](#33-æŸ¥è¯¢é…é¢)
  - [4. èµ„æºé™åˆ¶é…ç½®](#4-èµ„æºé™åˆ¶é…ç½®)
    - [4.1 è§’è‰²çº§åˆ«é™åˆ¶](#41-è§’è‰²çº§åˆ«é™åˆ¶)
    - [4.2 æ•°æ®åº“çº§åˆ«é™åˆ¶](#42-æ•°æ®åº“çº§åˆ«é™åˆ¶)
    - [4.3 å…¨å±€é™åˆ¶](#43-å…¨å±€é™åˆ¶)
  - [5. èµ„æºç›‘æ§ä¸å‘Šè­¦](#5-èµ„æºç›‘æ§ä¸å‘Šè­¦)
    - [5.1 èµ„æºç›‘æ§æŸ¥è¯¢](#51-èµ„æºç›‘æ§æŸ¥è¯¢)
    - [5.2 å‘Šè­¦é…ç½®](#52-å‘Šè­¦é…ç½®)
    - [5.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬](#53-è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 èµ„æºéš”ç¦»ç­–ç•¥](#61-èµ„æºéš”ç¦»ç­–ç•¥)
    - [6.2 é…é¢ç®¡ç†ç­–ç•¥](#62-é…é¢ç®¡ç†ç­–ç•¥)
    - [6.3 ç›‘æ§ä¸å‘Šè­¦](#63-ç›‘æ§ä¸å‘Šè­¦)
    - [6.4 å¤šç§Ÿæˆ·æ¶æ„é›†æˆ](#64-å¤šç§Ÿæˆ·æ¶æ„é›†æˆ)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†ï¼Ÿ

èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†æ˜¯ç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿæˆ–äº‘æ•°æ®åº“æœåŠ¡ä¸­ï¼Œä¸åŒç§Ÿæˆ·æˆ–ç”¨æˆ·èƒ½å¤Ÿå…¬å¹³ã€å®‰å…¨åœ°ä½¿ç”¨æ•°æ®åº“èµ„æºçš„å…³é”®æœºåˆ¶ã€‚

**æ ¸å¿ƒç›®æ ‡**:

- âœ… **èµ„æºéš”ç¦»**: é˜²æ­¢ä¸€ä¸ªç§Ÿæˆ·çš„èµ„æºä½¿ç”¨å½±å“å…¶ä»–ç§Ÿæˆ·
- âœ… **é…é¢ç®¡ç†**: é™åˆ¶æ¯ä¸ªç§Ÿæˆ·çš„èµ„æºä½¿ç”¨ä¸Šé™
- âœ… **å…¬å¹³åˆ†é…**: ç¡®ä¿èµ„æºå…¬å¹³åˆ†é…
- âœ… **æ€§èƒ½ä¿éšœ**: ä¿éšœå…³é”®ç§Ÿæˆ·çš„æ€§èƒ½

### 1.2 é€‚ç”¨åœºæ™¯

- å¤šç§Ÿæˆ·SaaSåº”ç”¨
- äº‘æ•°æ®åº“æœåŠ¡
- å…±äº«æ•°æ®åº“ç¯å¢ƒ
- ä¼ä¸šå†…éƒ¨åˆ†éƒ¨é—¨èµ„æºç®¡ç†

---

## 2. èµ„æºéš”ç¦»æœºåˆ¶

### 2.1 è¿æ¥éš”ç¦»

#### 2.1.1 è¿æ¥æ± éš”ç¦»

```sql
-- ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± éš”ç¦»
-- pgbouncer.inié…ç½®
[databases]
tenant1 = host=localhost port=5432 dbname=mydb
tenant2 = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
```

#### 2.1.2 è¿æ¥é™åˆ¶

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®è¿æ¥é™åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_name text;
    connection_limit int := 50;
    tenant_roles text[] := ARRAY['tenant1_user', 'tenant2_user'];
BEGIN
    FOREACH role_name IN ARRAY tenant_roles
    LOOP
        BEGIN
            -- æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = role_name) THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®è¿æ¥é™åˆ¶', role_name;
                CONTINUE;
            END IF;

            -- è®¾ç½®è¿æ¥é™åˆ¶
            EXECUTE format('ALTER ROLE %I CONNECTION LIMIT %s', role_name, connection_limit);
            RAISE NOTICE 'è§’è‰² % è¿æ¥é™åˆ¶è®¾ç½®ä¸º %', role_name, connection_limit;
        EXCEPTION
            WHEN undefined_object THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨', role_name;
            WHEN OTHERS THEN
                RAISE WARNING 'è®¾ç½®è§’è‰² % è¿æ¥é™åˆ¶å¤±è´¥: %', role_name, SQLERRM;
        END;
    END LOOP;
END $$;

-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    connection_record RECORD;
BEGIN
    FOR connection_record IN
        SELECT
            usename,
            count(*) as connection_count
        FROM pg_stat_activity
        WHERE datname = current_database()
        GROUP BY usename
        ORDER BY connection_count DESC
    LOOP
        RAISE NOTICE 'ç”¨æˆ· % å½“å‰è¿æ¥æ•°: %',
            connection_record.usename, connection_record.connection_count;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥è¯¢è¿æ¥æ•°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    usename,
    count(*) as connection_count
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY usename
ORDER BY connection_count DESC;
```

### 2.2 CPUéš”ç¦»

#### 2.2.1 æŸ¥è¯¢ä¼˜å…ˆçº§

```sql
-- ä½¿ç”¨pg_stat_statementsç›‘æ§CPUä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
            RAISE NOTICE 'æ‰©å±• pg_stat_statements åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'æ‰©å±• pg_stat_statements å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºæ‰©å±• pg_stat_statements';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ‰©å±• pg_stat_statements å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹CPUå¯†é›†å‹æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    query_record RECORD;
BEGIN
    FOR query_record IN
        SELECT
            userid::regrole as user_name,
            LEFT(query, 100) as query_preview,
            calls,
            total_exec_time,
            mean_exec_time
        FROM pg_stat_statements
        ORDER BY total_exec_time DESC
        LIMIT 10
    LOOP
        RAISE NOTICE 'ç”¨æˆ·: %, è°ƒç”¨æ¬¡æ•°: %, æ€»æ‰§è¡Œæ—¶é—´: %ms, å¹³å‡æ‰§è¡Œæ—¶é—´: %ms',
            query_record.user_name,
            query_record.calls,
            ROUND(query_record.total_exec_time::numeric, 2),
            ROUND(query_record.mean_exec_time::numeric, 2);
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥è¯¢CPUå¯†é›†å‹æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    userid::regrole,
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

#### 2.2.2 å¹¶è¡ŒæŸ¥è¯¢æ§åˆ¶

```sql
-- é™åˆ¶å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_name text;
    tenant_roles text[] := ARRAY['tenant1_user', 'tenant2_user'];
    max_workers int := 2;
BEGIN
    FOREACH role_name IN ARRAY tenant_roles
    LOOP
        BEGIN
            -- æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = role_name) THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶', role_name;
                CONTINUE;
            END IF;

            -- è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶
            EXECUTE format('ALTER ROLE %I SET max_parallel_workers_per_gather = %s', role_name, max_workers);
            RAISE NOTICE 'è§’è‰² % å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶è®¾ç½®ä¸º %', role_name, max_workers;
        EXCEPTION
            WHEN undefined_object THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨', role_name;
            WHEN OTHERS THEN
                RAISE WARNING 'è®¾ç½®è§’è‰² % å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶å¤±è´¥: %', role_name, SQLERRM;
        END;
    END LOOP;
END $$;

-- å…¨å±€å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT current_setting('is_superuser')::boolean THEN
        RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
    END IF;

    BEGIN
        ALTER SYSTEM SET max_parallel_workers = 8;
        ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å…¨å±€å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½é…ç½®';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN invalid_parameter_value THEN
            RAISE WARNING 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®å€¼';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å…¨å±€å¹¶è¡ŒæŸ¥è¯¢é™åˆ¶å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.3 å†…å­˜éš”ç¦»

#### 2.3.1 å·¥ä½œå†…å­˜é™åˆ¶

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®å·¥ä½œå†…å­˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_name text;
    tenant_roles text[] := ARRAY['tenant1_user', 'tenant2_user'];
    work_mem_size text := '64MB';
BEGIN
    FOREACH role_name IN ARRAY tenant_roles
    LOOP
        BEGIN
            -- æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = role_name) THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®å·¥ä½œå†…å­˜', role_name;
                CONTINUE;
            END IF;

            -- è®¾ç½®å·¥ä½œå†…å­˜
            EXECUTE format('ALTER ROLE %I SET work_mem = %L', role_name, work_mem_size);
            RAISE NOTICE 'è§’è‰² % å·¥ä½œå†…å­˜è®¾ç½®ä¸º %', role_name, work_mem_size;
        EXCEPTION
            WHEN undefined_object THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨', role_name;
            WHEN OTHERS THEN
                RAISE WARNING 'è®¾ç½®è§’è‰² % å·¥ä½œå†…å­˜å¤±è´¥: %', role_name, SQLERRM;
        END;
    END LOOP;
END $$;

---

-- ç›‘æ§å†…å­˜ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰

DO $$
DECLARE
    activity_record RECORD;
    active_count int;
BEGIN
    SELECT COUNT(*) INTO active_count
    FROM pg_stat_activity
    WHERE state = 'active';

    RAISE NOTICE 'å½“å‰æ´»è·ƒè¿æ¥æ•°: %', active_count;

    FOR activity_record IN
        SELECT
            usename,
            state,
            LEFT(query, 100) as query_preview,
            query_start
        FROM pg_stat_activity
        WHERE state = 'active'
        ORDER BY query_start
    LOOP
        RAISE NOTICE 'ç”¨æˆ·: %, çŠ¶æ€: %, æŸ¥è¯¢å¼€å§‹æ—¶é—´: %',
            activity_record.usename, activity_record.state, activity_record.query_start;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç›‘æ§å†…å­˜ä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    usename,
    state,
    LEFT(query, 100) as query_preview,
    query_start
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;
```

#### 2.3.2 å…±äº«ç¼“å†²åŒºç›‘æ§

```sql
-- æŸ¥çœ‹å…±äº«ç¼“å†²åŒºä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    total_size bigint := 0;
BEGIN
    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
        ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
        LIMIT 10
    LOOP
        BEGIN
            total_size := pg_total_relation_size(table_record.schemaname||'.'||table_record.tablename);
            RAISE NOTICE 'è¡¨ %.% å¤§å°: %',
                table_record.schemaname,
                table_record.tablename,
                pg_size_pretty(total_size);
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'è·å–è¡¨ %.% å¤§å°å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥è¯¢å…±äº«ç¼“å†²åŒºä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

### 2.4 I/Oéš”ç¦»

#### 2.4.1 è¡¨ç©ºé—´éš”ç¦»

```sql
-- ä¸ºä¸åŒç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹è¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    tablespace_name text;
    tablespace_location text;
    tablespace_info RECORD;
BEGIN
    -- å®šä¹‰è¡¨ç©ºé—´ä¿¡æ¯
    FOR tablespace_info IN
        SELECT * FROM (VALUES
            ('tenant1_tablespace', '/data/tenant1'),
            ('tenant2_tablespace', '/data/tenant2')
        ) AS t(name, location)
    LOOP
        BEGIN
            tablespace_name := tablespace_info.name;
            tablespace_location := tablespace_info.location;

            -- æ£€æŸ¥è¡¨ç©ºé—´æ˜¯å¦å·²å­˜åœ¨
            IF EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = tablespace_name) THEN
                RAISE NOTICE 'è¡¨ç©ºé—´ % å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º', tablespace_name;
                CONTINUE;
            END IF;

            -- åˆ›å»ºè¡¨ç©ºé—´ï¼ˆéœ€è¦ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æƒé™ï¼‰
            EXECUTE format('CREATE TABLESPACE %I LOCATION %L',
                tablespace_name, tablespace_location);
            RAISE NOTICE 'è¡¨ç©ºé—´ % åˆ›å»ºæˆåŠŸ', tablespace_name;
        EXCEPTION
            WHEN duplicate_object THEN
                RAISE NOTICE 'è¡¨ç©ºé—´ % å·²å­˜åœ¨', tablespace_name;
            WHEN insufficient_privilege THEN
                RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´ %', tablespace_name;
            WHEN OTHERS THEN
                RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´ % å¤±è´¥: %', tablespace_name, SQLERRM;
        END;
    END LOOP;
END $$;

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'tenant1') THEN
            CREATE SCHEMA tenant1;
            RAISE NOTICE 'Schema tenant1 åˆ›å»ºæˆåŠŸ';
        END IF;

        -- æ£€æŸ¥è¡¨ç©ºé—´æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'tenant1_tablespace') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ tenant1_tablespace ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨ç©ºé—´';
        END IF;

        -- åˆ›å»ºè¡¨
        CREATE TABLE IF NOT EXISTS tenant1.orders (
            id SERIAL PRIMARY KEY,
            created_at TIMESTAMPTZ DEFAULT NOW()
        ) TABLESPACE tenant1_tablespace;

        RAISE NOTICE 'è¡¨ tenant1.orders åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ tenant1.orders å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### 2.4.2 I/Oç›‘æ§

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–ï¼ˆæå‡I/Oéš”ç¦»æ€§èƒ½ï¼‰
-- å¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡I/Oæ€§èƒ½ï¼Œæ”¹å–„èµ„æºéš”ç¦»æ•ˆæœ
DO $$
BEGIN
    -- æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç”¨æˆ·
    IF NOT current_setting('is_superuser')::boolean THEN
        RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
    END IF;

    BEGIN
        -- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®ï¼ˆæå‡I/Oéš”ç¦»æ€§èƒ½ï¼‰
        -- å¯ç”¨å¼‚æ­¥I/Oå¯ä»¥æå‡2-3å€I/Oæ€§èƒ½ï¼Œæ”¹å–„èµ„æºéš”ç¦»æ•ˆæœ
        ALTER SYSTEM SET effective_io_concurrency = 200;  -- SSDæ¨èå€¼
        ALTER SYSTEM SET maintenance_io_concurrency = 10;  -- ç»´æŠ¤æ“ä½œå¹¶å‘

        -- é‡æ–°åŠ è½½é…ç½®
        PERFORM pg_reload_conf();

        RAISE NOTICE 'PostgreSQL 18å¼‚æ­¥I/Oé…ç½®å·²æ›´æ–°ï¼Œé…ç½®å·²é‡æ–°åŠ è½½';
        RAISE NOTICE 'å¼‚æ­¥I/Oä¼˜åŒ–æ•ˆæœï¼š';
        RAISE NOTICE '  - I/Oæ€§èƒ½æå‡ï¼š2-3å€';
        RAISE NOTICE '  - èµ„æºéš”ç¦»æ€§èƒ½æ”¹å–„ï¼šæ˜¾è‘—æå‡';
        RAISE NOTICE '  - å¤šç§Ÿæˆ·I/Oéš”ç¦»æ•ˆæœï¼šæ›´ä¼˜';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN invalid_parameter_value THEN
            RAISE WARNING 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®å€¼';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¼‚æ­¥I/Oé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›‘æ§I/Oä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    io_record RECORD;
    total_io_ops bigint;
BEGIN
    total_io_ops := 0;

    FOR io_record IN
        SELECT
            schemaname,
            tablename,
            seq_scan,
            seq_tup_read,
            idx_scan,
            idx_tup_fetch
        FROM pg_stat_user_tables
        ORDER BY seq_scan DESC
        LIMIT 10
    LOOP
        total_io_ops := total_io_ops + io_record.seq_scan + io_record.idx_scan;

        RAISE NOTICE 'è¡¨ %.% - é¡ºåºæ‰«æ: %, ç´¢å¼•æ‰«æ: %',
            io_record.schemaname, io_record.tablename,
            io_record.seq_scan, io_record.idx_scan;
    END LOOP;

    RAISE NOTICE 'å‰10ä¸ªè¡¨çš„IOæ“ä½œæ€»æ•°: %', total_io_ops;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç›‘æ§I/Oä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    (seq_scan + idx_scan) as total_scans
FROM pg_stat_user_tables
ORDER BY seq_scan DESC
LIMIT 10;
```

---

## 3. é…é¢ç®¡ç†ç­–ç•¥

### 3.1 å­˜å‚¨é…é¢

#### 3.1.1 æ•°æ®åº“å¤§å°é™åˆ¶

```sql
-- ç›‘æ§æ•°æ®åº“å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_record RECORD;
    db_size bigint;
    db_size_pretty text;
    warning_threshold_gb numeric := 100;  -- 100GBè­¦å‘Šé˜ˆå€¼
BEGIN
    FOR db_record IN
        SELECT datname FROM pg_database WHERE datistemplate = false
    LOOP
        BEGIN
            db_size := pg_database_size(db_record.datname);
            db_size_pretty := pg_size_pretty(db_size);

            RAISE NOTICE 'æ•°æ®åº“ % å¤§å°: %', db_record.datname, db_size_pretty;

            -- æ£€æŸ¥æ˜¯å¦è¶…è¿‡è­¦å‘Šé˜ˆå€¼
            IF db_size > (warning_threshold_gb * 1024 * 1024 * 1024) THEN
                RAISE WARNING 'æ•°æ®åº“ % å¤§å°è¶…è¿‡è­¦å‘Šé˜ˆå€¼: % (é˜ˆå€¼: % GB)',
                    db_record.datname, db_size_pretty, warning_threshold_gb;
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'ç›‘æ§æ•°æ®åº“ % å¤§å°å¤±è´¥: %', db_record.datname, SQLERRM;
        END;
    END LOOP;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šç›‘æ§æ•°æ®åº“å¤§å°
EXPLAIN ANALYZE
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size,
    pg_database_size(datname) as size_bytes
FROM pg_database
WHERE datistemplate = false
ORDER BY pg_database_size(datname) DESC;
```

#### 3.1.2 è¡¨å¤§å°é™åˆ¶

```sql
-- ç›‘æ§è¡¨å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    schema_name text := 'tenant1';
    table_count int;
    total_size bigint;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    SELECT COUNT(*) INTO table_count
    FROM pg_tables
    WHERE schemaname = schema_name;

    IF table_count = 0 THEN
        RAISE NOTICE 'Schema % ä¸­æ²¡æœ‰è¡¨', schema_name;
        RETURN;
    END IF;

    SELECT COALESCE(SUM(pg_total_relation_size(schemaname||'.'||tablename)), 0)
    INTO total_size
    FROM pg_tables
    WHERE schemaname = schema_name;

    RAISE NOTICE 'Schema % ä¸­å…±æœ‰ % ä¸ªè¡¨ï¼Œæ€»å¤§å°: %',
        schema_name, table_count, pg_size_pretty(total_size);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç›‘æ§è¡¨å¤§å°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables
WHERE schemaname = 'tenant1'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

### 3.2 è¿æ¥æ•°é…é¢

```sql
-- è®¾ç½®è¿æ¥æ•°é…é¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_name text;
    tenant_roles text[] := ARRAY['tenant1_user', 'tenant2_user'];
    connection_limit int := 50;
BEGIN
    FOREACH role_name IN ARRAY tenant_roles
    LOOP
        BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = role_name) THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®è¿æ¥æ•°é…é¢', role_name;
                CONTINUE;
            END IF;

            EXECUTE format('ALTER ROLE %I CONNECTION LIMIT %s', role_name, connection_limit);
            RAISE NOTICE 'è§’è‰² % è¿æ¥æ•°é…é¢è®¾ç½®ä¸º %', role_name, connection_limit;
        EXCEPTION
            WHEN undefined_object THEN
                RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨', role_name;
            WHEN OTHERS THEN
                RAISE WARNING 'è®¾ç½®è§’è‰² % è¿æ¥æ•°é…é¢å¤±è´¥: %', role_name, SQLERRM;
        END;
    END LOOP;
END $$;

-- ç›‘æ§è¿æ¥æ•°ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    connection_record RECORD;
    usage_percent numeric;
BEGIN
    FOR connection_record IN
        SELECT
            a.usename,
            COUNT(*)::int as current_connections,
            COALESCE(r.rolconnlimit, -1) as max_connections
        FROM pg_stat_activity a
        LEFT JOIN pg_roles r ON r.rolname = a.usename
        WHERE a.datname = current_database()
        GROUP BY a.usename, r.rolconnlimit
    LOOP
        IF connection_record.max_connections > 0 THEN
            usage_percent := ROUND(
                (connection_record.current_connections::numeric /
                 connection_record.max_connections::numeric * 100), 2
            );

            IF usage_percent > 80 THEN
                RAISE WARNING 'ç”¨æˆ· % è¿æ¥æ•°ä½¿ç”¨ç‡: %% (å½“å‰: %, æœ€å¤§: %)',
                    connection_record.usename, usage_percent,
                    connection_record.current_connections, connection_record.max_connections;
            ELSE
                RAISE NOTICE 'ç”¨æˆ· % è¿æ¥æ•°ä½¿ç”¨ç‡: %% (å½“å‰: %, æœ€å¤§: %)',
                    connection_record.usename, usage_percent,
                    connection_record.current_connections, connection_record.max_connections;
            END IF;
        END IF;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç›‘æ§è¿æ¥æ•°ä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    a.usename,
    COUNT(*) as current_connections,
    COALESCE(r.rolconnlimit, -1) as max_connections
FROM pg_stat_activity a
LEFT JOIN pg_roles r ON r.rolname = a.usename
WHERE a.datname = current_database()
GROUP BY a.usename, r.rolconnlimit
ORDER BY current_connections DESC;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

### 3.3 æŸ¥è¯¢é…é¢

```sql
-- ä½¿ç”¨pg_stat_statementsç›‘æ§æŸ¥è¯¢
SELECT
    userid::regrole,
    count(*) as query_count,
    sum(calls) as total_calls
FROM pg_stat_statements
WHERE userid IN (
    SELECT oid FROM pg_roles WHERE rolname LIKE 'tenant%'
)
GROUP BY userid;
```

---

## 4. èµ„æºé™åˆ¶é…ç½®

### 4.1 è§’è‰²çº§åˆ«é™åˆ¶

```sql
-- åˆ›å»ºç§Ÿæˆ·è§’è‰²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_info RECORD;
    tenant_roles RECORD;
BEGIN
    -- å®šä¹‰ç§Ÿæˆ·è§’è‰²ä¿¡æ¯
    FOR tenant_roles IN
        SELECT * FROM (VALUES
            ('tenant1_user', 'password1'),
            ('tenant2_user', 'password2')
        ) AS t(rolname, password)
    LOOP
        BEGIN
            -- æ£€æŸ¥è§’è‰²æ˜¯å¦å·²å­˜åœ¨
            IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = tenant_roles.rolname) THEN
                RAISE NOTICE 'è§’è‰² % å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º', tenant_roles.rolname;
            ELSE
                -- åˆ›å»ºè§’è‰²
                EXECUTE format('CREATE ROLE %I WITH LOGIN PASSWORD %L',
                    tenant_roles.rolname, tenant_roles.password);
                RAISE NOTICE 'è§’è‰² % åˆ›å»ºæˆåŠŸ', tenant_roles.rolname;
            END IF;
        EXCEPTION
            WHEN duplicate_object THEN
                RAISE NOTICE 'è§’è‰² % å·²å­˜åœ¨', tenant_roles.rolname;
            WHEN OTHERS THEN
                RAISE WARNING 'åˆ›å»ºè§’è‰² % å¤±è´¥: %', tenant_roles.rolname, SQLERRM;
        END;
    END LOOP;
END $$;

-- è®¾ç½®èµ„æºé™åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    role_name text := 'tenant1_user';
BEGIN
    -- æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = role_name) THEN
        RAISE EXCEPTION 'è§’è‰² % ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²', role_name;
    END IF;

    BEGIN
        EXECUTE format('ALTER ROLE %I SET work_mem = %L', role_name, '64MB');
        EXECUTE format('ALTER ROLE %I SET maintenance_work_mem = %L', role_name, '256MB');
        EXECUTE format('ALTER ROLE %I SET max_parallel_workers_per_gather = %s', role_name, 2);
        EXECUTE format('ALTER ROLE %I CONNECTION LIMIT %s', role_name, 50);

        RAISE NOTICE 'è§’è‰² % èµ„æºé™åˆ¶è®¾ç½®æˆåŠŸ', role_name;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è§’è‰² % ä¸å­˜åœ¨', role_name;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®è§’è‰² % èµ„æºé™åˆ¶å¤±è´¥: %', role_name, SQLERRM;
            RAISE;
    END;
END $$;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

### 4.2 æ•°æ®åº“çº§åˆ«é™åˆ¶

```sql
-- ä¸ºç‰¹å®šæ•°æ®åº“è®¾ç½®é™åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    db_name text := 'tenant1_db';
BEGIN
    -- æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = db_name) THEN
        RAISE EXCEPTION 'æ•°æ®åº“ % ä¸å­˜åœ¨', db_name;
    END IF;

    BEGIN
        EXECUTE format('ALTER DATABASE %I SET work_mem = %L', db_name, '64MB');
        -- æ³¨æ„ï¼šmax_connections ä¸èƒ½é€šè¿‡ ALTER DATABASE è®¾ç½®ï¼Œéœ€è¦åœ¨ postgresql.conf æˆ– ALTER SYSTEM ä¸­è®¾ç½®
        RAISE NOTICE 'æ•°æ®åº“ % èµ„æºé™åˆ¶è®¾ç½®æˆåŠŸ', db_name;
    EXCEPTION
        WHEN invalid_catalog_name THEN
            RAISE WARNING 'æ•°æ®åº“ % ä¸å­˜åœ¨', db_name;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ•°æ®åº“ % èµ„æºé™åˆ¶å¤±è´¥: %', db_name, SQLERRM;
            RAISE;
    END;
END $$;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

### 4.3 å…¨å±€é™åˆ¶

```sql
-- å…¨å±€èµ„æºé™åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç”¨æˆ·
    IF NOT current_setting('is_superuser')::boolean THEN
        RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®';
    END IF;

    BEGIN
        ALTER SYSTEM SET max_connections = 1000;
        ALTER SYSTEM SET shared_buffers = '8GB';
        ALTER SYSTEM SET work_mem = '64MB';
        ALTER SYSTEM SET maintenance_work_mem = '1GB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å…¨å±€èµ„æºé™åˆ¶é…ç½®æˆåŠŸï¼Œé…ç½®å·²é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿé…ç½®';
            RAISE;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å…¨å±€èµ„æºé™åˆ¶å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

---

## 5. èµ„æºç›‘æ§ä¸å‘Šè­¦

### 5.1 èµ„æºç›‘æ§æŸ¥è¯¢

```sql
-- ç›‘æ§è¿æ¥æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_record RECORD;
    conn_count int;
BEGIN
    FOR db_record IN
        SELECT datname FROM pg_database WHERE datistemplate = false
    LOOP
        BEGIN
            SELECT COUNT(*) INTO conn_count
            FROM pg_stat_activity
            WHERE datname = db_record.datname;

            RAISE NOTICE 'æ•°æ®åº“ % å½“å‰è¿æ¥æ•°: %', db_record.datname, conn_count;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'ç›‘æ§æ•°æ®åº“ % è¿æ¥æ•°å¤±è´¥: %', db_record.datname, SQLERRM;
        END;
    END LOOP;
END $$;

EXPLAIN ANALYZE
SELECT
    datname,
    count(*) as connections
FROM pg_stat_activity
JOIN pg_database ON pg_stat_activity.datname = pg_database.datname
WHERE pg_database.datistemplate = false
GROUP BY datname
ORDER BY connections DESC;

-- ç›‘æ§å†…å­˜ä½¿ç”¨ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN ANALYZE
SELECT
    usename,
    state,
    LEFT(query, 100) as query_preview,
    query_start,
    state_change
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
grep

### 5.2 å‘Šè­¦é…ç½®

```sql
-- åˆ›å»ºç›‘æ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_resource_usage()
RETURNS TABLE (
    tenant_name TEXT,
    connection_count BIGINT,
    max_connections INT,
    usage_percent NUMERIC
) AS $$
BEGIN
    BEGIN
        RETURN QUERY
        SELECT
            r.rolname::TEXT,
            COUNT(a.pid)::BIGINT,
            COALESCE(r.rolconnlimit, -1)::INT,
            CASE
                WHEN r.rolconnlimit > 0 THEN
                    ROUND((COUNT(a.pid)::NUMERIC / NULLIF(r.rolconnlimit, 0)::NUMERIC * 100), 2)
                ELSE 0
            END::NUMERIC
        FROM pg_roles r
        LEFT JOIN pg_stat_activity a ON a.usename = r.rolname
        WHERE r.rolname LIKE 'tenant%'
        GROUP BY r.rolname, r.rolconnlimit
        HAVING r.rolconnlimit > 0
           AND COUNT(a.pid) > r.rolconnlimit * 0.8;  -- 80%é˜ˆå€¼
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æ§å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
            -- è¿”å›ç©ºç»“æœè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
            RETURN;
    END;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æ§ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    alert_count int;
BEGIN
    SELECT COUNT(*) INTO alert_count
    FROM check_resource_usage();

    IF alert_count > 0 THEN
        RAISE WARNING 'æ£€æµ‹åˆ° % ä¸ªç§Ÿæˆ·èµ„æºä½¿ç”¨è¶…è¿‡80%%é˜ˆå€¼', alert_count;
    ELSE
        RAISE NOTICE 'æ‰€æœ‰ç§Ÿæˆ·èµ„æºä½¿ç”¨æ­£å¸¸';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ‰§è¡Œèµ„æºç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šç›‘æ§å‡½æ•°
EXPLAIN ANALYZE
SELECT * FROM check_resource_usage();
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

### 5.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# èµ„æºç›‘æ§è„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
set -e
set -u

error_exit() {
    echo "é”™è¯¯: $1" >&2
    exit 1
}

# é…ç½®å˜é‡
DB_NAME="${DB_NAME:-mydb}"
ALERT_EMAIL="${ALERT_EMAIL:-admin@example.com}"
ALERT_THRESHOLD="${ALERT_THRESHOLD:-0.8}"

# æ£€æŸ¥psqlæ˜¯å¦å®‰è£…
if ! command -v psql &> /dev/null; then
    error_exit "psqlæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…PostgreSQLå®¢æˆ·ç«¯å·¥å…·"
fi

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
if ! psql -d "$DB_NAME" -c "SELECT 1;" &> /dev/null; then
    error_exit "æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ $DB_NAMEï¼Œè¯·æ£€æŸ¥è¿æ¥é…ç½®"
fi

# æ‰§è¡Œç›‘æ§æŸ¥è¯¢
echo "æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ..."
QUERY_RESULT=$(psql -d "$DB_NAME" -t -c "
SELECT
    usename,
    count(*)::int as connections,
    COALESCE((SELECT rolconnlimit FROM pg_roles WHERE rolname = a.usename), -1) as max_conn
FROM pg_stat_activity a
WHERE datname = '$DB_NAME'
GROUP BY usename
HAVING count(*) > COALESCE((SELECT rolconnlimit FROM pg_roles WHERE rolname = a.usename), 0) * $ALERT_THRESHOLD
  AND (SELECT rolconnlimit FROM pg_roles WHERE rolname = a.usename) > 0;
" 2>&1)

if [ $? -ne 0 ]; then
    error_exit "æ‰§è¡Œç›‘æ§æŸ¥è¯¢å¤±è´¥: $QUERY_RESULT"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡é˜ˆå€¼çš„è¿æ¥
if [ -n "$QUERY_RESULT" ] && [ -n "$(echo "$QUERY_RESULT" | tr -d '[:space:]')" ]; then
    echo "æ£€æµ‹åˆ°èµ„æºä½¿ç”¨è¶…è¿‡é˜ˆå€¼ï¼Œå‘é€å‘Šè­¦é‚®ä»¶..."
    echo "$QUERY_RESULT" | mail -s "PostgreSQL Resource Alert - $DB_NAME" "$ALERT_EMAIL" || \
        error_exit "å‘é€é‚®ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥mailé…ç½®"
    echo "å‘Šè­¦é‚®ä»¶å·²å‘é€"
else
    echo "èµ„æºä½¿ç”¨æ­£å¸¸"
fi
```

<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
grep

---

## 6. æœ€ä½³å®è·µ

### 6.1 èµ„æºéš”ç¦»ç­–ç•¥

| èµ„æºç±»å‹ | éš”ç¦»æ–¹æ³• | æ¨èé…ç½® |
| --- | --- | --- |
| **è¿æ¥** | è¿æ¥æ±  + è§’è‰²é™åˆ¶ | æ¯ä¸ªç§Ÿæˆ·50-100è¿æ¥ |
| **CPU** | æŸ¥è¯¢ä¼˜å…ˆçº§ + å¹¶è¡Œé™åˆ¶ | max_parallel_workers_per_gather = 2 |
| **å†…å­˜** | work_memé™åˆ¶ | æ¯ä¸ªç§Ÿæˆ·64-128MB |
| **I/O** | è¡¨ç©ºé—´éš”ç¦» | ç‹¬ç«‹è¡¨ç©ºé—´ |
| **å­˜å‚¨** | æ•°æ®åº“/è¡¨ç©ºé—´é…é¢ | ç›‘æ§ + å‘Šè­¦ |

### 6.2 é…é¢ç®¡ç†ç­–ç•¥

- âœ… **å­˜å‚¨é…é¢**: è®¾ç½®æ•°æ®åº“/è¡¨ç©ºé—´å¤§å°é™åˆ¶ï¼Œå®šæœŸç›‘æ§
- âœ… **è¿æ¥é…é¢**: æ ¹æ®ç§Ÿæˆ·è§„æ¨¡è®¾ç½®è¿æ¥æ•°é™åˆ¶
- âœ… **æŸ¥è¯¢é…é¢**: ç›‘æ§æŸ¥è¯¢é¢‘ç‡å’Œå¤æ‚åº¦
- âœ… **èµ„æºé¢„ç•™**: ä¸ºå…³é”®ç§Ÿæˆ·é¢„ç•™èµ„æº

### 6.3 ç›‘æ§ä¸å‘Šè­¦

- âœ… **å®æ—¶ç›‘æ§**: ä½¿ç”¨pg_stat_activityå’Œpg_stat_statements
- âœ… **å‘Šè­¦é˜ˆå€¼**: è®¾ç½®80%ä½¿ç”¨ç‡å‘Šè­¦
- âœ… **è‡ªåŠ¨åŒ–å“åº”**: è‡ªåŠ¨é™åˆ¶æˆ–æ‹’ç»è¶…é…é¢è¯·æ±‚
- âœ… **å®šæœŸæŠ¥å‘Š**: ç”Ÿæˆèµ„æºä½¿ç”¨æŠ¥å‘Š

### 6.4 å¤šç§Ÿæˆ·æ¶æ„é›†æˆ

```sql
-- ç»“åˆå¤šç§Ÿæˆ·æ¶æ„çš„èµ„æºéš”ç¦»
-- 1. ä½¿ç”¨RLSå®ç°æ•°æ®éš”ç¦»
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON orders
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- 2. ä¸ºæ¯ä¸ªç§Ÿæˆ·è®¾ç½®èµ„æºé™åˆ¶
ALTER ROLE tenant1_user SET work_mem = '64MB';
ALTER ROLE tenant1_user CONNECTION LIMIT 50;

-- 3. ç›‘æ§ç§Ÿæˆ·èµ„æºä½¿ç”¨
SELECT
    current_setting('app.tenant_id') as tenant_id,
    count(*) as connections,
    pg_size_pretty(sum(pg_total_relation_size(schemaname||'.'||tablename))) as storage
FROM pg_stat_activity
JOIN pg_tables ON pg_stat_activity.datname = current_database()
WHERE usename LIKE 'tenant%'
GROUP BY tenant_id;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—](./å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—.md) - å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡
- [SLAç®¡ç†å®Œæ•´æŒ‡å—](./SLAç®¡ç†å®Œæ•´æŒ‡å—.md) - SLAç®¡ç†
- [31-å®¹é‡è§„åˆ’](../31-å®¹é‡è§„åˆ’/README.md) - å®¹é‡è§„åˆ’
- [12-ç›‘æ§ä¸è¯Šæ–­](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç›‘æ§å’Œè¯Šæ–­

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
