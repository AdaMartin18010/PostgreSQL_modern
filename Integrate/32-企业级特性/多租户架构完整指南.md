# PostgreSQLå¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—

> **PostgreSQLç‰ˆæœ¬**: 18.x
> **é€‚ç”¨åœºæ™¯**: å¤šç§Ÿæˆ·SaaSåº”ç”¨
> **å‚è€ƒæ¡ˆä¾‹**: [19-å®æˆ˜æ¡ˆä¾‹/04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ](../19-å®æˆ˜æ¡ˆä¾‹/04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ/README.md)

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¤šç§Ÿæˆ·æ¶æ„))
    æ¶æ„æ¨¡å¼
      å…±äº«Schema + RLS
      ç‹¬ç«‹Schema
      ç‹¬ç«‹æ•°æ®åº“
      æ··åˆæ¨¡å¼
    ç§Ÿæˆ·éš”ç¦»
      RLSç­–ç•¥
      åŸºç¡€RLSå®ç°
      PostgreSQL 18ä¼˜åŒ–
      é«˜çº§RLSç­–ç•¥
      Schemaéš”ç¦»
      æ•°æ®åº“éš”ç¦»
    æ€§èƒ½ä¼˜åŒ–
      ç´¢å¼•ä¼˜åŒ–
      è¿æ¥æ± ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–
      PostgreSQL 18ç‰¹æ€§
    å®‰å…¨ç®¡ç†
      ç§Ÿæˆ·è®¤è¯
      å®¡è®¡æ—¥å¿—
      æ•°æ®åŠ å¯†
    æ•°æ®æ¨¡å‹
      å…±äº«è¡¨ + tenant_id
      ç§Ÿæˆ·ç‰¹å®šè¡¨
      æ··åˆæ¨¡å‹
```

---

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„é€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦è®¾è®¡å¤šç§Ÿæˆ·æ¶æ„?] --> B{ç§Ÿæˆ·æ•°é‡?}
    B -->|<100| C[ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼]
    B -->|100-1000| D{å®šåˆ¶åŒ–éœ€æ±‚?}
    B -->|>1000| E[å…±äº«Schema + RLS]

    D -->|é«˜å®šåˆ¶åŒ–| F[ç‹¬ç«‹Schemaæ¨¡å¼]
    D -->|ä½å®šåˆ¶åŒ–| E

    C --> G[ä¼˜åŠ¿: å®Œå…¨éš”ç¦»<br/>é€‚ç”¨: å°è§„æ¨¡]
    F --> H[ä¼˜åŠ¿: çµæ´»å®šåˆ¶<br/>é€‚ç”¨: ä¸­è§„æ¨¡]
    E --> I[ä¼˜åŠ¿: æˆæœ¬ä½<br/>é€‚ç”¨: å¤§è§„æ¨¡]

    A --> J{æ•°æ®éš”ç¦»è¦æ±‚?}
    J -->|ä¸¥æ ¼éš”ç¦»| C
    J -->|ä¸­ç­‰éš”ç¦»| F
    J -->|åŸºç¡€éš”ç¦»| E
```

---

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼å¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ¨¡å¼ | éš”ç¦»çº§åˆ« | æˆæœ¬ | æ€§èƒ½ | æ‰©å±•æ€§ | ç»´æŠ¤å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- | --- |
| **å…±äº«Schema + RLS** | â­â­â­ | ä½ | â­â­â­â­ | â­â­â­â­â­ | â­â­ | å¤§è§„æ¨¡SaaS (1000+ç§Ÿæˆ·) |
| **ç‹¬ç«‹Schema** | â­â­â­â­ | ä¸­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | ä¸­è§„æ¨¡SaaS (100-1000ç§Ÿæˆ·) |
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | é«˜ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | å°è§„æ¨¡SaaS (<100ç§Ÿæˆ·) |
| **æ··åˆæ¨¡å¼** | â­â­â­â­ | ä¸­-é«˜ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å¤æ‚éœ€æ±‚åœºæ™¯ |

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLå¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—](#postgresqlå¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æŒ‡å—)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„é€‰å‹å†³ç­–æ ‘](#-å¤šç§Ÿæˆ·æ¶æ„é€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼å¯¹æ¯”çŸ©é˜µ](#-å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼å¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·æ¶æ„ï¼Ÿ](#11-ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·æ¶æ„)
    - [1.2 å¤šç§Ÿæˆ·æ¶æ„çš„ä¼˜åŠ¿](#12-å¤šç§Ÿæˆ·æ¶æ„çš„ä¼˜åŠ¿)
    - [1.3 å¤šç§Ÿæˆ·æ¶æ„çš„æŒ‘æˆ˜](#13-å¤šç§Ÿæˆ·æ¶æ„çš„æŒ‘æˆ˜)
  - [2. å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](#2-å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡)
    - [2.1 æ¶æ„æ¨¡å¼](#21-æ¶æ„æ¨¡å¼)
      - [æ¨¡å¼1ï¼šå…±äº«Schema + RLSï¼ˆæ¨èï¼‰â­](#æ¨¡å¼1å…±äº«schema--rlsæ¨è)
      - [æ¨¡å¼2ï¼šç‹¬ç«‹Schema](#æ¨¡å¼2ç‹¬ç«‹schema)
      - [æ¨¡å¼3ï¼šç‹¬ç«‹æ•°æ®åº“](#æ¨¡å¼3ç‹¬ç«‹æ•°æ®åº“)
  - [3. ç§Ÿæˆ·éš”ç¦»ç­–ç•¥](#3-ç§Ÿæˆ·éš”ç¦»ç­–ç•¥)
    - [3.1 RLSç­–ç•¥ï¼ˆæ¨èæ–¹æ¡ˆï¼‰](#31-rlsç­–ç•¥æ¨èæ–¹æ¡ˆ)
      - [3.1.1 åŸºç¡€RLSå®ç°](#311-åŸºç¡€rlså®ç°)
      - [3.1.2 PostgreSQL 18 RLSæ€§èƒ½ä¼˜åŒ–](#312-postgresql-18-rlsæ€§èƒ½ä¼˜åŒ–)
      - [3.1.3 é«˜çº§RLSç­–ç•¥](#313-é«˜çº§rlsç­–ç•¥)
    - [3.2 Schemaéš”ç¦»](#32-schemaéš”ç¦»)
    - [3.3 æ•°æ®åº“éš”ç¦»](#33-æ•°æ®åº“éš”ç¦»)
  - [4. å¤šç§Ÿæˆ·æ€§èƒ½ä¼˜åŒ–](#4-å¤šç§Ÿæˆ·æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 è¿æ¥æ± ä¼˜åŒ–](#42-è¿æ¥æ± ä¼˜åŒ–)
    - [4.3 æŸ¥è¯¢ä¼˜åŒ–](#43-æŸ¥è¯¢ä¼˜åŒ–)
    - [4.4 PostgreSQL 18æ€§èƒ½ç‰¹æ€§](#44-postgresql-18æ€§èƒ½ç‰¹æ€§)
  - [5. å¤šç§Ÿæˆ·å®‰å…¨ç®¡ç†](#5-å¤šç§Ÿæˆ·å®‰å…¨ç®¡ç†)
    - [5.1 ç§Ÿæˆ·è®¤è¯](#51-ç§Ÿæˆ·è®¤è¯)
    - [5.2 å®¡è®¡æ—¥å¿—](#52-å®¡è®¡æ—¥å¿—)
    - [5.3 æ•°æ®åŠ å¯†](#53-æ•°æ®åŠ å¯†)
  - [6. å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹è®¾è®¡](#6-å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹è®¾è®¡)
    - [6.1 æ•°æ®æ¨¡å‹æ¨¡å¼](#61-æ•°æ®æ¨¡å‹æ¨¡å¼)
      - [æ¨¡å¼1ï¼šå…±äº«è¡¨ + tenant\_id](#æ¨¡å¼1å…±äº«è¡¨--tenant_id)
      - [æ¨¡å¼2ï¼šç§Ÿæˆ·ç‰¹å®šè¡¨](#æ¨¡å¼2ç§Ÿæˆ·ç‰¹å®šè¡¨)
    - [6.2 æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ](#62-æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¶æ„é€‰æ‹©](#71-æ¶æ„é€‰æ‹©)
    - [7.2 æ€§èƒ½ä¼˜åŒ–](#72-æ€§èƒ½ä¼˜åŒ–)
    - [7.3 å®‰å…¨ç®¡ç†](#73-å®‰å…¨ç®¡ç†)
    - [7.4 ç›‘æ§ä¸å‘Šè­¦](#74-ç›‘æ§ä¸å‘Šè­¦)
  - [8. å‚è€ƒæ¡ˆä¾‹](#8-å‚è€ƒæ¡ˆä¾‹)
    - [8.1 å®æˆ˜æ¡ˆä¾‹](#81-å®æˆ˜æ¡ˆä¾‹)
    - [8.2 ç›¸å…³æ–‡æ¡£](#82-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·æ¶æ„ï¼Ÿ

å¤šç§Ÿæˆ·æ¶æ„ï¼ˆMulti-Tenant Architectureï¼‰æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„æ¨¡å¼ï¼Œå…è®¸å•ä¸ªåº”ç”¨å®ä¾‹ä¸ºå¤šä¸ªç§Ÿæˆ·ï¼ˆå®¢æˆ·ï¼‰æä¾›æœåŠ¡ï¼ŒåŒæ—¶ä¿æŒæ•°æ®éš”ç¦»å’Œå®‰å…¨æ€§ã€‚

### 1.2 å¤šç§Ÿæˆ·æ¶æ„çš„ä¼˜åŠ¿

- âœ… **æˆæœ¬æ•ˆç›Š**: å…±äº«åŸºç¡€è®¾æ–½ï¼Œé™ä½è¿è¥æˆæœ¬
- âœ… **æ˜“äºç»´æŠ¤**: å•ä¸€ä»£ç åº“ï¼Œç»Ÿä¸€æ›´æ–°
- âœ… **å¿«é€Ÿæ‰©å±•**: æ–°ç§Ÿæˆ·å¿«é€Ÿæ¥å…¥
- âœ… **èµ„æºåˆ©ç”¨**: æé«˜èµ„æºåˆ©ç”¨ç‡

### 1.3 å¤šç§Ÿæˆ·æ¶æ„çš„æŒ‘æˆ˜

- âš ï¸ **æ•°æ®éš”ç¦»**: ç¡®ä¿ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
- âš ï¸ **æ€§èƒ½å½±å“**: å¤§é‡ç§Ÿæˆ·å¯èƒ½å½±å“æ€§èƒ½
- âš ï¸ **å®‰å…¨é£é™©**: éœ€è¦ä¸¥æ ¼çš„å®‰å…¨ç­–ç•¥
- âš ï¸ **å®šåˆ¶åŒ–**: ä¸åŒç§Ÿæˆ·çš„å®šåˆ¶éœ€æ±‚

---

## 2. å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡

### 2.1 æ¶æ„æ¨¡å¼

PostgreSQLæ”¯æŒä¸‰ç§ä¸»è¦çš„å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼ï¼š

#### æ¨¡å¼1ï¼šå…±äº«Schema + RLSï¼ˆæ¨èï¼‰â­

**ç‰¹ç‚¹**:

- æ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€ä¸ªSchema
- ä½¿ç”¨Row Level Security (RLS)å®ç°æ•°æ®éš”ç¦»
- é€šè¿‡`tenant_id`åˆ—åŒºåˆ†ç§Ÿæˆ·

**ä¼˜åŠ¿**:

- âœ… ç®€å•æ˜“å®ç°
- âœ… ç»´æŠ¤æˆæœ¬ä½
- âœ… PostgreSQL 18 RLSæ€§èƒ½ä¼˜åŒ–æ˜¾è‘—

**é€‚ç”¨åœºæ™¯**:

- ç§Ÿæˆ·æ•°é‡ï¼š1000+
- æ•°æ®é‡ï¼šä¸­ç­‰
- å®šåˆ¶åŒ–éœ€æ±‚ï¼šä½

#### æ¨¡å¼2ï¼šç‹¬ç«‹Schema

**ç‰¹ç‚¹**:

- æ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„Schema
- é€šè¿‡`search_path`åŠ¨æ€åˆ‡æ¢Schema

**ä¼˜åŠ¿**:

- âœ… æ•°æ®éš”ç¦»æ›´å½»åº•
- âœ… æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„å®šåˆ¶

**åŠ£åŠ¿**:

- âŒ Schemaæ•°é‡é™åˆ¶ï¼ˆPostgreSQLé»˜è®¤10000ä¸ªï¼‰
- âŒ ç®¡ç†å¤æ‚åº¦é«˜

**é€‚ç”¨åœºæ™¯**:

- ç§Ÿæˆ·æ•°é‡ï¼š<1000
- æ•°æ®é‡ï¼šå¤§
- å®šåˆ¶åŒ–éœ€æ±‚ï¼šé«˜

#### æ¨¡å¼3ï¼šç‹¬ç«‹æ•°æ®åº“

**ç‰¹ç‚¹**:

- æ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“

**ä¼˜åŠ¿**:

- âœ… æ•°æ®éš”ç¦»æœ€å½»åº•
- âœ… æ”¯æŒå®Œå…¨ç‹¬ç«‹çš„é…ç½®

**åŠ£åŠ¿**:

- âŒ èµ„æºæ¶ˆè€—å¤§
- âŒ ç®¡ç†å¤æ‚åº¦æœ€é«˜

**é€‚ç”¨åœºæ™¯**:

- ç§Ÿæˆ·æ•°é‡ï¼š<100
- æ•°æ®é‡ï¼šè¶…å¤§
- åˆè§„æ€§è¦æ±‚ï¼šæé«˜

---

## 3. ç§Ÿæˆ·éš”ç¦»ç­–ç•¥

### 3.1 RLSç­–ç•¥ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

#### 3.1.1 åŸºç¡€RLSå®ç°

```sql
-- åˆ›å»ºè¡¨ï¼ŒåŒ…å«tenant_id
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    customer_id BIGINT,
    amount NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•ï¼ˆé‡è¦ï¼šæå‡RLSæ€§èƒ½ï¼‰
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);

-- å¯ç”¨RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç§Ÿæˆ·éš”ç¦»ç­–ç•¥
CREATE POLICY tenant_isolation ON orders
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::INT);

-- è®¾ç½®ç§Ÿæˆ·IDï¼ˆåº”ç”¨å±‚è®¾ç½®ï¼‰
SET app.tenant_id = '1001';
SELECT * FROM orders;  -- è‡ªåŠ¨è¿‡æ»¤ï¼Œåªè¿”å›ç§Ÿæˆ·1001çš„æ•°æ®
```

#### 3.1.2 PostgreSQL 18 RLSæ€§èƒ½ä¼˜åŒ–

PostgreSQL 18å¯¹RLSè¿›è¡Œäº†é‡å¤§æ€§èƒ½ä¼˜åŒ–ï¼š

- **ç­–ç•¥ä¸‹æ¨**: ç­–ç•¥è®¡ç®—ä¸‹æ¨åˆ°æŸ¥è¯¢æ‰§è¡Œå±‚
- **ç­–ç•¥ç¼“å­˜**: ç­–ç•¥ç»“æœç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
- **æ€§èƒ½æå‡**: æŸ¥è¯¢æ—¶é—´é™ä½20-50%

```sql
-- PostgreSQL 18è‡ªåŠ¨ä¼˜åŒ–RLSç­–ç•¥
-- æ— éœ€é¢å¤–é…ç½®ï¼Œæ€§èƒ½è‡ªåŠ¨æå‡
```

#### 3.1.3 é«˜çº§RLSç­–ç•¥

```sql
-- æ”¯æŒå¤æ‚æ¡ä»¶çš„ç­–ç•¥
CREATE POLICY tenant_isolation_advanced ON orders
    FOR ALL
    USING (
        tenant_id = current_setting('app.tenant_id')::INT
        AND status != 'deleted'  -- é¢å¤–æ¡ä»¶
    );

-- æ”¯æŒä¸åŒæ“ä½œçš„ç­–ç•¥
CREATE POLICY tenant_select ON orders
    FOR SELECT
    USING (tenant_id = current_setting('app.tenant_id')::INT);

CREATE POLICY tenant_insert ON orders
    FOR INSERT
    WITH CHECK (tenant_id = current_setting('app.tenant_id')::INT);
```

### 3.2 Schemaéš”ç¦»

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºSchema
CREATE SCHEMA tenant_1001;
CREATE SCHEMA tenant_1002;

-- åœ¨Schemaä¸­åˆ›å»ºè¡¨
CREATE TABLE tenant_1001.orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT,
    amount NUMERIC(10,2)
);

-- åŠ¨æ€åˆ‡æ¢Schema
SET search_path TO tenant_1001;
SELECT * FROM orders;  -- è‡ªåŠ¨è®¿é—®tenant_1001.orders
```

### 3.3 æ•°æ®åº“éš”ç¦»

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºæ•°æ®åº“
CREATE DATABASE tenant_1001;
CREATE DATABASE tenant_1002;

-- è¿æ¥åˆ°ç‰¹å®šç§Ÿæˆ·æ•°æ®åº“
\c tenant_1001
```

---

## 4. å¤šç§Ÿæˆ·æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- tenant_idå¿…é¡»å»ºç«‹ç´¢å¼•
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);

-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_orders_tenant_status ON orders(tenant_id, status);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆé’ˆå¯¹æ´»è·ƒç§Ÿæˆ·ï¼‰
CREATE INDEX idx_orders_active_tenant
ON orders(tenant_id, created_at)
WHERE status = 'active';
```

### 4.2 è¿æ¥æ± ä¼˜åŒ–

```sql
-- ä½¿ç”¨PgBounceræˆ–Pgpool-II
-- é…ç½®è¿æ¥æ± å‚æ•°
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

### 4.3 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
PREPARE get_orders(INT) AS
SELECT * FROM orders
WHERE tenant_id = $1
AND created_at > NOW() - INTERVAL '30 days';

EXECUTE get_orders(1001);

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆé’ˆå¯¹æŠ¥è¡¨æŸ¥è¯¢ï¼‰
CREATE MATERIALIZED VIEW mv_tenant_stats AS
SELECT
    tenant_id,
    COUNT(*) as order_count,
    SUM(amount) as total_amount
FROM orders
GROUP BY tenant_id;

CREATE UNIQUE INDEX ON mv_tenant_stats(tenant_id);
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_tenant_stats;
```

### 4.4 PostgreSQL 18æ€§èƒ½ç‰¹æ€§

```sql
-- å†…ç½®è¿æ¥æ± ï¼ˆpg_stat_activityå¢å¼ºï¼‰
-- è‡ªåŠ¨æŸ¥è¯¢ä¼˜åŒ–
-- RLSæ€§èƒ½æå‡ï¼ˆè‡ªåŠ¨ï¼‰
```

---

## 5. å¤šç§Ÿæˆ·å®‰å…¨ç®¡ç†

### 5.1 ç§Ÿæˆ·è®¤è¯

```sql
-- ä½¿ç”¨è§’è‰²æ˜ å°„ç§Ÿæˆ·
CREATE ROLE tenant_1001;
CREATE ROLE tenant_1002;

-- æˆäºˆæƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON orders TO tenant_1001;

-- åº”ç”¨å±‚è®¤è¯åè®¾ç½®è§’è‰²
SET ROLE tenant_1001;
```

### 5.2 å®¡è®¡æ—¥å¿—

```sql
-- å¯ç”¨å®¡è®¡æ—¥å¿—
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';

-- ä½¿ç”¨pgAuditæ‰©å±•ï¼ˆæ¨èï¼‰
CREATE EXTENSION pgaudit;
ALTER DATABASE mydb SET pgaudit.log = 'all';
```

### 5.3 æ•°æ®åŠ å¯†

```sql
-- ä½¿ç”¨é€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰
-- PostgreSQL 15+æ”¯æŒ

-- ä½¿ç”¨åˆ—çº§åŠ å¯†
CREATE EXTENSION pgcrypto;

CREATE TABLE sensitive_data (
    id SERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    encrypted_data BYTEA
);

-- åŠ å¯†å­˜å‚¨
INSERT INTO sensitive_data (tenant_id, encrypted_data)
VALUES (1001, pgp_sym_encrypt('sensitive data', 'encryption_key'));
```

---

## 6. å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹è®¾è®¡

### 6.1 æ•°æ®æ¨¡å‹æ¨¡å¼

#### æ¨¡å¼1ï¼šå…±äº«è¡¨ + tenant_id

```sql
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    customer_id BIGINT,
    amount NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€å¼ è¡¨
-- é€šè¿‡tenant_idåŒºåˆ†
```

#### æ¨¡å¼2ï¼šç§Ÿæˆ·ç‰¹å®šè¡¨

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºè¡¨
CREATE TABLE orders_1001 (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT,
    amount NUMERIC(10,2)
);

CREATE TABLE orders_1002 (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT,
    amount NUMERIC(10,2)
);
```

### 6.2 æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ

```sql
-- 1. tenant_idå¿…é¡»NOT NULL
CREATE TABLE orders (
    tenant_id INT NOT NULL,
    ...
);

-- 2. tenant_idå»ºç«‹ç´¢å¼•
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);

-- 3. å¤–é”®çº¦æŸåŒ…å«tenant_id
CREATE TABLE order_items (
    item_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    tenant_id INT NOT NULL,
    FOREIGN KEY (order_id, tenant_id)
        REFERENCES orders(order_id, tenant_id)
);
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ¶æ„é€‰æ‹©

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | åŸå›  |
| --- | --- | --- |
| ç§Ÿæˆ·æ•° < 100 | ç‹¬ç«‹æ•°æ®åº“ | æ•°æ®éš”ç¦»æœ€å½»åº• |
| ç§Ÿæˆ·æ•° 100-1000 | ç‹¬ç«‹Schema | å¹³è¡¡éš”ç¦»å’Œç®¡ç† |
| ç§Ÿæˆ·æ•° > 1000 | å…±äº«Schema + RLS | æˆæœ¬æ•ˆç›Šæœ€é«˜ |

### 7.2 æ€§èƒ½ä¼˜åŒ–

- âœ… **ç´¢å¼•ä¼˜åŒ–**: tenant_idå¿…é¡»å»ºç«‹ç´¢å¼•
- âœ… **è¿æ¥æ± **: ä½¿ç”¨PgBounceræˆ–Pgpool-II
- âœ… **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… **ç‰©åŒ–è§†å›¾**: é’ˆå¯¹æŠ¥è¡¨æŸ¥è¯¢ä½¿ç”¨ç‰©åŒ–è§†å›¾

### 7.3 å®‰å…¨ç®¡ç†

- âœ… **RLSç­–ç•¥**: æ‰€æœ‰è¡¨å¯ç”¨RLS
- âœ… **å®¡è®¡æ—¥å¿—**: å¯ç”¨å®Œæ•´çš„å®¡è®¡æ—¥å¿—
- âœ… **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- âœ… **æƒé™æ§åˆ¶**: ä¸¥æ ¼çš„æƒé™æ§åˆ¶

### 7.4 ç›‘æ§ä¸å‘Šè­¦

```sql
-- ç›‘æ§ç§Ÿæˆ·æ•°æ®é‡
SELECT
    tenant_id,
    COUNT(*) as row_count,
    pg_size_pretty(pg_total_relation_size('orders')) as table_size
FROM orders
GROUP BY tenant_id
ORDER BY row_count DESC;

-- ç›‘æ§ç§Ÿæˆ·æŸ¥è¯¢æ€§èƒ½
SELECT
    tenant_id,
    COUNT(*) as query_count,
    AVG(execution_time) as avg_time
FROM pg_stat_statements
WHERE query LIKE '%orders%'
GROUP BY tenant_id;
```

---

## 8. å‚è€ƒæ¡ˆä¾‹

### 8.1 å®æˆ˜æ¡ˆä¾‹

- **[19-å®æˆ˜æ¡ˆä¾‹/04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ](../19-å®æˆ˜æ¡ˆä¾‹/04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ/README.md)**
  - å®Œæ•´çš„å¤šç§Ÿæˆ·SaaSç³»ç»Ÿå®ç°
  - åŒ…å«RLSç­–ç•¥ã€æ•°æ®éš”ç¦»æ–¹æ¡ˆ
  - PostgreSQL 18ç‰¹æ€§åº”ç”¨

### 8.2 ç›¸å…³æ–‡æ¡£

- [05-å®‰å…¨ä¸åˆè§„/å®‰å…¨åŠ å›º](../05-å®‰å…¨ä¸åˆè§„/å®‰å…¨åŠ å›º/README.md) - å®‰å…¨åŠ å›ºæŒ‡å—
- [12-ç›‘æ§ä¸è¯Šæ–­](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•
- [èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†](./èµ„æºéš”ç¦»ä¸é…é¢ç®¡ç†.md) - èµ„æºç®¡ç†

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
**å‚è€ƒ**: 19-å®æˆ˜æ¡ˆä¾‹/04-å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ
