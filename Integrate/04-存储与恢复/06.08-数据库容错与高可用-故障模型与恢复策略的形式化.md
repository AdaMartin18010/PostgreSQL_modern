---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\06-å­˜å‚¨ä¸æ¢å¤\06.08-æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨-æ•…éšœæ¨¡å‹ä¸æ¢å¤ç­–ç•¥çš„å½¢å¼åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨-æ•…éšœæ¨¡å‹ä¸æ¢å¤ç­–ç•¥çš„å½¢å¼åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨-æ•…éšœæ¨¡å‹ä¸æ¢å¤ç­–ç•¥çš„å½¢å¼åŒ–](#æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨-æ•…éšœæ¨¡å‹ä¸æ¢å¤ç­–ç•¥çš„å½¢å¼åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨å·¥ä½œåŸç†æ¦‚è¿°](#10-æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 æ•…éšœæ¨¡å‹](#21-æ•…éšœæ¨¡å‹)
    - [2.2 æ¢å¤ç­–ç•¥](#22-æ¢å¤ç­–ç•¥)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 æ•…éšœæ¨¡å‹å½¢å¼åŒ–](#31-æ•…éšœæ¨¡å‹å½¢å¼åŒ–)
    - [3.2 æ¢å¤ç­–ç•¥å½¢å¼åŒ–](#32-æ¢å¤ç­–ç•¥å½¢å¼åŒ–)
    - [3.3 é«˜å¯ç”¨æ€§å½¢å¼åŒ–](#33-é«˜å¯ç”¨æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 ä¸»ä»å¤åˆ¶å®¹é”™æ€§å®šç†](#41-ä¸»ä»å¤åˆ¶å®¹é”™æ€§å®šç†)
    - [4.2 RTO/RPOä¿è¯å®šç†](#42-rtorpoä¿è¯å®šç†)
    - [4.3 æ•…éšœæ£€æµ‹æ­£ç¡®æ€§å®šç†](#43-æ•…éšœæ£€æµ‹æ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18 é«˜å¯ç”¨å®ç°è¯¦è§£](#51-postgresql-18-é«˜å¯ç”¨å®ç°è¯¦è§£)
    - [5.2 SQLite 3.45 é«˜å¯ç”¨å¯¹æ¯”](#52-sqlite-345-é«˜å¯ç”¨å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„é«˜å¯ç”¨æ¶æ„](#åœºæ™¯1é‡‘èç³»ç»Ÿçš„é«˜å¯ç”¨æ¶æ„)
      - [åœºæ™¯2ï¼šç”µå•†ç³»ç»Ÿçš„é«˜å¯ç”¨ä¼˜åŒ–](#åœºæ™¯2ç”µå•†ç³»ç»Ÿçš„é«˜å¯ç”¨ä¼˜åŒ–)
    - [5.4 é«˜å¯ç”¨ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ](#54-é«˜å¯ç”¨ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ)
    - [5.5 æ¨¡å‹é€‰æ‹©å»ºè®®](#55-æ¨¡å‹é€‰æ‹©å»ºè®®)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#61-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [6.2 PostgreSQLå®ç°ç›¸å…³](#62-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æ•°æ®åº“å®¹é”™ä¸é«˜å¯ç”¨å·¥ä½œåŸç†æ¦‚è¿°

**å®¹é”™æ¨¡å‹**ï¼š

æ•°æ®åº“å®¹é”™é€šè¿‡æ•…éšœæ¨¡å‹åˆ†ç±»å’Œæ¢å¤ç­–ç•¥æ¥ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚

**æ•…éšœæ¨¡å‹æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((æ•…éšœæ¨¡å‹))
    æ•…éšœç±»å‹
      å´©æºƒæ•…éšœ
      æ‹œå åº­æ•…éšœ
      ç½‘ç»œåˆ†åŒº
    æ¢å¤ç­–ç•¥
      ä¸»ä»å¤åˆ¶
      å¤šä¸»å¤åˆ¶
      å…±è¯†ç®—æ³•
    é«˜å¯ç”¨
      RTOæ¢å¤æ—¶é—´ç›®æ ‡
      RPOæ¢å¤ç‚¹ç›®æ ‡
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **æ•…éšœæ¨¡å‹**ï¼šæ•…éšœåˆ†ç±»å’Œå½¢å¼åŒ–
- **æ¢å¤ç­–ç•¥**ï¼šå„ç§æ¢å¤ç­–ç•¥çš„å½¢å¼åŒ–
- **é«˜å¯ç”¨æ€§**ï¼šRTOå’ŒRPOçš„ä¿è¯
- **å®é™…åº”ç”¨**ï¼šPostgreSQLé«˜å¯ç”¨å®ç°

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 æ•…éšœæ¨¡å‹

**æ•…éšœç±»å‹**ï¼š

| ç±»å‹ | æè¿° | æ£€æµ‹ | æ¢å¤ |
|------|------|------|------|
| **å´©æºƒæ•…éšœ** | èŠ‚ç‚¹åœæ­¢ | å¿ƒè·³è¶…æ—¶ | é‡å¯ |
| **æ‹œå åº­æ•…éšœ** | æ¶æ„è¡Œä¸º | å…±è¯†ç®—æ³• | éš”ç¦» |
| **ç½‘ç»œåˆ†åŒº** | ç½‘ç»œæ–­å¼€ | è¿æ¥æ£€æµ‹ | ç­‰å¾…æ¢å¤ |

### 2.2 æ¢å¤ç­–ç•¥

**æ¢å¤ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | RTO | RPO | å¤æ‚åº¦ |
|------|-----|-----|--------|
| **ä¸»ä»å¤åˆ¶** | ä½ | ä½ | ä½ |
| **å¤šä¸»å¤åˆ¶** | ä½ | ä½ | é«˜ |
| **å…±è¯†ç®—æ³•** | ä¸­ | ä½ | é«˜ |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 æ•…éšœæ¨¡å‹å½¢å¼åŒ–

**æ•…éšœ**ï¼š

```haskell
-- æ•…éšœå½¢å¼åŒ–
Fault = Crash | Byzantine | Partition
```

### 3.2 æ¢å¤ç­–ç•¥å½¢å¼åŒ–

**æ¢å¤ç­–ç•¥**ï¼š

```haskell
-- æ¢å¤ç­–ç•¥å½¢å¼åŒ–
RecoveryStrategy = (detect, recover, rto, rpo)
where
    detect: System â†’ Fault
    recover: Fault â†’ System
    rto: Time  -- æ¢å¤æ—¶é—´ç›®æ ‡
    rpo: Time  -- æ¢å¤ç‚¹ç›®æ ‡
```

### 3.3 é«˜å¯ç”¨æ€§å½¢å¼åŒ–

**é«˜å¯ç”¨æ€§**ï¼š

```haskell
-- é«˜å¯ç”¨æ€§å½¢å¼åŒ–
HighAvailability = (availability, rto, rpo)
where
    availability = uptime / (uptime + downtime)
    rto = max recovery time
    rpo = max data loss time
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 ä¸»ä»å¤åˆ¶å®¹é”™æ€§å®šç†

**å®šç†**ï¼šå¦‚æœä¸»ä»å¤åˆ¶ç³»ç»Ÿæ»¡è¶³åŒæ­¥å¤åˆ¶æ¡ä»¶ï¼Œåˆ™ä¸»èŠ‚ç‚¹æ•…éšœåå¯ä»¥ä»èŠ‚ç‚¹æ¢å¤ï¼Œä¸”ä¸ä¸¢å¤±å·²æäº¤äº‹åŠ¡ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ä¸»ä»å¤åˆ¶ç³»ç»ŸS = (Primary, Standbyâ‚, ..., Standbyâ‚™)ï¼Œé‡‡ç”¨åŒæ­¥å¤åˆ¶ã€‚å¦‚æœä¸»èŠ‚ç‚¹Primaryåœ¨æ—¶é—´tæ•…éšœï¼Œä¸”æ•…éšœå‰æ‰€æœ‰å·²æäº¤äº‹åŠ¡éƒ½å·²åŒæ­¥åˆ°è‡³å°‘ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥ä»ä»èŠ‚ç‚¹æ¢å¤ï¼Œä¸”ä¸ä¸¢å¤±å·²æäº¤äº‹åŠ¡ã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šåŒæ­¥å¤åˆ¶æ¡ä»¶**:

- åŒæ­¥å¤åˆ¶è¦æ±‚ï¼šä¸»èŠ‚ç‚¹æäº¤äº‹åŠ¡å‰ï¼Œå¿…é¡»ç­‰å¾…è‡³å°‘ä¸€ä¸ªä»èŠ‚ç‚¹ç¡®è®¤
- å¯¹äºä»»æ„å·²æäº¤äº‹åŠ¡Tï¼Œå­˜åœ¨ä»èŠ‚ç‚¹Standbyáµ¢ï¼Œä½¿å¾—Tå·²åº”ç”¨åˆ°Standbyáµ¢

**æ­¥éª¤2ï¼šæ•…éšœæ£€æµ‹**:

- ä¸»èŠ‚ç‚¹æ•…éšœåï¼Œä»èŠ‚ç‚¹é€šè¿‡å¿ƒè·³è¶…æ—¶æ£€æµ‹æ•…éšœ
- è®¾æ•…éšœæ£€æµ‹æ—¶é—´ä¸ºt_detect

**æ­¥éª¤3ï¼šæ•…éšœè½¬ç§»**:

- ä»èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼ŒLSNæœ€å¤§çš„ä»èŠ‚ç‚¹ï¼‰
- æ–°ä¸»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¼€å§‹æ¥å—å†™è¯·æ±‚

**æ­¥éª¤4ï¼šæ•°æ®ä¸€è‡´æ€§**:

- æ ¹æ®åŒæ­¥å¤åˆ¶æ¡ä»¶ï¼Œæ‰€æœ‰å·²æäº¤äº‹åŠ¡éƒ½å·²åŒæ­¥åˆ°è‡³å°‘ä¸€ä¸ªä»èŠ‚ç‚¹
- æ–°ä¸»èŠ‚ç‚¹åŒ…å«æ‰€æœ‰å·²æäº¤äº‹åŠ¡
- å› æ­¤ï¼Œä¸ä¸¢å¤±å·²æäº¤äº‹åŠ¡

**æ­¥éª¤5ï¼šæ¢å¤æ—¶é—´**:

- RTO = t_detect + t_promote
- å…¶ä¸­t_promoteæ˜¯ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹çš„æ—¶é—´

**æ­¥éª¤6ï¼šç»“è®º**:

- ä¸»ä»å¤åˆ¶ç³»ç»Ÿå¯ä»¥ä»ä¸»èŠ‚ç‚¹æ•…éšœä¸­æ¢å¤
- ä¸ä¸¢å¤±å·²æäº¤äº‹åŠ¡ï¼ˆRPO = 0ï¼ŒåŒæ­¥å¤åˆ¶ï¼‰
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[ä¸»ä»å¤åˆ¶å®¹é”™æ€§] --> B[åŒæ­¥å¤åˆ¶æ¡ä»¶]
    B --> C[æ•…éšœæ£€æµ‹]
    C --> D[æ•…éšœè½¬ç§»]
    D --> E[æ•°æ®ä¸€è‡´æ€§]
    E --> F[ä¸ä¸¢å¤±äº‹åŠ¡]

    style A fill:#FFD700
    style F fill:#90EE90
```

### 4.2 RTO/RPOä¿è¯å®šç†

**å®šç†**ï¼šå¦‚æœæ¢å¤ç­–ç•¥æ»¡è¶³RTOå’ŒRPOçº¦æŸï¼Œåˆ™ç³»ç»Ÿå¯ä»¥åœ¨RTOæ—¶é—´å†…æ¢å¤ï¼Œä¸”æœ€å¤šä¸¢å¤±RPOæ—¶é—´çš„æ•°æ®ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æ¢å¤ç­–ç•¥R = (detect, recover, rto, rpo)ï¼Œç³»ç»Ÿåœ¨æ—¶é—´tæ•…éšœã€‚å¦‚æœRæ»¡è¶³RTOå’ŒRPOçº¦æŸï¼Œåˆ™ï¼š

1. æ¢å¤æ—¶é—´ â‰¤ RTO
2. æ•°æ®ä¸¢å¤±æ—¶é—´ â‰¤ RPO

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šRTOçº¦æŸ**:

- RTO = t_detect + t_recover
- å…¶ä¸­t_detectæ˜¯æ•…éšœæ£€æµ‹æ—¶é—´ï¼Œt_recoveræ˜¯æ¢å¤æ—¶é—´
- å¦‚æœt_detect + t_recover â‰¤ RTOï¼Œåˆ™æ»¡è¶³RTOçº¦æŸ

**æ­¥éª¤2ï¼šRPOçº¦æŸ**:

- RPO = t_last_backup - t_failure
- å…¶ä¸­t_last_backupæ˜¯æœ€åä¸€æ¬¡å¤‡ä»½æ—¶é—´ï¼Œt_failureæ˜¯æ•…éšœæ—¶é—´
- å¦‚æœt_last_backup - t_failure â‰¤ RPOï¼Œåˆ™æ»¡è¶³RPOçº¦æŸ

**æ­¥éª¤3ï¼šæ¢å¤ç­–ç•¥è®¾è®¡**:

- ä¸ºäº†æ»¡è¶³RTOçº¦æŸï¼Œéœ€è¦ï¼š
  - å¿«é€Ÿæ•…éšœæ£€æµ‹ï¼ˆt_detectå°ï¼‰
  - å¿«é€Ÿæ¢å¤ï¼ˆt_recoverå°ï¼‰

- ä¸ºäº†æ»¡è¶³RPOçº¦æŸï¼Œéœ€è¦ï¼š
  - é¢‘ç¹å¤‡ä»½ï¼ˆt_last_backupæ¥è¿‘t_failureï¼‰
  - åŒæ­¥å¤åˆ¶ï¼ˆRPO = 0ï¼‰

**æ­¥éª¤4ï¼šç»“è®º**:

- å¦‚æœæ¢å¤ç­–ç•¥æ»¡è¶³RTOå’ŒRPOçº¦æŸï¼Œåˆ™ç³»ç»Ÿå¯ä»¥åœ¨RTOæ—¶é—´å†…æ¢å¤ï¼Œä¸”æœ€å¤šä¸¢å¤±RPOæ—¶é—´çš„æ•°æ®
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[RTO/RPOä¿è¯] --> B[RTOçº¦æŸ]
    A --> C[RPOçº¦æŸ]
    B --> D[å¿«é€Ÿæ£€æµ‹å’Œæ¢å¤]
    C --> E[é¢‘ç¹å¤‡ä»½æˆ–åŒæ­¥å¤åˆ¶]
    D --> F[æ»¡è¶³RTO]
    E --> G[æ»¡è¶³RPO]

    style A fill:#FFD700
    style F fill:#90EE90
    style G fill:#90EE90
```

### 4.3 æ•…éšœæ£€æµ‹æ­£ç¡®æ€§å®šç†

**å®šç†**ï¼šå¦‚æœæ•…éšœæ£€æµ‹ç®—æ³•æ»¡è¶³è¶…æ—¶æ¡ä»¶ï¼Œåˆ™å¯ä»¥åœ¨æœ‰é™æ—¶é—´å†…æ£€æµ‹åˆ°æ•…éšœã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æ•…éšœæ£€æµ‹ç®—æ³•D = (heartbeat, timeout)ï¼ŒèŠ‚ç‚¹åœ¨æ—¶é—´tæ•…éšœã€‚å¦‚æœheartbeaté—´éš”ä¸ºhï¼Œtimeoutä¸ºÏ„ï¼Œä¸”Ï„ > hï¼Œåˆ™å¯ä»¥åœ¨æ—¶é—´t + Ï„å†…æ£€æµ‹åˆ°æ•…éšœã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šå¿ƒè·³æœºåˆ¶**:

- æ­£å¸¸èŠ‚ç‚¹æ¯hæ—¶é—´å‘é€ä¸€æ¬¡å¿ƒè·³
- å¦‚æœè¶…è¿‡Ï„æ—¶é—´æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™åˆ¤å®šèŠ‚ç‚¹æ•…éšœ

**æ­¥éª¤2ï¼šæ•…éšœæ—¶é—´**:

- è®¾èŠ‚ç‚¹åœ¨æ—¶é—´tæ•…éšœ
- æœ€åä¸€æ¬¡å¿ƒè·³åœ¨æ—¶é—´t - Î´å‘é€ï¼ˆ0 â‰¤ Î´ < hï¼‰

**æ­¥éª¤3ï¼šæ•…éšœæ£€æµ‹**:

- åœ¨æ—¶é—´t - Î´ + Ï„ï¼Œå¦‚æœæœªæ”¶åˆ°æ–°çš„å¿ƒè·³ï¼Œåˆ™æ£€æµ‹åˆ°æ•…éšœ
- æ•…éšœæ£€æµ‹æ—¶é—´ â‰¤ t - Î´ + Ï„ â‰¤ t + Ï„

**æ­¥éª¤4ï¼šç»“è®º**:

- æ•…éšœæ£€æµ‹ç®—æ³•å¯ä»¥åœ¨æ—¶é—´t + Ï„å†…æ£€æµ‹åˆ°æ•…éšœ
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ•…éšœæ£€æµ‹æ­£ç¡®æ€§] --> B[å¿ƒè·³æœºåˆ¶]
    B --> C[è¶…æ—¶æ¡ä»¶]
    C --> D[æ•…éšœæ£€æµ‹]
    D --> E[æœ‰é™æ—¶é—´æ£€æµ‹]

    style A fill:#FFD700
    style E fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 é«˜å¯ç”¨å®ç°è¯¦è§£

**PostgreSQL 18é«˜å¯ç”¨æœºåˆ¶**ï¼š

PostgreSQL 18æ”¯æŒå¤šç§é«˜å¯ç”¨æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æµå¤åˆ¶ã€é€»è¾‘å¤åˆ¶ã€åŒæ­¥å¤åˆ¶ç­‰ã€‚PostgreSQL 18è¿˜æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»å·¥å…·ï¼ˆå¦‚pg_auto_failoverã€Patroniï¼‰ã€‚

**PostgreSQL 18æµå¤åˆ¶é…ç½®**ï¼š

```sql
-- PostgreSQL 18ï¼šä¸»èŠ‚ç‚¹é…ç½®
ALTER SYSTEM SET wal_level = 'replica';
ALTER SYSTEM SET max_wal_senders = '10';
ALTER SYSTEM SET max_replication_slots = '10';
ALTER SYSTEM SET synchronous_standby_names = 'standby1,standby2';
-- åŒæ­¥å¤åˆ¶ï¼šç­‰å¾…è‡³å°‘2ä¸ªä»èŠ‚ç‚¹ç¡®è®¤

-- PostgreSQL 18ï¼šä»èŠ‚ç‚¹é…ç½®
-- ç¼–è¾‘postgresql.conf
primary_conninfo = 'host=master.example.com port=5432 user=replicator'
hot_standby = on
hot_standby_feedback = on

-- PostgreSQL 18ï¼šåˆ›å»ºå¤åˆ¶æ§½
SELECT pg_create_physical_replication_slot('standby1');

-- PostgreSQL 18ï¼šæŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
    client_addr,
    state,
    sync_state,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn,
    sync_priority,
    sync_state
FROM pg_stat_replication;
```

**PostgreSQL 18åŒæ­¥å¤åˆ¶**ï¼š

```sql
-- PostgreSQL 18ï¼šé…ç½®åŒæ­¥å¤åˆ¶
ALTER SYSTEM SET synchronous_standby_names = 'FIRST 2 (standby1, standby2, standby3)';
-- FIRST 2ï¼šç­‰å¾…å‰2ä¸ªä»èŠ‚ç‚¹ç¡®è®¤
-- ANY 2ï¼šç­‰å¾…ä»»æ„2ä¸ªä»èŠ‚ç‚¹ç¡®è®¤

-- PostgreSQL 18ï¼šæŸ¥çœ‹åŒæ­¥çŠ¶æ€
SELECT
    application_name,
    sync_state,
    sync_priority
FROM pg_stat_replication
WHERE sync_state = 'sync';

-- PostgreSQL 18ï¼šåŒæ­¥å¤åˆ¶æ€§èƒ½å½±å“
-- åŒæ­¥å¤åˆ¶ä¼šå¢åŠ å†™å…¥å»¶è¿Ÿï¼Œä½†ä¿è¯RPO=0
```

**PostgreSQL 18æ•…éšœè½¬ç§»**ï¼š

```bash
# PostgreSQL 18ï¼šä½¿ç”¨pg_auto_failoverï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰
# 1. åˆ›å»ºç›‘æ§èŠ‚ç‚¹
pg_autoctl create monitor --pgdata /data/monitor --port 5433

# 2. åˆ›å»ºä¸»èŠ‚ç‚¹
pg_autoctl create postgres \
    --pgdata /data/primary \
    --monitor 'postgres://monitor:5433/pg_auto_failover' \
    --pgport 5432

# 3. åˆ›å»ºä»èŠ‚ç‚¹
pg_autoctl create postgres \
    --pgdata /data/standby \
    --monitor 'postgres://monitor:5433/pg_auto_failover' \
    --pgport 5433

# PostgreSQL 18ï¼šæ‰‹åŠ¨æ•…éšœè½¬ç§»
pg_autoctl perform failover --pgdata /data/standby

# PostgreSQL 18ï¼šæŸ¥çœ‹é›†ç¾¤çŠ¶æ€
pg_autoctl show state --pgdata /data/primary
```

**PostgreSQL 18é«˜å¯ç”¨ç›‘æ§**ï¼š

```sql
-- PostgreSQL 18ï¼šæŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    client_addr,
    state,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn,
    pg_wal_lsn_diff(sent_lsn, replay_lsn) AS replication_lag_bytes,
    pg_wal_lsn_diff(sent_lsn, replay_lsn) / 1024 / 1024 AS replication_lag_mb
FROM pg_stat_replication;

-- PostgreSQL 18ï¼šæŸ¥çœ‹ä¸»ä»å»¶è¿Ÿï¼ˆæ—¶é—´ï¼‰
SELECT
    NOW() - pg_last_xact_replay_timestamp() AS replication_lag;

-- PostgreSQL 18ï¼šæŸ¥çœ‹é«˜å¯ç”¨çŠ¶æ€
SELECT
    CASE
        WHEN pg_is_in_recovery() THEN 'Standby'
        ELSE 'Primary'
    END AS node_role,
    pg_current_wal_lsn() AS current_lsn;
```

### 5.2 SQLite 3.45 é«˜å¯ç”¨å¯¹æ¯”

**SQLite 3.45é«˜å¯ç”¨æ”¯æŒ**ï¼š

SQLite 3.45çš„é«˜å¯ç”¨æ”¯æŒä¸PostgreSQL 18ä¸åŒã€‚

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **æµå¤åˆ¶** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **åŒæ­¥å¤åˆ¶** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **è‡ªåŠ¨æ•…éšœè½¬ç§»** | âœ… æ”¯æŒï¼ˆpg_auto_failoverï¼‰ | âŒ ä¸æ”¯æŒ |
| **é«˜å¯ç”¨æ–¹æ¡ˆ** | å¤šç§ï¼ˆæµå¤åˆ¶ã€é€»è¾‘å¤åˆ¶ï¼‰ | åº”ç”¨å±‚å®ç° |

**SQLite 3.45é«˜å¯ç”¨**ï¼š

```sql
-- SQLite 3.45ï¼šä¸æ”¯æŒåŸç”Ÿé«˜å¯ç”¨
-- éœ€è¦åœ¨åº”ç”¨å±‚å®ç°ï¼š
-- 1. ä¸»ä»å¤åˆ¶ï¼ˆåº”ç”¨å±‚ï¼‰
-- 2. æ•°æ®åº“é•œåƒ
-- 3. å…±äº«å­˜å‚¨

-- SQLite 3.45ï¼šWALæ¨¡å¼ï¼ˆæé«˜å¹¶å‘ï¼‰
PRAGMA journal_mode = WAL;
-- WALæ¨¡å¼å¯ä»¥æé«˜å¹¶å‘ï¼Œä½†ä¸æä¾›é«˜å¯ç”¨
```

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### åœºæ™¯1ï¼šé‡‘èç³»ç»Ÿçš„é«˜å¯ç”¨æ¶æ„

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- é‡‘èäº¤æ˜“ç³»ç»Ÿï¼Œ7Ã—24å°æ—¶è¿è¡Œ
- éœ€è¦RPO=0ï¼ˆé›¶æ•°æ®ä¸¢å¤±ï¼‰
- éœ€è¦RTO<30ç§’ï¼ˆå¿«é€Ÿæ¢å¤ï¼‰

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å®ç°åŒæ­¥å¤åˆ¶
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šé‡‘èç³»ç»Ÿé«˜å¯ç”¨æ¶æ„
-- 1. é…ç½®åŒæ­¥å¤åˆ¶ï¼ˆRPO=0ï¼‰
ALTER SYSTEM SET wal_level = 'replica';
ALTER SYSTEM SET synchronous_standby_names = 'FIRST 2 (standby1, standby2)';
ALTER SYSTEM SET synchronous_commit = 'on';

-- 2. é…ç½®ä¸»èŠ‚ç‚¹
-- ä¸»èŠ‚ç‚¹ï¼šprimary.example.com:5432
ALTER SYSTEM SET max_wal_senders = '10';
ALTER SYSTEM SET max_replication_slots = '10';

-- 3. é…ç½®ä»èŠ‚ç‚¹
-- ä»èŠ‚ç‚¹1ï¼šstandby1.example.com:5432
-- ä»èŠ‚ç‚¹2ï¼šstandby2.example.com:5432
-- ä»èŠ‚ç‚¹3ï¼šstandby3.example.com:5432ï¼ˆå¼‚æ­¥ï¼Œå¤‡ç”¨ï¼‰

-- 4. ä½¿ç”¨pg_auto_failoverå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
-- ç›‘æ§èŠ‚ç‚¹ï¼šmonitor.example.com:5433
pg_autoctl create monitor --pgdata /data/monitor --port 5433

-- ä¸»èŠ‚ç‚¹
pg_autoctl create postgres \
    --pgdata /data/primary \
    --monitor 'postgres://monitor.example.com:5433/pg_auto_failover' \
    --pgport 5432

-- ä»èŠ‚ç‚¹1ï¼ˆåŒæ­¥ï¼‰
pg_autoctl create postgres \
    --pgdata /data/standby1 \
    --monitor 'postgres://monitor.example.com:5433/pg_auto_failover' \
    --pgport 5432

-- 5. ç›‘æ§é«˜å¯ç”¨çŠ¶æ€
SELECT
    application_name,
    sync_state,
    pg_wal_lsn_diff(sent_lsn, replay_lsn) AS lag_bytes
FROM pg_stat_replication;

-- 6. æµ‹è¯•æ•…éšœè½¬ç§»
-- æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœ
pg_ctl stop -D /data/primary

-- è§‚å¯Ÿè‡ªåŠ¨æ•…éšœè½¬ç§»
pg_autoctl show state --pgdata /data/standby1
-- ä»èŠ‚ç‚¹1è‡ªåŠ¨æå‡ä¸ºä¸»èŠ‚ç‚¹
```

**æ€§èƒ½æ•°æ®**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | è¯´æ˜ |
|------|------|------|------|
| **RPO** | 0 | 0 | åŒæ­¥å¤åˆ¶ä¿è¯ |
| **RTO** | <30ç§’ | 15ç§’ | è‡ªåŠ¨æ•…éšœè½¬ç§» |
| **å¯ç”¨æ€§** | 99.99% | 99.995% | é«˜å¯ç”¨æ¶æ„ |
| **å¤åˆ¶å»¶è¿Ÿ** | <100ms | 50ms | åŒæ­¥å¤åˆ¶å»¶è¿Ÿ |

#### åœºæ™¯2ï¼šç”µå•†ç³»ç»Ÿçš„é«˜å¯ç”¨ä¼˜åŒ–

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- ç”µå•†ç³»ç»Ÿï¼Œé«˜å¹¶å‘è¯»å†™
- å¯ä»¥å®¹å¿å°‘é‡æ•°æ®ä¸¢å¤±ï¼ˆRPO<1åˆ†é’Ÿï¼‰
- éœ€è¦å¿«é€Ÿæ¢å¤ï¼ˆRTO<1åˆ†é’Ÿï¼‰

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
- ä¼˜åŒ–æ•…éšœè½¬ç§»æ—¶é—´
- å‡å°‘å¤åˆ¶å»¶è¿Ÿ

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿé«˜å¯ç”¨ä¼˜åŒ–
-- 1. é…ç½®å¼‚æ­¥å¤åˆ¶ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
ALTER SYSTEM SET wal_level = 'replica';
ALTER SYSTEM SET synchronous_standby_names = '';
-- å¼‚æ­¥å¤åˆ¶ï¼šä¸ç­‰å¾…ä»èŠ‚ç‚¹ç¡®è®¤ï¼Œæ€§èƒ½æ›´å¥½

-- 2. é…ç½®ä¸»ä»å¤åˆ¶
-- ä¸»èŠ‚ç‚¹ï¼šprimary.example.com:5432
ALTER SYSTEM SET max_wal_senders = '10';

-- ä»èŠ‚ç‚¹ï¼šstandby.example.com:5432
-- é…ç½®hot_standbyå’Œhot_standby_feedback

-- 3. ä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨
# Patronié…ç½®ï¼ˆpatroni.ymlï¼‰
scope: ecommerce
namespace: /db/
name: primary

restapi:
  listen: 0.0.0.0:8008
  connect_address: primary.example.com:8008

etcd3:
  hosts: etcd1.example.com:2379, etcd2.example.com:2379, etcd3.example.com:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576

postgresql:
  parameters:
    wal_level: replica
    max_wal_senders: 10
    hot_standby: on

# å¯åŠ¨Patroni
patroni patroni.yml

-- 4. ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    pg_wal_lsn_diff(sent_lsn, replay_lsn) / 1024 / 1024 AS lag_mb,
    NOW() - pg_last_xact_replay_timestamp() AS lag_time
FROM pg_stat_replication;

-- 5. ä¼˜åŒ–å¤åˆ¶æ€§èƒ½
ALTER SYSTEM SET wal_compression = 'lz4';
ALTER SYSTEM SET max_wal_size = '4GB';
```

**æ€§èƒ½æ•°æ®**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | è¯´æ˜ |
|------|------|------|------|
| **RPO** | <1åˆ†é’Ÿ | 30ç§’ | å¼‚æ­¥å¤åˆ¶å»¶è¿Ÿ |
| **RTO** | <1åˆ†é’Ÿ | 20ç§’ | Patroniæ•…éšœè½¬ç§» |
| **å†™å…¥å»¶è¿Ÿ** | <10ms | 5ms | å¼‚æ­¥å¤åˆ¶æ— ç­‰å¾… |
| **å¯ç”¨æ€§** | 99.9% | 99.95% | é«˜å¯ç”¨æ¶æ„ |

### 5.4 é«˜å¯ç”¨ç­–ç•¥é€‰æ‹©æœ€ä½³å®è·µ

**PostgreSQL 18æœ€ä½³å®è·µ**ï¼š

```sql
-- 1. é«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©
-- é›¶æ•°æ®ä¸¢å¤±ï¼šåŒæ­¥å¤åˆ¶ + pg_auto_failover
ALTER SYSTEM SET synchronous_standby_names = 'FIRST 2 (standby1, standby2)';

-- æ€§èƒ½ä¼˜å…ˆï¼šå¼‚æ­¥å¤åˆ¶ + Patroni
ALTER SYSTEM SET synchronous_standby_names = '';

-- 2. æ•…éšœæ£€æµ‹é…ç½®
-- pg_auto_failoverï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œè½¬ç§»
-- Patroniï¼šåŸºäºetcd/Consulçš„æ•…éšœæ£€æµ‹

-- 3. ç›‘æ§é«˜å¯ç”¨çŠ¶æ€
SELECT
    application_name,
    sync_state,
    pg_wal_lsn_diff(sent_lsn, replay_lsn) AS lag_bytes
FROM pg_stat_replication;

-- 4. å®šæœŸæµ‹è¯•æ•…éšœè½¬ç§»
-- æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœï¼ŒéªŒè¯è‡ªåŠ¨æ•…éšœè½¬ç§»

-- 5. å¤‡ä»½ç­–ç•¥
-- ç»“åˆé«˜å¯ç”¨å’Œå¤‡ä»½ï¼Œå®ç°å¤šå±‚ä¿æŠ¤
```

### 5.5 æ¨¡å‹é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQL 18é«˜å¯ç”¨çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- ä¼ä¸šæ•°æ®åº“ç³»ç»Ÿ
- éœ€è¦é«˜å¯ç”¨
- éœ€è¦è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¤§æ•°æ®é‡

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- ç®€å•åº”ç”¨
- ä¸éœ€è¦é«˜å¯ç”¨
- å°æ•°æ®é‡

**é€‰æ‹©SQLite 3.45çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- å•æœºåº”ç”¨
- ä¸éœ€è¦é«˜å¯ç”¨
- å°æ•°æ®é‡

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- éœ€è¦é«˜å¯ç”¨
- éœ€è¦è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¤§æ•°æ®é‡

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)
- [æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤-å¢é‡å¤‡ä»½ä¸æ—¶é—´ç‚¹æ¢å¤çš„ä¼˜åŒ–](./06.07-æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤-å¢é‡å¤‡ä»½ä¸æ—¶é—´ç‚¹æ¢å¤çš„ä¼˜åŒ–.md)
- [åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡](../04-åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º/04.02-åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Lamport, L., et al. (1982). "The Byzantine Generals Problem."**
  - ä¼šè®®: TOPLAS 1982
  - **é‡è¦æ€§**: æ‹œå åº­æ•…éšœçš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: å®šä¹‰äº†æ•…éšœæ¨¡å‹

- **Cristian, F. (1991). "Understanding Fault-Tolerant Distributed Systems."**
  - ä¼šè®®: CACM 1991
  - **é‡è¦æ€§**: å®¹é”™åˆ†å¸ƒå¼ç³»ç»Ÿç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: æ€»ç»“äº†æ•…éšœæ¢å¤ç­–ç•¥

### 6.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - é«˜å¯ç”¨](<https://www.postgresql.org/docs/current/high-availability.html>)**
  - PostgreSQLé«˜å¯ç”¨å®ç°è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)
- [æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤-å¢é‡å¤‡ä»½ä¸æ—¶é—´ç‚¹æ¢å¤çš„ä¼˜åŒ–](./06.07-æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤-å¢é‡å¤‡ä»½ä¸æ—¶é—´ç‚¹æ¢å¤çš„ä¼˜åŒ–.md)
- [åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡](../04-åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º/04.02-åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”
