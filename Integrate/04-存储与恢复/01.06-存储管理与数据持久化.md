---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/01-æ ¸å¿ƒè¯¾ç¨‹/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.2
> **æœ€åæ›´æ–°**: 2025-01
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å­˜å‚¨ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–ã€I/Oä¼˜åŒ–ã€æ€§èƒ½è°ƒä¼˜ã€é«˜å¯ç”¨è®¾è®¡
> ğŸ†• **PostgreSQL 18å­˜å‚¨æ”¹è¿›**:
>
> - âœ… **å¼‚æ­¥I/Oå­ç³»ç»Ÿ**: I/Oæ€§èƒ½æå‡2-3å€ï¼Œç‰¹åˆ«é€‚ç”¨äºå‘é‡æ£€ç´¢ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰
> - âœ… **å¢é‡å¤‡ä»½**: èŠ‚çœ94%æ—¶é—´ï¼ŒWALæ±‡æ€»æœºåˆ¶ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰
> - âœ… **åŠ¨æ€å…±äº«å†…å­˜**: å…±äº«å†…å­˜ç®¡ç†æ›´æ™ºèƒ½ï¼Œå†…å­˜æ•ˆç‡æå‡20%
> - âœ… **æ•°æ®æ ¡éªŒå’Œé»˜è®¤å¯ç”¨**: `initdb` é»˜è®¤å¯ç”¨æ•°æ®æ ¡éªŒå’Œï¼Œæé«˜æ•°æ®å®Œæ•´æ€§

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—](#postgresqlå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–](#ä¸€å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”](#21-å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”)
    - [2.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”](#22-ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”)
  - [ä¸‰ã€ç†è®ºåŸºç¡€](#ä¸‰ç†è®ºåŸºç¡€)
    - [3.1 ç¼“å†²åŒºç®¡ç†ç†è®º](#31-ç¼“å†²åŒºç®¡ç†ç†è®º)
    - [3.2 WALç†è®º](#32-walç†è®º)
    - [3.3 æ£€æŸ¥ç‚¹ç†è®º](#33-æ£€æŸ¥ç‚¹ç†è®º)
  - [å››ã€PostgreSQLå­˜å‚¨æ¶æ„](#å››postgresqlå­˜å‚¨æ¶æ„)
    - [4.1 å­˜å‚¨ç»“æ„](#41-å­˜å‚¨ç»“æ„)
    - [4.2 é¡µé¢ç»“æ„](#42-é¡µé¢ç»“æ„)
    - [4.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€](#43-æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€)
  - [äº”ã€ç¼“å†²åŒºç®¡ç†](#äº”ç¼“å†²åŒºç®¡ç†)
    - [5.1 ç¼“å†²åŒºé…ç½®](#51-ç¼“å†²åŒºé…ç½®)
    - [5.2 ç¼“å†²åŒºä¼˜åŒ–](#52-ç¼“å†²åŒºä¼˜åŒ–)
      - [5.1.1 ç¼“å†²åŒºç®¡ç†æœºåˆ¶è¯¦è§£](#511-ç¼“å†²åŒºç®¡ç†æœºåˆ¶è¯¦è§£)
      - [5.2.1 ç¼“å†²åŒºæ€§èƒ½è°ƒä¼˜](#521-ç¼“å†²åŒºæ€§èƒ½è°ƒä¼˜)
  - [å…­ã€WALæœºåˆ¶](#å…­walæœºåˆ¶)
    - [6.1 WALé…ç½®](#61-walé…ç½®)
    - [6.2 WALå½’æ¡£](#62-walå½’æ¡£)
    - [6.3 æµå¤åˆ¶](#63-æµå¤åˆ¶)
      - [6.1.1 WALå†™å…¥æµç¨‹è¯¦è§£](#611-walå†™å…¥æµç¨‹è¯¦è§£)
      - [6.2.1 WALå½’æ¡£ç­–ç•¥è¯¦è§£](#621-walå½’æ¡£ç­–ç•¥è¯¦è§£)
      - [6.3.1 æµå¤åˆ¶ä¼˜åŒ–è¯¦è§£](#631-æµå¤åˆ¶ä¼˜åŒ–è¯¦è§£)
    - [6.4 PostgreSQL 18å¼‚æ­¥I/Oå­ç³»ç»Ÿ ğŸ†•](#64-postgresql-18å¼‚æ­¥ioå­ç³»ç»Ÿ-)
  - [ä¸ƒã€æ£€æŸ¥ç‚¹æœºåˆ¶](#ä¸ƒæ£€æŸ¥ç‚¹æœºåˆ¶)
    - [7.1 æ£€æŸ¥ç‚¹é…ç½®](#71-æ£€æŸ¥ç‚¹é…ç½®)
    - [7.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–](#72-æ£€æŸ¥ç‚¹ä¼˜åŒ–)
      - [7.1.1 æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£](#711-æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£)
      - [7.2.1 æ£€æŸ¥ç‚¹ä¼˜åŒ–ç­–ç•¥](#721-æ£€æŸ¥ç‚¹ä¼˜åŒ–ç­–ç•¥)
  - [å…«ã€å­˜å‚¨ä¼˜åŒ–](#å…«å­˜å‚¨ä¼˜åŒ–)
    - [8.0 PostgreSQL 18å¢é‡å¤‡ä»½å¢å¼º ğŸ†•](#80-postgresql-18å¢é‡å¤‡ä»½å¢å¼º-)
    - [8.1 è¡¨ç©ºé—´ç®¡ç†](#81-è¡¨ç©ºé—´ç®¡ç†)
      - [8.1.1 è¡¨ç©ºé—´è®¾è®¡åŸåˆ™](#811-è¡¨ç©ºé—´è®¾è®¡åŸåˆ™)
      - [8.1.2 è¡¨ç©ºé—´è¿ç§»ç­–ç•¥](#812-è¡¨ç©ºé—´è¿ç§»ç­–ç•¥)
      - [8.1.3 è¡¨ç©ºé—´æ€§èƒ½ä¼˜åŒ–](#813-è¡¨ç©ºé—´æ€§èƒ½ä¼˜åŒ–)
    - [8.2 åˆ†åŒºè¡¨ä¼˜åŒ–](#82-åˆ†åŒºè¡¨ä¼˜åŒ–)
      - [8.2.1 åˆ†åŒºç­–ç•¥é€‰æ‹©](#821-åˆ†åŒºç­–ç•¥é€‰æ‹©)
      - [8.2.2 åˆ†åŒºè£å‰ªæœºåˆ¶](#822-åˆ†åŒºè£å‰ªæœºåˆ¶)
      - [8.2.3 åˆ†åŒºç»´æŠ¤æ“ä½œ](#823-åˆ†åŒºç»´æŠ¤æ“ä½œ)
    - [8.3 å‹ç¼©å’ŒTOAST](#83-å‹ç¼©å’Œtoast)
      - [8.3.1 TOASTæœºåˆ¶è¯¦è§£](#831-toastæœºåˆ¶è¯¦è§£)
  - [ä¹ã€æ€§èƒ½ç›‘æ§](#ä¹æ€§èƒ½ç›‘æ§)
    - [9.1 I/Oæ€§èƒ½ç›‘æ§](#91-ioæ€§èƒ½ç›‘æ§)
      - [9.1.1 I/Oç›‘æ§æŒ‡æ ‡è¯¦è§£](#911-ioç›‘æ§æŒ‡æ ‡è¯¦è§£)
      - [9.1.2 I/Oé—®é¢˜è¯Šæ–­](#912-ioé—®é¢˜è¯Šæ–­)
    - [9.2 å­˜å‚¨æ€§èƒ½åˆ†æ](#92-å­˜å‚¨æ€§èƒ½åˆ†æ)
      - [9.2.1 å­˜å‚¨ä½¿ç”¨åˆ†æ](#921-å­˜å‚¨ä½¿ç”¨åˆ†æ)
      - [9.2.2 å­˜å‚¨ä¼˜åŒ–å»ºè®®](#922-å­˜å‚¨ä¼˜åŒ–å»ºè®®)
  - [åã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–](#101-å¤§æ•°æ®è¡¨ä¼˜åŒ–)
      - [10.1.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ](#1011-å¤§æ•°æ®è¡¨ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ)
    - [10.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–](#102-é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–)
      - [10.2.1 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ](#1021-é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ)
  - [åä¸€ã€ç›¸å…³æ¦‚å¿µ](#åä¸€ç›¸å…³æ¦‚å¿µ)
    - [11.1 ä¸Šä½æ¦‚å¿µ](#111-ä¸Šä½æ¦‚å¿µ)
    - [11.2 ä¸‹ä½æ¦‚å¿µ](#112-ä¸‹ä½æ¦‚å¿µ)
    - [11.3 å¹³è¡Œæ¦‚å¿µ](#113-å¹³è¡Œæ¦‚å¿µ)
  - [åäºŒã€å‚è€ƒèµ„æº](#åäºŒå‚è€ƒèµ„æº)
    - [12.1 ç›¸å…³æ–‡æ¡£](#121-ç›¸å…³æ–‡æ¡£)
    - [12.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#122-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
    - [12.3 å‚è€ƒæ–‡çŒ®](#123-å‚è€ƒæ–‡çŒ®)
    - [12.4 Wikidataå¯¹é½](#124-wikidataå¯¹é½)
      - [12.4.1 å­˜å‚¨ç®¡ç†æ¦‚å¿µå¯¹é½](#1241-å­˜å‚¨ç®¡ç†æ¦‚å¿µå¯¹é½)
      - [12.4.2 PostgreSQLå­˜å‚¨ç®¡ç†å¯¹é½](#1242-postgresqlå­˜å‚¨ç®¡ç†å¯¹é½)
  - [åä¸‰ã€å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯](#åä¸‰å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯)
    - [13.1 WALæŒä¹…æ€§ä¿è¯è¯æ˜](#131-walæŒä¹…æ€§ä¿è¯è¯æ˜)
    - [13.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥æœ€ä¼˜æ€§è¯æ˜](#132-ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥æœ€ä¼˜æ€§è¯æ˜)
    - [13.3 æ£€æŸ¥ç‚¹ä¸€è‡´æ€§è¯æ˜](#133-æ£€æŸ¥ç‚¹ä¸€è‡´æ€§è¯æ˜)
  - [åå››ã€äº¤å‰å¼•ç”¨](#åå››äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å­˜å‚¨ç®¡ç†))
    ç†è®ºåŸºç¡€
      ç¼“å†²åŒºç®¡ç†
      WALç†è®º
      æ£€æŸ¥ç‚¹ç†è®º
    å­˜å‚¨æ¶æ„
      å­˜å‚¨ç»“æ„
      é¡µé¢ç»“æ„
      æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€
    ç¼“å†²åŒºç®¡ç†
      é…ç½®
      ä¼˜åŒ–
    WALæœºåˆ¶
      é…ç½®
      å½’æ¡£
      æµå¤åˆ¶
    æ£€æŸ¥ç‚¹
      é…ç½®
      ä¼˜åŒ–
    å­˜å‚¨ä¼˜åŒ–
      è¡¨ç©ºé—´
      åˆ†åŒºè¡¨
      å‹ç¼©TOAST
    æ€§èƒ½ç›‘æ§
      I/Oç›‘æ§
      æ€§èƒ½åˆ†æ
    å®é™…åº”ç”¨
      å¤§æ•°æ®è¡¨
      é«˜å¹¶å‘å†™å…¥
```

---

## ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å­˜å‚¨ç®¡ç†æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç®¡ç†æ•°æ®æŒä¹…åŒ–å­˜å‚¨çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬ç¼“å†²åŒºç®¡ç†ã€WALæ—¥å¿—ã€æ£€æŸ¥ç‚¹ç­‰æ ¸å¿ƒç»„ä»¶ã€‚PostgreSQLé€šè¿‡é«˜æ•ˆçš„å­˜å‚¨ç®¡ç†ç¡®ä¿æ•°æ®çš„æŒä¹…æ€§å’Œç³»ç»Ÿçš„é«˜æ€§èƒ½ã€‚

**English Definition**: Storage management is a mechanism in database systems that manages persistent data storage, including buffer management, WAL logging, checkpoints, and other core components. PostgreSQL ensures data durability and high system performance through efficient storage management.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\storage}{\mathcal{S}}
\newcommand{\buffer}{\mathcal{B}}
\newcommand{\wal}{\mathcal{W}}
\newcommand{\page}{\mathcal{P}}
\newcommand{\disk}{\mathcal{D}}

% å­˜å‚¨ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰
\storage = (\buffer, \wal, \page, \disk)

å…¶ä¸­ï¼š
\buffer = \{b_1, b_2, \ldots, b_n\}: ç¼“å†²åŒºé¡µé¢é›†åˆ
\wal = \{w_1, w_2, \ldots, w_m\}: WALæ—¥å¿—è®°å½•é›†åˆ
\page = \{p_1, p_2, \ldots, p_k\}: ç£ç›˜é¡µé¢é›†åˆ
\disk = \{d_1, d_2, \ldots, d_l\}: ç£ç›˜å­˜å‚¨é›†åˆ
```

### 1.3 æ ¸å¿ƒå±æ€§

- **æŒä¹…æ€§**: ç¡®ä¿æ•°æ®æ°¸ä¹…ä¿å­˜
- **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ€§èƒ½**: ä¼˜åŒ–I/Oæ“ä½œæ•ˆç‡
- **å¯æ¢å¤æ€§**: æ”¯æŒæ•…éšœæ¢å¤

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”

| å­˜å‚¨ç®¡ç†æœºåˆ¶ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| ç›´æ¥I/O | ç»•è¿‡OSç¼“å­˜ | æ§åˆ¶ç²¾ç¡® | æ€§èƒ½è¾ƒä½ | ç‰¹æ®Šéœ€æ±‚ |
| ç¼“å†²I/O | OSç¼“å­˜ | æ€§èƒ½é«˜ | æ§åˆ¶æœ‰é™ | é€šç”¨åœºæ™¯ |
| å¼‚æ­¥I/O | å¼‚æ­¥æ“ä½œ | é«˜å¹¶å‘ | å®ç°å¤æ‚ | PostgreSQL 18+ |
| åŒæ­¥I/O | åŒæ­¥æ“ä½œ | å¯é æ€§é«˜ | æ€§èƒ½è¾ƒä½ | å…³é”®æ•°æ® |

### 2.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”

| æ›¿æ¢ç­–ç•¥ | ç®—æ³•å¤æ‚åº¦ | å‘½ä¸­ç‡ | å®ç°éš¾åº¦ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| LRU | O(1) | é«˜ | ä¸­ | é€šç”¨åœºæ™¯ |
| LFU | O(log n) | ä¸­ | é«˜ | è®¿é—®æ¨¡å¼ç¨³å®š |
| FIFO | O(1) | ä½ | ä½ | ç®€å•åœºæ™¯ |
| Clock | O(1) | ä¸­ | ä¸­ | å†…å­˜å—é™ |

---

## ä¸‰ã€ç†è®ºåŸºç¡€

### 3.1 ç¼“å†²åŒºç®¡ç†ç†è®º

```latex
\begin{theorem}[ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥]
LRU (Least Recently Used) ç­–ç•¥ï¼š
1. æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢ä¼˜å…ˆè¢«æ›¿æ¢
2. æ—¶é—´å¤æ‚åº¦ï¼šO(1) æŸ¥æ‰¾å’Œæ›´æ–°
3. ç©ºé—´å¤æ‚åº¦ï¼šO(n) å­˜å‚¨å¼€é”€
\end{theorem}

\begin{proof}
åŸºäºè®¿é—®æ—¶é—´æˆ³å’ŒåŒå‘é“¾è¡¨ç»“æ„ï¼Œå¯ä»¥è¯æ˜LRUç­–ç•¥çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.2 WALç†è®º

```latex
\begin{theorem}[WALåè®®]
Write-Ahead Loggingåè®®è¦æ±‚ï¼š
1. åœ¨ä¿®æ”¹æ•°æ®é¡µé¢å‰ï¼Œå¿…é¡»å…ˆå†™WALæ—¥å¿—
2. æ—¥å¿—è®°å½•å¿…é¡»æŒä¹…åŒ–åˆ°ç£ç›˜
3. æ£€æŸ¥ç‚¹æœºåˆ¶ç¡®ä¿æ•°æ®é¡µé¢çš„æŒä¹…åŒ–
\end{theorem}

\begin{proof}
åŸºäºæ•…éšœæ¢å¤çš„éœ€æ±‚å’Œæ—¥å¿—çš„å®Œæ•´æ€§ï¼Œå¯ä»¥è¯æ˜WALåè®®çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.3 æ£€æŸ¥ç‚¹ç†è®º

```latex
\begin{theorem}[æ£€æŸ¥ç‚¹ä¸€è‡´æ€§]
æ£€æŸ¥ç‚¹ç¡®ä¿ï¼š
1. æ‰€æœ‰è„é¡µè¢«å†™å…¥ç£ç›˜
2. WALæ—¥å¿—è¢«æˆªæ–­
3. ç³»ç»ŸçŠ¶æ€ä¸€è‡´
\end{theorem}
```

---

## å››ã€PostgreSQLå­˜å‚¨æ¶æ„

### 4.1 å­˜å‚¨ç»“æ„

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹è¡¨ç©ºé—´
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) as size
FROM pg_tablespace;
```

### 4.2 é¡µé¢ç»“æ„

```sql
-- æŸ¥çœ‹é¡µé¢ä¿¡æ¯
SELECT
    relname,
    relpages,
    reltuples,
    relallvisible,
    relfrozenxid
FROM pg_class
WHERE relkind = 'r'
ORDER BY relpages DESC;

-- æŸ¥çœ‹é¡µé¢ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables;
```

### 4.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€

```sql
-- æŸ¥çœ‹æ•°æ®ç›®å½•
SHOW data_directory;

-- æŸ¥çœ‹WALç›®å½•
SHOW log_directory;

-- æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®
SHOW config_file;
SHOW hba_file;
SHOW ident_file;
```

---

## äº”ã€ç¼“å†²åŒºç®¡ç†

### 5.1 ç¼“å†²åŒºé…ç½®

```sql
-- æŸ¥çœ‹ç¼“å†²åŒºé…ç½®
SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;
SHOW maintenance_work_mem;

-- æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æŸ¥çœ‹ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
SELECT
    c.relname,
    c.relkind,
    pg_size_pretty(pg_relation_size(c.oid)) as size,
    pg_stat_get_tuples_returned(c.oid) as tuples_returned,
    pg_stat_get_tuples_fetched(c.oid) as tuples_fetched,
    pg_stat_get_tuples_inserted(c.oid) as tuples_inserted,
    pg_stat_get_tuples_updated(c.oid) as tuples_updated,
    pg_stat_get_tuples_deleted(c.oid) as tuples_deleted
FROM pg_class c
WHERE c.relkind IN ('r', 'i')
ORDER BY pg_relation_size(c.oid) DESC;
```

### 5.2 ç¼“å†²åŒºä¼˜åŒ–

```sql
-- ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    round(100.0 * sum(blks_hit) / (sum(blks_hit) + sum(blks_read)), 2) as hit_ratio
FROM pg_stat_database;

-- è¡¨çº§ç¼“å†²åŒºç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 0
ORDER BY hit_ratio ASC;
```

#### 5.1.1 ç¼“å†²åŒºç®¡ç†æœºåˆ¶è¯¦è§£

**ç¼“å†²åŒºå·¥ä½œåŸç†**:

PostgreSQLä½¿ç”¨å…±äº«å†…å­˜ç¼“å†²åŒºæ± æ¥ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®é¡µï¼Œå‡å°‘ç£ç›˜I/Oæ“ä½œã€‚

**ç¼“å†²åŒºæ›¿æ¢ç®—æ³•ï¼ˆLRUï¼‰**:

```sql
-- æŸ¥çœ‹ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
SELECT
    c.relname,
    pg_size_pretty(pg_relation_size(c.oid)) as size,
    pg_stat_get_tuples_returned(c.oid) as tuples_returned,
    pg_stat_get_tuples_fetched(c.oid) as tuples_fetched
FROM pg_class c
WHERE c.relkind = 'r'
ORDER BY pg_relation_size(c.oid) DESC;

-- æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡è¯¦æƒ…
SELECT
    datname,
    blks_hit,
    blks_read,
    round(100.0 * blks_hit / (blks_hit + blks_read), 2) as hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname = current_database();
```

**ç¼“å†²åŒºé…ç½®ä¼˜åŒ–**:

```sql
-- æ¨èé…ç½®ï¼ˆæ ¹æ®ç³»ç»Ÿå†…å­˜ï¼‰
-- postgresql.conf

-- å…±äº«ç¼“å†²åŒºï¼ˆæ¨èï¼šç³»ç»Ÿå†…å­˜çš„25%ï¼‰
shared_buffers = 4GB  -- å¯¹äº16GBå†…å­˜ç³»ç»Ÿ

-- æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆæ¨èï¼šç³»ç»Ÿå†…å­˜çš„50-75%ï¼‰
effective_cache_size = 12GB  -- å¯¹äº16GBå†…å­˜ç³»ç»Ÿ

-- å·¥ä½œå†…å­˜ï¼ˆç”¨äºæ’åºå’Œå“ˆå¸Œæ“ä½œï¼‰
work_mem = 64MB  -- æ¯ä¸ªæ“ä½œçš„å†…å­˜é™åˆ¶

-- ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç”¨äºVACUUMã€CREATE INDEXç­‰ï¼‰
maintenance_work_mem = 1GB  -- ç»´æŠ¤æ“ä½œçš„å†…å­˜é™åˆ¶
```

**ç¼“å†²åŒºé¢„è¯»æœºåˆ¶**:

PostgreSQLä½¿ç”¨é¢„è¯»æœºåˆ¶æå‰åŠ è½½å¯èƒ½éœ€è¦çš„æ•°æ®é¡µï¼Œå‡å°‘I/Oç­‰å¾…ã€‚

```sql
-- æŸ¥çœ‹é¢„è¯»ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,      -- ä»ç£ç›˜è¯»å–çš„å—æ•°
    heap_blks_hit,       -- ä»ç¼“å†²åŒºå‘½ä¸­çš„å—æ•°
    idx_blks_read,       -- ç´¢å¼•å—è¯»å–æ•°
    idx_blks_hit,        -- ç´¢å¼•å—å‘½ä¸­æ•°
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as heap_hit_ratio,
    round(100.0 * idx_blks_hit / (idx_blks_hit + idx_blks_read), 2) as idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 0
ORDER BY heap_blks_read DESC;
```

**ç¼“å†²åŒºä¼˜åŒ–æœ€ä½³å®è·µ**:

```sql
-- 1. ç›‘æ§ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆç›®æ ‡ï¼š>99%ï¼‰
SELECT
    round(100.0 * sum(blks_hit) / (sum(blks_hit) + sum(blks_read)), 2) as overall_hit_ratio
FROM pg_stat_database;

-- 2. è¯†åˆ«ä½å‘½ä¸­ç‡çš„è¡¨
SELECT
    schemaname,
    tablename,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as hit_ratio,
    heap_blks_read,
    heap_blks_hit
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 1000
AND round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) < 95
ORDER BY heap_blks_read DESC;

-- 3. ä¼˜åŒ–ç­–ç•¥
-- - å¢åŠ shared_buffersï¼ˆå¦‚æœå‘½ä¸­ç‡ä½ï¼‰
-- - ä½¿ç”¨è¡¨ç©ºé—´å°†çƒ­ç‚¹æ•°æ®æ”¾åœ¨å¿«é€Ÿå­˜å‚¨ä¸Š
-- - ä¼˜åŒ–æŸ¥è¯¢å‡å°‘ä¸å¿…è¦çš„å…¨è¡¨æ‰«æ
```

#### 5.2.1 ç¼“å†²åŒºæ€§èƒ½è°ƒä¼˜

**æ€§èƒ½è°ƒä¼˜æ­¥éª¤**:

1. **è¯„ä¼°å½“å‰æ€§èƒ½**

    ```sql
    -- æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡
    SELECT
        checkpoints_timed,
        checkpoints_req,
        checkpoint_write_time,
        checkpoint_sync_time,
        buffers_checkpoint,
        buffers_clean,
        buffers_backend,
        buffers_backend_fsync,
        buffers_alloc
    FROM pg_stat_bgwriter;

    -- è®¡ç®—ç¼“å†²åŒºåˆ†é…æ•ˆç‡
    SELECT
        round(100.0 * buffers_checkpoint / (buffers_checkpoint + buffers_clean + buffers_backend), 2) as checkpoint_ratio,
        round(100.0 * buffers_clean / (buffers_checkpoint + buffers_clean + buffers_backend), 2) as clean_ratio,
        round(100.0 * buffers_backend / (buffers_checkpoint + buffers_clean + buffers_backend), 2) as backend_ratio
    FROM pg_stat_bgwriter;
    ```

2. **è°ƒæ•´é…ç½®å‚æ•°**

    ```sql
    -- æ ¹æ®å·¥ä½œè´Ÿè½½è°ƒæ•´
    -- postgresql.conf

    -- é«˜å¹¶å‘å†™å…¥åœºæ™¯
    shared_buffers = 8GB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB

    -- é«˜å¹¶å‘è¯»å–åœºæ™¯
    shared_buffers = 4GB
    effective_cache_size = 12GB
    random_page_cost = 1.1  -- SSDç¯å¢ƒ
    ```

3. **ç›‘æ§å’ŒéªŒè¯**

    ```sql
    -- æŒç»­ç›‘æ§ç¼“å†²åŒºæ€§èƒ½
    SELECT
        now() as check_time,
        round(100.0 * sum(blks_hit) / (sum(blks_hit) + sum(blks_read)), 2) as hit_ratio,
        sum(blks_read) as total_reads,
        sum(blks_hit) as total_hits
    FROM pg_stat_database;
    ```

---

## å…­ã€WALæœºåˆ¶

### 6.1 WALé…ç½®

```sql
-- WALé…ç½®å‚æ•°
SHOW wal_level;
SHOW wal_buffers;
SHOW checkpoint_timeout;
SHOW max_wal_size;
SHOW min_wal_size;
SHOW wal_compression;
SHOW wal_log_hints;

-- WALç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_wal;

-- WALä½ç½®ä¿¡æ¯
SELECT pg_current_wal_lsn();
SELECT pg_walfile_name(pg_current_wal_lsn());
SELECT pg_walfile_name_offset(pg_current_wal_lsn());
```

### 6.2 WALå½’æ¡£

```sql
-- WALå½’æ¡£é…ç½®
SHOW archive_mode;
SHOW archive_command;
SHOW archive_timeout;

-- æŸ¥çœ‹å½’æ¡£çŠ¶æ€
SELECT * FROM pg_stat_archiver;

-- æ‰‹åŠ¨å½’æ¡£
SELECT pg_switch_wal();

-- æŸ¥çœ‹WALæ–‡ä»¶
SELECT
    name,
    size,
    modification
FROM pg_ls_waldir()
ORDER BY modification DESC;
```

### 6.3 æµå¤åˆ¶

```sql
-- æµå¤åˆ¶é…ç½®
SHOW wal_sender_timeout;
SHOW wal_receiver_timeout;
SHOW max_wal_senders;
SHOW max_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;
```

#### 6.1.1 WALå†™å…¥æµç¨‹è¯¦è§£

**WALå†™å…¥è¿‡ç¨‹**:

1. **äº‹åŠ¡æäº¤**: äº‹åŠ¡æäº¤æ—¶ï¼ŒWALè®°å½•å†™å…¥WALç¼“å†²åŒº
2. **WALåˆ·æ–°**: WALç¼“å†²åŒºå®šæœŸåˆ·æ–°åˆ°ç£ç›˜
3. **åŒæ­¥å†™å…¥**: å…³é”®æ“ä½œéœ€è¦åŒæ­¥å†™å…¥ç¡®ä¿æŒä¹…æ€§

**WALå†™å…¥é…ç½®**:

```sql
-- WALåŒæ­¥æ¨¡å¼
SHOW synchronous_commit;
-- å¯é€‰å€¼ï¼š
-- off: å¼‚æ­¥æäº¤ï¼ˆæœ€å¿«ï¼Œä½†å¯èƒ½ä¸¢å¤±æœ€è¿‘çš„äº‹åŠ¡ï¼‰
-- local: æœ¬åœ°åŒæ­¥ï¼ˆé»˜è®¤ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§ï¼‰
-- remote_write: è¿œç¨‹å†™å…¥åŒæ­¥ï¼ˆæµå¤åˆ¶åœºæ™¯ï¼‰
-- on: å®Œå…¨åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œä½†æ€§èƒ½è¾ƒä½ï¼‰
-- remote_apply: è¿œç¨‹åº”ç”¨åŒæ­¥ï¼ˆæœ€é«˜ä¸€è‡´æ€§ï¼‰

-- æŸ¥çœ‹WALå†™å…¥ç»Ÿè®¡
SELECT
    wal_records,
    wal_write,
    wal_sync,
    wal_bytes,
    wal_buffers_full,
    wal_write_time,
    wal_sync_time,
    stats_reset
FROM pg_stat_wal;
```

**WALæ€§èƒ½ä¼˜åŒ–**:

```sql
-- 1. è°ƒæ•´WALç¼“å†²åŒºå¤§å°
-- postgresql.conf
wal_buffers = 16MB  -- é»˜è®¤å€¼é€šå¸¸è¶³å¤Ÿï¼Œé«˜å¹¶å‘å†™å…¥å¯å¢åŠ 

-- 2. è°ƒæ•´WALåŒæ­¥æ¨¡å¼ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰
synchronous_commit = local  -- å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
-- æˆ–
synchronous_commit = off  -- æœ€é«˜æ€§èƒ½ï¼Œä½†å¯èƒ½ä¸¢å¤±æœ€è¿‘äº‹åŠ¡

-- 3. å¯ç”¨WALå‹ç¼©ï¼ˆPostgreSQL 9.5+ï¼‰
wal_compression = on  -- å‡å°‘WALæ–‡ä»¶å¤§å°

-- 4. ç›‘æ§WALå†™å…¥æ€§èƒ½
SELECT
    wal_write_time / NULLIF(wal_write, 0) as avg_write_time_ms,
    wal_sync_time / NULLIF(wal_sync, 0) as avg_sync_time_ms,
    wal_buffers_full,
    wal_bytes / 1024 / 1024 as wal_size_mb
FROM pg_stat_wal;
```

#### 6.2.1 WALå½’æ¡£ç­–ç•¥è¯¦è§£

**WALå½’æ¡£é…ç½®**:

```sql
-- å¯ç”¨WALå½’æ¡£
-- postgresql.conf
archive_mode = on
archive_command = 'cp %p /archive/%f'  -- å½’æ¡£å‘½ä»¤

-- æŸ¥çœ‹å½’æ¡£çŠ¶æ€
SELECT
    archived_count,
    last_archived_wal,
    last_archived_time,
    failed_count,
    last_failed_wal,
    last_failed_time,
    stats_reset
FROM pg_stat_archiver;

-- æ‰‹åŠ¨è§¦å‘å½’æ¡£
SELECT pg_switch_wal();
```

**å½’æ¡£ç­–ç•¥é€‰æ‹©**:

1. **è¿ç»­å½’æ¡£ï¼ˆContinuous Archivingï¼‰**

    ```bash
    # postgresql.conf
    archive_mode = on
    archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'

    # å®šæœŸæ¸…ç†æ—§å½’æ¡£
    # ä¿ç•™æœ€è¿‘7å¤©çš„WALæ–‡ä»¶
    find /archive -name "*.wal" -mtime +7 -delete
    ```

2. **å½’æ¡£åˆ°è¿œç¨‹å­˜å‚¨**

    ```bash
    # å½’æ¡£åˆ°S3
    archive_command = 'aws s3 cp %p s3://my-bucket/wal-archive/%f'

    # å½’æ¡£åˆ°NFS
    archive_command = 'cp %p /mnt/nfs/wal-archive/%f'
    ```

3. **å½’æ¡£å‹ç¼©**

    ```bash
    # å½’æ¡£æ—¶å‹ç¼©
    archive_command = 'gzip < %p > /archive/%f.gz'
    ```

**å½’æ¡£ç›‘æ§å’Œç»´æŠ¤**:

```sql
-- æ£€æŸ¥å½’æ¡£å»¶è¿Ÿ
SELECT
    pg_walfile_name(pg_current_wal_lsn()) as current_wal,
    last_archived_wal,
    pg_walfile_name(pg_current_wal_lsn()) != last_archived_wal as archive_lag
FROM pg_stat_archiver;

-- æŸ¥çœ‹WALæ–‡ä»¶åˆ—è¡¨
SELECT
    name,
    size,
    modification
FROM pg_ls_waldir()
ORDER BY modification DESC
LIMIT 20;
```

#### 6.3.1 æµå¤åˆ¶ä¼˜åŒ–è¯¦è§£

**æµå¤åˆ¶é…ç½®ä¼˜åŒ–**:

```sql
-- ä¸»åº“é…ç½®
-- postgresql.conf
wal_level = replica  -- æˆ– logicalï¼ˆé€»è¾‘å¤åˆ¶ï¼‰
max_wal_senders = 10  -- æœ€å¤§WALå‘é€è¿›ç¨‹æ•°
max_replication_slots = 10  -- æœ€å¤§å¤åˆ¶æ§½æ•°
wal_keep_size = 1GB  -- ä¿ç•™çš„WALå¤§å°

-- ä»åº“é…ç½®
-- postgresql.conf
hot_standby = on
max_standby_streaming_delay = 30s  -- æŸ¥è¯¢å»¶è¿Ÿå®¹å¿åº¦
```

**æµå¤åˆ¶ç›‘æ§**:

```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) as sent_lag_bytes,
    pg_wal_lsn_diff(sent_lsn, write_lsn) as write_lag_bytes,
    pg_wal_lsn_diff(write_lsn, flush_lsn) as flush_lag_bytes,
    pg_wal_lsn_diff(flush_lsn, replay_lsn) as replay_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as total_lag_bytes
FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT
    slot_name,
    slot_type,
    database,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as lag_bytes
FROM pg_replication_slots;
```

**æµå¤åˆ¶æ€§èƒ½ä¼˜åŒ–**:

```sql
-- 1. è°ƒæ•´WALå‘é€å‚æ•°
-- postgresql.conf
wal_sender_timeout = 60s
wal_receiver_timeout = 60s

-- 2. ä½¿ç”¨å¤åˆ¶æ§½é˜²æ­¢WALè¢«åˆ é™¤
SELECT pg_create_physical_replication_slot('standby1');

-- 3. ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) as replication_lag
FROM pg_stat_replication;
```

### 6.4 PostgreSQL 18å¼‚æ­¥I/Oå­ç³»ç»Ÿ ğŸ†•

PostgreSQL 18å¼•å…¥äº†å…¨æ–°çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿï¼Œæ˜¾è‘—æå‡äº†I/Oå¯†é›†å‹æ“ä½œçš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å‘é‡æ£€ç´¢ã€å¤§è¡¨æ‰«æå’Œç´¢å¼•æ„å»ºåœºæ™¯ä¸­ï¼Œæ€§èƒ½æå‡2-3å€ã€‚

**æŠ€æœ¯åŸç†**:

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼æå‡æ€§èƒ½ï¼š

1. **å¼‚æ­¥é¢„è¯»**: åœ¨é¡ºåºæ‰«ææ—¶å¼‚æ­¥é¢„è¯»åç»­é¡µé¢ï¼Œå‡å°‘I/Oç­‰å¾…æ—¶é—´
2. **å¹¶å‘I/O**: æ”¯æŒå¤šä¸ªI/Oæ“ä½œå¹¶å‘æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨å­˜å‚¨è®¾å¤‡æ€§èƒ½
3. **æ™ºèƒ½è°ƒåº¦**: æ ¹æ®I/Oè´Ÿè½½åŠ¨æ€è°ƒæ•´I/Oç­–ç•¥

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
-- postgresql.conf

-- æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
effective_io_concurrency = 200   -- SSDæ¨èå€¼ï¼š200-300
                                  -- NVMeæ¨èå€¼ï¼š300-500
                                  -- HDDæ¨èå€¼ï¼š50-100

-- ç»´æŠ¤æ“ä½œI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
maintenance_io_concurrency = 200  -- VACUUMã€CREATE INDEXç­‰æ“ä½œ

-- æŸ¥çœ‹I/Oç»Ÿè®¡ä¿¡æ¯ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    read_time,
    write_time,
    sync_time
FROM pg_stat_io
ORDER BY reads DESC;
```

**ä½¿ç”¨åœºæ™¯**:

1. **å‘é‡æ£€ç´¢**

   ```sql
   -- pgvectorå‘é‡æ£€ç´¢å—ç›Šäºå¼‚æ­¥I/O
   SELECT id, content,
          1 - (embedding <=> query_vector) as similarity
   FROM documents
   ORDER BY embedding <=> query_vector
   LIMIT 100;
   -- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ€§èƒ½2-3å€
   ```

2. **å¤§è¡¨æ‰«æ**

   ```sql
   -- å¤§è¡¨å…¨è¡¨æ‰«æ
   SELECT COUNT(*) FROM large_table;
   -- PostgreSQL 18: å¼‚æ­¥é¢„è¯»æå‡æ‰«æé€Ÿåº¦
   ```

3. **ç´¢å¼•æ„å»º**

   ```sql
   -- åˆ›å»ºç´¢å¼•
   CREATE INDEX CONCURRENTLY idx_large ON large_table(column1);
   -- PostgreSQL 18: å¼‚æ­¥I/OåŠ é€Ÿç´¢å¼•æ„å»º
   ```

**æ€§èƒ½å¯¹æ¯”**:

- PostgreSQL 17: åŒæ­¥I/Oï¼Œé¡ºåºæ‰§è¡Œ
- PostgreSQL 18: å¼‚æ­¥I/Oï¼Œå¹¶å‘æ‰§è¡Œï¼Œæ€§èƒ½æå‡2-3å€
- å‘é‡æ£€ç´¢åœºæ™¯ï¼šæ€§èƒ½æå‡2-3å€
- å¤§è¡¨æ‰«æåœºæ™¯ï¼šæ€§èƒ½æå‡1.5-2å€
- ç´¢å¼•æ„å»ºåœºæ™¯ï¼šæ€§èƒ½æå‡2-3å€

**æœ€ä½³å®è·µ**:

- æ ¹æ®å­˜å‚¨ç±»å‹è°ƒæ•´`effective_io_concurrency`
  - SSD: 200-300
  - NVMe: 300-500
  - HDD: 50-100
- ç›‘æ§`pg_stat_io`è§†å›¾äº†è§£I/Oæ¨¡å¼
- ç»“åˆ`shared_buffers`è°ƒä¼˜æ•´ä½“æ€§èƒ½
- PostgreSQL 18çš„å¼‚æ­¥I/Oåœ¨å‘é‡æ£€ç´¢å’Œå¤§è¡¨æ‰«æåœºæ™¯ä¸­æ•ˆæœæœ€æ˜æ˜¾

---

## ä¸ƒã€æ£€æŸ¥ç‚¹æœºåˆ¶

### 7.1 æ£€æŸ¥ç‚¹é…ç½®

```sql
-- æ£€æŸ¥ç‚¹é…ç½®
SHOW checkpoint_timeout;
SHOW checkpoint_completion_target;
SHOW max_wal_size;
SHOW min_wal_size;

-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æ‰‹åŠ¨æ£€æŸ¥ç‚¹
CHECKPOINT;
```

### 7.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–

```sql
-- æ£€æŸ¥ç‚¹æ€§èƒ½åˆ†æ
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;

-- æ£€æŸ¥ç‚¹é¢‘ç‡åˆ†æ
SELECT
    checkpoints_timed + checkpoints_req as total_checkpoints,
    round(extract(epoch from now() - pg_postmaster_start_time()) / (checkpoints_timed + checkpoints_req), 2) as avg_interval_seconds
FROM pg_stat_bgwriter;
```

#### 7.1.1 æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£

**æ£€æŸ¥ç‚¹è§¦å‘æ¡ä»¶**:

1. **å®šæ—¶æ£€æŸ¥ç‚¹**: æ ¹æ®`checkpoint_timeout`å‚æ•°å®šæœŸè§¦å‘
2. **WALå¤§å°æ£€æŸ¥ç‚¹**: å½“WALå¤§å°è¾¾åˆ°`max_wal_size`æ—¶è§¦å‘
3. **æ‰‹åŠ¨æ£€æŸ¥ç‚¹**: æ‰§è¡Œ`CHECKPOINT`å‘½ä»¤è§¦å‘
4. **æ•°æ®åº“å…³é—­æ£€æŸ¥ç‚¹**: æ­£å¸¸å…³é—­æ•°æ®åº“æ—¶è§¦å‘

**æ£€æŸ¥ç‚¹é…ç½®è¯¦è§£**:

```sql
-- æŸ¥çœ‹æ£€æŸ¥ç‚¹é…ç½®
SHOW checkpoint_timeout;          -- æ£€æŸ¥ç‚¹è¶…æ—¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
SHOW checkpoint_completion_target; -- æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡ï¼ˆé»˜è®¤0.9ï¼‰
SHOW max_wal_size;               -- æœ€å¤§WALå¤§å°ï¼ˆé»˜è®¤1GBï¼‰
SHOW min_wal_size;               -- æœ€å°WALå¤§å°ï¼ˆé»˜è®¤80MBï¼‰

-- æ¨èé…ç½®
-- postgresql.conf
checkpoint_timeout = 15min        -- å¢åŠ æ£€æŸ¥ç‚¹é—´éš”
checkpoint_completion_target = 0.9 -- åœ¨90%çš„æ—¶é—´å†…å®Œæˆæ£€æŸ¥ç‚¹
max_wal_size = 4GB               -- å…è®¸æ›´å¤§çš„WALå¤§å°
min_wal_size = 1GB               -- ä¿ç•™æ›´å¤šWALæ–‡ä»¶
```

**æ£€æŸ¥ç‚¹å·¥ä½œæµç¨‹**:

1. **å‡†å¤‡é˜¶æ®µ**: ç¡®å®šéœ€è¦åˆ·æ–°çš„è„é¡µ
2. **å†™å…¥é˜¶æ®µ**: å°†è„é¡µå†™å…¥ç£ç›˜
3. **åŒæ­¥é˜¶æ®µ**: åŒæ­¥æ‰€æœ‰å†™å…¥æ“ä½œ
4. **å®Œæˆé˜¶æ®µ**: æ›´æ–°æ§åˆ¶æ–‡ä»¶ï¼Œæ ‡è®°æ£€æŸ¥ç‚¹å®Œæˆ

**æ£€æŸ¥ç‚¹æ€§èƒ½åˆ†æ**:

```sql
-- è¯¦ç»†æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT
    checkpoints_timed,           -- å®šæ—¶æ£€æŸ¥ç‚¹æ¬¡æ•°
    checkpoints_req,             -- è¯·æ±‚æ£€æŸ¥ç‚¹æ¬¡æ•°
    checkpoint_write_time,       -- æ£€æŸ¥ç‚¹å†™å…¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    checkpoint_sync_time,        -- æ£€æŸ¥ç‚¹åŒæ­¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    buffers_checkpoint,          -- æ£€æŸ¥ç‚¹å†™å…¥çš„ç¼“å†²åŒºæ•°
    buffers_clean,               -- åå°å†™å…¥çš„ç¼“å†²åŒºæ•°
    buffers_backend,             -- åç«¯è¿›ç¨‹å†™å…¥çš„ç¼“å†²åŒºæ•°
    buffers_backend_fsync,       -- åç«¯è¿›ç¨‹åŒæ­¥çš„ç¼“å†²åŒºæ•°
    buffers_alloc,               -- åˆ†é…çš„ç¼“å†²åŒºæ•°
    stats_reset                  -- ç»Ÿè®¡é‡ç½®æ—¶é—´
FROM pg_stat_bgwriter;

-- è®¡ç®—æ£€æŸ¥ç‚¹æ•ˆç‡
SELECT
    checkpoints_timed + checkpoints_req as total_checkpoints,
    round((checkpoint_write_time + checkpoint_sync_time) / NULLIF(checkpoints_timed + checkpoints_req, 0), 2) as avg_checkpoint_time_ms,
    round(extract(epoch from now() - stats_reset) / NULLIF(checkpoints_timed + checkpoints_req, 0), 2) as avg_interval_seconds
FROM pg_stat_bgwriter;
```

#### 7.2.1 æ£€æŸ¥ç‚¹ä¼˜åŒ–ç­–ç•¥

**ä¼˜åŒ–ç›®æ ‡**:

1. **å‡å°‘æ£€æŸ¥ç‚¹é¢‘ç‡**: é™ä½I/Oå¼€é”€
2. **å¹³æ»‘æ£€æŸ¥ç‚¹å†™å…¥**: é¿å…I/Oçªå‘
3. **å‡å°‘æ£€æŸ¥ç‚¹æ—¶é—´**: é™ä½å¯¹æ­£å¸¸æ“ä½œçš„å½±å“

**ä¼˜åŒ–é…ç½®**:

```sql
-- é«˜å†™å…¥è´Ÿè½½åœºæ™¯
-- postgresql.conf
checkpoint_timeout = 30min        -- å¢åŠ æ£€æŸ¥ç‚¹é—´éš”
checkpoint_completion_target = 0.9 -- å¹³æ»‘å†™å…¥
max_wal_size = 8GB               -- å…è®¸æ›´å¤§çš„WAL
wal_buffers = 32MB               -- å¢åŠ WALç¼“å†²åŒº

-- ä½å†™å…¥è´Ÿè½½åœºæ™¯
-- postgresql.conf
checkpoint_timeout = 15min        -- æ ‡å‡†é—´éš”
checkpoint_completion_target = 0.7 -- æ›´å¿«å®Œæˆ
max_wal_size = 2GB               -- è¾ƒå°çš„WAL
```

**æ£€æŸ¥ç‚¹æ€§èƒ½ç›‘æ§**:

```sql
-- ç›‘æ§æ£€æŸ¥ç‚¹æ€§èƒ½
SELECT
    now() as check_time,
    checkpoints_timed,
    checkpoints_req,
    round((checkpoint_write_time + checkpoint_sync_time) / 1000.0, 2) as total_checkpoint_time_sec,
    round(checkpoint_write_time / NULLIF(checkpoints_timed + checkpoints_req, 0) / 1000.0, 2) as avg_write_time_sec,
    round(checkpoint_sync_time / NULLIF(checkpoints_timed + checkpoints_req, 0) / 1000.0, 2) as avg_sync_time_sec,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend
FROM pg_stat_bgwriter;

-- è¯†åˆ«æ£€æŸ¥ç‚¹é—®é¢˜
-- å¦‚æœcheckpoints_reqè¿‡å¤šï¼Œè¯´æ˜éœ€è¦å¢åŠ max_wal_size
SELECT
    checkpoints_req,
    checkpoints_timed,
    round(100.0 * checkpoints_req / NULLIF(checkpoints_timed + checkpoints_req, 0), 2) as req_ratio
FROM pg_stat_bgwriter;
-- req_ratio > 50% è¡¨ç¤ºéœ€è¦ä¼˜åŒ–
```

**æ£€æŸ¥ç‚¹ä¸æ¢å¤**:

```sql
-- æŸ¥çœ‹æ¢å¤ä¿¡æ¯
SELECT
    pg_is_in_recovery(),
    pg_last_wal_receive_lsn(),
    pg_last_wal_replay_lsn(),
    pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) as replay_lag_bytes;

-- æ£€æŸ¥ç‚¹ä¸WALçš„å…³ç³»
SELECT
    pg_control_checkpoint(),
    pg_current_wal_lsn(),
    pg_walfile_name(pg_current_wal_lsn());
```

---

## å…«ã€å­˜å‚¨ä¼˜åŒ–

### 8.0 PostgreSQL 18å¢é‡å¤‡ä»½å¢å¼º ğŸ†•

PostgreSQL 18å¯¹å¢é‡å¤‡ä»½è¿›è¡Œäº†é‡å¤§å¢å¼ºï¼Œé€šè¿‡WAL Summarizerè¿›ç¨‹æ˜¾è‘—æå‡å¤‡ä»½æ€§èƒ½ï¼ŒèŠ‚çœ94%çš„å¤‡ä»½æ—¶é—´ã€‚

**WAL Summarizerè¿›ç¨‹**:

PostgreSQL 18å¼•å…¥äº†WAL Summarizeråå°è¿›ç¨‹ï¼ŒæŒç»­æ±‡æ€»WALä¿¡æ¯ï¼Œä¸ºå¢é‡å¤‡ä»½æä¾›é«˜æ•ˆçš„æ•°æ®å˜æ›´æ‘˜è¦ã€‚

**å·¥ä½œåŸç†**:

1. **WALæ±‡æ€»**: WAL Summarizerè¿›ç¨‹æŒç»­æ‰«æWALæ–‡ä»¶ï¼Œç”Ÿæˆæ•°æ®å˜æ›´æ‘˜è¦
2. **å¢é‡è¯†åˆ«**: åŸºäºæ‘˜è¦ä¿¡æ¯å¿«é€Ÿè¯†åˆ«éœ€è¦å¤‡ä»½çš„æ•°æ®é¡µ
3. **é«˜æ•ˆå¤‡ä»½**: åªå¤‡ä»½å˜æ›´çš„æ•°æ®é¡µï¼Œå¤§å¹…å‡å°‘å¤‡ä»½æ—¶é—´

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¢é‡å¤‡ä»½é…ç½®
-- postgresql.conf

-- å¯ç”¨WAL Summarizerï¼ˆPostgreSQL 18é»˜è®¤å¯ç”¨ï¼‰
wal_summarizer = on

-- æŸ¥çœ‹WAL SummarizerçŠ¶æ€
SELECT * FROM pg_stat_wal_summarizer;

-- ä½¿ç”¨pg_basebackupè¿›è¡Œå¢é‡å¤‡ä»½
-- PostgreSQL 18æ–°å¢--incrementalé€‰é¡¹
pg_basebackup -D /backup/incremental \
    --incremental \
    --progress \
    --verbose
```

**æ€§èƒ½æå‡**:

- PostgreSQL 17: å…¨é‡å¤‡ä»½ï¼Œè€—æ—¶åŸºå‡†
- PostgreSQL 18: å¢é‡å¤‡ä»½ï¼ŒèŠ‚çœ94%æ—¶é—´
- é¦–æ¬¡å¤‡ä»½åï¼Œåç»­å¤‡ä»½æ—¶é—´å¤§å¹…å‡å°‘
- ç‰¹åˆ«é€‚ç”¨äºå¤§å‹æ•°æ®åº“çš„å®šæœŸå¤‡ä»½

**ä½¿ç”¨åœºæ™¯**:

1. **å®šæœŸå¢é‡å¤‡ä»½**

   ```bash
   # æ¯æ—¥å¢é‡å¤‡ä»½
   pg_basebackup -D /backup/daily/incremental \
       --incremental \
       --progress
   ```

2. **æ—¶é—´ç‚¹æ¢å¤**

   ```bash
   # åŸºäºå¢é‡å¤‡ä»½çš„æ—¶é—´ç‚¹æ¢å¤
   pg_basebackup -D /backup/restore \
       --incremental \
       --target-time="2025-11-22 12:00:00"
   ```

**æœ€ä½³å®è·µ**:

- å®šæœŸæ‰§è¡Œå…¨é‡å¤‡ä»½ä½œä¸ºåŸºå‡†
- ä½¿ç”¨å¢é‡å¤‡ä»½è¿›è¡Œæ—¥å¸¸å¤‡ä»½
- ç›‘æ§WAL Summarizerè¿›ç¨‹çŠ¶æ€
- PostgreSQL 18çš„å¢é‡å¤‡ä»½ç‰¹åˆ«é€‚ç”¨äºå¤§å‹æ•°æ®åº“ï¼ˆTBçº§åˆ«ï¼‰

### 8.1 è¡¨ç©ºé—´ç®¡ç†

```sql
-- åˆ›å»ºè¡¨ç©ºé—´
CREATE TABLESPACE fastspace LOCATION '/fast/disk/postgresql';

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨
CREATE TABLE large_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) TABLESPACE fastspace;

-- ç§»åŠ¨è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE large_table SET TABLESPACE fastspace;

-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    t.spcname,
    pg_size_pretty(pg_tablespace_size(t.spcname)) as size
FROM pg_tablespace t;
```

#### 8.1.1 è¡¨ç©ºé—´è®¾è®¡åŸåˆ™

**è¡¨ç©ºé—´çš„ä½œç”¨**:

è¡¨ç©ºé—´å…è®¸å°†æ•°æ®åº“å¯¹è±¡å­˜å‚¨åœ¨ä¸åŒçš„ç‰©ç†ä½ç½®ï¼Œå®ç°æ•°æ®åˆ†ç¦»å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

**è¡¨ç©ºé—´è®¾è®¡ç­–ç•¥**:

1. **æŒ‰æ€§èƒ½éœ€æ±‚åˆ†ç¦»**
   - çƒ­ç‚¹æ•°æ®æ”¾åœ¨å¿«é€Ÿå­˜å‚¨ï¼ˆSSD/NVMeï¼‰
   - å†·æ•°æ®æ”¾åœ¨æ…¢é€Ÿå­˜å‚¨ï¼ˆHDDï¼‰
   - ç´¢å¼•å’Œè¡¨åˆ†ç¦»å­˜å‚¨

    ```sql
    -- åˆ›å»ºä¸åŒæ€§èƒ½çš„è¡¨ç©ºé—´
    CREATE TABLESPACE fast_ssd LOCATION '/fast/ssd/postgresql';
    CREATE TABLESPACE slow_hdd LOCATION '/slow/hdd/postgresql';
    CREATE TABLESPACE index_space LOCATION '/fast/ssd/postgresql_indexes';

    -- åœ¨å¿«é€Ÿå­˜å‚¨åˆ›å»ºçƒ­ç‚¹è¡¨
    CREATE TABLE hot_data (
        id SERIAL PRIMARY KEY,
        data TEXT,
        created_at TIMESTAMP DEFAULT NOW()
    ) TABLESPACE fast_ssd;

    -- åœ¨æ…¢é€Ÿå­˜å‚¨åˆ›å»ºå½’æ¡£è¡¨
    CREATE TABLE archive_data (
        id SERIAL PRIMARY KEY,
        data TEXT,
        archived_at TIMESTAMP DEFAULT NOW()
    ) TABLESPACE slow_hdd;

    -- ç´¢å¼•æ”¾åœ¨ç‹¬ç«‹è¡¨ç©ºé—´
    CREATE INDEX idx_hot_data_created ON hot_data(created_at) TABLESPACE index_space;
    ```

2. **æŒ‰ä¸šåŠ¡é€»è¾‘åˆ†ç¦»**
   - ä¸åŒä¸šåŠ¡æ¨¡å—ä½¿ç”¨ä¸åŒè¡¨ç©ºé—´
   - ä¾¿äºå¤‡ä»½å’Œæ¢å¤ç®¡ç†
   - æ”¯æŒè¡¨ç©ºé—´çº§åˆ«çš„æƒé™æ§åˆ¶

    ```sql
    -- æŒ‰ä¸šåŠ¡æ¨¡å—åˆ›å»ºè¡¨ç©ºé—´
    CREATE TABLESPACE finance_data LOCATION '/data/finance';
    CREATE TABLESPACE hr_data LOCATION '/data/hr';
    CREATE TABLESPACE log_data LOCATION '/data/logs';

    -- è´¢åŠ¡æ•°æ®è¡¨
    CREATE TABLE financial_transactions (
        id SERIAL PRIMARY KEY,
        amount DECIMAL(10,2),
        transaction_date DATE
    ) TABLESPACE finance_data;

    -- HRæ•°æ®è¡¨
    CREATE TABLE employee_records (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100),
        salary DECIMAL(10,2)
    ) TABLESPACE hr_data;
    ```

#### 8.1.2 è¡¨ç©ºé—´è¿ç§»ç­–ç•¥

**è¿ç§»åœºæ™¯**:

1. **æ€§èƒ½ä¼˜åŒ–è¿ç§»**: å°†è¡¨ä»æ…¢é€Ÿå­˜å‚¨è¿ç§»åˆ°å¿«é€Ÿå­˜å‚¨
2. **å­˜å‚¨ç©ºé—´ç®¡ç†**: å¹³è¡¡ä¸åŒå­˜å‚¨è®¾å¤‡çš„ä½¿ç”¨
3. **å¤‡ä»½æ¢å¤**: è¡¨ç©ºé—´çº§åˆ«çš„å¤‡ä»½å’Œæ¢å¤

**è¿ç§»æ–¹æ³•**:

```sql
-- æ–¹æ³•1: ä½¿ç”¨ALTER TABLEç§»åŠ¨è¡¨
ALTER TABLE large_table SET TABLESPACE fast_ssd;

-- æ–¹æ³•2: ä½¿ç”¨pg_restoreæ¢å¤è¡¨åˆ°æ–°è¡¨ç©ºé—´
-- pg_restore -t large_table -d database_name backup.dump

-- æ–¹æ³•3: ä½¿ç”¨CREATE TABLE ASå¤åˆ¶æ•°æ®
CREATE TABLE large_table_new (LIKE large_table INCLUDING ALL) TABLESPACE fast_ssd;
INSERT INTO large_table_new SELECT * FROM large_table;
ALTER TABLE large_table RENAME TO large_table_old;
ALTER TABLE large_table_new RENAME TO large_table;
DROP TABLE large_table_old;
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:

```sql
-- 1. æ£€æŸ¥è¡¨ç©ºé—´å¯ç”¨ç©ºé—´
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) as current_size,
    pg_size_pretty(pg_tablespace_size(spcname) * 1.2) as recommended_free_space
FROM pg_tablespace;

-- 2. è¿ç§»å‰é”å®šè¡¨ï¼ˆå¯é€‰ï¼‰
LOCK TABLE large_table IN ACCESS EXCLUSIVE MODE;

-- 3. è¿ç§»åæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE large_table;

-- 4. éªŒè¯è¿ç§»ç»“æœ
SELECT
    schemaname,
    tablename,
    tablespace
FROM pg_tables
WHERE tablename = 'large_table';
```

#### 8.1.3 è¡¨ç©ºé—´æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**:

1. **I/Oåˆ†ç¦»**: å°†é¢‘ç¹è®¿é—®çš„è¡¨å’Œç´¢å¼•åˆ†ç¦»åˆ°ä¸åŒè¡¨ç©ºé—´

    ```sql
    -- è¡¨æ”¾åœ¨ä¸»è¡¨ç©ºé—´
    CREATE TABLE orders (
        id SERIAL PRIMARY KEY,
        customer_id INTEGER,
        order_date DATE,
        amount DECIMAL(10,2)
    ) TABLESPACE fast_ssd;

    -- ç´¢å¼•æ”¾åœ¨ç‹¬ç«‹è¡¨ç©ºé—´ï¼ˆå¦‚æœI/Oåˆ†ç¦»ï¼‰
    CREATE INDEX idx_orders_customer ON orders(customer_id) TABLESPACE index_space;
    CREATE INDEX idx_orders_date ON orders(order_date) TABLESPACE index_space;
    ```

2. **è¡¨ç©ºé—´ç›‘æ§**:

    ```sql
    -- ç›‘æ§è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
    SELECT
        t.spcname as tablespace_name,
        pg_size_pretty(pg_tablespace_size(t.spcname)) as size,
        COUNT(c.oid) as table_count,
        pg_size_pretty(SUM(pg_total_relation_size(c.oid))) as total_table_size
    FROM pg_tablespace t
    LEFT JOIN pg_class c ON c.reltablespace = t.oid
    WHERE t.spcname NOT IN ('pg_default', 'pg_global')
    GROUP BY t.spcname, t.oid
    ORDER BY pg_tablespace_size(t.spcname) DESC;

    -- ç›‘æ§è¡¨ç©ºé—´I/Oæ€§èƒ½ï¼ˆPostgreSQL 18ï¼‰
    SELECT
        object,
        context,
        reads,
        writes,
        read_time,
        write_time
    FROM pg_stat_io
    WHERE object LIKE '%tablespace%'
    ORDER BY reads DESC;
    ```

3. **è¡¨ç©ºé—´ç»´æŠ¤**:

    ```sql
    -- æ¸…ç†æœªä½¿ç”¨çš„è¡¨ç©ºé—´
    DROP TABLESPACE IF EXISTS old_tablespace;

    -- é‡å‘½åè¡¨ç©ºé—´
    ALTER TABLESPACE old_name RENAME TO new_name;

    -- è®¾ç½®è¡¨ç©ºé—´æ‰€æœ‰è€…
    ALTER TABLESPACE tablespace_name OWNER TO new_owner;
    ```

### 8.2 åˆ†åŒºè¡¨ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE sales (
    id SERIAL,
    sale_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2023 PARTITION OF sales
FOR VALUES FROM ('2023-01-01') TO ('2024-01-01')
TABLESPACE fastspace;

CREATE TABLE sales_2024 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01')
TABLESPACE fastspace;

-- æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE tablename LIKE 'sales_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### 8.2.1 åˆ†åŒºç­–ç•¥é€‰æ‹©

**åˆ†åŒºç±»å‹**:

1. **èŒƒå›´åˆ†åŒºï¼ˆRANGEï¼‰**: é€‚ç”¨äºæ—¶é—´åºåˆ—æ•°æ®ã€æ•°å€¼èŒƒå›´

    ```sql
    -- æŒ‰æ—¥æœŸèŒƒå›´åˆ†åŒº
    CREATE TABLE log_entries (
        id BIGSERIAL,
        log_time TIMESTAMP NOT NULL,
        level VARCHAR(10),
        message TEXT
    ) PARTITION BY RANGE (log_time);

    -- æŒ‰æœˆåˆ›å»ºåˆ†åŒº
    CREATE TABLE log_entries_2024_01 PARTITION OF log_entries
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

    CREATE TABLE log_entries_2024_02 PARTITION OF log_entries
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

    -- æŒ‰æ•°å€¼èŒƒå›´åˆ†åŒº
    CREATE TABLE sales (
        id SERIAL,
        sale_date DATE,
        amount DECIMAL(10,2)
    ) PARTITION BY RANGE (amount);

    CREATE TABLE sales_low PARTITION OF sales
    FOR VALUES FROM (0) TO (1000);

    CREATE TABLE sales_medium PARTITION OF sales
    FOR VALUES FROM (1000) TO (10000);

    CREATE TABLE sales_high PARTITION OF sales
    FOR VALUES FROM (10000) TO (MAXVALUE);
    ```

2. **åˆ—è¡¨åˆ†åŒºï¼ˆLISTï¼‰**: é€‚ç”¨äºç¦»æ•£å€¼åˆ†ç±»

    ```sql
    -- æŒ‰åœ°åŒºåˆ—è¡¨åˆ†åŒº
    CREATE TABLE customers (
        id SERIAL,
        name VARCHAR(100),
        region VARCHAR(50),
        email VARCHAR(100)
    ) PARTITION BY LIST (region);

    CREATE TABLE customers_north PARTITION OF customers
    FOR VALUES IN ('Beijing', 'Tianjin', 'Hebei');

    CREATE TABLE customers_south PARTITION OF customers
    FOR VALUES IN ('Guangdong', 'Guangxi', 'Hainan');

    CREATE TABLE customers_other PARTITION OF customers
    DEFAULT;
    ```

3. **å“ˆå¸Œåˆ†åŒºï¼ˆHASHï¼‰**: é€‚ç”¨äºå‡åŒ€åˆ†å¸ƒæ•°æ®

    ```sql
    -- æŒ‰å“ˆå¸Œå€¼åˆ†åŒº
    CREATE TABLE user_sessions (
        id SERIAL,
        user_id INTEGER,
        session_data TEXT,
        created_at TIMESTAMP
    ) PARTITION BY HASH (user_id);

    -- åˆ›å»º4ä¸ªå“ˆå¸Œåˆ†åŒº
    CREATE TABLE user_sessions_0 PARTITION OF user_sessions
    FOR VALUES WITH (MODULUS 4, REMAINDER 0);

    CREATE TABLE user_sessions_1 PARTITION OF user_sessions
    FOR VALUES WITH (MODULUS 4, REMAINDER 1);

    CREATE TABLE user_sessions_2 PARTITION OF user_sessions
    FOR VALUES WITH (MODULUS 4, REMAINDER 2);

    CREATE TABLE user_sessions_3 PARTITION OF user_sessions
    FOR VALUES WITH (MODULUS 4, REMAINDER 3);
    ```

#### 8.2.2 åˆ†åŒºè£å‰ªæœºåˆ¶

**åˆ†åŒºè£å‰ªåŸç†**:

PostgreSQLä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ¡ä»¶ï¼Œåªæ‰«æç›¸å…³çš„åˆ†åŒºï¼Œå¤§å¹…æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

```sql
-- æŸ¥è¯¢ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ•°æ®ï¼ˆåªæ‰«æç›¸å…³åˆ†åŒºï¼‰
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM log_entries
WHERE log_time >= '2024-01-15' AND log_time < '2024-02-15';
-- åªæ‰«æ log_entries_2024_01 å’Œ log_entries_2024_02 åˆ†åŒº

-- æŸ¥çœ‹åˆ†åŒºè£å‰ªæ•ˆæœ
EXPLAIN (ANALYZE, VERBOSE)
SELECT COUNT(*) FROM sales
WHERE sale_date BETWEEN '2024-01-01' AND '2024-03-31';
-- åªæ‰«æç›¸å…³æœˆä»½çš„åˆ†åŒº

-- åˆ†åŒºè£å‰ªå¤±è´¥çš„æƒ…å†µï¼ˆéœ€è¦é¿å…ï¼‰
EXPLAIN (ANALYZE)
SELECT * FROM log_entries
WHERE EXTRACT(YEAR FROM log_time) = 2024;
-- æ— æ³•è£å‰ªï¼Œä¼šæ‰«ææ‰€æœ‰åˆ†åŒºï¼ˆåº”æ”¹ä¸ºèŒƒå›´æŸ¥è¯¢ï¼‰
```

**ä¼˜åŒ–åˆ†åŒºè£å‰ª**:

```sql
-- 1. ä½¿ç”¨èŒƒå›´æŸ¥è¯¢è€Œéå‡½æ•°
-- é”™è¯¯ï¼šæ— æ³•è£å‰ª
SELECT * FROM log_entries WHERE DATE_TRUNC('month', log_time) = '2024-01-01';

-- æ­£ç¡®ï¼šå¯ä»¥è£å‰ª
SELECT * FROM log_entries
WHERE log_time >= '2024-01-01' AND log_time < '2024-02-01';

-- 2. åœ¨åˆ†åŒºé”®ä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_log_entries_time ON log_entries(log_time);

-- 3. ä½¿ç”¨çº¦æŸæ’é™¤ä¼˜åŒ–
SET constraint_exclusion = partition;  -- é»˜è®¤å€¼
```

#### 8.2.3 åˆ†åŒºç»´æŠ¤æ“ä½œ

**åˆ†åŒºç®¡ç†**:

```sql
-- 1. æ·»åŠ æ–°åˆ†åŒº
CREATE TABLE log_entries_2024_03 PARTITION OF log_entries
FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

-- 2. åˆ é™¤æ—§åˆ†åŒºï¼ˆæ•°æ®ä¼šä¸€èµ·åˆ é™¤ï¼‰
DROP TABLE log_entries_2023_12;

-- 3. åˆ†ç¦»åˆ†åŒºï¼ˆä¿ç•™æ•°æ®ï¼Œä½†ä¸å†å±äºåˆ†åŒºè¡¨ï¼‰
ALTER TABLE log_entries DETACH PARTITION log_entries_2023_12;

-- 4. é™„åŠ åˆ†åŒº
ALTER TABLE log_entries ATTACH PARTITION log_entries_2023_12
FOR VALUES FROM ('2023-12-01') TO ('2024-01-01');

-- 5. åˆ†åŒºç´¢å¼•ç®¡ç†
CREATE INDEX idx_log_entries_level ON log_entries(level);
-- ç´¢å¼•ä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰åˆ†åŒºä¸Šåˆ›å»º

-- 6. æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_stat_get_tuples_returned(c.oid) as row_count
FROM pg_tables t
JOIN pg_class c ON c.relname = t.tablename
WHERE tablename LIKE 'log_entries_%'
ORDER BY tablename;
```

**è‡ªåŠ¨åˆ†åŒºç®¡ç†å‡½æ•°**:

```sql
-- è‡ªåŠ¨åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE OR REPLACE FUNCTION create_monthly_partition(
    parent_table text,
    partition_date date
) RETURNS void AS $$
DECLARE
    partition_name text;
    start_date date;
    end_date date;
BEGIN
    start_date := date_trunc('month', partition_date);
    end_date := start_date + interval '1 month';
    partition_name := parent_table || '_' || to_char(start_date, 'YYYY_MM');

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
        partition_name, parent_table, start_date, end_date
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT create_monthly_partition('log_entries', '2024-04-01');

-- è‡ªåŠ¨æ¸…ç†æ—§åˆ†åŒº
CREATE OR REPLACE FUNCTION drop_old_partitions(
    parent_table text,
    retention_months integer DEFAULT 12
) RETURNS void AS $$
DECLARE
    partition_record record;
    cutoff_date date;
BEGIN
    cutoff_date := date_trunc('month', CURRENT_DATE - (retention_months || ' months')::interval);

    FOR partition_record IN
        SELECT tablename
        FROM pg_tables
        WHERE tablename LIKE parent_table || '_%'
        AND tablename < parent_table || '_' || to_char(cutoff_date, 'YYYY_MM')
    LOOP
        EXECUTE format('DROP TABLE IF EXISTS %I', partition_record.tablename);
        RAISE NOTICE 'Dropped partition: %', partition_record.tablename;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹ï¼šåˆ é™¤12ä¸ªæœˆå‰çš„åˆ†åŒº
SELECT drop_old_partitions('log_entries', 12);
```

### 8.3 å‹ç¼©å’ŒTOAST

```sql
-- æŸ¥çœ‹TOASTè¡¨
SELECT
    c.relname,
    t.relname as toast_table,
    pg_size_pretty(pg_total_relation_size(t.oid)) as toast_size
FROM pg_class c
JOIN pg_class t ON t.oid = c.reltoastrelid
WHERE c.relkind = 'r'
ORDER BY pg_total_relation_size(t.oid) DESC;

-- å‹ç¼©é…ç½®
ALTER TABLE large_table SET (toast_tuple_target = 128);
ALTER TABLE large_table SET (fillfactor = 80);
```

#### 8.3.1 TOASTæœºåˆ¶è¯¦è§£

**TOASTå·¥ä½œåŸç†**:

TOAST (The Oversized-Attribute Storage Technique) æ˜¯PostgreSQLå¤„ç†å¤§å­—æ®µçš„æœºåˆ¶ã€‚å½“è¡Œæ•°æ®è¶…è¿‡é¡µé¢å¤§å°ï¼ˆé»˜è®¤8KBï¼‰æ—¶ï¼Œå¤§å­—æ®µä¼šè¢«å‹ç¼©å¹¶å­˜å‚¨åˆ°ç‹¬ç«‹çš„TOASTè¡¨ä¸­ã€‚

**TOASTå­˜å‚¨ç­–ç•¥**:

```sql
-- æŸ¥çœ‹è¡¨çš„TOASTå­˜å‚¨ç­–ç•¥
SELECT
    c.relname,
    a.attname,
    CASE a.attstorage
        WHEN 'p' THEN 'plain'      -- ä¸å‹ç¼©ï¼Œå†…è”å­˜å‚¨
        WHEN 'e' THEN 'external'   -- ä¸å‹ç¼©ï¼Œå¤–éƒ¨å­˜å‚¨
        WHEN 'm' THEN 'main'       -- å‹ç¼©ï¼Œä¼˜å…ˆå†…è”
        WHEN 'x' THEN 'extended'   -- å‹ç¼©ï¼Œä¼˜å…ˆå¤–éƒ¨ï¼ˆé»˜è®¤ï¼‰
    END as storage_strategy
FROM pg_class c
JOIN pg_attribute a ON a.attrelid = c.oid
WHERE c.relname = 'large_table'
AND a.attnum > 0
AND NOT a.attisdropped;
```

**TOASTé…ç½®å‚æ•°**:

```sql
-- 1. toast_tuple_target: TOASTè§¦å‘é˜ˆå€¼ï¼ˆé»˜è®¤2048å­—èŠ‚ï¼‰
ALTER TABLE large_table SET (toast_tuple_target = 128);
-- è¾ƒå°çš„å€¼ä¼šæ›´å¿«è§¦å‘TOASTï¼Œä½†å¯èƒ½å¢åŠ TOASTè¡¨å¤§å°

-- 2. fillfactor: é¡µé¢å¡«å……å› å­ï¼ˆé»˜è®¤100ï¼‰
ALTER TABLE large_table SET (fillfactor = 80);
-- è¾ƒå°çš„å€¼é¢„ç•™ç©ºé—´ç”¨äºUPDATEï¼Œå‡å°‘é¡µé¢åˆ†è£‚

-- 3. åˆ—çº§å­˜å‚¨ç­–ç•¥
ALTER TABLE large_table ALTER COLUMN large_text SET STORAGE EXTENDED;
-- EXTENDED: å‹ç¼©+å¤–éƒ¨å­˜å‚¨ï¼ˆé»˜è®¤ï¼Œé€‚åˆå¤§æ–‡æœ¬ï¼‰
-- MAIN: å‹ç¼©+ä¼˜å…ˆå†…è”ï¼ˆé€‚åˆä¸­ç­‰æ–‡æœ¬ï¼‰
-- EXTERNAL: ä¸å‹ç¼©+å¤–éƒ¨å­˜å‚¨ï¼ˆé€‚åˆå·²å‹ç¼©æ•°æ®ï¼‰
-- PLAIN: ä¸å‹ç¼©+å†…è”å­˜å‚¨ï¼ˆé€‚åˆå°æ•°æ®ï¼‰
```

**TOASTæ€§èƒ½ä¼˜åŒ–**:

```sql
-- 1. ç›‘æ§TOASTè¡¨å¤§å°
SELECT
    c.relname as table_name,
    t.relname as toast_table,
    pg_size_pretty(pg_total_relation_size(c.oid)) as table_size,
    pg_size_pretty(pg_total_relation_size(t.oid)) as toast_size,
    round(100.0 * pg_total_relation_size(t.oid) /
          NULLIF(pg_total_relation_size(c.oid), 0), 2) as toast_ratio
FROM pg_class c
JOIN pg_class t ON t.oid = c.reltoastrelid
WHERE c.relkind = 'r'
AND pg_total_relation_size(t.oid) > 0
ORDER BY pg_total_relation_size(t.oid) DESC;

-- 2. åˆ†æTOASTä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) as toast_size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio
FROM pg_stat_user_tables
WHERE pg_total_relation_size(schemaname||'.'||tablename) >
      pg_relation_size(schemaname||'.'||tablename)
ORDER BY (pg_total_relation_size(schemaname||'.'||tablename) -
          pg_relation_size(schemaname||'.'||tablename)) DESC;

-- 3. TOASTå‹ç¼©æ•ˆæœåˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as uncompressed_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    round(100.0 * (1 - pg_total_relation_size(schemaname||'.'||tablename) /
                   NULLIF(pg_relation_size(schemaname||'.'||tablename), 0)), 2) as compression_ratio
FROM pg_stat_user_tables
WHERE pg_total_relation_size(schemaname||'.'||tablename) <
      pg_relation_size(schemaname||'.'||tablename);
```

**TOASTä¼˜åŒ–æœ€ä½³å®è·µ**:

```sql
-- 1. å¯¹äºé¢‘ç¹æŸ¥è¯¢çš„å¤§å­—æ®µï¼Œè€ƒè™‘åˆ†ç¦»å­˜å‚¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    metadata JSONB,  -- å°å­—æ®µï¼Œå†…è”å­˜å‚¨
    content TEXT     -- å¤§å­—æ®µï¼ŒTOASTå­˜å‚¨
);

-- 2. å¯¹äºå·²å‹ç¼©çš„æ•°æ®ï¼ˆå¦‚JSONBï¼‰ï¼Œä½¿ç”¨EXTERNALç­–ç•¥é¿å…é‡å¤å‹ç¼©
ALTER TABLE documents ALTER COLUMN metadata SET STORAGE EXTERNAL;

-- 3. å®šæœŸVACUUM TOASTè¡¨
VACUUM ANALYZE large_table;

-- 4. ç›‘æ§TOASTè¡¨è†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE pg_total_relation_size(schemaname||'.'||tablename) > 1000000000  -- 1GB
ORDER BY n_dead_tup DESC;
```

---

## ä¹ã€æ€§èƒ½ç›‘æ§

### 9.1 I/Oæ€§èƒ½ç›‘æ§

```sql
-- æ•°æ®åº“I/Oç»Ÿè®¡
SELECT
    datname,
    blks_read,
    blks_hit,
    round(100.0 * blks_hit / (blks_hit + blks_read), 2) as hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname = current_database();

-- è¡¨I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as heap_hit_ratio,
    round(100.0 * idx_blks_hit / (idx_blks_hit + idx_blks_read), 2) as idx_hit_ratio
FROM pg_statio_user_tables
ORDER BY heap_blks_read + heap_blks_hit DESC;
```

#### 9.1.1 I/Oç›‘æ§æŒ‡æ ‡è¯¦è§£

**å…³é”®I/OæŒ‡æ ‡**:

1. **ç¼“å†²åŒºå‘½ä¸­ç‡**: åæ˜ ç¼“å­˜æ•ˆç‡ï¼Œç›®æ ‡>99%

```sql
-- å…¨å±€ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as global_hit_ratio
FROM pg_stat_database;

-- è¡¨çº§ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) as heap_hit_ratio,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) as idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 1000
ORDER BY heap_blks_read DESC
LIMIT 20;
```

1. **I/Oç­‰å¾…æ—¶é—´** (PostgreSQL 18):

```sql
-- æŸ¥çœ‹I/Oç­‰å¾…ç»Ÿè®¡
SELECT
    object,
    context,
    reads,
    writes,
    read_time,
    write_time,
    round(read_time / NULLIF(reads, 0), 2) as avg_read_time_ms,
    round(write_time / NULLIF(writes, 0), 2) as avg_write_time_ms
FROM pg_stat_io
WHERE reads > 0 OR writes > 0
ORDER BY reads + writes DESC;
```

1. **WAL I/Oç»Ÿè®¡**:

```sql
-- WALå†™å…¥æ€§èƒ½
SELECT
    wal_records,
    wal_write,
    wal_sync,
    wal_bytes,
    wal_write_time,
    wal_sync_time,
    round(wal_write_time / NULLIF(wal_write, 0), 2) as avg_write_time_ms,
    round(wal_sync_time / NULLIF(wal_sync, 0), 2) as avg_sync_time_ms
FROM pg_stat_wal;
```

#### 9.1.2 I/Oé—®é¢˜è¯Šæ–­

**å¸¸è§I/Oé—®é¢˜**:

1. **ç¼“å†²åŒºå‘½ä¸­ç‡ä½**:

```sql
-- è¯†åˆ«ä½å‘½ä¸­ç‡è¡¨
SELECT
    schemaname,
    tablename,
    round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) as hit_ratio,
    heap_blks_read,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 1000
AND round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) < 95
ORDER BY heap_blks_read DESC;

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. å¢åŠ shared_buffers
-- 2. ä¼˜åŒ–æŸ¥è¯¢å‡å°‘å…¨è¡¨æ‰«æ
-- 3. ä½¿ç”¨è¡¨ç©ºé—´å°†çƒ­ç‚¹æ•°æ®æ”¾åœ¨å¿«é€Ÿå­˜å‚¨
```

1. **I/Oç­‰å¾…æ—¶é—´é•¿**:

```sql
-- è¯†åˆ«I/Oç“¶é¢ˆ
SELECT
    object,
    context,
    reads,
    read_time,
    round(read_time / NULLIF(reads, 0), 2) as avg_read_ms
FROM pg_stat_io
WHERE reads > 1000
AND round(read_time / NULLIF(reads, 0), 2) > 10  -- å¹³å‡è¯»å–æ—¶é—´>10ms
ORDER BY read_time DESC;

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. æ£€æŸ¥å­˜å‚¨è®¾å¤‡æ€§èƒ½
-- 2. è°ƒæ•´effective_io_concurrencyï¼ˆPostgreSQL 18ï¼‰
-- 3. ä¼˜åŒ–æŸ¥è¯¢å‡å°‘I/O
```

### 9.2 å­˜å‚¨æ€§èƒ½åˆ†æ

```sql
-- å­˜å‚¨ä½¿ç”¨åˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size,
    round(100.0 * pg_indexes_size(schemaname||'.'||tablename) / pg_total_relation_size(schemaname||'.'||tablename), 2) as index_ratio
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### 9.2.1 å­˜å‚¨ä½¿ç”¨åˆ†æ

**å­˜å‚¨åˆ†ææŸ¥è¯¢**:

```sql
-- 1. æ•°æ®åº“å¤§å°åˆ†æ
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size,
    pg_size_pretty(pg_database_size(datname) -
                   (SELECT sum(pg_total_relation_size(schemaname||'.'||tablename))
                    FROM pg_tables
                    WHERE schemaname NOT IN ('pg_catalog', 'information_schema'))) as other_size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- 2. è¡¨ç©ºé—´ä½¿ç”¨åˆ†æ
SELECT
    t.spcname as tablespace,
    pg_size_pretty(pg_tablespace_size(t.spcname)) as total_size,
    COUNT(c.oid) as table_count,
    pg_size_pretty(SUM(pg_total_relation_size(c.oid))) as used_size,
    round(100.0 * SUM(pg_total_relation_size(c.oid)) /
          NULLIF(pg_tablespace_size(t.spcname), 0), 2) as usage_ratio
FROM pg_tablespace t
LEFT JOIN pg_class c ON c.reltablespace = t.oid AND c.relkind = 'r'
WHERE t.spcname NOT IN ('pg_default', 'pg_global')
GROUP BY t.spcname, t.oid
ORDER BY pg_tablespace_size(t.spcname) DESC;

-- 3. è¡¨è†¨èƒ€åˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

#### 9.2.2 å­˜å‚¨ä¼˜åŒ–å»ºè®®

**ä¼˜åŒ–ç­–ç•¥**:

```sql
-- 1. è¯†åˆ«å¤§è¡¨
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    n_live_tup,
    round(pg_total_relation_size(schemaname||'.'||tablename) /
          NULLIF(n_live_tup, 0), 0) as bytes_per_row
FROM pg_stat_user_tables
WHERE pg_total_relation_size(schemaname||'.'||tablename) > 1000000000  -- 1GB
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 2. è¯†åˆ«æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(schemaname||'.'||indexname)) as index_size,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND pg_relation_size(schemaname||'.'||indexname) > 1000000  -- 1MB
ORDER BY pg_relation_size(schemaname||'.'||indexname) DESC;

-- 3. è¯†åˆ«éœ€è¦VACUUMçš„è¡¨
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio,
    last_vacuum,
    last_autovacuum,
    CASE
        WHEN last_vacuum IS NULL AND last_autovacuum IS NULL THEN 'Never vacuumed'
        WHEN last_vacuum > last_autovacuum THEN last_vacuum::text
        ELSE last_autovacuum::text
    END as last_vacuum_time
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

---

## åã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–

```sql
-- å¤§è¡¨åˆ†åŒºç­–ç•¥
CREATE TABLE log_entries (
    id BIGSERIAL,
    log_time TIMESTAMP,
    level VARCHAR(10),
    message TEXT,
    source VARCHAR(100)
) PARTITION BY RANGE (log_time);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE log_entries_2024_01 PARTITION OF log_entries
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE log_entries_2024_02 PARTITION OF log_entries
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';

    EXECUTE format('CREATE TABLE %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

#### 10.1.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

**åœºæ™¯**: æ—¥å¿—ç³»ç»Ÿï¼Œæ¯å¤©äº§ç”Ÿæ•°åƒä¸‡æ¡è®°å½•ï¼Œéœ€è¦é•¿æœŸå­˜å‚¨å’Œå¿«é€ŸæŸ¥è¯¢ã€‚

**å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE application_logs (
    id BIGSERIAL,
    log_time TIMESTAMP NOT NULL,
    level VARCHAR(10) NOT NULL,
    application VARCHAR(50),
    module VARCHAR(50),
    message TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
) PARTITION BY RANGE (log_time);

-- 2. åˆ›å»ºç´¢å¼•ï¼ˆè‡ªåŠ¨åœ¨æ‰€æœ‰åˆ†åŒºä¸Šåˆ›å»ºï¼‰
CREATE INDEX idx_logs_time ON application_logs(log_time);
CREATE INDEX idx_logs_level ON application_logs(level);
CREATE INDEX idx_logs_app ON application_logs(application);
CREATE INDEX idx_logs_metadata ON application_logs USING GIN(metadata);

-- 3. ä½¿ç”¨è¡¨ç©ºé—´åˆ†ç¦»çƒ­ç‚¹å’Œå†·æ•°æ®
CREATE TABLESPACE logs_hot LOCATION '/fast/ssd/logs';
CREATE TABLESPACE logs_cold LOCATION '/slow/hdd/logs';

-- 4. è‡ªåŠ¨åˆ†åŒºåˆ›å»ºå‡½æ•°
CREATE OR REPLACE FUNCTION create_log_partition(partition_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    start_date date;
    end_date date;
    tablespace_name text;
BEGIN
    start_date := date_trunc('month', partition_date);
    end_date := start_date + interval '1 month';
    partition_name := 'application_logs_' || to_char(start_date, 'YYYY_MM');

    -- æœ€è¿‘3ä¸ªæœˆçš„æ•°æ®æ”¾åœ¨å¿«é€Ÿå­˜å‚¨ï¼Œå…¶ä»–æ”¾åœ¨æ…¢é€Ÿå­˜å‚¨
    IF start_date >= CURRENT_DATE - interval '3 months' THEN
        tablespace_name := 'logs_hot';
    ELSE
        tablespace_name := 'logs_cold';
    END IF;

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF application_logs '
        'FOR VALUES FROM (%L) TO (%L) TABLESPACE %I',
        partition_name, start_date, end_date, tablespace_name
    );

    RAISE NOTICE 'Created partition % in tablespace %', partition_name, tablespace_name;
END;
$$ LANGUAGE plpgsql;

-- 5. è‡ªåŠ¨æ¸…ç†æ—§åˆ†åŒº
CREATE OR REPLACE FUNCTION cleanup_old_log_partitions(retention_months integer DEFAULT 12)
RETURNS void AS $$
DECLARE
    partition_record record;
    cutoff_date date;
BEGIN
    cutoff_date := date_trunc('month', CURRENT_DATE - (retention_months || ' months')::interval);

    FOR partition_record IN
        SELECT tablename
        FROM pg_tables
        WHERE tablename LIKE 'application_logs_%'
        AND tablename < 'application_logs_' || to_char(cutoff_date, 'YYYY_MM')
    LOOP
        EXECUTE format('DROP TABLE IF EXISTS %I', partition_record.tablename);
        RAISE NOTICE 'Dropped old partition: %', partition_record.tablename;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 6. ä½¿ç”¨ç¤ºä¾‹
-- åˆ›å»ºæœªæ¥3ä¸ªæœˆçš„åˆ†åŒº
SELECT create_log_partition(CURRENT_DATE);
SELECT create_log_partition(CURRENT_DATE + interval '1 month');
SELECT create_log_partition(CURRENT_DATE + interval '2 months');

-- å®šæœŸæ¸…ç†ï¼ˆé€šè¿‡cronæˆ–pg_cronï¼‰
SELECT cleanup_old_log_partitions(12);

-- 7. æŸ¥è¯¢ä¼˜åŒ–ï¼ˆåˆ©ç”¨åˆ†åŒºè£å‰ªï¼‰
EXPLAIN (ANALYZE, BUFFERS)
SELECT level, COUNT(*) as count
FROM application_logs
WHERE log_time >= CURRENT_DATE - interval '7 days'
AND level = 'ERROR'
GROUP BY level;
-- åªæ‰«ææœ€è¿‘çš„åˆ†åŒº

-- 8. ç›‘æ§åˆ†åŒºä½¿ç”¨æƒ…å†µ
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_stat_get_tuples_returned(c.oid) as row_count,
    pg_stat_get_tuples_inserted(c.oid) as inserts
FROM pg_tables t
JOIN pg_class c ON c.relname = t.tablename
WHERE tablename LIKE 'application_logs_%'
ORDER BY tablename DESC;
```

**æ€§èƒ½ä¼˜åŒ–é…ç½®**:

```sql
-- postgresql.confä¼˜åŒ–
shared_buffers = 4GB              -- å¢åŠ ç¼“å†²åŒº
effective_cache_size = 12GB       -- æœ‰æ•ˆç¼“å­˜å¤§å°
work_mem = 64MB                   -- å·¥ä½œå†…å­˜
maintenance_work_mem = 1GB        -- ç»´æŠ¤å·¥ä½œå†…å­˜
checkpoint_timeout = 15min         -- æ£€æŸ¥ç‚¹é—´éš”
max_wal_size = 4GB                -- WALå¤§å°
effective_io_concurrency = 200    -- I/Oå¹¶å‘ï¼ˆPostgreSQL 18ï¼ŒSSDï¼‰
```

### 10.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–

```sql
-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
BEGIN;
INSERT INTO large_table (col1, col2, col3)
SELECT
    generate_series(1, 1000000),
    'data' || generate_series(1, 1000000),
    random() * 1000;
COMMIT;

-- å¹¶è¡Œå†™å…¥ä¼˜åŒ–
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;
SET parallel_setup_cost = 1000;

-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM large_table WHERE col1 > 500000;
```

#### 10.2.1 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

**åœºæ™¯**: ç”µå•†è®¢å•ç³»ç»Ÿï¼Œé«˜å³°æœŸæ¯ç§’æ•°åƒç¬”è®¢å•ï¼Œéœ€è¦ä¿è¯å†™å…¥æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

**å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. è¡¨ç»“æ„ä¼˜åŒ–
CREATE TABLE orders (
    order_id BIGSERIAL,
    user_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    order_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
) WITH (
    fillfactor = 90,              -- é¢„ç•™10%ç©ºé—´ç”¨äºUPDATE
    autovacuum_vacuum_scale_factor = 0.05,  -- æ›´é¢‘ç¹çš„VACUUM
    autovacuum_analyze_scale_factor = 0.02
);

-- 2. ç´¢å¼•ä¼˜åŒ–ï¼ˆå‡å°‘ç´¢å¼•æ•°é‡ï¼Œä½¿ç”¨å¤åˆç´¢å¼•ï¼‰
CREATE INDEX idx_orders_user_created ON orders(user_id, created_at DESC);
CREATE INDEX idx_orders_status_created ON orders(order_status, created_at DESC);
-- é¿å…è¿‡å¤šç´¢å¼•å½±å“å†™å…¥æ€§èƒ½

-- 3. ä½¿ç”¨UNLOGGEDè¡¨å¤„ç†ä¸´æ—¶æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE UNLOGGED TABLE orders_temp (
    LIKE orders INCLUDING ALL
);
-- UNLOGGEDè¡¨ä¸å†™WALï¼Œå†™å…¥é€Ÿåº¦æå‡2-3å€ï¼Œä½†å´©æºƒä¼šä¸¢å¤±æ•°æ®

-- 4. æ‰¹é‡æ’å…¥ä¼˜åŒ–
-- æ–¹æ³•1: ä½¿ç”¨COPYï¼ˆæœ€å¿«ï¼‰
COPY orders (user_id, product_id, quantity, price, order_status)
FROM '/path/to/orders.csv' WITH (FORMAT csv, HEADER);

-- æ–¹æ³•2: ä½¿ç”¨æ‰¹é‡INSERT
INSERT INTO orders (user_id, product_id, quantity, price)
SELECT
    (random() * 10000)::INTEGER,
    (random() * 1000)::INTEGER,
    (random() * 10 + 1)::INTEGER,
    (random() * 1000 + 10)::DECIMAL(10,2)
FROM generate_series(1, 100000);

-- æ–¹æ³•3: ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æäº¤
DO $$
DECLARE
    batch_size integer := 1000;
    total_rows integer := 100000;
    i integer;
BEGIN
    FOR i IN 1..(total_rows / batch_size) LOOP
        INSERT INTO orders (user_id, product_id, quantity, price)
        SELECT
            (random() * 10000)::INTEGER,
            (random() * 1000)::INTEGER,
            (random() * 10 + 1)::INTEGER,
            (random() * 1000 + 10)::DECIMAL(10,2)
        FROM generate_series(1, batch_size);

        COMMIT;
    END LOOP;
END $$;

-- 5. å¼‚æ­¥æäº¤ä¼˜åŒ–ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰
-- å¯¹äºéå…³é”®æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥æäº¤æå‡æ€§èƒ½
ALTER TABLE orders SET (synchronous_commit = off);  -- è°¨æ…ä½¿ç”¨

-- 6. WALä¼˜åŒ–
-- postgresql.conf
wal_buffers = 32MB                 -- å¢åŠ WALç¼“å†²åŒº
wal_compression = on               -- å¯ç”¨WALå‹ç¼©
checkpoint_completion_target = 0.9  -- å¹³æ»‘æ£€æŸ¥ç‚¹

-- 7. è¿æ¥æ± ä¼˜åŒ–
-- ä½¿ç”¨PgBounceræˆ–Pgpool-IIå‡å°‘è¿æ¥å¼€é”€
-- max_connections = 200
-- shared_buffersæ ¹æ®è¿æ¥æ•°è°ƒæ•´

-- 8. ç›‘æ§å†™å…¥æ€§èƒ½
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count
FROM pg_stat_user_tables
WHERE tablename = 'orders';

-- 9. è¯†åˆ«å†™å…¥ç“¶é¢ˆ
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND query LIKE '%INSERT%' OR query LIKE '%UPDATE%';

-- 10. åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆå¦‚æœæ•°æ®é‡å¤§ï¼‰
CREATE TABLE orders_partitioned (
    LIKE orders INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- æŒ‰å¤©åˆ†åŒº
CREATE TABLE orders_2024_01_01 PARTITION OF orders_partitioned
FOR VALUES FROM ('2024-01-01') TO ('2024-01-02');
```

**æ€§èƒ½å¯¹æ¯”**:

- **å•æ¡INSERT**: ~1000 TPS
- **æ‰¹é‡INSERT (1000æ¡)**: ~5000 TPS
- **COPYå‘½ä»¤**: ~10000+ TPS
- **UNLOGGEDè¡¨**: ~20000+ TPSï¼ˆä½†æ— æŒä¹…æ€§ä¿è¯ï¼‰

**æœ€ä½³å®è·µ**:

1. ä½¿ç”¨æ‰¹é‡æ’å…¥è€Œéå•æ¡æ’å…¥
2. åˆç†è®¾ç½®fillfactorå‡å°‘é¡µé¢åˆ†è£‚
3. å‡å°‘ä¸å¿…è¦çš„ç´¢å¼•
4. ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
5. æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åŒæ­¥/å¼‚æ­¥æäº¤
6. å®šæœŸVACUUMä¿æŒè¡¨å¥åº·
7. ç›‘æ§å†™å…¥æ€§èƒ½åŠæ—¶å‘ç°é—®é¢˜

---

## åä¸€ã€ç›¸å…³æ¦‚å¿µ

### 11.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„ç³»ç»Ÿç±»åˆ«
- **å­˜å‚¨ç³»ç»Ÿ**: æ•°æ®æŒä¹…åŒ–æœºåˆ¶
- **æ–‡ä»¶ç³»ç»Ÿ**: åº•å±‚å­˜å‚¨ç®¡ç†

### 11.2 ä¸‹ä½æ¦‚å¿µ

- **ç¼“å†²åŒºç®¡ç†**: å†…å­˜ç¼“å­˜æœºåˆ¶
- **WALæ—¥å¿—**: äº‹åŠ¡æ—¥å¿—ç³»ç»Ÿ
- **æ£€æŸ¥ç‚¹**: æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **é¡µé¢ç®¡ç†**: æ•°æ®é¡µé¢ç»„ç»‡

### 11.3 å¹³è¡Œæ¦‚å¿µ

- **å†…å­˜æ•°æ®åº“**: åŸºäºå†…å­˜çš„å­˜å‚¨
- **åˆ†å¸ƒå¼å­˜å‚¨**: è·¨èŠ‚ç‚¹å­˜å‚¨ç®¡ç†
- **äº‘å­˜å‚¨**: äº‘ç«¯å­˜å‚¨æœåŠ¡

---

## åäºŒã€å‚è€ƒèµ„æº

### 12.1 ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../03-äº‹åŠ¡ä¸å¹¶å‘/03.02-ACIDç‰¹æ€§/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - WALæœºåˆ¶ç†è®ºåŸºç¡€
- [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../03-äº‹åŠ¡ä¸å¹¶å‘/03.01-MVCCæœºåˆ¶/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶å®ç°
- [å¤‡ä»½ä¸æ¢å¤](./å¤‡ä»½ä¸æ¢å¤.md) - æ•°æ®æŒä¹…åŒ–å®è·µ
- [æ€§èƒ½è°ƒä¼˜å®è·µ](../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - å­˜å‚¨æ€§èƒ½ä¼˜åŒ–

### 12.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å®æˆ˜æ¡ˆä¾‹](../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ
- [Dockeréƒ¨ç½²æŒ‡å—](../11-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å­˜å‚¨é…ç½®å®è·µ
- [å¢é‡å¤‡ä»½ä¸æ¢å¤](../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - PostgreSQL 18å¢é‡å¤‡ä»½

### 12.3 å‚è€ƒæ–‡çŒ®

1. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
4. Silberschatz, A., Galvin, P. B., & Gagne, G. (2018). Operating System Concepts (10th ed.). John Wiley & Sons.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 12.4 Wikidataå¯¹é½

#### 12.4.1 å­˜å‚¨ç®¡ç†æ¦‚å¿µå¯¹é½

- **Wikidata ID**: Q192490 (Database storage)
- **ç›¸å…³å±æ€§**:
  - P31: Q192490 (instance of: database component)
  - P361: Q176165 (part of: database management system)
- **å¤–éƒ¨é“¾æ¥**:
  - [Wikipedia - Database storage structures](https://en.wikipedia.org/wiki/Database_storage_structures)
  - [Wikipedia - Write-ahead logging](https://en.wikipedia.org/wiki/Write-ahead_logging)

**Wikipediaå®šä¹‰**: [Write-ahead logging](https://en.wikipedia.org/wiki/Write-ahead_logging)

> Write-ahead logging (WAL) is a family of techniques for providing atomicity and durability (two of the ACID properties) in database systems.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒWALç”¨äºä¿è¯åŸå­æ€§å’ŒæŒä¹…æ€§
- âœ… **ACIDç‰¹æ€§**: éƒ½æåˆ°WALæ˜¯ACIDç‰¹æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†
- âœ… **å®ç°æœºåˆ¶**: éƒ½å¼ºè°ƒå…ˆå†™æ—¥å¿—åå†™æ•°æ®çš„æœºåˆ¶

#### 12.4.2 PostgreSQLå­˜å‚¨ç®¡ç†å¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/storage.html>
  - <https://www.postgresql.org/docs/current/wal.html>

---

## åä¸‰ã€å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯

### 13.1 WALæŒä¹…æ€§ä¿è¯è¯æ˜

**å®šç†**: WALæœºåˆ¶ä¿è¯å·²æäº¤äº‹åŠ¡çš„æŒä¹…æ€§ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[WALæŒä¹…æ€§ä¿è¯]
è®¾äº‹åŠ¡ T å·²æäº¤ï¼Œå…¶ä¿®æ”¹çš„æ•°æ®é¡µä¸º P_1, P_2, \ldots, P_nã€‚

WALæŒä¹…æ€§ä¿è¯ï¼š
å¦‚æœ WAL æ—¥å¿—å·²æŒä¹…åŒ–ï¼Œåˆ™å³ä½¿æ•°æ®é¡µæœªå†™å…¥ç£ç›˜ï¼Œäº‹åŠ¡ T çš„ä¿®æ”¹ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

è¯æ˜ï¼š
1. æäº¤æ¡ä»¶ï¼šäº‹åŠ¡ T æäº¤æ—¶ï¼ŒWAL æ—¥å¿—å¿…é¡»å·²æŒä¹…åŒ–
2. æ¢å¤æœºåˆ¶ï¼šç³»ç»Ÿé‡å¯åï¼Œå¯ä»¥é€šè¿‡ WAL æ—¥å¿—é‡æ”¾äº‹åŠ¡ T çš„ä¿®æ”¹
3. æ•°æ®ä¸€è‡´æ€§ï¼šé‡æ”¾åçš„æ•°æ®çŠ¶æ€ä¸æäº¤æ—¶çš„çŠ¶æ€ä¸€è‡´

å› æ­¤ï¼ŒWALæœºåˆ¶ä¿è¯å·²æäº¤äº‹åŠ¡çš„æŒä¹…æ€§ã€‚
\end{theorem}
```

### 13.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥æœ€ä¼˜æ€§è¯æ˜

**å®šç†**: LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥åœ¨å±€éƒ¨æ€§è®¿é—®æ¨¡å¼ä¸‹æ˜¯æœ€ä¼˜çš„ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥æœ€ä¼˜æ€§]
è®¾ç¼“å†²åŒºå¤§å°ä¸º Bï¼Œè®¿é—®åºåˆ—ä¸º a_1, a_2, \ldots, a_nã€‚

LRUç­–ç•¥ï¼š
å½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œæ›¿æ¢æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢ã€‚

æœ€ä¼˜æ€§æ¡ä»¶ï¼š
å¦‚æœè®¿é—®æ¨¡å¼å…·æœ‰æ—¶é—´å±€éƒ¨æ€§ï¼ˆæœ€è¿‘è®¿é—®çš„é¡µé¢æ›´å¯èƒ½å†æ¬¡è®¿é—®ï¼‰ï¼Œ
åˆ™LRUç­–ç•¥çš„ç¼“å­˜å‘½ä¸­ç‡æœ€é«˜ã€‚

è¯æ˜æ€è·¯ï¼š
1. æ—¶é—´å±€éƒ¨æ€§ï¼šP(\text{access}(t+1) = p | \text{access}(t) = p) > P(\text{access}(t+1) = p)
2. LRUç­–ç•¥ï¼šä¿ç•™æœ€è¿‘è®¿é—®çš„é¡µé¢ï¼Œæ›¿æ¢æœ€ä¹…æœªè®¿é—®çš„é¡µé¢
3. å‘½ä¸­ç‡ï¼šLRUç­–ç•¥æœ€å¤§åŒ–æœ€è¿‘è®¿é—®é¡µé¢çš„ä¿ç•™æ¦‚ç‡

å› æ­¤ï¼Œåœ¨å±€éƒ¨æ€§è®¿é—®æ¨¡å¼ä¸‹ï¼ŒLRUç­–ç•¥æ˜¯æœ€ä¼˜çš„ã€‚
\end{theorem}
```

### 13.3 æ£€æŸ¥ç‚¹ä¸€è‡´æ€§è¯æ˜

**å®šç†**: æ£€æŸ¥ç‚¹æœºåˆ¶ä¿è¯æ•°æ®åº“çŠ¶æ€çš„ä¸€è‡´æ€§å¿«ç…§ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[æ£€æŸ¥ç‚¹ä¸€è‡´æ€§]
è®¾æ£€æŸ¥ç‚¹æ—¶åˆ»ä¸º t_cpï¼Œæ•°æ®åº“çŠ¶æ€ä¸º D_{cp}ã€‚

æ£€æŸ¥ç‚¹ä¸€è‡´æ€§æ¡ä»¶ï¼š
1. æ‰€æœ‰å·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹éƒ½å·²å†™å…¥æ•°æ®æ–‡ä»¶
2. WALæ—¥å¿—è®°å½•æ£€æŸ¥ç‚¹ä½ç½®
3. æ£€æŸ¥ç‚¹åçš„WALæ—¥å¿—å¯ä»¥ç”¨äºæ¢å¤

ä¸€è‡´æ€§ä¿è¯ï¼š
\forall t < t_{cp}: \text{committed}(t) \Rightarrow \text{persisted}(t, D_{cp})

æ¢å¤ä¸€è‡´æ€§ï¼š
å¦‚æœç³»ç»Ÿåœ¨ t > t_{cp} æ—¶æ•…éšœï¼Œå¯ä»¥é€šè¿‡ï¼š
1. åŠ è½½æ£€æŸ¥ç‚¹æ—¶åˆ»çš„æ•°æ®çŠ¶æ€ D_{cp}
2. é‡æ”¾æ£€æŸ¥ç‚¹åçš„WALæ—¥å¿—
3. æ¢å¤åˆ°æ•…éšœå‰çš„çŠ¶æ€

å› æ­¤ï¼Œæ£€æŸ¥ç‚¹æœºåˆ¶ä¿è¯æ•°æ®åº“çŠ¶æ€çš„ä¸€è‡´æ€§å¿«ç…§ã€‚
\end{theorem}
```

---

## åå››ã€äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](./01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„ç†è®ºåŸºç¡€
- â­â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](./01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - WALæœºåˆ¶ç†è®ºåŸºç¡€
- â­â­ [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](./01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - MVCCæœºåˆ¶
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤å®è·µ
- â­â­ [å¢é‡å¤‡ä»½ä¸æ¢å¤](../../13-é«˜å¯ç”¨æ¶æ„/å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - PostgreSQL 18å¢é‡å¤‡ä»½
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - å­˜å‚¨æ€§èƒ½è°ƒä¼˜
- â­ [æ—¶åºç›‘æ§](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ—¶åºç›‘æ§.md) - æ—¶åºæ•°æ®å­˜å‚¨

### å¤–éƒ¨èµ„æº

- [PostgreSQLå­˜å‚¨æ–‡æ¡£](https://www.postgresql.org/docs/current/storage.html)
- [PostgreSQL WALæ–‡æ¡£](https://www.postgresql.org/docs/current/wal.html)
- [PostgreSQLå¤‡ä»½æ–‡æ¡£](https://www.postgresql.org/docs/current/backup.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team

- <https://www.postgresql.org/docs/current/wal.html>
