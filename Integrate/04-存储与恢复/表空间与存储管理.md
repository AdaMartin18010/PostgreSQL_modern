---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\06-å­˜å‚¨ç®¡ç†\è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-18

## ğŸ“‘ ç›®å½•

- [PostgreSQL è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†](#postgresql-è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°](#10-è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#14-è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. è¡¨ç©ºé—´ç®¡ç†](#2-è¡¨ç©ºé—´ç®¡ç†)
    - [2.1 åˆ›å»ºè¡¨ç©ºé—´](#21-åˆ›å»ºè¡¨ç©ºé—´)
    - [2.2 ä½¿ç”¨è¡¨ç©ºé—´](#22-ä½¿ç”¨è¡¨ç©ºé—´)
    - [2.3 è¡¨ç©ºé—´ç®¡ç†](#23-è¡¨ç©ºé—´ç®¡ç†)
  - [3. å­˜å‚¨ä¼˜åŒ–](#3-å­˜å‚¨ä¼˜åŒ–)
    - [3.1 TOAST æœºåˆ¶](#31-toast-æœºåˆ¶)
    - [3.2 æ•°æ®å‹ç¼©](#32-æ•°æ®å‹ç¼©)
    - [3.3 å­˜å‚¨ç›‘æ§](#33-å­˜å‚¨ç›‘æ§)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: å¤šç£ç›˜å­˜å‚¨ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-å¤šç£ç›˜å­˜å‚¨ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è¡¨ç©ºé—´è§„åˆ’](#51-è¡¨ç©ºé—´è§„åˆ’)
    - [5.2 å­˜å‚¨ä¼˜åŒ–](#52-å­˜å‚¨ä¼˜åŒ–)
    - [5.3 ç›‘æ§å’Œç»´æŠ¤](#53-ç›‘æ§å’Œç»´æŠ¤)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 è¡¨ç©ºé—´åŸºç¡€å¸¸è§é—®é¢˜](#61-è¡¨ç©ºé—´åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨è¡¨ç©ºé—´ï¼Ÿ](#q1-ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨è¡¨ç©ºé—´)
      - [Q2: å¦‚ä½•è¿ç§»è¡¨åˆ°æ–°è¡¨ç©ºé—´ï¼Ÿ](#q2-å¦‚ä½•è¿ç§»è¡¨åˆ°æ–°è¡¨ç©ºé—´)
    - [6.2 å­˜å‚¨ä¼˜åŒ–å¸¸è§é—®é¢˜](#62-å­˜å‚¨ä¼˜åŒ–å¸¸è§é—®é¢˜)
      - [Q3: TOASTè¡¨å ç”¨ç©ºé—´è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ](#q3-toastè¡¨å ç”¨ç©ºé—´è¿‡å¤§æ€ä¹ˆåŠ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
      - [âœ… è¡¨ç©ºé—´è§„åˆ’å»ºè®®](#-è¡¨ç©ºé—´è§„åˆ’å»ºè®®)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ è¡¨ç©ºé—´åæ¨¡å¼](#-è¡¨ç©ºé—´åæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†å·¥ä½œåŸç†æ¦‚è¿°

**è¡¨ç©ºé—´å·¥ä½œåŸç†**ï¼š

PostgreSQL è¡¨ç©ºé—´æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œç”¨äºå°†æ•°æ®åº“å¯¹è±¡ï¼ˆè¡¨ã€ç´¢å¼•ç­‰ï¼‰å­˜å‚¨åœ¨ä¸åŒçš„ç‰©ç†ä½ç½®ã€‚è¡¨ç©ºé—´çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **è¡¨ç©ºé—´æ˜ å°„**ï¼šè¡¨ç©ºé—´åç§°æ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿç›®å½•
2. **æ•°æ®åˆ†å¸ƒ**ï¼šå¯ä»¥å°†ä¸åŒçš„è¡¨å­˜å‚¨åœ¨ä¸åŒçš„è¡¨ç©ºé—´ï¼Œå®ç°æ•°æ®åˆ†å¸ƒ
3. **I/O ä¼˜åŒ–**ï¼šé€šè¿‡å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªç£ç›˜ï¼Œæå‡ I/O æ€§èƒ½
4. **å®¹é‡ç®¡ç†**ï¼šå¯ä»¥ç‹¬ç«‹ç®¡ç†æ¯ä¸ªè¡¨ç©ºé—´çš„å®¹é‡

**è¡¨ç©ºé—´æ¶æ„**ï¼š

```mermaid
flowchart TD
    A[PostgreSQLæ•°æ®åº“] --> B[é»˜è®¤è¡¨ç©ºé—´ pg_default]
    A --> C[è¡¨ç©ºé—´ fast_disk]
    A --> D[è¡¨ç©ºé—´ archive_disk]
    B --> B1[/var/lib/postgresql/data]
    C --> C1[/fast/disk/pgdata]
    D --> D1[/archive/disk/pgdata]

    style A fill:#FFD700
    style C fill:#90EE90
    style D fill:#87CEEB
```

**TOAST æœºåˆ¶å·¥ä½œåŸç†**ï¼š

TOAST (The Oversized-Attribute Storage Technique) æ˜¯ PostgreSQL ç”¨äºå­˜å‚¨å¤§å¯¹è±¡çš„æœºåˆ¶ã€‚
å½“è¡Œæ•°æ®è¶…è¿‡é¡µé¢å¤§å°ï¼ˆé€šå¸¸ 8KBï¼‰æ—¶ï¼ŒPostgreSQL ä¼šè‡ªåŠ¨å°†å¤§å­—æ®µå­˜å‚¨åˆ° TOAST è¡¨ä¸­ã€‚

**TOAST å­˜å‚¨æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥/æ›´æ–°æ•°æ®] --> B{è¡Œå¤§å° > 8KB?}
    B -->|å¦| C[æ­£å¸¸å­˜å‚¨]
    B -->|æ˜¯| D[æ£€æŸ¥å­—æ®µå¤§å°]
    D --> E{å­—æ®µ > 2KB?}
    E -->|å¦| F[è¡Œå†…å­˜å‚¨]
    E -->|æ˜¯| G[TOASTå­˜å‚¨]
    G --> H[å‹ç¼©æ•°æ®]
    H --> I{å‹ç¼©å < 2KB?}
    I -->|æ˜¯| J[è¡Œå†…å­˜å‚¨å‹ç¼©æ•°æ®]
    I -->|å¦| K[å­˜å‚¨åˆ°TOASTè¡¨]
    K --> L[è¡Œå†…å­˜å‚¨TOASTæŒ‡é’ˆ]

    style A fill:#FFD700
    style G fill:#90EE90
    style K fill:#87CEEB
```

**è¡¨ç©ºé—´è¿ç§»æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹è¿ç§»] --> B[åˆ›å»ºæ–°è¡¨ç©ºé—´]
    B --> C[è·å–è¡¨é”]
    C --> D[ç§»åŠ¨æ•°æ®æ–‡ä»¶]
    D --> E[æ›´æ–°ç³»ç»Ÿç›®å½•]
    E --> F[é‡Šæ”¾é”]
    F --> G[éªŒè¯è¿ç§»]
    G --> H{è¿ç§»æˆåŠŸ?}
    H -->|å¦| I[å›æ»š]
    H -->|æ˜¯| J[å®Œæˆè¿ç§»]

    style A fill:#FFD700
    style C fill:#FF6B6B
    style J fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**è¡¨ç©ºé—´å’Œå­˜å‚¨ç®¡ç†çš„ä»·å€¼**:

PostgreSQL æä¾›äº†çµæ´»çš„è¡¨ç©ºé—´å’Œå­˜å‚¨ç®¡ç†æœºåˆ¶ï¼š

1. **è¡¨ç©ºé—´**: å°†æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„ç£ç›˜
2. **TOAST**: è‡ªåŠ¨å¤„ç†å¤§å¯¹è±¡å­˜å‚¨
3. **æ•°æ®å‹ç¼©**: å‹ç¼©å­˜å‚¨æ•°æ®
4. **å­˜å‚¨ç›‘æ§**: ç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ

**åº”ç”¨åœºæ™¯**:

- **å¤šç£ç›˜å­˜å‚¨**: å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªç£ç›˜
- **æ€§èƒ½ä¼˜åŒ–**: é€šè¿‡è¡¨ç©ºé—´ä¼˜åŒ– I/O æ€§èƒ½
- **å­˜å‚¨ä¼˜åŒ–**: ä¼˜åŒ–å­˜å‚¨ç©ºé—´ä½¿ç”¨
- **å®¹é‡è§„åˆ’**: è§„åˆ’å­˜å‚¨å®¹é‡

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **I/O æ€§èƒ½** | å¤šç£ç›˜æå‡æ€§èƒ½ | **2-5x** |
| **å­˜å‚¨ç©ºé—´** | å‹ç¼©èŠ‚çœç©ºé—´ | **-30%** |
| **ç®¡ç†æ•ˆç‡** | è¡¨ç©ºé—´ç®¡ç† | **+50%** |
| **å¯æ‰©å±•æ€§** | æ”¯æŒå­˜å‚¨æ‰©å±• | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **I/O æ€§èƒ½**: å¤šç£ç›˜è¡¨ç©ºé—´æå‡ I/O æ€§èƒ½ 2-5 å€
- **å­˜å‚¨ç©ºé—´**: æ•°æ®å‹ç¼©èŠ‚çœå­˜å‚¨ç©ºé—´ 30%
- **ç®¡ç†æ•ˆç‡**: è¡¨ç©ºé—´ç®¡ç†æå‡ç®¡ç†æ•ˆç‡ 50%
- **å¯æ‰©å±•æ€§**: æ”¯æŒå­˜å‚¨æ‰©å±•ï¼Œé€‚åº”ä¸šåŠ¡å¢é•¿

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡è¡¨ç©ºé—´çš„åˆ›å»ºå’Œç®¡ç†
- ç†è§£ TOAST æœºåˆ¶çš„å·¥ä½œåŸç†
- å­¦ä¼šä¼˜åŒ–å­˜å‚¨ç©ºé—´ä½¿ç”¨
- æŒæ¡å­˜å‚¨ç›‘æ§å’Œå®¹é‡è§„åˆ’

### 1.4 è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((è¡¨ç©ºé—´ä¸å­˜å‚¨ç®¡ç†))
    è¡¨ç©ºé—´ç®¡ç†
      è¡¨ç©ºé—´åˆ›å»º
        åˆ›å»ºè¡¨ç©ºé—´
        æŒ‡å®šä½ç½®
        æƒé™è®¾ç½®
      è¡¨ç©ºé—´ä½¿ç”¨
        è¡¨ç©ºé—´åˆ†é…
        è¡¨ç©ºé—´åˆ‡æ¢
        è¡¨ç©ºé—´è¿ç§»
      è¡¨ç©ºé—´ç»´æŠ¤
        è¡¨ç©ºé—´ç›‘æ§
        è¡¨ç©ºé—´æ¸…ç†
        è¡¨ç©ºé—´ä¼˜åŒ–
    å­˜å‚¨ç»“æ„
      æ•°æ®æ–‡ä»¶
        æ•°æ®æ–‡ä»¶ç»„ç»‡
        æ•°æ®æ–‡ä»¶æ‰©å±•
        æ•°æ®æ–‡ä»¶ç®¡ç†
      WALæ–‡ä»¶
        WALæ–‡ä»¶ç®¡ç†
        WALå½’æ¡£
        WALæ¸…ç†
      TOASTæœºåˆ¶
        TOASTå­˜å‚¨
        TOASTå‹ç¼©
        TOASTä¼˜åŒ–
    å­˜å‚¨ä¼˜åŒ–
      æ•°æ®å‹ç¼©
        è¡¨å‹ç¼©
        ç´¢å¼•å‹ç¼©
        å½’æ¡£å‹ç¼©
      å­˜å‚¨ç›‘æ§
        ç©ºé—´ä½¿ç”¨ç›‘æ§
        å¢é•¿è¶‹åŠ¿åˆ†æ
        å®¹é‡é¢„è­¦
      å®¹é‡è§„åˆ’
        å®¹é‡é¢„æµ‹
        æ‰©å±•è®¡åˆ’
        èµ„æºè§„åˆ’
```

## 2. è¡¨ç©ºé—´ç®¡ç†

### 2.1 åˆ›å»ºè¡¨ç©ºé—´

**åˆ›å»ºè¡¨ç©ºé—´**:

```sql
-- åˆ›å»ºè¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk å·²å­˜åœ¨';
            RETURN;
        END IF;

        CREATE TABLESPACE fast_disk
        LOCATION '/data/postgresql/fast';
        RAISE NOTICE 'è¡¨ç©ºé—´ fast_disk åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè¡¨ç©ºé—´ï¼ˆéœ€è¦ç›®å½•å­˜åœ¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ³¨æ„ï¼šåœ¨æ“ä½œç³»ç»Ÿåˆ›å»ºç›®å½•ï¼ˆéœ€è¦åœ¨Bashä¸­æ‰§è¡Œï¼‰
-- mkdir -p /data/postgresql/fast
-- chown postgres:postgres /data/postgresql/fast

DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk å·²å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'postgres') THEN
            RAISE EXCEPTION 'è§’è‰² postgres ä¸å­˜åœ¨';
        END IF;

        CREATE TABLESPACE fast_disk
        OWNER postgres
        LOCATION '/data/postgresql/fast';
        RAISE NOTICE 'è¡¨ç©ºé—´ fast_disk åˆ›å»ºæˆåŠŸï¼ˆæ‰€æœ‰è€…: postgresï¼‰';
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk å·²å­˜åœ¨';
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´æˆ–è®¾ç½®æ‰€æœ‰è€…';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 ä½¿ç”¨è¡¨ç©ºé—´

**æŒ‡å®šè¡¨ç©ºé—´**:

```sql
-- åˆ›å»ºè¡¨æ—¶æŒ‡å®šè¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table å·²å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        END IF;

        CREATE TABLE large_table (
            id SERIAL PRIMARY KEY,
            data TEXT
        ) TABLESPACE fast_disk;
        RAISE NOTICE 'è¡¨ large_table åˆ›å»ºæˆåŠŸï¼ˆè¡¨ç©ºé—´: fast_diskï¼‰';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ large_table å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•æ—¶æŒ‡å®šè¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND indexname = 'large_table_idx') THEN
            RAISE WARNING 'ç´¢å¼• large_table_idx å·²å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        END IF;

        CREATE INDEX large_table_idx ON large_table (id)
        TABLESPACE fast_disk;
        RAISE NOTICE 'ç´¢å¼• large_table_idx åˆ›å»ºæˆåŠŸï¼ˆè¡¨ç©ºé—´: fast_diskï¼‰';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• large_table_idx å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è¡¨ç©ºé—´ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¿®æ”¹è¡¨çš„è¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        END IF;

        RAISE WARNING 'è­¦å‘Šï¼šALTER TABLE SET TABLESPACE ä¼šé”å®šè¡¨ï¼Œå¤§è¡¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´';
        ALTER TABLE large_table SET TABLESPACE fast_disk;
        RAISE NOTICE 'è¡¨ large_table çš„è¡¨ç©ºé—´ä¿®æ”¹æˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨æˆ–è¡¨ç©ºé—´ä¸å­˜åœ¨';
        WHEN lock_not_available THEN
            RAISE WARNING 'æ— æ³•è·å–è¡¨é”ï¼Œè¡¨å¯èƒ½æ­£åœ¨è¢«ä½¿ç”¨';
        WHEN OTHERS THEN
            RAISE WARNING 'ä¿®æ”¹è¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¿®æ”¹ç´¢å¼•çš„è¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND indexname = 'large_table_idx') THEN
            RAISE WARNING 'ç´¢å¼• large_table_idx ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        END IF;

        ALTER INDEX large_table_idx SET TABLESPACE fast_disk;
        RAISE NOTICE 'ç´¢å¼• large_table_idx çš„è¡¨ç©ºé—´ä¿®æ”¹æˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'ç´¢å¼•æˆ–è¡¨ç©ºé—´ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'ä¿®æ”¹ç´¢å¼•è¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.3 è¡¨ç©ºé—´ç®¡ç†

**è¡¨ç©ºé—´æ“ä½œ**:

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    tablespace_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO tablespace_count FROM pg_tablespace;
        RAISE NOTICE 'å…±æœ‰ % ä¸ªè¡¨ç©ºé—´', tablespace_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM pg_tablespace;

-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    custom_tablespace_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO custom_tablespace_count
        FROM pg_tablespace
        WHERE spcname != 'pg_default';

        RAISE NOTICE 'è‡ªå®šä¹‰è¡¨ç©ºé—´æ•°é‡: %', custom_tablespace_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    spcname AS tablespace_name,
    pg_size_pretty(pg_tablespace_size(spcname)) AS size
FROM pg_tablespace
WHERE spcname != 'pg_default';

-- æŸ¥çœ‹è¡¨æ‰€åœ¨çš„è¡¨ç©ºé—´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_tables
        WHERE tablespace IS NOT NULL;

        RAISE NOTICE 'ä½¿ç”¨è‡ªå®šä¹‰è¡¨ç©ºé—´çš„è¡¨æ•°é‡: %', table_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¡¨æ‰€åœ¨çš„è¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    tablespace
FROM pg_tables
WHERE tablespace IS NOT NULL;

-- åˆ é™¤è¡¨ç©ºé—´ï¼ˆéœ€è¦å…ˆåˆ é™¤æ‰€æœ‰å¯¹è±¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    object_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fast_disk') THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
            RETURN;
        END IF;

        -- æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è±¡ä½¿ç”¨è¯¥è¡¨ç©ºé—´
        SELECT COUNT(*) INTO object_count
        FROM pg_tables
        WHERE tablespace = 'fast_disk';

        IF object_count > 0 THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä»æœ‰ % ä¸ªè¡¨åœ¨ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤', object_count;
        END IF;

        DROP TABLESPACE fast_disk;
        RAISE NOTICE 'è¡¨ç©ºé—´ fast_disk åˆ é™¤æˆåŠŸ';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fast_disk ä¸å­˜åœ¨';
        WHEN dependent_objects_still_exist THEN
            RAISE EXCEPTION 'è¡¨ç©ºé—´ fast_disk ä»æœ‰ä¾èµ–å¯¹è±¡ï¼Œæ— æ³•åˆ é™¤';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ é™¤è¡¨ç©ºé—´å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 3. å­˜å‚¨ä¼˜åŒ–

### 3.1 TOAST æœºåˆ¶

**TOAST è¯´æ˜**:

PostgreSQL ä½¿ç”¨ TOASTï¼ˆThe Oversized-Attribute Storage Techniqueï¼‰æœºåˆ¶å¤„ç†å¤§å¯¹è±¡ï¼š

- **è‡ªåŠ¨å¤„ç†**: è¶…è¿‡ 2KB çš„åˆ—è‡ªåŠ¨ä½¿ç”¨ TOAST
- **å‹ç¼©å­˜å‚¨**: TOAST æ•°æ®ä¼šè¢«å‹ç¼©
- **é€æ˜è®¿é—®**: å¯¹ç”¨æˆ·é€æ˜ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†

**TOAST ç­–ç•¥**:

```sql
-- æŸ¥çœ‹è¡¨çš„ TOAST ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    toast_status TEXT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
            RETURN;
        END IF;

        SELECT
            CASE reltoastrelid
                WHEN 0 THEN 'no toast'
                ELSE 'has toast'
            END INTO toast_status
        FROM pg_class
        WHERE relname = 'large_table';

        RAISE NOTICE 'è¡¨ large_table çš„ TOAST çŠ¶æ€: %', toast_status;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ TOAST ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    relname,
    reltoastrelid,
    CASE reltoastrelid
        WHEN 0 THEN 'no toast'
        ELSE 'has toast'
    END AS toast_status
FROM pg_class
WHERE relname = 'large_table';

-- è®¾ç½® TOAST ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public'
            AND table_name = 'large_table'
            AND column_name = 'data'
        ) THEN
            RAISE WARNING 'åˆ— data ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE large_table
        ALTER COLUMN data SET STORAGE EXTENDED;  -- å…è®¸ TOAST å’Œå‹ç¼©
        RAISE NOTICE 'TOAST ç­–ç•¥è®¾ç½®æˆåŠŸ: data -> EXTENDED';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ— data ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½® TOAST ç­–ç•¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- TOAST ç­–ç•¥é€‰é¡¹è¯´æ˜ï¼š
-- PLAIN: ä¸å…è®¸ TOAST
-- EXTENDED: å…è®¸ TOAST å’Œå‹ç¼©ï¼ˆé»˜è®¤ï¼‰
-- EXTERNAL: å…è®¸ TOASTï¼Œä½†ä¸å‹ç¼©
-- MAIN: å…è®¸ TOASTï¼Œä½†å°½é‡ä¸ TOAST
```

### 3.2 æ•°æ®å‹ç¼©

**å‹ç¼©é€‰é¡¹**:

```sql
-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.3 å­˜å‚¨ç›‘æ§

**å­˜å‚¨ç›‘æ§æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO db_count FROM pg_database;
        RAISE NOTICE 'å…±æœ‰ % ä¸ªæ•°æ®åº“', db_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ•°æ®åº“å¤§å°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°ï¼ˆåŒ…æ‹¬ç´¢å¼•ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_tables
        WHERE schemaname = 'public';

        RAISE NOTICE 'public schema å…±æœ‰ % ä¸ªè¡¨', table_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¡¨å¤§å°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;

-- æŸ¥çœ‹ç´¢å¼•å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO index_count
        FROM pg_indexes
        WHERE schemaname = 'public';

        RAISE NOTICE 'public schema å…±æœ‰ % ä¸ªç´¢å¼•', index_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ç´¢å¼•å¤§å°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(schemaname||'.'||indexname)) AS size
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(schemaname||'.'||indexname) DESC
LIMIT 10;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: å¤šç£ç›˜å­˜å‚¨ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸå¤§å‹æ•°æ®åº“éœ€è¦ä¼˜åŒ– I/O æ€§èƒ½ï¼Œå°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªç£ç›˜ã€‚

**é—®é¢˜åˆ†æ**:

1. **I/O ç“¶é¢ˆ**: å•ç£ç›˜ I/O æˆä¸ºç“¶é¢ˆ
2. **å­˜å‚¨ç©ºé—´**: éœ€è¦æ‰©å±•å­˜å‚¨ç©ºé—´
3. **æ€§èƒ½è¦æ±‚**: éœ€è¦æå‡æŸ¥è¯¢æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå¤šä¸ªè¡¨ç©ºé—´
CREATE TABLESPACE ts_data1 LOCATION '/data/postgresql/data1';
CREATE TABLESPACE ts_data2 LOCATION '/data/postgresql/data2';
CREATE TABLESPACE ts_index LOCATION '/data/postgresql/index';

-- 2. å°†è¡¨åˆ†å¸ƒåˆ°ä¸åŒè¡¨ç©ºé—´
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER,
    order_date DATE,
    total_amount DECIMAL(10, 2)
) TABLESPACE ts_data1;

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER,
    quantity INTEGER,
    price DECIMAL(10, 2)
) TABLESPACE ts_data2;

-- 3. å°†ç´¢å¼•æ”¾åˆ°ç‹¬ç«‹è¡¨ç©ºé—´
CREATE INDEX orders_customer_idx ON orders (customer_id)
TABLESPACE ts_index;

CREATE INDEX order_items_order_idx ON order_items (order_id)
TABLESPACE ts_index;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **I/O æ€§èƒ½** | åŸºå‡† | **3x** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | åŸºå‡† | **2x** | **æå‡** |
| **å­˜å‚¨å®¹é‡** | 1TB | **3TB** | **æ‰©å±•** |

## 5. æœ€ä½³å®è·µ

### 5.1 è¡¨ç©ºé—´è§„åˆ’

1. **åˆ†ç¦»æ•°æ®å’Œç´¢å¼•**: å°†æ•°æ®å’Œç´¢å¼•æ”¾åˆ°ä¸åŒè¡¨ç©ºé—´
2. **åˆ†ç¦»çƒ­å†·æ•°æ®**: å°†çƒ­æ•°æ®å’Œå†·æ•°æ®åˆ†ç¦»
3. **å¤šç£ç›˜åˆ†å¸ƒ**: å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªç£ç›˜

### 5.2 å­˜å‚¨ä¼˜åŒ–

1. **TOAST ä¼˜åŒ–**: åˆç†è®¾ç½® TOAST ç­–ç•¥
2. **æ•°æ®å‹ç¼©**: ä½¿ç”¨å‹ç¼©èŠ‚çœå­˜å‚¨ç©ºé—´
3. **å®šæœŸæ¸…ç†**: å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®

### 5.3 ç›‘æ§å’Œç»´æŠ¤

1. **å­˜å‚¨ç›‘æ§**: å®šæœŸç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ
2. **å®¹é‡è§„åˆ’**: æå‰è§„åˆ’å­˜å‚¨å®¹é‡
3. **æ€§èƒ½ç›‘æ§**: ç›‘æ§ I/O æ€§èƒ½

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 è¡¨ç©ºé—´åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨è¡¨ç©ºé—´ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™éœ€è¦åˆ›å»ºè¡¨ç©ºé—´ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨é»˜è®¤è¡¨ç©ºé—´ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥å½“å‰è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) AS size
FROM pg_tablespace;

-- 2. æ£€æŸ¥ç£ç›˜I/Oæ€§èƒ½
SELECT * FROM pg_stat_io WHERE object = 'relation';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å¤šç£ç›˜å­˜å‚¨ï¼šä½¿ç”¨è¡¨ç©ºé—´åˆ†å¸ƒæ•°æ®
CREATE TABLESPACE ts_fast LOCATION '/fast_disk/postgresql';
CREATE TABLESPACE ts_slow LOCATION '/slow_disk/postgresql';

-- 2. åˆ†ç¦»æ•°æ®å’Œç´¢å¼•ï¼šæå‡I/Oæ€§èƒ½
CREATE TABLE orders (...) TABLESPACE ts_data;
CREATE INDEX orders_idx ON orders(...) TABLESPACE ts_index;

-- 3. åˆ†ç¦»çƒ­å†·æ•°æ®ï¼šä¼˜åŒ–å­˜å‚¨æˆæœ¬
CREATE TABLE hot_data (...) TABLESPACE ts_ssd;
CREATE TABLE cold_data (...) TABLESPACE ts_hdd;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- å•è¡¨ç©ºé—´ï¼šI/Oæ€§èƒ½ **100 MB/s**
- å¤šè¡¨ç©ºé—´ï¼šI/Oæ€§èƒ½ **300 MB/s**
- **æ€§èƒ½æå‡ï¼š3å€**

#### Q2: å¦‚ä½•è¿ç§»è¡¨åˆ°æ–°è¡¨ç©ºé—´ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å°†è¡¨è¿ç§»åˆ°æ–°è¡¨ç©ºé—´ï¼Œä½†ä¸çŸ¥é“æ­£ç¡®æ–¹æ³•ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥è¡¨å½“å‰è¡¨ç©ºé—´
SELECT
    tablename,
    tablespace
FROM pg_tables
WHERE schemaname = 'public' AND tablename = 'your_table';

-- 2. æ£€æŸ¥è¡¨å¤§å°
SELECT pg_size_pretty(pg_total_relation_size('your_table'));
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç§»åŠ¨è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE your_table SET TABLESPACE new_tablespace;
-- ä¼šé”å®šè¡¨ï¼Œå¤§è¡¨éœ€è¦è¾ƒé•¿æ—¶é—´

-- 2. ç§»åŠ¨ç´¢å¼•åˆ°æ–°è¡¨ç©ºé—´
ALTER INDEX your_index SET TABLESPACE new_tablespace;

-- 3. æ‰¹é‡ç§»åŠ¨ï¼ˆä½¿ç”¨pg_repackï¼Œä¸é˜»å¡ï¼‰
-- å®‰è£…pg_repackæ‰©å±•
CREATE EXTENSION pg_repack;
-- ç§»åŠ¨è¡¨ï¼ˆä¸é˜»å¡æŸ¥è¯¢ï¼‰
SELECT repack.repack_table('your_table', 'new_tablespace');
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- ALTER TABLEï¼šé”å®šè¡¨ **30åˆ†é’Ÿ**ï¼Œé˜»å¡æ‰€æœ‰æ“ä½œ
- pg_repackï¼šä¸é˜»å¡æŸ¥è¯¢ï¼Œåå°æ‰§è¡Œ
- **å¯ç”¨æ€§æå‡ï¼š100%**

### 6.2 å­˜å‚¨ä¼˜åŒ–å¸¸è§é—®é¢˜

#### Q3: TOASTè¡¨å ç”¨ç©ºé—´è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ

**é—®é¢˜æè¿°**ï¼šTOASTè¡¨å ç”¨å¤§é‡ç©ºé—´ï¼Œä¸çŸ¥é“å¦‚ä½•ä¼˜åŒ–ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥TOASTè¡¨å¤§å°
SELECT
    relname,
    pg_size_pretty(pg_total_relation_size(oid)) AS size
FROM pg_class
WHERE relname LIKE '%_toast%';

-- 2. æ£€æŸ¥å¤§å¯¹è±¡åˆ—
SELECT
    table_name,
    column_name,
    data_type
FROM information_schema.columns
WHERE table_schema = 'public'
    AND (data_type LIKE '%TEXT%' OR data_type LIKE '%BYTEA%');
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. è°ƒæ•´TOASTé˜ˆå€¼
ALTER TABLE your_table SET (toast_tuple_target = 2000);
-- é™ä½é˜ˆå€¼ï¼Œæ›´å¤šæ•°æ®è¿›å…¥TOAST

-- 2. ä½¿ç”¨å‹ç¼©
ALTER TABLE your_table SET (compression = 'lz4');
-- å¯ç”¨å‹ç¼©ï¼Œå‡å°‘TOASTç©ºé—´

-- 3. æ¸…ç†å¤§å¯¹è±¡
VACUUM FULL your_table;
-- æ¸…ç†TOASTä¸­çš„æ­»å…ƒç»„

-- 4. å½’æ¡£å¤§å¯¹è±¡æ•°æ®
-- å°†å¤§å¯¹è±¡æ•°æ®ç§»åˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚å¯¹è±¡å­˜å‚¨ï¼‰
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ä¼˜åŒ–ï¼šTOASTç©ºé—´ **50GB**
- å¯ç”¨å‹ç¼©ï¼šTOASTç©ºé—´ **20GB**
- **ç©ºé—´èŠ‚çœï¼š60%**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… è¡¨ç©ºé—´è§„åˆ’å»ºè®®

1. **å¤šç£ç›˜è¡¨ç©ºé—´**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå°†çƒ­æ•°æ®å­˜å‚¨åˆ°SSDè¡¨ç©ºé—´
   CREATE TABLESPACE fast_ssd LOCATION '/fast/ssd/pgdata';
   CREATE TABLE hot_table (...) TABLESPACE fast_ssd;

   -- âœ… å¥½ï¼šå°†å†·æ•°æ®å­˜å‚¨åˆ°HDDè¡¨ç©ºé—´
   CREATE TABLESPACE slow_hdd LOCATION '/slow/hdd/pgdata';
   CREATE TABLE archive_table (...) TABLESPACE slow_hdd;
   ```

2. **è¡¨ç©ºé—´å®¹é‡è§„åˆ’**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸç›‘æ§è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
   SELECT
       spcname AS tablespace_name,
       pg_size_pretty(pg_tablespace_size(spcname)) AS size,
       pg_tablespace_location(spcname) AS location
   FROM pg_tablespace
   WHERE spcname != 'pg_global';
   ```

3. **TOAST ä¼˜åŒ–**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå¯¹äºå¤§æ–‡æœ¬å­—æ®µï¼Œä½¿ç”¨TOASTå­˜å‚¨
   CREATE TABLE documents (
       id SERIAL PRIMARY KEY,
       content TEXT  -- è‡ªåŠ¨ä½¿ç”¨TOASTå­˜å‚¨
   );
   ```

### 7.2 é¿å…åšæ³•

#### âŒ è¡¨ç©ºé—´åæ¨¡å¼

1. **è¡¨ç©ºé—´ä½ç½®ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè¡¨ç©ºé—´ä½ç½®åœ¨ç³»ç»Ÿç›˜ï¼Œç©ºé—´ä¸è¶³
   CREATE TABLESPACE my_tablespace LOCATION '/var/lib/postgresql/data';

   -- âœ… å¥½ï¼šè¡¨ç©ºé—´ä½ç½®åœ¨ç‹¬ç«‹ç£ç›˜
   CREATE TABLESPACE my_tablespace LOCATION '/mnt/data/pgdata';
   ```

2. **å¿½ç•¥TOASTè¡¨å¤§å°**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šä¸ç›‘æ§TOASTè¡¨å¤§å°ï¼Œå¯¼è‡´å­˜å‚¨é—®é¢˜
   -- TOASTè¡¨å¯èƒ½å ç”¨å¤§é‡ç©ºé—´

   -- âœ… å¥½ï¼šå®šæœŸç›‘æ§TOASTè¡¨å¤§å°
   SELECT
       schemaname,
       tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
       pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                      pg_relation_size(schemaname||'.'||tablename)) AS toast_size
   FROM pg_tables
   WHERE schemaname = 'public';
   ```

3. **è¡¨ç©ºé—´æƒé™è®¾ç½®ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè¡¨ç©ºé—´ç›®å½•æƒé™è®¾ç½®ä¸å½“ï¼Œå¯¼è‡´æ— æ³•è®¿é—®
   -- chmod 777 /mnt/data/pgdata  -- ä¸å®‰å…¨

   -- âœ… å¥½ï¼šè®¾ç½®åˆé€‚çš„æƒé™
   -- chown postgres:postgres /mnt/data/pgdata
   -- chmod 700 /mnt/data/pgdata
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **è¡¨ç©ºé—´æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å°†çƒ­æ•°æ®å­˜å‚¨åˆ°SSDè¡¨ç©ºé—´ï¼Œæå‡I/Oæ€§èƒ½
   - å°†å†·æ•°æ®å­˜å‚¨åˆ°HDDè¡¨ç©ºé—´ï¼ŒèŠ‚çœæˆæœ¬
   - ä½¿ç”¨å¤šä¸ªè¡¨ç©ºé—´åˆ†å¸ƒæ•°æ®ï¼Œæå‡å¹¶è¡ŒI/Oæ€§èƒ½

2. **TOAST ä¼˜åŒ–å»ºè®®**ï¼š
   - å¯¹äºå¤§æ–‡æœ¬å­—æ®µï¼Œä½¿ç”¨TOASTè‡ªåŠ¨å­˜å‚¨
   - å®šæœŸç›‘æ§TOASTè¡¨å¤§å°ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´
   - å¯¹äºä¸éœ€è¦å…¨æ–‡æœç´¢çš„å¤§æ–‡æœ¬ï¼Œè€ƒè™‘ä½¿ç”¨å¤–éƒ¨å­˜å‚¨

3. **å­˜å‚¨ç›‘æ§å»ºè®®**ï¼š
   - å®šæœŸç›‘æ§è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶æ‰©å®¹
   - ç›‘æ§TOASTè¡¨å¤§å°ï¼Œé¿å…å­˜å‚¨é—®é¢˜
   - è®¾ç½®å­˜å‚¨å®¹é‡é¢„è­¦ï¼Œæå‰è§„åˆ’æ‰©å®¹

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è¡¨ç©ºé—´](https://www.postgresql.org/docs/current/manage-ag-tablespaces.html)**
  - è¡¨ç©ºé—´åˆ›å»ºã€ç®¡ç†å’Œä½¿ç”¨è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - CREATE TABLESPACE](https://www.postgresql.org/docs/current/sql-createtablespace.html)**
  - CREATE TABLESPACE è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - TOAST](https://www.postgresql.org/docs/current/storage-toast.html)**
  - TOAST æœºåˆ¶åŸç†å’Œä½¿ç”¨è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å­˜å‚¨ç®¡ç†](https://www.postgresql.org/docs/current/storage.html)**
  - PostgreSQL å­˜å‚¨ç®¡ç†æ¦‚è¿°

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[PostgreSQL Storage Management](https://www.postgresql.org/docs/current/storage.html)**
  - PostgreSQL å­˜å‚¨ç®¡ç†åŸç†å’Œå®ç°

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Tablespaces: Best Practices](https://www.postgresql.org/docs/current/manage-ag-tablespaces.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šè¡¨ç©ºé—´æœ€ä½³å®è·µ

- **[Understanding PostgreSQL TOAST](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-toast)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL TOAST

- **[PostgreSQL Storage Optimization Tips](https://www.citusdata.com/blog/2017/10/25/storage-optimization-in-postgresql/)**
  - Citus Data åšå®¢ï¼šå­˜å‚¨ä¼˜åŒ–æŠ€å·§

- **[2ndQuadrant - PostgreSQL Tablespace Management](https://www.2ndquadrant.com/en/blog/postgresql-tablespace-management/)**
  - 2ndQuadrant åšå®¢ï¼šè¡¨ç©ºé—´ç®¡ç†å®æˆ˜

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Tablespaces](https://wiki.postgresql.org/wiki/Tablespaces)**
  - PostgreSQL Wikiï¼šè¡¨ç©ºé—´ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Tablespaces](https://stackoverflow.com/questions/tagged/postgresql+tablespaces)**
  - Stack Overflowï¼šPostgreSQL è¡¨ç©ºé—´ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šè¡¨ç©ºé—´ç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](../11-æ€§èƒ½è°ƒä¼˜/æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [ç›‘æ§ä¸è¯Šæ–­](../12-ç›‘æ§ä¸è¯Šæ–­/README.md)
- [VACUUMä¸ç»´æŠ¤](./VACUUMä¸ç»´æŠ¤.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-18
