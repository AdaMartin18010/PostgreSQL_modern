# PostgreSQL åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç»Ÿè®¡æ¨æ–­ | åŠŸæ•ˆåˆ†æ | æ ·æœ¬é‡è®¡ç®—
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Statistical Power Analysis, Sample Size Calculation, Effect Size

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [åŠŸæ•ˆåˆ†ææ¦‚è¿°](#åŠŸæ•ˆåˆ†ææ¦‚è¿°)
    - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
  - [1. æ£€éªŒåŠŸæ•ˆ](#1-æ£€éªŒåŠŸæ•ˆ)
    - [1.1 tæ£€éªŒåŠŸæ•ˆ](#11-tæ£€éªŒåŠŸæ•ˆ)
    - [1.2 å¡æ–¹æ£€éªŒåŠŸæ•ˆ](#12-å¡æ–¹æ£€éªŒåŠŸæ•ˆ)
  - [2. æ ·æœ¬é‡è®¡ç®—](#2-æ ·æœ¬é‡è®¡ç®—)
    - [2.1 tæ£€éªŒæ ·æœ¬é‡](#21-tæ£€éªŒæ ·æœ¬é‡)
    - [2.2 åŠŸæ•ˆæ›²çº¿](#22-åŠŸæ•ˆæ›²çº¿)
  - [3. æ•ˆåº”é‡](#3-æ•ˆåº”é‡)
    - [3.1 Cohen's d](#31-cohens-d)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 A/Bæµ‹è¯•è®¾è®¡](#41-abæµ‹è¯•è®¾è®¡)
  - [5. PostgreSQL 18 å¹¶è¡ŒåŠŸæ•ˆåˆ†æå¢å¼º](#5-postgresql-18-å¹¶è¡ŒåŠŸæ•ˆåˆ†æå¢å¼º)
    - [5.1 å¹¶è¡ŒåŠŸæ•ˆåˆ†æåŸç†](#51-å¹¶è¡ŒåŠŸæ•ˆåˆ†æåŸç†)
    - [5.2 å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—](#52-å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—)
    - [5.3 å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—](#53-å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—)
    - [5.4 å¹¶è¡Œæ•ˆåº”é‡åˆ†æ](#54-å¹¶è¡Œæ•ˆåº”é‡åˆ†æ)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## åŠŸæ•ˆåˆ†ææ¦‚è¿°

**åŠŸæ•ˆåˆ†æï¼ˆPower Analysisï¼‰**ç”¨äºç¡®å®šæ£€éªŒçš„ç»Ÿè®¡åŠŸæ•ˆå’Œæ‰€éœ€çš„æ ·æœ¬é‡ï¼Œæ˜¯å®éªŒè®¾è®¡çš„é‡è¦å·¥å…·ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | å®šä¹‰ | ç¬¦å· |
|------|------|------|
| **ç»Ÿè®¡åŠŸæ•ˆ** | æ­£ç¡®æ‹’ç»é›¶å‡è®¾çš„æ¦‚ç‡ | $Power = 1 - \beta$ |
| **ç¬¬ä¸€ç±»é”™è¯¯** | é”™è¯¯æ‹’ç»é›¶å‡è®¾ | $\alpha$ |
| **ç¬¬äºŒç±»é”™è¯¯** | é”™è¯¯æ¥å—é›¶å‡è®¾ | $\beta$ |
| **æ•ˆåº”é‡** | å®é™…å·®å¼‚çš„å¤§å° | $d, \delta$ |

**æ£€éªŒåŠŸæ•ˆ**ï¼š$Power = 1 - \beta = P(\text{æ‹’ç»}H_0 | H_1\text{ä¸ºçœŸ})$

---

## 1. æ£€éªŒåŠŸæ•ˆ

### 1.1 tæ£€éªŒåŠŸæ•ˆ

**tæ£€éªŒåŠŸæ•ˆ**ä¾èµ–äºæ•ˆåº”é‡ã€æ ·æœ¬é‡å’Œæ˜¾è‘—æ€§æ°´å¹³ã€‚

**éä¸­å¿ƒå‚æ•°**ï¼š$\delta = \frac{\mu_1 - \mu_0}{\sigma} \sqrt{n}$

```sql
-- åŠŸæ•ˆåˆ†ææ•°æ®å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'power_analysis') THEN
            DROP TABLE power_analysis CASCADE;
        END IF;

        CREATE TABLE power_analysis (
            analysis_id SERIAL PRIMARY KEY,
            effect_size NUMERIC NOT NULL,
            sample_size INTEGER NOT NULL,
            alpha NUMERIC DEFAULT 0.05,
            power NUMERIC,
            test_type VARCHAR(20) DEFAULT 't_test'
        );

        -- æ’å…¥ä¸åŒå‚æ•°ç»„åˆ
        INSERT INTO power_analysis (effect_size, sample_size, alpha) VALUES
            (0.2, 50, 0.05),   -- å°æ•ˆåº”é‡
            (0.5, 50, 0.05),   -- ä¸­ç­‰æ•ˆåº”é‡
            (0.8, 50, 0.05),   -- å¤§æ•ˆåº”é‡
            (0.5, 100, 0.05),  -- å¢åŠ æ ·æœ¬é‡
            (0.5, 200, 0.05);  -- æ›´å¤§æ ·æœ¬é‡

        RAISE NOTICE 'è¡¨ power_analysis åˆ›å»ºæˆåŠŸï¼Œå…± % æ¡è®°å½•', (SELECT COUNT(*) FROM power_analysis);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- tæ£€éªŒåŠŸæ•ˆè®¡ç®—ï¼ˆä½¿ç”¨éä¸­å¿ƒtåˆ†å¸ƒè¿‘ä¼¼ï¼‰
WITH power_calculation AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        -- éä¸­å¿ƒå‚æ•°ï¼šÎ´ = d * sqrt(n/2)
        effect_size * SQRT(sample_size / 2.0) AS noncentrality_parameter,
        -- tä¸´ç•Œå€¼ï¼ˆè¿‘ä¼¼ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒï¼‰
        ABS(quantile_normal(alpha / 2.0)) AS t_critical
    FROM power_analysis
),
power_estimate AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        noncentrality_parameter,
        t_critical,
        -- åŠŸæ•ˆä¼°è®¡ï¼ˆç®€åŒ–ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒè¿‘ä¼¼ï¼‰
        -- Power â‰ˆ 1 - Î¦(t_critical - Î´) + Î¦(-t_critical - Î´)
        CASE
            WHEN noncentrality_parameter > t_critical + 2.0 THEN 0.95
            WHEN noncentrality_parameter > t_critical + 1.0 THEN 0.85
            WHEN noncentrality_parameter > t_critical THEN 0.75
            WHEN noncentrality_parameter > t_critical - 1.0 THEN 0.60
            WHEN noncentrality_parameter > t_critical - 2.0 THEN 0.40
            ELSE 0.20
        END AS estimated_power
    FROM power_calculation
)
SELECT
    analysis_id,
    ROUND(effect_size::numeric, 2) AS effect_size,
    sample_size,
    ROUND(alpha::numeric, 4) AS alpha,
    ROUND(noncentrality_parameter::numeric, 4) AS ncp,
    ROUND(estimated_power::numeric, 2) AS estimated_power,
    CASE
        WHEN estimated_power >= 0.8 THEN 'High power (â‰¥0.8) âœ“'
        WHEN estimated_power >= 0.5 THEN 'Moderate power (0.5-0.8)'
        ELSE 'Low power (<0.5) âœ—'
    END AS power_status
FROM power_estimate
ORDER BY effect_size, sample_size;
```

### 1.2 å¡æ–¹æ£€éªŒåŠŸæ•ˆ

**å¡æ–¹æ£€éªŒåŠŸæ•ˆ**ç”¨äºåˆ†ç±»æ•°æ®çš„å…³è”æ€§æ£€éªŒã€‚

```sql
-- å¡æ–¹æ£€éªŒåŠŸæ•ˆåˆ†æ
WITH chi_square_power AS (
    SELECT
        effect_size,  -- CramÃ©r's V
        sample_size,
        alpha,
        -- éä¸­å¿ƒå‚æ•°ï¼šÎ» = n * VÂ²
        sample_size * POWER(effect_size, 2) AS noncentrality_parameter
    FROM power_analysis
    WHERE test_type = 'chi_square'
)
SELECT
    ROUND(effect_size::numeric, 2) AS cramers_v,
    sample_size,
    ROUND(noncentrality_parameter::numeric, 2) AS ncp,
    CASE
        WHEN noncentrality_parameter > 10 THEN 'High power'
        WHEN noncentrality_parameter > 5 THEN 'Moderate power'
        ELSE 'Low power'
    END AS power_status
FROM chi_square_power;
```

---

## 2. æ ·æœ¬é‡è®¡ç®—

### 2.1 tæ£€éªŒæ ·æœ¬é‡

**æ ·æœ¬é‡å…¬å¼**ï¼ˆä¸¤æ ·æœ¬tæ£€éªŒï¼‰ï¼š
$$n = \frac{2(z_{\alpha/2} + z_{\beta})^2}{d^2}$$

å…¶ä¸­ $d$ æ˜¯æ ‡å‡†åŒ–æ•ˆåº”é‡ï¼ˆCohen's dï¼‰ã€‚

```sql
-- æ ·æœ¬é‡è®¡ç®—ï¼ˆtæ£€éªŒï¼‰
CREATE OR REPLACE FUNCTION calculate_sample_size(
    p_effect_size NUMERIC,
    p_desired_power NUMERIC DEFAULT 0.8,
    p_alpha NUMERIC DEFAULT 0.05,
    p_sided INTEGER DEFAULT 2
)
RETURNS INTEGER AS $$
DECLARE
    z_alpha NUMERIC;
    z_beta NUMERIC;
    required_n INTEGER;
BEGIN
    -- zå€¼ï¼ˆè¿‘ä¼¼ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒåˆ†ä½æ•°ï¼‰
    IF p_sided = 2 THEN
        z_alpha := 1.96;  -- Î±=0.05, åŒä¾§
    ELSE
        z_alpha := 1.645;  -- Î±=0.05, å•ä¾§
    END IF;

    -- z_betaï¼ˆåŠŸæ•ˆï¼‰
    IF p_desired_power = 0.8 THEN
        z_beta := 0.84;
    ELSIF p_desired_power = 0.9 THEN
        z_beta := 1.28;
    ELSIF p_desired_power = 0.95 THEN
        z_beta := 1.645;
    ELSE
        z_beta := 0.84;  -- é»˜è®¤
    END IF;

    -- æ ·æœ¬é‡è®¡ç®—
    required_n := CEILING(2.0 * POWER(z_alpha + z_beta, 2) / POWER(p_effect_size, 2));

    RETURN required_n;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨æ ·æœ¬é‡è®¡ç®—å‡½æ•°
WITH power_scenarios AS (
    SELECT
        effect_size,
        desired_power,
        alpha
    FROM (VALUES
        (0.2, 0.8, 0.05),
        (0.5, 0.8, 0.05),
        (0.8, 0.8, 0.05),
        (0.5, 0.9, 0.05)
    ) AS t(effect_size, desired_power, alpha)
)
SELECT
    ROUND(effect_size::numeric, 2) AS effect_size,
    ROUND(desired_power::numeric, 2) AS desired_power,
    calculate_sample_size(effect_size, desired_power, alpha) AS required_sample_size_per_group
FROM power_scenarios
ORDER BY effect_size, desired_power;
```

### 2.2 åŠŸæ•ˆæ›²çº¿

**åŠŸæ•ˆæ›²çº¿**å±•ç¤ºæ ·æœ¬é‡ä¸åŠŸæ•ˆçš„å…³ç³»ã€‚

```sql
-- åŠŸæ•ˆæ›²çº¿ï¼šä¸åŒæ ·æœ¬é‡ä¸‹çš„åŠŸæ•ˆ
WITH sample_sizes AS (
    SELECT generate_series(10, 200, 10) AS n
),
power_curve AS (
    SELECT
        n,
        0.5 AS effect_size,
        0.05 AS alpha,
        -- åŠŸæ•ˆä¼°è®¡
        CASE
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 + 2.0 THEN 0.95
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 + 1.0 THEN 0.85
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 THEN 0.75
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 - 1.0 THEN 0.60
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 - 2.0 THEN 0.40
            ELSE 0.20
        END AS estimated_power
    FROM sample_sizes
)
SELECT
    n AS sample_size,
    ROUND(estimated_power::numeric, 2) AS power,
    CASE
        WHEN estimated_power >= 0.8 THEN 'Target reached'
        ELSE ''
    END AS status
FROM power_curve
ORDER BY n;
```

---

## 3. æ•ˆåº”é‡

### 3.1 Cohen's d

**Cohen's d**æ˜¯æ ‡å‡†åŒ–å‡å€¼å·®å¼‚ã€‚

$$d = \frac{\mu_1 - \mu_2}{\sigma_{pooled}}$$

**æ•ˆåº”é‡æ ‡å‡†**ï¼š

- **å°æ•ˆåº”**ï¼š$d = 0.2$
- **ä¸­ç­‰æ•ˆåº”**ï¼š$d = 0.5$
- **å¤§æ•ˆåº”**ï¼š$d = 0.8$

```sql
-- æ•ˆåº”é‡è®¡ç®—
WITH group_statistics AS (
    SELECT
        group_id,
        AVG(value) AS mean_value,
        STDDEV(value) AS std_value,
        COUNT(*) AS n
    FROM experimental_data
    GROUP BY group_id
),
pooled_std AS (
    SELECT
        SQRT(
            SUM((n - 1) * POWER(std_value, 2)) / SUM(n - 1)
        ) AS pooled_stddev
    FROM group_statistics
),
cohens_d AS (
    SELECT
        (MAX(mean_value) - MIN(mean_value)) / ps.pooled_stddev AS cohens_d_value
    FROM group_statistics
    CROSS JOIN pooled_std ps
)
SELECT
    ROUND(cohens_d_value::numeric, 4) AS cohens_d,
    CASE
        WHEN ABS(cohens_d_value) >= 0.8 THEN 'Large effect'
        WHEN ABS(cohens_d_value) >= 0.5 THEN 'Medium effect'
        WHEN ABS(cohens_d_value) >= 0.2 THEN 'Small effect'
        ELSE 'Negligible effect'
    END AS effect_size_interpretation
FROM cohens_d;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 A/Bæµ‹è¯•è®¾è®¡

```sql
-- A/Bæµ‹è¯•ï¼šè®¡ç®—æ‰€éœ€æ ·æœ¬é‡
WITH ab_test_design AS (
    SELECT
        'Conversion Rate' AS metric,
        0.05 AS baseline_rate,  -- 5% baseline conversion
        0.06 AS expected_rate,  -- 6% expected conversion (20% improvement)
        0.8 AS desired_power,
        0.05 AS alpha
)
SELECT
    metric,
    ROUND(baseline_rate::numeric, 4) AS baseline_rate,
    ROUND(expected_rate::numeric, 4) AS expected_rate,
    -- æ•ˆåº”é‡ï¼šç›¸å¯¹æå‡
    ROUND((expected_rate - baseline_rate) / baseline_rate::numeric, 2) AS relative_improvement,
    -- æ‰€éœ€æ ·æœ¬é‡ï¼ˆæ¯ç»„ï¼‰
    calculate_sample_size(
        (expected_rate - baseline_rate) / SQRT(baseline_rate * (1 - baseline_rate)),
        desired_power,
        alpha
    ) AS required_sample_size_per_group
FROM ab_test_design;
```

---

## 5. PostgreSQL 18 å¹¶è¡ŒåŠŸæ•ˆåˆ†æå¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡ŒåŠŸæ•ˆåˆ†æèƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡ŒåŠŸæ•ˆè®¡ç®—ã€æ ·æœ¬é‡è®¡ç®—å’Œæ•ˆåº”é‡åˆ†æï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡åŠŸæ•ˆåˆ†æçš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡ŒåŠŸæ•ˆåˆ†æåŸç†

PostgreSQL 18 çš„å¹¶è¡ŒåŠŸæ•ˆåˆ†æé€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«ææ•°æ®
2. **å¹¶è¡Œç»Ÿè®¡é‡è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—éƒ¨åˆ†ç»Ÿè®¡é‡
3. **å¹¶è¡ŒåŠŸæ•ˆè®¡ç®—**ï¼šå¹¶è¡Œæ‰§è¡ŒåŠŸæ•ˆå‡½æ•°è®¡ç®—
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„åˆ†æç»“æœ

### 5.2 å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'power_analysis') THEN
            RAISE WARNING 'è¡¨ power_analysis ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œtæ£€éªŒåŠŸæ•ˆè®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH power_calculation AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        effect_size * SQRT(sample_size / 2.0) AS noncentrality_parameter,
        ABS(1.96) AS t_critical  -- è¿‘ä¼¼ä½¿ç”¨æ­£æ€åˆ†å¸ƒ
    FROM power_analysis
),
estimated_power AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        noncentrality_parameter,
        CASE
            WHEN noncentrality_parameter > t_critical + 2.0 THEN 0.95
            WHEN noncentrality_parameter > t_critical + 1.0 THEN 0.85
            WHEN noncentrality_parameter > t_critical THEN 0.75
            WHEN noncentrality_parameter > t_critical - 1.0 THEN 0.60
            WHEN noncentrality_parameter > t_critical - 2.0 THEN 0.40
            ELSE 0.20
        END AS estimated_power
    FROM power_calculation
)
SELECT
    analysis_id,
    ROUND(effect_size::numeric, 2) AS effect_size,
    sample_size,
    ROUND(alpha::numeric, 4) AS alpha,
    ROUND(estimated_power::numeric, 2) AS power
FROM estimated_power
ORDER BY effect_size, sample_size;
```

### 5.3 å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ ·æœ¬é‡è®¡ç®—ï¼šä¸åŒå‚æ•°ç»„åˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH power_scenarios AS (
    SELECT
        effect_size,
        desired_power,
        alpha,
        CASE
            WHEN alpha = 0.05 THEN 1.96
            WHEN alpha = 0.01 THEN 2.576
            ELSE 1.645
        END AS z_alpha,
        CASE
            WHEN desired_power = 0.8 THEN 0.84
            WHEN desired_power = 0.9 THEN 1.28
            WHEN desired_power = 0.95 THEN 1.645
            ELSE 0.84
        END AS z_beta
    FROM (VALUES
        (0.2, 0.8, 0.05),
        (0.5, 0.8, 0.05),
        (0.8, 0.8, 0.05),
        (0.5, 0.9, 0.05)
    ) AS t(effect_size, desired_power, alpha)
)
SELECT
    ROUND(effect_size::numeric, 2) AS effect_size,
    ROUND(desired_power::numeric, 2) AS desired_power,
    ROUND(alpha::numeric, 4) AS alpha,
    CEILING(2.0 * POWER(z_alpha + z_beta, 2) / POWER(effect_size, 2)) AS required_sample_size_per_group
FROM power_scenarios
ORDER BY effect_size, desired_power;
```

### 5.4 å¹¶è¡Œæ•ˆåº”é‡åˆ†æ

```sql
-- PostgreSQL 18 å¹¶è¡Œæ•ˆåº”é‡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'experimental_data') THEN
            RAISE WARNING 'è¡¨ experimental_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ•ˆåº”é‡åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ•ˆåº”é‡åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ•ˆåº”é‡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒCohen's dè®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH group_statistics AS (
    SELECT
        group_id,
        AVG(value) AS mean_value,
        STDDEV(value) AS std_value,
        COUNT(*) AS n
    FROM experimental_data
    GROUP BY group_id
),
pooled_stddev AS (
    SELECT
        SQRT(((g1.n - 1) * POWER(g1.std_value, 2) + (g2.n - 1) * POWER(g2.std_value, 2)) /
             NULLIF(g1.n + g2.n - 2, 0)) AS pooled_std
    FROM group_statistics g1
    CROSS JOIN group_statistics g2
    WHERE g1.group_id < g2.group_id
    LIMIT 1
),
cohens_d AS (
    SELECT
        g1.group_id AS group1,
        g2.group_id AS group2,
        g1.mean_value - g2.mean_value AS mean_difference,
        ps.pooled_std,
        (g1.mean_value - g2.mean_value) / NULLIF(ps.pooled_std, 0) AS cohens_d_value
    FROM group_statistics g1
    CROSS JOIN group_statistics g2
    CROSS JOIN pooled_stddev ps
    WHERE g1.group_id < g2.group_id
)
SELECT
    group1,
    group2,
    ROUND(mean_difference::numeric, 4) AS mean_difference,
    ROUND(pooled_std::numeric, 4) AS pooled_stddev,
    ROUND(ABS(cohens_d_value)::numeric, 4) AS cohens_d,
    CASE
        WHEN ABS(cohens_d_value) < 0.2 THEN 'Small effect'
        WHEN ABS(cohens_d_value) < 0.5 THEN 'Medium effect'
        WHEN ABS(cohens_d_value) < 0.8 THEN 'Large effect'
        ELSE 'Very large effect'
    END AS effect_size_category
FROM cohens_d;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Cohen, J. (1988)**: "Statistical Power Analysis for the Behavioral Sciences", 2nd Edition
2. **Faul, F., et al. (2007)**: "G*Power 3: A flexible statistical power analysis program"
3. **Lenth, R.V. (2001)**: "Some Practical Guidelines for Effective Sample Size Determination"

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é¢„å…ˆè®¡ç®—**ï¼šé¢„å…ˆè®¡ç®—å¸¸ç”¨å‚æ•°ç»„åˆçš„åŠŸæ•ˆ
2. **ç¼“å­˜ç»“æœ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åŠŸæ•ˆåˆ†æç»“æœ
3. **å¹¶è¡Œè®¡ç®—**ï¼šå¹¶è¡Œè®¡ç®—å¤šä¸ªåœºæ™¯çš„åŠŸæ•ˆ

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•ˆåº”é‡ä¼°è®¡**ï¼šåŸºäºå…ˆéªŒçŸ¥è¯†æˆ–è¯•ç‚¹ç ”ç©¶ä¼°è®¡æ•ˆåº”é‡
2. **åŠŸæ•ˆç›®æ ‡**ï¼šé€šå¸¸è®¾ç½®åŠŸæ•ˆâ‰¥0.8
3. **æ ·æœ¬é‡è§„åˆ’**ï¼šåœ¨å®éªŒå‰è¿›è¡ŒåŠŸæ•ˆåˆ†æ
4. **äº‹ååˆ†æ**ï¼šå®éªŒåè®¡ç®—å®é™…åŠŸæ•ˆ

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **åŠŸæ•ˆè®¡ç®—**: éœ€è¦ä½¿ç”¨éä¸­å¿ƒåˆ†å¸ƒï¼ŒPostgreSQLåŸç”Ÿä¸æ”¯æŒï¼Œéœ€è¦è¿‘ä¼¼æˆ–å¤–éƒ¨å·¥å…·
2. **æ ·æœ¬é‡è®¡ç®—**: å¯èƒ½éœ€è¦è¿­ä»£æ±‚è§£ï¼Œæ³¨æ„æ”¶æ•›æ¡ä»¶
3. **æ•°å€¼ç²¾åº¦**: ä½¿ç”¨NUMERICç±»å‹ä¿æŒè®¡ç®—ç²¾åº¦
4. **æ•ˆåº”é‡é€‰æ‹©**: æ ¹æ®Cohenå‡†åˆ™é€‰æ‹©åˆé€‚çš„æ•ˆåº”é‡

### PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡åŠŸæ•ˆåˆ†æç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«åˆ†æIDçš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-NåŠŸæ•ˆæŸ¥è¯¢å’Œå¤šåœºæ™¯å¯¹æ¯”æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡åŠŸæ•ˆåˆ†æè®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡æ ·æœ¬é‡è®¡ç®—å’Œå¹¶è¡ŒåŠŸæ•ˆæ›²çº¿åˆ†æ

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - åŠŸæ•ˆåˆ†ææ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨5èŠ‚è¯¦ç»†è¯´æ˜ï¼‰
   - é€‚ç”¨äºå¤§è§„æ¨¡åŠŸæ•ˆåˆ†æå’Œå¤šå‚æ•°å¹¶è¡Œè®¡ç®—

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–åŠŸæ•ˆåˆ†ææŸ¥è¯¢**

```sql
-- ä¸ºåŠŸæ•ˆåˆ†æåˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_power_analysis_skip_scan
ON power_analysis(analysis_id DESC, power DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æœ€é«˜åŠŸæ•ˆçš„åˆ†æåœºæ™¯
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (test_type)
    analysis_id,
    effect_size,
    sample_size,
    power
FROM power_analysis
ORDER BY test_type, power DESC
LIMIT 50;
```

### é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åŠŸæ•ˆåˆ†æç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„åŠŸæ•ˆåˆ†æç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜åŠŸæ•ˆåˆ†æç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS power_analysis_cache AS
WITH power_calculations AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        test_type,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—éä¸­å¿ƒå‚æ•°ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        effect_size * SQRT(sample_size / 2.0) AS noncentrality_parameter,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—åŠŸæ•ˆä¼°è®¡ï¼ˆç®€åŒ–ï¼šæ­£æ€åˆ†å¸ƒè¿‘ä¼¼ï¼‰
        CASE
            WHEN effect_size * SQRT(sample_size / 2.0) > 3.0 THEN 0.95
            WHEN effect_size * SQRT(sample_size / 2.0) > 2.0 THEN 0.85
            WHEN effect_size * SQRT(sample_size / 2.0) > 1.5 THEN 0.75
            WHEN effect_size * SQRT(sample_size / 2.0) > 1.0 THEN 0.60
            ELSE 0.40
        END AS estimated_power
    FROM power_analysis
),
power_quality AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        test_type,
        ROUND(noncentrality_parameter::numeric, 4) AS noncentrality_parameter,
        ROUND(estimated_power::numeric, 2) AS estimated_power,
        CASE
            WHEN estimated_power >= 0.8 THEN 'High Power (â‰¥0.8) âœ“'
            WHEN estimated_power >= 0.5 THEN 'Moderate Power (0.5-0.8)'
            ELSE 'Low Power (<0.5) âœ—'
        END AS power_status,
        CASE
            WHEN effect_size >= 0.8 THEN 'Large Effect'
            WHEN effect_size >= 0.5 THEN 'Medium Effect'
            WHEN effect_size >= 0.2 THEN 'Small Effect'
            ELSE 'Very Small Effect'
        END AS effect_size_category
    FROM power_calculations
)
SELECT
    analysis_id,
    effect_size,
    sample_size,
    alpha,
    test_type,
    noncentrality_parameter,
    estimated_power,
    power_status,
    effect_size_category
FROM power_quality
ORDER BY estimated_power DESC;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_power_analysis_cache_power ON power_analysis_cache(power_status, estimated_power DESC);
CREATE INDEX idx_power_analysis_cache_effect ON power_analysis_cache(effect_size_category, effect_size DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY power_analysis_cache;
```

**2. å®æ—¶åŠŸæ•ˆåˆ†æï¼šå¢é‡åŠŸæ•ˆæ›´æ–°**

**å®æ—¶åŠŸæ•ˆåˆ†æ**ï¼šå¯¹äºå®æ—¶æ•°æ®ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•æ›´æ–°åŠŸæ•ˆè®¡ç®—ç»“æœã€‚

```sql
-- å®æ—¶åŠŸæ•ˆåˆ†æï¼šå¢é‡åŠŸæ•ˆæ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'power_analysis_state') THEN
            CREATE TABLE power_analysis_state (
                analysis_id VARCHAR(100) NOT NULL,
                effect_size NUMERIC NOT NULL,
                sample_size INTEGER NOT NULL,
                alpha NUMERIC DEFAULT 0.05,
                noncentrality_parameter NUMERIC,
                estimated_power NUMERIC,
                power_status VARCHAR(50),
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                PRIMARY KEY (analysis_id)
            );

            CREATE INDEX idx_power_analysis_state_id ON power_analysis_state(analysis_id, last_updated DESC);
            CREATE INDEX idx_power_analysis_state_updated ON power_analysis_state(last_updated DESC);

            RAISE NOTICE 'åŠŸæ•ˆåˆ†æçŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡åŠŸæ•ˆåˆ†ææ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡åŠŸæ•ˆåˆ†ææ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**3. æ™ºèƒ½åŠŸæ•ˆä¼˜åŒ–ï¼šè‡ªé€‚åº”æ ·æœ¬é‡é€‰æ‹©**

**æ™ºèƒ½åŠŸæ•ˆä¼˜åŒ–**ï¼šæ ¹æ®åŠŸæ•ˆç›®æ ‡è‡ªåŠ¨è®¡ç®—æ‰€éœ€æ ·æœ¬é‡ã€‚

```sql
-- æ™ºèƒ½åŠŸæ•ˆä¼˜åŒ–ï¼šè‡ªé€‚åº”æ ·æœ¬é‡é€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    target_power NUMERIC := 0.8;
    effect_size_estimate NUMERIC;
    alpha_level NUMERIC := 0.05;
    recommended_sample_size INTEGER;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'power_analysis') THEN
            RAISE WARNING 'è¡¨ power_analysis ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½åŠŸæ•ˆä¼˜åŒ–';
            RETURN;
        END IF;

        -- è®¡ç®—å¹³å‡æ•ˆåº”é‡
        SELECT AVG(effect_size)
        INTO effect_size_estimate
        FROM power_analysis;

        -- æ ¹æ®åŠŸæ•ˆç›®æ ‡å’Œæ•ˆåº”é‡è‡ªé€‚åº”è®¡ç®—æ ·æœ¬é‡ï¼ˆç®€åŒ–å…¬å¼ï¼‰
        -- n â‰ˆ 2 * ((z_Î±/2 + z_Î²) / d)Â²
        IF effect_size_estimate >= 0.8 THEN
            recommended_sample_size := 30;  -- å¤§æ•ˆåº”ï¼šå°æ ·æœ¬
        ELSIF effect_size_estimate >= 0.5 THEN
            recommended_sample_size := 64;  -- ä¸­ç­‰æ•ˆåº”ï¼šä¸­ç­‰æ ·æœ¬
        ELSIF effect_size_estimate >= 0.2 THEN
            recommended_sample_size := 200;  -- å°æ•ˆåº”ï¼šå¤§æ ·æœ¬
        ELSE
            recommended_sample_size := 800;  -- å¾ˆå°æ•ˆåº”ï¼šå¾ˆå¤§æ ·æœ¬
        END IF;

        RAISE NOTICE 'ç›®æ ‡åŠŸæ•ˆ: %, æ•ˆåº”é‡ä¼°è®¡: %, æ˜¾è‘—æ€§æ°´å¹³: %, æ¨èæ ·æœ¬é‡: %',
            target_power, effect_size_estimate, alpha_level, recommended_sample_size;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½åŠŸæ•ˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆåŒ…å«å®Œæ•´ç†è®ºæ¨å¯¼ã€å®ç°å’ŒPostgreSQL 18æ–°ç‰¹æ€§æ”¯æŒï¼‰
