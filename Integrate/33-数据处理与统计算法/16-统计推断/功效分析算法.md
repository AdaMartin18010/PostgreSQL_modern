# PostgreSQL åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç»Ÿè®¡æ¨æ–­ | åŠŸæ•ˆåˆ†æ | æ ·æœ¬é‡è®¡ç®—
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Statistical Power Analysis, Sample Size Calculation, Effect Size

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-åŠŸæ•ˆåˆ†æç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [åŠŸæ•ˆåˆ†ææ¦‚è¿°](#åŠŸæ•ˆåˆ†ææ¦‚è¿°)
    - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
  - [1. æ£€éªŒåŠŸæ•ˆ](#1-æ£€éªŒåŠŸæ•ˆ)
    - [1.1 tæ£€éªŒåŠŸæ•ˆ](#11-tæ£€éªŒåŠŸæ•ˆ)
    - [1.2 å¡æ–¹æ£€éªŒåŠŸæ•ˆ](#12-å¡æ–¹æ£€éªŒåŠŸæ•ˆ)
  - [2. æ ·æœ¬é‡è®¡ç®—](#2-æ ·æœ¬é‡è®¡ç®—)
    - [2.1 tæ£€éªŒæ ·æœ¬é‡](#21-tæ£€éªŒæ ·æœ¬é‡)
    - [2.2 åŠŸæ•ˆæ›²çº¿](#22-åŠŸæ•ˆæ›²çº¿)
  - [3. æ•ˆåº”é‡](#3-æ•ˆåº”é‡)
    - [3.1 Cohen's d](#31-cohens-d)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 A/Bæµ‹è¯•è®¾è®¡](#41-abæµ‹è¯•è®¾è®¡)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## åŠŸæ•ˆåˆ†ææ¦‚è¿°

**åŠŸæ•ˆåˆ†æï¼ˆPower Analysisï¼‰**ç”¨äºç¡®å®šæ£€éªŒçš„ç»Ÿè®¡åŠŸæ•ˆå’Œæ‰€éœ€çš„æ ·æœ¬é‡ï¼Œæ˜¯å®éªŒè®¾è®¡çš„é‡è¦å·¥å…·ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | å®šä¹‰ | ç¬¦å· |
|------|------|------|
| **ç»Ÿè®¡åŠŸæ•ˆ** | æ­£ç¡®æ‹’ç»é›¶å‡è®¾çš„æ¦‚ç‡ | $Power = 1 - \beta$ |
| **ç¬¬ä¸€ç±»é”™è¯¯** | é”™è¯¯æ‹’ç»é›¶å‡è®¾ | $\alpha$ |
| **ç¬¬äºŒç±»é”™è¯¯** | é”™è¯¯æ¥å—é›¶å‡è®¾ | $\beta$ |
| **æ•ˆåº”é‡** | å®é™…å·®å¼‚çš„å¤§å° | $d, \delta$ |

**æ£€éªŒåŠŸæ•ˆ**ï¼š$Power = 1 - \beta = P(\text{æ‹’ç»}H_0 | H_1\text{ä¸ºçœŸ})$

---

## 1. æ£€éªŒåŠŸæ•ˆ

### 1.1 tæ£€éªŒåŠŸæ•ˆ

**tæ£€éªŒåŠŸæ•ˆ**ä¾èµ–äºæ•ˆåº”é‡ã€æ ·æœ¬é‡å’Œæ˜¾è‘—æ€§æ°´å¹³ã€‚

**éä¸­å¿ƒå‚æ•°**ï¼š$\delta = \frac{\mu_1 - \mu_0}{\sigma} \sqrt{n}$

```sql
-- åŠŸæ•ˆåˆ†ææ•°æ®å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'power_analysis') THEN
            DROP TABLE power_analysis CASCADE;
        END IF;

        CREATE TABLE power_analysis (
            analysis_id SERIAL PRIMARY KEY,
            effect_size NUMERIC NOT NULL,
            sample_size INTEGER NOT NULL,
            alpha NUMERIC DEFAULT 0.05,
            power NUMERIC,
            test_type VARCHAR(20) DEFAULT 't_test'
        );

        -- æ’å…¥ä¸åŒå‚æ•°ç»„åˆ
        INSERT INTO power_analysis (effect_size, sample_size, alpha) VALUES
            (0.2, 50, 0.05),   -- å°æ•ˆåº”é‡
            (0.5, 50, 0.05),   -- ä¸­ç­‰æ•ˆåº”é‡
            (0.8, 50, 0.05),   -- å¤§æ•ˆåº”é‡
            (0.5, 100, 0.05),  -- å¢åŠ æ ·æœ¬é‡
            (0.5, 200, 0.05);  -- æ›´å¤§æ ·æœ¬é‡

        RAISE NOTICE 'è¡¨ power_analysis åˆ›å»ºæˆåŠŸï¼Œå…± % æ¡è®°å½•', (SELECT COUNT(*) FROM power_analysis);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- tæ£€éªŒåŠŸæ•ˆè®¡ç®—ï¼ˆä½¿ç”¨éä¸­å¿ƒtåˆ†å¸ƒè¿‘ä¼¼ï¼‰
WITH power_calculation AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        -- éä¸­å¿ƒå‚æ•°ï¼šÎ´ = d * sqrt(n/2)
        effect_size * SQRT(sample_size / 2.0) AS noncentrality_parameter,
        -- tä¸´ç•Œå€¼ï¼ˆè¿‘ä¼¼ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒï¼‰
        ABS(quantile_normal(alpha / 2.0)) AS t_critical
    FROM power_analysis
),
power_estimate AS (
    SELECT
        analysis_id,
        effect_size,
        sample_size,
        alpha,
        noncentrality_parameter,
        t_critical,
        -- åŠŸæ•ˆä¼°è®¡ï¼ˆç®€åŒ–ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒè¿‘ä¼¼ï¼‰
        -- Power â‰ˆ 1 - Î¦(t_critical - Î´) + Î¦(-t_critical - Î´)
        CASE
            WHEN noncentrality_parameter > t_critical + 2.0 THEN 0.95
            WHEN noncentrality_parameter > t_critical + 1.0 THEN 0.85
            WHEN noncentrality_parameter > t_critical THEN 0.75
            WHEN noncentrality_parameter > t_critical - 1.0 THEN 0.60
            WHEN noncentrality_parameter > t_critical - 2.0 THEN 0.40
            ELSE 0.20
        END AS estimated_power
    FROM power_calculation
)
SELECT
    analysis_id,
    ROUND(effect_size::numeric, 2) AS effect_size,
    sample_size,
    ROUND(alpha::numeric, 4) AS alpha,
    ROUND(noncentrality_parameter::numeric, 4) AS ncp,
    ROUND(estimated_power::numeric, 2) AS estimated_power,
    CASE
        WHEN estimated_power >= 0.8 THEN 'High power (â‰¥0.8) âœ“'
        WHEN estimated_power >= 0.5 THEN 'Moderate power (0.5-0.8)'
        ELSE 'Low power (<0.5) âœ—'
    END AS power_status
FROM power_estimate
ORDER BY effect_size, sample_size;
```

### 1.2 å¡æ–¹æ£€éªŒåŠŸæ•ˆ

**å¡æ–¹æ£€éªŒåŠŸæ•ˆ**ç”¨äºåˆ†ç±»æ•°æ®çš„å…³è”æ€§æ£€éªŒã€‚

```sql
-- å¡æ–¹æ£€éªŒåŠŸæ•ˆåˆ†æ
WITH chi_square_power AS (
    SELECT
        effect_size,  -- CramÃ©r's V
        sample_size,
        alpha,
        -- éä¸­å¿ƒå‚æ•°ï¼šÎ» = n * VÂ²
        sample_size * POWER(effect_size, 2) AS noncentrality_parameter
    FROM power_analysis
    WHERE test_type = 'chi_square'
)
SELECT
    ROUND(effect_size::numeric, 2) AS cramers_v,
    sample_size,
    ROUND(noncentrality_parameter::numeric, 2) AS ncp,
    CASE
        WHEN noncentrality_parameter > 10 THEN 'High power'
        WHEN noncentrality_parameter > 5 THEN 'Moderate power'
        ELSE 'Low power'
    END AS power_status
FROM chi_square_power;
```

---

## 2. æ ·æœ¬é‡è®¡ç®—

### 2.1 tæ£€éªŒæ ·æœ¬é‡

**æ ·æœ¬é‡å…¬å¼**ï¼ˆä¸¤æ ·æœ¬tæ£€éªŒï¼‰ï¼š
$$n = \frac{2(z_{\alpha/2} + z_{\beta})^2}{d^2}$$

å…¶ä¸­ $d$ æ˜¯æ ‡å‡†åŒ–æ•ˆåº”é‡ï¼ˆCohen's dï¼‰ã€‚

```sql
-- æ ·æœ¬é‡è®¡ç®—ï¼ˆtæ£€éªŒï¼‰
CREATE OR REPLACE FUNCTION calculate_sample_size(
    p_effect_size NUMERIC,
    p_desired_power NUMERIC DEFAULT 0.8,
    p_alpha NUMERIC DEFAULT 0.05,
    p_sided INTEGER DEFAULT 2
)
RETURNS INTEGER AS $$
DECLARE
    z_alpha NUMERIC;
    z_beta NUMERIC;
    required_n INTEGER;
BEGIN
    -- zå€¼ï¼ˆè¿‘ä¼¼ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒåˆ†ä½æ•°ï¼‰
    IF p_sided = 2 THEN
        z_alpha := 1.96;  -- Î±=0.05, åŒä¾§
    ELSE
        z_alpha := 1.645;  -- Î±=0.05, å•ä¾§
    END IF;

    -- z_betaï¼ˆåŠŸæ•ˆï¼‰
    IF p_desired_power = 0.8 THEN
        z_beta := 0.84;
    ELSIF p_desired_power = 0.9 THEN
        z_beta := 1.28;
    ELSIF p_desired_power = 0.95 THEN
        z_beta := 1.645;
    ELSE
        z_beta := 0.84;  -- é»˜è®¤
    END IF;

    -- æ ·æœ¬é‡è®¡ç®—
    required_n := CEILING(2.0 * POWER(z_alpha + z_beta, 2) / POWER(p_effect_size, 2));

    RETURN required_n;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨æ ·æœ¬é‡è®¡ç®—å‡½æ•°
WITH power_scenarios AS (
    SELECT
        effect_size,
        desired_power,
        alpha
    FROM (VALUES
        (0.2, 0.8, 0.05),
        (0.5, 0.8, 0.05),
        (0.8, 0.8, 0.05),
        (0.5, 0.9, 0.05)
    ) AS t(effect_size, desired_power, alpha)
)
SELECT
    ROUND(effect_size::numeric, 2) AS effect_size,
    ROUND(desired_power::numeric, 2) AS desired_power,
    calculate_sample_size(effect_size, desired_power, alpha) AS required_sample_size_per_group
FROM power_scenarios
ORDER BY effect_size, desired_power;
```

### 2.2 åŠŸæ•ˆæ›²çº¿

**åŠŸæ•ˆæ›²çº¿**å±•ç¤ºæ ·æœ¬é‡ä¸åŠŸæ•ˆçš„å…³ç³»ã€‚

```sql
-- åŠŸæ•ˆæ›²çº¿ï¼šä¸åŒæ ·æœ¬é‡ä¸‹çš„åŠŸæ•ˆ
WITH sample_sizes AS (
    SELECT generate_series(10, 200, 10) AS n
),
power_curve AS (
    SELECT
        n,
        0.5 AS effect_size,
        0.05 AS alpha,
        -- åŠŸæ•ˆä¼°è®¡
        CASE
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 + 2.0 THEN 0.95
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 + 1.0 THEN 0.85
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 THEN 0.75
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 - 1.0 THEN 0.60
            WHEN 0.5 * SQRT(n / 2.0) > 1.96 - 2.0 THEN 0.40
            ELSE 0.20
        END AS estimated_power
    FROM sample_sizes
)
SELECT
    n AS sample_size,
    ROUND(estimated_power::numeric, 2) AS power,
    CASE
        WHEN estimated_power >= 0.8 THEN 'Target reached'
        ELSE ''
    END AS status
FROM power_curve
ORDER BY n;
```

---

## 3. æ•ˆåº”é‡

### 3.1 Cohen's d

**Cohen's d**æ˜¯æ ‡å‡†åŒ–å‡å€¼å·®å¼‚ã€‚

$$d = \frac{\mu_1 - \mu_2}{\sigma_{pooled}}$$

**æ•ˆåº”é‡æ ‡å‡†**ï¼š

- **å°æ•ˆåº”**ï¼š$d = 0.2$
- **ä¸­ç­‰æ•ˆåº”**ï¼š$d = 0.5$
- **å¤§æ•ˆåº”**ï¼š$d = 0.8$

```sql
-- æ•ˆåº”é‡è®¡ç®—
WITH group_statistics AS (
    SELECT
        group_id,
        AVG(value) AS mean_value,
        STDDEV(value) AS std_value,
        COUNT(*) AS n
    FROM experimental_data
    GROUP BY group_id
),
pooled_std AS (
    SELECT
        SQRT(
            SUM((n - 1) * POWER(std_value, 2)) / SUM(n - 1)
        ) AS pooled_stddev
    FROM group_statistics
),
cohens_d AS (
    SELECT
        (MAX(mean_value) - MIN(mean_value)) / ps.pooled_stddev AS cohens_d_value
    FROM group_statistics
    CROSS JOIN pooled_std ps
)
SELECT
    ROUND(cohens_d_value::numeric, 4) AS cohens_d,
    CASE
        WHEN ABS(cohens_d_value) >= 0.8 THEN 'Large effect'
        WHEN ABS(cohens_d_value) >= 0.5 THEN 'Medium effect'
        WHEN ABS(cohens_d_value) >= 0.2 THEN 'Small effect'
        ELSE 'Negligible effect'
    END AS effect_size_interpretation
FROM cohens_d;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 A/Bæµ‹è¯•è®¾è®¡

```sql
-- A/Bæµ‹è¯•ï¼šè®¡ç®—æ‰€éœ€æ ·æœ¬é‡
WITH ab_test_design AS (
    SELECT
        'Conversion Rate' AS metric,
        0.05 AS baseline_rate,  -- 5% baseline conversion
        0.06 AS expected_rate,  -- 6% expected conversion (20% improvement)
        0.8 AS desired_power,
        0.05 AS alpha
)
SELECT
    metric,
    ROUND(baseline_rate::numeric, 4) AS baseline_rate,
    ROUND(expected_rate::numeric, 4) AS expected_rate,
    -- æ•ˆåº”é‡ï¼šç›¸å¯¹æå‡
    ROUND((expected_rate - baseline_rate) / baseline_rate::numeric, 2) AS relative_improvement,
    -- æ‰€éœ€æ ·æœ¬é‡ï¼ˆæ¯ç»„ï¼‰
    calculate_sample_size(
        (expected_rate - baseline_rate) / SQRT(baseline_rate * (1 - baseline_rate)),
        desired_power,
        alpha
    ) AS required_sample_size_per_group
FROM ab_test_design;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Cohen, J. (1988)**: "Statistical Power Analysis for the Behavioral Sciences", 2nd Edition
2. **Faul, F., et al. (2007)**: "G*Power 3: A flexible statistical power analysis program"
3. **Lenth, R.V. (2001)**: "Some Practical Guidelines for Effective Sample Size Determination"

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é¢„å…ˆè®¡ç®—**ï¼šé¢„å…ˆè®¡ç®—å¸¸ç”¨å‚æ•°ç»„åˆçš„åŠŸæ•ˆ
2. **ç¼“å­˜ç»“æœ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åŠŸæ•ˆåˆ†æç»“æœ
3. **å¹¶è¡Œè®¡ç®—**ï¼šå¹¶è¡Œè®¡ç®—å¤šä¸ªåœºæ™¯çš„åŠŸæ•ˆ

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•ˆåº”é‡ä¼°è®¡**ï¼šåŸºäºå…ˆéªŒçŸ¥è¯†æˆ–è¯•ç‚¹ç ”ç©¶ä¼°è®¡æ•ˆåº”é‡
2. **åŠŸæ•ˆç›®æ ‡**ï¼šé€šå¸¸è®¾ç½®åŠŸæ•ˆâ‰¥0.8
3. **æ ·æœ¬é‡è§„åˆ’**ï¼šåœ¨å®éªŒå‰è¿›è¡ŒåŠŸæ•ˆåˆ†æ
4. **äº‹ååˆ†æ**ï¼šå®éªŒåè®¡ç®—å®é™…åŠŸæ•ˆ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
