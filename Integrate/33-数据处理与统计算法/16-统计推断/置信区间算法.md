# PostgreSQL ç½®ä¿¡åŒºé—´ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç»Ÿè®¡æ¨æ–­ | ç½®ä¿¡åŒºé—´ | Bootstrap
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Statistical Inference (Casella & Berger), Bootstrap Methods

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç½®ä¿¡åŒºé—´ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-ç½®ä¿¡åŒºé—´ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç½®ä¿¡åŒºé—´æ¦‚è¿°](#ç½®ä¿¡åŒºé—´æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
    - [æ•°å­¦å®šä¹‰](#æ•°å­¦å®šä¹‰)
    - [ç½®ä¿¡æ°´å¹³](#ç½®ä¿¡æ°´å¹³)
  - [1. æ­£æ€åˆ†å¸ƒç½®ä¿¡åŒºé—´](#1-æ­£æ€åˆ†å¸ƒç½®ä¿¡åŒºé—´)
    - [1.1 å‡å€¼ç½®ä¿¡åŒºé—´](#11-å‡å€¼ç½®ä¿¡åŒºé—´)
    - [1.2 æ–¹å·®ç½®ä¿¡åŒºé—´](#12-æ–¹å·®ç½®ä¿¡åŒºé—´)
  - [2. tåˆ†å¸ƒç½®ä¿¡åŒºé—´](#2-tåˆ†å¸ƒç½®ä¿¡åŒºé—´)
    - [2.1 å°æ ·æœ¬å‡å€¼ç½®ä¿¡åŒºé—´](#21-å°æ ·æœ¬å‡å€¼ç½®ä¿¡åŒºé—´)
  - [3. Bootstrapæ–¹æ³•](#3-bootstrapæ–¹æ³•)
    - [3.1 BootstrapåŸç†](#31-bootstrapåŸç†)
    - [3.2 Bootstrapå®ç°](#32-bootstrapå®ç°)
  - [4. æ¯”ä¾‹ç½®ä¿¡åŒºé—´](#4-æ¯”ä¾‹ç½®ä¿¡åŒºé—´)
    - [4.1 äºŒé¡¹æ¯”ä¾‹ç½®ä¿¡åŒºé—´](#41-äºŒé¡¹æ¯”ä¾‹ç½®ä¿¡åŒºé—´)
  - [5. å¤æ‚åº¦åˆ†æ](#5-å¤æ‚åº¦åˆ†æ)
  - [6. PostgreSQL 18 å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—å¢å¼º](#6-postgresql-18-å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—å¢å¼º)
    - [6.1 å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—åŸç†](#61-å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—åŸç†)
    - [6.2 å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´](#62-å¹¶è¡Œbootstrapç½®ä¿¡åŒºé—´)
    - [6.3 å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´](#63-å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´)
    - [6.4 å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´](#64-å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 å‚æ•°ä¼°è®¡](#71-å‚æ•°ä¼°è®¡)
    - [7.2 é¢„æµ‹åŒºé—´](#72-é¢„æµ‹åŒºé—´)
    - [7.3 åŒ»å­¦ç ”ç©¶](#73-åŒ»å­¦ç ”ç©¶)
    - [7.4 è´¨é‡æ§åˆ¶](#74-è´¨é‡æ§åˆ¶)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [Bootstrapä¼˜åŒ–](#bootstrapä¼˜åŒ–)
    - [ç´¢å¼•ä¼˜åŒ–](#ç´¢å¼•ä¼˜åŒ–)
    - [é‡‡æ ·ç­–ç•¥](#é‡‡æ ·ç­–ç•¥)
    - [ç‰©åŒ–è§†å›¾ç¼“å­˜](#ç‰©åŒ–è§†å›¾ç¼“å­˜)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [åˆ†å¸ƒå‡è®¾æ£€æŸ¥](#åˆ†å¸ƒå‡è®¾æ£€æŸ¥)
    - [ç½®ä¿¡æ°´å¹³é€‰æ‹©](#ç½®ä¿¡æ°´å¹³é€‰æ‹©)
    - [Bootstrapæœ€ä½³å®è·µ](#bootstrapæœ€ä½³å®è·µ)
    - [SQLå®ç°æ³¨æ„äº‹é¡¹](#sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“ˆ ç½®ä¿¡åŒºé—´æ–¹æ³•å¯¹æ¯”](#-ç½®ä¿¡åŒºé—´æ–¹æ³•å¯¹æ¯”)
  - [ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1ï¼šç½®ä¿¡åŒºé—´è¿‡å®½](#é—®é¢˜1ç½®ä¿¡åŒºé—´è¿‡å®½)
    - [é—®é¢˜2ï¼šBootstrapè®¡ç®—æ…¢](#é—®é¢˜2bootstrapè®¡ç®—æ…¢)
    - [é—®é¢˜3ï¼šåˆ†å¸ƒå‡è®¾ä¸æ»¡è¶³](#é—®é¢˜3åˆ†å¸ƒå‡è®¾ä¸æ»¡è¶³)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## ç½®ä¿¡åŒºé—´æ¦‚è¿°

**ç½®ä¿¡åŒºé—´**æ˜¯å‚æ•°ä¼°è®¡çš„é‡è¦å·¥å…·ï¼Œæä¾›äº†ä¸€ä¸ªåŒ…å«çœŸå®å‚æ•°å€¼çš„åŒºé—´ï¼Œå¹¶ç»™å‡ºç½®ä¿¡æ°´å¹³ã€‚

### ç†è®ºåŸºç¡€

ç»™å®šæ ·æœ¬æ•°æ®ï¼Œç½®ä¿¡åŒºé—´ $[L, U]$ æ»¡è¶³ï¼š

$$P(L \leq \theta \leq U) = 1 - \alpha$$

å…¶ä¸­ï¼š

- $\theta$ æ˜¯å¾…ä¼°è®¡å‚æ•°
- $\alpha$ æ˜¯æ˜¾è‘—æ€§æ°´å¹³
- $1 - \alpha$ æ˜¯ç½®ä¿¡æ°´å¹³

### æ•°å­¦å®šä¹‰

**ç½®ä¿¡åŒºé—´çš„ä¸€èˆ¬å½¢å¼**:
$$\hat{\theta} \pm z_{\alpha/2} \times SE(\hat{\theta})$$

å…¶ä¸­ï¼š

- $\hat{\theta}$ æ˜¯å‚æ•°ä¼°è®¡å€¼
- $z_{\alpha/2}$ æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ä¸´ç•Œå€¼
- $SE(\hat{\theta})$ æ˜¯æ ‡å‡†è¯¯å·®

### ç½®ä¿¡æ°´å¹³

| ç½®ä¿¡æ°´å¹³ | æ˜¾è‘—æ€§æ°´å¹³ | $z_{\alpha/2}$ (æ­£æ€) | $t_{\alpha/2}$ (df=9) |
|---------|-----------|---------------------|---------------------|
| **90%** | 0.10 | 1.645 | 1.833 |
| **95%** | 0.05 | 1.960 | 2.262 |
| **99%** | 0.01 | 2.576 | 3.250 |

---

## 1. æ­£æ€åˆ†å¸ƒç½®ä¿¡åŒºé—´

### 1.1 å‡å€¼ç½®ä¿¡åŒºé—´

**æ€»ä½“æ–¹å·®å·²çŸ¥æ—¶**ï¼Œå‡å€¼çš„ç½®ä¿¡åŒºé—´ä¸ºï¼š

$$\bar{x} \pm z_{\alpha/2} \times \frac{\sigma}{\sqrt{n}}$$

**æ€»ä½“æ–¹å·®æœªçŸ¥æ—¶**ï¼Œä½¿ç”¨æ ·æœ¬æ ‡å‡†å·®ï¼š

$$\bar{x} \pm z_{\alpha/2} \times \frac{s}{\sqrt{n}}$$

```sql
-- å‡å€¼ç½®ä¿¡åŒºé—´è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'ci_sample_data') THEN
            RAISE WARNING 'è¡¨ ci_sample_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE ci_sample_data CASCADE;
        END IF;

        CREATE TABLE ci_sample_data (
            id SERIAL PRIMARY KEY,
            value NUMERIC NOT NULL
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO ci_sample_data (value) VALUES
            (10.2), (9.8), (10.5), (10.1), (9.9),
            (10.3), (10.0), (9.7), (10.4), (10.1);

        RAISE NOTICE 'è¡¨ ci_sample_data åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥10æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ ci_sample_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 95%ç½®ä¿¡åŒºé—´è®¡ç®—
WITH sample_stats AS (
    SELECT
        COUNT(*) AS n,
        AVG(value) AS sample_mean,
        STDDEV(value) AS sample_std,
        1.96 AS z_critical  -- 95%ç½®ä¿¡æ°´å¹³
    FROM ci_sample_data
),
confidence_interval AS (
    SELECT
        n,
        sample_mean,
        sample_std,
        sample_mean - z_critical * (sample_std / SQRT(n)) AS lower_bound,
        sample_mean + z_critical * (sample_std / SQRT(n)) AS upper_bound,
        z_critical * (sample_std / SQRT(n)) AS margin_of_error
    FROM sample_stats
)
SELECT
    n AS sample_size,
    ROUND(sample_mean::numeric, 4) AS sample_mean,
    ROUND(sample_std::numeric, 4) AS sample_std,
    ROUND(lower_bound::numeric, 4) AS ci_lower_95,
    ROUND(upper_bound::numeric, 4) AS ci_upper_95,
    ROUND(margin_of_error::numeric, 4) AS margin_of_error,
    '95%' AS confidence_level
FROM confidence_interval;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    AVG(value) AS sample_mean,
    STDDEV(value) AS sample_std,
    COUNT(*) AS n
FROM ci_sample_data;
```

### 1.2 æ–¹å·®ç½®ä¿¡åŒºé—´

**æ–¹å·®çš„ç½®ä¿¡åŒºé—´**ï¼ˆæ­£æ€åˆ†å¸ƒï¼‰ï¼š

$$\frac{(n-1)s^2}{\chi^2_{\alpha/2, n-1}} \leq \sigma^2 \leq \frac{(n-1)s^2}{\chi^2_{1-\alpha/2, n-1}}$$

```sql
-- æ–¹å·®ç½®ä¿¡åŒºé—´è®¡ç®—
WITH sample_stats AS (
    SELECT
        COUNT(*) AS n,
        VARIANCE(value) AS sample_var,
        STDDEV(value) AS sample_std
    FROM ci_sample_data
),
chi_square_values AS (
    SELECT
        -- å¡æ–¹åˆ†å¸ƒä¸´ç•Œå€¼ï¼ˆç®€åŒ–ï¼šä½¿ç”¨è¿‘ä¼¼å€¼ï¼‰
        2.700 AS chi_sq_lower,  -- Ï‡Â²_{0.975, 9}
        19.023 AS chi_sq_upper   -- Ï‡Â²_{0.025, 9}
    FROM generate_series(1, 1)
),
variance_ci AS (
    SELECT
        ss.n,
        ss.sample_var,
        (ss.n - 1) * ss.sample_var / NULLIF(csv.chi_sq_upper, 0) AS var_lower,
        (ss.n - 1) * ss.sample_var / NULLIF(csv.chi_sq_lower, 0) AS var_upper,
        SQRT((ss.n - 1) * ss.sample_var / NULLIF(csv.chi_sq_upper, 0)) AS std_lower,
        SQRT((ss.n - 1) * ss.sample_var / NULLIF(csv.chi_sq_lower, 0)) AS std_upper
    FROM sample_stats ss
    CROSS JOIN chi_square_values csv
)
SELECT
    n,
    ROUND(sample_var::numeric, 4) AS sample_variance,
    ROUND(var_lower::numeric, 4) AS variance_ci_lower,
    ROUND(var_upper::numeric, 4) AS variance_ci_upper,
    ROUND(std_lower::numeric, 4) AS std_ci_lower,
    ROUND(std_upper::numeric, 4) AS std_ci_upper
FROM variance_ci;
```

---

## 2. tåˆ†å¸ƒç½®ä¿¡åŒºé—´

### 2.1 å°æ ·æœ¬å‡å€¼ç½®ä¿¡åŒºé—´

**å°æ ·æœ¬ï¼ˆn < 30ï¼‰æ—¶**ï¼Œä½¿ç”¨tåˆ†å¸ƒï¼š

$$\bar{x} \pm t_{\alpha/2, n-1} \times \frac{s}{\sqrt{n}}$$

```sql
-- tåˆ†å¸ƒç½®ä¿¡åŒºé—´è®¡ç®—
WITH sample_stats AS (
    SELECT
        COUNT(*) AS n,
        AVG(value) AS sample_mean,
        STDDEV(value) AS sample_std,
        2.262 AS t_critical  -- t_{0.025, 9} for 95% CI
    FROM ci_sample_data
),
t_confidence_interval AS (
    SELECT
        n,
        sample_mean,
        sample_std,
        sample_mean - t_critical * (sample_std / SQRT(n)) AS lower_bound,
        sample_mean + t_critical * (sample_std / SQRT(n)) AS upper_bound
    FROM sample_stats
)
SELECT
    n AS sample_size,
    ROUND(sample_mean::numeric, 4) AS sample_mean,
    ROUND(lower_bound::numeric, 4) AS ci_lower_95_t,
    ROUND(upper_bound::numeric, 4) AS ci_upper_95_t,
    't-distribution' AS distribution_type
FROM t_confidence_interval;
```

---

## 3. Bootstrapæ–¹æ³•

### 3.1 BootstrapåŸç†

**Bootstrapæ–¹æ³•**æ˜¯ä¸€ç§éå‚æ•°ç»Ÿè®¡æ–¹æ³•ï¼Œé€šè¿‡é‡é‡‡æ ·ä¼°è®¡å‚æ•°çš„ç½®ä¿¡åŒºé—´ã€‚

**ç®—æ³•æ­¥éª¤**:

1. ä»åŸå§‹æ ·æœ¬ä¸­æœ‰æ”¾å›æŠ½æ ·ï¼Œå¾—åˆ°Bootstrapæ ·æœ¬
2. è®¡ç®—Bootstrapç»Ÿè®¡é‡
3. é‡å¤æ­¥éª¤1-2å¤šæ¬¡ï¼ˆé€šå¸¸1000-10000æ¬¡ï¼‰
4. ä½¿ç”¨Bootstrapç»Ÿè®¡é‡çš„åˆ†ä½æ•°æ„å»ºç½®ä¿¡åŒºé—´

### 3.2 Bootstrapå®ç°

```sql
-- Bootstrapç½®ä¿¡åŒºé—´å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'ci_sample_data') THEN
            RAISE WARNING 'è¡¨ ci_sample_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒBootstrap';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒBootstrapç½®ä¿¡åŒºé—´è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Bootstrapè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- Bootstrapé‡é‡‡æ ·ï¼ˆç®€åŒ–ç‰ˆï¼šå±•ç¤ºåŸç†ï¼‰
WITH bootstrap_samples AS (
    SELECT
        bootstrap_id,
        AVG(value) AS bootstrap_mean
    FROM (
        SELECT
            generate_series(1, 1000) AS bootstrap_id,
            (SELECT value FROM ci_sample_data ORDER BY RANDOM() LIMIT 1) AS value
        FROM generate_series(1, 10)  -- æ¯ä¸ªBootstrapæ ·æœ¬10ä¸ªè§‚æµ‹
    ) bootstrap_data
    GROUP BY bootstrap_id
),
bootstrap_percentiles AS (
    SELECT
        PERCENTILE_CONT(0.025) WITHIN GROUP (ORDER BY bootstrap_mean) AS ci_lower,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY bootstrap_mean) AS median,
        PERCENTILE_CONT(0.975) WITHIN GROUP (ORDER BY bootstrap_mean) AS ci_upper
    FROM bootstrap_samples
)
SELECT
    ROUND(ci_lower::numeric, 4) AS bootstrap_ci_lower_95,
    ROUND(median::numeric, 4) AS bootstrap_median,
    ROUND(ci_upper::numeric, 4) AS bootstrap_ci_upper_95
FROM bootstrap_percentiles;
```

---

## 4. æ¯”ä¾‹ç½®ä¿¡åŒºé—´

### 4.1 äºŒé¡¹æ¯”ä¾‹ç½®ä¿¡åŒºé—´

**äºŒé¡¹æ¯”ä¾‹çš„ç½®ä¿¡åŒºé—´**ï¼ˆæ­£æ€è¿‘ä¼¼ï¼‰ï¼š

$$\hat{p} \pm z_{\alpha/2} \times \sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$$

```sql
-- æ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—
WITH proportion_data AS (
    SELECT
        COUNT(*) FILTER (WHERE success = 1) AS successes,
        COUNT(*) AS total,
        COUNT(*) FILTER (WHERE success = 1)::NUMERIC / COUNT(*) AS sample_proportion
    FROM binary_data
),
proportion_ci AS (
    SELECT
        successes,
        total,
        sample_proportion,
        sample_proportion - 1.96 * SQRT(sample_proportion * (1 - sample_proportion) / total) AS ci_lower,
        sample_proportion + 1.96 * SQRT(sample_proportion * (1 - sample_proportion) / total) AS ci_upper
    FROM proportion_data
)
SELECT
    successes,
    total,
    ROUND(sample_proportion::numeric, 4) AS sample_proportion,
    ROUND(ci_lower::numeric, 4) AS proportion_ci_lower_95,
    ROUND(ci_upper::numeric, 4) AS proportion_ci_upper_95
FROM proportion_ci;
```

---

## 5. å¤æ‚åº¦åˆ†æ

| æ–¹æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|-----------|-----------|---------|
| **æ­£æ€åˆ†å¸ƒCI** | $O(n)$ | $O(1)$ | å¤§æ ·æœ¬ï¼Œæ­£æ€åˆ†å¸ƒ |
| **tåˆ†å¸ƒCI** | $O(n)$ | $O(1)$ | å°æ ·æœ¬ï¼Œæ­£æ€åˆ†å¸ƒ |
| **Bootstrap** | $O(Bn)$ | $O(B)$ | éå‚æ•°ï¼Œä»»æ„åˆ†å¸ƒ |

å…¶ä¸­ $B$ æ˜¯Bootstrapé‡é‡‡æ ·æ¬¡æ•°ã€‚

---

## 6. PostgreSQL 18 å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡ŒBootstrapæ–¹æ³•ã€å‡å€¼ç½®ä¿¡åŒºé—´å’Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡ç»Ÿè®¡æ¨æ–­è®¡ç®—çš„æ€§èƒ½ã€‚

### 6.1 å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—åŸç†

PostgreSQL 18 çš„å¹¶è¡Œç½®ä¿¡åŒºé—´è®¡ç®—é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œé‡‡æ ·**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰§è¡ŒBootstrapé‡‡æ ·
2. **å¹¶è¡Œè®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—ç»Ÿè®¡é‡
3. **å¹¶è¡Œåˆ†ä½æ•°**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—åˆ†ä½æ•°
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„è®¡ç®—ç»“æœ

### 6.2 å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´

```sql
-- PostgreSQL 18 å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sample_data') THEN
            RAISE WARNING 'è¡¨ sample_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒBootstrapç½®ä¿¡åŒºé—´ï¼šå¹¶è¡Œæ‰§è¡ŒBootstrapé‡‡æ ·
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH bootstrap_samples AS (
    SELECT
        bootstrap_iteration,
        AVG(value) AS bootstrap_mean
    FROM (
        SELECT
            generate_series(1, 1000) AS bootstrap_iteration,
            (SELECT value FROM sample_data ORDER BY RANDOM() LIMIT 1) AS value
        FROM generate_series(1, (SELECT COUNT(*) FROM sample_data))
    ) bootstrap_data
    GROUP BY bootstrap_iteration
),
bootstrap_stats AS (
    SELECT
        PERCENTILE_CONT(0.025) WITHIN GROUP (ORDER BY bootstrap_mean) AS ci_lower,
        PERCENTILE_CONT(0.975) WITHIN GROUP (ORDER BY bootstrap_mean) AS ci_upper,
        AVG(bootstrap_mean) AS bootstrap_mean_estimate
    FROM bootstrap_samples
)
SELECT
    ROUND(bootstrap_mean_estimate::numeric, 4) AS mean_estimate,
    ROUND(ci_lower::numeric, 4) AS ci_lower_95,
    ROUND(ci_upper::numeric, 4) AS ci_upper_95
FROM bootstrap_stats;
```

### 6.3 å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´

```sql
-- PostgreSQL 18 å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sample_data') THEN
            RAISE WARNING 'è¡¨ sample_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå‡å€¼ç½®ä¿¡åŒºé—´ï¼š95%ç½®ä¿¡åŒºé—´
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH sample_stats AS (
    SELECT
        AVG(value) AS sample_mean,
        STDDEV(value) AS sample_stddev,
        COUNT(*) AS sample_size
    FROM sample_data
)
SELECT
    ROUND(sample_mean::numeric, 4) AS mean_estimate,
    ROUND(sample_stddev::numeric, 4) AS stddev_estimate,
    sample_size,
    ROUND((sample_mean - 1.96 * sample_stddev / SQRT(sample_size))::numeric, 4) AS ci_lower_95,
    ROUND((sample_mean + 1.96 * sample_stddev / SQRT(sample_size))::numeric, 4) AS ci_upper_95
FROM sample_stats;
```

### 6.4 å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´

```sql
-- PostgreSQL 18 å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'binary_data') THEN
            RAISE WARNING 'è¡¨ binary_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ¯”ä¾‹ç½®ä¿¡åŒºé—´ï¼šäºŒé¡¹æ¯”ä¾‹95%ç½®ä¿¡åŒºé—´
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH proportion_stats AS (
    SELECT
        COUNT(*) FILTER (WHERE outcome = 1)::numeric / COUNT(*) AS sample_proportion,
        COUNT(*) AS sample_size
    FROM binary_data
)
SELECT
    ROUND(sample_proportion::numeric, 4) AS proportion_estimate,
    sample_size,
    ROUND((sample_proportion - 1.96 * SQRT(sample_proportion * (1 - sample_proportion) / sample_size))::numeric, 4) AS ci_lower_95,
    ROUND((sample_proportion + 1.96 * SQRT(sample_proportion * (1 - sample_proportion) / sample_size))::numeric, 4) AS ci_upper_95
FROM proportion_stats;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 å‚æ•°ä¼°è®¡

```sql
-- å‚æ•°ä¼°è®¡åº”ç”¨ç¤ºä¾‹
WITH parameter_estimation AS (
    SELECT
        parameter_name,
        point_estimate,
        ci_lower,
        ci_upper,
        (ci_upper - ci_lower) / 2.0 AS margin_of_error
    FROM estimated_parameters
)
SELECT
    parameter_name,
    ROUND(point_estimate::numeric, 4) AS estimate,
    ROUND(ci_lower::numeric, 4) AS ci_lower_95,
    ROUND(ci_upper::numeric, 4) AS ci_upper_95,
    ROUND(margin_of_error::numeric, 4) AS margin_of_error
FROM parameter_estimation;
```

### 7.2 é¢„æµ‹åŒºé—´

```sql
-- é¢„æµ‹åŒºé—´è®¡ç®—ï¼ˆå›å½’é¢„æµ‹ï¼‰
WITH regression_prediction AS (
    SELECT
        x_value,
        predicted_y,
        prediction_std_error
    FROM regression_results
),
prediction_interval AS (
    SELECT
        x_value,
        predicted_y,
        predicted_y - 1.96 * prediction_std_error AS pred_lower,
        predicted_y + 1.96 * prediction_std_error AS pred_upper
    FROM regression_prediction
)
SELECT
    x_value,
    ROUND(predicted_y::numeric, 4) AS predicted_value,
    ROUND(pred_lower::numeric, 4) AS prediction_interval_lower,
    ROUND(pred_upper::numeric, 4) AS prediction_interval_upper
FROM prediction_interval;
```

---

### 7.3 åŒ»å­¦ç ”ç©¶

```sql
-- åŒ»å­¦ç ”ç©¶ç½®ä¿¡åŒºé—´åº”ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'medical_trial') THEN
            CREATE TABLE medical_trial (
                patient_id SERIAL PRIMARY KEY,
                treatment_group VARCHAR(20) NOT NULL,
                outcome_value NUMERIC NOT NULL
            );

            -- æ’å…¥ä¸´åºŠè¯•éªŒæ•°æ®
            INSERT INTO medical_trial (treatment_group, outcome_value) VALUES
                ('Treatment', 85), ('Treatment', 88), ('Treatment', 82),
                ('Control', 75), ('Control', 78), ('Control', 73);

            RAISE NOTICE 'åŒ»å­¦è¯•éªŒæ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŒ»å­¦ç ”ç©¶åº”ç”¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ²»ç–—æ•ˆæœç½®ä¿¡åŒºé—´
WITH treatment_effect AS (
    SELECT
        treatment_group,
        AVG(outcome_value) AS mean_outcome,
        STDDEV(outcome_value) AS std_outcome,
        COUNT(*) AS n
    FROM medical_trial
    GROUP BY treatment_group
),
effect_size AS (
    SELECT
        t.mean_outcome - c.mean_outcome AS mean_difference,
        SQRT((POWER(t.std_outcome, 2) / t.n) + (POWER(c.std_outcome, 2) / c.n)) AS se_difference
    FROM treatment_effect t
    CROSS JOIN treatment_effect c
    WHERE t.treatment_group = 'Treatment' AND c.treatment_group = 'Control'
)
SELECT
    ROUND(mean_difference::numeric, 4) AS treatment_effect,
    ROUND((mean_difference - 1.96 * se_difference)::numeric, 4) AS ci_lower_95,
    ROUND((mean_difference + 1.96 * se_difference)::numeric, 4) AS ci_upper_95
FROM effect_size;
```

### 7.4 è´¨é‡æ§åˆ¶

```sql
-- è´¨é‡æ§åˆ¶ç½®ä¿¡åŒºé—´åº”ç”¨
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'quality_control') THEN
            CREATE TABLE quality_control (
                batch_id INTEGER NOT NULL,
                measurement NUMERIC NOT NULL,
                PRIMARY KEY (batch_id)
            );

            -- æ’å…¥è´¨é‡æ§åˆ¶æ•°æ®
            INSERT INTO quality_control (batch_id, measurement) VALUES
                (1, 10.1), (2, 10.2), (3, 9.9), (4, 10.0), (5, 10.1);

            RAISE NOTICE 'è´¨é‡æ§åˆ¶æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è´¨é‡æ§åˆ¶åº”ç”¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è´¨é‡æ§åˆ¶é™è®¡ç®—
WITH qc_stats AS (
    SELECT
        AVG(measurement) AS mean_value,
        STDDEV(measurement) AS std_value,
        COUNT(*) AS n
    FROM quality_control
),
control_limits AS (
    SELECT
        mean_value,
        mean_value - 3 * std_value AS lcl,  -- ä¸‹æ§åˆ¶é™
        mean_value + 3 * std_value AS ucl   -- ä¸Šæ§åˆ¶é™
    FROM qc_stats
)
SELECT
    ROUND(mean_value::numeric, 4) AS center_line,
    ROUND(lcl::numeric, 4) AS lower_control_limit,
    ROUND(ucl::numeric, 4) AS upper_control_limit
FROM control_limits;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### Bootstrapä¼˜åŒ–

```sql
-- Bootstrapå¹¶è¡Œè®¡ç®—
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 100;
SET parallel_tuple_cost = 0.01;

-- å¹¶è¡ŒBootstrapé‡é‡‡æ ·
WITH bootstrap_iterations AS (
    SELECT
        iteration,
        TABLESAMPLE SYSTEM(100) AS bootstrap_sample
    FROM original_data
    CROSS JOIN generate_series(1, 1000) AS iteration
)
SELECT
    iteration,
    AVG(bootstrap_sample) AS bootstrap_mean
FROM bootstrap_iterations
GROUP BY iteration;
```

### ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºå…³é”®ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_sample_data ON ci_sample_data(value);
CREATE INDEX IF NOT EXISTS idx_time_series ON time_series_data(time_point);
```

### é‡‡æ ·ç­–ç•¥

```sql
-- å¤§æ•°æ®é›†é‡‡æ ·
SELECT *
FROM large_dataset TABLESAMPLE SYSTEM(10)  -- 10%é‡‡æ ·
LIMIT 10000;
```

### ç‰©åŒ–è§†å›¾ç¼“å­˜

```sql
-- ç¼“å­˜ç»Ÿè®¡ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS ci_statistics_cache AS
SELECT
    AVG(value) AS mean_value,
    STDDEV(value) AS std_value,
    COUNT(*) AS n
FROM ci_sample_data;

REFRESH MATERIALIZED VIEW CONCURRENTLY ci_statistics_cache;
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### åˆ†å¸ƒå‡è®¾æ£€æŸ¥

1. **æ­£æ€æ€§æ£€éªŒ**: æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆæ­£æ€åˆ†å¸ƒ

   ```sql
   -- Shapiro-Wilkæ£€éªŒï¼ˆç®€åŒ–ï¼‰
   WITH normality_check AS (
       SELECT
           AVG(value) AS mean_val,
           STDDEV(value) AS std_val,
           COUNT(*) AS n
       FROM ci_sample_data
   )
   SELECT
       CASE
           WHEN n >= 30 THEN 'Large sample, CLT applies'
           ELSE 'Small sample, check normality'
       END AS normality_status
   FROM normality_check;
   ```

2. **æ ·æœ¬é‡è¦æ±‚**: ç¡®ä¿è¶³å¤Ÿçš„æ ·æœ¬é‡
   - æ­£æ€åˆ†å¸ƒï¼šn â‰¥ 30ï¼ˆCLTï¼‰
   - tåˆ†å¸ƒï¼šn < 30
   - Bootstrapï¼šn â‰¥ 50

### ç½®ä¿¡æ°´å¹³é€‰æ‹©

1. **å¸¸ç”¨ç½®ä¿¡æ°´å¹³**:
   - 90%ï¼šè¾ƒå®½åŒºé—´ï¼Œè¾ƒä½ç½®ä¿¡åº¦
   - 95%ï¼šæ ‡å‡†é€‰æ‹©ï¼Œå¹³è¡¡ç²¾åº¦å’Œç½®ä¿¡åº¦
   - 99%ï¼šè¾ƒçª„åŒºé—´ï¼Œè¾ƒé«˜ç½®ä¿¡åº¦

2. **åº”ç”¨åœºæ™¯**:
   - åŒ»å­¦ç ”ç©¶ï¼šé€šå¸¸ä½¿ç”¨95%æˆ–99%
   - è´¨é‡æ§åˆ¶ï¼šé€šå¸¸ä½¿ç”¨95%
   - æ¢ç´¢æ€§åˆ†æï¼šå¯ä»¥ä½¿ç”¨90%

### Bootstrapæœ€ä½³å®è·µ

1. **é‡é‡‡æ ·æ¬¡æ•°**: é€šå¸¸1000-10000æ¬¡
   - ç®€å•ç»Ÿè®¡é‡ï¼š1000æ¬¡è¶³å¤Ÿ
   - å¤æ‚ç»Ÿè®¡é‡ï¼šéœ€è¦æ›´å¤šæ¬¡æ•°

2. **Bootstrapç±»å‹**:
   - æ ‡å‡†Bootstrapï¼šç‹¬ç«‹åŒåˆ†å¸ƒ
   - åˆ†å±‚Bootstrapï¼šåˆ†å±‚æ•°æ®
   - æ—¶é—´åºåˆ—Bootstrapï¼šç›¸å…³æ•°æ®

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ä½¿ç”¨DOå—å’ŒEXCEPTIONè¿›è¡Œé”™è¯¯å¤„ç†
2. **æ•°å€¼ç²¾åº¦**: æ³¨æ„æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨é‡‡æ ·å’Œç´¢å¼•ä¼˜åŒ–æ€§èƒ½
4. **ç»“æœè§£é‡Š**: æ­£ç¡®è§£é‡Šç½®ä¿¡åŒºé—´çš„å«ä¹‰

---

## ğŸ“ˆ ç½®ä¿¡åŒºé—´æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **æ­£æ€åˆ†å¸ƒCI** | å¤§æ ·æœ¬ï¼Œæ­£æ€åˆ†å¸ƒ | ç®€å•å¿«é€Ÿ | éœ€è¦æ­£æ€å‡è®¾ |
| **tåˆ†å¸ƒCI** | å°æ ·æœ¬ï¼Œæ­£æ€åˆ†å¸ƒ | è€ƒè™‘æ ·æœ¬é‡ | éœ€è¦æ­£æ€å‡è®¾ |
| **Bootstrap CI** | ä»»æ„åˆ†å¸ƒ | æ— éœ€åˆ†å¸ƒå‡è®¾ | è®¡ç®—é‡å¤§ |
| **WilsonåŒºé—´** | æ¯”ä¾‹ä¼°è®¡ | å°æ ·æœ¬æ•ˆæœå¥½ | ä»…é€‚ç”¨äºæ¯”ä¾‹ |

---

## ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šç½®ä¿¡åŒºé—´è¿‡å®½

**åŸå› **ï¼š

- æ ·æœ¬é‡å°
- æ–¹å·®å¤§
- ç½®ä¿¡æ°´å¹³é«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š

- å¢åŠ æ ·æœ¬é‡
- é™ä½ç½®ä¿¡æ°´å¹³
- ä½¿ç”¨åˆ†å±‚æŠ½æ ·

### é—®é¢˜2ï¼šBootstrapè®¡ç®—æ…¢

**åŸå› **ï¼š

- é‡é‡‡æ ·æ¬¡æ•°å¤š
- æ•°æ®é‡å¤§
- æœªä½¿ç”¨å¹¶è¡Œè®¡ç®—

**è§£å†³æ–¹æ¡ˆ**ï¼š

- å‡å°‘é‡é‡‡æ ·æ¬¡æ•°
- ä½¿ç”¨é‡‡æ ·å‡å°‘æ•°æ®é‡
- å¯ç”¨å¹¶è¡Œè®¡ç®—

### é—®é¢˜3ï¼šåˆ†å¸ƒå‡è®¾ä¸æ»¡è¶³

**åŸå› **ï¼š

- æ•°æ®éæ­£æ€
- æ ·æœ¬é‡å°
- å­˜åœ¨å¼‚å¸¸å€¼

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨Bootstrapæ–¹æ³•
- æ•°æ®å˜æ¢ï¼ˆå¯¹æ•°å˜æ¢ç­‰ï¼‰
- å»é™¤å¼‚å¸¸å€¼

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Casella, G., Berger, R.L. (2002)**: "Statistical Inference", 2nd Edition, Duxbury Press
2. **Efron, B., Tibshirani, R.J. (1994)**: "An Introduction to the Bootstrap", Chapman & Hall/CRC
3. **Davison, A.C., Hinkley, D.V. (1997)**: "Bootstrap Methods and Their Application", Cambridge University Press
4. **Wasserman, L. (2004)**: "All of Statistics: A Concise Course in Statistical Inference", Springer

---

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **åˆ†å¸ƒå‡è®¾**: æ£€æŸ¥æ•°æ®æ˜¯å¦æ»¡è¶³åˆ†å¸ƒå‡è®¾ï¼ˆæ­£æ€æ€§ã€ç‹¬ç«‹æ€§ï¼‰
2. **Bootstrapè®¡ç®—**: Bootstrapéœ€è¦å¤§é‡é‡å¤é‡‡æ ·ï¼Œæ³¨æ„è®¡ç®—æ—¶é—´
3. **æ•°å€¼ç²¾åº¦**: ä½¿ç”¨NUMERICç±»å‹ä¿æŒè®¡ç®—ç²¾åº¦
4. **ç½®ä¿¡æ°´å¹³**: é€‰æ‹©åˆé€‚çš„ç½®ä¿¡æ°´å¹³ï¼ˆé€šå¸¸95%ï¼‰

### PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç½®ä¿¡åŒºé—´ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«æ ·æœ¬IDçš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Nç½®ä¿¡åŒºé—´æŸ¥è¯¢å’Œå¤šæ ·æœ¬å¯¹æ¯”æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡ç½®ä¿¡åŒºé—´è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡Bootstrapç½®ä¿¡åŒºé—´å’Œå¹¶è¡Œå‚æ•°ä¼°è®¡

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - ç½®ä¿¡åŒºé—´è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨6èŠ‚è¯¦ç»†è¯´æ˜ï¼‰
   - é€‚ç”¨äºå¤§è§„æ¨¡Bootstrapå’Œå¤šå‚æ•°å¹¶è¡Œç½®ä¿¡åŒºé—´åˆ†æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–ç½®ä¿¡åŒºé—´æŸ¥è¯¢**

```sql
-- ä¸ºç½®ä¿¡åŒºé—´æ•°æ®åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_confidence_interval_skip_scan
ON ci_sample_data(id DESC, value DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æœ€æ–°æ ·æœ¬çš„ç½®ä¿¡åŒºé—´
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (DATE_TRUNC('day', CURRENT_TIMESTAMP))
    id,
    value,
    AVG(value) OVER () AS sample_mean,
    STDDEV(value) OVER () AS sample_stddev
FROM ci_sample_data
ORDER BY id DESC
LIMIT 50;
```

### é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç½®ä¿¡åŒºé—´ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„ç½®ä¿¡åŒºé—´ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜ç½®ä¿¡åŒºé—´ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS confidence_interval_cache AS
WITH bootstrap_samples AS (
    SELECT
        sample_id,
        value,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—Bootstrapå‡å€¼ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        AVG(value) OVER (
            PARTITION BY sample_id
            ORDER BY RANDOM()
            ROWS BETWEEN CURRENT ROW AND 99 FOLLOWING
        ) AS bootstrap_mean
    FROM (
        SELECT
            generate_series(1, 1000) AS sample_id,
            value
        FROM ci_sample_data
        TABLESAMPLE SYSTEM(10)  -- 10%é‡‡æ ·
    ) AS sampled_data
),
confidence_intervals AS (
    SELECT
        PERCENTILE_CONT(0.025) WITHIN GROUP (ORDER BY bootstrap_mean) AS lower_bound,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY bootstrap_mean) AS median,
        PERCENTILE_CONT(0.975) WITHIN GROUP (ORDER BY bootstrap_mean) AS upper_bound,
        AVG(bootstrap_mean) AS bootstrap_mean,
        STDDEV(bootstrap_mean) AS bootstrap_stddev
    FROM bootstrap_samples
)
SELECT
    ROUND(lower_bound::numeric, 4) AS lower_bound,
    ROUND(median::numeric, 4) AS median,
    ROUND(upper_bound::numeric, 4) AS upper_bound,
    ROUND(bootstrap_mean::numeric, 4) AS bootstrap_mean,
    ROUND(bootstrap_stddev::numeric, 4) AS bootstrap_stddev,
    ROUND((upper_bound - lower_bound)::numeric, 4) AS interval_width,
    CASE
        WHEN (upper_bound - lower_bound) < AVG(value) OVER () * 0.1 THEN 'Narrow - Precise Estimate'
        WHEN (upper_bound - lower_bound) < AVG(value) OVER () * 0.2 THEN 'Moderate - Reasonable Estimate'
        ELSE 'Wide - Less Precise Estimate'
    END AS interval_quality
FROM confidence_intervals
CROSS JOIN (SELECT AVG(value) FROM ci_sample_data) AS overall_mean;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_confidence_interval_cache_quality ON confidence_interval_cache(interval_quality, interval_width);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY confidence_interval_cache;
```

**2. å®æ—¶ç½®ä¿¡åŒºé—´è®¡ç®—ï¼šå¢é‡Bootstrapæ›´æ–°**

**å®æ—¶ç½®ä¿¡åŒºé—´è®¡ç®—**ï¼šå¯¹äºå®æ—¶æ•°æ®ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•æ›´æ–°Bootstrapç»“æœã€‚

```sql
-- å®æ—¶ç½®ä¿¡åŒºé—´è®¡ç®—ï¼šå¢é‡Bootstrapæ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'confidence_interval_state') THEN
            CREATE TABLE confidence_interval_state (
                parameter_name VARCHAR(100) NOT NULL,
                confidence_level NUMERIC NOT NULL,
                bootstrap_replications BIGINT DEFAULT 0,
                sum_bootstrap_values NUMERIC DEFAULT 0,
                sum_squared_bootstrap_values NUMERIC DEFAULT 0,
                lower_bound NUMERIC,
                upper_bound NUMERIC,
                interval_width NUMERIC,
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                PRIMARY KEY (parameter_name, confidence_level)
            );

            CREATE INDEX idx_confidence_interval_state_parameter ON confidence_interval_state(parameter_name, last_updated DESC);
            CREATE INDEX idx_confidence_interval_state_updated ON confidence_interval_state(last_updated DESC);

            RAISE NOTICE 'ç½®ä¿¡åŒºé—´çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡ç½®ä¿¡åŒºé—´è®¡ç®—æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡ç½®ä¿¡åŒºé—´è®¡ç®—æ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**3. æ™ºèƒ½ç½®ä¿¡åŒºé—´ä¼˜åŒ–ï¼šè‡ªé€‚åº”Bootstrapç­–ç•¥é€‰æ‹©**

**æ™ºèƒ½ç½®ä¿¡åŒºé—´ä¼˜åŒ–**ï¼šæ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜Bootstrapç­–ç•¥ã€‚

```sql
-- æ™ºèƒ½ç½®ä¿¡åŒºé—´ä¼˜åŒ–ï¼šè‡ªé€‚åº”Bootstrapç­–ç•¥é€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    sample_size BIGINT;
    data_variance NUMERIC;
    recommended_replications INTEGER;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'ci_sample_data') THEN
            RAISE WARNING 'è¡¨ ci_sample_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½ç½®ä¿¡åŒºé—´ä¼˜åŒ–';
            RETURN;
        END IF;

        -- è®¡ç®—æ•°æ®ç‰¹å¾
        SELECT
            COUNT(*),
            POWER(STDDEV(value), 2) / NULLIF(AVG(value), 0)
        INTO sample_size, data_variance
        FROM ci_sample_data;

        -- æ ¹æ®æ•°æ®ç‰¹å¾è‡ªé€‚åº”é€‰æ‹©Bootstrapé‡å¤æ¬¡æ•°
        IF sample_size < 50 AND data_variance < 0.5 THEN
            recommended_replications := 1000;  -- å°æ ·æœ¬ä½æ–¹å·®ï¼š1000æ¬¡
        ELSIF sample_size < 100 THEN
            recommended_replications := 5000;  -- ä¸­ç­‰æ ·æœ¬ï¼š5000æ¬¡
        ELSE
            recommended_replications := 10000;  -- å¤§æ ·æœ¬ï¼š10000æ¬¡
        END IF;

        RAISE NOTICE 'æ ·æœ¬å¤§å°: %, æ•°æ®æ–¹å·®: %, æ¨èBootstrapé‡å¤æ¬¡æ•°: %',
            sample_size, data_variance, recommended_replications;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½ç½®ä¿¡åŒºé—´ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆåŒ…å«å®Œæ•´ç†è®ºæ¨å¯¼ã€å®ç°å’ŒPostgreSQL 18æ–°ç‰¹æ€§æ”¯æŒï¼‰
