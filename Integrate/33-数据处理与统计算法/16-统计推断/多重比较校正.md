# PostgreSQL å¤šé‡æ¯”è¾ƒæ ¡æ­£ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç»Ÿè®¡æ¨æ–­ | å¤šé‡æ¯”è¾ƒ | é”™è¯¯æ§åˆ¶
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Multiple Comparisons, Family-Wise Error Rate, Statistical Inference

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å¤šé‡æ¯”è¾ƒæ ¡æ­£ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å¤šé‡æ¯”è¾ƒæ ¡æ­£ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å¤šé‡æ¯”è¾ƒæ¦‚è¿°](#å¤šé‡æ¯”è¾ƒæ¦‚è¿°)
  - [1. Bonferroniæ ¡æ­£](#1-bonferroniæ ¡æ­£)
  - [2. FDRæ§åˆ¶](#2-fdræ§åˆ¶)
  - [3. Holmæ–¹æ³•](#3-holmæ–¹æ³•)

---

## å¤šé‡æ¯”è¾ƒæ¦‚è¿°

**å¤šé‡æ¯”è¾ƒé—®é¢˜**ï¼šè¿›è¡Œå¤šä¸ªå‡è®¾æ£€éªŒæ—¶ï¼Œç¬¬ä¸€ç±»é”™è¯¯ç‡ä¼šç´¯ç§¯å¢åŠ ã€‚

---

## 1. Bonferroniæ ¡æ­£

**Bonferroniæ ¡æ­£**ï¼šå°†æ˜¾è‘—æ€§æ°´å¹³é™¤ä»¥æ£€éªŒæ¬¡æ•°ã€‚

$$\alpha_{adjusted} = \frac{\alpha}{m}$$

å…¶ä¸­ $m$ æ˜¯æ£€éªŒæ¬¡æ•°ã€‚

```sql
-- Bonferroniæ ¡æ­£å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'multiple_tests') THEN
            RAISE WARNING 'è¡¨ multiple_tests å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE multiple_tests CASCADE;
        END IF;

        CREATE TABLE multiple_tests (
            test_id SERIAL PRIMARY KEY,
            p_value NUMERIC NOT NULL,
            test_name VARCHAR(100) NOT NULL
        );

        INSERT INTO multiple_tests (p_value, test_name) VALUES
            (0.01, 'Test1'), (0.02, 'Test2'), (0.03, 'Test3'),
            (0.04, 'Test4'), (0.05, 'Test5');

        RAISE NOTICE 'è¡¨ multiple_tests åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- Bonferroniæ ¡æ­£
WITH test_count AS (
    SELECT COUNT(*) AS m FROM multiple_tests
),
bonferroni_correction AS (
    SELECT
        test_id,
        test_name,
        p_value,
        0.05 / (SELECT m FROM test_count) AS adjusted_alpha,
        CASE
            WHEN p_value < (0.05 / (SELECT m FROM test_count)) THEN 'Significant'
            ELSE 'Not significant'
        END AS bonferroni_result
    FROM multiple_tests
    CROSS JOIN test_count
)
SELECT
    test_id,
    test_name,
    ROUND(p_value::numeric, 4) AS p_value,
    ROUND(adjusted_alpha::numeric, 4) AS adjusted_alpha,
    bonferroni_result
FROM bonferroni_correction
ORDER BY p_value;
```

---

## 2. FDRæ§åˆ¶

**FDRï¼ˆFalse Discovery Rateï¼‰æ§åˆ¶**ä½¿ç”¨Benjamini-Hochbergæ–¹æ³•ã€‚

```sql
-- FDRæ§åˆ¶ï¼ˆBenjamini-Hochbergï¼‰
WITH ranked_tests AS (
    SELECT
        test_id,
        test_name,
        p_value,
        ROW_NUMBER() OVER (ORDER BY p_value) AS rank,
        COUNT(*) OVER () AS total_tests
    FROM multiple_tests
),
fdr_thresholds AS (
    SELECT
        test_id,
        test_name,
        p_value,
        rank,
        (rank::NUMERIC / total_tests) * 0.05 AS fdr_threshold
    FROM ranked_tests
)
SELECT
    test_id,
    test_name,
    ROUND(p_value::numeric, 4) AS p_value,
    ROUND(fdr_threshold::numeric, 4) AS fdr_threshold,
    CASE
        WHEN p_value <= fdr_threshold THEN 'Significant'
        ELSE 'Not significant'
    END AS fdr_result
FROM fdr_thresholds
ORDER BY p_value;
```

---

## 3. Holmæ–¹æ³•

**Holmæ–¹æ³•**æ˜¯Bonferroniçš„æ”¹è¿›ï¼Œæ›´powerfulã€‚

```sql
-- Holmæ–¹æ³•
WITH ranked_tests AS (
    SELECT
        test_id,
        p_value,
        ROW_NUMBER() OVER (ORDER BY p_value) AS rank,
        COUNT(*) OVER () AS total_tests
    FROM multiple_tests
),
holm_adjustment AS (
    SELECT
        test_id,
        p_value,
        rank,
        0.05 / (total_tests - rank + 1) AS holm_alpha
    FROM ranked_tests
)
SELECT
    test_id,
    ROUND(p_value::numeric, 4) AS p_value,
    ROUND(holm_alpha::numeric, 4) AS holm_alpha,
    CASE
        WHEN p_value < holm_alpha THEN 'Significant'
        ELSE 'Not significant'
    END AS holm_result
FROM holm_adjustment
ORDER BY p_value;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 åŸºå› ç»„å­¦ç ”ç©¶

```sql
-- åŸºå› ç»„å­¦å¤šé‡æ¯”è¾ƒåº”ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'genomics_tests') THEN
            CREATE TABLE genomics_tests (
                gene_id INTEGER PRIMARY KEY,
                p_value NUMERIC NOT NULL,
                gene_name VARCHAR(100)
            );

            -- æ’å…¥åŸºå› è¡¨è¾¾å·®å¼‚æ£€éªŒç»“æœ
            INSERT INTO genomics_tests (gene_id, p_value, gene_name) VALUES
                (1, 0.001, 'Gene1'), (2, 0.002, 'Gene2'), (3, 0.003, 'Gene3'),
                (4, 0.01, 'Gene4'), (5, 0.02, 'Gene5');

            RAISE NOTICE 'åŸºå› ç»„å­¦æ£€éªŒæ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŸºå› ç»„å­¦åº”ç”¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- FDRæ§åˆ¶ï¼ˆé€‚ç”¨äºå¤§è§„æ¨¡æ£€éªŒï¼‰
WITH ranked_genes AS (
    SELECT
        gene_id,
        gene_name,
        p_value,
        ROW_NUMBER() OVER (ORDER BY p_value) AS rank,
        COUNT(*) OVER () AS total_genes
    FROM genomics_tests
),
fdr_correction AS (
    SELECT
        gene_id,
        gene_name,
        p_value,
        rank,
        (rank::NUMERIC / total_genes) * 0.05 AS fdr_threshold
    FROM ranked_genes
)
SELECT
    gene_id,
    gene_name,
    ROUND(p_value::numeric, 6) AS p_value,
    ROUND(fdr_threshold::numeric, 6) AS fdr_threshold,
    CASE
        WHEN p_value <= fdr_threshold THEN 'Significant'
        ELSE 'Not significant'
    END AS fdr_result
FROM fdr_correction
ORDER BY p_value;
```

### 4.2 A/Bæµ‹è¯•

```sql
-- A/Bæµ‹è¯•å¤šé‡æ¯”è¾ƒåº”ç”¨
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'ab_test_results') THEN
            CREATE TABLE ab_test_results (
                test_id INTEGER PRIMARY KEY,
                metric_name VARCHAR(50) NOT NULL,
                p_value NUMERIC NOT NULL
            );

            -- æ’å…¥A/Bæµ‹è¯•ç»“æœ
            INSERT INTO ab_test_results (test_id, metric_name, p_value) VALUES
                (1, 'Click Rate', 0.03),
                (2, 'Conversion Rate', 0.04),
                (3, 'Revenue', 0.05),
                (4, 'Retention', 0.06);

            RAISE NOTICE 'A/Bæµ‹è¯•ç»“æœè¡¨åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'A/Bæµ‹è¯•åº”ç”¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- Bonferroniæ ¡æ­£ï¼ˆä¿å®ˆæ–¹æ³•ï¼‰
WITH test_count AS (
    SELECT COUNT(*) AS m FROM ab_test_results
),
bonferroni_corrected AS (
    SELECT
        test_id,
        metric_name,
        p_value,
        0.05 / (SELECT m FROM test_count) AS adjusted_alpha
    FROM ab_test_results
    CROSS JOIN test_count
)
SELECT
    test_id,
    metric_name,
    ROUND(p_value::numeric, 4) AS p_value,
    ROUND(adjusted_alpha::numeric, 6) AS adjusted_alpha,
    CASE
        WHEN p_value < adjusted_alpha THEN 'Significant'
        ELSE 'Not significant'
    END AS bonferroni_result
FROM bonferroni_corrected
ORDER BY p_value;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºå…³é”®ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_p_value ON multiple_tests(p_value);
CREATE INDEX IF NOT EXISTS idx_test_id ON multiple_tests(test_id);
```

### å¹¶è¡Œè®¡ç®—

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 100;
SET parallel_tuple_cost = 0.01;
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### æ–¹æ³•é€‰æ‹©

1. **Bonferroni**: ä¿å®ˆï¼Œé€‚ç”¨äºæ£€éªŒæ•°é‡å°‘
2. **Holm**: æ¯”Bonferroniæ›´powerfulï¼Œæ¨èä½¿ç”¨
3. **FDR**: é€‚ç”¨äºå¤§è§„æ¨¡æ£€éªŒï¼ˆå¦‚åŸºå› ç»„å­¦ï¼‰

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ä½¿ç”¨DOå—å’ŒEXCEPTIONè¿›è¡Œé”™è¯¯å¤„ç†
2. **æ•°å€¼ç²¾åº¦**: æ³¨æ„på€¼æ’åºå’Œæ¯”è¾ƒçš„ç²¾åº¦
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æ’åºæ€§èƒ½

---

## ğŸ“ˆ å¤šé‡æ¯”è¾ƒæ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | FWERæ§åˆ¶ | Power | é€‚ç”¨åœºæ™¯ |
|------|---------|-------|---------|
| **Bonferroni** | æ˜¯ | ä½ | æ£€éªŒæ•°é‡å°‘ |
| **Holm** | æ˜¯ | ä¸­ | ä¸€èˆ¬æƒ…å†µ |
| **FDR (BH)** | å¦ | é«˜ | å¤§è§„æ¨¡æ£€éªŒ |

---

## ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ ¡æ­£åæ— æ˜¾è‘—ç»“æœ

**åŸå› **ï¼š

- æ£€éªŒæ•°é‡å¤š
- æ•ˆåº”é‡å°
- æ ·æœ¬é‡ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨FDRæ–¹æ³•
- å¢åŠ æ ·æœ¬é‡
- é¢„ç­›é€‰æ£€éªŒ

### é—®é¢˜2ï¼šæ–¹æ³•é€‰æ‹©å›°éš¾

**åŸå› **ï¼š

- ä¸äº†è§£æ–¹æ³•å·®å¼‚
- åº”ç”¨åœºæ™¯ä¸æ˜ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š

- FWERæ§åˆ¶ï¼šä½¿ç”¨Bonferroniæˆ–Holm
- FDRæ§åˆ¶ï¼šä½¿ç”¨BHæ–¹æ³•
- å¤§è§„æ¨¡æ£€éªŒï¼šä½¿ç”¨FDR

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Benjamini, Y., Hochberg, Y. (1995)**: "Controlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing", Journal of the Royal Statistical Society, Series B, 57(1), 289-300
2. **Holm, S. (1979)**: "A Simple Sequentially Rejective Multiple Test Procedure", Scandinavian Journal of Statistics, 6(2), 65-70
3. **Bonferroni, C.E. (1936)**: "Teoria statistica delle classi e calcolo delle probabilitÃ ", Pubblicazioni del R Istituto Superiore di Scienze Economiche e Commerciali di Firenze, 8, 3-62

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
