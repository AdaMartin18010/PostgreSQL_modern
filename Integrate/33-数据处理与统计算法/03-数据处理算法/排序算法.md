# PostgreSQL æ’åºç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ’åºç®—æ³• | æŸ¥è¯¢ä¼˜åŒ–
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ’åºç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ’åºç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ’åºç®—æ³•æ¦‚è¿°](#æ’åºç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ’åºé—®é¢˜å®šä¹‰](#æ’åºé—®é¢˜å®šä¹‰)
      - [æ’åºç®—æ³•åˆ†ç±»](#æ’åºç®—æ³•åˆ†ç±»)
      - [æ’åºç­–ç•¥é€‰æ‹©](#æ’åºç­–ç•¥é€‰æ‹©)
    - [æ ¸å¿ƒæ’åºåŠŸèƒ½](#æ ¸å¿ƒæ’åºåŠŸèƒ½)
  - [1. ORDER BYæ’åº](#1-order-byæ’åº)
    - [1.1 ORDER BYæ’åºåŸç†](#11-order-byæ’åºåŸç†)
      - [æ’åºè¿‡ç¨‹](#æ’åºè¿‡ç¨‹)
      - [æ’åºæ–¹å‘](#æ’åºæ–¹å‘)
    - [1.2 åŸºç¡€æ’åºå®ç°](#12-åŸºç¡€æ’åºå®ç°)
    - [1.3 å¤šåˆ—æ’åºå®ç°](#13-å¤šåˆ—æ’åºå®ç°)
    - [1.4 NULLå€¼æ’åº](#14-nullå€¼æ’åº)
  - [2. çª—å£å‡½æ•°æ’åº](#2-çª—å£å‡½æ•°æ’åº)
    - [2.1 çª—å£å‡½æ•°æ’åºåŸç†](#21-çª—å£å‡½æ•°æ’åºåŸç†)
      - [åˆ†åŒºæ’åº](#åˆ†åŒºæ’åº)
      - [æ’åºå‡½æ•°](#æ’åºå‡½æ•°)
    - [2.2 åˆ†åŒºå†…æ’åºå®ç°](#22-åˆ†åŒºå†…æ’åºå®ç°)
    - [2.3 å¤šçº§æ’åº](#23-å¤šçº§æ’åº)
  - [3. ç´¢å¼•æ’åºä¼˜åŒ–](#3-ç´¢å¼•æ’åºä¼˜åŒ–)
    - [3.1 ç´¢å¼•æ’åºåŸç†](#31-ç´¢å¼•æ’åºåŸç†)
      - [ç´¢å¼•æ’åºä¼˜åŠ¿](#ç´¢å¼•æ’åºä¼˜åŠ¿)
      - [ç´¢å¼•æ’åºæ¡ä»¶](#ç´¢å¼•æ’åºæ¡ä»¶)
    - [3.2 åˆ©ç”¨ç´¢å¼•æ’åºå®ç°](#32-åˆ©ç”¨ç´¢å¼•æ’åºå®ç°)
    - [3.3 å¤åˆç´¢å¼•æ’åº](#33-å¤åˆç´¢å¼•æ’åº)
  - [4. æ’åºä¼˜åŒ–ç­–ç•¥](#4-æ’åºä¼˜åŒ–ç­–ç•¥)
    - [4.1 LIMITä¼˜åŒ–](#41-limitä¼˜åŒ–)
    - [4.2 ç´¢å¼•ä¼˜åŒ–æ’åº](#42-ç´¢å¼•ä¼˜åŒ–æ’åº)
    - [4.3 work\_memè°ƒä¼˜](#43-work_memè°ƒä¼˜)
  - [5. PostgreSQL 18å¹¶è¡Œæ’åºå¢å¼º](#5-postgresql-18å¹¶è¡Œæ’åºå¢å¼º)
    - [5.1 å¹¶è¡Œæ’åºæ¦‚è¿°](#51-å¹¶è¡Œæ’åºæ¦‚è¿°)
      - [å¹¶è¡Œæ’åºåŸç†](#å¹¶è¡Œæ’åºåŸç†)
      - [å¹¶è¡Œæ’åºæ¡ä»¶](#å¹¶è¡Œæ’åºæ¡ä»¶)
    - [5.2 å¹¶è¡Œæ’åºé…ç½®](#52-å¹¶è¡Œæ’åºé…ç½®)
    - [5.3 å¹¶è¡Œæ’åºå®ç°ç¤ºä¾‹](#53-å¹¶è¡Œæ’åºå®ç°ç¤ºä¾‹)
    - [5.4 å¹¶è¡Œæ’åºæ€§èƒ½ä¼˜åŒ–](#54-å¹¶è¡Œæ’åºæ€§èƒ½ä¼˜åŒ–)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 Top NæŸ¥è¯¢ä¼˜åŒ–](#61-top-næŸ¥è¯¢ä¼˜åŒ–)
    - [6.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–](#62-åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–)
    - [6.3 å¤šåˆ—æ’åºä¼˜åŒ–](#63-å¤šåˆ—æ’åºä¼˜åŒ–)
    - [5.4 æ’åºæ€§èƒ½ç›‘æ§](#54-æ’åºæ€§èƒ½ç›‘æ§)
  - [6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#6-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 æ’åºç­–ç•¥å¯¹æ¯”](#61-æ’åºç­–ç•¥å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 ç´¢å¼•è®¾è®¡](#71-ç´¢å¼•è®¾è®¡)
    - [7.2 æŸ¥è¯¢ä¼˜åŒ–](#72-æŸ¥è¯¢ä¼˜åŒ–)
    - [7.3 é…ç½®è°ƒä¼˜](#73-é…ç½®è°ƒä¼˜)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨](#75-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨)
    - [7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§](#76-é«˜çº§ä¼˜åŒ–æŠ€å·§)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ’åºç®—æ³•æ¦‚è¿°

**æ’åºç®—æ³•ï¼ˆSorting Algorithmï¼‰**ç”¨äºå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºï¼Œæ˜¯æ•°æ®åº“æŸ¥è¯¢ä¸­æœ€å¸¸è§çš„æ“ä½œä¹‹ä¸€ã€‚PostgreSQLæ ¹æ®æ•°æ®é‡ã€å¯ç”¨å†…å­˜å’Œç´¢å¼•æƒ…å†µï¼Œæ™ºèƒ½é€‰æ‹©æœ€ä¼˜çš„æ’åºç­–ç•¥ã€‚

### ç†è®ºåŸºç¡€

#### æ’åºé—®é¢˜å®šä¹‰

**æ’åºé—®é¢˜**ï¼šç»™å®šä¸€ä¸ªåºåˆ—$S = \{x_1, x_2, \ldots, x_n\}$ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ’åˆ—$\pi$ä½¿å¾—ï¼š
$$x_{\pi(1)} \leq x_{\pi(2)} \leq \ldots \leq x_{\pi(n)}$$

å¯¹äºé™åºæ’åºï¼Œåˆ™è¦æ±‚ï¼š
$$x_{\pi(1)} \geq x_{\pi(2)} \geq \ldots \geq x_{\pi(n)}$$

#### æ’åºç®—æ³•åˆ†ç±»

PostgreSQLä½¿ç”¨ä¸‰ç§ä¸»è¦æ’åºç­–ç•¥ï¼š

1. **ç´¢å¼•æ’åºï¼ˆIndex Scan Sortï¼‰**ï¼š
   - åˆ©ç”¨B-Treeç´¢å¼•çš„æœ‰åºæ€§
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(1)$
   - æ— éœ€é¢å¤–æ’åºæ“ä½œ

2. **å†…å­˜æ’åºï¼ˆIn-Memory Sortï¼‰**ï¼š
   - ä½¿ç”¨å¿«é€Ÿæ’åºï¼ˆQuicksortï¼‰æˆ–å †æ’åºï¼ˆHeapsortï¼‰
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(\log n)$ï¼ˆå¿«é€Ÿæ’åºï¼‰æˆ–$O(1)$ï¼ˆå †æ’åºï¼‰
   - éœ€è¦è¶³å¤Ÿçš„å†…å­˜ï¼ˆwork_memï¼‰

3. **å¤–éƒ¨æ’åºï¼ˆExternal Sortï¼‰**ï¼š
   - ä½¿ç”¨å½’å¹¶æ’åºï¼ˆMerge Sortï¼‰
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰
   - æ•°æ®è¶…å‡ºå†…å­˜æ—¶ä½¿ç”¨ç£ç›˜

#### æ’åºç­–ç•¥é€‰æ‹©

PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨æ ¹æ®ä»¥ä¸‹å› ç´ é€‰æ‹©æ’åºç­–ç•¥ï¼š

1. **ç´¢å¼•å¯ç”¨æ€§**ï¼šå¦‚æœæ’åºåˆ—ä¸Šæœ‰ç´¢å¼•ä¸”æ’åºæ–¹å‘åŒ¹é…ï¼Œä¼˜å…ˆä½¿ç”¨ç´¢å¼•æ’åº
2. **æ•°æ®é‡**ï¼šå°æ•°æ®é›†ä½¿ç”¨å†…å­˜æ’åºï¼Œå¤§æ•°æ®é›†ä½¿ç”¨å¤–éƒ¨æ’åº
3. **å†…å­˜é™åˆ¶**ï¼šæ ¹æ®work_memé…ç½®å†³å®šæ˜¯å¦ä½¿ç”¨å¤–éƒ¨æ’åº
4. **LIMITå­å¥**ï¼šLIMITå¯ä»¥ä¼˜åŒ–æ’åºï¼Œåªæ’åºå‰Næ¡è®°å½•

### æ ¸å¿ƒæ’åºåŠŸèƒ½

| åŠŸèƒ½ | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **ORDER BY** | å¯¹åºåˆ—$S$æ’åº | åŸºç¡€æ’åº | $O(n \log n)$ | $O(n)$ | é€šç”¨æ’åº |
| **çª—å£æ’åº** | åˆ†åŒºå†…æ’åº | åˆ†åŒºå†…æ’åº | $O(n \log n)$ | $O(n)$ | çª—å£å‡½æ•° |
| **ç´¢å¼•æ’åº** | åˆ©ç”¨ç´¢å¼•æœ‰åºæ€§ | é¿å…æ˜¾å¼æ’åº | $O(n)$ | $O(1)$ | æœ‰ç´¢å¼•æ—¶ |

---

## 1. ORDER BYæ’åº

### 1.1 ORDER BYæ’åºåŸç†

**ORDER BYå­å¥**ç”¨äºå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºï¼Œæ˜¯SQLæ ‡å‡†ä¸­æœ€å¸¸ç”¨çš„æ’åºæ–¹å¼ã€‚

#### æ’åºè¿‡ç¨‹

ORDER BYçš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. **æ•°æ®è·å–**ï¼šä»è¡¨ä¸­è·å–æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•
2. **æ’åºæ“ä½œ**ï¼šæ ¹æ®ORDER BYå­å¥æŒ‡å®šçš„åˆ—å’Œæ–¹å‘è¿›è¡Œæ’åº
3. **ç»“æœè¿”å›**ï¼šè¿”å›æ’åºåçš„ç»“æœé›†

#### æ’åºæ–¹å‘

- **ASC**ï¼šå‡åºæ’åºï¼ˆé»˜è®¤ï¼‰ï¼Œä»å°åˆ°å¤§
- **DESC**ï¼šé™åºæ’åºï¼Œä»å¤§åˆ°å°

### 1.2 åŸºç¡€æ’åºå®ç°

**å•åˆ—æ’åº**æŒ‰ç…§å•ä¸ªåˆ—è¿›è¡Œæ’åºã€‚

```sql
-- åŸºç¡€æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºç¡€æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å•åˆ—å‡åºæ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price ASC
LIMIT 100;

-- å•åˆ—é™åºæ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 100;
```

### 1.3 å¤šåˆ—æ’åºå®ç°

**å¤šåˆ—æ’åº**æŒ‰ç…§å¤šä¸ªåˆ—çš„é¡ºåºè¿›è¡Œæ’åºï¼Œå…ˆæŒ‰ç¬¬ä¸€åˆ—æ’åºï¼Œç›¸åŒå€¼å†æŒ‰ç¬¬äºŒåˆ—æ’åºã€‚

```sql
-- å¤šåˆ—æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šåˆ—æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šåˆ—æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šåˆ—æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šåˆ—æ’åºï¼šå…ˆæŒ‰æ—¥æœŸé™åºï¼Œå†æŒ‰å®¢æˆ·IDå‡åºï¼Œæœ€åæŒ‰é‡‘é¢é™åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT order_id, order_date, customer_id, amount
FROM orders
ORDER BY order_date DESC, customer_id ASC, amount DESC;

-- å¤šåˆ—æ’åºï¼šæŒ‰ç±»åˆ«å’Œä»·æ ¼æ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT category, product_name, price
FROM products
ORDER BY category ASC, price DESC;
```

### 1.4 NULLå€¼æ’åº

**NULLå€¼æ’åº**ï¼šPostgreSQLä¸­NULLå€¼é»˜è®¤æ’åœ¨æœ€åï¼ˆASCï¼‰æˆ–æœ€å‰ï¼ˆDESCï¼‰ï¼Œå¯ä»¥ä½¿ç”¨NULLS FIRST/NULLS LASTæ§åˆ¶ã€‚

```sql
-- NULLå€¼æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒNULLå€¼æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒNULLå€¼æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'NULLå€¼æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- NULLå€¼æ’åœ¨æœ€åï¼ˆé»˜è®¤ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price ASC NULLS LAST;

-- NULLå€¼æ’åœ¨æœ€å‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price ASC NULLS FIRST;
```

---

## 2. çª—å£å‡½æ•°æ’åº

### 2.1 çª—å£å‡½æ•°æ’åºåŸç†

**çª—å£å‡½æ•°æ’åº**åœ¨çª—å£å‡½æ•°ä¸­ä½¿ç”¨ORDER BYå­å¥ï¼Œå¯¹åˆ†åŒºå†…çš„æ•°æ®è¿›è¡Œæ’åºã€‚

#### åˆ†åŒºæ’åº

çª—å£å‡½æ•°æ’åºçš„ç‰¹ç‚¹ï¼š

1. **åˆ†åŒºå†…æ’åº**ï¼šæ¯ä¸ªåˆ†åŒºç‹¬ç«‹æ’åº
2. **æ’åºå‡½æ•°**ï¼šROW_NUMBERã€RANKã€DENSE_RANKç­‰éœ€è¦æ’åº
3. **æ’åºæ–¹å‘**ï¼šæ”¯æŒASCå’ŒDESC

#### æ’åºå‡½æ•°

å¸¸ç”¨çš„æ’åºç›¸å…³çª—å£å‡½æ•°ï¼š

- **ROW_NUMBER()**ï¼šä¸ºæ¯è¡Œåˆ†é…å”¯ä¸€åºå·
- **RANK()**ï¼šç›¸åŒå€¼ç›¸åŒæ’åï¼Œè·³è¿‡åç»­æ’å
- **DENSE_RANK()**ï¼šç›¸åŒå€¼ç›¸åŒæ’åï¼Œä¸è·³è¿‡åç»­æ’å
- **PERCENT_RANK()**ï¼šç™¾åˆ†æ¯”æ’å
- **CUME_DIST()**ï¼šç´¯ç§¯åˆ†å¸ƒ

### 2.2 åˆ†åŒºå†…æ’åºå®ç°

**åˆ†åŒºå†…æ’åº**åœ¨æ¯ä¸ªåˆ†åŒºå†…ç‹¬ç«‹è¿›è¡Œæ’åºã€‚

```sql
-- åˆ†åŒºå†…æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œçª—å£æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œçª—å£å‡½æ•°æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çª—å£æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ROW_NUMBERæ’åºï¼šæ¯ä¸ªç±»åˆ«å†…æŒ‰é”€å”®é¢é™åºæ’å
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    product_name,
    sales_amount,
    ROW_NUMBER() OVER (PARTITION BY category ORDER BY sales_amount DESC) AS rank_in_category
FROM sales
ORDER BY category, rank_in_category;

-- RANKæ’åºï¼šå¤„ç†ç›¸åŒå€¼çš„æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    product_name,
    sales_amount,
    RANK() OVER (PARTITION BY category ORDER BY sales_amount DESC) AS rank_in_category,
    DENSE_RANK() OVER (PARTITION BY category ORDER BY sales_amount DESC) AS dense_rank_in_category
FROM sales
ORDER BY category, rank_in_category;
```

### 2.3 å¤šçº§æ’åº

**å¤šçº§æ’åº**åœ¨çª—å£å‡½æ•°ä¸­ä½¿ç”¨å¤šä¸ªæ’åºåˆ—ã€‚

```sql
-- å¤šçº§æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šçº§æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šçº§æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šçº§æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šçº§æ’åºï¼šå…ˆæŒ‰ç±»åˆ«åˆ†åŒºï¼Œå†æŒ‰é”€å”®é¢é™åºï¼Œæœ€åæŒ‰äº§å“åç§°å‡åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    product_name,
    sales_amount,
    ROW_NUMBER() OVER (
        PARTITION BY category
        ORDER BY sales_amount DESC, product_name ASC
    ) AS rank_in_category
FROM sales
ORDER BY category, rank_in_category;
```

---

## 3. ç´¢å¼•æ’åºä¼˜åŒ–

### 3.1 ç´¢å¼•æ’åºåŸç†

**ç´¢å¼•æ’åºï¼ˆIndex Scan Sortï¼‰**åˆ©ç”¨B-Treeç´¢å¼•çš„æœ‰åºæ€§ï¼Œç›´æ¥æŒ‰ç´¢å¼•é¡ºåºæ‰«ææ•°æ®ï¼Œé¿å…æ˜¾å¼æ’åºæ“ä½œã€‚

#### ç´¢å¼•æ’åºä¼˜åŠ¿

1. **é›¶æ’åºæˆæœ¬**ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œæ— éœ€æ’åºæ“ä½œ
2. **é«˜æ•ˆæ‰«æ**ï¼šé¡ºåºI/Oï¼Œæ€§èƒ½æœ€ä¼˜
3. **æ”¯æŒèŒƒå›´æŸ¥è¯¢**ï¼šå¯ä»¥é«˜æ•ˆå¤„ç†LIMITå’ŒOFFSET
4. **å†…å­˜å ç”¨å°‘**ï¼šä¸éœ€è¦é¢å¤–çš„æ’åºå†…å­˜

#### ç´¢å¼•æ’åºæ¡ä»¶

1. **ç´¢å¼•å­˜åœ¨**ï¼šæ’åºåˆ—ä¸Šæœ‰B-Treeç´¢å¼•
2. **æ’åºæ–¹å‘åŒ¹é…**ï¼šORDER BYæ–¹å‘ä¸ç´¢å¼•æ–¹å‘ä¸€è‡´
3. **å¤šåˆ—æ’åº**ï¼šéœ€è¦å¤åˆç´¢å¼•ä¸”é¡ºåºåŒ¹é…
4. **æŸ¥è¯¢æ¡ä»¶åŒ¹é…**ï¼šWHEREæ¡ä»¶å¯ä»¥ä½¿ç”¨ç´¢å¼•

### 3.2 åˆ©ç”¨ç´¢å¼•æ’åºå®ç°

**å•åˆ—ç´¢å¼•æ’åº**ä½¿ç”¨å•åˆ—ç´¢å¼•è¿›è¡Œæ’åºã€‚

```sql
-- åˆ›å»ºæ’åºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        -- åˆ›å»ºå•åˆ—ç´¢å¼•
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'products' AND indexname = 'idx_products_price') THEN
            RAISE WARNING 'ç´¢å¼• idx_products_price å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_products_price ON products(price DESC);
            RAISE NOTICE 'ç´¢å¼• idx_products_price åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ products ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_products_price å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä½¿ç”¨ç´¢å¼•æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç´¢å¼•æ’åºæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç´¢å¼•æ’åºæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•æ’åºæŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å•åˆ—ç´¢å¼•æ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 100;
```

### 3.3 å¤åˆç´¢å¼•æ’åº

**å¤åˆç´¢å¼•æ’åº**ä½¿ç”¨å¤šåˆ—å¤åˆç´¢å¼•è¿›è¡Œæ’åºã€‚

```sql
-- åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'products' AND indexname = 'idx_products_price_name') THEN
            RAISE WARNING 'ç´¢å¼• idx_products_price_name å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_products_price_name ON products(price DESC, name ASC);
            RAISE NOTICE 'ç´¢å¼• idx_products_price_name åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ products ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_products_price_name å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä½¿ç”¨å¤åˆç´¢å¼•æ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC, name ASC
LIMIT 100;
```

---

## 4. æ’åºä¼˜åŒ–ç­–ç•¥

### 4.1 LIMITä¼˜åŒ–

**LIMITä¼˜åŒ–**ï¼šå½“æŸ¥è¯¢åªéœ€è¦å‰Næ¡è®°å½•æ—¶ï¼ŒPostgreSQLå¯ä»¥ä½¿ç”¨å †æ’åºåªç»´æŠ¤å‰Nä¸ªå…ƒç´ ï¼Œé¿å…å®Œæ•´æ’åºã€‚

```sql
-- LIMITä¼˜åŒ–æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒLIMITä¼˜åŒ–æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒLIMITä¼˜åŒ–æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'LIMITä¼˜åŒ–æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- LIMITä¼˜åŒ–ï¼šåªæ’åºå‰10æ¡è®°å½•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 10;
```

### 4.2 ç´¢å¼•ä¼˜åŒ–æ’åº

**ç´¢å¼•ä¼˜åŒ–æ’åº**ï¼šåˆ›å»ºåˆé€‚çš„ç´¢å¼•å¯ä»¥é¿å…æ’åºæ“ä½œã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç´¢å¼•ä¼˜åŒ–æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç´¢å¼•ä¼˜åŒ–æ’åº';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•ä¼˜åŒ–æ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè¦†ç›–ç´¢å¼•ä¼˜åŒ–æ’åº
CREATE INDEX IF NOT EXISTS idx_orders_date_customer_amount
ON orders(order_date DESC, customer_id ASC, amount DESC);

-- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT order_id, order_date, customer_id, amount
FROM orders
ORDER BY order_date DESC, customer_id ASC, amount DESC
LIMIT 100;
```

### 4.3 work_memè°ƒä¼˜

**work_memè°ƒä¼˜**ï¼šå¢åŠ work_memå¯ä»¥å‡å°‘å¤–éƒ¨æ’åºçš„ä½¿ç”¨ï¼Œæé«˜æ’åºæ€§èƒ½ã€‚

```sql
-- work_memè°ƒä¼˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æŸ¥çœ‹å½“å‰work_memè®¾ç½®
        RAISE NOTICE 'å½“å‰work_memè®¾ç½®: %', current_setting('work_mem');

        -- è®¾ç½®work_memï¼ˆä¼šè¯çº§åˆ«ï¼‰
        SET work_mem = '256MB';
        RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º256MB';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'work_memè°ƒä¼˜å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æµ‹è¯•work_memè°ƒä¼˜åçš„æ’åºæ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM large_table
ORDER BY sort_column DESC;
```

---

## 5. PostgreSQL 18å¹¶è¡Œæ’åºå¢å¼º

### 5.1 å¹¶è¡Œæ’åºæ¦‚è¿°

**PostgreSQL 18å¹¶è¡Œæ’åºå¢å¼º**ï¼šPostgreSQL 18å¯¹å¹¶è¡ŒæŸ¥è¯¢è¿›è¡Œäº†é‡å¤§æ”¹è¿›ï¼Œç‰¹åˆ«æ˜¯åœ¨æ’åºæ“ä½œæ–¹é¢ï¼Œå¯ä»¥æ˜¾è‘—æå‡å¤§è§„æ¨¡æ•°æ®æ’åºçš„æ€§èƒ½ã€‚

#### å¹¶è¡Œæ’åºåŸç†

**å¹¶è¡Œæ’åºï¼ˆParallel Sortï¼‰**ï¼šå°†æ’åºæ“ä½œåˆ†å¸ƒåˆ°å¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œæœ€ååˆå¹¶æ’åºç»“æœã€‚

**å¹¶è¡Œæ’åºä¼˜åŠ¿**ï¼š

- å……åˆ†åˆ©ç”¨å¤šæ ¸CPUèµ„æº
- å¤§å¹…æå‡å¤§è§„æ¨¡æ•°æ®æ’åºæ€§èƒ½
- æ”¯æŒå¤šç§æ’åºåœºæ™¯å¹¶è¡Œæ‰§è¡Œ

#### å¹¶è¡Œæ’åºæ¡ä»¶

PostgreSQLä¼šè‡ªåŠ¨é€‰æ‹©å¹¶è¡Œæ’åºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

1. **æ•°æ®é‡è¶³å¤Ÿå¤§**ï¼šé€šå¸¸éœ€è¦è¶…è¿‡`min_parallel_table_scan_size`é˜ˆå€¼
2. **æ’åºæ“ä½œæ”¯æŒå¹¶è¡Œ**ï¼šORDER BYæ“ä½œæ”¯æŒå¹¶è¡Œ
3. **ç³»ç»Ÿèµ„æºå……è¶³**ï¼šæœ‰è¶³å¤Ÿçš„å¹¶è¡Œå·¥ä½œè¿›ç¨‹å¯ç”¨

### 5.2 å¹¶è¡Œæ’åºé…ç½®

**é…ç½®å¹¶è¡Œå‚æ•°**ï¼š

```sql
-- é…ç½®å¹¶è¡Œæ’åºå‚æ•°ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾ç½®å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°ï¼ˆå»ºè®®ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰
        SET max_parallel_workers_per_gather = 4;

        -- è®¾ç½®å¹¶è¡Œè¡¨æ‰«æé˜ˆå€¼ï¼ˆé»˜è®¤8MBï¼‰
        SET min_parallel_table_scan_size = '8MB';

        -- è®¾ç½®å¹¶è¡Œæ’åºæˆæœ¬é˜ˆå€¼
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¹¶è¡Œæ’åºå‚æ•°å·²é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ’åºé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.3 å¹¶è¡Œæ’åºå®ç°ç¤ºä¾‹

**å¤§è§„æ¨¡æ•°æ®å¹¶è¡Œæ’åº**ï¼š

```sql
-- å¹¶è¡Œæ’åºï¼šå¤§è§„æ¨¡äº§å“é”€å”®æ•°æ®æ’åºï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
        SET max_parallel_workers_per_gather = 4;
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œæ’åºæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ’åºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¹¶è¡Œæ’åºæŸ¥è¯¢ï¼šæŒ‰é”€å”®é‡‘é¢æ’åº
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    product_id,
    product_name,
    SUM(amount) AS total_sales,
    COUNT(*) AS order_count
FROM sales_orders
WHERE order_date >= CURRENT_DATE - INTERVAL '1 year'
GROUP BY product_id, product_name
ORDER BY total_sales DESC
LIMIT 100;
```

**å¹¶è¡Œçª—å£æ’åº**ï¼š

```sql
-- å¹¶è¡Œçª—å£æ’åºï¼šè®¡ç®—æ’åï¼ˆPostgreSQL 18+ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    customer_id,
    order_date,
    amount,
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date DESC) AS order_rank,
    RANK() OVER (PARTITION BY customer_id ORDER BY amount DESC) AS amount_rank
FROM orders
WHERE order_date >= CURRENT_DATE - INTERVAL '90 days'
ORDER BY customer_id, order_date DESC;
```

### 5.4 å¹¶è¡Œæ’åºæ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–å»ºè®®**ï¼š

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨æ’åºåˆ—ä¸Šåˆ›å»ºç´¢å¼•
   - ä½¿ç”¨å¤åˆç´¢å¼•è¦†ç›–æŸ¥è¯¢

2. **åˆ†åŒºä¼˜åŒ–**ï¼š
   - ä½¿ç”¨åˆ†åŒºè¡¨æé«˜å¹¶è¡Œåº¦
   - åˆ†åŒºè£å‰ªå‡å°‘æ‰«ææ•°æ®é‡

3. **å‚æ•°è°ƒä¼˜**ï¼š
   - æ ¹æ®æ•°æ®é‡è°ƒæ•´`min_parallel_table_scan_size`
   - æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½®`max_parallel_workers_per_gather`

**æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**ï¼š

```sql
-- æ€§èƒ½å¯¹æ¯”ï¼šä¸²è¡Œ vs å¹¶è¡Œæ’åº
-- ä¸²è¡Œæ’åºï¼ˆç¦ç”¨å¹¶è¡Œï¼‰
SET max_parallel_workers_per_gather = 0;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table ORDER BY sort_column DESC LIMIT 1000;

-- å¹¶è¡Œæ’åºï¼ˆå¯ç”¨å¹¶è¡Œï¼Œ4ä¸ªå·¥ä½œè¿›ç¨‹ï¼‰
SET max_parallel_workers_per_gather = 4;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table ORDER BY sort_column DESC LIMIT 1000;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 Top NæŸ¥è¯¢ä¼˜åŒ–

**Top NæŸ¥è¯¢ä¼˜åŒ–**ï¼šè·å–æ’åºåçš„å‰Næ¡è®°å½•ï¼Œä½¿ç”¨LIMITå’Œç´¢å¼•ä¼˜åŒ–ã€‚

```sql
-- Top NæŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒTop NæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒTop NæŸ¥è¯¢ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Top NæŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- Top 10äº§å“é”€å”®
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    product_id,
    SUM(amount) AS total_sales
FROM sales
GROUP BY product_id
ORDER BY total_sales DESC
LIMIT 10;

-- Top 10å®¢æˆ·ï¼ˆæŒ‰è®¢å•é‡‘é¢ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    customer_id,
    SUM(amount) AS total_amount,
    COUNT(*) AS order_count
FROM orders
GROUP BY customer_id
ORDER BY total_amount DESC
LIMIT 10;
```

### 6.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

**åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨OFFSETå’ŒLIMITå®ç°åˆ†é¡µï¼Œä¼˜åŒ–æ’åºæ€§èƒ½ã€‚

```sql
-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†é¡µæŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¬¬ä¸€é¡µï¼ˆå‰20æ¡ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 20 OFFSET 0;

-- ç¬¬äºŒé¡µï¼ˆç¬¬21-40æ¡ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 20 OFFSET 20;

-- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_products_price_desc ON products(price DESC);

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT product_id, name, price
FROM products
ORDER BY price DESC
LIMIT 20 OFFSET 0;
```

### 6.3 å¤šåˆ—æ’åºä¼˜åŒ–

**å¤šåˆ—æ’åºä¼˜åŒ–**ï¼šä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–å¤šåˆ—æ’åºã€‚

```sql
-- å¤šåˆ—æ’åºä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šåˆ—æ’åºä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šåˆ—æ’åºä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šåˆ—æ’åºä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_orders_date_customer_amount
ON orders(order_date DESC, customer_id ASC, amount DESC);

-- å¤šåˆ—æ’åºæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT order_id, order_date, customer_id, amount
FROM orders
ORDER BY order_date DESC, customer_id ASC, amount DESC
LIMIT 100;
```

### 5.4 æ’åºæ€§èƒ½ç›‘æ§

**æ’åºæ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ’åºæ“ä½œçš„æ€§èƒ½ï¼Œè¯†åˆ«ä¼˜åŒ–æœºä¼šã€‚

```sql
-- æ’åºæ€§èƒ½ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºæ’åºæ€§èƒ½ç›‘æ§è¡¨
        CREATE TABLE IF NOT EXISTS sort_performance_log (
            id SERIAL PRIMARY KEY,
            query_text TEXT NOT NULL,
            table_name VARCHAR(100),
            sort_columns TEXT,
            row_count BIGINT,
            execution_time_ms NUMERIC(10, 2),
            sort_method VARCHAR(50),
            has_index BOOLEAN,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );

        RAISE NOTICE 'æ’åºæ€§èƒ½ç›‘æ§è¡¨å·²åˆ›å»º';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'æ’åºæ€§èƒ½ç›‘æ§è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºæ’åºæ€§èƒ½ç›‘æ§è¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ†ææ’åºæ€§èƒ½
SELECT
    table_name,
    sort_columns,
    AVG(execution_time_ms) AS avg_execution_time,
    AVG(row_count) AS avg_row_count,
    COUNT(*) AS query_count,
    SUM(CASE WHEN has_index THEN 1 ELSE 0 END) AS indexed_queries,
    SUM(CASE WHEN has_index = false AND execution_time_ms > 100 THEN 1 ELSE 0 END) AS optimization_candidates
FROM sort_performance_log
GROUP BY table_name, sort_columns
ORDER BY avg_execution_time DESC;
```

---

## 6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 æ’åºç­–ç•¥å¯¹æ¯”

| æ’åºç­–ç•¥ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|-----------|-----------|---------|------|------|
| **ç´¢å¼•æ’åº** | $O(n)$ | $O(1)$ | æœ‰ç´¢å¼•æ—¶ | æœ€å¿«ã€æ— æ’åºæˆæœ¬ | éœ€è¦ç´¢å¼• |
| **å†…å­˜æ’åºï¼ˆQuicksortï¼‰** | $O(n \log n)$ | $O(\log n)$ | å°æ•°æ®é›† | å¹³å‡æ€§èƒ½å¥½ | æœ€åæƒ…å†µ$O(n^2)$ |
| **å†…å­˜æ’åºï¼ˆHeapsortï¼‰** | $O(n \log n)$ | $O(1)$ | å°æ•°æ®é›† | æœ€åæƒ…å†µç¨³å®š | å¹³å‡æ€§èƒ½ç•¥å·® |
| **å¤–éƒ¨æ’åºï¼ˆMerge Sortï¼‰** | $O(n \log n)$ | $O(n)$ | å¤§æ•°æ®é›† | ç¨³å®šã€å¯å¤„ç†å¤§æ•°æ® | éœ€è¦ç£ç›˜ç©ºé—´ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨å¸¸ç”¨æ’åºåˆ—ä¸Šåˆ›å»ºç´¢å¼•
   - ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–å¤šåˆ—æ’åº
   - ç´¢å¼•æ–¹å‘ä¸æ’åºæ–¹å‘åŒ¹é…

2. **LIMITä¼˜åŒ–**ï¼š
   - ä½¿ç”¨LIMITåªè·å–éœ€è¦çš„è®°å½•
   - LIMITå¯ä»¥è§¦å‘å †æ’åºä¼˜åŒ–

3. **work_memè°ƒä¼˜**ï¼š
   - å¢åŠ work_memå‡å°‘å¤–éƒ¨æ’åº
   - æ ¹æ®æ•°æ®é‡è°ƒæ•´work_memå¤§å°

4. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - é¿å…ä¸å¿…è¦çš„æ’åº
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„æ’åº

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šæ’åºæ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºç´¢å¼•ã€ä½¿ç”¨LIMITã€å¢åŠ work_mem

**é—®é¢˜2**ï¼šå¤šåˆ—æ’åºæ— æ³•ä½¿ç”¨ç´¢å¼•

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºå¤åˆç´¢å¼•ï¼Œç´¢å¼•åˆ—é¡ºåºä¸ORDER BYé¡ºåºåŒ¹é…

**é—®é¢˜3**ï¼šå¤–éƒ¨æ’åºé¢‘ç¹

- **è§£å†³æ–¹æ¡ˆ**ï¼šå¢åŠ work_memé…ç½®ã€åˆ›å»ºç´¢å¼•ã€ä½¿ç”¨LIMIT

**é—®é¢˜4**ï¼šNULLå€¼æ’åºä¸ç¬¦åˆé¢„æœŸ

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨NULLS FIRSTæˆ–NULLS LASTæ˜ç¡®æŒ‡å®šNULLå€¼ä½ç½®

---

## 7. æœ€ä½³å®è·µ

### 7.1 ç´¢å¼•è®¾è®¡

1. **å•åˆ—æ’åº**ï¼šåœ¨æ’åºåˆ—ä¸Šåˆ›å»ºç´¢å¼•
2. **å¤šåˆ—æ’åº**ï¼šåˆ›å»ºå¤åˆç´¢å¼•ï¼Œåˆ—é¡ºåºä¸ORDER BYåŒ¹é…
3. **æ’åºæ–¹å‘**ï¼šç´¢å¼•æ–¹å‘ä¸æ’åºæ–¹å‘ä¸€è‡´
4. **è¦†ç›–ç´¢å¼•**ï¼šåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—

### 7.2 æŸ¥è¯¢ä¼˜åŒ–

1. **ä½¿ç”¨LIMIT**ï¼šåªè·å–éœ€è¦çš„è®°å½•æ•°
2. **é¿å…å…¨è¡¨æ’åº**ï¼šä½¿ç”¨WHEREæ¡ä»¶è¿‡æ»¤æ•°æ®
3. **ä½¿ç”¨çª—å£å‡½æ•°**ï¼šåˆ†åŒºå†…æ’åºæ¯”å…¨è¡¨æ’åºé«˜æ•ˆ

### 7.3 é…ç½®è°ƒä¼˜

1. **work_mem**ï¼šæ ¹æ®æ•°æ®é‡è°ƒæ•´ï¼Œé¿å…å¤–éƒ¨æ’åº
2. **shared_buffers**ï¼šå¢åŠ å…±äº«ç¼“å†²åŒºæé«˜I/Oæ€§èƒ½
3. **maintenance_work_mem**ï¼šç´¢å¼•åˆ›å»ºæ—¶ä½¿ç”¨

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **NULLå€¼å¤„ç†**ï¼šæ˜ç¡®æŒ‡å®šNULLå€¼æ’åºä½ç½®
2. **æ•°æ®ç±»å‹**ï¼šæ•°å€¼ç±»å‹æ’åºæ¯”å­—ç¬¦ä¸²ç±»å‹å¿«
3. **è¡¨è¾¾å¼æ’åº**ï¼šéœ€è¦è¡¨è¾¾å¼ç´¢å¼•
4. **æ€§èƒ½ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥æ’åºæ€§èƒ½ï¼Œè¯†åˆ«ä¼˜åŒ–æœºä¼š

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ’åºæ“ä½œçš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºæ’åºæŸ¥è¯¢ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-NæŸ¥è¯¢å’Œåˆ†é¡µæŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æ’åºæ“ä½œï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºå¤–éƒ¨æ’åºå’Œå¤§é‡æ•°æ®æ’åº

3. **å¹¶è¡Œæ’åºå¢å¼º**ï¼š
   - æ’åºæ“ä½œæ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®æ’åº

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–Top-Næ’åºæŸ¥è¯¢**

```sql
-- ä¸ºæ’åºåˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_products_price_skip_scan
ON products USING btree(price DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾ä»·æ ¼æœ€é«˜çš„å‰10ä¸ªå•†å“
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    product_id,
    product_name,
    price
FROM products
ORDER BY price DESC
LIMIT 10;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æ’åºç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„æ’åºæŸ¥è¯¢ï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨å•†å“æ’åºç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS top_products_cache AS
SELECT
    product_id,
    product_name,
    price,
    sales_count,
    ROW_NUMBER() OVER (ORDER BY sales_count DESC, price ASC) AS sales_rank,
    ROW_NUMBER() OVER (ORDER BY price DESC) AS price_rank
FROM products
WHERE status = 'active'
ORDER BY sales_count DESC, price ASC;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_top_products_sales_rank ON top_products_cache(sales_rank);
CREATE INDEX idx_top_products_price_rank ON top_products_cache(price_rank);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY top_products_cache;
```

**2. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ç‰¹å®šæ’åºåœºæ™¯**

ä¸ºç‰¹å®šæ’åºåœºæ™¯åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼š

```sql
-- ä¸ºæ´»è·ƒå•†å“åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆä»·æ ¼æ’åºï¼‰
CREATE INDEX IF NOT EXISTS idx_active_products_price
ON products USING btree(price DESC)
WHERE status = 'active' AND price > 0;

-- ä¸ºçƒ­é—¨å•†å“åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆé”€é‡æ’åºï¼‰
CREATE INDEX IF NOT EXISTS idx_hot_products_sales
ON products USING btree(sales_count DESC)
WHERE sales_count > 100 AND status = 'active';
```

**3. ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–åˆ†é¡µæ’åº**

ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…å…¨è¡¨æ’åºï¼š

```sql
-- ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–åˆ†é¡µæ’åºï¼ˆROW_NUMBERï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH ranked_products AS (
    SELECT
        product_id,
        product_name,
        price,
        sales_count,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ’åï¼ˆé¿å…å…¨è¡¨æ’åºï¼‰
        ROW_NUMBER() OVER (ORDER BY sales_count DESC, price ASC) AS rank
    FROM products
    WHERE status = 'active'
)
SELECT
    product_id,
    product_name,
    price,
    sales_count,
    rank
FROM ranked_products
WHERE rank BETWEEN 1 AND 20  -- ç¬¬1é¡µï¼š1-20
ORDER BY rank;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šç®—æ³•å¯¼è®ºã€‹ï¼ˆIntroduction to Algorithmsï¼‰- æ’åºç®—æ³•ç†è®ºåŸºç¡€
- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹ï¼ˆDatabase System Conceptsï¼‰- æŸ¥è¯¢ä¼˜åŒ–å’Œæ’åº

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [ORDER BYå­å¥](https://www.postgresql.org/docs/current/sql-select.html#SQL-ORDERBY)
- [æŸ¥è¯¢è§„åˆ’å™¨](https://www.postgresql.org/docs/current/planner-optimizer.html)
- [ç´¢å¼•ç±»å‹](https://www.postgresql.org/docs/current/indexes-types.html)

### åœ¨çº¿èµ„æº

- PostgreSQLæ€§èƒ½ä¼˜åŒ–æŒ‡å—
- æ’åºç®—æ³•å¯è§†åŒ–
- æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [èšåˆç®—æ³•](./èšåˆç®—æ³•.md) - èšåˆæ“ä½œä¸­çš„æ’åº
- [åˆ†ç»„ç®—æ³•](./åˆ†ç»„ç®—æ³•.md) - åˆ†ç»„æ“ä½œä¸­çš„æ’åº
- [æœç´¢ç®—æ³•](./æœç´¢ç®—æ³•.md) - æœç´¢ç»“æœçš„æ’åº

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
