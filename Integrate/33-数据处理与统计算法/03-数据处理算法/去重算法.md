# PostgreSQL åŽ»é‡ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | åŽ»é‡ç®—æ³• | æ•°æ®æ¸…æ´—
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ðŸ“‹ ç›®å½•

- [PostgreSQL åŽ»é‡ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-åŽ»é‡ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [åŽ»é‡ç®—æ³•æ¦‚è¿°](#åŽ»é‡ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [åŽ»é‡é—®é¢˜å®šä¹‰](#åŽ»é‡é—®é¢˜å®šä¹‰)
      - [åŽ»é‡ç®—æ³•åˆ†ç±»](#åŽ»é‡ç®—æ³•åˆ†ç±»)
      - [åŽ»é‡ç­–ç•¥é€‰æ‹©](#åŽ»é‡ç­–ç•¥é€‰æ‹©)
    - [æ ¸å¿ƒåŽ»é‡åŠŸèƒ½](#æ ¸å¿ƒåŽ»é‡åŠŸèƒ½)
  - [1. DISTINCTåŽ»é‡](#1-distinctåŽ»é‡)
    - [1.1 DISTINCTåŽ»é‡åŽŸç†](#11-distinctåŽ»é‡åŽŸç†)
      - [DISTINCTæ‰§è¡Œè¿‡ç¨‹](#distinctæ‰§è¡Œè¿‡ç¨‹)
      - [DISTINCTä¸ŽNULLå€¼](#distinctä¸Žnullå€¼)
    - [1.2 å•åˆ—åŽ»é‡å®žçŽ°](#12-å•åˆ—åŽ»é‡å®žçŽ°)
    - [1.3 å¤šåˆ—åŽ»é‡å®žçŽ°](#13-å¤šåˆ—åŽ»é‡å®žçŽ°)
    - [1.4 DISTINCT ONåŽ»é‡](#14-distinct-onåŽ»é‡)
  - [2. GROUP BYåŽ»é‡](#2-group-byåŽ»é‡)
    - [2.1 åˆ†ç»„åŽ»é‡](#21-åˆ†ç»„åŽ»é‡)
  - [3. çª—å£å‡½æ•°åŽ»é‡](#3-çª—å£å‡½æ•°åŽ»é‡)
    - [3.1 ä¿ç•™ç¬¬ä¸€æ¡è®°å½•](#31-ä¿ç•™ç¬¬ä¸€æ¡è®°å½•)
  - [4. åŽ»é‡ä¼˜åŒ–ç­–ç•¥](#4-åŽ»é‡ä¼˜åŒ–ç­–ç•¥)
    - [4.1 ç´¢å¼•ä¼˜åŒ–åŽ»é‡](#41-ç´¢å¼•ä¼˜åŒ–åŽ»é‡)
    - [4.2 å“ˆå¸ŒåŽ»é‡ä¼˜åŒ–](#42-å“ˆå¸ŒåŽ»é‡ä¼˜åŒ–)
    - [4.3 PostgreSQL 18 å¹¶è¡ŒåŽ»é‡å¢žå¼º](#43-postgresql-18-å¹¶è¡ŒåŽ»é‡å¢žå¼º)
      - [å¹¶è¡ŒåŽ»é‡åŽŸç†](#å¹¶è¡ŒåŽ»é‡åŽŸç†)
      - [å¹¶è¡ŒDISTINCTåŽ»é‡](#å¹¶è¡ŒdistinctåŽ»é‡)
      - [å¹¶è¡ŒGROUP BYåŽ»é‡](#å¹¶è¡Œgroup-byåŽ»é‡)
      - [å¹¶è¡ŒDISTINCT ONåŽ»é‡](#å¹¶è¡Œdistinct-onåŽ»é‡)
  - [5. å®žé™…åº”ç”¨æ¡ˆä¾‹](#5-å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 é‡å¤è®¢å•æ£€æµ‹](#51-é‡å¤è®¢å•æ£€æµ‹)
    - [5.2 æ•°æ®æ¸…æ´—åŽ»é‡](#52-æ•°æ®æ¸…æ´—åŽ»é‡)
    - [5.3 å”¯ä¸€æ€§éªŒè¯](#53-å”¯ä¸€æ€§éªŒè¯)
    - [5.4 åŽ»é‡æ€§èƒ½ç›‘æŽ§](#54-åŽ»é‡æ€§èƒ½ç›‘æŽ§)
  - [6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–](#6-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–)
    - [6.1 åŽ»é‡æ–¹æ³•å¯¹æ¯”](#61-åŽ»é‡æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ)
  - [7. æœ€ä½³å®žè·µ](#7-æœ€ä½³å®žè·µ)
    - [7.1 åŽ»é‡æ–¹æ³•é€‰æ‹©](#71-åŽ»é‡æ–¹æ³•é€‰æ‹©)
    - [7.2 ç´¢å¼•è®¾è®¡](#72-ç´¢å¼•è®¾è®¡)
    - [7.3 æŸ¥è¯¢ä¼˜åŒ–](#73-æŸ¥è¯¢ä¼˜åŒ–)
    - [7.4 SQLå®žçŽ°æ³¨æ„äº‹é¡¹](#74-sqlå®žçŽ°æ³¨æ„äº‹é¡¹)
  - [ðŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## åŽ»é‡ç®—æ³•æ¦‚è¿°

**åŽ»é‡ç®—æ³•ï¼ˆDeduplication Algorithmï¼‰**ç”¨äºŽåŽ»é™¤é‡å¤è®°å½•ï¼Œæ˜¯æ•°æ®æ¸…æ´—å’Œæ•°æ®å¤„ç†çš„æ ¸å¿ƒæ“ä½œä¹‹ä¸€ã€‚PostgreSQLæä¾›äº†å¤šç§åŽ»é‡æ–¹å¼ï¼Œæ¯ç§æ–¹å¼é€‚ç”¨äºŽä¸åŒçš„åœºæ™¯ã€‚

### ç†è®ºåŸºç¡€

#### åŽ»é‡é—®é¢˜å®šä¹‰

**åŽ»é‡é—®é¢˜**ï¼šç»™å®šä¸€ä¸ªå…³ç³»$R$ï¼Œæ‰¾åˆ°æ‰€æœ‰å”¯ä¸€çš„å…ƒç»„é›†åˆ$R'$ï¼Œä½¿å¾—ï¼š
$$R' = \{t \in R | \forall t' \in R', t \neq t'\}$$

å¯¹äºŽåŸºäºŽåˆ—çš„åŽ»é‡ï¼Œç»™å®šåˆ—é›†åˆ$C = \{c_1, c_2, \ldots, c_k\}$ï¼Œæ‰¾åˆ°æ‰€æœ‰å”¯ä¸€çš„åˆ—å€¼ç»„åˆï¼š
$$R' = \{t[C] | t \in R, \forall t' \in R', t[C] \neq t'[C]\}$$

#### åŽ»é‡ç®—æ³•åˆ†ç±»

PostgreSQLä½¿ç”¨ä¸‰ç§ä¸»è¦åŽ»é‡ç­–ç•¥ï¼š

1. **DISTINCTåŽ»é‡**ï¼š
   - ä½¿ç”¨æŽ’åºæˆ–å“ˆå¸ŒåŽ»é‡
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$ï¼ˆæŽ’åºï¼‰æˆ–$O(n)$ï¼ˆå“ˆå¸Œï¼‰
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$
   - é€‚ç”¨äºŽç®€å•åŽ»é‡

2. **GROUP BYåŽ»é‡**ï¼š
   - ä½¿ç”¨åˆ†ç»„æ“ä½œåŽ»é‡
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$
   - é€‚ç”¨äºŽéœ€è¦èšåˆçš„åŽ»é‡

3. **çª—å£å‡½æ•°åŽ»é‡**ï¼š
   - ä½¿ç”¨çª—å£å‡½æ•°é€‰æ‹©è®°å½•
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$
   - ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$
   - é€‚ç”¨äºŽéœ€è¦é€‰æ‹©ç‰¹å®šè®°å½•çš„åŽ»é‡

#### åŽ»é‡ç­–ç•¥é€‰æ‹©

PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨æ ¹æ®ä»¥ä¸‹å› ç´ é€‰æ‹©åŽ»é‡ç­–ç•¥ï¼š

1. **æ•°æ®é‡**ï¼šå°æ•°æ®é›†ä½¿ç”¨æŽ’åºï¼Œå¤§æ•°æ®é›†ä½¿ç”¨å“ˆå¸Œ
2. **å†…å­˜é™åˆ¶**ï¼šæ ¹æ®work_memé…ç½®é€‰æ‹©ç­–ç•¥
3. **ç´¢å¼•å¯ç”¨æ€§**ï¼šæœ‰ç´¢å¼•æ—¶å¯ä»¥ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–
4. **æ˜¯å¦éœ€è¦èšåˆ**ï¼šéœ€è¦èšåˆæ—¶ä½¿ç”¨GROUP BY

### æ ¸å¿ƒåŽ»é‡åŠŸèƒ½

| åŠŸèƒ½ | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **DISTINCT** | $R' = \{t[C] \mid t \in R, \forall t' \in R', t[C] \neq t'[C]\}$ | ç®€å•åŽ»é‡ | $O(n \log n)$ | $O(n)$ | ç®€å•åŽ»é‡ |
| **GROUP BY** | $R' = \{t[C] \mid t \in R\}$ + èšåˆ | åˆ†ç»„åŽ»é‡ | $O(n \log n)$ | $O(n)$ | éœ€è¦èšåˆ |
| **çª—å£å‡½æ•°** | $R' = \{t \mid t \in R, \text{rank}(t) = 1\}$ | é€‰æ‹©è®°å½• | $O(n \log n)$ | $O(n)$ | é€‰æ‹©ç‰¹å®šè®°å½• |

---

## 1. DISTINCTåŽ»é‡

### 1.1 DISTINCTåŽ»é‡åŽŸç†

**DISTINCTå­å¥**ç”¨äºŽåŽ»é™¤æŸ¥è¯¢ç»“æžœä¸­çš„é‡å¤è¡Œï¼Œæ˜¯SQLæ ‡å‡†ä¸­æœ€å¸¸ç”¨çš„åŽ»é‡æ–¹å¼ã€‚

#### DISTINCTæ‰§è¡Œè¿‡ç¨‹

DISTINCTçš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. **æ•°æ®èŽ·å–**ï¼šä»Žè¡¨ä¸­èŽ·å–æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•
2. **åŽ»é‡æ“ä½œ**ï¼šæ ¹æ®SELECTå­å¥ä¸­çš„åˆ—è¿›è¡ŒåŽ»é‡
3. **ç»“æžœè¿”å›ž**ï¼šè¿”å›žåŽ»é‡åŽçš„ç»“æžœé›†

PostgreSQLä½¿ç”¨ä¸¤ç§ç­–ç•¥å®žçŽ°DISTINCTï¼š

- **æŽ’åºåŽ»é‡**ï¼šå…ˆæŽ’åºï¼Œç„¶åŽåŽ»é™¤ç›¸é‚»é‡å¤é¡¹
- **å“ˆå¸ŒåŽ»é‡**ï¼šä½¿ç”¨å“ˆå¸Œè¡¨è®°å½•å·²å‡ºçŽ°çš„å€¼

#### DISTINCTä¸ŽNULLå€¼

- **NULLå€¼å¤„ç†**ï¼šå¤šä¸ªNULLå€¼è¢«è§†ä¸ºç›¸åŒï¼Œåªä¿ç•™ä¸€ä¸ª
- **NULLå€¼æ¯”è¾ƒ**ï¼šä½¿ç”¨`IS NULL`å’Œ`IS NOT NULL`åˆ¤æ–­

### 1.2 å•åˆ—åŽ»é‡å®žçŽ°

**å•åˆ—åŽ»é‡**åŽ»é™¤å•åˆ—çš„é‡å¤å€¼ã€‚

```sql
-- DISTINCTå•åˆ—åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒDISTINCTåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒDISTINCTå•åˆ—åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'DISTINCTåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å•åˆ—åŽ»é‡ï¼šèŽ·å–æ‰€æœ‰å”¯ä¸€çš„å®¢æˆ·ID
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id
FROM orders
ORDER BY customer_id;

-- å•åˆ—åŽ»é‡ï¼šèŽ·å–æ‰€æœ‰å”¯ä¸€çš„äº§å“ç±»åˆ«
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT category
FROM products
ORDER BY category;
```

### 1.3 å¤šåˆ—åŽ»é‡å®žçŽ°

**å¤šåˆ—åŽ»é‡**åŽ»é™¤å¤šåˆ—ç»„åˆçš„é‡å¤å€¼ã€‚

```sql
-- DISTINCTå¤šåˆ—åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šåˆ—åŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒDISTINCTå¤šåˆ—åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šåˆ—åŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šåˆ—åŽ»é‡ï¼šèŽ·å–å”¯ä¸€çš„å®¢æˆ·-äº§å“ç»„åˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id, product_id
FROM sales
ORDER BY customer_id, product_id;

-- å¤šåˆ—åŽ»é‡ï¼šèŽ·å–å”¯ä¸€çš„æ—¥æœŸ-ç±»åˆ«ç»„åˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT DATE_TRUNC('day', sale_date) AS sale_day, category
FROM sales
ORDER BY sale_day, category;
```

### 1.4 DISTINCT ONåŽ»é‡

**DISTINCT ON**æ˜¯PostgreSQLç‰¹æœ‰çš„è¯­æ³•ï¼Œç”¨äºŽèŽ·å–æ¯ä¸ªåˆ†ç»„çš„ç¬¬ä¸€æ¡è®°å½•ã€‚

```sql
-- DISTINCT ONåŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒDISTINCT ONåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒDISTINCT ONåŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'DISTINCT ONåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- DISTINCT ONï¼šæ¯ä¸ªå®¢æˆ·çš„æœ€æ–°è®¢å•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (customer_id)
    customer_id,
    order_id,
    order_date,
    amount
FROM orders
ORDER BY customer_id, order_date DESC;
```

---

## 2. GROUP BYåŽ»é‡

### 2.1 åˆ†ç»„åŽ»é‡

**GROUP BYåŽ»é‡**ä½¿ç”¨åˆ†ç»„åŽ»é™¤é‡å¤ï¼ŒåŒæ—¶ä¿ç•™å…¶ä»–åˆ—ã€‚

```sql
-- GROUP BYåŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒGROUP BYåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒGROUP BYåŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'GROUP BYåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    customer_id,
    product_id,
    MAX(order_date) AS latest_order_date,
    SUM(amount) AS total_amount
FROM orders
GROUP BY customer_id, product_id;
```

---

## 3. çª—å£å‡½æ•°åŽ»é‡

### 3.1 ä¿ç•™ç¬¬ä¸€æ¡è®°å½•

**çª—å£å‡½æ•°åŽ»é‡**ä½¿ç”¨ROW_NUMBERä¿ç•™æ¯ç»„çš„ç¬¬ä¸€æ¡è®°å½•ã€‚

```sql
-- çª—å£å‡½æ•°åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œçª—å£å‡½æ•°åŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œçª—å£å‡½æ•°åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çª—å£å‡½æ•°åŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM (
    SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY customer_id, product_id ORDER BY order_date DESC) AS rn
    FROM orders
) AS ranked
WHERE rn = 1;
```

---

## 4. åŽ»é‡ä¼˜åŒ–ç­–ç•¥

### 4.1 ç´¢å¼•ä¼˜åŒ–åŽ»é‡

**ç´¢å¼•ä¼˜åŒ–åŽ»é‡**ï¼šåˆ›å»ºåˆé€‚çš„ç´¢å¼•å¯ä»¥åŠ é€ŸåŽ»é‡æ“ä½œã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        -- åˆ›å»ºç´¢å¼•ä¼˜åŒ–åŽ»é‡
        CREATE INDEX IF NOT EXISTS idx_orders_customer_product
        ON orders(customer_id, product_id);

        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–åŽ»é‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id, product_id
FROM orders;
```

### 4.2 å“ˆå¸ŒåŽ»é‡ä¼˜åŒ–

**å“ˆå¸ŒåŽ»é‡ä¼˜åŒ–**ï¼šPostgreSQLè‡ªåŠ¨é€‰æ‹©å“ˆå¸ŒåŽ»é‡ç­–ç•¥ï¼Œé€‚ç”¨äºŽå¤§æ•°æ®é›†ã€‚

```sql
-- å“ˆå¸ŒåŽ»é‡ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¢žåŠ work_memä»¥æ”¯æŒå“ˆå¸ŒåŽ»é‡
        SET work_mem = '256MB';
        RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º256MB';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'work_memè®¾ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤§æ•°æ®é›†åŽ»é‡ï¼ˆä½¿ç”¨å“ˆå¸Œç­–ç•¥ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id, product_id
FROM large_sales_table;
```

### 4.3 PostgreSQL 18 å¹¶è¡ŒåŽ»é‡å¢žå¼º

**PostgreSQL 18** æ˜¾è‘—å¢žå¼ºäº†å¹¶è¡ŒåŽ»é‡èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œ DISTINCTã€GROUP BY å’Œçª—å£å‡½æ•°åŽ»é‡æ“ä½œï¼Œå¤§å¹…æå‡å¤§æ•°æ®é‡åŽ»é‡æŸ¥è¯¢çš„æ€§èƒ½ã€‚

#### å¹¶è¡ŒåŽ»é‡åŽŸç†

PostgreSQL 18 çš„å¹¶è¡ŒåŽ»é‡é€šè¿‡ä»¥ä¸‹æ–¹å¼å®žçŽ°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æè¡¨æ•°æ®
2. **å¹¶è¡ŒåŽ»é‡**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ‰§è¡ŒåŽ»é‡æ“ä½œ
3. **ç»“æžœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„åŽ»é‡ç»“æžœ

#### å¹¶è¡ŒDISTINCTåŽ»é‡

```sql
-- PostgreSQL 18 å¹¶è¡Œ DISTINCT åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_sales_table') THEN
            RAISE WARNING 'è¡¨ large_sales_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒDISTINCTåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒDISTINCTåŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒDISTINCTåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒDISTINCTåŽ»é‡ï¼šå•åˆ—åŽ»é‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id
FROM large_sales_table
ORDER BY customer_id;

-- å¹¶è¡ŒDISTINCTåŽ»é‡ï¼šå¤šåˆ—åŽ»é‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id, product_id
FROM large_sales_table
ORDER BY customer_id, product_id;
```

#### å¹¶è¡ŒGROUP BYåŽ»é‡

```sql
-- PostgreSQL 18 å¹¶è¡Œ GROUP BY åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒGROUP BYåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒGROUP BYåŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒGROUP BYåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒGROUP BYåŽ»é‡ï¼šåˆ†ç»„åŽ»é‡å¹¶èšåˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    customer_id,
    product_id,
    MAX(order_date) AS latest_order_date,
    SUM(amount) AS total_amount,
    COUNT(*) AS order_count
FROM orders
GROUP BY customer_id, product_id
ORDER BY customer_id, product_id;
```

#### å¹¶è¡ŒDISTINCT ONåŽ»é‡

```sql
-- PostgreSQL 18 å¹¶è¡Œ DISTINCT ON åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒDISTINCT ONåŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒDISTINCT ONåŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒDISTINCT ONåŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒDISTINCT ONåŽ»é‡ï¼šæ¯ä¸ªå®¢æˆ·çš„æœ€æ–°è®¢å•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (customer_id)
    customer_id,
    order_id,
    order_date,
    amount
FROM orders
ORDER BY customer_id, order_date DESC;
```

---

## 5. å®žé™…åº”ç”¨æ¡ˆä¾‹

### 5.1 é‡å¤è®¢å•æ£€æµ‹

**é‡å¤è®¢å•æ£€æµ‹**è¯†åˆ«å¹¶å¤„ç†é‡å¤è®¢å•ã€‚

```sql
-- é‡å¤è®¢å•æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé‡å¤è®¢å•æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé‡å¤è®¢å•æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é‡å¤è®¢å•æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æµ‹é‡å¤è®¢å•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    customer_id,
    product_id,
    order_date,
    COUNT(*) AS duplicate_count
FROM orders
GROUP BY customer_id, product_id, order_date
HAVING COUNT(*) > 1
ORDER BY duplicate_count DESC;

-- åˆ é™¤é‡å¤è®¢å•ï¼ˆä¿ç•™æœ€æ–°çš„ä¸€æ¡ï¼‰
DELETE FROM orders
WHERE order_id IN (
    SELECT order_id
    FROM (
        SELECT
            order_id,
            ROW_NUMBER() OVER (
                PARTITION BY customer_id, product_id, order_date
                ORDER BY order_id DESC
            ) AS rn
        FROM orders
    ) AS ranked
    WHERE rn > 1
);
```

### 5.2 æ•°æ®æ¸…æ´—åŽ»é‡

**æ•°æ®æ¸…æ´—åŽ»é‡**ï¼šæ¸…æ´—æ•°æ®ä¸­çš„é‡å¤è®°å½•ã€‚

```sql
-- æ•°æ®æ¸…æ´—åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'raw_data') THEN
            RAISE WARNING 'è¡¨ raw_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ•°æ®æ¸…æ´—åŽ»é‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ•°æ®æ¸…æ´—åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®æ¸…æ´—åŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºåŽ»é‡åŽçš„è¡¨
CREATE TABLE cleaned_data AS
SELECT DISTINCT ON (customer_id, email)
    customer_id,
    name,
    email,
    phone,
    created_at
FROM raw_data
ORDER BY customer_id, email, created_at DESC;

-- éªŒè¯åŽ»é‡ç»“æžœ
SELECT
    COUNT(*) AS original_count,
    (SELECT COUNT(*) FROM cleaned_data) AS cleaned_count,
    COUNT(*) - (SELECT COUNT(*) FROM cleaned_data) AS duplicates_removed
FROM raw_data;
```

### 5.3 å”¯ä¸€æ€§éªŒè¯

**å”¯ä¸€æ€§éªŒè¯**ï¼šéªŒè¯æ•°æ®çš„å”¯ä¸€æ€§çº¦æŸã€‚

```sql
-- å”¯ä¸€æ€§éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå”¯ä¸€æ€§éªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå”¯ä¸€æ€§éªŒè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å”¯ä¸€æ€§éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯é‚®ç®±å”¯ä¸€æ€§
SELECT
    email,
    COUNT(*) AS count
FROM users
GROUP BY email
HAVING COUNT(*) > 1
ORDER BY count DESC;

-- éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
SELECT
    username,
    COUNT(*) AS count
FROM users
GROUP BY username
HAVING COUNT(*) > 1
ORDER BY count DESC;
```

### 5.4 åŽ»é‡æ€§èƒ½ç›‘æŽ§

**åŽ»é‡æ€§èƒ½ç›‘æŽ§**ï¼šç›‘æŽ§åŽ»é‡æ“ä½œçš„æ€§èƒ½ã€‚

```sql
-- åŽ»é‡æ€§èƒ½ç›‘æŽ§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºåŽ»é‡æ€§èƒ½ç›‘æŽ§è¡¨
        CREATE TABLE IF NOT EXISTS deduplication_performance_log (
            id SERIAL PRIMARY KEY,
            query_text TEXT NOT NULL,
            table_name VARCHAR(100),
            deduplication_method VARCHAR(50),
            row_count_before BIGINT,
            row_count_after BIGINT,
            execution_time_ms NUMERIC(10, 2),
            created_at TIMESTAMPTZ DEFAULT NOW()
        );

        RAISE NOTICE 'åŽ»é‡æ€§èƒ½ç›‘æŽ§è¡¨å·²åˆ›å»º';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'åŽ»é‡æ€§èƒ½ç›‘æŽ§è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåŽ»é‡æ€§èƒ½ç›‘æŽ§è¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ†æžåŽ»é‡æ€§èƒ½
SELECT
    table_name,
    deduplication_method,
    AVG(execution_time_ms) AS avg_execution_time,
    AVG(row_count_before - row_count_after) AS avg_duplicates_removed,
    COUNT(*) AS query_count
FROM deduplication_performance_log
GROUP BY table_name, deduplication_method
ORDER BY avg_execution_time DESC;
```

---

## 6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–

### 6.1 åŽ»é‡æ–¹æ³•å¯¹æ¯”

| åŽ»é‡æ–¹æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|-----------|-----------|---------|------|------|
| **DISTINCT** | $O(n \log n)$ | $O(n)$ | ç®€å•åŽ»é‡ | ç®€å•ç›´æŽ¥ | éœ€è¦æŽ’åºæˆ–å“ˆå¸Œ |
| **GROUP BY** | $O(n \log n)$ | $O(n)$ | éœ€è¦èšåˆ | å¯èšåˆ | éœ€è¦æŽ’åº |
| **çª—å£å‡½æ•°** | $O(n \log n)$ | $O(n)$ | é€‰æ‹©è®°å½• | çµæ´» | éœ€è¦æŽ’åº |
| **DISTINCT ON** | $O(n \log n)$ | $O(n)$ | åˆ†ç»„ç¬¬ä¸€æ¡ | PostgreSQLç‰¹æœ‰ | éœ€è¦æŽ’åº |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨åŽ»é‡åˆ—ä¸Šåˆ›å»ºç´¢å¼•
   - ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–å¤šåˆ—åŽ»é‡

2. **å“ˆå¸Œä¼˜åŒ–**ï¼š
   - å¢žåŠ work_memæ”¯æŒå“ˆå¸ŒåŽ»é‡
   - å¤§æ•°æ®é›†ä½¿ç”¨å“ˆå¸Œç­–ç•¥

3. **å¹¶è¡Œä¼˜åŒ–**ï¼š
   - å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
   - å¤§æ•°æ®é›†ä½¿ç”¨å¹¶è¡ŒåŽ»é‡

4. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨DISTINCT ONæ›¿ä»£çª—å£å‡½æ•°ï¼ˆPostgreSQLç‰¹æœ‰ï¼‰
   - é¿å…ä¸å¿…è¦çš„åŽ»é‡

### 6.3 å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šåŽ»é‡æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºç´¢å¼•ã€å¢žåŠ work_memã€ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜2**ï¼šå†…å­˜ä¸è¶³

- **è§£å†³æ–¹æ¡ˆ**ï¼šå¢žåŠ work_memé…ç½®ã€ä½¿ç”¨å¤–éƒ¨æŽ’åº

**é—®é¢˜3**ï¼šåŽ»é‡ç»“æžœä¸ç¬¦åˆé¢„æœŸ

- **è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥NULLå€¼å¤„ç†ã€ç¡®è®¤åŽ»é‡åˆ—é€‰æ‹©

**é—®é¢˜4**ï¼šéœ€è¦ä¿ç•™ç‰¹å®šè®°å½•

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨çª—å£å‡½æ•°æˆ–DISTINCT ON

---

## 7. æœ€ä½³å®žè·µ

### 7.1 åŽ»é‡æ–¹æ³•é€‰æ‹©

1. **ç®€å•åŽ»é‡**ï¼šä½¿ç”¨DISTINCT
2. **éœ€è¦èšåˆ**ï¼šä½¿ç”¨GROUP BY
3. **é€‰æ‹©è®°å½•**ï¼šä½¿ç”¨çª—å£å‡½æ•°æˆ–DISTINCT ON
4. **å¤§æ•°æ®é›†**ï¼šä½¿ç”¨å“ˆå¸ŒåŽ»é‡ç­–ç•¥

### 7.2 ç´¢å¼•è®¾è®¡

1. **å•åˆ—åŽ»é‡**ï¼šåœ¨åŽ»é‡åˆ—ä¸Šåˆ›å»ºç´¢å¼•
2. **å¤šåˆ—åŽ»é‡**ï¼šåˆ›å»ºå¤åˆç´¢å¼•
3. **DISTINCT ON**ï¼šåœ¨ONåˆ—ä¸Šåˆ›å»ºç´¢å¼•

### 7.3 æŸ¥è¯¢ä¼˜åŒ–

1. **ä½¿ç”¨LIMIT**ï¼šåªèŽ·å–éœ€è¦çš„è®°å½•æ•°
2. **é¿å…å…¨è¡¨åŽ»é‡**ï¼šä½¿ç”¨WHEREæ¡ä»¶è¿‡æ»¤æ•°æ®
3. **ä½¿ç”¨DISTINCT ON**ï¼šPostgreSQLç‰¹æœ‰ï¼Œæ€§èƒ½æ›´å¥½

### 7.4 SQLå®žçŽ°æ³¨æ„äº‹é¡¹

1. **NULLå€¼å¤„ç†**ï¼šæ˜Žç¡®NULLå€¼çš„åŽ»é‡è¡Œä¸º
2. **æ•°æ®ç±»åž‹**ï¼šæ•°å€¼ç±»åž‹åŽ»é‡æ¯”å­—ç¬¦ä¸²ç±»åž‹å¿«
3. **æ€§èƒ½ç›‘æŽ§**ï¼šå®šæœŸæ£€æŸ¥åŽ»é‡æ€§èƒ½ï¼Œè¯†åˆ«ä¼˜åŒ–æœºä¼š
4. **æ•°æ®é‡**ï¼šæ ¹æ®æ•°æ®é‡é€‰æ‹©åŽ»é‡ç­–ç•¥

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢žå¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢žå¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡åŽ»é‡ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºŽåŒ…å«åŽ»é‡é”®çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºŽDISTINCT ONæŸ¥è¯¢å’ŒTop-NåŽ»é‡æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢žå¼º**ï¼š
   - å¯¹äºŽå¤§è§„æ¨¡åŽ»é‡è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºŽæ‰¹é‡åŽ»é‡å’Œå¤æ‚åŽ»é‡æ“ä½œ

3. **å¹¶è¡ŒæŸ¥è¯¢å¢žå¼º**ï¼š
   - åŽ»é‡æ“ä½œæ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨4.3èŠ‚è¯¦ç»†è¯´æ˜Žï¼‰
   - é€‚ç”¨äºŽå¤§è§„æ¨¡DISTINCTå’ŒGROUP BYåŽ»é‡

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–åŽ»é‡æŸ¥è¯¢**

```sql
-- ä¸ºåŽ»é‡é”®åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_dedup_keys_skip_scan
ON orders(customer_id, order_date DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªå®¢æˆ·æœ€æ–°çš„è®¢å•ï¼ˆDISTINCT ONä¼˜åŒ–ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (customer_id)
    customer_id,
    order_id,
    order_date,
    amount
FROM orders
ORDER BY customer_id, order_date DESC
LIMIT 100;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢žå¼ºï¼‰

**1. ä½¿ç”¨å”¯ä¸€ç´¢å¼•åŠ é€ŸåŽ»é‡**

å¯¹äºŽéœ€è¦åŽ»é‡çš„åˆ—ï¼Œåˆ›å»ºå”¯ä¸€ç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š

```sql
-- åˆ›å»ºå”¯ä¸€ç´¢å¼•åŠ é€ŸåŽ»é‡
CREATE UNIQUE INDEX IF NOT EXISTS idx_unique_customer_product
ON orders(customer_id, product_id);

-- ä½¿ç”¨å”¯ä¸€ç´¢å¼•åŠ é€ŸåŽ»é‡æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT customer_id, product_id
FROM orders
WHERE order_date >= CURRENT_DATE - INTERVAL '30 days';
```

**2. å¢žé‡åŽ»é‡ï¼šæµå¼æ•°æ®åŽ»é‡**

**å¢žé‡åŽ»é‡**ï¼šå¯¹äºŽæµå¼æ•°æ®ï¼Œä½¿ç”¨å¢žé‡æ–¹æ³•åŽ»é‡ã€‚

```sql
-- å¢žé‡åŽ»é‡ï¼šæµå¼æ•°æ®åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'deduplication_state') THEN
            CREATE TABLE deduplication_state (
                dedup_key VARCHAR(200) PRIMARY KEY,
                first_seen_at TIMESTAMPTZ NOT NULL,
                last_seen_at TIMESTAMPTZ NOT NULL,
                occurrence_count INTEGER DEFAULT 1
            );

            CREATE INDEX idx_deduplication_state_time ON deduplication_state(last_seen_at DESC);
            CREATE INDEX idx_deduplication_state_count ON deduplication_state(occurrence_count DESC);

            RAISE NOTICE 'åŽ»é‡çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢žé‡åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢žé‡åŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢žé‡åŽ»é‡ï¼šå®žæ—¶åŽ»é‡å¤„ç†
WITH new_records AS (
    SELECT
        customer_id || '|' || product_id AS dedup_key,
        order_date,
        order_id
    FROM orders
    WHERE order_date > (SELECT COALESCE(MAX(last_seen_at), '1970-01-01') FROM deduplication_state)
      AND order_date <= CURRENT_DATE
),
deduplicated_new AS (
    SELECT DISTINCT ON (dedup_key)
        dedup_key,
        MIN(order_date) OVER (PARTITION BY dedup_key) AS first_seen,
        MAX(order_date) OVER (PARTITION BY dedup_key) AS last_seen,
        COUNT(*) OVER (PARTITION BY dedup_key) AS occurrence_count
    FROM new_records
)
-- æ›´æ–°æˆ–æ’å…¥åŽ»é‡çŠ¶æ€
INSERT INTO deduplication_state (dedup_key, first_seen_at, last_seen_at, occurrence_count)
SELECT
    dedup_key,
    first_seen,
    last_seen,
    occurrence_count
FROM deduplicated_new
ON CONFLICT (dedup_key)
DO UPDATE SET
    last_seen_at = GREATEST(deduplication_state.last_seen_at, EXCLUDED.last_seen_at),
    occurrence_count = deduplication_state.occurrence_count + EXCLUDED.occurrence_count;
```

**3. æ™ºèƒ½åŽ»é‡ï¼šåŸºäºŽæ—¶é—´çª—å£çš„åŽ»é‡**

**æ™ºèƒ½åŽ»é‡**ï¼šåŸºäºŽæ—¶é—´çª—å£è¿›è¡Œæ™ºèƒ½åŽ»é‡ã€‚

```sql
-- æ™ºèƒ½åŽ»é‡ï¼šåŸºäºŽæ—¶é—´çª—å£çš„åŽ»é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_sessions') THEN
            CREATE TABLE user_sessions (
                session_id SERIAL PRIMARY KEY,
                user_id INTEGER NOT NULL,
                session_start TIMESTAMPTZ NOT NULL,
                session_end TIMESTAMPTZ,
                is_active BOOLEAN DEFAULT true
            );

            CREATE INDEX idx_user_sessions_user_time ON user_sessions(user_id, session_start DESC);
            CREATE INDEX idx_user_sessions_active ON user_sessions(is_active) WHERE is_active = true;

            RAISE NOTICE 'ç”¨æˆ·ä¼šè¯è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ™ºèƒ½åŽ»é‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½åŽ»é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ™ºèƒ½åŽ»é‡ï¼šåˆå¹¶é‡å æ—¶é—´çª—å£çš„ä¼šè¯
WITH session_windows AS (
    SELECT
        user_id,
        session_start,
        COALESCE(session_end, session_start + INTERVAL '30 minutes') AS session_end,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ä¼šè¯é‡å ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        LAG(session_end) OVER (PARTITION BY user_id ORDER BY session_start) AS prev_session_end
    FROM user_sessions
    WHERE is_active = true
),
merged_sessions AS (
    SELECT
        user_id,
        -- åˆå¹¶é‡å ä¼šè¯ï¼šå¦‚æžœå½“å‰ä¼šè¯å¼€å§‹æ—¶é—´ <= ä¸Šä¸€ä¸ªä¼šè¯ç»“æŸæ—¶é—´ + 5åˆ†é’Ÿï¼Œåˆ™åˆå¹¶
        CASE
            WHEN prev_session_end IS NOT NULL AND session_start <= prev_session_end + INTERVAL '5 minutes' THEN
                prev_session_end
            ELSE
                session_start
        END AS merged_start,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—åˆå¹¶åŽçš„ç»“æŸæ—¶é—´ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        MAX(session_end) OVER (
            PARTITION BY user_id,
            CASE
                WHEN prev_session_end IS NOT NULL AND session_start <= prev_session_end + INTERVAL '5 minutes' THEN
                    prev_session_end
                ELSE
                    session_start
            END
        ) AS merged_end
    FROM session_windows
)
SELECT DISTINCT ON (user_id, merged_start)
    user_id,
    merged_start AS session_start,
    merged_end AS session_end,
    EXTRACT(EPOCH FROM (merged_end - merged_start)) / 60 AS session_duration_minutes
FROM merged_sessions
ORDER BY user_id, merged_start, merged_end DESC
LIMIT 100;
```

---

## ðŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹ï¼ˆDatabase System Conceptsï¼‰- æŸ¥è¯¢ä¼˜åŒ–å’ŒåŽ»é‡
- ã€ŠSQLæƒå¨æŒ‡å—ã€‹ï¼ˆSQL: The Complete Referenceï¼‰- DISTINCTå’ŒGROUP BY

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [SELECT DISTINCT](https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT)
- [DISTINCT ON](https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT)
- [æŸ¥è¯¢è§„åˆ’å™¨](https://www.postgresql.org/docs/current/planner-optimizer.html)

### åœ¨çº¿èµ„æº

- PostgreSQLæ€§èƒ½ä¼˜åŒ–æŒ‡å—
- åŽ»é‡ç®—æ³•æœ€ä½³å®žè·µ
- æ•°æ®æ¸…æ´—æŠ€æœ¯

### ç›¸å…³ç®—æ³•

- [æŽ’åºç®—æ³•](./æŽ’åºç®—æ³•.md) - DISTINCTéœ€è¦æŽ’åº
- [åˆ†ç»„ç®—æ³•](./åˆ†ç»„ç®—æ³•.md) - GROUP BYåŽ»é‡
- [æ•°æ®æ¸…æ´—ç®—æ³•](../12-æ•°æ®è´¨é‡ç®—æ³•/æ•°æ®æ¸…æ´—ç®—æ³•.md) - æ•°æ®æ¸…æ´—ä¸­çš„åŽ»é‡

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
