# PostgreSQL é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | é£é™©è¯„ä¼° | é£é™©åº¦é‡
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [é£é™©è¯„ä¼°æ¦‚è¿°](#é£é™©è¯„ä¼°æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [é£é™©è¯„ä¼°é—®é¢˜å®šä¹‰](#é£é™©è¯„ä¼°é—®é¢˜å®šä¹‰)
      - [é£é™©åº¦é‡æ–¹æ³•åˆ†ç±»](#é£é™©åº¦é‡æ–¹æ³•åˆ†ç±»)
      - [é£é™©åº¦é‡é€‰æ‹©ç­–ç•¥](#é£é™©åº¦é‡é€‰æ‹©ç­–ç•¥)
    - [æ ¸å¿ƒé£é™©æŒ‡æ ‡](#æ ¸å¿ƒé£é™©æŒ‡æ ‡)
  - [1. æ³¢åŠ¨ç‡è®¡ç®—](#1-æ³¢åŠ¨ç‡è®¡ç®—)
    - [1.1 æ³¢åŠ¨ç‡è®¡ç®—åŸç†](#11-æ³¢åŠ¨ç‡è®¡ç®—åŸç†)
      - [æ³¢åŠ¨ç‡å®šä¹‰](#æ³¢åŠ¨ç‡å®šä¹‰)
      - [æ³¢åŠ¨ç‡è®¡ç®—æ–¹æ³•](#æ³¢åŠ¨ç‡è®¡ç®—æ–¹æ³•)
    - [1.2 å†å²æ³¢åŠ¨ç‡å®ç°](#12-å†å²æ³¢åŠ¨ç‡å®ç°)
    - [1.3 æ»šåŠ¨æ³¢åŠ¨ç‡](#13-æ»šåŠ¨æ³¢åŠ¨ç‡)
    - [1.4 æ¡ä»¶æ³¢åŠ¨ç‡](#14-æ¡ä»¶æ³¢åŠ¨ç‡)
  - [2. VaRè®¡ç®—](#2-varè®¡ç®—)
    - [2.1 VaRè®¡ç®—åŸç†](#21-varè®¡ç®—åŸç†)
      - [VaRå®šä¹‰](#varå®šä¹‰)
      - [VaRè®¡ç®—æ–¹æ³•](#varè®¡ç®—æ–¹æ³•)
    - [2.2 å†å²æ¨¡æ‹Ÿæ³•VaRå®ç°](#22-å†å²æ¨¡æ‹Ÿæ³•varå®ç°)
    - [2.3 å‚æ•°æ³•VaR](#23-å‚æ•°æ³•var)
    - [2.4 è’™ç‰¹å¡æ´›VaR](#24-è’™ç‰¹å¡æ´›var)
  - [3. é£é™©æŒ‡æ ‡](#3-é£é™©æŒ‡æ ‡)
    - [3.1 æœ€å¤§å›æ’¤åŸç†](#31-æœ€å¤§å›æ’¤åŸç†)
      - [æœ€å¤§å›æ’¤å®šä¹‰](#æœ€å¤§å›æ’¤å®šä¹‰)
      - [å›æ’¤è®¡ç®—æ–¹æ³•](#å›æ’¤è®¡ç®—æ–¹æ³•)
    - [3.2 æœ€å¤§å›æ’¤å®ç°](#32-æœ€å¤§å›æ’¤å®ç°)
    - [3.3 å¤æ™®æ¯”ç‡åŸç†](#33-å¤æ™®æ¯”ç‡åŸç†)
      - [å¤æ™®æ¯”ç‡å®šä¹‰](#å¤æ™®æ¯”ç‡å®šä¹‰)
      - [å¤æ™®æ¯”ç‡å…¬å¼](#å¤æ™®æ¯”ç‡å…¬å¼)
    - [3.4 å¤æ™®æ¯”ç‡å®ç°](#34-å¤æ™®æ¯”ç‡å®ç°)
    - [3.5 å…¶ä»–é£é™©æŒ‡æ ‡](#35-å…¶ä»–é£é™©æŒ‡æ ‡)
  - [4. é£é™©è¯„ä¼°ä¼˜åŒ–ç­–ç•¥](#4-é£é™©è¯„ä¼°ä¼˜åŒ–ç­–ç•¥)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 çª—å£å‡½æ•°ä¼˜åŒ–](#42-çª—å£å‡½æ•°ä¼˜åŒ–)
    - [4.3 æ‰¹é‡è®¡ç®—ä¼˜åŒ–](#43-æ‰¹é‡è®¡ç®—ä¼˜åŒ–)
  - [5. PostgreSQL 18 å¹¶è¡Œé£é™©è¯„ä¼°å¢å¼º](#5-postgresql-18-å¹¶è¡Œé£é™©è¯„ä¼°å¢å¼º)
    - [5.1 å¹¶è¡Œé£é™©è¯„ä¼°åŸç†](#51-å¹¶è¡Œé£é™©è¯„ä¼°åŸç†)
    - [5.2 å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—](#52-å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—)
    - [5.3 å¹¶è¡ŒVaRè®¡ç®—](#53-å¹¶è¡Œvarè®¡ç®—)
    - [5.4 å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—](#54-å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°](#51-æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°)
    - [5.2 é£é™©é™é¢ç›‘æ§](#52-é£é™©é™é¢ç›‘æ§)
    - [5.3 é£é™©å½’å› åˆ†æ](#53-é£é™©å½’å› åˆ†æ)
    - [5.4 é£é™©é¢„è­¦ç³»ç»Ÿ](#54-é£é™©é¢„è­¦ç³»ç»Ÿ)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 é£é™©åº¦é‡æ–¹æ³•å¯¹æ¯”](#61-é£é™©åº¦é‡æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [7.1 é£é™©åº¦é‡é€‰æ‹©](#71-é£é™©åº¦é‡é€‰æ‹©)
    - [7.2 å‚æ•°è®¾ç½®](#72-å‚æ•°è®¾ç½®)
    - [7.3 æ•°æ®è´¨é‡](#73-æ•°æ®è´¨é‡)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## é£é™©è¯„ä¼°æ¦‚è¿°

**é£é™©è¯„ä¼°ï¼ˆRisk Assessmentï¼‰**ç”¨äºé‡åŒ–æŠ•èµ„é£é™©ï¼Œæ˜¯é‡‘èé£é™©ç®¡ç†å’ŒæŠ•èµ„å†³ç­–çš„æ ¸å¿ƒå·¥å…·ã€‚

### ç†è®ºåŸºç¡€

#### é£é™©è¯„ä¼°é—®é¢˜å®šä¹‰

**é£é™©è¯„ä¼°é—®é¢˜**ï¼šç»™å®šæ”¶ç›Šç‡åºåˆ—$R = \{r_1, r_2, \ldots, r_T\}$ï¼Œè®¡ç®—é£é™©åº¦é‡$\rho(R)$ï¼š
$$\rho(R) = f(R)$$

å…¶ä¸­$f$æ˜¯é£é™©åº¦é‡å‡½æ•°ã€‚

#### é£é™©åº¦é‡æ–¹æ³•åˆ†ç±»

é£é™©åº¦é‡æ–¹æ³•åˆ†ç±»ï¼š

1. **æ³¢åŠ¨ç‡ï¼ˆVolatilityï¼‰**ï¼š
   - å†å²æ³¢åŠ¨ç‡ï¼š$\sigma = \sqrt{\text{Var}(r)}$
   - æ»šåŠ¨æ³¢åŠ¨ç‡ï¼šä½¿ç”¨æ»šåŠ¨çª—å£
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

2. **VaRï¼ˆValue at Riskï¼‰**ï¼š
   - å†å²æ¨¡æ‹Ÿæ³•ï¼šåŸºäºå†å²åˆ†ä½æ•°
   - å‚æ•°æ³•ï¼šåŸºäºåˆ†å¸ƒå‡è®¾
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$

3. **æœ€å¤§å›æ’¤ï¼ˆMaximum Drawdownï¼‰**ï¼š
   - å®šä¹‰ï¼š$\text{MDD} = \max_{t} \frac{\text{Peak}_t - \text{Price}_t}{\text{Peak}_t}$
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

4. **é£é™©è°ƒæ•´æ”¶ç›Š**ï¼š
   - å¤æ™®æ¯”ç‡ï¼š$\text{Sharpe} = \frac{R - R_f}{\sigma}$
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

#### é£é™©åº¦é‡é€‰æ‹©ç­–ç•¥

é€‰æ‹©é£é™©åº¦é‡çš„è€ƒè™‘å› ç´ ï¼š

1. **é£é™©ç±»å‹**ï¼šå¸‚åœºé£é™©ç”¨æ³¢åŠ¨ç‡ï¼Œæç«¯é£é™©ç”¨VaR
2. **æ—¶é—´èŒƒå›´**ï¼šçŸ­æœŸç”¨æ³¢åŠ¨ç‡ï¼Œé•¿æœŸç”¨æœ€å¤§å›æ’¤
3. **æ•°æ®è¦æ±‚**ï¼šå†å²æ•°æ®ç”¨å†å²æ¨¡æ‹Ÿï¼Œåˆ†å¸ƒå·²çŸ¥ç”¨å‚æ•°æ³•

### æ ¸å¿ƒé£é™©æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å­¦å®šä¹‰ | å…¬å¼ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|-----------|---------|
| **æ³¢åŠ¨ç‡** | $\sigma = \sqrt{\text{Var}(r)}$ | $\sqrt{\text{Var}(r)}$ | è¡¡é‡ä»·æ ¼æ³¢åŠ¨ç¨‹åº¦ | $O(n)$ | å¸‚åœºé£é™© |
| **VaR** | $P(\text{Loss} > \text{VaR}) = \alpha$ | åˆ†ä½æ•° | åœ¨é™©ä»·å€¼ | $O(n \log n)$ | æç«¯é£é™© |
| **æœ€å¤§å›æ’¤** | $\max_{t} \frac{\text{Peak}_t - \text{Price}_t}{\text{Peak}_t}$ | $\max(\text{Peak} - \text{Trough})$ | æœ€å¤§æŸå¤±å¹…åº¦ | $O(n)$ | ä¸‹è¡Œé£é™© |
| **å¤æ™®æ¯”ç‡** | $\frac{R - R_f}{\sigma}$ | $(R - R_f) / \sigma$ | é£é™©è°ƒæ•´æ”¶ç›Š | $O(n)$ | æ”¶ç›Šé£é™©æ¯” |

---

## 1. æ³¢åŠ¨ç‡è®¡ç®—

### 1.1 æ³¢åŠ¨ç‡è®¡ç®—åŸç†

**æ³¢åŠ¨ç‡ï¼ˆVolatilityï¼‰**æ˜¯è¡¡é‡èµ„äº§ä»·æ ¼æ³¢åŠ¨ç¨‹åº¦çš„æŒ‡æ ‡ã€‚

#### æ³¢åŠ¨ç‡å®šä¹‰

**æ³¢åŠ¨ç‡**ï¼šæ”¶ç›Šç‡çš„æ ‡å‡†å·®ï¼š
$$\sigma = \sqrt{\text{Var}(r)} = \sqrt{\frac{1}{n-1}\sum_{i=1}^{n}(r_i - \bar{r})^2}$$

**å¹´åŒ–æ³¢åŠ¨ç‡**ï¼šå°†æ—¥æ³¢åŠ¨ç‡å¹´åŒ–ï¼š
$$\sigma_{annual} = \sigma_{daily} \times \sqrt{252}$$

#### æ³¢åŠ¨ç‡è®¡ç®—æ–¹æ³•

**è®¡ç®—æ–¹æ³•**ï¼š

1. **å†å²æ³¢åŠ¨ç‡**ï¼šåŸºäºå†å²æ”¶ç›Šç‡è®¡ç®—
2. **æ»šåŠ¨æ³¢åŠ¨ç‡**ï¼šä½¿ç”¨æ»šåŠ¨çª—å£è®¡ç®—
3. **æ¡ä»¶æ³¢åŠ¨ç‡**ï¼šè€ƒè™‘æ¡ä»¶å¼‚æ–¹å·®ï¼ˆéœ€è¦GARCHæ¨¡å‹ï¼‰

### 1.2 å†å²æ³¢åŠ¨ç‡å®ç°

**å†å²æ³¢åŠ¨ç‡**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºæ”¶ç›Šç‡æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE returns_data CASCADE;
        END IF;

        CREATE TABLE returns_data (
            date DATE NOT NULL,
            symbol VARCHAR(10) NOT NULL,
            return_rate NUMERIC(10, 6) NOT NULL,
            PRIMARY KEY (date, symbol)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO returns_data (date, symbol, return_rate) VALUES
            ('2024-01-01', 'AAPL', 0.02), ('2024-01-02', 'AAPL', -0.01),
            ('2024-01-03', 'AAPL', 0.015), ('2024-01-04', 'AAPL', -0.005),
            ('2024-01-05', 'AAPL', 0.01), ('2024-01-01', 'GOOGL', 0.01),
            ('2024-01-02', 'GOOGL', 0.02), ('2024-01-03', 'GOOGL', -0.015),
            ('2024-01-04', 'GOOGL', 0.005), ('2024-01-05', 'GOOGL', 0.01);

        RAISE NOTICE 'è¡¨ returns_data åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥10æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ returns_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—å†å²æ³¢åŠ¨ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ³¢åŠ¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å†å²æ³¢åŠ¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ³¢åŠ¨ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æ—¥æ³¢åŠ¨ç‡å’Œå¹´åŒ–æ³¢åŠ¨ç‡
WITH volatility_stats AS (
    SELECT
        symbol,
        COUNT(*) AS trading_days,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        252.0 AS trading_days_per_year
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    trading_days,
    ROUND(mean_return::numeric, 6) AS mean_return,
    ROUND(std_return::numeric, 6) AS daily_volatility,
    ROUND((std_return * SQRT(trading_days_per_year))::numeric, 6) AS annualized_volatility,
    ROUND((std_return * SQRT(trading_days_per_year) * 100)::numeric, 2) AS annualized_volatility_pct
FROM volatility_stats
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    STDDEV(return_rate) AS daily_volatility
FROM returns_data
GROUP BY symbol;
```

---

### 1.3 æ»šåŠ¨æ³¢åŠ¨ç‡

**æ»šåŠ¨æ³¢åŠ¨ç‡**ï¼šä½¿ç”¨æ»šåŠ¨çª—å£è®¡ç®—æ³¢åŠ¨ç‡ã€‚

```sql
-- æ»šåŠ¨æ³¢åŠ¨ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ»šåŠ¨æ³¢åŠ¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æ»šåŠ¨æ³¢åŠ¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ»šåŠ¨æ³¢åŠ¨ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ»šåŠ¨æ³¢åŠ¨ç‡ï¼šä½¿ç”¨30æ—¥æ»šåŠ¨çª—å£
WITH rolling_volatility AS (
    SELECT
        date,
        symbol,
        return_rate,
        STDDEV(return_rate) OVER (
            PARTITION BY symbol
            ORDER BY date
            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
        ) AS rolling_volatility_30d,
        STDDEV(return_rate) OVER (
            PARTITION BY symbol
            ORDER BY date
            ROWS BETWEEN 59 PRECEDING AND CURRENT ROW
        ) AS rolling_volatility_60d
    FROM returns_data
)
SELECT
    date,
    symbol,
    return_rate,
    ROUND(rolling_volatility_30d::numeric, 6) AS vol_30d,
    ROUND((rolling_volatility_30d * SQRT(252))::numeric, 6) AS annualized_vol_30d,
    ROUND(rolling_volatility_60d::numeric, 6) AS vol_60d,
    ROUND((rolling_volatility_60d * SQRT(252))::numeric, 6) AS annualized_vol_60d
FROM rolling_volatility
WHERE rolling_volatility_30d IS NOT NULL
ORDER BY symbol, date;
```

### 1.4 æ¡ä»¶æ³¢åŠ¨ç‡

**æ¡ä»¶æ³¢åŠ¨ç‡**ï¼šè€ƒè™‘æ¡ä»¶å¼‚æ–¹å·®çš„æ³¢åŠ¨ç‡ï¼ˆç®€åŒ–ç‰ˆï¼‰ã€‚

```sql
-- æ¡ä»¶æ³¢åŠ¨ç‡ï¼ˆç®€åŒ–ç‰ˆï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'æ¡ä»¶æ³¢åŠ¨ç‡éœ€è¦GARCHæ¨¡å‹ï¼ŒPostgreSQLä¸­å®ç°å¤æ‚';
        -- å®é™…å®ç°éœ€è¦å¤–éƒ¨å·¥å…·æˆ–è‡ªå®šä¹‰å‡½æ•°
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¡ä»¶æ³¢åŠ¨ç‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. VaRè®¡ç®—

### 2.1 VaRè®¡ç®—åŸç†

**VaRï¼ˆValue at Riskï¼Œåœ¨é™©ä»·å€¼ï¼‰**è¡¡é‡åœ¨ç»™å®šç½®ä¿¡æ°´å¹³ä¸‹çš„æœ€å¤§å¯èƒ½æŸå¤±ã€‚

#### VaRå®šä¹‰

**VaR**ï¼šåœ¨ç½®ä¿¡æ°´å¹³$\alpha$ä¸‹ï¼Œæœªæ¥$T$æœŸçš„æœ€å¤§å¯èƒ½æŸå¤±ï¼š
$$P(\text{Loss} > \text{VaR}) = 1 - \alpha$$

**VaRå…¬å¼**ï¼š
$$\text{VaR}_\alpha = -F^{-1}(1 - \alpha)$$

å…¶ä¸­$F^{-1}$æ˜¯æŸå¤±åˆ†å¸ƒçš„åå‡½æ•°ã€‚

#### VaRè®¡ç®—æ–¹æ³•

**è®¡ç®—æ–¹æ³•**ï¼š

1. **å†å²æ¨¡æ‹Ÿæ³•**ï¼šåŸºäºå†å²åˆ†ä½æ•°
2. **å‚æ•°æ³•**ï¼šåŸºäºåˆ†å¸ƒå‡è®¾ï¼ˆå¦‚æ­£æ€åˆ†å¸ƒï¼‰
3. **è’™ç‰¹å¡æ´›æ³•**ï¼šåŸºäºéšæœºæ¨¡æ‹Ÿ

### 2.2 å†å²æ¨¡æ‹Ÿæ³•VaRå®ç°

**å†å²æ¨¡æ‹Ÿæ³•VaR**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- VaRè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    confidence_level NUMERIC := 0.95;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—VaR';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—VaRï¼Œç½®ä¿¡æ°´å¹³: %', confidence_level;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'VaRè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å†å²æ¨¡æ‹Ÿæ³•VaR
WITH ranked_returns AS (
    SELECT
        symbol,
        return_rate,
        PERCENT_RANK() OVER (PARTITION BY symbol ORDER BY return_rate) AS percentile_rank
    FROM returns_data
),
var_calculation AS (
    SELECT
        symbol,
        return_rate AS var_value,
        percentile_rank
    FROM ranked_returns
    WHERE percentile_rank <= 0.05  -- 95%ç½®ä¿¡æ°´å¹³ï¼Œå–5%åˆ†ä½æ•°
    ORDER BY symbol, return_rate
    LIMIT 1000
)
SELECT
    symbol,
    MIN(var_value) AS var_95,
    ROUND((MIN(var_value) * 100)::numeric, 4) AS var_95_pct
FROM var_calculation
GROUP BY symbol
ORDER BY symbol;

-- ä½¿ç”¨PERCENTILE_CONTè®¡ç®—VaR
WITH var_percentiles AS (
    SELECT
        symbol,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_rate) AS var_95,
        PERCENTILE_CONT(0.01) WITHIN GROUP (ORDER BY return_rate) AS var_99
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND((var_95 * 100)::numeric, 4) AS var_95_pct,
    ROUND(var_99::numeric, 6) AS var_99,
    ROUND((var_99 * 100)::numeric, 4) AS var_99_pct
FROM var_percentiles
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_rate) AS var_95
FROM returns_data
GROUP BY symbol;
```

---

### 2.3 å‚æ•°æ³•VaR

**å‚æ•°æ³•VaR**ï¼šåŸºäºæ­£æ€åˆ†å¸ƒå‡è®¾çš„VaRã€‚

```sql
-- å‚æ•°æ³•VaRï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    confidence_level NUMERIC := 0.95;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å‚æ•°æ³•VaR';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å‚æ•°æ³•VaRï¼Œç½®ä¿¡æ°´å¹³: %', confidence_level;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‚æ•°æ³•VaRè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å‚æ•°æ³•VaRï¼šå‡è®¾æ”¶ç›Šç‡æœä»æ­£æ€åˆ†å¸ƒ
WITH return_stats AS (
    SELECT
        symbol,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        COUNT(*) AS n_obs
    FROM returns_data
    GROUP BY symbol
),
var_calculation AS (
    SELECT
        symbol,
        mean_return,
        std_return,
        -- VaR = -mean - z_score * stdï¼ˆæ­£æ€åˆ†å¸ƒï¼‰
        -(mean_return + ABS(NORMAL_INVERSE(confidence_level)) * std_return) AS var_95,
        -(mean_return + ABS(NORMAL_INVERSE(0.99)) * std_return) AS var_99
    FROM return_stats
    WHERE std_return IS NOT NULL
)
SELECT
    symbol,
    ROUND(mean_return::numeric, 6) AS mean_return,
    ROUND(std_return::numeric, 6) AS std_return,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND((var_95 * 100)::numeric, 4) AS var_95_pct,
    ROUND(var_99::numeric, 6) AS var_99,
    ROUND((var_99 * 100)::numeric, 4) AS var_99_pct
FROM var_calculation
ORDER BY symbol;
```

### 2.4 è’™ç‰¹å¡æ´›VaR

**è’™ç‰¹å¡æ´›VaR**ï¼šåŸºäºéšæœºæ¨¡æ‹Ÿçš„VaRï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰ã€‚

```sql
-- è’™ç‰¹å¡æ´›VaRï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'è’™ç‰¹å¡æ´›VaRéœ€è¦å¤§é‡éšæœºæ¨¡æ‹Ÿï¼ŒPostgreSQLä¸­å®ç°å¤æ‚';
        -- å®é™…å®ç°éœ€è¦å¤–éƒ¨å·¥å…·æˆ–è‡ªå®šä¹‰å‡½æ•°
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è’™ç‰¹å¡æ´›VaRå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. é£é™©æŒ‡æ ‡

### 3.1 æœ€å¤§å›æ’¤åŸç†

**æœ€å¤§å›æ’¤ï¼ˆMaximum Drawdownï¼‰**è¡¡é‡ä»å³°å€¼åˆ°è°·åº•çš„æœ€å¤§è·Œå¹…ã€‚

#### æœ€å¤§å›æ’¤å®šä¹‰

**æœ€å¤§å›æ’¤**ï¼šä»å†å²æœ€é«˜ç‚¹åˆ°æœ€ä½ç‚¹çš„æœ€å¤§è·Œå¹…ï¼š
$$\text{MDD} = \max_{t} \frac{\text{Peak}_t - \text{Price}_t}{\text{Peak}_t}$$

å…¶ä¸­$\text{Peak}_t$æ˜¯åˆ°æ—¶åˆ»$t$ä¸ºæ­¢çš„æœ€é«˜ä»·æ ¼ã€‚

#### å›æ’¤è®¡ç®—æ–¹æ³•

**è®¡ç®—æ–¹æ³•**ï¼š

1. **æ»šåŠ¨å³°å€¼**ï¼šè®¡ç®—æ»šåŠ¨æœ€é«˜ä»·
2. **å›æ’¤è®¡ç®—**ï¼šè®¡ç®—å½“å‰ä»·æ ¼ç›¸å¯¹äºå³°å€¼çš„å›æ’¤
3. **æœ€å¤§å›æ’¤**ï¼šå–æ‰€æœ‰å›æ’¤çš„æœ€å¤§å€¼

### 3.2 æœ€å¤§å›æ’¤å®ç°

**æœ€å¤§å›æ’¤**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æœ€å¤§å›æ’¤è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'stock_prices') THEN
            RAISE WARNING 'è¡¨ stock_prices ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE stock_prices (
                date DATE NOT NULL,
                symbol VARCHAR(10) NOT NULL,
                close_price NUMERIC(10, 2) NOT NULL,
                PRIMARY KEY (date, symbol)
            );

            INSERT INTO stock_prices (date, symbol, close_price) VALUES
                ('2024-01-01', 'AAPL', 150.00), ('2024-01-02', 'AAPL', 155.00),
                ('2024-01-03', 'AAPL', 152.00), ('2024-01-04', 'AAPL', 148.00),
                ('2024-01-05', 'AAPL', 151.00);

            RAISE NOTICE 'è¡¨ stock_prices åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ€å¤§å›æ’¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ€å¤§å›æ’¤è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æœ€å¤§å›æ’¤
WITH price_series AS (
    SELECT
        date,
        symbol,
        close_price,
        MAX(close_price) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_max,
        MIN(close_price) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS running_min_ahead
    FROM stock_prices
),
drawdowns AS (
    SELECT
        date,
        symbol,
        close_price,
        running_max,
        (close_price - running_max) / NULLIF(running_max, 0) AS drawdown
    FROM price_series
)
SELECT
    symbol,
    MIN(drawdown) AS max_drawdown,
    ROUND((MIN(drawdown) * 100)::numeric, 2) AS max_drawdown_pct,
    MIN(date) FILTER (WHERE drawdown = (SELECT MIN(drawdown) FROM drawdowns d2 WHERE d2.symbol = drawdowns.symbol)) AS drawdown_start_date
FROM drawdowns
GROUP BY symbol
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    MAX(close_price) OVER (PARTITION BY symbol ORDER BY date) AS running_max
FROM stock_prices
ORDER BY symbol, date;
```

### 3.3 å¤æ™®æ¯”ç‡åŸç†

**å¤æ™®æ¯”ç‡ï¼ˆSharpe Ratioï¼‰**è¡¡é‡é£é™©è°ƒæ•´åçš„æ”¶ç›Šã€‚

#### å¤æ™®æ¯”ç‡å®šä¹‰

**å¤æ™®æ¯”ç‡**ï¼šè¶…é¢æ”¶ç›Šä¸æ³¢åŠ¨ç‡çš„æ¯”å€¼ï¼š
$$\text{Sharpe} = \frac{R - R_f}{\sigma}$$

å…¶ä¸­ï¼š

- $R$ï¼šèµ„äº§æ”¶ç›Šç‡
- $R_f$ï¼šæ— é£é™©æ”¶ç›Šç‡
- $\sigma$ï¼šæ”¶ç›Šç‡æ ‡å‡†å·®

#### å¤æ™®æ¯”ç‡å…¬å¼

**å¹´åŒ–å¤æ™®æ¯”ç‡**ï¼š
$$\text{Sharpe}_{annual} = \frac{R_{annual} - R_{f,annual}}{\sigma_{annual}} = \frac{(R_{daily} - R_{f,daily}) \times 252}{\sigma_{daily} \times \sqrt{252}}$$

### 3.4 å¤æ™®æ¯”ç‡å®ç°

**å¤æ™®æ¯”ç‡**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- å¤æ™®æ¯”ç‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¤æ™®æ¯”ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å¤æ™®æ¯”ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤æ™®æ¯”ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å¤æ™®æ¯”ç‡
WITH return_stats AS (
    SELECT
        symbol,
        COUNT(*) AS trading_days,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        0.03 / 252.0 AS risk_free_rate_daily  -- å‡è®¾å¹´åŒ–æ— é£é™©åˆ©ç‡3%
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    trading_days,
    ROUND(mean_return::numeric, 6) AS mean_daily_return,
    ROUND(std_return::numeric, 6) AS daily_volatility,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0))::numeric, 4) AS daily_sharpe_ratio,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0) * SQRT(252.0))::numeric, 4) AS annualized_sharpe_ratio
FROM return_stats
ORDER BY annualized_sharpe_ratio DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS std_return
FROM returns_data
GROUP BY symbol;
```

---

### 3.5 å…¶ä»–é£é™©æŒ‡æ ‡

**å…¶ä»–é£é™©æŒ‡æ ‡**ï¼šç´¢æè¯ºæ¯”ç‡ã€å¡ç›æ¯”ç‡ç­‰ã€‚

```sql
-- ç´¢æè¯ºæ¯”ç‡ï¼ˆSortino Ratioï¼‰ï¼šåªè€ƒè™‘ä¸‹è¡Œé£é™©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç´¢æè¯ºæ¯”ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç´¢æè¯ºæ¯”ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢æè¯ºæ¯”ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç´¢æè¯ºæ¯”ç‡ï¼šåªè€ƒè™‘ä¸‹è¡Œæ³¢åŠ¨ç‡
WITH downside_returns AS (
    SELECT
        symbol,
        return_rate,
        CASE WHEN return_rate < 0 THEN return_rate ELSE 0 END AS downside_return
    FROM returns_data
),
return_stats AS (
    SELECT
        symbol,
        AVG(return_rate) AS mean_return,
        STDDEV(downside_return) AS downside_std,
        0.03 / 252.0 AS risk_free_rate_daily
    FROM downside_returns
    GROUP BY symbol
)
SELECT
    symbol,
    ROUND(mean_return::numeric, 6) AS mean_return,
    ROUND(downside_std::numeric, 6) AS downside_volatility,
    CASE
        WHEN downside_std = 0 THEN NULL
        ELSE ROUND(((mean_return - risk_free_rate_daily) / downside_std * SQRT(252.0))::numeric, 4)
    END AS sortino_ratio
FROM return_stats
ORDER BY sortino_ratio DESC NULLS LAST;
```

---

## 4. é£é™©è¯„ä¼°ä¼˜åŒ–ç­–ç•¥

### 4.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºé£é™©è¯„ä¼°æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ”¶ç›Šç‡è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_returns_data_date_symbol
        ON returns_data(date, symbol);

        CREATE INDEX IF NOT EXISTS idx_returns_data_symbol_date
        ON returns_data(symbol, date);

        RAISE NOTICE 'é£é™©è¯„ä¼°ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 çª—å£å‡½æ•°ä¼˜åŒ–

**çª—å£å‡½æ•°ä¼˜åŒ–**ï¼šä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–æ»šåŠ¨è®¡ç®—ã€‚

```sql
-- çª—å£å‡½æ•°ä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜é£é™©æŒ‡æ ‡
CREATE MATERIALIZED VIEW IF NOT EXISTS risk_metrics_cache AS
SELECT
    date,
    symbol,
    return_rate,
    STDDEV(return_rate) OVER (
        PARTITION BY symbol
        ORDER BY date
        ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
    ) AS rolling_volatility_30d
FROM returns_data;

CREATE INDEX IF NOT EXISTS idx_risk_metrics_cache_date_symbol
ON risk_metrics_cache(date, symbol);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY risk_metrics_cache;
```

### 4.3 æ‰¹é‡è®¡ç®—ä¼˜åŒ–

**æ‰¹é‡è®¡ç®—ä¼˜åŒ–**ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ€§èƒ½ã€‚

```sql
-- æ‰¹é‡è®¡ç®—ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '512MB';
        SET max_parallel_workers_per_gather = 4;
        RAISE NOTICE 'æ‰¹é‡è®¡ç®—ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡è®¡ç®—ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡Œé£é™©è¯„ä¼°å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œé£é™©è¯„ä¼°èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œæ³¢åŠ¨ç‡è®¡ç®—ã€VaRè®¡ç®—å’Œé£é™©æŒ‡æ ‡è®¡ç®—ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡é£é™©è¯„ä¼°çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œé£é™©è¯„ä¼°åŸç†

PostgreSQL 18 çš„å¹¶è¡Œé£é™©è¯„ä¼°é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æé‡‘èæ•°æ®
2. **å¹¶è¡Œç»Ÿè®¡è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—ç»Ÿè®¡é‡
3. **å¹¶è¡Œé£é™©æŒ‡æ ‡**ï¼šå¹¶è¡Œæ‰§è¡Œé£é™©æŒ‡æ ‡è®¡ç®—
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„è®¡ç®—ç»“æœ

### 5.2 å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ³¢åŠ¨ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå†å²æ³¢åŠ¨ç‡è®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS volatility,
    VARIANCE(return_rate) AS variance,
    COUNT(*) AS n_obs
FROM returns_data
GROUP BY symbol
ORDER BY volatility DESC;
```

### 5.3 å¹¶è¡ŒVaRè®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡ŒVaRè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    confidence_level NUMERIC := 0.95;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒVaRè®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒVaRè®¡ç®—ï¼Œç½®ä¿¡æ°´å¹³: %', confidence_level;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒVaRè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå†å²æ¨¡æ‹Ÿæ³•VaR
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH ranked_returns AS (
    SELECT
        symbol,
        return_rate,
        PERCENT_RANK() OVER (PARTITION BY symbol ORDER BY return_rate) AS percentile_rank
    FROM returns_data
),
var_calculation AS (
    SELECT
        symbol,
        PERCENTILE_CONT(1 - 0.95) WITHIN GROUP (ORDER BY return_rate) AS var_95,
        PERCENTILE_CONT(1 - 0.99) WITHIN GROUP (ORDER BY return_rate) AS var_99
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND(var_99::numeric, 6) AS var_99
FROM var_calculation
ORDER BY var_95;
```

### 5.4 å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œé£é™©æŒ‡æ ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæœ€å¤§å›æ’¤å’Œå¤æ™®æ¯”ç‡è®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH cumulative_returns AS (
    SELECT
        symbol,
        date,
        return_rate,
        SUM(return_rate) OVER (PARTITION BY symbol ORDER BY date) AS cumulative_return
    FROM returns_data
),
peak_values AS (
    SELECT
        symbol,
        date,
        cumulative_return,
        MAX(cumulative_return) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS peak_return
    FROM cumulative_returns
),
drawdowns AS (
    SELECT
        symbol,
        MAX((peak_return - cumulative_return) / NULLIF(peak_return, 0)) AS max_drawdown
    FROM peak_values
    GROUP BY symbol
),
return_stats AS (
    SELECT
        symbol,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return
    FROM returns_data
    GROUP BY symbol
)
SELECT
    rs.symbol,
    ROUND(rs.mean_return::numeric, 6) AS mean_return,
    ROUND(rs.std_return::numeric, 6) AS volatility,
    ROUND(dd.max_drawdown::numeric, 6) AS max_drawdown,
    ROUND((rs.mean_return / NULLIF(rs.std_return, 0))::numeric, 4) AS sharpe_ratio
FROM return_stats rs
JOIN drawdowns dd ON rs.symbol = dd.symbol
ORDER BY sharpe_ratio DESC;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°

**æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°**ç»¼åˆè¯„ä¼°å¤šèµ„äº§ç»„åˆçš„é£é™©ã€‚

```sql
-- æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'portfolio_weights') THEN
            RAISE WARNING 'è¡¨ portfolio_weights ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE portfolio_weights (
                symbol VARCHAR(10) PRIMARY KEY,
                weight NUMERIC(5, 4) NOT NULL CHECK (weight >= 0 AND weight <= 1)
            );

            INSERT INTO portfolio_weights (symbol, weight) VALUES
                ('AAPL', 0.4),
                ('GOOGL', 0.6);

            RAISE NOTICE 'è¡¨ portfolio_weights åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒæŠ•èµ„ç»„åˆé£é™©è¯„ä¼°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æŠ•èµ„ç»„åˆé£é™©æŒ‡æ ‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH portfolio_returns AS (
    SELECT
        rd.date,
        SUM(rd.return_rate * pw.weight) AS portfolio_return
    FROM returns_data rd
    JOIN portfolio_weights pw ON rd.symbol = pw.symbol
    GROUP BY rd.date
),
portfolio_stats AS (
    SELECT
        COUNT(*) AS trading_days,
        AVG(portfolio_return) AS mean_return,
        STDDEV(portfolio_return) AS std_return,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return) AS var_95,
        PERCENTILE_CONT(0.01) WITHIN GROUP (ORDER BY portfolio_return) AS var_99,
        0.03 / 252.0 AS risk_free_rate_daily
    FROM portfolio_returns
)
SELECT
    trading_days,
    ROUND(mean_return::numeric, 6) AS portfolio_mean_return,
    ROUND(std_return::numeric, 6) AS portfolio_volatility,
    ROUND((std_return * SQRT(252.0))::numeric, 6) AS annualized_volatility,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND(var_99::numeric, 6) AS var_99,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0) * SQRT(252.0))::numeric, 4) AS sharpe_ratio
FROM portfolio_stats;
```

### 5.2 é£é™©é™é¢ç›‘æ§

**é£é™©é™é¢ç›‘æ§**ï¼šç›‘æ§æŠ•èµ„ç»„åˆæ˜¯å¦è¶…è¿‡é£é™©é™é¢ã€‚

```sql
-- é£é™©é™é¢ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    max_var_limit NUMERIC := -0.05;  -- æœ€å¤§VaRé™åˆ¶ï¼š-5%
    max_volatility_limit NUMERIC := 0.20;  -- æœ€å¤§æ³¢åŠ¨ç‡é™åˆ¶ï¼š20%
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé£é™©é™é¢ç›‘æ§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé£é™©é™é¢ç›‘æ§ï¼ŒVaRé™åˆ¶: %, æ³¢åŠ¨ç‡é™åˆ¶: %', max_var_limit, max_volatility_limit;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©é™é¢ç›‘æ§å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é£é™©é™é¢ç›‘æ§ï¼šæ£€æŸ¥æ˜¯å¦è¶…è¿‡é£é™©é™é¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH portfolio_returns AS (
    SELECT
        rd.date,
        SUM(rd.return_rate * pw.weight) AS portfolio_return
    FROM returns_data rd
    JOIN portfolio_weights pw ON rd.symbol = pw.symbol
    GROUP BY rd.date
),
risk_metrics AS (
    SELECT
        STDDEV(portfolio_return) * SQRT(252.0) AS annualized_volatility,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return) AS var_95
    FROM portfolio_returns
)
SELECT
    annualized_volatility,
    var_95,
    CASE
        WHEN var_95 < max_var_limit THEN 'VaR Limit Exceeded'
        WHEN annualized_volatility > max_volatility_limit THEN 'Volatility Limit Exceeded'
        ELSE 'Within Limits'
    END AS risk_status,
    CASE
        WHEN var_95 < max_var_limit THEN ABS(var_95 - max_var_limit)
        WHEN annualized_volatility > max_volatility_limit THEN annualized_volatility - max_volatility_limit
        ELSE 0
    END AS excess_risk
FROM risk_metrics;
```

### 5.3 é£é™©å½’å› åˆ†æ

**é£é™©å½’å› åˆ†æ**ï¼šåˆ†ææŠ•èµ„ç»„åˆé£é™©çš„æ¥æºã€‚

```sql
-- é£é™©å½’å› åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé£é™©å½’å› åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé£é™©å½’å› åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©å½’å› åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é£é™©å½’å› åˆ†æï¼šåˆ†æå„èµ„äº§å¯¹ç»„åˆé£é™©çš„è´¡çŒ®
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH asset_stats AS (
    SELECT
        symbol,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        COUNT(*) AS n_obs
    FROM returns_data
    GROUP BY symbol
),
covariance_matrix AS (
    SELECT
        a1.symbol AS asset1,
        a2.symbol AS asset2,
        AVG((a1.return_rate - s1.mean_return) * (a2.return_rate - s2.mean_return)) AS covariance
    FROM returns_data a1
    JOIN returns_data a2 ON a1.date = a2.date
    JOIN asset_stats s1 ON a1.symbol = s1.symbol
    JOIN asset_stats s2 ON a2.symbol = s2.symbol
    GROUP BY a1.symbol, a2.symbol
),
portfolio_risk_contribution AS (
    SELECT
        pw.symbol,
        pw.weight,
        as_stats.std_return,
        -- é£é™©è´¡çŒ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        pw.weight * as_stats.std_return AS risk_contribution,
        pw.weight * as_stats.std_return / SUM(pw.weight * as_stats.std_return) OVER () AS risk_contribution_pct
    FROM portfolio_weights pw
    JOIN asset_stats as_stats ON pw.symbol = as_stats.symbol
)
SELECT
    symbol,
    weight,
    ROUND(std_return::numeric, 6) AS asset_volatility,
    ROUND(risk_contribution::numeric, 6) AS risk_contribution,
    ROUND((risk_contribution_pct * 100)::numeric, 2) AS risk_contribution_pct
FROM portfolio_risk_contribution
ORDER BY risk_contribution DESC;
```

### 5.4 é£é™©é¢„è­¦ç³»ç»Ÿ

**é£é™©é¢„è­¦ç³»ç»Ÿ**ï¼šå®æ—¶ç›‘æ§é£é™©æŒ‡æ ‡å¹¶å‘å‡ºé¢„è­¦ã€‚

```sql
-- é£é™©é¢„è­¦ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    var_warning_threshold NUMERIC := -0.03;  -- VaRé¢„è­¦é˜ˆå€¼ï¼š-3%
    volatility_warning_threshold NUMERIC := 0.15;  -- æ³¢åŠ¨ç‡é¢„è­¦é˜ˆå€¼ï¼š15%
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé£é™©é¢„è­¦';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé£é™©é¢„è­¦ï¼ŒVaRé¢„è­¦é˜ˆå€¼: %, æ³¢åŠ¨ç‡é¢„è­¦é˜ˆå€¼: %', var_warning_threshold, volatility_warning_threshold;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©é¢„è­¦å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é£é™©é¢„è­¦ç³»ç»Ÿï¼šå®æ—¶ç›‘æ§é£é™©æŒ‡æ ‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH recent_returns AS (
    SELECT
        date,
        symbol,
        return_rate
    FROM returns_data
    WHERE date >= CURRENT_DATE - INTERVAL '30 days'
),
portfolio_returns AS (
    SELECT
        rr.date,
        SUM(rr.return_rate * pw.weight) AS portfolio_return
    FROM recent_returns rr
    JOIN portfolio_weights pw ON rr.symbol = pw.symbol
    GROUP BY rr.date
),
current_risk_metrics AS (
    SELECT
        MAX(date) AS latest_date,
        STDDEV(portfolio_return) * SQRT(252.0) AS current_volatility,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return) AS current_var_95
    FROM portfolio_returns
)
SELECT
    latest_date,
    current_volatility,
    current_var_95,
    CASE
        WHEN current_var_95 < var_warning_threshold THEN 'HIGH RISK: VaR Exceeded'
        WHEN current_volatility > volatility_warning_threshold THEN 'WARNING: High Volatility'
        ELSE 'NORMAL'
    END AS risk_alert,
    CASE
        WHEN current_var_95 < var_warning_threshold THEN ABS(current_var_95 - var_warning_threshold)
        WHEN current_volatility > volatility_warning_threshold THEN current_volatility - volatility_warning_threshold
        ELSE 0
    END AS risk_excess
FROM current_risk_metrics;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 é£é™©åº¦é‡æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **æ³¢åŠ¨ç‡** | $\sigma = \sqrt{\text{Var}(r)}$ | $O(n)$ | $O(1)$ | å¸‚åœºé£é™© | ç®€å•ã€ç›´è§‚ | å‡è®¾æ­£æ€åˆ†å¸ƒ |
| **VaRï¼ˆå†å²æ¨¡æ‹Ÿï¼‰** | åˆ†ä½æ•° | $O(n \log n)$ | $O(n)$ | æç«¯é£é™© | æ— åˆ†å¸ƒå‡è®¾ | éœ€è¦å¤§é‡å†å²æ•°æ® |
| **VaRï¼ˆå‚æ•°æ³•ï¼‰** | åŸºäºåˆ†å¸ƒ | $O(n)$ | $O(1)$ | å¿«é€Ÿè®¡ç®— | å¿«é€Ÿ | éœ€è¦åˆ†å¸ƒå‡è®¾ |
| **æœ€å¤§å›æ’¤** | $\max(\text{Peak} - \text{Trough})$ | $O(n)$ | $O(1)$ | ä¸‹è¡Œé£é™© | ç›´è§‚ | ä¸é¢„æµ‹æœªæ¥ |
| **å¤æ™®æ¯”ç‡** | $\frac{R - R_f}{\sigma}$ | $O(n)$ | $O(1)$ | æ”¶ç›Šé£é™©æ¯” | ç»¼åˆæŒ‡æ ‡ | å‡è®¾æ­£æ€åˆ†å¸ƒ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨(date, symbol)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•

2. **çª—å£å‡½æ•°ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–æ»šåŠ¨è®¡ç®—
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ

3. **æ‰¹é‡å¤„ç†**ï¼š
   - æ‰¹é‡è®¡ç®—å¤šä¸ªèµ„äº§çš„é£é™©æŒ‡æ ‡
   - ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šVaRè®¡ç®—æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å‚æ•°æ³•ã€åˆ›å»ºç´¢å¼•ã€å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜2**ï¼šæ³¢åŠ¨ç‡ä¼°è®¡ä¸å‡†ç¡®

- **è§£å†³æ–¹æ¡ˆ**ï¼šé€‰æ‹©åˆé€‚çš„çª—å£ã€å¤„ç†å¼‚å¸¸å€¼ã€ä½¿ç”¨æ»šåŠ¨çª—å£

**é—®é¢˜3**ï¼šé£é™©æŒ‡æ ‡ä¸ä¸€è‡´

- **è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€è®¡ç®—æ–¹æ³•ã€æ ‡å‡†åŒ–å‚æ•°ã€å®šæœŸæ ¡å‡†

**é—®é¢˜4**ï¼šå®æ—¶ç›‘æ§æ€§èƒ½å·®

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ã€å¢é‡æ›´æ–°ã€ä¼˜åŒ–æŸ¥è¯¢

---

## 8. æœ€ä½³å®è·µ

### 7.1 é£é™©åº¦é‡é€‰æ‹©

1. **å¸‚åœºé£é™©**ï¼šä½¿ç”¨æ³¢åŠ¨ç‡
2. **æç«¯é£é™©**ï¼šä½¿ç”¨VaR
3. **ä¸‹è¡Œé£é™©**ï¼šä½¿ç”¨æœ€å¤§å›æ’¤
4. **æ”¶ç›Šé£é™©æ¯”**ï¼šä½¿ç”¨å¤æ™®æ¯”ç‡

### 7.2 å‚æ•°è®¾ç½®

1. **æ—¶é—´çª—å£**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ï¼ˆ30æ—¥ã€60æ—¥ã€252æ—¥ï¼‰
2. **ç½®ä¿¡æ°´å¹³**ï¼šå¸¸ç”¨95%æˆ–99%
3. **å¹´åŒ–å€æ•°**ï¼š252ä¸ªäº¤æ˜“æ—¥

### 7.3 æ•°æ®è´¨é‡

1. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ•°æ®å®Œæ•´
2. **å¼‚å¸¸å€¼å¤„ç†**ï¼šè¯†åˆ«å’Œå¤„ç†å¼‚å¸¸å€¼
3. **æ•°æ®æ›´æ–°**ï¼šå®šæœŸæ›´æ–°æ•°æ®

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **ç²¾åº¦æ§åˆ¶**ï¼šä½¿ç”¨NUMERICç±»å‹
2. **NULLå¤„ç†**ï¼šæ­£ç¡®å¤„ç†NULLå€¼
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•å’Œç‰©åŒ–è§†å›¾
4. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é”™è¯¯å¤„ç†é€»è¾‘

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡é£é™©è¯„ä¼°è®¡ç®—çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«é£é™©æŒ‡æ ‡çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Né£é™©èµ„äº§æŸ¥è¯¢å’Œé£é™©æ’åæŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡é£é™©è¯„ä¼°è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡VaRè®¡ç®—å’Œå¤šèµ„äº§é£é™©åˆ†æ

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - é£é™©è¯„ä¼°è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡é£é™©æŒ‡æ ‡è®¡ç®—å’Œæ‰¹é‡é£é™©åˆ†æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–é£é™©æ’åæŸ¥è¯¢**

```sql
-- ä¸ºé£é™©æŒ‡æ ‡åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_risk_metrics_skip_scan
ON risk_metrics(symbol, var_95 DESC, volatility DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾é£é™©æœ€é«˜çš„å‰10ä¸ªèµ„äº§
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    var_95,
    volatility,
    max_drawdown
FROM risk_metrics
WHERE calculation_date = CURRENT_DATE
ORDER BY var_95 DESC, volatility DESC
LIMIT 10;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜é£é™©æŒ‡æ ‡ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„é£é™©æŒ‡æ ‡ï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜é£é™©æŒ‡æ ‡ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS risk_metrics_cache AS
SELECT
    symbol,
    calculation_date,
    -- æ³¢åŠ¨ç‡
    STDDEV(daily_return) * SQRT(252) AS annualized_volatility,
    -- VaR (95%)
    PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY daily_return) AS var_95,
    -- CVaR (95%)
    AVG(daily_return) FILTER (WHERE daily_return <= PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY daily_return)) AS cvar_95,
    -- æœ€å¤§å›æ’¤
    MAX(cumulative_return) OVER (PARTITION BY symbol ORDER BY date) - cumulative_return AS max_drawdown,
    -- å¤æ™®æ¯”ç‡
    (AVG(daily_return) * 252 - 0.02) / NULLIF(STDDEV(daily_return) * SQRT(252), 0) AS sharpe_ratio
FROM stock_returns
WHERE calculation_date >= CURRENT_DATE - INTERVAL '252 days'
GROUP BY symbol, calculation_date;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_risk_metrics_cache_symbol_date ON risk_metrics_cache(symbol, calculation_date DESC);
CREATE INDEX idx_risk_metrics_cache_var ON risk_metrics_cache(var_95 DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY risk_metrics_cache;
```

**2. å®æ—¶é£é™©ç›‘æ§ï¼šå¢é‡é£é™©è®¡ç®—**

**å®æ—¶é£é™©ç›‘æ§**ï¼šä½¿ç”¨å¢é‡æ–¹æ³•å®æ—¶æ›´æ–°é£é™©æŒ‡æ ‡ã€‚

```sql
-- å®æ—¶é£é™©ç›‘æ§ï¼šå¢é‡é£é™©è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'risk_monitoring_state') THEN
            CREATE TABLE risk_monitoring_state (
                symbol VARCHAR(20) PRIMARY KEY,
                last_calculation_date DATE NOT NULL,
                rolling_volatility NUMERIC,
                rolling_var_95 NUMERIC,
                last_updated TIMESTAMPTZ DEFAULT NOW()
            );

            RAISE NOTICE 'é£é™©ç›‘æ§çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡é£é™©è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡é£é™©è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°é£é™©æŒ‡æ ‡
WITH new_returns AS (
    SELECT
        symbol,
        daily_return,
        date
    FROM stock_returns
    WHERE date > (SELECT COALESCE(MAX(last_calculation_date), '1970-01-01') FROM risk_monitoring_state)
),
updated_risk_metrics AS (
    SELECT
        nr.symbol,
        MAX(nr.date) AS last_calculation_date,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ»šåŠ¨æ³¢åŠ¨ç‡ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        STDDEV(nr.daily_return) OVER (PARTITION BY nr.symbol ORDER BY nr.date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) * SQRT(252) AS rolling_volatility,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ»šåŠ¨VaR
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY nr.daily_return) OVER (PARTITION BY nr.symbol ORDER BY nr.date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) AS rolling_var_95
    FROM new_returns nr
)
-- æ›´æ–°æˆ–æ’å…¥é£é™©ç›‘æ§çŠ¶æ€
INSERT INTO risk_monitoring_state (symbol, last_calculation_date, rolling_volatility, rolling_var_95, last_updated)
SELECT DISTINCT ON (symbol)
    symbol,
    last_calculation_date,
    rolling_volatility,
    rolling_var_95,
    NOW()
FROM updated_risk_metrics
ON CONFLICT (symbol)
DO UPDATE SET
    last_calculation_date = EXCLUDED.last_calculation_date,
    rolling_volatility = EXCLUDED.rolling_volatility,
    rolling_var_95 = EXCLUDED.rolling_var_95,
    last_updated = NOW();
```

**3. å‹åŠ›æµ‹è¯•ï¼šæç«¯æƒ…æ™¯é£é™©åˆ†æ**

**å‹åŠ›æµ‹è¯•**ï¼šåˆ†ææç«¯å¸‚åœºæƒ…æ™¯ä¸‹çš„é£é™©æš´éœ²ã€‚

```sql
-- å‹åŠ›æµ‹è¯•ï¼šæç«¯æƒ…æ™¯é£é™©åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'portfolio_positions') THEN
            CREATE TABLE portfolio_positions (
                position_id SERIAL PRIMARY KEY,
                symbol VARCHAR(20) NOT NULL,
                quantity NUMERIC NOT NULL,
                current_price NUMERIC NOT NULL,
                portfolio_value NUMERIC GENERATED ALWAYS AS (quantity * current_price) STORED
            );

            RAISE NOTICE 'æŠ•èµ„ç»„åˆæŒä»“è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‹åŠ›æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‹åŠ›æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å‹åŠ›æµ‹è¯•ï¼šæ¨¡æ‹Ÿæç«¯å¸‚åœºæƒ…æ™¯ä¸‹çš„æŠ•èµ„ç»„åˆæŸå¤±
WITH stress_scenarios AS (
    SELECT
        'Market Crash' AS scenario_name,
        0.20 AS market_decline_pct,  -- å¸‚åœºä¸‹è·Œ20%
        1.5 AS volatility_multiplier  -- æ³¢åŠ¨ç‡æ”¾å¤§1.5å€
    UNION ALL
    SELECT
        'Flash Crash' AS scenario_name,
        0.10 AS market_decline_pct,  -- å¸‚åœºä¸‹è·Œ10%
        2.0 AS volatility_multiplier  -- æ³¢åŠ¨ç‡æ”¾å¤§2å€
    UNION ALL
    SELECT
        'Bear Market' AS scenario_name,
        0.30 AS market_decline_pct,  -- å¸‚åœºä¸‹è·Œ30%
        1.2 AS volatility_multiplier  -- æ³¢åŠ¨ç‡æ”¾å¤§1.2å€
),
portfolio_stress_test AS (
    SELECT
        ss.scenario_name,
        pp.symbol,
        pp.quantity,
        pp.current_price,
        pp.portfolio_value AS current_value,
        -- è®¡ç®—å‹åŠ›æƒ…æ™¯ä¸‹çš„ä»·æ ¼
        pp.current_price * (1 - ss.market_decline_pct) AS stressed_price,
        -- è®¡ç®—å‹åŠ›æƒ…æ™¯ä¸‹çš„æŠ•èµ„ç»„åˆä»·å€¼
        pp.quantity * pp.current_price * (1 - ss.market_decline_pct) AS stressed_value,
        -- è®¡ç®—æŸå¤±
        pp.portfolio_value - (pp.quantity * pp.current_price * (1 - ss.market_decline_pct)) AS portfolio_loss,
        -- è®¡ç®—æŸå¤±ç™¾åˆ†æ¯”
        (pp.portfolio_value - (pp.quantity * pp.current_price * (1 - ss.market_decline_pct))) / NULLIF(pp.portfolio_value, 0) AS loss_pct
    FROM portfolio_positions pp
    CROSS JOIN stress_scenarios ss
)
SELECT
    scenario_name,
    symbol,
    ROUND(current_value::numeric, 2) AS current_value,
    ROUND(stressed_value::numeric, 2) AS stressed_value,
    ROUND(portfolio_loss::numeric, 2) AS portfolio_loss,
    ROUND(loss_pct::numeric * 100, 2) AS loss_pct,
    -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç´¯è®¡æŸå¤±
    SUM(portfolio_loss) OVER (PARTITION BY scenario_name ORDER BY portfolio_loss DESC) AS cumulative_loss
FROM portfolio_stress_test
ORDER BY scenario_name, portfolio_loss DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šé£é™©ç®¡ç†ä¸é‡‘èæœºæ„ã€‹ï¼ˆRisk Management and Financial Institutionsï¼‰- é£é™©ç®¡ç†ç†è®º
- ã€Šé‡‘èé£é™©ç®¡ç†ã€‹ï¼ˆFinancial Risk Managementï¼‰- VaRè®¡ç®—æ–¹æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)
- [èšåˆå‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html)
- [ç»Ÿè®¡å‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-STATISTICS-TABLE)

### åœ¨çº¿èµ„æº

- PostgreSQLé‡‘èé£é™©è®¡ç®—æŒ‡å—
- VaRè®¡ç®—æ–¹æ³•è¯¦è§£
- é£é™©ç®¡ç†æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [æ”¶ç›Šç‡è®¡ç®—](./æ”¶ç›Šç‡è®¡ç®—.md) - æ”¶ç›Šç‡è®¡ç®—
- [æŠ•èµ„ç»„åˆä¼˜åŒ–](./æŠ•èµ„ç»„åˆä¼˜åŒ–.md) - æŠ•èµ„ç»„åˆä¼˜åŒ–
- [é‡‘èæ—¶é—´åºåˆ—åˆ†æ](./é‡‘èæ—¶é—´åºåˆ—åˆ†æ.md) - æ—¶é—´åºåˆ—åˆ†æ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
