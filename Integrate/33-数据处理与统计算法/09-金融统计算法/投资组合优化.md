# PostgreSQL æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æŠ•èµ„ç»„åˆ | ä¼˜åŒ–ç®—æ³•
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—](#postgresql-æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°](#æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°)
    - [æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•](#æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•)
  - [1. å‡å€¼-æ–¹å·®ä¼˜åŒ–](#1-å‡å€¼-æ–¹å·®ä¼˜åŒ–)
    - [1.1 æœ‰æ•ˆå‰æ²¿è®¡ç®—](#11-æœ‰æ•ˆå‰æ²¿è®¡ç®—)
  - [2. é£é™©å¹³ä»·](#2-é£é™©å¹³ä»·)
    - [2.1 é£é™©å¹³ä»·æƒé‡](#21-é£é™©å¹³ä»·æƒé‡)
  - [3. æœ€å°æ–¹å·®ç»„åˆ](#3-æœ€å°æ–¹å·®ç»„åˆ)
    - [3.1 æœ€å°æ–¹å·®æƒé‡](#31-æœ€å°æ–¹å·®æƒé‡)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 å¤šèµ„äº§ç»„åˆä¼˜åŒ–](#41-å¤šèµ„äº§ç»„åˆä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°

**æŠ•èµ„ç»„åˆä¼˜åŒ–**é€šè¿‡æ•°å­¦æ–¹æ³•æ‰¾åˆ°æœ€ä¼˜èµ„äº§é…ç½®ï¼Œå¹³è¡¡æ”¶ç›Šå’Œé£é™©ã€‚

### æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•

| æ–¹æ³• | ç›®æ ‡ | å¤æ‚åº¦ |
|------|------|--------|
| **å‡å€¼-æ–¹å·®** | æœ€å¤§åŒ–å¤æ™®æ¯”ç‡ | O(nÂ³) |
| **é£é™©å¹³ä»·** | ç­‰é£é™©è´¡çŒ® | O(nÂ²) |
| **æœ€å°æ–¹å·®** | æœ€å°åŒ–ç»„åˆæ–¹å·® | O(nÂ³) |

---

## 1. å‡å€¼-æ–¹å·®ä¼˜åŒ–

### 1.1 æœ‰æ•ˆå‰æ²¿è®¡ç®—

**æœ‰æ•ˆå‰æ²¿**å±•ç¤ºä¸åŒé£é™©æ°´å¹³ä¸‹çš„æœ€ä¼˜æ”¶ç›Šã€‚

```sql
-- åˆ›å»ºèµ„äº§æ”¶ç›Šç‡æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE asset_returns CASCADE;
        END IF;

        CREATE TABLE asset_returns (
            date DATE NOT NULL,
            asset VARCHAR(10) NOT NULL,
            return_rate NUMERIC(10, 6) NOT NULL,
            PRIMARY KEY (date, asset)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO asset_returns (date, asset, return_rate) VALUES
            ('2024-01-01', 'A', 0.02), ('2024-01-02', 'A', -0.01),
            ('2024-01-03', 'A', 0.015), ('2024-01-01', 'B', 0.01),
            ('2024-01-02', 'B', 0.02), ('2024-01-03', 'B', -0.005),
            ('2024-01-01', 'C', 0.005), ('2024-01-02', 'C', 0.01),
            ('2024-01-03', 'C', 0.008);

        RAISE NOTICE 'è¡¨ asset_returns åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥9æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ asset_returns å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—èµ„äº§ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æœ‰æ•ˆå‰æ²¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ‰æ•ˆå‰æ²¿';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ‰æ•ˆå‰æ²¿è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—èµ„äº§å‡å€¼å’Œåæ–¹å·®çŸ©é˜µ
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        COUNT(*) AS n_obs
    FROM asset_returns
    GROUP BY asset
),
covariance_matrix AS (
    SELECT
        a1.asset AS asset1,
        a2.asset AS asset2,
        AVG((a1.return_rate - s1.mean_return) * (a2.return_rate - s2.mean_return)) AS covariance
    FROM asset_returns a1
    JOIN asset_returns a2 ON a1.date = a2.date
    JOIN asset_stats s1 ON a1.asset = s1.asset
    JOIN asset_stats s2 ON a2.asset = s2.asset
    GROUP BY a1.asset, a2.asset
)
SELECT
    asset1,
    asset2,
    ROUND(covariance::numeric, 6) AS covariance,
    CASE
        WHEN asset1 = asset2 THEN ROUND(SQRT(covariance)::numeric, 6)
        ELSE NULL
    END AS volatility
FROM covariance_matrix
ORDER BY asset1, asset2;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS std_return
FROM asset_returns
GROUP BY asset;
```

---

## 2. é£é™©å¹³ä»·

### 2.1 é£é™©å¹³ä»·æƒé‡

**é£é™©å¹³ä»·**ä½¿å„èµ„äº§å¯¹ç»„åˆé£é™©çš„è´¡çŒ®ç›¸ç­‰ã€‚

```sql
-- é£é™©å¹³ä»·æƒé‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—é£é™©å¹³ä»·æƒé‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—é£é™©å¹³ä»·æƒé‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©å¹³ä»·è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—é£é™©å¹³ä»·æƒé‡ï¼ˆç®€åŒ–ç‰ˆï¼šåŸºäºæ³¢åŠ¨ç‡å€’æ•°ï¼‰
WITH asset_volatility AS (
    SELECT
        asset,
        STDDEV(return_rate) AS volatility
    FROM asset_returns
    GROUP BY asset
),
inverse_volatility AS (
    SELECT
        asset,
        volatility,
        1.0 / NULLIF(volatility, 0) AS inv_vol
    FROM asset_volatility
),
total_inv_vol AS (
    SELECT SUM(inv_vol) AS total_inv_vol
    FROM inverse_volatility
)
SELECT
    iv.asset,
    ROUND(iv.volatility::numeric, 6) AS volatility,
    ROUND((iv.inv_vol / tiv.total_inv_vol)::numeric, 4) AS risk_parity_weight
FROM inverse_volatility iv
CROSS JOIN total_inv_vol tiv
ORDER BY iv.asset;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    STDDEV(return_rate) AS volatility
FROM asset_returns
GROUP BY asset;
```

---

## 3. æœ€å°æ–¹å·®ç»„åˆ

### 3.1 æœ€å°æ–¹å·®æƒé‡

**æœ€å°æ–¹å·®ç»„åˆ**åœ¨ç»™å®šçº¦æŸä¸‹æœ€å°åŒ–ç»„åˆæ–¹å·®ã€‚

```sql
-- æœ€å°æ–¹å·®ç»„åˆè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æœ€å°æ–¹å·®ç»„åˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ€å°æ–¹å·®ç»„åˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ€å°æ–¹å·®ç»„åˆè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æœ€å°æ–¹å·®ç»„åˆï¼ˆç®€åŒ–ç‰ˆï¼šç­‰æƒé‡ä½œä¸ºåŸºå‡†ï¼‰
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        VARIANCE(return_rate) AS variance
    FROM asset_returns
    GROUP BY asset
),
equal_weight_portfolio AS (
    SELECT
        COUNT(*) AS n_assets,
        1.0 / COUNT(*) AS equal_weight
    FROM asset_stats
),
portfolio_variance AS (
    SELECT
        SUM(variance * ew.equal_weight * ew.equal_weight) AS portfolio_var
    FROM asset_stats
    CROSS JOIN equal_weight_portfolio ew
)
SELECT
    n_assets,
    ROUND(equal_weight::numeric, 4) AS equal_weight,
    ROUND(SQRT(portfolio_var)::numeric, 6) AS portfolio_volatility
FROM equal_weight_portfolio
CROSS JOIN portfolio_variance;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    VARIANCE(return_rate) AS variance
FROM asset_returns
GROUP BY asset;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 å¤šèµ„äº§ç»„åˆä¼˜åŒ–

**å¤šèµ„äº§ç»„åˆä¼˜åŒ–**ç»¼åˆè€ƒè™‘å¤šä¸ªèµ„äº§çš„æ”¶ç›Šå’Œé£é™©ã€‚

```sql
-- å¤šèµ„äº§ç»„åˆä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'optimization_results') THEN
            RAISE WARNING 'è¡¨ optimization_results ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE optimization_results (
                optimization_id SERIAL PRIMARY KEY,
                asset VARCHAR(10) NOT NULL,
                weight NUMERIC(5, 4) NOT NULL,
                expected_return NUMERIC(10, 6),
                portfolio_volatility NUMERIC(10, 6),
                sharpe_ratio NUMERIC(10, 4),
                created_at TIMESTAMP DEFAULT NOW()
            );

            RAISE NOTICE 'è¡¨ optimization_results åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šèµ„äº§ç»„åˆä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»„åˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ä¼˜åŒ–åçš„ç»„åˆæŒ‡æ ‡
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return
    FROM asset_returns
    GROUP BY asset
),
optimized_weights AS (
    SELECT
        asset,
        CASE asset
            WHEN 'A' THEN 0.3
            WHEN 'B' THEN 0.4
            WHEN 'C' THEN 0.3
        END AS weight
    FROM asset_stats
),
portfolio_stats AS (
    SELECT
        SUM(as_stats.mean_return * ow.weight) AS portfolio_return,
        SQRT(SUM(POWER(as_stats.std_return * ow.weight, 2))) AS portfolio_volatility,
        0.03 / 252.0 AS risk_free_rate
    FROM asset_stats as_stats
    JOIN optimized_weights ow ON as_stats.asset = ow.asset
)
SELECT
    ROUND(portfolio_return::numeric, 6) AS expected_return,
    ROUND(portfolio_volatility::numeric, 6) AS portfolio_volatility,
    ROUND(((portfolio_return - risk_free_rate) / NULLIF(portfolio_volatility, 0) * SQRT(252.0))::numeric, 4) AS sharpe_ratio
FROM portfolio_stats;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS std_return
FROM asset_returns
GROUP BY asset;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **çŸ©é˜µè¿ç®—**: ä½¿ç”¨æ•°ç»„ç±»å‹ä¼˜åŒ–çŸ©é˜µè®¡ç®—
2. **å¹¶è¡Œå¤„ç†**: åˆ©ç”¨PostgreSQLå¹¶è¡ŒæŸ¥è¯¢
3. **ç¼“å­˜ç»“æœ**: ç¼“å­˜åæ–¹å·®çŸ©é˜µç­‰ä¸­é—´ç»“æœ

## ğŸ¯ æœ€ä½³å®è·µ

1. **çº¦æŸæ¡ä»¶**: è®¾ç½®åˆç†çš„æƒé‡çº¦æŸ
2. **å†å¹³è¡¡**: å®šæœŸé‡æ–°ä¼˜åŒ–ç»„åˆ
3. **äº¤æ˜“æˆæœ¬**: è€ƒè™‘äº¤æ˜“æˆæœ¬çš„å½±å“
4. **å›æµ‹éªŒè¯**: ä½¿ç”¨å†å²æ•°æ®éªŒè¯ç­–ç•¥

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
