# PostgreSQL æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æŠ•èµ„ç»„åˆ | ä¼˜åŒ–ç®—æ³•
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—](#postgresql-æŠ•èµ„ç»„åˆä¼˜åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°](#æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æŠ•èµ„ç»„åˆä¼˜åŒ–é—®é¢˜å®šä¹‰](#æŠ•èµ„ç»„åˆä¼˜åŒ–é—®é¢˜å®šä¹‰)
      - [ä¼˜åŒ–æ–¹æ³•åˆ†ç±»](#ä¼˜åŒ–æ–¹æ³•åˆ†ç±»)
      - [ä¼˜åŒ–ç›®æ ‡é€‰æ‹©](#ä¼˜åŒ–ç›®æ ‡é€‰æ‹©)
    - [æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•](#æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•)
  - [1. å‡å€¼-æ–¹å·®ä¼˜åŒ–](#1-å‡å€¼-æ–¹å·®ä¼˜åŒ–)
    - [1.1 å‡å€¼-æ–¹å·®ä¼˜åŒ–åŸç†](#11-å‡å€¼-æ–¹å·®ä¼˜åŒ–åŸç†)
      - [Markowitzæ¨¡å‹](#markowitzæ¨¡å‹)
      - [æœ‰æ•ˆå‰æ²¿](#æœ‰æ•ˆå‰æ²¿)
    - [1.2 æœ‰æ•ˆå‰æ²¿è®¡ç®—å®ç°](#12-æœ‰æ•ˆå‰æ²¿è®¡ç®—å®ç°)
    - [1.3 æœ€ä¼˜ç»„åˆé€‰æ‹©](#13-æœ€ä¼˜ç»„åˆé€‰æ‹©)
  - [2. é£é™©å¹³ä»·](#2-é£é™©å¹³ä»·)
    - [2.1 é£é™©å¹³ä»·åŸç†](#21-é£é™©å¹³ä»·åŸç†)
      - [é£é™©å¹³ä»·å®šä¹‰](#é£é™©å¹³ä»·å®šä¹‰)
      - [é£é™©è´¡çŒ®](#é£é™©è´¡çŒ®)
    - [2.2 é£é™©å¹³ä»·æƒé‡å®ç°](#22-é£é™©å¹³ä»·æƒé‡å®ç°)
    - [2.3 é£é™©å¹³ä»·ä¼˜åŒ–](#23-é£é™©å¹³ä»·ä¼˜åŒ–)
  - [3. æœ€å°æ–¹å·®ç»„åˆ](#3-æœ€å°æ–¹å·®ç»„åˆ)
    - [3.1 æœ€å°æ–¹å·®ç»„åˆåŸç†](#31-æœ€å°æ–¹å·®ç»„åˆåŸç†)
      - [æœ€å°æ–¹å·®é—®é¢˜](#æœ€å°æ–¹å·®é—®é¢˜)
      - [ä¼˜åŒ–æ–¹æ³•](#ä¼˜åŒ–æ–¹æ³•)
    - [3.2 æœ€å°æ–¹å·®æƒé‡å®ç°](#32-æœ€å°æ–¹å·®æƒé‡å®ç°)
    - [3.3 çº¦æŸæœ€å°æ–¹å·®](#33-çº¦æŸæœ€å°æ–¹å·®)
  - [4. æŠ•èµ„ç»„åˆä¼˜åŒ–ç­–ç•¥](#4-æŠ•èµ„ç»„åˆä¼˜åŒ–ç­–ç•¥)
    - [4.1 åæ–¹å·®çŸ©é˜µä¼˜åŒ–](#41-åæ–¹å·®çŸ©é˜µä¼˜åŒ–)
    - [4.2 æƒé‡çº¦æŸä¼˜åŒ–](#42-æƒé‡çº¦æŸä¼˜åŒ–)
    - [4.3 æ€§èƒ½ä¼˜åŒ–](#43-æ€§èƒ½ä¼˜åŒ–)
  - [5. PostgreSQL 18 å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–å¢å¼º](#5-postgresql-18-å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–å¢å¼º)
    - [5.1 å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–åŸç†](#51-å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–åŸç†)
    - [5.2 å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–](#52-å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–)
    - [5.3 å¹¶è¡Œé£é™©å¹³ä»·](#53-å¹¶è¡Œé£é™©å¹³ä»·)
    - [5.4 å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆ](#54-å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆ)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 å¤šèµ„äº§ç»„åˆä¼˜åŒ–](#51-å¤šèµ„äº§ç»„åˆä¼˜åŒ–)
    - [5.2 åŠ¨æ€å†å¹³è¡¡ç­–ç•¥](#52-åŠ¨æ€å†å¹³è¡¡ç­–ç•¥)
    - [5.3 å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–](#53-å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–)
    - [5.4 é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–](#54-é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 ä¼˜åŒ–æ–¹æ³•å¯¹æ¯”](#61-ä¼˜åŒ–æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [7.1 ä¼˜åŒ–æ–¹æ³•é€‰æ‹©](#71-ä¼˜åŒ–æ–¹æ³•é€‰æ‹©)
    - [7.2 çº¦æŸæ¡ä»¶è®¾ç½®](#72-çº¦æŸæ¡ä»¶è®¾ç½®)
    - [7.3 å‚æ•°è°ƒä¼˜](#73-å‚æ•°è°ƒä¼˜)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨](#75-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨)
    - [7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§](#76-é«˜çº§ä¼˜åŒ–æŠ€å·§)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æŠ•èµ„ç»„åˆä¼˜åŒ–æ¦‚è¿°

**æŠ•èµ„ç»„åˆä¼˜åŒ–ï¼ˆPortfolio Optimizationï¼‰**é€šè¿‡æ•°å­¦æ–¹æ³•æ‰¾åˆ°æœ€ä¼˜èµ„äº§é…ç½®ï¼Œå¹³è¡¡æ”¶ç›Šå’Œé£é™©ï¼Œæ˜¯ç°ä»£æŠ•èµ„ç»„åˆç†è®ºçš„æ ¸å¿ƒã€‚

### ç†è®ºåŸºç¡€

#### æŠ•èµ„ç»„åˆä¼˜åŒ–é—®é¢˜å®šä¹‰

**æŠ•èµ„ç»„åˆä¼˜åŒ–é—®é¢˜**ï¼šç»™å®š$n$ä¸ªèµ„äº§ï¼Œæ‰¾åˆ°æƒé‡å‘é‡$\mathbf{w} = (w_1, w_2, \ldots, w_n)$ï¼Œä½¿å¾—ï¼š
$$\max_{\mathbf{w}} f(\mathbf{w}) \text{ subject to } \sum_{i=1}^{n} w_i = 1, w_i \geq 0$$

å…¶ä¸­$f(\mathbf{w})$æ˜¯ç›®æ ‡å‡½æ•°ï¼ˆå¦‚å¤æ™®æ¯”ç‡ã€æ”¶ç›Šã€é£é™©ç­‰ï¼‰ã€‚

#### ä¼˜åŒ–æ–¹æ³•åˆ†ç±»

æŠ•èµ„ç»„åˆä¼˜åŒ–æ–¹æ³•åˆ†ç±»ï¼š

1. **å‡å€¼-æ–¹å·®ä¼˜åŒ–ï¼ˆMarkowitzï¼‰**ï¼š
   - ç›®æ ‡ï¼šæœ€å¤§åŒ–å¤æ™®æ¯”ç‡
   - çº¦æŸï¼šæƒé‡å’Œä¸º1ï¼Œæƒé‡éè´Ÿ
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n^3)$

2. **é£é™©å¹³ä»·ï¼ˆRisk Parityï¼‰**ï¼š
   - ç›®æ ‡ï¼šç­‰é£é™©è´¡çŒ®
   - çº¦æŸï¼šæƒé‡å’Œä¸º1
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n^2)$

3. **æœ€å°æ–¹å·®ç»„åˆï¼ˆMinimum Varianceï¼‰**ï¼š
   - ç›®æ ‡ï¼šæœ€å°åŒ–ç»„åˆæ–¹å·®
   - çº¦æŸï¼šæƒé‡å’Œä¸º1ï¼Œæƒé‡éè´Ÿ
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n^3)$

#### ä¼˜åŒ–ç›®æ ‡é€‰æ‹©

é€‰æ‹©ä¼˜åŒ–ç›®æ ‡çš„è€ƒè™‘å› ç´ ï¼š

1. **é£é™©åå¥½**ï¼šé£é™©åŒæ¶ç”¨æœ€å°æ–¹å·®ï¼Œé£é™©ä¸­æ€§ç”¨å‡å€¼-æ–¹å·®
2. **å¸‚åœºç¯å¢ƒ**ï¼šç‰›å¸‚ç”¨å‡å€¼-æ–¹å·®ï¼Œç†Šå¸‚ç”¨æœ€å°æ–¹å·®
3. **èµ„äº§æ•°é‡**ï¼šå°‘èµ„äº§ç”¨å‡å€¼-æ–¹å·®ï¼Œå¤šèµ„äº§ç”¨é£é™©å¹³ä»·

### æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | ç›®æ ‡ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **å‡å€¼-æ–¹å·®** | $\max \frac{\mathbf{w}^T \boldsymbol{\mu} - R_f}{\sqrt{\mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}}}$ | æœ€å¤§åŒ–å¤æ™®æ¯”ç‡ | $O(n^3)$ | $O(n^2)$ | æ ‡å‡†ä¼˜åŒ– |
| **é£é™©å¹³ä»·** | $\min \sum_{i,j} (RC_i - RC_j)^2$ | ç­‰é£é™©è´¡çŒ® | $O(n^2)$ | $O(n^2)$ | å¤šèµ„äº§ç»„åˆ |
| **æœ€å°æ–¹å·®** | $\min \mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}$ | æœ€å°åŒ–ç»„åˆæ–¹å·® | $O(n^3)$ | $O(n^2)$ | é£é™©æœ€å°åŒ– |

---

## 1. å‡å€¼-æ–¹å·®ä¼˜åŒ–

### 1.1 å‡å€¼-æ–¹å·®ä¼˜åŒ–åŸç†

**å‡å€¼-æ–¹å·®ä¼˜åŒ–ï¼ˆMean-Variance Optimizationï¼‰**æ˜¯MarkowitzæŠ•èµ„ç»„åˆç†è®ºçš„æ ¸å¿ƒã€‚

#### Markowitzæ¨¡å‹

**Markowitzæ¨¡å‹**ï¼šåœ¨ç»™å®šé£é™©æ°´å¹³ä¸‹æœ€å¤§åŒ–æ”¶ç›Šï¼Œæˆ–åœ¨ç»™å®šæ”¶ç›Šæ°´å¹³ä¸‹æœ€å°åŒ–é£é™©ï¼š
$$\max_{\mathbf{w}} \mathbf{w}^T \boldsymbol{\mu} - \lambda \mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}$$

å…¶ä¸­ï¼š

- $\boldsymbol{\mu}$ï¼šæœŸæœ›æ”¶ç›Šç‡å‘é‡
- $\boldsymbol{\Sigma}$ï¼šåæ–¹å·®çŸ©é˜µ
- $\lambda$ï¼šé£é™©åŒæ¶ç³»æ•°

#### æœ‰æ•ˆå‰æ²¿

**æœ‰æ•ˆå‰æ²¿ï¼ˆEfficient Frontierï¼‰**ï¼šæ‰€æœ‰æœ‰æ•ˆæŠ•èµ„ç»„åˆçš„é›†åˆï¼Œå³åœ¨ç»™å®šé£é™©æ°´å¹³ä¸‹æ”¶ç›Šæœ€é«˜çš„ç»„åˆã€‚

### 1.2 æœ‰æ•ˆå‰æ²¿è®¡ç®—å®ç°

**æœ‰æ•ˆå‰æ²¿**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºèµ„äº§æ”¶ç›Šç‡æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE asset_returns CASCADE;
        END IF;

        CREATE TABLE asset_returns (
            date DATE NOT NULL,
            asset VARCHAR(10) NOT NULL,
            return_rate NUMERIC(10, 6) NOT NULL,
            PRIMARY KEY (date, asset)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO asset_returns (date, asset, return_rate) VALUES
            ('2024-01-01', 'A', 0.02), ('2024-01-02', 'A', -0.01),
            ('2024-01-03', 'A', 0.015), ('2024-01-01', 'B', 0.01),
            ('2024-01-02', 'B', 0.02), ('2024-01-03', 'B', -0.005),
            ('2024-01-01', 'C', 0.005), ('2024-01-02', 'C', 0.01),
            ('2024-01-03', 'C', 0.008);

        RAISE NOTICE 'è¡¨ asset_returns åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥9æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ asset_returns å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—èµ„äº§ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æœ‰æ•ˆå‰æ²¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ‰æ•ˆå‰æ²¿';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ‰æ•ˆå‰æ²¿è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—èµ„äº§å‡å€¼å’Œåæ–¹å·®çŸ©é˜µ
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        COUNT(*) AS n_obs
    FROM asset_returns
    GROUP BY asset
),
covariance_matrix AS (
    SELECT
        a1.asset AS asset1,
        a2.asset AS asset2,
        AVG((a1.return_rate - s1.mean_return) * (a2.return_rate - s2.mean_return)) AS covariance
    FROM asset_returns a1
    JOIN asset_returns a2 ON a1.date = a2.date
    JOIN asset_stats s1 ON a1.asset = s1.asset
    JOIN asset_stats s2 ON a2.asset = s2.asset
    GROUP BY a1.asset, a2.asset
)
SELECT
    asset1,
    asset2,
    ROUND(covariance::numeric, 6) AS covariance,
    CASE
        WHEN asset1 = asset2 THEN ROUND(SQRT(covariance)::numeric, 6)
        ELSE NULL
    END AS volatility
FROM covariance_matrix
ORDER BY asset1, asset2;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS std_return
FROM asset_returns
GROUP BY asset;
```

---

### 1.3 æœ€ä¼˜ç»„åˆé€‰æ‹©

**æœ€ä¼˜ç»„åˆé€‰æ‹©**ï¼šä»æœ‰æ•ˆå‰æ²¿ä¸­é€‰æ‹©æœ€ä¼˜ç»„åˆã€‚

```sql
-- æœ€ä¼˜ç»„åˆé€‰æ‹©ï¼šæœ€å¤§åŒ–å¤æ™®æ¯”ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    risk_free_rate NUMERIC := 0.03;  -- å¹´åŒ–æ— é£é™©åˆ©ç‡3%
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•é€‰æ‹©æœ€ä¼˜ç»„åˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹é€‰æ‹©æœ€ä¼˜ç»„åˆï¼Œæ— é£é™©åˆ©ç‡: %', risk_free_rate;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ€ä¼˜ç»„åˆé€‰æ‹©å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æœ€ä¼˜ç»„åˆé€‰æ‹©ï¼šè®¡ç®—ä¸åŒæƒé‡ç»„åˆçš„å¤æ™®æ¯”ç‡
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return
    FROM asset_returns
    GROUP BY asset
),
weight_combinations AS (
    SELECT
        a1.asset AS asset1,
        a2.asset AS asset2,
        0.5 AS weight1,
        0.5 AS weight2
    FROM asset_stats a1
    CROSS JOIN asset_stats a2
    WHERE a1.asset < a2.asset
),
portfolio_stats AS (
    SELECT
        wc.asset1,
        wc.asset2,
        wc.weight1,
        wc.weight2,
        as1.mean_return * wc.weight1 + as2.mean_return * wc.weight2 AS portfolio_return,
        SQRT(POWER(as1.std_return * wc.weight1, 2) + POWER(as2.std_return * wc.weight2, 2)) AS portfolio_volatility,
        risk_free_rate / 252.0 AS risk_free_rate_daily
    FROM weight_combinations wc
    JOIN asset_stats as1 ON wc.asset1 = as1.asset
    JOIN asset_stats as2 ON wc.asset2 = as2.asset
)
SELECT
    asset1,
    asset2,
    weight1,
    weight2,
    ROUND(portfolio_return::numeric, 6) AS portfolio_return,
    ROUND(portfolio_volatility::numeric, 6) AS portfolio_volatility,
    CASE
        WHEN portfolio_volatility = 0 THEN NULL
        ELSE ROUND(((portfolio_return - risk_free_rate_daily) / portfolio_volatility * SQRT(252.0))::numeric, 4)
    END AS sharpe_ratio
FROM portfolio_stats
ORDER BY sharpe_ratio DESC NULLS LAST
LIMIT 10;
```

---

## 2. é£é™©å¹³ä»·

### 2.1 é£é™©å¹³ä»·åŸç†

**é£é™©å¹³ä»·ï¼ˆRisk Parityï¼‰**ä½¿å„èµ„äº§å¯¹ç»„åˆé£é™©çš„è´¡çŒ®ç›¸ç­‰ã€‚

#### é£é™©å¹³ä»·å®šä¹‰

**é£é™©å¹³ä»·**ï¼šå„èµ„äº§çš„é£é™©è´¡çŒ®ç›¸ç­‰ï¼š
$$RC_i = w_i \times \frac{\partial \sigma_p}{\partial w_i} = \text{constant}$$

å…¶ä¸­$RC_i$æ˜¯èµ„äº§$i$çš„é£é™©è´¡çŒ®ã€‚

#### é£é™©è´¡çŒ®

**é£é™©è´¡çŒ®**ï¼šèµ„äº§$i$å¯¹ç»„åˆé£é™©çš„è´¡çŒ®ï¼š
$$RC_i = w_i \times \frac{(\boldsymbol{\Sigma} \mathbf{w})_i}{\sigma_p}$$

### 2.2 é£é™©å¹³ä»·æƒé‡å®ç°

**é£é™©å¹³ä»·æƒé‡**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- é£é™©å¹³ä»·æƒé‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—é£é™©å¹³ä»·æƒé‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—é£é™©å¹³ä»·æƒé‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©å¹³ä»·è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—é£é™©å¹³ä»·æƒé‡ï¼ˆç®€åŒ–ç‰ˆï¼šåŸºäºæ³¢åŠ¨ç‡å€’æ•°ï¼‰
WITH asset_volatility AS (
    SELECT
        asset,
        STDDEV(return_rate) AS volatility
    FROM asset_returns
    GROUP BY asset
),
inverse_volatility AS (
    SELECT
        asset,
        volatility,
        1.0 / NULLIF(volatility, 0) AS inv_vol
    FROM asset_volatility
),
total_inv_vol AS (
    SELECT SUM(inv_vol) AS total_inv_vol
    FROM inverse_volatility
)
SELECT
    iv.asset,
    ROUND(iv.volatility::numeric, 6) AS volatility,
    ROUND((iv.inv_vol / tiv.total_inv_vol)::numeric, 4) AS risk_parity_weight
FROM inverse_volatility iv
CROSS JOIN total_inv_vol tiv
ORDER BY iv.asset;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    STDDEV(return_rate) AS volatility
FROM asset_returns
GROUP BY asset;
```

---

### 2.3 é£é™©å¹³ä»·ä¼˜åŒ–

**é£é™©å¹³ä»·ä¼˜åŒ–**ï¼šè¿­ä»£ä¼˜åŒ–é£é™©å¹³ä»·æƒé‡ã€‚

```sql
-- é£é™©å¹³ä»·ä¼˜åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'é£é™©å¹³ä»·ä¼˜åŒ–éœ€è¦è¿­ä»£ç®—æ³•';
        -- å®é™…å®ç°éœ€è¦å¤šæ¬¡è¿­ä»£è°ƒæ•´æƒé‡
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©å¹³ä»·ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. æœ€å°æ–¹å·®ç»„åˆ

### 3.1 æœ€å°æ–¹å·®ç»„åˆåŸç†

**æœ€å°æ–¹å·®ç»„åˆï¼ˆMinimum Variance Portfolioï¼‰**åœ¨ç»™å®šçº¦æŸä¸‹æœ€å°åŒ–ç»„åˆæ–¹å·®ã€‚

#### æœ€å°æ–¹å·®é—®é¢˜

**æœ€å°æ–¹å·®é—®é¢˜**ï¼š
$$\min_{\mathbf{w}} \mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w} \text{ subject to } \sum_{i=1}^{n} w_i = 1, w_i \geq 0$$

#### ä¼˜åŒ–æ–¹æ³•

**ä¼˜åŒ–æ–¹æ³•**ï¼š

1. **æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•**ï¼šæ±‚è§£çº¦æŸä¼˜åŒ–é—®é¢˜
2. **äºŒæ¬¡è§„åˆ’**ï¼šä½¿ç”¨äºŒæ¬¡è§„åˆ’æ±‚è§£å™¨
3. **ç®€åŒ–æ–¹æ³•**ï¼šä½¿ç”¨æ³¢åŠ¨ç‡å€’æ•°ä½œä¸ºæƒé‡

### 3.2 æœ€å°æ–¹å·®æƒé‡å®ç°

**æœ€å°æ–¹å·®æƒé‡**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æœ€å°æ–¹å·®ç»„åˆè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æœ€å°æ–¹å·®ç»„åˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ€å°æ–¹å·®ç»„åˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ€å°æ–¹å·®ç»„åˆè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æœ€å°æ–¹å·®ç»„åˆï¼ˆç®€åŒ–ç‰ˆï¼šç­‰æƒé‡ä½œä¸ºåŸºå‡†ï¼‰
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        VARIANCE(return_rate) AS variance
    FROM asset_returns
    GROUP BY asset
),
equal_weight_portfolio AS (
    SELECT
        COUNT(*) AS n_assets,
        1.0 / COUNT(*) AS equal_weight
    FROM asset_stats
),
portfolio_variance AS (
    SELECT
        SUM(variance * ew.equal_weight * ew.equal_weight) AS portfolio_var
    FROM asset_stats
    CROSS JOIN equal_weight_portfolio ew
)
SELECT
    n_assets,
    ROUND(equal_weight::numeric, 4) AS equal_weight,
    ROUND(SQRT(portfolio_var)::numeric, 6) AS portfolio_volatility
FROM equal_weight_portfolio
CROSS JOIN portfolio_variance;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    asset,
    VARIANCE(return_rate) AS variance
FROM asset_returns
GROUP BY asset;
```

---

### 3.3 çº¦æŸæœ€å°æ–¹å·®

**çº¦æŸæœ€å°æ–¹å·®**ï¼šæ·»åŠ çº¦æŸæ¡ä»¶çš„æœ€å°æ–¹å·®ç»„åˆã€‚

```sql
-- çº¦æŸæœ€å°æ–¹å·®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    min_weight NUMERIC := 0.1;  -- æœ€å°æƒé‡10%
    max_weight NUMERIC := 0.5;  -- æœ€å¤§æƒé‡50%
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—çº¦æŸæœ€å°æ–¹å·®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—çº¦æŸæœ€å°æ–¹å·®ï¼Œæœ€å°æƒé‡: %, æœ€å¤§æƒé‡: %', min_weight, max_weight;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çº¦æŸæœ€å°æ–¹å·®è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- çº¦æŸæœ€å°æ–¹å·®ï¼šä½¿ç”¨æ³¢åŠ¨ç‡å€’æ•°ä½œä¸ºæƒé‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
WITH asset_volatility AS (
    SELECT
        asset,
        STDDEV(return_rate) AS volatility
    FROM asset_returns
    GROUP BY asset
),
inverse_volatility AS (
    SELECT
        asset,
        volatility,
        1.0 / NULLIF(volatility, 0) AS inv_vol
    FROM asset_volatility
),
normalized_weights AS (
    SELECT
        asset,
        inv_vol,
        inv_vol / SUM(inv_vol) OVER () AS raw_weight,
        -- åº”ç”¨çº¦æŸ
        GREATEST(min_weight, LEAST(max_weight, inv_vol / SUM(inv_vol) OVER ())) AS constrained_weight
    FROM inverse_volatility
),
rebalanced_weights AS (
    SELECT
        asset,
        constrained_weight,
        constrained_weight / SUM(constrained_weight) OVER () AS final_weight
    FROM normalized_weights
)
SELECT
    asset,
    ROUND(volatility::numeric, 6) AS volatility,
    ROUND(final_weight::numeric, 4) AS optimal_weight
FROM rebalanced_weights
JOIN asset_volatility USING (asset)
ORDER BY asset;
```

---

## 4. æŠ•èµ„ç»„åˆä¼˜åŒ–ç­–ç•¥

### 4.1 åæ–¹å·®çŸ©é˜µä¼˜åŒ–

**åæ–¹å·®çŸ©é˜µä¼˜åŒ–**ï¼šä¼˜åŒ–åæ–¹å·®çŸ©é˜µçš„è®¡ç®—å’Œå­˜å‚¨ã€‚

```sql
-- åæ–¹å·®çŸ©é˜µä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åæ–¹å·®çŸ©é˜µ
CREATE MATERIALIZED VIEW IF NOT EXISTS covariance_matrix_cache AS
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return
    FROM asset_returns
    GROUP BY asset
)
SELECT
    a1.asset AS asset1,
    a2.asset AS asset2,
    AVG((a1.return_rate - s1.mean_return) * (a2.return_rate - s2.mean_return)) AS covariance
FROM asset_returns a1
JOIN asset_returns a2 ON a1.date = a2.date
JOIN asset_stats s1 ON a1.asset = s1.asset
JOIN asset_stats s2 ON a2.asset = s2.asset
GROUP BY a1.asset, a2.asset;

CREATE INDEX IF NOT EXISTS idx_covariance_matrix_cache_asset1_asset2
ON covariance_matrix_cache(asset1, asset2);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY covariance_matrix_cache;
```

### 4.2 æƒé‡çº¦æŸä¼˜åŒ–

**æƒé‡çº¦æŸä¼˜åŒ–**ï¼šä¼˜åŒ–æƒé‡çº¦æŸçš„å¤„ç†ã€‚

```sql
-- æƒé‡çº¦æŸä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºæƒé‡çº¦æŸè¡¨
        CREATE TABLE IF NOT EXISTS weight_constraints (
            asset VARCHAR(10) PRIMARY KEY,
            min_weight NUMERIC(5, 4) DEFAULT 0,
            max_weight NUMERIC(5, 4) DEFAULT 1,
            CHECK (min_weight >= 0 AND max_weight <= 1 AND min_weight <= max_weight)
        );

        RAISE NOTICE 'æƒé‡çº¦æŸè¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æƒé‡çº¦æŸä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.3 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢å’Œæ‰¹é‡å¤„ç†ã€‚

```sql
-- æ€§èƒ½ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        SET work_mem = '1GB';
        RAISE NOTICE 'æ€§èƒ½ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–ã€é£é™©å¹³ä»·å’Œæœ€å°æ–¹å·®ç»„åˆè®¡ç®—ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡æŠ•èµ„ç»„åˆä¼˜åŒ–çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–åŸç†

PostgreSQL 18 çš„å¹¶è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æèµ„äº§æ•°æ®
2. **å¹¶è¡Œåæ–¹å·®è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—åæ–¹å·®çŸ©é˜µ
3. **å¹¶è¡Œä¼˜åŒ–è®¡ç®—**ï¼šå¹¶è¡Œæ‰§è¡ŒæŠ•èµ„ç»„åˆä¼˜åŒ–ç®—æ³•
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„ä¼˜åŒ–ç»“æœ

### 5.2 å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–

```sql
-- PostgreSQL 18 å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå‡å€¼-æ–¹å·®ä¼˜åŒ–ï¼šè®¡ç®—æœ‰æ•ˆå‰æ²¿
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        VARIANCE(return_rate) AS variance
    FROM asset_returns
    GROUP BY asset
),
portfolio_combinations AS (
    SELECT
        a1.asset AS asset1,
        a2.asset AS asset2,
        (a1.mean_return + a2.mean_return) / 2 AS portfolio_return,
        SQRT((a1.variance + a2.variance) / 2) AS portfolio_risk
    FROM asset_stats a1
    CROSS JOIN asset_stats a2
    WHERE a1.asset < a2.asset
)
SELECT
    asset1,
    asset2,
    ROUND(portfolio_return::numeric, 6) AS expected_return,
    ROUND(portfolio_risk::numeric, 6) AS portfolio_risk,
    ROUND((portfolio_return / NULLIF(portfolio_risk, 0))::numeric, 4) AS sharpe_ratio
FROM portfolio_combinations
ORDER BY sharpe_ratio DESC
LIMIT 20;
```

### 5.3 å¹¶è¡Œé£é™©å¹³ä»·

```sql
-- PostgreSQL 18 å¹¶è¡Œé£é™©å¹³ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œé£é™©å¹³ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œé£é™©å¹³ä»·';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œé£é™©å¹³ä»·å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œé£é™©å¹³ä»·ï¼šç­‰é£é™©è´¡çŒ®æƒé‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH asset_volatilities AS (
    SELECT
        asset,
        STDDEV(return_rate) AS volatility,
        1.0 / NULLIF(STDDEV(return_rate), 0) AS inverse_volatility
    FROM asset_returns
    GROUP BY asset
),
total_inverse_vol AS (
    SELECT SUM(inverse_volatility) AS total_inv_vol
    FROM asset_volatilities
)
SELECT
    av.asset,
    ROUND(av.volatility::numeric, 6) AS volatility,
    ROUND((av.inverse_volatility / tiv.total_inv_vol)::numeric, 6) AS risk_parity_weight
FROM asset_volatilities av
CROSS JOIN total_inverse_vol tiv
ORDER BY risk_parity_weight DESC;
```

### 5.4 å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆ

```sql
-- PostgreSQL 18 å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæœ€å°æ–¹å·®ç»„åˆï¼šåŸºäºæ³¢åŠ¨ç‡å€’æ•°
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH asset_variances AS (
    SELECT
        asset,
        VARIANCE(return_rate) AS variance,
        1.0 / NULLIF(VARIANCE(return_rate), 0) AS inverse_variance
    FROM asset_returns
    GROUP BY asset
),
total_inverse_var AS (
    SELECT SUM(inverse_variance) AS total_inv_var
    FROM asset_variances
)
SELECT
    av.asset,
    ROUND(av.variance::numeric, 6) AS variance,
    ROUND((av.inverse_variance / tiv.total_inv_var)::numeric, 6) AS min_variance_weight
FROM asset_variances av
CROSS JOIN total_inverse_var tiv
ORDER BY min_variance_weight DESC;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 å¤šèµ„äº§ç»„åˆä¼˜åŒ–

**å¤šèµ„äº§ç»„åˆä¼˜åŒ–**ç»¼åˆè€ƒè™‘å¤šä¸ªèµ„äº§çš„æ”¶ç›Šå’Œé£é™©ã€‚

```sql
-- å¤šèµ„äº§ç»„åˆä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'optimization_results') THEN
            RAISE WARNING 'è¡¨ optimization_results ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE optimization_results (
                optimization_id SERIAL PRIMARY KEY,
                asset VARCHAR(10) NOT NULL,
                weight NUMERIC(5, 4) NOT NULL,
                expected_return NUMERIC(10, 6),
                portfolio_volatility NUMERIC(10, 6),
                sharpe_ratio NUMERIC(10, 4),
                created_at TIMESTAMP DEFAULT NOW()
            );

            RAISE NOTICE 'è¡¨ optimization_results åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šèµ„äº§ç»„åˆä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»„åˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ä¼˜åŒ–åçš„ç»„åˆæŒ‡æ ‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH asset_stats AS (
    SELECT
        asset,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return
    FROM asset_returns
    GROUP BY asset
),
optimized_weights AS (
    SELECT
        asset,
        CASE asset
            WHEN 'A' THEN 0.3
            WHEN 'B' THEN 0.4
            WHEN 'C' THEN 0.3
        END AS weight
    FROM asset_stats
),
portfolio_stats AS (
    SELECT
        SUM(as_stats.mean_return * ow.weight) AS portfolio_return,
        SQRT(SUM(POWER(as_stats.std_return * ow.weight, 2))) AS portfolio_volatility,
        0.03 / 252.0 AS risk_free_rate
    FROM asset_stats as_stats
    JOIN optimized_weights ow ON as_stats.asset = ow.asset
)
SELECT
    ROUND(portfolio_return::numeric, 6) AS expected_return,
    ROUND(portfolio_volatility::numeric, 6) AS portfolio_volatility,
    ROUND(((portfolio_return - risk_free_rate) / NULLIF(portfolio_volatility, 0) * SQRT(252.0))::numeric, 4) AS sharpe_ratio
FROM portfolio_stats;
```

### 5.2 åŠ¨æ€å†å¹³è¡¡ç­–ç•¥

**åŠ¨æ€å†å¹³è¡¡ç­–ç•¥**ï¼šå®šæœŸé‡æ–°ä¼˜åŒ–æŠ•èµ„ç»„åˆã€‚

```sql
-- åŠ¨æ€å†å¹³è¡¡ç­–ç•¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    rebalance_frequency INTEGER := 30;  -- æ¯30å¤©å†å¹³è¡¡ä¸€æ¬¡
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_returns') THEN
            RAISE WARNING 'è¡¨ asset_returns ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒåŠ¨æ€å†å¹³è¡¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŠ¨æ€å†å¹³è¡¡ï¼Œå†å¹³è¡¡é¢‘ç‡: % å¤©', rebalance_frequency;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŠ¨æ€å†å¹³è¡¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ¨æ€å†å¹³è¡¡ï¼šè®¡ç®—å†å¹³è¡¡æ—¥æœŸå’Œæƒé‡
WITH rebalance_dates AS (
    SELECT DISTINCT
        DATE_TRUNC('month', date) + (rebalance_frequency - 1) * INTERVAL '1 day' AS rebalance_date
    FROM asset_returns
    WHERE date >= CURRENT_DATE - INTERVAL '1 year'
),
recent_returns AS (
    SELECT
        date,
        asset,
        return_rate
    FROM asset_returns
    WHERE date >= CURRENT_DATE - INTERVAL '90 days'
),
rebalance_weights AS (
    SELECT
        rd.rebalance_date,
        ar.asset,
        STDDEV(ar.return_rate) AS volatility,
        1.0 / NULLIF(STDDEV(ar.return_rate), 0) AS inv_vol
    FROM rebalance_dates rd
    CROSS JOIN (SELECT DISTINCT asset FROM asset_returns) ar
    LEFT JOIN recent_returns rr ON ar.asset = rr.asset
    GROUP BY rd.rebalance_date, ar.asset
)
SELECT
    rebalance_date,
    asset,
    ROUND((inv_vol / SUM(inv_vol) OVER (PARTITION BY rebalance_date))::numeric, 4) AS rebalance_weight
FROM rebalance_weights
WHERE inv_vol IS NOT NULL
ORDER BY rebalance_date, asset;
```

### 5.3 å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–

**å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–**ï¼šåŸºäºå› å­æ¨¡å‹çš„ç»„åˆä¼˜åŒ–ã€‚

```sql
-- å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'factor_loadings') THEN
            RAISE WARNING 'è¡¨ factor_loadings ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE factor_loadings (
                asset VARCHAR(10) NOT NULL,
                factor VARCHAR(20) NOT NULL,
                loading NUMERIC(10, 6) NOT NULL,
                PRIMARY KEY (asset, factor)
            );

            INSERT INTO factor_loadings (asset, factor, loading) VALUES
                ('A', 'Market', 1.2),
                ('A', 'Size', 0.8),
                ('B', 'Market', 0.9),
                ('B', 'Size', 1.1);

            RAISE NOTICE 'è¡¨ factor_loadings åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå› å­æŠ•èµ„ç»„åˆä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å› å­æŠ•èµ„ç»„åˆä¼˜åŒ–ï¼šåŸºäºå› å­æš´éœ²ä¼˜åŒ–æƒé‡
WITH factor_exposures AS (
    SELECT
        asset,
        SUM(loading) AS total_factor_exposure
    FROM factor_loadings
    GROUP BY asset
),
optimized_weights AS (
    SELECT
        asset,
        total_factor_exposure,
        total_factor_exposure / SUM(total_factor_exposure) OVER () AS factor_weight
    FROM factor_exposures
)
SELECT
    asset,
    ROUND(total_factor_exposure::numeric, 6) AS factor_exposure,
    ROUND(factor_weight::numeric, 4) AS optimal_weight
FROM optimized_weights
ORDER BY factor_weight DESC;
```

### 5.4 é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–

**é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–**ï¼šåŸºäºé£é™©é¢„ç®—çš„ç»„åˆä¼˜åŒ–ã€‚

```sql
-- é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'risk_budgets') THEN
            RAISE WARNING 'è¡¨ risk_budgets ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE risk_budgets (
                asset VARCHAR(10) PRIMARY KEY,
                risk_budget NUMERIC(5, 4) NOT NULL CHECK (risk_budget >= 0 AND risk_budget <= 1)
            );

            INSERT INTO risk_budgets (asset, risk_budget) VALUES
                ('A', 0.3),
                ('B', 0.4),
                ('C', 0.3);

            RAISE NOTICE 'è¡¨ risk_budgets åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé£é™©é¢„ç®—ç»„åˆä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é£é™©é¢„ç®—ç»„åˆä¼˜åŒ–ï¼šæ ¹æ®é£é™©é¢„ç®—åˆ†é…æƒé‡
WITH asset_volatility AS (
    SELECT
        asset,
        STDDEV(return_rate) AS volatility
    FROM asset_returns
    GROUP BY asset
),
risk_budget_weights AS (
    SELECT
        av.asset,
        av.volatility,
        rb.risk_budget,
        rb.risk_budget / NULLIF(av.volatility, 0) AS weight_factor
    FROM asset_volatility av
    JOIN risk_budgets rb ON av.asset = rb.asset
)
SELECT
    asset,
    ROUND(volatility::numeric, 6) AS volatility,
    ROUND(risk_budget::numeric, 4) AS risk_budget,
    ROUND((weight_factor / SUM(weight_factor) OVER ())::numeric, 4) AS optimal_weight
FROM risk_budget_weights
ORDER BY asset;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 ä¼˜åŒ–æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **å‡å€¼-æ–¹å·®** | $\max \frac{\mathbf{w}^T \boldsymbol{\mu} - R_f}{\sqrt{\mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}}}$ | $O(n^3)$ | $O(n^2)$ | æ ‡å‡†ä¼˜åŒ– | ç†è®ºå®Œå–„ | éœ€è¦ä¼°è®¡å‚æ•° |
| **é£é™©å¹³ä»·** | $\min \sum_{i,j} (RC_i - RC_j)^2$ | $O(n^2)$ | $O(n^2)$ | å¤šèµ„äº§ç»„åˆ | ç¨³å¥ | å¯èƒ½å¿½ç•¥æ”¶ç›Š |
| **æœ€å°æ–¹å·®** | $\min \mathbf{w}^T \boldsymbol{\Sigma} \mathbf{w}$ | $O(n^3)$ | $O(n^2)$ | é£é™©æœ€å°åŒ– | ç®€å• | å¯èƒ½æ”¶ç›Šè¾ƒä½ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **çŸ©é˜µè¿ç®—ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨æ•°ç»„ç±»å‹ä¼˜åŒ–çŸ©é˜µè®¡ç®—
   - ç¼“å­˜åæ–¹å·®çŸ©é˜µ

2. **å¹¶è¡Œå¤„ç†**ï¼š
   - åˆ©ç”¨PostgreSQLå¹¶è¡ŒæŸ¥è¯¢
   - æ‰¹é‡è®¡ç®—å¤šä¸ªç»„åˆ

3. **ç®—æ³•ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç®€åŒ–æ–¹æ³•ï¼ˆå¦‚æ³¢åŠ¨ç‡å€’æ•°ï¼‰
   - è¿­ä»£ä¼˜åŒ–ç®—æ³•

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šåæ–¹å·®çŸ©é˜µä¼°è®¡ä¸å‡†ç¡®

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ›´é•¿çš„å†å²æ•°æ®ã€ä½¿ç”¨å› å­æ¨¡å‹ã€æ­£åˆ™åŒ–

**é—®é¢˜2**ï¼šä¼˜åŒ–ç»“æœä¸ç¨³å®š

- **è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ çº¦æŸæ¡ä»¶ã€ä½¿ç”¨ç¨³å¥ä¼°è®¡ã€å¤šæ¬¡ä¼˜åŒ–

**é—®é¢˜3**ï¼šè®¡ç®—æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ã€å¹¶è¡ŒæŸ¥è¯¢ã€ç®€åŒ–ç®—æ³•

**é—®é¢˜4**ï¼šæƒé‡æç«¯

- **è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ æƒé‡çº¦æŸã€ä½¿ç”¨æ­£åˆ™åŒ–ã€é£é™©å¹³ä»·

---

## 8. æœ€ä½³å®è·µ

### 7.1 ä¼˜åŒ–æ–¹æ³•é€‰æ‹©

1. **æ ‡å‡†ä¼˜åŒ–**ï¼šä½¿ç”¨å‡å€¼-æ–¹å·®ä¼˜åŒ–
2. **å¤šèµ„äº§ç»„åˆ**ï¼šä½¿ç”¨é£é™©å¹³ä»·
3. **é£é™©æœ€å°åŒ–**ï¼šä½¿ç”¨æœ€å°æ–¹å·®ç»„åˆ

### 7.2 çº¦æŸæ¡ä»¶è®¾ç½®

1. **æƒé‡çº¦æŸ**ï¼šè®¾ç½®æœ€å°å’Œæœ€å¤§æƒé‡
2. **è¡Œä¸šçº¦æŸ**ï¼šé™åˆ¶è¡Œä¸šé›†ä¸­åº¦
3. **æµåŠ¨æ€§çº¦æŸ**ï¼šè€ƒè™‘èµ„äº§æµåŠ¨æ€§

### 7.3 å‚æ•°è°ƒä¼˜

1. **æ—¶é—´çª—å£**ï¼šé€‰æ‹©åˆé€‚çš„ä¼°è®¡çª—å£
2. **é£é™©åŒæ¶ç³»æ•°**ï¼šæ ¹æ®é£é™©åå¥½è°ƒæ•´
3. **å†å¹³è¡¡é¢‘ç‡**ï¼šå¹³è¡¡æˆæœ¬å’Œæ”¶ç›Š

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **çŸ©é˜µè¿ç®—**ï¼šä½¿ç”¨æ•°ç»„ç±»å‹æˆ–è¡¨ç»“æ„
2. **è¿­ä»£ç®—æ³•**ï¼šä½¿ç”¨é€’å½’CTEæˆ–å¤–éƒ¨å·¥å…·
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾å’Œç´¢å¼•
4. **æ•°å€¼ç¨³å®šæ€§**ï¼šæ³¨æ„æ•°å€¼ç²¾åº¦å’Œç¨³å®šæ€§

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æŠ•èµ„ç»„åˆä¼˜åŒ–çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«æŠ•èµ„ç»„åˆæƒé‡çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Næœ€ä¼˜æŠ•èµ„ç»„åˆæŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æŠ•èµ„ç»„åˆä¼˜åŒ–è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡æŠ•èµ„ç»„åˆä¼˜åŒ–å’Œå¤šç›®æ ‡ä¼˜åŒ–

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - æŠ•èµ„ç»„åˆä¼˜åŒ–è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡åæ–¹å·®çŸ©é˜µè®¡ç®—å’Œæ‰¹é‡ä¼˜åŒ–

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–æŠ•èµ„ç»„åˆæŸ¥è¯¢**

```sql
-- ä¸ºæŠ•èµ„ç»„åˆæƒé‡åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_portfolio_weights_skip_scan
ON portfolio_weights(portfolio_id, weight DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æƒé‡æœ€é«˜çš„å‰10ä¸ªèµ„äº§
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    portfolio_id,
    symbol,
    weight
FROM portfolio_weights
WHERE portfolio_id = 1
ORDER BY weight DESC
LIMIT 10;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS portfolio_optimization_cache AS
WITH asset_returns AS (
    SELECT
        symbol,
        date,
        daily_return,
        AVG(daily_return) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN 251 PRECEDING AND CURRENT ROW) AS mean_return,
        STDDEV(daily_return) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN 251 PRECEDING AND CURRENT ROW) AS stddev_return
    FROM stock_returns
    WHERE date >= CURRENT_DATE - INTERVAL '252 days'
),
covariance_matrix AS (
    SELECT
        a1.symbol AS symbol1,
        a2.symbol AS symbol2,
        AVG((a1.daily_return - a1.mean_return) * (a2.daily_return - a2.mean_return)) AS covariance
    FROM asset_returns a1
    JOIN asset_returns a2 ON a1.date = a2.date
    WHERE a1.symbol <= a2.symbol
    GROUP BY a1.symbol, a2.symbol
)
SELECT
    symbol1,
    symbol2,
    ROUND(covariance::numeric, 6) AS covariance
FROM covariance_matrix;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_portfolio_optimization_cache_symbols ON portfolio_optimization_cache(symbol1, symbol2);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY portfolio_optimization_cache;
```

**2. é£é™©å¹³ä»·æŠ•èµ„ç»„åˆï¼šç­‰é£é™©è´¡çŒ®ä¼˜åŒ–**

**é£é™©å¹³ä»·æŠ•èµ„ç»„åˆ**ï¼šæ„å»ºç­‰é£é™©è´¡çŒ®çš„æŠ•èµ„ç»„åˆã€‚

```sql
-- é£é™©å¹³ä»·æŠ•èµ„ç»„åˆï¼šç­‰é£é™©è´¡çŒ®ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'asset_risk_contributions') THEN
            CREATE TABLE asset_risk_contributions (
                portfolio_id INTEGER NOT NULL,
                symbol VARCHAR(20) NOT NULL,
                weight NUMERIC NOT NULL,
                risk_contribution NUMERIC NOT NULL,
                PRIMARY KEY (portfolio_id, symbol)
            );

            CREATE INDEX idx_asset_risk_contributions_portfolio ON asset_risk_contributions(portfolio_id, risk_contribution DESC);

            RAISE NOTICE 'èµ„äº§é£é™©è´¡çŒ®è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé£é™©å¹³ä»·æŠ•èµ„ç»„åˆä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é£é™©å¹³ä»·æŠ•èµ„ç»„åˆä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é£é™©å¹³ä»·ï¼šè®¡ç®—æ¯ä¸ªèµ„äº§çš„é£é™©è´¡çŒ®
WITH portfolio_risk AS (
    SELECT
        pw.portfolio_id,
        pw.symbol,
        pw.weight,
        -- è®¡ç®—èµ„äº§çš„é£é™©è´¡çŒ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        pw.weight * ar.volatility AS marginal_risk,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ€»é£é™©ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        SQRT(SUM(POWER(pw.weight * ar.volatility, 2)) OVER (PARTITION BY pw.portfolio_id)) AS portfolio_volatility
    FROM portfolio_weights pw
    JOIN asset_risk ar ON pw.symbol = ar.symbol
    WHERE pw.portfolio_id = 1
),
risk_contributions AS (
    SELECT
        portfolio_id,
        symbol,
        weight,
        marginal_risk,
        portfolio_volatility,
        -- è®¡ç®—é£é™©è´¡çŒ®ç™¾åˆ†æ¯”
        (marginal_risk / NULLIF(portfolio_volatility, 0)) AS risk_contribution_pct
    FROM portfolio_risk
)
SELECT
    portfolio_id,
    symbol,
    ROUND(weight::numeric, 4) AS weight,
    ROUND(marginal_risk::numeric, 6) AS marginal_risk,
    ROUND(portfolio_volatility::numeric, 6) AS portfolio_volatility,
    ROUND(risk_contribution_pct::numeric * 100, 2) AS risk_contribution_pct,
    -- è®¡ç®—ç›®æ ‡æƒé‡ï¼ˆç­‰é£é™©è´¡çŒ®ï¼‰
    ROUND((1.0 / COUNT(*) OVER (PARTITION BY portfolio_id))::numeric, 4) AS target_weight,
    -- è®¡ç®—æƒé‡è°ƒæ•´
    ROUND((1.0 / COUNT(*) OVER (PARTITION BY portfolio_id) - weight)::numeric, 4) AS weight_adjustment
FROM risk_contributions
ORDER BY portfolio_id, risk_contribution_pct DESC;
```

**3. åŠ¨æ€å†å¹³è¡¡ï¼šæŠ•èµ„ç»„åˆæƒé‡è°ƒæ•´**

**åŠ¨æ€å†å¹³è¡¡**ï¼šæ ¹æ®å¸‚åœºå˜åŒ–åŠ¨æ€è°ƒæ•´æŠ•èµ„ç»„åˆæƒé‡ã€‚

```sql
-- åŠ¨æ€å†å¹³è¡¡ï¼šæŠ•èµ„ç»„åˆæƒé‡è°ƒæ•´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'portfolio_rebalancing_log') THEN
            CREATE TABLE portfolio_rebalancing_log (
                rebalance_id SERIAL PRIMARY KEY,
                portfolio_id INTEGER NOT NULL,
                rebalance_date DATE NOT NULL,
                symbol VARCHAR(20) NOT NULL,
                old_weight NUMERIC NOT NULL,
                new_weight NUMERIC NOT NULL,
                weight_change NUMERIC GENERATED ALWAYS AS (new_weight - old_weight) STORED,
                rebalance_cost NUMERIC,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );

            CREATE INDEX idx_portfolio_rebalancing_log_portfolio_date ON portfolio_rebalancing_log(portfolio_id, rebalance_date DESC);

            RAISE NOTICE 'æŠ•èµ„ç»„åˆå†å¹³è¡¡æ—¥å¿—è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŠ¨æ€å†å¹³è¡¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŠ¨æ€å†å¹³è¡¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŠ¨æ€å†å¹³è¡¡ï¼šè®¡ç®—éœ€è¦è°ƒæ•´çš„æƒé‡
WITH current_portfolio AS (
    SELECT
        portfolio_id,
        symbol,
        weight AS current_weight,
        market_value
    FROM portfolio_weights
    WHERE portfolio_id = 1
),
target_portfolio AS (
    SELECT
        portfolio_id,
        symbol,
        -- ç›®æ ‡æƒé‡ï¼šåŸºäºä¼˜åŒ–ç»“æœæˆ–ç­–ç•¥
        optimal_weight AS target_weight
    FROM portfolio_optimization_results
    WHERE portfolio_id = 1
),
rebalancing_needs AS (
    SELECT
        cp.portfolio_id,
        cp.symbol,
        cp.current_weight,
        COALESCE(tp.target_weight, cp.current_weight) AS target_weight,
        COALESCE(tp.target_weight, cp.current_weight) - cp.current_weight AS weight_difference,
        -- è®¡ç®—å†å¹³è¡¡é˜ˆå€¼ï¼ˆè¶…è¿‡5%æ‰å†å¹³è¡¡ï¼‰
        CASE
            WHEN ABS(COALESCE(tp.target_weight, cp.current_weight) - cp.current_weight) > 0.05 THEN 'Rebalance'
            ELSE 'Hold'
        END AS rebalance_action,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ€»å¸‚å€¼ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        SUM(cp.market_value) OVER (PARTITION BY cp.portfolio_id) AS total_portfolio_value
    FROM current_portfolio cp
    LEFT JOIN target_portfolio tp ON cp.portfolio_id = tp.portfolio_id AND cp.symbol = tp.symbol
)
SELECT
    portfolio_id,
    symbol,
    ROUND(current_weight::numeric, 4) AS current_weight,
    ROUND(target_weight::numeric, 4) AS target_weight,
    ROUND(weight_difference::numeric, 4) AS weight_difference,
    ROUND(ABS(weight_difference) * total_portfolio_value::numeric, 2) AS rebalance_amount,
    rebalance_action,
    -- è®¡ç®—å†å¹³è¡¡æˆæœ¬ï¼ˆå‡è®¾0.1%äº¤æ˜“æˆæœ¬ï¼‰
    ROUND(ABS(weight_difference) * total_portfolio_value * 0.001::numeric, 2) AS estimated_cost
FROM rebalancing_needs
WHERE rebalance_action = 'Rebalance'
ORDER BY ABS(weight_difference) DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€ŠæŠ•èµ„ç»„åˆç†è®ºä¸èµ„æœ¬å¸‚åœºã€‹ï¼ˆPortfolio Theory and Capital Marketsï¼‰- Markowitzç†è®º
- ã€Šé£é™©å¹³ä»·æŠ•èµ„ç»„åˆã€‹ï¼ˆRisk Parity Portfoliosï¼‰- é£é™©å¹³ä»·æ–¹æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [æ•°ç»„æ“ä½œ](https://www.postgresql.org/docs/current/arrays.html)
- [çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)
- [é€’å½’æŸ¥è¯¢](https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-RECURSIVE)

### åœ¨çº¿èµ„æº

- PostgreSQLæŠ•èµ„ç»„åˆä¼˜åŒ–æŒ‡å—
- Markowitzæ¨¡å‹è¯¦è§£
- æŠ•èµ„ç»„åˆä¼˜åŒ–æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [æ”¶ç›Šç‡è®¡ç®—](./æ”¶ç›Šç‡è®¡ç®—.md) - æ”¶ç›Šç‡è®¡ç®—
- [é£é™©è¯„ä¼°ç®—æ³•](./é£é™©è¯„ä¼°ç®—æ³•.md) - é£é™©è¯„ä¼°
- [é‡‘èæ—¶é—´åºåˆ—åˆ†æ](./é‡‘èæ—¶é—´åºåˆ—åˆ†æ.md) - æ—¶é—´åºåˆ—åˆ†æ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
