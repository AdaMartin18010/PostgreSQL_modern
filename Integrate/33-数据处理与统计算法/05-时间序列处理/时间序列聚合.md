# PostgreSQL æ—¶é—´åºåˆ—èšåˆå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ—¶é—´åºåˆ— | æ—¶é—´èšåˆ
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ—¶é—´åºåˆ—èšåˆå®Œæ•´æŒ‡å—](#postgresql-æ—¶é—´åºåˆ—èšåˆå®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ—¶é—´åºåˆ—èšåˆæ¦‚è¿°](#æ—¶é—´åºåˆ—èšåˆæ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ—¶é—´ç²’åº¦](#æ—¶é—´ç²’åº¦)
      - [èšåˆå‡½æ•°](#èšåˆå‡½æ•°)
      - [æ—¶é—´æ¡¶åŸç†](#æ—¶é—´æ¡¶åŸç†)
    - [æ ¸å¿ƒèšåˆåŠŸèƒ½](#æ ¸å¿ƒèšåˆåŠŸèƒ½)
  - [1. æ—¶é—´æ¡¶èšåˆ](#1-æ—¶é—´æ¡¶èšåˆ)
    - [1.1 æ—¶é—´æ¡¶åŸç†](#11-æ—¶é—´æ¡¶åŸç†)
      - [date\_binå‡½æ•°](#date_binå‡½æ•°)
      - [æ—¶é—´æ¡¶å¯¹é½](#æ—¶é—´æ¡¶å¯¹é½)
    - [1.2 date\_binèšåˆå®ç°](#12-date_binèšåˆå®ç°)
    - [1.3 å¤šæ—¶é—´æ¡¶å¤§å°å¯¹æ¯”](#13-å¤šæ—¶é—´æ¡¶å¤§å°å¯¹æ¯”)
    - [1.4 è‡ªå®šä¹‰æ—¶é—´æ¡¶](#14-è‡ªå®šä¹‰æ—¶é—´æ¡¶)
  - [2. æ—¶é—´åˆ†ç»„èšåˆ](#2-æ—¶é—´åˆ†ç»„èšåˆ)
    - [2.1 DATE\_TRUNCåŸç†](#21-date_truncåŸç†)
      - [DATE\_TRUNCå‡½æ•°](#date_truncå‡½æ•°)
      - [æˆªæ–­è§„åˆ™](#æˆªæ–­è§„åˆ™)
    - [2.2 DATE\_TRUNCèšåˆå®ç°](#22-date_truncèšåˆå®ç°)
    - [2.3 å¤šæ—¶é—´ç²’åº¦èšåˆ](#23-å¤šæ—¶é—´ç²’åº¦èšåˆ)
    - [2.4 æ—¶é—´ç²’åº¦è½¬æ¢](#24-æ—¶é—´ç²’åº¦è½¬æ¢)
  - [3. æ—¶é—´åºåˆ—å¡«å……](#3-æ—¶é—´åºåˆ—å¡«å……)
    - [3.1 æ—¶é—´åºåˆ—å¡«å……åŸç†](#31-æ—¶é—´åºåˆ—å¡«å……åŸç†)
      - [å¡«å……æ–¹æ³•](#å¡«å……æ–¹æ³•)
      - [è¿ç»­æ—¶é—´åºåˆ—ç”Ÿæˆ](#è¿ç»­æ—¶é—´åºåˆ—ç”Ÿæˆ)
    - [3.2 ç”Ÿæˆè¿ç»­æ—¶é—´åºåˆ—å®ç°](#32-ç”Ÿæˆè¿ç»­æ—¶é—´åºåˆ—å®ç°)
    - [3.3 å¤šç§å¡«å……æ–¹æ³•](#33-å¤šç§å¡«å……æ–¹æ³•)
    - [3.4 æ—¶é—´åºåˆ—å¯¹é½](#34-æ—¶é—´åºåˆ—å¯¹é½)
  - [4. é«˜çº§èšåˆæŠ€æœ¯](#4-é«˜çº§èšåˆæŠ€æœ¯)
    - [4.1 æ»šåŠ¨æ—¶é—´çª—å£èšåˆ](#41-æ»šåŠ¨æ—¶é—´çª—å£èšåˆ)
    - [4.2 åˆ†å±‚æ—¶é—´èšåˆ](#42-åˆ†å±‚æ—¶é—´èšåˆ)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 å¤šæ—¶é—´ç²’åº¦èšåˆ](#51-å¤šæ—¶é—´ç²’åº¦èšåˆ)
    - [5.2 é”€å”®æ•°æ®å¤šç»´åº¦èšåˆ](#52-é”€å”®æ•°æ®å¤šç»´åº¦èšåˆ)
    - [5.3 ç½‘ç«™æµé‡æ—¶é—´èšåˆåˆ†æ](#53-ç½‘ç«™æµé‡æ—¶é—´èšåˆåˆ†æ)
    - [5.4 é‡‘èæ•°æ®æ—¶é—´æ¡¶åˆ†æ](#54-é‡‘èæ•°æ®æ—¶é—´æ¡¶åˆ†æ)
  - [6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#6-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 æ—¶é—´èšåˆæ–¹æ³•å¯¹æ¯”](#61-æ—¶é—´èšåˆæ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ—¶é—´ç²’åº¦é€‰æ‹©](#71-æ—¶é—´ç²’åº¦é€‰æ‹©)
    - [7.2 æ—¶é—´èšåˆæ³¨æ„äº‹é¡¹](#72-æ—¶é—´èšåˆæ³¨æ„äº‹é¡¹)
    - [7.3 SQLå®ç°æ³¨æ„äº‹é¡¹](#73-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ—¶é—´åºåˆ—èšåˆæ¦‚è¿°

**æ—¶é—´åºåˆ—èšåˆï¼ˆTime Series Aggregationï¼‰**å°†æ—¶é—´åºåˆ—æ•°æ®æŒ‰æ—¶é—´é—´éš”è¿›è¡Œèšåˆç»Ÿè®¡ï¼Œç”¨äºæ•°æ®é™ç»´ã€è¶‹åŠ¿åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆã€‚æ—¶é—´åºåˆ—èšåˆæ˜¯æ—¶é—´åºåˆ—åˆ†æçš„åŸºç¡€æ“ä½œï¼Œèƒ½å¤Ÿå°†ç»†ç²’åº¦æ•°æ®è½¬æ¢ä¸ºç²—ç²’åº¦æ•°æ®ï¼Œä¾¿äºåˆ†æå’Œå¯è§†åŒ–ã€‚

### ç†è®ºåŸºç¡€

#### æ—¶é—´ç²’åº¦

**æ—¶é—´ç²’åº¦ï¼ˆTime Granularityï¼‰**æ˜¯æŒ‡èšåˆçš„æ—¶é—´å•ä½ï¼Œå¸¸è§çš„æ—¶é—´ç²’åº¦åŒ…æ‹¬ï¼š

1. **ç§’çº§**ï¼šç§’ã€åˆ†é’Ÿ
2. **å°æ—¶çº§**ï¼šå°æ—¶
3. **æ—¥çº§**ï¼šå¤©
4. **å‘¨çº§**ï¼šå‘¨
5. **æœˆçº§**ï¼šæœˆã€å­£åº¦
6. **å¹´çº§**ï¼šå¹´

#### èšåˆå‡½æ•°

**èšåˆå‡½æ•°**ç”¨äºè®¡ç®—æ¯ä¸ªæ—¶é—´æ¡¶å†…çš„ç»Ÿè®¡é‡ï¼š

1. **è®¡æ•°å‡½æ•°**ï¼š`COUNT(*)`, `COUNT(DISTINCT column)`
2. **æ±‚å’Œå‡½æ•°**ï¼š`SUM(column)`
3. **å¹³å‡å‡½æ•°**ï¼š`AVG(column)`
4. **æå€¼å‡½æ•°**ï¼š`MIN(column)`, `MAX(column)`
5. **ç»Ÿè®¡å‡½æ•°**ï¼š`STDDEV(column)`, `VARIANCE(column)`
6. **åˆ†ä½æ•°å‡½æ•°**ï¼š`PERCENTILE_CONT`, `PERCENTILE_DISC`

#### æ—¶é—´æ¡¶åŸç†

**æ—¶é—´æ¡¶ï¼ˆTime Bucketï¼‰**æ˜¯å°†è¿ç»­æ—¶é—´åºåˆ—åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„åŒºé—´ï¼Œæ¯ä¸ªåŒºé—´å†…çš„æ•°æ®è¢«èšåˆä¸ºä¸€ä¸ªå€¼ã€‚

**æ—¶é—´æ¡¶å¤§å°**ï¼š

- å›ºå®šå¤§å°ï¼šå¦‚1å°æ—¶ã€1å¤©ã€1å‘¨
- å¯å˜å¤§å°ï¼šå¦‚å·¥ä½œæ—¥ã€è‡ªç„¶æœˆ

### æ ¸å¿ƒèšåˆåŠŸèƒ½

| åŠŸèƒ½ | ç”¨é€” | å¤æ‚åº¦ | æ—¶é—´ç²’åº¦ |
|------|------|--------|---------|
| **DATE_TRUNC** | æ—¶é—´æˆªæ–­ | $O(n)$ | å›ºå®šç²’åº¦ |
| **date_bin** | æ—¶é—´æ¡¶ | $O(n)$ | è‡ªå®šä¹‰ç²’åº¦ |
| **æ—¶é—´å¡«å……** | è¿ç»­æ—¶é—´åºåˆ— | $O(n)$ | ä»»æ„ç²’åº¦ |
| **GROUPING SETS** | å¤šç²’åº¦èšåˆ | $O(n)$ | å¤šç²’åº¦ |

---

## 1. æ—¶é—´æ¡¶èšåˆ

### 1.1 æ—¶é—´æ¡¶åŸç†

**æ—¶é—´æ¡¶èšåˆï¼ˆTime Bucket Aggregationï¼‰**ä½¿ç”¨å›ºå®šæ—¶é—´é—´éš”å°†æ—¶é—´åºåˆ—æ•°æ®åˆ†ç»„ï¼Œç„¶åå¯¹æ¯ç»„æ•°æ®è¿›è¡Œèšåˆè®¡ç®—ã€‚

#### date_binå‡½æ•°

**date_binå‡½æ•°**ï¼ˆPostgreSQL 14+ï¼‰å°†æ—¶é—´æˆ³å¯¹é½åˆ°æŒ‡å®šé—´éš”çš„æ¡¶ä¸­ï¼š

```sql
date_bin(interval, source, origin)
```

å…¶ä¸­ï¼š

- `interval`ï¼šæ—¶é—´é—´éš”ï¼ˆå¦‚'1 hour', '1 day'ï¼‰
- `source`ï¼šæºæ—¶é—´æˆ³
- `origin`ï¼šå¯¹é½åŸç‚¹

#### æ—¶é—´æ¡¶å¯¹é½

**å¯¹é½æ–¹å¼**ï¼š

- **å‘ä¸‹å¯¹é½**ï¼š`FLOOR(timestamp / interval) * interval`
- **å‘ä¸Šå¯¹é½**ï¼š`CEIL(timestamp / interval) * interval`
- **æœ€è¿‘å¯¹é½**ï¼š`ROUND(timestamp / interval) * interval`

### 1.2 date_binèšåˆå®ç°

```sql
-- date_binæ—¶é—´æ¡¶èšåˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'metrics') THEN
            RAISE WARNING 'è¡¨ metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œdate_binèšåˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œdate_binæ—¶é—´æ¡¶èšåˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'date_binèšåˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date_bin('1 hour', timestamp, '2024-01-01 00:00:00'::timestamp) AS hour_bucket,
    COUNT(*) AS count,
    AVG(value) AS avg_value,
    SUM(value) AS total_value
FROM metrics
GROUP BY hour_bucket
ORDER BY hour_bucket;
```

---

### 1.3 å¤šæ—¶é—´æ¡¶å¤§å°å¯¹æ¯”

**å¤šæ—¶é—´æ¡¶**å¯¹æ¯”ä¸åŒæ—¶é—´æ¡¶å¤§å°çš„èšåˆæ•ˆæœã€‚

```sql
-- å¤šæ—¶é—´æ¡¶å¤§å°å¯¹æ¯”ï¼šå°æ—¶ã€4å°æ—¶ã€å¤©
SELECT
    date_bin('1 hour', timestamp, '2024-01-01 00:00:00'::timestamp) AS hour_bucket,
    date_bin('4 hours', timestamp, '2024-01-01 00:00:00'::timestamp) AS four_hour_bucket,
    date_bin('1 day', timestamp, '2024-01-01 00:00:00'::timestamp) AS day_bucket,
    COUNT(*) AS count,
    AVG(value) AS avg_value,
    SUM(value) AS total_value,
    MIN(value) AS min_value,
    MAX(value) AS max_value
FROM metrics
GROUP BY hour_bucket, four_hour_bucket, day_bucket
ORDER BY hour_bucket;
```

### 1.4 è‡ªå®šä¹‰æ—¶é—´æ¡¶

**è‡ªå®šä¹‰æ—¶é—´æ¡¶**ä½¿ç”¨éæ ‡å‡†æ—¶é—´é—´éš”ã€‚

```sql
-- è‡ªå®šä¹‰æ—¶é—´æ¡¶ï¼š15åˆ†é’Ÿã€30åˆ†é’Ÿ
SELECT
    date_bin('15 minutes', timestamp, '2024-01-01 00:00:00'::timestamp) AS bucket_15min,
    date_bin('30 minutes', timestamp, '2024-01-01 00:00:00'::timestamp) AS bucket_30min,
    COUNT(*) AS count,
    AVG(value) AS avg_value
FROM metrics
GROUP BY bucket_15min, bucket_30min
ORDER BY bucket_15min;
```

---

## 2. æ—¶é—´åˆ†ç»„èšåˆ

### 2.1 DATE_TRUNCåŸç†

**DATE_TRUNCèšåˆ**æŒ‰æ—¶é—´å•ä½è¿›è¡Œåˆ†ç»„èšåˆï¼Œå°†æ—¶é—´æˆ³æˆªæ–­åˆ°æŒ‡å®šçš„æ—¶é—´å•ä½ã€‚

#### DATE_TRUNCå‡½æ•°

**DATE_TRUNCå‡½æ•°**å°†æ—¶é—´æˆ³æˆªæ–­åˆ°æŒ‡å®šç²¾åº¦ï¼š

```sql
DATE_TRUNC('unit', timestamp)

```

æ”¯æŒçš„æ—¶é—´å•ä½ï¼š

- `microsecond`, `millisecond`, `second`
- `minute`, `hour`
- `day`, `week`, `month`, `quarter`, `year`

#### æˆªæ–­è§„åˆ™

**æˆªæ–­è§„åˆ™**ï¼š

- `DATE_TRUNC('day', timestamp)`ï¼šæˆªæ–­åˆ°å½“å¤©00:00:00
- `DATE_TRUNC('month', timestamp)`ï¼šæˆªæ–­åˆ°å½“æœˆ1æ—¥00:00:00
- `DATE_TRUNC('year', timestamp)`ï¼šæˆªæ–­åˆ°å½“å¹´1æœˆ1æ—¥00:00:00

### 2.2 DATE_TRUNCèšåˆå®ç°

```sql
-- DATE_TRUNCæ—¶é—´åˆ†ç»„èšåˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒDATE_TRUNCèšåˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒDATE_TRUNCæ—¶é—´åˆ†ç»„èšåˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'DATE_TRUNCèšåˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('day', sale_date) AS date,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM sales
GROUP BY DATE_TRUNC('day', sale_date)
ORDER BY date;
```

---

### 2.3 å¤šæ—¶é—´ç²’åº¦èšåˆ

**å¤šæ—¶é—´ç²’åº¦**åŒæ—¶ç”Ÿæˆå¤šä¸ªæ—¶é—´ç²’åº¦çš„èšåˆç»“æœã€‚

```sql
-- å¤šæ—¶é—´ç²’åº¦èšåˆï¼šå°æ—¶ã€å¤©ã€å‘¨ã€æœˆ
WITH multi_granularity AS (
    SELECT
        DATE_TRUNC('hour', sale_date) AS hour,
        DATE_TRUNC('day', sale_date) AS day,
        DATE_TRUNC('week', sale_date) AS week,
        DATE_TRUNC('month', sale_date) AS month,
        sale_date,
        amount
    FROM sales
)
SELECT
    hour,
    day,
    week,
    month,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM multi_granularity
GROUP BY GROUPING SETS (
    (hour),
    (day),
    (week),
    (month)
)
ORDER BY hour NULLS LAST, day NULLS LAST, week NULLS LAST, month NULLS LAST;
```

### 2.4 æ—¶é—´ç²’åº¦è½¬æ¢

**æ—¶é—´ç²’åº¦è½¬æ¢**å°†ç»†ç²’åº¦æ•°æ®è½¬æ¢ä¸ºç²—ç²’åº¦æ•°æ®ã€‚

```sql
-- æ—¶é—´ç²’åº¦è½¬æ¢ï¼šä»å°æ—¶åˆ°å¤©ã€å‘¨ã€æœˆ
WITH hourly_data AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        AVG(value) AS hourly_avg
    FROM metrics
    GROUP BY DATE_TRUNC('hour', timestamp)
)
SELECT
    DATE_TRUNC('day', hour) AS day,
    DATE_TRUNC('week', hour) AS week,
    DATE_TRUNC('month', hour) AS month,
    COUNT(*) AS hour_count,
    AVG(hourly_avg) AS daily_avg,
    SUM(hourly_avg) AS daily_sum
FROM hourly_data
GROUP BY DATE_TRUNC('day', hour), DATE_TRUNC('week', hour), DATE_TRUNC('month', hour)
ORDER BY day;
```

---

## 3. æ—¶é—´åºåˆ—å¡«å……

### 3.1 æ—¶é—´åºåˆ—å¡«å……åŸç†

**æ—¶é—´åºåˆ—å¡«å……ï¼ˆTime Series Fillingï¼‰**ç”Ÿæˆè¿ç»­çš„æ—¶é—´åºåˆ—å¹¶å¡«å……ç¼ºå¤±å€¼ï¼Œç¡®ä¿æ—¶é—´åºåˆ—çš„è¿ç»­æ€§ã€‚

#### å¡«å……æ–¹æ³•

1. **å‰å‘å¡«å……ï¼ˆForward Fillï¼‰**ï¼šä½¿ç”¨å‰ä¸€ä¸ªå€¼å¡«å……
2. **åå‘å¡«å……ï¼ˆBackward Fillï¼‰**ï¼šä½¿ç”¨åä¸€ä¸ªå€¼å¡«å……
3. **é›¶å¡«å……ï¼ˆZero Fillï¼‰**ï¼šä½¿ç”¨0å¡«å……
4. **æ’å€¼å¡«å……ï¼ˆInterpolationï¼‰**ï¼šä½¿ç”¨çº¿æ€§æ’å€¼å¡«å……
5. **å‡å€¼å¡«å……ï¼ˆMean Fillï¼‰**ï¼šä½¿ç”¨å‡å€¼å¡«å……

#### è¿ç»­æ—¶é—´åºåˆ—ç”Ÿæˆ

**generate_serieså‡½æ•°**ç”Ÿæˆè¿ç»­çš„æ—¶é—´åºåˆ—ï¼š

```sql
generate_series(start, stop, step)
```

### 3.2 ç”Ÿæˆè¿ç»­æ—¶é—´åºåˆ—å®ç°

```sql
-- æ—¶é—´åºåˆ—å¡«å……ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ—¶é—´åºåˆ—å¡«å……';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ—¶é—´åºåˆ—å¡«å……å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH time_series AS (
    SELECT generate_series(
        '2024-01-01'::date,
        '2024-12-31'::date,
        '1 day'::interval
    )::date AS date
),
data_points AS (
    SELECT
        DATE_TRUNC('day', sale_date)::date AS date,
        COUNT(*) AS count,
        SUM(amount) AS amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)::date
)
SELECT
    ts.date,
    COALESCE(dp.count, 0) AS count,
    COALESCE(dp.amount, 0) AS amount
FROM time_series ts
LEFT JOIN data_points dp ON ts.date = dp.date
ORDER BY ts.date;
```

---

### 3.3 å¤šç§å¡«å……æ–¹æ³•

**å¤šç§å¡«å……æ–¹æ³•**å¯¹æ¯”ä¸åŒçš„å¡«å……ç­–ç•¥ã€‚

```sql
-- å¤šç§å¡«å……æ–¹æ³•ï¼šå‰å‘å¡«å……ã€åå‘å¡«å……ã€é›¶å¡«å……ã€æ’å€¼å¡«å……
WITH time_series AS (
    SELECT generate_series(
        '2024-01-01'::date,
        '2024-12-31'::date,
        '1 day'::interval
    )::date AS date
),
data_points AS (
    SELECT
        DATE_TRUNC('day', sale_date)::date AS date,
        SUM(amount) AS amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)::date
),
filled_data AS (
    SELECT
        ts.date,
        dp.amount AS original_amount,
        -- å‰å‘å¡«å……
        COALESCE(
            dp.amount,
            LAG(dp.amount) OVER (ORDER BY ts.date)
        ) AS forward_filled,
        -- åå‘å¡«å……
        COALESCE(
            dp.amount,
            LEAD(dp.amount) OVER (ORDER BY ts.date)
        ) AS backward_filled,
        -- é›¶å¡«å……
        COALESCE(dp.amount, 0) AS zero_filled,
        -- å‡å€¼å¡«å……
        COALESCE(
            dp.amount,
            AVG(dp.amount) OVER ()
        ) AS mean_filled
    FROM time_series ts
    LEFT JOIN data_points dp ON ts.date = dp.date
)
SELECT
    date,
    COALESCE(original_amount, 0) AS original_amount,
    COALESCE(forward_filled, 0) AS forward_filled,
    COALESCE(backward_filled, 0) AS backward_filled,
    zero_filled,
    ROUND(mean_filled::numeric, 2) AS mean_filled
FROM filled_data
ORDER BY date;
```

### 3.4 æ—¶é—´åºåˆ—å¯¹é½

**æ—¶é—´åºåˆ—å¯¹é½**å°†å¤šä¸ªæ—¶é—´åºåˆ—å¯¹é½åˆ°ç›¸åŒçš„æ—¶é—´ç²’åº¦ã€‚

```sql
-- æ—¶é—´åºåˆ—å¯¹é½ï¼šå°†ä¸åŒç²’åº¦çš„æ—¶é—´åºåˆ—å¯¹é½åˆ°å¤©
WITH sales_daily AS (
    SELECT
        DATE_TRUNC('day', sale_date) AS date,
        SUM(amount) AS sales_amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)
),
metrics_hourly AS (
    SELECT
        DATE_TRUNC('day', timestamp) AS date,
        AVG(value) AS avg_metric
    FROM metrics
    GROUP BY DATE_TRUNC('day', timestamp)
),
aligned_series AS (
    SELECT
        COALESCE(s.date, m.date) AS date,
        COALESCE(s.sales_amount, 0) AS sales_amount,
        COALESCE(m.avg_metric, 0) AS avg_metric
    FROM sales_daily s
    FULL OUTER JOIN metrics_hourly m ON s.date = m.date
)
SELECT
    date,
    sales_amount,
    avg_metric,
    -- ç›¸å…³æ€§åˆ†æ
    CORR(sales_amount, avg_metric) OVER () AS correlation
FROM aligned_series
ORDER BY date;
```

---

## 4. é«˜çº§èšåˆæŠ€æœ¯

### 4.1 æ»šåŠ¨æ—¶é—´çª—å£èšåˆ

**æ»šåŠ¨æ—¶é—´çª—å£**ä½¿ç”¨æ—¶é—´èŒƒå›´è€Œéå›ºå®šè¡Œæ•°è¿›è¡Œèšåˆã€‚

```sql
-- æ»šåŠ¨æ—¶é—´çª—å£èšåˆï¼šä½¿ç”¨RANGEæ¡†æ¶
SELECT
    timestamp,
    value,
    AVG(value) OVER (
        ORDER BY timestamp
        RANGE BETWEEN INTERVAL '1 hour' PRECEDING AND CURRENT ROW
    ) AS rolling_avg_1h,
    SUM(value) OVER (
        ORDER BY timestamp
        RANGE BETWEEN INTERVAL '24 hours' PRECEDING AND CURRENT ROW
    ) AS rolling_sum_24h,
    COUNT(*) OVER (
        ORDER BY timestamp
        RANGE BETWEEN INTERVAL '7 days' PRECEDING AND CURRENT ROW
    ) AS rolling_count_7d
FROM metrics
ORDER BY timestamp;
```

### 4.2 åˆ†å±‚æ—¶é—´èšåˆ

**åˆ†å±‚æ—¶é—´èšåˆ**ç”Ÿæˆå¤šä¸ªå±‚æ¬¡çš„æ—¶é—´èšåˆç»“æœã€‚

```sql
-- åˆ†å±‚æ—¶é—´èšåˆï¼šå°æ—¶ã€å¤©ã€å‘¨ã€æœˆã€å¹´
WITH hierarchical_aggregation AS (
    SELECT
        timestamp,
        value,
        DATE_TRUNC('hour', timestamp) AS hour,
        DATE_TRUNC('day', timestamp) AS day,
        DATE_TRUNC('week', timestamp) AS week,
        DATE_TRUNC('month', timestamp) AS month,
        DATE_TRUNC('year', timestamp) AS year
    FROM metrics
)
SELECT
    hour,
    day,
    week,
    month,
    year,
    COUNT(*) AS count,
    AVG(value) AS avg_value,
    SUM(value) AS total_value
FROM hierarchical_aggregation
GROUP BY ROLLUP(year, month, week, day, hour)
ORDER BY year NULLS LAST, month NULLS LAST, week NULLS LAST, day NULLS LAST, hour NULLS LAST;
```

---

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 å¤šæ—¶é—´ç²’åº¦èšåˆ

**å¤šæ—¶é—´ç²’åº¦èšåˆ**åŒæ—¶ç”Ÿæˆå¤šä¸ªæ—¶é—´ç²’åº¦çš„èšåˆç»“æœã€‚

```sql
-- å¤šæ—¶é—´ç²’åº¦èšåˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šæ—¶é—´ç²’åº¦èšåˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šæ—¶é—´ç²’åº¦èšåˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šæ—¶é—´ç²’åº¦èšåˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    DATE_TRUNC('hour', sale_date) AS hour,
    DATE_TRUNC('day', sale_date) AS day,
    DATE_TRUNC('week', sale_date) AS week,
    DATE_TRUNC('month', sale_date) AS month,
    COUNT(*) AS count,
    SUM(amount) AS total_amount
FROM sales
GROUP BY GROUPING SETS (
    (DATE_TRUNC('hour', sale_date)),
    (DATE_TRUNC('day', sale_date)),
    (DATE_TRUNC('week', sale_date)),
    (DATE_TRUNC('month', sale_date))
)
ORDER BY hour NULLS LAST, day NULLS LAST, week NULLS LAST, month NULLS LAST;
```

### 5.2 é”€å”®æ•°æ®å¤šç»´åº¦èšåˆ

**åœºæ™¯**ï¼šæŒ‰å¤šä¸ªæ—¶é—´ç»´åº¦èšåˆé”€å”®æ•°æ®ã€‚

```sql
-- é”€å”®æ•°æ®å¤šç»´åº¦èšåˆï¼šæ—¶é—´ã€äº§å“ã€åœ°åŒº
WITH sales_aggregated AS (
    SELECT
        DATE_TRUNC('day', order_date) AS order_day,
        DATE_TRUNC('week', order_date) AS order_week,
        DATE_TRUNC('month', order_date) AS order_month,
        product_id,
        region_id,
        SUM(order_amount) AS total_amount,
        COUNT(*) AS order_count,
        AVG(order_amount) AS avg_amount
    FROM orders
    GROUP BY
        DATE_TRUNC('day', order_date),
        DATE_TRUNC('week', order_date),
        DATE_TRUNC('month', order_date),
        product_id,
        region_id
)
SELECT
    order_day,
    order_week,
    order_month,
    product_id,
    region_id,
    total_amount,
    order_count,
    avg_amount,
    -- æ—¶é—´ç»´åº¦æ±‡æ€»
    SUM(total_amount) OVER (PARTITION BY order_month) AS monthly_total,
    SUM(total_amount) OVER (PARTITION BY order_week) AS weekly_total,
    -- äº§å“ç»´åº¦æ±‡æ€»
    SUM(total_amount) OVER (PARTITION BY product_id, order_month) AS product_monthly_total,
    -- åœ°åŒºç»´åº¦æ±‡æ€»
    SUM(total_amount) OVER (PARTITION BY region_id, order_month) AS region_monthly_total
FROM sales_aggregated
ORDER BY order_month, order_week, order_day, product_id, region_id;
```

### 5.3 ç½‘ç«™æµé‡æ—¶é—´èšåˆåˆ†æ

**åœºæ™¯**ï¼šæŒ‰ä¸åŒæ—¶é—´ç²’åº¦èšåˆç½‘ç«™æµé‡æ•°æ®ã€‚

```sql
-- ç½‘ç«™æµé‡æ—¶é—´èšåˆåˆ†æï¼šåˆ†é’Ÿã€å°æ—¶ã€å¤©ã€å‘¨
WITH traffic_aggregated AS (
    SELECT
        DATE_TRUNC('minute', visit_time) AS minute,
        DATE_TRUNC('hour', visit_time) AS hour,
        DATE_TRUNC('day', visit_time) AS day,
        DATE_TRUNC('week', visit_time) AS week,
        COUNT(*) AS page_views,
        COUNT(DISTINCT user_id) AS unique_visitors,
        COUNT(DISTINCT session_id) AS sessions
    FROM page_views
    GROUP BY
        DATE_TRUNC('minute', visit_time),
        DATE_TRUNC('hour', visit_time),
        DATE_TRUNC('day', visit_time),
        DATE_TRUNC('week', visit_time)
)
SELECT
    minute,
    hour,
    day,
    week,
    page_views,
    unique_visitors,
    sessions,
    -- æ—¶é—´ç²’åº¦æ±‡æ€»
    SUM(page_views) OVER (PARTITION BY hour) AS hourly_page_views,
    SUM(page_views) OVER (PARTITION BY day) AS daily_page_views,
    SUM(page_views) OVER (PARTITION BY week) AS weekly_page_views,
    -- å¢é•¿ç‡
    (page_views - LAG(page_views) OVER (PARTITION BY hour ORDER BY minute)) /
    NULLIF(LAG(page_views) OVER (PARTITION BY hour ORDER BY minute), 0) * 100 AS minute_over_minute_growth
FROM traffic_aggregated
ORDER BY minute;
```

### 5.4 é‡‘èæ•°æ®æ—¶é—´æ¡¶åˆ†æ

**åœºæ™¯**ï¼šä½¿ç”¨æ—¶é—´æ¡¶åˆ†æé‡‘èäº¤æ˜“æ•°æ®ã€‚

```sql
-- é‡‘èæ•°æ®æ—¶é—´æ¡¶åˆ†æï¼š15åˆ†é’Ÿã€1å°æ—¶ã€4å°æ—¶ã€1å¤©
WITH transaction_buckets AS (
    SELECT
        transaction_time,
        amount,
        date_bin('15 minutes', transaction_time, '2024-01-01 00:00:00'::timestamp) AS bucket_15min,
        date_bin('1 hour', transaction_time, '2024-01-01 00:00:00'::timestamp) AS bucket_1h,
        date_bin('4 hours', transaction_time, '2024-01-01 00:00:00'::timestamp) AS bucket_4h,
        date_bin('1 day', transaction_time, '2024-01-01 00:00:00'::timestamp) AS bucket_1d
    FROM transactions
)
SELECT
    bucket_15min,
    bucket_1h,
    bucket_4h,
    bucket_1d,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount,
    MIN(amount) AS min_amount,
    MAX(amount) AS max_amount,
    STDDEV(amount) AS stddev_amount
FROM transaction_buckets
GROUP BY bucket_15min, bucket_1h, bucket_4h, bucket_1d
ORDER BY bucket_15min;
```

---

## 6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 æ—¶é—´èšåˆæ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|-----------|-----------|---------|------|------|
| **DATE_TRUNC** | $O(n)$ | $O(k)$ | å›ºå®šç²’åº¦ | ç®€å•å¿«é€Ÿ | ç²’åº¦å›ºå®š |
| **date_bin** | $O(n)$ | $O(k)$ | è‡ªå®šä¹‰ç²’åº¦ | çµæ´» | PostgreSQL 14+ |
| **æ—¶é—´å¡«å……** | $O(n+m)$ | $O(m)$ | è¿ç»­åºåˆ— | å®Œæ•´åºåˆ— | è®¡ç®—å¤æ‚ |
| **GROUPING SETS** | $O(nk)$ | $O(k)$ | å¤šç²’åº¦ | ä¸€æ¬¡æŸ¥è¯¢ | ç»“æœå¤æ‚ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è®¡ç®—ä¼˜åŒ–**ï¼š
   - åˆ›å»ºæ—¶é—´ç´¢å¼•
   - ä½¿ç”¨åˆ†åŒºè¡¨
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾

2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - é™åˆ¶æ—¶é—´èŒƒå›´
   - ä½¿ç”¨å¹¶è¡Œå¤„ç†
   - ä¼˜åŒ–GROUP BY

3. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - é¢„èšåˆæ•°æ®
   - ä½¿ç”¨æ—¶é—´åºåˆ—æ•°æ®åº“
   - å‹ç¼©å†å²æ•°æ®

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šæ—¶é—´ç²’åº¦é€‰æ‹©å›°éš¾

- **è§£å†³æ–¹æ¡ˆ**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ã€ä½¿ç”¨å¤šç§ç²’åº¦å¯¹æ¯”ã€è€ƒè™‘æ•°æ®ç‰¹å¾

**é—®é¢˜2**ï¼šç¼ºå¤±å€¼å¤„ç†

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ—¶é—´å¡«å……ã€é€‰æ‹©åˆé€‚çš„å¡«å……æ–¹æ³•ã€æ ‡è®°ç¼ºå¤±å€¼

**é—®é¢˜3**ï¼šæ—¶åŒºé—®é¢˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€æ—¶åŒºã€ä½¿ç”¨TIMESTAMPTZã€æ˜ç¡®æ—¶åŒºè½¬æ¢

**é—®é¢˜4**ï¼šæ€§èƒ½é—®é¢˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºç´¢å¼•ã€ä½¿ç”¨åˆ†åŒºè¡¨ã€ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ—¶é—´ç²’åº¦é€‰æ‹©

1. **ä¸šåŠ¡éœ€æ±‚**ï¼š
   - å®æ—¶ç›‘æ§ï¼šåˆ†é’Ÿã€å°æ—¶
   - æ—¥å¸¸æŠ¥è¡¨ï¼šå¤©ã€å‘¨
   - é•¿æœŸåˆ†æï¼šæœˆã€å¹´

2. **æ•°æ®ç‰¹å¾**ï¼š
   - é«˜é¢‘æ•°æ®ï¼šç»†ç²’åº¦
   - ä½é¢‘æ•°æ®ï¼šç²—ç²’åº¦
   - å‘¨æœŸæ€§æ•°æ®ï¼šåŒ¹é…å‘¨æœŸ

3. **å­˜å‚¨è€ƒè™‘**ï¼š
   - ç»†ç²’åº¦ï¼šå­˜å‚¨æˆæœ¬é«˜
   - ç²—ç²’åº¦ï¼šä¿¡æ¯æŸå¤±
   - å¹³è¡¡ï¼šå¤šç²’åº¦å­˜å‚¨

### 7.2 æ—¶é—´èšåˆæ³¨æ„äº‹é¡¹

1. **æ•°æ®è´¨é‡**ï¼š
   - å¤„ç†ç¼ºå¤±å€¼
   - è¯†åˆ«å¼‚å¸¸å€¼
   - éªŒè¯æ—¶é—´æˆ³

2. **æ—¶åŒºå¤„ç†**ï¼š
   - ç»Ÿä¸€æ—¶åŒº
   - æ˜ç¡®æ—¶åŒºè½¬æ¢
   - è€ƒè™‘å¤ä»¤æ—¶

3. **è¾¹ç•Œå¤„ç†**ï¼š
   - å¤„ç†æ—¶é—´è¾¹ç•Œ
   - å¤„ç†ä¸å®Œæ•´å‘¨æœŸ
   - å¤„ç†æ—¶åŒºè¾¹ç•Œ

### 7.3 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼š
   - åˆ›å»ºæ—¶é—´ç´¢å¼•
   - ä½¿ç”¨åˆ†åŒºè¡¨
   - ä¼˜åŒ–GROUP BY

2. **å‡†ç¡®æ€§**ï¼š
   - å¤„ç†æ—¶åŒºé—®é¢˜
   - å¤„ç†è¾¹ç•Œæƒ…å†µ
   - éªŒè¯è®¡ç®—ç»“æœ

3. **å¯ç»´æŠ¤æ€§**ï¼š
   - ä½¿ç”¨æ¸…æ™°çš„å˜é‡å
   - æ·»åŠ æ³¨é‡Š
   - æ¨¡å—åŒ–è®¾è®¡

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

1. **ã€Šæ—¶é—´åºåˆ—åˆ†æã€‹**ï¼ˆHamilton, J. D., 1994ï¼‰- æ—¶é—´åºåˆ—èšåˆç†è®º

2. **ã€Šåº”ç”¨æ—¶é—´åºåˆ—åˆ†æã€‹**ï¼ˆç‹ç‡•, 2015ï¼‰- æ—¶é—´ç²’åº¦é€‰æ‹©

3. **ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹**ï¼ˆSilberschatz, A., et al., 2019ï¼‰- èšåˆæŸ¥è¯¢ä¼˜åŒ–

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- **æ—¥æœŸæ—¶é—´å‡½æ•°**: <https://www.postgresql.org/docs/current/functions-datetime.html>
- **èšåˆå‡½æ•°**: <https://www.postgresql.org/docs/current/functions-aggregate.html>
- **çª—å£å‡½æ•°**: <https://www.postgresql.org/docs/current/tutorial-window.html>
- **date_binå‡½æ•°**: <https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-BIN>

### åœ¨çº¿èµ„æº

- **æ—¶é—´åºåˆ—èšåˆ**: <https://en.wikipedia.org/wiki/Time_series>
- **æ—¶é—´æ¡¶**: <https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-BIN>
- **GROUPING SETS**: <https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-GROUPING-SETS>

### ç›¸å…³ç®—æ³•

- **æ—¶é—´åºåˆ—é¢„æµ‹**ï¼šåŸºäºèšåˆæ•°æ®çš„é¢„æµ‹
- **è¶‹åŠ¿åˆ†æ**ï¼šä½¿ç”¨èšåˆæ•°æ®è¯†åˆ«è¶‹åŠ¿
- **å‘¨æœŸæ€§åˆ†æ**ï¼šåŸºäºæ—¶é—´èšåˆçš„å‘¨æœŸæ€§æ£€æµ‹
- **æ»‘åŠ¨çª—å£è®¡ç®—**ï¼šæ—¶é—´çª—å£èšåˆ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
