# PostgreSQL ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç´¢å¼•ç®—æ³• | æŸ¥è¯¢ä¼˜åŒ–
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç´¢å¼•ç®—æ³•æ¦‚è¿°](#ç´¢å¼•ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [ç´¢å¼•çš„ä½œç”¨](#ç´¢å¼•çš„ä½œç”¨)
      - [ç´¢å¼•çš„ä»£ä»·](#ç´¢å¼•çš„ä»£ä»·)
      - [ç´¢å¼•é€‰æ‹©åŸåˆ™](#ç´¢å¼•é€‰æ‹©åŸåˆ™)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. B-Treeç´¢å¼•](#1-b-treeç´¢å¼•)
    - [1.1 B-Treeç´¢å¼•åŸç†](#11-b-treeç´¢å¼•åŸç†)
      - [B-Treeç»“æ„](#b-treeç»“æ„)
      - [æŸ¥è¯¢æ“ä½œ](#æŸ¥è¯¢æ“ä½œ)
      - [B-Treeä¼˜åŠ¿](#b-treeä¼˜åŠ¿)
    - [1.2 B-Treeç´¢å¼•åˆ†æå®ç°](#12-b-treeç´¢å¼•åˆ†æå®ç°)
  - [2. å…¶ä»–ç´¢å¼•ç±»å‹](#2-å…¶ä»–ç´¢å¼•ç±»å‹)
    - [2.1 Hashç´¢å¼•](#21-hashç´¢å¼•)
      - [Hashç´¢å¼•åŸç†](#hashç´¢å¼•åŸç†)
      - [Hashç´¢å¼•é™åˆ¶](#hashç´¢å¼•é™åˆ¶)
    - [2.2 GINç´¢å¼•](#22-ginç´¢å¼•)
      - [GINç´¢å¼•åŸç†](#ginç´¢å¼•åŸç†)
    - [2.3 GiSTç´¢å¼•](#23-gistç´¢å¼•)
      - [GiSTç´¢å¼•åŸç†](#gistç´¢å¼•åŸç†)
    - [2.4 BRINç´¢å¼•](#24-brinç´¢å¼•)
      - [BRINç´¢å¼•åŸç†](#brinç´¢å¼•åŸç†)
  - [3. ç´¢å¼•é€‰æ‹©](#3-ç´¢å¼•é€‰æ‹©)
    - [3.1 ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ](#31-ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ)
  - [4. ç´¢å¼•ä¼˜åŒ–](#4-ç´¢å¼•ä¼˜åŒ–)
    - [4.1 ç´¢å¼•è†¨èƒ€æ£€æµ‹](#41-ç´¢å¼•è†¨èƒ€æ£€æµ‹)
      - [è†¨èƒ€æ£€æµ‹æ–¹æ³•](#è†¨èƒ€æ£€æµ‹æ–¹æ³•)
    - [4.2 ç´¢å¼•é‡å»ºå»ºè®®å®ç°](#42-ç´¢å¼•é‡å»ºå»ºè®®å®ç°)
  - [5. PostgreSQL 18 å¹¶è¡Œç´¢å¼•æ“ä½œå¢å¼º](#5-postgresql-18-å¹¶è¡Œç´¢å¼•æ“ä½œå¢å¼º)
    - [5.1 å¹¶è¡Œç´¢å¼•æ“ä½œåŸç†](#51-å¹¶è¡Œç´¢å¼•æ“ä½œåŸç†)
    - [5.2 å¹¶è¡Œç´¢å¼•æ‰«æ](#52-å¹¶è¡Œç´¢å¼•æ‰«æ)
    - [5.3 å¹¶è¡Œç´¢å¼•æ„å»º](#53-å¹¶è¡Œç´¢å¼•æ„å»º)
    - [5.4 å¹¶è¡ŒGINç´¢å¼•æ“ä½œ](#54-å¹¶è¡Œginç´¢å¼•æ“ä½œ)
    - [5.5 å¹¶è¡Œç´¢å¼•ç»´æŠ¤](#55-å¹¶è¡Œç´¢å¼•ç»´æŠ¤)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 ç´¢å¼•æ€§èƒ½ä¼˜åŒ–](#61-ç´¢å¼•æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [8.1 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰](#81-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨å¢å¼º)
    - [8.2 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰](#82-é«˜çº§ä¼˜åŒ–æŠ€å·§å¢å¼º)

---

## ç´¢å¼•ç®—æ³•æ¦‚è¿°

**ç´¢å¼•ï¼ˆIndexï¼‰**æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç”¨äºåŠ é€Ÿæ•°æ®æ£€ç´¢çš„æ•°æ®ç»“æ„ã€‚PostgreSQLæ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼Œæ¯ç§ç±»å‹é’ˆå¯¹ä¸åŒçš„æŸ¥è¯¢æ¨¡å¼è¿›è¡Œäº†ä¼˜åŒ–ã€‚æ­£ç¡®é€‰æ‹©å’Œè®¾è®¡ç´¢å¼•æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚

### ç†è®ºåŸºç¡€

#### ç´¢å¼•çš„ä½œç”¨

1. **åŠ é€ŸæŸ¥è¯¢**ï¼šé¿å…å…¨è¡¨æ‰«æï¼Œå¿«é€Ÿå®šä½æ•°æ®
2. **åŠ é€Ÿæ’åº**ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œé¿å…æ’åºæ“ä½œ
3. **åŠ é€Ÿè¿æ¥**ï¼šåŠ é€ŸJOINæ“ä½œ
4. **å”¯ä¸€æ€§çº¦æŸ**ï¼šä¿è¯æ•°æ®å”¯ä¸€æ€§
5. **åŠ é€Ÿèšåˆ**ï¼šæ”¯æŒç´¢å¼•æ‰«æè¿›è¡Œèšåˆ

#### ç´¢å¼•çš„ä»£ä»·

1. **å­˜å‚¨ç©ºé—´**ï¼šç´¢å¼•éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´
2. **ç»´æŠ¤æˆæœ¬**ï¼šINSERT/UPDATE/DELETEéœ€è¦æ›´æ–°ç´¢å¼•
3. **é€‰æ‹©æˆæœ¬**ï¼šä¼˜åŒ–å™¨éœ€è¦é€‰æ‹©ä½¿ç”¨å“ªä¸ªç´¢å¼•

#### ç´¢å¼•é€‰æ‹©åŸåˆ™

- **é«˜é€‰æ‹©æ€§**ï¼šç´¢å¼•åˆ—çš„å€¼åˆ†å¸ƒå¹¿æ³›
- **é¢‘ç¹æŸ¥è¯¢**ï¼šç»å¸¸åœ¨WHEREã€JOINã€ORDER BYä¸­ä½¿ç”¨
- **æ›´æ–°é¢‘ç‡ä½**ï¼šé¿å…é¢‘ç¹æ›´æ–°çš„åˆ—
- **æ•°æ®é‡å¤§**ï¼šå°è¡¨é€šå¸¸ä¸éœ€è¦ç´¢å¼•

### æ ¸å¿ƒç®—æ³•

| ç´¢å¼•ç±»å‹ | ç”¨é€” | æŸ¥è¯¢å¤æ‚åº¦ | ç»´æŠ¤å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|------|-----------|-----------|---------|
| **B-Tree** | èŒƒå›´æŸ¥è¯¢ã€æ’åº | $O(\log n)$ | $O(\log n)$ | é€šç”¨ç´¢å¼•ï¼Œé»˜è®¤ç±»å‹ |
| **Hash** | ç­‰å€¼æŸ¥è¯¢ | $O(1)$ | $O(1)$ | ç²¾ç¡®åŒ¹é…ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ |
| **GIN** | å…¨æ–‡æœç´¢ã€æ•°ç»„ | $O(\log n)$ | $O(\log n)$ | å…¨æ–‡æœç´¢ã€æ•°ç»„æŸ¥è¯¢ |
| **GiST** | ç©ºé—´æ•°æ®ã€è‡ªå®šä¹‰ç±»å‹ | $O(\log n)$ | $O(\log n)$ | åœ°ç†æ•°æ®ã€èŒƒå›´ç±»å‹ |
| **BRIN** | å¤§è¡¨èŒƒå›´æŸ¥è¯¢ | $O(\log n)$ | $O(1)$ | å¤§è¡¨ã€æœ‰åºæ•°æ® |
| **SP-GiST** | éå¹³è¡¡æ•°æ®ç»“æ„ | $O(\log n)$ | $O(\log n)$ | éå¹³è¡¡æ ‘ç»“æ„ |

---

## 1. B-Treeç´¢å¼•

### 1.1 B-Treeç´¢å¼•åŸç†

**B-Treeï¼ˆBalanced Treeï¼‰ç´¢å¼•**æ˜¯PostgreSQLçš„é»˜è®¤ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºå¤§å¤šæ•°æŸ¥è¯¢åœºæ™¯ã€‚

#### B-Treeç»“æ„

**B-Treeç‰¹æ€§**ï¼š

- **å¹³è¡¡æ ‘**ï¼šæ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚
- **æœ‰åºæ€§**ï¼šèŠ‚ç‚¹å†…æœ‰åºï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
- **å¤šè·¯æœç´¢**ï¼šæ¯ä¸ªèŠ‚ç‚¹æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå‡å°‘æ ‘é«˜åº¦

**B-TreeèŠ‚ç‚¹ç»“æ„**ï¼š

- **å†…éƒ¨èŠ‚ç‚¹**ï¼šå­˜å‚¨é”®å€¼å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆ
- **å¶å­èŠ‚ç‚¹**ï¼šå­˜å‚¨é”®å€¼å’ŒæŒ‡å‘æ•°æ®è¡Œçš„æŒ‡é’ˆï¼ˆTIDï¼‰

#### æŸ¥è¯¢æ“ä½œ

**ç­‰å€¼æŸ¥è¯¢**ï¼š

1. ä»æ ¹èŠ‚ç‚¹å¼€å§‹
2. æ ¹æ®é”®å€¼é€‰æ‹©å­èŠ‚ç‚¹
3. é€’å½’åˆ°å¶å­èŠ‚ç‚¹
4. åœ¨å¶å­èŠ‚ç‚¹ä¸­æ‰¾åˆ°åŒ¹é…çš„TID
5. é€šè¿‡TIDè®¿é—®æ•°æ®è¡Œ

**èŒƒå›´æŸ¥è¯¢**ï¼š

1. æ‰¾åˆ°èŒƒå›´çš„èµ·å§‹é”®å€¼
2. é¡ºåºæ‰«æå¶å­èŠ‚ç‚¹
3. ç›´åˆ°èŒƒå›´çš„ç»“æŸé”®å€¼

**æ—¶é—´å¤æ‚åº¦**ï¼š$O(\log n)$ï¼Œå…¶ä¸­$n$æ˜¯ç´¢å¼•é¡¹æ•°é‡ã€‚

#### B-Treeä¼˜åŠ¿

1. **é€šç”¨æ€§å¼º**ï¼šæ”¯æŒç­‰å€¼ã€èŒƒå›´ã€æ’åºæŸ¥è¯¢
2. **ç¨³å®šæ€§å¥½**ï¼šæ€§èƒ½ç¨³å®šï¼Œä¸å—æ•°æ®åˆ†å¸ƒå½±å“
3. **ç»´æŠ¤ç®€å•**ï¼šè‡ªåŠ¨å¹³è¡¡ï¼Œç»´æŠ¤æˆæœ¬ä½

### 1.2 B-Treeç´¢å¼•åˆ†æå®ç°

```sql
-- åˆ›å»ºç´¢å¼•ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE index_usage_stats CASCADE;
        END IF;

        CREATE TABLE index_usage_stats (
            index_name VARCHAR(100) NOT NULL,
            table_name VARCHAR(100) NOT NULL,
            index_size_bytes BIGINT NOT NULL,
            index_scans BIGINT NOT NULL,
            tuples_read BIGINT NOT NULL,
            tuples_fetched BIGINT NOT NULL,
            PRIMARY KEY (index_name, table_name)
        );

        INSERT INTO index_usage_stats (index_name, table_name, index_size_bytes, index_scans, tuples_read, tuples_fetched) VALUES
            ('idx_user_email', 'users', 1048576, 10000, 10000, 10000),
            ('idx_order_date', 'orders', 5242880, 5000, 50000, 5000),
            ('idx_product_category', 'products', 2097152, 2000, 20000, 2000);

        RAISE NOTICE 'è¡¨ index_usage_stats åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ index_usage_stats å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ç´¢å¼•ä½¿ç”¨ç‡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•ä½¿ç”¨ç‡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS index_size_mb,
    index_scans,
    tuples_read,
    tuples_fetched,
    CASE
        WHEN index_scans = 0 THEN 0
        ELSE ROUND((tuples_fetched::numeric / NULLIF(tuples_read, 0))::numeric, 4)
    END AS selectivity_ratio,
    CASE
        WHEN index_scans = 0 THEN 'Unused - Consider dropping'
        WHEN tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.1 THEN 'Low Selectivity - Review'
        WHEN index_size_bytes > 100000000 AND index_scans < 100 THEN 'Large Unused - Consider optimization'
        ELSE 'Good'
    END AS index_status
FROM index_usage_stats
ORDER BY index_scans DESC, index_size_bytes DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    index_name,
    SUM(index_scans) AS total_scans
FROM index_usage_stats
GROUP BY index_name;
```

---

## 2. å…¶ä»–ç´¢å¼•ç±»å‹

### 2.1 Hashç´¢å¼•

**Hashç´¢å¼•**ä½¿ç”¨å“ˆå¸Œè¡¨å®ç°ï¼Œé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢ã€‚

#### Hashç´¢å¼•åŸç†

**å“ˆå¸Œå‡½æ•°**ï¼š
$$h(key) = key \bmod m$$

å…¶ä¸­$m$æ˜¯å“ˆå¸Œè¡¨å¤§å°ã€‚

**æŸ¥è¯¢æ“ä½œ**ï¼š

1. è®¡ç®—é”®å€¼çš„å“ˆå¸Œå€¼
2. åœ¨å“ˆå¸Œæ¡¶ä¸­æŸ¥æ‰¾
3. è¿”å›åŒ¹é…çš„TID

**æ—¶é—´å¤æ‚åº¦**ï¼šå¹³å‡$O(1)$ï¼Œæœ€å$O(n)$ï¼ˆå“ˆå¸Œå†²çªæ—¶ï¼‰ã€‚

#### Hashç´¢å¼•é™åˆ¶

- **åªæ”¯æŒç­‰å€¼æŸ¥è¯¢**ï¼šä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€æ’åº
- **ä¸æ”¯æŒå”¯ä¸€çº¦æŸ**ï¼šä¸èƒ½ç”¨äºå”¯ä¸€ç´¢å¼•
- **ä¸é€‚ç”¨äºé¢‘ç¹æ›´æ–°**ï¼šå“ˆå¸Œå†²çªå¤„ç†å¤æ‚

### 2.2 GINç´¢å¼•

**GINï¼ˆGeneralized Inverted Indexï¼‰ç´¢å¼•**é€‚ç”¨äºå…¨æ–‡æœç´¢å’Œæ•°ç»„æŸ¥è¯¢ã€‚

#### GINç´¢å¼•åŸç†

**å€’æ’ç´¢å¼•ç»“æ„**ï¼š

- **è¯é¡¹ï¼ˆTermï¼‰** â†’ **æ–‡æ¡£åˆ—è¡¨ï¼ˆPosting Listï¼‰**
- æ”¯æŒå¤šå€¼å±æ€§ï¼ˆå¦‚æ•°ç»„ã€å…¨æ–‡ï¼‰

**æŸ¥è¯¢æ“ä½œ**ï¼š

1. æŸ¥æ‰¾è¯é¡¹çš„å€’æ’åˆ—è¡¨
2. åˆå¹¶å¤šä¸ªå€’æ’åˆ—è¡¨ï¼ˆAND/ORæ“ä½œï¼‰
3. è¿”å›åŒ¹é…çš„æ–‡æ¡£

**é€‚ç”¨åœºæ™¯**ï¼š

- å…¨æ–‡æœç´¢ï¼ˆtsvectorï¼‰
- æ•°ç»„åŒ…å«æŸ¥è¯¢ï¼ˆ@>ã€<@ï¼‰
- JSONBæŸ¥è¯¢

### 2.3 GiSTç´¢å¼•

**GiSTï¼ˆGeneralized Search Treeï¼‰ç´¢å¼•**æ˜¯é€šç”¨æœç´¢æ ‘ï¼Œæ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹ã€‚

#### GiSTç´¢å¼•åŸç†

**ç©ºé—´åˆ†å‰²**ï¼š

- å°†æ•°æ®ç©ºé—´åˆ†å‰²æˆåŒºåŸŸ
- æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªåŒºåŸŸ
- æ”¯æŒé‡å åŒºåŸŸ

**é€‚ç”¨åœºæ™¯**ï¼š

- åœ°ç†æ•°æ®ï¼ˆPostGISï¼‰
- èŒƒå›´ç±»å‹ï¼ˆrangeï¼‰
- è‡ªå®šä¹‰æ•°æ®ç±»å‹

### 2.4 BRINç´¢å¼•

**BRINï¼ˆBlock Range Indexï¼‰ç´¢å¼•**é€‚ç”¨äºå¤§è¡¨çš„èŒƒå›´æŸ¥è¯¢ã€‚

#### BRINç´¢å¼•åŸç†

**å—èŒƒå›´æ‘˜è¦**ï¼š

- æ¯ä¸ªç´¢å¼•é¡¹å¯¹åº”ä¸€ä¸ªæ•°æ®å—èŒƒå›´
- å­˜å‚¨è¯¥èŒƒå›´çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
- ç©ºé—´å ç”¨æå°

**é€‚ç”¨åœºæ™¯**ï¼š

- å¤§è¡¨ï¼ˆç™¾ä¸‡è¡Œä»¥ä¸Šï¼‰
- æ•°æ®æœ‰åºæˆ–è¿‘ä¼¼æœ‰åº
- èŒƒå›´æŸ¥è¯¢

**ä¼˜åŠ¿**ï¼šç©ºé—´å ç”¨æå°ï¼Œç»´æŠ¤æˆæœ¬ä½
**åŠ£åŠ¿**ï¼šæŸ¥è¯¢æ—¶éœ€è¦æ‰«ææ›´å¤šæ•°æ®å—

## 3. ç´¢å¼•é€‰æ‹©

### 3.1 ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ

**ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ**è¯„ä¼°å“ªäº›ç´¢å¼•è¢«é¢‘ç¹ä½¿ç”¨ï¼Œè¯†åˆ«æœªä½¿ç”¨çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä½¿ç”¨ç‡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•ä½¿ç”¨ç‡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç´¢å¼•ä½¿ç”¨æ•ˆç‡
WITH index_efficiency AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS efficiency_ratio,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE index_size_bytes::numeric / NULLIF(index_scans, 0)
        END AS bytes_per_scan
    FROM index_usage_stats
)
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS size_mb,
    index_scans,
    ROUND(efficiency_ratio::numeric, 4) AS efficiency_ratio,
    ROUND(bytes_per_scan::numeric, 0) AS bytes_per_scan,
    CASE
        WHEN index_scans = 0 THEN 'Unused'
        WHEN efficiency_ratio < 0.1 THEN 'Low Efficiency'
        WHEN bytes_per_scan > 1000000 THEN 'High Cost per Scan'
        ELSE 'Efficient'
    END AS efficiency_status
FROM index_efficiency
ORDER BY efficiency_ratio ASC, bytes_per_scan DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    table_name,
    COUNT(*) AS index_count,
    SUM(index_scans) AS total_scans
FROM index_usage_stats
GROUP BY table_name;
```

---

## 4. ç´¢å¼•ä¼˜åŒ–

### 4.1 ç´¢å¼•è†¨èƒ€æ£€æµ‹

**ç´¢å¼•è†¨èƒ€ï¼ˆIndex Bloatï¼‰**æ˜¯æŒ‡ç´¢å¼•å ç”¨çš„ç©ºé—´è¿œå¤§äºå®é™…éœ€è¦ï¼Œé€šå¸¸ç”±é¢‘ç¹çš„UPDATEå’ŒDELETEæ“ä½œå¼•èµ·ã€‚

#### è†¨èƒ€æ£€æµ‹æ–¹æ³•

**pg_stat_user_indexesè§†å›¾**ï¼š

- `idx_scan`ï¼šç´¢å¼•æ‰«ææ¬¡æ•°
- `idx_tup_read`ï¼šé€šè¿‡ç´¢å¼•è¯»å–çš„å…ƒç»„æ•°
- `idx_tup_fetch`ï¼šé€šè¿‡ç´¢å¼•è·å–çš„å…ƒç»„æ•°

**è†¨èƒ€ä¼°ç®—**ï¼š
$$Bloat = 1 - \frac{idx\_tup\_fetch}{idx\_tup\_read}$$

### 4.2 ç´¢å¼•é‡å»ºå»ºè®®å®ç°

```sql
-- ç´¢å¼•é‡å»ºå»ºè®®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•é‡å»ºå»ºè®®ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿæˆç´¢å¼•ç»´æŠ¤å»ºè®®
WITH index_analysis AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS bloat_estimate
    FROM index_usage_stats
)
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS current_size_mb,
    index_scans,
    ROUND(bloat_estimate::numeric, 4) AS bloat_estimate,
    CASE
        WHEN index_scans = 0 THEN 'DROP INDEX ' || index_name || ';'
        WHEN bloat_estimate < 0.3 AND index_size_bytes > 10485760 THEN 'REINDEX INDEX ' || index_name || ';'
        WHEN index_scans < 10 AND index_size_bytes > 5242880 THEN 'Consider dropping: Low usage'
        ELSE 'No action needed'
    END AS maintenance_action,
    CASE
        WHEN index_scans = 0 THEN 'High'
        WHEN bloat_estimate < 0.3 AND index_size_bytes > 10485760 THEN 'Medium'
        ELSE 'Low'
    END AS priority
FROM index_analysis
WHERE index_scans = 0 OR (bloat_estimate < 0.3 AND index_size_bytes > 10485760)
ORDER BY
    CASE priority WHEN 'High' THEN 1 WHEN 'Medium' THEN 2 ELSE 3 END,
    index_size_bytes DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) AS indexes_needing_maintenance
FROM index_usage_stats
WHERE index_scans = 0 OR (tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.3 AND index_size_bytes > 10485760);
```

---

## 5. PostgreSQL 18 å¹¶è¡Œç´¢å¼•æ“ä½œå¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œç´¢å¼•æ“ä½œèƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œç´¢å¼•æ‰«æã€å¹¶è¡Œç´¢å¼•æ„å»ºå’Œå¹¶è¡Œç´¢å¼•ç»´æŠ¤ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡ç´¢å¼•æ“ä½œçš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œç´¢å¼•æ“ä½œåŸç†

PostgreSQL 18 çš„å¹¶è¡Œç´¢å¼•æ“ä½œé€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æè¡¨æ•°æ®
2. **å¹¶è¡Œç´¢å¼•æ„å»º**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ„å»ºéƒ¨åˆ†ç´¢å¼•
3. **å¹¶è¡Œç´¢å¼•ç»´æŠ¤**ï¼šå¹¶è¡Œæ‰§è¡Œç´¢å¼•é‡å»ºå’Œä¼˜åŒ–
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„ç´¢å¼•ç»“æœ

### 5.2 å¹¶è¡Œç´¢å¼•æ‰«æ

```sql
-- PostgreSQL 18 å¹¶è¡Œç´¢å¼•æ‰«æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œç´¢å¼•æ‰«æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œç´¢å¼•æ‰«æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œç´¢å¼•æ‰«æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œç´¢å¼•æ‰«æï¼šä½¿ç”¨B-Treeç´¢å¼•è¿›è¡ŒèŒƒå›´æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    column1,
    column2
FROM large_table
WHERE column1 BETWEEN 1000 AND 10000
ORDER BY column1
LIMIT 1000;
```

### 5.3 å¹¶è¡Œç´¢å¼•æ„å»º

```sql
-- PostgreSQL 18 å¹¶è¡Œç´¢å¼•æ„å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œç´¢å¼•æ„å»º';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œç´¢å¼•æ„å»º';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œç´¢å¼•æ„å»ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;
SET maintenance_work_mem = '1GB';

-- å¹¶è¡Œç´¢å¼•æ„å»ºï¼šåˆ›å»ºB-Treeç´¢å¼•
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_large_table_column1
ON large_table(column1);

-- éªŒè¯å¹¶è¡Œç´¢å¼•æ„å»ºæ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT COUNT(*)
FROM large_table
WHERE column1 IS NOT NULL;
```

### 5.4 å¹¶è¡ŒGINç´¢å¼•æ“ä½œ

```sql
-- PostgreSQL 18 å¹¶è¡ŒGINç´¢å¼•æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒGINç´¢å¼•æ“ä½œ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒGINç´¢å¼•æ“ä½œ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒGINç´¢å¼•æ“ä½œå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒGINç´¢å¼•æ‰«æï¼šå…¨æ–‡æœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content
FROM documents
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
ORDER BY ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) DESC
LIMIT 20;
```

### 5.5 å¹¶è¡Œç´¢å¼•ç»´æŠ¤

```sql
-- PostgreSQL 18 å¹¶è¡Œç´¢å¼•ç»´æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œç´¢å¼•ç»´æŠ¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œç´¢å¼•ç»´æŠ¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œç´¢å¼•ç»´æŠ¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;
SET maintenance_work_mem = '1GB';

-- å¹¶è¡Œç´¢å¼•é‡å»ºï¼šä½¿ç”¨REINDEX CONCURRENTLY
REINDEX INDEX CONCURRENTLY idx_large_table_column1;

-- å¹¶è¡Œç´¢å¼•åˆ†æï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE large_table;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 ç´¢å¼•æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•æ€§èƒ½ä¼˜åŒ–**ç»¼åˆä¼˜åŒ–ç´¢å¼•ç­–ç•¥ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚

```sql
-- ç´¢å¼•æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç´¢å¼•æ€§èƒ½ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç´¢å¼•æ€§èƒ½ä¼˜åŒ–åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•æ€§èƒ½ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆç´¢å¼•ä¼˜åŒ–å»ºè®®
WITH index_metrics AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS selectivity,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE index_size_bytes::numeric / NULLIF(index_scans, 0)
        END AS cost_per_scan
    FROM index_usage_stats
),
optimization_recommendations AS (
    SELECT
        index_name,
        table_name,
        ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS size_mb,
        index_scans,
        ROUND(selectivity::numeric, 4) AS selectivity,
        ROUND(cost_per_scan::numeric, 0) AS cost_per_scan,
        CASE
            WHEN index_scans = 0 THEN 'DROP'
            WHEN selectivity < 0.05 AND index_size_bytes > 5242880 THEN 'REINDEX'
            WHEN cost_per_scan > 1000000 AND index_scans < 100 THEN 'REVIEW'
            ELSE 'KEEP'
        END AS action,
        CASE
            WHEN index_scans = 0 THEN 'Unused index consuming space'
            WHEN selectivity < 0.05 THEN 'Low selectivity - high bloat'
            WHEN cost_per_scan > 1000000 THEN 'High cost per scan'
            ELSE 'Index is efficient'
        END AS reason
    FROM index_metrics
)
SELECT
    index_name,
    table_name,
    size_mb,
    index_scans,
    selectivity,
    cost_per_scan,
    action,
    reason
FROM optimization_recommendations
WHERE action != 'KEEP'
ORDER BY
    CASE action WHEN 'DROP' THEN 1 WHEN 'REINDEX' THEN 2 ELSE 3 END,
    size_mb DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE index_scans = 0) AS unused_indexes,
    COUNT(*) FILTER (WHERE tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.05) AS low_selectivity_indexes
FROM index_usage_stats;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
2. **ç›‘æ§**: æŒç»­ç›‘æ§ç´¢å¼•æ€§èƒ½
3. **ç»´æŠ¤**: å®šæœŸé‡å»ºç´¢å¼•
4. **é€‰æ‹©**: é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç´¢å¼•è®¾è®¡**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•
2. **é¿å…è¿‡åº¦**: é¿å…åˆ›å»ºè¿‡å¤šç´¢å¼•
3. **å®šæœŸç»´æŠ¤**: å®šæœŸç»´æŠ¤ç´¢å¼•
4. **ç›‘æ§ä½¿ç”¨**: ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ

### 8.1 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç´¢å¼•ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - Skip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æï¼Œç‰¹åˆ«é€‚ç”¨äºç¨€ç–ç´¢å¼•å’Œéƒ¨åˆ†ç´¢å¼•
   - ç‰¹åˆ«é€‚ç”¨äºTop-NæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡ç´¢å¼•æ“ä½œï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡ç´¢å¼•æ„å»ºå’Œç´¢å¼•ç»´æŠ¤

3. **å¹¶è¡Œç´¢å¼•æ“ä½œå¢å¼º**ï¼š
   - ç´¢å¼•æ“ä½œæ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨5èŠ‚è¯¦ç»†è¯´æ˜ï¼‰
   - é€‚ç”¨äºå¤§è§„æ¨¡ç´¢å¼•æ„å»ºå’Œç´¢å¼•æ‰«æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–ç´¢å¼•æŸ¥è¯¢**

```sql
-- ä¸ºç´¢å¼•æŸ¥è¯¢åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_table_column_skip_scan
ON large_table(category, created_at DESC, id);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªç±»åˆ«æœ€æ–°åˆ›å»ºçš„å‰5æ¡è®°å½•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (category)
    category,
    id,
    created_at,
    value
FROM large_table
ORDER BY category, created_at DESC
LIMIT 50;
```

### 8.2 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰

**1. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ç‰¹å®šæŸ¥è¯¢**

å¯¹äºåªæŸ¥è¯¢éƒ¨åˆ†æ•°æ®çš„åœºæ™¯ï¼Œä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å¯ä»¥æ˜¾è‘—å‡å°‘ç´¢å¼•å¤§å°å’Œæå‡æ€§èƒ½ï¼š

```sql
-- åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•æ´»è·ƒæ•°æ®
CREATE INDEX IF NOT EXISTS idx_active_orders_skip_scan
ON orders(order_date DESC, amount DESC)
WHERE status = 'active';

-- éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ´»è·ƒè®¢å•ä¸­é‡‘é¢æœ€é«˜çš„å‰10ä¸ª
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    order_id,
    order_date,
    amount
FROM orders
WHERE status = 'active'
ORDER BY order_date DESC, amount DESC
LIMIT 10;
```

**2. æ™ºèƒ½ç´¢å¼•ç®¡ç†ï¼šè‡ªé€‚åº”ç´¢å¼•ç»´æŠ¤**

**æ™ºèƒ½ç´¢å¼•ç®¡ç†**ï¼šæ ¹æ®ç´¢å¼•ä½¿ç”¨æƒ…å†µè‡ªåŠ¨è°ƒæ•´ç´¢å¼•ç»´æŠ¤ç­–ç•¥ã€‚

```sql
-- æ™ºèƒ½ç´¢å¼•ç®¡ç†ï¼šè‡ªé€‚åº”ç´¢å¼•ç»´æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_bloat_ratio NUMERIC;
    index_usage_rate NUMERIC;
    maintenance_action VARCHAR(50);
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½ç´¢å¼•ç®¡ç†';
            RETURN;
        END IF;

        -- è®¡ç®—ç´¢å¼•ç‰¹å¾
        SELECT
            AVG(CASE WHEN index_scans = 0 THEN 1.0 ELSE 0.0 END),
            AVG(CASE WHEN tuples_fetched > 0 THEN tuples_fetched::numeric / NULLIF(tuples_read, 0) ELSE 0 END)
        INTO index_bloat_ratio, index_usage_rate
        FROM index_usage_stats;

        -- æ ¹æ®ç´¢å¼•ç‰¹å¾è‡ªé€‚åº”é€‰æ‹©ç»´æŠ¤ç­–ç•¥
        IF index_bloat_ratio > 0.3 THEN
            maintenance_action := 'DROP_UNUSED_INDEXES';  -- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
        ELSIF index_usage_rate < 0.1 THEN
            maintenance_action := 'REINDEX_LOW_USAGE';  -- é‡å»ºä½ä½¿ç”¨ç‡ç´¢å¼•
        ELSE
            maintenance_action := 'ANALYZE_INDEXES';  -- åˆ†æç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
        END IF;

        RAISE NOTICE 'ç´¢å¼•è†¨èƒ€ç‡: %, ç´¢å¼•ä½¿ç”¨ç‡: %, é€‰æ‹©ç­–ç•¥: %',
            index_bloat_ratio, index_usage_rate, maintenance_action;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½ç´¢å¼•ç®¡ç†å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ™ºèƒ½ç´¢å¼•ç»´æŠ¤ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸åŒçš„ç»´æŠ¤æ–¹å¼
WITH index_analysis AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç´¢å¼•æ•ˆç‡ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN index_scans = 0 THEN 0.0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS index_efficiency,
        CASE
            WHEN index_scans = 0 THEN 'UNUSED'
            WHEN tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.05 THEN 'LOW_EFFICIENCY'
            WHEN index_size_bytes > 104857600 THEN 'LARGE_SIZE'  -- 100MB
            ELSE 'EFFICIENT'
        END AS index_status,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç´¢å¼•ä¼˜å…ˆçº§ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        ROW_NUMBER() OVER (
            ORDER BY
                CASE WHEN index_scans = 0 THEN 1 ELSE 0 END DESC,
                index_size_bytes DESC
        ) AS maintenance_priority
    FROM index_usage_stats
)
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS size_mb,
    index_scans,
    ROUND(index_efficiency::numeric, 4) AS efficiency,
    index_status,
    maintenance_priority,
    CASE
        WHEN index_status = 'UNUSED' THEN 'DROP INDEX'
        WHEN index_status = 'LOW_EFFICIENCY' THEN 'REINDEX CONCURRENTLY'
        WHEN index_status = 'LARGE_SIZE' THEN 'VACUUM ANALYZE'
        ELSE 'KEEP INDEX'
    END AS recommended_action
FROM index_analysis
WHERE index_status != 'EFFICIENT'
ORDER BY maintenance_priority
LIMIT 50;
```

**3. å®æ—¶ç´¢å¼•ä¼˜åŒ–ï¼šå¢é‡ç´¢å¼•ä½¿ç”¨åˆ†æ**

**å®æ—¶ç´¢å¼•ä¼˜åŒ–**ï¼šå¯¹äºå®æ—¶æŸ¥è¯¢ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µã€‚

```sql
-- å®æ—¶ç´¢å¼•ä¼˜åŒ–ï¼šå¢é‡ç´¢å¼•ä½¿ç”¨åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_state') THEN
            CREATE TABLE index_usage_state (
                index_name VARCHAR(100) PRIMARY KEY,
                table_name VARCHAR(100) NOT NULL,
                total_scans BIGINT DEFAULT 0,
                total_tuples_read BIGINT DEFAULT 0,
                total_tuples_fetched BIGINT DEFAULT 0,
                last_scan_time TIMESTAMPTZ,
                last_updated TIMESTAMPTZ DEFAULT NOW()
            );

            CREATE INDEX idx_index_usage_state_scans ON index_usage_state(total_scans DESC);
            CREATE INDEX idx_index_usage_state_updated ON index_usage_state(last_updated DESC);

            RAISE NOTICE 'ç´¢å¼•ä½¿ç”¨çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡ç´¢å¼•ä½¿ç”¨åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡ç´¢å¼•ä½¿ç”¨åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡ï¼šå®æ—¶ç´¢å¼•ä¼˜åŒ–
WITH new_index_usage AS (
    SELECT
        schemaname || '.' || indexname AS index_name,
        schemaname || '.' || tablename AS table_name,
        idx_scan AS new_scans,
        idx_tup_read AS new_tuples_read,
        idx_tup_fetch AS new_tuples_fetched,
        last_idx_scan AS new_last_scan_time
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public'
      AND (last_idx_scan > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM index_usage_state)
           OR last_idx_scan IS NULL)
),
updated_index_usage AS (
    SELECT
        COALESCE(ius.index_name, niu.index_name) AS index_name,
        COALESCE(ius.table_name, niu.table_name) AS table_name,
        COALESCE(ius.total_scans, 0) + COALESCE(niu.new_scans, 0) AS new_total_scans,
        COALESCE(ius.total_tuples_read, 0) + COALESCE(niu.new_tuples_read, 0) AS new_total_tuples_read,
        COALESCE(ius.total_tuples_fetched, 0) + COALESCE(niu.new_tuples_fetched, 0) AS new_total_tuples_fetched,
        GREATEST(COALESCE(ius.last_scan_time, niu.new_last_scan_time), COALESCE(niu.new_last_scan_time, ius.last_scan_time)) AS new_last_scan_time
    FROM index_usage_state ius
    FULL OUTER JOIN new_index_usage niu ON ius.index_name = niu.index_name
)
-- æ›´æ–°æˆ–æ’å…¥ç´¢å¼•ä½¿ç”¨çŠ¶æ€
INSERT INTO index_usage_state (
    index_name,
    table_name,
    total_scans,
    total_tuples_read,
    total_tuples_fetched,
    last_scan_time,
    last_updated
)
SELECT
    index_name,
    table_name,
    new_total_scans,
    new_total_tuples_read,
    new_total_tuples_fetched,
    new_last_scan_time,
    NOW()
FROM updated_index_usage
ON CONFLICT (index_name)
DO UPDATE SET
    total_scans = EXCLUDED.total_scans,
    total_tuples_read = EXCLUDED.total_tuples_read,
    total_tuples_fetched = EXCLUDED.total_tuples_fetched,
    last_scan_time = EXCLUDED.last_scan_time,
    last_updated = NOW();
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
