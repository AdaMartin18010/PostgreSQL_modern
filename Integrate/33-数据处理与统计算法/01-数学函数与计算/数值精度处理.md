# PostgreSQL 数值精度处理完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 数值精度 | 金融计算
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 数值精度处理完整指南](#postgresql-数值精度处理完整指南)
  - [📋 目录](#-目录)
  - [数值精度处理概述](#数值精度处理概述)
    - [核心函数列表](#核心函数列表)
  - [1. 四舍五入](#1-四舍五入)
    - [1.1 基本四舍五入](#11-基本四舍五入)
  - [2. 截断](#2-截断)
    - [2.1 基本截断](#21-基本截断)
  - [3. 精度控制](#3-精度控制)
    - [3.1 数据类型精度](#31-数据类型精度)
  - [4. 实际应用案例](#4-实际应用案例)
    - [4.1 金融计算：金额格式化](#41-金融计算金额格式化)

---

## 数值精度处理概述

**数值精度处理**用于控制数值的显示精度和计算精度，在金融计算中尤为重要。

### 核心函数列表

| 函数名称 | 用途 | 示例 |
|---------|------|------|
| **ROUND()** | 四舍五入 | ROUND(123.456, 2) → 123.46 |
| **TRUNC()** | 截断 | TRUNC(123.456, 2) → 123.45 |
| **CEIL()** | 向上取整 | CEIL(123.1) → 124 |
| **FLOOR()** | 向下取整 | FLOOR(123.9) → 123 |

---

## 1. 四舍五入

### 1.1 基本四舍五入

```sql
-- 四舍五入（带错误处理）
DO $$
DECLARE
    value NUMERIC := 123.456789;
    rounded_2 NUMERIC;
    rounded_0 NUMERIC;
    rounded_neg2 NUMERIC;
BEGIN
    BEGIN
        -- 保留2位小数
        rounded_2 := ROUND(value, 2);
        RAISE NOTICE '四舍五入到2位小数: % -> %', value, rounded_2;

        -- 保留0位小数（整数）
        rounded_0 := ROUND(value, 0);
        RAISE NOTICE '四舍五入到整数: % -> %', value, rounded_0;

        -- 四舍五入到百位
        rounded_neg2 := ROUND(value, -2);
        RAISE NOTICE '四舍五入到百位: % -> %', value, rounded_neg2;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '四舍五入失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. 截断

### 2.1 基本截断

```sql
-- 截断（带错误处理）
DO $$
DECLARE
    value NUMERIC := 123.456789;
    truncated_2 NUMERIC;
    truncated_0 NUMERIC;
    truncated_neg2 NUMERIC;
BEGIN
    BEGIN
        -- 截断到2位小数
        truncated_2 := TRUNC(value, 2);
        RAISE NOTICE '截断到2位小数: % -> %', value, truncated_2;

        -- 截断到整数
        truncated_0 := TRUNC(value, 0);
        RAISE NOTICE '截断到整数: % -> %', value, truncated_0;

        -- 截断到百位
        truncated_neg2 := TRUNC(value, -2);
        RAISE NOTICE '截断到百位: % -> %', value, truncated_neg2;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '截断失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. 精度控制

### 3.1 数据类型精度

```sql
-- 精度控制（带错误处理）
DO $$
DECLARE
    value NUMERIC := 123.4567890123456789;
    fixed_precision NUMERIC(10, 2);
    decimal_precision DECIMAL(10, 4);
BEGIN
    BEGIN
        -- 固定精度（10位总长度，2位小数）
        fixed_precision := CAST(value AS NUMERIC(10, 2));
        RAISE NOTICE '固定精度(10,2): % -> %', value, fixed_precision;

        -- 小数精度（10位总长度，4位小数）
        decimal_precision := value::DECIMAL(10, 4);
        RAISE NOTICE '小数精度(10,4): % -> %', value, decimal_precision;
    EXCEPTION
        WHEN numeric_value_out_of_range THEN
            RAISE WARNING '数值超出精度范围';
        WHEN OTHERS THEN
            RAISE WARNING '精度控制失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. 实际应用案例

### 4.1 金融计算：金额格式化

```sql
-- 金额格式化（带错误处理）
DO $$
DECLARE
    amount NUMERIC := 1234567.89;
    formatted_amount TEXT;
BEGIN
    BEGIN
        -- 格式化为货币格式（保留2位小数）
        formatted_amount := TO_CHAR(ROUND(amount, 2), 'FM$999,999,999.00');
        RAISE NOTICE '金额格式化: % -> %', amount, formatted_amount;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '金额格式化失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
