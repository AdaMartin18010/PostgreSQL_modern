# PostgreSQL æ€§èƒ½æŒ‡æ ‡è®¡ç®—å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ€§èƒ½ç›‘æŽ§ | æŒ‡æ ‡è®¡ç®—
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ðŸ“‹ ç›®å½•

- [PostgreSQL æ€§èƒ½æŒ‡æ ‡è®¡ç®—å®Œæ•´æŒ‡å—](#postgresql-æ€§èƒ½æŒ‡æ ‡è®¡ç®—å®Œæ•´æŒ‡å—)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ€§èƒ½æŒ‡æ ‡æ¦‚è¿°](#æ€§èƒ½æŒ‡æ ‡æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ€§èƒ½æŒ‡æ ‡é—®é¢˜å®šä¹‰](#æ€§èƒ½æŒ‡æ ‡é—®é¢˜å®šä¹‰)
      - [æ€§èƒ½æŒ‡æ ‡åˆ†ç±»](#æ€§èƒ½æŒ‡æ ‡åˆ†ç±»)
      - [æŒ‡æ ‡è®¡ç®—æ–¹æ³•é€‰æ‹©](#æŒ‡æ ‡è®¡ç®—æ–¹æ³•é€‰æ‹©)
    - [æ ¸å¿ƒæŒ‡æ ‡](#æ ¸å¿ƒæŒ‡æ ‡)
  - [1. CPUä½¿ç”¨çŽ‡](#1-cpuä½¿ç”¨çŽ‡)
    - [1.1 CPUä½¿ç”¨çŽ‡åŽŸç†](#11-cpuä½¿ç”¨çŽ‡åŽŸç†)
      - [CPUä½¿ç”¨çŽ‡å®šä¹‰](#cpuä½¿ç”¨çŽ‡å®šä¹‰)
      - [CPUä½¿ç”¨çŽ‡è®¡ç®—](#cpuä½¿ç”¨çŽ‡è®¡ç®—)
    - [1.2 CPUä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°](#12-cpuä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°)
    - [1.3 CPUè´Ÿè½½åˆ†æž](#13-cpuè´Ÿè½½åˆ†æž)
  - [2. å†…å­˜ä½¿ç”¨çŽ‡](#2-å†…å­˜ä½¿ç”¨çŽ‡)
    - [2.1 å†…å­˜ä½¿ç”¨çŽ‡åŽŸç†](#21-å†…å­˜ä½¿ç”¨çŽ‡åŽŸç†)
      - [å†…å­˜ä½¿ç”¨çŽ‡å®šä¹‰](#å†…å­˜ä½¿ç”¨çŽ‡å®šä¹‰)
      - [å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—](#å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—)
    - [2.2 å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°](#22-å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°)
    - [2.3 å†…å­˜åŽ‹åŠ›åˆ†æž](#23-å†…å­˜åŽ‹åŠ›åˆ†æž)
  - [3. ç£ç›˜I/O](#3-ç£ç›˜io)
    - [3.1 ç£ç›˜I/OåŽŸç†](#31-ç£ç›˜ioåŽŸç†)
      - [ç£ç›˜I/Oå®šä¹‰](#ç£ç›˜ioå®šä¹‰)
      - [I/OæŒ‡æ ‡è®¡ç®—](#ioæŒ‡æ ‡è®¡ç®—)
    - [3.2 ç£ç›˜I/Oç»Ÿè®¡å®žçŽ°](#32-ç£ç›˜ioç»Ÿè®¡å®žçŽ°)
    - [3.3 I/Oæ€§èƒ½åˆ†æž](#33-ioæ€§èƒ½åˆ†æž)
  - [4. æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡](#4-æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡)
    - [4.1 æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡åŽŸç†](#41-æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡åŽŸç†)
      - [æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡å®šä¹‰](#æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡å®šä¹‰)
      - [æ€§èƒ½æŒ‡æ ‡åˆ†ç±»](#æ€§èƒ½æŒ‡æ ‡åˆ†ç±»-1)
    - [4.2 æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡å®žçŽ°](#42-æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡å®žçŽ°)
    - [4.3 è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡](#43-è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡)
  - [5. PostgreSQL 18å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—](#5-postgresql-18å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—)
    - [5.1 å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—æ¦‚è¿°](#51-å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—æ¦‚è¿°)
      - [å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—é…ç½®](#å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—é…ç½®)
      - [å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å®žçŽ°](#å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å®žçŽ°)
  - [6. æ€§èƒ½æŒ‡æ ‡ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½æŒ‡æ ‡ä¼˜åŒ–ç­–ç•¥)
    - [6.1 ç´¢å¼•ä¼˜åŒ–](#61-ç´¢å¼•ä¼˜åŒ–)
    - [6.2 èšåˆä¼˜åŒ–](#62-èšåˆä¼˜åŒ–)
    - [6.3 å®žæ—¶ç›‘æŽ§ä¼˜åŒ–](#63-å®žæ—¶ç›‘æŽ§ä¼˜åŒ–)
  - [7. å®žé™…åº”ç”¨æ¡ˆä¾‹](#7-å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 æ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿](#71-æ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿)
    - [7.2 æ€§èƒ½è¶‹åŠ¿åˆ†æž](#72-æ€§èƒ½è¶‹åŠ¿åˆ†æž)
    - [7.3 æ€§èƒ½å‘Šè­¦ç³»ç»Ÿ](#73-æ€§èƒ½å‘Šè­¦ç³»ç»Ÿ)
    - [7.4 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#74-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
  - [8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–](#8-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–)
    - [8.1 æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•å¯¹æ¯”](#81-æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•å¯¹æ¯”)
    - [8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [8.3 å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ](#83-å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ)
  - [9. æœ€ä½³å®žè·µ](#9-æœ€ä½³å®žè·µ)
    - [9.1 æŒ‡æ ‡é€‰æ‹©](#91-æŒ‡æ ‡é€‰æ‹©)
    - [9.2 é‡‡æ ·é¢‘çŽ‡](#92-é‡‡æ ·é¢‘çŽ‡)
    - [9.3 æ•°æ®ä¿ç•™](#93-æ•°æ®ä¿ç•™)
    - [9.4 SQLå®žçŽ°æ³¨æ„äº‹é¡¹](#94-sqlå®žçŽ°æ³¨æ„äº‹é¡¹)
    - [9.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢žå¼ºï¼‰](#95-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨å¢žå¼º)
    - [9.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢žå¼ºï¼‰](#96-é«˜çº§ä¼˜åŒ–æŠ€å·§å¢žå¼º)
  - [ðŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ€§èƒ½æŒ‡æ ‡æ¦‚è¿°

**æ€§èƒ½æŒ‡æ ‡è®¡ç®—ï¼ˆPerformance Metrics Calculationï¼‰**ç”¨äºŽç›‘æŽ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œæ˜¯è¿ç»´ç›‘æŽ§çš„æ ¸å¿ƒã€‚

### ç†è®ºåŸºç¡€

#### æ€§èƒ½æŒ‡æ ‡é—®é¢˜å®šä¹‰

**æ€§èƒ½æŒ‡æ ‡é—®é¢˜**ï¼šç»™å®šç³»ç»Ÿç›‘æŽ§æ•°æ®$M = \{m_1, m_2, \ldots, m_T\}$ï¼Œè®¡ç®—æ€§èƒ½æŒ‡æ ‡$I = \{i_1, i_2, \ldots, i_T\}$ï¼š
$$i_t = f(m_t, m_{t-1}, \ldots, m_{t-k})$$

å…¶ä¸­$f$æ˜¯æŒ‡æ ‡è®¡ç®—å‡½æ•°ã€‚

#### æ€§èƒ½æŒ‡æ ‡åˆ†ç±»

æ€§èƒ½æŒ‡æ ‡åˆ†ç±»ï¼š

1. **èµ„æºä½¿ç”¨æŒ‡æ ‡**ï¼š
   - CPUä½¿ç”¨çŽ‡ï¼š$\text{CPU\%} = \frac{\text{CPU\_used}}{\text{CPU\_total}} \times 100\%$
   - å†…å­˜ä½¿ç”¨çŽ‡ï¼š$\text{Memory\%} = \frac{\text{Memory\_used}}{\text{Memory\_total}} \times 100\%$
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(1)$

2. **I/Oæ€§èƒ½æŒ‡æ ‡**ï¼š
   - IOPSï¼šæ¯ç§’I/Oæ“ä½œæ•°
   - åžåé‡ï¼šæ¯ç§’ä¼ è¾“å­—èŠ‚æ•°
   - å»¶è¿Ÿï¼šå¹³å‡å“åº”æ—¶é—´
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

3. **æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡**ï¼š
   - æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
   - è¿žæŽ¥æ•°
   - äº‹åŠ¡åžåé‡
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

#### æŒ‡æ ‡è®¡ç®—æ–¹æ³•é€‰æ‹©

é€‰æ‹©è®¡ç®—æ–¹æ³•çš„è€ƒè™‘å› ç´ ï¼š

1. **æŒ‡æ ‡ç±»åž‹**ï¼šèµ„æºä½¿ç”¨ç”¨æ¯”çŽ‡ï¼ŒI/Oç”¨ç»Ÿè®¡ï¼Œæ•°æ®åº“ç”¨èšåˆ
2. **æ—¶é—´ç²’åº¦**ï¼šå®žæ—¶ç”¨å½“å‰å€¼ï¼Œè¶‹åŠ¿ç”¨ç§»åŠ¨å¹³å‡
3. **ç²¾åº¦è¦æ±‚**ï¼šé«˜ç²¾åº¦ç”¨è¯¦ç»†ç»Ÿè®¡ï¼Œæ¦‚è§ˆç”¨èšåˆ

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å­¦å®šä¹‰ | ç”¨é€” | å•ä½ | æ—¶é—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|-----------|---------|
| **CPUä½¿ç”¨çŽ‡** | $\frac{\text{CPU\_used}}{\text{CPU\_total}} \times 100\%$ | CPUè´Ÿè½½ | % | $O(1)$ | ç³»ç»Ÿç›‘æŽ§ |
| **å†…å­˜ä½¿ç”¨çŽ‡** | $\frac{\text{Memory\_used}}{\text{Memory\_total}} \times 100\%$ | å†…å­˜å ç”¨ | % | $O(1)$ | å†…å­˜ç›‘æŽ§ |
| **ç£ç›˜I/O** | $\text{IOPS} = \frac{\text{IO\_count}}{\text{time\_interval}}$ | ç£ç›˜è¯»å†™ | IOPS | $O(n)$ | I/Oç›‘æŽ§ |
| **æŸ¥è¯¢æ€§èƒ½** | $\text{Avg\_Time} = \frac{1}{n}\sum_{i=1}^{n} t_i$ | æ•°æ®åº“æ€§èƒ½ | ms | $O(n)$ | æ•°æ®åº“ç›‘æŽ§ |

---

## 1. CPUä½¿ç”¨çŽ‡

### 1.1 CPUä½¿ç”¨çŽ‡åŽŸç†

**CPUä½¿ç”¨çŽ‡ï¼ˆCPU Usageï¼‰**æ˜¯è¡¡é‡CPUç¹å¿™ç¨‹åº¦çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚

#### CPUä½¿ç”¨çŽ‡å®šä¹‰

**CPUä½¿ç”¨çŽ‡**ï¼šCPUåœ¨å•ä½æ—¶é—´å†…çš„ä½¿ç”¨æ¯”ä¾‹ï¼š
$$\text{CPU\%} = \frac{\text{CPU\_used\_time}}{\text{CPU\_total\_time}} \times 100\%$$

**Linuxç³»ç»ŸCPUä½¿ç”¨çŽ‡**ï¼š
$$\text{CPU\%} = \left(1 - \frac{\text{idle\_time}}{\text{total\_time}}\right) \times 100\%$$

#### CPUä½¿ç”¨çŽ‡è®¡ç®—

**è®¡ç®—æ–¹æ³•**ï¼š

1. **çž¬æ—¶å€¼**ï¼šå½“å‰æ—¶åˆ»çš„CPUä½¿ç”¨çŽ‡
2. **å¹³å‡å€¼**ï¼šä¸€æ®µæ—¶é—´å†…çš„å¹³å‡CPUä½¿ç”¨çŽ‡
3. **å³°å€¼**ï¼šä¸€æ®µæ—¶é—´å†…çš„æœ€å¤§CPUä½¿ç”¨çŽ‡

### 1.2 CPUä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°

**CPUä½¿ç”¨çŽ‡**çš„å®žçŽ°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºç³»ç»Ÿç›‘æŽ§æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE system_metrics CASCADE;
        END IF;

        CREATE TABLE system_metrics (
            timestamp TIMESTAMP NOT NULL,
            metric_name VARCHAR(50) NOT NULL,
            metric_value NUMERIC(10, 2) NOT NULL,
            PRIMARY KEY (timestamp, metric_name)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO system_metrics (timestamp, metric_name, metric_value) VALUES
            ('2024-01-01 10:00:00', 'cpu_usage', 45.5),
            ('2024-01-01 10:01:00', 'cpu_usage', 52.3),
            ('2024-01-01 10:02:00', 'cpu_usage', 48.7),
            ('2024-01-01 10:00:00', 'memory_usage', 65.2),
            ('2024-01-01 10:01:00', 'memory_usage', 67.8),
            ('2024-01-01 10:02:00', 'memory_usage', 69.1);

        RAISE NOTICE 'è¡¨ system_metrics åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ system_metrics å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—CPUä½¿ç”¨çŽ‡ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—CPUä½¿ç”¨çŽ‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—CPUä½¿ç”¨çŽ‡ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'CPUä½¿ç”¨çŽ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—CPUä½¿ç”¨çŽ‡ç»Ÿè®¡
SELECT
    metric_name,
    COUNT(*) AS sample_count,
    ROUND(AVG(metric_value)::numeric, 2) AS avg_value,
    ROUND(MIN(metric_value)::numeric, 2) AS min_value,
    ROUND(MAX(metric_value)::numeric, 2) AS max_value,
    ROUND(STDDEV(metric_value)::numeric, 2) AS std_value
FROM system_metrics
WHERE metric_name = 'cpu_usage'
GROUP BY metric_name;

-- è®¡ç®—ç§»åŠ¨å¹³å‡CPUä½¿ç”¨çŽ‡
SELECT
    timestamp,
    metric_value,
    AVG(metric_value) OVER (
        ORDER BY timestamp
        ROWS BETWEEN 4 PRECEDING AND CURRENT ROW
    ) AS moving_avg_5min
FROM system_metrics
WHERE metric_name = 'cpu_usage'
ORDER BY timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    timestamp,
    AVG(metric_value) OVER (ORDER BY timestamp ROWS BETWEEN 4 PRECEDING AND CURRENT ROW) AS moving_avg
FROM system_metrics
WHERE metric_name = 'cpu_usage'
ORDER BY timestamp;
```

---

### 1.3 CPUè´Ÿè½½åˆ†æž

**CPUè´Ÿè½½åˆ†æž**ï¼šåˆ†æžCPUè´Ÿè½½è¶‹åŠ¿å’Œå³°å€¼ã€‚

```sql
-- CPUè´Ÿè½½åˆ†æžï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æžCPUè´Ÿè½½';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æžCPUè´Ÿè½½';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'CPUè´Ÿè½½åˆ†æžå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- CPUè´Ÿè½½åˆ†æžï¼šè¯†åˆ«CPUå³°å€¼å’Œè¶‹åŠ¿
WITH cpu_trends AS (
    SELECT
        timestamp,
        metric_value AS cpu_usage,
        AVG(metric_value) OVER (
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg_10min,
        MAX(metric_value) OVER (
            ORDER BY timestamp
            ROWS BETWEEN 59 PRECEDING AND CURRENT ROW
        ) AS max_1h
    FROM system_metrics
    WHERE metric_name = 'cpu_usage'
)
SELECT
    timestamp,
    ROUND(cpu_usage::numeric, 2) AS cpu_usage,
    ROUND(moving_avg_10min::numeric, 2) AS moving_avg_10min,
    ROUND(max_1h::numeric, 2) AS max_1h,
    CASE
        WHEN cpu_usage > 90 THEN 'Critical'
        WHEN cpu_usage > 80 THEN 'High'
        WHEN cpu_usage > 70 THEN 'Warning'
        ELSE 'Normal'
    END AS load_level,
    CASE
        WHEN cpu_usage > moving_avg_10min * 1.2 THEN 'Spike'
        WHEN cpu_usage < moving_avg_10min * 0.8 THEN 'Drop'
        ELSE 'Stable'
    END AS trend
FROM cpu_trends
ORDER BY timestamp;
```

---

## 2. å†…å­˜ä½¿ç”¨çŽ‡

### 2.1 å†…å­˜ä½¿ç”¨çŽ‡åŽŸç†

**å†…å­˜ä½¿ç”¨çŽ‡ï¼ˆMemory Usageï¼‰**ç›‘æŽ§å†…å­˜å ç”¨æƒ…å†µã€‚

#### å†…å­˜ä½¿ç”¨çŽ‡å®šä¹‰

**å†…å­˜ä½¿ç”¨çŽ‡**ï¼šå†…å­˜ä½¿ç”¨é‡ä¸Žæ€»å†…å­˜çš„æ¯”å€¼ï¼š
$$\text{Memory\%} = \frac{\text{Memory\_used}}{\text{Memory\_total}} \times 100\%$$

**å†…å­˜åŽ‹åŠ›**ï¼šå½“å†…å­˜ä½¿ç”¨çŽ‡æŽ¥è¿‘ä¸Šé™æ—¶ï¼Œç³»ç»Ÿå¯èƒ½å‡ºçŽ°å†…å­˜åŽ‹åŠ›ã€‚

#### å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—

**è®¡ç®—æ–¹æ³•**ï¼š

1. **å½“å‰ä½¿ç”¨çŽ‡**ï¼šå½“å‰æ—¶åˆ»çš„å†…å­˜ä½¿ç”¨çŽ‡
2. **å³°å€¼ä½¿ç”¨çŽ‡**ï¼šä¸€æ®µæ—¶é—´å†…çš„æœ€å¤§ä½¿ç”¨çŽ‡
3. **å¹³å‡ä½¿ç”¨çŽ‡**ï¼šä¸€æ®µæ—¶é—´å†…çš„å¹³å‡ä½¿ç”¨çŽ‡

### 2.2 å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—å®žçŽ°

**å†…å­˜ä½¿ç”¨çŽ‡**çš„å®žçŽ°å’Œä½¿ç”¨ã€‚

```sql
-- å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å†…å­˜ä½¿ç”¨çŽ‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å†…å­˜ä½¿ç”¨çŽ‡ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å†…å­˜ä½¿ç”¨çŽ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å†…å­˜ä½¿ç”¨çŽ‡ç»Ÿè®¡
SELECT
    timestamp,
    metric_value AS memory_usage_pct,
    CASE
        WHEN metric_value > 90 THEN 'Critical'
        WHEN metric_value > 80 THEN 'Warning'
        WHEN metric_value > 70 THEN 'Caution'
        ELSE 'Normal'
    END AS status
FROM system_metrics
WHERE metric_name = 'memory_usage'
ORDER BY timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    timestamp,
    metric_value
FROM system_metrics
WHERE metric_name = 'memory_usage'
ORDER BY timestamp;
```

---

### 2.3 å†…å­˜åŽ‹åŠ›åˆ†æž

**å†…å­˜åŽ‹åŠ›åˆ†æž**ï¼šåˆ†æžå†…å­˜åŽ‹åŠ›å’Œäº¤æ¢ä½¿ç”¨ã€‚

```sql
-- å†…å­˜åŽ‹åŠ›åˆ†æžï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æžå†…å­˜åŽ‹åŠ›';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æžå†…å­˜åŽ‹åŠ›';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å†…å­˜åŽ‹åŠ›åˆ†æžå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å†…å­˜åŽ‹åŠ›åˆ†æžï¼šè¯†åˆ«å†…å­˜åŽ‹åŠ›äº‹ä»¶
WITH memory_analysis AS (
    SELECT
        timestamp,
        metric_value AS memory_usage,
        LAG(metric_value) OVER (ORDER BY timestamp) AS prev_memory_usage,
        AVG(metric_value) OVER (
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg_10min
    FROM system_metrics
    WHERE metric_name = 'memory_usage'
)
SELECT
    timestamp,
    ROUND(memory_usage::numeric, 2) AS memory_usage,
    ROUND(moving_avg_10min::numeric, 2) AS moving_avg_10min,
    CASE
        WHEN memory_usage > 95 THEN 'Critical Pressure'
        WHEN memory_usage > 90 THEN 'High Pressure'
        WHEN memory_usage > 80 THEN 'Moderate Pressure'
        ELSE 'Normal'
    END AS pressure_level,
    CASE
        WHEN memory_usage - COALESCE(prev_memory_usage, memory_usage) > 5 THEN 'Rapid Increase'
        WHEN memory_usage - COALESCE(prev_memory_usage, memory_usage) < -5 THEN 'Rapid Decrease'
        ELSE 'Stable'
    END AS change_trend
FROM memory_analysis
WHERE memory_usage > 80
ORDER BY timestamp;
```

---

## 3. ç£ç›˜I/O

### 3.1 ç£ç›˜I/OåŽŸç†

**ç£ç›˜I/Oï¼ˆDisk I/Oï¼‰**ç›‘æŽ§ç£ç›˜è¯»å†™æ€§èƒ½ã€‚

#### ç£ç›˜I/Oå®šä¹‰

**IOPSï¼ˆInput/Output Operations Per Secondï¼‰**ï¼šæ¯ç§’I/Oæ“ä½œæ•°ï¼š
$$\text{IOPS} = \frac{\text{IO\_count}}{\text{time\_interval}}$$

**åžåé‡ï¼ˆThroughputï¼‰**ï¼šæ¯ç§’ä¼ è¾“çš„å­—èŠ‚æ•°ï¼š
$$\text{Throughput} = \frac{\text{bytes\_transferred}}{\text{time\_interval}}$$

**å»¶è¿Ÿï¼ˆLatencyï¼‰**ï¼šå¹³å‡å“åº”æ—¶é—´ï¼š
$$\text{Latency} = \frac{1}{n}\sum_{i=1}^{n} t_i$$

#### I/OæŒ‡æ ‡è®¡ç®—

**I/OæŒ‡æ ‡**ï¼š

1. **IOPS**ï¼šè¯»å†™æ“ä½œé¢‘çŽ‡
2. **åžåé‡**ï¼šæ•°æ®ä¼ è¾“é€Ÿåº¦
3. **å»¶è¿Ÿ**ï¼šå“åº”æ—¶é—´
4. **é˜Ÿåˆ—æ·±åº¦**ï¼šç­‰å¾…é˜Ÿåˆ—é•¿åº¦

### 3.2 ç£ç›˜I/Oç»Ÿè®¡å®žçŽ°

**ç£ç›˜I/Oç»Ÿè®¡**çš„å®žçŽ°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºç£ç›˜I/Oæ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'disk_io_metrics') THEN
            RAISE WARNING 'è¡¨ disk_io_metrics å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE disk_io_metrics CASCADE;
        END IF;

        CREATE TABLE disk_io_metrics (
            timestamp TIMESTAMP NOT NULL,
            device VARCHAR(50) NOT NULL,
            read_iops INTEGER NOT NULL,
            write_iops INTEGER NOT NULL,
            read_bytes BIGINT NOT NULL,
            write_bytes BIGINT NOT NULL,
            PRIMARY KEY (timestamp, device)
        );

        INSERT INTO disk_io_metrics (timestamp, device, read_iops, write_iops, read_bytes, write_bytes) VALUES
            ('2024-01-01 10:00:00', 'sda', 100, 50, 1048576, 524288),
            ('2024-01-01 10:01:00', 'sda', 120, 60, 1258291, 629146),
            ('2024-01-01 10:02:00', 'sda', 110, 55, 1153434, 576717);

        RAISE NOTICE 'è¡¨ disk_io_metrics åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ disk_io_metrics å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—ç£ç›˜I/Oç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'disk_io_metrics') THEN
            RAISE WARNING 'è¡¨ disk_io_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç£ç›˜I/Oç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç£ç›˜I/Oç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç£ç›˜I/Oç»Ÿè®¡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç£ç›˜I/Oç»Ÿè®¡
SELECT
    device,
    COUNT(*) AS sample_count,
    ROUND(AVG(read_iops)::numeric, 2) AS avg_read_iops,
    ROUND(AVG(write_iops)::numeric, 2) AS avg_write_iops,
    ROUND(AVG(read_iops + write_iops)::numeric, 2) AS avg_total_iops,
    ROUND(AVG(read_bytes)::numeric / 1024 / 1024, 2) AS avg_read_mbps,
    ROUND(AVG(write_bytes)::numeric / 1024 / 1024, 2) AS avg_write_mbps
FROM disk_io_metrics
GROUP BY device
ORDER BY device;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    device,
    AVG(read_iops + write_iops) AS avg_total_iops
FROM disk_io_metrics
GROUP BY device;
```

---

### 3.3 I/Oæ€§èƒ½åˆ†æž

**I/Oæ€§èƒ½åˆ†æž**ï¼šåˆ†æžI/Oç“¶é¢ˆå’Œæ€§èƒ½è¶‹åŠ¿ã€‚

```sql
-- I/Oæ€§èƒ½åˆ†æžï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'disk_io_metrics') THEN
            RAISE WARNING 'è¡¨ disk_io_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æžI/Oæ€§èƒ½';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æžI/Oæ€§èƒ½';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'I/Oæ€§èƒ½åˆ†æžå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- I/Oæ€§èƒ½åˆ†æžï¼šè¯†åˆ«I/Oç“¶é¢ˆ
WITH io_performance AS (
    SELECT
        timestamp,
        device,
        read_iops,
        write_iops,
        read_iops + write_iops AS total_iops,
        read_bytes + write_bytes AS total_bytes,
        AVG(read_iops + write_iops) OVER (
            PARTITION BY device
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_iops_10min,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY read_iops + write_iops) OVER (
            PARTITION BY device
            ORDER BY timestamp
            ROWS BETWEEN 59 PRECEDING AND CURRENT ROW
        ) AS p95_iops_1h
    FROM disk_io_metrics
)
SELECT
    timestamp,
    device,
    total_iops,
    ROUND((total_bytes / 1024 / 1024)::numeric, 2) AS total_mbps,
    ROUND(avg_iops_10min::numeric, 2) AS avg_iops_10min,
    ROUND(p95_iops_1h::numeric, 2) AS p95_iops_1h,
    CASE
        WHEN total_iops > p95_iops_1h * 1.5 THEN 'I/O Spike'
        WHEN total_iops > avg_iops_10min * 1.2 THEN 'High I/O'
        ELSE 'Normal'
    END AS io_status
FROM io_performance
WHERE total_iops > avg_iops_10min * 1.2
ORDER BY device, timestamp;
```

---

## 4. æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

### 4.1 æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡åŽŸç†

**æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡ï¼ˆDatabase Performance Metricsï¼‰**ç›‘æŽ§æ•°æ®åº“æŸ¥è¯¢å’Œäº‹åŠ¡æ€§èƒ½ã€‚

#### æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡å®šä¹‰

**æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡**ï¼š

- **å¹³å‡æ‰§è¡Œæ—¶é—´**ï¼š$\bar{t} = \frac{1}{n}\sum_{i=1}^{n} t_i$
- **P95æ‰§è¡Œæ—¶é—´**ï¼š95%çš„æŸ¥è¯¢æ‰§è¡Œæ—¶é—´å°äºŽæ­¤å€¼
- **åžåé‡**ï¼š$\text{QPS} = \frac{\text{query\_count}}{\text{time\_interval}}$

#### æ€§èƒ½æŒ‡æ ‡åˆ†ç±»

**æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡åˆ†ç±»**ï¼š

1. **æŸ¥è¯¢æ€§èƒ½**ï¼šæ‰§è¡Œæ—¶é—´ã€è¿”å›žè¡Œæ•°
2. **è¿žæŽ¥æ€§èƒ½**ï¼šè¿žæŽ¥æ•°ã€è¿žæŽ¥ç­‰å¾…æ—¶é—´
3. **äº‹åŠ¡æ€§èƒ½**ï¼šäº‹åŠ¡åžåé‡ã€äº‹åŠ¡å»¶è¿Ÿ
4. **é”æ€§èƒ½**ï¼šé”ç­‰å¾…æ—¶é—´ã€æ­»é”æ•°

### 4.2 æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡å®žçŽ°

**æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡**çš„å®žçŽ°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºæŸ¥è¯¢æ€§èƒ½æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'query_performance') THEN
            RAISE WARNING 'è¡¨ query_performance å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE query_performance CASCADE;
        END IF;

        CREATE TABLE query_performance (
            timestamp TIMESTAMP NOT NULL,
            query_id VARCHAR(100) NOT NULL,
            execution_time_ms NUMERIC(10, 2) NOT NULL,
            rows_returned INTEGER NOT NULL,
            PRIMARY KEY (timestamp, query_id)
        );

        INSERT INTO query_performance (timestamp, query_id, execution_time_ms, rows_returned) VALUES
            ('2024-01-01 10:00:00', 'query_001', 125.5, 1000),
            ('2024-01-01 10:01:00', 'query_001', 130.2, 1050),
            ('2024-01-01 10:02:00', 'query_001', 118.7, 980),
            ('2024-01-01 10:00:00', 'query_002', 45.3, 500),
            ('2024-01-01 10:01:00', 'query_002', 42.1, 480);

        RAISE NOTICE 'è¡¨ query_performance åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ query_performance å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'query_performance') THEN
            RAISE WARNING 'è¡¨ query_performance ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡
SELECT
    query_id,
    COUNT(*) AS execution_count,
    ROUND(AVG(execution_time_ms)::numeric, 2) AS avg_execution_time,
    ROUND(MIN(execution_time_ms)::numeric, 2) AS min_execution_time,
    ROUND(MAX(execution_time_ms)::numeric, 2) AS max_execution_time,
    ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms)::numeric, 2) AS p95_execution_time,
    ROUND(AVG(rows_returned)::numeric, 0) AS avg_rows_returned
FROM query_performance
GROUP BY query_id
ORDER BY avg_execution_time DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    query_id,
    AVG(execution_time_ms) AS avg_time
FROM query_performance
GROUP BY query_id;
```

---

### 4.3 è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡

**è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡**ï¼šç›‘æŽ§æ•°æ®åº“è¿žæŽ¥å’Œäº‹åŠ¡æ€§èƒ½ã€‚

```sql
-- è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'database_connections') THEN
            RAISE WARNING 'è¡¨ database_connections ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE database_connections (
                timestamp TIMESTAMP NOT NULL,
                database_name VARCHAR(100) NOT NULL,
                active_connections INTEGER NOT NULL,
                idle_connections INTEGER NOT NULL,
                waiting_connections INTEGER NOT NULL,
                PRIMARY KEY (timestamp, database_name)
            );

            INSERT INTO database_connections (timestamp, database_name, active_connections, idle_connections, waiting_connections) VALUES
                ('2024-01-01 10:00:00', 'db_prod', 50, 20, 2),
                ('2024-01-01 10:01:00', 'db_prod', 55, 18, 3),
                ('2024-01-01 10:02:00', 'db_prod', 60, 15, 5);

            RAISE NOTICE 'è¡¨ database_connections åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹ç»Ÿè®¡è¿žæŽ¥å’Œäº‹åŠ¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è¿žæŽ¥å’Œäº‹åŠ¡ç»Ÿè®¡
WITH connection_stats AS (
    SELECT
        database_name,
        timestamp,
        active_connections,
        idle_connections,
        waiting_connections,
        active_connections + idle_connections + waiting_connections AS total_connections,
        AVG(active_connections) OVER (
            PARTITION BY database_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_active_connections
    FROM database_connections
)
SELECT
    database_name,
    timestamp,
    active_connections,
    idle_connections,
    waiting_connections,
    total_connections,
    ROUND(avg_active_connections::numeric, 2) AS avg_active_connections,
    ROUND((waiting_connections::NUMERIC / NULLIF(total_connections, 0) * 100)::numeric, 2) AS waiting_pct,
    CASE
        WHEN waiting_connections > 10 THEN 'Connection Contention'
        WHEN waiting_connections > 5 THEN 'Moderate Wait'
        ELSE 'Normal'
    END AS connection_status
FROM connection_stats
ORDER BY database_name, timestamp;
```

---

## 5. PostgreSQL 18å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—

### 5.1 å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—æ¦‚è¿°

**PostgreSQL 18å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—**ï¼šåˆ©ç”¨PostgreSQL 18çš„å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ›ï¼Œæ˜¾è‘—æå‡å¤§è§„æ¨¡æ€§èƒ½æŒ‡æ ‡è®¡ç®—çš„æ€§èƒ½ã€‚

#### å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—é…ç½®

```sql
-- é…ç½®å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å‚æ•°ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾ç½®å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
        SET max_parallel_workers_per_gather = 4;

        -- è®¾ç½®å¹¶è¡Œè¡¨æ‰«æé˜ˆå€¼
        SET min_parallel_table_scan_size = '8MB';

        -- è®¾ç½®å¹¶è¡Œèšåˆæˆæœ¬é˜ˆå€¼
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å‚æ•°å·²é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å®žçŽ°

```sql
-- å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—ï¼šå¤§è§„æ¨¡ç›‘æŽ§æ•°æ®ç»Ÿè®¡ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
        SET max_parallel_workers_per_gather = 4;
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¹¶è¡Œæ€§èƒ½æŒ‡æ ‡èšåˆç»Ÿè®¡
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH parallel_metrics AS (
    SELECT
        metric_name,
        timestamp,
        metric_value
    FROM performance_metrics
    WHERE timestamp >= CURRENT_DATE - INTERVAL '7 days'
),
parallel_stats AS (
    SELECT
        metric_name,
        COUNT(*) AS sample_count,
        AVG(metric_value) AS avg_value,
        MIN(metric_value) AS min_value,
        MAX(metric_value) AS max_value,
        STDDEV(metric_value) AS stddev_value,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY metric_value) AS median_value,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY metric_value) AS p95_value
    FROM parallel_metrics
    GROUP BY metric_name
)
SELECT
    metric_name,
    sample_count,
    ROUND(avg_value::numeric, 2) AS avg_value,
    ROUND(min_value::numeric, 2) AS min_value,
    ROUND(max_value::numeric, 2) AS max_value,
    ROUND(stddev_value::numeric, 2) AS stddev_value,
    ROUND(median_value::numeric, 2) AS median_value,
    ROUND(p95_value::numeric, 2) AS p95_value
FROM parallel_stats
ORDER BY metric_name;
```

---

## 6. æ€§èƒ½æŒ‡æ ‡ä¼˜åŒ–ç­–ç•¥

### 6.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- ç³»ç»ŸæŒ‡æ ‡è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_system_metrics_timestamp_metric
        ON system_metrics(timestamp, metric_name);

        CREATE INDEX IF NOT EXISTS idx_system_metrics_metric_timestamp
        ON system_metrics(metric_name, timestamp);

        -- ç£ç›˜I/Oè¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_disk_io_metrics_timestamp_device
        ON disk_io_metrics(timestamp, device);

        -- æŸ¥è¯¢æ€§èƒ½è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_query_performance_timestamp_query
        ON query_performance(timestamp, query_id);

        RAISE NOTICE 'æ€§èƒ½æŒ‡æ ‡ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 6.2 èšåˆä¼˜åŒ–

**èšåˆä¼˜åŒ–**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¸¸ç”¨ç»Ÿè®¡ã€‚

```sql
-- èšåˆä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
CREATE MATERIALIZED VIEW IF NOT EXISTS performance_metrics_summary AS
SELECT
    metric_name,
    DATE_TRUNC('hour', timestamp) AS hour,
    COUNT(*) AS sample_count,
    AVG(metric_value) AS avg_value,
    MIN(metric_value) AS min_value,
    MAX(metric_value) AS max_value,
    STDDEV(metric_value) AS std_value
FROM system_metrics
GROUP BY metric_name, DATE_TRUNC('hour', timestamp);

CREATE INDEX IF NOT EXISTS idx_performance_metrics_summary_metric_hour
ON performance_metrics_summary(metric_name, hour);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY performance_metrics_summary;
```

### 6.3 å®žæ—¶ç›‘æŽ§ä¼˜åŒ–

**å®žæ—¶ç›‘æŽ§ä¼˜åŒ–**ï¼šä¼˜åŒ–å®žæ—¶ç›‘æŽ§æŸ¥è¯¢æ€§èƒ½ã€‚

```sql
-- å®žæ—¶ç›‘æŽ§ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '256MB';
        RAISE NOTICE 'å®žæ—¶ç›‘æŽ§ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å®žæ—¶ç›‘æŽ§ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 7. å®žé™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿

**æ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿**ç»¼åˆå±•ç¤ºå„é¡¹æ€§èƒ½æŒ‡æ ‡ã€‚

```sql
-- æ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿æ•°æ®æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆç›‘æŽ§ä»ªè¡¨æ¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆæ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æŽ§ä»ªè¡¨æ¿ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿæˆæ€§èƒ½ç›‘æŽ§ä»ªè¡¨æ¿æ•°æ®
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH latest_metrics AS (
    SELECT
        metric_name,
        metric_value,
        timestamp
    FROM system_metrics
    WHERE timestamp = (SELECT MAX(timestamp) FROM system_metrics)
),
summary_stats AS (
    SELECT
        metric_name,
        COUNT(*) AS sample_count,
        AVG(metric_value) AS avg_value,
        MIN(metric_value) AS min_value,
        MAX(metric_value) AS max_value,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY metric_value) AS p95_value
    FROM system_metrics
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
    GROUP BY metric_name
)
SELECT
    lm.metric_name,
    lm.metric_value AS current_value,
    ROUND(ss.avg_value::numeric, 2) AS avg_value_1h,
    ROUND(ss.min_value::numeric, 2) AS min_value_1h,
    ROUND(ss.max_value::numeric, 2) AS max_value_1h,
    ROUND(ss.p95_value::numeric, 2) AS p95_value_1h,
    CASE
        WHEN lm.metric_name = 'cpu_usage' AND lm.metric_value > 80 THEN 'Critical'
        WHEN lm.metric_name = 'cpu_usage' AND lm.metric_value > 70 THEN 'Warning'
        WHEN lm.metric_name = 'memory_usage' AND lm.metric_value > 90 THEN 'Critical'
        WHEN lm.metric_name = 'memory_usage' AND lm.metric_value > 80 THEN 'Warning'
        ELSE 'Normal'
    END AS status
FROM latest_metrics lm
JOIN summary_stats ss ON lm.metric_name = ss.metric_name
ORDER BY lm.metric_name;
```

### 7.2 æ€§èƒ½è¶‹åŠ¿åˆ†æž

**æ€§èƒ½è¶‹åŠ¿åˆ†æž**ï¼šåˆ†æžæ€§èƒ½æŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿ã€‚

```sql
-- æ€§èƒ½è¶‹åŠ¿åˆ†æžï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æžæ€§èƒ½è¶‹åŠ¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æžæ€§èƒ½è¶‹åŠ¿';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½è¶‹åŠ¿åˆ†æžå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½è¶‹åŠ¿åˆ†æžï¼šè¯†åˆ«æ€§èƒ½å˜åŒ–è¶‹åŠ¿
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH hourly_metrics AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        metric_name,
        AVG(metric_value) AS avg_value,
        MIN(metric_value) AS min_value,
        MAX(metric_value) AS max_value
    FROM system_metrics
    WHERE timestamp >= NOW() - INTERVAL '24 hours'
    GROUP BY DATE_TRUNC('hour', timestamp), metric_name
),
trend_analysis AS (
    SELECT
        hour,
        metric_name,
        avg_value,
        LAG(avg_value) OVER (PARTITION BY metric_name ORDER BY hour) AS prev_avg,
        AVG(avg_value) OVER (
            PARTITION BY metric_name
            ORDER BY hour
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ) AS moving_avg_4h
    FROM hourly_metrics
)
SELECT
    hour,
    metric_name,
    ROUND(avg_value::numeric, 2) AS avg_value,
    ROUND(prev_avg::numeric, 2) AS prev_avg,
    ROUND(moving_avg_4h::numeric, 2) AS moving_avg_4h,
    ROUND(((avg_value - COALESCE(prev_avg, avg_value)) / NULLIF(prev_avg, 0) * 100)::numeric, 2) AS change_pct,
    CASE
        WHEN avg_value > moving_avg_4h * 1.2 THEN 'Increasing Trend'
        WHEN avg_value < moving_avg_4h * 0.8 THEN 'Decreasing Trend'
        ELSE 'Stable Trend'
    END AS trend_direction
FROM trend_analysis
WHERE prev_avg IS NOT NULL
ORDER BY metric_name, hour;
```

### 7.3 æ€§èƒ½å‘Šè­¦ç³»ç»Ÿ

**æ€§èƒ½å‘Šè­¦ç³»ç»Ÿ**ï¼šåŸºäºŽæ€§èƒ½æŒ‡æ ‡ç”Ÿæˆå‘Šè­¦ã€‚

```sql
-- æ€§èƒ½å‘Šè­¦ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    cpu_warning_threshold NUMERIC := 70;
    cpu_critical_threshold NUMERIC := 80;
    memory_warning_threshold NUMERIC := 80;
    memory_critical_threshold NUMERIC := 90;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ€§èƒ½å‘Šè­¦';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆæ€§èƒ½å‘Šè­¦ï¼ŒCPUè­¦å‘Šé˜ˆå€¼: %, ä¸´ç•Œé˜ˆå€¼: %', cpu_warning_threshold, cpu_critical_threshold;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½å‘Šè­¦ç³»ç»Ÿå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½å‘Šè­¦ç³»ç»Ÿï¼šå®žæ—¶ç›‘æŽ§å¹¶ç”Ÿæˆå‘Šè­¦
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH recent_metrics AS (
    SELECT
        timestamp,
        metric_name,
        metric_value
    FROM system_metrics
    WHERE timestamp >= NOW() - INTERVAL '5 minutes'
),
alert_conditions AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        CASE
            WHEN metric_name = 'cpu_usage' AND metric_value > cpu_critical_threshold THEN 'CRITICAL'
            WHEN metric_name = 'cpu_usage' AND metric_value > cpu_warning_threshold THEN 'WARNING'
            WHEN metric_name = 'memory_usage' AND metric_value > memory_critical_threshold THEN 'CRITICAL'
            WHEN metric_name = 'memory_usage' AND metric_value > memory_warning_threshold THEN 'WARNING'
            ELSE 'NORMAL'
        END AS alert_level,
        CASE
            WHEN metric_name = 'cpu_usage' AND metric_value > cpu_critical_threshold THEN 'CPU usage exceeds critical threshold'
            WHEN metric_name = 'cpu_usage' AND metric_value > cpu_warning_threshold THEN 'CPU usage exceeds warning threshold'
            WHEN metric_name = 'memory_usage' AND metric_value > memory_critical_threshold THEN 'Memory usage exceeds critical threshold'
            WHEN metric_name = 'memory_usage' AND metric_value > memory_warning_threshold THEN 'Memory usage exceeds warning threshold'
            ELSE NULL
        END AS alert_message
    FROM recent_metrics
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    alert_level,
    alert_message
FROM alert_conditions
WHERE alert_level != 'NORMAL'
ORDER BY
    CASE alert_level WHEN 'CRITICAL' THEN 1 WHEN 'WARNING' THEN 2 ELSE 3 END,
    timestamp DESC;
```

### 7.4 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

**æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**ï¼šè¯†åˆ«ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆã€‚

```sql
-- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'disk_io_metrics') THEN
            RAISE WARNING 'è¡¨ disk_io_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'query_performance') THEN
            RAISE WARNING 'è¡¨ query_performance ä¸å­˜åœ¨ï¼Œæ— æ³•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½ç“¶é¢ˆè¯†åˆ«å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«ï¼šç»¼åˆåˆ†æžå¤šä¸ªæŒ‡æ ‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH cpu_bottleneck AS (
    SELECT
        'CPU' AS resource_type,
        COUNT(*) FILTER (WHERE metric_value > 80) AS critical_count,
        AVG(metric_value) FILTER (WHERE metric_value > 80) AS avg_critical_value
    FROM system_metrics
    WHERE metric_name = 'cpu_usage' AND timestamp >= NOW() - INTERVAL '1 hour'
),
memory_bottleneck AS (
    SELECT
        'Memory' AS resource_type,
        COUNT(*) FILTER (WHERE metric_value > 90) AS critical_count,
        AVG(metric_value) FILTER (WHERE metric_value > 90) AS avg_critical_value
    FROM system_metrics
    WHERE metric_name = 'memory_usage' AND timestamp >= NOW() - INTERVAL '1 hour'
),
io_bottleneck AS (
    SELECT
        'Disk I/O' AS resource_type,
        COUNT(*) FILTER (WHERE read_iops + write_iops > 1000) AS critical_count,
        AVG(read_iops + write_iops) FILTER (WHERE read_iops + write_iops > 1000) AS avg_critical_value
    FROM disk_io_metrics
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
),
query_bottleneck AS (
    SELECT
        'Query Performance' AS resource_type,
        COUNT(*) FILTER (WHERE execution_time_ms > 1000) AS critical_count,
        AVG(execution_time_ms) FILTER (WHERE execution_time_ms > 1000) AS avg_critical_value
    FROM query_performance
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
),
all_bottlenecks AS (
    SELECT * FROM cpu_bottleneck
    UNION ALL SELECT * FROM memory_bottleneck
    UNION ALL SELECT * FROM io_bottleneck
    UNION ALL SELECT * FROM query_bottleneck
)
SELECT
    resource_type,
    critical_count,
    ROUND(avg_critical_value::numeric, 2) AS avg_critical_value,
    CASE
        WHEN critical_count > 10 THEN 'Severe Bottleneck'
        WHEN critical_count > 5 THEN 'Moderate Bottleneck'
        WHEN critical_count > 0 THEN 'Minor Bottleneck'
        ELSE 'No Bottleneck'
    END AS bottleneck_severity,
    CASE
        WHEN critical_count > 10 THEN 'Immediate action required'
        WHEN critical_count > 5 THEN 'Investigation recommended'
        WHEN critical_count > 0 THEN 'Monitor closely'
        ELSE 'System operating normally'
    END AS recommendation
FROM all_bottlenecks
ORDER BY critical_count DESC;
```

---

## 8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸Žä¼˜åŒ–

### 8.1 æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **çž¬æ—¶å€¼** | $I_t = M_t$ | $O(1)$ | $O(1)$ | å®žæ—¶ç›‘æŽ§ | ç®€å•ã€å¿«é€Ÿ | æ³¢åŠ¨å¤§ |
| **ç§»åŠ¨å¹³å‡** | $I_t = \frac{1}{n}\sum_{i=0}^{n-1} M_{t-i}$ | $O(n)$ | $O(1)$ | è¶‹åŠ¿åˆ†æž | å¹³æ»‘ | æ»žåŽæ€§ |
| **èšåˆç»Ÿè®¡** | $I = \{\text{avg}, \text{min}, \text{max}, \text{std}\}$ | $O(n)$ | $O(1)$ | åŽ†å²åˆ†æž | å…¨é¢ | è®¡ç®—å¤æ‚ |

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨(timestamp, metric_name)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•

2. **èšåˆä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»Ÿè®¡
   - æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨æ•°æ®

3. **å®žæ—¶ç›‘æŽ§**ï¼š
   - é™åˆ¶æŸ¥è¯¢æ—¶é—´èŒƒå›´
   - ä½¿ç”¨é‡‡æ ·å‡å°‘æ•°æ®é‡

### 8.3 å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šç›‘æŽ§æ•°æ®é‡å¤§

- **è§£å†³æ–¹æ¡ˆ**ï¼šæ—¶é—´åˆ†åŒºã€æ•°æ®å½’æ¡£ã€é‡‡æ ·

**é—®é¢˜2**ï¼šå®žæ—¶æŸ¥è¯¢æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šç‰©åŒ–è§†å›¾ã€ç´¢å¼•ä¼˜åŒ–ã€é™åˆ¶æ—¶é—´èŒƒå›´

**é—®é¢˜3**ï¼šå‘Šè­¦è¯¯æŠ¥å¤š

- **è§£å†³æ–¹æ¡ˆ**ï¼šè°ƒæ•´é˜ˆå€¼ã€ä½¿ç”¨ç§»åŠ¨å¹³å‡ã€æ·»åŠ è¿‡æ»¤æ¡ä»¶

**é—®é¢˜4**ï¼šæŒ‡æ ‡ä¸ä¸€è‡´

- **è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€è®¡ç®—æ–¹æ³•ã€æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ã€å®šæœŸæ ¡å‡†

---

## 9. æœ€ä½³å®žè·µ

### 9.1 æŒ‡æ ‡é€‰æ‹©

1. **æ ¸å¿ƒæŒ‡æ ‡**ï¼šCPUã€å†…å­˜ã€ç£ç›˜I/Oã€ç½‘ç»œ
2. **æ•°æ®åº“æŒ‡æ ‡**ï¼šæŸ¥è¯¢æ€§èƒ½ã€è¿žæŽ¥æ•°ã€äº‹åŠ¡åžåé‡
3. **ä¸šåŠ¡æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€é”™è¯¯çŽ‡ã€åžåé‡

### 9.2 é‡‡æ ·é¢‘çŽ‡

1. **å®žæ—¶ç›‘æŽ§**ï¼š1-5åˆ†é’Ÿé‡‡æ ·
2. **è¶‹åŠ¿åˆ†æž**ï¼š15-60åˆ†é’Ÿé‡‡æ ·
3. **åŽ†å²åˆ†æž**ï¼š1å°æ—¶æˆ–1å¤©é‡‡æ ·

### 9.3 æ•°æ®ä¿ç•™

1. **å®žæ—¶æ•°æ®**ï¼šä¿ç•™1-7å¤©
2. **åŽ†å²æ•°æ®**ï¼šä¿ç•™30-90å¤©
3. **å½’æ¡£æ•°æ®**ï¼šä¿ç•™1å¹´ä»¥ä¸Š

### 9.4 SQLå®žçŽ°æ³¨æ„äº‹é¡¹

1. **æ—¶é—´èŒƒå›´**ï¼šé™åˆ¶æŸ¥è¯¢æ—¶é—´èŒƒå›´
2. **ç´¢å¼•ä½¿ç”¨**ï¼šç¡®ä¿ä½¿ç”¨ç´¢å¼•
3. **èšåˆä¼˜åŒ–**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†NULLå€¼å’Œè¾¹ç•Œæƒ…å†µ

### 9.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢žå¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢žå¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½æŒ‡æ ‡è®¡ç®—çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºŽåŒ…å«æ€§èƒ½æŒ‡æ ‡çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºŽTop-Næ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢žå¼º**ï¼š
   - å¯¹äºŽå¤§è§„æ¨¡æ€§èƒ½æŒ‡æ ‡è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºŽæ‰¹é‡æŒ‡æ ‡è®¡ç®—å’Œå®žæ—¶ç›‘æŽ§

3. **å¹¶è¡ŒæŸ¥è¯¢å¢žå¼º**ï¼š
   - æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨5èŠ‚è¯¦ç»†è¯´æ˜Žï¼‰
   - é€‚ç”¨äºŽå¤§è§„æ¨¡æ€§èƒ½ç»Ÿè®¡å’Œå¤šæŒ‡æ ‡è®¡ç®—

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–æ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢**

```sql
-- ä¸ºæ€§èƒ½æŒ‡æ ‡åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_performance_metrics_skip_scan
ON system_metrics(metric_name, timestamp DESC, metric_value DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªæŒ‡æ ‡æœ€æ–°æ—¶é—´ç‚¹çš„å‰5ä¸ªæœ€é«˜å€¼
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (metric_name)
    metric_name,
    timestamp,
    metric_value
FROM system_metrics
WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
ORDER BY metric_name, timestamp DESC, metric_value DESC
LIMIT 50;
```

### 9.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢žå¼ºï¼‰

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ç»“æžœ**

å¯¹äºŽé¢‘ç¹ä½¿ç”¨çš„æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ç»“æžœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ç»“æžœ
CREATE MATERIALIZED VIEW IF NOT EXISTS performance_metrics_cache AS
WITH performance_statistics AS (
    SELECT
        metric_name,
        DATE_TRUNC('hour', timestamp) AS time_bucket,
        COUNT(*) AS sample_count,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS stddev_value,
        MIN(metric_value) AS min_value,
        MAX(metric_value) AS max_value,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY metric_value) AS p95_value,
        PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY metric_value) AS p99_value,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç§»åŠ¨å¹³å‡å’Œè¶‹åŠ¿ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY DATE_TRUNC('hour', timestamp)
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ) AS moving_avg_3,
        CASE
            WHEN LAG(AVG(metric_value)) OVER (
                PARTITION BY metric_name
                ORDER BY DATE_TRUNC('hour', timestamp)
            ) > 0 THEN
                (AVG(metric_value) - LAG(AVG(metric_value)) OVER (
                    PARTITION BY metric_name
                    ORDER BY DATE_TRUNC('hour', timestamp)
                )) / LAG(AVG(metric_value)) OVER (
                    PARTITION BY metric_name
                    ORDER BY DATE_TRUNC('hour', timestamp)
                ) * 100
            ELSE NULL
        END AS hourly_change_pct
    FROM system_metrics
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '7 days'
    GROUP BY metric_name, DATE_TRUNC('hour', timestamp)
)
SELECT
    metric_name,
    time_bucket,
    sample_count,
    ROUND(mean_value::numeric, 4) AS mean_value,
    ROUND(stddev_value::numeric, 4) AS stddev_value,
    min_value,
    max_value,
    ROUND(p95_value::numeric, 4) AS p95_value,
    ROUND(p99_value::numeric, 4) AS p99_value,
    ROUND(moving_avg_3::numeric, 4) AS moving_avg_3,
    ROUND(hourly_change_pct::numeric, 2) AS hourly_change_pct,
    CASE
        WHEN hourly_change_pct > 20 THEN 'Significant Increase'
        WHEN hourly_change_pct > 10 THEN 'Moderate Increase'
        WHEN hourly_change_pct < -20 THEN 'Significant Decrease'
        WHEN hourly_change_pct < -10 THEN 'Moderate Decrease'
        ELSE 'Stable'
    END AS trend_status
FROM performance_statistics;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_performance_metrics_cache_metric_time ON performance_metrics_cache(metric_name, time_bucket DESC);
CREATE INDEX idx_performance_metrics_cache_trend ON performance_metrics_cache(trend_status, hourly_change_pct DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY performance_metrics_cache;
```

**2. å®žæ—¶æ€§èƒ½ç›‘æŽ§ï¼šå¢žé‡æŒ‡æ ‡æ›´æ–°**

**å®žæ—¶æ€§èƒ½ç›‘æŽ§**ï¼šå¯¹äºŽå®žæ—¶æ•°æ®ï¼Œä½¿ç”¨å¢žé‡æ–¹æ³•æ›´æ–°æ€§èƒ½æŒ‡æ ‡ç»“æžœã€‚

```sql
-- å®žæ—¶æ€§èƒ½ç›‘æŽ§ï¼šå¢žé‡æŒ‡æ ‡æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'performance_metrics_state') THEN
            CREATE TABLE performance_metrics_state (
                metric_name VARCHAR(100) NOT NULL,
                time_bucket TIMESTAMPTZ NOT NULL,
                sample_count BIGINT DEFAULT 0,
                sum_value NUMERIC DEFAULT 0,
                sum_squared_value NUMERIC DEFAULT 0,
                min_value NUMERIC,
                max_value NUMERIC,
                last_value NUMERIC,
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                PRIMARY KEY (metric_name, time_bucket)
            );

            CREATE INDEX idx_performance_metrics_state_metric_time ON performance_metrics_state(metric_name, time_bucket DESC);
            CREATE INDEX idx_performance_metrics_state_updated ON performance_metrics_state(last_updated DESC);

            RAISE NOTICE 'æ€§èƒ½æŒ‡æ ‡çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢žé‡æŒ‡æ ‡æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢žé‡æŒ‡æ ‡æ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢žé‡æ›´æ–°æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ï¼šå®žæ—¶æ€§èƒ½ç›‘æŽ§
WITH new_metrics AS (
    SELECT
        metric_name,
        DATE_TRUNC('minute', timestamp) AS time_bucket,
        metric_value
    FROM system_metrics
    WHERE timestamp > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM performance_metrics_state)
      AND timestamp <= CURRENT_TIMESTAMP
),
updated_metrics AS (
    SELECT
        COALESCE(pms.metric_name, nm.metric_name) AS metric_name,
        COALESCE(pms.time_bucket, nm.time_bucket) AS time_bucket,
        COALESCE(pms.sample_count, 0) + COUNT(*) AS new_sample_count,
        COALESCE(pms.sum_value, 0) + SUM(nm.metric_value) AS new_sum_value,
        COALESCE(pms.sum_squared_value, 0) + SUM(POWER(nm.metric_value, 2)) AS new_sum_squared_value,
        LEAST(COALESCE(pms.min_value, nm.metric_value), MIN(nm.metric_value)) AS new_min_value,
        GREATEST(COALESCE(pms.max_value, nm.metric_value), MAX(nm.metric_value)) AS new_max_value,
        MAX(nm.metric_value) AS new_last_value
    FROM performance_metrics_state pms
    FULL OUTER JOIN new_metrics nm ON pms.metric_name = nm.metric_name AND pms.time_bucket = nm.time_bucket
    GROUP BY pms.metric_name, nm.metric_name, pms.time_bucket, nm.time_bucket,
             pms.sample_count, pms.sum_value, pms.sum_squared_value, pms.min_value, pms.max_value
)
-- æ›´æ–°æˆ–æ’å…¥æ€§èƒ½æŒ‡æ ‡çŠ¶æ€
INSERT INTO performance_metrics_state (
    metric_name,
    time_bucket,
    sample_count,
    sum_value,
    sum_squared_value,
    min_value,
    max_value,
    last_value,
    last_updated
)
SELECT
    metric_name,
    time_bucket,
    new_sample_count,
    new_sum_value,
    new_sum_squared_value,
    new_min_value,
    new_max_value,
    new_last_value,
    NOW()
FROM updated_metrics
ON CONFLICT (metric_name, time_bucket)
DO UPDATE SET
    sample_count = EXCLUDED.sample_count,
    sum_value = EXCLUDED.sum_value,
    sum_squared_value = EXCLUDED.sum_squared_value,
    min_value = EXCLUDED.min_value,
    max_value = EXCLUDED.max_value,
    last_value = EXCLUDED.last_value,
    last_updated = NOW();
```

**3. æ™ºèƒ½æ€§èƒ½ç›‘æŽ§ï¼šè‡ªé€‚åº”å‘Šè­¦é˜ˆå€¼**

**æ™ºèƒ½æ€§èƒ½ç›‘æŽ§**ï¼šæ ¹æ®åŽ†å²æ•°æ®è‡ªåŠ¨è°ƒæ•´å‘Šè­¦é˜ˆå€¼ã€‚

```sql
-- æ™ºèƒ½æ€§èƒ½ç›‘æŽ§ï¼šè‡ªé€‚åº”å‘Šè­¦é˜ˆå€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'system_metrics') THEN
            RAISE WARNING 'è¡¨ system_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½æ€§èƒ½ç›‘æŽ§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ™ºèƒ½æ€§èƒ½ç›‘æŽ§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½æ€§èƒ½ç›‘æŽ§å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ™ºèƒ½æ€§èƒ½ç›‘æŽ§ï¼šåŸºäºŽåŽ†å²æ•°æ®çš„è‡ªé€‚åº”å‘Šè­¦é˜ˆå€¼
WITH historical_statistics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS historical_mean,
        STDDEV(metric_value) AS historical_stddev,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY metric_value) AS historical_p95,
        PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY metric_value) AS historical_p99,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—åŠ¨æ€é˜ˆå€¼ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        AVG(metric_value) + 2 * STDDEV(metric_value) AS warning_threshold,
        AVG(metric_value) + 3 * STDDEV(metric_value) AS critical_threshold
    FROM system_metrics
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'
      AND timestamp < CURRENT_TIMESTAMP - INTERVAL '1 day'  -- ä½¿ç”¨åŽ†å²æ•°æ®è®¡ç®—é˜ˆå€¼
    GROUP BY metric_name
),
current_metrics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS current_mean,
        MAX(metric_value) AS current_max,
        COUNT(*) AS current_count
    FROM system_metrics
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '1 hour'  -- å½“å‰1å°æ—¶çš„æ•°æ®
    GROUP BY metric_name
),
adaptive_alerts AS (
    SELECT
        cm.metric_name,
        cm.current_mean,
        cm.current_max,
        cm.current_count,
        hs.historical_mean,
        hs.historical_stddev,
        hs.historical_p95,
        hs.historical_p99,
        hs.warning_threshold,
        hs.critical_threshold,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—åç¦»åº¦ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        ABS(cm.current_mean - hs.historical_mean) / NULLIF(hs.historical_stddev, 0) AS z_score,
        CASE
            WHEN cm.current_max > hs.critical_threshold THEN 'CRITICAL'
            WHEN cm.current_mean > hs.warning_threshold THEN 'WARNING'
            WHEN ABS(cm.current_mean - hs.historical_mean) / NULLIF(hs.historical_stddev, 0) > 3 THEN 'STATISTICAL_ANOMALY'
            ELSE 'NORMAL'
        END AS alert_level
    FROM current_metrics cm
    JOIN historical_statistics hs ON cm.metric_name = hs.metric_name
)
SELECT
    metric_name,
    ROUND(current_mean::numeric, 4) AS current_mean,
    ROUND(current_max::numeric, 4) AS current_max,
    current_count,
    ROUND(historical_mean::numeric, 4) AS historical_mean,
    ROUND(historical_p95::numeric, 4) AS historical_p95,
    ROUND(warning_threshold::numeric, 4) AS warning_threshold,
    ROUND(critical_threshold::numeric, 4) AS critical_threshold,
    ROUND(z_score::numeric, 4) AS z_score,
    alert_level,
    CASE
        WHEN alert_level = 'CRITICAL' THEN 'Immediate action required - metric exceeds critical threshold'
        WHEN alert_level = 'WARNING' THEN 'Investigation recommended - metric exceeds warning threshold'
        WHEN alert_level = 'STATISTICAL_ANOMALY' THEN 'Statistical anomaly detected - significant deviation from historical pattern'
        ELSE 'Metric operating within normal range'
    END AS alert_message
FROM adaptive_alerts
WHERE alert_level != 'NORMAL'
ORDER BY
    CASE alert_level
        WHEN 'CRITICAL' THEN 1
        WHEN 'WARNING' THEN 2
        WHEN 'STATISTICAL_ANOMALY' THEN 3
        ELSE 4
    END,
    z_score DESC NULLS LAST
LIMIT 50;
```

---

## ðŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–ã€‹ï¼ˆSystems Performanceï¼‰- æ€§èƒ½ç›‘æŽ§ç†è®º
- ã€Šæ•°æ®åº“æ€§èƒ½è°ƒä¼˜ã€‹ï¼ˆDatabase Performance Tuningï¼‰- æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [ç³»ç»Ÿè§†å›¾](https://www.postgresql.org/docs/current/monitoring-stats.html)
- [æ€§èƒ½ç»Ÿè®¡](https://www.postgresql.org/docs/current/monitoring.html)
- [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)

### åœ¨çº¿èµ„æº

- PostgreSQLæ€§èƒ½ç›‘æŽ§æŒ‡å—
- ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡è¯¦è§£
- æ€§èƒ½ç›‘æŽ§æœ€ä½³å®žè·µ

### ç›¸å…³ç®—æ³•

- [å®¹é‡è§„åˆ’ç®—æ³•](./å®¹é‡è§„åˆ’ç®—æ³•.md) - å®¹é‡è§„åˆ’
- [å¼‚å¸¸æ£€æµ‹ç®—æ³•](./å¼‚å¸¸æ£€æµ‹ç®—æ³•.md) - å¼‚å¸¸æ£€æµ‹
- [èµ„æºä¼˜åŒ–ç®—æ³•](./èµ„æºä¼˜åŒ–ç®—æ³•.md) - èµ„æºä¼˜åŒ–

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
