# PostgreSQL å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å¼‚å¸¸æ£€æµ‹ | ç›‘æ§å‘Šè­¦
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å¼‚å¸¸æ£€æµ‹æ¦‚è¿°](#å¼‚å¸¸æ£€æµ‹æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹](#1-ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹)
    - [1.1 Z-scoreæ–¹æ³•](#11-z-scoreæ–¹æ³•)
    - [1.2 IQRæ–¹æ³•](#12-iqræ–¹æ³•)
  - [2. æ—¶é—´åºåˆ—å¼‚å¸¸](#2-æ—¶é—´åºåˆ—å¼‚å¸¸)
    - [2.1 ç§»åŠ¨å¹³å‡å¼‚å¸¸](#21-ç§»åŠ¨å¹³å‡å¼‚å¸¸)
  - [3. å¼‚å¸¸è¯„åˆ†](#3-å¼‚å¸¸è¯„åˆ†)
    - [3.1 å¼‚å¸¸è¯„åˆ†è®¡ç®—](#31-å¼‚å¸¸è¯„åˆ†è®¡ç®—)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹](#41-ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## å¼‚å¸¸æ£€æµ‹æ¦‚è¿°

**å¼‚å¸¸æ£€æµ‹**è¯†åˆ«æ•°æ®ä¸­çš„å¼‚å¸¸å€¼ï¼Œç”¨äºç³»ç»Ÿç›‘æ§å’Œæ•…éšœé¢„è­¦ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **Z-score** | ç»Ÿè®¡å¼‚å¸¸ | O(n) |
| **IQR** | å››åˆ†ä½è·å¼‚å¸¸ | O(n log n) |
| **ç§»åŠ¨å¹³å‡** | æ—¶é—´åºåˆ—å¼‚å¸¸ | O(n) |

---

## 1. ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹

### 1.1 Z-scoreæ–¹æ³•

**Z-scoreæ–¹æ³•**åŸºäºæ ‡å‡†å·®è¯†åˆ«å¼‚å¸¸å€¼ã€‚

```sql
-- åˆ›å»ºç›‘æ§æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE monitoring_data CASCADE;
        END IF;

        CREATE TABLE monitoring_data (
            timestamp TIMESTAMP NOT NULL,
            metric_name VARCHAR(50) NOT NULL,
            metric_value NUMERIC(10, 2) NOT NULL,
            PRIMARY KEY (timestamp, metric_name)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«ä¸€äº›å¼‚å¸¸å€¼ï¼‰
        INSERT INTO monitoring_data (timestamp, metric_name, metric_value) VALUES
            ('2024-01-01 10:00:00', 'cpu_usage', 45.5),
            ('2024-01-01 10:01:00', 'cpu_usage', 52.3),
            ('2024-01-01 10:02:00', 'cpu_usage', 48.7),
            ('2024-01-01 10:03:00', 'cpu_usage', 95.2),  -- å¼‚å¸¸å€¼
            ('2024-01-01 10:04:00', 'cpu_usage', 50.1),
            ('2024-01-01 10:05:00', 'cpu_usage', 5.3),   -- å¼‚å¸¸å€¼
            ('2024-01-01 10:06:00', 'cpu_usage', 49.8);

        RAISE NOTICE 'è¡¨ monitoring_data åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ monitoring_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- Z-scoreå¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡ŒZ-scoreå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—Z-scoreå¹¶è¯†åˆ«å¼‚å¸¸
WITH stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
z_scores AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        s.mean_value,
        s.std_value,
        CASE
            WHEN s.std_value = 0 THEN 0
            ELSE ABS((md.metric_value - s.mean_value) / s.std_value)
        END AS z_score
    FROM monitoring_data md
    JOIN stats s ON md.metric_name = s.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(mean_value::numeric, 2) AS mean_value,
    ROUND(std_value::numeric, 2) AS std_value,
    ROUND(z_score::numeric, 2) AS z_score,
    CASE
        WHEN z_score > 3 THEN 'Critical Anomaly'
        WHEN z_score > 2 THEN 'Warning Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM z_scores
ORDER BY z_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    AVG(metric_value) AS mean_value,
    STDDEV(metric_value) AS std_value
FROM monitoring_data
GROUP BY metric_name;
```

### 1.2 IQRæ–¹æ³•

**IQRæ–¹æ³•**ä½¿ç”¨å››åˆ†ä½è·è¯†åˆ«å¼‚å¸¸å€¼ã€‚

```sql
-- IQRå¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡ŒIQRå¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡ŒIQRå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'IQRå¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨IQRæ–¹æ³•æ£€æµ‹å¼‚å¸¸
WITH quartiles AS (
    SELECT
        metric_name,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY metric_value) AS median,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM monitoring_data
    GROUP BY metric_name
),
iqr_values AS (
    SELECT
        metric_name,
        q1,
        median,
        q3,
        q3 - q1 AS iqr,
        q1 - 1.5 * (q3 - q1) AS lower_bound,
        q3 + 1.5 * (q3 - q1) AS upper_bound
    FROM quartiles
)
SELECT
    md.timestamp,
    md.metric_name,
    ROUND(md.metric_value::numeric, 2) AS metric_value,
    ROUND(iq.lower_bound::numeric, 2) AS lower_bound,
    ROUND(iq.upper_bound::numeric, 2) AS upper_bound,
    CASE
        WHEN md.metric_value < iq.lower_bound OR md.metric_value > iq.upper_bound THEN 'Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM monitoring_data md
JOIN iqr_values iq ON md.metric_name = iq.metric_name
ORDER BY md.timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
FROM monitoring_data
GROUP BY metric_name;
```

---

## 2. æ—¶é—´åºåˆ—å¼‚å¸¸

### 2.1 ç§»åŠ¨å¹³å‡å¼‚å¸¸

**ç§»åŠ¨å¹³å‡å¼‚å¸¸**åŸºäºç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®è¯†åˆ«å¼‚å¸¸ã€‚

```sql
-- ç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºç§»åŠ¨å¹³å‡çš„å¼‚å¸¸æ£€æµ‹
WITH moving_stats AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg,
        STDDEV(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_std
    FROM monitoring_data
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(moving_avg::numeric, 2) AS moving_avg,
    ROUND(moving_std::numeric, 2) AS moving_std,
    CASE
        WHEN moving_std = 0 THEN 'Normal'
        WHEN ABS(metric_value - moving_avg) > 2 * moving_std THEN 'Anomaly'
        WHEN ABS(metric_value - moving_avg) > 1.5 * moving_std THEN 'Warning'
        ELSE 'Normal'
    END AS anomaly_status,
    ROUND(ABS(metric_value - moving_avg) / NULLIF(moving_std, 0)::numeric, 2) AS deviation_score
FROM moving_stats
WHERE moving_avg IS NOT NULL AND moving_std IS NOT NULL
ORDER BY deviation_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    timestamp,
    AVG(metric_value) OVER (ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS moving_avg
FROM monitoring_data
WHERE metric_name = 'cpu_usage'
ORDER BY timestamp;
```

---

## 3. å¼‚å¸¸è¯„åˆ†

### 3.1 å¼‚å¸¸è¯„åˆ†è®¡ç®—

**å¼‚å¸¸è¯„åˆ†**é‡åŒ–å¼‚å¸¸ç¨‹åº¦ï¼Œä¾¿äºæ’åºå’Œç­›é€‰ã€‚

```sql
-- å¼‚å¸¸è¯„åˆ†è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¼‚å¸¸è¯„åˆ†';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å¼‚å¸¸è¯„åˆ†';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸è¯„åˆ†è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆå¼‚å¸¸è¯„åˆ†ï¼ˆç»“åˆZ-scoreå’ŒIQRï¼‰
WITH z_score_stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
iqr_stats AS (
    SELECT
        metric_name,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM monitoring_data
    GROUP BY metric_name
),
anomaly_scores AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        ABS((md.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) AS z_score,
        CASE
            WHEN md.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) THEN 1
            WHEN md.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 1
            ELSE 0
        END AS iqr_anomaly,
        (ABS((md.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) +
         CASE
            WHEN md.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) THEN 1 ELSE 0
            WHEN md.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 1 ELSE 0
            ELSE 0
         END) / 2.0 AS anomaly_score
    FROM monitoring_data md
    JOIN z_score_stats zs ON md.metric_name = zs.metric_name
    JOIN iqr_stats iqs ON md.metric_name = iqs.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    iqr_anomaly,
    ROUND(anomaly_score::numeric, 2) AS anomaly_score,
    CASE
        WHEN anomaly_score > 2.0 THEN 'Critical'
        WHEN anomaly_score > 1.5 THEN 'High'
        WHEN anomaly_score > 1.0 THEN 'Medium'
        ELSE 'Low'
    END AS severity
FROM anomaly_scores
ORDER BY anomaly_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    COUNT(*) AS record_count
FROM monitoring_data
GROUP BY metric_name;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹

**ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹**å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡å¹¶è¯†åˆ«å¼‚å¸¸ã€‚

```sql
-- ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®æ—¶å¼‚å¸¸æ£€æµ‹æŸ¥è¯¢
WITH recent_data AS (
    SELECT
        timestamp,
        metric_name,
        metric_value
    FROM monitoring_data
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
),
statistics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM recent_data
    GROUP BY metric_name
),
anomalies AS (
    SELECT
        rd.timestamp,
        rd.metric_name,
        rd.metric_value,
        s.mean_value,
        s.std_value,
        ABS((rd.metric_value - s.mean_value) / NULLIF(s.std_value, 0)) AS z_score,
        CASE
            WHEN rd.metric_value < s.q1 - 1.5 * (s.q3 - s.q1) OR
                 rd.metric_value > s.q3 + 1.5 * (s.q3 - s.q1) THEN TRUE
            ELSE FALSE
        END AS is_iqr_anomaly
    FROM recent_data rd
    JOIN statistics s ON rd.metric_name = s.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    is_iqr_anomaly,
    CASE
        WHEN z_score > 3 OR is_iqr_anomaly THEN 'CRITICAL'
        WHEN z_score > 2 THEN 'WARNING'
        ELSE 'NORMAL'
    END AS alert_level
FROM anomalies
WHERE z_score > 2 OR is_iqr_anomaly
ORDER BY z_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    AVG(metric_value) AS mean_value
FROM monitoring_data
WHERE timestamp >= NOW() - INTERVAL '1 hour'
GROUP BY metric_name;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨(timestamp, metric_name)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
2. **çª—å£å‡½æ•°**: å……åˆ†åˆ©ç”¨çª—å£å‡½æ•°ä¼˜åŒ–è®¡ç®—
3. **é‡‡æ ·**: å¯¹å¤§æ•°æ®é›†è¿›è¡Œé‡‡æ ·åˆ†æ

## ğŸ¯ æœ€ä½³å®è·µ

1. **é˜ˆå€¼è°ƒæ•´**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´å¼‚å¸¸é˜ˆå€¼
2. **å¤šæ–¹æ³•ç»“åˆ**: ç»“åˆå¤šç§æ–¹æ³•æé«˜å‡†ç¡®æ€§
3. **ä¸Šä¸‹æ–‡è€ƒè™‘**: è€ƒè™‘ä¸šåŠ¡ä¸Šä¸‹æ–‡åˆ¤æ–­å¼‚å¸¸
4. **å‘Šè­¦ç­–ç•¥**: è®¾ç½®åˆç†çš„å‘Šè­¦ç­–ç•¥é¿å…è¯¯æŠ¥

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
