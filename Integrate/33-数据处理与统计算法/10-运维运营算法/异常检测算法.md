# PostgreSQL å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å¼‚å¸¸æ£€æµ‹ | ç›‘æ§å‘Šè­¦
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å¼‚å¸¸æ£€æµ‹ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å¼‚å¸¸æ£€æµ‹æ¦‚è¿°](#å¼‚å¸¸æ£€æµ‹æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [å¼‚å¸¸æ£€æµ‹é—®é¢˜å®šä¹‰](#å¼‚å¸¸æ£€æµ‹é—®é¢˜å®šä¹‰)
      - [å¼‚å¸¸æ£€æµ‹æ–¹æ³•åˆ†ç±»](#å¼‚å¸¸æ£€æµ‹æ–¹æ³•åˆ†ç±»)
      - [å¼‚å¸¸æ£€æµ‹æ–¹æ³•é€‰æ‹©](#å¼‚å¸¸æ£€æµ‹æ–¹æ³•é€‰æ‹©)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹](#1-ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹)
    - [1.1 ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹åŸç†](#11-ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹åŸç†)
      - [å¼‚å¸¸å€¼å®šä¹‰](#å¼‚å¸¸å€¼å®šä¹‰)
      - [ç»Ÿè®¡æ–¹æ³•](#ç»Ÿè®¡æ–¹æ³•)
    - [1.2 Z-scoreæ–¹æ³•å®ç°](#12-z-scoreæ–¹æ³•å®ç°)
    - [1.3 IQRæ–¹æ³•å®ç°](#13-iqræ–¹æ³•å®ç°)
    - [1.4 3-sigmaè§„åˆ™](#14-3-sigmaè§„åˆ™)
  - [2. æ—¶é—´åºåˆ—å¼‚å¸¸](#2-æ—¶é—´åºåˆ—å¼‚å¸¸)
    - [2.1 æ—¶é—´åºåˆ—å¼‚å¸¸åŸç†](#21-æ—¶é—´åºåˆ—å¼‚å¸¸åŸç†)
      - [æ—¶é—´åºåˆ—å¼‚å¸¸å®šä¹‰](#æ—¶é—´åºåˆ—å¼‚å¸¸å®šä¹‰)
      - [æ£€æµ‹æ–¹æ³•](#æ£€æµ‹æ–¹æ³•)
    - [2.2 ç§»åŠ¨å¹³å‡å¼‚å¸¸å®ç°](#22-ç§»åŠ¨å¹³å‡å¼‚å¸¸å®ç°)
    - [2.3 è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹](#23-è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹)
  - [3. å¼‚å¸¸è¯„åˆ†](#3-å¼‚å¸¸è¯„åˆ†)
    - [3.1 å¼‚å¸¸è¯„åˆ†åŸç†](#31-å¼‚å¸¸è¯„åˆ†åŸç†)
      - [å¼‚å¸¸è¯„åˆ†å®šä¹‰](#å¼‚å¸¸è¯„åˆ†å®šä¹‰)
      - [è¯„åˆ†æ–¹æ³•](#è¯„åˆ†æ–¹æ³•)
    - [3.2 å¼‚å¸¸è¯„åˆ†è®¡ç®—å®ç°](#32-å¼‚å¸¸è¯„åˆ†è®¡ç®—å®ç°)
    - [3.3 ç»¼åˆå¼‚å¸¸è¯„åˆ†](#33-ç»¼åˆå¼‚å¸¸è¯„åˆ†)
  - [4. PostgreSQL 18å¹¶è¡Œå¼‚å¸¸æ£€æµ‹ä¸AIå¢å¼º](#4-postgresql-18å¹¶è¡Œå¼‚å¸¸æ£€æµ‹ä¸aiå¢å¼º)
    - [4.1 å¹¶è¡Œå¼‚å¸¸æ£€æµ‹æ¦‚è¿°](#41-å¹¶è¡Œå¼‚å¸¸æ£€æµ‹æ¦‚è¿°)
      - [å¹¶è¡Œå¼‚å¸¸æ£€æµ‹é…ç½®](#å¹¶è¡Œå¼‚å¸¸æ£€æµ‹é…ç½®)
      - [å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å®ç°](#å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å®ç°)
    - [4.2 AIå¢å¼ºå¼‚å¸¸æ£€æµ‹ï¼ˆpgvectorï¼‰](#42-aiå¢å¼ºå¼‚å¸¸æ£€æµ‹pgvector)
  - [5. å¼‚å¸¸æ£€æµ‹ä¼˜åŒ–ç­–ç•¥](#5-å¼‚å¸¸æ£€æµ‹ä¼˜åŒ–ç­–ç•¥)
    - [5.1 ç´¢å¼•ä¼˜åŒ–](#51-ç´¢å¼•ä¼˜åŒ–)
    - [5.2 çª—å£å‡½æ•°ä¼˜åŒ–](#52-çª—å£å‡½æ•°ä¼˜åŒ–)
    - [5.3 å®æ—¶æ£€æµ‹ä¼˜åŒ–](#53-å®æ—¶æ£€æµ‹ä¼˜åŒ–)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹](#61-ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹)
    - [6.2 æ€§èƒ½å¼‚å¸¸æ£€æµ‹](#62-æ€§èƒ½å¼‚å¸¸æ£€æµ‹)
    - [6.3 ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹](#63-ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹)
    - [6.4 å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ](#64-å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [7.1 å¼‚å¸¸æ£€æµ‹æ–¹æ³•å¯¹æ¯”](#71-å¼‚å¸¸æ£€æµ‹æ–¹æ³•å¯¹æ¯”)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#73-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 æ–¹æ³•é€‰æ‹©](#81-æ–¹æ³•é€‰æ‹©)
    - [8.2 é˜ˆå€¼è®¾ç½®](#82-é˜ˆå€¼è®¾ç½®)
    - [8.3 è¯¯æŠ¥å¤„ç†](#83-è¯¯æŠ¥å¤„ç†)
    - [8.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#84-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## å¼‚å¸¸æ£€æµ‹æ¦‚è¿°

**å¼‚å¸¸æ£€æµ‹ï¼ˆAnomaly Detectionï¼‰**è¯†åˆ«æ•°æ®ä¸­çš„å¼‚å¸¸å€¼ï¼Œç”¨äºç³»ç»Ÿç›‘æ§å’Œæ•…éšœé¢„è­¦ï¼Œæ˜¯è¿ç»´ç›‘æ§çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

### ç†è®ºåŸºç¡€

#### å¼‚å¸¸æ£€æµ‹é—®é¢˜å®šä¹‰

**å¼‚å¸¸æ£€æµ‹é—®é¢˜**ï¼šç»™å®šæ•°æ®åºåˆ—$X = \{x_1, x_2, \ldots, x_n\}$ï¼Œè¯†åˆ«å¼‚å¸¸å€¼$A = \{a_1, a_2, \ldots, a_k\}$ï¼š
$$a_i \in X \text{ and } f(a_i) > \theta$$

å…¶ä¸­$f$æ˜¯å¼‚å¸¸è¯„åˆ†å‡½æ•°ï¼Œ$\theta$æ˜¯é˜ˆå€¼ã€‚

#### å¼‚å¸¸æ£€æµ‹æ–¹æ³•åˆ†ç±»

å¼‚å¸¸æ£€æµ‹æ–¹æ³•åˆ†ç±»ï¼š

1. **ç»Ÿè®¡æ–¹æ³•**ï¼š
   - Z-scoreï¼š$z = \frac{x - \mu}{\sigma}$
   - IQRï¼š$\text{outlier} = x < Q1 - 1.5 \times IQR \text{ or } x > Q3 + 1.5 \times IQR$
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$

2. **æ—¶é—´åºåˆ—æ–¹æ³•**ï¼š
   - ç§»åŠ¨å¹³å‡ï¼šåŸºäºç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®
   - è¶‹åŠ¿åˆ†æï¼šåŸºäºè¶‹åŠ¿åç¦»
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

3. **æœºå™¨å­¦ä¹ æ–¹æ³•**ï¼š
   - èšç±»ï¼šåŸºäºè·ç¦»
   - å­¤ç«‹æ£®æ—ï¼šåŸºäºæ ‘ç»“æ„
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \log n)$

#### å¼‚å¸¸æ£€æµ‹æ–¹æ³•é€‰æ‹©

é€‰æ‹©æ£€æµ‹æ–¹æ³•çš„è€ƒè™‘å› ç´ ï¼š

1. **æ•°æ®åˆ†å¸ƒ**ï¼šæ­£æ€åˆ†å¸ƒç”¨Z-scoreï¼Œåæ€åˆ†å¸ƒç”¨IQR
2. **æ—¶é—´åºåˆ—**ï¼šæ—¶é—´åºåˆ—ç”¨ç§»åŠ¨å¹³å‡ï¼Œé™æ€æ•°æ®ç”¨ç»Ÿè®¡æ–¹æ³•
3. **ç²¾åº¦è¦æ±‚**ï¼šé«˜ç²¾åº¦ç”¨å¤æ‚æ–¹æ³•ï¼Œå¿«é€Ÿç”¨ç®€å•æ–¹æ³•

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **Z-score** | $z = \frac{x - \mu}{\sigma}$ | ç»Ÿè®¡å¼‚å¸¸ | $O(n)$ | $O(1)$ | æ­£æ€åˆ†å¸ƒ |
| **IQR** | $\text{outlier} = x < Q1 - 1.5 \times IQR \text{ or } x > Q3 + 1.5 \times IQR$ | å››åˆ†ä½è·å¼‚å¸¸ | $O(n \log n)$ | $O(n)$ | åæ€åˆ†å¸ƒ |
| **ç§»åŠ¨å¹³å‡** | åŸºäºç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·® | æ—¶é—´åºåˆ—å¼‚å¸¸ | $O(n)$ | $O(1)$ | æ—¶é—´åºåˆ— |

---

## 1. ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹

### 1.1 ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹åŸç†

**ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹ï¼ˆStatistical Anomaly Detectionï¼‰**åŸºäºç»Ÿè®¡åˆ†å¸ƒè¯†åˆ«å¼‚å¸¸å€¼ã€‚

#### å¼‚å¸¸å€¼å®šä¹‰

**å¼‚å¸¸å€¼ï¼ˆOutlierï¼‰**ï¼šä¸æ•°æ®é›†ä¸­å…¶ä»–å€¼æ˜¾è‘—ä¸åŒçš„å€¼ï¼š

- **å…¨å±€å¼‚å¸¸**ï¼šä¸æ•´ä¸ªæ•°æ®é›†ä¸åŒ
- **å±€éƒ¨å¼‚å¸¸**ï¼šä¸å±€éƒ¨æ•°æ®ä¸åŒ

#### ç»Ÿè®¡æ–¹æ³•

**ç»Ÿè®¡æ–¹æ³•**ï¼š

1. **Z-score**ï¼šåŸºäºæ ‡å‡†å·®
2. **IQR**ï¼šåŸºäºå››åˆ†ä½è·
3. **3-sigmaè§„åˆ™**ï¼šåŸºäº3å€æ ‡å‡†å·®

### 1.2 Z-scoreæ–¹æ³•å®ç°

**Z-scoreæ–¹æ³•**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºç›‘æ§æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE monitoring_data CASCADE;
        END IF;

        CREATE TABLE monitoring_data (
            timestamp TIMESTAMP NOT NULL,
            metric_name VARCHAR(50) NOT NULL,
            metric_value NUMERIC(10, 2) NOT NULL,
            PRIMARY KEY (timestamp, metric_name)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«ä¸€äº›å¼‚å¸¸å€¼ï¼‰
        INSERT INTO monitoring_data (timestamp, metric_name, metric_value) VALUES
            ('2024-01-01 10:00:00', 'cpu_usage', 45.5),
            ('2024-01-01 10:01:00', 'cpu_usage', 52.3),
            ('2024-01-01 10:02:00', 'cpu_usage', 48.7),
            ('2024-01-01 10:03:00', 'cpu_usage', 95.2),  -- å¼‚å¸¸å€¼
            ('2024-01-01 10:04:00', 'cpu_usage', 50.1),
            ('2024-01-01 10:05:00', 'cpu_usage', 5.3),   -- å¼‚å¸¸å€¼
            ('2024-01-01 10:06:00', 'cpu_usage', 49.8);

        RAISE NOTICE 'è¡¨ monitoring_data åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ monitoring_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- Z-scoreå¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡ŒZ-scoreå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—Z-scoreå¹¶è¯†åˆ«å¼‚å¸¸
WITH stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
z_scores AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        s.mean_value,
        s.std_value,
        CASE
            WHEN s.std_value = 0 THEN 0
            ELSE ABS((md.metric_value - s.mean_value) / s.std_value)
        END AS z_score
    FROM monitoring_data md
    JOIN stats s ON md.metric_name = s.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(mean_value::numeric, 2) AS mean_value,
    ROUND(std_value::numeric, 2) AS std_value,
    ROUND(z_score::numeric, 2) AS z_score,
    CASE
        WHEN z_score > 3 THEN 'Critical Anomaly'
        WHEN z_score > 2 THEN 'Warning Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM z_scores
ORDER BY z_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    AVG(metric_value) AS mean_value,
    STDDEV(metric_value) AS std_value
FROM monitoring_data
GROUP BY metric_name;
```

### 1.3 IQRæ–¹æ³•å®ç°

**IQRæ–¹æ³•**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- IQRå¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡ŒIQRå¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡ŒIQRå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'IQRå¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨IQRæ–¹æ³•æ£€æµ‹å¼‚å¸¸
WITH quartiles AS (
    SELECT
        metric_name,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY metric_value) AS median,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM monitoring_data
    GROUP BY metric_name
),
iqr_values AS (
    SELECT
        metric_name,
        q1,
        median,
        q3,
        q3 - q1 AS iqr,
        q1 - 1.5 * (q3 - q1) AS lower_bound,
        q3 + 1.5 * (q3 - q1) AS upper_bound
    FROM quartiles
)
SELECT
    md.timestamp,
    md.metric_name,
    ROUND(md.metric_value::numeric, 2) AS metric_value,
    ROUND(iq.lower_bound::numeric, 2) AS lower_bound,
    ROUND(iq.upper_bound::numeric, 2) AS upper_bound,
    CASE
        WHEN md.metric_value < iq.lower_bound OR md.metric_value > iq.upper_bound THEN 'Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM monitoring_data md
JOIN iqr_values iq ON md.metric_name = iq.metric_name
ORDER BY md.timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
FROM monitoring_data
GROUP BY metric_name;
```

---

### 1.4 3-sigmaè§„åˆ™

**3-sigmaè§„åˆ™**ï¼šä½¿ç”¨3å€æ ‡å‡†å·®è¯†åˆ«å¼‚å¸¸ã€‚

```sql
-- 3-sigmaè§„åˆ™å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œ3-sigmaè§„åˆ™å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œ3-sigmaè§„åˆ™å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '3-sigmaè§„åˆ™å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3-sigmaè§„åˆ™ï¼šä½¿ç”¨3å€æ ‡å‡†å·®
WITH stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
three_sigma AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        s.mean_value,
        s.std_value,
        s.mean_value - 3 * s.std_value AS lower_bound,
        s.mean_value + 3 * s.std_value AS upper_bound
    FROM monitoring_data md
    JOIN stats s ON md.metric_name = s.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(mean_value::numeric, 2) AS mean_value,
    ROUND(std_value::numeric, 2) AS std_value,
    ROUND(lower_bound::numeric, 2) AS lower_bound,
    ROUND(upper_bound::numeric, 2) AS upper_bound,
    CASE
        WHEN metric_value < lower_bound OR metric_value > upper_bound THEN 'Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM three_sigma
WHERE metric_value < lower_bound OR metric_value > upper_bound
ORDER BY timestamp DESC;
```

---

## 2. æ—¶é—´åºåˆ—å¼‚å¸¸

### 2.1 æ—¶é—´åºåˆ—å¼‚å¸¸åŸç†

**æ—¶é—´åºåˆ—å¼‚å¸¸æ£€æµ‹ï¼ˆTime Series Anomaly Detectionï¼‰**è¯†åˆ«æ—¶é—´åºåˆ—ä¸­çš„å¼‚å¸¸æ¨¡å¼ã€‚

#### æ—¶é—´åºåˆ—å¼‚å¸¸å®šä¹‰

**æ—¶é—´åºåˆ—å¼‚å¸¸**ï¼š

- **ç‚¹å¼‚å¸¸**ï¼šå•ä¸ªæ—¶é—´ç‚¹çš„å¼‚å¸¸å€¼
- **æ¨¡å¼å¼‚å¸¸**ï¼šå¼‚å¸¸çš„æ¨¡å¼æˆ–è¶‹åŠ¿
- **ä¸Šä¸‹æ–‡å¼‚å¸¸**ï¼šåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸‹çš„å¼‚å¸¸

#### æ£€æµ‹æ–¹æ³•

**æ£€æµ‹æ–¹æ³•**ï¼š

1. **ç§»åŠ¨å¹³å‡**ï¼šåŸºäºç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®
2. **è¶‹åŠ¿åˆ†æ**ï¼šåŸºäºè¶‹åŠ¿åç¦»
3. **å­£èŠ‚æ€§åˆ†æ**ï¼šåŸºäºå­£èŠ‚æ€§æ¨¡å¼

### 2.2 ç§»åŠ¨å¹³å‡å¼‚å¸¸å®ç°

**ç§»åŠ¨å¹³å‡å¼‚å¸¸**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- ç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç§»åŠ¨å¹³å‡å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºç§»åŠ¨å¹³å‡çš„å¼‚å¸¸æ£€æµ‹
WITH moving_stats AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg,
        STDDEV(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_std
    FROM monitoring_data
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(moving_avg::numeric, 2) AS moving_avg,
    ROUND(moving_std::numeric, 2) AS moving_std,
    CASE
        WHEN moving_std = 0 THEN 'Normal'
        WHEN ABS(metric_value - moving_avg) > 2 * moving_std THEN 'Anomaly'
        WHEN ABS(metric_value - moving_avg) > 1.5 * moving_std THEN 'Warning'
        ELSE 'Normal'
    END AS anomaly_status,
    ROUND(ABS(metric_value - moving_avg) / NULLIF(moving_std, 0)::numeric, 2) AS deviation_score
FROM moving_stats
WHERE moving_avg IS NOT NULL AND moving_std IS NOT NULL
ORDER BY deviation_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    timestamp,
    AVG(metric_value) OVER (ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS moving_avg
FROM monitoring_data
WHERE metric_name = 'cpu_usage'
ORDER BY timestamp;
```

---

### 2.3 è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹

**è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹**ï¼šè¯†åˆ«è¶‹åŠ¿ä¸­çš„å¼‚å¸¸å˜åŒ–ã€‚

```sql
-- è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè¶‹åŠ¿å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œè¶‹åŠ¿å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹ï¼šè¯†åˆ«è¶‹åŠ¿ä¸­çš„å¼‚å¸¸å˜åŒ–
WITH trend_analysis AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg,
        LAG(metric_value) OVER (PARTITION BY metric_name ORDER BY timestamp) AS prev_value,
        metric_value - LAG(metric_value) OVER (PARTITION BY metric_name ORDER BY timestamp) AS change_rate
    FROM monitoring_data
),
trend_anomalies AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        moving_avg,
        change_rate,
        AVG(change_rate) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_change_rate,
        STDDEV(change_rate) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS std_change_rate
    FROM trend_analysis
    WHERE change_rate IS NOT NULL
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(moving_avg::numeric, 2) AS moving_avg,
    ROUND(change_rate::numeric, 2) AS change_rate,
    ROUND(avg_change_rate::numeric, 2) AS avg_change_rate,
    ROUND(std_change_rate::numeric, 2) AS std_change_rate,
    CASE
        WHEN ABS(change_rate - avg_change_rate) > 3 * std_change_rate THEN 'Trend Anomaly'
        WHEN ABS(change_rate - avg_change_rate) > 2 * std_change_rate THEN 'Trend Warning'
        ELSE 'Normal'
    END AS trend_status
FROM trend_anomalies
WHERE ABS(change_rate - avg_change_rate) > 2 * std_change_rate
ORDER BY timestamp DESC;
```

---

## 3. å¼‚å¸¸è¯„åˆ†

### 3.1 å¼‚å¸¸è¯„åˆ†åŸç†

**å¼‚å¸¸è¯„åˆ†ï¼ˆAnomaly Scoringï¼‰**é‡åŒ–å¼‚å¸¸ç¨‹åº¦ï¼Œä¾¿äºæ’åºå’Œç­›é€‰ã€‚

#### å¼‚å¸¸è¯„åˆ†å®šä¹‰

**å¼‚å¸¸è¯„åˆ†**ï¼šå°†å¼‚å¸¸ç¨‹åº¦é‡åŒ–ä¸ºæ•°å€¼ï¼š
$$S(x) = f(x, \text{context})$$

å…¶ä¸­$f$æ˜¯è¯„åˆ†å‡½æ•°ï¼Œå€¼è¶Šå¤§è¡¨ç¤ºå¼‚å¸¸ç¨‹åº¦è¶Šé«˜ã€‚

#### è¯„åˆ†æ–¹æ³•

**è¯„åˆ†æ–¹æ³•**ï¼š

1. **Z-scoreè¯„åˆ†**ï¼š$S(x) = |z|$
2. **IQRè¯„åˆ†**ï¼šåŸºäºå››åˆ†ä½è·çš„è·ç¦»
3. **ç»¼åˆè¯„åˆ†**ï¼šç»“åˆå¤šç§æ–¹æ³•

### 3.2 å¼‚å¸¸è¯„åˆ†è®¡ç®—å®ç°

**å¼‚å¸¸è¯„åˆ†è®¡ç®—**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- å¼‚å¸¸è¯„åˆ†è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¼‚å¸¸è¯„åˆ†';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å¼‚å¸¸è¯„åˆ†';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸è¯„åˆ†è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆå¼‚å¸¸è¯„åˆ†ï¼ˆç»“åˆZ-scoreå’ŒIQRï¼‰
WITH z_score_stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
iqr_stats AS (
    SELECT
        metric_name,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM monitoring_data
    GROUP BY metric_name
),
anomaly_scores AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        ABS((md.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) AS z_score,
        CASE
            WHEN md.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) THEN 1
            WHEN md.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 1
            ELSE 0
        END AS iqr_anomaly,
        (ABS((md.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) +
         CASE
            WHEN md.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) THEN 1 ELSE 0
            WHEN md.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 1 ELSE 0
            ELSE 0
         END) / 2.0 AS anomaly_score
    FROM monitoring_data md
    JOIN z_score_stats zs ON md.metric_name = zs.metric_name
    JOIN iqr_stats iqs ON md.metric_name = iqs.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    iqr_anomaly,
    ROUND(anomaly_score::numeric, 2) AS anomaly_score,
    CASE
        WHEN anomaly_score > 2.0 THEN 'Critical'
        WHEN anomaly_score > 1.5 THEN 'High'
        WHEN anomaly_score > 1.0 THEN 'Medium'
        ELSE 'Low'
    END AS severity
FROM anomaly_scores
ORDER BY anomaly_score DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    metric_name,
    COUNT(*) AS record_count
FROM monitoring_data
GROUP BY metric_name;
```

---

### 3.3 ç»¼åˆå¼‚å¸¸è¯„åˆ†

**ç»¼åˆå¼‚å¸¸è¯„åˆ†**ï¼šç»“åˆå¤šç§æ–¹æ³•çš„å¼‚å¸¸è¯„åˆ†ã€‚

```sql
-- ç»¼åˆå¼‚å¸¸è¯„åˆ†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç»¼åˆå¼‚å¸¸è¯„åˆ†';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç»¼åˆå¼‚å¸¸è¯„åˆ†';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆå¼‚å¸¸è¯„åˆ†è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆå¼‚å¸¸è¯„åˆ†ï¼šç»“åˆZ-scoreã€IQRå’Œç§»åŠ¨å¹³å‡
WITH z_score_stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    GROUP BY metric_name
),
iqr_stats AS (
    SELECT
        metric_name,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM monitoring_data
    GROUP BY metric_name
),
moving_stats AS (
    SELECT
        timestamp,
        metric_name,
        metric_value,
        AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_avg,
        STDDEV(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS moving_std
    FROM monitoring_data
),
composite_scores AS (
    SELECT
        ms.timestamp,
        ms.metric_name,
        ms.metric_value,
        ABS((ms.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) AS z_score,
        CASE
            WHEN ms.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) OR
                 ms.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 1
            ELSE 0
        END AS iqr_flag,
        ABS((ms.metric_value - ms.moving_avg) / NULLIF(ms.moving_std, 0)) AS moving_z_score,
        -- ç»¼åˆè¯„åˆ†ï¼šåŠ æƒå¹³å‡
        (ABS((ms.metric_value - zs.mean_value) / NULLIF(zs.std_value, 0)) * 0.4 +
         CASE
            WHEN ms.metric_value < iqs.q1 - 1.5 * (iqs.q3 - iqs.q1) OR
                 ms.metric_value > iqs.q3 + 1.5 * (iqs.q3 - iqs.q1) THEN 3 ELSE 0
         END * 0.3 +
         ABS((ms.metric_value - ms.moving_avg) / NULLIF(ms.moving_std, 0)) * 0.3) AS composite_score
    FROM moving_stats ms
    JOIN z_score_stats zs ON ms.metric_name = zs.metric_name
    JOIN iqr_stats iqs ON ms.metric_name = iqs.metric_name
    WHERE ms.moving_avg IS NOT NULL AND ms.moving_std IS NOT NULL
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    iqr_flag,
    ROUND(moving_z_score::numeric, 2) AS moving_z_score,
    ROUND(composite_score::numeric, 2) AS composite_score,
    CASE
        WHEN composite_score > 3.0 THEN 'Critical'
        WHEN composite_score > 2.0 THEN 'High'
        WHEN composite_score > 1.0 THEN 'Medium'
        ELSE 'Low'
    END AS severity
FROM composite_scores
WHERE composite_score > 1.0
ORDER BY composite_score DESC, timestamp DESC;
```

---

## 4. PostgreSQL 18å¹¶è¡Œå¼‚å¸¸æ£€æµ‹ä¸AIå¢å¼º

### 4.1 å¹¶è¡Œå¼‚å¸¸æ£€æµ‹æ¦‚è¿°

**PostgreSQL 18å¹¶è¡Œå¼‚å¸¸æ£€æµ‹**ï¼šåˆ©ç”¨PostgreSQL 18çš„å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ›ï¼Œæ˜¾è‘—æå‡å¤§è§„æ¨¡æ•°æ®å¼‚å¸¸æ£€æµ‹çš„æ€§èƒ½ã€‚

#### å¹¶è¡Œå¼‚å¸¸æ£€æµ‹é…ç½®

```sql
-- é…ç½®å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å‚æ•°ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾ç½®å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
        SET max_parallel_workers_per_gather = 4;

        -- è®¾ç½®å¹¶è¡Œè¡¨æ‰«æé˜ˆå€¼
        SET min_parallel_table_scan_size = '8MB';

        -- è®¾ç½®å¹¶è¡Œèšåˆæˆæœ¬é˜ˆå€¼
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å‚æ•°å·²é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå¼‚å¸¸æ£€æµ‹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å®ç°

```sql
-- å¹¶è¡Œå¼‚å¸¸æ£€æµ‹ï¼šå¤§è§„æ¨¡ç›‘æ§æ•°æ®å¼‚å¸¸æ£€æµ‹ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
        SET max_parallel_workers_per_gather = 4;
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¹¶è¡ŒZ-scoreå¼‚å¸¸æ£€æµ‹
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH parallel_stats AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    WHERE timestamp >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY metric_name
),
parallel_anomalies AS (
    SELECT
        md.timestamp,
        md.metric_name,
        md.metric_value,
        ps.mean_value,
        ps.std_value,
        ABS((md.metric_value - ps.mean_value) / NULLIF(ps.std_value, 0)) AS z_score
    FROM monitoring_data md
    JOIN parallel_stats ps ON md.metric_name = ps.metric_name
    WHERE md.timestamp >= CURRENT_DATE - INTERVAL '1 day'
)
SELECT
    timestamp,
    metric_name,
    metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    CASE
        WHEN z_score > 3 THEN 'Critical Anomaly'
        WHEN z_score > 2 THEN 'Significant Anomaly'
        ELSE 'Normal'
    END AS anomaly_level
FROM parallel_anomalies
WHERE z_score > 2
ORDER BY z_score DESC;
```

### 4.2 AIå¢å¼ºå¼‚å¸¸æ£€æµ‹ï¼ˆpgvectorï¼‰

**AIå¢å¼ºå¼‚å¸¸æ£€æµ‹**ï¼šä½¿ç”¨pgvectorè¿›è¡Œå¼‚å¸¸æ¨¡å¼è¯†åˆ«ï¼Œç»“åˆå†å²å¼‚å¸¸æ¨¡å¼è¿›è¡Œæ£€æµ‹ã€‚

```sql
-- AIå¢å¼ºå¼‚å¸¸æ£€æµ‹ï¼šåŸºäºå¼‚å¸¸æ¨¡å¼å‘é‡è¯†åˆ«ï¼ˆéœ€è¦pgvectoræ‰©å±•ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'pgvectoræ‰©å±•å®‰è£…å¤±è´¥: %ã€‚è¯·ç¡®ä¿å·²å®‰è£…pgvectoræ‰©å±•ã€‚', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºå¼‚å¸¸æ¨¡å¼å‘é‡è¡¨
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'anomaly_pattern_vectors') THEN
            RAISE WARNING 'è¡¨ anomaly_pattern_vectors å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE anomaly_pattern_vectors CASCADE;
        END IF;

        -- åˆ›å»ºåŒ…å«å¼‚å¸¸æ¨¡å¼å‘é‡çš„è¡¨
        CREATE TABLE anomaly_pattern_vectors (
            id SERIAL PRIMARY KEY,
            metric_name TEXT NOT NULL,
            timestamp TIMESTAMP NOT NULL,
            -- å¼‚å¸¸æ¨¡å¼ç‰¹å¾å‘é‡ï¼ˆå¦‚ï¼šå¤šä¸ªæŒ‡æ ‡çš„ç»„åˆå‘é‡ï¼‰
            pattern_vector vector(128),
            -- å¼‚å¸¸æ ‡ç­¾
            is_anomaly BOOLEAN DEFAULT FALSE,
            anomaly_type TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- åˆ›å»ºå‘é‡ç›¸ä¼¼åº¦ç´¢å¼•ï¼ˆHNSWç´¢å¼•ï¼ŒPostgreSQL 18+ï¼‰
        CREATE INDEX idx_anomaly_pattern_vectors_vector
        ON anomaly_pattern_vectors
        USING hnsw (pattern_vector vector_cosine_ops)
        WITH (m = 16, ef_construction = 64);

        -- åˆ›å»ºæŒ‡æ ‡å’Œæ—¶é—´ç´¢å¼•
        CREATE INDEX idx_anomaly_pattern_vectors_metric_time
        ON anomaly_pattern_vectors(metric_name, timestamp DESC);

        RAISE NOTICE 'å¼‚å¸¸æ¨¡å¼å‘é‡è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¼‚å¸¸æ¨¡å¼å‘é‡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- AIå¼‚å¸¸æ£€æµ‹ï¼šåŸºäºå†å²å¼‚å¸¸æ¨¡å¼æ£€æµ‹å½“å‰å¼‚å¸¸
WITH current_patterns AS (
    SELECT
        metric_name,
        timestamp,
        pattern_vector
    FROM anomaly_pattern_vectors
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
),
historical_anomalies AS (
    SELECT
        metric_name,
        pattern_vector,
        anomaly_type
    FROM anomaly_pattern_vectors
    WHERE is_anomaly = TRUE
),
similarity_analysis AS (
    SELECT
        cp.metric_name,
        cp.timestamp,
        ha.anomaly_type,
        1 - (cp.pattern_vector <=> ha.pattern_vector) AS similarity_score
    FROM current_patterns cp
    CROSS JOIN historical_anomalies ha
    WHERE cp.metric_name = ha.metric_name
),
anomaly_detection AS (
    SELECT DISTINCT ON (metric_name, timestamp)
        metric_name,
        timestamp,
        anomaly_type,
        similarity_score
    FROM similarity_analysis
    WHERE similarity_score > 0.8  -- ç›¸ä¼¼åº¦é˜ˆå€¼
    ORDER BY metric_name, timestamp, similarity_score DESC
)
SELECT
    metric_name,
    timestamp,
    anomaly_type,
    ROUND(similarity_score::numeric, 4) AS similarity_score,
    CASE
        WHEN similarity_score > 0.9 THEN 'High Confidence Anomaly'
        WHEN similarity_score > 0.8 THEN 'Medium Confidence Anomaly'
        ELSE 'Low Confidence Anomaly'
    END AS confidence_level
FROM anomaly_detection
ORDER BY similarity_score DESC;
```

---

## 5. å¼‚å¸¸æ£€æµ‹ä¼˜åŒ–ç­–ç•¥

### 5.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¼‚å¸¸æ£€æµ‹æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- ç›‘æ§æ•°æ®è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_monitoring_data_timestamp_metric
        ON monitoring_data(timestamp, metric_name);

        CREATE INDEX IF NOT EXISTS idx_monitoring_data_metric_timestamp
        ON monitoring_data(metric_name, timestamp);

        RAISE NOTICE 'å¼‚å¸¸æ£€æµ‹ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 çª—å£å‡½æ•°ä¼˜åŒ–

**çª—å£å‡½æ•°ä¼˜åŒ–**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ã€‚

```sql
-- çª—å£å‡½æ•°ä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
CREATE MATERIALIZED VIEW IF NOT EXISTS anomaly_stats_cache AS
SELECT
    metric_name,
    AVG(metric_value) AS mean_value,
    STDDEV(metric_value) AS std_value,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
FROM monitoring_data
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY metric_name;

CREATE INDEX IF NOT EXISTS idx_anomaly_stats_cache_metric
ON anomaly_stats_cache(metric_name);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY anomaly_stats_cache;
```

### 5.3 å®æ—¶æ£€æµ‹ä¼˜åŒ–

**å®æ—¶æ£€æµ‹ä¼˜åŒ–**ï¼šä¼˜åŒ–å®æ—¶å¼‚å¸¸æ£€æµ‹æ€§èƒ½ã€‚

```sql
-- å®æ—¶æ£€æµ‹ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '256MB';
        RAISE NOTICE 'å®æ—¶æ£€æµ‹ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å®æ—¶æ£€æµ‹ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹

**ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹**å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡å¹¶è¯†åˆ«å¼‚å¸¸ã€‚

```sql
-- ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç³»ç»Ÿç›‘æ§å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å®æ—¶å¼‚å¸¸æ£€æµ‹æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH recent_data AS (
    SELECT
        timestamp,
        metric_name,
        metric_value
    FROM monitoring_data
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
),
statistics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY metric_value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY metric_value) AS q3
    FROM recent_data
    GROUP BY metric_name
),
anomalies AS (
    SELECT
        rd.timestamp,
        rd.metric_name,
        rd.metric_value,
        s.mean_value,
        s.std_value,
        ABS((rd.metric_value - s.mean_value) / NULLIF(s.std_value, 0)) AS z_score,
        CASE
            WHEN rd.metric_value < s.q1 - 1.5 * (s.q3 - s.q1) OR
                 rd.metric_value > s.q3 + 1.5 * (s.q3 - s.q1) THEN TRUE
            ELSE FALSE
        END AS is_iqr_anomaly
    FROM recent_data rd
    JOIN statistics s ON rd.metric_name = s.metric_name
)
SELECT
    timestamp,
    metric_name,
    ROUND(metric_value::numeric, 2) AS metric_value,
    ROUND(z_score::numeric, 2) AS z_score,
    is_iqr_anomaly,
    CASE
        WHEN z_score > 3 OR is_iqr_anomaly THEN 'CRITICAL'
        WHEN z_score > 2 THEN 'WARNING'
        ELSE 'NORMAL'
    END AS alert_level
FROM anomalies
WHERE z_score > 2 OR is_iqr_anomaly
ORDER BY z_score DESC, timestamp;
```

### 6.2 æ€§èƒ½å¼‚å¸¸æ£€æµ‹

**æ€§èƒ½å¼‚å¸¸æ£€æµ‹**ï¼šæ£€æµ‹æ€§èƒ½æŒ‡æ ‡çš„å¼‚å¸¸ã€‚

```sql
-- æ€§èƒ½å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'query_performance') THEN
            RAISE WARNING 'è¡¨ query_performance ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ€§èƒ½å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œæ€§èƒ½å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½å¼‚å¸¸æ£€æµ‹ï¼šæ£€æµ‹æŸ¥è¯¢æ€§èƒ½å¼‚å¸¸
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH query_stats AS (
    SELECT
        query_id,
        AVG(execution_time_ms) AS avg_time,
        STDDEV(execution_time_ms) AS std_time,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) AS p95_time
    FROM query_performance
    WHERE timestamp >= NOW() - INTERVAL '24 hours'
    GROUP BY query_id
),
recent_queries AS (
    SELECT
        timestamp,
        query_id,
        execution_time_ms
    FROM query_performance
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
),
performance_anomalies AS (
    SELECT
        rq.timestamp,
        rq.query_id,
        rq.execution_time_ms,
        qs.avg_time,
        qs.p95_time,
        ABS((rq.execution_time_ms - qs.avg_time) / NULLIF(qs.std_time, 0)) AS z_score,
        CASE
            WHEN rq.execution_time_ms > qs.p95_time * 2 THEN TRUE
            WHEN rq.execution_time_ms > qs.avg_time + 3 * qs.std_time THEN TRUE
            ELSE FALSE
        END AS is_anomaly
    FROM recent_queries rq
    JOIN query_stats qs ON rq.query_id = qs.query_id
)
SELECT
    timestamp,
    query_id,
    ROUND(execution_time_ms::numeric, 2) AS execution_time_ms,
    ROUND(avg_time::numeric, 2) AS avg_time,
    ROUND(p95_time::numeric, 2) AS p95_time,
    ROUND(z_score::numeric, 2) AS z_score,
    CASE
        WHEN execution_time_ms > p95_time * 2 THEN 'Critical Performance Degradation'
        WHEN z_score > 3 THEN 'Severe Anomaly'
        WHEN z_score > 2 THEN 'Moderate Anomaly'
        ELSE 'Normal'
    END AS anomaly_type
FROM performance_anomalies
WHERE is_anomaly
ORDER BY z_score DESC, timestamp DESC;
```

### 6.3 ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹

**ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹**ï¼šæ£€æµ‹ä¸šåŠ¡æŒ‡æ ‡çš„å¼‚å¸¸ã€‚

```sql
-- ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_metrics') THEN
            RAISE WARNING 'è¡¨ business_metrics ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE business_metrics (
                timestamp TIMESTAMP NOT NULL,
                metric_name VARCHAR(50) NOT NULL,
                metric_value NUMERIC(10, 2) NOT NULL,
                PRIMARY KEY (timestamp, metric_name)
            );

            INSERT INTO business_metrics (timestamp, metric_name, metric_value) VALUES
                ('2024-01-01 10:00:00', 'order_count', 1000),
                ('2024-01-01 11:00:00', 'order_count', 1050),
                ('2024-01-01 12:00:00', 'order_count', 500),  -- å¼‚å¸¸å€¼
                ('2024-01-01 13:00:00', 'order_count', 1100);

            RAISE NOTICE 'è¡¨ business_metrics åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹è¿›è¡Œä¸šåŠ¡å¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹ï¼šæ£€æµ‹ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH hourly_aggregates AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        metric_name,
        SUM(metric_value) AS hourly_value
    FROM business_metrics
    WHERE timestamp >= NOW() - INTERVAL '7 days'
    GROUP BY DATE_TRUNC('hour', timestamp), metric_name
),
hourly_stats AS (
    SELECT
        metric_name,
        EXTRACT(HOUR FROM hour) AS hour_of_day,
        AVG(hourly_value) AS avg_hourly_value,
        STDDEV(hourly_value) AS std_hourly_value
    FROM hourly_aggregates
    GROUP BY metric_name, EXTRACT(HOUR FROM hour)
),
recent_hourly AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        metric_name,
        SUM(metric_value) AS hourly_value
    FROM business_metrics
    WHERE timestamp >= NOW() - INTERVAL '1 day'
    GROUP BY DATE_TRUNC('hour', timestamp), metric_name
),
business_anomalies AS (
    SELECT
        rh.hour,
        rh.metric_name,
        rh.hourly_value,
        hs.avg_hourly_value,
        hs.std_hourly_value,
        ABS((rh.hourly_value - hs.avg_hourly_value) / NULLIF(hs.std_hourly_value, 0)) AS z_score
    FROM recent_hourly rh
    JOIN hourly_stats hs ON rh.metric_name = hs.metric_name
        AND EXTRACT(HOUR FROM rh.hour) = hs.hour_of_day
)
SELECT
    hour,
    metric_name,
    ROUND(hourly_value::numeric, 2) AS hourly_value,
    ROUND(avg_hourly_value::numeric, 2) AS expected_value,
    ROUND(z_score::numeric, 2) AS z_score,
    CASE
        WHEN z_score > 3 THEN 'Critical Business Anomaly'
        WHEN z_score > 2 THEN 'Significant Deviation'
        WHEN z_score > 1.5 THEN 'Moderate Deviation'
        ELSE 'Normal'
    END AS anomaly_severity
FROM business_anomalies
WHERE z_score > 1.5
ORDER BY z_score DESC, hour DESC;
```

### 6.4 å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ

**å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ**ï¼šåŸºäºå¼‚å¸¸æ£€æµ‹ç”Ÿæˆå‘Šè­¦ã€‚

```sql
-- å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    critical_threshold NUMERIC := 3.0;
    warning_threshold NUMERIC := 2.0;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆå¼‚å¸¸å‘Šè­¦';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆå¼‚å¸¸å‘Šè­¦ï¼Œä¸´ç•Œé˜ˆå€¼: %, è­¦å‘Šé˜ˆå€¼: %', critical_threshold, warning_threshold;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿï¼šç”Ÿæˆå‘Šè­¦
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH recent_metrics AS (
    SELECT
        timestamp,
        metric_name,
        metric_value
    FROM monitoring_data
    WHERE timestamp >= NOW() - INTERVAL '5 minutes'
),
statistics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_value,
        STDDEV(metric_value) AS std_value
    FROM monitoring_data
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
    GROUP BY metric_name
),
anomaly_scores AS (
    SELECT
        rm.timestamp,
        rm.metric_name,
        rm.metric_value,
        s.mean_value,
        s.std_value,
        ABS((rm.metric_value - s.mean_value) / NULLIF(s.std_value, 0)) AS z_score
    FROM recent_metrics rm
    JOIN statistics s ON rm.metric_name = s.metric_name
),
alerts AS (
    SELECT
        timestamp,
        metric_name,
        ROUND(metric_value::numeric, 2) AS metric_value,
        ROUND(mean_value::numeric, 2) AS expected_value,
        ROUND(z_score::numeric, 2) AS anomaly_score,
        CASE
            WHEN z_score > critical_threshold THEN 'CRITICAL'
            WHEN z_score > warning_threshold THEN 'WARNING'
            ELSE 'INFO'
        END AS alert_level,
        CASE
            WHEN z_score > critical_threshold THEN 'Immediate action required'
            WHEN z_score > warning_threshold THEN 'Investigation recommended'
            ELSE 'Monitor closely'
        END AS alert_message
    FROM anomaly_scores
    WHERE z_score > warning_threshold
)
SELECT
    timestamp,
    metric_name,
    metric_value,
    expected_value,
    anomaly_score,
    alert_level,
    alert_message
FROM alerts
ORDER BY
    CASE alert_level WHEN 'CRITICAL' THEN 1 WHEN 'WARNING' THEN 2 ELSE 3 END,
    anomaly_score DESC,
    timestamp DESC;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 7.1 å¼‚å¸¸æ£€æµ‹æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **Z-score** | $z = \frac{x - \mu}{\sigma}$ | $O(n)$ | $O(1)$ | æ­£æ€åˆ†å¸ƒ | ç®€å•ã€å¿«é€Ÿ | å‡è®¾æ­£æ€åˆ†å¸ƒ |
| **IQR** | $\text{outlier} = x < Q1 - 1.5 \times IQR \text{ or } x > Q3 + 1.5 \times IQR$ | $O(n \log n)$ | $O(n)$ | åæ€åˆ†å¸ƒ | ç¨³å¥ | éœ€è¦æ’åº |
| **ç§»åŠ¨å¹³å‡** | åŸºäºç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·® | $O(n)$ | $O(1)$ | æ—¶é—´åºåˆ— | è€ƒè™‘æ—¶é—´æ€§ | æ»åæ€§ |
| **ç»¼åˆè¯„åˆ†** | åŠ æƒç»„åˆå¤šç§æ–¹æ³• | $O(n \log n)$ | $O(n)$ | ç»¼åˆåœºæ™¯ | å‡†ç¡® | è®¡ç®—å¤æ‚ |

### 7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨(timestamp, metric_name)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•

2. **çª—å£å‡½æ•°ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
   - ä¼˜åŒ–çª—å£å‡½æ•°è®¡ç®—

3. **å®æ—¶æ£€æµ‹**ï¼š
   - é™åˆ¶æŸ¥è¯¢æ—¶é—´èŒƒå›´
   - ä½¿ç”¨é‡‡æ ·å‡å°‘æ•°æ®é‡

### 7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šè¯¯æŠ¥ç‡é«˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šè°ƒæ•´é˜ˆå€¼ã€ä½¿ç”¨ç§»åŠ¨å¹³å‡ã€æ·»åŠ è¿‡æ»¤æ¡ä»¶

**é—®é¢˜2**ï¼šæ¼æŠ¥ç‡é«˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šé™ä½é˜ˆå€¼ã€ä½¿ç”¨å¤šç§æ–¹æ³•ã€è€ƒè™‘ä¸Šä¸‹æ–‡

**é—®é¢˜3**ï¼šè®¡ç®—æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ã€ç´¢å¼•ä¼˜åŒ–ã€å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜4**ï¼šé˜ˆå€¼é€‰æ‹©å›°éš¾

- **è§£å†³æ–¹æ¡ˆ**ï¼šåŸºäºå†å²æ•°æ®ã€A/Bæµ‹è¯•ã€åŠ¨æ€è°ƒæ•´

---

## 8. æœ€ä½³å®è·µ

### 8.1 æ–¹æ³•é€‰æ‹©

1. **æ­£æ€åˆ†å¸ƒæ•°æ®**ï¼šä½¿ç”¨Z-score
2. **åæ€åˆ†å¸ƒæ•°æ®**ï¼šä½¿ç”¨IQR
3. **æ—¶é—´åºåˆ—æ•°æ®**ï¼šä½¿ç”¨ç§»åŠ¨å¹³å‡
4. **ç»¼åˆåœºæ™¯**ï¼šä½¿ç”¨ç»¼åˆè¯„åˆ†

### 8.2 é˜ˆå€¼è®¾ç½®

1. **Z-scoreé˜ˆå€¼**ï¼šå¸¸ç”¨2æˆ–3
2. **IQRå€æ•°**ï¼šå¸¸ç”¨1.5æˆ–3
3. **åŠ¨æ€é˜ˆå€¼**ï¼šåŸºäºå†å²æ•°æ®åŠ¨æ€è°ƒæ•´

### 8.3 è¯¯æŠ¥å¤„ç†

1. **é˜ˆå€¼è°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é˜ˆå€¼
2. **è¿‡æ»¤è§„åˆ™**ï¼šæ·»åŠ ä¸šåŠ¡è§„åˆ™è¿‡æ»¤è¯¯æŠ¥
3. **å‘Šè­¦èšåˆ**ï¼šèšåˆç›¸ä¼¼å‘Šè­¦å‡å°‘å™ªéŸ³

### 8.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **NULLå¤„ç†**ï¼šæ­£ç¡®å¤„ç†NULLå€¼
2. **é™¤é›¶å¤„ç†**ï¼šä½¿ç”¨NULLIFé¿å…é™¤é›¶
3. **ç²¾åº¦æ§åˆ¶**ï¼šæ§åˆ¶æ•°å€¼ç²¾åº¦
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•å’Œç‰©åŒ–è§†å›¾

### 8.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡å¼‚å¸¸æ£€æµ‹ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«æŒ‡æ ‡åç§°çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Nå¼‚å¸¸å€¼æŸ¥è¯¢å’Œå¤šæŒ‡æ ‡å¼‚å¸¸å¯¹æ¯”æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡å¼‚å¸¸æ£€æµ‹è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡å¼‚å¸¸æ£€æµ‹å’Œå¤šæ–¹æ³•å¼‚å¸¸å¯¹æ¯”

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - å¼‚å¸¸æ£€æµ‹æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨4èŠ‚è¯¦ç»†è¯´æ˜ï¼‰
   - é€‚ç”¨äºå¤§è§„æ¨¡ç›‘æ§æ•°æ®å¼‚å¸¸æ£€æµ‹å’Œå¤šæŒ‡æ ‡å¹¶è¡Œå¼‚å¸¸åˆ†æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–å¼‚å¸¸æ£€æµ‹æŸ¥è¯¢**

```sql
-- ä¸ºå¼‚å¸¸æ£€æµ‹åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_anomaly_detection_skip_scan
ON monitoring_data(metric_name, timestamp DESC, metric_value DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªæŒ‡æ ‡æœ€æ–°æ—¶é—´ç‚¹çš„å¼‚å¸¸å€¼
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (metric_name)
    metric_name,
    timestamp,
    metric_value,
    CASE
        WHEN ABS((metric_value - AVG(metric_value) OVER (PARTITION BY metric_name)) /
                 NULLIF(STDDEV(metric_value) OVER (PARTITION BY metric_name), 0)) > 3 THEN 'Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM monitoring_data
ORDER BY metric_name, timestamp DESC
LIMIT 50;
```

### 8.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¼‚å¸¸æ£€æµ‹ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„å¼‚å¸¸æ£€æµ‹ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜å¼‚å¸¸æ£€æµ‹ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS anomaly_detection_cache AS
WITH anomaly_statistics AS (
    SELECT
        metric_name,
        timestamp,
        metric_value,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—å¼‚å¸¸å¾—åˆ†ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        ABS((metric_value - AVG(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
        )) / NULLIF(STDDEV(metric_value) OVER (
            PARTITION BY metric_name
            ORDER BY timestamp
            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
        ), 0)) AS z_score,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—IQRå¼‚å¸¸ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN metric_value < PERCENTILE_CONT(0.25) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            ) - 1.5 * (PERCENTILE_CONT(0.75) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            ) - PERCENTILE_CONT(0.25) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            )) OR
                 metric_value > PERCENTILE_CONT(0.75) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            ) + 1.5 * (PERCENTILE_CONT(0.75) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            ) - PERCENTILE_CONT(0.25) OVER (
                PARTITION BY metric_name
                ORDER BY timestamp
                ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
            )) THEN 1
            ELSE 0
        END AS iqr_outlier
    FROM monitoring_data
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '90 days'
)
SELECT
    metric_name,
    timestamp,
    metric_value,
    ROUND(z_score::numeric, 4) AS z_score,
    iqr_outlier,
    CASE
        WHEN z_score > 3 OR iqr_outlier = 1 THEN 'Critical Anomaly'
        WHEN z_score > 2 THEN 'Warning Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM anomaly_statistics
ORDER BY metric_name, timestamp DESC;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_anomaly_detection_cache_metric_time ON anomaly_detection_cache(metric_name, timestamp DESC);
CREATE INDEX idx_anomaly_detection_cache_status ON anomaly_detection_cache(anomaly_status, z_score DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY anomaly_detection_cache;
```

**2. å®æ—¶å¼‚å¸¸æ£€æµ‹ï¼šå¢é‡å¼‚å¸¸æ›´æ–°**

**å®æ—¶å¼‚å¸¸æ£€æµ‹**ï¼šå¯¹äºå®æ—¶æ•°æ®ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•æ›´æ–°å¼‚å¸¸æ£€æµ‹ç»“æœã€‚

```sql
-- å®æ—¶å¼‚å¸¸æ£€æµ‹ï¼šå¢é‡å¼‚å¸¸æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'anomaly_detection_state') THEN
            CREATE TABLE anomaly_detection_state (
                metric_name VARCHAR(50) NOT NULL,
                detection_method VARCHAR(50) NOT NULL,  -- 'Z-score', 'IQR', 'Moving Average'
                window_size INTEGER NOT NULL,
                sum_values NUMERIC DEFAULT 0,
                sum_squared_values NUMERIC DEFAULT 0,
                count_samples BIGINT DEFAULT 0,
                mean_value NUMERIC,
                stddev_value NUMERIC,
                last_anomaly_count BIGINT DEFAULT 0,
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                PRIMARY KEY (metric_name, detection_method, window_size)
            );

            CREATE INDEX idx_anomaly_detection_state_metric ON anomaly_detection_state(metric_name, last_updated DESC);
            CREATE INDEX idx_anomaly_detection_state_updated ON anomaly_detection_state(last_updated DESC);

            RAISE NOTICE 'å¼‚å¸¸æ£€æµ‹çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡å¼‚å¸¸æ£€æµ‹æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡å¼‚å¸¸æ£€æµ‹æ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°å¼‚å¸¸æ£€æµ‹ç»Ÿè®¡ï¼šå®æ—¶å¼‚å¸¸æ£€æµ‹
WITH new_monitoring_data AS (
    SELECT
        metric_name,
        timestamp,
        metric_value
    FROM monitoring_data
    WHERE timestamp > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM anomaly_detection_state)
      AND timestamp <= CURRENT_TIMESTAMP
),
updated_anomaly_stats AS (
    SELECT
        COALESCE(ads.metric_name, nmd.metric_name) AS metric_name,
        'Z-score' AS detection_method,
        30 AS window_size,
        COALESCE(ads.sum_values, 0) + SUM(nmd.metric_value) AS new_sum_values,
        COALESCE(ads.sum_squared_values, 0) + SUM(POWER(nmd.metric_value, 2)) AS new_sum_squared_values,
        COALESCE(ads.count_samples, 0) + COUNT(*) AS new_count_samples,
        (COALESCE(ads.sum_values, 0) + SUM(nmd.metric_value)) /
        NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0) AS new_mean_value,
        SQRT(((COALESCE(ads.sum_squared_values, 0) + SUM(POWER(nmd.metric_value, 2))) /
              NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0)) -
             POWER((COALESCE(ads.sum_values, 0) + SUM(nmd.metric_value)) /
                   NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0), 2)) AS new_stddev_value,
        COUNT(*) FILTER (WHERE ABS(nmd.metric_value - (COALESCE(ads.sum_values, 0) + SUM(nmd.metric_value)) /
                                          NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0)) /
                                 NULLIF(SQRT(((COALESCE(ads.sum_squared_values, 0) + SUM(POWER(nmd.metric_value, 2))) /
                                              NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0)) -
                                             POWER((COALESCE(ads.sum_values, 0) + SUM(nmd.metric_value)) /
                                                   NULLIF(COALESCE(ads.count_samples, 0) + COUNT(*), 0), 2)), 0) > 3) AS new_anomaly_count
    FROM anomaly_detection_state ads
    FULL OUTER JOIN new_monitoring_data nmd ON ads.metric_name = nmd.metric_name
                                               AND ads.detection_method = 'Z-score'
                                               AND ads.window_size = 30
    GROUP BY ads.metric_name, nmd.metric_name, ads.sum_values, ads.sum_squared_values, ads.count_samples
)
-- æ›´æ–°æˆ–æ’å…¥å¼‚å¸¸æ£€æµ‹çŠ¶æ€
INSERT INTO anomaly_detection_state (
    metric_name,
    detection_method,
    window_size,
    sum_values,
    sum_squared_values,
    count_samples,
    mean_value,
    stddev_value,
    last_anomaly_count,
    last_updated
)
SELECT
    metric_name,
    detection_method,
    window_size,
    new_sum_values,
    new_sum_squared_values,
    new_count_samples,
    new_mean_value,
    new_stddev_value,
    new_anomaly_count,
    NOW()
FROM updated_anomaly_stats
ON CONFLICT (metric_name, detection_method, window_size)
DO UPDATE SET
    sum_values = EXCLUDED.sum_values,
    sum_squared_values = EXCLUDED.sum_squared_values,
    count_samples = EXCLUDED.count_samples,
    mean_value = EXCLUDED.mean_value,
    stddev_value = EXCLUDED.stddev_value,
    last_anomaly_count = EXCLUDED.last_anomaly_count,
    last_updated = NOW();
```

**3. æ™ºèƒ½å¼‚å¸¸æ£€æµ‹ï¼šè‡ªé€‚åº”æ£€æµ‹æ–¹æ³•é€‰æ‹©**

**æ™ºèƒ½å¼‚å¸¸æ£€æµ‹**ï¼šæ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¼‚å¸¸æ£€æµ‹æ–¹æ³•ã€‚

```sql
-- æ™ºèƒ½å¼‚å¸¸æ£€æµ‹ï¼šè‡ªé€‚åº”æ£€æµ‹æ–¹æ³•é€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    data_distribution_type VARCHAR(50);
    data_variance NUMERIC;
    recommended_method VARCHAR(50);
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'monitoring_data') THEN
            RAISE WARNING 'è¡¨ monitoring_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½å¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;

        -- è®¡ç®—æ•°æ®ç‰¹å¾
        WITH distribution_features AS (
            SELECT
                AVG(metric_value) AS mean_val,
                STDDEV(metric_value) AS stddev_val,
                PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY metric_value) AS median_val
            FROM monitoring_data
            WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'
        )
        SELECT
            CASE
                WHEN ABS(mean_val - median_val) / NULLIF(stddev_val, 0) < 0.3 THEN 'Normal'
                ELSE 'Skewed'
            END,
            stddev_val / NULLIF(mean_val, 0)
        INTO data_distribution_type, data_variance
        FROM distribution_features;

        -- æ ¹æ®æ•°æ®ç‰¹å¾è‡ªé€‚åº”é€‰æ‹©å¼‚å¸¸æ£€æµ‹æ–¹æ³•
        IF data_distribution_type = 'Normal' AND data_variance < 0.5 THEN
            recommended_method := 'Z_SCORE';  -- æ­£æ€åˆ†å¸ƒä½æ–¹å·®ï¼šZ-score
        ELSIF data_distribution_type = 'Skewed' THEN
            recommended_method := 'IQR';  -- åæ€åˆ†å¸ƒï¼šIQR
        ELSE
            recommended_method := 'MOVING_AVERAGE';  -- å…¶ä»–ï¼šç§»åŠ¨å¹³å‡
        END IF;

        RAISE NOTICE 'æ•°æ®åˆ†å¸ƒç±»å‹: %, æ•°æ®æ–¹å·®: %, æ¨èæ–¹æ³•: %',
            data_distribution_type, data_variance, recommended_method;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ™ºèƒ½å¼‚å¸¸æ£€æµ‹ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸åŒçš„æ£€æµ‹æ–¹æ³•
WITH distribution_characteristics AS (
    SELECT
        metric_name,
        AVG(metric_value) AS mean_val,
        STDDEV(metric_value) AS stddev_val,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY metric_value) AS median_val,
        STDDEV(metric_value) / NULLIF(AVG(metric_value), 0) AS coefficient_of_variation
    FROM monitoring_data
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'
    GROUP BY metric_name
),
adaptive_anomaly_detection AS (
    SELECT
        md.metric_name,
        md.timestamp,
        md.metric_value,
        dc.mean_val,
        dc.stddev_val,
        dc.median_val,
        dc.coefficient_of_variation,
        CASE
            WHEN ABS(dc.mean_val - dc.median_val) / NULLIF(dc.stddev_val, 0) < 0.3 AND dc.coefficient_of_variation < 0.5 THEN 'Z_SCORE'
            WHEN ABS(dc.mean_val - dc.median_val) / NULLIF(dc.stddev_val, 0) >= 0.3 THEN 'IQR'
            ELSE 'MOVING_AVERAGE'
        END AS recommended_method,
        -- æ ¹æ®æ¨èæ–¹æ³•è®¡ç®—å¼‚å¸¸å¾—åˆ†ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN ABS(dc.mean_val - dc.median_val) / NULLIF(dc.stddev_val, 0) < 0.3 AND dc.coefficient_of_variation < 0.5 THEN
                ABS((md.metric_value - dc.mean_val) / NULLIF(dc.stddev_val, 0))
            ELSE NULL
        END AS z_score,
        CASE
            WHEN ABS(dc.mean_val - dc.median_val) / NULLIF(dc.stddev_val, 0) >= 0.3 THEN
                CASE
                    WHEN md.metric_value < PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name) -
                         1.5 * (PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name) -
                                PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name)) OR
                         md.metric_value > PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name) +
                         1.5 * (PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name) -
                                PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY md.metric_value) OVER (PARTITION BY md.metric_name)) THEN 1
                    ELSE 0
                END
            ELSE NULL
        END AS iqr_outlier
    FROM monitoring_data md
    JOIN distribution_characteristics dc ON md.metric_name = dc.metric_name
    WHERE md.timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'
)
SELECT
    metric_name,
    timestamp,
    metric_value,
    recommended_method,
    ROUND(COALESCE(z_score, 0)::numeric, 4) AS z_score,
    iqr_outlier,
    CASE
        WHEN recommended_method = 'Z_SCORE' AND z_score > 3 THEN 'Critical Anomaly'
        WHEN recommended_method = 'Z_SCORE' AND z_score > 2 THEN 'Warning Anomaly'
        WHEN recommended_method = 'IQR' AND iqr_outlier = 1 THEN 'IQR Anomaly'
        ELSE 'Normal'
    END AS anomaly_status
FROM adaptive_anomaly_detection
WHERE (recommended_method = 'Z_SCORE' AND z_score > 2) OR
      (recommended_method = 'IQR' AND iqr_outlier = 1)
ORDER BY metric_name, timestamp DESC
LIMIT 100;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šå¼‚å¸¸æ£€æµ‹ã€‹ï¼ˆAnomaly Detectionï¼‰- å¼‚å¸¸æ£€æµ‹ç†è®º
- ã€Šæ—¶é—´åºåˆ—å¼‚å¸¸æ£€æµ‹ã€‹ï¼ˆTime Series Anomaly Detectionï¼‰- æ—¶é—´åºåˆ—æ–¹æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)
- [èšåˆå‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html)
- [ç»Ÿè®¡å‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-STATISTICS-TABLE)

### åœ¨çº¿èµ„æº

- PostgreSQLå¼‚å¸¸æ£€æµ‹æŒ‡å—
- å¼‚å¸¸æ£€æµ‹æ–¹æ³•è¯¦è§£
- å¼‚å¸¸æ£€æµ‹æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [æ€§èƒ½æŒ‡æ ‡è®¡ç®—](./æ€§èƒ½æŒ‡æ ‡è®¡ç®—.md) - æ€§èƒ½ç›‘æ§
- [å®¹é‡è§„åˆ’ç®—æ³•](./å®¹é‡è§„åˆ’ç®—æ³•.md) - å®¹é‡è§„åˆ’
- [é¢„æµ‹æ€§ç»´æŠ¤](./é¢„æµ‹æ€§ç»´æŠ¤.md) - é¢„æµ‹æ€§ç»´æŠ¤

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
