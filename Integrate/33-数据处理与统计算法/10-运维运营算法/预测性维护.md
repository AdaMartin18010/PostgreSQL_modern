# PostgreSQL é¢„æµ‹æ€§ç»´æŠ¤å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | é¢„æµ‹æ€§ç»´æŠ¤ | æ•…éšœé¢„æµ‹
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL é¢„æµ‹æ€§ç»´æŠ¤å®Œæ•´æŒ‡å—](#postgresql-é¢„æµ‹æ€§ç»´æŠ¤å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [é¢„æµ‹æ€§ç»´æŠ¤æ¦‚è¿°](#é¢„æµ‹æ€§ç»´æŠ¤æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [é¢„æµ‹æ€§ç»´æŠ¤é—®é¢˜å®šä¹‰](#é¢„æµ‹æ€§ç»´æŠ¤é—®é¢˜å®šä¹‰)
      - [é¢„æµ‹æ–¹æ³•åˆ†ç±»](#é¢„æµ‹æ–¹æ³•åˆ†ç±»)
      - [é¢„æµ‹æ–¹æ³•é€‰æ‹©](#é¢„æµ‹æ–¹æ³•é€‰æ‹©)
    - [æ ¸å¿ƒæ–¹æ³•](#æ ¸å¿ƒæ–¹æ³•)
  - [1. è®¾å¤‡å¥åº·åº¦è¯„ä¼°](#1-è®¾å¤‡å¥åº·åº¦è¯„ä¼°)
    - [1.1 è®¾å¤‡å¥åº·åº¦è¯„ä¼°åŸç†](#11-è®¾å¤‡å¥åº·åº¦è¯„ä¼°åŸç†)
      - [å¥åº·åº¦å®šä¹‰](#å¥åº·åº¦å®šä¹‰)
      - [å¥åº·åº¦è®¡ç®—æ–¹æ³•](#å¥åº·åº¦è®¡ç®—æ–¹æ³•)
    - [1.2 å¥åº·åº¦è¯„åˆ†å®ç°](#12-å¥åº·åº¦è¯„åˆ†å®ç°)
    - [1.3 å¤šæŒ‡æ ‡å¥åº·åº¦](#13-å¤šæŒ‡æ ‡å¥åº·åº¦)
  - [2. æ•…éšœé¢„æµ‹](#2-æ•…éšœé¢„æµ‹)
    - [2.1 æ•…éšœé¢„æµ‹åŸç†](#21-æ•…éšœé¢„æµ‹åŸç†)
      - [æ•…éšœé¢„æµ‹å®šä¹‰](#æ•…éšœé¢„æµ‹å®šä¹‰)
      - [é¢„æµ‹æ–¹æ³•](#é¢„æµ‹æ–¹æ³•)
    - [2.2 åŸºäºè¶‹åŠ¿çš„é¢„æµ‹å®ç°](#22-åŸºäºè¶‹åŠ¿çš„é¢„æµ‹å®ç°)
    - [2.3 åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹](#23-åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹)
      - [ä¼ ç»Ÿæœºå™¨å­¦ä¹ é¢„æµ‹](#ä¼ ç»Ÿæœºå™¨å­¦ä¹ é¢„æµ‹)
      - [AIå¢å¼ºé¢„æµ‹ï¼ˆpgvector + æ¨¡å¼è¯†åˆ«ï¼‰](#aiå¢å¼ºé¢„æµ‹pgvector--æ¨¡å¼è¯†åˆ«)
  - [3. ç»´æŠ¤å»ºè®®](#3-ç»´æŠ¤å»ºè®®)
    - [3.1 ç»´æŠ¤å»ºè®®åŸç†](#31-ç»´æŠ¤å»ºè®®åŸç†)
      - [ç»´æŠ¤å»ºè®®å®šä¹‰](#ç»´æŠ¤å»ºè®®å®šä¹‰)
      - [ä¼˜å…ˆçº§è®¡ç®—](#ä¼˜å…ˆçº§è®¡ç®—)
    - [3.2 ç»´æŠ¤ä¼˜å…ˆçº§å®ç°](#32-ç»´æŠ¤ä¼˜å…ˆçº§å®ç°)
    - [3.3 ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–](#33-ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–)
  - [4. é¢„æµ‹æ€§ç»´æŠ¤ä¼˜åŒ–ç­–ç•¥](#4-é¢„æµ‹æ€§ç»´æŠ¤ä¼˜åŒ–ç­–ç•¥)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 å¥åº·åº¦è®¡ç®—ä¼˜åŒ–](#42-å¥åº·åº¦è®¡ç®—ä¼˜åŒ–)
    - [4.3 æ‰¹é‡é¢„æµ‹ä¼˜åŒ–](#43-æ‰¹é‡é¢„æµ‹ä¼˜åŒ–)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤](#51-æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤)
    - [5.2 æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤](#52-æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤)
    - [5.3 ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤](#53-ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤)
    - [5.4 ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ](#54-ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ)
  - [6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#6-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 é¢„æµ‹æ–¹æ³•å¯¹æ¯”](#61-é¢„æµ‹æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ–¹æ³•é€‰æ‹©](#71-æ–¹æ³•é€‰æ‹©)
    - [7.2 æ•°æ®è´¨é‡](#72-æ•°æ®è´¨é‡)
    - [7.3 æ¨¡å‹æ›´æ–°](#73-æ¨¡å‹æ›´æ–°)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## é¢„æµ‹æ€§ç»´æŠ¤æ¦‚è¿°

**é¢„æµ‹æ€§ç»´æŠ¤ï¼ˆPredictive Maintenanceï¼‰**é€šè¿‡åˆ†æè®¾å¤‡è¿è¡Œæ•°æ®é¢„æµ‹æ•…éšœï¼Œæå‰å®‰æ’ç»´æŠ¤ï¼Œæ˜¯è¿ç»´ç®¡ç†çš„é«˜çº§åº”ç”¨ã€‚

### ç†è®ºåŸºç¡€

#### é¢„æµ‹æ€§ç»´æŠ¤é—®é¢˜å®šä¹‰

**é¢„æµ‹æ€§ç»´æŠ¤é—®é¢˜**ï¼šç»™å®šè®¾å¤‡ç›‘æ§æ•°æ®$M = \{m_1, m_2, \ldots, m_T\}$ï¼Œé¢„æµ‹æ•…éšœæ—¶é—´$T_f$å’Œç»´æŠ¤å»ºè®®$A$ï¼š
$$T_f = f(M), \quad A = g(M, T_f)$$

å…¶ä¸­$f$æ˜¯æ•…éšœé¢„æµ‹å‡½æ•°ï¼Œ$g$æ˜¯ç»´æŠ¤å»ºè®®å‡½æ•°ã€‚

#### é¢„æµ‹æ–¹æ³•åˆ†ç±»

é¢„æµ‹æ€§ç»´æŠ¤æ–¹æ³•åˆ†ç±»ï¼š

1. **å¥åº·åº¦è¯„ä¼°**ï¼š
   - å¤šæŒ‡æ ‡ç»¼åˆè¯„åˆ†
   - å¥åº·åº¦è¶‹åŠ¿åˆ†æ
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

2. **è¶‹åŠ¿é¢„æµ‹**ï¼š
   - åŸºäºè¶‹åŠ¿çš„æ•…éšœé¢„æµ‹
   - åŸºäºå›å½’çš„é¢„æµ‹
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

3. **å¼‚å¸¸æ£€æµ‹**ï¼š
   - åŸºäºå¼‚å¸¸çš„æ•…éšœé¢„æµ‹
   - åŸºäºæ¨¡å¼çš„é¢„æµ‹
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

#### é¢„æµ‹æ–¹æ³•é€‰æ‹©

é€‰æ‹©é¢„æµ‹æ–¹æ³•çš„è€ƒè™‘å› ç´ ï¼š

1. **æ•°æ®ç±»å‹**ï¼šè¿ç»­æ•°æ®ç”¨è¶‹åŠ¿é¢„æµ‹ï¼Œç¦»æ•£æ•°æ®ç”¨åˆ†ç±»
2. **å†å²æ•°æ®**ï¼šæ•°æ®å……è¶³ç”¨å¤æ‚æ¨¡å‹ï¼Œæ•°æ®ä¸è¶³ç”¨ç®€å•æ¨¡å‹
3. **ç²¾åº¦è¦æ±‚**ï¼šé«˜ç²¾åº¦ç”¨æœºå™¨å­¦ä¹ ï¼Œå¿«é€Ÿç”¨ç»Ÿè®¡æ–¹æ³•

### æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **å¥åº·åº¦è¯„åˆ†** | $H = \sum_{i=1}^{n} w_i \cdot S_i$ | è®¾å¤‡çŠ¶æ€è¯„ä¼° | $O(n)$ | $O(1)$ | å¤šæŒ‡æ ‡è¯„ä¼° |
| **è¶‹åŠ¿åˆ†æ** | $T_f = f(\text{trend}(M))$ | æ•…éšœé¢„æµ‹ | $O(n)$ | $O(1)$ | è¶‹åŠ¿é¢„æµ‹ |
| **å¼‚å¸¸æ£€æµ‹** | $T_f = f(\text{anomaly}(M))$ | å¼‚å¸¸è¯†åˆ« | $O(n)$ | $O(1)$ | å¼‚å¸¸é¢„æµ‹ |

---

## 1. è®¾å¤‡å¥åº·åº¦è¯„ä¼°

### 1.1 è®¾å¤‡å¥åº·åº¦è¯„ä¼°åŸç†

**è®¾å¤‡å¥åº·åº¦è¯„ä¼°ï¼ˆEquipment Health Assessmentï¼‰**ç»¼åˆå¤šä¸ªæŒ‡æ ‡è¯„ä¼°è®¾å¤‡å¥åº·çŠ¶æ€ã€‚

#### å¥åº·åº¦å®šä¹‰

**å¥åº·åº¦ï¼ˆHealth Scoreï¼‰**ï¼šè®¾å¤‡å¥åº·çŠ¶æ€çš„é‡åŒ–æŒ‡æ ‡ï¼š
$$H = \sum_{i=1}^{n} w_i \cdot S_i$$

å…¶ä¸­$w_i$æ˜¯æŒ‡æ ‡$i$çš„æƒé‡ï¼Œ$S_i$æ˜¯æŒ‡æ ‡$i$çš„å¥åº·åº¦è¯„åˆ†ã€‚

#### å¥åº·åº¦è®¡ç®—æ–¹æ³•

**å¥åº·åº¦è®¡ç®—æ–¹æ³•**ï¼š

1. **å•æŒ‡æ ‡è¯„åˆ†**ï¼šå°†æŒ‡æ ‡å€¼æ˜ å°„åˆ°0-100åˆ†
2. **å¤šæŒ‡æ ‡ç»¼åˆ**ï¼šåŠ æƒå¹³å‡å¤šä¸ªæŒ‡æ ‡è¯„åˆ†
3. **è¶‹åŠ¿åˆ†æ**ï¼šè€ƒè™‘å¥åº·åº¦å˜åŒ–è¶‹åŠ¿

### 1.2 å¥åº·åº¦è¯„åˆ†å®ç°

**å¥åº·åº¦è¯„åˆ†**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºè®¾å¤‡ç›‘æ§æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE equipment_metrics CASCADE;
        END IF;

        CREATE TABLE equipment_metrics (
            timestamp TIMESTAMP NOT NULL,
            equipment_id VARCHAR(50) NOT NULL,
            temperature NUMERIC(5, 2),
            vibration NUMERIC(5, 2),
            pressure NUMERIC(5, 2),
            power_consumption NUMERIC(5, 2),
            PRIMARY KEY (timestamp, equipment_id)
        );

        INSERT INTO equipment_metrics (timestamp, equipment_id, temperature, vibration, pressure, power_consumption) VALUES
            ('2024-01-01 10:00:00', 'EQ001', 45.5, 2.3, 100.5, 1200.0),
            ('2024-01-01 10:01:00', 'EQ001', 46.2, 2.5, 101.2, 1210.0),
            ('2024-01-01 10:02:00', 'EQ001', 47.8, 2.8, 102.5, 1230.0),
            ('2024-01-01 10:00:00', 'EQ002', 42.0, 1.8, 95.0, 1100.0),
            ('2024-01-01 10:01:00', 'EQ002', 42.5, 1.9, 95.5, 1110.0);

        RAISE NOTICE 'è¡¨ equipment_metrics åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ equipment_metrics å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—è®¾å¤‡å¥åº·åº¦è¯„åˆ†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¥åº·åº¦è¯„åˆ†';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—è®¾å¤‡å¥åº·åº¦è¯„åˆ†';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¥åº·åº¦è¯„åˆ†è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å¥åº·åº¦è¯„åˆ†ï¼ˆåŸºäºå¤šæŒ‡æ ‡ï¼‰
WITH normal_ranges AS (
    SELECT
        'temperature' AS metric, 50.0 AS max_normal, 40.0 AS min_normal
    UNION ALL SELECT 'vibration', 3.0, 1.0
    UNION ALL SELECT 'pressure', 110.0, 90.0
    UNION ALL SELECT 'power_consumption', 1300.0, 1000.0
),
latest_metrics AS (
    SELECT DISTINCT ON (equipment_id)
        equipment_id,
        temperature,
        vibration,
        pressure,
        power_consumption,
        timestamp
    FROM equipment_metrics
    ORDER BY equipment_id, timestamp DESC
),
health_scores AS (
    SELECT
        lm.equipment_id,
        lm.timestamp,
        -- æ¸©åº¦å¥åº·åº¦ (0-100)
        CASE
            WHEN lm.temperature > nr_temp.max_normal THEN 0
            WHEN lm.temperature < nr_temp.min_normal THEN 50
            ELSE 100 - ((lm.temperature - nr_temp.min_normal) / (nr_temp.max_normal - nr_temp.min_normal) * 50)
        END AS temp_score,
        -- æŒ¯åŠ¨å¥åº·åº¦
        CASE
            WHEN lm.vibration > nr_vib.max_normal THEN 0
            WHEN lm.vibration < nr_vib.min_normal THEN 50
            ELSE 100 - ((lm.vibration - nr_vib.min_normal) / (nr_vib.max_normal - nr_vib.min_normal) * 50)
        END AS vib_score,
        -- å‹åŠ›å¥åº·åº¦
        CASE
            WHEN lm.pressure > nr_press.max_normal THEN 0
            WHEN lm.pressure < nr_press.min_normal THEN 50
            ELSE 100 - ((lm.pressure - nr_press.min_normal) / (nr_press.max_normal - nr_press.min_normal) * 50)
        END AS press_score,
        -- åŠŸè€—å¥åº·åº¦
        CASE
            WHEN lm.power_consumption > nr_power.max_normal THEN 0
            WHEN lm.power_consumption < nr_power.min_normal THEN 50
            ELSE 100 - ((lm.power_consumption - nr_power.min_normal) / (nr_power.max_normal - nr_power.min_normal) * 50)
        END AS power_score
    FROM latest_metrics lm
    CROSS JOIN (SELECT * FROM normal_ranges WHERE metric = 'temperature') nr_temp
    CROSS JOIN (SELECT * FROM normal_ranges WHERE metric = 'vibration') nr_vib
    CROSS JOIN (SELECT * FROM normal_ranges WHERE metric = 'pressure') nr_press
    CROSS JOIN (SELECT * FROM normal_ranges WHERE metric = 'power_consumption') nr_power
)
SELECT
    equipment_id,
    timestamp,
    ROUND(temp_score::numeric, 2) AS temp_score,
    ROUND(vib_score::numeric, 2) AS vib_score,
    ROUND(press_score::numeric, 2) AS press_score,
    ROUND(power_score::numeric, 2) AS power_score,
    ROUND((temp_score + vib_score + press_score + power_score) / 4::numeric, 2) AS overall_health_score,
    CASE
        WHEN (temp_score + vib_score + press_score + power_score) / 4 >= 80 THEN 'Healthy'
        WHEN (temp_score + vib_score + press_score + power_score) / 4 >= 60 THEN 'Warning'
        ELSE 'Critical'
    END AS health_status
FROM health_scores
ORDER BY overall_health_score ASC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (equipment_id)
    equipment_id,
    temperature,
    vibration
FROM equipment_metrics
ORDER BY equipment_id, timestamp DESC;
```

---

### 1.3 å¤šæŒ‡æ ‡å¥åº·åº¦

**å¤šæŒ‡æ ‡å¥åº·åº¦**ï¼šç»¼åˆå¤šä¸ªæŒ‡æ ‡çš„å¥åº·åº¦è¯„ä¼°ã€‚

```sql
-- å¤šæŒ‡æ ‡å¥åº·åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¤šæŒ‡æ ‡å¥åº·åº¦';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å¤šæŒ‡æ ‡å¥åº·åº¦';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šæŒ‡æ ‡å¥åº·åº¦è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šæŒ‡æ ‡å¥åº·åº¦ï¼šç»¼åˆæ¸©åº¦ã€æŒ¯åŠ¨ã€å‹åŠ›ã€åŠŸè€—
WITH latest_metrics AS (
    SELECT DISTINCT ON (equipment_id)
        equipment_id,
        timestamp,
        temperature,
        vibration,
        pressure,
        power_consumption
    FROM equipment_metrics
    ORDER BY equipment_id, timestamp DESC
),
health_scores AS (
    SELECT
        equipment_id,
        timestamp,
        -- æ¸©åº¦å¥åº·åº¦ï¼ˆ0-100ï¼‰
        CASE
            WHEN temperature > 50 THEN 0
            WHEN temperature < 40 THEN 50
            ELSE 100 - ((temperature - 40) / 10 * 50)
        END AS temp_score,
        -- æŒ¯åŠ¨å¥åº·åº¦
        CASE
            WHEN vibration > 3 THEN 0
            WHEN vibration < 1 THEN 50
            ELSE 100 - ((vibration - 1) / 2 * 50)
        END AS vib_score,
        -- å‹åŠ›å¥åº·åº¦
        CASE
            WHEN pressure > 110 THEN 0
            WHEN pressure < 90 THEN 50
            ELSE 100 - ((pressure - 90) / 20 * 50)
        END AS press_score,
        -- åŠŸè€—å¥åº·åº¦
        CASE
            WHEN power_consumption > 1300 THEN 0
            WHEN power_consumption < 1000 THEN 50
            ELSE 100 - ((power_consumption - 1000) / 300 * 50)
        END AS power_score
    FROM latest_metrics
),
weighted_health AS (
    SELECT
        equipment_id,
        timestamp,
        temp_score,
        vib_score,
        press_score,
        power_score,
        -- åŠ æƒå¥åº·åº¦ï¼ˆæ¸©åº¦30%ï¼ŒæŒ¯åŠ¨30%ï¼Œå‹åŠ›20%ï¼ŒåŠŸè€—20%ï¼‰
        temp_score * 0.3 + vib_score * 0.3 + press_score * 0.2 + power_score * 0.2 AS overall_health_score
    FROM health_scores
)
SELECT
    equipment_id,
    timestamp,
    ROUND(temp_score::numeric, 2) AS temp_score,
    ROUND(vib_score::numeric, 2) AS vib_score,
    ROUND(press_score::numeric, 2) AS press_score,
    ROUND(power_score::numeric, 2) AS power_score,
    ROUND(overall_health_score::numeric, 2) AS overall_health_score,
    CASE
        WHEN overall_health_score >= 80 THEN 'Healthy'
        WHEN overall_health_score >= 60 THEN 'Warning'
        WHEN overall_health_score >= 40 THEN 'Degraded'
        ELSE 'Critical'
    END AS health_status
FROM weighted_health
ORDER BY overall_health_score ASC;
```

---

## 2. æ•…éšœé¢„æµ‹

### 2.1 æ•…éšœé¢„æµ‹åŸç†

**æ•…éšœé¢„æµ‹ï¼ˆFailure Predictionï¼‰**åˆ†æè®¾å¤‡æ•°æ®é¢„æµ‹æ½œåœ¨æ•…éšœã€‚

#### æ•…éšœé¢„æµ‹å®šä¹‰

**æ•…éšœé¢„æµ‹**ï¼šé¢„æµ‹è®¾å¤‡åœ¨æœªæ¥$T$æ—¶é—´å†…å‘ç”Ÿæ•…éšœçš„æ¦‚ç‡ï¼š
$$P(\text{failure} | M, T) = f(M, T)$$

å…¶ä¸­$f$æ˜¯é¢„æµ‹å‡½æ•°ã€‚

#### é¢„æµ‹æ–¹æ³•

**é¢„æµ‹æ–¹æ³•**ï¼š

1. **è¶‹åŠ¿é¢„æµ‹**ï¼šåŸºäºæŒ‡æ ‡è¶‹åŠ¿é¢„æµ‹æ•…éšœ
2. **å›å½’é¢„æµ‹**ï¼šä½¿ç”¨å›å½’æ¨¡å‹é¢„æµ‹æ•…éšœæ—¶é—´
3. **å¼‚å¸¸é¢„æµ‹**ï¼šåŸºäºå¼‚å¸¸æ£€æµ‹é¢„æµ‹æ•…éšœ

### 2.2 åŸºäºè¶‹åŠ¿çš„é¢„æµ‹å®ç°

**åŸºäºè¶‹åŠ¿çš„é¢„æµ‹**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æ•…éšœé¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ•…éšœé¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œæ•…éšœé¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•…éšœé¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºè¶‹åŠ¿çš„æ•…éšœé¢„æµ‹
WITH trend_analysis AS (
    SELECT
        equipment_id,
        timestamp,
        temperature,
        vibration,
        pressure,
        power_consumption,
        AVG(temperature) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS temp_trend,
        AVG(vibration) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS vib_trend,
        LAG(temperature) OVER (PARTITION BY equipment_id ORDER BY timestamp) AS prev_temp,
        LAG(vibration) OVER (PARTITION BY equipment_id ORDER BY timestamp) AS prev_vib
    FROM equipment_metrics
),
failure_risk AS (
    SELECT
        equipment_id,
        timestamp,
        temperature,
        vibration,
        temp_trend,
        vib_trend,
        CASE
            WHEN temperature > temp_trend * 1.1 AND vibration > vib_trend * 1.15 THEN 'High Risk'
            WHEN temperature > temp_trend * 1.05 OR vibration > vib_trend * 1.1 THEN 'Medium Risk'
            ELSE 'Low Risk'
        END AS failure_risk_level,
        CASE
            WHEN temperature > temp_trend * 1.1 AND vibration > vib_trend * 1.15 THEN 0.8
            WHEN temperature > temp_trend * 1.05 OR vibration > vib_trend * 1.1 THEN 0.5
            ELSE 0.2
        END AS failure_probability
    FROM trend_analysis
    WHERE temp_trend IS NOT NULL AND vib_trend IS NOT NULL
)
SELECT
    equipment_id,
    timestamp,
    ROUND(temperature::numeric, 2) AS temperature,
    ROUND(vibration::numeric, 2) AS vibration,
    ROUND(temp_trend::numeric, 2) AS temp_trend,
    ROUND(vib_trend::numeric, 2) AS vib_trend,
    failure_risk_level,
    ROUND((failure_probability * 100)::numeric, 2) AS failure_probability_pct
FROM failure_risk
WHERE failure_risk_level != 'Low Risk'
ORDER BY failure_probability DESC, timestamp;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    equipment_id,
    AVG(temperature) OVER (PARTITION BY equipment_id ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS temp_trend
FROM equipment_metrics
ORDER BY equipment_id, timestamp;
```

---

### 2.3 åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹

**åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹**ï¼šä½¿ç”¨ç‰¹å¾å·¥ç¨‹å’ŒAIæ¨¡å‹è¿›è¡Œæ•…éšœé¢„æµ‹ã€‚

#### ä¼ ç»Ÿæœºå™¨å­¦ä¹ é¢„æµ‹

**ä¼ ç»Ÿæœºå™¨å­¦ä¹ æ–¹æ³•**ï¼šä½¿ç”¨çº¿æ€§å›å½’ã€æ—¶é—´åºåˆ—æ¨¡å‹ç­‰è¿›è¡Œé¢„æµ‹ã€‚

#### AIå¢å¼ºé¢„æµ‹ï¼ˆpgvector + æ¨¡å¼è¯†åˆ«ï¼‰

**AIå¢å¼ºé¢„æµ‹**ï¼šä½¿ç”¨pgvectorè¿›è¡Œè®¾å¤‡çŠ¶æ€æ¨¡å¼è¯†åˆ«ï¼Œç»“åˆå†å²æ•…éšœæ¨¡å¼è¿›è¡Œé¢„æµ‹ã€‚

```sql
-- AIå¢å¼ºé¢„æµ‹ï¼šåŸºäºè®¾å¤‡çŠ¶æ€å‘é‡æ¨¡å¼è¯†åˆ«ï¼ˆéœ€è¦pgvectoræ‰©å±•ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'pgvectoræ‰©å±•å®‰è£…å¤±è´¥: %ã€‚è¯·ç¡®ä¿å·²å®‰è£…pgvectoræ‰©å±•ã€‚', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºè®¾å¤‡çŠ¶æ€å‘é‡è¡¨
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_state_vectors') THEN
            RAISE WARNING 'è¡¨ equipment_state_vectors å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE equipment_state_vectors CASCADE;
        END IF;

        -- åˆ›å»ºåŒ…å«è®¾å¤‡çŠ¶æ€å‘é‡çš„è¡¨
        CREATE TABLE equipment_state_vectors (
            id SERIAL PRIMARY KEY,
            equipment_id INTEGER NOT NULL,
            timestamp TIMESTAMP NOT NULL,
            -- è®¾å¤‡çŠ¶æ€ç‰¹å¾å‘é‡ï¼ˆå¦‚ï¼šæ¸©åº¦ã€æŒ¯åŠ¨ã€å‹åŠ›ç­‰æŒ‡æ ‡çš„å‘é‡åŒ–ï¼‰
            state_vector vector(128),
            -- æ•…éšœæ ‡ç­¾ï¼ˆå¦‚æœæœ‰å†å²æ•…éšœæ•°æ®ï¼‰
            fault_type TEXT,
            fault_occurred BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- åˆ›å»ºå‘é‡ç›¸ä¼¼åº¦ç´¢å¼•ï¼ˆHNSWç´¢å¼•ï¼ŒPostgreSQL 18+ï¼‰
        CREATE INDEX idx_equipment_state_vectors_vector
        ON equipment_state_vectors
        USING hnsw (state_vector vector_cosine_ops)
        WITH (m = 16, ef_construction = 64);

        -- åˆ›å»ºè®¾å¤‡å’Œæ—¶é—´ç´¢å¼•
        CREATE INDEX idx_equipment_state_vectors_equipment_time
        ON equipment_state_vectors(equipment_id, timestamp DESC);

        RAISE NOTICE 'è®¾å¤‡çŠ¶æ€å‘é‡è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè®¾å¤‡çŠ¶æ€å‘é‡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- AIé¢„æµ‹ï¼šåŸºäºå†å²æ•…éšœæ¨¡å¼é¢„æµ‹å½“å‰è®¾å¤‡æ•…éšœé£é™©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_state_vectors') THEN
            RAISE WARNING 'è¡¨ equipment_state_vectors ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒAIé¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒAIå¢å¼ºé¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'AIé¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH current_states AS (
    SELECT
        equipment_id,
        state_vector,
        timestamp
    FROM equipment_state_vectors
    WHERE timestamp >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
),
historical_faults AS (
    SELECT
        equipment_id,
        state_vector,
        fault_type,
        timestamp
    FROM equipment_state_vectors
    WHERE fault_occurred = TRUE
),
similarity_analysis AS (
    SELECT
        cs.equipment_id,
        cs.timestamp AS current_time,
        hf.fault_type,
        hf.timestamp AS fault_time,
        -- è®¡ç®—ä¸å†å²æ•…éšœçŠ¶æ€çš„ç›¸ä¼¼åº¦
        1 - (cs.state_vector <=> hf.state_vector) AS similarity_score,
        -- è®¡ç®—æ—¶é—´è·ç¦»ï¼ˆè¶Šè¿‘çš„æ•…éšœè¶Šç›¸å…³ï¼‰
        EXTRACT(EPOCH FROM (cs.timestamp - hf.timestamp)) / 86400 AS days_apart
    FROM current_states cs
    CROSS JOIN historical_faults hf
    WHERE cs.equipment_id = hf.equipment_id
),
risk_assessment AS (
    SELECT
        equipment_id,
        current_time,
        fault_type,
        similarity_score,
        days_apart,
        -- é£é™©åˆ†æ•°ï¼šç›¸ä¼¼åº¦ * æ—¶é—´è¡°å‡å› å­
        similarity_score * EXP(-days_apart / 30) AS risk_score
    FROM similarity_analysis
    WHERE similarity_score > 0.7  -- ç›¸ä¼¼åº¦é˜ˆå€¼
)
SELECT
    equipment_id,
    current_time,
    fault_type,
    ROUND(similarity_score::numeric, 4) AS similarity,
    ROUND(risk_score::numeric, 4) AS risk_score,
    CASE
        WHEN risk_score > 0.8 THEN 'High Risk'
        WHEN risk_score > 0.6 THEN 'Medium Risk'
        ELSE 'Low Risk'
    END AS risk_level
FROM risk_assessment
ORDER BY risk_score DESC;
```

```sql
-- åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'åŸºäºæœºå™¨å­¦ä¹ çš„é¢„æµ‹éœ€è¦å¤–éƒ¨å·¥å…·æˆ–è‡ªå®šä¹‰å‡½æ•°';
        -- å®é™…å®ç°éœ€è¦ç‰¹å¾å·¥ç¨‹å’Œæœºå™¨å­¦ä¹ æ¨¡å‹
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœºå™¨å­¦ä¹ é¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç‰¹å¾å·¥ç¨‹ï¼šæå–é¢„æµ‹ç‰¹å¾
WITH feature_engineering AS (
    SELECT
        equipment_id,
        timestamp,
        temperature,
        vibration,
        pressure,
        power_consumption,
        -- ç‰¹å¾1ï¼šæ¸©åº¦è¶‹åŠ¿
        AVG(temperature) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS temp_trend,
        -- ç‰¹å¾2ï¼šæŒ¯åŠ¨å˜åŒ–ç‡
        ABS(vibration - LAG(vibration) OVER (PARTITION BY equipment_id ORDER BY timestamp)) AS vib_change_rate,
        -- ç‰¹å¾3ï¼šå‹åŠ›ç¨³å®šæ€§
        STDDEV(pressure) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS pressure_stability
    FROM equipment_metrics
)
SELECT
    equipment_id,
    timestamp,
    ROUND(temp_trend::numeric, 2) AS temp_trend,
    ROUND(vib_change_rate::numeric, 2) AS vib_change_rate,
    ROUND(pressure_stability::numeric, 2) AS pressure_stability,
    -- ç®€åŒ–çš„æ•…éšœæ¦‚ç‡ï¼ˆåŸºäºç‰¹å¾ï¼‰
    CASE
        WHEN temp_trend > 50 AND vib_change_rate > 1.0 THEN 0.8
        WHEN temp_trend > 45 OR vib_change_rate > 0.5 THEN 0.5
        ELSE 0.2
    END AS failure_probability
FROM feature_engineering
WHERE temp_trend IS NOT NULL
ORDER BY equipment_id, timestamp;
```

---

## 3. ç»´æŠ¤å»ºè®®

### 3.1 ç»´æŠ¤å»ºè®®åŸç†

**ç»´æŠ¤å»ºè®®ï¼ˆMaintenance Recommendationsï¼‰**æ ¹æ®è®¾å¤‡çŠ¶æ€å’Œé£é™©ç¡®å®šç»´æŠ¤é¡ºåºã€‚

#### ç»´æŠ¤å»ºè®®å®šä¹‰

**ç»´æŠ¤å»ºè®®**ï¼šåŸºäºå¥åº·åº¦å’Œæ•…éšœé¢„æµ‹ç”Ÿæˆç»´æŠ¤å»ºè®®ï¼š
$$A = g(H, P_f, C)$$

å…¶ä¸­$H$æ˜¯å¥åº·åº¦ï¼Œ$P_f$æ˜¯æ•…éšœæ¦‚ç‡ï¼Œ$C$æ˜¯ç»´æŠ¤æˆæœ¬ã€‚

#### ä¼˜å…ˆçº§è®¡ç®—

**ä¼˜å…ˆçº§è®¡ç®—**ï¼š
$$\text{Priority} = w_1 \cdot (1 - H) + w_2 \cdot P_f + w_3 \cdot C$$

### 3.2 ç»´æŠ¤ä¼˜å…ˆçº§å®ç°

**ç»´æŠ¤ä¼˜å…ˆçº§**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- ç»´æŠ¤ä¼˜å…ˆçº§è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç»´æŠ¤ä¼˜å…ˆçº§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç»´æŠ¤ä¼˜å…ˆçº§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»´æŠ¤ä¼˜å…ˆçº§è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç»´æŠ¤ä¼˜å…ˆçº§
WITH equipment_status AS (
    SELECT DISTINCT ON (equipment_id)
        equipment_id,
        timestamp,
        temperature,
        vibration,
        pressure,
        power_consumption
    FROM equipment_metrics
    ORDER BY equipment_id, timestamp DESC
),
health_scores AS (
    SELECT
        equipment_id,
        timestamp,
        CASE
            WHEN temperature > 50 THEN 0
            WHEN temperature < 40 THEN 50
            ELSE 100 - ((temperature - 40) / 10 * 50)
        END AS temp_score,
        CASE
            WHEN vibration > 3 THEN 0
            WHEN vibration < 1 THEN 50
            ELSE 100 - ((vibration - 1) / 2 * 50)
        END AS vib_score
    FROM equipment_status
),
maintenance_priority AS (
    SELECT
        es.equipment_id,
        es.timestamp AS last_check,
        ROUND((hs.temp_score + hs.vib_score) / 2::numeric, 2) AS health_score,
        CASE
            WHEN (hs.temp_score + hs.vib_score) / 2 < 50 THEN 'Immediate'
            WHEN (hs.temp_score + hs.vib_score) / 2 < 70 THEN 'High'
            WHEN (hs.temp_score + hs.vib_score) / 2 < 85 THEN 'Medium'
            ELSE 'Low'
        END AS priority,
        CASE
            WHEN (hs.temp_score + hs.vib_score) / 2 < 50 THEN 1
            WHEN (hs.temp_score + hs.vib_score) / 2 < 70 THEN 2
            WHEN (hs.temp_score + hs.vib_score) / 2 < 85 THEN 3
            ELSE 4
        END AS priority_order
    FROM equipment_status es
    JOIN health_scores hs ON es.equipment_id = hs.equipment_id
)
SELECT
    equipment_id,
    last_check,
    health_score,
    priority,
    CASE priority
        WHEN 'Immediate' THEN 'Schedule maintenance within 24 hours'
        WHEN 'High' THEN 'Schedule maintenance within 1 week'
        WHEN 'Medium' THEN 'Schedule maintenance within 1 month'
        ELSE 'Routine check recommended'
    END AS maintenance_recommendation
FROM maintenance_priority
ORDER BY priority_order, health_score ASC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (equipment_id)
    equipment_id,
    timestamp
FROM equipment_metrics
ORDER BY equipment_id, timestamp DESC;
```

---

### 3.3 ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–

**ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–**ï¼šä¼˜åŒ–ç»´æŠ¤è®¡åˆ’å’Œæ—¶é—´å®‰æ’ã€‚

```sql
-- ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•ä¼˜åŒ–ç»´æŠ¤è®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ä¼˜åŒ–ç»´æŠ¤è®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–ï¼šè€ƒè™‘ç»´æŠ¤çª—å£å’Œèµ„æºçº¦æŸ
WITH equipment_priority AS (
    SELECT
        equipment_id,
        timestamp,
        temperature,
        vibration,
        CASE
            WHEN temperature > 50 OR vibration > 3 THEN 1  -- Immediate
            WHEN temperature > 45 OR vibration > 2.5 THEN 2  -- High
            WHEN temperature > 40 OR vibration > 2 THEN 3    -- Medium
            ELSE 4  -- Low
        END AS priority_order,
        CASE
            WHEN temperature > 50 OR vibration > 3 THEN 'Immediate'
            WHEN temperature > 45 OR vibration > 2.5 THEN 'High'
            WHEN temperature > 40 OR vibration > 2 THEN 'Medium'
            ELSE 'Low'
        END AS priority_level
    FROM equipment_metrics
    WHERE timestamp >= NOW() - INTERVAL '1 day'
),
maintenance_schedule AS (
    SELECT DISTINCT ON (equipment_id)
        equipment_id,
        priority_order,
        priority_level,
        CASE priority_order
            WHEN 1 THEN NOW() + INTERVAL '24 hours'
            WHEN 2 THEN NOW() + INTERVAL '7 days'
            WHEN 3 THEN NOW() + INTERVAL '30 days'
            ELSE NOW() + INTERVAL '90 days'
        END AS recommended_date,
        CASE priority_order
            WHEN 1 THEN 'Schedule immediately'
            WHEN 2 THEN 'Schedule within 1 week'
            WHEN 3 THEN 'Schedule within 1 month'
            ELSE 'Routine check recommended'
        END AS maintenance_recommendation
    FROM equipment_priority
    ORDER BY equipment_id, priority_order ASC, timestamp DESC
)
SELECT
    equipment_id,
    priority_level,
    recommended_date,
    maintenance_recommendation
FROM maintenance_schedule
WHERE priority_order <= 3
ORDER BY priority_order, equipment_id;
```

---

## 4. é¢„æµ‹æ€§ç»´æŠ¤ä¼˜åŒ–ç­–ç•¥

### 4.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºé¢„æµ‹æ€§ç»´æŠ¤æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾å¤‡æŒ‡æ ‡è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_equipment_metrics_timestamp_equipment
        ON equipment_metrics(timestamp, equipment_id);

        CREATE INDEX IF NOT EXISTS idx_equipment_metrics_equipment_timestamp
        ON equipment_metrics(equipment_id, timestamp);

        RAISE NOTICE 'é¢„æµ‹æ€§ç»´æŠ¤ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 å¥åº·åº¦è®¡ç®—ä¼˜åŒ–

**å¥åº·åº¦è®¡ç®—ä¼˜åŒ–**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¥åº·åº¦ã€‚

```sql
-- å¥åº·åº¦è®¡ç®—ä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¥åº·åº¦
CREATE MATERIALIZED VIEW IF NOT EXISTS equipment_health_cache AS
SELECT DISTINCT ON (equipment_id)
    equipment_id,
    timestamp,
    temperature,
    vibration,
    pressure,
    power_consumption,
    CASE
        WHEN temperature > 50 THEN 0
        WHEN temperature < 40 THEN 50
        ELSE 100 - ((temperature - 40) / 10 * 50)
    END AS temp_score,
    CASE
        WHEN vibration > 3 THEN 0
        WHEN vibration < 1 THEN 50
        ELSE 100 - ((vibration - 1) / 2 * 50)
    END AS vib_score
FROM equipment_metrics
ORDER BY equipment_id, timestamp DESC;

CREATE INDEX IF NOT EXISTS idx_equipment_health_cache_equipment
ON equipment_health_cache(equipment_id);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY equipment_health_cache;
```

### 4.3 æ‰¹é‡é¢„æµ‹ä¼˜åŒ–

**æ‰¹é‡é¢„æµ‹ä¼˜åŒ–**ï¼šæ‰¹é‡é¢„æµ‹å¤šä¸ªè®¾å¤‡ã€‚

```sql
-- æ‰¹é‡é¢„æµ‹ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '512MB';
        SET max_parallel_workers_per_gather = 4;
        RAISE NOTICE 'æ‰¹é‡é¢„æµ‹ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡é¢„æµ‹ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡Œé¢„æµ‹æ€§ç»´æŠ¤å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œé¢„æµ‹æ€§ç»´æŠ¤èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œå¥åº·åº¦è¯„ä¼°ã€æ•…éšœé¢„æµ‹å’Œç»´æŠ¤å»ºè®®è®¡ç®—ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡é¢„æµ‹æ€§ç»´æŠ¤çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œé¢„æµ‹æ€§ç»´æŠ¤åŸç†

PostgreSQL 18 çš„å¹¶è¡Œé¢„æµ‹æ€§ç»´æŠ¤é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æè®¾å¤‡ç›‘æ§æ•°æ®
2. **å¹¶è¡Œå¥åº·åº¦è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—è®¾å¤‡å¥åº·åº¦
3. **å¹¶è¡Œæ•…éšœé¢„æµ‹**ï¼šå¹¶è¡Œæ‰§è¡Œæ•…éšœé¢„æµ‹ç®—æ³•
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„é¢„æµ‹ç»“æœ

### 5.2 å¹¶è¡Œå¥åº·åº¦è¯„ä¼°

```sql
-- PostgreSQL 18 å¹¶è¡Œå¥åº·åº¦è¯„ä¼°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå¥åº·åº¦è¯„ä¼°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå¥åº·åº¦è¯„ä¼°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå¥åº·åº¦è¯„ä¼°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå¥åº·åº¦è¯„ä¼°ï¼šå¤šæŒ‡æ ‡ç»¼åˆè¯„åˆ†
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH metric_stats AS (
    SELECT
        equipment_id,
        AVG(temperature) AS avg_temp,
        AVG(vibration) AS avg_vib,
        AVG(power_consumption) AS avg_power,
        STDDEV(temperature) AS std_temp,
        STDDEV(vibration) AS std_vib
    FROM equipment_metrics
    WHERE timestamp >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY equipment_id
),
health_scores AS (
    SELECT
        equipment_id,
        avg_temp,
        avg_vib,
        avg_power,
        CASE
            WHEN avg_temp < 50 AND avg_vib < 5 THEN 1.0
            WHEN avg_temp < 70 AND avg_vib < 10 THEN 0.8
            WHEN avg_temp < 85 AND avg_vib < 15 THEN 0.6
            ELSE 0.4
        END AS health_score
    FROM metric_stats
)
SELECT
    equipment_id,
    ROUND(avg_temp::numeric, 2) AS avg_temperature,
    ROUND(avg_vib::numeric, 2) AS avg_vibration,
    ROUND(health_score::numeric, 2) AS health_score,
    CASE
        WHEN health_score >= 0.8 THEN 'Healthy'
        WHEN health_score >= 0.6 THEN 'Warning'
        ELSE 'Critical'
    END AS health_status
FROM health_scores
ORDER BY health_score;
```

### 5.3 å¹¶è¡Œæ•…éšœé¢„æµ‹

```sql
-- PostgreSQL 18 å¹¶è¡Œæ•…éšœé¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ•…éšœé¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ•…éšœé¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ•…éšœé¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ•…éšœé¢„æµ‹ï¼šåŸºäºè¶‹åŠ¿åˆ†æ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH trend_analysis AS (
    SELECT
        equipment_id,
        timestamp,
        temperature,
        vibration,
        AVG(temperature) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS temp_trend,
        AVG(vibration) OVER (
            PARTITION BY equipment_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS vib_trend
    FROM equipment_metrics
    WHERE timestamp >= CURRENT_DATE - INTERVAL '7 days'
),
failure_risk AS (
    SELECT
        equipment_id,
        MAX(timestamp) AS last_check,
        MAX(CASE
            WHEN temperature > temp_trend * 1.1 AND vibration > vib_trend * 1.15 THEN 0.8
            WHEN temperature > temp_trend * 1.05 OR vibration > vib_trend * 1.1 THEN 0.5
            ELSE 0.2
        END) AS max_failure_risk
    FROM trend_analysis
    GROUP BY equipment_id
)
SELECT
    equipment_id,
    last_check,
    ROUND(max_failure_risk::numeric, 2) AS failure_risk_score,
    CASE
        WHEN max_failure_risk >= 0.7 THEN 'High Risk'
        WHEN max_failure_risk >= 0.5 THEN 'Medium Risk'
        ELSE 'Low Risk'
    END AS risk_level
FROM failure_risk
ORDER BY max_failure_risk DESC;
```

### 5.4 å¹¶è¡Œç»´æŠ¤å»ºè®®

```sql
-- PostgreSQL 18 å¹¶è¡Œç»´æŠ¤å»ºè®®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œç»´æŠ¤å»ºè®®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œç»´æŠ¤å»ºè®®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œç»´æŠ¤å»ºè®®å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œç»´æŠ¤å»ºè®®ï¼šåŸºäºå¥åº·åº¦å’Œæ•…éšœé£é™©
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH equipment_status AS (
    SELECT
        equipment_id,
        AVG(temperature) AS avg_temp,
        AVG(vibration) AS avg_vib,
        MAX(temperature) AS max_temp,
        MAX(vibration) AS max_vib
    FROM equipment_metrics
    WHERE timestamp >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY equipment_id
),
maintenance_priority AS (
    SELECT
        equipment_id,
        avg_temp,
        avg_vib,
        CASE
            WHEN max_temp > 85 OR max_vib > 15 THEN 1  -- ç´§æ€¥
            WHEN max_temp > 70 OR max_vib > 10 THEN 2  -- é«˜ä¼˜å…ˆçº§
            WHEN max_temp > 50 OR max_vib > 5 THEN 3   -- ä¸­ä¼˜å…ˆçº§
            ELSE 4  -- ä½ä¼˜å…ˆçº§
        END AS priority,
        CASE
            WHEN max_temp > 85 THEN 'Temperature too high, immediate inspection needed'
            WHEN max_vib > 15 THEN 'Vibration excessive, check bearings'
            WHEN max_temp > 70 THEN 'Temperature elevated, schedule maintenance'
            WHEN max_vib > 10 THEN 'Vibration increased, monitor closely'
            ELSE 'Normal operation, routine maintenance'
        END AS maintenance_recommendation
    FROM equipment_status
)
SELECT
    equipment_id,
    ROUND(avg_temp::numeric, 2) AS avg_temperature,
    ROUND(avg_vib::numeric, 2) AS avg_vibration,
    priority,
    maintenance_recommendation
FROM maintenance_priority
ORDER BY priority, equipment_id;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤

**æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤**ç›‘æ§æœåŠ¡å™¨å¥åº·çŠ¶æ€å¹¶é¢„æµ‹æ•…éšœã€‚

```sql
-- æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'server_metrics') THEN
            RAISE WARNING 'è¡¨ server_metrics ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE server_metrics (
                timestamp TIMESTAMP NOT NULL,
                server_id VARCHAR(50) NOT NULL,
                cpu_usage NUMERIC(5, 2),
                memory_usage NUMERIC(5, 2),
                disk_io_wait NUMERIC(5, 2),
                disk_usage NUMERIC(5, 2),
                error_count INTEGER,
                PRIMARY KEY (timestamp, server_id)
            );

            INSERT INTO server_metrics (timestamp, server_id, cpu_usage, memory_usage, disk_io_wait, disk_usage, error_count) VALUES
                ('2024-01-01 10:00:00', 'SRV001', 45.5, 65.2, 5.2, 75.0, 0),
                ('2024-01-01 10:01:00', 'SRV001', 48.2, 67.8, 6.5, 75.5, 2),
                ('2024-01-01 10:02:00', 'SRV001', 52.3, 70.1, 8.1, 76.0, 5);

            RAISE NOTICE 'è¡¨ server_metrics åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒæœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœåŠ¡å™¨é¢„æµ‹æ€§ç»´æŠ¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æœåŠ¡å™¨å¥åº·åº¦è¯„ä¼°å’Œé¢„æµ‹
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH server_trends AS (
    SELECT
        server_id,
        timestamp,
        cpu_usage,
        memory_usage,
        disk_io_wait,
        disk_usage,
        error_count,
        AVG(cpu_usage) OVER (PARTITION BY server_id ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS avg_cpu,
        AVG(memory_usage) OVER (PARTITION BY server_id ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS avg_memory,
        AVG(disk_io_wait) OVER (PARTITION BY server_id ORDER BY timestamp ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) AS avg_io_wait
    FROM server_metrics
),
health_assessment AS (
    SELECT
        server_id,
        timestamp,
        cpu_usage,
        memory_usage,
        disk_usage,
        error_count,
        avg_cpu,
        avg_memory,
        avg_io_wait,
        CASE
            WHEN cpu_usage > 90 OR memory_usage > 95 OR disk_usage > 90 OR error_count > 10 THEN 'Critical'
            WHEN cpu_usage > 80 OR memory_usage > 85 OR disk_usage > 80 OR error_count > 5 THEN 'Warning'
            ELSE 'Normal'
        END AS current_status,
        CASE
            WHEN avg_cpu > 85 OR avg_memory > 90 OR avg_io_wait > 15 THEN 'High Risk'
            WHEN avg_cpu > 75 OR avg_memory > 80 OR avg_io_wait > 10 THEN 'Medium Risk'
            ELSE 'Low Risk'
        END AS failure_risk
    FROM server_trends
    WHERE avg_cpu IS NOT NULL
)
SELECT
    server_id,
    timestamp,
    ROUND(cpu_usage::numeric, 2) AS cpu_usage,
    ROUND(memory_usage::numeric, 2) AS memory_usage,
    ROUND(disk_usage::numeric, 2) AS disk_usage,
    error_count,
    current_status,
    failure_risk,
    CASE
        WHEN current_status = 'Critical' THEN 'Immediate maintenance required'
        WHEN failure_risk = 'High Risk' THEN 'Schedule maintenance within 48 hours'
        WHEN failure_risk = 'Medium Risk' THEN 'Schedule maintenance within 1 week'
        ELSE 'Monitor closely'
    END AS maintenance_action
FROM health_assessment
WHERE current_status != 'Normal' OR failure_risk != 'Low Risk'
ORDER BY
    CASE current_status WHEN 'Critical' THEN 1 WHEN 'Warning' THEN 2 ELSE 3 END,
    CASE failure_risk WHEN 'High Risk' THEN 1 WHEN 'Medium Risk' THEN 2 ELSE 3 END;
```

### 5.2 æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤

**æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤**ï¼šé¢„æµ‹æ•°æ®åº“æ•…éšœå’Œç»´æŠ¤éœ€æ±‚ã€‚

```sql
-- æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'database_health') THEN
            RAISE WARNING 'è¡¨ database_health ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE database_health (
                timestamp TIMESTAMP NOT NULL,
                database_name VARCHAR(100) NOT NULL,
                connection_count INTEGER,
                query_count BIGINT,
                slow_query_count INTEGER,
                lock_wait_count INTEGER,
                deadlock_count INTEGER,
                PRIMARY KEY (timestamp, database_name)
            );

            INSERT INTO database_health (timestamp, database_name, connection_count, query_count, slow_query_count, lock_wait_count, deadlock_count) VALUES
                ('2024-01-01 10:00:00', 'db_prod', 50, 1000000, 10, 5, 0),
                ('2024-01-01 11:00:00', 'db_prod', 55, 1050000, 15, 8, 1),
                ('2024-01-01 12:00:00', 'db_prod', 60, 1100000, 25, 15, 2);

            RAISE NOTICE 'è¡¨ database_health åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ•°æ®åº“é¢„æµ‹æ€§ç»´æŠ¤ï¼šè¯„ä¼°æ•°æ®åº“å¥åº·åº¦
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH database_trends AS (
    SELECT
        database_name,
        timestamp,
        connection_count,
        query_count,
        slow_query_count,
        lock_wait_count,
        deadlock_count,
        AVG(connection_count) OVER (
            PARTITION BY database_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_connections,
        AVG(slow_query_count) OVER (
            PARTITION BY database_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_slow_queries,
        AVG(lock_wait_count) OVER (
            PARTITION BY database_name
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_lock_waits
    FROM database_health
),
health_scores AS (
    SELECT
        database_name,
        timestamp,
        connection_count,
        slow_query_count,
        lock_wait_count,
        deadlock_count,
        avg_connections,
        avg_slow_queries,
        avg_lock_waits,
        -- è¿æ¥å¥åº·åº¦
        CASE
            WHEN connection_count > 100 THEN 0
            WHEN connection_count < 20 THEN 50
            ELSE 100 - ((connection_count - 20) / 80 * 50)
        END AS connection_score,
        -- æŸ¥è¯¢å¥åº·åº¦
        CASE
            WHEN slow_query_count > 50 THEN 0
            WHEN slow_query_count < 5 THEN 100
            ELSE 100 - ((slow_query_count - 5) / 45 * 100)
        END AS query_score,
        -- é”å¥åº·åº¦
        CASE
            WHEN lock_wait_count > 20 THEN 0
            WHEN lock_wait_count < 2 THEN 100
            ELSE 100 - ((lock_wait_count - 2) / 18 * 100)
        END AS lock_score
    FROM database_trends
    WHERE avg_connections IS NOT NULL
),
overall_health AS (
    SELECT
        database_name,
        timestamp,
        connection_count,
        slow_query_count,
        lock_wait_count,
        deadlock_count,
        connection_score,
        query_score,
        lock_score,
        (connection_score * 0.3 + query_score * 0.4 + lock_score * 0.3) AS overall_health_score,
        CASE
            WHEN deadlock_count > 0 THEN 'Critical'
            WHEN avg_slow_queries > 30 OR avg_lock_waits > 15 THEN 'High Risk'
            WHEN avg_slow_queries > 20 OR avg_lock_waits > 10 THEN 'Medium Risk'
            ELSE 'Low Risk'
        END AS failure_risk
    FROM health_scores
    JOIN database_trends USING (database_name, timestamp)
)
SELECT
    database_name,
    timestamp,
    connection_count,
    slow_query_count,
    lock_wait_count,
    deadlock_count,
    ROUND(overall_health_score::numeric, 2) AS health_score,
    failure_risk,
    CASE
        WHEN deadlock_count > 0 THEN 'Immediate investigation required'
        WHEN failure_risk = 'High Risk' THEN 'Schedule maintenance within 48 hours'
        WHEN failure_risk = 'Medium Risk' THEN 'Schedule maintenance within 1 week'
        ELSE 'Monitor closely'
    END AS maintenance_action
FROM overall_health
WHERE overall_health_score < 70 OR failure_risk != 'Low Risk'
ORDER BY overall_health_score ASC, timestamp DESC;
```

### 5.3 ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤

**ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤**ï¼šé¢„æµ‹ç½‘ç»œè®¾å¤‡æ•…éšœã€‚

```sql
-- ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'network_device_metrics') THEN
            RAISE WARNING 'è¡¨ network_device_metrics ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE network_device_metrics (
                timestamp TIMESTAMP NOT NULL,
                device_id VARCHAR(50) NOT NULL,
                cpu_usage NUMERIC(5, 2),
                memory_usage NUMERIC(5, 2),
                packet_loss_rate NUMERIC(5, 2),
                error_rate NUMERIC(5, 2),
                PRIMARY KEY (timestamp, device_id)
            );

            INSERT INTO network_device_metrics (timestamp, device_id, cpu_usage, memory_usage, packet_loss_rate, error_rate) VALUES
                ('2024-01-01 10:00:00', 'SW001', 30.5, 45.2, 0.1, 0.05),
                ('2024-01-01 11:00:00', 'SW001', 32.2, 47.8, 0.2, 0.08),
                ('2024-01-01 12:00:00', 'SW001', 35.5, 50.1, 0.5, 0.15);

            RAISE NOTICE 'è¡¨ network_device_metrics åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç½‘ç»œè®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤ï¼šè¯„ä¼°ç½‘ç»œè®¾å¤‡å¥åº·åº¦
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH device_trends AS (
    SELECT
        device_id,
        timestamp,
        cpu_usage,
        memory_usage,
        packet_loss_rate,
        error_rate,
        AVG(cpu_usage) OVER (
            PARTITION BY device_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_cpu,
        AVG(packet_loss_rate) OVER (
            PARTITION BY device_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_packet_loss,
        AVG(error_rate) OVER (
            PARTITION BY device_id
            ORDER BY timestamp
            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
        ) AS avg_error_rate
    FROM network_device_metrics
),
health_assessment AS (
    SELECT
        device_id,
        timestamp,
        cpu_usage,
        memory_usage,
        packet_loss_rate,
        error_rate,
        avg_cpu,
        avg_packet_loss,
        avg_error_rate,
        CASE
            WHEN packet_loss_rate > 1.0 OR error_rate > 0.5 THEN 'Critical'
            WHEN packet_loss_rate > 0.5 OR error_rate > 0.2 THEN 'Warning'
            ELSE 'Normal'
        END AS current_status,
        CASE
            WHEN avg_packet_loss > 0.8 OR avg_error_rate > 0.4 THEN 'High Risk'
            WHEN avg_packet_loss > 0.3 OR avg_error_rate > 0.15 THEN 'Medium Risk'
            ELSE 'Low Risk'
        END AS failure_risk
    FROM device_trends
    WHERE avg_cpu IS NOT NULL
)
SELECT
    device_id,
    timestamp,
    ROUND(cpu_usage::numeric, 2) AS cpu_usage,
    ROUND(memory_usage::numeric, 2) AS memory_usage,
    ROUND(packet_loss_rate::numeric, 2) AS packet_loss_rate,
    ROUND(error_rate::numeric, 2) AS error_rate,
    current_status,
    failure_risk,
    CASE
        WHEN current_status = 'Critical' THEN 'Immediate maintenance required'
        WHEN failure_risk = 'High Risk' THEN 'Schedule maintenance within 48 hours'
        WHEN failure_risk = 'Medium Risk' THEN 'Schedule maintenance within 1 week'
        ELSE 'Monitor closely'
    END AS maintenance_action
FROM health_assessment
WHERE current_status != 'Normal' OR failure_risk != 'Low Risk'
ORDER BY
    CASE current_status WHEN 'Critical' THEN 1 WHEN 'Warning' THEN 2 ELSE 3 END,
    CASE failure_risk WHEN 'High Risk' THEN 1 WHEN 'Medium Risk' THEN 2 ELSE 3 END;
```

### 5.4 ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ

**ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ**ï¼šç»¼åˆå¤šç§è®¾å¤‡çš„é¢„æµ‹æ€§ç»´æŠ¤ã€‚

```sql
-- ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'equipment_metrics') THEN
            RAISE WARNING 'è¡¨ equipment_metrics ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆé¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿï¼šç»Ÿä¸€è¯„ä¼°æ‰€æœ‰è®¾å¤‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH equipment_health AS (
    SELECT DISTINCT ON (equipment_id)
        equipment_id,
        timestamp,
        temperature,
        vibration,
        pressure,
        power_consumption,
        CASE
            WHEN temperature > 50 THEN 0
            WHEN temperature < 40 THEN 50
            ELSE 100 - ((temperature - 40) / 10 * 50)
        END AS temp_score,
        CASE
            WHEN vibration > 3 THEN 0
            WHEN vibration < 1 THEN 50
            ELSE 100 - ((vibration - 1) / 2 * 50)
        END AS vib_score
    FROM equipment_metrics
    ORDER BY equipment_id, timestamp DESC
),
health_summary AS (
    SELECT
        equipment_id,
        timestamp,
        (temp_score + vib_score) / 2 AS health_score,
        CASE
            WHEN (temp_score + vib_score) / 2 < 50 THEN 'Critical'
            WHEN (temp_score + vib_score) / 2 < 70 THEN 'Warning'
            WHEN (temp_score + vib_score) / 2 < 85 THEN 'Degraded'
            ELSE 'Healthy'
        END AS health_status,
        CASE
            WHEN (temp_score + vib_score) / 2 < 50 THEN 1
            WHEN (temp_score + vib_score) / 2 < 70 THEN 2
            WHEN (temp_score + vib_score) / 2 < 85 THEN 3
            ELSE 4
        END AS priority_order
    FROM equipment_health
)
SELECT
    equipment_id,
    timestamp,
    ROUND(health_score::numeric, 2) AS health_score,
    health_status,
    CASE priority_order
        WHEN 1 THEN NOW() + INTERVAL '24 hours'
        WHEN 2 THEN NOW() + INTERVAL '7 days'
        WHEN 3 THEN NOW() + INTERVAL '30 days'
        ELSE NOW() + INTERVAL '90 days'
    END AS recommended_maintenance_date,
    CASE priority_order
        WHEN 1 THEN 'Immediate maintenance required'
        WHEN 2 THEN 'Schedule maintenance within 1 week'
        WHEN 3 THEN 'Schedule maintenance within 1 month'
        ELSE 'Routine check recommended'
    END AS maintenance_recommendation
FROM health_summary
ORDER BY priority_order, health_score ASC;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 é¢„æµ‹æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **å¥åº·åº¦è¯„åˆ†** | $H = \sum_{i=1}^{n} w_i \cdot S_i$ | $O(n)$ | $O(1)$ | å¤šæŒ‡æ ‡è¯„ä¼° | ç®€å•ã€ç›´è§‚ | éœ€è¦æƒé‡è®¾ç½® |
| **è¶‹åŠ¿é¢„æµ‹** | $T_f = f(\text{trend}(M))$ | $O(n)$ | $O(1)$ | è¶‹åŠ¿é¢„æµ‹ | è€ƒè™‘æ—¶é—´æ€§ | å‡è®¾è¶‹åŠ¿å»¶ç»­ |
| **å¼‚å¸¸é¢„æµ‹** | $T_f = f(\text{anomaly}(M))$ | $O(n)$ | $O(1)$ | å¼‚å¸¸é¢„æµ‹ | å¿«é€Ÿ | å¯èƒ½è¯¯æŠ¥ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨(timestamp, equipment_id)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•

2. **å¥åº·åº¦è®¡ç®—ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¥åº·åº¦
   - æ‰¹é‡è®¡ç®—å¤šä¸ªè®¾å¤‡

3. **é¢„æµ‹ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜é¢„æµ‹ç»“æœ
   - å®šæœŸæ›´æ–°é¢„æµ‹æ¨¡å‹

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šé¢„æµ‹ç²¾åº¦ä½

- **è§£å†³æ–¹æ¡ˆ**ï¼šå¢åŠ å†å²æ•°æ®ã€ä½¿ç”¨æ›´å¤æ‚æ¨¡å‹ã€å¤šæŒ‡æ ‡ç»¼åˆ

**é—®é¢˜2**ï¼šè¯¯æŠ¥ç‡é«˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šè°ƒæ•´é˜ˆå€¼ã€ä½¿ç”¨ç§»åŠ¨å¹³å‡ã€æ·»åŠ è¿‡æ»¤æ¡ä»¶

**é—®é¢˜3**ï¼šè®¡ç®—æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ã€ç´¢å¼•ä¼˜åŒ–ã€å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜4**ï¼šç»´æŠ¤è®¡åˆ’ä¸åˆç†

- **è§£å†³æ–¹æ¡ˆ**ï¼šè€ƒè™‘ç»´æŠ¤æˆæœ¬ã€èµ„æºçº¦æŸã€ä¼˜å…ˆçº§ä¼˜åŒ–

---

## 8. æœ€ä½³å®è·µ

### 7.1 æ–¹æ³•é€‰æ‹©

1. **å¤šæŒ‡æ ‡è®¾å¤‡**ï¼šä½¿ç”¨å¥åº·åº¦è¯„åˆ†
2. **è¶‹åŠ¿æ˜æ˜¾**ï¼šä½¿ç”¨è¶‹åŠ¿é¢„æµ‹
3. **å¼‚å¸¸é¢‘ç¹**ï¼šä½¿ç”¨å¼‚å¸¸é¢„æµ‹

### 7.2 æ•°æ®è´¨é‡

1. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿ç›‘æ§æ•°æ®å®Œæ•´
2. **å¼‚å¸¸å€¼å¤„ç†**ï¼šè¯†åˆ«å’Œå¤„ç†å¼‚å¸¸å€¼
3. **æ•°æ®æ›´æ–°**ï¼šå®æ—¶æ›´æ–°ç›‘æ§æ•°æ®

### 7.3 æ¨¡å‹æ›´æ–°

1. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°é¢„æµ‹æ¨¡å‹
2. **åé¦ˆå­¦ä¹ **ï¼šæ ¹æ®ç»´æŠ¤ç»“æœä¼˜åŒ–æ¨¡å‹
3. **é˜ˆå€¼è°ƒæ•´**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é˜ˆå€¼

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **å¤šæŒ‡æ ‡ç»¼åˆ**ï¼šåˆç†è®¾ç½®æƒé‡
2. **æ—¶é—´çª—å£**ï¼šåˆç†è®¾ç½®æ—¶é—´çª—å£
3. **ä¼˜å…ˆçº§è®¡ç®—**ï¼šè€ƒè™‘å¤šä¸ªå› ç´ 
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†NULLå€¼å’Œè¾¹ç•Œæƒ…å†µ

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šé¢„æµ‹æ€§ç»´æŠ¤ã€‹ï¼ˆPredictive Maintenanceï¼‰- é¢„æµ‹æ€§ç»´æŠ¤ç†è®º
- ã€Šè®¾å¤‡å¥åº·ç®¡ç†ã€‹ï¼ˆEquipment Health Managementï¼‰- å¥åº·åº¦è¯„ä¼°

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)
- [èšåˆå‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html)
- [æ—¶é—´å‡½æ•°](https://www.postgresql.org/docs/current/functions-datetime.html)

### åœ¨çº¿èµ„æº

- PostgreSQLé¢„æµ‹æ€§ç»´æŠ¤æŒ‡å—
- é¢„æµ‹æ€§ç»´æŠ¤æ–¹æ³•è¯¦è§£
- é¢„æµ‹æ€§ç»´æŠ¤æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [æ€§èƒ½æŒ‡æ ‡è®¡ç®—](./æ€§èƒ½æŒ‡æ ‡è®¡ç®—.md) - æ€§èƒ½ç›‘æ§
- [å¼‚å¸¸æ£€æµ‹ç®—æ³•](./å¼‚å¸¸æ£€æµ‹ç®—æ³•.md) - å¼‚å¸¸æ£€æµ‹
- [èµ„æºä¼˜åŒ–ç®—æ³•](./èµ„æºä¼˜åŒ–ç®—æ³•.md) - èµ„æºä¼˜åŒ–

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
