# PostgreSQL æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ•°æ®å®‰å…¨ | åŠ å¯†ç®—æ³• | å“ˆå¸Œå‡½æ•°
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Cryptography, Data Encryption, Security

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ•°æ®åŠ å¯†æ¦‚è¿°](#æ•°æ®åŠ å¯†æ¦‚è¿°)
  - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
    - [æ•°æ®åŠ å¯†é—®é¢˜å®šä¹‰](#æ•°æ®åŠ å¯†é—®é¢˜å®šä¹‰)
    - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
    - [ç®—æ³•åˆ†ç±»](#ç®—æ³•åˆ†ç±»)
    - [åŠ å¯†ç±»å‹å¯¹æ¯”](#åŠ å¯†ç±»å‹å¯¹æ¯”)
    - [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
  - [1. å¯¹ç§°åŠ å¯†](#1-å¯¹ç§°åŠ å¯†)
    - [1.1 AESåŠ å¯†](#11-aesåŠ å¯†)
    - [1.2 åŠ å¯†å‡½æ•°å°è£…](#12-åŠ å¯†å‡½æ•°å°è£…)
  - [2. éå¯¹ç§°åŠ å¯†](#2-éå¯¹ç§°åŠ å¯†)
    - [2.1 RSAåŠ å¯†](#21-rsaåŠ å¯†)
  - [3. å“ˆå¸Œå‡½æ•°](#3-å“ˆå¸Œå‡½æ•°)
    - [3.1 MD5å’ŒSHAå“ˆå¸Œ](#31-md5å’Œshaå“ˆå¸Œ)
    - [3.2 å¯†ç å­˜å‚¨æœ€ä½³å®è·µ](#32-å¯†ç å­˜å‚¨æœ€ä½³å®è·µ)
    - [3.3 æ•°æ®å®Œæ•´æ€§éªŒè¯](#33-æ•°æ®å®Œæ•´æ€§éªŒè¯)
  - [4. åŠ å¯†æ€§èƒ½åˆ†æ](#4-åŠ å¯†æ€§èƒ½åˆ†æ)
    - [4.1 åŠ å¯†æ€§èƒ½æµ‹è¯•](#41-åŠ å¯†æ€§èƒ½æµ‹è¯•)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨](#51-æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨)
    - [5.2 å¯†ç ç®¡ç†ç³»ç»Ÿ](#52-å¯†ç ç®¡ç†ç³»ç»Ÿ)
    - [5.3 æ•°æ®å®Œæ•´æ€§éªŒè¯ç³»ç»Ÿ](#53-æ•°æ®å®Œæ•´æ€§éªŒè¯ç³»ç»Ÿ)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [å¯†é’¥ç®¡ç†](#å¯†é’¥ç®¡ç†)
    - [åŠ å¯†ç®—æ³•é€‰æ‹©](#åŠ å¯†ç®—æ³•é€‰æ‹©)
    - [æ‰¹é‡åŠ å¯†ä¼˜åŒ–](#æ‰¹é‡åŠ å¯†ä¼˜åŒ–)
    - [ç´¢å¼•ä¼˜åŒ–](#ç´¢å¼•ä¼˜åŒ–)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [å¯†é’¥å®‰å…¨](#å¯†é’¥å®‰å…¨)
    - [å¯†ç ç­–ç•¥](#å¯†ç ç­–ç•¥)
    - [æ•°æ®åˆ†ç±»](#æ•°æ®åˆ†ç±»)
    - [SQLå®ç°æ³¨æ„äº‹é¡¹](#sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“ˆ åŠ å¯†æ–¹æ³•å¯¹æ¯”](#-åŠ å¯†æ–¹æ³•å¯¹æ¯”)
  - [ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1ï¼šåŠ å¯†æ€§èƒ½æ…¢](#é—®é¢˜1åŠ å¯†æ€§èƒ½æ…¢)
    - [é—®é¢˜2ï¼šå¯†é’¥æ³„éœ²é£é™©](#é—®é¢˜2å¯†é’¥æ³„éœ²é£é™©)
    - [é—®é¢˜3ï¼šå¯†ç å­˜å‚¨ä¸å®‰å…¨](#é—®é¢˜3å¯†ç å­˜å‚¨ä¸å®‰å…¨)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## æ•°æ®åŠ å¯†æ¦‚è¿°

**æ•°æ®åŠ å¯†**ä¿æŠ¤æ•°æ®çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ•°æ®å®‰å…¨çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

## ç†è®ºåŸºç¡€

### æ•°æ®åŠ å¯†é—®é¢˜å®šä¹‰

æ•°æ®åŠ å¯†æ˜¯é€šè¿‡æ•°å­¦ç®—æ³•å°†æ˜æ–‡è½¬æ¢ä¸ºå¯†æ–‡çš„è¿‡ç¨‹ï¼Œç¡®ä¿åªæœ‰æ‹¥æœ‰å¯†é’¥çš„æˆæƒç”¨æˆ·æ‰èƒ½è§£å¯†å’Œè®¿é—®åŸå§‹æ•°æ®ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

1. **åŠ å¯†ç±»å‹**ï¼š
   - **å¯¹ç§°åŠ å¯†**ï¼šåŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€å¯†é’¥ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§æ•°æ®é‡
   - **éå¯¹ç§°åŠ å¯†**ï¼šä½¿ç”¨å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯†ï¼Œå®‰å…¨æ€§é«˜ï¼Œé€‚åˆå¯†é’¥äº¤æ¢
   - **å“ˆå¸Œå‡½æ•°**ï¼šå•å‘å‡½æ•°ï¼Œä¸å¯é€†ï¼Œç”¨äºå¯†ç å­˜å‚¨å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯

2. **åŠ å¯†ç®—æ³•**ï¼š
   - **AESï¼ˆAdvanced Encryption Standardï¼‰**ï¼šå¯¹ç§°åŠ å¯†æ ‡å‡†ï¼Œæ”¯æŒ128/192/256ä½å¯†é’¥
   - **RSA**ï¼šéå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒåŸºäºå¤§æ•°åˆ†è§£éš¾é¢˜
   - **SHAç³»åˆ—**ï¼šå®‰å…¨å“ˆå¸Œç®—æ³•ï¼Œç”¨äºæ•°æ®å®Œæ•´æ€§éªŒè¯

3. **å¯†é’¥ç®¡ç†**ï¼š
   - å¯†é’¥ç”Ÿæˆï¼šä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
   - å¯†é’¥å­˜å‚¨ï¼šå®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œé¿å…æ³„éœ²
   - å¯†é’¥è½®æ¢ï¼šå®šæœŸæ›´æ–°å¯†é’¥

### ç®—æ³•åˆ†ç±»

1. **æŒ‰åŠ å¯†æ–¹å¼åˆ†ç±»**ï¼š
   - å¯¹ç§°åŠ å¯†ï¼šAESã€DESã€3DES
   - éå¯¹ç§°åŠ å¯†ï¼šRSAã€ECCã€ElGamal
   - å“ˆå¸Œå‡½æ•°ï¼šMD5ã€SHA-1ã€SHA-256ã€SHA-512

2. **æŒ‰åº”ç”¨åœºæ™¯åˆ†ç±»**ï¼š
   - æ•°æ®åŠ å¯†ï¼šä¿æŠ¤å­˜å‚¨æ•°æ®
   - ä¼ è¾“åŠ å¯†ï¼šä¿æŠ¤ä¼ è¾“ä¸­çš„æ•°æ®
   - å¯†ç å­˜å‚¨ï¼šå®‰å…¨å­˜å‚¨ç”¨æˆ·å¯†ç 

### åŠ å¯†ç±»å‹å¯¹æ¯”

| ç±»å‹ | ç‰¹ç‚¹ | åº”ç”¨åœºæ™¯ | ä¼˜åŠ¿ | å±€é™æ€§ |
|------|------|---------|------|--------|
| **å¯¹ç§°åŠ å¯†** | åŠ å¯†è§£å¯†ä½¿ç”¨åŒä¸€å¯†é’¥ | å¤§æ•°æ®é‡åŠ å¯† | é€Ÿåº¦å¿«ã€æ•ˆç‡é«˜ | å¯†é’¥åˆ†å‘å›°éš¾ |
| **éå¯¹ç§°åŠ å¯†** | å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯† | å¯†é’¥äº¤æ¢ã€æ•°å­—ç­¾å | å®‰å…¨æ€§é«˜ã€å¯†é’¥ç®¡ç†ç®€å• | é€Ÿåº¦æ…¢ã€è®¡ç®—å¤æ‚ |
| **å“ˆå¸Œå‡½æ•°** | å•å‘å‡½æ•°ï¼Œä¸å¯é€† | å¯†ç å­˜å‚¨ã€æ•°æ®å®Œæ•´æ€§ | ä¸å¯é€†ã€å¿«é€ŸéªŒè¯ | æ— æ³•è§£å¯† |

### æŠ€æœ¯æ ˆ

- **pgcryptoæ‰©å±•**ï¼šPostgreSQLåŠ å¯†æ‰©å±•
- **åŠ å¯†å‡½æ•°**ï¼šencryptã€decryptã€digestã€gen_random_bytes
- **å“ˆå¸Œå‡½æ•°**ï¼šmd5ã€sha1ã€sha256ã€sha512
- **å¯†é’¥ç®¡ç†**ï¼šå¯†é’¥ç”Ÿæˆã€å­˜å‚¨ã€è½®æ¢

---

## 1. å¯¹ç§°åŠ å¯†

### 1.1 AESåŠ å¯†

**AESï¼ˆAdvanced Encryption Standardï¼‰**æ˜¯å¸¸ç”¨çš„å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚

**å¯†é’¥é•¿åº¦**ï¼š128ä½ã€192ä½ã€256ä½

```sql
-- æ•°æ®åŠ å¯†å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥pgcryptoæ‰©å±•
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'pgcryptoæ‰©å±•ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…: CREATE EXTENSION pgcrypto;';
        ELSE
            RAISE NOTICE 'pgcryptoæ‰©å±•å·²å®‰è£…';
        END IF;

        -- åˆ›å»ºæ•æ„Ÿæ•°æ®è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_table') THEN
            DROP TABLE sensitive_table CASCADE;
        END IF;

        CREATE TABLE sensitive_table (
            id SERIAL PRIMARY KEY,
            sensitive_data TEXT NOT NULL,
            encrypted_data BYTEA,
            encryption_key TEXT DEFAULT 'my_secret_key_12345'  -- å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å®‰å…¨çš„å¯†é’¥ç®¡ç†
        );

        -- æ’å…¥ç¤ºä¾‹æ•æ„Ÿæ•°æ®
        INSERT INTO sensitive_table (sensitive_data) VALUES
            ('Credit Card: 1234-5678-9012-3456'),
            ('SSN: 123-45-6789'),
            ('Password: MySecret123'),
            ('Email: user@example.com');

        RAISE NOTICE 'æ•æ„Ÿæ•°æ®è¡¨åˆ›å»ºæˆåŠŸï¼Œå…± % æ¡è®°å½•', (SELECT COUNT(*) FROM sensitive_table);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- AESåŠ å¯†ï¼šä½¿ç”¨pgcryptoæ‰©å±•
-- æ³¨æ„ï¼šéœ€è¦å…ˆå®‰è£…æ‰©å±• CREATE EXTENSION IF NOT EXISTS pgcrypto;
UPDATE sensitive_table
SET encrypted_data = encrypt(
    sensitive_data::bytea,
    encryption_key::bytea,
    'aes'
)
WHERE encrypted_data IS NULL;

-- æŸ¥çœ‹åŠ å¯†ç»“æœ
SELECT
    id,
    sensitive_data,
    encrypted_data,
    LENGTH(encrypted_data) AS encrypted_length,
    encode(encrypted_data, 'hex') AS encrypted_hex
FROM sensitive_table
LIMIT 5;

-- AESè§£å¯†
SELECT
    id,
    sensitive_data AS original_data,
    decrypt(encrypted_data, encryption_key::bytea, 'aes')::TEXT AS decrypted_data,
    CASE
        WHEN decrypt(encrypted_data, encryption_key::bytea, 'aes')::TEXT = sensitive_data
        THEN 'Decryption successful âœ“'
        ELSE 'Decryption failed âœ—'
    END AS decryption_status
FROM sensitive_table
WHERE encrypted_data IS NOT NULL
LIMIT 5;
```

### 1.2 åŠ å¯†å‡½æ•°å°è£…

```sql
-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(
    p_data TEXT,
    p_key TEXT DEFAULT 'default_key'
)
RETURNS BYTEA AS $$
BEGIN
    -- æ£€æŸ¥æ‰©å±•
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
        RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…';
    END IF;

    RETURN encrypt(p_data::bytea, p_key::bytea, 'aes');
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åŠ å¯†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- åˆ›å»ºè§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(
    p_encrypted_data BYTEA,
    p_key TEXT DEFAULT 'default_key'
)
RETURNS TEXT AS $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
        RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…';
    END IF;

    RETURN decrypt(p_encrypted_data, p_key::bytea, 'aes')::TEXT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è§£å¯†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ä½¿ç”¨åŠ å¯†å‡½æ•°
SELECT
    id,
    encrypt_sensitive_data(sensitive_data, encryption_key) AS encrypted,
    decrypt_sensitive_data(
        encrypt_sensitive_data(sensitive_data, encryption_key),
        encryption_key
    ) AS decrypted
FROM sensitive_table
LIMIT 3;
```

---

## 2. éå¯¹ç§°åŠ å¯†

### 2.1 RSAåŠ å¯†

**RSAåŠ å¯†**ä½¿ç”¨å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯†ã€‚

```sql
-- RSAå¯†é’¥å¯¹ç”Ÿæˆï¼ˆç®€åŒ–ï¼šä½¿ç”¨pgcryptoï¼‰
-- æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†å·¥å…·
DO $$
DECLARE
    public_key TEXT;
    private_key TEXT;
BEGIN
    BEGIN
        -- ç”ŸæˆRSAå¯†é’¥å¯¹ï¼ˆç®€åŒ–å®ç°ï¼‰
        -- å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨opensslæˆ–ä¸“é—¨çš„å¯†é’¥ç®¡ç†å·¥å…·
        RAISE NOTICE 'RSAå¯†é’¥å¯¹ç”Ÿæˆéœ€è¦å¤–éƒ¨å·¥å…·ï¼Œè¿™é‡Œä»…æ¼”ç¤ºæ¦‚å¿µ';

        -- ç¤ºä¾‹ï¼šå­˜å‚¨å…¬é’¥å’Œç§é’¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”å®‰å…¨å­˜å‚¨ï¼‰
        CREATE TABLE IF NOT EXISTS rsa_keys (
            key_id SERIAL PRIMARY KEY,
            public_key TEXT NOT NULL,
            private_key TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        RAISE NOTICE 'RSAå¯†é’¥è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'RSAå¯†é’¥ç”Ÿæˆå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- RSAåŠ å¯†ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰
-- å®é™…å®ç°éœ€è¦ä½¿ç”¨pgcryptoçš„pgp_pub_encryptå‡½æ•°
SELECT
    'RSA encryption requires pgcrypto extension and proper key management' AS note;
```

---

## 3. å“ˆå¸Œå‡½æ•°

### 3.1 MD5å’ŒSHAå“ˆå¸Œ

**å“ˆå¸Œå‡½æ•°**ç”¨äºå¯†ç å­˜å‚¨å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯ã€‚

```sql
-- å“ˆå¸Œå‡½æ•°ï¼šMD5å’ŒSHA
WITH hash_examples AS (
    SELECT
        'password123' AS plaintext,
        md5('password123') AS md5_hash,
        encode(digest('password123', 'sha1'), 'hex') AS sha1_hash,
        encode(digest('password123', 'sha256'), 'hex') AS sha256_hash
)
SELECT
    plaintext,
    md5_hash,
    sha1_hash,
    LEFT(sha256_hash, 32) AS sha256_hash_short,
    LENGTH(md5_hash) AS md5_length,
    LENGTH(sha1_hash) AS sha1_length,
    LENGTH(sha256_hash) AS sha256_length
FROM hash_examples;
```

### 3.2 å¯†ç å­˜å‚¨æœ€ä½³å®è·µ

```sql
-- å¯†ç å­˜å‚¨ï¼šä½¿ç”¨åŠ ç›å“ˆå¸Œ
CREATE OR REPLACE FUNCTION hash_password(
    p_password TEXT,
    p_salt TEXT DEFAULT NULL
)
RETURNS TEXT AS $$
DECLARE
    salt_value TEXT;
    hashed_password TEXT;
BEGIN
    -- ç”Ÿæˆéšæœºç›ï¼ˆå¦‚æœæœªæä¾›ï¼‰
    IF p_salt IS NULL THEN
        salt_value := encode(gen_random_bytes(16), 'hex');
    ELSE
        salt_value := p_salt;
    END IF;

    -- ä½¿ç”¨SHA-256åŠ ç›å“ˆå¸Œ
    hashed_password := encode(
        digest(p_password || salt_value, 'sha256'),
        'hex'
    );

    -- è¿”å›ï¼šç›:å“ˆå¸Œå€¼ï¼ˆä¾¿äºå­˜å‚¨å’ŒéªŒè¯ï¼‰
    RETURN salt_value || ':' || hashed_password;
END;
$$ LANGUAGE plpgsql;

-- å¯†ç éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION verify_password(
    p_password TEXT,
    p_stored_hash TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    salt_part TEXT;
    hash_part TEXT;
    computed_hash TEXT;
BEGIN
    -- åˆ†ç¦»ç›å’Œå“ˆå¸Œå€¼
    salt_part := SPLIT_PART(p_stored_hash, ':', 1);
    hash_part := SPLIT_PART(p_stored_hash, ':', 2);

    -- è®¡ç®—å“ˆå¸Œå€¼
    computed_hash := encode(
        digest(p_password || salt_part, 'sha256'),
        'hex'
    );

    -- æ¯”è¾ƒå“ˆå¸Œå€¼
    RETURN computed_hash = hash_part;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨å¯†ç å“ˆå¸Œå‡½æ•°
WITH password_test AS (
    SELECT
        'MySecurePassword123' AS password,
        hash_password('MySecurePassword123') AS stored_hash
)
SELECT
    password,
    stored_hash,
    verify_password('MySecurePassword123', stored_hash) AS verification_result,
    verify_password('WrongPassword', stored_hash) AS wrong_password_result
FROM password_test;
```

### 3.3 æ•°æ®å®Œæ•´æ€§éªŒè¯

```sql
-- æ•°æ®å®Œæ•´æ€§ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹
CREATE OR REPLACE FUNCTION compute_data_hash(
    p_data TEXT
)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(digest(p_data, 'sha256'), 'hex');
END;
$$ LANGUAGE plpgsql;

-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
WITH data_integrity_check AS (
    SELECT
        id,
        sensitive_data,
        compute_data_hash(sensitive_data) AS data_hash,
        -- æ¨¡æ‹Ÿå­˜å‚¨çš„å“ˆå¸Œå€¼
        compute_data_hash(sensitive_data) AS stored_hash
    FROM sensitive_table
)
SELECT
    id,
    LEFT(data_hash, 16) AS data_hash_short,
    LEFT(stored_hash, 16) AS stored_hash_short,
    CASE
        WHEN data_hash = stored_hash THEN 'Data integrity verified âœ“'
        ELSE 'Data integrity check failed âœ—'
    END AS integrity_status
FROM data_integrity_check
LIMIT 5;
```

---

## 4. åŠ å¯†æ€§èƒ½åˆ†æ

### 4.1 åŠ å¯†æ€§èƒ½æµ‹è¯•

```sql
-- åŠ å¯†æ€§èƒ½æµ‹è¯•
DO $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    elapsed INTERVAL;
    test_data TEXT := 'This is a test data for encryption performance testing';
    encrypted_result BYTEA;
BEGIN
    start_time := clock_timestamp();

    -- æ‰§è¡Œ100æ¬¡åŠ å¯†
    FOR i IN 1..100 LOOP
        encrypted_result := encrypt(test_data::bytea, 'test_key'::bytea, 'aes');
    END LOOP;

    end_time := clock_timestamp();
    elapsed := end_time - start_time;

    RAISE NOTICE 'AESåŠ å¯†100æ¬¡ï¼Œè€—æ—¶: %', elapsed;
    RAISE NOTICE 'å¹³å‡æ¯æ¬¡åŠ å¯†è€—æ—¶: %', elapsed / 100;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡Œæ•°æ®åŠ å¯†å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œæ•°æ®åŠ å¯†è®¡ç®—èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡ŒAESåŠ å¯†ã€å“ˆå¸Œå‡½æ•°è®¡ç®—å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡æ•°æ®åŠ å¯†å¤„ç†çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œæ•°æ®åŠ å¯†åŸç†

PostgreSQL 18 çš„å¹¶è¡Œæ•°æ®åŠ å¯†é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æå¾…åŠ å¯†æ•°æ®
2. **å¹¶è¡ŒåŠ å¯†è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ‰§è¡ŒåŠ å¯†æ“ä½œ
3. **å¹¶è¡Œå“ˆå¸Œè®¡ç®—**ï¼šå¹¶è¡Œæ‰§è¡Œå“ˆå¸Œå‡½æ•°è®¡ç®—
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„è®¡ç®—ç»“æœ

### 5.2 å¹¶è¡Œæ‰¹é‡åŠ å¯†

```sql
-- PostgreSQL 18 å¹¶è¡Œæ‰¹é‡åŠ å¯†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_sensitive_info') THEN
            RAISE WARNING 'è¡¨ user_sensitive_info ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ‰¹é‡åŠ å¯†';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ‰¹é‡åŠ å¯†';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ‰¹é‡åŠ å¯†å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå“ˆå¸Œè®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    username,
    encode(digest(sensitive_data::text, 'sha256'), 'hex') AS hashed_data,
    encode(digest(sensitive_data::text, 'md5'), 'hex') AS md5_hash
FROM user_sensitive_info
ORDER BY user_id;
```

### 5.3 å¹¶è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯

```sql
-- PostgreSQL 18 å¹¶è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_sensitive_info') THEN
            RAISE WARNING 'è¡¨ user_sensitive_info ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå®Œæ•´æ€§æ ¡éªŒ
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    encode(digest(sensitive_data::text, 'sha256'), 'hex') AS current_hash,
    stored_hash,
    CASE
        WHEN encode(digest(sensitive_data::text, 'sha256'), 'hex') = stored_hash THEN 'Valid âœ“'
        ELSE 'Invalid âœ—'
    END AS integrity_status
FROM user_sensitive_info
ORDER BY user_id;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

```sql
-- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨åº”ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºç”¨æˆ·æ•æ„Ÿä¿¡æ¯è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_sensitive_info') THEN
            DROP TABLE user_sensitive_info CASCADE;
        END IF;

        CREATE TABLE user_sensitive_info (
            user_id SERIAL PRIMARY KEY,
            username VARCHAR(50) NOT NULL UNIQUE,
            email_encrypted BYTEA,
            phone_encrypted BYTEA,
            ssn_encrypted BYTEA,
            encryption_key TEXT DEFAULT 'user_encryption_key_12345'
        );

        -- æ’å…¥ç¤ºä¾‹ç”¨æˆ·æ•°æ®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
        INSERT INTO user_sensitive_info (username, email_encrypted, phone_encrypted, ssn_encrypted) VALUES
            ('user1', encrypt('user1@example.com'::bytea, 'user_encryption_key_12345'::bytea, 'aes'),
                    encrypt('13800138000'::bytea, 'user_encryption_key_12345'::bytea, 'aes'),
                    encrypt('123-45-6789'::bytea, 'user_encryption_key_12345'::bytea, 'aes')),
            ('user2', encrypt('user2@example.com'::bytea, 'user_encryption_key_12345'::bytea, 'aes'),
                    encrypt('13900139000'::bytea, 'user_encryption_key_12345'::bytea, 'aes'),
                    encrypt('987-65-4321'::bytea, 'user_encryption_key_12345'::bytea, 'aes'));

        RAISE NOTICE 'ç”¨æˆ·æ•æ„Ÿä¿¡æ¯è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢åŠ å¯†æ•°æ®ï¼ˆè§£å¯†æ˜¾ç¤ºï¼‰
SELECT
    user_id,
    username,
    decrypt(email_encrypted, encryption_key::bytea, 'aes')::TEXT AS email,
    decrypt(phone_encrypted, encryption_key::bytea, 'aes')::TEXT AS phone,
    decrypt(ssn_encrypted, encryption_key::bytea, 'aes')::TEXT AS ssn
FROM user_sensitive_info
ORDER BY user_id;
```

### 5.2 å¯†ç ç®¡ç†ç³»ç»Ÿ

```sql
-- å¯†ç ç®¡ç†ç³»ç»Ÿåº”ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºç”¨æˆ·å¯†ç è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_passwords') THEN
            DROP TABLE user_passwords CASCADE;
        END IF;

        CREATE TABLE user_passwords (
            user_id SERIAL PRIMARY KEY,
            username VARCHAR(50) NOT NULL UNIQUE,
            password_hash TEXT NOT NULL,
            salt TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- æ’å…¥ç¤ºä¾‹ç”¨æˆ·å¯†ç ï¼ˆä½¿ç”¨åŠ ç›å“ˆå¸Œï¼‰
        INSERT INTO user_passwords (username, password_hash, salt) VALUES
            ('admin', hash_password('Admin123!', NULL), SPLIT_PART(hash_password('Admin123!', NULL), ':', 1)),
            ('user1', hash_password('User123!', NULL), SPLIT_PART(hash_password('User123!', NULL), ':', 1)),
            ('user2', hash_password('Password123!', NULL), SPLIT_PART(hash_password('Password123!', NULL), ':', 1));

        RAISE NOTICE 'ç”¨æˆ·å¯†ç è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯†ç ç®¡ç†ç³»ç»Ÿå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¯†ç éªŒè¯
SELECT
    username,
    CASE
        WHEN verify_password('Admin123!', password_hash) THEN 'Password correct âœ“'
        ELSE 'Password incorrect âœ—'
    END AS verification_result
FROM user_passwords
WHERE username = 'admin';
```

### 5.3 æ•°æ®å®Œæ•´æ€§éªŒè¯ç³»ç»Ÿ

```sql
-- æ•°æ®å®Œæ•´æ€§éªŒè¯ç³»ç»Ÿåº”ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºæ•°æ®å®Œæ•´æ€§è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_integrity_records') THEN
            DROP TABLE data_integrity_records CASCADE;
        END IF;

        CREATE TABLE data_integrity_records (
            record_id SERIAL PRIMARY KEY,
            data_content TEXT NOT NULL,
            data_hash TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆå¸¦å“ˆå¸Œå€¼ï¼‰
        INSERT INTO data_integrity_records (data_content, data_hash) VALUES
            ('Important document content 1', compute_data_hash('Important document content 1')),
            ('Important document content 2', compute_data_hash('Important document content 2')),
            ('Important document content 3', compute_data_hash('Important document content 3'));

        RAISE NOTICE 'æ•°æ®å®Œæ•´æ€§è®°å½•è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®å®Œæ•´æ€§éªŒè¯ç³»ç»Ÿå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
SELECT
    record_id,
    LEFT(data_content, 30) AS data_preview,
    LEFT(data_hash, 16) AS stored_hash_short,
    LEFT(compute_data_hash(data_content), 16) AS computed_hash_short,
    CASE
        WHEN compute_data_hash(data_content) = data_hash THEN 'Integrity verified âœ“'
        ELSE 'Integrity check failed âœ—'
    END AS integrity_status
FROM data_integrity_records
ORDER BY record_id;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¯†é’¥ç®¡ç†

```sql
-- å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ
-- 1. ä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚AWS KMSã€Azure Key Vaultï¼‰
-- 2. å®šæœŸè½®æ¢å¯†é’¥
-- 3. å®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œé¿å…ç¡¬ç¼–ç 
```

### åŠ å¯†ç®—æ³•é€‰æ‹©

```sql
-- æ ¹æ®æ€§èƒ½å’Œå®‰å…¨éœ€æ±‚é€‰æ‹©ç®—æ³•
-- AES-256ï¼šé«˜å®‰å…¨æ€§ï¼Œé€‚åˆæ•æ„Ÿæ•°æ®
-- AES-128ï¼šå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
-- RSAï¼šé€‚åˆå¯†é’¥äº¤æ¢ï¼Œä¸é€‚åˆå¤§æ•°æ®é‡åŠ å¯†
```

### æ‰¹é‡åŠ å¯†ä¼˜åŒ–

```sql
-- æ‰¹é‡åŠ å¯†ï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡å¤„ç†
BEGIN;
UPDATE sensitive_table
SET encrypted_data = encrypt(sensitive_data::bytea, encryption_key::bytea, 'aes')
WHERE encrypted_data IS NULL;
COMMIT;
```

### ç´¢å¼•ä¼˜åŒ–

```sql
-- åŠ å¯†å­—æ®µæ— æ³•ç›´æ¥ç´¢å¼•ï¼Œéœ€è¦åˆ›å»ºå‡½æ•°ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_username ON user_sensitive_info(username);
-- æ³¨æ„ï¼šåŠ å¯†å­—æ®µæœ¬èº«ä¸èƒ½åˆ›å»ºç´¢å¼•ï¼Œåªèƒ½å¯¹æœªåŠ å¯†å­—æ®µåˆ›å»ºç´¢å¼•
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### å¯†é’¥å®‰å…¨

1. **å¯†é’¥ç”Ÿæˆ**ï¼šä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
2. **å¯†é’¥å­˜å‚¨**ï¼šå®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œé¿å…æ³„éœ²
3. **å¯†é’¥è½®æ¢**ï¼šå®šæœŸæ›´æ–°å¯†é’¥
4. **å¯†é’¥åˆ†ç¦»**ï¼šä¸åŒæ•°æ®ä½¿ç”¨ä¸åŒå¯†é’¥

### å¯†ç ç­–ç•¥

1. **åŠ ç›å“ˆå¸Œ**ï¼šä½¿ç”¨åŠ ç›å“ˆå¸Œå­˜å‚¨å¯†ç 
2. **å¯†ç å¼ºåº¦**ï¼šè¦æ±‚å¼ºå¯†ç ç­–ç•¥
3. **å¯†ç æ›´æ–°**ï¼šå®šæœŸæ›´æ–°å¯†ç 
4. **å¯†ç éªŒè¯**ï¼šä½¿ç”¨å®‰å…¨çš„å¯†ç éªŒè¯æ–¹æ³•

### æ•°æ®åˆ†ç±»

1. **æ•æ„Ÿåº¦åˆ†çº§**ï¼šæ ¹æ®æ•°æ®æ•æ„Ÿåº¦é€‰æ‹©åŠ å¯†çº§åˆ«
2. **åŠ å¯†èŒƒå›´**ï¼šç¡®å®šéœ€è¦åŠ å¯†çš„æ•°æ®èŒƒå›´
3. **åŠ å¯†æ—¶æœº**ï¼šåœ¨å­˜å‚¨å’Œä¼ è¾“æ—¶åŠ å¯†
4. **è®¿é—®æ§åˆ¶**ï¼šç»“åˆè®¿é—®æ§åˆ¶ä¿æŠ¤æ•°æ®

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨DOå—å’ŒEXCEPTIONè¿›è¡Œé”™è¯¯å¤„ç†
2. **æ€§èƒ½è€ƒè™‘**ï¼šåŠ å¯†æ“ä½œå¯èƒ½å½±å“æ€§èƒ½ï¼Œéœ€è¦ä¼˜åŒ–
3. **å¯†é’¥ç®¡ç†**ï¼šå®‰å…¨ç®¡ç†åŠ å¯†å¯†é’¥
4. **æ•°æ®å¤‡ä»½**ï¼šåŠ å¯†æ•°æ®å¤‡ä»½æ—¶æ³¨æ„å¯†é’¥å®‰å…¨

---

## ğŸ“ˆ åŠ å¯†æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | å®‰å…¨æ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | å±€é™æ€§ |
|------|--------|------|---------|------|--------|
| AES-256 | é«˜ | é«˜ | å¤§æ•°æ®é‡åŠ å¯† | é€Ÿåº¦å¿«ã€å®‰å…¨æ€§é«˜ | å¯†é’¥ç®¡ç†å¤æ‚ |
| RSA-2048 | é«˜ | ä½ | å¯†é’¥äº¤æ¢ã€æ•°å­—ç­¾å | å®‰å…¨æ€§é«˜ã€å¯†é’¥ç®¡ç†ç®€å• | é€Ÿåº¦æ…¢ã€ä¸é€‚åˆå¤§æ•°æ®é‡ |
| SHA-256 | é«˜ | é«˜ | å¯†ç å­˜å‚¨ã€æ•°æ®å®Œæ•´æ€§ | ä¸å¯é€†ã€å¿«é€ŸéªŒè¯ | æ— æ³•è§£å¯† |

---

## ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šåŠ å¯†æ€§èƒ½æ…¢

**åŸå› **ï¼š

- æ•°æ®é‡å¤§
- åŠ å¯†ç®—æ³•é€‰æ‹©ä¸å½“
- æœªä½¿ç”¨æ‰¹é‡å¤„ç†

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨å¯¹ç§°åŠ å¯†ï¼ˆAESï¼‰ä»£æ›¿éå¯¹ç§°åŠ å¯†
- ä½¿ç”¨æ‰¹é‡åŠ å¯†å¤„ç†
- ä¼˜åŒ–åŠ å¯†ç®—æ³•å‚æ•°

### é—®é¢˜2ï¼šå¯†é’¥æ³„éœ²é£é™©

**åŸå› **ï¼š

- å¯†é’¥ç¡¬ç¼–ç 
- å¯†é’¥å­˜å‚¨ä¸å®‰å…¨
- å¯†é’¥æœªå®šæœŸè½®æ¢

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡
- å®‰å…¨å­˜å‚¨å¯†é’¥
- å®šæœŸè½®æ¢å¯†é’¥

### é—®é¢˜3ï¼šå¯†ç å­˜å‚¨ä¸å®‰å…¨

**åŸå› **ï¼š

- ä½¿ç”¨æ˜æ–‡å­˜å‚¨
- ä½¿ç”¨å¼±å“ˆå¸Œç®—æ³•
- æœªä½¿ç”¨åŠ ç›

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨åŠ ç›å“ˆå¸Œ
- ä½¿ç”¨å¼ºå“ˆå¸Œç®—æ³•ï¼ˆSHA-256ï¼‰
- ä½¿ç”¨bcryptæˆ–argon2

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Stallings, W. (2017)**: "Cryptography and Network Security: Principles and Practice", 7th Edition
2. **Menezes, A.J., et al. (2018)**: "Handbook of Applied Cryptography"
3. **NIST (2020)**: "Guidelines for Cryptography"

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
