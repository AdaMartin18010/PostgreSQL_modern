# PostgreSQL æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ•°æ®å®‰å…¨ | åŠ å¯†ç®—æ³• | å“ˆå¸Œå‡½æ•°
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Cryptography, Data Encryption, Security

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ•°æ®åŠ å¯†ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ•°æ®åŠ å¯†æ¦‚è¿°](#æ•°æ®åŠ å¯†æ¦‚è¿°)
    - [åŠ å¯†ç±»å‹](#åŠ å¯†ç±»å‹)
  - [1. å¯¹ç§°åŠ å¯†](#1-å¯¹ç§°åŠ å¯†)
    - [1.1 AESåŠ å¯†](#11-aesåŠ å¯†)
    - [1.2 åŠ å¯†å‡½æ•°å°è£…](#12-åŠ å¯†å‡½æ•°å°è£…)
  - [2. éå¯¹ç§°åŠ å¯†](#2-éå¯¹ç§°åŠ å¯†)
    - [2.1 RSAåŠ å¯†](#21-rsaåŠ å¯†)
  - [3. å“ˆå¸Œå‡½æ•°](#3-å“ˆå¸Œå‡½æ•°)
    - [3.1 MD5å’ŒSHAå“ˆå¸Œ](#31-md5å’Œshaå“ˆå¸Œ)
    - [3.2 å¯†ç å­˜å‚¨æœ€ä½³å®è·µ](#32-å¯†ç å­˜å‚¨æœ€ä½³å®è·µ)
    - [3.3 æ•°æ®å®Œæ•´æ€§éªŒè¯](#33-æ•°æ®å®Œæ•´æ€§éªŒè¯)
  - [4. åŠ å¯†æ€§èƒ½åˆ†æ](#4-åŠ å¯†æ€§èƒ½åˆ†æ)
    - [4.1 åŠ å¯†æ€§èƒ½æµ‹è¯•](#41-åŠ å¯†æ€§èƒ½æµ‹è¯•)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ•°æ®åŠ å¯†æ¦‚è¿°

**æ•°æ®åŠ å¯†**ä¿æŠ¤æ•°æ®çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ•°æ®å®‰å…¨çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

### åŠ å¯†ç±»å‹

| ç±»å‹ | ç‰¹ç‚¹ | åº”ç”¨åœºæ™¯ |
|------|------|---------|
| **å¯¹ç§°åŠ å¯†** | åŠ å¯†è§£å¯†ä½¿ç”¨åŒä¸€å¯†é’¥ | å¤§æ•°æ®é‡åŠ å¯† |
| **éå¯¹ç§°åŠ å¯†** | å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯† | å¯†é’¥äº¤æ¢ã€æ•°å­—ç­¾å |
| **å“ˆå¸Œå‡½æ•°** | å•å‘å‡½æ•°ï¼Œä¸å¯é€† | å¯†ç å­˜å‚¨ã€æ•°æ®å®Œæ•´æ€§ |

---

## 1. å¯¹ç§°åŠ å¯†

### 1.1 AESåŠ å¯†

**AESï¼ˆAdvanced Encryption Standardï¼‰**æ˜¯å¸¸ç”¨çš„å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚

**å¯†é’¥é•¿åº¦**ï¼š128ä½ã€192ä½ã€256ä½

```sql
-- æ•°æ®åŠ å¯†å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥pgcryptoæ‰©å±•
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
            RAISE WARNING 'pgcryptoæ‰©å±•ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…: CREATE EXTENSION pgcrypto;';
        ELSE
            RAISE NOTICE 'pgcryptoæ‰©å±•å·²å®‰è£…';
        END IF;

        -- åˆ›å»ºæ•æ„Ÿæ•°æ®è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sensitive_table') THEN
            DROP TABLE sensitive_table CASCADE;
        END IF;

        CREATE TABLE sensitive_table (
            id SERIAL PRIMARY KEY,
            sensitive_data TEXT NOT NULL,
            encrypted_data BYTEA,
            encryption_key TEXT DEFAULT 'my_secret_key_12345'  -- å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å®‰å…¨çš„å¯†é’¥ç®¡ç†
        );

        -- æ’å…¥ç¤ºä¾‹æ•æ„Ÿæ•°æ®
        INSERT INTO sensitive_table (sensitive_data) VALUES
            ('Credit Card: 1234-5678-9012-3456'),
            ('SSN: 123-45-6789'),
            ('Password: MySecret123'),
            ('Email: user@example.com');

        RAISE NOTICE 'æ•æ„Ÿæ•°æ®è¡¨åˆ›å»ºæˆåŠŸï¼Œå…± % æ¡è®°å½•', (SELECT COUNT(*) FROM sensitive_table);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- AESåŠ å¯†ï¼šä½¿ç”¨pgcryptoæ‰©å±•
-- æ³¨æ„ï¼šéœ€è¦å…ˆå®‰è£…æ‰©å±• CREATE EXTENSION IF NOT EXISTS pgcrypto;
UPDATE sensitive_table
SET encrypted_data = encrypt(
    sensitive_data::bytea,
    encryption_key::bytea,
    'aes'
)
WHERE encrypted_data IS NULL;

-- æŸ¥çœ‹åŠ å¯†ç»“æœ
SELECT
    id,
    sensitive_data,
    encrypted_data,
    LENGTH(encrypted_data) AS encrypted_length,
    encode(encrypted_data, 'hex') AS encrypted_hex
FROM sensitive_table
LIMIT 5;

-- AESè§£å¯†
SELECT
    id,
    sensitive_data AS original_data,
    decrypt(encrypted_data, encryption_key::bytea, 'aes')::TEXT AS decrypted_data,
    CASE
        WHEN decrypt(encrypted_data, encryption_key::bytea, 'aes')::TEXT = sensitive_data
        THEN 'Decryption successful âœ“'
        ELSE 'Decryption failed âœ—'
    END AS decryption_status
FROM sensitive_table
WHERE encrypted_data IS NOT NULL
LIMIT 5;
```

### 1.2 åŠ å¯†å‡½æ•°å°è£…

```sql
-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(
    p_data TEXT,
    p_key TEXT DEFAULT 'default_key'
)
RETURNS BYTEA AS $$
BEGIN
    -- æ£€æŸ¥æ‰©å±•
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
        RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…';
    END IF;

    RETURN encrypt(p_data::bytea, p_key::bytea, 'aes');
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åŠ å¯†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- åˆ›å»ºè§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(
    p_encrypted_data BYTEA,
    p_key TEXT DEFAULT 'default_key'
)
RETURNS TEXT AS $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto') THEN
        RAISE EXCEPTION 'pgcryptoæ‰©å±•æœªå®‰è£…';
    END IF;

    RETURN decrypt(p_encrypted_data, p_key::bytea, 'aes')::TEXT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è§£å¯†å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ä½¿ç”¨åŠ å¯†å‡½æ•°
SELECT
    id,
    encrypt_sensitive_data(sensitive_data, encryption_key) AS encrypted,
    decrypt_sensitive_data(
        encrypt_sensitive_data(sensitive_data, encryption_key),
        encryption_key
    ) AS decrypted
FROM sensitive_table
LIMIT 3;
```

---

## 2. éå¯¹ç§°åŠ å¯†

### 2.1 RSAåŠ å¯†

**RSAåŠ å¯†**ä½¿ç”¨å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯†ã€‚

```sql
-- RSAå¯†é’¥å¯¹ç”Ÿæˆï¼ˆç®€åŒ–ï¼šä½¿ç”¨pgcryptoï¼‰
-- æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†å·¥å…·
DO $$
DECLARE
    public_key TEXT;
    private_key TEXT;
BEGIN
    BEGIN
        -- ç”ŸæˆRSAå¯†é’¥å¯¹ï¼ˆç®€åŒ–å®ç°ï¼‰
        -- å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨opensslæˆ–ä¸“é—¨çš„å¯†é’¥ç®¡ç†å·¥å…·
        RAISE NOTICE 'RSAå¯†é’¥å¯¹ç”Ÿæˆéœ€è¦å¤–éƒ¨å·¥å…·ï¼Œè¿™é‡Œä»…æ¼”ç¤ºæ¦‚å¿µ';

        -- ç¤ºä¾‹ï¼šå­˜å‚¨å…¬é’¥å’Œç§é’¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”å®‰å…¨å­˜å‚¨ï¼‰
        CREATE TABLE IF NOT EXISTS rsa_keys (
            key_id SERIAL PRIMARY KEY,
            public_key TEXT NOT NULL,
            private_key TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        RAISE NOTICE 'RSAå¯†é’¥è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'RSAå¯†é’¥ç”Ÿæˆå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- RSAåŠ å¯†ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰
-- å®é™…å®ç°éœ€è¦ä½¿ç”¨pgcryptoçš„pgp_pub_encryptå‡½æ•°
SELECT
    'RSA encryption requires pgcrypto extension and proper key management' AS note;
```

---

## 3. å“ˆå¸Œå‡½æ•°

### 3.1 MD5å’ŒSHAå“ˆå¸Œ

**å“ˆå¸Œå‡½æ•°**ç”¨äºå¯†ç å­˜å‚¨å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯ã€‚

```sql
-- å“ˆå¸Œå‡½æ•°ï¼šMD5å’ŒSHA
WITH hash_examples AS (
    SELECT
        'password123' AS plaintext,
        md5('password123') AS md5_hash,
        encode(digest('password123', 'sha1'), 'hex') AS sha1_hash,
        encode(digest('password123', 'sha256'), 'hex') AS sha256_hash
)
SELECT
    plaintext,
    md5_hash,
    sha1_hash,
    LEFT(sha256_hash, 32) AS sha256_hash_short,
    LENGTH(md5_hash) AS md5_length,
    LENGTH(sha1_hash) AS sha1_length,
    LENGTH(sha256_hash) AS sha256_length
FROM hash_examples;
```

### 3.2 å¯†ç å­˜å‚¨æœ€ä½³å®è·µ

```sql
-- å¯†ç å­˜å‚¨ï¼šä½¿ç”¨åŠ ç›å“ˆå¸Œ
CREATE OR REPLACE FUNCTION hash_password(
    p_password TEXT,
    p_salt TEXT DEFAULT NULL
)
RETURNS TEXT AS $$
DECLARE
    salt_value TEXT;
    hashed_password TEXT;
BEGIN
    -- ç”Ÿæˆéšæœºç›ï¼ˆå¦‚æœæœªæä¾›ï¼‰
    IF p_salt IS NULL THEN
        salt_value := encode(gen_random_bytes(16), 'hex');
    ELSE
        salt_value := p_salt;
    END IF;

    -- ä½¿ç”¨SHA-256åŠ ç›å“ˆå¸Œ
    hashed_password := encode(
        digest(p_password || salt_value, 'sha256'),
        'hex'
    );

    -- è¿”å›ï¼šç›:å“ˆå¸Œå€¼ï¼ˆä¾¿äºå­˜å‚¨å’ŒéªŒè¯ï¼‰
    RETURN salt_value || ':' || hashed_password;
END;
$$ LANGUAGE plpgsql;

-- å¯†ç éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION verify_password(
    p_password TEXT,
    p_stored_hash TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    salt_part TEXT;
    hash_part TEXT;
    computed_hash TEXT;
BEGIN
    -- åˆ†ç¦»ç›å’Œå“ˆå¸Œå€¼
    salt_part := SPLIT_PART(p_stored_hash, ':', 1);
    hash_part := SPLIT_PART(p_stored_hash, ':', 2);

    -- è®¡ç®—å“ˆå¸Œå€¼
    computed_hash := encode(
        digest(p_password || salt_part, 'sha256'),
        'hex'
    );

    -- æ¯”è¾ƒå“ˆå¸Œå€¼
    RETURN computed_hash = hash_part;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨å¯†ç å“ˆå¸Œå‡½æ•°
WITH password_test AS (
    SELECT
        'MySecurePassword123' AS password,
        hash_password('MySecurePassword123') AS stored_hash
)
SELECT
    password,
    stored_hash,
    verify_password('MySecurePassword123', stored_hash) AS verification_result,
    verify_password('WrongPassword', stored_hash) AS wrong_password_result
FROM password_test;
```

### 3.3 æ•°æ®å®Œæ•´æ€§éªŒè¯

```sql
-- æ•°æ®å®Œæ•´æ€§ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹
CREATE OR REPLACE FUNCTION compute_data_hash(
    p_data TEXT
)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(digest(p_data, 'sha256'), 'hex');
END;
$$ LANGUAGE plpgsql;

-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
WITH data_integrity_check AS (
    SELECT
        id,
        sensitive_data,
        compute_data_hash(sensitive_data) AS data_hash,
        -- æ¨¡æ‹Ÿå­˜å‚¨çš„å“ˆå¸Œå€¼
        compute_data_hash(sensitive_data) AS stored_hash
    FROM sensitive_table
)
SELECT
    id,
    LEFT(data_hash, 16) AS data_hash_short,
    LEFT(stored_hash, 16) AS stored_hash_short,
    CASE
        WHEN data_hash = stored_hash THEN 'Data integrity verified âœ“'
        ELSE 'Data integrity check failed âœ—'
    END AS integrity_status
FROM data_integrity_check
LIMIT 5;
```

---

## 4. åŠ å¯†æ€§èƒ½åˆ†æ

### 4.1 åŠ å¯†æ€§èƒ½æµ‹è¯•

```sql
-- åŠ å¯†æ€§èƒ½æµ‹è¯•
DO $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    elapsed INTERVAL;
    test_data TEXT := 'This is a test data for encryption performance testing';
    encrypted_result BYTEA;
BEGIN
    start_time := clock_timestamp();

    -- æ‰§è¡Œ100æ¬¡åŠ å¯†
    FOR i IN 1..100 LOOP
        encrypted_result := encrypt(test_data::bytea, 'test_key'::bytea, 'aes');
    END LOOP;

    end_time := clock_timestamp();
    elapsed := end_time - start_time;

    RAISE NOTICE 'AESåŠ å¯†100æ¬¡ï¼Œè€—æ—¶: %', elapsed;
    RAISE NOTICE 'å¹³å‡æ¯æ¬¡åŠ å¯†è€—æ—¶: %', elapsed / 100;
END $$;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Stallings, W. (2017)**: "Cryptography and Network Security: Principles and Practice", 7th Edition
2. **Menezes, A.J., et al. (2018)**: "Handbook of Applied Cryptography"

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡
2. **åŠ å¯†ç®—æ³•é€‰æ‹©**ï¼šæ ¹æ®æ€§èƒ½å’Œå®‰å…¨éœ€æ±‚é€‰æ‹©ç®—æ³•
3. **æ‰¹é‡åŠ å¯†**ï¼šæ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
4. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜å¸¸ç”¨åŠ å¯†ç»“æœ

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **å¯†é’¥å®‰å…¨**ï¼šå®‰å…¨å­˜å‚¨å’Œç®¡ç†åŠ å¯†å¯†é’¥
2. **å¯†ç ç­–ç•¥**ï¼šä½¿ç”¨åŠ ç›å“ˆå¸Œå­˜å‚¨å¯†ç 
3. **æ•°æ®åˆ†ç±»**ï¼šæ ¹æ®æ•æ„Ÿåº¦é€‰æ‹©åŠ å¯†çº§åˆ«
4. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°åŠ å¯†å¯†é’¥å’Œç®—æ³•

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
