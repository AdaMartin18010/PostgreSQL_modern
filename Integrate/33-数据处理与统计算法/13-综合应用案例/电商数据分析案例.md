# PostgreSQL ç”µå•†æ•°æ®åˆ†æç»¼åˆæ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç”µå•†åˆ†æ | ç»¼åˆåº”ç”¨
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç”µå•†æ•°æ®åˆ†æç»¼åˆæ¡ˆä¾‹](#postgresql-ç”µå•†æ•°æ®åˆ†æç»¼åˆæ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¡ˆä¾‹æ¦‚è¿°](#æ¡ˆä¾‹æ¦‚è¿°)
  - [1. æ•°æ®å‡†å¤‡](#1-æ•°æ®å‡†å¤‡)
  - [2. é”€å”®åˆ†æ](#2-é”€å”®åˆ†æ)
  - [3. ç”¨æˆ·è¡Œä¸ºåˆ†æ](#3-ç”¨æˆ·è¡Œä¸ºåˆ†æ)
  - [4. å•†å“åˆ†æ](#4-å•†å“åˆ†æ)
  - [5. ç»¼åˆæŠ¥è¡¨](#5-ç»¼åˆæŠ¥è¡¨)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹ç»¼åˆè¿ç”¨å¤šç§SQLç®—æ³•å’ŒæŠ€æœ¯ï¼Œå¯¹ç”µå•†æ•°æ®è¿›è¡Œå…¨é¢åˆ†æï¼ŒåŒ…æ‹¬é”€å”®ç»Ÿè®¡ã€ç”¨æˆ·è¡Œä¸ºã€å•†å“åˆ†æç­‰ã€‚

---

## 1. æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºç”µå•†æ•°æ®åº“è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºç”¨æˆ·è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            DROP TABLE users CASCADE;
        END IF;

        CREATE TABLE users (
            user_id SERIAL PRIMARY KEY,
            username VARCHAR(50) NOT NULL,
            email VARCHAR(100) UNIQUE,
            registration_date DATE NOT NULL,
            city VARCHAR(50)
        );

        -- åˆ›å»ºå•†å“è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            DROP TABLE products CASCADE;
        END IF;

        CREATE TABLE products (
            product_id SERIAL PRIMARY KEY,
            product_name VARCHAR(100) NOT NULL,
            category VARCHAR(50) NOT NULL,
            price NUMERIC(10, 2) NOT NULL,
            stock_quantity INTEGER NOT NULL
        );

        -- åˆ›å»ºè®¢å•è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            DROP TABLE orders CASCADE;
        END IF;

        CREATE TABLE orders (
            order_id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL,
            order_date DATE NOT NULL,
            total_amount NUMERIC(10, 2) NOT NULL,
            status VARCHAR(20) NOT NULL,
            FOREIGN KEY (user_id) REFERENCES users(user_id)
        );

        -- åˆ›å»ºè®¢å•æ˜ç»†è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'order_items') THEN
            DROP TABLE order_items CASCADE;
        END IF;

        CREATE TABLE order_items (
            item_id SERIAL PRIMARY KEY,
            order_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            quantity INTEGER NOT NULL,
            unit_price NUMERIC(10, 2) NOT NULL,
            FOREIGN KEY (order_id) REFERENCES orders(order_id),
            FOREIGN KEY (product_id) REFERENCES products(product_id)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO users (username, email, registration_date, city) VALUES
            ('user1', 'user1@example.com', '2023-01-15', 'Beijing'),
            ('user2', 'user2@example.com', '2023-02-20', 'Shanghai'),
            ('user3', 'user3@example.com', '2023-03-10', 'Guangzhou'),
            ('user4', 'user4@example.com', '2023-04-05', 'Shenzhen'),
            ('user5', 'user5@example.com', '2023-05-12', 'Beijing');

        INSERT INTO products (product_name, category, price, stock_quantity) VALUES
            ('Laptop', 'Electronics', 5999.00, 50),
            ('Smartphone', 'Electronics', 3999.00, 100),
            ('Tablet', 'Electronics', 2999.00, 30),
            ('Headphones', 'Electronics', 299.00, 200),
            ('Keyboard', 'Electronics', 199.00, 150);

        INSERT INTO orders (user_id, order_date, total_amount, status) VALUES
            (1, '2024-01-01', 9998.00, 'completed'),
            (1, '2024-01-15', 299.00, 'completed'),
            (2, '2024-01-05', 3999.00, 'completed'),
            (2, '2024-01-20', 2999.00, 'pending'),
            (3, '2024-01-10', 5999.00, 'completed'),
            (4, '2024-01-12', 199.00, 'completed'),
            (5, '2024-01-18', 3298.00, 'completed');

        INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES
            (1, 1, 1, 5999.00), (1, 2, 1, 3999.00),
            (2, 4, 1, 299.00),
            (3, 2, 1, 3999.00),
            (4, 3, 1, 2999.00),
            (5, 1, 1, 5999.00),
            (6, 5, 1, 199.00),
            (7, 2, 1, 3999.00), (7, 4, 1, 299.00);

        RAISE NOTICE 'ç”µå•†æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 2. é”€å”®åˆ†æ

```sql
-- é”€å”®åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œé”€å”®åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œé”€å”®åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é”€å”®åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æœˆåº¦é”€å”®ç»Ÿè®¡
SELECT
    DATE_TRUNC('month', order_date) AS month,
    COUNT(*) AS order_count,
    COUNT(DISTINCT user_id) AS unique_customers,
    SUM(total_amount) AS total_revenue,
    AVG(total_amount) AS avg_order_value,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_amount) AS median_order_value
FROM orders
WHERE status = 'completed'
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;

-- é”€å”®è¶‹åŠ¿åˆ†æï¼ˆç§»åŠ¨å¹³å‡ï¼‰
WITH monthly_sales AS (
    SELECT
        DATE_TRUNC('month', order_date) AS month,
        SUM(total_amount) AS monthly_revenue
    FROM orders
    WHERE status = 'completed'
    GROUP BY DATE_TRUNC('month', order_date)
)
SELECT
    month,
    monthly_revenue,
    AVG(monthly_revenue) OVER (
        ORDER BY month
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg_3months
FROM monthly_sales
ORDER BY month;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('month', order_date) AS month,
    SUM(total_amount) AS total_revenue
FROM orders
WHERE status = 'completed'
GROUP BY DATE_TRUNC('month', order_date);
```

---

## 3. ç”¨æˆ·è¡Œä¸ºåˆ†æ

```sql
-- ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·è¡Œä¸ºåˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·è¡Œä¸ºåˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·è¡Œä¸ºåˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·ä»·å€¼åˆ†æï¼ˆRFMæ¨¡å‹ç®€åŒ–ç‰ˆï¼‰
WITH user_metrics AS (
    SELECT
        u.user_id,
        u.username,
        COUNT(DISTINCT o.order_id) AS frequency,
        SUM(o.total_amount) AS monetary_value,
        MAX(o.order_date) AS last_order_date,
        CURRENT_DATE - MAX(o.order_date) AS recency_days
    FROM users u
    LEFT JOIN orders o ON u.user_id = o.user_id AND o.status = 'completed'
    GROUP BY u.user_id, u.username
)
SELECT
    user_id,
    username,
    frequency,
    ROUND(monetary_value::numeric, 2) AS monetary_value,
    recency_days,
    CASE
        WHEN recency_days <= 30 THEN 'Active'
        WHEN recency_days <= 90 THEN 'At Risk'
        ELSE 'Inactive'
    END AS customer_segment
FROM user_metrics
ORDER BY monetary_value DESC NULLS LAST;

-- ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†æ
WITH user_purchase_patterns AS (
    SELECT
        u.user_id,
        u.username,
        COUNT(DISTINCT o.order_id) AS total_orders,
        SUM(o.total_amount) AS total_spent,
        AVG(o.total_amount) AS avg_order_value,
        COUNT(DISTINCT oi.product_id) AS unique_products_purchased,
        COUNT(oi.item_id) AS total_items_purchased
    FROM users u
    LEFT JOIN orders o ON u.user_id = o.user_id AND o.status = 'completed'
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY u.user_id, u.username
)
SELECT
    user_id,
    username,
    total_orders,
    ROUND(total_spent::numeric, 2) AS total_spent,
    ROUND(avg_order_value::numeric, 2) AS avg_order_value,
    unique_products_purchased,
    total_items_purchased,
    ROUND((total_spent / NULLIF(total_orders, 0))::numeric, 2) AS value_per_order
FROM user_purchase_patterns
ORDER BY total_spent DESC NULLS LAST;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    u.user_id,
    COUNT(DISTINCT o.order_id) AS total_orders,
    SUM(o.total_amount) AS total_spent
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id AND o.status = 'completed'
GROUP BY u.user_id;
```

---

## 4. å•†å“åˆ†æ

```sql
-- å•†å“åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'order_items') THEN
            RAISE WARNING 'è¡¨ order_items ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå•†å“åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œå•†å“åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å•†å“åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å•†å“é”€å”®æ’è¡Œ
SELECT
    p.product_id,
    p.product_name,
    p.category,
    COUNT(DISTINCT oi.order_id) AS order_count,
    SUM(oi.quantity) AS total_quantity_sold,
    SUM(oi.quantity * oi.unit_price) AS total_revenue,
    AVG(oi.unit_price) AS avg_price,
    RANK() OVER (ORDER BY SUM(oi.quantity * oi.unit_price) DESC) AS revenue_rank
FROM products p
LEFT JOIN order_items oi ON p.product_id = oi.product_id
LEFT JOIN orders o ON oi.order_id = o.order_id AND o.status = 'completed'
GROUP BY p.product_id, p.product_name, p.category
ORDER BY total_revenue DESC NULLS LAST;

-- ç±»åˆ«é”€å”®åˆ†æ
SELECT
    p.category,
    COUNT(DISTINCT p.product_id) AS product_count,
    COUNT(DISTINCT oi.order_id) AS order_count,
    SUM(oi.quantity) AS total_quantity_sold,
    SUM(oi.quantity * oi.unit_price) AS category_revenue,
    AVG(oi.unit_price) AS avg_category_price,
    ROUND((SUM(oi.quantity * oi.unit_price) / NULLIF(SUM(SUM(oi.quantity * oi.unit_price)) OVER (), 0) * 100)::numeric, 2) AS revenue_percentage
FROM products p
LEFT JOIN order_items oi ON p.product_id = oi.product_id
LEFT JOIN orders o ON oi.order_id = o.order_id AND o.status = 'completed'
GROUP BY p.category
ORDER BY category_revenue DESC NULLS LAST;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    p.category,
    SUM(oi.quantity * oi.unit_price) AS category_revenue
FROM products p
LEFT JOIN order_items oi ON p.product_id = oi.product_id
GROUP BY p.category;
```

---

## 5. ç»¼åˆæŠ¥è¡¨

```sql
-- ç»¼åˆæŠ¥è¡¨ç”Ÿæˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆç»¼åˆæŠ¥è¡¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆç»¼åˆæŠ¥è¡¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆæŠ¥è¡¨ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”µå•†æ•°æ®ç»¼åˆæŠ¥è¡¨
WITH sales_summary AS (
    SELECT
        COUNT(DISTINCT o.order_id) AS total_orders,
        COUNT(DISTINCT o.user_id) AS total_customers,
        SUM(o.total_amount) AS total_revenue,
        AVG(o.total_amount) AS avg_order_value
    FROM orders o
    WHERE o.status = 'completed'
),
product_summary AS (
    SELECT
        COUNT(DISTINCT p.product_id) AS total_products,
        COUNT(DISTINCT p.category) AS total_categories,
        SUM(oi.quantity) AS total_items_sold
    FROM products p
    LEFT JOIN order_items oi ON p.product_id = oi.product_id
    LEFT JOIN orders o ON oi.order_id = o.order_id AND o.status = 'completed'
),
user_summary AS (
    SELECT
        COUNT(*) AS total_users,
        COUNT(*) FILTER (WHERE EXISTS (
            SELECT 1 FROM orders WHERE user_id = users.user_id AND status = 'completed'
        )) AS active_users
    FROM users
)
SELECT
    'Sales Metrics' AS metric_category,
    ss.total_orders AS metric_value,
    'Total Orders' AS metric_name
FROM sales_summary ss
UNION ALL
SELECT
    'Sales Metrics',
    ss.total_customers,
    'Total Customers'
FROM sales_summary ss
UNION ALL
SELECT
    'Sales Metrics',
    ROUND(ss.total_revenue::numeric, 2),
    'Total Revenue'
FROM sales_summary ss
UNION ALL
SELECT
    'Product Metrics',
    ps.total_products,
    'Total Products'
FROM product_summary ps
UNION ALL
SELECT
    'Product Metrics',
    ps.total_items_sold,
    'Total Items Sold'
FROM product_summary ps
UNION ALL
SELECT
    'User Metrics',
    us.total_users,
    'Total Users'
FROM user_summary us
UNION ALL
SELECT
    'User Metrics',
    us.active_users,
    'Active Users'
FROM user_summary us
ORDER BY metric_category, metric_name;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(DISTINCT order_id) AS total_orders,
    SUM(total_amount) AS total_revenue
FROM orders
WHERE status = 'completed';
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨order_date, user_id, product_idä¸Šåˆ›å»ºç´¢å¼•
2. **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒºè®¢å•è¡¨
3. **ç‰©åŒ–è§†å›¾**: å¯¹å¸¸ç”¨æŠ¥è¡¨åˆ›å»ºç‰©åŒ–è§†å›¾

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
2. **å®šæœŸæ›´æ–°**: å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
3. **ç¼“å­˜**: ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
4. **ç›‘æ§**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
