# PostgreSQL ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç”¨æˆ·è¡Œä¸º | æ•°æ®åˆ†æ
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹](#postgresql-ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¡ˆä¾‹æ¦‚è¿°](#æ¡ˆä¾‹æ¦‚è¿°)
  - [1. æ•°æ®å‡†å¤‡](#1-æ•°æ®å‡†å¤‡)
  - [2. ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ](#2-ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ)
  - [3. ç”¨æˆ·è·¯å¾„åˆ†æ](#3-ç”¨æˆ·è·¯å¾„åˆ†æ)
  - [4. ç”¨æˆ·ç•™å­˜åˆ†æ](#4-ç”¨æˆ·ç•™å­˜åˆ†æ)
  - [5. ç”¨æˆ·åˆ†ç¾¤åˆ†æ](#5-ç”¨æˆ·åˆ†ç¾¤åˆ†æ)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹ç»¼åˆè¿ç”¨çª—å£å‡½æ•°ã€èšåˆç®—æ³•ã€æ—¶é—´åºåˆ—åˆ†æç­‰æŠ€æœ¯ï¼Œå¯¹ç”¨æˆ·è¡Œä¸ºæ•°æ®è¿›è¡Œæ·±å…¥åˆ†æã€‚

---

## 1. æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºç”¨æˆ·è¡Œä¸ºæ•°æ®è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE user_events CASCADE;
        END IF;

        CREATE TABLE user_events (
            event_id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL,
            event_type VARCHAR(50) NOT NULL,
            event_timestamp TIMESTAMP NOT NULL,
            page_url VARCHAR(200),
            session_id VARCHAR(100),
            device_type VARCHAR(20),
            duration_seconds INTEGER
        );

        -- æ’å…¥ç¤ºä¾‹ç”¨æˆ·è¡Œä¸ºæ•°æ®
        INSERT INTO user_events (user_id, event_type, event_timestamp, page_url, session_id, device_type, duration_seconds) VALUES
            (1, 'page_view', '2024-01-01 10:00:00', '/home', 'session_001', 'desktop', 30),
            (1, 'page_view', '2024-01-01 10:00:30', '/products', 'session_001', 'desktop', 45),
            (1, 'click', '2024-01-01 10:01:15', '/products/item1', 'session_001', 'desktop', NULL),
            (1, 'page_view', '2024-01-01 10:01:20', '/products/item1', 'session_001', 'desktop', 120),
            (1, 'purchase', '2024-01-01 10:03:20', '/checkout', 'session_001', 'desktop', NULL),
            (2, 'page_view', '2024-01-01 11:00:00', '/home', 'session_002', 'mobile', 20),
            (2, 'page_view', '2024-01-01 11:00:20', '/products', 'session_002', 'mobile', 30),
            (2, 'page_view', '2024-01-02 10:00:00', '/home', 'session_003', 'mobile', 25),
            (3, 'page_view', '2024-01-01 12:00:00', '/home', 'session_004', 'desktop', 40),
            (3, 'page_view', '2024-01-01 12:00:40', '/products', 'session_004', 'desktop', 60),
            (3, 'click', '2024-01-01 12:01:40', '/products/item2', 'session_004', 'desktop', NULL),
            (4, 'page_view', '2024-01-01 13:00:00', '/home', 'session_005', 'mobile', 15),
            (4, 'page_view', '2024-01-01 13:00:15', '/products', 'session_005', 'mobile', 20),
            (5, 'page_view', '2024-01-01 14:00:00', '/home', 'session_006', 'desktop', 50),
            (5, 'purchase', '2024-01-01 14:00:50', '/checkout', 'session_006', 'desktop', NULL);

        RAISE NOTICE 'ç”¨æˆ·è¡Œä¸ºæ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 2. ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ

```sql
-- ç”¨æˆ·æ´»è·ƒåº¦åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·æ´»è·ƒåº¦åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·æ´»è·ƒåº¦åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·æ´»è·ƒåº¦åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·æ—¥æ´»è·ƒåº¦ç»Ÿè®¡
SELECT
    DATE_TRUNC('day', event_timestamp) AS date,
    COUNT(DISTINCT user_id) AS daily_active_users,
    COUNT(DISTINCT session_id) AS daily_sessions,
    COUNT(*) AS total_events,
    AVG(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS avg_session_duration
FROM user_events
GROUP BY DATE_TRUNC('day', event_timestamp)
ORDER BY date;

-- ç”¨æˆ·æ´»è·ƒåº¦æ’è¡Œ
SELECT
    user_id,
    COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS active_days,
    COUNT(DISTINCT session_id) AS total_sessions,
    COUNT(*) AS total_events,
    SUM(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS total_duration,
    MAX(event_timestamp) AS last_active_time,
    CURRENT_TIMESTAMP - MAX(event_timestamp) AS days_since_last_active
FROM user_events
GROUP BY user_id
ORDER BY active_days DESC, total_events DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('day', event_timestamp) AS date,
    COUNT(DISTINCT user_id) AS daily_active_users
FROM user_events
GROUP BY DATE_TRUNC('day', event_timestamp);
```

---

## 3. ç”¨æˆ·è·¯å¾„åˆ†æ

```sql
-- ç”¨æˆ·è·¯å¾„åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·è·¯å¾„åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·è·¯å¾„åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·è·¯å¾„åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·ä¼šè¯è·¯å¾„åˆ†æ
WITH session_paths AS (
    SELECT
        session_id,
        user_id,
        page_url,
        event_type,
        event_timestamp,
        ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY event_timestamp) AS step_number,
        LAG(page_url) OVER (PARTITION BY session_id ORDER BY event_timestamp) AS previous_page
    FROM user_events
    WHERE event_type = 'page_view'
)
SELECT
    session_id,
    user_id,
    STRING_AGG(page_url, ' -> ' ORDER BY step_number) AS user_path,
    COUNT(*) AS path_length,
    MAX(CASE WHEN page_url = '/checkout' THEN 1 ELSE 0 END) AS reached_checkout
FROM session_paths
GROUP BY session_id, user_id
ORDER BY path_length DESC;

-- é¡µé¢æµè½¬åˆ†æ
WITH page_transitions AS (
    SELECT
        session_id,
        page_url AS from_page,
        LEAD(page_url) OVER (PARTITION BY session_id ORDER BY event_timestamp) AS to_page
    FROM user_events
    WHERE event_type = 'page_view'
)
SELECT
    from_page,
    to_page,
    COUNT(*) AS transition_count,
    ROUND((COUNT(*)::numeric / SUM(COUNT(*)) OVER (PARTITION BY from_page) * 100)::numeric, 2) AS transition_percentage
FROM page_transitions
WHERE to_page IS NOT NULL
GROUP BY from_page, to_page
ORDER BY transition_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    session_id,
    STRING_AGG(page_url, ' -> ' ORDER BY event_timestamp) AS user_path
FROM user_events
WHERE event_type = 'page_view'
GROUP BY session_id;
```

---

## 4. ç”¨æˆ·ç•™å­˜åˆ†æ

```sql
-- ç”¨æˆ·ç•™å­˜åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·ç•™å­˜åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·ç•™å­˜åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·ç•™å­˜åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·é¦–æ¬¡æ´»è·ƒæ—¥æœŸ
WITH user_first_active AS (
    SELECT
        user_id,
        MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
    FROM user_events
    GROUP BY user_id
),
daily_active_users AS (
    SELECT
        DATE_TRUNC('day', event_timestamp) AS active_date,
        user_id
    FROM user_events
    GROUP BY DATE_TRUNC('day', event_timestamp), user_id
),
retention_analysis AS (
    SELECT
        ufa.first_active_date AS cohort_date,
        dau.active_date,
        dau.active_date - ufa.first_active_date AS days_since_first,
        COUNT(DISTINCT dau.user_id) AS retained_users
    FROM user_first_active ufa
    JOIN daily_active_users dau ON ufa.user_id = dau.user_id
    GROUP BY ufa.first_active_date, dau.active_date
)
SELECT
    cohort_date,
    active_date,
    days_since_first,
    retained_users,
    (SELECT COUNT(DISTINCT user_id) FROM user_first_active WHERE first_active_date = cohort_date) AS cohort_size,
    ROUND((retained_users::numeric / NULLIF((SELECT COUNT(DISTINCT user_id) FROM user_first_active WHERE first_active_date = cohort_date), 0) * 100)::numeric, 2) AS retention_rate
FROM retention_analysis
ORDER BY cohort_date, days_since_first;

-- ç®€åŒ–ç‰ˆç•™å­˜ç‡è®¡ç®—
WITH user_first_active AS (
    SELECT
        user_id,
        MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
    FROM user_events
    GROUP BY user_id
),
retention_by_day AS (
    SELECT
        ufa.first_active_date,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date THEN ue.user_id END) AS day_0_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '1 day' THEN ue.user_id END) AS day_1_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '7 days' THEN ue.user_id END) AS day_7_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '30 days' THEN ue.user_id END) AS day_30_users
    FROM user_first_active ufa
    LEFT JOIN user_events ue ON ufa.user_id = ue.user_id
    GROUP BY ufa.first_active_date
)
SELECT
    first_active_date AS cohort_date,
    day_0_users,
    day_1_users,
    ROUND((day_1_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_1_retention_rate,
    day_7_users,
    ROUND((day_7_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_7_retention_rate,
    day_30_users,
    ROUND((day_30_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_30_retention_rate
FROM retention_by_day
ORDER BY first_active_date;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
FROM user_events
GROUP BY user_id;
```

---

## 5. ç”¨æˆ·åˆ†ç¾¤åˆ†æ

```sql
-- ç”¨æˆ·åˆ†ç¾¤åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·åˆ†ç¾¤åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·åˆ†ç¾¤åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·åˆ†ç¾¤åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºè¡Œä¸ºçš„ç”¨æˆ·åˆ†ç¾¤ï¼ˆRFMæ¨¡å‹ç®€åŒ–ç‰ˆï¼‰
WITH user_metrics AS (
    SELECT
        user_id,
        COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS frequency,
        MAX(event_timestamp) AS last_active_time,
        CURRENT_TIMESTAMP - MAX(event_timestamp) AS recency_days,
        COUNT(DISTINCT session_id) AS session_count,
        SUM(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS total_duration,
        COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count
    FROM user_events
    GROUP BY user_id
),
user_segments AS (
    SELECT
        user_id,
        frequency,
        recency_days,
        session_count,
        total_duration,
        purchase_count,
        CASE
            WHEN recency_days <= INTERVAL '7 days' AND frequency >= 5 THEN 'Champion'
            WHEN recency_days <= INTERVAL '30 days' AND frequency >= 3 THEN 'Loyal'
            WHEN recency_days <= INTERVAL '7 days' AND frequency < 3 THEN 'New'
            WHEN recency_days > INTERVAL '30 days' AND frequency >= 3 THEN 'At Risk'
            ELSE 'Inactive'
        END AS user_segment
    FROM user_metrics
)
SELECT
    user_segment,
    COUNT(*) AS user_count,
    ROUND(AVG(frequency)::numeric, 2) AS avg_frequency,
    ROUND(AVG(EXTRACT(EPOCH FROM recency_days))::numeric, 2) AS avg_recency_days,
    ROUND(AVG(session_count)::numeric, 2) AS avg_sessions,
    ROUND(AVG(total_duration)::numeric, 2) AS avg_duration,
    SUM(purchase_count) AS total_purchases
FROM user_segments
GROUP BY user_segment
ORDER BY user_count DESC;

-- è®¾å¤‡ç±»å‹ç”¨æˆ·åˆ†ç¾¤
SELECT
    device_type,
    COUNT(DISTINCT user_id) AS user_count,
    COUNT(DISTINCT session_id) AS session_count,
    AVG(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS avg_session_duration,
    COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count,
    ROUND((COUNT(*) FILTER (WHERE event_type = 'purchase')::numeric / COUNT(*) * 100)::numeric, 2) AS conversion_rate
FROM user_events
WHERE device_type IS NOT NULL
GROUP BY device_type
ORDER BY user_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS frequency,
    MAX(event_timestamp) AS last_active_time
FROM user_events
GROUP BY user_id;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨user_id, event_timestamp, session_idä¸Šåˆ›å»ºç´¢å¼•
2. **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒºäº‹ä»¶è¡¨
3. **ç‰©åŒ–è§†å›¾**: å¯¹å¸¸ç”¨ç»Ÿè®¡åˆ›å»ºç‰©åŒ–è§†å›¾

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•°æ®è´¨é‡**: ç¡®ä¿äº‹ä»¶æ•°æ®å®Œæ•´å‡†ç¡®
2. **å®æ—¶åˆ†æ**: æ”¯æŒå®æ—¶å’Œæ‰¹é‡åˆ†æ
3. **éšç§ä¿æŠ¤**: æ³¨æ„ç”¨æˆ·éšç§æ•°æ®ä¿æŠ¤
4. **æ€§èƒ½ç›‘æ§**: ç›‘æ§åˆ†ææŸ¥è¯¢æ€§èƒ½

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
