# PostgreSQL ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç”¨æˆ·è¡Œä¸º | æ•°æ®åˆ†æ
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹](#postgresql-ç”¨æˆ·è¡Œä¸ºåˆ†æç»¼åˆæ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¡ˆä¾‹æ¦‚è¿°](#æ¡ˆä¾‹æ¦‚è¿°)
  - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
    - [ç”¨æˆ·è¡Œä¸ºåˆ†æé—®é¢˜å®šä¹‰](#ç”¨æˆ·è¡Œä¸ºåˆ†æé—®é¢˜å®šä¹‰)
    - [æ ¸å¿ƒåˆ†æç»´åº¦](#æ ¸å¿ƒåˆ†æç»´åº¦)
    - [åˆ†ææ–¹æ³•åˆ†ç±»](#åˆ†ææ–¹æ³•åˆ†ç±»)
    - [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
  - [1. æ•°æ®å‡†å¤‡](#1-æ•°æ®å‡†å¤‡)
  - [2. ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ](#2-ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ)
  - [3. ç”¨æˆ·è·¯å¾„åˆ†æ](#3-ç”¨æˆ·è·¯å¾„åˆ†æ)
  - [4. ç”¨æˆ·ç•™å­˜åˆ†æ](#4-ç”¨æˆ·ç•™å­˜åˆ†æ)
  - [5. ç”¨æˆ·åˆ†ç¾¤åˆ†æ](#5-ç”¨æˆ·åˆ†ç¾¤åˆ†æ)
  - [6. è½¬åŒ–æ¼æ–—åˆ†æ](#6-è½¬åŒ–æ¼æ–—åˆ†æ)
  - [7. ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æ](#7-ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æ)
  - [8. ç”¨æˆ·ä»·å€¼åˆ†æ](#8-ç”¨æˆ·ä»·å€¼åˆ†æ)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [ç´¢å¼•ä¼˜åŒ–](#ç´¢å¼•ä¼˜åŒ–)
    - [åˆ†åŒºè¡¨](#åˆ†åŒºè¡¨)
    - [ç‰©åŒ–è§†å›¾](#ç‰©åŒ–è§†å›¾)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [æ•°æ®è´¨é‡](#æ•°æ®è´¨é‡)
    - [åˆ†æç­–ç•¥](#åˆ†æç­–ç•¥)
    - [éšç§ä¿æŠ¤](#éšç§ä¿æŠ¤)
    - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
    - [SQLå®ç°æ³¨æ„äº‹é¡¹](#sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“ˆ åˆ†ææ–¹æ³•å¯¹æ¯”](#-åˆ†ææ–¹æ³•å¯¹æ¯”)
  - [ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [é—®é¢˜1ï¼šç”¨æˆ·è¡Œä¸ºæ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢æ…¢](#é—®é¢˜1ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡å¤§æŸ¥è¯¢æ…¢)
    - [é—®é¢˜2ï¼šç•™å­˜ç‡è®¡ç®—ä¸å‡†ç¡®](#é—®é¢˜2ç•™å­˜ç‡è®¡ç®—ä¸å‡†ç¡®)
    - [é—®é¢˜3ï¼šç”¨æˆ·åˆ†ç¾¤æ•ˆæœä¸å¥½](#é—®é¢˜3ç”¨æˆ·åˆ†ç¾¤æ•ˆæœä¸å¥½)

---

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹ç»¼åˆè¿ç”¨çª—å£å‡½æ•°ã€èšåˆç®—æ³•ã€æ—¶é—´åºåˆ—åˆ†æç­‰æŠ€æœ¯ï¼Œå¯¹ç”¨æˆ·è¡Œä¸ºæ•°æ®è¿›è¡Œæ·±å…¥åˆ†æã€‚

## ç†è®ºåŸºç¡€

### ç”¨æˆ·è¡Œä¸ºåˆ†æé—®é¢˜å®šä¹‰

ç”¨æˆ·è¡Œä¸ºåˆ†ææ˜¯é€šè¿‡æ”¶é›†ã€å¤„ç†å’Œåˆ†æç”¨æˆ·åœ¨åº”ç”¨ç³»ç»Ÿä¸­çš„è¡Œä¸ºæ•°æ®ï¼Œä»¥äº†è§£ç”¨æˆ·è¡Œä¸ºæ¨¡å¼ã€ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€æå‡è½¬åŒ–ç‡å’Œå¢åŠ ç”¨æˆ·ä»·å€¼çš„è¿‡ç¨‹ã€‚

### æ ¸å¿ƒåˆ†æç»´åº¦

1. **ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ**ï¼š
   - æ—¥æ´»è·ƒç”¨æˆ·ï¼ˆDAUï¼‰
   - æœˆæ´»è·ƒç”¨æˆ·ï¼ˆMAUï¼‰
   - ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿
   - ç”¨æˆ·æ´»è·ƒåº¦åˆ†å¸ƒ

2. **ç”¨æˆ·è·¯å¾„åˆ†æ**ï¼š
   - ç”¨æˆ·è®¿é—®è·¯å¾„
   - é¡µé¢æµè½¬åˆ†æ
   - è½¬åŒ–æ¼æ–—åˆ†æ
   - å…³é”®è·¯å¾„è¯†åˆ«

3. **ç”¨æˆ·ç•™å­˜åˆ†æ**ï¼š
   - ç•™å­˜ç‡è®¡ç®—
   - ç•™å­˜ç‡è¶‹åŠ¿
   - åŒæœŸç¾¤åˆ†æ
   - æµå¤±ç”¨æˆ·åˆ†æ

4. **ç”¨æˆ·åˆ†ç¾¤åˆ†æ**ï¼š
   - RFMæ¨¡å‹åˆ†ç¾¤
   - è¡Œä¸ºç‰¹å¾åˆ†ç¾¤
   - ä»·å€¼åˆ†ç¾¤
   - ç”Ÿå‘½å‘¨æœŸåˆ†ç¾¤

### åˆ†ææ–¹æ³•åˆ†ç±»

1. **æè¿°æ€§åˆ†æ**ï¼šç»Ÿè®¡æ±‡æ€»ã€è¶‹åŠ¿åˆ†æã€åˆ†å¸ƒåˆ†æ
2. **è¯Šæ–­æ€§åˆ†æ**ï¼šè·¯å¾„åˆ†æã€è½¬åŒ–åˆ†æã€æµå¤±åˆ†æ
3. **é¢„æµ‹æ€§åˆ†æ**ï¼šç•™å­˜é¢„æµ‹ã€æµå¤±é¢„æµ‹ã€ä»·å€¼é¢„æµ‹
4. **è§„èŒƒæ€§åˆ†æ**ï¼šä¸ªæ€§åŒ–æ¨èã€ç²¾å‡†è¥é”€ã€ä½“éªŒä¼˜åŒ–

### æŠ€æœ¯æ ˆ

- **çª—å£å‡½æ•°**ï¼šROW_NUMBERã€RANKã€LAGã€LEADã€FIRST_VALUEã€LAST_VALUE
- **èšåˆç®—æ³•**ï¼šCOUNTã€SUMã€AVGã€GROUP BYã€FILTER
- **æ—¶é—´åºåˆ—åˆ†æ**ï¼šDATE_TRUNCã€æ»‘åŠ¨çª—å£ã€ç§»åŠ¨å¹³å‡
- **å…³è”åˆ†æ**ï¼šJOINã€CTEã€å­æŸ¥è¯¢
- **ç»Ÿè®¡åˆ†æ**ï¼šç™¾åˆ†ä½æ•°ã€æ ‡å‡†å·®ã€ç›¸å…³æ€§

---

## 1. æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºç”¨æˆ·è¡Œä¸ºæ•°æ®è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE user_events CASCADE;
        END IF;

        CREATE TABLE user_events (
            event_id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL,
            event_type VARCHAR(50) NOT NULL,
            event_timestamp TIMESTAMP NOT NULL,
            page_url VARCHAR(200),
            session_id VARCHAR(100),
            device_type VARCHAR(20),
            duration_seconds INTEGER
        );

        -- æ’å…¥ç¤ºä¾‹ç”¨æˆ·è¡Œä¸ºæ•°æ®
        INSERT INTO user_events (user_id, event_type, event_timestamp, page_url, session_id, device_type, duration_seconds) VALUES
            (1, 'page_view', '2024-01-01 10:00:00', '/home', 'session_001', 'desktop', 30),
            (1, 'page_view', '2024-01-01 10:00:30', '/products', 'session_001', 'desktop', 45),
            (1, 'click', '2024-01-01 10:01:15', '/products/item1', 'session_001', 'desktop', NULL),
            (1, 'page_view', '2024-01-01 10:01:20', '/products/item1', 'session_001', 'desktop', 120),
            (1, 'purchase', '2024-01-01 10:03:20', '/checkout', 'session_001', 'desktop', NULL),
            (2, 'page_view', '2024-01-01 11:00:00', '/home', 'session_002', 'mobile', 20),
            (2, 'page_view', '2024-01-01 11:00:20', '/products', 'session_002', 'mobile', 30),
            (2, 'page_view', '2024-01-02 10:00:00', '/home', 'session_003', 'mobile', 25),
            (3, 'page_view', '2024-01-01 12:00:00', '/home', 'session_004', 'desktop', 40),
            (3, 'page_view', '2024-01-01 12:00:40', '/products', 'session_004', 'desktop', 60),
            (3, 'click', '2024-01-01 12:01:40', '/products/item2', 'session_004', 'desktop', NULL),
            (4, 'page_view', '2024-01-01 13:00:00', '/home', 'session_005', 'mobile', 15),
            (4, 'page_view', '2024-01-01 13:00:15', '/products', 'session_005', 'mobile', 20),
            (5, 'page_view', '2024-01-01 14:00:00', '/home', 'session_006', 'desktop', 50),
            (5, 'purchase', '2024-01-01 14:00:50', '/checkout', 'session_006', 'desktop', NULL);

        RAISE NOTICE 'ç”¨æˆ·è¡Œä¸ºæ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 2. ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ

```sql
-- ç”¨æˆ·æ´»è·ƒåº¦åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·æ´»è·ƒåº¦åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·æ´»è·ƒåº¦åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·æ´»è·ƒåº¦åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·æ—¥æ´»è·ƒåº¦ç»Ÿè®¡
SELECT
    DATE_TRUNC('day', event_timestamp) AS date,
    COUNT(DISTINCT user_id) AS daily_active_users,
    COUNT(DISTINCT session_id) AS daily_sessions,
    COUNT(*) AS total_events,
    AVG(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS avg_session_duration
FROM user_events
GROUP BY DATE_TRUNC('day', event_timestamp)
ORDER BY date;

-- ç”¨æˆ·æ´»è·ƒåº¦æ’è¡Œ
SELECT
    user_id,
    COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS active_days,
    COUNT(DISTINCT session_id) AS total_sessions,
    COUNT(*) AS total_events,
    SUM(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS total_duration,
    MAX(event_timestamp) AS last_active_time,
    CURRENT_TIMESTAMP - MAX(event_timestamp) AS days_since_last_active
FROM user_events
GROUP BY user_id
ORDER BY active_days DESC, total_events DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('day', event_timestamp) AS date,
    COUNT(DISTINCT user_id) AS daily_active_users
FROM user_events
GROUP BY DATE_TRUNC('day', event_timestamp);
```

---

## 3. ç”¨æˆ·è·¯å¾„åˆ†æ

```sql
-- ç”¨æˆ·è·¯å¾„åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·è·¯å¾„åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·è·¯å¾„åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·è·¯å¾„åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·ä¼šè¯è·¯å¾„åˆ†æ
WITH session_paths AS (
    SELECT
        session_id,
        user_id,
        page_url,
        event_type,
        event_timestamp,
        ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY event_timestamp) AS step_number,
        LAG(page_url) OVER (PARTITION BY session_id ORDER BY event_timestamp) AS previous_page
    FROM user_events
    WHERE event_type = 'page_view'
)
SELECT
    session_id,
    user_id,
    STRING_AGG(page_url, ' -> ' ORDER BY step_number) AS user_path,
    COUNT(*) AS path_length,
    MAX(CASE WHEN page_url = '/checkout' THEN 1 ELSE 0 END) AS reached_checkout
FROM session_paths
GROUP BY session_id, user_id
ORDER BY path_length DESC;

-- é¡µé¢æµè½¬åˆ†æ
WITH page_transitions AS (
    SELECT
        session_id,
        page_url AS from_page,
        LEAD(page_url) OVER (PARTITION BY session_id ORDER BY event_timestamp) AS to_page
    FROM user_events
    WHERE event_type = 'page_view'
)
SELECT
    from_page,
    to_page,
    COUNT(*) AS transition_count,
    ROUND((COUNT(*)::numeric / SUM(COUNT(*)) OVER (PARTITION BY from_page) * 100)::numeric, 2) AS transition_percentage
FROM page_transitions
WHERE to_page IS NOT NULL
GROUP BY from_page, to_page
ORDER BY transition_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    session_id,
    STRING_AGG(page_url, ' -> ' ORDER BY event_timestamp) AS user_path
FROM user_events
WHERE event_type = 'page_view'
GROUP BY session_id;
```

---

## 4. ç”¨æˆ·ç•™å­˜åˆ†æ

```sql
-- ç”¨æˆ·ç•™å­˜åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·ç•™å­˜åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·ç•™å­˜åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·ç•™å­˜åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·é¦–æ¬¡æ´»è·ƒæ—¥æœŸ
WITH user_first_active AS (
    SELECT
        user_id,
        MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
    FROM user_events
    GROUP BY user_id
),
daily_active_users AS (
    SELECT
        DATE_TRUNC('day', event_timestamp) AS active_date,
        user_id
    FROM user_events
    GROUP BY DATE_TRUNC('day', event_timestamp), user_id
),
retention_analysis AS (
    SELECT
        ufa.first_active_date AS cohort_date,
        dau.active_date,
        dau.active_date - ufa.first_active_date AS days_since_first,
        COUNT(DISTINCT dau.user_id) AS retained_users
    FROM user_first_active ufa
    JOIN daily_active_users dau ON ufa.user_id = dau.user_id
    GROUP BY ufa.first_active_date, dau.active_date
)
SELECT
    cohort_date,
    active_date,
    days_since_first,
    retained_users,
    (SELECT COUNT(DISTINCT user_id) FROM user_first_active WHERE first_active_date = cohort_date) AS cohort_size,
    ROUND((retained_users::numeric / NULLIF((SELECT COUNT(DISTINCT user_id) FROM user_first_active WHERE first_active_date = cohort_date), 0) * 100)::numeric, 2) AS retention_rate
FROM retention_analysis
ORDER BY cohort_date, days_since_first;

-- ç®€åŒ–ç‰ˆç•™å­˜ç‡è®¡ç®—
WITH user_first_active AS (
    SELECT
        user_id,
        MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
    FROM user_events
    GROUP BY user_id
),
retention_by_day AS (
    SELECT
        ufa.first_active_date,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date THEN ue.user_id END) AS day_0_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '1 day' THEN ue.user_id END) AS day_1_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '7 days' THEN ue.user_id END) AS day_7_users,
        COUNT(DISTINCT CASE WHEN DATE_TRUNC('day', ue.event_timestamp) = ufa.first_active_date + INTERVAL '30 days' THEN ue.user_id END) AS day_30_users
    FROM user_first_active ufa
    LEFT JOIN user_events ue ON ufa.user_id = ue.user_id
    GROUP BY ufa.first_active_date
)
SELECT
    first_active_date AS cohort_date,
    day_0_users,
    day_1_users,
    ROUND((day_1_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_1_retention_rate,
    day_7_users,
    ROUND((day_7_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_7_retention_rate,
    day_30_users,
    ROUND((day_30_users::numeric / NULLIF(day_0_users, 0) * 100)::numeric, 2) AS day_30_retention_rate
FROM retention_by_day
ORDER BY first_active_date;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    MIN(DATE_TRUNC('day', event_timestamp)) AS first_active_date
FROM user_events
GROUP BY user_id;
```

---

## 5. ç”¨æˆ·åˆ†ç¾¤åˆ†æ

```sql
-- ç”¨æˆ·åˆ†ç¾¤åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·åˆ†ç¾¤åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·åˆ†ç¾¤åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·åˆ†ç¾¤åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åŸºäºè¡Œä¸ºçš„ç”¨æˆ·åˆ†ç¾¤ï¼ˆRFMæ¨¡å‹ç®€åŒ–ç‰ˆï¼‰
WITH user_metrics AS (
    SELECT
        user_id,
        COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS frequency,
        MAX(event_timestamp) AS last_active_time,
        CURRENT_TIMESTAMP - MAX(event_timestamp) AS recency_days,
        COUNT(DISTINCT session_id) AS session_count,
        SUM(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS total_duration,
        COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count
    FROM user_events
    GROUP BY user_id
),
user_segments AS (
    SELECT
        user_id,
        frequency,
        recency_days,
        session_count,
        total_duration,
        purchase_count,
        CASE
            WHEN recency_days <= INTERVAL '7 days' AND frequency >= 5 THEN 'Champion'
            WHEN recency_days <= INTERVAL '30 days' AND frequency >= 3 THEN 'Loyal'
            WHEN recency_days <= INTERVAL '7 days' AND frequency < 3 THEN 'New'
            WHEN recency_days > INTERVAL '30 days' AND frequency >= 3 THEN 'At Risk'
            ELSE 'Inactive'
        END AS user_segment
    FROM user_metrics
)
SELECT
    user_segment,
    COUNT(*) AS user_count,
    ROUND(AVG(frequency)::numeric, 2) AS avg_frequency,
    ROUND(AVG(EXTRACT(EPOCH FROM recency_days))::numeric, 2) AS avg_recency_days,
    ROUND(AVG(session_count)::numeric, 2) AS avg_sessions,
    ROUND(AVG(total_duration)::numeric, 2) AS avg_duration,
    SUM(purchase_count) AS total_purchases
FROM user_segments
GROUP BY user_segment
ORDER BY user_count DESC;

-- è®¾å¤‡ç±»å‹ç”¨æˆ·åˆ†ç¾¤
SELECT
    device_type,
    COUNT(DISTINCT user_id) AS user_count,
    COUNT(DISTINCT session_id) AS session_count,
    AVG(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS avg_session_duration,
    COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count,
    ROUND((COUNT(*) FILTER (WHERE event_type = 'purchase')::numeric / COUNT(*) * 100)::numeric, 2) AS conversion_rate
FROM user_events
WHERE device_type IS NOT NULL
GROUP BY device_type
ORDER BY user_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS frequency,
    MAX(event_timestamp) AS last_active_time
FROM user_events
GROUP BY user_id;
```

---

## 6. è½¬åŒ–æ¼æ–—åˆ†æ

```sql
-- è½¬åŒ–æ¼æ–—åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè½¬åŒ–æ¼æ–—åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œè½¬åŒ–æ¼æ–—åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è½¬åŒ–æ¼æ–—åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è½¬åŒ–æ¼æ–—ç»Ÿè®¡
WITH funnel_steps AS (
    SELECT
        session_id,
        MAX(CASE WHEN page_url = '/home' THEN 1 ELSE 0 END) AS step1_home,
        MAX(CASE WHEN page_url = '/products' THEN 1 ELSE 0 END) AS step2_products,
        MAX(CASE WHEN page_url LIKE '/products/%' THEN 1 ELSE 0 END) AS step3_product_detail,
        MAX(CASE WHEN event_type = 'click' AND page_url LIKE '/products/%' THEN 1 ELSE 0 END) AS step4_click,
        MAX(CASE WHEN page_url = '/checkout' THEN 1 ELSE 0 END) AS step5_checkout,
        MAX(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS step6_purchase
    FROM user_events
    GROUP BY session_id
)
SELECT
    'Step 1: Home' AS funnel_step,
    COUNT(*) FILTER (WHERE step1_home = 1) AS user_count,
    100.0 AS conversion_rate
FROM funnel_steps
UNION ALL
SELECT
    'Step 2: Products',
    COUNT(*) FILTER (WHERE step2_products = 1),
    ROUND((COUNT(*) FILTER (WHERE step2_products = 1)::numeric / NULLIF(COUNT(*) FILTER (WHERE step1_home = 1), 0) * 100)::numeric, 2)
FROM funnel_steps
UNION ALL
SELECT
    'Step 3: Product Detail',
    COUNT(*) FILTER (WHERE step3_product_detail = 1),
    ROUND((COUNT(*) FILTER (WHERE step3_product_detail = 1)::numeric / NULLIF(COUNT(*) FILTER (WHERE step1_home = 1), 0) * 100)::numeric, 2)
FROM funnel_steps
UNION ALL
SELECT
    'Step 4: Click',
    COUNT(*) FILTER (WHERE step4_click = 1),
    ROUND((COUNT(*) FILTER (WHERE step4_click = 1)::numeric / NULLIF(COUNT(*) FILTER (WHERE step1_home = 1), 0) * 100)::numeric, 2)
FROM funnel_steps
UNION ALL
SELECT
    'Step 5: Checkout',
    COUNT(*) FILTER (WHERE step5_checkout = 1),
    ROUND((COUNT(*) FILTER (WHERE step5_checkout = 1)::numeric / NULLIF(COUNT(*) FILTER (WHERE step1_home = 1), 0) * 100)::numeric, 2)
FROM funnel_steps
UNION ALL
SELECT
    'Step 6: Purchase',
    COUNT(*) FILTER (WHERE step6_purchase = 1),
    ROUND((COUNT(*) FILTER (WHERE step6_purchase = 1)::numeric / NULLIF(COUNT(*) FILTER (WHERE step1_home = 1), 0) * 100)::numeric, 2)
FROM funnel_steps
ORDER BY funnel_step;
```

---

## 7. ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æ

```sql
-- ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸåˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯†åˆ«
WITH user_lifecycle AS (
    SELECT
        user_id,
        MIN(event_timestamp) AS first_event_date,
        MAX(event_timestamp) AS last_event_date,
        COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS active_days,
        COUNT(DISTINCT session_id) AS total_sessions,
        COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count,
        CURRENT_DATE - MAX(DATE_TRUNC('day', event_timestamp))::date AS days_since_last_active
    FROM user_events
    GROUP BY user_id
)
SELECT
    user_id,
    first_event_date,
    last_event_date,
    active_days,
    total_sessions,
    purchase_count,
    days_since_last_active,
    CASE
        WHEN days_since_last_active <= 7 AND active_days >= 5 THEN 'Active'
        WHEN days_since_last_active <= 30 AND active_days >= 3 THEN 'Engaged'
        WHEN days_since_last_active <= 7 AND active_days < 3 THEN 'New'
        WHEN days_since_last_active <= 30 AND active_days < 3 THEN 'At Risk'
        WHEN days_since_last_active > 30 AND active_days >= 3 THEN 'Churned'
        ELSE 'Inactive'
    END AS lifecycle_stage
FROM user_lifecycle
ORDER BY days_since_last_active DESC;

-- ç”Ÿå‘½å‘¨æœŸé˜¶æ®µåˆ†å¸ƒ
WITH user_lifecycle AS (
    SELECT
        user_id,
        MIN(event_timestamp) AS first_event_date,
        MAX(event_timestamp) AS last_event_date,
        COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS active_days,
        CURRENT_DATE - MAX(DATE_TRUNC('day', event_timestamp))::date AS days_since_last_active
    FROM user_events
    GROUP BY user_id
)
SELECT
    CASE
        WHEN days_since_last_active <= 7 AND active_days >= 5 THEN 'Active'
        WHEN days_since_last_active <= 30 AND active_days >= 3 THEN 'Engaged'
        WHEN days_since_last_active <= 7 AND active_days < 3 THEN 'New'
        WHEN days_since_last_active <= 30 AND active_days < 3 THEN 'At Risk'
        WHEN days_since_last_active > 30 AND active_days >= 3 THEN 'Churned'
        ELSE 'Inactive'
    END AS lifecycle_stage,
    COUNT(*) AS user_count,
    ROUND(AVG(active_days)::numeric, 2) AS avg_active_days,
    ROUND(AVG(days_since_last_active)::numeric, 2) AS avg_days_since_last_active
FROM user_lifecycle
GROUP BY lifecycle_stage
ORDER BY user_count DESC;
```

---

## 8. ç”¨æˆ·ä»·å€¼åˆ†æ

```sql
-- ç”¨æˆ·ä»·å€¼åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_events') THEN
            RAISE WARNING 'è¡¨ user_events ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç”¨æˆ·ä»·å€¼åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç”¨æˆ·ä»·å€¼åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·ä»·å€¼åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·ä»·å€¼è¯„åˆ†ï¼ˆåŸºäºè¡Œä¸ºï¼‰
WITH user_value_metrics AS (
    SELECT
        user_id,
        COUNT(DISTINCT DATE_TRUNC('day', event_timestamp)) AS active_days,
        COUNT(DISTINCT session_id) AS session_count,
        SUM(duration_seconds) FILTER (WHERE duration_seconds IS NOT NULL) AS total_duration,
        COUNT(*) FILTER (WHERE event_type = 'purchase') AS purchase_count,
        COUNT(*) FILTER (WHERE event_type = 'click') AS click_count,
        MAX(event_timestamp) AS last_active_time,
        CURRENT_TIMESTAMP - MAX(event_timestamp) AS recency
    FROM user_events
    GROUP BY user_id
),
user_value_scores AS (
    SELECT
        user_id,
        active_days,
        session_count,
        total_duration,
        purchase_count,
        click_count,
        EXTRACT(EPOCH FROM recency) / 86400 AS recency_days,
        -- æ´»è·ƒåº¦å¾—åˆ† (0-30åˆ†)
        LEAST(active_days * 2, 30) AS activity_score,
        -- å‚ä¸åº¦å¾—åˆ† (0-30åˆ†)
        LEAST(session_count * 2, 30) AS engagement_score,
        -- è½¬åŒ–å¾—åˆ† (0-30åˆ†)
        LEAST(purchase_count * 10, 30) AS conversion_score,
        -- æœ€è¿‘æ€§å¾—åˆ† (0-10åˆ†ï¼Œæœ€è¿‘è¶Šæ´»è·ƒå¾—åˆ†è¶Šé«˜)
        CASE
            WHEN recency_days <= 1 THEN 10
            WHEN recency_days <= 7 THEN 7
            WHEN recency_days <= 30 THEN 4
            ELSE 1
        END AS recency_score
    FROM user_value_metrics
)
SELECT
    user_id,
    active_days,
    session_count,
    purchase_count,
    ROUND(recency_days::numeric, 2) AS recency_days,
    activity_score,
    engagement_score,
    conversion_score,
    recency_score,
    activity_score + engagement_score + conversion_score + recency_score AS total_value_score,
    CASE
        WHEN activity_score + engagement_score + conversion_score + recency_score >= 80 THEN 'High Value'
        WHEN activity_score + engagement_score + conversion_score + recency_score >= 50 THEN 'Medium Value'
        ELSE 'Low Value'
    END AS value_segment
FROM user_value_scores
ORDER BY total_value_score DESC;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºå…³é”®ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_events_user ON user_events(user_id);
CREATE INDEX IF NOT EXISTS idx_events_timestamp ON user_events(event_timestamp);
CREATE INDEX IF NOT EXISTS idx_events_session ON user_events(session_id);
CREATE INDEX IF NOT EXISTS idx_events_type ON user_events(event_type);
CREATE INDEX IF NOT EXISTS idx_events_url ON user_events(page_url);
```

### åˆ†åŒºè¡¨

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºäº‹ä»¶è¡¨ï¼ˆPostgreSQL 10+ï¼‰
CREATE TABLE user_events_partitioned (
    LIKE user_events INCLUDING ALL
) PARTITION BY RANGE (event_timestamp);

CREATE TABLE events_2024_01 PARTITION OF user_events_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE events_2024_02 PARTITION OF user_events_partitioned
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

### ç‰©åŒ–è§†å›¾

```sql
-- åˆ›å»ºå¸¸ç”¨ç»Ÿè®¡çš„ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW IF NOT EXISTS mv_daily_active_users AS
SELECT
    DATE_TRUNC('day', event_timestamp) AS date,
    COUNT(DISTINCT user_id) AS daily_active_users,
    COUNT(DISTINCT session_id) AS daily_sessions,
    COUNT(*) AS total_events
FROM user_events
GROUP BY DATE_TRUNC('day', event_timestamp);

CREATE UNIQUE INDEX ON mv_daily_active_users(date);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_daily_active_users;
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### æ•°æ®è´¨é‡

1. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿äº‹ä»¶æ•°æ®å®Œæ•´å‡†ç¡®
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è·¨è¡¨æ•°æ®ä¸€è‡´æ€§
3. **æ•°æ®æ—¶æ•ˆæ€§**ï¼šåŠæ—¶æ”¶é›†å’Œå¤„ç†äº‹ä»¶æ•°æ®
4. **æ•°æ®æ¸…æ´—**ï¼šå®šæœŸæ¸…æ´—å¼‚å¸¸æ•°æ®

### åˆ†æç­–ç•¥

1. **åˆ†å±‚åˆ†æ**ï¼šä»å®è§‚åˆ°å¾®è§‚é€æ­¥æ·±å…¥
2. **å¯¹æ¯”åˆ†æ**ï¼šä¸å†å²æ•°æ®ã€è¡Œä¸šæ ‡å‡†å¯¹æ¯”
3. **å¤šç»´åº¦åˆ†æ**ï¼šä»æ—¶é—´ã€ç”¨æˆ·ã€è¡Œä¸ºç­‰å¤šç»´åº¦åˆ†æ
4. **å¼‚å¸¸æ£€æµ‹**ï¼šè¯†åˆ«å¼‚å¸¸è¡Œä¸ºå’Œå¼‚å¸¸æ¨¡å¼

### éšç§ä¿æŠ¤

1. **æ•°æ®è„±æ•**ï¼šå¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•å¤„ç†
2. **è®¿é—®æ§åˆ¶**ï¼šæ§åˆ¶æ•°æ®è®¿é—®æƒé™
3. **åˆè§„æ€§**ï¼šéµå®ˆæ•°æ®ä¿æŠ¤æ³•è§„
4. **ç”¨æˆ·åŒæ„**ï¼šè·å¾—ç”¨æˆ·åŒæ„åæ”¶é›†æ•°æ®

### æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•è®¾è®¡**ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•
2. **åˆ†åŒºç­–ç•¥**ï¼šå¯¹å¤§æ•°æ®é‡è¡¨è¿›è¡Œåˆ†åŒº
3. **ç‰©åŒ–è§†å›¾**ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
4. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä¼˜åŒ–SQLæŸ¥è¯¢è¯­å¥

### SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨DOå—è¿›è¡Œé”™è¯¯å¤„ç†
2. **NULLå€¼å¤„ç†**ï¼šä½¿ç”¨COALESCEå’ŒNULLIFå¤„ç†NULLå€¼
3. **æ€§èƒ½æµ‹è¯•**ï¼šä½¿ç”¨EXPLAIN ANALYZEæµ‹è¯•æ€§èƒ½
4. **æ•°æ®ç±»å‹è½¬æ¢**ï¼šæ³¨æ„æ•°æ®ç±»å‹è½¬æ¢å’Œç²¾åº¦

---

## ğŸ“ˆ åˆ†ææ–¹æ³•å¯¹æ¯”

| åˆ†ææ–¹æ³• | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | å±€é™æ€§ |
|---------|---------|------|--------|
| æè¿°æ€§åˆ†æ | ç°çŠ¶äº†è§£ã€è¶‹åŠ¿åˆ†æ | ç®€å•ç›´è§‚ã€æ˜“äºç†è§£ | æ— æ³•é¢„æµ‹æœªæ¥ |
| è¯Šæ–­æ€§åˆ†æ | é—®é¢˜å®šä½ã€åŸå› åˆ†æ | æ·±å…¥æŒ–æ˜ã€å‘ç°è§„å¾‹ | éœ€è¦å¤§é‡æ•°æ® |
| é¢„æµ‹æ€§åˆ†æ | è¶‹åŠ¿é¢„æµ‹ã€æµå¤±é¢„æµ‹ | æå‰é¢„è­¦ã€æ”¯æŒå†³ç­– | å‡†ç¡®æ€§æœ‰é™ |
| è§„èŒƒæ€§åˆ†æ | ä¸ªæ€§åŒ–æ¨èã€ç²¾å‡†è¥é”€ | æä¾›è¡ŒåŠ¨æ–¹æ¡ˆ | éœ€è¦é¢†åŸŸçŸ¥è¯† |

---

## ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šç”¨æˆ·è¡Œä¸ºæ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢æ…¢

**åŸå› **ï¼š

- æ•°æ®é‡è¿‡å¤§
- ç¼ºå°‘ç´¢å¼•
- å¤æ‚æŸ¥è¯¢

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨åˆ†åŒºè¡¨
- åˆ›å»ºåˆé€‚çš„ç´¢å¼•
- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ
- ä¼˜åŒ–æŸ¥è¯¢è¯­å¥

### é—®é¢˜2ï¼šç•™å­˜ç‡è®¡ç®—ä¸å‡†ç¡®

**åŸå› **ï¼š

- æ•°æ®ç¼ºå¤±
- è®¡ç®—é€»è¾‘é”™è¯¯
- æ—¶é—´çª—å£é€‰æ‹©ä¸å½“

**è§£å†³æ–¹æ¡ˆ**ï¼š

- æé«˜æ•°æ®è´¨é‡
- ä»”ç»†æ£€æŸ¥è®¡ç®—å…¬å¼
- é€‰æ‹©åˆé€‚çš„æ—¶é—´çª—å£
- ä¸ä¸šåŠ¡äººå‘˜ç¡®è®¤

### é—®é¢˜3ï¼šç”¨æˆ·åˆ†ç¾¤æ•ˆæœä¸å¥½

**åŸå› **ï¼š

- ç‰¹å¾é€‰æ‹©ä¸å½“
- åˆ†ç¾¤æ ‡å‡†ä¸åˆç†
- æ•°æ®è´¨é‡å·®

**è§£å†³æ–¹æ¡ˆ**ï¼š

- é€‰æ‹©åˆé€‚çš„ç‰¹å¾
- è°ƒæ•´åˆ†ç¾¤æ ‡å‡†
- æé«˜æ•°æ®è´¨é‡
- ä½¿ç”¨å¤šç§åˆ†ç¾¤æ–¹æ³•

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
