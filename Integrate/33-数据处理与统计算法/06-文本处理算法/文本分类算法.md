# PostgreSQL æ–‡æœ¬åˆ†ç±»ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ–‡æœ¬åˆ†ç±» | æ–‡æ¡£åˆ†ç±»
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ–‡æœ¬åˆ†ç±»ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ–‡æœ¬åˆ†ç±»ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ–‡æœ¬åˆ†ç±»ç®—æ³•æ¦‚è¿°](#æ–‡æœ¬åˆ†ç±»ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ–‡æœ¬åˆ†ç±»é—®é¢˜å®šä¹‰](#æ–‡æœ¬åˆ†ç±»é—®é¢˜å®šä¹‰)
      - [åˆ†ç±»ç®—æ³•åˆ†ç±»](#åˆ†ç±»ç®—æ³•åˆ†ç±»)
      - [åˆ†ç±»ç­–ç•¥é€‰æ‹©](#åˆ†ç±»ç­–ç•¥é€‰æ‹©)
    - [æ ¸å¿ƒåˆ†ç±»æ–¹æ³•](#æ ¸å¿ƒåˆ†ç±»æ–¹æ³•)
  - [1. å…³é”®è¯åˆ†ç±»](#1-å…³é”®è¯åˆ†ç±»)
    - [1.1 å…³é”®è¯åˆ†ç±»åŸç†](#11-å…³é”®è¯åˆ†ç±»åŸç†)
      - [å…³é”®è¯åŒ¹é…å®šä¹‰](#å…³é”®è¯åŒ¹é…å®šä¹‰)
      - [å…³é”®è¯æƒé‡](#å…³é”®è¯æƒé‡)
    - [1.2 å…³é”®è¯åŒ¹é…åˆ†ç±»å®ç°](#12-å…³é”®è¯åŒ¹é…åˆ†ç±»å®ç°)
    - [1.3 å¤šå…³é”®è¯åˆ†ç±»](#13-å¤šå…³é”®è¯åˆ†ç±»)
  - [2. åŸºäºè§„åˆ™çš„åˆ†ç±»](#2-åŸºäºè§„åˆ™çš„åˆ†ç±»)
    - [2.1 è§„åˆ™åˆ†ç±»åŸç†](#21-è§„åˆ™åˆ†ç±»åŸç†)
      - [è§„åˆ™å®šä¹‰](#è§„åˆ™å®šä¹‰)
      - [è§„åˆ™ä¼˜å…ˆçº§](#è§„åˆ™ä¼˜å…ˆçº§)
    - [2.2 è§„åˆ™å¼•æ“åˆ†ç±»å®ç°](#22-è§„åˆ™å¼•æ“åˆ†ç±»å®ç°)
    - [2.3 å¤æ‚è§„åˆ™åˆ†ç±»](#23-å¤æ‚è§„åˆ™åˆ†ç±»)
  - [3. åŸºäºå‘é‡çš„åˆ†ç±»ï¼ˆpgvectorï¼‰](#3-åŸºäºå‘é‡çš„åˆ†ç±»pgvector)
    - [3.1 å‘é‡åˆ†ç±»æ¦‚è¿°](#31-å‘é‡åˆ†ç±»æ¦‚è¿°)
      - [å‘é‡åˆ†ç±»åŸç†](#å‘é‡åˆ†ç±»åŸç†)
      - [pgvectoræ‰©å±•å®‰è£…](#pgvectoræ‰©å±•å®‰è£…)
    - [3.2 å‘é‡åˆ†ç±»å®ç°](#32-å‘é‡åˆ†ç±»å®ç°)
    - [3.3 å‘é‡åˆ†ç±»æ€§èƒ½ä¼˜åŒ–](#33-å‘é‡åˆ†ç±»æ€§èƒ½ä¼˜åŒ–)
  - [4. æ–‡æœ¬ç‰¹å¾æå–](#4-æ–‡æœ¬ç‰¹å¾æå–)
    - [4.1 ç‰¹å¾æå–åŸç†](#41-ç‰¹å¾æå–åŸç†)
      - [ç‰¹å¾å®šä¹‰](#ç‰¹å¾å®šä¹‰)
      - [ç‰¹å¾é€‰æ‹©](#ç‰¹å¾é€‰æ‹©)
    - [4.2 ç‰¹å¾å‘é‡æå–å®ç°](#42-ç‰¹å¾å‘é‡æå–å®ç°)
    - [4.3 TF-IDFç‰¹å¾æå–](#43-tf-idfç‰¹å¾æå–)
  - [5. åˆ†ç±»ä¼˜åŒ–ç­–ç•¥](#5-åˆ†ç±»ä¼˜åŒ–ç­–ç•¥)
    - [5.1 ç´¢å¼•ä¼˜åŒ–](#51-ç´¢å¼•ä¼˜åŒ–)
    - [5.2 è§„åˆ™ä¼˜åŒ–](#52-è§„åˆ™ä¼˜åŒ–)
    - [5.3 æ€§èƒ½ä¼˜åŒ–](#53-æ€§èƒ½ä¼˜åŒ–)
  - [6. PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬åˆ†ç±»å¢å¼º](#6-postgresql-18-å¹¶è¡Œæ–‡æœ¬åˆ†ç±»å¢å¼º)
    - [6.1 å¹¶è¡Œæ–‡æœ¬åˆ†ç±»åŸç†](#61-å¹¶è¡Œæ–‡æœ¬åˆ†ç±»åŸç†)
    - [6.2 å¹¶è¡Œå…³é”®è¯åˆ†ç±»](#62-å¹¶è¡Œå…³é”®è¯åˆ†ç±»)
    - [6.3 å¹¶è¡Œå‘é‡åˆ†ç±»](#63-å¹¶è¡Œå‘é‡åˆ†ç±»)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»](#61-æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»)
    - [6.2 é‚®ä»¶åˆ†ç±»ç³»ç»Ÿ](#62-é‚®ä»¶åˆ†ç±»ç³»ç»Ÿ)
    - [6.3 æ–°é—»åˆ†ç±»ç³»ç»Ÿ](#63-æ–°é—»åˆ†ç±»ç³»ç»Ÿ)
    - [6.4 æƒ…æ„Ÿåˆ†æåˆ†ç±»](#64-æƒ…æ„Ÿåˆ†æåˆ†ç±»)
  - [8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#8-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [7.1 åˆ†ç±»æ–¹æ³•å¯¹æ¯”](#71-åˆ†ç±»æ–¹æ³•å¯¹æ¯”)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#73-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [8.1 åˆ†ç±»ç­–ç•¥é€‰æ‹©](#81-åˆ†ç±»ç­–ç•¥é€‰æ‹©)
    - [8.2 ç‰¹å¾å·¥ç¨‹](#82-ç‰¹å¾å·¥ç¨‹)
    - [8.3 è§„åˆ™è®¾è®¡](#83-è§„åˆ™è®¾è®¡)
    - [8.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#84-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [8.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨](#85-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨)
    - [8.6 é«˜çº§ä¼˜åŒ–æŠ€å·§](#86-é«˜çº§ä¼˜åŒ–æŠ€å·§)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ–‡æœ¬åˆ†ç±»ç®—æ³•æ¦‚è¿°

**æ–‡æœ¬åˆ†ç±»ç®—æ³•ï¼ˆText Classification Algorithmï¼‰**ç”¨äºå°†æ–‡æœ¬è‡ªåŠ¨åˆ†ç±»åˆ°é¢„å®šä¹‰çš„ç±»åˆ«ï¼Œæ˜¯è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¿¡æ¯æ£€ç´¢çš„æ ¸å¿ƒä»»åŠ¡ä¹‹ä¸€ã€‚PostgreSQLå¯ä»¥é€šè¿‡SQLå®ç°åŸºäºè§„åˆ™å’Œç‰¹å¾çš„åˆ†ç±»ç®—æ³•ã€‚

### ç†è®ºåŸºç¡€

#### æ–‡æœ¬åˆ†ç±»é—®é¢˜å®šä¹‰

**æ–‡æœ¬åˆ†ç±»é—®é¢˜**ï¼šç»™å®šæ–‡æœ¬é›†åˆ$D = \{d_1, d_2, \ldots, d_n\}$å’Œç±»åˆ«é›†åˆ$C = \{c_1, c_2, \ldots, c_k\}$ï¼Œæ‰¾åˆ°ä¸€ä¸ªåˆ†ç±»å‡½æ•°$f: D \to C$ï¼Œä½¿å¾—ï¼š
$$f(d_i) = c_j$$

**åˆ†ç±»ä»»åŠ¡ç±»å‹**ï¼š

1. **äºŒåˆ†ç±»**ï¼š$|C| = 2$
2. **å¤šåˆ†ç±»**ï¼š$|C| > 2$
3. **å¤šæ ‡ç­¾åˆ†ç±»**ï¼šä¸€ä¸ªæ–‡æ¡£å¯ä»¥å±äºå¤šä¸ªç±»åˆ«

#### åˆ†ç±»ç®—æ³•åˆ†ç±»

æ–‡æœ¬åˆ†ç±»ç®—æ³•åˆ†ç±»ï¼š

1. **åŸºäºè§„åˆ™**ï¼š
   - å…³é”®è¯åŒ¹é…
   - æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
   - è§„åˆ™å¼•æ“
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

2. **åŸºäºç‰¹å¾**ï¼š
   - ç‰¹å¾å‘é‡æå–
   - TF-IDFç‰¹å¾
   - ç»Ÿè®¡ç‰¹å¾
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

3. **åŸºäºæœºå™¨å­¦ä¹ **ï¼ˆéœ€è¦å¤–éƒ¨å·¥å…·ï¼‰ï¼š
   - æœ´ç´ è´å¶æ–¯
   - æ”¯æŒå‘é‡æœº
   - ç¥ç»ç½‘ç»œ

#### åˆ†ç±»ç­–ç•¥é€‰æ‹©

é€‰æ‹©åˆ†ç±»ç­–ç•¥çš„è€ƒè™‘å› ç´ ï¼š

1. **æ•°æ®é‡**ï¼šå°æ•°æ®é›†ç”¨è§„åˆ™ï¼Œå¤§æ•°æ®é›†ç”¨ç‰¹å¾
2. **ç±»åˆ«æ•°é‡**ï¼šå°‘ç±»åˆ«ç”¨è§„åˆ™ï¼Œå¤šç±»åˆ«ç”¨ç‰¹å¾
3. **ç²¾åº¦è¦æ±‚**ï¼šé«˜ç²¾åº¦ç”¨æœºå™¨å­¦ä¹ ï¼Œå¿«é€Ÿåˆ†ç±»ç”¨è§„åˆ™
4. **å¯è§£é‡Šæ€§**ï¼šéœ€è¦å¯è§£é‡Šæ€§ç”¨è§„åˆ™

### æ ¸å¿ƒåˆ†ç±»æ–¹æ³•

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **å…³é”®è¯åˆ†ç±»** | $f(d) = c_i \text{ if } \text{keywords}(d) \cap K_i \neq \emptyset$ | åŸºäºå…³é”®è¯ | $O(n)$ | $O(n)$ | ç®€å•åˆ†ç±» |
| **è§„åˆ™åˆ†ç±»** | $f(d) = c_i \text{ if } r_i(d) = \text{true}$ | åŸºäºè§„åˆ™ | $O(n)$ | $O(1)$ | å¤æ‚è§„åˆ™ |
| **ç‰¹å¾åˆ†ç±»** | $f(d) = \arg\max_{c_i} \text{score}(\text{features}(d), c_i)$ | åŸºäºç‰¹å¾ | $O(n)$ | $O(n)$ | ç²¾ç¡®åˆ†ç±» |

---

## 1. å…³é”®è¯åˆ†ç±»

### 1.1 å…³é”®è¯åˆ†ç±»åŸç†

**å…³é”®è¯åˆ†ç±»ï¼ˆKeyword-based Classificationï¼‰**æ˜¯åŸºäºå…³é”®è¯åŒ¹é…çš„ç®€å•åˆ†ç±»æ–¹æ³•ã€‚

#### å…³é”®è¯åŒ¹é…å®šä¹‰

**å…³é”®è¯åŒ¹é…**ï¼šç»™å®šæ–‡æ¡£$d$å’Œå…³é”®è¯é›†åˆ$K = \{k_1, k_2, \ldots, k_n\}$ï¼Œå¦‚æœæ–‡æ¡£åŒ…å«å…³é”®è¯ï¼Œåˆ™åˆ†ç±»åˆ°å¯¹åº”ç±»åˆ«ï¼š
$$f(d) = c_i \text{ if } \exists k_j \in K_i \text{ such that } k_j \in d$$

#### å…³é”®è¯æƒé‡

**å…³é”®è¯æƒé‡**ï¼šä¸åŒå…³é”®è¯å¯ä»¥æœ‰ä¸åŒçš„æƒé‡ï¼š
$$f(d) = \arg\max_{c_i} \sum_{k_j \in K_i} w_j \times \text{count}(k_j, d)$$

### 1.2 å…³é”®è¯åŒ¹é…åˆ†ç±»å®ç°

**å…³é”®è¯åŒ¹é…åˆ†ç±»**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- å…³é”®è¯åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…³é”®è¯åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…³é”®è¯åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…³é”®è¯åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    CASE
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software | programming') THEN 'Technology'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance | market') THEN 'Business'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'health | medical | doctor') THEN 'Health'
        ELSE 'Other'
    END AS category
FROM articles;
```

---

### 1.3 å¤šå…³é”®è¯åˆ†ç±»

**å¤šå…³é”®è¯åˆ†ç±»**ï¼šä½¿ç”¨å¤šä¸ªå…³é”®è¯ç»„åˆè¿›è¡Œåˆ†ç±»ã€‚

```sql
-- å¤šå…³é”®è¯åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šå…³é”®è¯åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šå…³é”®è¯åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šå…³é”®è¯åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šå…³é”®è¯åˆ†ç±»ï¼šä½¿ç”¨å…³é”®è¯æƒé‡
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    -- è®¡ç®—æ¯ä¸ªç±»åˆ«çš„å…³é”®è¯åŒ¹é…åˆ†æ•°
    (SELECT COUNT(*) FROM unnest(string_to_array('technology software programming', ' ')) AS kw
     WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) AS tech_score,
    (SELECT COUNT(*) FROM unnest(string_to_array('business finance market', ' ')) AS kw
     WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) AS business_score,
    (SELECT COUNT(*) FROM unnest(string_to_array('health medical doctor', ' ')) AS kw
     WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) AS health_score,
    -- é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ç±»åˆ«
    CASE
        WHEN (SELECT COUNT(*) FROM unnest(string_to_array('technology software programming', ' ')) AS kw
              WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) >= 2 THEN 'Technology'
        WHEN (SELECT COUNT(*) FROM unnest(string_to_array('business finance market', ' ')) AS kw
              WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) >= 2 THEN 'Business'
        WHEN (SELECT COUNT(*) FROM unnest(string_to_array('health medical doctor', ' ')) AS kw
              WHERE to_tsvector('english', content) @@ to_tsquery('english', kw)) >= 2 THEN 'Health'
        ELSE 'Other'
    END AS category
FROM articles;
```

---

## 2. åŸºäºè§„åˆ™çš„åˆ†ç±»

### 2.1 è§„åˆ™åˆ†ç±»åŸç†

**åŸºäºè§„åˆ™çš„åˆ†ç±»ï¼ˆRule-based Classificationï¼‰**ä½¿ç”¨é¢„å®šä¹‰çš„è§„åˆ™è¿›è¡Œåˆ†ç±»ã€‚

#### è§„åˆ™å®šä¹‰

**åˆ†ç±»è§„åˆ™**ï¼šè§„åˆ™$r$æ˜¯ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™å°†æ–‡æ¡£åˆ†ç±»åˆ°å¯¹åº”ç±»åˆ«ï¼š
$$f(d) = c_i \text{ if } r_i(d) = \text{true}$$

**è§„åˆ™ç±»å‹**ï¼š

- **å…³é”®è¯è§„åˆ™**ï¼šåŒ…å«ç‰¹å®šå…³é”®è¯
- **é•¿åº¦è§„åˆ™**ï¼šæ–‡æœ¬é•¿åº¦æ»¡è¶³æ¡ä»¶
- **æ¨¡å¼è§„åˆ™**ï¼šåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
- **ç»„åˆè§„åˆ™**ï¼šå¤šä¸ªæ¡ä»¶çš„é€»è¾‘ç»„åˆ

#### è§„åˆ™ä¼˜å…ˆçº§

**è§„åˆ™ä¼˜å…ˆçº§**ï¼šå¤šä¸ªè§„åˆ™å¯èƒ½åŒæ—¶åŒ¹é…ï¼Œéœ€è¦å®šä¹‰ä¼˜å…ˆçº§ï¼š
$$f(d) = c_i \text{ if } r_i(d) = \text{true} \text{ and } \forall j < i, r_j(d) = \text{false}$$

### 2.2 è§„åˆ™å¼•æ“åˆ†ç±»å®ç°

**è§„åˆ™å¼•æ“åˆ†ç±»**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åŸºäºè§„åˆ™çš„åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒåŸºäºè§„åˆ™çš„åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºäºè§„åˆ™çš„åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åŸºäºè§„åˆ™çš„åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH classification_rules AS (
    SELECT
        id,
        title,
        content,
        CASE
            WHEN length(content) > 5000 AND similarity(title, 'report') > 0.3 THEN 'Long Report'
            WHEN length(content) < 500 AND similarity(title, 'note') > 0.3 THEN 'Short Note'
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'urgent | important') THEN 'Urgent'
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'meeting | schedule') THEN 'Meeting'
            ELSE 'General'
        END AS document_category
    FROM documents
)
SELECT
    document_category,
    COUNT(*) AS count,
    AVG(length(content)) AS avg_length
FROM classification_rules
GROUP BY document_category
ORDER BY count DESC;
```

---

### 2.3 å¤æ‚è§„åˆ™åˆ†ç±»

**å¤æ‚è§„åˆ™åˆ†ç±»**ï¼šä½¿ç”¨å¤æ‚çš„è§„åˆ™ç»„åˆè¿›è¡Œåˆ†ç±»ã€‚

```sql
-- å¤æ‚è§„åˆ™åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤æ‚è§„åˆ™åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤æ‚è§„åˆ™åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤æ‚è§„åˆ™åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤æ‚è§„åˆ™åˆ†ç±»ï¼šç»„åˆå¤šä¸ªæ¡ä»¶
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    length(content) AS content_length,
    array_length(string_to_array(content, ' '), 1) AS word_count,
    CASE
        -- ä¼˜å…ˆçº§1ï¼šç´§æ€¥æ–‡æ¡£
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'urgent | critical | emergency') THEN 'Urgent'
        -- ä¼˜å…ˆçº§2ï¼šé•¿æŠ¥å‘Š
        WHEN length(content) > 5000 AND similarity(title, 'report') > 0.3 THEN 'Long Report'
        -- ä¼˜å…ˆçº§3ï¼šçŸ­ç¬”è®°
        WHEN length(content) < 500 AND similarity(title, 'note') > 0.3 THEN 'Short Note'
        -- ä¼˜å…ˆçº§4ï¼šä¼šè®®ç›¸å…³
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'meeting | schedule | appointment') THEN 'Meeting'
        -- ä¼˜å…ˆçº§5ï¼šæŠ€æœ¯æ–‡æ¡£
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software | code') THEN 'Technical'
        -- é»˜è®¤ç±»åˆ«
        ELSE 'General'
    END AS document_category
FROM documents;
```

---

## 3. åŸºäºå‘é‡çš„åˆ†ç±»ï¼ˆpgvectorï¼‰

### 3.1 å‘é‡åˆ†ç±»æ¦‚è¿°

**åŸºäºå‘é‡çš„åˆ†ç±»ï¼ˆVector-based Classificationï¼‰**ï¼šä½¿ç”¨pgvectoræ‰©å±•è¿›è¡Œè¯­ä¹‰çº§åˆ«çš„æ–‡æœ¬åˆ†ç±»ï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦å®ç°æ›´å‡†ç¡®çš„åˆ†ç±»ã€‚

#### å‘é‡åˆ†ç±»åŸç†

**å‘é‡åˆ†ç±»**ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡åµŒå…¥ï¼ˆembeddingï¼‰ï¼Œé€šè¿‡è®¡ç®—å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œåˆ†ç±»ã€‚

**å‘é‡åˆ†ç±»ä¼˜åŠ¿**ï¼š

- è¯­ä¹‰ç†è§£èƒ½åŠ›å¼º
- æ”¯æŒç›¸ä¼¼æ–‡æœ¬è‡ªåŠ¨å½’ç±»
- å¯ä»¥ç»“åˆé¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚OpenAIã€Cohereï¼‰

#### pgvectoræ‰©å±•å®‰è£…

```sql
-- å®‰è£…pgvectoræ‰©å±•ï¼ˆéœ€è¦PostgreSQL 11+ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'pgvectoræ‰©å±•å®‰è£…å¤±è´¥: %ã€‚è¯·ç¡®ä¿å·²å®‰è£…pgvectoræ‰©å±•ã€‚', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.2 å‘é‡åˆ†ç±»å®ç°

**åˆ›å»ºå‘é‡åˆ†ç±»è¡¨**ï¼š

```sql
-- åˆ›å»ºæ–‡æ¡£å‘é‡åˆ†ç±»è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_classification') THEN
            RAISE WARNING 'è¡¨ document_classification å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE document_classification CASCADE;
        END IF;

        -- åˆ›å»ºåŒ…å«å‘é‡åµŒå…¥çš„åˆ†ç±»è¡¨
        CREATE TABLE document_classification (
            id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            -- ä½¿ç”¨vectorç±»å‹å­˜å‚¨1536ç»´å‘é‡ï¼ˆOpenAI text-embedding-3-largeï¼‰
            embedding vector(1536),
            -- åˆ†ç±»æ ‡ç­¾
            category TEXT,
            confidence_score NUMERIC,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- åˆ›å»ºå‘é‡ç›¸ä¼¼åº¦ç´¢å¼•ï¼ˆHNSWç´¢å¼•ï¼ŒPostgreSQL 18+ï¼‰
        CREATE INDEX idx_document_classification_vector
        ON document_classification
        USING hnsw (embedding vector_cosine_ops)
        WITH (m = 16, ef_construction = 64);

        -- åˆ›å»ºåˆ†ç±»ç´¢å¼•
        CREATE INDEX idx_document_classification_category
        ON document_classification(category);

        RAISE NOTICE 'æ–‡æ¡£å‘é‡åˆ†ç±»è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ–‡æ¡£å‘é‡åˆ†ç±»è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„åˆ†ç±»**ï¼š

```sql
-- å‘é‡åˆ†ç±»ï¼šåŸºäºç±»åˆ«ä¸­å¿ƒå‘é‡åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_classification') THEN
            RAISE WARNING 'è¡¨ document_classification ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‘é‡åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‘é‡åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æ¯ä¸ªç±»åˆ«çš„ä¸­å¿ƒå‘é‡
WITH category_centroids AS (
    SELECT
        category,
        AVG(embedding) AS centroid_embedding
    FROM document_classification
    WHERE category IS NOT NULL AND embedding IS NOT NULL
    GROUP BY category
),
-- å¯¹æœªåˆ†ç±»æ–‡æ¡£è¿›è¡Œåˆ†ç±»
unclassified_documents AS (
    SELECT
        id,
        title,
        content,
        embedding
    FROM document_classification
    WHERE category IS NULL AND embedding IS NOT NULL
),
-- è®¡ç®—ä¸æ¯ä¸ªç±»åˆ«ä¸­å¿ƒçš„ç›¸ä¼¼åº¦
similarity_scores AS (
    SELECT
        ud.id,
        ud.title,
        cc.category,
        1 - (ud.embedding <=> cc.centroid_embedding) AS similarity
    FROM unclassified_documents ud
    CROSS JOIN category_centroids cc
),
-- é€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„ç±»åˆ«
best_matches AS (
    SELECT DISTINCT ON (id)
        id,
        title,
        category,
        similarity
    FROM similarity_scores
    ORDER BY id, similarity DESC
)
-- æ›´æ–°åˆ†ç±»ç»“æœ
UPDATE document_classification dc
SET
    category = bm.category,
    confidence_score = bm.similarity
FROM best_matches bm
WHERE dc.id = bm.id AND bm.similarity > 0.7;  -- ç›¸ä¼¼åº¦é˜ˆå€¼
```

**æ··åˆåˆ†ç±»ï¼ˆå‘é‡ + å…³é”®è¯ï¼‰**ï¼š

```sql
-- æ··åˆåˆ†ç±»ï¼šç»“åˆå‘é‡ç›¸ä¼¼åº¦å’Œå…³é”®è¯åŒ¹é…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
WITH vector_classification AS (
    SELECT
        id,
        title,
        content,
        embedding,
        -- å‘é‡ç›¸ä¼¼åº¦åˆ†ç±»
        (SELECT category
         FROM document_classification
         WHERE category IS NOT NULL
         ORDER BY embedding <=> dc.embedding
         LIMIT 1) AS vector_category,
        (SELECT 1 - (embedding <=> dc.embedding)
         FROM document_classification
         WHERE category IS NOT NULL
         ORDER BY embedding <=> dc.embedding
         LIMIT 1) AS vector_score
    FROM document_classification dc
    WHERE category IS NULL
),
keyword_classification AS (
    SELECT
        id,
        CASE
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software') THEN 'Technology'
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance') THEN 'Business'
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'health | medical') THEN 'Health'
            ELSE NULL
        END AS keyword_category,
        CASE
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software') THEN 0.8
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance') THEN 0.8
            WHEN to_tsvector('english', content) @@ to_tsquery('english', 'health | medical') THEN 0.8
            ELSE 0.0
        END AS keyword_score
    FROM document_classification
    WHERE category IS NULL
)
SELECT
    vc.id,
    vc.title,
    -- åŠ æƒç»„åˆï¼šå‘é‡ç›¸ä¼¼åº¦æƒé‡0.7ï¼Œå…³é”®è¯åŒ¹é…æƒé‡0.3
    COALESCE(vc.vector_category, kc.keyword_category) AS final_category,
    (COALESCE(vc.vector_score, 0) * 0.7 + COALESCE(kc.keyword_score, 0) * 0.3) AS final_score
FROM vector_classification vc
LEFT JOIN keyword_classification kc ON vc.id = kc.id
WHERE COALESCE(vc.vector_score, 0) * 0.7 + COALESCE(kc.keyword_score, 0) * 0.3 > 0.6;
```

### 3.3 å‘é‡åˆ†ç±»æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- pgvectorç´¢å¼•ä¼˜åŒ–ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- HNSWç´¢å¼•ï¼šé€‚åˆé«˜ç»´å‘é‡ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'document_classification' AND indexname = 'idx_document_classification_vector') THEN
            RAISE WARNING 'å‘é‡ç´¢å¼•å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_document_classification_vector
            ON document_classification
            USING hnsw (embedding vector_cosine_ops)
            WITH (m = 16, ef_construction = 64);
            RAISE NOTICE 'HNSWå‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. æ–‡æœ¬ç‰¹å¾æå–

### 4.1 ç‰¹å¾æå–åŸç†

**æ–‡æœ¬ç‰¹å¾æå–ï¼ˆText Feature Extractionï¼‰**æ˜¯ä»æ–‡æœ¬ä¸­æå–ç”¨äºåˆ†ç±»çš„ç‰¹å¾å‘é‡ã€‚

#### ç‰¹å¾å®šä¹‰

**ç‰¹å¾**ï¼šç‰¹å¾$f_i$æ˜¯æ–‡æœ¬çš„ä¸€ä¸ªå±æ€§ï¼Œå¯ä»¥æ˜¯ï¼š

- **ç»Ÿè®¡ç‰¹å¾**ï¼šæ–‡æœ¬é•¿åº¦ã€è¯æ•°ã€å¥å­æ•°
- **è¯æ±‡ç‰¹å¾**ï¼šè¯é¢‘ã€å…³é”®è¯å‡ºç°æ¬¡æ•°
- **è¯­ä¹‰ç‰¹å¾**ï¼šTF-IDFå€¼ã€è¯å‘é‡

**ç‰¹å¾å‘é‡**ï¼š$\mathbf{f}(d) = (f_1(d), f_2(d), \ldots, f_n(d))$

#### ç‰¹å¾é€‰æ‹©

**ç‰¹å¾é€‰æ‹©**ï¼šé€‰æ‹©æœ€ç›¸å…³çš„ç‰¹å¾ç”¨äºåˆ†ç±»ï¼š

- **ä¿¡æ¯å¢ç›Š**ï¼šé€‰æ‹©ä¿¡æ¯å¢ç›Šé«˜çš„ç‰¹å¾
- **å¡æ–¹æ£€éªŒ**ï¼šé€‰æ‹©ä¸ç±»åˆ«ç›¸å…³æ€§é«˜çš„ç‰¹å¾
- **ç›¸å…³æ€§åˆ†æ**ï¼šé€‰æ‹©ä¸ç±»åˆ«ç›¸å…³æ€§é«˜çš„ç‰¹å¾

### 4.2 ç‰¹å¾å‘é‡æå–å®ç°

**ç‰¹å¾å‘é‡æå–**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æ–‡æœ¬ç‰¹å¾æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'texts') THEN
            RAISE WARNING 'è¡¨ texts ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ–‡æœ¬ç‰¹å¾æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ–‡æœ¬ç‰¹å¾æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ–‡æœ¬ç‰¹å¾æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH text_features AS (
    SELECT
        id,
        text,
        length(text) AS text_length,
        array_length(string_to_array(text, ' '), 1) AS word_count,
        (SELECT COUNT(*) FROM unnest(string_to_array(lower(text), ' ')) AS word WHERE word IN ('important', 'urgent', 'critical')) AS important_words_count,
        similarity(text, 'reference text') AS similarity_score
    FROM texts
)
SELECT
    id,
    text_length,
    word_count,
    important_words_count,
    similarity_score,
    CASE
        WHEN important_words_count >= 2 THEN 'High Priority'
        WHEN similarity_score > 0.7 THEN 'Similar'
        WHEN word_count > 100 THEN 'Long'
        ELSE 'Normal'
    END AS text_class
FROM text_features;
```

---

### 4.3 TF-IDFç‰¹å¾æå–

**TF-IDFç‰¹å¾æå–**ï¼šä½¿ç”¨TF-IDFå€¼ä½œä¸ºç‰¹å¾ã€‚

```sql
-- TF-IDFç‰¹å¾æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒTF-IDFç‰¹å¾æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒTF-IDFç‰¹å¾æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'TF-IDFç‰¹å¾æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- TF-IDFç‰¹å¾æå–ï¼šæå–æ¯ä¸ªæ–‡æ¡£çš„TF-IDFç‰¹å¾å‘é‡
WITH document_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
),
term_frequency AS (
    SELECT
        id,
        word,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM document_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM document_words
    GROUP BY word
),
total_documents AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM documents
),
tf_idf_features AS (
    SELECT
        tf.id,
        tf.word,
        tf.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf
    FROM term_frequency tf
    JOIN document_frequency df ON tf.word = df.word
    CROSS JOIN total_documents td
    WHERE tf.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) > 0.1
)
SELECT
    id,
    array_agg(word ORDER BY tf_idf DESC) AS top_keywords,
    array_agg(tf_idf ORDER BY tf_idf DESC) AS tf_idf_scores
FROM tf_idf_features
GROUP BY id
ORDER BY id;
```

---

## 5. åˆ†ç±»ä¼˜åŒ–ç­–ç•¥

### 5.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºåˆ†ç±»æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- GINç´¢å¼•ï¼šå…¨æ–‡æœç´¢åˆ†ç±»
        CREATE INDEX IF NOT EXISTS idx_documents_content_gin
        ON documents USING GIN (to_tsvector('english', content));

        -- Trigramç´¢å¼•ï¼šç›¸ä¼¼åº¦åˆ†ç±»
        CREATE EXTENSION IF NOT EXISTS pg_trgm;
        CREATE INDEX IF NOT EXISTS idx_documents_title_trgm
        ON documents USING GIN (title gin_trgm_ops);

        RAISE NOTICE 'åˆ†ç±»ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 è§„åˆ™ä¼˜åŒ–

**è§„åˆ™ä¼˜åŒ–**ï¼šä¼˜åŒ–åˆ†ç±»è§„åˆ™æé«˜æ€§èƒ½ã€‚

```sql
-- è§„åˆ™ä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åˆ†ç±»ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS document_categories AS
SELECT
    id,
    title,
    content,
    CASE
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software') THEN 'Technology'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance') THEN 'Business'
        ELSE 'Other'
    END AS category
FROM documents;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿåˆ†ç±»æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_document_categories_category
ON document_categories(category);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY document_categories;
```

### 5.3 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æ‰¹é‡å¤„ç†å’Œå¹¶è¡ŒæŸ¥è¯¢ã€‚

```sql
-- æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰¹é‡åˆ†ç±»ï¼šä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    CASE
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software') THEN 'Technology'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance') THEN 'Business'
        ELSE 'Other'
    END AS category
FROM documents;
```

---

## 6. PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬åˆ†ç±»å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œæ–‡æœ¬åˆ†ç±»èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œå…³é”®è¯åˆ†ç±»ã€è§„åˆ™åˆ†ç±»å’Œå‘é‡åˆ†ç±»ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡æ–‡æœ¬åˆ†ç±»çš„æ€§èƒ½ã€‚

### 6.1 å¹¶è¡Œæ–‡æœ¬åˆ†ç±»åŸç†

PostgreSQL 18 çš„å¹¶è¡Œæ–‡æœ¬åˆ†ç±»é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«ææ–‡æœ¬æ•°æ®
2. **å¹¶è¡Œç‰¹å¾æå–**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æå–æ–‡æœ¬ç‰¹å¾
3. **å¹¶è¡Œåˆ†ç±»**ï¼šå¹¶è¡Œæ‰§è¡Œåˆ†ç±»ç®—æ³•
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„åˆ†ç±»ç»“æœ

### 6.2 å¹¶è¡Œå…³é”®è¯åˆ†ç±»

```sql
-- PostgreSQL 18 å¹¶è¡Œå…³é”®è¯åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå…³é”®è¯åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå…³é”®è¯åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå…³é”®è¯åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå…³é”®è¯åˆ†ç±»ï¼šåŸºäºå…³é”®è¯åŒ¹é…
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH keyword_categories AS (
    SELECT 'technology' AS category, ARRAY['computer', 'software', 'hardware', 'internet'] AS keywords
    UNION ALL
    SELECT 'sports', ARRAY['football', 'basketball', 'tennis', 'soccer']
    UNION ALL
    SELECT 'science', ARRAY['research', 'experiment', 'theory', 'discovery']
),
document_classification AS (
    SELECT
        d.id,
        d.title,
        d.content,
        kc.category,
        COUNT(*) FILTER (WHERE d.content ILIKE '%' || keyword || '%') AS keyword_matches
    FROM documents d
    CROSS JOIN keyword_categories kc
    CROSS JOIN LATERAL unnest(kc.keywords) AS keyword
    GROUP BY d.id, d.title, d.content, kc.category
)
SELECT DISTINCT ON (id)
    id,
    title,
    category,
    keyword_matches
FROM document_classification
WHERE keyword_matches > 0
ORDER BY id, keyword_matches DESC;
```

### 6.3 å¹¶è¡Œå‘é‡åˆ†ç±»

```sql
-- PostgreSQL 18 å¹¶è¡Œå‘é‡åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_classification') THEN
            RAISE WARNING 'è¡¨ document_classification ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå‘é‡åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå‘é‡åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå‘é‡åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå‘é‡åˆ†ç±»ï¼šåŸºäºç±»åˆ«ä¸­å¿ƒå‘é‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH category_centroids AS (
    SELECT
        category,
        AVG(embedding) AS centroid_embedding
    FROM document_classification
    WHERE category IS NOT NULL AND embedding IS NOT NULL
    GROUP BY category
),
unclassified_documents AS (
    SELECT
        id,
        title,
        embedding
    FROM document_classification
    WHERE category IS NULL AND embedding IS NOT NULL
),
similarity_scores AS (
    SELECT
        ud.id,
        ud.title,
        cc.category,
        1 - (ud.embedding <=> cc.centroid_embedding) AS similarity
    FROM unclassified_documents ud
    CROSS JOIN category_centroids cc
)
SELECT DISTINCT ON (id)
    id,
    title,
    category,
    ROUND(similarity::numeric, 4) AS confidence_score
FROM similarity_scores
ORDER BY id, similarity DESC;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»

**æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»**æ ¹æ®å†…å®¹è‡ªåŠ¨åˆ†ç±»æ–‡æ¡£ã€‚

```sql
-- æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ–‡æ¡£è‡ªåŠ¨åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ–‡æ¡£è‡ªåŠ¨åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»ï¼šå¤šç±»åˆ«åˆ†ç±»
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    CASE
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'technology | software | programming') THEN 'Technology'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'business | finance | market') THEN 'Business'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'health | medical | doctor') THEN 'Health'
        WHEN to_tsvector('english', content) @@ to_tsquery('english', 'education | learning | school') THEN 'Education'
        ELSE 'General'
    END AS category,
    ts_rank(to_tsvector('english', content),
            to_tsquery('english', 'technology | business | health | education')) AS relevance_score
FROM documents
ORDER BY relevance_score DESC;
```

### 6.2 é‚®ä»¶åˆ†ç±»ç³»ç»Ÿ

**é‚®ä»¶åˆ†ç±»ç³»ç»Ÿ**ï¼šè‡ªåŠ¨åˆ†ç±»é‚®ä»¶åˆ°ä¸åŒæ–‡ä»¶å¤¹ã€‚

```sql
-- é‚®ä»¶åˆ†ç±»ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'emails') THEN
            RAISE WARNING 'è¡¨ emails ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé‚®ä»¶åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé‚®ä»¶åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é‚®ä»¶åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é‚®ä»¶åˆ†ç±»ï¼šæ ¹æ®ä¸»é¢˜å’Œå†…å®¹åˆ†ç±»
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    sender,
    subject,
    body,
    CASE
        WHEN to_tsvector('english', subject || ' ' || body) @@ to_tsquery('english', 'spam | promotion | discount') THEN 'Spam'
        WHEN to_tsvector('english', subject || ' ' || body) @@ to_tsquery('english', 'urgent | important | asap') THEN 'Urgent'
        WHEN to_tsvector('english', subject || ' ' || body) @@ to_tsquery('english', 'meeting | schedule | appointment') THEN 'Meeting'
        WHEN to_tsvector('english', subject || ' ' || body) @@ to_tsquery('english', 'invoice | payment | bill') THEN 'Finance'
        ELSE 'General'
    END AS email_category,
    CASE
        WHEN sender ~* '@spam\.com$' THEN 'Spam'
        WHEN sender IN (SELECT email FROM trusted_senders) THEN 'Trusted'
        ELSE 'Unknown'
    END AS sender_category
FROM emails
ORDER BY received_at DESC;
```

### 6.3 æ–°é—»åˆ†ç±»ç³»ç»Ÿ

**æ–°é—»åˆ†ç±»ç³»ç»Ÿ**ï¼šè‡ªåŠ¨åˆ†ç±»æ–°é—»æ–‡ç« ã€‚

```sql
-- æ–°é—»åˆ†ç±»ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'news_articles') THEN
            RAISE WARNING 'è¡¨ news_articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ–°é—»åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ–°é—»åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ–°é—»åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ–°é—»åˆ†ç±»ï¼šæ ¹æ®æ ‡é¢˜å’Œå†…å®¹åˆ†ç±»
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    author,
    published_at,
    CASE
        WHEN to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'politics | election | government') THEN 'Politics'
        WHEN to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'sports | game | match') THEN 'Sports'
        WHEN to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'technology | tech | innovation') THEN 'Technology'
        WHEN to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'business | economy | market') THEN 'Business'
        WHEN to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'health | medical | science') THEN 'Health'
        ELSE 'General'
    END AS news_category
FROM news_articles
ORDER BY published_at DESC;
```

### 6.4 æƒ…æ„Ÿåˆ†æåˆ†ç±»

**æƒ…æ„Ÿåˆ†æåˆ†ç±»**ï¼šæ ¹æ®æ–‡æœ¬æƒ…æ„Ÿå€¾å‘åˆ†ç±»ã€‚

```sql
-- æƒ…æ„Ÿåˆ†æåˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'reviews') THEN
            RAISE WARNING 'è¡¨ reviews ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæƒ…æ„Ÿåˆ†æåˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæƒ…æ„Ÿåˆ†æåˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æƒ…æ„Ÿåˆ†æåˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æƒ…æ„Ÿåˆ†æåˆ†ç±»ï¼šåŸºäºæƒ…æ„Ÿè¯æ±‡
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    review_text,
    rating,
    -- æ­£é¢æƒ…æ„Ÿè¯è®¡æ•°
    (SELECT COUNT(*) FROM unnest(string_to_array('good great excellent amazing wonderful', ' ')) AS word
     WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) AS positive_count,
    -- è´Ÿé¢æƒ…æ„Ÿè¯è®¡æ•°
    (SELECT COUNT(*) FROM unnest(string_to_array('bad terrible awful horrible poor', ' ')) AS word
     WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) AS negative_count,
    -- æƒ…æ„Ÿåˆ†ç±»
    CASE
        WHEN (SELECT COUNT(*) FROM unnest(string_to_array('good great excellent amazing wonderful', ' ')) AS word
              WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) >
             (SELECT COUNT(*) FROM unnest(string_to_array('bad terrible awful horrible poor', ' ')) AS word
              WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) THEN 'Positive'
        WHEN (SELECT COUNT(*) FROM unnest(string_to_array('bad terrible awful horrible poor', ' ')) AS word
              WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) >
             (SELECT COUNT(*) FROM unnest(string_to_array('good great excellent amazing wonderful', ' ')) AS word
              WHERE to_tsvector('english', review_text) @@ to_tsquery('english', word)) THEN 'Negative'
        ELSE 'Neutral'
    END AS sentiment_category
FROM reviews
ORDER BY id;
```

---

## 8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 7.1 åˆ†ç±»æ–¹æ³•å¯¹æ¯”

| åˆ†ç±»æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|-----------|-----------|---------|------|------|
| **å…³é”®è¯åˆ†ç±»** | $f(d) = c_i \text{ if } \text{keywords}(d) \cap K_i \neq \emptyset$ | $O(n)$ | $O(n)$ | ç®€å•åˆ†ç±» | å¿«é€Ÿã€ç®€å• | ç²¾åº¦ä½ |
| **è§„åˆ™åˆ†ç±»** | $f(d) = c_i \text{ if } r_i(d) = \text{true}$ | $O(n)$ | $O(1)$ | å¤æ‚è§„åˆ™ | çµæ´»ã€å¯è§£é‡Š | è§„åˆ™ç»´æŠ¤éš¾ |
| **ç‰¹å¾åˆ†ç±»** | $f(d) = \arg\max_{c_i} \text{score}(\text{features}(d), c_i)$ | $O(n)$ | $O(n)$ | ç²¾ç¡®åˆ†ç±» | ç²¾åº¦é«˜ | ç‰¹å¾å·¥ç¨‹å¤æ‚ |

### 7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - å…¨æ–‡æœç´¢ï¼šä½¿ç”¨GINç´¢å¼•
   - å…³é”®è¯åŒ¹é…ï¼šä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•
   - è§„åˆ™åŒ¹é…ï¼šä½¿ç”¨å‡½æ•°ç´¢å¼•

2. **è§„åˆ™ä¼˜åŒ–**ï¼š
   - ä¼˜åŒ–è§„åˆ™é¡ºåº
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜
   - æ‰¹é‡åˆ†ç±»

3. **ç‰¹å¾ä¼˜åŒ–**ï¼š
   - é€‰æ‹©æœ‰æ•ˆç‰¹å¾
   - ä½¿ç”¨ç‰¹å¾ç´¢å¼•
   - æ‰¹é‡ç‰¹å¾æå–

### 7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šåˆ†ç±»ç²¾åº¦ä½

- **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–å…³é”®è¯é›†åˆã€æ”¹è¿›è§„åˆ™ã€ä½¿ç”¨ç‰¹å¾åˆ†ç±»

**é—®é¢˜2**ï¼šåˆ†ç±»æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºç´¢å¼•ã€ä½¿ç”¨ç‰©åŒ–è§†å›¾ã€æ‰¹é‡å¤„ç†

**é—®é¢˜3**ï¼šè§„åˆ™ç»´æŠ¤å›°éš¾

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨è§„åˆ™è¡¨ã€è§„åˆ™ç‰ˆæœ¬ç®¡ç†ã€è§„åˆ™æµ‹è¯•

**é—®é¢˜4**ï¼šå¤šç±»åˆ«åˆ†ç±»

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å¤šæ ‡ç­¾åˆ†ç±»ã€æ¦‚ç‡åˆ†ç±»ã€é˜ˆå€¼è°ƒæ•´

---

## 9. æœ€ä½³å®è·µ

### 8.1 åˆ†ç±»ç­–ç•¥é€‰æ‹©

1. **ç®€å•åˆ†ç±»**ï¼šä½¿ç”¨å…³é”®è¯åˆ†ç±»
2. **å¤æ‚åˆ†ç±»**ï¼šä½¿ç”¨è§„åˆ™åˆ†ç±»
3. **ç²¾ç¡®åˆ†ç±»**ï¼šä½¿ç”¨ç‰¹å¾åˆ†ç±»

### 8.2 ç‰¹å¾å·¥ç¨‹

1. **ç‰¹å¾é€‰æ‹©**ï¼šé€‰æ‹©ä¸ç±»åˆ«ç›¸å…³çš„ç‰¹å¾
2. **ç‰¹å¾æå–**ï¼šä½¿ç”¨TF-IDFã€è¯é¢‘ç­‰
3. **ç‰¹å¾æ ‡å‡†åŒ–**ï¼šæ ‡å‡†åŒ–ç‰¹å¾å€¼

### 8.3 è§„åˆ™è®¾è®¡

1. **è§„åˆ™ä¼˜å…ˆçº§**ï¼šå®šä¹‰æ¸…æ™°çš„ä¼˜å…ˆçº§
2. **è§„åˆ™æµ‹è¯•**ï¼šæµ‹è¯•è§„åˆ™å‡†ç¡®æ€§
3. **è§„åˆ™ç»´æŠ¤**ï¼šå®šæœŸæ›´æ–°è§„åˆ™

### 8.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨å¤§æ•°æ®é›†ä¸Šä½¿ç”¨å¤æ‚è§„åˆ™
2. **ç´¢å¼•ä½¿ç”¨**ï¼šç¡®ä¿æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
3. **ç»“æœç¼“å­˜**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜åˆ†ç±»ç»“æœ
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†NULLå€¼å’Œè¾¹ç•Œæƒ…å†µ

### 8.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ–‡æœ¬åˆ†ç±»ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«åˆ†ç±»æ ‡ç­¾çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Nåˆ†ç±»æŸ¥è¯¢å’Œç±»åˆ«ç­›é€‰

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æ–‡æœ¬åˆ†ç±»è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡æ–‡æœ¬åˆ†ç±»å’Œç‰¹å¾æå–

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - æ–‡æœ¬åˆ†ç±»è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡æ–‡æ¡£åˆ†ç±»å’Œæ‰¹é‡å¤„ç†

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–åˆ†ç±»æŸ¥è¯¢**

```sql
-- ä¸ºæ–‡æœ¬åˆ†ç±»åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_text_classification_skip_scan
ON documents(category, classification_score DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾åˆ†ç±»å¾—åˆ†æœ€é«˜çš„å‰10ä¸ªæ–‡æ¡£
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    document_id,
    title,
    category,
    classification_score
FROM documents
WHERE category = 'Technology'
ORDER BY classification_score DESC
LIMIT 10;
```

### 8.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æ–‡æœ¬åˆ†ç±»ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„æ–‡æœ¬åˆ†ç±»ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜æ–‡æœ¬åˆ†ç±»ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS document_classification_cache AS
WITH classification_features AS (
    SELECT
        document_id,
        title,
        content,
        -- ç‰¹å¾æå–ï¼šTF-IDFï¼ˆç®€åŒ–ç‰ˆï¼‰
        ts_rank(to_tsvector('english', content), to_tsquery('english', 'technology | software | programming')) AS tech_score,
        ts_rank(to_tsvector('english', content), to_tsquery('english', 'business | finance | market')) AS business_score,
        ts_rank(to_tsvector('english', content), to_tsquery('english', 'health | medical | doctor')) AS health_score
    FROM documents
    WHERE content IS NOT NULL
),
classification_results AS (
    SELECT
        document_id,
        title,
        content,
        tech_score,
        business_score,
        health_score,
        GREATEST(tech_score, business_score, health_score) AS max_score,
        CASE
            WHEN GREATEST(tech_score, business_score, health_score) = tech_score THEN 'Technology'
            WHEN GREATEST(tech_score, business_score, health_score) = business_score THEN 'Business'
            WHEN GREATEST(tech_score, business_score, health_score) = health_score THEN 'Health'
            ELSE 'Other'
        END AS predicted_category
    FROM classification_features
)
SELECT
    document_id,
    title,
    predicted_category,
    ROUND(tech_score::numeric, 4) AS technology_score,
    ROUND(business_score::numeric, 4) AS business_score,
    ROUND(health_score::numeric, 4) AS health_score,
    ROUND(max_score::numeric, 4) AS confidence_score
FROM classification_results
WHERE max_score > 0.1;  -- åªä¿ç•™ç½®ä¿¡åº¦è¾ƒé«˜çš„åˆ†ç±»

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_document_classification_cache_category ON document_classification_cache(predicted_category, confidence_score DESC);
CREATE INDEX idx_document_classification_cache_score ON document_classification_cache(confidence_score DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY document_classification_cache;
```

**2. å¢é‡æ–‡æœ¬åˆ†ç±»ï¼šæµå¼æ–‡æ¡£åˆ†ç±»**

**å¢é‡æ–‡æœ¬åˆ†ç±»**ï¼šå¯¹äºæµå¼æ–‡æ¡£ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•è¿›è¡Œåˆ†ç±»ã€‚

```sql
-- å¢é‡æ–‡æœ¬åˆ†ç±»ï¼šæµå¼æ–‡æ¡£åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_classification_state') THEN
            CREATE TABLE document_classification_state (
                category VARCHAR(50) PRIMARY KEY,
                keyword_weights JSONB NOT NULL,  -- å­˜å‚¨å…³é”®è¯æƒé‡
                document_count INTEGER DEFAULT 0,
                last_updated TIMESTAMPTZ DEFAULT NOW()
            );

            RAISE NOTICE 'æ–‡æ¡£åˆ†ç±»çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡æ–‡æœ¬åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡æ–‡æœ¬åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°åˆ†ç±»æ¨¡å‹å…³é”®è¯æƒé‡
WITH new_documents AS (
    SELECT
        document_id,
        category,
        to_tsvector('english', content) AS content_vector
    FROM documents
    WHERE created_at > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM document_classification_state)
),
category_keywords AS (
    SELECT
        category,
        -- æå–å…³é”®è¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
        array_agg(DISTINCT word) AS keywords,
        COUNT(*) AS keyword_count
    FROM new_documents,
    LATERAL unnest(string_to_array(content, ' ')) AS word
    WHERE length(word) > 3
    GROUP BY category
)
-- æ›´æ–°æˆ–æ’å…¥åˆ†ç±»æ¨¡å‹çŠ¶æ€
INSERT INTO document_classification_state (category, keyword_weights, document_count, last_updated)
SELECT
    category,
    jsonb_object_agg(keywords[i], 1.0 / keyword_count) AS keyword_weights,
    COUNT(DISTINCT document_id) AS document_count,
    NOW()
FROM category_keywords,
LATERAL generate_series(1, array_length(keywords, 1)) AS i
GROUP BY category
ON CONFLICT (category)
DO UPDATE SET
    keyword_weights = EXCLUDED.keyword_weights,
    document_count = document_classification_state.document_count + EXCLUDED.document_count,
    last_updated = NOW();
```

**3. å¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»ï¼šæ–‡æ¡£å¤šç±»åˆ«åˆ†ç±»**

**å¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»**ï¼šä¸€ä¸ªæ–‡æ¡£å¯ä»¥å±äºå¤šä¸ªç±»åˆ«ã€‚

```sql
-- å¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»ï¼šæ–‡æ¡£å¤šç±»åˆ«åˆ†ç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šæ ‡ç­¾æ–‡æœ¬åˆ†ç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šæ ‡ç­¾åˆ†ç±»ï¼šä¸€ä¸ªæ–‡æ¡£å¯ä»¥å±äºå¤šä¸ªç±»åˆ«
WITH document_category_scores AS (
    SELECT
        d.document_id,
        d.title,
        d.content,
        c.category,
        -- è®¡ç®—æ¯ä¸ªç±»åˆ«çš„å¾—åˆ†ï¼ˆåŸºäºå…³é”®è¯åŒ¹é…ï¼‰
        ts_rank(to_tsvector('english', d.content),
                to_tsquery('english', string_agg(c.keyword, ' | '))) AS category_score
    FROM documents d
    CROSS JOIN (
        VALUES
            ('Technology', 'technology software programming computer'),
            ('Business', 'business finance market economy'),
            ('Health', 'health medical doctor treatment'),
            ('Science', 'science research experiment discovery')
    ) AS c(category, keyword)
    GROUP BY d.document_id, d.title, d.content, c.category
),
multilabel_classification AS (
    SELECT
        document_id,
        title,
        content,
        category,
        category_score,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„æœ€é«˜å¾—åˆ†ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        MAX(category_score) OVER (PARTITION BY document_id) AS max_category_score,
        -- åˆ¤æ–­æ˜¯å¦å±äºè¯¥ç±»åˆ«ï¼ˆé˜ˆå€¼ï¼š0.3ï¼‰
        CASE
            WHEN category_score >= 0.3 THEN true
            ELSE false
        END AS is_classified
    FROM document_category_scores
)
SELECT
    document_id,
    title,
    array_agg(category ORDER BY category_score DESC) FILTER (WHERE is_classified = true) AS predicted_categories,
    array_agg(ROUND(category_score::numeric, 4)) FILTER (WHERE is_classified = true) AS category_scores,
    COUNT(*) FILTER (WHERE is_classified = true) AS num_categories
FROM multilabel_classification
WHERE is_classified = true
GROUP BY document_id, title
ORDER BY num_categories DESC, document_id
LIMIT 50;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šè‡ªç„¶è¯­è¨€å¤„ç†ç»¼è®ºã€‹ï¼ˆSpeech and Language Processingï¼‰- æ–‡æœ¬åˆ†ç±»ç†è®º
- ã€Šæœºå™¨å­¦ä¹ ã€‹ï¼ˆMachine Learningï¼‰- åˆ†ç±»ç®—æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [æ¨¡å¼åŒ¹é…](https://www.postgresql.org/docs/current/functions-matching.html)
- [æ•°ç»„æ“ä½œ](https://www.postgresql.org/docs/current/arrays.html)

### åœ¨çº¿èµ„æº

- PostgreSQLæ–‡æœ¬åˆ†ç±»æŒ‡å—
- è‡ªç„¶è¯­è¨€å¤„ç†æœ€ä½³å®è·µ
- åˆ†ç±»ç®—æ³•å¯¹æ¯”åˆ†æ

### ç›¸å…³ç®—æ³•

- [æ–‡æœ¬æœç´¢ç®—æ³•](./æ–‡æœ¬æœç´¢ç®—æ³•.md) - æ–‡æœ¬æœç´¢
- [æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—](./æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—.md) - ç›¸ä¼¼åº¦è®¡ç®—
- [æ–‡æœ¬æŒ–æ˜ç®—æ³•](./æ–‡æœ¬æŒ–æ˜ç®—æ³•.md) - æ–‡æœ¬æŒ–æ˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
