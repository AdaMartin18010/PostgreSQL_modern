# PostgreSQL æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ–‡æœ¬æœç´¢ | å…¨æ–‡æœç´¢
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°](#æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒæœç´¢åŠŸèƒ½](#æ ¸å¿ƒæœç´¢åŠŸèƒ½)
  - [1. å…¨æ–‡æœç´¢](#1-å…¨æ–‡æœç´¢)
    - [1.1 tsvectoræœç´¢](#11-tsvectoræœç´¢)
  - [2. æ¨¡ç³Šæœç´¢](#2-æ¨¡ç³Šæœç´¢)
    - [2.1 ç›¸ä¼¼åº¦æœç´¢](#21-ç›¸ä¼¼åº¦æœç´¢)
  - [3. æ­£åˆ™è¡¨è¾¾å¼æœç´¢](#3-æ­£åˆ™è¡¨è¾¾å¼æœç´¢)
    - [3.1 æ¨¡å¼åŒ¹é…æœç´¢](#31-æ¨¡å¼åŒ¹é…æœç´¢)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç»„åˆæœç´¢](#41-ç»„åˆæœç´¢)

---

## æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°

**æ–‡æœ¬æœç´¢ç®—æ³•**ç”¨äºåœ¨æ–‡æœ¬æ•°æ®ä¸­æŸ¥æ‰¾ç‰¹å®šå†…å®¹ï¼ŒPostgreSQLæä¾›äº†å¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½ã€‚

### æ ¸å¿ƒæœç´¢åŠŸèƒ½

| åŠŸèƒ½ | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **å…¨æ–‡æœç´¢** | tsvectoræœç´¢ | O(log n) |
| **æ¨¡ç³Šæœç´¢** | ç›¸ä¼¼åº¦æœç´¢ | O(n) |
| **æ­£åˆ™æœç´¢** | æ¨¡å¼åŒ¹é… | O(n) |

---

## 1. å…¨æ–‡æœç´¢

### 1.1 tsvectoræœç´¢

**å…¨æ–‡æœç´¢**ä½¿ç”¨tsvectorè¿›è¡Œé«˜æ•ˆçš„æ–‡æœ¬æœç´¢ã€‚

```sql
-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'idx_documents_content_gin') THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_content_gin å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_documents_content_gin ON documents USING GIN (to_tsvector('english', content));
            RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼• idx_documents_content_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_content_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å…¨æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…¨æ–‡æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨æ–‡æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…¨æ–‡æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), query) AS rank
FROM documents,
     to_tsquery('english', 'keyword1 & keyword2') AS query
WHERE to_tsvector('english', content) @@ query
ORDER BY rank DESC;
```

---

## 2. æ¨¡ç³Šæœç´¢

### 2.1 ç›¸ä¼¼åº¦æœç´¢

**æ¨¡ç³Šæœç´¢**ä½¿ç”¨ç›¸ä¼¼åº¦å‡½æ•°è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚

```sql
-- æ¨¡ç³Šæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ¨¡ç³Šæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¨¡ç³Šæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨¡ç³Šæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    name,
    similarity(name, 'search_term') AS similarity_score
FROM products
WHERE similarity(name, 'search_term') > 0.3
ORDER BY similarity_score DESC;
```

---

## 3. æ­£åˆ™è¡¨è¾¾å¼æœç´¢

### 3.1 æ¨¡å¼åŒ¹é…æœç´¢

**æ­£åˆ™è¡¨è¾¾å¼æœç´¢**ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚

```sql
-- æ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'text_data') THEN
            RAISE WARNING 'è¡¨ text_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ­£åˆ™è¡¨è¾¾å¼æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    content
FROM text_data
WHERE content ~* 'pattern.*regex';  -- ä¸åŒºåˆ†å¤§å°å†™
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç»„åˆæœç´¢

**ç»„åˆæœç´¢**ç»“åˆå¤šç§æœç´¢æ–¹å¼ã€‚

```sql
-- ç»„åˆæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç»„åˆæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç»„åˆæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»„åˆæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), query) AS fulltext_rank,
    similarity(title, 'search_term') AS similarity_score
FROM articles,
     to_tsquery('english', 'keyword') AS query
WHERE to_tsvector('english', content) @@ query
   OR similarity(title, 'search_term') > 0.3
ORDER BY fulltext_rank DESC, similarity_score DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
