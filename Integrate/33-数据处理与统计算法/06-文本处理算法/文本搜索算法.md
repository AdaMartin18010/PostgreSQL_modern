# PostgreSQL æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ–‡æœ¬æœç´¢ | å…¨æ–‡æœç´¢
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ–‡æœ¬æœç´¢ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°](#æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ–‡æœ¬æœç´¢é—®é¢˜å®šä¹‰](#æ–‡æœ¬æœç´¢é—®é¢˜å®šä¹‰)
      - [æœç´¢ç®—æ³•åˆ†ç±»](#æœç´¢ç®—æ³•åˆ†ç±»)
      - [æœç´¢ç­–ç•¥é€‰æ‹©](#æœç´¢ç­–ç•¥é€‰æ‹©)
    - [æ ¸å¿ƒæœç´¢åŠŸèƒ½](#æ ¸å¿ƒæœç´¢åŠŸèƒ½)
  - [1. å…¨æ–‡æœç´¢](#1-å…¨æ–‡æœç´¢)
    - [1.1 å…¨æ–‡æœç´¢åŸç†](#11-å…¨æ–‡æœç´¢åŸç†)
      - [å…¨æ–‡æœç´¢å®šä¹‰](#å…¨æ–‡æœç´¢å®šä¹‰)
      - [tsvectorå’Œtsquery](#tsvectorå’Œtsquery)
    - [1.2 tsvectoræœç´¢å®ç°](#12-tsvectoræœç´¢å®ç°)
    - [1.3 å…¨æ–‡æœç´¢æ’å](#13-å…¨æ–‡æœç´¢æ’å)
    - [1.4 å…¨æ–‡æœç´¢é«˜äº®](#14-å…¨æ–‡æœç´¢é«˜äº®)
  - [2. æ¨¡ç³Šæœç´¢](#2-æ¨¡ç³Šæœç´¢)
    - [2.1 æ¨¡ç³Šæœç´¢åŸç†](#21-æ¨¡ç³Šæœç´¢åŸç†)
      - [æ¨¡ç³ŠåŒ¹é…å®šä¹‰](#æ¨¡ç³ŠåŒ¹é…å®šä¹‰)
      - [ç›¸ä¼¼åº¦å‡½æ•°](#ç›¸ä¼¼åº¦å‡½æ•°)
    - [2.2 ç›¸ä¼¼åº¦æœç´¢å®ç°](#22-ç›¸ä¼¼åº¦æœç´¢å®ç°)
    - [2.3 Trigramç´¢å¼•ä¼˜åŒ–](#23-trigramç´¢å¼•ä¼˜åŒ–)
  - [3. æ­£åˆ™è¡¨è¾¾å¼æœç´¢](#3-æ­£åˆ™è¡¨è¾¾å¼æœç´¢)
    - [3.1 æ­£åˆ™è¡¨è¾¾å¼æœç´¢åŸç†](#31-æ­£åˆ™è¡¨è¾¾å¼æœç´¢åŸç†)
      - [æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•](#æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•)
      - [æ¨¡å¼åŒ¹é…](#æ¨¡å¼åŒ¹é…)
    - [3.2 æ¨¡å¼åŒ¹é…æœç´¢å®ç°](#32-æ¨¡å¼åŒ¹é…æœç´¢å®ç°)
    - [3.3 æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–](#33-æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–)
  - [4. æ–‡æœ¬æœç´¢ä¼˜åŒ–ç­–ç•¥](#4-æ–‡æœ¬æœç´¢ä¼˜åŒ–ç­–ç•¥)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
    - [4.3 æ€§èƒ½è°ƒä¼˜](#43-æ€§èƒ½è°ƒä¼˜)
  - [5. PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬æœç´¢å¢å¼º](#5-postgresql-18-å¹¶è¡Œæ–‡æœ¬æœç´¢å¢å¼º)
    - [5.1 å¹¶è¡Œæ–‡æœ¬æœç´¢åŸç†](#51-å¹¶è¡Œæ–‡æœ¬æœç´¢åŸç†)
    - [5.2 å¹¶è¡Œå…¨æ–‡æœç´¢](#52-å¹¶è¡Œå…¨æ–‡æœç´¢)
    - [5.3 å¹¶è¡Œæ¨¡ç³Šæœç´¢](#53-å¹¶è¡Œæ¨¡ç³Šæœç´¢)
    - [5.4 å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢](#54-å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢)
    - [5.5 å¹¶è¡Œæ··åˆæœç´¢ï¼ˆå…¨æ–‡æœç´¢ + å‘é‡æœç´¢ï¼‰](#55-å¹¶è¡Œæ··åˆæœç´¢å…¨æ–‡æœç´¢--å‘é‡æœç´¢)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 ç»„åˆæœç´¢](#51-ç»„åˆæœç´¢)
    - [5.2 ç”µå•†å•†å“æœç´¢](#52-ç”µå•†å•†å“æœç´¢)
    - [5.3 æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢](#53-æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢)
    - [5.4 æ—¥å¿—æœç´¢åˆ†æ](#54-æ—¥å¿—æœç´¢åˆ†æ)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 æœç´¢æ–¹æ³•å¯¹æ¯”](#61-æœç´¢æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [7.1 æœç´¢ç­–ç•¥é€‰æ‹©](#71-æœç´¢ç­–ç•¥é€‰æ‹©)
    - [7.2 ç´¢å¼•è®¾è®¡](#72-ç´¢å¼•è®¾è®¡)
    - [7.3 æŸ¥è¯¢ä¼˜åŒ–](#73-æŸ¥è¯¢ä¼˜åŒ–)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨](#75-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨)
    - [7.6 é«˜çº§æœç´¢ä¼˜åŒ–æŠ€å·§](#76-é«˜çº§æœç´¢ä¼˜åŒ–æŠ€å·§)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ–‡æœ¬æœç´¢ç®—æ³•æ¦‚è¿°

**æ–‡æœ¬æœç´¢ç®—æ³•ï¼ˆText Search Algorithmï¼‰**ç”¨äºåœ¨æ–‡æœ¬æ•°æ®ä¸­æŸ¥æ‰¾ç‰¹å®šå†…å®¹ï¼Œæ˜¯ä¿¡æ¯æ£€ç´¢å’Œæ–‡æœ¬å¤„ç†çš„æ ¸å¿ƒæ“ä½œã€‚PostgreSQLæä¾›äº†å¼ºå¤§çš„å…¨æ–‡æœç´¢ã€æ¨¡ç³Šæœç´¢å’Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢åŠŸèƒ½ã€‚

### ç†è®ºåŸºç¡€

#### æ–‡æœ¬æœç´¢é—®é¢˜å®šä¹‰

**æ–‡æœ¬æœç´¢é—®é¢˜**ï¼šç»™å®šæ–‡æœ¬é›†åˆ$D = \{d_1, d_2, \ldots, d_n\}$å’ŒæŸ¥è¯¢$q$ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ…å«$q$çš„æ–‡æ¡£ï¼š
$$R = \{d_i \in D \mid q \text{ matches } d_i\}$$

**æœç´¢ç±»å‹**ï¼š

1. **ç²¾ç¡®æœç´¢**ï¼šå®Œå…¨åŒ¹é…æŸ¥è¯¢
2. **å…¨æ–‡æœç´¢**ï¼šåŸºäºå…³é”®è¯åŒ¹é…
3. **æ¨¡ç³Šæœç´¢**ï¼šåŸºäºç›¸ä¼¼åº¦åŒ¹é…
4. **æ¨¡å¼æœç´¢**ï¼šåŸºäºæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

#### æœç´¢ç®—æ³•åˆ†ç±»

PostgreSQLæ–‡æœ¬æœç´¢ç®—æ³•åˆ†ç±»ï¼š

1. **å…¨æ–‡æœç´¢ï¼ˆFull-Text Searchï¼‰**ï¼š
   - ä½¿ç”¨tsvectorå’Œtsquery
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(\log n)$ï¼ˆæœ‰ç´¢å¼•ï¼‰
   - æ”¯æŒè¯å¹²æå–ã€åœç”¨è¯è¿‡æ»¤

2. **æ¨¡ç³Šæœç´¢ï¼ˆFuzzy Searchï¼‰**ï¼š
   - ä½¿ç”¨ç›¸ä¼¼åº¦å‡½æ•°ï¼ˆå¦‚Levenshteinã€Trigramï¼‰
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$
   - æ”¯æŒæ‹¼å†™é”™è¯¯å®¹å¿

3. **æ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ˆRegular Expression Searchï¼‰**ï¼š
   - ä½¿ç”¨POSIXæ­£åˆ™è¡¨è¾¾å¼
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$
   - æ”¯æŒå¤æ‚æ¨¡å¼åŒ¹é…

#### æœç´¢ç­–ç•¥é€‰æ‹©

PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨æ ¹æ®ä»¥ä¸‹å› ç´ é€‰æ‹©æœç´¢ç­–ç•¥ï¼š

1. **ç´¢å¼•å¯ç”¨æ€§**ï¼šæœ‰GINç´¢å¼•æ—¶ä½¿ç”¨å…¨æ–‡æœç´¢
2. **æŸ¥è¯¢ç±»å‹**ï¼šç²¾ç¡®æŸ¥è¯¢ã€æ¨¡ç³ŠæŸ¥è¯¢ã€æ¨¡å¼æŸ¥è¯¢
3. **æ€§èƒ½è¦æ±‚**ï¼šå®æ—¶æœç´¢ã€æ‰¹é‡æœç´¢
4. **ç²¾åº¦è¦æ±‚**ï¼šç²¾ç¡®åŒ¹é…ã€ç›¸ä¼¼åº¦é˜ˆå€¼

### æ ¸å¿ƒæœç´¢åŠŸèƒ½

| åŠŸèƒ½ | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **å…¨æ–‡æœç´¢** | $D \bowtie_q \text{tsquery}$ | tsvectoræœç´¢ | $O(\log n)$ | $O(n)$ | å…³é”®è¯æœç´¢ |
| **æ¨¡ç³Šæœç´¢** | $\text{similarity}(d, q) > \theta$ | ç›¸ä¼¼åº¦æœç´¢ | $O(n)$ | $O(1)$ | æ‹¼å†™å®¹é”™ |
| **æ­£åˆ™æœç´¢** | $d \sim q$ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰ | æ¨¡å¼åŒ¹é… | $O(n)$ | $O(1)$ | å¤æ‚æ¨¡å¼ |

---

## 1. å…¨æ–‡æœç´¢

### 1.1 å…¨æ–‡æœç´¢åŸç†

**å…¨æ–‡æœç´¢ï¼ˆFull-Text Searchï¼‰**æ˜¯åŸºäºå…³é”®è¯çš„æ–‡æœ¬æœç´¢æ–¹æ³•ï¼Œæ”¯æŒè¯å¹²æå–ã€åœç”¨è¯è¿‡æ»¤å’Œç›¸å…³æ€§æ’åã€‚

#### å…¨æ–‡æœç´¢å®šä¹‰

**å…¨æ–‡æœç´¢**ï¼šå°†æ–‡æ¡£è½¬æ¢ä¸ºè¯å‘é‡ï¼ˆtsvectorï¼‰ï¼Œä½¿ç”¨æŸ¥è¯¢å‘é‡ï¼ˆtsqueryï¼‰è¿›è¡ŒåŒ¹é…ã€‚

**tsvector**ï¼šè¯å‘é‡ï¼ŒåŒ…å«æ–‡æ¡£ä¸­çš„æ‰€æœ‰è¯åŠå…¶ä½ç½®ä¿¡æ¯

- æ ¼å¼ï¼š`'word1':1,2 'word2':3`

**tsquery**ï¼šæŸ¥è¯¢å‘é‡ï¼ŒåŒ…å«æœç´¢è¯å’Œé€»è¾‘è¿ç®—ç¬¦

- è¿ç®—ç¬¦ï¼š`&`ï¼ˆANDï¼‰ã€`|`ï¼ˆORï¼‰ã€`!`ï¼ˆNOTï¼‰

#### tsvectorå’Œtsquery

**tsvectoråˆ›å»º**ï¼š`to_tsvector(config, text)`

- **config**ï¼šè¯­è¨€é…ç½®ï¼ˆå¦‚'english'ã€'simple'ï¼‰
- **text**ï¼šå¾…ç´¢å¼•çš„æ–‡æœ¬

**tsqueryåˆ›å»º**ï¼š`to_tsquery(config, query)`

- **query**ï¼šæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆæ”¯æŒé€»è¾‘è¿ç®—ç¬¦ï¼‰

### 1.2 tsvectoræœç´¢å®ç°

**tsvectoræœç´¢**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'idx_documents_content_gin') THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_content_gin å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_documents_content_gin ON documents USING GIN (to_tsvector('english', content));
            RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼• idx_documents_content_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_content_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å…¨æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…¨æ–‡æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨æ–‡æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…¨æ–‡æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), query) AS rank
FROM documents,
     to_tsquery('english', 'keyword1 & keyword2') AS query
WHERE to_tsvector('english', content) @@ query
ORDER BY rank DESC;
```

---

### 1.3 å…¨æ–‡æœç´¢æ’å

**å…¨æ–‡æœç´¢æ’å**ï¼šä½¿ç”¨ts_rankå‡½æ•°è®¡ç®—æ–‡æ¡£ç›¸å…³æ€§ã€‚

```sql
-- å…¨æ–‡æœç´¢æ’åï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…¨æ–‡æœç´¢æ’å';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨æ–‡æœç´¢æ’å';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…¨æ–‡æœç´¢æ’åå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å…¨æ–‡æœç´¢æ’åï¼šä½¿ç”¨ts_rankè®¡ç®—ç›¸å…³æ€§
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), query) AS rank,
    ts_rank_cd(to_tsvector('english', content), query) AS rank_cd
FROM documents,
     to_tsquery('english', 'keyword1 & keyword2') AS query
WHERE to_tsvector('english', content) @@ query
ORDER BY rank DESC;
```

### 1.4 å…¨æ–‡æœç´¢é«˜äº®

**å…¨æ–‡æœç´¢é«˜äº®**ï¼šä½¿ç”¨ts_headlineå‡½æ•°é«˜äº®åŒ¹é…çš„æ–‡æœ¬ã€‚

```sql
-- å…¨æ–‡æœç´¢é«˜äº®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…¨æ–‡æœç´¢é«˜äº®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨æ–‡æœç´¢é«˜äº®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…¨æ–‡æœç´¢é«˜äº®å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å…¨æ–‡æœç´¢é«˜äº®ï¼šä½¿ç”¨ts_headlineé«˜äº®åŒ¹é…æ–‡æœ¬
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    ts_headline('english', content, query, 'StartSel=<mark>, StopSel=</mark>') AS highlighted_content
FROM documents,
     to_tsquery('english', 'keyword1 & keyword2') AS query
WHERE to_tsvector('english', content) @@ query
ORDER BY ts_rank(to_tsvector('english', content), query) DESC;
```

---

## 2. æ¨¡ç³Šæœç´¢

### 2.1 æ¨¡ç³Šæœç´¢åŸç†

**æ¨¡ç³Šæœç´¢ï¼ˆFuzzy Searchï¼‰**ä½¿ç”¨ç›¸ä¼¼åº¦å‡½æ•°è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼Œæ”¯æŒæ‹¼å†™é”™è¯¯å’Œå˜ä½“åŒ¹é…ã€‚

#### æ¨¡ç³ŠåŒ¹é…å®šä¹‰

**æ¨¡ç³ŠåŒ¹é…**ï¼šç»™å®šæ–‡æœ¬$t$å’ŒæŸ¥è¯¢$q$ï¼Œè®¡ç®—ç›¸ä¼¼åº¦$\text{similarity}(t, q)$ï¼Œå¦‚æœç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼$\theta$ï¼Œåˆ™è®¤ä¸ºåŒ¹é…ï¼š
$$\text{match}(t, q) = \begin{cases} \text{true} & \text{if } \text{similarity}(t, q) \geq \theta \\ \text{false} & \text{otherwise} \end{cases}$$

#### ç›¸ä¼¼åº¦å‡½æ•°

PostgreSQLæä¾›çš„ç›¸ä¼¼åº¦å‡½æ•°ï¼š

1. **similarity()**ï¼šåŸºäºTrigramçš„ç›¸ä¼¼åº¦ï¼ˆ0-1ï¼‰
2. **levenshtein()**ï¼šç¼–è¾‘è·ç¦»ï¼ˆ0-âˆï¼‰
3. **jaro_winkler()**ï¼šJaro-Winklerç›¸ä¼¼åº¦ï¼ˆ0-1ï¼‰

### 2.2 ç›¸ä¼¼åº¦æœç´¢å®ç°

**ç›¸ä¼¼åº¦æœç´¢**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æ¨¡ç³Šæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ¨¡ç³Šæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¨¡ç³Šæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨¡ç³Šæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    name,
    similarity(name, 'search_term') AS similarity_score
FROM products
WHERE similarity(name, 'search_term') > 0.3
ORDER BY similarity_score DESC;
```

---

### 2.3 Trigramç´¢å¼•ä¼˜åŒ–

**Trigramç´¢å¼•ä¼˜åŒ–**ï¼šä½¿ç”¨pg_trgmæ‰©å±•åˆ›å»ºTrigramç´¢å¼•ï¼ŒåŠ é€Ÿæ¨¡ç³Šæœç´¢ã€‚

```sql
-- Trigramç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¯ç”¨pg_trgmæ‰©å±•
        CREATE EXTENSION IF NOT EXISTS pg_trgm;

        -- åˆ›å»ºTrigramç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_products_name_trgm
        ON products USING GIN (name gin_trgm_ops);

        RAISE NOTICE 'Trigramç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Trigramç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨Trigramç´¢å¼•çš„æ¨¡ç³Šæœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    name,
    similarity(name, 'search_term') AS similarity_score
FROM products
WHERE name % 'search_term'  -- % æ“ä½œç¬¦ä½¿ç”¨Trigramç´¢å¼•
ORDER BY similarity_score DESC;
```

---

## 3. æ­£åˆ™è¡¨è¾¾å¼æœç´¢

### 3.1 æ­£åˆ™è¡¨è¾¾å¼æœç´¢åŸç†

**æ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ˆRegular Expression Searchï¼‰**ä½¿ç”¨POSIXæ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚

#### æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•

**POSIXæ­£åˆ™è¡¨è¾¾å¼**æ”¯æŒï¼š

- `.`ï¼šåŒ¹é…ä»»æ„å­—ç¬¦
- `*`ï¼šåŒ¹é…0ä¸ªæˆ–å¤šä¸ªå‰ä¸€ä¸ªå­—ç¬¦
- `+`ï¼šåŒ¹é…1ä¸ªæˆ–å¤šä¸ªå‰ä¸€ä¸ªå­—ç¬¦
- `?`ï¼šåŒ¹é…0ä¸ªæˆ–1ä¸ªå‰ä¸€ä¸ªå­—ç¬¦
- `^`ï¼šåŒ¹é…å­—ç¬¦ä¸²å¼€å¤´
- `$`ï¼šåŒ¹é…å­—ç¬¦ä¸²ç»“å°¾
- `[abc]`ï¼šåŒ¹é…å­—ç¬¦é›†
- `(a|b)`ï¼šåŒ¹é…aæˆ–b

#### æ¨¡å¼åŒ¹é…

**æ¨¡å¼åŒ¹é…æ“ä½œç¬¦**ï¼š

- `~`ï¼šåŒºåˆ†å¤§å°å†™åŒ¹é…
- `~*`ï¼šä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
- `!~`ï¼šä¸åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
- `!~*`ï¼šä¸åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

### 3.2 æ¨¡å¼åŒ¹é…æœç´¢å®ç°

**æ¨¡å¼åŒ¹é…æœç´¢**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'text_data') THEN
            RAISE WARNING 'è¡¨ text_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ­£åˆ™è¡¨è¾¾å¼æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    content
FROM text_data
WHERE content ~* 'pattern.*regex';  -- ä¸åŒºåˆ†å¤§å°å†™
```

---

### 3.3 æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–

**æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•å’Œä¼˜åŒ–æ¨¡å¼æé«˜æ€§èƒ½ã€‚

```sql
-- æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•ï¼ˆå¦‚æœæ¨¡å¼å›ºå®šï¼‰
        CREATE INDEX IF NOT EXISTS idx_text_data_email_pattern
        ON text_data((content ~* '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'));

        RAISE NOTICE 'æ­£åˆ™è¡¨è¾¾å¼ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ­£åˆ™è¡¨è¾¾å¼ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨ç´¢å¼•çš„æ­£åˆ™è¡¨è¾¾å¼æœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, content
FROM text_data
WHERE content ~* '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$';
```

---

## 4. æ–‡æœ¬æœç´¢ä¼˜åŒ–ç­–ç•¥

### 4.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæ–‡æœ¬æœç´¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- GINç´¢å¼•ï¼šå…¨æ–‡æœç´¢
        CREATE INDEX IF NOT EXISTS idx_documents_content_gin
        ON documents USING GIN (to_tsvector('english', content));

        -- Trigramç´¢å¼•ï¼šæ¨¡ç³Šæœç´¢
        CREATE EXTENSION IF NOT EXISTS pg_trgm;
        CREATE INDEX IF NOT EXISTS idx_documents_title_trgm
        ON documents USING GIN (title gin_trgm_ops);

        RAISE NOTICE 'æ–‡æœ¬æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–**ï¼šä¼˜åŒ–æŸ¥è¯¢è¯­å¥æé«˜æ€§èƒ½ã€‚

```sql
-- æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¼˜åŒ–æŸ¥è¯¢ï¼šä½¿ç”¨LIMITå’Œç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, title, content
FROM documents
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
ORDER BY ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) DESC
LIMIT 10;
```

### 4.3 æ€§èƒ½è°ƒä¼˜

**æ€§èƒ½è°ƒä¼˜**ï¼šè°ƒæ•´PostgreSQLé…ç½®ä¼˜åŒ–æ–‡æœ¬æœç´¢æ€§èƒ½ã€‚

```sql
-- æ€§èƒ½è°ƒä¼˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- è°ƒæ•´å…¨æ–‡æœç´¢é…ç½®
        SET default_text_search_config = 'english';

        -- è°ƒæ•´work_memï¼ˆå¦‚æœéœ€è¦ï¼‰
        SET work_mem = '256MB';

        RAISE NOTICE 'æ€§èƒ½è°ƒä¼˜é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½è°ƒä¼˜å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬æœç´¢å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œæ–‡æœ¬æœç´¢èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œå…¨æ–‡æœç´¢ã€æ¨¡ç³Šæœç´¢å’Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡æ–‡æœ¬æœç´¢æŸ¥è¯¢çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œæ–‡æœ¬æœç´¢åŸç†

PostgreSQL 18 çš„å¹¶è¡Œæ–‡æœ¬æœç´¢é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«ææ–‡æœ¬æ•°æ®
2. **å¹¶è¡Œæœç´¢**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ‰§è¡Œæœç´¢æ“ä½œ
3. **å¹¶è¡Œæ’åº**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ’åºæœç´¢ç»“æœ
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„æœç´¢ç»“æœ

### 5.2 å¹¶è¡Œå…¨æ–‡æœç´¢

```sql
-- PostgreSQL 18 å¹¶è¡Œå…¨æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå…¨æ–‡æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå…¨æ–‡æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå…¨æ–‡æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œå…¨æ–‡æœç´¢ï¼šæœç´¢åŒ…å«å…³é”®è¯çš„æ–‡æ¡£
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) AS rank
FROM documents
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
ORDER BY rank DESC
LIMIT 20;
```

### 5.3 å¹¶è¡Œæ¨¡ç³Šæœç´¢

```sql
-- PostgreSQL 18 å¹¶è¡Œæ¨¡ç³Šæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS pg_trgm;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ¨¡ç³Šæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ¨¡ç³Šæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ¨¡ç³Šæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ¨¡ç³Šæœç´¢ï¼šä½¿ç”¨Trigramç›¸ä¼¼åº¦æœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    similarity(title, 'search term') AS similarity_score
FROM documents
WHERE similarity(title, 'search term') > 0.3
ORDER BY similarity_score DESC
LIMIT 20;
```

### 5.4 å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢

```sql
-- PostgreSQL 18 å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'text_data') THEN
            RAISE WARNING 'è¡¨ text_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼šæœç´¢åŒ¹é…æ¨¡å¼çš„æ–‡æœ¬
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    content
FROM text_data
WHERE content ~* 'pattern.*regex'  -- ä¸åŒºåˆ†å¤§å°å†™
ORDER BY id
LIMIT 100;
```

### 5.5 å¹¶è¡Œæ··åˆæœç´¢ï¼ˆå…¨æ–‡æœç´¢ + å‘é‡æœç´¢ï¼‰

```sql
-- PostgreSQL 18 å¹¶è¡Œæ··åˆæœç´¢ï¼šç»“åˆå…¨æ–‡æœç´¢å’Œpgvectorå‘é‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- ç¡®ä¿pgvectoræ‰©å±•å·²å®‰è£…
        CREATE EXTENSION IF NOT EXISTS vector;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_embeddings') THEN
            RAISE WARNING 'è¡¨ document_embeddings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ··åˆæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ··åˆæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ··åˆæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ··åˆæœç´¢ï¼šç»“åˆå…¨æ–‡æœç´¢å’Œå‘é‡ç›¸ä¼¼åº¦æœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH target_embedding AS (
    SELECT embedding
    FROM document_embeddings
    WHERE id = 1
    LIMIT 1
),
fulltext_results AS (
    SELECT
        id,
        title,
        ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) AS fulltext_rank
    FROM document_embeddings
    WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
),
vector_results AS (
    SELECT
        id,
        title,
        1 - (embedding <=> (SELECT embedding FROM target_embedding)) AS vector_similarity
    FROM document_embeddings
    WHERE id != 1
),
hybrid_results AS (
    SELECT
        COALESCE(ft.id, vr.id) AS id,
        COALESCE(ft.title, vr.title) AS title,
        COALESCE(ft.fulltext_rank, 0) * 0.6 + COALESCE(vr.vector_similarity, 0) * 0.4 AS hybrid_score
    FROM fulltext_results ft
    FULL OUTER JOIN vector_results vr ON ft.id = vr.id
)
SELECT
    id,
    title,
    ROUND(hybrid_score::numeric, 4) AS hybrid_score
FROM hybrid_results
ORDER BY hybrid_score DESC
LIMIT 20;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 ç»„åˆæœç´¢

**ç»„åˆæœç´¢**ç»“åˆå¤šç§æœç´¢æ–¹å¼ï¼Œæä¾›æ›´å…¨é¢çš„æœç´¢ç»“æœã€‚

```sql
-- ç»„åˆæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç»„åˆæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç»„åˆæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»„åˆæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»„åˆæœç´¢ï¼šå…¨æ–‡æœç´¢ + æ¨¡ç³Šæœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), query) AS fulltext_rank,
    similarity(title, 'search_term') AS similarity_score,
    CASE
        WHEN to_tsvector('english', content) @@ query THEN 'fulltext_match'
        WHEN similarity(title, 'search_term') > 0.3 THEN 'fuzzy_match'
        ELSE 'no_match'
    END AS match_type
FROM articles,
     to_tsquery('english', 'keyword') AS query
WHERE to_tsvector('english', content) @@ query
   OR similarity(title, 'search_term') > 0.3
ORDER BY fulltext_rank DESC NULLS LAST, similarity_score DESC NULLS LAST;
```

### 5.2 ç”µå•†å•†å“æœç´¢

**ç”µå•†å•†å“æœç´¢**ï¼šç»“åˆå…¨æ–‡æœç´¢å’Œå±æ€§è¿‡æ»¤çš„å•†å“æœç´¢ã€‚

```sql
-- ç”µå•†å•†å“æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç”µå•†å•†å“æœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç”µå•†å•†å“æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”µå•†å•†å“æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”µå•†å•†å“æœç´¢ï¼šå…¨æ–‡æœç´¢ + ä»·æ ¼èŒƒå›´ + ç±»åˆ«è¿‡æ»¤
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    p.id,
    p.name,
    p.description,
    p.price,
    p.category,
    ts_rank(to_tsvector('english', p.name || ' ' || p.description), query) AS relevance_score
FROM products p,
     to_tsquery('english', 'laptop & intel') AS query
WHERE to_tsvector('english', p.name || ' ' || p.description) @@ query
  AND p.price BETWEEN 500 AND 2000
  AND p.category = 'electronics'
  AND p.status = 'active'
ORDER BY relevance_score DESC, p.price ASC
LIMIT 20;
```

### 5.3 æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢

**æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢**ï¼šæ”¯æŒå…¨æ–‡æœç´¢ã€æ ‡ç­¾è¿‡æ»¤å’Œæ—¥æœŸèŒƒå›´çš„æ–‡æ¡£æœç´¢ã€‚

```sql
-- æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ–‡æ¡£ç®¡ç†ç³»ç»Ÿæœç´¢ï¼šå…¨æ–‡æœç´¢ + æ ‡ç­¾è¿‡æ»¤ + æ—¥æœŸèŒƒå›´
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    d.id,
    d.title,
    d.content,
    d.tags,
    d.created_at,
    ts_rank(to_tsvector('english', d.title || ' ' || d.content), query) AS relevance_score,
    ts_headline('english', d.content, query) AS highlighted_content
FROM documents d,
     to_tsquery('english', 'project & report') AS query
WHERE to_tsvector('english', d.title || ' ' || d.content) @@ query
  AND d.created_at >= '2024-01-01'
  AND 'important' = ANY(d.tags)
ORDER BY relevance_score DESC, d.created_at DESC
LIMIT 10;
```

### 5.4 æ—¥å¿—æœç´¢åˆ†æ

**æ—¥å¿—æœç´¢åˆ†æ**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æœç´¢å’Œåˆ†ææ—¥å¿—æ–‡ä»¶ã€‚

```sql
-- æ—¥å¿—æœç´¢åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'log_entries') THEN
            RAISE WARNING 'è¡¨ log_entries ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ—¥å¿—æœç´¢åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ—¥å¿—æœç´¢åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ—¥å¿—æœç´¢åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ—¥å¿—æœç´¢åˆ†æï¼šæ­£åˆ™è¡¨è¾¾å¼æœç´¢ + æ—¶é—´èŒƒå›´ + é”™è¯¯çº§åˆ«
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    id,
    log_level,
    message,
    timestamp,
    -- æå–IPåœ°å€
    (regexp_match(message, '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'))[1] AS ip_address,
    -- æå–é”™è¯¯ä»£ç 
    (regexp_match(message, 'ERROR\s+(\d+)'))[1] AS error_code
FROM log_entries
WHERE message ~* 'error|exception|failed'
  AND timestamp >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
  AND log_level IN ('ERROR', 'WARN')
ORDER BY timestamp DESC
LIMIT 100;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 æœç´¢æ–¹æ³•å¯¹æ¯”

| æœç´¢æ–¹æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|-----------|-----------|---------|------|------|
| **å…¨æ–‡æœç´¢** | $D \bowtie_q \text{tsquery}$ | $O(\log n)$ | $O(n)$ | å…³é”®è¯æœç´¢ | å¿«é€Ÿã€æ”¯æŒæ’å | éœ€è¦ç´¢å¼• |
| **æ¨¡ç³Šæœç´¢** | $\text{similarity}(d, q) > \theta$ | $O(n)$ | $O(1)$ | æ‹¼å†™å®¹é”™ | å®¹é”™æ€§å¼º | æ€§èƒ½è¾ƒæ…¢ |
| **æ­£åˆ™æœç´¢** | $d \sim q$ | $O(n)$ | $O(1)$ | å¤æ‚æ¨¡å¼ | çµæ´» | æ€§èƒ½æœ€æ…¢ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - å…¨æ–‡æœç´¢ï¼šä½¿ç”¨GINç´¢å¼•
   - æ¨¡ç³Šæœç´¢ï¼šä½¿ç”¨Trigramç´¢å¼•
   - æ­£åˆ™æœç´¢ï¼šä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•ï¼ˆå¦‚æœæ¨¡å¼å›ºå®šï¼‰

2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°
   - ç»„åˆå¤šç§æœç´¢æ–¹å¼
   - ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶é¡ºåº

3. **é…ç½®ä¼˜åŒ–**ï¼š
   - é€‰æ‹©åˆé€‚çš„è¯­è¨€é…ç½®
   - è°ƒæ•´work_memé…ç½®
   - ä½¿ç”¨è¿æ¥æ± 

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šå…¨æ–‡æœç´¢æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºGINç´¢å¼•ã€ä½¿ç”¨LIMITã€ä¼˜åŒ–æŸ¥è¯¢

**é—®é¢˜2**ï¼šæ¨¡ç³Šæœç´¢ä¸å‡†ç¡®

- **è§£å†³æ–¹æ¡ˆ**ï¼šè°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼ã€ä½¿ç”¨Trigramç´¢å¼•

**é—®é¢˜3**ï¼šæ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½å·®

- **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼ã€ä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•ã€é¿å…å¤æ‚æ¨¡å¼

**é—®é¢˜4**ï¼šæœç´¢ç»“æœä¸ç›¸å…³

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ts_rankæ’åã€è°ƒæ•´æŸ¥è¯¢æƒé‡ã€ä¼˜åŒ–åœç”¨è¯

---

## 8. æœ€ä½³å®è·µ

### 7.1 æœç´¢ç­–ç•¥é€‰æ‹©

1. **ç²¾ç¡®æœç´¢**ï¼šä½¿ç”¨ç­‰å€¼æŸ¥è¯¢æˆ–å…¨æ–‡æœç´¢
2. **æ¨¡ç³Šæœç´¢**ï¼šä½¿ç”¨ç›¸ä¼¼åº¦å‡½æ•°å’ŒTrigramç´¢å¼•
3. **æ¨¡å¼æœç´¢**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼

### 7.2 ç´¢å¼•è®¾è®¡

1. **å…¨æ–‡æœç´¢**ï¼šåˆ›å»ºGINç´¢å¼•
2. **æ¨¡ç³Šæœç´¢**ï¼šåˆ›å»ºTrigramç´¢å¼•
3. **ç»„åˆæœç´¢**ï¼šåˆ›å»ºå¤šä¸ªç´¢å¼•

### 7.3 æŸ¥è¯¢ä¼˜åŒ–

1. **ä½¿ç”¨ç´¢å¼•**ï¼šç¡®ä¿æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
2. **é™åˆ¶ç»“æœ**ï¼šä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°
3. **ä¼˜åŒ–æ¡ä»¶**ï¼šå°†é€‰æ‹©æ€§é«˜çš„æ¡ä»¶æ”¾åœ¨å‰é¢

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **è¯­è¨€é…ç½®**ï¼šé€‰æ‹©åˆé€‚çš„è¯­è¨€é…ç½®
2. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨å¤§æ•°æ®é›†ä¸Šä½¿ç”¨å¤æ‚æ­£åˆ™è¡¨è¾¾å¼
3. **ç»“æœæ’å**ï¼šä½¿ç”¨ts_rankæä¾›ç›¸å…³æ€§æ’å
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼å’ŒæŸ¥è¯¢

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ–‡æœ¬æœç´¢çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«æ–‡æœ¬æœç´¢è¡¨è¾¾å¼çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºåˆ†é¡µæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æ–‡æœ¬æ•°æ®çš„æœç´¢ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡æœç´¢å’Œèšåˆæ“ä½œ

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - æ–‡æœ¬æœç´¢æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡å…¨æ–‡æœç´¢å’Œæ¨¡ç³Šæœç´¢

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–æ–‡æœ¬æœç´¢æŸ¥è¯¢**

```sql
-- ä¸ºæ–‡æœ¬æœç´¢åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_text_search_skip_scan
ON documents USING btree (ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')));

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ’åæœ€é«˜çš„æ–‡æ¡£
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) AS rank
FROM documents
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
ORDER BY rank DESC
LIMIT 10;
```

**ç¤ºä¾‹ï¼šä½¿ç”¨å¼‚æ­¥I/Oè¿›è¡Œæ‰¹é‡æ–‡æœ¬æœç´¢**

```sql
-- å¯ç”¨å¼‚æ­¥I/Oè¿›è¡Œæ‰¹é‡æ–‡æœ¬æœç´¢
SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;
SET parallel_tuple_cost = 0.0001;
SET enable_async_append = ON;

-- æ‰¹é‡æœç´¢ï¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ–‡æœ¬æœç´¢æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) AS rank
FROM documents
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
ORDER BY rank DESC;
```

### 7.6 é«˜çº§æœç´¢ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æœç´¢ç»“æœ**

å¯¹äºé¢‘ç¹æœç´¢çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜æœç´¢ç»“æœï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨æœç´¢çš„æœç´¢ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS popular_search_results AS
SELECT
    query_term,
    id,
    title,
    content,
    ts_rank(to_tsvector('english', content), to_tsquery('english', query_term)) AS rank
FROM documents,
     (SELECT unnest(ARRAY['keyword1', 'keyword2', 'keyword3']) AS query_term) AS queries
WHERE to_tsvector('english', content) @@ to_tsquery('english', query_term);

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_popular_search_query ON popular_search_results
USING btree (query_term, rank DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY popular_search_results;
```

**2. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ç‰¹å®šæœç´¢åœºæ™¯**

ä¸ºç‰¹å®šæœç´¢åœºæ™¯åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼š

```sql
-- ä¸ºæ´»è·ƒæ–‡æ¡£åˆ›å»ºéƒ¨åˆ†å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_active_documents_search
ON documents USING GIN (to_tsvector('english', content))
WHERE status = 'active' AND created_at > NOW() - INTERVAL '1 year';

-- ä¸ºçƒ­é—¨ç±»åˆ«åˆ›å»ºéƒ¨åˆ†ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_hot_categories_search
ON products USING GIN (to_tsvector('english', name || ' ' || description))
WHERE category IN ('electronics', 'clothing', 'books') AND sales_count > 100;
```

**3. ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–æœç´¢ç»“æœæ’å**

ä½¿ç”¨çª—å£å‡½æ•°é¿å…é‡å¤è®¡ç®—æ’åï¼š

```sql
-- ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–æœç´¢ç»“æœæ’å
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH search_results AS (
    SELECT
        id,
        title,
        content,
        category,
        ts_rank(to_tsvector('english', content), to_tsquery('english', 'keyword')) AS global_rank
    FROM documents
    WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword')
)
SELECT
    id,
    title,
    content,
    category,
    global_rank,
    -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç±»åˆ«å†…æ’åï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
    ROW_NUMBER() OVER (PARTITION BY category ORDER BY global_rank DESC) AS category_rank,
    -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç™¾åˆ†æ¯”æ’å
    PERCENT_RANK() OVER (ORDER BY global_rank DESC) AS percentile_rank
FROM search_results
ORDER BY global_rank DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šä¿¡æ¯æ£€ç´¢å¯¼è®ºã€‹ï¼ˆIntroduction to Information Retrievalï¼‰- æ–‡æœ¬æœç´¢ç†è®º
- ã€Šå…¨æ–‡æœç´¢å¼•æ“åŸç†ä¸å®è·µã€‹- å…¨æ–‡æœç´¢å®ç°

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [pg_trgmæ‰©å±•](https://www.postgresql.org/docs/current/pgtrgm.html)
- [æ­£åˆ™è¡¨è¾¾å¼](https://www.postgresql.org/docs/current/functions-matching.html)

### åœ¨çº¿èµ„æº

- PostgreSQLå…¨æ–‡æœç´¢æŒ‡å—
- æ–‡æœ¬æœç´¢æœ€ä½³å®è·µ
- æœç´¢å¼•æ“ä¼˜åŒ–æŠ€æœ¯

### ç›¸å…³ç®—æ³•

- [æœç´¢ç®—æ³•](../03-æ•°æ®å¤„ç†ç®—æ³•/æœç´¢ç®—æ³•.md) - é€šç”¨æœç´¢ç®—æ³•
- [æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—](./æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—.md) - ç›¸ä¼¼åº¦è®¡ç®—
- [æ–‡æœ¬åˆ†ç±»ç®—æ³•](./æ–‡æœ¬åˆ†ç±»ç®—æ³•.md) - æ–‡æœ¬åˆ†ç±»

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
