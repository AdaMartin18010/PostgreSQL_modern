# PostgreSQL æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ–‡æœ¬æŒ–æ˜ | å…³é”®è¯æå–
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°](#æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ–‡æœ¬æŒ–æ˜é—®é¢˜å®šä¹‰](#æ–‡æœ¬æŒ–æ˜é—®é¢˜å®šä¹‰)
      - [æŒ–æ˜ç®—æ³•åˆ†ç±»](#æŒ–æ˜ç®—æ³•åˆ†ç±»)
      - [æŒ–æ˜ç­–ç•¥é€‰æ‹©](#æŒ–æ˜ç­–ç•¥é€‰æ‹©)
    - [æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½](#æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½)
  - [1. å…³é”®è¯æå–](#1-å…³é”®è¯æå–)
    - [1.1 å…³é”®è¯æå–åŸç†](#11-å…³é”®è¯æå–åŸç†)
      - [å…³é”®è¯å®šä¹‰](#å…³é”®è¯å®šä¹‰)
      - [æå–æ–¹æ³•](#æå–æ–¹æ³•)
    - [1.2 é«˜é¢‘è¯æå–å®ç°](#12-é«˜é¢‘è¯æå–å®ç°)
    - [1.3 TF-IDFå…³é”®è¯æå–](#13-tf-idfå…³é”®è¯æå–)
    - [1.4 å…³é”®è¯è¿‡æ»¤](#14-å…³é”®è¯è¿‡æ»¤)
  - [2. è¯é¢‘ç»Ÿè®¡](#2-è¯é¢‘ç»Ÿè®¡)
    - [2.1 è¯é¢‘ç»Ÿè®¡åŸç†](#21-è¯é¢‘ç»Ÿè®¡åŸç†)
      - [è¯é¢‘å®šä¹‰](#è¯é¢‘å®šä¹‰)
      - [ç»Ÿè®¡æ–¹æ³•](#ç»Ÿè®¡æ–¹æ³•)
    - [2.2 æ–‡æ¡£è¯é¢‘ç»Ÿè®¡å®ç°](#22-æ–‡æ¡£è¯é¢‘ç»Ÿè®¡å®ç°)
    - [2.3 å…¨å±€è¯é¢‘ç»Ÿè®¡](#23-å…¨å±€è¯é¢‘ç»Ÿè®¡)
    - [2.4 è¯é¢‘åˆ†å¸ƒåˆ†æ](#24-è¯é¢‘åˆ†å¸ƒåˆ†æ)
  - [3. TF-IDFè®¡ç®—](#3-tf-idfè®¡ç®—)
    - [3.1 TF-IDFåŸç†](#31-tf-idfåŸç†)
      - [TF-IDFå®šä¹‰](#tf-idfå®šä¹‰)
      - [TF-IDFå…¬å¼](#tf-idfå…¬å¼)
    - [3.2 TF-IDFè¯„åˆ†å®ç°](#32-tf-idfè¯„åˆ†å®ç°)
    - [3.3 TF-IDFä¼˜åŒ–](#33-tf-idfä¼˜åŒ–)
  - [4. åŸºäºå‘é‡çš„ä¸»é¢˜èšç±»ï¼ˆpgvectorï¼‰](#4-åŸºäºå‘é‡çš„ä¸»é¢˜èšç±»pgvector)
    - [4.1 å‘é‡ä¸»é¢˜èšç±»æ¦‚è¿°](#41-å‘é‡ä¸»é¢˜èšç±»æ¦‚è¿°)
      - [å‘é‡ä¸»é¢˜èšç±»åŸç†](#å‘é‡ä¸»é¢˜èšç±»åŸç†)
      - [pgvectoræ‰©å±•å®‰è£…](#pgvectoræ‰©å±•å®‰è£…)
    - [4.2 å‘é‡ä¸»é¢˜èšç±»å®ç°](#42-å‘é‡ä¸»é¢˜èšç±»å®ç°)
  - [5. ä¸»é¢˜å»ºæ¨¡](#5-ä¸»é¢˜å»ºæ¨¡)
    - [5.1 ä¸»é¢˜å»ºæ¨¡åŸç†](#51-ä¸»é¢˜å»ºæ¨¡åŸç†)
      - [ä¸»é¢˜å®šä¹‰](#ä¸»é¢˜å®šä¹‰)
      - [LDAæ¨¡å‹](#ldaæ¨¡å‹)
    - [5.2 ç®€å•ä¸»é¢˜æå–](#52-ç®€å•ä¸»é¢˜æå–)
  - [5. æ–‡æœ¬æŒ–æ˜ä¼˜åŒ–ç­–ç•¥](#5-æ–‡æœ¬æŒ–æ˜ä¼˜åŒ–ç­–ç•¥)
    - [5.1 ç´¢å¼•ä¼˜åŒ–](#51-ç´¢å¼•ä¼˜åŒ–)
    - [5.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–](#52-æ‰¹é‡å¤„ç†ä¼˜åŒ–)
    - [5.3 å¹¶è¡Œè®¡ç®—ä¼˜åŒ–](#53-å¹¶è¡Œè®¡ç®—ä¼˜åŒ–)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 ä¸»é¢˜å…³é”®è¯æå–](#61-ä¸»é¢˜å…³é”®è¯æå–)
    - [6.2 æ–‡æ¡£æ‘˜è¦ç”Ÿæˆ](#62-æ–‡æ¡£æ‘˜è¦ç”Ÿæˆ)
    - [6.3 çƒ­ç‚¹è¯é¢˜åˆ†æ](#63-çƒ­ç‚¹è¯é¢˜åˆ†æ)
    - [6.4 å†…å®¹æ¨èç³»ç»Ÿ](#64-å†…å®¹æ¨èç³»ç»Ÿ)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [7.1 æŒ–æ˜ç®—æ³•å¯¹æ¯”](#71-æŒ–æ˜ç®—æ³•å¯¹æ¯”)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#73-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 ç®—æ³•é€‰æ‹©](#81-ç®—æ³•é€‰æ‹©)
    - [8.2 å‚æ•°è°ƒä¼˜](#82-å‚æ•°è°ƒä¼˜)
    - [8.3 æ€§èƒ½ä¼˜åŒ–](#83-æ€§èƒ½ä¼˜åŒ–)
    - [8.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#84-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°

**æ–‡æœ¬æŒ–æ˜ç®—æ³•ï¼ˆText Mining Algorithmï¼‰**ç”¨äºä»æ–‡æœ¬ä¸­æå–æœ‰ç”¨ä¿¡æ¯ï¼Œå¦‚å…³é”®è¯ã€ä¸»é¢˜ã€æ¨¡å¼ç­‰ã€‚æ–‡æœ¬æŒ–æ˜æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¿¡æ¯æ£€ç´¢çš„é‡è¦åˆ†æ”¯ã€‚

### ç†è®ºåŸºç¡€

#### æ–‡æœ¬æŒ–æ˜é—®é¢˜å®šä¹‰

**æ–‡æœ¬æŒ–æ˜é—®é¢˜**ï¼šç»™å®šæ–‡æœ¬é›†åˆ$D = \{d_1, d_2, \ldots, d_n\}$ï¼Œæå–æœ‰ç”¨ä¿¡æ¯ï¼š

- **å…³é”®è¯**ï¼š$K = \{k_1, k_2, \ldots, k_m\}$
- **ä¸»é¢˜**ï¼š$T = \{t_1, t_2, \ldots, t_k\}$
- **æ¨¡å¼**ï¼š$P = \{p_1, p_2, \ldots, p_l\}$

**æŒ–æ˜ä»»åŠ¡**ï¼š

1. **å…³é”®è¯æå–**ï¼šä»æ–‡æœ¬ä¸­æå–é‡è¦å…³é”®è¯
2. **ä¸»é¢˜å»ºæ¨¡**ï¼šå‘ç°æ–‡æœ¬çš„ä¸»é¢˜åˆ†å¸ƒ
3. **æ¨¡å¼å‘ç°**ï¼šå‘ç°æ–‡æœ¬ä¸­çš„æ¨¡å¼

#### æŒ–æ˜ç®—æ³•åˆ†ç±»

æ–‡æœ¬æŒ–æ˜ç®—æ³•åˆ†ç±»ï¼š

1. **åŸºäºé¢‘ç‡**ï¼š
   - è¯é¢‘ç»Ÿè®¡
   - é«˜é¢‘è¯æå–
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

2. **åŸºäºé‡è¦æ€§**ï¼š
   - TF-IDFè®¡ç®—
   - å…³é”®è¯è¯„åˆ†
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$

3. **åŸºäºä¸»é¢˜**ï¼š
   - ä¸»é¢˜å»ºæ¨¡ï¼ˆLDAç­‰ï¼‰
   - ä¸»é¢˜æå–
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(n \times k)$ï¼ˆ$k$ä¸ºä¸»é¢˜æ•°ï¼‰

#### æŒ–æ˜ç­–ç•¥é€‰æ‹©

é€‰æ‹©æŒ–æ˜ç­–ç•¥çš„è€ƒè™‘å› ç´ ï¼š

1. **æ•°æ®è§„æ¨¡**ï¼šå°æ•°æ®é›†ç”¨ç®€å•æ–¹æ³•ï¼Œå¤§æ•°æ®é›†ç”¨é«˜æ•ˆç®—æ³•
2. **ç²¾åº¦è¦æ±‚**ï¼šé«˜ç²¾åº¦ç”¨TF-IDFï¼Œå¿«é€Ÿæå–ç”¨è¯é¢‘
3. **åº”ç”¨åœºæ™¯**ï¼šå…³é”®è¯æå–ã€ä¸»é¢˜å‘ç°ã€æ¨¡å¼è¯†åˆ«

### æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½

| åŠŸèƒ½ | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **å…³é”®è¯æå–** | $K = \{k_i \mid \text{score}(k_i) > \theta\}$ | æå–å…³é”®è¯ | $O(n)$ | $O(n)$ | æ–‡æ¡£æ‘˜è¦ |
| **è¯é¢‘ç»Ÿè®¡** | $\text{tf}(w, d) = \frac{\text{count}(w, d)}{|d|}$ | ç»Ÿè®¡è¯é¢‘ | $O(n)$ | $O(n)$ | æ–‡æœ¬åˆ†æ |
| **TF-IDF** | $\text{tf-idf}(w, d) = \text{tf}(w, d) \times \text{idf}(w)$ | é‡è¦æ€§è¯„åˆ† | $O(n)$ | $O(n)$ | å…³é”®è¯æå– |

---

## 1. å…³é”®è¯æå–

### 1.1 å…³é”®è¯æå–åŸç†

**å…³é”®è¯æå–ï¼ˆKeyword Extractionï¼‰**æ˜¯ä»æ–‡æœ¬ä¸­æå–é‡è¦å…³é”®è¯çš„è¿‡ç¨‹ã€‚

#### å…³é”®è¯å®šä¹‰

**å…³é”®è¯**ï¼šå…³é”®è¯$k$æ˜¯æ–‡æœ¬ä¸­çš„é‡è¦è¯ï¼Œæ»¡è¶³ï¼š
$$\text{score}(k) > \theta$$

å…¶ä¸­$\text{score}(k)$æ˜¯å…³é”®è¯çš„è¯„åˆ†ï¼Œ$\theta$æ˜¯é˜ˆå€¼ã€‚

#### æå–æ–¹æ³•

**å…³é”®è¯æå–æ–¹æ³•**ï¼š

1. **è¯é¢‘æ–¹æ³•**ï¼šé€‰æ‹©é«˜é¢‘è¯
2. **TF-IDFæ–¹æ³•**ï¼šé€‰æ‹©TF-IDFå€¼é«˜çš„è¯
3. **ä½ç½®æ–¹æ³•**ï¼šé€‰æ‹©å‡ºç°åœ¨æ ‡é¢˜ã€æ‘˜è¦ç­‰ä½ç½®çš„è¯
4. **ç»„åˆæ–¹æ³•**ï¼šç»„åˆå¤šç§æ–¹æ³•

### 1.2 é«˜é¢‘è¯æå–å®ç°

**é«˜é¢‘è¯æå–**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- å…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH word_frequencies AS (
    SELECT
        unnest(string_to_array(lower(content), ' ')) AS word,
        COUNT(*) AS frequency
    FROM documents
    GROUP BY unnest(string_to_array(lower(content), ' '))
    HAVING length(unnest(string_to_array(lower(content), ' '))) > 3  -- è¿‡æ»¤çŸ­è¯
)
SELECT
    word,
    frequency,
    frequency * 100.0 / SUM(frequency) OVER () AS frequency_pct
FROM word_frequencies
ORDER BY frequency DESC
LIMIT 50;
```

---

### 1.3 TF-IDFå…³é”®è¯æå–

**TF-IDFå…³é”®è¯æå–**ï¼šä½¿ç”¨TF-IDFå€¼æå–å…³é”®è¯ã€‚

```sql
-- TF-IDFå…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒTF-IDFå…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒTF-IDFå…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'TF-IDFå…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- TF-IDFå…³é”®è¯æå–ï¼šæå–æ¯ä¸ªæ–‡æ¡£çš„Top Nå…³é”®è¯
WITH document_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 3
),
term_frequency AS (
    SELECT
        id,
        word,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM document_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM document_words
    GROUP BY word
),
total_documents AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM documents
),
tf_idf_scores AS (
    SELECT
        tf.id,
        tf.word,
        tf.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf
    FROM term_frequency tf
    JOIN document_frequency df ON tf.word = df.word
    CROSS JOIN total_documents td
)
SELECT
    id,
    word,
    tf_idf
FROM (
    SELECT
        id,
        word,
        tf_idf,
        ROW_NUMBER() OVER (PARTITION BY id ORDER BY tf_idf DESC) AS rn
    FROM tf_idf_scores
) AS ranked
WHERE rn <= 10  -- Top 10å…³é”®è¯
ORDER BY id, tf_idf DESC;
```

### 1.4 å…³é”®è¯è¿‡æ»¤

**å…³é”®è¯è¿‡æ»¤**ï¼šè¿‡æ»¤åœç”¨è¯å’Œæ— æ„ä¹‰è¯ã€‚

```sql
-- å…³é”®è¯è¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºåœç”¨è¯è¡¨
        CREATE TABLE IF NOT EXISTS stop_words (
            word TEXT PRIMARY KEY
        );

        -- æ’å…¥å¸¸è§åœç”¨è¯
        INSERT INTO stop_words (word) VALUES
            ('the'), ('a'), ('an'), ('and'), ('or'), ('but'), ('in'), ('on'), ('at'), ('to'), ('for'), ('of'), ('with'), ('by')
        ON CONFLICT (word) DO NOTHING;

        RAISE NOTICE 'åœç”¨è¯è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åœç”¨è¯è¡¨åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è¿‡æ»¤åœç”¨è¯çš„å…³é”®è¯æå–
SELECT
    word,
    COUNT(*) AS frequency
FROM (
    SELECT unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
) AS expanded
WHERE length(word) > 3
  AND word NOT IN (SELECT word FROM stop_words)
GROUP BY word
ORDER BY frequency DESC
LIMIT 50;
```

---

## 2. è¯é¢‘ç»Ÿè®¡

### 2.1 è¯é¢‘ç»Ÿè®¡åŸç†

**è¯é¢‘ç»Ÿè®¡ï¼ˆTerm Frequency Statisticsï¼‰**æ˜¯ç»Ÿè®¡æ–‡æœ¬ä¸­è¯çš„å‡ºç°é¢‘ç‡ã€‚

#### è¯é¢‘å®šä¹‰

**è¯é¢‘ï¼ˆTerm Frequency, TFï¼‰**ï¼šè¯$w$åœ¨æ–‡æ¡£$d$ä¸­çš„é¢‘ç‡ï¼š
$$\text{tf}(w, d) = \frac{\text{count}(w, d)}{|d|}$$

å…¶ä¸­ï¼š

- $\text{count}(w, d)$ï¼šè¯$w$åœ¨æ–‡æ¡£$d$ä¸­çš„å‡ºç°æ¬¡æ•°
- $|d|$ï¼šæ–‡æ¡£$d$çš„æ€»è¯æ•°

#### ç»Ÿè®¡æ–¹æ³•

**è¯é¢‘ç»Ÿè®¡æ–¹æ³•**ï¼š

1. **æ–‡æ¡£è¯é¢‘**ï¼šç»Ÿè®¡æ¯ä¸ªæ–‡æ¡£ä¸­çš„è¯é¢‘
2. **å…¨å±€è¯é¢‘**ï¼šç»Ÿè®¡æ•´ä¸ªè¯­æ–™åº“ä¸­çš„è¯é¢‘
3. **ç›¸å¯¹è¯é¢‘**ï¼šè¯é¢‘ç›¸å¯¹äºæ€»è¯æ•°çš„æ¯”ä¾‹

### 2.2 æ–‡æ¡£è¯é¢‘ç»Ÿè®¡å®ç°

**æ–‡æ¡£è¯é¢‘ç»Ÿè®¡**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- è¯é¢‘ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¯é¢‘ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè¯é¢‘ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯é¢‘ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    id,
    word,
    COUNT(*) AS word_count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (PARTITION BY id) AS word_frequency_pct
FROM (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
) AS expanded
GROUP BY id, word
ORDER BY id, word_count DESC;
```

---

### 2.3 å…¨å±€è¯é¢‘ç»Ÿè®¡

**å…¨å±€è¯é¢‘ç»Ÿè®¡**ï¼šç»Ÿè®¡æ•´ä¸ªè¯­æ–™åº“ä¸­çš„è¯é¢‘ã€‚

```sql
-- å…¨å±€è¯é¢‘ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…¨å±€è¯é¢‘ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨å±€è¯é¢‘ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…¨å±€è¯é¢‘ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å…¨å±€è¯é¢‘ç»Ÿè®¡ï¼šç»Ÿè®¡æ‰€æœ‰æ–‡æ¡£ä¸­çš„è¯é¢‘
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    word,
    COUNT(*) AS global_frequency,
    COUNT(DISTINCT id) AS document_frequency,
    COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER () AS global_frequency_pct
FROM (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 3
) AS expanded
GROUP BY word
ORDER BY global_frequency DESC
LIMIT 100;
```

### 2.4 è¯é¢‘åˆ†å¸ƒåˆ†æ

**è¯é¢‘åˆ†å¸ƒåˆ†æ**ï¼šåˆ†æè¯é¢‘çš„åˆ†å¸ƒç‰¹å¾ã€‚

```sql
-- è¯é¢‘åˆ†å¸ƒåˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¯é¢‘åˆ†å¸ƒåˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè¯é¢‘åˆ†å¸ƒåˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯é¢‘åˆ†å¸ƒåˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è¯é¢‘åˆ†å¸ƒåˆ†æï¼šZipfå®šå¾‹éªŒè¯
WITH word_frequencies AS (
    SELECT
        word,
        COUNT(*) AS frequency
    FROM (
        SELECT unnest(string_to_array(lower(content), ' ')) AS word
        FROM documents
    ) AS expanded
    GROUP BY word
),
ranked_words AS (
    SELECT
        word,
        frequency,
        ROW_NUMBER() OVER (ORDER BY frequency DESC) AS rank
    FROM word_frequencies
)
SELECT
    rank,
    word,
    frequency,
    frequency::NUMERIC / (SELECT MAX(frequency) FROM word_frequencies) AS normalized_frequency,
    1.0 / rank AS zipf_prediction
FROM ranked_words
ORDER BY rank
LIMIT 50;
```

---

## 3. TF-IDFè®¡ç®—

### 3.1 TF-IDFåŸç†

**TF-IDFï¼ˆTerm Frequency-Inverse Document Frequencyï¼‰**æ˜¯è¡¡é‡è¯åœ¨æ–‡æ¡£é›†åˆä¸­é‡è¦æ€§çš„ç»å…¸æ–¹æ³•ã€‚

#### TF-IDFå®šä¹‰

**TF-IDF**ï¼šè¯$w$åœ¨æ–‡æ¡£$d$ä¸­çš„TF-IDFå€¼ä¸ºï¼š
$$\text{tf-idf}(w, d) = \text{tf}(w, d) \times \text{idf}(w)$$

å…¶ä¸­ï¼š

- **TFï¼ˆTerm Frequencyï¼‰**ï¼š$\text{tf}(w, d) = \frac{\text{count}(w, d)}{|d|}$
- **IDFï¼ˆInverse Document Frequencyï¼‰**ï¼š$\text{idf}(w) = \ln\left(\frac{N}{\text{df}(w)}\right)$
  - $N$ï¼šæ–‡æ¡£æ€»æ•°
  - $\text{df}(w)$ï¼šåŒ…å«è¯$w$çš„æ–‡æ¡£æ•°

#### TF-IDFå…¬å¼

**TF-IDFå…¬å¼**ï¼š
$$\text{tf-idf}(w, d) = \frac{\text{count}(w, d)}{|d|} \times \ln\left(\frac{N}{\text{df}(w)}\right)$$

**æ€§è´¨**ï¼š

- TF-IDFå€¼è¶Šé«˜ï¼Œè¯è¶Šé‡è¦
- å¸¸è§è¯ï¼ˆé«˜DFï¼‰çš„IDFå€¼ä½
- ç¨€æœ‰è¯ï¼ˆä½DFï¼‰çš„IDFå€¼é«˜

### 3.2 TF-IDFè¯„åˆ†å®ç°

**TF-IDFè¯„åˆ†**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- TF-IDFè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒTF-IDFè®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒTF-IDFè®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'TF-IDFè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH document_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
),
term_frequency AS (
    SELECT
        id,
        word,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM document_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM document_words
    GROUP BY word
),
total_documents AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM documents
)
SELECT
    tf.id,
    tf.word,
    tf.tf,
    df.df,
    td.total,
    LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS idf,
    tf.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf
FROM term_frequency tf
JOIN document_frequency df ON tf.word = df.word
CROSS JOIN total_documents td
ORDER BY tf.id, tf_idf DESC;
```

---

### 3.3 TF-IDFä¼˜åŒ–

**TF-IDFä¼˜åŒ–**ï¼šä¼˜åŒ–TF-IDFè®¡ç®—æ€§èƒ½ã€‚

```sql
-- TF-IDFä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ä¸­é—´ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS document_word_tf AS
SELECT
    id,
    word,
    COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
FROM (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
) AS expanded
GROUP BY id, word;

CREATE INDEX IF NOT EXISTS idx_document_word_tf_id_word
ON document_word_tf(id, word);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY document_word_tf;
```

---

## 4. åŸºäºå‘é‡çš„ä¸»é¢˜èšç±»ï¼ˆpgvectorï¼‰

### 4.1 å‘é‡ä¸»é¢˜èšç±»æ¦‚è¿°

**åŸºäºå‘é‡çš„ä¸»é¢˜èšç±»ï¼ˆVector-based Topic Clusteringï¼‰**ï¼šä½¿ç”¨pgvectoræ‰©å±•è¿›è¡Œè¯­ä¹‰çº§åˆ«çš„æ–‡æ¡£èšç±»ï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦å‘ç°æ–‡æ¡£ä¸»é¢˜ã€‚

#### å‘é‡ä¸»é¢˜èšç±»åŸç†

**å‘é‡ä¸»é¢˜èšç±»**ï¼šå°†æ–‡æ¡£è½¬æ¢ä¸ºå‘é‡åµŒå…¥ï¼ˆembeddingï¼‰ï¼Œé€šè¿‡è®¡ç®—å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œä¸»é¢˜èšç±»ã€‚

**å‘é‡ä¸»é¢˜èšç±»ä¼˜åŠ¿**ï¼š

- è¯­ä¹‰ç†è§£èƒ½åŠ›å¼º
- è‡ªåŠ¨å‘ç°ä¸»é¢˜
- å¯ä»¥ç»“åˆé¢„è®­ç»ƒæ¨¡å‹

#### pgvectoræ‰©å±•å®‰è£…

```sql
-- å®‰è£…pgvectoræ‰©å±•ï¼ˆéœ€è¦PostgreSQL 11+ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'pgvectoræ‰©å±•å®‰è£…å¤±è´¥: %ã€‚è¯·ç¡®ä¿å·²å®‰è£…pgvectoræ‰©å±•ã€‚', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 å‘é‡ä¸»é¢˜èšç±»å®ç°

**åˆ›å»ºæ–‡æ¡£å‘é‡è¡¨**ï¼š

```sql
-- åˆ›å»ºæ–‡æ¡£å‘é‡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_vectors') THEN
            RAISE WARNING 'è¡¨ document_vectors å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE document_vectors CASCADE;
        END IF;

        -- åˆ›å»ºåŒ…å«å‘é‡åµŒå…¥çš„æ–‡æ¡£è¡¨
        CREATE TABLE document_vectors (
            id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            -- ä½¿ç”¨vectorç±»å‹å­˜å‚¨1536ç»´å‘é‡ï¼ˆOpenAI text-embedding-3-largeï¼‰
            embedding vector(1536),
            topic_cluster INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- åˆ›å»ºå‘é‡ç›¸ä¼¼åº¦ç´¢å¼•ï¼ˆHNSWç´¢å¼•ï¼ŒPostgreSQL 18+ï¼‰
        CREATE INDEX idx_document_vectors_vector
        ON document_vectors
        USING hnsw (embedding vector_cosine_ops)
        WITH (m = 16, ef_construction = 64);

        RAISE NOTICE 'æ–‡æ¡£å‘é‡è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ–‡æ¡£å‘é‡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„ä¸»é¢˜èšç±»**ï¼š

```sql
-- å‘é‡ä¸»é¢˜èšç±»ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦èšç±»æ–‡æ¡£ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_vectors') THEN
            RAISE WARNING 'è¡¨ document_vectors ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‘é‡ä¸»é¢˜èšç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‘é‡ä¸»é¢˜èšç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡ä¸»é¢˜èšç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å‘é‡ä¸»é¢˜èšç±»ï¼šä½¿ç”¨K-meansæ€æƒ³è¿›è¡Œèšç±»
WITH document_similarities AS (
    SELECT
        d1.id AS doc1_id,
        d2.id AS doc2_id,
        1 - (d1.embedding <=> d2.embedding) AS similarity
    FROM document_vectors d1
    JOIN document_vectors d2 ON d1.id < d2.id
    WHERE d1.embedding IS NOT NULL AND d2.embedding IS NOT NULL
),
-- æ‰¾åˆ°æ¯ä¸ªæ–‡æ¡£çš„æœ€ç›¸ä¼¼æ–‡æ¡£
nearest_neighbors AS (
    SELECT DISTINCT ON (doc1_id)
        doc1_id,
        doc2_id,
        similarity
    FROM document_similarities
    WHERE similarity > 0.7  -- ç›¸ä¼¼åº¦é˜ˆå€¼
    ORDER BY doc1_id, similarity DESC
),
-- æ„å»ºä¸»é¢˜ç°‡ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”ä½¿ç”¨å®Œæ•´èšç±»ç®—æ³•ï¼‰
topic_clusters AS (
    SELECT
        doc1_id AS document_id,
        DENSE_RANK() OVER (ORDER BY doc2_id) AS cluster_id
    FROM nearest_neighbors
)
-- æ›´æ–°æ–‡æ¡£çš„ä¸»é¢˜ç°‡
UPDATE document_vectors dv
SET topic_cluster = tc.cluster_id
FROM topic_clusters tc
WHERE dv.id = tc.document_id;
```

**ä¸»é¢˜èšç±»ç»“æœåˆ†æ**ï¼š

```sql
-- ä¸»é¢˜èšç±»ç»“æœåˆ†æï¼šç»Ÿè®¡æ¯ä¸ªä¸»é¢˜çš„æ–‡æ¡£æ•°å’Œå…³é”®è¯
WITH cluster_summary AS (
    SELECT
        topic_cluster,
        COUNT(*) AS document_count,
        AVG(1 - (embedding <=> (SELECT AVG(embedding) FROM document_vectors WHERE topic_cluster = dv.topic_cluster))) AS avg_similarity
    FROM document_vectors dv
    WHERE topic_cluster IS NOT NULL
    GROUP BY topic_cluster
)
SELECT
    cs.topic_cluster,
    cs.document_count,
    ROUND(cs.avg_similarity::numeric, 4) AS avg_similarity,
    -- æå–ä¸»é¢˜å…³é”®è¯ï¼ˆä½¿ç”¨å…¨æ–‡æœç´¢ï¼‰
    (SELECT string_agg(word, ', ' ORDER BY frequency DESC)
     FROM (
         SELECT unnest(string_to_array(lower(content), ' ')) AS word,
                COUNT(*) AS frequency
         FROM document_vectors
         WHERE topic_cluster = cs.topic_cluster
         GROUP BY word
         ORDER BY frequency DESC
         LIMIT 5
     ) AS keywords) AS top_keywords
FROM cluster_summary cs
ORDER BY document_count DESC;
```

---

## 5. ä¸»é¢˜å»ºæ¨¡

### 5.1 ä¸»é¢˜å»ºæ¨¡åŸç†

**ä¸»é¢˜å»ºæ¨¡ï¼ˆTopic Modelingï¼‰**æ˜¯å‘ç°æ–‡æœ¬é›†åˆä¸­æ½œåœ¨ä¸»é¢˜çš„æ–¹æ³•ã€‚

#### ä¸»é¢˜å®šä¹‰

**ä¸»é¢˜**ï¼šä¸»é¢˜$t$æ˜¯è¯çš„åˆ†å¸ƒï¼š$P(w \mid t)$

**æ–‡æ¡£ä¸»é¢˜åˆ†å¸ƒ**ï¼šæ–‡æ¡£$d$çš„ä¸»é¢˜åˆ†å¸ƒï¼š$P(t \mid d)$

#### LDAæ¨¡å‹

**LDAï¼ˆLatent Dirichlet Allocationï¼‰**æ˜¯ç»å…¸çš„ä¸»é¢˜å»ºæ¨¡æ–¹æ³•ï¼š
$$P(w \mid d) = \sum_{t} P(w \mid t) \times P(t \mid d)$$

### 5.2 ç®€å•ä¸»é¢˜æå–

**ç®€å•ä¸»é¢˜æå–**ï¼šä½¿ç”¨å…³é”®è¯èšç±»æå–ä¸»é¢˜ï¼ˆç®€åŒ–ç‰ˆLDAï¼‰ã€‚

```sql
-- ç®€å•ä¸»é¢˜æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç®€å•ä¸»é¢˜æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç®€å•ä¸»é¢˜æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç®€å•ä¸»é¢˜æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç®€å•ä¸»é¢˜æå–ï¼šåŸºäºTF-IDFå’Œå…³é”®è¯èšç±»
WITH document_keywords AS (
    SELECT
        id,
        word,
        tf_idf
    FROM (
        -- TF-IDFè®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰
        SELECT
            id,
            word,
            COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) *
            LN(COUNT(DISTINCT id) OVER ()::NUMERIC / COUNT(DISTINCT id) OVER (PARTITION BY word)) AS tf_idf
        FROM (
            SELECT id, unnest(string_to_array(lower(content), ' ')) AS word
            FROM documents
        ) AS expanded
        GROUP BY id, word
    ) AS tf_idf_calc
    WHERE tf_idf > 0.5
),
top_keywords_per_doc AS (
    SELECT
        id,
        array_agg(word ORDER BY tf_idf DESC) AS keywords
    FROM (
        SELECT
            id,
            word,
            tf_idf,
            ROW_NUMBER() OVER (PARTITION BY id ORDER BY tf_idf DESC) AS rn
        FROM document_keywords
    ) AS ranked
    WHERE rn <= 5
    GROUP BY id
)
SELECT
    id,
    keywords,
    -- ç®€å•ä¸»é¢˜æ ‡ç­¾ï¼ˆåŸºäºå…³é”®è¯ï¼‰
    CASE
        WHEN 'technology' = ANY(keywords) OR 'software' = ANY(keywords) THEN 'Technology'
        WHEN 'business' = ANY(keywords) OR 'finance' = ANY(keywords) THEN 'Business'
        WHEN 'health' = ANY(keywords) OR 'medical' = ANY(keywords) THEN 'Health'
        ELSE 'General'
    END AS topic
FROM top_keywords_per_doc;
```

---

## 5. æ–‡æœ¬æŒ–æ˜ä¼˜åŒ–ç­–ç•¥

### 5.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæ–‡æœ¬æŒ–æ˜åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- GINç´¢å¼•ï¼šå…¨æ–‡æœç´¢
        CREATE INDEX IF NOT EXISTS idx_documents_content_gin
        ON documents USING GIN (to_tsvector('english', content));

        RAISE NOTICE 'æ–‡æœ¬æŒ–æ˜ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–

**æ‰¹é‡å¤„ç†ä¼˜åŒ–**ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ€§èƒ½ã€‚

```sql
-- æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '512MB';
        RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º512MB';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡å¤„ç†ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.3 å¹¶è¡Œè®¡ç®—ä¼˜åŒ–

**å¹¶è¡Œè®¡ç®—ä¼˜åŒ–**ï¼šä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢å¤„ç†å¤§è§„æ¨¡æ•°æ®ã€‚

```sql
-- å¹¶è¡Œè®¡ç®—ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œè®¡ç®—ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 6. PostgreSQL 18 å¹¶è¡Œæ–‡æœ¬æŒ–æ˜å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œæ–‡æœ¬æŒ–æ˜èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œå…³é”®è¯æå–ã€è¯é¢‘ç»Ÿè®¡å’ŒTF-IDFè®¡ç®—ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡æ–‡æœ¬æŒ–æ˜çš„æ€§èƒ½ã€‚

### 6.1 å¹¶è¡Œæ–‡æœ¬æŒ–æ˜åŸç†

PostgreSQL 18 çš„å¹¶è¡Œæ–‡æœ¬æŒ–æ˜é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«ææ–‡æœ¬æ•°æ®
2. **å¹¶è¡Œåˆ†è¯**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹æ‰§è¡Œæ–‡æœ¬åˆ†è¯
3. **å¹¶è¡Œç»Ÿè®¡**ï¼šå¹¶è¡Œæ‰§è¡Œè¯é¢‘ç»Ÿè®¡å’ŒTF-IDFè®¡ç®—
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„æŒ–æ˜ç»“æœ

### 6.2 å¹¶è¡Œå…³é”®è¯æå–

```sql
-- PostgreSQL 18 å¹¶è¡Œå…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œå…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œå…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œå…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œé«˜é¢‘è¯æå–
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH word_frequencies AS (
    SELECT
        unnest(string_to_array(lower(content), ' ')) AS word,
        COUNT(*) AS frequency
    FROM documents
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 3
    GROUP BY unnest(string_to_array(lower(content), ' '))
)
SELECT
    word,
    frequency,
    ROUND(frequency::numeric / SUM(frequency) OVER () * 100, 2) AS frequency_percentage
FROM word_frequencies
ORDER BY frequency DESC
LIMIT 50;
```

### 6.3 å¹¶è¡ŒTF-IDFè®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡ŒTF-IDFè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡ŒTF-IDFè®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡ŒTF-IDFè®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡ŒTF-IDFè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡ŒTF-IDFè®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH document_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 3
),
term_frequencies AS (
    SELECT
        id,
        word,
        COUNT(*) AS tf
    FROM document_words
    GROUP BY id, word
),
document_frequencies AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM document_words
    GROUP BY word
),
total_documents AS (
    SELECT COUNT(DISTINCT id) AS n FROM documents
),
tfidf_scores AS (
    SELECT
        tf.id,
        tf.word,
        tf.tf,
        df.df,
        td.n,
        (tf.tf::numeric / (SELECT COUNT(*) FROM document_words dw2 WHERE dw2.id = tf.id)) *
        LN(td.n::numeric / NULLIF(df.df, 0)) AS tfidf
    FROM term_frequencies tf
    JOIN document_frequencies df ON tf.word = df.word
    CROSS JOIN total_documents td
)
SELECT
    id,
    word,
    ROUND(tfidf::numeric, 4) AS tfidf_score
FROM tfidf_scores
ORDER BY id, tfidf_score DESC
LIMIT 100;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 ä¸»é¢˜å…³é”®è¯æå–

**ä¸»é¢˜å…³é”®è¯æå–**æå–æ–‡æ¡£çš„ä¸»é¢˜å…³é”®è¯ã€‚

```sql
-- ä¸»é¢˜å…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œä¸»é¢˜å…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œä¸»é¢˜å…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸»é¢˜å…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸»é¢˜å…³é”®è¯æå–ï¼šä½¿ç”¨TF-IDFæå–æ¯ä¸ªæ–‡æ¡£çš„Topå…³é”®è¯
WITH article_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM articles
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 4
),
word_stats AS (
    SELECT
        id,
        word,
        COUNT(*) AS word_count,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM article_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM article_words
    GROUP BY word
),
total_docs AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM articles
),
tf_idf_scores AS (
    SELECT
        ws.id,
        ws.word,
        ws.word_count,
        ws.tf,
        df.df,
        ws.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf_score
    FROM word_stats ws
    JOIN document_frequency df ON ws.word = df.word
    CROSS JOIN total_docs td
)
SELECT
    id,
    word,
    tf_idf_score
FROM (
    SELECT
        id,
        word,
        tf_idf_score,
        ROW_NUMBER() OVER (PARTITION BY id ORDER BY tf_idf_score DESC) AS rn
    FROM tf_idf_scores
    WHERE tf_idf_score > 0.5
) AS ranked
WHERE rn <= 10
ORDER BY id, tf_idf_score DESC;
```

### 6.2 æ–‡æ¡£æ‘˜è¦ç”Ÿæˆ

**æ–‡æ¡£æ‘˜è¦ç”Ÿæˆ**ï¼šåŸºäºå…³é”®è¯ç”Ÿæˆæ–‡æ¡£æ‘˜è¦ã€‚

```sql
-- æ–‡æ¡£æ‘˜è¦ç”Ÿæˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ–‡æ¡£æ‘˜è¦ç”Ÿæˆ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ–‡æ¡£æ‘˜è¦ç”Ÿæˆ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ–‡æ¡£æ‘˜è¦ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ–‡æ¡£æ‘˜è¦ç”Ÿæˆï¼šæå–åŒ…å«å…³é”®è¯çš„å¥å­
WITH document_keywords AS (
    SELECT
        id,
        word,
        tf_idf_score
    FROM (
        -- TF-IDFè®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰
        SELECT
            id,
            word,
            COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) *
            LN(COUNT(DISTINCT id) OVER ()::NUMERIC / COUNT(DISTINCT id) OVER (PARTITION BY word)) AS tf_idf_score
        FROM (
            SELECT id, unnest(string_to_array(lower(content), ' ')) AS word
            FROM documents
        ) AS expanded
        GROUP BY id, word
    ) AS tf_idf_calc
    WHERE tf_idf_score > 0.5
),
top_keywords AS (
    SELECT
        id,
        array_agg(word ORDER BY tf_idf_score DESC) AS keywords
    FROM (
        SELECT
            id,
            word,
            tf_idf_score,
            ROW_NUMBER() OVER (PARTITION BY id ORDER BY tf_idf_score DESC) AS rn
        FROM document_keywords
    ) AS ranked
    WHERE rn <= 5
    GROUP BY id
)
SELECT
    d.id,
    d.title,
    -- æå–åŒ…å«å…³é”®è¯çš„å¥å­ä½œä¸ºæ‘˜è¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
    substring(d.content FROM 1 FOR 200) AS summary_preview,
    tk.keywords AS key_terms
FROM documents d
JOIN top_keywords tk ON d.id = tk.id
ORDER BY d.id;
```

### 6.3 çƒ­ç‚¹è¯é¢˜åˆ†æ

**çƒ­ç‚¹è¯é¢˜åˆ†æ**ï¼šåˆ†ææ—¶é—´åºåˆ—ä¸­çš„çƒ­ç‚¹è¯é¢˜ã€‚

```sql
-- çƒ­ç‚¹è¯é¢˜åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'news_articles') THEN
            RAISE WARNING 'è¡¨ news_articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œçƒ­ç‚¹è¯é¢˜åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œçƒ­ç‚¹è¯é¢˜åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çƒ­ç‚¹è¯é¢˜åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- çƒ­ç‚¹è¯é¢˜åˆ†æï¼šæŒ‰æ—¶é—´æ®µåˆ†æå…³é”®è¯è¶‹åŠ¿
WITH time_periods AS (
    SELECT
        DATE_TRUNC('week', published_at) AS week_start,
        id,
        content
    FROM news_articles
    WHERE published_at >= CURRENT_DATE - INTERVAL '12 weeks'
),
weekly_keywords AS (
    SELECT
        week_start,
        word,
        COUNT(*) AS frequency
    FROM (
        SELECT
            week_start,
            unnest(string_to_array(lower(content), ' ')) AS word
        FROM time_periods
    ) AS expanded
    WHERE length(word) > 4
    GROUP BY week_start, word
),
keyword_trends AS (
    SELECT
        word,
        week_start,
        frequency,
        LAG(frequency) OVER (PARTITION BY word ORDER BY week_start) AS prev_frequency,
        frequency - LAG(frequency) OVER (PARTITION BY word ORDER BY week_start) AS frequency_change
    FROM weekly_keywords
)
SELECT
    word,
    week_start,
    frequency,
    frequency_change,
    CASE
        WHEN frequency_change > 0 THEN 'Rising'
        WHEN frequency_change < 0 THEN 'Declining'
        ELSE 'Stable'
    END AS trend
FROM keyword_trends
WHERE frequency_change IS NOT NULL
ORDER BY ABS(frequency_change) DESC, week_start DESC
LIMIT 50;
```

### 6.4 å†…å®¹æ¨èç³»ç»Ÿ

**å†…å®¹æ¨èç³»ç»Ÿ**ï¼šåŸºäºTF-IDFæ¨èç›¸ä¼¼å†…å®¹ã€‚

```sql
-- å†…å®¹æ¨èç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå†…å®¹æ¨è';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå†…å®¹æ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å†…å®¹æ¨èå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å†…å®¹æ¨èï¼šåŸºäºTF-IDFå‘é‡ç›¸ä¼¼åº¦æ¨èç›¸ä¼¼æ–‡ç« 
WITH article_tf_idf AS (
    SELECT
        id,
        word,
        tf_idf_score
    FROM (
        -- TF-IDFè®¡ç®—
        SELECT
            id,
            word,
            COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) *
            LN(COUNT(DISTINCT id) OVER ()::NUMERIC / COUNT(DISTINCT id) OVER (PARTITION BY word)) AS tf_idf_score
        FROM (
            SELECT id, unnest(string_to_array(lower(content), ' ')) AS word
            FROM articles
        ) AS expanded
        GROUP BY id, word
    ) AS tf_idf_calc
    WHERE tf_idf_score > 0.1
),
article_vectors AS (
    SELECT
        id,
        array_agg(word ORDER BY word) AS word_vector,
        array_agg(tf_idf_score ORDER BY word) AS tf_idf_vector
    FROM article_tf_idf
    GROUP BY id
),
similarity_scores AS (
    SELECT
        a1.id AS article1_id,
        a2.id AS article2_id,
        -- è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
        (SELECT COUNT(*) FROM unnest(a1.word_vector) AS w1
         WHERE w1 = ANY(a2.word_vector))::NUMERIC /
        GREATEST(array_length(a1.word_vector, 1), array_length(a2.word_vector, 1)) AS similarity
    FROM article_vectors a1
    CROSS JOIN article_vectors a2
    WHERE a1.id < a2.id
)
SELECT
    article1_id,
    article2_id,
    similarity
FROM similarity_scores
WHERE similarity > 0.3
ORDER BY similarity DESC
LIMIT 20;
```

---

## 8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 7.1 æŒ–æ˜ç®—æ³•å¯¹æ¯”

| ç®—æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **è¯é¢‘ç»Ÿè®¡** | $\text{tf}(w, d) = \frac{\text{count}(w, d)}{|d|}$ | $O(n)$ | $O(n)$ | ç®€å•åˆ†æ | å¿«é€Ÿã€ç®€å• | å¿½ç•¥é‡è¦æ€§ |
| **TF-IDF** | $\text{tf-idf}(w, d) = \text{tf}(w, d) \times \text{idf}(w)$ | $O(n)$ | $O(n)$ | å…³é”®è¯æå– | è€ƒè™‘é‡è¦æ€§ | è®¡ç®—å¤æ‚ |
| **ä¸»é¢˜å»ºæ¨¡** | $P(w \mid d) = \sum_t P(w \mid t) \times P(t \mid d)$ | $O(n \times k)$ | $O(n \times k)$ | ä¸»é¢˜å‘ç° | å‘ç°ä¸»é¢˜ | è®¡ç®—å¤æ‚ |

### 7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - å…¨æ–‡æœç´¢ï¼šä½¿ç”¨GINç´¢å¼•
   - è¯é¢‘ç»Ÿè®¡ï¼šä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•

2. **æ‰¹é‡å¤„ç†**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ä¸­é—´ç»“æœ
   - æ‰¹é‡è®¡ç®—TF-IDF

3. **å¹¶è¡Œè®¡ç®—**ï¼š
   - å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
   - ä½¿ç”¨åˆ†åŒºè¡¨

### 7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šTF-IDFè®¡ç®—æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ã€æ‰¹é‡å¤„ç†ã€å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜2**ï¼šå…³é”®è¯æå–ä¸å‡†ç¡®

- **è§£å†³æ–¹æ¡ˆ**ï¼šè°ƒæ•´TF-IDFé˜ˆå€¼ã€è¿‡æ»¤åœç”¨è¯ã€ä½¿ç”¨ç»„åˆæ–¹æ³•

**é—®é¢˜3**ï¼šä¸»é¢˜å»ºæ¨¡å¤æ‚

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç®€åŒ–ç‰ˆä¸»é¢˜æå–ã€å¤–éƒ¨å·¥å…·ï¼ˆå¦‚Pythonï¼‰

**é—®é¢˜4**ï¼šå¤§è§„æ¨¡æ•°æ®å¤„ç†å†…å­˜ä¸è¶³

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æ‰¹å¤„ç†ã€ä½¿ç”¨æµå¼å¤„ç†ã€ä¼˜åŒ–æ•°æ®ç»“æ„

---

## 9. æœ€ä½³å®è·µ

### 8.1 ç®—æ³•é€‰æ‹©

1. **ç®€å•åˆ†æ**ï¼šä½¿ç”¨è¯é¢‘ç»Ÿè®¡
2. **å…³é”®è¯æå–**ï¼šä½¿ç”¨TF-IDF
3. **ä¸»é¢˜å‘ç°**ï¼šä½¿ç”¨ä¸»é¢˜å»ºæ¨¡ï¼ˆéœ€è¦å¤–éƒ¨å·¥å…·ï¼‰

### 8.2 å‚æ•°è°ƒä¼˜

1. **TF-IDFé˜ˆå€¼**ï¼šæ ¹æ®åº”ç”¨åœºæ™¯è°ƒæ•´
2. **å…³é”®è¯æ•°é‡**ï¼šé€‰æ‹©Top Nå…³é”®è¯
3. **åœç”¨è¯è¿‡æ»¤**ï¼šè¿‡æ»¤å¸¸è§åœç”¨è¯

### 8.3 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
2. **æ‰¹é‡å¤„ç†**ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ€§èƒ½
3. **ç»“æœç¼“å­˜**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ

### 8.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨å¤§æ•°æ®é›†ä¸Šä½¿ç”¨å¤æ‚è®¡ç®—
2. **å†…å­˜ç®¡ç†**ï¼šæ§åˆ¶work_memé…ç½®
3. **ç»“æœéªŒè¯**ï¼šéªŒè¯æŒ–æ˜ç»“æœçš„å‡†ç¡®æ€§
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†NULLå€¼å’Œè¾¹ç•Œæƒ…å†µ

### 8.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ–‡æœ¬æŒ–æ˜ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«TF-IDFå¾—åˆ†çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Nå…³é”®è¯æŸ¥è¯¢å’Œçƒ­ç‚¹è¯é¢˜æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æ–‡æœ¬æŒ–æ˜è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡TF-IDFè®¡ç®—å’Œä¸»é¢˜å»ºæ¨¡

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - æ–‡æœ¬æŒ–æ˜è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œ
   - é€‚ç”¨äºå¤§è§„æ¨¡è¯é¢‘ç»Ÿè®¡å’Œæ‰¹é‡å…³é”®è¯æå–

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–å…³é”®è¯æŸ¥è¯¢**

```sql
-- ä¸ºTF-IDFå¾—åˆ†åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_tfidf_scores_skip_scan
ON document_keywords(document_id, tfidf_score DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾TF-IDFå¾—åˆ†æœ€é«˜çš„å‰10ä¸ªå…³é”®è¯
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    document_id,
    keyword,
    tfidf_score
FROM document_keywords
WHERE document_id = 1
ORDER BY tfidf_score DESC
LIMIT 10;
```

### 8.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜TF-IDFè®¡ç®—ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„TF-IDFç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜TF-IDFè®¡ç®—ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS tfidf_scores_cache AS
WITH document_term_frequency AS (
    SELECT
        document_id,
        unnest(string_to_array(lower(content), ' ')) AS term,
        COUNT(*) AS term_frequency
    FROM documents
    WHERE content IS NOT NULL
    GROUP BY document_id, unnest(string_to_array(lower(content), ' '))
    HAVING length(unnest(string_to_array(lower(content), ' '))) > 3
),
document_frequencies AS (
    SELECT
        term,
        COUNT(DISTINCT document_id) AS document_frequency,
        (SELECT COUNT(DISTINCT document_id) FROM documents WHERE content IS NOT NULL) AS total_documents
    FROM document_term_frequency
    GROUP BY term
),
tfidf_calculation AS (
    SELECT
        dtf.document_id,
        dtf.term,
        dtf.term_frequency,
        df.document_frequency,
        df.total_documents,
        -- TF-IDFè®¡ç®—ï¼šTF * IDF
        (dtf.term_frequency::numeric / NULLIF(SUM(dtf.term_frequency) OVER (PARTITION BY dtf.document_id), 0)) *
        LN(df.total_documents::numeric / NULLIF(df.document_frequency, 0)) AS tfidf_score
    FROM document_term_frequency dtf
    JOIN document_frequencies df ON dtf.term = df.term
)
SELECT
    document_id,
    term AS keyword,
    ROUND(tfidf_score::numeric, 6) AS tfidf_score
FROM tfidf_calculation
WHERE tfidf_score > 0.1;  -- åªä¿ç•™é‡è¦å…³é”®è¯

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_tfidf_cache_document ON tfidf_scores_cache(document_id, tfidf_score DESC);
CREATE INDEX idx_tfidf_cache_keyword ON tfidf_scores_cache(keyword, tfidf_score DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY tfidf_scores_cache;
```

**2. å®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æï¼šå¢é‡TF-IDFè®¡ç®—**

**å®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æ**ï¼šä½¿ç”¨å¢é‡æ–¹æ³•å®æ—¶æ›´æ–°çƒ­ç‚¹è¯é¢˜ã€‚

```sql
-- å®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æï¼šå¢é‡TF-IDFè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'topic_analysis_state') THEN
            CREATE TABLE topic_analysis_state (
                topic_id SERIAL PRIMARY KEY,
                keyword VARCHAR(100) NOT NULL,
                document_count INTEGER DEFAULT 0,
                total_term_frequency INTEGER DEFAULT 0,
                idf_score NUMERIC,
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                UNIQUE(keyword)
            );

            CREATE INDEX idx_topic_analysis_state_idf ON topic_analysis_state(idf_score DESC);
            CREATE INDEX idx_topic_analysis_state_keyword ON topic_analysis_state(keyword);

            RAISE NOTICE 'è¯é¢˜åˆ†æçŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°TF-IDFï¼šå®æ—¶çƒ­ç‚¹è¯é¢˜åˆ†æ
WITH new_documents AS (
    SELECT
        document_id,
        unnest(string_to_array(lower(content), ' ')) AS term
    FROM documents
    WHERE created_at > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM topic_analysis_state)
      AND content IS NOT NULL
),
new_term_frequencies AS (
    SELECT
        term,
        COUNT(*) AS term_frequency,
        COUNT(DISTINCT document_id) AS document_frequency
    FROM new_documents
    WHERE length(term) > 3
    GROUP BY term
),
updated_topic_stats AS (
    SELECT
        COALESCE(tas.keyword, ntf.term) AS keyword,
        COALESCE(tas.document_count, 0) + ntf.document_frequency AS new_document_count,
        COALESCE(tas.total_term_frequency, 0) + ntf.term_frequency AS new_total_term_frequency,
        (SELECT COUNT(DISTINCT document_id) FROM documents WHERE content IS NOT NULL) AS total_documents,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—IDFï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        LN((SELECT COUNT(DISTINCT document_id) FROM documents WHERE content IS NOT NULL)::numeric /
           NULLIF(COALESCE(tas.document_count, 0) + ntf.document_frequency, 0)) AS new_idf_score
    FROM topic_analysis_state tas
    FULL OUTER JOIN new_term_frequencies ntf ON tas.keyword = ntf.term
)
-- æ›´æ–°æˆ–æ’å…¥è¯é¢˜åˆ†æçŠ¶æ€
INSERT INTO topic_analysis_state (keyword, document_count, total_term_frequency, idf_score, last_updated)
SELECT
    keyword,
    new_document_count,
    new_total_term_frequency,
    new_idf_score,
    NOW()
FROM updated_topic_stats
ON CONFLICT (keyword)
DO UPDATE SET
    document_count = EXCLUDED.document_count,
    total_term_frequency = EXCLUDED.total_term_frequency,
    idf_score = EXCLUDED.idf_score,
    last_updated = NOW();
```

**3. ä¸»é¢˜å»ºæ¨¡ï¼šåŸºäºTF-IDFçš„ä¸»é¢˜æå–**

**ä¸»é¢˜å»ºæ¨¡**ï¼šä½¿ç”¨TF-IDFè¿›è¡Œç®€åŒ–çš„ä¸»é¢˜æå–ã€‚

```sql
-- ä¸»é¢˜å»ºæ¨¡ï¼šåŸºäºTF-IDFçš„ä¸»é¢˜æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'document_topics') THEN
            CREATE TABLE document_topics (
                document_id INTEGER NOT NULL,
                topic_id INTEGER NOT NULL,
                topic_score NUMERIC NOT NULL,
                PRIMARY KEY (document_id, topic_id)
            );

            CREATE INDEX idx_document_topics_document ON document_topics(document_id, topic_score DESC);
            CREATE INDEX idx_document_topics_topic ON document_topics(topic_id, topic_score DESC);

            RAISE NOTICE 'æ–‡æ¡£ä¸»é¢˜è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œä¸»é¢˜å»ºæ¨¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸»é¢˜å»ºæ¨¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸»é¢˜å»ºæ¨¡ï¼šåŸºäºå…³é”®è¯èšç±»çš„ç®€åŒ–ä¸»é¢˜æå–
WITH keyword_topics AS (
    SELECT
        keyword,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—å…³é”®è¯çš„é‡è¦æ€§ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        ROW_NUMBER() OVER (ORDER BY idf_score DESC, total_term_frequency DESC) AS topic_rank,
        CASE
            WHEN idf_score > 2.0 THEN 1  -- é«˜é‡è¦æ€§ä¸»é¢˜
            WHEN idf_score > 1.0 THEN 2  -- ä¸­ç­‰é‡è¦æ€§ä¸»é¢˜
            ELSE 3  -- ä½é‡è¦æ€§ä¸»é¢˜
        END AS topic_category
    FROM topic_analysis_state
    WHERE idf_score > 0.5
),
document_topic_scores AS (
    SELECT
        tfsc.document_id,
        kt.topic_category AS topic_id,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ–‡æ¡£ä¸»é¢˜å¾—åˆ†ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        SUM(tfsc.tfidf_score) OVER (PARTITION BY tfsc.document_id, kt.topic_category) AS topic_score
    FROM tfidf_scores_cache tfsc
    JOIN keyword_topics kt ON tfsc.keyword = kt.keyword
)
SELECT DISTINCT ON (document_id, topic_id)
    document_id,
    topic_id,
    ROUND(topic_score::numeric, 4) AS topic_score,
    -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ä¸»é¢˜æ’åï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
    ROW_NUMBER() OVER (PARTITION BY document_id ORDER BY topic_score DESC) AS topic_rank
FROM document_topic_scores
ORDER BY document_id, topic_id, topic_score DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šä¿¡æ¯æ£€ç´¢å¯¼è®ºã€‹ï¼ˆIntroduction to Information Retrievalï¼‰- TF-IDFç†è®º
- ã€Šæ•°æ®æŒ–æ˜ï¼šæ¦‚å¿µä¸æŠ€æœ¯ã€‹ï¼ˆData Mining: Concepts and Techniquesï¼‰- æ–‡æœ¬æŒ–æ˜

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [æ•°ç»„æ“ä½œ](https://www.postgresql.org/docs/current/arrays.html)
- [çª—å£å‡½æ•°](https://www.postgresql.org/docs/current/tutorial-window.html)

### åœ¨çº¿èµ„æº

- PostgreSQLæ–‡æœ¬æŒ–æ˜æŒ‡å—
- TF-IDFç®—æ³•è¯¦è§£
- ä¸»é¢˜å»ºæ¨¡æœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [æ–‡æœ¬æœç´¢ç®—æ³•](./æ–‡æœ¬æœç´¢ç®—æ³•.md) - æ–‡æœ¬æœç´¢
- [æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—](./æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—.md) - ç›¸ä¼¼åº¦è®¡ç®—
- [æ–‡æœ¬åˆ†ç±»ç®—æ³•](./æ–‡æœ¬åˆ†ç±»ç®—æ³•.md) - æ–‡æœ¬åˆ†ç±»

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
