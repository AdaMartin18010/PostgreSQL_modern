# PostgreSQL æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ–‡æœ¬æŒ–æ˜ | å…³é”®è¯æå–
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ–‡æœ¬æŒ–æ˜ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°](#æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½](#æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½)
  - [1. å…³é”®è¯æå–](#1-å…³é”®è¯æå–)
    - [1.1 é«˜é¢‘è¯æå–](#11-é«˜é¢‘è¯æå–)
  - [2. è¯é¢‘ç»Ÿè®¡](#2-è¯é¢‘ç»Ÿè®¡)
    - [2.1 æ–‡æ¡£è¯é¢‘ç»Ÿè®¡](#21-æ–‡æ¡£è¯é¢‘ç»Ÿè®¡)
  - [3. TF-IDFè®¡ç®—](#3-tf-idfè®¡ç®—)
    - [3.1 TF-IDFè¯„åˆ†](#31-tf-idfè¯„åˆ†)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ä¸»é¢˜å…³é”®è¯æå–](#41-ä¸»é¢˜å…³é”®è¯æå–)

---

## æ–‡æœ¬æŒ–æ˜ç®—æ³•æ¦‚è¿°

**æ–‡æœ¬æŒ–æ˜ç®—æ³•**ç”¨äºä»æ–‡æœ¬ä¸­æå–æœ‰ç”¨ä¿¡æ¯ï¼Œå¦‚å…³é”®è¯ã€ä¸»é¢˜ç­‰ã€‚

### æ ¸å¿ƒæŒ–æ˜åŠŸèƒ½

| åŠŸèƒ½ | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **å…³é”®è¯æå–** | æå–å…³é”®è¯ | O(n) |
| **è¯é¢‘ç»Ÿè®¡** | ç»Ÿè®¡è¯é¢‘ | O(n) |
| **TF-IDF** | é‡è¦æ€§è¯„åˆ† | O(n) |

---

## 1. å…³é”®è¯æå–

### 1.1 é«˜é¢‘è¯æå–

**å…³é”®è¯æå–**æå–æ–‡æœ¬ä¸­çš„é«˜é¢‘å…³é”®è¯ã€‚

```sql
-- å…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH word_frequencies AS (
    SELECT
        unnest(string_to_array(lower(content), ' ')) AS word,
        COUNT(*) AS frequency
    FROM documents
    GROUP BY unnest(string_to_array(lower(content), ' '))
    HAVING length(unnest(string_to_array(lower(content), ' '))) > 3  -- è¿‡æ»¤çŸ­è¯
)
SELECT
    word,
    frequency,
    frequency * 100.0 / SUM(frequency) OVER () AS frequency_pct
FROM word_frequencies
ORDER BY frequency DESC
LIMIT 50;
```

---

## 2. è¯é¢‘ç»Ÿè®¡

### 2.1 æ–‡æ¡£è¯é¢‘ç»Ÿè®¡

**è¯é¢‘ç»Ÿè®¡**ç»Ÿè®¡æ¯ä¸ªæ–‡æ¡£ä¸­çš„è¯é¢‘ã€‚

```sql
-- è¯é¢‘ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¯é¢‘ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè¯é¢‘ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯é¢‘ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    id,
    word,
    COUNT(*) AS word_count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (PARTITION BY id) AS word_frequency_pct
FROM (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
) AS expanded
GROUP BY id, word
ORDER BY id, word_count DESC;
```

---

## 3. TF-IDFè®¡ç®—

### 3.1 TF-IDFè¯„åˆ†

**TF-IDFè®¡ç®—**è®¡ç®—è¯çš„é‡è¦æ€§è¯„åˆ†ã€‚

```sql
-- TF-IDFè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒTF-IDFè®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒTF-IDFè®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'TF-IDFè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH document_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM documents
),
term_frequency AS (
    SELECT
        id,
        word,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM document_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM document_words
    GROUP BY word
),
total_documents AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM documents
)
SELECT
    tf.id,
    tf.word,
    tf.tf,
    df.df,
    td.total,
    LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS idf,
    tf.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf
FROM term_frequency tf
JOIN document_frequency df ON tf.word = df.word
CROSS JOIN total_documents td
ORDER BY tf.id, tf_idf DESC;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ä¸»é¢˜å…³é”®è¯æå–

**ä¸»é¢˜å…³é”®è¯æå–**æå–æ–‡æ¡£çš„ä¸»é¢˜å…³é”®è¯ã€‚

```sql
-- ä¸»é¢˜å…³é”®è¯æå–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œä¸»é¢˜å…³é”®è¯æå–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œä¸»é¢˜å…³é”®è¯æå–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸»é¢˜å…³é”®è¯æå–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH article_words AS (
    SELECT
        id,
        unnest(string_to_array(lower(content), ' ')) AS word
    FROM articles
    WHERE length(unnest(string_to_array(lower(content), ' '))) > 4  -- è¿‡æ»¤çŸ­è¯
),
word_stats AS (
    SELECT
        id,
        word,
        COUNT(*) AS word_count,
        COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER (PARTITION BY id) AS tf
    FROM article_words
    GROUP BY id, word
),
document_frequency AS (
    SELECT
        word,
        COUNT(DISTINCT id) AS df
    FROM article_words
    GROUP BY word
),
total_docs AS (
    SELECT COUNT(DISTINCT id) AS total
    FROM articles
)
SELECT
    ws.id,
    ws.word,
    ws.word_count,
    ws.tf,
    df.df,
    ws.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) AS tf_idf_score
FROM word_stats ws
JOIN document_frequency df ON ws.word = df.word
CROSS JOIN total_docs td
WHERE ws.tf * LN(td.total::NUMERIC / NULLIF(df.df, 0)) > 0.5  -- TF-IDFé˜ˆå€¼
ORDER BY ws.id, tf_idf_score DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
