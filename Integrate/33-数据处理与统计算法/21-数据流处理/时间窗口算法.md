# PostgreSQL æ—¶é—´çª—å£ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æµå¤„ç† | æ—¶é—´çª—å£ | æ»‘åŠ¨çª—å£
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
> **å‚è€ƒæ ‡å‡†**: Time Windows, Tumbling Windows, Sliding Windows, Session Windows

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ—¶é—´çª—å£ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ—¶é—´çª—å£ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ—¶é—´çª—å£æ¦‚è¿°](#æ—¶é—´çª—å£æ¦‚è¿°)
    - [çª—å£ç±»å‹](#çª—å£ç±»å‹)
  - [1. æ»šåŠ¨çª—å£](#1-æ»šåŠ¨çª—å£)
  - [2. æ»‘åŠ¨çª—å£](#2-æ»‘åŠ¨çª—å£)
  - [3. ä¼šè¯çª—å£](#3-ä¼šè¯çª—å£)
  - [4. æ°´ä½çº¿å¤„ç†](#4-æ°´ä½çº¿å¤„ç†)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## æ—¶é—´çª—å£æ¦‚è¿°

**æ—¶é—´çª—å£**å°†è¿ç»­æ•°æ®æµåˆ’åˆ†ä¸ºæ—¶é—´åŒºé—´è¿›è¡Œå¤„ç†ã€‚

### çª—å£ç±»å‹

| çª—å£ç±»å‹ | ç‰¹ç‚¹ | åº”ç”¨åœºæ™¯ |
|---------|------|---------|
| **æ»šåŠ¨çª—å£** | å›ºå®šå¤§å°ï¼Œä¸é‡å  | å®šæœŸç»Ÿè®¡ |
| **æ»‘åŠ¨çª—å£** | å›ºå®šå¤§å°ï¼Œæœ‰é‡å  | å¹³æ»‘ç»Ÿè®¡ |
| **ä¼šè¯çª—å£** | åŸºäºæ´»åŠ¨é—´éš” | ç”¨æˆ·ä¼šè¯åˆ†æ |

---

## 1. æ»šåŠ¨çª—å£

**æ»šåŠ¨çª—å£ï¼ˆTumbling Windowï¼‰**å°†æ•°æ®æµåˆ’åˆ†ä¸ºä¸é‡å çš„å›ºå®šæ—¶é—´åŒºé—´ã€‚

```sql
-- æ»šåŠ¨çª—å£æ•°æ®å‡†å¤‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'stream_events') THEN
            DROP TABLE stream_events CASCADE;
        END IF;

        CREATE TABLE stream_events (
            event_id SERIAL PRIMARY KEY,
            event_time TIMESTAMP NOT NULL,
            value NUMERIC NOT NULL
        );

        INSERT INTO stream_events (event_time, value) VALUES
            ('2024-01-01 10:00:00', 10),
            ('2024-01-01 10:00:30', 20),
            ('2024-01-01 10:01:00', 15),
            ('2024-01-01 10:01:30', 25);

        RAISE NOTICE 'è¡¨ stream_events åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ»šåŠ¨çª—å£èšåˆï¼ˆ1åˆ†é’Ÿçª—å£ï¼‰
WITH tumbling_windows AS (
    SELECT
        DATE_TRUNC('minute', event_time) AS window_start,
        DATE_TRUNC('minute', event_time) + INTERVAL '1 minute' AS window_end,
        COUNT(*) AS event_count,
        SUM(value) AS total_value,
        AVG(value) AS avg_value
    FROM stream_events
    GROUP BY DATE_TRUNC('minute', event_time)
)
SELECT
    window_start,
    window_end,
    event_count,
    ROUND(total_value::numeric, 2) AS total_value,
    ROUND(avg_value::numeric, 2) AS avg_value
FROM tumbling_windows
ORDER BY window_start;
```

---

## 2. æ»‘åŠ¨çª—å£

**æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**ä½¿ç”¨å›ºå®šå¤§å°çš„çª—å£ï¼Œä½†çª—å£ä¹‹é—´æœ‰é‡å ã€‚

```sql
-- æ»‘åŠ¨çª—å£èšåˆï¼ˆ1åˆ†é’Ÿçª—å£ï¼Œ30ç§’æ»‘åŠ¨ï¼‰
WITH sliding_windows AS (
    SELECT
        event_time,
        value,
        DATE_TRUNC('minute', event_time) AS window_start,
        DATE_TRUNC('minute', event_time) + INTERVAL '1 minute' AS window_end
    FROM stream_events
),
window_aggregates AS (
    SELECT
        window_start,
        window_end,
        COUNT(*) AS event_count,
        SUM(value) AS total_value,
        AVG(value) AS avg_value
    FROM sliding_windows
    GROUP BY window_start, window_end
)
SELECT
    window_start,
    window_end,
    event_count,
    ROUND(total_value::numeric, 2) AS total_value,
    ROUND(avg_value::numeric, 2) AS avg_value
FROM window_aggregates
ORDER BY window_start;
```

---

## 3. ä¼šè¯çª—å£

**ä¼šè¯çª—å£ï¼ˆSession Windowï¼‰**åŸºäºæ´»åŠ¨é—´éš”åŠ¨æ€åˆ’åˆ†çª—å£ã€‚

```sql
-- ä¼šè¯çª—å£è¯†åˆ«
WITH session_boundaries AS (
    SELECT
        event_time,
        value,
        LAG(event_time) OVER (ORDER BY event_time) AS prev_time,
        CASE
            WHEN LAG(event_time) OVER (ORDER BY event_time) IS NULL THEN 1
            WHEN event_time - LAG(event_time) OVER (ORDER BY event_time) > INTERVAL '5 minutes' THEN 1
            ELSE 0
        END AS session_start
    FROM stream_events
),
session_ids AS (
    SELECT
        event_time,
        value,
        SUM(session_start) OVER (ORDER BY event_time) AS session_id
    FROM session_boundaries
)
SELECT
    session_id,
    MIN(event_time) AS session_start,
    MAX(event_time) AS session_end,
    COUNT(*) AS event_count,
    SUM(value) AS total_value
FROM session_ids
GROUP BY session_id
ORDER BY session_id;
```

---

## 4. æ°´ä½çº¿å¤„ç†

**æ°´ä½çº¿ï¼ˆWatermarkï¼‰**å¤„ç†å»¶è¿Ÿæ•°æ®ï¼Œå®šä¹‰äº‹ä»¶æ—¶é—´çš„æœ€å¤§å»¶è¿Ÿã€‚

```sql
-- æ°´ä½çº¿å¤„ç†
WITH watermarks AS (
    SELECT
        event_time,
        value,
        MAX(event_time) OVER () AS max_event_time,
        MAX(event_time) OVER () - INTERVAL '1 hour' AS watermark
    FROM stream_events
)
SELECT
    event_time,
    value,
    watermark,
    CASE
        WHEN event_time >= watermark THEN 'On-time'
        ELSE 'Late'
    END AS data_status
FROM watermarks
ORDER BY event_time;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Apache Flink Documentation**: "Time Windows"
2. **Kafka Streams**: "Windowing"

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
