# PostgreSQL æ¨èç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ¨èç®—æ³• | ååŒè¿‡æ»¤
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ¨èç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ¨èç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¨èç®—æ³•æ¦‚è¿°](#æ¨èç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ¨èç³»ç»Ÿå®šä¹‰](#æ¨èç³»ç»Ÿå®šä¹‰)
      - [æ¨èç³»ç»Ÿç±»å‹](#æ¨èç³»ç»Ÿç±»å‹)
      - [æ¨èç³»ç»Ÿè¯„ä¼°æŒ‡æ ‡](#æ¨èç³»ç»Ÿè¯„ä¼°æŒ‡æ ‡)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. ååŒè¿‡æ»¤](#1-ååŒè¿‡æ»¤)
    - [1.1 ååŒè¿‡æ»¤åŸç†](#11-ååŒè¿‡æ»¤åŸç†)
      - [ååŒè¿‡æ»¤å‡è®¾](#ååŒè¿‡æ»¤å‡è®¾)
      - [ååŒè¿‡æ»¤ä¼˜åŠ¿](#ååŒè¿‡æ»¤ä¼˜åŠ¿)
      - [ååŒè¿‡æ»¤æŒ‘æˆ˜](#ååŒè¿‡æ»¤æŒ‘æˆ˜)
    - [1.2 åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤å®ç°](#12-åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤å®ç°)
    - [1.2 åŸºäºç‰©å“çš„ååŒè¿‡æ»¤](#12-åŸºäºç‰©å“çš„ååŒè¿‡æ»¤)
    - [1.3 ååŒè¿‡æ»¤é¢„æµ‹å…¬å¼](#13-ååŒè¿‡æ»¤é¢„æµ‹å…¬å¼)
  - [2. ç›¸ä¼¼åº¦è®¡ç®—](#2-ç›¸ä¼¼åº¦è®¡ç®—)
    - [2.1 ç›¸ä¼¼åº¦è®¡ç®—åŸç†](#21-ç›¸ä¼¼åº¦è®¡ç®—åŸç†)
      - [ç›¸ä¼¼åº¦åº¦é‡æ–¹æ³•](#ç›¸ä¼¼åº¦åº¦é‡æ–¹æ³•)
    - [2.2 ä½™å¼¦ç›¸ä¼¼åº¦å®ç°](#22-ä½™å¼¦ç›¸ä¼¼åº¦å®ç°)
    - [2.2 çš®å°”é€Šç›¸å…³ç³»æ•°](#22-çš®å°”é€Šç›¸å…³ç³»æ•°)
    - [2.3 Jaccardç›¸ä¼¼åº¦](#23-jaccardç›¸ä¼¼åº¦)
    - [2.4 è°ƒæ•´ä½™å¼¦ç›¸ä¼¼åº¦](#24-è°ƒæ•´ä½™å¼¦ç›¸ä¼¼åº¦)
  - [3. æ¨èç”Ÿæˆ](#3-æ¨èç”Ÿæˆ)
    - [3.1 æ¨èç”ŸæˆåŸç†](#31-æ¨èç”ŸæˆåŸç†)
      - [æ¨èç”Ÿæˆæ–¹æ³•](#æ¨èç”Ÿæˆæ–¹æ³•)
    - [3.2 Top-Næ¨èå®ç°](#32-top-næ¨èå®ç°)
    - [3.3 åŠ æƒæ¨èç”Ÿæˆ](#33-åŠ æƒæ¨èç”Ÿæˆ)
  - [4. å†…å®¹è¿‡æ»¤æ¨è](#4-å†…å®¹è¿‡æ»¤æ¨è)
    - [4.1 å†…å®¹è¿‡æ»¤åŸç†](#41-å†…å®¹è¿‡æ»¤åŸç†)
      - [å†…å®¹è¿‡æ»¤ä¼˜åŠ¿](#å†…å®¹è¿‡æ»¤ä¼˜åŠ¿)
      - [å†…å®¹è¿‡æ»¤æŒ‘æˆ˜](#å†…å®¹è¿‡æ»¤æŒ‘æˆ˜)
    - [4.2 å†…å®¹è¿‡æ»¤å®ç°](#42-å†…å®¹è¿‡æ»¤å®ç°)
  - [5. æ··åˆæ¨è](#5-æ··åˆæ¨è)
    - [5.1 æ··åˆæ¨èåŸç†](#51-æ··åˆæ¨èåŸç†)
      - [æ··åˆç­–ç•¥](#æ··åˆç­–ç•¥)
    - [5.2 æ··åˆæ¨èå®ç°](#52-æ··åˆæ¨èå®ç°)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 å•†å“æ¨è](#61-å•†å“æ¨è)
    - [6.2 ç”µå½±æ¨èç³»ç»Ÿ](#62-ç”µå½±æ¨èç³»ç»Ÿ)
    - [6.3 æ–°é—»æ¨èç³»ç»Ÿ](#63-æ–°é—»æ¨èç³»ç»Ÿ)
    - [6.4 æ¨èç³»ç»Ÿè¯„ä¼°](#64-æ¨èç³»ç»Ÿè¯„ä¼°)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [7.1 æ¨èç®—æ³•å¯¹æ¯”](#71-æ¨èç®—æ³•å¯¹æ¯”)
    - [7.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#72-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#73-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 æ¨èç³»ç»Ÿè®¾è®¡](#81-æ¨èç³»ç»Ÿè®¾è®¡)
    - [8.2 æ¨èç³»ç»Ÿæ³¨æ„äº‹é¡¹](#82-æ¨èç³»ç»Ÿæ³¨æ„äº‹é¡¹)
    - [8.3 SQLå®ç°æ³¨æ„äº‹é¡¹](#83-sqlå®ç°æ³¨æ„äº‹é¡¹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ¨èç®—æ³•æ¦‚è¿°

**æ¨èç®—æ³•ï¼ˆRecommendation Algorithmï¼‰**ç”¨äºé¢„æµ‹ç”¨æˆ·å¯èƒ½æ„Ÿå…´è¶£çš„ç‰©å“ï¼Œå¹¿æ³›åº”ç”¨äºç”µå•†ã€å†…å®¹å¹³å°ã€ç¤¾äº¤åª’ä½“ç­‰åœºæ™¯ã€‚æ¨èç³»ç»Ÿæ˜¯ç°ä»£äº’è”ç½‘åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡è½¬åŒ–ç‡ã€‚

### ç†è®ºåŸºç¡€

#### æ¨èç³»ç»Ÿå®šä¹‰

**æ¨èç³»ç»Ÿï¼ˆRecommendation Systemï¼‰**æ˜¯ä¸€ä¸ªä¿¡æ¯è¿‡æ»¤ç³»ç»Ÿï¼Œé€šè¿‡åˆ†æç”¨æˆ·çš„å†å²è¡Œä¸ºã€åå¥½å’Œç‰¹å¾ï¼Œé¢„æµ‹ç”¨æˆ·å¯èƒ½æ„Ÿå…´è¶£çš„ç‰©å“æˆ–å†…å®¹ã€‚

#### æ¨èç³»ç»Ÿç±»å‹

1. **ååŒè¿‡æ»¤ï¼ˆCollaborative Filteringï¼‰**ï¼š
   - åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ï¼ˆUser-Based CFï¼‰
   - åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ï¼ˆItem-Based CFï¼‰

2. **å†…å®¹è¿‡æ»¤ï¼ˆContent-Based Filteringï¼‰**ï¼š
   - åŸºäºç‰©å“ç‰¹å¾
   - åŸºäºç”¨æˆ·ç”»åƒ

3. **æ··åˆæ¨èï¼ˆHybrid Recommendationï¼‰**ï¼š
   - åŠ æƒæ··åˆ
   - åˆ‡æ¢æ··åˆ
   - çº§è”æ··åˆ

#### æ¨èç³»ç»Ÿè¯„ä¼°æŒ‡æ ‡

1. **å‡†ç¡®ç‡æŒ‡æ ‡**ï¼š
   - **MAEï¼ˆMean Absolute Errorï¼‰**ï¼š$MAE = \frac{1}{n}\sum_{i=1}^{n}|r_i - \hat{r}_i|$
   - **RMSEï¼ˆRoot Mean Square Errorï¼‰**ï¼š$RMSE = \sqrt{\frac{1}{n}\sum_{i=1}^{n}(r_i - \hat{r}_i)^2}$

2. **æ’åºæŒ‡æ ‡**ï¼š
   - **Precision@K**ï¼šå‰Kä¸ªæ¨èä¸­ç›¸å…³çš„æ¯”ä¾‹
   - **Recall@K**ï¼šå‰Kä¸ªæ¨èè¦†ç›–çš„ç›¸å…³ç‰©å“æ¯”ä¾‹
   - **NDCGï¼ˆNormalized Discounted Cumulative Gainï¼‰**ï¼šè€ƒè™‘æ’åºä½ç½®çš„æŒ‡æ ‡

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ | æ•°å­¦è¡¨ç¤º |
|------|------|--------|---------|
| **ååŒè¿‡æ»¤** | åŸºäºç”¨æˆ·è¡Œä¸º | $O(n^2)$ | $sim(u,v) = \frac{\vec{u} \cdot \vec{v}}{|\vec{u}||\vec{v}|}$ |
| **å†…å®¹è¿‡æ»¤** | åŸºäºç‰©å“ç‰¹å¾ | $O(nm)$ | $score(u,i) = \sum_{f} w_{u,f} \cdot f_i$ |
| **æ··åˆæ¨è** | ç»„åˆå¤šç§æ–¹æ³• | $O(n^2)$ | $score = \alpha \cdot CF + (1-\alpha) \cdot CB$ |

---

## 1. ååŒè¿‡æ»¤

### 1.1 ååŒè¿‡æ»¤åŸç†

**ååŒè¿‡æ»¤ï¼ˆCollaborative Filteringï¼‰**åŸºäº"ç›¸ä¼¼ç”¨æˆ·æœ‰ç›¸ä¼¼åå¥½"çš„å‡è®¾ï¼Œé€šè¿‡åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®æ¥é¢„æµ‹ç”¨æˆ·å…´è¶£ã€‚

#### ååŒè¿‡æ»¤å‡è®¾

1. **ç”¨æˆ·ç›¸ä¼¼æ€§å‡è®¾**ï¼šå¦‚æœç”¨æˆ·Aå’Œç”¨æˆ·Bå¯¹æŸäº›ç‰©å“æœ‰ç›¸ä¼¼çš„è¯„åˆ†ï¼Œé‚£ä¹ˆä»–ä»¬å¯¹å…¶ä»–ç‰©å“ä¹Ÿå¯èƒ½æœ‰ç›¸ä¼¼çš„è¯„åˆ†ã€‚
2. **ç‰©å“ç›¸ä¼¼æ€§å‡è®¾**ï¼šå¦‚æœç‰©å“Xå’Œç‰©å“Yè¢«ç›¸ä¼¼ç”¨æˆ·å–œæ¬¢ï¼Œé‚£ä¹ˆå–œæ¬¢Xçš„ç”¨æˆ·ä¹Ÿå¯èƒ½å–œæ¬¢Yã€‚

#### ååŒè¿‡æ»¤ä¼˜åŠ¿

1. **æ— éœ€ç‰©å“ç‰¹å¾**ï¼šåªéœ€è¦ç”¨æˆ·è¡Œä¸ºæ•°æ®
2. **å‘ç°æ½œåœ¨å…´è¶£**ï¼šå¯ä»¥å‘ç°ç”¨æˆ·è‡ªå·±éƒ½ä¸çŸ¥é“çš„å…´è¶£
3. **é€‚åº”æ€§å¼º**ï¼šèƒ½å¤Ÿé€‚åº”ç”¨æˆ·å…´è¶£çš„å˜åŒ–

#### ååŒè¿‡æ»¤æŒ‘æˆ˜

1. **å†·å¯åŠ¨é—®é¢˜**ï¼šæ–°ç”¨æˆ·å’Œæ–°ç‰©å“ç¼ºä¹æ•°æ®
2. **æ•°æ®ç¨€ç–æ€§**ï¼šç”¨æˆ·-ç‰©å“çŸ©é˜µé€šå¸¸å¾ˆç¨€ç–
3. **å¯æ‰©å±•æ€§**ï¼šè®¡ç®—å¤æ‚åº¦é«˜

### 1.2 åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤å®ç°

```sql
-- åˆ›å»ºç”¨æˆ·è¯„åˆ†è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE user_ratings CASCADE;
        END IF;

        CREATE TABLE user_ratings (
            user_id INTEGER NOT NULL,
            item_id INTEGER NOT NULL,
            rating NUMERIC NOT NULL CHECK (rating >= 1 AND rating <= 5),
            PRIMARY KEY (user_id, item_id)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO user_ratings (user_id, item_id, rating) VALUES
            (1, 1, 5), (1, 2, 4), (1, 3, 3), (1, 4, 2),
            (2, 1, 4), (2, 2, 5), (2, 3, 4), (2, 5, 3),
            (3, 2, 3), (3, 3, 5), (3, 4, 4), (3, 5, 5),
            (4, 1, 2), (4, 3, 4), (4, 4, 5), (4, 5, 4);

        RAISE NOTICE 'è¡¨ user_ratings åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥16æ¡è¯„åˆ†æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ user_ratings å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒååŒè¿‡æ»¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ååŒè¿‡æ»¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
WITH user_vectors AS (
    SELECT
        user_id,
        item_id,
        rating
    FROM user_ratings
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) AS dot_product,
        SQRT(SUM(u1.rating * u1.rating)) AS norm1,
        SQRT(SUM(u2.rating * u2.rating)) AS norm2
    FROM user_vectors u1
    JOIN user_vectors u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
)
SELECT
    user1_id,
    user2_id,
    ROUND((dot_product / NULLIF(norm1 * norm2, 0))::numeric, 4) AS cosine_similarity
FROM user_similarity
ORDER BY cosine_similarity DESC;

-- ä¸ºç”¨æˆ·1æ¨èç‰©å“ï¼ˆåŸºäºç›¸ä¼¼ç”¨æˆ·ï¼‰
WITH target_user AS (
    SELECT 1 AS user_id
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) /
        NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity
    FROM user_ratings u1
    JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
    GROUP BY u1.user_id, u2.user_id
),
similar_users AS (
    SELECT
        CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
        similarity
    FROM user_similarity
    WHERE similarity > 0.5  -- ç›¸ä¼¼åº¦é˜ˆå€¼
),
recommendations AS (
    SELECT
        r.item_id,
        SUM(r.rating * s.similarity) / SUM(s.similarity) AS predicted_rating,
        COUNT(*) AS recommendation_count
    FROM user_ratings r
    JOIN similar_users s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating,
    recommendation_count
FROM recommendations
ORDER BY predicted_rating DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    u1.user_id,
    u2.user_id,
    COUNT(*) AS common_items
FROM user_ratings u1
JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
GROUP BY u1.user_id, u2.user_id
LIMIT 100;
```

### 1.2 åŸºäºç‰©å“çš„ååŒè¿‡æ»¤

**åŸºäºç‰©å“çš„ååŒè¿‡æ»¤**æ‰¾åˆ°ç›¸ä¼¼ç‰©å“ï¼Œæ¨èç»™ç”¨æˆ·ã€‚

```sql
-- åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç‰©å“ååŒè¿‡æ»¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºäºç‰©å“çš„ååŒè¿‡æ»¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç‰©å“ååŒè¿‡æ»¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç‰©å“ç›¸ä¼¼åº¦
WITH item_vectors AS (
    SELECT
        item_id,
        user_id,
        rating
    FROM user_ratings
),
item_similarity AS (
    SELECT
        i1.item_id AS item1_id,
        i2.item_id AS item2_id,
        SUM(i1.rating * i2.rating) AS dot_product,
        SQRT(SUM(i1.rating * i1.rating)) AS norm1,
        SQRT(SUM(i2.rating * i2.rating)) AS norm2
    FROM item_vectors i1
    JOIN item_vectors i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
    GROUP BY i1.item_id, i2.item_id
)
SELECT
    item1_id,
    item2_id,
    ROUND((dot_product / NULLIF(norm1 * norm2, 0))::numeric, 4) AS cosine_similarity
FROM item_similarity
ORDER BY cosine_similarity DESC;

-- ä¸ºç”¨æˆ·1æ¨èç‰©å“ï¼ˆåŸºäºç‰©å“ç›¸ä¼¼åº¦ï¼‰
WITH target_user AS (
    SELECT 1 AS user_id
),
user_items AS (
    SELECT item_id, rating
    FROM user_ratings
    WHERE user_id = (SELECT user_id FROM target_user)
),
item_similarity AS (
    SELECT
        i1.item_id AS item1_id,
        i2.item_id AS item2_id,
        SUM(i1.rating * i2.rating) /
        NULLIF(SQRT(SUM(i1.rating * i1.rating)) * SQRT(SUM(i2.rating * i2.rating)), 0) AS similarity
    FROM user_ratings i1
    JOIN user_ratings i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
    GROUP BY i1.item_id, i2.item_id
),
recommendations AS (
    SELECT
        CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END AS item_id,
        SUM(ui.rating * isim.similarity) / SUM(isim.similarity) AS predicted_rating
    FROM user_items ui
    JOIN item_similarity isim ON (isim.item1_id = ui.item_id OR isim.item2_id = ui.item_id)
    WHERE CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END
          NOT IN (SELECT item_id FROM user_items)
    GROUP BY CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating
FROM recommendations
ORDER BY predicted_rating DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    i1.item_id,
    i2.item_id,
    COUNT(*) AS common_users
FROM user_ratings i1
JOIN user_ratings i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
GROUP BY i1.item_id, i2.item_id
LIMIT 100;
```

---

### 1.3 ååŒè¿‡æ»¤é¢„æµ‹å…¬å¼

**é¢„æµ‹è¯„åˆ†**ï¼š
$$\hat{r}_{u,i} = \bar{r}_u + \frac{\sum_{v \in N(u)} sim(u,v) \cdot (r_{v,i} - \bar{r}_v)}{\sum_{v \in N(u)} |sim(u,v)|}$$

å…¶ä¸­ï¼š

- $\hat{r}_{u,i}$ï¼šç”¨æˆ·$u$å¯¹ç‰©å“$i$çš„é¢„æµ‹è¯„åˆ†
- $\bar{r}_u$ï¼šç”¨æˆ·$u$çš„å¹³å‡è¯„åˆ†
- $N(u)$ï¼šä¸ç”¨æˆ·$u$ç›¸ä¼¼çš„ç”¨æˆ·é›†åˆ
- $sim(u,v)$ï¼šç”¨æˆ·$u$å’Œ$v$çš„ç›¸ä¼¼åº¦
- $r_{v,i}$ï¼šç”¨æˆ·$v$å¯¹ç‰©å“$i$çš„è¯„åˆ†

---

## 2. ç›¸ä¼¼åº¦è®¡ç®—

### 2.1 ç›¸ä¼¼åº¦è®¡ç®—åŸç†

**ç›¸ä¼¼åº¦è®¡ç®—**æ˜¯ååŒè¿‡æ»¤çš„æ ¸å¿ƒï¼Œç”¨äºè¡¡é‡ç”¨æˆ·æˆ–ç‰©å“ä¹‹é—´çš„ç›¸ä¼¼ç¨‹åº¦ã€‚

#### ç›¸ä¼¼åº¦åº¦é‡æ–¹æ³•

1. **ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰**ï¼šè¡¡é‡å‘é‡å¤¹è§’
2. **çš®å°”é€Šç›¸å…³ç³»æ•°ï¼ˆPearson Correlationï¼‰**ï¼šè¡¡é‡çº¿æ€§ç›¸å…³æ€§
3. **Jaccardç›¸ä¼¼åº¦**ï¼šè¡¡é‡é›†åˆé‡å åº¦
4. **æ¬§æ°è·ç¦»**ï¼šè¡¡é‡å‘é‡è·ç¦»

### 2.2 ä½™å¼¦ç›¸ä¼¼åº¦å®ç°

```sql
-- ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION cosine_similarity(vec1 NUMERIC[], vec2 NUMERIC[])
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    dot_product NUMERIC := 0;
    norm1 NUMERIC := 0;
    norm2 NUMERIC := 0;
    i INTEGER;
BEGIN
    BEGIN
        IF vec1 IS NULL OR vec2 IS NULL OR
           array_length(vec1, 1) IS NULL OR array_length(vec2, 1) IS NULL THEN
            RAISE WARNING 'è¾“å…¥å‘é‡ä¸ºç©º';
            RETURN NULL;
        END IF;

        IF array_length(vec1, 1) != array_length(vec2, 1) THEN
            RAISE WARNING 'å‘é‡ç»´åº¦ä¸åŒ¹é…';
            RETURN NULL;
        END IF;

        -- è®¡ç®—ç‚¹ç§¯å’ŒèŒƒæ•°
        FOR i IN 1..array_length(vec1, 1) LOOP
            dot_product := dot_product + vec1[i] * vec2[i];
            norm1 := norm1 + vec1[i] * vec1[i];
            norm2 := norm2 + vec2[i] * vec2[i];
        END LOOP;

        norm1 := SQRT(norm1);
        norm2 := SQRT(norm2);

        IF norm1 = 0 OR norm2 = 0 THEN
            RETURN 0;
        END IF;

        RETURN dot_product / (norm1 * norm2);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å¤±è´¥: %', SQLERRM;
            RETURN NULL;
    END;
END;
$$;

-- ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'cosine_similarity') THEN
            RAISE WARNING 'cosine_similarityå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æµ‹è¯•ä½™å¼¦ç›¸ä¼¼åº¦å‡½æ•°
SELECT
    cosine_similarity(ARRAY[1, 2, 3], ARRAY[4, 5, 6]) AS similarity1,
    cosine_similarity(ARRAY[1, 0, 0], ARRAY[0, 1, 0]) AS similarity2,
    cosine_similarity(ARRAY[1, 2, 3], ARRAY[2, 4, 6]) AS similarity3;
```

### 2.2 çš®å°”é€Šç›¸å…³ç³»æ•°

**çš®å°”é€Šç›¸å…³ç³»æ•°**è¡¡é‡ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³æ€§ã€‚

```sql
-- çš®å°”é€Šç›¸å…³ç³»æ•°è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çš®å°”é€Šç›¸å…³ç³»æ•°è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç”¨æˆ·é—´çš„çš®å°”é€Šç›¸å…³ç³»æ•°
WITH user_stats AS (
    SELECT
        user_id,
        AVG(rating) AS avg_rating,
        STDDEV(rating) AS std_rating
    FROM user_ratings
    GROUP BY user_id
),
user_ratings_normalized AS (
    SELECT
        ur.user_id,
        ur.item_id,
        ur.rating,
        us.avg_rating,
        (ur.rating - us.avg_rating) / NULLIF(us.std_rating, 0) AS normalized_rating
    FROM user_ratings ur
    JOIN user_stats us ON ur.user_id = us.user_id
),
pearson_correlation AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        COUNT(*) AS common_items,
        SUM(u1.normalized_rating * u2.normalized_rating) /
        NULLIF(COUNT(*), 0) AS correlation
    FROM user_ratings_normalized u1
    JOIN user_ratings_normalized u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
    HAVING COUNT(*) >= 2  -- è‡³å°‘2ä¸ªå…±åŒè¯„åˆ†
)
SELECT
    user1_id,
    user2_id,
    common_items,
    ROUND(correlation::numeric, 4) AS pearson_correlation
FROM pearson_correlation
ORDER BY correlation DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    u1.user_id,
    u2.user_id,
    COUNT(*) AS common_items
FROM user_ratings u1
JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
GROUP BY u1.user_id, u2.user_id
LIMIT 100;
```

---

### 2.3 Jaccardç›¸ä¼¼åº¦

**Jaccardç›¸ä¼¼åº¦**é€‚ç”¨äºäºŒå…ƒè¯„åˆ†ï¼ˆå–œæ¬¢/ä¸å–œæ¬¢ï¼‰ã€‚

```sql
-- Jaccardç›¸ä¼¼åº¦è®¡ç®—ï¼šé€‚ç”¨äºäºŒå…ƒè¯„åˆ†
WITH user_items AS (
    SELECT
        user_id,
        ARRAY_AGG(DISTINCT item_id ORDER BY item_id) AS item_list
    FROM user_ratings
    WHERE rating >= 4  -- åªè€ƒè™‘é«˜åˆ†ï¼ˆå–œæ¬¢ï¼‰
    GROUP BY user_id
),
jaccard_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        -- äº¤é›†å¤§å°
        (
            SELECT COUNT(*)
            FROM unnest(u1.item_list) AS item
            WHERE item = ANY(u2.item_list)
        ) AS intersection_size,
        -- å¹¶é›†å¤§å°
        (
            SELECT COUNT(DISTINCT item)
            FROM (
                SELECT unnest(u1.item_list) AS item
                UNION
                SELECT unnest(u2.item_list) AS item
            ) AS union_items
        ) AS union_size
    FROM user_items u1
    JOIN user_items u2 ON u1.user_id < u2.user_id
)
SELECT
    user1_id,
    user2_id,
    intersection_size,
    union_size,
    -- Jaccardç›¸ä¼¼åº¦ = äº¤é›† / å¹¶é›†
    ROUND((intersection_size::numeric / NULLIF(union_size, 0))::numeric, 4) AS jaccard_similarity
FROM jaccard_similarity
WHERE union_size > 0
ORDER BY jaccard_similarity DESC;
```

### 2.4 è°ƒæ•´ä½™å¼¦ç›¸ä¼¼åº¦

**è°ƒæ•´ä½™å¼¦ç›¸ä¼¼åº¦**è€ƒè™‘ç”¨æˆ·è¯„åˆ†åå·®ã€‚

```sql
-- è°ƒæ•´ä½™å¼¦ç›¸ä¼¼åº¦ï¼šå‡å»ç”¨æˆ·å¹³å‡è¯„åˆ†
WITH user_means AS (
    SELECT
        user_id,
        AVG(rating) AS mean_rating
    FROM user_ratings
    GROUP BY user_id
),
adjusted_ratings AS (
    SELECT
        ur.user_id,
        ur.item_id,
        ur.rating - um.mean_rating AS adjusted_rating
    FROM user_ratings ur
    JOIN user_means um ON ur.user_id = um.user_id
),
adjusted_cosine AS (
    SELECT
        a1.user_id AS user1_id,
        a2.user_id AS user2_id,
        SUM(a1.adjusted_rating * a2.adjusted_rating) AS dot_product,
        SQRT(SUM(a1.adjusted_rating * a1.adjusted_rating)) AS norm1,
        SQRT(SUM(a2.adjusted_rating * a2.adjusted_rating)) AS norm2
    FROM adjusted_ratings a1
    JOIN adjusted_ratings a2 ON a1.item_id = a2.item_id AND a1.user_id < a2.user_id
    GROUP BY a1.user_id, a2.user_id
)
SELECT
    user1_id,
    user2_id,
    ROUND((dot_product / NULLIF(norm1 * norm2, 0))::numeric, 4) AS adjusted_cosine_similarity
FROM adjusted_cosine
ORDER BY adjusted_cosine_similarity DESC;
```

---

## 3. æ¨èç”Ÿæˆ

### 3.1 æ¨èç”ŸæˆåŸç†

**æ¨èç”Ÿæˆ**åŸºäºç›¸ä¼¼åº¦è®¡ç®—ç»“æœï¼Œé¢„æµ‹ç”¨æˆ·å¯¹æœªè¯„åˆ†ç‰©å“çš„è¯„åˆ†ï¼Œå¹¶ç”Ÿæˆæ¨èåˆ—è¡¨ã€‚

#### æ¨èç”Ÿæˆæ–¹æ³•

1. **Top-Næ¨è**ï¼šæ¨èè¯„åˆ†æœ€é«˜çš„Nä¸ªç‰©å“
2. **é˜ˆå€¼æ¨è**ï¼šæ¨èè¯„åˆ†è¶…è¿‡é˜ˆå€¼çš„ç‰©å“
3. **åŠ æƒæ¨è**ï¼šæ ¹æ®ç›¸ä¼¼åº¦åŠ æƒè®¡ç®—é¢„æµ‹è¯„åˆ†

### 3.2 Top-Næ¨èå®ç°

```sql
-- Top-Næ¨èç”Ÿæˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•ç”ŸæˆTop-Næ¨è';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”ŸæˆTop-Næ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Top-Næ¨èç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸ºç”¨æˆ·1ç”ŸæˆTop-5æ¨è
WITH target_user AS (
    SELECT 1 AS user_id, 5 AS top_n
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) /
        NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity
    FROM user_ratings u1
    JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
    GROUP BY u1.user_id, u2.user_id
),
similar_users AS (
    SELECT
        CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
        similarity
    FROM user_similarity
    WHERE similarity > 0.3  -- ç›¸ä¼¼åº¦é˜ˆå€¼
),
recommendations AS (
    SELECT
        r.item_id,
        SUM(r.rating * s.similarity) / SUM(s.similarity) AS predicted_rating,
        COUNT(*) AS recommendation_count,
        SUM(s.similarity) AS total_similarity
    FROM user_ratings r
    JOIN similar_users s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
    HAVING COUNT(*) >= 2  -- è‡³å°‘2ä¸ªç›¸ä¼¼ç”¨æˆ·æ¨è
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating,
    recommendation_count,
    ROUND(total_similarity::numeric, 4) AS total_similarity
FROM recommendations
ORDER BY predicted_rating DESC, total_similarity DESC
LIMIT (SELECT top_n FROM target_user);

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    item_id,
    AVG(rating) AS avg_rating
FROM user_ratings
WHERE user_id = 1
GROUP BY item_id
LIMIT 10;
```

---

### 3.3 åŠ æƒæ¨èç”Ÿæˆ

**åŠ æƒæ¨è**ä½¿ç”¨ç›¸ä¼¼åº¦åŠ æƒè®¡ç®—é¢„æµ‹è¯„åˆ†ã€‚

```sql
-- åŠ æƒæ¨èç”Ÿæˆï¼šè€ƒè™‘ç›¸ä¼¼åº¦å’Œè¯„åˆ†æ•°é‡
WITH target_user AS (
    SELECT 1 AS user_id
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) /
        NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity,
        COUNT(*) AS common_items
    FROM user_ratings u1
    JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
    GROUP BY u1.user_id, u2.user_id
    HAVING COUNT(*) >= 2  -- è‡³å°‘2ä¸ªå…±åŒè¯„åˆ†
),
similar_users AS (
    SELECT
        CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
        similarity,
        common_items,
        -- åŠ æƒç›¸ä¼¼åº¦ï¼šè€ƒè™‘å…±åŒè¯„åˆ†æ•°é‡
        similarity * LOG(1 + common_items) AS weighted_similarity
    FROM user_similarity
    WHERE similarity > 0.3
),
recommendations AS (
    SELECT
        r.item_id,
        -- åŠ æƒå¹³å‡é¢„æµ‹è¯„åˆ†
        SUM(r.rating * s.weighted_similarity) / SUM(s.weighted_similarity) AS predicted_rating,
        COUNT(*) AS recommendation_count,
        SUM(s.weighted_similarity) AS total_weight
    FROM user_ratings r
    JOIN similar_users s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
    HAVING COUNT(*) >= 2
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating,
    recommendation_count,
    ROUND(total_weight::numeric, 4) AS total_weight
FROM recommendations
ORDER BY predicted_rating DESC, total_weight DESC
LIMIT 10;
```

---

## 4. åŸºäºå‘é‡çš„æ¨èï¼ˆpgvectorï¼‰

### 4.1 å‘é‡æ¨èæ¦‚è¿°

**åŸºäºå‘é‡çš„æ¨èï¼ˆVector-based Recommendationï¼‰**ï¼šä½¿ç”¨pgvectoræ‰©å±•è¿›è¡Œè¯­ä¹‰çº§åˆ«çš„æ¨èï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦å®ç°æ›´å‡†ç¡®çš„ç‰©å“æ¨èã€‚

#### å‘é‡æ¨èåŸç†

**å‘é‡æ¨è**ï¼šå°†ç”¨æˆ·å’Œç‰©å“è½¬æ¢ä¸ºå‘é‡åµŒå…¥ï¼ˆembeddingï¼‰ï¼Œé€šè¿‡è®¡ç®—å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œæ¨èã€‚

**å‘é‡æ¨èä¼˜åŠ¿**ï¼š
- è¯­ä¹‰ç†è§£èƒ½åŠ›å¼º
- æ”¯æŒå†·å¯åŠ¨é—®é¢˜
- å¯ä»¥ç»“åˆé¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚OpenAIã€Cohereï¼‰

#### pgvectoræ‰©å±•å®‰è£…

```sql
-- å®‰è£…pgvectoræ‰©å±•ï¼ˆéœ€è¦PostgreSQL 11+ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE EXTENSION IF NOT EXISTS vector;
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'pgvectoræ‰©å±•å®‰è£…å¤±è´¥: %ã€‚è¯·ç¡®ä¿å·²å®‰è£…pgvectoræ‰©å±•ã€‚', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 å‘é‡æ¨èå®ç°

**åˆ›å»ºå‘é‡æ¨èè¡¨**ï¼š

```sql
-- åˆ›å»ºç‰©å“å‘é‡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'item_embeddings') THEN
            RAISE WARNING 'è¡¨ item_embeddings å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE item_embeddings CASCADE;
        END IF;

        -- åˆ›å»ºåŒ…å«å‘é‡åµŒå…¥çš„ç‰©å“è¡¨
        CREATE TABLE item_embeddings (
            item_id SERIAL PRIMARY KEY,
            item_name TEXT NOT NULL,
            description TEXT,
            -- ä½¿ç”¨vectorç±»å‹å­˜å‚¨1536ç»´å‘é‡ï¼ˆOpenAI text-embedding-3-largeï¼‰
            embedding vector(1536),
            category TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- åˆ›å»ºå‘é‡ç›¸ä¼¼åº¦ç´¢å¼•ï¼ˆHNSWç´¢å¼•ï¼ŒPostgreSQL 18+ï¼‰
        CREATE INDEX idx_item_embeddings_vector
        ON item_embeddings
        USING hnsw (embedding vector_cosine_ops)
        WITH (m = 16, ef_construction = 64);

        RAISE NOTICE 'ç‰©å“å‘é‡è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©å“å‘é‡è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„æ¨è**ï¼š

```sql
-- å‘é‡æ¨èï¼šåŸºäºç”¨æˆ·å†å²ç‰©å“çš„å‘é‡ç›¸ä¼¼åº¦æ¨èï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'item_embeddings') THEN
            RAISE WARNING 'è¡¨ item_embeddings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‘é‡æ¨è';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‘é‡æ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡æ¨èå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å‘é‡æ¨èï¼šåŸºäºç”¨æˆ·å†å²ç‰©å“æ¨èç›¸ä¼¼ç‰©å“
WITH user_history AS (
    SELECT
        u.user_id,
        AVG(ie.embedding) AS user_embedding
    FROM user_ratings ur
    JOIN item_embeddings ie ON ur.item_id = ie.item_id
    WHERE ur.rating >= 4  -- åªè€ƒè™‘é«˜åˆ†ç‰©å“
    GROUP BY u.user_id
),
recommendations AS (
    SELECT
        uh.user_id,
        ie.item_id,
        ie.item_name,
        ie.category,
        1 - (ie.embedding <=> uh.user_embedding) AS similarity_score
    FROM user_history uh
    CROSS JOIN item_embeddings ie
    WHERE NOT EXISTS (
        SELECT 1 FROM user_ratings ur
        WHERE ur.user_id = uh.user_id AND ur.item_id = ie.item_id
    )  -- æ’é™¤å·²è¯„åˆ†ç‰©å“
)
SELECT
    user_id,
    item_id,
    item_name,
    category,
    similarity_score
FROM recommendations
WHERE similarity_score > 0.7  -- ç›¸ä¼¼åº¦é˜ˆå€¼
ORDER BY user_id, similarity_score DESC
LIMIT 10;  -- æ¯ä¸ªç”¨æˆ·æ¨è10ä¸ªç‰©å“
```

**æ··åˆæ¨èï¼ˆå‘é‡ + ååŒè¿‡æ»¤ï¼‰**ï¼š

```sql
-- æ··åˆæ¨èï¼šç»“åˆå‘é‡ç›¸ä¼¼åº¦å’ŒååŒè¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
WITH vector_recommendations AS (
    -- å‘é‡æ¨èåˆ†æ•°
    SELECT
        u.user_id,
        ie.item_id,
        1 - (ie.embedding <=> (SELECT AVG(ie2.embedding)
                               FROM user_ratings ur2
                               JOIN item_embeddings ie2 ON ur2.item_id = ie2.item_id
                               WHERE ur2.user_id = u.user_id AND ur2.rating >= 4)) AS vector_score
    FROM users u
    CROSS JOIN item_embeddings ie
    WHERE NOT EXISTS (
        SELECT 1 FROM user_ratings ur
        WHERE ur.user_id = u.user_id AND ur.item_id = ie.item_id
    )
),
collaborative_recommendations AS (
    -- ååŒè¿‡æ»¤æ¨èåˆ†æ•°
    SELECT
        ur.user_id,
        ur2.item_id,
        AVG(ur2.rating) AS cf_score
    FROM user_ratings ur
    JOIN user_ratings ur2 ON ur.item_id = ur2.item_id AND ur.user_id != ur2.user_id
    WHERE ur.rating >= 4
    GROUP BY ur.user_id, ur2.item_id
    HAVING COUNT(*) >= 2
)
SELECT
    COALESCE(vr.user_id, cf.user_id) AS user_id,
    COALESCE(vr.item_id, cf.item_id) AS item_id,
    COALESCE(vr.vector_score, 0) AS vector_score,
    COALESCE(cf.cf_score, 0) AS cf_score,
    -- åŠ æƒç»„åˆï¼šå‘é‡æ¨èæƒé‡0.6ï¼ŒååŒè¿‡æ»¤æƒé‡0.4
    (COALESCE(vr.vector_score, 0) * 0.6 + COALESCE(cf.cf_score, 0) * 0.4) AS final_score
FROM vector_recommendations vr
FULL OUTER JOIN collaborative_recommendations cf
    ON vr.user_id = cf.user_id AND vr.item_id = cf.item_id
WHERE (COALESCE(vr.vector_score, 0) * 0.6 + COALESCE(cf.cf_score, 0) * 0.4) > 0.6
ORDER BY user_id, final_score DESC
LIMIT 10;
```

### 4.3 å‘é‡æ¨èæ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- pgvectorç´¢å¼•ä¼˜åŒ–ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- HNSWç´¢å¼•ï¼šé€‚åˆé«˜ç»´å‘é‡ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'item_embeddings' AND indexname = 'idx_item_embeddings_vector') THEN
            RAISE WARNING 'å‘é‡ç´¢å¼•å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_item_embeddings_vector
            ON item_embeddings
            USING hnsw (embedding vector_cosine_ops)
            WITH (m = 16, ef_construction = 64);
            RAISE NOTICE 'HNSWå‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘é‡ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. å†…å®¹è¿‡æ»¤æ¨è

### 5.1 å†…å®¹è¿‡æ»¤åŸç†

**å†…å®¹è¿‡æ»¤ï¼ˆContent-Based Filteringï¼‰**åŸºäºç‰©å“çš„ç‰¹å¾å’Œç”¨æˆ·çš„å†å²åå¥½ï¼Œæ¨èä¸ç”¨æˆ·å–œæ¬¢è¿‡çš„ç‰©å“ç›¸ä¼¼çš„ç‰©å“ã€‚

#### å†…å®¹è¿‡æ»¤ä¼˜åŠ¿

1. **æ— éœ€ç”¨æˆ·æ•°æ®**ï¼šåªéœ€è¦ç‰©å“ç‰¹å¾
2. **å¯è§£é‡Šæ€§å¼º**ï¼šå¯ä»¥è§£é‡Šæ¨èåŸå› 
3. **æ— å†·å¯åŠ¨é—®é¢˜**ï¼šæ–°ç‰©å“å¯ä»¥ç«‹å³æ¨è

#### å†…å®¹è¿‡æ»¤æŒ‘æˆ˜

1. **ç‰¹å¾æå–å›°éš¾**ï¼šéœ€è¦æå–æœ‰æ•ˆçš„ç‰©å“ç‰¹å¾
2. **è¿‡åº¦ä¸“ä¸šåŒ–**ï¼šå¯èƒ½åªæ¨èç›¸ä¼¼ç‰©å“
3. **æ–°ç”¨æˆ·é—®é¢˜**ï¼šæ–°ç”¨æˆ·ç¼ºä¹å†å²æ•°æ®

### 5.2 å†…å®¹è¿‡æ»¤å®ç°

```sql
-- å†…å®¹è¿‡æ»¤æ¨èï¼šåŸºäºç‰©å“ç‰¹å¾ç›¸ä¼¼åº¦
WITH item_features AS (
    SELECT
        item_id,
        category,
        price_range,
        rating_avg,
        -- ç‰¹å¾å‘é‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
        ARRAY[
            CASE category WHEN 'electronics' THEN 1 ELSE 0 END,
            CASE category WHEN 'books' THEN 1 ELSE 0 END,
            CASE category WHEN 'clothing' THEN 1 ELSE 0 END,
            CASE WHEN price_range < 50 THEN 1 ELSE 0 END,
            CASE WHEN price_range >= 50 AND price_range < 100 THEN 1 ELSE 0 END,
            CASE WHEN price_range >= 100 THEN 1 ELSE 0 END
        ] AS feature_vector
    FROM items
),
user_preferences AS (
    SELECT
        user_id,
        -- ç”¨æˆ·åå¥½å‘é‡ï¼ˆåŸºäºå†å²è¯„åˆ†ï¼‰
        ARRAY[
            AVG(CASE WHEN category = 'electronics' THEN rating ELSE NULL END),
            AVG(CASE WHEN category = 'books' THEN rating ELSE NULL END),
            AVG(CASE WHEN category = 'clothing' THEN rating ELSE NULL END),
            AVG(CASE WHEN price_range < 50 THEN rating ELSE NULL END),
            AVG(CASE WHEN price_range >= 50 AND price_range < 100 THEN rating ELSE NULL END),
            AVG(CASE WHEN price_range >= 100 THEN rating ELSE NULL END)
        ] AS preference_vector
    FROM user_ratings ur
    JOIN items i ON ur.item_id = i.item_id
    GROUP BY user_id
),
content_recommendations AS (
    SELECT
        up.user_id,
        if.item_id,
        -- ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ç‰©å“ä¸ç”¨æˆ·åå¥½çš„åŒ¹é…åº¦
        cosine_similarity(if.feature_vector, up.preference_vector) AS content_score
    FROM user_preferences up
    CROSS JOIN item_features if
    WHERE if.item_id NOT IN (
        SELECT item_id FROM user_ratings WHERE user_id = up.user_id
    )
)
SELECT
    user_id,
    item_id,
    ROUND(content_score::numeric, 4) AS content_score
FROM content_recommendations
WHERE content_score > 0.5
ORDER BY user_id, content_score DESC
LIMIT 10;
```

---

## 6. æ··åˆæ¨è

### 6.1 æ··åˆæ¨èåŸç†

**æ··åˆæ¨èï¼ˆHybrid Recommendationï¼‰**ç»“åˆå¤šç§æ¨èæ–¹æ³•ï¼Œåˆ©ç”¨å„è‡ªçš„ä¼˜åŠ¿ï¼Œæé«˜æ¨èè´¨é‡ã€‚

#### æ··åˆç­–ç•¥

1. **åŠ æƒæ··åˆ**ï¼š$score = \alpha \cdot CF + (1-\alpha) \cdot CB$
2. **åˆ‡æ¢æ··åˆ**ï¼šæ ¹æ®æƒ…å†µé€‰æ‹©ä¸åŒæ–¹æ³•
3. **çº§è”æ··åˆ**ï¼šå…ˆç”¨ä¸€ç§æ–¹æ³•ç­›é€‰ï¼Œå†ç”¨å¦ä¸€ç§æ–¹æ³•æ’åº

### 6.2 æ··åˆæ¨èå®ç°

```sql
-- æ··åˆæ¨èï¼šç»“åˆååŒè¿‡æ»¤å’Œå†…å®¹è¿‡æ»¤
WITH target_user AS (
    SELECT 1 AS user_id, 0.6 AS cf_weight, 0.4 AS cb_weight
),
-- ååŒè¿‡æ»¤è¯„åˆ†
cf_scores AS (
    SELECT
        r.item_id,
        SUM(r.rating * s.similarity) / SUM(s.similarity) AS cf_score
    FROM user_ratings r
    JOIN (
        SELECT
            CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
            similarity
        FROM (
            SELECT
                u1.user_id AS user1_id,
                u2.user_id AS user2_id,
                SUM(u1.rating * u2.rating) /
                NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity
            FROM user_ratings u1
            JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
            WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
            GROUP BY u1.user_id, u2.user_id
        ) sim
        WHERE similarity > 0.3
    ) s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
),
-- å†…å®¹è¿‡æ»¤è¯„åˆ†ï¼ˆç®€åŒ–ç‰ˆï¼‰
cb_scores AS (
    SELECT
        i.item_id,
        -- åŸºäºç±»åˆ«åŒ¹é…çš„ç®€å•è¯„åˆ†
        CASE
            WHEN i.category IN (
                SELECT DISTINCT i2.category
                FROM user_ratings ur
                JOIN items i2 ON ur.item_id = i2.item_id
                WHERE ur.user_id = (SELECT user_id FROM target_user) AND ur.rating >= 4
            ) THEN 0.8
            ELSE 0.3
        END AS cb_score
    FROM items i
    WHERE i.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
),
-- æ··åˆè¯„åˆ†
hybrid_scores AS (
    SELECT
        COALESCE(cf.item_id, cb.item_id) AS item_id,
        COALESCE(cf.cf_score, 0) * (SELECT cf_weight FROM target_user) +
        COALESCE(cb.cb_score, 0) * (SELECT cb_weight FROM target_user) AS hybrid_score
    FROM cf_scores cf
    FULL OUTER JOIN cb_scores cb ON cf.item_id = cb.item_id
)
SELECT
    item_id,
    ROUND(hybrid_score::numeric, 4) AS hybrid_score
FROM hybrid_scores
ORDER BY hybrid_score DESC
LIMIT 10;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 å•†å“æ¨è

**å•†å“æ¨è**ä¸ºç”µå•†ç”¨æˆ·æ¨èå¯èƒ½æ„Ÿå…´è¶£çš„å•†å“ã€‚

```sql
-- å•†å“æ¨èç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'product_interactions') THEN
            RAISE WARNING 'è¡¨ product_interactions ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE product_interactions (
                user_id INTEGER NOT NULL,
                product_id INTEGER NOT NULL,
                interaction_type VARCHAR(20) NOT NULL,  -- 'view', 'purchase', 'cart'
                interaction_score NUMERIC NOT NULL,  -- 1-5åˆ†
                interaction_time TIMESTAMP DEFAULT NOW(),
                PRIMARY KEY (user_id, product_id, interaction_type)
            );

            INSERT INTO product_interactions (user_id, product_id, interaction_type, interaction_score) VALUES
                (1, 101, 'purchase', 5), (1, 102, 'view', 4), (1, 103, 'cart', 3),
                (2, 101, 'purchase', 4), (2, 102, 'purchase', 5), (2, 104, 'view', 3),
                (3, 102, 'purchase', 4), (3, 103, 'purchase', 5), (3, 105, 'view', 4),
                (4, 101, 'view', 2), (4, 103, 'purchase', 5), (4, 105, 'purchase', 4);

            RAISE NOTICE 'è¡¨ product_interactions åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå•†å“æ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å•†å“æ¨èå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—åŠ æƒè¯„åˆ†ï¼ˆä¸åŒäº¤äº’ç±»å‹æƒé‡ä¸åŒï¼‰
WITH weighted_ratings AS (
    SELECT
        user_id,
        product_id,
        SUM(CASE interaction_type
            WHEN 'purchase' THEN interaction_score * 3
            WHEN 'cart' THEN interaction_score * 2
            WHEN 'view' THEN interaction_score * 1
            ELSE interaction_score
        END) /
        SUM(CASE interaction_type
            WHEN 'purchase' THEN 3
            WHEN 'cart' THEN 2
            WHEN 'view' THEN 1
            ELSE 1
        END) AS weighted_rating
    FROM product_interactions
    GROUP BY user_id, product_id
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.weighted_rating * u2.weighted_rating) /
        NULLIF(SQRT(SUM(u1.weighted_rating * u1.weighted_rating)) *
               SQRT(SUM(u2.weighted_rating * u2.weighted_rating)), 0) AS similarity
    FROM weighted_ratings u1
    JOIN weighted_ratings u2 ON u1.product_id = u2.product_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
),
recommendations AS (
    SELECT
        wr.product_id,
        SUM(wr.weighted_rating * us.similarity) / SUM(us.similarity) AS predicted_score
    FROM weighted_ratings wr
    JOIN user_similarity us ON wr.user_id = us.user2_id
    WHERE us.user1_id = 1  -- ä¸ºç›®æ ‡ç”¨æˆ·æ¨è
      AND wr.product_id NOT IN (SELECT product_id FROM weighted_ratings WHERE user_id = 1)
    GROUP BY wr.product_id
    HAVING COUNT(*) >= 1
)
SELECT
    product_id,
    ROUND(predicted_score::numeric, 2) AS predicted_score
FROM recommendations
ORDER BY predicted_score DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    product_id,
    AVG(interaction_score) AS avg_score
FROM product_interactions
GROUP BY user_id, product_id
LIMIT 100;
```

---

### 7.2 ç”µå½±æ¨èç³»ç»Ÿ

**åœºæ™¯**ï¼šä¸ºè§†é¢‘å¹³å°ç”¨æˆ·æ¨èç”µå½±ã€‚

```sql
-- ç”µå½±æ¨èç³»ç»Ÿï¼šç»“åˆè¯„åˆ†ã€è§‚çœ‹æ—¶é•¿ã€æ”¶è—ç­‰è¡Œä¸º
WITH user_movie_interactions AS (
    SELECT
        user_id,
        movie_id,
        -- ç»¼åˆè¯„åˆ†ï¼šè€ƒè™‘è¯„åˆ†ã€è§‚çœ‹æ—¶é•¿ã€æ”¶è—
        (
            COALESCE(rating, 0) * 0.5 +
            CASE WHEN watch_duration > 0.8 THEN 4 ELSE 0 END * 0.3 +
            CASE WHEN favorited THEN 5 ELSE 0 END * 0.2
        ) AS interaction_score
    FROM movie_interactions
    WHERE rating IS NOT NULL OR watch_duration > 0 OR favorited = true
),
movie_similarity AS (
    SELECT
        m1.movie_id AS movie1_id,
        m2.movie_id AS movie2_id,
        -- åŸºäºå…±åŒç”¨æˆ·çš„ç›¸ä¼¼åº¦
        COUNT(DISTINCT m1.user_id) AS common_users,
        SUM(m1.interaction_score * m2.interaction_score) /
        NULLIF(
            SQRT(SUM(m1.interaction_score * m1.interaction_score)) *
            SQRT(SUM(m2.interaction_score * m2.interaction_score)),
            0
        ) AS similarity
    FROM user_movie_interactions m1
    JOIN user_movie_interactions m2 ON m1.user_id = m2.user_id AND m1.movie_id < m2.movie_id
    GROUP BY m1.movie_id, m2.movie_id
    HAVING COUNT(DISTINCT m1.user_id) >= 5  -- è‡³å°‘5ä¸ªå…±åŒç”¨æˆ·
),
recommendations AS (
    SELECT
        target.user_id,
        CASE WHEN ms.movie1_id = um.movie_id THEN ms.movie2_id ELSE ms.movie1_id END AS recommended_movie_id,
        SUM(um.interaction_score * ms.similarity) / SUM(ms.similarity) AS predicted_score
    FROM (SELECT DISTINCT user_id FROM user_movie_interactions) target
    CROSS JOIN user_movie_interactions um
    JOIN movie_similarity ms ON (ms.movie1_id = um.movie_id OR ms.movie2_id = um.movie_id)
    WHERE um.user_id = target.user_id
      AND CASE WHEN ms.movie1_id = um.movie_id THEN ms.movie2_id ELSE ms.movie1_id END
          NOT IN (SELECT movie_id FROM user_movie_interactions WHERE user_id = target.user_id)
    GROUP BY target.user_id, CASE WHEN ms.movie1_id = um.movie_id THEN ms.movie2_id ELSE ms.movie1_id END
)
SELECT
    user_id,
    recommended_movie_id,
    ROUND(predicted_score::numeric, 2) AS predicted_score
FROM recommendations
ORDER BY user_id, predicted_score DESC
LIMIT 10;
```

### 7.3 æ–°é—»æ¨èç³»ç»Ÿ

**åœºæ™¯**ï¼šä¸ºæ–°é—»å¹³å°ç”¨æˆ·æ¨èæ–°é—»æ–‡ç« ã€‚

```sql
-- æ–°é—»æ¨èç³»ç»Ÿï¼šåŸºäºé˜…è¯»å†å²å’Œæ–‡ç« ç›¸ä¼¼åº¦
WITH user_reading_history AS (
    SELECT
        user_id,
        article_id,
        read_duration,
        click_time,
        -- é˜…è¯»å…´è¶£è¯„åˆ†
        CASE
            WHEN read_duration > 60 THEN 5  -- æ·±åº¦é˜…è¯»
            WHEN read_duration > 30 THEN 4  -- ä¸­ç­‰é˜…è¯»
            WHEN read_duration > 10 THEN 3  -- æµ…åº¦é˜…è¯»
            ELSE 2  -- å¿«é€Ÿæµè§ˆ
        END AS interest_score
    FROM article_reads
    WHERE click_time >= NOW() - INTERVAL '30 days'  -- æœ€è¿‘30å¤©
),
article_similarity AS (
    SELECT
        a1.article_id AS article1_id,
        a2.article_id AS article2_id,
        -- åŸºäºç±»åˆ«çš„ç›¸ä¼¼åº¦
        CASE
            WHEN a1.category = a2.category THEN 0.8
            WHEN a1.category IN (SELECT related_categories FROM articles WHERE article_id = a2.article_id) THEN 0.5
            ELSE 0.2
        END AS category_similarity,
        -- åŸºäºæ ‡ç­¾çš„ç›¸ä¼¼åº¦
        (
            SELECT COUNT(*)
            FROM unnest(a1.tags) AS tag
            WHERE tag = ANY(a2.tags)
        )::numeric / NULLIF(
            (
                SELECT COUNT(DISTINCT tag)
                FROM (
                    SELECT unnest(a1.tags) AS tag
                    UNION
                    SELECT unnest(a2.tags) AS tag
                ) AS all_tags
            ),
            0
        ) AS tag_similarity
    FROM articles a1
    JOIN articles a2 ON a1.article_id < a2.article_id
),
recommendations AS (
    SELECT
        urh.user_id,
        CASE WHEN asim.article1_id = urh.article_id THEN asim.article2_id ELSE asim.article1_id END AS recommended_article_id,
        SUM(urh.interest_score * (asim.category_similarity * 0.6 + asim.tag_similarity * 0.4)) /
        SUM(asim.category_similarity * 0.6 + asim.tag_similarity * 0.4) AS predicted_score
    FROM user_reading_history urh
    JOIN article_similarity asim ON (asim.article1_id = urh.article_id OR asim.article2_id = urh.article_id)
    WHERE CASE WHEN asim.article1_id = urh.article_id THEN asim.article2_id ELSE asim.article1_id END
          NOT IN (SELECT article_id FROM user_reading_history WHERE user_id = urh.user_id)
    GROUP BY urh.user_id, CASE WHEN asim.article1_id = urh.article_id THEN asim.article2_id ELSE asim.article1_id END
)
SELECT
    user_id,
    recommended_article_id,
    ROUND(predicted_score::numeric, 2) AS predicted_score
FROM recommendations
ORDER BY user_id, predicted_score DESC
LIMIT 10;
```

### 7.4 æ¨èç³»ç»Ÿè¯„ä¼°

**åœºæ™¯**ï¼šè¯„ä¼°æ¨èç³»ç»Ÿçš„æ€§èƒ½ã€‚

```sql
-- æ¨èç³»ç»Ÿè¯„ä¼°ï¼šè®¡ç®—MAEã€RMSEç­‰æŒ‡æ ‡
WITH test_data AS (
    SELECT
        user_id,
        item_id,
        rating AS actual_rating,
        -- é¢„æµ‹è¯„åˆ†ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨å¹³å‡è¯„åˆ†ï¼‰
        (
            SELECT AVG(rating)
            FROM user_ratings ur2
            WHERE ur2.item_id = ur1.item_id
        ) AS predicted_rating
    FROM user_ratings ur1
    WHERE user_id = 1  -- æµ‹è¯•ç”¨æˆ·
),
evaluation_metrics AS (
    SELECT
        COUNT(*) AS total_predictions,
        AVG(ABS(actual_rating - predicted_rating)) AS mae,
        SQRT(AVG(POWER(actual_rating - predicted_rating, 2))) AS rmse,
        -- å‡†ç¡®ç‡ï¼ˆé¢„æµ‹è¯¯å·®å°äº1ï¼‰
        SUM(CASE WHEN ABS(actual_rating - predicted_rating) < 1 THEN 1 ELSE 0 END)::numeric / COUNT(*) AS accuracy
    FROM test_data
)
SELECT
    total_predictions,
    ROUND(mae::numeric, 4) AS mae,
    ROUND(rmse::numeric, 4) AS rmse,
    ROUND(accuracy::numeric, 4) AS accuracy
FROM evaluation_metrics;
```

---

## 8. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 8.1 æ¨èç®—æ³•å¯¹æ¯”

| ç®—æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|-----------|-----------|---------|------|------|
| **ç”¨æˆ·ååŒè¿‡æ»¤** | $O(n^2)$ | $O(n^2)$ | ç”¨æˆ·å¤šç‰©å“å°‘ | å‘ç°æ½œåœ¨å…´è¶£ | è®¡ç®—å¤æ‚ |
| **ç‰©å“ååŒè¿‡æ»¤** | $O(m^2)$ | $O(m^2)$ | ç‰©å“å¤šç”¨æˆ·å°‘ | ç¨³å®šå¿«é€Ÿ | éœ€è¦ç‰©å“ç›¸ä¼¼åº¦ |
| **å†…å®¹è¿‡æ»¤** | $O(nm)$ | $O(m)$ | æœ‰ç‰©å“ç‰¹å¾ | å¯è§£é‡Šæ€§å¼º | ç‰¹å¾æå–å›°éš¾ |
| **æ··åˆæ¨è** | $O(n^2)$ | $O(n^2)$ | ç»¼åˆåœºæ™¯ | æ€§èƒ½æœ€ä¼˜ | å®ç°å¤æ‚ |

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è®¡ç®—ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨çŸ©é˜µåˆ†è§£ï¼ˆSVDã€NMFï¼‰
   - é‡‡æ ·è®¡ç®—ç›¸ä¼¼åº¦
   - å¹¶è¡Œå¤„ç†

2. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - ç¼“å­˜ç›¸ä¼¼åº¦çŸ©é˜µ
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾
   - å¢é‡æ›´æ–°

3. **ç®—æ³•ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨LSHï¼ˆLocality-Sensitive Hashingï¼‰
   - é™ç»´æŠ€æœ¯
   - è¿‘ä¼¼ç®—æ³•

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šå†·å¯åŠ¨é—®é¢˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å†…å®¹è¿‡æ»¤ã€çƒ­é—¨æ¨èã€ç”¨æˆ·ç”»åƒ

**é—®é¢˜2**ï¼šæ•°æ®ç¨€ç–æ€§

- **è§£å†³æ–¹æ¡ˆ**ï¼šçŸ©é˜µåˆ†è§£ã€é™ç»´æŠ€æœ¯ã€æ•°æ®å¢å¼º

**é—®é¢˜3**ï¼šè®¡ç®—æ€§èƒ½é—®é¢˜

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç´¢å¼•ã€é‡‡æ ·è®¡ç®—ã€å¢é‡æ›´æ–°

**é—®é¢˜4**ï¼šæ¨èå¤šæ ·æ€§ä¸è¶³

- **è§£å†³æ–¹æ¡ˆ**ï¼šå¤šæ ·æ€§ä¼˜åŒ–ã€æ··åˆæ¨èã€éšæœºæ€§å¼•å…¥

---

## 9. æœ€ä½³å®è·µ

### 9.1 æ¨èç³»ç»Ÿè®¾è®¡

1. **æ•°æ®å‡†å¤‡**ï¼š
   - æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®
   - æå–ç‰©å“ç‰¹å¾
   - æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†

2. **ç®—æ³•é€‰æ‹©**ï¼š
   - æ ¹æ®åœºæ™¯é€‰æ‹©ç®—æ³•
   - è€ƒè™‘è®¡ç®—èµ„æº
   - å¹³è¡¡å‡†ç¡®æ€§å’Œå¤šæ ·æ€§

3. **ç³»ç»Ÿå®ç°**ï¼š
   - å®æ—¶æ¨èvsç¦»çº¿æ¨è
   - ç¼“å­˜ç­–ç•¥
   - å¢é‡æ›´æ–°

### 9.2 æ¨èç³»ç»Ÿæ³¨æ„äº‹é¡¹

1. **å†·å¯åŠ¨**ï¼š
   - æ–°ç”¨æˆ·ï¼šä½¿ç”¨çƒ­é—¨æ¨èã€å†…å®¹è¿‡æ»¤
   - æ–°ç‰©å“ï¼šä½¿ç”¨å†…å®¹ç‰¹å¾ã€ç›¸ä¼¼ç‰©å“

2. **å¤šæ ·æ€§**ï¼š
   - é¿å…è¿‡åº¦ä¸“ä¸šåŒ–
   - å¼•å…¥éšæœºæ€§
   - ç±»åˆ«å¤šæ ·æ€§

3. **å®æ—¶æ€§**ï¼š
   - å®æ—¶æ›´æ–°ç”¨æˆ·åå¥½
   - å¿«é€Ÿå“åº”
   - å¢é‡è®¡ç®—

### 9.3 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼š
   - ä¼˜åŒ–è¿æ¥æŸ¥è¯¢
   - åˆ›å»ºé€‚å½“ç´¢å¼•
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾

2. **å‡†ç¡®æ€§**ï¼š
   - å¤„ç†NULLå€¼
   - é¿å…é™¤é›¶é”™è¯¯
   - éªŒè¯è®¡ç®—ç»“æœ

3. **å¯ç»´æŠ¤æ€§**ï¼š
   - ä½¿ç”¨æ¸…æ™°çš„å˜é‡å
   - æ·»åŠ æ³¨é‡Š
   - æ¨¡å—åŒ–è®¾è®¡

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

1. **ã€Šæ¨èç³»ç»Ÿå®è·µã€‹**ï¼ˆé¡¹äº®, 2012ï¼‰- æ¨èç³»ç»Ÿç»å…¸æ•™æ

2. **ã€Šæ¨èç³»ç»Ÿã€‹**ï¼ˆRicci, F., et al., 2011ï¼‰- æ¨èç³»ç»Ÿç†è®º

3. **ã€ŠååŒè¿‡æ»¤æ¨èç³»ç»Ÿã€‹**ï¼ˆSarwar, B., et al., 2001ï¼‰- ååŒè¿‡æ»¤ç®—æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- **èšåˆå‡½æ•°**: <https://www.postgresql.org/docs/current/functions-aggregate.html>
- **æ•°ç»„å‡½æ•°**: <https://www.postgresql.org/docs/current/functions-array.html>
- **çª—å£å‡½æ•°**: <https://www.postgresql.org/docs/current/tutorial-window.html>

### åœ¨çº¿èµ„æº

- **æ¨èç³»ç»Ÿ**: <https://en.wikipedia.org/wiki/Recommender_system>
- **ååŒè¿‡æ»¤**: <https://en.wikipedia.org/wiki/Collaborative_filtering>
- **Netflix Prize**: <https://en.wikipedia.org/wiki/Netflix_Prize>

### ç›¸å…³ç®—æ³•

- **ååŒè¿‡æ»¤ç®—æ³•**ï¼šç”¨æˆ·/ç‰©å“ååŒè¿‡æ»¤
- **å†…å®¹è¿‡æ»¤ç®—æ³•**ï¼šåŸºäºç‰¹å¾çš„æ¨è
- **çŸ©é˜µåˆ†è§£ç®—æ³•**ï¼šSVDã€NMFæ¨è
- **æ·±åº¦å­¦ä¹ æ¨è**ï¼šç¥ç»ç½‘ç»œæ¨è

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
