# PostgreSQL å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å›¾èšç±» | ç¤¾åŒºæ£€æµ‹
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å›¾èšç±»ç®—æ³•æ¦‚è¿°](#å›¾èšç±»ç®—æ³•æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [å›¾èšç±»é—®é¢˜å®šä¹‰](#å›¾èšç±»é—®é¢˜å®šä¹‰)
      - [èšç±»ç®—æ³•åˆ†ç±»](#èšç±»ç®—æ³•åˆ†ç±»)
      - [èšç±»è´¨é‡è¯„ä¼°](#èšç±»è´¨é‡è¯„ä¼°)
    - [æ ¸å¿ƒèšç±»æ–¹æ³•](#æ ¸å¿ƒèšç±»æ–¹æ³•)
  - [1. æ¨¡å—åº¦ä¼˜åŒ–](#1-æ¨¡å—åº¦ä¼˜åŒ–)
    - [1.1 æ¨¡å—åº¦åŸç†](#11-æ¨¡å—åº¦åŸç†)
      - [æ¨¡å—åº¦å®šä¹‰](#æ¨¡å—åº¦å®šä¹‰)
      - [æ¨¡å—åº¦å…¬å¼](#æ¨¡å—åº¦å…¬å¼)
    - [1.2 æ¨¡å—åº¦è®¡ç®—å®ç°](#12-æ¨¡å—åº¦è®¡ç®—å®ç°)
    - [1.3 æ¨¡å—åº¦ä¼˜åŒ–](#13-æ¨¡å—åº¦ä¼˜åŒ–)
  - [2. ç¤¾åŒºæ£€æµ‹](#2-ç¤¾åŒºæ£€æµ‹)
    - [2.1 ç¤¾åŒºæ£€æµ‹åŸç†](#21-ç¤¾åŒºæ£€æµ‹åŸç†)
      - [ç¤¾åŒºå®šä¹‰](#ç¤¾åŒºå®šä¹‰)
      - [æ£€æµ‹æ–¹æ³•](#æ£€æµ‹æ–¹æ³•)
    - [2.2 ç®€å•ç¤¾åŒºæ£€æµ‹å®ç°](#22-ç®€å•ç¤¾åŒºæ£€æµ‹å®ç°)
    - [2.3 æ ‡ç­¾ä¼ æ’­ç®—æ³•](#23-æ ‡ç­¾ä¼ æ’­ç®—æ³•)
  - [3. èšç±»è¯„ä¼°](#3-èšç±»è¯„ä¼°)
    - [3.1 èšç±»è¯„ä¼°åŸç†](#31-èšç±»è¯„ä¼°åŸç†)
      - [è¯„ä¼°æŒ‡æ ‡](#è¯„ä¼°æŒ‡æ ‡)
      - [è¯„ä¼°æ–¹æ³•](#è¯„ä¼°æ–¹æ³•)
    - [3.2 èšç±»è´¨é‡è¯„ä¼°å®ç°](#32-èšç±»è´¨é‡è¯„ä¼°å®ç°)
    - [3.3 èšç±»å¯¹æ¯”åˆ†æ](#33-èšç±»å¯¹æ¯”åˆ†æ)
  - [4. å›¾èšç±»ä¼˜åŒ–ç­–ç•¥](#4-å›¾èšç±»ä¼˜åŒ–ç­–ç•¥)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 ç®—æ³•ä¼˜åŒ–](#42-ç®—æ³•ä¼˜åŒ–)
    - [4.3 æ€§èƒ½ä¼˜åŒ–](#43-æ€§èƒ½ä¼˜åŒ–)
  - [5. PostgreSQL 18 å¹¶è¡Œå›¾èšç±»å¢å¼º](#5-postgresql-18-å¹¶è¡Œå›¾èšç±»å¢å¼º)
    - [5.1 å¹¶è¡Œå›¾èšç±»åŸç†](#51-å¹¶è¡Œå›¾èšç±»åŸç†)
    - [5.2 å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—](#52-å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—)
    - [5.3 å¹¶è¡Œç¤¾åŒºæ£€æµ‹](#53-å¹¶è¡Œç¤¾åŒºæ£€æµ‹)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹](#51-æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹)
    - [5.2 ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°](#52-ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°)
    - [5.3 çŸ¥è¯†å›¾è°±èšç±»](#53-çŸ¥è¯†å›¾è°±èšç±»)
    - [5.4 ç”Ÿç‰©ç½‘ç»œåˆ†æ](#54-ç”Ÿç‰©ç½‘ç»œåˆ†æ)
  - [7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#7-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 èšç±»ç®—æ³•å¯¹æ¯”](#61-èšç±»ç®—æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [7.1 ç®—æ³•é€‰æ‹©](#71-ç®—æ³•é€‰æ‹©)
    - [7.2 å‚æ•°è°ƒä¼˜](#72-å‚æ•°è°ƒä¼˜)
    - [7.3 æ€§èƒ½ä¼˜åŒ–](#73-æ€§èƒ½ä¼˜åŒ–)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨](#75-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨)
    - [7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§](#76-é«˜çº§ä¼˜åŒ–æŠ€å·§)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## å›¾èšç±»ç®—æ³•æ¦‚è¿°

**å›¾èšç±»ç®—æ³•ï¼ˆGraph Clustering Algorithmï¼‰**ç”¨äºè¯†åˆ«å›¾ä¸­çš„ç¤¾åŒºç»“æ„ï¼Œå°†ç´§å¯†è¿æ¥çš„èŠ‚ç‚¹åˆ†ç»„ï¼Œæ˜¯å›¾åˆ†æå’Œç¤¾äº¤ç½‘ç»œåˆ†æçš„é‡è¦å·¥å…·ã€‚

### ç†è®ºåŸºç¡€

#### å›¾èšç±»é—®é¢˜å®šä¹‰

**å›¾èšç±»é—®é¢˜**ï¼šç»™å®šå›¾$G = (V, E)$ï¼Œå°†èŠ‚ç‚¹åˆ’åˆ†ä¸º$k$ä¸ªç¤¾åŒºï¼š
$$C = \{C_1, C_2, \ldots, C_k\} \text{ such that } \bigcup_{i=1}^{k} C_i = V \text{ and } C_i \cap C_j = \emptyset$$

**èšç±»ç›®æ ‡**ï¼šæœ€å¤§åŒ–ç¤¾åŒºå†…éƒ¨è¿æ¥ï¼Œæœ€å°åŒ–ç¤¾åŒºé—´è¿æ¥ã€‚

#### èšç±»ç®—æ³•åˆ†ç±»

å›¾èšç±»ç®—æ³•åˆ†ç±»ï¼š

1. **åŸºäºæ¨¡å—åº¦**ï¼š
   - æ¨¡å—åº¦ä¼˜åŒ–
   - Louvainç®—æ³•
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(V \log V)$

2. **åŸºäºæ ‡ç­¾ä¼ æ’­**ï¼š
   - æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼ˆLPAï¼‰
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(V + E)$

3. **åŸºäºè°±èšç±»**ï¼š
   - è°±èšç±»ç®—æ³•
   - æ—¶é—´å¤æ‚åº¦ï¼š$O(V^3)$

#### èšç±»è´¨é‡è¯„ä¼°

**èšç±»è´¨é‡è¯„ä¼°æŒ‡æ ‡**ï¼š

1. **æ¨¡å—åº¦ï¼ˆModularityï¼‰**ï¼š$Q \in [-1, 1]$ï¼Œè¶Šå¤§è¶Šå¥½
2. **è½®å»“ç³»æ•°ï¼ˆSilhouette Coefficientï¼‰**ï¼š$s \in [-1, 1]$ï¼Œè¶Šå¤§è¶Šå¥½
3. **ç¤¾åŒºå†…å¯†åº¦**ï¼šç¤¾åŒºå†…éƒ¨è¾¹çš„æ¯”ä¾‹

### æ ¸å¿ƒèšç±»æ–¹æ³•

| æ–¹æ³• | æ•°å­¦å®šä¹‰ | ç”¨é€” | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|-----------|---------|
| **æ¨¡å—åº¦ä¼˜åŒ–** | $Q = \sum_{i} \left(\frac{e_{ii}}{m} - \left(\frac{d_i}{2m}\right)^2\right)$ | ç¤¾åŒºè´¨é‡è¯„ä¼° | $O(V^2)$ | $O(V^2)$ | ç¤¾åŒºæ£€æµ‹ |
| **Louvainç®—æ³•** | è¿­ä»£æ¨¡å—åº¦ä¼˜åŒ– | ç¤¾åŒºæ£€æµ‹ | $O(V \log V)$ | $O(V + E)$ | å¤§è§„æ¨¡å›¾ |
| **æ ‡ç­¾ä¼ æ’­** | èŠ‚ç‚¹æ ‡ç­¾ä¼ æ’­ | å¿«é€Ÿèšç±» | $O(V + E)$ | $O(V)$ | å¿«é€Ÿèšç±» |

---

## 1. æ¨¡å—åº¦ä¼˜åŒ–

### 1.1 æ¨¡å—åº¦åŸç†

**æ¨¡å—åº¦ï¼ˆModularityï¼‰**æ˜¯è¡¡é‡ç¤¾åŒºåˆ’åˆ†è´¨é‡çš„ç»å…¸æŒ‡æ ‡ã€‚

#### æ¨¡å—åº¦å®šä¹‰

**æ¨¡å—åº¦**ï¼šæ¨¡å—åº¦$Q$è¡¡é‡ç¤¾åŒºåˆ’åˆ†çš„è´¨é‡ï¼š
$$Q = \sum_{i=1}^{k} \left(\frac{e_{ii}}{m} - \left(\frac{d_i}{2m}\right)^2\right)$$

å…¶ä¸­ï¼š

- $e_{ii}$ï¼šç¤¾åŒº$i$å†…éƒ¨çš„è¾¹æ•°
- $m$ï¼šæ€»è¾¹æ•°
- $d_i$ï¼šç¤¾åŒº$i$ä¸­èŠ‚ç‚¹çš„æ€»åº¦æ•°

#### æ¨¡å—åº¦å…¬å¼

**æ¨¡å—åº¦èŒƒå›´**ï¼š$Q \in [-1, 1]$

- $Q > 0$ï¼šç¤¾åŒºç»“æ„æ˜æ˜¾
- $Q = 0$ï¼šéšæœºè¿æ¥
- $Q < 0$ï¼šç¤¾åŒºç»“æ„ä¸æ˜æ˜¾

### 1.2 æ¨¡å—åº¦è®¡ç®—å®ç°

**æ¨¡å—åº¦è®¡ç®—**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- æ¨¡å—åº¦è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    modularity_score NUMERIC;
    total_edges BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ¨¡å—åº¦';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'node_communities') THEN
            RAISE WARNING 'è¡¨ node_communities ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ¨¡å—åº¦';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO total_edges FROM edges;

        WITH community_edges AS (
            SELECT
                nc1.community_id,
                COUNT(*) AS internal_edges,
                (SELECT COUNT(*) FROM node_communities WHERE community_id = nc1.community_id) AS community_size
            FROM edges e
            JOIN node_communities nc1 ON e.source_id = nc1.node_id
            JOIN node_communities nc2 ON e.target_id = nc2.node_id
            WHERE nc1.community_id = nc2.community_id
            GROUP BY nc1.community_id
        )
        SELECT
            SUM(internal_edges::NUMERIC / NULLIF(total_edges, 0) - POWER(community_size::NUMERIC / NULLIF((SELECT COUNT(*) FROM node_communities), 0), 2))
        INTO modularity_score
        FROM community_edges;

        RAISE NOTICE 'æ¨¡å—åº¦: % (èŒƒå›´: -1åˆ°1ï¼Œè¶Šå¤§è¶Šå¥½)', modularity_score;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨¡å—åº¦è®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

### 1.3 æ¨¡å—åº¦ä¼˜åŒ–

**æ¨¡å—åº¦ä¼˜åŒ–**ï¼šé€šè¿‡è°ƒæ•´ç¤¾åŒºåˆ’åˆ†ä¼˜åŒ–æ¨¡å—åº¦ã€‚

```sql
-- æ¨¡å—åº¦ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'æ¨¡å—åº¦ä¼˜åŒ–éœ€è¦è¿­ä»£ç®—æ³•';
        -- å®é™…å®ç°éœ€è¦å¤šæ¬¡è¿­ä»£è°ƒæ•´ç¤¾åŒºåˆ’åˆ†
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨¡å—åº¦ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. ç¤¾åŒºæ£€æµ‹

### 2.1 ç¤¾åŒºæ£€æµ‹åŸç†

**ç¤¾åŒºæ£€æµ‹ï¼ˆCommunity Detectionï¼‰**æ˜¯è¯†åˆ«å›¾ä¸­ç¤¾åŒºç»“æ„çš„ç®—æ³•ã€‚

#### ç¤¾åŒºå®šä¹‰

**ç¤¾åŒº**ï¼šç¤¾åŒº$C$æ˜¯å›¾$G$çš„ä¸€ä¸ªå­å›¾ï¼Œæ»¡è¶³ï¼š

- ç¤¾åŒºå†…éƒ¨è¿æ¥å¯†é›†
- ç¤¾åŒºé—´è¿æ¥ç¨€ç–

#### æ£€æµ‹æ–¹æ³•

**æ£€æµ‹æ–¹æ³•**ï¼š

1. **åŸºäºæ¨¡å—åº¦**ï¼šä¼˜åŒ–æ¨¡å—åº¦å€¼
2. **åŸºäºæ ‡ç­¾ä¼ æ’­**ï¼šèŠ‚ç‚¹æ ‡ç­¾ä¼ æ’­
3. **åŸºäºè¿é€šæ€§**ï¼šä½¿ç”¨è¿é€šåˆ†é‡

### 2.2 ç®€å•ç¤¾åŒºæ£€æµ‹å®ç°

**ç®€å•ç¤¾åŒºæ£€æµ‹**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- ç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE communities AS (
    SELECT
        id AS node_id,
        id AS community_id
    FROM nodes
    UNION
    SELECT
        e.target_id,
        c.community_id
    FROM communities c
    JOIN edges e ON c.node_id = e.source_id
    WHERE (
        SELECT COUNT(*)
        FROM edges e2
        WHERE e2.source_id = e.target_id
          AND e2.target_id IN (SELECT node_id FROM communities WHERE community_id = c.community_id)
    ) > (
        SELECT COUNT(*)
        FROM edges e3
        WHERE e3.source_id = e.target_id
          AND e3.target_id NOT IN (SELECT node_id FROM communities WHERE community_id = c.community_id)
    )
)
SELECT
    community_id,
    COUNT(DISTINCT node_id) AS community_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS members
FROM communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

### 2.3 æ ‡ç­¾ä¼ æ’­ç®—æ³•

**æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼ˆLabel Propagation Algorithm, LPAï¼‰**ï¼šå¿«é€Ÿç¤¾åŒºæ£€æµ‹ç®—æ³•ã€‚

```sql
-- æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ ‡ç­¾ä¼ æ’­ç®—æ³•';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ ‡ç­¾ä¼ æ’­ç®—æ³•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ ‡ç­¾ä¼ æ’­ç®—æ³•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ ‡ç­¾ä¼ æ’­ç®—æ³•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼šèŠ‚ç‚¹é‡‡ç”¨é‚»å±…ä¸­å‡ºç°æœ€å¤šçš„æ ‡ç­¾
WITH RECURSIVE label_propagation AS (
    -- åˆå§‹åŒ–ï¼šæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨è‡ªå·±çš„IDä½œä¸ºæ ‡ç­¾
    SELECT
        id AS node_id,
        id AS label
    FROM nodes
    UNION ALL
    -- è¿­ä»£ï¼šèŠ‚ç‚¹é‡‡ç”¨é‚»å±…ä¸­å‡ºç°æœ€å¤šçš„æ ‡ç­¾
    SELECT
        n.id AS node_id,
        MODE() WITHIN GROUP (ORDER BY lp.label) AS label
    FROM nodes n
    JOIN edges e ON n.id = e.source_id OR n.id = e.target_id
    JOIN label_propagation lp ON (e.source_id = lp.node_id AND n.id = e.target_id) OR
                                  (e.target_id = lp.node_id AND n.id = e.source_id)
    GROUP BY n.id
    HAVING COUNT(*) > 0
    LIMIT 10  -- é™åˆ¶è¿­ä»£æ¬¡æ•°
)
SELECT DISTINCT ON (node_id)
    node_id,
    label AS community_id
FROM label_propagation
ORDER BY node_id, label;
```

---

## 3. èšç±»è¯„ä¼°

### 3.1 èšç±»è¯„ä¼°åŸç†

**èšç±»è¯„ä¼°ï¼ˆClustering Evaluationï¼‰**æ˜¯è¯„ä¼°èšç±»ç»“æœè´¨é‡çš„ç®—æ³•ã€‚

#### è¯„ä¼°æŒ‡æ ‡

**è¯„ä¼°æŒ‡æ ‡**ï¼š

1. **æ¨¡å—åº¦**ï¼š$Q \in [-1, 1]$
2. **è½®å»“ç³»æ•°**ï¼š$s \in [-1, 1]$
3. **ç¤¾åŒºå†…å¯†åº¦**ï¼š$\rho = \frac{2e_{in}}{n(n-1)}$

#### è¯„ä¼°æ–¹æ³•

**è¯„ä¼°æ–¹æ³•**ï¼š

1. **å†…éƒ¨è¯„ä¼°**ï¼šåŸºäºå›¾ç»“æ„è¯„ä¼°
2. **å¤–éƒ¨è¯„ä¼°**ï¼šä¸å·²çŸ¥æ ‡ç­¾å¯¹æ¯”
3. **ç¨³å®šæ€§è¯„ä¼°**ï¼šå¤šæ¬¡è¿è¡Œçš„ä¸€è‡´æ€§

### 3.2 èšç±»è´¨é‡è¯„ä¼°å®ç°

**èšç±»è´¨é‡è¯„ä¼°**çš„å®ç°å’Œä½¿ç”¨ã€‚

```sql
-- èšç±»è´¨é‡è¯„ä¼°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    avg_cluster_size NUMERIC;
    cluster_count INTEGER;
    total_nodes BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'node_communities') THEN
            RAISE WARNING 'è¡¨ node_communities ä¸å­˜åœ¨ï¼Œæ— æ³•è¯„ä¼°èšç±»è´¨é‡';
            RETURN;
        END IF;

        SELECT
            COUNT(DISTINCT community_id),
            COUNT(DISTINCT node_id),
            AVG(community_size)
        INTO cluster_count, total_nodes, avg_cluster_size
        FROM (
            SELECT
                community_id,
                COUNT(*) AS community_size
            FROM node_communities
            GROUP BY community_id
        ) AS cluster_sizes;

        RAISE NOTICE 'èšç±»è´¨é‡è¯„ä¼°:';
        RAISE NOTICE '  èšç±»æ•°é‡: %', cluster_count;
        RAISE NOTICE '  æ€»èŠ‚ç‚¹æ•°: %', total_nodes;
        RAISE NOTICE '  å¹³å‡èšç±»å¤§å°: %', avg_cluster_size;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'èšç±»è´¨é‡è¯„ä¼°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    community_id,
    COUNT(*) AS community_size,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS size_percentage
FROM node_communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

### 3.3 èšç±»å¯¹æ¯”åˆ†æ

**èšç±»å¯¹æ¯”åˆ†æ**ï¼šå¯¹æ¯”ä¸åŒèšç±»æ–¹æ³•çš„ç»“æœã€‚

```sql
-- èšç±»å¯¹æ¯”åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'èšç±»å¯¹æ¯”åˆ†æéœ€è¦å¤šç§èšç±»æ–¹æ³•çš„ç»“æœ';
        -- å®é™…å®ç°éœ€è¦è¿è¡Œå¤šç§èšç±»ç®—æ³•å¹¶å¯¹æ¯”ç»“æœ
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'èšç±»å¯¹æ¯”åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. å›¾èšç±»ä¼˜åŒ–ç­–ç•¥

### 4.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå›¾èšç±»æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- è¾¹è¡¨ç´¢å¼•ï¼šåŠ é€Ÿé‚»å±…æŸ¥æ‰¾
        CREATE INDEX IF NOT EXISTS idx_edges_source_target
        ON edges(source_id, target_id);

        CREATE INDEX IF NOT EXISTS idx_edges_target_source
        ON edges(target_id, source_id);

        -- ç¤¾åŒºè¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_node_communities_node_community
        ON node_communities(node_id, community_id);

        RAISE NOTICE 'å›¾èšç±»ç´¢å¼•åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 ç®—æ³•ä¼˜åŒ–

**ç®—æ³•ä¼˜åŒ–**ï¼šä¼˜åŒ–èšç±»ç®—æ³•å®ç°ã€‚

```sql
-- ç®—æ³•ä¼˜åŒ–ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜èšç±»ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS community_assignments_cache AS
SELECT
    node_id,
    community_id
FROM node_communities;

CREATE INDEX IF NOT EXISTS idx_community_assignments_cache_node_community
ON community_assignments_cache(node_id, community_id);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY community_assignments_cache;
```

### 4.3 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢å’Œæ‰¹é‡å¤„ç†ã€‚

```sql
-- æ€§èƒ½ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        SET work_mem = '512MB';
        RAISE NOTICE 'æ€§èƒ½ä¼˜åŒ–é…ç½®å·²è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. PostgreSQL 18 å¹¶è¡Œå›¾èšç±»å¢å¼º

**PostgreSQL 18** æ˜¾è‘—å¢å¼ºäº†å¹¶è¡Œå›¾èšç±»èƒ½åŠ›ï¼Œæ”¯æŒå¹¶è¡Œæ‰§è¡Œæ¨¡å—åº¦è®¡ç®—ã€ç¤¾åŒºæ£€æµ‹å’Œèšç±»è¯„ä¼°ï¼Œå¤§å¹…æå‡å¤§è§„æ¨¡å›¾èšç±»çš„æ€§èƒ½ã€‚

### 5.1 å¹¶è¡Œå›¾èšç±»åŸç†

PostgreSQL 18 çš„å¹¶è¡Œå›¾èšç±»é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **å¹¶è¡Œæ‰«æ**ï¼šå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ‰«æå›¾æ•°æ®
2. **å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—**ï¼šæ¯ä¸ªå·¥ä½œè¿›ç¨‹ç‹¬ç«‹è®¡ç®—æ¨¡å—åº¦
3. **å¹¶è¡Œç¤¾åŒºæ£€æµ‹**ï¼šå¹¶è¡Œæ‰§è¡Œç¤¾åŒºæ£€æµ‹ç®—æ³•
4. **ç»“æœåˆå¹¶**ï¼šä¸»è¿›ç¨‹åˆå¹¶æ‰€æœ‰å·¥ä½œè¿›ç¨‹çš„èšç±»ç»“æœ

### 5.2 å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—

```sql
-- PostgreSQL 18 å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œæ¨¡å—åº¦è®¡ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œæ¨¡å—åº¦è®¡ç®—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH graph_stats AS (
    SELECT
        COUNT(DISTINCT source_id) + COUNT(DISTINCT target_id) AS total_nodes,
        COUNT(*) AS total_edges
    FROM edges
),
community_edges AS (
    SELECT
        nc.community_id,
        COUNT(*) AS internal_edges
    FROM edges e
    JOIN node_communities nc1 ON e.source_id = nc1.node_id
    JOIN node_communities nc2 ON e.target_id = nc2.node_id
    WHERE nc1.community_id = nc2.community_id
    GROUP BY nc1.community_id
),
community_degrees AS (
    SELECT
        nc.community_id,
        COUNT(*) AS community_nodes,
        SUM(degree) AS total_degree
    FROM node_communities nc
    JOIN (SELECT source_id AS node_id, COUNT(*) AS degree FROM edges GROUP BY source_id
          UNION ALL
          SELECT target_id AS node_id, COUNT(*) AS degree FROM edges GROUP BY target_id) deg
    ON nc.node_id = deg.node_id
    GROUP BY nc.community_id
),
modularity_calc AS (
    SELECT
        ce.community_id,
        ce.internal_edges,
        cd.community_nodes,
        cd.total_degree,
        gs.total_edges,
        (ce.internal_edges::numeric / gs.total_edges) -
        (cd.total_degree::numeric / (2 * gs.total_edges))^2 AS modularity_contribution
    FROM community_edges ce
    JOIN community_degrees cd ON ce.community_id = cd.community_id
    CROSS JOIN graph_stats gs
)
SELECT
    SUM(modularity_contribution) AS total_modularity
FROM modularity_calc;
```

### 5.3 å¹¶è¡Œç¤¾åŒºæ£€æµ‹

```sql
-- PostgreSQL 18 å¹¶è¡Œç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¹¶è¡Œç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒPostgreSQL 18å¹¶è¡Œç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET max_parallel_workers_per_gather = 4;
SET parallel_setup_cost = 0;

-- å¹¶è¡Œç¤¾åŒºæ£€æµ‹ï¼šåŸºäºè¿é€šåˆ†é‡
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH RECURSIVE connected_communities AS (
    SELECT
        source_id AS node_id,
        source_id AS community_id
    FROM edges
    UNION
    SELECT
        target_id,
        source_id AS community_id
    FROM edges
    UNION
    SELECT
        e.target_id,
        cc.community_id
    FROM connected_communities cc
    JOIN edges e ON cc.node_id = e.source_id
    UNION
    SELECT
        e.source_id,
        cc.community_id
    FROM connected_communities cc
    JOIN edges e ON cc.node_id = e.target_id
)
SELECT
    community_id,
    COUNT(DISTINCT node_id) AS community_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS nodes
FROM connected_communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹

**æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹**è¯†åˆ«ç”¨æˆ·ç¤¾åŒºç”¨äºæ¨èã€‚

```sql
-- æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_interactions') THEN
            RAISE WARNING 'è¡¨ user_interactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼šåŸºäºç”¨æˆ·ç›¸ä¼¼åº¦æ„å»ºå›¾å¹¶æ£€æµ‹ç¤¾åŒº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH user_similarity AS (
    SELECT
        u1.user_id AS user1,
        u2.user_id AS user2,
        COUNT(DISTINCT u1.item_id) AS common_items,
        COUNT(DISTINCT u1.item_id)::NUMERIC /
        SQRT(COUNT(DISTINCT u1.item_id) OVER (PARTITION BY u1.user_id) *
             COUNT(DISTINCT u2.item_id) OVER (PARTITION BY u2.user_id)) AS jaccard_similarity
    FROM user_interactions u1
    JOIN user_interactions u2 ON u1.item_id = u2.item_id
    WHERE u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
    HAVING COUNT(DISTINCT u1.item_id) >= 5  -- æœ€å°ç›¸ä¼¼åº¦é˜ˆå€¼
),
user_graph AS (
    SELECT user1 AS source_id, user2 AS target_id FROM user_similarity
    UNION
    SELECT user2 AS source_id, user1 AS target_id FROM user_similarity
),
user_communities AS (
    SELECT
        user1 AS user_id,
        user1 AS community_id
    FROM user_similarity
    UNION
    SELECT
        user2,
        uc.community_id
    FROM user_communities uc
    JOIN user_similarity us ON uc.user_id = us.user1
    WHERE us.user2 NOT IN (SELECT user_id FROM user_communities WHERE community_id = uc.community_id)
)
SELECT
    community_id,
    COUNT(DISTINCT user_id) AS community_size,
    array_agg(DISTINCT user_id ORDER BY user_id) AS members
FROM user_communities
GROUP BY community_id
HAVING COUNT(DISTINCT user_id) > 1
ORDER BY community_size DESC;
```

### 5.2 ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°

**ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°**ï¼šå‘ç°ç¤¾äº¤ç½‘ç»œä¸­çš„ç”¨æˆ·ç¤¾åŒºã€‚

```sql
-- ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'social_network') THEN
            RAISE WARNING 'è¡¨ social_network ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¤¾äº¤ç½‘ç»œç¤¾åŒºå‘ç°ï¼šåŸºäºå¥½å‹å…³ç³»æ£€æµ‹ç¤¾åŒº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH RECURSIVE social_communities AS (
    SELECT
        user_id AS node_id,
        user_id AS community_id
    FROM users
    UNION
    SELECT
        sn.friend_id,
        sc.community_id
    FROM social_communities sc
    JOIN social_network sn ON sc.node_id = sn.user_id
    WHERE sn.friend_id NOT IN (
        SELECT node_id FROM social_communities WHERE community_id = sc.community_id
    )
    AND (
        -- ç¤¾åŒºæ£€æµ‹æ¡ä»¶ï¼šä¸ç¤¾åŒºå†…èŠ‚ç‚¹æœ‰è¶³å¤Ÿè¿æ¥
        SELECT COUNT(*)
        FROM social_network sn2
        WHERE sn2.user_id = sn.friend_id
          AND sn2.friend_id IN (SELECT node_id FROM social_communities WHERE community_id = sc.community_id)
    ) >= 2  -- è‡³å°‘ä¸2ä¸ªç¤¾åŒºæˆå‘˜è¿æ¥
)
SELECT
    community_id,
    COUNT(DISTINCT node_id) AS community_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS members
FROM social_communities
GROUP BY community_id
HAVING COUNT(DISTINCT node_id) > 1
ORDER BY community_size DESC;
```

### 5.3 çŸ¥è¯†å›¾è°±èšç±»

**çŸ¥è¯†å›¾è°±èšç±»**ï¼šå¯¹çŸ¥è¯†å›¾è°±ä¸­çš„å®ä½“è¿›è¡Œèšç±»ã€‚

```sql
-- çŸ¥è¯†å›¾è°±èšç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'knowledge_graph') THEN
            RAISE WARNING 'è¡¨ knowledge_graph ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒçŸ¥è¯†å›¾è°±èšç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒçŸ¥è¯†å›¾è°±èšç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çŸ¥è¯†å›¾è°±èšç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- çŸ¥è¯†å›¾è°±èšç±»ï¼šåŸºäºå®ä½“å…³ç³»èšç±»
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH entity_relations AS (
    SELECT
        source_entity_id,
        target_entity_id,
        relation_type,
        -- å…³ç³»æƒé‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
        CASE relation_type
            WHEN 'is_a' THEN 2.0
            WHEN 'part_of' THEN 1.5
            WHEN 'related_to' THEN 1.0
            ELSE 0.5
        END AS relation_weight
    FROM knowledge_graph
),
entity_similarity AS (
    SELECT
        e1.source_entity_id AS entity1,
        e2.source_entity_id AS entity2,
        COUNT(*) AS common_relations,
        SUM(e1.relation_weight + e2.relation_weight) AS similarity_score
    FROM entity_relations e1
    JOIN entity_relations e2 ON e1.target_entity_id = e2.target_entity_id
    WHERE e1.source_entity_id < e2.source_entity_id
    GROUP BY e1.source_entity_id, e2.source_entity_id
    HAVING COUNT(*) >= 3  -- è‡³å°‘3ä¸ªå…±åŒå…³ç³»
),
entity_communities AS (
    SELECT
        entity1 AS entity_id,
        entity1 AS community_id
    FROM entity_similarity
    UNION
    SELECT
        entity2,
        ec.community_id
    FROM entity_communities ec
    JOIN entity_similarity es ON ec.entity_id = es.entity1
    WHERE es.entity2 NOT IN (SELECT entity_id FROM entity_communities WHERE community_id = ec.community_id)
)
SELECT
    community_id,
    COUNT(DISTINCT entity_id) AS community_size,
    array_agg(DISTINCT entity_id ORDER BY entity_id) AS entities
FROM entity_communities
GROUP BY community_id
ORDER BY community_size DESC;
```

### 5.4 ç”Ÿç‰©ç½‘ç»œåˆ†æ

**ç”Ÿç‰©ç½‘ç»œåˆ†æ**ï¼šåˆ†æç”Ÿç‰©ç½‘ç»œä¸­çš„åŠŸèƒ½æ¨¡å—ã€‚

```sql
-- ç”Ÿç‰©ç½‘ç»œåˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'protein_interactions') THEN
            RAISE WARNING 'è¡¨ protein_interactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç”Ÿç‰©ç½‘ç»œåˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç”Ÿç‰©ç½‘ç»œåˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”Ÿç‰©ç½‘ç»œåˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿç‰©ç½‘ç»œåˆ†æï¼šè¯†åˆ«è›‹ç™½è´¨åŠŸèƒ½æ¨¡å—
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH RECURSIVE protein_modules AS (
    SELECT
        protein_id AS node_id,
        protein_id AS module_id
    FROM proteins
    UNION
    SELECT
        pi.protein2_id,
        pm.module_id
    FROM protein_modules pm
    JOIN protein_interactions pi ON pm.node_id = pi.protein1_id
    WHERE pi.protein2_id NOT IN (
        SELECT node_id FROM protein_modules WHERE module_id = pm.module_id
    )
    AND (
        -- æ¨¡å—æ£€æµ‹æ¡ä»¶ï¼šä¸æ¨¡å—å†…è›‹ç™½è´¨æœ‰è¶³å¤Ÿç›¸äº’ä½œç”¨
        SELECT COUNT(*)
        FROM protein_interactions pi2
        WHERE pi2.protein1_id = pi.protein2_id
          AND pi2.protein2_id IN (SELECT node_id FROM protein_modules WHERE module_id = pm.module_id)
    ) >= 2  -- è‡³å°‘ä¸2ä¸ªæ¨¡å—æˆå‘˜ç›¸äº’ä½œç”¨
)
SELECT
    module_id,
    COUNT(DISTINCT node_id) AS module_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS proteins
FROM protein_modules
GROUP BY module_id
HAVING COUNT(DISTINCT node_id) > 1
ORDER BY module_size DESC;
```

---

## 7. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 èšç±»ç®—æ³•å¯¹æ¯”

| ç®—æ³• | æ•°å­¦å®šä¹‰ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|-----------|-----------|---------|------|------|
| **æ¨¡å—åº¦ä¼˜åŒ–** | $Q = \sum_{i} \left(\frac{e_{ii}}{m} - \left(\frac{d_i}{2m}\right)^2\right)$ | $O(V^2)$ | $O(V^2)$ | ç¤¾åŒºæ£€æµ‹ | è´¨é‡é«˜ | æ€§èƒ½æ…¢ |
| **Louvainç®—æ³•** | è¿­ä»£æ¨¡å—åº¦ä¼˜åŒ– | $O(V \log V)$ | $O(V + E)$ | å¤§è§„æ¨¡å›¾ | å¿«é€Ÿã€è´¨é‡é«˜ | å®ç°å¤æ‚ |
| **æ ‡ç­¾ä¼ æ’­** | èŠ‚ç‚¹æ ‡ç­¾ä¼ æ’­ | $O(V + E)$ | $O(V)$ | å¿«é€Ÿèšç±» | å¿«é€Ÿ | è´¨é‡ä¸­ç­‰ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - ä¸ºè¾¹è¡¨åˆ›å»ºç´¢å¼•
   - ä¸ºç¤¾åŒºè¡¨åˆ›å»ºç´¢å¼•

2. **ç®—æ³•ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨Louvainç®—æ³•ï¼ˆå¦‚æœæ”¯æŒï¼‰
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ

3. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - é™åˆ¶æœç´¢èŒƒå›´
   - ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šèšç±»ç®—æ³•æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ ‡ç­¾ä¼ æ’­ç®—æ³•ã€åˆ›å»ºç´¢å¼•ã€å¹¶è¡ŒæŸ¥è¯¢

**é—®é¢˜2**ï¼šèšç±»è´¨é‡ä½

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ¨¡å—åº¦ä¼˜åŒ–ã€è°ƒæ•´å‚æ•°ã€å¤šæ¬¡è¿è¡Œ

**é—®é¢˜3**ï¼šå¤§è§„æ¨¡å›¾å†…å­˜ä¸è¶³

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æ‰¹å¤„ç†ã€ä½¿ç”¨æµå¼å¤„ç†ã€ä¼˜åŒ–æ•°æ®ç»“æ„

**é—®é¢˜4**ï¼šç¤¾åŒºæ•°é‡ä¸ç¡®å®š

- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ¨¡å—åº¦ä¼˜åŒ–ã€è°ƒæ•´é˜ˆå€¼ã€è¯„ä¼°æŒ‡æ ‡

---

## 8. æœ€ä½³å®è·µ

### 7.1 ç®—æ³•é€‰æ‹©

1. **å¿«é€Ÿèšç±»**ï¼šä½¿ç”¨æ ‡ç­¾ä¼ æ’­ç®—æ³•
2. **é«˜è´¨é‡èšç±»**ï¼šä½¿ç”¨æ¨¡å—åº¦ä¼˜åŒ–
3. **å¤§è§„æ¨¡å›¾**ï¼šä½¿ç”¨Louvainç®—æ³•

### 7.2 å‚æ•°è°ƒä¼˜

1. **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šæ ¹æ®åº”ç”¨åœºæ™¯è°ƒæ•´
2. **ç¤¾åŒºå¤§å°**ï¼šè®¾ç½®æœ€å°å’Œæœ€å¤§ç¤¾åŒºå¤§å°
3. **è¿­ä»£æ¬¡æ•°**ï¼šé™åˆ¶è¿­ä»£æ¬¡æ•°é¿å…æ— é™å¾ªç¯

### 7.3 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
2. **ç»“æœç¼“å­˜**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ
3. **å¹¶è¡ŒæŸ¥è¯¢**ï¼šå¯ç”¨å¹¶è¡ŒæŸ¥è¯¢å¤„ç†å¤§è§„æ¨¡æ•°æ®

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **é€’å½’æ·±åº¦**ï¼šæ³¨æ„PostgreSQLçš„é€’å½’æ·±åº¦é™åˆ¶
2. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨å¤§å›¾ä¸Šä½¿ç”¨å¤æ‚ç®—æ³•
3. **ç»“æœéªŒè¯**ï¼šéªŒè¯èšç±»ç»“æœçš„åˆç†æ€§
4. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†NULLå€¼å’Œè¾¹ç•Œæƒ…å†µ

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡å›¾èšç±»ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«æ¨¡å—åº¦çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-Kç¤¾åŒºæŸ¥è¯¢å’Œé«˜è´¨é‡ç¤¾åŒºæŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡å›¾èšç±»è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡æ¨¡å—åº¦è®¡ç®—å’Œç¤¾åŒºæ£€æµ‹

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - å›¾èšç±»è®¡ç®—æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆæœ‰é™æ”¯æŒï¼Œå› ä¸ºé€’å½’CTEçš„å¹¶è¡ŒåŒ–é™åˆ¶ï¼‰
   - é€‚ç”¨äºç‹¬ç«‹ç¤¾åŒºæ£€æµ‹å’Œæ‰¹é‡èšç±»åˆ†æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–ç¤¾åŒºæŸ¥è¯¢**

```sql
-- ä¸ºç¤¾åŒºæ¨¡å—åº¦åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_community_modularity_skip_scan
ON communities(community_id, modularity_score DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¨¡å—åº¦æœ€é«˜çš„å‰10ä¸ªç¤¾åŒº
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    community_id,
    modularity_score,
    community_size
FROM communities
ORDER BY modularity_score DESC
LIMIT 10;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç¤¾åŒºèšç±»ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„ç¤¾åŒºèšç±»ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜ç¤¾åŒºèšç±»ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS community_clusters_cache AS
WITH community_edges AS (
    SELECT
        nc1.community_id,
        COUNT(*) AS internal_edges,
        (SELECT COUNT(*) FROM node_communities WHERE community_id = nc1.community_id) AS community_size
    FROM edges e
    JOIN node_communities nc1 ON e.source_id = nc1.node_id
    JOIN node_communities nc2 ON e.target_id = nc2.node_id
    WHERE nc1.community_id = nc2.community_id
    GROUP BY nc1.community_id
),
modularity_scores AS (
    SELECT
        community_id,
        community_size,
        internal_edges,
        (SELECT COUNT(*) FROM edges) AS total_edges,
        -- è®¡ç®—æ¨¡å—åº¦ï¼šQ = Î£(e_ii/m - (d_i/2m)^2)
        (internal_edges::numeric / NULLIF((SELECT COUNT(*) FROM edges), 0)) -
        POWER(community_size::numeric / NULLIF((SELECT COUNT(*) FROM nodes), 0), 2) AS modularity_score
    FROM community_edges
)
SELECT
    community_id,
    community_size,
    internal_edges,
    ROUND(modularity_score::numeric, 6) AS modularity_score
FROM modularity_scores
WHERE modularity_score > 0;  -- åªä¿ç•™æ­£æ¨¡å—åº¦ç¤¾åŒº

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_community_clusters_cache_modularity ON community_clusters_cache(modularity_score DESC);
CREATE INDEX idx_community_clusters_cache_size ON community_clusters_cache(community_size DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY community_clusters_cache;
```

**2. æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼šå¿«é€Ÿç¤¾åŒºæ£€æµ‹**

**æ ‡ç­¾ä¼ æ’­ç®—æ³•**ï¼šä½¿ç”¨æ ‡ç­¾ä¼ æ’­è¿›è¡Œå¿«é€Ÿç¤¾åŒºæ£€æµ‹ã€‚

```sql
-- æ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼šå¿«é€Ÿç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    max_iterations INTEGER := 10;
    current_iteration INTEGER := 0;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'node_labels') THEN
            CREATE TABLE node_labels (
                node_id INTEGER PRIMARY KEY,
                label INTEGER NOT NULL,
                iteration INTEGER DEFAULT 0
            );

            CREATE INDEX idx_node_labels_label ON node_labels(label);

            -- åˆå§‹åŒ–ï¼šæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨è‡ªå·±çš„IDä½œä¸ºæ ‡ç­¾
            INSERT INTO node_labels (node_id, label, iteration)
            SELECT id, id, 0 FROM nodes;

            RAISE NOTICE 'èŠ‚ç‚¹æ ‡ç­¾è¡¨åˆ›å»ºæˆåŠŸï¼Œå·²åˆå§‹åŒ–æ ‡ç­¾';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ ‡ç­¾ä¼ æ’­ç®—æ³•ï¼Œæœ€å¤§è¿­ä»£æ¬¡æ•°: %', max_iterations;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ ‡ç­¾ä¼ æ’­ç®—æ³•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ ‡ç­¾ä¼ æ’­ï¼šè¿­ä»£æ›´æ–°èŠ‚ç‚¹æ ‡ç­¾
WITH node_neighbor_labels AS (
    SELECT
        nl.node_id,
        e.target_id AS neighbor_id,
        nl2.label AS neighbor_label,
        COUNT(*) OVER (PARTITION BY nl.node_id, nl2.label) AS label_frequency
    FROM node_labels nl
    JOIN edges e ON nl.node_id = e.source_id
    JOIN node_labels nl2 ON e.target_id = nl2.node_id
    WHERE nl.iteration = (SELECT MAX(iteration) FROM node_labels)
),
most_frequent_labels AS (
    SELECT DISTINCT ON (node_id)
        node_id,
        neighbor_label AS new_label,
        label_frequency
    FROM node_neighbor_labels
    ORDER BY node_id, label_frequency DESC, neighbor_label ASC
)
-- æ›´æ–°èŠ‚ç‚¹æ ‡ç­¾ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦å¾ªç¯è¿­ä»£ï¼‰
SELECT
    mfl.node_id,
    mfl.new_label AS updated_label,
    nl.label AS old_label
FROM most_frequent_labels mfl
JOIN node_labels nl ON mfl.node_id = nl.node_id
WHERE mfl.new_label != nl.label;
```

**3. æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼šååŒè¿‡æ»¤ç¤¾åŒºå‘ç°**

**æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹**ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºå‘ç°æ¨èç³»ç»Ÿç¤¾åŒºã€‚

```sql
-- æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼šååŒè¿‡æ»¤ç¤¾åŒºå‘ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_interactions') THEN
            CREATE TABLE user_interactions (
                interaction_id SERIAL PRIMARY KEY,
                user_id INTEGER NOT NULL,
                item_id INTEGER NOT NULL,
                interaction_type VARCHAR(20),  -- 'view', 'like', 'purchase'
                interaction_time TIMESTAMPTZ DEFAULT NOW(),
                UNIQUE(user_id, item_id, interaction_type)
            );

            CREATE INDEX idx_user_interactions_user ON user_interactions(user_id);
            CREATE INDEX idx_user_interactions_item ON user_interactions(item_id);
            CREATE INDEX idx_user_interactions_type ON user_interactions(interaction_type);

            RAISE NOTICE 'ç”¨æˆ·äº¤äº’è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼šåŸºäºå…±åŒäº¤äº’ç‰©å“çš„ç¤¾åŒºå‘ç°
WITH user_similarity AS (
    SELECT
        ui1.user_id AS user1_id,
        ui2.user_id AS user2_id,
        COUNT(*) AS common_items,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—Jaccardç›¸ä¼¼åº¦ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        COUNT(*)::numeric / NULLIF(
            (SELECT COUNT(DISTINCT item_id) FROM user_interactions WHERE user_id = ui1.user_id) +
            (SELECT COUNT(DISTINCT item_id) FROM user_interactions WHERE user_id = ui2.user_id) - COUNT(*),
            0
        ) AS jaccard_similarity
    FROM user_interactions ui1
    JOIN user_interactions ui2 ON ui1.item_id = ui2.item_id AND ui1.user_id < ui2.user_id
    WHERE ui1.interaction_type = 'purchase' AND ui2.interaction_type = 'purchase'
    GROUP BY ui1.user_id, ui2.user_id
    HAVING COUNT(*) >= 3  -- è‡³å°‘3ä¸ªå…±åŒç‰©å“
),
similarity_graph AS (
    SELECT
        user1_id AS source_id,
        user2_id AS target_id,
        jaccard_similarity AS edge_weight
    FROM user_similarity
    WHERE jaccard_similarity > 0.3  -- ç›¸ä¼¼åº¦é˜ˆå€¼
),
community_detection AS (
    WITH RECURSIVE communities AS (
        SELECT
            user_id,
            user_id AS community_id
        FROM (SELECT DISTINCT user_id FROM user_interactions) users
        UNION
        SELECT
            sg.target_id,
            c.community_id
        FROM communities c
        JOIN similarity_graph sg ON c.user_id = sg.source_id
        WHERE sg.edge_weight > 0.5  -- é«˜ç›¸ä¼¼åº¦é˜ˆå€¼
    )
    SELECT
        community_id,
        COUNT(DISTINCT user_id) AS community_size,
        array_agg(DISTINCT user_id ORDER BY user_id) AS community_members
    FROM communities
    GROUP BY community_id
)
SELECT
    community_id,
    community_size,
    community_members[1:10] AS top_members,  -- å‰10ä¸ªæˆå‘˜
    CASE
        WHEN community_size >= 20 THEN 'Large Community'
        WHEN community_size >= 10 THEN 'Medium Community'
        ELSE 'Small Community'
    END AS community_type
FROM community_detection
WHERE community_size >= 5
ORDER BY community_size DESC
LIMIT 20;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

- ã€Šå¤æ‚ç½‘ç»œã€‹ï¼ˆComplex Networksï¼‰- ç¤¾åŒºæ£€æµ‹ç†è®º
- ã€Šå›¾è®ºã€‹ï¼ˆGraph Theoryï¼‰- å›¾èšç±»ç®—æ³•

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- [é€’å½’æŸ¥è¯¢](https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-RECURSIVE)
- [èšåˆå‡½æ•°](https://www.postgresql.org/docs/current/functions-aggregate.html)

### åœ¨çº¿èµ„æº

- PostgreSQLå›¾èšç±»ç®—æ³•å®ç°
- ç¤¾åŒºæ£€æµ‹ç®—æ³•è¯¦è§£
- å›¾åˆ†ææœ€ä½³å®è·µ

### ç›¸å…³ç®—æ³•

- [å›¾éå†ç®—æ³•](./å›¾éå†ç®—æ³•.md) - å›¾éå†
- [æœ€çŸ­è·¯å¾„ç®—æ³•](./æœ€çŸ­è·¯å¾„ç®—æ³•.md) - æœ€çŸ­è·¯å¾„æŸ¥æ‰¾
- [è¿é€šæ€§åˆ†æ](./è¿é€šæ€§åˆ†æ.md) - è¿é€šæ€§æ£€æµ‹

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
