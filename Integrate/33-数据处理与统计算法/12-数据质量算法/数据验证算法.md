# PostgreSQL æ•°æ®éªŒè¯ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ•°æ®éªŒè¯ | çº¦æŸæ£€æŸ¥
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ•°æ®éªŒè¯ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ•°æ®éªŒè¯ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ•°æ®éªŒè¯æ¦‚è¿°](#æ•°æ®éªŒè¯æ¦‚è¿°)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [æ•°æ®éªŒè¯åŸç†](#æ•°æ®éªŒè¯åŸç†)
      - [éªŒè¯è§„åˆ™ç±»å‹](#éªŒè¯è§„åˆ™ç±»å‹)
      - [éªŒè¯ç­–ç•¥](#éªŒè¯ç­–ç•¥)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. æ ¼å¼éªŒè¯](#1-æ ¼å¼éªŒè¯)
    - [1.1 æ ¼å¼éªŒè¯åŸç†](#11-æ ¼å¼éªŒè¯åŸç†)
      - [æ­£åˆ™è¡¨è¾¾å¼åŸºç¡€](#æ­£åˆ™è¡¨è¾¾å¼åŸºç¡€)
      - [PostgreSQLæ­£åˆ™è¡¨è¾¾å¼å‡½æ•°](#postgresqlæ­£åˆ™è¡¨è¾¾å¼å‡½æ•°)
    - [1.2 é‚®ç®±æ ¼å¼éªŒè¯å®ç°](#12-é‚®ç®±æ ¼å¼éªŒè¯å®ç°)
    - [1.3 ç”µè¯å·ç éªŒè¯å®ç°](#13-ç”µè¯å·ç éªŒè¯å®ç°)
    - [1.4 URLæ ¼å¼éªŒè¯](#14-urlæ ¼å¼éªŒè¯)
    - [1.5 èº«ä»½è¯å·éªŒè¯](#15-èº«ä»½è¯å·éªŒè¯)
  - [2. èŒƒå›´éªŒè¯](#2-èŒƒå›´éªŒè¯)
    - [2.1 èŒƒå›´éªŒè¯åŸç†](#21-èŒƒå›´éªŒè¯åŸç†)
      - [æ•°å€¼èŒƒå›´éªŒè¯](#æ•°å€¼èŒƒå›´éªŒè¯)
      - [æ—¥æœŸèŒƒå›´éªŒè¯](#æ—¥æœŸèŒƒå›´éªŒè¯)
      - [å­—ç¬¦ä¸²é•¿åº¦éªŒè¯](#å­—ç¬¦ä¸²é•¿åº¦éªŒè¯)
    - [2.2 æ•°å€¼èŒƒå›´éªŒè¯å®ç°](#22-æ•°å€¼èŒƒå›´éªŒè¯å®ç°)
    - [2.3 æ—¥æœŸèŒƒå›´éªŒè¯](#23-æ—¥æœŸèŒƒå›´éªŒè¯)
    - [2.4 å­—ç¬¦ä¸²é•¿åº¦éªŒè¯](#24-å­—ç¬¦ä¸²é•¿åº¦éªŒè¯)
  - [3. ä¸šåŠ¡è§„åˆ™éªŒè¯](#3-ä¸šåŠ¡è§„åˆ™éªŒè¯)
    - [3.1 ä¸šåŠ¡è§„åˆ™éªŒè¯åŸç†](#31-ä¸šåŠ¡è§„åˆ™éªŒè¯åŸç†)
      - [è·¨å­—æ®µéªŒè¯](#è·¨å­—æ®µéªŒè¯)
      - [æ¡ä»¶éªŒè¯](#æ¡ä»¶éªŒè¯)
      - [èšåˆéªŒè¯](#èšåˆéªŒè¯)
    - [3.2 è‡ªå®šä¹‰è§„åˆ™éªŒè¯å®ç°](#32-è‡ªå®šä¹‰è§„åˆ™éªŒè¯å®ç°)
    - [3.3 å¼•ç”¨å®Œæ•´æ€§éªŒè¯](#33-å¼•ç”¨å®Œæ•´æ€§éªŒè¯)
    - [3.4 å”¯ä¸€æ€§éªŒè¯](#34-å”¯ä¸€æ€§éªŒè¯)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç»¼åˆæ•°æ®éªŒè¯](#41-ç»¼åˆæ•°æ®éªŒè¯)
    - [4.2 ç”¨æˆ·æ³¨å†Œæ•°æ®éªŒè¯](#42-ç”¨æˆ·æ³¨å†Œæ•°æ®éªŒè¯)
    - [4.3 è®¢å•æ•°æ®éªŒè¯](#43-è®¢å•æ•°æ®éªŒè¯)
    - [4.4 æ•°æ®è´¨é‡ç›‘æ§](#44-æ•°æ®è´¨é‡ç›‘æ§)
    - [4.5 å®æ—¶æ•°æ®éªŒè¯](#45-å®æ—¶æ•°æ®éªŒè¯)
  - [5. PostgreSQL 18å¹¶è¡Œæ•°æ®éªŒè¯](#5-postgresql-18å¹¶è¡Œæ•°æ®éªŒè¯)
    - [5.1 å¹¶è¡Œæ•°æ®éªŒè¯æ¦‚è¿°](#51-å¹¶è¡Œæ•°æ®éªŒè¯æ¦‚è¿°)
      - [å¹¶è¡Œæ•°æ®éªŒè¯é…ç½®](#å¹¶è¡Œæ•°æ®éªŒè¯é…ç½®)
      - [å¹¶è¡Œæ•°æ®éªŒè¯å®ç°](#å¹¶è¡Œæ•°æ®éªŒè¯å®ç°)
  - [6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#6-ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)
    - [6.1 éªŒè¯æ–¹æ³•å¯¹æ¯”](#61-éªŒè¯æ–¹æ³•å¯¹æ¯”)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#63-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 éªŒè¯ç­–ç•¥](#71-éªŒè¯ç­–ç•¥)
    - [7.2 éªŒè¯è§„åˆ™è®¾è®¡](#72-éªŒè¯è§„åˆ™è®¾è®¡)
    - [7.3 é”™è¯¯å¤„ç†](#73-é”™è¯¯å¤„ç†)
    - [7.4 SQLå®ç°æ³¨æ„äº‹é¡¹](#74-sqlå®ç°æ³¨æ„äº‹é¡¹)
    - [7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰](#75-postgresql-18-æ–°ç‰¹æ€§åº”ç”¨å¢å¼º)
    - [7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰](#76-é«˜çº§ä¼˜åŒ–æŠ€å·§å¢å¼º)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
    - [å­¦æœ¯æ–‡çŒ®](#å­¦æœ¯æ–‡çŒ®)
    - [PostgreSQLå®˜æ–¹æ–‡æ¡£](#postgresqlå®˜æ–¹æ–‡æ¡£)
    - [åœ¨çº¿èµ„æº](#åœ¨çº¿èµ„æº)
    - [ç›¸å…³ç®—æ³•](#ç›¸å…³ç®—æ³•)

---

## æ•°æ®éªŒè¯æ¦‚è¿°

**æ•°æ®éªŒè¯ï¼ˆData Validationï¼‰**æ˜¯ç¡®ä¿æ•°æ®è´¨é‡çš„å…³é”®ç¯èŠ‚ï¼Œé€šè¿‡æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„å®šä¹‰çš„è§„åˆ™ã€çº¦æŸå’Œä¸šåŠ¡é€»è¾‘ï¼Œè¯†åˆ«å’Œæ ‡è®°æ— æ•ˆã€ä¸ä¸€è‡´æˆ–ä¸ç¬¦åˆè¦æ±‚çš„æ•°æ®ã€‚

### ç†è®ºåŸºç¡€

#### æ•°æ®éªŒè¯åŸç†

**æ•°æ®éªŒè¯**æ˜¯åœ¨æ•°æ®è¿›å…¥ç³»ç»Ÿæˆ–å¤„ç†ä¹‹å‰ï¼Œå¯¹æ•°æ®è¿›è¡Œæ£€æŸ¥ä»¥ç¡®ä¿å…¶æ­£ç¡®æ€§ã€å®Œæ•´æ€§å’Œä¸€è‡´æ€§çš„è¿‡ç¨‹ã€‚

**éªŒè¯ç›®æ ‡**ï¼š

1. **æ­£ç¡®æ€§**ï¼šæ•°æ®å€¼æ˜¯å¦æ­£ç¡®
2. **å®Œæ•´æ€§**ï¼šå¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
3. **ä¸€è‡´æ€§**ï¼šæ•°æ®æ˜¯å¦ç¬¦åˆä¸šåŠ¡è§„åˆ™
4. **æ ¼å¼æ€§**ï¼šæ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ
5. **æœ‰æ•ˆæ€§**ï¼šæ•°æ®æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…

#### éªŒè¯è§„åˆ™ç±»å‹

1. **æ ¼å¼éªŒè¯ï¼ˆFormat Validationï¼‰**ï¼š
   - æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ
   - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€æ¨¡å¼åŒ¹é…
   - ç¤ºä¾‹ï¼šé‚®ç®±æ ¼å¼ã€ç”µè¯å·ç æ ¼å¼ã€æ—¥æœŸæ ¼å¼

2. **èŒƒå›´éªŒè¯ï¼ˆRange Validationï¼‰**ï¼š
   - æ£€æŸ¥æ•°æ®å€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
   - æ•°å€¼èŒƒå›´ã€æ—¥æœŸèŒƒå›´ã€å­—ç¬¦ä¸²é•¿åº¦
   - ç¤ºä¾‹ï¼šå¹´é¾„åœ¨0-150ä¹‹é—´ã€åˆ†æ•°åœ¨0-100ä¹‹é—´

3. **ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆBusiness Rule Validationï¼‰**ï¼š
   - æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆä¸šåŠ¡é€»è¾‘
   - è·¨å­—æ®µéªŒè¯ã€æ¡ä»¶éªŒè¯
   - ç¤ºä¾‹ï¼šè®¢å•é‡‘é¢å¿…é¡»å¤§äº0ã€ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ

4. **å¼•ç”¨å®Œæ•´æ€§éªŒè¯ï¼ˆReferential Integrity Validationï¼‰**ï¼š
   - æ£€æŸ¥å¤–é”®å¼•ç”¨æ˜¯å¦æœ‰æ•ˆ
   - ç¡®ä¿å…³è”æ•°æ®å­˜åœ¨
   - ç¤ºä¾‹ï¼šè®¢å•å¿…é¡»å…³è”æœ‰æ•ˆçš„å®¢æˆ·

5. **å”¯ä¸€æ€§éªŒè¯ï¼ˆUniqueness Validationï¼‰**ï¼š
   - æ£€æŸ¥æ•°æ®æ˜¯å¦å”¯ä¸€
   - ä¸»é”®ã€å”¯ä¸€çº¦æŸ
   - ç¤ºä¾‹ï¼šé‚®ç®±åœ°å€å¿…é¡»å”¯ä¸€

#### éªŒè¯ç­–ç•¥

1. **å®æ—¶éªŒè¯ï¼ˆReal-time Validationï¼‰**ï¼š
   - åœ¨æ•°æ®è¾“å…¥æ—¶ç«‹å³éªŒè¯
   - æä¾›å³æ—¶åé¦ˆ
   - é€‚åˆç”¨æˆ·è¾“å…¥åœºæ™¯

2. **æ‰¹é‡éªŒè¯ï¼ˆBatch Validationï¼‰**ï¼š
   - å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ‰¹é‡éªŒè¯
   - ç”ŸæˆéªŒè¯æŠ¥å‘Š
   - é€‚åˆæ•°æ®å¯¼å…¥ã€ETLåœºæ™¯

3. **å»¶è¿ŸéªŒè¯ï¼ˆDeferred Validationï¼‰**ï¼š
   - åœ¨äº‹åŠ¡æäº¤æ—¶éªŒè¯
   - æé«˜æ€§èƒ½
   - é€‚åˆæ•°æ®åº“çº¦æŸ

### æ ¸å¿ƒç®—æ³•

| éªŒè¯ç±»å‹ | éªŒè¯æ–¹æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------|-----------|---------|
| **æ ¼å¼éªŒè¯** | æ­£åˆ™è¡¨è¾¾å¼ã€æ¨¡å¼åŒ¹é… | $O(n)$ | $O(1)$ | é‚®ç®±ã€ç”µè¯ã€URL |
| **èŒƒå›´éªŒè¯** | æ•°å€¼æ¯”è¾ƒã€åŒºé—´æ£€æŸ¥ | $O(n)$ | $O(1)$ | å¹´é¾„ã€åˆ†æ•°ã€æ—¥æœŸ |
| **è§„åˆ™éªŒè¯** | æ¡ä»¶åˆ¤æ–­ã€é€»è¾‘è¿ç®— | $O(n)$ | $O(1)$ | ä¸šåŠ¡è§„åˆ™ã€è·¨å­—æ®µéªŒè¯ |
| **å®Œæ•´æ€§éªŒè¯** | å¤–é”®æ£€æŸ¥ã€å…³è”æŸ¥è¯¢ | $O(n \log n)$ | $O(n)$ | å¼•ç”¨å®Œæ•´æ€§ |
| **å”¯ä¸€æ€§éªŒè¯** | å“ˆå¸Œè¡¨ã€ç´¢å¼•æŸ¥æ‰¾ | $O(n)$ | $O(n)$ | å”¯ä¸€çº¦æŸ |

---

## 1. æ ¼å¼éªŒè¯

### 1.1 æ ¼å¼éªŒè¯åŸç†

**æ ¼å¼éªŒè¯**æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„å®šä¹‰çš„æ ¼å¼è§„èŒƒï¼Œé€šå¸¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegular Expressionï¼‰è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚

#### æ­£åˆ™è¡¨è¾¾å¼åŸºç¡€

**æ­£åˆ™è¡¨è¾¾å¼**æ˜¯ä¸€ç§æè¿°å­—ç¬¦ä¸²æ¨¡å¼çš„è¯­æ³•ï¼Œç”¨äºåŒ¹é…ã€æŸ¥æ‰¾å’Œæ›¿æ¢æ–‡æœ¬ã€‚

**å¸¸ç”¨å…ƒå­—ç¬¦**ï¼š

- `.`ï¼šåŒ¹é…ä»»æ„å­—ç¬¦
- `*`ï¼šåŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦0æ¬¡æˆ–å¤šæ¬¡
- `+`ï¼šåŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦1æ¬¡æˆ–å¤šæ¬¡
- `?`ï¼šåŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦0æ¬¡æˆ–1æ¬¡
- `^`ï¼šåŒ¹é…å­—ç¬¦ä¸²å¼€å§‹
- `$`ï¼šåŒ¹é…å­—ç¬¦ä¸²ç»“æŸ
- `[]`ï¼šå­—ç¬¦ç±»ï¼ŒåŒ¹é…æ‹¬å·å†…çš„ä»»æ„å­—ç¬¦
- `()`ï¼šåˆ†ç»„
- `|`ï¼šæˆ–è¿ç®—ç¬¦

#### PostgreSQLæ­£åˆ™è¡¨è¾¾å¼å‡½æ•°

1. **~**ï¼šåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
2. **~***ï¼šåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
3. **!~**ï¼šä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
4. **!~***ï¼šä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
5. **regexp_match()**ï¼šè¿”å›åŒ¹é…çš„å­ä¸²
6. **regexp_replace()**ï¼šæ›¿æ¢åŒ¹é…çš„å­ä¸²

### 1.2 é‚®ç®±æ ¼å¼éªŒè¯å®ç°

```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE validation_test CASCADE;
        END IF;

        CREATE TABLE validation_test (
            id SERIAL PRIMARY KEY,
            email VARCHAR(100),
            phone VARCHAR(20),
            age INTEGER,
            score NUMERIC(5, 2)
        );

        INSERT INTO validation_test (email, phone, age, score) VALUES
            ('valid@example.com', '13800138000', 25, 85.5),
            ('invalid-email', '12345', 15, 120.0),
            ('test@domain', '13800138001', 30, 95.0),
            ('user@test.com', 'invalid-phone', 25, 75.5);

        RAISE NOTICE 'è¡¨ validation_test åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ validation_test å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- é‚®ç®±æ ¼å¼éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯é‚®ç®±æ ¼å¼';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹éªŒè¯é‚®ç®±æ ¼å¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é‚®ç®±æ ¼å¼éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯é‚®ç®±æ ¼å¼
SELECT
    id,
    email,
    CASE
        WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN 'Valid'
        ELSE 'Invalid'
    END AS email_validation_status,
    CASE
        WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN NULL
        ELSE 'Email format is invalid'
    END AS validation_error
FROM validation_test
WHERE email IS NOT NULL
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    email
FROM validation_test
WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$';
```

### 1.3 ç”µè¯å·ç éªŒè¯å®ç°

**ç”µè¯å·ç éªŒè¯**éªŒè¯ç”µè¯å·ç æ ¼å¼ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼ˆå›ºå®šç”µè¯ã€æ‰‹æœºã€å›½é™…å·ç ç­‰ï¼‰ã€‚

```sql
-- ç”µè¯å·ç éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯ç”µè¯å·ç ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹éªŒè¯ç”µè¯å·ç æ ¼å¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”µè¯å·ç éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯ä¸­å›½æ‰‹æœºå·æ ¼å¼ï¼ˆ11ä½æ•°å­—ï¼Œä»¥1å¼€å¤´ï¼‰
SELECT
    id,
    phone,
    CASE
        WHEN phone ~ '^1[3-9]\d{9}$' THEN 'Valid'
        ELSE 'Invalid'
    END AS phone_validation_status,
    CASE
        WHEN phone ~ '^1[3-9]\d{9}$' THEN NULL
        ELSE 'Phone number format is invalid (should be 11 digits starting with 1)'
    END AS validation_error
FROM validation_test
WHERE phone IS NOT NULL
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    phone
FROM validation_test
WHERE phone ~ '^1[3-9]\d{9}$';
```

---

### 1.4 URLæ ¼å¼éªŒè¯

**URLæ ¼å¼éªŒè¯**éªŒè¯URLåœ°å€æ ¼å¼ã€‚

```sql
-- URLæ ¼å¼éªŒè¯
SELECT
    id,
    url,
    CASE
        WHEN url ~* '^https?://([\da-z\.-]+)\.([a-z\.]{2,6})([/\w \.-]*)*/?$' THEN 'Valid'
        ELSE 'Invalid'
    END AS url_validation_status
FROM url_test
WHERE url IS NOT NULL;
```

### 1.5 èº«ä»½è¯å·éªŒè¯

**èº«ä»½è¯å·éªŒè¯**éªŒè¯ä¸­å›½èº«ä»½è¯å·ç æ ¼å¼å’Œæ ¡éªŒä½ã€‚

```sql
-- èº«ä»½è¯å·éªŒè¯ï¼ˆ18ä½ï¼ŒåŒ…å«æ ¡éªŒä½ï¼‰
CREATE OR REPLACE FUNCTION validate_id_card(id_card TEXT) RETURNS BOOLEAN AS $$
DECLARE
    weights INTEGER[] := ARRAY[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];
    check_codes CHAR[] := ARRAY['1','0','X','9','8','7','6','5','4','3','2'];
    sum_val INTEGER := 0;
    i INTEGER;
BEGIN
    -- æ£€æŸ¥é•¿åº¦
    IF LENGTH(id_card) != 18 THEN
        RETURN FALSE;
    END IF;

    -- æ£€æŸ¥å‰17ä½æ˜¯å¦ä¸ºæ•°å­—
    IF id_card ~ '^\d{17}' THEN
        -- è®¡ç®—æ ¡éªŒä½
        FOR i IN 1..17 LOOP
            sum_val := sum_val + (SUBSTRING(id_card, i, 1)::INTEGER * weights[i]);
        END LOOP;

        -- éªŒè¯æ ¡éªŒä½
        RETURN SUBSTRING(id_card, 18, 1) = check_codes[(sum_val % 11) + 1];
    END IF;

    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨å‡½æ•°éªŒè¯èº«ä»½è¯å·
SELECT
    id,
    id_card,
    validate_id_card(id_card) AS is_valid
FROM id_card_test;
```

## 2. èŒƒå›´éªŒè¯

### 2.1 èŒƒå›´éªŒè¯åŸç†

**èŒƒå›´éªŒè¯**æ£€æŸ¥æ•°æ®å€¼æ˜¯å¦åœ¨é¢„å®šä¹‰çš„æœ‰æ•ˆèŒƒå›´å†…ï¼ŒåŒ…æ‹¬æ•°å€¼èŒƒå›´ã€æ—¥æœŸèŒƒå›´ã€å­—ç¬¦ä¸²é•¿åº¦ç­‰ã€‚

#### æ•°å€¼èŒƒå›´éªŒè¯

**æ•°å€¼èŒƒå›´éªŒè¯**æ£€æŸ¥æ•°å€¼æ˜¯å¦åœ¨æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ï¼š
$$min\_value \leq value \leq max\_value$$

#### æ—¥æœŸèŒƒå›´éªŒè¯

**æ—¥æœŸèŒƒå›´éªŒè¯**æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ‰æ•ˆçš„æ—¶é—´èŒƒå›´å†…ï¼š
$$start\_date \leq date \leq end\_date$$

#### å­—ç¬¦ä¸²é•¿åº¦éªŒè¯

**å­—ç¬¦ä¸²é•¿åº¦éªŒè¯**æ£€æŸ¥å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼š
$$min\_length \leq LENGTH(string) \leq max\_length$$

### 2.2 æ•°å€¼èŒƒå›´éªŒè¯å®ç°

```sql
-- æ•°å€¼èŒƒå›´éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯æ•°å€¼èŒƒå›´';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹éªŒè¯æ•°å€¼èŒƒå›´';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°å€¼èŒƒå›´éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- éªŒè¯å¹´é¾„èŒƒå›´ï¼ˆ18-100ï¼‰
SELECT
    id,
    age,
    CASE
        WHEN age >= 18 AND age <= 100 THEN 'Valid'
        WHEN age < 18 THEN 'Invalid - Too young'
        WHEN age > 100 THEN 'Invalid - Too old'
        ELSE 'Invalid - NULL or out of range'
    END AS age_validation_status
FROM validation_test
ORDER BY id;

-- éªŒè¯åˆ†æ•°èŒƒå›´ï¼ˆ0-100ï¼‰
SELECT
    id,
    score,
    CASE
        WHEN score >= 0 AND score <= 100 THEN 'Valid'
        WHEN score < 0 THEN 'Invalid - Negative score'
        WHEN score > 100 THEN 'Invalid - Score exceeds maximum'
        ELSE 'Invalid - NULL'
    END AS score_validation_status
FROM validation_test
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    age
FROM validation_test
WHERE age >= 18 AND age <= 100;
```

---

### 2.3 æ—¥æœŸèŒƒå›´éªŒè¯

**æ—¥æœŸèŒƒå›´éªŒè¯**æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ã€‚

```sql
-- æ—¥æœŸèŒƒå›´éªŒè¯
SELECT
    id,
    start_date,
    end_date,
    CASE
        WHEN start_date <= end_date THEN 'Valid'
        ELSE 'Invalid - Start date must be before end date'
    END AS date_range_status,
    CASE
        WHEN start_date > CURRENT_DATE THEN 'Future start date'
        WHEN end_date < CURRENT_DATE THEN 'Past end date'
        ELSE 'Current date range'
    END AS date_status
FROM date_test
WHERE start_date IS NOT NULL AND end_date IS NOT NULL;
```

### 2.4 å­—ç¬¦ä¸²é•¿åº¦éªŒè¯

**å­—ç¬¦ä¸²é•¿åº¦éªŒè¯**æ£€æŸ¥å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ã€‚

```sql
-- å­—ç¬¦ä¸²é•¿åº¦éªŒè¯
SELECT
    id,
    name,
    LENGTH(name) AS name_length,
    CASE
        WHEN LENGTH(name) >= 2 AND LENGTH(name) <= 50 THEN 'Valid'
        WHEN LENGTH(name) < 2 THEN 'Invalid - Too short (minimum 2 characters)'
        WHEN LENGTH(name) > 50 THEN 'Invalid - Too long (maximum 50 characters)'
        ELSE 'Invalid - NULL'
    END AS length_validation_status
FROM name_test
WHERE name IS NOT NULL;
```

## 3. ä¸šåŠ¡è§„åˆ™éªŒè¯

### 3.1 ä¸šåŠ¡è§„åˆ™éªŒè¯åŸç†

**ä¸šåŠ¡è§„åˆ™éªŒè¯**æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å’Œçº¦æŸæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠå¤šä¸ªå­—æ®µä¹‹é—´çš„å…³ç³»ã€‚

#### è·¨å­—æ®µéªŒè¯

**è·¨å­—æ®µéªŒè¯**æ£€æŸ¥å¤šä¸ªå­—æ®µä¹‹é—´çš„å…³ç³»ï¼š

- è®¢å•é‡‘é¢å¿…é¡»å¤§äº0
- ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ
- æŠ˜æ‰£é‡‘é¢ä¸èƒ½è¶…è¿‡åŸä»·

#### æ¡ä»¶éªŒè¯

**æ¡ä»¶éªŒè¯**æ ¹æ®æŸä¸ªæ¡ä»¶æ£€æŸ¥å…¶ä»–å­—æ®µï¼š

- å¦‚æœè®¢å•ç±»å‹æ˜¯"é€€è´§"ï¼Œåˆ™å¿…é¡»å¡«å†™é€€è´§åŸå› 
- å¦‚æœç”¨æˆ·æ˜¯VIPï¼Œåˆ™æŠ˜æ‰£ç‡å¯ä»¥æ›´é«˜

#### èšåˆéªŒè¯

**èšåˆéªŒè¯**æ£€æŸ¥èšåˆç»“æœæ˜¯å¦ç¬¦åˆè§„åˆ™ï¼š

- è®¢å•æ€»é‡‘é¢å¿…é¡»ç­‰äºå„å•†å“é‡‘é¢ä¹‹å’Œ
- åº“å­˜æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°

### 3.2 è‡ªå®šä¹‰è§„åˆ™éªŒè¯å®ç°

```sql
-- è‡ªå®šä¹‰è§„åˆ™éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè‡ªå®šä¹‰è§„åˆ™éªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œè‡ªå®šä¹‰è§„åˆ™éªŒè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è‡ªå®šä¹‰è§„åˆ™éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆéªŒè¯ï¼šæ‰€æœ‰å­—æ®µå¿…é¡»é€šè¿‡éªŒè¯
WITH validation_results AS (
    SELECT
        id,
        email,
        phone,
        age,
        score,
        CASE
            WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN TRUE
            ELSE FALSE
        END AS email_valid,
        CASE
            WHEN phone ~ '^1[3-9]\d{9}$' THEN TRUE
            ELSE FALSE
        END AS phone_valid,
        CASE
            WHEN age >= 18 AND age <= 100 THEN TRUE
            ELSE FALSE
        END AS age_valid,
        CASE
            WHEN score >= 0 AND score <= 100 THEN TRUE
            ELSE FALSE
        END AS score_valid
    FROM validation_test
)
SELECT
    id,
    email,
    phone,
    age,
    score,
    email_valid,
    phone_valid,
    age_valid,
    score_valid,
    CASE
        WHEN email_valid AND phone_valid AND age_valid AND score_valid THEN 'All Valid'
        ELSE 'Has Invalid Fields'
    END AS overall_status,
    ARRAY_REMOVE(ARRAY[
        CASE WHEN NOT email_valid THEN 'email' END,
        CASE WHEN NOT phone_valid THEN 'phone' END,
        CASE WHEN NOT age_valid THEN 'age' END,
        CASE WHEN NOT score_valid THEN 'score' END
    ], NULL) AS invalid_fields
FROM validation_results
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_emails
FROM validation_test;
```

---

### 3.3 å¼•ç”¨å®Œæ•´æ€§éªŒè¯

**å¼•ç”¨å®Œæ•´æ€§éªŒè¯**æ£€æŸ¥å¤–é”®å¼•ç”¨æ˜¯å¦æœ‰æ•ˆã€‚

```sql
-- å¼•ç”¨å®Œæ•´æ€§éªŒè¯ï¼šæ£€æŸ¥è®¢å•æ˜¯å¦å…³è”æœ‰æ•ˆçš„å®¢æˆ·
SELECT
    o.order_id,
    o.customer_id,
    CASE
        WHEN c.customer_id IS NOT NULL THEN 'Valid'
        ELSE 'Invalid - Customer does not exist'
    END AS referential_integrity_status
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
WHERE o.customer_id IS NOT NULL;
```

### 3.4 å”¯ä¸€æ€§éªŒè¯

**å”¯ä¸€æ€§éªŒè¯**æ£€æŸ¥æ•°æ®æ˜¯å¦å”¯ä¸€ã€‚

```sql
-- å”¯ä¸€æ€§éªŒè¯ï¼šæ£€æŸ¥é‚®ç®±æ˜¯å¦é‡å¤
WITH email_counts AS (
    SELECT
        email,
        COUNT(*) AS email_count
    FROM users
    WHERE email IS NOT NULL
    GROUP BY email
)
SELECT
    u.user_id,
    u.email,
    CASE
        WHEN ec.email_count = 1 THEN 'Unique'
        ELSE 'Duplicate'
    END AS uniqueness_status
FROM users u
LEFT JOIN email_counts ec ON u.email = ec.email
WHERE u.email IS NOT NULL;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç»¼åˆæ•°æ®éªŒè¯

**ç»¼åˆæ•°æ®éªŒè¯**æ•´åˆå¤šç§éªŒè¯æ–¹æ³•ï¼Œç”Ÿæˆå®Œæ•´çš„éªŒè¯æŠ¥å‘Šã€‚

```sql
-- ç»¼åˆæ•°æ®éªŒè¯ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç»¼åˆæ•°æ®éªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç»¼åˆæ•°æ®éªŒè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆæ•°æ®éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿæˆæ•°æ®éªŒè¯æŠ¥å‘Š
WITH validation_summary AS (
    SELECT
        COUNT(*) AS total_records,
        COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_emails,
        COUNT(*) FILTER (WHERE phone ~ '^1[3-9]\d{9}$') AS valid_phones,
        COUNT(*) FILTER (WHERE age >= 18 AND age <= 100) AS valid_ages,
        COUNT(*) FILTER (WHERE score >= 0 AND score <= 100) AS valid_scores,
        COUNT(*) FILTER (WHERE
            email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'
            AND phone ~ '^1[3-9]\d{9}$'
            AND age >= 18 AND age <= 100
            AND score >= 0 AND score <= 100
        ) AS fully_valid_records
    FROM validation_test
)
SELECT
    total_records,
    valid_emails,
    ROUND((valid_emails::numeric / total_records * 100)::numeric, 2) AS email_validity_pct,
    valid_phones,
    ROUND((valid_phones::numeric / total_records * 100)::numeric, 2) AS phone_validity_pct,
    valid_ages,
    ROUND((valid_ages::numeric / total_records * 100)::numeric, 2) AS age_validity_pct,
    valid_scores,
    ROUND((valid_scores::numeric / total_records * 100)::numeric, 2) AS score_validity_pct,
    fully_valid_records,
    ROUND((fully_valid_records::numeric / total_records * 100)::numeric, 2) AS overall_validity_pct,
    CASE
        WHEN fully_valid_records::numeric / total_records >= 0.95 THEN 'Excellent'
        WHEN fully_valid_records::numeric / total_records >= 0.80 THEN 'Good'
        WHEN fully_valid_records::numeric / total_records >= 0.60 THEN 'Fair'
        ELSE 'Poor'
    END AS data_quality_rating
FROM validation_summary;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_count
FROM validation_test;
```

---

### 4.2 ç”¨æˆ·æ³¨å†Œæ•°æ®éªŒè¯

**åœºæ™¯**ï¼šéªŒè¯ç”¨æˆ·æ³¨å†Œæ—¶çš„æ•°æ®è´¨é‡ã€‚

```sql
-- ç”¨æˆ·æ³¨å†Œæ•°æ®éªŒè¯ï¼šç»¼åˆéªŒè¯æ‰€æœ‰å­—æ®µ
WITH user_validation AS (
    SELECT
        user_id,
        username,
        email,
        phone,
        birth_date,
        -- æ ¼å¼éªŒè¯
        CASE WHEN username ~ '^[a-zA-Z0-9_]{3,20}$' THEN TRUE ELSE FALSE END AS username_valid,
        CASE WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN TRUE ELSE FALSE END AS email_valid,
        CASE WHEN phone ~ '^1[3-9]\d{9}$' THEN TRUE ELSE FALSE END AS phone_valid,
        -- èŒƒå›´éªŒè¯
        CASE WHEN birth_date >= '1900-01-01' AND birth_date <= CURRENT_DATE THEN TRUE ELSE FALSE END AS birth_date_valid,
        -- ä¸šåŠ¡è§„åˆ™éªŒè¯
        CASE WHEN LENGTH(username) >= 3 AND LENGTH(username) <= 20 THEN TRUE ELSE FALSE END AS username_length_valid
    FROM user_registration
)
SELECT
    user_id,
    username,
    email,
    phone,
    birth_date,
    username_valid,
    email_valid,
    phone_valid,
    birth_date_valid,
    username_length_valid,
    CASE
        WHEN username_valid AND email_valid AND phone_valid AND birth_date_valid AND username_length_valid THEN 'All Valid'
        ELSE 'Has Invalid Fields'
    END AS overall_status,
    ARRAY_REMOVE(ARRAY[
        CASE WHEN NOT username_valid THEN 'username' END,
        CASE WHEN NOT email_valid THEN 'email' END,
        CASE WHEN NOT phone_valid THEN 'phone' END,
        CASE WHEN NOT birth_date_valid THEN 'birth_date' END,
        CASE WHEN NOT username_length_valid THEN 'username_length' END
    ], NULL) AS invalid_fields
FROM user_validation
ORDER BY user_id;
```

### 4.3 è®¢å•æ•°æ®éªŒè¯

**åœºæ™¯**ï¼šéªŒè¯è®¢å•æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚

```sql
-- è®¢å•æ•°æ®éªŒè¯ï¼šéªŒè¯è®¢å•ä¸šåŠ¡è§„åˆ™
WITH order_validation AS (
    SELECT
        o.order_id,
        o.customer_id,
        o.order_date,
        o.total_amount,
        o.discount_amount,
        oi.item_count,
        oi.items_total,
        -- ä¸šåŠ¡è§„åˆ™éªŒè¯
        CASE WHEN o.total_amount > 0 THEN TRUE ELSE FALSE END AS amount_valid,
        CASE WHEN o.discount_amount <= o.total_amount THEN TRUE ELSE FALSE END AS discount_valid,
        CASE WHEN o.total_amount = oi.items_total THEN TRUE ELSE FALSE END AS amount_match_valid,
        CASE WHEN c.customer_id IS NOT NULL THEN TRUE ELSE FALSE END AS customer_valid,
        CASE WHEN o.order_date <= CURRENT_DATE THEN TRUE ELSE FALSE END AS date_valid
    FROM orders o
    LEFT JOIN customers c ON o.customer_id = c.customer_id
    LEFT JOIN (
        SELECT
            order_id,
            COUNT(*) AS item_count,
            SUM(quantity * price) AS items_total
        FROM order_items
        GROUP BY order_id
    ) oi ON o.order_id = oi.order_id
)
SELECT
    order_id,
    customer_id,
    order_date,
    total_amount,
    discount_amount,
    amount_valid,
    discount_valid,
    amount_match_valid,
    customer_valid,
    date_valid,
    CASE
        WHEN amount_valid AND discount_valid AND amount_match_valid AND customer_valid AND date_valid THEN 'Valid'
        ELSE 'Invalid'
    END AS validation_status
FROM order_validation
ORDER BY order_id;
```

### 4.4 æ•°æ®è´¨é‡ç›‘æ§

**åœºæ™¯**ï¼šæŒç»­ç›‘æ§æ•°æ®è´¨é‡ï¼Œç”Ÿæˆè´¨é‡æŠ¥å‘Šã€‚

```sql
-- æ•°æ®è´¨é‡ç›‘æ§ï¼šç”Ÿæˆè´¨é‡æŠ¥å‘Š
WITH quality_metrics AS (
    SELECT
        'users' AS table_name,
        COUNT(*) AS total_records,
        COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_emails,
        COUNT(*) FILTER (WHERE phone ~ '^1[3-9]\d{9}$') AS valid_phones,
        COUNT(*) FILTER (WHERE created_at <= CURRENT_DATE) AS valid_dates,
        COUNT(DISTINCT email) AS unique_emails
    FROM users
    UNION ALL
    SELECT
        'orders' AS table_name,
        COUNT(*) AS total_records,
        COUNT(*) FILTER (WHERE total_amount > 0) AS valid_amounts,
        COUNT(*) FILTER (WHERE order_date <= CURRENT_DATE) AS valid_dates,
        COUNT(*) FILTER (WHERE customer_id IS NOT NULL) AS valid_customers,
        NULL::BIGINT AS unique_emails
    FROM orders
)
SELECT
    table_name,
    total_records,
    valid_emails,
    ROUND((valid_emails::numeric / NULLIF(total_records, 0) * 100)::numeric, 2) AS email_quality_pct,
    valid_phones,
    ROUND((valid_phones::numeric / NULLIF(total_records, 0) * 100)::numeric, 2) AS phone_quality_pct,
    valid_dates,
    ROUND((valid_dates::numeric / NULLIF(total_records, 0) * 100)::numeric, 2) AS date_quality_pct,
    CASE
        WHEN (valid_emails::numeric / NULLIF(total_records, 0) >= 0.95
              AND valid_phones::numeric / NULLIF(total_records, 0) >= 0.95) THEN 'Excellent'
        WHEN (valid_emails::numeric / NULLIF(total_records, 0) >= 0.80
              AND valid_phones::numeric / NULLIF(total_records, 0) >= 0.80) THEN 'Good'
        ELSE 'Needs Improvement'
    END AS quality_rating
FROM quality_metrics;
```

### 4.5 å®æ—¶æ•°æ®éªŒè¯

**åœºæ™¯**ï¼šåœ¨æ•°æ®æ’å…¥æ—¶è¿›è¡Œå®æ—¶éªŒè¯ã€‚

```sql
-- å®æ—¶æ•°æ®éªŒè¯ï¼šä½¿ç”¨è§¦å‘å™¨è¿›è¡ŒéªŒè¯
CREATE OR REPLACE FUNCTION validate_user_data() RETURNS TRIGGER AS $$
BEGIN
    -- éªŒè¯é‚®ç®±æ ¼å¼
    IF NEW.email IS NOT NULL AND
       NEW.email !~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN
        RAISE EXCEPTION 'Invalid email format: %', NEW.email;
    END IF;

    -- éªŒè¯ç”µè¯å·ç æ ¼å¼
    IF NEW.phone IS NOT NULL AND
       NEW.phone !~ '^1[3-9]\d{9}$' THEN
        RAISE EXCEPTION 'Invalid phone format: %', NEW.phone;
    END IF;

    -- éªŒè¯ç”¨æˆ·åé•¿åº¦
    IF LENGTH(NEW.username) < 3 OR LENGTH(NEW.username) > 20 THEN
        RAISE EXCEPTION 'Username length must be between 3 and 20 characters';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER user_validation_trigger
BEFORE INSERT OR UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION validate_user_data();
```

---

## 5. PostgreSQL 18å¹¶è¡Œæ•°æ®éªŒè¯

### 5.1 å¹¶è¡Œæ•°æ®éªŒè¯æ¦‚è¿°

**PostgreSQL 18å¹¶è¡Œæ•°æ®éªŒè¯**ï¼šåˆ©ç”¨PostgreSQL 18çš„å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ›ï¼Œæ˜¾è‘—æå‡å¤§è§„æ¨¡æ•°æ®éªŒè¯çš„æ€§èƒ½ã€‚

#### å¹¶è¡Œæ•°æ®éªŒè¯é…ç½®

```sql
-- é…ç½®å¹¶è¡Œæ•°æ®éªŒè¯å‚æ•°ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾ç½®å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
        SET max_parallel_workers_per_gather = 4;

        -- è®¾ç½®å¹¶è¡Œè¡¨æ‰«æé˜ˆå€¼
        SET min_parallel_table_scan_size = '8MB';

        -- è®¾ç½®å¹¶è¡Œèšåˆæˆæœ¬é˜ˆå€¼
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¹¶è¡Œæ•°æ®éªŒè¯å‚æ•°å·²é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ•°æ®éªŒè¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### å¹¶è¡Œæ•°æ®éªŒè¯å®ç°

```sql
-- å¹¶è¡Œæ•°æ®éªŒè¯ï¼šå¤§è§„æ¨¡æ•°æ®æ ¼å¼éªŒè¯ï¼ˆPostgreSQL 18+ï¼‰
DO $$
BEGIN
    BEGIN
        -- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
        SET max_parallel_workers_per_gather = 4;
        SET parallel_setup_cost = 0;
        SET parallel_tuple_cost = 0.0001;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¹¶è¡Œæ•°æ®éªŒè¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶è¡Œæ•°æ®éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¹¶è¡Œæ ¼å¼éªŒè¯
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH parallel_validation AS (
    SELECT
        id,
        email,
        phone,
        CASE
            WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN TRUE
            ELSE FALSE
        END AS is_valid_email,
        CASE
            WHEN phone ~ '^1[3-9]\d{9}$' THEN TRUE
            ELSE FALSE
        END AS is_valid_phone
    FROM users
)
SELECT
    COUNT(*) AS total_records,
    COUNT(*) FILTER (WHERE is_valid_email) AS valid_emails,
    COUNT(*) FILTER (WHERE is_valid_phone) AS valid_phones,
    COUNT(*) FILTER (WHERE is_valid_email AND is_valid_phone) AS fully_valid,
    ROUND((COUNT(*) FILTER (WHERE is_valid_email)::numeric / COUNT(*) * 100)::numeric, 2) AS email_validity_pct,
    ROUND((COUNT(*) FILTER (WHERE is_valid_phone)::numeric / COUNT(*) * 100)::numeric, 2) AS phone_validity_pct
FROM parallel_validation;
```

---

## 6. ç®—æ³•æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 6.1 éªŒè¯æ–¹æ³•å¯¹æ¯”

| éªŒè¯æ–¹æ³• | æ€§èƒ½ | å‡†ç¡®æ€§ | é€‚ç”¨åœºæ™¯ | å®ç°å¤æ‚åº¦ |
|---------|------|--------|---------|-----------|
| **æ­£åˆ™è¡¨è¾¾å¼** | ä¸­ | é«˜ | æ ¼å¼éªŒè¯ | ä¸­ |
| **æ•°å€¼æ¯”è¾ƒ** | å¿« | é«˜ | èŒƒå›´éªŒè¯ | ä½ |
| **å¤–é”®æ£€æŸ¥** | æ…¢ | é«˜ | å¼•ç”¨å®Œæ•´æ€§ | ä¸­ |
| **å”¯ä¸€æ€§æ£€æŸ¥** | ä¸­ | é«˜ | å”¯ä¸€æ€§éªŒè¯ | ä¸­ |
| **è§¦å‘å™¨éªŒè¯** | ä¸­ | é«˜ | å®æ—¶éªŒè¯ | é«˜ |

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åœ¨éªŒè¯å­—æ®µä¸Šåˆ›å»ºç´¢å¼•
   - ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
   - ä¸ºå¤–é”®åˆ›å»ºç´¢å¼•

2. **çº¦æŸä½¿ç”¨**ï¼š
   - ä½¿ç”¨CHECKçº¦æŸè¿›è¡Œç®€å•éªŒè¯
   - ä½¿ç”¨UNIQUEçº¦æŸç¡®ä¿å”¯ä¸€æ€§
   - ä½¿ç”¨FOREIGN KEYç¡®ä¿å¼•ç”¨å®Œæ•´æ€§

3. **å‡½æ•°ä¼˜åŒ–**ï¼š
   - åˆ›å»ºéªŒè¯å‡½æ•°æé«˜å¤ç”¨æ€§
   - ä½¿ç”¨IMMUTABLEå‡½æ•°ä¼˜åŒ–æ€§èƒ½
   - é¿å…åœ¨å‡½æ•°ä¸­è¿›è¡Œå¤æ‚è®¡ç®—

4. **æ‰¹é‡éªŒè¯**ï¼š
   - ä½¿ç”¨æ‰¹é‡éªŒè¯å‡å°‘æ•°æ®åº“è®¿é—®
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜éªŒè¯ç»“æœ
   - å¹¶è¡Œå¤„ç†å¤§é‡æ•°æ®

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜1**ï¼šæ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½æ…¢

- **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼ã€ä½¿ç”¨ç´¢å¼•ã€è€ƒè™‘ä½¿ç”¨CHECKçº¦æŸ

**é—®é¢˜2**ï¼šéªŒè¯è§„åˆ™å¤æ‚

- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºéªŒè¯å‡½æ•°ã€ä½¿ç”¨è§¦å‘å™¨ã€æ¨¡å—åŒ–è®¾è®¡

**é—®é¢˜3**ï¼šå®æ—¶éªŒè¯å½±å“æ€§èƒ½

- **è§£å†³æ–¹æ¡ˆ**ï¼šå¼‚æ­¥éªŒè¯ã€æ‰¹é‡éªŒè¯ã€ä½¿ç”¨ç‰©åŒ–è§†å›¾

**é—®é¢˜4**ï¼šéªŒè¯é”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°

- **è§£å†³æ–¹æ¡ˆ**ï¼šæä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€ä½¿ç”¨é”™è¯¯ç ã€è®°å½•éªŒè¯æ—¥å¿—

---

## 7. æœ€ä½³å®è·µ

### 7.1 éªŒè¯ç­–ç•¥

1. **å¤šå±‚éªŒè¯**ï¼š
   - å‰ç«¯éªŒè¯ï¼šç”¨æˆ·è¾“å…¥æ—¶éªŒè¯
   - åº”ç”¨å±‚éªŒè¯ï¼šä¸šåŠ¡é€»è¾‘éªŒè¯
   - æ•°æ®åº“å±‚éªŒè¯ï¼šçº¦æŸå’Œè§¦å‘å™¨éªŒè¯

2. **éªŒè¯æ—¶æœº**ï¼š
   - å®æ—¶éªŒè¯ï¼šæ•°æ®è¾“å…¥æ—¶
   - æ‰¹é‡éªŒè¯ï¼šæ•°æ®å¯¼å…¥æ—¶
   - å®šæœŸéªŒè¯ï¼šæ•°æ®ç»´æŠ¤æ—¶

3. **éªŒè¯ç²’åº¦**ï¼š
   - å­—æ®µçº§éªŒè¯ï¼šå•ä¸ªå­—æ®µ
   - è®°å½•çº§éªŒè¯ï¼šæ•´æ¡è®°å½•
   - è¡¨çº§éªŒè¯ï¼šæ•´ä¸ªè¡¨

### 7.2 éªŒè¯è§„åˆ™è®¾è®¡

1. **è§„åˆ™æ˜ç¡®**ï¼š
   - å®šä¹‰æ¸…æ™°çš„éªŒè¯è§„åˆ™
   - æ–‡æ¡£åŒ–æ‰€æœ‰è§„åˆ™
   - æä¾›ç¤ºä¾‹å’Œåä¾‹

2. **è§„åˆ™å¯ç»´æŠ¤**ï¼š
   - é›†ä¸­ç®¡ç†éªŒè¯è§„åˆ™
   - ä½¿ç”¨é…ç½®è¡¨å­˜å‚¨è§„åˆ™
   - æ”¯æŒè§„åˆ™åŠ¨æ€æ›´æ–°

3. **è§„åˆ™å¯æ‰©å±•**ï¼š
   - æ”¯æŒè‡ªå®šä¹‰è§„åˆ™
   - æ”¯æŒè§„åˆ™ç»„åˆ
   - æ”¯æŒè§„åˆ™ä¼˜å…ˆçº§

### 7.3 é”™è¯¯å¤„ç†

1. **é”™è¯¯ä¿¡æ¯**ï¼š
   - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
   - æŒ‡å‡ºå…·ä½“çš„éªŒè¯å¤±è´¥åŸå› 
   - æä¾›ä¿®å¤å»ºè®®

2. **é”™è¯¯è®°å½•**ï¼š
   - è®°å½•æ‰€æœ‰éªŒè¯é”™è¯¯
   - ç”ŸæˆéªŒè¯æŠ¥å‘Š
   - è·Ÿè¸ªé”™è¯¯è¶‹åŠ¿

3. **é”™è¯¯æ¢å¤**ï¼š
   - æ”¯æŒæ•°æ®ä¿®å¤
   - æä¾›ä¿®å¤å·¥å…·
   - éªŒè¯ä¿®å¤ç»“æœ

### 7.4 SQLå®ç°æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼š
   - ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼
   - ä½¿ç”¨ç´¢å¼•åŠ é€ŸéªŒè¯
   - é¿å…å…¨è¡¨æ‰«æ

2. **å¯ç»´æŠ¤æ€§**ï¼š
   - ä½¿ç”¨å‡½æ•°å°è£…éªŒè¯é€»è¾‘
   - æ¸…æ™°çš„ä»£ç æ³¨é‡Š
   - æ¨¡å—åŒ–è®¾è®¡

3. **é”™è¯¯å¤„ç†**ï¼š
   - ä½¿ç”¨å¼‚å¸¸å¤„ç†
   - æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
   - è®°å½•éªŒè¯æ—¥å¿—

### 7.5 PostgreSQL 18 æ–°ç‰¹æ€§åº”ç”¨ï¼ˆå¢å¼ºï¼‰

**PostgreSQL 18**å¼•å…¥äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ•°æ®éªŒè¯ç®—æ³•çš„æ€§èƒ½ï¼š

1. **Skip Scanä¼˜åŒ–**ï¼š
   - å¯¹äºåŒ…å«éªŒè¯é”®çš„ç´¢å¼•ï¼ŒSkip Scanå¯ä»¥è·³è¿‡ä¸å¿…è¦çš„ç´¢å¼•æ‰«æ
   - ç‰¹åˆ«é€‚ç”¨äºTop-NéªŒè¯æŸ¥è¯¢å’Œå¤šè§„åˆ™éªŒè¯å¯¹æ¯”æŸ¥è¯¢

2. **å¼‚æ­¥I/Oå¢å¼º**ï¼š
   - å¯¹äºå¤§è§„æ¨¡æ•°æ®éªŒè¯è®¡ç®—ï¼Œå¼‚æ­¥I/Oå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
   - é€‚ç”¨äºæ‰¹é‡éªŒè¯å’Œå¤šæ–¹æ³•éªŒè¯å¯¹æ¯”

3. **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š
   - æ•°æ®éªŒè¯æ”¯æŒæ›´å¥½çš„å¹¶è¡Œæ‰§è¡Œï¼ˆå·²åœ¨5èŠ‚è¯¦ç»†è¯´æ˜ï¼‰
   - é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®éªŒè¯å’Œå¤šè§„åˆ™å¹¶è¡ŒéªŒè¯åˆ†æ

**ç¤ºä¾‹ï¼šä½¿ç”¨Skip Scanä¼˜åŒ–æ•°æ®éªŒè¯æŸ¥è¯¢**

```sql
-- ä¸ºæ•°æ®éªŒè¯åˆ›å»ºSkip Scanä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_data_validation_skip_scan
ON validation_test(id, email, phone DESC);

-- Skip Scanä¼˜åŒ–æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªé‚®ç®±çš„æœ€æ–°éªŒè¯çŠ¶æ€
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT DISTINCT ON (email)
    id,
    email,
    phone,
    age,
    score,
    CASE
        WHEN email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$' THEN 'Valid Email'
        ELSE 'Invalid Email'
    END AS email_validation,
    CASE
        WHEN age BETWEEN 0 AND 150 THEN 'Valid Age'
        ELSE 'Invalid Age'
    END AS age_validation
FROM validation_test
ORDER BY email, id DESC
LIMIT 50;
```

### 7.6 é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼ˆå¢å¼ºï¼‰

**1. ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜éªŒè¯ç»“æœ**

å¯¹äºé¢‘ç¹ä½¿ç”¨çš„éªŒè¯ç»“æœï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜éªŒè¯ç»“æœ
CREATE MATERIALIZED VIEW IF NOT EXISTS data_validation_cache AS
WITH validation_statistics AS (
    SELECT
        id,
        email,
        phone,
        age,
        score,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—æ ¼å¼éªŒè¯ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$' THEN true
            ELSE false
        END AS email_format_valid,
        CASE
            WHEN phone ~ '^1[3-9]\d{9}$' THEN true
            ELSE false
        END AS phone_format_valid,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—èŒƒå›´éªŒè¯ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN age BETWEEN 0 AND 150 THEN true
            ELSE false
        END AS age_range_valid,
        CASE
            WHEN score BETWEEN 0 AND 100 THEN true
            ELSE false
        END AS score_range_valid,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—ç»¼åˆéªŒè¯å¾—åˆ†ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$' THEN 1 ELSE 0 END +
        CASE WHEN phone ~ '^1[3-9]\d{9}$' THEN 1 ELSE 0 END +
        CASE WHEN age BETWEEN 0 AND 150 THEN 1 ELSE 0 END +
        CASE WHEN score BETWEEN 0 AND 100 THEN 1 ELSE 0 END AS validation_score
    FROM validation_test
)
SELECT
    id,
    email,
    phone,
    age,
    score,
    email_format_valid,
    phone_format_valid,
    age_range_valid,
    score_range_valid,
    validation_score,
    CASE
        WHEN validation_score = 4 THEN 'Fully Valid'
        WHEN validation_score >= 3 THEN 'Mostly Valid'
        WHEN validation_score >= 2 THEN 'Partially Valid'
        ELSE 'Invalid'
    END AS validation_status
FROM validation_statistics
ORDER BY validation_score DESC, id DESC;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿç‰©åŒ–è§†å›¾æŸ¥è¯¢
CREATE INDEX idx_data_validation_cache_id ON data_validation_cache(id DESC);
CREATE INDEX idx_data_validation_cache_status ON data_validation_cache(validation_status, validation_score DESC);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY data_validation_cache;
```

**2. å®æ—¶æ•°æ®éªŒè¯ï¼šå¢é‡éªŒè¯æ›´æ–°**

**å®æ—¶æ•°æ®éªŒè¯**ï¼šå¯¹äºå®æ—¶æ•°æ®ï¼Œä½¿ç”¨å¢é‡æ–¹æ³•æ›´æ–°éªŒè¯ç»“æœã€‚

```sql
-- å®æ—¶æ•°æ®éªŒè¯ï¼šå¢é‡éªŒè¯æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_validation_state') THEN
            CREATE TABLE data_validation_state (
                table_name VARCHAR(100) NOT NULL,
                validation_rule VARCHAR(100) NOT NULL,  -- 'email_format', 'phone_format', 'age_range', 'score_range'
                total_rows BIGINT DEFAULT 0,
                valid_rows BIGINT DEFAULT 0,
                invalid_rows BIGINT DEFAULT 0,
                validation_rate NUMERIC,
                last_updated TIMESTAMPTZ DEFAULT NOW(),
                PRIMARY KEY (table_name, validation_rule)
            );

            CREATE INDEX idx_data_validation_state_table ON data_validation_state(table_name, last_updated DESC);
            CREATE INDEX idx_data_validation_state_updated ON data_validation_state(last_updated DESC);

            RAISE NOTICE 'æ•°æ®éªŒè¯çŠ¶æ€è¡¨åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¢é‡æ•°æ®éªŒè¯æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¢é‡æ•°æ®éªŒè¯æ›´æ–°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¢é‡æ›´æ–°æ•°æ®éªŒè¯ç»Ÿè®¡ï¼šå®æ—¶æ•°æ®éªŒè¯
WITH new_validation_data AS (
    SELECT
        'validation_test' AS table_name,
        'email_format' AS validation_rule,
        COUNT(*) AS new_total_rows,
        COUNT(*) FILTER (
            WHERE email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
        ) AS new_valid_rows
    FROM validation_test
    WHERE id > (SELECT COALESCE(MAX(last_updated)::integer, 0) FROM data_validation_state
                WHERE table_name = 'validation_test' AND validation_rule = 'email_format')
    GROUP BY 'validation_test', 'email_format'
),
updated_validation_stats AS (
    SELECT
        COALESCE(dvs.table_name, nvd.table_name) AS table_name,
        COALESCE(dvs.validation_rule, nvd.validation_rule) AS validation_rule,
        COALESCE(dvs.total_rows, 0) + COALESCE(nvd.new_total_rows, 0) AS new_total_rows,
        COALESCE(dvs.valid_rows, 0) + COALESCE(nvd.new_valid_rows, 0) AS new_valid_rows,
        (COALESCE(dvs.total_rows, 0) + COALESCE(nvd.new_total_rows, 0)) -
        (COALESCE(dvs.valid_rows, 0) + COALESCE(nvd.new_valid_rows, 0)) AS new_invalid_rows,
        (COALESCE(dvs.valid_rows, 0) + COALESCE(nvd.new_valid_rows, 0))::numeric /
        NULLIF(COALESCE(dvs.total_rows, 0) + COALESCE(nvd.new_total_rows, 0), 0) AS new_validation_rate
    FROM data_validation_state dvs
    FULL OUTER JOIN new_validation_data nvd ON dvs.table_name = nvd.table_name
                                              AND dvs.validation_rule = nvd.validation_rule
)
-- æ›´æ–°æˆ–æ’å…¥æ•°æ®éªŒè¯çŠ¶æ€
INSERT INTO data_validation_state (
    table_name,
    validation_rule,
    total_rows,
    valid_rows,
    invalid_rows,
    validation_rate,
    last_updated
)
SELECT
    table_name,
    validation_rule,
    new_total_rows,
    new_valid_rows,
    new_invalid_rows,
    new_validation_rate,
    NOW()
FROM updated_validation_stats
ON CONFLICT (table_name, validation_rule)
DO UPDATE SET
    total_rows = EXCLUDED.total_rows,
    valid_rows = EXCLUDED.valid_rows,
    invalid_rows = EXCLUDED.invalid_rows,
    validation_rate = EXCLUDED.validation_rate,
    last_updated = NOW();
```

**3. æ™ºèƒ½æ•°æ®éªŒè¯ï¼šè‡ªé€‚åº”éªŒè¯ç­–ç•¥é€‰æ‹©**

**æ™ºèƒ½æ•°æ®éªŒè¯**ï¼šæ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜éªŒè¯ç­–ç•¥ã€‚

```sql
-- æ™ºèƒ½æ•°æ®éªŒè¯ï¼šè‡ªé€‚åº”éªŒè¯ç­–ç•¥é€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    data_quality_rate NUMERIC;
    validation_complexity NUMERIC;
    recommended_strategy VARCHAR(50);
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING 'è¡¨ validation_test ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ™ºèƒ½æ•°æ®éªŒè¯';
            RETURN;
        END IF;

        -- è®¡ç®—æ•°æ®ç‰¹å¾
        WITH validation_features AS (
            SELECT
                COUNT(*) AS total_count,
                COUNT(*) FILTER (
                    WHERE email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
                      AND phone ~ '^1[3-9]\d{9}$'
                      AND age BETWEEN 0 AND 150
                      AND score BETWEEN 0 AND 100
                ) AS valid_count,
                COUNT(*) FILTER (
                    WHERE email IS NOT NULL OR phone IS NOT NULL OR age IS NOT NULL OR score IS NOT NULL
                ) AS non_null_count
            FROM validation_test
        )
        SELECT
            valid_count::numeric / NULLIF(total_count, 0),
            non_null_count::numeric / NULLIF(total_count, 0)
        INTO data_quality_rate, validation_complexity
        FROM validation_features;

        -- æ ¹æ®æ•°æ®ç‰¹å¾è‡ªé€‚åº”é€‰æ‹©éªŒè¯ç­–ç•¥
        IF data_quality_rate > 0.9 AND validation_complexity > 0.95 THEN
            recommended_strategy := 'SAMPLING_VALIDATION';  -- é«˜è´¨é‡ä½å¤æ‚åº¦ï¼šé‡‡æ ·éªŒè¯
        ELSIF data_quality_rate < 0.7 OR validation_complexity < 0.8 THEN
            recommended_strategy := 'FULL_VALIDATION';  -- ä½è´¨é‡é«˜å¤æ‚åº¦ï¼šå…¨é‡éªŒè¯
        ELSE
            recommended_strategy := 'INCREMENTAL_VALIDATION';  -- ä¸­ç­‰è´¨é‡ï¼šå¢é‡éªŒè¯
        END IF;

        RAISE NOTICE 'æ•°æ®è´¨é‡ç‡: %, éªŒè¯å¤æ‚åº¦: %, æ¨èç­–ç•¥: %',
            data_quality_rate, validation_complexity, recommended_strategy;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ™ºèƒ½æ•°æ®éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ™ºèƒ½æ•°æ®éªŒè¯ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸åŒçš„éªŒè¯æ–¹å¼
WITH validation_characteristics AS (
    SELECT
        COUNT(*) AS total_count,
        COUNT(*) FILTER (
            WHERE email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
              AND phone ~ '^1[3-9]\d{9}$'
              AND age BETWEEN 0 AND 150
              AND score BETWEEN 0 AND 100
        ) AS valid_count,
        COUNT(*) FILTER (
            WHERE email IS NOT NULL OR phone IS NOT NULL OR age IS NOT NULL OR score IS NOT NULL
        ) AS non_null_count
    FROM validation_test
),
adaptive_validation_strategy AS (
    SELECT
        total_count,
        valid_count,
        non_null_count,
        valid_count::numeric / NULLIF(total_count, 0) AS data_quality_rate,
        non_null_count::numeric / NULLIF(total_count, 0) AS validation_complexity,
        CASE
            WHEN valid_count::numeric / NULLIF(total_count, 0) > 0.9
                 AND non_null_count::numeric / NULLIF(total_count, 0) > 0.95 THEN 'SAMPLING_VALIDATION'
            WHEN valid_count::numeric / NULLIF(total_count, 0) < 0.7
                 OR non_null_count::numeric / NULLIF(total_count, 0) < 0.8 THEN 'FULL_VALIDATION'
            ELSE 'INCREMENTAL_VALIDATION'
        END AS recommended_strategy,
        -- ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—éªŒè¯æ•ˆç‡ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        CASE
            WHEN valid_count::numeric / NULLIF(total_count, 0) > 0.9
                 AND non_null_count::numeric / NULLIF(total_count, 0) > 0.95 THEN
                GREATEST(100, total_count / 10)  -- é‡‡æ ·éªŒè¯ï¼š10%
            WHEN valid_count::numeric / NULLIF(total_count, 0) < 0.7
                 OR non_null_count::numeric / NULLIF(total_count, 0) < 0.8 THEN
                total_count  -- å…¨é‡éªŒè¯ï¼š100%
            ELSE
                total_count / 2  -- å¢é‡éªŒè¯ï¼š50%
        END AS validation_range
    FROM validation_characteristics
)
SELECT
    total_count,
    valid_count,
    ROUND(data_quality_rate::numeric, 4) AS data_quality_rate,
    ROUND(validation_complexity::numeric, 4) AS validation_complexity,
    recommended_strategy,
    validation_range,
    CASE
        WHEN recommended_strategy = 'SAMPLING_VALIDATION' THEN 'Use sampling validation for high-quality data with low complexity'
        WHEN recommended_strategy = 'FULL_VALIDATION' THEN 'Use full validation for low-quality data or high complexity'
        ELSE 'Use incremental validation for medium-quality data'
    END AS validation_advice
FROM adaptive_validation_strategy;
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯æ–‡çŒ®

1. **ã€Šæ•°æ®è´¨é‡ï¼šæ¦‚å¿µã€æŠ€æœ¯ä¸å®è·µã€‹**ï¼ˆBatini et al., 2009ï¼‰- æ•°æ®éªŒè¯å’Œè´¨é‡ä¿è¯

2. **ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹**ï¼ˆSilberschatz et al., 2019ï¼‰- ç¬¬6ç«  å®Œæ•´æ€§çº¦æŸ

3. **PostgreSQLå®˜æ–¹æ–‡æ¡£** - çº¦æŸã€è§¦å‘å™¨ã€å‡½æ•°

### PostgreSQLå®˜æ–¹æ–‡æ¡£

- **çº¦æŸ**: <https://www.postgresql.org/docs/current/ddl-constraints.html>
- **è§¦å‘å™¨**: <https://www.postgresql.org/docs/current/triggers.html>
- **æ­£åˆ™è¡¨è¾¾å¼**: <https://www.postgresql.org/docs/current/functions-matching.html>
- **CHECKçº¦æŸ**: <https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS>

### åœ¨çº¿èµ„æº

- **æ•°æ®éªŒè¯**: <https://en.wikipedia.org/wiki/Data_validation>
- **æ­£åˆ™è¡¨è¾¾å¼**: <https://www.regular-expressions.info/>
- **æ•°æ®è´¨é‡**: <https://www.postgresql.org/docs/current/performance-tips.html>

### ç›¸å…³ç®—æ³•

- **æ•°æ®æ¸…æ´—ç®—æ³•**ï¼šæ•°æ®éªŒè¯çš„å‰ç½®æ­¥éª¤
- **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**ï¼šå®Œæ•´æ€§éªŒè¯
- **æ•°æ®æ ‡å‡†åŒ–ç®—æ³•**ï¼šæ ¼å¼æ ‡å‡†åŒ–
- **æ•°æ®è´¨é‡ç®—æ³•**ï¼šè´¨é‡ä¿è¯

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
