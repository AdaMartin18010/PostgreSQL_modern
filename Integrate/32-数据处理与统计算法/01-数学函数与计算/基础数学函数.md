# PostgreSQL 基础数学函数完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 数学函数 | 基础运算
> **难度级别**: ⭐⭐ (初级)

---

## 📋 目录

- [PostgreSQL 基础数学函数完整指南](#postgresql-基础数学函数完整指南)
  - [📋 目录](#-目录)
  - [基础数学函数概述](#基础数学函数概述)
    - [核心函数列表](#核心函数列表)
  - [1. 四则运算](#1-四则运算)
    - [1.1 基本运算](#11-基本运算)
    - [1.2 取模运算](#12-取模运算)
  - [2. 幂运算和开方](#2-幂运算和开方)
    - [2.1 幂运算](#21-幂运算)
    - [2.2 开方运算](#22-开方运算)
  - [3. 对数运算](#3-对数运算)
    - [3.1 自然对数和常用对数](#31-自然对数和常用对数)
  - [4. 三角函数](#4-三角函数)
    - [4.1 基本三角函数](#41-基本三角函数)
    - [4.2 反三角函数](#42-反三角函数)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 金融计算：复利计算](#51-金融计算复利计算)
    - [5.2 几何计算：距离计算](#52-几何计算距离计算)
  - [📊 性能优化建议](#-性能优化建议)
  - [🎯 最佳实践](#-最佳实践)

---

## 基础数学函数概述

**基础数学函数**是PostgreSQL提供的内置数学运算函数，用于执行基本的数学计算。

### 核心函数列表

| 函数类型 | 函数名称 | 用途 |
|---------|---------|------|
| **四则运算** | +, -, *, / | 基本算术运算 |
| **幂运算** | POWER(), ^ | 幂运算 |
| **开方** | SQRT(), CBRT() | 平方根、立方根 |
| **对数** | LN(), LOG() | 自然对数、常用对数 |
| **三角函数** | SIN(), COS(), TAN() | 三角函数 |
| **反三角函数** | ASIN(), ACOS(), ATAN() | 反三角函数 |

---

## 1. 四则运算

### 1.1 基本运算

**加法、减法、乘法、除法**是基础的算术运算。

```sql
-- 基础四则运算（带错误处理）
DO $$
DECLARE
    value1 NUMERIC := 100;
    value2 NUMERIC := 25;
    addition_result NUMERIC;
    subtraction_result NUMERIC;
    multiplication_result NUMERIC;
    division_result NUMERIC;
BEGIN
    BEGIN
        -- 加法
        addition_result := value1 + value2;
        RAISE NOTICE '加法结果: % + % = %', value1, value2, addition_result;

        -- 减法
        subtraction_result := value1 - value2;
        RAISE NOTICE '减法结果: % - % = %', value1, value2, subtraction_result;

        -- 乘法
        multiplication_result := value1 * value2;
        RAISE NOTICE '乘法结果: % * % = %', value1, value2, multiplication_result;

        -- 除法（避免除零错误）
        IF value2 = 0 THEN
            RAISE WARNING '除数不能为零';
        ELSE
            division_result := value1 / value2;
            RAISE NOTICE '除法结果: % / % = %', value1, value2, division_result;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '四则运算失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：批量计算
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    value1 + value2 AS addition,
    value1 - value2 AS subtraction,
    value1 * value2 AS multiplication,
    value1 / NULLIF(value2, 0) AS division
FROM (
    SELECT
        generate_series(1, 100000) AS id,
        random() * 1000 AS value1,
        random() * 100 + 1 AS value2
) AS test_data;
```

### 1.2 取模运算

**取模运算**用于计算余数。

```sql
-- 取模运算（带错误处理）
DO $$
DECLARE
    dividend NUMERIC := 17;
    divisor NUMERIC := 5;
    modulo_result NUMERIC;
BEGIN
    BEGIN
        IF divisor = 0 THEN
            RAISE WARNING '除数不能为零';
            RETURN;
        END IF;

        modulo_result := dividend % divisor;
        RAISE NOTICE '取模结果: % %% % = %', dividend, divisor, modulo_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '取模运算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. 幂运算和开方

### 2.1 幂运算

**幂运算**用于计算一个数的n次方。

```sql
-- 幂运算（带错误处理）
DO $$
DECLARE
    base NUMERIC := 2;
    exponent NUMERIC := 10;
    power_result NUMERIC;
BEGIN
    BEGIN
        power_result := POWER(base, exponent);
        RAISE NOTICE '幂运算结果: %^% = %', base, exponent, power_result;

        -- 使用^运算符
        power_result := base ^ exponent;
        RAISE NOTICE '使用^运算符: %^% = %', base, exponent, power_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '幂运算失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：批量幂运算
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    POWER(value, 2) AS square,
    POWER(value, 3) AS cube,
    POWER(value, 0.5) AS square_root
FROM (
    SELECT generate_series(1, 100000) AS id, random() * 100 AS value
) AS test_data;
```

### 2.2 开方运算

**开方运算**用于计算平方根和立方根。

```sql
-- 开方运算（带错误处理）
DO $$
DECLARE
    value NUMERIC := 16;
    sqrt_result NUMERIC;
    cbrt_result NUMERIC;
BEGIN
    BEGIN
        IF value < 0 THEN
            RAISE WARNING '负数不能开平方根';
        ELSE
            sqrt_result := SQRT(value);
            RAISE NOTICE '平方根结果: SQRT(%) = %', value, sqrt_result;
        END IF;

        cbrt_result := CBRT(value);
        RAISE NOTICE '立方根结果: CBRT(%) = %', value, cbrt_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '开方运算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3. 对数运算

### 3.1 自然对数和常用对数

**对数运算**用于计算对数值。

```sql
-- 对数运算（带错误处理）
DO $$
DECLARE
    value NUMERIC := 100;
    ln_result NUMERIC;
    log10_result NUMERIC;
    log2_result NUMERIC;
BEGIN
    BEGIN
        IF value <= 0 THEN
            RAISE WARNING '对数的真数必须大于0';
            RETURN;
        END IF;

        -- 自然对数（以e为底）
        ln_result := LN(value);
        RAISE NOTICE '自然对数: LN(%) = %', value, ln_result;

        -- 常用对数（以10为底）
        log10_result := LOG(10, value);
        RAISE NOTICE '常用对数: LOG(10, %) = %', value, log10_result;

        -- 以2为底的对数
        log2_result := LOG(2, value);
        RAISE NOTICE '以2为底的对数: LOG(2, %) = %', value, log2_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '对数运算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. 三角函数

### 4.1 基本三角函数

**三角函数**用于计算角度相关的数学值。

```sql
-- 三角函数（带错误处理）
DO $$
DECLARE
    angle_radians NUMERIC := PI() / 4;  -- 45度
    sin_result NUMERIC;
    cos_result NUMERIC;
    tan_result NUMERIC;
BEGIN
    BEGIN
        -- 正弦
        sin_result := SIN(angle_radians);
        RAISE NOTICE '正弦: SIN(%) = %', angle_radians, sin_result;

        -- 余弦
        cos_result := COS(angle_radians);
        RAISE NOTICE '余弦: COS(%) = %', angle_radians, cos_result;

        -- 正切
        tan_result := TAN(angle_radians);
        RAISE NOTICE '正切: TAN(%) = %', angle_radians, tan_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '三角函数计算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 反三角函数

**反三角函数**用于从三角函数值计算角度。

```sql
-- 反三角函数（带错误处理）
DO $$
DECLARE
    sin_value NUMERIC := 0.7071067811865476;  -- sin(45°)
    cos_value NUMERIC := 0.7071067811865476;  -- cos(45°)
    tan_value NUMERIC := 1.0;  -- tan(45°)
    asin_result NUMERIC;
    acos_result NUMERIC;
    atan_result NUMERIC;
BEGIN
    BEGIN
        IF ABS(sin_value) > 1 THEN
            RAISE WARNING 'ASIN的参数必须在[-1, 1]范围内';
            RETURN;
        END IF;

        -- 反正弦
        asin_result := ASIN(sin_value);
        RAISE NOTICE '反正弦: ASIN(%) = % 弧度', sin_value, asin_result;

        -- 反余弦
        IF ABS(cos_value) > 1 THEN
            RAISE WARNING 'ACOS的参数必须在[-1, 1]范围内';
            RETURN;
        END IF;
        acos_result := ACOS(cos_value);
        RAISE NOTICE '反余弦: ACOS(%) = % 弧度', cos_value, acos_result;

        -- 反正切
        atan_result := ATAN(tan_value);
        RAISE NOTICE '反正切: ATAN(%) = % 弧度', tan_value, atan_result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '反三角函数计算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. 实际应用案例

### 5.1 金融计算：复利计算

```sql
-- 复利计算（带错误处理）
DO $$
DECLARE
    principal NUMERIC := 10000;  -- 本金
    annual_rate NUMERIC := 0.05;  -- 年利率5%
    years INTEGER := 10;  -- 年数
    compound_frequency INTEGER := 12;  -- 复利频率（月）
    final_amount NUMERIC;
BEGIN
    BEGIN
        IF principal <= 0 OR annual_rate < 0 OR years <= 0 OR compound_frequency <= 0 THEN
            RAISE WARNING '参数无效';
            RETURN;
        END IF;

        -- 复利公式: A = P * (1 + r/n)^(n*t)
        final_amount := principal * POWER(1 + annual_rate / compound_frequency, compound_frequency * years);
        RAISE NOTICE '复利计算结果: 本金=%, 年利率=%, 年数=%, 最终金额=%',
            principal, annual_rate, years, final_amount;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '复利计算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 几何计算：距离计算

```sql
-- 两点间距离计算（带错误处理）
DO $$
DECLARE
    x1 NUMERIC := 0;
    y1 NUMERIC := 0;
    x2 NUMERIC := 3;
    y2 NUMERIC := 4;
    distance NUMERIC;
BEGIN
    BEGIN
        -- 欧几里得距离: sqrt((x2-x1)^2 + (y2-y1)^2)
        distance := SQRT(POWER(x2 - x1, 2) + POWER(y2 - y1, 2));
        RAISE NOTICE '两点间距离: 点1(%, %), 点2(%, %), 距离=%',
            x1, y1, x2, y2, distance;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '距离计算失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 📊 性能优化建议

1. **使用索引**: 对于频繁计算的列，考虑创建表达式索引
2. **避免重复计算**: 使用CTE或子查询缓存中间结果
3. **精度控制**: 使用NUMERIC类型控制精度，避免浮点误差
4. **批量处理**: 对于大量数据，使用批量计算而非逐行计算

---

## 🎯 最佳实践

1. **错误处理**: 始终检查除零、负数开方等边界情况
2. **精度控制**: 金融计算使用NUMERIC而非REAL/DOUBLE
3. **性能考虑**: 对于复杂计算，考虑使用函数或存储过程
4. **文档注释**: 为复杂公式添加注释说明

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
