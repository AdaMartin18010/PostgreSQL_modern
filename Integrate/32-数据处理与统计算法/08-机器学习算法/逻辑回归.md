# PostgreSQL é€»è¾‘å›å½’å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | é€»è¾‘å›å½’ | åˆ†ç±»ç®—æ³•
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL é€»è¾‘å›å½’å®Œæ•´æŒ‡å—](#postgresql-é€»è¾‘å›å½’å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [é€»è¾‘å›å½’æ¦‚è¿°](#é€»è¾‘å›å½’æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. äºŒåˆ†ç±»é€»è¾‘å›å½’](#1-äºŒåˆ†ç±»é€»è¾‘å›å½’)
    - [1.1 Sigmoidå‡½æ•°å®ç°](#11-sigmoidå‡½æ•°å®ç°)
  - [2. å¤šåˆ†ç±»é€»è¾‘å›å½’](#2-å¤šåˆ†ç±»é€»è¾‘å›å½’)
    - [2.1 Softmaxå‡½æ•°å®ç°](#21-softmaxå‡½æ•°å®ç°)
  - [3. æ¨¡å‹è¯„ä¼°](#3-æ¨¡å‹è¯„ä¼°)
    - [3.1 æ··æ·†çŸ©é˜µ](#31-æ··æ·†çŸ©é˜µ)
    - [3.2 ROCæ›²çº¿](#32-rocæ›²çº¿)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç”¨æˆ·æµå¤±é¢„æµ‹](#41-ç”¨æˆ·æµå¤±é¢„æµ‹)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## é€»è¾‘å›å½’æ¦‚è¿°

**é€»è¾‘å›å½’**ç”¨äºäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»é—®é¢˜ï¼Œé€šè¿‡Sigmoidå‡½æ•°å°†çº¿æ€§å›å½’ç»“æœæ˜ å°„åˆ°æ¦‚ç‡ç©ºé—´ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **Sigmoidå‡½æ•°** | äºŒåˆ†ç±» | O(n) |
| **Softmaxå‡½æ•°** | å¤šåˆ†ç±» | O(n*k) |
| **æœ€å¤§ä¼¼ç„¶ä¼°è®¡** | å‚æ•°ä¼°è®¡ | O(n*m) |

---

## 1. äºŒåˆ†ç±»é€»è¾‘å›å½’

### 1.1 Sigmoidå‡½æ•°å®ç°

**Sigmoidå‡½æ•°**å°†çº¿æ€§ç»„åˆæ˜ å°„åˆ°0-1ä¹‹é—´çš„æ¦‚ç‡å€¼ã€‚

```sql
-- åˆ›å»ºé€»è¾‘å›å½’æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logistic_data') THEN
            RAISE WARNING 'è¡¨ logistic_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE logistic_data CASCADE;
        END IF;

        CREATE TABLE logistic_data (
            id SERIAL PRIMARY KEY,
            feature1 NUMERIC NOT NULL,
            feature2 NUMERIC NOT NULL,
            label INTEGER NOT NULL CHECK (label IN (0, 1))
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO logistic_data (feature1, feature2, label) VALUES
            (1.0, 2.0, 0), (2.0, 3.0, 0), (3.0, 4.0, 1),
            (4.0, 5.0, 1), (5.0, 6.0, 1), (6.0, 7.0, 1),
            (7.0, 8.0, 1), (8.0, 9.0, 1), (9.0, 10.0, 1), (10.0, 11.0, 1);

        RAISE NOTICE 'è¡¨ logistic_data åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥10æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ logistic_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- Sigmoidå‡½æ•°å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION sigmoid(z NUMERIC)
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    BEGIN
        -- Sigmoidå‡½æ•°: 1 / (1 + exp(-z))
        -- é˜²æ­¢æº¢å‡º
        IF z > 700 THEN
            RETURN 1.0;
        ELSIF z < -700 THEN
            RETURN 0.0;
        ELSE
            RETURN 1.0 / (1.0 + EXP(-z));
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Sigmoidå‡½æ•°è®¡ç®—å¤±è´¥: %', SQLERRM;
            RETURN NULL;
    END;
END;
$$;

-- é€»è¾‘å›å½’é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logistic_data') THEN
            RAISE WARNING 'è¡¨ logistic_data ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé€»è¾‘å›å½’';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'sigmoid') THEN
            RAISE WARNING 'Sigmoidå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé€»è¾‘å›å½’é¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é€»è¾‘å›å½’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨ç®€åŒ–çš„æƒé‡è¿›è¡Œé¢„æµ‹ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦é€šè¿‡è®­ç»ƒå¾—åˆ°ï¼‰
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
),
predictions AS (
    SELECT
        id,
        feature1,
        feature2,
        label,
        sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) AS probability,
        CASE
            WHEN sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) > 0.5 THEN 1
            ELSE 0
        END AS predicted_label
    FROM logistic_data, weights w
)
SELECT
    id,
    feature1,
    feature2,
    label AS actual_label,
    ROUND(probability::numeric, 4) AS probability,
    predicted_label,
    CASE WHEN label = predicted_label THEN 1 ELSE 0 END AS is_correct
FROM predictions
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
)
SELECT
    sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) AS probability
FROM logistic_data, weights w
LIMIT 100;
```

---

## 2. å¤šåˆ†ç±»é€»è¾‘å›å½’

### 2.1 Softmaxå‡½æ•°å®ç°

**Softmaxå‡½æ•°**å°†å¤šä¸ªçº¿æ€§ç»„åˆæ˜ å°„åˆ°æ¦‚ç‡åˆ†å¸ƒã€‚

```sql
-- Softmaxå‡½æ•°å®ç°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION softmax(z NUMERIC[])
RETURNS NUMERIC[]
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    max_z NUMERIC;
    exp_sum NUMERIC;
    result NUMERIC[];
    i INTEGER;
BEGIN
    BEGIN
        IF z IS NULL OR array_length(z, 1) IS NULL THEN
            RAISE WARNING 'è¾“å…¥æ•°ç»„ä¸ºç©º';
            RETURN NULL;
        END IF;

        -- æ‰¾åˆ°æœ€å¤§å€¼ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰
        SELECT MAX(unnest) INTO max_z FROM unnest(z) AS unnest;

        -- è®¡ç®—exp(z_i - max_z)çš„å’Œ
        SELECT SUM(EXP(unnest - max_z)) INTO exp_sum FROM unnest(z) AS unnest;

        -- è®¡ç®—Softmax
        result := ARRAY[]::NUMERIC[];
        FOR i IN 1..array_length(z, 1) LOOP
            result := result || EXP(z[i] - max_z) / exp_sum;
        END LOOP;

        RETURN result;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Softmaxå‡½æ•°è®¡ç®—å¤±è´¥: %', SQLERRM;
            RETURN NULL;
    END;
END;
$$;

-- å¤šåˆ†ç±»é€»è¾‘å›å½’ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'multiclass_data') THEN
            RAISE WARNING 'è¡¨ multiclass_data ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE multiclass_data (
                id SERIAL PRIMARY KEY,
                feature1 NUMERIC NOT NULL,
                feature2 NUMERIC NOT NULL,
                class_label INTEGER NOT NULL CHECK (class_label IN (0, 1, 2))
            );

            INSERT INTO multiclass_data (feature1, feature2, class_label) VALUES
                (1.0, 2.0, 0), (2.0, 3.0, 0), (3.0, 4.0, 1),
                (4.0, 5.0, 1), (5.0, 6.0, 2), (6.0, 7.0, 2);

            RAISE NOTICE 'è¡¨ multiclass_data åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'softmax') THEN
            RAISE WARNING 'Softmaxå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¤šåˆ†ç±»é€»è¾‘å›å½’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šåˆ†ç±»é€»è¾‘å›å½’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤šåˆ†ç±»é¢„æµ‹ï¼ˆä½¿ç”¨ç®€åŒ–çš„æƒé‡ï¼‰
WITH weights AS (
    SELECT
        ARRAY[0.5, 0.3, -0.2] AS w1,  -- ç±»åˆ«0çš„æƒé‡
        ARRAY[0.2, 0.4, -0.1] AS w2,  -- ç±»åˆ«1çš„æƒé‡
        ARRAY[-0.3, 0.1, 0.5] AS w3,  -- ç±»åˆ«2çš„æƒé‡
        ARRAY[-1.0, -0.5, 0.0] AS bias
),
scores AS (
    SELECT
        id,
        feature1,
        feature2,
        class_label,
        ARRAY[
            w.w1[1] * feature1 + w.w1[2] * feature2 + w.w1[3] + w.bias[1],
            w.w2[1] * feature1 + w.w2[2] * feature2 + w.w2[3] + w.bias[2],
            w.w3[1] * feature1 + w.w3[2] * feature2 + w.w3[3] + w.bias[3]
        ] AS class_scores
    FROM multiclass_data, weights w
),
probabilities AS (
    SELECT
        id,
        feature1,
        feature2,
        class_label,
        class_scores,
        softmax(class_scores) AS probabilities
    FROM scores
)
SELECT
    id,
    feature1,
    feature2,
    class_label AS actual_class,
    probabilities[1] AS prob_class0,
    probabilities[2] AS prob_class1,
    probabilities[3] AS prob_class2,
    CASE
        WHEN probabilities[1] >= probabilities[2] AND probabilities[1] >= probabilities[3] THEN 0
        WHEN probabilities[2] >= probabilities[3] THEN 1
        ELSE 2
    END AS predicted_class
FROM probabilities
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH weights AS (
    SELECT ARRAY[0.5, 0.3, -0.2] AS w1
)
SELECT feature1, feature2 FROM multiclass_data LIMIT 100;
```

---

## 3. æ¨¡å‹è¯„ä¼°

### 3.1 æ··æ·†çŸ©é˜µ

**æ··æ·†çŸ©é˜µ**å±•ç¤ºåˆ†ç±»ç»“æœçš„å‡†ç¡®æ€§ã€‚

```sql
-- æ··æ·†çŸ©é˜µè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logistic_data') THEN
            RAISE WARNING 'è¡¨ logistic_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ··æ·†çŸ©é˜µ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æ··æ·†çŸ©é˜µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ··æ·†çŸ©é˜µè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æ··æ·†çŸ©é˜µ
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
),
predictions AS (
    SELECT
        label AS actual,
        CASE
            WHEN sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) > 0.5 THEN 1
            ELSE 0
        END AS predicted
    FROM logistic_data, weights w
),
confusion_matrix AS (
    SELECT
        actual,
        predicted,
        COUNT(*) AS count
    FROM predictions
    GROUP BY actual, predicted
)
SELECT
    SUM(CASE WHEN actual = 0 AND predicted = 0 THEN count ELSE 0 END) AS true_negative,
    SUM(CASE WHEN actual = 0 AND predicted = 1 THEN count ELSE 0 END) AS false_positive,
    SUM(CASE WHEN actual = 1 AND predicted = 0 THEN count ELSE 0 END) AS false_negative,
    SUM(CASE WHEN actual = 1 AND predicted = 1 THEN count ELSE 0 END) AS true_positive,
    COUNT(*) AS total
FROM predictions;

-- è®¡ç®—å‡†ç¡®ç‡ã€ç²¾ç¡®ç‡ã€å¬å›ç‡
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
),
predictions AS (
    SELECT
        label AS actual,
        CASE
            WHEN sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) > 0.5 THEN 1
            ELSE 0
        END AS predicted
    FROM logistic_data, weights w
),
metrics AS (
    SELECT
        SUM(CASE WHEN actual = 0 AND predicted = 0 THEN 1 ELSE 0 END) AS tn,
        SUM(CASE WHEN actual = 0 AND predicted = 1 THEN 1 ELSE 0 END) AS fp,
        SUM(CASE WHEN actual = 1 AND predicted = 0 THEN 1 ELSE 0 END) AS fn,
        SUM(CASE WHEN actual = 1 AND predicted = 1 THEN 1 ELSE 0 END) AS tp,
        COUNT(*) AS total
    FROM predictions
)
SELECT
    tn,
    fp,
    fn,
    tp,
    total,
    ROUND((tp + tn)::numeric / NULLIF(total, 0), 4) AS accuracy,
    ROUND(tp::numeric / NULLIF(tp + fp, 0), 4) AS precision,
    ROUND(tp::numeric / NULLIF(tp + fn, 0), 4) AS recall,
    ROUND(2 * tp::numeric / NULLIF(2 * tp + fp + fn, 0), 4) AS f1_score
FROM metrics;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
)
SELECT
    label AS actual,
    CASE
        WHEN sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) > 0.5 THEN 1
        ELSE 0
    END AS predicted
FROM logistic_data, weights w;
```

### 3.2 ROCæ›²çº¿

**ROCæ›²çº¿**è¯„ä¼°åˆ†ç±»å™¨åœ¨ä¸åŒé˜ˆå€¼ä¸‹çš„æ€§èƒ½ã€‚

```sql
-- ROCæ›²çº¿æ•°æ®è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logistic_data') THEN
            RAISE WARNING 'è¡¨ logistic_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ROCæ›²çº¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ROCæ›²çº¿æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ROCæ›²çº¿è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ä¸åŒé˜ˆå€¼ä¸‹çš„TPRå’ŒFPR
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
),
probabilities AS (
    SELECT
        label AS actual,
        sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) AS prob
    FROM logistic_data, weights w
),
thresholds AS (
    SELECT unnest(ARRAY[0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]) AS threshold
),
roc_points AS (
    SELECT
        t.threshold,
        SUM(CASE WHEN p.actual = 1 AND p.prob >= t.threshold THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN p.actual = 1 THEN 1 ELSE 0 END), 0) AS tpr,
        SUM(CASE WHEN p.actual = 0 AND p.prob >= t.threshold THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN p.actual = 0 THEN 1 ELSE 0 END), 0) AS fpr
    FROM thresholds t
    CROSS JOIN probabilities p
    GROUP BY t.threshold
)
SELECT
    threshold,
    ROUND(COALESCE(tpr, 0)::numeric, 4) AS tpr,
    ROUND(COALESCE(fpr, 0)::numeric, 4) AS fpr
FROM roc_points
ORDER BY threshold;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH weights AS (
    SELECT 0.5 AS w1, 0.3 AS w2, -2.0 AS bias
)
SELECT
    sigmoid(w.w1 * feature1 + w.w2 * feature2 + w.bias) AS prob
FROM logistic_data, weights w
LIMIT 100;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç”¨æˆ·æµå¤±é¢„æµ‹

**ç”¨æˆ·æµå¤±é¢„æµ‹**ä½¿ç”¨é€»è¾‘å›å½’é¢„æµ‹ç”¨æˆ·æ˜¯å¦ä¼šæµå¤±ã€‚

```sql
-- ç”¨æˆ·æµå¤±é¢„æµ‹ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_behavior') THEN
            RAISE WARNING 'è¡¨ user_behavior ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE user_behavior (
                user_id SERIAL PRIMARY KEY,
                login_days INTEGER NOT NULL,
                purchase_count INTEGER NOT NULL,
                avg_session_duration NUMERIC NOT NULL,
                churned INTEGER NOT NULL CHECK (churned IN (0, 1))
            );

            INSERT INTO user_behavior (login_days, purchase_count, avg_session_duration, churned) VALUES
                (5, 2, 10.5, 1), (15, 5, 25.3, 0), (20, 8, 30.1, 0),
                (3, 1, 8.2, 1), (25, 10, 35.5, 0), (2, 0, 5.1, 1),
                (30, 12, 40.2, 0), (1, 0, 3.5, 1), (18, 6, 28.7, 0), (4, 1, 9.8, 1);

            RAISE NOTICE 'è¡¨ user_behavior åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç”¨æˆ·æµå¤±é¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·æµå¤±é¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨é€»è¾‘å›å½’é¢„æµ‹ç”¨æˆ·æµå¤±æ¦‚ç‡
WITH weights AS (
    SELECT
        -0.1 AS w_login,
        0.05 AS w_purchase,
        -0.02 AS w_duration,
        -1.5 AS bias
),
predictions AS (
    SELECT
        user_id,
        login_days,
        purchase_count,
        avg_session_duration,
        churned AS actual_churned,
        sigmoid(
            w.w_login * login_days +
            w.w_purchase * purchase_count +
            w.w_duration * avg_session_duration +
            w.bias
        ) AS churn_probability,
        CASE
            WHEN sigmoid(
                w.w_login * login_days +
                w.w_purchase * purchase_count +
                w.w_duration * avg_session_duration +
                w.bias
            ) > 0.5 THEN 1
            ELSE 0
        END AS predicted_churned
    FROM user_behavior, weights w
)
SELECT
    user_id,
    login_days,
    purchase_count,
    avg_session_duration,
    actual_churned,
    ROUND(churn_probability::numeric, 4) AS churn_probability,
    predicted_churned,
    CASE WHEN actual_churned = predicted_churned THEN 'Correct' ELSE 'Wrong' END AS prediction_status
FROM predictions
ORDER BY churn_probability DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH weights AS (
    SELECT -0.1 AS w_login, 0.05 AS w_purchase, -0.02 AS w_duration, -1.5 AS bias
)
SELECT
    sigmoid(
        w.w_login * login_days +
        w.w_purchase * purchase_count +
        w.w_duration * avg_session_duration +
        w.bias
    ) AS churn_probability
FROM user_behavior, weights w;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‡½æ•°ä¼˜åŒ–**: ä½¿ç”¨IMMUTABLEæ ‡è®°æé«˜å‡½æ•°æ€§èƒ½
2. **ç´¢å¼•ä¼˜åŒ–**: åœ¨ç‰¹å¾åˆ—ä¸Šåˆ›å»ºç´¢å¼•
3. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨æ•°ç»„æ“ä½œå‡å°‘å‡½æ•°è°ƒç”¨æ¬¡æ•°

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç‰¹å¾å·¥ç¨‹**: å¯¹ç‰¹å¾è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†
2. **æ­£åˆ™åŒ–**: ä½¿ç”¨L1/L2æ­£åˆ™åŒ–é˜²æ­¢è¿‡æ‹Ÿåˆ
3. **äº¤å‰éªŒè¯**: ä½¿ç”¨KæŠ˜äº¤å‰éªŒè¯è¯„ä¼°æ¨¡å‹
4. **é˜ˆå€¼è°ƒæ•´**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´åˆ†ç±»é˜ˆå€¼

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
