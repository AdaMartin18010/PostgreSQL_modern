# PostgreSQL æ¨èç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ¨èç®—æ³• | ååŒè¿‡æ»¤
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ¨èç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ¨èç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¨èç®—æ³•æ¦‚è¿°](#æ¨èç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. ååŒè¿‡æ»¤](#1-ååŒè¿‡æ»¤)
    - [1.1 åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤](#11-åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤)
    - [1.2 åŸºäºç‰©å“çš„ååŒè¿‡æ»¤](#12-åŸºäºç‰©å“çš„ååŒè¿‡æ»¤)
  - [2. ç›¸ä¼¼åº¦è®¡ç®—](#2-ç›¸ä¼¼åº¦è®¡ç®—)
    - [2.1 ä½™å¼¦ç›¸ä¼¼åº¦](#21-ä½™å¼¦ç›¸ä¼¼åº¦)
    - [2.2 çš®å°”é€Šç›¸å…³ç³»æ•°](#22-çš®å°”é€Šç›¸å…³ç³»æ•°)
  - [3. æ¨èç”Ÿæˆ](#3-æ¨èç”Ÿæˆ)
    - [3.1 Top-Næ¨è](#31-top-næ¨è)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 å•†å“æ¨è](#41-å•†å“æ¨è)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ¨èç®—æ³•æ¦‚è¿°

**æ¨èç®—æ³•**ç”¨äºé¢„æµ‹ç”¨æˆ·å¯èƒ½æ„Ÿå…´è¶£çš„ç‰©å“ï¼Œå¹¿æ³›åº”ç”¨äºç”µå•†ã€å†…å®¹å¹³å°ç­‰åœºæ™¯ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **ååŒè¿‡æ»¤** | åŸºäºç”¨æˆ·è¡Œä¸º | O(nÂ²) |
| **å†…å®¹è¿‡æ»¤** | åŸºäºç‰©å“ç‰¹å¾ | O(n*m) |
| **æ··åˆæ¨è** | ç»„åˆå¤šç§æ–¹æ³• | O(nÂ²) |

---

## 1. ååŒè¿‡æ»¤

### 1.1 åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤

**åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤**æ‰¾åˆ°ç›¸ä¼¼ç”¨æˆ·ï¼Œæ¨èä»–ä»¬å–œæ¬¢çš„ç‰©å“ã€‚

```sql
-- åˆ›å»ºç”¨æˆ·è¯„åˆ†è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE user_ratings CASCADE;
        END IF;

        CREATE TABLE user_ratings (
            user_id INTEGER NOT NULL,
            item_id INTEGER NOT NULL,
            rating NUMERIC NOT NULL CHECK (rating >= 1 AND rating <= 5),
            PRIMARY KEY (user_id, item_id)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO user_ratings (user_id, item_id, rating) VALUES
            (1, 1, 5), (1, 2, 4), (1, 3, 3), (1, 4, 2),
            (2, 1, 4), (2, 2, 5), (2, 3, 4), (2, 5, 3),
            (3, 2, 3), (3, 3, 5), (3, 4, 4), (3, 5, 5),
            (4, 1, 2), (4, 3, 4), (4, 4, 5), (4, 5, 4);

        RAISE NOTICE 'è¡¨ user_ratings åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥16æ¡è¯„åˆ†æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ user_ratings å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒååŒè¿‡æ»¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ååŒè¿‡æ»¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
WITH user_vectors AS (
    SELECT
        user_id,
        item_id,
        rating
    FROM user_ratings
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) AS dot_product,
        SQRT(SUM(u1.rating * u1.rating)) AS norm1,
        SQRT(SUM(u2.rating * u2.rating)) AS norm2
    FROM user_vectors u1
    JOIN user_vectors u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
)
SELECT
    user1_id,
    user2_id,
    ROUND((dot_product / NULLIF(norm1 * norm2, 0))::numeric, 4) AS cosine_similarity
FROM user_similarity
ORDER BY cosine_similarity DESC;

-- ä¸ºç”¨æˆ·1æ¨èç‰©å“ï¼ˆåŸºäºç›¸ä¼¼ç”¨æˆ·ï¼‰
WITH target_user AS (
    SELECT 1 AS user_id
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) /
        NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity
    FROM user_ratings u1
    JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
    GROUP BY u1.user_id, u2.user_id
),
similar_users AS (
    SELECT
        CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
        similarity
    FROM user_similarity
    WHERE similarity > 0.5  -- ç›¸ä¼¼åº¦é˜ˆå€¼
),
recommendations AS (
    SELECT
        r.item_id,
        SUM(r.rating * s.similarity) / SUM(s.similarity) AS predicted_rating,
        COUNT(*) AS recommendation_count
    FROM user_ratings r
    JOIN similar_users s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating,
    recommendation_count
FROM recommendations
ORDER BY predicted_rating DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    u1.user_id,
    u2.user_id,
    COUNT(*) AS common_items
FROM user_ratings u1
JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
GROUP BY u1.user_id, u2.user_id
LIMIT 100;
```

### 1.2 åŸºäºç‰©å“çš„ååŒè¿‡æ»¤

**åŸºäºç‰©å“çš„ååŒè¿‡æ»¤**æ‰¾åˆ°ç›¸ä¼¼ç‰©å“ï¼Œæ¨èç»™ç”¨æˆ·ã€‚

```sql
-- åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç‰©å“ååŒè¿‡æ»¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºäºç‰©å“çš„ååŒè¿‡æ»¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç‰©å“ååŒè¿‡æ»¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç‰©å“ç›¸ä¼¼åº¦
WITH item_vectors AS (
    SELECT
        item_id,
        user_id,
        rating
    FROM user_ratings
),
item_similarity AS (
    SELECT
        i1.item_id AS item1_id,
        i2.item_id AS item2_id,
        SUM(i1.rating * i2.rating) AS dot_product,
        SQRT(SUM(i1.rating * i1.rating)) AS norm1,
        SQRT(SUM(i2.rating * i2.rating)) AS norm2
    FROM item_vectors i1
    JOIN item_vectors i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
    GROUP BY i1.item_id, i2.item_id
)
SELECT
    item1_id,
    item2_id,
    ROUND((dot_product / NULLIF(norm1 * norm2, 0))::numeric, 4) AS cosine_similarity
FROM item_similarity
ORDER BY cosine_similarity DESC;

-- ä¸ºç”¨æˆ·1æ¨èç‰©å“ï¼ˆåŸºäºç‰©å“ç›¸ä¼¼åº¦ï¼‰
WITH target_user AS (
    SELECT 1 AS user_id
),
user_items AS (
    SELECT item_id, rating
    FROM user_ratings
    WHERE user_id = (SELECT user_id FROM target_user)
),
item_similarity AS (
    SELECT
        i1.item_id AS item1_id,
        i2.item_id AS item2_id,
        SUM(i1.rating * i2.rating) /
        NULLIF(SQRT(SUM(i1.rating * i1.rating)) * SQRT(SUM(i2.rating * i2.rating)), 0) AS similarity
    FROM user_ratings i1
    JOIN user_ratings i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
    GROUP BY i1.item_id, i2.item_id
),
recommendations AS (
    SELECT
        CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END AS item_id,
        SUM(ui.rating * isim.similarity) / SUM(isim.similarity) AS predicted_rating
    FROM user_items ui
    JOIN item_similarity isim ON (isim.item1_id = ui.item_id OR isim.item2_id = ui.item_id)
    WHERE CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END
          NOT IN (SELECT item_id FROM user_items)
    GROUP BY CASE WHEN isim.item1_id = ui.item_id THEN isim.item2_id ELSE isim.item1_id END
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating
FROM recommendations
ORDER BY predicted_rating DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    i1.item_id,
    i2.item_id,
    COUNT(*) AS common_users
FROM user_ratings i1
JOIN user_ratings i2 ON i1.user_id = i2.user_id AND i1.item_id < i2.item_id
GROUP BY i1.item_id, i2.item_id
LIMIT 100;
```

---

## 2. ç›¸ä¼¼åº¦è®¡ç®—

### 2.1 ä½™å¼¦ç›¸ä¼¼åº¦

**ä½™å¼¦ç›¸ä¼¼åº¦**è¡¡é‡ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ã€‚

```sql
-- ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION cosine_similarity(vec1 NUMERIC[], vec2 NUMERIC[])
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    dot_product NUMERIC := 0;
    norm1 NUMERIC := 0;
    norm2 NUMERIC := 0;
    i INTEGER;
BEGIN
    BEGIN
        IF vec1 IS NULL OR vec2 IS NULL OR
           array_length(vec1, 1) IS NULL OR array_length(vec2, 1) IS NULL THEN
            RAISE WARNING 'è¾“å…¥å‘é‡ä¸ºç©º';
            RETURN NULL;
        END IF;

        IF array_length(vec1, 1) != array_length(vec2, 1) THEN
            RAISE WARNING 'å‘é‡ç»´åº¦ä¸åŒ¹é…';
            RETURN NULL;
        END IF;

        -- è®¡ç®—ç‚¹ç§¯å’ŒèŒƒæ•°
        FOR i IN 1..array_length(vec1, 1) LOOP
            dot_product := dot_product + vec1[i] * vec2[i];
            norm1 := norm1 + vec1[i] * vec1[i];
            norm2 := norm2 + vec2[i] * vec2[i];
        END LOOP;

        norm1 := SQRT(norm1);
        norm2 := SQRT(norm2);

        IF norm1 = 0 OR norm2 = 0 THEN
            RETURN 0;
        END IF;

        RETURN dot_product / (norm1 * norm2);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å¤±è´¥: %', SQLERRM;
            RETURN NULL;
    END;
END;
$$;

-- ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'cosine_similarity') THEN
            RAISE WARNING 'cosine_similarityå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æµ‹è¯•ä½™å¼¦ç›¸ä¼¼åº¦å‡½æ•°
SELECT
    cosine_similarity(ARRAY[1, 2, 3], ARRAY[4, 5, 6]) AS similarity1,
    cosine_similarity(ARRAY[1, 0, 0], ARRAY[0, 1, 0]) AS similarity2,
    cosine_similarity(ARRAY[1, 2, 3], ARRAY[2, 4, 6]) AS similarity3;
```

### 2.2 çš®å°”é€Šç›¸å…³ç³»æ•°

**çš®å°”é€Šç›¸å…³ç³»æ•°**è¡¡é‡ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³æ€§ã€‚

```sql
-- çš®å°”é€Šç›¸å…³ç³»æ•°è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çš®å°”é€Šç›¸å…³ç³»æ•°è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç”¨æˆ·é—´çš„çš®å°”é€Šç›¸å…³ç³»æ•°
WITH user_stats AS (
    SELECT
        user_id,
        AVG(rating) AS avg_rating,
        STDDEV(rating) AS std_rating
    FROM user_ratings
    GROUP BY user_id
),
user_ratings_normalized AS (
    SELECT
        ur.user_id,
        ur.item_id,
        ur.rating,
        us.avg_rating,
        (ur.rating - us.avg_rating) / NULLIF(us.std_rating, 0) AS normalized_rating
    FROM user_ratings ur
    JOIN user_stats us ON ur.user_id = us.user_id
),
pearson_correlation AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        COUNT(*) AS common_items,
        SUM(u1.normalized_rating * u2.normalized_rating) /
        NULLIF(COUNT(*), 0) AS correlation
    FROM user_ratings_normalized u1
    JOIN user_ratings_normalized u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
    HAVING COUNT(*) >= 2  -- è‡³å°‘2ä¸ªå…±åŒè¯„åˆ†
)
SELECT
    user1_id,
    user2_id,
    common_items,
    ROUND(correlation::numeric, 4) AS pearson_correlation
FROM pearson_correlation
ORDER BY correlation DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    u1.user_id,
    u2.user_id,
    COUNT(*) AS common_items
FROM user_ratings u1
JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
GROUP BY u1.user_id, u2.user_id
LIMIT 100;
```

---

## 3. æ¨èç”Ÿæˆ

### 3.1 Top-Næ¨è

**Top-Næ¨è**ä¸ºç”¨æˆ·ç”Ÿæˆå‰Nä¸ªæœ€å¯èƒ½æ„Ÿå…´è¶£çš„ç‰©å“ã€‚

```sql
-- Top-Næ¨èç”Ÿæˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_ratings') THEN
            RAISE WARNING 'è¡¨ user_ratings ä¸å­˜åœ¨ï¼Œæ— æ³•ç”ŸæˆTop-Næ¨è';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”ŸæˆTop-Næ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Top-Næ¨èç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸ºç”¨æˆ·1ç”ŸæˆTop-5æ¨è
WITH target_user AS (
    SELECT 1 AS user_id, 5 AS top_n
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.rating * u2.rating) /
        NULLIF(SQRT(SUM(u1.rating * u1.rating)) * SQRT(SUM(u2.rating * u2.rating)), 0) AS similarity
    FROM user_ratings u1
    JOIN user_ratings u2 ON u1.item_id = u2.item_id AND u1.user_id < u2.user_id
    WHERE u1.user_id = (SELECT user_id FROM target_user) OR u2.user_id = (SELECT user_id FROM target_user)
    GROUP BY u1.user_id, u2.user_id
),
similar_users AS (
    SELECT
        CASE WHEN user1_id = (SELECT user_id FROM target_user) THEN user2_id ELSE user1_id END AS similar_user_id,
        similarity
    FROM user_similarity
    WHERE similarity > 0.3  -- ç›¸ä¼¼åº¦é˜ˆå€¼
),
recommendations AS (
    SELECT
        r.item_id,
        SUM(r.rating * s.similarity) / SUM(s.similarity) AS predicted_rating,
        COUNT(*) AS recommendation_count,
        SUM(s.similarity) AS total_similarity
    FROM user_ratings r
    JOIN similar_users s ON r.user_id = s.similar_user_id
    WHERE r.item_id NOT IN (SELECT item_id FROM user_ratings WHERE user_id = (SELECT user_id FROM target_user))
    GROUP BY r.item_id
    HAVING COUNT(*) >= 2  -- è‡³å°‘2ä¸ªç›¸ä¼¼ç”¨æˆ·æ¨è
)
SELECT
    item_id,
    ROUND(predicted_rating::numeric, 2) AS predicted_rating,
    recommendation_count,
    ROUND(total_similarity::numeric, 4) AS total_similarity
FROM recommendations
ORDER BY predicted_rating DESC, total_similarity DESC
LIMIT (SELECT top_n FROM target_user);

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    item_id,
    AVG(rating) AS avg_rating
FROM user_ratings
WHERE user_id = 1
GROUP BY item_id
LIMIT 10;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 å•†å“æ¨è

**å•†å“æ¨è**ä¸ºç”µå•†ç”¨æˆ·æ¨èå¯èƒ½æ„Ÿå…´è¶£çš„å•†å“ã€‚

```sql
-- å•†å“æ¨èç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'product_interactions') THEN
            RAISE WARNING 'è¡¨ product_interactions ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE product_interactions (
                user_id INTEGER NOT NULL,
                product_id INTEGER NOT NULL,
                interaction_type VARCHAR(20) NOT NULL,  -- 'view', 'purchase', 'cart'
                interaction_score NUMERIC NOT NULL,  -- 1-5åˆ†
                interaction_time TIMESTAMP DEFAULT NOW(),
                PRIMARY KEY (user_id, product_id, interaction_type)
            );

            INSERT INTO product_interactions (user_id, product_id, interaction_type, interaction_score) VALUES
                (1, 101, 'purchase', 5), (1, 102, 'view', 4), (1, 103, 'cart', 3),
                (2, 101, 'purchase', 4), (2, 102, 'purchase', 5), (2, 104, 'view', 3),
                (3, 102, 'purchase', 4), (3, 103, 'purchase', 5), (3, 105, 'view', 4),
                (4, 101, 'view', 2), (4, 103, 'purchase', 5), (4, 105, 'purchase', 4);

            RAISE NOTICE 'è¡¨ product_interactions åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå•†å“æ¨è';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å•†å“æ¨èå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—åŠ æƒè¯„åˆ†ï¼ˆä¸åŒäº¤äº’ç±»å‹æƒé‡ä¸åŒï¼‰
WITH weighted_ratings AS (
    SELECT
        user_id,
        product_id,
        SUM(CASE interaction_type
            WHEN 'purchase' THEN interaction_score * 3
            WHEN 'cart' THEN interaction_score * 2
            WHEN 'view' THEN interaction_score * 1
            ELSE interaction_score
        END) /
        SUM(CASE interaction_type
            WHEN 'purchase' THEN 3
            WHEN 'cart' THEN 2
            WHEN 'view' THEN 1
            ELSE 1
        END) AS weighted_rating
    FROM product_interactions
    GROUP BY user_id, product_id
),
user_similarity AS (
    SELECT
        u1.user_id AS user1_id,
        u2.user_id AS user2_id,
        SUM(u1.weighted_rating * u2.weighted_rating) /
        NULLIF(SQRT(SUM(u1.weighted_rating * u1.weighted_rating)) *
               SQRT(SUM(u2.weighted_rating * u2.weighted_rating)), 0) AS similarity
    FROM weighted_ratings u1
    JOIN weighted_ratings u2 ON u1.product_id = u2.product_id AND u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
),
recommendations AS (
    SELECT
        wr.product_id,
        SUM(wr.weighted_rating * us.similarity) / SUM(us.similarity) AS predicted_score
    FROM weighted_ratings wr
    JOIN user_similarity us ON wr.user_id = us.user2_id
    WHERE us.user1_id = 1  -- ä¸ºç›®æ ‡ç”¨æˆ·æ¨è
      AND wr.product_id NOT IN (SELECT product_id FROM weighted_ratings WHERE user_id = 1)
    GROUP BY wr.product_id
    HAVING COUNT(*) >= 1
)
SELECT
    product_id,
    ROUND(predicted_score::numeric, 2) AS predicted_score
FROM recommendations
ORDER BY predicted_score DESC
LIMIT 10;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    product_id,
    AVG(interaction_score) AS avg_score
FROM product_interactions
GROUP BY user_id, product_id
LIMIT 100;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **çŸ©é˜µåˆ†è§£**: ä½¿ç”¨SVDç­‰çŸ©é˜µåˆ†è§£æ–¹æ³•é™ä½è®¡ç®—å¤æ‚åº¦
2. **ç¼“å­˜**: ç¼“å­˜ç›¸ä¼¼åº¦è®¡ç®—ç»“æœ
3. **å¢é‡æ›´æ–°**: ä½¿ç”¨å¢é‡æ›´æ–°è€Œéå…¨é‡è®¡ç®—

## ğŸ¯ æœ€ä½³å®è·µ

1. **å†·å¯åŠ¨**: å¤„ç†æ–°ç”¨æˆ·å’Œæ–°ç‰©å“çš„æ¨èé—®é¢˜
2. **å¤šæ ·æ€§**: å¹³è¡¡å‡†ç¡®æ€§å’Œå¤šæ ·æ€§
3. **å®æ—¶æ€§**: è€ƒè™‘å®æ—¶æ¨èéœ€æ±‚
4. **A/Bæµ‹è¯•**: ä½¿ç”¨A/Bæµ‹è¯•è¯„ä¼°æ¨èæ•ˆæœ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
