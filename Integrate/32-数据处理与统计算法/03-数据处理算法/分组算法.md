# PostgreSQL 分组算法完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 分组算法 | 多维分析
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 分组算法完整指南](#postgresql-分组算法完整指南)
  - [📋 目录](#-目录)
  - [分组算法概述](#分组算法概述)
    - [核心分组功能](#核心分组功能)
  - [1. GROUP BY分组](#1-group-by分组)
    - [1.1 单列分组](#11-单列分组)
    - [1.2 多列分组](#12-多列分组)
  - [2. GROUPING SETS](#2-grouping-sets)
    - [2.1 多维度组合](#21-多维度组合)
  - [3. ROLLUP分组](#3-rollup分组)
    - [3.1 层次汇总](#31-层次汇总)
  - [4. CUBE分组](#4-cube分组)
    - [4.1 全维度组合](#41-全维度组合)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 多维度报表](#51-多维度报表)

---

## 分组算法概述

**分组算法**用于将数据按照指定列进行分组，PostgreSQL支持多种分组方式。

### 核心分组功能

| 功能 | 用途 | 复杂度 |
|------|------|--------|
| **GROUP BY** | 单维度分组 | O(n log n) |
| **GROUPING SETS** | 多维度组合 | O(n log n) |
| **ROLLUP** | 层次汇总 | O(n log n) |
| **CUBE** | 全维度组合 | O(2^n) |

---

## 1. GROUP BY分组

### 1.1 单列分组

**单列分组**按照单个列进行分组。

```sql
-- 单列分组（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行单列分组';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行单列分组';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '单列分组准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    COUNT(*) AS count,
    SUM(amount) AS total_amount
FROM sales
GROUP BY category
ORDER BY total_amount DESC;
```

### 1.2 多列分组

**多列分组**按照多个列进行分组。

```sql
-- 多列分组（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行多列分组';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行多列分组';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '多列分组准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    COUNT(*) AS count,
    SUM(amount) AS total_amount
FROM sales
GROUP BY region, category
ORDER BY region, total_amount DESC;
```

---

## 2. GROUPING SETS

### 2.1 多维度组合

**GROUPING SETS**指定多个分组维度组合。

```sql
-- GROUPING SETS多维度组合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行GROUPING SETS';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行GROUPING SETS多维度组合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'GROUPING SETS准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    SUM(amount) AS total_amount
FROM sales
GROUP BY GROUPING SETS (
    (region, category),
    (region),
    (category),
    ()
)
ORDER BY region NULLS LAST, category NULLS LAST;
```

---

## 3. ROLLUP分组

### 3.1 层次汇总

**ROLLUP分组**进行层次汇总，从细到粗。

```sql
-- ROLLUP层次汇总（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行ROLLUP';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行ROLLUP层次汇总';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ROLLUP准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    SUM(amount) AS total_amount
FROM sales
GROUP BY ROLLUP(region, category)
ORDER BY region NULLS LAST, category NULLS LAST;
```

---

## 4. CUBE分组

### 4.1 全维度组合

**CUBE分组**生成所有可能的维度组合。

```sql
-- CUBE全维度组合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行CUBE';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行CUBE全维度组合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'CUBE准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    SUM(amount) AS total_amount
FROM sales
GROUP BY CUBE(region, category)
ORDER BY region NULLS LAST, category NULLS LAST;
```

---

## 5. 实际应用案例

### 5.1 多维度报表

**多维度报表**使用分组生成多维度报表。

```sql
-- 多维度报表（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行多维度报表';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行多维度报表';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '多维度报表准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    DATE_TRUNC('month', sale_date) AS month,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM sales
GROUP BY GROUPING SETS (
    (region, category, DATE_TRUNC('month', sale_date)),
    (region, category),
    (region),
    ()
)
ORDER BY region NULLS LAST, category NULLS LAST, month NULLS LAST;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
