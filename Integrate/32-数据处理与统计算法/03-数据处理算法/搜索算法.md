# PostgreSQL 搜索算法完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 搜索算法 | 查询优化
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 搜索算法完整指南](#postgresql-搜索算法完整指南)
  - [📋 目录](#-目录)
  - [搜索算法概述](#搜索算法概述)
    - [核心搜索功能](#核心搜索功能)
  - [1. 精确搜索](#1-精确搜索)
    - [1.1 等值搜索](#11-等值搜索)
    - [1.2 IN子句搜索](#12-in子句搜索)
  - [2. 范围搜索](#2-范围搜索)
    - [2.1 BETWEEN搜索](#21-between搜索)
  - [3. 模糊搜索](#3-模糊搜索)
    - [3.1 LIKE搜索](#31-like搜索)
    - [3.2 正则表达式搜索](#32-正则表达式搜索)
  - [4. 全文搜索](#4-全文搜索)
    - [4.1 tsvector搜索](#41-tsvector搜索)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 组合搜索](#51-组合搜索)

---

## 搜索算法概述

**搜索算法**用于在数据集中查找特定记录，PostgreSQL支持多种搜索方式。

### 核心搜索功能

| 功能 | 用途 | 复杂度 |
|------|------|--------|
| **精确搜索** | 等值匹配 | O(log n) |
| **范围搜索** | 区间匹配 | O(log n) |
| **模糊搜索** | 模式匹配 | O(n) |
| **全文搜索** | 文本搜索 | O(log n) |

---

## 1. 精确搜索

### 1.1 等值搜索

**等值搜索**使用等号进行精确匹配。

```sql
-- 等值搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING '表 users 不存在，无法执行等值搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行等值搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '等值搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM users
WHERE id = 123;
```

### 1.2 IN子句搜索

**IN子句搜索**在多个值中查找。

```sql
-- IN子句搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING '表 products 不存在，无法执行IN子句搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行IN子句搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'IN子句搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM products
WHERE category_id IN (1, 2, 3, 4, 5);
```

---

## 2. 范围搜索

### 2.1 BETWEEN搜索

**BETWEEN搜索**在范围内查找。

```sql
-- BETWEEN范围搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING '表 orders 不存在，无法执行范围搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行BETWEEN范围搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '范围搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM orders
WHERE order_date BETWEEN '2024-01-01' AND '2024-12-31'
  AND amount BETWEEN 100 AND 1000;
```

---

## 3. 模糊搜索

### 3.1 LIKE搜索

**LIKE搜索**使用通配符进行模式匹配。

```sql
-- LIKE模糊搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING '表 products 不存在，无法执行LIKE搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行LIKE模糊搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'LIKE搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM products
WHERE name LIKE '%keyword%';
```

### 3.2 正则表达式搜索

**正则表达式搜索**使用正则表达式进行模式匹配。

```sql
-- 正则表达式搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING '表 users 不存在，无法执行正则表达式搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行正则表达式搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '正则表达式搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM users
WHERE email ~ '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$';
```

---

## 4. 全文搜索

### 4.1 tsvector搜索

**tsvector搜索**使用全文搜索索引进行文本搜索。

```sql
-- 创建全文搜索索引（带错误处理）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING '表 articles 不存在，无法创建全文搜索索引';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_content_gin') THEN
            RAISE WARNING '索引 idx_articles_content_gin 已存在';
        ELSE
            CREATE INDEX idx_articles_content_gin ON articles USING GIN (to_tsvector('english', content));
            RAISE NOTICE '全文搜索索引 idx_articles_content_gin 创建成功';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION '表 articles 不存在';
        WHEN duplicate_table THEN
            RAISE WARNING '索引 idx_articles_content_gin 已存在';
        WHEN OTHERS THEN
            RAISE EXCEPTION '创建全文搜索索引失败: %', SQLERRM;
    END;
END $$;

-- 全文搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING '表 articles 不存在，无法执行全文搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行全文搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '全文搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM articles
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'keyword & search');
```

---

## 5. 实际应用案例

### 5.1 组合搜索

**组合搜索**结合多种搜索条件。

```sql
-- 组合搜索（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING '表 products 不存在，无法执行组合搜索';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行组合搜索';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '组合搜索准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT *
FROM products
WHERE category_id IN (1, 2, 3)
  AND price BETWEEN 100 AND 500
  AND name LIKE '%keyword%'
ORDER BY price DESC
LIMIT 20;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
