# PostgreSQL 聚合算法完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 聚合算法 | 数据汇总
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 聚合算法完整指南](#postgresql-聚合算法完整指南)
  - [📋 目录](#-目录)
  - [聚合算法概述](#聚合算法概述)
    - [核心聚合函数](#核心聚合函数)
  - [1. 基础聚合函数](#1-基础聚合函数)
    - [1.1 COUNT聚合](#11-count聚合)
    - [1.2 SUM聚合](#12-sum聚合)
  - [2. 分组聚合](#2-分组聚合)
    - [2.1 GROUP BY聚合](#21-group-by聚合)
  - [3. 条件聚合](#3-条件聚合)
    - [3.1 FILTER子句](#31-filter子句)
  - [4. 窗口聚合](#4-窗口聚合)
    - [4.1 窗口函数聚合](#41-窗口函数聚合)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 多维度聚合](#51-多维度聚合)

---

## 聚合算法概述

**聚合算法**用于对数据进行汇总统计，PostgreSQL提供了丰富的聚合函数。

### 核心聚合函数

| 函数名称 | 用途 | 复杂度 |
|---------|------|--------|
| **COUNT()** | 计数 | O(n) |
| **SUM()** | 求和 | O(n) |
| **AVG()** | 平均值 | O(n) |
| **MIN()** | 最小值 | O(n) |
| **MAX()** | 最大值 | O(n) |
| **PERCENTILE_CONT()** | 百分位数 | O(n log n) |

---

## 1. 基础聚合函数

### 1.1 COUNT聚合

**COUNT聚合**用于计算记录数量。

```sql
-- COUNT聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING '表 orders 不存在，无法执行COUNT聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行COUNT聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'COUNT聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) AS total_orders,
    COUNT(DISTINCT customer_id) AS distinct_customers
FROM orders;
```

### 1.2 SUM聚合

**SUM聚合**用于计算数值总和。

```sql
-- SUM聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行SUM聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行SUM聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'SUM聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    SUM(amount) AS total_amount,
    SUM(quantity) AS total_quantity
FROM sales
WHERE amount IS NOT NULL;
```

---

## 2. 分组聚合

### 2.1 GROUP BY聚合

**GROUP BY聚合**按组进行聚合统计。

```sql
-- GROUP BY聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行GROUP BY聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行GROUP BY聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'GROUP BY聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount,
    MIN(amount) AS min_amount,
    MAX(amount) AS max_amount
FROM sales
GROUP BY category
ORDER BY total_amount DESC;
```

---

## 3. 条件聚合

### 3.1 FILTER子句

**FILTER子句**对聚合结果进行条件过滤。

```sql
-- FILTER条件聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING '表 orders 不存在，无法执行FILTER聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行FILTER条件聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'FILTER聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE status = 'completed') AS completed_count,
    SUM(amount) FILTER (WHERE status = 'completed') AS completed_amount,
    COUNT(*) FILTER (WHERE status = 'pending') AS pending_count,
    SUM(amount) FILTER (WHERE status = 'pending') AS pending_amount
FROM orders;
```

---

## 4. 窗口聚合

### 4.1 窗口函数聚合

**窗口函数聚合**在窗口内进行聚合统计。

```sql
-- 窗口函数聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行窗口聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行窗口函数聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '窗口聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_sum_7,
    AVG(amount) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_avg_7,
    SUM(amount) OVER (ORDER BY date) AS cumulative_sum
FROM (
    SELECT DATE_TRUNC('day', sale_date) AS date, SUM(amount) AS amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)
) AS daily_sales
ORDER BY date;
```

---

## 5. 实际应用案例

### 5.1 多维度聚合

**多维度聚合**使用ROLLUP进行层次汇总。

```sql
-- 多维度聚合ROLLUP（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行多维度聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行多维度聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '多维度聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    COUNT(*) AS count,
    SUM(amount) AS total_amount
FROM sales
GROUP BY ROLLUP(region, category)
ORDER BY region, category;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
