# PostgreSQL æ—¶é—´åºåˆ—é¢„æµ‹å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ—¶é—´åºåˆ—é¢„æµ‹ | è¶‹åŠ¿é¢„æµ‹
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ—¶é—´åºåˆ—é¢„æµ‹å®Œæ•´æŒ‡å—](#postgresql-æ—¶é—´åºåˆ—é¢„æµ‹å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ—¶é—´åºåˆ—é¢„æµ‹æ¦‚è¿°](#æ—¶é—´åºåˆ—é¢„æµ‹æ¦‚è¿°)
    - [æ ¸å¿ƒé¢„æµ‹æ–¹æ³•](#æ ¸å¿ƒé¢„æµ‹æ–¹æ³•)
  - [1. çº¿æ€§è¶‹åŠ¿é¢„æµ‹](#1-çº¿æ€§è¶‹åŠ¿é¢„æµ‹)
    - [1.1 çº¿æ€§å›å½’é¢„æµ‹](#11-çº¿æ€§å›å½’é¢„æµ‹)
  - [2. æŒ‡æ•°å¹³æ»‘é¢„æµ‹](#2-æŒ‡æ•°å¹³æ»‘é¢„æµ‹)
    - [2.1 å•æŒ‡æ•°å¹³æ»‘](#21-å•æŒ‡æ•°å¹³æ»‘)
  - [3. ç§»åŠ¨å¹³å‡é¢„æµ‹](#3-ç§»åŠ¨å¹³å‡é¢„æµ‹)
    - [3.1 ç§»åŠ¨å¹³å‡é¢„æµ‹](#31-ç§»åŠ¨å¹³å‡é¢„æµ‹)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 é”€å”®é¢„æµ‹](#41-é”€å”®é¢„æµ‹)

---

## æ—¶é—´åºåˆ—é¢„æµ‹æ¦‚è¿°

**æ—¶é—´åºåˆ—é¢„æµ‹**åŸºäºå†å²æ•°æ®é¢„æµ‹æœªæ¥è¶‹åŠ¿ï¼ŒPostgreSQLå¯ä»¥é€šè¿‡SQLå®ç°ç®€å•çš„é¢„æµ‹ç®—æ³•ã€‚

### æ ¸å¿ƒé¢„æµ‹æ–¹æ³•

| æ–¹æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **çº¿æ€§å›å½’** | è¶‹åŠ¿é¢„æµ‹ | O(n) |
| **æŒ‡æ•°å¹³æ»‘** | çŸ­æœŸé¢„æµ‹ | O(n) |
| **ç§»åŠ¨å¹³å‡** | å¹³æ»‘é¢„æµ‹ | O(n) |

---

## 1. çº¿æ€§è¶‹åŠ¿é¢„æµ‹

### 1.1 çº¿æ€§å›å½’é¢„æµ‹

**çº¿æ€§è¶‹åŠ¿é¢„æµ‹**ä½¿ç”¨çº¿æ€§å›å½’é¢„æµ‹æœªæ¥å€¼ã€‚

```sql
-- çº¿æ€§è¶‹åŠ¿é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slope NUMERIC;
    intercept NUMERIC;
    n_val BIGINT;
    avg_x NUMERIC;
    avg_y NUMERIC;
    sum_xy NUMERIC;
    sum_x2 NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING 'è¡¨ time_series ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œçº¿æ€§è¶‹åŠ¿é¢„æµ‹';
            RETURN;
        END IF;

        SELECT
            COUNT(*),
            AVG(EXTRACT(EPOCH FROM date)),
            AVG(value),
            SUM(EXTRACT(EPOCH FROM date) * value),
            SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date))
        INTO n_val, avg_x, avg_y, sum_xy, sum_x2
        FROM time_series
        WHERE value IS NOT NULL;

        slope := (sum_xy - n_val * avg_x * avg_y) / NULLIF(sum_x2 - n_val * avg_x * avg_x, 0);
        intercept := avg_y - slope * avg_x;

        RAISE NOTICE 'çº¿æ€§å›å½’å‚æ•°:';
        RAISE NOTICE '  æ–œç‡: %', slope;
        RAISE NOTICE '  æˆªè·: %', intercept;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'çº¿æ€§è¶‹åŠ¿é¢„æµ‹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é¢„æµ‹æœªæ¥å€¼
WITH regression AS (
    SELECT
        (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) AS slope,
        avg_y - (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) * avg_x AS intercept
    FROM (
        SELECT
            COUNT(*) AS n,
            AVG(EXTRACT(EPOCH FROM date)) AS avg_x,
            AVG(value) AS avg_y,
            SUM(EXTRACT(EPOCH FROM date) * value) AS sum_xy,
            SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date)) AS sum_x2
        FROM time_series
        WHERE value IS NOT NULL
    ) AS stats
),
future_dates AS (
    SELECT generate_series(
        (SELECT MAX(date) FROM time_series) + INTERVAL '1 day',
        (SELECT MAX(date) FROM time_series) + INTERVAL '30 days',
        '1 day'::interval
    )::date AS date
)
SELECT
    fd.date,
    r.slope * EXTRACT(EPOCH FROM fd.date) + r.intercept AS predicted_value
FROM future_dates fd
CROSS JOIN regression r
ORDER BY fd.date;
```

---

## 2. æŒ‡æ•°å¹³æ»‘é¢„æµ‹

### 2.1 å•æŒ‡æ•°å¹³æ»‘

**å•æŒ‡æ•°å¹³æ»‘**ä½¿ç”¨æŒ‡æ•°åŠ æƒè¿›è¡Œé¢„æµ‹ã€‚

```sql
-- å•æŒ‡æ•°å¹³æ»‘é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    alpha NUMERIC := 0.3;
    last_value NUMERIC;
    last_smoothed NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING 'è¡¨ time_series ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŒ‡æ•°å¹³æ»‘é¢„æµ‹';
            RETURN;
        END IF;

        SELECT value INTO last_value
        FROM time_series
        ORDER BY date DESC
        LIMIT 1;

        RAISE NOTICE 'æŒ‡æ•°å¹³æ»‘é¢„æµ‹ï¼Œå¹³æ»‘ç³»æ•°: %, æœ€åå€¼: %', alpha, last_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŒ‡æ•°å¹³æ»‘é¢„æµ‹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH smoothed_values AS (
    SELECT
        date,
        value,
        value AS smoothed,
        0.3 AS alpha
    FROM time_series
    WHERE date = (SELECT MIN(date) FROM time_series)
    UNION ALL
    SELECT
        t.date,
        t.value,
        s.smoothed * (1 - s.alpha) + t.value * s.alpha AS smoothed,
        s.alpha
    FROM time_series t
    JOIN smoothed_values s ON t.date = s.date + INTERVAL '1 day'
)
SELECT * FROM smoothed_values ORDER BY date;
```

---

## 3. ç§»åŠ¨å¹³å‡é¢„æµ‹

### 3.1 ç§»åŠ¨å¹³å‡é¢„æµ‹

**ç§»åŠ¨å¹³å‡é¢„æµ‹**ä½¿ç”¨ç§»åŠ¨å¹³å‡è¿›è¡Œé¢„æµ‹ã€‚

```sql
-- ç§»åŠ¨å¹³å‡é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    window_size INTEGER := 7;
    last_avg NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING 'è¡¨ time_series ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç§»åŠ¨å¹³å‡é¢„æµ‹';
            RETURN;
        END IF;

        SELECT AVG(value) INTO last_avg
        FROM (
            SELECT value
            FROM time_series
            ORDER BY date DESC
            LIMIT window_size
        ) AS recent_values;

        RAISE NOTICE 'ç§»åŠ¨å¹³å‡é¢„æµ‹ï¼Œçª—å£å¤§å°: %, é¢„æµ‹å€¼: %', window_size, last_avg;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç§»åŠ¨å¹³å‡é¢„æµ‹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH recent_avg AS (
    SELECT AVG(value) AS avg_value
    FROM (
        SELECT value
        FROM time_series
        ORDER BY date DESC
        LIMIT 7
    ) AS recent
),
future_dates AS (
    SELECT generate_series(
        (SELECT MAX(date) FROM time_series) + INTERVAL '1 day',
        (SELECT MAX(date) FROM time_series) + INTERVAL '7 days',
        '1 day'::interval
    )::date AS date
)
SELECT
    fd.date,
    ra.avg_value AS predicted_value
FROM future_dates fd
CROSS JOIN recent_avg ra
ORDER BY fd.date;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 é”€å”®é¢„æµ‹

**é”€å”®é¢„æµ‹**é¢„æµ‹æœªæ¥é”€å”®è¶‹åŠ¿ã€‚

```sql
-- é”€å”®é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING 'è¡¨ sales ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé”€å”®é¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé”€å”®é¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é”€å”®é¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH daily_sales AS (
    SELECT
        DATE_TRUNC('day', sale_date) AS date,
        SUM(amount) AS daily_amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)
),
regression AS (
    SELECT
        (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) AS slope,
        avg_y - (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) * avg_x AS intercept
    FROM (
        SELECT
            COUNT(*) AS n,
            AVG(EXTRACT(EPOCH FROM date)) AS avg_x,
            AVG(daily_amount) AS avg_y,
            SUM(EXTRACT(EPOCH FROM date) * daily_amount) AS sum_xy,
            SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date)) AS sum_x2
        FROM daily_sales
    ) AS stats
),
future_dates AS (
    SELECT generate_series(
        (SELECT MAX(date) FROM daily_sales) + INTERVAL '1 day',
        (SELECT MAX(date) FROM daily_sales) + INTERVAL '30 days',
        '1 day'::interval
    )::date AS date
)
SELECT
    fd.date,
    GREATEST(0, r.slope * EXTRACT(EPOCH FROM fd.date) + r.intercept) AS predicted_sales
FROM future_dates fd
CROSS JOIN regression r
ORDER BY fd.date;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
