# PostgreSQL 趋势分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 趋势分析 | 趋势识别
> **难度级别**: ⭐⭐⭐⭐ (高级)

---

## 📋 目录

- [PostgreSQL 趋势分析完整指南](#postgresql-趋势分析完整指南)
  - [📋 目录](#-目录)
  - [趋势分析概述](#趋势分析概述)
    - [核心趋势类型](#核心趋势类型)
  - [1. 线性趋势分析](#1-线性趋势分析)
    - [1.1 趋势斜率计算](#11-趋势斜率计算)
  - [2. 非线性趋势分析](#2-非线性趋势分析)
    - [2.1 多项式趋势](#21-多项式趋势)
  - [3. 趋势强度分析](#3-趋势强度分析)
    - [3.1 趋势强度计算](#31-趋势强度计算)
  - [4. 实际应用案例](#4-实际应用案例)
    - [4.1 业务指标趋势分析](#41-业务指标趋势分析)

---

## 趋势分析概述

**趋势分析**识别时间序列数据的长期趋势，用于理解数据的变化方向。

### 核心趋势类型

| 趋势类型 | 特征 | 识别方法 |
|---------|------|---------|
| **上升趋势** | 持续增长 | 线性回归斜率>0 |
| **下降趋势** | 持续下降 | 线性回归斜率<0 |
| **平稳趋势** | 无明显变化 | 线性回归斜率≈0 |

---

## 1. 线性趋势分析

### 1.1 趋势斜率计算

**线性趋势分析**使用线性回归计算趋势斜率。

```sql
-- 线性趋势分析（带错误处理和性能测试）
DO $$
DECLARE
    slope NUMERIC;
    intercept NUMERIC;
    correlation NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING '表 time_series 不存在，无法执行线性趋势分析';
            RETURN;
        END IF;

        WITH stats AS (
            SELECT
                COUNT(*) AS n,
                AVG(EXTRACT(EPOCH FROM date)) AS avg_x,
                AVG(value) AS avg_y,
                SUM(EXTRACT(EPOCH FROM date) * value) AS sum_xy,
                SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date)) AS sum_x2,
                SUM(value * value) AS sum_y2
            FROM time_series
            WHERE value IS NOT NULL
        )
        SELECT
            (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) AS slope_val,
            avg_y - (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) * avg_x AS intercept_val,
            (sum_xy - n * avg_x * avg_y) / NULLIF(SQRT((sum_x2 - n * avg_x * avg_x) * (sum_y2 - n * avg_y * avg_y)), 0) AS corr_val
        INTO slope, intercept, correlation
        FROM stats;

        RAISE NOTICE '线性趋势分析结果:';
        RAISE NOTICE '  斜率: %', slope;
        RAISE NOTICE '  截距: %', intercept;
        RAISE NOTICE '  相关系数: %', correlation;
        RAISE NOTICE '  趋势方向: %', CASE WHEN slope > 0 THEN '上升' WHEN slope < 0 THEN '下降' ELSE '平稳' END;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '线性趋势分析失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 可视化趋势
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH regression AS (
    SELECT
        (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) AS slope,
        avg_y - (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) * avg_x AS intercept
    FROM (
        SELECT
            COUNT(*) AS n,
            AVG(EXTRACT(EPOCH FROM date)) AS avg_x,
            AVG(value) AS avg_y,
            SUM(EXTRACT(EPOCH FROM date) * value) AS sum_xy,
            SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date)) AS sum_x2
        FROM time_series
        WHERE value IS NOT NULL
    ) AS stats
)
SELECT
    ts.date,
    ts.value AS actual_value,
    r.slope * EXTRACT(EPOCH FROM ts.date) + r.intercept AS trend_value,
    ts.value - (r.slope * EXTRACT(EPOCH FROM ts.date) + r.intercept) AS residual
FROM time_series ts
CROSS JOIN regression r
WHERE ts.value IS NOT NULL
ORDER BY ts.date;
```

---

## 2. 非线性趋势分析

### 2.1 多项式趋势

**非线性趋势分析**识别非线性趋势模式。

```sql
-- 非线性趋势分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING '表 time_series 不存在，无法执行非线性趋势分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行非线性趋势分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '非线性趋势分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 使用移动平均识别非线性趋势
SELECT
    date,
    value,
    AVG(value) OVER (
        ORDER BY date
        ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
    ) AS trend_30,
    AVG(value) OVER (
        ORDER BY date
        ROWS BETWEEN 89 PRECEDING AND CURRENT ROW
    ) AS trend_90
FROM time_series
ORDER BY date;
```

---

## 3. 趋势强度分析

### 3.1 趋势强度计算

**趋势强度分析**评估趋势的强度和可靠性。

```sql
-- 趋势强度分析（带错误处理和性能测试）
DO $$
DECLARE
    r_squared NUMERIC;
    trend_strength TEXT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING '表 time_series 不存在，无法执行趋势强度分析';
            RETURN;
        END IF;

        WITH regression AS (
            SELECT
                (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) AS slope,
                avg_y - (sum_xy - n * avg_x * avg_y) / NULLIF(sum_x2 - n * avg_x * avg_x, 0) * avg_x AS intercept,
                avg_y AS mean_y
            FROM (
                SELECT
                    COUNT(*) AS n,
                    AVG(EXTRACT(EPOCH FROM date)) AS avg_x,
                    AVG(value) AS avg_y,
                    SUM(EXTRACT(EPOCH FROM date) * value) AS sum_xy,
                    SUM(EXTRACT(EPOCH FROM date) * EXTRACT(EPOCH FROM date)) AS sum_x2
                FROM time_series
                WHERE value IS NOT NULL
            ) AS stats
        ),
        residuals AS (
            SELECT
                POWER(ts.value - (r.slope * EXTRACT(EPOCH FROM ts.date) + r.intercept), 2) AS residual_sq,
                POWER(ts.value - r.mean_y, 2) AS total_sq
            FROM time_series ts
            CROSS JOIN regression r
            WHERE ts.value IS NOT NULL
        )
        SELECT
            1 - SUM(residual_sq) / NULLIF(SUM(total_sq), 0) INTO r_squared
        FROM residuals;

        trend_strength := CASE
            WHEN r_squared > 0.7 THEN '强趋势'
            WHEN r_squared > 0.4 THEN '中等趋势'
            WHEN r_squared > 0.1 THEN '弱趋势'
            ELSE '无趋势'
        END;

        RAISE NOTICE '趋势强度分析结果:';
        RAISE NOTICE '  R²: %', r_squared;
        RAISE NOTICE '  趋势强度: %', trend_strength;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '趋势强度分析失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. 实际应用案例

### 4.1 业务指标趋势分析

**业务指标趋势分析**分析业务指标的趋势变化。

```sql
-- 业务指标趋势分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_metrics') THEN
            RAISE WARNING '表 business_metrics 不存在，无法执行业务指标趋势分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行业务指标趋势分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '业务指标趋势分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH daily_metrics AS (
    SELECT
        DATE_TRUNC('day', metric_date) AS date,
        metric_name,
        AVG(metric_value) AS daily_avg
    FROM business_metrics
    GROUP BY DATE_TRUNC('day', metric_date), metric_name
),
trend_analysis AS (
    SELECT
        metric_name,
        date,
        daily_avg,
        AVG(daily_avg) OVER (
            PARTITION BY metric_name
            ORDER BY date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS short_trend,
        AVG(daily_avg) OVER (
            PARTITION BY metric_name
            ORDER BY date
            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
        ) AS long_trend
    FROM daily_metrics
)
SELECT
    metric_name,
    date,
    daily_avg,
    short_trend,
    long_trend,
    CASE
        WHEN daily_avg > short_trend * 1.1 THEN '快速上升'
        WHEN daily_avg > short_trend THEN '上升'
        WHEN daily_avg < short_trend * 0.9 THEN '快速下降'
        WHEN daily_avg < short_trend THEN '下降'
        ELSE '平稳'
    END AS trend_direction
FROM trend_analysis
ORDER BY metric_name, date;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
