# PostgreSQL 周期性分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 周期性分析 | 季节分解
> **难度级别**: ⭐⭐⭐⭐ (高级)

---

## 📋 目录

- [PostgreSQL 周期性分析完整指南](#postgresql-周期性分析完整指南)
  - [📋 目录](#-目录)
  - [周期性分析概述](#周期性分析概述)
    - [核心周期类型](#核心周期类型)
  - [1. 日周期分析](#1-日周期分析)
    - [1.1 小时模式分析](#11-小时模式分析)
  - [2. 周周期分析](#2-周周期分析)
    - [2.1 星期模式分析](#21-星期模式分析)
  - [3. 月周期分析](#3-月周期分析)
    - [3.1 月份模式分析](#31-月份模式分析)
  - [4. 季节分解](#4-季节分解)
    - [4.1 季节性分解](#41-季节性分解)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 多周期综合分析](#51-多周期综合分析)

---

## 周期性分析概述

**周期性分析**识别时间序列数据中的周期性规律，用于理解数据的周期性模式。

### 核心周期类型

| 周期类型 | 用途 | 复杂度 |
|---------|------|--------|
| **日周期** | 日内模式 | O(n) |
| **周周期** | 周内模式 | O(n) |
| **月周期** | 月内模式 | O(n) |
| **季节周期** | 季节性模式 | O(n) |

---

## 1. 日周期分析

### 1.1 小时模式分析

**日周期分析**分析一天内的周期性模式。

```sql
-- 日周期分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'metrics') THEN
            RAISE WARNING '表 metrics 不存在，无法执行日周期分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行日周期分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '日周期分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    EXTRACT(HOUR FROM timestamp) AS hour_of_day,
    COUNT(*) AS count,
    AVG(value) AS avg_value,
    STDDEV(value) AS stddev_value,
    MIN(value) AS min_value,
    MAX(value) AS max_value
FROM metrics
GROUP BY EXTRACT(HOUR FROM timestamp)
ORDER BY hour_of_day;
```

---

## 2. 周周期分析

### 2.1 星期模式分析

**周周期分析**分析一周内的周期性模式。

```sql
-- 周周期分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行周周期分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行周周期分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '周周期分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    EXTRACT(DOW FROM sale_date) AS day_of_week,
    CASE EXTRACT(DOW FROM sale_date)
        WHEN 0 THEN 'Sunday'
        WHEN 1 THEN 'Monday'
        WHEN 2 THEN 'Tuesday'
        WHEN 3 THEN 'Wednesday'
        WHEN 4 THEN 'Thursday'
        WHEN 5 THEN 'Friday'
        WHEN 6 THEN 'Saturday'
    END AS day_name,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM sales
GROUP BY EXTRACT(DOW FROM sale_date)
ORDER BY day_of_week;
```

---

## 3. 月周期分析

### 3.1 月份模式分析

**月周期分析**分析月份内的周期性模式。

```sql
-- 月周期分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行月周期分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行月周期分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '月周期分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    EXTRACT(DAY FROM sale_date) AS day_of_month,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM sales
GROUP BY EXTRACT(DAY FROM sale_date)
ORDER BY day_of_month;
```

---

## 4. 季节分解

### 4.1 季节性分解

**季节分解**将时间序列分解为趋势、季节性和残差。

```sql
-- 季节分解（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING '表 time_series 不存在，无法执行季节分解';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行季节分解';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '季节分解准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH monthly_data AS (
    SELECT
        DATE_TRUNC('month', date) AS month,
        AVG(value) AS monthly_avg
    FROM time_series
    GROUP BY DATE_TRUNC('month', date)
),
trend AS (
    SELECT
        month,
        monthly_avg,
        AVG(monthly_avg) OVER (
            ORDER BY month
            ROWS BETWEEN 5 PRECEDING AND 5 FOLLOWING
        ) AS trend_value
    FROM monthly_data
),
seasonal AS (
    SELECT
        EXTRACT(MONTH FROM month) AS month_num,
        AVG(monthly_avg - trend_value) AS seasonal_component
    FROM trend
    GROUP BY EXTRACT(MONTH FROM month)
)
SELECT
    t.month,
    t.monthly_avg AS original_value,
    t.trend_value,
    s.seasonal_component,
    t.monthly_avg - t.trend_value - s.seasonal_component AS residual
FROM trend t
JOIN seasonal s ON EXTRACT(MONTH FROM t.month) = s.month_num
ORDER BY t.month;
```

---

## 5. 实际应用案例

### 5.1 多周期综合分析

**多周期综合分析**同时分析多个周期模式。

```sql
-- 多周期综合分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'metrics') THEN
            RAISE WARNING '表 metrics 不存在，无法执行多周期综合分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行多周期综合分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '多周期综合分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    EXTRACT(DOW FROM timestamp) AS day_of_week,
    EXTRACT(HOUR FROM timestamp) AS hour_of_day,
    COUNT(*) AS count,
    AVG(value) AS avg_value,
    STDDEV(value) AS stddev_value
FROM metrics
GROUP BY EXTRACT(DOW FROM timestamp), EXTRACT(HOUR FROM timestamp)
ORDER BY day_of_week, hour_of_day;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
