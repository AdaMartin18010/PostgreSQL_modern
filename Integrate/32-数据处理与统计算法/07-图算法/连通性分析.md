# PostgreSQL è¿é€šæ€§åˆ†æå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | è¿é€šæ€§åˆ†æ | å¼ºè¿é€šåˆ†é‡
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL è¿é€šæ€§åˆ†æå®Œæ•´æŒ‡å—](#postgresql-è¿é€šæ€§åˆ†æå®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [è¿é€šæ€§åˆ†ææ¦‚è¿°](#è¿é€šæ€§åˆ†ææ¦‚è¿°)
    - [æ ¸å¿ƒè¿é€šæ€§æ¦‚å¿µ](#æ ¸å¿ƒè¿é€šæ€§æ¦‚å¿µ)
  - [1. è¿é€šåˆ†é‡æ£€æµ‹](#1-è¿é€šåˆ†é‡æ£€æµ‹)
    - [1.1 æ— å‘å›¾è¿é€šåˆ†é‡](#11-æ— å‘å›¾è¿é€šåˆ†é‡)
  - [2. å¼ºè¿é€šåˆ†é‡](#2-å¼ºè¿é€šåˆ†é‡)
    - [2.1 æœ‰å‘å›¾å¼ºè¿é€šåˆ†é‡](#21-æœ‰å‘å›¾å¼ºè¿é€šåˆ†é‡)
  - [3. å¼±è¿é€šåˆ†é‡](#3-å¼±è¿é€šåˆ†é‡)
    - [3.1 æœ‰å‘å›¾å¼±è¿é€šåˆ†é‡](#31-æœ‰å‘å›¾å¼±è¿é€šåˆ†é‡)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ](#41-ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ)

---

## è¿é€šæ€§åˆ†ææ¦‚è¿°

**è¿é€šæ€§åˆ†æ**ç”¨äºåˆ†æå›¾ä¸­èŠ‚ç‚¹çš„è¿é€šæ€§ï¼Œè¯†åˆ«è¿é€šåˆ†é‡å’Œå­¤ç«‹èŠ‚ç‚¹ã€‚

### æ ¸å¿ƒè¿é€šæ€§æ¦‚å¿µ

| æ¦‚å¿µ | å®šä¹‰ | ç”¨é€” |
|------|------|------|
| **è¿é€šåˆ†é‡** | ç›¸äº’å¯è¾¾çš„èŠ‚ç‚¹é›†åˆ | è¯†åˆ«å­å›¾ |
| **å¼ºè¿é€š** | åŒå‘å¯è¾¾ | æœ‰å‘å›¾åˆ†æ |
| **å¼±è¿é€š** | å¿½ç•¥æ–¹å‘å¯è¾¾ | æœ‰å‘å›¾åˆ†æ |

---

## 1. è¿é€šåˆ†é‡æ£€æµ‹

### 1.1 æ— å‘å›¾è¿é€šåˆ†é‡

**è¿é€šåˆ†é‡æ£€æµ‹**è¯†åˆ«æ— å‘å›¾ä¸­çš„è¿é€šåˆ†é‡ã€‚

```sql
-- è¿é€šåˆ†é‡æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè¿é€šåˆ†é‡æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¿é€šåˆ†é‡æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE connected_components AS (
    SELECT
        id AS node_id,
        id AS component_id
    FROM nodes
    UNION
    SELECT
        e.target_id,
        cc.component_id
    FROM connected_components cc
    JOIN edges e ON cc.node_id = e.source_id
    UNION
    SELECT
        e.source_id,
        cc.component_id
    FROM connected_components cc
    JOIN edges e ON cc.node_id = e.target_id
)
SELECT
    component_id,
    COUNT(DISTINCT node_id) AS component_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS nodes
FROM connected_components
GROUP BY component_id
ORDER BY component_size DESC;
```

---

## 2. å¼ºè¿é€šåˆ†é‡

### 2.1 æœ‰å‘å›¾å¼ºè¿é€šåˆ†é‡

**å¼ºè¿é€šåˆ†é‡**è¯†åˆ«æœ‰å‘å›¾ä¸­çš„å¼ºè¿é€šåˆ†é‡ã€‚

```sql
-- å¼ºè¿é€šåˆ†é‡æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¼ºè¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¼ºè¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¼ºè¿é€šåˆ†é‡æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼ºè¿é€šåˆ†é‡æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE forward_reachable AS (
    SELECT
        id AS node_id,
        id AS root_id
    FROM nodes
    UNION
    SELECT
        e.target_id,
        fr.root_id
    FROM forward_reachable fr
    JOIN edges e ON fr.node_id = e.source_id
),
backward_reachable AS (
    SELECT
        id AS node_id,
        id AS root_id
    FROM nodes
    UNION
    SELECT
        e.source_id,
        br.root_id
    FROM backward_reachable br
    JOIN edges e ON br.node_id = e.target_id
)
SELECT
    fr.root_id AS component_id,
    COUNT(DISTINCT fr.node_id) AS component_size
FROM forward_reachable fr
JOIN backward_reachable br ON fr.node_id = br.node_id AND fr.root_id = br.root_id
GROUP BY fr.root_id
ORDER BY component_size DESC;
```

---

## 3. å¼±è¿é€šåˆ†é‡

### 3.1 æœ‰å‘å›¾å¼±è¿é€šåˆ†é‡

**å¼±è¿é€šåˆ†é‡**å¿½ç•¥è¾¹çš„æ–¹å‘è¯†åˆ«è¿é€šåˆ†é‡ã€‚

```sql
-- å¼±è¿é€šåˆ†é‡æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¼±è¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¼±è¿é€šåˆ†é‡æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå¼±è¿é€šåˆ†é‡æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼±è¿é€šåˆ†é‡æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE weak_components AS (
    SELECT
        id AS node_id,
        id AS component_id
    FROM nodes
    UNION
    SELECT
        e.target_id,
        wc.component_id
    FROM weak_components wc
    JOIN edges e ON wc.node_id = e.source_id
    UNION
    SELECT
        e.source_id,
        wc.component_id
    FROM weak_components wc
    JOIN edges e ON wc.node_id = e.target_id
)
SELECT
    component_id,
    COUNT(DISTINCT node_id) AS component_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS nodes
FROM weak_components
GROUP BY component_id
ORDER BY component_size DESC;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ

**ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ**åˆ†æç¤¾äº¤ç½‘ç»œçš„è¿é€šæ€§ã€‚

```sql
-- ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'friendships') THEN
            RAISE WARNING 'è¡¨ friendships ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¤¾äº¤ç½‘ç»œè¿é€šæ€§åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE social_components AS (
    SELECT
        user_id AS node_id,
        user_id AS component_id
    FROM users
    UNION
    SELECT
        f.friend_id,
        sc.component_id
    FROM social_components sc
    JOIN friendships f ON sc.node_id = f.user_id
    UNION
    SELECT
        f.user_id,
        sc.component_id
    FROM social_components sc
    JOIN friendships f ON sc.node_id = f.friend_id
)
SELECT
    component_id,
    COUNT(DISTINCT node_id) AS community_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS members
FROM social_components
GROUP BY component_id
HAVING COUNT(DISTINCT node_id) > 1
ORDER BY community_size DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
