# PostgreSQL å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å›¾èšç±» | ç¤¾åŒºæ£€æµ‹
> **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å›¾èšç±»ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å›¾èšç±»ç®—æ³•æ¦‚è¿°](#å›¾èšç±»ç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒèšç±»æ–¹æ³•](#æ ¸å¿ƒèšç±»æ–¹æ³•)
  - [1. æ¨¡å—åº¦ä¼˜åŒ–](#1-æ¨¡å—åº¦ä¼˜åŒ–)
    - [1.1 æ¨¡å—åº¦è®¡ç®—](#11-æ¨¡å—åº¦è®¡ç®—)
  - [2. ç¤¾åŒºæ£€æµ‹](#2-ç¤¾åŒºæ£€æµ‹)
    - [2.1 ç®€å•ç¤¾åŒºæ£€æµ‹](#21-ç®€å•ç¤¾åŒºæ£€æµ‹)
  - [3. èšç±»è¯„ä¼°](#3-èšç±»è¯„ä¼°)
    - [3.1 èšç±»è´¨é‡è¯„ä¼°](#31-èšç±»è´¨é‡è¯„ä¼°)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹](#41-æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹)

---

## å›¾èšç±»ç®—æ³•æ¦‚è¿°

**å›¾èšç±»ç®—æ³•**ç”¨äºè¯†åˆ«å›¾ä¸­çš„ç¤¾åŒºç»“æ„ï¼Œå°†ç´§å¯†è¿æ¥çš„èŠ‚ç‚¹åˆ†ç»„ã€‚

### æ ¸å¿ƒèšç±»æ–¹æ³•

| æ–¹æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **æ¨¡å—åº¦ä¼˜åŒ–** | ç¤¾åŒºè´¨é‡è¯„ä¼° | O(VÂ²) |
| **Louvainç®—æ³•** | ç¤¾åŒºæ£€æµ‹ | O(V log V) |
| **æ ‡ç­¾ä¼ æ’­** | å¿«é€Ÿèšç±» | O(V+E) |

---

## 1. æ¨¡å—åº¦ä¼˜åŒ–

### 1.1 æ¨¡å—åº¦è®¡ç®—

**æ¨¡å—åº¦**è¡¡é‡ç¤¾åŒºåˆ’åˆ†çš„è´¨é‡ã€‚

```sql
-- æ¨¡å—åº¦è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    modularity_score NUMERIC;
    total_edges BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ¨¡å—åº¦';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'node_communities') THEN
            RAISE WARNING 'è¡¨ node_communities ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ¨¡å—åº¦';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO total_edges FROM edges;

        WITH community_edges AS (
            SELECT
                nc1.community_id,
                COUNT(*) AS internal_edges,
                (SELECT COUNT(*) FROM node_communities WHERE community_id = nc1.community_id) AS community_size
            FROM edges e
            JOIN node_communities nc1 ON e.source_id = nc1.node_id
            JOIN node_communities nc2 ON e.target_id = nc2.node_id
            WHERE nc1.community_id = nc2.community_id
            GROUP BY nc1.community_id
        )
        SELECT
            SUM(internal_edges::NUMERIC / NULLIF(total_edges, 0) - POWER(community_size::NUMERIC / NULLIF((SELECT COUNT(*) FROM node_communities), 0), 2))
        INTO modularity_score
        FROM community_edges;

        RAISE NOTICE 'æ¨¡å—åº¦: % (èŒƒå›´: -1åˆ°1ï¼Œè¶Šå¤§è¶Šå¥½)', modularity_score;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨¡å—åº¦è®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 2. ç¤¾åŒºæ£€æµ‹

### 2.1 ç®€å•ç¤¾åŒºæ£€æµ‹

**ç¤¾åŒºæ£€æµ‹**è¯†åˆ«å›¾ä¸­çš„ç¤¾åŒºç»“æ„ã€‚

```sql
-- ç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'nodes') THEN
            RAISE WARNING 'è¡¨ nodes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'edges') THEN
            RAISE WARNING 'è¡¨ edges ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH RECURSIVE communities AS (
    SELECT
        id AS node_id,
        id AS community_id
    FROM nodes
    UNION
    SELECT
        e.target_id,
        c.community_id
    FROM communities c
    JOIN edges e ON c.node_id = e.source_id
    WHERE (
        SELECT COUNT(*)
        FROM edges e2
        WHERE e2.source_id = e.target_id
          AND e2.target_id IN (SELECT node_id FROM communities WHERE community_id = c.community_id)
    ) > (
        SELECT COUNT(*)
        FROM edges e3
        WHERE e3.source_id = e.target_id
          AND e3.target_id NOT IN (SELECT node_id FROM communities WHERE community_id = c.community_id)
    )
)
SELECT
    community_id,
    COUNT(DISTINCT node_id) AS community_size,
    array_agg(DISTINCT node_id ORDER BY node_id) AS members
FROM communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

## 3. èšç±»è¯„ä¼°

### 3.1 èšç±»è´¨é‡è¯„ä¼°

**èšç±»è¯„ä¼°**è¯„ä¼°èšç±»ç»“æœçš„è´¨é‡ã€‚

```sql
-- èšç±»è´¨é‡è¯„ä¼°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    avg_cluster_size NUMERIC;
    cluster_count INTEGER;
    total_nodes BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'node_communities') THEN
            RAISE WARNING 'è¡¨ node_communities ä¸å­˜åœ¨ï¼Œæ— æ³•è¯„ä¼°èšç±»è´¨é‡';
            RETURN;
        END IF;

        SELECT
            COUNT(DISTINCT community_id),
            COUNT(DISTINCT node_id),
            AVG(community_size)
        INTO cluster_count, total_nodes, avg_cluster_size
        FROM (
            SELECT
                community_id,
                COUNT(*) AS community_size
            FROM node_communities
            GROUP BY community_id
        ) AS cluster_sizes;

        RAISE NOTICE 'èšç±»è´¨é‡è¯„ä¼°:';
        RAISE NOTICE '  èšç±»æ•°é‡: %', cluster_count;
        RAISE NOTICE '  æ€»èŠ‚ç‚¹æ•°: %', total_nodes;
        RAISE NOTICE '  å¹³å‡èšç±»å¤§å°: %', avg_cluster_size;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'èšç±»è´¨é‡è¯„ä¼°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    community_id,
    COUNT(*) AS community_size,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS size_percentage
FROM node_communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹

**æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹**è¯†åˆ«ç”¨æˆ·ç¤¾åŒºç”¨äºæ¨èã€‚

```sql
-- æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_interactions') THEN
            RAISE WARNING 'è¡¨ user_interactions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¨èç³»ç»Ÿç¤¾åŒºæ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH user_similarity AS (
    SELECT
        u1.user_id AS user1,
        u2.user_id AS user2,
        COUNT(DISTINCT u1.item_id) AS common_items
    FROM user_interactions u1
    JOIN user_interactions u2 ON u1.item_id = u2.item_id
    WHERE u1.user_id < u2.user_id
    GROUP BY u1.user_id, u2.user_id
    HAVING COUNT(DISTINCT u1.item_id) >= 5  -- æœ€å°ç›¸ä¼¼åº¦é˜ˆå€¼
),
user_communities AS (
    SELECT
        user1 AS user_id,
        user1 AS community_id
    FROM user_similarity
    UNION
    SELECT
        user2,
        uc.community_id
    FROM user_communities uc
    JOIN user_similarity us ON uc.user_id = us.user1
    WHERE us.user2 NOT IN (SELECT user_id FROM user_communities WHERE community_id = uc.community_id)
)
SELECT
    community_id,
    COUNT(DISTINCT user_id) AS community_size
FROM user_communities
GROUP BY community_id
ORDER BY community_size DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
