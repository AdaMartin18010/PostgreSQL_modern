# PostgreSQL èµ„æºä¼˜åŒ–ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | èµ„æºä¼˜åŒ– | æˆæœ¬ä¼˜åŒ–
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL èµ„æºä¼˜åŒ–ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-èµ„æºä¼˜åŒ–ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [èµ„æºä¼˜åŒ–æ¦‚è¿°](#èµ„æºä¼˜åŒ–æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. èµ„æºåˆ©ç”¨ç‡åˆ†æ](#1-èµ„æºåˆ©ç”¨ç‡åˆ†æ)
    - [1.1 åˆ©ç”¨ç‡ç»Ÿè®¡](#11-åˆ©ç”¨ç‡ç»Ÿè®¡)
  - [2. èµ„æºåˆ†é…ä¼˜åŒ–](#2-èµ„æºåˆ†é…ä¼˜åŒ–)
    - [2.1 è´Ÿè½½å‡è¡¡](#21-è´Ÿè½½å‡è¡¡)
  - [3. æˆæœ¬ä¼˜åŒ–](#3-æˆæœ¬ä¼˜åŒ–)
    - [3.1 æˆæœ¬åˆ†æ](#31-æˆæœ¬åˆ†æ)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 äº‘èµ„æºä¼˜åŒ–](#41-äº‘èµ„æºä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## èµ„æºä¼˜åŒ–æ¦‚è¿°

**èµ„æºä¼˜åŒ–**é€šè¿‡åˆç†åˆ†é…å’Œè°ƒåº¦èµ„æºï¼Œæé«˜åˆ©ç”¨ç‡å¹¶é™ä½æˆæœ¬ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **åˆ©ç”¨ç‡åˆ†æ** | èµ„æºä½¿ç”¨è¯„ä¼° | O(n) |
| **è´Ÿè½½å‡è¡¡** | èµ„æºåˆ†é… | O(n log n) |
| **æˆæœ¬ä¼˜åŒ–** | æˆæœ¬æœ€å°åŒ– | O(nÂ²) |

---

## 1. èµ„æºåˆ©ç”¨ç‡åˆ†æ

### 1.1 åˆ©ç”¨ç‡ç»Ÿè®¡

**åˆ©ç”¨ç‡ç»Ÿè®¡**åˆ†æèµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚

```sql
-- åˆ›å»ºèµ„æºä½¿ç”¨æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_usage') THEN
            RAISE WARNING 'è¡¨ resource_usage å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE resource_usage CASCADE;
        END IF;

        CREATE TABLE resource_usage (
            timestamp TIMESTAMP NOT NULL,
            resource_id VARCHAR(50) NOT NULL,
            resource_type VARCHAR(50) NOT NULL,
            allocated_capacity NUMERIC(10, 2) NOT NULL,
            used_capacity NUMERIC(10, 2) NOT NULL,
            PRIMARY KEY (timestamp, resource_id)
        );

        INSERT INTO resource_usage (timestamp, resource_id, resource_type, allocated_capacity, used_capacity) VALUES
            ('2024-01-01 10:00:00', 'CPU001', 'CPU', 100.0, 45.5),
            ('2024-01-01 10:01:00', 'CPU001', 'CPU', 100.0, 48.2),
            ('2024-01-01 10:00:00', 'MEM001', 'Memory', 64.0, 32.5),
            ('2024-01-01 10:01:00', 'MEM001', 'Memory', 64.0, 35.2),
            ('2024-01-01 10:00:00', 'STOR001', 'Storage', 1000.0, 750.0),
            ('2024-01-01 10:01:00', 'STOR001', 'Storage', 1000.0, 755.0);

        RAISE NOTICE 'è¡¨ resource_usage åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ resource_usage å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—èµ„æºåˆ©ç”¨ç‡ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_usage') THEN
            RAISE WARNING 'è¡¨ resource_usage ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—åˆ©ç”¨ç‡ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—èµ„æºåˆ©ç”¨ç‡ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ©ç”¨ç‡ç»Ÿè®¡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—èµ„æºåˆ©ç”¨ç‡
SELECT
    resource_id,
    resource_type,
    COUNT(*) AS sample_count,
    ROUND(AVG(allocated_capacity)::numeric, 2) AS avg_allocated,
    ROUND(AVG(used_capacity)::numeric, 2) AS avg_used,
    ROUND(AVG(used_capacity / NULLIF(allocated_capacity, 0) * 100)::numeric, 2) AS avg_utilization_pct,
    ROUND(MIN(used_capacity / NULLIF(allocated_capacity, 0) * 100)::numeric, 2) AS min_utilization_pct,
    ROUND(MAX(used_capacity / NULLIF(allocated_capacity, 0) * 100)::numeric, 2) AS max_utilization_pct,
    ROUND((AVG(allocated_capacity) - AVG(used_capacity))::numeric, 2) AS avg_available,
    CASE
        WHEN AVG(used_capacity / NULLIF(allocated_capacity, 0)) > 0.9 THEN 'Overutilized'
        WHEN AVG(used_capacity / NULLIF(allocated_capacity, 0)) < 0.3 THEN 'Underutilized'
        ELSE 'Optimal'
    END AS utilization_status
FROM resource_usage
GROUP BY resource_id, resource_type
ORDER BY avg_utilization_pct DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    resource_id,
    AVG(used_capacity / NULLIF(allocated_capacity, 0)) AS avg_utilization
FROM resource_usage
GROUP BY resource_id;
```

---

## 2. èµ„æºåˆ†é…ä¼˜åŒ–

### 2.1 è´Ÿè½½å‡è¡¡

**è´Ÿè½½å‡è¡¡**ä¼˜åŒ–èµ„æºåˆ†é…ï¼Œæé«˜æ•´ä½“åˆ©ç”¨ç‡ã€‚

```sql
-- è´Ÿè½½å‡è¡¡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_usage') THEN
            RAISE WARNING 'è¡¨ resource_usage ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè´Ÿè½½å‡è¡¡åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œè´Ÿè½½å‡è¡¡åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è´Ÿè½½å‡è¡¡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æè´Ÿè½½åˆ†å¸ƒ
WITH resource_stats AS (
    SELECT
        resource_type,
        resource_id,
        AVG(used_capacity / NULLIF(allocated_capacity, 0)) AS avg_utilization
    FROM resource_usage
    GROUP BY resource_type, resource_id
),
type_stats AS (
    SELECT
        resource_type,
        COUNT(*) AS resource_count,
        AVG(avg_utilization) AS avg_type_utilization,
        STDDEV(avg_utilization) AS std_type_utilization
    FROM resource_stats
    GROUP BY resource_type
)
SELECT
    rs.resource_type,
    rs.resource_id,
    ROUND(rs.avg_utilization::numeric, 4) AS resource_utilization,
    ROUND(ts.avg_type_utilization::numeric, 4) AS type_avg_utilization,
    ROUND(ts.std_type_utilization::numeric, 4) AS type_std_utilization,
    CASE
        WHEN rs.avg_utilization > ts.avg_type_utilization + ts.std_type_utilization THEN 'Overloaded'
        WHEN rs.avg_utilization < ts.avg_type_utilization - ts.std_type_utilization THEN 'Underloaded'
        ELSE 'Balanced'
    END AS load_status,
    CASE
        WHEN rs.avg_utilization > ts.avg_type_utilization + ts.std_type_utilization THEN
            'Consider redistributing load'
        WHEN rs.avg_utilization < ts.avg_type_utilization - ts.std_type_utilization THEN
            'Can accept more load'
        ELSE 'Optimal'
    END AS optimization_suggestion
FROM resource_stats rs
JOIN type_stats ts ON rs.resource_type = ts.resource_type
ORDER BY rs.resource_type, rs.avg_utilization DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    resource_type,
    AVG(used_capacity / NULLIF(allocated_capacity, 0)) AS avg_utilization
FROM resource_usage
GROUP BY resource_type;
```

---

## 3. æˆæœ¬ä¼˜åŒ–

### 3.1 æˆæœ¬åˆ†æ

**æˆæœ¬åˆ†æ**è¯„ä¼°èµ„æºä½¿ç”¨æˆæœ¬ï¼Œè¯†åˆ«ä¼˜åŒ–æœºä¼šã€‚

```sql
-- åˆ›å»ºèµ„æºæˆæœ¬è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_costs') THEN
            RAISE WARNING 'è¡¨ resource_costs å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE resource_costs CASCADE;
        END IF;

        CREATE TABLE resource_costs (
            resource_type VARCHAR(50) PRIMARY KEY,
            cost_per_unit NUMERIC(10, 4) NOT NULL,
            unit VARCHAR(20) NOT NULL
        );

        INSERT INTO resource_costs (resource_type, cost_per_unit, unit) VALUES
            ('CPU', 0.10, 'per core/hour'),
            ('Memory', 0.05, 'per GB/hour'),
            ('Storage', 0.01, 'per GB/hour');

        RAISE NOTICE 'è¡¨ resource_costs åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ resource_costs å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æˆæœ¬åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_usage') THEN
            RAISE WARNING 'è¡¨ resource_usage ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæˆæœ¬åˆ†æ';
            RETURN;
        END IF;
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'resource_costs') THEN
            RAISE WARNING 'è¡¨ resource_costs ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæˆæœ¬åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œæˆæœ¬åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æˆæœ¬åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—èµ„æºæˆæœ¬
WITH usage_summary AS (
    SELECT
        resource_id,
        resource_type,
        AVG(allocated_capacity) AS avg_allocated,
        AVG(used_capacity) AS avg_used,
        COUNT(*) AS hours_count
    FROM resource_usage
    GROUP BY resource_id, resource_type
),
cost_calculation AS (
    SELECT
        us.resource_id,
        us.resource_type,
        us.avg_allocated,
        us.avg_used,
        us.hours_count,
        rc.cost_per_unit,
        rc.unit,
        -- åˆ†é…æˆæœ¬ï¼ˆåŸºäºåˆ†é…å®¹é‡ï¼‰
        us.avg_allocated * rc.cost_per_unit * us.hours_count AS allocated_cost,
        -- ä½¿ç”¨æˆæœ¬ï¼ˆåŸºäºä½¿ç”¨å®¹é‡ï¼‰
        us.avg_used * rc.cost_per_unit * us.hours_count AS used_cost,
        -- æµªè´¹æˆæœ¬ï¼ˆæœªä½¿ç”¨çš„å®¹é‡ï¼‰
        (us.avg_allocated - us.avg_used) * rc.cost_per_unit * us.hours_count AS waste_cost
    FROM usage_summary us
    JOIN resource_costs rc ON us.resource_type = rc.resource_type
)
SELECT
    resource_id,
    resource_type,
    ROUND(avg_allocated::numeric, 2) AS avg_allocated,
    ROUND(avg_used::numeric, 2) AS avg_used,
    ROUND((avg_used / NULLIF(avg_allocated, 0) * 100)::numeric, 2) AS utilization_pct,
    ROUND(allocated_cost::numeric, 2) AS allocated_cost,
    ROUND(used_cost::numeric, 2) AS used_cost,
    ROUND(waste_cost::numeric, 2) AS waste_cost,
    ROUND((waste_cost / NULLIF(allocated_cost, 0) * 100)::numeric, 2) AS waste_pct,
    CASE
        WHEN waste_pct > 50 THEN 'High Waste - Consider downsizing'
        WHEN waste_pct > 30 THEN 'Moderate Waste - Review allocation'
        ELSE 'Efficient'
    END AS optimization_recommendation
FROM cost_calculation
ORDER BY waste_cost DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    resource_type,
    SUM(avg_allocated * cost_per_unit) AS total_cost
FROM (
    SELECT
        resource_type,
        AVG(allocated_capacity) AS avg_allocated
    FROM resource_usage
    GROUP BY resource_type
) us
JOIN resource_costs rc ON us.resource_type = rc.resource_type
GROUP BY resource_type;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 äº‘èµ„æºä¼˜åŒ–

**äº‘èµ„æºä¼˜åŒ–**ä¼˜åŒ–äº‘å¹³å°èµ„æºä½¿ç”¨ï¼Œé™ä½æˆæœ¬ã€‚

```sql
-- äº‘èµ„æºä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'cloud_resources') THEN
            RAISE WARNING 'è¡¨ cloud_resources ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE cloud_resources (
                timestamp TIMESTAMP NOT NULL,
                instance_id VARCHAR(50) NOT NULL,
                instance_type VARCHAR(50) NOT NULL,
                cpu_cores INTEGER NOT NULL,
                memory_gb INTEGER NOT NULL,
                cpu_usage_pct NUMERIC(5, 2),
                memory_usage_pct NUMERIC(5, 2),
                hourly_cost NUMERIC(10, 4),
                PRIMARY KEY (timestamp, instance_id)
            );

            INSERT INTO cloud_resources (timestamp, instance_id, instance_type, cpu_cores, memory_gb, cpu_usage_pct, memory_usage_pct, hourly_cost) VALUES
                ('2024-01-01 10:00:00', 'INST001', 'large', 8, 32, 25.5, 40.2, 0.50),
                ('2024-01-01 10:01:00', 'INST001', 'large', 8, 32, 26.2, 41.5, 0.50),
                ('2024-01-01 10:00:00', 'INST002', 'medium', 4, 16, 75.3, 80.1, 0.25),
                ('2024-01-01 10:01:00', 'INST002', 'medium', 4, 16, 78.5, 82.3, 0.25);

            RAISE NOTICE 'è¡¨ cloud_resources åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œäº‘èµ„æºä¼˜åŒ–åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'äº‘èµ„æºä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äº‘èµ„æºä¼˜åŒ–å»ºè®®
WITH instance_stats AS (
    SELECT
        instance_id,
        instance_type,
        cpu_cores,
        memory_gb,
        AVG(cpu_usage_pct) AS avg_cpu_usage,
        AVG(memory_usage_pct) AS avg_memory_usage,
        MAX(cpu_usage_pct) AS max_cpu_usage,
        MAX(memory_usage_pct) AS max_memory_usage,
        AVG(hourly_cost) AS avg_hourly_cost
    FROM cloud_resources
    GROUP BY instance_id, instance_type, cpu_cores, memory_gb
),
optimization_recommendations AS (
    SELECT
        instance_id,
        instance_type,
        cpu_cores,
        memory_gb,
        ROUND(avg_cpu_usage::numeric, 2) AS avg_cpu_usage,
        ROUND(avg_memory_usage::numeric, 2) AS avg_memory_usage,
        ROUND(max_cpu_usage::numeric, 2) AS max_cpu_usage,
        ROUND(max_memory_usage::numeric, 2) AS max_memory_usage,
        ROUND(avg_hourly_cost::numeric, 4) AS current_cost,
        CASE
            WHEN avg_cpu_usage < 30 AND avg_memory_usage < 40 THEN 'Downsize to smaller instance'
            WHEN avg_cpu_usage > 80 OR avg_memory_usage > 85 THEN 'Consider upgrading'
            WHEN avg_cpu_usage < 50 AND avg_memory_usage < 50 THEN 'Right-size opportunity'
            ELSE 'Current size appropriate'
        END AS optimization_action,
        CASE
            WHEN avg_cpu_usage < 30 AND avg_memory_usage < 40 THEN avg_hourly_cost * 0.5
            ELSE avg_hourly_cost
        END AS estimated_savings
    FROM instance_stats
)
SELECT
    instance_id,
    instance_type,
    cpu_cores,
    memory_gb,
    avg_cpu_usage,
    avg_memory_usage,
    current_cost,
    optimization_action,
    ROUND(estimated_savings::numeric, 4) AS estimated_savings,
    ROUND(((current_cost - estimated_savings) * 24 * 30)::numeric, 2) AS monthly_savings
FROM optimization_recommendations
WHERE optimization_action != 'Current size appropriate'
ORDER BY monthly_savings DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    instance_id,
    AVG(cpu_usage_pct) AS avg_cpu_usage,
    AVG(memory_usage_pct) AS avg_memory_usage
FROM cloud_resources
GROUP BY instance_id;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨(timestamp, resource_id)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
2. **èšåˆä¼˜åŒ–**: ä½¿ç”¨ç‰©åŒ–è§†å›¾å­˜å‚¨å¸¸ç”¨ç»Ÿè®¡
3. **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨å†å²æ•°æ®

## ğŸ¯ æœ€ä½³å®è·µ

1. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æèµ„æºä½¿ç”¨æƒ…å†µ
2. **è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–èµ„æºä¼˜åŒ–å†³ç­–
3. **æˆæœ¬ç›‘æ§**: æŒç»­ç›‘æ§èµ„æºæˆæœ¬
4. **å®¹é‡è§„åˆ’**: ç»“åˆå®¹é‡è§„åˆ’è¿›è¡Œä¼˜åŒ–

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
