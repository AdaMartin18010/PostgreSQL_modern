# PostgreSQL å®¹é‡è§„åˆ’ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å®¹é‡è§„åˆ’ | èµ„æºé¢„æµ‹
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ðŸ“‹ ç›®å½•

- [PostgreSQL å®¹é‡è§„åˆ’ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å®¹é‡è§„åˆ’ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å®¹é‡è§„åˆ’æ¦‚è¿°](#å®¹é‡è§„åˆ’æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. å¢žé•¿è¶‹åŠ¿åˆ†æž](#1-å¢žé•¿è¶‹åŠ¿åˆ†æž)
    - [1.1 çº¿æ€§è¶‹åŠ¿é¢„æµ‹](#11-çº¿æ€§è¶‹åŠ¿é¢„æµ‹)
  - [2. å®¹é‡éœ€æ±‚é¢„æµ‹](#2-å®¹é‡éœ€æ±‚é¢„æµ‹)
    - [2.1 åŸºäºŽåŽ†å²æ•°æ®çš„é¢„æµ‹](#21-åŸºäºŽåŽ†å²æ•°æ®çš„é¢„æµ‹)
  - [3. èµ„æºåˆ©ç”¨çŽ‡åˆ†æž](#3-èµ„æºåˆ©ç”¨çŽ‡åˆ†æž)
    - [3.1 èµ„æºä½¿ç”¨è¶‹åŠ¿](#31-èµ„æºä½¿ç”¨è¶‹åŠ¿)
  - [4. å®žé™…åº”ç”¨æ¡ˆä¾‹](#4-å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ•°æ®åº“å®¹é‡è§„åˆ’](#41-æ•°æ®åº“å®¹é‡è§„åˆ’)
  - [ðŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ðŸŽ¯ æœ€ä½³å®žè·µ](#-æœ€ä½³å®žè·µ)

---

## å®¹é‡è§„åˆ’æ¦‚è¿°

**å®¹é‡è§„åˆ’**ç”¨äºŽé¢„æµ‹æœªæ¥èµ„æºéœ€æ±‚ï¼Œç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å®¹é‡æ”¯æŒä¸šåŠ¡å¢žé•¿ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **çº¿æ€§å›žå½’** | è¶‹åŠ¿é¢„æµ‹ | O(n) |
| **ç§»åŠ¨å¹³å‡** | å¹³æ»‘æ•°æ® | O(n) |
| **å¢žé•¿çŽ‡è®¡ç®—** | å¢žé•¿é¢„æµ‹ | O(n) |

---

## 1. å¢žé•¿è¶‹åŠ¿åˆ†æž

### 1.1 çº¿æ€§è¶‹åŠ¿é¢„æµ‹

**çº¿æ€§è¶‹åŠ¿é¢„æµ‹**ä½¿ç”¨çº¿æ€§å›žå½’é¢„æµ‹æœªæ¥å®¹é‡éœ€æ±‚ã€‚

```sql
-- åˆ›å»ºå®¹é‡åŽ†å²æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'capacity_history') THEN
            RAISE WARNING 'è¡¨ capacity_history å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE capacity_history CASCADE;
        END IF;

        CREATE TABLE capacity_history (
            date DATE NOT NULL,
            resource_type VARCHAR(50) NOT NULL,
            usage_value NUMERIC(10, 2) NOT NULL,
            PRIMARY KEY (date, resource_type)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO capacity_history (date, resource_type, usage_value) VALUES
            ('2024-01-01', 'storage_gb', 100.0),
            ('2024-01-02', 'storage_gb', 102.5),
            ('2024-01-03', 'storage_gb', 105.0),
            ('2024-01-04', 'storage_gb', 107.5),
            ('2024-01-05', 'storage_gb', 110.0),
            ('2024-01-01', 'cpu_percent', 45.0),
            ('2024-01-02', 'cpu_percent', 46.5),
            ('2024-01-03', 'cpu_percent', 48.0),
            ('2024-01-04', 'cpu_percent', 49.5),
            ('2024-01-05', 'cpu_percent', 51.0);

        RAISE NOTICE 'è¡¨ capacity_history åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ capacity_history å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- çº¿æ€§è¶‹åŠ¿é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'capacity_history') THEN
            RAISE WARNING 'è¡¨ capacity_history ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè¶‹åŠ¿é¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œçº¿æ€§è¶‹åŠ¿é¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¶‹åŠ¿é¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—çº¿æ€§è¶‹åŠ¿å¹¶é¢„æµ‹æœªæ¥30å¤©
WITH numbered_data AS (
    SELECT
        date,
        resource_type,
        usage_value,
        ROW_NUMBER() OVER (PARTITION BY resource_type ORDER BY date) AS day_num
    FROM capacity_history
),
regression_stats AS (
    SELECT
        resource_type,
        COUNT(*) AS n,
        AVG(day_num) AS avg_day,
        AVG(usage_value) AS avg_usage,
        SUM(day_num * usage_value) AS sum_xy,
        SUM(day_num * day_num) AS sum_x2
    FROM numbered_data
    GROUP BY resource_type
),
regression_coeffs AS (
    SELECT
        resource_type,
        n,
        (sum_xy - n * avg_day * avg_usage) / NULLIF(sum_x2 - n * avg_day * avg_day, 0) AS slope,
        avg_usage - ((sum_xy - n * avg_day * avg_usage) / NULLIF(sum_x2 - n * avg_day * avg_day, 0)) * avg_day AS intercept
    FROM regression_stats
),
future_dates AS (
    SELECT
        resource_type,
        generate_series(
            (SELECT MAX(date) FROM capacity_history) + INTERVAL '1 day',
            (SELECT MAX(date) FROM capacity_history) + INTERVAL '30 days',
            INTERVAL '1 day'
        )::DATE AS future_date,
        ROW_NUMBER() OVER (PARTITION BY resource_type ORDER BY generate_series) + (SELECT MAX(day_num) FROM numbered_data) AS future_day_num
    FROM regression_coeffs
)
SELECT
    fd.future_date,
    fd.resource_type,
    ROUND((rc.slope * fd.future_day_num + rc.intercept)::numeric, 2) AS predicted_usage
FROM future_dates fd
JOIN regression_coeffs rc ON fd.resource_type = rc.resource_type
ORDER BY fd.resource_type, fd.future_date;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    resource_type,
    AVG(usage_value) AS avg_usage
FROM capacity_history
GROUP BY resource_type;
```

---

## 2. å®¹é‡éœ€æ±‚é¢„æµ‹

### 2.1 åŸºäºŽåŽ†å²æ•°æ®çš„é¢„æµ‹

**åŸºäºŽåŽ†å²æ•°æ®çš„é¢„æµ‹**ä½¿ç”¨åŽ†å²å¢žé•¿çŽ‡é¢„æµ‹æœªæ¥éœ€æ±‚ã€‚

```sql
-- å®¹é‡éœ€æ±‚é¢„æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'capacity_history') THEN
            RAISE WARNING 'è¡¨ capacity_history ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå®¹é‡éœ€æ±‚é¢„æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œå®¹é‡éœ€æ±‚é¢„æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å®¹é‡éœ€æ±‚é¢„æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å¢žé•¿çŽ‡å¹¶é¢„æµ‹æœªæ¥éœ€æ±‚
WITH monthly_aggregates AS (
    SELECT
        DATE_TRUNC('month', date) AS month,
        resource_type,
        AVG(usage_value) AS avg_usage
    FROM capacity_history
    GROUP BY DATE_TRUNC('month', date), resource_type
),
growth_rates AS (
    SELECT
        resource_type,
        month,
        avg_usage,
        LAG(avg_usage) OVER (PARTITION BY resource_type ORDER BY month) AS prev_usage,
        CASE
            WHEN LAG(avg_usage) OVER (PARTITION BY resource_type ORDER BY month) = 0 THEN NULL
            ELSE (avg_usage - LAG(avg_usage) OVER (PARTITION BY resource_type ORDER BY month)) /
                 LAG(avg_usage) OVER (PARTITION BY resource_type ORDER BY month)
        END AS growth_rate
    FROM monthly_aggregates
),
avg_growth_rate AS (
    SELECT
        resource_type,
        AVG(growth_rate) AS avg_growth_rate,
        MAX(month) AS last_month,
        MAX(avg_usage) AS last_usage
    FROM growth_rates
    WHERE growth_rate IS NOT NULL
    GROUP BY resource_type
),
future_predictions AS (
    SELECT
        resource_type,
        last_month + (generate_series(1, 12) || ' months')::INTERVAL AS future_month,
        last_usage * POWER(1 + COALESCE(avg_growth_rate, 0), generate_series(1, 12)) AS predicted_usage
    FROM avg_growth_rate
)
SELECT
    resource_type,
    future_month::DATE AS prediction_month,
    ROUND(predicted_usage::numeric, 2) AS predicted_usage,
    ROUND((predicted_usage - LAG(predicted_usage) OVER (PARTITION BY resource_type ORDER BY future_month))::numeric, 2) AS monthly_increase
FROM future_predictions
ORDER BY resource_type, future_month;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('month', date) AS month,
    resource_type,
    AVG(usage_value) AS avg_usage
FROM capacity_history
GROUP BY DATE_TRUNC('month', date), resource_type
ORDER BY month, resource_type;
```

---

## 3. èµ„æºåˆ©ç”¨çŽ‡åˆ†æž

### 3.1 èµ„æºä½¿ç”¨è¶‹åŠ¿

**èµ„æºä½¿ç”¨è¶‹åŠ¿**åˆ†æžèµ„æºåˆ©ç”¨çŽ‡çš„å˜åŒ–è¶‹åŠ¿ã€‚

```sql
-- èµ„æºä½¿ç”¨è¶‹åŠ¿åˆ†æžï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'capacity_history') THEN
            RAISE WARNING 'è¡¨ capacity_history ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æžèµ„æºä½¿ç”¨è¶‹åŠ¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æžèµ„æºä½¿ç”¨è¶‹åŠ¿';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'èµ„æºä½¿ç”¨è¶‹åŠ¿åˆ†æžå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æžèµ„æºä½¿ç”¨è¶‹åŠ¿
WITH usage_trends AS (
    SELECT
        date,
        resource_type,
        usage_value,
        AVG(usage_value) OVER (
            PARTITION BY resource_type
            ORDER BY date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS moving_avg_7d,
        STDDEV(usage_value) OVER (
            PARTITION BY resource_type
            ORDER BY date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS moving_std_7d
    FROM capacity_history
),
trend_analysis AS (
    SELECT
        date,
        resource_type,
        usage_value,
        moving_avg_7d,
        moving_std_7d,
        CASE
            WHEN usage_value > moving_avg_7d + 2 * moving_std_7d THEN 'Spike'
            WHEN usage_value < moving_avg_7d - 2 * moving_std_7d THEN 'Drop'
            ELSE 'Normal'
        END AS trend_status
    FROM usage_trends
    WHERE moving_avg_7d IS NOT NULL
)
SELECT
    date,
    resource_type,
    ROUND(usage_value::numeric, 2) AS usage_value,
    ROUND(moving_avg_7d::numeric, 2) AS moving_avg,
    ROUND(moving_std_7d::numeric, 2) AS moving_std,
    trend_status
FROM trend_analysis
ORDER BY resource_type, date;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date,
    resource_type,
    AVG(usage_value) OVER (PARTITION BY resource_type ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_avg
FROM capacity_history
ORDER BY resource_type, date;
```

---

## 4. å®žé™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ•°æ®åº“å®¹é‡è§„åˆ’

**æ•°æ®åº“å®¹é‡è§„åˆ’**é¢„æµ‹æ•°æ®åº“å­˜å‚¨å’Œæ€§èƒ½éœ€æ±‚ã€‚

```sql
-- æ•°æ®åº“å®¹é‡è§„åˆ’ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'database_metrics') THEN
            RAISE WARNING 'è¡¨ database_metrics ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE database_metrics (
                date DATE NOT NULL,
                database_name VARCHAR(100) NOT NULL,
                size_gb NUMERIC(10, 2) NOT NULL,
                table_count INTEGER NOT NULL,
                index_count INTEGER NOT NULL,
                query_count BIGINT NOT NULL,
                PRIMARY KEY (date, database_name)
            );

            INSERT INTO database_metrics (date, database_name, size_gb, table_count, index_count, query_count) VALUES
                ('2024-01-01', 'db_prod', 500.0, 150, 200, 1000000),
                ('2024-01-02', 'db_prod', 502.5, 152, 202, 1050000),
                ('2024-01-03', 'db_prod', 505.0, 154, 204, 1100000);

            RAISE NOTICE 'è¡¨ database_metrics åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ•°æ®åº“å®¹é‡è§„åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®åº“å®¹é‡è§„åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é¢„æµ‹æ•°æ®åº“æœªæ¥å®¹é‡éœ€æ±‚
WITH growth_analysis AS (
    SELECT
        database_name,
        date,
        size_gb,
        LAG(size_gb) OVER (PARTITION BY database_name ORDER BY date) AS prev_size,
        (size_gb - LAG(size_gb) OVER (PARTITION BY database_name ORDER BY date)) /
        NULLIF(LAG(size_gb) OVER (PARTITION BY database_name ORDER BY date), 0) AS daily_growth_rate
    FROM database_metrics
),
avg_growth AS (
    SELECT
        database_name,
        AVG(daily_growth_rate) AS avg_daily_growth,
        MAX(date) AS last_date,
        MAX(size_gb) AS last_size
    FROM growth_analysis
    WHERE daily_growth_rate IS NOT NULL
    GROUP BY database_name
),
future_capacity AS (
    SELECT
        database_name,
        last_date + (generate_series(1, 90) || ' days')::INTERVAL AS future_date,
        last_size * POWER(1 + COALESCE(avg_daily_growth, 0), generate_series(1, 90)) AS predicted_size_gb
    FROM avg_growth
)
SELECT
    database_name,
    future_date::DATE AS prediction_date,
    ROUND(predicted_size_gb::numeric, 2) AS predicted_size_gb,
    CASE
        WHEN predicted_size_gb > 1000 THEN 'Critical - Need Expansion'
        WHEN predicted_size_gb > 800 THEN 'Warning - Monitor Closely'
        ELSE 'Normal'
    END AS capacity_status
FROM future_capacity
WHERE future_date <= (SELECT MAX(last_date) FROM avg_growth) + INTERVAL '90 days'
ORDER BY database_name, future_date;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    database_name,
    AVG(size_gb) AS avg_size
FROM database_metrics
GROUP BY database_name;
```

---

## ðŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨(date, resource_type)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
2. **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨åŽ†å²æ•°æ®
3. **é‡‡æ ·**: å¯¹å¤§æ•°æ®é›†è¿›è¡Œé‡‡æ ·åˆ†æž

## ðŸŽ¯ æœ€ä½³å®žè·µ

1. **æ•°æ®è´¨é‡**: ç¡®ä¿åŽ†å²æ•°æ®çš„å‡†ç¡®æ€§
2. **å¤šç»´åº¦åˆ†æž**: ç»“åˆå¤šä¸ªæŒ‡æ ‡è¿›è¡Œåˆ†æž
3. **å®šæœŸæ›´æ–°**: å®šæœŸæ›´æ–°é¢„æµ‹æ¨¡åž‹
4. **ç¼“å†²ç©ºé—´**: é¢„ç•™è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
