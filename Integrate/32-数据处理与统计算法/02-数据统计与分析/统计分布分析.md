# PostgreSQL 统计分布分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 统计分布 | 概率分析
> **难度级别**: ⭐⭐⭐⭐ (高级)

---

## 📋 目录

- [PostgreSQL 统计分布分析完整指南](#postgresql-统计分布分析完整指南)
  - [📋 目录](#-目录)
  - [统计分布分析概述](#统计分布分析概述)
    - [核心分布类型](#核心分布类型)
  - [1. 正态分布分析](#1-正态分布分析)
    - [1.1 正态性检验](#11-正态性检验)
  - [2. 泊松分布分析](#2-泊松分布分析)
    - [2.1 泊松分布拟合](#21-泊松分布拟合)
  - [3. 二项分布分析](#3-二项分布分析)
    - [3.1 二项分布拟合](#31-二项分布拟合)
  - [4. 分布拟合检验](#4-分布拟合检验)
    - [4.1 卡方检验](#41-卡方检验)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 数据质量分布分析](#51-数据质量分布分析)

---

## 统计分布分析概述

**统计分布分析**用于分析数据的概率分布特征，帮助理解数据规律。

### 核心分布类型

| 分布类型 | 用途 | 参数 |
|---------|------|------|
| **正态分布** | 连续数据 | 均值μ、标准差σ |
| **泊松分布** | 计数数据 | 均值λ |
| **二项分布** | 二分类数据 | 试验次数n、成功概率p |

---

## 1. 正态分布分析

### 1.1 正态性检验

**正态性检验**检验数据是否符合正态分布。

```sql
-- 正态性检验（带错误处理和性能测试）
DO $$
DECLARE
    mean_val NUMERIC;
    stddev_val NUMERIC;
    skewness_val NUMERIC;
    kurtosis_val NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'measurements') THEN
            RAISE WARNING '表 measurements 不存在，无法执行正态性检验';
            RETURN;
        END IF;

        -- 计算均值和标准差
        SELECT AVG(value), STDDEV(value) INTO mean_val, stddev_val
        FROM measurements
        WHERE value IS NOT NULL;

        -- 计算偏度（简化版）
        SELECT AVG(POWER((value - mean_val) / NULLIF(stddev_val, 0), 3)) INTO skewness_val
        FROM measurements
        WHERE value IS NOT NULL;

        -- 计算峰度（简化版）
        SELECT AVG(POWER((value - mean_val) / NULLIF(stddev_val, 0), 4)) - 3 INTO kurtosis_val
        FROM measurements
        WHERE value IS NOT NULL;

        RAISE NOTICE '正态性检验结果:';
        RAISE NOTICE '  均值: %', mean_val;
        RAISE NOTICE '  标准差: %', stddev_val;
        RAISE NOTICE '  偏度: % (接近0表示对称)', skewness_val;
        RAISE NOTICE '  峰度: % (接近0表示正态)', kurtosis_val;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '正态性检验失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 查看数据分布
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    CASE
        WHEN value < AVG(value) OVER () - 2 * STDDEV(value) OVER () THEN '低于-2σ'
        WHEN value < AVG(value) OVER () - STDDEV(value) OVER () THEN '-2σ到-1σ'
        WHEN value < AVG(value) OVER () THEN '-1σ到均值'
        WHEN value < AVG(value) OVER () + STDDEV(value) OVER () THEN '均值到+1σ'
        WHEN value < AVG(value) OVER () + 2 * STDDEV(value) OVER () THEN '+1σ到+2σ'
        ELSE '高于+2σ'
    END AS distribution_range,
    COUNT(*) AS count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS percentage
FROM measurements
WHERE value IS NOT NULL
GROUP BY distribution_range
ORDER BY MIN(value);
```

---

## 2. 泊松分布分析

### 2.1 泊松分布拟合

**泊松分布拟合**检验计数数据是否符合泊松分布。

```sql
-- 泊松分布拟合（带错误处理和性能测试）
DO $$
DECLARE
    lambda_val NUMERIC;
    total_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
            RAISE WARNING '表 events 不存在，无法执行泊松分布拟合';
            RETURN;
        END IF;

        -- 计算泊松参数λ（均值）
        SELECT AVG(event_count), COUNT(*) INTO lambda_val, total_count
        FROM events
        WHERE event_count IS NOT NULL;

        RAISE NOTICE '泊松分布拟合结果:';
        RAISE NOTICE '  参数λ (均值): %', lambda_val;
        RAISE NOTICE '  总记录数: %', total_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '泊松分布拟合失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 查看事件计数分布
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    event_count,
    COUNT(*) AS observed_count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS observed_percentage
FROM events
WHERE event_count IS NOT NULL
GROUP BY event_count
ORDER BY event_count;
```

---

## 3. 二项分布分析

### 3.1 二项分布拟合

**二项分布拟合**检验二分类数据是否符合二项分布。

```sql
-- 二项分布拟合（带错误处理和性能测试）
DO $$
DECLARE
    n_val INTEGER;
    p_val NUMERIC;
    success_count BIGINT;
    total_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'trials') THEN
            RAISE WARNING '表 trials 不存在，无法执行二项分布拟合';
            RETURN;
        END IF;

        -- 计算二项分布参数
        SELECT COUNT(*) FILTER (WHERE success = true), COUNT(*) INTO success_count, total_count
        FROM trials;

        n_val := 1;  -- 每次试验次数
        p_val := success_count::NUMERIC / NULLIF(total_count, 0);

        RAISE NOTICE '二项分布拟合结果:';
        RAISE NOTICE '  试验次数n: %', n_val;
        RAISE NOTICE '  成功概率p: %', p_val;
        RAISE NOTICE '  成功次数: %', success_count;
        RAISE NOTICE '  总次数: %', total_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '二项分布拟合失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 查看成功/失败分布
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    success,
    COUNT(*) AS count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS percentage
FROM trials
GROUP BY success;
```

---

## 4. 分布拟合检验

### 4.1 卡方检验

**卡方检验**检验观测分布与理论分布的拟合度。

```sql
-- 卡方检验（带错误处理和性能测试）
DO $$
DECLARE
    chi_square NUMERIC := 0;
    expected_count NUMERIC;
    observed_count NUMERIC;
    total_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data') THEN
            RAISE WARNING '表 data 不存在，无法执行卡方检验';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO total_count FROM data WHERE value IS NOT NULL;

        -- 计算卡方统计量（简化版）
        FOR observed_count, expected_count IN
            SELECT
                COUNT(*) AS obs,
                total_count::NUMERIC / COUNT(DISTINCT value) AS exp
            FROM data
            WHERE value IS NOT NULL
            GROUP BY value
        LOOP
            chi_square := chi_square + POWER(observed_count - expected_count, 2) / NULLIF(expected_count, 0);
        END LOOP;

        RAISE NOTICE '卡方检验结果:';
        RAISE NOTICE '  卡方统计量: %', chi_square;
        RAISE NOTICE '  总记录数: %', total_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '卡方检验失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5. 实际应用案例

### 5.1 数据质量分布分析

**数据质量分布分析**分析数据质量指标的分布。

```sql
-- 数据质量分布分析（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'quality_metrics') THEN
            RAISE WARNING '表 quality_metrics 不存在，无法执行数据质量分布分析';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行数据质量分布分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '数据质量分布分析准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH stats AS (
    SELECT
        AVG(metric_value) AS mean,
        STDDEV(metric_value) AS stddev
    FROM quality_metrics
    WHERE metric_value IS NOT NULL
)
SELECT
    CASE
        WHEN metric_value < s.mean - 3 * s.stddev THEN '异常低值 (<-3σ)'
        WHEN metric_value < s.mean - 2 * s.stddev THEN '偏低 (-3σ到-2σ)'
        WHEN metric_value < s.mean - s.stddev THEN '正常偏低 (-2σ到-1σ)'
        WHEN metric_value < s.mean + s.stddev THEN '正常 (-1σ到+1σ)'
        WHEN metric_value < s.mean + 2 * s.stddev THEN '正常偏高 (+1σ到+2σ)'
        WHEN metric_value < s.mean + 3 * s.stddev THEN '偏高 (+2σ到+3σ)'
        ELSE '异常高值 (>+3σ)'
    END AS distribution_category,
    COUNT(*) AS count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS percentage
FROM quality_metrics
CROSS JOIN stats s
WHERE metric_value IS NOT NULL
GROUP BY distribution_category
ORDER BY MIN(metric_value);
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
