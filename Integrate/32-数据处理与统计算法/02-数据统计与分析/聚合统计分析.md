# PostgreSQL 聚合统计分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 聚合函数 | 统计分析
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 聚合统计分析完整指南](#postgresql-聚合统计分析完整指南)
  - [📋 目录](#-目录)
  - [聚合统计分析概述](#聚合统计分析概述)
    - [核心聚合函数](#核心聚合函数)
  - [1. 基础聚合函数](#1-基础聚合函数)
    - [1.1 基本聚合](#11-基本聚合)
  - [2. 条件聚合](#2-条件聚合)
    - [2.1 FILTER子句](#21-filter子句)
  - [3. 分组聚合](#3-分组聚合)
    - [3.1 GROUP BY](#31-group-by)
  - [4. 多维度聚合](#4-多维度聚合)
    - [4.1 ROLLUP](#41-rollup)

---

## 聚合统计分析概述

**聚合统计分析**使用PostgreSQL的聚合函数对数据进行汇总统计。

### 核心聚合函数

| 函数名称 | 用途 | 示例 |
|---------|------|------|
| **COUNT()** | 计数 | COUNT(*) |
| **SUM()** | 求和 | SUM(amount) |
| **AVG()** | 平均值 | AVG(price) |
| **MIN()** | 最小值 | MIN(date) |
| **MAX()** | 最大值 | MAX(date) |
| **PERCENTILE_CONT()** | 百分位数 | PERCENTILE_CONT(0.5) |

---

## 1. 基础聚合函数

### 1.1 基本聚合

```sql
-- 基础聚合统计（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行聚合统计';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行基础聚合统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '聚合统计准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) AS total_count,
    COUNT(DISTINCT customer_id) AS distinct_customers,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount,
    MIN(amount) AS min_amount,
    MAX(amount) AS max_amount
FROM sales
WHERE amount IS NOT NULL;
```

---

## 2. 条件聚合

### 2.1 FILTER子句

```sql
-- 条件聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING '表 orders 不存在，无法执行条件聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行条件聚合统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '条件聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE status = 'completed') AS completed_count,
    SUM(amount) FILTER (WHERE status = 'completed') AS completed_amount,
    AVG(amount) FILTER (WHERE category = 'A') AS category_a_avg
FROM orders;
```

---

## 3. 分组聚合

### 3.1 GROUP BY

```sql
-- 分组聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行分组聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行分组聚合统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '分组聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    COUNT(*) AS count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM sales
GROUP BY category
ORDER BY total_amount DESC;
```

---

## 4. 多维度聚合

### 4.1 ROLLUP

```sql
-- 多维度聚合ROLLUP（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法执行多维度聚合';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行ROLLUP多维度聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '多维度聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    SUM(amount) AS total_amount
FROM sales
GROUP BY ROLLUP(region, category)
ORDER BY region, category;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
