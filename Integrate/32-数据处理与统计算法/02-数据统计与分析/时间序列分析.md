# PostgreSQL 时间序列分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 时间序列 | 趋势分析
> **难度级别**: ⭐⭐⭐⭐ (高级)

---

## 📋 目录

- [PostgreSQL 时间序列分析完整指南](#postgresql-时间序列分析完整指南)
  - [📋 目录](#-目录)
  - [时间序列分析概述](#时间序列分析概述)
    - [核心分析功能](#核心分析功能)
  - [1. 时间序列聚合](#1-时间序列聚合)
  - [2. 移动平均](#2-移动平均)

---

## 时间序列分析概述

**时间序列分析**对按时间排序的数据进行统计分析和趋势预测。

### 核心分析功能

| 功能 | 用途 | 复杂度 |
|------|------|--------|
| **时间聚合** | 按时间分组 | O(n) |
| **移动平均** | 平滑处理 | O(n) |
| **趋势分析** | 趋势识别 | O(n) |

---

## 1. 时间序列聚合

```sql
-- 时间序列聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行时间序列聚合';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '时间序列聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('day', sale_date) AS date,
    COUNT(*) AS count,
    SUM(amount) AS total_amount
FROM sales
GROUP BY DATE_TRUNC('day', sale_date)
ORDER BY date;
```

---

## 2. 移动平均

```sql
-- 移动平均（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行移动平均计算';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '移动平均准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date,
    amount,
    AVG(amount) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_avg_7
FROM (
    SELECT DATE_TRUNC('day', sale_date) AS date, SUM(amount) AS amount
    FROM sales
    GROUP BY DATE_TRUNC('day', sale_date)
) AS daily_sales
ORDER BY date;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
