# PostgreSQL 窗口函数统计完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 窗口函数 | 排名分析
> **难度级别**: ⭐⭐⭐⭐ (高级)

---

## 📋 目录

- [PostgreSQL 窗口函数统计完整指南](#postgresql-窗口函数统计完整指南)
  - [📋 目录](#-目录)
  - [窗口函数统计概述](#窗口函数统计概述)
    - [核心窗口函数](#核心窗口函数)
  - [1. 排名函数](#1-排名函数)
  - [2. 窗口聚合](#2-窗口聚合)

---

## 窗口函数统计概述

**窗口函数统计**使用窗口函数进行排名、聚合和趋势分析。

### 核心窗口函数

| 函数类型 | 函数名称 | 用途 |
|---------|---------|------|
| **排名** | ROW_NUMBER(), RANK(), DENSE_RANK() | 排名分析 |
| **聚合** | SUM(), AVG(), COUNT() OVER | 窗口聚合 |
| **偏移** | LAG(), LEAD() | 前后值比较 |

---

## 1. 排名函数

```sql
-- 排名函数（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING '表 employees 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行排名函数统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '排名函数准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_number,
    RANK() OVER (ORDER BY salary DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY salary DESC) AS dense_rank
FROM employees;
```

---

## 2. 窗口聚合

```sql
-- 窗口聚合（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行窗口聚合统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '窗口聚合准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_sum_7,
    AVG(amount) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_avg_7
FROM sales
ORDER BY date;
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
