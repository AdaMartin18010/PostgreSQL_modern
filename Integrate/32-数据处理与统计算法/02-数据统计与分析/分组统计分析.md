# PostgreSQL 分组统计分析完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | GROUP BY | 多维分析
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 分组统计分析完整指南](#postgresql-分组统计分析完整指南)
  - [📋 目录](#-目录)
  - [分组统计分析概述](#分组统计分析概述)
    - [核心分组功能](#核心分组功能)
  - [1. GROUP BY基础](#1-group-by基础)
  - [2. GROUPING SETS](#2-grouping-sets)

---

## 分组统计分析概述

**分组统计分析**使用GROUP BY及其扩展功能进行多维数据分析。

### 核心分组功能

| 功能 | 用途 | 复杂度 |
|------|------|--------|
| **GROUP BY** | 单维度分组 | O(n log n) |
| **GROUPING SETS** | 多维度组合 | O(n log n) |
| **CUBE** | 全维度组合 | O(2^n) |
| **ROLLUP** | 层次汇总 | O(n log n) |

---

## 1. GROUP BY基础

```sql
-- GROUP BY基础分组（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行GROUP BY分组统计';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '分组统计准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    category,
    COUNT(*) AS count,
    SUM(amount) AS total
FROM sales
GROUP BY category;
```

---

## 2. GROUPING SETS

```sql
-- GROUPING SETS多维度分组（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在';
            RETURN;
        END IF;
        RAISE NOTICE '开始执行GROUPING SETS多维度分组';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'GROUPING SETS准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    region,
    category,
    SUM(amount) AS total
FROM sales
GROUP BY GROUPING SETS (
    (region, category),
    (region),
    ()
);
```

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
