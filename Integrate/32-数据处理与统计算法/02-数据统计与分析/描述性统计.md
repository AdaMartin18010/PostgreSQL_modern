# PostgreSQL 描述性统计完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 统计分析 | 描述性统计
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 描述性统计完整指南](#postgresql-描述性统计完整指南)
  - [📋 目录](#-目录)
  - [描述性统计概述](#描述性统计概述)
    - [核心统计指标](#核心统计指标)
  - [1. 中心趋势度量](#1-中心趋势度量)
    - [1.1 均值（Mean）](#11-均值mean)
    - [1.2 中位数（Median）](#12-中位数median)
    - [1.3 众数（Mode）](#13-众数mode)
  - [2. 离散程度度量](#2-离散程度度量)
    - [2.1 标准差（Standard Deviation）](#21-标准差standard-deviation)
    - [2.2 方差（Variance）](#22-方差variance)
    - [2.3 极差（Range）](#23-极差range)
  - [3. 分布形状度量](#3-分布形状度量)
    - [3.1 偏度（Skewness）](#31-偏度skewness)
    - [3.2 峰度（Kurtosis）](#32-峰度kurtosis)
  - [4. 综合统计报告](#4-综合统计报告)
    - [4.1 完整描述性统计报告](#41-完整描述性统计报告)
  - [5. 实际应用案例](#5-实际应用案例)
    - [5.1 电商销售数据分析](#51-电商销售数据分析)
  - [📚 参考资源](#-参考资源)
    - [PostgreSQL官方文档](#postgresql官方文档)
    - [统计学习资源](#统计学习资源)

---

## 描述性统计概述

**描述性统计**用于描述和总结数据的基本特征，包括中心趋势、离散程度和分布形状。

### 核心统计指标

| 指标类型 | 指标名称 | SQL函数 | 用途 |
|---------|---------|---------|------|
| **中心趋势** | 均值 | AVG() | 数据的平均水平 |
| | 中位数 | PERCENTILE_CONT(0.5) | 数据的中间值 |
| | 众数 | MODE() | 数据中出现最频繁的值 |
| **离散程度** | 标准差 | STDDEV() | 数据的离散程度 |
| | 方差 | VARIANCE() | 标准差的平方 |
| | 极差 | MAX() - MIN() | 最大值与最小值的差 |
| **分布形状** | 偏度 | 自定义函数 | 分布的对称性 |
| | 峰度 | 自定义函数 | 分布的尖锐程度 |

---

## 1. 中心趋势度量

### 1.1 均值（Mean）

**均值**是所有数据的平均值。

```sql
-- 计算均值（带错误处理和性能测试）
DO $$
DECLARE
    mean_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算均值';
            RETURN;
        END IF;

        -- 检查列是否存在
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        -- 计算行数
        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count = 0 THEN
            RAISE WARNING '表 sales 中没有有效数据';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算均值，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算均值准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算均值
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT AVG(amount) AS mean_amount
FROM sales
WHERE amount IS NOT NULL;

-- 结果示例：
-- mean_amount: 1250.50
```

### 1.2 中位数（Median）

**中位数**是将数据排序后位于中间的值。

```sql
-- 计算中位数（带错误处理和性能测试）
DO $$
DECLARE
    median_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算中位数';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count = 0 THEN
            RAISE WARNING '表 sales 中没有有效数据';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算中位数，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算中位数准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算中位数（使用PERCENTILE_CONT）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount) AS median_amount
FROM sales
WHERE amount IS NOT NULL;

-- 结果示例：
-- median_amount: 1200.00
```

### 1.3 众数（Mode）

**众数**是数据中出现最频繁的值。

```sql
-- 计算众数（带错误处理和性能测试）
DO $$
DECLARE
    mode_value NUMERIC;
    mode_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算众数';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算众数';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算众数准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算众数（使用GROUP BY和COUNT）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT amount AS mode_amount, COUNT(*) AS frequency
FROM sales
WHERE amount IS NOT NULL
GROUP BY amount
ORDER BY COUNT(*) DESC
LIMIT 1;

-- 结果示例：
-- mode_amount: 1000.00, frequency: 150
```

---

## 2. 离散程度度量

### 2.1 标准差（Standard Deviation）

**标准差**衡量数据的离散程度。

```sql
-- 计算标准差（带错误处理和性能测试）
DO $$
DECLARE
    stddev_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算标准差';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count < 2 THEN
            RAISE WARNING '数据行数不足（需要至少2行）';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算标准差，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算标准差准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算标准差（样本标准差）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT STDDEV(amount) AS stddev_amount
FROM sales
WHERE amount IS NOT NULL;

-- 性能测试：计算标准差（总体标准差）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT STDDEV_POP(amount) AS stddev_pop_amount
FROM sales
WHERE amount IS NOT NULL;

-- 结果示例：
-- stddev_amount: 250.75 (样本标准差)
-- stddev_pop_amount: 250.50 (总体标准差)
```

### 2.2 方差（Variance）

**方差**是标准差的平方。

```sql
-- 计算方差（带错误处理和性能测试）
DO $$
DECLARE
    variance_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算方差';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count < 2 THEN
            RAISE WARNING '数据行数不足（需要至少2行）';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算方差，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算方差准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算方差（样本方差）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT VARIANCE(amount) AS variance_amount
FROM sales
WHERE amount IS NOT NULL;

-- 性能测试：计算方差（总体方差）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT VAR_POP(amount) AS var_pop_amount
FROM sales
WHERE amount IS NOT NULL;

-- 结果示例：
-- variance_amount: 62875.56 (样本方差)
-- var_pop_amount: 62850.25 (总体方差)
```

### 2.3 极差（Range）

**极差**是最大值与最小值的差。

```sql
-- 计算极差（带错误处理和性能测试）
DO $$
DECLARE
    range_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算极差';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count = 0 THEN
            RAISE WARNING '表 sales 中没有有效数据';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算极差，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算极差准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算极差
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT MAX(amount) - MIN(amount) AS range_amount
FROM sales
WHERE amount IS NOT NULL;

-- 结果示例：
-- range_amount: 2000.00
```

---

## 3. 分布形状度量

### 3.1 偏度（Skewness）

**偏度**衡量分布的对称性。

```sql
-- 计算偏度（带错误处理和性能测试）
DO $$
DECLARE
    skewness_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算偏度';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count < 3 THEN
            RAISE WARNING '数据行数不足（需要至少3行）';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算偏度，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算偏度准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算偏度（使用自定义公式）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH stats AS (
    SELECT
        AVG(amount) AS mean_val,
        STDDEV(amount) AS stddev_val,
        COUNT(*) AS n
    FROM sales
    WHERE amount IS NOT NULL
)
SELECT
    (n / ((n - 1) * (n - 2))) * SUM(POWER((amount - mean_val) / stddev_val, 3)) AS skewness
FROM sales, stats
WHERE amount IS NOT NULL;

-- 结果示例：
-- skewness: 0.25 (正偏，右尾较长)
-- skewness: -0.25 (负偏，左尾较长)
-- skewness: 0.00 (对称分布)
```

### 3.2 峰度（Kurtosis）

**峰度**衡量分布的尖锐程度。

```sql
-- 计算峰度（带错误处理和性能测试）
DO $$
DECLARE
    kurtosis_value NUMERIC;
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法计算峰度';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count < 4 THEN
            RAISE WARNING '数据行数不足（需要至少4行）';
            RETURN;
        END IF;

        RAISE NOTICE '开始计算峰度，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '计算峰度准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：计算峰度（使用自定义公式）
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH stats AS (
    SELECT
        AVG(amount) AS mean_val,
        STDDEV(amount) AS stddev_val,
        COUNT(*) AS n
    FROM sales
    WHERE amount IS NOT NULL
)
SELECT
    ((n * (n + 1)) / ((n - 1) * (n - 2) * (n - 3))) * SUM(POWER((amount - mean_val) / stddev_val, 4)) -
    (3 * (n - 1) * (n - 1)) / ((n - 2) * (n - 3)) AS kurtosis
FROM sales, stats
WHERE amount IS NOT NULL;

-- 结果示例：
-- kurtosis: > 0 (尖峰分布，数据集中)
-- kurtosis: < 0 (平峰分布，数据分散)
-- kurtosis: 0 (正态分布)
```

---

## 4. 综合统计报告

### 4.1 完整描述性统计报告

```sql
-- 生成完整描述性统计报告（带错误处理和性能测试）
DO $$
DECLARE
    row_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
            RAISE WARNING '表 sales 不存在，无法生成统计报告';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'sales' AND column_name = 'amount'
        ) THEN
            RAISE WARNING '列 amount 不存在';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO row_count FROM sales WHERE amount IS NOT NULL;
        IF row_count = 0 THEN
            RAISE WARNING '表 sales 中没有有效数据';
            RETURN;
        END IF;

        RAISE NOTICE '开始生成完整描述性统计报告，数据行数: %', row_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '生成统计报告准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：生成完整描述性统计报告
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    -- 中心趋势
    AVG(amount) AS mean,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount) AS median,
    MODE() WITHIN GROUP (ORDER BY amount) AS mode,

    -- 离散程度
    STDDEV(amount) AS stddev,
    VARIANCE(amount) AS variance,
    MAX(amount) - MIN(amount) AS range_val,
    MIN(amount) AS min_val,
    MAX(amount) AS max_val,

    -- 分位数
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY amount) AS q1,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY amount) AS q3,
    PERCENTILE_CONT(0.90) WITHIN GROUP (ORDER BY amount) AS p90,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY amount) AS p95,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY amount) AS p99,

    -- 计数
    COUNT(*) AS count,
    COUNT(DISTINCT amount) AS distinct_count
FROM sales
WHERE amount IS NOT NULL;
```

---

## 5. 实际应用案例

### 5.1 电商销售数据分析

**业务场景**: 分析电商平台的销售数据，生成销售统计报告。

```sql
-- 电商销售数据分析（带完整错误处理和性能测试）
DO $$
DECLARE
    report_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING '表 orders 不存在，无法生成销售分析报告';
            RETURN;
        END IF;

        -- 检查必需的列
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'order_amount'
        ) THEN
            RAISE WARNING '列 order_amount 不存在';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'order_date'
        ) THEN
            RAISE WARNING '列 order_date 不存在';
            RETURN;
        END IF;

        RAISE NOTICE '开始生成电商销售数据分析报告';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '生成销售分析报告准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 性能测试：按日期分组的销售统计
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('day', order_date) AS sale_date,
    COUNT(*) AS order_count,
    COUNT(DISTINCT customer_id) AS customer_count,
    SUM(order_amount) AS total_amount,
    AVG(order_amount) AS avg_amount,
    STDDEV(order_amount) AS stddev_amount,
    MIN(order_amount) AS min_amount,
    MAX(order_amount) AS max_amount,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY order_amount) AS median_amount
FROM orders
WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
  AND order_amount IS NOT NULL
GROUP BY DATE_TRUNC('day', order_date)
ORDER BY sale_date DESC;
```

---

## 📚 参考资源

### PostgreSQL官方文档

- [聚合函数](https://www.postgresql.org/docs/current/functions-aggregate.html)
- [窗口函数](https://www.postgresql.org/docs/current/tutorial-window.html)
- [统计函数](https://www.postgresql.org/docs/current/functions-math.html)

### 统计学习资源

- 《统计学习方法》- 李航
- 《统计学》- 贾俊平
- 《数据挖掘：概念与技术》- Han, Kamber, Pei

---

**最后更新**: 2025年1月
**维护者**: PostgreSQL Modern Team
