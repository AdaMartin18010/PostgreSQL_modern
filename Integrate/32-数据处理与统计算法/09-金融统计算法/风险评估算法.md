# PostgreSQL é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | é£é™©è¯„ä¼° | é£é™©åº¦é‡
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-é£é™©è¯„ä¼°ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [é£é™©è¯„ä¼°æ¦‚è¿°](#é£é™©è¯„ä¼°æ¦‚è¿°)
    - [æ ¸å¿ƒé£é™©æŒ‡æ ‡](#æ ¸å¿ƒé£é™©æŒ‡æ ‡)
  - [1. æ³¢åŠ¨ç‡è®¡ç®—](#1-æ³¢åŠ¨ç‡è®¡ç®—)
    - [1.1 å†å²æ³¢åŠ¨ç‡](#11-å†å²æ³¢åŠ¨ç‡)
  - [2. VaRè®¡ç®—](#2-varè®¡ç®—)
    - [2.1 å†å²æ¨¡æ‹Ÿæ³•VaR](#21-å†å²æ¨¡æ‹Ÿæ³•var)
  - [3. é£é™©æŒ‡æ ‡](#3-é£é™©æŒ‡æ ‡)
    - [3.1 æœ€å¤§å›æ’¤](#31-æœ€å¤§å›æ’¤)
    - [3.2 å¤æ™®æ¯”ç‡](#32-å¤æ™®æ¯”ç‡)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°](#41-æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°)

---

## é£é™©è¯„ä¼°æ¦‚è¿°

**é£é™©è¯„ä¼°**ç”¨äºé‡åŒ–æŠ•èµ„é£é™©ï¼Œå¸®åŠ©æŠ•èµ„è€…åšå‡ºç†æ€§å†³ç­–ã€‚

### æ ¸å¿ƒé£é™©æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| **æ³¢åŠ¨ç‡** | Ïƒ = âˆš(Var(r)) | è¡¡é‡ä»·æ ¼æ³¢åŠ¨ç¨‹åº¦ |
| **VaR** | P(Loss > VaR) = Î± | åœ¨é™©ä»·å€¼ |
| **æœ€å¤§å›æ’¤** | Max(Peak - Trough) | æœ€å¤§æŸå¤±å¹…åº¦ |
| **å¤æ™®æ¯”ç‡** | (R - Rf) / Ïƒ | é£é™©è°ƒæ•´æ”¶ç›Š |

---

## 1. æ³¢åŠ¨ç‡è®¡ç®—

### 1.1 å†å²æ³¢åŠ¨ç‡

**å†å²æ³¢åŠ¨ç‡**åŸºäºå†å²æ”¶ç›Šç‡æ•°æ®è®¡ç®—ã€‚

```sql
-- åˆ›å»ºæ”¶ç›Šç‡æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE returns_data CASCADE;
        END IF;

        CREATE TABLE returns_data (
            date DATE NOT NULL,
            symbol VARCHAR(10) NOT NULL,
            return_rate NUMERIC(10, 6) NOT NULL,
            PRIMARY KEY (date, symbol)
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO returns_data (date, symbol, return_rate) VALUES
            ('2024-01-01', 'AAPL', 0.02), ('2024-01-02', 'AAPL', -0.01),
            ('2024-01-03', 'AAPL', 0.015), ('2024-01-04', 'AAPL', -0.005),
            ('2024-01-05', 'AAPL', 0.01), ('2024-01-01', 'GOOGL', 0.01),
            ('2024-01-02', 'GOOGL', 0.02), ('2024-01-03', 'GOOGL', -0.015),
            ('2024-01-04', 'GOOGL', 0.005), ('2024-01-05', 'GOOGL', 0.01);

        RAISE NOTICE 'è¡¨ returns_data åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥10æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ returns_data å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- è®¡ç®—å†å²æ³¢åŠ¨ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ³¢åŠ¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å†å²æ³¢åŠ¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ³¢åŠ¨ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æ—¥æ³¢åŠ¨ç‡å’Œå¹´åŒ–æ³¢åŠ¨ç‡
WITH volatility_stats AS (
    SELECT
        symbol,
        COUNT(*) AS trading_days,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        252.0 AS trading_days_per_year
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    trading_days,
    ROUND(mean_return::numeric, 6) AS mean_return,
    ROUND(std_return::numeric, 6) AS daily_volatility,
    ROUND((std_return * SQRT(trading_days_per_year))::numeric, 6) AS annualized_volatility,
    ROUND((std_return * SQRT(trading_days_per_year) * 100)::numeric, 2) AS annualized_volatility_pct
FROM volatility_stats
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    STDDEV(return_rate) AS daily_volatility
FROM returns_data
GROUP BY symbol;
```

---

## 2. VaRè®¡ç®—

### 2.1 å†å²æ¨¡æ‹Ÿæ³•VaR

**VaRï¼ˆåœ¨é™©ä»·å€¼ï¼‰**è¡¡é‡åœ¨ç»™å®šç½®ä¿¡æ°´å¹³ä¸‹çš„æœ€å¤§å¯èƒ½æŸå¤±ã€‚

```sql
-- VaRè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    confidence_level NUMERIC := 0.95;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—VaR';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—VaRï¼Œç½®ä¿¡æ°´å¹³: %', confidence_level;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'VaRè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å†å²æ¨¡æ‹Ÿæ³•VaR
WITH ranked_returns AS (
    SELECT
        symbol,
        return_rate,
        PERCENT_RANK() OVER (PARTITION BY symbol ORDER BY return_rate) AS percentile_rank
    FROM returns_data
),
var_calculation AS (
    SELECT
        symbol,
        return_rate AS var_value,
        percentile_rank
    FROM ranked_returns
    WHERE percentile_rank <= 0.05  -- 95%ç½®ä¿¡æ°´å¹³ï¼Œå–5%åˆ†ä½æ•°
    ORDER BY symbol, return_rate
    LIMIT 1000
)
SELECT
    symbol,
    MIN(var_value) AS var_95,
    ROUND((MIN(var_value) * 100)::numeric, 4) AS var_95_pct
FROM var_calculation
GROUP BY symbol
ORDER BY symbol;

-- ä½¿ç”¨PERCENTILE_CONTè®¡ç®—VaR
WITH var_percentiles AS (
    SELECT
        symbol,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_rate) AS var_95,
        PERCENTILE_CONT(0.01) WITHIN GROUP (ORDER BY return_rate) AS var_99
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND((var_95 * 100)::numeric, 4) AS var_95_pct,
    ROUND(var_99::numeric, 6) AS var_99,
    ROUND((var_99 * 100)::numeric, 4) AS var_99_pct
FROM var_percentiles
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY return_rate) AS var_95
FROM returns_data
GROUP BY symbol;
```

---

## 3. é£é™©æŒ‡æ ‡

### 3.1 æœ€å¤§å›æ’¤

**æœ€å¤§å›æ’¤**è¡¡é‡ä»å³°å€¼åˆ°è°·åº•çš„æœ€å¤§è·Œå¹…ã€‚

```sql
-- æœ€å¤§å›æ’¤è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'stock_prices') THEN
            RAISE WARNING 'è¡¨ stock_prices ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE stock_prices (
                date DATE NOT NULL,
                symbol VARCHAR(10) NOT NULL,
                close_price NUMERIC(10, 2) NOT NULL,
                PRIMARY KEY (date, symbol)
            );

            INSERT INTO stock_prices (date, symbol, close_price) VALUES
                ('2024-01-01', 'AAPL', 150.00), ('2024-01-02', 'AAPL', 155.00),
                ('2024-01-03', 'AAPL', 152.00), ('2024-01-04', 'AAPL', 148.00),
                ('2024-01-05', 'AAPL', 151.00);

            RAISE NOTICE 'è¡¨ stock_prices åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æœ€å¤§å›æ’¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœ€å¤§å›æ’¤è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æœ€å¤§å›æ’¤
WITH price_series AS (
    SELECT
        date,
        symbol,
        close_price,
        MAX(close_price) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_max,
        MIN(close_price) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS running_min_ahead
    FROM stock_prices
),
drawdowns AS (
    SELECT
        date,
        symbol,
        close_price,
        running_max,
        (close_price - running_max) / NULLIF(running_max, 0) AS drawdown
    FROM price_series
)
SELECT
    symbol,
    MIN(drawdown) AS max_drawdown,
    ROUND((MIN(drawdown) * 100)::numeric, 2) AS max_drawdown_pct,
    MIN(date) FILTER (WHERE drawdown = (SELECT MIN(drawdown) FROM drawdowns d2 WHERE d2.symbol = drawdowns.symbol)) AS drawdown_start_date
FROM drawdowns
GROUP BY symbol
ORDER BY symbol;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    MAX(close_price) OVER (PARTITION BY symbol ORDER BY date) AS running_max
FROM stock_prices
ORDER BY symbol, date;
```

### 3.2 å¤æ™®æ¯”ç‡

**å¤æ™®æ¯”ç‡**è¡¡é‡é£é™©è°ƒæ•´åçš„æ”¶ç›Šã€‚

```sql
-- å¤æ™®æ¯”ç‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—å¤æ™®æ¯”ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—å¤æ™®æ¯”ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤æ™®æ¯”ç‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å¤æ™®æ¯”ç‡
WITH return_stats AS (
    SELECT
        symbol,
        COUNT(*) AS trading_days,
        AVG(return_rate) AS mean_return,
        STDDEV(return_rate) AS std_return,
        0.03 / 252.0 AS risk_free_rate_daily  -- å‡è®¾å¹´åŒ–æ— é£é™©åˆ©ç‡3%
    FROM returns_data
    GROUP BY symbol
)
SELECT
    symbol,
    trading_days,
    ROUND(mean_return::numeric, 6) AS mean_daily_return,
    ROUND(std_return::numeric, 6) AS daily_volatility,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0))::numeric, 4) AS daily_sharpe_ratio,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0) * SQRT(252.0))::numeric, 4) AS annualized_sharpe_ratio
FROM return_stats
ORDER BY annualized_sharpe_ratio DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    symbol,
    AVG(return_rate) AS mean_return,
    STDDEV(return_rate) AS std_return
FROM returns_data
GROUP BY symbol;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°

**æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°**ç»¼åˆè¯„ä¼°å¤šèµ„äº§ç»„åˆçš„é£é™©ã€‚

```sql
-- æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'portfolio_weights') THEN
            RAISE WARNING 'è¡¨ portfolio_weights ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹è¡¨';

            CREATE TABLE portfolio_weights (
                symbol VARCHAR(10) PRIMARY KEY,
                weight NUMERIC(5, 4) NOT NULL CHECK (weight >= 0 AND weight <= 1)
            );

            INSERT INTO portfolio_weights (symbol, weight) VALUES
                ('AAPL', 0.4),
                ('GOOGL', 0.6);

            RAISE NOTICE 'è¡¨ portfolio_weights åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'returns_data') THEN
            RAISE WARNING 'è¡¨ returns_data ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒæŠ•èµ„ç»„åˆé£é™©è¯„ä¼°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŠ•èµ„ç»„åˆé£é™©è¯„ä¼°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—æŠ•èµ„ç»„åˆé£é™©æŒ‡æ ‡
WITH portfolio_returns AS (
    SELECT
        rd.date,
        SUM(rd.return_rate * pw.weight) AS portfolio_return
    FROM returns_data rd
    JOIN portfolio_weights pw ON rd.symbol = pw.symbol
    GROUP BY rd.date
),
portfolio_stats AS (
    SELECT
        COUNT(*) AS trading_days,
        AVG(portfolio_return) AS mean_return,
        STDDEV(portfolio_return) AS std_return,
        PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return) AS var_95,
        0.03 / 252.0 AS risk_free_rate_daily
    FROM portfolio_returns
)
SELECT
    trading_days,
    ROUND(mean_return::numeric, 6) AS portfolio_mean_return,
    ROUND(std_return::numeric, 6) AS portfolio_volatility,
    ROUND((std_return * SQRT(252.0))::numeric, 6) AS annualized_volatility,
    ROUND(var_95::numeric, 6) AS var_95,
    ROUND(((mean_return - risk_free_rate_daily) / NULLIF(std_return, 0) * SQRT(252.0))::numeric, 4) AS sharpe_ratio
FROM portfolio_stats;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    date,
    SUM(return_rate * weight) AS portfolio_return
FROM returns_data rd
JOIN portfolio_weights pw ON rd.symbol = pw.symbol
GROUP BY date
ORDER BY date;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨(date, symbol)ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
2. **çª—å£å‡½æ•°**: ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–æ»šåŠ¨è®¡ç®—
3. **ç‰©åŒ–è§†å›¾**: å¯¹å¸¸ç”¨é£é™©æŒ‡æ ‡åˆ›å»ºç‰©åŒ–è§†å›¾

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•°æ®è´¨é‡**: å¤„ç†ç¼ºå¤±å€¼å’Œå¼‚å¸¸å€¼
2. **æ—¶é—´çª—å£**: é€‰æ‹©åˆé€‚çš„è®¡ç®—çª—å£
3. **ç½®ä¿¡æ°´å¹³**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç½®ä¿¡æ°´å¹³
4. **é£é™©ç›‘æ§**: å®šæœŸæ›´æ–°é£é™©æŒ‡æ ‡

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
