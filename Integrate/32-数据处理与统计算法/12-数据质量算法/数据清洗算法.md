# PostgreSQL æ•°æ®æ¸…æ´—ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ•°æ®æ¸…æ´— | æ•°æ®è´¨é‡
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ•°æ®æ¸…æ´—ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-æ•°æ®æ¸…æ´—ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ•°æ®æ¸…æ´—æ¦‚è¿°](#æ•°æ®æ¸…æ´—æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. ç¼ºå¤±å€¼å¤„ç†](#1-ç¼ºå¤±å€¼å¤„ç†)
    - [1.1 ç¼ºå¤±å€¼æ£€æµ‹](#11-ç¼ºå¤±å€¼æ£€æµ‹)
    - [1.2 ç¼ºå¤±å€¼å¡«å……](#12-ç¼ºå¤±å€¼å¡«å……)
  - [2. å¼‚å¸¸å€¼å¤„ç†](#2-å¼‚å¸¸å€¼å¤„ç†)
    - [2.1 å¼‚å¸¸å€¼æ£€æµ‹](#21-å¼‚å¸¸å€¼æ£€æµ‹)
  - [3. é‡å¤æ•°æ®å¤„ç†](#3-é‡å¤æ•°æ®å¤„ç†)
    - [3.1 é‡å¤æ•°æ®æ£€æµ‹](#31-é‡å¤æ•°æ®æ£€æµ‹)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç»¼åˆæ•°æ®æ¸…æ´—](#41-ç»¼åˆæ•°æ®æ¸…æ´—)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ•°æ®æ¸…æ´—æ¦‚è¿°

**æ•°æ®æ¸…æ´—**ç”¨äºè¯†åˆ«å’Œä¿®å¤æ•°æ®è´¨é‡é—®é¢˜ï¼Œæé«˜æ•°æ®å¯é æ€§ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **ç¼ºå¤±å€¼æ£€æµ‹** | è¯†åˆ«ç©ºå€¼ | O(n) |
| **å¼‚å¸¸å€¼æ£€æµ‹** | è¯†åˆ«ç¦»ç¾¤å€¼ | O(n log n) |
| **é‡å¤æ£€æµ‹** | è¯†åˆ«é‡å¤è®°å½• | O(nÂ²) |

---

## 1. ç¼ºå¤±å€¼å¤„ç†

### 1.1 ç¼ºå¤±å€¼æ£€æµ‹

**ç¼ºå¤±å€¼æ£€æµ‹**è¯†åˆ«æ•°æ®ä¸­çš„NULLå€¼ã€‚

```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE data_quality_test CASCADE;
        END IF;

        CREATE TABLE data_quality_test (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100),
            email VARCHAR(100),
            age INTEGER,
            salary NUMERIC(10, 2),
            created_at TIMESTAMP
        );

        INSERT INTO data_quality_test (name, email, age, salary, created_at) VALUES
            ('John Doe', 'john@example.com', 30, 50000.00, '2024-01-01'),
            ('Jane Smith', NULL, 25, 45000.00, '2024-01-02'),
            (NULL, 'bob@example.com', NULL, 60000.00, '2024-01-03'),
            ('Alice Brown', 'alice@example.com', 35, NULL, '2024-01-04'),
            ('Charlie Wilson', 'charlie@example.com', 28, 55000.00, NULL);

        RAISE NOTICE 'è¡¨ data_quality_test åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ data_quality_test å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ç¼ºå¤±å€¼æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹ç¼ºå¤±å€¼';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æµ‹ç¼ºå¤±å€¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¼ºå¤±å€¼æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»Ÿè®¡å„å­—æ®µçš„ç¼ºå¤±å€¼
SELECT
    'name' AS column_name,
    COUNT(*) AS total_rows,
    COUNT(name) AS non_null_count,
    COUNT(*) - COUNT(name) AS null_count,
    ROUND(((COUNT(*) - COUNT(name))::numeric / COUNT(*) * 100)::numeric, 2) AS null_percentage
FROM data_quality_test
UNION ALL
SELECT
    'email' AS column_name,
    COUNT(*) AS total_rows,
    COUNT(email) AS non_null_count,
    COUNT(*) - COUNT(email) AS null_count,
    ROUND(((COUNT(*) - COUNT(email))::numeric / COUNT(*) * 100)::numeric, 2) AS null_percentage
FROM data_quality_test
UNION ALL
SELECT
    'age' AS column_name,
    COUNT(*) AS total_rows,
    COUNT(age) AS non_null_count,
    COUNT(*) - COUNT(age) AS null_count,
    ROUND(((COUNT(*) - COUNT(age))::numeric / COUNT(*) * 100)::numeric, 2) AS null_percentage
FROM data_quality_test
UNION ALL
SELECT
    'salary' AS column_name,
    COUNT(*) AS total_rows,
    COUNT(salary) AS non_null_count,
    COUNT(*) - COUNT(salary) AS null_count,
    ROUND(((COUNT(*) - COUNT(salary))::numeric / COUNT(*) * 100)::numeric, 2) AS null_percentage
FROM data_quality_test
ORDER BY null_percentage DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) - COUNT(name) AS null_count
FROM data_quality_test;
```

### 1.2 ç¼ºå¤±å€¼å¡«å……

**ç¼ºå¤±å€¼å¡«å……**ä½¿ç”¨åˆç†å€¼å¡«å……ç¼ºå¤±æ•°æ®ã€‚

```sql
-- ç¼ºå¤±å€¼å¡«å……ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test ä¸å­˜åœ¨ï¼Œæ— æ³•å¡«å……ç¼ºå¤±å€¼';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹å¡«å……ç¼ºå¤±å€¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¼ºå¤±å€¼å¡«å……å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨å‡å€¼å¡«å……æ•°å€¼å­—æ®µ
WITH filled_data AS (
    SELECT
        id,
        COALESCE(name, 'Unknown') AS name,
        COALESCE(email, 'noemail@example.com') AS email,
        COALESCE(age, (SELECT ROUND(AVG(age)) FROM data_quality_test WHERE age IS NOT NULL)) AS age,
        COALESCE(salary, (SELECT AVG(salary) FROM data_quality_test WHERE salary IS NOT NULL)) AS salary,
        COALESCE(created_at, NOW()) AS created_at
    FROM data_quality_test
)
SELECT
    id,
    name,
    email,
    age,
    ROUND(salary::numeric, 2) AS salary,
    created_at
FROM filled_data
ORDER BY id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COALESCE(age, (SELECT AVG(age) FROM data_quality_test WHERE age IS NOT NULL)) AS age
FROM data_quality_test;
```

---

## 2. å¼‚å¸¸å€¼å¤„ç†

### 2.1 å¼‚å¸¸å€¼æ£€æµ‹

**å¼‚å¸¸å€¼æ£€æµ‹**ä½¿ç”¨ç»Ÿè®¡æ–¹æ³•è¯†åˆ«å¼‚å¸¸æ•°æ®ã€‚

```sql
-- å¼‚å¸¸å€¼æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹å¼‚å¸¸å€¼';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æµ‹å¼‚å¸¸å€¼';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸å€¼æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨IQRæ–¹æ³•æ£€æµ‹å¼‚å¸¸å€¼
WITH salary_stats AS (
    SELECT
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY salary) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY salary) AS q3,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY salary) AS median,
        AVG(salary) AS mean,
        STDDEV(salary) AS stddev
    FROM data_quality_test
    WHERE salary IS NOT NULL
),
outlier_detection AS (
    SELECT
        dqt.id,
        dqt.salary,
        ss.mean,
        ss.median,
        ss.q1,
        ss.q3,
        ss.q3 - ss.q1 AS iqr,
        ss.q1 - 1.5 * (ss.q3 - ss.q1) AS lower_bound,
        ss.q3 + 1.5 * (ss.q3 - ss.q1) AS upper_bound,
        CASE
            WHEN dqt.salary < ss.q1 - 1.5 * (ss.q3 - ss.q1) THEN 'Lower Outlier'
            WHEN dqt.salary > ss.q3 + 1.5 * (ss.q3 - ss.q1) THEN 'Upper Outlier'
            ELSE 'Normal'
        END AS outlier_status
    FROM data_quality_test dqt
    CROSS JOIN salary_stats ss
    WHERE dqt.salary IS NOT NULL
)
SELECT
    id,
    ROUND(salary::numeric, 2) AS salary,
    ROUND(mean::numeric, 2) AS mean,
    ROUND(median::numeric, 2) AS median,
    ROUND(lower_bound::numeric, 2) AS lower_bound,
    ROUND(upper_bound::numeric, 2) AS upper_bound,
    outlier_status
FROM outlier_detection
ORDER BY salary DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY salary) AS q3
FROM data_quality_test
WHERE salary IS NOT NULL;
```

---

## 3. é‡å¤æ•°æ®å¤„ç†

### 3.1 é‡å¤æ•°æ®æ£€æµ‹

**é‡å¤æ•°æ®æ£€æµ‹**è¯†åˆ«é‡å¤è®°å½•ã€‚

```sql
-- é‡å¤æ•°æ®æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹é‡å¤æ•°æ®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æµ‹é‡å¤æ•°æ®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é‡å¤æ•°æ®æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æµ‹åŸºäºemailçš„é‡å¤è®°å½•
WITH duplicate_emails AS (
    SELECT
        email,
        COUNT(*) AS duplicate_count,
        ARRAY_AGG(id ORDER BY id) AS duplicate_ids
    FROM data_quality_test
    WHERE email IS NOT NULL
    GROUP BY email
    HAVING COUNT(*) > 1
)
SELECT
    email,
    duplicate_count,
    duplicate_ids,
    'Duplicate email addresses found' AS issue_description
FROM duplicate_emails
ORDER BY duplicate_count DESC;

-- æ£€æµ‹å®Œå…¨é‡å¤çš„è®°å½•
WITH row_hashes AS (
    SELECT
        id,
        MD5(COALESCE(name, '') || COALESCE(email, '') || COALESCE(age::text, '') || COALESCE(salary::text, '')) AS row_hash
    FROM data_quality_test
),
duplicate_rows AS (
    SELECT
        row_hash,
        COUNT(*) AS duplicate_count,
        ARRAY_AGG(id ORDER BY id) AS duplicate_ids
    FROM row_hashes
    GROUP BY row_hash
    HAVING COUNT(*) > 1
)
SELECT
    row_hash,
    duplicate_count,
    duplicate_ids,
    'Duplicate rows found' AS issue_description
FROM duplicate_rows
ORDER BY duplicate_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    email,
    COUNT(*) AS duplicate_count
FROM data_quality_test
WHERE email IS NOT NULL
GROUP BY email
HAVING COUNT(*) > 1;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç»¼åˆæ•°æ®æ¸…æ´—

**ç»¼åˆæ•°æ®æ¸…æ´—**æ•´åˆå¤šç§æ¸…æ´—æ–¹æ³•ã€‚

```sql
-- ç»¼åˆæ•°æ®æ¸…æ´—ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_quality_test') THEN
            RAISE WARNING 'è¡¨ data_quality_test ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç»¼åˆæ•°æ®æ¸…æ´—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç»¼åˆæ•°æ®æ¸…æ´—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆæ•°æ®æ¸…æ´—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆæ•°æ®è´¨é‡æŠ¥å‘Š
WITH quality_metrics AS (
    SELECT
        COUNT(*) AS total_rows,
        COUNT(name) AS name_filled,
        COUNT(email) AS email_filled,
        COUNT(age) AS age_filled,
        COUNT(salary) AS salary_filled,
        COUNT(DISTINCT email) FILTER (WHERE email IS NOT NULL) AS unique_emails,
        COUNT(*) FILTER (WHERE email IS NOT NULL) AS total_emails
    FROM data_quality_test
),
salary_stats AS (
    SELECT
        AVG(salary) AS avg_salary,
        STDDEV(salary) AS stddev_salary,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY salary) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY salary) AS q3
    FROM data_quality_test
    WHERE salary IS NOT NULL
),
outlier_count AS (
    SELECT
        COUNT(*) AS outlier_rows
    FROM data_quality_test dqt
    CROSS JOIN salary_stats ss
    WHERE dqt.salary IS NOT NULL
        AND (dqt.salary < ss.q1 - 1.5 * (ss.q3 - ss.q1) OR dqt.salary > ss.q3 + 1.5 * (ss.q3 - ss.q1))
)
SELECT
    qm.total_rows,
    ROUND((qm.name_filled::numeric / qm.total_rows * 100)::numeric, 2) AS name_completeness_pct,
    ROUND((qm.email_filled::numeric / qm.total_rows * 100)::numeric, 2) AS email_completeness_pct,
    ROUND((qm.age_filled::numeric / qm.total_rows * 100)::numeric, 2) AS age_completeness_pct,
    ROUND((qm.salary_filled::numeric / qm.total_rows * 100)::numeric, 2) AS salary_completeness_pct,
    qm.total_emails - qm.unique_emails AS duplicate_emails,
    oc.outlier_rows,
    CASE
        WHEN (qm.name_filled::numeric / qm.total_rows) < 0.9 THEN 'Low'
        WHEN (qm.email_filled::numeric / qm.total_rows) < 0.9 THEN 'Low'
        WHEN oc.outlier_rows > qm.total_rows * 0.1 THEN 'Low'
        ELSE 'High'
    END AS overall_quality
FROM quality_metrics qm
CROSS JOIN outlier_count oc;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) AS total_rows,
    COUNT(name) AS name_filled
FROM data_quality_test;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨å…³é”®å­—æ®µä¸Šåˆ›å»ºç´¢å¼•
2. **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¤„ç†å¤§é‡æ•°æ®
3. **å¹¶è¡Œå¤„ç†**: åˆ©ç”¨å¹¶è¡ŒæŸ¥è¯¢åŠ é€Ÿå¤„ç†

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ•°æ®éªŒè¯**: åœ¨æ•°æ®å…¥åº“å‰è¿›è¡ŒéªŒè¯
2. **æ¸…æ´—ç­–ç•¥**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆ¶å®šæ¸…æ´—ç­–ç•¥
3. **ç›‘æ§**: æŒç»­ç›‘æ§æ•°æ®è´¨é‡
4. **æ–‡æ¡£**: è®°å½•æ¸…æ´—è§„åˆ™å’Œè¿‡ç¨‹

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
