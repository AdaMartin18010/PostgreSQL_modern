# PostgreSQL æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ•°æ®å®Œæ•´æ€§ | çº¦æŸæ£€æŸ¥
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæ•´æŒ‡å—](#postgresql-æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ•°æ®å®Œæ•´æ€§æ¦‚è¿°](#æ•°æ®å®Œæ•´æ€§æ¦‚è¿°)
    - [æ ¸å¿ƒæ£€æŸ¥é¡¹](#æ ¸å¿ƒæ£€æŸ¥é¡¹)
  - [1. å¤–é”®å®Œæ•´æ€§](#1-å¤–é”®å®Œæ•´æ€§)
    - [1.1 å¤–é”®çº¦æŸæ£€æŸ¥](#11-å¤–é”®çº¦æŸæ£€æŸ¥)
  - [2. å¼•ç”¨å®Œæ•´æ€§](#2-å¼•ç”¨å®Œæ•´æ€§)
    - [2.1 å­¤ç«‹è®°å½•æ£€æµ‹](#21-å­¤ç«‹è®°å½•æ£€æµ‹)
  - [3. æ•°æ®ä¸€è‡´æ€§](#3-æ•°æ®ä¸€è‡´æ€§)
    - [3.1 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥](#31-æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥](#41-ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ•°æ®å®Œæ•´æ€§æ¦‚è¿°

**æ•°æ®å®Œæ•´æ€§**ç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ï¼ŒåŒ…æ‹¬å®ä½“å®Œæ•´æ€§ã€å‚ç…§å®Œæ•´æ€§å’ŒåŸŸå®Œæ•´æ€§ã€‚

### æ ¸å¿ƒæ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | ç”¨é€” | å¤æ‚åº¦ |
|--------|------|--------|
| **å¤–é”®å®Œæ•´æ€§** | æ£€æŸ¥å¤–é”®çº¦æŸ | O(n) |
| **å¼•ç”¨å®Œæ•´æ€§** | æ£€æŸ¥å­¤ç«‹è®°å½• | O(n) |
| **æ•°æ®ä¸€è‡´æ€§** | æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ | O(n) |

---

## 1. å¤–é”®å®Œæ•´æ€§

### 1.1 å¤–é”®çº¦æŸæ£€æŸ¥

**å¤–é”®çº¦æŸæ£€æŸ¥**éªŒè¯å¤–é”®å…³ç³»æ˜¯å¦å®Œæ•´ã€‚

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE orders CASCADE;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'customers') THEN
            RAISE WARNING 'è¡¨ customers å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE customers CASCADE;
        END IF;

        CREATE TABLE customers (
            customer_id SERIAL PRIMARY KEY,
            customer_name VARCHAR(100) NOT NULL,
            email VARCHAR(100) UNIQUE
        );

        CREATE TABLE orders (
            order_id SERIAL PRIMARY KEY,
            customer_id INTEGER NOT NULL,
            order_date DATE NOT NULL,
            total_amount NUMERIC(10, 2),
            FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
        );

        INSERT INTO customers (customer_name, email) VALUES
            ('John Doe', 'john@example.com'),
            ('Jane Smith', 'jane@example.com'),
            ('Bob Wilson', 'bob@example.com');

        INSERT INTO orders (customer_id, order_date, total_amount) VALUES
            (1, '2024-01-01', 100.50),
            (1, '2024-01-02', 200.75),
            (2, '2024-01-03', 150.00),
            (3, '2024-01-04', 300.25);

        RAISE NOTICE 'è¡¨ customers å’Œ orders åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ£€æŸ¥å¤–é”®å®Œæ•´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥å¤–é”®å®Œæ•´æ€§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥å¤–é”®å®Œæ•´æ€§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤–é”®å®Œæ•´æ€§æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥å¤–é”®çº¦æŸ
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_name = 'orders'
ORDER BY tc.constraint_name;

-- æ£€æŸ¥è¿åå¤–é”®çº¦æŸçš„è®°å½•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå…ˆæ’å…¥ä¸€æ¡æ— æ•ˆè®°å½•æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        -- ä¸´æ—¶ç¦ç”¨å¤–é”®çº¦æŸæ£€æŸ¥ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
        INSERT INTO orders (customer_id, order_date, total_amount) VALUES
            (999, '2024-01-05', 500.00);
    EXCEPTION
        WHEN foreign_key_violation THEN
            RAISE NOTICE 'å¤–é”®çº¦æŸæ­£å¸¸å·¥ä½œï¼šæ— æ³•æ’å…¥æ— æ•ˆçš„customer_id';
        WHEN OTHERS THEN
            RAISE WARNING 'æ’å…¥æµ‹è¯•è®°å½•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    o.order_id,
    o.customer_id,
    c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id;
```

---

## 2. å¼•ç”¨å®Œæ•´æ€§

### 2.1 å­¤ç«‹è®°å½•æ£€æµ‹

**å­¤ç«‹è®°å½•æ£€æµ‹**æŸ¥æ‰¾æ²¡æœ‰å¯¹åº”ä¸»é”®è®°å½•çš„å¤–é”®è®°å½•ã€‚

```sql
-- å­¤ç«‹è®°å½•æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æµ‹å­¤ç«‹è®°å½•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æµ‹å­¤ç«‹è®°å½•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å­¤ç«‹è®°å½•æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æµ‹ordersè¡¨ä¸­çš„å­¤ç«‹è®°å½•ï¼ˆæ²¡æœ‰å¯¹åº”customerçš„è®°å½•ï¼‰
SELECT
    o.order_id,
    o.customer_id,
    o.order_date,
    o.total_amount,
    'Orphaned record: customer_id does not exist in customers table' AS issue_description
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
WHERE c.customer_id IS NULL;

-- ç»Ÿè®¡å­¤ç«‹è®°å½•æ•°é‡
SELECT
    COUNT(*) AS orphaned_records_count,
    'orders' AS table_name,
    'customer_id' AS foreign_key_column
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
WHERE c.customer_id IS NULL;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    o.order_id,
    o.customer_id
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
WHERE c.customer_id IS NULL;
```

---

## 3. æ•°æ®ä¸€è‡´æ€§

### 3.1 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**éªŒè¯ç›¸å…³æ•°æ®çš„ä¸€è‡´æ€§ã€‚

```sql
-- åˆ›å»ºè®¢å•æ˜ç»†è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'order_items') THEN
            RAISE WARNING 'è¡¨ order_items å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE order_items CASCADE;
        END IF;

        CREATE TABLE order_items (
            item_id SERIAL PRIMARY KEY,
            order_id INTEGER NOT NULL,
            product_name VARCHAR(100) NOT NULL,
            quantity INTEGER NOT NULL,
            unit_price NUMERIC(10, 2) NOT NULL,
            FOREIGN KEY (order_id) REFERENCES orders(order_id)
        );

        INSERT INTO order_items (order_id, product_name, quantity, unit_price) VALUES
            (1, 'Product A', 2, 50.25),
            (1, 'Product B', 1, 100.00),
            (2, 'Product C', 3, 66.92),
            (3, 'Product A', 1, 50.25),
            (3, 'Product D', 2, 75.00);

        RAISE NOTICE 'è¡¨ order_items åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ order_items å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼šè®¢å•æ€»é¢ä¸æ˜ç»†æ€»é¢æ˜¯å¦ä¸€è‡´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'order_items') THEN
            RAISE WARNING 'è¡¨ order_items ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥è®¢å•æ€»é¢ä¸æ˜ç»†æ€»é¢çš„ä¸€è‡´æ€§
WITH order_totals AS (
    SELECT
        o.order_id,
        o.total_amount AS order_total,
        COALESCE(SUM(oi.quantity * oi.unit_price), 0) AS calculated_total
    FROM orders o
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY o.order_id, o.total_amount
)
SELECT
    order_id,
    ROUND(order_total::numeric, 2) AS order_total,
    ROUND(calculated_total::numeric, 2) AS calculated_total,
    ROUND(ABS(order_total - calculated_total)::numeric, 2) AS difference,
    CASE
        WHEN ABS(order_total - calculated_total) < 0.01 THEN 'Consistent'
        ELSE 'Inconsistent'
    END AS consistency_status
FROM order_totals
ORDER BY ABS(order_total - calculated_total) DESC;

-- æ£€æŸ¥è®¢å•æ˜¯å¦æœ‰æ˜ç»†é¡¹
SELECT
    o.order_id,
    o.order_date,
    o.total_amount,
    COUNT(oi.item_id) AS item_count,
    CASE
        WHEN COUNT(oi.item_id) = 0 THEN 'No items - Data inconsistency'
        ELSE 'Has items'
    END AS consistency_status
FROM orders o
LEFT JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id, o.order_date, o.total_amount
ORDER BY item_count, o.order_id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    o.order_id,
    SUM(oi.quantity * oi.unit_price) AS calculated_total
FROM orders o
LEFT JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥

**ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥**æ•´åˆå¤šç§å®Œæ•´æ€§æ£€æŸ¥æ–¹æ³•ã€‚

```sql
-- ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç»¼åˆå®Œæ•´æ€§æ£€æŸ¥';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç»¼åˆå®Œæ•´æ€§æ£€æŸ¥';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆå®Œæ•´æ€§æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿæˆå®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š
WITH integrity_checks AS (
    SELECT
        'Foreign Key Integrity' AS check_type,
        COUNT(*) AS issue_count,
        'Orders with invalid customer_id' AS description
    FROM orders o
    LEFT JOIN customers c ON o.customer_id = c.customer_id
    WHERE c.customer_id IS NULL

    UNION ALL

    SELECT
        'Data Consistency' AS check_type,
        COUNT(*) AS issue_count,
        'Orders with total_amount mismatch' AS description
    FROM (
        SELECT o.order_id
        FROM orders o
        LEFT JOIN (
            SELECT order_id, SUM(quantity * unit_price) AS calculated_total
            FROM order_items
            GROUP BY order_id
        ) oi ON o.order_id = oi.order_id
        WHERE ABS(o.total_amount - COALESCE(oi.calculated_total, 0)) > 0.01
    ) inconsistent_orders

    UNION ALL

    SELECT
        'Referential Integrity' AS check_type,
        COUNT(*) AS issue_count,
        'Orders without items' AS description
    FROM orders o
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    WHERE oi.item_id IS NULL
)
SELECT
    check_type,
    issue_count,
    description,
    CASE
        WHEN issue_count = 0 THEN 'Pass'
        ELSE 'Fail'
    END AS check_status
FROM integrity_checks
ORDER BY issue_count DESC, check_type;

-- è¯¦ç»†å®Œæ•´æ€§æŠ¥å‘Š
WITH detailed_report AS (
    SELECT
        o.order_id,
        o.customer_id,
        o.order_date,
        o.total_amount,
        CASE WHEN c.customer_id IS NULL THEN 'Missing customer' ELSE 'OK' END AS customer_status,
        COUNT(oi.item_id) AS item_count,
        COALESCE(SUM(oi.quantity * oi.unit_price), 0) AS calculated_total,
        CASE
            WHEN COUNT(oi.item_id) = 0 THEN 'No items'
            WHEN ABS(o.total_amount - COALESCE(SUM(oi.quantity * oi.unit_price), 0)) > 0.01 THEN 'Amount mismatch'
            ELSE 'OK'
        END AS consistency_status
    FROM orders o
    LEFT JOIN customers c ON o.customer_id = c.customer_id
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY o.order_id, o.customer_id, o.order_date, o.total_amount, c.customer_id
)
SELECT
    order_id,
    customer_id,
    order_date,
    ROUND(total_amount::numeric, 2) AS total_amount,
    item_count,
    ROUND(calculated_total::numeric, 2) AS calculated_total,
    customer_status,
    consistency_status,
    CASE
        WHEN customer_status = 'OK' AND consistency_status = 'OK' THEN 'All checks passed'
        ELSE 'Issues found'
    END AS overall_status
FROM detailed_report
ORDER BY overall_status, order_id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    o.order_id,
    c.customer_id IS NOT NULL AS has_customer,
    COUNT(oi.item_id) AS item_count
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
LEFT JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id, c.customer_id;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨å¤–é”®åˆ—ä¸Šåˆ›å»ºç´¢å¼•
2. **çº¦æŸ**: ä½¿ç”¨æ•°æ®åº“çº¦æŸç¡®ä¿å®Œæ•´æ€§
3. **å®šæœŸæ£€æŸ¥**: å®šæœŸè¿è¡Œå®Œæ•´æ€§æ£€æŸ¥

## ğŸ¯ æœ€ä½³å®è·µ

1. **çº¦æŸå®šä¹‰**: åœ¨è¡¨è®¾è®¡æ—¶å®šä¹‰å®Œæ•´æ€§çº¦æŸ
2. **ç›‘æ§**: æŒç»­ç›‘æ§æ•°æ®å®Œæ•´æ€§
3. **ä¿®å¤**: åŠæ—¶ä¿®å¤å‘ç°çš„å®Œæ•´æ€§é—®é¢˜
4. **æ–‡æ¡£**: è®°å½•å®Œæ•´æ€§è§„åˆ™å’Œæ£€æŸ¥æµç¨‹

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
