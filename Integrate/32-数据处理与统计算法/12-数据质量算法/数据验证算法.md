# PostgreSQL 数据验证算法完整指南

> **创建日期**: 2025年1月
> **技术栈**: PostgreSQL 17+/18+ | 数据验证 | 约束检查
> **难度级别**: ⭐⭐⭐ (中级)

---

## 📋 目录

- [PostgreSQL 数据验证算法完整指南](#postgresql-数据验证算法完整指南)
  - [📋 目录](#-目录)
  - [数据验证概述](#数据验证概述)
    - [核心算法](#核心算法)
  - [1. 格式验证](#1-格式验证)
    - [1.1 邮箱格式验证](#11-邮箱格式验证)
    - [1.2 电话号码验证](#12-电话号码验证)
  - [2. 范围验证](#2-范围验证)
    - [2.1 数值范围验证](#21-数值范围验证)
  - [3. 业务规则验证](#3-业务规则验证)
    - [3.1 自定义规则验证](#31-自定义规则验证)
  - [4. 实际应用案例](#4-实际应用案例)
    - [4.1 综合数据验证](#41-综合数据验证)
  - [📊 性能优化建议](#-性能优化建议)
  - [🎯 最佳实践](#-最佳实践)

---

## 数据验证概述

**数据验证**确保数据符合预定义的规则和约束。

### 核心算法

| 算法 | 用途 | 复杂度 |
|------|------|--------|
| **格式验证** | 检查数据格式 | O(n) |
| **范围验证** | 检查数值范围 | O(n) |
| **规则验证** | 检查业务规则 | O(n) |

---

## 1. 格式验证

### 1.1 邮箱格式验证

**邮箱格式验证**使用正则表达式验证邮箱格式。

```sql
-- 创建测试数据表（带错误处理）
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 已存在，先删除';
            DROP TABLE validation_test CASCADE;
        END IF;

        CREATE TABLE validation_test (
            id SERIAL PRIMARY KEY,
            email VARCHAR(100),
            phone VARCHAR(20),
            age INTEGER,
            score NUMERIC(5, 2)
        );

        INSERT INTO validation_test (email, phone, age, score) VALUES
            ('valid@example.com', '13800138000', 25, 85.5),
            ('invalid-email', '12345', 15, 120.0),
            ('test@domain', '13800138001', 30, 95.0),
            ('user@test.com', 'invalid-phone', 25, 75.5);

        RAISE NOTICE '表 validation_test 创建成功';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING '表 validation_test 已存在';
        WHEN OTHERS THEN
            RAISE EXCEPTION '创建表失败: %', SQLERRM;
    END;
END $$;

-- 邮箱格式验证（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 不存在，无法验证邮箱格式';
            RETURN;
        END IF;
        RAISE NOTICE '开始验证邮箱格式';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '邮箱格式验证准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 验证邮箱格式
SELECT
    id,
    email,
    CASE
        WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN 'Valid'
        ELSE 'Invalid'
    END AS email_validation_status,
    CASE
        WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN NULL
        ELSE 'Email format is invalid'
    END AS validation_error
FROM validation_test
WHERE email IS NOT NULL
ORDER BY id;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    email
FROM validation_test
WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$';
```

### 1.2 电话号码验证

**电话号码验证**验证电话号码格式。

```sql
-- 电话号码验证（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 不存在，无法验证电话号码';
            RETURN;
        END IF;
        RAISE NOTICE '开始验证电话号码格式';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '电话号码验证准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 验证中国手机号格式（11位数字，以1开头）
SELECT
    id,
    phone,
    CASE
        WHEN phone ~ '^1[3-9]\d{9}$' THEN 'Valid'
        ELSE 'Invalid'
    END AS phone_validation_status,
    CASE
        WHEN phone ~ '^1[3-9]\d{9}$' THEN NULL
        ELSE 'Phone number format is invalid (should be 11 digits starting with 1)'
    END AS validation_error
FROM validation_test
WHERE phone IS NOT NULL
ORDER BY id;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    phone
FROM validation_test
WHERE phone ~ '^1[3-9]\d{9}$';
```

---

## 2. 范围验证

### 2.1 数值范围验证

**数值范围验证**检查数值是否在合理范围内。

```sql
-- 数值范围验证（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 不存在，无法验证数值范围';
            RETURN;
        END IF;
        RAISE NOTICE '开始验证数值范围';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '数值范围验证准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 验证年龄范围（18-100）
SELECT
    id,
    age,
    CASE
        WHEN age >= 18 AND age <= 100 THEN 'Valid'
        WHEN age < 18 THEN 'Invalid - Too young'
        WHEN age > 100 THEN 'Invalid - Too old'
        ELSE 'Invalid - NULL or out of range'
    END AS age_validation_status
FROM validation_test
ORDER BY id;

-- 验证分数范围（0-100）
SELECT
    id,
    score,
    CASE
        WHEN score >= 0 AND score <= 100 THEN 'Valid'
        WHEN score < 0 THEN 'Invalid - Negative score'
        WHEN score > 100 THEN 'Invalid - Score exceeds maximum'
        ELSE 'Invalid - NULL'
    END AS score_validation_status
FROM validation_test
ORDER BY id;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    age
FROM validation_test
WHERE age >= 18 AND age <= 100;
```

---

## 3. 业务规则验证

### 3.1 自定义规则验证

**自定义规则验证**检查业务特定的规则。

```sql
-- 自定义规则验证（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 不存在，无法进行自定义规则验证';
            RETURN;
        END IF;
        RAISE NOTICE '开始进行自定义规则验证';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '自定义规则验证准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 综合验证：所有字段必须通过验证
WITH validation_results AS (
    SELECT
        id,
        email,
        phone,
        age,
        score,
        CASE
            WHEN email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN TRUE
            ELSE FALSE
        END AS email_valid,
        CASE
            WHEN phone ~ '^1[3-9]\d{9}$' THEN TRUE
            ELSE FALSE
        END AS phone_valid,
        CASE
            WHEN age >= 18 AND age <= 100 THEN TRUE
            ELSE FALSE
        END AS age_valid,
        CASE
            WHEN score >= 0 AND score <= 100 THEN TRUE
            ELSE FALSE
        END AS score_valid
    FROM validation_test
)
SELECT
    id,
    email,
    phone,
    age,
    score,
    email_valid,
    phone_valid,
    age_valid,
    score_valid,
    CASE
        WHEN email_valid AND phone_valid AND age_valid AND score_valid THEN 'All Valid'
        ELSE 'Has Invalid Fields'
    END AS overall_status,
    ARRAY_REMOVE(ARRAY[
        CASE WHEN NOT email_valid THEN 'email' END,
        CASE WHEN NOT phone_valid THEN 'phone' END,
        CASE WHEN NOT age_valid THEN 'age' END,
        CASE WHEN NOT score_valid THEN 'score' END
    ], NULL) AS invalid_fields
FROM validation_results
ORDER BY id;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_emails
FROM validation_test;
```

---

## 4. 实际应用案例

### 4.1 综合数据验证

**综合数据验证**整合多种验证方法。

```sql
-- 综合数据验证示例（带错误处理和性能测试）
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'validation_test') THEN
            RAISE WARNING '表 validation_test 不存在，无法进行综合数据验证';
            RETURN;
        END IF;
        RAISE NOTICE '开始进行综合数据验证';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '综合数据验证准备失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 生成数据验证报告
WITH validation_summary AS (
    SELECT
        COUNT(*) AS total_records,
        COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_emails,
        COUNT(*) FILTER (WHERE phone ~ '^1[3-9]\d{9}$') AS valid_phones,
        COUNT(*) FILTER (WHERE age >= 18 AND age <= 100) AS valid_ages,
        COUNT(*) FILTER (WHERE score >= 0 AND score <= 100) AS valid_scores,
        COUNT(*) FILTER (WHERE
            email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'
            AND phone ~ '^1[3-9]\d{9}$'
            AND age >= 18 AND age <= 100
            AND score >= 0 AND score <= 100
        ) AS fully_valid_records
    FROM validation_test
)
SELECT
    total_records,
    valid_emails,
    ROUND((valid_emails::numeric / total_records * 100)::numeric, 2) AS email_validity_pct,
    valid_phones,
    ROUND((valid_phones::numeric / total_records * 100)::numeric, 2) AS phone_validity_pct,
    valid_ages,
    ROUND((valid_ages::numeric / total_records * 100)::numeric, 2) AS age_validity_pct,
    valid_scores,
    ROUND((valid_scores::numeric / total_records * 100)::numeric, 2) AS score_validity_pct,
    fully_valid_records,
    ROUND((fully_valid_records::numeric / total_records * 100)::numeric, 2) AS overall_validity_pct,
    CASE
        WHEN fully_valid_records::numeric / total_records >= 0.95 THEN 'Excellent'
        WHEN fully_valid_records::numeric / total_records >= 0.80 THEN 'Good'
        WHEN fully_valid_records::numeric / total_records >= 0.60 THEN 'Fair'
        ELSE 'Poor'
    END AS data_quality_rating
FROM validation_summary;

-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') AS valid_count
FROM validation_test;
```

---

## 📊 性能优化建议

1. **索引优化**: 在验证字段上创建索引
2. **约束**: 使用CHECK约束进行验证
3. **函数**: 创建验证函数提高复用性

## 🎯 最佳实践

1. **早期验证**: 在数据入库前进行验证
2. **规则文档**: 记录所有验证规则
3. **错误处理**: 提供清晰的错误信息
4. **性能**: 优化正则表达式性能

---

**最后更新**: 2025年1月
**文档状态**: ✅ 已完成
