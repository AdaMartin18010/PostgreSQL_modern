# PostgreSQL ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ç´¢å¼•ç®—æ³• | æŸ¥è¯¢ä¼˜åŒ–
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-ç´¢å¼•ç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç´¢å¼•ç®—æ³•æ¦‚è¿°](#ç´¢å¼•ç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. B-Treeç´¢å¼•](#1-b-treeç´¢å¼•)
    - [1.1 B-Treeç´¢å¼•åˆ†æ](#11-b-treeç´¢å¼•åˆ†æ)
  - [2. ç´¢å¼•é€‰æ‹©](#2-ç´¢å¼•é€‰æ‹©)
    - [2.1 ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ](#21-ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ)
  - [3. ç´¢å¼•ä¼˜åŒ–](#3-ç´¢å¼•ä¼˜åŒ–)
    - [3.1 ç´¢å¼•é‡å»ºå»ºè®®](#31-ç´¢å¼•é‡å»ºå»ºè®®)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç´¢å¼•æ€§èƒ½ä¼˜åŒ–](#41-ç´¢å¼•æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## ç´¢å¼•ç®—æ³•æ¦‚è¿°

**ç´¢å¼•ç®—æ³•**ç”¨äºä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Œé€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹å’Œç­–ç•¥ã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **B-Tree** | èŒƒå›´æŸ¥è¯¢ | O(log n) |
| **Hash** | ç­‰å€¼æŸ¥è¯¢ | O(1) |
| **GIN** | å…¨æ–‡æœç´¢ | O(log n) |

---

## 1. B-Treeç´¢å¼•

### 1.1 B-Treeç´¢å¼•åˆ†æ

**B-Treeç´¢å¼•åˆ†æ**è¯„ä¼°ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µå’Œæ•ˆæœã€‚

```sql
-- åˆ›å»ºç´¢å¼•ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE index_usage_stats CASCADE;
        END IF;

        CREATE TABLE index_usage_stats (
            index_name VARCHAR(100) NOT NULL,
            table_name VARCHAR(100) NOT NULL,
            index_size_bytes BIGINT NOT NULL,
            index_scans BIGINT NOT NULL,
            tuples_read BIGINT NOT NULL,
            tuples_fetched BIGINT NOT NULL,
            PRIMARY KEY (index_name, table_name)
        );

        INSERT INTO index_usage_stats (index_name, table_name, index_size_bytes, index_scans, tuples_read, tuples_fetched) VALUES
            ('idx_user_email', 'users', 1048576, 10000, 10000, 10000),
            ('idx_order_date', 'orders', 5242880, 5000, 50000, 5000),
            ('idx_product_category', 'products', 2097152, 2000, 20000, 2000);

        RAISE NOTICE 'è¡¨ index_usage_stats åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ index_usage_stats å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ç´¢å¼•ä½¿ç”¨ç‡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•ä½¿ç”¨ç‡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS index_size_mb,
    index_scans,
    tuples_read,
    tuples_fetched,
    CASE
        WHEN index_scans = 0 THEN 0
        ELSE ROUND((tuples_fetched::numeric / NULLIF(tuples_read, 0))::numeric, 4)
    END AS selectivity_ratio,
    CASE
        WHEN index_scans = 0 THEN 'Unused - Consider dropping'
        WHEN tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.1 THEN 'Low Selectivity - Review'
        WHEN index_size_bytes > 100000000 AND index_scans < 100 THEN 'Large Unused - Consider optimization'
        ELSE 'Good'
    END AS index_status
FROM index_usage_stats
ORDER BY index_scans DESC, index_size_bytes DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    index_name,
    SUM(index_scans) AS total_scans
FROM index_usage_stats
GROUP BY index_name;
```

---

## 2. ç´¢å¼•é€‰æ‹©

### 2.1 ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ

**ç´¢å¼•ä½¿ç”¨ç‡åˆ†æ**è¯„ä¼°å“ªäº›ç´¢å¼•è¢«é¢‘ç¹ä½¿ç”¨ã€‚

```sql
-- ç´¢å¼•ä½¿ç”¨ç‡åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æç´¢å¼•ä½¿ç”¨ç‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•ä½¿ç”¨ç‡åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—ç´¢å¼•ä½¿ç”¨æ•ˆç‡
WITH index_efficiency AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS efficiency_ratio,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE index_size_bytes::numeric / NULLIF(index_scans, 0)
        END AS bytes_per_scan
    FROM index_usage_stats
)
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS size_mb,
    index_scans,
    ROUND(efficiency_ratio::numeric, 4) AS efficiency_ratio,
    ROUND(bytes_per_scan::numeric, 0) AS bytes_per_scan,
    CASE
        WHEN index_scans = 0 THEN 'Unused'
        WHEN efficiency_ratio < 0.1 THEN 'Low Efficiency'
        WHEN bytes_per_scan > 1000000 THEN 'High Cost per Scan'
        ELSE 'Efficient'
    END AS efficiency_status
FROM index_efficiency
ORDER BY efficiency_ratio ASC, bytes_per_scan DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    table_name,
    COUNT(*) AS index_count,
    SUM(index_scans) AS total_scans
FROM index_usage_stats
GROUP BY table_name;
```

---

## 3. ç´¢å¼•ä¼˜åŒ–

### 3.1 ç´¢å¼•é‡å»ºå»ºè®®

**ç´¢å¼•é‡å»ºå»ºè®®**è¯†åˆ«éœ€è¦é‡å»ºçš„ç´¢å¼•ã€‚

```sql
-- ç´¢å¼•é‡å»ºå»ºè®®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•é‡å»ºå»ºè®®ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”Ÿæˆç´¢å¼•ç»´æŠ¤å»ºè®®
WITH index_analysis AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS bloat_estimate
    FROM index_usage_stats
)
SELECT
    index_name,
    table_name,
    ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS current_size_mb,
    index_scans,
    ROUND(bloat_estimate::numeric, 4) AS bloat_estimate,
    CASE
        WHEN index_scans = 0 THEN 'DROP INDEX ' || index_name || ';'
        WHEN bloat_estimate < 0.3 AND index_size_bytes > 10485760 THEN 'REINDEX INDEX ' || index_name || ';'
        WHEN index_scans < 10 AND index_size_bytes > 5242880 THEN 'Consider dropping: Low usage'
        ELSE 'No action needed'
    END AS maintenance_action,
    CASE
        WHEN index_scans = 0 THEN 'High'
        WHEN bloat_estimate < 0.3 AND index_size_bytes > 10485760 THEN 'Medium'
        ELSE 'Low'
    END AS priority
FROM index_analysis
WHERE index_scans = 0 OR (bloat_estimate < 0.3 AND index_size_bytes > 10485760)
ORDER BY
    CASE priority WHEN 'High' THEN 1 WHEN 'Medium' THEN 2 ELSE 3 END,
    index_size_bytes DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) AS indexes_needing_maintenance
FROM index_usage_stats
WHERE index_scans = 0 OR (tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.3 AND index_size_bytes > 10485760);
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç´¢å¼•æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•æ€§èƒ½ä¼˜åŒ–**ç»¼åˆä¼˜åŒ–ç´¢å¼•ç­–ç•¥ã€‚

```sql
-- ç´¢å¼•æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'index_usage_stats') THEN
            RAISE WARNING 'è¡¨ index_usage_stats ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç´¢å¼•æ€§èƒ½ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œç´¢å¼•æ€§èƒ½ä¼˜åŒ–åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•æ€§èƒ½ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆç´¢å¼•ä¼˜åŒ–å»ºè®®
WITH index_metrics AS (
    SELECT
        index_name,
        table_name,
        index_size_bytes,
        index_scans,
        tuples_read,
        tuples_fetched,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE tuples_fetched::numeric / NULLIF(tuples_read, 0)
        END AS selectivity,
        CASE
            WHEN index_scans = 0 THEN 0
            ELSE index_size_bytes::numeric / NULLIF(index_scans, 0)
        END AS cost_per_scan
    FROM index_usage_stats
),
optimization_recommendations AS (
    SELECT
        index_name,
        table_name,
        ROUND(index_size_bytes / 1024.0 / 1024.0, 2) AS size_mb,
        index_scans,
        ROUND(selectivity::numeric, 4) AS selectivity,
        ROUND(cost_per_scan::numeric, 0) AS cost_per_scan,
        CASE
            WHEN index_scans = 0 THEN 'DROP'
            WHEN selectivity < 0.05 AND index_size_bytes > 5242880 THEN 'REINDEX'
            WHEN cost_per_scan > 1000000 AND index_scans < 100 THEN 'REVIEW'
            ELSE 'KEEP'
        END AS action,
        CASE
            WHEN index_scans = 0 THEN 'Unused index consuming space'
            WHEN selectivity < 0.05 THEN 'Low selectivity - high bloat'
            WHEN cost_per_scan > 1000000 THEN 'High cost per scan'
            ELSE 'Index is efficient'
        END AS reason
    FROM index_metrics
)
SELECT
    index_name,
    table_name,
    size_mb,
    index_scans,
    selectivity,
    cost_per_scan,
    action,
    reason
FROM optimization_recommendations
WHERE action != 'KEEP'
ORDER BY
    CASE action WHEN 'DROP' THEN 1 WHEN 'REINDEX' THEN 2 ELSE 3 END,
    size_mb DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*) FILTER (WHERE index_scans = 0) AS unused_indexes,
    COUNT(*) FILTER (WHERE tuples_fetched::numeric / NULLIF(tuples_read, 0) < 0.05) AS low_selectivity_indexes
FROM index_usage_stats;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
2. **ç›‘æ§**: æŒç»­ç›‘æ§ç´¢å¼•æ€§èƒ½
3. **ç»´æŠ¤**: å®šæœŸé‡å»ºç´¢å¼•
4. **é€‰æ‹©**: é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç´¢å¼•è®¾è®¡**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•
2. **é¿å…è¿‡åº¦**: é¿å…åˆ›å»ºè¿‡å¤šç´¢å¼•
3. **å®šæœŸç»´æŠ¤**: å®šæœŸç»´æŠ¤ç´¢å¼•
4. **ç›‘æ§ä½¿ç”¨**: ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
