# PostgreSQL å“ˆå¸Œç®—æ³•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å“ˆå¸Œç®—æ³• | æ•°æ®åˆ†å¸ƒ
> **éš¾åº¦çº§åˆ«**: â­â­â­ (ä¸­çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å“ˆå¸Œç®—æ³•å®Œæ•´æŒ‡å—](#postgresql-å“ˆå¸Œç®—æ³•å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å“ˆå¸Œç®—æ³•æ¦‚è¿°](#å“ˆå¸Œç®—æ³•æ¦‚è¿°)
    - [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
  - [1. å“ˆå¸Œç´¢å¼•](#1-å“ˆå¸Œç´¢å¼•)
    - [1.1 å“ˆå¸Œç´¢å¼•åˆ›å»º](#11-å“ˆå¸Œç´¢å¼•åˆ›å»º)
  - [2. å“ˆå¸Œåˆ†åŒº](#2-å“ˆå¸Œåˆ†åŒº)
    - [2.1 å“ˆå¸Œåˆ†åŒºè¡¨](#21-å“ˆå¸Œåˆ†åŒºè¡¨)
  - [3. æ•°æ®åˆ†å¸ƒåˆ†æ](#3-æ•°æ®åˆ†å¸ƒåˆ†æ)
    - [3.1 å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§](#31-å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 å“ˆå¸Œè¡¨ä¼˜åŒ–](#41-å“ˆå¸Œè¡¨ä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## å“ˆå¸Œç®—æ³•æ¦‚è¿°

**å“ˆå¸Œç®—æ³•**ç”¨äºå¿«é€Ÿå®šä½æ•°æ®ï¼Œå¸¸ç”¨äºç­‰å€¼æŸ¥è¯¢å’Œåˆ†åŒºã€‚

### æ ¸å¿ƒç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **Hashç´¢å¼•** | ç­‰å€¼æŸ¥è¯¢ | O(1) |
| **Hashåˆ†åŒº** | æ•°æ®åˆ†å¸ƒ | O(1) |
| **Hash Join** | è¡¨è¿æ¥ | O(n+m) |

---

## 1. å“ˆå¸Œç´¢å¼•

### 1.1 å“ˆå¸Œç´¢å¼•åˆ›å»º

**å“ˆå¸Œç´¢å¼•**é€‚ç”¨äºç­‰å€¼æŸ¥è¯¢ï¼Œæä¾›O(1)çš„æŸ¥æ‰¾æ€§èƒ½ã€‚

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_test_table') THEN
            RAISE WARNING 'è¡¨ hash_test_table å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE hash_test_table CASCADE;
        END IF;

        CREATE TABLE hash_test_table (
            id INTEGER PRIMARY KEY,
            email VARCHAR(100) NOT NULL,
            username VARCHAR(50) NOT NULL
        );

        INSERT INTO hash_test_table (id, email, username) VALUES
            (1, 'user1@example.com', 'user1'),
            (2, 'user2@example.com', 'user2'),
            (3, 'user3@example.com', 'user3'),
            (4, 'user4@example.com', 'user4'),
            (5, 'user5@example.com', 'user5');

        RAISE NOTICE 'è¡¨ hash_test_table åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ hash_test_table å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºå“ˆå¸Œç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_test_table') THEN
            RAISE WARNING 'è¡¨ hash_test_table ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå“ˆå¸Œç´¢å¼•';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_hash_email') THEN
            RAISE WARNING 'ç´¢å¼• idx_hash_email å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP INDEX idx_hash_email;
        END IF;

        CREATE INDEX idx_hash_email ON hash_test_table USING HASH (email);
        RAISE NOTICE 'å“ˆå¸Œç´¢å¼• idx_hash_email åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå“ˆå¸Œç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æµ‹è¯•å“ˆå¸Œç´¢å¼•æŸ¥è¯¢
SELECT
    id,
    email,
    username
FROM hash_test_table
WHERE email = 'user3@example.com';

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    email
FROM hash_test_table
WHERE email = 'user3@example.com';
```

---

## 2. å“ˆå¸Œåˆ†åŒº

### 2.1 å“ˆå¸Œåˆ†åŒºè¡¨

**å“ˆå¸Œåˆ†åŒº**æ ¹æ®å“ˆå¸Œå€¼å°†æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒåˆ†åŒºã€‚

```sql
-- åˆ›å»ºå“ˆå¸Œåˆ†åŒºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_partitioned_table') THEN
            RAISE WARNING 'è¡¨ hash_partitioned_table å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE hash_partitioned_table CASCADE;
        END IF;

        CREATE TABLE hash_partitioned_table (
            id INTEGER NOT NULL,
            user_id INTEGER NOT NULL,
            data TEXT,
            created_at TIMESTAMP DEFAULT NOW()
        ) PARTITION BY HASH (user_id);

        CREATE TABLE hash_partitioned_table_0 PARTITION OF hash_partitioned_table
            FOR VALUES WITH (MODULUS 4, REMAINDER 0);
        CREATE TABLE hash_partitioned_table_1 PARTITION OF hash_partitioned_table
            FOR VALUES WITH (MODULUS 4, REMAINDER 1);
        CREATE TABLE hash_partitioned_table_2 PARTITION OF hash_partitioned_table
            FOR VALUES WITH (MODULUS 4, REMAINDER 2);
        CREATE TABLE hash_partitioned_table_3 PARTITION OF hash_partitioned_table
            FOR VALUES WITH (MODULUS 4, REMAINDER 3);

        INSERT INTO hash_partitioned_table (id, user_id, data) VALUES
            (1, 1, 'data1'), (2, 2, 'data2'), (3, 3, 'data3'),
            (4, 4, 'data4'), (5, 5, 'data5'), (6, 6, 'data6'),
            (7, 7, 'data7'), (8, 8, 'data8'), (9, 9, 'data9'),
            (10, 10, 'data10');

        RAISE NOTICE 'å“ˆå¸Œåˆ†åŒºè¡¨åˆ›å»ºæˆåŠŸï¼Œå·²æ’å…¥10æ¡æ•°æ®';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ hash_partitioned_table å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå“ˆå¸Œåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ†æå“ˆå¸Œåˆ†åŒºåˆ†å¸ƒï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_partitioned_table') THEN
            RAISE WARNING 'è¡¨ hash_partitioned_table ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æåˆ†åŒºåˆ†å¸ƒ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æå“ˆå¸Œåˆ†åŒºåˆ†å¸ƒ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†åŒºåˆ†å¸ƒåˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æå„åˆ†åŒºçš„æ•°æ®åˆ†å¸ƒ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    (SELECT COUNT(*) FROM hash_partitioned_table WHERE (user_id % 4) =
        CASE tablename
            WHEN 'hash_partitioned_table_0' THEN 0
            WHEN 'hash_partitioned_table_1' THEN 1
            WHEN 'hash_partitioned_table_2' THEN 2
            WHEN 'hash_partitioned_table_3' THEN 3
        END
    ) AS row_count
FROM pg_tables
WHERE tablename LIKE 'hash_partitioned_table_%'
ORDER BY tablename;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*)
FROM hash_partitioned_table
WHERE user_id = 5;
```

---

## 3. æ•°æ®åˆ†å¸ƒåˆ†æ

### 3.1 å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§

**å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§**è¯„ä¼°æ•°æ®åœ¨å„åˆ†åŒºçš„åˆ†å¸ƒæ˜¯å¦å‡åŒ€ã€‚

```sql
-- å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_partitioned_table') THEN
            RAISE WARNING 'è¡¨ hash_partitioned_table ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æåˆ†å¸ƒå‡åŒ€æ€§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†æå“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†å¸ƒå‡åŒ€æ€§åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¡ç®—å„åˆ†åŒºçš„æ•°æ®åˆ†å¸ƒ
WITH partition_counts AS (
    SELECT
        (user_id % 4) AS partition_id,
        COUNT(*) AS row_count
    FROM hash_partitioned_table
    GROUP BY (user_id % 4)
),
distribution_stats AS (
    SELECT
        COUNT(*) AS partition_count,
        AVG(row_count) AS avg_rows,
        STDDEV(row_count) AS stddev_rows,
        MIN(row_count) AS min_rows,
        MAX(row_count) AS max_rows
    FROM partition_counts
)
SELECT
    pc.partition_id,
    pc.row_count,
    ROUND((pc.row_count::numeric / NULLIF(ds.avg_rows, 0) * 100)::numeric, 2) AS percentage_of_avg,
    ROUND(ds.avg_rows::numeric, 2) AS overall_avg,
    ROUND(ds.stddev_rows::numeric, 2) AS stddev,
    CASE
        WHEN ABS(pc.row_count - ds.avg_rows) <= ds.stddev_rows THEN 'Balanced'
        WHEN pc.row_count > ds.avg_rows + ds.stddev_rows THEN 'Overloaded'
        ELSE 'Underloaded'
    END AS distribution_status
FROM partition_counts pc
CROSS JOIN distribution_stats ds
ORDER BY pc.partition_id;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    (user_id % 4) AS partition_id,
    COUNT(*) AS row_count
FROM hash_partitioned_table
GROUP BY (user_id % 4);
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 å“ˆå¸Œè¡¨ä¼˜åŒ–

**å“ˆå¸Œè¡¨ä¼˜åŒ–**ä¼˜åŒ–å“ˆå¸Œç´¢å¼•å’Œåˆ†åŒºç­–ç•¥ã€‚

```sql
-- å“ˆå¸Œè¡¨ä¼˜åŒ–ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'hash_test_table') THEN
            RAISE WARNING 'è¡¨ hash_test_table ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå“ˆå¸Œè¡¨ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œå“ˆå¸Œè¡¨ä¼˜åŒ–åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å“ˆå¸Œè¡¨ä¼˜åŒ–å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†æå“ˆå¸Œç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef,
    pg_size_pretty(pg_relation_size(indexname::regclass)) AS index_size
FROM pg_indexes
WHERE tablename = 'hash_test_table'
    AND indexdef LIKE '%HASH%'
ORDER BY indexname;

-- åˆ†æå“ˆå¸Œç´¢å¼•æ•ˆç‡
WITH index_stats AS (
    SELECT
        schemaname,
        tablename,
        indexname,
        pg_relation_size(indexname::regclass) AS index_size_bytes
    FROM pg_indexes
    WHERE tablename = 'hash_test_table'
        AND indexdef LIKE '%HASH%'
)
SELECT
    tablename,
    indexname,
    pg_size_pretty(index_size_bytes) AS index_size,
    CASE
        WHEN index_size_bytes > 10485760 THEN 'Large - Consider review'
        WHEN index_size_bytes < 1024 THEN 'Small - Efficient'
        ELSE 'Normal'
    END AS size_status
FROM index_stats
ORDER BY index_size_bytes DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(*)
FROM hash_test_table
WHERE email = 'user3@example.com';
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•é€‰æ‹©**: å“ˆå¸Œç´¢å¼•é€‚ç”¨äºç­‰å€¼æŸ¥è¯¢
2. **åˆ†åŒºæ•°é‡**: é€‰æ‹©åˆé€‚çš„åˆ†åŒºæ•°é‡
3. **æ•°æ®åˆ†å¸ƒ**: ç¡®ä¿æ•°æ®åˆ†å¸ƒå‡åŒ€
4. **ç»´æŠ¤**: å®šæœŸé‡å»ºå“ˆå¸Œç´¢å¼•

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä½¿ç”¨åœºæ™¯**: å“ˆå¸Œç´¢å¼•é€‚åˆç­‰å€¼æŸ¥è¯¢
2. **åˆ†åŒºç­–ç•¥**: æ ¹æ®æ•°æ®é‡é€‰æ‹©åˆ†åŒºæ•°
3. **ç›‘æ§**: ç›‘æ§æ•°æ®åˆ†å¸ƒå‡åŒ€æ€§
4. **ä¼˜åŒ–**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–å“ˆå¸Œç­–ç•¥

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
