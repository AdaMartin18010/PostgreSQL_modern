# PostgreSQL å…³è”è§„åˆ™æŒ–æ˜å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | å…³è”è§„åˆ™ | å¸‚åœºåˆ†æ
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å…³è”è§„åˆ™æŒ–æ˜å®Œæ•´æŒ‡å—](#postgresql-å…³è”è§„åˆ™æŒ–æ˜å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [å…³è”è§„åˆ™æŒ–æ˜æ¦‚è¿°](#å…³è”è§„åˆ™æŒ–æ˜æ¦‚è¿°)
    - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
  - [1. é¢‘ç¹é¡¹é›†æŒ–æ˜](#1-é¢‘ç¹é¡¹é›†æŒ–æ˜)
    - [1.1 å•ä¸€é¡¹é›†ç»Ÿè®¡](#11-å•ä¸€é¡¹é›†ç»Ÿè®¡)
    - [1.2 äºŒé¡¹é›†ç»Ÿè®¡](#12-äºŒé¡¹é›†ç»Ÿè®¡)
  - [2. å…³è”è§„åˆ™ç”Ÿæˆ](#2-å…³è”è§„åˆ™ç”Ÿæˆ)
    - [2.1 è§„åˆ™ç”Ÿæˆ](#21-è§„åˆ™ç”Ÿæˆ)
  - [3. æ”¯æŒåº¦å’Œç½®ä¿¡åº¦è®¡ç®—](#3-æ”¯æŒåº¦å’Œç½®ä¿¡åº¦è®¡ç®—)
    - [3.1 è§„åˆ™è¯„ä¼°](#31-è§„åˆ™è¯„ä¼°)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 è´­ç‰©ç¯®åˆ†æ](#41-è´­ç‰©ç¯®åˆ†æ)

---

## å…³è”è§„åˆ™æŒ–æ˜æ¦‚è¿°

**å…³è”è§„åˆ™æŒ–æ˜**ç”¨äºå‘ç°æ•°æ®é¡¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¸¸ç”¨äºè´­ç‰©ç¯®åˆ†æã€‚

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | å®šä¹‰ | ç”¨é€” |
|------|------|------|
| **æ”¯æŒåº¦** | é¡¹é›†å‡ºç°çš„é¢‘ç‡ | è¡¡é‡è§„åˆ™é‡è¦æ€§ |
| **ç½®ä¿¡åº¦** | æ¡ä»¶æ¦‚ç‡ | è¡¡é‡è§„åˆ™å¯é æ€§ |
| **é¢‘ç¹é¡¹é›†** | æ”¯æŒåº¦è¶…è¿‡é˜ˆå€¼çš„é¡¹é›† | å€™é€‰è§„åˆ™åŸºç¡€ |

---

## 1. é¢‘ç¹é¡¹é›†æŒ–æ˜

### 1.1 å•ä¸€é¡¹é›†ç»Ÿè®¡

**å•ä¸€é¡¹é›†ç»Ÿè®¡**ç»Ÿè®¡æ¯ä¸ªé¡¹çš„å‡ºç°é¢‘ç‡ã€‚

```sql
-- å•ä¸€é¡¹é›†ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transaction_items') THEN
            RAISE WARNING 'è¡¨ transaction_items ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå•ä¸€é¡¹é›†ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå•ä¸€é¡¹é›†ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å•ä¸€é¡¹é›†ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    item,
    COUNT(DISTINCT transaction_id) AS support_count,
    COUNT(DISTINCT transaction_id) * 100.0 / (SELECT COUNT(DISTINCT transaction_id) FROM transaction_items) AS support_pct
FROM transaction_items
GROUP BY item
HAVING COUNT(DISTINCT transaction_id) >= 10  -- æœ€å°æ”¯æŒåº¦é˜ˆå€¼
ORDER BY support_count DESC;
```

### 1.2 äºŒé¡¹é›†ç»Ÿè®¡

**äºŒé¡¹é›†ç»Ÿè®¡**ç»Ÿè®¡ä¸¤ä¸ªé¡¹åŒæ—¶å‡ºç°çš„é¢‘ç‡ã€‚

```sql
-- äºŒé¡¹é›†ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transaction_items') THEN
            RAISE WARNING 'è¡¨ transaction_items ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒäºŒé¡¹é›†ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒäºŒé¡¹é›†ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'äºŒé¡¹é›†ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    t1.item AS item1,
    t2.item AS item2,
    COUNT(DISTINCT t1.transaction_id) AS support_count,
    COUNT(DISTINCT t1.transaction_id) * 100.0 / (SELECT COUNT(DISTINCT transaction_id) FROM transaction_items) AS support_pct
FROM transaction_items t1
INNER JOIN transaction_items t2 ON t1.transaction_id = t2.transaction_id
WHERE t1.item < t2.item  -- é¿å…é‡å¤ç»„åˆ
GROUP BY t1.item, t2.item
HAVING COUNT(DISTINCT t1.transaction_id) >= 10  -- æœ€å°æ”¯æŒåº¦é˜ˆå€¼
ORDER BY support_count DESC;
```

---

## 2. å…³è”è§„åˆ™ç”Ÿæˆ

### 2.1 è§„åˆ™ç”Ÿæˆ

**å…³è”è§„åˆ™ç”Ÿæˆ**ä»é¢‘ç¹é¡¹é›†ç”Ÿæˆå…³è”è§„åˆ™ã€‚

```sql
-- å…³è”è§„åˆ™ç”Ÿæˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transaction_items') THEN
            RAISE WARNING 'è¡¨ transaction_items ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆå…³è”è§„åˆ™';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆå…³è”è§„åˆ™';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å…³è”è§„åˆ™ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH frequent_itemsets AS (
    SELECT
        t1.item AS item1,
        t2.item AS item2,
        COUNT(DISTINCT t1.transaction_id) AS support_count
    FROM transaction_items t1
    INNER JOIN transaction_items t2 ON t1.transaction_id = t2.transaction_id
    WHERE t1.item < t2.item
    GROUP BY t1.item, t2.item
    HAVING COUNT(DISTINCT t1.transaction_id) >= 10
),
item_supports AS (
    SELECT
        item,
        COUNT(DISTINCT transaction_id) AS item_support
    FROM transaction_items
    GROUP BY item
)
SELECT
    fi.item1,
    fi.item2,
    fi.support_count AS support_count,
    fi.support_count * 100.0 / (SELECT COUNT(DISTINCT transaction_id) FROM transaction_items) AS support_pct,
    fi.support_count * 100.0 / NULLIF(is1.item_support, 0) AS confidence_pct,
    fi.support_count * 100.0 / NULLIF(is2.item_support, 0) AS reverse_confidence_pct
FROM frequent_itemsets fi
JOIN item_supports is1 ON fi.item1 = is1.item
JOIN item_supports is2 ON fi.item2 = is2.item
ORDER BY confidence_pct DESC;
```

---

## 3. æ”¯æŒåº¦å’Œç½®ä¿¡åº¦è®¡ç®—

### 3.1 è§„åˆ™è¯„ä¼°

**è§„åˆ™è¯„ä¼°**è®¡ç®—è§„åˆ™çš„æ”¯æŒåº¦å’Œç½®ä¿¡åº¦ã€‚

```sql
-- è§„åˆ™è¯„ä¼°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_transactions BIGINT;
    rule_support_count BIGINT;
    item1_support_count BIGINT;
    support_pct NUMERIC;
    confidence_pct NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'transaction_items') THEN
            RAISE WARNING 'è¡¨ transaction_items ä¸å­˜åœ¨ï¼Œæ— æ³•è¯„ä¼°è§„åˆ™';
            RETURN;
        END IF;

        SELECT COUNT(DISTINCT transaction_id) INTO total_transactions FROM transaction_items;

        -- è®¡ç®—è§„åˆ™ A -> B çš„æ”¯æŒåº¦å’Œç½®ä¿¡åº¦
        SELECT COUNT(DISTINCT transaction_id) INTO rule_support_count
        FROM transaction_items
        WHERE transaction_id IN (
            SELECT transaction_id FROM transaction_items WHERE item = 'A'
        )
        AND transaction_id IN (
            SELECT transaction_id FROM transaction_items WHERE item = 'B'
        );

        SELECT COUNT(DISTINCT transaction_id) INTO item1_support_count
        FROM transaction_items
        WHERE item = 'A';

        support_pct := rule_support_count * 100.0 / NULLIF(total_transactions, 0);
        confidence_pct := rule_support_count * 100.0 / NULLIF(item1_support_count, 0);

        RAISE NOTICE 'è§„åˆ™ A -> B è¯„ä¼°ç»“æœ:';
        RAISE NOTICE '  æ”¯æŒåº¦: %%%', support_pct;
        RAISE NOTICE '  ç½®ä¿¡åº¦: %%%', confidence_pct;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§„åˆ™è¯„ä¼°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 è´­ç‰©ç¯®åˆ†æ

**è´­ç‰©ç¯®åˆ†æ**åˆ†æé¡¾å®¢è´­ä¹°å•†å“çš„å…³è”å…³ç³»ã€‚

```sql
-- è´­ç‰©ç¯®åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'order_items') THEN
            RAISE WARNING 'è¡¨ order_items ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œè´­ç‰©ç¯®åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œè´­ç‰©ç¯®åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è´­ç‰©ç¯®åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH product_pairs AS (
    SELECT DISTINCT
        o1.order_id,
        o1.product_id AS product1,
        o2.product_id AS product2
    FROM order_items o1
    INNER JOIN order_items o2 ON o1.order_id = o2.order_id
    WHERE o1.product_id < o2.product_id
),
pair_stats AS (
    SELECT
        product1,
        product2,
        COUNT(DISTINCT order_id) AS pair_count
    FROM product_pairs
    GROUP BY product1, product2
    HAVING COUNT(DISTINCT order_id) >= 5  -- æœ€å°æ”¯æŒåº¦
),
product_stats AS (
    SELECT
        product_id,
        COUNT(DISTINCT order_id) AS product_count
    FROM order_items
    GROUP BY product_id
)
SELECT
    ps.product1,
    ps.product2,
    ps.pair_count AS support_count,
    ps.pair_count * 100.0 / (SELECT COUNT(DISTINCT order_id) FROM order_items) AS support_pct,
    ps.pair_count * 100.0 / NULLIF(p1.product_count, 0) AS confidence_pct
FROM pair_stats ps
JOIN product_stats p1 ON ps.product1 = p1.product_id
JOIN product_stats p2 ON ps.product2 = p2.product_id
ORDER BY confidence_pct DESC
LIMIT 20;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
