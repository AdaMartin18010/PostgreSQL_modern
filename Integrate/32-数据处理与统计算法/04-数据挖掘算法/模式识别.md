# PostgreSQL æ¨¡å¼è¯†åˆ«å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ¨¡å¼è¯†åˆ« | åºåˆ—åˆ†æ
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ¨¡å¼è¯†åˆ«å®Œæ•´æŒ‡å—](#postgresql-æ¨¡å¼è¯†åˆ«å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¨¡å¼è¯†åˆ«æ¦‚è¿°](#æ¨¡å¼è¯†åˆ«æ¦‚è¿°)
    - [æ ¸å¿ƒæ¨¡å¼ç±»å‹](#æ ¸å¿ƒæ¨¡å¼ç±»å‹)
  - [1. åºåˆ—æ¨¡å¼è¯†åˆ«](#1-åºåˆ—æ¨¡å¼è¯†åˆ«)
    - [1.1 åºåˆ—æ¨¡å¼æ£€æµ‹](#11-åºåˆ—æ¨¡å¼æ£€æµ‹)
  - [2. é¢‘ç¹æ¨¡å¼è¯†åˆ«](#2-é¢‘ç¹æ¨¡å¼è¯†åˆ«)
    - [2.1 é¢‘ç¹é¡¹é›†è¯†åˆ«](#21-é¢‘ç¹é¡¹é›†è¯†åˆ«)
  - [3. å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«](#3-å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«)
    - [3.1 å‘¨æœŸæ£€æµ‹](#31-å‘¨æœŸæ£€æµ‹)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«](#41-ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«)

---

## æ¨¡å¼è¯†åˆ«æ¦‚è¿°

**æ¨¡å¼è¯†åˆ«**ç”¨äºè¯†åˆ«æ•°æ®ä¸­çš„é‡å¤æ¨¡å¼å’Œè§„å¾‹ï¼Œå¸¸ç”¨äºè¡Œä¸ºåˆ†æå’Œè¶‹åŠ¿é¢„æµ‹ã€‚

### æ ¸å¿ƒæ¨¡å¼ç±»å‹

| æ¨¡å¼ç±»å‹ | ç”¨é€” | å¤æ‚åº¦ |
|---------|------|--------|
| **åºåˆ—æ¨¡å¼** | é¡ºåºæ¨¡å¼ | O(nÂ²) |
| **é¢‘ç¹æ¨¡å¼** | é‡å¤æ¨¡å¼ | O(n) |
| **å‘¨æœŸæ¨¡å¼** | å‘¨æœŸæ€§è§„å¾‹ | O(n log n) |

---

## 1. åºåˆ—æ¨¡å¼è¯†åˆ«

### 1.1 åºåˆ—æ¨¡å¼æ£€æµ‹

**åºåˆ—æ¨¡å¼è¯†åˆ«**è¯†åˆ«æ•°æ®ä¸­çš„åºåˆ—æ¨¡å¼ã€‚

```sql
-- åºåˆ—æ¨¡å¼è¯†åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_actions') THEN
            RAISE WARNING 'è¡¨ user_actions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œåºåˆ—æ¨¡å¼è¯†åˆ«';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œåºåˆ—æ¨¡å¼è¯†åˆ«';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åºåˆ—æ¨¡å¼è¯†åˆ«å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH action_sequences AS (
    SELECT
        user_id,
        action_type,
        LAG(action_type) OVER (PARTITION BY user_id ORDER BY action_time) AS prev_action,
        LEAD(action_type) OVER (PARTITION BY user_id ORDER BY action_time) AS next_action
    FROM user_actions
)
SELECT
    prev_action,
    action_type AS current_action,
    next_action,
    COUNT(*) AS pattern_count
FROM action_sequences
WHERE prev_action IS NOT NULL AND next_action IS NOT NULL
GROUP BY prev_action, action_type, next_action
HAVING COUNT(*) >= 10  -- æœ€å°æ”¯æŒåº¦
ORDER BY pattern_count DESC;
```

---

## 2. é¢‘ç¹æ¨¡å¼è¯†åˆ«

### 2.1 é¢‘ç¹é¡¹é›†è¯†åˆ«

**é¢‘ç¹æ¨¡å¼è¯†åˆ«**è¯†åˆ«é¢‘ç¹å‡ºç°çš„æ¨¡å¼ã€‚

```sql
-- é¢‘ç¹æ¨¡å¼è¯†åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'events') THEN
            RAISE WARNING 'è¡¨ events ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé¢‘ç¹æ¨¡å¼è¯†åˆ«';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé¢‘ç¹æ¨¡å¼è¯†åˆ«';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é¢‘ç¹æ¨¡å¼è¯†åˆ«å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT
    event_type,
    COUNT(*) AS frequency,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () AS frequency_pct
FROM events
GROUP BY event_type
HAVING COUNT(*) >= 100  -- æœ€å°æ”¯æŒåº¦
ORDER BY frequency DESC;
```

---

## 3. å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«

### 3.1 å‘¨æœŸæ£€æµ‹

**å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«**è¯†åˆ«æ•°æ®ä¸­çš„å‘¨æœŸæ€§è§„å¾‹ã€‚

```sql
-- å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'time_series') THEN
            RAISE WARNING 'è¡¨ time_series ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å‘¨æœŸæ€§æ¨¡å¼è¯†åˆ«å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH daily_patterns AS (
    SELECT
        EXTRACT(DOW FROM timestamp) AS day_of_week,
        EXTRACT(HOUR FROM timestamp) AS hour_of_day,
        AVG(value) AS avg_value
    FROM time_series
    GROUP BY EXTRACT(DOW FROM timestamp), EXTRACT(HOUR FROM timestamp)
)
SELECT
    day_of_week,
    hour_of_day,
    avg_value,
    CASE
        WHEN avg_value > (SELECT AVG(avg_value) FROM daily_patterns) + (SELECT STDDEV(avg_value) FROM daily_patterns) THEN 'é«˜å³°'
        WHEN avg_value < (SELECT AVG(avg_value) FROM daily_patterns) - (SELECT STDDEV(avg_value) FROM daily_patterns) THEN 'ä½è°·'
        ELSE 'æ­£å¸¸'
    END AS pattern_type
FROM daily_patterns
ORDER BY day_of_week, hour_of_day;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«

**ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«**è¯†åˆ«ç”¨æˆ·è¡Œä¸ºæ¨¡å¼ã€‚

```sql
-- ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_sessions') THEN
            RAISE WARNING 'è¡¨ user_sessions ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH session_patterns AS (
    SELECT
        user_id,
        session_id,
        page_path,
        ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY visit_time) AS page_order
    FROM user_sessions
),
page_transitions AS (
    SELECT
        sp1.page_path AS from_page,
        sp2.page_path AS to_page,
        COUNT(*) AS transition_count
    FROM session_patterns sp1
    JOIN session_patterns sp2 ON sp1.session_id = sp2.session_id
        AND sp2.page_order = sp1.page_order + 1
    GROUP BY sp1.page_path, sp2.page_path
)
SELECT
    from_page,
    to_page,
    transition_count,
    transition_count * 100.0 / SUM(transition_count) OVER (PARTITION BY from_page) AS transition_probability
FROM page_transitions
WHERE transition_count >= 5  -- æœ€å°æ”¯æŒåº¦
ORDER BY from_page, transition_count DESC;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
