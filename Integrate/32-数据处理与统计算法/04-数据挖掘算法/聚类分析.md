# PostgreSQL èšç±»åˆ†æå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | èšç±»åˆ†æ | ç”¨æˆ·åˆ†ç¾¤
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL èšç±»åˆ†æå®Œæ•´æŒ‡å—](#postgresql-èšç±»åˆ†æå®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [èšç±»åˆ†ææ¦‚è¿°](#èšç±»åˆ†ææ¦‚è¿°)
    - [æ ¸å¿ƒèšç±»ç®—æ³•](#æ ¸å¿ƒèšç±»ç®—æ³•)
  - [1. K-meansèšç±»](#1-k-meansèšç±»)
    - [1.1 ç®€å•K-meanså®ç°](#11-ç®€å•k-meanså®ç°)
  - [2. å±‚æ¬¡èšç±»](#2-å±‚æ¬¡èšç±»)
    - [2.1 è·ç¦»çŸ©é˜µè®¡ç®—](#21-è·ç¦»çŸ©é˜µè®¡ç®—)
  - [3. èšç±»è¯„ä¼°](#3-èšç±»è¯„ä¼°)
    - [3.1 è½®å»“ç³»æ•°è®¡ç®—](#31-è½®å»“ç³»æ•°è®¡ç®—)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 ç”¨æˆ·åˆ†ç¾¤](#41-ç”¨æˆ·åˆ†ç¾¤)

---

## èšç±»åˆ†ææ¦‚è¿°

**èšç±»åˆ†æ**å°†ç›¸ä¼¼çš„æ•°æ®ç‚¹åˆ†ç»„ï¼Œç”¨äºç”¨æˆ·åˆ†ç¾¤ã€æ•°æ®åˆ†ç±»ç­‰åœºæ™¯ã€‚

### æ ¸å¿ƒèšç±»ç®—æ³•

| ç®—æ³• | ç”¨é€” | å¤æ‚åº¦ |
|------|------|--------|
| **K-means** | å¿«é€Ÿèšç±» | O(n*k*i) |
| **å±‚æ¬¡èšç±»** | æ ‘çŠ¶èšç±» | O(nÂ²) |
| **DBSCAN** | å¯†åº¦èšç±» | O(n log n) |

---

## 1. K-meansèšç±»

### 1.1 ç®€å•K-meanså®ç°

**K-meansèšç±»**ä½¿ç”¨çª—å£å‡½æ•°å®ç°ç®€å•çš„K-meansç®—æ³•ã€‚

```sql
-- K-meansèšç±»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_points') THEN
            RAISE WARNING 'è¡¨ data_points ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒK-meansèšç±»';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒK-meansèšç±»';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'K-meansèšç±»å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–èšç±»ä¸­å¿ƒï¼ˆä½¿ç”¨NTILEï¼‰
WITH initial_clusters AS (
    SELECT
        id,
        x,
        y,
        NTILE(3) OVER (ORDER BY x, y) AS cluster_id
    FROM data_points
),
-- ç¬¬äºŒæ­¥ï¼šè®¡ç®—èšç±»ä¸­å¿ƒ
cluster_centers AS (
    SELECT
        cluster_id,
        AVG(x) AS center_x,
        AVG(y) AS center_y
    FROM initial_clusters
    GROUP BY cluster_id
),
-- ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—æ¯ä¸ªç‚¹åˆ°å„ä¸­å¿ƒçš„è·ç¦»
distances AS (
    SELECT
        p.id,
        p.x,
        p.y,
        c.cluster_id,
        SQRT(POWER(p.x - c.center_x, 2) + POWER(p.y - c.center_y, 2)) AS distance
    FROM data_points p
    CROSS JOIN cluster_centers c
),
-- ç¬¬å››æ­¥ï¼šåˆ†é…æœ€è¿‘çš„ä¸­å¿ƒ
closest_clusters AS (
    SELECT
        id,
        x,
        y,
        cluster_id,
        ROW_NUMBER() OVER (PARTITION BY id ORDER BY distance) AS rn
    FROM distances
)
SELECT
    id,
    x,
    y,
    cluster_id
FROM closest_clusters
WHERE rn = 1
ORDER BY cluster_id, id;
```

---

## 2. å±‚æ¬¡èšç±»

### 2.1 è·ç¦»çŸ©é˜µè®¡ç®—

**è·ç¦»çŸ©é˜µè®¡ç®—**è®¡ç®—æ‰€æœ‰ç‚¹ä¹‹é—´çš„è·ç¦»ã€‚

```sql
-- è·ç¦»çŸ©é˜µè®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'data_points') THEN
            RAISE WARNING 'è¡¨ data_points ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—è·ç¦»çŸ©é˜µ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—è·ç¦»çŸ©é˜µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·ç¦»çŸ©é˜µè®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    p1.id AS point1_id,
    p2.id AS point2_id,
    SQRT(POWER(p1.x - p2.x, 2) + POWER(p1.y - p2.y, 2)) AS distance
FROM data_points p1
CROSS JOIN data_points p2
WHERE p1.id < p2.id
ORDER BY distance;
```

---

## 3. èšç±»è¯„ä¼°

### 3.1 è½®å»“ç³»æ•°è®¡ç®—

**è½®å»“ç³»æ•°**è¯„ä¼°èšç±»è´¨é‡ã€‚

```sql
-- è½®å»“ç³»æ•°è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    avg_silhouette NUMERIC;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'clustered_points') THEN
            RAISE WARNING 'è¡¨ clustered_points ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—è½®å»“ç³»æ•°';
            RETURN;
        END IF;

        -- è®¡ç®—å¹³å‡è½®å»“ç³»æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        WITH intra_cluster_distances AS (
            SELECT
                cluster_id,
                AVG(SQRT(POWER(p1.x - p2.x, 2) + POWER(p1.y - p2.y, 2))) AS avg_intra_distance
            FROM clustered_points p1
            JOIN clustered_points p2 ON p1.cluster_id = p2.cluster_id
            WHERE p1.id < p2.id
            GROUP BY cluster_id
        ),
        inter_cluster_distances AS (
            SELECT
                p1.cluster_id,
                AVG(SQRT(POWER(p1.x - p2.x, 2) + POWER(p1.y - p2.y, 2))) AS avg_inter_distance
            FROM clustered_points p1
            JOIN clustered_points p2 ON p1.cluster_id != p2.cluster_id
            GROUP BY p1.cluster_id
        )
        SELECT AVG((ic.avg_inter_distance - ia.avg_intra_distance) / NULLIF(GREATEST(ic.avg_inter_distance, ia.avg_intra_distance), 0))
        INTO avg_silhouette
        FROM intra_cluster_distances ia
        JOIN inter_cluster_distances ic ON ia.cluster_id = ic.cluster_id;

        RAISE NOTICE 'å¹³å‡è½®å»“ç³»æ•°: % (èŒƒå›´: -1åˆ°1ï¼Œè¶Šå¤§è¶Šå¥½)', avg_silhouette;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è½®å»“ç³»æ•°è®¡ç®—å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 ç”¨æˆ·åˆ†ç¾¤

**ç”¨æˆ·åˆ†ç¾¤**æ ¹æ®ç”¨æˆ·è¡Œä¸ºç‰¹å¾è¿›è¡Œåˆ†ç¾¤ã€‚

```sql
-- ç”¨æˆ·åˆ†ç¾¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_features') THEN
            RAISE WARNING 'è¡¨ user_features ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç”¨æˆ·åˆ†ç¾¤';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç”¨æˆ·åˆ†ç¾¤';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·åˆ†ç¾¤å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

WITH normalized_features AS (
    SELECT
        user_id,
        (total_orders - AVG(total_orders) OVER ()) / NULLIF(STDDEV(total_orders) OVER (), 0) AS norm_orders,
        (total_amount - AVG(total_amount) OVER ()) / NULLIF(STDDEV(total_amount) OVER (), 0) AS norm_amount,
        (last_visit_days - AVG(last_visit_days) OVER ()) / NULLIF(STDDEV(last_visit_days) OVER (), 0) AS norm_recency
    FROM user_features
),
initial_clusters AS (
    SELECT
        user_id,
        norm_orders,
        norm_amount,
        norm_recency,
        NTILE(5) OVER (ORDER BY norm_orders, norm_amount, norm_recency) AS cluster_id
    FROM normalized_features
)
SELECT
    cluster_id,
    COUNT(*) AS user_count,
    AVG(norm_orders) AS avg_norm_orders,
    AVG(norm_amount) AS avg_norm_amount,
    AVG(norm_recency) AS avg_norm_recency
FROM initial_clusters
GROUP BY cluster_id
ORDER BY cluster_id;
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
