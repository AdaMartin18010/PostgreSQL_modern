# PostgreSQL æ—¥å¿—åˆ†æç»¼åˆæ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | æ—¥å¿—åˆ†æ | æ—¶é—´åºåˆ—
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL æ—¥å¿—åˆ†æç»¼åˆæ¡ˆä¾‹](#postgresql-æ—¥å¿—åˆ†æç»¼åˆæ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¡ˆä¾‹æ¦‚è¿°](#æ¡ˆä¾‹æ¦‚è¿°)
  - [1. æ•°æ®å‡†å¤‡](#1-æ•°æ®å‡†å¤‡)
  - [2. é”™è¯¯æ—¥å¿—åˆ†æ](#2-é”™è¯¯æ—¥å¿—åˆ†æ)
  - [3. è®¿é—®æ¨¡å¼åˆ†æ](#3-è®¿é—®æ¨¡å¼åˆ†æ)
  - [4. æ€§èƒ½åˆ†æ](#4-æ€§èƒ½åˆ†æ)
  - [5. å¼‚å¸¸æ£€æµ‹](#5-å¼‚å¸¸æ£€æµ‹)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹ç»¼åˆè¿ç”¨æ—¶é—´åºåˆ—åˆ†æã€èšåˆç®—æ³•ã€å¼‚å¸¸æ£€æµ‹ç­‰æŠ€æœ¯ï¼Œå¯¹åº”ç”¨æ—¥å¿—è¿›è¡Œå…¨é¢åˆ†æã€‚

---

## 1. æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºæ—¥å¿—æ•°æ®è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'application_logs') THEN
            RAISE WARNING 'è¡¨ application_logs å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
            DROP TABLE application_logs CASCADE;
        END IF;

        CREATE TABLE application_logs (
            log_id SERIAL PRIMARY KEY,
            timestamp TIMESTAMP NOT NULL,
            log_level VARCHAR(20) NOT NULL,
            service_name VARCHAR(50) NOT NULL,
            endpoint VARCHAR(200),
            status_code INTEGER,
            response_time_ms NUMERIC(10, 2),
            error_message TEXT,
            user_id INTEGER,
            ip_address INET
        );

        -- æ’å…¥ç¤ºä¾‹æ—¥å¿—æ•°æ®
        INSERT INTO application_logs (timestamp, log_level, service_name, endpoint, status_code, response_time_ms, user_id, ip_address) VALUES
            ('2024-01-01 10:00:00', 'INFO', 'api-service', '/api/users', 200, 45.5, 1, '192.168.1.1'),
            ('2024-01-01 10:00:05', 'INFO', 'api-service', '/api/products', 200, 32.1, 2, '192.168.1.2'),
            ('2024-01-01 10:00:10', 'ERROR', 'api-service', '/api/orders', 500, 1200.0, NULL, '192.168.1.3'),
            ('2024-01-01 10:00:15', 'INFO', 'api-service', '/api/users', 200, 38.7, 3, '192.168.1.1'),
            ('2024-01-01 10:00:20', 'WARN', 'api-service', '/api/products', 404, 25.3, NULL, '192.168.1.4'),
            ('2024-01-01 10:00:25', 'INFO', 'api-service', '/api/orders', 200, 67.2, 4, '192.168.1.5'),
            ('2024-01-01 10:00:30', 'ERROR', 'api-service', '/api/users', 500, 1500.0, 5, '192.168.1.6'),
            ('2024-01-01 10:00:35', 'INFO', 'api-service', '/api/products', 200, 29.8, 1, '192.168.1.1'),
            ('2024-01-01 10:00:40', 'INFO', 'api-service', '/api/orders', 200, 55.4, 2, '192.168.1.2'),
            ('2024-01-01 10:00:45', 'INFO', 'api-service', '/api/users', 200, 42.1, 3, '192.168.1.3');

        RAISE NOTICE 'æ—¥å¿—æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 2. é”™è¯¯æ—¥å¿—åˆ†æ

```sql
-- é”™è¯¯æ—¥å¿—åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'application_logs') THEN
            RAISE WARNING 'è¡¨ application_logs ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œé”™è¯¯æ—¥å¿—åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œé”™è¯¯æ—¥å¿—åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é”™è¯¯æ—¥å¿—åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é”™è¯¯æ—¥å¿—ç»Ÿè®¡
SELECT
    log_level,
    COUNT(*) AS log_count,
    COUNT(*) FILTER (WHERE status_code >= 500) AS error_count,
    COUNT(DISTINCT endpoint) AS affected_endpoints,
    AVG(response_time_ms) AS avg_response_time,
    MAX(response_time_ms) AS max_response_time
FROM application_logs
WHERE log_level IN ('ERROR', 'WARN')
GROUP BY log_level
ORDER BY log_count DESC;

-- é”™è¯¯ç«¯ç‚¹æ’è¡Œ
SELECT
    endpoint,
    COUNT(*) AS error_count,
    COUNT(DISTINCT DATE_TRUNC('hour', timestamp)) AS error_hours,
    AVG(response_time_ms) AS avg_response_time,
    MAX(response_time_ms) AS max_response_time,
    ARRAY_AGG(DISTINCT status_code ORDER BY status_code) AS status_codes
FROM application_logs
WHERE log_level = 'ERROR'
GROUP BY endpoint
ORDER BY error_count DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    endpoint,
    COUNT(*) AS error_count
FROM application_logs
WHERE log_level = 'ERROR'
GROUP BY endpoint;
```

---

## 3. è®¿é—®æ¨¡å¼åˆ†æ

```sql
-- è®¿é—®æ¨¡å¼åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'application_logs') THEN
            RAISE WARNING 'è¡¨ application_logs ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè®¿é—®æ¨¡å¼åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œè®¿é—®æ¨¡å¼åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¿é—®æ¨¡å¼åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŒ‰å°æ—¶ç»Ÿè®¡è®¿é—®é‡
SELECT
    DATE_TRUNC('hour', timestamp) AS hour,
    COUNT(*) AS request_count,
    COUNT(DISTINCT user_id) AS unique_users,
    COUNT(DISTINCT ip_address) AS unique_ips,
    COUNT(*) FILTER (WHERE status_code >= 200 AND status_code < 300) AS success_count,
    COUNT(*) FILTER (WHERE status_code >= 400) AS error_count,
    AVG(response_time_ms) AS avg_response_time
FROM application_logs
GROUP BY DATE_TRUNC('hour', timestamp)
ORDER BY hour;

-- ç«¯ç‚¹è®¿é—®ç»Ÿè®¡
SELECT
    endpoint,
    COUNT(*) AS total_requests,
    COUNT(DISTINCT user_id) AS unique_users,
    AVG(response_time_ms) AS avg_response_time,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time_ms) AS p95_response_time,
    COUNT(*) FILTER (WHERE status_code >= 200 AND status_code < 300) AS success_count,
    COUNT(*) FILTER (WHERE status_code >= 400) AS error_count,
    ROUND((COUNT(*) FILTER (WHERE status_code >= 200 AND status_code < 300)::numeric / COUNT(*) * 100)::numeric, 2) AS success_rate
FROM application_logs
WHERE endpoint IS NOT NULL
GROUP BY endpoint
ORDER BY total_requests DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('hour', timestamp) AS hour,
    COUNT(*) AS request_count
FROM application_logs
GROUP BY DATE_TRUNC('hour', timestamp);
```

---

## 4. æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'application_logs') THEN
            RAISE WARNING 'è¡¨ application_logs ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ€§èƒ½åˆ†æ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œæ€§èƒ½åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ€§èƒ½åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å“åº”æ—¶é—´åˆ†æ
WITH response_time_stats AS (
    SELECT
        endpoint,
        response_time_ms,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY response_time_ms) OVER (PARTITION BY endpoint) AS median_time,
        AVG(response_time_ms) OVER (PARTITION BY endpoint) AS avg_time,
        STDDEV(response_time_ms) OVER (PARTITION BY endpoint) AS stddev_time
    FROM application_logs
    WHERE response_time_ms IS NOT NULL
)
SELECT
    endpoint,
    COUNT(*) AS request_count,
    ROUND(AVG(response_time_ms)::numeric, 2) AS avg_response_time,
    ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY response_time_ms)::numeric, 2) AS median_response_time,
    ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time_ms)::numeric, 2) AS p95_response_time,
    ROUND(PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY response_time_ms)::numeric, 2) AS p99_response_time,
    ROUND(STDDEV(response_time_ms)::numeric, 2) AS stddev_response_time,
    COUNT(*) FILTER (WHERE response_time_ms > avg_time + 2 * stddev_time) AS slow_requests
FROM application_logs
WHERE response_time_ms IS NOT NULL
GROUP BY endpoint
ORDER BY avg_response_time DESC;

-- æ€§èƒ½è¶‹åŠ¿åˆ†æï¼ˆç§»åŠ¨å¹³å‡ï¼‰
WITH hourly_performance AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        AVG(response_time_ms) AS avg_response_time
    FROM application_logs
    WHERE response_time_ms IS NOT NULL
    GROUP BY DATE_TRUNC('hour', timestamp)
)
SELECT
    hour,
    ROUND(avg_response_time::numeric, 2) AS avg_response_time,
    ROUND(AVG(avg_response_time) OVER (
        ORDER BY hour
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    )::numeric, 2) AS moving_avg_3hours
FROM hourly_performance
ORDER BY hour;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    endpoint,
    AVG(response_time_ms) AS avg_response_time
FROM application_logs
WHERE response_time_ms IS NOT NULL
GROUP BY endpoint;
```

---

## 5. å¼‚å¸¸æ£€æµ‹

```sql
-- å¼‚å¸¸æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'application_logs') THEN
            RAISE WARNING 'è¡¨ application_logs ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿›è¡Œå¼‚å¸¸æ£€æµ‹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼‚å¸¸æ£€æµ‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨IQRæ–¹æ³•æ£€æµ‹å¼‚å¸¸å“åº”æ—¶é—´
WITH response_time_stats AS (
    SELECT
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY response_time_ms) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY response_time_ms) AS q3,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY response_time_ms) AS median,
        AVG(response_time_ms) AS mean
    FROM application_logs
    WHERE response_time_ms IS NOT NULL
),
outlier_detection AS (
    SELECT
        al.log_id,
        al.timestamp,
        al.endpoint,
        al.response_time_ms,
        rts.mean,
        rts.median,
        rts.q1,
        rts.q3,
        rts.q3 - rts.q1 AS iqr,
        rts.q1 - 1.5 * (rts.q3 - rts.q1) AS lower_bound,
        rts.q3 + 1.5 * (rts.q3 - rts.q1) AS upper_bound
    FROM application_logs al
    CROSS JOIN response_time_stats rts
    WHERE al.response_time_ms IS NOT NULL
)
SELECT
    log_id,
    timestamp,
    endpoint,
    ROUND(response_time_ms::numeric, 2) AS response_time_ms,
    ROUND(mean::numeric, 2) AS mean_response_time,
    ROUND(median::numeric, 2) AS median_response_time,
    ROUND(lower_bound::numeric, 2) AS lower_bound,
    ROUND(upper_bound::numeric, 2) AS upper_bound,
    CASE
        WHEN response_time_ms < lower_bound THEN 'Lower Outlier'
        WHEN response_time_ms > upper_bound THEN 'Upper Outlier'
        ELSE 'Normal'
    END AS anomaly_status
FROM outlier_detection
WHERE response_time_ms < lower_bound OR response_time_ms > upper_bound
ORDER BY response_time_ms DESC;

-- é”™è¯¯ç‡å¼‚å¸¸æ£€æµ‹
WITH hourly_error_rates AS (
    SELECT
        DATE_TRUNC('hour', timestamp) AS hour,
        COUNT(*) FILTER (WHERE status_code >= 500)::numeric / COUNT(*) AS error_rate
    FROM application_logs
    GROUP BY DATE_TRUNC('hour', timestamp)
),
error_rate_stats AS (
    SELECT
        AVG(error_rate) AS mean_error_rate,
        STDDEV(error_rate) AS stddev_error_rate
    FROM hourly_error_rates
)
SELECT
    her.hour,
    ROUND(her.error_rate::numeric, 4) AS error_rate,
    ROUND(ers.mean_error_rate::numeric, 4) AS mean_error_rate,
    ROUND((ers.mean_error_rate + 2 * ers.stddev_error_rate)::numeric, 4) AS threshold,
    CASE
        WHEN her.error_rate > ers.mean_error_rate + 2 * ers.stddev_error_rate THEN 'High Error Rate'
        ELSE 'Normal'
    END AS anomaly_status
FROM hourly_error_rates her
CROSS JOIN error_rate_stats ers
WHERE her.error_rate > ers.mean_error_rate + 2 * ers.stddev_error_rate
ORDER BY her.hour;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY response_time_ms) AS q3
FROM application_logs
WHERE response_time_ms IS NOT NULL;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨timestamp, log_level, endpointä¸Šåˆ›å»ºç´¢å¼•
2. **åˆ†åŒºè¡¨**: æŒ‰æ—¶é—´åˆ†åŒºæ—¥å¿—è¡¨
3. **å½’æ¡£ç­–ç•¥**: å®šæœŸå½’æ¡£å†å²æ—¥å¿—

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ—¥å¿—æ ¼å¼**: ç»Ÿä¸€æ—¥å¿—æ ¼å¼ä¾¿äºåˆ†æ
2. **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§é”™è¯¯å’Œæ€§èƒ½æŒ‡æ ‡
3. **å‘Šè­¦æœºåˆ¶**: è®¾ç½®å¼‚å¸¸å‘Šè­¦é˜ˆå€¼
4. **æ•°æ®ä¿ç•™**: åˆç†è®¾ç½®æ—¥å¿—ä¿ç•™æœŸé™

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
