# PostgreSQL ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—ç»¼åˆæ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | ä¸šåŠ¡æŒ‡æ ‡ | KPIè®¡ç®—
> **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—ç»¼åˆæ¡ˆä¾‹](#postgresql-ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—ç»¼åˆæ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¡ˆä¾‹æ¦‚è¿°](#æ¡ˆä¾‹æ¦‚è¿°)
  - [1. æ•°æ®å‡†å¤‡](#1-æ•°æ®å‡†å¤‡)
  - [2. æ”¶å…¥æŒ‡æ ‡](#2-æ”¶å…¥æŒ‡æ ‡)
  - [3. ç”¨æˆ·æŒ‡æ ‡](#3-ç”¨æˆ·æŒ‡æ ‡)
  - [4. è¿è¥æŒ‡æ ‡](#4-è¿è¥æŒ‡æ ‡)
  - [5. ç»¼åˆä»ªè¡¨æ¿](#5-ç»¼åˆä»ªè¡¨æ¿)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

---

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹ç»¼åˆè¿ç”¨èšåˆç®—æ³•ã€çª—å£å‡½æ•°ã€æ—¶é—´åºåˆ—åˆ†æç­‰æŠ€æœ¯ï¼Œè®¡ç®—å„ç±»ä¸šåŠ¡å…³é”®æŒ‡æ ‡ï¼ˆKPIï¼‰ã€‚

---

## 1. æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºä¸šåŠ¡æ•°æ®è¡¨ç»“æ„ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºè®¢å•è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_orders') THEN
            DROP TABLE business_orders CASCADE;
        END IF;

        CREATE TABLE business_orders (
            order_id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL,
            order_date DATE NOT NULL,
            order_amount NUMERIC(10, 2) NOT NULL,
            order_status VARCHAR(20) NOT NULL,
            channel VARCHAR(50)
        );

        -- åˆ›å»ºç”¨æˆ·è¡¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_users') THEN
            DROP TABLE business_users CASCADE;
        END IF;

        CREATE TABLE business_users (
            user_id SERIAL PRIMARY KEY,
            registration_date DATE NOT NULL,
            user_type VARCHAR(20) NOT NULL
        );

        -- æ’å…¥ç¤ºä¾‹æ•°æ®
        INSERT INTO business_users (registration_date, user_type) VALUES
            ('2023-01-01', 'premium'),
            ('2023-02-01', 'standard'),
            ('2023-03-01', 'premium'),
            ('2023-04-01', 'standard'),
            ('2023-05-01', 'premium');

        INSERT INTO business_orders (user_id, order_date, order_amount, order_status, channel) VALUES
            (1, '2024-01-01', 1000.00, 'completed', 'web'),
            (1, '2024-01-15', 500.00, 'completed', 'mobile'),
            (2, '2024-01-05', 800.00, 'completed', 'web'),
            (2, '2024-01-20', 600.00, 'pending', 'mobile'),
            (3, '2024-01-10', 1200.00, 'completed', 'web'),
            (4, '2024-01-12', 400.00, 'completed', 'mobile'),
            (5, '2024-01-18', 900.00, 'completed', 'web'),
            (1, '2024-02-01', 750.00, 'completed', 'web'),
            (2, '2024-02-05', 550.00, 'completed', 'mobile'),
            (3, '2024-02-10', 1100.00, 'completed', 'web');

        RAISE NOTICE 'ä¸šåŠ¡æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 2. æ”¶å…¥æŒ‡æ ‡

```sql
-- æ”¶å…¥æŒ‡æ ‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_orders') THEN
            RAISE WARNING 'è¡¨ business_orders ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—æ”¶å…¥æŒ‡æ ‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—æ”¶å…¥æŒ‡æ ‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶å…¥æŒ‡æ ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€»æ”¶å…¥ï¼ˆGMVï¼‰
SELECT
    'Total Revenue (GMV)' AS metric_name,
    SUM(order_amount) FILTER (WHERE order_status = 'completed') AS metric_value,
    'CNY' AS unit
FROM business_orders;

-- æœˆåº¦æ”¶å…¥è¶‹åŠ¿
SELECT
    DATE_TRUNC('month', order_date) AS month,
    SUM(order_amount) FILTER (WHERE order_status = 'completed') AS monthly_revenue,
    COUNT(*) FILTER (WHERE order_status = 'completed') AS order_count,
    AVG(order_amount) FILTER (WHERE order_status = 'completed') AS avg_order_value,
    SUM(order_amount) FILTER (WHERE order_status = 'completed') -
    LAG(SUM(order_amount) FILTER (WHERE order_status = 'completed')) OVER (ORDER BY DATE_TRUNC('month', order_date)) AS revenue_growth
FROM business_orders
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;

-- æ¸ é“æ”¶å…¥åˆ†æ
SELECT
    channel,
    SUM(order_amount) FILTER (WHERE order_status = 'completed') AS channel_revenue,
    COUNT(*) FILTER (WHERE order_status = 'completed') AS order_count,
    AVG(order_amount) FILTER (WHERE order_status = 'completed') AS avg_order_value,
    ROUND((SUM(order_amount) FILTER (WHERE order_status = 'completed')::numeric /
           NULLIF(SUM(SUM(order_amount) FILTER (WHERE order_status = 'completed')) OVER (), 0) * 100)::numeric, 2) AS revenue_percentage
FROM business_orders
GROUP BY channel
ORDER BY channel_revenue DESC;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('month', order_date) AS month,
    SUM(order_amount) FILTER (WHERE order_status = 'completed') AS monthly_revenue
FROM business_orders
GROUP BY DATE_TRUNC('month', order_date);
```

---

## 3. ç”¨æˆ·æŒ‡æ ‡

```sql
-- ç”¨æˆ·æŒ‡æ ‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_users') THEN
            RAISE WARNING 'è¡¨ business_users ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç”¨æˆ·æŒ‡æ ‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç”¨æˆ·æŒ‡æ ‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç”¨æˆ·æŒ‡æ ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç”¨æˆ·æ€»æ•°å’Œæ´»è·ƒç”¨æˆ·
SELECT
    'Total Users' AS metric_name,
    COUNT(*) AS metric_value,
    'users' AS unit
FROM business_users
UNION ALL
SELECT
    'Active Users (Last 30 Days)',
    COUNT(DISTINCT bo.user_id),
    'users'
FROM business_orders bo
WHERE bo.order_date >= CURRENT_DATE - INTERVAL '30 days'
    AND bo.order_status = 'completed';

-- ç”¨æˆ·ä»·å€¼åˆ†æ
WITH user_value AS (
    SELECT
        bu.user_id,
        bu.user_type,
        COUNT(DISTINCT bo.order_id) FILTER (WHERE bo.order_status = 'completed') AS order_count,
        SUM(bo.order_amount) FILTER (WHERE bo.order_status = 'completed') AS total_value,
        AVG(bo.order_amount) FILTER (WHERE bo.order_status = 'completed') AS avg_order_value
    FROM business_users bu
    LEFT JOIN business_orders bo ON bu.user_id = bo.user_id
    GROUP BY bu.user_id, bu.user_type
)
SELECT
    user_type,
    COUNT(*) AS user_count,
    ROUND(AVG(order_count)::numeric, 2) AS avg_orders_per_user,
    ROUND(AVG(total_value)::numeric, 2) AS avg_user_value,
    ROUND(SUM(total_value)::numeric, 2) AS total_user_value
FROM user_value
GROUP BY user_type
ORDER BY avg_user_value DESC;

-- ç”¨æˆ·ç•™å­˜ç‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
WITH user_first_order AS (
    SELECT
        user_id,
        MIN(order_date) AS first_order_date
    FROM business_orders
    WHERE order_status = 'completed'
    GROUP BY user_id
),
retention_analysis AS (
    SELECT
        DATE_TRUNC('month', ufo.first_order_date) AS cohort_month,
        COUNT(DISTINCT ufo.user_id) AS cohort_size,
        COUNT(DISTINCT CASE WHEN bo.order_date >= ufo.first_order_date + INTERVAL '1 month'
            AND bo.order_date < ufo.first_order_date + INTERVAL '2 months' THEN bo.user_id END) AS month_1_retained,
        COUNT(DISTINCT CASE WHEN bo.order_date >= ufo.first_order_date + INTERVAL '2 months'
            AND bo.order_date < ufo.first_order_date + INTERVAL '3 months' THEN bo.user_id END) AS month_2_retained
    FROM user_first_order ufo
    LEFT JOIN business_orders bo ON ufo.user_id = bo.user_id AND bo.order_status = 'completed'
    GROUP BY DATE_TRUNC('month', ufo.first_order_date)
)
SELECT
    cohort_month,
    cohort_size,
    month_1_retained,
    ROUND((month_1_retained::numeric / NULLIF(cohort_size, 0) * 100)::numeric, 2) AS month_1_retention_rate,
    month_2_retained,
    ROUND((month_2_retained::numeric / NULLIF(cohort_size, 0) * 100)::numeric, 2) AS month_2_retention_rate
FROM retention_analysis
ORDER BY cohort_month;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    user_id,
    COUNT(DISTINCT order_id) AS order_count,
    SUM(order_amount) AS total_value
FROM business_orders
WHERE order_status = 'completed'
GROUP BY user_id;
```

---

## 4. è¿è¥æŒ‡æ ‡

```sql
-- è¿è¥æŒ‡æ ‡è®¡ç®—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_orders') THEN
            RAISE WARNING 'è¡¨ business_orders ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—è¿è¥æŒ‡æ ‡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—è¿è¥æŒ‡æ ‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¿è¥æŒ‡æ ‡è®¡ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¢å•è½¬åŒ–ç‡
SELECT
    'Order Conversion Rate' AS metric_name,
    ROUND((COUNT(*) FILTER (WHERE order_status = 'completed')::numeric / COUNT(*) * 100)::numeric, 2) AS metric_value,
    '%' AS unit
FROM business_orders;

-- å¹³å‡è®¢å•ä»·å€¼ï¼ˆAOVï¼‰
SELECT
    'Average Order Value (AOV)' AS metric_name,
    ROUND(AVG(order_amount) FILTER (WHERE order_status = 'completed')::numeric, 2) AS metric_value,
    'CNY' AS unit
FROM business_orders;

-- å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰ç®€åŒ–ç‰ˆ
WITH user_lifetime_value AS (
    SELECT
        user_id,
        COUNT(DISTINCT order_id) FILTER (WHERE order_status = 'completed') AS total_orders,
        SUM(order_amount) FILTER (WHERE order_status = 'completed') AS lifetime_value,
        MIN(order_date) FILTER (WHERE order_status = 'completed') AS first_order_date,
        MAX(order_date) FILTER (WHERE order_status = 'completed') AS last_order_date
    FROM business_orders
    GROUP BY user_id
)
SELECT
    'Average Customer Lifetime Value' AS metric_name,
    ROUND(AVG(lifetime_value)::numeric, 2) AS metric_value,
    'CNY' AS unit
FROM user_lifetime_value
WHERE lifetime_value > 0;

-- æœˆåº¦è¿è¥æŒ‡æ ‡æ±‡æ€»
SELECT
    DATE_TRUNC('month', order_date) AS month,
    COUNT(*) AS total_orders,
    COUNT(*) FILTER (WHERE order_status = 'completed') AS completed_orders,
    ROUND((COUNT(*) FILTER (WHERE order_status = 'completed')::numeric / COUNT(*) * 100)::numeric, 2) AS conversion_rate,
    ROUND(AVG(order_amount) FILTER (WHERE order_status = 'completed')::numeric, 2) AS avg_order_value,
    COUNT(DISTINCT user_id) FILTER (WHERE order_status = 'completed') AS unique_customers
FROM business_orders
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY month;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    DATE_TRUNC('month', order_date) AS month,
    COUNT(*) FILTER (WHERE order_status = 'completed') AS completed_orders,
    AVG(order_amount) FILTER (WHERE order_status = 'completed') AS avg_order_value
FROM business_orders
GROUP BY DATE_TRUNC('month', order_date);
```

---

## 5. ç»¼åˆä»ªè¡¨æ¿

```sql
-- ç»¼åˆä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'business_orders') THEN
            RAISE WARNING 'è¡¨ business_orders ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆç»¼åˆä»ªè¡¨æ¿';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç”Ÿæˆç»¼åˆä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»¼åˆä»ªè¡¨æ¿ç”Ÿæˆå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç»¼åˆä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿
WITH revenue_metrics AS (
    SELECT
        SUM(order_amount) FILTER (WHERE order_status = 'completed') AS total_revenue,
        AVG(order_amount) FILTER (WHERE order_status = 'completed') AS avg_order_value,
        COUNT(*) FILTER (WHERE order_status = 'completed') AS total_orders
    FROM business_orders
),
user_metrics AS (
    SELECT
        COUNT(DISTINCT bu.user_id) AS total_users,
        COUNT(DISTINCT bo.user_id) FILTER (WHERE bo.order_status = 'completed' AND bo.order_date >= CURRENT_DATE - INTERVAL '30 days') AS active_users_30d
    FROM business_users bu
    LEFT JOIN business_orders bo ON bu.user_id = bo.user_id
),
operational_metrics AS (
    SELECT
        COUNT(*) FILTER (WHERE order_status = 'completed')::numeric / COUNT(*) * 100 AS conversion_rate,
        COUNT(DISTINCT user_id) FILTER (WHERE order_status = 'completed') AS paying_customers
    FROM business_orders
)
SELECT
    'Revenue' AS category,
    'Total Revenue' AS metric_name,
    ROUND(rm.total_revenue::numeric, 2) AS metric_value,
    'CNY' AS unit
FROM revenue_metrics rm
UNION ALL
SELECT
    'Revenue',
    'Average Order Value',
    ROUND(rm.avg_order_value::numeric, 2),
    'CNY'
FROM revenue_metrics rm
UNION ALL
SELECT
    'Revenue',
    'Total Orders',
    rm.total_orders,
    'orders'
FROM revenue_metrics rm
UNION ALL
SELECT
    'Users',
    'Total Users',
    um.total_users,
    'users'
FROM user_metrics um
UNION ALL
SELECT
    'Users',
    'Active Users (30d)',
    um.active_users_30d,
    'users'
FROM user_metrics um
UNION ALL
SELECT
    'Operations',
    'Conversion Rate',
    ROUND(om.conversion_rate::numeric, 2),
    '%'
FROM operational_metrics om
UNION ALL
SELECT
    'Operations',
    'Paying Customers',
    om.paying_customers,
    'users'
FROM operational_metrics om
ORDER BY category, metric_name;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    SUM(order_amount) FILTER (WHERE order_status = 'completed') AS total_revenue,
    COUNT(*) FILTER (WHERE order_status = 'completed') AS total_orders
FROM business_orders;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**: åœ¨order_date, user_id, order_statusä¸Šåˆ›å»ºç´¢å¼•
2. **ç‰©åŒ–è§†å›¾**: å¯¹å¸¸ç”¨æŒ‡æ ‡åˆ›å»ºç‰©åŒ–è§†å›¾
3. **å®šæœŸæ›´æ–°**: å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯

## ğŸ¯ æœ€ä½³å®è·µ

1. **æŒ‡æ ‡å®šä¹‰**: æ˜ç¡®å®šä¹‰æ¯ä¸ªä¸šåŠ¡æŒ‡æ ‡çš„è®¡ç®—æ–¹æ³•
2. **æ•°æ®è´¨é‡**: ç¡®ä¿æ•°æ®å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
3. **å®æ—¶æ€§**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©å®æ—¶æˆ–æ‰¹é‡è®¡ç®—
4. **å¯è§†åŒ–**: å°†æŒ‡æ ‡ç»“æœå¯è§†åŒ–å±•ç¤º

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
