---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\04-Distributed\10-åˆ†å¸ƒå¼é”å®æˆ˜.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLåˆ†å¸ƒå¼é”å®æˆ˜

## 1. å’¨è¯¢é”ï¼ˆAdvisory Lockï¼‰

### 1.1 åŸºç¡€ä½¿ç”¨

```sql
-- ä¼šè¯çº§é”ï¼ˆæŒç»­åˆ°è¿æ¥å…³é—­ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_lock_id BIGINT := 12345;
    v_lock_acquired BOOLEAN;
BEGIN
    BEGIN
        -- å°è¯•è·å–é”
        SELECT pg_try_advisory_lock(v_lock_id) INTO v_lock_acquired;

        IF v_lock_acquired THEN
            RAISE NOTICE 'é” % è·å–æˆåŠŸ', v_lock_id;
            -- æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
            -- ...
            -- é‡Šæ”¾é”
            PERFORM pg_advisory_unlock(v_lock_id);
            RAISE NOTICE 'é” % é‡Šæ”¾æˆåŠŸ', v_lock_id;
        ELSE
            RAISE WARNING 'é” % å·²è¢«å ç”¨', v_lock_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            -- ç¡®ä¿é‡Šæ”¾é”
            BEGIN
                PERFORM pg_advisory_unlock(v_lock_id);
            EXCEPTION
                WHEN OTHERS THEN
                    NULL;
            END;
            RAISE WARNING 'é”æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- äº‹åŠ¡çº§é”ï¼ˆæŒç»­åˆ°äº‹åŠ¡ç»“æŸï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_lock_id BIGINT := 12345;
    v_lock_acquired BOOLEAN;
BEGIN
    BEGIN
        BEGIN;
        -- å°è¯•è·å–äº‹åŠ¡çº§é”
        SELECT pg_try_advisory_xact_lock(v_lock_id) INTO v_lock_acquired;

        IF v_lock_acquired THEN
            RAISE NOTICE 'äº‹åŠ¡çº§é” % è·å–æˆåŠŸ', v_lock_id;
            -- æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
            -- ...
            COMMIT;  -- è‡ªåŠ¨é‡Šæ”¾
            RAISE NOTICE 'äº‹åŠ¡æäº¤ï¼Œé”è‡ªåŠ¨é‡Šæ”¾';
        ELSE
            ROLLBACK;
            RAISE WARNING 'äº‹åŠ¡çº§é” % è·å–å¤±è´¥', v_lock_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE WARNING 'äº‹åŠ¡çº§é”æ“ä½œå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å°è¯•è·å–é”ï¼ˆéé˜»å¡ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_lock_id BIGINT := 12345;
    v_lock_acquired BOOLEAN;
BEGIN
    BEGIN
        SELECT pg_try_advisory_lock(v_lock_id) INTO v_lock_acquired;
        -- è¿”å› true: è·å–æˆåŠŸ
        -- è¿”å› false: é”å·²è¢«å ç”¨
        IF v_lock_acquired THEN
            RAISE NOTICE 'é” % è·å–æˆåŠŸ', v_lock_id;
        ELSE
            RAISE NOTICE 'é” % å·²è¢«å ç”¨', v_lock_id;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å°è¯•è·å–é”å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥é”çŠ¶æ€ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_locks WHERE locktype = 'advisory';
```

---

## 2. åˆ†å¸ƒå¼ä»»åŠ¡é”

### 2.2 å®šæ—¶ä»»åŠ¡äº’æ–¥

```python
import psycopg2
import hashlib

def run_distributed_job(job_name):
    """åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¿è¯ä»»åŠ¡åªè¿è¡Œä¸€æ¬¡"""

    # ç”Ÿæˆjob_nameçš„å”¯ä¸€ID
    lock_id = int(hashlib.md5(job_name.encode()).hexdigest()[:8], 16)

    conn = psycopg2.connect("dbname=mydb")
    cursor = conn.cursor()

    try:
        # å°è¯•è·å–é”
        cursor.execute("SELECT pg_try_advisory_lock(%s)", (lock_id,))
        acquired = cursor.fetchone()[0]

        if not acquired:
            print(f"ä»»åŠ¡ {job_name} å·²åœ¨å…¶ä»–èŠ‚ç‚¹è¿è¡Œ")
            return

        print(f"èŠ‚ç‚¹è·å–é”ï¼Œæ‰§è¡Œä»»åŠ¡: {job_name}")

        # æ‰§è¡Œä»»åŠ¡
        execute_job(job_name)

    finally:
        # é‡Šæ”¾é”
        cursor.execute("SELECT pg_advisory_unlock(%s)", (lock_id,))
        cursor.close()
        conn.close()

# å¤šèŠ‚ç‚¹ç¯å¢ƒ
# Node1: run_distributed_job("daily_report")  â†’ æ‰§è¡Œ
# Node2: run_distributed_job("daily_report")  â†’ è·³è¿‡ï¼ˆé”è¢«å ç”¨ï¼‰
```

### 2.2 é˜Ÿåˆ—æ¶ˆè´¹

```sql
-- ä»»åŠ¡é˜Ÿåˆ—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'task_queue') THEN
            CREATE TABLE task_queue (
                id BIGSERIAL PRIMARY KEY,
                task_name VARCHAR(100),
                payload JSONB,
                status VARCHAR(20) DEFAULT 'pending',
                worker_id VARCHAR(50),
                created_at TIMESTAMPTZ DEFAULT now(),
                started_at TIMESTAMPTZ,
                completed_at TIMESTAMPTZ
            );
            RAISE NOTICE 'è¡¨ task_queue åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ task_queue å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ task_queue å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_status') THEN
            CREATE INDEX idx_status ON task_queue(status) WHERE status = 'pending';
            RAISE NOTICE 'ç´¢å¼• idx_status åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_status å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼• idx_status å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM task_queue WHERE status = 'pending' LIMIT 10;
```

-- åˆ†å¸ƒå¼æ¶ˆè´¹è€…
CREATE OR REPLACE FUNCTION consume_task()
RETURNS TABLE(task_id BIGINT, task_name VARCHAR, payload JSONB)
LANGUAGE plpgsql AS $$
DECLARE
    v_task_id BIGINT;
BEGIN
    -- ä½¿ç”¨FOR UPDATE SKIP LOCKEDé¿å…é”å†²çª
    SELECT id INTO v_task_id
    FROM task_queue
    WHERE status = 'pending'
    ORDER BY created_at
    LIMIT 1
    FOR UPDATE SKIP LOCKED;

    IF v_task_id IS NULL THEN
        RETURN;
    END IF;

    -- ä½¿ç”¨å’¨è¯¢é”é˜²æ­¢å¹¶å‘
    IF NOT pg_try_advisory_lock(v_task_id) THEN
        RETURN;
    END IF;

    -- æ›´æ–°çŠ¶æ€
    UPDATE task_queue
    SET
        status = 'processing',
        worker_id = inet_client_addr()::TEXT,
        started_at = now()
    WHERE id = v_task_id
    RETURNING id, task_name, payload INTO task_id, task_name, payload;

    RETURN NEXT;

    -- æ³¨æ„: è°ƒç”¨è€…éœ€è¦åœ¨ä»»åŠ¡å®Œæˆåè°ƒç”¨ pg_advisory_unlock(task_id)
END;
$$;

-- Pythonæ¶ˆè´¹è€…
def worker():
    conn = psycopg2.connect("dbname=mydb")
    cursor = conn.cursor()

    while True:
        cursor.execute("SELECT * FROM consume_task()")
        task = cursor.fetchone()

        if not task:
            time.sleep(1)
            continue

        task_id, task_name, payload = task

        try:
            # æ‰§è¡Œä»»åŠ¡
            process_task(task_name, payload)

            # æ ‡è®°å®Œæˆ
            cursor.execute("""
                UPDATE task_queue
                SET status = 'completed', completed_at = now()
                WHERE id = %s
            """, (task_id,))
            conn.commit()

        except Exception as e:
            # æ ‡è®°å¤±è´¥
            cursor.execute("""
                UPDATE task_queue
                SET status = 'failed'
                WHERE id = %s
            """, (task_id,))
            conn.commit()

        finally:
            # é‡Šæ”¾é”
            cursor.execute("SELECT pg_advisory_unlock(%s)", (task_id,))

# å¤šä¸ªworkerå¹¶å‘è¿è¡Œï¼Œè‡ªåŠ¨åˆ†é…ä»»åŠ¡ï¼Œæ— å†²çª
```

---

## 3. åˆ†å¸ƒå¼é™æµ

```sql
-- é™æµè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'rate_limit') THEN
            CREATE TABLE rate_limit (
                key VARCHAR(100) PRIMARY KEY,
                count INT DEFAULT 0,
                window_start TIMESTAMPTZ DEFAULT now()
            );
            RAISE NOTICE 'è¡¨ rate_limit åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ rate_limit å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ rate_limit å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM rate_limit WHERE key = 'test_key';
```

-- é™æµå‡½æ•°
CREATE OR REPLACE FUNCTION check_rate_limit(
    p_key VARCHAR,
    p_max_requests INT,
    p_window_seconds INT
)
RETURNS BOOLEAN
LANGUAGE plpgsql AS $$
DECLARE
    v_count INT;
    v_window_start TIMESTAMPTZ;
BEGIN
    -- ä½¿ç”¨å’¨è¯¢é”ä¿è¯åŸå­æ€§
    PERFORM pg_advisory_lock(hashtext(p_key)::INT);

    SELECT count, window_start INTO v_count, v_window_start
    FROM rate_limit
    WHERE key = p_key;

    IF v_count IS NULL OR v_window_start < now() - (p_window_seconds || ' seconds')::INTERVAL THEN
        -- æ–°çª—å£
        INSERT INTO rate_limit (key, count, window_start)
        VALUES (p_key, 1, now())
        ON CONFLICT (key) DO UPDATE
        SET count = 1, window_start = now();

        PERFORM pg_advisory_unlock(hashtext(p_key)::INT);
        RETURN true;
    END IF;

    IF v_count >= p_max_requests THEN
        -- è¶…å‡ºé™åˆ¶
        PERFORM pg_advisory_unlock(hashtext(p_key)::INT);
        RETURN false;
    END IF;

    -- å¢åŠ è®¡æ•°
    UPDATE rate_limit SET count = count + 1 WHERE key = p_key;

    PERFORM pg_advisory_unlock(hashtext(p_key)::INT);
    RETURN true;
END;
$$;

-- ä½¿ç”¨
SELECT check_rate_limit('user:123:api', 100, 60);  -- æ¯åˆ†é’Ÿ100æ¬¡
-- true: å…è®¸
-- false: æ‹’ç»ï¼ˆè¶…é™ï¼‰
```

---

## 4. åˆ†å¸ƒå¼IDç”Ÿæˆ

```sql
-- Snowflake IDç”Ÿæˆå™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'id_generator') THEN
            CREATE TABLE id_generator (
                worker_id INT PRIMARY KEY,
                sequence INT DEFAULT 0,
                last_timestamp BIGINT DEFAULT 0
            );
            RAISE NOTICE 'è¡¨ id_generator åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ id_generator å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ id_generator å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM id_generator WHERE worker_id = 1;
```

CREATE OR REPLACE FUNCTION generate_snowflake_id(p_worker_id INT)
RETURNS BIGINT
LANGUAGE plpgsql AS $$
DECLARE
    v_timestamp BIGINT;
    v_sequence INT;
    v_last_timestamp BIGINT;
    v_epoch BIGINT := 1609459200000; -- 2021-01-01 00:00:00
BEGIN
    -- å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    v_timestamp := (EXTRACT(EPOCH FROM now()) * 1000)::BIGINT - v_epoch;

    -- ä½¿ç”¨å’¨è¯¢é”
    PERFORM pg_advisory_lock(p_worker_id);

    SELECT sequence, last_timestamp INTO v_sequence, v_last_timestamp
    FROM id_generator
    WHERE worker_id = p_worker_id;

    IF v_timestamp = v_last_timestamp THEN
        -- åŒä¸€æ¯«ç§’å†…ï¼Œé€’å¢åºåˆ—å·
        v_sequence := (v_sequence + 1) & 4095;  -- 12ä½åºåˆ—å·

        IF v_sequence = 0 THEN
            -- åºåˆ—å·è€—å°½ï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
            PERFORM pg_sleep(0.001);
            v_timestamp := (EXTRACT(EPOCH FROM now()) * 1000)::BIGINT - v_epoch;
        END IF;
    ELSE
        -- æ–°çš„æ¯«ç§’ï¼Œé‡ç½®åºåˆ—å·
        v_sequence := 0;
    END IF;

    -- æ›´æ–°çŠ¶æ€
    UPDATE id_generator
    SET sequence = v_sequence, last_timestamp = v_timestamp
    WHERE worker_id = p_worker_id;

    PERFORM pg_advisory_unlock(p_worker_id);

    -- ç»„è£…ID: 41ä½æ—¶é—´æˆ³ + 10ä½worker_id + 12ä½åºåˆ—å·
    RETURN (v_timestamp << 22) | (p_worker_id << 12) | v_sequence;
END;
$$;

-- åˆå§‹åŒ–worker
INSERT INTO id_generator (worker_id) VALUES (1), (2), (3);

-- ç”ŸæˆID
SELECT generate_snowflake_id(1);
-- è¿”å›: 1234567890123456789
```

---

## 5. ä¹è§‚é”

```sql
-- ç‰ˆæœ¬å·ä¹è§‚é”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'accounts') THEN
            CREATE TABLE accounts (
                id SERIAL PRIMARY KEY,
                username VARCHAR(50),
                balance NUMERIC(10, 2),
                version INT DEFAULT 0
            );
            RAISE NOTICE 'è¡¨ accounts åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ accounts å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ accounts å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_account_id INT := 123;
    v_expected_version INT := 5;
    v_updated_rows INT;
BEGIN
    BEGIN
        UPDATE accounts
        SET
            balance = balance - 100,
            version = version + 1
        WHERE id = v_account_id
          AND version = v_expected_version;  -- å¿…é¡»åŒ¹é…å½“å‰ç‰ˆæœ¬

        -- æ£€æŸ¥å½±å“è¡Œæ•°
        GET DIAGNOSTICS v_updated_rows = ROW_COUNT;

        IF v_updated_rows = 0 THEN
            RAISE EXCEPTION 'å¹¶å‘å†²çªï¼Œè¯·é‡è¯•ã€‚è´¦æˆ·ID: %, æœŸæœ›ç‰ˆæœ¬: %', v_account_id, v_expected_version;
        ELSE
            RAISE NOTICE 'ä¹è§‚é”æ›´æ–°æˆåŠŸï¼Œè´¦æˆ·ID: %, æ–°ç‰ˆæœ¬: %', v_account_id, v_expected_version + 1;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¹è§‚é”æ›´æ–°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM accounts WHERE id = 123;
```

-- Pythonå®ç°
def transfer_optimistic(from_id, to_id, amount, max_retries=3):
    """ä¹è§‚é”è½¬è´¦"""

    for attempt in range(max_retries):
        try:
            # è¯»å–å½“å‰ç‰ˆæœ¬
            cursor.execute(
                "SELECT balance, version FROM accounts WHERE id = %s",
                (from_id,)
            )
            balance, version = cursor.fetchone()

            if balance < amount:
                raise ValueError("ä½™é¢ä¸è¶³")

            # å°è¯•æ›´æ–°
            cursor.execute("""
                UPDATE accounts
                SET balance = balance - %s, version = version + 1
                WHERE id = %s AND version = %s
            """, (amount, from_id, version))

            if cursor.rowcount == 0:
                # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
                conn.rollback()
                continue

            # å¯¹æ–¹è´¦æˆ·
            cursor.execute("""
                UPDATE accounts
                SET balance = balance + %s, version = version + 1
                WHERE id = %s
            """, (amount, to_id))

            conn.commit()
            return True

        except Exception as e:
            conn.rollback()
            if attempt == max_retries - 1:
                raise

    raise Exception("è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°")
```

---

## 6. æœ€ä½³å®è·µ

```text
é€‰æ‹©é”ç±»å‹:
âœ“ å’¨è¯¢é”: åˆ†å¸ƒå¼ä»»åŠ¡ã€ä¸´ç•ŒåŒº
âœ“ FOR UPDATE SKIP LOCKED: é˜Ÿåˆ—æ¶ˆè´¹
âœ“ ä¹è§‚é”: é«˜å¹¶å‘ã€å†²çªå°‘çš„åœºæ™¯
âœ“ æ‚²è§‚é”: å†²çªå¤šã€å¿…é¡»ä¸²è¡Œ

æ³¨æ„äº‹é¡¹:
âœ“ é”è¶…æ—¶æœºåˆ¶ï¼ˆé¿å…æ­»é”ï¼‰
âœ“ é”ç²’åº¦æœ€å°åŒ–
âœ“ é¿å…åµŒå¥—é”
âœ“ è®°å½•é”æŒæœ‰æ—¶é—´
âœ“ ç›‘æ§é”ç«äº‰

æ€§èƒ½ä¼˜åŒ–:
âœ“ ä½¿ç”¨äº‹åŠ¡çº§é”è€Œéä¼šè¯çº§
âœ“ å°½æ—©é‡Šæ”¾é”
âœ“ æ‰¹é‡æ“ä½œå‡å°‘é”æ¬¡æ•°
âœ“ åˆ†æ®µé”ï¼ˆå‡å°‘ç«äº‰ï¼‰
```

---

**å®Œæˆ**: PostgreSQLåˆ†å¸ƒå¼é”å®æˆ˜
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: å’¨è¯¢é”ã€åˆ†å¸ƒå¼ä»»åŠ¡ã€é˜Ÿåˆ—æ¶ˆè´¹ã€é™æµã€IDç”Ÿæˆã€ä¹è§‚é”ã€æœ€ä½³å®è·µ
