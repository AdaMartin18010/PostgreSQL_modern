---

> **📋 文档来源**: `docs\04-Distributed\07-逻辑复制分布式架构.md`
> **📅 复制日期**: 2025-12-22
> **⚠️ 注意**: 本文档为复制版本，原文件保持不变

---

# PostgreSQL 18 逻辑复制分布式架构

## 📋 目录

- [PostgreSQL 18 逻辑复制分布式架构](#postgresql-18-逻辑复制分布式架构)
  - [📋 目录](#-目录)
  - [1. 架构模式](#1-架构模式)
    - [1.1 发布订阅模型](#11-发布订阅模型)
  - [2. 基础配置](#2-基础配置)
    - [2.1 发布端配置](#21-发布端配置)
    - [2.2 订阅端配置](#22-订阅端配置)
  - [3. 高级特性](#3-高级特性)
    - [3.1 行过滤（PostgreSQL 18）](#31-行过滤postgresql-18)
    - [3.2 列过滤（PostgreSQL 18）](#32-列过滤postgresql-18)
    - [3.3 转换（Transform）](#33-转换transform)
  - [4. 架构模式](#4-架构模式)
    - [4.1 一对多（广播）](#41-一对多广播)
    - [4.2 多对一（聚合）](#42-多对一聚合)
    - [4.3 级联复制](#43-级联复制)
    - [4.4 双向复制](#44-双向复制)
  - [5. 冲突处理](#5-冲突处理)
    - [5.1 冲突类型](#51-冲突类型)
    - [5.2 冲突解决策略](#52-冲突解决策略)
  - [6. 监控](#6-监控)
    - [6.1 发布端监控](#61-发布端监控)
    - [6.2 订阅端监控](#62-订阅端监控)
  - [7. 运维操作](#7-运维操作)
    - [7.1 暂停/恢复](#71-暂停恢复)
    - [7.2 重置订阅](#72-重置订阅)
  - [8. 故障处理](#8-故障处理)
    - [8.1 复制中断](#81-复制中断)
    - [8.2 数据不一致](#82-数据不一致)
  - [9. 性能优化](#9-性能优化)

## 1. 架构模式

### 1.1 发布订阅模型

```text
┌──────────────────────────────────────────────────────┐
│          逻辑复制架构                                 │
├──────────────────────────────────────────────────────┤
│                                                      │
│  [Publisher (发布端)]                                │
│         │                                            │
│    WAL逻辑解码                                        │
│         │                                            │
│   [Replication Slot]                                 │
│         │                                            │
│    ┌────┴────┬────────┐                              │
│    │         │        │                              │
│ [Sub1]   [Sub2]   [Sub3]                             │
│ (订阅端1) (订阅端2) (订阅端3)                          │
│                                                      │
│  特点: 表级复制、过滤、转换                            │
└──────────────────────────────────────────────────────┘
```

---

## 2. 基础配置

### 2.1 发布端配置

```sql
-- 配置参数
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_replication_slots = 10;
ALTER SYSTEM SET max_wal_senders = 10;

-- 重启PostgreSQL
-- sudo systemctl restart postgresql

-- 创建发布
CREATE PUBLICATION my_pub FOR ALL TABLES;

-- 或指定表
CREATE PUBLICATION orders_pub FOR TABLE orders, order_items;

-- 带WHERE过滤（PostgreSQL 18增强）
CREATE PUBLICATION active_users_pub FOR TABLE users
WHERE (status = 'active');

-- 带列过滤（PostgreSQL 18新特性）
CREATE PUBLICATION user_pub FOR TABLE users (user_id, username, email);
-- 不包含敏感列: password, ssn

-- 查看发布
\dRp+
SELECT * FROM pg_publication;
```

### 2.2 订阅端配置

```sql
-- 创建相同Schema（或不同Schema）
-- 可以表名不同、列不同

-- 创建订阅
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=publisher_host port=5432 dbname=mydb user=replicator password=xxx'
PUBLICATION my_pub;

-- 查看订阅状态
\dRs+
SELECT * FROM pg_subscription;

-- 查看复制状态
SELECT * FROM pg_stat_subscription;
```

---

## 3. 高级特性

### 3.1 行过滤（PostgreSQL 18）

```sql
-- 发布端: 只复制特定行
CREATE PUBLICATION premium_users_pub FOR TABLE users
WHERE (subscription_type = 'premium');

-- 订阅端接收过滤后的数据
CREATE SUBSCRIPTION premium_sub
CONNECTION 'host=...'
PUBLICATION premium_users_pub;

-- 应用场景:
-- 1. 分区复制（按地区）
-- 2. 分级复制（按等级）
-- 3. 合规性（数据脱敏）
```

### 3.2 列过滤（PostgreSQL 18）

```sql
-- 只复制部分列
CREATE PUBLICATION user_basic_pub FOR TABLE users (
    user_id,
    username,
    email,
    created_at
);
-- 不复制password, credit_card等敏感信息

-- 订阅端
CREATE TABLE users_replica (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(100),
    email VARCHAR(255),
    created_at TIMESTAMPTZ
);

CREATE SUBSCRIPTION user_basic_sub
CONNECTION 'host=...'
PUBLICATION user_basic_pub;
```

### 3.3 转换（Transform）

```sql
-- PostgreSQL 18: 列转换
CREATE PUBLICATION masked_data_pub FOR TABLE sensitive_data;

-- 在订阅端应用转换触发器
CREATE OR REPLACE FUNCTION mask_sensitive_data()
RETURNS TRIGGER AS $$
BEGIN
    -- 脱敏处理
    NEW.email := substring(NEW.email, 1, 3) || '***@' ||
                 split_part(NEW.email, '@', 2);
    NEW.phone := '***' || substring(NEW.phone, 8);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_mask_data
    BEFORE INSERT OR UPDATE ON sensitive_data
    FOR EACH ROW EXECUTE FUNCTION mask_sensitive_data();
```

---

## 4. 架构模式

### 4.1 一对多（广播）

```text
[主库] → 发布
   ├─→ [从库1] 订阅 (报表)
   ├─→ [从库2] 订阅 (分析)
   └─→ [从库3] 订阅 (备份)

用途: 读写分离、数据分发
```

### 4.2 多对一（聚合）

```text
[分库1] → 发布 (地区A数据)
[分库2] → 发布 (地区B数据)
[分库3] → 发布 (地区C数据)
   ↓
[中心库] → 订阅所有

用途: 数据汇总、全局视图
```

### 4.3 级联复制

```text
[主库] → 发布
   ↓
[中间库] → 订阅 → 发布
   ↓
[末端库] → 订阅

用途: 多层分发
```

### 4.4 双向复制

```sql
-- 节点A
CREATE PUBLICATION pub_a FOR TABLE shared_table;
CREATE SUBSCRIPTION sub_from_b
CONNECTION 'host=node_b ...'
PUBLICATION pub_b;

-- 节点B
CREATE PUBLICATION pub_b FOR TABLE shared_table;
CREATE SUBSCRIPTION sub_from_a
CONNECTION 'host=node_a ...'
PUBLICATION pub_a;

-- 冲突检测与解决
ALTER SUBSCRIPTION sub_from_b
SET (origin = 'none');  -- 避免循环复制
```

---

## 5. 冲突处理

### 5.1 冲突类型

```text
插入冲突:
主键/唯一键冲突

更新冲突:
目标行不存在

删除冲突:
目标行不存在
```

### 5.2 冲突解决策略

```sql
-- 配置冲突解决
ALTER SUBSCRIPTION my_sub
SET (conflict_resolution = 'last_update_wins');

-- PostgreSQL 18选项:
-- error: 报错停止（默认）
-- skip: 跳过冲突行
-- last_update_wins: 最后更新胜出

-- 自定义冲突处理
CREATE OR REPLACE FUNCTION handle_conflict()
RETURNS TRIGGER AS $$
BEGIN
    -- 记录冲突
    INSERT INTO replication_conflicts (table_name, conflict_type, data)
    VALUES (TG_TABLE_NAME, TG_OP, row_to_json(NEW));

    -- 返回NEW继续，或RETURN NULL跳过
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_conflict
    BEFORE INSERT OR UPDATE ON replicated_table
    FOR EACH ROW EXECUTE FUNCTION handle_conflict();
```

---

## 6. 监控

### 6.1 发布端监控

```sql
-- 查看复制槽
SELECT
    slot_name,
    plugin,
    slot_type,
    active,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size
FROM pg_replication_slots;

-- WAL发送统计
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS send_lag
FROM pg_stat_replication;
```

### 6.2 订阅端监控

```sql
-- 订阅状态
SELECT
    subname,
    pid,
    received_lsn,
    latest_end_lsn,
    pg_size_pretty(pg_wal_lsn_diff(latest_end_lsn, received_lsn)) AS lag_size,
    last_msg_send_time,
    last_msg_receipt_time
FROM pg_stat_subscription;

-- 复制延迟
SELECT
    subname,
    NOW() - last_msg_receipt_time AS lag_time
FROM pg_stat_subscription;
```

---

## 7. 运维操作

### 7.1 暂停/恢复

```sql
-- 暂停订阅
ALTER SUBSCRIPTION my_sub DISABLE;

-- 恢复订阅
ALTER SUBSCRIPTION my_sub ENABLE;

-- 刷新订阅（重新获取发布定义）
ALTER SUBSCRIPTION my_sub REFRESH PUBLICATION;
```

### 7.2 重置订阅

```sql
-- 删除订阅
DROP SUBSCRIPTION my_sub;

-- 清理发布端复制槽
SELECT pg_drop_replication_slot('my_sub');

-- 重新创建
CREATE SUBSCRIPTION my_sub
CONNECTION '...'
PUBLICATION my_pub
WITH (copy_data = true);  -- 重新复制全量数据
```

---

## 8. 故障处理

### 8.1 复制中断

```bash
# 1. 检查网络
ping publisher_host

# 2. 检查订阅状态
psql -c "SELECT * FROM pg_stat_subscription;"

# 3. 查看日志
sudo tail -100 /var/log/postgresql/postgresql-*.log | grep logical

# 4. 重启订阅
psql -c "ALTER SUBSCRIPTION my_sub DISABLE;"
psql -c "ALTER SUBSCRIPTION my_sub ENABLE;"
```

### 8.2 数据不一致

```sql
-- 对比数据
-- 发布端
SELECT COUNT(*), MAX(updated_at) FROM orders;

-- 订阅端
SELECT COUNT(*), MAX(updated_at) FROM orders;

-- 如果不一致，重新初始化
DROP SUBSCRIPTION my_sub;
TRUNCATE TABLE orders;

CREATE SUBSCRIPTION my_sub
CONNECTION '...'
PUBLICATION my_pub
WITH (copy_data = true);
```

---

## 9. 性能优化

```sql
-- 订阅端配置
ALTER SUBSCRIPTION my_sub
SET (streaming = on);  -- 启用流式应用（PostgreSQL 14+）

ALTER SUBSCRIPTION my_sub
SET (binary = true);  -- 二进制传输（更快）

-- 并行应用（PostgreSQL 16+）
ALTER SUBSCRIPTION my_sub
SET (streaming = parallel);

-- 发布端优化
ALTER SYSTEM SET max_wal_senders = 20;
ALTER SYSTEM SET wal_sender_timeout = '60s';
```

---

**完成**: PostgreSQL 18逻辑复制分布式架构
**字数**: ~8,000字
**涵盖**: 架构、配置、高级特性、冲突处理、监控、运维
