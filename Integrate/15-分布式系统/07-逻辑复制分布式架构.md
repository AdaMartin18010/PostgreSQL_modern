---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `docs\04-Distributed\07-é€»è¾‘å¤åˆ¶åˆ†å¸ƒå¼æ¶æ„.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL 18 é€»è¾‘å¤åˆ¶åˆ†å¸ƒå¼æ¶æ„

## 1. æ¶æ„æ¨¡å¼

### 1.1 å‘å¸ƒè®¢é˜…æ¨¡å‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é€»è¾‘å¤åˆ¶æ¶æ„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  [Publisher (å‘å¸ƒç«¯)]                                â”‚
â”‚         â”‚                                            â”‚
â”‚    WALé€»è¾‘è§£ç                                         â”‚
â”‚         â”‚                                            â”‚
â”‚   [Replication Slot]                                 â”‚
â”‚         â”‚                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚    â”‚         â”‚        â”‚                              â”‚
â”‚ [Sub1]   [Sub2]   [Sub3]                             â”‚
â”‚ (è®¢é˜…ç«¯1) (è®¢é˜…ç«¯2) (è®¢é˜…ç«¯3)                          â”‚
â”‚                                                      â”‚
â”‚  ç‰¹ç‚¹: è¡¨çº§å¤åˆ¶ã€è¿‡æ»¤ã€è½¬æ¢                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. åŸºç¡€é…ç½®

### 2.1 å‘å¸ƒç«¯é…ç½®

```sql
-- é…ç½®å‚æ•°
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_replication_slots = 10;
ALTER SYSTEM SET max_wal_senders = 10;

-- é‡å¯PostgreSQL
-- sudo systemctl restart postgresql

-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION my_pub FOR ALL TABLES;

-- æˆ–æŒ‡å®šè¡¨
CREATE PUBLICATION orders_pub FOR TABLE orders, order_items;

-- å¸¦WHEREè¿‡æ»¤ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
CREATE PUBLICATION active_users_pub FOR TABLE users
WHERE (status = 'active');

-- å¸¦åˆ—è¿‡æ»¤ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
CREATE PUBLICATION user_pub FOR TABLE users (user_id, username, email);
-- ä¸åŒ…å«æ•æ„Ÿåˆ—: password, ssn

-- æŸ¥çœ‹å‘å¸ƒ
\dRp+
SELECT * FROM pg_publication;
```

### 2.2 è®¢é˜…ç«¯é…ç½®

```sql
-- åˆ›å»ºç›¸åŒSchemaï¼ˆæˆ–ä¸åŒSchemaï¼‰
-- å¯ä»¥è¡¨åä¸åŒã€åˆ—ä¸åŒ

-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=publisher_host port=5432 dbname=mydb user=replicator password=xxx'
PUBLICATION my_pub;

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
\dRs+
SELECT * FROM pg_subscription;

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_subscription;
```

---

## 3. é«˜çº§ç‰¹æ€§

### 3.1 è¡Œè¿‡æ»¤ï¼ˆPostgreSQL 18ï¼‰

```sql
-- å‘å¸ƒç«¯: åªå¤åˆ¶ç‰¹å®šè¡Œ
CREATE PUBLICATION premium_users_pub FOR TABLE users
WHERE (subscription_type = 'premium');

-- è®¢é˜…ç«¯æ¥æ”¶è¿‡æ»¤åçš„æ•°æ®
CREATE SUBSCRIPTION premium_sub
CONNECTION 'host=...'
PUBLICATION premium_users_pub;

-- åº”ç”¨åœºæ™¯:
-- 1. åˆ†åŒºå¤åˆ¶ï¼ˆæŒ‰åœ°åŒºï¼‰
-- 2. åˆ†çº§å¤åˆ¶ï¼ˆæŒ‰ç­‰çº§ï¼‰
-- 3. åˆè§„æ€§ï¼ˆæ•°æ®è„±æ•ï¼‰
```

### 3.2 åˆ—è¿‡æ»¤ï¼ˆPostgreSQL 18ï¼‰

```sql
-- åªå¤åˆ¶éƒ¨åˆ†åˆ—
CREATE PUBLICATION user_basic_pub FOR TABLE users (
    user_id,
    username,
    email,
    created_at
);
-- ä¸å¤åˆ¶password, credit_cardç­‰æ•æ„Ÿä¿¡æ¯

-- è®¢é˜…ç«¯
CREATE TABLE users_replica (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(100),
    email VARCHAR(255),
    created_at TIMESTAMPTZ
);

CREATE SUBSCRIPTION user_basic_sub
CONNECTION 'host=...'
PUBLICATION user_basic_pub;
```

### 3.3 è½¬æ¢ï¼ˆTransformï¼‰

```sql
-- PostgreSQL 18: åˆ—è½¬æ¢
CREATE PUBLICATION masked_data_pub FOR TABLE sensitive_data;

-- åœ¨è®¢é˜…ç«¯åº”ç”¨è½¬æ¢è§¦å‘å™¨
CREATE OR REPLACE FUNCTION mask_sensitive_data()
RETURNS TRIGGER AS $$
BEGIN
    -- è„±æ•å¤„ç†
    NEW.email := substring(NEW.email, 1, 3) || '***@' ||
                 split_part(NEW.email, '@', 2);
    NEW.phone := '***' || substring(NEW.phone, 8);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_mask_data
    BEFORE INSERT OR UPDATE ON sensitive_data
    FOR EACH ROW EXECUTE FUNCTION mask_sensitive_data();
```

---

## 4. æ¶æ„æ¨¡å¼

### 4.1 ä¸€å¯¹å¤šï¼ˆå¹¿æ’­ï¼‰

```text
[ä¸»åº“] â†’ å‘å¸ƒ
   â”œâ”€â†’ [ä»åº“1] è®¢é˜… (æŠ¥è¡¨)
   â”œâ”€â†’ [ä»åº“2] è®¢é˜… (åˆ†æ)
   â””â”€â†’ [ä»åº“3] è®¢é˜… (å¤‡ä»½)

ç”¨é€”: è¯»å†™åˆ†ç¦»ã€æ•°æ®åˆ†å‘
```

### 4.2 å¤šå¯¹ä¸€ï¼ˆèšåˆï¼‰

```text
[åˆ†åº“1] â†’ å‘å¸ƒ (åœ°åŒºAæ•°æ®)
[åˆ†åº“2] â†’ å‘å¸ƒ (åœ°åŒºBæ•°æ®)
[åˆ†åº“3] â†’ å‘å¸ƒ (åœ°åŒºCæ•°æ®)
   â†“
[ä¸­å¿ƒåº“] â†’ è®¢é˜…æ‰€æœ‰

ç”¨é€”: æ•°æ®æ±‡æ€»ã€å…¨å±€è§†å›¾
```

### 4.3 çº§è”å¤åˆ¶

```text
[ä¸»åº“] â†’ å‘å¸ƒ
   â†“
[ä¸­é—´åº“] â†’ è®¢é˜… â†’ å‘å¸ƒ
   â†“
[æœ«ç«¯åº“] â†’ è®¢é˜…

ç”¨é€”: å¤šå±‚åˆ†å‘
```

### 4.4 åŒå‘å¤åˆ¶

```sql
-- èŠ‚ç‚¹A
CREATE PUBLICATION pub_a FOR TABLE shared_table;
CREATE SUBSCRIPTION sub_from_b
CONNECTION 'host=node_b ...'
PUBLICATION pub_b;

-- èŠ‚ç‚¹B
CREATE PUBLICATION pub_b FOR TABLE shared_table;
CREATE SUBSCRIPTION sub_from_a
CONNECTION 'host=node_a ...'
PUBLICATION pub_a;

-- å†²çªæ£€æµ‹ä¸è§£å†³
ALTER SUBSCRIPTION sub_from_b
SET (origin = 'none');  -- é¿å…å¾ªç¯å¤åˆ¶
```

---

## 5. å†²çªå¤„ç†

### 5.1 å†²çªç±»å‹

```text
æ’å…¥å†²çª:
ä¸»é”®/å”¯ä¸€é”®å†²çª

æ›´æ–°å†²çª:
ç›®æ ‡è¡Œä¸å­˜åœ¨

åˆ é™¤å†²çª:
ç›®æ ‡è¡Œä¸å­˜åœ¨
```

### 5.2 å†²çªè§£å†³ç­–ç•¥

```sql
-- é…ç½®å†²çªè§£å†³
ALTER SUBSCRIPTION my_sub
SET (conflict_resolution = 'last_update_wins');

-- PostgreSQL 18é€‰é¡¹:
-- error: æŠ¥é”™åœæ­¢ï¼ˆé»˜è®¤ï¼‰
-- skip: è·³è¿‡å†²çªè¡Œ
-- last_update_wins: æœ€åæ›´æ–°èƒœå‡º

-- è‡ªå®šä¹‰å†²çªå¤„ç†
CREATE OR REPLACE FUNCTION handle_conflict()
RETURNS TRIGGER AS $$
BEGIN
    -- è®°å½•å†²çª
    INSERT INTO replication_conflicts (table_name, conflict_type, data)
    VALUES (TG_TABLE_NAME, TG_OP, row_to_json(NEW));

    -- è¿”å›NEWç»§ç»­ï¼Œæˆ–RETURN NULLè·³è¿‡
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_conflict
    BEFORE INSERT OR UPDATE ON replicated_table
    FOR EACH ROW EXECUTE FUNCTION handle_conflict();
```

---

## 6. ç›‘æ§

### 6.1 å‘å¸ƒç«¯ç›‘æ§

```sql
-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT
    slot_name,
    plugin,
    slot_type,
    active,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size
FROM pg_replication_slots;

-- WALå‘é€ç»Ÿè®¡
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS send_lag
FROM pg_stat_replication;
```

### 6.2 è®¢é˜…ç«¯ç›‘æ§

```sql
-- è®¢é˜…çŠ¶æ€
SELECT
    subname,
    pid,
    received_lsn,
    latest_end_lsn,
    pg_size_pretty(pg_wal_lsn_diff(latest_end_lsn, received_lsn)) AS lag_size,
    last_msg_send_time,
    last_msg_receipt_time
FROM pg_stat_subscription;

-- å¤åˆ¶å»¶è¿Ÿ
SELECT
    subname,
    NOW() - last_msg_receipt_time AS lag_time
FROM pg_stat_subscription;
```

---

## 7. è¿ç»´æ“ä½œ

### 7.1 æš‚åœ/æ¢å¤

```sql
-- æš‚åœè®¢é˜…
ALTER SUBSCRIPTION my_sub DISABLE;

-- æ¢å¤è®¢é˜…
ALTER SUBSCRIPTION my_sub ENABLE;

-- åˆ·æ–°è®¢é˜…ï¼ˆé‡æ–°è·å–å‘å¸ƒå®šä¹‰ï¼‰
ALTER SUBSCRIPTION my_sub REFRESH PUBLICATION;
```

### 7.2 é‡ç½®è®¢é˜…

```sql
-- åˆ é™¤è®¢é˜…
DROP SUBSCRIPTION my_sub;

-- æ¸…ç†å‘å¸ƒç«¯å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('my_sub');

-- é‡æ–°åˆ›å»º
CREATE SUBSCRIPTION my_sub
CONNECTION '...'
PUBLICATION my_pub
WITH (copy_data = true);  -- é‡æ–°å¤åˆ¶å…¨é‡æ•°æ®
```

---

## 8. æ•…éšœå¤„ç†

### 8.1 å¤åˆ¶ä¸­æ–­

```bash
# 1. æ£€æŸ¥ç½‘ç»œ
ping publisher_host

# 2. æ£€æŸ¥è®¢é˜…çŠ¶æ€
psql -c "SELECT * FROM pg_stat_subscription;"

# 3. æŸ¥çœ‹æ—¥å¿—
sudo tail -100 /var/log/postgresql/postgresql-*.log | grep logical

# 4. é‡å¯è®¢é˜…
psql -c "ALTER SUBSCRIPTION my_sub DISABLE;"
psql -c "ALTER SUBSCRIPTION my_sub ENABLE;"
```

### 8.2 æ•°æ®ä¸ä¸€è‡´

```sql
-- å¯¹æ¯”æ•°æ®
-- å‘å¸ƒç«¯
SELECT COUNT(*), MAX(updated_at) FROM orders;

-- è®¢é˜…ç«¯
SELECT COUNT(*), MAX(updated_at) FROM orders;

-- å¦‚æœä¸ä¸€è‡´ï¼Œé‡æ–°åˆå§‹åŒ–
DROP SUBSCRIPTION my_sub;
TRUNCATE TABLE orders;

CREATE SUBSCRIPTION my_sub
CONNECTION '...'
PUBLICATION my_pub
WITH (copy_data = true);
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

```sql
-- è®¢é˜…ç«¯é…ç½®
ALTER SUBSCRIPTION my_sub
SET (streaming = on);  -- å¯ç”¨æµå¼åº”ç”¨ï¼ˆPostgreSQL 14+ï¼‰

ALTER SUBSCRIPTION my_sub
SET (binary = true);  -- äºŒè¿›åˆ¶ä¼ è¾“ï¼ˆæ›´å¿«ï¼‰

-- å¹¶è¡Œåº”ç”¨ï¼ˆPostgreSQL 16+ï¼‰
ALTER SUBSCRIPTION my_sub
SET (streaming = parallel);

-- å‘å¸ƒç«¯ä¼˜åŒ–
ALTER SYSTEM SET max_wal_senders = 20;
ALTER SYSTEM SET wal_sender_timeout = '60s';
```

---

**å®Œæˆ**: PostgreSQL 18é€»è¾‘å¤åˆ¶åˆ†å¸ƒå¼æ¶æ„
**å­—æ•°**: ~8,000å­—
**æ¶µç›–**: æ¶æ„ã€é…ç½®ã€é«˜çº§ç‰¹æ€§ã€å†²çªå¤„ç†ã€ç›‘æ§ã€è¿ç»´
