---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/01-æ ¸å¿ƒè¯¾ç¨‹/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: ç³»ç»Ÿæ¶æ„ç†è§£ã€æ€§èƒ½ä¼˜åŒ–ã€é«˜å¯ç”¨è®¾è®¡ã€ç³»ç»Ÿè°ƒä¼˜
> ğŸ†• **PostgreSQL 18æ¶æ„æ”¹è¿›**
> PostgreSQL 18åœ¨ç³»ç»Ÿæ¶æ„æ–¹é¢å¸¦æ¥ä»¥ä¸‹æ”¹è¿›ï¼š
>
> - âœ… **å¼‚æ­¥I/Oå­ç³»ç»Ÿ**: I/Oæ€§èƒ½æå‡2-3å€ï¼Œç‰¹åˆ«é€‚ç”¨äºå‘é‡æ£€ç´¢
> - âœ… **åŠ¨æ€å…±äº«å†…å­˜**: å…±äº«å†…å­˜ç®¡ç†æ›´æ™ºèƒ½ï¼Œå†…å­˜æ•ˆç‡æå‡20%
> - âœ… **è¿›ç¨‹é€šä¿¡ä¼˜åŒ–**: è¿›ç¨‹é—´é€šä¿¡æ€§èƒ½æå‡
> - âœ… **åå°å·¥ä½œè¿›ç¨‹å¢å¼º**: æ–°å¢WALæ±‡æ€»è¿›ç¨‹ï¼ˆç”¨äºå¢é‡å¤‡ä»½ï¼‰
> - âœ… **ç›‘æ§èƒ½åŠ›æå‡**: æ–°å¢pg_shmem_allocationsè§†å›¾ç›‘æ§å…±äº«å†…å­˜

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†å®Œæ•´æŒ‡å—](#postgresqlç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 å®šä¹‰](#11-å®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€ç†è®ºåŸºç¡€](#äºŒç†è®ºåŸºç¡€)
    - [2.1 ç³»ç»Ÿæ¶æ„ç†è®º](#21-ç³»ç»Ÿæ¶æ„ç†è®º)
    - [2.2 è¿›ç¨‹æ¨¡å‹ç†è®º](#22-è¿›ç¨‹æ¨¡å‹ç†è®º)
  - [ä¸‰ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¸‰çŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [3.1 è¿›ç¨‹æ¨¡å‹å¯¹æ¯”](#31-è¿›ç¨‹æ¨¡å‹å¯¹æ¯”)
    - [3.2 å†…å­˜ç®¡ç†æ–¹æ¡ˆå¯¹æ¯”](#32-å†…å­˜ç®¡ç†æ–¹æ¡ˆå¯¹æ¯”)
  - [å››ã€ç³»ç»Ÿç»„ä»¶](#å››ç³»ç»Ÿç»„ä»¶)
    - [4.1 è¿›ç¨‹æ¨¡å‹](#41-è¿›ç¨‹æ¨¡å‹)
      - [4.1.1 Postmasterè¿›ç¨‹](#411-postmasterè¿›ç¨‹)
      - [4.1.2 Backendè¿›ç¨‹](#412-backendè¿›ç¨‹)
      - [4.1.3 Backgroundè¿›ç¨‹](#413-backgroundè¿›ç¨‹)
    - [4.2 å†…å­˜ç®¡ç†](#42-å†…å­˜ç®¡ç†)
      - [4.2.1 å…±äº«å†…å­˜](#421-å…±äº«å†…å­˜)
      - [4.2.2 æœ¬åœ°å†…å­˜](#422-æœ¬åœ°å†…å­˜)
    - [4.3 å­˜å‚¨ç³»ç»Ÿ](#43-å­˜å‚¨ç³»ç»Ÿ)
      - [4.3.1 å­˜å‚¨å¼•æ“](#431-å­˜å‚¨å¼•æ“)
      - [4.3.2 ç¼“å†²åŒºç®¡ç†](#432-ç¼“å†²åŒºç®¡ç†)
    - [4.4 ç½‘ç»œåè®®](#44-ç½‘ç»œåè®®)
      - [4.4.1 PostgreSQLåè®®](#441-postgresqlåè®®)
  - [äº”ã€å®é™…åº”ç”¨](#äº”å®é™…åº”ç”¨)
    - [5.1 é«˜å¹¶å‘åº”ç”¨åœºæ™¯](#51-é«˜å¹¶å‘åº”ç”¨åœºæ™¯)
    - [5.2 é«˜å¯ç”¨éƒ¨ç½²](#52-é«˜å¯ç”¨éƒ¨ç½²)
      - [1. ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slaveï¼‰](#1-ä¸»ä»å¤åˆ¶master-slave)
      - [2. æµå¤åˆ¶ç›‘æ§](#2-æµå¤åˆ¶ç›‘æ§)
      - [3. æ•…éšœåˆ‡æ¢ï¼ˆFailoverï¼‰](#3-æ•…éšœåˆ‡æ¢failover)
      - [4. é«˜å¯ç”¨æ¶æ„æ¨¡å¼](#4-é«˜å¯ç”¨æ¶æ„æ¨¡å¼)
  - [å…­ã€æ€§èƒ½åˆ†æ](#å…­æ€§èƒ½åˆ†æ)
    - [6.1 ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡](#61-ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡)
      - [1. å¹¶å‘è¿æ¥æ•°](#1-å¹¶å‘è¿æ¥æ•°)
      - [2. äº‹åŠ¡ååé‡](#2-äº‹åŠ¡ååé‡)
      - [3. æŸ¥è¯¢å“åº”æ—¶é—´](#3-æŸ¥è¯¢å“åº”æ—¶é—´)
      - [4. å†…å­˜ä½¿ç”¨æ•ˆç‡](#4-å†…å­˜ä½¿ç”¨æ•ˆç‡)
      - [5. I/Oæ€§èƒ½æŒ‡æ ‡](#5-ioæ€§èƒ½æŒ‡æ ‡)
    - [6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#62-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
      - [1. é…ç½®å‚æ•°ä¼˜åŒ–](#1-é…ç½®å‚æ•°ä¼˜åŒ–)
      - [2. æŸ¥è¯¢ä¼˜åŒ–](#2-æŸ¥è¯¢ä¼˜åŒ–)
      - [3. ç´¢å¼•ä¼˜åŒ–](#3-ç´¢å¼•ä¼˜åŒ–)
      - [4. è¡¨ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–](#4-è¡¨ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–)
      - [5. VACUUMä¼˜åŒ–](#5-vacuumä¼˜åŒ–)
      - [6. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#6-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
      - [7. PostgreSQL 18æ€§èƒ½ä¼˜åŒ–æ–°ç‰¹æ€§](#7-postgresql-18æ€§èƒ½ä¼˜åŒ–æ–°ç‰¹æ€§)
  - [ä¸ƒã€ç›¸å…³æ¦‚å¿µ](#ä¸ƒç›¸å…³æ¦‚å¿µ)
    - [7.1 ä¸Šä½æ¦‚å¿µ](#71-ä¸Šä½æ¦‚å¿µ)
    - [7.2 ä¸‹ä½æ¦‚å¿µ](#72-ä¸‹ä½æ¦‚å¿µ)
    - [7.3 å¹³è¡Œæ¦‚å¿µ](#73-å¹³è¡Œæ¦‚å¿µ)
  - [å…«ã€å‚è€ƒèµ„æº](#å…«å‚è€ƒèµ„æº)
    - [8.1 ç›¸å…³æ–‡æ¡£](#81-ç›¸å…³æ–‡æ¡£)
    - [8.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#82-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
    - [8.3 å‚è€ƒæ–‡çŒ®](#83-å‚è€ƒæ–‡çŒ®)
    - [8.4 Wikidataå¯¹é½](#84-wikidataå¯¹é½)
      - [8.4.1 PostgreSQLç³»ç»Ÿå¯¹é½](#841-postgresqlç³»ç»Ÿå¯¹é½)
      - [8.4.2 æ•°æ®åº“ç³»ç»Ÿæ¶æ„æ¦‚å¿µå¯¹é½](#842-æ•°æ®åº“ç³»ç»Ÿæ¶æ„æ¦‚å¿µå¯¹é½)
      - [8.4.3 å¤šè¿›ç¨‹æ¶æ„æ¦‚å¿µå¯¹é½](#843-å¤šè¿›ç¨‹æ¶æ„æ¦‚å¿µå¯¹é½)
  - [ä¹ã€å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯](#ä¹å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯)
    - [9.1 ç³»ç»Ÿæ¶æ„å®Œå¤‡æ€§è¯æ˜](#91-ç³»ç»Ÿæ¶æ„å®Œå¤‡æ€§è¯æ˜)
    - [9.2 è¿›ç¨‹æ¨¡å‹æ­£ç¡®æ€§è¯æ˜](#92-è¿›ç¨‹æ¨¡å‹æ­£ç¡®æ€§è¯æ˜)
    - [9.3 å†…å­˜ç®¡ç†æ•ˆç‡è¯æ˜](#93-å†…å­˜ç®¡ç†æ•ˆç‡è¯æ˜)
  - [åã€äº¤å‰å¼•ç”¨](#åäº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
  - [åã€åˆå¹¶æ¥æºä¸æ˜ å°„ï¼ˆæ•´åˆä¸­ï¼‰](#ååˆå¹¶æ¥æºä¸æ˜ å°„æ•´åˆä¸­)
    - [å¾…åŠäº‹é¡¹](#å¾…åŠäº‹é¡¹)
      - [1. æœ¯è¯­ç»Ÿä¸€](#1-æœ¯è¯­ç»Ÿä¸€)
      - [2. æ–‡æ¡£äº¤å‰å¼•ç”¨](#2-æ–‡æ¡£äº¤å‰å¼•ç”¨)
      - [3. éƒ¨ç½²æ‹“æ‰‘è¡¥å……](#3-éƒ¨ç½²æ‹“æ‰‘è¡¥å……)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQLæ¶æ„))
    è¿›ç¨‹æ¨¡å‹
      Postmaster
      Backend
      Background
    å†…å­˜ç®¡ç†
      å…±äº«å†…å­˜
      æœ¬åœ°å†…å­˜
      åŠ¨æ€å…±äº«å†…å­˜
    å­˜å‚¨ç³»ç»Ÿ
      å­˜å‚¨å¼•æ“
      ç¼“å†²åŒºç®¡ç†
      WAL
    ç½‘ç»œåè®®
      PostgreSQLåè®®
      è¿æ¥ç®¡ç†
    å®é™…åº”ç”¨
      é«˜å¹¶å‘
      é«˜å¯ç”¨
      æ€§èƒ½ä¼˜åŒ–
    æ€§èƒ½åˆ†æ
      æ€§èƒ½æŒ‡æ ‡
      ä¼˜åŒ–ç­–ç•¥
      ç›‘æ§è¯Šæ–­
```

---

## ä¸€ã€æ¦‚è¿°

### 1.1 å®šä¹‰

**ä¸­æ–‡å®šä¹‰**: PostgreSQLæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(ORDBMS)ï¼Œé‡‡ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ï¼Œæ”¯æŒSQLæ ‡å‡†ï¼Œå…·æœ‰ACIDäº‹åŠ¡ç‰¹æ€§ï¼Œæä¾›ä¸°å¯Œçš„æ‰©å±•æ€§å’Œé«˜çº§åŠŸèƒ½ã€‚

**English Definition**: PostgreSQL is a powerful open-source object-relational database management system (ORDBMS) that employs a client-server architecture, supports SQL standards, provides ACID transaction properties, and offers rich extensibility and advanced features.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\pg}{\mathcal{PG}}
\newcommand{\process}{\mathcal{P}}
\newcommand{\memory}{\mathcal{M}}
\newcommand{\storage}{\mathcal{S}}
\newcommand{\network}{\mathcal{N}}

% PostgreSQLç³»ç»Ÿå½¢å¼åŒ–å®šä¹‰
\pg = (\process, \memory, \storage, \network)

å…¶ä¸­ï¼š
\process = \{p_1, p_2, \ldots, p_n\} \text{ ä¸ºè¿›ç¨‹é›†åˆ}
\memory = \{m_1, m_2, \ldots, m_k\} \text{ ä¸ºå†…å­˜åŒºåŸŸé›†åˆ}
\storage = \{s_1, s_2, \ldots, s_l\} \text{ ä¸ºå­˜å‚¨ç»„ä»¶é›†åˆ}
\network = \{n_1, n_2, \ldots, n_m\} \text{ ä¸ºç½‘ç»œåè®®é›†åˆ}
```

### 1.3 æ ¸å¿ƒå±æ€§

- **ACID Compliance**: æ”¯æŒåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
- **SQL Standard**: ç¬¦åˆSQL:2023æ ‡å‡†
- **Extensibility**: æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹ã€å‡½æ•°ã€æ“ä½œç¬¦
- **Concurrency Control**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)
- **Client-Server Architecture**: å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„
- **Multi-Process Model**: å¤šè¿›ç¨‹æ¨¡å‹

## äºŒã€ç†è®ºåŸºç¡€

### 2.1 ç³»ç»Ÿæ¶æ„ç†è®º

```latex
\begin{theorem}[PostgreSQLæ¶æ„å®Œå¤‡æ€§]
è®¾ \pg ä¸ºPostgreSQLç³»ç»Ÿï¼Œåˆ™ \pg çš„æ¶æ„æ˜¯å®Œå¤‡çš„ï¼Œå½“ä¸”ä»…å½“ï¼š
1. è¿›ç¨‹æ¨¡å‹æ”¯æŒå¹¶å‘å¤„ç†
2. å†…å­˜ç®¡ç†æ”¯æŒäº‹åŠ¡éš”ç¦»
3. å­˜å‚¨ç³»ç»Ÿæ”¯æŒæŒä¹…åŒ–
4. ç½‘ç»œåè®®æ”¯æŒå®¢æˆ·ç«¯é€šä¿¡
\end{theorem}

\begin{proof}
1. è¿›ç¨‹æ¨¡å‹å®Œå¤‡æ€§ï¼šå¤šè¿›ç¨‹æ¶æ„ç¡®ä¿å¹¶å‘å®‰å…¨
2. å†…å­˜ç®¡ç†å®Œå¤‡æ€§ï¼šå…±äº«å†…å­˜å’Œæœ¬åœ°å†…å­˜åˆ†ç¦»
3. å­˜å‚¨ç³»ç»Ÿå®Œå¤‡æ€§ï¼šWALæœºåˆ¶ä¿è¯æŒä¹…æ€§
4. ç½‘ç»œåè®®å®Œå¤‡æ€§ï¼šPostgreSQLåè®®æ”¯æŒå…¨åŠŸèƒ½é€šä¿¡
\end{proof}
```

### 2.2 è¿›ç¨‹æ¨¡å‹ç†è®º

```latex
\begin{theorem}[è¿›ç¨‹æ¨¡å‹æ­£ç¡®æ€§]
PostgreSQLçš„å¤šè¿›ç¨‹æ¨¡å‹æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š
1. è¿›ç¨‹éš”ç¦»æ€§ï¼šä¸åŒè¿›ç¨‹é—´å†…å­˜éš”ç¦»
2. è¿›ç¨‹é€šä¿¡æ€§ï¼šé€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡
3. è¿›ç¨‹å¯æ¢å¤æ€§ï¼šå•ä¸ªè¿›ç¨‹æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿ
\end{theorem}
```

## ä¸‰ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 3.1 è¿›ç¨‹æ¨¡å‹å¯¹æ¯”

| è¿›ç¨‹ç±»å‹ | æ•°é‡ | ç”Ÿå‘½å‘¨æœŸ | ä¸»è¦èŒè´£ | èµ„æºå ç”¨ |
| --------- | ------ | --------- | --------- | --------- |
| Postmaster | 1 | é•¿æœŸ | è¿›ç¨‹ç®¡ç†ã€è¿æ¥ç›‘å¬ | ä½ |
| Backend | N | ä¼šè¯æœŸé—´ | æŸ¥è¯¢å¤„ç†ã€äº‹åŠ¡ç®¡ç† | ä¸­ |
| Background | å›ºå®š | é•¿æœŸ | ç»´æŠ¤ä»»åŠ¡ã€åå°å¤„ç† | ä½-ä¸­ |

### 3.2 å†…å­˜ç®¡ç†æ–¹æ¡ˆå¯¹æ¯”

| å†…å­˜ç±»å‹ | å¤§å° | å…±äº«æ€§ | ç”¨é€” | ç®¡ç†æ–¹å¼ |
| --------- | ------ | -------- | ------ | --------- |
| å…±äº«å†…å­˜ | å›ºå®š | å…¨å±€å…±äº« | ç¼“å­˜ã€é”ã€ç»Ÿè®¡ä¿¡æ¯ | å¯åŠ¨æ—¶åˆ†é… |
| æœ¬åœ°å†…å­˜ | åŠ¨æ€ | è¿›ç¨‹ç§æœ‰ | æŸ¥è¯¢å¤„ç†ã€æ’åº | æŒ‰éœ€åˆ†é… |
| åŠ¨æ€å…±äº«å†…å­˜ | åŠ¨æ€ | å¯å…±äº« | æ‰©å±•ã€ä¼šè¯æ•°æ® | è¿è¡Œæ—¶åˆ†é… |

---

## å››ã€ç³»ç»Ÿç»„ä»¶

### 4.1 è¿›ç¨‹æ¨¡å‹

#### 4.1.1 Postmasterè¿›ç¨‹

Postmasterè¿›ç¨‹æ˜¯PostgreSQLç³»ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£æ•´ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„å¯åŠ¨ã€åˆå§‹åŒ–å’Œè¿›ç¨‹ç®¡ç†ã€‚

**å¯åŠ¨æµç¨‹**:

```bash
# Postmasterè¿›ç¨‹å¯åŠ¨ç¤ºä¾‹
postmaster -D /var/lib/postgresql/data -p 5432

# å¯åŠ¨æ­¥éª¤ï¼š
# 1. è¯»å–é…ç½®æ–‡ä»¶ï¼ˆpostgresql.confï¼‰
# 2. åˆå§‹åŒ–å…±äº«å†…å­˜
# 3. åˆ›å»ºä¿¡å·å¤„ç†å™¨
# 4. ç»‘å®šç›‘å¬ç«¯å£
# 5. å¯åŠ¨åå°å·¥ä½œè¿›ç¨‹
```

**æ ¸å¿ƒåŠŸèƒ½**:

1. **ç³»ç»Ÿå¯åŠ¨å’Œåˆå§‹åŒ–**
   - è¯»å–é…ç½®æ–‡ä»¶ï¼ˆpostgresql.confã€pg_hba.confï¼‰
   - åˆå§‹åŒ–å…±äº«å†…å­˜åŒºåŸŸ
   - åˆ›å»ºç³»ç»Ÿç›®å½•å’Œæ–‡ä»¶
   - åŠ è½½é¢„åŠ è½½åº“ï¼ˆshared_preload_librariesï¼‰

2. **å®¢æˆ·ç«¯è¿æ¥ç®¡ç†**
   - ç›‘å¬å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼ˆé»˜è®¤ç«¯å£5432ï¼‰
   - æ¥å—æ–°è¿æ¥å¹¶åˆ›å»ºBackendè¿›ç¨‹
   - ç®¡ç†è¿æ¥æ± å’Œè¿æ¥é™åˆ¶
   - å¤„ç†è¿æ¥è®¤è¯ï¼ˆæ”¯æŒOAuth 2.0ï¼ŒPostgreSQL 18ï¼‰

3. **å­è¿›ç¨‹åˆ›å»ºå’Œç›‘æ§**
   - ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºç‹¬ç«‹çš„Backendè¿›ç¨‹
   - ç›‘æ§å­è¿›ç¨‹çŠ¶æ€ï¼Œå¤„ç†å¼‚å¸¸é€€å‡º
   - å®ç°è¿›ç¨‹æ± ç®¡ç†ï¼ˆé€šè¿‡pgBouncerç­‰ï¼‰

4. **ç³»ç»Ÿé…ç½®ç®¡ç†**
   - åŠ¨æ€é…ç½®å‚æ•°ï¼ˆALTER SYSTEMï¼‰
   - ä¿¡å·å¤„ç†ï¼ˆSIGHUPé‡è½½é…ç½®ã€SIGTERMä¼˜é›…å…³é—­ï¼‰
   - ç³»ç»ŸçŠ¶æ€ç›‘æ§

**PostgreSQL 18æ”¹è¿›**:

- æ”¹è¿›çš„è¿›ç¨‹é—´é€šä¿¡æ€§èƒ½
- æ›´é«˜æ•ˆçš„è¿æ¥ç®¡ç†æœºåˆ¶
- å¢å¼ºçš„ä¿¡å·å¤„ç†èƒ½åŠ›

**ç›‘æ§æ–¹æ³•**:

```sql
-- æŸ¥çœ‹Postmasterè¿›ç¨‹ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    backend_pid INT;
BEGIN
    BEGIN
        SELECT pg_backend_pid() INTO backend_pid;
        RAISE NOTICE 'å½“å‰Backendè¿›ç¨‹PID: %', backend_pid;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–Backendè¿›ç¨‹PIDå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_activity WHERE pid = pg_backend_pid();

-- æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_db TEXT;
    process_count INT;
BEGIN
    BEGIN
        SELECT current_database() INTO current_db;
        SELECT COUNT(*) INTO process_count
        FROM pg_stat_activity
        WHERE datname = current_db;

        RAISE NOTICE 'å½“å‰æ•°æ®åº“: %, æ´»åŠ¨è¿›ç¨‹æ•°: %', current_db, process_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    state_change
FROM pg_stat_activity
WHERE datname = current_database();
```

#### 4.1.2 Backendè¿›ç¨‹

Backendè¿›ç¨‹æ˜¯PostgreSQLä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºçš„ç‹¬ç«‹è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç†è¯¥è¿æ¥çš„æ‰€æœ‰æŸ¥è¯¢å’Œäº‹åŠ¡ã€‚

**è¿›ç¨‹ç»“æ„**:

```c
// Backendè¿›ç¨‹ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
typedef struct Backend {
    pid_t pid;                    // è¿›ç¨‹ID
    int sock;                     // å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
    Port *port;                   // è¿æ¥ç«¯å£ä¿¡æ¯
    MemoryContext context;        // å†…å­˜ä¸Šä¸‹æ–‡
    TransactionState *xact_state; // äº‹åŠ¡çŠ¶æ€
    QueryDesc *query_desc;        // æŸ¥è¯¢æè¿°ç¬¦
    EState *estate;               // æ‰§è¡ŒçŠ¶æ€
} Backend;
```

**æ ¸å¿ƒåŠŸèƒ½**:

1. **SQLæŸ¥è¯¢è§£æå’Œæ‰§è¡Œ**
   - æ¥æ”¶å®¢æˆ·ç«¯SQLæŸ¥è¯¢
   - è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æï¼ˆLex/Yaccï¼‰
   - æŸ¥è¯¢é‡å†™å’Œä¼˜åŒ–
   - æ‰§è¡Œè®¡åˆ’ç”Ÿæˆå’Œæ‰§è¡Œ
   - ç»“æœé›†æ„å»ºå’Œè¿”å›

2. **äº‹åŠ¡ç®¡ç†**
   - äº‹åŠ¡å¼€å§‹ã€æäº¤ã€å›æ»š
   - MVCCç‰ˆæœ¬ç®¡ç†
   - é”ç®¡ç†ï¼ˆè¡¨é”ã€è¡Œé”ï¼‰
   - éš”ç¦»çº§åˆ«æ§åˆ¶

3. **å†…å­˜ç®¡ç†**
   - æŸ¥è¯¢å†…å­˜åˆ†é…ï¼ˆwork_memï¼‰
   - ä¸´æ—¶æ–‡ä»¶ç®¡ç†
   - å†…å­˜ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆMemoryContextï¼‰

4. **å®¢æˆ·ç«¯é€šä¿¡**
   - PostgreSQLåè®®æ¶ˆæ¯å¤„ç†
   - ç»“æœé›†åºåˆ—åŒ–
   - é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Š

**ç”Ÿå‘½å‘¨æœŸ**:

```sql
-- Backendè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹
-- 1. è¿æ¥å»ºç«‹
CONNECT TO postgresql://user@host:5432/dbname;

-- 2. æŸ¥è¯¢æ‰§è¡Œ
BEGIN;
SELECT * FROM users WHERE id = 1;
COMMIT;

-- 3. è¿æ¥å…³é—­
DISCONNECT;
```

**æ€§èƒ½ä¼˜åŒ–**:

- è¿æ¥æ± ï¼šä½¿ç”¨pgBouncerå‡å°‘è¿›ç¨‹åˆ›å»ºå¼€é”€
- é¢„ç¼–è¯‘è¯­å¥ï¼šå‡å°‘è§£æå¼€é”€
- æ‰¹é‡æ“ä½œï¼šå‡å°‘ç½‘ç»œå¾€è¿”

**PostgreSQL 18æ”¹è¿›**:

- æ”¹è¿›çš„æŸ¥è¯¢æ‰§è¡Œæ€§èƒ½
- æ›´é«˜æ•ˆçš„å†…å­˜ç®¡ç†
- ä¼˜åŒ–çš„é”æœºåˆ¶

#### 4.1.3 Backgroundè¿›ç¨‹

Backgroundè¿›ç¨‹æ˜¯PostgreSQLçš„åå°å·¥ä½œè¿›ç¨‹ï¼Œè´Ÿè´£ç³»ç»Ÿç»´æŠ¤ã€æ•°æ®æŒä¹…åŒ–å’Œæ€§èƒ½ä¼˜åŒ–ç­‰ä»»åŠ¡ã€‚

**è¿›ç¨‹ç±»å‹è¯¦è§£**:

```c
// Backgroundè¿›ç¨‹ç±»å‹ï¼ˆPostgreSQL 18ï¼‰
enum BackgroundProcessType {
    CHECKPOINTER,      // æ£€æŸ¥ç‚¹è¿›ç¨‹
    WAL_WRITER,        // WALå†™å…¥è¿›ç¨‹
    WAL_SUMMARIZER,    // WALæ±‡æ€»è¿›ç¨‹ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
    AUTOVACUUM_LAUNCHER, // è‡ªåŠ¨æ¸…ç†å¯åŠ¨å™¨
    AUTOVACUUM_WORKER,   // è‡ªåŠ¨æ¸…ç†å·¥ä½œè¿›ç¨‹
    STATS_COLLECTOR,   // ç»Ÿè®¡æ”¶é›†è¿›ç¨‹
    LOGGER,            // æ—¥å¿—è¿›ç¨‹
    ARCHIVER           // WALå½’æ¡£è¿›ç¨‹
};
```

**1. Checkpointerè¿›ç¨‹**:

è´Ÿè´£å®šæœŸåˆ›å»ºæ£€æŸ¥ç‚¹ï¼Œå°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜ï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–ã€‚

```sql
-- æ£€æŸ¥ç‚¹é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_checkpoint_timeout TEXT;
    v_max_wal_size TEXT;
    v_min_wal_size TEXT;
    v_completion_target TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_checkpoint_timeout FROM pg_settings WHERE name = 'checkpoint_timeout';
        SELECT setting INTO v_max_wal_size FROM pg_settings WHERE name = 'max_wal_size';
        SELECT setting INTO v_min_wal_size FROM pg_settings WHERE name = 'min_wal_size';
        SELECT setting INTO v_completion_target FROM pg_settings WHERE name = 'checkpoint_completion_target';

        RAISE NOTICE 'æ£€æŸ¥ç‚¹é…ç½®ï¼š';
        RAISE NOTICE '  checkpoint_timeout: %, max_wal_size: %, min_wal_size: %',
            v_checkpoint_timeout, v_max_wal_size, v_min_wal_size;
        RAISE NOTICE '  checkpoint_completion_target: %', v_completion_target;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰‹åŠ¨è§¦å‘æ£€æŸ¥ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CHECKPOINT;
        RAISE NOTICE 'æ£€æŸ¥ç‚¹å·²æˆåŠŸè§¦å‘';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è§¦å‘æ£€æŸ¥ç‚¹å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stat_count FROM pg_stat_bgwriter;
        IF stat_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_bgwriter;
```

**åŠŸèƒ½**:

- å®šæœŸåˆ›å»ºæ£€æŸ¥ç‚¹ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
- å°†å…±äº«ç¼“å†²åŒºä¸­çš„è„é¡µå†™å…¥ç£ç›˜
- æ›´æ–°æ§åˆ¶æ–‡ä»¶ï¼ˆpg_controlï¼‰
- æ¸…ç†æ—§çš„WALæ–‡ä»¶

**2. WAL Writerè¿›ç¨‹**:

è´Ÿè´£å°†WALç¼“å†²åŒºä¸­çš„æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œç¡®ä¿äº‹åŠ¡æ—¥å¿—çš„æŒä¹…åŒ–ã€‚

```sql
-- WALé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_wal_buffers TEXT;
    v_wal_writer_delay TEXT;
    v_wal_writer_flush_after TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_wal_buffers FROM pg_settings WHERE name = 'wal_buffers';
        SELECT setting INTO v_wal_writer_delay FROM pg_settings WHERE name = 'wal_writer_delay';
        SELECT setting INTO v_wal_writer_flush_after FROM pg_settings WHERE name = 'wal_writer_flush_after';

        RAISE NOTICE 'WALé…ç½®ï¼š';
        RAISE NOTICE '  wal_buffers: %, wal_writer_delay: %, wal_writer_flush_after: %',
            v_wal_buffers, v_wal_writer_delay, v_wal_writer_flush_after;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹WALé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹WALç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stat_count FROM pg_stat_wal;
        IF stat_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°WALç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°WALç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹WALç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_wal;
```

**åŠŸèƒ½**:

- å®šæœŸåˆ·æ–°WALç¼“å†²åŒºåˆ°ç£ç›˜
- ç¡®ä¿äº‹åŠ¡æ—¥å¿—çš„æŒä¹…åŒ–
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å†™å…¥æ¨¡å¼

**3. WAL Summarizerè¿›ç¨‹ï¼ˆPostgreSQL 18æ–°å¢ï¼‰**:

æ–°å¢çš„åå°è¿›ç¨‹ï¼Œç”¨äºæ±‡æ€»WALæ—¥å¿—ï¼Œæ”¯æŒå¢é‡å¤‡ä»½ã€‚

```sql
-- WAL Summarizeré…ç½®ï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_wal_summarize TEXT;
    v_wal_summarize_keep_time TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_wal_summarize FROM pg_settings WHERE name = 'wal_summarize';
        SELECT setting INTO v_wal_summarize_keep_time FROM pg_settings WHERE name = 'wal_summarize_keep_time';

        IF v_wal_summarize IS NOT NULL THEN
            RAISE NOTICE 'WAL Summarizeré…ç½®ï¼ˆPostgreSQL 18ï¼‰ï¼š';
            RAISE NOTICE '  wal_summarize: %, wal_summarize_keep_time: %',
                v_wal_summarize, v_wal_summarize_keep_time;
        ELSE
            RAISE WARNING 'WAL SummarizeråŠŸèƒ½ä»…åœ¨PostgreSQL 18+ä¸­å¯ç”¨';
        END IF;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'WAL Summarizeré…ç½®å‚æ•°ä¸å­˜åœ¨ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹WAL Summarizeré…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹WALæ±‡æ€»ç»Ÿè®¡ï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stat_count FROM pg_stat_wal_summarizer;
        IF stat_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°WALæ±‡æ€»ç»Ÿè®¡ä¿¡æ¯ï¼ˆPostgreSQL 18ï¼‰';
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°WALæ±‡æ€»ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18æˆ–æœªå¯ç”¨ï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'pg_stat_wal_summarizerè§†å›¾ä¸å­˜åœ¨ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹WALæ±‡æ€»ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_wal_summarizer;
```

**åŠŸèƒ½**:

- å®šæœŸæ±‡æ€»WALæ—¥å¿—
- ç”Ÿæˆå¢é‡å¤‡ä»½æ‰€éœ€çš„æ‘˜è¦ä¿¡æ¯
- æ”¯æŒå¿«é€Ÿå¢é‡å¤‡ä»½å’Œæ¢å¤

**4. Autovacuumè¿›ç¨‹**:

è‡ªåŠ¨æ¸…ç†è¿›ç¨‹ï¼Œè´Ÿè´£å›æ”¶æ­»å…ƒç»„ç©ºé—´ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€‚

```sql
-- Autovacuumé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_autovacuum TEXT;
    v_max_workers TEXT;
    v_naptime TEXT;
    v_vacuum_threshold TEXT;
    v_analyze_threshold TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_autovacuum FROM pg_settings WHERE name = 'autovacuum';
        SELECT setting INTO v_max_workers FROM pg_settings WHERE name = 'autovacuum_max_workers';
        SELECT setting INTO v_naptime FROM pg_settings WHERE name = 'autovacuum_naptime';
        SELECT setting INTO v_vacuum_threshold FROM pg_settings WHERE name = 'autovacuum_vacuum_threshold';
        SELECT setting INTO v_analyze_threshold FROM pg_settings WHERE name = 'autovacuum_analyze_threshold';

        RAISE NOTICE 'Autovacuumé…ç½®ï¼š';
        RAISE NOTICE '  autovacuum: %, autovacuum_max_workers: %, autovacuum_naptime: %',
            v_autovacuum, v_max_workers, v_naptime;
        RAISE NOTICE '  autovacuum_vacuum_threshold: %, autovacuum_analyze_threshold: %',
            v_vacuum_threshold, v_analyze_threshold;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹Autovacuumé…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹Autovacuumç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stat_count FROM pg_stat_progress_vacuum;
        IF stat_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ­£åœ¨è¿è¡Œçš„VACUUMè¿›ç¨‹', stat_count;
        ELSE
            RAISE NOTICE 'å½“å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„VACUUMè¿›ç¨‹';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹Autovacuumç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_progress_vacuum;
```

**åŠŸèƒ½**:

- è‡ªåŠ¨æ¸…ç†æ­»å…ƒç»„
- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
- é˜²æ­¢è¡¨è†¨èƒ€
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**5. Stats Collectorè¿›ç¨‹**:

ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¿›ç¨‹ï¼Œæ”¶é›†ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ã€‚

```sql
-- ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_track_activities TEXT;
    v_track_counts TEXT;
    v_track_io_timing TEXT;
    v_track_functions TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_track_activities FROM pg_settings WHERE name = 'track_activities';
        SELECT setting INTO v_track_counts FROM pg_settings WHERE name = 'track_counts';
        SELECT setting INTO v_track_io_timing FROM pg_settings WHERE name = 'track_io_timing';
        SELECT setting INTO v_track_functions FROM pg_settings WHERE name = 'track_functions';

        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼š';
        RAISE NOTICE '  track_activities: %, track_counts: %, track_io_timing: %, track_functions: %',
            v_track_activities, v_track_counts, v_track_io_timing, v_track_functions;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_count INT;
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO db_count FROM pg_stat_database;
        SELECT COUNT(*) INTO table_count FROM pg_stat_user_tables;

        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯ï¼šæ•°æ®åº“æ•°: %, ç”¨æˆ·è¡¨æ•°: %', db_count, table_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_database;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_user_tables;
```

**6. Loggerè¿›ç¨‹**:

æ—¥å¿—è¿›ç¨‹ï¼Œè´Ÿè´£å†™å…¥ç³»ç»Ÿæ—¥å¿—ã€‚

```sql
-- æ—¥å¿—é…ç½®
-- postgresql.conf
logging_collector = on          -- å¯ç”¨æ—¥å¿—æ”¶é›†
log_directory = 'log'           -- æ—¥å¿—ç›®å½•
log_filename = 'postgresql-%Y-%m-%d.log' -- æ—¥å¿—æ–‡ä»¶å
log_min_duration_statement = 1000ms -- æ…¢æŸ¥è¯¢æ—¥å¿—é˜ˆå€¼
```

**PostgreSQL 18æ”¹è¿›**:

- æ–°å¢WAL Summarizerè¿›ç¨‹æ”¯æŒå¢é‡å¤‡ä»½
- æ”¹è¿›çš„Autovacuumæ€§èƒ½
- æ›´é«˜æ•ˆçš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

### 4.2 å†…å­˜ç®¡ç†

#### 4.2.1 å…±äº«å†…å­˜

å…±äº«å†…å­˜æ˜¯PostgreSQLå¤šè¿›ç¨‹æ¶æ„çš„æ ¸å¿ƒï¼Œæ‰€æœ‰è¿›ç¨‹é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œæ•°æ®äº¤æ¢å’ŒåŒæ­¥ã€‚

**å…±äº«å†…å­˜ç»“æ„**:

```c
// å…±äº«å†…å­˜ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
typedef struct SharedMemory {
    PGShmemHeader *header;        // å…±äº«å†…å­˜å¤´éƒ¨
    LWLockArray *lwlock_array;    // è½»é‡çº§é”æ•°ç»„
    ProcArray *proc_array;        // è¿›ç¨‹æ•°ç»„ï¼ˆMVCCï¼‰
    XLogCtl *xlog_ctl;            // WALæ§åˆ¶ç»“æ„
    BufferDesc *buffer_descs;      // ç¼“å†²åŒºæè¿°ç¬¦æ•°ç»„
    CLOGControl *clog_ctl;        // æäº¤æ—¥å¿—æ§åˆ¶
    MultiXactState *multixact;    // å¤šäº‹åŠ¡çŠ¶æ€
    OidGenState *oid_gen;         // OIDç”Ÿæˆå™¨
} SharedMemory;
```

**å†…å­˜åŒºåŸŸè¯¦è§£**:

1. **LWLockåŒºåŸŸï¼ˆè½»é‡çº§é”ï¼‰**
   - ç”¨äºçŸ­æœŸé”å®šçš„è½»é‡çº§é”
   - æ”¯æŒå…±äº«é”å’Œæ’ä»–é”
   - é”æ•°é‡å¯é…ç½®ï¼ˆmax_locks_per_transactionï¼‰

    ```sql
    -- æŸ¥çœ‹é”ç»Ÿè®¡
    SELECT * FROM pg_stat_database_conflicts;

    -- é”é…ç½®
    -- postgresql.conf
    max_locks_per_transaction = 64
    max_pred_locks_per_transaction = 64
    ```

2. **ProcArrayåŒºåŸŸï¼ˆè¿›ç¨‹æ•°ç»„ï¼‰**
   - å­˜å‚¨æ‰€æœ‰æ´»åŠ¨äº‹åŠ¡çš„è¿›ç¨‹ä¿¡æ¯
   - æ”¯æŒMVCCå¿«ç…§éš”ç¦»
   - ç”¨äºäº‹åŠ¡å¯è§æ€§åˆ¤æ–­

    ```sql
    -- æŸ¥çœ‹æ´»åŠ¨è¿›ç¨‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
    DO $$
    DECLARE
        process_count INT;
    BEGIN
        BEGIN
            SELECT COUNT(*) INTO process_count FROM pg_stat_activity;
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ´»åŠ¨è¿›ç¨‹', process_count;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥çœ‹æ´»åŠ¨è¿›ç¨‹å‡†å¤‡å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;

    EXPLAIN (ANALYZE, BUFFERS, TIMING)
    SELECT
        pid,
        usename,
        application_name,
        state,
        xact_start,
        query_start
    FROM pg_stat_activity;
    ```

3. **BufferåŒºåŸŸï¼ˆæ•°æ®ç¼“å†²åŒºï¼‰**
   - å­˜å‚¨è¡¨å’Œç´¢å¼•çš„æ•°æ®é¡µ
   - ä½¿ç”¨LRUç®—æ³•ç®¡ç†
   - å¤§å°ç”±shared_buffersé…ç½®

    ```sql
    -- ç¼“å†²åŒºé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    DO $$
    DECLARE
        v_shared_buffers TEXT;
        v_effective_cache_size TEXT;
    BEGIN
        BEGIN
            SELECT setting INTO v_shared_buffers FROM pg_settings WHERE name = 'shared_buffers';
            SELECT setting INTO v_effective_cache_size FROM pg_settings WHERE name = 'effective_cache_size';

            RAISE NOTICE 'ç¼“å†²åŒºé…ç½®ï¼š';
            RAISE NOTICE '  shared_buffers: %, effective_cache_size: %',
                v_shared_buffers, v_effective_cache_size;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥çœ‹ç¼“å†²åŒºé…ç½®å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;

    -- æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
    DO $$
    DECLARE
        bgwriter_count INT;
        buffercache_count INT;
    BEGIN
        BEGIN
            SELECT COUNT(*) INTO bgwriter_count FROM pg_stat_bgwriter;
            IF bgwriter_count > 0 THEN
                RAISE NOTICE 'æ‰¾åˆ°ç¼“å†²åŒºå†™å…¥å™¨ç»Ÿè®¡ä¿¡æ¯';
            END IF;

            BEGIN
                SELECT COUNT(*) INTO buffercache_count FROM pg_buffercache;
                IF buffercache_count > 0 THEN
                    RAISE NOTICE 'æ‰¾åˆ°ç¼“å†²åŒºç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆpg_buffercacheæ‰©å±•å·²å®‰è£…ï¼‰';
                END IF;
            EXCEPTION
                WHEN undefined_table THEN
                    RAISE WARNING 'pg_buffercacheæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹ç¼“å†²åŒºç¼“å­˜';
                WHEN OTHERS THEN
                    RAISE WARNING 'æŸ¥çœ‹ç¼“å†²åŒºç¼“å­˜å¤±è´¥: %', SQLERRM;
            END;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;

    EXPLAIN (ANALYZE, BUFFERS, TIMING)
    SELECT * FROM pg_stat_bgwriter;

    -- éœ€è¦pg_buffercacheæ‰©å±•
    EXPLAIN (ANALYZE, BUFFERS, TIMING)
    SELECT * FROM pg_buffercache;
    ```

4. **WALåŒºåŸŸï¼ˆé¢„å†™æ—¥å¿—ç¼“å†²åŒºï¼‰**
   - å­˜å‚¨äº‹åŠ¡æ—¥å¿—çš„ç¼“å†²åŒº
   - ç”±WAL Writerè¿›ç¨‹å®šæœŸåˆ·æ–°
   - å¤§å°ç”±wal_buffersé…ç½®

    ```sql
    -- WALç¼“å†²åŒºé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    DO $$
    DECLARE
        v_wal_buffers TEXT;
        v_wal_writer_delay TEXT;
    BEGIN
        BEGIN
            SELECT setting INTO v_wal_buffers FROM pg_settings WHERE name = 'wal_buffers';
            SELECT setting INTO v_wal_writer_delay FROM pg_settings WHERE name = 'wal_writer_delay';

            RAISE NOTICE 'WALç¼“å†²åŒºé…ç½®ï¼š';
            RAISE NOTICE '  wal_buffers: %, wal_writer_delay: %',
                v_wal_buffers, v_wal_writer_delay;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥çœ‹WALç¼“å†²åŒºé…ç½®å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;

    -- æŸ¥çœ‹WALç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
    DO $$
    DECLARE
        stat_count INT;
    BEGIN
        BEGIN
            SELECT COUNT(*) INTO stat_count FROM pg_stat_wal;
            IF stat_count > 0 THEN
                RAISE NOTICE 'æ‰¾åˆ°WALç»Ÿè®¡ä¿¡æ¯';
            ELSE
                RAISE WARNING 'æœªæ‰¾åˆ°WALç»Ÿè®¡ä¿¡æ¯';
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æŸ¥çœ‹WALç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
                RAISE;
        END;
    END $$;

    EXPLAIN (ANALYZE, BUFFERS, TIMING)
    SELECT * FROM pg_stat_wal;
    ```

**PostgreSQL 18åŠ¨æ€å…±äº«å†…å­˜æ”¹è¿›**:

PostgreSQL 18å¼•å…¥äº†åŠ¨æ€å…±äº«å†…å­˜ç®¡ç†ï¼Œä½¿å…±äº«å†…å­˜åˆ†é…æ›´æ™ºèƒ½ï¼Œå†…å­˜æ•ˆç‡æå‡20%ã€‚

  ```sql
  -- PostgreSQL 18æ–°å¢ï¼šæŸ¥çœ‹å…±äº«å†…å­˜åˆ†é…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
  DO $$
  DECLARE
      shmem_count INT;
  BEGIN
      BEGIN
          SELECT COUNT(*) INTO shmem_count FROM pg_shmem_allocations;
          IF shmem_count > 0 THEN
              RAISE NOTICE 'æ‰¾åˆ° % ä¸ªå…±äº«å†…å­˜åˆ†é…é¡¹ï¼ˆPostgreSQL 18ï¼‰', shmem_count;
          ELSE
              RAISE WARNING 'æœªæ‰¾åˆ°å…±äº«å†…å­˜åˆ†é…ä¿¡æ¯ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
          END IF;
      EXCEPTION
          WHEN undefined_table THEN
              RAISE WARNING 'pg_shmem_allocationsè§†å›¾ä¸å­˜åœ¨ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
          WHEN OTHERS THEN
              RAISE WARNING 'æŸ¥çœ‹å…±äº«å†…å­˜åˆ†é…å‡†å¤‡å¤±è´¥: %', SQLERRM;
              RAISE;
      END;
  END $$;

  EXPLAIN (ANALYZE, BUFFERS, TIMING)
  SELECT * FROM pg_shmem_allocations;

  -- åŠ¨æ€å…±äº«å†…å­˜é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
  DO $$
  DECLARE
      v_dynamic_shmem_type TEXT;
  BEGIN
      BEGIN
          SELECT setting INTO v_dynamic_shmem_type FROM pg_settings WHERE name = 'dynamic_shared_memory_type';
          IF v_dynamic_shmem_type IS NOT NULL THEN
              RAISE NOTICE 'åŠ¨æ€å…±äº«å†…å­˜ç±»å‹: %', v_dynamic_shmem_type;
          ELSE
              RAISE WARNING 'dynamic_shared_memory_typeå‚æ•°ä¸å­˜åœ¨ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
          END IF;
      EXCEPTION
          WHEN undefined_object THEN
              RAISE WARNING 'åŠ¨æ€å…±äº«å†…å­˜é…ç½®å‚æ•°ä¸å­˜åœ¨ï¼ˆå¯èƒ½PostgreSQLç‰ˆæœ¬ä½äº18ï¼‰';
          WHEN OTHERS THEN
              RAISE WARNING 'æŸ¥çœ‹åŠ¨æ€å…±äº«å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
              RAISE;
      END;
  END $$;
  -- postgresql.conf
  -- dynamic_shared_memory_type = posix  -- åŠ¨æ€å…±äº«å†…å­˜ç±»å‹
  ```

**å…±äº«å†…å­˜å¤§å°è®¡ç®—**:

```bash
# å…±äº«å†…å­˜å¤§å°ä¼°ç®—
# shared_buffers + wal_buffers + max_connections * (work_mem + maintenance_work_mem)
# ç¤ºä¾‹ï¼š256MB + 16MB + 100 * (4MB + 64MB) â‰ˆ 7GB
```

**ç›‘æ§å’Œè°ƒä¼˜**:

```sql
-- æŸ¥çœ‹å…±äº«å†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    setting_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO setting_count
        FROM pg_settings
        WHERE name LIKE '%shared%' OR name LIKE '%memory%';

        IF setting_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªå…±äº«å†…å­˜ç›¸å…³é…ç½®å‚æ•°', setting_count;
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°å…±äº«å†…å­˜ç›¸å…³é…ç½®å‚æ•°';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹å…±äº«å†…å­˜ä½¿ç”¨æƒ…å†µå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    setting,
    unit,
    source
FROM pg_settings
WHERE name LIKE '%shared%' OR name LIKE '%memory%'
ORDER BY name;
```

#### 4.2.2 æœ¬åœ°å†…å­˜

æœ¬åœ°å†…å­˜æ˜¯æ¯ä¸ªBackendè¿›ç¨‹ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œç”¨äºæŸ¥è¯¢æ‰§è¡Œã€æ’åºã€å“ˆå¸Œç­‰æ“ä½œã€‚

**å†…å­˜ä¸Šä¸‹æ–‡ç»“æ„**:

```c
// å†…å­˜ä¸Šä¸‹æ–‡ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
typedef struct MemoryContext {
    NodeTag type;                  // ä¸Šä¸‹æ–‡ç±»å‹
    MemoryContext parent;          // çˆ¶ä¸Šä¸‹æ–‡
    MemoryContext firstchild;      // ç¬¬ä¸€ä¸ªå­ä¸Šä¸‹æ–‡
    MemoryContext nextchild;        // ä¸‹ä¸€ä¸ªå­ä¸Šä¸‹æ–‡
    char *name;                    // ä¸Šä¸‹æ–‡åç§°
    bool isReset;                  // é‡ç½®æ ‡å¿—
    Size totalSpace;                // æ€»ç©ºé—´
    Size freeSpace;                 // ç©ºé—²ç©ºé—´
    Size maxSpace;                  // æœ€å¤§ç©ºé—´
} MemoryContext;
```

**å†…å­˜ä¸Šä¸‹æ–‡ç±»å‹**:

1. **TopMemoryContext**
   - é¡¶çº§å†…å­˜ä¸Šä¸‹æ–‡
   - ç”Ÿå‘½å‘¨æœŸä¸è¿›ç¨‹ç›¸åŒ
   - å­˜å‚¨è¿›ç¨‹çº§åˆ«çš„æ•°æ®

2. **CacheMemoryContext**
   - ç¼“å­˜å†…å­˜ä¸Šä¸‹æ–‡
   - å­˜å‚¨ç³»ç»Ÿç¼“å­˜ï¼ˆå¦‚ç³»ç»Ÿè¡¨ç¼“å­˜ï¼‰
   - ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿

3. **MessageContext**
   - æ¶ˆæ¯å†…å­˜ä¸Šä¸‹æ–‡
   - å­˜å‚¨æŸ¥è¯¢ç»“æœå’Œæ¶ˆæ¯
   - æ¯ä¸ªæŸ¥è¯¢é‡ç½®

4. **TupleContext**
   - å…ƒç»„å†…å­˜ä¸Šä¸‹æ–‡
   - å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œä¸­çš„ä¸´æ—¶å…ƒç»„
   - æ¯ä¸ªæ“ä½œé‡ç½®

**æŸ¥è¯¢å†…å­˜é…ç½®**:

```sql
-- æŸ¥è¯¢å†…å­˜é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_work_mem TEXT;
    v_maintenance_work_mem TEXT;
    v_temp_buffers TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_work_mem FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO v_maintenance_work_mem FROM pg_settings WHERE name = 'maintenance_work_mem';
        SELECT setting INTO v_temp_buffers FROM pg_settings WHERE name = 'temp_buffers';

        RAISE NOTICE 'æŸ¥è¯¢å†…å­˜é…ç½®ï¼š';
        RAISE NOTICE '  work_mem: %, maintenance_work_mem: %, temp_buffers: %',
            v_work_mem, v_maintenance_work_mem, v_temp_buffers;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æŸ¥è¯¢å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
-- postgresql.conf
-- work_mem = 4MB                    -- æŸ¥è¯¢å·¥ä½œå†…å­˜ï¼ˆæ’åºã€å“ˆå¸Œï¼‰
-- maintenance_work_mem = 64MB       -- ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆVACUUMã€CREATE INDEXï¼‰
-- temp_buffers = 8MB                -- ä¸´æ—¶ç¼“å†²åŒº
```

**å†…å­˜ä½¿ç”¨åœºæ™¯**:

1. **æ’åºæ“ä½œ**

   ```sql
   -- æ’åºä½¿ç”¨work_mem
   SELECT * FROM large_table ORDER BY column1;
   -- å¦‚æœæ•°æ®é‡è¶…è¿‡work_memï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶
   ```

2. **å“ˆå¸Œæ“ä½œ**

   ```sql
   -- å“ˆå¸Œè¿æ¥ä½¿ç”¨work_mem
   SELECT * FROM table1 JOIN table2 ON table1.id = table2.id;
   ```

3. **èšåˆæ“ä½œ**

   ```sql
   -- GROUP BYä½¿ç”¨work_mem
   SELECT category, COUNT(*) FROM products GROUP BY category;
   ```

**å†…å­˜ç›‘æ§**:

```sql
-- æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO active_count
        FROM pg_stat_activity
        WHERE state = 'active';

        IF active_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ´»åŠ¨è¿›ç¨‹', active_count;
        ELSE
            RAISE NOTICE 'å½“å‰æ²¡æœ‰æ´»åŠ¨è¿›ç¨‹';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    query,
    query_start
FROM pg_stat_activity
WHERE state = 'active';

-- æŸ¥çœ‹ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨ï¼ˆå¦‚æœwork_memä¸è¶³ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_db TEXT;
    db_count INT;
BEGIN
    BEGIN
        SELECT current_database() INTO current_db;
        SELECT COUNT(*) INTO db_count
        FROM pg_stat_database
        WHERE datname = current_db;

        IF db_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°æ•°æ®åº“ % çš„ç»Ÿè®¡ä¿¡æ¯', current_db;
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°å½“å‰æ•°æ®åº“çš„ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_database WHERE datname = current_database();
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**:

- æ ¹æ®æŸ¥è¯¢å¤æ‚åº¦è°ƒæ•´work_mem
- ç›‘æ§ä¸´æ—¶æ–‡ä»¶ä½¿ç”¨æƒ…å†µ
- é¿å…è¿‡å¤§çš„work_memå¯¼è‡´OOM
- ä½¿ç”¨EXPLAIN (ANALYZE, BUFFERS, TIMING)æŸ¥çœ‹å†…å­˜ä½¿ç”¨

### 4.3 å­˜å‚¨ç³»ç»Ÿ

#### 4.3.1 å­˜å‚¨å¼•æ“

PostgreSQLçš„å­˜å‚¨å¼•æ“é‡‡ç”¨å †è¡¨ï¼ˆHeapï¼‰ç»“æ„ï¼Œæ”¯æŒå¤šç§å­˜å‚¨æ ¼å¼å’Œä¼˜åŒ–ç­–ç•¥ã€‚

**å­˜å‚¨ç»“æ„**:

```sql
-- è¡¨ç©ºé—´åˆ›å»ºå’Œç®¡ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶éœ€è¦ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æ­£ç¡®æƒé™
        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fastspace') THEN
            -- CREATE TABLESPACE fastspace LOCATION '/fast/disk';
            RAISE NOTICE 'æç¤ºï¼šåˆ›å»ºè¡¨ç©ºé—´ fastspaceï¼ˆéœ€è¦ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æƒé™ï¼‰';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ fastspace å·²å­˜åœ¨';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'slowspace') THEN
            -- CREATE TABLESPACE slowspace LOCATION '/slow/disk';
            RAISE NOTICE 'æç¤ºï¼šåˆ›å»ºè¡¨ç©ºé—´ slowspaceï¼ˆéœ€è¦ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æƒé™ï¼‰';
        ELSE
            RAISE NOTICE 'è¡¨ç©ºé—´ slowspace å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè¡¨ç©ºé—´';
        WHEN OTHERS THEN
            RAISE WARNING 'è¡¨ç©ºé—´åˆ›å»ºæ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE NOTICE 'è¡¨ large_table å·²å­˜åœ¨';
        ELSE
            -- éœ€è¦å…ˆç¡®ä¿è¡¨ç©ºé—´å­˜åœ¨
            IF EXISTS (SELECT 1 FROM pg_tablespace WHERE spcname = 'fastspace') THEN
                CREATE TABLE large_table (
                    id SERIAL PRIMARY KEY,
                    data TEXT,
                    created_at TIMESTAMP DEFAULT NOW()
                ) TABLESPACE fastspace;
                RAISE NOTICE 'è¡¨ large_table åœ¨è¡¨ç©ºé—´ fastspace ä¸­åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE WARNING 'è¡¨ç©ºé—´ fastspace ä¸å­˜åœ¨ï¼Œæ— æ³•åœ¨æŒ‡å®šè¡¨ç©ºé—´åˆ›å»ºè¡¨';
            END IF;
        END IF;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE WARNING 'è¡¨ç©ºé—´ fastspace ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ large_table å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    tablespace_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO tablespace_count FROM pg_tablespace;
        IF tablespace_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªè¡¨ç©ºé—´', tablespace_count;
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°è¡¨ç©ºé—´';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) AS size
FROM pg_tablespace;
```

**å­˜å‚¨ç»„ä»¶è¯¦è§£**:

1. **Heapå­˜å‚¨ï¼ˆå †è¡¨ï¼‰**
   - PostgreSQLé»˜è®¤å­˜å‚¨æ ¼å¼
   - æ”¯æŒMVCCå¤šç‰ˆæœ¬æ§åˆ¶
   - è¡Œå­˜å‚¨æ ¼å¼ï¼ˆHeap Tupleï¼‰

  ```sql
  -- æŸ¥çœ‹è¡¨å­˜å‚¨ä¿¡æ¯
  SELECT
      schemaname,
      tablename,
      pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
      pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
      pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) AS indexes_size
  FROM pg_tables
  WHERE schemaname = 'public'
  ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
  ```

**è¡Œå­˜å‚¨æ ¼å¼**:

  ```c
  // Heap Tupleç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
  typedef struct HeapTupleHeader {
      uint32 t_xmin;          // æ’å…¥äº‹åŠ¡ID
      uint32 t_xmax;          // åˆ é™¤äº‹åŠ¡ID
      uint32 t_cid;           // å‘½ä»¤ID
      uint16 t_infomask;      // ä¿¡æ¯æ©ç 
      uint16 t_hoff;          // å¤´éƒ¨åç§»
      bits8 t_bits[];         // NULLä½å›¾
      char t_data[];          // å®é™…æ•°æ®
  } HeapTupleHeader;
  ```

1. **Indexå­˜å‚¨ï¼ˆç´¢å¼•ï¼‰**
   - B-Treeç´¢å¼•ï¼ˆé»˜è®¤ï¼‰
   - Hashç´¢å¼•
   - GINç´¢å¼•ï¼ˆå…¨æ–‡æœç´¢ï¼‰
   - GiSTç´¢å¼•ï¼ˆç©ºé—´æ•°æ®ï¼‰
   - BRINç´¢å¼•ï¼ˆå—èŒƒå›´ï¼‰
   - HNSWç´¢å¼•ï¼ˆå‘é‡ï¼Œpgvectorï¼‰

    ```sql
    -- åˆ›å»ºä¸åŒç±»å‹çš„ç´¢å¼•
    CREATE INDEX idx_btree ON table1 (column1);           -- B-Tree
    CREATE INDEX idx_hash ON table1 USING hash (column1); -- Hash
    CREATE INDEX idx_gin ON table1 USING gin (column1);   -- GIN
    CREATE INDEX idx_gist ON table1 USING gist (column1); -- GiST
    CREATE INDEX idx_brin ON table1 USING brin (column1); -- BRIN

    -- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
    SELECT
        schemaname,
        tablename,
        indexname,
        idx_scan,
        idx_tup_read,
        idx_tup_fetch
    FROM pg_stat_user_indexes
    ORDER BY idx_scan DESC;
    ```

2. **WALå­˜å‚¨ï¼ˆé¢„å†™æ—¥å¿—ï¼‰**
   - äº‹åŠ¡æ—¥å¿—å­˜å‚¨
   - æ”¯æŒå½’æ¡£å’Œæµå¤åˆ¶
   - PostgreSQL 18æ”¯æŒå¢é‡å¤‡ä»½

    ```sql
    -- WALé…ç½®
    -- postgresql.conf
    wal_level = replica              -- WALçº§åˆ«ï¼ˆreplica/logicalï¼‰
    archive_mode = on                -- å¯ç”¨å½’æ¡£
    archive_command = 'cp %p /backup/wal/%f' -- å½’æ¡£å‘½ä»¤

    -- æŸ¥çœ‹WALä¿¡æ¯
    SELECT * FROM pg_stat_wal;
    SELECT pg_current_wal_lsn();     -- å½“å‰WALä½ç½®
    ```

3. **Temporaryå­˜å‚¨ï¼ˆä¸´æ—¶æ•°æ®ï¼‰**
   - ä¸´æ—¶è¡¨å’Œä¸´æ—¶æ–‡ä»¶
   - å­˜å‚¨åœ¨ä¸´æ—¶è¡¨ç©ºé—´
   - ä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†

    ```sql
    -- ä¸´æ—¶è¡¨ç©ºé—´é…ç½®
    CREATE TEMPORARY TABLESPACE temp_fast LOCATION '/fast/temp';

    -- è®¾ç½®ä¸´æ—¶è¡¨ç©ºé—´
    SET temp_tablespaces = 'temp_fast';

    -- åˆ›å»ºä¸´æ—¶è¡¨
    CREATE TEMP TABLE temp_data AS SELECT * FROM large_table;
    ```

**PostgreSQL 18å­˜å‚¨æ”¹è¿›**:

- **å¼‚æ­¥I/Oå­ç³»ç»Ÿ**: I/Oæ€§èƒ½æå‡2-3å€
  - ç‰¹åˆ«é€‚ç”¨äºå‘é‡æ£€ç´¢ç­‰I/Oå¯†é›†å‹æ“ä½œ
  - æ”¯æŒå¼‚æ­¥é¢„è¯»å’Œå†™å…¥
  - å‡å°‘I/Oç­‰å¾…æ—¶é—´

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
-- postgresql.conf
effective_io_concurrency = 200   -- æœ‰æ•ˆI/Oå¹¶å‘æ•°
maintenance_io_concurrency = 10  -- ç»´æŠ¤I/Oå¹¶å‘æ•°

-- æŸ¥çœ‹I/Oç»Ÿè®¡
SELECT * FROM pg_stat_io;
```

#### 4.3.2 ç¼“å†²åŒºç®¡ç†

ç¼“å†²åŒºç®¡ç†æ˜¯PostgreSQLæ€§èƒ½çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£åœ¨å†…å­˜å’Œç£ç›˜ä¹‹é—´é«˜æ•ˆåœ°ç®¡ç†æ•°æ®é¡µã€‚

**ç¼“å†²åŒºç®¡ç†ç®—æ³•**:

```c
// ç¼“å†²åŒºç®¡ç†æ§åˆ¶ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
typedef struct BufferStrategyControl {
    BufferTag *buffer_tags;        // ç¼“å†²åŒºæ ‡ç­¾ï¼ˆè¡¨OID+é¡µå·ï¼‰
    int *buffer_usage_count;       // ä½¿ç”¨è®¡æ•°ï¼ˆLRUï¼‰
    int *buffer_dirty_flags;       // è„é¡µæ ‡å¿—
    LWLock *buffer_io_lock;        // IOé”
    int *buffer_pin_count;         // å›ºå®šè®¡æ•°
    XLogRecPtr *buffer_lsn;        // é¡µé¢LSN
} BufferStrategyControl;
```

**ç¼“å†²åŒºç®¡ç†ç­–ç•¥**:

PostgreSQLä½¿ç”¨å¤šç§ç­–ç•¥ç®¡ç†ç¼“å†²åŒºï¼š

**1. LRUç®—æ³•ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰**:

ä½¿ç”¨è®¡æ•°è·Ÿè¸ªé¡µé¢è®¿é—®é¢‘ç‡ï¼Œä¼˜å…ˆæ·˜æ±°æœ€å°‘ä½¿ç”¨çš„é¡µé¢ï¼Œæ”¯æŒæ—¶é’Ÿæ‰«æç®—æ³•ä¼˜åŒ–ã€‚

**2. é¢„è¯»æœºåˆ¶ï¼ˆRead-Aheadï¼‰**:

é¡ºåºæ‰«ææ—¶é¢„è¯»åç»­é¡µé¢ï¼Œå‡å°‘I/Oç­‰å¾…æ—¶é—´ï¼ŒPostgreSQL 18å¼‚æ­¥I/Oå¢å¼ºé¢„è¯»æ€§èƒ½ã€‚

```sql
-- é¢„è¯»é…ç½®
-- postgresql.conf
effective_io_concurrency = 200   -- æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18ï¼‰

-- æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    hit_ratio numeric;
BEGIN
    BEGIN
        SELECT
            sum(heap_blks_hit)::numeric / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0)::numeric
        INTO hit_ratio
        FROM pg_statio_user_tables;

        IF hit_ratio IS NULL THEN
            RAISE WARNING 'æ— æ³•è®¡ç®—ç¼“å†²åŒºå‘½ä¸­ç‡ï¼Œå¯èƒ½æ²¡æœ‰ç»Ÿè®¡æ•°æ®';
        ELSE
            RAISE NOTICE 'ç¼“å†²åŒºå‘½ä¸­ç‡: %%%', ROUND(hit_ratio * 100, 2);
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ç¼“å†²åŒºå‘½ä¸­ç‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    sum(heap_blks_read) as heap_read,
    sum(heap_blks_hit) as heap_hit,
    sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0) as hit_ratio
FROM pg_statio_user_tables;
```

**3. è„é¡µåˆ·æ–°**:

Checkpointerè¿›ç¨‹å®šæœŸåˆ·æ–°ï¼Œåå°å†™å…¥å™¨ï¼ˆBackground Writerï¼‰è¾…åŠ©åˆ·æ–°ï¼ŒPostgreSQL 18æ”¯æŒå¼‚æ­¥åˆ·æ–°ã€‚

```sql
-- ç¼“å†²åŒºå†™å…¥é…ç½®
-- postgresql.conf
bgwriter_delay = 200ms            -- åå°å†™å…¥å™¨å»¶è¿Ÿ
bgwriter_lru_maxpages = 100      -- æœ€å¤§åˆ·æ–°é¡µæ•°
bgwriter_lru_multiplier = 2.0    -- LRUä¹˜æ•°

-- æŸ¥çœ‹åå°å†™å…¥å™¨ç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;
```

**ç¼“å†²åŒºç›‘æ§**:

```sql
-- å®‰è£…pg_buffercacheæ‰©å±•æŸ¥çœ‹ç¼“å†²åŒºå†…å®¹
CREATE EXTENSION IF NOT EXISTS pg_buffercache;

-- æŸ¥çœ‹ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
SELECT
    c.relname,
    count(*) as buffers,
    pg_size_pretty(count(*) * 8192) as size
FROM pg_buffercache b
JOIN pg_class c ON b.relfilenode = pg_relation_filenode(c.oid)
WHERE b.reldatabase IN (0, (SELECT oid FROM pg_database WHERE datname = current_database()))
GROUP BY c.relname
ORDER BY count(*) DESC
LIMIT 10;

-- æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆåº”è¯¥>95%ï¼‰
SELECT
    'Buffer Hit Ratio' as metric,
    round(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2) as percentage
FROM pg_statio_user_tables;
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**:

- **shared_buffers**: è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„25%ï¼ˆLinuxï¼‰æˆ–40%ï¼ˆWindowsï¼‰
- **effective_cache_size**: è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%
- **ç›‘æ§å‘½ä¸­ç‡**: ç›®æ ‡>95%
- **è°ƒæ•´é¢„è¯»**: æ ¹æ®å­˜å‚¨ç±»å‹è°ƒæ•´effective_io_concurrency

**PostgreSQL 18æ”¹è¿›**:

- å¼‚æ­¥I/Oå­ç³»ç»Ÿæå‡I/Oæ€§èƒ½2-3å€
- æ”¹è¿›çš„ç¼“å†²åŒºé¢„è¯»ç®—æ³•
- æ›´é«˜æ•ˆçš„è„é¡µåˆ·æ–°æœºåˆ¶

### 4.4 ç½‘ç»œåè®®

#### 4.4.1 PostgreSQLåè®®

PostgreSQLä½¿ç”¨åŸºäºæ¶ˆæ¯çš„åè®®è¿›è¡Œå®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡ï¼Œæ”¯æŒå¤šç§è®¤è¯æ–¹å¼å’Œå®‰å…¨æœºåˆ¶ã€‚

**åè®®æ¶ˆæ¯ç»“æ„**:

```c
// åè®®æ¶ˆæ¯ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
typedef struct ProtocolMessage {
    char msg_type;          // æ¶ˆæ¯ç±»å‹
    uint32 msg_length;     // æ¶ˆæ¯é•¿åº¦
    char msg_data[];       // æ¶ˆæ¯æ•°æ®
} ProtocolMessage;
```

**åè®®æ¶ˆæ¯ç±»å‹**:

1. **å¯åŠ¨æ¶ˆæ¯ï¼ˆStartupMessageï¼‰**
   - å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚
   - åŒ…å«åè®®ç‰ˆæœ¬å’Œå‚æ•°

2. **æŸ¥è¯¢æ¶ˆæ¯ï¼ˆQueryï¼‰**
   - SQLæŸ¥è¯¢è¯·æ±‚
   - åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²

3. **è§£ææ¶ˆæ¯ï¼ˆParseï¼‰**
   - é¢„ç¼–è¯‘è¯­å¥è§£æ
   - å‚æ•°ç±»å‹å£°æ˜

4. **ç»‘å®šæ¶ˆæ¯ï¼ˆBindï¼‰**
   - å‚æ•°ç»‘å®š
   - ç»“æœæ ¼å¼æŒ‡å®š

5. **æ‰§è¡Œæ¶ˆæ¯ï¼ˆExecuteï¼‰**
   - æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥
   - è¿”å›ç»“æœé›†

**è¿æ¥å»ºç«‹æµç¨‹**:

```sql
-- 1. å®¢æˆ·ç«¯å‘èµ·è¿æ¥
-- psql postgresql://user@host:5432/dbname

-- 2. æœåŠ¡å™¨å“åº”è®¤è¯è¯·æ±‚
-- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š
--   - trustï¼ˆä¿¡ä»»ï¼‰
--   - passwordï¼ˆå¯†ç ï¼‰
--   - md5ï¼ˆMD5å“ˆå¸Œï¼‰
--   - scram-sha-256ï¼ˆSCRAM-SHA-256ï¼‰
--   - oauth2ï¼ˆOAuth 2.0ï¼ŒPostgreSQL 18ï¼‰

-- 3. è®¤è¯æˆåŠŸåå»ºç«‹ä¼šè¯
```

**è®¤è¯é…ç½®**:

```bash
# pg_hba.confé…ç½®ç¤ºä¾‹
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             0.0.0.0/0               oauth2  # PostgreSQL 18
hostssl all             all             0.0.0.0/0               scram-sha-256
```

**PostgreSQL 18 OAuth 2.0è®¤è¯**:

PostgreSQL 18æ–°å¢OAuth 2.0èº«ä»½éªŒè¯æ”¯æŒï¼Œæä¾›æ›´å®‰å…¨çš„è®¤è¯æœºåˆ¶ã€‚

```sql
-- OAuth 2.0é…ç½®ç¤ºä¾‹
-- postgresql.conf
oauth2.issuer = 'https://auth.example.com'
oauth2.client_id = 'postgresql-client'
oauth2.client_secret = 'secret'
oauth2.scope = 'openid profile'

-- pg_hba.conf
host    all             all             0.0.0.0/0               oauth2
```

**SSL/TLSæ”¯æŒ**:

```bash
# SSLé…ç½®
# postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'

# å®¢æˆ·ç«¯è¿æ¥ï¼ˆSSLï¼‰
psql "postgresql://user@host:5432/dbname?sslmode=require"
```

**è¿æ¥æ± ç®¡ç†**:

```sql
-- ä½¿ç”¨pgBouncerè¿æ¥æ± 
-- pgbouncer.ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

**æ€§èƒ½ä¼˜åŒ–**:

- ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿›ç¨‹åˆ›å»ºå¼€é”€
- å¯ç”¨SSL/TLSä¿æŠ¤æ•°æ®ä¼ è¾“
- é…ç½®åˆç†çš„max_connections
- ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥å‡å°‘è§£æå¼€é”€

**ç›‘æ§è¿æ¥**:

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change
FROM pg_stat_activity
WHERE datname = current_database();

-- æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname = current_database();
```

**åè®®ç‰¹æ€§**:

- **äºŒè¿›åˆ¶åè®®**: é«˜æ•ˆçš„æ•°æ®ä¼ è¾“
- **SSLæ”¯æŒ**: åŠ å¯†é€šä¿¡
- **è¿æ¥æ± **: è¿æ¥å¤ç”¨
- **å¼‚æ­¥æ”¯æŒ**: å¼‚æ­¥æŸ¥è¯¢å¤„ç†

## äº”ã€å®é™…åº”ç”¨

### 5.1 é«˜å¹¶å‘åº”ç”¨åœºæ™¯

PostgreSQLçš„è¿›ç¨‹æ¨¡å‹å’Œå†…å­˜ç®¡ç†è®¾è®¡ä½¿å…¶èƒ½å¤Ÿæ”¯æŒé«˜å¹¶å‘åº”ç”¨åœºæ™¯ã€‚

**é«˜å¹¶å‘æ¶æ„è®¾è®¡**:

PostgreSQLä½¿ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¹åº”ä¸€ä¸ªBackendè¿›ç¨‹ï¼Œå®ç°çœŸæ­£çš„å¹¶å‘å¤„ç†ã€‚

```sql
-- è¿æ¥æ± é…ç½®
-- postgresql.conf
max_connections = 200              -- æœ€å¤§è¿æ¥æ•°
shared_buffers = 256MB              -- å…±äº«ç¼“å†²åŒºå¤§å°
work_mem = 4MB                      -- æ¯ä¸ªæŸ¥è¯¢çš„å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB         -- ç»´æŠ¤æ“ä½œå†…å­˜
effective_cache_size = 1GB          -- æœ‰æ•ˆç¼“å­˜å¤§å°
```

**è¿æ¥ç®¡ç†ä¼˜åŒ–**:

```sql
-- 1. ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€
-- PgBounceré…ç½®ç¤ºä¾‹
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25

-- 2. ç›‘æ§è¿æ¥çŠ¶æ€
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active_connections,
    count(*) FILTER (WHERE state = 'idle') as idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction
FROM pg_stat_activity
WHERE datname = current_database();

-- 3. è¯†åˆ«é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    now() - query_start as duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND now() - query_start > interval '5 minutes'
ORDER BY duration DESC;
```

**é«˜å¹¶å‘æ€§èƒ½è°ƒä¼˜**:

```sql
-- 1. è°ƒæ•´å…±äº«å†…å­˜
-- å»ºè®®è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„25%
-- ä¾‹å¦‚ï¼š32GBå†…å­˜ç³»ç»Ÿï¼Œè®¾ç½®shared_buffers = 8GB
shared_buffers = 8GB

-- 2. ä¼˜åŒ–å·¥ä½œå†…å­˜
-- æ ¹æ®å¹¶å‘è¿æ¥æ•°å’ŒæŸ¥è¯¢å¤æ‚åº¦è°ƒæ•´
-- work_mem = (æ€»å†…å­˜ - shared_buffers) / (max_connections * 2)
work_mem = 16MB

-- 3. å¯ç”¨JITç¼–è¯‘ï¼ˆPostgreSQL 11+ï¼‰
jit = on
jit_above_cost = 100000

-- 4. å¹¶è¡ŒæŸ¥è¯¢é…ç½®
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_worker_processes = 8
```

**åº”ç”¨æ¡ˆä¾‹**:

- **Webåº”ç”¨**: æ”¯æŒé«˜å¹¶å‘ç”¨æˆ·è®¿é—®
  - ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBouncerï¼‰ç®¡ç†è¿æ¥
  - è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½
  - ç¼“å­˜çƒ­ç‚¹æ•°æ®å‡å°‘æ•°æ®åº“å‹åŠ›

- **OLTPç³»ç»Ÿ**: äº‹åŠ¡å¯†é›†å‹åº”ç”¨
  - ä¼˜åŒ–äº‹åŠ¡å¤„ç†æµç¨‹
  - ä½¿ç”¨MVCCå‡å°‘é”ç«äº‰
  - åˆç†è®¾ç½®éš”ç¦»çº§åˆ«

- **æ•°æ®ä»“åº“**: åˆ†ææŸ¥è¯¢å¤„ç†
  - å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
  - ä½¿ç”¨åˆ—å¼å­˜å‚¨æ‰©å±•ï¼ˆcstore_fdwï¼‰
  - ç‰©åŒ–è§†å›¾é¢„è®¡ç®—

- **å®æ—¶ç³»ç»Ÿ**: ä½å»¶è¿Ÿæ•°æ®å¤„ç†
  - å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
  - æµå¤åˆ¶å®ç°å®æ—¶åŒæ­¥
  - é€»è¾‘å¤åˆ¶æ”¯æŒå®æ—¶æ•°æ®åˆ†å‘

### 5.2 é«˜å¯ç”¨éƒ¨ç½²

PostgreSQLçš„é«˜å¯ç”¨éƒ¨ç½²åŸºäºæµå¤åˆ¶å’ŒWALæœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’ŒæœåŠ¡å¯ç”¨æ€§ã€‚

**æµå¤åˆ¶æ¶æ„**:

PostgreSQLä½¿ç”¨WALï¼ˆWrite-Ahead Loggingï¼‰å®ç°ä¸»ä»å¤åˆ¶ï¼Œä¸»åº“å°†WALè®°å½•æµå¼ä¼ è¾“åˆ°ä»åº“ã€‚

```sql
-- ä¸»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica                    -- WALçº§åˆ«
max_wal_senders = 3                    -- æœ€å¤§WALå‘é€è¿›ç¨‹æ•°
wal_keep_size = 1GB                    -- ä¿ç•™çš„WALå¤§å°ï¼ˆPostgreSQL 13+ï¼‰
# wal_keep_segments = 32               -- PostgreSQL 12åŠä»¥ä¸‹ä½¿ç”¨

-- ä»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
hot_standby = on                        -- å¯ç”¨çƒ­å¤‡
primary_conninfo = 'host=master port=5432 user=repl password=repl_pass'
```

**é«˜å¯ç”¨éƒ¨ç½²æ–¹æ¡ˆ**:

#### 1. ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slaveï¼‰

```sql
-- ä¸»åº“åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER repl REPLICATION LOGIN PASSWORD 'repl_pass';

-- é…ç½®pg_hba.conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    replication     repl            192.168.1.0/24          md5

-- ä»åº“åˆå§‹åŒ–
pg_basebackup -h master -U repl -D /var/lib/postgresql/data -P -W

-- ä»åº“åˆ›å»ºrecovery.confï¼ˆPostgreSQL 12åŠä»¥ä¸‹ï¼‰
standby_mode = 'on'
primary_conninfo = 'host=master port=5432 user=repl password=repl_pass'
trigger_file = '/tmp/promote_standby'

-- PostgreSQL 13+ä½¿ç”¨postgresql.auto.conf
primary_conninfo = 'host=master port=5432 user=repl password=repl_pass'
```

#### 2. æµå¤åˆ¶ç›‘æ§

```sql
-- ä¸»åº“æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) as lag_bytes
FROM pg_stat_replication;

-- ä»åº“æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    pg_last_wal_receive_lsn() as receive_lsn,
    pg_last_wal_replay_lsn() as replay_lsn,
    pg_wal_lsn_diff(
        pg_last_wal_receive_lsn(),
        pg_last_wal_replay_lsn()
    ) as lag_bytes,
    now() - pg_last_xact_replay_timestamp() as lag_time;
```

#### 3. æ•…éšœåˆ‡æ¢ï¼ˆFailoverï¼‰

```sql
-- ä»åº“æå‡ä¸ºä¸»åº“ï¼ˆPostgreSQL 12åŠä»¥ä¸‹ï¼‰
-- åˆ›å»ºè§¦å‘æ–‡ä»¶
touch /tmp/promote_standby

-- PostgreSQL 13+ä½¿ç”¨pg_promote()
SELECT pg_promote();

-- æ£€æŸ¥ä¸»ä»çŠ¶æ€
SELECT pg_is_in_recovery();
-- false = ä¸»åº“ï¼Œtrue = ä»åº“
```

#### 4. é«˜å¯ç”¨æ¶æ„æ¨¡å¼

- **ä¸€ä¸»ä¸€ä»**: ç®€å•é«˜å¯ç”¨æ–¹æ¡ˆ
- **ä¸€ä¸»å¤šä»**: è¯»å†™åˆ†ç¦»ï¼Œæå‡è¯»æ€§èƒ½
- **çº§è”å¤åˆ¶**: ä¸»åº“ -> ä»åº“1 -> ä»åº“2ï¼Œå‡å°‘ä¸»åº“å‹åŠ›
- **é€»è¾‘å¤åˆ¶**: æ”¯æŒè¡¨çº§å¤åˆ¶ï¼Œçµæ´»çš„æ•°æ®åˆ†å‘

**PostgreSQL 18é«˜å¯ç”¨æ”¹è¿›**:

- **å¢é‡å¤‡ä»½**: WAL Summarizerè¿›ç¨‹æ”¯æŒå¢é‡å¤‡ä»½ï¼ŒèŠ‚çœ94%å¤‡ä»½æ—¶é—´
- **æµå¤åˆ¶æ€§èƒ½**: æ”¹è¿›çš„WALä¼ è¾“æ€§èƒ½
- **ç›‘æ§å¢å¼º**: æ›´è¯¦ç»†çš„å¤åˆ¶çŠ¶æ€ç›‘æ§

## å…­ã€æ€§èƒ½åˆ†æ

### 6.1 ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

PostgreSQLçš„æ€§èƒ½æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿçš„æ•´ä½“è¿è¡ŒçŠ¶æ€å’Œæ•ˆç‡ã€‚

**æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡**:

#### 1. å¹¶å‘è¿æ¥æ•°

PostgreSQLæ”¯æŒæ•°åƒä¸ªå¹¶å‘è¿æ¥ï¼Œä½†éœ€è¦åˆç†é…ç½®èµ„æºã€‚

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active,
    count(*) FILTER (WHERE state = 'idle') as idle,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction
FROM pg_stat_activity;

-- æŸ¥çœ‹è¿æ¥æ•°è¶‹åŠ¿
SELECT
    count(*) as connections,
    state,
    application_name
FROM pg_stat_activity
GROUP BY state, application_name
ORDER BY connections DESC;
```

#### 2. äº‹åŠ¡ååé‡

TPSï¼ˆTransactions Per Secondï¼‰æ˜¯è¡¡é‡æ•°æ®åº“æ€§èƒ½çš„é‡è¦æŒ‡æ ‡ã€‚

```sql
-- æŸ¥çœ‹äº‹åŠ¡ç»Ÿè®¡
SELECT
    datname,
    xact_commit as commits,
    xact_rollback as rollbacks,
    xact_commit + xact_rollback as total_transactions,
    xact_commit::numeric / NULLIF(xact_commit + xact_rollback, 0) * 100 as commit_rate
FROM pg_stat_database
WHERE datname = current_database();

-- ä½¿ç”¨pg_stat_statementsæŸ¥çœ‹æŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

#### 3. æŸ¥è¯¢å“åº”æ—¶é—´

æŸ¥è¯¢å“åº”æ—¶é—´æ˜¯ç”¨æˆ·ä½“éªŒçš„å…³é”®æŒ‡æ ‡ã€‚

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    pid,
    now() - query_start as duration,
    state,
    query
FROM pg_stat_activity
WHERE state != 'idle'
  AND now() - query_start > interval '1 second'
ORDER BY duration DESC;

-- ä½¿ç”¨pg_stat_statementsåˆ†ææŸ¥è¯¢æ€§èƒ½
SELECT
    left(query, 100) as query_preview,
    calls,
    mean_exec_time,
    (mean_exec_time * calls) as total_time,
    rows / calls as avg_rows
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
ORDER BY total_time DESC
LIMIT 20;
```

#### 4. å†…å­˜ä½¿ç”¨æ•ˆç‡

å†…å­˜ä½¿ç”¨æ•ˆç‡ç›´æ¥å½±å“æ•°æ®åº“æ€§èƒ½ã€‚

```sql
-- æŸ¥çœ‹å…±äº«å†…å­˜ä½¿ç”¨
SELECT
    name,
    setting,
    unit,
    source
FROM pg_settings
WHERE name IN ('shared_buffers', 'effective_cache_size', 'work_mem', 'maintenance_work_mem');

-- PostgreSQL 18æ–°å¢ï¼šæŸ¥çœ‹å…±äº«å†…å­˜åˆ†é…
SELECT
    name,
    off,
    size,
    allocated_size
FROM pg_shmem_allocations
ORDER BY allocated_size DESC
LIMIT 20;

-- æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) as heap_read,
    sum(heap_blks_hit) as heap_hit,
    sum(heap_blks_hit)::numeric / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0) * 100 as cache_hit_rate
FROM pg_statio_user_tables;
```

#### 5. I/Oæ€§èƒ½æŒ‡æ ‡

I/Oæ€§èƒ½æ˜¯æ•°æ®åº“æ€§èƒ½çš„ç“¶é¢ˆä¹‹ä¸€ã€‚

```sql
-- æŸ¥çœ‹I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    (heap_blks_hit + idx_blks_hit)::numeric /
    NULLIF(heap_blks_hit + idx_blks_hit + heap_blks_read + idx_blks_read, 0) * 100 as cache_hit_rate
FROM pg_statio_user_tables
ORDER BY heap_blks_read + idx_blks_read DESC
LIMIT 20;

-- PostgreSQL 18å¼‚æ­¥I/Oç»Ÿè®¡
-- æŸ¥çœ‹å¼‚æ­¥I/Oé…ç½®
SHOW effective_io_concurrency;
SHOW maintenance_io_concurrency;
```

**æ€§èƒ½åŸºå‡†æµ‹è¯•**:

```sql
-- ä½¿ç”¨pgbenchè¿›è¡ŒåŸºå‡†æµ‹è¯•
-- åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
pgbench -i -s 100 mydb  -- -s 100è¡¨ç¤º100å€æ ‡å‡†è§„æ¨¡

-- è¿è¡ŒåŸºå‡†æµ‹è¯•
pgbench -c 10 -j 2 -T 60 mydb  -- 10ä¸ªå®¢æˆ·ç«¯ï¼Œ2ä¸ªçº¿ç¨‹ï¼Œè¿è¡Œ60ç§’

-- æŸ¥çœ‹æµ‹è¯•ç»“æœ
-- TPS: æ¯ç§’äº‹åŠ¡æ•°
-- Latency: å¹³å‡å»¶è¿Ÿ
-- 99th percentile latency: 99%å»¶è¿Ÿ
```

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

PostgreSQLæ€§èƒ½ä¼˜åŒ–éœ€è¦ä»å¤šä¸ªç»´åº¦è¿›è¡Œï¼ŒåŒ…æ‹¬é…ç½®è°ƒä¼˜ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–ç­‰ã€‚

#### 1. é…ç½®å‚æ•°ä¼˜åŒ–

```sql
-- å†…å­˜é…ç½®ä¼˜åŒ–
-- shared_buffers: è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„25%
shared_buffers = 8GB  -- 32GBå†…å­˜ç³»ç»Ÿ

-- effective_cache_size: è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%
effective_cache_size = 24GB

-- work_mem: æ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´
-- work_mem = (æ€»å†…å­˜ - shared_buffers) / (max_connections * 2)
work_mem = 16MB

-- maintenance_work_mem: ç»´æŠ¤æ“ä½œå†…å­˜
maintenance_work_mem = 1GB

-- æ£€æŸ¥ç‚¹ä¼˜åŒ–
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB

-- è¿æ¥ä¼˜åŒ–
max_connections = 200
```

#### 2. æŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¯ç”¨æŸ¥è¯¢è®¡åˆ’ç¼“å­˜
-- PostgreSQLè‡ªåŠ¨ç¼“å­˜æŸ¥è¯¢è®¡åˆ’

-- ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees WHERE dept_id = 10;

-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    (total_exec_time / calls) as avg_time_per_call
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- è¯†åˆ«éœ€è¦ä¼˜åŒ–çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    (mean_exec_time * calls) as total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
ORDER BY total_time DESC;
```

#### 3. ç´¢å¼•ä¼˜åŒ–

```sql
-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- åˆ›å»ºåˆé€‚çš„ç´¢å¼•
CREATE INDEX idx_emp_dept_salary ON employees(dept_id, salary);
CREATE INDEX idx_emp_name_trgm ON employees USING gin(name gin_trgm_ops);
```

#### 4. è¡¨ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

```sql
-- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- é’ˆå¯¹ç‰¹å®šè¡¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE employees;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯è´¨é‡
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE n_dead_tup > n_live_tup * 0.1;  -- æ­»å…ƒç»„è¶…è¿‡10%
```

#### 5. VACUUMä¼˜åŒ–

```sql
-- è‡ªåŠ¨VACUUMé…ç½®
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

-- æ‰‹åŠ¨VACUUM
VACUUM ANALYZE employees;

-- æŸ¥çœ‹VACUUMç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;
```

#### 6. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_worker_processes = 8

-- å¹¶è¡ŒæŸ¥è¯¢é˜ˆå€¼
parallel_setup_cost = 1000
parallel_tuple_cost = 0.01
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512KB

-- æŸ¥çœ‹å¹¶è¡ŒæŸ¥è¯¢ä½¿ç”¨æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table WHERE column1 > 1000;
```

#### 7. PostgreSQL 18æ€§èƒ½ä¼˜åŒ–æ–°ç‰¹æ€§

```sql
-- å¼‚æ­¥I/Oé…ç½®ï¼ˆPostgreSQL 18ï¼‰
effective_io_concurrency = 200  -- SSDç¯å¢ƒ
maintenance_io_concurrency = 10

-- æŸ¥çœ‹å¼‚æ­¥I/Oæ•ˆæœ
-- å¼‚æ­¥I/Oå¯ä»¥æå‡I/Oæ€§èƒ½2-3å€ï¼Œç‰¹åˆ«é€‚ç”¨äºå‘é‡æ£€ç´¢

-- åŠ¨æ€å…±äº«å†…å­˜ï¼ˆPostgreSQL 18ï¼‰
-- å…±äº«å†…å­˜ç®¡ç†æ›´æ™ºèƒ½ï¼Œå†…å­˜æ•ˆç‡æå‡20%
-- ä½¿ç”¨pg_shmem_allocationsè§†å›¾ç›‘æ§
SELECT * FROM pg_shmem_allocations;
```

**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**:

- [ ] åˆç†é…ç½®shared_bufferså’Œeffective_cache_size
- [ ] æ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´work_mem
- [ ] å¯ç”¨è‡ªåŠ¨VACUUMå’ŒANALYZE
- [ ] åˆ›å»ºåˆé€‚çš„ç´¢å¼•å¹¶å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„ç´¢å¼•
- [ ] å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- [ ] ä½¿ç”¨EXPLAINåˆ†ææ…¢æŸ¥è¯¢
- [ ] å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 9.6+ï¼‰
- [ ] é…ç½®å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
- [ ] ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
- [ ] ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

## ä¸ƒã€ç›¸å…³æ¦‚å¿µ

### 7.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„ç³»ç»Ÿç±»åˆ«
- **å…³ç³»æ•°æ®åº“**: æ•°æ®æ¨¡å‹ç±»å‹
- **å®¢æˆ·ç«¯-æœåŠ¡å™¨ç³»ç»Ÿ**: æ¶æ„æ¨¡å¼

### 7.2 ä¸‹ä½æ¦‚å¿µ

- **Postmasterè¿›ç¨‹**: ç³»ç»Ÿç®¡ç†è¿›ç¨‹
- **Backendè¿›ç¨‹**: æŸ¥è¯¢å¤„ç†è¿›ç¨‹
- **å…±äº«å†…å­˜**: è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶
- **WALæœºåˆ¶**: äº‹åŠ¡æ—¥å¿—ç³»ç»Ÿ

### 7.3 å¹³è¡Œæ¦‚å¿µ

- **MySQL**: å…¶ä»–å…³ç³»æ•°æ®åº“
- **Oracle**: å•†ä¸šæ•°æ®åº“ç³»ç»Ÿ
- **SQL Server**: å¾®è½¯æ•°æ®åº“ç³»ç»Ÿ

---

## å…«ã€å‚è€ƒèµ„æº

### 8.1 ç›¸å…³æ–‡æ¡£

- [PostgreSQLå†å²ä¸å‘å±•](../../01.00-PostgreSQLå†å²ä¸å‘å±•.md) - PostgreSQLå‘å±•å†ç¨‹å’Œç‰ˆæœ¬æ¼”è¿›
- [å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º](../01.03-æ•°æ®æ¨¡å‹/01.02-å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º.md) - å…³ç³»æ•°æ®æ¨¡å‹ç†è®ºåŸºç¡€
- [SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†](../01.04-SQLè¯­è¨€/01.03-SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†.md) - SQLè¯­è¨€è§„èŒƒ
- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../03-äº‹åŠ¡ä¸å¹¶å‘/03.02-ACIDç‰¹æ€§/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç®¡ç†
- [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../../03-äº‹åŠ¡ä¸å¹¶å‘/03.01-MVCCæœºåˆ¶/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶

### 8.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å®æˆ˜æ¡ˆä¾‹](../../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ
- [Dockeréƒ¨ç½²æŒ‡å—](../../11-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å®¹å™¨åŒ–éƒ¨ç½²å®è·µ

### 8.3 å‚è€ƒæ–‡çŒ®

1. Stonebraker, M., & Rowe, L. A. (1986). The design of POSTGRES. ACM SIGMOD Record, 15(2), 340-355.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Release Notes. <https://www.postgresql.org/docs/18/release-18.html>
4. Berenson, H., et al. (1995). A critique of ANSI SQL isolation levels. ACM SIGMOD Record, 24(2), 1-10.
5. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
6. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 8.4 Wikidataå¯¹é½

#### 8.4.1 PostgreSQLç³»ç»Ÿå¯¹é½

- **Wikidata ID**: Q192490 (PostgreSQL)
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
  - P856: <https://www.postgresql.org> (official website)
- **å¤–éƒ¨é“¾æ¥**:
  - [Wikipedia - PostgreSQL](https://en.wikipedia.org/wiki/PostgreSQL)
  - <https://www.postgresql.org/docs/>
  - <https://github.com/postgres/postgres>

#### 8.4.2 æ•°æ®åº“ç³»ç»Ÿæ¶æ„æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Database architecture](https://en.wikipedia.org/wiki/Database_architecture)

> Database architecture is the design of a database system, which includes its structure, components, and relationships.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒæ•°æ®åº“ç³»ç»Ÿçš„ç»“æ„å’Œç»„ä»¶è®¾è®¡
- âœ… **æ¶æ„ç»„ä»¶**: éƒ½åŒ…å«è¿›ç¨‹æ¨¡å‹ã€å†…å­˜ç®¡ç†ã€å­˜å‚¨ç³»ç»Ÿã€ç½‘ç»œåè®®ç­‰æ ¸å¿ƒç»„ä»¶
- âœ… **è®¾è®¡åŸåˆ™**: éƒ½å¼ºè°ƒå¯æ‰©å±•æ€§ã€æ€§èƒ½ã€å¯é æ€§ç­‰è®¾è®¡åŸåˆ™

#### 8.4.3 å¤šè¿›ç¨‹æ¶æ„æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Multiprocessing](https://en.wikipedia.org/wiki/Multiprocessing)

> Multiprocessing is the use of two or more central processing units (CPUs) within a single computer system.

**å¯¹é½è¯´æ˜**:

- âœ… **è¿›ç¨‹æ¨¡å‹**: PostgreSQLçš„å¤šè¿›ç¨‹æ¶æ„ç¬¦åˆWikipediaçš„å¤šè¿›ç¨‹å®šä¹‰
- âœ… **å¹¶å‘å¤„ç†**: éƒ½å¼ºè°ƒå¤šè¿›ç¨‹æ”¯æŒå¹¶å‘å¤„ç†
- âœ… **èµ„æºéš”ç¦»**: éƒ½æåˆ°è¿›ç¨‹é—´çš„èµ„æºéš”ç¦»

---

## ä¹ã€å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯

### 9.1 ç³»ç»Ÿæ¶æ„å®Œå¤‡æ€§è¯æ˜

**å®šç†**: PostgreSQLçš„ç³»ç»Ÿæ¶æ„æ˜¯å®Œå¤‡çš„ï¼Œèƒ½å¤Ÿæ”¯æŒå®Œæ•´çš„æ•°æ®åº“åŠŸèƒ½ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[ç³»ç»Ÿæ¶æ„å®Œå¤‡æ€§]
è®¾ \pg = (\process, \memory, \storage, \network) ä¸ºPostgreSQLç³»ç»Ÿã€‚

æ¶æ„å®Œå¤‡æ€§æ¡ä»¶ï¼š
1. è¿›ç¨‹æ¨¡å‹å®Œå¤‡æ€§ï¼š\forall q \in \queries, \exists p \in \process: \text{process}(q, p)
2. å†…å­˜ç®¡ç†å®Œå¤‡æ€§ï¼š\forall t \in \transactions, \exists m \in \memory: \text{isolate}(t, m)
3. å­˜å‚¨ç³»ç»Ÿå®Œå¤‡æ€§ï¼š\forall d \in \data, \exists s \in \storage: \text{persist}(d, s)
4. ç½‘ç»œåè®®å®Œå¤‡æ€§ï¼š\forall c \in \clients, \exists n \in \network: \text{communicate}(c, n)

è¯æ˜ï¼š
1. è¿›ç¨‹æ¨¡å‹ï¼šå¤šè¿›ç¨‹æ¶æ„ç¡®ä¿æ¯ä¸ªæŸ¥è¯¢éƒ½æœ‰ç‹¬ç«‹çš„å¤„ç†è¿›ç¨‹
2. å†…å­˜ç®¡ç†ï¼šå…±äº«å†…å­˜å’Œæœ¬åœ°å†…å­˜åˆ†ç¦»ç¡®ä¿äº‹åŠ¡éš”ç¦»
3. å­˜å‚¨ç³»ç»Ÿï¼šWALæœºåˆ¶å’Œæ£€æŸ¥ç‚¹ç¡®ä¿æ•°æ®æŒä¹…åŒ–
4. ç½‘ç»œåè®®ï¼šPostgreSQLåè®®æ”¯æŒå®Œæ•´çš„å®¢æˆ·ç«¯é€šä¿¡

å› æ­¤ï¼ŒPostgreSQLçš„ç³»ç»Ÿæ¶æ„æ˜¯å®Œå¤‡çš„ã€‚
\end{theorem}
```

### 9.2 è¿›ç¨‹æ¨¡å‹æ­£ç¡®æ€§è¯æ˜

**å®šç†**: PostgreSQLçš„å¤šè¿›ç¨‹æ¨¡å‹æ»¡è¶³è¿›ç¨‹éš”ç¦»æ€§ã€é€šä¿¡æ€§å’Œå¯æ¢å¤æ€§ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[è¿›ç¨‹æ¨¡å‹æ­£ç¡®æ€§]
è®¾ \process = \{p_1, p_2, \ldots, p_n\} ä¸ºPostgreSQLè¿›ç¨‹é›†åˆã€‚

è¿›ç¨‹éš”ç¦»æ€§ï¼š
\forall p_i, p_j \in \process, i \neq j: \text{memory}(p_i) \cap \text{memory}(p_j) = \emptyset

è¿›ç¨‹é€šä¿¡æ€§ï¼š
\exists \text{shared\_memory}: \forall p_i, p_j \in \process: \text{communicate}(p_i, p_j, \text{shared\_memory})

è¿›ç¨‹å¯æ¢å¤æ€§ï¼š
\forall p_i \in \process: \text{failure}(p_i) \Rightarrow \text{recover}(\pg \setminus \{p_i\})

è¯æ˜ï¼š
1. éš”ç¦»æ€§ï¼šæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´
2. é€šä¿¡æ€§ï¼šé€šè¿‡å…±äº«å†…å­˜è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
3. å¯æ¢å¤æ€§ï¼šå•ä¸ªè¿›ç¨‹æ•…éšœä¸å½±å“å…¶ä»–è¿›ç¨‹

å› æ­¤ï¼ŒPostgreSQLçš„è¿›ç¨‹æ¨¡å‹æ˜¯æ­£ç¡®çš„ã€‚
\end{theorem}
```

### 9.3 å†…å­˜ç®¡ç†æ•ˆç‡è¯æ˜

**å®šç†**: PostgreSQLçš„å†…å­˜ç®¡ç†ç­–ç•¥èƒ½å¤Ÿå®ç°é«˜æ•ˆçš„å†…å­˜åˆ©ç”¨å’Œäº‹åŠ¡éš”ç¦»ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[å†…å­˜ç®¡ç†æ•ˆç‡]
è®¾ \memory = \{\text{shared}, \text{local}, \text{dynamic}\} ä¸ºå†…å­˜ç±»å‹é›†åˆã€‚

å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼š
\text{Efficiency} = \frac{\text{used\_memory}}{\text{allocated\_memory}}

éš”ç¦»æ€§ä¿è¯ï¼š
\forall t_1, t_2 \in \transactions, t_1 \neq t_2: \text{memory}(t_1) \cap \text{memory}(t_2) = \emptyset

å…±äº«å†…å­˜æ•ˆç‡ï¼š
\text{shared\_memory\_efficiency} = \frac{\text{cache\_hits}}{\text{cache\_hits} + \text{cache\_misses}}

ç”±äºå…±äº«å†…å­˜ç”¨äºç¼“å­˜å’Œé”ç®¡ç†ï¼Œæœ¬åœ°å†…å­˜ç”¨äºæŸ¥è¯¢å¤„ç†ï¼ŒåŠ¨æ€å…±äº«å†…å­˜ç”¨äºæ‰©å±•ï¼Œ
å†…å­˜ç®¡ç†ç­–ç•¥èƒ½å¤Ÿå®ç°é«˜æ•ˆçš„å†…å­˜åˆ©ç”¨å’Œäº‹åŠ¡éš”ç¦»ã€‚
\end{theorem}
```

---

## åã€äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º](../01.03-æ•°æ®æ¨¡å‹/01.02-å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º.md) - å…³ç³»æ¨¡å‹ç†è®ºåŸºç¡€
- â­â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†è¯¦ç»†è¯´æ˜
- â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../03-äº‹åŠ¡ä¸å¹¶å‘/03.02-ACIDç‰¹æ€§/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç®¡ç†ç†è®ºåŸºç¡€
- â­â­ [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../../03-äº‹åŠ¡ä¸å¹¶å‘/03.01-MVCCæœºåˆ¶/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶æœºåˆ¶
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜è¯¦ç»†æŒ‡å—
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../../11-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„è®¾è®¡
- â­ [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - ç³»ç»Ÿç›‘æ§
- â­ [å¤‡ä»½ä¸æ¢å¤](../../04-å­˜å‚¨ä¸æ¢å¤/å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤å®è·µ

### å¤–éƒ¨èµ„æº

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [PostgreSQLç³»ç»Ÿæ¶æ„æ–‡æ¡£](https://www.postgresql.org/docs/current/internals.html)
- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://wiki.postgresql.org/wiki/Performance_Optimization)

---

## åã€åˆå¹¶æ¥æºä¸æ˜ å°„ï¼ˆæ•´åˆä¸­ï¼‰

- 1.1.1-PostgreSQLç³»ç»Ÿæ¶æ„-é‡æ„ç‰ˆ.md
- 1.1.2-ç³»ç»Ÿæ¶æ„.md
- 1.1.9-PostgreSQLåˆ†å¸ƒå¼æ¶æ„ä¸ç³»ç»Ÿä¼˜ç¼ºç‚¹.md
- 1.1.9-åˆ†å¸ƒå¼PostgreSQLæ¶æ„è®¾è®¡.md
- 1.1.11-PostgreSQLç³»ç»Ÿè®¾è®¡ä¸ç°ä»£ç¡¬ä»¶AIåœºæ™¯é€‚é…æ€§åˆ†æ.md

### å¾…åŠäº‹é¡¹

ä»¥ä¸‹äº‹é¡¹è®¡åˆ’åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„ï¼š

#### 1. æœ¯è¯­ç»Ÿä¸€

- [x] ç»Ÿä¸€è¿›ç¨‹/å†…å­˜/å­˜å‚¨/ç½‘ç»œå››å…ƒç»„æœ¯è¯­ âœ…
  - ç›®æ ‡ï¼šç¡®ä¿æ‰€æœ‰æ–‡æ¡£ä½¿ç”¨ä¸€è‡´çš„æœ¯è¯­
  - ä¼˜å…ˆçº§ï¼šä¸­
  - çŠ¶æ€ï¼šå·²å®Œæˆ

#### 2. æ–‡æ¡£äº¤å‰å¼•ç”¨

- [x] ä¸è¿ç»´æ¶æ„æ–‡æ¡£ï¼ˆ`06-è¿ç»´å®è·µ/`ï¼‰å»ºç«‹æ¸…æ™°çš„åˆ†ç•Œå’Œäº¤å‰å¼•ç”¨ âœ…
- [x] ä¸å‰æ²¿æ‰©å±•æ–‡æ¡£ï¼ˆ`07-å‰æ²¿æŠ€æœ¯/`ï¼‰å»ºç«‹äº¤å‰å¼•ç”¨ âœ…
  - ç›®æ ‡ï¼šå»ºç«‹æ¸…æ™°çš„æ–‡æ¡£è¾¹ç•Œå’Œå¼•ç”¨å…³ç³»
  - ä¼˜å…ˆçº§ï¼šä¸­
  - çŠ¶æ€ï¼šå·²å®Œæˆ

#### 3. éƒ¨ç½²æ‹“æ‰‘è¡¥å……

- [ ] è¡¥å……å…¸å‹éƒ¨ç½²æ‹“æ‰‘ä¸èµ„æºç”»åƒ
  - ç›®æ ‡ï¼šæä¾›å®é™…éƒ¨ç½²åœºæ™¯çš„æ‹“æ‰‘å›¾å’Œèµ„æºé…ç½®ç¤ºä¾‹
  - ä¼˜å…ˆçº§ï¼šä½
  - è®¡åˆ’ï¼šæ·»åŠ å•æœºã€ä¸»ä»ã€é›†ç¾¤ç­‰å…¸å‹éƒ¨ç½²æ‹“æ‰‘å›¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
