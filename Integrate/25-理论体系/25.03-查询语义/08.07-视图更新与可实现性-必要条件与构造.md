---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\08-æŸ¥è¯¢è¯­è¨€ä¸è¯­ä¹‰\08.07-è§†å›¾æ›´æ–°ä¸å¯å®ç°æ€§-å¿…è¦æ¡ä»¶ä¸æ„é€ .md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# è§†å›¾æ›´æ–°ä¸å¯å®ç°æ€§-å¿…è¦æ¡ä»¶ä¸æ„é€ 

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [è§†å›¾æ›´æ–°ä¸å¯å®ç°æ€§-å¿…è¦æ¡ä»¶ä¸æ„é€ ](#è§†å›¾æ›´æ–°ä¸å¯å®ç°æ€§-å¿…è¦æ¡ä»¶ä¸æ„é€ )
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 è§†å›¾æ›´æ–°å·¥ä½œåŸç†æ¦‚è¿°](#10-è§†å›¾æ›´æ–°å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 å¯å®ç°æ€§æ¡ä»¶](#21-å¯å®ç°æ€§æ¡ä»¶)
    - [2.2 æ„é€ æ–¹æ³•](#22-æ„é€ æ–¹æ³•)
    - [2.3 æ›´æ–°è¯­ä¹‰](#23-æ›´æ–°è¯­ä¹‰)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å¯å®ç°æ€§å½¢å¼åŒ–](#31-å¯å®ç°æ€§å½¢å¼åŒ–)
    - [3.2 æ›´æ–°æ˜ å°„å½¢å¼åŒ–](#32-æ›´æ–°æ˜ å°„å½¢å¼åŒ–)
    - [3.3 æ­£ç¡®æ€§å½¢å¼åŒ–](#33-æ­£ç¡®æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 å¯å®ç°æ€§åˆ¤å®šå®šç†](#41-å¯å®ç°æ€§åˆ¤å®šå®šç†)
    - [4.2 æ›´æ–°æ­£ç¡®æ€§å®šç†](#42-æ›´æ–°æ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18è§†å›¾æ›´æ–°å®ç°](#51-postgresql-18è§†å›¾æ›´æ–°å®ç°)
      - [5.1.1 å¯æ›´æ–°è§†å›¾å®ç°](#511-å¯æ›´æ–°è§†å›¾å®ç°)
    - [5.2 å®é™…åº”ç”¨åœºæ™¯](#52-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šå¤šç§Ÿæˆ·SaaSç³»ç»Ÿçš„è¡Œçº§å®‰å…¨è§†å›¾](#åœºæ™¯1å¤šç§Ÿæˆ·saasç³»ç»Ÿçš„è¡Œçº§å®‰å…¨è§†å›¾)
      - [åœºæ™¯2ï¼šæ•°æ®ä»“åº“çš„ç‰©åŒ–è§†å›¾æ›´æ–°](#åœºæ™¯2æ•°æ®ä»“åº“çš„ç‰©åŒ–è§†å›¾æ›´æ–°)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 è§†å›¾æ›´æ–°ç›¸å…³](#72-è§†å›¾æ›´æ–°ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 è§†å›¾æ›´æ–°å·¥ä½œåŸç†æ¦‚è¿°

**è§†å›¾æ›´æ–°**ï¼š

è§†å›¾æ›´æ–°æ˜¯æŒ‡é€šè¿‡è§†å›¾ä¿®æ”¹åº•å±‚åŸºè¡¨æ•°æ®ã€‚å¹¶éæ‰€æœ‰è§†å›¾éƒ½å¯ä»¥æ›´æ–°ï¼Œéœ€è¦æ»¡è¶³ç‰¹å®šçš„å¯å®ç°æ€§æ¡ä»¶ã€‚

**è§†å›¾æ›´æ–°ä½“ç³»æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((è§†å›¾æ›´æ–°))
    å¯å®ç°æ€§
      å•è¡¨è§†å›¾
      è¿æ¥è§†å›¾
      èšåˆè§†å›¾
      æ¡ä»¶
    æ›´æ–°ç±»å‹
      INSERT
      UPDATE
      DELETE
    æ„é€ æ–¹æ³•
      å”¯ä¸€æ˜ å°„
      å¯é€†æ˜ å°„
      è¡¥å¿æ›´æ–°
    æ­£ç¡®æ€§
      è¯­ä¹‰æ­£ç¡®
      å®Œæ•´æ€§ä¿æŒ
      çº¦æŸæ»¡è¶³
```

**è§†å›¾æ›´æ–°åˆ¤å®šå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è§†å›¾æ›´æ–°è¯·æ±‚] --> B{è§†å›¾ç±»å‹}
    B -->|å•è¡¨æŠ•å½±| C[æ£€æŸ¥å”¯ä¸€æ€§]
    B -->|è¿æ¥è§†å›¾| D[æ£€æŸ¥ä¸€å¯¹ä¸€æ˜ å°„]
    B -->|èšåˆè§†å›¾| E[ä¸å¯æ›´æ–°]
    C --> F{ä¸»é”®å¯è§?}
    F -->|æ˜¯| G[å¯æ›´æ–°]
    F -->|å¦| H[ä¸å¯æ›´æ–°]
    D --> I{ä¸€å¯¹ä¸€æ˜ å°„?}
    I -->|æ˜¯| G
    I -->|å¦| H
    G --> J[æ‰§è¡Œæ›´æ–°]
    H --> K[æ‹’ç»æ›´æ–°]

    style A fill:#FFD700
    style G fill:#90EE90
    style K fill:#FF6B6B
```

**è§†å›¾ç±»å‹æ›´æ–°èƒ½åŠ›å¯¹æ¯”çŸ©é˜µ**ï¼š

| è§†å›¾ç±»å‹ | INSERT | UPDATE | DELETE | æ¡ä»¶ |
| --- | --- | --- | --- | --- |
| **å•è¡¨æŠ•å½±** | æ˜¯ | æ˜¯ | æ˜¯ | ä¸»é”®å¯è§ |
| **å•è¡¨é€‰æ‹©** | æ˜¯ | æ˜¯ | æ˜¯ | ä¸»é”®å¯è§ |
| **è¿æ¥è§†å›¾** | å¦ | éƒ¨åˆ† | éƒ¨åˆ† | ä¸€å¯¹ä¸€æ˜ å°„ |
| **èšåˆè§†å›¾** | å¦ | å¦ | å¦ | ä¸å¯æ›´æ–° |
| **UNIONè§†å›¾** | å¦ | å¦ | å¦ | ä¸å¯æ›´æ–° |

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **å¯å®ç°æ€§æ¡ä»¶**ï¼šè§†å›¾å¯æ›´æ–°çš„å¿…è¦å’Œå……åˆ†æ¡ä»¶
- **æ„é€ æ–¹æ³•**ï¼šæ„é€ å¯æ›´æ–°è§†å›¾çš„æ–¹æ³•
- **æ›´æ–°è¯­ä¹‰**ï¼šè§†å›¾æ›´æ–°çš„è¯­ä¹‰å®šä¹‰
- **å®é™…åº”ç”¨**ï¼šPostgreSQLè§†å›¾æ›´æ–°çš„å®ç°

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 å¯å®ç°æ€§æ¡ä»¶

**å¿…è¦æ¡ä»¶**ï¼š

```haskell
-- è§†å›¾å¯æ›´æ–°æ¡ä»¶
updatable :: View -> Bool
updatable V =
    -- æ¡ä»¶1: è§†å›¾å®šä¹‰ä¸åŒ…å«èšåˆ
    not (hasAggregation(V.definition)) &&
    -- æ¡ä»¶2: è§†å›¾å®šä¹‰ä¸åŒ…å«DISTINCT
    not (hasDistinct(V.definition)) &&
    -- æ¡ä»¶3: è§†å›¾å®šä¹‰ä¸åŒ…å«UNION
    not (hasUnion(V.definition)) &&
    -- æ¡ä»¶4: åŸºè¡¨ä¸»é”®åœ¨è§†å›¾ä¸­å¯è§
    hasPrimaryKey(V)
```

**å……åˆ†æ¡ä»¶**ï¼š

```haskell
-- å•è¡¨è§†å›¾å¯æ›´æ–°
singleTableUpdatable :: View -> Bool
singleTableUpdatable V =
    isSingleTable(V) &&
    hasPrimaryKey(V) &&
    not (hasAggregation(V.definition))
```

**è§†å›¾æ›´æ–°åˆ¤å®šæµç¨‹**ï¼š

```mermaid
graph TD
    A[è§†å›¾V] --> B{å•è¡¨è§†å›¾?}
    B -->|æ˜¯| C{ä¸»é”®å¯è§?}
    B -->|å¦| D{è¿æ¥è§†å›¾?}
    C -->|æ˜¯| E[å¯æ›´æ–°]
    C -->|å¦| F[ä¸å¯æ›´æ–°]
    D -->|æ˜¯| G{ä¸€å¯¹ä¸€æ˜ å°„?}
    D -->|å¦| H[ä¸å¯æ›´æ–°]
    G -->|æ˜¯| I[éƒ¨åˆ†å¯æ›´æ–°]
    G -->|å¦| H

    style A fill:#FFD700
    style E fill:#90EE90
    style I fill:#87CEEB
    style F fill:#FF6B6B
    style H fill:#FF6B6B
```

### 2.2 æ„é€ æ–¹æ³•

**å¯æ›´æ–°è§†å›¾æ„é€ **ï¼š

```haskell
-- æ„é€ å¯æ›´æ–°è§†å›¾
constructUpdatable :: Table -> Attributes -> View
constructUpdatable T attrs =
    View {
        definition = Ï€_attrs(T),
        baseTable = T,
        primaryKey = getPrimaryKey(T)
    }
```

**æ›´æ–°æ˜ å°„**ï¼š

```haskell
-- è§†å›¾æ›´æ–°åˆ°åŸºè¡¨æ›´æ–°
mapUpdate :: View -> Update -> Update
mapUpdate V (Update viewAttrs newVals) =
    Update V.baseTable (mapToBaseAttrs(V, viewAttrs)) (mapToBaseVals(V, newVals))
```

### 2.3 æ›´æ–°è¯­ä¹‰

**INSERTè¯­ä¹‰**ï¼š

```haskell
-- è§†å›¾INSERT
insertIntoView :: View -> Tuple -> Database -> Database
insertIntoView V t db =
    let baseTuple = mapToBaseTuple(V, t)
    in insertIntoTable(V.baseTable, baseTuple, db)
```

**UPDATEè¯­ä¹‰**ï¼š

```haskell
-- è§†å›¾UPDATE
updateView :: View -> Condition -> Update -> Database -> Database
updateView V cond update db =
    let baseCond = mapToBaseCondition(V, cond)
        baseUpdate = mapToBaseUpdate(V, update)
    in updateTable(V.baseTable, baseCond, baseUpdate, db)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å¯å®ç°æ€§å½¢å¼åŒ–

**å¯æ›´æ–°æ€§**ï¼š

```haskell
-- è§†å›¾å¯æ›´æ–°
updatable(V) iff
    exists function f: ViewUpdate -> BaseUpdate such that:
      forall DB: âŸ¦VâŸ§(f(update, DB)) = update(âŸ¦VâŸ§(DB))
```

### 3.2 æ›´æ–°æ˜ å°„å½¢å¼åŒ–

**æ›´æ–°æ˜ å°„**ï¼š

```haskell
-- æ›´æ–°æ˜ å°„
mapUpdate(V, u) = u' such that:
    forall DB: âŸ¦VâŸ§(u'(DB)) = u(âŸ¦VâŸ§(DB))
```

### 3.3 æ­£ç¡®æ€§å½¢å¼åŒ–

**æ›´æ–°æ­£ç¡®æ€§**ï¼š

```haskell
-- è§†å›¾æ›´æ–°æ­£ç¡®
correct(V, u) iff
    forall DB: âŸ¦VâŸ§(mapUpdate(V, u)(DB)) = u(âŸ¦VâŸ§(DB))
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 å¯å®ç°æ€§åˆ¤å®šå®šç†

**å®šç†1ï¼ˆå¯å®ç°æ€§åˆ¤å®šï¼‰**ï¼š

å•è¡¨è§†å›¾Vå¯æ›´æ–°å½“ä¸”ä»…å½“åŸºè¡¨çš„ä¸»é”®åœ¨è§†å›¾ä¸­å¯è§ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾è§†å›¾V = Ï€_A(Ïƒ_Î¸(R))ï¼Œå…¶ä¸­Ræ˜¯åŸºè¡¨ï¼ŒAæ˜¯å±æ€§é›†ï¼ŒÎ¸æ˜¯é€‰æ‹©æ¡ä»¶ã€‚åˆ™ï¼š

```text
updatable(V) âŸº primary_key(R) âŠ† A
```

**è¯æ˜**ï¼š

**å¿…è¦æ€§ï¼šå¯æ›´æ–° âŸ¹ ä¸»é”®å¯è§**:

**æ­¥éª¤1ï¼šå¯æ›´æ–°æ€§å‡è®¾**ï¼š

- å‡è®¾è§†å›¾Vå¯æ›´æ–°ï¼Œå³å­˜åœ¨æ›´æ–°æ˜ å°„å‡½æ•°f: ViewUpdate â†’ BaseUpdate
- å¯¹äºä»»æ„è§†å›¾æ›´æ–°uï¼Œå­˜åœ¨åŸºè¡¨æ›´æ–°u' = f(u)ä½¿å¾—æ›´æ–°åè§†å›¾çŠ¶æ€æ­£ç¡®

**æ­¥éª¤2ï¼šå”¯ä¸€æ€§è¦æ±‚**ï¼š

- å¯¹äºè§†å›¾UPDATEæ“ä½œï¼Œéœ€è¦å”¯ä¸€ç¡®å®šè¦æ›´æ–°çš„åŸºè¡¨è¡Œ
- å¯¹äºè§†å›¾DELETEæ“ä½œï¼Œéœ€è¦å”¯ä¸€ç¡®å®šè¦åˆ é™¤çš„åŸºè¡¨è¡Œ
- å¯¹äºè§†å›¾INSERTæ“ä½œï¼Œéœ€è¦å”¯ä¸€ç¡®å®šæ’å…¥ä½ç½®

**æ­¥éª¤3ï¼šåè¯æ³•**ï¼š

- å‡è®¾ä¸»é”®primary_key(R)ä¸åœ¨è§†å›¾å±æ€§é›†Aä¸­
- è€ƒè™‘è§†å›¾UPDATEæ“ä½œï¼šUPDATE V SET a = v WHERE ...
- ç”±äºä¸»é”®ä¸å¯è§ï¼ŒWHEREæ¡ä»¶å¯èƒ½åŒ¹é…å¤šä¸ªåŸºè¡¨è¡Œ
- æ— æ³•å”¯ä¸€ç¡®å®šè¦æ›´æ–°çš„è¡Œï¼Œå¯¼è‡´æ›´æ–°æ˜ å°„ä¸å”¯ä¸€
- è¿™ä¸å¯æ›´æ–°æ€§çŸ›ç›¾

**æ­¥éª¤4ï¼šå¿…è¦æ€§ç»“è®º**ï¼š

- å› æ­¤ï¼Œå¦‚æœè§†å›¾å¯æ›´æ–°ï¼Œåˆ™ä¸»é”®å¿…é¡»åœ¨è§†å›¾ä¸­å¯è§
- å¿…è¦æ€§å¾—è¯

**å……åˆ†æ€§ï¼šä¸»é”®å¯è§ âŸ¹ å¯æ›´æ–°**:

**æ­¥éª¤1ï¼šä¸»é”®å¯è§å‡è®¾**ï¼š

- å‡è®¾åŸºè¡¨Rçš„ä¸»é”®Kåœ¨è§†å›¾å±æ€§é›†Aä¸­ï¼Œå³K âŠ† A
- è§†å›¾V = Ï€_A(Ïƒ_Î¸(R))ï¼Œå…¶ä¸­K âŠ† A

**æ­¥éª¤2ï¼šæ„é€ æ›´æ–°æ˜ å°„**ï¼š

- **INSERTæ˜ å°„**ï¼š
  - å¯¹äºINSERT INTO V VALUES (...)ï¼Œæ„é€ INSERT INTO R VALUES (...)
  - ç”±äºK âŠ† Aï¼Œä¸»é”®å€¼åœ¨è§†å›¾ä¸­ï¼Œå¯ä»¥å”¯ä¸€ç¡®å®šæ’å…¥ä½ç½®

- **UPDATEæ˜ å°„**ï¼š
  - å¯¹äºUPDATE V SET a = v WHERE condï¼Œæ„é€ UPDATE R SET a = v WHERE cond' AND Î¸'
  - å…¶ä¸­cond'æ˜¯æ¡ä»¶condåœ¨åŸºè¡¨ä¸Šçš„æ˜ å°„ï¼ŒÎ¸'æ˜¯è§†å›¾é€‰æ‹©æ¡ä»¶
  - ç”±äºK âŠ† Aï¼ŒWHEREæ¡ä»¶å¯ä»¥å”¯ä¸€ç¡®å®šè¦æ›´æ–°çš„è¡Œ

- **DELETEæ˜ å°„**ï¼š
  - å¯¹äºDELETE FROM V WHERE condï¼Œæ„é€ DELETE FROM R WHERE cond' AND Î¸'
  - ç”±äºK âŠ† Aï¼ŒWHEREæ¡ä»¶å¯ä»¥å”¯ä¸€ç¡®å®šè¦åˆ é™¤çš„è¡Œ

**æ­¥éª¤3ï¼šè¯æ˜æ˜ å°„æ­£ç¡®æ€§**ï¼š

- å¯¹äºä»»æ„æ•°æ®åº“çŠ¶æ€DBå’Œè§†å›¾æ›´æ–°uï¼š
  - è®¾æ›´æ–°å‰è§†å›¾çŠ¶æ€ä¸ºV_old = âŸ¦VâŸ§(DB)
  - è®¾æ›´æ–°åè§†å›¾çŠ¶æ€ä¸ºV_new = u(V_old)
  - è®¾åŸºè¡¨æ›´æ–°ä¸ºu' = f(u)
  - è®¾æ›´æ–°ååŸºè¡¨çŠ¶æ€ä¸ºDB' = u'(DB)
  - éœ€è¦è¯æ˜âŸ¦VâŸ§(DB') = V_new

- ç”±äºä¸»é”®å¯è§ï¼Œæ›´æ–°æ˜ å°„æ˜¯å”¯ä¸€çš„
- ç”±äºä¸»é”®å”¯ä¸€æ€§ï¼Œæ›´æ–°æ“ä½œä¸ä¼šäº§ç”Ÿæ­§ä¹‰
- å› æ­¤âŸ¦VâŸ§(DB') = V_newï¼Œæ˜ å°„æ­£ç¡®

**æ­¥éª¤4ï¼šå……åˆ†æ€§ç»“è®º**ï¼š

- å› æ­¤ï¼Œå¦‚æœä¸»é”®åœ¨è§†å›¾ä¸­å¯è§ï¼Œåˆ™è§†å›¾å¯æ›´æ–°
- å……åˆ†æ€§å¾—è¯

**ç»“è®º**ï¼š

- å•è¡¨è§†å›¾å¯æ›´æ–°å½“ä¸”ä»…å½“ä¸»é”®åœ¨è§†å›¾ä¸­å¯è§
- å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å¯å®ç°æ€§åˆ¤å®šå®šç†] --> B[å¿…è¦æ€§: å¯æ›´æ–° âŸ¹ ä¸»é”®å¯è§]
    A --> C[å……åˆ†æ€§: ä¸»é”®å¯è§ âŸ¹ å¯æ›´æ–°]
    B --> D[åè¯: æ— ä¸»é”®åˆ™æ— æ³•å”¯ä¸€æ˜ å°„]
    D --> E[UPDATE/DELETEéœ€è¦å”¯ä¸€æ€§]
    E --> F[çŸ›ç›¾]
    C --> G[æ„é€ æ›´æ–°æ˜ å°„]
    G --> H[INSERT/UPDATE/DELETEæ˜ å°„]
    H --> I[ä¸»é”®ä¿è¯å”¯ä¸€æ€§]
    I --> J[æ˜ å°„æ­£ç¡®]
    F --> K[å®šç†å¾—è¯]
    J --> K

    style A fill:#FFD700
    style K fill:#90EE90
```

### 4.2 æ›´æ–°æ­£ç¡®æ€§å®šç†

**å®šç†2ï¼ˆæ›´æ–°æ­£ç¡®æ€§ï¼‰**ï¼š

å¯¹äºå¯æ›´æ–°è§†å›¾Vï¼Œå¦‚æœæ›´æ–°æ˜ å°„fæ»¡è¶³å¯å®ç°æ€§æ¡ä»¶ï¼Œåˆ™fæ˜¯æ­£ç¡®çš„ï¼Œå³å¯¹äºä»»æ„æ•°æ®åº“çŠ¶æ€DBå’Œè§†å›¾æ›´æ–°uï¼Œæœ‰âŸ¦VâŸ§(f(u)(DB)) = u(âŸ¦VâŸ§(DB))ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾è§†å›¾Vå¯æ›´æ–°ï¼Œæ›´æ–°æ˜ å°„f: ViewUpdate â†’ BaseUpdateã€‚åˆ™ï¼š

```text
correct(f) âŸº âˆ€DB, âˆ€u: âŸ¦VâŸ§(f(u)(DB)) = u(âŸ¦VâŸ§(DB))
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šå¯å®ç°æ€§æ¡ä»¶åº”ç”¨**ï¼š

- ç”±äºè§†å›¾Vå¯æ›´æ–°ï¼Œæ ¹æ®å®šç†1ï¼Œä¸»é”®Kåœ¨è§†å›¾ä¸­å¯è§
- æ›´æ–°æ˜ å°„fæ»¡è¶³å¯å®ç°æ€§æ¡ä»¶ï¼šå¯¹äºä»»æ„è§†å›¾æ›´æ–°uï¼Œf(u)æ˜¯æœ‰æ•ˆçš„åŸºè¡¨æ›´æ–°

**æ­¥éª¤2ï¼šINSERTæ“ä½œæ­£ç¡®æ€§**ï¼š

- è®¾è§†å›¾INSERTæ“ä½œï¼šINSERT INTO V VALUES (aâ‚, ..., aâ‚™)
- è®¾åŸºè¡¨INSERTæ“ä½œï¼šINSERT INTO R VALUES (bâ‚, ..., bâ‚˜)ï¼Œå…¶ä¸­m â‰¥ n
- ç”±äºK âŠ† Aï¼Œä¸»é”®å€¼åœ¨è§†å›¾ä¸­ï¼Œå¯ä»¥å”¯ä¸€ç¡®å®šæ’å…¥çš„åŸºè¡¨è¡Œ
- è®¾æ’å…¥å‰ï¼šDBï¼Œæ’å…¥åï¼šDB' = INSERT(R, (bâ‚, ..., bâ‚˜), DB)
- éœ€è¦è¯æ˜ï¼šâŸ¦VâŸ§(DB') = âŸ¦VâŸ§(DB) âˆª {(aâ‚, ..., aâ‚™)}
- ç”±äºæ’å…¥æ“ä½œæ­£ç¡®æ˜ å°„ï¼Œè§†å›¾çŠ¶æ€æ­£ç¡®æ›´æ–°
- INSERTæ“ä½œæ­£ç¡®æ€§å¾—è¯

**æ­¥éª¤3ï¼šUPDATEæ“ä½œæ­£ç¡®æ€§**ï¼š

- è®¾è§†å›¾UPDATEæ“ä½œï¼šUPDATE V SET a = v WHERE cond
- è®¾åŸºè¡¨UPDATEæ“ä½œï¼šUPDATE R SET a = v WHERE cond' AND Î¸
- ç”±äºK âŠ† Aï¼ŒWHEREæ¡ä»¶å¯ä»¥å”¯ä¸€ç¡®å®šè¦æ›´æ–°çš„åŸºè¡¨è¡Œ
- è®¾æ›´æ–°å‰ï¼šDBï¼Œæ›´æ–°åï¼šDB' = UPDATE(R, a, v, cond' AND Î¸, DB)
- éœ€è¦è¯æ˜ï¼šâŸ¦VâŸ§(DB') = UPDATE(âŸ¦VâŸ§(DB), a, v, cond)
- ç”±äºæ›´æ–°æ“ä½œæ­£ç¡®æ˜ å°„ï¼Œè§†å›¾çŠ¶æ€æ­£ç¡®æ›´æ–°
- UPDATEæ“ä½œæ­£ç¡®æ€§å¾—è¯

**æ­¥éª¤4ï¼šDELETEæ“ä½œæ­£ç¡®æ€§**ï¼š

- è®¾è§†å›¾DELETEæ“ä½œï¼šDELETE FROM V WHERE cond
- è®¾åŸºè¡¨DELETEæ“ä½œï¼šDELETE FROM R WHERE cond' AND Î¸
- ç”±äºK âŠ† Aï¼ŒWHEREæ¡ä»¶å¯ä»¥å”¯ä¸€ç¡®å®šè¦åˆ é™¤çš„åŸºè¡¨è¡Œ
- è®¾åˆ é™¤å‰ï¼šDBï¼Œåˆ é™¤åï¼šDB' = DELETE(R, cond' AND Î¸, DB)
- éœ€è¦è¯æ˜ï¼šâŸ¦VâŸ§(DB') = DELETE(âŸ¦VâŸ§(DB), cond)
- ç”±äºåˆ é™¤æ“ä½œæ­£ç¡®æ˜ å°„ï¼Œè§†å›¾çŠ¶æ€æ­£ç¡®æ›´æ–°
- DELETEæ“ä½œæ­£ç¡®æ€§å¾—è¯

**æ­¥éª¤5ï¼šå¤åˆæ“ä½œæ­£ç¡®æ€§**ï¼š

- å¯¹äºå¤åˆè§†å›¾æ›´æ–°æ“ä½œï¼ˆå¤šä¸ªINSERT/UPDATE/DELETEçš„ç»„åˆï¼‰
- ç”±äºæ¯ä¸ªåŸºæœ¬æ“ä½œéƒ½æ­£ç¡®ï¼Œå¤åˆæ“ä½œä¹Ÿæ­£ç¡®
- å¤åˆæ“ä½œæ­£ç¡®æ€§å¾—è¯

**æ­¥éª¤6ï¼šç»“è®º**ï¼š

- å¯¹äºå¯æ›´æ–°è§†å›¾Vï¼Œæ›´æ–°æ˜ å°„fæ˜¯æ­£ç¡®çš„
- å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ›´æ–°æ­£ç¡®æ€§å®šç†] --> B[å¯å®ç°æ€§æ¡ä»¶]
    B --> C[INSERTæ“ä½œæ­£ç¡®æ€§]
    B --> D[UPDATEæ“ä½œæ­£ç¡®æ€§]
    B --> E[DELETEæ“ä½œæ­£ç¡®æ€§]
    C --> F[ä¸»é”®ä¿è¯å”¯ä¸€æ˜ å°„]
    D --> F
    E --> F
    F --> G[è§†å›¾çŠ¶æ€æ­£ç¡®æ›´æ–°]
    G --> H[å¤åˆæ“ä½œæ­£ç¡®æ€§]
    H --> I[æ›´æ–°æ˜ å°„æ­£ç¡®]

    style A fill:#FFD700
    style I fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18è§†å›¾æ›´æ–°å®ç°

#### 5.1.1 å¯æ›´æ–°è§†å›¾å®ç°

**PostgreSQL 18è§†å›¾æ›´æ–°æ”¯æŒ**ï¼š

PostgreSQL 18æ”¯æŒå•è¡¨è§†å›¾çš„è‡ªåŠ¨æ›´æ–°ï¼Œå¯¹äºå¤æ‚è§†å›¾å¯ä»¥ä½¿ç”¨INSTEAD OFè§¦å‘å™¨å®ç°è‡ªå®šä¹‰æ›´æ–°é€»è¾‘ã€‚

**å¯æ›´æ–°è§†å›¾æ¡ä»¶æ£€æŸ¥**ï¼š

```sql
-- PostgreSQL 18ï¼šæ£€æŸ¥è§†å›¾å¯æ›´æ–°æ€§å‡½æ•°
CREATE OR REPLACE FUNCTION is_view_updatable(
    p_view_schema TEXT,
    p_view_name TEXT
)
RETURNS TABLE (
    is_updatable BOOLEAN,
    reason TEXT
) AS $$
DECLARE
    v_view_definition TEXT;
    v_has_aggregation BOOLEAN;
    v_has_distinct BOOLEAN;
    v_has_union BOOLEAN;
    v_has_join BOOLEAN;
    v_primary_key_visible BOOLEAN;
BEGIN
    -- è·å–è§†å›¾å®šä¹‰
    SELECT definition INTO v_view_definition
    FROM pg_views
    WHERE schemaname = p_view_schema AND viewname = p_view_name;

    IF v_view_definition IS NULL THEN
        RETURN QUERY SELECT FALSE, 'View not found'::TEXT;
        RETURN;
    END IF;

    -- æ£€æŸ¥èšåˆ
    v_has_aggregation := v_view_definition ~* '(COUNT|SUM|AVG|MAX|MIN|GROUP\s+BY)';

    -- æ£€æŸ¥DISTINCT
    v_has_distinct := v_view_definition ~* '\bDISTINCT\b';

    -- æ£€æŸ¥UNION
    v_has_union := v_view_definition ~* '\bUNION\b';

    -- æ£€æŸ¥JOIN
    v_has_join := v_view_definition ~* '\bJOIN\b';

    -- æ£€æŸ¥ä¸»é”®å¯è§æ€§ï¼ˆç®€åŒ–æ£€æŸ¥ï¼‰
    -- å®é™…å®ç°éœ€è¦è§£æè§†å›¾å®šä¹‰å’ŒåŸºè¡¨ç»“æ„
    v_primary_key_visible := NOT v_has_join;  -- ç®€åŒ–ï¼šå•è¡¨è§†å›¾å‡è®¾ä¸»é”®å¯è§

    -- åˆ¤æ–­å¯æ›´æ–°æ€§
    IF v_has_aggregation OR v_has_distinct OR v_has_union THEN
        RETURN QUERY SELECT FALSE, 'View contains aggregation, DISTINCT, or UNION'::TEXT;
    ELSIF v_has_join THEN
        RETURN QUERY SELECT FALSE, 'View contains JOIN (use INSTEAD OF triggers)'::TEXT;
    ELSIF NOT v_primary_key_visible THEN
        RETURN QUERY SELECT FALSE, 'Primary key not visible in view'::TEXT;
    ELSE
        RETURN QUERY SELECT TRUE, 'View is updatable'::TEXT;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šå¤šç§Ÿæˆ·SaaSç³»ç»Ÿçš„è¡Œçº§å®‰å…¨è§†å›¾

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

å¤šç§Ÿæˆ·SaaSç³»ç»Ÿéœ€è¦ä¸ºæ¯ä¸ªç§Ÿæˆ·æä¾›æ•°æ®éš”ç¦»è§†å›¾ï¼Œç§Ÿæˆ·åªèƒ½çœ‹åˆ°å’Œæ›´æ–°è‡ªå·±çš„æ•°æ®ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»è§†å›¾
-- 1. åˆ›å»ºåŸºè¡¨
CREATE TABLE customers (
    customer_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_customers_tenant ON customers(tenant_id);

-- 2. åˆ›å»ºç§Ÿæˆ·è§†å›¾ï¼ˆå¯æ›´æ–°ï¼‰
CREATE VIEW tenant_customers AS
SELECT
    customer_id,
    customer_name,
    email,
    status
FROM customers
WHERE tenant_id = current_setting('app.tenant_id')::BIGINT;

-- 3. å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_policy ON customers
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id')::BIGINT)
    WITH CHECK (tenant_id = current_setting('app.tenant_id')::BIGINT);

-- 4. è§†å›¾æ›´æ–°æ“ä½œ
-- è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
SET app.tenant_id = 1;

-- æ’å…¥æ•°æ®ï¼ˆé€šè¿‡è§†å›¾ï¼‰
INSERT INTO tenant_customers (customer_name, email)
VALUES ('Alice', 'alice@example.com');
-- è‡ªåŠ¨æ·»åŠ tenant_id = 1

-- æ›´æ–°æ•°æ®ï¼ˆé€šè¿‡è§†å›¾ï¼‰
UPDATE tenant_customers
SET email = 'newemail@example.com'
WHERE customer_id = 1;
-- åªèƒ½æ›´æ–°tenant_id = 1çš„æ•°æ®

-- åˆ é™¤æ•°æ®ï¼ˆé€šè¿‡è§†å›¾ï¼‰
DELETE FROM tenant_customers
WHERE customer_id = 1;
-- åªèƒ½åˆ é™¤tenant_id = 1çš„æ•°æ®

-- 5. éªŒè¯æ•°æ®éš”ç¦»
SET app.tenant_id = 2;
SELECT * FROM tenant_customers;  -- åªèƒ½çœ‹åˆ°tenant_id = 2çš„æ•°æ®
```

**SQLite 3.45å¯¹æ¯”**ï¼š

SQLite 3.45ä¸æ”¯æŒè¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰ï¼Œéœ€è¦ä½¿ç”¨åº”ç”¨å±‚å®ç°ï¼š

```sql
-- SQLite 3.45ï¼šåº”ç”¨å±‚å®ç°
-- éœ€è¦åœ¨åº”ç”¨ä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ tenant_idè¿‡æ»¤
SELECT * FROM customers WHERE tenant_id = ?;
UPDATE customers SET ... WHERE customer_id = ? AND tenant_id = ?;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | PostgreSQL 18 | SQLite 3.45 | è¯´æ˜ |
| --- | --- | --- | --- |
| **è¡Œçº§å®‰å…¨** | âœ… å†…ç½®æ”¯æŒ | âŒ ä¸æ”¯æŒ | PostgreSQLæ›´å®‰å…¨ |
| **è§†å›¾æ›´æ–°** | âœ… è‡ªåŠ¨æ”¯æŒ | âš ï¸ æœ‰é™æ”¯æŒ | PostgreSQLæ›´å®Œå–„ |
| **æ•°æ®éš”ç¦»** | âœ… æ•°æ®åº“çº§ | âš ï¸ åº”ç”¨çº§ | PostgreSQLæ›´å¯é  |

**å®æ–½æ•ˆæœ**ï¼š

- **å®‰å…¨æ€§**ï¼šæ•°æ®åº“çº§æ•°æ®éš”ç¦»ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
- **æ€§èƒ½**ï¼šRLSç­–ç•¥é«˜æ•ˆæ‰§è¡Œï¼ŒæŸ¥è¯¢æ€§èƒ½å½±å“<5%
- **å¯ç»´æŠ¤æ€§**ï¼šè§†å›¾æ›´æ–°ç®€åŒ–äº†åº”ç”¨ä»£ç 

#### åœºæ™¯2ï¼šæ•°æ®ä»“åº“çš„ç‰©åŒ–è§†å›¾æ›´æ–°

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

æ•°æ®ä»“åº“ç³»ç»Ÿéœ€è¦ç»´æŠ¤ç‰©åŒ–è§†å›¾ï¼Œå½“åŸºè¡¨æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°ç‰©åŒ–è§†å›¾ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šç‰©åŒ–è§†å›¾è‡ªåŠ¨æ›´æ–°
-- 1. åˆ›å»ºåŸºè¡¨
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    order_date DATE NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending'
);

CREATE TABLE order_items (
    item_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(order_id),
    product_id BIGINT NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL
);

-- 2. åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW monthly_sales_summary AS
SELECT
    DATE_TRUNC('month', o.order_date) AS month,
    COUNT(DISTINCT o.order_id) AS order_count,
    COUNT(oi.item_id) AS item_count,
    SUM(oi.quantity * oi.price) AS total_sales
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
WHERE o.status = 'completed'
GROUP BY DATE_TRUNC('month', o.order_date);

CREATE UNIQUE INDEX idx_monthly_sales_month ON monthly_sales_summary(month);

-- 3. åˆ›å»ºè‡ªåŠ¨åˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_monthly_sales_summary()
RETURNS TRIGGER AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY monthly_sales_summary;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- 4. åˆ›å»ºè§¦å‘å™¨ï¼ˆå½“è®¢å•æ›´æ–°æ—¶è‡ªåŠ¨åˆ·æ–°ï¼‰
CREATE TRIGGER refresh_sales_summary_on_order_update
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH STATEMENT
EXECUTE FUNCTION refresh_monthly_sales_summary();

CREATE TRIGGER refresh_sales_summary_on_item_update
AFTER INSERT OR UPDATE OR DELETE ON order_items
FOR EACH STATEMENT
EXECUTE FUNCTION refresh_monthly_sales_summary();

-- 5. ä½¿ç”¨ç‰©åŒ–è§†å›¾æŸ¥è¯¢
SELECT * FROM monthly_sales_summary
WHERE month >= DATE_TRUNC('month', NOW() - INTERVAL '12 months')
ORDER BY month DESC;

-- æ€§èƒ½æ•°æ®
-- åŸºè¡¨å¤§å°ï¼š100ä¸‡è®¢å•ï¼Œ500ä¸‡è®¢å•é¡¹
-- ç‰©åŒ–è§†å›¾å¤§å°ï¼š12è¡Œï¼ˆ12ä¸ªæœˆï¼‰
-- æŸ¥è¯¢æ—¶é—´ï¼š<1msï¼ˆç‰©åŒ–è§†å›¾ï¼‰vs ~500msï¼ˆåŸºè¡¨æŸ¥è¯¢ï¼‰
-- åˆ·æ–°æ—¶é—´ï¼š~2ç§’ï¼ˆCONCURRENTåˆ·æ–°ï¼‰
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å…³ç³»ä»£æ•°ä¸å…³ç³»æ¼”ç®—-ç§‘å¾·å®šç†ä¸å¯è¡¨è¾¾æ€§](./08.02-å…³ç³»ä»£æ•°ä¸å…³ç³»æ¼”ç®—-ç§‘å¾·å®šç†ä¸å¯è¡¨è¾¾æ€§.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Dayal, U., & Bernstein, P. A. (1982). "On the Correct Translation of Update Operations on Relational Views."**
  - ä¼šè®®: TODS 1982
  - **é‡è¦æ€§**: è§†å›¾æ›´æ–°çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†è§†å›¾æ›´æ–°çš„å¯å®ç°æ€§æ¡ä»¶

- **Keller, A. M. (1985). "Algorithms for Translating View Updates to Database Updates for Views Involving Selections, Projections, and Joins."**
  - ä¼šè®®: PODS 1985
  - **é‡è¦æ€§**: è§†å›¾æ›´æ–°ç®—æ³•çš„ç»å…¸ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†è§†å›¾æ›´æ–°çš„æ„é€ ç®—æ³•

### 7.2 è§†å›¾æ›´æ–°ç›¸å…³

- **Abiteboul, S., et al. (1995). "Foundations of Databases."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley 1995
  - **é‡è¦æ€§**: æ•°æ®åº“ç†è®ºçš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†é˜è¿°äº†è§†å›¾æ›´æ–°çš„ç†è®º

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - è§†å›¾](<https://www.postgresql.org/docs/current/sql-createview.html>)**
  - PostgreSQLè§†å›¾å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [å…³ç³»ä»£æ•°ä¸å…³ç³»æ¼”ç®—-ç§‘å¾·å®šç†ä¸å¯è¡¨è¾¾æ€§](./08.02-å…³ç³»ä»£æ•°ä¸å…³ç³»æ¼”ç®—-ç§‘å¾·å®šç†ä¸å¯è¡¨è¾¾æ€§.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
