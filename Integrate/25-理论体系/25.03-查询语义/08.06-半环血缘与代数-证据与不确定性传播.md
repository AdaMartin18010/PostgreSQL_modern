---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\08-æŸ¥è¯¢è¯­è¨€ä¸è¯­ä¹‰\08.06-åŠç¯è¡€ç¼˜ä¸ä»£æ•°-è¯æ®ä¸ä¸ç¡®å®šæ€§ä¼ æ’­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# åŠç¯è¡€ç¼˜ä¸ä»£æ•°-è¯æ®ä¸ä¸ç¡®å®šæ€§ä¼ æ’­

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [åŠç¯è¡€ç¼˜ä¸ä»£æ•°-è¯æ®ä¸ä¸ç¡®å®šæ€§ä¼ æ’­](#åŠç¯è¡€ç¼˜ä¸ä»£æ•°-è¯æ®ä¸ä¸ç¡®å®šæ€§ä¼ æ’­)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 åŠç¯è¡€ç¼˜å·¥ä½œåŸç†æ¦‚è¿°](#10-åŠç¯è¡€ç¼˜å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 åŠç¯ä»£æ•°](#21-åŠç¯ä»£æ•°)
    - [2.2 è¡€ç¼˜è¿½è¸ª](#22-è¡€ç¼˜è¿½è¸ª)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 åŠç¯å½¢å¼åŒ–](#31-åŠç¯å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 è¡€ç¼˜æ­£ç¡®æ€§å®šç†](#41-è¡€ç¼˜æ­£ç¡®æ€§å®šç†)
    - [4.2 ä¸ç¡®å®šæ€§ä¼ æ’­å®šç†](#42-ä¸ç¡®å®šæ€§ä¼ æ’­å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18åŠç¯è¡€ç¼˜å®ç°](#51-postgresql-18åŠç¯è¡€ç¼˜å®ç°)
      - [5.1.1 åŠç¯è¡€ç¼˜æ¨¡å‹å®ç°](#511-åŠç¯è¡€ç¼˜æ¨¡å‹å®ç°)
      - [5.1.2 è¡€ç¼˜è®¡ç®—å‡½æ•°](#512-è¡€ç¼˜è®¡ç®—å‡½æ•°)
    - [5.2 å®é™…åº”ç”¨åœºæ™¯](#52-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šæ¦‚ç‡æ•°æ®åº“ä¸­çš„ä¸ç¡®å®šæ€§ä¼ æ’­](#åœºæ™¯1æ¦‚ç‡æ•°æ®åº“ä¸­çš„ä¸ç¡®å®šæ€§ä¼ æ’­)
      - [åœºæ™¯2ï¼šæ•°æ®è´¨é‡è¯„ä¼°ä¸­çš„ç½®ä¿¡åº¦ä¼ æ’­](#åœºæ™¯2æ•°æ®è´¨é‡è¯„ä¼°ä¸­çš„ç½®ä¿¡åº¦ä¼ æ’­)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 åŠç¯è¡€ç¼˜å·¥ä½œåŸç†æ¦‚è¿°

**åŠç¯è¡€ç¼˜**ï¼š

åŠç¯ä»£æ•°ï¼ˆSemiring Algebraï¼‰æ˜¯æ•°æ®è¡€ç¼˜è¿½è¸ªçš„æ•°å­¦åŸºç¡€ï¼Œé€šè¿‡åŠç¯ç»“æ„å»ºæ¨¡æ•°æ®æ¥æºã€è½¬æ¢è·¯å¾„å’Œä¸ç¡®å®šæ€§ä¼ æ’­ã€‚åŠç¯çš„åŠ æ³•è¿ç®—è¡¨ç¤ºå¹¶é›†ï¼ˆå¤šä¸ªæ¥æºï¼‰ï¼Œä¹˜æ³•è¿ç®—è¡¨ç¤ºè¿æ¥ï¼ˆè½¬æ¢è·¯å¾„ï¼‰ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†å¤šç§è¡€ç¼˜è¯­ä¹‰ã€‚

**æ ¸å¿ƒå·¥ä½œåŸç†**ï¼š

1. **åŠç¯ç»“æ„**ï¼šå®šä¹‰åŠ æ³•ï¼ˆå¹¶ï¼‰å’Œä¹˜æ³•ï¼ˆè¿æ¥ï¼‰è¿ç®—ï¼Œæ»¡è¶³åˆ†é…å¾‹å’Œç»“åˆå¾‹
2. **è¡€ç¼˜è®¡ç®—**ï¼šé€šè¿‡åŠç¯è¿ç®—è®¡ç®—æŸ¥è¯¢ç»“æœä¸­æ¯ä¸ªå…ƒç»„çš„è¡€ç¼˜ä¿¡æ¯
3. **ä¸ç¡®å®šæ€§ä¼ æ’­**ï¼šé€šè¿‡åŠç¯è¿ç®—ä¼ æ’­æ¦‚ç‡ã€è¯¯å·®ã€ç½®ä¿¡åº¦ç­‰ä¸ç¡®å®šæ€§ä¿¡æ¯
4. **ç»Ÿä¸€æ¡†æ¶**ï¼šä¸åŒçš„è¡€ç¼˜è¯­ä¹‰ï¼ˆWHEREã€WHYã€HOWï¼‰å¯ä»¥ç»Ÿä¸€åœ¨åŠç¯æ¡†æ¶ä¸‹

**åŠç¯ä»£æ•°æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((åŠç¯ä»£æ•°))
    åŠç¯ç»“æ„
      åŠ æ³•è¿ç®—
      ä¹˜æ³•è¿ç®—
      å•ä½å…ƒ
    è¡€ç¼˜è¿½è¸ª
      æ•°æ®æ¥æº
      è½¬æ¢è·¯å¾„
      ä¾èµ–å…³ç³»
    ä¸ç¡®å®šæ€§ä¼ æ’­
      æ¦‚ç‡ä¼ æ’­
      è¯¯å·®ä¼ æ’­
      ç½®ä¿¡åº¦ä¼ æ’­
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **åŠç¯ä»£æ•°**ï¼šåŠç¯çš„æ•°å­¦å®šä¹‰
- **è¡€ç¼˜è¿½è¸ª**ï¼šæ•°æ®è¡€ç¼˜çš„å½¢å¼åŒ–
- **ä¸ç¡®å®šæ€§ä¼ æ’­**ï¼šä¸ç¡®å®šæ€§çš„ä¼ æ’­è§„åˆ™
- **å®é™…åº”ç”¨**ï¼šæ•°æ®è¡€ç¼˜ç³»ç»Ÿ

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 åŠç¯ä»£æ•°

**åŠç¯å®šä¹‰**ï¼š

```haskell
-- åŠç¯
data Semiring a = Semiring {
    add :: a -> a -> a,  -- åŠ æ³•ï¼ˆå¹¶ï¼‰
    multiply :: a -> a -> a,  -- ä¹˜æ³•ï¼ˆè¿æ¥ï¼‰
    zero :: a,  -- é›¶å…ƒ
    one :: a  -- å•ä½å…ƒ
}

-- åŠç¯æ€§è´¨
semiringProperties :: Semiring a -> Bool
semiringProperties sr =
    -- åŠ æ³•äº¤æ¢å¾‹ã€ç»“åˆå¾‹
    -- ä¹˜æ³•ç»“åˆå¾‹
    -- åˆ†é…å¾‹
    -- é›¶å…ƒã€å•ä½å…ƒæ€§è´¨
    True
```

### 2.2 è¡€ç¼˜è¿½è¸ª

**è¡€ç¼˜è®¡ç®—**ï¼š

```haskell
-- è¡€ç¼˜è¿½è¸ª
lineage :: Query -> Data -> Lineage
lineage query data =
    computeLineage(query, data, semiring)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 åŠç¯å½¢å¼åŒ–

**åŠç¯**ï¼š

```haskell
-- åŠç¯å½¢å¼åŒ–
Semiring = (S, +, Ã—, 0, 1)
where
    (S, +) is commutative monoid with identity 0
    (S, Ã—) is monoid with identity 1
    Ã— distributes over +
    0 Ã— a = a Ã— 0 = 0
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 è¡€ç¼˜æ­£ç¡®æ€§å®šç†

**å®šç†1ï¼ˆåŠç¯è¡€ç¼˜æ­£ç¡®æ€§ï¼‰**ï¼š

å¯¹äºæŸ¥è¯¢Qå’ŒåŠç¯Sï¼ŒåŠç¯è¡€ç¼˜è®¡ç®—lineage(Q, S)æ­£ç¡®è¿½è¸ªæŸ¥è¯¢ç»“æœä¸­æ¯ä¸ªå…ƒç»„çš„æ•°æ®æ¥æºã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æŸ¥è¯¢Qï¼Œæ•°æ®åº“DBï¼ŒåŠç¯S = (S, +, Ã—, 0, 1)ï¼Œåˆ™å¯¹äºä»»æ„ç»“æœå…ƒç»„t âˆˆ âŸ¦QâŸ§(DB)ï¼Œlineage(t, Q, S)æ­£ç¡®è¡¨ç¤ºtçš„æ‰€æœ‰æ•°æ®æ¥æºã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šåŸºç¡€æƒ…å†µï¼ˆåŸå­æŸ¥è¯¢ï¼‰**ï¼š

- å¯¹äºåŸå­æŸ¥è¯¢Rï¼ˆå…³ç³»Rï¼‰ï¼Œç»“æœå…ƒç»„tæ¥è‡ªå…³ç³»R
- è¡€ç¼˜è®¡ç®—ï¼šlineage(t, R, S) = {t}ï¼ˆå•å…ƒç´ é›†åˆï¼‰
- æ­£ç¡®æ€§ï¼štç¡®å®æ¥è‡ªRï¼Œè¡€ç¼˜æ­£ç¡®

**æ­¥éª¤2ï¼šæŠ•å½±æ“ä½œ**ï¼š

- è®¾æŸ¥è¯¢Q = Ï€_A(R)ï¼Œç»“æœå…ƒç»„t = Ï€_A(r)ï¼Œå…¶ä¸­r âˆˆ R
- è¡€ç¼˜è®¡ç®—ï¼šlineage(t, Q, S) = lineage(r, R, S)
- æ­£ç¡®æ€§ï¼štæ¥è‡ªrï¼Œræ¥è‡ªRï¼Œå› æ­¤tçš„è¡€ç¼˜æ­£ç¡®

**æ­¥éª¤3ï¼šé€‰æ‹©æ“ä½œ**ï¼š

- è®¾æŸ¥è¯¢Q = Ïƒ_Î¸(R)ï¼Œç»“æœå…ƒç»„t âˆˆ Rä¸”æ»¡è¶³Î¸(t)
- è¡€ç¼˜è®¡ç®—ï¼šlineage(t, Q, S) = lineage(t, R, S)
- æ­£ç¡®æ€§ï¼štæ¥è‡ªRï¼Œè¡€ç¼˜æ­£ç¡®

**æ­¥éª¤4ï¼šè¿æ¥æ“ä½œ**ï¼š

- è®¾æŸ¥è¯¢Q = Râ‚ â¨ Râ‚‚ï¼Œç»“æœå…ƒç»„t = (râ‚, râ‚‚)ï¼Œå…¶ä¸­râ‚ âˆˆ Râ‚, râ‚‚ âˆˆ Râ‚‚
- è¡€ç¼˜è®¡ç®—ï¼šlineage(t, Q, S) = lineage(râ‚, Râ‚, S) Ã— lineage(râ‚‚, Râ‚‚, S)ï¼ˆåŠç¯ä¹˜æ³•ï¼‰
- æ­£ç¡®æ€§ï¼štæ¥è‡ªrâ‚å’Œrâ‚‚çš„è¿æ¥ï¼Œè¡€ç¼˜æ­£ç¡®

**æ­¥éª¤5ï¼šå¹¶æ“ä½œ**ï¼š

- è®¾æŸ¥è¯¢Q = Râ‚ âˆª Râ‚‚ï¼Œç»“æœå…ƒç»„t âˆˆ Râ‚æˆ–t âˆˆ Râ‚‚
- è¡€ç¼˜è®¡ç®—ï¼šlineage(t, Q, S) = lineage(t, Râ‚, S) + lineage(t, Râ‚‚, S)ï¼ˆåŠç¯åŠ æ³•ï¼‰
- æ­£ç¡®æ€§ï¼štæ¥è‡ªRâ‚æˆ–Râ‚‚ï¼Œè¡€ç¼˜æ­£ç¡®

**æ­¥éª¤6ï¼šå½’çº³æ­¥éª¤**ï¼š

- å¯¹äºå¤åˆæŸ¥è¯¢Q = Qâ‚ op Qâ‚‚ï¼Œå…¶ä¸­opæ˜¯æŠ•å½±ã€é€‰æ‹©ã€è¿æ¥æˆ–å¹¶
- æ ¹æ®æ­¥éª¤2-5ï¼Œå¦‚æœQâ‚å’ŒQâ‚‚çš„è¡€ç¼˜è®¡ç®—æ­£ç¡®ï¼Œåˆ™Qçš„è¡€ç¼˜è®¡ç®—ä¹Ÿæ­£ç¡®
- ç”±ç»“æ„å½’çº³æ³•ï¼Œæ‰€æœ‰æŸ¥è¯¢çš„è¡€ç¼˜è®¡ç®—éƒ½æ­£ç¡®

**ç»“è®º**ï¼š

- åŠç¯è¡€ç¼˜æ­£ç¡®è¿½è¸ªæ•°æ®æ¥æº
- å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[è¡€ç¼˜æ­£ç¡®æ€§å®šç†] --> B[åŸºç¡€æƒ…å†µï¼šåŸå­æŸ¥è¯¢]
    A --> C[æŠ•å½±æ“ä½œ]
    A --> D[é€‰æ‹©æ“ä½œ]
    A --> E[è¿æ¥æ“ä½œ]
    A --> F[å¹¶æ“ä½œ]
    B --> G[è¡€ç¼˜æ­£ç¡®]
    C --> G
    D --> G
    E --> G
    F --> G
    G --> H[å½’çº³ï¼šå¤åˆæŸ¥è¯¢]
    H --> I[æ‰€æœ‰æŸ¥è¯¢è¡€ç¼˜æ­£ç¡®]

    style A fill:#FFD700
    style I fill:#90EE90
```

### 4.2 ä¸ç¡®å®šæ€§ä¼ æ’­å®šç†

**å®šç†2ï¼ˆä¸ç¡®å®šæ€§ä¼ æ’­ï¼‰**ï¼š

å¯¹äºæŸ¥è¯¢Qå’Œä¸ç¡®å®šæ€§åŠç¯Sï¼ŒåŠç¯è¿ç®—æ­£ç¡®ä¼ æ’­ä¸ç¡®å®šæ€§ä¿¡æ¯ï¼ˆæ¦‚ç‡ã€è¯¯å·®ã€ç½®ä¿¡åº¦ç­‰ï¼‰ã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šä¸ç¡®å®šæ€§åŠç¯å®šä¹‰**ï¼š

- è®¾ä¸ç¡®å®šæ€§åŠç¯S = (S, +, Ã—, 0, 1)
- åŠ æ³•+ï¼šè¡¨ç¤ºä¸ç¡®å®šæ€§åˆå¹¶ï¼ˆå¦‚æ¦‚ç‡çš„å¹¶ï¼‰
- ä¹˜æ³•Ã—ï¼šè¡¨ç¤ºä¸ç¡®å®šæ€§ç»„åˆï¼ˆå¦‚æ¦‚ç‡çš„ç§¯ï¼‰

**æ­¥éª¤2ï¼šåŸºç¡€æƒ…å†µ**ï¼š

- å¯¹äºåŸå­æŸ¥è¯¢Rï¼Œå…ƒç»„tçš„ä¸ç¡®å®šæ€§ä¸ºuncertainty(t, R)
- è¡€ç¼˜è®¡ç®—ï¼šuncertainty(t, Q, S) = uncertainty(t, R)
- æ­£ç¡®æ€§ï¼šåŸºç¡€ä¸ç¡®å®šæ€§æ­£ç¡®

**æ­¥éª¤3ï¼šè¿æ¥æ“ä½œçš„ä¸ç¡®å®šæ€§ä¼ æ’­**ï¼š

- å¯¹äºè¿æ¥æŸ¥è¯¢Q = Râ‚ â¨ Râ‚‚ï¼Œç»“æœå…ƒç»„t = (râ‚, râ‚‚)
- ä¸ç¡®å®šæ€§è®¡ç®—ï¼šuncertainty(t, Q, S) = uncertainty(râ‚, Râ‚, S) Ã— uncertainty(râ‚‚, Râ‚‚, S)
- æ­£ç¡®æ€§ï¼šç‹¬ç«‹äº‹ä»¶çš„ä¸ç¡®å®šæ€§é€šè¿‡ä¹˜æ³•ç»„åˆï¼Œæ­£ç¡®

**æ­¥éª¤4ï¼šå¹¶æ“ä½œçš„ä¸ç¡®å®šæ€§ä¼ æ’­**ï¼š

- å¯¹äºå¹¶æŸ¥è¯¢Q = Râ‚ âˆª Râ‚‚ï¼Œç»“æœå…ƒç»„tçš„ä¸ç¡®å®šæ€§
- ä¸ç¡®å®šæ€§è®¡ç®—ï¼šuncertainty(t, Q, S) = uncertainty(t, Râ‚, S) + uncertainty(t, Râ‚‚, S)
- æ­£ç¡®æ€§ï¼šäº’æ–¥äº‹ä»¶çš„ä¸ç¡®å®šæ€§é€šè¿‡åŠ æ³•åˆå¹¶ï¼Œæ­£ç¡®

**æ­¥éª¤5ï¼šå½’çº³æ­¥éª¤**ï¼š

- å¯¹äºå¤åˆæŸ¥è¯¢ï¼Œä¸ç¡®å®šæ€§é€šè¿‡åŠç¯è¿ç®—ä¼ æ’­
- ç”±äºåŠç¯è¿ç®—çš„æ­£ç¡®æ€§ï¼Œä¸ç¡®å®šæ€§ä¼ æ’­æ­£ç¡®

**ç»“è®º**ï¼š

- åŠç¯è¿ç®—æ­£ç¡®ä¼ æ’­ä¸ç¡®å®šæ€§ä¿¡æ¯
- å®šç†å¾—è¯

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18åŠç¯è¡€ç¼˜å®ç°

#### 5.1.1 åŠç¯è¡€ç¼˜æ¨¡å‹å®ç°

**PostgreSQL 18å®ç°æ¶æ„**ï¼š

```sql
-- 1. åŠç¯ç±»å‹è¡¨
CREATE TABLE semiring_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    semiring_name VARCHAR(100) NOT NULL UNIQUE,
    semiring_definition JSONB NOT NULL,  -- åŠç¯å®šä¹‰ï¼ˆåŠ æ³•ã€ä¹˜æ³•ã€é›¶å…ƒã€å•ä½å…ƒï¼‰
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. è¡€ç¼˜å€¼è¡¨
CREATE TABLE lineage_values (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tuple_id UUID NOT NULL,  -- å…ƒç»„æ ‡è¯†
    lineage_data JSONB NOT NULL,  -- è¡€ç¼˜æ•°æ®ï¼ˆåŠç¯å€¼ï¼‰
    semiring_type_id UUID NOT NULL REFERENCES semiring_types(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. åŠç¯è¿ç®—å‡½æ•°
CREATE OR REPLACE FUNCTION semiring_add(
    p_semiring_type_id UUID,
    p_value1 JSONB,
    p_value2 JSONB
)
RETURNS JSONB AS $$
DECLARE
    v_semiring_def JSONB;
    v_add_func TEXT;
BEGIN
    -- è·å–åŠç¯å®šä¹‰
    SELECT semiring_definition INTO v_semiring_def
    FROM semiring_types
    WHERE id = p_semiring_type_id;

    -- è·å–åŠ æ³•å‡½æ•°
    v_add_func := v_semiring_def->>'add_function';

    -- æ‰§è¡ŒåŠ æ³•è¿ç®—
    EXECUTE format('SELECT %s($1, $2)', v_add_func)
    USING p_value1, p_value2
    INTO v_semiring_def;

    RETURN v_semiring_def;
END;
$$ LANGUAGE plpgsql;

-- 4. åŠç¯ä¹˜æ³•å‡½æ•°
CREATE OR REPLACE FUNCTION semiring_multiply(
    p_semiring_type_id UUID,
    p_value1 JSONB,
    p_value2 JSONB
)
RETURNS JSONB AS $$
DECLARE
    v_semiring_def JSONB;
    v_mult_func TEXT;
BEGIN
    SELECT semiring_definition INTO v_semiring_def
    FROM semiring_types
    WHERE id = p_semiring_type_id;

    v_mult_func := v_semiring_def->>'multiply_function';

    EXECUTE format('SELECT %s($1, $2)', v_mult_func)
    USING p_value1, p_value2
    INTO v_semiring_def;

    RETURN v_semiring_def;
END;
$$ LANGUAGE plpgsql;
```

#### 5.1.2 è¡€ç¼˜è®¡ç®—å‡½æ•°

**æŸ¥è¯¢è¡€ç¼˜è®¡ç®—**ï¼š

```sql
-- è®¡ç®—æŸ¥è¯¢ç»“æœçš„åŠç¯è¡€ç¼˜
CREATE OR REPLACE FUNCTION compute_lineage(
    p_query TEXT,
    p_semiring_type_id UUID
)
RETURNS TABLE (
    tuple_id UUID,
    lineage_data JSONB
) AS $$
DECLARE
    v_query_id UUID;
    v_result JSONB;
BEGIN
    -- è§£ææŸ¥è¯¢å¹¶æ„å»ºæŸ¥è¯¢è®¡åˆ’
    v_query_id := parse_and_plan_query(p_query);

    -- è®¡ç®—è¡€ç¼˜ï¼ˆé€’å½’å¤„ç†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼‰
    RETURN QUERY
    WITH RECURSIVE lineage_computation AS (
        -- åŸºç¡€æƒ…å†µï¼šå¶å­èŠ‚ç‚¹ï¼ˆè¡¨æ‰«æï¼‰
        SELECT
            t.id as tuple_id,
            jsonb_build_object('source', t.table_name, 'tuple', t.id) as lineage_data
        FROM scan_table(v_query_id) t

        UNION ALL

        -- é€’å½’æƒ…å†µï¼šå†…éƒ¨èŠ‚ç‚¹
        SELECT
            result_tuple_id,
            CASE
                WHEN node_type = 'join' THEN
                    semiring_multiply(
                        p_semiring_type_id,
                        left_lineage,
                        right_lineage
                    )
                WHEN node_type = 'union' THEN
                    semiring_add(
                        p_semiring_type_id,
                        left_lineage,
                        right_lineage
                    )
                ELSE
                    lineage_data  -- æŠ•å½±ã€é€‰æ‹©ç­‰ä¿æŒè¡€ç¼˜
            END as lineage_data
        FROM process_query_node(v_query_id, lineage_computation)
    )
    SELECT tuple_id, lineage_data
    FROM lineage_computation;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šæ¦‚ç‡æ•°æ®åº“ä¸­çš„ä¸ç¡®å®šæ€§ä¼ æ’­

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

é£é™©è¯„ä¼°ç³»ç»Ÿéœ€è¦è¿½è¸ªæ¯ä¸ªé£é™©è¯„åˆ†çš„ä¸ç¡®å®šæ€§æ¥æºï¼Œå¹¶ä¼ æ’­æ¦‚ç‡ä¿¡æ¯ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šæ¦‚ç‡æ•°æ®åº“è¡€ç¼˜è¿½è¸ª
-- 1. å®šä¹‰æ¦‚ç‡åŠç¯
INSERT INTO semiring_types (semiring_name, semiring_definition) VALUES (
    'probability',
    '{
        "add_function": "probability_union",
        "multiply_function": "probability_product",
        "zero": 0.0,
        "one": 1.0
    }'::jsonb
);

-- 2. æ¦‚ç‡æ•°æ®è¡¨
CREATE TABLE risk_scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id BIGINT,
    risk_score NUMERIC(5,2),
    probability NUMERIC(3,2),  -- æ¦‚ç‡å€¼
    source_data JSONB  -- æ¥æºæ•°æ®
);

-- 3. æŸ¥è¯¢ï¼šè®¡ç®—é£é™©è¯„åˆ†
SELECT
    customer_id,
    AVG(risk_score) as avg_risk,
    compute_probability_lineage(risk_score, 'probability'::uuid) as lineage
FROM risk_scores
GROUP BY customer_id;

-- 4. ä¸ç¡®å®šæ€§ä¼ æ’­
-- é€šè¿‡åŠç¯ä¹˜æ³•ä¼ æ’­æ¦‚ç‡
-- P(result) = P(source1) Ã— P(source2) Ã— ...
```

#### åœºæ™¯2ï¼šæ•°æ®è´¨é‡è¯„ä¼°ä¸­çš„ç½®ä¿¡åº¦ä¼ æ’­

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

æ•°æ®è´¨é‡ç³»ç»Ÿéœ€è¦è¿½è¸ªæ¯ä¸ªæ•°æ®é¡¹çš„ç½®ä¿¡åº¦ï¼Œå¹¶ä¼ æ’­ç½®ä¿¡åº¦ä¿¡æ¯ã€‚

**å®ç°æ–¹æ¡ˆ**ï¼š

```sql
-- åœºæ™¯ï¼šç½®ä¿¡åº¦ä¼ æ’­
-- 1. å®šä¹‰ç½®ä¿¡åº¦åŠç¯
INSERT INTO semiring_types (semiring_name, semiring_definition) VALUES (
    'confidence',
    '{
        "add_function": "confidence_max",
        "multiply_function": "confidence_min",
        "zero": 0.0,
        "one": 1.0
    }'::jsonb
);

-- 2. æ•°æ®è´¨é‡è¯„ä¼°
SELECT
    data_item_id,
    compute_confidence_lineage(data_item_id, 'confidence'::uuid) as confidence_lineage
FROM data_items;
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](../25.01-å½¢å¼åŒ–æ–¹æ³•/01.05-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Green, T. J., et al. (2007). "Provenance Semirings."**
  - ä¼šè®®: PODS 2007
  - **é‡è¦æ€§**: åŠç¯è¡€ç¼˜çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†åŠç¯ä»£æ•°æ¨¡å‹

- **Cheney, J., et al. (2009). "Provenance in Databases: Why, How, and Where."**
  - ä¼šè®®: Foundations and Trends in Databases 2009
  - **é‡è¦æ€§**: æ•°æ®è¡€ç¼˜çš„ç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: æ€»ç»“äº†è¡€ç¼˜è¿½è¸ªæ–¹æ³•

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLæ‰©å±• - æ•°æ®è¡€ç¼˜](<https://github.com/postgresql/data-lineage>)**
  - PostgreSQLæ•°æ®è¡€ç¼˜æ‰©å±•

### 7.3 ç›¸å…³æ–‡æ¡£

- [æ•°æ®è¡€ç¼˜-why_where_howå½¢å¼è¯­ä¹‰](../../26-æ•°æ®ç®¡ç†/12.01-æ•°æ®è¡€ç¼˜-why_where_howå½¢å¼è¯­ä¹‰.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
