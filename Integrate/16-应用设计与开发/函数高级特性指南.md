---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: æ–°å¢æ·±åŒ–æ–‡æ¡£
> **ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£èšç„¦å‡½æ•°é«˜çº§ç‰¹æ€§æŠ€æœ¯æ ˆ

---

# PostgreSQLå‡½æ•°é«˜çº§ç‰¹æ€§æŒ‡å—

## å…ƒæ•°æ®

- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01
- **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | PL/pgSQL | PL/Python | PL/Perl | è‡ªå®šä¹‰èšåˆ
- **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)
- **é¢„è®¡é˜…è¯»**: 200åˆ†é’Ÿ
- **å‰ç½®è¦æ±‚**: ç†Ÿæ‚‰PostgreSQLåŸºç¡€ã€PL/pgSQLåŸºç¡€ã€ç¼–ç¨‹åŸºç¡€

---

## ğŸ“‹ å®Œæ•´ç›®å½•

- [PostgreSQLå‡½æ•°é«˜çº§ç‰¹æ€§æŒ‡å—](#postgresqlå‡½æ•°é«˜çº§ç‰¹æ€§æŒ‡å—)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [ğŸ“‹ å®Œæ•´ç›®å½•](#-å®Œæ•´ç›®å½•)
  - [1. å‡½æ•°æ¦‚è¿°](#1-å‡½æ•°æ¦‚è¿°)
    - [1.1 å‡½æ•°ç±»å‹](#11-å‡½æ•°ç±»å‹)
      - [å‡½æ•°åˆ†ç±»](#å‡½æ•°åˆ†ç±»)
    - [1.2 å‡½æ•°ç‰¹æ€§åˆ†ç±»](#12-å‡½æ•°ç‰¹æ€§åˆ†ç±»)
      - [ç‰¹æ€§æ ‡è®°](#ç‰¹æ€§æ ‡è®°)
  - [2. å¤šè¯­è¨€å‡½æ•°](#2-å¤šè¯­è¨€å‡½æ•°)
    - [2.1 PL/Pythonå‡½æ•°](#21-plpythonå‡½æ•°)
      - [å®‰è£…ä¸é…ç½®](#å®‰è£…ä¸é…ç½®)
      - [PL/PythonåŸºç¡€å‡½æ•°](#plpythonåŸºç¡€å‡½æ•°)
      - [PL/Pythonæ•°æ®å¤„ç†](#plpythonæ•°æ®å¤„ç†)
    - [2.2 PL/Perlå‡½æ•°](#22-plperlå‡½æ•°)
      - [PL/PerlåŸºç¡€](#plperlåŸºç¡€)
  - [3. è‡ªå®šä¹‰èšåˆå‡½æ•°](#3-è‡ªå®šä¹‰èšåˆå‡½æ•°)
    - [3.1 èšåˆå‡½æ•°åŸºç¡€](#31-èšåˆå‡½æ•°åŸºç¡€)
      - [èšåˆå‡½æ•°ç»“æ„](#èšåˆå‡½æ•°ç»“æ„)
    - [3.2 çŠ¶æ€å‡½æ•°](#32-çŠ¶æ€å‡½æ•°)
      - [çŠ¶æ€å‡½æ•°å®ç°](#çŠ¶æ€å‡½æ•°å®ç°)
    - [3.3 æœ€ç»ˆå‡½æ•°](#33-æœ€ç»ˆå‡½æ•°)
      - [æœ€ç»ˆå‡½æ•°å®ç°](#æœ€ç»ˆå‡½æ•°å®ç°)
    - [3.4 ç»„åˆå‡½æ•°](#34-ç»„åˆå‡½æ•°)
      - [ç»„åˆå‡½æ•°å®ç°ï¼ˆç”¨äºå¹¶è¡Œæ‰§è¡Œï¼‰](#ç»„åˆå‡½æ•°å®ç°ç”¨äºå¹¶è¡Œæ‰§è¡Œ)
    - [3.5 å®Œæ•´ç¤ºä¾‹](#35-å®Œæ•´ç¤ºä¾‹)
      - [è‡ªå®šä¹‰SUMèšåˆå‡½æ•°](#è‡ªå®šä¹‰sumèšåˆå‡½æ•°)
      - [å¤æ‚èšåˆå‡½æ•°ï¼šä¸­ä½æ•°](#å¤æ‚èšåˆå‡½æ•°ä¸­ä½æ•°)
  - [4. å‡½æ•°å®‰å…¨ç‰¹æ€§](#4-å‡½æ•°å®‰å…¨ç‰¹æ€§)
    - [4.1 SECURITY DEFINER](#41-security-definer)
      - [å®‰å…¨å®šä¹‰è€…å‡½æ•°](#å®‰å…¨å®šä¹‰è€…å‡½æ•°)
    - [4.2 SECURITY INVOKER](#42-security-invoker)
      - [å®‰å…¨è°ƒç”¨è€…å‡½æ•°ï¼ˆé»˜è®¤ï¼‰](#å®‰å…¨è°ƒç”¨è€…å‡½æ•°é»˜è®¤)
  - [5. å‡½æ•°ç¨³å®šæ€§ä¸å¹¶è¡Œ](#5-å‡½æ•°ç¨³å®šæ€§ä¸å¹¶è¡Œ)
    - [5.1 IMMUTABLE](#51-immutable)
      - [ä¸å¯å˜å‡½æ•°](#ä¸å¯å˜å‡½æ•°)
    - [5.2 STABLE](#52-stable)
      - [ç¨³å®šå‡½æ•°](#ç¨³å®šå‡½æ•°)
    - [5.3 VOLATILE](#53-volatile)
      - [æ˜“å˜å‡½æ•°ï¼ˆé»˜è®¤ï¼‰](#æ˜“å˜å‡½æ•°é»˜è®¤)
    - [5.4 å¹¶è¡Œæ‰§è¡Œ](#54-å¹¶è¡Œæ‰§è¡Œ)
      - [å¹¶è¡Œå®‰å…¨å‡½æ•°](#å¹¶è¡Œå®‰å…¨å‡½æ•°)
  - [6. å‡½æ•°é‡è½½ä¸å‚æ•°åŒ¹é…](#6-å‡½æ•°é‡è½½ä¸å‚æ•°åŒ¹é…)
    - [6.1 å‡½æ•°é‡è½½](#61-å‡½æ•°é‡è½½)
      - [é‡è½½ç¤ºä¾‹](#é‡è½½ç¤ºä¾‹)
  - [7. å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
    - [7.1 è‡ªå®šä¹‰ç»Ÿè®¡èšåˆå‡½æ•°](#71-è‡ªå®šä¹‰ç»Ÿè®¡èšåˆå‡½æ•°)
      - [å®Œæ•´ç»Ÿè®¡èšåˆå‡½æ•°](#å®Œæ•´ç»Ÿè®¡èšåˆå‡½æ•°)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## 1. å‡½æ•°æ¦‚è¿°

### 1.1 å‡½æ•°ç±»å‹

#### å‡½æ•°åˆ†ç±»

```text
æŒ‰è¿”å›ç±»å‹åˆ†ç±»:
1. æ ‡é‡å‡½æ•° - è¿”å›å•ä¸ªå€¼
2. è¡¨å‡½æ•° - è¿”å›è¡¨ï¼ˆRETURNS TABLEï¼‰
3. é›†åˆå‡½æ•° - è¿”å›é›†åˆï¼ˆRETURNS SETOFï¼‰

æŒ‰è¯­è¨€åˆ†ç±»:
1. SQLå‡½æ•° - LANGUAGE sql
2. PL/pgSQLå‡½æ•° - LANGUAGE plpgsql
3. PL/Pythonå‡½æ•° - LANGUAGE plpython3u
4. PL/Perlå‡½æ•° - LANGUAGE plperl
5. PL/Javaå‡½æ•° - LANGUAGE java
6. Cå‡½æ•° - LANGUAGE c

æŒ‰ç‰¹æ€§åˆ†ç±»:
1. IMMUTABLE - ç»“æœåªä¾èµ–å‚æ•°
2. STABLE - ç»“æœåœ¨åŒä¸€äº‹åŠ¡ä¸­ä¸å˜
3. VOLATILE - ç»“æœå¯èƒ½å˜åŒ–ï¼ˆé»˜è®¤ï¼‰
```

### 1.2 å‡½æ•°ç‰¹æ€§åˆ†ç±»

#### ç‰¹æ€§æ ‡è®°

```sql
-- IMMUTABLE: çº¯å‡½æ•°ï¼Œç»“æœåªä¾èµ–å‚æ•°
CREATE OR REPLACE FUNCTION add_numbers(a INTEGER, b INTEGER)
RETURNS INTEGER
LANGUAGE sql
IMMUTABLE
AS $$
    SELECT a + b;
$$;

-- STABLE: ç»“æœåœ¨åŒä¸€äº‹åŠ¡ä¸­ä¸å˜
CREATE OR REPLACE FUNCTION get_current_time()
RETURNS TIMESTAMPTZ
LANGUAGE sql
STABLE
AS $$
    SELECT NOW();
$$;

-- VOLATILE: ç»“æœå¯èƒ½å˜åŒ–ï¼ˆé»˜è®¤ï¼‰
CREATE OR REPLACE FUNCTION get_random_number()
RETURNS INTEGER
LANGUAGE sql
VOLATILE
AS $$
    SELECT floor(random() * 100)::INTEGER;
$$;
```

---

## 2. å¤šè¯­è¨€å‡½æ•°

### 2.1 PL/Pythonå‡½æ•°

#### å®‰è£…ä¸é…ç½®

```bash
# Ubuntu/Debian
sudo apt-get install postgresql-17-plpython3

# åœ¨æ•°æ®åº“ä¸­å¯ç”¨
CREATE EXTENSION IF NOT EXISTS plpython3u;
```

#### PL/PythonåŸºç¡€å‡½æ•°

```sql
-- ç®€å•çš„Pythonå‡½æ•°
-- PL/Pythoné—®å€™å‡½æ•°ï¼ˆå¸¦å‚æ•°éªŒè¯ï¼‰
CREATE OR REPLACE FUNCTION python_hello(p_name TEXT)
RETURNS TEXT
LANGUAGE plpython3u
AS $$
try:
    # å‚æ•°éªŒè¯
    if not p_name or not p_name.strip():
        plpy.error('åç§°ä¸èƒ½ä¸ºç©º')

    if len(p_name) > 100:
        plpy.error(f'åç§°è¿‡é•¿: {len(p_name)} (æœ€å¤§100å­—ç¬¦)')

    return f"Hello, {p_name.strip()}!"
except Exception as e:
    plpy.error(f'python_helloæ‰§è¡Œå¤±è´¥: {str(e)}')
$$;

-- ä½¿ç”¨NumPyè®¡ç®—ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯ï¼‰
CREATE OR REPLACE FUNCTION calculate_statistics(p_data NUMERIC[])
RETURNS TABLE (
    mean NUMERIC,
    stddev NUMERIC,
    median NUMERIC
)
LANGUAGE plpython3u
AS $$
import numpy as np
import plpy

try:
    # å‚æ•°éªŒè¯
    if p_data is None or len(p_data) == 0:
        plpy.error('æ•°æ®æ•°ç»„ä¸èƒ½ä¸ºç©º')

    if len(p_data) > 1000000:
        plpy.error(f'æ•°æ®é‡è¿‡å¤§: {len(p_data)} (æœ€å¤§1000000)')

    # è½¬æ¢ä¸ºnumpyæ•°ç»„
    try:
        arr = np.array(p_data, dtype=float)
    except Exception as e:
        plpy.error(f'æ•°æ®è½¬æ¢å¤±è´¥: {str(e)}')

    # è¿‡æ»¤NaNå€¼
    arr = arr[~np.isnan(arr)]

    if len(arr) == 0:
        plpy.warning('æ•°æ®ä¸­åªåŒ…å«æ— æ•ˆå€¼')
        return [(None, None, None)]

    # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    try:
        mean_val = float(np.mean(arr))
        stddev_val = float(np.std(arr))
        median_val = float(np.median(arr))

        return [
            (mean_val if not np.isnan(mean_val) else None,
             stddev_val if not np.isnan(stddev_val) else None,
             median_val if not np.isnan(median_val) else None)
        ]
    except Exception as e:
        plpy.error(f'è®¡ç®—ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: {str(e)}')

except Exception as e:
    plpy.error(f'calculate_statisticsæ‰§è¡Œå¤±è´¥: {str(e)}')
$$;
```

#### PL/Pythonæ•°æ®å¤„ç†

```sql
-- ä½¿ç”¨Pandaså¤„ç†æ•°æ®ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œè¾“å…¥éªŒè¯ï¼‰
CREATE OR REPLACE FUNCTION analyze_table_pandas(
    p_table_name TEXT,
    p_column_name TEXT
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC
)
LANGUAGE plpython3u
AS $$
import pandas as pd
import plpy
import re

try:
    # å‚æ•°éªŒè¯
    if not p_table_name or not p_table_name.strip():
        plpy.error('è¡¨åä¸èƒ½ä¸ºç©º')

    if not p_column_name or not p_column_name.strip():
        plpy.error('åˆ—åä¸èƒ½ä¸ºç©º')

    # éªŒè¯è¡¨åå’Œåˆ—åæ ¼å¼ï¼ˆé˜²æ­¢SQLæ³¨å…¥ï¼‰
    if not re.match(r'^[a-zA-Z_][a-zA-Z0-9_]*$', p_table_name):
        plpy.error(f'è¡¨åæ ¼å¼æ— æ•ˆ: {p_table_name}')

    if not re.match(r'^[a-zA-Z_][a-zA-Z0-9_]*$', p_column_name):
        plpy.error(f'åˆ—åæ ¼å¼æ— æ•ˆ: {p_column_name}')

    # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    check_table = plpy.execute(
        f"SELECT 1 FROM information_schema.tables "
        f"WHERE table_schema = 'public' AND table_name = '{p_table_name}'"
    )

    if not check_table:
        plpy.error(f'è¡¨ä¸å­˜åœ¨: {p_table_name}')

    # æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
    check_column = plpy.execute(
        f"SELECT 1 FROM information_schema.columns "
        f"WHERE table_schema = 'public' AND table_name = '{p_table_name}' "
        f"AND column_name = '{p_column_name}'"
    )

    if not check_column:
        plpy.error(f'åˆ—ä¸å­˜åœ¨: {p_table_name}.{p_column_name}')

    # å®‰å…¨æ„å»ºæŸ¥è¯¢ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ›´å¥½ï¼Œä½†PL/Pythoné™åˆ¶ä½¿ç”¨f-stringï¼‰
    # æ³¨æ„ï¼šç”±äºå·²éªŒè¯è¡¨åå’Œåˆ—åæ ¼å¼ï¼Œè¿™é‡Œæ˜¯å®‰å…¨çš„
    query = f'SELECT "{p_column_name}" FROM "{p_table_name}"'
    result = plpy.execute(query)

    if not result:
        plpy.warning(f'è¡¨ {p_table_name} ä¸ºç©º')
        return

    # è½¬æ¢ä¸ºDataFrame
    df = pd.DataFrame([dict(row) for row in result])

    if len(df) == 0:
        plpy.warning(f'è¡¨ {p_table_name} ä¸­æ²¡æœ‰æ•°æ®')
        return

    # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    try:
        stats = {
            'count': len(df),
            'mean': float(df[p_column_name].mean()) if pd.notna(df[p_column_name].mean()) else None,
            'std': float(df[p_column_name].std()) if pd.notna(df[p_column_name].std()) else None,
            'min': float(df[p_column_name].min()) if pd.notna(df[p_column_name].min()) else None,
            'max': float(df[p_column_name].max()) if pd.notna(df[p_column_name].max()) else None,
            'median': float(df[p_column_name].median()) if pd.notna(df[p_column_name].median()) else None
        }

        for key, value in stats.items():
            yield (key, value if value is not None else 0)
    except Exception as e:
        plpy.error(f'è®¡ç®—ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: {str(e)}')

except Exception as e:
    plpy.error(f'analyze_table_pandasæ‰§è¡Œå¤±è´¥: {str(e)}')
$$;
```

### 2.2 PL/Perlå‡½æ•°

#### PL/PerlåŸºç¡€

```sql
-- å¯ç”¨PL/Perl
CREATE EXTENSION IF NOT EXISTS plperl;

-- ç®€å•çš„Perlå‡½æ•°
CREATE OR REPLACE FUNCTION perl_reverse(text)
RETURNS TEXT
LANGUAGE plperl
AS $$
    return reverse($_[0]);
$$;

-- Perlæ•°æ®å¤„ç†
CREATE OR REPLACE FUNCTION perl_process_array(data INTEGER[])
RETURNS INTEGER[]
LANGUAGE plperl
AS $$
    my @arr = @{$_[0]};
    @arr = map { $_ * 2 } @arr;
    return \@arr;
$$;
```

---

## 3. è‡ªå®šä¹‰èšåˆå‡½æ•°

### 3.1 èšåˆå‡½æ•°åŸºç¡€

#### èšåˆå‡½æ•°ç»“æ„

```text
èšåˆå‡½æ•°ç»„ä»¶:
1. çŠ¶æ€å‡½æ•°ï¼ˆState Functionï¼‰ - å¤„ç†æ¯ä¸ªè¾“å…¥å€¼
2. æœ€ç»ˆå‡½æ•°ï¼ˆFinal Functionï¼‰ - å¤„ç†æœ€ç»ˆç»“æœ
3. åˆå§‹çŠ¶æ€ï¼ˆInitial Stateï¼‰ - åˆå§‹å€¼
4. ç»„åˆå‡½æ•°ï¼ˆCombine Functionï¼‰ - ç»„åˆå¹¶è¡Œæ‰§è¡Œç»“æœï¼ˆå¯é€‰ï¼‰
```

### 3.2 çŠ¶æ€å‡½æ•°

#### çŠ¶æ€å‡½æ•°å®ç°

```sql
-- çŠ¶æ€å‡½æ•°ï¼šç´¯ç§¯å¤„ç†æ¯ä¸ªå€¼
CREATE OR REPLACE FUNCTION sum_state(
    state INTEGER,
    value INTEGER
)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN COALESCE(state, 0) + value;
END;
$$;
```

### 3.3 æœ€ç»ˆå‡½æ•°

#### æœ€ç»ˆå‡½æ•°å®ç°

```sql
-- æœ€ç»ˆå‡½æ•°ï¼šå¤„ç†æœ€ç»ˆçŠ¶æ€
CREATE OR REPLACE FUNCTION sum_final(state INTEGER)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN COALESCE(state, 0);
END;
$$;
```

### 3.4 ç»„åˆå‡½æ•°

#### ç»„åˆå‡½æ•°å®ç°ï¼ˆç”¨äºå¹¶è¡Œæ‰§è¡Œï¼‰

```sql
-- ç»„åˆå‡½æ•°ï¼šç»„åˆä¸¤ä¸ªçŠ¶æ€
CREATE OR REPLACE FUNCTION sum_combine(
    state1 INTEGER,
    state2 INTEGER
)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN COALESCE(state1, 0) + COALESCE(state2, 0);
END;
$$;
```

### 3.5 å®Œæ•´ç¤ºä¾‹

#### è‡ªå®šä¹‰SUMèšåˆå‡½æ•°

```sql
-- åˆ›å»ºå®Œæ•´çš„è‡ªå®šä¹‰èšåˆå‡½æ•°
CREATE AGGREGATE custom_sum(INTEGER) (
    SFUNC = sum_state,
    STYPE = INTEGER,
    INITCOND = 0,
    FINALFUNC = sum_final,
    COMBINEFUNC = sum_combine,
    PARALLEL = SAFE
);

-- ä½¿ç”¨ç¤ºä¾‹
SELECT custom_sum(value) FROM numbers;
```

#### å¤æ‚èšåˆå‡½æ•°ï¼šä¸­ä½æ•°

```sql
-- çŠ¶æ€å‡½æ•°ï¼šç´¯ç§¯æ‰€æœ‰å€¼
CREATE OR REPLACE FUNCTION median_state(
    state INTEGER[],
    value INTEGER
)
RETURNS INTEGER[]
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN array_append(COALESCE(state, ARRAY[]::INTEGER[]), value);
END;
$$;

-- æœ€ç»ˆå‡½æ•°ï¼šè®¡ç®—ä¸­ä½æ•°
CREATE OR REPLACE FUNCTION median_final(state INTEGER[])
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    sorted INTEGER[];
    mid INTEGER;
BEGIN
    IF state IS NULL OR array_length(state, 1) IS NULL THEN
        RETURN NULL;
    END IF;

    sorted := state;
    SELECT INTO sorted array_agg(val ORDER BY val) FROM unnest(state) AS val;

    mid := array_length(sorted, 1) / 2;

    IF array_length(sorted, 1) % 2 = 0 THEN
        RETURN (sorted[mid] + sorted[mid + 1]) / 2.0;
    ELSE
        RETURN sorted[mid + 1];
    END IF;
END;
$$;

-- ç»„åˆå‡½æ•°
CREATE OR REPLACE FUNCTION median_combine(
    state1 INTEGER[],
    state2 INTEGER[]
)
RETURNS INTEGER[]
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN COALESCE(state1, ARRAY[]::INTEGER[]) || COALESCE(state2, ARRAY[]::INTEGER[]);
END;
$$;

-- åˆ›å»ºèšåˆå‡½æ•°
CREATE AGGREGATE custom_median(INTEGER) (
    SFUNC = median_state,
    STYPE = INTEGER[],
    INITCOND = '{}',
    FINALFUNC = median_final,
    COMBINEFUNC = median_combine,
    PARALLEL = SAFE
);

-- ä½¿ç”¨ç¤ºä¾‹
SELECT custom_median(value) FROM numbers;
```

---

## 4. å‡½æ•°å®‰å…¨ç‰¹æ€§

### 4.1 SECURITY DEFINER

#### å®‰å…¨å®šä¹‰è€…å‡½æ•°

```sql
-- ä½¿ç”¨SECURITY DEFINERä»¥å‡½æ•°æ‰€æœ‰è€…æƒé™æ‰§è¡Œ
CREATE OR REPLACE FUNCTION admin_only_operation(user_id INTEGER)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_temp  -- é˜²æ­¢æœç´¢è·¯å¾„æ”»å‡»
AS $$
BEGIN
    -- æ£€æŸ¥è°ƒç”¨è€…
    IF current_user != 'app_user' THEN
        RAISE EXCEPTION 'Permission denied';
    END IF;

    -- ä»¥å‡½æ•°æ‰€æœ‰è€…ï¼ˆadminï¼‰æƒé™æ‰§è¡Œ
    UPDATE users SET status = 'admin' WHERE id = user_id;
END;
$$;

-- æˆäºˆæ‰§è¡Œæƒé™
GRANT EXECUTE ON FUNCTION admin_only_operation(INTEGER) TO app_user;
```

### 4.2 SECURITY INVOKER

#### å®‰å…¨è°ƒç”¨è€…å‡½æ•°ï¼ˆé»˜è®¤ï¼‰

```sql
-- SECURITY INVOKERï¼šä»¥è°ƒç”¨è€…æƒé™æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
CREATE OR REPLACE FUNCTION user_operation(user_id INTEGER)
RETURNS VOID
LANGUAGE plpgsql
SECURITY INVOKER
AS $$
BEGIN
    -- åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
    IF user_id != current_setting('app.user_id', true)::INTEGER THEN
        RAISE EXCEPTION 'Permission denied: can only access own data';
    END IF;

    UPDATE users SET last_login = NOW() WHERE id = user_id;
END;
$$;
```

---

## 5. å‡½æ•°ç¨³å®šæ€§ä¸å¹¶è¡Œ

### 5.1 IMMUTABLE

#### ä¸å¯å˜å‡½æ•°

```sql
-- IMMUTABLEå‡½æ•°ï¼šç»“æœåªä¾èµ–å‚æ•°
CREATE OR REPLACE FUNCTION calculate_tax(price NUMERIC, rate NUMERIC DEFAULT 0.1)
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN price * rate;
END;
$$;

-- å¯ä»¥åœ¨ç´¢å¼•ä¸­ä½¿ç”¨
CREATE INDEX idx_products_tax ON products (calculate_tax(price, 0.1));
```

### 5.2 STABLE

#### ç¨³å®šå‡½æ•°

```sql
-- STABLEå‡½æ•°ï¼šç»“æœåœ¨åŒä¸€äº‹åŠ¡ä¸­ä¸å˜
CREATE OR REPLACE FUNCTION get_user_balance(user_id INTEGER)
RETURNS NUMERIC
LANGUAGE plpgsql
STABLE
AS $$
DECLARE
    v_balance NUMERIC;
BEGIN
    SELECT balance INTO v_balance
    FROM accounts
    WHERE user_id = get_user_balance.user_id;

    RETURN COALESCE(v_balance, 0);
END;
$$;
```

### 5.3 VOLATILE

#### æ˜“å˜å‡½æ•°ï¼ˆé»˜è®¤ï¼‰

```sql
-- VOLATILEå‡½æ•°ï¼šç»“æœå¯èƒ½å˜åŒ–
CREATE OR REPLACE FUNCTION get_random_id()
RETURNS INTEGER
LANGUAGE plpgsql
VOLATILE
AS $$
BEGIN
    RETURN floor(random() * 1000000)::INTEGER;
END;
$$;
```

### 5.4 å¹¶è¡Œæ‰§è¡Œ

#### å¹¶è¡Œå®‰å…¨å‡½æ•°

```sql
-- PARALLEL SAFEï¼šå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
CREATE OR REPLACE FUNCTION parallel_safe_function(value INTEGER)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
PARALLEL SAFE
AS $$
BEGIN
    RETURN value * 2;
END;
$$;

-- PARALLEL UNSAFEï¼šä¸èƒ½å¹¶è¡Œæ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
CREATE OR REPLACE FUNCTION parallel_unsafe_function()
RETURNS INTEGER
LANGUAGE plpgsql
VOLATILE
PARALLEL UNSAFE
AS $$
BEGIN
    -- è®¿é—®å…±äº«çŠ¶æ€ï¼Œä¸èƒ½å¹¶è¡Œ
    PERFORM pg_advisory_lock(1);
    RETURN 1;
END;
$$;
```

---

## 6. å‡½æ•°é‡è½½ä¸å‚æ•°åŒ¹é…

### 6.1 å‡½æ•°é‡è½½

#### é‡è½½ç¤ºä¾‹

```sql
-- é‡è½½å‡½æ•°ï¼šä¸åŒå‚æ•°ç±»å‹
CREATE OR REPLACE FUNCTION add_numbers(a INTEGER, b INTEGER)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN a + b;
END;
$$;

CREATE OR REPLACE FUNCTION add_numbers(a NUMERIC, b NUMERIC)
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN a + b;
END;
$$;

-- è‡ªåŠ¨é€‰æ‹©åŒ¹é…çš„å‡½æ•°
SELECT add_numbers(1, 2);        -- ä½¿ç”¨INTEGERç‰ˆæœ¬
SELECT add_numbers(1.5, 2.5);    -- ä½¿ç”¨NUMERICç‰ˆæœ¬
```

---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 è‡ªå®šä¹‰ç»Ÿè®¡èšåˆå‡½æ•°

#### å®Œæ•´ç»Ÿè®¡èšåˆå‡½æ•°

```sql
-- çŠ¶æ€ç±»å‹ï¼šç´¯ç§¯ç»Ÿè®¡ä¿¡æ¯
CREATE TYPE stats_state AS (
    count BIGINT,
    sum NUMERIC,
    sum_sq NUMERIC,
    min_val NUMERIC,
    max_val NUMERIC
);

-- çŠ¶æ€å‡½æ•°
CREATE OR REPLACE FUNCTION stats_state_func(
    state stats_state,
    value NUMERIC
)
RETURNS stats_state
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    new_state stats_state;
BEGIN
    IF state IS NULL THEN
        new_state := (1, value, value * value, value, value);
    ELSE
        new_state := (
            state.count + 1,
            state.sum + value,
            state.sum_sq + (value * value),
            LEAST(state.min_val, value),
            GREATEST(state.max_val, value)
        );
    END IF;

    RETURN new_state;
END;
$$;

-- æœ€ç»ˆå‡½æ•°ï¼šè®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
CREATE OR REPLACE FUNCTION stats_final_func(state stats_state)
RETURNS TABLE (
    count BIGINT,
    mean NUMERIC,
    stddev NUMERIC,
    variance NUMERIC,
    min_val NUMERIC,
    max_val NUMERIC
)
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    v_mean NUMERIC;
    v_variance NUMERIC;
BEGIN
    IF state IS NULL OR state.count = 0 THEN
        RETURN;
    END IF;

    v_mean := state.sum / state.count;
    v_variance := (state.sum_sq / state.count) - (v_mean * v_mean);

    RETURN QUERY SELECT
        state.count,
        v_mean,
        sqrt(v_variance),
        v_variance,
        state.min_val,
        state.max_val;
END;
$$;

-- ç»„åˆå‡½æ•°
CREATE OR REPLACE FUNCTION stats_combine_func(
    state1 stats_state,
    state2 stats_state
)
RETURNS stats_state
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    IF state1 IS NULL THEN
        RETURN state2;
    END IF;

    IF state2 IS NULL THEN
        RETURN state1;
    END IF;

    RETURN (
        state1.count + state2.count,
        state1.sum + state2.sum,
        state1.sum_sq + state2.sum_sq,
        LEAST(state1.min_val, state2.min_val),
        GREATEST(state1.max_val, state2.max_val)
    );
END;
$$;

-- åˆ›å»ºèšåˆå‡½æ•°
CREATE AGGREGATE comprehensive_stats(NUMERIC) (
    SFUNC = stats_state_func,
    STYPE = stats_state,
    FINALFUNC = stats_final_func,
    COMBINEFUNC = stats_combine_func,
    INITCOND = '(0, 0, 0, NULL, NULL)',
    PARALLEL = SAFE
);

-- ä½¿ç”¨ç¤ºä¾‹
SELECT comprehensive_stats(amount) FROM orders;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£**: <https://www.postgresql.org/docs/current/xfunc.html>
2. **PL/Pythonæ–‡æ¡£**: <https://www.postgresql.org/docs/current/plpython.html>
3. **è‡ªå®šä¹‰èšåˆå‡½æ•°**: <https://www.postgresql.org/docs/current/xaggr.html>

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.0** (2025-01): é«˜çº§ç‰¹æ€§æŒ‡å—
  - è¡¥å……å¤šè¯­è¨€å‡½æ•°ï¼ˆPL/Pythonã€PL/Perlï¼‰
  - è¡¥å……è‡ªå®šä¹‰èšåˆå‡½æ•°å®Œæ•´å®ç°
  - è¡¥å……å‡½æ•°å®‰å…¨ç‰¹æ€§
  - è¡¥å……å‡½æ•°ç¨³å®šæ€§ä¸å¹¶è¡Œæ‰§è¡Œ
  - è¡¥å……å‡½æ•°é‡è½½
  - è¡¥å……å®æˆ˜æ¡ˆä¾‹

---

**çŠ¶æ€**: âœ… **æ–‡æ¡£å®Œæˆ** | [è¿”å›ç›®å½•](./README.md)
