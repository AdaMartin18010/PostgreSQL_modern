# PostgreSQLé›†æˆæµ‹è¯•æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLé›†æˆæµ‹è¯•æŒ‡å—](#postgresqlé›†æˆæµ‹è¯•æŒ‡å—)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ä¸šåŠ¡æµç¨‹æµ‹è¯•](#2-ä¸šåŠ¡æµç¨‹æµ‹è¯•)
  - [3. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•](#3-æ•°æ®ä¸€è‡´æ€§æµ‹è¯•)
  - [4. æ€§èƒ½é›†æˆæµ‹è¯•](#4-æ€§èƒ½é›†æˆæµ‹è¯•)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)

---

## 1. æ¦‚è¿°

é›†æˆæµ‹è¯•éªŒè¯å¤šä¸ªç»„ä»¶ååŒå·¥ä½œçš„æ­£ç¡®æ€§ã€‚

**æµ‹è¯•èŒƒå›´**:
- ä¸šåŠ¡æµç¨‹
- æ•°æ®ä¸€è‡´æ€§
- æ€§èƒ½è¦æ±‚
- é”™è¯¯å¤„ç†

---

## 2. ä¸šåŠ¡æµç¨‹æµ‹è¯•

### 2.1 å®Œæ•´æµç¨‹æµ‹è¯•

```sql
BEGIN;
SELECT plan(5);

-- 1. åˆ›å»ºç”¨æˆ·
INSERT INTO users (name, email) VALUES ('Test', 'test@example.com');
SELECT ok(
    (SELECT COUNT(*) FROM users WHERE email = 'test@example.com') = 1,
    'User should be created'
);

-- 2. åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, amount)
SELECT id, 100 FROM users WHERE email = 'test@example.com';
SELECT ok(
    (SELECT COUNT(*) FROM orders WHERE user_id =
     (SELECT id FROM users WHERE email = 'test@example.com')) = 1,
    'Order should be created'
);

-- 3. æ›´æ–°åº“å­˜
UPDATE products SET stock = stock - 1 WHERE id = 1;
SELECT ok(
    (SELECT stock FROM products WHERE id = 1) >= 0,
    'Stock should be valid'
);

-- 4. éªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT ok(
    (SELECT COUNT(*) FROM orders o
     JOIN users u ON o.user_id = u.id
     WHERE u.email = 'test@example.com') = 1,
    'Data should be consistent'
);

-- 5. æ¸…ç†æµ‹è¯•æ•°æ®
DELETE FROM orders WHERE user_id = (SELECT id FROM users WHERE email = 'test@example.com');
DELETE FROM users WHERE email = 'test@example.com';
SELECT ok(
    (SELECT COUNT(*) FROM users WHERE email = 'test@example.com') = 0,
    'Test data should be cleaned'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 3. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

### 3.1 å¤–é”®çº¦æŸæµ‹è¯•

```sql
BEGIN;
SELECT plan(2);

-- æµ‹è¯•å¤–é”®çº¦æŸ
SELECT throws_ok(
    'INSERT INTO orders (user_id, amount) VALUES (999, 100)',
    '23503',
    'Foreign key constraint should be enforced'
);

-- æµ‹è¯•çº§è”åˆ é™¤
INSERT INTO users (name, email) VALUES ('Test', 'test@example.com');
INSERT INTO orders (user_id, amount)
SELECT id, 100 FROM users WHERE email = 'test@example.com';
DELETE FROM users WHERE email = 'test@example.com';

SELECT ok(
    (SELECT COUNT(*) FROM orders WHERE user_id =
     (SELECT id FROM users WHERE email = 'test@example.com')) = 0,
    'Orders should be deleted with user'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 4. æ€§èƒ½é›†æˆæµ‹è¯•

### 4.1 å¹¶å‘æµ‹è¯•

```sql
-- æµ‹è¯•å¹¶å‘æ’å…¥
BEGIN;
SELECT plan(1);

-- æ¨¡æ‹Ÿå¹¶å‘æ’å…¥
DO $$
DECLARE
    i INT;
BEGIN
    FOR i IN 1..100 LOOP
        INSERT INTO users (name, email)
        VALUES ('User' || i, 'user' || i || '@example.com');
    END LOOP;
END $$;

SELECT ok(
    (SELECT COUNT(*) FROM users WHERE email LIKE 'user%@example.com') = 100,
    'Concurrent inserts should work'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **æµ‹è¯•å®Œæ•´æµç¨‹** - è¦†ç›–ä¸šåŠ¡æµç¨‹
2. **æ•°æ®éš”ç¦»** - ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
3. **æ¸…ç†æ•°æ®** - æµ‹è¯•åæ¸…ç†
4. **é”™è¯¯å¤„ç†** - æµ‹è¯•é”™è¯¯åœºæ™¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•å®Œæ•´æŒ‡å—.md](./æµ‹è¯•å®Œæ•´æŒ‡å—.md) - æµ‹è¯•å®Œæ•´æŒ‡å—
- [å•å…ƒæµ‹è¯•.md](./å•å…ƒæµ‹è¯•.md) - å•å…ƒæµ‹è¯•è¯¦è§£
- [æ€§èƒ½æµ‹è¯•.md](./æ€§èƒ½æµ‹è¯•.md) - æ€§èƒ½æµ‹è¯•è¯¦è§£
- [16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/README.md](../README.md) - åº”ç”¨è®¾è®¡ä¸å¼€å‘ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
