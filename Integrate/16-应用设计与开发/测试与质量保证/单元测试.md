# PostgreSQL单元测试指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL单元测试指南](#postgresql单元测试指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. pgTAP使用](#2-pgtap使用)
    - [2.1 安装pgTAP](#21-安装pgtap)
    - [2.2 基本测试](#22-基本测试)
  - [3. 函数测试](#3-函数测试)
    - [3.1 测试函数](#31-测试函数)
  - [4. 触发器测试](#4-触发器测试)
    - [4.1 测试触发器](#41-测试触发器)
  - [5. 最佳实践](#5-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

单元测试验证PostgreSQL函数、触发器等单个组件的正确性。

**测试对象**:

- 函数
- 触发器
- 视图
- 约束

---

## 2. pgTAP使用

### 2.1 安装pgTAP

```sql
CREATE EXTENSION IF NOT EXISTS pgtap;
```

### 2.2 基本测试

```sql
BEGIN;
SELECT plan(2);

SELECT ok(
    (SELECT COUNT(*) FROM users) >= 0,
    'Users table should exist'
);

SELECT is(
    (SELECT COUNT(*) FROM users WHERE email IS NULL),
    0,
    'Users should have email'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 3. 函数测试

### 3.1 测试函数

```sql
-- 创建测试函数
CREATE OR REPLACE FUNCTION add_user(name TEXT, email TEXT)
RETURNS INT AS $$
DECLARE
    user_id INT;
BEGIN
    INSERT INTO users (name, email)
    VALUES (name, email)
    RETURNING id INTO user_id;
    RETURN user_id;
END;
$$ LANGUAGE plpgsql;

-- 测试函数
BEGIN;
SELECT plan(3);

SELECT ok(
    add_user('Test', 'test@example.com') > 0,
    'add_user should return user id'
);

SELECT is(
    (SELECT COUNT(*) FROM users WHERE email = 'test@example.com'),
    1,
    'User should be created'
);

SELECT throws_ok(
    'SELECT add_user(NULL, NULL)',
    '23502',
    'User name and email are required'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 4. 触发器测试

### 4.1 测试触发器

```sql
-- 创建触发器
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- 测试触发器
BEGIN;
SELECT plan(1);

INSERT INTO users (name, email) VALUES ('Test', 'test@example.com');
UPDATE users SET name = 'Updated' WHERE email = 'test@example.com';

SELECT ok(
    (SELECT updated_at FROM users WHERE email = 'test@example.com') >
    (SELECT created_at FROM users WHERE email = 'test@example.com'),
    'updated_at should be updated'
);

SELECT * FROM finish();
ROLLBACK;
```

---

## 5. 最佳实践

### ✅ 推荐做法

1. **测试隔离** - 每个测试独立
2. **使用事务** - 测试后回滚
3. **测试数据** - 使用测试数据
4. **测试覆盖** - 覆盖所有分支

---

## 📚 相关文档

- [测试完整指南.md](./测试完整指南.md) - 测试完整指南
- [集成测试.md](./集成测试.md) - 集成测试详解
- [测试自动化.md](./测试自动化.md) - 测试自动化
- [16-应用设计与开发/README.md](../README.md) - 应用设计与开发主题

---

**最后更新**: 2025年1月
