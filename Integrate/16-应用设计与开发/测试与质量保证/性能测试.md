# PostgreSQL性能测试指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL性能测试指南](#postgresql性能测试指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. pgbench使用](#2-pgbench使用)
    - [2.1 初始化测试数据](#21-初始化测试数据)
    - [2.2 运行性能测试](#22-运行性能测试)
    - [2.3 测试结果](#23-测试结果)
  - [3. 查询性能测试](#3-查询性能测试)
    - [3.1 测试单个查询](#31-测试单个查询)
    - [3.2 测试查询集](#32-测试查询集)
  - [4. 并发性能测试](#4-并发性能测试)
    - [4.1 并发查询测试](#41-并发查询测试)
  - [5. 性能基准](#5-性能基准)
    - [5.1 基准指标](#51-基准指标)
    - [5.2 性能优化](#52-性能优化)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

性能测试验证PostgreSQL应用是否满足性能要求。

**测试指标**:

- 查询响应时间
- 吞吐量
- 并发处理能力
- 资源使用

---

## 2. pgbench使用

### 2.1 初始化测试数据

```bash
# 初始化测试数据库
pgbench -i -s 50 mydb

# -i: 初始化
# -s: 缩放因子（50倍标准数据）
```

### 2.2 运行性能测试

```bash
# 基础性能测试
pgbench -c 10 -j 2 -T 60 mydb

# -c: 客户端数
# -j: 线程数
# -T: 运行时间（秒）
```

### 2.3 测试结果

```text
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 50
query mode: simple
number of clients: 10
number of threads: 2
duration: 60 s
number of transactions actually processed: 12345
latency average = 48.6 ms
tps = 205.8 (including connections establishing)
```

---

## 3. 查询性能测试

### 3.1 测试单个查询

```sql
-- 使用EXPLAIN ANALYZE
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM users WHERE email = 'test@example.com';
```

### 3.2 测试查询集

```sql
-- 测试多个查询
\timing on

SELECT * FROM users WHERE email = 'test@example.com';
SELECT * FROM orders WHERE user_id = 1;
SELECT * FROM products WHERE category = 'Electronics';
```

---

## 4. 并发性能测试

### 4.1 并发查询测试

```sql
-- 使用pgbench自定义脚本
-- test.sql
BEGIN;
SELECT * FROM users WHERE id = :id;
UPDATE users SET last_login = NOW() WHERE id = :id;
COMMIT;
```

```bash
# 运行并发测试
pgbench -c 20 -j 4 -T 60 -f test.sql mydb
```

---

## 5. 性能基准

### 5.1 基准指标

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| **查询响应时间** | < 100ms | EXPLAIN ANALYZE |
| **TPS** | > 1000 | pgbench |
| **并发连接** | > 100 | 压力测试 |

### 5.2 性能优化

```text
1. 分析慢查询
2. 优化索引
3. 调整配置参数
4. 重新测试
```

---

## 📚 相关文档

- [测试完整指南.md](./测试完整指南.md) - 测试完整指南
- [压力测试.md](./压力测试.md) - 压力测试详解
- [测试自动化.md](./测试自动化.md) - 测试自动化
- [16-应用设计与开发/README.md](../README.md) - 应用设计与开发主题

---

**最后更新**: 2025年1月
