# PostgreSQL压力测试指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL压力测试指南](#postgresql压力测试指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 压力测试工具](#2-压力测试工具)
    - [2.1 pgbench](#21-pgbench)
    - [2.2 自定义脚本](#22-自定义脚本)
  - [3. 测试场景](#3-测试场景)
    - [3.1 场景1: 高并发读取](#31-场景1-高并发读取)
    - [3.2 场景2: 高并发写入](#32-场景2-高并发写入)
    - [3.3 场景3: 混合负载](#33-场景3-混合负载)
  - [4. 监控指标](#4-监控指标)
    - [4.1 数据库指标](#41-数据库指标)
    - [4.2 系统指标](#42-系统指标)
  - [5. 结果分析](#5-结果分析)
    - [5.1 性能指标](#51-性能指标)
    - [5.2 优化建议](#52-优化建议)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

压力测试验证PostgreSQL在极限负载下的表现。

**测试目标**:

- 发现性能瓶颈
- 确定系统极限
- 验证稳定性
- 优化配置

---

## 2. 压力测试工具

### 2.1 pgbench

```bash
# 高并发压力测试
pgbench -c 100 -j 8 -T 300 mydb

# -c: 100个客户端
# -j: 8个线程
# -T: 运行5分钟
```

### 2.2 自定义脚本

```sql
-- stress_test.sql
BEGIN;
SELECT * FROM users WHERE id = :id;
UPDATE users SET last_login = NOW() WHERE id = :id;
INSERT INTO logs (user_id, action) VALUES (:id, 'login');
COMMIT;
```

```bash
pgbench -c 200 -j 16 -T 600 -f stress_test.sql mydb
```

---

## 3. 测试场景

### 3.1 场景1: 高并发读取

```bash
# 只读压力测试
pgbench -c 200 -j 16 -T 300 -S mydb

# -S: 只读模式
```

### 3.2 场景2: 高并发写入

```bash
# 写入压力测试
pgbench -c 100 -j 8 -T 300 -N mydb

# -N: 跳过SELECT
```

### 3.3 场景3: 混合负载

```bash
# 混合负载测试
pgbench -c 150 -j 12 -T 300 mydb
```

---

## 4. 监控指标

### 4.1 数据库指标

```sql
-- 监控连接数
SELECT COUNT(*) FROM pg_stat_activity;

-- 监控锁等待
SELECT * FROM pg_locks WHERE NOT granted;

-- 监控慢查询
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 4.2 系统指标

```bash
# 监控CPU和内存
top -p $(pgrep -f postgres)

# 监控I/O
iostat -x 1
```

---

## 5. 结果分析

### 5.1 性能指标

| 指标 | 正常范围 | 异常处理 |
|------|---------|---------|
| **TPS** | > 1000 | 优化查询 |
| **延迟** | < 100ms | 优化索引 |
| **连接数** | < max_connections | 增加连接池 |

### 5.2 优化建议

```text
1. 分析慢查询
2. 优化索引
3. 调整配置参数
4. 增加硬件资源
5. 优化应用代码
```

---

## 📚 相关文档

- [测试完整指南.md](./测试完整指南.md) - 测试完整指南
- [性能测试.md](./性能测试.md) - 性能测试详解
- [测试自动化.md](./测试自动化.md) - 测试自动化
- [16-应用设计与开发/README.md](../README.md) - 应用设计与开发主题

---

**最后更新**: 2025年1月
