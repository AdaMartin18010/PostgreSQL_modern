---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\09-åº”ç”¨è®¾è®¡\åº”ç”¨æ¶æ„\07.04-å†…å®¹ç®¡ç†ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLå†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰å®Œæ•´å®è·µæŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: åšå®¢ç³»ç»Ÿã€æ–°é—»ç½‘ç«™ã€çŸ¥è¯†åº“ã€æ–‡æ¡£ç®¡ç†

---

## ğŸ“‘ ç›®å½•

- [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
- [1.2 æŠ€æœ¯æŒ‘æˆ˜](#12-æŠ€æœ¯æŒ‘æˆ˜)
- [1.3 PostgreSQLä¼˜åŠ¿](#13-postgresqlä¼˜åŠ¿)
- [1.4 ç‰ˆæœ¬è¦æ±‚](#14-ç‰ˆæœ¬è¦æ±‚)
- [2.1 CMSæ ¸å¿ƒåŠŸèƒ½](#21-cmsæ ¸å¿ƒåŠŸèƒ½)
- [2.2 æ•°æ®æ¨¡å‹è®¾è®¡](#22-æ•°æ®æ¨¡å‹è®¾è®¡)
- [2.3 æƒé™æ§åˆ¶æ¨¡å‹](#23-æƒé™æ§åˆ¶æ¨¡å‹)
- [2.4 æ€ç»´å¯¼å›¾](#24-æ€ç»´å¯¼å›¾)
- [3.1 æ•´ä½“æ¶æ„è®¾è®¡](#31-æ•´ä½“æ¶æ„è®¾è®¡)
- [3.2 æ•°æ®æµè®¾è®¡](#32-æ•°æ®æµè®¾è®¡)
- [3.3 å­˜å‚¨è®¾è®¡](#33-å­˜å‚¨è®¾è®¡)
- [4.1 åŸºç¡€è¡¨ç»“æ„è®¾è®¡](#41-åŸºç¡€è¡¨ç»“æ„è®¾è®¡)
- [4.2 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ](#42-ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ)
- [4.3 æƒé™ä¸RLSå®ç°](#43-æƒé™ä¸rlså®ç°)
- [4.4 å…¨æ–‡æœç´¢å®ç°](#44-å…¨æ–‡æœç´¢å®ç°)
- [4.5 æ ‡ç­¾ç³»ç»Ÿå®ç°](#45-æ ‡ç­¾ç³»ç»Ÿå®ç°)
- [4.6 å·¥ä½œæµå®ç°](#46-å·¥ä½œæµå®ç°)
- [5.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#51-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
- [5.2 å¼‚æ­¥I/Oä¼˜åŒ–](#52-å¼‚æ­¥ioä¼˜åŒ–)
- [5.3 JSONBæ€§èƒ½æå‡](#53-jsonbæ€§èƒ½æå‡)
- [6.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”](#61-å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”)
- [6.2 ç´¢å¼•ç­–ç•¥å¯¹æ¯”](#62-ç´¢å¼•ç­–ç•¥å¯¹æ¯”)
- [6.3 ç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”](#63-ç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”)
- [7.1 åšå®¢ç³»ç»Ÿå®ç°](#71-åšå®¢ç³»ç»Ÿå®ç°)
- [7.2 æ–°é—»ç½‘ç«™å®ç°](#72-æ–°é—»ç½‘ç«™å®ç°)
- [7.3 çŸ¥è¯†åº“ç³»ç»Ÿå®ç°](#73-çŸ¥è¯†åº“ç³»ç»Ÿå®ç°)
- [8.1 æŸ¥è¯¢ä¼˜åŒ–](#81-æŸ¥è¯¢ä¼˜åŒ–)
- [8.2 å†™å…¥ä¼˜åŒ–](#82-å†™å…¥ä¼˜åŒ–)
- [8.3 ç¼“å­˜ä¼˜åŒ–](#83-ç¼“å­˜ä¼˜åŒ–)
- [8.4 åˆ†åŒºä¼˜åŒ–](#84-åˆ†åŒºä¼˜åŒ–)
- [9.1 å…³é”®æŒ‡æ ‡](#91-å…³é”®æŒ‡æ ‡)
- [9.2 ç›‘æ§æ–¹æ¡ˆ](#92-ç›‘æ§æ–¹æ¡ˆ)
- [9.3 éªŒè¯æ–¹æ³•](#93-éªŒè¯æ–¹æ³•)
- [10.1 è®¾è®¡æœ€ä½³å®è·µ](#101-è®¾è®¡æœ€ä½³å®è·µ)
- [10.2 å¼€å‘æœ€ä½³å®è·µ](#102-å¼€å‘æœ€ä½³å®è·µ)
- [11.1 å®˜æ–¹æ–‡æ¡£](#111-å®˜æ–¹æ–‡æ¡£)
- [11.2 ç½‘ç»œèµ„æº](#112-ç½‘ç»œèµ„æº)
- [11.3 ç›¸å…³æ–‡æ¡£](#113-ç›¸å…³æ–‡æ¡£)
- [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
- [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
---

## ä¸€ã€æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

å†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰æ˜¯ç°ä»£Webåº”ç”¨çš„æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºåˆ›å»ºã€ç¼–è¾‘ã€ç®¡ç†å’Œå‘å¸ƒæ•°å­—å†…å®¹ã€‚å…¸å‹çš„CMSç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- **å†…å®¹ç®¡ç†**ï¼šæ–‡ç« ã€é¡µé¢ã€åª’ä½“æ–‡ä»¶çš„ç®¡ç†
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå†…å®¹çš„å†å²ç‰ˆæœ¬å’Œå›æ»šåŠŸèƒ½
- **æƒé™ç®¡ç†**ï¼šå¤šè§’è‰²ã€å¤šæƒé™çš„è®¿é—®æ§åˆ¶
- **å…¨æ–‡æœç´¢**ï¼šå¿«é€Ÿçš„å†…å®¹æ£€ç´¢åŠŸèƒ½
- **å·¥ä½œæµ**ï¼šå†…å®¹ä»è‰ç¨¿åˆ°å‘å¸ƒçš„å®Œæ•´æµç¨‹
- **åˆ†ç±»æ ‡ç­¾**ï¼šå†…å®¹çš„ç»„ç»‡å’Œåˆ†ç±»

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

**CMSç³»ç»Ÿé¢ä¸´çš„ä¸»è¦æŠ€æœ¯æŒ‘æˆ˜**ï¼š

1. **é«˜å¹¶å‘è¯»å†™**ï¼šå¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®å’Œç¼–è¾‘å†…å®¹
2. **å¤æ‚æŸ¥è¯¢**ï¼šå…¨æ–‡æœç´¢ã€æ ‡ç­¾è¿‡æ»¤ã€åˆ†ç±»æŸ¥è¯¢
3. **ç‰ˆæœ¬ç®¡ç†**ï¼šå†å²ç‰ˆæœ¬å­˜å‚¨å’Œå¿«é€Ÿå›æ»š
4. **æƒé™æ§åˆ¶**ï¼šç»†ç²’åº¦çš„è¡Œçº§æƒé™æ§åˆ¶
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¿«é€Ÿçš„å†…å®¹æ£€ç´¢å’Œåˆ—è¡¨å±•ç¤º
6. **æ•°æ®ä¸€è‡´æ€§**ï¼šå¤šç”¨æˆ·ç¼–è¾‘æ—¶çš„æ•°æ®ä¸€è‡´æ€§

### 1.3 PostgreSQLä¼˜åŠ¿

**PostgreSQLåœ¨CMSç³»ç»Ÿä¸­çš„ä¼˜åŠ¿**ï¼š

- âœ… **JSONBæ”¯æŒ**ï¼šçµæ´»å­˜å‚¨å†…å®¹å…ƒæ•°æ®å’Œé…ç½®
- âœ… **å…¨æ–‡æœç´¢**ï¼šå†…ç½®å…¨æ–‡æœç´¢åŠŸèƒ½ï¼Œæ— éœ€å¤–éƒ¨æœç´¢å¼•æ“
- âœ… **RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰**ï¼šç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- âœ… **æ•°ç»„å’Œæ ‡ç­¾**ï¼šåŸç”Ÿæ”¯æŒæ•°ç»„ç±»å‹ï¼Œé€‚åˆæ ‡ç­¾ç³»ç»Ÿ
- âœ… **ç‰©åŒ–è§†å›¾**ï¼šé«˜æ€§èƒ½çš„å†…å®¹åˆ—è¡¨ç¼“å­˜
- âœ… **åˆ†åŒºè¡¨**ï¼šå¤§è¡¨åˆ†åŒºï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- âœ… **PostgreSQL 18æ–°ç‰¹æ€§**ï¼šè™šæ‹Ÿç”Ÿæˆåˆ—ã€å¼‚æ­¥I/Oç­‰

### 1.4 ç‰ˆæœ¬è¦æ±‚

- **PostgreSQL 18.x**ï¼šæ¨èï¼Œæ”¯æŒè™šæ‹Ÿç”Ÿæˆåˆ—ã€å¼‚æ­¥I/O
- **PostgreSQL 17.x**ï¼šæ¨èï¼ŒåŠŸèƒ½å®Œæ•´
- **PostgreSQL 16.x**ï¼šå…¼å®¹ï¼ŒåŸºç¡€åŠŸèƒ½æ”¯æŒ

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µ

### 2.1 CMSæ ¸å¿ƒåŠŸèƒ½

**CMSç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—**ï¼š

1. **å†…å®¹ç®¡ç†**ï¼šåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤å†…å®¹
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¿å­˜å†å²ç‰ˆæœ¬ï¼Œæ”¯æŒå›æ»š
3. **æƒé™ç®¡ç†**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
4. **å…¨æ–‡æœç´¢**ï¼šå¿«é€Ÿæ£€ç´¢å†…å®¹
5. **åˆ†ç±»æ ‡ç­¾**ï¼šå†…å®¹ç»„ç»‡å’Œåˆ†ç±»
6. **å·¥ä½œæµ**ï¼šå†…å®¹å‘å¸ƒæµç¨‹ç®¡ç†
7. **åª’ä½“ç®¡ç†**ï¼šå›¾ç‰‡ã€è§†é¢‘ç­‰åª’ä½“æ–‡ä»¶ç®¡ç†

### 2.2 æ•°æ®æ¨¡å‹è®¾è®¡

**æ ¸å¿ƒæ•°æ®æ¨¡å‹**ï¼š

- **ç”¨æˆ·è¡¨ï¼ˆusersï¼‰**ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- **è§’è‰²è¡¨ï¼ˆrolesï¼‰**ï¼šè§’è‰²å®šä¹‰
- **å†…å®¹è¡¨ï¼ˆcontentsï¼‰**ï¼šå†…å®¹ä¸»è¡¨
- **ç‰ˆæœ¬è¡¨ï¼ˆcontent_versionsï¼‰**ï¼šå†…å®¹ç‰ˆæœ¬å†å²
- **åˆ†ç±»è¡¨ï¼ˆcategoriesï¼‰**ï¼šå†…å®¹åˆ†ç±»
- **æ ‡ç­¾è¡¨ï¼ˆtagsï¼‰**ï¼šæ ‡ç­¾å®šä¹‰
- **å†…å®¹æ ‡ç­¾å…³è”è¡¨ï¼ˆcontent_tagsï¼‰**ï¼šå†…å®¹ä¸æ ‡ç­¾çš„å¤šå¯¹å¤šå…³ç³»
- **åª’ä½“è¡¨ï¼ˆmediaï¼‰**ï¼šåª’ä½“æ–‡ä»¶ä¿¡æ¯

### 2.3 æƒé™æ§åˆ¶æ¨¡å‹

**æƒé™æ§åˆ¶å±‚æ¬¡**ï¼š

1. **æ•°æ®åº“çº§æƒé™**ï¼šç”¨æˆ·å’Œè§’è‰²æƒé™
2. **è¡¨çº§æƒé™**ï¼šè¡¨çš„è¯»å†™æƒé™
3. **è¡Œçº§æƒé™ï¼ˆRLSï¼‰**ï¼šåŸºäºè¡Œçš„è®¿é—®æ§åˆ¶
4. **åˆ—çº§æƒé™**ï¼šæ•æ„Ÿå­—æ®µçš„è®¿é—®æ§åˆ¶

### 2.4 æ€ç»´å¯¼å›¾

```mermaid
graph TD
    A[CMSç³»ç»Ÿ] --> B[å†…å®¹ç®¡ç†]
    A --> C[ç‰ˆæœ¬æ§åˆ¶]
    A --> D[æƒé™ç®¡ç†]
    A --> E[å…¨æ–‡æœç´¢]
    A --> F[åˆ†ç±»æ ‡ç­¾]
    A --> G[å·¥ä½œæµ]

    B --> B1[åˆ›å»ºå†…å®¹]
    B --> B2[ç¼–è¾‘å†…å®¹]
    B --> B3[åˆ é™¤å†…å®¹]
    B --> B4[å‘å¸ƒå†…å®¹]

    C --> C1[ç‰ˆæœ¬å†å²]
    C --> C2[ç‰ˆæœ¬å¯¹æ¯”]
    C --> C3[ç‰ˆæœ¬å›æ»š]

    D --> D1[ç”¨æˆ·è§’è‰²]
    D --> D2[RLSç­–ç•¥]
    D --> D3[æƒé™ç»§æ‰¿]

    E --> E1[å…¨æ–‡ç´¢å¼•]
    E --> E2[æœç´¢æ’å]
    E --> E3[é«˜äº®æ˜¾ç¤º]

    F --> F1[åˆ†ç±»æ ‘]
    F --> F2[æ ‡ç­¾äº‘]
    F --> F3[æ ‡ç­¾å…³è”]

    G --> G1[è‰ç¨¿]
    G --> G2[å®¡æ ¸]
    G --> G3[å‘å¸ƒ]
    G --> G4[å½’æ¡£]
```

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æ¶æ„è®¾è®¡

```mermaid
graph TB
    A[åº”ç”¨å±‚] --> B[APIå±‚]
    B --> C[ä¸šåŠ¡é€»è¾‘å±‚]
    C --> D[æ•°æ®è®¿é—®å±‚]
    D --> E[PostgreSQLæ•°æ®åº“]

    E --> E1[å†…å®¹è¡¨]
    E --> E2[ç‰ˆæœ¬è¡¨]
    E --> E3[ç”¨æˆ·è¡¨]
    E --> E4[æƒé™è¡¨]

    C --> C1[å…¨æ–‡æœç´¢æœåŠ¡]
    C --> C2[ç¼“å­˜æœåŠ¡]
    C --> C3[æ–‡ä»¶å­˜å‚¨æœåŠ¡]

    C1 --> E
    C2 --> F[Redisç¼“å­˜]
    C3 --> G[å¯¹è±¡å­˜å‚¨]
```

### 3.2 æ•°æ®æµè®¾è®¡

**å†…å®¹åˆ›å»ºæµç¨‹**ï¼š

1. ç”¨æˆ·åˆ›å»ºå†…å®¹ â†’ ä¿å­˜åˆ°å†…å®¹è¡¨
2. è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ â†’ ä¿å­˜åˆ°ç‰ˆæœ¬è¡¨
3. æ›´æ–°å…¨æ–‡ç´¢å¼• â†’ æ›´æ–°æœç´¢ç´¢å¼•
4. æ›´æ–°æ ‡ç­¾å…³è” â†’ æ›´æ–°æ ‡ç­¾è¡¨
5. åˆ·æ–°ç¼“å­˜ â†’ æ›´æ–°åº”ç”¨ç¼“å­˜

**å†…å®¹å‘å¸ƒæµç¨‹**ï¼š

1. å†…å®¹çŠ¶æ€å˜æ›´ â†’ è‰ç¨¿ â†’ å®¡æ ¸ â†’ å‘å¸ƒ
2. è§¦å‘å·¥ä½œæµ â†’ é€šçŸ¥ç›¸å…³äººå‘˜
3. åˆ·æ–°ç‰©åŒ–è§†å›¾ â†’ æ›´æ–°å†…å®¹åˆ—è¡¨
4. æ›´æ–°æœç´¢å¼•æ“ â†’ ç´¢å¼•æ–°å†…å®¹

### 3.3 å­˜å‚¨è®¾è®¡

**å­˜å‚¨ç­–ç•¥**ï¼š

- **çƒ­æ•°æ®**ï¼šå½“å‰å†…å®¹å­˜å‚¨åœ¨å†…å®¹è¡¨
- **å†å²æ•°æ®**ï¼šæ—§ç‰ˆæœ¬å­˜å‚¨åœ¨ç‰ˆæœ¬è¡¨
- **å½’æ¡£æ•°æ®**ï¼šè¶…è¿‡ä¸€å®šæ—¶é—´çš„å†…å®¹åˆ†åŒºå­˜å‚¨
- **åª’ä½“æ–‡ä»¶**ï¼šå­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ï¼Œæ•°æ®åº“åªå­˜å‚¨å…ƒæ•°æ®

---

## å››ã€å®ç°æ–¹æ¡ˆ

### 4.1 åŸºç¡€è¡¨ç»“æ„è®¾è®¡

**ç”¨æˆ·å’Œè§’è‰²è¡¨**ï¼š

```sql
-- ç”¨æˆ·å’Œè§’è‰²è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
-- 1. è§’è‰²è¡¨ï¼ˆå¿…é¡»å…ˆåˆ›å»ºï¼Œå› ä¸ºusersè¡¨å¼•ç”¨å®ƒï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'roles') THEN
        DROP TABLE roles CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: roles';
    END IF;

    CREATE TABLE roles (
        id SERIAL PRIMARY KEY,
        name VARCHAR(50) UNIQUE NOT NULL,
        description TEXT,
        permissions JSONB DEFAULT '{}'::jsonb,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );

    RAISE NOTICE 'è§’è‰²è¡¨åˆ›å»ºæˆåŠŸ: roles';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨roleså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§’è‰²è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- 2. æ’å…¥é»˜è®¤è§’è‰²ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
    IF EXISTS (SELECT 1 FROM roles WHERE name IN ('admin', 'editor', 'author', 'viewer')) THEN
        RAISE NOTICE 'é»˜è®¤è§’è‰²å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
    ELSE
        INSERT INTO roles (name, description, permissions) VALUES
        ('admin', 'ç®¡ç†å‘˜', '{"create": true, "edit": true, "delete": true, "publish": true}'::jsonb),
        ('editor', 'ç¼–è¾‘', '{"create": true, "edit": true, "delete": false, "publish": true}'::jsonb),
        ('author', 'ä½œè€…', '{"create": true, "edit": true, "delete": false, "publish": false}'::jsonb),
        ('viewer', 'æŸ¥çœ‹è€…', '{"create": false, "edit": false, "delete": false, "publish": false}'::jsonb);
        RAISE NOTICE 'é»˜è®¤è§’è‰²æ’å…¥æˆåŠŸ';
    END IF;
EXCEPTION
    WHEN unique_violation THEN
        RAISE WARNING 'è§’è‰²å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥é»˜è®¤è§’è‰²å¤±è´¥: %', SQLERRM;
END $$;

-- 3. ç”¨æˆ·è¡¨
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        DROP TABLE users CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: users';
    END IF;

    -- æ£€æŸ¥rolesè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'roles') THEN
        RAISE EXCEPTION 'rolesè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        display_name VARCHAR(100),
        avatar_url TEXT,
        role_id INTEGER NOT NULL REFERENCES roles(id),
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    RAISE NOTICE 'ç”¨æˆ·è¡¨åˆ›å»ºæˆåŠŸ: users';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'rolesè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨userså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç”¨æˆ·è¡¨å¤±è´¥: %', SQLERRM;
END $$;
```

**å†…å®¹è¡¨è®¾è®¡**ï¼š

```sql
-- å†…å®¹ä¸»è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        DROP TABLE contents CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: contents';
    END IF;

    -- æ£€æŸ¥usersè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE contents (
        id BIGSERIAL PRIMARY KEY,
        title TEXT NOT NULL,
        slug VARCHAR(255) UNIQUE NOT NULL,
        body TEXT NOT NULL,
        excerpt TEXT,
        author_id BIGINT NOT NULL REFERENCES users(id),
        category_id INTEGER,
        status VARCHAR(20) NOT NULL DEFAULT 'draft'
            CHECK (status IN ('draft', 'review', 'published', 'archived')),
        published_at TIMESTAMPTZ,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW(),
        view_count INTEGER DEFAULT 0,
        like_count INTEGER DEFAULT 0,
        -- å…ƒæ•°æ®ï¼ˆJSONBï¼‰
        metadata JSONB DEFAULT '{}'::jsonb,
        -- æ ‡ç­¾æ•°ç»„
        tags TEXT[] DEFAULT '{}',
        -- PostgreSQL 18: è™šæ‹Ÿç”Ÿæˆåˆ—ç”¨äºå…¨æ–‡æœç´¢
        search_vector tsvector GENERATED ALWAYS AS (
            to_tsvector('simple', coalesce(title, '') || ' ' || coalesce(body, ''))
        ) STORED
    );

    RAISE NOTICE 'å†…å®¹è¡¨åˆ›å»ºæˆåŠŸ: contents';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨contentså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå†…å®¹è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- author_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_author') THEN
        CREATE INDEX idx_contents_author ON contents(author_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_author';
    END IF;

    -- statusç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_status') THEN
        CREATE INDEX idx_contents_status ON contents(status);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_status';
    END IF;

    -- published_atç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_published_at') THEN
        CREATE INDEX idx_contents_published_at ON contents(published_at DESC);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_published_at';
    END IF;

    -- tags GINç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_tags_gin') THEN
        CREATE INDEX idx_contents_tags_gin ON contents USING GIN (tags);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_tags_gin';
    END IF;

    -- search_vector GINç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_search_vector') THEN
        CREATE INDEX idx_contents_search_vector ON contents USING GIN (search_vector);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_search_vector';
    END IF;

    -- metadata GINç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_metadata_gin') THEN
        CREATE INDEX idx_contents_metadata_gin ON contents USING GIN (metadata);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_metadata_gin';
    END IF;

    -- slugç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'contents' AND indexname = 'idx_contents_slug') THEN
        CREATE INDEX idx_contents_slug ON contents(slug);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_contents_slug';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

**åˆ†ç±»è¡¨è®¾è®¡**ï¼š

```sql
-- åˆ†ç±»è¡¨ï¼ˆæ”¯æŒæ ‘å½¢ç»“æ„ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'categories') THEN
        DROP TABLE categories CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: categories';
    END IF;

    CREATE TABLE categories (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        slug VARCHAR(100) UNIQUE NOT NULL,
        description TEXT,
        parent_id INTEGER REFERENCES categories(id),
        sort_order INTEGER DEFAULT 0,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );

    RAISE NOTICE 'åˆ†ç±»è¡¨åˆ›å»ºæˆåŠŸ: categories';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨categorieså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†ç±»è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- parent_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'categories' AND indexname = 'idx_categories_parent') THEN
        CREATE INDEX idx_categories_parent ON categories(parent_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_categories_parent';
    END IF;

    -- slugç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'categories' AND indexname = 'idx_categories_slug') THEN
        CREATE INDEX idx_categories_slug ON categories(slug);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_categories_slug';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'categoriesè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 4.2 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

**ç‰ˆæœ¬è¡¨è®¾è®¡**ï¼š

```sql
-- å†…å®¹ç‰ˆæœ¬è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'content_versions') THEN
        DROP TABLE content_versions CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: content_versions';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE content_versions (
        id BIGSERIAL PRIMARY KEY,
        content_id BIGINT NOT NULL REFERENCES contents(id) ON DELETE CASCADE,
        version_number INTEGER NOT NULL CHECK (version_number > 0),
        title TEXT NOT NULL,
        body TEXT NOT NULL,
        excerpt TEXT,
        author_id BIGINT NOT NULL REFERENCES users(id),
        created_at TIMESTAMPTZ DEFAULT NOW(),
        change_summary TEXT,
        -- ç¡®ä¿ç‰ˆæœ¬å·å”¯ä¸€
        UNIQUE(content_id, version_number)
    );

    RAISE NOTICE 'å†…å®¹ç‰ˆæœ¬è¡¨åˆ›å»ºæˆåŠŸ: content_versions';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–usersè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨content_versionså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå†…å®¹ç‰ˆæœ¬è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- content_idå’Œversion_numberå¤åˆç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'content_versions' AND indexname = 'idx_content_versions_content') THEN
        CREATE INDEX idx_content_versions_content ON content_versions(content_id, version_number DESC);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_content_versions_content';
    END IF;

    -- author_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'content_versions' AND indexname = 'idx_content_versions_author') THEN
        CREATE INDEX idx_content_versions_author ON content_versions(author_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_content_versions_author';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'content_versionsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- ç‰ˆæœ¬ç®¡ç†å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION create_content_version(
    p_content_id BIGINT,
    p_change_summary TEXT DEFAULT NULL
)
RETURNS INTEGER AS $$
DECLARE
    v_version_number INTEGER;
    v_content RECORD;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_content_id IS NULL OR p_content_id <= 0 THEN
        RAISE EXCEPTION 'å†…å®¹IDæ— æ•ˆ: %', p_content_id;
    END IF;

    -- æ£€æŸ¥contentsè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    END IF;

    -- æ£€æŸ¥content_versionsè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'content_versions') THEN
        RAISE EXCEPTION 'content_versionsè¡¨ä¸å­˜åœ¨';
    END IF;

    -- è·å–å†…å®¹å½“å‰çŠ¶æ€
    BEGIN
        SELECT * INTO v_content
        FROM contents
        WHERE id = p_content_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'å†…å®¹ä¸å­˜åœ¨: %', p_content_id;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æŸ¥è¯¢å†…å®¹å¤±è´¥: %', SQLERRM;
    END;

    -- è·å–å½“å‰æœ€å¤§ç‰ˆæœ¬å·
    BEGIN
        SELECT COALESCE(MAX(version_number), 0) + 1
        INTO v_version_number
        FROM content_versions
        WHERE content_id = p_content_id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'è·å–ç‰ˆæœ¬å·å¤±è´¥: %', SQLERRM;
    END;

    -- åˆ›å»ºæ–°ç‰ˆæœ¬
    BEGIN
        INSERT INTO content_versions (
            content_id, version_number, title, body, excerpt,
            author_id, change_summary
        ) VALUES (
            p_content_id, v_version_number, v_content.title,
            v_content.body, v_content.excerpt, v_content.author_id,
            p_change_summary
        );
    EXCEPTION
        WHEN unique_violation THEN
            RAISE EXCEPTION 'ç‰ˆæœ¬å·å†²çª: content_id=%, version_number=%', p_content_id, v_version_number;
        WHEN foreign_key_violation THEN
            RAISE EXCEPTION 'å¤–é”®çº¦æŸè¿å: è¯·æ£€æŸ¥content_idæˆ–author_idæ˜¯å¦å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
    END;

    RETURN v_version_number;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'create_content_versionå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- ç‰ˆæœ¬å›æ»šå‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION rollback_content_version(
    p_content_id BIGINT,
    p_version_number INTEGER
)
RETURNS BOOLEAN AS $$
DECLARE
    v_version RECORD;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_content_id IS NULL OR p_content_id <= 0 THEN
        RAISE EXCEPTION 'å†…å®¹IDæ— æ•ˆ: %', p_content_id;
    END IF;

    IF p_version_number IS NULL OR p_version_number <= 0 THEN
        RAISE EXCEPTION 'ç‰ˆæœ¬å·æ— æ•ˆ: %', p_version_number;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'content_versions') THEN
        RAISE EXCEPTION 'content_versionsè¡¨ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    END IF;

    -- è·å–æŒ‡å®šç‰ˆæœ¬
    BEGIN
        SELECT * INTO v_version
        FROM content_versions
        WHERE content_id = p_content_id
          AND version_number = p_version_number;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'ç‰ˆæœ¬ä¸å­˜åœ¨: content_id=%, version_number=%', p_content_id, p_version_number;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'content_versionsè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æŸ¥è¯¢ç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
    END;

    -- åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½
    BEGIN
        PERFORM create_content_version(p_content_id, 'Rollback to version ' || p_version_number);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤‡ä»½ç‰ˆæœ¬å¤±è´¥: %ï¼Œç»§ç»­æ‰§è¡Œå›æ»š', SQLERRM;
    END;

    -- æ¢å¤å†…å®¹
    BEGIN
        UPDATE contents
        SET title = v_version.title,
            body = v_version.body,
            excerpt = v_version.excerpt,
            updated_at = NOW()
        WHERE id = p_content_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'å†…å®¹ä¸å­˜åœ¨: %', p_content_id;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ¢å¤å†…å®¹å¤±è´¥: %', SQLERRM;
    END;

    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'rollback_content_versionå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

**è‡ªåŠ¨ç‰ˆæœ¬åˆ›å»ºè§¦å‘å™¨**ï¼š

```sql
-- å†…å®¹æ›´æ–°æ—¶è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION trigger_create_content_version()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æŸ¥NEWå’ŒOLDè®°å½•
    IF NEW IS NULL OR OLD IS NULL THEN
        RAISE EXCEPTION 'è§¦å‘å™¨è®°å½•ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥create_content_versionå‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'create_content_version') THEN
        RAISE EXCEPTION 'create_content_versionå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    -- åªæœ‰åœ¨å†…å®¹å®é™…å˜æ›´æ—¶æ‰åˆ›å»ºç‰ˆæœ¬
    IF OLD.title IS DISTINCT FROM NEW.title OR
       OLD.body IS DISTINCT FROM NEW.body OR
       OLD.excerpt IS DISTINCT FROM NEW.excerpt THEN
        BEGIN
            PERFORM create_content_version(NEW.id, 'Auto-saved version');
        EXCEPTION
            WHEN OTHERS THEN
                -- ç‰ˆæœ¬åˆ›å»ºå¤±è´¥ä¸åº”è¯¥é˜»æ­¢å†…å®¹æ›´æ–°ï¼Œè®°å½•è­¦å‘Š
                RAISE WARNING 'è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
        END;
    END IF;

    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- è®°å½•é”™è¯¯ä½†å…è®¸æ›´æ–°ç»§ç»­
        RAISE WARNING 'trigger_create_content_versionå¤±è´¥: %', SQLERRM;
        RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- åˆ é™¤ç°æœ‰è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'trg_content_version') THEN
        DROP TRIGGER trg_content_version ON contents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨: trg_content_version';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
    END IF;

    -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'trigger_create_content_version') THEN
        RAISE EXCEPTION 'trigger_create_content_versionå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    CREATE TRIGGER trg_content_version
    AFTER UPDATE ON contents
    FOR EACH ROW
    EXECUTE FUNCTION trigger_create_content_version();

    RAISE NOTICE 'è§¦å‘å™¨åˆ›å»ºæˆåŠŸ: trg_content_version';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'trigger_create_content_versionå‡½æ•°ä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'è§¦å‘å™¨å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
END $$;
```

### 4.3 æƒé™ä¸RLSå®ç°

**å¯ç”¨RLS**ï¼š

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        ALTER TABLE contents ENABLE ROW LEVEL SECURITY;
        RAISE NOTICE 'RLSå·²å¯ç”¨: contents';
    ELSE
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•å¯ç”¨RLS';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¯ç”¨RLSå¤±è´¥: %', SQLERRM;
END $$;

-- RLSç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„å†…å®¹æˆ–å·²å‘å¸ƒçš„å†…å®¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'contents' AND policyname = 'content_select_policy') THEN
        DROP POLICY content_select_policy ON contents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: content_select_policy';
    END IF;

    CREATE POLICY content_select_policy ON contents
        FOR SELECT
        USING (
            author_id = current_setting('app.user_id', true)::BIGINT
            OR status = 'published'
            OR EXISTS (
                SELECT 1 FROM users
                WHERE id = current_setting('app.user_id', true)::BIGINT
                  AND role_id IN (SELECT id FROM roles WHERE name IN ('admin', 'editor'))
            )
        );

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: content_select_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–usersè¡¨æˆ–rolesè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºSELECTç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- RLSç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºå†…å®¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'contents' AND policyname = 'content_insert_policy') THEN
        DROP POLICY content_insert_policy ON contents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: content_insert_policy';
    END IF;

    CREATE POLICY content_insert_policy ON contents
        FOR INSERT
        WITH CHECK (
            author_id = current_setting('app.user_id', true)::BIGINT
        );

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: content_insert_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºINSERTç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- RLSç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„å†…å®¹ï¼Œç¼–è¾‘å’Œç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘æ‰€æœ‰å†…å®¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'contents' AND policyname = 'content_update_policy') THEN
        DROP POLICY content_update_policy ON contents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: content_update_policy';
    END IF;

    CREATE POLICY content_update_policy ON contents
        FOR UPDATE
        USING (
            author_id = current_setting('app.user_id', true)::BIGINT
            OR EXISTS (
                SELECT 1 FROM users
                WHERE id = current_setting('app.user_id', true)::BIGINT
                  AND role_id IN (SELECT id FROM roles WHERE name IN ('admin', 'editor'))
            )
        );

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: content_update_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–usersè¡¨æˆ–rolesè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºUPDATEç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;

-- RLSç­–ç•¥ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å†…å®¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname = 'public' AND tablename = 'contents' AND policyname = 'content_delete_policy') THEN
        DROP POLICY content_delete_policy ON contents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç­–ç•¥: content_delete_policy';
    END IF;

    CREATE POLICY content_delete_policy ON contents
        FOR DELETE
        USING (
            EXISTS (
                SELECT 1 FROM users
                WHERE id = current_setting('app.user_id', true)::BIGINT
                  AND role_id = (SELECT id FROM roles WHERE name = 'admin')
            )
        );

    RAISE NOTICE 'ç­–ç•¥åˆ›å»ºæˆåŠŸ: content_delete_policy';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–usersè¡¨æˆ–rolesè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºDELETEç­–ç•¥å¤±è´¥: %', SQLERRM;
END $$;
```

**æƒé™æ£€æŸ¥å‡½æ•°**ï¼š

```sql
-- æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_user_permission(
    p_user_id BIGINT,
    p_permission TEXT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_permissions JSONB;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_user_id IS NULL OR p_user_id <= 0 THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDæ— æ•ˆ: %', p_user_id;
    END IF;

    IF p_permission IS NULL OR length(trim(p_permission)) = 0 THEN
        RAISE EXCEPTION 'æƒé™åç§°ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'roles') THEN
        RAISE EXCEPTION 'rolesè¡¨ä¸å­˜åœ¨';
    END IF;

    -- æŸ¥è¯¢ç”¨æˆ·æƒé™
    BEGIN
        SELECT r.permissions INTO v_permissions
        FROM users u
        JOIN roles r ON r.id = u.role_id
        WHERE u.id = p_user_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'ç”¨æˆ·ä¸å­˜åœ¨: %', p_user_id;
        END IF;

        IF v_permissions IS NULL THEN
            RETURN FALSE;
        END IF;

        -- æ£€æŸ¥æƒé™
        RETURN COALESCE((v_permissions->>p_permission)::BOOLEAN, FALSE);
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'usersè¡¨æˆ–rolesè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æŸ¥è¯¢ç”¨æˆ·æƒé™å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'check_user_permissionå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 4.4 å…¨æ–‡æœç´¢å®ç°

**å…¨æ–‡æœç´¢æŸ¥è¯¢**ï¼š

```sql
-- åŸºç¡€å…¨æ–‡æœç´¢
SELECT
    id,
    title,
    excerpt,
    published_at,
    ts_rank(search_vector, plainto_tsquery('simple', $1)) AS rank
FROM contents
WHERE search_vector @@ plainto_tsquery('simple', $1)
  AND status = 'published'
ORDER BY rank DESC, published_at DESC
LIMIT 20;

-- é«˜çº§å…¨æ–‡æœç´¢ï¼ˆæ”¯æŒé«˜äº®ï¼‰
SELECT
    id,
    title,
    ts_headline('simple', body, plainto_tsquery('simple', $1)) AS highlighted_body,
    ts_rank(search_vector, plainto_tsquery('simple', $1)) AS rank
FROM contents
WHERE search_vector @@ plainto_tsquery('simple', $1)
  AND status = 'published'
ORDER BY rank DESC
LIMIT 10;

-- å¤šå­—æ®µæœç´¢
SELECT
    id,
    title,
    excerpt,
    ts_rank_cd(
        search_vector,
        plainto_tsquery('simple', $1),
        32
    ) AS rank
FROM contents
WHERE search_vector @@ plainto_tsquery('simple', $1)
  AND status = 'published'
  AND (category_id = $2 OR $2 IS NULL)
ORDER BY rank DESC, published_at DESC
LIMIT 20;
```

**æœç´¢ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºæœç´¢ä¼˜åŒ–å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION search_contents(
    p_query TEXT,
    p_category_id INTEGER DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_limit INTEGER DEFAULT 20,
    p_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    id BIGINT,
    title TEXT,
    excerpt TEXT,
    published_at TIMESTAMPTZ,
    rank REAL
) AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_query IS NULL OR length(trim(p_query)) = 0 THEN
        RAISE EXCEPTION 'æœç´¢æŸ¥è¯¢ä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_limit IS NULL OR p_limit <= 0 OR p_limit > 1000 THEN
        RAISE EXCEPTION 'limitå‚æ•°æ— æ•ˆ: % (å¿…é¡»åœ¨1-1000ä¹‹é—´)', p_limit;
    END IF;

    IF p_offset IS NULL OR p_offset < 0 THEN
        RAISE EXCEPTION 'offsetå‚æ•°æ— æ•ˆ: % (å¿…é¡» >= 0)', p_offset;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    END IF;

    -- æ‰§è¡Œæœç´¢
    BEGIN
        RETURN QUERY
        SELECT
            c.id,
            c.title,
            c.excerpt,
            c.published_at,
            ts_rank_cd(c.search_vector, plainto_tsquery('simple', p_query), 32) AS rank
        FROM contents c
        WHERE c.search_vector @@ plainto_tsquery('simple', p_query)
          AND c.status = 'published'
          AND (p_category_id IS NULL OR c.category_id = p_category_id)
          AND (p_tags IS NULL OR c.tags && p_tags)
        ORDER BY rank DESC, c.published_at DESC
        LIMIT p_limit
        OFFSET p_offset;
    EXCEPTION
        WHEN undefined_function THEN
            RAISE EXCEPTION 'å…¨æ–‡æœç´¢å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥PostgreSQLæ‰©å±•æ˜¯å¦æ­£ç¡®å®‰è£…';
        WHEN syntax_error THEN
            RAISE EXCEPTION 'æœç´¢æŸ¥è¯¢è¯­æ³•é”™è¯¯: %', p_query;
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æœç´¢å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'search_contentså¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 4.5 æ ‡ç­¾ç³»ç»Ÿå®ç°

**æ ‡ç­¾ç®¡ç†**ï¼š

```sql
-- æ ‡ç­¾è¡¨
-- æ ‡ç­¾è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tags') THEN
        DROP TABLE tags CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: tags';
    END IF;

    CREATE TABLE tags (
        id SERIAL PRIMARY KEY,
        name VARCHAR(50) UNIQUE NOT NULL,
        slug VARCHAR(50) UNIQUE NOT NULL,
        description TEXT,
        usage_count INTEGER DEFAULT 0 CHECK (usage_count >= 0),
        created_at TIMESTAMPTZ DEFAULT NOW()
    );

    RAISE NOTICE 'æ ‡ç­¾è¡¨åˆ›å»ºæˆåŠŸ: tags';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨tagså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ ‡ç­¾è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- å†…å®¹æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'content_tags') THEN
        DROP TABLE content_tags CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: content_tags';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tags') THEN
        RAISE EXCEPTION 'tagsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE content_tags (
        content_id BIGINT NOT NULL REFERENCES contents(id) ON DELETE CASCADE,
        tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
        PRIMARY KEY (content_id, tag_id)
    );

    RAISE NOTICE 'å†…å®¹æ ‡ç­¾å…³è”è¡¨åˆ›å»ºæˆåŠŸ: content_tags';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–tagsè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨content_tagså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå†…å®¹æ ‡ç­¾å…³è”è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- content_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'content_tags' AND indexname = 'idx_content_tags_content') THEN
        CREATE INDEX idx_content_tags_content ON content_tags(content_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_content_tags_content';
    END IF;

    -- tag_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'content_tags' AND indexname = 'idx_content_tags_tag') THEN
        CREATE INDEX idx_content_tags_tag ON content_tags(tag_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_content_tags_tag';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'content_tagsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ ‡ç­¾ä½¿ç”¨ç»Ÿè®¡æ›´æ–°å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_tag_usage_count()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æŸ¥tagsè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tags') THEN
        RAISE EXCEPTION 'tagsè¡¨ä¸å­˜åœ¨';
    END IF;

    BEGIN
        IF TG_OP = 'INSERT' THEN
            IF NEW.tag_id IS NULL THEN
                RAISE EXCEPTION 'tag_idä¸èƒ½ä¸ºç©º';
            END IF;

            UPDATE tags
            SET usage_count = usage_count + 1
            WHERE id = NEW.tag_id;

            IF NOT FOUND THEN
                RAISE EXCEPTION 'æ ‡ç­¾ä¸å­˜åœ¨: %', NEW.tag_id;
            END IF;

            RETURN NEW;
        ELSIF TG_OP = 'DELETE' THEN
            IF OLD.tag_id IS NULL THEN
                RAISE EXCEPTION 'tag_idä¸èƒ½ä¸ºç©º';
            END IF;

            UPDATE tags
            SET usage_count = GREATEST(usage_count - 1, 0)
            WHERE id = OLD.tag_id;

            -- DELETEæ“ä½œæ—¶ï¼Œå³ä½¿æ ‡ç­¾ä¸å­˜åœ¨ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸ç»§ç»­
            RETURN OLD;
        ELSE
            RAISE EXCEPTION 'ä¸æ”¯æŒçš„è§¦å‘å™¨æ“ä½œ: %', TG_OP;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'tagsè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°æ ‡ç­¾ä½¿ç”¨è®¡æ•°å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'update_tag_usage_countè§¦å‘å™¨å‡½æ•°å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- åˆ é™¤ç°æœ‰è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'trg_tag_usage_count') THEN
        DROP TRIGGER trg_tag_usage_count ON content_tags;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨: trg_tag_usage_count';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'content_tags') THEN
        RAISE EXCEPTION 'content_tagsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
    END IF;

    CREATE TRIGGER trg_tag_usage_count
    AFTER INSERT OR DELETE ON content_tags
    FOR EACH ROW
    EXECUTE FUNCTION update_tag_usage_count();

    RAISE NOTICE 'è§¦å‘å™¨åˆ›å»ºæˆåŠŸ: trg_tag_usage_count';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'content_tagsè¡¨ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'update_tag_usage_countå‡½æ•°ä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'è§¦å‘å™¨å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
END $$;
```

**æ ‡ç­¾æŸ¥è¯¢**ï¼š

```sql
-- è·å–çƒ­é—¨æ ‡ç­¾
SELECT
    t.id,
    t.name,
    t.slug,
    t.usage_count
FROM tags t
ORDER BY t.usage_count DESC
LIMIT 20;

-- æ ¹æ®æ ‡ç­¾è·å–å†…å®¹
SELECT
    c.id,
    c.title,
    c.excerpt,
    c.published_at
FROM contents c
JOIN content_tags ct ON ct.content_id = c.id
JOIN tags t ON t.id = ct.tag_id
WHERE t.slug = $1
  AND c.status = 'published'
ORDER BY c.published_at DESC
LIMIT 20;

-- æ ‡ç­¾äº‘æŸ¥è¯¢
SELECT
    t.name,
    t.slug,
    t.usage_count,
    CASE
        WHEN t.usage_count > 100 THEN 'large'
        WHEN t.usage_count > 50 THEN 'medium'
        ELSE 'small'
    END AS size_class
FROM tags t
WHERE t.usage_count > 0
ORDER BY t.usage_count DESC;
```

### 4.6 å·¥ä½œæµå®ç°

**å·¥ä½œæµçŠ¶æ€ç®¡ç†**ï¼š

```sql
-- å·¥ä½œæµæ—¥å¿—è¡¨
-- å·¥ä½œæµæ—¥å¿—è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'workflow_logs') THEN
        DROP TABLE workflow_logs CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: workflow_logs';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE workflow_logs (
        id BIGSERIAL PRIMARY KEY,
        content_id BIGINT NOT NULL REFERENCES contents(id) ON DELETE CASCADE,
        from_status VARCHAR(20) CHECK (from_status IN ('draft', 'review', 'published', 'archived')),
        to_status VARCHAR(20) NOT NULL CHECK (to_status IN ('draft', 'review', 'published', 'archived')),
        user_id BIGINT NOT NULL REFERENCES users(id),
        comment TEXT,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );

    RAISE NOTICE 'å·¥ä½œæµæ—¥å¿—è¡¨åˆ›å»ºæˆåŠŸ: workflow_logs';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'contentsè¡¨æˆ–usersè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨workflow_logså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå·¥ä½œæµæ—¥å¿—è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- content_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'workflow_logs' AND indexname = 'idx_workflow_logs_content') THEN
        CREATE INDEX idx_workflow_logs_content ON workflow_logs(content_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_workflow_logs_content';
    END IF;

    -- user_idç´¢å¼•
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'workflow_logs' AND indexname = 'idx_workflow_logs_user') THEN
        CREATE INDEX idx_workflow_logs_user ON workflow_logs(user_id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_workflow_logs_user';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'workflow_logsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN duplicate_object THEN
        RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- çŠ¶æ€å˜æ›´å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION change_content_status(
    p_content_id BIGINT,
    p_new_status VARCHAR(20),
    p_user_id BIGINT,
    p_comment TEXT DEFAULT NULL
)
RETURNS BOOLEAN AS $$
DECLARE
    v_old_status VARCHAR(20);
    v_role_name VARCHAR(50);
    v_allowed_statuses TEXT[] := ARRAY['draft', 'review', 'published', 'archived'];
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_content_id IS NULL OR p_content_id <= 0 THEN
        RAISE EXCEPTION 'å†…å®¹IDæ— æ•ˆ: %', p_content_id;
    END IF;

    IF p_new_status IS NULL OR length(trim(p_new_status)) = 0 THEN
        RAISE EXCEPTION 'æ–°çŠ¶æ€ä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_new_status != ALL(v_allowed_statuses) THEN
        RAISE EXCEPTION 'æ— æ•ˆçš„çŠ¶æ€å€¼: % (å…è®¸çš„çŠ¶æ€: %)', p_new_status, array_to_string(v_allowed_statuses, ', ');
    END IF;

    IF p_user_id IS NULL OR p_user_id <= 0 THEN
        RAISE EXCEPTION 'ç”¨æˆ·IDæ— æ•ˆ: %', p_user_id;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'contents') THEN
        RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'workflow_logs') THEN
        RAISE EXCEPTION 'workflow_logsè¡¨ä¸å­˜åœ¨';
    END IF;

    -- è·å–å½“å‰çŠ¶æ€
    BEGIN
        SELECT status INTO v_old_status
        FROM contents
        WHERE id = p_content_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'å†…å®¹ä¸å­˜åœ¨: %', p_content_id;
        END IF;

        IF v_old_status = p_new_status THEN
            RAISE NOTICE 'å†…å®¹çŠ¶æ€å·²ç»æ˜¯: %', p_new_status;
            RETURN TRUE;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'contentsè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æŸ¥è¯¢å†…å®¹çŠ¶æ€å¤±è´¥: %', SQLERRM;
    END;

    -- æ£€æŸ¥æƒé™
    BEGIN
        SELECT r.name INTO v_role_name
        FROM users u
        JOIN roles r ON r.id = u.role_id
        WHERE u.id = p_user_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'ç”¨æˆ·ä¸å­˜åœ¨: %', p_user_id;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'usersè¡¨æˆ–rolesè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æŸ¥è¯¢ç”¨æˆ·è§’è‰²å¤±è´¥: %', SQLERRM;
    END;

    -- çŠ¶æ€è½¬æ¢éªŒè¯
    IF p_new_status = 'published' AND v_role_name NOT IN ('admin', 'editor') THEN
        RAISE EXCEPTION 'åªæœ‰ç®¡ç†å‘˜æˆ–ç¼–è¾‘å¯ä»¥å‘å¸ƒå†…å®¹';
    END IF;

    -- æ›´æ–°çŠ¶æ€
    BEGIN
        UPDATE contents
        SET status = p_new_status,
            published_at = CASE WHEN p_new_status = 'published' AND published_at IS NULL
                                THEN NOW() ELSE published_at END,
            updated_at = NOW()
        WHERE id = p_content_id;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'æ›´æ–°å†…å®¹çŠ¶æ€å¤±è´¥: å†…å®¹ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN check_violation THEN
            RAISE EXCEPTION 'çŠ¶æ€å€¼ä¸ç¬¦åˆçº¦æŸæ¡ä»¶';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°å†…å®¹çŠ¶æ€å¤±è´¥: %', SQLERRM;
    END;

    -- è®°å½•å·¥ä½œæµæ—¥å¿—
    BEGIN
        INSERT INTO workflow_logs (
            content_id, from_status, to_status, user_id, comment
        ) VALUES (
            p_content_id, v_old_status, p_new_status, p_user_id, p_comment
        );
    EXCEPTION
        WHEN foreign_key_violation THEN
            RAISE EXCEPTION 'å¤–é”®çº¦æŸè¿å: è¯·æ£€æŸ¥content_idæˆ–user_idæ˜¯å¦å­˜åœ¨';
        WHEN check_violation THEN
            RAISE EXCEPTION 'çŠ¶æ€å€¼ä¸ç¬¦åˆçº¦æŸæ¡ä»¶';
        WHEN OTHERS THEN
            RAISE WARNING 'è®°å½•å·¥ä½œæµæ—¥å¿—å¤±è´¥: %ï¼Œä½†çŠ¶æ€å·²æ›´æ–°', SQLERRM;
    END;

    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'change_content_statuså¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## äº”ã€PostgreSQL 18ä¼˜åŒ–

### 5.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

**ä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–å…¨æ–‡æœç´¢**ï¼š

```sql
-- PostgreSQL 18: è™šæ‹Ÿç”Ÿæˆåˆ—è‡ªåŠ¨è®¡ç®—æœç´¢å‘é‡
CREATE TABLE contents_v2 (
    id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    body TEXT NOT NULL,
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æœç´¢å‘é‡
    search_vector tsvector GENERATED ALWAYS AS (
        to_tsvector('simple', coalesce(title, '') || ' ' || coalesce(body, ''))
    ) STORED,
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æ‘˜è¦
    excerpt TEXT GENERATED ALWAYS AS (
        substring(body, 1, 200)
    ) STORED
);

-- è‡ªåŠ¨ç´¢å¼•è™šæ‹Ÿç”Ÿæˆåˆ—
CREATE INDEX idx_contents_v2_search ON contents_v2 USING GIN (search_vector);
```

**æ€§èƒ½æå‡**ï¼š

- æœç´¢å‘é‡è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
- æŸ¥è¯¢æ€§èƒ½æå‡15-25%
- å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆSTOREDç±»å‹ï¼‰æˆ–æå‡å†™å…¥æ€§èƒ½ï¼ˆVIRTUALç±»å‹ï¼‰

### 5.2 å¼‚æ­¥I/Oä¼˜åŒ–

**å¯ç”¨å¼‚æ­¥I/O**ï¼š

```sql
-- PostgreSQL 18: åœ¨postgresql.confä¸­é…ç½®
-- io_uring = on  -- å¦‚æœç³»ç»Ÿæ”¯æŒio_uring
-- max_io_concurrency = 10  -- å¼‚æ­¥I/Oå¹¶å‘æ•°

-- å¤§æ–‡ä»¶å†…å®¹å†™å…¥è‡ªåŠ¨åˆ©ç”¨å¼‚æ­¥I/O
INSERT INTO contents (title, body, author_id)
VALUES ($1, $2, $3);
-- è‡ªåŠ¨ä½¿ç”¨å¼‚æ­¥I/Oæå‡å†™å…¥æ€§èƒ½
```

### 5.3 JSONBæ€§èƒ½æå‡

**PostgreSQL 18 JSONBä¼˜åŒ–**ï¼š

```sql
-- JSONBå…ƒæ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢
CREATE TABLE contents_metadata (
    id BIGINT PRIMARY KEY REFERENCES contents(id),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- åˆ›å»ºGINç´¢å¼•æ”¯æŒJSONBæŸ¥è¯¢
CREATE INDEX idx_contents_metadata_gin ON contents_metadata USING GIN (metadata);

-- é«˜æ•ˆJSONBæŸ¥è¯¢
SELECT id, metadata->>'author' AS author
FROM contents_metadata
WHERE metadata @> '{"category": "tech"}'::jsonb;
```

---

## å…­ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 6.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ€§èƒ½ | çµæ´»æ€§ | å­˜å‚¨æˆæœ¬ | æŸ¥è¯¢å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|------|--------|---------|-----------|---------|
| **å…³ç³»å‹è¡¨** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­ | ç»“æ„åŒ–æ•°æ® |
| **JSONB** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | å…ƒæ•°æ®ã€é…ç½® |
| **æ•°ç»„ç±»å‹** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­ | æ ‡ç­¾ã€åˆ†ç±» |
| **å…¨æ–‡æœç´¢** | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­ | å†…å®¹æœç´¢ |

### 6.2 ç´¢å¼•ç­–ç•¥å¯¹æ¯”

| ç´¢å¼•ç±»å‹ | é€‚ç”¨åœºæ™¯ | æŸ¥è¯¢æ€§èƒ½ | å­˜å‚¨å¼€é”€ | ç»´æŠ¤æˆæœ¬ | æ¨èåº¦ |
|---------|---------|---------|---------|---------|--------|
| **B-Tree** | ä¸»é”®ã€å¤–é”®ã€æ—¶é—´æ’åº | â­â­â­â­â­ | â­â­â­ | â­â­ | â­â­â­â­â­ |
| **GINï¼ˆå…¨æ–‡ï¼‰** | å…¨æ–‡æœç´¢ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **GINï¼ˆæ•°ç»„ï¼‰** | æ ‡ç­¾æŸ¥è¯¢ | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **GINï¼ˆJSONBï¼‰** | JSONBæŸ¥è¯¢ | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **GiST** | èŒƒå›´æŸ¥è¯¢ | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ |

### 6.3 ç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å‘½ä¸­ç‡ | å»¶è¿Ÿ | å¤æ‚åº¦ | æˆæœ¬ | æ¨èåœºæ™¯ |
|------|--------|------|--------|------|---------|
| **ç‰©åŒ–è§†å›¾** | â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­ | å†…å®¹åˆ—è¡¨ |
| **åº”ç”¨ç¼“å­˜** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­ | çƒ­ç‚¹å†…å®¹ |
| **CDNç¼“å­˜** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | é™æ€å†…å®¹ |
| **æ•°æ®åº“ç¼“å­˜** | â­â­â­ | â­â­â­â­ | â­ | â­ | è‡ªåŠ¨ç¼“å­˜ |

---

## ä¸ƒã€å®è·µæ¡ˆä¾‹

### 7.1 åšå®¢ç³»ç»Ÿå®ç°

**åšå®¢ç³»ç»Ÿç‰¹ç‚¹**ï¼š

- ä¸ªäººåšå®¢ï¼Œå•ä½œè€…
- ç®€å•çš„åˆ†ç±»å’Œæ ‡ç­¾
- è¯„è®ºç³»ç»Ÿ
- RSSè®¢é˜…

**å®ç°è¦ç‚¹**ï¼š

```sql
-- åšå®¢æ–‡ç« è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'blog_posts') THEN
        DROP TABLE blog_posts CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: blog_posts';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE blog_posts (
        id BIGSERIAL PRIMARY KEY,
        title TEXT NOT NULL,
        slug VARCHAR(255) UNIQUE NOT NULL,
        content TEXT NOT NULL,
        author_id BIGINT NOT NULL REFERENCES users(id),
        category_id INTEGER REFERENCES categories(id),
        tags TEXT[] DEFAULT '{}',
        status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'review', 'published', 'archived')),
        published_at TIMESTAMPTZ,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW(),
        view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
        search_vector tsvector GENERATED ALWAYS AS (
            to_tsvector('simple', title || ' ' || content)
        ) STORED
    );

    RAISE NOTICE 'åšå®¢æ–‡ç« è¡¨åˆ›å»ºæˆåŠŸ: blog_posts';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'usersè¡¨æˆ–categoriesè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨blog_postså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåšå®¢æ–‡ç« è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è¯„è®ºè¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'comments') THEN
        DROP TABLE comments CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: comments';
    END IF;

    -- æ£€æŸ¥blog_postsè¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'blog_posts') THEN
        RAISE EXCEPTION 'blog_postsè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE comments (
        id BIGSERIAL PRIMARY KEY,
        post_id BIGINT NOT NULL REFERENCES blog_posts(id) ON DELETE CASCADE,
        author_name VARCHAR(100) NOT NULL,
        author_email VARCHAR(100),
        content TEXT NOT NULL,
        parent_id BIGINT REFERENCES comments(id),
        created_at TIMESTAMPTZ DEFAULT NOW(),
        approved BOOLEAN DEFAULT FALSE
    );

    -- åˆ›å»ºç´¢å¼•
    CREATE INDEX IF NOT EXISTS idx_comments_post ON comments(post_id);
    CREATE INDEX IF NOT EXISTS idx_comments_parent ON comments(parent_id) WHERE parent_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_comments_approved ON comments(approved) WHERE approved = TRUE;

    RAISE NOTICE 'è¯„è®ºè¡¨åˆ›å»ºæˆåŠŸ: comments';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'blog_postsè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨commentså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¯„è®ºè¡¨å¤±è´¥: %', SQLERRM;
END $$;
```

### 7.2 æ–°é—»ç½‘ç«™å®ç°

**æ–°é—»ç½‘ç«™ç‰¹ç‚¹**ï¼š

- å¤šä½œè€…åä½œ
- ä¸¥æ ¼çš„å®¡æ ¸æµç¨‹
- åˆ†ç±»å±‚æ¬¡ç»“æ„
- çƒ­ç‚¹æ¨è

**å®ç°è¦ç‚¹**ï¼š

```sql
-- æ–°é—»æ–‡ç« è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼Œæ”¯æŒåˆ†åŒºï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'news_articles') THEN
        DROP TABLE news_articles CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: news_articles';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'categories') THEN
        RAISE EXCEPTION 'categoriesè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE news_articles (
        id BIGSERIAL PRIMARY KEY,
        headline TEXT NOT NULL,
        slug VARCHAR(255) UNIQUE NOT NULL,
        content TEXT NOT NULL,
        author_id BIGINT NOT NULL REFERENCES users(id),
        editor_id BIGINT REFERENCES users(id),
        category_id INTEGER NOT NULL REFERENCES categories(id),
        tags TEXT[] DEFAULT '{}',
        status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'review', 'published', 'archived')),
        priority INTEGER DEFAULT 0 CHECK (priority >= 0),  -- ä¼˜å…ˆçº§
        featured BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦æ¨è
        published_at TIMESTAMPTZ,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW(),
        view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
        search_vector tsvector GENERATED ALWAYS AS (
            to_tsvector('simple', headline || ' ' || content)
        ) STORED
    ) PARTITION BY RANGE (published_at);

    RAISE NOTICE 'æ–°é—»æ–‡ç« ä¸»è¡¨åˆ›å»ºæˆåŠŸ: news_articles';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'usersè¡¨æˆ–categoriesè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨news_articleså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ–°é—»æ–‡ç« è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- æŒ‰æœˆåˆ›å»ºåˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- åˆ é™¤ç°æœ‰åˆ†åŒºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'news_articles_2025_01') THEN
        DROP TABLE news_articles_2025_01;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰åˆ†åŒº: news_articles_2025_01';
    END IF;

    -- æ£€æŸ¥ä¸»è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'news_articles') THEN
        RAISE EXCEPTION 'news_articlesä¸»è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒº';
    END IF;

    CREATE TABLE news_articles_2025_01 PARTITION OF news_articles
        FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

    RAISE NOTICE 'åˆ†åŒºåˆ›å»ºæˆåŠŸ: news_articles_2025_01';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'news_articlesä¸»è¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'åˆ†åŒºå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;
```

### 7.3 çŸ¥è¯†åº“ç³»ç»Ÿå®ç°

**çŸ¥è¯†åº“ç³»ç»Ÿç‰¹ç‚¹**ï¼š

- ç‰ˆæœ¬æ§åˆ¶é‡è¦
- å…¨æ–‡æœç´¢æ ¸å¿ƒåŠŸèƒ½
- çŸ¥è¯†å…³è”
- æƒé™æ§åˆ¶ä¸¥æ ¼

**å®ç°è¦ç‚¹**ï¼š

```sql
-- çŸ¥è¯†åº“æ–‡ç« è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'knowledge_base') THEN
        DROP TABLE knowledge_base CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: knowledge_base';
    END IF;

    -- æ£€æŸ¥ä¾èµ–è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤–é”®çº¦æŸ';
    END IF;

    CREATE TABLE knowledge_base (
        id BIGSERIAL PRIMARY KEY,
        title TEXT NOT NULL,
        slug VARCHAR(255) UNIQUE NOT NULL,
        content TEXT NOT NULL,
        author_id BIGINT NOT NULL REFERENCES users(id),
        category_id INTEGER REFERENCES categories(id),
        tags TEXT[] DEFAULT '{}',
        related_articles BIGINT[] DEFAULT '{}',  -- å…³è”æ–‡ç« 
        status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'review', 'published', 'archived')),
        published_at TIMESTAMPTZ,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW(),
        view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
        helpful_count INTEGER DEFAULT 0 CHECK (helpful_count >= 0),
        search_vector tsvector GENERATED ALWAYS AS (
            to_tsvector('simple', title || ' ' || content)
        ) STORED
    );

    -- åˆ›å»ºç´¢å¼•
    CREATE INDEX IF NOT EXISTS idx_knowledge_base_slug ON knowledge_base(slug);
    CREATE INDEX IF NOT EXISTS idx_knowledge_base_author ON knowledge_base(author_id);
    CREATE INDEX IF NOT EXISTS idx_knowledge_base_status ON knowledge_base(status);
    CREATE INDEX IF NOT EXISTS idx_knowledge_base_search ON knowledge_base USING GIN (search_vector);
    CREATE INDEX IF NOT EXISTS idx_knowledge_base_tags ON knowledge_base USING GIN (tags);

    RAISE NOTICE 'çŸ¥è¯†åº“æ–‡ç« è¡¨åˆ›å»ºæˆåŠŸ: knowledge_base';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'usersè¡¨ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨knowledge_baseå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºçŸ¥è¯†åº“æ–‡ç« è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- çŸ¥è¯†å…³è”æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶åº”è¯¥åŒ…è£…åœ¨å‡½æ•°ä¸­æˆ–åº”ç”¨å±‚æ·»åŠ é”™è¯¯å¤„ç†
DO $$
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'knowledge_base') THEN
        RAISE EXCEPTION 'knowledge_baseè¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
    END IF;

    RAISE NOTICE 'çŸ¥è¯†åº“è¡¨å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢:';
    RAISE NOTICE 'SELECT kb1.id, kb1.title, kb2.id AS related_id, kb2.title AS related_title FROM knowledge_base kb1 JOIN knowledge_base kb2 ON kb2.id = ANY(kb1.related_articles) WHERE kb1.id = $1;';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'çŸ¥è¯†å…³è”æŸ¥è¯¢æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 æŸ¥è¯¢ä¼˜åŒ–

**åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨å†…å®¹åˆ—è¡¨
CREATE MATERIALIZED VIEW mv_popular_contents AS
SELECT
    id,
    title,
    excerpt,
    published_at,
    view_count,
    like_count
FROM contents
WHERE status = 'published'
ORDER BY view_count DESC, published_at DESC
LIMIT 1000;

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_popular_contents;

-- ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_contents_list_covering ON contents(status, published_at DESC)
INCLUDE (id, title, excerpt, view_count);
```

**è¯¦æƒ…æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨ä¸»é”®æŸ¥è¯¢ï¼Œè‡ªåŠ¨ä½¿ç”¨ç´¢å¼•
SELECT * FROM contents WHERE id = $1;

-- ä½¿ç”¨slugæŸ¥è¯¢ï¼Œéœ€è¦ç´¢å¼•
SELECT * FROM contents WHERE slug = $1;
```

### 8.2 å†™å…¥ä¼˜åŒ–

**æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨COPYè¿›è¡Œæ‰¹é‡æ’å…¥
COPY contents (title, slug, body, author_id, status)
FROM STDIN WITH (FORMAT csv);

-- ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥
BEGIN;
INSERT INTO contents (...) VALUES (...);
INSERT INTO contents (...) VALUES (...);
COMMIT;
```

**æ›´æ–°ä¼˜åŒ–**ï¼š

```sql
-- åªæ›´æ–°å˜æ›´çš„å­—æ®µ
UPDATE contents
SET title = $1,
    updated_at = NOW()
WHERE id = $2
  AND title IS DISTINCT FROM $1;  -- åªæœ‰å˜æ›´æ—¶æ‰æ›´æ–°
```

### 8.3 ç¼“å­˜ä¼˜åŒ–

**åº”ç”¨å±‚ç¼“å­˜ç­–ç•¥**ï¼š

```sql
-- ä½¿ç”¨ETagæ”¯æŒHTTPç¼“å­˜
SELECT
    id,
    title,
    MD5(title || body || updated_at::TEXT) AS etag
FROM contents
WHERE id = $1;

-- ç¼“å­˜çƒ­é—¨å†…å®¹
SELECT * FROM mv_popular_contents LIMIT 20;
```

### 8.4 åˆ†åŒºä¼˜åŒ–

**æŒ‰æ—¶é—´åˆ†åŒº**ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE contents_archive (
    LIKE contents INCLUDING ALL
) PARTITION BY RANGE (published_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE contents_archive_2024_01 PARTITION OF contents_archive
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(
    p_table_name TEXT,
    p_start_date DATE
)
RETURNS VOID AS $$
DECLARE
    v_partition_name TEXT;
    v_end_date DATE;
BEGIN
    v_end_date := p_start_date + INTERVAL '1 month';
    v_partition_name := p_table_name || '_' || to_char(p_start_date, 'YYYY_MM');

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
        v_partition_name,
        p_table_name,
        p_start_date,
        v_end_date
    );
END;
$$ LANGUAGE plpgsql;
```

---

## ä¹ã€ç›‘æ§ä¸éªŒè¯

### 9.1 å…³é”®æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡**ï¼š

- æŸ¥è¯¢å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- å†™å…¥TPS
- ç¼“å­˜å‘½ä¸­ç‡
- ç´¢å¼•ä½¿ç”¨ç‡
- è¿æ¥æ•°

**ä¸šåŠ¡æŒ‡æ ‡**ï¼š

- å†…å®¹åˆ›å»ºæ•°
- å†…å®¹å‘å¸ƒæ•°
- æœç´¢æŸ¥è¯¢æ•°
- ç”¨æˆ·æ´»è·ƒåº¦

### 9.2 ç›‘æ§æ–¹æ¡ˆ

**æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
ORDER BY mean_exec_time DESC
LIMIT 20;
```

**å†…å®¹ç»Ÿè®¡ç›‘æ§**ï¼š

```sql
-- å†…å®¹çŠ¶æ€ç»Ÿè®¡
SELECT
    status,
    COUNT(*) AS count,
    COUNT(*) FILTER (WHERE published_at >= NOW() - INTERVAL '7 days') AS last_7_days
FROM contents
GROUP BY status;

-- ä½œè€…æ´»è·ƒåº¦ç»Ÿè®¡
SELECT
    u.username,
    COUNT(c.id) AS content_count,
    COUNT(c.id) FILTER (WHERE c.published_at >= NOW() - INTERVAL '30 days') AS last_30_days
FROM users u
LEFT JOIN contents c ON c.author_id = u.id
GROUP BY u.id, u.username
ORDER BY content_count DESC;
```

### 9.3 éªŒè¯æ–¹æ³•

**æ•°æ®ä¸€è‡´æ€§éªŒè¯**ï¼š

```sql
-- éªŒè¯ç‰ˆæœ¬å®Œæ•´æ€§
SELECT
    c.id,
    c.title,
    COUNT(cv.id) AS version_count
FROM contents c
LEFT JOIN content_versions cv ON cv.content_id = c.id
GROUP BY c.id, c.title
HAVING COUNT(cv.id) = 0;  -- æŸ¥æ‰¾æ²¡æœ‰ç‰ˆæœ¬çš„å†…å®¹

-- éªŒè¯æ ‡ç­¾å…³è”
SELECT
    c.id,
    c.title,
    array_length(c.tags, 1) AS tag_count,
    COUNT(ct.tag_id) AS relation_count
FROM contents c
LEFT JOIN content_tags ct ON ct.content_id = c.id
GROUP BY c.id, c.title, c.tags
HAVING array_length(c.tags, 1) IS DISTINCT FROM COUNT(ct.tag_id);
```

---

## åã€æœ€ä½³å®è·µ

### 10.1 è®¾è®¡æœ€ä½³å®è·µ

1. **è¡¨è®¾è®¡**ï¼š
   - ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹
   - æ·»åŠ å¿…è¦çš„çº¦æŸ
   - è®¾è®¡åˆç†çš„ç´¢å¼•
   - è€ƒè™‘åˆ†åŒºç­–ç•¥

2. **ç‰ˆæœ¬æ§åˆ¶**ï¼š
   - è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬
   - é™åˆ¶ç‰ˆæœ¬æ•°é‡
   - å®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬

3. **æƒé™æ§åˆ¶**ï¼š
   - ä½¿ç”¨RLSå®ç°ç»†ç²’åº¦æƒé™
   - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
   - å®šæœŸå®¡æŸ¥æƒé™ç­–ç•¥

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜
   - åˆç†ä½¿ç”¨ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
   - ä½¿ç”¨è¿æ¥æ± 

### 10.2 å¼€å‘æœ€ä½³å®è·µ

1. **ä»£ç è§„èŒƒ**ï¼š
   - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
   - æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†

2. **æµ‹è¯•**ï¼š
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

3. **ç›‘æ§**ï¼š
   - ç›‘æ§å…³é”®æŒ‡æ ‡
   - è®¾ç½®å‘Šè­¦
   - å®šæœŸå®¡æŸ¥æ—¥å¿—

---

## åä¸€ã€å‚è€ƒèµ„æº

### 11.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLå…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [PostgreSQLè¡Œçº§å®‰å…¨](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [PostgreSQL JSONB](https://www.postgresql.org/docs/current/datatype-json.html)
- [PostgreSQLç‰©åŒ–è§†å›¾](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)

### 11.2 ç½‘ç»œèµ„æº

- [PostgreSQL CMSæœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/)
- [Django CMS PostgreSQLä¼˜åŒ–](https://docs.djangoproject.com/)
- [WordPress PostgreSQLè¿ç§»æŒ‡å—](https://wordpress.org/)

### 11.3 ç›¸å…³æ–‡æ¡£

- â­â­â­ [æ•°æ®å»ºæ¨¡å®Œæ•´æŒ‡å—](../æ•°æ®æ¨¡å‹è®¾è®¡/09.02-æ•°æ®å»ºæ¨¡å®Œæ•´æŒ‡å—.md) - æ•°æ®å»ºæ¨¡ç†è®ºåŸºç¡€
- â­â­ [å®‰å…¨ä¸åˆè§„](../../../05-å®‰å…¨ä¸åˆè§„/README.md) - RLSç­–ç•¥è¯¦è§£
- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](../../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.02-ç´¢å¼•ç»“æ„/02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - GINç´¢å¼•å’Œå…¨æ–‡æœç´¢
- â­ [PostgreSQL 18æ–°ç‰¹æ€§](../../../18-ç‰ˆæœ¬ç‰¹æ€§/02.01-PostgreSQL-18-æ–°ç‰¹æ€§.md) - è™šæ‹Ÿç”Ÿæˆåˆ—å’Œå¼‚æ­¥I/O
- â­ [å®æ—¶æ¨è](../è¡Œä¸šæ¡ˆä¾‹/å®æ—¶æ¨è.md) - å®æ—¶æ¨èç³»ç»Ÿæ¡ˆä¾‹

---

## åäºŒã€äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### æ•°æ®æ¨¡å‹è®¾è®¡

- â­â­â­ [æ•°æ®å»ºæ¨¡å®Œæ•´æŒ‡å—](../æ•°æ®æ¨¡å‹è®¾è®¡/09.02-æ•°æ®å»ºæ¨¡å®Œæ•´æŒ‡å—.md) - CMSæ•°æ®å»ºæ¨¡å®è·µ
- â­â­ [æ•°æ®åˆ†æå®Œæ•´æŒ‡å—](../æ•°æ®æ¨¡å‹è®¾è®¡/09.01-æ•°æ®åˆ†æå®Œæ•´æŒ‡å—.md) - å†…å®¹æ•°æ®åˆ†æ

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†](../../../01-æ ¸å¿ƒåŸºç¡€/01.04-SQLè¯­è¨€/01.03-SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†.md) - SQLè¯­è¨€åŸºç¡€
- â­ [å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º](../../../01-æ ¸å¿ƒåŸºç¡€/01.03-æ•°æ®æ¨¡å‹/01.02-å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º.md) - æ•°æ®æ¨¡å‹ç†è®º

#### æŸ¥è¯¢ä¸ä¼˜åŒ–

- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](../../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.02-ç´¢å¼•ç»“æ„/02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - GINç´¢å¼•å’Œå…¨æ–‡æœç´¢
- â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–åŸºç¡€

#### é«˜çº§ç‰¹æ€§

- â­â­â­ [å®‰å…¨ä¸åˆè§„](../../../05-å®‰å…¨ä¸åˆè§„/README.md) - RLSç­–ç•¥è¯¦è§£

#### ç‰ˆæœ¬ç‰¹æ€§

- â­â­ [PostgreSQL 18æ–°ç‰¹æ€§](../../../18-ç‰ˆæœ¬ç‰¹æ€§/02.01-PostgreSQL-18-æ–°ç‰¹æ€§.md) - è™šæ‹Ÿç”Ÿæˆåˆ—å’Œå¼‚æ­¥I/O

### å¤–éƒ¨èµ„æº

- [PostgreSQLå…¨æ–‡æœç´¢æ–‡æ¡£](https://www.postgresql.org/docs/current/textsearch.html)
- [PostgreSQL JSONBæ–‡æ¡£](https://www.postgresql.org/docs/current/datatype-json.html)
- [PostgreSQLç‰©åŒ–è§†å›¾æ–‡æ¡£](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Data-Science Team
