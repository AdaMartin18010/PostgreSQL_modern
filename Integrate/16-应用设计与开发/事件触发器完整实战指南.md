---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: æ–°å¢æ·±åŒ–æ–‡æ¡£
> **ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£èšç„¦äº‹ä»¶è§¦å‘å™¨ï¼ˆEvent Triggersï¼‰å®Œæ•´æŠ€æœ¯æ ˆ

---

# PostgreSQLäº‹ä»¶è§¦å‘å™¨å®Œæ•´å®æˆ˜æŒ‡å—

## å…ƒæ•°æ®

- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01
- **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | PL/pgSQL | pg_event_trigger
- **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)
- **é¢„è®¡é˜…è¯»**: 120åˆ†é’Ÿ
- **å‰ç½®è¦æ±‚**: ç†Ÿæ‚‰PostgreSQLåŸºç¡€ã€è§¦å‘å™¨åŸºç¡€ã€DDLæ“ä½œ

---

## ğŸ“‹ å®Œæ•´ç›®å½•

- [PostgreSQLäº‹ä»¶è§¦å‘å™¨å®Œæ•´å®æˆ˜æŒ‡å—](#postgresqläº‹ä»¶è§¦å‘å™¨å®Œæ•´å®æˆ˜æŒ‡å—)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [ğŸ“‹ å®Œæ•´ç›®å½•](#-å®Œæ•´ç›®å½•)
  - [1. äº‹ä»¶è§¦å‘å™¨æ¦‚è¿°](#1-äº‹ä»¶è§¦å‘å™¨æ¦‚è¿°)
    - [1.1 äº‹ä»¶è§¦å‘å™¨æ¦‚å¿µ](#11-äº‹ä»¶è§¦å‘å™¨æ¦‚å¿µ)
      - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
      - [äº‹ä»¶è§¦å‘å™¨ç‰¹ç‚¹](#äº‹ä»¶è§¦å‘å™¨ç‰¹ç‚¹)
    - [1.2 äº‹ä»¶è§¦å‘å™¨vsæ™®é€šè§¦å‘å™¨](#12-äº‹ä»¶è§¦å‘å™¨vsæ™®é€šè§¦å‘å™¨)
      - [å¯¹æ¯”è¡¨](#å¯¹æ¯”è¡¨)
    - [1.3 äº‹ä»¶è§¦å‘å™¨åº”ç”¨åœºæ™¯](#13-äº‹ä»¶è§¦å‘å™¨åº”ç”¨åœºæ™¯)
      - [å…¸å‹åº”ç”¨åœºæ™¯](#å…¸å‹åº”ç”¨åœºæ™¯)
  - [2. DDLäº‹ä»¶è§¦å‘å™¨](#2-ddläº‹ä»¶è§¦å‘å™¨)
    - [2.1 DDLäº‹ä»¶ç±»å‹](#21-ddläº‹ä»¶ç±»å‹)
      - [æ”¯æŒçš„äº‹ä»¶](#æ”¯æŒçš„äº‹ä»¶)
      - [äº‹ä»¶è§¦å‘æ—¶æœº](#äº‹ä»¶è§¦å‘æ—¶æœº)
    - [2.2 åˆ›å»ºDDLäº‹ä»¶è§¦å‘å™¨](#22-åˆ›å»ºddläº‹ä»¶è§¦å‘å™¨)
      - [åŸºæœ¬åˆ›å»ºè¯­æ³•](#åŸºæœ¬åˆ›å»ºè¯­æ³•)
      - [é«˜çº§äº‹ä»¶è§¦å‘å™¨å‡½æ•°](#é«˜çº§äº‹ä»¶è§¦å‘å™¨å‡½æ•°)
    - [2.3 è·å–DDLå‘½ä»¤ä¿¡æ¯](#23-è·å–ddlå‘½ä»¤ä¿¡æ¯)
      - [pg\_event\_trigger\_ddl\_commands()](#pg_event_trigger_ddl_commands)
      - [pg\_event\_trigger\_dropped\_objects()](#pg_event_trigger_dropped_objects)
    - [2.4 DDLäº‹ä»¶è§¦å‘å™¨åº”ç”¨](#24-ddläº‹ä»¶è§¦å‘å™¨åº”ç”¨)
      - [æ¡ä»¶è§¦å‘](#æ¡ä»¶è§¦å‘)
  - [3. æ•°æ®åº“çº§äº‹ä»¶è§¦å‘å™¨](#3-æ•°æ®åº“çº§äº‹ä»¶è§¦å‘å™¨)
    - [3.1 æ•°æ®åº“äº‹ä»¶ç±»å‹](#31-æ•°æ®åº“äº‹ä»¶ç±»å‹)
      - [PostgreSQL 15+æ”¯æŒçš„æ•°æ®åº“äº‹ä»¶](#postgresql-15æ”¯æŒçš„æ•°æ®åº“äº‹ä»¶)
    - [3.2 ç™»å½•/ç™»å‡ºäº‹ä»¶è§¦å‘å™¨](#32-ç™»å½•ç™»å‡ºäº‹ä»¶è§¦å‘å™¨)
      - [ç™»å½•äº‹ä»¶è§¦å‘å™¨](#ç™»å½•äº‹ä»¶è§¦å‘å™¨)
  - [4. å®¡è®¡æ—¥å¿—å®ç°](#4-å®¡è®¡æ—¥å¿—å®ç°)
    - [4.1 DDLå®¡è®¡æ—¥å¿—](#41-ddlå®¡è®¡æ—¥å¿—)
      - [å®Œæ•´DDLå®¡è®¡ç³»ç»Ÿ](#å®Œæ•´ddlå®¡è®¡ç³»ç»Ÿ)
      - [å®¡è®¡æ—¥å¿—æŸ¥è¯¢](#å®¡è®¡æ—¥å¿—æŸ¥è¯¢)
  - [5. å®‰å…¨ç­–ç•¥å®æ–½](#5-å®‰å…¨ç­–ç•¥å®æ–½)
    - [5.1 DDLæƒé™æ§åˆ¶](#51-ddlæƒé™æ§åˆ¶)
      - [ç›‘æ§æ•æ„Ÿæ“ä½œ](#ç›‘æ§æ•æ„Ÿæ“ä½œ)
    - [5.2 å¯¹è±¡å‘½åè§„èŒƒ](#52-å¯¹è±¡å‘½åè§„èŒƒ)
      - [å‘½åè§„èŒƒæ£€æŸ¥](#å‘½åè§„èŒƒæ£€æŸ¥)
  - [6. æ€§èƒ½ç›‘æ§](#6-æ€§èƒ½ç›‘æ§)
    - [6.1 DDLæ“ä½œç›‘æ§](#61-ddlæ“ä½œç›‘æ§)
      - [DDLæ€§èƒ½ç›‘æ§](#ddlæ€§èƒ½ç›‘æ§)
  - [7. å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
    - [7.1 å®Œæ•´DDLå®¡è®¡ç³»ç»Ÿ](#71-å®Œæ•´ddlå®¡è®¡ç³»ç»Ÿ)
      - [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## 1. äº‹ä»¶è§¦å‘å™¨æ¦‚è¿°

### 1.1 äº‹ä»¶è§¦å‘å™¨æ¦‚å¿µ

#### æ ¸å¿ƒæ¦‚å¿µ

```text
äº‹ä»¶è§¦å‘å™¨ï¼ˆEvent Triggerï¼‰:
- åœ¨æ•°æ®åº“çº§åˆ«æ•è·DDLäº‹ä»¶
- å“åº”CREATEã€DROPã€ALTERç­‰æ“ä½œ
- åœ¨æ“ä½œæ‰§è¡Œå‰æˆ–åè§¦å‘
- å¯ä»¥é˜»æ­¢æˆ–è®°å½•DDLæ“ä½œ
```

#### äº‹ä»¶è§¦å‘å™¨ç‰¹ç‚¹

- âœ… **æ•°æ®åº“çº§åˆ«**: ä½œç”¨äºæ•´ä¸ªæ•°æ®åº“ï¼Œä¸æ˜¯ç‰¹å®šè¡¨
- âœ… **DDLäº‹ä»¶**: æ•è·æ•°æ®å®šä¹‰è¯­è¨€ï¼ˆDDLï¼‰äº‹ä»¶
- âœ… **æ— æ³•é˜»æ­¢**: åœ¨äº‹ä»¶å‘ç”Ÿåè§¦å‘ï¼Œæ— æ³•é˜»æ­¢æ“ä½œ
- âœ… **ä¿¡æ¯è®¿é—®**: å¯ä»¥è®¿é—®DDLå‘½ä»¤çš„è¯¦ç»†ä¿¡æ¯
- âœ… **å®‰å…¨æ€§**: éœ€è¦è¶…çº§ç”¨æˆ·æƒé™åˆ›å»º

### 1.2 äº‹ä»¶è§¦å‘å™¨vsæ™®é€šè§¦å‘å™¨

#### å¯¹æ¯”è¡¨

| ç‰¹æ€§ | äº‹ä»¶è§¦å‘å™¨ | æ™®é€šè§¦å‘å™¨ |
|------|-----------|-----------|
| **ä½œç”¨çº§åˆ«** | æ•°æ®åº“çº§åˆ« | è¡¨çº§åˆ« |
| **è§¦å‘äº‹ä»¶** | DDLäº‹ä»¶ï¼ˆCREATEã€DROPã€ALTERï¼‰ | DMLäº‹ä»¶ï¼ˆINSERTã€UPDATEã€DELETEï¼‰ |
| **æ˜¯å¦å¯ä»¥é˜»æ­¢** | ä¸èƒ½é˜»æ­¢ï¼ˆåœ¨äº‹ä»¶åè§¦å‘ï¼‰ | å¯ä»¥é˜»æ­¢ï¼ˆBEFOREè§¦å‘å™¨ï¼‰ |
| **ä¿¡æ¯è®¿é—®** | `pg_event_trigger_ddl_commands()` | OLD/NEWè®°å½• |
| **åˆ›å»ºæƒé™** | éœ€è¦è¶…çº§ç”¨æˆ· | è¡¨æ‰€æœ‰è€… |
| **ä½¿ç”¨åœºæ™¯** | å®¡è®¡ã€ç›‘æ§ã€æ—¥å¿—è®°å½• | æ•°æ®éªŒè¯ã€ä¸šåŠ¡é€»è¾‘ |

### 1.3 äº‹ä»¶è§¦å‘å™¨åº”ç”¨åœºæ™¯

#### å…¸å‹åº”ç”¨åœºæ™¯

```text
åœºæ™¯1: DDLå®¡è®¡æ—¥å¿—
- è®°å½•æ‰€æœ‰DDLæ“ä½œ
- è®°å½•æ“ä½œæ—¶é—´ã€ç”¨æˆ·ã€å‘½ä»¤
- ç”Ÿæˆå®¡è®¡æŠ¥å‘Š

åœºæ™¯2: æ•°æ®åº“å˜æ›´ç®¡ç†
- è·Ÿè¸ªæ•°æ®åº“ç»“æ„å˜æ›´
- è®°å½•å˜æ›´å†å²
- ç”Ÿæˆå˜æ›´æŠ¥å‘Š

åœºæ™¯3: å®‰å…¨ç­–ç•¥å®æ–½
- ç›‘æ§æ•æ„Ÿæ“ä½œ
- è®°å½•å®‰å…¨äº‹ä»¶
- ç”Ÿæˆå®‰å…¨æŠ¥å‘Š

åœºæ™¯4: æ€§èƒ½ç›‘æ§
- ç›‘æ§DDLæ“ä½œæ€§èƒ½
- è®°å½•é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œ
- ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
```

---

## 2. DDLäº‹ä»¶è§¦å‘å™¨

### 2.1 DDLäº‹ä»¶ç±»å‹

#### æ”¯æŒçš„äº‹ä»¶

```sql
-- DDLäº‹ä»¶ç±»å‹
CREATE TABLE event_types (
    event_type TEXT PRIMARY KEY,
    description TEXT
);

INSERT INTO event_types VALUES
('ddl_command_start', 'DDLå‘½ä»¤æ‰§è¡Œå‰è§¦å‘'),
('ddl_command_end', 'DDLå‘½ä»¤æ‰§è¡Œåè§¦å‘'),
('sql_drop', 'DROPå‘½ä»¤æ‰§è¡Œåè§¦å‘'),
('table_rewrite', 'è¡¨é‡å†™æ“ä½œæ—¶è§¦å‘');
```

#### äº‹ä»¶è§¦å‘æ—¶æœº

```text
ddl_command_start:
- åœ¨DDLå‘½ä»¤æ‰§è¡Œå‰è§¦å‘
- å¯ä»¥è®¿é—®å‘½ä»¤ä¿¡æ¯
- æ— æ³•é˜»æ­¢å‘½ä»¤æ‰§è¡Œ

ddl_command_end:
- åœ¨DDLå‘½ä»¤æ‰§è¡Œåè§¦å‘
- å¯ä»¥è®¿é—®å‘½ä»¤ç»“æœ
- é€šå¸¸ç”¨äºæ—¥å¿—è®°å½•

sql_drop:
- åœ¨DROPå‘½ä»¤æ‰§è¡Œåè§¦å‘
- å¯ä»¥è®¿é—®è¢«åˆ é™¤å¯¹è±¡ä¿¡æ¯
- é€šå¸¸ç”¨äºå®¡è®¡å’Œæ¢å¤

table_rewrite:
- åœ¨è¡¨é‡å†™æ“ä½œæ—¶è§¦å‘
- ä¾‹å¦‚ï¼šALTER TABLE ... SET DATA TYPE
- é€šå¸¸ç”¨äºæ€§èƒ½ç›‘æ§
```

### 2.2 åˆ›å»ºDDLäº‹ä»¶è§¦å‘å™¨

#### åŸºæœ¬åˆ›å»ºè¯­æ³•

```sql
-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION log_ddl_command()
RETURNS event_trigger AS $$
BEGIN
    RAISE NOTICE 'DDL command executed';
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER ddl_log_trigger
ON ddl_command_end
EXECUTE FUNCTION log_ddl_command();
```

#### é«˜çº§äº‹ä»¶è§¦å‘å™¨å‡½æ•°

```sql
-- è·å–DDLå‘½ä»¤ä¿¡æ¯çš„äº‹ä»¶è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION audit_ddl_command()
RETURNS event_trigger AS $$
DECLARE
    r RECORD;
    command_text TEXT;
BEGIN
    -- è·å–DDLå‘½ä»¤ä¿¡æ¯
    FOR r IN
        SELECT * FROM pg_event_trigger_ddl_commands()
    LOOP
        command_text := r.object_identity;

        -- è®°å½•å®¡è®¡æ—¥å¿—
        INSERT INTO ddl_audit_log (
            event_time,
            event_type,
            command_tag,
            object_type,
            object_identity,
            schema_name,
            object_name,
            username
        ) VALUES (
            NOW(),
            tg_event,
            tg_tag,
            r.object_type,
            r.object_identity,
            r.schema_name,
            r.object_name,
            current_user
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®¡è®¡äº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER audit_ddl_trigger
ON ddl_command_end
EXECUTE FUNCTION audit_ddl_command();

-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE ddl_audit_log (
    id BIGSERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    event_type TEXT NOT NULL,
    command_tag TEXT,
    object_type TEXT,
    object_identity TEXT,
    schema_name TEXT,
    object_name TEXT,
    username TEXT,
    command_text TEXT
);

CREATE INDEX idx_ddl_audit_log_time ON ddl_audit_log(event_time);
CREATE INDEX idx_ddl_audit_log_user ON ddl_audit_log(username);
CREATE INDEX idx_ddl_audit_log_object ON ddl_audit_log(object_identity);
```

### 2.3 è·å–DDLå‘½ä»¤ä¿¡æ¯

#### pg_event_trigger_ddl_commands()

```sql
-- ä½¿ç”¨pg_event_trigger_ddl_commands()è·å–å‘½ä»¤ä¿¡æ¯
CREATE OR REPLACE FUNCTION log_ddl_details()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    cmd_text TEXT := '';
BEGIN
    FOR cmd IN
        SELECT
            object_type,
            schema_name,
            object_identity,
            in_extension,
            command_tag,
            command
        FROM pg_event_trigger_ddl_commands()
    LOOP
        -- æ„å»ºå‘½ä»¤æ–‡æœ¬
        cmd_text := format(
            'Object: %s.%s (%s), Tag: %s, Extension: %s',
            cmd.schema_name,
            cmd.object_identity,
            cmd.object_type,
            cmd.command_tag,
            cmd.in_extension
        );

        RAISE NOTICE '%', cmd_text;

        -- è®°å½•è¯¦ç»†ä¿¡æ¯
        INSERT INTO ddl_audit_log (
            event_time,
            object_type,
            object_identity,
            schema_name,
            command_tag,
            command_text
        ) VALUES (
            NOW(),
            cmd.object_type,
            cmd.object_identity,
            cmd.schema_name,
            cmd.command_tag,
            cmd_text
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

#### pg_event_trigger_dropped_objects()

```sql
-- è·å–è¢«åˆ é™¤å¯¹è±¡ä¿¡æ¯ï¼ˆç”¨äºsql_dropäº‹ä»¶ï¼‰
CREATE OR REPLACE FUNCTION log_dropped_objects()
RETURNS event_trigger AS $$
DECLARE
    obj RECORD;
BEGIN
    FOR obj IN
        SELECT
            object_type,
            schema_name,
            object_name,
            object_identity,
            address_names,
            address_args,
            original,
            normal
        FROM pg_event_trigger_dropped_objects()
    LOOP
        -- è®°å½•åˆ é™¤çš„å¯¹è±¡
        INSERT INTO drop_audit_log (
            event_time,
            object_type,
            schema_name,
            object_name,
            object_identity,
            original,
            username
        ) VALUES (
            NOW(),
            obj.object_type,
            obj.schema_name,
            obj.object_name,
            obj.object_identity,
            obj.original,
            current_user
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºDROPäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER log_drop_trigger
ON sql_drop
EXECUTE FUNCTION log_dropped_objects();

-- åˆ›å»ºDROPå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE drop_audit_log (
    id BIGSERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    object_type TEXT NOT NULL,
    schema_name TEXT,
    object_name TEXT,
    object_identity TEXT,
    original BOOLEAN,
    username TEXT,
    restore_sql TEXT  -- å¯ç”¨äºæ¢å¤
);
```

### 2.4 DDLäº‹ä»¶è§¦å‘å™¨åº”ç”¨

#### æ¡ä»¶è§¦å‘

```sql
-- åªè®°å½•ç‰¹å®šç±»å‹çš„DDLæ“ä½œ
CREATE OR REPLACE FUNCTION audit_table_ddl()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
BEGIN
    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
        WHERE object_type IN ('table', 'view', 'materialized view')
    LOOP
        INSERT INTO table_ddl_log (
            event_time,
            object_type,
            object_identity,
            command_tag,
            username
        ) VALUES (
            NOW(),
            cmd.object_type,
            cmd.object_identity,
            tg_tag,
            current_user
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER audit_table_ddl_trigger
ON ddl_command_end
WHEN TAG IN ('CREATE TABLE', 'ALTER TABLE', 'DROP TABLE',
             'CREATE VIEW', 'ALTER VIEW', 'DROP VIEW')
EXECUTE FUNCTION audit_table_ddl();
```

---

## 3. æ•°æ®åº“çº§äº‹ä»¶è§¦å‘å™¨

### 3.1 æ•°æ®åº“äº‹ä»¶ç±»å‹

#### PostgreSQL 15+æ”¯æŒçš„æ•°æ®åº“äº‹ä»¶

```sql
-- æ•°æ®åº“çº§äº‹ä»¶ï¼ˆPostgreSQL 15+ï¼‰
-- loginäº‹ä»¶ï¼šç”¨æˆ·ç™»å½•æ—¶è§¦å‘
-- æ³¨æ„ï¼šéœ€è¦pg_hba.confé…ç½®æ”¯æŒ
```

### 3.2 ç™»å½•/ç™»å‡ºäº‹ä»¶è§¦å‘å™¨

#### ç™»å½•äº‹ä»¶è§¦å‘å™¨

```sql
-- ç™»å½•äº‹ä»¶è§¦å‘å™¨ï¼ˆPostgreSQL 15+ï¼‰
-- æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦ç‰¹å®šé…ç½®å’Œæƒé™

-- åˆ›å»ºç™»å½•å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE login_audit_log (
    id BIGSERIAL PRIMARY KEY,
    login_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    username TEXT NOT NULL,
    database_name TEXT,
    application_name TEXT,
    client_addr INET,
    session_id TEXT
);

-- åˆ›å»ºç™»å½•äº‹ä»¶è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION log_user_login()
RETURNS event_trigger AS $$
BEGIN
    INSERT INTO login_audit_log (
        username,
        database_name,
        application_name,
        client_addr,
        session_id
    ) VALUES (
        current_user,
        current_database(),
        current_setting('application_name', true),
        inet_client_addr(),
        pg_backend_pid()::TEXT
    );
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºç™»å½•äº‹ä»¶è§¦å‘å™¨ï¼ˆéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰
-- CREATE EVENT TRIGGER log_login_trigger
-- ON login
-- EXECUTE FUNCTION log_user_login();
```

---

## 4. å®¡è®¡æ—¥å¿—å®ç°

### 4.1 DDLå®¡è®¡æ—¥å¿—

#### å®Œæ•´DDLå®¡è®¡ç³»ç»Ÿ

```sql
-- å®Œæ•´çš„DDLå®¡è®¡æ—¥å¿—ç³»ç»Ÿ
CREATE OR REPLACE FUNCTION comprehensive_ddl_audit()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    audit_record JSONB;
BEGIN
    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
    LOOP
        -- æ„å»ºå®¡è®¡è®°å½•
        audit_record := jsonb_build_object(
            'event_time', NOW(),
            'event_type', tg_event,
            'command_tag', tg_tag,
            'object_type', cmd.object_type,
            'schema_name', cmd.schema_name,
            'object_identity', cmd.object_identity,
            'username', current_user,
            'database', current_database(),
            'session_id', pg_backend_pid(),
            'transaction_id', txid_current()
        );

        -- å­˜å‚¨å®¡è®¡è®°å½•ï¼ˆJSONBæ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
        INSERT INTO comprehensive_audit_log (
            event_time,
            event_type,
            audit_data
        ) VALUES (
            NOW(),
            tg_event,
            audit_record
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºç»¼åˆå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE comprehensive_audit_log (
    id BIGSERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    event_type TEXT NOT NULL,
    audit_data JSONB NOT NULL
);

-- åˆ›å»ºGINç´¢å¼•ä»¥æ”¯æŒJSONBæŸ¥è¯¢
CREATE INDEX idx_audit_log_data ON comprehensive_audit_log USING GIN (audit_data);
CREATE INDEX idx_audit_log_time ON comprehensive_audit_log(event_time);
CREATE INDEX idx_audit_log_type ON comprehensive_audit_log(event_type);

-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER comprehensive_ddl_audit_trigger
ON ddl_command_end
EXECUTE FUNCTION comprehensive_ddl_audit();
```

#### å®¡è®¡æ—¥å¿—æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æœ€è¿‘çš„è¡¨åˆ›å»ºæ“ä½œ
SELECT
    event_time,
    audit_data->>'username' AS username,
    audit_data->>'object_identity' AS object,
    audit_data->>'command_tag' AS command
FROM comprehensive_audit_log
WHERE event_type = 'ddl_command_end'
  AND audit_data->>'object_type' = 'table'
  AND audit_data->>'command_tag' = 'CREATE TABLE'
ORDER BY event_time DESC
LIMIT 10;

-- æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰DDLæ“ä½œ
SELECT
    event_time,
    audit_data->>'command_tag' AS command,
    audit_data->>'object_identity' AS object
FROM comprehensive_audit_log
WHERE audit_data->>'username' = 'admin'
ORDER BY event_time DESC;
```

---

## 5. å®‰å…¨ç­–ç•¥å®æ–½

### 5.1 DDLæƒé™æ§åˆ¶

#### ç›‘æ§æ•æ„Ÿæ“ä½œ

```sql
-- ç›‘æ§æ•æ„ŸDDLæ“ä½œ
CREATE OR REPLACE FUNCTION monitor_sensitive_ddl()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    alert_level TEXT;
BEGIN
    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
    LOOP
        -- åˆ¤æ–­æ•æ„Ÿæ“ä½œ
        alert_level := CASE
            WHEN cmd.object_type = 'role' AND tg_tag LIKE 'CREATE%' THEN 'CRITICAL'
            WHEN cmd.object_type = 'database' THEN 'HIGH'
            WHEN cmd.schema_name = 'public' AND cmd.object_type = 'table' THEN 'MEDIUM'
            ELSE 'LOW'
        END;

        -- è®°å½•æ•æ„Ÿæ“ä½œ
        IF alert_level IN ('CRITICAL', 'HIGH') THEN
            INSERT INTO security_alert_log (
                alert_time,
                alert_level,
                object_type,
                object_identity,
                command_tag,
                username,
                action_taken
            ) VALUES (
                NOW(),
                alert_level,
                cmd.object_type,
                cmd.object_identity,
                tg_tag,
                current_user,
                'LOGGED'
            );

            -- å‘é€é€šçŸ¥ï¼ˆå¯ä»¥ä½¿ç”¨pg_notifyï¼‰
            PERFORM pg_notify('security_alert', jsonb_build_object(
                'level', alert_level,
                'object', cmd.object_identity,
                'command', tg_tag,
                'user', current_user
            )::TEXT);
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®‰å…¨å‘Šè­¦æ—¥å¿—è¡¨
CREATE TABLE security_alert_log (
    id BIGSERIAL PRIMARY KEY,
    alert_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    alert_level TEXT NOT NULL,
    object_type TEXT,
    object_identity TEXT,
    command_tag TEXT,
    username TEXT,
    action_taken TEXT
);

-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER security_monitor_trigger
ON ddl_command_end
EXECUTE FUNCTION monitor_sensitive_ddl();
```

### 5.2 å¯¹è±¡å‘½åè§„èŒƒ

#### å‘½åè§„èŒƒæ£€æŸ¥

```sql
-- æ£€æŸ¥å¯¹è±¡å‘½åè§„èŒƒ
CREATE OR REPLACE FUNCTION check_naming_convention()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    object_name TEXT;
    violation TEXT;
BEGIN
    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
        WHERE object_type IN ('table', 'view', 'function', 'procedure')
    LOOP
        object_name := cmd.object_name;

        -- æ£€æŸ¥å‘½åè§„èŒƒï¼ˆç¤ºä¾‹ï¼šå¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
        IF NOT (object_name ~ '^[a-z][a-z0-9_]*$') THEN
            violation := format(
                'Naming convention violation: %s does not match pattern ^[a-z][a-z0-9_]*$',
                object_name
            );

            -- è®°å½•è¿è§„
            INSERT INTO naming_violation_log (
                violation_time,
                object_type,
                object_name,
                object_identity,
                violation_reason,
                username
            ) VALUES (
                NOW(),
                cmd.object_type,
                object_name,
                cmd.object_identity,
                violation,
                current_user
            );

            -- å¯ä»¥é€‰æ‹©æŠ›å‡ºå¼‚å¸¸é˜»æ­¢åˆ›å»º
            -- RAISE EXCEPTION '%', violation;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå‘½åè§„èŒƒè¿è§„æ—¥å¿—è¡¨
CREATE TABLE naming_violation_log (
    id BIGSERIAL PRIMARY KEY,
    violation_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    object_type TEXT NOT NULL,
    object_name TEXT NOT NULL,
    object_identity TEXT,
    violation_reason TEXT,
    username TEXT
);

-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER naming_convention_trigger
ON ddl_command_end
EXECUTE FUNCTION check_naming_convention();
```

---

## 6. æ€§èƒ½ç›‘æ§

### 6.1 DDLæ“ä½œç›‘æ§

#### DDLæ€§èƒ½ç›‘æ§

```sql
-- DDLæ“ä½œæ€§èƒ½ç›‘æ§
CREATE OR REPLACE FUNCTION monitor_ddl_performance()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    start_time TIMESTAMPTZ;
    duration INTERVAL;
BEGIN
    -- è·å–æ“ä½œå¼€å§‹æ—¶é—´ï¼ˆéœ€è¦é…åˆddl_command_startè§¦å‘å™¨ï¼‰
    SELECT MAX(event_time) INTO start_time
    FROM ddl_performance_log
    WHERE command_id = txid_current();

    -- å¦‚æœæ²¡æœ‰å¼€å§‹æ—¶é—´è®°å½•ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
    IF start_time IS NULL THEN
        start_time := NOW();
    END IF;

    duration := NOW() - start_time;

    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
    LOOP
        -- è®°å½•æ€§èƒ½æ•°æ®
        INSERT INTO ddl_performance_log (
            event_time,
            command_tag,
            object_type,
            object_identity,
            duration,
            username
        ) VALUES (
            NOW(),
            tg_tag,
            cmd.object_type,
            cmd.object_identity,
            duration,
            current_user
        );

        -- å¦‚æœæ“ä½œæ—¶é—´è¿‡é•¿ï¼Œè®°å½•å‘Šè­¦
        IF duration > INTERVAL '1 minute' THEN
            INSERT INTO slow_ddl_alert (
                alert_time,
                object_identity,
                command_tag,
                duration,
                username
            ) VALUES (
                NOW(),
                cmd.object_identity,
                tg_tag,
                duration,
                current_user
            );
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºæ€§èƒ½æ—¥å¿—è¡¨
CREATE TABLE ddl_performance_log (
    id BIGSERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    command_tag TEXT,
    object_type TEXT,
    object_identity TEXT,
    duration INTERVAL,
    username TEXT,
    command_id BIGINT
);

CREATE INDEX idx_ddl_perf_time ON ddl_performance_log(event_time);
CREATE INDEX idx_ddl_perf_duration ON ddl_performance_log(duration);

-- åˆ›å»ºæ…¢DDLå‘Šè­¦è¡¨
CREATE TABLE slow_ddl_alert (
    id BIGSERIAL PRIMARY KEY,
    alert_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    object_identity TEXT,
    command_tag TEXT,
    duration INTERVAL,
    username TEXT
);

-- åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER ddl_performance_monitor
ON ddl_command_end
EXECUTE FUNCTION monitor_ddl_performance();
```

---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 å®Œæ•´DDLå®¡è®¡ç³»ç»Ÿ

#### ç³»ç»Ÿæ¶æ„

```sql
-- å®Œæ•´çš„DDLå®¡è®¡ç³»ç»Ÿå®ç°

-- 1. åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE ddl_audit_system (
    id BIGSERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    event_type TEXT NOT NULL,
    command_tag TEXT,
    object_type TEXT,
    schema_name TEXT,
    object_name TEXT,
    object_identity TEXT,
    username TEXT NOT NULL,
    database_name TEXT NOT NULL,
    application_name TEXT,
    client_addr INET,
    command_text TEXT,
    metadata JSONB
);

-- 2. åˆ›å»ºç»¼åˆå®¡è®¡å‡½æ•°
CREATE OR REPLACE FUNCTION comprehensive_audit_function()
RETURNS event_trigger AS $$
DECLARE
    cmd RECORD;
    audit_metadata JSONB;
BEGIN
    FOR cmd IN
        SELECT * FROM pg_event_trigger_ddl_commands()
    LOOP
        -- æ„å»ºå…ƒæ•°æ®
        audit_metadata := jsonb_build_object(
            'session_id', pg_backend_pid(),
            'transaction_id', txid_current(),
            'query', current_query(),
            'in_extension', cmd.in_extension
        );

        -- æ’å…¥å®¡è®¡è®°å½•
        INSERT INTO ddl_audit_system (
            event_type,
            command_tag,
            object_type,
            schema_name,
            object_name,
            object_identity,
            username,
            database_name,
            application_name,
            client_addr,
            metadata
        ) VALUES (
            tg_event,
            tg_tag,
            cmd.object_type,
            cmd.schema_name,
            cmd.object_name,
            cmd.object_identity,
            current_user,
            current_database(),
            current_setting('application_name', true),
            inet_client_addr(),
            audit_metadata
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 3. åˆ›å»ºäº‹ä»¶è§¦å‘å™¨
CREATE EVENT TRIGGER comprehensive_audit_trigger
ON ddl_command_end
EXECUTE FUNCTION comprehensive_audit_function();

-- 4. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_audit_time ON ddl_audit_system(event_time);
CREATE INDEX idx_audit_user ON ddl_audit_system(username);
CREATE INDEX idx_audit_object ON ddl_audit_system(object_identity);
CREATE INDEX idx_audit_type ON ddl_audit_system(object_type);

-- 5. åˆ›å»ºå®¡è®¡æŠ¥å‘Šè§†å›¾
CREATE OR REPLACE VIEW ddl_audit_report AS
SELECT
    DATE_TRUNC('day', event_time) AS audit_date,
    username,
    object_type,
    command_tag,
    COUNT(*) AS operation_count
FROM ddl_audit_system
GROUP BY DATE_TRUNC('day', event_time), username, object_type, command_tag
ORDER BY audit_date DESC, operation_count DESC;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£**: <https://www.postgresql.org/docs/current/event-triggers.html>
2. **pg_event_triggeræ‰©å±•**: <https://www.postgresql.org/docs/current/functions-event-triggers.html>
3. **DDLå®¡è®¡æœ€ä½³å®è·µ**: <https://www.postgresql.org/docs/current/event-triggers.html>

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.0** (2025-01): å®Œæ•´å®æˆ˜æŒ‡å—
  - è¡¥å……DDLäº‹ä»¶è§¦å‘å™¨å®Œæ•´å®ç°
  - è¡¥å……æ•°æ®åº“çº§äº‹ä»¶è§¦å‘å™¨
  - è¡¥å……å®¡è®¡æ—¥å¿—å®ç°
  - è¡¥å……å®‰å…¨ç­–ç•¥å®æ–½
  - è¡¥å……æ€§èƒ½ç›‘æ§
  - è¡¥å……å®æˆ˜æ¡ˆä¾‹

---

**çŠ¶æ€**: âœ… **æ–‡æ¡£å®Œæˆ** | [è¿”å›ç›®å½•](./README.md)
