# PostgreSQLäº‹åŠ¡è®¿é—®ç¨‹åºè®¾è®¡å®Œæ•´æŒ‡å— - æ­£åç¤ºä¾‹ä¸å¤šç»´åˆ†æ

> **PostgreSQLç‰ˆæœ¬**: 17+/18+
> **é€‚ç”¨åœºæ™¯**: åº”ç”¨å¼€å‘ã€æ•°æ®åº“é›†æˆã€äº‹åŠ¡å¤„ç†
> **éš¾åº¦ç­‰çº§**: â­â­â­â­â­ ä¸“å®¶çº§
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLäº‹åŠ¡è®¿é—®ç¨‹åºè®¾è®¡å®Œæ•´æŒ‡å— - æ­£åç¤ºä¾‹ä¸å¤šç»´åˆ†æ](#postgresqläº‹åŠ¡è®¿é—®ç¨‹åºè®¾è®¡å®Œæ•´æŒ‡å—---æ­£åç¤ºä¾‹ä¸å¤šç»´åˆ†æ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [ğŸ“Š äº‹åŠ¡æ¨¡å¼é€‰å‹å†³ç­–æ ‘](#-äº‹åŠ¡æ¨¡å¼é€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š å¤šè¯­è¨€äº‹åŠ¡å¤„ç†å¯¹æ¯”çŸ©é˜µ](#-å¤šè¯­è¨€äº‹åŠ¡å¤„ç†å¯¹æ¯”çŸ©é˜µ)
  - [ğŸ“Š äº‹åŠ¡éš”ç¦»çº§åˆ«é€‰å‹å†³ç­–æ ‘](#-äº‹åŠ¡éš”ç¦»çº§åˆ«é€‰å‹å†³ç­–æ ‘)
  - [ğŸ“Š äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ](#-äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ)
  - [âœ… æ­£é¢ç¤ºä¾‹ï¼šå¤šè¯­è¨€äº‹åŠ¡å¤„ç†æœ€ä½³å®è·µ](#-æ­£é¢ç¤ºä¾‹å¤šè¯­è¨€äº‹åŠ¡å¤„ç†æœ€ä½³å®è·µ)
    - [ç¤ºä¾‹1: Rust + tokio-postgresï¼ˆä¼˜ç§€è®¾è®¡ï¼‰](#ç¤ºä¾‹1-rust--tokio-postgresä¼˜ç§€è®¾è®¡)
    - [ç¤ºä¾‹2: Go + pgxï¼ˆä¼˜ç§€è®¾è®¡ï¼‰](#ç¤ºä¾‹2-go--pgxä¼˜ç§€è®¾è®¡)
    - [ç¤ºä¾‹3: Python + asyncpgï¼ˆä¼˜ç§€è®¾è®¡ï¼‰](#ç¤ºä¾‹3-python--asyncpgä¼˜ç§€è®¾è®¡)
    - [ç¤ºä¾‹4: JavaScript + pgï¼ˆä¼˜ç§€è®¾è®¡ï¼‰](#ç¤ºä¾‹4-javascript--pgä¼˜ç§€è®¾è®¡)
    - [ç¤ºä¾‹5: TypeScript + Prismaï¼ˆä¼˜ç§€è®¾è®¡ï¼‰](#ç¤ºä¾‹5-typescript--prismaä¼˜ç§€è®¾è®¡)
  - [âŒ åé¢ç¤ºä¾‹ï¼šå¸¸è§è®¾è®¡é”™è¯¯](#-åé¢ç¤ºä¾‹å¸¸è§è®¾è®¡é”™è¯¯)
    - [åä¾‹1: äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°](#åä¾‹1-äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°)
    - [åä¾‹2: é•¿äº‹åŠ¡é—®é¢˜](#åä¾‹2-é•¿äº‹åŠ¡é—®é¢˜)
    - [åä¾‹3: ç¼ºå°‘é”™è¯¯å¤„ç†](#åä¾‹3-ç¼ºå°‘é”™è¯¯å¤„ç†)
    - [åä¾‹4: éš”ç¦»çº§åˆ«é€‰æ‹©ä¸å½“](#åä¾‹4-éš”ç¦»çº§åˆ«é€‰æ‹©ä¸å½“)
    - [åä¾‹5: æ­»é”é—®é¢˜](#åä¾‹5-æ­»é”é—®é¢˜)
  - [ğŸ“Š å¤šç»´åˆ†æè®ºè¯](#-å¤šç»´åˆ†æè®ºè¯)
    - [ç»´åº¦1ï¼šä¸€è‡´æ€§ç»´åº¦](#ç»´åº¦1ä¸€è‡´æ€§ç»´åº¦)
    - [ç»´åº¦2ï¼šæ€§èƒ½ç»´åº¦](#ç»´åº¦2æ€§èƒ½ç»´åº¦)
    - [ç»´åº¦3ï¼šæ˜“ç”¨æ€§ç»´åº¦](#ç»´åº¦3æ˜“ç”¨æ€§ç»´åº¦)
    - [ç»´åº¦4ï¼šé”™è¯¯å¤„ç†ç»´åº¦](#ç»´åº¦4é”™è¯¯å¤„ç†ç»´åº¦)
  - [ğŸ“Š è¯æ˜æ ‘ç½‘ï¼šäº‹åŠ¡ACIDç‰¹æ€§çš„å½¢å¼åŒ–è¯æ˜](#-è¯æ˜æ ‘ç½‘äº‹åŠ¡acidç‰¹æ€§çš„å½¢å¼åŒ–è¯æ˜)
    - [è¯æ˜1ï¼šäº‹åŠ¡åŸå­æ€§çš„å½¢å¼åŒ–è¯æ˜](#è¯æ˜1äº‹åŠ¡åŸå­æ€§çš„å½¢å¼åŒ–è¯æ˜)
    - [è¯æ˜2ï¼šäº‹åŠ¡ä¸€è‡´æ€§çš„å½¢å¼åŒ–è¯æ˜](#è¯æ˜2äº‹åŠ¡ä¸€è‡´æ€§çš„å½¢å¼åŒ–è¯æ˜)
    - [è¯æ˜3ï¼šäº‹åŠ¡éš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜](#è¯æ˜3äº‹åŠ¡éš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜)
    - [è¯æ˜4ï¼šäº‹åŠ¡æŒä¹…æ€§çš„å½¢å¼åŒ–è¯æ˜](#è¯æ˜4äº‹åŠ¡æŒä¹…æ€§çš„å½¢å¼åŒ–è¯æ˜)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((äº‹åŠ¡è®¿é—®ç¨‹åºè®¾è®¡))
    äº‹åŠ¡åŸºç¡€
      ACIDç‰¹æ€§
        åŸå­æ€§
        ä¸€è‡´æ€§
        éš”ç¦»æ€§
        æŒä¹…æ€§
      éš”ç¦»çº§åˆ«
        è¯»æœªæäº¤
        è¯»å·²æäº¤
        å¯é‡å¤è¯»
        å¯ä¸²è¡ŒåŒ–
      äº‹åŠ¡è¾¹ç•Œ
        æ˜¾å¼äº‹åŠ¡
        éšå¼äº‹åŠ¡
        åµŒå¥—äº‹åŠ¡
        ä¿å­˜ç‚¹
    å¤šè¯­è¨€å®ç°
      Rustäº‹åŠ¡å¤„ç†
        tokio-postgres
        sqlx
        å¼‚æ­¥äº‹åŠ¡
        ç±»å‹å®‰å…¨
      Goäº‹åŠ¡å¤„ç†
        database/sql
        pgx
        ä¸Šä¸‹æ–‡ç®¡ç†
        é”™è¯¯å¤„ç†
      Pythonäº‹åŠ¡å¤„ç†
        psycopg2
        asyncpg
        åŒæ­¥äº‹åŠ¡
        å¼‚æ­¥äº‹åŠ¡
      JavaScriptäº‹åŠ¡å¤„ç†
        pg
        postgres.js
        Promiseé“¾
        async/await
      TypeScriptäº‹åŠ¡å¤„ç†
        Prisma
        TypeORM
        ç±»å‹å®‰å…¨
        äº‹åŠ¡API
    äº‹åŠ¡æ¨¡å¼
      æ˜¾å¼äº‹åŠ¡
        BEGIN/COMMIT
        BEGIN/ROLLBACK
        äº‹åŠ¡è¾¹ç•Œæ¸…æ™°
      éšå¼äº‹åŠ¡
        è‡ªåŠ¨æäº¤
        å•è¯­å¥äº‹åŠ¡
        ç®€å•åœºæ™¯
      åµŒå¥—äº‹åŠ¡
        ä¿å­˜ç‚¹æœºåˆ¶
        éƒ¨åˆ†å›æ»š
        å¤æ‚ä¸šåŠ¡
      åˆ†å¸ƒå¼äº‹åŠ¡
        2PC
        SAGA
        æœ€ç»ˆä¸€è‡´æ€§
    é”™è¯¯å¤„ç†
      äº‹åŠ¡å›æ»š
        è‡ªåŠ¨å›æ»š
        æ˜¾å¼å›æ»š
        éƒ¨åˆ†å›æ»š
      é‡è¯•æœºåˆ¶
        æŒ‡æ•°é€€é¿
        æœ€å¤§é‡è¯•æ¬¡æ•°
        å¹‚ç­‰æ€§ä¿è¯
      è¶…æ—¶æ§åˆ¶
        æŸ¥è¯¢è¶…æ—¶
        è¿æ¥è¶…æ—¶
        äº‹åŠ¡è¶…æ—¶
      æ­»é”å¤„ç†
        æ­»é”æ£€æµ‹
        æ­»é”é¿å…
        æ­»é”æ¢å¤
    æ€§èƒ½ä¼˜åŒ–
      äº‹åŠ¡å¤§å°
        å°äº‹åŠ¡åŸåˆ™
        æ‰¹é‡æ“ä½œ
        å‡å°‘é”ç«äº‰
      é”ç«äº‰
        é”ç²’åº¦ä¼˜åŒ–
        é”é¡ºåº
        é”è¶…æ—¶
      è¿æ¥å¤ç”¨
        è¿æ¥æ± 
        è¿æ¥é¢„çƒ­
        è¿æ¥ç›‘æ§
      æ‰¹é‡æ“ä½œ
        æ‰¹é‡æ’å…¥
        æ‰¹é‡æ›´æ–°
        æ‰¹é‡åˆ é™¤
    æœ€ä½³å®è·µ
      äº‹åŠ¡è¾¹ç•Œè®¾è®¡
        æœ€å°äº‹åŠ¡åŸåˆ™
        å¿«é€Ÿäº‹åŠ¡
        é¿å…é•¿äº‹åŠ¡
      å¼‚å¸¸å¤„ç†ç­–ç•¥
        é”™è¯¯åˆ†ç±»
        é‡è¯•ç­–ç•¥
        é™çº§æ–¹æ¡ˆ
      æ€§èƒ½ä¼˜åŒ–æŠ€å·§
        ç´¢å¼•ä½¿ç”¨
        æŸ¥è¯¢ä¼˜åŒ–
        æ‰¹é‡æ“ä½œ
      åæ¨¡å¼é¿å…
        é•¿äº‹åŠ¡
        åµŒå¥—äº‹åŠ¡æ»¥ç”¨
        æ­»é”é£é™©
```

---

## ğŸ“Š äº‹åŠ¡æ¨¡å¼é€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦äº‹åŠ¡å¤„ç†?] --> B{äº‹åŠ¡ç±»å‹?}
    B -->|å•æœºäº‹åŠ¡| C{äº‹åŠ¡å¤æ‚åº¦?}
    B -->|åˆ†å¸ƒå¼äº‹åŠ¡| D[åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼]

    C -->|ç®€å•| E[éšå¼äº‹åŠ¡]
    C -->|ä¸­ç­‰| F[æ˜¾å¼äº‹åŠ¡]
    C -->|å¤æ‚| G[åµŒå¥—äº‹åŠ¡/ä¿å­˜ç‚¹]

    E --> H[ä¼˜åŠ¿: ç®€å•<br/>é€‚ç”¨: å•è¯­å¥æ“ä½œ]
    F --> I[ä¼˜åŠ¿: æ¸…æ™°<br/>é€‚ç”¨: å¤šè¯­å¥æ“ä½œ]
    G --> J[ä¼˜åŠ¿: çµæ´»<br/>é€‚ç”¨: å¤æ‚ä¸šåŠ¡]

    D --> K{ä¸€è‡´æ€§è¦æ±‚?}
    K -->|å¼ºä¸€è‡´| L[2PCä¸¤é˜¶æ®µæäº¤]
    K -->|æœ€ç»ˆä¸€è‡´| M[SAGAæ¨¡å¼]
    K -->|è¡¥å¿æœºåˆ¶| N[TCCæ¨¡å¼]

    L --> O[ä¼˜åŠ¿: å¼ºä¸€è‡´<br/>é€‚ç”¨: é‡‘èç³»ç»Ÿ]
    M --> P[ä¼˜åŠ¿: é«˜å¯ç”¨<br/>é€‚ç”¨: å¾®æœåŠ¡]
    N --> Q[ä¼˜åŠ¿: çµæ´»<br/>é€‚ç”¨: å¤æ‚ä¸šåŠ¡]
```

---

## ğŸ“Š å¤šè¯­è¨€äº‹åŠ¡å¤„ç†å¯¹æ¯”çŸ©é˜µ

| è¯­è¨€ | é©±åŠ¨/æ¡†æ¶ | äº‹åŠ¡API | ç±»å‹å®‰å…¨ | æ€§èƒ½ | æ˜“ç”¨æ€§ | é”™è¯¯å¤„ç† | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **Rust** | tokio-postgres | æ˜¾å¼BEGIN/COMMIT | âœ… | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | ç³»ç»Ÿçº§ã€é«˜æ€§èƒ½ |
| **Rust** | sqlx | æ˜¾å¼BEGIN/COMMIT | âœ… | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | ç±»å‹å®‰å…¨é¡¹ç›® |
| **Go** | database/sql | æ˜¾å¼BEGIN/COMMIT | âœ… | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å¾®æœåŠ¡ã€é«˜å¹¶å‘ |
| **Go** | pgx | æ˜¾å¼BEGIN/COMMIT | âœ… | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | é«˜æ€§èƒ½åº”ç”¨ |
| **Python** | psycopg2 | withè¯­å¥ | âŒ | â­â­â­ | â­â­â­â­â­ | â­â­â­ | ç®€å•åº”ç”¨ |
| **Python** | asyncpg | async with | âŒ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å¼‚æ­¥åº”ç”¨ |
| **JavaScript** | pg | æ˜¾å¼BEGIN/COMMIT | âŒ | â­â­â­ | â­â­â­â­ | â­â­â­ | Node.jsåº”ç”¨ |
| **TypeScript** | Prisma | $transaction | âœ… | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | TypeScripté¡¹ç›® |
| **TypeScript** | TypeORM | æ˜¾å¼äº‹åŠ¡ | âœ… | â­â­â­ | â­â­â­â­ | â­â­â­â­ | ä¼ä¸šåº”ç”¨ |

---

## ğŸ“Š äº‹åŠ¡éš”ç¦»çº§åˆ«é€‰å‹å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦é€‰æ‹©éš”ç¦»çº§åˆ«?] --> B{ä¸€è‡´æ€§è¦æ±‚?}
    B -->|æœ€é«˜| C[Serializable]
    B -->|é«˜| D[Repeatable Read]
    B -->|æ ‡å‡†| E[Read Committed]
    B -->|æœ€ä½| F[Read Uncommitted]

    C --> G{æ€§èƒ½è¦æ±‚?}
    G -->|å¯æ¥å—| H[é€‰æ‹©Serializable]
    G -->|è¦æ±‚é«˜| I[è€ƒè™‘Repeatable Read]

    D --> J{å¹»è¯»å®¹å¿?}
    J -->|ä¸å®¹å¿| K[é€‰æ‹©Repeatable Read]
    J -->|å¯å®¹å¿| L[è€ƒè™‘Read Committed]

    E --> M[ä¼˜åŠ¿: å¹³è¡¡<br/>é€‚ç”¨: å¤§å¤šæ•°åœºæ™¯]
    H --> N[ä¼˜åŠ¿: æœ€å¼ºä¸€è‡´<br/>é€‚ç”¨: é‡‘èç³»ç»Ÿ]
    K --> O[ä¼˜åŠ¿: é˜²æ­¢å¹»è¯»<br/>é€‚ç”¨: æŠ¥è¡¨ç³»ç»Ÿ]
```

---

## ğŸ“Š äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | ä¸€è‡´æ€§ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- | --- |
| **Read Uncommitted** | âŒ å¯èƒ½ | âŒ å¯èƒ½ | âŒ å¯èƒ½ | â­â­â­â­â­ | â­ | ä»…æµ‹è¯•ç¯å¢ƒ |
| **Read Committed** | âœ… é˜²æ­¢ | âŒ å¯èƒ½ | âŒ å¯èƒ½ | â­â­â­â­ | â­â­â­ | å¤§å¤šæ•°åº”ç”¨ï¼ˆPostgreSQLé»˜è®¤ï¼‰ |
| **Repeatable Read** | âœ… é˜²æ­¢ | âœ… é˜²æ­¢ | âŒ å¯èƒ½ | â­â­â­ | â­â­â­â­ | æŠ¥è¡¨ã€åˆ†æç³»ç»Ÿ |
| **Serializable** | âœ… é˜²æ­¢ | âœ… é˜²æ­¢ | âœ… é˜²æ­¢ | â­â­ | â­â­â­â­â­ | é‡‘èã€è´¦åŠ¡ç³»ç»Ÿ |

---

## âœ… æ­£é¢ç¤ºä¾‹ï¼šå¤šè¯­è¨€äº‹åŠ¡å¤„ç†æœ€ä½³å®è·µ

### ç¤ºä¾‹1: Rust + tokio-postgresï¼ˆä¼˜ç§€è®¾è®¡ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- ç±»å‹å®‰å…¨çš„äº‹åŠ¡å¤„ç†
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- å¼‚æ­¥é«˜æ€§èƒ½
- èµ„æºè‡ªåŠ¨ç®¡ç†

**å®ç°ä»£ç **ï¼š

```rust
use tokio_postgres::{Client, NoTls, Error};

// âœ… æ­£ç¡®ï¼šç±»å‹å®‰å…¨çš„äº‹åŠ¡å¤„ç†
async fn transfer_funds(
    client: &mut Client,
    from_account: &str,
    to_account: &str,
    amount: i64,
) -> Result<(), Box<dyn std::error::Error>> {
    let transaction = client.transaction().await?;

    // æ‰£å‡æºè´¦æˆ·ï¼ˆç±»å‹å®‰å…¨ï¼‰
    let rows = transaction
        .query(
            "UPDATE accounts SET balance = balance - $1 WHERE account_id = $2 AND balance >= $1 RETURNING balance",
            &[&amount, &from_account],
        )
        .await?;

    if rows.is_empty() {
        transaction.rollback().await?;
        return Err("ä½™é¢ä¸è¶³".into());
    }

    // å¢åŠ ç›®æ ‡è´¦æˆ·ï¼ˆç±»å‹å®‰å…¨ï¼‰
    transaction
        .execute(
            "UPDATE accounts SET balance = balance + $1 WHERE account_id = $2",
            &[&amount, &to_account],
        )
        .await?;

    // è®°å½•äº¤æ˜“ï¼ˆç±»å‹å®‰å…¨ï¼‰
    transaction
        .execute(
            "INSERT INTO transactions (from_account, to_account, amount) VALUES ($1, $2, $3)",
            &[&from_account, &to_account, &amount],
        )
        .await?;

    transaction.commit().await?;
    Ok(())
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥æ± çš„äº‹åŠ¡å¤„ç†
use deadpool_postgres::{Config, Pool, Runtime};

async fn transfer_funds_with_pool(
    pool: &Pool,
    from_account: &str,
    to_account: &str,
    amount: i64,
) -> Result<(), Box<dyn std::error::Error>> {
    let client = pool.get().await?;
    let transaction = client.transaction().await?;

    // äº‹åŠ¡æ“ä½œ...
    transaction.commit().await?;
    Ok(())
}
```

**è®¾è®¡ä¼˜ç‚¹**ï¼š

1. âœ… **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
2. âœ… **èµ„æºç®¡ç†**ï¼šRAIIè‡ªåŠ¨ç®¡ç†èµ„æº
3. âœ… **é”™è¯¯å¤„ç†**ï¼šResultç±»å‹å¼ºåˆ¶é”™è¯¯å¤„ç†
4. âœ… **å¼‚æ­¥æ€§èƒ½**ï¼štokioå¼‚æ­¥è¿è¡Œæ—¶é«˜æ€§èƒ½

---

### ç¤ºä¾‹2: Go + pgxï¼ˆä¼˜ç§€è®¾è®¡ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- ä¸Šä¸‹æ–‡ç®¡ç†çš„äº‹åŠ¡å¤„ç†
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- é«˜æ€§èƒ½
- èµ„æºè‡ªåŠ¨æ¸…ç†

**å®ç°ä»£ç **ï¼š

```go
package main

import (
    "context"
    "fmt"
    "github.com/jackc/pgx/v5"
)

// âœ… æ­£ç¡®ï¼šä¸Šä¸‹æ–‡ç®¡ç†çš„äº‹åŠ¡å¤„ç†
func TransferFunds(
    ctx context.Context,
    conn *pgx.Conn,
    fromAccount, toAccount string,
    amount int64,
) error {
    tx, err := conn.Begin(ctx)
    if err != nil {
        return fmt.Errorf("å¼€å§‹äº‹åŠ¡å¤±è´¥: %w", err)
    }
    defer tx.Rollback(ctx) // âœ… ç¡®ä¿å›æ»š

    // æ‰£å‡æºè´¦æˆ·
    var balance int64
    err = tx.QueryRow(ctx,
        "UPDATE accounts SET balance = balance - $1 WHERE account_id = $2 AND balance >= $1 RETURNING balance",
        amount, fromAccount,
    ).Scan(&balance)

    if err != nil {
        if err == pgx.ErrNoRows {
            return fmt.Errorf("ä½™é¢ä¸è¶³")
        }
        return fmt.Errorf("æ‰£å‡è´¦æˆ·å¤±è´¥: %w", err)
    }

    // å¢åŠ ç›®æ ‡è´¦æˆ·
    _, err = tx.Exec(ctx,
        "UPDATE accounts SET balance = balance + $1 WHERE account_id = $2",
        amount, toAccount,
    )
    if err != nil {
        return fmt.Errorf("å¢åŠ è´¦æˆ·å¤±è´¥: %w", err)
    }

    // è®°å½•äº¤æ˜“
    _, err = tx.Exec(ctx,
        "INSERT INTO transactions (from_account, to_account, amount) VALUES ($1, $2, $3)",
        fromAccount, toAccount, amount,
    )
    if err != nil {
        return fmt.Errorf("è®°å½•äº¤æ˜“å¤±è´¥: %w", err)
    }

    // âœ… æäº¤äº‹åŠ¡
    if err := tx.Commit(ctx); err != nil {
        return fmt.Errorf("æäº¤äº‹åŠ¡å¤±è´¥: %w", err)
    }

    return nil
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥æ± çš„äº‹åŠ¡å¤„ç†
func TransferFundsWithPool(
    ctx context.Context,
    pool *pgxpool.Pool,
    fromAccount, toAccount string,
    amount int64,
) error {
    conn, err := pool.Acquire(ctx)
    if err != nil {
        return fmt.Errorf("è·å–è¿æ¥å¤±è´¥: %w", err)
    }
    defer conn.Release()

    return TransferFunds(ctx, conn.Conn(), fromAccount, toAccount, amount)
}
```

**è®¾è®¡ä¼˜ç‚¹**ï¼š

1. âœ… **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šæ”¯æŒè¶…æ—¶å’Œå–æ¶ˆ
2. âœ… **deferä¿è¯**ï¼šç¡®ä¿èµ„æºæ¸…ç†
3. âœ… **é”™è¯¯åŒ…è£…**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
4. âœ… **é«˜æ€§èƒ½**ï¼špgxåŸç”Ÿé©±åŠ¨é«˜æ€§èƒ½

---

### ç¤ºä¾‹3: Python + asyncpgï¼ˆä¼˜ç§€è®¾è®¡ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- å¼‚æ­¥äº‹åŠ¡å¤„ç†
- ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- é«˜æ€§èƒ½

**å®ç°ä»£ç **ï¼š

```python
import asyncpg
from typing import Optional

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥äº‹åŠ¡å¤„ç†ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰
async def transfer_funds(
    pool: asyncpg.Pool,
    from_account: str,
    to_account: str,
    amount: int
) -> None:
    async with pool.acquire() as conn:
        async with conn.transaction():
            # æ‰£å‡æºè´¦æˆ·
            result = await conn.fetchrow(
                """
                UPDATE accounts
                SET balance = balance - $1
                WHERE account_id = $2 AND balance >= $1
                RETURNING balance
                """,
                amount, from_account
            )

            if result is None:
                raise ValueError('ä½™é¢ä¸è¶³')

            # å¢åŠ ç›®æ ‡è´¦æˆ·
            await conn.execute(
                "UPDATE accounts SET balance = balance + $1 WHERE account_id = $2",
                amount, to_account
            )

            # è®°å½•äº¤æ˜“
            await conn.execute(
                "INSERT INTO transactions (from_account, to_account, amount) VALUES ($1, $2, $3)",
                from_account, to_account, amount
            )

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¿å­˜ç‚¹çš„åµŒå¥—äº‹åŠ¡
async def complex_transaction(
    pool: asyncpg.Pool,
    account_id: str,
    operations: list
) -> None:
    async with pool.acquire() as conn:
        async with conn.transaction():
            for i, operation in enumerate(operations):
                try:
                    async with conn.transaction() as savepoint:
                        await execute_operation(conn, operation)
                except Exception as e:
                    # âœ… ä¿å­˜ç‚¹å›æ»šï¼Œå¤–å±‚äº‹åŠ¡ç»§ç»­
                    logger.error(f"æ“ä½œ {i} å¤±è´¥: {e}")
                    continue
```

**è®¾è®¡ä¼˜ç‚¹**ï¼š

1. âœ… **ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼šè‡ªåŠ¨ç®¡ç†äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ
2. âœ… **å¼‚æ­¥æ€§èƒ½**ï¼šasyncpgé«˜æ€§èƒ½å¼‚æ­¥é©±åŠ¨
3. âœ… **ä¿å­˜ç‚¹æ”¯æŒ**ï¼šæ”¯æŒåµŒå¥—äº‹åŠ¡å’Œéƒ¨åˆ†å›æ»š
4. âœ… **ç±»å‹æç¤º**ï¼šæ”¯æŒç±»å‹æ£€æŸ¥

---

### ç¤ºä¾‹4: JavaScript + pgï¼ˆä¼˜ç§€è®¾è®¡ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- Promise-basedäº‹åŠ¡å¤„ç†
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è¿æ¥æ± ç®¡ç†
- å¼‚æ­¥/awaitè¯­æ³•

**å®ç°ä»£ç **ï¼š

```javascript
const { Pool } = require('pg');

const pool = new Pool({
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// âœ… æ­£ç¡®ï¼šPromise-basedäº‹åŠ¡å¤„ç†
async function transferFunds(fromAccount, toAccount, amount) {
  const client = await pool.connect();
  try {
    await client.query('BEGIN');

    // æ‰£å‡æºè´¦æˆ·
    const result = await client.query(
      'UPDATE accounts SET balance = balance - $1 WHERE account_id = $2 AND balance >= $1 RETURNING balance',
      [amount, fromAccount]
    );

    if (result.rows.length === 0) {
      throw new Error('ä½™é¢ä¸è¶³');
    }

    // å¢åŠ ç›®æ ‡è´¦æˆ·
    await client.query(
      'UPDATE accounts SET balance = balance + $1 WHERE account_id = $2',
      [amount, toAccount]
    );

    // è®°å½•äº¤æ˜“
    await client.query(
      'INSERT INTO transactions (from_account, to_account, amount) VALUES ($1, $2, $3)',
      [fromAccount, toAccount, amount]
    );

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release(); // âœ… ç¡®ä¿é‡Šæ”¾è¿æ¥
  }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨éš”ç¦»çº§åˆ«çš„äº‹åŠ¡
async function transferFundsWithIsolation(
  fromAccount,
  toAccount,
  amount
) {
  const client = await pool.connect();
  try {
    // âœ… è®¾ç½®éš”ç¦»çº§åˆ«
    await client.query('BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE');

    // äº‹åŠ¡æ“ä½œ...
    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

**è®¾è®¡ä¼˜ç‚¹**ï¼š

1. âœ… **Promiseé“¾**ï¼šæ¸…æ™°çš„å¼‚æ­¥æµç¨‹
2. âœ… **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„try-catch-finally
3. âœ… **è¿æ¥ç®¡ç†**ï¼šç¡®ä¿è¿æ¥é‡Šæ”¾
4. âœ… **éš”ç¦»çº§åˆ«**ï¼šæ”¯æŒè‡ªå®šä¹‰éš”ç¦»çº§åˆ«

---

### ç¤ºä¾‹5: TypeScript + Prismaï¼ˆä¼˜ç§€è®¾è®¡ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- ç±»å‹å®‰å…¨çš„äº‹åŠ¡å¤„ç†
- è‡ªåŠ¨ç±»å‹ç”Ÿæˆ
- ç®€æ´çš„API
- å®Œæ•´çš„é”™è¯¯å¤„ç†

**å®ç°ä»£ç **ï¼š

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// âœ… æ­£ç¡®ï¼šç±»å‹å®‰å…¨çš„äº‹åŠ¡å¤„ç†
async function transferFunds(
  fromAccount: string,
  toAccount: string,
  amount: number
): Promise<void> {
  await prisma.$transaction(async (tx) => {
    // æ‰£å‡æºè´¦æˆ·ï¼ˆç±»å‹å®‰å…¨ï¼‰
    const from = await tx.account.update({
      where: { accountId: fromAccount },
      data: { balance: { decrement: amount } },
    });

    if (from.balance < 0) {
      throw new Error('ä½™é¢ä¸è¶³');
    }

    // å¢åŠ ç›®æ ‡è´¦æˆ·ï¼ˆç±»å‹å®‰å…¨ï¼‰
    await tx.account.update({
      where: { accountId: toAccount },
      data: { balance: { increment: amount } },
    });

    // è®°å½•äº¤æ˜“ï¼ˆç±»å‹å®‰å…¨ï¼‰
    await tx.transaction.create({
      data: {
        fromAccount,
        toAccount,
        amount,
        type: 'TRANSFER',
        status: 'SUCCESS',
      },
    });
  });
}

// âœ… æ­£ç¡®ï¼šå¸¦è¶…æ—¶çš„äº‹åŠ¡å¤„ç†
async function transferFundsWithTimeout(
  fromAccount: string,
  toAccount: string,
  amount: number,
  timeout: number = 5000
): Promise<void> {
  await prisma.$transaction(
    async (tx) => {
      // äº‹åŠ¡æ“ä½œ...
    },
    {
      maxWait: timeout, // æœ€å¤§ç­‰å¾…æ—¶é—´
      timeout: timeout, // äº‹åŠ¡è¶…æ—¶æ—¶é—´
    }
  );
}

// âœ… æ­£ç¡®ï¼šäº¤äº’å¼äº‹åŠ¡ï¼ˆæ›´çµæ´»çš„æ§åˆ¶ï¼‰
async function transferFundsInteractive(
  fromAccount: string,
  toAccount: string,
  amount: number
): Promise<void> {
  await prisma.$transaction(async (tx) => {
    // å¯ä»¥æ‰§è¡Œå¤šä¸ªæ“ä½œ
    const from = await tx.account.findUnique({
      where: { accountId: fromAccount },
    });

    if (!from || from.balance < amount) {
      throw new Error('ä½™é¢ä¸è¶³');
    }

    await tx.account.update({
      where: { accountId: fromAccount },
      data: { balance: { decrement: amount } },
    });

    await tx.account.update({
      where: { accountId: toAccount },
      data: { balance: { increment: amount } },
    });
  });
}
```

**è®¾è®¡ä¼˜ç‚¹**ï¼š

1. âœ… **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
2. âœ… **ç®€æ´API**ï¼š$transactionè‡ªåŠ¨ç®¡ç†äº‹åŠ¡
3. âœ… **è¶…æ—¶æ§åˆ¶**ï¼šæ”¯æŒäº‹åŠ¡è¶…æ—¶é…ç½®
4. âœ… **äº¤äº’å¼äº‹åŠ¡**ï¼šçµæ´»çš„äº‹åŠ¡æ§åˆ¶

---

## âŒ åé¢ç¤ºä¾‹ï¼šå¸¸è§è®¾è®¡é”™è¯¯

### åä¾‹1: äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šäº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°
def bad_transfer(conn, from_account, to_account, amount):
    conn.execute("UPDATE accounts SET balance = balance - %s WHERE account_id = %s", [amount, from_account])
    # âŒ ä¸­é—´æœ‰å…¶ä»–æ“ä½œï¼Œå¯èƒ½å¤±è´¥
    do_something_else()  # å¯èƒ½å¤±è´¥ï¼Œä½†ä¸åœ¨äº‹åŠ¡å†…
    conn.execute("UPDATE accounts SET balance = balance + %s WHERE account_id = %s", [amount, to_account])
    conn.commit()  # å¦‚æœä¸­é—´æ“ä½œå¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ **äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°**ï¼šéƒ¨åˆ†æ“ä½œåœ¨äº‹åŠ¡å¤–
2. âŒ **æ•°æ®ä¸ä¸€è‡´**ï¼šä¸­é—´æ“ä½œå¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
3. âŒ **éš¾ä»¥è°ƒè¯•**ï¼šæ— æ³•ç¡®å®šå“ªäº›æ“ä½œåœ¨äº‹åŠ¡å†…

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```python
# âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„äº‹åŠ¡è¾¹ç•Œ
async def good_transfer(pool, from_account, to_account, amount):
    async with pool.acquire() as conn:
        async with conn.transaction():
            await conn.execute(
                "UPDATE accounts SET balance = balance - %s WHERE account_id = %s",
                [amount, from_account]
            )
            # âœ… æ‰€æœ‰æ“ä½œåœ¨äº‹åŠ¡å†…
            await do_something_else(conn)  # ä¼ å…¥è¿æ¥ï¼Œç¡®ä¿åœ¨äº‹åŠ¡å†…
            await conn.execute(
                "UPDATE accounts SET balance = balance + %s WHERE account_id = %s",
                [amount, to_account]
            )
```

---

### åä¾‹2: é•¿äº‹åŠ¡é—®é¢˜

**é”™è¯¯è®¾è®¡**ï¼š

```go
// âŒ é”™è¯¯ï¼šäº‹åŠ¡æ—¶é—´è¿‡é•¿
func badLongTransaction(tx pgx.Tx) error {
    // æ•°æ®åº“æ“ä½œ
    tx.Exec("UPDATE accounts SET ...")

    // âŒ å¤–éƒ¨APIè°ƒç”¨ï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
    http.Get("https://external-api.com/...")  // é˜»å¡äº‹åŠ¡

    // æ›´å¤šæ•°æ®åº“æ“ä½œ
    tx.Exec("UPDATE accounts SET ...")
    return nil
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ **é•¿äº‹åŠ¡**ï¼šå¤–éƒ¨è°ƒç”¨é˜»å¡äº‹åŠ¡
2. âŒ **æ­»é”é£é™©**ï¼šé•¿æ—¶é—´æŒæœ‰é”
3. âŒ **æ€§èƒ½é—®é¢˜**ï¼šé˜»å¡å…¶ä»–äº‹åŠ¡
4. âŒ **èµ„æºæµªè´¹**ï¼šé•¿æ—¶é—´å ç”¨è¿æ¥

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```go
// âœ… æ­£ç¡®ï¼šå¿«é€Ÿäº‹åŠ¡ï¼Œå¤–éƒ¨è°ƒç”¨åœ¨äº‹åŠ¡å¤–
func goodTransaction(tx pgx.Tx) error {
    tx.Exec("UPDATE accounts SET ...")
    tx.Exec("UPDATE accounts SET ...")
    return nil
}

func goodFlow(ctx context.Context, conn *pgx.Conn) error {
    tx, _ := conn.Begin(ctx)
    defer tx.Rollback(ctx)

    goodTransaction(tx)
    tx.Commit(ctx)

    // âœ… å¤–éƒ¨è°ƒç”¨åœ¨äº‹åŠ¡å¤–
    http.Get("https://external-api.com/...")
    return nil
}
```

---

### åä¾‹3: ç¼ºå°‘é”™è¯¯å¤„ç†

**é”™è¯¯è®¾è®¡**ï¼š

```rust
// âŒ é”™è¯¯ï¼šç¼ºå°‘é”™è¯¯å¤„ç†
async fn bad_transfer(client: &mut Client, from: &str, to: &str, amount: i64) {
    let tx = client.transaction().await.unwrap();
    tx.execute("UPDATE accounts SET balance = balance - $1 WHERE account_id = $2", &[&amount, &from]).await.unwrap();
    tx.execute("UPDATE accounts SET balance = balance + $1 WHERE account_id = $2", &[&amount, &to]).await.unwrap();
    tx.commit().await.unwrap();
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ **panicé£é™©**ï¼šunwrap()å¯èƒ½å¯¼è‡´panic
2. âŒ **äº‹åŠ¡ä¸ä¸€è‡´**ï¼šé”™è¯¯æ—¶äº‹åŠ¡ä¸ä¼šå›æ»š
3. âŒ **èµ„æºæ³„æ¼**ï¼šé”™è¯¯æ—¶èµ„æºä¸ä¼šé‡Šæ”¾

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```rust
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†
async fn good_transfer(
    client: &mut Client,
    from: &str,
    to: &str,
    amount: i64,
) -> Result<(), Box<dyn std::error::Error>> {
    let tx = client.transaction().await?;

    match tx.execute(
        "UPDATE accounts SET balance = balance - $1 WHERE account_id = $2 AND balance >= $1",
        &[&amount, &from],
    ).await {
        Ok(rows) if rows > 0 => {},
        _ => {
            tx.rollback().await?;
            return Err("ä½™é¢ä¸è¶³".into());
        }
    }

    tx.execute(
        "UPDATE accounts SET balance = balance + $1 WHERE account_id = $2",
        &[&amount, &to],
    ).await?;

    tx.commit().await?;
    Ok(())
}
```

---

### åä¾‹4: éš”ç¦»çº§åˆ«é€‰æ‹©ä¸å½“

**é”™è¯¯è®¾è®¡**ï¼š

```javascript
// âŒ é”™è¯¯ï¼šéš”ç¦»çº§åˆ«é€‰æ‹©ä¸å½“
async function badQuery() {
  const client = await pool.connect();
  try {
    // âŒ ä½¿ç”¨Read Uncommittedï¼ˆPostgreSQLä¸æ”¯æŒï¼Œä½†æ¦‚å¿µä¸Šé”™è¯¯ï¼‰
    await client.query('BEGIN TRANSACTION ISOLATION LEVEL READ UNCOMMITTED');

    // è¯»å–å¯èƒ½æœªæäº¤çš„æ•°æ®
    const result = await client.query('SELECT * FROM accounts');

    await client.query('COMMIT');
  } finally {
    client.release();
  }
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ **æ•°æ®ä¸ä¸€è‡´**ï¼šå¯èƒ½è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
2. âŒ **è„è¯»é£é™©**ï¼šæ•°æ®å¯èƒ½è¢«å›æ»š
3. âŒ **ä¸šåŠ¡é€»è¾‘é”™è¯¯**ï¼šåŸºäºè„æ•°æ®åšå†³ç­–

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©é€‚å½“çš„éš”ç¦»çº§åˆ«
async function goodQuery() {
  const client = await pool.connect();
  try {
    // âœ… é‡‘èç³»ç»Ÿä½¿ç”¨Serializable
    await client.query('BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE');

    const result = await client.query('SELECT * FROM accounts');

    await client.query('COMMIT');
  } finally {
    client.release();
  }
}

// âœ… æ­£ç¡®ï¼šå¤§å¤šæ•°åœºæ™¯ä½¿ç”¨Read Committedï¼ˆPostgreSQLé»˜è®¤ï¼‰
async function goodQueryDefault() {
  const client = await pool.connect();
  try {
    // âœ… ä½¿ç”¨é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆRead Committedï¼‰
    await client.query('BEGIN');

    const result = await client.query('SELECT * FROM accounts');

    await client.query('COMMIT');
  } finally {
    client.release();
  }
}
```

---

### åä¾‹5: æ­»é”é—®é¢˜

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šé”é¡ºåºä¸ä¸€è‡´ï¼Œå®¹æ˜“æ­»é”
async def bad_transfer1(pool, account1, account2, amount):
    async with pool.acquire() as conn:
        async with conn.transaction():
            # âŒ å…ˆé”account1
            await conn.execute("SELECT * FROM accounts WHERE id = $1 FOR UPDATE", account1)
            await asyncio.sleep(1)  # æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œ
            await conn.execute("SELECT * FROM accounts WHERE id = $2 FOR UPDATE", account2)

async def bad_transfer2(pool, account1, account2, amount):
    async with pool.acquire() as conn:
        async with conn.transaction():
            # âŒ å…ˆé”account2ï¼ˆé¡ºåºä¸ä¸€è‡´ï¼‰
            await conn.execute("SELECT * FROM accounts WHERE id = $2 FOR UPDATE", account2)
            await asyncio.sleep(1)
            await conn.execute("SELECT * FROM accounts WHERE id = $1 FOR UPDATE", account1)
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ **æ­»é”é£é™©**ï¼šé”é¡ºåºä¸ä¸€è‡´
2. âŒ **æ€§èƒ½é—®é¢˜**ï¼šé•¿æ—¶é—´æŒæœ‰é”
3. âŒ **ç³»ç»Ÿé˜»å¡**ï¼šæ­»é”å¯¼è‡´ç³»ç»Ÿé˜»å¡

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```python
# âœ… æ­£ç¡®ï¼šç»Ÿä¸€çš„é”é¡ºåº
async def good_transfer(pool, account1, account2, amount):
    # âœ… ç¡®ä¿é”é¡ºåºä¸€è‡´ï¼ˆæŒ‰IDæ’åºï¼‰
    accounts = sorted([account1, account2])

    async with pool.acquire() as conn:
        async with conn.transaction():
            # âœ… æŒ‰ç»Ÿä¸€é¡ºåºåŠ é”
            for account in accounts:
                await conn.execute("SELECT * FROM accounts WHERE id = $1 FOR UPDATE", account)

            # æ‰§è¡Œè½¬è´¦æ“ä½œ
            await conn.execute("UPDATE accounts SET balance = balance - $1 WHERE id = $2", [amount, account1])
            await conn.execute("UPDATE accounts SET balance = balance + $1 WHERE id = $2", [amount, account2])
```

---

## ğŸ“Š å¤šç»´åˆ†æè®ºè¯

### ç»´åº¦1ï¼šä¸€è‡´æ€§ç»´åº¦

**ä¸€è‡´æ€§ä¿è¯å¯¹æ¯”åˆ†æ**ï¼š

| è¯­è¨€/æ¡†æ¶ | ACIDä¿è¯ | éš”ç¦»çº§åˆ«æ”¯æŒ | ä¸€è‡´æ€§æ£€æŸ¥ | çº¦æŸæ”¯æŒ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- |
| **Rust + tokio-postgres** | âœ… å®Œæ•´ | âœ… å…¨éƒ¨ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | ç³»ç»Ÿçº§åº”ç”¨ |
| **Go + pgx** | âœ… å®Œæ•´ | âœ… å…¨éƒ¨ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | å¾®æœåŠ¡ |
| **Python + asyncpg** | âœ… å®Œæ•´ | âœ… å…¨éƒ¨ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | å¼‚æ­¥åº”ç”¨ |
| **JavaScript + pg** | âœ… å®Œæ•´ | âœ… å…¨éƒ¨ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | Node.jsåº”ç”¨ |
| **TypeScript + Prisma** | âœ… å®Œæ•´ | âœ… å…¨éƒ¨ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | TypeScripté¡¹ç›® |

**ä¸€è‡´æ€§ä¿è¯æœºåˆ¶**ï¼š

1. âœ… **ACIDç‰¹æ€§**ï¼šæ‰€æœ‰è¯­è¨€éƒ½æ”¯æŒPostgreSQLçš„ACIDç‰¹æ€§
2. âœ… **éš”ç¦»çº§åˆ«**ï¼šæ”¯æŒæ‰€æœ‰PostgreSQLéš”ç¦»çº§åˆ«
3. âœ… **çº¦æŸæ£€æŸ¥**ï¼šå¤–é”®ã€æ£€æŸ¥çº¦æŸç­‰åœ¨äº‹åŠ¡å†…æ‰§è¡Œ
4. âœ… **è§¦å‘å™¨**ï¼šè§¦å‘å™¨åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œä¿è¯ä¸€è‡´æ€§

---

### ç»´åº¦2ï¼šæ€§èƒ½ç»´åº¦

**æ€§èƒ½å¯¹æ¯”åˆ†æ**ï¼š

| è¯­è¨€/æ¡†æ¶ | äº‹åŠ¡å¼€é”€ | å¹¶å‘æ€§èƒ½ | å»¶è¿Ÿ | ååé‡ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- | --- |
| **Rust + tokio-postgres** | â­â­â­â­â­ | â­â­â­â­â­ | 0.1-1ms | 50,000+ TPS | æè‡´æ€§èƒ½ |
| **Go + pgx** | â­â­â­â­ | â­â­â­â­â­ | 0.5-2ms | 30,000+ TPS | é«˜å¹¶å‘ |
| **Python + asyncpg** | â­â­â­â­ | â­â­â­â­ | 1-3ms | 20,000+ TPS | å¼‚æ­¥åº”ç”¨ |
| **JavaScript + pg** | â­â­â­ | â­â­â­ | 2-5ms | 10,000+ TPS | é€šç”¨åº”ç”¨ |
| **TypeScript + Prisma** | â­â­â­ | â­â­â­ | 3-8ms | 8,000+ TPS | ç±»å‹å®‰å…¨é¡¹ç›® |

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

1. âœ… **è¿æ¥æ± ä¼˜åŒ–**ï¼šåˆç†é…ç½®è¿æ¥æ± å¤§å°
2. âœ… **æ‰¹é‡æ“ä½œ**ï¼šå‡å°‘äº‹åŠ¡æ•°é‡
3. âœ… **å¿«é€Ÿäº‹åŠ¡**ï¼šé¿å…é•¿äº‹åŠ¡
4. âœ… **ç´¢å¼•ä½¿ç”¨**ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

---

### ç»´åº¦3ï¼šæ˜“ç”¨æ€§ç»´åº¦

**æ˜“ç”¨æ€§å¯¹æ¯”åˆ†æ**ï¼š

| è¯­è¨€/æ¡†æ¶ | APIç®€æ´æ€§ | å­¦ä¹ æ›²çº¿ | æ–‡æ¡£è´¨é‡ | IDEæ”¯æŒ | å¼€å‘æ•ˆç‡ |
| --- | --- | --- | --- | --- | --- |
| **Rust + tokio-postgres** | â­â­â­ | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **Go + pgx** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **Python + asyncpg** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **JavaScript + pg** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **TypeScript + Prisma** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

**æ˜“ç”¨æ€§æå‡ç­–ç•¥**ï¼š

1. âœ… **ORMæ¡†æ¶**ï¼šä½¿ç”¨ORMç®€åŒ–ä»£ç 
2. âœ… **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨TypeScriptæä¾›ç±»å‹å®‰å…¨
3. âœ… **ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼šè‡ªåŠ¨ç®¡ç†èµ„æº
4. âœ… **é”™è¯¯å¤„ç†**ï¼šæ¸…æ™°çš„é”™è¯¯å¤„ç†æœºåˆ¶

---

### ç»´åº¦4ï¼šé”™è¯¯å¤„ç†ç»´åº¦

**é”™è¯¯å¤„ç†å¯¹æ¯”åˆ†æ**ï¼š

| è¯­è¨€/æ¡†æ¶ | é”™è¯¯ç±»å‹ | é”™è¯¯ä¼ æ’­ | é‡è¯•æœºåˆ¶ | è¶…æ—¶æ§åˆ¶ | é”™è¯¯ä¿¡æ¯ |
| --- | --- | --- | --- | --- | --- |
| **Rust + tokio-postgres** | âœ… Resultç±»å‹ | âœ… æ˜¾å¼ä¼ æ’­ | âš ï¸ æ‰‹åŠ¨å®ç° | âœ… æ”¯æŒ | â­â­â­â­ |
| **Go + pgx** | âœ… erroræ¥å£ | âœ… æ˜¾å¼ä¼ æ’­ | âš ï¸ æ‰‹åŠ¨å®ç° | âœ… æ”¯æŒ | â­â­â­â­ |
| **Python + asyncpg** | âœ… å¼‚å¸¸ | âœ… è‡ªåŠ¨ä¼ æ’­ | âš ï¸ æ‰‹åŠ¨å®ç° | âœ… æ”¯æŒ | â­â­â­ |
| **JavaScript + pg** | âœ… å¼‚å¸¸ | âœ… è‡ªåŠ¨ä¼ æ’­ | âš ï¸ æ‰‹åŠ¨å®ç° | âœ… æ”¯æŒ | â­â­â­ |
| **TypeScript + Prisma** | âœ… å¼‚å¸¸ | âœ… è‡ªåŠ¨ä¼ æ’­ | âœ… å†…ç½® | âœ… æ”¯æŒ | â­â­â­â­â­ |

**é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**ï¼š

1. âœ… **é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
2. âœ… **é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿é‡è¯•
3. âœ… **è¶…æ—¶æ§åˆ¶**ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
4. âœ… **é”™è¯¯æ—¥å¿—**ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“Š è¯æ˜æ ‘ç½‘ï¼šäº‹åŠ¡ACIDç‰¹æ€§çš„å½¢å¼åŒ–è¯æ˜

### è¯æ˜1ï¼šäº‹åŠ¡åŸå­æ€§çš„å½¢å¼åŒ–è¯æ˜

**è¯æ˜ç›®æ ‡**ï¼šè¯æ˜äº‹åŠ¡æ“ä½œæ»¡è¶³åŸå­æ€§ï¼ˆAtomicityï¼‰

**è¯æ˜ç»“æ„**ï¼š

```mermaid
graph TD
    A[äº‹åŠ¡åŸå­æ€§è¯æ˜] --> B[å‰ææ¡ä»¶]
    A --> C[è¯æ˜æ­¥éª¤]
    A --> D[ç»“è®º]

    B --> B1[äº‹åŠ¡ç”±BEGINå¼€å§‹]
    B --> B2[æ‰€æœ‰æ“ä½œåœ¨äº‹åŠ¡å†…]
    B --> B3[COMMITæˆ–ROLLBACKç»“æŸ]

    C --> C1[æ­¥éª¤1: è¯æ˜BEGINçš„åŸå­æ€§]
    C --> C2[æ­¥éª¤2: è¯æ˜æ“ä½œçš„åŸå­æ€§]
    C --> C3[æ­¥éª¤3: è¯æ˜COMMIT/ROLLBACKçš„åŸå­æ€§]

    C1 --> C1A[BEGINåˆ›å»ºäº‹åŠ¡ä¸Šä¸‹æ–‡]
    C1 --> C1B[äº‹åŠ¡IDåˆ†é…æ˜¯åŸå­çš„]
    C1 --> C1C[çŠ¶æ€å˜æ›´åœ¨ä¸´ç•ŒåŒºå†…]

    C2 --> C2A[æ‰€æœ‰æ“ä½œè®°å½•åœ¨WAL]
    C2 --> C2B[æ“ä½œå¯ä»¥å…¨éƒ¨å›æ»š]
    C2 --> C2C[æ“ä½œçŠ¶æ€ä¸€è‡´]

    C3 --> C3A[COMMIT: æ‰€æœ‰æ“ä½œç”Ÿæ•ˆ]
    C3 --> C3B[ROLLBACK: æ‰€æœ‰æ“ä½œæ’¤é”€]
    C3 --> C3C[çŠ¶æ€å˜æ›´æ˜¯åŸå­çš„]

    D --> D1[äº‹åŠ¡æ»¡è¶³åŸå­æ€§]
    D --> D2[è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥]
```

**å½¢å¼åŒ–è¯æ˜**ï¼š

```text
å®šç†ï¼šäº‹åŠ¡åŸå­æ€§

å‰æï¼š
  P1: äº‹åŠ¡Tç”±BEGINå¼€å§‹
  P2: æ‰€æœ‰æ“ä½œO_iåœ¨äº‹åŠ¡Tå†…
  P3: äº‹åŠ¡Tä»¥COMMITæˆ–ROLLBACKç»“æŸ

å®šä¹‰ï¼š
  A(T) = {O_1, O_2, ..., O_n}  // äº‹åŠ¡Tçš„æ‰€æœ‰æ“ä½œ

è¯æ˜ï¼š
  æƒ…å†µ1ï¼šCOMMITæˆåŠŸ
    - æ‰€æœ‰æ“ä½œO_iåœ¨WALä¸­è®°å½•
    - COMMITæ ‡è®°æ‰€æœ‰æ“ä½œä¸ºå·²æäº¤
    - æ‰€æœ‰æ“ä½œçŠ¶æ€å˜æ›´ç”Ÿæ•ˆ
    - ç»“è®ºï¼šæ‰€æœ‰æ“ä½œæˆåŠŸï¼ˆåŸå­æ€§æ»¡è¶³ï¼‰

  æƒ…å†µ2ï¼šROLLBACKæˆ–å¤±è´¥
    - æ£€æµ‹åˆ°é”™è¯¯æˆ–æ˜¾å¼ROLLBACK
    - æ‰€æœ‰æ“ä½œO_içš„çŠ¶æ€å˜æ›´æ’¤é”€
    - WALä¸­çš„æ“ä½œæ ‡è®°ä¸ºå›æ»š
    - ç»“è®ºï¼šæ‰€æœ‰æ“ä½œå¤±è´¥ï¼ˆåŸå­æ€§æ»¡è¶³ï¼‰

  æƒ…å†µ3ï¼šéƒ¨åˆ†æ“ä½œæˆåŠŸï¼ˆä¸å¯èƒ½ï¼‰
    - å‡è®¾ï¼šæ“ä½œO_1æˆåŠŸï¼ŒO_2å¤±è´¥
    - ä½†æ‰€æœ‰æ“ä½œåœ¨äº‹åŠ¡å†…ï¼ŒçŠ¶æ€å˜æ›´åœ¨COMMITå‰ä¸å¯è§
    - å¦‚æœO_2å¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»šï¼ŒO_1çš„çŠ¶æ€å˜æ›´ä¹Ÿæ’¤é”€
    - çŸ›ç›¾ï¼šä¸å­˜åœ¨éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µ

ç»“è®ºï¼š
  C1: äº‹åŠ¡æ»¡è¶³åŸå­æ€§
  C2: è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
```

---

### è¯æ˜2ï¼šäº‹åŠ¡ä¸€è‡´æ€§çš„å½¢å¼åŒ–è¯æ˜

**è¯æ˜ç›®æ ‡**ï¼šè¯æ˜äº‹åŠ¡æ“ä½œæ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰

**è¯æ˜ç»“æ„**ï¼š

```mermaid
graph TD
    A[äº‹åŠ¡ä¸€è‡´æ€§è¯æ˜] --> B[å‰ææ¡ä»¶]
    A --> C[è¯æ˜æ­¥éª¤]
    A --> D[ç»“è®º]

    B --> B1[æ•°æ®åº“æœ‰å®Œæ•´æ€§çº¦æŸC]
    B --> B2[äº‹åŠ¡å¼€å§‹å‰æ•°æ®åº“çŠ¶æ€ä¸€è‡´]
    B --> B3[çº¦æŸæ£€æŸ¥åœ¨äº‹åŠ¡å†…]

    C --> C1[æ­¥éª¤1: è¯æ˜çº¦æŸæ£€æŸ¥]
    C --> C2[æ­¥éª¤2: è¯æ˜çŠ¶æ€ä¸€è‡´æ€§]
    C --> C3[æ­¥éª¤3: è¯æ˜äº‹åŠ¡åä¸€è‡´æ€§]

    C1 --> C1A[å¤–é”®çº¦æŸæ£€æŸ¥]
    C1 --> C1B[æ£€æŸ¥çº¦æŸéªŒè¯]
    C1 --> C1C[å”¯ä¸€çº¦æŸæ£€æŸ¥]

    C2 --> C2A[äº‹åŠ¡å†…çŠ¶æ€å˜æ›´]
    C2 --> C2B[ä¸­é—´çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´]
    C2 --> C2C[ä½†å¯¹å¤–ä¸å¯è§]

    C3 --> C3A[COMMITå‰æ£€æŸ¥æ‰€æœ‰çº¦æŸ]
    C3 --> C3B[çº¦æŸè¿ååˆ™å›æ»š]
    C3 --> C3C[COMMITåçŠ¶æ€ä¸€è‡´]

    D --> D1[äº‹åŠ¡æ»¡è¶³ä¸€è‡´æ€§]
    D --> D2[äº‹åŠ¡å‰åæ•°æ®åº“çŠ¶æ€ä¸€è‡´]
```

**å½¢å¼åŒ–è¯æ˜**ï¼š

```text
å®šç†ï¼šäº‹åŠ¡ä¸€è‡´æ€§

å‰æï¼š
  P1: æ•°æ®åº“æœ‰å®Œæ•´æ€§çº¦æŸé›†åˆC = {c_1, c_2, ..., c_n}
  P2: äº‹åŠ¡å¼€å§‹å‰ï¼šâˆ€c_i âˆˆ C, c_i(D) = true
  P3: çº¦æŸæ£€æŸ¥åœ¨äº‹åŠ¡å†…æ‰§è¡Œ

å®šä¹‰ï¼š
  D_before: äº‹åŠ¡å¼€å§‹å‰çš„æ•°æ®åº“çŠ¶æ€
  D_after: äº‹åŠ¡ç»“æŸåçš„æ•°æ®åº“çŠ¶æ€
  D_during: äº‹åŠ¡æ‰§è¡Œä¸­çš„æ•°æ®åº“çŠ¶æ€

è¯æ˜ï¼š
  æ­¥éª¤1ï¼šäº‹åŠ¡å¼€å§‹å‰ä¸€è‡´æ€§
    - D_beforeæ»¡è¶³æ‰€æœ‰çº¦æŸC
    - ç»“è®ºï¼šåˆå§‹çŠ¶æ€ä¸€è‡´

  æ­¥éª¤2ï¼šäº‹åŠ¡æ‰§è¡Œä¸­
    - æ“ä½œå¯èƒ½äº§ç”Ÿä¸­é—´çŠ¶æ€D_during
    - D_duringå¯èƒ½ä¸æ»¡è¶³æŸäº›çº¦æŸï¼ˆä¸´æ—¶ä¸ä¸€è‡´ï¼‰
    - ä½†D_duringå¯¹å¤–ä¸å¯è§ï¼ˆéš”ç¦»æ€§ä¿è¯ï¼‰
    - ç»“è®ºï¼šä¸­é—´ä¸ä¸€è‡´ä¸å½±å“å¤–éƒ¨

  æ­¥éª¤3ï¼šCOMMITå‰çº¦æŸæ£€æŸ¥
    - æ£€æŸ¥æ‰€æœ‰çº¦æŸc_i âˆˆ C
    - å¦‚æœâˆƒc_i, c_i(D_after) = false
      â†’ äº‹åŠ¡å›æ»šï¼ŒD_after = D_before
    - å¦‚æœâˆ€c_i, c_i(D_after) = true
      â†’ äº‹åŠ¡æäº¤ï¼ŒD_afterç”Ÿæ•ˆ

  æ­¥éª¤4ï¼šäº‹åŠ¡ç»“æŸåä¸€è‡´æ€§
    - å¦‚æœCOMMITï¼šD_afteræ»¡è¶³æ‰€æœ‰çº¦æŸ
    - å¦‚æœROLLBACKï¼šD_after = D_beforeï¼Œæ»¡è¶³æ‰€æœ‰çº¦æŸ
    - ç»“è®ºï¼šäº‹åŠ¡åçŠ¶æ€ä¸€è‡´

ç»“è®ºï¼š
  C1: äº‹åŠ¡æ»¡è¶³ä¸€è‡´æ€§
  C2: äº‹åŠ¡å‰åæ•°æ®åº“çŠ¶æ€ä¸€è‡´
```

---

### è¯æ˜3ï¼šäº‹åŠ¡éš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜

**è¯æ˜ç›®æ ‡**ï¼šè¯æ˜äº‹åŠ¡æ“ä½œæ»¡è¶³éš”ç¦»æ€§ï¼ˆIsolationï¼‰

**è¯æ˜ç»“æ„**ï¼š

```mermaid
graph TD
    A[äº‹åŠ¡éš”ç¦»æ€§è¯æ˜] --> B[å‰ææ¡ä»¶]
    A --> C[è¯æ˜æ­¥éª¤]
    A --> D[ç»“è®º]

    B --> B1[ä½¿ç”¨MVCCæœºåˆ¶]
    B --> B2[æ¯ä¸ªäº‹åŠ¡æœ‰å¿«ç…§]
    B --> B3[éš”ç¦»çº§åˆ«å®šä¹‰å¯è§æ€§]

    C --> C1[æ­¥éª¤1: è¯æ˜å¿«ç…§éš”ç¦»]
    C --> C2[æ­¥éª¤2: è¯æ˜å†™å†™éš”ç¦»]
    C --> C3[æ­¥éª¤3: è¯æ˜éš”ç¦»çº§åˆ«]

    C1 --> C1A[äº‹åŠ¡T_iæœ‰å¿«ç…§S_i]
    C1 --> C1B[S_iåŒ…å«å·²æäº¤çš„ç‰ˆæœ¬]
    C1 --> C1C[æœªæäº¤çš„ç‰ˆæœ¬ä¸å¯è§]

    C2 --> C2A[å†™æ“ä½œè·å–è¡Œé”]
    C2 --> C2B[åŒä¸€è¡Œåªèƒ½ä¸€ä¸ªå†™]
    C2 --> C2C[å†™å†™å†²çªè¢«é˜»æ­¢]

    C3 --> C3A[Read Committed: è¯­å¥çº§å¿«ç…§]
    C3 --> C3B[Repeatable Read: äº‹åŠ¡çº§å¿«ç…§]
    C3 --> C3C[Serializable: åºåˆ—åŒ–éš”ç¦»]

    D --> D1[äº‹åŠ¡æ»¡è¶³éš”ç¦»æ€§]
    D --> D2[å¹¶å‘äº‹åŠ¡äº’ä¸å¹²æ‰°]
```

**å½¢å¼åŒ–è¯æ˜**ï¼š

```text
å®šç†ï¼šäº‹åŠ¡éš”ç¦»æ€§

å‰æï¼š
  P1: ä½¿ç”¨MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰
  P2: æ¯ä¸ªäº‹åŠ¡T_iæœ‰å¿«ç…§S_i
  P3: éš”ç¦»çº§åˆ«ILå®šä¹‰å¯è§æ€§è§„åˆ™

å®šä¹‰ï¼š
  T_i: äº‹åŠ¡i
  S_i: äº‹åŠ¡T_içš„å¿«ç…§
  V(t, x): å…ƒç»„xåœ¨æ—¶é—´tçš„ç‰ˆæœ¬
  committed(V): ç‰ˆæœ¬Vå·²æäº¤

è¯æ˜ï¼š
  æ­¥éª¤1ï¼šå¿«ç…§éš”ç¦»
    - äº‹åŠ¡T_iå¼€å§‹æ—¶è·å–å¿«ç…§S_i
    - S_iåŒ…å«ï¼šæ‰€æœ‰åœ¨T_iå¼€å§‹å‰å·²æäº¤çš„ç‰ˆæœ¬
    - è¯»æ“ä½œä»S_iè¯»å–ï¼Œä¸å—å…¶ä»–äº‹åŠ¡å½±å“
    - ç»“è®ºï¼šè¯»æ“ä½œéš”ç¦»

  æ­¥éª¤2ï¼šå†™å†™éš”ç¦»
    - å†™æ“ä½œéœ€è¦è·å–è¡Œé”L(x)
    - å¦‚æœL(x)è¢«å…¶ä»–äº‹åŠ¡æŒæœ‰ï¼Œç­‰å¾…æˆ–å†²çª
    - åŒä¸€è¡ŒxåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå†™æ“ä½œ
    - ç»“è®ºï¼šå†™æ“ä½œéš”ç¦»

  æ­¥éª¤3ï¼šéš”ç¦»çº§åˆ«ä¿è¯
    Read Committed:
      - æ¯æ¡è¯­å¥è·å–æ–°å¿«ç…§
      - é˜²æ­¢è„è¯»
      - ç»“è®ºï¼šæ»¡è¶³Read Committedéš”ç¦»æ€§

    Repeatable Read:
      - äº‹åŠ¡çº§å¿«ç…§
      - é˜²æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»
      - ç»“è®ºï¼šæ»¡è¶³Repeatable Readéš”ç¦»æ€§

    Serializable:
      - SSIï¼ˆå¯åºåˆ—åŒ–å¿«ç…§éš”ç¦»ï¼‰
      - æ£€æµ‹è¯»å†™ä¾èµ–ï¼Œé˜²æ­¢å¹»è¯»
      - ç»“è®ºï¼šæ»¡è¶³Serializableéš”ç¦»æ€§

ç»“è®ºï¼š
  C1: äº‹åŠ¡æ»¡è¶³éš”ç¦»æ€§
  C2: å¹¶å‘äº‹åŠ¡äº’ä¸å¹²æ‰°
```

---

### è¯æ˜4ï¼šäº‹åŠ¡æŒä¹…æ€§çš„å½¢å¼åŒ–è¯æ˜

**è¯æ˜ç›®æ ‡**ï¼šè¯æ˜äº‹åŠ¡æ“ä½œæ»¡è¶³æŒä¹…æ€§ï¼ˆDurabilityï¼‰

**è¯æ˜ç»“æ„**ï¼š

```mermaid
graph TD
    A[äº‹åŠ¡æŒä¹…æ€§è¯æ˜] --> B[å‰ææ¡ä»¶]
    A --> C[è¯æ˜æ­¥éª¤]
    A --> D[ç»“è®º]

    B --> B1[ä½¿ç”¨WALé¢„å†™æ—¥å¿—]
    B --> B2[COMMITå‰æ—¥å¿—åˆ·ç›˜]
    B --> B3[Checkpointæœºåˆ¶]

    C --> C1[æ­¥éª¤1: è¯æ˜WALä¿è¯]
    C --> C2[æ­¥éª¤2: è¯æ˜æ—¥å¿—åˆ·ç›˜]
    C --> C3[æ­¥éª¤3: è¯æ˜æ¢å¤èƒ½åŠ›]

    C1 --> C1A[æ‰€æœ‰æ“ä½œå†™å…¥WAL]
    C1 --> C1B[WALé¡ºåºå†™å…¥]
    C1 --> C1C[WALåŒ…å«å®Œæ•´ä¿¡æ¯]

    C2 --> C2A[COMMITå‰fsync WAL]
    C2 --> C2B[æ—¥å¿—æŒä¹…åŒ–åˆ°ç£ç›˜]
    C2 --> C2C[æ•°æ®å¯ä»¥æ¢å¤]

    C3 --> C3A[ç³»ç»Ÿå´©æºƒå]
    C3 --> C3B[ä»WALæ¢å¤æ•°æ®]
    C3 --> C3C[å·²æäº¤äº‹åŠ¡ä¸ä¸¢å¤±]

    D --> D1[äº‹åŠ¡æ»¡è¶³æŒä¹…æ€§]
    D --> D2[å·²æäº¤æ•°æ®æ°¸ä¸ä¸¢å¤±]
```

**å½¢å¼åŒ–è¯æ˜**ï¼š

```text
å®šç†ï¼šäº‹åŠ¡æŒä¹…æ€§

å‰æï¼š
  P1: ä½¿ç”¨WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰
  P2: COMMITå‰æ—¥å¿—åˆ·ç›˜ï¼ˆfsyncï¼‰
  P3: Checkpointå®šæœŸåŒæ­¥æ•°æ®

å®šä¹‰ï¼š
  WAL: é¢„å†™æ—¥å¿—
  L(T): äº‹åŠ¡Tçš„æ—¥å¿—è®°å½•
  fsync(L): æ—¥å¿—åˆ·ç›˜æ“ä½œ
  committed(T): äº‹åŠ¡Tå·²æäº¤

è¯æ˜ï¼š
  æ­¥éª¤1ï¼šWALè®°å½•
    - äº‹åŠ¡Tçš„æ‰€æœ‰æ“ä½œå†™å…¥WAL
    - WALåŒ…å«ï¼šæ“ä½œç±»å‹ã€æ•°æ®ã€æ—¶é—´æˆ³
    - ç»“è®ºï¼šWALåŒ…å«å®Œæ•´çš„äº‹åŠ¡ä¿¡æ¯

  æ­¥éª¤2ï¼šCOMMITä¿è¯
    - COMMITæ“ä½œå†™å…¥WAL
    - fsync(WAL)ç¡®ä¿æ—¥å¿—åˆ·ç›˜
    - ç£ç›˜æŒä¹…åŒ–ä¿è¯æ•°æ®ä¸ä¸¢å¤±
    - ç»“è®ºï¼šCOMMITåæ•°æ®æŒä¹…åŒ–

  æ­¥éª¤3ï¼šæ¢å¤èƒ½åŠ›
    - ç³»ç»Ÿå´©æºƒåï¼Œä»WALæ¢å¤
    - æ‰«æWALï¼Œæ‰¾åˆ°å·²æäº¤çš„äº‹åŠ¡
    - é‡æ”¾å·²æäº¤äº‹åŠ¡çš„æ“ä½œ
    - ç»“è®ºï¼šå·²æäº¤äº‹åŠ¡å¯ä»¥æ¢å¤

  æ­¥éª¤4ï¼šæŒä¹…æ€§ä¿è¯
    - å¦‚æœcommitted(T) = true
    - åˆ™L(T)å·²åˆ·ç›˜
    - å³ä½¿ç³»ç»Ÿå´©æºƒï¼ŒTçš„æ“ä½œå¯ä»¥æ¢å¤
    - ç»“è®ºï¼šå·²æäº¤æ•°æ®æ°¸ä¸ä¸¢å¤±

ç»“è®ºï¼š
  C1: äº‹åŠ¡æ»¡è¶³æŒä¹…æ€§
  C2: å·²æäº¤æ•°æ®æ°¸ä¸ä¸¢å¤±
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç¨‹åºå¼€å‘è®¾è®¡å®Œæ•´æŒ‡å—-Rust-Golang-Python.md](./ç¨‹åºå¼€å‘è®¾è®¡å®Œæ•´æŒ‡å—-Rust-Golang-Python.md) - Rust/Go/Pythoné›†æˆæŒ‡å—
- [ç¨‹åºå¼€å‘è®¾è®¡å®Œæ•´æŒ‡å—-JavaScript-TypeScript.md](./ç¨‹åºå¼€å‘è®¾è®¡å®Œæ•´æŒ‡å—-JavaScript-TypeScript.md) - JavaScript/TypeScripté›†æˆæŒ‡å—
- [æ•°æ®åº“è®¾è®¡å®Œæ•´æŒ‡å—-æ­£åç¤ºä¾‹ä¸å¤šç»´åˆ†æ.md](./æ•°æ®åº“è®¾è®¡å®Œæ•´æŒ‡å—-æ­£åç¤ºä¾‹ä¸å¤šç»´åˆ†æ.md) - æ•°æ®åº“è®¾è®¡æŒ‡å—
- [03-äº‹åŠ¡ä¸å¹¶å‘](../03-äº‹åŠ¡ä¸å¹¶å‘/README.md) - äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶
- [12-ç›‘æ§ä¸è¯Šæ–­](../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - æ€§èƒ½ç›‘æ§å’Œè¯Šæ–­

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
