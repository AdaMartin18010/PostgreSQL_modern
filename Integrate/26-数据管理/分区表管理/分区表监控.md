# åˆ†åŒºè¡¨ç›‘æ§

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [åˆ†åŒºè¡¨ç›‘æ§](#åˆ†åŒºè¡¨ç›‘æ§)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆ†åŒºä¿¡æ¯ç›‘æ§](#2-åˆ†åŒºä¿¡æ¯ç›‘æ§)
    - [2.1 æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº](#21-æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº)
    - [2.2 æŸ¥çœ‹åˆ†åŒºå…³ç³»](#22-æŸ¥çœ‹åˆ†åŒºå…³ç³»)
  - [3. åˆ†åŒºå¤§å°ç›‘æ§](#3-åˆ†åŒºå¤§å°ç›‘æ§)
    - [3.1 åˆ†åŒºå¤§å°ç»Ÿè®¡](#31-åˆ†åŒºå¤§å°ç»Ÿè®¡)
    - [3.2 åˆ†åŒºå¢é•¿è¶‹åŠ¿](#32-åˆ†åŒºå¢é•¿è¶‹åŠ¿)
  - [4. åˆ†åŒºä½¿ç”¨ç›‘æ§](#4-åˆ†åŒºä½¿ç”¨ç›‘æ§)
    - [4.1 åˆ†åŒºç»Ÿè®¡ä¿¡æ¯](#41-åˆ†åŒºç»Ÿè®¡ä¿¡æ¯)
    - [4.2 åˆ†åŒºæ•°æ®åˆ†å¸ƒ](#42-åˆ†åŒºæ•°æ®åˆ†å¸ƒ)
  - [5. æ€§èƒ½ç›‘æ§](#5-æ€§èƒ½ç›‘æ§)
    - [5.1 åˆ†åŒºè£å‰ªç›‘æ§](#51-åˆ†åŒºè£å‰ªç›‘æ§)
    - [5.2 æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#52-æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [7. åˆ†åŒºç›‘æ§ä»ªè¡¨æ¿](#7-åˆ†åŒºç›‘æ§ä»ªè¡¨æ¿)
    - [7.1 ç»¼åˆç›‘æ§è§†å›¾](#71-ç»¼åˆç›‘æ§è§†å›¾)
    - [7.2 åˆ†åŒºå¥åº·æ£€æŸ¥](#72-åˆ†åŒºå¥åº·æ£€æŸ¥)
  - [8. åˆ†åŒºå‘Šè­¦é…ç½®](#8-åˆ†åŒºå‘Šè­¦é…ç½®)
    - [8.1 å‘Šè­¦è§„åˆ™](#81-å‘Šè­¦è§„åˆ™)
    - [8.2 å‘Šè­¦æ£€æŸ¥å‡½æ•°](#82-å‘Šè­¦æ£€æŸ¥å‡½æ•°)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

åˆ†åŒºè¡¨ç›‘æ§æ˜¯åˆ†åŒºè¡¨ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡ç›‘æ§å¯ä»¥ï¼š

- äº†è§£åˆ†åŒºçŠ¶æ€
- å‘ç°æ€§èƒ½é—®é¢˜
- ä¼˜åŒ–åˆ†åŒºç­–ç•¥
- è§„åˆ’å®¹é‡

---

## 2. åˆ†åŒºä¿¡æ¯ç›‘æ§

### 2.1 æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº

```sql
-- æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename LIKE 'orders_%'
ORDER BY tablename;
```

### 2.2 æŸ¥çœ‹åˆ†åŒºå…³ç³»

```sql
-- æŸ¥çœ‹åˆ†åŒºå±‚æ¬¡å…³ç³»
SELECT
    n.nspname AS schema_name,
    c.relname AS partition_name,
    pg_get_expr(c.relpartbound, c.oid) AS partition_bound
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relispartition = true
  AND c.relname LIKE 'orders_%'
ORDER BY c.relname;
```

---

## 3. åˆ†åŒºå¤§å°ç›‘æ§

### 3.1 åˆ†åŒºå¤§å°ç»Ÿè®¡

```sql
-- æŸ¥çœ‹æ¯ä¸ªåˆ†åŒºçš„å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) AS indexes_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size
FROM pg_tables
WHERE tablename LIKE 'orders_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3.2 åˆ†åŒºå¢é•¿è¶‹åŠ¿

```sql
-- ç›‘æ§åˆ†åŒºå¢é•¿ï¼ˆéœ€è¦å†å²æ•°æ®ï¼‰
-- å¯ä»¥å®šæœŸè®°å½•åˆ†åŒºå¤§å°åˆ°ç›‘æ§è¡¨
CREATE TABLE partition_size_history (
    partition_name TEXT,
    size_bytes BIGINT,
    recorded_at TIMESTAMPTZ DEFAULT NOW()
);

-- å®šæœŸè®°å½•
INSERT INTO partition_size_history (partition_name, size_bytes)
SELECT
    tablename,
    pg_total_relation_size(schemaname||'.'||tablename)
FROM pg_tables
WHERE tablename LIKE 'orders_%';
```

---

## 4. åˆ†åŒºä½¿ç”¨ç›‘æ§

### 4.1 åˆ†åŒºç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹åˆ†åŒºç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename LIKE 'orders_%'
ORDER BY tablename;
```

### 4.2 åˆ†åŒºæ•°æ®åˆ†å¸ƒ

```sql
-- æŸ¥çœ‹æ¯ä¸ªåˆ†åŒºçš„æ•°æ®é‡
SELECT
    tablename,
    n_live_tup AS row_count,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_stat_user_tables
WHERE tablename LIKE 'orders_%'
ORDER BY tablename;
```

---

## 5. æ€§èƒ½ç›‘æ§

### 5.1 åˆ†åŒºè£å‰ªç›‘æ§

```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼Œæ£€æŸ¥åˆ†åŒºè£å‰ª
EXPLAIN (ANALYZE, VERBOSE, BUFFERS)
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2024-02-01';

-- æ£€æŸ¥æ˜¯å¦åªæ‰«æäº†ç›®æ ‡åˆ†åŒº
```

### 5.2 æŸ¥è¯¢æ€§èƒ½ç›‘æ§

```sql
-- ä½¿ç”¨pg_stat_statementsç›‘æ§æŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE query LIKE '%orders%'
ORDER BY mean_exec_time DESC
LIMIT 10;
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å®šæœŸç›‘æ§** - å®šæœŸæ£€æŸ¥åˆ†åŒºçŠ¶æ€
2. **ç›‘æ§å¤§å°** - ç›‘æ§åˆ†åŒºå¤§å°å’Œå¢é•¿
3. **ç›‘æ§ä½¿ç”¨** - ç›‘æ§åˆ†åŒºä½¿ç”¨æƒ…å†µ
4. **ç›‘æ§æ€§èƒ½** - ç›‘æ§æŸ¥è¯¢æ€§èƒ½
5. **è®¾ç½®å‘Šè­¦** - è®¾ç½®åˆ†åŒºå¤§å°å’Œæ€§èƒ½å‘Šè­¦

### âŒ é¿å…åšæ³•

1. **ä¸ç›‘æ§** - æ— æ³•å‘ç°é—®é¢˜
2. **ä¸è®°å½•å†å²** - æ— æ³•åˆ†æè¶‹åŠ¿
3. **ä¸è®¾ç½®å‘Šè­¦** - æ— æ³•åŠæ—¶å‘ç°é—®é¢˜
4. **ä¸åˆ†ææ€§èƒ½** - æ— æ³•ä¼˜åŒ–æ€§èƒ½

---

## 7. åˆ†åŒºç›‘æ§ä»ªè¡¨æ¿

### 7.1 ç»¼åˆç›‘æ§è§†å›¾

```sql
-- åˆ›å»ºåˆ†åŒºç›‘æ§ä»ªè¡¨æ¿è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE VIEW v_partition_dashboard AS
SELECT
    pt.tablename AS partition_name,
    pt.schemaname AS schema_name,
    pg_size_pretty(pg_total_relation_size(pt.schemaname || '.' || pt.tablename)) AS total_size,
    pg_total_relation_size(pt.schemaname || '.' || pt.tablename) AS size_bytes,
    pst.n_live_tup AS row_count,
    pst.n_dead_tup AS dead_tuples,
    ROUND(100.0 * pst.n_dead_tup / NULLIF(pst.n_live_tup + pst.n_dead_tup, 0), 2) AS dead_ratio,
    pst.last_vacuum,
    pst.last_autovacuum,
    pst.last_analyze,
    pst.last_autoanalyze,
    CASE
        WHEN pst.last_analyze IS NULL OR NOW() - pst.last_analyze > INTERVAL '7 days' THEN 'STALE'
        ELSE 'FRESH'
    END AS stats_status
FROM pg_tables pt
LEFT JOIN pg_stat_user_tables pst ON pt.tablename = pst.tablename AND pt.schemaname = pst.schemaname
WHERE pt.tablename LIKE 'orders_%'
ORDER BY pg_total_relation_size(pt.schemaname || '.' || pt.tablename) DESC;

-- æŸ¥è¯¢ç›‘æ§ä»ªè¡¨æ¿
SELECT * FROM v_partition_dashboard;
```

### 7.2 åˆ†åŒºå¥åº·æ£€æŸ¥

```sql
-- åˆ†åŒºå¥åº·æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION check_partition_health(
    p_table_name TEXT
)
RETURNS TABLE (
    partition_name TEXT,
    health_status TEXT,
    issues TEXT[]
) AS $$
DECLARE
    partition_rec RECORD;
    health_issues TEXT[];
    dead_ratio NUMERIC;
    stats_age INTERVAL;
BEGIN
    FOR partition_rec IN
        SELECT
            pt.tablename,
            pst.n_live_tup,
            pst.n_dead_tup,
            pst.last_analyze
        FROM pg_tables pt
        LEFT JOIN pg_stat_user_tables pst ON pt.tablename = pst.tablename
        WHERE pt.tablename LIKE p_table_name || '_%'
    LOOP
        health_issues := ARRAY[]::TEXT[];

        -- æ£€æŸ¥æ­»å…ƒç»„æ¯”ä¾‹
        IF partition_rec.n_dead_tup IS NOT NULL AND partition_rec.n_live_tup IS NOT NULL THEN
            dead_ratio := 100.0 * partition_rec.n_dead_tup / NULLIF(partition_rec.n_live_tup + partition_rec.n_dead_tup, 0);

            IF dead_ratio > 20 THEN
                health_issues := array_append(health_issues, format('æ­»å…ƒç»„æ¯”ä¾‹è¿‡é«˜: %%', dead_ratio));
            END IF;
        END IF;

        -- æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
        IF partition_rec.last_analyze IS NOT NULL THEN
            stats_age := NOW() - partition_rec.last_analyze;

            IF stats_age > INTERVAL '7 days' THEN
                health_issues := array_append(health_issues, format('ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶: %', stats_age));
            END IF;
        ELSE
            health_issues := array_append(health_issues, 'ç»Ÿè®¡ä¿¡æ¯ç¼ºå¤±');
        END IF;

        RETURN QUERY SELECT
            partition_rec.tablename,
            CASE
                WHEN array_length(health_issues, 1) IS NULL THEN 'HEALTHY'
                WHEN array_length(health_issues, 1) <= 1 THEN 'WARNING'
                ELSE 'CRITICAL'
            END,
            health_issues;
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ†åŒºå¥åº·æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œå¥åº·æ£€æŸ¥
SELECT * FROM check_partition_health('orders');
```

---

## 8. åˆ†åŒºå‘Šè­¦é…ç½®

### 8.1 å‘Šè­¦è§„åˆ™

```sql
-- åˆ†åŒºå‘Šè­¦è§„åˆ™è¡¨
CREATE TABLE IF NOT EXISTS partition_alert_rules (
    id SERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    alert_type TEXT,  -- 'SIZE', 'ROW_COUNT', 'DEAD_TUPLES', 'STATS_AGE'
    threshold_value NUMERIC,
    threshold_unit TEXT,  -- 'MB', 'GB', 'PERCENT', 'DAYS'
    alert_level TEXT,  -- 'WARNING', 'CRITICAL'
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥å‘Šè­¦è§„åˆ™
INSERT INTO partition_alert_rules (table_name, alert_type, threshold_value, threshold_unit, alert_level)
VALUES
    ('orders', 'SIZE', 10, 'GB', 'WARNING'),
    ('orders', 'SIZE', 50, 'GB', 'CRITICAL'),
    ('orders', 'DEAD_TUPLES', 20, 'PERCENT', 'WARNING'),
    ('orders', 'STATS_AGE', 7, 'DAYS', 'WARNING');
```

### 8.2 å‘Šè­¦æ£€æŸ¥å‡½æ•°

```sql
-- åˆ†åŒºå‘Šè­¦æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION check_partition_alerts()
RETURNS TABLE (
    partition_name TEXT,
    alert_type TEXT,
    alert_message TEXT,
    alert_level TEXT,
    current_value TEXT
) AS $$
DECLARE
    rule_rec RECORD;
    partition_rec RECORD;
    current_val NUMERIC;
    alert_msg TEXT;
BEGIN
    FOR rule_rec IN
        SELECT * FROM partition_alert_rules WHERE enabled = TRUE
    LOOP
        FOR partition_rec IN
            SELECT tablename
            FROM pg_tables
            WHERE tablename LIKE rule_rec.table_name || '_%'
        LOOP
            CASE rule_rec.alert_type
                WHEN 'SIZE' THEN
                    SELECT pg_total_relation_size(schemaname || '.' || tablename) /
                           CASE rule_rec.threshold_unit
                               WHEN 'MB' THEN 1024 * 1024
                               WHEN 'GB' THEN 1024 * 1024 * 1024
                               ELSE 1
                           END
                    INTO current_val
                    FROM pg_tables
                    WHERE tablename = partition_rec.tablename;

                    IF current_val >= rule_rec.threshold_value THEN
                        alert_msg := format('åˆ†åŒºå¤§å°è¶…è¿‡é˜ˆå€¼: % %', current_val, rule_rec.threshold_unit);
                        RETURN QUERY SELECT
                            partition_rec.tablename,
                            rule_rec.alert_type,
                            alert_msg,
                            rule_rec.alert_level,
                            format('% %', current_val, rule_rec.threshold_unit);
                    END IF;

                WHEN 'DEAD_TUPLES' THEN
                    SELECT ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2)
                    INTO current_val
                    FROM pg_stat_user_tables
                    WHERE tablename = partition_rec.tablename;

                    IF current_val >= rule_rec.threshold_value THEN
                        alert_msg := format('æ­»å…ƒç»„æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼: %%', current_val);
                        RETURN QUERY SELECT
                            partition_rec.tablename,
                            rule_rec.alert_type,
                            alert_msg,
                            rule_rec.alert_level,
                            format('%%', current_val);
                    END IF;

                WHEN 'STATS_AGE' THEN
                    SELECT EXTRACT(DAYS FROM (NOW() - last_analyze))
                    INTO current_val
                    FROM pg_stat_user_tables
                    WHERE tablename = partition_rec.tablename;

                    IF current_val >= rule_rec.threshold_value THEN
                        alert_msg := format('ç»Ÿè®¡ä¿¡æ¯å¹´é¾„è¶…è¿‡é˜ˆå€¼: % å¤©', current_val);
                        RETURN QUERY SELECT
                            partition_rec.tablename,
                            rule_rec.alert_type,
                            alert_msg,
                            rule_rec.alert_level,
                            format('% å¤©', current_val);
                    END IF;
            END CASE;
        END LOOP;
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥åˆ†åŒºå‘Šè­¦å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥è¯¢å‘Šè­¦
SELECT * FROM check_partition_alerts();
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—.md](./åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—.md) - åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—
- [åˆ†åŒºè¡¨ç»´æŠ¤.md](./åˆ†åŒºè¡¨ç»´æŠ¤.md) - åˆ†åŒºè¡¨ç»´æŠ¤
- [åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–.md](./åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–.md) - æ€§èƒ½ä¼˜åŒ–
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
