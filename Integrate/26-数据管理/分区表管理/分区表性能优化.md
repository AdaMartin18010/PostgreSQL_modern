# åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ðŸ“‹ ç›®å½•

- [åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–](#åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆ†åŒºè£å‰ªä¼˜åŒ–](#2-åˆ†åŒºè£å‰ªä¼˜åŒ–)
    - [2.1 ç¡®ä¿åˆ†åŒºè£å‰ª](#21-ç¡®ä¿åˆ†åŒºè£å‰ª)
    - [2.2 ä½¿ç”¨å¸¸é‡è¡¨è¾¾å¼](#22-ä½¿ç”¨å¸¸é‡è¡¨è¾¾å¼)
    - [2.3 æ£€æŸ¥åˆ†åŒºè£å‰ª](#23-æ£€æŸ¥åˆ†åŒºè£å‰ª)
  - [3. ç´¢å¼•ä¼˜åŒ–](#3-ç´¢å¼•ä¼˜åŒ–)
    - [3.1 åˆ†åŒºç´¢å¼•](#31-åˆ†åŒºç´¢å¼•)
    - [3.2 éƒ¨åˆ†ç´¢å¼•](#32-éƒ¨åˆ†ç´¢å¼•)
    - [3.3 ç´¢å¼•ç»´æŠ¤](#33-ç´¢å¼•ç»´æŠ¤)
  - [4. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#4-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
    - [4.1 å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢](#41-å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢)
    - [4.2 å¹¶è¡Œåº¦è°ƒä¼˜](#42-å¹¶è¡Œåº¦è°ƒä¼˜)
  - [5. ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–](#5-ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–)
    - [5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯](#51-æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)
    - [5.2 ç»Ÿè®¡ä¿¡æ¯é…ç½®](#52-ç»Ÿè®¡ä¿¡æ¯é…ç½®)
  - [6. æœ€ä½³å®žè·µ](#6-æœ€ä½³å®žè·µ)
    - [âœ… æŽ¨èåšæ³•](#-æŽ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [7. åˆ†åŒºè¡¨æŸ¥è¯¢ä¼˜åŒ–](#7-åˆ†åŒºè¡¨æŸ¥è¯¢ä¼˜åŒ–)
    - [7.1 æŸ¥è¯¢é‡å†™ä¼˜åŒ–](#71-æŸ¥è¯¢é‡å†™ä¼˜åŒ–)
    - [7.2 åˆ†åŒºé”®é€‰æ‹©ä¼˜åŒ–](#72-åˆ†åŒºé”®é€‰æ‹©ä¼˜åŒ–)
  - [8. åˆ†åŒºè¡¨ç´¢å¼•ç­–ç•¥](#8-åˆ†åŒºè¡¨ç´¢å¼•ç­–ç•¥)
    - [8.1 å…¨å±€ç´¢å¼• vs åˆ†åŒºç´¢å¼•](#81-å…¨å±€ç´¢å¼•-vs-åˆ†åŒºç´¢å¼•)
    - [8.2 ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–](#82-ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–)
  - [9. åˆ†åŒºè¡¨æ€§èƒ½ç›‘æŽ§](#9-åˆ†åŒºè¡¨æ€§èƒ½ç›‘æŽ§)
    - [9.1 åˆ†åŒºè£å‰ªç›‘æŽ§](#91-åˆ†åŒºè£å‰ªç›‘æŽ§)
    - [9.2 æ€§èƒ½åŸºå‡†æµ‹è¯•](#92-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [ðŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–æ˜¯æå‡åˆ†åŒºè¡¨æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š

- **åˆ†åŒºè£å‰ª** - å‡å°‘æ‰«æçš„åˆ†åŒºæ•°é‡
- **ç´¢å¼•ä¼˜åŒ–** - ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºåˆé€‚çš„ç´¢å¼•
- **å¹¶è¡ŒæŸ¥è¯¢** - åˆ©ç”¨å¹¶è¡ŒæŸ¥è¯¢æå‡æ€§èƒ½
- **ç»Ÿè®¡ä¿¡æ¯** - ä¿æŒç»Ÿè®¡ä¿¡æ¯æœ€æ–°

---

## 2. åˆ†åŒºè£å‰ªä¼˜åŒ–

### 2.1 ç¡®ä¿åˆ†åŒºè£å‰ª

```sql
-- âœ… æŽ¨èï¼šæŸ¥è¯¢æ¡ä»¶åŒ…å«åˆ†åŒºé”®
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2024-02-01';
-- åªæ‰«æorders_2024_01åˆ†åŒº

-- âŒ é¿å…ï¼šæŸ¥è¯¢æ¡ä»¶ä¸åŒ…å«åˆ†åŒºé”®
SELECT * FROM orders
WHERE customer_id = 123;
-- æ‰«ææ‰€æœ‰åˆ†åŒº
```

### 2.2 ä½¿ç”¨å¸¸é‡è¡¨è¾¾å¼

```sql
-- âœ… æŽ¨èï¼šä½¿ç”¨å¸¸é‡
SELECT * FROM orders
WHERE order_date = '2024-06-15';

-- âŒ é¿å…ï¼šä½¿ç”¨å‡½æ•°
SELECT * FROM orders
WHERE extract(year from order_date) = 2024;
-- åˆ†åŒºè£å‰ªå¤±æ•ˆ
```

### 2.3 æ£€æŸ¥åˆ†åŒºè£å‰ª

```sql
-- ä½¿ç”¨EXPLAINæ£€æŸ¥åˆ†åŒºè£å‰ª
EXPLAIN (ANALYZE, VERBOSE)
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2024-02-01';

-- æŸ¥çœ‹æ˜¯å¦å‡ºçŽ°ï¼š
-- - Append
-- - Seq Scan on orders_2024_01
-- å¦‚æžœæ‰«æå¤šä¸ªåˆ†åŒºï¼Œè¯´æ˜Žè£å‰ªä¸å®Œæ•´
```

---

## 3. ç´¢å¼•ä¼˜åŒ–

### 3.1 åˆ†åŒºç´¢å¼•

```sql
-- åœ¨ä¸»è¡¨ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰åˆ†åŒºï¼‰
CREATE INDEX orders_customer_id_idx ON orders (customer_id);

-- æˆ–åœ¨æ¯ä¸ªåˆ†åŒºä¸Šå•ç‹¬åˆ›å»ºç´¢å¼•
CREATE INDEX orders_2024_01_customer_id_idx ON orders_2024_01 (customer_id);
```

### 3.2 éƒ¨åˆ†ç´¢å¼•

```sql
-- ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºéƒ¨åˆ†ç´¢å¼•
CREATE INDEX orders_2024_01_active_idx ON orders_2024_01 (customer_id)
WHERE status = 'active';
```

### 3.3 ç´¢å¼•ç»´æŠ¤

```sql
-- å®šæœŸç»´æŠ¤ç´¢å¼•
VACUUM ANALYZE orders;

-- é‡å»ºç´¢å¼•ï¼ˆå¦‚æžœç´¢å¼•è†¨èƒ€ï¼‰
REINDEX TABLE orders;
```

---

## 4. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

### 4.1 å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;

-- åˆ†åŒºè¡¨æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢
EXPLAIN (ANALYZE)
SELECT customer_id, SUM(amount)
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY customer_id;
```

### 4.2 å¹¶è¡Œåº¦è°ƒä¼˜

```sql
-- æ ¹æ®æ•°æ®é‡è°ƒæ•´å¹¶è¡Œåº¦
ALTER TABLE orders SET (parallel_workers = 4);
```

---

## 5. ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

### 5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```sql
-- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- æˆ–ä½¿ç”¨è‡ªåŠ¨åˆ†æž
ALTER TABLE orders SET (autovacuum_analyze_scale_factor = 0.1);
```

### 5.2 ç»Ÿè®¡ä¿¡æ¯é…ç½®

```sql
-- å¢žåŠ ç»Ÿè®¡ä¿¡æ¯æ ·æœ¬
ALTER TABLE orders ALTER COLUMN order_date SET STATISTICS 1000;
```

---

## 6. æœ€ä½³å®žè·µ

### âœ… æŽ¨èåšæ³•

1. **ç¡®ä¿åˆ†åŒºè£å‰ª** - æŸ¥è¯¢æ¡ä»¶å¿…é¡»åŒ…å«åˆ†åŒºé”®
2. **åˆ›å»ºåˆé€‚ç´¢å¼•** - ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºç´¢å¼•
3. **ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢** - åˆ©ç”¨å¹¶è¡ŒæŸ¥è¯¢æå‡æ€§èƒ½
4. **ä¿æŒç»Ÿè®¡ä¿¡æ¯æœ€æ–°** - å®šæœŸANALYZE
5. **ç›‘æŽ§æ€§èƒ½** - ä½¿ç”¨EXPLAINåˆ†æžæŸ¥è¯¢è®¡åˆ’

### âŒ é¿å…åšæ³•

1. **æŸ¥è¯¢æ¡ä»¶ä¸åŒ…å«åˆ†åŒºé”®** - å¯¼è‡´å…¨åˆ†åŒºæ‰«æ
2. **ä¸ä½¿ç”¨ç´¢å¼•** - å½±å“æŸ¥è¯¢æ€§èƒ½
3. **å¿½ç•¥ç»Ÿè®¡ä¿¡æ¯** - å½±å“æŸ¥è¯¢ä¼˜åŒ–
4. **ä¸ç›‘æŽ§æ€§èƒ½** - æ— æ³•å‘çŽ°æ€§èƒ½é—®é¢˜

---

## 7. åˆ†åŒºè¡¨æŸ¥è¯¢ä¼˜åŒ–

### 7.1 æŸ¥è¯¢é‡å†™ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å‰ï¼šå…¨åˆ†åŒºæ‰«æ
SELECT * FROM orders
WHERE customer_id = 123;

-- ä¼˜åŒ–åŽï¼šä½¿ç”¨åˆ†åŒºé”®è¿‡æ»¤
SELECT * FROM orders
WHERE customer_id = 123
  AND order_date >= CURRENT_DATE - INTERVAL '1 month'
  AND order_date < CURRENT_DATE;
-- åªæ‰«ææœ€è¿‘ä¸€ä¸ªæœˆçš„åˆ†åŒº
```

### 7.2 åˆ†åŒºé”®é€‰æ‹©ä¼˜åŒ–

```sql
-- åˆ†åŒºé”®é€‰æ‹©å»ºè®®ï¼š
-- 1. é€‰æ‹©æŸ¥è¯¢ä¸­ç»å¸¸ä½¿ç”¨çš„å­—æ®µ
-- 2. é€‰æ‹©æ•°æ®åˆ†å¸ƒå‡åŒ€çš„å­—æ®µ
-- 3. é€‰æ‹©æ—¶é—´å­—æ®µï¼ˆé€‚åˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰

-- ç¤ºä¾‹ï¼šæŒ‰æ—¶é—´åˆ†åŒºï¼ˆæŽ¨èï¼‰
CREATE TABLE orders (
    order_id SERIAL,
    order_date DATE NOT NULL,
    customer_id INT,
    amount NUMERIC
) PARTITION BY RANGE (order_date);

-- ç¤ºä¾‹ï¼šæŒ‰å®¢æˆ·IDåˆ†åŒºï¼ˆå¦‚æžœæŸ¥è¯¢ç»å¸¸æŒ‰å®¢æˆ·è¿‡æ»¤ï¼‰
CREATE TABLE orders (
    order_id SERIAL,
    order_date DATE,
    customer_id INT NOT NULL,
    amount NUMERIC
) PARTITION BY HASH (customer_id);
```

---

## 8. åˆ†åŒºè¡¨ç´¢å¼•ç­–ç•¥

### 8.1 å…¨å±€ç´¢å¼• vs åˆ†åŒºç´¢å¼•

```sql
-- å…¨å±€ç´¢å¼•ï¼ˆåœ¨ä¸»è¡¨ä¸Šåˆ›å»ºï¼Œè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰åˆ†åŒºï¼‰
CREATE INDEX orders_customer_id_idx ON orders (customer_id);

-- åˆ†åŒºç´¢å¼•ï¼ˆåœ¨æ¯ä¸ªåˆ†åŒºä¸Šå•ç‹¬åˆ›å»ºï¼‰
CREATE INDEX orders_2024_01_customer_id_idx ON orders_2024_01 (customer_id);
CREATE INDEX orders_2024_02_customer_id_idx ON orders_2024_02 (customer_id);

-- é€‰æ‹©å»ºè®®ï¼š
-- - å…¨å±€ç´¢å¼•ï¼šç»´æŠ¤ç®€å•ï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½
-- - åˆ†åŒºç´¢å¼•ï¼šæ€§èƒ½æ›´å¥½ï¼Œä½†éœ€è¦å•ç‹¬ç»´æŠ¤
```

### 8.2 ç´¢å¼•ç»´æŠ¤ä¼˜åŒ–

```sql
-- æ‰¹é‡ç´¢å¼•ç»´æŠ¤å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION maintain_partition_indexes(
    p_table_name TEXT
)
RETURNS TABLE (
    partition_name TEXT,
    index_name TEXT,
    maintenance_status TEXT,
    duration INTERVAL
) AS $$
DECLARE
    partition_rec RECORD;
    index_rec RECORD;
    start_time TIMESTAMPTZ;
    end_time TIMESTAMPTZ;
BEGIN
    FOR partition_rec IN
        SELECT tablename
        FROM pg_tables
        WHERE tablename LIKE p_table_name || '_%'
    LOOP
        FOR index_rec IN
            SELECT indexname
            FROM pg_indexes
            WHERE tablename = partition_rec.tablename
        LOOP
            start_time := clock_timestamp();

            BEGIN
                -- é‡å»ºç´¢å¼•
                EXECUTE format('REINDEX INDEX CONCURRENTLY %I', index_rec.indexname);

                end_time := clock_timestamp();

                RETURN QUERY SELECT
                    partition_rec.tablename,
                    index_rec.indexname,
                    'SUCCESS'::TEXT,
                    end_time - start_time;

            EXCEPTION
                WHEN OTHERS THEN
                    RETURN QUERY SELECT
                        partition_rec.tablename,
                        index_rec.indexname,
                        format('FAILED: %', SQLERRM)::TEXT,
                        NULL::INTERVAL;
            END;
        END LOOP;
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç´¢å¼•ç»´æŠ¤å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç´¢å¼•ç»´æŠ¤
SELECT * FROM maintain_partition_indexes('orders');
```

---

## 9. åˆ†åŒºè¡¨æ€§èƒ½ç›‘æŽ§

### 9.1 åˆ†åŒºè£å‰ªç›‘æŽ§

```sql
-- åˆ†åŒºè£å‰ªç›‘æŽ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION monitor_partition_pruning(
    p_table_name TEXT,
    p_query_text TEXT
)
RETURNS TABLE (
    partition_name TEXT,
    scanned BOOLEAN,
    row_count BIGINT
) AS $$
DECLARE
    partition_rec RECORD;
    scan_count BIGINT;
BEGIN
    -- æ‰§è¡ŒæŸ¥è¯¢å¹¶åˆ†æžè®¡åˆ’
    FOR partition_rec IN
        SELECT tablename
        FROM pg_tables
        WHERE tablename LIKE p_table_name || '_%'
    LOOP
        BEGIN
            -- æ£€æŸ¥åˆ†åŒºæ˜¯å¦è¢«æ‰«æ
            EXECUTE format(
                'SELECT COUNT(*) FROM %I WHERE %s',
                partition_rec.tablename,
                substring(p_query_text from 'WHERE (.+)')
            ) INTO scan_count;

            RETURN QUERY SELECT
                partition_rec.tablename,
                scan_count > 0,
                scan_count;

        EXCEPTION
            WHEN OTHERS THEN
                RETURN QUERY SELECT
                    partition_rec.tablename,
                    NULL::BOOLEAN,
                    NULL::BIGINT;
        END;
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æŽ§åˆ†åŒºè£å‰ªå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 9.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åˆ†åŒºè¡¨æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æžï¼‰
CREATE OR REPLACE FUNCTION benchmark_partition_query(
    p_table_name TEXT,
    p_query_text TEXT,
    p_iterations INT DEFAULT 10
)
RETURNS TABLE (
    iteration INT,
    execution_time_ms NUMERIC,
    partitions_scanned INT
) AS $$
DECLARE
    i INT;
    start_time TIMESTAMPTZ;
    end_time TIMESTAMPTZ;
    exec_time_ms NUMERIC;
BEGIN
    FOR i IN 1..p_iterations LOOP
        start_time := clock_timestamp();

        EXECUTE p_query_text;

        end_time := clock_timestamp();
        exec_time_ms := EXTRACT(EPOCH FROM (end_time - start_time)) * 1000;

        RETURN QUERY SELECT
            i,
            exec_time_ms,
            NULL::INT;  -- éœ€è¦ä»ŽEXPLAINä¸­æå–
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒåŸºå‡†æµ‹è¯•
SELECT * FROM benchmark_partition_query(
    'orders',
    'SELECT COUNT(*) FROM orders WHERE order_date >= ''2024-01-01'' AND order_date < ''2024-02-01'''
);
```

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—.md](./åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—.md) - åˆ†åŒºè¡¨å®Œæ•´æŒ‡å—
- [åˆ†åŒºç­–ç•¥é€‰æ‹©.md](./åˆ†åŒºç­–ç•¥é€‰æ‹©.md) - åˆ†åŒºç­–ç•¥é€‰æ‹©
- [åˆ†åŒºè¡¨ç»´æŠ¤.md](./åˆ†åŒºè¡¨ç»´æŠ¤.md) - åˆ†åŒºè¡¨ç»´æŠ¤
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
