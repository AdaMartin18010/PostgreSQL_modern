# 分区表维护

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [分区表维护](#分区表维护)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 添加分区](#2-添加分区)
    - [2.1 手动添加分区](#21-手动添加分区)
    - [2.2 自动创建分区函数](#22-自动创建分区函数)
  - [3. 删除分区](#3-删除分区)
    - [3.1 删除分区（删除数据）](#31-删除分区删除数据)
    - [3.2 分离分区（保留数据）](#32-分离分区保留数据)
    - [3.3 自动删除旧分区](#33-自动删除旧分区)
  - [4. 分区归档](#4-分区归档)
    - [4.1 归档到独立表](#41-归档到独立表)
    - [4.2 导出归档](#42-导出归档)
  - [5. 自动维护](#5-自动维护)
    - [5.1 使用pg\_partman](#51-使用pg_partman)
    - [5.2 使用pg\_cron](#52-使用pg_cron)
  - [6. 最佳实践](#6-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

分区表维护是分区表管理的重要组成部分。包括：

- **添加分区** - 创建新分区
- **删除分区** - 删除旧分区
- **分区归档** - 归档历史分区
- **自动维护** - 自动化维护任务

---

## 2. 添加分区

### 2.1 手动添加分区

```sql
-- 添加新分区
CREATE TABLE orders_2024_12 PARTITION OF orders
    FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

### 2.2 自动创建分区函数

```sql
-- 创建自动创建分区的函数
CREATE OR REPLACE FUNCTION create_monthly_partition(
    table_name TEXT,
    partition_date DATE
)
RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
    start_date DATE;
    end_date DATE;
BEGIN
    start_date := date_trunc('month', partition_date);
    end_date := start_date + INTERVAL '1 month';
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
        partition_name, table_name, start_date, end_date
    );
END;
$$ LANGUAGE plpgsql;

-- 使用
SELECT create_monthly_partition('orders', '2024-12-15');
```

---

## 3. 删除分区

### 3.1 删除分区（删除数据）

```sql
-- 删除分区（数据也会删除）
DROP TABLE orders_2024_01;
```

### 3.2 分离分区（保留数据）

```sql
-- 分离分区（保留数据）
ALTER TABLE orders DETACH PARTITION orders_2024_01;

-- 分离后的表可以独立管理
-- 可以重命名、移动、删除等
```

### 3.3 自动删除旧分区

```sql
-- 创建自动删除旧分区的函数
CREATE OR REPLACE FUNCTION drop_old_partitions(
    table_name TEXT,
    retention_months INT DEFAULT 12
)
RETURNS VOID AS $$
DECLARE
    partition_record RECORD;
    cutoff_date DATE;
BEGIN
    cutoff_date := CURRENT_DATE - (retention_months || ' months')::INTERVAL;

    FOR partition_record IN
        SELECT tablename
        FROM pg_tables
        WHERE tablename LIKE table_name || '_%'
          AND tablename ~ '^\d{4}_\d{2}$'  -- 匹配YYYY_MM格式
    LOOP
        -- 提取日期并检查
        IF to_date(substring(partition_record.tablename from '\d{4}_\d{2}'), 'YYYY_MM') < cutoff_date THEN
            EXECUTE format('DROP TABLE IF EXISTS %I', partition_record.tablename);
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 使用
SELECT drop_old_partitions('orders', 12);  -- 保留12个月
```

---

## 4. 分区归档

### 4.1 归档到独立表

```sql
-- 分离分区
ALTER TABLE orders DETACH PARTITION orders_2024_01;

-- 重命名归档
ALTER TABLE orders_2024_01 RENAME TO orders_archive_2024_01;

-- 移动到归档schema
ALTER TABLE orders_archive_2024_01 SET SCHEMA archive;
```

### 4.2 导出归档

```bash
# 导出分区数据
pg_dump -t orders_2024_01 mydb > orders_2024_01.dump

# 删除分区
DROP TABLE orders_2024_01;
```

---

## 5. 自动维护

### 5.1 使用pg_partman

```sql
-- 安装pg_partman
CREATE EXTENSION pg_partman;

-- 配置自动分区
SELECT partman.create_parent(
    p_parent_table => 'public.orders',
    p_control => 'order_date',
    p_type => 'range',
    p_interval => 'monthly',
    p_premake => 3
);

-- 自动创建未来3个月的分区
-- 自动删除旧分区（根据配置）
```

### 5.2 使用pg_cron

```sql
-- 安装pg_cron
CREATE EXTENSION pg_cron;

-- 定期创建新分区（每月1号）
SELECT cron.schedule(
    'create_monthly_partition',
    '0 0 1 * *',
    $$SELECT create_monthly_partition('orders', CURRENT_DATE)$$
);

-- 定期删除旧分区（每月1号）
SELECT cron.schedule(
    'drop_old_partitions',
    '0 1 1 * *',
    $$SELECT drop_old_partitions('orders', 12)$$
);
```

---

## 6. 最佳实践

### ✅ 推荐做法

1. **自动化维护** - 使用pg_partman或自定义函数
2. **提前创建分区** - 提前创建未来分区
3. **定期清理** - 定期删除或归档旧分区
4. **监控分区** - 监控分区数量和大小
5. **备份重要数据** - 删除前备份重要数据

### ❌ 避免做法

1. **手动维护** - 容易遗漏和出错
2. **不清理旧分区** - 导致分区过多
3. **不备份** - 删除前不备份
4. **不监控** - 无法及时发现问题

---

## 📚 相关文档

- [分区表完整指南.md](./分区表完整指南.md) - 分区表完整指南
- [分区表监控.md](./分区表监控.md) - 分区表监控
- [PostgreSQL分区表高级优化指南.md](./PostgreSQL分区表高级优化指南.md) - 高级优化指南
- [26-数据管理/README.md](../README.md) - 数据管理主题

---

**最后更新**: 2025年1月
