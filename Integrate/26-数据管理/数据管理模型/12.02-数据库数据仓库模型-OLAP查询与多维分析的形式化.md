---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\12-æ•°æ®ç®¡ç†æ¨¡å‹\12.02-æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-OLAPæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-OLAPæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-OLAPæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–](#æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-olapæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹å·¥ä½œåŸç†æ¦‚è¿°](#10-æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 å¤šç»´æ¨¡å‹](#21-å¤šç»´æ¨¡å‹)
    - [2.2 OLAPæ“ä½œ](#22-olapæ“ä½œ)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å¤šç»´æ¨¡å‹å½¢å¼åŒ–](#31-å¤šç»´æ¨¡å‹å½¢å¼åŒ–)
  - [4. å®é™…åº”ç”¨](#4-å®é™…åº”ç”¨)
    - [4.1 PostgreSQL 18æ•°æ®ä»“åº“å®ç°](#41-postgresql-18æ•°æ®ä»“åº“å®ç°)
      - [4.1.1 å®Œæ•´æ˜Ÿå‹æ¨¡å¼å®ç°](#411-å®Œæ•´æ˜Ÿå‹æ¨¡å¼å®ç°)
      - [4.1.2 OLAPæ“ä½œå®ç°](#412-olapæ“ä½œå®ç°)
      - [4.1.3 ç‰©åŒ–è§†å›¾ä¼˜åŒ–](#413-ç‰©åŒ–è§†å›¾ä¼˜åŒ–)
    - [4.2 å®é™…åº”ç”¨åœºæ™¯](#42-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šç”µå•†é”€å”®åˆ†æ](#åœºæ™¯1ç”µå•†é”€å”®åˆ†æ)
      - [åœºæ™¯2ï¼šè´¢åŠ¡æ•°æ®ä»“åº“](#åœºæ™¯2è´¢åŠ¡æ•°æ®ä»“åº“)
  - [5. ç›¸å…³æ–‡æ¡£](#5-ç›¸å…³æ–‡æ¡£)
    - [5.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#51-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [6. å‚è€ƒæ–‡çŒ®](#6-å‚è€ƒæ–‡çŒ®)
    - [6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#61-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [6.2 PostgreSQLå®ç°ç›¸å…³](#62-postgresqlå®ç°ç›¸å…³)
    - [6.3 ç›¸å…³æ–‡æ¡£](#63-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹å·¥ä½œåŸç†æ¦‚è¿°

**æ•°æ®ä»“åº“**ï¼š

æ•°æ®ä»“åº“ï¼ˆData Warehouseï¼‰æ˜¯ä¸€ç§é¢å‘ä¸»é¢˜çš„ã€é›†æˆçš„ã€ç›¸å¯¹ç¨³å®šçš„ã€åæ˜ å†å²å˜åŒ–çš„æ•°æ®é›†åˆï¼Œç”¨äºæ”¯æŒç®¡ç†å†³ç­–ã€‚
å®ƒä½¿ç”¨æ˜Ÿå‹æ¨¡å¼ï¼ˆStar Schemaï¼‰æˆ–é›ªèŠ±å‹æ¨¡å¼ï¼ˆSnowflake Schemaï¼‰å­˜å‚¨å¤šç»´æ•°æ®ï¼Œæ”¯æŒOLAPï¼ˆOnline Analytical Processingï¼‰æŸ¥è¯¢å’Œå¤šç»´åˆ†æã€‚

**æ ¸å¿ƒå·¥ä½œåŸç†**ï¼š

1. **å¤šç»´æ•°æ®æ¨¡å‹**ï¼šä½¿ç”¨äº‹å®è¡¨ï¼ˆFact Tableï¼‰å’Œç»´åº¦è¡¨ï¼ˆDimension Tableï¼‰ç»„ç»‡æ•°æ®
2. **OLAPæ“ä½œ**ï¼šæ”¯æŒä¸Šå·ï¼ˆRoll-upï¼‰ã€ä¸‹é’»ï¼ˆDrill-downï¼‰ã€åˆ‡ç‰‡ï¼ˆSliceï¼‰ã€åˆ‡å—ï¼ˆDiceï¼‰ã€æ—‹è½¬ï¼ˆPivotï¼‰ç­‰æ“ä½œ
3. **èšåˆè®¡ç®—**ï¼šé€šè¿‡GROUP BY ROLLUPã€CUBEã€GROUPING SETSç­‰å®ç°å¤šç»´èšåˆ
4. **ç‰©åŒ–è§†å›¾**ï¼šé¢„è®¡ç®—å¸¸ç”¨èšåˆç»“æœï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
5. **åˆ†åŒºç­–ç•¥**ï¼šæŒ‰æ—¶é—´æˆ–ç»´åº¦åˆ†åŒºï¼Œä¼˜åŒ–å­˜å‚¨å’ŒæŸ¥è¯¢

**æ•°æ®ä»“åº“æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((æ•°æ®ä»“åº“))
    å¤šç»´æ¨¡å‹
      äº‹å®è¡¨
      ç»´åº¦è¡¨
      åº¦é‡
    OLAPæ“ä½œ
      ä¸Šå·
      ä¸‹é’»
      åˆ‡ç‰‡
      åˆ‡å—
    æŸ¥è¯¢ä¼˜åŒ–
      ç‰©åŒ–è§†å›¾
      ç´¢å¼•ä¼˜åŒ–
      åˆ†åŒºç­–ç•¥
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **å¤šç»´æ¨¡å‹**ï¼šæ˜Ÿå‹æ¨¡å¼å’Œé›ªèŠ±å‹æ¨¡å¼
- **OLAPæŸ¥è¯¢**ï¼šä¸Šå·ã€ä¸‹é’»ç­‰æ“ä½œ
- **å®é™…åº”ç”¨**ï¼šæ•°æ®ä»“åº“å®ç°

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 å¤šç»´æ¨¡å‹

**æ˜Ÿå‹æ¨¡å¼**ï¼š

```haskell
-- æ˜Ÿå‹æ¨¡å¼
data StarSchema = StarSchema {
    factTable :: FactTable,
    dimensionTables :: [DimensionTable]
}

-- äº‹å®è¡¨
data FactTable = FactTable {
    measures :: [Measure],
    foreignKeys :: [ForeignKey]
}
```

### 2.2 OLAPæ“ä½œ

**OLAPæ“ä½œç±»å‹**ï¼š

| æ“ä½œ | å®šä¹‰ | æ•ˆæœ |
| --- | --- | --- |
| **ä¸Šå·** | èšåˆåˆ°æ›´é«˜å±‚æ¬¡ | æ•°æ®æ±‡æ€» |
| **ä¸‹é’»** | åˆ†è§£åˆ°æ›´ç»†å±‚æ¬¡ | æ•°æ®æ˜ç»† |
| **åˆ‡ç‰‡** | é€‰æ‹©ç‰¹å®šç»´åº¦å€¼ | æ•°æ®è¿‡æ»¤ |
| **åˆ‡å—** | é€‰æ‹©å¤šä¸ªç»´åº¦å€¼ | æ•°æ®å­é›† |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å¤šç»´æ¨¡å‹å½¢å¼åŒ–

**å¤šç»´æ¨¡å‹**ï¼š

```haskell
-- å¤šç»´æ¨¡å‹å½¢å¼åŒ–
MultidimensionalModel = (F, D, M)
where
    F = fact table
    D = {d1, d2, ..., dn}  -- dimension tables
    M = {m1, m2, ..., mk}  -- measures
```

---

## 4. å®é™…åº”ç”¨

### 4.1 PostgreSQL 18æ•°æ®ä»“åº“å®ç°

#### 4.1.1 å®Œæ•´æ˜Ÿå‹æ¨¡å¼å®ç°

**PostgreSQL 18å®ç°æ¶æ„**ï¼š

```sql
-- 1. æ—¶é—´ç»´åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'dim_time') THEN
            CREATE TABLE dim_time (
                time_id INTEGER PRIMARY KEY,
                date DATE NOT NULL UNIQUE,
                year INTEGER NOT NULL,
                quarter INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
                month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
                week INTEGER NOT NULL CHECK (week BETWEEN 1 AND 53),
                day_of_month INTEGER NOT NULL CHECK (day_of_month BETWEEN 1 AND 31),
                day_of_week INTEGER NOT NULL CHECK (day_of_week BETWEEN 1 AND 7),
                is_weekend BOOLEAN NOT NULL,
                is_holiday BOOLEAN NOT NULL DEFAULT FALSE
            );
            RAISE NOTICE 'è¡¨ dim_time åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ dim_time å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ dim_time å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ dim_time å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    -- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_dim_time_year') THEN
            CREATE INDEX idx_dim_time_year ON dim_time(year);
            RAISE NOTICE 'ç´¢å¼• idx_dim_time_year åˆ›å»ºæˆåŠŸ';
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_dim_time_quarter') THEN
            CREATE INDEX idx_dim_time_quarter ON dim_time(year, quarter);
            RAISE NOTICE 'ç´¢å¼• idx_dim_time_quarter åˆ›å»ºæˆåŠŸ';
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_dim_time_month') THEN
            CREATE INDEX idx_dim_time_month ON dim_time(year, month);
            RAISE NOTICE 'ç´¢å¼• idx_dim_time_month åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. äº§å“ç»´åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'dim_product') THEN
            CREATE TABLE dim_product (
                product_id INTEGER PRIMARY KEY,
                product_name VARCHAR(100) NOT NULL,
                category_id INTEGER NOT NULL,
                category_name VARCHAR(50) NOT NULL,
                brand VARCHAR(50),
                price NUMERIC(10,2),
                cost NUMERIC(10,2),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ dim_product åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ dim_product å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ dim_product å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ dim_product å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å®¢æˆ·ç»´åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'dim_customer') THEN
            CREATE TABLE dim_customer (
                customer_id INTEGER PRIMARY KEY,
                customer_name VARCHAR(100) NOT NULL,
                region_id INTEGER NOT NULL,
                region_name VARCHAR(50) NOT NULL,
                country VARCHAR(50),
                city VARCHAR(50),
                customer_segment VARCHAR(50),
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ dim_customer åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ dim_customer å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ dim_customer å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ dim_customer å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. é”€å”®äº‹å®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'fact_sales') THEN
            CREATE TABLE fact_sales (
                sale_id BIGSERIAL PRIMARY KEY,
                time_id INTEGER NOT NULL REFERENCES dim_time(time_id),
                product_id INTEGER NOT NULL REFERENCES dim_product(product_id),
                customer_id INTEGER NOT NULL REFERENCES dim_customer(customer_id),
                -- åº¦é‡ï¼ˆMeasuresï¼‰
                sales_amount NUMERIC(12,2) NOT NULL,
                quantity INTEGER NOT NULL,
                discount_amount NUMERIC(12,2) DEFAULT 0,
                profit_amount NUMERIC(12,2),
                -- å…ƒæ•°æ®
                created_at TIMESTAMPTZ DEFAULT NOW()
            ) PARTITION BY RANGE (created_at);
            RAISE NOTICE 'è¡¨ fact_sales åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ fact_sales å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ fact_sales å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ fact_sales å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    -- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'fact_sales') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_fact_sales_time') THEN
                CREATE INDEX idx_fact_sales_time ON fact_sales(time_id);
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_fact_sales_product') THEN
                CREATE INDEX idx_fact_sales_product ON fact_sales(product_id);
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_fact_sales_customer') THEN
                CREATE INDEX idx_fact_sales_customer ON fact_sales(customer_id);
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_fact_sales_composite') THEN
                CREATE INDEX idx_fact_sales_composite ON fact_sales(time_id, product_id, customer_id);
            END IF;
            RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. åˆ†åŒºç­–ç•¥ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'fact_sales') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_inherits WHERE inhrelid = 'fact_sales_2024'::regclass) THEN
                CREATE TABLE fact_sales_2024 PARTITION OF fact_sales
                    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
                RAISE NOTICE 'åˆ†åŒº fact_sales_2024 åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE NOTICE 'åˆ†åŒº fact_sales_2024 å·²å­˜åœ¨';
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_inherits WHERE inhrelid = 'fact_sales_2025'::regclass) THEN
                CREATE TABLE fact_sales_2025 PARTITION OF fact_sales
                    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
                RAISE NOTICE 'åˆ†åŒº fact_sales_2025 åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE NOTICE 'åˆ†åŒº fact_sales_2025 å·²å­˜åœ¨';
            END IF;
        ELSE
            RAISE WARNING 'è¡¨ fact_sales ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºåˆ†åŒº';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'åˆ†åŒºå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

#### 4.1.2 OLAPæ“ä½œå®ç°

**ä¸Šå·ï¼ˆRoll-upï¼‰æ“ä½œ**ï¼š

```sql
-- ä¸Šå·ï¼šä»æœˆä»½èšåˆåˆ°å­£åº¦ï¼Œå†åˆ°å¹´åº¦ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    t.quarter,
    t.month,
    SUM(f.sales_amount) AS total_sales,
    SUM(f.quantity) AS total_quantity,
    COUNT(*) AS transaction_count
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
WHERE t.year = 2024
GROUP BY ROLLUP(t.year, t.quarter, t.month)
ORDER BY t.year, t.quarter, t.month
LIMIT 100;
```

**ä¸‹é’»ï¼ˆDrill-downï¼‰æ“ä½œ**ï¼š

```sql
-- ä¸‹é’»ï¼šä»å¹´åº¦ä¸‹é’»åˆ°å­£åº¦ï¼Œå†åˆ°æœˆä»½ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH yearly_summary AS (
    SELECT
        t.year,
        SUM(f.sales_amount) AS total_sales
    FROM fact_sales f
    JOIN dim_time t ON f.time_id = t.time_id
    GROUP BY t.year
)
SELECT
    t.year,
    t.quarter,
    SUM(f.sales_amount) AS quarterly_sales,
    (SELECT total_sales FROM yearly_summary WHERE year = t.year) AS yearly_total
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
WHERE t.year = 2024
GROUP BY t.year, t.quarter
ORDER BY t.year, t.quarter
LIMIT 100;
```

**åˆ‡ç‰‡ï¼ˆSliceï¼‰æ“ä½œ**ï¼š

```sql
-- åˆ‡ç‰‡ï¼šé€‰æ‹©ç‰¹å®šç»´åº¦å€¼ï¼ˆ2024å¹´Q1ï¼‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    p.category_name,
    c.region_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_customer c ON f.customer_id = c.customer_id
WHERE t.year = 2024 AND t.quarter = 1  -- åˆ‡ç‰‡æ¡ä»¶
GROUP BY p.category_name, c.region_name
ORDER BY total_sales DESC
LIMIT 100;
```

**åˆ‡å—ï¼ˆDiceï¼‰æ“ä½œ**ï¼š

```sql
-- åˆ‡å—ï¼šé€‰æ‹©å¤šä¸ªç»´åº¦å€¼çš„ç»„åˆï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.month,
    p.category_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
WHERE t.year = 2024
  AND t.quarter IN (1, 2)  -- åˆ‡å—æ¡ä»¶1
  AND p.category_name IN ('Electronics', 'Clothing')  -- åˆ‡å—æ¡ä»¶2
GROUP BY t.month, p.category_name
ORDER BY t.month, p.category_name
LIMIT 100;
```

#### 4.1.3 ç‰©åŒ–è§†å›¾ä¼˜åŒ–

**åˆ›å»ºç‰©åŒ–è§†å›¾**ï¼š

```sql
-- åˆ›å»ºé¢„èšåˆç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_matviews WHERE matviewname = 'mv_sales_monthly') THEN
            CREATE MATERIALIZED VIEW mv_sales_monthly AS
            SELECT
                t.year,
                t.month,
                p.category_name,
                c.region_name,
                SUM(f.sales_amount) AS total_sales,
                SUM(f.quantity) AS total_quantity,
                SUM(f.profit_amount) AS total_profit,
                COUNT(*) AS transaction_count
            FROM fact_sales f
            JOIN dim_time t ON f.time_id = t.time_id
            JOIN dim_product p ON f.product_id = p.product_id
            JOIN dim_customer c ON f.customer_id = c.customer_id
            GROUP BY t.year, t.month, p.category_name, c.region_name;
            RAISE NOTICE 'ç‰©åŒ–è§†å›¾ mv_sales_monthly åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç‰©åŒ–è§†å›¾ mv_sales_monthly å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç‰©åŒ–è§†å›¾å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    -- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_matviews WHERE matviewname = 'mv_sales_monthly') THEN
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_mv_sales_monthly_lookup') THEN
                CREATE INDEX idx_mv_sales_monthly_lookup
                ON mv_sales_monthly(year, month, category_name, region_name);
                RAISE NOTICE 'ç´¢å¼• idx_mv_sales_monthly_lookup åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE NOTICE 'ç´¢å¼• idx_mv_sales_monthly_lookup å·²å­˜åœ¨';
            END IF;
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    -- è‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾ï¼ˆä½¿ç”¨pg_cronæ‰©å±•ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_cron') THEN
            IF NOT EXISTS (SELECT 1 FROM cron.job WHERE jobname = 'refresh-sales-monthly') THEN
                PERFORM cron.schedule(
                    'refresh-sales-monthly',
                    '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨2ç‚¹
                    $$REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_monthly$$
                );
                RAISE NOTICE 'å®šæ—¶ä»»åŠ¡ refresh-sales-monthly åˆ›å»ºæˆåŠŸ';
            ELSE
                RAISE NOTICE 'å®šæ—¶ä»»åŠ¡ refresh-sales-monthly å·²å­˜åœ¨';
            END IF;
        ELSE
            RAISE WARNING 'æ‰©å±• pg_cron æœªå®‰è£…ï¼Œæ— æ³•åˆ›å»ºå®šæ—¶ä»»åŠ¡';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šç”µå•†é”€å”®åˆ†æ

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

æŸç”µå•†å¹³å°éœ€è¦åˆ†æé”€å”®æ•°æ®ï¼Œæ”¯æŒæŒ‰æ—¶é—´ã€äº§å“ç±»åˆ«ã€åœ°åŒºç­‰ç»´åº¦è¿›è¡Œå¤šç»´åº¦åˆ†æï¼Œç”Ÿæˆé”€å”®æŠ¥è¡¨ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- å¤šç»´åˆ†ææŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    t.quarter,
    p.category_name,
    c.region_name,
    SUM(f.sales_amount) AS total_sales,
    SUM(f.profit_amount) AS total_profit,
    AVG(f.sales_amount) AS avg_transaction_value,
    COUNT(DISTINCT f.customer_id) AS unique_customers
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_customer c ON f.customer_id = c.customer_id
WHERE t.year >= 2023
GROUP BY CUBE(t.year, t.quarter, p.category_name, c.region_name)
ORDER BY t.year, t.quarter, p.category_name, c.region_name
LIMIT 100;
```

**SQLite 3.45å¯¹æ¯”**ï¼š

SQLite 3.45ä¸æ”¯æŒCUBEå’ŒROLLUPï¼Œéœ€è¦ä½¿ç”¨UNIONæ¨¡æ‹Ÿï¼š

```sql
-- SQLite 3.45å®ç°ï¼ˆä½¿ç”¨UNIONæ¨¡æ‹ŸCUBEï¼‰
SELECT year, quarter, category_name, region_name, total_sales
FROM (
    SELECT t.year, t.quarter, p.category_name, c.region_name,
           SUM(f.sales_amount) AS total_sales
    FROM fact_sales f
    JOIN dim_time t ON f.time_id = t.time_id
    JOIN dim_product p ON f.product_id = p.product_id
    JOIN dim_customer c ON f.customer_id = c.customer_id
    GROUP BY t.year, t.quarter, p.category_name, c.region_name

    UNION ALL

    -- èšåˆåˆ°å­£åº¦çº§åˆ«
    SELECT t.year, t.quarter, NULL, NULL, SUM(f.sales_amount)
    FROM fact_sales f
    JOIN dim_time t ON f.time_id = t.time_id
    GROUP BY t.year, t.quarter
);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | PostgreSQL 18 | SQLite 3.45 | è¯´æ˜ |
| --- | --- | --- | --- |
| **CUBEæŸ¥è¯¢** | <100ms | éœ€è¦UNIONæ¨¡æ‹Ÿ | PostgreSQLåŸç”Ÿæ”¯æŒ |
| **ç‰©åŒ–è§†å›¾** | æ”¯æŒå¹¶å‘åˆ·æ–° | ä¸æ”¯æŒ | PostgreSQLæ€§èƒ½æ›´å¥½ |
| **åˆ†åŒºæŸ¥è¯¢** | åˆ†åŒºè£å‰ªä¼˜åŒ– | æœ‰é™æ”¯æŒ | PostgreSQLä¼˜åŒ–æ›´å¥½ |
| **é€‚ç”¨åœºæ™¯** | ä¼ä¸šçº§æ•°æ®ä»“åº“ | å°å‹åˆ†æ | æ ¹æ®è§„æ¨¡é€‰æ‹© |

**å®æ–½æ•ˆæœ**ï¼š

- **æŸ¥è¯¢æ€§èƒ½**ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾åï¼Œå¸¸ç”¨æŸ¥è¯¢ä»5ç§’é™ä½åˆ°50msï¼ˆ99%æå‡ï¼‰
- **å­˜å‚¨ä¼˜åŒ–**ï¼šåˆ†åŒºç­–ç•¥ä½¿å­˜å‚¨ç©ºé—´å‡å°‘30%
- **åˆ†ææ•ˆç‡**ï¼šå¤šç»´åˆ†æå“åº”æ—¶é—´ä»åˆ†é’Ÿçº§é™ä½åˆ°ç§’çº§

#### åœºæ™¯2ï¼šè´¢åŠ¡æ•°æ®ä»“åº“

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

è´¢åŠ¡ç³»ç»Ÿéœ€è¦æŒ‰ä¼šè®¡æœŸé—´ã€ç§‘ç›®ã€éƒ¨é—¨ç­‰ç»´åº¦åˆ†æè´¢åŠ¡æ•°æ®ï¼Œæ”¯æŒé¢„ç®—å¯¹æ¯”å’Œè¶‹åŠ¿åˆ†æã€‚

**å®ç°æ–¹æ¡ˆ**ï¼š

```sql
-- è´¢åŠ¡äº‹å®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'fact_financial') THEN
            CREATE TABLE fact_financial (
                financial_id BIGSERIAL,
                period_id INTEGER NOT NULL REFERENCES dim_period(period_id),
                account_id INTEGER NOT NULL REFERENCES dim_account(account_id),
                department_id INTEGER NOT NULL REFERENCES dim_department(department_id),
                amount NUMERIC(15,2) NOT NULL,
                budget_amount NUMERIC(15,2),
                variance NUMERIC(15,2) GENERATED ALWAYS AS (amount - budget_amount) STORED
            ) PARTITION BY RANGE (period_id);
            RAISE NOTICE 'è¡¨ fact_financial åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¡¨ fact_financial å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'è¡¨ fact_financial å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ fact_financial å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é¢„ç®—å¯¹æ¯”åˆ†æï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    p.fiscal_year,
    p.fiscal_quarter,
    a.account_name,
    d.department_name,
    SUM(f.amount) AS actual_amount,
    SUM(f.budget_amount) AS budget_amount,
    SUM(f.variance) AS total_variance,
    ROUND(100.0 * SUM(f.variance) / NULLIF(SUM(f.budget_amount), 0), 2) AS variance_percent
FROM fact_financial f
JOIN dim_period p ON f.period_id = p.period_id
JOIN dim_account a ON f.account_id = a.account_id
JOIN dim_department d ON f.department_id = d.department_id
WHERE p.fiscal_year = 2024
GROUP BY ROLLUP(p.fiscal_year, p.fiscal_quarter, a.account_name, d.department_name)
HAVING SUM(f.budget_amount) > 0
ORDER BY ABS(SUM(f.variance)) DESC
LIMIT 100;
```

---

## 5. ç›¸å…³æ–‡æ¡£

### 5.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](../../25-ç†è®ºä½“ç³»/25.01-å½¢å¼åŒ–æ–¹æ³•/01.05-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 6. å‚è€ƒæ–‡çŒ®

### 6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Chaudhuri, S., & Dayal, U. (1997). "An Overview of Data Warehousing and OLAP Technology."**
  - ä¼šè®®: SIGMOD Record 1997
  - **é‡è¦æ€§**: æ•°æ®ä»“åº“å’ŒOLAPçš„ç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: æ€»ç»“äº†å¤šç»´æ¨¡å‹å’ŒOLAPæ“ä½œ

- **Gray, J., et al. (1997). "Data Cube: A Relational Aggregation Operator Generalizing Group-By, Cross-Tab, and Sub-Totals."**
  - ä¼šè®®: Data Mining and Knowledge Discovery 1997
  - **é‡è¦æ€§**: æ•°æ®ç«‹æ–¹ä½“çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¤šç»´èšåˆæ“ä½œ

### 6.2 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - è¡¨ç»§æ‰¿](<https://www.postgresql.org/docs/current/ddl-inherit.html>)**
  - PostgreSQLè¡¨ç»§æ‰¿å¯ç”¨äºå®ç°ç»´åº¦æ¨¡å‹

### 6.3 ç›¸å…³æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
