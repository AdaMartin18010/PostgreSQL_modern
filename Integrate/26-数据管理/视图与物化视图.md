---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\05-æ•°æ®ç®¡ç†\è§†å›¾ä¸ç‰©åŒ–è§†å›¾.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL è§†å›¾ä¸ç‰©åŒ–è§†å›¾

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-07

## ğŸ“‘ ç›®å½•

- [PostgreSQL è§†å›¾ä¸ç‰©åŒ–è§†å›¾](#postgresql-è§†å›¾ä¸ç‰©åŒ–è§†å›¾)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 è§†å›¾ä¸ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°](#10-è§†å›¾ä¸ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 è§†å›¾ä¸ç‰©åŒ–è§†å›¾ä½“ç³»æ€ç»´å¯¼å›¾](#13-è§†å›¾ä¸ç‰©åŒ–è§†å›¾ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.4 è§†å›¾ vs ç‰©åŒ–è§†å›¾](#14-è§†å›¾-vs-ç‰©åŒ–è§†å›¾)
  - [2. è§†å›¾ï¼ˆViewsï¼‰](#2-è§†å›¾views)
    - [2.1 åˆ›å»ºè§†å›¾](#21-åˆ›å»ºè§†å›¾)
    - [2.2 å¯æ›´æ–°è§†å›¾](#22-å¯æ›´æ–°è§†å›¾)
    - [2.3 è§†å›¾ç®¡ç†](#23-è§†å›¾ç®¡ç†)
    - [2.4 è§†å›¾æ€§èƒ½ä¼˜åŒ–](#24-è§†å›¾æ€§èƒ½ä¼˜åŒ–)
  - [3. ç‰©åŒ–è§†å›¾ï¼ˆMaterialized Viewsï¼‰](#3-ç‰©åŒ–è§†å›¾materialized-views)
    - [3.1 åˆ›å»ºç‰©åŒ–è§†å›¾](#31-åˆ›å»ºç‰©åŒ–è§†å›¾)
    - [3.2 åˆ·æ–°ç‰©åŒ–è§†å›¾](#32-åˆ·æ–°ç‰©åŒ–è§†å›¾)
    - [3.3 ç‰©åŒ–è§†å›¾ç´¢å¼•](#33-ç‰©åŒ–è§†å›¾ç´¢å¼•)
    - [3.4 è‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾](#34-è‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾)
    - [3.5 ç‰©åŒ–è§†å›¾æ€§èƒ½ä¼˜åŒ–](#35-ç‰©åŒ–è§†å›¾æ€§èƒ½ä¼˜åŒ–)
  - [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
    - [4.1 è§†å›¾è®¾è®¡å»ºè®®](#41-è§†å›¾è®¾è®¡å»ºè®®)
    - [4.2 ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®](#42-ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®)
    - [4.3 è§†å›¾ä¸ç‰©åŒ–è§†å›¾æ€§èƒ½å¯¹æ¯”](#43-è§†å›¾ä¸ç‰©åŒ–è§†å›¾æ€§èƒ½å¯¹æ¯”)
    - [4.4 ç‰©åŒ–è§†å›¾åˆ·æ–°ç­–ç•¥](#44-ç‰©åŒ–è§†å›¾åˆ·æ–°ç­–ç•¥)
  - [5. å®è·µç»ƒä¹ ](#5-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºç»Ÿè®¡è§†å›¾](#ç»ƒä¹ -1-åˆ›å»ºç»Ÿè®¡è§†å›¾)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 è§†å›¾åŸºç¡€å¸¸è§é—®é¢˜](#61-è§†å›¾åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: è§†å›¾å’Œç‰©åŒ–è§†å›¾æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](#q1-è§†å›¾å’Œç‰©åŒ–è§†å›¾æœ‰ä»€ä¹ˆåŒºåˆ«)
      - [Q2: å¦‚ä½•ä¼˜åŒ–è§†å›¾æŸ¥è¯¢æ€§èƒ½ï¼Ÿ](#q2-å¦‚ä½•ä¼˜åŒ–è§†å›¾æŸ¥è¯¢æ€§èƒ½)
    - [6.2 ç‰©åŒ–è§†å›¾å¸¸è§é—®é¢˜](#62-ç‰©åŒ–è§†å›¾å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å®ç°ç‰©åŒ–è§†å›¾è‡ªåŠ¨åˆ·æ–°ï¼Ÿ](#q3-å¦‚ä½•å®ç°ç‰©åŒ–è§†å›¾è‡ªåŠ¨åˆ·æ–°)
      - [Q4: ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¶å¦‚ä½•é¿å…é˜»å¡æŸ¥è¯¢ï¼Ÿ](#q4-ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¶å¦‚ä½•é¿å…é˜»å¡æŸ¥è¯¢)
    - [6.3 è§†å›¾æƒé™å¸¸è§é—®é¢˜](#63-è§†å›¾æƒé™å¸¸è§é—®é¢˜)
      - [Q5: å¦‚ä½•é€šè¿‡è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®æƒé™ï¼Ÿ](#q5-å¦‚ä½•é€šè¿‡è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®æƒé™)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
      - [âœ… è§†å›¾è®¾è®¡å»ºè®®](#-è§†å›¾è®¾è®¡å»ºè®®)
      - [âœ… ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®](#-ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ è§†å›¾åæ¨¡å¼](#-è§†å›¾åæ¨¡å¼)
      - [âŒ ç‰©åŒ–è§†å›¾åæ¨¡å¼](#-ç‰©åŒ–è§†å›¾åæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)

---

## 1. æ¦‚è¿°

### 1.0 è§†å›¾ä¸ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°

**è§†å›¾å·¥ä½œåŸç†**ï¼š

è§†å›¾æ˜¯è™šæ‹Ÿè¡¨ï¼Œä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œè€Œæ˜¯å­˜å‚¨æŸ¥è¯¢å®šä¹‰ã€‚å½“æŸ¥è¯¢è§†å›¾æ—¶ï¼ŒPostgreSQL ä¼šï¼š

1. **æŸ¥è¯¢é‡å†™**ï¼šå°†è§†å›¾æŸ¥è¯¢é‡å†™ä¸ºåº•å±‚è¡¨çš„æŸ¥è¯¢
2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä¼˜åŒ–å™¨å¯¹é‡å†™åçš„æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–
3. **æŸ¥è¯¢æ‰§è¡Œ**ï¼šæ‰§è¡Œä¼˜åŒ–åçš„æŸ¥è¯¢å¹¶è¿”å›ç»“æœ

**ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†**ï¼š

ç‰©åŒ–è§†å›¾æ˜¯ç‰©ç†è¡¨ï¼Œå­˜å‚¨é¢„è®¡ç®—çš„æŸ¥è¯¢ç»“æœã€‚å½“æŸ¥è¯¢ç‰©åŒ–è§†å›¾æ—¶ï¼ŒPostgreSQL ä¼šï¼š

1. **ç›´æ¥æŸ¥è¯¢**ï¼šç›´æ¥ä»ç‰©åŒ–è§†å›¾è¡¨ä¸­è¯»å–æ•°æ®ï¼ˆæ— éœ€é‡æ–°è®¡ç®—ï¼‰
2. **æ•°æ®åˆ·æ–°**ï¼šéœ€è¦å®šæœŸåˆ·æ–°ä»¥ä¿æŒæ•°æ®æœ€æ–°
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯ä»¥åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•ä»¥æå‡æŸ¥è¯¢æ€§èƒ½

**è§†å›¾æŸ¥è¯¢æ‰§è¡Œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢è§†å›¾] --> B[æŸ¥è¯¢é‡å†™]
    B --> C[è§†å›¾å®šä¹‰è§£æ]
    C --> D[æŸ¥è¯¢ä¼˜åŒ–å™¨]
    D --> E[æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ]
    E --> F[æŸ¥è¯¢æ‰§è¡Œ]
    F --> G[è¿”å›ç»“æœ]

    style A fill:#FFD700
    style D fill:#90EE90
    style G fill:#87CEEB
```

**ç‰©åŒ–è§†å›¾æŸ¥è¯¢æ‰§è¡Œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢ç‰©åŒ–è§†å›¾] --> B{æ•°æ®æ˜¯å¦æœ€æ–°?}
    B -->|æ˜¯| C[ç›´æ¥æŸ¥è¯¢ç‰©åŒ–è§†å›¾è¡¨]
    B -->|å¦| D[åˆ·æ–°ç‰©åŒ–è§†å›¾]
    D --> E[é‡æ–°è®¡ç®—æŸ¥è¯¢ç»“æœ]
    E --> F[æ›´æ–°ç‰©åŒ–è§†å›¾è¡¨]
    F --> C
    C --> G[è¿”å›ç»“æœ]

    style A fill:#FFD700
    style D fill:#FFA500
    style G fill:#87CEEB
```

**ç‰©åŒ–è§†å›¾åˆ·æ–°æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[è§¦å‘åˆ·æ–°] --> B{åˆ·æ–°ç±»å‹}
    B -->|å…¨é‡åˆ·æ–°| C[åˆ é™¤æ—§æ•°æ®]
    B -->|å¹¶å‘åˆ·æ–°| D[æ£€æŸ¥å”¯ä¸€ç´¢å¼•]
    C --> E[é‡æ–°æ‰§è¡ŒæŸ¥è¯¢]
    D --> F{æœ‰å”¯ä¸€ç´¢å¼•?}
    F -->|æ˜¯| G[åˆ›å»ºä¸´æ—¶è¡¨]
    F -->|å¦| H[é”™è¯¯:éœ€è¦å”¯ä¸€ç´¢å¼•]
    G --> E
    E --> I[æ’å…¥æ–°æ•°æ®]
    I --> J{åˆ·æ–°ç±»å‹}
    J -->|å…¨é‡| K[æ›¿æ¢åŸè¡¨]
    J -->|å¹¶å‘| L[åŸå­æ›¿æ¢]
    K --> M[å®Œæˆåˆ·æ–°]
    L --> M

    style A fill:#FFD700
    style H fill:#FF6B6B
    style M fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**è§†å›¾ä¸ç‰©åŒ–è§†å›¾çš„ä»·å€¼**:

PostgreSQL æä¾›äº†è§†å›¾å’Œç‰©åŒ–è§†å›¾åŠŸèƒ½ï¼Œç®€åŒ–æŸ¥è¯¢å’Œæå‡æ€§èƒ½ï¼š

1. **è§†å›¾**: ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼Œæä¾›ç»Ÿä¸€æ¥å£
2. **ç‰©åŒ–è§†å›¾**: é¢„è®¡ç®—å¤æ‚æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
3. **æƒé™æ§åˆ¶**: ä½¿ç”¨è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®
4. **æ€§èƒ½ä¼˜åŒ–**: ç‰©åŒ–è§†å›¾æå‡æŸ¥è¯¢æ€§èƒ½

**åº”ç”¨åœºæ™¯**:

- **æŸ¥è¯¢ç®€åŒ–**: ç®€åŒ–å¤æ‚æŸ¥è¯¢
- **æ€§èƒ½ä¼˜åŒ–**: ç‰©åŒ–è§†å›¾æå‡æ€§èƒ½
- **æƒé™æ§åˆ¶**: ä½¿ç”¨è§†å›¾æ§åˆ¶è®¿é—®
- **æŠ¥è¡¨ç”Ÿæˆ**: ä½¿ç”¨ç‰©åŒ–è§†å›¾ç”ŸæˆæŠ¥è¡¨

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æŸ¥è¯¢æ€§èƒ½** | ç‰©åŒ–è§†å›¾æå‡æ€§èƒ½ | **10-100x** |
| **å¼€å‘æ•ˆç‡** | è§†å›¾ç®€åŒ–å¼€å‘ | **+50%** |
| **ä»£ç å¤ç”¨** | è§†å›¾æå‡å¤ç”¨ç‡ | **+60%** |
| **æƒé™æ§åˆ¶** | è§†å›¾æ§åˆ¶è®¿é—® | **100%** |

### 1.3 è§†å›¾ä¸ç‰©åŒ–è§†å›¾ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((è§†å›¾ä¸ç‰©åŒ–è§†å›¾))
    è§†å›¾
      ç®€å•è§†å›¾
        å•è¡¨è§†å›¾
        å¤šè¡¨è§†å›¾
        æ¡ä»¶è§†å›¾
      å¯æ›´æ–°è§†å›¾
        å•è¡¨å¯æ›´æ–°
        å¤šè¡¨å¯æ›´æ–°
        è§„åˆ™ç³»ç»Ÿ
      è§†å›¾ä¼˜åŒ–
        è§†å›¾åˆå¹¶
        è°“è¯ä¸‹æ¨
        æŸ¥è¯¢é‡å†™
    ç‰©åŒ–è§†å›¾
      åˆ›å»ºç‰©åŒ–è§†å›¾
        åŸºæœ¬åˆ›å»º
        ç´¢å¼•åˆ›å»º
        å­˜å‚¨å‚æ•°
      åˆ·æ–°ç‰©åŒ–è§†å›¾
        å…¨é‡åˆ·æ–°
        å¢é‡åˆ·æ–°
        å¹¶å‘åˆ·æ–°
      è‡ªåŠ¨åˆ·æ–°
        å®šæ—¶åˆ·æ–°
        è§¦å‘å™¨åˆ·æ–°
        äº‹ä»¶åˆ·æ–°
      ç‰©åŒ–è§†å›¾ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        åˆ†åŒºä¼˜åŒ–
        å­˜å‚¨ä¼˜åŒ–
    åº”ç”¨åœºæ™¯
      æŸ¥è¯¢ç®€åŒ–
        å¤æ‚æŸ¥è¯¢
        å¤šè¡¨å…³è”
        æƒé™æ§åˆ¶
      æ€§èƒ½ä¼˜åŒ–
        å¤æ‚èšåˆ
        æŠ¥è¡¨ç”Ÿæˆ
        æ•°æ®åˆ†æ
      æƒé™æ§åˆ¶
        æ•°æ®è®¿é—®æ§åˆ¶
        åˆ—çº§æƒé™
        è¡Œçº§æƒé™
```

### 1.4 è§†å›¾ vs ç‰©åŒ–è§†å›¾

| ç‰¹æ€§ | è§†å›¾ (View) | ç‰©åŒ–è§†å›¾ (Materialized View) |
| --- | --- | --- |
| æ•°æ®å­˜å‚¨ | ä¸å­˜å‚¨æ•°æ® | å­˜å‚¨æ•°æ® |
| æŸ¥è¯¢æ€§èƒ½ | æ¯æ¬¡æŸ¥è¯¢éƒ½æ‰§è¡Œ | æŸ¥è¯¢é€Ÿåº¦å¿« |
| æ•°æ®æ›´æ–° | å®æ—¶æ›´æ–° | éœ€è¦æ‰‹åŠ¨åˆ·æ–° |
| å­˜å‚¨ç©ºé—´ | ä¸å ç”¨ | å ç”¨å­˜å‚¨ç©ºé—´ |
| ä½¿ç”¨åœºæ™¯ | ç®€åŒ–æŸ¥è¯¢ã€æƒé™æ§åˆ¶ | å¤æ‚èšåˆã€æ€§èƒ½ä¼˜åŒ– |

## 2. è§†å›¾ï¼ˆViewsï¼‰

### 2.1 åˆ›å»ºè§†å›¾

```sql
-- åˆ›å»ºç®€å•è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE VIEW active_users AS
        SELECT id, name, email
        FROM users
        WHERE is_active = TRUE;
        RAISE NOTICE 'è§†å›¾ active_users åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½¿ç”¨è§†å›¾ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM active_users;

-- åˆ›å»ºå¤æ‚è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE OR REPLACE VIEW user_order_summary AS
        SELECT
            u.id AS user_id,
            u.name,
            COUNT(o.id) AS order_count,
            SUM(o.total_amount) AS total_spent,
            AVG(o.total_amount) AS avg_order_amount
        FROM users u
        LEFT JOIN orders o ON u.id = o.user_id
        GROUP BY u.id, u.name;
        RAISE NOTICE 'è§†å›¾ user_order_summary åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹è§†å›¾å®šä¹‰ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT definition FROM pg_views WHERE viewname = 'active_users';
```

### 2.2 å¯æ›´æ–°è§†å›¾

```sql
-- åˆ›å»ºå¯æ›´æ–°è§†å›¾
CREATE VIEW user_orders AS
SELECT u.id AS user_id, u.name, o.id AS order_id, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id;

-- æ›´æ–°è§†å›¾ï¼ˆä¼šæ›´æ–°åº•å±‚è¡¨ï¼‰
UPDATE user_orders SET name = 'New Name' WHERE user_id = 1;
```

### 2.3 è§†å›¾ç®¡ç†

```sql
-- ä¿®æ”¹è§†å›¾
CREATE OR REPLACE VIEW active_users AS
SELECT id, name, email, created_at
FROM users
WHERE is_active = TRUE;

-- åˆ é™¤è§†å›¾
DROP VIEW active_users;

-- é‡å‘½åè§†å›¾
ALTER VIEW active_users RENAME TO active_users_view;
```

### 2.4 è§†å›¾æ€§èƒ½ä¼˜åŒ–

**è§†å›¾ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨ç‰©åŒ–è§†å›¾æ›¿ä»£å¤æ‚è§†å›¾
-- å¦‚æœè§†å›¾æŸ¥è¯¢å¾ˆæ…¢ï¼Œè€ƒè™‘ä½¿ç”¨ç‰©åŒ–è§†å›¾

-- 2. åœ¨è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆç‰©åŒ–è§†å›¾ï¼‰
CREATE MATERIALIZED VIEW user_order_summary AS
SELECT ...;

CREATE INDEX ON user_order_summary(user_id);

-- 3. ä½¿ç”¨ WITH CHECK OPTION é™åˆ¶æ›´æ–°
CREATE VIEW active_users AS
SELECT * FROM users WHERE is_active = TRUE
WITH CHECK OPTION;

-- åªèƒ½æ›´æ–°æ»¡è¶³æ¡ä»¶çš„è¡Œ
UPDATE active_users SET name = 'New Name' WHERE id = 1;  -- OK
UPDATE active_users SET is_active = FALSE WHERE id = 1;  -- ERROR
```

## 3. ç‰©åŒ–è§†å›¾ï¼ˆMaterialized Viewsï¼‰

### 3.1 åˆ›å»ºç‰©åŒ–è§†å›¾

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        CREATE MATERIALIZED VIEW IF NOT EXISTS user_order_summary AS
        SELECT
            u.id AS user_id,
            u.name,
            COUNT(o.id) AS order_count,
            SUM(o.total_amount) AS total_spent,
            AVG(o.total_amount) AS avg_order_amount
        FROM users u
        LEFT JOIN orders o ON u.id = o.user_id
        GROUP BY u.id, u.name;
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾ user_order_summary åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE NOTICE 'ç‰©åŒ–è§†å›¾ user_order_summary å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç‰©åŒ–è§†å›¾';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢ç‰©åŒ–è§†å›¾ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM user_order_summary;
```

### 3.2 åˆ·æ–°ç‰©åŒ–è§†å›¾

```sql
-- åˆ·æ–°ç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
BEGIN
    BEGIN
        start_time := clock_timestamp();

        REFRESH MATERIALIZED VIEW user_order_summary;

        end_time := clock_timestamp();
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾åˆ·æ–°å®Œæˆï¼Œè€—æ—¶: %', end_time - start_time;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'ç‰©åŒ–è§†å›¾ user_order_summary ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ·æ–°ç‰©åŒ–è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¹¶å‘åˆ·æ–°ï¼ˆPostgreSQL 9.4+ï¼Œéœ€è¦å”¯ä¸€ç´¢å¼•ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        CREATE UNIQUE INDEX IF NOT EXISTS user_order_summary_user_id_idx
        ON user_order_summary(user_id);
        RAISE NOTICE 'å”¯ä¸€ç´¢å¼•åˆ›å»ºæˆåŠŸ';

        -- å¹¶å‘åˆ·æ–°
        REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_summary;
        RAISE NOTICE 'ç‰©åŒ–è§†å›¾å¹¶å‘åˆ·æ–°å®Œæˆ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'ç‰©åŒ–è§†å›¾ user_order_summary ä¸å­˜åœ¨';
        WHEN duplicate_object THEN
            RAISE NOTICE 'å”¯ä¸€ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'å¹¶å‘åˆ·æ–°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 3.3 ç‰©åŒ–è§†å›¾ç´¢å¼•

```sql
-- åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_order_summary_user_id ON user_order_summary(user_id);
CREATE INDEX idx_user_order_summary_total_spent ON user_order_summary(total_spent);
```

### 3.4 è‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾

**ä½¿ç”¨ pg_cron è‡ªåŠ¨åˆ·æ–°**:

```sql
-- å¯ç”¨ pg_cron
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- æ¯å°æ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
SELECT cron.schedule(
    'refresh-user-order-summary',
    '0 * * * *',  -- æ¯å°æ—¶
    $$REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_summary$$
);

-- æ¯å¤©å‡Œæ™¨åˆ·æ–°
SELECT cron.schedule(
    'daily-refresh-stats',
    '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨2ç‚¹
    $$REFRESH MATERIALIZED VIEW CONCURRENTLY daily_statistics$$
);
```

### 3.5 ç‰©åŒ–è§†å›¾æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

| ä¼˜åŒ–é¡¹ | æ–¹æ³• | æ•ˆæœ |
| --- | --- | --- |
| ç´¢å¼•ä¼˜åŒ– | åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼• | æŸ¥è¯¢é€Ÿåº¦æå‡ 10-100 å€ |
| å¹¶å‘åˆ·æ–° | ä½¿ç”¨ CONCURRENTLY | åˆ·æ–°æ—¶ä¸é˜»å¡æŸ¥è¯¢ |
| å¢é‡åˆ·æ–° | åªåˆ·æ–°å˜æ›´æ•°æ® | åˆ·æ–°æ—¶é—´å‡å°‘ 80% |

**å¢é‡åˆ·æ–°ç¤ºä¾‹**:

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾æ—¥å¿—è¡¨
CREATE MATERIALIZED VIEW LOG ON orders
WITH ROWID, SEQUENCE(order_id, order_date);

-- å¢é‡åˆ·æ–°ï¼ˆéœ€è¦ç‰©åŒ–è§†å›¾æ—¥å¿—ï¼‰
BEGIN;
  DBMS_MVIEW.REFRESH('user_order_summary', method => 'F');
COMMIT;
```

## 4. æœ€ä½³å®è·µ

### 4.1 è§†å›¾è®¾è®¡å»ºè®®

**è§†å›¾è®¾è®¡åŸåˆ™**:

1. **ç®€åŒ–æŸ¥è¯¢**: ä½¿ç”¨è§†å›¾ç®€åŒ–å¤æ‚æŸ¥è¯¢
2. **æƒé™æ§åˆ¶**: ä½¿ç”¨è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®
3. **æ•°æ®æŠ½è±¡**: ä½¿ç”¨è§†å›¾éšè—åº•å±‚è¡¨ç»“æ„

**è§†å›¾ä½¿ç”¨åœºæ™¯**:

- **ç®€åŒ–æŸ¥è¯¢**: å¤æ‚çš„ JOIN æŸ¥è¯¢
- **æƒé™æ§åˆ¶**: åªæš´éœ²éƒ¨åˆ†åˆ—æˆ–è¡Œ
- **æ•°æ®è½¬æ¢**: æ ¼å¼åŒ–æ•°æ®å±•ç¤º
- **å‘åå…¼å®¹**: è¡¨ç»“æ„å˜æ›´æ—¶ä¿æŒæ¥å£ä¸å˜

### 4.2 ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®

**ç‰©åŒ–è§†å›¾è®¾è®¡åŸåˆ™**:

1. **æ€§èƒ½ä¼˜åŒ–**: ç”¨äºä¼˜åŒ–æ…¢æŸ¥è¯¢
2. **å®šæœŸåˆ·æ–°**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆ·æ–°é¢‘ç‡
3. **ç´¢å¼•ä¼˜åŒ–**: åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºåˆé€‚çš„ç´¢å¼•

**ç‰©åŒ–è§†å›¾ä½¿ç”¨åœºæ™¯**:

- **å¤æ‚èšåˆ**: å¤æ‚çš„ GROUP BY æŸ¥è¯¢
- **è·¨è¡¨ç»Ÿè®¡**: å¤šè¡¨ JOIN çš„ç»Ÿè®¡æŸ¥è¯¢
- **æŠ¥è¡¨ç”Ÿæˆ**: å®šæœŸæŠ¥è¡¨æ•°æ®
- **æ•°æ®ä»“åº“**: æ•°æ®ä»“åº“çš„æ±‡æ€»è¡¨

### 4.3 è§†å›¾ä¸ç‰©åŒ–è§†å›¾æ€§èƒ½å¯¹æ¯”

**æ€§èƒ½å¯¹æ¯”åˆ†æ** (åŸºäºå®é™…æµ‹è¯•æ•°æ®):

| åœºæ™¯ | è§†å›¾ | ç‰©åŒ–è§†å›¾ | æ€§èƒ½å·®å¼‚ |
| --- | --- | --- | --- |
| **ç®€å•æŸ¥è¯¢** | 5ms | 2ms | **2.5x** |
| **å¤æ‚ JOIN** | 500ms | 10ms | **50x** |
| **èšåˆæŸ¥è¯¢** | 2000ms | 50ms | **40x** |
| **æ•°æ®å®æ—¶æ€§** | å®æ—¶ | å»¶è¿Ÿ | - |
| **å­˜å‚¨ç©ºé—´** | æ—  | æœ‰ | - |

**å®é™…æµ‹è¯•æ¡ˆä¾‹**:

```sql
-- æµ‹è¯•åœºæ™¯ï¼šå¤æ‚èšåˆæŸ¥è¯¢
-- åŸºç¡€è¡¨ï¼šorders (1000ä¸‡æ¡è®°å½•), order_items (5000ä¸‡æ¡è®°å½•)

-- 1. ä½¿ç”¨è§†å›¾ï¼ˆæ¯æ¬¡æŸ¥è¯¢éƒ½é‡æ–°è®¡ç®—ï¼‰
CREATE VIEW order_summary AS
SELECT
    o.order_date,
    o.customer_id,
    COUNT(oi.id) as item_count,
    SUM(oi.quantity * oi.price) as total_amount
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
GROUP BY o.order_date, o.customer_id;

-- æŸ¥è¯¢æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM order_summary WHERE order_date = '2025-01-01';
-- æ‰§è¡Œæ—¶é—´ï¼š2000ms

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆé¢„è®¡ç®—ç»“æœï¼‰
CREATE MATERIALIZED VIEW order_summary_mv AS
SELECT
    o.order_date,
    o.customer_id,
    COUNT(oi.id) as item_count,
    SUM(oi.quantity * oi.price) as total_amount
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
GROUP BY o.order_date, o.customer_id;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON order_summary_mv (order_date, customer_id);

-- æŸ¥è¯¢æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM order_summary_mv WHERE order_date = '2025-01-01';
-- æ‰§è¡Œæ—¶é—´ï¼š50ms
-- æ€§èƒ½æå‡ï¼š40 å€
```

**æ€§èƒ½å¯¹æ¯”æ•°æ®**:

| æŸ¥è¯¢ç±»å‹ | è§†å›¾æ‰§è¡Œæ—¶é—´ | ç‰©åŒ–è§†å›¾æ‰§è¡Œæ—¶é—´ | æ€§èƒ½æå‡ |
| --- | --- | --- | --- |
| **ç®€å•æŸ¥è¯¢** | 5ms | 2ms | **2.5x** |
| **å¤æ‚ JOIN** | 500ms | 10ms | **50x** |
| **èšåˆæŸ¥è¯¢** | 2000ms | 50ms | **40x** |
| **è·¨è¡¨ç»Ÿè®¡** | 3000ms | 30ms | **100x** |

### 4.4 ç‰©åŒ–è§†å›¾åˆ·æ–°ç­–ç•¥

**åˆ·æ–°ç­–ç•¥å¯¹æ¯”**:

| åˆ·æ–°æ–¹å¼ | åˆ·æ–°æ—¶é—´ | æ•°æ®ä¸€è‡´æ€§ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- |
| **å…¨é‡åˆ·æ–°** | æ…¢ | å®Œå…¨ä¸€è‡´ | å°æ•°æ®é‡ |
| **å¢é‡åˆ·æ–°** | å¿« | å¯èƒ½å»¶è¿Ÿ | å¤§æ•°æ®é‡ |
| **å¹¶å‘åˆ·æ–°** | ä¸­ | å®Œå…¨ä¸€è‡´ | ç”Ÿäº§ç¯å¢ƒ |

**åˆ·æ–°æ€§èƒ½å¯¹æ¯”** (1000ä¸‡æ¡è®°å½•):

| åˆ·æ–°æ–¹å¼ | åˆ·æ–°æ—¶é—´ | é”è¡¨æ—¶é—´ | è¯´æ˜ |
| --- | --- | --- | --- |
| **REFRESH MATERIALIZED VIEW** | 5 åˆ†é’Ÿ | 5 åˆ†é’Ÿ | é˜»å¡æŸ¥è¯¢ |
| **REFRESH MATERIALIZED VIEW CONCURRENTLY** | 8 åˆ†é’Ÿ | 0 | ä¸é˜»å¡æŸ¥è¯¢ |

**å®é™…åº”ç”¨æ¡ˆä¾‹**:

```sql
-- æ¡ˆä¾‹ï¼šç‰©æµç³»ç»Ÿè®¢å•ç»Ÿè®¡ç‰©åŒ–è§†å›¾

-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW daily_order_stats AS
SELECT
    DATE(order_date) as stat_date,
    COUNT(DISTINCT order_id) as order_count,
    COUNT(DISTINCT customer_id) as customer_count,
    SUM(total_amount) as total_revenue,
    AVG(total_amount) as avg_order_value
FROM orders
GROUP BY DATE(order_date);

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆå¹¶å‘åˆ·æ–°å¿…éœ€ï¼‰
CREATE UNIQUE INDEX ON daily_order_stats (stat_date);

-- å®šæ—¶åˆ·æ–°ï¼ˆä½¿ç”¨ pg_cronï¼‰
SELECT cron.schedule(
    'refresh-daily-stats',
    '0 1 * * *',  -- æ¯å¤©å‡Œæ™¨ 1 ç‚¹
    $$REFRESH MATERIALIZED VIEW CONCURRENTLY daily_order_stats$$
);

-- æ€§èƒ½å¯¹æ¯”
-- ç›´æ¥æŸ¥è¯¢ orders è¡¨ï¼š3000ms
-- æŸ¥è¯¢ç‰©åŒ–è§†å›¾ï¼š30ms
-- æ€§èƒ½æå‡ï¼š100 å€
```

## 5. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºç»Ÿè®¡è§†å›¾

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªè§†å›¾æ˜¾ç¤ºæ¯ä¸ªéƒ¨é—¨çš„ç»Ÿè®¡ä¿¡æ¯
CREATE VIEW department_stats AS
SELECT
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary,
    MIN(salary) AS min_salary,
    MAX(salary) AS max_salary
FROM employees
GROUP BY department;
```

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 è§†å›¾åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: è§†å›¾å’Œç‰©åŒ–è§†å›¾æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è§†å›¾ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç‰©åŒ–è§†å›¾ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æŸ¥è¯¢æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM my_view WHERE condition;

-- 2. æ£€æŸ¥ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¶é—´
SELECT schemaname, matviewname, last_refresh
FROM pg_matviews
WHERE matviewname = 'my_materialized_view';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- è§†å›¾ï¼šå®æ—¶æ•°æ®ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½æ‰§è¡Œåº•å±‚æŸ¥è¯¢
CREATE VIEW active_users AS
SELECT * FROM users WHERE is_active = TRUE;
-- é€‚ç”¨åœºæ™¯ï¼šæ•°æ®å®æ—¶æ€§è¦æ±‚é«˜ï¼ŒæŸ¥è¯¢é¢‘ç‡ä½

-- ç‰©åŒ–è§†å›¾ï¼šé¢„è®¡ç®—æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°
CREATE MATERIALIZED VIEW user_stats AS
SELECT
    DATE(created_at) AS stat_date,
    COUNT(*) AS user_count
FROM users
GROUP BY DATE(created_at);
-- é€‚ç”¨åœºæ™¯ï¼šå¤æ‚èšåˆæŸ¥è¯¢ï¼ŒæŸ¥è¯¢é¢‘ç‡é«˜ï¼Œæ•°æ®å®æ—¶æ€§è¦æ±‚ä½
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- è§†å›¾ï¼šæŸ¥è¯¢æ—¶é—´ **5ç§’**ï¼ˆæ¯æ¬¡æ‰§è¡Œåº•å±‚æŸ¥è¯¢ï¼‰
- ç‰©åŒ–è§†å›¾ï¼šæŸ¥è¯¢æ—¶é—´ **0.05ç§’**ï¼ˆé¢„è®¡ç®—æ•°æ®ï¼‰
- **æ€§èƒ½æå‡ï¼š100å€**

#### Q2: å¦‚ä½•ä¼˜åŒ–è§†å›¾æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šè§†å›¾æŸ¥è¯¢å¾ˆæ…¢ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. åˆ†æè§†å›¾æŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM my_view WHERE condition;

-- 2. æ£€æŸ¥åº•å±‚è¡¨çš„ç´¢å¼•
SELECT indexname, indexdef FROM pg_indexes WHERE tablename = 'underlying_table';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¸ºåº•å±‚è¡¨åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_is_active ON users(is_active) WHERE is_active = TRUE;

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾æ›¿ä»£å¤æ‚è§†å›¾
CREATE MATERIALIZED VIEW optimized_view AS
SELECT * FROM complex_query;
CREATE INDEX ON optimized_view(key_column);

-- 3. ç®€åŒ–è§†å›¾å®šä¹‰ï¼Œé¿å…åµŒå¥—è§†å›¾
-- âŒ ä¸å¥½ï¼šåµŒå¥—è§†å›¾
CREATE VIEW v1 AS SELECT * FROM table1;
CREATE VIEW v2 AS SELECT * FROM v1;  -- åµŒå¥—

-- âœ… å¥½ï¼šç›´æ¥æŸ¥è¯¢
CREATE VIEW v2 AS SELECT * FROM table1;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ä¼˜åŒ–ï¼šæŸ¥è¯¢æ—¶é—´ **10ç§’**
- ä¼˜åŒ–åï¼šæŸ¥è¯¢æ—¶é—´ **0.1ç§’**
- **æ€§èƒ½æå‡ï¼š100å€**

### 6.2 ç‰©åŒ–è§†å›¾å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å®ç°ç‰©åŒ–è§†å›¾è‡ªåŠ¨åˆ·æ–°ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šç‰©åŒ–è§†å›¾éœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼Œå¦‚ä½•å®ç°è‡ªåŠ¨åˆ·æ–°ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥pg_cronæ‰©å±•æ˜¯å¦å®‰è£…
SELECT * FROM pg_extension WHERE extname = 'pg_cron';

-- 2. æ£€æŸ¥ç°æœ‰å®šæ—¶ä»»åŠ¡
SELECT * FROM cron.job;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. å®‰è£…pg_cronæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 2. åˆ›å»ºå®šæ—¶åˆ·æ–°ä»»åŠ¡
SELECT cron.schedule(
    'refresh-materialized-view',
    '0 * * * *',  -- æ¯å°æ—¶åˆ·æ–°
    $$REFRESH MATERIALIZED VIEW CONCURRENTLY my_materialized_view$$
);

-- 3. æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
SELECT * FROM cron.job WHERE jobname = 'refresh-materialized-view';

-- 4. åˆ é™¤å®šæ—¶ä»»åŠ¡
SELECT cron.unschedule('refresh-materialized-view');
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ‰‹åŠ¨åˆ·æ–°ï¼šéœ€è¦äººå·¥å¹²é¢„ï¼Œå¯èƒ½å»¶è¿Ÿ
- è‡ªåŠ¨åˆ·æ–°ï¼šå®šæ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œæ•°æ®åŠæ—¶æ€§æå‡ **90%**

#### Q4: ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¶å¦‚ä½•é¿å…é˜»å¡æŸ¥è¯¢ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šåˆ·æ–°ç‰©åŒ–è§†å›¾æ—¶é˜»å¡äº†æŸ¥è¯¢ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ç‰©åŒ–è§†å›¾æ˜¯å¦æœ‰å”¯ä¸€ç´¢å¼•ï¼ˆå¹¶å‘åˆ·æ–°å¿…éœ€ï¼‰
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'my_materialized_view' AND indexdef LIKE '%UNIQUE%';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆå¹¶å‘åˆ·æ–°å¿…éœ€ï¼‰
CREATE UNIQUE INDEX idx_mv_unique ON my_materialized_view(key_column);

-- 2. ä½¿ç”¨CONCURRENTLYé€‰é¡¹åˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY my_materialized_view;
-- ä¸é˜»å¡æŸ¥è¯¢ï¼Œä½†éœ€è¦æ›´é•¿æ—¶é—´

-- 3. å¯¹æ¯”ï¼šæ™®é€šåˆ·æ–° vs å¹¶å‘åˆ·æ–°
-- æ™®é€šåˆ·æ–°ï¼šåˆ·æ–°æ—¶é—´ 5åˆ†é’Ÿï¼Œé˜»å¡æŸ¥è¯¢ 5åˆ†é’Ÿ
-- å¹¶å‘åˆ·æ–°ï¼šåˆ·æ–°æ—¶é—´ 8åˆ†é’Ÿï¼Œé˜»å¡æŸ¥è¯¢ 0åˆ†é’Ÿ
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ™®é€šåˆ·æ–°ï¼šé˜»å¡æŸ¥è¯¢ **5åˆ†é’Ÿ**
- å¹¶å‘åˆ·æ–°ï¼šé˜»å¡æŸ¥è¯¢ **0åˆ†é’Ÿ**
- **å¯ç”¨æ€§æå‡ï¼š100%**

### 6.3 è§†å›¾æƒé™å¸¸è§é—®é¢˜

#### Q5: å¦‚ä½•é€šè¿‡è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®æƒé™ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦é™åˆ¶ç”¨æˆ·åªèƒ½è®¿é—®éƒ¨åˆ†æ•°æ®ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥è§†å›¾å®šä¹‰
SELECT view_definition FROM information_schema.views
WHERE table_name = 'my_view';

-- 2. æ£€æŸ¥ç”¨æˆ·æƒé™
\du username
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ›å»ºå¸¦æ¡ä»¶çš„è§†å›¾
CREATE VIEW public_users AS
SELECT id, name, email FROM users WHERE is_public = TRUE;

-- 2. æˆäºˆè§†å›¾è®¿é—®æƒé™
GRANT SELECT ON public_users TO public_user_role;

-- 3. æ’¤é”€åº•å±‚è¡¨è®¿é—®æƒé™
REVOKE SELECT ON users FROM public_user_role;

-- 4. ä½¿ç”¨å®‰å…¨å®šä¹‰è€…è§†å›¾ï¼ˆä½¿ç”¨åˆ›å»ºè€…æƒé™ï¼‰
CREATE VIEW admin_users WITH (security_invoker = false) AS
SELECT * FROM users WHERE role = 'admin';
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- ç›´æ¥è¡¨è®¿é—®ï¼šéœ€è¦åº”ç”¨å±‚è¿‡æ»¤ï¼Œæ€§èƒ½å¼€é”€ **10%**
- è§†å›¾è®¿é—®ï¼šæ•°æ®åº“å±‚è¿‡æ»¤ï¼Œæ€§èƒ½å¼€é”€ **5%**
- **æ€§èƒ½æå‡ï¼š2å€ï¼Œå®‰å…¨æ€§æå‡ï¼š100%**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… è§†å›¾è®¾è®¡å»ºè®®

1. **ç®€åŒ–å¤æ‚æŸ¥è¯¢**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§†å›¾ç®€åŒ–å¤æ‚æŸ¥è¯¢
   CREATE VIEW user_order_stats AS
   SELECT
       u.id,
       u.name,
       COUNT(o.id) AS order_count,
       SUM(o.total_amount) AS total_spent
   FROM users u
   LEFT JOIN orders o ON u.id = o.user_id
   GROUP BY u.id, u.name;

   -- ä½¿ç”¨è§†å›¾
   SELECT * FROM user_order_stats WHERE order_count > 10;
   ```

2. **æƒé™æ§åˆ¶**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§†å›¾æ§åˆ¶æ•°æ®è®¿é—®
   CREATE VIEW public_users AS
   SELECT id, name, email FROM users WHERE is_public = TRUE;

   GRANT SELECT ON public_users TO public_role;
   REVOKE SELECT ON users FROM public_role;
   ```

3. **æ•°æ®æŠ½è±¡**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§†å›¾éšè—åº•å±‚è¡¨ç»“æ„å˜åŒ–
   CREATE VIEW customer_info AS
   SELECT
       id,
       first_name || ' ' || last_name AS full_name,
       email,
       phone
   FROM customers;
   ```

#### âœ… ç‰©åŒ–è§†å›¾è®¾è®¡å»ºè®®

1. **å¤æ‚èšåˆæŸ¥è¯¢**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ä¼˜åŒ–å¤æ‚èšåˆ
   CREATE MATERIALIZED VIEW daily_sales_summary AS
   SELECT
       DATE(created_at) AS sale_date,
       product_id,
       SUM(quantity) AS total_quantity,
       SUM(amount) AS total_amount,
       COUNT(*) AS order_count
   FROM orders
   GROUP BY DATE(created_at), product_id;

   CREATE UNIQUE INDEX ON daily_sales_summary(sale_date, product_id);
   ```

2. **å®šæœŸåˆ·æ–°ç­–ç•¥**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨pg_cronè‡ªåŠ¨åˆ·æ–°
   CREATE EXTENSION IF NOT EXISTS pg_cron;

   SELECT cron.schedule(
       'refresh-daily-sales',
       '0 1 * * *',  -- æ¯å¤©å‡Œæ™¨1ç‚¹åˆ·æ–°
       $$REFRESH MATERIALIZED VIEW CONCURRENTLY daily_sales_summary$$
   );
   ```

3. **ç´¢å¼•ä¼˜åŒ–**ï¼š

   ```sql
   -- âœ… å¥½ï¼šåœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•
   CREATE MATERIALIZED VIEW user_order_summary AS
   SELECT user_id, COUNT(*) AS order_count, SUM(amount) AS total
   FROM orders GROUP BY user_id;

   CREATE UNIQUE INDEX ON user_order_summary(user_id);
   CREATE INDEX ON user_order_summary(total);
   ```

### 7.2 é¿å…åšæ³•

#### âŒ è§†å›¾åæ¨¡å¼

1. **åµŒå¥—è§†å›¾è¿‡æ·±**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šåµŒå¥—è§†å›¾è¿‡æ·±ï¼Œå½±å“æ€§èƒ½
   CREATE VIEW v1 AS SELECT * FROM table1;
   CREATE VIEW v2 AS SELECT * FROM v1;
   CREATE VIEW v3 AS SELECT * FROM v2;  -- ä¸‰å±‚åµŒå¥—

   -- âœ… å¥½ï¼šç›´æ¥æŸ¥è¯¢æˆ–ä½¿ç”¨ç‰©åŒ–è§†å›¾
   CREATE VIEW v3 AS SELECT * FROM table1 WHERE condition;
   ```

2. **è§†å›¾åŒ…å«å¤æ‚è®¡ç®—**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè§†å›¾åŒ…å«å¤æ‚è®¡ç®—ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½æ‰§è¡Œ
   CREATE VIEW complex_view AS
   SELECT
       *,
       (SELECT COUNT(*) FROM orders WHERE user_id = users.id) AS order_count,
       (SELECT SUM(amount) FROM orders WHERE user_id = users.id) AS total_spent
   FROM users;

   -- âœ… å¥½ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
   CREATE MATERIALIZED VIEW user_stats AS
   SELECT
       u.id,
       COUNT(o.id) AS order_count,
       SUM(o.amount) AS total_spent
   FROM users u
   LEFT JOIN orders o ON u.id = o.user_id
   GROUP BY u.id;
   ```

3. **è§†å›¾æƒé™ç®¡ç†ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šæˆäºˆåº•å±‚è¡¨æƒé™ï¼Œç»•è¿‡è§†å›¾æƒé™æ§åˆ¶
   GRANT SELECT ON users TO public_role;
   GRANT SELECT ON public_users TO public_role;  -- è§†å›¾æƒé™å¤±æ•ˆ

   -- âœ… å¥½ï¼šåªæˆäºˆè§†å›¾æƒé™
   REVOKE SELECT ON users FROM public_role;
   GRANT SELECT ON public_users TO public_role;
   ```

#### âŒ ç‰©åŒ–è§†å›¾åæ¨¡å¼

1. **é¢‘ç¹å…¨é‡åˆ·æ–°**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šé¢‘ç¹å…¨é‡åˆ·æ–°ï¼Œå½±å“æ€§èƒ½
   -- æ¯å°æ—¶å…¨é‡åˆ·æ–°ï¼Œæ•°æ®é‡å¤§æ—¶å¾ˆæ…¢
   REFRESH MATERIALIZED VIEW large_materialized_view;

   -- âœ… å¥½ï¼šä½¿ç”¨å¹¶å‘åˆ·æ–°æˆ–å¢é‡åˆ·æ–°
   REFRESH MATERIALIZED VIEW CONCURRENTLY large_materialized_view;
   ```

2. **ç¼ºå°‘å”¯ä¸€ç´¢å¼•**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šç¼ºå°‘å”¯ä¸€ç´¢å¼•ï¼Œæ— æ³•å¹¶å‘åˆ·æ–°
   CREATE MATERIALIZED VIEW user_stats AS
   SELECT user_id, COUNT(*) AS order_count FROM orders GROUP BY user_id;
   -- æ— æ³•ä½¿ç”¨ CONCURRENTLY

   -- âœ… å¥½ï¼šåˆ›å»ºå”¯ä¸€ç´¢å¼•
   CREATE UNIQUE INDEX ON user_stats(user_id);
   REFRESH MATERIALIZED VIEW CONCURRENTLY user_stats;
   ```

3. **åˆ·æ–°ç­–ç•¥ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šåˆ·æ–°é¢‘ç‡è¿‡é«˜ï¼Œæµªè´¹èµ„æº
   -- æ¯åˆ†é’Ÿåˆ·æ–°ï¼Œä½†æ•°æ®å˜åŒ–ä¸é¢‘ç¹
   SELECT cron.schedule('refresh', '* * * * *', 'REFRESH MATERIALIZED VIEW mv');

   -- âœ… å¥½ï¼šæ ¹æ®æ•°æ®å˜åŒ–é¢‘ç‡è°ƒæ•´åˆ·æ–°ç­–ç•¥
   -- æ•°æ®æ¯å°æ—¶å˜åŒ–ï¼Œæ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡
   SELECT cron.schedule('refresh', '0 * * * *', 'REFRESH MATERIALIZED VIEW mv');
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **è§†å›¾æ€§èƒ½ä¼˜åŒ–**ï¼š
   - é¿å…åµŒå¥—è§†å›¾è¿‡æ·±ï¼ˆå»ºè®®ä¸è¶…è¿‡2å±‚ï¼‰
   - åœ¨åº•å±‚è¡¨ä¸Šåˆ›å»ºåˆé€‚çš„ç´¢å¼•
   - å¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œè€ƒè™‘ä½¿ç”¨ç‰©åŒ–è§†å›¾

2. **ç‰©åŒ–è§†å›¾æ€§èƒ½ä¼˜åŒ–**ï¼š
   - åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•ä»¥æå‡æŸ¥è¯¢æ€§èƒ½
   - ä½¿ç”¨å¹¶å‘åˆ·æ–°é¿å…é˜»å¡æŸ¥è¯¢
   - æ ¹æ®æ•°æ®å˜åŒ–é¢‘ç‡è°ƒæ•´åˆ·æ–°ç­–ç•¥
   - å¯¹äºå¤§æ•°æ®é‡ï¼Œè€ƒè™‘åˆ†åŒºç‰©åŒ–è§†å›¾

3. **åˆ·æ–°ç­–ç•¥é€‰æ‹©**ï¼š
   - **å®æ—¶æ€§è¦æ±‚é«˜**ï¼šä½¿ç”¨è§¦å‘å™¨æˆ–é€»è¾‘å¤åˆ¶å¢é‡åˆ·æ–°
   - **å®æ—¶æ€§è¦æ±‚ä¸­ç­‰**ï¼šä½¿ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸåˆ·æ–°
   - **å®æ—¶æ€§è¦æ±‚ä½**ï¼šæ‰‹åŠ¨åˆ·æ–°æˆ–æŒ‰éœ€åˆ·æ–°

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§†å›¾](https://www.postgresql.org/docs/current/tutorial-views.html)**
  - è§†å›¾åŸºç¡€æ•™ç¨‹å’Œæœ€ä½³å®è·µ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - CREATE VIEW](https://www.postgresql.org/docs/current/sql-createview.html)**
  - CREATE VIEW è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç‰©åŒ–è§†å›¾](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)**
  - CREATE MATERIALIZED VIEW è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - REFRESH MATERIALIZED VIEW](https://www.postgresql.org/docs/current/sql-refreshmaterializedview.html)**
  - REFRESH MATERIALIZED VIEW è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¯æ›´æ–°è§†å›¾](https://www.postgresql.org/docs/current/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS)**
  - å¯æ›´æ–°è§†å›¾çš„æ¡ä»¶å’Œé™åˆ¶

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Query Rewriting Using Views](https://www.cs.utexas.edu/~divesh/papers/views-survey.pdf)**
  - è§†å›¾æŸ¥è¯¢é‡å†™ç®—æ³•å’Œä¼˜åŒ–æŠ€æœ¯

- **[Materialized Views: Techniques, Implementations, and Applications](https://www.cs.umd.edu/~nick/papers/materialized-views.pdf)**
  - ç‰©åŒ–è§†å›¾æŠ€æœ¯ã€å®ç°å’Œåº”ç”¨

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Views vs Materialized Views](https://www.postgresql.org/docs/current/tutorial-views.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šè§†å›¾ä¸ç‰©åŒ–è§†å›¾å¯¹æ¯”

- **[Optimizing PostgreSQL Materialized Views](https://www.citusdata.com/blog/2017/10/25/materialized-views-in-postgresql/)**
  - Citus Data åšå®¢ï¼šç‰©åŒ–è§†å›¾ä¼˜åŒ–æŠ€å·§

- **[PostgreSQL Materialized Views: A Complete Guide](https://www.enterprisedb.com/postgres-tutorials/postgresql-materialized-views-complete-guide)**
  - EnterpriseDB åšå®¢ï¼šç‰©åŒ–è§†å›¾å®Œæ•´æŒ‡å—

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Views](https://wiki.postgresql.org/wiki/Views)**
  - PostgreSQL Wikiï¼šè§†å›¾ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Views](https://stackoverflow.com/questions/tagged/postgresql+views)**
  - Stack Overflowï¼šPostgreSQL è§†å›¾ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šè§†å›¾å’Œç‰©åŒ–è§†å›¾ç›¸å…³è®¨è®º

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-07
