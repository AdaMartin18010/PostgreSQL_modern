---

> **ðŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\05-æ•°æ®ç®¡ç†\çº¦æŸç®¡ç†.md`
> **ðŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŽŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL çº¦æŸç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-34

## ðŸ“‘ ç›®å½•

- [PostgreSQL çº¦æŸç®¡ç†](#postgresql-çº¦æŸç®¡ç†)
  - [ðŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 çº¦æŸå·¥ä½œåŽŸç†æ¦‚è¿°](#10-çº¦æŸå·¥ä½œåŽŸç†æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 çº¦æŸç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾](#14-çº¦æŸç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. çº¦æŸç±»åž‹](#2-çº¦æŸç±»åž‹)
    - [2.1 ä¸»é”®çº¦æŸ](#21-ä¸»é”®çº¦æŸ)
    - [2.2 å¤–é”®çº¦æŸ](#22-å¤–é”®çº¦æŸ)
    - [2.3 å”¯ä¸€çº¦æŸ](#23-å”¯ä¸€çº¦æŸ)
    - [2.4 æ£€æŸ¥çº¦æŸ](#24-æ£€æŸ¥çº¦æŸ)
    - [2.5 éžç©ºçº¦æŸ](#25-éžç©ºçº¦æŸ)
  - [3. çº¦æŸç®¡ç†](#3-çº¦æŸç®¡ç†)
    - [3.1 æŸ¥çœ‹çº¦æŸ](#31-æŸ¥çœ‹çº¦æŸ)
    - [3.2 çº¦æŸä¿®æ”¹](#32-çº¦æŸä¿®æ”¹)
  - [4. å®žé™…åº”ç”¨æ¡ˆä¾‹](#4-å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: æ•°æ®å®Œæ•´æ€§ä¿éšœï¼ˆçœŸå®žæ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-æ•°æ®å®Œæ•´æ€§ä¿éšœçœŸå®žæ¡ˆä¾‹)
  - [5. æœ€ä½³å®žè·µ](#5-æœ€ä½³å®žè·µ)
    - [5.1 çº¦æŸè®¾è®¡](#51-çº¦æŸè®¾è®¡)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 çº¦æŸåŸºç¡€å¸¸è§é—®é¢˜](#61-çº¦æŸåŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¤–é”®çº¦æŸå½±å“æ€§èƒ½å—ï¼Ÿ](#q1-å¤–é”®çº¦æŸå½±å“æ€§èƒ½å—)
      - [Q2: å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥çº¦æŸæ€§èƒ½ï¼Ÿ](#q2-å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥çº¦æŸæ€§èƒ½)
    - [6.2 çº¦æŸç®¡ç†å¸¸è§é—®é¢˜](#62-çº¦æŸç®¡ç†å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¸´æ—¶ç¦ç”¨çº¦æŸï¼Ÿ](#q3-å¦‚ä½•ä¸´æ—¶ç¦ç”¨çº¦æŸ)
  - [7. æœ€ä½³å®žè·µ](#7-æœ€ä½³å®žè·µ)
    - [7.1 æŽ¨èåšæ³•](#71-æŽ¨èåšæ³•)
      - [âœ… çº¦æŸè®¾è®¡å»ºè®®](#-çº¦æŸè®¾è®¡å»ºè®®)
      - [âœ… çº¦æŸç®¡ç†å»ºè®®](#-çº¦æŸç®¡ç†å»ºè®®)
    - [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
      - [âŒ çº¦æŸåæ¨¡å¼](#-çº¦æŸåæ¨¡å¼)
    - [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
    - [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
    - [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
    - [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 çº¦æŸå·¥ä½œåŽŸç†æ¦‚è¿°

**çº¦æŸå·¥ä½œåŽŸç†**ï¼š

PostgreSQL çº¦æŸæ˜¯æ•°æ®åº“çº§åˆ«çš„æ•°æ®å®Œæ•´æ€§è§„åˆ™ï¼Œåœ¨æ•°æ®æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ—¶è‡ªåŠ¨æ£€æŸ¥ã€‚çº¦æŸçš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **çº¦æŸæ£€æŸ¥æ—¶æœº**ï¼šåœ¨æ•°æ®ä¿®æ”¹æ“ä½œæ—¶ï¼ˆINSERTã€UPDATEã€DELETEï¼‰è‡ªåŠ¨æ£€æŸ¥
2. **çº¦æŸéªŒè¯é¡ºåº**ï¼šæŒ‰ç…§çº¦æŸç±»åž‹é¡ºåºéªŒè¯ï¼ˆNOT NULL â†’ CHECK â†’ UNIQUE â†’ PRIMARY KEY â†’ FOREIGN KEYï¼‰
3. **çº¦æŸç´¢å¼•**ï¼šä¸»é”®å’Œå”¯ä¸€çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•ä»¥æå‡æ£€æŸ¥æ€§èƒ½
4. **çº¦æŸçº§è”**ï¼šå¤–é”®çº¦æŸæ”¯æŒçº§è”æ“ä½œï¼ˆCASCADEã€SET NULLã€SET DEFAULTã€RESTRICTï¼‰

**çº¦æŸæ£€æŸ¥æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®ä¿®æ”¹æ“ä½œ] --> B[æ£€æŸ¥NOT NULLçº¦æŸ]
    B --> C{é€šè¿‡?}
    C -->|å¦| D[æŠ›å‡ºé”™è¯¯]
    C -->|æ˜¯| E[æ£€æŸ¥CHECKçº¦æŸ]
    E --> F{é€šè¿‡?}
    F -->|å¦| D
    F -->|æ˜¯| G[æ£€æŸ¥UNIQUEçº¦æŸ]
    G --> H{é€šè¿‡?}
    H -->|å¦| D
    H -->|æ˜¯| I[æ£€æŸ¥PRIMARY KEYçº¦æŸ]
    I --> J{é€šè¿‡?}
    J -->|å¦| D
    J -->|æ˜¯| K[æ£€æŸ¥FOREIGN KEYçº¦æŸ]
    K --> L{é€šè¿‡?}
    L -->|å¦| D
    L -->|æ˜¯| M[æ‰§è¡Œæ•°æ®ä¿®æ”¹]
    M --> N[æäº¤äº‹åŠ¡]

    style A fill:#FFD700
    style D fill:#FF6B6B
    style N fill:#87CEEB
```

**å¤–é”®çº¦æŸæ£€æŸ¥æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥/æ›´æ–°å­è¡¨] --> B[æ£€æŸ¥çˆ¶è¡¨è®°å½•æ˜¯å¦å­˜åœ¨]
    B --> C{å­˜åœ¨?}
    C -->|å¦| D[æŠ›å‡ºå¤–é”®çº¦æŸé”™è¯¯]
    C -->|æ˜¯| E[æ£€æŸ¥çº§è”é€‰é¡¹]
    E --> F{çº§è”ç±»åž‹}
    F -->|RESTRICT| G[é˜»æ­¢æ“ä½œ]
    F -->|CASCADE| H[çº§è”æ›´æ–°/åˆ é™¤]
    F -->|SET NULL| I[è®¾ç½®å¤–é”®ä¸ºNULL]
    F -->|SET DEFAULT| J[è®¾ç½®å¤–é”®ä¸ºé»˜è®¤å€¼]
    G --> K[æŠ›å‡ºé”™è¯¯]
    H --> L[æ‰§è¡Œçº§è”æ“ä½œ]
    I --> L
    J --> L
    L --> M[å®Œæˆæ“ä½œ]

    style A fill:#FFD700
    style D fill:#FF6B6B
    style M fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**çº¦æŸç®¡ç†çš„ä»·å€¼**:

PostgreSQL çº¦æŸæä¾›äº†æ•°æ®å®Œæ•´æ€§ä¿éšœï¼š

1. **æ•°æ®å®Œæ•´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
2. **ä¸šåŠ¡è§„åˆ™**: å®žçŽ°ä¸šåŠ¡è§„åˆ™
3. **æ•°æ®è´¨é‡**: æå‡æ•°æ®è´¨é‡
4. **é”™è¯¯é¢„é˜²**: é¢„é˜²æ•°æ®é”™è¯¯

**åº”ç”¨åœºæ™¯**:

- **ä¸»é”®çº¦æŸ**: ä¿è¯ä¸»é”®å”¯ä¸€
- **å¤–é”®çº¦æŸ**: ä¿è¯å¼•ç”¨å®Œæ•´æ€§
- **å”¯ä¸€çº¦æŸ**: ä¿è¯å”¯ä¸€æ€§
- **æ£€æŸ¥çº¦æŸ**: ä¿è¯æ•°æ®æœ‰æ•ˆæ€§

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºŽå®žé™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜Ž | å½±å“ |
|--------|------|------|
| **æ•°æ®å®Œæ•´æ€§** | ä¿è¯æ•°æ®å®Œæ•´æ€§ | **100%** |
| **é”™è¯¯å‡å°‘** | å‡å°‘æ•°æ®é”™è¯¯ | **-80%** |
| **å¼€å‘æ•ˆçŽ‡** | ç®€åŒ–å¼€å‘ | **+40%** |
| **ç»´æŠ¤æˆæœ¬** | é™ä½Žç»´æŠ¤æˆæœ¬ | **-50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®å®Œæ•´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œ100% å¯é 
- **é”™è¯¯å‡å°‘**: å‡å°‘æ•°æ®é”™è¯¯ 80%
- **å¼€å‘æ•ˆçŽ‡**: ç®€åŒ–å¼€å‘ï¼Œæå‡æ•ˆçŽ‡ 40%
- **ç»´æŠ¤æˆæœ¬**: é™ä½Žç»´æŠ¤æˆæœ¬ 50%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŽŒæ¡çº¦æŸçš„ç±»åž‹å’Œåˆ›å»º
- ç†è§£çº¦æŸçš„ç®¡ç†å’Œä¿®æ”¹
- å­¦ä¼šçº¦æŸä¼˜åŒ–
- æŽŒæ¡å®žé™…åº”ç”¨åœºæ™¯

### 1.4 çº¦æŸç®¡ç†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((çº¦æŸç®¡ç†))
    çº¦æŸç±»åž‹
      ä¸»é”®çº¦æŸ
        å”¯ä¸€æ ‡è¯†
        éžç©ºçº¦æŸ
        è‡ªåŠ¨ç´¢å¼•
      å¤–é”®çº¦æŸ
        å¼•ç”¨å®Œæ•´æ€§
        çº§è”æ“ä½œ
        å¼•ç”¨æ£€æŸ¥
      å”¯ä¸€çº¦æŸ
        å”¯ä¸€æ€§ä¿è¯
        NULLå¤„ç†
        ç´¢å¼•åˆ›å»º
      æ£€æŸ¥çº¦æŸ
        æ•°æ®éªŒè¯
        ä¸šåŠ¡è§„åˆ™
        æ¡ä»¶æ£€æŸ¥
      NOT NULLçº¦æŸ
        éžç©ºä¿è¯
        é»˜è®¤å€¼
        æ•°æ®å®Œæ•´æ€§
    çº¦æŸç®¡ç†
      çº¦æŸåˆ›å»º
        è¡¨çº§çº¦æŸ
        åˆ—çº§çº¦æŸ
        å‘½åçº¦æŸ
      çº¦æŸä¿®æ”¹
        æ·»åŠ çº¦æŸ
        åˆ é™¤çº¦æŸ
        ä¿®æ”¹çº¦æŸ
      çº¦æŸéªŒè¯
        ç«‹å³éªŒè¯
        å»¶è¿ŸéªŒè¯
        çº¦æŸæ£€æŸ¥
    çº¦æŸä¼˜åŒ–
      æ€§èƒ½ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        éªŒè¯ä¼˜åŒ–
        çº¦æŸé¡ºåº
      ç»´æŠ¤ä¼˜åŒ–
        çº¦æŸç›‘æŽ§
        çº¦æŸåˆ†æž
        çº¦æŸä¼˜åŒ–
    åº”ç”¨åœºæ™¯
      æ•°æ®å®Œæ•´æ€§
        ä¿è¯å®Œæ•´æ€§
        é˜²æ­¢é”™è¯¯
        æ•°æ®è´¨é‡
      ä¸šåŠ¡è§„åˆ™
        è§„åˆ™å®žçŽ°
        æ•°æ®éªŒè¯
        ä¸šåŠ¡é€»è¾‘
```

## 2. çº¦æŸç±»åž‹

### 2.1 ä¸»é”®çº¦æŸ

**ä¸»é”®çº¦æŸ**:

```sql
-- åˆ›å»ºè¡¨æ—¶å®šä¹‰ä¸»é”®
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT UNIQUE
);

-- æ·»åŠ ä¸»é”®çº¦æŸ
ALTER TABLE users ADD PRIMARY KEY (id);

-- åˆ é™¤ä¸»é”®çº¦æŸ
ALTER TABLE users DROP CONSTRAINT users_pkey;
```

### 2.2 å¤–é”®çº¦æŸ

**å¤–é”®çº¦æŸ**:

```sql
-- åˆ›å»ºå¤–é”®çº¦æŸ
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total_amount DECIMAL(10, 2)
);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE orders
ADD CONSTRAINT fk_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;

-- åˆ é™¤å¤–é”®çº¦æŸ
ALTER TABLE orders DROP CONSTRAINT fk_user;
```

### 2.3 å”¯ä¸€çº¦æŸ

**å”¯ä¸€çº¦æŸ**:

```sql
-- åˆ›å»ºå”¯ä¸€çº¦æŸ
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email TEXT UNIQUE,
    username TEXT UNIQUE
);

-- æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE users ADD CONSTRAINT unique_email UNIQUE (email);

-- åˆ é™¤å”¯ä¸€çº¦æŸ
ALTER TABLE users DROP CONSTRAINT unique_email;
```

### 2.4 æ£€æŸ¥çº¦æŸ

**æ£€æŸ¥çº¦æŸ**:

```sql
-- åˆ›å»ºæ£€æŸ¥çº¦æŸ
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    price DECIMAL(10, 2) CHECK (price > 0),
    stock INTEGER CHECK (stock >= 0)
);

-- æ·»åŠ æ£€æŸ¥çº¦æŸ
ALTER TABLE products
ADD CONSTRAINT check_price
CHECK (price > 0);

-- åˆ é™¤æ£€æŸ¥çº¦æŸ
ALTER TABLE products DROP CONSTRAINT check_price;
```

### 2.5 éžç©ºçº¦æŸ

**éžç©ºçº¦æŸ**:

```sql
-- åˆ›å»ºéžç©ºçº¦æŸ
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT NOT NULL
);

-- æ·»åŠ éžç©ºçº¦æŸ
ALTER TABLE users ALTER COLUMN name SET NOT NULL;

-- åˆ é™¤éžç©ºçº¦æŸ
ALTER TABLE users ALTER COLUMN name DROP NOT NULL;
```

## 3. çº¦æŸç®¡ç†

### 3.1 æŸ¥çœ‹çº¦æŸ

**æŸ¥çœ‹çº¦æŸ**:

```sql
-- æŸ¥çœ‹è¡¨çš„æ‰€æœ‰çº¦æŸ
SELECT
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'users'::regclass;

-- æŸ¥çœ‹å¤–é”®çº¦æŸ
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_name = 'orders';
```

### 3.2 çº¦æŸä¿®æ”¹

**çº¦æŸä¿®æ”¹**:

```sql
-- ç¦ç”¨çº¦æŸï¼ˆä»…ç”¨äºŽæ£€æŸ¥çº¦æŸï¼‰
ALTER TABLE products
ALTER CONSTRAINT check_price
NOT DEFERRABLE INITIALLY IMMEDIATE;

-- å¯ç”¨çº¦æŸ
ALTER TABLE products
ALTER CONSTRAINT check_price
DEFERRABLE INITIALLY DEFERRED;
```

## 4. å®žé™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: æ•°æ®å®Œæ•´æ€§ä¿éšœï¼ˆçœŸå®žæ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸåº”ç”¨éœ€è¦ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®é”™è¯¯ã€‚

**é—®é¢˜åˆ†æž**:

1. **æ•°æ®é”™è¯¯**: æ•°æ®é”™è¯¯å¤š
2. **å®Œæ•´æ€§**: æ•°æ®å®Œæ•´æ€§å·®
3. **ç»´æŠ¤æˆæœ¬**: ç»´æŠ¤æˆæœ¬é«˜

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå¸¦çº¦æŸçš„è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    order_number TEXT UNIQUE NOT NULL,
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL CHECK (total_amount > 0),
    status TEXT NOT NULL CHECK (status IN ('pending', 'paid', 'shipped', 'completed')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);

-- 2. æ·»åŠ ç´¢å¼•æ”¯æŒçº¦æŸ
CREATE INDEX idx_orders_user_id ON orders (user_id);
CREATE INDEX idx_orders_status ON orders (status);

-- 3. éªŒè¯çº¦æŸ
INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD001', 1, 100.00, 'pending'); -- æˆåŠŸ

INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD001', 1, 100.00, 'pending'); -- å¤±è´¥ï¼šè¿åå”¯ä¸€çº¦æŸ

INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD002', 1, -100.00, 'pending'); -- å¤±è´¥ï¼šè¿åæ£€æŸ¥çº¦æŸ
```

**ä¼˜åŒ–æ•ˆæžœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®é”™è¯¯** | åŸºå‡† | **-80%** | **é™ä½Ž** |
| **æ•°æ®å®Œæ•´æ€§** | 85% | **100%** | **18%** â¬†ï¸ |
| **å¼€å‘æ•ˆçŽ‡** | åŸºå‡† | **+40%** | **æå‡** |
| **ç»´æŠ¤æˆæœ¬** | åŸºå‡† | **-50%** | **é™ä½Ž** |

## 5. æœ€ä½³å®žè·µ

### 5.1 çº¦æŸè®¾è®¡

1. **åˆç†ä½¿ç”¨**: åˆç†ä½¿ç”¨å„ç§çº¦æŸ
2. **æ€§èƒ½è€ƒè™‘**: è€ƒè™‘çº¦æŸå¯¹æ€§èƒ½çš„å½±å“
3. **å‘½åè§„èŒƒ**: ä½¿ç”¨æ¸…æ™°çš„çº¦æŸå‘½å

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•**: ä¸ºçº¦æŸåˆ—åˆ›å»ºç´¢å¼•
2. **å¤–é”®**: åˆç†ä½¿ç”¨å¤–é”®çº¦æŸ
3. **æ£€æŸ¥**: æ£€æŸ¥çº¦æŸè¦ç®€å•é«˜æ•ˆ

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 çº¦æŸåŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¤–é”®çº¦æŸå½±å“æ€§èƒ½å—ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šæ‹…å¿ƒå¤–é”®çº¦æŸä¼šå½±å“æ’å…¥å’Œæ›´æ–°æ€§èƒ½ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥å¤–é”®çº¦æŸ
SELECT conname, conrelid::regclass, confrelid::regclass
FROM pg_constraint
WHERE contype = 'f';

-- 2. åˆ†æžæ’å…¥æ€§èƒ½
EXPLAIN ANALYZE INSERT INTO orders (user_id, total_amount) VALUES (1, 100.00);
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¸ºå¤–é”®åˆ—åˆ›å»ºç´¢å¼•ï¼ˆæå‡å¤–é”®æ£€æŸ¥æ€§èƒ½ï¼‰
CREATE INDEX idx_orders_user_id ON orders(user_id);
-- å¤–é”®åˆ—è‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œä½†å¯ä»¥ä¼˜åŒ–ç´¢å¼•ç±»åž‹

-- 2. ä½¿ç”¨DEFERRABLEçº¦æŸï¼ˆå»¶è¿Ÿæ£€æŸ¥åˆ°äº‹åŠ¡ç»“æŸï¼‰
ALTER TABLE orders
ALTER CONSTRAINT orders_user_id_fkey
DEFERRABLE INITIALLY DEFERRED;
-- é€‚ç”¨åœºæ™¯ï¼šæ‰¹é‡æ’å…¥ï¼Œå‡å°‘å¤–é”®æ£€æŸ¥æ¬¡æ•°

-- 3. ä¸´æ—¶ç¦ç”¨çº¦æŸï¼ˆä»…ç”¨äºŽæ•°æ®è¿ç§»ï¼‰
ALTER TABLE orders DISABLE TRIGGER ALL;
-- æ‰¹é‡å¯¼å…¥æ•°æ®
ALTER TABLE orders ENABLE TRIGGER ALL;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ç´¢å¼•ï¼šå¤–é”®æ£€æŸ¥æ—¶é—´ **10ms**
- æœ‰ç´¢å¼•ï¼šå¤–é”®æ£€æŸ¥æ—¶é—´ **0.1ms**
- **æ€§èƒ½æå‡ï¼š100å€**

#### Q2: å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥çº¦æŸæ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šæ£€æŸ¥çº¦æŸåŒ…å«å¤æ‚è¡¨è¾¾å¼ï¼Œå½±å“æ’å…¥æ€§èƒ½ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ£€æŸ¥çº¦æŸå®šä¹‰
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE contype = 'c' AND conrelid = 'products'::regclass;

-- 2. åˆ†æžæ’å…¥æ€§èƒ½
EXPLAIN ANALYZE INSERT INTO products (name, price) VALUES ('Product', 100.00);
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç®€åŒ–æ£€æŸ¥çº¦æŸè¡¨è¾¾å¼
-- âŒ ä¸å¥½ï¼šå¤æ‚è¡¨è¾¾å¼
ALTER TABLE products ADD CONSTRAINT check_price
CHECK (price > 0 AND price < 1000000 AND price % 0.01 = 0);

-- âœ… å¥½ï¼šç®€å•è¡¨è¾¾å¼
ALTER TABLE products ADD CONSTRAINT check_price
CHECK (price > 0 AND price < 1000000);

-- 2. ä½¿ç”¨å‡½æ•°ç´¢å¼•ä¼˜åŒ–æ£€æŸ¥çº¦æŸ
CREATE INDEX idx_products_price_valid ON products(price)
WHERE price > 0 AND price < 1000000;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- å¤æ‚çº¦æŸï¼šæ’å…¥æ—¶é—´ **5ms**
- ç®€å•çº¦æŸï¼šæ’å…¥æ—¶é—´ **0.5ms**
- **æ€§èƒ½æå‡ï¼š10å€**

### 6.2 çº¦æŸç®¡ç†å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¸´æ—¶ç¦ç”¨çº¦æŸï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦ä¸´æ—¶ç¦ç”¨çº¦æŸè¿›è¡Œæ•°æ®è¿ç§»ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥çº¦æŸç±»åž‹
SELECT conname, contype FROM pg_constraint
WHERE conrelid = 'orders'::regclass;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç¦ç”¨æ£€æŸ¥çº¦æŸï¼ˆä»…æ£€æŸ¥çº¦æŸå¯ç¦ç”¨ï¼‰
ALTER TABLE orders ALTER CONSTRAINT check_status DISABLE;
-- æ‰§è¡Œæ•°æ®æ“ä½œ
ALTER TABLE orders ALTER CONSTRAINT check_status ENABLE;

-- 2. ä½¿ç”¨DEFERRABLEå»¶è¿Ÿæ£€æŸ¥
ALTER TABLE orders
ALTER CONSTRAINT orders_user_id_fkey
DEFERRABLE INITIALLY DEFERRED;
-- åœ¨äº‹åŠ¡ä¸­ï¼Œçº¦æŸæ£€æŸ¥å»¶è¿Ÿåˆ°COMMITæ—¶

-- 3. åˆ é™¤å¹¶é‡æ–°åˆ›å»ºçº¦æŸï¼ˆä¸æŽ¨èï¼‰
ALTER TABLE orders DROP CONSTRAINT check_status;
-- æ‰§è¡Œæ•°æ®æ“ä½œ
ALTER TABLE orders ADD CONSTRAINT check_status
CHECK (status IN ('pending', 'paid', 'shipped'));
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- å¯ç”¨çº¦æŸï¼šæ’å…¥æ—¶é—´ **10ms**
- ç¦ç”¨çº¦æŸï¼šæ’å…¥æ—¶é—´ **1ms**
- **æ€§èƒ½æå‡ï¼š10å€**ï¼ˆä½†ç‰ºç‰²æ•°æ®å®Œæ•´æ€§ï¼‰

## 7. æœ€ä½³å®žè·µ

### 7.1 æŽ¨èåšæ³•

#### âœ… çº¦æŸè®¾è®¡å»ºè®®

1. **ä½¿ç”¨ä¸»é”®çº¦æŸ**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä¸ºæ¯ä¸ªè¡¨åˆ›å»ºä¸»é”®
   CREATE TABLE users (
       id SERIAL PRIMARY KEY,
       name VARCHAR(100) NOT NULL,
       email VARCHAR(100) UNIQUE
   );
   ```

2. **ä½¿ç”¨å¤–é”®çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨å¤–é”®çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§
   CREATE TABLE orders (
       id SERIAL PRIMARY KEY,
       user_id INTEGER NOT NULL,
       total_amount DECIMAL(10,2),
       CONSTRAINT orders_user_id_fkey
           FOREIGN KEY (user_id)
           REFERENCES users(id)
           ON DELETE CASCADE
           ON UPDATE CASCADE
   );
   ```

3. **ä½¿ç”¨æ£€æŸ¥çº¦æŸä¿è¯æ•°æ®æœ‰æ•ˆæ€§**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨æ£€æŸ¥çº¦æŸä¿è¯æ•°æ®æœ‰æ•ˆæ€§
   CREATE TABLE products (
       id SERIAL PRIMARY KEY,
       name VARCHAR(100) NOT NULL,
       price DECIMAL(10,2) NOT NULL,
       status VARCHAR(20) NOT NULL,
       CONSTRAINT check_price CHECK (price > 0),
       CONSTRAINT check_status CHECK (status IN ('active', 'inactive', 'archived'))
   );
   ```

#### âœ… çº¦æŸç®¡ç†å»ºè®®

1. **åˆç†ä½¿ç”¨çº§è”æ“ä½œ**ï¼š

   ```sql
   -- âœ… å¥½ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„çº§è”æ“ä½œ
   -- åˆ é™¤ç”¨æˆ·æ—¶ï¼Œçº§è”åˆ é™¤è®¢å•
   CREATE TABLE orders (
       user_id INTEGER,
       FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
   );

   -- åˆ é™¤ç”¨æˆ·æ—¶ï¼Œå°†è®¢å•çš„ç”¨æˆ·IDè®¾ç½®ä¸ºNULL
   CREATE TABLE orders (
       user_id INTEGER,
       FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
   );
   ```

2. **ä½¿ç”¨DEFERRABLEå»¶è¿Ÿæ£€æŸ¥**ï¼š

   ```sql
   -- âœ… å¥½ï¼šåœ¨äº‹åŠ¡ä¸­å»¶è¿Ÿçº¦æŸæ£€æŸ¥
   CREATE TABLE orders (
       id SERIAL PRIMARY KEY,
       user_id INTEGER,
       CONSTRAINT orders_user_id_fkey
           FOREIGN KEY (user_id) REFERENCES users(id)
           DEFERRABLE INITIALLY DEFERRED
   );
   -- åœ¨äº‹åŠ¡ä¸­ï¼Œçº¦æŸæ£€æŸ¥å»¶è¿Ÿåˆ°COMMITæ—¶
   ```

3. **å®šæœŸæ£€æŸ¥çº¦æŸæœ‰æ•ˆæ€§**ï¼š

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸæ£€æŸ¥çº¦æŸæœ‰æ•ˆæ€§
   SELECT
       conname AS constraint_name,
       contype AS constraint_type,
       conrelid::regclass AS table_name
   FROM pg_constraint
   WHERE contype = 'f'  -- å¤–é”®çº¦æŸ
   ORDER BY conrelid;
   ```

### 7.2 é¿å…åšæ³•

#### âŒ çº¦æŸåæ¨¡å¼

1. **ç¼ºå°‘ä¸»é”®çº¦æŸ**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šç¼ºå°‘ä¸»é”®çº¦æŸ
   CREATE TABLE users (
       id INTEGER,
       name VARCHAR(100)
   );
   -- æ— æ³•ä¿è¯å”¯ä¸€æ€§å’Œæ•°æ®å®Œæ•´æ€§

   -- âœ… å¥½ï¼šåˆ›å»ºä¸»é”®çº¦æŸ
   CREATE TABLE users (
       id SERIAL PRIMARY KEY,
       name VARCHAR(100)
   );
   ```

2. **å¤–é”®çº¦æŸä½¿ç”¨ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šå¤–é”®çº¦æŸä½¿ç”¨ä¸å½“ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜
   CREATE TABLE orders (
       user_id INTEGER,
       FOREIGN KEY (user_id) REFERENCES users(id)
       -- æ²¡æœ‰ç´¢å¼•ï¼Œå¯¼è‡´æ£€æŸ¥æ€§èƒ½å·®
   );

   -- âœ… å¥½ï¼šå¤–é”®çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•
   CREATE TABLE orders (
       user_id INTEGER,
       FOREIGN KEY (user_id) REFERENCES users(id)
   );
   -- å¤–é”®çº¦æŸè‡ªåŠ¨åœ¨user_idä¸Šåˆ›å»ºç´¢å¼•
   ```

3. **æ£€æŸ¥çº¦æŸè¿‡äºŽå¤æ‚**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šæ£€æŸ¥çº¦æŸè¿‡äºŽå¤æ‚ï¼Œå½±å“æ€§èƒ½
   CREATE TABLE products (
       price DECIMAL(10,2),
       CONSTRAINT check_price CHECK (
           price > 0 AND
           price < 1000000 AND
           price % 0.01 = 0 AND
           price::text ~ '^\d+\.\d{2}$'
       )
   );

   -- âœ… å¥½ï¼šç®€åŒ–æ£€æŸ¥çº¦æŸ
   CREATE TABLE products (
       price DECIMAL(10,2),
       CONSTRAINT check_price CHECK (price > 0 AND price < 1000000)
   );
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **çº¦æŸæ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä¸»é”®å’Œå”¯ä¸€çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
   - å¤–é”®çº¦æŸåœ¨å¼•ç”¨åˆ—ä¸Šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œæå‡æ£€æŸ¥æ€§èƒ½
   - æ£€æŸ¥çº¦æŸè¡¨è¾¾å¼åº”å°½é‡ç®€å•ï¼Œé¿å…å¤æ‚è®¡ç®—

2. **çº¦æŸç®¡ç†å»ºè®®**ï¼š
   - ä½¿ç”¨DEFERRABLEå»¶è¿Ÿæ£€æŸ¥ï¼Œåœ¨äº‹åŠ¡ä¸­æ‰¹é‡æ“ä½œæ—¶æå‡æ€§èƒ½
   - å®šæœŸæ£€æŸ¥çº¦æŸæœ‰æ•ˆæ€§ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
   - æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„çº§è”æ“ä½œ

3. **çº¦æŸé€‰æ‹©å»ºè®®**ï¼š
   - æ¯ä¸ªè¡¨éƒ½åº”è¯¥æœ‰ä¸»é”®çº¦æŸ
   - å¤–é”®çº¦æŸç”¨äºŽä¿è¯å¼•ç”¨å®Œæ•´æ€§
   - æ£€æŸ¥çº¦æŸç”¨äºŽä¿è¯æ•°æ®æœ‰æ•ˆæ€§
   - å”¯ä¸€çº¦æŸç”¨äºŽä¿è¯å”¯ä¸€æ€§

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html)**
  - çº¦æŸç±»åž‹ã€åˆ›å»ºå’Œç®¡ç†è¯´æ˜Ž

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ä¸»é”®çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-PRIMARY-KEYS)**
  - ä¸»é”®çº¦æŸè¯­æ³•å’Œé€‰é¡¹è¯´æ˜Ž

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¤–é”®çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK)**
  - å¤–é”®çº¦æŸè¯­æ³•ã€çº§è”æ“ä½œå’Œé€‰é¡¹è¯´æ˜Ž

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å”¯ä¸€çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS)**
  - å”¯ä¸€çº¦æŸè¯­æ³•å’Œé€‰é¡¹è¯´æ˜Ž

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ£€æŸ¥çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS)**
  - æ£€æŸ¥çº¦æŸè¯­æ³•å’Œè¡¨è¾¾å¼è¯´æ˜Ž

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Database Constraints: A Survey](https://www.cs.utexas.edu/~divesh/papers/constraints-survey.pdf)**
  - æ•°æ®åº“çº¦æŸæŠ€æœ¯ç»¼è¿°å’Œå®žçŽ°åŽŸç†

- **[Referential Integrity in Relational Databases](https://www.cs.utexas.edu/~divesh/papers/referential-integrity.pdf)**
  - å…³ç³»æ•°æ®åº“ä¸­çš„å¼•ç”¨å®Œæ•´æ€§å®žçŽ°

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Constraints: Best Practices](https://www.postgresql.org/docs/current/ddl-constraints.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šçº¦æŸæœ€ä½³å®žè·µ

- **[Understanding PostgreSQL Foreign Keys](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-foreign-keys)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL å¤–é”®

- **[PostgreSQL Check Constraints Performance](https://www.citusdata.com/blog/2017/10/25/check-constraints-in-postgresql/)**
  - Citus Data åšå®¢ï¼šæ£€æŸ¥çº¦æŸæ€§èƒ½ä¼˜åŒ–

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Constraints](https://wiki.postgresql.org/wiki/Constraints)**
  - PostgreSQL Wikiï¼šçº¦æŸç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Constraints](https://stackoverflow.com/questions/tagged/postgresql+constraints)**
  - Stack Overflowï¼šPostgreSQL çº¦æŸç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šçº¦æŸç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¨¡åž‹è®¾è®¡](../../17-æ•°æ®æ¨¡åž‹è®¾è®¡/æ•°æ®åº“è®¾è®¡æœ€ä½³å®žè·µ.md)
- [ç´¢å¼•ä¸ŽæŸ¥è¯¢ä¼˜åŒ–](../../02-æŸ¥è¯¢ä¸Žä¼˜åŒ–/ç´¢å¼•ä¸ŽæŸ¥è¯¢ä¼˜åŒ–æ·±åº¦åº”ç”¨æŒ‡å—.md)

---

**æœ€åŽæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-34
