# æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—](#æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ˜Ÿå‹æ¨¡å¼](#2-æ˜Ÿå‹æ¨¡å¼)
    - [2.1 ç»“æ„ç‰¹ç‚¹](#21-ç»“æ„ç‰¹ç‚¹)
    - [2.2 å®Œæ•´ç¤ºä¾‹](#22-å®Œæ•´ç¤ºä¾‹)
    - [2.3 ä¼˜åŠ¿](#23-ä¼˜åŠ¿)
    - [2.4 åŠ£åŠ¿](#24-åŠ£åŠ¿)
  - [3. é›ªèŠ±å‹æ¨¡å¼](#3-é›ªèŠ±å‹æ¨¡å¼)
    - [3.1 ç»“æ„ç‰¹ç‚¹](#31-ç»“æ„ç‰¹ç‚¹)
    - [3.2 å®Œæ•´ç¤ºä¾‹](#32-å®Œæ•´ç¤ºä¾‹)
    - [3.3 ä¼˜åŠ¿](#33-ä¼˜åŠ¿)
    - [3.4 åŠ£åŠ¿](#34-åŠ£åŠ¿)
  - [4. æ¨¡å¼é€‰æ‹©](#4-æ¨¡å¼é€‰æ‹©)
    - [4.1 é€‰æ‹©çŸ©é˜µ](#41-é€‰æ‹©çŸ©é˜µ)
    - [4.2 å†³ç­–æµç¨‹](#42-å†³ç­–æµç¨‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [6. æ··åˆæ¨¡å¼è®¾è®¡](#6-æ··åˆæ¨¡å¼è®¾è®¡)
    - [6.1 æ··åˆæ¨¡å¼ç¤ºä¾‹](#61-æ··åˆæ¨¡å¼ç¤ºä¾‹)
    - [6.2 æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–](#62-æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–)
  - [7. æ¨¡å¼è½¬æ¢ç­–ç•¥](#7-æ¨¡å¼è½¬æ¢ç­–ç•¥)
    - [7.1 æ˜Ÿå‹è½¬é›ªèŠ±å‹](#71-æ˜Ÿå‹è½¬é›ªèŠ±å‹)
    - [7.2 é›ªèŠ±å‹è½¬æ˜Ÿå‹](#72-é›ªèŠ±å‹è½¬æ˜Ÿå‹)
  - [8. æ€§èƒ½å¯¹æ¯”åˆ†æ](#8-æ€§èƒ½å¯¹æ¯”åˆ†æ)
    - [8.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”](#81-æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”)
    - [8.2 å­˜å‚¨ç©ºé—´å¯¹æ¯”](#82-å­˜å‚¨ç©ºé—´å¯¹æ¯”)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æ˜Ÿå‹æ¨¡å¼å’Œé›ªèŠ±å‹æ¨¡å¼æ˜¯æ•°æ®ä»“åº“çš„ä¸¤ç§ä¸»è¦è®¾è®¡æ¨¡å¼ï¼š

- **æ˜Ÿå‹æ¨¡å¼** - äº‹å®è¡¨+æ‰å¹³ç»´åº¦è¡¨
- **é›ªèŠ±å‹æ¨¡å¼** - äº‹å®è¡¨+è§„èŒƒåŒ–ç»´åº¦è¡¨

é€‰æ‹©åˆé€‚çš„æ¨¡å¼å¯¹æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§è‡³å…³é‡è¦ã€‚

---

## 2. æ˜Ÿå‹æ¨¡å¼

### 2.1 ç»“æ„ç‰¹ç‚¹

```text
        äº‹å®è¡¨ï¼ˆä¸­å¿ƒï¼‰
           /|\
          / | \
         /  |  \
    ç»´åº¦è¡¨ ç»´åº¦è¡¨ ç»´åº¦è¡¨
```

### 2.2 å®Œæ•´ç¤ºä¾‹

```sql
-- äº‹å®è¡¨
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    product_id INT NOT NULL,
    customer_id INT NOT NULL,
    store_id INT NOT NULL,
    sales_amount NUMERIC(12,2),
    quantity INT,
    discount_amount NUMERIC(12,2)
);

-- ç»´åº¦è¡¨ï¼ˆæ‰å¹³ï¼‰
CREATE TABLE dim_time (
    time_id INT PRIMARY KEY,
    date DATE,
    year INT,
    quarter INT,
    month INT,
    week INT,
    day_of_week INT,
    is_weekend BOOLEAN,
    is_holiday BOOLEAN
);

CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_name TEXT,
    brand_name TEXT,
    supplier_name TEXT,
    unit_price NUMERIC(10,2)
);

CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    gender TEXT,
    age INT,
    region_name TEXT,
    country_name TEXT,
    city_name TEXT
);
```

### 2.3 ä¼˜åŠ¿

- âœ… æŸ¥è¯¢æ€§èƒ½å¥½ï¼ˆJOINå°‘ï¼‰
- âœ… è®¾è®¡ç®€å•
- âœ… æ˜“äºç†è§£
- âœ… é€‚åˆå¤§å¤šæ•°åœºæ™¯

### 2.4 åŠ£åŠ¿

- âŒ æ•°æ®å†—ä½™
- âŒ å­˜å‚¨ç©ºé—´è¾ƒå¤§
- âŒ ç»´åº¦æ›´æ–°å¤æ‚

---

## 3. é›ªèŠ±å‹æ¨¡å¼

### 3.1 ç»“æ„ç‰¹ç‚¹

```text
        äº‹å®è¡¨ï¼ˆä¸­å¿ƒï¼‰
           /|\
          / | \
         /  |  \
    ç»´åº¦è¡¨ ç»´åº¦è¡¨ ç»´åº¦è¡¨
         |   |   |
    å­ç»´åº¦ å­ç»´åº¦ å­ç»´åº¦
```

### 3.2 å®Œæ•´ç¤ºä¾‹

```sql
-- äº‹å®è¡¨
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    product_id INT NOT NULL,
    customer_id INT NOT NULL,
    sales_amount NUMERIC(12,2)
);

-- ç»´åº¦è¡¨ï¼ˆè§„èŒƒåŒ–ï¼‰
CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category(category_id)
);

CREATE TABLE dim_category (
    category_id INT PRIMARY KEY,
    category_name TEXT,
    department_id INT REFERENCES dim_department(department_id)
);

CREATE TABLE dim_department (
    department_id INT PRIMARY KEY,
    department_name TEXT
);

CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    city_id INT REFERENCES dim_city(city_id)
);

CREATE TABLE dim_city (
    city_id INT PRIMARY KEY,
    city_name TEXT,
    region_id INT REFERENCES dim_region(region_id)
);

CREATE TABLE dim_region (
    region_id INT PRIMARY KEY,
    region_name TEXT,
    country_id INT REFERENCES dim_country(country_id)
);

CREATE TABLE dim_country (
    country_id INT PRIMARY KEY,
    country_name TEXT
);
```

### 3.3 ä¼˜åŠ¿

- âœ… æ•°æ®è§„èŒƒåŒ–
- âœ… å­˜å‚¨ç©ºé—´èŠ‚çœ
- âœ… ç»´åº¦æ›´æ–°ç®€å•
- âœ… é€‚åˆå¤æ‚ç»´åº¦

### 3.4 åŠ£åŠ¿

- âŒ JOINå¤šï¼ŒæŸ¥è¯¢è¾ƒæ…¢
- âŒ è®¾è®¡å¤æ‚
- âŒ ç»´æŠ¤æˆæœ¬é«˜

---

## 4. æ¨¡å¼é€‰æ‹©

### 4.1 é€‰æ‹©çŸ©é˜µ

| åœºæ™¯ | æ¨èæ¨¡å¼ | åŸå›  |
| --- | --- | --- |
| å¤§å¤šæ•°åœºæ™¯ | æ˜Ÿå‹æ¨¡å¼ | æ€§èƒ½å¥½ï¼Œè®¾è®¡ç®€å• |
| ç»´åº¦å±‚æ¬¡æ·± | é›ªèŠ±å‹æ¨¡å¼ | èŠ‚çœå­˜å‚¨ï¼Œæ›´æ–°ç®€å• |
| æŸ¥è¯¢æ€§èƒ½ä¼˜å…ˆ | æ˜Ÿå‹æ¨¡å¼ | JOINå°‘ï¼Œæ€§èƒ½å¥½ |
| å­˜å‚¨ç©ºé—´æœ‰é™ | é›ªèŠ±å‹æ¨¡å¼ | æ•°æ®è§„èŒƒåŒ–ï¼ŒèŠ‚çœç©ºé—´ |
| ç»´åº¦å˜åŒ–é¢‘ç¹ | é›ªèŠ±å‹æ¨¡å¼ | æ›´æ–°ç®€å• |

### 4.2 å†³ç­–æµç¨‹

```text
1. ç»´åº¦å±‚æ¬¡æ˜¯å¦å¾ˆæ·±ï¼Ÿ
   â†’ æ˜¯ï¼šè€ƒè™‘é›ªèŠ±å‹æ¨¡å¼
   â†’ å¦ï¼šç»§ç»­

2. æŸ¥è¯¢æ€§èƒ½æ˜¯å¦å…³é”®ï¼Ÿ
   â†’ æ˜¯ï¼šé€‰æ‹©æ˜Ÿå‹æ¨¡å¼
   â†’ å¦ï¼šç»§ç»­

3. å­˜å‚¨ç©ºé—´æ˜¯å¦æœ‰é™ï¼Ÿ
   â†’ æ˜¯ï¼šè€ƒè™‘é›ªèŠ±å‹æ¨¡å¼
   â†’ å¦ï¼šé€‰æ‹©æ˜Ÿå‹æ¨¡å¼
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä¼˜å…ˆä½¿ç”¨æ˜Ÿå‹æ¨¡å¼** - å¤§å¤šæ•°åœºæ™¯æ€§èƒ½æ›´å¥½
2. **åˆç†è§„èŒƒåŒ–** - åªåœ¨å¿…è¦æ—¶ä½¿ç”¨é›ªèŠ±å‹æ¨¡å¼
3. **åˆ›å»ºç´¢å¼•** - ä¸ºæ‰€æœ‰ç»´åº¦é”®åˆ›å»ºç´¢å¼•
4. **ä½¿ç”¨ä»£ç†é”®** - æé«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§
5. **è€ƒè™‘æ··åˆæ¨¡å¼** - éƒ¨åˆ†ç»´åº¦æ˜Ÿå‹ï¼Œéƒ¨åˆ†ç»´åº¦é›ªèŠ±å‹

### âŒ é¿å…åšæ³•

1. **è¿‡åº¦è§„èŒƒåŒ–** - é¿å…ä¸å¿…è¦çš„JOIN
2. **å¿½ç•¥æ€§èƒ½** - æŸ¥è¯¢æ€§èƒ½ä¼˜å…ˆ
3. **ä¸ä½¿ç”¨ç´¢å¼•** - ç»´åº¦è¡¨å¿…é¡»æœ‰ç´¢å¼•
4. **æ¨¡å¼æ··ç”¨ä¸å½“** - éœ€è¦æ¸…æ™°çš„ç­–ç•¥

---

## 6. æ··åˆæ¨¡å¼è®¾è®¡

### 6.1 æ··åˆæ¨¡å¼ç¤ºä¾‹

```sql
-- æ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†ç»´åº¦æ˜Ÿå‹ï¼Œéƒ¨åˆ†ç»´åº¦é›ªèŠ±å‹
-- æ—¶é—´ç»´åº¦ï¼šæ˜Ÿå‹ï¼ˆæ‰å¹³ï¼‰
CREATE TABLE dim_time (
    time_id INT PRIMARY KEY,
    date DATE,
    year INT,
    quarter INT,
    month INT,
    week INT,
    day_of_week INT,
    is_weekend BOOLEAN,
    is_holiday BOOLEAN
);

-- äº§å“ç»´åº¦ï¼šé›ªèŠ±å‹ï¼ˆè§„èŒƒåŒ–ï¼‰
CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category(category_id)
);

CREATE TABLE dim_category (
    category_id INT PRIMARY KEY,
    category_name TEXT,
    department_id INT REFERENCES dim_department(department_id)
);

CREATE TABLE dim_department (
    department_id INT PRIMARY KEY,
    department_name TEXT
);

-- å®¢æˆ·ç»´åº¦ï¼šæ˜Ÿå‹ï¼ˆæ‰å¹³ï¼‰
CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    gender TEXT,
    age INT,
    region_name TEXT,
    country_name TEXT,
    city_name TEXT
);
```

### 6.2 æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æ··åˆæ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    t.quarter,
    d.department_name,
    c.region_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id  -- æ˜Ÿå‹ï¼š1ä¸ªJOIN
JOIN dim_product p ON f.product_id = p.product_id  -- é›ªèŠ±å‹ï¼šå¼€å§‹
JOIN dim_category cat ON p.category_id = cat.category_id  -- é›ªèŠ±å‹ï¼šä¸­é—´
JOIN dim_department d ON cat.department_id = d.department_id  -- é›ªèŠ±å‹ï¼šç»“æŸï¼ˆ3ä¸ªJOINï¼‰
JOIN dim_customer c ON f.customer_id = c.customer_id  -- æ˜Ÿå‹ï¼š1ä¸ªJOIN
WHERE t.year = 2024
GROUP BY t.year, t.quarter, d.department_name, c.region_name;

-- ä¼˜åŒ–å»ºè®®ï¼š
-- 1. ä¸ºäº§å“ç»´åº¦åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆæ‰å¹³åŒ–ï¼‰
-- 2. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–JOIN
-- 3. è€ƒè™‘å°†å¸¸ç”¨ç»´åº¦æ‰å¹³åŒ–
```

---

## 7. æ¨¡å¼è½¬æ¢ç­–ç•¥

### 7.1 æ˜Ÿå‹è½¬é›ªèŠ±å‹

```sql
-- æ˜Ÿå‹è½¬é›ªèŠ±å‹ï¼šè§„èŒƒåŒ–äº§å“ç»´åº¦
-- æ­¥éª¤1ï¼šåˆ›å»ºè§„èŒƒåŒ–è¡¨
CREATE TABLE dim_category_new (
    category_id SERIAL PRIMARY KEY,
    category_name TEXT UNIQUE NOT NULL
);

CREATE TABLE dim_product_new (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category_new(category_id)
);

-- æ­¥éª¤2ï¼šè¿ç§»æ•°æ®
INSERT INTO dim_category_new (category_name)
SELECT DISTINCT category_name
FROM dim_product
WHERE category_name IS NOT NULL;

INSERT INTO dim_product_new (product_id, product_name, category_id)
SELECT
    p.product_id,
    p.product_name,
    c.category_id
FROM dim_product p
JOIN dim_category_new c ON p.category_name = c.category_name;

-- æ­¥éª¤3ï¼šæ›´æ–°äº‹å®è¡¨å¤–é”®ï¼ˆå¦‚æœéœ€è¦ï¼‰
-- æ­¥éª¤4ï¼šåˆ é™¤æ—§è¡¨ï¼Œé‡å‘½åæ–°è¡¨
```

### 7.2 é›ªèŠ±å‹è½¬æ˜Ÿå‹

```sql
-- é›ªèŠ±å‹è½¬æ˜Ÿå‹ï¼šæ‰å¹³åŒ–äº§å“ç»´åº¦
-- æ­¥éª¤1ï¼šåˆ›å»ºæ‰å¹³åŒ–è¡¨
CREATE TABLE dim_product_flat AS
SELECT
    p.product_id,
    p.product_name,
    c.category_name,
    d.department_name
FROM dim_product p
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id;

-- æ­¥éª¤2ï¼šæ›´æ–°äº‹å®è¡¨å¤–é”®ï¼ˆå¦‚æœéœ€è¦ï¼‰
-- æ­¥éª¤3ï¼šåˆ é™¤è§„èŒƒåŒ–è¡¨ï¼Œé‡å‘½åæ‰å¹³è¡¨
```

---

## 8. æ€§èƒ½å¯¹æ¯”åˆ†æ

### 8.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

```sql
-- æ˜Ÿå‹æ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    p.category_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
WHERE t.year = 2024
GROUP BY t.year, p.category_name;
-- é¢„æœŸï¼š2ä¸ªJOINï¼Œæ€§èƒ½è¾ƒå¥½

-- é›ªèŠ±å‹æ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    d.department_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id
WHERE t.year = 2024
GROUP BY t.year, d.department_name;
-- é¢„æœŸï¼š4ä¸ªJOINï¼Œæ€§èƒ½è¾ƒå·®
```

### 8.2 å­˜å‚¨ç©ºé—´å¯¹æ¯”

```sql
-- æ˜Ÿå‹æ¨¡å¼å­˜å‚¨ç©ºé—´
SELECT
    pg_size_pretty(pg_total_relation_size('dim_product')) AS star_storage;

-- é›ªèŠ±å‹æ¨¡å¼å­˜å‚¨ç©ºé—´
SELECT
    pg_size_pretty(
        pg_total_relation_size('dim_product') +
        pg_total_relation_size('dim_category') +
        pg_total_relation_size('dim_department')
    ) AS snowflake_storage;

-- å¯¹æ¯”åˆ†æï¼š
-- æ˜Ÿå‹æ¨¡å¼ï¼šæ•°æ®å†—ä½™ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå¤§
-- é›ªèŠ±å‹æ¨¡å¼ï¼šæ•°æ®è§„èŒƒåŒ–ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå°
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—.md](./æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—.md) - æ•°æ®ä»“åº“è®¾è®¡
- [OLAPæŸ¥è¯¢ä¼˜åŒ–.md](./OLAPæŸ¥è¯¢ä¼˜åŒ–.md) - OLAPæŸ¥è¯¢ä¼˜åŒ–
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
