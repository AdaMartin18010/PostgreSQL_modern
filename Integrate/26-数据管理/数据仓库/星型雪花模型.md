# æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—](#æ˜Ÿå‹é›ªèŠ±æ¨¡å‹è®¾è®¡æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ˜Ÿå‹æ¨¡å¼](#2-æ˜Ÿå‹æ¨¡å¼)
    - [2.1 ç»“æ„ç‰¹ç‚¹](#21-ç»“æ„ç‰¹ç‚¹)
    - [2.2 å®Œæ•´ç¤ºä¾‹](#22-å®Œæ•´ç¤ºä¾‹)
    - [2.3 ä¼˜åŠ¿](#23-ä¼˜åŠ¿)
    - [2.4 åŠ£åŠ¿](#24-åŠ£åŠ¿)
  - [3. é›ªèŠ±å‹æ¨¡å¼](#3-é›ªèŠ±å‹æ¨¡å¼)
    - [3.1 ç»“æ„ç‰¹ç‚¹](#31-ç»“æ„ç‰¹ç‚¹)
    - [3.2 å®Œæ•´ç¤ºä¾‹](#32-å®Œæ•´ç¤ºä¾‹)
    - [3.3 ä¼˜åŠ¿](#33-ä¼˜åŠ¿)
    - [3.4 åŠ£åŠ¿](#34-åŠ£åŠ¿)
  - [4. æ¨¡å¼é€‰æ‹©](#4-æ¨¡å¼é€‰æ‹©)
    - [4.1 é€‰æ‹©çŸ©é˜µ](#41-é€‰æ‹©çŸ©é˜µ)
    - [4.2 å†³ç­–æµç¨‹](#42-å†³ç­–æµç¨‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [6. æ··åˆæ¨¡å¼è®¾è®¡](#6-æ··åˆæ¨¡å¼è®¾è®¡)
    - [6.1 æ··åˆæ¨¡å¼ç¤ºä¾‹](#61-æ··åˆæ¨¡å¼ç¤ºä¾‹)
    - [6.2 æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–](#62-æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–)
  - [7. æ¨¡å¼è½¬æ¢ç­–ç•¥](#7-æ¨¡å¼è½¬æ¢ç­–ç•¥)
    - [7.1 æ˜Ÿå‹è½¬é›ªèŠ±å‹](#71-æ˜Ÿå‹è½¬é›ªèŠ±å‹)
    - [7.2 é›ªèŠ±å‹è½¬æ˜Ÿå‹](#72-é›ªèŠ±å‹è½¬æ˜Ÿå‹)
  - [8. æ€§èƒ½å¯¹æ¯”åˆ†æ](#8-æ€§èƒ½å¯¹æ¯”åˆ†æ)
    - [8.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”](#81-æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”)
    - [8.2 å­˜å‚¨ç©ºé—´å¯¹æ¯”](#82-å­˜å‚¨ç©ºé—´å¯¹æ¯”)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æ˜Ÿå‹æ¨¡å¼å’Œé›ªèŠ±å‹æ¨¡å¼æ˜¯æ•°æ®ä»“åº“çš„ä¸¤ç§ä¸»è¦è®¾è®¡æ¨¡å¼ï¼š

- **æ˜Ÿå‹æ¨¡å¼** - äº‹å®è¡¨+æ‰å¹³ç»´åº¦è¡¨
- **é›ªèŠ±å‹æ¨¡å¼** - äº‹å®è¡¨+è§„èŒƒåŒ–ç»´åº¦è¡¨

é€‰æ‹©åˆé€‚çš„æ¨¡å¼å¯¹æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§è‡³å…³é‡è¦ã€‚

---

## 2. æ˜Ÿå‹æ¨¡å¼

### 2.1 ç»“æ„ç‰¹ç‚¹

```text
        äº‹å®è¡¨ï¼ˆä¸­å¿ƒï¼‰
           /|\
          / | \
         /  |  \
    ç»´åº¦è¡¨ ç»´åº¦è¡¨ ç»´åº¦è¡¨
```

### 2.2 å®Œæ•´ç¤ºä¾‹

```sql
-- æ˜Ÿå‹æ¨¡å¼ï¼šç»´åº¦è¡¨æ‰å¹³åŒ–è®¾è®¡

-- 1. åˆ›å»ºæ—¶é—´ç»´åº¦è¡¨
CREATE TABLE IF NOT EXISTS dim_time (
    time_id SERIAL PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    year INTEGER NOT NULL,
    quarter INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
    week INTEGER NOT NULL CHECK (week BETWEEN 1 AND 53),
    day_of_week INTEGER NOT NULL CHECK (day_of_week BETWEEN 1 AND 7),
    is_weekend BOOLEAN GENERATED ALWAYS AS (day_of_week IN (6, 7)) STORED,
    is_holiday BOOLEAN DEFAULT FALSE
);

-- 2. åˆ›å»ºäº§å“ç»´åº¦è¡¨ï¼ˆæ‰å¹³åŒ–ï¼ŒåŒ…å«æ‰€æœ‰å±‚çº§ä¿¡æ¯ï¼‰
CREATE TABLE IF NOT EXISTS dim_product (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category_name VARCHAR(100) NOT NULL,
    brand_name VARCHAR(100),
    supplier_name VARCHAR(100),
    unit_price NUMERIC(10,2) NOT NULL CHECK (unit_price > 0)
);

-- 3. åˆ›å»ºå®¢æˆ·ç»´åº¦è¡¨ï¼ˆæ‰å¹³åŒ–ï¼‰
CREATE TABLE IF NOT EXISTS dim_customer (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(200) NOT NULL,
    gender VARCHAR(10) CHECK (gender IN ('Male', 'Female', 'Other')),
    age INTEGER CHECK (age > 0),
    region_name VARCHAR(100) NOT NULL,
    country_name VARCHAR(100) NOT NULL,
    city_name VARCHAR(100) NOT NULL
);

-- 4. åˆ›å»ºé—¨åº—ç»´åº¦è¡¨
CREATE TABLE IF NOT EXISTS dim_store (
    store_id SERIAL PRIMARY KEY,
    store_name VARCHAR(200) NOT NULL,
    store_type VARCHAR(50),
    region_name VARCHAR(100)
);

-- 5. åˆ›å»ºäº‹å®è¡¨ï¼ˆä¸­å¿ƒè¡¨ï¼‰
CREATE TABLE IF NOT EXISTS fact_sales (
    sale_id SERIAL,
    time_id INTEGER NOT NULL REFERENCES dim_time(time_id),
    product_id INTEGER NOT NULL REFERENCES dim_product(product_id),
    customer_id INTEGER NOT NULL REFERENCES dim_customer(customer_id),
    store_id INTEGER NOT NULL REFERENCES dim_store(store_id),
    sales_amount NUMERIC(12,2) NOT NULL CHECK (sales_amount >= 0),
    quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
    discount_amount NUMERIC(12,2) DEFAULT 0 CHECK (discount_amount >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 6. æ’å…¥ç¤ºä¾‹ç»´åº¦æ•°æ®
INSERT INTO dim_time (date, year, quarter, month, week, day_of_week, is_holiday) VALUES
    ('2024-01-15', 2024, 1, 1, 3, 1, FALSE),
    ('2024-02-20', 2024, 1, 2, 8, 2, FALSE),
    ('2024-03-10', 2024, 1, 3, 11, 7, TRUE)
ON CONFLICT (date) DO NOTHING;

INSERT INTO dim_product (product_name, category_name, brand_name, supplier_name, unit_price) VALUES
    ('Laptop Pro', 'Electronics', 'TechBrand', 'TechSupplier', 999.99),
    ('Wireless Mouse', 'Electronics', 'TechBrand', 'TechSupplier', 29.99),
    ('Office Chair', 'Furniture', 'ComfortBrand', 'FurnitureSupplier', 199.99)
ON CONFLICT DO NOTHING;

INSERT INTO dim_customer (customer_name, gender, age, region_name, country_name, city_name) VALUES
    ('Alice Johnson', 'Female', 35, 'North', 'USA', 'New York'),
    ('Bob Smith', 'Male', 42, 'South', 'USA', 'Miami'),
    ('Charlie Brown', 'Male', 28, 'West', 'USA', 'Los Angeles')
ON CONFLICT DO NOTHING;

INSERT INTO dim_store (store_name, store_type, region_name) VALUES
    ('NYC Flagship', 'Retail', 'North'),
    ('Miami Store', 'Retail', 'South'),
    ('LA Warehouse', 'Warehouse', 'West')
ON CONFLICT DO NOTHING;

-- 7. æ’å…¥ç¤ºä¾‹äº‹å®æ•°æ®
INSERT INTO fact_sales (time_id, product_id, customer_id, store_id, sales_amount, quantity, discount_amount)
SELECT
    (SELECT time_id FROM dim_time WHERE date = '2024-01-15'),
    (SELECT product_id FROM dim_product WHERE product_name = 'Laptop Pro'),
    (SELECT customer_id FROM dim_customer WHERE customer_name = 'Alice Johnson'),
    (SELECT store_id FROM dim_store WHERE store_name = 'NYC Flagship'),
    999.99, 1, 0.00
UNION ALL
SELECT
    (SELECT time_id FROM dim_time WHERE date = '2024-02-20'),
    (SELECT product_id FROM dim_product WHERE product_name = 'Wireless Mouse'),
    (SELECT customer_id FROM dim_customer WHERE customer_name = 'Bob Smith'),
    (SELECT store_id FROM dim_store WHERE store_name = 'Miami Store'),
    149.95, 5, 10.00;
```

### 2.3 ä¼˜åŠ¿

- âœ… æŸ¥è¯¢æ€§èƒ½å¥½ï¼ˆJOINå°‘ï¼‰
- âœ… è®¾è®¡ç®€å•
- âœ… æ˜“äºç†è§£
- âœ… é€‚åˆå¤§å¤šæ•°åœºæ™¯

### 2.4 åŠ£åŠ¿

- âŒ æ•°æ®å†—ä½™
- âŒ å­˜å‚¨ç©ºé—´è¾ƒå¤§
- âŒ ç»´åº¦æ›´æ–°å¤æ‚

---

## 3. é›ªèŠ±å‹æ¨¡å¼

### 3.1 ç»“æ„ç‰¹ç‚¹

```text
        äº‹å®è¡¨ï¼ˆä¸­å¿ƒï¼‰
           /|\
          / | \
         /  |  \
    ç»´åº¦è¡¨ ç»´åº¦è¡¨ ç»´åº¦è¡¨
         |   |   |
    å­ç»´åº¦ å­ç»´åº¦ å­ç»´åº¦
```

### 3.2 å®Œæ•´ç¤ºä¾‹

```sql
-- é›ªèŠ±å‹æ¨¡å¼ï¼šç»´åº¦è¡¨è§„èŒƒåŒ–è®¾è®¡

-- 1. åˆ›å»ºè§„èŒƒåŒ–ç»´åº¦è¡¨ï¼ˆä»æœ€åº•å±‚å¼€å§‹ï¼‰

-- åœ°ç†ç»´åº¦å±‚çº§ï¼ˆä»åº•å±‚åˆ°é¡¶å±‚ï¼‰
CREATE TABLE IF NOT EXISTS dim_country (
    country_id SERIAL PRIMARY KEY,
    country_name VARCHAR(100) NOT NULL UNIQUE,
    country_code VARCHAR(3) UNIQUE
);

CREATE TABLE IF NOT EXISTS dim_region (
    region_id SERIAL PRIMARY KEY,
    region_name VARCHAR(100) NOT NULL,
    country_id INTEGER NOT NULL REFERENCES dim_country(country_id),
    UNIQUE(region_name, country_id)
);

CREATE TABLE IF NOT EXISTS dim_city (
    city_id SERIAL PRIMARY KEY,
    city_name VARCHAR(100) NOT NULL,
    region_id INTEGER NOT NULL REFERENCES dim_region(region_id),
    population INTEGER,
    UNIQUE(city_name, region_id)
);

-- äº§å“ç»´åº¦å±‚çº§
CREATE TABLE IF NOT EXISTS dim_department (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS dim_category (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    department_id INTEGER NOT NULL REFERENCES dim_department(department_id),
    UNIQUE(category_name, department_id)
);

CREATE TABLE IF NOT EXISTS dim_product (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category_id INTEGER NOT NULL REFERENCES dim_category(category_id),
    unit_price NUMERIC(10,2) NOT NULL CHECK (unit_price > 0)
);

-- å®¢æˆ·ç»´åº¦
CREATE TABLE IF NOT EXISTS dim_customer (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(200) NOT NULL,
    city_id INTEGER NOT NULL REFERENCES dim_city(city_id)
);

-- 2. åˆ›å»ºäº‹å®è¡¨
CREATE TABLE IF NOT EXISTS fact_sales (
    sale_id SERIAL,
    time_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL REFERENCES dim_product(product_id),
    customer_id INTEGER NOT NULL REFERENCES dim_customer(customer_id),
    sales_amount NUMERIC(12,2) NOT NULL CHECK (sales_amount >= 0),
    quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆæŒ‰ç…§ä¾èµ–å…³ç³»é¡ºåºï¼‰
INSERT INTO dim_country (country_name, country_code) VALUES
    ('United States', 'USA'),
    ('Canada', 'CAN')
ON CONFLICT (country_name) DO NOTHING;

INSERT INTO dim_region (region_name, country_id) VALUES
    ('North', (SELECT country_id FROM dim_country WHERE country_code = 'USA')),
    ('South', (SELECT country_id FROM dim_country WHERE country_code = 'USA'))
ON CONFLICT (region_name, country_id) DO NOTHING;

INSERT INTO dim_city (city_name, region_id, population) VALUES
    ('New York', (SELECT region_id FROM dim_region WHERE region_name = 'North' LIMIT 1), 8000000),
    ('Miami', (SELECT region_id FROM dim_region WHERE region_name = 'South' LIMIT 1), 4000000)
ON CONFLICT (city_name, region_id) DO NOTHING;

INSERT INTO dim_department (department_name) VALUES
    ('Electronics'),
    ('Furniture')
ON CONFLICT (department_name) DO NOTHING;

INSERT INTO dim_category (category_name, department_id) VALUES
    ('Computers', (SELECT department_id FROM dim_department WHERE department_name = 'Electronics')),
    ('Accessories', (SELECT department_id FROM dim_department WHERE department_name = 'Electronics'))
ON CONFLICT (category_name, department_id) DO NOTHING;

INSERT INTO dim_product (product_name, category_id, unit_price) VALUES
    ('Laptop Pro', (SELECT category_id FROM dim_category WHERE category_name = 'Computers' LIMIT 1), 999.99),
    ('Wireless Mouse', (SELECT category_id FROM dim_category WHERE category_name = 'Accessories' LIMIT 1), 29.99)
ON CONFLICT DO NOTHING;

INSERT INTO dim_customer (customer_name, city_id) VALUES
    ('Alice Johnson', (SELECT city_id FROM dim_city WHERE city_name = 'New York' LIMIT 1)),
    ('Bob Smith', (SELECT city_id FROM dim_city WHERE city_name = 'Miami' LIMIT 1))
ON CONFLICT DO NOTHING;

-- 4. æŸ¥è¯¢ç¤ºä¾‹ï¼ˆéœ€è¦å¤šè¡¨JOINï¼‰
SELECT
    co.country_name,
    r.region_name,
    ci.city_name,
    d.department_name,
    c.category_name,
    p.product_name,
    cu.customer_name,
    f.sales_amount
FROM fact_sales f
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id
JOIN dim_customer cu ON f.customer_id = cu.customer_id
JOIN dim_city ci ON cu.city_id = ci.city_id
JOIN dim_region r ON ci.region_id = r.region_id
JOIN dim_country co ON r.country_id = co.country_id
ORDER BY f.sales_amount DESC;
```

### 3.3 ä¼˜åŠ¿

- âœ… æ•°æ®è§„èŒƒåŒ–
- âœ… å­˜å‚¨ç©ºé—´èŠ‚çœ
- âœ… ç»´åº¦æ›´æ–°ç®€å•
- âœ… é€‚åˆå¤æ‚ç»´åº¦

### 3.4 åŠ£åŠ¿

- âŒ JOINå¤šï¼ŒæŸ¥è¯¢è¾ƒæ…¢
- âŒ è®¾è®¡å¤æ‚
- âŒ ç»´æŠ¤æˆæœ¬é«˜

---

## 4. æ¨¡å¼é€‰æ‹©

### 4.1 é€‰æ‹©çŸ©é˜µ

| åœºæ™¯ | æ¨èæ¨¡å¼ | åŸå›  |
| --- | --- | --- |
| å¤§å¤šæ•°åœºæ™¯ | æ˜Ÿå‹æ¨¡å¼ | æ€§èƒ½å¥½ï¼Œè®¾è®¡ç®€å• |
| ç»´åº¦å±‚æ¬¡æ·± | é›ªèŠ±å‹æ¨¡å¼ | èŠ‚çœå­˜å‚¨ï¼Œæ›´æ–°ç®€å• |
| æŸ¥è¯¢æ€§èƒ½ä¼˜å…ˆ | æ˜Ÿå‹æ¨¡å¼ | JOINå°‘ï¼Œæ€§èƒ½å¥½ |
| å­˜å‚¨ç©ºé—´æœ‰é™ | é›ªèŠ±å‹æ¨¡å¼ | æ•°æ®è§„èŒƒåŒ–ï¼ŒèŠ‚çœç©ºé—´ |
| ç»´åº¦å˜åŒ–é¢‘ç¹ | é›ªèŠ±å‹æ¨¡å¼ | æ›´æ–°ç®€å• |

### 4.2 å†³ç­–æµç¨‹

```text
1. ç»´åº¦å±‚æ¬¡æ˜¯å¦å¾ˆæ·±ï¼Ÿ
   â†’ æ˜¯ï¼šè€ƒè™‘é›ªèŠ±å‹æ¨¡å¼
   â†’ å¦ï¼šç»§ç»­

2. æŸ¥è¯¢æ€§èƒ½æ˜¯å¦å…³é”®ï¼Ÿ
   â†’ æ˜¯ï¼šé€‰æ‹©æ˜Ÿå‹æ¨¡å¼
   â†’ å¦ï¼šç»§ç»­

3. å­˜å‚¨ç©ºé—´æ˜¯å¦æœ‰é™ï¼Ÿ
   â†’ æ˜¯ï¼šè€ƒè™‘é›ªèŠ±å‹æ¨¡å¼
   â†’ å¦ï¼šé€‰æ‹©æ˜Ÿå‹æ¨¡å¼
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä¼˜å…ˆä½¿ç”¨æ˜Ÿå‹æ¨¡å¼** - å¤§å¤šæ•°åœºæ™¯æ€§èƒ½æ›´å¥½
2. **åˆç†è§„èŒƒåŒ–** - åªåœ¨å¿…è¦æ—¶ä½¿ç”¨é›ªèŠ±å‹æ¨¡å¼
3. **åˆ›å»ºç´¢å¼•** - ä¸ºæ‰€æœ‰ç»´åº¦é”®åˆ›å»ºç´¢å¼•
4. **ä½¿ç”¨ä»£ç†é”®** - æé«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§
5. **è€ƒè™‘æ··åˆæ¨¡å¼** - éƒ¨åˆ†ç»´åº¦æ˜Ÿå‹ï¼Œéƒ¨åˆ†ç»´åº¦é›ªèŠ±å‹

### âŒ é¿å…åšæ³•

1. **è¿‡åº¦è§„èŒƒåŒ–** - é¿å…ä¸å¿…è¦çš„JOIN
2. **å¿½ç•¥æ€§èƒ½** - æŸ¥è¯¢æ€§èƒ½ä¼˜å…ˆ
3. **ä¸ä½¿ç”¨ç´¢å¼•** - ç»´åº¦è¡¨å¿…é¡»æœ‰ç´¢å¼•
4. **æ¨¡å¼æ··ç”¨ä¸å½“** - éœ€è¦æ¸…æ™°çš„ç­–ç•¥

---

## 6. æ··åˆæ¨¡å¼è®¾è®¡

### 6.1 æ··åˆæ¨¡å¼ç¤ºä¾‹

```sql
-- æ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†ç»´åº¦æ˜Ÿå‹ï¼Œéƒ¨åˆ†ç»´åº¦é›ªèŠ±å‹
-- æ—¶é—´ç»´åº¦ï¼šæ˜Ÿå‹ï¼ˆæ‰å¹³ï¼‰
CREATE TABLE dim_time (
    time_id INT PRIMARY KEY,
    date DATE,
    year INT,
    quarter INT,
    month INT,
    week INT,
    day_of_week INT,
    is_weekend BOOLEAN,
    is_holiday BOOLEAN
);

-- äº§å“ç»´åº¦ï¼šé›ªèŠ±å‹ï¼ˆè§„èŒƒåŒ–ï¼‰
CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category(category_id)
);

CREATE TABLE dim_category (
    category_id INT PRIMARY KEY,
    category_name TEXT,
    department_id INT REFERENCES dim_department(department_id)
);

CREATE TABLE dim_department (
    department_id INT PRIMARY KEY,
    department_name TEXT
);

-- å®¢æˆ·ç»´åº¦ï¼šæ˜Ÿå‹ï¼ˆæ‰å¹³ï¼‰
CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    gender TEXT,
    age INT,
    region_name TEXT,
    country_name TEXT,
    city_name TEXT
);
```

### 6.2 æ··åˆæ¨¡å¼æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æ··åˆæ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    t.quarter,
    d.department_name,
    c.region_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id  -- æ˜Ÿå‹ï¼š1ä¸ªJOIN
JOIN dim_product p ON f.product_id = p.product_id  -- é›ªèŠ±å‹ï¼šå¼€å§‹
JOIN dim_category cat ON p.category_id = cat.category_id  -- é›ªèŠ±å‹ï¼šä¸­é—´
JOIN dim_department d ON cat.department_id = d.department_id  -- é›ªèŠ±å‹ï¼šç»“æŸï¼ˆ3ä¸ªJOINï¼‰
JOIN dim_customer c ON f.customer_id = c.customer_id  -- æ˜Ÿå‹ï¼š1ä¸ªJOIN
WHERE t.year = 2024
GROUP BY t.year, t.quarter, d.department_name, c.region_name;

-- ä¼˜åŒ–å»ºè®®ï¼š
-- 1. ä¸ºäº§å“ç»´åº¦åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆæ‰å¹³åŒ–ï¼‰
-- 2. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–JOIN
-- 3. è€ƒè™‘å°†å¸¸ç”¨ç»´åº¦æ‰å¹³åŒ–
```

---

## 7. æ¨¡å¼è½¬æ¢ç­–ç•¥

### 7.1 æ˜Ÿå‹è½¬é›ªèŠ±å‹

```sql
-- æ˜Ÿå‹è½¬é›ªèŠ±å‹ï¼šè§„èŒƒåŒ–äº§å“ç»´åº¦
-- æ­¥éª¤1ï¼šåˆ›å»ºè§„èŒƒåŒ–è¡¨
CREATE TABLE dim_category_new (
    category_id SERIAL PRIMARY KEY,
    category_name TEXT UNIQUE NOT NULL
);

CREATE TABLE dim_product_new (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category_new(category_id)
);

-- æ­¥éª¤2ï¼šè¿ç§»æ•°æ®
INSERT INTO dim_category_new (category_name)
SELECT DISTINCT category_name
FROM dim_product
WHERE category_name IS NOT NULL;

INSERT INTO dim_product_new (product_id, product_name, category_id)
SELECT
    p.product_id,
    p.product_name,
    c.category_id
FROM dim_product p
JOIN dim_category_new c ON p.category_name = c.category_name;

-- æ­¥éª¤3ï¼šæ›´æ–°äº‹å®è¡¨å¤–é”®ï¼ˆå¦‚æœéœ€è¦ï¼‰
-- æ­¥éª¤4ï¼šåˆ é™¤æ—§è¡¨ï¼Œé‡å‘½åæ–°è¡¨
```

### 7.2 é›ªèŠ±å‹è½¬æ˜Ÿå‹

```sql
-- é›ªèŠ±å‹è½¬æ˜Ÿå‹ï¼šæ‰å¹³åŒ–äº§å“ç»´åº¦
-- æ­¥éª¤1ï¼šåˆ›å»ºæ‰å¹³åŒ–è¡¨
CREATE TABLE dim_product_flat AS
SELECT
    p.product_id,
    p.product_name,
    c.category_name,
    d.department_name
FROM dim_product p
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id;

-- æ­¥éª¤2ï¼šæ›´æ–°äº‹å®è¡¨å¤–é”®ï¼ˆå¦‚æœéœ€è¦ï¼‰
-- æ­¥éª¤3ï¼šåˆ é™¤è§„èŒƒåŒ–è¡¨ï¼Œé‡å‘½åæ‰å¹³è¡¨
```

---

## 8. æ€§èƒ½å¯¹æ¯”åˆ†æ

### 8.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

```sql
-- æ˜Ÿå‹æ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    p.category_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
WHERE t.year = 2024
GROUP BY t.year, p.category_name;
-- é¢„æœŸï¼š2ä¸ªJOINï¼Œæ€§èƒ½è¾ƒå¥½

-- é›ªèŠ±å‹æ¨¡å¼æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    t.year,
    d.department_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id
WHERE t.year = 2024
GROUP BY t.year, d.department_name;
-- é¢„æœŸï¼š4ä¸ªJOINï¼Œæ€§èƒ½è¾ƒå·®
```

### 8.2 å­˜å‚¨ç©ºé—´å¯¹æ¯”

```sql
-- æ˜Ÿå‹æ¨¡å¼å­˜å‚¨ç©ºé—´
SELECT
    pg_size_pretty(pg_total_relation_size('dim_product')) AS star_storage;

-- é›ªèŠ±å‹æ¨¡å¼å­˜å‚¨ç©ºé—´
SELECT
    pg_size_pretty(
        pg_total_relation_size('dim_product') +
        pg_total_relation_size('dim_category') +
        pg_total_relation_size('dim_department')
    ) AS snowflake_storage;

-- å¯¹æ¯”åˆ†æï¼š
-- æ˜Ÿå‹æ¨¡å¼ï¼šæ•°æ®å†—ä½™ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå¤§
-- é›ªèŠ±å‹æ¨¡å¼ï¼šæ•°æ®è§„èŒƒåŒ–ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå°
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—.md](./æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—.md) - æ•°æ®ä»“åº“è®¾è®¡
- [OLAPæŸ¥è¯¢ä¼˜åŒ–.md](./OLAPæŸ¥è¯¢ä¼˜åŒ–.md) - OLAPæŸ¥è¯¢ä¼˜åŒ–
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
