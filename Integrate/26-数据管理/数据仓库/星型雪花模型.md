# 星型雪花模型设计指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [星型雪花模型设计指南](#星型雪花模型设计指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 星型模式](#2-星型模式)
    - [2.1 结构特点](#21-结构特点)
    - [2.2 完整示例](#22-完整示例)
    - [2.3 优势](#23-优势)
    - [2.4 劣势](#24-劣势)
  - [3. 雪花型模式](#3-雪花型模式)
    - [3.1 结构特点](#31-结构特点)
    - [3.2 完整示例](#32-完整示例)
    - [3.3 优势](#33-优势)
    - [3.4 劣势](#34-劣势)
  - [4. 模式选择](#4-模式选择)
    - [4.1 选择矩阵](#41-选择矩阵)
    - [4.2 决策流程](#42-决策流程)
  - [5. 最佳实践](#5-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

星型模式和雪花型模式是数据仓库的两种主要设计模式：

- **星型模式** - 事实表+扁平维度表
- **雪花型模式** - 事实表+规范化维度表

选择合适的模式对性能和可维护性至关重要。

---

## 2. 星型模式

### 2.1 结构特点

```
        事实表（中心）
           /|\
          / | \
         /  |  \
    维度表 维度表 维度表
```

### 2.2 完整示例

```sql
-- 事实表
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    product_id INT NOT NULL,
    customer_id INT NOT NULL,
    store_id INT NOT NULL,
    sales_amount NUMERIC(12,2),
    quantity INT,
    discount_amount NUMERIC(12,2)
);

-- 维度表（扁平）
CREATE TABLE dim_time (
    time_id INT PRIMARY KEY,
    date DATE,
    year INT,
    quarter INT,
    month INT,
    week INT,
    day_of_week INT,
    is_weekend BOOLEAN,
    is_holiday BOOLEAN
);

CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_name TEXT,
    brand_name TEXT,
    supplier_name TEXT,
    unit_price NUMERIC(10,2)
);

CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    gender TEXT,
    age INT,
    region_name TEXT,
    country_name TEXT,
    city_name TEXT
);
```

### 2.3 优势

- ✅ 查询性能好（JOIN少）
- ✅ 设计简单
- ✅ 易于理解
- ✅ 适合大多数场景

### 2.4 劣势

- ❌ 数据冗余
- ❌ 存储空间较大
- ❌ 维度更新复杂

---

## 3. 雪花型模式

### 3.1 结构特点

```
        事实表（中心）
           /|\
          / | \
         /  |  \
    维度表 维度表 维度表
         |   |   |
    子维度 子维度 子维度
```

### 3.2 完整示例

```sql
-- 事实表
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    product_id INT NOT NULL,
    customer_id INT NOT NULL,
    sales_amount NUMERIC(12,2)
);

-- 维度表（规范化）
CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category(category_id)
);

CREATE TABLE dim_category (
    category_id INT PRIMARY KEY,
    category_name TEXT,
    department_id INT REFERENCES dim_department(department_id)
);

CREATE TABLE dim_department (
    department_id INT PRIMARY KEY,
    department_name TEXT
);

CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    city_id INT REFERENCES dim_city(city_id)
);

CREATE TABLE dim_city (
    city_id INT PRIMARY KEY,
    city_name TEXT,
    region_id INT REFERENCES dim_region(region_id)
);

CREATE TABLE dim_region (
    region_id INT PRIMARY KEY,
    region_name TEXT,
    country_id INT REFERENCES dim_country(country_id)
);

CREATE TABLE dim_country (
    country_id INT PRIMARY KEY,
    country_name TEXT
);
```

### 3.3 优势

- ✅ 数据规范化
- ✅ 存储空间节省
- ✅ 维度更新简单
- ✅ 适合复杂维度

### 3.4 劣势

- ❌ JOIN多，查询较慢
- ❌ 设计复杂
- ❌ 维护成本高

---

## 4. 模式选择

### 4.1 选择矩阵

| 场景 | 推荐模式 | 原因 |
| --- | --- | --- |
| 大多数场景 | 星型模式 | 性能好，设计简单 |
| 维度层次深 | 雪花型模式 | 节省存储，更新简单 |
| 查询性能优先 | 星型模式 | JOIN少，性能好 |
| 存储空间有限 | 雪花型模式 | 数据规范化，节省空间 |
| 维度变化频繁 | 雪花型模式 | 更新简单 |

### 4.2 决策流程

```
1. 维度层次是否很深？
   → 是：考虑雪花型模式
   → 否：继续

2. 查询性能是否关键？
   → 是：选择星型模式
   → 否：继续

3. 存储空间是否有限？
   → 是：考虑雪花型模式
   → 否：选择星型模式
```

---

## 5. 最佳实践

### ✅ 推荐做法

1. **优先使用星型模式** - 大多数场景性能更好
2. **合理规范化** - 只在必要时使用雪花型模式
3. **创建索引** - 为所有维度键创建索引
4. **使用代理键** - 提高性能和可维护性
5. **考虑混合模式** - 部分维度星型，部分维度雪花型

### ❌ 避免做法

1. **过度规范化** - 避免不必要的JOIN
2. **忽略性能** - 查询性能优先
3. **不使用索引** - 维度表必须有索引
4. **模式混用不当** - 需要清晰的策略

---

## 📚 相关文档

- [数据仓库设计指南.md](./数据仓库设计指南.md) - 数据仓库设计
- [OLAP查询优化.md](./OLAP查询优化.md) - OLAP查询优化
- [26-数据管理/README.md](../README.md) - 数据管理主题

---

**最后更新**: 2025年1月
