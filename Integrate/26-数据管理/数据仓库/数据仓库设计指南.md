# æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—](#æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ•°æ®ä»“åº“æ¶æ„](#2-æ•°æ®ä»“åº“æ¶æ„)
    - [2.1 ä¸‰å±‚æ¶æ„](#21-ä¸‰å±‚æ¶æ„)
    - [2.2 æ•°æ®æµ](#22-æ•°æ®æµ)
  - [3. æ˜Ÿå‹æ¨¡å¼è®¾è®¡](#3-æ˜Ÿå‹æ¨¡å¼è®¾è®¡)
    - [3.1 æ˜Ÿå‹æ¨¡å¼ç»“æ„](#31-æ˜Ÿå‹æ¨¡å¼ç»“æ„)
    - [3.2 æ˜Ÿå‹æ¨¡å¼ä¼˜åŠ¿](#32-æ˜Ÿå‹æ¨¡å¼ä¼˜åŠ¿)
  - [4. é›ªèŠ±å‹æ¨¡å¼è®¾è®¡](#4-é›ªèŠ±å‹æ¨¡å¼è®¾è®¡)
    - [4.1 é›ªèŠ±å‹æ¨¡å¼ç»“æ„](#41-é›ªèŠ±å‹æ¨¡å¼ç»“æ„)
    - [4.2 é›ªèŠ±å‹æ¨¡å¼ä¼˜åŠ¿](#42-é›ªèŠ±å‹æ¨¡å¼ä¼˜åŠ¿)
    - [4.3 é›ªèŠ±å‹æ¨¡å¼åŠ£åŠ¿](#43-é›ªèŠ±å‹æ¨¡å¼åŠ£åŠ¿)
  - [5. äº‹å®è¡¨è®¾è®¡](#5-äº‹å®è¡¨è®¾è®¡)
    - [5.1 äº‹å®è¡¨ç±»å‹](#51-äº‹å®è¡¨ç±»å‹)
    - [5.2 äº‹å®è¡¨è®¾è®¡åŸåˆ™](#52-äº‹å®è¡¨è®¾è®¡åŸåˆ™)
  - [6. ç»´åº¦è¡¨è®¾è®¡](#6-ç»´åº¦è¡¨è®¾è®¡)
    - [6.1 ç»´åº¦è¡¨è®¾è®¡åŸåˆ™](#61-ç»´åº¦è¡¨è®¾è®¡åŸåˆ™)
    - [6.2 ç¼“æ…¢å˜åŒ–ç»´åº¦ï¼ˆSCDï¼‰](#62-ç¼“æ…¢å˜åŒ–ç»´åº¦scd)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [8. æ•°æ®ä»“åº“å®æ–½æ­¥éª¤](#8-æ•°æ®ä»“åº“å®æ–½æ­¥éª¤)
    - [8.1 éœ€æ±‚åˆ†æ](#81-éœ€æ±‚åˆ†æ)
    - [8.2 æ•°æ®æ¨¡å‹è®¾è®¡](#82-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [8.3 ç»´åº¦è¡¨å®æ–½](#83-ç»´åº¦è¡¨å®æ–½)
  - [9. æ•°æ®ä»“åº“æ€§èƒ½ä¼˜åŒ–](#9-æ•°æ®ä»“åº“æ€§èƒ½ä¼˜åŒ–)
    - [9.1 åˆ†åŒºç­–ç•¥](#91-åˆ†åŒºç­–ç•¥)
    - [9.2 ç‰©åŒ–è§†å›¾ä¼˜åŒ–](#92-ç‰©åŒ–è§†å›¾ä¼˜åŒ–)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æ•°æ®ä»“åº“è®¾è®¡æ˜¯æ„å»ºé«˜æ•ˆåˆ†æç³»ç»Ÿçš„åŸºç¡€ã€‚PostgreSQLæ”¯æŒå®Œæ•´çš„æ•°æ®ä»“åº“åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- **å¤šç»´æ•°æ®æ¨¡å‹** - æ˜Ÿå‹æ¨¡å¼å’Œé›ªèŠ±å‹æ¨¡å¼
- **OLAPæŸ¥è¯¢** - GROUP BY ROLLUPã€CUBEã€GROUPING SETS
- **ç‰©åŒ–è§†å›¾** - é¢„è®¡ç®—èšåˆç»“æœ
- **åˆ†åŒºç­–ç•¥** - æŒ‰æ—¶é—´æˆ–ç»´åº¦åˆ†åŒº

---

## 2. æ•°æ®ä»“åº“æ¶æ„

### 2.1 ä¸‰å±‚æ¶æ„

```text
æ•°æ®æºå±‚
  â†“
ETLå±‚ï¼ˆæå–ã€è½¬æ¢ã€åŠ è½½ï¼‰
  â†“
æ•°æ®ä»“åº“å±‚ï¼ˆæ˜Ÿå‹/é›ªèŠ±å‹æ¨¡å¼ï¼‰
  â†“
OLAPå±‚ï¼ˆæŸ¥è¯¢å’Œåˆ†æï¼‰
```

### 2.2 æ•°æ®æµ

```text
æºç³»ç»Ÿ â†’ ETL â†’ æ•°æ®ä»“åº“ â†’ OLAPæŸ¥è¯¢ â†’ æŠ¥è¡¨/åˆ†æ
```

---

## 3. æ˜Ÿå‹æ¨¡å¼è®¾è®¡

### 3.1 æ˜Ÿå‹æ¨¡å¼ç»“æ„

```sql
-- æ•°æ®ä»“åº“æ˜Ÿå‹æ¨¡å¼è®¾è®¡
-- 1. åˆ›å»ºç»´åº¦è¡¨

-- æ—¶é—´ç»´åº¦è¡¨
CREATE TABLE IF NOT EXISTS dim_time (
    time_id SERIAL PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    year INTEGER NOT NULL,
    quarter INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
    week INTEGER NOT NULL CHECK (week BETWEEN 1 AND 53),
    day_of_week INTEGER NOT NULL CHECK (day_of_week BETWEEN 1 AND 7),
    is_weekend BOOLEAN GENERATED ALWAYS AS (day_of_week IN (6, 7)) STORED
);

-- äº§å“ç»´åº¦è¡¨
CREATE TABLE IF NOT EXISTS dim_product (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category_name VARCHAR(100) NOT NULL,
    brand_name VARCHAR(100),
    unit_price NUMERIC(10, 2) NOT NULL
);

-- å®¢æˆ·ç»´åº¦è¡¨
CREATE TABLE IF NOT EXISTS dim_customer (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(200) NOT NULL,
    region_name VARCHAR(100) NOT NULL,
    country_name VARCHAR(100) NOT NULL,
    customer_segment VARCHAR(50)
);

-- 2. åˆ›å»ºäº‹å®è¡¨ï¼ˆä¸­å¿ƒè¡¨ï¼‰
CREATE TABLE IF NOT EXISTS fact_sales (
    sale_id SERIAL,
    time_id INTEGER NOT NULL REFERENCES dim_time(time_id),
    product_id INTEGER NOT NULL REFERENCES dim_product(product_id),
    customer_id INTEGER NOT NULL REFERENCES dim_customer(customer_id),
    -- åº¦é‡å­—æ®µ
    sales_amount NUMERIC(12,2) NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    profit_amount NUMERIC(12,2),
    discount_amount NUMERIC(10,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (sale_id, time_id)  -- æ”¯æŒåˆ†åŒºé”®
);

-- 3. æ’å…¥ç¤ºä¾‹ç»´åº¦æ•°æ®
INSERT INTO dim_time (date, year, quarter, month, week, day_of_week) VALUES
    ('2024-01-15', 2024, 1, 1, 3, 1),
    ('2024-02-20', 2024, 1, 2, 8, 2),
    ('2024-03-10', 2024, 1, 3, 11, 7)
ON CONFLICT (date) DO NOTHING;

INSERT INTO dim_product (product_name, category_name, brand_name, unit_price) VALUES
    ('Laptop Pro', 'Electronics', 'TechBrand', 999.99),
    ('Wireless Mouse', 'Electronics', 'TechBrand', 29.99),
    ('Office Chair', 'Furniture', 'ComfortBrand', 199.99)
ON CONFLICT DO NOTHING;

INSERT INTO dim_customer (customer_name, region_name, country_name, customer_segment) VALUES
    ('Alice Corporation', 'North', 'USA', 'Enterprise'),
    ('Bob Industries', 'South', 'USA', 'SMB'),
    ('Charlie LLC', 'West', 'USA', 'Enterprise')
ON CONFLICT DO NOTHING;

-- 4. æ’å…¥ç¤ºä¾‹äº‹å®æ•°æ®
INSERT INTO fact_sales (time_id, product_id, customer_id, sales_amount, quantity, profit_amount, discount_amount)
SELECT
    (SELECT time_id FROM dim_time WHERE date = '2024-01-15'),
    (SELECT product_id FROM dim_product WHERE product_name = 'Laptop Pro'),
    (SELECT customer_id FROM dim_customer WHERE customer_name = 'Alice Corporation'),
    999.99, 1, 200.00, 0.00
UNION ALL
SELECT
    (SELECT time_id FROM dim_time WHERE date = '2024-02-20'),
    (SELECT product_id FROM dim_product WHERE product_name = 'Wireless Mouse'),
    (SELECT customer_id FROM dim_customer WHERE customer_name = 'Bob Industries'),
    29.99, 5, 50.00, 10.00;
```

### 3.2 æ˜Ÿå‹æ¨¡å¼ä¼˜åŠ¿

- æŸ¥è¯¢æ€§èƒ½å¥½ï¼ˆJOINå°‘ï¼‰
- è®¾è®¡ç®€å•
- æ˜“äºç†è§£
- é€‚åˆå¤§å¤šæ•°åœºæ™¯

---

## 4. é›ªèŠ±å‹æ¨¡å¼è®¾è®¡

### 4.1 é›ªèŠ±å‹æ¨¡å¼ç»“æ„

```sql
-- é›ªèŠ±å‹æ¨¡å¼ï¼šç»´åº¦è¡¨è¿›ä¸€æ­¥è§„èŒƒåŒ–

-- 1. åˆ›å»ºè§„èŒƒåŒ–ç»´åº¦è¡¨ï¼ˆä»æœ€åº•å±‚å¼€å§‹ï¼‰
CREATE TABLE IF NOT EXISTS dim_department (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS dim_category (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    department_id INTEGER NOT NULL REFERENCES dim_department(department_id)
);

CREATE TABLE IF NOT EXISTS dim_product (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category_id INTEGER NOT NULL REFERENCES dim_category(category_id),
    brand_name VARCHAR(100),
    unit_price NUMERIC(10, 2) NOT NULL
);

-- 2. æ’å…¥ç¤ºä¾‹æ•°æ®ï¼ˆæŒ‰ç…§ä¾èµ–å…³ç³»é¡ºåºï¼‰
INSERT INTO dim_department (department_name) VALUES
    ('Electronics'),
    ('Furniture'),
    ('Clothing')
ON CONFLICT (department_name) DO NOTHING;

INSERT INTO dim_category (category_name, department_id) VALUES
    ('Computers', (SELECT department_id FROM dim_department WHERE department_name = 'Electronics')),
    ('Accessories', (SELECT department_id FROM dim_department WHERE department_name = 'Electronics')),
    ('Chairs', (SELECT department_id FROM dim_department WHERE department_name = 'Furniture'))
ON CONFLICT DO NOTHING;

INSERT INTO dim_product (product_name, category_id, brand_name, unit_price) VALUES
    ('Laptop Pro', (SELECT category_id FROM dim_category WHERE category_name = 'Computers'), 'TechBrand', 999.99),
    ('Wireless Mouse', (SELECT category_id FROM dim_category WHERE category_name = 'Accessories'), 'TechBrand', 29.99),
    ('Office Chair', (SELECT category_id FROM dim_category WHERE category_name = 'Chairs'), 'ComfortBrand', 199.99)
ON CONFLICT DO NOTHING;

-- 3. æŸ¥è¯¢ç¤ºä¾‹ï¼ˆéœ€è¦å¤šè¡¨JOINï¼‰
SELECT
    d.department_name,
    c.category_name,
    p.product_name,
    p.unit_price
FROM dim_product p
JOIN dim_category c ON p.category_id = c.category_id
JOIN dim_department d ON c.department_id = d.department_id
ORDER BY d.department_name, c.category_name;
```

### 4.2 é›ªèŠ±å‹æ¨¡å¼ä¼˜åŠ¿

- æ•°æ®è§„èŒƒåŒ–
- å­˜å‚¨ç©ºé—´èŠ‚çœ
- é€‚åˆå¤æ‚ç»´åº¦

### 4.3 é›ªèŠ±å‹æ¨¡å¼åŠ£åŠ¿

- JOINå¤šï¼ŒæŸ¥è¯¢è¾ƒæ…¢
- è®¾è®¡å¤æ‚
- ç»´æŠ¤æˆæœ¬é«˜

---

## 5. äº‹å®è¡¨è®¾è®¡

### 5.1 äº‹å®è¡¨ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| --- | --- | --- |
| **äº‹åŠ¡äº‹å®è¡¨** | è®°å½•æ¯ä¸ªäº‹åŠ¡ | é”€å”®è®¢å• |
| **å¿«ç…§äº‹å®è¡¨** | å®šæœŸå¿«ç…§ | åº“å­˜å¿«ç…§ |
| **ç´¯ç§¯äº‹å®è¡¨** | ç´¯ç§¯åº¦é‡ | è´¦æˆ·ä½™é¢ |

### 5.2 äº‹å®è¡¨è®¾è®¡åŸåˆ™

```sql
-- 1. é€‰æ‹©åˆé€‚çš„äº‹å®è¡¨ç±»å‹
-- 2. ç¡®å®šç²’åº¦ï¼ˆæœ€ç»†ç²’åº¦ï¼‰
-- 3. é€‰æ‹©åº¦é‡ï¼ˆå¯åŠ æ€§ã€åŠå¯åŠ æ€§ã€ä¸å¯åŠ æ€§ï¼‰
-- 4. æ·»åŠ é€€åŒ–ç»´åº¦ï¼ˆå¦‚è®¢å•å·ï¼‰
-- 5. ä½¿ç”¨ä»£ç†é”®

CREATE TABLE fact_sales (
    -- ä»£ç†é”®
    sales_key BIGSERIAL PRIMARY KEY,
    -- æ—¶é—´ç»´åº¦é”®
    time_id INT NOT NULL,
    -- äº§å“ç»´åº¦é”®
    product_id INT NOT NULL,
    -- å®¢æˆ·ç»´åº¦é”®
    customer_id INT NOT NULL,
    -- åº¦é‡ï¼ˆå¯åŠ æ€§ï¼‰
    sales_amount NUMERIC(12,2) NOT NULL,
    quantity INT NOT NULL,
    -- åº¦é‡ï¼ˆåŠå¯åŠ æ€§ï¼‰
    inventory_level INT,
    -- é€€åŒ–ç»´åº¦
    order_number TEXT
);
```

---

## 6. ç»´åº¦è¡¨è®¾è®¡

### 6.1 ç»´åº¦è¡¨è®¾è®¡åŸåˆ™

```sql
-- 1. ä½¿ç”¨ä»£ç†é”®
-- 2. åŒ…å«è‡ªç„¶é”®ï¼ˆä¸šåŠ¡é”®ï¼‰
-- 3. æ·»åŠ ç¼“æ…¢å˜åŒ–ç»´åº¦å¤„ç†
-- 4. åŒ…å«å±‚æ¬¡ç»“æ„

CREATE TABLE dim_customer (
    -- ä»£ç†é”®
    customer_key INT PRIMARY KEY,
    -- è‡ªç„¶é”®
    customer_id INT UNIQUE NOT NULL,
    -- å±æ€§
    customer_name TEXT,
    -- å±‚æ¬¡ç»“æ„
    region_name TEXT,
    country_name TEXT,
    -- SCDå¤„ç†
    effective_date DATE,
    expiry_date DATE,
    is_current BOOLEAN DEFAULT TRUE
);
```

### 6.2 ç¼“æ…¢å˜åŒ–ç»´åº¦ï¼ˆSCDï¼‰

- **SCD Type 1** - è¦†ç›–å†å²å€¼
- **SCD Type 2** - ä¿ç•™å†å²ç‰ˆæœ¬
- **SCD Type 3** - ä¿ç•™æœ‰é™å†å²

---

## 7. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **é€‰æ‹©åˆé€‚çš„æ¨¡å¼** - å¤§å¤šæ•°åœºæ™¯ä½¿ç”¨æ˜Ÿå‹æ¨¡å¼
2. **ç¡®å®šæ­£ç¡®ç²’åº¦** - é€‰æ‹©æœ€ç»†ç²’åº¦
3. **ä½¿ç”¨ä»£ç†é”®** - æé«˜æ€§èƒ½å’Œç»´æŠ¤æ€§
4. **åˆç†åˆ†åŒº** - æŒ‰æ—¶é—´åˆ†åŒºäº‹å®è¡¨
5. **ä½¿ç”¨ç‰©åŒ–è§†å›¾** - é¢„è®¡ç®—å¸¸ç”¨èšåˆ

### âŒ é¿å…åšæ³•

1. **è¿‡åº¦è§„èŒƒåŒ–** - é¿å…è¿‡åº¦ä½¿ç”¨é›ªèŠ±å‹æ¨¡å¼
2. **ç²’åº¦ä¸å½“** - ç²’åº¦å¤ªç²—æˆ–å¤ªç»†éƒ½ä¸å¥½
3. **ä¸ä½¿ç”¨ç´¢å¼•** - ç»´åº¦è¡¨å¿…é¡»æœ‰ç´¢å¼•
4. **å¿½ç•¥SCD** - éœ€è¦å¤„ç†ç»´åº¦å˜åŒ–

---

## 8. æ•°æ®ä»“åº“å®æ–½æ­¥éª¤

### 8.1 éœ€æ±‚åˆ†æ

```sql
-- éœ€æ±‚åˆ†ææ­¥éª¤ï¼š
-- 1. è¯†åˆ«ä¸šåŠ¡éœ€æ±‚
-- 2. ç¡®å®šæ•°æ®æº
-- 3. å®šä¹‰åº¦é‡ï¼ˆKPIï¼‰
-- 4. ç¡®å®šç»´åº¦
-- 5. ç¡®å®šç²’åº¦

-- ç¤ºä¾‹ï¼šé”€å”®æ•°æ®ä»“åº“éœ€æ±‚
-- åº¦é‡ï¼šé”€å”®é¢ã€æ•°é‡ã€åˆ©æ¶¦
-- ç»´åº¦ï¼šæ—¶é—´ã€äº§å“ã€å®¢æˆ·ã€åœ°åŒº
-- ç²’åº¦ï¼šæ¯ä¸ªè®¢å•è¡Œ
```

### 8.2 æ•°æ®æ¨¡å‹è®¾è®¡

```sql
-- æ•°æ®æ¨¡å‹è®¾è®¡æ­¥éª¤ï¼š
-- 1. è®¾è®¡äº‹å®è¡¨ç»“æ„
-- 2. è®¾è®¡ç»´åº¦è¡¨ç»“æ„
-- 3. ç¡®å®šå…³ç³»
-- 4. è®¾è®¡ç´¢å¼•
-- 5. è®¾è®¡åˆ†åŒºç­–ç•¥

-- åˆ›å»ºäº‹å®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE TABLE IF NOT EXISTS fact_sales (
    sales_key BIGSERIAL PRIMARY KEY,
    time_id INT NOT NULL REFERENCES dim_time(time_id),
    product_id INT NOT NULL REFERENCES dim_product(product_id),
    customer_id INT NOT NULL REFERENCES dim_customer(customer_id),
    store_id INT NOT NULL REFERENCES dim_store(store_id),
    sales_amount NUMERIC(12,2) NOT NULL,
    quantity INT NOT NULL,
    profit_amount NUMERIC(12,2),
    discount_amount NUMERIC(12,2),
    order_number TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY RANGE (time_id);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_fact_sales_time ON fact_sales (time_id);
CREATE INDEX idx_fact_sales_product ON fact_sales (product_id);
CREATE INDEX idx_fact_sales_customer ON fact_sales (customer_id);
CREATE INDEX idx_fact_sales_store ON fact_sales (store_id);
```

### 8.3 ç»´åº¦è¡¨å®æ–½

```sql
-- æ—¶é—´ç»´åº¦è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE TABLE IF NOT EXISTS dim_time (
    time_id INT PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    year INT NOT NULL,
    quarter INT NOT NULL,
    month INT NOT NULL,
    week INT NOT NULL,
    day_of_week INT NOT NULL,
    day_of_month INT NOT NULL,
    is_weekend BOOLEAN NOT NULL,
    is_holiday BOOLEAN DEFAULT FALSE,
    fiscal_year INT,
    fiscal_quarter INT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_dim_time_date ON dim_time (date);
CREATE INDEX idx_dim_time_year_month ON dim_time (year, month);

-- å¡«å……æ—¶é—´ç»´åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION populate_time_dimension(
    p_start_date DATE,
    p_end_date DATE
)
RETURNS TABLE (
    inserted_count BIGINT
) AS $$
DECLARE
    current_date DATE;
    inserted_rows BIGINT;
BEGIN
    current_date := p_start_date;

    WHILE current_date <= p_end_date LOOP
        INSERT INTO dim_time (
            time_id,
            date,
            year,
            quarter,
            month,
            week,
            day_of_week,
            day_of_month,
            is_weekend,
            fiscal_year,
            fiscal_quarter
        )
        VALUES (
            to_char(current_date, 'YYYYMMDD')::INT,
            current_date,
            EXTRACT(YEAR FROM current_date),
            EXTRACT(QUARTER FROM current_date),
            EXTRACT(MONTH FROM current_date),
            EXTRACT(WEEK FROM current_date),
            EXTRACT(DOW FROM current_date),
            EXTRACT(DAY FROM current_date),
            EXTRACT(DOW FROM current_date) IN (0, 6),
            EXTRACT(YEAR FROM current_date),
            EXTRACT(QUARTER FROM current_date)
        )
        ON CONFLICT (date) DO NOTHING;

        current_date := current_date + INTERVAL '1 day';
    END LOOP;

    GET DIAGNOSTICS inserted_rows = ROW_COUNT;

    RETURN QUERY SELECT inserted_rows;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¡«å……æ—¶é—´ç»´åº¦å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œå¡«å……
SELECT * FROM populate_time_dimension('2020-01-01', '2030-12-31');
```

---

## 9. æ•°æ®ä»“åº“æ€§èƒ½ä¼˜åŒ–

### 9.1 åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºäº‹å®è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE TABLE fact_sales_2024_01 PARTITION OF fact_sales
FOR VALUES FROM (20240101) TO (20240201);

CREATE TABLE fact_sales_2024_02 PARTITION OF fact_sales
FOR VALUES FROM (20240201) TO (20240301);

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE OR REPLACE FUNCTION create_fact_partitions(
    p_start_month DATE,
    p_month_count INT DEFAULT 12
)
RETURNS TABLE (
    partition_name TEXT,
    status TEXT
) AS $$
DECLARE
    i INT;
    partition_date DATE;
    partition_name TEXT;
    start_id INT;
    end_id INT;
BEGIN
    FOR i IN 0..p_month_count - 1 LOOP
        partition_date := date_trunc('month', p_start_month) + (i || ' months')::INTERVAL;
        partition_name := 'fact_sales_' || to_char(partition_date, 'YYYY_MM');
        start_id := to_char(partition_date, 'YYYYMMDD')::INT;
        end_id := to_char(partition_date + INTERVAL '1 month', 'YYYYMMDD')::INT;

        BEGIN
            EXECUTE format(
                'CREATE TABLE IF NOT EXISTS %I PARTITION OF fact_sales FOR VALUES FROM (%s) TO (%s)',
                partition_name,
                start_id,
                end_id
            );

            RETURN QUERY SELECT partition_name, 'CREATED'::TEXT;

        EXCEPTION
            WHEN duplicate_table THEN
                RETURN QUERY SELECT partition_name, 'EXISTS'::TEXT;
            WHEN OTHERS THEN
                RETURN QUERY SELECT partition_name, format('FAILED: %', SQLERRM)::TEXT;
        END;
    END LOOP;

    RETURN;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œåˆ›å»ºåˆ†åŒº
SELECT * FROM create_fact_partitions('2024-01-01', 12);
```

### 9.2 ç‰©åŒ–è§†å›¾ä¼˜åŒ–

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE MATERIALIZED VIEW IF NOT EXISTS mv_sales_summary AS
SELECT
    t.year,
    t.quarter,
    t.month,
    p.category_name,
    c.region_name,
    SUM(f.sales_amount) AS total_sales,
    SUM(f.quantity) AS total_quantity,
    SUM(f.profit_amount) AS total_profit,
    COUNT(*) AS transaction_count
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
JOIN dim_customer c ON f.customer_id = c.customer_id
GROUP BY t.year, t.quarter, t.month, p.category_name, c.region_name;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆæ”¯æŒCONCURRENTåˆ·æ–°ï¼‰
CREATE UNIQUE INDEX IF NOT EXISTS mv_sales_summary_idx ON mv_sales_summary
(year, quarter, month, category_name, region_name);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION refresh_sales_summary()
RETURNS TABLE (
    refresh_status TEXT,
    refresh_duration INTERVAL
) AS $$
DECLARE
    start_time TIMESTAMPTZ;
    end_time TIMESTAMPTZ;
BEGIN
    start_time := clock_timestamp();

    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_summary;

    end_time := clock_timestamp();

    RETURN QUERY SELECT
        'SUCCESS'::TEXT,
        end_time - start_time;

EXCEPTION
    WHEN OTHERS THEN
        RETURN QUERY SELECT
            format('FAILED: %', SQLERRM)::TEXT,
            NULL::INTERVAL;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œåˆ·æ–°
SELECT * FROM refresh_sales_summary();
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-OLAPæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–.md](../æ•°æ®ç®¡ç†æ¨¡å‹/12.02-æ•°æ®åº“æ•°æ®ä»“åº“æ¨¡å‹-OLAPæŸ¥è¯¢ä¸å¤šç»´åˆ†æçš„å½¢å¼åŒ–.md) - æ•°æ®ä»“åº“æ¨¡å‹ç†è®º
- [æ•°æ®åº“æ•°æ®é›†æˆæ¨¡å‹-ETLæµç¨‹ä¸æ•°æ®è½¬æ¢çš„å½¢å¼åŒ–.md](../æ•°æ®ç®¡ç†æ¨¡å‹/12.01-æ•°æ®åº“æ•°æ®é›†æˆæ¨¡å‹-ETLæµç¨‹ä¸æ•°æ®è½¬æ¢çš„å½¢å¼åŒ–.md) - ETLæµç¨‹ç†è®º
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
