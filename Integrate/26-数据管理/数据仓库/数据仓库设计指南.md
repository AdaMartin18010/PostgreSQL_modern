# 数据仓库设计指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [数据仓库设计指南](#数据仓库设计指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 数据仓库架构](#2-数据仓库架构)
    - [2.1 三层架构](#21-三层架构)
    - [2.2 数据流](#22-数据流)
  - [3. 星型模式设计](#3-星型模式设计)
    - [3.1 星型模式结构](#31-星型模式结构)
    - [3.2 星型模式优势](#32-星型模式优势)
  - [4. 雪花型模式设计](#4-雪花型模式设计)
    - [4.1 雪花型模式结构](#41-雪花型模式结构)
    - [4.2 雪花型模式优势](#42-雪花型模式优势)
    - [4.3 雪花型模式劣势](#43-雪花型模式劣势)
  - [5. 事实表设计](#5-事实表设计)
    - [5.1 事实表类型](#51-事实表类型)
    - [5.2 事实表设计原则](#52-事实表设计原则)
  - [6. 维度表设计](#6-维度表设计)
    - [6.1 维度表设计原则](#61-维度表设计原则)
    - [6.2 缓慢变化维度（SCD）](#62-缓慢变化维度scd)
  - [7. 最佳实践](#7-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

数据仓库设计是构建高效分析系统的基础。PostgreSQL支持完整的数据仓库功能，包括：

- **多维数据模型** - 星型模式和雪花型模式
- **OLAP查询** - GROUP BY ROLLUP、CUBE、GROUPING SETS
- **物化视图** - 预计算聚合结果
- **分区策略** - 按时间或维度分区

---

## 2. 数据仓库架构

### 2.1 三层架构

```
数据源层
  ↓
ETL层（提取、转换、加载）
  ↓
数据仓库层（星型/雪花型模式）
  ↓
OLAP层（查询和分析）
```

### 2.2 数据流

```
源系统 → ETL → 数据仓库 → OLAP查询 → 报表/分析
```

---

## 3. 星型模式设计

### 3.1 星型模式结构

```sql
-- 事实表（中心）
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    product_id INT NOT NULL,
    customer_id INT NOT NULL,
    -- 度量
    sales_amount NUMERIC(12,2),
    quantity INT,
    profit_amount NUMERIC(12,2)
);

-- 维度表（围绕事实表）
CREATE TABLE dim_time (
    time_id INT PRIMARY KEY,
    date DATE,
    year INT,
    quarter INT,
    month INT,
    week INT,
    day_of_week INT
);

CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_name TEXT,
    brand_name TEXT
);

CREATE TABLE dim_customer (
    customer_id INT PRIMARY KEY,
    customer_name TEXT,
    region_name TEXT,
    country_name TEXT
);
```

### 3.2 星型模式优势

- 查询性能好（JOIN少）
- 设计简单
- 易于理解
- 适合大多数场景

---

## 4. 雪花型模式设计

### 4.1 雪花型模式结构

```sql
-- 维度表进一步规范化
CREATE TABLE dim_product (
    product_id INT PRIMARY KEY,
    product_name TEXT,
    category_id INT REFERENCES dim_category(category_id)
);

CREATE TABLE dim_category (
    category_id INT PRIMARY KEY,
    category_name TEXT,
    department_id INT REFERENCES dim_department(department_id)
);

CREATE TABLE dim_department (
    department_id INT PRIMARY KEY,
    department_name TEXT
);
```

### 4.2 雪花型模式优势

- 数据规范化
- 存储空间节省
- 适合复杂维度

### 4.3 雪花型模式劣势

- JOIN多，查询较慢
- 设计复杂
- 维护成本高

---

## 5. 事实表设计

### 5.1 事实表类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **事务事实表** | 记录每个事务 | 销售订单 |
| **快照事实表** | 定期快照 | 库存快照 |
| **累积事实表** | 累积度量 | 账户余额 |

### 5.2 事实表设计原则

```sql
-- 1. 选择合适的事实表类型
-- 2. 确定粒度（最细粒度）
-- 3. 选择度量（可加性、半可加性、不可加性）
-- 4. 添加退化维度（如订单号）
-- 5. 使用代理键

CREATE TABLE fact_sales (
    -- 代理键
    sales_key BIGSERIAL PRIMARY KEY,
    -- 时间维度键
    time_id INT NOT NULL,
    -- 产品维度键
    product_id INT NOT NULL,
    -- 客户维度键
    customer_id INT NOT NULL,
    -- 度量（可加性）
    sales_amount NUMERIC(12,2) NOT NULL,
    quantity INT NOT NULL,
    -- 度量（半可加性）
    inventory_level INT,
    -- 退化维度
    order_number TEXT
);
```

---

## 6. 维度表设计

### 6.1 维度表设计原则

```sql
-- 1. 使用代理键
-- 2. 包含自然键（业务键）
-- 3. 添加缓慢变化维度处理
-- 4. 包含层次结构

CREATE TABLE dim_customer (
    -- 代理键
    customer_key INT PRIMARY KEY,
    -- 自然键
    customer_id INT UNIQUE NOT NULL,
    -- 属性
    customer_name TEXT,
    -- 层次结构
    region_name TEXT,
    country_name TEXT,
    -- SCD处理
    effective_date DATE,
    expiry_date DATE,
    is_current BOOLEAN DEFAULT TRUE
);
```

### 6.2 缓慢变化维度（SCD）

- **SCD Type 1** - 覆盖历史值
- **SCD Type 2** - 保留历史版本
- **SCD Type 3** - 保留有限历史

---

## 7. 最佳实践

### ✅ 推荐做法

1. **选择合适的模式** - 大多数场景使用星型模式
2. **确定正确粒度** - 选择最细粒度
3. **使用代理键** - 提高性能和维护性
4. **合理分区** - 按时间分区事实表
5. **使用物化视图** - 预计算常用聚合

### ❌ 避免做法

1. **过度规范化** - 避免过度使用雪花型模式
2. **粒度不当** - 粒度太粗或太细都不好
3. **不使用索引** - 维度表必须有索引
4. **忽略SCD** - 需要处理维度变化

---

## 📚 相关文档

- [数据库数据仓库模型-OLAP查询与多维分析的形式化.md](./数据库数据仓库模型-OLAP查询与多维分析的形式化.md) - 数据仓库模型理论
- [数据库数据集成模型-ETL流程与数据转换的形式化.md](./数据库数据集成模型-ETL流程与数据转换的形式化.md) - ETL流程理论
- [26-数据管理/README.md](../README.md) - 数据管理主题

---

**最后更新**: 2025年1月
