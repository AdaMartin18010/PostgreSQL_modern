# 数据仓库最佳实践

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [数据仓库最佳实践](#数据仓库最佳实践)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 设计最佳实践](#2-设计最佳实践)
    - [2.1 模式选择](#21-模式选择)
    - [2.2 粒度设计](#22-粒度设计)
    - [2.3 维度设计](#23-维度设计)
  - [3. 性能最佳实践](#3-性能最佳实践)
    - [3.1 索引策略](#31-索引策略)
    - [3.2 物化视图](#32-物化视图)
    - [3.3 分区策略](#33-分区策略)
  - [4. 维护最佳实践](#4-维护最佳实践)
    - [4.1 数据质量](#41-数据质量)
    - [4.2 性能监控](#42-性能监控)
    - [4.3 定期维护](#43-定期维护)
  - [5. 安全最佳实践](#5-安全最佳实践)
    - [5.1 访问控制](#51-访问控制)
    - [5.2 数据脱敏](#52-数据脱敏)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

数据仓库最佳实践是构建高效、可靠数据仓库的关键。本文档总结PostgreSQL数据仓库的最佳实践。

---

## 2. 设计最佳实践

### 2.1 模式选择

- ✅ **优先使用星型模式** - 大多数场景性能更好
- ✅ **合理使用雪花型模式** - 只在维度层次很深时使用
- ✅ **混合模式** - 部分维度星型，部分维度雪花型

### 2.2 粒度设计

- ✅ **选择最细粒度** - 支持所有分析需求
- ✅ **避免过度聚合** - 保留原始数据
- ✅ **考虑未来需求** - 粒度要足够细

### 2.3 维度设计

- ✅ **使用代理键** - 提高性能和可维护性
- ✅ **处理SCD** - 根据需求选择SCD类型
- ✅ **层次结构清晰** - 便于OLAP操作

---

## 3. 性能最佳实践

### 3.1 索引策略

```sql
-- 为所有维度键创建索引
CREATE INDEX idx_fact_sales_time ON fact_sales (time_id);
CREATE INDEX idx_fact_sales_product ON fact_sales (product_id);
CREATE INDEX idx_fact_sales_customer ON fact_sales (customer_id);

-- 为常用查询组合创建复合索引
CREATE INDEX idx_fact_sales_time_product ON fact_sales (time_id, product_id);
```

### 3.2 物化视图

```sql
-- 为常用查询创建物化视图
CREATE MATERIALIZED VIEW mv_sales_summary AS
SELECT
    t.year,
    t.quarter,
    p.category_name,
    SUM(f.sales_amount) AS total_sales
FROM fact_sales f
JOIN dim_time t ON f.time_id = t.time_id
JOIN dim_product p ON f.product_id = p.product_id
GROUP BY t.year, t.quarter, p.category_name;

-- 定期刷新
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_summary;
```

### 3.3 分区策略

```sql
-- 按时间分区事实表
CREATE TABLE fact_sales (
    time_id INT NOT NULL,
    ...
) PARTITION BY RANGE (time_id);

-- 按月分区
CREATE TABLE fact_sales_2024_01 PARTITION OF fact_sales
    FOR VALUES FROM (20240101) TO (20240201);
```

---

## 4. 维护最佳实践

### 4.1 数据质量

- ✅ **数据验证** - 在ETL阶段验证数据
- ✅ **数据清洗** - 处理NULL、重复、异常值
- ✅ **数据监控** - 监控数据质量指标

### 4.2 性能监控

```sql
-- 监控查询性能
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
WHERE query LIKE '%fact_sales%'
ORDER BY mean_exec_time DESC;
```

### 4.3 定期维护

```sql
-- 定期VACUUM
VACUUM ANALYZE fact_sales;

-- 刷新物化视图
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_sales_summary;

-- 更新统计信息
ANALYZE fact_sales;
```

---

## 5. 安全最佳实践

### 5.1 访问控制

```sql
-- 创建只读用户
CREATE USER dw_readonly WITH PASSWORD 'strong_password';
GRANT SELECT ON ALL TABLES IN SCHEMA dw TO dw_readonly;
```

### 5.2 数据脱敏

```sql
-- 对敏感数据进行脱敏
CREATE VIEW v_sales_masked AS
SELECT
    time_id,
    product_id,
    CASE
        WHEN customer_id IS NOT NULL THEN '***'
        ELSE NULL
    END AS customer_id,
    sales_amount
FROM fact_sales;
```

---

## 📚 相关文档

- [数据仓库设计指南.md](./数据仓库设计指南.md) - 数据仓库设计
- [OLAP查询优化.md](./OLAP查询优化.md) - OLAP查询优化
- [星型雪花模型.md](./星型雪花模型.md) - 模型设计
- [ETL流程设计.md](./ETL流程设计.md) - ETL流程设计
- [26-数据管理/README.md](../README.md) - 数据管理主题

---

**最后更新**: 2025年1月
