# PostgreSQL半结构化数据处理指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [PostgreSQL半结构化数据处理指南](#postgresql半结构化数据处理指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. JSON处理](#2-json处理)
    - [2.1 JSONB存储](#21-jsonb存储)
    - [2.2 JSON查询](#22-json查询)
  - [3. XML处理](#3-xml处理)
    - [3.1 XML存储](#31-xml存储)
    - [3.2 XML查询](#32-xml查询)
  - [4. 性能优化](#4-性能优化)
    - [4.1 JSONB索引](#41-jsonb索引)
    - [4.2 表达式索引](#42-表达式索引)
  - [5. 最佳实践](#5-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

PostgreSQL原生支持JSON/JSONB，可以高效处理半结构化数据。

**支持格式**:

- JSON/JSONB
- XML
- 自定义格式

---

## 2. JSON处理

### 2.1 JSONB存储

```sql
-- 创建JSONB表
CREATE TABLE json_data (
    id SERIAL PRIMARY KEY,
    data JSONB
);

-- 插入JSON数据
INSERT INTO json_data (data)
VALUES ('{"name": "test", "value": 100, "tags": ["a", "b"]}'::jsonb);
```

### 2.2 JSON查询

```sql
-- 查询JSON字段
SELECT
    data->>'name' AS name,
    (data->>'value')::INT AS value,
    data->'tags' AS tags
FROM json_data
WHERE data->>'name' = 'test';
```

---

## 3. XML处理

### 3.1 XML存储

```sql
-- 创建XML表
CREATE TABLE xml_data (
    id SERIAL PRIMARY KEY,
    data XML
);

-- 插入XML数据
INSERT INTO xml_data (data)
VALUES ('<root><name>test</name><value>100</value></root>'::xml);
```

### 3.2 XML查询

```sql
-- 查询XML数据
SELECT
    (xpath('/root/name/text()', data))[1]::TEXT AS name,
    (xpath('/root/value/text()', data))[1]::TEXT AS value
FROM xml_data;
```

---

## 4. 性能优化

### 4.1 JSONB索引

```sql
-- GIN索引
CREATE INDEX idx_json_data ON json_data USING GIN (data);

-- 查询优化
SELECT * FROM json_data
WHERE data @> '{"name": "test"}'::jsonb;
```

### 4.2 表达式索引

```sql
-- 为常用字段创建索引
CREATE INDEX idx_json_name ON json_data ((data->>'name'));
```

---

## 5. 最佳实践

### ✅ 推荐做法

1. **使用JSONB** - 性能更好
2. **创建索引** - 提高查询性能
3. **规范化数据** - 减少嵌套层级
4. **使用约束** - 验证数据格式

---

## 📚 相关文档

- [数据湖完整指南.md](./数据湖完整指南.md) - 数据湖完整指南
- [元数据管理.md](./元数据管理.md) - 元数据管理详解
- [26-数据管理/README.md](../README.md) - 数据管理主题

---

**最后更新**: 2025年1月
