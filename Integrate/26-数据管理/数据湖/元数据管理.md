# PostgreSQLæ•°æ®æ¹–å…ƒæ•°æ®ç®¡ç†æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­ ä¸­çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ•°æ®æ¹–å…ƒæ•°æ®ç®¡ç†æŒ‡å—](#postgresqlæ•°æ®æ¹–å…ƒæ•°æ®ç®¡ç†æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å…ƒæ•°æ®æ¨¡å‹](#2-å…ƒæ•°æ®æ¨¡å‹)
    - [2.1 å…ƒæ•°æ®è¡¨](#21-å…ƒæ•°æ®è¡¨)
  - [3. å…ƒæ•°æ®å­˜å‚¨](#3-å…ƒæ•°æ®å­˜å‚¨)
    - [3.1 è‡ªåŠ¨æ”¶é›†](#31-è‡ªåŠ¨æ”¶é›†)
  - [4. å…ƒæ•°æ®æŸ¥è¯¢](#4-å…ƒæ•°æ®æŸ¥è¯¢)
    - [4.1 æ•°æ®å‘ç°](#41-æ•°æ®å‘ç°)
    - [4.2 æ•°æ®è¡€ç¼˜](#42-æ•°æ®è¡€ç¼˜)
  - [5. å…ƒæ•°æ®ç»´æŠ¤](#5-å…ƒæ•°æ®ç»´æŠ¤)
    - [5.1 å®šæœŸæ›´æ–°](#51-å®šæœŸæ›´æ–°)
    - [5.2 å…ƒæ•°æ®éªŒè¯](#52-å…ƒæ•°æ®éªŒè¯)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å…ƒæ•°æ®ç®¡ç†æ˜¯æ•°æ®æ¹–ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæä¾›æ•°æ®ç›®å½•å’Œå‘ç°åŠŸèƒ½ã€‚

**å…ƒæ•°æ®å†…å®¹**:

- æ•°æ®æºä¿¡æ¯
- æ•°æ®æ ¼å¼
- æ•°æ®æ¨¡å¼
- æ•°æ®è¡€ç¼˜

---

## 2. å…ƒæ•°æ®æ¨¡å‹

### 2.1 å…ƒæ•°æ®è¡¨

```sql
-- æ•°æ®æºå…ƒæ•°æ®
CREATE TABLE data_source_metadata (
    id SERIAL PRIMARY KEY,
    source_name TEXT NOT NULL,
    source_type TEXT,
    location TEXT,
    format TEXT,
    schema_info JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ•°æ®è¡¨å…ƒæ•°æ®
CREATE TABLE table_metadata (
    id SERIAL PRIMARY KEY,
    table_name TEXT NOT NULL,
    source_id INT REFERENCES data_source_metadata(id),
    columns JSONB,
    row_count BIGINT,
    size_bytes BIGINT,
    last_updated TIMESTAMPTZ
);
```

---

## 3. å…ƒæ•°æ®å­˜å‚¨

### 3.1 è‡ªåŠ¨æ”¶é›†

```sql
-- è‡ªåŠ¨æ”¶é›†è¡¨å…ƒæ•°æ®
CREATE OR REPLACE FUNCTION collect_table_metadata()
RETURNS VOID AS $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN
        SELECT
            schemaname,
            tablename,
            pg_total_relation_size(schemaname||'.'||tablename) AS size
        FROM pg_tables
        WHERE schemaname = 'public'
    LOOP
        INSERT INTO table_metadata (table_name, size_bytes)
        VALUES (r.tablename, r.size)
        ON CONFLICT (table_name) DO UPDATE
        SET size_bytes = r.size, last_updated = NOW();
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. å…ƒæ•°æ®æŸ¥è¯¢

### 4.1 æ•°æ®å‘ç°

```sql
-- æŸ¥æ‰¾æ•°æ®è¡¨
SELECT
    table_name,
    columns,
    row_count,
    size_bytes
FROM table_metadata
WHERE columns @> '[{"name": "user_id"}]'::jsonb;
```

### 4.2 æ•°æ®è¡€ç¼˜

```sql
-- æ•°æ®è¡€ç¼˜æŸ¥è¯¢
SELECT
    source_table,
    target_table,
    transformation
FROM data_lineage
WHERE source_table = 'users';
```

---

## 5. å…ƒæ•°æ®ç»´æŠ¤

### 5.1 å®šæœŸæ›´æ–°

```sql
-- å®šæœŸæ›´æ–°å…ƒæ•°æ®
SELECT cron.schedule(
    'update-metadata',
    '0 2 * * *',
    'SELECT collect_table_metadata();'
);
```

### 5.2 å…ƒæ•°æ®éªŒè¯

```sql
-- éªŒè¯å…ƒæ•°æ®ä¸€è‡´æ€§
SELECT
    table_name,
    CASE
        WHEN row_count != (SELECT COUNT(*) FROM table_name)
        THEN 'ä¸ä¸€è‡´'
        ELSE 'ä¸€è‡´'
    END AS status
FROM table_metadata;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¹–å®Œæ•´æŒ‡å—.md](./æ•°æ®æ¹–å®Œæ•´æŒ‡å—.md) - æ•°æ®æ¹–å®Œæ•´æŒ‡å—
- [æ•°æ®æ¹–æ¶æ„è®¾è®¡.md](./æ•°æ®æ¹–æ¶æ„è®¾è®¡.md) - æ•°æ®æ¹–æ¶æ„è®¾è®¡
- [26-æ•°æ®ç®¡ç†/README.md](../README.md) - æ•°æ®ç®¡ç†ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
