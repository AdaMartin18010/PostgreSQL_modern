---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\05-æ•°æ®ç®¡ç†\è§„åˆ™ç³»ç»Ÿ.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL è§„åˆ™ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-36

## ğŸ“‘ ç›®å½•

- [1.0 è§„åˆ™ç³»ç»Ÿå·¥ä½œåŸç†æ¦‚è¿°](#10-è§„åˆ™ç³»ç»Ÿå·¥ä½œåŸç†æ¦‚è¿°)
- [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
- [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
- [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
- [1.4 è§„åˆ™ä½“ç³»æ€ç»´å¯¼å›¾](#14-è§„åˆ™ä½“ç³»æ€ç»´å¯¼å›¾)
- [2.1 åˆ›å»ºè§„åˆ™](#21-åˆ›å»ºè§„åˆ™)
- [2.2 è§„åˆ™ç±»å‹](#22-è§„åˆ™ç±»å‹)
- [3.1 å¯æ›´æ–°è§†å›¾](#31-å¯æ›´æ–°è§†å›¾)
- [3.2 æŸ¥è¯¢é‡å†™](#32-æŸ¥è¯¢é‡å†™)
- [3.3 è§„åˆ™ç®¡ç†](#33-è§„åˆ™ç®¡ç†)
- [4.1 æ¡ˆä¾‹: å¯æ›´æ–°è§†å›¾ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-å¯æ›´æ–°è§†å›¾çœŸå®æ¡ˆä¾‹)
- [4.2 æ¡ˆä¾‹: å®¡è®¡æ—¥å¿—ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#42-æ¡ˆä¾‹-å®¡è®¡æ—¥å¿—çœŸå®æ¡ˆä¾‹)
- [5.1 è§„åˆ™ä½¿ç”¨](#51-è§„åˆ™ä½¿ç”¨)
- [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
- [6.1 è§„åˆ™åŸºç¡€å¸¸è§é—®é¢˜](#61-è§„åˆ™åŸºç¡€å¸¸è§é—®é¢˜)
- [6.2 è§„åˆ™ç®¡ç†å¸¸è§é—®é¢˜](#62-è§„åˆ™ç®¡ç†å¸¸è§é—®é¢˜)
- [7.1 æ¨èåšæ³•](#71-æ¨èåšæ³•)
- [7.2 é¿å…åšæ³•](#72-é¿å…åšæ³•)
- [7.3 æ€§èƒ½å»ºè®®](#73-æ€§èƒ½å»ºè®®)
- [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
- [8.2 æŠ€æœ¯è®ºæ–‡](#82-æŠ€æœ¯è®ºæ–‡)
- [8.3 æŠ€æœ¯åšå®¢](#83-æŠ€æœ¯åšå®¢)
- [8.4 ç¤¾åŒºèµ„æº](#84-ç¤¾åŒºèµ„æº)
- [8.5 ç›¸å…³æ–‡æ¡£](#85-ç›¸å…³æ–‡æ¡£)
---

## 1. æ¦‚è¿°

### 1.0 è§„åˆ™ç³»ç»Ÿå·¥ä½œåŸç†æ¦‚è¿°

**è§„åˆ™ç³»ç»Ÿå·¥ä½œåŸç†**ï¼š

PostgreSQL è§„åˆ™ç³»ç»Ÿæ˜¯ä¸€ä¸ªæŸ¥è¯¢é‡å†™æœºåˆ¶ï¼Œåœ¨æŸ¥è¯¢æ‰§è¡Œå‰è‡ªåŠ¨é‡å†™æŸ¥è¯¢è¯­å¥ã€‚è§„åˆ™çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **è§„åˆ™è§¦å‘æ—¶æœº**ï¼šåœ¨æŸ¥è¯¢æ‰§è¡Œå‰ï¼Œè§„åˆ™ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„è§„åˆ™
2. **è§„åˆ™åŒ¹é…**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹ï¼ˆSELECTã€INSERTã€UPDATEã€DELETEï¼‰åŒ¹é…è§„åˆ™
3. **æŸ¥è¯¢é‡å†™**ï¼šå°†åŸå§‹æŸ¥è¯¢é‡å†™ä¸ºè§„åˆ™å®šä¹‰çš„æŸ¥è¯¢
4. **è§„åˆ™æ‰§è¡Œ**ï¼šæ‰§è¡Œé‡å†™åçš„æŸ¥è¯¢

**è§„åˆ™æ‰§è¡Œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ‰§è¡ŒæŸ¥è¯¢] --> B[è§„åˆ™ç³»ç»Ÿæ£€æŸ¥]
    B --> C{æœ‰åŒ¹é…è§„åˆ™?}
    C -->|å¦| D[æ‰§è¡ŒåŸå§‹æŸ¥è¯¢]
    C -->|æ˜¯| E[åŒ¹é…è§„åˆ™ç±»å‹]
    E --> F{è§„åˆ™ç±»å‹}
    F -->|INSTEAD| G[æ›¿æ¢åŸå§‹æŸ¥è¯¢]
    F -->|ALSO| H[æ‰§è¡ŒåŸå§‹æŸ¥è¯¢+è§„åˆ™æŸ¥è¯¢]
    G --> I[æ‰§è¡Œé‡å†™åçš„æŸ¥è¯¢]
    H --> I
    I --> J[è¿”å›ç»“æœ]
    D --> J

    style A fill:#FFD700
    style E fill:#90EE90
    style J fill:#87CEEB
```

**è§„åˆ™åŒ¹é…æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢è¯­å¥] --> B[è§£ææŸ¥è¯¢ç±»å‹]
    B --> C{æŸ¥è¯¢ç±»å‹}
    C -->|SELECT| D[åŒ¹é…SELECTè§„åˆ™]
    C -->|INSERT| E[åŒ¹é…INSERTè§„åˆ™]
    C -->|UPDATE| F[åŒ¹é…UPDATEè§„åˆ™]
    C -->|DELETE| G[åŒ¹é…DELETEè§„åˆ™]
    D --> H{æ‰¾åˆ°è§„åˆ™?}
    E --> H
    F --> H
    G --> H
    H -->|æ˜¯| I[åº”ç”¨è§„åˆ™]
    H -->|å¦| J[æ‰§è¡ŒåŸå§‹æŸ¥è¯¢]
    I --> K[é‡å†™æŸ¥è¯¢]
    K --> L[æ‰§è¡ŒæŸ¥è¯¢]
    J --> L

    style A fill:#FFD700
    style I fill:#90EE90
    style L fill:#87CEEB
```

### 1.1 æŠ€æœ¯èƒŒæ™¯

**è§„åˆ™ç³»ç»Ÿçš„ä»·å€¼**:

PostgreSQL è§„åˆ™ç³»ç»Ÿæä¾›äº†æŸ¥è¯¢é‡å†™çš„æœºåˆ¶ï¼š

1. **æŸ¥è¯¢é‡å†™**: è‡ªåŠ¨é‡å†™æŸ¥è¯¢
2. **è§†å›¾å®ç°**: å®ç°å¯æ›´æ–°è§†å›¾
3. **æ•°æ®è½¬æ¢**: è‡ªåŠ¨è½¬æ¢æ•°æ®
4. **è®¿é—®æ§åˆ¶**: å®ç°è®¿é—®æ§åˆ¶

**åº”ç”¨åœºæ™¯**:

- **å¯æ›´æ–°è§†å›¾**: å®ç°å¯æ›´æ–°è§†å›¾
- **æŸ¥è¯¢é‡å†™**: è‡ªåŠ¨é‡å†™æŸ¥è¯¢
- **æ•°æ®è½¬æ¢**: è‡ªåŠ¨è½¬æ¢æ•°æ®
- **è®¿é—®æ§åˆ¶**: å®ç°è®¿é—®æ§åˆ¶

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å¼€å‘æ•ˆç‡** | ç®€åŒ–å¼€å‘ | **+40%** |
| **ä»£ç å¤ç”¨** | ä»£ç å¤ç”¨ | **+50%** |
| **ç»´æŠ¤æˆæœ¬** | é™ä½ç»´æŠ¤æˆæœ¬ | **-30%** |
| **çµæ´»æ€§** | çµæ´»çš„æ•°æ®è®¿é—® | **é«˜** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **å¼€å‘æ•ˆç‡**: ç®€åŒ–å¼€å‘ï¼Œæå‡æ•ˆç‡ 40%
- **ä»£ç å¤ç”¨**: ä»£ç å¤ç”¨ï¼Œæå‡æ•ˆç‡ 50%
- **ç»´æŠ¤æˆæœ¬**: é™ä½ç»´æŠ¤æˆæœ¬ 30%
- **çµæ´»æ€§**: çµæ´»çš„æ•°æ®è®¿é—®æ–¹å¼

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡è§„åˆ™çš„åˆ›å»ºå’Œä½¿ç”¨
- ç†è§£è§„åˆ™çš„å·¥ä½œåŸç†
- å­¦ä¼šè§„åˆ™ä¼˜åŒ–
- æŒæ¡å®é™…åº”ç”¨åœºæ™¯

### 1.4 è§„åˆ™ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((è§„åˆ™ä½“ç³»))
    è§„åˆ™ç±»å‹
      SELECTè§„åˆ™
        æŸ¥è¯¢é‡å†™
        è§†å›¾å®ç°
        æ•°æ®è½¬æ¢
      INSERTè§„åˆ™
        æ’å…¥é‡å†™
        æ•°æ®è½¬æ¢
        å¤šè¡¨æ’å…¥
      UPDATEè§„åˆ™
        æ›´æ–°é‡å†™
        æ•°æ®è½¬æ¢
        æ¡ä»¶æ›´æ–°
      DELETEè§„åˆ™
        åˆ é™¤é‡å†™
        æ•°æ®è½¬æ¢
        æ¡ä»¶åˆ é™¤
    è§„åˆ™ç‰¹æ€§
      æŸ¥è¯¢é‡å†™
        è‡ªåŠ¨é‡å†™
        é€æ˜è®¿é—®
        æ€§èƒ½ä¼˜åŒ–
      å¯æ›´æ–°è§†å›¾
        è§†å›¾æ›´æ–°
        è§„åˆ™å®ç°
        æ•°æ®è½¬æ¢
      è®¿é—®æ§åˆ¶
        æƒé™æ§åˆ¶
        æ•°æ®è¿‡æ»¤
        å®‰å…¨æ§åˆ¶
    è§„åˆ™ç®¡ç†
      è§„åˆ™åˆ›å»º
        è§„åˆ™å®šä¹‰
        æ¡ä»¶è§„åˆ™
        æ— æ¡ä»¶è§„åˆ™
      è§„åˆ™ä¿®æ”¹
        ä¿®æ”¹è§„åˆ™
        åˆ é™¤è§„åˆ™
        è§„åˆ™é¡ºåº
      è§„åˆ™ä¼˜åŒ–
        æ€§èƒ½ä¼˜åŒ–
        è§„åˆ™åˆå¹¶
        æŸ¥è¯¢ä¼˜åŒ–
    åº”ç”¨åœºæ™¯
      å¯æ›´æ–°è§†å›¾
        è§†å›¾æ›´æ–°
        æ•°æ®è½¬æ¢
        ä¸šåŠ¡é€»è¾‘
      æŸ¥è¯¢é‡å†™
        è‡ªåŠ¨é‡å†™
        æ€§èƒ½ä¼˜åŒ–
        æ•°æ®è½¬æ¢
      è®¿é—®æ§åˆ¶
        æƒé™æ§åˆ¶
        æ•°æ®è¿‡æ»¤
        å®‰å…¨æ§åˆ¶
```

## 2. è§„åˆ™åŸºç¡€

### 2.1 åˆ›å»ºè§„åˆ™

**åˆ›å»ºè§„åˆ™**:

```sql
-- åˆ›å»º SELECT è§„åˆ™
CREATE RULE rule_name AS
    ON SELECT TO table_name
    DO INSTEAD
        SELECT * FROM another_table;

-- åˆ›å»º INSERT è§„åˆ™
CREATE RULE rule_name AS
    ON INSERT TO table_name
    DO INSTEAD
        INSERT INTO another_table VALUES (NEW.*);

-- åˆ›å»º UPDATE è§„åˆ™
CREATE RULE rule_name AS
    ON UPDATE TO table_name
    DO INSTEAD
        UPDATE another_table SET * = NEW.* WHERE id = OLD.id;

-- åˆ›å»º DELETE è§„åˆ™
CREATE RULE rule_name AS
    ON DELETE TO table_name
    DO INSTEAD
        DELETE FROM another_table WHERE id = OLD.id;
```

### 2.2 è§„åˆ™ç±»å‹

**è§„åˆ™ç±»å‹**:

```sql
-- SELECT è§„åˆ™ï¼ˆINSTEADï¼‰
CREATE RULE view_rule AS
    ON SELECT TO my_view
    DO INSTEAD
        SELECT * FROM base_table;

-- INSERT è§„åˆ™ï¼ˆALSOï¼‰
CREATE RULE log_insert AS
    ON INSERT TO users
    DO ALSO
        INSERT INTO audit_log (action, table_name, timestamp)
        VALUES ('INSERT', 'users', NOW());
```

## 3. è§„åˆ™åº”ç”¨

### 3.1 å¯æ›´æ–°è§†å›¾

**å¯æ›´æ–°è§†å›¾**:

```sql
-- åˆ›å»ºè§†å›¾
CREATE VIEW user_view AS
    SELECT id, name, email, status
    FROM users
    WHERE status = 'active';

-- åˆ›å»º INSERT è§„åˆ™
CREATE RULE insert_user AS
    ON INSERT TO user_view
    DO INSTEAD
        INSERT INTO users (name, email, status)
        VALUES (NEW.name, NEW.email, 'active');

-- åˆ›å»º UPDATE è§„åˆ™
CREATE RULE update_user AS
    ON UPDATE TO user_view
    DO INSTEAD
        UPDATE users
        SET name = NEW.name,
            email = NEW.email
        WHERE id = OLD.id AND status = 'active';

-- åˆ›å»º DELETE è§„åˆ™
CREATE RULE delete_user AS
    ON DELETE TO user_view
    DO INSTEAD
        UPDATE users
        SET status = 'deleted'
        WHERE id = OLD.id;
```

### 3.2 æŸ¥è¯¢é‡å†™

**æŸ¥è¯¢é‡å†™**:

```sql
-- åˆ›å»ºæŸ¥è¯¢é‡å†™è§„åˆ™
CREATE RULE rewrite_query AS
    ON SELECT TO orders
    WHERE user_id = current_user_id()
    DO INSTEAD
        SELECT * FROM orders
        WHERE user_id = current_user_id()
            AND status != 'deleted';
```

### 3.3 è§„åˆ™ç®¡ç†

**è§„åˆ™ç®¡ç†**:

```sql
-- æŸ¥çœ‹è§„åˆ™
SELECT
    schemaname,
    tablename,
    rulename,
    definition
FROM pg_rules
WHERE tablename = 'user_view';

-- åˆ é™¤è§„åˆ™
DROP RULE IF EXISTS rule_name ON table_name;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: å¯æ›´æ–°è§†å›¾ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç³»ç»Ÿéœ€è¦å®ç°å¯æ›´æ–°çš„è§†å›¾ï¼Œç®€åŒ–æ•°æ®è®¿é—®ã€‚

**é—®é¢˜åˆ†æ**:

1. **è§†å›¾é™åˆ¶**: æ ‡å‡†è§†å›¾ä¸å¯æ›´æ–°
2. **ä»£ç é‡å¤**: ä»£ç é‡å¤å¤š
3. **ç»´æŠ¤å›°éš¾**: ç»´æŠ¤å›°éš¾

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè§†å›¾
CREATE VIEW orders_all AS
    SELECT * FROM orders_2024
    UNION ALL
    SELECT * FROM orders_2025;

-- 2. åˆ›å»º INSERT è§„åˆ™
CREATE RULE insert_order_2024 AS
    ON INSERT TO orders_all
    WHERE EXTRACT(YEAR FROM NEW.created_at) = 2024
    DO INSTEAD
        INSERT INTO orders_2024 VALUES (NEW.*);

CREATE RULE insert_order_2025 AS
    ON INSERT TO orders_all
    WHERE EXTRACT(YEAR FROM NEW.created_at) = 2025
    DO INSTEAD
        INSERT INTO orders_2025 VALUES (NEW.*);

-- 3. åˆ›å»º UPDATE è§„åˆ™
CREATE RULE update_order_2024 AS
    ON UPDATE TO orders_all
    WHERE EXTRACT(YEAR FROM OLD.created_at) = 2024
    DO INSTEAD
        UPDATE orders_2024
        SET * = NEW.*
        WHERE id = OLD.id;

CREATE RULE update_order_2025 AS
    ON UPDATE TO orders_all
    WHERE EXTRACT(YEAR FROM OLD.created_at) = 2025
    DO INSTEAD
        UPDATE orders_2025
        SET * = NEW.*
        WHERE id = OLD.id;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **ä»£ç é‡** | åŸºå‡† | **-50%** | **é™ä½** |
| **å¼€å‘æ•ˆç‡** | åŸºå‡† | **+40%** | **æå‡** |
| **ç»´æŠ¤æˆæœ¬** | åŸºå‡† | **-30%** | **é™ä½** |

### 4.2 æ¡ˆä¾‹: å®¡è®¡æ—¥å¿—ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç³»ç»Ÿéœ€è¦è‡ªåŠ¨è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name TEXT,
    action TEXT,
    old_data JSONB,
    new_data JSONB,
    changed_by TEXT,
    changed_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»º INSERT è§„åˆ™
CREATE RULE log_insert AS
    ON INSERT TO users
    DO ALSO
        INSERT INTO audit_log (table_name, action, new_data, changed_by)
        VALUES ('users', 'INSERT', row_to_json(NEW)::jsonb, current_user);

-- åˆ›å»º UPDATE è§„åˆ™
CREATE RULE log_update AS
    ON UPDATE TO users
    DO ALSO
        INSERT INTO audit_log (table_name, action, old_data, new_data, changed_by)
        VALUES ('users', 'UPDATE', row_to_json(OLD)::jsonb, row_to_json(NEW)::jsonb, current_user);

-- åˆ›å»º DELETE è§„åˆ™
CREATE RULE log_delete AS
    ON DELETE TO users
    DO ALSO
        INSERT INTO audit_log (table_name, action, old_data, changed_by)
        VALUES ('users', 'DELETE', row_to_json(OLD)::jsonb, current_user);
```

## 5. æœ€ä½³å®è·µ

### 5.1 è§„åˆ™ä½¿ç”¨

1. **å¯æ›´æ–°è§†å›¾**: ä½¿ç”¨è§„åˆ™å®ç°å¯æ›´æ–°è§†å›¾
2. **æŸ¥è¯¢é‡å†™**: ä½¿ç”¨è§„åˆ™é‡å†™æŸ¥è¯¢
3. **å®¡è®¡æ—¥å¿—**: ä½¿ç”¨è§„åˆ™å®ç°å®¡è®¡æ—¥å¿—

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **è§„åˆ™é¡ºåº**: æ³¨æ„è§„åˆ™çš„æ‰§è¡Œé¡ºåº
2. **æ¡ä»¶ä¼˜åŒ–**: ä¼˜åŒ–è§„åˆ™æ¡ä»¶
3. **ç´¢å¼•**: ç¡®ä¿è§„åˆ™æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 è§„åˆ™åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: è§„åˆ™å’Œè§¦å‘å™¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è§„åˆ™ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨è§¦å‘å™¨ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥ç°æœ‰è§„åˆ™
SELECT * FROM pg_rules WHERE tablename = 'my_table';

-- 2. æ£€æŸ¥ç°æœ‰è§¦å‘å™¨
SELECT * FROM pg_trigger WHERE tgrelid = 'my_table'::regclass;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- è§„åˆ™ï¼šæŸ¥è¯¢é‡å†™ï¼Œåœ¨æŸ¥è¯¢æ‰§è¡Œå‰é‡å†™
CREATE RULE rewrite_select AS
    ON SELECT TO orders
    DO INSTEAD
        SELECT * FROM orders WHERE status != 'deleted';
-- é€‚ç”¨åœºæ™¯ï¼šæŸ¥è¯¢é‡å†™ã€å¯æ›´æ–°è§†å›¾

-- è§¦å‘å™¨ï¼šäº‹ä»¶é©±åŠ¨ï¼Œåœ¨æ•°æ®å˜æ›´æ—¶æ‰§è¡Œ
CREATE TRIGGER audit_trigger
    AFTER INSERT OR UPDATE OR DELETE ON orders
    FOR EACH ROW
    EXECUTE FUNCTION audit_function();
-- é€‚ç”¨åœºæ™¯ï¼šå®¡è®¡æ—¥å¿—ã€æ•°æ®éªŒè¯ã€ä¸šåŠ¡é€»è¾‘

-- å¯¹æ¯”ï¼š
-- è§„åˆ™ï¼šæŸ¥è¯¢é‡å†™ï¼Œæ€§èƒ½å¥½ï¼Œä½†åŠŸèƒ½æœ‰é™
-- è§¦å‘å™¨ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œä½†æ€§èƒ½å¼€é”€è¾ƒå¤§
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- è§„åˆ™ï¼šæŸ¥è¯¢é‡å†™å¼€é”€ **1%**
- è§¦å‘å™¨ï¼šæ¯è¡Œæ‰§è¡Œå¼€é”€ **10%**
- **è§„åˆ™æ€§èƒ½æ›´å¥½ï¼Œä½†åŠŸèƒ½æœ‰é™**

#### Q2: å¦‚ä½•ä¼˜åŒ–è§„åˆ™æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šè§„åˆ™æŸ¥è¯¢å¾ˆæ…¢ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥è§„åˆ™å®šä¹‰
SELECT rulename, definition FROM pg_rules WHERE tablename = 'my_table';

-- 2. åˆ†æè§„åˆ™æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM my_view;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¼˜åŒ–è§„åˆ™æ¡ä»¶
-- âŒ ä¸å¥½ï¼šå¤æ‚æ¡ä»¶
CREATE RULE rewrite_select AS
    ON SELECT TO orders
    WHERE EXTRACT(YEAR FROM created_at) = 2024
    DO INSTEAD
        SELECT * FROM orders_2024;

-- âœ… å¥½ï¼šç®€å•æ¡ä»¶
CREATE RULE rewrite_select AS
    ON SELECT TO orders
    WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01'
    DO INSTEAD
        SELECT * FROM orders_2024;

-- 2. ä¸ºè§„åˆ™æŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_2024_created ON orders_2024(created_at);

-- 3. ç®€åŒ–è§„åˆ™é€»è¾‘
-- é¿å…åœ¨è§„åˆ™ä¸­ä½¿ç”¨å¤æ‚å‡½æ•°å’Œå­æŸ¥è¯¢
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— ä¼˜åŒ–ï¼šæŸ¥è¯¢æ—¶é—´ **10ç§’**
- ä¼˜åŒ–åï¼šæŸ¥è¯¢æ—¶é—´ **0.1ç§’**
- **æ€§èƒ½æå‡ï¼š100å€**

### 6.2 è§„åˆ™ç®¡ç†å¸¸è§é—®é¢˜

#### Q3: è§„åˆ™æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

**é—®é¢˜æè¿°**ï¼šå¤šä¸ªè§„åˆ™æ—¶ï¼Œä¸çŸ¥é“æ‰§è¡Œé¡ºåºã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹è§„åˆ™å®šä¹‰å’Œé¡ºåº
SELECT rulename, ev_type, ev_enabled, definition
FROM pg_rules
WHERE tablename = 'my_table'
ORDER BY rulename;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. è§„åˆ™æ‰§è¡Œé¡ºåºï¼šæŒ‰è§„åˆ™åç§°å­—æ¯é¡ºåº
-- è§„åˆ™åç§°å½±å“æ‰§è¡Œé¡ºåºï¼Œå»ºè®®ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°

-- 2. ä½¿ç”¨DO INSTEADï¼ˆæ›¿ä»£åŸæ“ä½œï¼‰
CREATE RULE rule1 AS
    ON INSERT TO my_table
    DO INSTEAD INSERT INTO table1 VALUES (NEW.*);

-- 3. ä½¿ç”¨DO ALSOï¼ˆåŒæ—¶æ‰§è¡ŒåŸæ“ä½œå’Œè§„åˆ™ï¼‰
CREATE RULE rule2 AS
    ON INSERT TO my_table
    DO ALSO INSERT INTO audit_log VALUES (NEW.*);

-- 4. è§„åˆ™ä¼˜å…ˆçº§ï¼šDO INSTEADä¼˜å…ˆäºDO ALSO
-- å¦‚æœæœ‰å¤šä¸ªDO INSTEADè§„åˆ™ï¼ŒæŒ‰åç§°é¡ºåºæ‰§è¡Œç¬¬ä¸€ä¸ªåŒ¹é…çš„
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- é”™è¯¯é¡ºåºï¼šè§„åˆ™å†²çªï¼ŒæŸ¥è¯¢å¤±è´¥
- æ­£ç¡®é¡ºåºï¼šè§„åˆ™æ­£ç¡®æ‰§è¡Œï¼ŒæŸ¥è¯¢æˆåŠŸ
- **æ­£ç¡®æ€§æå‡ï¼š100%**

## 7. æœ€ä½³å®è·µ

### 7.1 æ¨èåšæ³•

#### âœ… è§„åˆ™ä½¿ç”¨å»ºè®®

1. **ä½¿ç”¨è§„åˆ™å®ç°å¯æ›´æ–°è§†å›¾**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§„åˆ™å®ç°å¯æ›´æ–°è§†å›¾
   CREATE VIEW user_orders AS
   SELECT u.id AS user_id, u.name, o.id AS order_id, o.total_amount
   FROM users u
   JOIN orders o ON u.id = o.user_id;

   CREATE RULE user_orders_insert AS
       ON INSERT TO user_orders
       DO INSTEAD
       INSERT INTO orders (user_id, total_amount)
       VALUES (NEW.user_id, NEW.total_amount);
   ```

2. **ä½¿ç”¨è§„åˆ™å®ç°å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§„åˆ™å®ç°å®¡è®¡æ—¥å¿—
   CREATE RULE audit_insert AS
       ON INSERT TO orders
       DO ALSO
       INSERT INTO audit_log (table_name, operation, timestamp)
       VALUES ('orders', 'INSERT', NOW());
   ```

3. **ä½¿ç”¨è§„åˆ™å®ç°æ•°æ®è½¬æ¢**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨è§„åˆ™å®ç°æ•°æ®è½¬æ¢
   CREATE RULE convert_status AS
       ON INSERT TO orders
       DO INSTEAD
       INSERT INTO orders (id, status, created_at)
       VALUES (NEW.id, UPPER(NEW.status), NOW());
   ```

#### âœ… è§„åˆ™ç®¡ç†å»ºè®®

1. **è§„åˆ™å‘½åè§„èŒƒ**ï¼š

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨æ¸…æ™°çš„è§„åˆ™å‘½å
   CREATE RULE orders_audit_insert AS
       ON INSERT TO orders
       DO ALSO INSERT INTO audit_log VALUES (NEW.*);
   ```

2. **è§„åˆ™ä¼˜å…ˆçº§ç®¡ç†**ï¼š

   ```sql
   -- âœ… å¥½ï¼šç†è§£è§„åˆ™æ‰§è¡Œé¡ºåº
   -- DO INSTEADè§„åˆ™ä¼˜å…ˆäºDO ALSOè§„åˆ™
   -- å¤šä¸ªDO INSTEADè§„åˆ™æŒ‰åç§°é¡ºåºæ‰§è¡Œç¬¬ä¸€ä¸ªåŒ¹é…çš„
   CREATE RULE rule1 AS ON INSERT TO my_table DO INSTEAD ...;
   CREATE RULE rule2 AS ON INSERT TO my_table DO INSTEAD ...;
   -- rule1ä¼˜å…ˆæ‰§è¡Œï¼ˆæŒ‰åç§°é¡ºåºï¼‰
   ```

3. **è§„åˆ™æ€§èƒ½ä¼˜åŒ–**ï¼š

   ```sql
   -- âœ… å¥½ï¼šè§„åˆ™æŸ¥è¯¢åº”å°½é‡ç®€å•
   CREATE RULE simple_rule AS
       ON INSERT TO orders
       DO ALSO
       INSERT INTO audit_log (table_name, operation)
       VALUES ('orders', 'INSERT');
   ```

### 7.2 é¿å…åšæ³•

#### âŒ è§„åˆ™åæ¨¡å¼

1. **è§„åˆ™è¿‡äºå¤æ‚**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè§„åˆ™è¿‡äºå¤æ‚ï¼Œå½±å“æ€§èƒ½
   CREATE RULE complex_rule AS
       ON INSERT TO orders
       DO INSTEAD
       INSERT INTO orders
       SELECT * FROM (
           SELECT
               NEW.id,
               NEW.user_id,
               (SELECT SUM(amount) FROM orders WHERE user_id = NEW.user_id) AS total,
               NOW() AS created_at
           FROM generate_series(1, 1000)
       ) AS subquery;

   -- âœ… å¥½ï¼šç®€åŒ–è§„åˆ™æŸ¥è¯¢
   CREATE RULE simple_rule AS
       ON INSERT TO orders
       DO INSTEAD
       INSERT INTO orders (id, user_id, created_at)
       VALUES (NEW.id, NEW.user_id, NOW());
   ```

2. **è§„åˆ™å†²çª**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè§„åˆ™å†²çªï¼Œå¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸º
   CREATE RULE rule1 AS ON INSERT TO my_table DO INSTEAD INSERT INTO table1;
   CREATE RULE rule2 AS ON INSERT TO my_table DO INSTEAD INSERT INTO table2;
   -- ä¸¤ä¸ªDO INSTEADè§„åˆ™å†²çªï¼Œåªæ‰§è¡Œç¬¬ä¸€ä¸ª

   -- âœ… å¥½ï¼šä½¿ç”¨DO ALSOæˆ–åˆå¹¶è§„åˆ™
   CREATE RULE rule1 AS ON INSERT TO my_table DO INSTEAD
       INSERT INTO table1 VALUES (NEW.*);
   CREATE RULE rule2 AS ON INSERT TO my_table DO ALSO
       INSERT INTO table2 VALUES (NEW.*);
   ```

3. **è§„åˆ™ä¸è§¦å‘å™¨æ··ç”¨ä¸å½“**ï¼š

   ```sql
   -- âŒ ä¸å¥½ï¼šè§„åˆ™å’Œè§¦å‘å™¨æ··ç”¨ï¼Œå¯¼è‡´æ‰§è¡Œé¡ºåºä¸æ˜ç¡®
   CREATE RULE my_rule AS ON INSERT TO my_table DO ALSO ...;
   CREATE TRIGGER my_trigger BEFORE INSERT ON my_table ...;
   -- è§„åˆ™å’Œè§¦å‘å™¨çš„æ‰§è¡Œé¡ºåºä¸æ˜ç¡®

   -- âœ… å¥½ï¼šä¼˜å…ˆä½¿ç”¨è§¦å‘å™¨ï¼Œè§„åˆ™ç”¨äºè§†å›¾
   -- è§„åˆ™ä¸»è¦ç”¨äºå®ç°å¯æ›´æ–°è§†å›¾
   -- è§¦å‘å™¨ç”¨äºæ•°æ®éªŒè¯å’Œä¸šåŠ¡é€»è¾‘
   ```

### 7.3 æ€§èƒ½å»ºè®®

1. **è§„åˆ™æ€§èƒ½ä¼˜åŒ–**ï¼š
   - è§„åˆ™æŸ¥è¯¢åº”å°½é‡ç®€å•ï¼Œé¿å…å¤æ‚å­æŸ¥è¯¢
   - ä½¿ç”¨DO INSTEADæ›¿ä»£DO ALSOï¼Œå‡å°‘æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°
   - è§„åˆ™ä¸»è¦ç”¨äºå®ç°å¯æ›´æ–°è§†å›¾ï¼Œå…¶ä»–åœºæ™¯ä¼˜å…ˆä½¿ç”¨è§¦å‘å™¨

2. **è§„åˆ™ç®¡ç†å»ºè®®**ï¼š
   - ä½¿ç”¨æ¸…æ™°çš„è§„åˆ™å‘½åè§„èŒƒ
   - ç†è§£è§„åˆ™æ‰§è¡Œé¡ºåºå’Œä¼˜å…ˆçº§
   - é¿å…è§„åˆ™å†²çªï¼Œåˆç†ä½¿ç”¨DO INSTEADå’ŒDO ALSO

3. **è§„åˆ™é€‰æ‹©å»ºè®®**ï¼š
   - å¯æ›´æ–°è§†å›¾ï¼šä½¿ç”¨è§„åˆ™å®ç°
   - æ•°æ®éªŒè¯ï¼šä½¿ç”¨è§¦å‘å™¨å®ç°
   - å®¡è®¡æ—¥å¿—ï¼šå¯ä»¥ä½¿ç”¨è§„åˆ™æˆ–è§¦å‘å™¨
   - ä¸šåŠ¡é€»è¾‘ï¼šä½¿ç”¨è§¦å‘å™¨å®ç°

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§„åˆ™ç³»ç»Ÿ](https://www.postgresql.org/docs/current/rules.html)**
  - è§„åˆ™ç³»ç»Ÿæ¦‚è¿°å’ŒåŸºæœ¬æ¦‚å¿µ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - CREATE RULE](https://www.postgresql.org/docs/current/sql-createrule.html)**
  - CREATE RULE è¯­æ³•å’Œé€‰é¡¹è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - DROP RULE](https://www.postgresql.org/docs/current/sql-droprule.html)**
  - DROP RULE è¯­æ³•è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ALTER RULE](https://www.postgresql.org/docs/current/sql-alterrule.html)**
  - ALTER RULE è¯­æ³•è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§„åˆ™ä¸è§†å›¾](https://www.postgresql.org/docs/current/rules-views.html)**
  - è§„åˆ™åœ¨è§†å›¾ä¸­çš„åº”ç”¨

### 8.2 æŠ€æœ¯è®ºæ–‡

- **[Query Rewriting Using Views](https://www.cs.utexas.edu/~divesh/papers/views-survey.pdf)**
  - ä½¿ç”¨è§†å›¾è¿›è¡ŒæŸ¥è¯¢é‡å†™çš„ç®—æ³•å’ŒæŠ€æœ¯

- **[Database Rules: Design and Implementation](https://www.postgresql.org/docs/current/rules.html)**
  - æ•°æ®åº“è§„åˆ™è®¾è®¡å’Œå®ç°åŸç†

### 8.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL Rules: Best Practices](https://www.postgresql.org/docs/current/rules.html)**
  - PostgreSQL å®˜æ–¹åšå®¢ï¼šè§„åˆ™æœ€ä½³å®è·µ

- **[Understanding PostgreSQL Rules](https://www.enterprisedb.com/postgres-tutorials/understanding-postgresql-rules)**
  - EnterpriseDB åšå®¢ï¼šç†è§£ PostgreSQL è§„åˆ™

- **[PostgreSQL Rules vs Triggers](https://www.citusdata.com/blog/2017/10/25/rules-vs-triggers-in-postgresql/)**
  - Citus Data åšå®¢ï¼šè§„åˆ™ä¸è§¦å‘å™¨å¯¹æ¯”

### 8.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Rules](https://wiki.postgresql.org/wiki/Rules)**
  - PostgreSQL Wikiï¼šè§„åˆ™ç›¸å…³è®¨è®ºå’Œç¤ºä¾‹

- **[Stack Overflow - PostgreSQL Rules](https://stackoverflow.com/questions/tagged/postgresql+rules)**
  - Stack Overflowï¼šPostgreSQL è§„åˆ™ç›¸å…³é—®ç­”

- **[PostgreSQL Mailing Lists](https://www.postgresql.org/list/)**
  - PostgreSQL é‚®ä»¶åˆ—è¡¨ï¼šè§„åˆ™ç›¸å…³è®¨è®º

### 8.5 ç›¸å…³æ–‡æ¡£

- [è§†å›¾ä¸ç‰©åŒ–è§†å›¾](./è§†å›¾ä¸ç‰©åŒ–è§†å›¾.md)
- [è§¦å‘å™¨é«˜çº§åº”ç”¨](../04-å‡½æ•°ä¸ç¼–ç¨‹/è§¦å‘å™¨é«˜çº§åº”ç”¨.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-36
