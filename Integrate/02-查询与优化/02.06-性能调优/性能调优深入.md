---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\11-æ€§èƒ½è°ƒä¼˜\æ€§èƒ½è°ƒä¼˜æ·±å…¥.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL æ€§èƒ½è°ƒä¼˜æ·±å…¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-12

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ€§èƒ½è°ƒä¼˜æ·±å…¥](#postgresql-æ€§èƒ½è°ƒä¼˜æ·±å…¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾](#13-æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰](#2-æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰)
    - [2.0 æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰](#20-æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰)
    - [2.1 é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å¯¹æ¯”çŸ©é˜µ](#21-é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å¯¹æ¯”çŸ©é˜µ)
  - [3. é…ç½®å‚æ•°è°ƒä¼˜](#3-é…ç½®å‚æ•°è°ƒä¼˜)
    - [3.1 å†…å­˜é…ç½®](#31-å†…å­˜é…ç½®)
    - [3.2 æ£€æŸ¥ç‚¹é…ç½®](#32-æ£€æŸ¥ç‚¹é…ç½®)
    - [3.3 æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®](#33-æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®)
  - [4. æŸ¥è¯¢è®¡åˆ’åˆ†æ](#4-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
    - [4.1 EXPLAIN è¯¦è§£](#41-explain-è¯¦è§£)
    - [4.2 ç†è§£æ‰§è¡Œè®¡åˆ’](#42-ç†è§£æ‰§è¡Œè®¡åˆ’)
    - [4.3 æ…¢æŸ¥è¯¢åˆ†æ](#43-æ…¢æŸ¥è¯¢åˆ†æ)
  - [5. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#5-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
    - [5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯](#51-æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æ€§èƒ½è°ƒä¼˜ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#71-æ¡ˆä¾‹-ç”µå•†å¹³å°æ€§èƒ½è°ƒä¼˜çœŸå®æ¡ˆä¾‹)
    - [ç»ƒä¹  2: é…ç½®ä¼˜åŒ–](#ç»ƒä¹ -2-é…ç½®ä¼˜åŒ–)
  - [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
    - [9.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™](#91-æ€§èƒ½è°ƒä¼˜åŸåˆ™)
    - [9.2 è°ƒä¼˜å»ºè®®](#92-è°ƒä¼˜å»ºè®®)
  - [10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#10-å¸¸è§é—®é¢˜faq)
    - [10.1 æ€§èƒ½è°ƒä¼˜åŸºç¡€å¸¸è§é—®é¢˜](#101-æ€§èƒ½è°ƒä¼˜åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Ÿ](#q1-å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ)
      - [Q2: å¦‚ä½•ä¼˜åŒ–å†…å­˜é…ç½®ï¼Ÿ](#q2-å¦‚ä½•ä¼˜åŒ–å†…å­˜é…ç½®)
    - [10.2 é…ç½®è°ƒä¼˜å¸¸è§é—®é¢˜](#102-é…ç½®è°ƒä¼˜å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®)
  - [11. å‚è€ƒèµ„æ–™](#11-å‚è€ƒèµ„æ–™)
    - [11.1 å®˜æ–¹æ–‡æ¡£](#111-å®˜æ–¹æ–‡æ¡£)
    - [9.2 æŠ€æœ¯è®ºæ–‡](#92-æŠ€æœ¯è®ºæ–‡)
    - [9.3 æŠ€æœ¯åšå®¢](#93-æŠ€æœ¯åšå®¢)
    - [9.4 ç¤¾åŒºèµ„æº](#94-ç¤¾åŒºèµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ€§èƒ½è°ƒä¼˜çš„ä»·å€¼**:

PostgreSQL æ€§èƒ½è°ƒä¼˜æ˜¯æ•°æ®åº“ç®¡ç†çš„æ ¸å¿ƒä»»åŠ¡ï¼š

1. **é…ç½®ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“é…ç½®å‚æ•°
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢è¯­å¥å’Œæ‰§è¡Œè®¡åˆ’
3. **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–ç´¢å¼•è®¾è®¡å’Œç»´æŠ¤
4. **æ¶æ„ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“æ¶æ„

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½æå‡**: æå‡æ•°æ®åº“æ€§èƒ½
- **èµ„æºä¼˜åŒ–**: ä¼˜åŒ–èµ„æºä½¿ç”¨
- **æˆæœ¬ä¼˜åŒ–**: é™ä½ç¡¬ä»¶æˆæœ¬
- **å®¹é‡è§„åˆ’**: è¿›è¡Œå®¹é‡è§„åˆ’

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æ€§èƒ½æå‡** | è°ƒä¼˜æå‡æ€§èƒ½ | **2-10x** |
| **èµ„æºåˆ©ç”¨** | ä¼˜åŒ–èµ„æºåˆ©ç”¨ | **+40%** |
| **æˆæœ¬ä¼˜åŒ–** | é™ä½ç¡¬ä»¶æˆæœ¬ | **-30%** |
| **å“åº”æ—¶é—´** | é™ä½å“åº”æ—¶é—´ | **-70%** |

### 1.3 æ€§èƒ½è°ƒä¼˜ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½è°ƒä¼˜ä½“ç³»))
    é…ç½®è°ƒä¼˜
      å†…å­˜é…ç½®
        shared_buffers
        work_mem
        maintenance_work_mem
        effective_cache_size
      æ£€æŸ¥ç‚¹é…ç½®
        checkpoint_timeout
        checkpoint_completion_target
        max_wal_size
        min_wal_size
      æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®
        æˆæœ¬å‚æ•°
        ä¼˜åŒ–å™¨å¼€å…³
        å¹¶è¡Œå‚æ•°
    æŸ¥è¯¢ä¼˜åŒ–
      æŸ¥è¯¢é‡å†™
        å­æŸ¥è¯¢ä¼˜åŒ–
        JOINä¼˜åŒ–
        è°“è¯ä¸‹æ¨
      ç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•é€‰æ‹©
        ç´¢å¼•ç»´æŠ¤
        ç´¢å¼•ç»Ÿè®¡
      ç»Ÿè®¡ä¿¡æ¯
        ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
        ç»Ÿè®¡ä¿¡æ¯åˆ†æ
        ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨
    æ¶æ„ä¼˜åŒ–
      åˆ†åŒºä¼˜åŒ–
        åˆ†åŒºè®¾è®¡
        åˆ†åŒºç»´æŠ¤
        åˆ†åŒºæŸ¥è¯¢
      å¤åˆ¶ä¼˜åŒ–
        æµå¤åˆ¶
        è¯»å†™åˆ†ç¦»
        è´Ÿè½½å‡è¡¡
      è¿æ¥ä¼˜åŒ–
        è¿æ¥æ± 
        è¿æ¥ç®¡ç†
        è¿æ¥ç›‘æ§
```

## 2. æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰

### 2.0 æ€§èƒ½è°ƒä¼˜å½¢å¼åŒ–å®šä¹‰

**æ€§èƒ½è°ƒä¼˜çš„æœ¬è´¨**ï¼šæ€§èƒ½è°ƒä¼˜æ˜¯é€šè¿‡æ·±å…¥åˆ†æç³»ç»Ÿç“¶é¢ˆï¼Œåº”ç”¨é«˜çº§ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ç°æ€§èƒ½çš„æŒç»­æå‡ã€‚

**å®šä¹‰ 1ï¼ˆæ€§èƒ½ç“¶é¢ˆåˆ†æï¼‰**ï¼š
è®¾ BottleneckAnalysis = {identification, measurement, root_cause}ï¼Œå…¶ä¸­ï¼š

- identificationï¼šç“¶é¢ˆè¯†åˆ«
- measurementï¼šæ€§èƒ½æµ‹é‡
- root_causeï¼šæ ¹æœ¬åŸå› åˆ†æ

**å®šä¹‰ 2ï¼ˆé…ç½®è°ƒä¼˜ï¼‰**ï¼š
è®¾ ConfigOptimization = {memory, checkpoint, optimizer}ï¼Œå…¶ä¸­ï¼š

- memoryï¼šå†…å­˜é…ç½®ä¼˜åŒ–
- checkpointï¼šæ£€æŸ¥ç‚¹é…ç½®ä¼˜åŒ–
- optimizerï¼šä¼˜åŒ–å™¨é…ç½®ä¼˜åŒ–

**å®šä¹‰ 3ï¼ˆæŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ï¼‰**ï¼š
è®¾ QueryPlanOptimization = {explain, analysis, tuning}ï¼Œå…¶ä¸­ï¼š

- explainï¼šæ‰§è¡Œè®¡åˆ’åˆ†æ
- analysisï¼šæ€§èƒ½åˆ†æ
- tuningï¼šè®¡åˆ’è°ƒä¼˜

**å®šä¹‰ 4ï¼ˆç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–ï¼‰**ï¼š
è®¾ StatisticsOptimization = {collection, accuracy, maintenance}ï¼Œå…¶ä¸­ï¼š

- collectionï¼šç»Ÿè®¡ä¿¡æ¯æ”¶é›†
- accuracyï¼šç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§
- maintenanceï¼šç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç† 1ï¼ˆé…ç½®è°ƒä¼˜æœ‰æ•ˆæ€§ï¼‰**ï¼š
å¦‚æœé…ç½®å‚æ•°ä¸ç¡¬ä»¶ç¯å¢ƒåŒ¹é…ï¼Œåˆ™æ€§èƒ½æå‡æ˜¾è‘—ã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰2ï¼Œé…ç½®è°ƒä¼˜åŒ…æ‹¬å†…å­˜ã€æ£€æŸ¥ç‚¹ã€ä¼˜åŒ–å™¨é…ç½®
2. é…ç½®å‚æ•°ä¸ç¡¬ä»¶ç¯å¢ƒåŒ¹é…
3. æ•°æ®åº“ç³»ç»Ÿå……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æº
4. å› æ­¤ï¼Œæ€§èƒ½æå‡æ˜¾è‘—

**å®šç† 2ï¼ˆç»Ÿè®¡ä¿¡æ¯é‡è¦æ€§ï¼‰**ï¼š
ç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§ç›´æ¥å½±å“æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å†³ç­–è´¨é‡ã€‚

**è¯æ˜**ï¼š

1. æŸ¥è¯¢ä¼˜åŒ–å™¨ä¾èµ–ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä»£ä»·ä¼°ç®—
2. ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´ä»£ä»·ä¼°ç®—é”™è¯¯
3. é”™è¯¯çš„ä»£ä»·ä¼°ç®—å¯¼è‡´æ¬¡ä¼˜è®¡åˆ’é€‰æ‹©
4. å› æ­¤ï¼Œç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§ç›´æ¥å½±å“ä¼˜åŒ–å™¨å†³ç­–è´¨é‡

**å®é™…åº”ç”¨**ï¼š

- æ€§èƒ½è°ƒä¼˜åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œé…ç½®ä¼˜åŒ–
- æŸ¥è¯¢ä¼˜åŒ–å™¨åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œè®¡åˆ’é€‰æ‹©
- ç»Ÿè®¡ä¿¡æ¯ç®¡ç†åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

### 2.1 é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å¯¹æ¯”çŸ©é˜µ

**é…ç½®è°ƒä¼˜ç­–ç•¥çš„é€‰æ‹©æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®å†³ç­–**ï¼Œé€‰æ‹©åˆé€‚çš„ç­–ç•¥å¯ä»¥æœ€å¤§åŒ–æ€§èƒ½æå‡ã€‚

**é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å¯¹æ¯”çŸ©é˜µ**ï¼š

| ç­–ç•¥ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ | é£é™© | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
| --- | --- | --- | --- | --- | --- |
| **å†…å­˜é…ç½®** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å†…å­˜å—é™ | 4.3/5 |
| **æ£€æŸ¥ç‚¹é…ç½®** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | I/Oç“¶é¢ˆ | 4.6/5 |
| **ä¼˜åŒ–å™¨é…ç½®** | â­â­â­â­â­ | â­â­â­ | â­â­â­ | æŸ¥è¯¢æ€§èƒ½ | 4.0/5 |
| **å¹¶è¡ŒæŸ¥è¯¢é…ç½®** | â­â­â­â­â­ | â­â­â­ | â­â­â­ | å¤§æ•°æ®é‡ | 3.7/5 |

**é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B{ç“¶é¢ˆç±»å‹}
    B -->|å†…å­˜ç“¶é¢ˆ| C[å†…å­˜é…ç½®è°ƒä¼˜]
    B -->|I/Oç“¶é¢ˆ| D[æ£€æŸ¥ç‚¹é…ç½®è°ƒä¼˜]
    B -->|æŸ¥è¯¢æ€§èƒ½| E{æŸ¥è¯¢ç±»å‹}
    B -->|CPUç“¶é¢ˆ| F[å¹¶è¡ŒæŸ¥è¯¢é…ç½®]
    E -->|ä¼˜åŒ–å™¨é—®é¢˜| G[ä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜]
    E -->|ç»Ÿè®¡ä¿¡æ¯é—®é¢˜| H[ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–]
    C --> I[éªŒè¯è°ƒä¼˜æ•ˆæœ]
    D --> I
    G --> I
    F --> I
    H --> I
    I --> J{æ€§èƒ½æ»¡è¶³è¦æ±‚?}
    J -->|æ˜¯| K[è°ƒä¼˜å®Œæˆ]
    J -->|å¦| L{é—®é¢˜åˆ†æ}
    L -->|æ€§èƒ½é—®é¢˜| M{æ˜¯å¦éœ€è¦å…¶ä»–ç­–ç•¥?}
    L -->|åŠŸèƒ½é—®é¢˜| N[é€‰æ‹©å…¶ä»–ç­–ç•¥]
    M -->|æ˜¯| O[ç»„åˆç­–ç•¥]
    M -->|å¦| P[é€‰æ‹©å…¶ä»–ç­–ç•¥]
    O --> I
    P --> B
    N --> B

    style B fill:#FFD700
    style J fill:#90EE90
    style K fill:#90EE90
```

## 3. é…ç½®å‚æ•°è°ƒä¼˜

### 3.1 å†…å­˜é…ç½®

**å†…å­˜é…ç½®åŸç†**:

PostgreSQL ä½¿ç”¨å¤šç§å†…å­˜åŒºåŸŸï¼Œåˆç†é…ç½®å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š

1. **shared_buffers**: å…±äº«ç¼“å†²åŒºï¼Œå­˜å‚¨è¡¨å’Œç´¢å¼•çš„é¡µé¢
2. **work_mem**: æ¯ä¸ªæŸ¥è¯¢æ“ä½œï¼ˆæ’åºã€å“ˆå¸Œï¼‰ä½¿ç”¨çš„å†…å­˜
3. **maintenance_work_mem**: ç»´æŠ¤æ“ä½œï¼ˆVACUUMã€CREATE INDEXï¼‰ä½¿ç”¨çš„å†…å­˜
4. **effective_cache_size**: å‘Šè¯‰ä¼˜åŒ–å™¨ç³»ç»Ÿå¯ç”¨çš„ç¼“å­˜å¤§å°

**æŸ¥çœ‹å½“å‰é…ç½®**:

```sql
-- æŸ¥çœ‹å½“å‰é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    shared_buffers_setting TEXT;
    work_mem_setting TEXT;
    maintenance_work_mem_setting TEXT;
    effective_cache_size_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO shared_buffers_setting FROM pg_settings WHERE name = 'shared_buffers';
        SELECT setting INTO work_mem_setting FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO maintenance_work_mem_setting FROM pg_settings WHERE name = 'maintenance_work_mem';
        SELECT setting INTO effective_cache_size_setting FROM pg_settings WHERE name = 'effective_cache_size';

        RAISE NOTICE 'å½“å‰å†…å­˜é…ç½®:';
        RAISE NOTICE '  shared_buffers: %', shared_buffers_setting;
        RAISE NOTICE '  work_mem: %', work_mem_setting;
        RAISE NOTICE '  maintenance_work_mem: %', maintenance_work_mem_setting;
        RAISE NOTICE '  effective_cache_size: %', effective_cache_size_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹å†…å­˜é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
DO $$
DECLARE
    shared_buffers_setting TEXT;
    work_mem_setting TEXT;
    maintenance_work_mem_setting TEXT;
    effective_cache_size_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO shared_buffers_setting FROM pg_settings WHERE name = 'shared_buffers';
        SELECT setting INTO work_mem_setting FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO maintenance_work_mem_setting FROM pg_settings WHERE name = 'maintenance_work_mem';
        SELECT setting INTO effective_cache_size_setting FROM pg_settings WHERE name = 'effective_cache_size';

        RAISE NOTICE 'å½“å‰å†…å­˜é…ç½®:';
        RAISE NOTICE '  shared_buffers: %', shared_buffers_setting;
        RAISE NOTICE '  work_mem: %', work_mem_setting;
        RAISE NOTICE '  maintenance_work_mem: %', maintenance_work_mem_setting;
        RAISE NOTICE '  effective_cache_size: %', effective_cache_size_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    setting,
    unit,
    source
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem', 'effective_cache_size')
ORDER BY name;
```

**ä¸åŒæœåŠ¡å™¨é…ç½®å»ºè®®**:

```sql
-- å°å‹æœåŠ¡å™¨ï¼ˆ8GB RAMï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET shared_buffers = '2GB';  -- 25% of RAM
        ALTER SYSTEM SET work_mem = '16MB';
        ALTER SYSTEM SET maintenance_work_mem = '512MB';
        ALTER SYSTEM SET effective_cache_size = '6GB';  -- 75% of RAM
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å°å‹æœåŠ¡å™¨ï¼ˆ8GB RAMï¼‰å†…å­˜é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸­å‹æœåŠ¡å™¨ï¼ˆ32GB RAMï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET shared_buffers = '8GB';  -- 25% of RAM
        ALTER SYSTEM SET work_mem = '64MB';
        ALTER SYSTEM SET maintenance_work_mem = '2GB';
        ALTER SYSTEM SET effective_cache_size = '24GB';  -- 75% of RAM
        PERFORM pg_reload_conf();
        RAISE NOTICE 'ä¸­å‹æœåŠ¡å™¨ï¼ˆ32GB RAMï¼‰å†…å­˜é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¤§å‹æœåŠ¡å™¨ï¼ˆ128GB RAMï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET shared_buffers = '32GB';  -- 25% of RAMï¼ˆæœ€å¤§å»ºè®®å€¼ï¼‰
        ALTER SYSTEM SET work_mem = '256MB';
        ALTER SYSTEM SET maintenance_work_mem = '8GB';
        ALTER SYSTEM SET effective_cache_size = '96GB';  -- 75% of RAM
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¤§å‹æœåŠ¡å™¨ï¼ˆ128GB RAMï¼‰å†…å­˜é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**å†…å­˜é…ç½®æ€§èƒ½å½±å“** (åŸºäºå®é™…æµ‹è¯•):

| é…ç½®é¡¹ | é»˜è®¤å€¼ | ä¼˜åŒ–å€¼ | æ€§èƒ½æå‡ | è¯´æ˜ |
| --- | --- | --- | --- | --- |
| **shared_buffers** | 128MB | 2GB | **30-50%** | ç¼“å­˜å‘½ä¸­ç‡æå‡ |
| **work_mem** | 4MB | 64MB | **20-40%** | æ’åºå’Œå“ˆå¸Œæ“ä½œæ›´å¿« |
| **maintenance_work_mem** | 64MB | 2GB | **50-70%** | VACUUM å’Œç´¢å¼•æ„å»ºæ›´å¿« |
| **effective_cache_size** | 4GB | 24GB | **10-20%** | æŸ¥è¯¢è®¡åˆ’æ›´ä¼˜ |

**å†…å­˜é…ç½®æ³¨æ„äº‹é¡¹**:

1. **shared_buffers**: ä¸è¦è¶…è¿‡ç³»ç»Ÿå†…å­˜çš„ 40%ï¼Œé€šå¸¸è®¾ç½®ä¸º 25%
2. **work_mem**: æ³¨æ„å¹¶å‘è¿æ¥æ•°ï¼Œ`work_mem Ã— max_connections` ä¸åº”è¶…è¿‡ç³»ç»Ÿå†…å­˜
3. **maintenance_work_mem**: å¯ä»¥è®¾ç½®è¾ƒå¤§ï¼Œå› ä¸ºç»´æŠ¤æ“ä½œé€šå¸¸ä¸å¹¶å‘æ‰§è¡Œ
4. **effective_cache_size**: è®¾ç½®ä¸ºæ“ä½œç³»ç»Ÿç¼“å­˜ + shared_buffers çš„æ€»å’Œ

### 3.2 æ£€æŸ¥ç‚¹é…ç½®

**æ£€æŸ¥ç‚¹åŸç†**:

æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰æ˜¯ PostgreSQL å°†è„é¡µï¼ˆä¿®æ”¹è¿‡çš„é¡µé¢ï¼‰å†™å…¥ç£ç›˜çš„è¿‡ç¨‹ã€‚
åˆç†çš„æ£€æŸ¥ç‚¹é…ç½®å¯ä»¥å¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ã€‚

**æ£€æŸ¥ç‚¹é…ç½®å‚æ•°**:

```sql
-- æ£€æŸ¥ç‚¹é…ç½®
-- checkpoint_timeout = 15min     # æ£€æŸ¥ç‚¹é—´éš”ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
-- max_wal_size = 1GB             # WAL æœ€å¤§å¤§å°ï¼ˆè§¦å‘æ£€æŸ¥ç‚¹ï¼‰
-- min_wal_size = 80MB            # WAL æœ€å°å¤§å°
-- checkpoint_completion_target = 0.9  # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡ï¼ˆ0.0-1.0ï¼‰
```

**ä¸åŒåœºæ™¯é…ç½®å»ºè®®**:

```sql
-- é«˜å†™å…¥è´Ÿè½½åœºæ™¯ï¼ˆOLTPï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET checkpoint_timeout = '10min';
        ALTER SYSTEM SET max_wal_size = '2GB';
        ALTER SYSTEM SET min_wal_size = '160MB';
        ALTER SYSTEM SET checkpoint_completion_target = 0.9;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'é«˜å†™å…¥è´Ÿè½½åœºæ™¯ï¼ˆOLTPï¼‰æ£€æŸ¥ç‚¹é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä½å†™å…¥è´Ÿè½½åœºæ™¯ï¼ˆOLAPï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET checkpoint_timeout = '30min';
        ALTER SYSTEM SET max_wal_size = '4GB';
        ALTER SYSTEM SET min_wal_size = '320MB';
        ALTER SYSTEM SET checkpoint_completion_target = 0.9;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'ä½å†™å…¥è´Ÿè½½åœºæ™¯ï¼ˆOLAPï¼‰æ£€æŸ¥ç‚¹é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ··åˆè´Ÿè½½åœºæ™¯ï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET checkpoint_timeout = '15min';
        ALTER SYSTEM SET max_wal_size = '1GB';
        ALTER SYSTEM SET min_wal_size = '80MB';
        ALTER SYSTEM SET checkpoint_completion_target = 0.9;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'æ··åˆè´Ÿè½½åœºæ™¯æ£€æŸ¥ç‚¹é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**æ£€æŸ¥ç‚¹é…ç½®æ€§èƒ½å½±å“**:

| é…ç½®é¡¹ | é»˜è®¤å€¼ | ä¼˜åŒ–å€¼ | æ€§èƒ½å½±å“ | è¯´æ˜ |
|--------|--------|--------|---------|------|
| **checkpoint_timeout** | 5min | 15min | **å‡å°‘ I/O å³°å€¼** | æ£€æŸ¥ç‚¹é—´éš”æ›´é•¿ |
| **max_wal_size** | 1GB | 2GB | **å‡å°‘æ£€æŸ¥ç‚¹é¢‘ç‡** | WAL æ›´å¤§æ‰è§¦å‘æ£€æŸ¥ç‚¹ |
| **checkpoint_completion_target** | 0.5 | 0.9 | **å¹³æ»‘ I/O** | æ£€æŸ¥ç‚¹æ›´å¹³æ»‘ |

**æ£€æŸ¥ç‚¹ç›‘æ§**:

```sql
-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    checkpoint_count INT;
    avg_write_time NUMERIC;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO checkpoint_count
        FROM pg_stat_bgwriter;

        IF checkpoint_count = 0 THEN
            RAISE WARNING 'æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
            RETURN;
        END IF;

        SELECT
            CASE
                WHEN (checkpoints_timed + checkpoints_req) > 0
                THEN checkpoint_write_time / (checkpoints_timed + checkpoints_req)
                ELSE 0
            END INTO avg_write_time
        FROM pg_stat_bgwriter;

        IF avg_write_time > 1000 THEN
            RAISE WARNING 'æ£€æŸ¥ç‚¹å¹³å‡å†™å…¥æ—¶é—´ %.2f ms è¶…è¿‡1000msï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–', avg_write_time;
        ELSE
            RAISE NOTICE 'æ£€æŸ¥ç‚¹å¹³å‡å†™å…¥æ—¶é—´ %.2f msï¼Œæ€§èƒ½æ­£å¸¸', avg_write_time;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,      -- å®šæ—¶æ£€æŸ¥ç‚¹æ¬¡æ•°
    checkpoints_req,        -- è¯·æ±‚æ£€æŸ¥ç‚¹æ¬¡æ•°
    checkpoint_write_time,  -- æ£€æŸ¥ç‚¹å†™å…¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    checkpoint_sync_time,   -- æ£€æŸ¥ç‚¹åŒæ­¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    buffers_checkpoint,     -- æ£€æŸ¥ç‚¹å†™å…¥çš„ç¼“å†²åŒºæ•°
    buffers_clean,          -- åå°å†™å…¥çš„ç¼“å†²åŒºæ•°
    maxwritten_clean        -- è¾¾åˆ° max_dirty é™åˆ¶çš„æ¬¡æ•°
FROM pg_stat_bgwriter;

-- æ£€æŸ¥ç‚¹æ€§èƒ½æŒ‡æ ‡è¯´æ˜
-- checkpoint_write_time / (checkpoints_timed + checkpoints_req) < 1000ms ä¸ºæ­£å¸¸
```

### 3.3 æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®

**æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®è¯¦è§£**ï¼š

æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®å½±å“æŸ¥è¯¢è®¡åˆ’çš„é€‰æ‹©ï¼Œåˆç†çš„é…ç½®å¯ä»¥æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

```sql
-- 1. I/O æˆæœ¬é…ç½®ï¼ˆæ ¹æ®å­˜å‚¨ç±»å‹ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- HDDï¼ˆæœºæ¢°ç¡¬ç›˜ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET random_page_cost = 4.0;
        ALTER SYSTEM SET seq_page_cost = 1.0;
        ALTER SYSTEM SET effective_io_concurrency = 2;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'HDDï¼ˆæœºæ¢°ç¡¬ç›˜ï¼‰I/Oæˆæœ¬é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®I/Oæˆæœ¬é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- SSDï¼ˆå›ºæ€ç¡¬ç›˜ï¼‰- æ¨èï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET random_page_cost = 1.1;  -- æ¥è¿‘é¡ºåºè¯»å–æˆæœ¬
        ALTER SYSTEM SET seq_page_cost = 1.0;
        ALTER SYSTEM SET effective_io_concurrency = 200;  -- SSD å¹¶å‘ I/O èƒ½åŠ›å¼º
        PERFORM pg_reload_conf();
        RAISE NOTICE 'SSDï¼ˆå›ºæ€ç¡¬ç›˜ï¼‰I/Oæˆæœ¬é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®I/Oæˆæœ¬é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- NVMe SSDï¼ˆé«˜æ€§èƒ½ SSDï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET random_page_cost = 1.0;  -- éšæœºå’Œé¡ºåºè¯»å–æˆæœ¬ç›¸åŒ
        ALTER SYSTEM SET seq_page_cost = 1.0;
        ALTER SYSTEM SET effective_io_concurrency = 300;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'NVMe SSDï¼ˆé«˜æ€§èƒ½SSDï¼‰I/Oæˆæœ¬é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®I/Oæˆæœ¬é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET default_statistics_target = 100;  -- é»˜è®¤å€¼
        PERFORM pg_reload_conf();
        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ä¿¡æ¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¯¹äºå¤§è¡¨æˆ–å¤æ‚æŸ¥è¯¢ï¼Œå¯ä»¥å¢åŠ åˆ° 200-500ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œè·³è¿‡ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡è®¾ç½®';
            RETURN;
        END IF;

        ALTER TABLE large_table ALTER COLUMN important_column SET STATISTICS 500;
        ANALYZE large_table;
        RAISE NOTICE 'è¡¨ large_table çš„åˆ— important_column ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å·²è®¾ç½®ä¸º500å¹¶å·²åˆ†æ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ— important_column ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å¹¶è¡ŒæŸ¥è¯¢é…ç½®ï¼ˆPostgreSQL 9.6+ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET max_parallel_workers_per_gather = 4;  -- æ¯ä¸ªæŸ¥è¯¢çš„æœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
        ALTER SYSTEM SET max_parallel_workers = 8;  -- ç³»ç»Ÿæœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
        ALTER SYSTEM SET parallel_setup_cost = 1000;  -- å¹¶è¡Œè®¾ç½®æˆæœ¬é˜ˆå€¼
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
-- 3. å¹¶è¡Œå…ƒç»„ä¼ è¾“æˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;
        ALTER SYSTEM SET parallel_tuple_cost = 0.01;  -- å¹¶è¡Œå…ƒç»„ä¼ è¾“æˆæœ¬
        RAISE NOTICE 'parallel_tuple_costå·²è®¾ç½®ä¸º0.01';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®parallel_tuple_costå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. æŸ¥è¯¢ä¼˜åŒ–å™¨å¼€å…³ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;
        -- å¯ç”¨æ‰€æœ‰ä¼˜åŒ–å™¨åŠŸèƒ½ï¼ˆæ¨èï¼‰
        ALTER SYSTEM SET enable_seqscan = on;
        ALTER SYSTEM SET enable_indexscan = on;
        ALTER SYSTEM SET enable_bitmapscan = on;
        ALTER SYSTEM SET enable_nestloop = on;
        ALTER SYSTEM SET enable_mergejoin = on;
        ALTER SYSTEM SET enable_hashjoin = on;
        RAISE NOTICE 'æŸ¥è¯¢ä¼˜åŒ–å™¨å¼€å…³å·²å¯ç”¨';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æŸ¥è¯¢ä¼˜åŒ–å™¨å¼€å…³å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. JOIN é¡ºåºä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;
        ALTER SYSTEM SET join_collapse_limit = 12;  -- JOIN é‡æ’åºé™åˆ¶
        ALTER SYSTEM SET from_collapse_limit = 12;  -- FROM å­å¥é‡æ’åºé™åˆ¶
        RAISE NOTICE 'JOINé¡ºåºä¼˜åŒ–å‚æ•°å·²è®¾ç½®';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®JOINé¡ºåºä¼˜åŒ–å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 6. æŸ¥çœ‹å½“å‰ä¼˜åŒ–å™¨é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢å½“å‰ä¼˜åŒ–å™¨é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, source
FROM pg_settings
WHERE name LIKE '%cost%'
   OR name LIKE '%parallel%'
   OR name LIKE '%statistics%'
   OR name LIKE 'enable_%'
ORDER BY name;

-- 7. æµ‹è¯•ä¼˜åŒ–å™¨é…ç½®æ•ˆæœï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•ä¼˜åŒ–å™¨é…ç½®æ•ˆæœ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ‰§è¡ŒæŸ¥è¯¢å‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table WHERE column = 'value';

-- è°ƒæ•´é…ç½®å
SET random_page_cost = 1.1;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table WHERE column = 'value';

-- 8. é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢è°ƒæ•´æˆæœ¬å‚æ•°ï¼ˆä¼šè¯çº§åˆ«ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table2') THEN
            RAISE WARNING 'è¡¨ table1 æˆ– table2 ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢çš„æˆæœ¬å‚æ•°è°ƒæ•´';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SET random_page_cost = 1.1;  -- å½“å‰ä¼šè¯ä½¿ç”¨ SSD æˆæœ¬
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM table1 JOIN table2 ON ...;
RESET random_page_cost;  -- æ¢å¤é»˜è®¤å€¼
```

## 4. æŸ¥è¯¢è®¡åˆ’åˆ†æ

### 4.1 EXPLAIN è¯¦è§£

```sql
-- åŸºæœ¬ EXPLAINï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒEXPLAIN';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºæœ¬EXPLAIN';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'EXPLAINå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN (ANALYZE, BUFFERS, TIMING)ï¼ˆå®é™…æ‰§è¡Œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒEXPLAIN (ANALYZE, BUFFERS, TIMING)';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒEXPLAIN (ANALYZE, BUFFERS, TIMING)ï¼ˆå®é™…æ‰§è¡Œï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'EXPLAIN (ANALYZE, BUFFERS, TIMING)å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN VERBOSEï¼ˆè¯¦ç»†ä¿¡æ¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒEXPLAIN VERBOSE';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒEXPLAIN VERBOSEï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'EXPLAIN VERBOSEå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN VERBOSE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN BUFFERSï¼ˆç¼“å†²åŒºä½¿ç”¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒEXPLAIN BUFFERS';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒEXPLAIN BUFFERSï¼ˆç¼“å†²åŒºä½¿ç”¨ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'EXPLAIN BUFFERSå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN FORMAT JSONï¼ˆJSON æ ¼å¼ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒEXPLAIN FORMAT JSON';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒEXPLAIN FORMAT JSONï¼ˆJSONæ ¼å¼ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'EXPLAIN FORMAT JSONå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON)
SELECT * FROM users WHERE email = 'john@example.com'
```

### 4.2 ç†è§£æ‰§è¡Œè®¡åˆ’

**å¸¸è§æ“ä½œç±»å‹è¯¦è§£**:

ç†è§£æ‰§è¡Œè®¡åˆ’ä¸­çš„æ“ä½œç±»å‹æ˜¯æ€§èƒ½è°ƒä¼˜çš„åŸºç¡€ã€‚

```sql
-- 1. Seq Scanï¼ˆé¡ºåºæ‰«æï¼‰- å…¨è¡¨æ‰«æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'small_table') THEN
            RAISE WARNING 'è¡¨ small_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Seq Scanï¼ˆé¡ºåºæ‰«æï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå°è¡¨ã€æ— ç´¢å¼•ã€éœ€è¦å¤§éƒ¨åˆ†æ•°æ®
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM small_table WHERE status = 'active';
-- è®¡åˆ’ï¼šSeq Scan on small_table

-- 2. Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰- ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šæœ‰ç´¢å¼•ã€é€‰æ‹©æ€§é«˜çš„æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users WHERE email = 'john@example.com';
-- è®¡åˆ’ï¼šIndex Scan using idx_users_email on users

-- 3. Index Only Scanï¼ˆä»…ç´¢å¼•æ‰«æï¼‰- æœ€å¿«ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes WHERE tablename = 'users' AND indexname = 'idx_users_email_name'
        ) THEN
            CREATE INDEX IF NOT EXISTS idx_users_email_name ON users(email, name);
            RAISE NOTICE 'ç´¢å¼• idx_users_email_name åˆ›å»ºæˆåŠŸ';
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Index Only Scanï¼ˆä»…ç´¢å¼•æ‰«æï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šæŸ¥è¯¢åˆ—éƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦è®¿é—®è¡¨
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT email, name FROM users WHERE email = 'john@example.com';
-- è®¡åˆ’ï¼šIndex Only Scan using idx_users_email_name on users

-- 4. Bitmap Index Scanï¼ˆä½å›¾ç´¢å¼•æ‰«æï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Bitmap Index Scanï¼ˆä½å›¾ç´¢å¼•æ‰«æï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå¤šä¸ªæ¡ä»¶ã€é€‰æ‹©æ€§ä¸­ç­‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders
WHERE customer_id = 123 AND status = 'pending';
-- è®¡åˆ’ï¼šBitmap Index Scan -> Bitmap Heap Scan

-- 5. Nested Loopï¼ˆåµŒå¥—å¾ªç¯è¿æ¥ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Nested Loopï¼ˆåµŒå¥—å¾ªç¯è¿æ¥ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå°è¡¨è¿æ¥ã€æœ‰ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, o.total
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.id = 123;
-- è®¡åˆ’ï¼šNested Loop

-- 6. Hash Joinï¼ˆå“ˆå¸Œè¿æ¥ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Hash Joinï¼ˆå“ˆå¸Œè¿æ¥ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå¤§è¡¨è¿æ¥ã€æ— ç´¢å¼•ã€ç­‰å€¼è¿æ¥
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, o.total
FROM users u
JOIN orders o ON u.id = o.user_id;
-- è®¡åˆ’ï¼šHash Join

-- 7. Merge Joinï¼ˆå½’å¹¶è¿æ¥ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•Merge Joinï¼ˆå½’å¹¶è¿æ¥ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå¤§è¡¨è¿æ¥ã€å·²æ’åºæ•°æ®
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, o.total
FROM users u
JOIN orders o ON u.id = o.user_id
ORDER BY u.id;
-- è®¡åˆ’ï¼šMerge Join

-- 8. å¹¶è¡ŒæŸ¥è¯¢ï¼ˆParallelï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•å¹¶è¡ŒæŸ¥è¯¢ï¼ˆParallelï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é€‚ç”¨åœºæ™¯ï¼šå¤§è¡¨æ‰«æã€CPU å¯†é›†å‹æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE status = 'active';
-- è®¡åˆ’ï¼šParallel Seq Scan -> Gather

-- 9. åˆ†ææ‰§è¡Œè®¡åˆ’æˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†ææ‰§è¡Œè®¡åˆ’æˆæœ¬';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name
HAVING COUNT(o.id) > 10;

-- 10. è¯†åˆ«æ€§èƒ½é—®é¢˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        -- é—®é¢˜1ï¼šSeq Scan on large_tableï¼ˆåº”è¯¥ä½¿ç”¨ç´¢å¼•ï¼‰
        -- è§£å†³ï¼šåˆ›å»ºç´¢å¼•
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes WHERE tablename = 'large_table' AND indexname = 'idx_large_table_status'
        ) THEN
            CREATE INDEX idx_large_table_status ON large_table(status);
            RAISE NOTICE 'ç´¢å¼• idx_large_table_status åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é—®é¢˜2ï¼šNested Loop æˆæœ¬é«˜ï¼ˆåº”è¯¥ä½¿ç”¨ Hash Joinï¼‰
-- è§£å†³ï¼šå¢åŠ  work_mem æˆ–åˆ›å»ºç´¢å¼•

-- é—®é¢˜3ï¼šå¹¶è¡Œåº¦ä¸å¤Ÿ
-- è§£å†³ï¼šå¢åŠ  max_parallel_workers_per_gather

-- 11. æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŠ€å·§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŠ€å·§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- âœ… å¥½ï¼šä½¿ç”¨ç´¢å¼•æ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users WHERE email = 'john@example.com';
-- è®¡åˆ’ï¼šIndex Scanï¼ˆå¿«ï¼‰

-- âŒ ä¸å¥½ï¼šå…¨è¡¨æ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users WHERE name LIKE '%john%';
-- è®¡åˆ’ï¼šSeq Scanï¼ˆæ…¢ï¼‰
-- è§£å†³ï¼šä½¿ç”¨å…¨æ–‡æœç´¢ç´¢å¼•æˆ–ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶
```

### 4.3 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- å¯ç”¨ pg_stat_statementsï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION pg_stat_statements;
            RAISE NOTICE 'pg_stat_statements æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pg_stat_statements æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pg_stat_statements æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pg_stat_statements æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slow_query_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'pg_stat_statements æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æŸ¥è¯¢æ…¢æŸ¥è¯¢';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO slow_query_count
        FROM pg_stat_statements
        WHERE mean_exec_time > 100;

        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ…¢æŸ¥è¯¢ï¼ˆå¹³å‡æ‰§è¡Œæ—¶é—´ > 100msï¼‰', slow_query_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'pg_stat_statements è§†å›¾ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / 1000 / 60) AS total_minutes
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´ > 100ms
ORDER BY mean_exec_time DESC
LIMIT 20;

-- é‡ç½®ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'pg_stat_statements æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•é‡ç½®ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        PERFORM pg_stat_statements_reset();
        RAISE NOTICE 'pg_stat_statements ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®';
    EXCEPTION
        WHEN undefined_function THEN
            RAISE WARNING 'å‡½æ•° pg_stat_statements_reset() ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é‡ç½®ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 5. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

### 5.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```sql
-- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ANALYZE users;
        RAISE NOTICE 'è¡¨ users ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ›´æ–°æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        ANALYZE;
        RAISE NOTICE 'æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ANALYZE users (email, name);
        RAISE NOTICE 'è¡¨ users çš„åˆ— email, name ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ— email æˆ– name ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE users ALTER COLUMN email SET STATISTICS 500;
        ANALYZE users;
        RAISE NOTICE 'è¡¨ users çš„åˆ— email ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å·²è®¾ç½®ä¸º500å¹¶å·²åˆ†æ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ— email ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

### 5.2 æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_stats_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_stats_count
        FROM pg_stat_user_tables
        WHERE tablename = 'users';

        IF table_stats_count = 0 THEN
            RAISE WARNING 'è¡¨ users çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
        ELSE
            RAISE NOTICE 'æ‰¾åˆ°è¡¨ users çš„ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¡¨ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'users';

-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    column_stats_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO column_stats_count
        FROM pg_stats
        WHERE tablename = 'users' AND attname = 'email';

        IF column_stats_count = 0 THEN
            RAISE WARNING 'è¡¨ users çš„åˆ— email çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
        ELSE
            RAISE NOTICE 'æ‰¾åˆ°åˆ— email çš„ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢åˆ—ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    attname,
    n_distinct,
    correlation,
    most_common_vals
FROM pg_stats
WHERE tablename = 'users' AND attname = 'email';

## 6. è¿æ¥æ± ä¼˜åŒ–

### 6.1 è¿æ¥æ•°é…ç½®

```sql
-- æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    max_conn_setting INT;
    current_conn_count INT;
    usage_percentage NUMERIC;
BEGIN
    BEGIN
        SELECT setting::INT INTO max_conn_setting FROM pg_settings WHERE name = 'max_connections';
        SELECT COUNT(*) INTO current_conn_count FROM pg_stat_activity;

        usage_percentage := (current_conn_count::NUMERIC / max_conn_setting::NUMERIC) * 100;

        RAISE NOTICE 'è¿æ¥é…ç½®:';
        RAISE NOTICE '  æœ€å¤§è¿æ¥æ•°: %', max_conn_setting;
        RAISE NOTICE '  å½“å‰è¿æ¥æ•°: %', current_conn_count;
        RAISE NOTICE '  ä½¿ç”¨ç‡: %.2f%%', usage_percentage;

        IF usage_percentage > 80 THEN
            RAISE WARNING 'è¿æ¥ä½¿ç”¨ç‡è¶…è¿‡80%%ï¼Œå»ºè®®è€ƒè™‘ä½¿ç”¨è¿æ¥æ± ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¿æ¥é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW max_connections;

-- æ¨èé…ç½®ï¼ˆè¯´æ˜ï¼‰
-- max_connections = 100          # æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´
-- superuser_reserved_connections = 3  # è¶…çº§ç”¨æˆ·ä¿ç•™è¿æ¥æ•°
-- æ³¨æ„ï¼šå®é™…é…ç½®éœ€è¦åœ¨postgresql.confä¸­è®¾ç½®æˆ–ä½¿ç”¨ALTER SYSTEM

### 6.2 ä½¿ç”¨è¿æ¥æ± 

**è¿æ¥æ± åŸç†**:

è¿æ¥æ± ï¼ˆConnection Poolï¼‰å¤ç”¨æ•°æ®åº“è¿æ¥ï¼Œå‡å°‘è¿æ¥å»ºç«‹å’Œé”€æ¯çš„å¼€é”€ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

**PgBouncer é…ç½®ç¤ºä¾‹**:

```ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
min_pool_size = 5
reserve_pool_timeout = 3
max_db_connections = 100
max_user_connections = 100
```

**PgBouncer æ¨¡å¼å¯¹æ¯”**:

| æ¨¡å¼ | è¿æ¥æ—¶é—´ | åŠŸèƒ½é™åˆ¶ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ |
|------|---------|---------|---------|------|
| **session** | é•¿ | æ—  | éœ€è¦ä¼šè¯çº§åŠŸèƒ½ | ä½ |
| **transaction** | ä¸­ | ä¸­ç­‰ | **æ¨èï¼Œé€šç”¨åœºæ™¯** | **é«˜** |
| **statement** | çŸ­ | å¤š | ç®€å•æŸ¥è¯¢ | **æœ€é«˜** |

**è¿æ¥æ± æ€§èƒ½å¯¹æ¯”** (åŸºäºå®é™…æµ‹è¯•):

| åœºæ™¯ | æ— è¿æ¥æ±  | ä½¿ç”¨è¿æ¥æ±  | æ€§èƒ½æå‡ |
|------|---------|-----------|---------|
| **è¿æ¥å»ºç«‹æ—¶é—´** | 50ms | 1ms | **50x** |
| **å¹¶å‘è¿æ¥æ•°** | 100 | 1000+ | **10x** |
| **èµ„æºå ç”¨** | é«˜ | ä½ | **60%** â¬‡ï¸ |
| **æŸ¥è¯¢å»¶è¿Ÿ** | 100ms | 80ms | **20%** â¬‡ï¸ |

**è¿æ¥æ± æœ€ä½³å®è·µ**:

1. **pool_mode**: æ¨èä½¿ç”¨ `transaction` æ¨¡å¼ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
2. **default_pool_size**: è®¾ç½®ä¸º `(max_connections - superuser_reserved_connections) / æ•°æ®åº“æ•°é‡`
3. **reserve_pool_size**: ä¿ç•™å°‘é‡è¿æ¥ç»™ç´§æ€¥æŸ¥è¯¢
4. **min_pool_size**: ä¿æŒæœ€å°è¿æ¥æ•°ï¼Œå‡å°‘è¿æ¥å»ºç«‹å»¶è¿Ÿ

**è¿æ¥æ± ç›‘æ§**:

```sql
-- PgBouncer ç»Ÿè®¡ä¿¡æ¯ï¼ˆé€šè¿‡ PgBouncer è¿æ¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹PgBouncerç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- PgBouncerå‘½ä»¤ï¼ˆéœ€è¦åœ¨PgBouncerè¿æ¥ä¸­æ‰§è¡Œï¼‰
SHOW POOLS;
SHOW STATS;
SHOW CLIENTS;
SHOW SERVERS;

-- æŸ¥çœ‹è¿æ¥æ± ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_class WHERE relname = 'pg_stat_pool') THEN
            RAISE WARNING 'pg_stat_poolè§†å›¾ä¸å­˜åœ¨ï¼ˆå¯èƒ½éœ€è¦å®‰è£…pg_stat_poolæ‰©å±•æˆ–é€šè¿‡PgBouncerè¿æ¥ï¼‰';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹è¿æ¥æ± ä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    pool_size,
    reserve_pool,
    maxwait,
    pool_mode
FROM pg_stat_pool;
```

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹: ç”µå•†å¹³å°æ€§èƒ½è°ƒä¼˜ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°éœ€è¦æ·±å…¥ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ï¼Œæ—¥è®¢å•é‡100ä¸‡+ï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´>3ç§’ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„é…ç½®è°ƒä¼˜ç­–ç•¥ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ€§èƒ½é—®é¢˜**: æŸ¥è¯¢å“åº”æ—¶é—´>3ç§’
2. **èµ„æºä½¿ç”¨**: å†…å­˜ä½¿ç”¨ç‡90%+ï¼ŒI/Oç­‰å¾…æ—¶é—´é•¿
3. **æŸ¥è¯¢ç±»å‹**: ä¸»è¦æ˜¯è®¢å•æŸ¥è¯¢å’Œå•†å“æŸ¥è¯¢
4. **æ•°æ®é‡**: è®¢å•æ•°é‡1äº¿+ï¼Œå•†å“æ•°é‡1000ä¸‡+

**é…ç½®è°ƒä¼˜ç­–ç•¥é€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºç”µå•†å¹³å°é€‰æ‹©åˆé€‚çš„é…ç½®è°ƒä¼˜ç­–ç•¥ï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šå†…å­˜é…ç½®è°ƒä¼˜**:

- **æè¿°**: ä¼˜åŒ–å†…å­˜é…ç½®å‚æ•°
- **ä¼˜ç‚¹**:
  - æ€§èƒ½æå‡æ˜¾è‘—ï¼ˆé€šå¸¸3-5å€ï¼‰
  - å®æ–½ç®€å•ï¼Œé£é™©ä½
  - æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - éœ€è¦é‡å¯æ•°æ®åº“
  - éœ€è¦è¶³å¤Ÿçš„å†…å­˜èµ„æº
- **é€‚ç”¨åœºæ™¯**: å†…å­˜å—é™åœºæ™¯
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´ä»3ç§’é™åˆ°0.8ç§’ï¼Œæ€§èƒ½æå‡3.75å€
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç¡¬ä»¶æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šæ£€æŸ¥ç‚¹é…ç½®è°ƒä¼˜**:

- **æè¿°**: ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®å‚æ•°
- **ä¼˜ç‚¹**:
  - å‡å°‘I/Oå³°å€¼ï¼Œæ€§èƒ½æå‡ï¼ˆé€šå¸¸2-3å€ï¼‰
  - å®æ–½ç®€å•ï¼Œé£é™©ä½
  - æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - éœ€è¦é‡å¯æ•°æ®åº“
  - å¯èƒ½å¢åŠ æ¢å¤æ—¶é—´
- **é€‚ç”¨åœºæ™¯**: I/Oç“¶é¢ˆåœºæ™¯
- **æ€§èƒ½æ•°æ®**: I/Oç­‰å¾…æ—¶é—´å‡å°‘60%ï¼Œæ€§èƒ½æå‡2.5å€
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ3ï¼šä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜**:

- **æè¿°**: ä¼˜åŒ–æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®å‚æ•°
- **ä¼˜ç‚¹**:
  - æŸ¥è¯¢æ€§èƒ½æå‡æ˜¾è‘—ï¼ˆé€šå¸¸5-10å€ï¼‰
  - ä¸éœ€è¦é‡å¯æ•°æ®åº“ï¼ˆä¼šè¯çº§åˆ«ï¼‰
  - æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - éœ€è¦æ·±å…¥ç†è§£ä¼˜åŒ–å™¨
  - å¯èƒ½å½±å“å…¶ä»–æŸ¥è¯¢
- **é€‚ç”¨åœºæ™¯**: æŸ¥è¯¢æ€§èƒ½é—®é¢˜
- **æ€§èƒ½æ•°æ®**: æŸ¥è¯¢æ—¶é—´ä»3ç§’é™åˆ°0.3ç§’ï¼Œæ€§èƒ½æå‡10å€
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä¸­ç­‰ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä¸­ç­‰

**æ–¹æ¡ˆ4ï¼šå¹¶è¡ŒæŸ¥è¯¢é…ç½®**:

- **æè¿°**: å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢é…ç½®
- **ä¼˜ç‚¹**:
  - å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½æå‡æ˜¾è‘—ï¼ˆé€šå¸¸5-20å€ï¼‰
  - å……åˆ†åˆ©ç”¨å¤šæ ¸CPU
  - æˆæœ¬ä½
- **ç¼ºç‚¹**:
  - éœ€è¦å¤šæ ¸CPU
  - å¯èƒ½å¢åŠ CPUä½¿ç”¨ç‡
- **é€‚ç”¨åœºæ™¯**: å¤§æ•°æ®é‡æŸ¥è¯¢
- **æ€§èƒ½æ•°æ®**: å¤§æ•°æ®é‡æŸ¥è¯¢æ—¶é—´ä»10ç§’é™åˆ°0.5ç§’ï¼Œæ€§èƒ½æå‡20å€
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç¡¬ä»¶æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ | é£é™© | é€‚ç”¨åœºæ™¯ | æˆæœ¬ | ç»¼åˆè¯„åˆ† |
|------|---------|---------|------|---------|------|---------|
| å†…å­˜é…ç½® | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å†…å­˜å—é™ | â­â­â­â­ | 4.3/5 |
| æ£€æŸ¥ç‚¹é…ç½® | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | I/Oç“¶é¢ˆ | â­â­â­â­â­ | 4.6/5 |
| ä¼˜åŒ–å™¨é…ç½® | â­â­â­â­â­ | â­â­â­ | â­â­â­ | æŸ¥è¯¢æ€§èƒ½ | â­â­â­â­â­ | 4.0/5 |
| å¹¶è¡ŒæŸ¥è¯¢é…ç½® | â­â­â­â­â­ | â­â­â­ | â­â­â­ | å¤§æ•°æ®é‡ | â­â­â­â­ | 3.7/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- æ€§èƒ½æå‡ï¼šæƒé‡40%
- å®æ–½éš¾åº¦ï¼šæƒé‡20%
- é£é™©ï¼šæƒé‡15%
- é€‚ç”¨åœºæ™¯ï¼šæƒé‡15%
- æˆæœ¬ï¼šæƒé‡10%

**è¯„åˆ†è®¡ç®—**:

- å†…å­˜é…ç½®ï¼š5.0 Ã— 0.4 + 4.0 Ã— 0.2 + 4.0 Ã— 0.15 + 4.0 Ã— 0.15 + 4.0 Ã— 0.1 = 4.3
- æ£€æŸ¥ç‚¹é…ç½®ï¼š4.0 Ã— 0.4 + 5.0 Ã— 0.2 + 5.0 Ã— 0.15 + 5.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.6
- ä¼˜åŒ–å™¨é…ç½®ï¼š5.0 Ã— 0.4 + 3.0 Ã— 0.2 + 3.0 Ã— 0.15 + 5.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.0
- å¹¶è¡ŒæŸ¥è¯¢é…ç½®ï¼š5.0 Ã— 0.4 + 3.0 Ã— 0.2 + 3.0 Ã— 0.15 + 4.0 Ã— 0.15 + 4.0 Ã— 0.1 = 3.7

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: ç»„åˆç­–ç•¥ï¼ˆå†…å­˜é…ç½®+æ£€æŸ¥ç‚¹é…ç½®+ä¼˜åŒ–å™¨é…ç½®ï¼‰

**æ¨èç†ç”±**:

1. æ€§èƒ½æå‡æ˜¾è‘—ï¼Œæ»¡è¶³æ€§èƒ½è¦æ±‚ï¼ˆ<1ç§’ï¼‰
2. å®æ–½éš¾åº¦é€‚ä¸­ï¼Œé£é™©å¯æ§
3. æˆæœ¬åˆç†
4. é€‚åˆç”µå•†å¹³å°åœºæ™¯

**å®æ–½å»ºè®®**:

1. å…ˆè¿›è¡Œå†…å­˜é…ç½®è°ƒä¼˜ï¼Œä¼˜åŒ–shared_bufferså’Œwork_mem
2. ç„¶åè¿›è¡Œæ£€æŸ¥ç‚¹é…ç½®è°ƒä¼˜ï¼Œå‡å°‘I/Oå³°å€¼
3. æœ€åè¿›è¡Œä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜ï¼Œä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
4. ç›‘æ§æ€§èƒ½ï¼Œæ ¹æ®å®é™…æ•ˆæœè°ƒæ•´

**è§£å†³æ–¹æ¡ˆ**:

**ä¸šåŠ¡åœºæ™¯**:

æŸç”µå•†å¹³å°æ•°æ®åº“æ€§èƒ½ä¸‹é™ï¼ŒæŸ¥è¯¢å»¶è¿Ÿä» 50ms å¢åŠ åˆ° 500msï¼Œéœ€è¦ä¼˜åŒ–é…ç½®ã€‚

**é—®é¢˜åˆ†æ**:

1. **å†…å­˜é…ç½®ä¸è¶³**: `shared_buffers` åªæœ‰ 128MBï¼Œç¼“å­˜å‘½ä¸­ç‡ä»… 60%
2. **è¿æ¥æ•°è¿‡å¤š**: 1000+ å¹¶å‘è¿æ¥ï¼Œæ²¡æœ‰ä½¿ç”¨è¿æ¥æ± 
3. **æ£€æŸ¥ç‚¹é¢‘ç¹**: æ£€æŸ¥ç‚¹æ¯ 5 åˆ†é’Ÿè§¦å‘ï¼ŒI/O å³°å€¼é«˜

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. ä¼˜åŒ–å†…å­˜é…ç½®ï¼ˆ32GB RAM æœåŠ¡å™¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET shared_buffers = '8GB';
        ALTER SYSTEM SET work_mem = '64MB';
        ALTER SYSTEM SET maintenance_work_mem = '2GB';
        ALTER SYSTEM SET effective_cache_size = '24GB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å†…å­˜é…ç½®ï¼ˆ32GB RAMæœåŠ¡å™¨ï¼‰å·²ä¼˜åŒ–å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'ä¼˜åŒ–å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET checkpoint_timeout = '15min';
        ALTER SYSTEM SET max_wal_size = '2GB';
        ALTER SYSTEM SET checkpoint_completion_target = 0.9;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'æ£€æŸ¥ç‚¹é…ç½®å·²ä¼˜åŒ–å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä½¿ç”¨ PgBouncer è¿æ¥æ± ï¼ˆè¯´æ˜ï¼‰
-- æ³¨æ„ï¼šPgBounceré…ç½®éœ€è¦åœ¨PgBounceré…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œæ— æ³•é€šè¿‡SQLç›´æ¥é…ç½®
-- æ¨èé…ç½®: max_client_conn = 1000, default_pool_size = 100

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
| --- | --- | --- | --- |
| **æŸ¥è¯¢å»¶è¿Ÿ (P95)** | 500ms | 50ms | **90%** â¬‡ï¸ |
| **ç¼“å­˜å‘½ä¸­ç‡** | 60% | 95% | **58%** â¬‡ï¸ |
| **æ£€æŸ¥ç‚¹ I/O å³°å€¼** | é«˜ | ä½ | **å¹³æ»‘** |
| **å¹¶å‘è¿æ¥æ•°** | 100 | 1000+ | **10x** |

### 7.2 æ¡ˆä¾‹: æ•°æ®åˆ†æç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**:

æ•°æ®åˆ†æç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡èšåˆæŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ—¶é—´ä» 10 ç§’å¢åŠ åˆ° 60 ç§’ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. å¢åŠ  work_memï¼ˆæ”¯æŒå¤§æ’åºå’Œå“ˆå¸Œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET work_mem = '256MB';
        PERFORM pg_reload_conf();
        RAISE NOTICE 'work_mem å·²å¢åŠ å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'å¢åŠ  work_mem å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
        ALTER SYSTEM SET max_parallel_workers = 8;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET default_statistics_target = 500;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯é…ç½®å·²ä¼˜åŒ–å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

**ä¼˜åŒ–æ•ˆæœ**:

- èšåˆæŸ¥è¯¢æ—¶é—´: ä» 60 ç§’é™ä½åˆ° 15 ç§’ï¼ˆ**75%** â¬‡ï¸ï¼‰
- å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½: æå‡ **4 å€**

## 8. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ†ææ…¢æŸ¥è¯¢

```sql
-- ä»»åŠ¡: åˆ†æå¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- 1. å¯ç”¨ pg_stat_statementsï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION pg_stat_statements;
            RAISE NOTICE 'pg_stat_statements æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pg_stat_statements æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pg_stat_statements æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pg_stat_statements æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. è¿è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•è¿è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¿è¡ŒæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;

-- 3. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆå·²åœ¨ä¸Šé¢æ‰§è¡ŒEXPLAIN (ANALYZE, BUFFERS, TIMING)ï¼‰

-- 4. åˆ›å»ºç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND indexname = 'idx_orders_user_id') THEN
            CREATE INDEX idx_orders_user_id ON orders(user_id);
            RAISE NOTICE 'ç´¢å¼• idx_orders_user_id åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_orders_user_id å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_user_id å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. å†æ¬¡æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ users æˆ– orders ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ä¼˜åŒ–åçš„æ‰§è¡Œè®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰§è¡Œè®¡åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT u.name, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;
```

### ç»ƒä¹  2: é…ç½®ä¼˜åŒ–

```sql
-- ä»»åŠ¡: æ ¹æ®æœåŠ¡å™¨é…ç½®ä¼˜åŒ– PostgreSQLï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- 1. æŸ¥çœ‹å½“å‰é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    shared_buffers_setting TEXT;
    work_mem_setting TEXT;
    effective_cache_size_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO shared_buffers_setting FROM pg_settings WHERE name = 'shared_buffers';
        SELECT setting INTO work_mem_setting FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO effective_cache_size_setting FROM pg_settings WHERE name = 'effective_cache_size';

        RAISE NOTICE 'å½“å‰é…ç½®:';
        RAISE NOTICE '  shared_buffers: %', shared_buffers_setting;
        RAISE NOTICE '  work_mem: %', work_mem_setting;
        RAISE NOTICE '  effective_cache_size: %', effective_cache_size_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å½“å‰é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW shared_buffers;
SHOW work_mem;
SHOW effective_cache_size;

-- 2. è®¡ç®—æ¨èå€¼ï¼ˆå‡è®¾ 16GB RAMï¼‰
-- shared_buffers = 4GBï¼ˆç³»ç»Ÿå†…å­˜çš„25%ï¼‰
-- work_mem = 32MBï¼ˆæ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´ï¼‰
-- effective_cache_size = 12GBï¼ˆç³»ç»Ÿå†…å­˜çš„75%ï¼‰

-- 3. ä¿®æ”¹é…ç½®ï¼ˆéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        -- æ³¨æ„ï¼šä»¥ä¸‹é…ç½®éœ€è¦æ ¹æ®å®é™…æœåŠ¡å™¨å†…å­˜è°ƒæ•´
        -- ALTER SYSTEM SET shared_buffers = '4GB';
        -- ALTER SYSTEM SET work_mem = '32MB';
        -- ALTER SYSTEM SET effective_cache_size = '12GB';
        -- PERFORM pg_reload_conf();

        RAISE NOTICE 'é…ç½®ä¼˜åŒ–å»ºè®®ï¼šæ ¹æ®16GB RAMæœåŠ¡å™¨ï¼Œå»ºè®®è®¾ç½®shared_buffers=4GB, work_mem=32MB, effective_cache_size=12GB';
        RAISE NOTICE 'æ³¨æ„ï¼šè¿™äº›é…ç½®å¯ä»¥é€šè¿‡ALTER SYSTEMè®¾ç½®ï¼Œæˆ–ç›´æ¥åœ¨postgresql.confä¸­ç¼–è¾‘';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 9. æœ€ä½³å®è·µ

### 9.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™

**æ¨èåšæ³•**ï¼š

1. **æµ‹é‡ä¼˜å…ˆ**ï¼ˆå…ˆæµ‹é‡å†ä¼˜åŒ–ï¼Œé¿å…ç›²ç›®ä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå…ˆæµ‹é‡æ€§èƒ½åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   -- 1. å¯ç”¨ pg_stat_statementsï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
               CREATE EXTENSION pg_stat_statements;
               RAISE NOTICE 'pg_stat_statements æ‰©å±•åˆ›å»ºæˆåŠŸ';
           ELSE
               RAISE NOTICE 'pg_stat_statements æ‰©å±•å·²å­˜åœ¨';
           END IF;
       EXCEPTION
           WHEN insufficient_privilege THEN
               RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pg_stat_statements æ‰©å±•';
           WHEN OTHERS THEN
               RAISE WARNING 'åˆ›å»º pg_stat_statements æ‰©å±•å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   -- 2. è¿è¡ŒæŸ¥è¯¢å¹¶è®°å½•æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
               RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•è¿è¡ŒæŸ¥è¯¢';
               RETURN;
           END IF;
           RAISE NOTICE 'å¼€å§‹æµ‹é‡æŸ¥è¯¢æ€§èƒ½';
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   EXPLAIN (ANALYZE, BUFFERS, TIMING) SELECT * FROM users WHERE email = 'john@example.com';

   -- 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
               RAISE WARNING 'pg_stat_statements æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯';
               RETURN;
           END IF;
           RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯';
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   EXPLAIN (ANALYZE, BUFFERS, TIMING)
   SELECT query, calls, mean_exec_time, total_exec_time
   FROM pg_stat_statements
   WHERE query LIKE '%users%';

   -- 4. ä¼˜åŒ–åå†æ¬¡æµ‹é‡
   -- 5. å¯¹æ¯”ä¼˜åŒ–æ•ˆæœ
   ```

1. **ç³»ç»ŸåŒ–è°ƒä¼˜**ï¼ˆæŒ‰ä¼˜å…ˆçº§ç³»ç»ŸåŒ–ä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæŒ‰ä¼˜å…ˆçº§è°ƒä¼˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   -- ä¼˜å…ˆçº§1ï¼šç´¢å¼•ä¼˜åŒ–ï¼ˆå½±å“æœ€å¤§ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
               RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
               RETURN;
           END IF;

           IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND indexname = 'idx_users_email') THEN
               CREATE INDEX idx_users_email ON users(email);
               RAISE NOTICE 'ç´¢å¼• idx_users_email åˆ›å»ºæˆåŠŸ';
           ELSE
               RAISE NOTICE 'ç´¢å¼• idx_users_email å·²å­˜åœ¨';
           END IF;
       EXCEPTION
           WHEN undefined_table THEN
               RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
           WHEN duplicate_table THEN
               RAISE WARNING 'ç´¢å¼• idx_users_email å·²å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   -- ä¼˜å…ˆçº§2ï¼šæŸ¥è¯¢ä¼˜åŒ–ï¼ˆé‡å†™æŸ¥è¯¢ï¼‰
   -- ä¼˜åŒ–å‰ï¼šSELECT * FROM users WHERE name LIKE '%john%';
   -- ä¼˜åŒ–åï¼šä½¿ç”¨å…¨æ–‡æœç´¢æˆ–ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶
   -- æ³¨æ„ï¼šæŸ¥è¯¢ä¼˜åŒ–éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œ

   -- ä¼˜å…ˆçº§3ï¼šé…ç½®ä¼˜åŒ–ï¼ˆå¾®è°ƒï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
               RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
           END IF;

           ALTER SYSTEM SET work_mem = '64MB';
           PERFORM pg_reload_conf();
           RAISE NOTICE 'work_mem é…ç½®å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
       EXCEPTION
           WHEN insufficient_privilege THEN
               RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
           WHEN OTHERS THEN
               RAISE WARNING 'é…ç½®ä¼˜åŒ–å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   -- ä¼˜å…ˆçº§4ï¼šæ¶æ„ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰
   -- åˆ†åŒºè¡¨ã€è¯»å†™åˆ†ç¦»ç­‰
   -- æ³¨æ„ï¼šæ¶æ„ä¼˜åŒ–éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè®¾è®¡å’Œå®æ–½
   ```

1. **æŒç»­ç›‘æ§å’Œä¼˜åŒ–**ï¼ˆå»ºç«‹ç›‘æ§ä½“ç³»ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   -- 1. æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
               RAISE WARNING 'pg_stat_statements æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•ç›‘æ§æ…¢æŸ¥è¯¢';
               RETURN;
           END IF;
           RAISE NOTICE 'å¼€å§‹ç›‘æ§æ…¢æŸ¥è¯¢';
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'æ…¢æŸ¥è¯¢ç›‘æ§å‡†å¤‡å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   EXPLAIN (ANALYZE, BUFFERS, TIMING)
   SELECT query, calls, mean_exec_time
   FROM pg_stat_statements
   WHERE mean_exec_time > 100
   ORDER BY mean_exec_time DESC
   LIMIT 20;

   -- 2. ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
   DO $$
   DECLARE
       cache_hit_ratio NUMERIC;
   BEGIN
       BEGIN
           SELECT
               CASE
                   WHEN (sum(heap_blks_hit) + sum(heap_blks_read)) > 0
                   THEN sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read))::float * 100
                   ELSE 0
               END INTO cache_hit_ratio
           FROM pg_statio_user_tables;

           IF cache_hit_ratio < 80 THEN
               RAISE WARNING 'ç¼“å­˜å‘½ä¸­ç‡ %.2f%% ä½äº80%%ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–', cache_hit_ratio;
           ELSE
               RAISE NOTICE 'ç¼“å­˜å‘½ä¸­ç‡ %.2f%% æ­£å¸¸', cache_hit_ratio;
           END IF;
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   EXPLAIN (ANALYZE, BUFFERS, TIMING)
   SELECT
       sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read))::float * 100 AS cache_hit_ratio
   FROM pg_statio_user_tables;

   -- 3. è¿æ¥æ•°ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   SELECT count(*) FROM pg_stat_activity;

   -- 4. ç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§
   SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read
   FROM pg_stat_user_indexes
   WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
   ORDER BY pg_relation_size(indexrelid) DESC;
   ```

1. **æ–‡æ¡£åŒ–è°ƒä¼˜è¿‡ç¨‹**ï¼ˆè®°å½•è°ƒä¼˜è¿‡ç¨‹å’Œç»“æœï¼‰

   ```sql
   -- âœ… å¥½ï¼šè®°å½•è°ƒä¼˜è¿‡ç¨‹
   -- 1. è®°å½•ä¼˜åŒ–å‰æ€§èƒ½
   -- æŸ¥è¯¢ï¼šSELECT * FROM users WHERE email = 'john@example.com';
   -- ä¼˜åŒ–å‰ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´ 500msï¼ŒSeq Scan

   -- 2. è®°å½•ä¼˜åŒ–æªæ–½
   -- åˆ›å»ºç´¢å¼•ï¼šCREATE INDEX idx_users_email ON users(email);

   -- 3. è®°å½•ä¼˜åŒ–åæ€§èƒ½
   -- ä¼˜åŒ–åï¼šå¹³å‡æ‰§è¡Œæ—¶é—´ 5msï¼ŒIndex Scan

   -- 4. è®°å½•ä¼˜åŒ–æ•ˆæœ
   -- æ€§èƒ½æå‡ï¼š100å€ï¼ˆ500ms -> 5msï¼‰
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…ç›²ç›®ä¼˜åŒ–**ï¼ˆä¸æµ‹é‡å°±ä¼˜åŒ–ï¼Œå¯èƒ½é€‚å¾—å…¶åï¼‰
2. **é¿å…è¿‡åº¦ä¼˜åŒ–**ï¼ˆä¼˜åŒ–æˆæœ¬å¯èƒ½è¶…è¿‡æ”¶ç›Šï¼‰
3. **é¿å…å¿½ç•¥ç›‘æ§**ï¼ˆæ— æ³•å‘ç°æ€§èƒ½é—®é¢˜ï¼‰
4. **é¿å…ä¸è®°å½•**ï¼ˆæ— æ³•è¿½è¸ªä¼˜åŒ–æ•ˆæœï¼‰

### 9.2 è°ƒä¼˜å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **æ ¹æ®ç¡¬ä»¶å’Œè´Ÿè½½è°ƒä¼˜é…ç½®**ï¼ˆé’ˆå¯¹æ€§ä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šæ ¹æ®ç¡¬ä»¶é…ç½®
   -- 16GB RAM æœåŠ¡å™¨
   ALTER SYSTEM SET shared_buffers = '4GB';  -- 25% RAM
   ALTER SYSTEM SET work_mem = '64MB';
   ALTER SYSTEM SET effective_cache_size = '10GB';  -- 50-75% RAM

   -- âœ… å¥½ï¼šæ ¹æ®è´Ÿè½½ç±»å‹
   -- OLTPï¼ˆé«˜å¹¶å‘ã€å°äº‹åŠ¡ï¼‰
   ALTER SYSTEM SET work_mem = '16MB';
   ALTER SYSTEM SET max_connections = 200;

   -- OLAPï¼ˆå¤§æŸ¥è¯¢ã€åˆ†æï¼‰
   ALTER SYSTEM SET work_mem = '256MB';
   ALTER SYSTEM SET max_connections = 50;
   ```

2. **ä¼˜åŒ–æ…¢æŸ¥è¯¢**ï¼ˆè¯†åˆ«å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼‰

   ```sql
   -- âœ… å¥½ï¼šè¯†åˆ«æ…¢æŸ¥è¯¢
   SELECT query, calls, mean_exec_time, total_exec_time
   FROM pg_stat_statements
   WHERE mean_exec_time > 100
   ORDER BY mean_exec_time DESC
   LIMIT 20;

   -- âœ… å¥½ï¼šåˆ†ææ…¢æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
   EXPLAIN (ANALYZE, BUFFERS, TIMING)
   SELECT * FROM users WHERE email = 'john@example.com';

   -- âœ… å¥½ï¼šä¼˜åŒ–æ…¢æŸ¥è¯¢
   -- 1. åˆ›å»ºç´¢å¼•
   CREATE INDEX idx_users_email ON users(email);

   -- 2. é‡å†™æŸ¥è¯¢
   -- ä¼˜åŒ–å‰ï¼šSELECT * FROM users WHERE name LIKE '%john%';
   -- ä¼˜åŒ–åï¼šä½¿ç”¨å…¨æ–‡æœç´¢æˆ–ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶

   -- 3. ä½¿ç”¨ç‰©åŒ–è§†å›¾
   CREATE MATERIALIZED VIEW user_summary AS
   SELECT user_id, COUNT(*) AS order_count
   FROM orders
   GROUP BY user_id;
   ```

3. **åˆ›å»ºå’Œç»´æŠ¤ç´¢å¼•**ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šåˆ›å»ºåˆé€‚çš„ç´¢å¼•
   -- 1. ä¸»é”®å’Œå¤–é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
   CREATE TABLE orders (
       id SERIAL PRIMARY KEY,
       user_id INTEGER REFERENCES users(id)
   );

   -- 2. æŸ¥è¯¢æ¡ä»¶åˆ—ç´¢å¼•
   CREATE INDEX idx_users_email ON users(email);
   CREATE INDEX idx_orders_status ON orders(status);

   -- 3. å¤åˆç´¢å¼•ï¼ˆå¤šåˆ—æŸ¥è¯¢ï¼‰
   CREATE INDEX idx_orders_user_status ON orders(user_id, status);

   -- 4. éƒ¨åˆ†ç´¢å¼•ï¼ˆè¿‡æ»¤æ¡ä»¶ï¼‰
   CREATE INDEX idx_orders_active ON orders(user_id) WHERE status = 'active';

   -- âœ… å¥½ï¼šç»´æŠ¤ç´¢å¼•
   -- 1. å®šæœŸé‡å»ºç´¢å¼•ï¼ˆå¤§è¡¨ï¼‰
   REINDEX TABLE large_table;

   -- 2. åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
   SELECT schemaname, tablename, indexname
   FROM pg_stat_user_indexes
   WHERE idx_scan = 0;
   ```

4. **ä¼˜åŒ–æ•°æ®åº“æ¶æ„**ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

   ```sql
   -- âœ… å¥½ï¼šä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆå¤§è¡¨ï¼‰
   CREATE TABLE orders (
       id BIGSERIAL,
       order_date DATE NOT NULL,
       ...
   ) PARTITION BY RANGE (order_date);

   -- âœ… å¥½ï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰
   CREATE MATERIALIZED VIEW user_order_summary AS
   SELECT u.id, u.name, COUNT(o.id) AS order_count, SUM(o.total) AS total_amount
   FROM users u
   LEFT JOIN orders o ON u.id = o.user_id
   GROUP BY u.id, u.name;

   -- âœ… å¥½ï¼šè¯»å†™åˆ†ç¦»ï¼ˆé«˜å¹¶å‘ï¼‰
   -- å†™æ“ä½œï¼šä¸»åº“
   -- è¯»æ“ä½œï¼šä»åº“
   ```

5. **ä½¿ç”¨è¿æ¥æ± **ï¼ˆå‡å°‘è¿æ¥å¼€é”€ï¼‰

   ```ini
   # âœ… å¥½ï¼šä½¿ç”¨ PgBouncer è¿æ¥æ± 
   [pgbouncer]
   pool_mode = transaction
   max_client_conn = 1000
   default_pool_size = 25
   ```

6. **å®šæœŸç»´æŠ¤**ï¼ˆä¿æŒæ€§èƒ½ï¼‰

   ```sql
   -- âœ… å¥½ï¼šå®šæœŸ VACUUM å’Œ ANALYZEï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
               VACUUM ANALYZE users;
               RAISE NOTICE 'VACUUM ANALYZE users æ‰§è¡ŒæˆåŠŸ';
           ELSE
               RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨';
           END IF;

           IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
               VACUUM ANALYZE orders;
               RAISE NOTICE 'VACUUM ANALYZE orders æ‰§è¡ŒæˆåŠŸ';
           ELSE
               RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨';
           END IF;
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'VACUUM ANALYZEæ‰§è¡Œå¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   -- âœ… å¥½ï¼šå®šæœŸé‡å»ºç´¢å¼•ï¼ˆå¤§è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
               REINDEX TABLE large_table;
               RAISE NOTICE 'REINDEX TABLE large_table æ‰§è¡ŒæˆåŠŸ';
           ELSE
               RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
           END IF;
       EXCEPTION
           WHEN undefined_table THEN
               RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE WARNING 'REINDEXæ‰§è¡Œå¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;

   -- âœ… å¥½ï¼šå®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           ANALYZE;
           RAISE NOTICE 'ANALYZE æ‰§è¡ŒæˆåŠŸ';
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'ANALYZEæ‰§è¡Œå¤±è´¥: %', SQLERRM;
               RAISE;
       END;
   END $$;
   ```

**é¿å…åšæ³•**ï¼š

1. **é¿å…è¿‡åº¦ç´¢å¼•**ï¼ˆç´¢å¼•è¿‡å¤šå½±å“å†™å…¥æ€§èƒ½ï¼‰
2. **é¿å…å¿½ç•¥ç»Ÿè®¡ä¿¡æ¯**ï¼ˆä¼˜åŒ–å™¨å†³ç­–é”™è¯¯ï¼‰
3. **é¿å…å¿½ç•¥ç»´æŠ¤**ï¼ˆæ€§èƒ½é€æ¸ä¸‹é™ï¼‰
4. **é¿å…ä¸ç›‘æ§**ï¼ˆæ— æ³•å‘ç°æ€§èƒ½é—®é¢˜ï¼‰
5. **é¿å…ä¸€åˆ€åˆ‡**ï¼ˆä¸åŒåœºæ™¯éœ€è¦ä¸åŒé…ç½®ï¼‰

## 10. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 10.1 æ€§èƒ½è°ƒä¼˜åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•è¯†åˆ«ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE EXCEPTION 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…æ‰©å±•';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥æ…¢æŸ¥è¯¢';
    EXCEPTION
        WHEN undefined_file THEN
            RAISE EXCEPTION 'pg_stat_statementsæ‰©å±•æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•ï¼‰';
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT query, calls, mean_exec_time, total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 2. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read))::float * 100 AS cache_hit_ratio
FROM pg_statio_user_tables;

-- 3. æ£€æŸ¥I/Oç­‰å¾…
SELECT * FROM pg_stat_io WHERE object = 'relation';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨pg_stat_statementsè¯†åˆ«æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            CREATE EXTENSION pg_stat_statements;
            RAISE NOTICE 'pg_stat_statements æ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'pg_stat_statements æ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»º pg_stat_statements æ‰©å±•';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»º pg_stat_statements æ‰©å±•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææ‰§è¡Œè®¡åˆ’ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†ææ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹åˆ†ææ‰§è¡Œè®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM large_table WHERE condition;

-- 3. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    unused_index_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO unused_index_count
        FROM pg_stat_user_indexes
        WHERE idx_scan = 0;

        IF unused_index_count > 0 THEN
            RAISE WARNING 'å‘ç° % ä¸ªæœªä½¿ç”¨çš„ç´¢å¼•', unused_index_count;
        ELSE
            RAISE NOTICE 'æœªå‘ç°æœªä½¿ç”¨çš„ç´¢å¼•';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0;  -- æœªä½¿ç”¨çš„ç´¢å¼•
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— è¯Šæ–­ï¼šç›²ç›®ä¼˜åŒ–ï¼Œæ•ˆæœä¸æ˜æ˜¾
- æœ‰è¯Šæ–­ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡ **10-100å€**

#### Q2: å¦‚ä½•ä¼˜åŒ–å†…å­˜é…ç½®ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•é…ç½®å†…å­˜å‚æ•°ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥å½“å‰é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    shared_buffers_val TEXT;
    work_mem_val TEXT;
    effective_cache_size_val TEXT;
BEGIN
    BEGIN
        SELECT setting INTO shared_buffers_val FROM pg_settings WHERE name = 'shared_buffers';
        SELECT setting INTO work_mem_val FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO effective_cache_size_val FROM pg_settings WHERE name = 'effective_cache_size';

        RAISE NOTICE 'å½“å‰é…ç½®:';
        RAISE NOTICE '  shared_buffers: %', shared_buffers_val;
        RAISE NOTICE '  work_mem: %', work_mem_val;
        RAISE NOTICE '  effective_cache_size: %', effective_cache_size_val;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'effective_cache_size')
ORDER BY name;

-- 2. æ£€æŸ¥ç³»ç»Ÿå†…å­˜
-- åœ¨æ“ä½œç³»ç»ŸæŸ¥çœ‹ï¼šfree -h
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æ ¹æ®æœåŠ¡å™¨å†…å­˜é…ç½®ï¼ˆ16GB RAMç¤ºä¾‹ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET shared_buffers = '4GB';  -- 25% RAM
        ALTER SYSTEM SET work_mem = '64MB';
        ALTER SYSTEM SET maintenance_work_mem = '1GB';
        ALTER SYSTEM SET effective_cache_size = '12GB';  -- 75% RAM
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å†…å­˜é…ç½®ï¼ˆ16GB RAMæœåŠ¡å™¨ï¼‰å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é‡å¯PostgreSQLä½¿é…ç½®ç”Ÿæ•ˆï¼ˆæ³¨æ„ï¼šæŸäº›å‚æ•°éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰
-- systemctl restart postgresql

-- 3. éªŒè¯é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    shared_buffers_setting TEXT;
BEGIN
    BEGIN
        SELECT setting INTO shared_buffers_setting FROM pg_settings WHERE name = 'shared_buffers';
        RAISE NOTICE 'å½“å‰ shared_buffers é…ç½®: %', shared_buffers_setting;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, source
FROM pg_settings
WHERE name = 'shared_buffers';
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- é»˜è®¤é…ç½®ï¼šç¼“å­˜å‘½ä¸­ç‡ **60%**ï¼ŒæŸ¥è¯¢æ—¶é—´ **500ms**
- ä¼˜åŒ–é…ç½®ï¼šç¼“å­˜å‘½ä¸­ç‡ **95%**ï¼ŒæŸ¥è¯¢æ—¶é—´ **50ms**
- **æ€§èƒ½æå‡ï¼š10å€**

### 10.2 é…ç½®è°ƒä¼˜å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šæ£€æŸ¥ç‚¹é¢‘ç¹ï¼Œå½±å“I/Oæ€§èƒ½ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    checkpoint_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO checkpoint_count FROM pg_stat_bgwriter;
        IF checkpoint_count = 0 THEN
            RAISE WARNING 'æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
        ELSE
            RAISE NOTICE 'å¼€å§‹æŸ¥è¯¢æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time
FROM pg_stat_bgwriter;

-- 2. æ£€æŸ¥WALå¤§å°
SELECT pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0'));
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½®ï¼ˆé«˜å†™å…¥è´Ÿè½½ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = current_user AND rolsuper = true) THEN
            RAISE EXCEPTION 'éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ¥é…ç½®ç³»ç»Ÿå‚æ•°';
        END IF;

        ALTER SYSTEM SET checkpoint_timeout = '15min';
        ALTER SYSTEM SET max_wal_size = '2GB';
        ALTER SYSTEM SET checkpoint_completion_target = 0.9;
        PERFORM pg_reload_conf();
        RAISE NOTICE 'æ£€æŸ¥ç‚¹é…ç½®ï¼ˆé«˜å†™å…¥è´Ÿè½½ï¼‰å·²è®¾ç½®å¹¶é‡æ–°åŠ è½½';
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¾ç½®ç³»ç»Ÿå‚æ•°';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é‡å¯PostgreSQLï¼ˆæ³¨æ„ï¼šæŸäº›å‚æ•°éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰
-- systemctl restart postgresql

-- 3. ç›‘æ§æ£€æŸ¥ç‚¹æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    avg_write_time NUMERIC;
BEGIN
    BEGIN
        SELECT
            CASE
                WHEN (checkpoints_timed + checkpoints_req) > 0
                THEN checkpoint_write_time / (checkpoints_timed + checkpoints_req)
                ELSE 0
            END INTO avg_write_time
        FROM pg_stat_bgwriter;

        IF avg_write_time > 1000 THEN
            RAISE WARNING 'æ£€æŸ¥ç‚¹å¹³å‡å†™å…¥æ—¶é—´ %.2f ms è¶…è¿‡1000msï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–', avg_write_time;
        ELSE
            RAISE NOTICE 'æ£€æŸ¥ç‚¹å¹³å‡å†™å…¥æ—¶é—´ %.2f msï¼Œæ€§èƒ½æ­£å¸¸', avg_write_time;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æ§æ£€æŸ¥ç‚¹æ€§èƒ½å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoint_write_time / (checkpoints_timed + checkpoints_req) AS avg_write_time
FROM pg_stat_bgwriter;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- é»˜è®¤é…ç½®ï¼šæ£€æŸ¥ç‚¹I/Oå³°å€¼é«˜ï¼ŒæŸ¥è¯¢å»¶è¿Ÿ **100ms**
- ä¼˜åŒ–é…ç½®ï¼šæ£€æŸ¥ç‚¹I/Oå¹³æ»‘ï¼ŒæŸ¥è¯¢å»¶è¿Ÿ **50ms**
- **æ€§èƒ½æå‡ï¼š2å€**

## 11. å‚è€ƒèµ„æ–™

### 11.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æç¤º](https://www.postgresql.org/docs/current/performance-tips.html)**
  - æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—
  - æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€å·§

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é…ç½®å‚æ•°](https://www.postgresql.org/docs/current/runtime-config.html)**
  - æ‰€æœ‰é…ç½®å‚æ•°è¯´æ˜
  - å‚æ•°è°ƒä¼˜æŒ‡å—

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](https://www.postgresql.org/docs/current/planner-stats.html)**
  - ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æœºåˆ¶
  - ANALYZE å‘½ä»¤è¯¦è§£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html)**
  - EXPLAIN å‘½ä»¤è¯¦è§£
  - æ‰§è¡Œè®¡åˆ’åˆ†æ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - æ€§èƒ½ç›‘æ§å·¥å…·å’Œæ–¹æ³•
  - æ…¢æŸ¥è¯¢è¯Šæ–­

### 9.2 æŠ€æœ¯è®ºæ–‡

- **Graefe, G. (1995). "The Cascades Framework for Query Optimization."**
  - æœŸåˆŠ: IEEE Data Engineering Bulletin, 18(3), 19-29
  - **é‡è¦æ€§**: æŸ¥è¯¢ä¼˜åŒ–å™¨æ¡†æ¶è®¾è®¡çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº† Cascades æŸ¥è¯¢ä¼˜åŒ–æ¡†æ¶ï¼Œå½±å“äº†ç°ä»£æ•°æ®åº“ä¼˜åŒ–å™¨çš„è®¾è®¡

- **Leis, V., et al. (2015). "How Good Are Query Optimizers?"**
  - ä¼šè®®: SIGMOD 2015
  - è®ºæ–‡é“¾æ¥: [arXiv:1504.01155](https://arxiv.org/abs/1504.01155)
  - **é‡è¦æ€§**: ç°ä»£æŸ¥è¯¢ä¼˜åŒ–å™¨æ€§èƒ½è¯„ä¼°ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°è¯„ä¼°äº†ç°ä»£æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æ€§èƒ½ï¼Œå‘ç°äº†ä¼˜åŒ–å™¨çš„å±€é™æ€§

- **Chaudhuri, S., & Narasayya, V. (1997).
  "An efficient cost-driven index selection tool for Microsoft SQL Server."**
  - ä¼šè®®: VLDB 1997
  - **é‡è¦æ€§**: è‡ªåŠ¨ç´¢å¼•æ¨èé¢†åŸŸçš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†åŸºäºæˆæœ¬æ¨¡å‹çš„è‡ªåŠ¨ç´¢å¼•é€‰æ‹©å·¥å…·ï¼Œä¸ºæ€§èƒ½ä¼˜åŒ–æä¾›äº†ç†è®ºåŸºç¡€

### 9.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - æ€§èƒ½ä¼˜åŒ–](https://www.postgresql.org/docs/current/performance-tips.html)**
  - æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ
  - æ€§èƒ½è°ƒä¼˜æŠ€å·§

- **[2ndQuadrant - PostgreSQL æ€§èƒ½è°ƒä¼˜](https://www.2ndquadrant.com/en/blog/postgresql-performance-tuning/)**
  - æ€§èƒ½è°ƒä¼˜å®æˆ˜
  - æ€§èƒ½æå‡æ¡ˆä¾‹

- **[Percona - PostgreSQL æ€§èƒ½ä¼˜åŒ–](https://www.percona.com/blog/postgresql-performance-optimization/)**
  - æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
  - æ…¢æŸ¥è¯¢è¯Šæ–­å’Œä¼˜åŒ–

- **[EnterpriseDB - PostgreSQL æ€§èƒ½è°ƒä¼˜](https://www.enterprisedb.com/postgres-tutorials/postgresql-performance-tuning)**
  - æ€§èƒ½è°ƒä¼˜æ·±å…¥è§£æ
  - é…ç½®å‚æ•°ä¼˜åŒ–æŒ‡å—

### 9.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Performance Optimization](https://wiki.postgresql.org/wiki/Performance_Optimization)**
  - æ€§èƒ½ä¼˜åŒ–æŠ€å·§
  - å®é™…ä¼˜åŒ–æ¡ˆä¾‹

- **[PostgreSQL Wiki - Slow Query](https://wiki.postgresql.org/wiki/Slow_Query)**
  - æ…¢æŸ¥è¯¢è¯Šæ–­æ–¹æ³•
  - æ…¢æŸ¥è¯¢ä¼˜åŒ–æ¡ˆä¾‹

- **[Stack Overflow - PostgreSQL Performance](https://stackoverflow.com/questions/tagged/postgresql+performance)**
  - æ€§èƒ½ç›¸å…³é—®é¢˜è§£ç­”
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[pg_stat_statements æ‰©å±•æ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html)**
  - æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯æ‰©å±•
  - æ…¢æŸ¥è¯¢åˆ†æå·¥å…·

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æç¤º](https://www.postgresql.org/docs/current/performance-tips.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é…ç½®](https://www.postgresql.org/docs/current/runtime-config.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-12

```
