---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQLåŸ¹è®­\11-æ€§èƒ½è°ƒä¼˜\æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQL æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-24

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•](#postgresql-æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 æ€§èƒ½æµ‹è¯•ä½“ç³»æ€ç»´å¯¼å›¾](#14-æ€§èƒ½æµ‹è¯•ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰](#2-æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰)
    - [2.0 æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰](#20-æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰)
    - [2.1 æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ](#21-æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ)
  - [3. æµ‹è¯•å·¥å…·](#3-æµ‹è¯•å·¥å…·)
    - [3.1 pgbench](#31-pgbench)
    - [3.2 è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬](#32-è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬)
  - [4. åŸºå‡†æµ‹è¯•](#4-åŸºå‡†æµ‹è¯•)
    - [4.1 TPC-C åŸºå‡†æµ‹è¯•](#41-tpc-c-åŸºå‡†æµ‹è¯•)
    - [4.2 è‡ªå®šä¹‰åŸºå‡†æµ‹è¯•](#42-è‡ªå®šä¹‰åŸºå‡†æµ‹è¯•)
  - [5. å‹åŠ›æµ‹è¯•](#5-å‹åŠ›æµ‹è¯•)
    - [5.1 å¹¶å‘å‹åŠ›æµ‹è¯•](#51-å¹¶å‘å‹åŠ›æµ‹è¯•)
    - [5.2 è´Ÿè½½æµ‹è¯•](#52-è´Ÿè½½æµ‹è¯•)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1 æ¡ˆä¾‹: æ•°æ®åº“æ€§èƒ½æµ‹è¯•ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#61-æ¡ˆä¾‹-æ•°æ®åº“æ€§èƒ½æµ‹è¯•çœŸå®æ¡ˆä¾‹)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 æµ‹è¯•è®¾è®¡](#71-æµ‹è¯•è®¾è®¡)
    - [7.2 ç»“æœåˆ†æ](#72-ç»“æœåˆ†æ)
    - [7.3 ä¼˜åŒ–éªŒè¯](#73-ä¼˜åŒ–éªŒè¯)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 æ€§èƒ½æµ‹è¯•åŸºç¡€å¸¸è§é—®é¢˜](#81-æ€§èƒ½æµ‹è¯•åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•ä½¿ç”¨pgbenchè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Ÿ](#q1-å¦‚ä½•ä½¿ç”¨pgbenchè¿›è¡Œæ€§èƒ½æµ‹è¯•)
      - [Q2: å¦‚ä½•è®¾è®¡æœ‰æ•ˆçš„æ€§èƒ½æµ‹è¯•ï¼Ÿ](#q2-å¦‚ä½•è®¾è®¡æœ‰æ•ˆçš„æ€§èƒ½æµ‹è¯•)
    - [8.2 åŸºå‡†æµ‹è¯•å¸¸è§é—®é¢˜](#82-åŸºå‡†æµ‹è¯•å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•è§£è¯»æ€§èƒ½æµ‹è¯•ç»“æœï¼Ÿ](#q3-å¦‚ä½•è§£è¯»æ€§èƒ½æµ‹è¯•ç»“æœ)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [9.1 å®˜æ–¹æ–‡æ¡£](#91-å®˜æ–¹æ–‡æ¡£)
    - [9.2 æŠ€æœ¯è®ºæ–‡](#92-æŠ€æœ¯è®ºæ–‡)
    - [9.3 æŠ€æœ¯åšå®¢](#93-æŠ€æœ¯åšå®¢)
    - [9.4 ç¤¾åŒºèµ„æº](#94-ç¤¾åŒºèµ„æº)
    - [9.5 ç›¸å…³æ–‡æ¡£](#95-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•çš„ä»·å€¼**:

PostgreSQL æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•å¯ä»¥ï¼š

1. **æ€§èƒ½è¯„ä¼°**: è¯„ä¼°æ•°æ®åº“æ€§èƒ½
2. **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **ä¼˜åŒ–éªŒè¯**: éªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **å®¹é‡è§„åˆ’**: è¿›è¡Œå®¹é‡è§„åˆ’

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
- **å®¹é‡è§„åˆ’**: è§„åˆ’æ•°æ®åº“å®¹é‡
- **ç¡¬ä»¶é€‰å‹**: é€‰æ‹©åˆé€‚çš„ç¡¬ä»¶
- **é…ç½®è°ƒä¼˜**: è°ƒä¼˜æ•°æ®åº“é…ç½®

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
| --- | --- | --- |
| **æ€§èƒ½æå‡** | åŸºå‡†æµ‹è¯•æŒ‡å¯¼ä¼˜åŒ– | **2-10x** |
| **å®¹é‡è§„åˆ’** | å‡†ç¡®å®¹é‡è§„åˆ’ | **+30%** |
| **æˆæœ¬ä¼˜åŒ–** | ä¼˜åŒ–ç¡¬ä»¶æˆæœ¬ | **-20%** |
| **é—®é¢˜é¢„é˜²** | æå‰å‘ç°é—®é¢˜ | **+50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ€§èƒ½æå‡**: åŸºå‡†æµ‹è¯•æŒ‡å¯¼ä¼˜åŒ–ï¼Œæå‡æ€§èƒ½ 2-10 å€
- **å®¹é‡è§„åˆ’**: å‡†ç¡®å®¹é‡è§„åˆ’ï¼Œæå‡è§„åˆ’å‡†ç¡®æ€§ 30%
- **æˆæœ¬ä¼˜åŒ–**: ä¼˜åŒ–ç¡¬ä»¶æˆæœ¬ï¼Œé™ä½ 20%
- **é—®é¢˜é¢„é˜²**: æå‰å‘ç°é—®é¢˜ï¼Œæå‡é—®é¢˜é¢„é˜²èƒ½åŠ› 50%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡æ€§èƒ½æµ‹è¯•æ–¹æ³•
- ç†è§£åŸºå‡†æµ‹è¯•å·¥å…·
- å­¦ä¼šæ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- æŒæ¡å®¹é‡è§„åˆ’æ–¹æ³•

### 1.4 æ€§èƒ½æµ‹è¯•ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½æµ‹è¯•ä½“ç³»))
    æµ‹è¯•å·¥å…·
      pgbench
        åŸºå‡†æµ‹è¯•
        å‹åŠ›æµ‹è¯•
        æ€§èƒ½åˆ†æ
      è‡ªå®šä¹‰æµ‹è¯•
        ä¸šåŠ¡åœºæ™¯æµ‹è¯•
        è´Ÿè½½æµ‹è¯•
        å‹åŠ›æµ‹è¯•
    æµ‹è¯•ç±»å‹
      åŸºå‡†æµ‹è¯•
        æ ‡å‡†æµ‹è¯•
        æ€§èƒ½å¯¹æ¯”
        æ€§èƒ½è¯„ä¼°
      å‹åŠ›æµ‹è¯•
        æé™æµ‹è¯•
        ç¨³å®šæ€§æµ‹è¯•
        æ•…éšœæµ‹è¯•
      è´Ÿè½½æµ‹è¯•
        æ­£å¸¸è´Ÿè½½
        å³°å€¼è´Ÿè½½
        æŒç»­è´Ÿè½½
    æ€§èƒ½åˆ†æ
      æ€§èƒ½æŒ‡æ ‡
        TPS
        å»¶è¿Ÿ
        ååé‡
      ç“¶é¢ˆè¯†åˆ«
        CPUç“¶é¢ˆ
        å†…å­˜ç“¶é¢ˆ
        I/Oç“¶é¢ˆ
      ä¼˜åŒ–å»ºè®®
        é…ç½®ä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
        æ¶æ„ä¼˜åŒ–
```

## 2. æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰

### 2.0 æ€§èƒ½æµ‹è¯•å½¢å¼åŒ–å®šä¹‰

**æ€§èƒ½æµ‹è¯•çš„æœ¬è´¨**ï¼šæ€§èƒ½æµ‹è¯•æ˜¯é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•æµ‹é‡å’Œè¯„ä¼°æ•°æ®åº“ç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ï¼Œè¯†åˆ«ç“¶é¢ˆå¹¶éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚

**å®šä¹‰ 1ï¼ˆæ€§èƒ½æŒ‡æ ‡ï¼‰**ï¼š
è®¾ PerformanceMetrics = {throughput, latency, resource_usage, error_rate}ï¼Œå…¶ä¸­ï¼š

- throughputï¼šååé‡ï¼ˆTPS/QPSï¼‰
- latencyï¼šå»¶è¿Ÿï¼ˆå“åº”æ—¶é—´ï¼‰
- resource_usageï¼šèµ„æºä½¿ç”¨ç‡ï¼ˆCPU/å†…å­˜/IOï¼‰
- error_rateï¼šé”™è¯¯ç‡

**å®šä¹‰ 2ï¼ˆæµ‹è¯•åœºæ™¯ï¼‰**ï¼š
è®¾ TestScenario = {workload, concurrency, duration}ï¼Œå…¶ä¸­ï¼š

- workloadï¼šå·¥ä½œè´Ÿè½½ç±»å‹
- concurrencyï¼šå¹¶å‘æ•°
- durationï¼šæµ‹è¯•æŒç»­æ—¶é—´

**å®šä¹‰ 3ï¼ˆåŸºå‡†æµ‹è¯•ï¼‰**ï¼š
è®¾ Benchmark = {standard, custom, comparison}ï¼Œå…¶ä¸­ï¼š

- standardï¼šæ ‡å‡†åŸºå‡†æµ‹è¯•ï¼ˆTPC-Cç­‰ï¼‰
- customï¼šè‡ªå®šä¹‰åŸºå‡†æµ‹è¯•
- comparisonï¼šæ€§èƒ½å¯¹æ¯”æµ‹è¯•

**å®šä¹‰ 4ï¼ˆæµ‹è¯•ç»“æœï¼‰**ï¼š
è®¾ TestResult = {metrics, analysis, recommendations}ï¼Œå…¶ä¸­ï¼š

- metricsï¼šæ€§èƒ½æŒ‡æ ‡
- analysisï¼šç»“æœåˆ†æ
- recommendationsï¼šä¼˜åŒ–å»ºè®®

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç† 1ï¼ˆæµ‹è¯•æœ‰æ•ˆæ€§ï¼‰**ï¼š
å¦‚æœæµ‹è¯•åœºæ™¯çœŸå®åæ˜ ä¸šåŠ¡è´Ÿè½½ï¼Œåˆ™æµ‹è¯•ç»“æœæœ‰æ•ˆã€‚

**è¯æ˜**ï¼š

1. æ ¹æ®å®šä¹‰2ï¼Œæµ‹è¯•åœºæ™¯åŒ…æ‹¬å·¥ä½œè´Ÿè½½ã€å¹¶å‘æ•°ã€æŒç»­æ—¶é—´
2. æµ‹è¯•åœºæ™¯çœŸå®åæ˜ ä¸šåŠ¡è´Ÿè½½
3. æµ‹è¯•ç»“æœåæ˜ çœŸå®æ€§èƒ½
4. å› æ­¤ï¼Œæµ‹è¯•ç»“æœæœ‰æ•ˆ

**å®šç† 2ï¼ˆåŸºå‡†æµ‹è¯•å¯æ¯”æ€§ï¼‰**ï¼š
æ ‡å‡†åŸºå‡†æµ‹è¯•çš„ç»“æœå…·æœ‰å¯æ¯”æ€§ï¼Œå¯ç”¨äºæ€§èƒ½å¯¹æ¯”ã€‚

**è¯æ˜**ï¼š

1. æ ‡å‡†åŸºå‡†æµ‹è¯•æœ‰ç»Ÿä¸€çš„æµ‹è¯•è§„èŒƒ
2. æµ‹è¯•ç¯å¢ƒå’Œæ–¹æ³•æ ‡å‡†åŒ–
3. æµ‹è¯•ç»“æœå¯é‡å¤
4. å› æ­¤ï¼Œæµ‹è¯•ç»“æœå…·æœ‰å¯æ¯”æ€§

**å®é™…åº”ç”¨**ï¼š

- æ€§èƒ½æµ‹è¯•åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œæµ‹è¯•è®¾è®¡
- åŸºå‡†æµ‹è¯•åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œæ€§èƒ½å¯¹æ¯”
- æµ‹è¯•å·¥å…·åˆ©ç”¨å½¢å¼åŒ–å®šä¹‰è¿›è¡Œç»“æœåˆ†æ

### 2.1 æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ

**æ€§èƒ½æµ‹è¯•å·¥å…·çš„é€‰æ‹©æ˜¯æ€§èƒ½æµ‹è¯•çš„å…³é”®å†³ç­–**ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·å¯ä»¥æå‡æµ‹è¯•æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

**æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å¯¹æ¯”çŸ©é˜µ**ï¼š

| å·¥å…· | åŠŸèƒ½ | æ˜“ç”¨æ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ | ç»¼åˆè¯„åˆ† |
| --- | --- | --- | --- | --- | --- |
| **pgbench** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | æ ‡å‡†åŸºå‡†æµ‹è¯• | 5.0/5 |
| **è‡ªå®šä¹‰è„šæœ¬** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | ä¸šåŠ¡åœºæ™¯æµ‹è¯• | 3.7/5 |
| **TPC-C** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | æ ‡å‡†åŸºå‡†æµ‹è¯• | 4.0/5 |
| **å‹åŠ›æµ‹è¯•å·¥å…·** | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å‹åŠ›æµ‹è¯• | 4.0/5 |

**æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å†³ç­–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[éœ€è¦æ€§èƒ½æµ‹è¯•] --> B{æµ‹è¯•ç±»å‹}
    B -->|æ ‡å‡†åŸºå‡†æµ‹è¯•| C[ä½¿ç”¨pgbench]
    B -->|ä¸šåŠ¡åœºæ™¯æµ‹è¯•| D[ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬]
    B -->|å‹åŠ›æµ‹è¯•| E[ä½¿ç”¨å‹åŠ›æµ‹è¯•å·¥å…·]
    B -->|æ ‡å‡†å¯¹æ¯”| F[ä½¿ç”¨TPC-C]
    C --> G[æ‰§è¡Œæµ‹è¯•]
    D --> G
    E --> G
    F --> G
    G --> H[åˆ†æç»“æœ]
    H --> I{ç»“æœæ»¡è¶³è¦æ±‚?}
    I -->|æ˜¯| J[æµ‹è¯•å®Œæˆ]
    I -->|å¦| K{é—®é¢˜åˆ†æ}
    K -->|æ€§èƒ½é—®é¢˜| L{æ˜¯å¦éœ€è¦ä¼˜åŒ–?}
    K -->|å·¥å…·é—®é¢˜| M[é€‰æ‹©å…¶ä»–å·¥å…·]
    L -->|æ˜¯| N[è¿›è¡Œä¼˜åŒ–]
    L -->|å¦| O[é€‰æ‹©å…¶ä»–å·¥å…·]
    N --> G
    O --> B
    M --> B

    style B fill:#FFD700
    style I fill:#90EE90
    style J fill:#90EE90
```

## 3. æµ‹è¯•å·¥å…·

### 3.1 pgbench

**pgbench åŸºç¡€ä½¿ç”¨**:

```bash
# åˆå§‹åŒ–æµ‹è¯•æ•°æ®
pgbench -i -s 50 mydb

# è¿è¡ŒåŸºå‡†æµ‹è¯•
pgbench -c 10 -j 2 -T 60 mydb

# è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬
pgbench -f custom_script.sql -c 10 -T 60 mydb
```

**pgbench å‚æ•°**:

```bash
# å®¢æˆ·ç«¯æ•°
-c, --clients=N

# çº¿ç¨‹æ•°
-j, --jobs=N

# è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
-T, --time=SECONDS

# äº‹åŠ¡æ•°
-t, --transactions=N

# æ¯”ä¾‹å› å­
-s, --scale=N
```

### 3.2 è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬

**æµ‹è¯•è„šæœ¬ç¤ºä¾‹** (test_script.sql):

```sql
-- ç®€å•æŸ¥è¯¢æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç®€å•æŸ¥è¯¢æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- pgbenchè„šæœ¬ä¸­ä½¿ç”¨ï¼š
-- \set id random(1, 1000000)
-- SELECT * FROM users WHERE id = :id;

EXPLAIN ANALYZE
SELECT * FROM users WHERE id = 1;  -- ç¤ºä¾‹æŸ¥è¯¢

-- å¤æ‚æŸ¥è¯¢æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå¤æ‚æŸ¥è¯¢æµ‹è¯•';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹å¤æ‚æŸ¥è¯¢æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- pgbenchè„šæœ¬ä¸­ä½¿ç”¨ï¼š
-- \set user_id random(1, 100000)
-- SELECT u.*, COUNT(o.id) AS order_count
-- FROM users u
-- LEFT JOIN orders o ON u.id = o.user_id
-- WHERE u.id = :user_id
-- GROUP BY u.id;

EXPLAIN ANALYZE
SELECT u.*, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.id = 1
GROUP BY u.id;  -- ç¤ºä¾‹æŸ¥è¯¢

## 4. åŸºå‡†æµ‹è¯•

### 4.1 TPC-C åŸºå‡†æµ‹è¯•

**TPC-C æµ‹è¯•**:

```bash
# ä½¿ç”¨ BenchmarkSQL è¿è¡Œ TPC-C
java -jar benchmarksql.jar -c config.xml

# é…ç½®ç¤ºä¾‹ (config.xml)
<props>
    <entry key="db">postgres</entry>
    <entry key="driver">org.postgresql.Driver</entry>
    <entry key="conn">jdbc:postgresql://localhost/mydb</entry>
    <entry key="user">postgres</entry>
    <entry key="password">password</entry>
    <entry key="warehouses">10</entry>
    <entry key="terminals">10</entry>
</props>
```

### 4.2 è‡ªå®šä¹‰åŸºå‡†æµ‹è¯•

**Python æµ‹è¯•è„šæœ¬**:

```python
import psycopg2
import time
import statistics

class PerformanceTest:
    def __init__(self, connection_string):
        self.conn = psycopg2.connect(connection_string)

    def run_query_test(self, query, iterations=100):
        """è¿è¡ŒæŸ¥è¯¢æµ‹è¯•"""
        times = []
        for _ in range(iterations):
            start = time.time()
            cur = self.conn.cursor()
            cur.execute(query)
            cur.fetchall()
            cur.close()
            times.append((time.time() - start) * 1000)  # è½¬æ¢ä¸ºæ¯«ç§’

        return {
            'mean': statistics.mean(times),
            'median': statistics.median(times),
            'p95': statistics.quantiles(times, n=20)[18],
            'p99': statistics.quantiles(times, n=100)[98]
        }
```

## 5. å‹åŠ›æµ‹è¯•

### 5.1 å¹¶å‘å‹åŠ›æµ‹è¯•

**å¹¶å‘æµ‹è¯•è„šæœ¬**:

```python
import asyncio
import asyncpg
import time

async def stress_test(query, concurrency=100, duration=60):
    """å‹åŠ›æµ‹è¯•"""
    conn = await asyncpg.connect('postgresql://user:pass@localhost/db')

    start_time = time.time()
    tasks = []

    async def run_query():
        while time.time() - start_time < duration:
            await conn.fetch(query)

    for _ in range(concurrency):
        tasks.append(run_query())

    await asyncio.gather(*tasks)
    await conn.close()
```

### 5.2 è´Ÿè½½æµ‹è¯•

**è´Ÿè½½æµ‹è¯•å·¥å…·**:

```bash
# ä½¿ç”¨ Apache Bench
ab -n 10000 -c 100 http://api.example.com/query

# ä½¿ç”¨ wrk
wrk -t12 -c400 -d30s http://api.example.com/query
```

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1 æ¡ˆä¾‹: æ•°æ®åº“æ€§èƒ½æµ‹è¯•ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å¯¹PostgreSQLæ•°æ®åº“è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œè¯„ä¼°æ€§èƒ½å¹¶ä¼˜åŒ–é…ç½®ï¼Œæ—¥äº¤æ˜“é‡100ä¸‡+ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„æµ‹è¯•å·¥å…·ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ€§èƒ½æœªçŸ¥**: ä¸æ¸…æ¥šæ•°æ®åº“æ€§èƒ½
2. **é…ç½®æœªä¼˜åŒ–**: é…ç½®æœªä¼˜åŒ–
3. **å®¹é‡ä¸æ˜**: ä¸æ¸…æ¥šå®¹é‡éœ€æ±‚
4. **æ•°æ®é‡**: æ—¥äº¤æ˜“é‡100ä¸‡+ï¼Œéœ€è¦å‡†ç¡®è¯„ä¼°æ€§èƒ½

**æ€§èƒ½æµ‹è¯•å·¥å…·é€‰æ‹©å†³ç­–è®ºè¯**:

**é—®é¢˜**: å¦‚ä½•ä¸ºæ•°æ®åº“æ€§èƒ½æµ‹è¯•é€‰æ‹©åˆé€‚çš„æµ‹è¯•å·¥å…·ï¼Ÿ

**æ–¹æ¡ˆåˆ†æ**:

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨pgbench**:

- **æè¿°**: ä½¿ç”¨PostgreSQLå†…ç½®çš„pgbenchå·¥å…·è¿›è¡ŒåŸºå‡†æµ‹è¯•
- **ä¼˜ç‚¹**:
  - åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒå¤šç§æµ‹è¯•åœºæ™¯
  - æ˜“ç”¨æ€§å¥½ï¼Œé…ç½®ç®€å•
  - æ€§èƒ½å¥½ï¼Œæµ‹è¯•æ•ˆç‡é«˜
  - ç»“æœå¯é‡å¤
- **ç¼ºç‚¹**:
  - æµ‹è¯•åœºæ™¯ç›¸å¯¹å›ºå®š
  - ä¸èƒ½å®Œå…¨æ¨¡æ‹Ÿä¸šåŠ¡åœºæ™¯
- **é€‚ç”¨åœºæ™¯**: æ ‡å‡†åŸºå‡†æµ‹è¯•
- **æ€§èƒ½æ•°æ®**: æµ‹è¯•æ—¶é—´<10åˆ†é’Ÿï¼Œç»“æœå‡†ç¡®
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬**:

- **æè¿°**: ç¼–å†™è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬æ¨¡æ‹Ÿä¸šåŠ¡åœºæ™¯
- **ä¼˜ç‚¹**:
  - å®Œå…¨æ¨¡æ‹Ÿä¸šåŠ¡åœºæ™¯
  - çµæ´»æ€§é«˜
  - å¯ä»¥æµ‹è¯•ç‰¹å®šåŠŸèƒ½
- **ç¼ºç‚¹**:
  - å¼€å‘æˆæœ¬é«˜
  - éœ€è¦ç»´æŠ¤
  - ç»“æœå¯èƒ½ä¸å¯é‡å¤
- **é€‚ç”¨åœºæ™¯**: ä¸šåŠ¡åœºæ™¯æµ‹è¯•
- **æ€§èƒ½æ•°æ®**: æµ‹è¯•æ—¶é—´<30åˆ†é’Ÿï¼Œç»“æœå‡†ç¡®
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œç»´æŠ¤æˆæœ¬ä¸­ç­‰ï¼Œé£é™©ä¸­ç­‰

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨TPC-C**:

- **æè¿°**: ä½¿ç”¨TPC-Cæ ‡å‡†åŸºå‡†æµ‹è¯•
- **ä¼˜ç‚¹**:
  - æ ‡å‡†åŸºå‡†æµ‹è¯•ï¼Œç»“æœå¯å¯¹æ¯”
  - æµ‹è¯•åœºæ™¯å…¨é¢
  - ç»“æœæƒå¨
- **ç¼ºç‚¹**:
  - å®æ–½å¤æ‚
  - éœ€è¦è®¤è¯
  - æˆæœ¬é«˜
- **é€‚ç”¨åœºæ™¯**: æ ‡å‡†æ€§èƒ½å¯¹æ¯”
- **æ€§èƒ½æ•°æ®**: æµ‹è¯•æ—¶é—´>1å°æ—¶ï¼Œç»“æœå‡†ç¡®
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬é«˜ï¼Œè®¤è¯æˆæœ¬é«˜ï¼Œé£é™©ä½

**æ–¹æ¡ˆ4ï¼šä½¿ç”¨å‹åŠ›æµ‹è¯•å·¥å…·**:

- **æè¿°**: ä½¿ç”¨Apache Benchã€wrkç­‰å‹åŠ›æµ‹è¯•å·¥å…·
- **ä¼˜ç‚¹**:
  - æ˜“ç”¨æ€§å¥½
  - æ”¯æŒé«˜å¹¶å‘æµ‹è¯•
  - ç»“æœç›´è§‚
- **ç¼ºç‚¹**:
  - åŠŸèƒ½æœ‰é™
  - ä¸èƒ½æµ‹è¯•æ•°æ®åº“å†…éƒ¨æ€§èƒ½
- **é€‚ç”¨åœºæ™¯**: å‹åŠ›æµ‹è¯•
- **æ€§èƒ½æ•°æ®**: æµ‹è¯•æ—¶é—´<5åˆ†é’Ÿï¼Œç»“æœå‡†ç¡®
- **æˆæœ¬åˆ†æ**: å¼€å‘æˆæœ¬ä½ï¼Œç»´æŠ¤æˆæœ¬ä½ï¼Œé£é™©ä½

**å¯¹æ¯”åˆ†æ**:

| æ–¹æ¡ˆ | åŠŸèƒ½ | æ˜“ç”¨æ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ | ç»¼åˆè¯„åˆ† |
| --- | --- | --- | --- | --- | --- | --- |
| pgbench | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | æ ‡å‡†åŸºå‡†æµ‹è¯• | â­â­â­â­â­ | 5.0/5 |
| è‡ªå®šä¹‰è„šæœ¬ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | ä¸šåŠ¡åœºæ™¯æµ‹è¯• | â­â­â­ | 3.7/5 |
| TPC-C | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | æ ‡å‡†å¯¹æ¯” | â­â­ | 4.0/5 |
| å‹åŠ›æµ‹è¯•å·¥å…· | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | å‹åŠ›æµ‹è¯• | â­â­â­â­â­ | 4.0/5 |

**å†³ç­–ä¾æ®**:

**å†³ç­–æ ‡å‡†**:

- åŠŸèƒ½ï¼šæƒé‡30%
- æ˜“ç”¨æ€§ï¼šæƒé‡25%
- æ€§èƒ½ï¼šæƒé‡20%
- é€‚ç”¨åœºæ™¯ï¼šæƒé‡15%
- æˆæœ¬ï¼šæƒé‡10%

**è¯„åˆ†è®¡ç®—**:

- pgbenchï¼š5.0 Ã— 0.3 + 5.0 Ã— 0.25 + 5.0 Ã— 0.2 + 5.0 Ã— 0.15 + 5.0 Ã— 0.1 = 5.0
- è‡ªå®šä¹‰è„šæœ¬ï¼š5.0 Ã— 0.3 + 3.0 Ã— 0.25 + 5.0 Ã— 0.2 + 4.0 Ã— 0.15 + 3.0 Ã— 0.1 = 3.7
- TPC-Cï¼š5.0 Ã— 0.3 + 3.0 Ã— 0.25 + 5.0 Ã— 0.2 + 5.0 Ã— 0.15 + 2.0 Ã— 0.1 = 4.0
- å‹åŠ›æµ‹è¯•å·¥å…·ï¼š4.0 Ã— 0.3 + 4.0 Ã— 0.25 + 4.0 Ã— 0.2 + 4.0 Ã— 0.15 + 5.0 Ã— 0.1 = 4.0

**ç»“è®ºä¸å»ºè®®**:

**æ¨èæ–¹æ¡ˆ**: pgbenchï¼ˆæ ‡å‡†åŸºå‡†æµ‹è¯•ï¼‰+ è‡ªå®šä¹‰è„šæœ¬ï¼ˆä¸šåŠ¡åœºæ™¯æµ‹è¯•ï¼‰

**æ¨èç†ç”±**:

1. pgbenchåŠŸèƒ½å®Œå–„ï¼Œæ˜“ç”¨æ€§å¥½ï¼Œé€‚åˆæ ‡å‡†åŸºå‡†æµ‹è¯•
2. è‡ªå®šä¹‰è„šæœ¬å¯ä»¥æ¨¡æ‹Ÿä¸šåŠ¡åœºæ™¯ï¼Œè¡¥å……pgbenchçš„ä¸è¶³
3. ç»„åˆä½¿ç”¨å¯ä»¥å…¨é¢è¯„ä¼°æ€§èƒ½
4. æˆæœ¬åˆç†ï¼Œé£é™©å¯æ§

**å®æ–½å»ºè®®**:

1. ä½¿ç”¨pgbenchè¿›è¡Œæ ‡å‡†åŸºå‡†æµ‹è¯•ï¼Œè¯„ä¼°åŸºç¡€æ€§èƒ½
2. ç¼–å†™è‡ªå®šä¹‰è„šæœ¬æ¨¡æ‹Ÿä¸šåŠ¡åœºæ™¯ï¼Œè¯„ä¼°ä¸šåŠ¡æ€§èƒ½
3. æ ¹æ®æµ‹è¯•ç»“æœè¿›è¡Œä¼˜åŒ–
4. å®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼ŒæŒç»­ç›‘æ§æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. è¿è¡Œ pgbench åŸºå‡†æµ‹è¯•
pgbench -i -s 100 mydb
pgbench -c 50 -j 4 -T 300 mydb

# 2. åˆ†æç»“æœ
# æŸ¥çœ‹ TPS (Transactions per second)
# æŸ¥çœ‹å»¶è¿Ÿç»Ÿè®¡

# 3. ä¼˜åŒ–é…ç½®
# æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´ postgresql.conf

# 4. é‡æ–°æµ‹è¯•éªŒè¯
pgbench -c 50 -j 4 -T 300 mydb
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
| --- | --- | --- | --- |
| **TPS** | 1000 | **5000** | **5x** â¬†ï¸ |
| **P95 å»¶è¿Ÿ** | 100ms | **20ms** | **80%** â¬‡ï¸ |
| **P99 å»¶è¿Ÿ** | 200ms | **50ms** | **75%** â¬‡ï¸ |

## 7. æœ€ä½³å®è·µ

### 7.1 æµ‹è¯•è®¾è®¡

1. **çœŸå®åœºæ™¯**: æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
2. **é€æ­¥å¢åŠ **: é€æ­¥å¢åŠ è´Ÿè½½
3. **å¤šç»´åº¦æµ‹è¯•**: æµ‹è¯•å¤šä¸ªç»´åº¦

### 7.2 ç»“æœåˆ†æ

1. **å…³é”®æŒ‡æ ‡**: å…³æ³¨å…³é”®æ€§èƒ½æŒ‡æ ‡
2. **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **è¶‹åŠ¿åˆ†æ**: åˆ†ææ€§èƒ½è¶‹åŠ¿

### 7.3 ä¼˜åŒ–éªŒè¯

1. **å¯¹æ¯”æµ‹è¯•**: å¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½
2. **æŒç»­ç›‘æ§**: æŒç»­ç›‘æ§æ€§èƒ½
3. **å®šæœŸæµ‹è¯•**: å®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 æ€§èƒ½æµ‹è¯•åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•ä½¿ç”¨pgbenchè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨pgbenchè¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥pgbenchæ˜¯å¦å¯ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åœ¨ç³»ç»Ÿå±‚é¢ï¼šwhich pgbench
-- æˆ–ä½¿ç”¨DOå—æ£€æŸ¥ï¼ˆéœ€è¦superuseræƒé™ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ£€æŸ¥å½“å‰æ•°æ®åº“
        PERFORM current_database();
        RAISE NOTICE 'å½“å‰æ•°æ®åº“: %', current_database();

        -- æ³¨æ„ï¼špgbenchæ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œéœ€è¦åœ¨ç³»ç»Ÿå±‚é¢æ£€æŸ¥
        RAISE NOTICE 'æç¤ºï¼šè¯·ä½¿ç”¨ which pgbench æˆ– pgbench --version æ£€æŸ¥pgbenchæ˜¯å¦å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æ£€æŸ¥æµ‹è¯•æ•°æ®åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    db_name TEXT;
BEGIN
    BEGIN
        SELECT current_database() INTO db_name;
        RAISE NOTICE 'å½“å‰æµ‹è¯•æ•°æ®åº“: %', db_name;

        -- æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = db_name) THEN
            RAISE WARNING 'æ•°æ®åº“ % ä¸å­˜åœ¨', db_name;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æ•°æ®åº“å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼ˆæ³¨æ„ï¼špgbenchæ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼‰
-- åœ¨ç³»ç»Ÿå‘½ä»¤è¡Œæ‰§è¡Œï¼š
-- pgbench -i -s 100 mydb
-- -i: åˆå§‹åŒ–
-- -s: ç¼©æ”¾å› å­ï¼ˆ100è¡¨ç¤º100å€åŸºå‡†æ•°æ®ï¼‰

-- æ£€æŸ¥åˆå§‹åŒ–ç»“æœï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    table_count INT;
    row_count BIGINT;
BEGIN
    BEGIN
        -- æ£€æŸ¥pgbenchè¡¨æ˜¯å¦å­˜åœ¨
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'pgbench_accounts') THEN
            SELECT COUNT(*) INTO table_count
            FROM information_schema.tables
            WHERE table_schema = 'public'
            AND table_name LIKE 'pgbench_%';

            SELECT COUNT(*) INTO row_count
            FROM pgbench_accounts;

            RAISE NOTICE 'pgbenchè¡¨æ•°é‡: %, pgbench_accountsè¡Œæ•°: %', table_count, row_count;
        ELSE
            RAISE WARNING 'pgbenchè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ pgbench -i -s 100 mydb åˆå§‹åŒ–';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'pgbenchè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆå§‹åŒ–';
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥pgbenchè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆæ³¨æ„ï¼šéœ€è¦åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼‰
-- pgbench -c 10 -j 2 -T 60 mydb
-- -c: å®¢æˆ·ç«¯æ•°ï¼ˆå¹¶å‘è¿æ¥æ•°ï¼‰
-- -j: çº¿ç¨‹æ•°
-- -T: è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰

-- 3. è¿è¡Œè‡ªå®šä¹‰æµ‹è¯•ï¼ˆæ³¨æ„ï¼šéœ€è¦åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼‰
-- pgbench -f custom_script.sql -c 10 -T 60 mydb
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— æµ‹è¯•ï¼šæ€§èƒ½é—®é¢˜å‘ç°æ—¶é—´ **æ•°å‘¨**ï¼Œå½±å“ç”Ÿäº§
- æœ‰æµ‹è¯•ï¼šæ€§èƒ½é—®é¢˜å‘ç°æ—¶é—´ **æ•°å°æ—¶**ï¼Œå¿«é€Ÿå®šä½
- **é—®é¢˜å‘ç°æ•ˆç‡æå‡ï¼š100å€**

#### Q2: å¦‚ä½•è®¾è®¡æœ‰æ•ˆçš„æ€§èƒ½æµ‹è¯•ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•è®¾è®¡æœ‰æ•ˆçš„æ€§èƒ½æµ‹è¯•ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. åˆ†æä¸šåŠ¡åœºæ™¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹åˆ†æä¸šåŠ¡åœºæ™¯å’Œè´Ÿè½½æ¨¡å¼';
        RAISE NOTICE 'æç¤ºï¼šéœ€è¦åˆ†æå®é™…ä¸šåŠ¡è´Ÿè½½æ¨¡å¼ï¼ŒåŒ…æ‹¬è¯»å†™æ¯”ä¾‹ã€å¹¶å‘é‡ã€æŸ¥è¯¢ç±»å‹ç­‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æ£€æŸ¥æ•°æ®åº“é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    v_shared_buffers TEXT;
    v_work_mem TEXT;
BEGIN
    BEGIN
        -- æ£€æŸ¥shared_buffersé…ç½®
        SELECT setting INTO v_shared_buffers
        FROM pg_settings
        WHERE name = 'shared_buffers';

        RAISE NOTICE 'shared_buffersé…ç½®: %', v_shared_buffers;

        -- æ£€æŸ¥work_memé…ç½®
        SELECT setting INTO v_work_mem
        FROM pg_settings
        WHERE name = 'work_mem';

        RAISE NOTICE 'work_memé…ç½®: %', v_work_mem;

        -- æ£€æŸ¥å…¶ä»–å…³é”®é…ç½®
        RAISE NOTICE 'æç¤ºï¼šä½¿ç”¨ SHOW å‘½ä»¤æŸ¥çœ‹å…¶ä»–é…ç½®å‚æ•°';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›´æ¥æŸ¥è¯¢é…ç½®ï¼ˆç¤ºä¾‹ï¼‰
SHOW shared_buffers;
SHOW work_mem;

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. è®¾è®¡æµ‹è¯•åœºæ™¯ï¼ˆæ³¨æ„ï¼špgbenchå‘½ä»¤éœ€è¦åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼‰

-- åœºæ™¯1ï¼šOLTPè´Ÿè½½ï¼ˆé«˜å¹¶å‘å°äº‹åŠ¡ï¼‰
-- åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š
-- pgbench -c 50 -j 4 -T 300 -M prepared mydb

-- åœºæ™¯2ï¼šOLAPè´Ÿè½½ï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰
-- åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š
-- pgbench -c 5 -j 2 -T 300 -f complex_query.sql mydb

-- åœºæ™¯3ï¼šæ··åˆè´Ÿè½½
-- åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š
-- pgbench -c 20 -j 4 -T 300 -f mixed_workload.sql mydb

-- 2. è®°å½•æµ‹è¯•ç»“æœï¼ˆæ³¨æ„ï¼šéœ€è¦åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼‰
-- pgbench -c 10 -T 60 -l mydb > results.log

-- æ£€æŸ¥æµ‹è¯•ç»“æœè¡¨ï¼ˆå¦‚æœä½¿ç”¨-lé€‰é¡¹ï¼Œç»“æœä¼šè®°å½•åˆ°pgbench_historyè¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    history_count BIGINT;
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'pgbench_history') THEN
            SELECT COUNT(*) INTO history_count
            FROM pgbench_history;

            RAISE NOTICE 'pgbench_historyè®°å½•æ•°: %', history_count;

            IF history_count > 0 THEN
                RAISE NOTICE 'å¼€å§‹åˆ†ææµ‹è¯•ç»“æœ';
            ELSE
                RAISE WARNING 'pgbench_historyè¡¨ä¸ºç©ºï¼Œè¯·å…ˆè¿è¡Œæµ‹è¯•';
            END IF;
        ELSE
            RAISE WARNING 'pgbench_historyè¡¨ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ -l é€‰é¡¹è¿è¡Œæµ‹è¯•ä»¥è®°å½•ç»“æœ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'pgbench_historyè¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥æµ‹è¯•ç»“æœå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— è®¾è®¡ï¼šæµ‹è¯•ç»“æœä¸å‡†ç¡®ï¼Œæ— æ³•åæ˜ çœŸå®æ€§èƒ½
- æœ‰è®¾è®¡ï¼šæµ‹è¯•ç»“æœå‡†ç¡®ï¼ŒçœŸå®åæ˜ æ€§èƒ½
- **æµ‹è¯•å‡†ç¡®æ€§æå‡ï¼š10å€**

### 8.2 åŸºå‡†æµ‹è¯•å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•è§£è¯»æ€§èƒ½æµ‹è¯•ç»“æœï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•è§£è¯»æ€§èƒ½æµ‹è¯•ç»“æœã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹æµ‹è¯•ç»“æœï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    db_name TEXT;
BEGIN
    BEGIN
        SELECT current_database() INTO db_name;
        RAISE NOTICE 'åˆ†æpgbenchè¾“å‡ºç»“æœï¼ˆæ•°æ®åº“: %ï¼‰', db_name;
        RAISE NOTICE 'æç¤ºï¼špgbenchè¾“å‡ºåŒ…å«TPSã€å¹³å‡å»¶è¿Ÿã€95%%å»¶è¿Ÿç­‰å…³é”®æŒ‡æ ‡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ†æå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_name TEXT;
    db_stats RECORD;
BEGIN
    BEGIN
        SELECT current_database() INTO db_name;

        SELECT
            datname,
            numbackends,
            xact_commit,
            xact_rollback,
            blks_read,
            blks_hit,
            tup_returned,
            tup_fetched,
            tup_inserted,
            tup_updated,
            tup_deleted
        INTO db_stats
        FROM pg_stat_database
        WHERE datname = db_name;

        IF db_stats.datname IS NULL THEN
            RAISE WARNING 'æ•°æ®åº“ % çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨', db_name;
            RETURN;
        END IF;

        RAISE NOTICE 'æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ï¼ˆ%ï¼‰ï¼š', db_name;
        RAISE NOTICE '  è¿æ¥æ•°: %, æäº¤äº‹åŠ¡: %, å›æ»šäº‹åŠ¡: %',
            db_stats.numbackends, db_stats.xact_commit, db_stats.xact_rollback;
        RAISE NOTICE '  è¯»å–å—: %, å‘½ä¸­å—: %', db_stats.blks_read, db_stats.blks_hit;
        RAISE NOTICE '  è¿”å›è¡Œ: %, è·å–è¡Œ: %', db_stats.tup_returned, db_stats.tup_fetched;
        RAISE NOTICE '  æ’å…¥: %, æ›´æ–°: %, åˆ é™¤: %',
            db_stats.tup_inserted, db_stats.tup_updated, db_stats.tup_deleted;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥ç³»ç»Ÿèµ„æºå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM pg_stat_database WHERE datname = current_database();

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. åˆ†æTPSï¼ˆæ¯ç§’äº‹åŠ¡æ•°ï¼‰
-- é«˜TPSè¡¨ç¤ºç³»ç»Ÿå¤„ç†èƒ½åŠ›å¼º
-- ç›®æ ‡ï¼šTPS > 1000

-- 2. åˆ†æå»¶è¿Ÿï¼ˆå¹³å‡å»¶è¿Ÿï¼‰
-- ä½å»¶è¿Ÿè¡¨ç¤ºå“åº”å¿«
-- ç›®æ ‡ï¼šå¹³å‡å»¶è¿Ÿ < 10ms

-- 3. åˆ†æ95%å»¶è¿Ÿ
-- 95%å»¶è¿Ÿåæ˜ ç³»ç»Ÿç¨³å®šæ€§
-- ç›®æ ‡ï¼š95%å»¶è¿Ÿ < 50ms

-- 4. å¯¹æ¯”æµ‹è¯•ç»“æœ
-- ä¼˜åŒ–å‰ï¼šTPS=500, å¹³å‡å»¶è¿Ÿ=20ms
-- ä¼˜åŒ–åï¼šTPS=1000, å¹³å‡å»¶è¿Ÿ=10ms
-- æ€§èƒ½æå‡ï¼š2å€
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— åˆ†æï¼šæ— æ³•ç†è§£æµ‹è¯•ç»“æœï¼Œæ— æ³•ä¼˜åŒ–
- æœ‰åˆ†æï¼šå¿«é€Ÿç†è§£æµ‹è¯•ç»“æœï¼Œå¿«é€Ÿä¼˜åŒ–
- **ä¼˜åŒ–æ•ˆç‡æå‡ï¼š10å€**

## 9. å‚è€ƒèµ„æ–™

### 9.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - pgbench](https://www.postgresql.org/docs/current/pgbench.html)**
  - pgbenchå®Œæ•´å‚è€ƒæ‰‹å†Œ
  - åŒ…å«æ‰€æœ‰pgbenchç‰¹æ€§çš„è¯¦ç»†è¯´æ˜

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æµ‹è¯•](https://www.postgresql.org/docs/current/performance-tips.html)**
  - æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 9.2 æŠ€æœ¯è®ºæ–‡

- **[TPC-C Benchmark Specification](http://www.tpc.org/tpcc/)**
  - TPC-CåŸºå‡†æµ‹è¯•æ ‡å‡†è§„èŒƒ
  - æ€§èƒ½æµ‹è¯•æ ‡å‡†å®šä¹‰

- **[Gray, J. (1993). "The Benchmark Handbook for Database and Transaction Processing Systems."](https://www.amazon.com/Benchmark-Handbook-Database-Transaction-Processing/dp/1558601597)**
  - æ•°æ®åº“åŸºå‡†æµ‹è¯•çš„ç»å…¸æ•™æ
  - æ€§èƒ½æµ‹è¯•æ–¹æ³•è®º

### 9.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - æ€§èƒ½æµ‹è¯•](https://www.postgresql.org/about/newsarchive/)**
  - PostgreSQL æ€§èƒ½æµ‹è¯•æœ€æ–°åŠ¨æ€
  - å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†äº«

- **[2ndQuadrant PostgreSQL åšå®¢](https://www.2ndquadrant.com/en/blog/)**
  - PostgreSQL æ€§èƒ½æµ‹è¯•æ–‡ç« 
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Percona PostgreSQL åšå®¢](https://www.percona.com/blog/tag/postgresql/)**
  - PostgreSQL æ€§èƒ½æµ‹è¯•ä¼˜åŒ–å®è·µ
  - æ€§èƒ½æµ‹è¯•æ¡ˆä¾‹

### 9.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Performance Testing](https://wiki.postgresql.org/wiki/Performance_Testing)**
  - PostgreSQL æ€§èƒ½æµ‹è¯•Wiki
  - å¸¸è§é—®é¢˜è§£ç­”å’Œæœ€ä½³å®è·µ

- **[Stack Overflow - PostgreSQL Performance Testing](https://stackoverflow.com/questions/tagged/postgresql+performance-testing)**
  - PostgreSQL æ€§èƒ½æµ‹è¯•ç›¸å…³é—®ç­”
  - é«˜è´¨é‡çš„é—®é¢˜å’Œç­”æ¡ˆ

- **[PostgreSQL é‚®ä»¶åˆ—è¡¨](https://www.postgresql.org/list/)**
  - PostgreSQL ç¤¾åŒºè®¨è®º
  - æ€§èƒ½æµ‹è¯•ä½¿ç”¨é—®é¢˜äº¤æµ

### 9.5 ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£](./æ€§èƒ½è°ƒä¼˜ä½“ç³»è¯¦è§£.md)
- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](./æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/README.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-24
