---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: æ–°å¢æ·±åŒ–æ–‡æ¡£
> **ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºæ·±åº¦è¡¥å……ï¼Œç³»ç»ŸåŒ–å…¨æ–‡æœç´¢æŠ€æœ¯æ ˆ

---

# PostgreSQLå…¨æ–‡æœç´¢å®Œæ•´å®æˆ˜æŒ‡å—

## å…ƒæ•°æ®

- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01
- **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | zhparser | pgvector | Elasticsearchå¯¹æ¯”
- **éš¾åº¦çº§åˆ«**: â­â­â­â­ (é«˜çº§)
- **é¢„è®¡é˜…è¯»**: 150åˆ†é’Ÿ
- **å‰ç½®è¦æ±‚**: ç†Ÿæ‚‰PostgreSQLåŸºç¡€ã€æ–‡æœ¬å¤„ç†åŸºç¡€

---

## ğŸ“‹ å®Œæ•´ç›®å½•

- [PostgreSQLå…¨æ–‡æœç´¢å®Œæ•´å®æˆ˜æŒ‡å—](#postgresqlå…¨æ–‡æœç´¢å®Œæ•´å®æˆ˜æŒ‡å—)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [ğŸ“‹ å®Œæ•´ç›®å½•](#-å®Œæ•´ç›®å½•)
  - [1. å…¨æ–‡æœç´¢åŸºç¡€](#1-å…¨æ–‡æœç´¢åŸºç¡€)
    - [1.1 tsvectorä¸tsquery](#11-tsvectorä¸tsquery)
      - [tsvectorï¼ˆæ–‡æœ¬å‘é‡ï¼‰](#tsvectoræ–‡æœ¬å‘é‡)
      - [tsqueryï¼ˆæŸ¥è¯¢å‘é‡ï¼‰](#tsqueryæŸ¥è¯¢å‘é‡)
    - [1.2 åŸºç¡€æœç´¢è¯­æ³•](#12-åŸºç¡€æœç´¢è¯­æ³•)
      - [æ“ä½œç¬¦](#æ“ä½œç¬¦)
    - [1.3 æ–‡æœ¬æœç´¢é…ç½®](#13-æ–‡æœ¬æœç´¢é…ç½®)
      - [å†…ç½®é…ç½®](#å†…ç½®é…ç½®)
  - [2. ä¸­æ–‡å…¨æ–‡æœç´¢](#2-ä¸­æ–‡å…¨æ–‡æœç´¢)
    - [2.1 zhparserå®‰è£…ä¸é…ç½®](#21-zhparserå®‰è£…ä¸é…ç½®)
      - [å®‰è£…zhparser](#å®‰è£…zhparser)
      - [éªŒè¯å®‰è£…](#éªŒè¯å®‰è£…)
    - [2.2 ä¸­æ–‡åˆ†è¯é…ç½®](#22-ä¸­æ–‡åˆ†è¯é…ç½®)
      - [åˆ›å»ºä¸­æ–‡æ–‡æœ¬æœç´¢é…ç½®](#åˆ›å»ºä¸­æ–‡æ–‡æœ¬æœç´¢é…ç½®)
      - [è‡ªå®šä¹‰è¯å…¸](#è‡ªå®šä¹‰è¯å…¸)
    - [2.3 ä¸­æ–‡æœç´¢å®è·µ](#23-ä¸­æ–‡æœç´¢å®è·µ)
      - [åˆ›å»ºä¸­æ–‡æœç´¢è¡¨](#åˆ›å»ºä¸­æ–‡æœç´¢è¡¨)
      - [ä¸­æ–‡æœç´¢æŸ¥è¯¢](#ä¸­æ–‡æœç´¢æŸ¥è¯¢)
    - [2.4 ä¸­æ–‡æœç´¢ä¼˜åŒ–](#24-ä¸­æ–‡æœç´¢ä¼˜åŒ–)
      - [å¤„ç†åŒä¹‰è¯](#å¤„ç†åŒä¹‰è¯)
      - [å¤„ç†åœç”¨è¯](#å¤„ç†åœç”¨è¯)
  - [3. å¤šè¯­è¨€å…¨æ–‡æœç´¢](#3-å¤šè¯­è¨€å…¨æ–‡æœç´¢)
    - [3.1 è¯­è¨€æ£€æµ‹](#31-è¯­è¨€æ£€æµ‹)
      - [ç®€å•è¯­è¨€æ£€æµ‹å‡½æ•°](#ç®€å•è¯­è¨€æ£€æµ‹å‡½æ•°)
    - [3.2 å¤šè¯­è¨€é…ç½®](#32-å¤šè¯­è¨€é…ç½®)
      - [å­˜å‚¨è¯­è¨€ä¿¡æ¯](#å­˜å‚¨è¯­è¨€ä¿¡æ¯)
    - [3.3 æ··åˆè¯­è¨€æœç´¢](#33-æ··åˆè¯­è¨€æœç´¢)
      - [å¤šè¯­è¨€æœç´¢æŸ¥è¯¢](#å¤šè¯­è¨€æœç´¢æŸ¥è¯¢)
      - [è·¨è¯­è¨€æœç´¢](#è·¨è¯­è¨€æœç´¢)
  - [4. å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–](#4-å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–)
    - [4.1 GIN vs GiSTç´¢å¼•](#41-gin-vs-gistç´¢å¼•)
      - [å¯¹æ¯”åˆ†æ](#å¯¹æ¯”åˆ†æ)
      - [é€‰æ‹©å»ºè®®](#é€‰æ‹©å»ºè®®)
    - [4.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#42-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
      - [GINç´¢å¼•ä¼˜åŒ–](#ginç´¢å¼•ä¼˜åŒ–)
      - [éƒ¨åˆ†ç´¢å¼•](#éƒ¨åˆ†ç´¢å¼•)
    - [4.3 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§](#43-æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§)
      - [ä½¿ç”¨LIMITé™åˆ¶ç»“æœ](#ä½¿ç”¨limité™åˆ¶ç»“æœ)
      - [é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°](#é¿å…åœ¨whereä¸­ä½¿ç”¨å‡½æ•°)
  - [5. å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ](#5-å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ)
    - [5.1 æ··åˆæœç´¢æ¶æ„](#51-æ··åˆæœç´¢æ¶æ„)
    - [5.2 å®ç°æ–¹æ¡ˆ](#52-å®ç°æ–¹æ¡ˆ)
      - [åˆ›å»ºæ··åˆæœç´¢è¡¨](#åˆ›å»ºæ··åˆæœç´¢è¡¨)
      - [æ··åˆæ£€ç´¢å‡½æ•°](#æ··åˆæ£€ç´¢å‡½æ•°)
    - [5.3 ç›¸å…³æ€§èåˆ](#53-ç›¸å…³æ€§èåˆ)
      - [RRF (Reciprocal Rank Fusion)](#rrf-reciprocal-rank-fusion)
  - [7. å…¨æ–‡æœç´¢ä¸RAGé›†æˆ](#7-å…¨æ–‡æœç´¢ä¸ragé›†æˆ)
    - [7.1 RAGä¸­çš„æ£€ç´¢ç­–ç•¥](#71-ragä¸­çš„æ£€ç´¢ç­–ç•¥)
      - [æ··åˆæ£€ç´¢RAG](#æ··åˆæ£€ç´¢rag)
  - [8. ä¸Elasticsearchå¯¹æ¯”](#8-ä¸elasticsearchå¯¹æ¯”)
    - [8.1 åŠŸèƒ½å¯¹æ¯”](#81-åŠŸèƒ½å¯¹æ¯”)
    - [8.2 æ€§èƒ½å¯¹æ¯”](#82-æ€§èƒ½å¯¹æ¯”)
    - [8.3 é€‰æ‹©å»ºè®®](#83-é€‰æ‹©å»ºè®®)
  - [9. å®æˆ˜æ¡ˆä¾‹](#9-å®æˆ˜æ¡ˆä¾‹)
    - [9.1 åšå®¢æœç´¢ç³»ç»Ÿ](#91-åšå®¢æœç´¢ç³»ç»Ÿ)
      - [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
      - [æœç´¢API](#æœç´¢api)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## 1. å…¨æ–‡æœç´¢åŸºç¡€

### 1.1 tsvectorä¸tsquery

#### tsvectorï¼ˆæ–‡æœ¬å‘é‡ï¼‰

```sql
-- tsvectoræ˜¯æ–‡æ¡£çš„å‘é‡è¡¨ç¤ºï¼ŒåŒ…å«è¯å…ƒå’Œä½ç½®ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_vector tsvector;
BEGIN
    BEGIN
        result_vector := to_tsvector('english', 'PostgreSQL is a powerful open source database');
        RAISE NOTICE 'tsvectorç”ŸæˆæˆåŠŸ: %', result_vector;
        -- ç»“æœ: 'databas':7 'open':5 'postgresql':1 'power':4 'sourc':6
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'ç”Ÿæˆtsvectorå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æµ‹è¯•ts_debug';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æµ‹è¯•å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT ts_debug('english', 'PostgreSQL is a powerful database');
```

#### tsqueryï¼ˆæŸ¥è¯¢å‘é‡ï¼‰

```sql
-- tsqueryæ˜¯æŸ¥è¯¢çš„å‘é‡è¡¨ç¤ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_query tsquery;
BEGIN
    BEGIN
        result_query := to_tsquery('english', 'postgresql & database');
        RAISE NOTICE 'tsqueryç”ŸæˆæˆåŠŸ: %', result_query;
        -- ç»“æœ: 'postgresql' & 'databas'
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'ç”Ÿæˆtsqueryå¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä½¿ç”¨tsqueryæœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…¨æ–‡æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM articles
WHERE to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'postgresql & database');
-- æ³¨æ„ï¼šæ­¤æŸ¥è¯¢æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå› ä¸ºtsvectoråœ¨WHEREä¸­åŠ¨æ€ç”Ÿæˆ
-- æ¨èï¼šä½¿ç”¨é¢„è®¡ç®—çš„tsvectoråˆ—
```

### 1.2 åŸºç¡€æœç´¢è¯­æ³•

#### æ“ä½œç¬¦

```sql
-- & (AND) - å¿…é¡»åŒæ—¶åŒ…å«
SELECT to_tsquery('english', 'postgresql & database');

-- | (OR) - åŒ…å«ä»»ä¸€å³å¯
SELECT to_tsquery('english', 'postgresql | mysql');

-- ! (NOT) - ä¸åŒ…å«
SELECT to_tsquery('english', 'postgresql & !mysql');

-- ç»„åˆä½¿ç”¨
SELECT to_tsquery('english', '(postgresql | mysql) & database & !oracle');

-- <-> (FOLLOWED BY) - ç›¸é‚»
SELECT to_tsquery('english', 'postgresql <-> database');  -- "postgresql database"ç›¸é‚»

-- <N> (è·ç¦»N) - è·ç¦»Nä¸ªè¯
SELECT to_tsquery('english', 'postgresql <2> database');  -- è·ç¦»2ä¸ªè¯ä»¥å†…
```

### 1.3 æ–‡æœ¬æœç´¢é…ç½®

#### å†…ç½®é…ç½®

```sql
-- æŸ¥çœ‹å¯ç”¨çš„æ–‡æœ¬æœç´¢é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    config_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO config_count FROM pg_ts_config;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ–‡æœ¬æœç´¢é…ç½®', config_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ–‡æœ¬æœç´¢é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT cfgname FROM pg_ts_config;

-- å¸¸ç”¨é…ç½®
-- 'english' - è‹±è¯­
-- 'simple' - ç®€å•é…ç½®ï¼ˆä¸åˆ†è¯ï¼‰
-- 'chinese' - ä¸­æ–‡ï¼ˆéœ€è¦å®‰è£…zhparserï¼‰
-- 'japanese' - æ—¥è¯­
-- 'korean' - éŸ©è¯­

-- ä½¿ç”¨ä¸åŒé…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    result_vector tsvector;
BEGIN
    BEGIN
        result_vector := to_tsvector('english', 'running databases');
        RAISE NOTICE 'englishé…ç½®æµ‹è¯•æˆåŠŸ: %', result_vector;
        -- ç»“æœ: 'databas':2 'run':1  (runningè¢«è¯å¹²åŒ–ä¸ºrun)
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'englishé…ç½®æµ‹è¯•å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        result_vector := to_tsvector('simple', 'running databases');
        RAISE NOTICE 'simpleé…ç½®æµ‹è¯•æˆåŠŸ: %', result_vector;
        -- ç»“æœ: 'databases':2 'running':1  (simpleé…ç½®ä¸åˆ†è¯)
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'simpleé…ç½®æµ‹è¯•å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT to_tsvector('english', 'running databases');

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT to_tsvector('simple', 'running databases');
```

---

## 2. ä¸­æ–‡å…¨æ–‡æœç´¢

### 2.1 zhparserå®‰è£…ä¸é…ç½®

#### å®‰è£…zhparser

```bash
# Ubuntu/Debian
sudo apt-get install postgresql-17-zhparser

# æˆ–ä»æºç ç¼–è¯‘
git clone https://github.com/amutu/zhparser.git
cd zhparser
make && sudo make install

# åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ‰©å±•
psql -d mydb -c "CREATE EXTENSION zhparser;"
```

#### éªŒè¯å®‰è£…

```sql
-- æ£€æŸ¥æ‰©å±•
SELECT * FROM pg_extension WHERE extname = 'zhparser';

-- æµ‹è¯•ä¸­æ–‡åˆ†è¯
SELECT to_tsvector('zhparser', 'PostgreSQLæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¼€æºæ•°æ®åº“');
-- ç»“æœä¼šæ˜¾ç¤ºåˆ†è¯ç»“æœ
```

### 2.2 ä¸­æ–‡åˆ†è¯é…ç½®

#### åˆ›å»ºä¸­æ–‡æ–‡æœ¬æœç´¢é…ç½®

```sql
-- åˆ›å»ºä¸­æ–‡æ–‡æœ¬æœç´¢é…ç½®
CREATE TEXT SEARCH CONFIGURATION chinese_zhparser (PARSER = zhparser);

-- æ·»åŠ tokenæ˜ å°„
ALTER TEXT SEARCH CONFIGURATION chinese_zhparser
    ADD MAPPING FOR n,v,a,i,e,l WITH simple;

-- æµ‹è¯•é…ç½®
SELECT to_tsvector('chinese_zhparser', 'PostgreSQLæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¼€æºæ•°æ®åº“');
SELECT to_tsquery('chinese_zhparser', 'æ•°æ®åº“');
```

#### è‡ªå®šä¹‰è¯å…¸

```sql
-- zhparserä½¿ç”¨jiebaè¯å…¸ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰è¯å…¸
-- åœ¨postgresql.confä¸­é…ç½®
-- zhparser.multi_short = true  # å¯ç”¨çŸ­è¯è¯†åˆ«
-- zhparser.dict_in_memory = false  # è¯å…¸ä¸åŠ è½½åˆ°å†…å­˜ï¼ˆèŠ‚çœå†…å­˜ï¼‰

-- æˆ–è€…ä½¿ç”¨pg_jiebaï¼ˆå¦ä¸€ä¸ªjiebaæ‰©å±•ï¼‰
CREATE EXTENSION pg_jieba;

SELECT jieba_cut('PostgreSQLæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¼€æºæ•°æ®åº“');
```

### 2.3 ä¸­æ–‡æœç´¢å®è·µ

#### åˆ›å»ºä¸­æ–‡æœç´¢è¡¨

```sql
-- åˆ›å»ºæ–‡ç« è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles å·²å­˜åœ¨';
        ELSE
            CREATE TABLE articles (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at TIMESTAMPTZ DEFAULT NOW(),
                -- é¢„è®¡ç®—tsvector
                tsv tsvector
            );
            RAISE NOTICE 'è¡¨ articles åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ articles å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ articles å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°tsvectorï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'update_article_tsv') THEN
            DROP FUNCTION update_article_tsv() CASCADE;
            RAISE NOTICE 'å‡½æ•° update_article_tsv å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION update_article_tsv()
        RETURNS TRIGGER AS $$
        BEGIN
            BEGIN
                NEW.tsv :=
                    setweight(to_tsvector('chinese_zhparser', COALESCE(NEW.title, '')), 'A') ||
                    setweight(to_tsvector('chinese_zhparser', COALESCE(NEW.content, '')), 'B');
                RETURN NEW;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'æ›´æ–°tsvectorå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‡½æ•° update_article_tsv åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° update_article_tsv å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_article_tsv_trigger') THEN
            DROP TRIGGER update_article_tsv_trigger ON articles;
            RAISE NOTICE 'è§¦å‘å™¨ update_article_tsv_trigger å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TRIGGER update_article_tsv_trigger
        BEFORE INSERT OR UPDATE ON articles
        FOR EACH ROW
        EXECUTE FUNCTION update_article_tsv();
        RAISE NOTICE 'è§¦å‘å™¨ update_article_tsv_trigger åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºGINç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_articles_tsv ON articles USING GIN (tsv);
            RAISE NOTICE 'GINç´¢å¼• idx_articles_tsv åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

#### ä¸­æ–‡æœç´¢æŸ¥è¯¢

```sql
-- åŸºç¡€æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tsv') THEN
            RAISE WARNING 'GINç´¢å¼• idx_articles_tsv ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢å¯èƒ½è¾ƒæ…¢';
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåŸºç¡€æœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT id, title, content
FROM articles
WHERE tsv @@ to_tsquery('chinese_zhparser', 'æ•°æ®åº“');

-- ç›¸å…³æ€§æ’åºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œç›¸å…³æ€§æ’åº';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œç›¸å…³æ€§æ’åºæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    id,
    title,
    content,
    ts_rank(tsv, query) AS rank
FROM articles, to_tsquery('chinese_zhparser', 'PostgreSQL & æ•°æ®åº“') query
WHERE tsv @@ query
ORDER BY rank DESC
LIMIT 10;

-- åŠ æƒæœç´¢ï¼ˆæ ‡é¢˜æƒé‡æ›´é«˜ï¼‰
SELECT
    id,
    title,
    content,
    ts_rank_cd(
        '{0.1, 0.2, 0.4, 1.0}',  -- æƒé‡å‘é‡
        tsv,
        query
    ) AS rank
FROM articles, to_tsquery('chinese_zhparser', 'PostgreSQL & æ•°æ®åº“') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

### 2.4 ä¸­æ–‡æœç´¢ä¼˜åŒ–

#### å¤„ç†åŒä¹‰è¯

```sql
-- åˆ›å»ºåŒä¹‰è¯è¯å…¸ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ³¨æ„ï¼šsynonymæ¨¡æ¿éœ€è¦ç³»ç»Ÿæ–‡ä»¶æ”¯æŒ
        -- åˆ›å»ºåŒä¹‰è¯æ–‡ä»¶ï¼ˆéœ€è¦ç³»ç»Ÿæ–‡ä»¶ï¼‰
        -- æ ¼å¼: æºè¯ => ç›®æ ‡è¯
        -- ä¾‹å¦‚: æ•°æ®åº“ => database
        --       èµ„æ–™åº“ => database

        IF EXISTS (SELECT 1 FROM pg_ts_dict WHERE dictname = 'chinese_synonym') THEN
            RAISE WARNING 'åŒä¹‰è¯è¯å…¸ chinese_synonym å·²å­˜åœ¨';
        ELSE
            CREATE TEXT SEARCH DICTIONARY chinese_synonym (
                TEMPLATE = synonym,
                SYNONYMS = chinese_synonym
            );
            RAISE NOTICE 'åŒä¹‰è¯è¯å…¸ chinese_synonym åˆ›å»ºæˆåŠŸï¼ˆéœ€è¦ç³»ç»Ÿæ–‡ä»¶æ”¯æŒï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE EXCEPTION 'åŒä¹‰è¯æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆéœ€è¦åˆ›å»ºç³»ç»Ÿæ–‡ä»¶ï¼‰';
        WHEN duplicate_object THEN
            RAISE WARNING 'åŒä¹‰è¯è¯å…¸ chinese_synonym å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåŒä¹‰è¯è¯å…¸å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_ts_config WHERE cfgname = 'chinese_zhparser') THEN
            RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½® chinese_zhparser ä¸å­˜åœ¨';
        END IF;

        ALTER TEXT SEARCH CONFIGURATION chinese_zhparser
            ALTER MAPPING FOR n,v,a,i,e,l
            WITH chinese_synonym, simple;
        RAISE NOTICE 'åŒä¹‰è¯è¯å…¸å·²æ·»åŠ åˆ°é…ç½®ä¸­';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½® chinese_zhparser ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

#### å¤„ç†åœç”¨è¯

```sql
-- åˆ›å»ºåœç”¨è¯è¯å…¸ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- æ³¨æ„ï¼šåœç”¨è¯è¯å…¸éœ€è¦ç³»ç»Ÿæ–‡ä»¶æ”¯æŒ
        -- åˆ›å»ºåœç”¨è¯æ–‡ä»¶ï¼ˆéœ€è¦ç³»ç»Ÿæ–‡ä»¶ï¼‰

        IF EXISTS (SELECT 1 FROM pg_ts_dict WHERE dictname = 'chinese_stopwords') THEN
            RAISE WARNING 'åœç”¨è¯è¯å…¸ chinese_stopwords å·²å­˜åœ¨';
        ELSE
            CREATE TEXT SEARCH DICTIONARY chinese_stopwords (
                TEMPLATE = pg_catalog.simple,
                STOPWORDS = chinese_stopwords
            );
            RAISE NOTICE 'åœç”¨è¯è¯å…¸ chinese_stopwords åˆ›å»ºæˆåŠŸï¼ˆéœ€è¦ç³»ç»Ÿæ–‡ä»¶æ”¯æŒï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE EXCEPTION 'åœç”¨è¯æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆéœ€è¦åˆ›å»ºç³»ç»Ÿæ–‡ä»¶ï¼‰';
        WHEN duplicate_object THEN
            RAISE WARNING 'åœç”¨è¯è¯å…¸ chinese_stopwords å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåœç”¨è¯è¯å…¸å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_ts_config WHERE cfgname = 'chinese_zhparser') THEN
            RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½® chinese_zhparser ä¸å­˜åœ¨';
        END IF;

        ALTER TEXT SEARCH CONFIGURATION chinese_zhparser
            ALTER MAPPING FOR n,v,a,i,e,l
            WITH chinese_stopwords, simple;
        RAISE NOTICE 'åœç”¨è¯è¯å…¸å·²æ·»åŠ åˆ°é…ç½®ä¸­';
    EXCEPTION
        WHEN undefined_object THEN
            RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½® chinese_zhparser ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°é…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 3. å¤šè¯­è¨€å…¨æ–‡æœç´¢

### 3.1 è¯­è¨€æ£€æµ‹

#### ç®€å•è¯­è¨€æ£€æµ‹å‡½æ•°

```sql
-- åˆ›å»ºè¯­è¨€æ£€æµ‹å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'detect_language') THEN
            DROP FUNCTION detect_language(TEXT) CASCADE;
            RAISE NOTICE 'å‡½æ•° detect_language å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION detect_language(text TEXT)
        RETURNS regconfig AS $$
        BEGIN
            -- å‚æ•°éªŒè¯
            IF text IS NULL OR TRIM(text) = '' THEN
                RAISE EXCEPTION 'è¾“å…¥æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
            END IF;

            BEGIN
                -- æ£€æµ‹ä¸­æ–‡å­—ç¬¦
                IF text ~ '[\u4e00-\u9fa5]' THEN
                    RETURN 'chinese_zhparser'::regconfig;
                -- æ£€æµ‹æ—¥æ–‡å­—ç¬¦
                ELSIF text ~ '[\u3040-\u309F\u30A0-\u30FF]' THEN
                    RETURN 'japanese'::regconfig;
                -- æ£€æµ‹éŸ©æ–‡å­—ç¬¦
                ELSIF text ~ '[\uAC00-\uD7A3]' THEN
                    RETURN 'korean'::regconfig;
                -- é»˜è®¤è‹±è¯­
                ELSE
                    RETURN 'english'::regconfig;
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'è¯­è¨€æ£€æµ‹å¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql IMMUTABLE;
        RAISE NOTICE 'å‡½æ•° detect_language åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° detect_language å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä½¿ç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT detect_language('PostgreSQLæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®åº“');
-- è¿”å›: chinese_zhparser
```

### 3.2 å¤šè¯­è¨€é…ç½®

#### å­˜å‚¨è¯­è¨€ä¿¡æ¯

```sql
-- åˆ›å»ºå¤šè¯­è¨€æ–‡ç« è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'multilingual_articles') THEN
            RAISE WARNING 'è¡¨ multilingual_articles å·²å­˜åœ¨';
        ELSE
            CREATE TABLE multilingual_articles (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                language TEXT NOT NULL,  -- 'chinese', 'english', 'japanese', etc.
                tsv tsvector,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ multilingual_articles åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ multilingual_articles å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ multilingual_articles å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ ¹æ®è¯­è¨€è‡ªåŠ¨ç”Ÿæˆtsvectorï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'update_multilingual_tsv') THEN
            DROP FUNCTION update_multilingual_tsv() CASCADE;
            RAISE NOTICE 'å‡½æ•° update_multilingual_tsv å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION update_multilingual_tsv()
        RETURNS TRIGGER AS $$
        DECLARE
            config_name regconfig;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF NEW.language IS NULL OR TRIM(NEW.language) = '' THEN
                RAISE EXCEPTION 'languageå­—æ®µä¸èƒ½ä¸ºç©º';
            END IF;

            BEGIN
                -- æ ¹æ®languageé€‰æ‹©é…ç½®
                CASE NEW.language
                    WHEN 'chinese' THEN config_name := 'chinese_zhparser';
                    WHEN 'japanese' THEN config_name := 'japanese';
                    WHEN 'korean' THEN config_name := 'korean';
                    WHEN 'english' THEN config_name := 'english';
                    ELSE config_name := 'simple';
                END CASE;

                NEW.tsv :=
                    setweight(to_tsvector(config_name, COALESCE(NEW.title, '')), 'A') ||
                    setweight(to_tsvector(config_name, COALESCE(NEW.content, '')), 'B');

                RETURN NEW;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'æ›´æ–°å¤šè¯­è¨€tsvectorå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‡½æ•° update_multilingual_tsv åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° update_multilingual_tsv å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_multilingual_tsv_trigger') THEN
            DROP TRIGGER update_multilingual_tsv_trigger ON multilingual_articles;
            RAISE NOTICE 'è§¦å‘å™¨ update_multilingual_tsv_trigger å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TRIGGER update_multilingual_tsv_trigger
        BEFORE INSERT OR UPDATE ON multilingual_articles
        FOR EACH ROW
        EXECUTE FUNCTION update_multilingual_tsv();
        RAISE NOTICE 'è§¦å‘å™¨ update_multilingual_tsv_trigger åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ multilingual_articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§¦å‘å™¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'multilingual_articles') THEN
            RAISE EXCEPTION 'è¡¨ multilingual_articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'multilingual_articles' AND indexname = 'idx_multilingual_articles_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_multilingual_articles_tsv å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_multilingual_articles_tsv ON multilingual_articles USING GIN (tsv);
            RAISE NOTICE 'GINç´¢å¼• idx_multilingual_articles_tsv åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'multilingual_articles' AND indexname = 'idx_multilingual_articles_language') THEN
            RAISE WARNING 'ç´¢å¼• idx_multilingual_articles_language å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_multilingual_articles_language ON multilingual_articles (language);
            RAISE NOTICE 'ç´¢å¼• idx_multilingual_articles_language åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ multilingual_articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 3.3 æ··åˆè¯­è¨€æœç´¢

#### å¤šè¯­è¨€æœç´¢æŸ¥è¯¢

```sql
-- æœç´¢å¤šç§è¯­è¨€
WITH queries AS (
    SELECT
        'chinese' AS lang,
        to_tsquery('chinese_zhparser', 'æ•°æ®åº“') AS query
    UNION ALL
    SELECT
        'english' AS lang,
        to_tsquery('english', 'database') AS query
)
SELECT
    a.id,
    a.title,
    a.content,
    a.language,
    ts_rank(a.tsv, q.query) AS rank
FROM multilingual_articles a
JOIN queries q ON a.language = q.lang
WHERE a.tsv @@ q.query
ORDER BY rank DESC
LIMIT 20;
```

#### è·¨è¯­è¨€æœç´¢

```sql
-- è·¨è¯­è¨€æœç´¢ï¼ˆå°†æŸ¥è¯¢è½¬æ¢ä¸ºå¤šç§è¯­è¨€ï¼Œå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'multilingual_search') THEN
            DROP FUNCTION multilingual_search(TEXT) CASCADE;
            RAISE NOTICE 'å‡½æ•° multilingual_search å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION multilingual_search(search_text TEXT)
        RETURNS TABLE (
            id INTEGER,
            title TEXT,
            content TEXT,
            language TEXT,
            rank REAL
        ) AS $$
        BEGIN
            -- å‚æ•°éªŒè¯
            IF search_text IS NULL OR TRIM(search_text) = '' THEN
                RAISE EXCEPTION 'æœç´¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'multilingual_articles') THEN
                RAISE EXCEPTION 'è¡¨ multilingual_articles ä¸å­˜åœ¨';
            END IF;

            BEGIN
                RETURN QUERY
                SELECT
                    a.id,
                    a.title,
                    a.content,
                    a.language,
                    CASE a.language
                        WHEN 'chinese' THEN ts_rank(a.tsv, to_tsquery('chinese_zhparser', search_text))
                        WHEN 'english' THEN ts_rank(a.tsv, to_tsquery('english', search_text))
                        ELSE 0
                    END AS rank
                FROM multilingual_articles a
                WHERE
                    (a.language = 'chinese' AND a.tsv @@ to_tsquery('chinese_zhparser', search_text))
                    OR
                    (a.language = 'english' AND a.tsv @@ to_tsquery('english', search_text))
                ORDER BY rank DESC;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'è·¨è¯­è¨€æœç´¢æ‰§è¡Œå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‡½æ•° multilingual_search åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° multilingual_search å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä½¿ç”¨å‡½æ•°ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM multilingual_search('æ•°æ®åº“ | database');
```

---

## 4. å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–

### 4.1 GIN vs GiSTç´¢å¼•

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | GINç´¢å¼• | GiSTç´¢å¼• |
|------|---------|----------|
| **æŸ¥è¯¢é€Ÿåº¦** | å¿« | è¾ƒæ…¢ |
| **ç´¢å¼•å¤§å°** | å¤§ | å° |
| **æ›´æ–°é€Ÿåº¦** | æ…¢ | å¿« |
| **é€‚ç”¨åœºæ™¯** | è¯»å¤šå†™å°‘ | å†™å¤šè¯»å°‘ |
| **æ”¯æŒæ“ä½œ** | @@, @@@ | @@ |

#### é€‰æ‹©å»ºè®®

```sql
-- âœ… æ¨èä½¿ç”¨GINç´¢å¼•ï¼ˆå¤§å¤šæ•°åœºæ™¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tsv_gin') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv_gin å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_articles_tsv_gin ON articles USING GIN (tsv);
            RAISE NOTICE 'GINç´¢å¼• idx_articles_tsv_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- âœ… å†™å¯†é›†å‹åœºæ™¯ä½¿ç”¨GiSTç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tsv_gist') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv_gist å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_articles_tsv_gist ON articles USING GIST (tsv);
            RAISE NOTICE 'GiSTç´¢å¼• idx_articles_tsv_gist åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv_gist å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGiSTç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ³¨æ„ï¼šGINä¸æ”¯æŒç»„åˆç´¢å¼•ï¼Œéœ€è¦åˆ†åˆ«åˆ›å»ºç©ºé—´ç´¢å¼•å’Œå…¨æ–‡æœç´¢ç´¢å¼•
```

### 4.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

#### GINç´¢å¼•ä¼˜åŒ–

```sql
-- ä½¿ç”¨fastupdateå‚æ•°ï¼ˆå»¶è¿Ÿæ›´æ–°ï¼Œæå‡å†™å…¥æ€§èƒ½ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv å·²å­˜åœ¨ï¼Œå¦‚éœ€é‡æ–°åˆ›å»ºè¯·å…ˆåˆ é™¤';
        ELSE
            CREATE INDEX idx_articles_tsv ON articles
            USING GIN (tsv) WITH (fastupdate = on);
            RAISE NOTICE 'GINç´¢å¼• idx_articles_tsv åˆ›å»ºæˆåŠŸï¼ˆfastupdate=onï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tsv å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å®šæœŸæ¸…ç†å¾…å¤„ç†çš„æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒVACUUM';
        END IF;

        -- GINç´¢å¼•ä¼šç§¯ç´¯å¾…å¤„ç†çš„æ›´æ–°ï¼Œéœ€è¦å®šæœŸæ¸…ç†
        VACUUM articles;
        RAISE NOTICE 'VACUUMæ‰§è¡ŒæˆåŠŸ: articles';

        -- æˆ–è€…æ‰‹åŠ¨æ¸…ç†ï¼ˆå¸¦ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ï¼‰
        VACUUM ANALYZE articles;
        RAISE NOTICE 'VACUUM ANALYZEæ‰§è¡ŒæˆåŠŸ: articles';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'VACUUMæ‰§è¡Œå¤±è´¥: %', SQLERRM;
    END;
END $$;
```

#### éƒ¨åˆ†ç´¢å¼•

```sql
-- åªä¸ºæ´»è·ƒæ–‡ç« åˆ›å»ºç´¢å¼•ï¼ˆèŠ‚çœç©ºé—´ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        -- æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'articles' AND column_name = 'status'
        ) THEN
            RAISE EXCEPTION 'åˆ— status ä¸å­˜åœ¨';
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'articles' AND column_name = 'created_at'
        ) THEN
            RAISE EXCEPTION 'åˆ— created_at ä¸å­˜åœ¨';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_active_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_active_tsv å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_articles_active_tsv ON articles
            USING GIN (tsv)
            WHERE status = 'published' AND created_at > NOW() - INTERVAL '1 year';
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_articles_active_tsv åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨ï¼ˆè¯·æ£€æŸ¥statuså’Œcreated_atåˆ—ï¼‰';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_active_tsv å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºéƒ¨åˆ†ç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 4.3 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

#### ä½¿ç”¨LIMITé™åˆ¶ç»“æœ

```sql
-- âœ… æ¨èï¼šä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    query_text tsquery;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢';
            RETURN;
        END IF;

        query_text := to_tsquery('chinese_zhparser', 'æ•°æ®åº“');
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒLIMITæœç´¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM articles
WHERE tsv @@ to_tsquery('chinese_zhparser', 'æ•°æ®åº“')
ORDER BY ts_rank(tsv, to_tsquery('chinese_zhparser', 'æ•°æ®åº“')) DESC
LIMIT 20;
```

#### é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°

```sql
-- âŒ ä¸æ¨èï¼šå‡½æ•°åœ¨WHEREä¸­ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢';
            RETURN;
        END IF;
        RAISE NOTICE 'æµ‹è¯•ä¸æ¨èæ–¹å¼ï¼ˆå‡½æ•°åœ¨WHEREä¸­ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM articles
WHERE to_tsvector('chinese_zhparser', title || ' ' || content)
      @@ to_tsquery('chinese_zhparser', 'æ•°æ®åº“');
-- æ‰§è¡Œæ—¶é—´: æ…¢ï¼ˆæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œéœ€è¦åŠ¨æ€ç”Ÿæˆtsvectorï¼‰

-- âœ… æ¨èï¼šä½¿ç”¨é¢„è®¡ç®—çš„tsvectoråˆ—ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢';
            RETURN;
        END IF;

        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'articles' AND column_name = 'tsv'
        ) THEN
            RAISE WARNING 'åˆ— tsv ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºtsvectoråˆ—';
            RETURN;
        END IF;
        RAISE NOTICE 'æµ‹è¯•æ¨èæ–¹å¼ï¼ˆä½¿ç”¨é¢„è®¡ç®—çš„tsvectoråˆ—ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æœç´¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM articles
WHERE tsv @@ to_tsquery('chinese_zhparser', 'æ•°æ®åº“');
-- æ‰§è¡Œæ—¶é—´: å¿«ï¼ˆå¯ä»¥ä½¿ç”¨GINç´¢å¼•ï¼‰
```

---

## 5. å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ

### 5.1 æ··åˆæœç´¢æ¶æ„

```text
ç”¨æˆ·æŸ¥è¯¢
    â†“
æŸ¥è¯¢ç†è§£
    â”œâ”€ å…¨æ–‡æœç´¢æŸ¥è¯¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
    â””â”€ å‘é‡æœç´¢æŸ¥è¯¢ï¼ˆè¯­ä¹‰åŒ¹é…ï¼‰
    â†“
å¹¶è¡Œæ£€ç´¢
    â”œâ”€ å…¨æ–‡æœç´¢ç»“æœï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    â””â”€ å‘é‡æœç´¢ç»“æœï¼ˆè¯­ä¹‰ç›¸ä¼¼ï¼‰
    â†“
ç»“æœèåˆï¼ˆRRFã€åŠ æƒèåˆï¼‰
    â†“
æ’åºç»“æœ
```

### 5.2 å®ç°æ–¹æ¡ˆ

#### åˆ›å»ºæ··åˆæœç´¢è¡¨

```sql
-- åˆ›å»ºåŒ…å«å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢çš„è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE WARNING 'è¡¨ documents å·²å­˜åœ¨';
        ELSE
            -- æ£€æŸ¥pgvectoræ‰©å±•
            IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
                RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆæ‰§è¡Œ: CREATE EXTENSION vector;';
            END IF;

            CREATE TABLE documents (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                -- å…¨æ–‡æœç´¢
                tsv tsvector,
                -- å‘é‡æœç´¢ï¼ˆä½¿ç”¨pgvectorï¼‰
                embedding vector(384)  -- ä½¿ç”¨sentence-transformersæ¨¡å‹
            );
            RAISE NOTICE 'è¡¨ documents åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ documents å·²å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ documents å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'idx_documents_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_tsv å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_documents_tsv ON documents USING GIN (tsv);
            RAISE NOTICE 'GINç´¢å¼• idx_documents_tsv åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'idx_documents_embedding') THEN
            RAISE WARNING 'ç´¢å¼• idx_documents_embedding å·²å­˜åœ¨';
        ELSE
            -- æ£€æŸ¥pgvectoræ‰©å±•
            IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
                RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•åˆ›å»ºå‘é‡ç´¢å¼•';
            END IF;

            CREATE INDEX idx_documents_embedding ON documents USING ivfflat (embedding vector_cosine_ops);
            RAISE NOTICE 'IVFFlatç´¢å¼• idx_documents_embedding åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
        WHEN undefined_object THEN
            RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```
```

#### æ··åˆæ£€ç´¢å‡½æ•°

```sql
-- åˆ›å»ºæ··åˆæ£€ç´¢å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'hybrid_search') THEN
            DROP FUNCTION hybrid_search(TEXT, REAL, REAL, INTEGER) CASCADE;
            RAISE NOTICE 'å‡½æ•° hybrid_search å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION hybrid_search(
            search_text TEXT,
            text_weight REAL DEFAULT 0.5,
            vector_weight REAL DEFAULT 0.5,
            limit_count INTEGER DEFAULT 20
        )
        RETURNS TABLE (
            id INTEGER,
            title TEXT,
            content TEXT,
            text_score REAL,
            vector_score REAL,
            combined_score REAL
        ) AS $$
        DECLARE
            query_embedding vector(384);
            search_query tsquery;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF search_text IS NULL OR TRIM(search_text) = '' THEN
                RAISE EXCEPTION 'æœç´¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
            END IF;

            IF text_weight < 0 OR text_weight > 1 OR vector_weight < 0 OR vector_weight > 1 THEN
                RAISE EXCEPTION 'æƒé‡å¿…é¡»åœ¨0-1ä¹‹é—´: text_weight=%, vector_weight=%', text_weight, vector_weight;
            END IF;

            IF limit_count IS NULL OR limit_count < 1 OR limit_count > 1000 THEN
                RAISE EXCEPTION 'limit_countå¿…é¡»åœ¨1-1000ä¹‹é—´: %', limit_count;
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
                RAISE EXCEPTION 'è¡¨ documents ä¸å­˜åœ¨';
            END IF;

            BEGIN
                -- ç”ŸæˆæŸ¥è¯¢å‘é‡ï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦è°ƒç”¨åµŒå…¥æ¨¡å‹ï¼‰
                -- query_embedding := generate_embedding(search_text);
                -- ä¸´æ—¶ä½¿ç”¨é›¶å‘é‡ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦è°ƒç”¨åµŒå…¥æ¨¡å‹ï¼‰
                query_embedding := (SELECT embedding FROM documents LIMIT 1);
                IF query_embedding IS NULL THEN
                    RAISE EXCEPTION 'æ— æ³•ç”ŸæˆæŸ¥è¯¢å‘é‡ï¼ˆè¡¨documentsä¸ºç©ºæˆ–embeddingåˆ—ä¸å­˜åœ¨ï¼‰';
                END IF;

                -- ç”Ÿæˆå…¨æ–‡æœç´¢æŸ¥è¯¢
                search_query := to_tsquery('chinese_zhparser', search_text);

                RETURN QUERY
                WITH text_results AS (
                    SELECT
                        d.id,
                        d.title,
                        d.content,
                        ts_rank(d.tsv, search_query) AS score
                    FROM documents d
                    WHERE d.tsv @@ search_query
                    ORDER BY score DESC
                    LIMIT limit_count * 2  -- è·å–æ›´å¤šå€™é€‰ç»“æœ
                ),
                vector_results AS (
                    SELECT
                        d.id,
                        d.title,
                        d.content,
                        1 - (d.embedding <=> query_embedding) AS score  -- ä½™å¼¦ç›¸ä¼¼åº¦
                    FROM documents d
                    ORDER BY d.embedding <=> query_embedding
                    LIMIT limit_count * 2
                ),
                combined AS (
                    SELECT
                        COALESCE(t.id, v.id) AS id,
                        COALESCE(t.title, v.title) AS title,
                        COALESCE(t.content, v.content) AS content,
                        COALESCE(t.score, 0) AS text_score,
                        COALESCE(v.score, 0) AS vector_score,
                        COALESCE(t.score, 0) * text_weight + COALESCE(v.score, 0) * vector_weight AS combined_score
                    FROM text_results t
                    FULL OUTER JOIN vector_results v ON t.id = v.id
                )
                SELECT
                    c.id,
                    c.title,
                    c.content,
                    c.text_score,
                    c.vector_score,
                    c.combined_score
                FROM combined c
                ORDER BY c.combined_score DESC
                LIMIT limit_count;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'æ··åˆæ£€ç´¢æ‰§è¡Œå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‡½æ•° hybrid_search åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° hybrid_search å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

### 5.3 ç›¸å…³æ€§èåˆ

#### RRF (Reciprocal Rank Fusion)

```sql
-- RRFèåˆç®—æ³•
CREATE OR REPLACE FUNCTION rrf_fusion(
    text_ranks INTEGER[],
    vector_ranks INTEGER[],
    k INTEGER DEFAULT 60
)
RETURNS REAL AS $$
DECLARE
    text_score REAL := 0;
    vector_score REAL := 0;
    i INTEGER;
BEGIN
    -- è®¡ç®—æ–‡æœ¬æœç´¢RRFåˆ†æ•°
    FOREACH i IN ARRAY text_ranks
    LOOP
        text_score := text_score + 1.0 / (k + i);
    END LOOP;

    -- è®¡ç®—å‘é‡æœç´¢RRFåˆ†æ•°
    FOREACH i IN ARRAY vector_ranks
    LOOP
        vector_score := vector_score + 1.0 / (k + i);
    END LOOP;

    RETURN text_score + vector_score;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

---

## 7. å…¨æ–‡æœç´¢ä¸RAGé›†æˆ

### 7.1 RAGä¸­çš„æ£€ç´¢ç­–ç•¥

#### æ··åˆæ£€ç´¢RAG

```python
# Pythonç¤ºä¾‹ï¼šæ··åˆæ£€ç´¢RAG
import psycopg2
from sentence_transformers import SentenceTransformer
import numpy as np

class HybridRetrievalRAG:
    """æ··åˆæ£€ç´¢RAGç³»ç»Ÿ"""

    def __init__(self, db_config, embedding_model_name='paraphrase-multilingual-MiniLM-L12-v2'):
        self.conn = psycopg2.connect(**db_config)
        self.cursor = self.conn.cursor()
        self.embedding_model = SentenceTransformer(embedding_model_name)

    def retrieve(self, query: str, top_k: int = 5, text_weight: float = 0.4, vector_weight: float = 0.6):
        """æ··åˆæ£€ç´¢"""
        # ç”ŸæˆæŸ¥è¯¢å‘é‡
        query_embedding = self.embedding_model.encode(query).tolist()

        # å…¨æ–‡æœç´¢ + å‘é‡æœç´¢
        self.cursor.execute("""
            WITH text_results AS (
                SELECT
                    id,
                    content,
                    ts_rank(tsv, to_tsquery('chinese_zhparser', %s)) AS text_score
                FROM documents
                WHERE tsv @@ to_tsquery('chinese_zhparser', %s)
                ORDER BY text_score DESC
                LIMIT %s
            ),
            vector_results AS (
                SELECT
                    id,
                    content,
                    1 - (embedding <=> %s::vector) AS vector_score
                FROM documents
                ORDER BY embedding <=> %s::vector
                LIMIT %s
            ),
            combined AS (
                SELECT
                    COALESCE(t.id, v.id) AS id,
                    COALESCE(t.content, v.content) AS content,
                    COALESCE(t.text_score, 0) * %s + COALESCE(v.vector_score, 0) * %s AS combined_score
                FROM text_results t
                FULL OUTER JOIN vector_results v ON t.id = v.id
            )
            SELECT id, content, combined_score
            FROM combined
            ORDER BY combined_score DESC
            LIMIT %s
        """, (
            query, query, top_k * 2,
            query_embedding, query_embedding, top_k * 2,
            text_weight, vector_weight,
            top_k
        ))

        return self.cursor.fetchall()
```

---

## 8. ä¸Elasticsearchå¯¹æ¯”

### 8.1 åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQLå…¨æ–‡æœç´¢ | Elasticsearch |
| --- | --- | --- |
| **å®‰è£…éƒ¨ç½²** | å†…ç½®ï¼Œæ— éœ€é¢å¤–ç»„ä»¶ | éœ€è¦ç‹¬ç«‹éƒ¨ç½² |
| **ä¸­æ–‡æ”¯æŒ** | éœ€è¦zhparseræ‰©å±• | å†…ç½®IKåˆ†è¯å™¨ |
| **å®æ—¶æ€§** | å®æ—¶ï¼ˆäº‹åŠ¡å†…ï¼‰ | è¿‘å®æ—¶ï¼ˆ1ç§’ï¼‰ |
| **ä¸€è‡´æ€§** | å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰ | æœ€ç»ˆä¸€è‡´æ€§ |
| **å¤æ‚æŸ¥è¯¢** | SQLä¸°å¯Œ | DSLçµæ´» |
| **æ‰©å±•æ€§** | å‚ç›´æ‰©å±• | æ°´å¹³æ‰©å±• |
| **å­¦ä¹ æˆæœ¬** | ä½ï¼ˆSQLï¼‰ | ä¸­ï¼ˆDSLï¼‰ |

### 8.2 æ€§èƒ½å¯¹æ¯”

```text
å°è§„æ¨¡æ•°æ®ï¼ˆ<100ä¸‡æ–‡æ¡£ï¼‰:
- PostgreSQL: æ€§èƒ½ç›¸å½“æˆ–æ›´å¥½
- Elasticsearch: å¼€é”€è¾ƒå¤§

ä¸­ç­‰è§„æ¨¡æ•°æ®ï¼ˆ100ä¸‡-1äº¿æ–‡æ¡£ï¼‰:
- PostgreSQL: æ€§èƒ½è‰¯å¥½ï¼Œéœ€è¦ä¼˜åŒ–
- Elasticsearch: æ€§èƒ½ä¼˜ç§€ï¼Œæ¨ªå‘æ‰©å±•

å¤§è§„æ¨¡æ•°æ®ï¼ˆ>1äº¿æ–‡æ¡£ï¼‰:
- PostgreSQL: éœ€è¦åˆ†ç‰‡å’Œä¼˜åŒ–
- Elasticsearch: å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼
```

### 8.3 é€‰æ‹©å»ºè®®

```text
é€‰æ‹©PostgreSQLå…¨æ–‡æœç´¢:
âœ… æ•°æ®é‡ < 1äº¿æ–‡æ¡£
âœ… éœ€è¦å¼ºä¸€è‡´æ€§
âœ… éœ€è¦å¤æ‚SQLæŸ¥è¯¢
âœ… å¸Œæœ›å‡å°‘ç³»ç»Ÿå¤æ‚åº¦
âœ… æ•°æ®å·²åœ¨PostgreSQLä¸­

é€‰æ‹©Elasticsearch:
âœ… æ•°æ®é‡ > 1äº¿æ–‡æ¡£
âœ… éœ€è¦æ°´å¹³æ‰©å±•
âœ… éœ€è¦å¤æ‚çš„èšåˆåˆ†æ
âœ… éœ€è¦æ—¥å¿—åˆ†æåœºæ™¯
âœ… å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§
```

---

## 9. å®æˆ˜æ¡ˆä¾‹

### 9.1 åšå®¢æœç´¢ç³»ç»Ÿ

#### æ•°æ®æ¨¡å‹

```sql
-- åšå®¢æ–‡ç« è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'blog_posts') THEN
            RAISE WARNING 'è¡¨ blog_posts å·²å­˜åœ¨';
        ELSE
            CREATE TABLE blog_posts (
                id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                author_id INTEGER,
                category_id INTEGER,
                published_at TIMESTAMPTZ,
                status TEXT DEFAULT 'draft',  -- 'draft', 'published', 'archived'
                tsv tsvector,
                view_count INTEGER DEFAULT 0
            );
            RAISE NOTICE 'è¡¨ blog_posts åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ blog_posts å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ blog_posts å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'blog_posts') THEN
            RAISE EXCEPTION 'è¡¨ blog_posts ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'blog_posts' AND indexname = 'idx_blog_posts_tsv') THEN
            RAISE WARNING 'ç´¢å¼• idx_blog_posts_tsv å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_blog_posts_tsv ON blog_posts USING GIN (tsv);
            RAISE NOTICE 'GINç´¢å¼• idx_blog_posts_tsv åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'blog_posts' AND indexname = 'idx_blog_posts_status') THEN
            RAISE WARNING 'ç´¢å¼• idx_blog_posts_status å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_blog_posts_status ON blog_posts (status) WHERE status = 'published';
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_blog_posts_status åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'blog_posts' AND indexname = 'idx_blog_posts_published') THEN
            RAISE WARNING 'ç´¢å¼• idx_blog_posts_published å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_blog_posts_published ON blog_posts (published_at DESC) WHERE status = 'published';
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_blog_posts_published åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ blog_posts ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

#### æœç´¢API

```sql
-- æœç´¢åšå®¢æ–‡ç« ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'search_blog_posts') THEN
            DROP FUNCTION search_blog_posts(TEXT, INTEGER, INTEGER) CASCADE;
            RAISE NOTICE 'å‡½æ•° search_blog_posts å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE OR REPLACE FUNCTION search_blog_posts(
            search_text TEXT,
            category_id INTEGER DEFAULT NULL,
            limit_count INTEGER DEFAULT 20
        )
        RETURNS TABLE (
            id INTEGER,
            title TEXT,
            content_preview TEXT,
            author_id INTEGER,
            published_at TIMESTAMPTZ,
            rank REAL
        ) AS $$
        DECLARE
            search_query tsquery;
        BEGIN
            -- å‚æ•°éªŒè¯
            IF search_text IS NULL OR TRIM(search_text) = '' THEN
                RAISE EXCEPTION 'æœç´¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
            END IF;

            IF limit_count IS NULL OR limit_count < 1 OR limit_count > 1000 THEN
                RAISE EXCEPTION 'limit_countå¿…é¡»åœ¨1-1000ä¹‹é—´: %', limit_count;
            END IF;

            -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'blog_posts') THEN
                RAISE EXCEPTION 'è¡¨ blog_posts ä¸å­˜åœ¨';
            END IF;

            BEGIN
                -- ç”Ÿæˆå…¨æ–‡æœç´¢æŸ¥è¯¢
                search_query := to_tsquery('chinese_zhparser', search_text);

                RETURN QUERY
                SELECT
                    p.id,
                    p.title,
                    LEFT(p.content, 200) AS content_preview,
                    p.author_id,
                    p.published_at,
                    ts_rank(p.tsv, search_query) AS rank
                FROM blog_posts p
                WHERE p.status = 'published'
                  AND p.tsv @@ search_query
                  AND (category_id IS NULL OR p.category_id = category_id)
                ORDER BY rank DESC, p.published_at DESC
                LIMIT limit_count;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE EXCEPTION 'æœç´¢æ‰§è¡Œå¤±è´¥: %', SQLERRM;
            END;
        END;
        $$ LANGUAGE plpgsql;
        RAISE NOTICE 'å‡½æ•° search_blog_posts åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºå‡½æ•° search_blog_posts å¤±è´¥: %', SQLERRM;
    END;
END $$;

---

## ğŸ“š å‚è€ƒèµ„æº

1. **PostgreSQLå…¨æ–‡æœç´¢æ–‡æ¡£**: <https://www.postgresql.org/docs/current/textsearch.html>
2. **zhparser GitHub**: <https://github.com/amutu/zhparser>
3. **pg_jieba GitHub**: <https://github.com/jaiminpan/pg_jieba>
4. **Elasticsearchå¯¹æ¯”**: <https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html>

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.0** (2025-01): å®Œæ•´å®æˆ˜æŒ‡å—
  - æ•´åˆå…¨æ–‡æœç´¢åŸºç¡€
  - è¡¥å……ä¸­æ–‡å…¨æ–‡æœç´¢å®Œæ•´æ–¹æ¡ˆ
  - æ·»åŠ å¤šè¯­è¨€å…¨æ–‡æœç´¢
  - è¡¥å……æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
  - æ·»åŠ å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ
  - è¡¥å……é«˜çº§æœç´¢åŠŸèƒ½
  - æ·»åŠ å…¨æ–‡æœç´¢ä¸RAGé›†æˆ
  - è¡¥å……Elasticsearchå¯¹æ¯”
  - æ·»åŠ å®æˆ˜æ¡ˆä¾‹

---

**çŠ¶æ€**: âœ… **æ–‡æ¡£å®Œæˆ** | [è¿”å›ç›®å½•](./README.md)
