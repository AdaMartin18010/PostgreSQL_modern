---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\05-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–\05.03-BTreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# BTreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [BTreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜](#btreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 B-Treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°](#10-b-treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 B-Treeæ’å…¥ç®—æ³•](#21-b-treeæ’å…¥ç®—æ³•)
    - [2.2 ä¸å˜å¼ç»´æŠ¤](#22-ä¸å˜å¼ç»´æŠ¤)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 æ’å…¥æ“ä½œå½¢å¼åŒ–](#31-æ’å…¥æ“ä½œå½¢å¼åŒ–)
    - [3.2 ä¸å˜å¼å½¢å¼åŒ–](#32-ä¸å˜å¼å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 æ’å…¥ä¸å˜å¼å®šç†](#41-æ’å…¥ä¸å˜å¼å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18 B-Treeæ’å…¥å®ç°è¯¦è§£](#51-postgresql-18-b-treeæ’å…¥å®ç°è¯¦è§£)
      - [5.1.1 æ’å…¥ç®—æ³•å®ç°](#511-æ’å…¥ç®—æ³•å®ç°)
      - [5.1.2 ä¸å˜å¼éªŒè¯](#512-ä¸å˜å¼éªŒè¯)
      - [5.1.3 æ’å…¥æ€§èƒ½ä¼˜åŒ–](#513-æ’å…¥æ€§èƒ½ä¼˜åŒ–)
    - [5.2 ä¸SQLite 3.45å¯¹æ¯”](#52-ä¸sqlite-345å¯¹æ¯”)
      - [5.2.1 B-Treeæ’å…¥å®ç°å¯¹æ¯”](#521-b-treeæ’å…¥å®ç°å¯¹æ¯”)
      - [5.2.2 æ’å…¥æ“ä½œå¯¹æ¯”](#522-æ’å…¥æ“ä½œå¯¹æ¯”)
      - [5.2.3 æ€§èƒ½å¯¹æ¯”](#523-æ€§èƒ½å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [5.3.1 æ¡ˆä¾‹1ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿæ’å…¥ä¼˜åŒ–](#531-æ¡ˆä¾‹1é«˜å¹¶å‘è®¢å•ç³»ç»Ÿæ’å…¥ä¼˜åŒ–)
      - [5.3.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—ç³»ç»Ÿæ—¶é—´åºåˆ—æ’å…¥](#532-æ¡ˆä¾‹2æ—¥å¿—ç³»ç»Ÿæ—¶é—´åºåˆ—æ’å…¥)
      - [5.3.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿæ’å…¥ä¼˜åŒ–](#533-æ¡ˆä¾‹3ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿæ’å…¥ä¼˜åŒ–)
    - [5.4 æ€§èƒ½å¯¹æ¯”æ•°æ®](#54-æ€§èƒ½å¯¹æ¯”æ•°æ®)
      - [5.4.1 æ’å…¥æ€§èƒ½å¯¹æ¯”](#541-æ’å…¥æ€§èƒ½å¯¹æ¯”)
      - [5.4.2 æ’å…¥åæŸ¥è¯¢æ€§èƒ½](#542-æ’å…¥åæŸ¥è¯¢æ€§èƒ½)
    - [5.5 æœ€ä½³å®è·µ](#55-æœ€ä½³å®è·µ)
      - [5.5.1 æ’å…¥ä¼˜åŒ–ç­–ç•¥](#551-æ’å…¥ä¼˜åŒ–ç­–ç•¥)
      - [5.5.2 ä¸å˜å¼éªŒè¯ç­–ç•¥](#552-ä¸å˜å¼éªŒè¯ç­–ç•¥)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 å½¢å¼åŒ–è¯æ˜ç›¸å…³](#72-å½¢å¼åŒ–è¯æ˜ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 B-Treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°

**B-Treeä¸å˜å¼**ï¼š

B-Treeçš„ä¸å˜å¼æ˜¯ä¿è¯B-Treeæ­£ç¡®æ€§çš„å…³é”®æ€§è´¨ã€‚æ’å…¥æ“ä½œå¿…é¡»ç»´æŠ¤è¿™äº›ä¸å˜å¼ï¼Œå¦åˆ™B-Treeçš„ç»“æ„ä¼šè¢«ç ´åï¼Œå¯¼è‡´æŸ¥è¯¢ç»“æœé”™è¯¯ã€‚

**B-Treeä¸å˜å¼**ï¼š

```mermaid
flowchart TD
    A[B-Treeä¸å˜å¼] --> B[èŠ‚ç‚¹é”®æ•°é™åˆ¶]
    A --> C[é”®é¡ºåºæ€§]
    A --> D[æ ‘å¹³è¡¡æ€§]
    B --> E[æœ€å°é”®æ•°: âŒˆm/2âŒ‰-1]
    B --> F[æœ€å¤§é”®æ•°: m-1]
    C --> G[å·¦å­æ ‘ < é”® < å³å­æ ‘]
    D --> H[æ‰€æœ‰å¶å­èŠ‚ç‚¹åŒå±‚]
    E --> I[ç»“æ„æ­£ç¡®æ€§]
    F --> I
    G --> I
    H --> I

    style A fill:#FFD700
    style I fill:#87CEEB
```

**æ’å…¥æ“ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥é”®å€¼] --> B[æŸ¥æ‰¾æ’å…¥ä½ç½®]
    B --> C{èŠ‚ç‚¹æœªæ»¡?}
    C -->|æ˜¯| D[ç›´æ¥æ’å…¥]
    C -->|å¦| E[èŠ‚ç‚¹åˆ†è£‚]
    E --> F[å‘ä¸Šä¼ æ’­]
    F --> G{æ ¹èŠ‚ç‚¹åˆ†è£‚?}
    G -->|æ˜¯| H[åˆ›å»ºæ–°æ ¹]
    G -->|å¦| F
    D --> I[éªŒè¯ä¸å˜å¼]
    H --> I
    I --> J{ä¸å˜å¼æ»¡è¶³?}
    J -->|æ˜¯| K[æ’å…¥æˆåŠŸ]
    J -->|å¦| L[æ’å…¥å¤±è´¥]

    style A fill:#FFD700
    style I fill:#90EE90
    style K fill:#87CEEB
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **ä¸å˜å¼å®šä¹‰**ï¼šB-Treeä¸å˜å¼çš„ä¸¥æ ¼æ•°å­¦å®šä¹‰
- **æ’å…¥ç®—æ³•**ï¼šB-Treeæ’å…¥æ“ä½œçš„ç®—æ³•æè¿°
- **å½’çº³è¯æ˜**ï¼šä½¿ç”¨æ•°å­¦å½’çº³æ³•ä¸¥æ ¼è¯æ˜æ’å…¥æ“ä½œç»´æŠ¤ä¸å˜å¼
- **æ­£ç¡®æ€§ä¿è¯**ï¼šè¯æ˜æ’å…¥æ“ä½œçš„æ­£ç¡®æ€§

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 B-Treeæ’å…¥ç®—æ³•

**æ’å…¥ç®—æ³•**ï¼š

```haskell
-- B-Treeæ’å…¥
insert :: BTree -> Key -> Value -> BTree
insert tree key value =
    let (newTree, split) = insertNode(tree.root, key, value)
    in if split then
        createNewRoot(newTree)
    else
        newTree

-- èŠ‚ç‚¹æ’å…¥
insertNode :: Node -> Key -> Value -> (Node, Bool)
insertNode node key value =
    if isLeaf(node) then
        insertIntoLeaf(node, key, value)
    else
        let (child, split) = insertNode(findChild(node, key), key, value)
        in if split then
            splitNode(node, child)
        else
            (updateChild(node, child), False)
```

**æ’å…¥æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥é”®å€¼] --> B[æŸ¥æ‰¾æ’å…¥ä½ç½®]
    B --> C{å¶å­èŠ‚ç‚¹?}
    C -->|æ˜¯| D{èŠ‚ç‚¹æœªæ»¡?}
    C -->|å¦| E[é€’å½’æ’å…¥å­èŠ‚ç‚¹]
    D -->|æ˜¯| F[ç›´æ¥æ’å…¥]
    D -->|å¦| G[èŠ‚ç‚¹åˆ†è£‚]
    E --> H{å­èŠ‚ç‚¹åˆ†è£‚?}
    H -->|æ˜¯| G
    H -->|å¦| I[æ›´æ–°èŠ‚ç‚¹]
    G --> J[å‘ä¸Šä¼ æ’­]
    J --> K{æ ¹èŠ‚ç‚¹åˆ†è£‚?}
    K -->|æ˜¯| L[åˆ›å»ºæ–°æ ¹]
    K -->|å¦| I
    F --> M[éªŒè¯ä¸å˜å¼]
    I --> M
    L --> M

    style A fill:#FFD700
    style M fill:#90EE90
```

### 2.2 ä¸å˜å¼ç»´æŠ¤

**ä¸å˜å¼ç»´æŠ¤ç­–ç•¥**ï¼š

| ä¸å˜å¼ | ç»´æŠ¤æ–¹æ³• | éªŒè¯æ—¶æœº |
|--------|---------|---------|
| **é”®æ•°é™åˆ¶** | èŠ‚ç‚¹åˆ†è£‚ | æ’å…¥å |
| **é”®é¡ºåº** | æœ‰åºæ’å…¥ | æ’å…¥æ—¶ |
| **æ ‘å¹³è¡¡** | åˆ†è£‚ä¼ æ’­ | åˆ†è£‚å |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 æ’å…¥æ“ä½œå½¢å¼åŒ–

**æ’å…¥æ“ä½œ**ï¼š

```haskell
-- æ’å…¥æ“ä½œå½¢å¼åŒ–
insert(T, k, v) =
    let T' = insertIntoTree(T, k, v)
    in
        if violatesInvariant(T') then
            fixInvariant(T')
        else
            T'
```

### 3.2 ä¸å˜å¼å½¢å¼åŒ–

**ä¸å˜å¼**ï¼š

```haskell
-- ä¸å˜å¼å½¢å¼åŒ–
Invariant(T) =
    forall node n in T:
        âŒˆm/2âŒ‰ - 1 <= |n.keys| <= m - 1
        and
        keys(n) are sorted
        and
        all leaves at same level
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 æ’å…¥ä¸å˜å¼å®šç†

**å®šç†**ï¼šå¯¹äºä»»æ„B-Tree Tå’Œé”®å€¼å¯¹(k, v)ï¼Œå¦‚æœæ’å…¥å‰Tæ»¡è¶³æ‰€æœ‰ä¸å˜å¼ï¼Œåˆ™æ’å…¥åT' = insert(T, k, v)ä¹Ÿæ»¡è¶³æ‰€æœ‰ä¸å˜å¼ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾B-Tree Tæ»¡è¶³ä¸å˜å¼I = {é”®æ•°é™åˆ¶ã€é”®é¡ºåºã€æ ‘å¹³è¡¡}ã€‚å¯¹äºä»»æ„é”®kå’Œå€¼vï¼Œå¦‚æœinsert(T, k, v) = T'ï¼Œåˆ™T'ä¹Ÿæ»¡è¶³ä¸å˜å¼Iã€‚

**å½’çº³è¯æ˜**ï¼ˆå¯¹æ ‘çš„é«˜åº¦hè¿›è¡Œå½’çº³ï¼‰ï¼š

**æ­¥éª¤1ï¼šåŸºç¡€æƒ…å†µï¼ˆh = 0ï¼Œç©ºæ ‘ï¼‰**:

- ç©ºæ ‘Tâ‚€æ»¡è¶³æ‰€æœ‰ä¸å˜å¼ï¼ˆç©ºæ ‘æ²¡æœ‰èŠ‚ç‚¹ï¼Œä¸å˜å¼å¹³å‡¡æ»¡è¶³ï¼‰
- æ’å…¥ç¬¬ä¸€ä¸ªé”®å€¼å¯¹(k, v)åï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹nï¼ŒåŒ…å«ä¸€ä¸ªé”®å€¼å¯¹
- æ ¹èŠ‚ç‚¹æ»¡è¶³é”®æ•°é™åˆ¶ï¼š1 â‰¤ m - 1ï¼ˆå‡è®¾m â‰¥ 2ï¼‰
- æ ¹èŠ‚ç‚¹æ»¡è¶³é”®é¡ºåºï¼šå•ä¸ªé”®æœ‰åº
- æ ¹èŠ‚ç‚¹æ»¡è¶³æ ‘å¹³è¡¡ï¼šå•ä¸ªèŠ‚ç‚¹ï¼Œæ‰€æœ‰å¶å­èŠ‚ç‚¹åŒå±‚
- å› æ­¤ï¼Œæ’å…¥åæ ‘Tâ‚æ»¡è¶³æ‰€æœ‰ä¸å˜å¼

**æ­¥éª¤2ï¼šå½’çº³å‡è®¾**:

- å‡è®¾å¯¹äºæ‰€æœ‰é«˜åº¦h < Hçš„B-Treeï¼Œå¦‚æœæ’å…¥å‰æ»¡è¶³ä¸å˜å¼ï¼Œåˆ™æ’å…¥åä¹Ÿæ»¡è¶³ä¸å˜å¼

**æ­¥éª¤3ï¼šå½’çº³æ­¥éª¤ï¼ˆh = Hï¼‰**:

- è®¾Tæ˜¯é«˜åº¦ä¸ºHçš„B-Treeï¼Œæ’å…¥å‰æ»¡è¶³æ‰€æœ‰ä¸å˜å¼
- æ’å…¥æ“ä½œinsert(T, k, v)çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
  - ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®é”®é¡ºåºæ‰¾åˆ°æ’å…¥è·¯å¾„
  - åˆ°è¾¾å¶å­èŠ‚ç‚¹nï¼Œæ’å…¥é”®å€¼å¯¹(k, v)

**æ­¥éª¤4ï¼šæƒ…å†µ1 - å¶å­èŠ‚ç‚¹æœªæ»¡**:

- å¦‚æœå¶å­èŠ‚ç‚¹næœªæ»¡ï¼ˆ|n.keys| < m - 1ï¼‰ï¼Œç›´æ¥æ’å…¥é”®å€¼å¯¹
- æ’å…¥åï¼Œn.keysä»ç„¶æœ‰åºï¼ˆæ’å…¥æ—¶ç»´æŠ¤é¡ºåºï¼‰
- æ’å…¥åï¼Œ|n.keys| â‰¤ m - 1ï¼Œæ»¡è¶³é”®æ•°é™åˆ¶
- æ’å…¥åï¼Œæ ‘çš„é«˜åº¦ä¸å˜ï¼Œæ‰€æœ‰å¶å­èŠ‚ç‚¹ä»åŒå±‚
- å› æ­¤ï¼Œæ’å…¥åæ ‘æ»¡è¶³æ‰€æœ‰ä¸å˜å¼

**æ­¥éª¤5ï¼šæƒ…å†µ2 - å¶å­èŠ‚ç‚¹æ»¡ï¼ˆéœ€è¦åˆ†è£‚ï¼‰**:

- å¦‚æœå¶å­èŠ‚ç‚¹næ»¡ï¼ˆ|n.keys| = m - 1ï¼‰ï¼Œæ’å…¥åéœ€è¦åˆ†è£‚
- åˆ†è£‚æ“ä½œï¼šå°†nåˆ†è£‚ä¸ºnâ‚å’Œnâ‚‚ï¼Œä¸­é—´é”®kâ‚˜æå‡åˆ°çˆ¶èŠ‚ç‚¹
- åˆ†è£‚åï¼Œnâ‚å’Œnâ‚‚éƒ½æ»¡è¶³é”®æ•°é™åˆ¶ï¼šâŒˆm/2âŒ‰ - 1 â‰¤ |nâ‚.keys|, |nâ‚‚.keys| â‰¤ m - 1
- åˆ†è£‚åï¼Œnâ‚å’Œnâ‚‚çš„é”®ä»ç„¶æœ‰åº
- åˆ†è£‚åï¼Œæ ‘çš„é«˜åº¦å¯èƒ½å¢åŠ ï¼ˆå¦‚æœæ ¹èŠ‚ç‚¹åˆ†è£‚ï¼‰

**æ­¥éª¤6ï¼šåˆ†è£‚å‘ä¸Šä¼ æ’­**:

- å¦‚æœçˆ¶èŠ‚ç‚¹påœ¨æ¥æ”¶æå‡é”®åä¹Ÿæ»¡ï¼Œéœ€è¦ç»§ç»­åˆ†è£‚
- åˆ†è£‚å‘ä¸Šä¼ æ’­ï¼Œç›´åˆ°ï¼š
  - æŸä¸ªèŠ‚ç‚¹æœªæ»¡ï¼Œåˆ†è£‚åœæ­¢
  - æ ¹èŠ‚ç‚¹åˆ†è£‚ï¼Œåˆ›å»ºæ–°æ ¹ï¼Œæ ‘é«˜åº¦å¢åŠ 1
- æ¯æ¬¡åˆ†è£‚éƒ½ç»´æŠ¤ä¸å˜å¼ï¼šåˆ†è£‚åçš„èŠ‚ç‚¹æ»¡è¶³é”®æ•°é™åˆ¶å’Œé”®é¡ºåº

**æ­¥éª¤7ï¼šæ ‘å¹³è¡¡æ€§ç»´æŠ¤**:

- å¦‚æœæ ¹èŠ‚ç‚¹åˆ†è£‚ï¼Œåˆ›å»ºæ–°æ ¹rï¼Œé«˜åº¦å¢åŠ 1
- æ–°æ ¹råŒ…å«ä¸€ä¸ªé”®ï¼Œæ»¡è¶³é”®æ•°é™åˆ¶
- æ–°æ ¹rçš„ä¸¤ä¸ªå­èŠ‚ç‚¹æ˜¯åŸæ ¹åˆ†è£‚åçš„èŠ‚ç‚¹ï¼Œé«˜åº¦ç›¸åŒ
- å› æ­¤ï¼Œæ‰€æœ‰å¶å­èŠ‚ç‚¹ä»åŒå±‚ï¼Œæ»¡è¶³æ ‘å¹³è¡¡æ€§

**æ­¥éª¤8ï¼šç»“è®º**:

- æ— è®ºæ’å…¥æ“ä½œæ˜¯å¦è§¦å‘åˆ†è£‚ï¼Œæ’å…¥åæ ‘éƒ½æ»¡è¶³æ‰€æœ‰ä¸å˜å¼
- ç”±å½’çº³æ³•ï¼Œå¯¹äºä»»æ„é«˜åº¦çš„B-Treeï¼Œæ’å…¥æ“ä½œç»´æŠ¤æ‰€æœ‰ä¸å˜å¼
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ’å…¥ä¸å˜å¼] --> B[åŸºç¡€æƒ…å†µ]
    A --> C[å½’çº³æ­¥éª¤]
    B --> D[ç©ºæ ‘æ’å…¥]
    C --> E[å‡è®¾æ’å…¥å‰æ»¡è¶³]
    E --> F[æ’å…¥æ“ä½œ]
    F --> G{è¿åä¸å˜å¼?}
    G -->|æ˜¯| H[èŠ‚ç‚¹åˆ†è£‚]
    G -->|å¦| I[æ»¡è¶³ä¸å˜å¼]
    H --> J[æ¢å¤ä¸å˜å¼]
    J --> I

    style A fill:#FFD700
    style I fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 B-Treeæ’å…¥å®ç°è¯¦è§£

#### 5.1.1 æ’å…¥ç®—æ³•å®ç°

**PostgreSQL 18 B-Treeæ’å…¥æµç¨‹**ï¼š

1. **æŸ¥æ‰¾æ’å…¥ä½ç½®**ï¼š
   - ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å®šä½é”®çš„ä½ç½®
   - æ ¹æ®é”®é¡ºåºé€‰æ‹©å­èŠ‚ç‚¹ï¼Œé€’å½’åˆ°å¶å­èŠ‚ç‚¹

2. **æ’å…¥é”®å€¼å¯¹**ï¼š
   - åœ¨å¶å­èŠ‚ç‚¹ä¸­æ‰¾åˆ°æ­£ç¡®çš„æ’å…¥ä½ç½®
   - ç»´æŠ¤é”®çš„æœ‰åºæ€§ï¼ˆæ’å…¥æ—¶ä¿æŒæ’åºï¼‰

3. **èŠ‚ç‚¹åˆ†è£‚å¤„ç†**ï¼š
   - å¦‚æœèŠ‚ç‚¹æ»¡ï¼ˆè¾¾åˆ°fillfactorï¼‰ï¼Œè§¦å‘åˆ†è£‚
   - åˆ†è£‚ç‚¹é€‰æ‹©ï¼šä¸­é—´é”®æˆ–æœ€ä¼˜åˆ†è£‚ç‚¹
   - æå‡ä¸­é—´é”®åˆ°çˆ¶èŠ‚ç‚¹

4. **åˆ†è£‚å‘ä¸Šä¼ æ’­**ï¼š
   - å¦‚æœçˆ¶èŠ‚ç‚¹ä¹Ÿæ»¡ï¼Œç»§ç»­åˆ†è£‚
   - ç›´åˆ°æ ¹èŠ‚ç‚¹åˆ†è£‚ï¼Œåˆ›å»ºæ–°æ ¹ï¼Œæ ‘é«˜åº¦å¢åŠ 

**PostgreSQL 18 B-TreeèŠ‚ç‚¹ç»“æ„**ï¼š

```c
// PostgreSQL B-TreeèŠ‚ç‚¹ç»“æ„ï¼ˆç®€åŒ–ï¼‰
typedef struct BTPageOpaqueData {
    uint32      btpo_flags;      // èŠ‚ç‚¹æ ‡å¿—ï¼ˆå¶å­/å†…éƒ¨/æ ¹ï¼‰
    BlockNumber btpo_prev;       // å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¶å­èŠ‚ç‚¹é“¾è¡¨ï¼‰
    BlockNumber btpo_next;       // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¶å­èŠ‚ç‚¹é“¾è¡¨ï¼‰
    uint16      btpo_level;      // èŠ‚ç‚¹å±‚çº§ï¼ˆ0=å¶å­ï¼‰
    TransactionId btpo_cycleid;  // å¾ªç¯IDï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰
} BTPageOpaqueData;
```

**æ’å…¥æ“ä½œç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºè¡¨å¹¶æ’å…¥æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            DROP TABLE orders CASCADE;
            RAISE NOTICE 'è¡¨ orders å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE orders (
            order_id BIGSERIAL PRIMARY KEY,
            customer_id BIGINT NOT NULL,
            order_date TIMESTAMP NOT NULL,
            total_amount DECIMAL(10,2)
        );
        RAISE NOTICE 'è¡¨ orders åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- åˆ›å»ºB-Treeç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_customer_id') THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_orders_customer_id ON orders(customer_id);
            RAISE NOTICE 'B-Treeç´¢å¼• idx_orders_customer_id åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ‰¹é‡æ’å…¥æ•°æ®ï¼ˆè§¦å‘B-Treeæ’å…¥å’Œåˆ†è£‚ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    insert_count BIGINT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
        END IF;

        INSERT INTO orders (customer_id, order_date, total_amount)
        SELECT
            (random() * 10000)::bigint,
            NOW() - (random() * 365)::integer * INTERVAL '1 day',
            (random() * 1000)::decimal(10,2)
        FROM generate_series(1, 100000);
        GET DIAGNOSTICS insert_count = ROW_COUNT;
        RAISE NOTICE 'æ‰¹é‡æ’å…¥æ•°æ®æˆåŠŸ: % è¡Œ', insert_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ‰¹é‡æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ï¼ˆè§‚å¯Ÿæ’å…¥åçš„ç´¢å¼•çŠ¶æ€ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_id'
        ) THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ï¼ˆè§‚å¯Ÿæ’å…¥åçš„ç´¢å¼•çŠ¶æ€ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    indexrelname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE indexrelname = 'idx_orders_customer_id';
```

#### 5.1.2 ä¸å˜å¼éªŒè¯

**PostgreSQL 18ä¸å˜å¼éªŒè¯æœºåˆ¶**ï¼š

```sql
-- ä½¿ç”¨amcheckæ‰©å±•éªŒè¯B-Treeä¸å˜å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'amcheck') THEN
            CREATE EXTENSION IF NOT EXISTS amcheck;
            RAISE NOTICE 'amcheckæ‰©å±•åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'amcheckæ‰©å±•å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_file THEN
            RAISE EXCEPTION 'amcheckæ‰©å±•æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆéœ€è¦å®‰è£…amcheckæ‰©å±•ï¼‰';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'å®‰è£…amcheckæ‰©å±•å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_id'
        ) THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯';
            RETURN;
        END IF;

        RAISE NOTICE 'ç´¢å¼•ä¸å˜å¼éªŒè¯å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œï¼‰:';
        RAISE NOTICE '  SELECT bt_index_check(''idx_orders_customer_id'');';
        RAISE NOTICE '  SELECT * FROM bt_index_check(''idx_orders_customer_id'', true);';
        RAISE NOTICE '  SELECT bt_index_parent_check(''orders'');';
        -- æ³¨æ„ï¼šbt_index_checkè¿”å›ç©ºè¡¨ç¤ºéªŒè¯é€šè¿‡ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯è¡¨ç¤ºéªŒè¯å¤±è´¥
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'ç´¢å¼•æˆ–è¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'éªŒè¯ç´¢å¼•ä¸å˜å¼å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

**æ’å…¥åéªŒè¯ç¤ºä¾‹**ï¼š

```sql
-- æ’å…¥æ•°æ®åéªŒè¯ä¸å˜å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    insert_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
        END IF;

        INSERT INTO orders (customer_id, order_date, total_amount)
        VALUES (12345, NOW(), 500.00);
        GET DIAGNOSTICS insert_count = ROW_COUNT;
        RAISE NOTICE 'æ•°æ®æ’å…¥æˆåŠŸ: % è¡Œ', insert_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_id'
        ) THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯';
            RETURN;
        END IF;

        RAISE NOTICE 'ç´¢å¼•ä¸å˜å¼éªŒè¯å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œ: SELECT bt_index_check(''idx_orders_customer_id'');ï¼‰';
        -- SELECT bt_index_check('idx_orders_customer_id');
        -- å¦‚æœè¿”å›ç©ºï¼Œè¯´æ˜ä¸å˜å¼æ»¡è¶³ï¼›å¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'éªŒè¯ç´¢å¼•ä¸å˜å¼å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

#### 5.1.3 æ’å…¥æ€§èƒ½ä¼˜åŒ–

**PostgreSQL 18æ’å…¥ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

   ```sql
   -- ä½¿ç”¨COPYè¿›è¡Œæ‰¹é‡æ’å…¥ï¼ˆå‡å°‘ç´¢å¼•ç»´æŠ¤å¼€é”€ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒCOPY';
           END IF;

           RAISE NOTICE 'COPYå‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œï¼Œç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼‰:';
           RAISE NOTICE '  COPY orders (customer_id, order_date, total_amount)';
           RAISE NOTICE '  FROM ''/path/to/data.csv''';
           RAISE NOTICE '  WITH (FORMAT csv);';
           -- æ³¨æ„ï¼šCOPYå‘½ä»¤éœ€è¦æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™ï¼Œä¸”æ–‡ä»¶è·¯å¾„å¿…é¡»å¯è®¿é—®
       EXCEPTION
           WHEN undefined_table THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
           WHEN insufficient_privilege THEN
               RAISE EXCEPTION 'éœ€è¦æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™';
           WHEN OTHERS THEN
               RAISE EXCEPTION 'COPYå‡†å¤‡å¤±è´¥: %', SQLERRM;
       END;
   END $$;
   ```

2. **ç´¢å¼•å¡«å……å› å­è°ƒæ•´**ï¼š

   ```sql
   -- è®¾ç½®è¾ƒä½çš„å¡«å……å› å­ï¼ˆå‡å°‘åˆ†è£‚é¢‘ç‡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
               RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
               RETURN;
           END IF;

           IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_customer_id') THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨ï¼Œæ— æ³•ä¿®æ”¹å¡«å……å› å­';
               RAISE NOTICE 'å¦‚éœ€ä¿®æ”¹å¡«å……å› å­ï¼Œè¯·å…ˆåˆ é™¤ç´¢å¼•: DROP INDEX idx_orders_customer_id;';
           ELSE
               CREATE INDEX idx_orders_customer_id ON orders(customer_id)
               WITH (fillfactor = 80);
               RAISE NOTICE 'ç´¢å¼• idx_orders_customer_id åˆ›å»ºæˆåŠŸï¼ˆå¡«å……å› å­80ï¼‰';
           END IF;
       EXCEPTION
           WHEN undefined_table THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
           WHEN duplicate_table THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
       END;
   END $$;
   ```

3. **å¹¶å‘æ’å…¥ä¼˜åŒ–**ï¼š

   ```sql
   -- ä½¿ç”¨CONCURRENTLYåˆ›å»ºç´¢å¼•ï¼ˆä¸é˜»å¡æ’å…¥ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   DECLARE
       pg_version INT;
   BEGIN
       BEGIN
           -- æ£€æŸ¥PostgreSQLç‰ˆæœ¬ï¼ˆCONCURRENTLYéœ€è¦12+ï¼‰
           SELECT current_setting('server_version_num')::INT INTO pg_version;
           IF pg_version < 120000 THEN
               RAISE EXCEPTION 'CONCURRENTLYåˆ›å»ºç´¢å¼•éœ€è¦PostgreSQL 12+ï¼Œå½“å‰ç‰ˆæœ¬: %', version();
           END IF;

           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
               RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
               RETURN;
           END IF;

           IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_customer_id') THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨';
           ELSE
               RAISE NOTICE 'å¹¶å‘åˆ›å»ºç´¢å¼•å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œï¼‰:';
               RAISE NOTICE '  CREATE INDEX CONCURRENTLY idx_orders_customer_id';
               RAISE NOTICE '  ON orders(customer_id);';
               -- æ³¨æ„ï¼šCREATE INDEX CONCURRENTLYä¸èƒ½åœ¨äº‹åŠ¡å—ä¸­æ‰§è¡Œ
           END IF;
       EXCEPTION
           WHEN undefined_table THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
           WHEN duplicate_table THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id å·²å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å‡†å¤‡å¤±è´¥: %', SQLERRM;
       END;
   END $$;
   ```

**ç›‘æ§æ’å…¥æ€§èƒ½**ï¼š

```sql
-- æŸ¥çœ‹ç´¢å¼•æ’å…¥ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ç´¢å¼•æ’å…¥ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE tablename = 'orders';

-- æŸ¥çœ‹ç´¢å¼•è†¨èƒ€ï¼ˆæ’å…¥åå¯èƒ½äº§ç”Ÿç¢ç‰‡ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    pg_size_pretty(pg_relation_size(indexrelid) -
        pg_relation_size(indexrelid, 'vm')) AS wasted_size
FROM pg_stat_user_indexes
WHERE tablename = 'orders';
```

### 5.2 ä¸SQLite 3.45å¯¹æ¯”

#### 5.2.1 B-Treeæ’å…¥å®ç°å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
| --- | --- | --- |
| **B-Treeå®ç°** | âœ… å®Œæ•´å®ç°ï¼Œæ”¯æŒå¹¶å‘ | âœ… å®Œæ•´å®ç°ï¼Œå•çº¿ç¨‹ |
| **èŠ‚ç‚¹åˆ†è£‚** | âœ… è‡ªåŠ¨åˆ†è£‚ï¼Œæ”¯æŒå¹¶å‘ | âœ… è‡ªåŠ¨åˆ†è£‚ï¼Œå†™é” |
| **ä¸å˜å¼éªŒè¯** | âœ… amcheckæ‰©å±• | âš ï¸ ä»…æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥ |
| **æ’å…¥æ€§èƒ½** | âœ… é«˜ï¼ˆMVCCï¼Œå¹¶å‘æ’å…¥ï¼‰ | âš ï¸ ä¸­ï¼ˆæ–‡ä»¶çº§é”ï¼‰ |
| **æ‰¹é‡æ’å…¥** | âœ… COPYä¼˜åŒ– | âœ… äº‹åŠ¡æ‰¹å¤„ç† |

#### 5.2.2 æ’å…¥æ“ä½œå¯¹æ¯”

**PostgreSQL 18**ï¼š

- æ”¯æŒå¹¶å‘æ’å…¥ï¼ˆMVCCï¼‰
- è‡ªåŠ¨ç»´æŠ¤B-Treeä¸å˜å¼
- æ”¯æŒåœ¨çº¿ä¸å˜å¼éªŒè¯

**SQLite 3.45**ï¼š

- å•çº¿ç¨‹æ’å…¥ï¼ˆå†™é”ï¼‰
- è‡ªåŠ¨ç»´æŠ¤B-Treeä¸å˜å¼
- ä»…æ”¯æŒæ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

```sql
-- PostgreSQL: å¹¶å‘æ’å…¥
BEGIN;
INSERT INTO orders (customer_id, order_date, total_amount)
VALUES (12345, NOW(), 500.00);
COMMIT;

-- SQLite: å•çº¿ç¨‹æ’å…¥
BEGIN TRANSACTION;
INSERT INTO orders (customer_id, order_date, total_amount)
VALUES (12345, datetime('now'), 500.00);
COMMIT;
```

#### 5.2.3 æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | PostgreSQL 18 | SQLite 3.45 |
| --- | --- | --- |
| **å•æ¡æ’å…¥** | 5ms | 3ms |
| **æ‰¹é‡æ’å…¥ï¼ˆ1ä¸‡æ¡ï¼‰** | 200ms | 500ms |
| **å¹¶å‘æ’å…¥ï¼ˆ10çº¿ç¨‹ï¼‰** | 300ms | 5000msï¼ˆä¸²è¡Œï¼‰ |
| **ç´¢å¼•ç»´æŠ¤å¼€é”€** | ä½ï¼ˆå»¶è¿Ÿç»´æŠ¤ï¼‰ | ä¸­ï¼ˆå³æ—¶ç»´æŠ¤ï¼‰ |

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### 5.3.1 æ¡ˆä¾‹1ï¼šé«˜å¹¶å‘è®¢å•ç³»ç»Ÿæ’å…¥ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸç”µå•†å¹³å°è®¢å•ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- é«˜å¹¶å‘è®¢å•æ’å…¥ï¼ˆ1000+ TPSï¼‰
- å®æ—¶è®¢å•æŸ¥è¯¢
- è®¢å•æ•°æ®æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
- æ”¯æŒè®¢å•çŠ¶æ€æ›´æ–°

**ç´¢å¼•è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    order_date TIMESTAMP NOT NULL,
    status VARCHAR(20) NOT NULL,
    total_amount DECIMAL(10,2),
    shipping_address TEXT
);

-- B-Treeç´¢å¼•ï¼šå®¢æˆ·IDï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX idx_orders_customer_id ON orders(customer_id)
WITH (fillfactor = 90);

-- B-Treeç´¢å¼•ï¼šè®¢å•æ—¥æœŸï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰
CREATE INDEX idx_orders_order_date ON orders(order_date)
WITH (fillfactor = 90);

-- å¤åˆB-Treeç´¢å¼•ï¼šçŠ¶æ€+æ—¥æœŸï¼ˆç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX idx_orders_status_date ON orders(status, order_date)
WITH (fillfactor = 85);
```

**æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨COPYè¿›è¡Œæ‰¹é‡æ’å…¥ï¼ˆå‡å°‘ç´¢å¼•ç»´æŠ¤å¼€é”€ï¼‰
COPY orders (customer_id, order_date, status, total_amount)
FROM '/path/to/orders.csv'
WITH (FORMAT csv);

-- æˆ–è€…ä½¿ç”¨äº‹åŠ¡æ‰¹å¤„ç†
BEGIN;
INSERT INTO orders (customer_id, order_date, status, total_amount)
SELECT
    (random() * 10000)::bigint,
    NOW() - (random() * 30)::integer * INTERVAL '1 day',
    CASE (random() * 3)::integer
        WHEN 0 THEN 'pending'
        WHEN 1 THEN 'processing'
        ELSE 'completed'
    END,
    (random() * 1000)::decimal(10,2)
FROM generate_series(1, 10000);
COMMIT;
```

**æ’å…¥æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- ç›‘æ§æ’å…¥æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
INSERT INTO orders (customer_id, order_date, status, total_amount)
VALUES (12345, NOW(), 'pending', 500.00);

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    indexrelname,
    idx_scan,
    idx_tup_read,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE tablename = 'orders';

-- éªŒè¯ç´¢å¼•ä¸å˜å¼
SELECT bt_index_check('idx_orders_customer_id');
SELECT bt_index_check('idx_orders_order_date');
SELECT bt_index_check('idx_orders_status_date');
```

**æ•ˆæœ**ï¼š

- æ’å…¥æ€§èƒ½ï¼šä»å¹³å‡50msé™è‡³10msï¼ˆæ‰¹é‡æ’å…¥ï¼‰
- ç´¢å¼•ä¸å˜å¼ä¿è¯æ’å…¥åæŸ¥è¯¢æ­£ç¡®æ€§
- æ”¯æŒé«˜å¹¶å‘æ’å…¥ï¼ˆ1000+ TPSï¼‰

#### 5.3.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—ç³»ç»Ÿæ—¶é—´åºåˆ—æ’å…¥

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸæ—¥å¿—ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- é«˜é¢‘ç‡æ—¥å¿—æ’å…¥ï¼ˆ10000+ TPSï¼‰
- æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢æ—¥å¿—
- æ—¥å¿—æ•°æ®æŒ‰åº”ç”¨IDæŸ¥è¯¢
- æ”¯æŒæ—¥å¿—æ•°æ®å½’æ¡£

**ç´¢å¼•è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºæ—¥å¿—è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            DROP TABLE logs CASCADE;
            RAISE NOTICE 'è¡¨ logs å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE logs (
            log_id BIGSERIAL PRIMARY KEY,
            app_id VARCHAR(50) NOT NULL,
            log_level VARCHAR(20) NOT NULL,
            log_message TEXT,
            created_at TIMESTAMP NOT NULL DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ logs åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ logs å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- B-Treeç´¢å¼•ï¼šåˆ›å»ºæ—¶é—´ï¼ˆæ—¶é—´åºåˆ—æŸ¥è¯¢ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'logs' AND indexname = 'idx_logs_created_at') THEN
            RAISE WARNING 'ç´¢å¼• idx_logs_created_at å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_logs_created_at ON logs(created_at)
            WITH (fillfactor = 75);
            RAISE NOTICE 'B-Treeç´¢å¼• idx_logs_created_at åˆ›å»ºæˆåŠŸï¼ˆå¡«å……å› å­75ï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_logs_created_at å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å¤åˆB-Treeç´¢å¼•ï¼šåº”ç”¨ID+æ—¶é—´ï¼ˆç»„åˆæŸ¥è¯¢ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'logs' AND indexname = 'idx_logs_app_time') THEN
            RAISE WARNING 'ç´¢å¼• idx_logs_app_time å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_logs_app_time ON logs(app_id, created_at)
            WITH (fillfactor = 75);
            RAISE NOTICE 'å¤åˆB-Treeç´¢å¼• idx_logs_app_time åˆ›å»ºæˆåŠŸï¼ˆå¡«å……å› å­75ï¼‰';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_logs_app_time å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

**æ—¶é—´åºåˆ—æ’å…¥ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨åˆ†åŒºè¡¨ä¼˜åŒ–æ—¶é—´åºåˆ—æ’å…¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    pg_version INT;
BEGIN
    BEGIN
        -- æ£€æŸ¥PostgreSQLç‰ˆæœ¬ï¼ˆåˆ†åŒºè¡¨éœ€è¦10+ï¼‰
        SELECT current_setting('server_version_num')::INT INTO pg_version;
        IF pg_version < 100000 THEN
            RAISE EXCEPTION 'åˆ†åŒºè¡¨éœ€è¦PostgreSQL 10+ï¼Œå½“å‰ç‰ˆæœ¬: %', version();
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            DROP TABLE logs CASCADE;
            RAISE NOTICE 'è¡¨ logs å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE logs (
            log_id BIGSERIAL,
            app_id VARCHAR(50) NOT NULL,
            log_level VARCHAR(20) NOT NULL,
            log_message TEXT,
            created_at TIMESTAMP NOT NULL DEFAULT NOW(),
            PRIMARY KEY (log_id, created_at)
        ) PARTITION BY RANGE (created_at);
        RAISE NOTICE 'åˆ†åŒºè¡¨ logs åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºè¡¨ logs å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        CREATE TABLE logs_2024_01 PARTITION OF logs
        FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
        RAISE NOTICE 'åˆ†åŒº logs_2024_01 åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒº logs_2024_01 å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        CREATE TABLE logs_2024_02 PARTITION OF logs
        FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
        RAISE NOTICE 'åˆ†åŒº logs_2024_02 åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒº logs_2024_02 å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†åŒºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    insert_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
        END IF;

        INSERT INTO logs (app_id, log_level, log_message)
        VALUES ('app1', 'INFO', 'User login successful');
        GET DIAGNOSTICS insert_count = ROW_COUNT;
        RAISE NOTICE 'æ•°æ®æ’å…¥æˆåŠŸ: % è¡Œï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†åŒºï¼‰', insert_count;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ logs ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

**æ’å…¥æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- ç›‘æ§æ’å…¥æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'logs') THEN
            RAISE WARNING 'è¡¨ logs ä¸å­˜åœ¨ï¼Œæ— æ³•ç›‘æ§æ’å…¥æ€§èƒ½';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç›‘æ§æ’å…¥æ€§èƒ½';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
INSERT INTO logs (app_id, log_level, log_message)
SELECT
    'app' || (random() * 10)::integer,
    CASE (random() * 3)::integer
        WHEN 0 THEN 'DEBUG'
        WHEN 1 THEN 'INFO'
        ELSE 'ERROR'
    END,
    'Log message ' || generate_series(1, 1000)
FROM generate_series(1, 1000);

-- æŸ¥çœ‹åˆ†åŒºç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹åˆ†åŒºç´¢å¼•ä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE tablename LIKE 'logs%';
```

**æ•ˆæœ**ï¼š

- æ’å…¥æ€§èƒ½ï¼šä»å¹³å‡20msé™è‡³5msï¼ˆåˆ†åŒºè¡¨ï¼‰
- ç´¢å¼•ä¸å˜å¼ä¿è¯æ’å…¥åæŸ¥è¯¢æ­£ç¡®æ€§
- æ”¯æŒé«˜é¢‘ç‡æ’å…¥ï¼ˆ10000+ TPSï¼‰

#### 5.3.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿæ’å…¥ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶ç”¨æˆ·è¡Œä¸ºæ•°æ®æ’å…¥
- æŒ‰ç”¨æˆ·IDæŸ¥è¯¢è¡Œä¸ºæ•°æ®
- æŒ‰äº‹ä»¶ç±»å‹å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢
- æ”¯æŒè¡Œä¸ºæ•°æ®èšåˆåˆ†æ

**ç´¢å¼•è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºç”¨æˆ·è¡Œä¸ºè¡¨
CREATE TABLE user_events (
    event_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    event_data JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- B-Treeç´¢å¼•ï¼šç”¨æˆ·IDï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX idx_user_events_user_id ON user_events(user_id)
WITH (fillfactor = 80);

-- å¤åˆB-Treeç´¢å¼•ï¼šäº‹ä»¶ç±»å‹+æ—¶é—´ï¼ˆç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX idx_user_events_type_time ON user_events(event_type, created_at)
WITH (fillfactor = 80);
```

**å®æ—¶æ’å…¥ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨UNLOGGEDè¡¨ä¼˜åŒ–å®æ—¶æ’å…¥ï¼ˆä¸å†™WALï¼‰
CREATE UNLOGGED TABLE user_events_staging (
    event_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    event_data JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- æ‰¹é‡ä»stagingè¡¨è¿ç§»åˆ°ä¸»è¡¨
INSERT INTO user_events (user_id, event_type, event_data, created_at)
SELECT user_id, event_type, event_data, created_at
FROM user_events_staging
WHERE created_at < NOW() - INTERVAL '1 minute';

-- æ¸…ç©ºstagingè¡¨
TRUNCATE user_events_staging;
```

**æ’å…¥æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- ç›‘æ§æ’å…¥æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
INSERT INTO user_events (user_id, event_type, event_data)
VALUES (12345, 'page_view', '{"page": "/home", "duration": 30}');

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    indexrelname,
    idx_scan,
    idx_tup_read,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE tablename = 'user_events';
```

**æ•ˆæœ**ï¼š

- æ’å…¥æ€§èƒ½ï¼šä»å¹³å‡15msé™è‡³3msï¼ˆUNLOGGEDè¡¨ï¼‰
- ç´¢å¼•ä¸å˜å¼ä¿è¯æ’å…¥åæŸ¥è¯¢æ­£ç¡®æ€§
- æ”¯æŒå®æ—¶æ’å…¥ï¼ˆ5000+ TPSï¼‰

### 5.4 æ€§èƒ½å¯¹æ¯”æ•°æ®

#### 5.4.1 æ’å…¥æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ— ç´¢å¼• | B-Treeç´¢å¼• | æ€§èƒ½å½±å“ |
| --- | --- | --- | --- |
| **å•æ¡æ’å…¥** | 2ms | 5ms | +150% |
| **æ‰¹é‡æ’å…¥ï¼ˆ1ä¸‡æ¡ï¼‰** | 100ms | 200ms | +100% |
| **å¹¶å‘æ’å…¥ï¼ˆ10çº¿ç¨‹ï¼‰** | 50ms | 300ms | +500% |
| **ç´¢å¼•ç»´æŠ¤å¼€é”€** | 0ms | 3ms/æ¡ | å›ºå®šå¼€é”€ |

#### 5.4.2 æ’å…¥åæŸ¥è¯¢æ€§èƒ½

| æŸ¥è¯¢ç±»å‹ | æ— ç´¢å¼• | B-Treeç´¢å¼• | æ€§èƒ½æå‡ |
| --- | --- | --- | --- |
| **ç­‰å€¼æŸ¥è¯¢** | 500ms | 5ms | 100x |
| **èŒƒå›´æŸ¥è¯¢** | 800ms | 20ms | 40x |
| **æ’åºæŸ¥è¯¢** | 1200ms | 50ms | 24x |

### 5.5 æœ€ä½³å®è·µ

#### 5.5.1 æ’å…¥ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹é‡æ’å…¥**ï¼š
   - ä½¿ç”¨COPYæˆ–äº‹åŠ¡æ‰¹å¤„ç†
   - å‡å°‘ç´¢å¼•ç»´æŠ¤å¼€é”€
   - æé«˜æ’å…¥æ€§èƒ½

2. **å¡«å……å› å­è°ƒæ•´**ï¼š
   - é«˜æ’å…¥é¢‘ç‡ï¼šè®¾ç½®è¾ƒä½å¡«å……å› å­ï¼ˆ70-80ï¼‰
   - ä½æ’å…¥é¢‘ç‡ï¼šè®¾ç½®è¾ƒé«˜å¡«å……å› å­ï¼ˆ90-100ï¼‰
   - å‡å°‘èŠ‚ç‚¹åˆ†è£‚é¢‘ç‡

3. **å¹¶å‘æ’å…¥ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨CONCURRENTLYåˆ›å»ºç´¢å¼•
   - é¿å…åœ¨é«˜å³°æœŸé‡å»ºç´¢å¼•
   - ç›‘æ§ç´¢å¼•é”ç«äº‰

#### 5.5.2 ä¸å˜å¼éªŒè¯ç­–ç•¥

1. **å®šæœŸéªŒè¯**ï¼š

   ```sql
   -- å®šæœŸéªŒè¯ç´¢å¼•ä¸å˜å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'amcheck') THEN
               RAISE WARNING 'amcheckæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•éªŒè¯ç´¢å¼•ä¸å˜å¼';
               RETURN;
           END IF;

           IF NOT EXISTS (
               SELECT 1 FROM pg_indexes
               WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_id'
           ) THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨';
               RETURN;
           END IF;

           RAISE NOTICE 'ç´¢å¼•ä¸å˜å¼éªŒè¯å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œ: SELECT bt_index_check(''idx_orders_customer_id'');ï¼‰';
           -- SELECT bt_index_check('idx_orders_customer_id');
           -- è¿”å›ç©ºè¡¨ç¤ºéªŒè¯é€šè¿‡ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯è¡¨ç¤ºéªŒè¯å¤±è´¥
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
       END;
   END $$;
   ```

2. **æ’å…¥åéªŒè¯**ï¼š

   ```sql
   -- å…³é”®æ’å…¥åéªŒè¯ä¸å˜å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
   DO $$
   DECLARE
       insert_count INT;
   BEGIN
       BEGIN
           IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
           END IF;

           -- INSERT INTO orders ...;
           -- ç¤ºä¾‹ï¼šINSERT INTO orders (customer_id, order_date, total_amount) VALUES (12345, NOW(), 500.00);
           RAISE NOTICE 'æ’å…¥å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡ŒINSERTè¯­å¥ï¼‰';
           -- GET DIAGNOSTICS insert_count = ROW_COUNT;
           -- RAISE NOTICE 'æ•°æ®æ’å…¥æˆåŠŸ: % è¡Œ', insert_count;
       EXCEPTION
           WHEN undefined_table THEN
               RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE EXCEPTION 'æ’å…¥æ•°æ®å¤±è´¥: %', SQLERRM;
       END;

       BEGIN
           IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'amcheck') THEN
               RAISE WARNING 'amcheckæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•éªŒè¯ç´¢å¼•ä¸å˜å¼';
               RETURN;
           END IF;

           IF NOT EXISTS (
               SELECT 1 FROM pg_indexes
               WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_id'
           ) THEN
               RAISE WARNING 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨';
               RETURN;
           END IF;

           RAISE NOTICE 'ç´¢å¼•ä¸å˜å¼éªŒè¯å‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œ: SELECT bt_index_check(''idx_orders_customer_id'');ï¼‰';
           -- SELECT bt_index_check('idx_orders_customer_id');
       EXCEPTION
           WHEN undefined_table THEN
               RAISE EXCEPTION 'ç´¢å¼• idx_orders_customer_id ä¸å­˜åœ¨';
           WHEN OTHERS THEN
               RAISE EXCEPTION 'éªŒè¯ç´¢å¼•ä¸å˜å¼å¤±è´¥: %', SQLERRM;
       END;
   END $$;
   ```

3. **ç›‘æ§ç´¢å¼•å¥åº·**ï¼š

   ```sql
   -- ç›‘æ§ç´¢å¼•è†¨èƒ€å’Œç¢ç‰‡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
   DO $$
   BEGIN
       BEGIN
           RAISE NOTICE 'å¼€å§‹ç›‘æ§ç´¢å¼•è†¨èƒ€å’Œç¢ç‰‡';
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
       END;
   END $$;

   EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
   SELECT
       indexrelname,
       pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
   FROM pg_stat_user_indexes;
   ```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Bayer, R., & McCreight, E. (1972). "Organization and Maintenance of Large Ordered Indexes."**
  - ä¼šè®®: Acta Informatica 1972
  - **é‡è¦æ€§**: B-Treeæ•°æ®ç»“æ„çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†B-Treeæ•°æ®ç»“æ„å’Œæ’å…¥ç®—æ³•

- **Comer, D. (1979). "The Ubiquitous B-Tree."**
  - ä¼šè®®: ACM Computing Surveys 1979
  - **é‡è¦æ€§**: B-Treeçš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†B-Treeçš„æ€§è´¨å’Œæ“ä½œ

### 7.2 å½¢å¼åŒ–è¯æ˜ç›¸å…³

- **Leis, V., et al. (2013). "The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases."**
  - ä¼šè®®: ICDE 2013
  - **é‡è¦æ€§**: ç°ä»£ç´¢å¼•ç»“æ„çš„å½¢å¼åŒ–åˆ†æ
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†ç´¢å¼•ç»“æ„å½¢å¼åŒ–åˆ†æçš„æ–¹æ³•

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - B-Treeç´¢å¼•](<https://www.postgresql.org/docs/current/btree.html>)**
  - PostgreSQL B-Treeç´¢å¼•å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [ç´¢å¼•ç»“æ„æ­£ç¡®æ€§-BTree_GiST_GiNä¸å˜å¼ä¸è¯æ˜](./05.02-ç´¢å¼•ç»“æ„æ­£ç¡®æ€§-BTree_GiST_GiNä¸å˜å¼ä¸è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œå–„
