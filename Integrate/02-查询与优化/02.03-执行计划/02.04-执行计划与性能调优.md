---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: æ‰§è¡Œè®¡åˆ’åˆ†æã€æ€§èƒ½è°ƒä¼˜ã€ç³»ç»Ÿä¼˜åŒ–
> ğŸ†• **PostgreSQL 18æ€§èƒ½æ”¹è¿›**: å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡30-40%ã€æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—ã€æ”¹è¿›çš„EXPLAINåˆ†æã€å¼‚æ­¥I/Oæå‡I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½2-3å€

---

## ğŸ“‹ ç›®å½•

- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](#æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#-å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹å¯¹æ¯”çŸ©é˜µ](#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹å¯¹æ¯”çŸ©é˜µ)
    - [æ€§èƒ½è°ƒä¼˜ç­–ç•¥å¯¹æ¯”çŸ©é˜µ](#æ€§èƒ½è°ƒä¼˜ç­–ç•¥å¯¹æ¯”çŸ©é˜µ)
    - [EXPLAINè¾“å‡ºæ ¼å¼å¯¹æ¯”çŸ©é˜µ](#explainè¾“å‡ºæ ¼å¼å¯¹æ¯”çŸ©é˜µ)
  - [ğŸŒ Wikipediaå¯¹é½](#-wikipediaå¯¹é½)
    - [æ‰§è¡Œè®¡åˆ’æ¦‚å¿µå¯¹é½](#æ‰§è¡Œè®¡åˆ’æ¦‚å¿µå¯¹é½)
    - [æ€§èƒ½è°ƒä¼˜æ¦‚å¿µå¯¹é½](#æ€§èƒ½è°ƒä¼˜æ¦‚å¿µå¯¹é½)
  - [1. å®šä¹‰ä¸å½¢å¼åŒ–](#1-å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1 æ‰§è¡Œè®¡åˆ’ç†è®º](#21-æ‰§è¡Œè®¡åˆ’ç†è®º)
    - [2.2 æ€§èƒ½è°ƒä¼˜ç†è®º](#22-æ€§èƒ½è°ƒä¼˜ç†è®º)
  - [3. æ‰§è¡Œè®¡åˆ’åˆ†æ](#3-æ‰§è¡Œè®¡åˆ’åˆ†æ)
    - [3.1 åŸºæœ¬æ‰§è¡Œè®¡åˆ’](#31-åŸºæœ¬æ‰§è¡Œè®¡åˆ’)
    - [3.2 æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹](#32-æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹)
    - [3.3 æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡ä¿¡æ¯](#33-æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡ä¿¡æ¯)
  - [4. æ€§èƒ½ç›‘æ§](#4-æ€§èƒ½ç›‘æ§)
    - [4.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#41-æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
    - [4.2 ç³»ç»Ÿæ€§èƒ½ç›‘æ§](#42-ç³»ç»Ÿæ€§èƒ½ç›‘æ§)
    - [4.3 I/Oæ€§èƒ½ç›‘æ§](#43-ioæ€§èƒ½ç›‘æ§)
  - [5. æ€§èƒ½è°ƒä¼˜ç­–ç•¥](#5-æ€§èƒ½è°ƒä¼˜ç­–ç•¥)
    - [5.1 æŸ¥è¯¢ä¼˜åŒ–](#51-æŸ¥è¯¢ä¼˜åŒ–)
    - [5.2 ç³»ç»Ÿå‚æ•°è°ƒä¼˜](#52-ç³»ç»Ÿå‚æ•°è°ƒä¼˜)
    - [6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•](#62-æ€§èƒ½åŸºå‡†æµ‹è¯•)
    - [6.3 æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿](#63-æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 æ…¢æŸ¥è¯¢ä¼˜åŒ–](#71-æ…¢æŸ¥è¯¢ä¼˜åŒ–)
    - [7.2 æ‰¹é‡æ“ä½œä¼˜åŒ–](#72-æ‰¹é‡æ“ä½œä¼˜åŒ–)
    - [7.3 åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–](#73-åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–)
    - [7.4 åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ– ğŸ†•](#74-åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–-)
      - [ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–çŸ¥è¯†ä½“ç³»](#-åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–çŸ¥è¯†ä½“ç³»)
      - [ğŸ“Š åˆ—å­˜å‚¨ vs è¡Œå­˜å‚¨æ‰§è¡Œè®¡åˆ’å¯¹æ¯”çŸ©é˜µ](#-åˆ—å­˜å‚¨-vs-è¡Œå­˜å‚¨æ‰§è¡Œè®¡åˆ’å¯¹æ¯”çŸ©é˜µ)
      - [ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–å†³ç­–æ ‘](#-åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–å†³ç­–æ ‘)
      - [ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’æ—¶åºå›¾](#-åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’æ—¶åºå›¾)
  - [8. PostgreSQL 18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æ–°ç‰¹æ€§](#8-postgresql-18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æ–°ç‰¹æ€§)
    - [8.1 å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡](#81-å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡)
    - [8.2 æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—](#82-æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—)
    - [8.3 æ”¹è¿›çš„EXPLAINåˆ†æ](#83-æ”¹è¿›çš„explainåˆ†æ)
    - [8.4 å¼‚æ­¥I/Oæå‡I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½](#84-å¼‚æ­¥ioæå‡ioå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½)
    - [8.5 æ”¹è¿›çš„æ‰§è¡Œè®¡åˆ’ç¼“å­˜](#85-æ”¹è¿›çš„æ‰§è¡Œè®¡åˆ’ç¼“å­˜)
    - [8.6 PostgreSQL 18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](#86-postgresql-18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ)
  - [9. æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](#9-æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ)
    - [9.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#91-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
    - [9.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#92-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [9.3 ç³»ç»Ÿé…ç½®ä¼˜åŒ–](#93-ç³»ç»Ÿé…ç½®ä¼˜åŒ–)
  - [10. ç›¸å…³æ¦‚å¿µ](#10-ç›¸å…³æ¦‚å¿µ)
    - [10.1 ä¸Šä½æ¦‚å¿µ](#101-ä¸Šä½æ¦‚å¿µ)
    - [10.2 ä¸‹ä½æ¦‚å¿µ](#102-ä¸‹ä½æ¦‚å¿µ)
    - [10.3 å¹³è¡Œæ¦‚å¿µ](#103-å¹³è¡Œæ¦‚å¿µ)
  - [11. ç›¸å…³æ–‡æ¡£](#11-ç›¸å…³æ–‡æ¡£)
    - [10.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#101-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
  - [12. å‚è€ƒæ–‡çŒ®](#12-å‚è€ƒæ–‡çŒ®)
  - [13. äº¤å‰å¼•ç”¨](#13-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [æŸ¥è¯¢ä¸ä¼˜åŒ–](#æŸ¥è¯¢ä¸ä¼˜åŒ–)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
  - [14. Wikidataå¯¹é½](#14-wikidataå¯¹é½)
  - [15. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯](#15-å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯)
    - [14.1 æ‰§è¡Œè®¡åˆ’å‡†ç¡®æ€§è¯æ˜](#141-æ‰§è¡Œè®¡åˆ’å‡†ç¡®æ€§è¯æ˜)
    - [14.2 æ€§èƒ½è°ƒä¼˜æœ€ä¼˜æ€§è¯æ˜](#142-æ€§èƒ½è°ƒä¼˜æœ€ä¼˜æ€§è¯æ˜)
    - [14.3 ç´¢å¼•é€‰æ‹©æœ€ä¼˜æ€§è¯æ˜](#143-ç´¢å¼•é€‰æ‹©æœ€ä¼˜æ€§è¯æ˜)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜))
    æ‰§è¡Œè®¡åˆ’
      è®¡åˆ’èŠ‚ç‚¹
        Seq Scan
        Index Scan
        Hash Join
        Nested Loop
        Sort
        Aggregate
      è®¡åˆ’åˆ†æ
        ä»£ä»·åˆ†æ
        è¡Œæ•°ä¼°è®¡
        æ—¶é—´ä¼°ç®—
        ç¼“å†²åŒºä½¿ç”¨
      è®¡åˆ’ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        è¿æ¥ä¼˜åŒ–
        æ’åºä¼˜åŒ–
    æ€§èƒ½ç›‘æ§
      æŸ¥è¯¢ç›‘æ§
        æ…¢æŸ¥è¯¢
        æ‰§è¡Œæ—¶é—´
        èµ„æºä½¿ç”¨
      ç³»ç»Ÿç›‘æ§
        CPUä½¿ç”¨
        å†…å­˜ä½¿ç”¨
        I/Oä½¿ç”¨
      æ€§èƒ½æŒ‡æ ‡
        QPS
        å“åº”æ—¶é—´
        ååé‡
    æ€§èƒ½è°ƒä¼˜
      æŸ¥è¯¢ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        æŸ¥è¯¢é‡å†™
        å‚æ•°è°ƒä¼˜
      ç³»ç»Ÿä¼˜åŒ–
        é…ç½®å‚æ•°
        èµ„æºåˆ†é…
        å¹¶å‘æ§åˆ¶
      ç´¢å¼•ä¼˜åŒ–
        ç´¢å¼•é€‰æ‹©
        ç´¢å¼•ç»´æŠ¤
        ç´¢å¼•ç›‘æ§
    è°ƒä¼˜å·¥å…·
      EXPLAIN
        è®¡åˆ’åˆ†æ
        ä»£ä»·ä¼°ç®—
        å®é™…æ‰§è¡Œ
      pg_stat_statements
        æŸ¥è¯¢ç»Ÿè®¡
        æ€§èƒ½åˆ†æ
      ç›‘æ§å·¥å…·
        pgAdmin
        Grafana
        Prometheus
    åº”ç”¨æ¡ˆä¾‹
      æ…¢æŸ¥è¯¢ä¼˜åŒ–
        æŸ¥è¯¢åˆ†æ
        ç´¢å¼•ä¼˜åŒ–
        å‚æ•°è°ƒä¼˜
      æ‰¹é‡æ“ä½œ
        æ‰¹é‡æ’å…¥
        æ‰¹é‡æ›´æ–°
        æ‰¹é‡åˆ é™¤
      åˆ†åŒºè¡¨
        åˆ†åŒºç­–ç•¥
        æŸ¥è¯¢ä¼˜åŒ–
        ç»´æŠ¤ä¼˜åŒ–
```

---

## ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹å¯¹æ¯”çŸ©é˜µ

| èŠ‚ç‚¹ç±»å‹ | æ“ä½œç±»å‹ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜åŒ–æ–¹å‘ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- | --- |
| **Seq Scan** | é¡ºåºæ‰«æ | O(n) | O(1) | å°è¡¨ã€å…¨è¡¨æ‰«æ | ç´¢å¼•ä¼˜åŒ– | âœ… æ”¯æŒ |
| **Index Scan** | ç´¢å¼•æ‰«æ | O(log n) | O(1) | ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ | è¦†ç›–ç´¢å¼• | âœ… æ”¯æŒ |
| **Index Only Scan** | ä»…ç´¢å¼•æ‰«æ | O(log n) | O(1) | è¦†ç›–ç´¢å¼•æŸ¥è¯¢ | INCLUDEåˆ— | âœ… æ”¯æŒ |
| **Bitmap Index Scan** | ä½å›¾æ‰«æ | O(log n) | O(n) | å¤šæ¡ä»¶ORæŸ¥è¯¢ | ç´¢å¼•åˆå¹¶ | âœ… æ”¯æŒ |
| **Hash Join** | å“ˆå¸Œè¿æ¥ | O(n+m) | O(m) | ç­‰å€¼è¿æ¥ã€å¤§è¡¨ | å†…å­˜ä¼˜åŒ– | âœ… æ”¯æŒ |
| **Nested Loop** | åµŒå¥—å¾ªç¯ | O(nÃ—m) | O(1) | å°è¡¨è¿æ¥ | ç´¢å¼•ä¼˜åŒ– | âœ… æ”¯æŒ |
| **Merge Join** | åˆå¹¶è¿æ¥ | O(n log n + m log m) | O(1) | æœ‰åºæ•°æ®è¿æ¥ | æ’åºä¼˜åŒ– | âœ… æ”¯æŒ |

### æ€§èƒ½è°ƒä¼˜ç­–ç•¥å¯¹æ¯”çŸ©é˜µ

| è°ƒä¼˜ç­–ç•¥ | ä¼˜åŒ–æ•ˆæœ | å®æ–½éš¾åº¦ | é£é™©ç­‰çº§ | é€‚ç”¨åœºæ™¯ | PostgreSQLç‰¹æ€§ |
| --- | --- | --- | --- | --- | --- |
| **ç´¢å¼•ä¼˜åŒ–** | é«˜ | ä¸­ | ä½ | æŸ¥è¯¢æ…¢ | âœ… æ”¯æŒ |
| **æŸ¥è¯¢é‡å†™** | é«˜ | é«˜ | ä¸­ | å¤æ‚æŸ¥è¯¢ | âœ… æ”¯æŒ |
| **å‚æ•°è°ƒä¼˜** | ä¸­ | ä½ | ä¸­ | ç³»ç»Ÿçº§ä¼˜åŒ– | âœ… æ”¯æŒ |
| **ç»Ÿè®¡ä¿¡æ¯æ›´æ–°** | ä¸­ | ä½ | ä½ | ç»Ÿè®¡è¿‡æ—¶ | âœ… æ”¯æŒ |
| **åˆ†åŒºä¼˜åŒ–** | é«˜ | é«˜ | ä½ | å¤§è¡¨æŸ¥è¯¢ | âœ… æ”¯æŒ |
| **å¹¶è¡ŒæŸ¥è¯¢** | é«˜ | ä¸­ | ä½ | å¤§æ•°æ®é‡ | âœ… æ”¯æŒ |

### EXPLAINè¾“å‡ºæ ¼å¼å¯¹æ¯”çŸ©é˜µ

| EXPLAINé€‰é¡¹ | è¾“å‡ºå†…å®¹ | æ€§èƒ½å¼€é”€ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- |
| **EXPLAIN** | æ‰§è¡Œè®¡åˆ’ | æ—  | è®¡åˆ’åˆ†æ | âœ… æ”¯æŒ |
| **EXPLAIN ANALYZE** | è®¡åˆ’+å®é™…æ‰§è¡Œ | é«˜ | æ€§èƒ½åˆ†æ | âœ… æ”¯æŒ |
| **EXPLAIN BUFFERS** | è®¡åˆ’+ç¼“å†²åŒº | ä¸­ | I/Oåˆ†æ | âœ… æ”¯æŒ |
| **EXPLAIN VERBOSE** | è¯¦ç»†è®¡åˆ’ | æ—  | è¯¦ç»†åˆ†æ | âœ… æ”¯æŒ |
| **EXPLAIN COSTS** | ä»£ä»·ä¿¡æ¯ | æ—  | ä»£ä»·åˆ†æ | âœ… æ”¯æŒ |

---

## ğŸŒ Wikipediaå¯¹é½

### æ‰§è¡Œè®¡åˆ’æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Query plan](https://en.wikipedia.org/wiki/Query_plan)

> A query plan (or query execution plan) is a sequence of steps used to access data in a SQL relational database management system.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒæ‰§è¡Œè®¡åˆ’æ˜¯æŸ¥è¯¢æ‰§è¡Œçš„æ­¥éª¤åºåˆ—
- âœ… **æ ¸å¿ƒå†…å®¹**: éƒ½åŒ…å«æ“ä½œç±»å‹ã€ä»£ä»·ã€è¡Œæ•°ç­‰ä¿¡æ¯
- âœ… **ä¼˜åŒ–ç›®æ ‡**: éƒ½å¼ºè°ƒé€šè¿‡æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### æ€§èƒ½è°ƒä¼˜æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Database tuning](https://en.wikipedia.org/wiki/Database_tuning)

> Database tuning is the activity of making a database application run more efficiently. Database tuning aims to maximize use of system resources to perform work as efficiently and rapidly as possible.

**å¯¹é½è¯´æ˜**:

- âœ… **ä¼˜åŒ–ç›®æ ‡**: éƒ½å¼ºè°ƒæé«˜æ•°æ®åº“åº”ç”¨è¿è¡Œæ•ˆç‡
- âœ… **ä¼˜åŒ–æ–¹æ³•**: éƒ½æåˆ°èµ„æºé…ç½®å’ŒæŸ¥è¯¢ä¼˜åŒ–
- âœ… **æ€§èƒ½æŒ‡æ ‡**: éƒ½å…³æ³¨å“åº”æ—¶é—´å’Œååé‡

---

## 1. å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: æ‰§è¡Œè®¡åˆ’æ˜¯æ•°æ®åº“ç³»ç»Ÿå°†æŸ¥è¯¢è½¬æ¢ä¸ºå…·ä½“æ‰§è¡Œæ­¥éª¤çš„è¯¦ç»†æ–¹æ¡ˆï¼Œæ€§èƒ½è°ƒä¼˜æ˜¯é€šè¿‡åˆ†ææ‰§è¡Œè®¡åˆ’å’Œç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡æ¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½çš„è¿‡ç¨‹ã€‚

**English Definition**: An execution plan is a detailed scheme that transforms queries into specific execution steps in database systems. Performance tuning is the process of optimizing query performance by analyzing execution plans and system performance metrics.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\plan}{\mathcal{P}}
\newcommand{\node}{\mathcal{N}}
\newcommand{\cost}{\mathcal{C}}
\newcommand{\time}{\mathcal{T}}

% æ‰§è¡Œè®¡åˆ’çš„å½¢å¼åŒ–å®šä¹‰
\plan = \{n_1, n_2, \ldots, n_k\}

å…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ n_i = (type_i, cost_i, time_i, rows_i, width_i) è¡¨ç¤ºï¼š
- type_i: æ“ä½œç±»å‹
- cost_i: æ‰§è¡Œä»£ä»·
- time_i: æ‰§è¡Œæ—¶é—´
- rows_i: è¾“å‡ºè¡Œæ•°
- width_i: è¡Œå®½åº¦
```

### 1.3 æ ¸å¿ƒå±æ€§

- **å‡†ç¡®æ€§**: æ‰§è¡Œè®¡åˆ’åæ˜ çœŸå®æ‰§è¡Œè¿‡ç¨‹
- **å¯è¯»æ€§**: æ‰§è¡Œè®¡åˆ’æ˜“äºç†è§£å’Œåˆ†æ
- **å¯ä¼˜åŒ–æ€§**: æ”¯æŒæ€§èƒ½è°ƒä¼˜å’Œä¼˜åŒ–
- **å¯é¢„æµ‹æ€§**: èƒ½å¤Ÿé¢„æµ‹æ‰§è¡Œæ€§èƒ½

## 2. ç†è®ºåŸºç¡€

### 2.1 æ‰§è¡Œè®¡åˆ’ç†è®º

```latex
\begin{theorem}[æ‰§è¡Œè®¡åˆ’æ­£ç¡®æ€§]
æ‰§è¡Œè®¡åˆ’Pæ­£ç¡®æ‰§è¡ŒæŸ¥è¯¢Qï¼Œå½“ä¸”ä»…å½“ï¼š
1. è¯­ä¹‰ç­‰ä»·æ€§ï¼š\text{result}(P) = \text{result}(Q)
2. ä»£ä»·æœ€ä¼˜æ€§ï¼š\cost(P) = \min_{P' \in \mathcal{P}(Q)} \cost(P')
3. æ—¶é—´å¯è¡Œæ€§ï¼š\time(P) \leq \text{timeout}
\end{theorem}
```

### 2.2 æ€§èƒ½è°ƒä¼˜ç†è®º

```latex
\begin{theorem}[æ€§èƒ½è°ƒä¼˜æœ€ä¼˜åŒ–]
æ€§èƒ½è°ƒä¼˜çš„ç›®æ ‡æ˜¯ï¼š
\min_{\text{config}} \sum_{i=1}^{n} \time(\query_i, \text{config})

å…¶ä¸­configæ˜¯ç³»ç»Ÿé…ç½®å‚æ•°ï¼Œquery_iæ˜¯æŸ¥è¯¢é›†åˆã€‚
\end{theorem}
```

## 3. æ‰§è¡Œè®¡åˆ’åˆ†æ

### 3.1 åŸºæœ¬æ‰§è¡Œè®¡åˆ’

```sql
-- åŸºæœ¬æ‰§è¡Œè®¡åˆ’ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹åŸºæœ¬æ‰§è¡Œè®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM employees WHERE emp_id = 1001;

-- è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT e.name, d.dept_name, e.salary
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000;

-- æ‰§è¡Œè®¡åˆ’æ ¼å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹JSONæ ¼å¼æ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹JSONæ ¼å¼æ‰§è¡Œè®¡åˆ’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (FORMAT JSON, ANALYZE)
SELECT * FROM employees WHERE dept_id = 1;
```

### 3.2 æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹

```sql
-- æ‰«æèŠ‚ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºæ‰«æèŠ‚ç‚¹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºæ‰«æèŠ‚ç‚¹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees;  -- Seq Scan

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE emp_id = 1001;  -- Index Scan

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;  -- Bitmap Scan

-- è¿æ¥èŠ‚ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºè¿æ¥èŠ‚ç‚¹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºè¿æ¥èŠ‚ç‚¹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e, departments d
WHERE e.dept_id = d.dept_id;  -- Nested Loop

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;  -- Hash Join

-- èšåˆèŠ‚ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºèšåˆèŠ‚ç‚¹';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºèšåˆèŠ‚ç‚¹';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT dept_id, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id;  -- Hash Aggregate
```

### 3.3 æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT e.name, d.dept_name, e.salary
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000
ORDER BY e.salary DESC;

-- æ‰§è¡Œè®¡åˆ’æˆæœ¬åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æˆæœ¬';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æˆæœ¬åˆ†æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æˆæœ¬å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (COSTS, BUFFERS, ANALYZE)
SELECT * FROM employees WHERE dept_id = 1;
```

## 4. æ€§èƒ½ç›‘æ§

### 4.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_query_count int := 0;
    query_record RECORD;
BEGIN
    BEGIN
        FOR query_record IN
            SELECT
                pid,
                usename,
                application_name,
                client_addr,
                backend_start,
                state,
                query_start,
                state_change,
                query
            FROM pg_stat_activity
            WHERE state = 'active'
            ORDER BY query_start
            LIMIT 10
        LOOP
            active_query_count := active_query_count + 1;
            RAISE NOTICE 'æ´»åŠ¨æŸ¥è¯¢: PID=%, ç”¨æˆ·=%, åº”ç”¨=%, çŠ¶æ€=%',
                query_record.pid, query_record.usename, query_record.application_name, query_record.state;
        END LOOP;

        IF active_query_count = 0 THEN
            RAISE NOTICE 'å½“å‰æ²¡æœ‰æ´»åŠ¨æŸ¥è¯¢';
        ELSE
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ´»åŠ¨æŸ¥è¯¢', active_query_count;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ´»åŠ¨æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    query_start,
    state_change,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            RAISE WARNING 'pg_stat_statements æ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    total_time,
    mean_time,
    stddev_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

### 4.2 ç³»ç»Ÿæ€§èƒ½ç›‘æ§

```sql
-- æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_record RECORD;
BEGIN
    BEGIN
        SELECT
            datname,
            numbackends,
            xact_commit,
            xact_rollback,
            blks_read,
            blks_hit,
            tup_returned,
            tup_fetched,
            tup_inserted,
            tup_updated,
            tup_deleted
        INTO db_record
        FROM pg_stat_database
        WHERE datname = current_database();

        IF db_record IS NULL THEN
            RAISE WARNING 'æ— æ³•è·å–æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡';
        ELSE
            RAISE NOTICE 'æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡: æ•°æ®åº“=%, è¿æ¥æ•°=%, æäº¤äº‹åŠ¡=%, å›æ»šäº‹åŠ¡=%',
                db_record.datname, db_record.numbackends, db_record.xact_commit, db_record.xact_rollback;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ•°æ®åº“æ€§èƒ½ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname = current_database();

-- è¡¨æ€§èƒ½ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    table_count int := 0;
BEGIN
    BEGIN
        FOR table_record IN
            SELECT
                schemaname,
                tablename,
                seq_scan,
                seq_tup_read,
                idx_scan,
                idx_tup_fetch,
                n_tup_ins,
                n_tup_upd,
                n_tup_del,
                n_live_tup,
                n_dead_tup
            FROM pg_stat_user_tables
            ORDER BY seq_scan DESC
            LIMIT 10
        LOOP
            table_count := table_count + 1;
            RAISE NOTICE 'è¡¨æ€§èƒ½: %.%, é¡ºåºæ‰«æ=%, ç´¢å¼•æ‰«æ=%, æ´»å…ƒç»„=%',
                table_record.schemaname, table_record.tablename,
                table_record.seq_scan, table_record.idx_scan, table_record.n_live_tup;
        END LOOP;

        IF table_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°è¡¨æ€§èƒ½ç»Ÿè®¡';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨æ€§èƒ½ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;
```

### 4.3 I/Oæ€§èƒ½ç›‘æ§

```sql
-- I/Oç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    io_record RECORD;
    io_count int := 0;
BEGIN
    BEGIN
        FOR io_record IN
            SELECT
                schemaname,
                tablename,
                heap_blks_read,
                heap_blks_hit,
                idx_blks_read,
                idx_blks_hit,
                toast_blks_read,
                toast_blks_hit,
                tidx_blks_read,
                tidx_blks_hit
            FROM pg_statio_user_tables
            ORDER BY heap_blks_read + heap_blks_hit DESC
            LIMIT 10
        LOOP
            io_count := io_count + 1;
            RAISE NOTICE 'I/Oç»Ÿè®¡: %.%, å †å—è¯»å–=%, å †å—å‘½ä¸­=%, ç´¢å¼•å—è¯»å–=%',
                io_record.schemaname, io_record.tablename,
                io_record.heap_blks_read, io_record.heap_blks_hit, io_record.idx_blks_read;
        END LOOP;

        IF io_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°I/Oç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹I/Oç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    toast_blks_read,
    toast_blks_hit,
    tidx_blks_read,
    tidx_blks_hit
FROM pg_statio_user_tables
ORDER BY heap_blks_read + heap_blks_hit DESC;

-- ç¼“å†²åŒºå‘½ä¸­ç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    hit_ratio numeric;
BEGIN
    BEGIN
        SELECT
            round(100.0 * sum(blks_hit)::numeric / NULLIF(sum(blks_hit) + sum(blks_read), 0)::numeric, 2)
        INTO hit_ratio
        FROM pg_stat_database;

        IF hit_ratio IS NULL THEN
            RAISE WARNING 'æ— æ³•è®¡ç®—ç¼“å†²åŒºå‘½ä¸­ç‡';
        ELSE
            RAISE NOTICE 'ç¼“å†²åŒºå‘½ä¸­ç‡: %%%', hit_ratio;
            IF hit_ratio < 95 THEN
                RAISE WARNING 'ç¼“å†²åŒºå‘½ä¸­ç‡ä½äº95%%ï¼Œå»ºè®®ä¼˜åŒ–';
            END IF;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as hit_ratio
FROM pg_stat_database;
```

## 5. æ€§èƒ½è°ƒä¼˜ç­–ç•¥

### 5.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æŸ¥è¯¢é‡å†™ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
-- ä¼˜åŒ–å‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºæŸ¥è¯¢é‡å†™ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºæŸ¥è¯¢é‡å†™ä¼˜åŒ–ï¼ˆä¼˜åŒ–å‰ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE emp_id IN (
    SELECT emp_id FROM employees WHERE salary > 50000
);

-- ä¼˜åŒ–å
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºæŸ¥è¯¢é‡å†™ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºæŸ¥è¯¢é‡å†™ä¼˜åŒ–ï¼ˆä¼˜åŒ–åï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE salary > 50000;

-- ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_salary') THEN
            CREATE INDEX idx_emp_salary ON employees (salary);
            RAISE NOTICE 'ç´¢å¼• idx_emp_salary åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_emp_salary å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_emp_salary å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE salary > 50000;

-- å¤åˆç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤åˆç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_dept_salary') THEN
            CREATE INDEX idx_emp_dept_salary ON employees (dept_id, salary);
            RAISE NOTICE 'å¤åˆç´¢å¼• idx_emp_dept_salary åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'å¤åˆç´¢å¼• idx_emp_dept_salary å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_emp_dept_salary å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤åˆç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;
```

### 5.2 ç³»ç»Ÿå‚æ•°è°ƒä¼˜

```sql
-- å†…å­˜å‚æ•°è°ƒä¼˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    param_value text;
BEGIN
    BEGIN
        SELECT setting INTO param_value FROM pg_settings WHERE name = 'shared_buffers';
        RAISE NOTICE 'shared_buffers: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'work_mem';
        RAISE NOTICE 'work_mem: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'maintenance_work_mem';
        RAISE NOTICE 'maintenance_work_mem: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'effective_cache_size';
        RAISE NOTICE 'effective_cache_size: %', param_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å†…å­˜å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¾ç½®å†…å­˜å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET shared_buffers = '256MB';
        SET work_mem = '4MB';
        SET maintenance_work_mem = '64MB';
        SET effective_cache_size = '1GB';
        RAISE NOTICE 'å†…å­˜å‚æ•°å·²è®¾ç½®';
    EXCEPTION
        WHEN invalid_parameter_value THEN
            RAISE WARNING 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®å€¼';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ£€æŸ¥ç‚¹å‚æ•°è°ƒä¼˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    param_value text;
BEGIN
    BEGIN
        SELECT setting INTO param_value FROM pg_settings WHERE name = 'checkpoint_timeout';
        RAISE NOTICE 'checkpoint_timeout: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'max_wal_size';
        RAISE NOTICE 'max_wal_size: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'min_wal_size';
        RAISE NOTICE 'min_wal_size: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'checkpoint_completion_target';
        RAISE NOTICE 'checkpoint_completion_target: %', param_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢æ£€æŸ¥ç‚¹å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¾ç½®æ£€æŸ¥ç‚¹å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET checkpoint_timeout = '15min';
        SET max_wal_size = '1GB';
        SET min_wal_size = '80MB';
        SET checkpoint_completion_target = 0.9;
        RAISE NOTICE 'æ£€æŸ¥ç‚¹å‚æ•°å·²è®¾ç½®';
    EXCEPTION
        WHEN invalid_parameter_value THEN
            RAISE WARNING 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®å€¼';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®æ£€æŸ¥ç‚¹å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

### 5.3 å¹¶å‘å‚æ•°è°ƒä¼˜

```sql
-- å¹¶å‘å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    param_value text;
BEGIN
    BEGIN
        SELECT setting INTO param_value FROM pg_settings WHERE name = 'max_connections';
        RAISE NOTICE 'max_connections: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'max_prepared_transactions';
        RAISE NOTICE 'max_prepared_transactions: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'max_locks_per_transaction';
        RAISE NOTICE 'max_locks_per_transaction: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'max_pred_locks_per_transaction';
        RAISE NOTICE 'max_pred_locks_per_transaction: %', param_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å¹¶å‘å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è®¾ç½®å¹¶å‘å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_connections = 100;
        SET max_prepared_transactions = 0;
        SET max_locks_per_transaction = 64;
        SET max_pred_locks_per_transaction = 64;
        RAISE NOTICE 'å¹¶å‘å‚æ•°å·²è®¾ç½®';
    EXCEPTION
        WHEN invalid_parameter_value THEN
            RAISE WARNING 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®å€¼';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶å‘å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

## 6. æ€§èƒ½åˆ†æå·¥å…·

### 6.1 æ‰§è¡Œè®¡åˆ’åˆ†æ

```sql
-- åˆ›å»ºæ‰§è¡Œè®¡åˆ’åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_execution_plan(query_text text)
RETURNS TABLE(
    node_type text,
    cost_start numeric,
    cost_total numeric,
    actual_time numeric,
    rows_estimated bigint,
    rows_actual bigint,
    width_estimated integer
) AS $$
BEGIN
    RETURN QUERY
    EXECUTE format('EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON) %s', query_text);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨æ‰§è¡Œè®¡åˆ’åˆ†æ
SELECT * FROM analyze_execution_plan('SELECT * FROM employees WHERE salary > 50000');
```

### 6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åˆ›å»ºæ€§èƒ½æµ‹è¯•å‡½æ•°
CREATE OR REPLACE FUNCTION benchmark_query(query_text text, iterations integer DEFAULT 10)
RETURNS TABLE(
    iteration integer,
    execution_time numeric,
    rows_returned bigint
) AS $$
DECLARE
    i integer;
    start_time timestamp;
    end_time timestamp;
    result_rows bigint;
BEGIN
    FOR i IN 1..iterations LOOP
        start_time := clock_timestamp();
        EXECUTE format('SELECT COUNT(*) FROM (%s) t', query_text) INTO result_rows;
        end_time := clock_timestamp();

        RETURN QUERY SELECT
            i,
            EXTRACT(EPOCH FROM (end_time - start_time)) * 1000,
            result_rows;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨æ€§èƒ½æµ‹è¯•
SELECT * FROM benchmark_query('SELECT * FROM employees WHERE salary > 50000', 5);
```

### 6.3 æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'performance_dashboard') THEN
            DROP VIEW performance_dashboard;
            RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§†å›¾ performance_dashboard';
        END IF;

        CREATE OR REPLACE VIEW performance_dashboard AS
        SELECT
            'Database' as metric_type,
            datname as metric_name,
            round(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) as hit_ratio,
            tup_returned + tup_fetched + tup_inserted + tup_updated + tup_deleted as total_operations
        FROM pg_stat_database
        WHERE datname = current_database()

        UNION ALL

        SELECT
            'Table' as metric_type,
            tablename as metric_name,
            round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) as hit_ratio,
            n_live_tup as total_operations
        FROM pg_stat_user_tables
        ORDER BY metric_type, hit_ratio DESC;

        RAISE NOTICE 'æ€§èƒ½ç›‘æ§è§†å›¾ performance_dashboard åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹æ€§èƒ½ä»ªè¡¨æ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    dashboard_record RECORD;
    record_count int := 0;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'performance_dashboard') THEN
            RAISE WARNING 'è§†å›¾ performance_dashboard ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
            RETURN;
        END IF;

        FOR dashboard_record IN
            SELECT * FROM performance_dashboard
            LIMIT 20
        LOOP
            record_count := record_count + 1;
            RAISE NOTICE 'æ€§èƒ½æŒ‡æ ‡: ç±»å‹=%, åç§°=%, å‘½ä¸­ç‡=%%%, æ€»æ“ä½œæ•°=%',
                dashboard_record.metric_type, dashboard_record.metric_name,
                dashboard_record.hit_ratio, dashboard_record.total_operations;
        END LOOP;

        IF record_count = 0 THEN
            RAISE WARNING 'æ€§èƒ½ä»ªè¡¨æ¿æ— æ•°æ®';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è§†å›¾ performance_dashboard ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ€§èƒ½ä»ªè¡¨æ¿å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM performance_dashboard;
```

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ…¢æŸ¥è¯¢ä¼˜åŒ–

```sql
-- è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_time,
    mean_time,
    stddev_time,
    rows,
    100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
WHERE mean_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’
ORDER BY mean_time DESC
LIMIT 10;

-- ä¼˜åŒ–æ…¢æŸ¥è¯¢
-- åŸå§‹æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id
WHERE e.salary > 50000 AND d.budget > 1000000;

-- åˆ›å»ºä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_emp_salary ON employees (salary);
CREATE INDEX idx_dept_budget ON departments (budget);
CREATE INDEX idx_proj_manager ON projects (manager_id);

-- ä¼˜åŒ–åæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id
WHERE e.salary > 50000 AND d.budget > 1000000;
```

### 7.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```sql
-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
-- ä¼˜åŒ–å‰
DO $$
DECLARE
    i integer;
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO employees (name, dept_id, salary)
        VALUES ('Employee' || i, (i % 10) + 1, 30000 + (i % 50000));
    END LOOP;
END $$;

-- ä¼˜åŒ–å
INSERT INTO employees (name, dept_id, salary)
SELECT
    'Employee' || generate_series(1, 10000),
    (generate_series(1, 10000) % 10) + 1,
    30000 + (generate_series(1, 10000) % 50000);

-- æ‰¹é‡æ›´æ–°ä¼˜åŒ–
-- ä¼˜åŒ–å‰
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 1;
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 2;
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 3;

-- ä¼˜åŒ–å
UPDATE employees SET salary = salary * 1.1 WHERE dept_id IN (1, 2, 3);
```

### 7.3 åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–

```sql
-- åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–
CREATE TABLE sales (
    id BIGSERIAL,
    sale_date DATE,
    amount DECIMAL(10,2),
    customer_id INTEGER
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2023 PARTITION OF sales
FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');

CREATE TABLE sales_2024 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- åˆ†åŒºæŸ¥è¯¢ä¼˜åŒ–
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM sales WHERE sale_date >= '2024-01-01' AND sale_date < '2024-02-01';

-- åˆ†åŒºè£å‰ª
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM sales WHERE sale_date BETWEEN '2024-01-01' AND '2024-12-31';
```

### 7.4 åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ– ğŸ†•

#### ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–çŸ¥è¯†ä½“ç³»

```mermaid
mindmap
  root((åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–))
    æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
      åˆ—é€‰æ‹©ä¼˜åŒ–
        åªæŸ¥è¯¢éœ€è¦çš„åˆ—
        å‡å°‘I/Oå¼€é”€
        æå‡æŸ¥è¯¢æ€§èƒ½
      èšåˆæŸ¥è¯¢ä¼˜åŒ–
        åˆ—å­˜å‚¨èšåˆä¼˜åŠ¿
        æ‰¹é‡å¤„ç†ä¼˜åŒ–
        å¹¶è¡Œèšåˆ
      è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–
        è°“è¯ä¸‹æ¨
        åˆ—å­˜å‚¨è¿‡æ»¤
        å‹ç¼©æ•°æ®è¿‡æ»¤
    æ‰§è¡Œè®¡åˆ’åˆ†æ
      åˆ—å­˜å‚¨æ‰«æ
        Foreign Scan
        åˆ—æ–‡ä»¶æ‰«æ
        å‹ç¼©æ•°æ®è¯»å–
      ä»£ä»·ä¼°ç®—
        åˆ—å­˜å‚¨ä»£ä»·æ¨¡å‹
        I/Oä»£ä»·ä¼°ç®—
        è§£å‹ä»£ä»·ä¼°ç®—
    æ€§èƒ½è°ƒä¼˜
      å‹ç¼©ä¼˜åŒ–
        å‹ç¼©ç®—æ³•é€‰æ‹©
        å‹ç¼©å‚æ•°è°ƒä¼˜
        å‹ç¼©ç‡ä¼˜åŒ–
      æŸ¥è¯¢é‡å†™
        åˆ—å­˜å‚¨æŸ¥è¯¢é‡å†™
        èšåˆæŸ¥è¯¢ä¼˜åŒ–
        è¿æ¥æŸ¥è¯¢ä¼˜åŒ–
```

**åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–æ¦‚è¿°**ï¼š

åˆ—å­˜å‚¨åœ¨æ‰§è¡Œè®¡åˆ’ä¸­è¡¨ç°ä¸º`Foreign Scan`èŠ‚ç‚¹ï¼Œä¼˜åŒ–å™¨éœ€è¦é’ˆå¯¹åˆ—å­˜å‚¨ç‰¹æ€§è¿›è¡Œç‰¹æ®Šä¼˜åŒ–ã€‚

#### ğŸ“Š åˆ—å­˜å‚¨ vs è¡Œå­˜å‚¨æ‰§è¡Œè®¡åˆ’å¯¹æ¯”çŸ©é˜µ

| æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ | è¡Œå­˜å‚¨ | åˆ—å­˜å‚¨ | æ€§èƒ½å·®å¼‚ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **æ‰«æèŠ‚ç‚¹** | Seq Scan / Index Scan | Foreign Scan | åˆ—å­˜å‚¨I/Oå‡å°‘50-90% | åˆ†ææŸ¥è¯¢ |
| **I/Oå¼€é”€** | è¯»å–æ•´è¡Œ | åªè¯»å–éœ€è¦çš„åˆ— | åˆ—å­˜å‚¨I/Oå‡å°‘ | æŸ¥è¯¢å°‘é‡åˆ— |
| **å‹ç¼©æ•°æ®** | æ— å‹ç¼©/é€šç”¨å‹ç¼© | åˆ—å‹ç¼©ï¼ˆ70-90%ï¼‰ | åˆ—å­˜å‚¨å‹ç¼©ç‡é«˜ | å†å²æ•°æ® |
| **èšåˆæ€§èƒ½** | è¡Œæ‰«æèšåˆ | åˆ—æ‰¹é‡èšåˆ | åˆ—å­˜å‚¨å¿«10-100å€ | èšåˆæŸ¥è¯¢ |
| **è¿‡æ»¤æ€§èƒ½** | è¡Œçº§è¿‡æ»¤ | åˆ—çº§è¿‡æ»¤+å‹ç¼©è¿‡æ»¤ | åˆ—å­˜å‚¨è¿‡æ»¤å¿« | èŒƒå›´æŸ¥è¯¢ |
| **è¿æ¥æ€§èƒ½** | è¡Œè¿æ¥ | åˆ—è¿æ¥ï¼ˆéœ€è½¬æ¢ï¼‰ | è¡Œå­˜å‚¨å¿« | ç‚¹æŸ¥è¯¢ |

#### ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–å†³ç­–æ ‘

```mermaid
flowchart TD
    A[åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–] --> B{æŸ¥è¯¢ç±»å‹}

    B -->|èšåˆæŸ¥è¯¢| C[åˆ—å­˜å‚¨èšåˆä¼˜åŒ– âœ…]
    B -->|ç‚¹æŸ¥è¯¢| D[è€ƒè™‘è¡Œå­˜å‚¨]
    B -->|åˆ†ææŸ¥è¯¢| E[åˆ—å­˜å‚¨åˆ†æä¼˜åŒ– âœ…]

    C --> C1[åªé€‰æ‹©èšåˆåˆ—<br/>å‡å°‘I/O]
    C --> C2[åˆ©ç”¨åˆ—å­˜å‚¨æ‰¹é‡å¤„ç†<br/>æå‡èšåˆæ€§èƒ½]
    C --> C3[å¹¶è¡Œèšåˆ<br/>åˆ©ç”¨å¤šæ ¸]

    E --> E1[åˆ—é€‰æ‹©ä¼˜åŒ–<br/>åªæŸ¥è¯¢éœ€è¦çš„åˆ—]
    E --> E2[è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–<br/>è°“è¯ä¸‹æ¨åˆ°åˆ—å­˜å‚¨]
    E --> E3[å‹ç¼©æ•°æ®è¿‡æ»¤<br/>å‡å°‘è§£å‹å¼€é”€]

    style C fill:#90EE90
    style E fill:#90EE90
```

**åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æ**ï¼š

```sql
-- 1. åˆ—å­˜å‚¨è¡¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    product_id,
    SUM(amount) as total_amount,
    SUM(quantity) as total_quantity,
    AVG(amount) as avg_amount
FROM fact_sales_columnar
WHERE date_id BETWEEN 20230101 AND 20231231
GROUP BY product_id
ORDER BY total_amount DESC
LIMIT 100;

-- æ‰§è¡Œè®¡åˆ’åˆ†æï¼š
-- Foreign Scan on fact_sales_columnar
--   Filter: (date_id >= 20230101 AND date_id <= 20231231)
--   -> HashAggregate
--         Group Key: product_id
--         -> Sort
--               Sort Key: product_id
--               -> Foreign Scan on fact_sales_columnar
--                     Columns: product_id, amount, quantity, date_id
--                     (åªæ‰«æéœ€è¦çš„åˆ—ï¼ŒI/Oå‡å°‘)

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- è¡Œå­˜å‚¨ï¼šæ‰«ææ‰€æœ‰åˆ—ï¼ŒI/Oå¤§ï¼ŒæŸ¥è¯¢æ—¶é—´ï¼š10-30ç§’
-- åˆ—å­˜å‚¨ï¼šåªæ‰«æproduct_id, amount, quantity, date_idï¼ŒI/Oå°ï¼ŒæŸ¥è¯¢æ—¶é—´ï¼š1-3ç§’
-- æ€§èƒ½æå‡ï¼š5-10å€
```

**åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. åˆ—é€‰æ‹©ä¼˜åŒ–ï¼šåªæŸ¥è¯¢éœ€è¦çš„åˆ—
-- âŒ ä¸æ¨èï¼šæŸ¥è¯¢æ‰€æœ‰åˆ—
SELECT * FROM fact_sales_columnar WHERE date_id = 20230101;

-- âœ… æ¨èï¼šåªæŸ¥è¯¢éœ€è¦çš„åˆ—
SELECT product_id, amount, quantity
FROM fact_sales_columnar
WHERE date_id = 20230101;

-- 2. èšåˆæŸ¥è¯¢ä¼˜åŒ–ï¼šåˆ©ç”¨åˆ—å­˜å‚¨æ‰¹é‡å¤„ç†
-- âœ… åˆ—å­˜å‚¨èšåˆæŸ¥è¯¢ï¼ˆæ€§èƒ½å¥½ï¼‰
SELECT
    product_id,
    SUM(amount) as total_amount,
    COUNT(*) as order_count
FROM fact_sales_columnar
WHERE date_id BETWEEN 20230101 AND 20231231
GROUP BY product_id;

-- 3. è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–ï¼šè°“è¯ä¸‹æ¨
-- âœ… è¿‡æ»¤æ¡ä»¶ä¼šè‡ªåŠ¨ä¸‹æ¨åˆ°åˆ—å­˜å‚¨æ‰«æ
SELECT product_id, amount
FROM fact_sales_columnar
WHERE date_id BETWEEN 20230101 AND 20231231
  AND amount > 1000
  AND product_id IN (1, 2, 3);

-- 4. æ··åˆå­˜å‚¨æŸ¥è¯¢ï¼šçƒ­æ•°æ®è¡Œå­˜å‚¨ + å†·æ•°æ®åˆ—å­˜å‚¨
-- ä½¿ç”¨UNIONæŸ¥è¯¢çƒ­æ•°æ®å’Œå†·æ•°æ®
SELECT product_id, SUM(amount) as total_amount
FROM (
    -- çƒ­æ•°æ®ï¼ˆè¡Œå­˜å‚¨ï¼‰
    SELECT product_id, amount
    FROM sales_fact
    WHERE sale_date >= CURRENT_DATE - INTERVAL '3 months'

    UNION ALL

    -- å†·æ•°æ®ï¼ˆåˆ—å­˜å‚¨ï¼‰
    SELECT product_id, amount
    FROM fact_sales_columnar
    WHERE date_id < (SELECT date_id FROM date_dim
                     WHERE date = CURRENT_DATE - INTERVAL '3 months')
) combined
GROUP BY product_id;
```

#### ğŸ“Š åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client
    participant Optimizer
    participant Executor
    participant ColumnStore
    participant Compression

    Client->>Optimizer: SELECT product_id, SUM(amount) FROM fact_sales_columnar WHERE date_id BETWEEN ? AND ? GROUP BY product_id
    Optimizer->>Optimizer: åˆ†ææŸ¥è¯¢æ¡ä»¶
    Optimizer->>Optimizer: é€‰æ‹©åˆ—ï¼šproduct_id, amount, date_id
    Optimizer->>Optimizer: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼šForeign Scan + HashAggregate

    Optimizer->>Executor: æ‰§è¡Œè®¡åˆ’
    Executor->>ColumnStore: Foreign Scanï¼ˆåªè¯»å–éœ€è¦çš„åˆ—ï¼‰
    ColumnStore->>Compression: è¯»å–å‹ç¼©åˆ—æ–‡ä»¶
    Compression->>Compression: è§£å‹åˆ—æ•°æ®
    Compression-->>ColumnStore: è¿”å›è§£å‹æ•°æ®
    ColumnStore->>ColumnStore: åº”ç”¨è¿‡æ»¤æ¡ä»¶ï¼ˆdate_id BETWEENï¼‰
    ColumnStore-->>Executor: è¿”å›è¿‡æ»¤åçš„åˆ—æ•°æ®

    Executor->>Executor: HashAggregateï¼ˆæŒ‰product_idèšåˆï¼‰
    Executor->>Executor: è®¡ç®—SUM(amount)
    Executor-->>Client: è¿”å›èšåˆç»“æœ

    Note over Executor,ColumnStore: åˆ—å­˜å‚¨ä¼˜åŠ¿ï¼šåªè¯»å–éœ€è¦çš„åˆ—ï¼ŒI/Oå‡å°‘50-90%
```

## 8. PostgreSQL 18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æ–°ç‰¹æ€§

### 8.1 å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡

PostgreSQL 18å¯¹å¤æ‚æŸ¥è¯¢è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡30-40%ã€‚

**å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡**ï¼š

```sql
-- å¤æ‚åˆ†ææŸ¥è¯¢ï¼ˆPostgreSQL 18æ€§èƒ½æå‡30-40%ï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
WITH dept_stats AS (
    SELECT
        dept_id,
        COUNT(*) as emp_count,
        AVG(salary) as avg_salary,
        MAX(salary) as max_salary
    FROM employees
    GROUP BY dept_id
),
ranked_employees AS (
    SELECT
        e.*,
        ROW_NUMBER() OVER (PARTITION BY e.dept_id ORDER BY e.salary DESC) as salary_rank
    FROM employees e
)
SELECT
    d.dept_name,
    ds.emp_count,
    ds.avg_salary,
    re.name as top_employee,
    re.salary as top_salary
FROM departments d
JOIN dept_stats ds ON d.dept_id = ds.dept_id
JOIN ranked_employees re ON d.dept_id = re.dept_id AND re.salary_rank = 1;

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—
-- 2. æ›´æ™ºèƒ½çš„CTEç‰©åŒ–ç­–ç•¥
-- 3. æ”¹è¿›çš„çª—å£å‡½æ•°æ‰§è¡Œ
```

**æ€§èƒ½æå‡**ï¼š

- å¤æ‚æŸ¥è¯¢æ€§èƒ½æå‡30-40%
- æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—
- æ›´æ™ºèƒ½çš„æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

### 8.2 æ›´å‡†ç¡®çš„æ‰§è¡Œè®¡åˆ’ä¼°ç®—

PostgreSQL 18æ”¹è¿›äº†æ‰§è¡Œè®¡åˆ’ä¼°ç®—ç®—æ³•ï¼Œæ˜¾è‘—æé«˜äº†ä¼°ç®—å‡†ç¡®æ€§ã€‚

**æ‰§è¡Œè®¡åˆ’ä¼°ç®—æ”¹è¿›**ï¼š

```sql
-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¼°ç®—å‡†ç¡®æ€§
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.lead_emp_id
WHERE e.salary > 50000
AND d.location = 'New York'
AND p.status = 'active';

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. åŸºæ•°ä¼°è®¡è¯¯å·®ä»25%é™ä½åˆ°15%
-- 2. æ›´å‡†ç¡®çš„è¿æ¥åŸºæ•°ä¼°è®¡
-- 3. æ›´æ™ºèƒ½çš„ç»Ÿè®¡ä¿¡æ¯åˆ©ç”¨
```

**æ”¹è¿›ç‚¹**ï¼š

- åŸºæ•°ä¼°è®¡è¯¯å·®ä»25%é™ä½åˆ°15%
- æ›´å‡†ç¡®çš„è¿æ¥åŸºæ•°ä¼°è®¡
- æ›´æ™ºèƒ½çš„ç»Ÿè®¡ä¿¡æ¯åˆ©ç”¨

### 8.3 æ”¹è¿›çš„EXPLAINåˆ†æ

PostgreSQL 18æ”¹è¿›äº†EXPLAINå‘½ä»¤çš„è¾“å‡ºå’Œåˆ†æåŠŸèƒ½ã€‚

**EXPLAINåˆ†ææ”¹è¿›**ï¼š

```sql
-- PostgreSQL 18æ”¹è¿›çš„EXPLAINè¾“å‡º
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;

-- æ–°å¢SETTINGSé€‰é¡¹ï¼ˆPostgreSQL 18ï¼‰
-- æ˜¾ç¤ºå½±å“æŸ¥è¯¢è®¡åˆ’çš„é…ç½®å‚æ•°

-- æ›´è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING, SUMMARY)
SELECT * FROM large_table WHERE value > 1000;

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
-- 2. æ›´æ¸…æ™°çš„è®¡åˆ’æ ‘ç»“æ„
-- 3. æ›´å¥½çš„æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
- æ›´æ¸…æ™°çš„è®¡åˆ’æ ‘ç»“æ„
- æ›´å¥½çš„æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

### 8.4 å¼‚æ­¥I/Oæå‡I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡äº†I/Oå¯†é›†å‹æŸ¥è¯¢çš„æ€§èƒ½ã€‚

**å¼‚æ­¥I/Oåœ¨æŸ¥è¯¢æ‰§è¡Œä¸­çš„åº”ç”¨**ï¼š

```sql
-- é…ç½®å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4  -- ç»´æŠ¤æ“ä½œçš„I/Oå·¥ä½œè¿›ç¨‹
-- max_io_workers = 10  -- æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹æ•°

-- I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”
-- ä¼ ç»ŸåŒæ­¥I/O
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- I/Oç­‰å¾…æ—¶é—´ï¼šçº¦30ç§’

-- å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
-- é…ç½®å¼‚æ­¥I/Oå
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- I/Oç­‰å¾…æ—¶é—´ï¼šçº¦10-15ç§’ï¼ˆæ€§èƒ½æå‡2-3å€ï¼‰

-- ç›‘æ§I/Oæ€§èƒ½
SELECT
    object,
    context,
    reads,
    writes,
    read_time,
    write_time
FROM pg_stat_io
ORDER BY reads DESC;
```

**æ€§èƒ½æå‡**ï¼š

- I/Oå¯†é›†å‹æŸ¥è¯¢æ€§èƒ½æå‡2-3å€
- å‡å°‘I/Oç­‰å¾…æ—¶é—´
- æé«˜æŸ¥è¯¢ååé‡

### 8.5 æ”¹è¿›çš„æ‰§è¡Œè®¡åˆ’ç¼“å­˜

PostgreSQL 18æ”¹è¿›äº†æ‰§è¡Œè®¡åˆ’ç¼“å­˜æœºåˆ¶ï¼Œæé«˜äº†é‡å¤æŸ¥è¯¢çš„æ€§èƒ½ã€‚

**æ‰§è¡Œè®¡åˆ’ç¼“å­˜æ”¹è¿›**ï¼š

```sql
-- å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆPostgreSQL 18æ”¹è¿›è®¡åˆ’ç¼“å­˜ï¼‰
PREPARE get_employees (INTEGER, DECIMAL) AS
SELECT * FROM employees
WHERE dept_id = $1 AND salary > $2;

-- æ‰§è¡Œå‚æ•°åŒ–æŸ¥è¯¢
EXECUTE get_employees(1, 50000);
EXECUTE get_employees(2, 60000);
EXECUTE get_employees(3, 70000);

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´æ™ºèƒ½çš„è®¡åˆ’ç¼“å­˜ç­–ç•¥
-- 2. æ›´å¥½çš„è®¡åˆ’é‡ç”¨æœºåˆ¶
-- 3. å‡å°‘è®¡åˆ’ç”Ÿæˆå¼€é”€
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´æ™ºèƒ½çš„è®¡åˆ’ç¼“å­˜ç­–ç•¥
- æ›´å¥½çš„è®¡åˆ’é‡ç”¨æœºåˆ¶
- å‡å°‘è®¡åˆ’ç”Ÿæˆå¼€é”€

### 8.6 PostgreSQL 18æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ

**æœ€ä½³å®è·µæ€»ç»“**ï¼š

```sql
-- 1. åˆ©ç”¨PostgreSQL 18çš„æ€§èƒ½æå‡
-- ç¡®ä¿ä½¿ç”¨PostgreSQL 18å¹¶é…ç½®å¼‚æ­¥I/O
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4
-- max_io_workers = 10

-- 2. ä½¿ç”¨æ”¹è¿›çš„EXPLAINåˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;

-- 3. ç¡®ä¿ç»Ÿè®¡ä¿¡æ¯åŠæ—¶æ›´æ–°
ANALYZE employees;
ANALYZE departments;

-- 4. åˆ©ç”¨å‚æ•°åŒ–æŸ¥è¯¢æå‡è®¡åˆ’ç¼“å­˜æ•ˆç‡
PREPARE get_employees (INTEGER, DECIMAL) AS
SELECT * FROM employees WHERE dept_id = $1 AND salary > $2;

-- 5. ç›‘æ§I/Oæ€§èƒ½
SELECT * FROM pg_stat_io ORDER BY reads DESC;

-- 6. åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–æŸ¥è¯¢
CREATE TABLE products (
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) VIRTUAL
);
CREATE INDEX idx_products_final_price ON products (final_price);
```

## 9. æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ

### 9.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

```sql
-- ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
-- 1. åˆ†ææŸ¥è¯¢æ¨¡å¼
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename, attname;

-- 2. åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_emp_optimized ON employees (dept_id, salary, hire_date);

-- 3. ç›‘æ§ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0;  -- æœªä½¿ç”¨çš„ç´¢å¼•
```

### 9.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

```sql
-- æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
-- 1. ä½¿ç”¨é€‚å½“çš„JOINç±»å‹
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
INNER JOIN departments d ON e.dept_id = d.dept_id;

-- 2. é¿å…SELECT *
EXPLAIN (ANALYZE, BUFFERS)
SELECT emp_id, name, salary FROM employees WHERE dept_id = 1;

-- 3. ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›†
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees ORDER BY salary DESC LIMIT 10;
```

### 9.3 ç³»ç»Ÿé…ç½®ä¼˜åŒ–

```sql
-- ç³»ç»Ÿé…ç½®ä¼˜åŒ–
-- 1. å†…å­˜é…ç½®
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';

-- 2. æ£€æŸ¥ç‚¹é…ç½®
ALTER SYSTEM SET checkpoint_timeout = '15min';
ALTER SYSTEM SET max_wal_size = '1GB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;

-- 3. å¹¶å‘é…ç½®
ALTER SYSTEM SET max_connections = 100;
ALTER SYSTEM SET max_prepared_transactions = 0;

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

## 10. ç›¸å…³æ¦‚å¿µ

### 10.1 ä¸Šä½æ¦‚å¿µ

- **æŸ¥è¯¢ä¼˜åŒ–**: æ›´å¹¿æ³›çš„æŸ¥è¯¢ä¼˜åŒ–æœºåˆ¶
- **æ€§èƒ½ç®¡ç†**: ç³»ç»Ÿæ€§èƒ½ç®¡ç†
- **æ•°æ®åº“è°ƒä¼˜**: æ•°æ®åº“æ€§èƒ½è°ƒä¼˜

### 10.2 ä¸‹ä½æ¦‚å¿µ

- **æ‰§è¡Œè®¡åˆ’**: æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
- **æ€§èƒ½ç›‘æ§**: æ€§èƒ½ç›‘æ§æœºåˆ¶
- **ç´¢å¼•ä¼˜åŒ–**: ç´¢å¼•æ€§èƒ½ä¼˜åŒ–
- **æŸ¥è¯¢é‡å†™**: æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯

### 10.3 å¹³è¡Œæ¦‚å¿µ

- **åŸºå‡†æµ‹è¯•**: æ€§èƒ½åŸºå‡†æµ‹è¯•
- **è´Ÿè½½æµ‹è¯•**: ç³»ç»Ÿè´Ÿè½½æµ‹è¯•
- **å®¹é‡è§„åˆ’**: ç³»ç»Ÿå®¹é‡è§„åˆ’

## 11. ç›¸å…³æ–‡æ¡£

### 10.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å®æˆ˜æ¡ˆä¾‹](../../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ
- [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - æ€§èƒ½è°ƒä¼˜å®è·µæ¡ˆä¾‹
- [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - æ€§èƒ½ç›‘æ§å®è·µ
- [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - ç”Ÿäº§çº§æ€§èƒ½ä¼˜åŒ–

## 12. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. Selinger, P. G., et al. (1979). Access path selection in a relational database management system. ACM SIGMOD Record, 8(2), 23-34.
3. Graefe, G. (1995). The Cascades framework for query optimization. IEEE Data Engineering Bulletin, 18(3), 19-29.
4. Ioannidis, Y. E. (1996). Query optimization. ACM Computing Surveys, 28(1), 121-123.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

## 13. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### æŸ¥è¯¢ä¸ä¼˜åŒ–

- â­â­â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](./02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–ç†è®ºåŸºç¡€
- â­â­â­ [ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹](./02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ä»£ä»·æ¨¡å‹ç†è®ºåŸºç¡€
- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](./02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - ç´¢å¼•ä¼˜åŒ–å®è·µ
- â­â­ [å¹¶è¡ŒæŸ¥è¯¢å¤„ç†](./02.05-å¹¶è¡ŒæŸ¥è¯¢å¤„ç†.md) - å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†](../../01-æ ¸å¿ƒåŸºç¡€/01.04-SQLè¯­è¨€/01.03-SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†.md) - SQLè¯­è¨€åŸºç¡€

#### æ•°æ®æ¨¡å‹è®¾è®¡

- â­â­ [æ•°æ®æ¨¡å‹è®¾è®¡](../../17-æ•°æ®æ¨¡å‹è®¾è®¡/README.md) - æ€§èƒ½åˆ†æå®è·µ

#### éƒ¨ç½²æ¶æ„

- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜è¯¦ç»†æŒ‡å—

#### è¿ç»´å®è·µ

- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - æ€§èƒ½ç›‘æ§
- â­â­ [æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - æ€§èƒ½é—®é¢˜æ¡ˆä¾‹

### å¤–éƒ¨èµ„æº

- [PostgreSQL EXPLAINæ–‡æ¡£](https://www.postgresql.org/docs/current/using-explain.html)
- [PostgreSQLç›‘æ§ç»Ÿè®¡æ–‡æ¡£](https://www.postgresql.org/docs/current/monitoring-stats.html)
- [PostgreSQLæ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](https://wiki.postgresql.org/wiki/Performance_Optimization)

---

## 14. Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/using-explain.html>
  - <https://www.postgresql.org/docs/current/monitoring-stats.html>

---

## 15. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯

### 14.1 æ‰§è¡Œè®¡åˆ’å‡†ç¡®æ€§è¯æ˜

**å®šç†**: EXPLAIN ANALYZE è¾“å‡ºçš„å®é™…æ‰§è¡Œæ—¶é—´ä¸è®¡åˆ’ä¼°ç®—æ—¶é—´çš„æ¯”å€¼åæ˜ äº†ä»£ä»·æ¨¡å‹çš„å‡†ç¡®æ€§ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[æ‰§è¡Œè®¡åˆ’å‡†ç¡®æ€§]
è®¾æ‰§è¡Œè®¡åˆ’ \plan çš„ä¼°ç®—æ—¶é—´ä¸º T_{est}ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ä¸º T_{act}ã€‚

å‡†ç¡®æ€§åº¦é‡ï¼š
\text{Accuracy} = \frac{T_{est}}{T_{act}}

å¦‚æœ \text{Accuracy} \approx 1ï¼Œåˆ™ä»£ä»·æ¨¡å‹å‡†ç¡®ã€‚

ä»£ä»·æ¨¡å‹å‡†ç¡®æ€§å½±å“å› ç´ ï¼š
1. ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§ï¼š\text{Accuracy}(stats) \propto \text{Accuracy}(plan)
2. ä»£ä»·å‚æ•°è®¾ç½®ï¼š\text{Accuracy}(params) \propto \text{Accuracy}(plan)
3. æ•°æ®åˆ†å¸ƒå‡è®¾ï¼š\text{Accuracy}(assumption) \propto \text{Accuracy}(plan)

å¦‚æœç»Ÿè®¡ä¿¡æ¯å‡†ç¡®ã€ä»£ä»·å‚æ•°åˆç†ã€æ•°æ®åˆ†å¸ƒå‡è®¾æ­£ç¡®ï¼Œåˆ™æ‰§è¡Œè®¡åˆ’å‡†ç¡®æ€§é«˜ã€‚
\end{theorem}
```

### 14.2 æ€§èƒ½è°ƒä¼˜æœ€ä¼˜æ€§è¯æ˜

**å®šç†**: é€šè¿‡ç³»ç»ŸåŒ–çš„æ€§èƒ½è°ƒä¼˜æ–¹æ³•ï¼Œå¯ä»¥æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜çš„ç³»ç»Ÿé…ç½®ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[æ€§èƒ½è°ƒä¼˜æœ€ä¼˜æ€§]
è®¾ç³»ç»Ÿé…ç½®ç©ºé—´ä¸º \mathcal{C}ï¼Œæ€§èƒ½æŒ‡æ ‡ä¸º \text{Perf}: \mathcal{C} \rightarrow \mathbb{R}^+ã€‚

æœ€ä¼˜é…ç½®ï¼š
c^* = \arg\max_{c \in \mathcal{C}} \text{Perf}(c)

æ€§èƒ½è°ƒä¼˜æ–¹æ³•ï¼š
1. åŸºå‡†æµ‹è¯•ï¼š\text{Perf}(c) = f(\text{benchmark}(c))
2. å‚æ•°è°ƒä¼˜ï¼šc^* = \text{optimize}(\text{Perf}, \mathcal{C})
3. è¿­ä»£ä¼˜åŒ–ï¼šc_{i+1} = \text{improve}(c_i, \text{Perf}(c_i))

ç”±äºé…ç½®ç©ºé—´é€šå¸¸æ˜¯ç¦»æ•£çš„ï¼Œå¯ä»¥é€šè¿‡ç©·ä¸¾æˆ–å¯å‘å¼æ–¹æ³•æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜è§£ã€‚

æ€§èƒ½è°ƒä¼˜çš„æ”¶æ•›æ€§ï¼š
å¦‚æœ \text{Perf} æ˜¯å•è°ƒçš„ï¼ˆå‚æ•°å¢åŠ æ€§èƒ½æå‡ï¼‰ï¼Œåˆ™ä¼˜åŒ–è¿‡ç¨‹æ”¶æ•›ã€‚
\end{theorem}
```

### 14.3 ç´¢å¼•é€‰æ‹©æœ€ä¼˜æ€§è¯æ˜

**å®šç†**: å¯¹äºç­‰å€¼æŸ¥è¯¢ï¼Œå¦‚æœå­˜åœ¨å”¯ä¸€ç´¢å¼•ï¼Œåˆ™ç´¢å¼•æ‰«ææ˜¯æœ€ä¼˜é€‰æ‹©ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[ç´¢å¼•é€‰æ‹©æœ€ä¼˜æ€§]
è®¾æŸ¥è¯¢ Q = \sigma_{A=a}(R)ï¼Œå…¶ä¸­ A ä¸ºå±æ€§ï¼Œa ä¸ºå¸¸é‡å€¼ã€‚

æƒ…å†µ1ï¼šå­˜åœ¨å”¯ä¸€ç´¢å¼• I_A
- ç´¢å¼•æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ï¼šO(\log n)
- ç»“æœé›†å¤§å°ï¼š|R| \leq 1ï¼ˆå”¯ä¸€æ€§ä¿è¯ï¼‰
- æ€»ä»£ä»·ï¼š\cost_{index} = O(\log n)

æƒ…å†µ2ï¼šå…¨è¡¨æ‰«æ
- æ‰«ææ—¶é—´å¤æ‚åº¦ï¼šO(n)
- ç»“æœé›†å¤§å°ï¼š|R| \leq 1
- æ€»ä»£ä»·ï¼š\cost_{seq} = O(n)

ç”±äº O(\log n) < O(n)ï¼ˆå½“ n > 1ï¼‰ï¼Œç´¢å¼•æ‰«ææ˜¯æœ€ä¼˜é€‰æ‹©ã€‚

å¯¹äºèŒƒå›´æŸ¥è¯¢ï¼Œå¦‚æœç´¢å¼•æ”¯æŒèŒƒå›´æ‰«æï¼Œç´¢å¼•æ‰«æä»ç„¶æ˜¯æœ€ä¼˜é€‰æ‹©ã€‚
\end{theorem}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
