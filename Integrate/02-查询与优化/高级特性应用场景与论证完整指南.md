---
> **ğŸ“‹ æ–‡æ¡£æ¥æº**: æ–°å¢æ·±åŒ–æ–‡æ¡£
> **ğŸ“… åˆ›å»ºæ—¥æœŸ**: 2025-01
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£èšç„¦CTEã€JSONã€æ•°ç»„ç­‰é«˜çº§ç‰¹æ€§åº”ç”¨åœºæ™¯åˆ†æä¸è®ºè¯

---

# PostgreSQLé«˜çº§ç‰¹æ€§åº”ç”¨åœºæ™¯ä¸è®ºè¯å®Œæ•´æŒ‡å—

## å…ƒæ•°æ®

- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01
- **æŠ€æœ¯æ ˆ**: PostgreSQL 17+/18+ | CTE | JSON/JSONB | æ•°ç»„ | é€’å½’æŸ¥è¯¢
- **éš¾åº¦çº§åˆ«**: â­â­â­â­â­ (ä¸“å®¶çº§)
- **é¢„è®¡é˜…è¯»**: 200åˆ†é’Ÿ
- **å‰ç½®è¦æ±‚**: ç†Ÿæ‚‰PostgreSQLåŸºç¡€ã€SQLé«˜çº§ç‰¹æ€§

---

## ğŸ“‹ å®Œæ•´ç›®å½•

- [PostgreSQLé«˜çº§ç‰¹æ€§åº”ç”¨åœºæ™¯ä¸è®ºè¯å®Œæ•´æŒ‡å—](#postgresqlé«˜çº§ç‰¹æ€§åº”ç”¨åœºæ™¯ä¸è®ºè¯å®Œæ•´æŒ‡å—)
  - [å…ƒæ•°æ®](#å…ƒæ•°æ®)
  - [ğŸ“‹ å®Œæ•´ç›®å½•](#-å®Œæ•´ç›®å½•)
  - [1. é«˜çº§ç‰¹æ€§æ¦‚è¿°](#1-é«˜çº§ç‰¹æ€§æ¦‚è¿°)
    - [1.1 ç‰¹æ€§åˆ†ç±»](#11-ç‰¹æ€§åˆ†ç±»)
      - [1.1.1 é«˜çº§ç‰¹æ€§ä½“ç³»æ€ç»´å¯¼å›¾](#111-é«˜çº§ç‰¹æ€§ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.2 ç‰¹æ€§é€‰å‹å†³ç­–](#12-ç‰¹æ€§é€‰å‹å†³ç­–)
      - [1.2.1 ç‰¹æ€§é€‰å‹å†³ç­–çŸ©é˜µ](#121-ç‰¹æ€§é€‰å‹å†³ç­–çŸ©é˜µ)
  - [2. CTEåº”ç”¨åœºæ™¯åˆ†æ](#2-cteåº”ç”¨åœºæ™¯åˆ†æ)
    - [2.1 åœºæ™¯æè¿°](#21-åœºæ™¯æè¿°)
      - [2.1.1 ä¸šåŠ¡éœ€æ±‚](#211-ä¸šåŠ¡éœ€æ±‚)
    - [2.2 CTEæ–¹æ¡ˆ](#22-cteæ–¹æ¡ˆ)
      - [2.2.1 CTEå®ç°](#221-cteå®ç°)
    - [2.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”](#23-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”)
      - [2.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#231-æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
      - [2.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šåµŒå¥—å­æŸ¥è¯¢](#232-æ›¿ä»£æ–¹æ¡ˆåµŒå¥—å­æŸ¥è¯¢)
    - [2.4 æ€§èƒ½è®ºè¯](#24-æ€§èƒ½è®ºè¯)
      - [2.4.1 æ€§èƒ½æµ‹è¯•](#241-æ€§èƒ½æµ‹è¯•)
  - [3. é€’å½’CTEåº”ç”¨åœºæ™¯](#3-é€’å½’cteåº”ç”¨åœºæ™¯)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
      - [3.1.1 ä¸šåŠ¡éœ€æ±‚](#311-ä¸šåŠ¡éœ€æ±‚)
    - [3.2 é€’å½’CTEæ–¹æ¡ˆ](#32-é€’å½’cteæ–¹æ¡ˆ)
      - [3.2.1 é€’å½’CTEå®ç°](#321-é€’å½’cteå®ç°)
    - [3.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”](#33-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”)
      - [3.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#331-æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [4. JSON/JSONBåº”ç”¨åœºæ™¯](#4-jsonjsonbåº”ç”¨åœºæ™¯)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
      - [4.1.1 ä¸šåŠ¡éœ€æ±‚](#411-ä¸šåŠ¡éœ€æ±‚)
    - [4.2 JSON/JSONBæ–¹æ¡ˆ](#42-jsonjsonbæ–¹æ¡ˆ)
      - [4.2.1 JSONBå®ç°](#421-jsonbå®ç°)
    - [4.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”](#43-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”)
      - [4.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#431-æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
      - [4.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šEAVæ¨¡å‹](#432-æ›¿ä»£æ–¹æ¡ˆeavæ¨¡å‹)
    - [4.4 æ€§èƒ½è®ºè¯](#44-æ€§èƒ½è®ºè¯)
      - [4.4.1 æ€§èƒ½æµ‹è¯•](#441-æ€§èƒ½æµ‹è¯•)
  - [5. æ•°ç»„åº”ç”¨åœºæ™¯](#5-æ•°ç»„åº”ç”¨åœºæ™¯)
    - [5.1 åœºæ™¯æè¿°](#51-åœºæ™¯æè¿°)
      - [ä¸šåŠ¡éœ€æ±‚](#ä¸šåŠ¡éœ€æ±‚)
    - [5.2 æ•°ç»„æ–¹æ¡ˆ](#52-æ•°ç»„æ–¹æ¡ˆ)
      - [5.2.1 æ•°ç»„å®ç°](#521-æ•°ç»„å®ç°)
    - [5.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”](#53-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”)
      - [5.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#531-æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
      - [5.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šå…³è”è¡¨](#532-æ›¿ä»£æ–¹æ¡ˆå…³è”è¡¨)
    - [5.4 æ€§èƒ½è®ºè¯](#54-æ€§èƒ½è®ºè¯)
      - [æ€§èƒ½æµ‹è¯•](#æ€§èƒ½æµ‹è¯•)
  - [6. ç‰¹æ€§ç»„åˆåº”ç”¨](#6-ç‰¹æ€§ç»„åˆåº”ç”¨)
    - [6.1 çª—å£å‡½æ•°+CTE](#61-çª—å£å‡½æ•°cte)
      - [ç»„åˆåº”ç”¨ç¤ºä¾‹](#ç»„åˆåº”ç”¨ç¤ºä¾‹)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)
  - [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## 1. é«˜çº§ç‰¹æ€§æ¦‚è¿°

### 1.1 ç‰¹æ€§åˆ†ç±»

#### 1.1.1 é«˜çº§ç‰¹æ€§ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((PostgreSQLé«˜çº§ç‰¹æ€§))
    CTE
      ç®€å•CTE
        æŸ¥è¯¢ç®€åŒ–
        ä»£ç å¯è¯»æ€§
      é€’å½’CTE
        å±‚æ¬¡ç»“æ„
        å›¾éå†
        ç´¯è®¡è®¡ç®—
      ç‰©åŒ–CTE
        æ€§èƒ½ä¼˜åŒ–
        ä¸­é—´ç»“æœç¼“å­˜
    JSON/JSONB
      JSON
        æ–‡æœ¬å­˜å‚¨
        å®Œæ•´éªŒè¯
      JSONB
        äºŒè¿›åˆ¶å­˜å‚¨
        ç´¢å¼•æ”¯æŒ
        GINç´¢å¼•
        æŸ¥è¯¢ä¼˜åŒ–
    æ•°ç»„
      ä¸€ç»´æ•°ç»„
        ç®€å•åˆ—è¡¨
      å¤šç»´æ•°ç»„
        çŸ©é˜µæ•°æ®
      æ•°ç»„å‡½æ•°
        èšåˆæ“ä½œ
        å…ƒç´ æ“ä½œ
    çª—å£å‡½æ•°
      æ’åå‡½æ•°
      èšåˆå‡½æ•°
      å€¼å‡½æ•°
    LATERAL JOIN
      ç›¸å…³å­æŸ¥è¯¢ä¼˜åŒ–
      è¡¨å‡½æ•°è°ƒç”¨
```

### 1.2 ç‰¹æ€§é€‰å‹å†³ç­–

#### 1.2.1 ç‰¹æ€§é€‰å‹å†³ç­–çŸ©é˜µ

| éœ€æ±‚åœºæ™¯ | æ¨èç‰¹æ€§ | æ›¿ä»£æ–¹æ¡ˆ | æ€§èƒ½ | å¤æ‚åº¦ |
| --- | --- | --- | --- | --- |
| **å¤æ‚æŸ¥è¯¢ç®€åŒ–** | CTE | å­æŸ¥è¯¢/ä¸´æ—¶è¡¨ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ç®€å• |
| **å±‚æ¬¡ç»“æ„æŸ¥è¯¢** | é€’å½’CTE | åº”ç”¨å±‚é€’å½’ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ç®€å• |
| **åŠç»“æ„åŒ–æ•°æ®** | JSONB | å…³ç³»è¡¨/EAV | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ç®€å• |
| **åˆ—è¡¨æ•°æ®** | æ•°ç»„ | å…³è”è¡¨ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ç®€å• |
| **åŠ¨æ€åˆ—** | JSONB | å®½è¡¨ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¡ ä¸­ç­‰ |

---

## 2. CTEåº”ç”¨åœºæ™¯åˆ†æ

### 2.1 åœºæ™¯æè¿°

#### 2.1.1 ä¸šåŠ¡éœ€æ±‚

```text
åœºæ™¯ï¼šå¤šå±‚æ•°æ®åˆ†æ
éœ€æ±‚ï¼š
1. é¦–å…ˆç­›é€‰é«˜ä»·å€¼å®¢æˆ·
2. ç„¶åè®¡ç®—å®¢æˆ·è®¢å•ç»Ÿè®¡
3. æœ€åè¿›è¡Œå®¢æˆ·åˆ†ç±»

æ•°æ®é‡ï¼š100ä¸‡å®¢æˆ·ï¼Œ1000ä¸‡è®¢å•
æŸ¥è¯¢é¢‘ç‡ï¼šå®æ—¶æŸ¥è¯¢
```

### 2.2 CTEæ–¹æ¡ˆ

#### 2.2.1 CTEå®ç°

```sql
-- CTEæ–¹æ¡ˆï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'customers') THEN
            RAISE WARNING 'è¡¨ customers ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒCTEæŸ¥è¯¢';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒCTEæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒCTEæŸ¥è¯¢æ€§èƒ½æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH high_value_customers AS (
    -- æ­¥éª¤1ï¼šç­›é€‰é«˜ä»·å€¼å®¢æˆ·
    SELECT
        customer_id,
        name,
        email,
        total_spent
    FROM customers
    WHERE total_spent > 10000
),
customer_order_stats AS (
    -- æ­¥éª¤2ï¼šè®¡ç®—è®¢å•ç»Ÿè®¡
    SELECT
        hvc.customer_id,
        hvc.name,
        COUNT(o.order_id) AS order_count,
        SUM(o.amount) AS total_amount,
        AVG(o.amount) AS avg_order_amount,
        MAX(o.order_date) AS last_order_date
    FROM high_value_customers hvc
    LEFT JOIN orders o ON hvc.customer_id = o.customer_id
    GROUP BY hvc.customer_id, hvc.name
),
customer_segments AS (
    -- æ­¥éª¤3ï¼šå®¢æˆ·åˆ†ç±»
    SELECT
        cos.*,
        CASE
            WHEN cos.avg_order_amount > 500 THEN 'VIP'
            WHEN cos.avg_order_amount > 200 THEN 'Regular'
            ELSE 'Standard'
        END AS segment
    FROM customer_order_stats cos
)
SELECT * FROM customer_segments
ORDER BY total_amount DESC;
```

### 2.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

#### 2.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | æ€§èƒ½ | å¯è¯»æ€§ | å¯ç»´æŠ¤æ€§ | æ¨èåº¦ |
| --- | --- | --- | --- | --- | --- |
| **CTE** | WITHå­å¥ | ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ é«˜ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ é«˜ | â­â­â­â­â­ |
| **å­æŸ¥è¯¢** | åµŒå¥—å­æŸ¥è¯¢ | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ ä½ | ğŸ”´ ä½ | â­â­ |
| **ä¸´æ—¶è¡¨** | CREATE TEMP TABLE | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ ä¸­ç­‰ | â­â­â­ |
| **è§†å›¾** | CREATE VIEW | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ç­‰ | â­â­â­ |

#### 2.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šåµŒå¥—å­æŸ¥è¯¢

```sql
-- æ–¹æ¡ˆ2ï¼šåµŒå¥—å­æŸ¥è¯¢ï¼ˆä¸æ¨èï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'customers') THEN
            RAISE WARNING 'è¡¨ customers ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒåµŒå¥—å­æŸ¥è¯¢';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒåµŒå¥—å­æŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒåµŒå¥—å­æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼ˆå¯¹æ¯”ç”¨ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    cos.customer_id,
    cos.name,
    cos.order_count,
    cos.total_amount,
    cos.avg_order_amount,
    CASE
        WHEN cos.avg_order_amount > 500 THEN 'VIP'
        WHEN cos.avg_order_amount > 200 THEN 'Regular'
        ELSE 'Standard'
    END AS segment
FROM (
    SELECT
        hvc.customer_id,
        hvc.name,
        COUNT(o.order_id) AS order_count,
        SUM(o.amount) AS total_amount,
        AVG(o.amount) AS avg_order_amount
    FROM (
        SELECT customer_id, name
        FROM customers
        WHERE total_spent > 10000
    ) hvc
    LEFT JOIN orders o ON hvc.customer_id = o.customer_id
    GROUP BY hvc.customer_id, hvc.name
) cos
ORDER BY cos.total_amount DESC;

-- é—®é¢˜ï¼š
-- 1. åµŒå¥—å±‚æ¬¡æ·±ï¼Œå¯è¯»æ€§å·®
-- 2. éš¾ä»¥ç»´æŠ¤
-- 3. æ€§èƒ½å¯èƒ½è¾ƒå·®ï¼ˆå–å†³äºä¼˜åŒ–å™¨ï¼‰
```

### 2.4 æ€§èƒ½è®ºè¯

#### 2.4.1 æ€§èƒ½æµ‹è¯•

```sql
-- æ€§èƒ½å¯¹æ¯”ï¼š100ä¸‡å®¢æˆ·ï¼Œ1000ä¸‡è®¢å•

-- CTEæ–¹æ¡ˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH high_value_customers AS (
    SELECT customer_id, name FROM customers WHERE total_spent > 10000
),
customer_order_stats AS (
    SELECT
        hvc.customer_id,
        COUNT(o.order_id) AS order_count,
        SUM(o.amount) AS total_amount
    FROM high_value_customers hvc
    LEFT JOIN orders o ON hvc.customer_id = o.customer_id
    GROUP BY hvc.customer_id
)
SELECT * FROM customer_order_stats;
-- æ‰§è¡Œæ—¶é—´ï¼š450ms
-- è§„åˆ’æ—¶é—´ï¼š3ms

-- åµŒå¥—å­æŸ¥è¯¢æ–¹æ¡ˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    customer_id,
    COUNT(order_id) AS order_count,
    SUM(amount) AS total_amount
FROM (
    SELECT c.customer_id, o.order_id, o.amount
    FROM (SELECT customer_id FROM customers WHERE total_spent > 10000) c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
) sub
GROUP BY customer_id;
-- æ‰§è¡Œæ—¶é—´ï¼š520ms
-- è§„åˆ’æ—¶é—´ï¼š5ms
```

**æ€§èƒ½ä¼˜åŠ¿**: CTEæ–¹æ¡ˆæ¯”åµŒå¥—å­æŸ¥è¯¢å¿«çº¦15%ï¼Œä¸”ä»£ç æ›´æ¸…æ™°ã€‚

---

## 3. é€’å½’CTEåº”ç”¨åœºæ™¯

### 3.1 åœºæ™¯æè¿°

#### 3.1.1 ä¸šåŠ¡éœ€æ±‚

```text
åœºæ™¯ï¼šç»„ç»‡æ¶æ„å±‚æ¬¡æŸ¥è¯¢
éœ€æ±‚ï¼š
1. æŸ¥è¯¢æ•´ä¸ªç»„ç»‡æ¶æ„æ ‘
2. è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°
3. è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„
4. æŸ¥æ‰¾ç‰¹å®šèŠ‚ç‚¹çš„æ‰€æœ‰ä¸‹çº§

æ•°æ®é‡ï¼š10ä¸‡ç»„ç»‡èŠ‚ç‚¹
æŸ¥è¯¢é¢‘ç‡ï¼šå®æ—¶æŸ¥è¯¢
```

### 3.2 é€’å½’CTEæ–¹æ¡ˆ

#### 3.2.1 é€’å½’CTEå®ç°

```sql
-- é€’å½’CTEæ–¹æ¡ˆï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'organizations') THEN
            RAISE WARNING 'è¡¨ organizations ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œé€’å½’CTEæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œé€’å½’CTEæŸ¥è¯¢æ€§èƒ½æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH RECURSIVE org_hierarchy AS (
    -- é”šç‚¹ï¼šæ ¹èŠ‚ç‚¹
    SELECT
        org_id,
        parent_id,
        name,
        level,
        1 AS depth,
        ARRAY[org_id] AS path,
        name AS path_names
    FROM organizations
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’ï¼šå­èŠ‚ç‚¹
    SELECT
        o.org_id,
        o.parent_id,
        o.name,
        o.level,
        oh.depth + 1,
        oh.path || o.org_id,
        oh.path_names || ' > ' || o.name
    FROM organizations o
    JOIN org_hierarchy oh ON o.parent_id = oh.org_id
)
SELECT
    org_id,
    name,
    depth,
    path,
    path_names,
    (
        SELECT COUNT(*)
        FROM org_hierarchy oh2
        WHERE oh2.path @> ARRAY[oh.org_id]
          AND oh2.depth > oh.depth
    ) AS subtree_size
FROM org_hierarchy oh
ORDER BY path;
```

### 3.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

#### 3.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨æ·±åº¦ | æ¨èåº¦ |
| --- | --- | --- | --- | --- | --- |
| **é€’å½’CTE** | WITH RECURSIVE | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ç®€å• | ğŸŸ¢ æ·±å±‚æ¬¡ | â­â­â­â­â­ |
| **åº”ç”¨å±‚é€’å½’** | ç¨‹åºå¾ªç¯ | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ å¤æ‚ | ğŸŸ¡ ä¸­ç­‰ | â­â­ |
| **ç‰©åŒ–è·¯å¾„** | é¢„è®¡ç®—è·¯å¾„ | ğŸŸ¢ğŸŸ¢ æä¼˜ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä»»æ„ | â­â­â­â­ |
| **é—­åŒ…è¡¨** | å…³ç³»è¡¨ | ğŸŸ¢ ä¼˜ç§€ | ğŸ”´ å¤æ‚ | ğŸŸ¢ ä»»æ„ | â­â­â­ |

---

## 4. JSON/JSONBåº”ç”¨åœºæ™¯

### 4.1 åœºæ™¯æè¿°

#### 4.1.1 ä¸šåŠ¡éœ€æ±‚

```text
åœºæ™¯ï¼šçµæ´»çš„ç”¨æˆ·é…ç½®å­˜å‚¨
éœ€æ±‚ï¼š
1. å­˜å‚¨ç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®ï¼ˆå­—æ®µåŠ¨æ€ï¼‰
2. æ”¯æŒé…ç½®çš„å¿«é€ŸæŸ¥è¯¢
3. æ”¯æŒé…ç½®çš„å±€éƒ¨æ›´æ–°
4. æ”¯æŒé…ç½®çš„ç‰ˆæœ¬ç®¡ç†

æ•°æ®é‡ï¼š1000ä¸‡ç”¨æˆ·
æŸ¥è¯¢é¢‘ç‡ï¼šé«˜é¢‘æŸ¥è¯¢
```

### 4.2 JSON/JSONBæ–¹æ¡ˆ

#### 4.2.1 JSONBå®ç°

```sql
-- JSONBæ–¹æ¡ˆï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profiles') THEN
            DROP TABLE user_profiles CASCADE;
            RAISE NOTICE 'è¡¨ user_profiles å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE user_profiles (
            user_id INTEGER PRIMARY KEY,
            profile_data JSONB NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ user_profiles åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ user_profiles å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profiles') THEN
            RAISE EXCEPTION 'è¡¨ user_profiles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'user_profiles' AND indexname = 'idx_user_profiles_gin') THEN
            RAISE WARNING 'ç´¢å¼• idx_user_profiles_gin å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_user_profiles_gin ON user_profiles USING GIN (profile_data);
            RAISE NOTICE 'GINç´¢å¼• idx_user_profiles_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ user_profiles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_user_profiles_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ’å…¥æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profiles') THEN
            RAISE EXCEPTION 'è¡¨ user_profiles ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
        END IF;

        INSERT INTO user_profiles (user_id, profile_data)
        VALUES (1, '{
            "preferences": {
                "theme": "dark",
        "language": "zh-CN",
        "notifications": {
            "email": true,
            "sms": false
        }
    },
    "settings": {
        "page_size": 20,
        "auto_save": true
    }
}'::JSONB);

-- æŸ¥è¯¢
SELECT
    user_id,
    profile_data->'preferences'->>'theme' AS theme,
    profile_data->'preferences'->'notifications'->>'email' AS email_notification,
    profile_data->'settings'->>'page_size' AS page_size
FROM user_profiles
WHERE profile_data @> '{"preferences": {"theme": "dark"}}'::JSONB;

-- æ›´æ–°ï¼ˆå±€éƒ¨æ›´æ–°ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_updated_rows INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profiles') THEN
            RAISE WARNING 'è¡¨ user_profiles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œæ›´æ–°';
            RETURN;
        END IF;

        UPDATE user_profiles
        SET profile_data = jsonb_set(
            profile_data,
            '{preferences,theme}',
            '"light"'
        )
        WHERE user_id = 1;

        GET DIAGNOSTICS v_updated_rows = ROW_COUNT;
        
        IF v_updated_rows = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°user_id=1çš„è®°å½•';
        ELSE
            RAISE NOTICE 'JSONBå±€éƒ¨æ›´æ–°æˆåŠŸï¼Œæ›´æ–°äº† % è¡Œ', v_updated_rows;
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ user_profiles ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ›´æ–°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 4.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

#### 4.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | æ€§èƒ½ | çµæ´»æ€§ | æŸ¥è¯¢èƒ½åŠ› | æ¨èåº¦ |
| --- | --- | --- | --- | --- | --- |
| **JSONB** | JSONBç±»å‹+GINç´¢å¼• | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æé«˜ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ å¼º | â­â­â­â­â­ |
| **JSON** | JSONç±»å‹ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æé«˜ | ğŸŸ¡ ä¸­ç­‰ | â­â­â­ |
| **EAVæ¨¡å‹** | é”®å€¼å¯¹è¡¨ | ğŸ”´ è¾ƒå·® | ğŸŸ¢ é«˜ | ğŸ”´ å¼± | â­â­ |
| **å®½è¡¨** | å¤šåˆ—è®¾è®¡ | ğŸŸ¢ ä¼˜ç§€ | ğŸ”´ ä½ | ğŸŸ¢ å¼º | â­â­ |

#### 4.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šEAVæ¨¡å‹

```sql
-- æ–¹æ¡ˆ2ï¼šEAVæ¨¡å‹ï¼ˆä¸æ¨èï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profile_attributes') THEN
            DROP TABLE user_profile_attributes CASCADE;
            RAISE NOTICE 'è¡¨ user_profile_attributes å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE user_profile_attributes (
            user_id INTEGER,
            attribute_name TEXT,
            attribute_value TEXT,
            PRIMARY KEY (user_id, attribute_name)
        );
        RAISE NOTICE 'è¡¨ user_profile_attributes åˆ›å»ºæˆåŠŸï¼ˆEAVæ¨¡å‹ç¤ºä¾‹ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ user_profile_attributes å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢ï¼ˆæ€§èƒ½å·®ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_profile_attributes') THEN
            RAISE WARNING 'è¡¨ user_profile_attributes ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡ŒEAVæ¨¡å‹æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼ˆå¯¹æ¯”ç”¨ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    user_id,
    MAX(CASE WHEN attribute_name = 'theme' THEN attribute_value END) AS theme,
    MAX(CASE WHEN attribute_name = 'language' THEN attribute_value END) AS language
FROM user_profile_attributes
WHERE user_id = 1
GROUP BY user_id;

-- é—®é¢˜ï¼š
-- 1. éœ€è¦å¤šè¡Œå­˜å‚¨ä¸€ä¸ªå¯¹è±¡çš„å±æ€§
-- 2. æŸ¥è¯¢éœ€è¦GROUP BYï¼Œæ€§èƒ½å·®
-- 3. ç±»å‹æ£€æŸ¥å›°éš¾
-- 4. ç´¢å¼•æ•ˆç‡ä½
```

### 4.4 æ€§èƒ½è®ºè¯

#### 4.4.1 æ€§èƒ½æµ‹è¯•

```sql
-- æ€§èƒ½å¯¹æ¯”ï¼š1000ä¸‡ç”¨æˆ·é…ç½®

-- JSONBæ–¹æ¡ˆï¼ˆå¸¦GINç´¢å¼•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT user_id, profile_data->'preferences'->>'theme'
FROM user_profiles
WHERE profile_data @> '{"preferences": {"theme": "dark"}}'::JSONB;
-- æ‰§è¡Œæ—¶é—´ï¼š25msï¼ˆä½¿ç”¨GINç´¢å¼•ï¼‰
-- ç´¢å¼•æ‰«æï¼šBitmap Index Scan

-- EAVæ–¹æ¡ˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT user_id
FROM user_profile_attributes
WHERE attribute_name = 'theme' AND attribute_value = 'dark';
-- æ‰§è¡Œæ—¶é—´ï¼š150ms
-- ç´¢å¼•æ‰«æï¼šIndex Scan
```

**æ€§èƒ½ä¼˜åŠ¿**: JSONBæ–¹æ¡ˆæ¯”EAVæ¨¡å‹å¿«çº¦6å€ï¼Œä¸”æ›´çµæ´»ã€‚

---

## 5. æ•°ç»„åº”ç”¨åœºæ™¯

### 5.1 åœºæ™¯æè¿°

#### ä¸šåŠ¡éœ€æ±‚

```text
åœºæ™¯ï¼šæ ‡ç­¾ç³»ç»Ÿ
éœ€æ±‚ï¼š
1. ä¸ºæ–‡ç« å­˜å‚¨å¤šä¸ªæ ‡ç­¾
2. æŸ¥è¯¢åŒ…å«ç‰¹å®šæ ‡ç­¾çš„æ–‡ç« 
3. ç»Ÿè®¡æ ‡ç­¾ä½¿ç”¨é¢‘ç‡
4. æŸ¥æ‰¾ç›¸ä¼¼æ ‡ç­¾çš„æ–‡ç« 

æ•°æ®é‡ï¼š100ä¸‡æ–‡ç« ï¼Œæ¯ä¸ªæ–‡ç« å¹³å‡5ä¸ªæ ‡ç­¾
æŸ¥è¯¢é¢‘ç‡ï¼šé«˜é¢‘æŸ¥è¯¢
```

### 5.2 æ•°ç»„æ–¹æ¡ˆ

#### 5.2.1 æ•°ç»„å®ç°

```sql
-- æ•°ç»„æ–¹æ¡ˆï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            DROP TABLE articles CASCADE;
            RAISE NOTICE 'è¡¨ articles å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤';
        END IF;

        CREATE TABLE articles (
            article_id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT,
            tags TEXT[] NOT NULL,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨ articles åˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ articles å¤±è´¥: %', SQLERRM;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'articles' AND indexname = 'idx_articles_tags_gin') THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tags_gin å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_articles_tags_gin ON articles USING GIN (tags);
            RAISE NOTICE 'GINç´¢å¼• idx_articles_tags_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_articles_tags_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æ’å…¥æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE EXCEPTION 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ’å…¥æ•°æ®';
        END IF;

        INSERT INTO articles (title, tags)
        VALUES
            ('PostgreSQL Guide', ARRAY['database', 'sql', 'postgresql']),
            ('SQL Tutorial', ARRAY['sql', 'database', 'tutorial']);
        RAISE NOTICE 'æ–‡ç« æ•°æ®æ’å…¥æˆåŠŸ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ’å…¥æ–‡ç« æ•°æ®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢åŒ…å«ç‰¹å®šæ ‡ç­¾çš„æ–‡ç« ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE WARNING 'è¡¨ articles ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæ•°ç»„æŸ¥è¯¢æ€§èƒ½æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT article_id, title, tags
FROM articles
WHERE 'sql' = ANY(tags);  -- æˆ–ä½¿ç”¨ @> æ“ä½œç¬¦
-- WHERE tags @> ARRAY['sql'];

-- æŸ¥è¯¢åŒ…å«å¤šä¸ªæ ‡ç­¾çš„æ–‡ç« 
SELECT article_id, title, tags
FROM articles
WHERE tags @> ARRAY['sql', 'database'];

-- ç»Ÿè®¡æ ‡ç­¾ä½¿ç”¨é¢‘ç‡
SELECT
    unnest(tags) AS tag,
    COUNT(*) AS frequency
FROM articles
GROUP BY unnest(tags)
ORDER BY frequency DESC;

-- æŸ¥æ‰¾ç›¸ä¼¼æ ‡ç­¾çš„æ–‡ç« ï¼ˆJaccardç›¸ä¼¼åº¦ï¼‰
WITH article_tags AS (
    SELECT article_id, tags
    FROM articles
    WHERE article_id = 1
)
SELECT
    a.article_id,
    a.title,
    a.tags,
    (
        SELECT COUNT(*)
        FROM unnest(a.tags) AS tag
        WHERE tag = ANY(at.tags)
    )::FLOAT /
    GREATEST(
        array_length(a.tags, 1),
        array_length(at.tags, 1)
    ) AS similarity
FROM articles a, article_tags at
WHERE a.article_id != at.article_id
ORDER BY similarity DESC
LIMIT 10;
```

### 5.3 æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

#### 5.3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | æ€§èƒ½ | å­˜å‚¨æ•ˆç‡ | æŸ¥è¯¢èƒ½åŠ› | æ¨èåº¦ |
| --- | --- | --- | --- | --- | --- |
| **æ•°ç»„+GINç´¢å¼•** | TEXT[] | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ é«˜ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ å¼º | â­â­â­â­â­ |
| **å…³è”è¡¨** | å¤šå¯¹å¤šå…³ç³» | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ ä½ | ğŸŸ¢ å¼º | â­â­â­ |
| **JSONBæ•°ç»„** | JSONBç±»å‹ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å¼º | â­â­â­â­ |
| **æ–‡æœ¬å­˜å‚¨** | TEXT | ğŸ”´ è¾ƒå·® | ğŸŸ¢ é«˜ | ğŸ”´ å¼± | â­ |

#### 5.3.2 æ›¿ä»£æ–¹æ¡ˆï¼šå…³è”è¡¨

```sql
-- æ–¹æ¡ˆ2ï¼šå…³è”è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') THEN
            RAISE NOTICE 'è¡¨ articles å·²å­˜åœ¨';
        ELSE
            CREATE TABLE articles (
                article_id SERIAL PRIMARY KEY,
                title TEXT NOT NULL,
                content TEXT
            );
            RAISE NOTICE 'è¡¨ articles åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tags') THEN
            RAISE NOTICE 'è¡¨ tags å·²å­˜åœ¨';
        ELSE
            CREATE TABLE tags (
                tag_id SERIAL PRIMARY KEY,
                tag_name TEXT UNIQUE NOT NULL
            );
            RAISE NOTICE 'è¡¨ tags åˆ›å»ºæˆåŠŸ';
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'article_tags') THEN
            RAISE NOTICE 'è¡¨ article_tags å·²å­˜åœ¨';
        ELSE
            CREATE TABLE article_tags (
                article_id INTEGER REFERENCES articles(article_id),
                tag_id INTEGER REFERENCES tags(tag_id),
                PRIMARY KEY (article_id, tag_id)
            );
            RAISE NOTICE 'è¡¨ article_tags åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå…³è”è¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢ï¼ˆéœ€è¦JOINï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tags') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'article_tags') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒJOINæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œå…³è”è¡¨JOINæŸ¥è¯¢';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT a.article_id, a.title
FROM articles a
JOIN article_tags at ON a.article_id = at.article_id
JOIN tags t ON at.tag_id = t.tag_id
WHERE t.tag_name = 'sql';

-- é—®é¢˜ï¼š
-- 1. éœ€è¦å¤šä¸ªè¡¨å’Œå¤šè¡¨JOIN
-- 2. å­˜å‚¨å¼€é”€å¤§ï¼ˆæ¯å¯¹å…³ç³»ä¸€è¡Œï¼‰
-- 3. æŸ¥è¯¢æ€§èƒ½å—JOINå½±å“
```

### 5.4 æ€§èƒ½è®ºè¯

#### æ€§èƒ½æµ‹è¯•

```sql
-- æ€§èƒ½å¯¹æ¯”ï¼š100ä¸‡æ–‡ç« ï¼Œå¹³å‡5ä¸ªæ ‡ç­¾

-- æ•°ç»„æ–¹æ¡ˆï¼ˆGINç´¢å¼•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT article_id, title
FROM articles
WHERE tags @> ARRAY['sql'];
-- æ‰§è¡Œæ—¶é—´ï¼š12ms
-- ç´¢å¼•æ‰«æï¼šBitmap Index Scan on idx_articles_tags_gin

-- å…³è”è¡¨æ–¹æ¡ˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT DISTINCT a.article_id, a.title
FROM articles a
JOIN article_tags at ON a.article_id = at.article_id
JOIN tags t ON at.tag_id = t.tag_id
WHERE t.tag_name = 'sql';
-- æ‰§è¡Œæ—¶é—´ï¼š85ms
-- ç´¢å¼•æ‰«æï¼šNested Loop + Hash Join
```

**æ€§èƒ½ä¼˜åŠ¿**: æ•°ç»„æ–¹æ¡ˆæ¯”å…³è”è¡¨æ–¹æ¡ˆå¿«çº¦7å€ï¼Œä¸”å­˜å‚¨æ›´é«˜æ•ˆã€‚

---

## 6. ç‰¹æ€§ç»„åˆåº”ç”¨

### 6.1 çª—å£å‡½æ•°+CTE

#### ç»„åˆåº”ç”¨ç¤ºä¾‹

```sql
-- åœºæ™¯ï¼šè®¡ç®—æ¯ä¸ªéƒ¨é—¨çš„Top 3å‘˜å·¥åŠå…¶è–ªèµ„ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ‰§è¡Œçª—å£å‡½æ•°+CTEç»„åˆæŸ¥è¯¢æ€§èƒ½æµ‹è¯•';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH department_stats AS (
    -- CTEï¼šè®¡ç®—éƒ¨é—¨ç»Ÿè®¡
    SELECT
        department_id,
        COUNT(*) AS employee_count,
        AVG(salary) AS avg_salary
    FROM employees
    GROUP BY department_id
),
ranked_employees AS (
    -- çª—å£å‡½æ•°ï¼šæ’å
    SELECT
        e.employee_id,
        e.department_id,
        e.name,
        e.salary,
        ROW_NUMBER() OVER (
            PARTITION BY e.department_id
            ORDER BY e.salary DESC
        ) AS rank_in_dept
    FROM employees e
)
SELECT
    re.employee_id,
    re.name,
    re.department_id,
    re.salary,
    re.rank_in_dept,
    ds.employee_count,
    ds.avg_salary,
    re.salary - ds.avg_salary AS diff_from_avg
FROM ranked_employees re
JOIN department_stats ds ON re.department_id = ds.department_id
WHERE re.rank_in_dept <= 3
ORDER BY re.department_id, re.rank_in_dept;
```

---

## ğŸ“š å‚è€ƒèµ„æº

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£**: <https://www.postgresql.org/docs/current/queries-with.html>
2. **JSON/JSONBæ–‡æ¡£**: <https://www.postgresql.org/docs/current/datatype-json.html>
3. **æ•°ç»„æ–‡æ¡£**: <https://www.postgresql.org/docs/current/arrays.html>

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.0** (2025-01): å®Œæ•´åº”ç”¨åœºæ™¯åˆ†æä¸è®ºè¯æŒ‡å—
  - è¡¥å……CTEåº”ç”¨åœºæ™¯å®Œæ•´è®ºè¯
  - è¡¥å……é€’å½’CTEåº”ç”¨åœºæ™¯å®Œæ•´è®ºè¯
  - è¡¥å……JSON/JSONBåº”ç”¨åœºæ™¯å®Œæ•´è®ºè¯
  - è¡¥å……æ•°ç»„åº”ç”¨åœºæ™¯å®Œæ•´è®ºè¯
  - è¡¥å……ç‰¹æ€§ç»„åˆåº”ç”¨
  - æ·»åŠ æ€ç»´å¯¼å›¾ã€å¯¹æ¯”çŸ©é˜µã€å†³ç­–æµç¨‹å›¾

---

**çŠ¶æ€**: âœ… **æ–‡æ¡£å®Œæˆ** | [è¿”å›ç›®å½•](./README.md)
