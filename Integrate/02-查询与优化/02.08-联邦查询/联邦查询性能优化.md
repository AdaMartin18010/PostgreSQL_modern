# PostgreSQL联邦查询性能优化指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL联邦查询性能优化指南](#postgresql联邦查询性能优化指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 查询下推优化](#2-查询下推优化)
    - [2.1 启用查询下推](#21-启用查询下推)
    - [2.2 下推优化](#22-下推优化)
  - [3. 批量操作优化](#3-批量操作优化)
    - [3.1 批量导入](#31-批量导入)
    - [3.2 批量更新](#32-批量更新)
  - [4. 连接优化](#4-连接优化)
    - [4.1 连接池](#41-连接池)
    - [4.2 连接管理](#42-连接管理)
  - [5. 缓存策略](#5-缓存策略)
    - [5.1 物化视图](#51-物化视图)
    - [5.2 本地缓存](#52-本地缓存)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

联邦查询性能优化是提高跨数据源查询效率的关键。

**优化策略**:

- 查询下推
- 批量操作
- 连接优化
- 缓存策略

---

## 2. 查询下推优化

### 2.1 启用查询下推

```sql
-- 启用远程估算
ALTER FOREIGN TABLE foreign_table
OPTIONS (ADD use_remote_estimate 'true');

-- 启用WHERE下推
ALTER FOREIGN TABLE foreign_table
OPTIONS (ADD fetch_size '100');
```

### 2.2 下推优化

```sql
-- 优化前：全表传输
SELECT * FROM foreign_table;

-- 优化后：WHERE下推
SELECT * FROM foreign_table WHERE id > 1000;
-- 查询在远程执行，只返回结果
```

---

## 3. 批量操作优化

### 3.1 批量导入

```sql
-- 批量导入
INSERT INTO local_table
SELECT * FROM foreign_table
WHERE created_at > CURRENT_DATE - INTERVAL '7 days';

-- 使用COPY加速
COPY (SELECT * FROM foreign_table) TO '/tmp/data.csv';
COPY local_table FROM '/tmp/data.csv';
```

### 3.2 批量更新

```sql
-- 批量更新
UPDATE local_table l
SET status = f.status
FROM foreign_table f
WHERE l.id = f.id;
```

---

## 4. 连接优化

### 4.1 连接池

```text
使用PgBouncer或连接池
- 减少连接开销
- 提高连接复用
- 降低延迟
```

### 4.2 连接管理

```sql
-- 查看外部连接
SELECT * FROM pg_foreign_server;

-- 监控连接状态
SELECT * FROM pg_stat_activity
WHERE application_name LIKE '%fdw%';
```

---

## 5. 缓存策略

### 5.1 物化视图

```sql
-- 创建物化视图
CREATE MATERIALIZED VIEW mv_foreign_data AS
SELECT * FROM foreign_table;

-- 定期刷新
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_foreign_data;
```

### 5.2 本地缓存

```sql
-- 创建本地缓存表
CREATE TABLE cache_foreign_data AS
SELECT * FROM foreign_table;

-- 定期更新
TRUNCATE cache_foreign_data;
INSERT INTO cache_foreign_data
SELECT * FROM foreign_table;
```

---

## 📚 相关文档

- [FDW完整指南.md](./FDW完整指南.md) - FDW完整指南
- [多数据源查询.md](./多数据源查询.md) - 多数据源查询详解
- [02-查询与优化/README.md](../README.md) - 查询与优化主题

---

**最后更新**: 2025年1月
