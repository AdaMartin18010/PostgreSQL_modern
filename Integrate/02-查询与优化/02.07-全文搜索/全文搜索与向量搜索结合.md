# å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+, pgvector 0.7+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ](#å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ··åˆæœç´¢æ¶æ„](#2-æ··åˆæœç´¢æ¶æ„)
    - [2.1 æ•°æ®æ¨¡å‹](#21-æ•°æ®æ¨¡å‹)
    - [2.2 æ•°æ®å‡†å¤‡](#22-æ•°æ®å‡†å¤‡)
  - [3. å®ç°æ–¹æ¡ˆ](#3-å®ç°æ–¹æ¡ˆ)
    - [3.1 æ··åˆæœç´¢æŸ¥è¯¢](#31-æ··åˆæœç´¢æŸ¥è¯¢)
    - [3.2 åŠ æƒæ··åˆæœç´¢](#32-åŠ æƒæ··åˆæœç´¢)
    - [3.3 ä½¿ç”¨ç¤ºä¾‹](#33-ä½¿ç”¨ç¤ºä¾‹)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢å„æœ‰ä¼˜åŠ¿ï¼š

- **å…¨æ–‡æœç´¢** - ç²¾ç¡®åŒ¹é…ã€å…³é”®è¯æœç´¢ã€è¯­ä¹‰ç†è§£æœ‰é™
- **å‘é‡æœç´¢** - è¯­ä¹‰ç›¸ä¼¼åº¦ã€è¯­ä¹‰ç†è§£ã€éœ€è¦å‘é‡åŒ–

ç»“åˆä¸¤è€…å¯ä»¥å®ç°ï¼š

- **æ··åˆæœç´¢** - åŒæ—¶ä½¿ç”¨å…³é”®è¯å’Œè¯­ä¹‰æœç´¢
- **ç›¸å…³æ€§æ’åº** - ç»¼åˆå…³é”®è¯åŒ¹é…å’Œè¯­ä¹‰ç›¸ä¼¼åº¦
- **æ›´å‡†ç¡®çš„æœç´¢** - ç»“åˆç²¾ç¡®åŒ¹é…å’Œè¯­ä¹‰ç†è§£

---

## 2. æ··åˆæœç´¢æ¶æ„

### 2.1 æ•°æ®æ¨¡å‹

```sql
-- åˆ›å»ºæ”¯æŒå…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢çš„è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    tsv TSVECTOR,              -- å…¨æ–‡æœç´¢å‘é‡
    embedding VECTOR(1536),    -- å‘é‡åµŒå…¥ï¼ˆOpenAI ada-002ï¼‰
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX documents_tsv_idx ON documents USING GIN (tsv);

-- åˆ›å»ºå‘é‡æœç´¢ç´¢å¼•
CREATE INDEX documents_embedding_idx ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

### 2.2 æ•°æ®å‡†å¤‡

```sql
-- è‡ªåŠ¨ç”Ÿæˆtsvector
CREATE OR REPLACE FUNCTION documents_tsv_trigger()
RETURNS TRIGGER AS $$
BEGIN
    NEW.tsv := to_tsvector('english',
        coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, '')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER documents_tsv_update
BEFORE INSERT OR UPDATE ON documents
FOR EACH ROW
EXECUTE FUNCTION documents_tsv_trigger();

-- embeddingéœ€è¦å¤–éƒ¨ç”Ÿæˆï¼ˆä½¿ç”¨OpenAI APIç­‰ï¼‰
-- è¿™é‡Œå‡è®¾å·²ç»ç”Ÿæˆ
```

---

## 3. å®ç°æ–¹æ¡ˆ

### 3.1 æ··åˆæœç´¢æŸ¥è¯¢

```sql
-- æ–¹æ¡ˆ1ï¼šåˆ†åˆ«æŸ¥è¯¢ååˆå¹¶
WITH fulltext_results AS (
    SELECT
        id,
        title,
        content,
        ts_rank(tsv, query) AS fulltext_rank
    FROM documents,
         to_tsquery('english', 'postgresql & database') query
    WHERE tsv @@ query
    LIMIT 50
),
vector_results AS (
    SELECT
        id,
        title,
        content,
        1 - (embedding <=> query_embedding) AS vector_similarity
    FROM documents,
         (SELECT embedding AS query_embedding FROM documents WHERE id = 1) q
    ORDER BY embedding <=> query_embedding
    LIMIT 50
)
SELECT
    COALESCE(f.id, v.id) AS id,
    COALESCE(f.title, v.title) AS title,
    COALESCE(f.content, v.content) AS content,
    COALESCE(f.fulltext_rank, 0) AS fulltext_rank,
    COALESCE(v.vector_similarity, 0) AS vector_similarity,
    (COALESCE(f.fulltext_rank, 0) * 0.4 + COALESCE(v.vector_similarity, 0) * 0.6) AS combined_score
FROM fulltext_results f
FULL OUTER JOIN vector_results v ON f.id = v.id
ORDER BY combined_score DESC
LIMIT 20;
```

### 3.2 åŠ æƒæ··åˆæœç´¢

```sql
-- æ–¹æ¡ˆ2ï¼šåŠ æƒç»„åˆ
CREATE OR REPLACE FUNCTION hybrid_search(
    query_text TEXT,
    query_embedding VECTOR(1536),
    fulltext_weight FLOAT DEFAULT 0.4,
    vector_weight FLOAT DEFAULT 0.6
)
RETURNS TABLE (
    id INT,
    title TEXT,
    content TEXT,
    fulltext_rank FLOAT,
    vector_similarity FLOAT,
    combined_score FLOAT
) AS $$
BEGIN
    RETURN QUERY
    WITH fulltext_matches AS (
        SELECT
            d.id,
            d.title,
            d.content,
            ts_rank(d.tsv, to_tsquery('english', query_text)) AS rank
        FROM documents d
        WHERE d.tsv @@ to_tsquery('english', query_text)
    ),
    vector_matches AS (
        SELECT
            d.id,
            d.title,
            d.content,
            1 - (d.embedding <=> query_embedding) AS similarity
        FROM documents d
        ORDER BY d.embedding <=> query_embedding
        LIMIT 100
    )
    SELECT
        COALESCE(f.id, v.id),
        COALESCE(f.title, v.title),
        COALESCE(f.content, v.content),
        COALESCE(f.rank, 0),
        COALESCE(v.similarity, 0),
        (COALESCE(f.rank, 0) * fulltext_weight + COALESCE(v.similarity, 0) * vector_weight) AS score
    FROM fulltext_matches f
    FULL OUTER JOIN vector_matches v ON f.id = v.id
    ORDER BY score DESC
    LIMIT 20;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 ä½¿ç”¨ç¤ºä¾‹

```sql
-- ä½¿ç”¨æ··åˆæœç´¢å‡½æ•°
SELECT * FROM hybrid_search(
    'postgresql database',
    (SELECT embedding FROM documents WHERE id = 1),
    0.4,  -- å…¨æ–‡æœç´¢æƒé‡
    0.6   -- å‘é‡æœç´¢æƒé‡
);
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX documents_tsv_idx ON documents USING GIN (tsv);

-- å‘é‡æœç´¢ç´¢å¼•ï¼ˆIVFFlatï¼‰
CREATE INDEX documents_embedding_idx ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- å¯¹äºå¤§è¡¨ï¼Œè€ƒè™‘ä½¿ç”¨HNSWç´¢å¼•ï¼ˆPostgreSQL 17+ï¼‰
-- CREATE INDEX documents_embedding_hnsw_idx ON documents
-- USING hnsw (embedding vector_cosine_ops);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨LIMITå‡å°‘è®¡ç®—é‡
WITH fulltext_results AS (
    SELECT id, title, content, ts_rank(tsv, query) AS rank
    FROM documents, to_tsquery('english', 'postgresql') query
    WHERE tsv @@ query
    ORDER BY rank DESC
    LIMIT 50  -- é™åˆ¶ç»“æœæ•°é‡
),
vector_results AS (
    SELECT id, title, content, 1 - (embedding <=> query_embedding) AS similarity
    FROM documents
    ORDER BY embedding <=> query_embedding
    LIMIT 50  -- é™åˆ¶ç»“æœæ•°é‡
)
-- åˆå¹¶ç»“æœ...
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **åˆç†è®¾ç½®æƒé‡** - æ ¹æ®åœºæ™¯è°ƒæ•´å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢çš„æƒé‡
2. **ä½¿ç”¨ç´¢å¼•** - ä¸ºå…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢éƒ½åˆ›å»ºç´¢å¼•
3. **é™åˆ¶ç»“æœæ•°é‡** - åœ¨åˆå¹¶å‰é™åˆ¶æ¯ä¸ªæœç´¢çš„ç»“æœæ•°é‡
4. **ç¼“å­˜æŸ¥è¯¢ç»“æœ** - å¯¹äºå¸¸è§æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜
5. **ç›‘æ§æ€§èƒ½** - è·Ÿè¸ªæ··åˆæœç´¢çš„æ€§èƒ½

### âŒ é¿å…åšæ³•

1. **æƒé‡è®¾ç½®ä¸å½“** - éœ€è¦æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´
2. **ä¸ä½¿ç”¨ç´¢å¼•** - æ€§èƒ½ä¼šæå·®
3. **è¿”å›è¿‡å¤šç»“æœ** - å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
4. **å¿½ç•¥æ€§èƒ½ä¼˜åŒ–** - æ··åˆæœç´¢å¯èƒ½è¾ƒæ…¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md](./PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md) - å…¨æ–‡æœç´¢å®Œæ•´æŒ‡å—
- [å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–.md](./å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–.md) - æ€§èƒ½ä¼˜åŒ–æŒ‡å—
- [10-AIä¸æœºå™¨å­¦ä¹ /../../10-AIä¸æœºå™¨å­¦ä¹ /README.md) - pgvectorå‘é‡æœç´¢

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
