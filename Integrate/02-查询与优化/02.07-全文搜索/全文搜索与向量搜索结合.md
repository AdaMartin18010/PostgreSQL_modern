# å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+, pgvector 0.7+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ](#å…¨æ–‡æœç´¢ä¸å‘é‡æœç´¢ç»“åˆ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ··åˆæœç´¢æ¶æ„](#2-æ··åˆæœç´¢æ¶æ„)
    - [2.1 æ•°æ®æ¨¡å‹](#21-æ•°æ®æ¨¡å‹)
    - [2.2 æ•°æ®å‡†å¤‡](#22-æ•°æ®å‡†å¤‡)
  - [3. å®ç°æ–¹æ¡ˆ](#3-å®ç°æ–¹æ¡ˆ)
    - [3.1 æ··åˆæœç´¢æŸ¥è¯¢](#31-æ··åˆæœç´¢æŸ¥è¯¢)
    - [3.2 åŠ æƒæ··åˆæœç´¢](#32-åŠ æƒæ··åˆæœç´¢)
    - [3.3 ä½¿ç”¨ç¤ºä¾‹](#33-ä½¿ç”¨ç¤ºä¾‹)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âŒ é¿å…åšæ³•](#-é¿å…åšæ³•)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢å„æœ‰ä¼˜åŠ¿ï¼š

- **å…¨æ–‡æœç´¢** - ç²¾ç¡®åŒ¹é…ã€å…³é”®è¯æœç´¢ã€è¯­ä¹‰ç†è§£æœ‰é™
- **å‘é‡æœç´¢** - è¯­ä¹‰ç›¸ä¼¼åº¦ã€è¯­ä¹‰ç†è§£ã€éœ€è¦å‘é‡åŒ–

ç»“åˆä¸¤è€…å¯ä»¥å®ç°ï¼š

- **æ··åˆæœç´¢** - åŒæ—¶ä½¿ç”¨å…³é”®è¯å’Œè¯­ä¹‰æœç´¢
- **ç›¸å…³æ€§æ’åº** - ç»¼åˆå…³é”®è¯åŒ¹é…å’Œè¯­ä¹‰ç›¸ä¼¼åº¦
- **æ›´å‡†ç¡®çš„æœç´¢** - ç»“åˆç²¾ç¡®åŒ¹é…å’Œè¯­ä¹‰ç†è§£

---

## 2. æ··åˆæœç´¢æ¶æ„

### 2.1 æ•°æ®æ¨¡å‹

**åˆ›å»ºæ··åˆæœç´¢è¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- åˆ›å»ºæ”¯æŒå…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢çš„è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥pgvectoræ‰©å±•æ˜¯å¦å®‰è£…
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    END IF;

    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: documents';
    ELSE
        CREATE TABLE documents (
            id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            tsv TSVECTOR,              -- å…¨æ–‡æœç´¢å‘é‡
            embedding VECTOR(1536),    -- å‘é‡åµŒå…¥ï¼ˆOpenAI ada-002ï¼‰
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        RAISE NOTICE 'è¡¨åˆ›å»ºæˆåŠŸ: documents';
    END IF;
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: documents';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'documents_tsv_idx'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_tsv_idx';
    ELSE
        CREATE INDEX documents_tsv_idx ON documents USING GIN (tsv);
        RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ: documents_tsv_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_tsv_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå‘é‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'documents_embedding_idx'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_idx';
    ELSE
        CREATE INDEX documents_embedding_idx ON documents
        USING ivfflat (embedding vector_cosine_ops)
        WITH (lists = 100);
        RAISE NOTICE 'å‘é‡æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ: documents_embedding_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå‘é‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM documents
WHERE tsv @@ to_tsquery('english', 'postgresql')
ORDER BY embedding <=> (SELECT embedding FROM documents LIMIT 1)
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Limit -> Sort -> Bitmap Heap Scan (å…¨æ–‡) + Index Scan (å‘é‡)
```

### 2.2 æ•°æ®å‡†å¤‡

**åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- è‡ªåŠ¨ç”Ÿæˆtsvectorï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION documents_tsv_trigger()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æŸ¥æ–‡æœ¬æœç´¢é…ç½®æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM pg_ts_config WHERE cfgname = 'english') THEN
        RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½®ä¸å­˜åœ¨: english';
    END IF;

    -- ç”Ÿæˆtsvector
    NEW.tsv := to_tsvector('english',
        coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, '')
    );

    RETURN NEW;
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½®ä¸å­˜åœ¨: english';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç”Ÿæˆtsvectorå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'documents_tsv_trigger') THEN
        RAISE EXCEPTION 'è§¦å‘å™¨å‡½æ•°ä¸å­˜åœ¨: documents_tsv_trigger';
    END IF;

    -- åˆ é™¤ç°æœ‰è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    IF EXISTS (
        SELECT 1 FROM pg_trigger WHERE tgname = 'documents_tsv_update'
    ) THEN
        DROP TRIGGER documents_tsv_update ON documents;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§¦å‘å™¨: documents_tsv_update';
    END IF;

    -- åˆ›å»ºè§¦å‘å™¨
    CREATE TRIGGER documents_tsv_update
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW
    EXECUTE FUNCTION documents_tsv_trigger();

    RAISE NOTICE 'è§¦å‘å™¨åˆ›å»ºæˆåŠŸ: documents_tsv_update';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'è§¦å‘å™¨å‡½æ•°ä¸å­˜åœ¨: documents_tsv_trigger';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§¦å‘å™¨å¤±è´¥: %', SQLERRM;
END $$;

-- æ³¨æ„ï¼šembeddingéœ€è¦å¤–éƒ¨ç”Ÿæˆï¼ˆä½¿ç”¨OpenAI APIç­‰ï¼‰
-- è¿™é‡Œå‡è®¾å·²ç»ç”Ÿæˆ
```

---

## 3. å®ç°æ–¹æ¡ˆ

### 3.1 æ··åˆæœç´¢æŸ¥è¯¢

**æ··åˆæœç´¢æŸ¥è¯¢ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**:

```sql
-- æ–¹æ¡ˆ1ï¼šåˆ†åˆ«æŸ¥è¯¢ååˆå¹¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM (
        WITH fulltext_results AS (
            SELECT
                id,
                title,
                content,
                ts_rank(tsv, query) AS fulltext_rank
            FROM documents,
                 to_tsquery('english', 'postgresql & database') query
            WHERE tsv @@ query
            LIMIT 50
        ),
        vector_results AS (
            SELECT
                id,
                title,
                content,
                1 - (embedding <=> query_embedding) AS vector_similarity
            FROM documents,
                 (SELECT embedding AS query_embedding FROM documents WHERE id = 1 LIMIT 1) q
            ORDER BY embedding <=> query_embedding
            LIMIT 50
        )
        SELECT COALESCE(f.id, v.id) AS id
        FROM fulltext_results f
        FULL OUTER JOIN vector_results v ON f.id = v.id
        ORDER BY (COALESCE(f.fulltext_rank, 0) * 0.4 + COALESCE(v.vector_similarity, 0) * 0.6) DESC
        LIMIT 20
    ) subquery;

    RAISE NOTICE 'æ··åˆæœç´¢æŸ¥è¯¢æˆåŠŸ: æ‰¾åˆ° % æ¡ç»“æœ', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ··åˆæœç´¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šåˆ†åˆ«æŸ¥è¯¢ååˆå¹¶
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH fulltext_results AS (
    SELECT
        id,
        title,
        content,
        ts_rank(tsv, query) AS fulltext_rank
    FROM documents,
         to_tsquery('english', 'postgresql & database') query
    WHERE tsv @@ query
    LIMIT 50
),
vector_results AS (
    SELECT
        id,
        title,
        content,
        1 - (embedding <=> query_embedding) AS vector_similarity
    FROM documents,
         (SELECT embedding AS query_embedding FROM documents WHERE id = 1 LIMIT 1) q
    ORDER BY embedding <=> query_embedding
    LIMIT 50
)
SELECT
    COALESCE(f.id, v.id) AS id,
    COALESCE(f.title, v.title) AS title,
    COALESCE(f.content, v.content) AS content,
    COALESCE(f.fulltext_rank, 0) AS fulltext_rank,
    COALESCE(v.vector_similarity, 0) AS vector_similarity,
    (COALESCE(f.fulltext_rank, 0) * 0.4 + COALESCE(v.vector_similarity, 0) * 0.6) AS combined_score
FROM fulltext_results f
FULL OUTER JOIN vector_results v ON f.id = v.id
ORDER BY combined_score DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Limit -> Sort -> Full Join -> Limit -> Sort -> Index Scan
```

### 3.2 åŠ æƒæ··åˆæœç´¢

**åˆ›å»ºæ··åˆæœç´¢å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- æ–¹æ¡ˆ2ï¼šåŠ æƒç»„åˆï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION hybrid_search(
    query_text TEXT,
    query_embedding VECTOR(1536),
    fulltext_weight FLOAT DEFAULT 0.4,
    vector_weight FLOAT DEFAULT 0.6
)
RETURNS TABLE (
    id INT,
    title TEXT,
    content TEXT,
    fulltext_rank FLOAT,
    vector_similarity FLOAT,
    combined_score FLOAT
) AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF query_text IS NULL OR TRIM(query_text) = '' THEN
        RAISE EXCEPTION 'æŸ¥è¯¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
    END IF;

    IF query_embedding IS NULL THEN
        RAISE EXCEPTION 'æŸ¥è¯¢å‘é‡ä¸èƒ½ä¸ºNULL';
    END IF;

    IF fulltext_weight < 0 OR fulltext_weight > 1 THEN
        RAISE EXCEPTION 'å…¨æ–‡æœç´¢æƒé‡å¿…é¡»åœ¨0-1ä¹‹é—´';
    END IF;

    IF vector_weight < 0 OR vector_weight > 1 THEN
        RAISE EXCEPTION 'å‘é‡æœç´¢æƒé‡å¿…é¡»åœ¨0-1ä¹‹é—´';
    END IF;

    IF ABS(fulltext_weight + vector_weight - 1.0) > 0.01 THEN
        RAISE WARNING 'æƒé‡æ€»å’Œä¸ä¸º1ï¼Œå°†è‡ªåŠ¨å½’ä¸€åŒ–';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    RETURN QUERY
    WITH fulltext_matches AS (
        SELECT
            d.id,
            d.title,
            d.content,
            ts_rank(d.tsv, to_tsquery('english', query_text)) AS rank
        FROM documents d
        WHERE d.tsv @@ to_tsquery('english', query_text)
    ),
    vector_matches AS (
        SELECT
            d.id,
            d.title,
            d.content,
            1 - (d.embedding <=> query_embedding) AS similarity
        FROM documents d
        ORDER BY d.embedding <=> query_embedding
        LIMIT 100
    )
    SELECT
        COALESCE(f.id, v.id),
        COALESCE(f.title, v.title),
        COALESCE(f.content, v.content),
        COALESCE(f.rank, 0),
        COALESCE(v.similarity, 0),
        (COALESCE(f.rank, 0) * fulltext_weight + COALESCE(v.similarity, 0) * vector_weight) AS score
    FROM fulltext_matches f
    FULL OUTER JOIN vector_matches v ON f.id = v.id
    ORDER BY score DESC
    LIMIT 20;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'æ–‡æœ¬æœç´¢é…ç½®ä¸å­˜åœ¨: english';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ··åˆæœç´¢å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 ä½¿ç”¨ç¤ºä¾‹

**ä½¿ç”¨æ··åˆæœç´¢å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**:

```sql
-- ä½¿ç”¨æ··åˆæœç´¢å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM documents WHERE id = 1) THEN
        RAISE EXCEPTION 'æ–‡æ¡£ä¸å­˜åœ¨: id=1';
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM hybrid_search(
        'postgresql database',
        (SELECT embedding FROM documents WHERE id = 1),
        0.4,  -- å…¨æ–‡æœç´¢æƒé‡
        0.6   -- å‘é‡æœç´¢æƒé‡
    );

    RAISE NOTICE 'æ··åˆæœç´¢æˆåŠŸ: æ‰¾åˆ° % æ¡ç»“æœ', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN no_data_found THEN
        RAISE EXCEPTION 'æ–‡æ¡£ä¸å­˜åœ¨: id=1';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ··åˆæœç´¢å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæ··åˆæœç´¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM hybrid_search(
    'postgresql database',
    (SELECT embedding FROM documents WHERE id = 1),
    0.4,
    0.6
);
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Limit -> Sort -> Full Outer Join -> CTE Scan
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'documents_tsv_idx'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_tsv_idx';
    ELSE
        CREATE INDEX documents_tsv_idx ON documents USING GIN (tsv);
        RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ: documents_tsv_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_tsv_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- å‘é‡æœç´¢ç´¢å¼•ï¼ˆIVFFlatï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'documents_embedding_idx'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_idx';
    ELSE
        CREATE INDEX documents_embedding_idx ON documents
        USING ivfflat (embedding vector_cosine_ops)
        WITH (lists = 100);
        RAISE NOTICE 'å‘é‡æœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ: documents_embedding_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå‘é‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- å¯¹äºå¤§è¡¨ï¼Œè€ƒè™‘ä½¿ç”¨HNSWç´¢å¼•ï¼ˆPostgreSQL 17+ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    -- æ£€æŸ¥PostgreSQLç‰ˆæœ¬
    IF current_setting('server_version_num')::INT < 170000 THEN
        RAISE EXCEPTION 'HNSWç´¢å¼•éœ€è¦PostgreSQL 17+';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'vector') THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'documents' AND indexname = 'documents_embedding_hnsw_idx'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_hnsw_idx';
    ELSE
        CREATE INDEX documents_embedding_hnsw_idx ON documents
        USING hnsw (embedding vector_cosine_ops);
        RAISE NOTICE 'HNSWç´¢å¼•åˆ›å»ºæˆåŠŸ: documents_embedding_hnsw_idx';
    END IF;
EXCEPTION
    WHEN feature_not_supported THEN
        RAISE WARNING 'HNSWç´¢å¼•éœ€è¦PostgreSQL 17+å’Œpgvector 0.7+';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•æœªå®‰è£…';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: documents_embedding_hnsw_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºHNSWç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰**:

```sql
-- ä½¿ç”¨LIMITå‡å°‘è®¡ç®—é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    fulltext_count BIGINT;
    vector_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'documents') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    END IF;

    -- å…¨æ–‡æœç´¢ç»“æœæ•°
    SELECT COUNT(*) INTO fulltext_count
    FROM (
        SELECT id, title, content, ts_rank(tsv, query) AS rank
        FROM documents, to_tsquery('english', 'postgresql') query
        WHERE tsv @@ query
        ORDER BY rank DESC
        LIMIT 50
    ) subquery;

    -- å‘é‡æœç´¢ç»“æœæ•°
    SELECT COUNT(*) INTO vector_count
    FROM (
        SELECT id, title, content, 1 - (embedding <=> (SELECT embedding FROM documents LIMIT 1)) AS similarity
        FROM documents
        ORDER BY embedding <=> (SELECT embedding FROM documents LIMIT 1)
        LIMIT 50
    ) subquery;

    RAISE NOTICE 'å…¨æ–‡æœç´¢ç»“æœæ•°: %, å‘é‡æœç´¢ç»“æœæ•°: %', fulltext_count, vector_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: documents';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢ä¼˜åŒ–éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šä½¿ç”¨LIMITä¼˜åŒ–
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH fulltext_results AS (
    SELECT id, title, content, ts_rank(tsv, query) AS rank
    FROM documents, to_tsquery('english', 'postgresql') query
    WHERE tsv @@ query
    ORDER BY rank DESC
    LIMIT 50  -- é™åˆ¶ç»“æœæ•°é‡
),
vector_results AS (
    SELECT id, title, content, 1 - (embedding <=> (SELECT embedding FROM documents LIMIT 1)) AS similarity
    FROM documents
    ORDER BY embedding <=> (SELECT embedding FROM documents LIMIT 1)
    LIMIT 50  -- é™åˆ¶ç»“æœæ•°é‡
)
SELECT * FROM fulltext_results
UNION ALL
SELECT * FROM vector_results;
-- æ‰§è¡Œæ—¶é—´: ä½¿ç”¨LIMITåæ€§èƒ½æ˜¾è‘—æå‡
-- è®¡åˆ’: Append -> Limit -> Sort -> Bitmap Heap Scan / Index Scan
```

---

## 5. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **åˆç†è®¾ç½®æƒé‡** - æ ¹æ®åœºæ™¯è°ƒæ•´å…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢çš„æƒé‡
2. **ä½¿ç”¨ç´¢å¼•** - ä¸ºå…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢éƒ½åˆ›å»ºç´¢å¼•
3. **é™åˆ¶ç»“æœæ•°é‡** - åœ¨åˆå¹¶å‰é™åˆ¶æ¯ä¸ªæœç´¢çš„ç»“æœæ•°é‡
4. **ç¼“å­˜æŸ¥è¯¢ç»“æœ** - å¯¹äºå¸¸è§æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜
5. **ç›‘æ§æ€§èƒ½** - è·Ÿè¸ªæ··åˆæœç´¢çš„æ€§èƒ½

### âŒ é¿å…åšæ³•

1. **æƒé‡è®¾ç½®ä¸å½“** - éœ€è¦æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´
2. **ä¸ä½¿ç”¨ç´¢å¼•** - æ€§èƒ½ä¼šæå·®
3. **è¿”å›è¿‡å¤šç»“æœ** - å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
4. **å¿½ç•¥æ€§èƒ½ä¼˜åŒ–** - æ··åˆæœç´¢å¯èƒ½è¾ƒæ…¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md](./PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md) - å…¨æ–‡æœç´¢å®Œæ•´æŒ‡å—
- [å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–.md](./å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–.md) - æ€§èƒ½ä¼˜åŒ–æŒ‡å—
- [10-AIä¸æœºå™¨å­¦ä¹ /../../10-AIä¸æœºå™¨å­¦ä¹ /README.md) - pgvectorå‘é‡æœç´¢

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
