# 多语言全文搜索

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [多语言全文搜索](#多语言全文搜索)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 语言检测](#2-语言检测)
    - [2.1 简单语言检测](#21-简单语言检测)
    - [2.2 使用语言检测](#22-使用语言检测)
  - [3. 多语言配置](#3-多语言配置)
    - [3.1 创建多语言配置](#31-创建多语言配置)
    - [3.2 存储语言信息](#32-存储语言信息)
  - [4. 混合语言搜索](#4-混合语言搜索)
    - [4.1 多语言搜索](#41-多语言搜索)
    - [4.2 按语言过滤搜索](#42-按语言过滤搜索)
    - [4.3 组合搜索](#43-组合搜索)
  - [5. 最佳实践](#5-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

多语言全文搜索支持在同一个系统中搜索多种语言的文档。PostgreSQL支持：

- **内置语言** - 英语、中文、日语、韩语等
- **自定义配置** - 创建自定义文本搜索配置
- **语言检测** - 自动检测文档语言
- **混合搜索** - 同时搜索多种语言

---

## 2. 语言检测

### 2.1 简单语言检测

```sql
-- 检测是否包含中文字符
CREATE OR REPLACE FUNCTION detect_language(text TEXT)
RETURNS regconfig AS $$
BEGIN
    -- 检测中文
    IF text ~ '[\u4e00-\u9fa5]' THEN
        RETURN 'chinese'::regconfig;
    -- 检测日文
    ELSIF text ~ '[\u3040-\u309F\u30A0-\u30FF]' THEN
        RETURN 'japanese'::regconfig;
    -- 检测韩文
    ELSIF text ~ '[\uAC00-\uD7A3]' THEN
        RETURN 'korean'::regconfig;
    -- 默认英语
    ELSE
        RETURN 'english'::regconfig;
    END IF;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### 2.2 使用语言检测

```sql
-- 创建表
CREATE TABLE multilingual_articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    tsv TSVECTOR
);

-- 自动检测语言并生成tsvector
CREATE OR REPLACE FUNCTION multilingual_tsv_trigger()
RETURNS TRIGGER AS $$
BEGIN
    NEW.tsv := to_tsvector(
        detect_language(coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, '')),
        coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, '')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER multilingual_tsv_update
BEFORE INSERT OR UPDATE ON multilingual_articles
FOR EACH ROW
EXECUTE FUNCTION multilingual_tsv_trigger();
```

---

## 3. 多语言配置

### 3.1 创建多语言配置

```sql
-- 安装中文分词扩展
CREATE EXTENSION IF NOT EXISTS zhparser;

-- 创建中文配置
CREATE TEXT SEARCH CONFIGURATION chinese (PARSER = zhparser);
ALTER TEXT SEARCH CONFIGURATION chinese
    ADD MAPPING FOR n,v,a,i,e,l WITH simple;

-- 创建日文配置（如果可用）
-- CREATE TEXT SEARCH CONFIGURATION japanese (PARSER = japanese_parser);

-- 创建韩文配置（如果可用）
-- CREATE TEXT SEARCH CONFIGURATION korean (PARSER = korean_parser);
```

### 3.2 存储语言信息

```sql
-- 添加语言列
ALTER TABLE multilingual_articles
ADD COLUMN language TEXT DEFAULT 'auto';

-- 自动检测并存储语言
CREATE OR REPLACE FUNCTION detect_and_store_language()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.language = 'auto' THEN
        IF NEW.content ~ '[\u4e00-\u9fa5]' THEN
            NEW.language := 'chinese';
        ELSIF NEW.content ~ '[\u3040-\u309F\u30A0-\u30FF]' THEN
            NEW.language := 'japanese';
        ELSIF NEW.content ~ '[\uAC00-\uD7A3]' THEN
            NEW.language := 'korean';
        ELSE
            NEW.language := 'english';
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER detect_language_trigger
BEFORE INSERT OR UPDATE ON multilingual_articles
FOR EACH ROW
EXECUTE FUNCTION detect_and_store_language();
```

---

## 4. 混合语言搜索

### 4.1 多语言搜索

```sql
-- 搜索多种语言
SELECT
    id,
    title,
    content,
    language,
    ts_rank(tsv, query) AS rank
FROM multilingual_articles,
     to_tsquery('english', 'database | 数据库 | データベース') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

### 4.2 按语言过滤搜索

```sql
-- 只搜索特定语言
SELECT
    id,
    title,
    content
FROM multilingual_articles
WHERE language = 'chinese'
  AND tsv @@ to_tsquery('chinese', '数据库');
```

### 4.3 组合搜索

```sql
-- 组合多种语言的查询
WITH english_query AS (
    SELECT to_tsquery('english', 'database') AS q
),
chinese_query AS (
    SELECT to_tsquery('chinese', '数据库') AS q
)
SELECT
    id,
    title,
    content,
    language,
    CASE
        WHEN language = 'english' THEN ts_rank(tsv, (SELECT q FROM english_query))
        WHEN language = 'chinese' THEN ts_rank(tsv, (SELECT q FROM chinese_query))
        ELSE 0
    END AS rank
FROM multilingual_articles
WHERE (language = 'english' AND tsv @@ (SELECT q FROM english_query))
   OR (language = 'chinese' AND tsv @@ (SELECT q FROM chinese_query))
ORDER BY rank DESC;
```

---

## 5. 最佳实践

### ✅ 推荐做法

1. **自动检测语言** - 使用语言检测函数
2. **存储语言信息** - 便于按语言过滤
3. **使用合适的配置** - 为每种语言使用专门的配置
4. **优化索引** - 为多语言数据创建合适的索引
5. **提供语言选择** - 允许用户选择搜索语言

### ❌ 避免做法

1. **忽略语言差异** - 不同语言需要不同处理
2. **不存储语言信息** - 影响搜索性能
3. **使用错误的配置** - 影响搜索准确性
4. **不优化查询** - 多语言搜索可能较慢

---

## 📚 相关文档

- [PostgreSQL18-全文搜索深度实战.md](./PostgreSQL18-全文搜索深度实战.md) - 全文搜索完整指南
- [中文全文搜索指南.md](./中文全文搜索指南.md) - 中文全文搜索指南
- [全文搜索性能优化.md](./全文搜索性能优化.md) - 性能优化指南

---

**最后更新**: 2025年1月
