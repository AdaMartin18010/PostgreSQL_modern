# å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–](#å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. GIN vs GiSTç´¢å¼•](#2-gin-vs-gistç´¢å¼•)
  - [3. GINç´¢å¼•ä¼˜åŒ–](#3-ginç´¢å¼•ä¼˜åŒ–)
  - [4. åˆ†åŒºè¡¨ä¼˜åŒ–](#4-åˆ†åŒºè¡¨ä¼˜åŒ–)
  - [5. æŸ¥è¯¢ä¼˜åŒ–](#5-æŸ¥è¯¢ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

---

## 1. æ¦‚è¿°

å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜åŒ–æ˜¯æå‡æœç´¢æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š

- **ç´¢å¼•é€‰æ‹©** - GIN vs GiST
- **ç´¢å¼•ä¼˜åŒ–** - ç´¢å¼•å‚æ•°è°ƒä¼˜
- **æŸ¥è¯¢ä¼˜åŒ–** - æŸ¥è¯¢è¯­å¥ä¼˜åŒ–
- **åˆ†åŒºä¼˜åŒ–** - å¤§è¡¨åˆ†åŒºç­–ç•¥

---

## 2. GIN vs GiSTç´¢å¼•

### 2.1 ç´¢å¼•å¯¹æ¯”

| ç‰¹æ€§ | GINç´¢å¼• | GiSTç´¢å¼• |
|------|---------|----------|
| **æŸ¥è¯¢é€Ÿåº¦** | å¿« | ä¸­ç­‰ |
| **ç´¢å¼•å¤§å°** | å¤§ | å° |
| **æ›´æ–°é€Ÿåº¦** | æ…¢ | å¿« |
| **é€‚ç”¨åœºæ™¯** | æŸ¥è¯¢é¢‘ç¹ã€æ›´æ–°å°‘ | æ›´æ–°é¢‘ç¹ã€æŸ¥è¯¢ä¸­ç­‰ |

### 2.2 é€‰æ‹©å»ºè®®

- **GINç´¢å¼•** - æ¨èç”¨äºå¤§å¤šæ•°å…¨æ–‡æœç´¢åœºæ™¯
  - æŸ¥è¯¢æ€§èƒ½ä¼˜ç§€
  - é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯
  - ç´¢å¼•æ„å»ºè¾ƒæ…¢ä½†æŸ¥è¯¢å¿«

- **GiSTç´¢å¼•** - é€‚åˆæ›´æ–°é¢‘ç¹çš„åœºæ™¯
  - ç´¢å¼•æ„å»ºå¿«
  - æ›´æ–°æ€§èƒ½å¥½
  - æŸ¥è¯¢æ€§èƒ½ä¸­ç­‰

---

## 3. GINç´¢å¼•ä¼˜åŒ–

### 3.1 ç´¢å¼•å‚æ•°

```sql
-- åˆ›å»ºGINç´¢å¼•ï¼ˆé»˜è®¤å‚æ•°ï¼‰
CREATE INDEX articles_tsv_idx ON articles USING GIN (tsv);

-- ä½¿ç”¨fastupdateå‚æ•°ï¼ˆPostgreSQL 9.5+ï¼‰
-- fastupdate=off: ç«‹å³æ›´æ–°ç´¢å¼•ï¼ˆæŸ¥è¯¢å¿«ï¼Œæ›´æ–°æ…¢ï¼‰
-- fastupdate=on: å»¶è¿Ÿæ›´æ–°ç´¢å¼•ï¼ˆæ›´æ–°å¿«ï¼ŒæŸ¥è¯¢å¯èƒ½ç¨æ…¢ï¼‰
CREATE INDEX articles_tsv_idx ON articles
USING GIN (tsv) WITH (fastupdate=on);

-- ä½¿ç”¨gin_pending_list_limitå‚æ•°
-- æ§åˆ¶pending listçš„å¤§å°
CREATE INDEX articles_tsv_idx ON articles
USING GIN (tsv) WITH (
    fastupdate=on,
    gin_pending_list_limit=4096
);
```

### 3.2 ç´¢å¼•ç»´æŠ¤

```sql
-- å®šæœŸç»´æŠ¤GINç´¢å¼•
-- åˆå¹¶pending liståˆ°ä¸»ç´¢å¼•
VACUUM articles;

-- é‡å»ºç´¢å¼•ï¼ˆå¦‚æœç´¢å¼•è†¨èƒ€ä¸¥é‡ï¼‰
REINDEX INDEX articles_tsv_idx;
```

---

## 4. åˆ†åŒºè¡¨ä¼˜åŒ–

### 4.1 åˆ†åŒºç­–ç•¥

å¯¹äºå¤§è¡¨ï¼Œå¯ä»¥è€ƒè™‘æŒ‰æ—¶é—´æˆ–ç±»åˆ«åˆ†åŒºï¼š

```sql
-- æŒ‰æ—¶é—´åˆ†åŒº
CREATE TABLE articles (
    id BIGSERIAL,
    title TEXT,
    content TEXT,
    tsv TSVECTOR,
    created_at TIMESTAMPTZ
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE articles_2024 PARTITION OF articles
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- åœ¨æ¯ä¸ªåˆ†åŒºä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX articles_2024_tsv_idx ON articles_2024 USING GIN (tsv);
```

### 4.2 åˆ†åŒºè£å‰ª

```sql
-- æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿›è¡Œåˆ†åŒºè£å‰ª
EXPLAIN (ANALYZE)
SELECT * FROM articles
WHERE tsv @@ to_tsquery('postgresql')
  AND created_at >= '2024-01-01'
  AND created_at < '2025-01-01';
-- åªæ‰«æarticles_2024åˆ†åŒº
```

---

## 5. æŸ¥è¯¢ä¼˜åŒ–

### 5.1 é¢„è®¡ç®—tsvector

```sql
-- âŒ ä¸æ¨èï¼šæŸ¥è¯¢æ—¶è®¡ç®—
SELECT * FROM articles
WHERE to_tsvector('english', content) @@ to_tsquery('english', 'postgresql');

-- âœ… æ¨èï¼šä½¿ç”¨é¢„è®¡ç®—çš„tsvector
SELECT * FROM articles
WHERE tsv @@ to_tsquery('english', 'postgresql');
```

### 5.2 ä½¿ç”¨LIMIT

```sql
-- ä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°é‡
SELECT * FROM articles
WHERE tsv @@ to_tsquery('english', 'postgresql')
ORDER BY ts_rank(tsv, query) DESC
LIMIT 20;
```

### 5.3 é¿å…å¤æ‚æŸ¥è¯¢

```sql
-- âŒ é¿å…ï¼šè¿‡äºå¤æ‚çš„æŸ¥è¯¢è¡¨è¾¾å¼
SELECT * FROM articles
WHERE tsv @@ to_tsquery('english', 'a & b & c & d & e & f');

-- âœ… æ¨èï¼šç®€åŒ–æŸ¥è¯¢è¡¨è¾¾å¼
SELECT * FROM articles
WHERE tsv @@ to_tsquery('english', 'a & b & c');
```

---

## 6. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨GINç´¢å¼•** - å¤§å¤šæ•°åœºæ™¯ä¸‹æ€§èƒ½æœ€å¥½
2. **é¢„è®¡ç®—tsvector** - é¿å…æŸ¥è¯¢æ—¶è®¡ç®—
3. **åˆç†ä½¿ç”¨fastupdate** - æ ¹æ®æ›´æ–°é¢‘ç‡é€‰æ‹©
4. **å®šæœŸç»´æŠ¤ç´¢å¼•** - VACUUMå’ŒREINDEX
5. **ä½¿ç”¨åˆ†åŒºè¡¨** - å¯¹äºå¤§è¡¨è€ƒè™‘åˆ†åŒº

### âŒ é¿å…åšæ³•

1. **æŸ¥è¯¢æ—¶è®¡ç®—tsvector** - æ€§èƒ½å·®
2. **å¿½ç•¥ç´¢å¼•ç»´æŠ¤** - ç´¢å¼•è†¨èƒ€å½±å“æ€§èƒ½
3. **è¿‡åº¦å¤æ‚çš„æŸ¥è¯¢** - å½±å“æŸ¥è¯¢æ€§èƒ½
4. **ä¸ä½¿ç”¨LIMIT** - è¿”å›è¿‡å¤šç»“æœå½±å“æ€§èƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md](./PostgreSQL18-å…¨æ–‡æœç´¢æ·±åº¦å®æˆ˜.md) - å…¨æ–‡æœç´¢å®Œæ•´æŒ‡å—
- [02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.06-æ€§èƒ½è°ƒä¼˜/](../02.06-æ€§èƒ½è°ƒä¼˜/README.md) - æ€§èƒ½è°ƒä¼˜æŒ‡å—

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
