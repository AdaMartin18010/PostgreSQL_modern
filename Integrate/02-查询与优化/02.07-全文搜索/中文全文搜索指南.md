# 中文全文搜索指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [中文全文搜索指南](#中文全文搜索指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 安装zhparser](#2-安装zhparser)
    - [2.1 系统要求](#21-系统要求)
    - [2.2 安装步骤](#22-安装步骤)
    - [2.3 验证安装](#23-验证安装)
  - [3. 配置中文分词](#3-配置中文分词)
    - [3.1 创建中文文本搜索配置](#31-创建中文文本搜索配置)
    - [3.2 配置说明](#32-配置说明)
  - [4. 中文搜索示例](#4-中文搜索示例)
    - [4.1 基础搜索](#41-基础搜索)
    - [4.2 自动更新tsvector](#42-自动更新tsvector)
    - [4.3 相关性排序](#43-相关性排序)
  - [5. 性能优化](#5-性能优化)
    - [5.1 索引优化](#51-索引优化)
    - [5.2 查询优化](#52-查询优化)
  - [6. 最佳实践](#6-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

PostgreSQL默认的全文搜索主要针对英文等语言，对于中文需要安装专门的分词扩展。常用的中文分词扩展包括：

- **zhparser** - 基于jieba的中文分词
- **pg_jieba** - 另一个jieba分词扩展
- **scws** - 基于SCWS的中文分词

本文档以zhparser为例，介绍中文全文搜索的配置和使用。

---

## 2. 安装zhparser

### 2.1 系统要求

- PostgreSQL 12+
- 编译工具（gcc、make等）

### 2.2 安装步骤

```bash
# 1. 下载zhparser
git clone https://github.com/amutu/zhparser.git
cd zhparser

# 2. 编译安装
make && sudo make install

# 3. 在数据库中创建扩展
psql -d your_database -c "CREATE EXTENSION zhparser;"
```

### 2.3 验证安装

```sql
-- 检查扩展是否安装成功
SELECT * FROM pg_extension WHERE extname = 'zhparser';

-- 测试中文分词
SELECT to_tsvector('zhparser', 'PostgreSQL是一个强大的开源数据库');
```

---

## 3. 配置中文分词

### 3.1 创建中文文本搜索配置

```sql
-- 创建中文文本搜索配置
CREATE TEXT SEARCH CONFIGURATION chinese_zh (PARSER = zhparser);

-- 添加中文词典映射
ALTER TEXT SEARCH CONFIGURATION chinese_zh
    ADD MAPPING FOR n,v,a,i,e,l WITH simple;
```

### 3.2 配置说明

- **n**: 名词
- **v**: 动词
- **a**: 形容词
- **i**: 成语
- **e**: 叹词
- **l**: 习用语

---

## 4. 中文搜索示例

### 4.1 基础搜索

```sql
-- 创建测试表
CREATE TABLE articles_cn (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    tsv TSVECTOR
);

-- 创建索引
CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv);

-- 插入数据并生成tsvector
INSERT INTO articles_cn (title, content, tsv) VALUES
    ('PostgreSQL数据库', 'PostgreSQL是一个功能强大的开源数据库系统',
     to_tsvector('chinese_zh', 'PostgreSQL数据库 PostgreSQL是一个功能强大的开源数据库系统'));

-- 中文搜索
SELECT title, content
FROM articles_cn
WHERE tsv @@ to_tsquery('chinese_zh', '数据库');
```

### 4.2 自动更新tsvector

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION articles_cn_tsv_trigger()
RETURNS TRIGGER AS $$
BEGIN
    NEW.tsv := to_tsvector('chinese_zh',
        coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, ''));
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER articles_cn_tsv_update
BEFORE INSERT OR UPDATE ON articles_cn
FOR EACH ROW
EXECUTE FUNCTION articles_cn_tsv_trigger();
```

### 4.3 相关性排序

```sql
-- 使用ts_rank进行相关性排序
SELECT
    title,
    content,
    ts_rank(tsv, query) AS rank
FROM articles_cn,
     to_tsquery('chinese_zh', '数据库 & 开源') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

---

## 5. 性能优化

### 5.1 索引优化

```sql
-- 使用GIN索引（推荐）
CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv);

-- 对于大表，考虑使用部分索引
CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv)
WHERE tsv IS NOT NULL;
```

### 5.2 查询优化

```sql
-- 使用预计算的tsvector（推荐）
-- 在插入/更新时计算tsvector，而不是在查询时计算

-- 避免在WHERE子句中直接使用to_tsvector
-- ❌ 不推荐
SELECT * FROM articles_cn
WHERE to_tsvector('chinese_zh', content) @@ to_tsquery('chinese_zh', '数据库');

-- ✅ 推荐
SELECT * FROM articles_cn
WHERE tsv @@ to_tsquery('chinese_zh', '数据库');
```

---

## 6. 最佳实践

### ✅ 推荐做法

1. **预计算tsvector** - 在插入/更新时计算，避免查询时计算
2. **使用GIN索引** - 对于全文搜索，GIN索引性能更好
3. **合理配置分词器** - 根据实际需求调整词典映射
4. **定期维护索引** - 定期VACUUM和REINDEX

### ❌ 避免做法

1. **查询时计算tsvector** - 性能差，不推荐
2. **过度分词** - 分词过细会影响搜索准确性
3. **忽略索引维护** - 索引膨胀会影响性能

---

## 📚 相关文档

- [PostgreSQL18-全文搜索深度实战.md](./PostgreSQL18-全文搜索深度实战.md) - 全文搜索完整指南
- [02-查询与优化/README.md](../README.md) - 查询与优化主题

---

**最后更新**: 2025年1月
