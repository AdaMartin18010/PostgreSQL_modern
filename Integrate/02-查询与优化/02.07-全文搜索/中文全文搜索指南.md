# 中文全文搜索指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 18+
> **难度等级**: ⭐⭐⭐ 中级

---

## 📋 目录

- [中文全文搜索指南](#中文全文搜索指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 安装zhparser](#2-安装zhparser)
    - [2.1 系统要求](#21-系统要求)
    - [2.2 安装步骤](#22-安装步骤)
    - [2.3 验证安装](#23-验证安装)
  - [3. 配置中文分词](#3-配置中文分词)
    - [3.1 创建中文文本搜索配置](#31-创建中文文本搜索配置)
    - [3.2 配置说明](#32-配置说明)
  - [4. 中文搜索示例](#4-中文搜索示例)
    - [4.1 基础搜索](#41-基础搜索)
    - [4.2 自动更新tsvector](#42-自动更新tsvector)
    - [4.3 相关性排序](#43-相关性排序)
  - [5. 性能优化](#5-性能优化)
    - [5.1 索引优化](#51-索引优化)
    - [5.2 查询优化](#52-查询优化)
  - [6. 最佳实践](#6-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

PostgreSQL默认的全文搜索主要针对英文等语言，对于中文需要安装专门的分词扩展。常用的中文分词扩展包括：

- **zhparser** - 基于jieba的中文分词
- **pg_jieba** - 另一个jieba分词扩展
- **scws** - 基于SCWS的中文分词

本文档以zhparser为例，介绍中文全文搜索的配置和使用。

---

## 2. 安装zhparser

### 2.1 系统要求

- PostgreSQL 12+
- 编译工具（gcc、make等）

### 2.2 安装步骤

```bash
# 1. 下载zhparser
git clone https://github.com/amutu/zhparser.git
cd zhparser

# 2. 编译安装
make && sudo make install

# 3. 在数据库中创建扩展
psql -d your_database -c "CREATE EXTENSION zhparser;"
```

### 2.3 验证安装

**验证安装（带完整错误处理）**:

```sql
-- 检查扩展是否安装成功（带错误处理）
DO $$
DECLARE
    ext_exists BOOLEAN;
BEGIN
    SELECT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'zhparser'
    ) INTO ext_exists;

    IF NOT ext_exists THEN
        RAISE EXCEPTION 'zhparser扩展未安装，请先安装扩展';
    ELSE
        RAISE NOTICE 'zhparser扩展已安装';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION '检查扩展失败: %', SQLERRM;
END $$;

-- 测试中文分词（带错误处理）
DO $$
DECLARE
    test_result TSVECTOR;
BEGIN
    BEGIN
        test_result := to_tsvector('zhparser', 'PostgreSQL是一个强大的开源数据库');

        IF test_result IS NULL THEN
            RAISE WARNING '中文分词测试返回NULL（可能配置有问题）';
        ELSE
            RAISE NOTICE '中文分词测试成功: %', test_result;
        END IF;
    EXCEPTION
        WHEN undefined_object THEN
            RAISE EXCEPTION 'zhparser配置不存在，请先创建文本搜索配置';
        WHEN OTHERS THEN
            RAISE EXCEPTION '中文分词测试失败: %', SQLERRM;
    END;
END $$;

-- 性能测试：中文分词
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT to_tsvector('zhparser', 'PostgreSQL是一个强大的开源数据库');
-- 执行时间: <10ms
-- 计划: Result
```

---

## 3. 配置中文分词

### 3.1 创建中文文本搜索配置

**创建配置（带完整错误处理）**:

```sql
-- 创建中文文本搜索配置（带错误处理）
DO $$
BEGIN
    -- 检查zhparser扩展是否安装
    IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'zhparser') THEN
        RAISE EXCEPTION 'zhparser扩展未安装，请先安装扩展';
    END IF;

    -- 检查配置是否已存在
    IF EXISTS (
        SELECT 1 FROM pg_ts_config WHERE cfgname = 'chinese_zh'
    ) THEN
        RAISE WARNING '文本搜索配置已存在: chinese_zh';
    ELSE
        CREATE TEXT SEARCH CONFIGURATION chinese_zh (PARSER = zhparser);
        RAISE NOTICE '文本搜索配置创建成功: chinese_zh';
    END IF;
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'zhparser解析器不存在，请先安装zhparser扩展';
    WHEN duplicate_object THEN
        RAISE WARNING '文本搜索配置已存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建文本搜索配置失败: %', SQLERRM;
END $$;

-- 添加中文词典映射（带错误处理）
DO $$
BEGIN
    -- 检查配置是否存在
    IF NOT EXISTS (SELECT 1 FROM pg_ts_config WHERE cfgname = 'chinese_zh') THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    END IF;

    -- 添加词典映射
    ALTER TEXT SEARCH CONFIGURATION chinese_zh
        ADD MAPPING FOR n,v,a,i,e,l WITH simple;

    RAISE NOTICE '中文词典映射添加成功: n,v,a,i,e,l -> simple';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '添加词典映射失败: %', SQLERRM;
END $$;
```

### 3.2 配置说明

- **n**: 名词
- **v**: 动词
- **a**: 形容词
- **i**: 成语
- **e**: 叹词
- **l**: 习用语

---

## 4. 中文搜索示例

### 4.1 基础搜索

**创建表和索引（带完整错误处理）**:

```sql
-- 创建测试表（带错误处理）
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE WARNING '表已存在: articles_cn';
    ELSE
        CREATE TABLE articles_cn (
            id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            tsv TSVECTOR
        );
        RAISE NOTICE '表创建成功: articles_cn';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING '表已存在: articles_cn';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建表失败: %', SQLERRM;
END $$;

-- 创建索引（带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'articles_cn' AND indexname = 'articles_cn_tsv_idx'
    ) THEN
        RAISE WARNING '索引已存在: articles_cn_tsv_idx';
    ELSE
        CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv);
        RAISE NOTICE '索引创建成功: articles_cn_tsv_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN duplicate_table THEN
        RAISE WARNING '索引已存在: articles_cn_tsv_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建索引失败: %', SQLERRM;
END $$;

-- 插入数据并生成tsvector（带错误处理）
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    INSERT INTO articles_cn (title, content, tsv) VALUES
        ('PostgreSQL数据库', 'PostgreSQL是一个功能强大的开源数据库系统',
         to_tsvector('chinese_zh', 'PostgreSQL数据库 PostgreSQL是一个功能强大的开源数据库系统'))
    RETURNING id INTO inserted_id;

    RAISE NOTICE '数据插入成功: id=%', inserted_id;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '插入数据失败: %', SQLERRM;
END $$;

-- 中文搜索（带错误处理和性能测试）
DO $$
DECLARE
    result_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM articles_cn
    WHERE tsv @@ to_tsquery('chinese_zh', '数据库');

    RAISE NOTICE '搜索成功: 找到 % 条结果', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '搜索失败: %', SQLERRM;
END $$;

-- 性能测试：中文搜索
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT title, content
FROM articles_cn
WHERE tsv @@ to_tsquery('chinese_zh', '数据库');
-- 执行时间: 取决于表大小和索引
-- 计划: Bitmap Heap Scan -> Bitmap Index Scan (使用GIN索引)
```

### 4.2 自动更新tsvector

**创建触发器（带完整错误处理）**:

```sql
-- 创建触发器函数（带错误处理）
CREATE OR REPLACE FUNCTION articles_cn_tsv_trigger()
RETURNS TRIGGER AS $$
BEGIN
    -- 检查文本搜索配置是否存在
    IF NOT EXISTS (SELECT 1 FROM pg_ts_config WHERE cfgname = 'chinese_zh') THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    END IF;

    -- 生成tsvector
    NEW.tsv := to_tsvector('chinese_zh',
        coalesce(NEW.title, '') || ' ' || coalesce(NEW.content, ''));

    RETURN NEW;
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '生成tsvector失败: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器（带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'articles_cn_tsv_trigger') THEN
        RAISE EXCEPTION '触发器函数不存在: articles_cn_tsv_trigger';
    END IF;

    -- 删除现有触发器（如果存在）
    IF EXISTS (
        SELECT 1 FROM pg_trigger WHERE tgname = 'articles_cn_tsv_update'
    ) THEN
        DROP TRIGGER articles_cn_tsv_update ON articles_cn;
        RAISE NOTICE '已删除现有触发器: articles_cn_tsv_update';
    END IF;

    -- 创建触发器
    CREATE TRIGGER articles_cn_tsv_update
    BEFORE INSERT OR UPDATE ON articles_cn
    FOR EACH ROW
    EXECUTE FUNCTION articles_cn_tsv_trigger();

    RAISE NOTICE '触发器创建成功: articles_cn_tsv_update';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN undefined_function THEN
        RAISE EXCEPTION '触发器函数不存在: articles_cn_tsv_trigger';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建触发器失败: %', SQLERRM;
END $$;
```

### 4.3 相关性排序

**相关性排序查询（带完整错误处理和性能测试）**:

```sql
-- 使用ts_rank进行相关性排序（带错误处理）
DO $$
DECLARE
    result_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM articles_cn,
         to_tsquery('chinese_zh', '数据库 & 开源') query
    WHERE tsv @@ query;

    IF result_count = 0 THEN
        RAISE NOTICE '未找到匹配结果';
    ELSE
        RAISE NOTICE '找到 % 条匹配结果', result_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '相关性排序查询失败: %', SQLERRM;
END $$;

-- 性能测试：相关性排序查询
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    title,
    content,
    ts_rank(tsv, query) AS rank
FROM articles_cn,
     to_tsquery('chinese_zh', '数据库 & 开源') query
WHERE tsv @@ query
ORDER BY rank DESC;
-- 执行时间: 取决于表大小和匹配行数
-- 计划: Sort -> Bitmap Heap Scan -> Bitmap Index Scan
```

---

## 5. 性能优化

### 5.1 索引优化

**索引优化（带完整错误处理）**:

```sql
-- 使用GIN索引（推荐，带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'articles_cn' AND indexname = 'articles_cn_tsv_idx'
    ) THEN
        RAISE WARNING '索引已存在: articles_cn_tsv_idx';
    ELSE
        CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv);
        RAISE NOTICE 'GIN索引创建成功: articles_cn_tsv_idx';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN duplicate_table THEN
        RAISE WARNING '索引已存在: articles_cn_tsv_idx';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建索引失败: %', SQLERRM;
END $$;

-- 对于大表，考虑使用部分索引（带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    -- 删除现有索引（如果存在）
    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'articles_cn' AND indexname = 'articles_cn_tsv_idx'
    ) THEN
        DROP INDEX articles_cn_tsv_idx;
        RAISE NOTICE '已删除现有索引: articles_cn_tsv_idx';
    END IF;

    -- 创建部分索引
    CREATE INDEX articles_cn_tsv_idx ON articles_cn USING GIN (tsv)
    WHERE tsv IS NOT NULL;

    RAISE NOTICE '部分索引创建成功: articles_cn_tsv_idx (WHERE tsv IS NOT NULL)';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建部分索引失败: %', SQLERRM;
END $$;

-- 性能测试：索引使用情况
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM articles_cn
WHERE tsv @@ to_tsquery('chinese_zh', '数据库');
-- 执行时间: 使用GIN索引，查询速度快
-- 计划: Bitmap Heap Scan -> Bitmap Index Scan
```

### 5.2 查询优化

**查询优化对比（带性能测试）**:

```sql
-- ❌ 不推荐：查询时计算tsvector（性能差）
-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM articles_cn
WHERE to_tsvector('chinese_zh', content) @@ to_tsquery('chinese_zh', '数据库');
-- 执行时间: 慢（需要为每行计算tsvector）
-- 计划: Seq Scan（无法使用索引）

-- ✅ 推荐：使用预计算的tsvector（性能好）
-- 性能测试
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM articles_cn
WHERE tsv @@ to_tsquery('chinese_zh', '数据库');
-- 执行时间: 快（使用GIN索引）
-- 计划: Bitmap Heap Scan -> Bitmap Index Scan

-- 查询优化验证（带错误处理）
DO $$
DECLARE
    slow_count BIGINT;
    fast_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'articles_cn') THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    END IF;

    -- 慢查询（不推荐）
    SELECT COUNT(*) INTO slow_count
    FROM articles_cn
    WHERE to_tsvector('chinese_zh', content) @@ to_tsquery('chinese_zh', '数据库');

    -- 快查询（推荐）
    SELECT COUNT(*) INTO fast_count
    FROM articles_cn
    WHERE tsv @@ to_tsquery('chinese_zh', '数据库');

    RAISE NOTICE '慢查询结果数: %, 快查询结果数: %', slow_count, fast_count;

    IF slow_count != fast_count THEN
        RAISE WARNING '查询结果不一致（可能有问题）';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION '表不存在: articles_cn';
    WHEN undefined_object THEN
        RAISE EXCEPTION '文本搜索配置不存在: chinese_zh';
    WHEN OTHERS THEN
        RAISE EXCEPTION '查询优化验证失败: %', SQLERRM;
END $$;
```

---

## 6. 最佳实践

### ✅ 推荐做法

1. **预计算tsvector** - 在插入/更新时计算，避免查询时计算
2. **使用GIN索引** - 对于全文搜索，GIN索引性能更好
3. **合理配置分词器** - 根据实际需求调整词典映射
4. **定期维护索引** - 定期VACUUM和REINDEX

### ❌ 避免做法

1. **查询时计算tsvector** - 性能差，不推荐
2. **过度分词** - 分词过细会影响搜索准确性
3. **忽略索引维护** - 索引膨胀会影响性能

---

## 📚 相关文档

- [PostgreSQL18-全文搜索深度实战.md](./PostgreSQL18-全文搜索深度实战.md) - 全文搜索完整指南
- [02-查询与优化/README.md](../README.md) - 查询与优化主题

---

**最后更新**: 2025年1月
