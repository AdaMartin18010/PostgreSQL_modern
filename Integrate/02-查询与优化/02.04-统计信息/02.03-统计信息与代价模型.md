---

> **ðŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/03-æŸ¥è¯¢ä¸Žä¼˜åŒ–/02.03-ç»Ÿè®¡ä¿¡æ¯ä¸Žä»£ä»·æ¨¡åž‹.md`
> **ðŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŽŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç»Ÿè®¡ä¿¡æ¯ä¸Žä»£ä»·æ¨¡åž‹

> **ç‰ˆæœ¬**: v3.1
> **æœ€åŽæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æŽ¨è) â­ | 17.x (æŽ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ã€ä»£ä»·æ¨¡åž‹è°ƒä¼˜ã€æŸ¥è¯¢ä¼˜åŒ–
> ðŸ†• **PostgreSQL 18ç»Ÿè®¡æ”¹è¿›**: æ”¹è¿›çš„å¤šå˜é‡ç»Ÿè®¡å‡†ç¡®æ€§ã€æ›´ç²¾ç»†çš„ç›´æ–¹å›¾ã€è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ã€è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¼˜åŒ–ã€å¼‚æ­¥I/Oæå‡ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½ã€æ›´æ™ºèƒ½çš„ç»Ÿè®¡ä¿¡æ¯é‡‡æ ·ç­–ç•¥

---

## ðŸ“‹ ç›®å½•

- [ç»Ÿè®¡ä¿¡æ¯ä¸Žä»£ä»·æ¨¡åž‹](#ç»Ÿè®¡ä¿¡æ¯ä¸Žä»£ä»·æ¨¡åž‹)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ðŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ðŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#-å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [ç»Ÿè®¡ä¿¡æ¯ç±»åž‹å¯¹æ¯”çŸ©é˜µ](#ç»Ÿè®¡ä¿¡æ¯ç±»åž‹å¯¹æ¯”çŸ©é˜µ)
    - [ä»£ä»·æ¨¡åž‹å‚æ•°å¯¹æ¯”çŸ©é˜µ](#ä»£ä»·æ¨¡åž‹å‚æ•°å¯¹æ¯”çŸ©é˜µ)
    - [é€‰æ‹©æ€§ä¼°è®¡æ–¹æ³•å¯¹æ¯”çŸ©é˜µ](#é€‰æ‹©æ€§ä¼°è®¡æ–¹æ³•å¯¹æ¯”çŸ©é˜µ)
  - [ðŸŒ Wikipediaå¯¹é½](#-wikipediaå¯¹é½)
    - [ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½](#ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½)
    - [ä»£ä»·æ¨¡åž‹æ¦‚å¿µå¯¹é½](#ä»£ä»·æ¨¡åž‹æ¦‚å¿µå¯¹é½)
  - [1. å®šä¹‰ä¸Žå½¢å¼åŒ–](#1-å®šä¹‰ä¸Žå½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±žæ€§](#13-æ ¸å¿ƒå±žæ€§)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1 ç»Ÿè®¡ä¿¡æ¯ç†è®º](#21-ç»Ÿè®¡ä¿¡æ¯ç†è®º)
    - [2.2 ä»£ä»·æ¨¡åž‹ç†è®º](#22-ä»£ä»·æ¨¡åž‹ç†è®º)
    - [2.3 é€‰æ‹©æ€§ä¼°è®¡ç†è®º](#23-é€‰æ‹©æ€§ä¼°è®¡ç†è®º)
  - [3. PostgreSQLç»Ÿè®¡ä¿¡æ¯](#3-postgresqlç»Ÿè®¡ä¿¡æ¯)
    - [3.1 è¡¨çº§ç»Ÿè®¡ä¿¡æ¯](#31-è¡¨çº§ç»Ÿè®¡ä¿¡æ¯)
    - [3.2 åˆ—çº§ç»Ÿè®¡ä¿¡æ¯](#32-åˆ—çº§ç»Ÿè®¡ä¿¡æ¯)
    - [3.3 ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯](#33-ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯)
  - [4. ç»Ÿè®¡ä¿¡æ¯æ”¶é›†](#4-ç»Ÿè®¡ä¿¡æ¯æ”¶é›†)
    - [4.1 è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†](#41-è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†)
    - [4.2 æ‰‹åŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†](#42-æ‰‹åŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†)
    - [4.3 ç»Ÿè®¡ä¿¡æ¯é…ç½®](#43-ç»Ÿè®¡ä¿¡æ¯é…ç½®)
  - [5. ä»£ä»·æ¨¡åž‹å‚æ•°](#5-ä»£ä»·æ¨¡åž‹å‚æ•°)
    - [5.1 åŸºæœ¬ä»£ä»·å‚æ•°](#51-åŸºæœ¬ä»£ä»·å‚æ•°)
    - [5.2 è¿žæŽ¥ä»£ä»·å‚æ•°](#52-è¿žæŽ¥ä»£ä»·å‚æ•°)
    - [5.3 å†…å­˜ä»£ä»·å‚æ•°](#53-å†…å­˜ä»£ä»·å‚æ•°)
  - [6. é€‰æ‹©æ€§ä¼°è®¡](#6-é€‰æ‹©æ€§ä¼°è®¡)
    - [6.1 ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§](#61-ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§)
    - [6.2 èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§](#62-èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§)
    - [6.3 å¤åˆæ¡ä»¶é€‰æ‹©æ€§](#63-å¤åˆæ¡ä»¶é€‰æ‹©æ€§)
  - [7. ä»£ä»·ä¼°ç®—åˆ†æž](#7-ä»£ä»·ä¼°ç®—åˆ†æž)
    - [7.1 æ‰«æä»£ä»·ä¼°ç®—](#71-æ‰«æä»£ä»·ä¼°ç®—)
    - [7.2 è¿žæŽ¥ä»£ä»·ä¼°ç®—](#72-è¿žæŽ¥ä»£ä»·ä¼°ç®—)
    - [7.3 èšåˆä»£ä»·ä¼°ç®—](#73-èšåˆä»£ä»·ä¼°ç®—)
  - [8. PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯æ–°ç‰¹æ€§](#8-postgresql-18ç»Ÿè®¡ä¿¡æ¯æ–°ç‰¹æ€§)
    - [8.1 è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¼˜åŒ–](#81-è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¼˜åŒ–)
    - [8.2 æ”¹è¿›çš„å¤šå˜é‡ç»Ÿè®¡å‡†ç¡®æ€§](#82-æ”¹è¿›çš„å¤šå˜é‡ç»Ÿè®¡å‡†ç¡®æ€§)
    - [8.3 æ›´ç²¾ç»†çš„ç›´æ–¹å›¾](#83-æ›´ç²¾ç»†çš„ç›´æ–¹å›¾)
    - [8.4 è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°](#84-è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°)
    - [8.5 å¼‚æ­¥I/Oæå‡ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½](#85-å¼‚æ­¥ioæå‡ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½)
  - [9. ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–](#9-ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–)
    - [9.1 ç»Ÿè®¡ä¿¡æ¯è´¨é‡è¯„ä¼°](#91-ç»Ÿè®¡ä¿¡æ¯è´¨é‡è¯„ä¼°)
    - [9.2 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥](#92-ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥)
    - [9.3 ç»Ÿè®¡ä¿¡æ¯ç›‘æŽ§](#93-ç»Ÿè®¡ä¿¡æ¯ç›‘æŽ§)
  - [10. å®žé™…åº”ç”¨æ¡ˆä¾‹](#10-å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 å¤§æ•°æ®è¡¨ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#101-å¤§æ•°æ®è¡¨ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
    - [10.2 åŠ¨æ€ç»Ÿè®¡ä¿¡æ¯è°ƒæ•´](#102-åŠ¨æ€ç»Ÿè®¡ä¿¡æ¯è°ƒæ•´)
    - [10.3 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯æœ€ä½³å®žè·µ](#103-postgresql-18ç»Ÿè®¡ä¿¡æ¯æœ€ä½³å®žè·µ)
  - [11. ç›¸å…³æ¦‚å¿µ](#11-ç›¸å…³æ¦‚å¿µ)
    - [11.1 ä¸Šä½æ¦‚å¿µ](#111-ä¸Šä½æ¦‚å¿µ)
    - [11.2 ä¸‹ä½æ¦‚å¿µ](#112-ä¸‹ä½æ¦‚å¿µ)
    - [11.3 å¹³è¡Œæ¦‚å¿µ](#113-å¹³è¡Œæ¦‚å¿µ)
  - [12. å‚è€ƒæ–‡çŒ®](#12-å‚è€ƒæ–‡çŒ®)
  - [13. äº¤å‰å¼•ç”¨](#13-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
  - [14. Wikidataå¯¹é½](#14-wikidataå¯¹é½)
    - [14.1 ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½](#141-ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½)
    - [14.2 PostgreSQLç»Ÿè®¡ä¿¡æ¯å¯¹é½](#142-postgresqlç»Ÿè®¡ä¿¡æ¯å¯¹é½)
  - [15. å½¢å¼è¯æ˜Žä¸Žç†è®ºè®ºè¯](#15-å½¢å¼è¯æ˜Žä¸Žç†è®ºè®ºè¯)
    - [15.1 é€‰æ‹©æ€§ä¼°è®¡å‡†ç¡®æ€§è¯æ˜Ž](#151-é€‰æ‹©æ€§ä¼°è®¡å‡†ç¡®æ€§è¯æ˜Ž)
    - [15.2 ä»£ä»·æ¨¡åž‹æœ€ä¼˜æ€§è¯æ˜Ž](#152-ä»£ä»·æ¨¡åž‹æœ€ä¼˜æ€§è¯æ˜Ž)
    - [15.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¿…è¦æ€§è¯æ˜Ž](#153-ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¿…è¦æ€§è¯æ˜Ž)

---

## ðŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç»Ÿè®¡ä¿¡æ¯ä¸Žä»£ä»·æ¨¡åž‹))
    ç»Ÿè®¡ä¿¡æ¯
      è¡¨çº§ç»Ÿè®¡
        è¡Œæ•°
        é¡µæ•°
        è¡¨å¤§å°
      åˆ—çº§ç»Ÿè®¡
        ä¸åŒå€¼æ•°é‡
        ç©ºå€¼æ•°é‡
        ç›¸å…³æ€§
        ç›´æ–¹å›¾
        æœ€å¸¸å€¼
      ç´¢å¼•ç»Ÿè®¡
        ç´¢å¼•å¤§å°
        ç´¢å¼•ä½¿ç”¨çŽ‡
        ç´¢å¼•é€‰æ‹©æ€§
    ç»Ÿè®¡æ”¶é›†
      è‡ªåŠ¨æ”¶é›†
        ANALYZE
        è‡ªåŠ¨è§¦å‘
        é…ç½®å‚æ•°
      æ‰‹åŠ¨æ”¶é›†
        æ‰‹åŠ¨ANALYZE
        éƒ¨åˆ†ç»Ÿè®¡
        æ‰©å±•ç»Ÿè®¡
      ç»Ÿè®¡é…ç½®
        é‡‡æ ·çŽ‡
        ç»Ÿè®¡ç›®æ ‡
        ç»Ÿè®¡èŒƒå›´
    ä»£ä»·æ¨¡åž‹
      åŸºæœ¬ä»£ä»·
        CPUä»£ä»·
        I/Oä»£ä»·
        å†…å­˜ä»£ä»·
      è¿žæŽ¥ä»£ä»·
        åµŒå¥—å¾ªçŽ¯
        å“ˆå¸Œè¿žæŽ¥
        åˆå¹¶è¿žæŽ¥
      èšåˆä»£ä»·
        Hashèšåˆ
        Sortèšåˆ
    é€‰æ‹©æ€§ä¼°è®¡
      ç­‰å€¼æŸ¥è¯¢
        å”¯ä¸€å€¼ä¼°è®¡
        æœ€å¸¸å€¼ä¼°è®¡
      èŒƒå›´æŸ¥è¯¢
        ç›´æ–¹å›¾ä¼°è®¡
        ç›¸å…³æ€§è€ƒè™‘
      å¤åˆæ¡ä»¶
        ç‹¬ç«‹æ€§å‡è®¾
        ç›¸å…³æ€§ç»Ÿè®¡
    ä»£ä»·ä¼°ç®—
      æ‰«æä»£ä»·
        é¡ºåºæ‰«æ
        ç´¢å¼•æ‰«æ
        ä½å›¾æ‰«æ
      è¿žæŽ¥ä»£ä»·
        è¿žæŽ¥ç®—æ³•
        è¿žæŽ¥é¡ºåº
      èšåˆä»£ä»·
        èšåˆç®—æ³•
        åˆ†ç»„å¤§å°
    ç»Ÿè®¡ä¼˜åŒ–
      è´¨é‡è¯„ä¼°
        å‡†ç¡®æ€§æ£€æŸ¥
        æ—¶æ•ˆæ€§æ£€æŸ¥
      æ›´æ–°ç­–ç•¥
        å¢žé‡æ›´æ–°
        å…¨é‡æ›´æ–°
      ç›‘æŽ§è¯Šæ–­
        ç»Ÿè®¡ç›‘æŽ§
        æ€§èƒ½åˆ†æž
```

---

## ðŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### ç»Ÿè®¡ä¿¡æ¯ç±»åž‹å¯¹æ¯”çŸ©é˜µ

| ç»Ÿè®¡ç±»åž‹ | æ”¶é›†æ–¹å¼ | æ›´æ–°é¢‘çŽ‡ | å­˜å‚¨ç©ºé—´ | å‡†ç¡®æ€§ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- | --- |
| **è¡¨çº§ç»Ÿè®¡** | ANALYZE | ä½Ž | å° | é«˜ | åŸºæœ¬æŸ¥è¯¢ | âœ… é»˜è®¤ |
| **åˆ—çº§ç»Ÿè®¡** | ANALYZE | ä¸­ | ä¸­ | é«˜ | å•åˆ—æŸ¥è¯¢ | âœ… é»˜è®¤ |
| **å¤šåˆ—ç»Ÿè®¡** | CREATE STATISTICS | ä¸­ | ä¸­ | ä¸­ | å¤šåˆ—æŸ¥è¯¢ | âœ… æ”¯æŒ |
| **è¡¨è¾¾å¼ç»Ÿè®¡** | CREATE STATISTICS | ä¸­ | ä¸­ | ä¸­ | è¡¨è¾¾å¼æŸ¥è¯¢ | âœ… æ”¯æŒ |
| **æ‰©å±•ç»Ÿè®¡** | CREATE STATISTICS | ä½Ž | å¤§ | é«˜ | å¤æ‚æŸ¥è¯¢ | âœ… æ”¯æŒ |

### ä»£ä»·æ¨¡åž‹å‚æ•°å¯¹æ¯”çŸ©é˜µ

| ä»£ä»·å‚æ•° | é»˜è®¤å€¼ | å½±å“èŒƒå›´ | è°ƒä¼˜éš¾åº¦ | æ€§èƒ½å½±å“ | PostgreSQLç‰ˆæœ¬ |
| --- | --- | --- | --- | --- | --- |
| **seq_page_cost** | 1.0 | é¡ºåºæ‰«æ | ä½Ž | é«˜ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **random_page_cost** | 4.0 | éšæœºI/O | ä½Ž | é«˜ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **cpu_tuple_cost** | 0.01 | CPUå¤„ç† | ä½Ž | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **cpu_index_tuple_cost** | 0.005 | ç´¢å¼•å¤„ç† | ä½Ž | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **cpu_operator_cost** | 0.0025 | æ“ä½œç¬¦ | ä½Ž | ä½Ž | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **effective_cache_size** | 4GB | ç¼“å­˜å‡è®¾ | ä¸­ | é«˜ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |

### é€‰æ‹©æ€§ä¼°è®¡æ–¹æ³•å¯¹æ¯”çŸ©é˜µ

| ä¼°è®¡æ–¹æ³• | å‡†ç¡®æ€§ | è®¡ç®—å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | å±€é™æ€§ | PostgreSQLå®žçŽ° |
| --- | --- | --- | --- | --- | --- |
| **å‡åŒ€åˆ†å¸ƒå‡è®¾** | ä½Ž | O(1) | æ— ç»Ÿè®¡ä¿¡æ¯ | ä¸å‡†ç¡® | âœ… é»˜è®¤ |
| **æœ€å¸¸å€¼(MCV)** | é«˜ | O(1) | åæ–œæ•°æ® | éœ€è¦ç»Ÿè®¡ | âœ… æ”¯æŒ |
| **ç›´æ–¹å›¾** | é«˜ | O(log n) | èŒƒå›´æŸ¥è¯¢ | éœ€è¦ç»Ÿè®¡ | âœ… æ”¯æŒ |
| **å¤šåˆ—ç»Ÿè®¡** | å¾ˆé«˜ | O(n) | ç›¸å…³åˆ— | éœ€è¦æ‰©å±•ç»Ÿè®¡ | âœ… æ”¯æŒ |
| **è¡¨è¾¾å¼ç»Ÿè®¡** | å¾ˆé«˜ | O(n) | è¡¨è¾¾å¼æŸ¥è¯¢ | éœ€è¦æ‰©å±•ç»Ÿè®¡ | âœ… æ”¯æŒ |

---

## ðŸŒ Wikipediaå¯¹é½

### ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Database statistics](https://en.wikipedia.org/wiki/Database_statistics)

> Database statistics are metadata about data stored in a database that help the query optimizer choose the best execution plan for a query.

**å¯¹é½è¯´æ˜Ž**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸ŽWikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒç»Ÿè®¡ä¿¡æ¯ç”¨äºŽæŸ¥è¯¢ä¼˜åŒ–
- âœ… **æ ¸å¿ƒä½œç”¨**: éƒ½æåˆ°å¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè®¡åˆ’
- âœ… **å†…å®¹èŒƒå›´**: éƒ½åŒ…å«è¡¨çº§ã€åˆ—çº§ã€ç´¢å¼•çº§ç»Ÿè®¡

### ä»£ä»·æ¨¡åž‹æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Query optimization](https://en.wikipedia.org/wiki/Query_optimization#Cost-based_optimization)

> Cost-based optimization uses statistics about the data distribution and system resources to estimate the cost of different execution plans and choose the best one.

**å¯¹é½è¯´æ˜Ž**:

- âœ… **ä¼˜åŒ–æ–¹æ³•**: PostgreSQLä½¿ç”¨åŸºäºŽä»£ä»·çš„ä¼˜åŒ–
- âœ… **ç»Ÿè®¡ä¾èµ–**: éƒ½å¼ºè°ƒåŸºäºŽç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä»£ä»·ä¼°ç®—
- âœ… **ç›®æ ‡ä¸€è‡´**: éƒ½å¼ºè°ƒé€‰æ‹©æœ€ä¼˜æ‰§è¡Œè®¡åˆ’

---

## 1. å®šä¹‰ä¸Žå½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: ç»Ÿè®¡ä¿¡æ¯æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç”¨äºŽæè¿°æ•°æ®åˆ†å¸ƒç‰¹å¾çš„ä¿¡æ¯ï¼Œä»£ä»·æ¨¡åž‹åŸºäºŽç»Ÿè®¡ä¿¡æ¯ä¼°ç®—æŸ¥è¯¢æ‰§è¡Œæˆæœ¬ï¼Œä¸ºæŸ¥è¯¢ä¼˜åŒ–å™¨æä¾›å†³ç­–ä¾æ®ã€‚

**English Definition**: Statistics are information in database systems used to describe data distribution characteristics. Cost models estimate query execution costs based on statistics, providing decision-making basis for query optimizers.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\stats}{\mathcal{S}}
\newcommand{\cost}{\mathcal{C}}
\newcommand{\query}{\mathcal{Q}}
\newcommand{\plan}{\mathcal{P}}

% ç»Ÿè®¡ä¿¡æ¯çš„å½¢å¼åŒ–å®šä¹‰
\stats = \{n, \text{ndistinct}, \text{correlation}, \text{histogram}, \text{mcv}\}

å…¶ä¸­ï¼š
n: å…ƒç»„æ•°é‡
\text{ndistinct}: ä¸åŒå€¼æ•°é‡
\text{correlation}: åˆ—ç›¸å…³æ€§
\text{histogram}: ç›´æ–¹å›¾åˆ†å¸ƒ
\text{mcv}: æœ€å¸¸å€¼

% ä»£ä»·æ¨¡åž‹çš„å½¢å¼åŒ–å®šä¹‰
\cost(\plan) = \cost_{IO}(\plan) + \cost_{CPU}(\plan) + \cost_{Memory}(\plan)
```

### 1.3 æ ¸å¿ƒå±žæ€§

- **å‡†ç¡®æ€§**: ç»Ÿè®¡ä¿¡æ¯åæ˜ çœŸå®žæ•°æ®åˆ†å¸ƒ
- **æ—¶æ•ˆæ€§**: ç»Ÿè®¡ä¿¡æ¯åŠæ—¶æ›´æ–°
- **å®Œæ•´æ€§**: è¦†ç›–æ‰€æœ‰ç›¸å…³æ•°æ®ç‰¹å¾
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤æ‚æŸ¥è¯¢ä»£ä»·ä¼°ç®—

## 2. ç†è®ºåŸºç¡€

### 2.1 ç»Ÿè®¡ä¿¡æ¯ç†è®º

```latex
\begin{theorem}[ç»Ÿè®¡ä¿¡æ¯å®Œå¤‡æ€§]
ç»Ÿè®¡ä¿¡æ¯å®Œå¤‡æ€§è¦æ±‚ï¼š
1. åŸºæ•°ä¼°è®¡ï¼š|R| çš„å‡†ç¡®ä¼°è®¡
2. é€‰æ‹©æ€§ä¼°è®¡ï¼š\frac{|\sigma_p(R)|}{|R|} çš„å‡†ç¡®ä¼°è®¡
3. ç›¸å…³æ€§ä¼°è®¡ï¼šåˆ—é—´ç›¸å…³æ€§çš„å‡†ç¡®ä¼°è®¡
4. åˆ†å¸ƒä¼°è®¡ï¼šæ•°æ®åˆ†å¸ƒçš„å‡†ç¡®ä¼°è®¡
\end{theorem}
```

### 2.2 ä»£ä»·æ¨¡åž‹ç†è®º

```latex
\begin{theorem}[ä»£ä»·æ¨¡åž‹æ­£ç¡®æ€§]
ä»£ä»·æ¨¡åž‹æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š
1. å•è°ƒæ€§ï¼š\cost(\plan_1) \leq \cost(\plan_2) \Rightarrow \text{æ€§èƒ½}(\plan_1) \geq \text{æ€§èƒ½}(\plan_2)
2. å¯åŠ æ€§ï¼š\cost(\plan_1 \bowtie \plan_2) = \cost(\plan_1) + \cost(\plan_2) + \cost_{join}
3. ä¸€è‡´æ€§ï¼šç›¸åŒæ“ä½œçš„ä»£ä»·ä¼°ç®—ä¸€è‡´
\end{theorem}
```

### 2.3 é€‰æ‹©æ€§ä¼°è®¡ç†è®º

```latex
\begin{theorem}[é€‰æ‹©æ€§ä¼°è®¡]
å¯¹äºŽè°“è¯ pï¼Œé€‰æ‹©æ€§ä¼°è®¡ä¸ºï¼š
\text{sel}(p) = \frac{|\sigma_p(R)|}{|R|}

å…¶ä¸­é€‰æ‹©æ€§ä¼°è®¡çš„å‡†ç¡®æ€§ç›´æŽ¥å½±å“æŸ¥è¯¢ä¼˜åŒ–æ•ˆæžœã€‚
\end{theorem}
```

## 3. PostgreSQLç»Ÿè®¡ä¿¡æ¯

### 3.1 è¡¨çº§ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_stat_user_tables
        WHERE tablename = 'employees';

        IF table_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'employees';

-- æŸ¥çœ‹è¡¨å¤§å°ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_tables
        WHERE tablename = 'employees';

        IF table_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°è¡¨ employees çš„å¤§å°ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨å¤§å°ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size
FROM pg_tables
WHERE tablename = 'employees';
```

### 3.2 åˆ—çº§ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public' AND tablename = 'employees';

        IF stats_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªåˆ—çš„ç»Ÿè®¡ä¿¡æ¯', stats_count;
        ELSE
            RAISE WARNING 'åˆ—ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE schemaname = 'public' AND tablename = 'employees';

-- æŸ¥çœ‹ç‰¹å®šåˆ—ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public'
        AND tablename = 'employees'
        AND attname = 'salary';

        IF stats_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°åˆ— salary çš„ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'åˆ— salary çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE employees(salary)';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç‰¹å®šåˆ—ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    attname,
    n_distinct,
    correlation,
    array_length(most_common_vals, 1) as mcv_count,
    array_length(histogram_bounds, 1) as histogram_buckets
FROM pg_stats
WHERE schemaname = 'public'
AND tablename = 'employees'
AND attname = 'salary';
```

### 3.3 ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO index_count FROM pg_stat_user_indexes;
        IF index_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯', index_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    idx_blks_read,
    idx_blks_hit
FROM pg_statio_user_indexes
WHERE tablename = 'employees';

-- ç´¢å¼•ä½¿ç”¨æ•ˆçŽ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æ•ˆçŽ‡';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO index_count FROM pg_statio_user_indexes WHERE tablename = 'employees';
        IF index_count = 0 THEN
            RAISE WARNING 'è¡¨ employees æ²¡æœ‰ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯', index_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ç´¢å¼•ä½¿ç”¨æ•ˆçŽ‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    round(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) as hit_ratio
FROM pg_statio_user_indexes
WHERE tablename = 'employees'
ORDER BY idx_scan DESC;
```

## 4. ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

### 4.1 è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

```sql
-- æŸ¥çœ‹è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_autovacuum TEXT;
    v_threshold TEXT;
    v_scale_factor TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_autovacuum FROM pg_settings WHERE name = 'autovacuum';
        SELECT setting INTO v_threshold FROM pg_settings WHERE name = 'autovacuum_analyze_threshold';
        SELECT setting INTO v_scale_factor FROM pg_settings WHERE name = 'autovacuum_analyze_scale_factor';

        RAISE NOTICE 'è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯é…ç½®ï¼š';
        RAISE NOTICE '  autovacuum: %', v_autovacuum;
        RAISE NOTICE '  autovacuum_analyze_threshold: %', v_threshold;
        RAISE NOTICE '  autovacuum_analyze_scale_factor: %', v_scale_factor;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW autovacuum;
SHOW autovacuum_analyze_threshold;
SHOW autovacuum_analyze_scale_factor;

-- é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        ALTER TABLE employees SET (autovacuum_analyze_threshold = 50);
        ALTER TABLE employees SET (autovacuum_analyze_scale_factor = 0.1);
        RAISE NOTICE 'è¡¨ employees çš„è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯é…ç½®å·²æ›´æ–°';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ”¶é›†çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_stat_user_tables
        WHERE tablename = 'employees';

        IF table_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†çŠ¶æ€';
        ELSE
            RAISE WARNING 'è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†çŠ¶æ€ä¸å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ”¶é›†çŠ¶æ€å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
WHERE tablename = 'employees';
```

### 4.2 æ‰‹åŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

```sql
-- æ‰‹åŠ¨æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ”¶é›†ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ”¶é›†è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

ANALYZE employees;

-- æ”¶é›†ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ”¶é›†è¡¨ employees çš„åˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆsalary, dept_idï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†åˆ—ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

ANALYZE employees (salary, dept_id);

-- è¯¦ç»†æ¨¡å¼æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è¯¦ç»†æ¨¡å¼æ”¶é›†è¡¨ employees çš„ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è¯¦ç»†æ¨¡å¼æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

ANALYZE VERBOSE employees;

-- æ”¶é›†æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ”¶é›†æ‰€æœ‰è¡¨çš„ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

ANALYZE;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    analyze_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO analyze_count
        FROM pg_stat_activity
        WHERE query LIKE '%ANALYZE%';

        IF analyze_count > 0 THEN
            RAISE NOTICE 'å‘çŽ° % ä¸ªANALYZEè¿›ç¨‹æ­£åœ¨è¿è¡Œ', analyze_count;
        ELSE
            RAISE NOTICE 'å½“å‰æ²¡æœ‰ANALYZEè¿›ç¨‹åœ¨è¿è¡Œ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¿›åº¦å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%ANALYZE%';
```

### 4.3 ç»Ÿè®¡ä¿¡æ¯é…ç½®

```sql
-- ç»Ÿè®¡ä¿¡æ¯é…ç½®å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_target TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_target FROM pg_settings WHERE name = 'default_statistics_target';
        RAISE NOTICE 'é»˜è®¤ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ï¼ˆdefault_statistics_targetï¼‰: %', v_target;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯é…ç½®å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW default_statistics_target;

-- è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'employees' AND column_name = 'salary') THEN
            RAISE WARNING 'åˆ— salary ä¸å­˜åœ¨';
        ELSE
            ALTER TABLE employees ALTER COLUMN salary SET STATISTICS 1000;
            RAISE NOTICE 'åˆ— salary çš„ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å·²è®¾ç½®ä¸º1000';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'employees' AND column_name = 'dept_id') THEN
            RAISE WARNING 'åˆ— dept_id ä¸å­˜åœ¨';
        ELSE
            ALTER TABLE employees ALTER COLUMN dept_id SET STATISTICS 100;
            RAISE NOTICE 'åˆ— dept_id çš„ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å·²è®¾ç½®ä¸º100';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'æŒ‡å®šåˆ—ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    column_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO column_count
        FROM pg_attribute
        WHERE attrelid = 'employees'::regclass
        AND attnum > 0
        AND NOT attisdropped;

        IF column_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªåˆ—ï¼ŒæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡', column_count;
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°æœ‰æ•ˆåˆ—';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    attname,
    attstattarget
FROM pg_attribute
WHERE attrelid = 'employees'::regclass
AND attnum > 0
AND NOT attisdropped;
```

## 5. ä»£ä»·æ¨¡åž‹å‚æ•°

### 5.1 åŸºæœ¬ä»£ä»·å‚æ•°

```sql
-- æŸ¥çœ‹åŸºæœ¬ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_seq_page_cost TEXT;
    v_random_page_cost TEXT;
    v_cpu_tuple_cost TEXT;
    v_cpu_index_tuple_cost TEXT;
    v_cpu_operator_cost TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_seq_page_cost FROM pg_settings WHERE name = 'seq_page_cost';
        SELECT setting INTO v_random_page_cost FROM pg_settings WHERE name = 'random_page_cost';
        SELECT setting INTO v_cpu_tuple_cost FROM pg_settings WHERE name = 'cpu_tuple_cost';
        SELECT setting INTO v_cpu_index_tuple_cost FROM pg_settings WHERE name = 'cpu_index_tuple_cost';
        SELECT setting INTO v_cpu_operator_cost FROM pg_settings WHERE name = 'cpu_operator_cost';

        RAISE NOTICE 'åŸºæœ¬ä»£ä»·å‚æ•°ï¼š';
        RAISE NOTICE '  seq_page_cost: %, random_page_cost: %', v_seq_page_cost, v_random_page_cost;
        RAISE NOTICE '  cpu_tuple_cost: %, cpu_index_tuple_cost: %, cpu_operator_cost: %',
            v_cpu_tuple_cost, v_cpu_index_tuple_cost, v_cpu_operator_cost;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹åŸºæœ¬ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW seq_page_cost;
SHOW random_page_cost;
SHOW cpu_tuple_cost;
SHOW cpu_index_tuple_cost;
SHOW cpu_operator_cost;

-- è®¾ç½®ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET seq_page_cost = 1.0;
        SET random_page_cost = 4.0;
        SET cpu_tuple_cost = 0.01;
        SET cpu_index_tuple_cost = 0.005;
        SET cpu_operator_cost = 0.0025;
        RAISE NOTICE 'ä»£ä»·å‚æ•°è®¾ç½®æˆåŠŸï¼ˆä¼šè¯çº§åˆ«ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.2 è¿žæŽ¥ä»£ä»·å‚æ•°

```sql
-- æŸ¥çœ‹è¿žæŽ¥ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_join_collapse_limit TEXT;
    v_from_collapse_limit TEXT;
    v_geqo TEXT;
    v_geqo_threshold TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_join_collapse_limit FROM pg_settings WHERE name = 'join_collapse_limit';
        SELECT setting INTO v_from_collapse_limit FROM pg_settings WHERE name = 'from_collapse_limit';
        SELECT setting INTO v_geqo FROM pg_settings WHERE name = 'geqo';
        SELECT setting INTO v_geqo_threshold FROM pg_settings WHERE name = 'geqo_threshold';

        RAISE NOTICE 'è¿žæŽ¥ä»£ä»·å‚æ•°ï¼š';
        RAISE NOTICE '  join_collapse_limit: %, from_collapse_limit: %', v_join_collapse_limit, v_from_collapse_limit;
        RAISE NOTICE '  geqo: %, geqo_threshold: %', v_geqo, v_geqo_threshold;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¿žæŽ¥ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW join_collapse_limit;
SHOW from_collapse_limit;
SHOW geqo;
SHOW geqo_threshold;

-- è®¾ç½®è¿žæŽ¥ä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET join_collapse_limit = 8;
        SET from_collapse_limit = 8;
        SET geqo = on;
        SET geqo_threshold = 12;
        RAISE NOTICE 'è¿žæŽ¥ä»£ä»·å‚æ•°è®¾ç½®æˆåŠŸï¼ˆä¼šè¯çº§åˆ«ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®è¿žæŽ¥ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 5.3 å†…å­˜ä»£ä»·å‚æ•°

```sql
-- æŸ¥çœ‹å†…å­˜ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_work_mem TEXT;
    v_maintenance_work_mem TEXT;
    v_effective_cache_size TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_work_mem FROM pg_settings WHERE name = 'work_mem';
        SELECT setting INTO v_maintenance_work_mem FROM pg_settings WHERE name = 'maintenance_work_mem';
        SELECT setting INTO v_effective_cache_size FROM pg_settings WHERE name = 'effective_cache_size';

        RAISE NOTICE 'å†…å­˜ä»£ä»·å‚æ•°ï¼š';
        RAISE NOTICE '  work_mem: %, maintenance_work_mem: %, effective_cache_size: %',
            v_work_mem, v_maintenance_work_mem, v_effective_cache_size;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹å†…å­˜ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SHOW work_mem;
SHOW maintenance_work_mem;
SHOW effective_cache_size;

-- è®¾ç½®å†…å­˜å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET work_mem = '256MB';
        SET maintenance_work_mem = '1GB';
        SET effective_cache_size = '8GB';
        RAISE NOTICE 'å†…å­˜ä»£ä»·å‚æ•°è®¾ç½®æˆåŠŸï¼ˆä¼šè¯çº§åˆ«ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å†…å­˜ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 6. é€‰æ‹©æ€§ä¼°è®¡

### 6.1 ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§

```sql
-- ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡ï¼ˆemp_id = 1001ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç­‰å€¼æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees WHERE emp_id = 1001;

-- æŸ¥çœ‹é€‰æ‹©æ€§ä¼°è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹é€‰æ‹©æ€§ä¼°è®¡';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public'
        AND tablename = 'employees'
        AND attname = 'emp_id';

        IF stats_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°åˆ— emp_id çš„é€‰æ‹©æ€§ä¼°è®¡ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'åˆ— emp_id çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE employees(emp_id)';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹é€‰æ‹©æ€§ä¼°è®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    attname,
    n_distinct,
    most_common_vals,
    most_common_freqs
FROM pg_stats
WHERE schemaname = 'public'
AND tablename = 'employees'
AND attname = 'emp_id';
```

### 6.2 èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§

```sql
-- èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡ŒèŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡ï¼ˆsalary BETWEEN 40000 AND 60000ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'èŒƒå›´æŸ¥è¯¢é€‰æ‹©æ€§ä¼°è®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees WHERE salary BETWEEN 40000 AND 60000;

-- æŸ¥çœ‹ç›´æ–¹å›¾ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç›´æ–¹å›¾ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public'
        AND tablename = 'employees'
        AND attname = 'salary';

        IF stats_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ°åˆ— salary çš„ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'åˆ— salary çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE employees(salary)';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç›´æ–¹å›¾ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    attname,
    histogram_bounds
FROM pg_stats
WHERE schemaname = 'public'
AND tablename = 'employees'
AND attname = 'salary';
```

### 6.3 å¤åˆæ¡ä»¶é€‰æ‹©æ€§

```sql
-- å¤åˆæ¡ä»¶é€‰æ‹©æ€§ä¼°è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œå¤åˆæ¡ä»¶é€‰æ‹©æ€§ä¼°è®¡';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹å¤åˆæ¡ä»¶é€‰æ‹©æ€§ä¼°è®¡ï¼ˆdept_id = 1 AND salary > 50000ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤åˆæ¡ä»¶é€‰æ‹©æ€§ä¼°è®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees
WHERE dept_id = 1 AND salary > 50000;

-- æŸ¥çœ‹åˆ—ç›¸å…³æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹åˆ—ç›¸å…³æ€§';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public'
        AND tablename = 'employees'
        AND attname IN ('dept_id', 'salary');

        IF stats_count >= 2 THEN
            RAISE NOTICE 'æ‰¾åˆ°åˆ— dept_id å’Œ salary çš„ç›¸å…³æ€§ç»Ÿè®¡ä¿¡æ¯';
        ELSE
            RAISE WARNING 'åˆ—ç›¸å…³æ€§ç»Ÿè®¡ä¿¡æ¯ä¸å®Œæ•´ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE employees';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹åˆ—ç›¸å…³æ€§å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    attname,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
AND tablename = 'employees'
AND attname IN ('dept_id', 'salary');
```

## 7. ä»£ä»·ä¼°ç®—åˆ†æž

### 7.1 æ‰«æä»£ä»·ä¼°ç®—

```sql
-- é¡ºåºæ‰«æä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºé¡ºåºæ‰«æä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºé¡ºåºæ‰«æä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é¡ºåºæ‰«æä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT * FROM employees;

-- ç´¢å¼•æ‰«æä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºç´¢å¼•æ‰«æä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºç´¢å¼•æ‰«æä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•æ‰«æä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT * FROM employees WHERE emp_id = 1001;

-- ä½å›¾æ‰«æä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºä½å›¾æ‰«æä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºä½å›¾æ‰«æä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä½å›¾æ‰«æä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;
```

### 7.2 è¿žæŽ¥ä»£ä»·ä¼°ç®—

```sql
-- åµŒå¥—å¾ªçŽ¯è¿žæŽ¥ä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºåµŒå¥—å¾ªçŽ¯è¿žæŽ¥ä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºåµŒå¥—å¾ªçŽ¯è¿žæŽ¥ä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åµŒå¥—å¾ªçŽ¯è¿žæŽ¥ä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT e.name, d.dept_name
FROM employees e, departments d
WHERE e.dept_id = d.dept_id;

-- å“ˆå¸Œè¿žæŽ¥ä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå“ˆå¸Œè¿žæŽ¥ä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå“ˆå¸Œè¿žæŽ¥ä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å“ˆå¸Œè¿žæŽ¥ä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- åˆå¹¶è¿žæŽ¥ä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºåˆå¹¶è¿žæŽ¥ä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºåˆå¹¶è¿žæŽ¥ä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'åˆå¹¶è¿žæŽ¥ä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
ORDER BY e.dept_id;
```

### 7.3 èšåˆä»£ä»·ä¼°ç®—

```sql
-- å“ˆå¸Œèšåˆä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå“ˆå¸Œèšåˆä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå“ˆå¸Œèšåˆä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å“ˆå¸Œèšåˆä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT dept_id, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id;

-- æŽ’åºèšåˆä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºæŽ’åºèšåˆä»£ä»·';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºæŽ’åºèšåˆä»£ä»·ä¼°ç®—';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŽ’åºèšåˆä»£ä»·æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT dept_id, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id
ORDER BY dept_id;
```

## 8. PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯æ–°ç‰¹æ€§

### 8.1 è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¼˜åŒ–

PostgreSQL 18å¼•å…¥äº†è™šæ‹Ÿç”Ÿæˆåˆ—ï¼ˆVirtual Generated Columnsï¼‰ï¼Œä¼˜åŒ–å™¨çŽ°åœ¨èƒ½å¤Ÿä¸ºè™šæ‹Ÿç”Ÿæˆåˆ—æ”¶é›†å’Œç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯ã€‚

**è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¿¡æ¯**ï¼š

```sql
-- åˆ›å»ºå¸¦è™šæ‹Ÿç”Ÿæˆåˆ—çš„è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE NOTICE 'è¡¨ products å·²å­˜åœ¨';
        ELSE
            CREATE TABLE products (
                id SERIAL PRIMARY KEY,
                name VARCHAR(100),
                price DECIMAL(10,2),
                discount DECIMAL(5,2),
                final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) STORED
            );
            RAISE NOTICE 'è¡¨ products åˆ›å»ºæˆåŠŸï¼ˆå¸¦è™šæ‹Ÿç”Ÿæˆåˆ—ï¼‰';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ products å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸ºè™šæ‹Ÿç”Ÿæˆåˆ—æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ”¶é›†ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        ANALYZE products;
        RAISE NOTICE 'è¡¨ products ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹è™šæ‹Ÿç”Ÿæˆåˆ—çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count FROM pg_stats WHERE tablename = 'products' AND attname = 'final_price';
        IF stats_count = 0 THEN
            RAISE WARNING 'è™šæ‹Ÿç”Ÿæˆåˆ— final_price çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ°è™šæ‹Ÿç”Ÿæˆåˆ— final_price çš„ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs
FROM pg_stats
WHERE tablename = 'products'
AND attname = 'final_price';

-- ä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºè™šæ‹Ÿç”Ÿæˆåˆ—æŸ¥è¯¢ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è™šæ‹Ÿç”Ÿæˆåˆ—æŸ¥è¯¢ä¼˜åŒ–æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM products
WHERE final_price BETWEEN 50 AND 100;
```

**ä¼˜åŠ¿**ï¼š

- ä¼˜åŒ–å™¨èƒ½å¤Ÿå‡†ç¡®ä¼°è®¡åŸºäºŽè™šæ‹Ÿç”Ÿæˆåˆ—çš„æŸ¥è¯¢é€‰æ‹©æ€§
- æ”¯æŒåœ¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•å¹¶åˆ©ç”¨ç»Ÿè®¡ä¿¡æ¯
- è‡ªåŠ¨ç»´æŠ¤è™šæ‹Ÿç”Ÿæˆåˆ—çš„ç»Ÿè®¡ä¿¡æ¯

### 8.2 æ”¹è¿›çš„å¤šå˜é‡ç»Ÿè®¡å‡†ç¡®æ€§

PostgreSQL 18æ”¹è¿›äº†å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†é«˜åº¦ç›¸å…³çš„åˆ—æ—¶ã€‚

**å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯æ”¹è¿›**ï¼š

```sql
-- åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_statistic_ext WHERE stxrelid = 'products'::regclass AND stxname = 'products_stats') THEN
            RAISE NOTICE 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_stats å·²å­˜åœ¨';
        ELSE
            CREATE STATISTICS products_stats (dependencies, ndistinct)
            ON price, discount, final_price
            FROM products;
            RAISE NOTICE 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_stats åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_stats å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æ”¶é›†æ‰©å±•ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ”¶é›†æ‰©å±•ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        ANALYZE products;
        RAISE NOTICE 'è¡¨ products æ‰©å±•ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†æ‰©å±•ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count FROM pg_statistic_ext WHERE stxrelid = 'products'::regclass;
        IF stats_count = 0 THEN
            RAISE WARNING 'è¡¨ products æ²¡æœ‰å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯', stats_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    stxname,
    stxkeys,
    stxdependencies,
    stxndistinct
FROM pg_statistic_ext
WHERE stxrelid = 'products'::regclass;

-- æŸ¥è¯¢ä¼˜åŒ–å™¨åˆ©ç”¨å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºæŸ¥è¯¢ä¼˜åŒ–å™¨åˆ©ç”¨å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM products
WHERE price > 100 AND discount > 10 AND final_price < 90;
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´å‡†ç¡®çš„åˆ—ç›¸å…³æ€§ä¼°è®¡
- æ›´å¥½çš„å¤åˆæ¡ä»¶é€‰æ‹©æ€§ä¼°è®¡
- å‡å°‘å› ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´çš„æŸ¥è¯¢è®¡åˆ’é€‰æ‹©é”™è¯¯

### 8.3 æ›´ç²¾ç»†çš„ç›´æ–¹å›¾

PostgreSQL 18æ”¹è¿›äº†ç›´æ–¹å›¾çš„ç²¾åº¦ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†åæ€åˆ†å¸ƒæ•°æ®æ—¶ã€‚

**ç›´æ–¹å›¾æ”¹è¿›**ï¼š

```sql
-- æŸ¥çœ‹æ”¹è¿›çš„ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count FROM pg_stats WHERE tablename = 'products' AND attname = 'price';
        IF stats_count = 0 THEN
            RAISE WARNING 'åˆ— price çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ°åˆ— price çš„ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    attname,
    n_distinct,
    histogram_bounds,
    array_length(histogram_bounds, 1) as bucket_count
FROM pg_stats
WHERE tablename = 'products'
AND attname = 'price';

-- é…ç½®æ›´é«˜çš„ç»Ÿè®¡ç›®æ ‡ä»¥èŽ·å¾—æ›´ç²¾ç»†çš„ç›´æ–¹å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®ç»Ÿè®¡ç›®æ ‡';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'products' AND column_name = 'price') THEN
            RAISE WARNING 'åˆ— price ä¸å­˜åœ¨';
            RETURN;
        END IF;

        ALTER TABLE products ALTER COLUMN price SET STATISTICS 1000;
        RAISE NOTICE 'åˆ— price çš„ç»Ÿè®¡ç›®æ ‡å·²è®¾ç½®ä¸º1000';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ— price ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®ç»Ÿè®¡ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;

    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ”¶é›†ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        ANALYZE products;
        RAISE NOTICE 'è¡¨ products ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹æ›´ç²¾ç»†çš„ç›´æ–¹å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æ›´ç²¾ç»†çš„ç›´æ–¹å›¾';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count FROM pg_stats WHERE tablename = 'products' AND attname = 'price';
        IF stats_count = 0 THEN
            RAISE WARNING 'åˆ— price çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ°åˆ— price çš„æ›´ç²¾ç»†ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æ›´ç²¾ç»†ç›´æ–¹å›¾å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    attname,
    array_length(histogram_bounds, 1) as bucket_count,
    histogram_bounds[1:5] as first_buckets,
    histogram_bounds[array_length(histogram_bounds, 1)-4:array_length(histogram_bounds, 1)] as last_buckets
FROM pg_stats
WHERE tablename = 'products'
AND attname = 'price';
```

**æ”¹è¿›ç‚¹**ï¼š

- æ”¯æŒæ›´å¤šç›´æ–¹å›¾æ¡¶ï¼ˆæœ€é«˜10000ï¼‰
- æ›´æ™ºèƒ½çš„æ¡¶è¾¹ç•Œé€‰æ‹©
- æ›´å¥½çš„åæ€åˆ†å¸ƒå¤„ç†

### 8.4 è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°

PostgreSQL 18å¼•å…¥äº†æ›´æ™ºèƒ½çš„ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥ï¼Œæ ¹æ®æ•°æ®å˜åŒ–è‡ªåŠ¨è°ƒæ•´æ›´æ–°é¢‘çŽ‡ã€‚

**è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼š

```sql
-- æŸ¥çœ‹è¡¨çš„ä¿®æ”¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹è¡¨çš„ä¿®æ”¹ç»Ÿè®¡';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO table_count FROM pg_stat_user_tables WHERE tablename = 'products';
        IF table_count = 0 THEN
            RAISE WARNING 'è¡¨ products çš„ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ°è¡¨ products çš„ä¿®æ”¹ç»Ÿè®¡ä¿¡æ¯';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨çš„ä¿®æ”¹ç»Ÿè®¡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_autoanalyze,
    last_analyze
FROM pg_stat_user_tables
WHERE tablename = 'products';

-- é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é˜ˆå€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é˜ˆå€¼';
            RETURN;
        END IF;

        ALTER TABLE products SET (
            autovacuum_analyze_scale_factor = 0.05,
            autovacuum_analyze_threshold = 1000
        );
        RAISE NOTICE 'è¡¨ products çš„è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é˜ˆå€¼å·²é…ç½®';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é˜ˆå€¼å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é¢‘çŽ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count FROM pg_stat_user_tables WHERE schemaname = 'public';
        IF table_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°public schemaä¸‹çš„è¡¨ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯', table_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é¢‘çŽ‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    tablename,
    last_analyze,
    last_autoanalyze,
    analyze_count,
    autoanalyze_count,
    CASE
        WHEN last_autoanalyze IS NULL THEN 'Never'
        WHEN last_autoanalyze > NOW() - INTERVAL '1 day' THEN 'Recent'
        WHEN last_autoanalyze > NOW() - INTERVAL '7 days' THEN 'Weekly'
        ELSE 'Stale'
    END as analyze_status
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY last_autoanalyze DESC NULLS LAST;
```

**æ”¹è¿›ç‚¹**ï¼š

- æ ¹æ®æ•°æ®å˜åŒ–çŽ‡è‡ªåŠ¨è°ƒæ•´æ›´æ–°é¢‘çŽ‡
- å‡å°‘ä¸å¿…è¦çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å¼€é”€
- æé«˜ç»Ÿè®¡ä¿¡æ¯çš„æ—¶æ•ˆæ€§

### 8.5 å¼‚æ­¥I/Oæå‡ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡äº†ç»Ÿè®¡ä¿¡æ¯æ”¶é›†çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§è¡¨ä¸Šã€‚

**å¼‚æ­¥I/Oåœ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ä¸­çš„åº”ç”¨**ï¼š

```sql
-- å¯ç”¨å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4  -- ç»´æŠ¤æ“ä½œçš„I/Oå·¥ä½œè¿›ç¨‹æ•°
DO $$
DECLARE
    pg_version INT;
    io_workers TEXT;
BEGIN
    BEGIN
        SELECT current_setting('server_version_num')::INT INTO pg_version;
        IF pg_version < 180000 THEN
            RAISE WARNING 'å¼‚æ­¥I/Oéœ€è¦PostgreSQL 18+ï¼Œå½“å‰ç‰ˆæœ¬: %', version();
            RETURN;
        END IF;

        SELECT setting INTO io_workers FROM pg_settings WHERE name = 'maintenance_io_workers';
        RAISE NOTICE 'å½“å‰maintenance_io_workersé…ç½®: %', io_workers;
        RAISE NOTICE 'æç¤ºï¼šåœ¨postgresql.confä¸­è®¾ç½®maintenance_io_workers = 4ä»¥å¯ç”¨å¼‚æ­¥I/O';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å¼‚æ­¥I/Oé…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å¤§è¡¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½å¯¹æ¯”';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå¤§è¡¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½å¯¹æ¯”';
        RAISE NOTICE 'æç¤ºï¼šä¼ ç»ŸåŒæ­¥I/Oå¯èƒ½éœ€è¦60ç§’ï¼Œå¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰å¯èƒ½åªéœ€è¦20-30ç§’';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½å¯¹æ¯”æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¼ ç»ŸåŒæ­¥I/Oï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒANALYZE';
            RETURN;
        END IF;
        -- ANALYZE large_table;  -- å‡è®¾éœ€è¦60ç§’ï¼ˆå®žé™…æ‰§è¡Œæ—¶å–æ¶ˆæ³¨é‡Šï¼‰
        RAISE NOTICE 'ä¼ ç»ŸåŒæ­¥I/O ANALYZE large_tableï¼ˆå‡è®¾éœ€è¦60ç§’ï¼‰';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰§è¡ŒANALYZEå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- é…ç½®å¼‚æ­¥I/OåŽï¼ŒåŒæ ·çš„æ“ä½œå¯èƒ½åªéœ€è¦20-30ç§’
DO $$
DECLARE
    pg_version INT;
BEGIN
    BEGIN
        SELECT current_setting('server_version_num')::INT INTO pg_version;
        IF pg_version < 180000 THEN
            RAISE WARNING 'å¼‚æ­¥I/Oéœ€è¦PostgreSQL 18+ï¼Œå½“å‰ç‰ˆæœ¬: %', version();
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒANALYZE';
            RETURN;
        END IF;
        -- ANALYZE large_table;  -- æ€§èƒ½æå‡2-3å€ï¼ˆå®žé™…æ‰§è¡Œæ—¶å–æ¶ˆæ³¨é‡Šï¼‰
        RAISE NOTICE 'å¼‚æ­¥I/O ANALYZE large_tableï¼ˆæ€§èƒ½æå‡2-3å€ï¼Œå¯èƒ½åªéœ€è¦20-30ç§’ï¼‰';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰§è¡ŒANALYZEå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    analyze_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO analyze_count
        FROM pg_stat_activity
        WHERE query LIKE '%ANALYZE%'
        AND state = 'active';

        IF analyze_count > 0 THEN
            RAISE NOTICE 'å‘çŽ° % ä¸ªANALYZEè¿›ç¨‹æ­£åœ¨è¿è¡Œ', analyze_count;
        ELSE
            RAISE NOTICE 'å½“å‰æ²¡æœ‰ANALYZEè¿›ç¨‹åœ¨è¿è¡Œ';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE query LIKE '%ANALYZE%'
AND state = 'active';
```

**æ€§èƒ½æå‡**ï¼š

- å¤§è¡¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†é€Ÿåº¦æå‡2-3å€
- å‡å°‘ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å¯¹æ­£å¸¸æŸ¥è¯¢çš„å½±å“
- æ”¯æŒå¹¶è¡Œç»Ÿè®¡ä¿¡æ¯æ”¶é›†

## 9. ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

### 9.1 ç»Ÿè®¡ä¿¡æ¯è´¨é‡è¯„ä¼°

```sql
-- ç»Ÿè®¡ä¿¡æ¯è´¨é‡è¯„ä¼°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stats_count FROM pg_stats WHERE schemaname = 'public';
        IF stats_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°public schemaä¸‹çš„ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % æ¡ç»Ÿè®¡ä¿¡æ¯ï¼Œå¼€å§‹è´¨é‡è¯„ä¼°', stats_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç»Ÿè®¡ä¿¡æ¯è´¨é‡è¯„ä¼°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    CASE
        WHEN n_distinct = -1 THEN 'ALL_DISTINCT'
        WHEN n_distinct = 0 THEN 'NO_DISTINCT'
        ELSE 'PARTIAL_DISTINCT'
    END as distinct_status,
    CASE
        WHEN correlation IS NULL THEN 'NO_CORRELATION'
        WHEN abs(correlation) > 0.8 THEN 'HIGH_CORRELATION'
        WHEN abs(correlation) > 0.5 THEN 'MEDIUM_CORRELATION'
        ELSE 'LOW_CORRELATION'
    END as correlation_status
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename, attname;
```

### 9.2 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥

```sql
-- åˆ›å»ºç»Ÿè®¡ä¿¡æ¯æ›´æ–°å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_table_stats(table_name text)
RETURNS void AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF table_name IS NULL OR TRIM(table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    -- è¡¨åæ ¼å¼éªŒè¯ï¼ˆé˜²æ­¢SQLæ³¨å…¥ï¼‰
    IF table_name !~ '^[a-zA-Z_][a-zA-Z0-9_]*$' THEN
        RAISE EXCEPTION 'è¡¨åæ ¼å¼æ— æ•ˆ: %', table_name;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = update_table_stats.table_name
    ) THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', table_name;
    END IF;

    BEGIN
        EXECUTE format('ANALYZE %I', table_name);
        RAISE NOTICE 'Updated statistics for table: %', table_name;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', table_name;
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡ŒANALYZE: %', table_name;
        WHEN OTHERS THEN
            RAISE EXCEPTION 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: % (é”™è¯¯: %)', table_name, SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'update_table_statsæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰¹é‡æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    r RECORD;
    success_count INT := 0;
    error_count INT := 0;
BEGIN
    BEGIN
        FOR r IN
            SELECT tablename
            FROM pg_tables
            WHERE schemaname = 'public'
        LOOP
            BEGIN
                PERFORM update_table_stats(r.tablename);
                success_count := success_count + 1;
            EXCEPTION
                WHEN OTHERS THEN
                    error_count := error_count + 1;
                    RAISE WARNING 'æ›´æ–°è¡¨ % çš„ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', r.tablename, SQLERRM;
            END;
        END LOOP;

        RAISE NOTICE 'æ‰¹é‡æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å®Œæˆ: æˆåŠŸ %, å¤±è´¥ %', success_count, error_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ‰¹é‡æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 9.3 ç»Ÿè®¡ä¿¡æ¯ç›‘æŽ§

```sql
-- ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION monitor_stats()
RETURNS TABLE(
    table_name text,
    last_analyze timestamp,
    analyze_count bigint,
    autoanalyze_count bigint,
    days_since_analyze numeric
)
LANGUAGE plpgsql
AS $$
BEGIN
    BEGIN
        RETURN QUERY
        SELECT
            COALESCE(t.tablename, 'unknown')::text,
            s.last_analyze,
            COALESCE(s.analyze_count, 0)::bigint,
            COALESCE(s.autoanalyze_count, 0)::bigint,
            CASE
                WHEN s.last_analyze IS NULL THEN NULL::numeric
                ELSE COALESCE(
                    EXTRACT(EPOCH FROM (NOW() - s.last_analyze)) / 86400.0,
                    0
                )
            END::numeric as days_since_analyze
        FROM pg_tables t
        LEFT JOIN pg_stat_user_tables s
            ON t.schemaname = s.schemaname
            AND t.tablename = s.relname
        WHERE t.schemaname = 'public'
          AND t.tablename IS NOT NULL
        ORDER BY
            CASE
                WHEN s.last_analyze IS NULL THEN 1
                ELSE 0
            END,
            days_since_analyze DESC NULLS LAST;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'monitor_statsæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;

-- ä½¿ç”¨ç›‘æŽ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO result_count FROM monitor_stats();
        IF result_count = 0 THEN
            RAISE WARNING 'ç›‘æŽ§å‡½æ•°æœªè¿”å›žä»»ä½•ç»“æžœ';
        ELSE
            RAISE NOTICE 'ç›‘æŽ§å‡½æ•°è¿”å›ž % æ¡è®°å½•', result_count;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è°ƒç”¨ç›‘æŽ§å‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

SELECT * FROM monitor_stats();
```

## 10. å®žé™…åº”ç”¨æ¡ˆä¾‹

### 10.1 å¤§æ•°æ®è¡¨ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

```sql
-- å¤§è¡¨ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE NOTICE 'è¡¨ large_table å·²å­˜åœ¨';
        ELSE
            CREATE TABLE large_table (
                id BIGSERIAL PRIMARY KEY,
                category_id INTEGER,
                value DECIMAL(10,2),
                created_at TIMESTAMP DEFAULT NOW()
            );
            RAISE NOTICE 'è¡¨ large_table åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ large_table å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¡¨ large_table å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- åˆ†åŒºè¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'log_entries') THEN
            RAISE NOTICE 'è¡¨ log_entries å·²å­˜åœ¨';
        ELSE
            CREATE TABLE log_entries (
                id BIGSERIAL,
                log_time TIMESTAMP,
                level VARCHAR(10),
                message TEXT
            ) PARTITION BY RANGE (log_time);
            RAISE NOTICE 'åˆ†åŒºè¡¨ log_entries åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ log_entries å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºåˆ†åŒºè¡¨ log_entries å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ä¸ºåˆ†åŒºè¡¨æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    r RECORD;
    partition_count INT := 0;
    success_count INT := 0;
    error_count INT := 0;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO partition_count
        FROM pg_tables
        WHERE tablename LIKE 'log_entries_%';

        IF partition_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ° log_entries çš„åˆ†åŒºè¡¨';
            RETURN;
        END IF;

        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªåˆ†åŒºè¡¨ï¼Œå¼€å§‹æ”¶é›†ç»Ÿè®¡ä¿¡æ¯', partition_count;

        FOR r IN
            SELECT schemaname, tablename
            FROM pg_tables
            WHERE tablename LIKE 'log_entries_%'
        LOOP
            BEGIN
                EXECUTE format('ANALYZE %I.%I', r.schemaname, r.tablename);
                success_count := success_count + 1;
            EXCEPTION
                WHEN undefined_table THEN
                    error_count := error_count + 1;
                    RAISE WARNING 'åˆ†åŒºè¡¨ %.% ä¸å­˜åœ¨', r.schemaname, r.tablename;
                WHEN insufficient_privilege THEN
                    error_count := error_count + 1;
                    RAISE WARNING 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ†æžåˆ†åŒºè¡¨ %.%', r.schemaname, r.tablename;
                WHEN OTHERS THEN
                    error_count := error_count + 1;
                    RAISE WARNING 'åˆ†æžåˆ†åŒºè¡¨ %.% å¤±è´¥: %', r.schemaname, r.tablename, SQLERRM;
            END;
        END LOOP;

        RAISE NOTICE 'åˆ†åŒºè¡¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å®Œæˆ: æˆåŠŸ %, å¤±è´¥ %', success_count, error_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ä¸ºåˆ†åŒºè¡¨æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 10.2 åŠ¨æ€ç»Ÿè®¡ä¿¡æ¯è°ƒæ•´

```sql
-- åŠ¨æ€è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
-- è°ƒæ•´ç»Ÿè®¡ç›®æ ‡å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION adjust_stats_target(
    p_table_name text,
    p_column_name text,
    p_target integer
)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_table_name IS NULL OR TRIM(p_table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_column_name IS NULL OR TRIM(p_column_name) = '' THEN
        RAISE EXCEPTION 'åˆ—åä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_target IS NULL THEN
        RAISE EXCEPTION 'ç»Ÿè®¡ç›®æ ‡å€¼ä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_target < 0 OR p_target > 10000 THEN
        RAISE EXCEPTION 'ç»Ÿè®¡ç›®æ ‡å€¼å¿…é¡»åœ¨0-10000ä¹‹é—´: %', p_target;
    END IF;

    -- è¡¨åå’Œåˆ—åæ ¼å¼éªŒè¯ï¼ˆé˜²æ­¢SQLæ³¨å…¥ï¼‰
    IF p_table_name !~ '^[a-zA-Z_][a-zA-Z0-9_]*$' THEN
        RAISE EXCEPTION 'è¡¨åæ ¼å¼æ— æ•ˆ: %', p_table_name;
    END IF;

    IF p_column_name !~ '^[a-zA-Z_][a-zA-Z0-9_]*$' THEN
        RAISE EXCEPTION 'åˆ—åæ ¼å¼æ— æ•ˆ: %', p_column_name;
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = p_table_name
    ) THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', p_table_name;
    END IF;

    -- æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = p_table_name
          AND column_name = p_column_name
    ) THEN
        RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨: %.%', p_table_name, p_column_name;
    END IF;

    BEGIN
        -- è®¾ç½®ç»Ÿè®¡ç›®æ ‡
        BEGIN
            EXECUTE format(
                'ALTER TABLE %I ALTER COLUMN %I SET STATISTICS %s',
                p_table_name, p_column_name, p_target
            );
        EXCEPTION
            WHEN undefined_table THEN
                RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', p_table_name;
            WHEN undefined_column THEN
                RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨: %.%', p_table_name, p_column_name;
            WHEN OTHERS THEN
                RAISE EXCEPTION 'è®¾ç½®ç»Ÿè®¡ç›®æ ‡å¤±è´¥: %', SQLERRM;
        END;

        -- æ‰§è¡ŒANALYZE
        BEGIN
            EXECUTE format('ANALYZE %I', p_table_name);
        EXCEPTION
            WHEN insufficient_privilege THEN
                RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡ŒANALYZE: %', p_table_name;
            WHEN OTHERS THEN
                RAISE WARNING 'æ‰§è¡ŒANALYZEå¤±è´¥: % (é”™è¯¯: %), ç»Ÿè®¡ç›®æ ‡å·²è®¾ç½®', p_table_name, SQLERRM;
        END;

        RAISE NOTICE 'ç»Ÿè®¡ç›®æ ‡è°ƒæ•´æˆåŠŸ: %.% = %', p_table_name, p_column_name, p_target;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'adjust_stats_targetæ‰§è¡Œå¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'adjust_stats_targetæ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$;

-- ä½¿ç”¨åŠ¨æ€è°ƒæ•´
SELECT adjust_stats_target('employees', 'salary', 1000);
SELECT adjust_stats_target('employees', 'dept_id', 100);
```

### 10.3 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯æœ€ä½³å®žè·µ

**æœ€ä½³å®žè·µæ€»ç»“**ï¼š

```sql
-- 1. ä¸ºå…³é”®åˆ—è®¾ç½®åˆé€‚çš„ç»Ÿè®¡ç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®ç»Ÿè®¡ç›®æ ‡';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'products' AND column_name = 'price') THEN
            RAISE WARNING 'åˆ— price ä¸å­˜åœ¨';
        ELSE
            ALTER TABLE products ALTER COLUMN price SET STATISTICS 500;
            RAISE NOTICE 'åˆ— price çš„ç»Ÿè®¡ç›®æ ‡å·²è®¾ç½®ä¸º500';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'products' AND column_name = 'category_id') THEN
            RAISE WARNING 'åˆ— category_id ä¸å­˜åœ¨';
        ELSE
            ALTER TABLE products ALTER COLUMN category_id SET STATISTICS 100;
            RAISE NOTICE 'åˆ— category_id çš„ç»Ÿè®¡ç›®æ ‡å·²è®¾ç½®ä¸º100';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE WARNING 'æŒ‡å®šåˆ—ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ç›®æ ‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ç”¨äºŽå¤åˆæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_statistic_ext WHERE stxrelid = 'products'::regclass AND stxname = 'products_multi_stats') THEN
            RAISE NOTICE 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_multi_stats å·²å­˜åœ¨';
        ELSE
            CREATE STATISTICS products_multi_stats (dependencies, ndistinct)
            ON price, category_id, discount
            FROM products;
            RAISE NOTICE 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_multi_stats åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_object THEN
            RAISE WARNING 'å¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯ products_multi_stats å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå¤šå˜é‡ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä¸ºè™šæ‹Ÿç”Ÿæˆåˆ—æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•æ”¶é›†ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        ANALYZE products;  -- è‡ªåŠ¨æ”¶é›†è™šæ‹Ÿç”Ÿæˆåˆ—ç»Ÿè®¡ä¿¡æ¯
        RAISE NOTICE 'è¡¨ products ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æˆåŠŸï¼ˆåŒ…æ‹¬è™šæ‹Ÿç”Ÿæˆåˆ—ï¼‰';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. é…ç½®è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'products') THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨ï¼Œæ— æ³•é…ç½®è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°';
            RETURN;
        END IF;

        ALTER TABLE products SET (
            autovacuum_analyze_scale_factor = 0.05,
            autovacuum_analyze_threshold = 1000
        );
        RAISE NOTICE 'è¡¨ products çš„è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å·²é…ç½®';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ products ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®è‡ªé€‚åº”ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 5. åˆ©ç”¨å¼‚æ­¥I/Oæå‡å¤§è¡¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4
DO $$
DECLARE
    pg_version INT;
    io_workers TEXT;
BEGIN
    BEGIN
        SELECT current_setting('server_version_num')::INT INTO pg_version;
        IF pg_version < 180000 THEN
            RAISE WARNING 'å¼‚æ­¥I/Oéœ€è¦PostgreSQL 18+ï¼Œå½“å‰ç‰ˆæœ¬: %', version();
            RETURN;
        END IF;

        SELECT setting INTO io_workers FROM pg_settings WHERE name = 'maintenance_io_workers';
        RAISE NOTICE 'å½“å‰maintenance_io_workersé…ç½®: %', io_workers;
        RAISE NOTICE 'æç¤ºï¼šåœ¨postgresql.confä¸­è®¾ç½®maintenance_io_workers = 4ä»¥å¯ç”¨å¼‚æ­¥I/O';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å¼‚æ­¥I/Oé…ç½®å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- 6. å®šæœŸç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯è´¨é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO stats_count FROM pg_stats WHERE schemaname = 'public';
        IF stats_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°public schemaä¸‹çš„ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;
        RAISE NOTICE 'æ‰¾åˆ° % æ¡ç»Ÿè®¡ä¿¡æ¯ï¼Œå¼€å§‹è´¨é‡ç›‘æŽ§', stats_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æŽ§ç»Ÿè®¡ä¿¡æ¯è´¨é‡å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    CASE
        WHEN n_distinct = -1 THEN 'All Distinct'
        WHEN n_distinct = 0 THEN 'No Distinct'
        WHEN n_distinct < 10 THEN 'Low Cardinality'
        ELSE 'High Cardinality'
    END as cardinality_status,
    CASE
        WHEN correlation IS NULL THEN 'No Correlation'
        WHEN abs(correlation) > 0.8 THEN 'High Correlation'
        WHEN abs(correlation) > 0.5 THEN 'Medium Correlation'
        ELSE 'Low Correlation'
    END as correlation_status
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename, attname;
```

## 11. ç›¸å…³æ¦‚å¿µ

### 11.1 ä¸Šä½æ¦‚å¿µ

- **æŸ¥è¯¢ä¼˜åŒ–**: æ›´å¹¿æ³›çš„æŸ¥è¯¢ä¼˜åŒ–æœºåˆ¶
- **æ•°æ®åº“ç»Ÿè®¡**: æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ç®¡ç†
- **æ€§èƒ½åˆ†æž**: æ€§èƒ½åˆ†æžå’Œä¼˜åŒ–

### 11.2 ä¸‹ä½æ¦‚å¿µ

- **ç›´æ–¹å›¾**: æ•°æ®åˆ†å¸ƒè¡¨ç¤º
- **ç›¸å…³æ€§**: åˆ—é—´å…³ç³»åº¦é‡
- **é€‰æ‹©æ€§**: æŸ¥è¯¢æ¡ä»¶é€‰æ‹©æ€§
- **åŸºæ•°ä¼°è®¡**: ç»“æžœé›†å¤§å°ä¼°è®¡

### 11.3 å¹³è¡Œæ¦‚å¿µ

- **é‡‡æ ·**: æ•°æ®é‡‡æ ·æŠ€æœ¯
- **è¿‘ä¼¼ç®—æ³•**: è¿‘ä¼¼ç»Ÿè®¡ç®—æ³•
- **æœºå™¨å­¦ä¹ **: åŸºäºŽMLçš„ç»Ÿè®¡ä¼°è®¡

## 12. å‚è€ƒæ–‡çŒ®

1. Ioannidis, Y. E. (1996). Query optimization. ACM Computing Surveys, 28(1), 121-123.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. Selinger, P. G., et al. (1979). Access path selection in a relational database management system. ACM SIGMOD Record, 8(2), 23-34.
4. Chaudhuri, S. (1998). An overview of query optimization in relational systems. ACM PODS, 34-43.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

## 13. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŽŸç†](./02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŽŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–ç†è®ºåŸºç¡€
- â­â­â­ [æ‰§è¡Œè®¡åˆ’ä¸Žæ€§èƒ½è°ƒä¼˜](./02.04-æ‰§è¡Œè®¡åˆ’ä¸Žæ€§èƒ½è°ƒä¼˜.md) - æ‰§è¡Œè®¡åˆ’åˆ†æžå®žè·µ
- â­â­ [ç´¢å¼•ç»“æž„ä¸Žä¼˜åŒ–](./02.02-ç´¢å¼•ç»“æž„ä¸Žä¼˜åŒ–.md) - ç´¢å¼•é€‰æ‹©ä¼˜åŒ–
- â­â­ [å­˜å‚¨ç®¡ç†ä¸Žæ•°æ®æŒä¹…åŒ–](../../../04-å­˜å‚¨ä¸Žæ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸Žæ•°æ®æŒä¹…åŒ–.md) - åˆ—å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯ã€åˆ—å­˜å‚¨ä»£ä»·ä¼°ç®—ðŸ†•
- â­â­ [æ•°æ®æ¨¡åž‹è®¾è®¡](../../../17-æ•°æ®æ¨¡åž‹è®¾è®¡/README.md) - ç»Ÿè®¡åˆ†æžå®žè·µ
- â­â­ [æ€§èƒ½è°ƒä¼˜å®žè·µ](../../../11-éƒ¨ç½²æž¶æž„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®žè·µ.md) - æ€§èƒ½è°ƒä¼˜è¯¦ç»†æŒ‡å—
- â­ [ç›‘æŽ§ä¸Žè¯Šæ–­](../../../12-ç›‘æŽ§ä¸Žè¯Šæ–­/README.md) - ç»Ÿè®¡ä¿¡æ¯ç›‘æŽ§

### å¤–éƒ¨èµ„æº

- [PostgreSQLç»Ÿè®¡ä¿¡æ¯æ–‡æ¡£](https://www.postgresql.org/docs/current/planner-stats.html)
- [PostgreSQLæŸ¥è¯¢é…ç½®æ–‡æ¡£](https://www.postgresql.org/docs/current/runtime-config-query.html)
- [PostgreSQLç»Ÿè®¡ä¿¡æ¯æœ€ä½³å®žè·µ](https://wiki.postgresql.org/wiki/Statistics)

---

## 14. Wikidataå¯¹é½

### 14.1 ç»Ÿè®¡ä¿¡æ¯æ¦‚å¿µå¯¹é½

- **Wikidata ID**: Q192490 (Database statistics)
- **ç›¸å…³å±žæ€§**:
  - P31: Q192490 (instance of: database metadata)
  - P361: Q176165 (part of: database management system)
- **å¤–éƒ¨é“¾æŽ¥**:
  - [Wikipedia - Database statistics](https://en.wikipedia.org/wiki/Database_statistics)

### 14.2 PostgreSQLç»Ÿè®¡ä¿¡æ¯å¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±žæ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æŽ¥**:
  - <https://www.postgresql.org/docs/current/planner-stats.html>
  - <https://www.postgresql.org/docs/current/runtime-config-query.html>

---

## 15. å½¢å¼è¯æ˜Žä¸Žç†è®ºè®ºè¯

### 15.1 é€‰æ‹©æ€§ä¼°è®¡å‡†ç¡®æ€§è¯æ˜Ž

**å®šç†**: åœ¨å‡åŒ€åˆ†å¸ƒå‡è®¾ä¸‹ï¼Œç­‰å€¼æŸ¥è¯¢çš„é€‰æ‹©æ€§ä¼°è®¡ä¸º 1/ndistinctï¼Œå…¶ä¸­ ndistinct ä¸ºä¸åŒå€¼æ•°é‡ã€‚

**è¯æ˜Ž**:

```latex
\begin{theorem}[é€‰æ‹©æ€§ä¼°è®¡å‡†ç¡®æ€§]
è®¾è¡¨ R æœ‰ n ä¸ªå…ƒç»„ï¼Œå±žæ€§ A æœ‰ ndistinct ä¸ªä¸åŒå€¼ï¼ŒæŸ¥è¯¢æ¡ä»¶ä¸º A = aã€‚

å‡åŒ€åˆ†å¸ƒå‡è®¾ï¼š
\forall v \in \text{Values}(A): P(A = v) = \frac{1}{\text{ndistinct}}

é€‰æ‹©æ€§ä¼°è®¡ï¼š
\text{Selectivity}(A = a) = P(A = a) = \frac{1}{\text{ndistinct}}

ç»“æžœé›†å¤§å°ä¼°è®¡ï¼š
|\sigma_{A=a}(R)| = n \times \text{Selectivity}(A = a) = \frac{n}{\text{ndistinct}}

åœ¨å‡åŒ€åˆ†å¸ƒå‡è®¾ä¸‹ï¼Œè¯¥ä¼°è®¡æ˜¯å‡†ç¡®çš„ã€‚

å¯¹äºŽåæ–œåˆ†å¸ƒï¼Œä½¿ç”¨æœ€å¸¸å€¼(MCV)ç»Ÿè®¡å¯ä»¥æé«˜ä¼°è®¡å‡†ç¡®æ€§ã€‚
\end{theorem}
```

### 15.2 ä»£ä»·æ¨¡åž‹æœ€ä¼˜æ€§è¯æ˜Ž

**å®šç†**: åŸºäºŽç»Ÿè®¡ä¿¡æ¯çš„ä»£ä»·æ¨¡åž‹å¯ä»¥æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜æ‰§è¡Œè®¡åˆ’ã€‚

**è¯æ˜Ž**:

```latex
\begin{theorem}[ä»£ä»·æ¨¡åž‹æœ€ä¼˜æ€§]
è®¾æŸ¥è¯¢ Q çš„æ‰€æœ‰å¯èƒ½æ‰§è¡Œè®¡åˆ’é›†åˆä¸º \mathcal{P}ï¼Œä»£ä»·å‡½æ•°ä¸º \cost: \mathcal{P} \rightarrow \mathbb{R}^+ã€‚

æœ€ä¼˜æ‰§è¡Œè®¡åˆ’ï¼š
\plan^* = \arg\min_{\plan \in \mathcal{P}} \cost(\plan)

ä»£ä»·å‡½æ•°å®šä¹‰ï¼š
\cost(\plan) = \cost_{IO}(\plan) + \cost_{CPU}(\plan) + \cost_{Memory}(\plan)

å…¶ä¸­ï¼š
- \cost_{IO}(\plan) = \sum_{i} \text{seq\_page\_cost} \times \text{pages}_i + \text{random\_page\_cost} \times \text{random\_pages}_i
- \cost_{CPU}(\plan) = \sum_{i} \text{cpu\_tuple\_cost} \times \text{tuples}_i + \text{cpu\_operator\_cost} \times \text{operators}_i
- \cost_{Memory}(\plan) = \text{work\_mem} \times \text{memory\_usage}

åŸºäºŽç»Ÿè®¡ä¿¡æ¯çš„ä»£ä»·ä¼°ç®—ï¼š
- ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ä¼°ç®—æ¯ä¸ªæ“ä½œçš„ä»£ä»·
- é€šè¿‡åŠ¨æ€è§„åˆ’æˆ–è´ªå¿ƒç®—æ³•æœç´¢æœ€ä¼˜è®¡åˆ’

ç”±äºŽä»£ä»·å‡½æ•°æ˜¯å•è°ƒçš„ï¼ˆå­è®¡åˆ’ä»£ä»·ç´¯åŠ ï¼‰ï¼ŒåŠ¨æ€è§„åˆ’ç®—æ³•å¯ä»¥æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜è§£ã€‚
\end{theorem}
```

### 15.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¿…è¦æ€§è¯æ˜Ž

**å®šç†**: å½“æ•°æ®åˆ†å¸ƒå‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»Ÿè®¡ä¿¡æ¯éœ€è¦æ›´æ–°ä»¥ä¿æŒæŸ¥è¯¢ä¼˜åŒ–çš„å‡†ç¡®æ€§ã€‚

**è¯æ˜Ž**:

```latex
\begin{theorem}[ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¿…è¦æ€§]
è®¾è¡¨ R åœ¨æ—¶é—´ t_0 çš„ç»Ÿè®¡ä¿¡æ¯ä¸º S_0ï¼Œåœ¨æ—¶é—´ t_1 çš„æ•°æ®åˆ†å¸ƒä¸º D_1ã€‚

æ•°æ®åˆ†å¸ƒå˜åŒ–ï¼š
å¦‚æžœ D_1 \neq D_0ï¼Œåˆ™ç»Ÿè®¡ä¿¡æ¯ S_0 ä¸å†å‡†ç¡®åæ˜  D_1ã€‚

æŸ¥è¯¢ä¼˜åŒ–å½±å“ï¼š
è®¾æŸ¥è¯¢ Q åœ¨ç»Ÿè®¡ä¿¡æ¯ S_0 ä¸‹çš„æœ€ä¼˜è®¡åˆ’ä¸º \plan_0ï¼Œåœ¨çœŸå®žåˆ†å¸ƒ D_1 ä¸‹çš„æœ€ä¼˜è®¡åˆ’ä¸º \plan_1ã€‚

å¦‚æžœ S_0 ä¸å‡†ç¡®ï¼Œåˆ™ï¼š
\cost(\plan_0, D_1) \geq \cost(\plan_1, D_1)

å³ä½¿ç”¨æ—§ç»Ÿè®¡ä¿¡æ¯é€‰æ‹©çš„è®¡åˆ’å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„ã€‚

æ›´æ–°ç»Ÿè®¡ä¿¡æ¯åŽï¼š
ä½¿ç”¨æ–°ç»Ÿè®¡ä¿¡æ¯ S_1ï¼ˆåæ˜  D_1ï¼‰é€‰æ‹©çš„è®¡åˆ’ \plan_1' æ»¡è¶³ï¼š
\cost(\plan_1', D_1) \leq \cost(\plan_0, D_1)

å› æ­¤ï¼Œç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ˜¯å¿…è¦çš„ã€‚
\end{theorem}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åŽæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æŽ¨è) â­ | 17.x (æŽ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
