---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: æŸ¥è¯¢ä¼˜åŒ–ã€æ€§èƒ½è°ƒä¼˜ã€ç³»ç»Ÿè®¾è®¡
> ğŸ†• **PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–**: æ”¹è¿›çš„æŸ¥è¯¢è®¡åˆ’å™¨ã€åŸºæ•°ä¼°è®¡å‡†ç¡®æ€§æå‡ï¼ˆè¯¯å·®ä»25%â†’15%ï¼‰ã€æ›´æ™ºèƒ½çš„JOINæ–¹æ³•é€‰æ‹©ã€è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

---

## ğŸ“‹ ç›®å½•

- [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](#æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#-å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [æŸ¥è¯¢ä¼˜åŒ–å™¨æ¶æ„å¯¹æ¯”çŸ©é˜µ](#æŸ¥è¯¢ä¼˜åŒ–å™¨æ¶æ„å¯¹æ¯”çŸ©é˜µ)
    - [è¿æ¥ç®—æ³•å¯¹æ¯”çŸ©é˜µ](#è¿æ¥ç®—æ³•å¯¹æ¯”çŸ©é˜µ)
    - [æŸ¥è¯¢é‡å†™è§„åˆ™å¯¹æ¯”çŸ©é˜µ](#æŸ¥è¯¢é‡å†™è§„åˆ™å¯¹æ¯”çŸ©é˜µ)
    - [éš”ç¦»çº§åˆ«ä¸æŸ¥è¯¢ä¼˜åŒ–å½±å“å¯¹æ¯”çŸ©é˜µ](#éš”ç¦»çº§åˆ«ä¸æŸ¥è¯¢ä¼˜åŒ–å½±å“å¯¹æ¯”çŸ©é˜µ)
  - [ğŸŒ Wikipediaå¯¹é½](#-wikipediaå¯¹é½)
    - [æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½](#æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½)
    - [å…³ç³»ä»£æ•°æ¦‚å¿µå¯¹é½](#å…³ç³»ä»£æ•°æ¦‚å¿µå¯¹é½)
    - [åŠ¨æ€è§„åˆ’æ¦‚å¿µå¯¹é½](#åŠ¨æ€è§„åˆ’æ¦‚å¿µå¯¹é½)
  - [1. å®šä¹‰ä¸å½¢å¼åŒ–](#1-å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1 æŸ¥è¯¢ä»£ä»·æ¨¡å‹](#21-æŸ¥è¯¢ä»£ä»·æ¨¡å‹)
    - [2.2 æŸ¥è¯¢é‡å†™ç†è®º](#22-æŸ¥è¯¢é‡å†™ç†è®º)
    - [2.3 è¿æ¥é¡ºåºä¼˜åŒ–](#23-è¿æ¥é¡ºåºä¼˜åŒ–)
  - [3. PostgreSQLä¼˜åŒ–å™¨æ¶æ„](#3-postgresqlä¼˜åŒ–å™¨æ¶æ„)
    - [3.1 ä¼˜åŒ–å™¨ç»„ä»¶](#31-ä¼˜åŒ–å™¨ç»„ä»¶)
    - [3.2 æŸ¥è¯¢è§£æ](#32-æŸ¥è¯¢è§£æ)
    - [3.3 ç»Ÿè®¡ä¿¡æ¯](#33-ç»Ÿè®¡ä¿¡æ¯)
  - [4. æŸ¥è¯¢é‡å†™ä¼˜åŒ–](#4-æŸ¥è¯¢é‡å†™ä¼˜åŒ–)
    - [4.1 è°“è¯ä¸‹æ¨](#41-è°“è¯ä¸‹æ¨)
      - [å“ˆå¸Œè¿æ¥ï¼ˆHash Joinï¼‰](#å“ˆå¸Œè¿æ¥hash-join)
      - [åˆå¹¶è¿æ¥ï¼ˆMerge Joinï¼‰](#åˆå¹¶è¿æ¥merge-join)
    - [5.2 è¿æ¥é¡ºåºä¼˜åŒ–](#52-è¿æ¥é¡ºåºä¼˜åŒ–)
    - [5.3 è¿æ¥ä¼˜åŒ–é…ç½®](#53-è¿æ¥ä¼˜åŒ–é…ç½®)
  - [6. ç´¢å¼•ä¼˜åŒ–](#6-ç´¢å¼•ä¼˜åŒ–)
    - [6.1 ç´¢å¼•é€‰æ‹©](#61-ç´¢å¼•é€‰æ‹©)
    - [6.2 ç´¢å¼•æ‰«æä¼˜åŒ–](#62-ç´¢å¼•æ‰«æä¼˜åŒ–)
      - [Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰](#index-scanç´¢å¼•æ‰«æ)
      - [Index Only Scanï¼ˆä»…ç´¢å¼•æ‰«æï¼‰](#index-only-scanä»…ç´¢å¼•æ‰«æ)
      - [Bitmap Index Scanï¼ˆä½å›¾ç´¢å¼•æ‰«æï¼‰](#bitmap-index-scanä½å›¾ç´¢å¼•æ‰«æ)
  - [7. èšåˆä¼˜åŒ–](#7-èšåˆä¼˜åŒ–)
    - [7.1 èšåˆç®—æ³•](#71-èšåˆç®—æ³•)
    - [7.2 çª—å£å‡½æ•°ä¼˜åŒ–](#72-çª—å£å‡½æ•°ä¼˜åŒ–)
  - [8. PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–å™¨æ–°ç‰¹æ€§](#8-postgresql-18æŸ¥è¯¢ä¼˜åŒ–å™¨æ–°ç‰¹æ€§)
    - [8.1 æ”¹è¿›çš„æŸ¥è¯¢è®¡åˆ’å™¨](#81-æ”¹è¿›çš„æŸ¥è¯¢è®¡åˆ’å™¨)
    - [8.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#82-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
    - [8.3 æ”¹è¿›çš„JOINæ–¹æ³•é€‰æ‹©](#83-æ”¹è¿›çš„joinæ–¹æ³•é€‰æ‹©)
    - [8.4 æ”¹è¿›çš„è¿æ¥é¡ºåºä¼˜åŒ–](#84-æ”¹è¿›çš„è¿æ¥é¡ºåºä¼˜åŒ–)
    - [8.5 æ”¹è¿›çš„ç´¢å¼•é€‰æ‹©](#85-æ”¹è¿›çš„ç´¢å¼•é€‰æ‹©)
    - [8.6 PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–å™¨æœ€ä½³å®è·µ](#86-postgresql-18æŸ¥è¯¢ä¼˜åŒ–å™¨æœ€ä½³å®è·µ)
  - [9. æ€§èƒ½è°ƒä¼˜](#9-æ€§èƒ½è°ƒä¼˜)
    - [9.1 ä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜](#91-ä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜)
    - [9.2 æŸ¥è¯¢æç¤º](#92-æŸ¥è¯¢æç¤º)
  - [10. å®é™…åº”ç”¨æ¡ˆä¾‹](#10-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–](#101-å¤æ‚æŸ¥è¯¢ä¼˜åŒ–)
    - [9.2 å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–](#92-å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–)
  - [11. ç›¸å…³æ¦‚å¿µ](#11-ç›¸å…³æ¦‚å¿µ)
    - [11.1 ä¸Šä½æ¦‚å¿µ](#111-ä¸Šä½æ¦‚å¿µ)
    - [11.2 ä¸‹ä½æ¦‚å¿µ](#112-ä¸‹ä½æ¦‚å¿µ)
    - [11.3 å¹³è¡Œæ¦‚å¿µ](#113-å¹³è¡Œæ¦‚å¿µ)
  - [12. ç›¸å…³æ–‡æ¡£](#12-ç›¸å…³æ–‡æ¡£)
    - [11.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#111-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
  - [13. å‚è€ƒæ–‡çŒ®](#13-å‚è€ƒæ–‡çŒ®)
  - [14. äº¤å‰å¼•ç”¨](#14-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [æŸ¥è¯¢ä¸ä¼˜åŒ–](#æŸ¥è¯¢ä¸ä¼˜åŒ–)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
      - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
  - [15. Wikidataå¯¹é½](#15-wikidataå¯¹é½)
    - [14.1 æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½](#141-æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½)
    - [14.2 PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨å¯¹é½](#142-postgresqlæŸ¥è¯¢ä¼˜åŒ–å™¨å¯¹é½)
  - [16. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯](#16-å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯)
    - [15.1 æŸ¥è¯¢é‡å†™ç­‰ä»·æ€§è¯æ˜](#151-æŸ¥è¯¢é‡å†™ç­‰ä»·æ€§è¯æ˜)
    - [15.2 è¿æ¥é¡ºåºä¼˜åŒ–æœ€ä¼˜æ€§è¯æ˜](#152-è¿æ¥é¡ºåºä¼˜åŒ–æœ€ä¼˜æ€§è¯æ˜)
    - [15.3 è°“è¯ä¸‹æ¨æ­£ç¡®æ€§è¯æ˜](#153-è°“è¯ä¸‹æ¨æ­£ç¡®æ€§è¯æ˜)
  - [åˆå¹¶æ¥æºä¸æ˜ å°„ï¼ˆæ•´åˆä¸­ï¼‰](#åˆå¹¶æ¥æºä¸æ˜ å°„æ•´åˆä¸­)
    - [å¾…åŠäº‹é¡¹](#å¾…åŠäº‹é¡¹)
      - [1. æ¥å£æè¿°ç»Ÿä¸€](#1-æ¥å£æè¿°ç»Ÿä¸€)
      - [2. å†…å®¹å»é‡](#2-å†…å®¹å»é‡)
      - [3. å½¢å¼åŒ–è¯æ˜å¤–é“¾](#3-å½¢å¼åŒ–è¯æ˜å¤–é“¾)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æŸ¥è¯¢ä¼˜åŒ–å™¨))
    ç†è®ºåŸºç¡€
      æŸ¥è¯¢ä»£ä»·æ¨¡å‹
        åŸºæ•°ä¼°è®¡
        ä»£ä»·è®¡ç®—
        ç»Ÿè®¡ä¿¡æ¯
      æŸ¥è¯¢é‡å†™ç†è®º
        ç­‰ä»·å˜æ¢
        è°“è¯ä¸‹æ¨
        å¸¸é‡æŠ˜å 
      è¿æ¥é¡ºåºä¼˜åŒ–
        åŠ¨æ€è§„åˆ’
        è´ªå¿ƒç®—æ³•
        å¯å‘å¼è§„åˆ™
    PostgreSQLæ¶æ„
      ä¼˜åŒ–å™¨ç»„ä»¶
        è§£æå™¨
        é‡å†™å™¨
        è§„åˆ’å™¨
        æ‰§è¡Œå™¨
      æŸ¥è¯¢è§£æ
        SQLè§£æ
        è¯­æ³•æ ‘
        è¯­ä¹‰åˆ†æ
      ç»Ÿè®¡ä¿¡æ¯
        è¡¨ç»Ÿè®¡
        åˆ—ç»Ÿè®¡
        ç›¸å…³æ€§ç»Ÿè®¡
    æŸ¥è¯¢é‡å†™
      è°“è¯ä¸‹æ¨
        è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–
        è¿æ¥æ¡ä»¶ä¼˜åŒ–
      å¸¸é‡æŠ˜å 
        å¸¸é‡è®¡ç®—
        è¡¨è¾¾å¼ç®€åŒ–
      è§†å›¾å±•å¼€
        è§†å›¾é‡å†™
        å­æŸ¥è¯¢ä¼˜åŒ–
    è¿æ¥ä¼˜åŒ–
      è¿æ¥ç®—æ³•
        åµŒå¥—å¾ªç¯
        å“ˆå¸Œè¿æ¥
        åˆå¹¶è¿æ¥
      è¿æ¥é¡ºåº
        åŠ¨æ€è§„åˆ’
        è´ªå¿ƒç®—æ³•
      è¿æ¥é…ç½®
        å‚æ•°è°ƒä¼˜
        æç¤ºä½¿ç”¨
    ç´¢å¼•ä¼˜åŒ–
      ç´¢å¼•é€‰æ‹©
        ä»£ä»·ä¼°ç®—
        é€‰æ‹©æ€§åˆ†æ
      æ‰«æç±»å‹
      ç´¢å¼•æ‰«æ
        Index Scan
        Index Only Scan
        Bitmap Scan
    èšåˆä¼˜åŒ–
      èšåˆç®—æ³•
        Hashèšåˆ
        Sortèšåˆ
        Groupèšåˆ
      çª—å£å‡½æ•°
        çª—å£æ¡†æ¶
        æ’åºä¼˜åŒ–
    æ€§èƒ½è°ƒä¼˜
      é…ç½®è°ƒä¼˜
        ä»£ä»·å‚æ•°
        ç»Ÿè®¡ä¿¡æ¯
      æŸ¥è¯¢æç¤º
        è¿æ¥æç¤º
        æ‰«ææç¤º
    åº”ç”¨æ¡ˆä¾‹
      å¤æ‚æŸ¥è¯¢
        å¤šè¡¨è¿æ¥
        å­æŸ¥è¯¢ä¼˜åŒ–
      å¤§æ•°æ®é‡
        åˆ†åŒºæŸ¥è¯¢
        å¹¶è¡ŒæŸ¥è¯¢
```

---

## ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### æŸ¥è¯¢ä¼˜åŒ–å™¨æ¶æ„å¯¹æ¯”çŸ©é˜µ

| ä¼˜åŒ–å™¨ç±»å‹ | ä¼˜åŒ–ç­–ç•¥ | ä»£ä»·æ¨¡å‹ | æœç´¢ç©ºé—´ | æœ€ä¼˜æ€§ä¿è¯ | é€‚ç”¨åœºæ™¯ | PostgreSQLå®ç° |
| --- | --- | --- | --- | --- | --- | --- |
| **åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨(RBO)** | è§„åˆ™åŒ¹é… | æ—  | å° | æ—  | ç®€å•æŸ¥è¯¢ | âŒ ä¸æ”¯æŒ |
| **åŸºäºä»£ä»·çš„ä¼˜åŒ–å™¨(CBO)** | ä»£ä»·ä¼°ç®— | ç»Ÿè®¡ä¿¡æ¯ | å¤§ | å±€éƒ¨æœ€ä¼˜ | å¤æ‚æŸ¥è¯¢ | âœ… é»˜è®¤ |
| **åŸºäºå­¦ä¹ çš„ä¼˜åŒ–å™¨(LBO)** | æœºå™¨å­¦ä¹  | MLæ¨¡å‹ | æå¤§ | è¿‘ä¼¼æœ€ä¼˜ | å¤§æ•°æ®é‡ | ğŸ”„ ç ”ç©¶é˜¶æ®µ |
| **æ··åˆä¼˜åŒ–å™¨** | è§„åˆ™+ä»£ä»· | æ··åˆæ¨¡å‹ | ä¸­ | å±€éƒ¨æœ€ä¼˜ | é€šç”¨åœºæ™¯ | âœ… PostgreSQL |

### è¿æ¥ç®—æ³•å¯¹æ¯”çŸ©é˜µ

| è¿æ¥ç®—æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | å‰ææ¡ä»¶ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- |
| **åµŒå¥—å¾ªç¯è¿æ¥(NLJ)** | O(nÃ—m) | O(1) | å°è¡¨è¿æ¥ | æ—  | âœ… æ”¯æŒ |
| **å“ˆå¸Œè¿æ¥(Hash Join)** | O(n+m) | O(m) | ç­‰å€¼è¿æ¥ | å†…å­˜å……è¶³ | âœ… æ”¯æŒ |
| **åˆå¹¶è¿æ¥(Merge Join)** | O(n log n + m log m) | O(1) | æœ‰åºæ•°æ® | å·²æ’åº | âœ… æ”¯æŒ |
| **ç´¢å¼•åµŒå¥—å¾ªç¯** | O(n log m) | O(1) | æœ‰ç´¢å¼• | ç´¢å¼•å­˜åœ¨ | âœ… æ”¯æŒ |

### æŸ¥è¯¢é‡å†™è§„åˆ™å¯¹æ¯”çŸ©é˜µ

| é‡å†™è§„åˆ™ | ä¼˜åŒ–æ•ˆæœ | é€‚ç”¨æ¡ä»¶ | å¤æ‚åº¦ | PostgreSQLæ”¯æŒ | ç¤ºä¾‹ |
| --- | --- | --- | --- | --- | --- |
| **è°“è¯ä¸‹æ¨** | é«˜ | è¿‡æ»¤æ¡ä»¶ | O(1) | âœ… æ”¯æŒ | WHEREä¸‹æ¨åˆ°JOINå‰ |
| **å¸¸é‡æŠ˜å ** | ä¸­ | å¸¸é‡è¡¨è¾¾å¼ | O(1) | âœ… æ”¯æŒ | 1+1 â†’ 2 |
| **è§†å›¾å±•å¼€** | ä¸­ | è§†å›¾æŸ¥è¯¢ | O(n) | âœ… æ”¯æŒ | è§†å›¾æ›¿æ¢ä¸ºåŸºè¡¨ |
| **å­æŸ¥è¯¢ä¼˜åŒ–** | é«˜ | å­æŸ¥è¯¢ | O(nÂ²) | âœ… æ”¯æŒ | EXISTS â†’ JOIN |
| **è¿æ¥æ¶ˆé™¤** | é«˜ | å†—ä½™è¿æ¥ | O(n) | âœ… æ”¯æŒ | ä¸»é”®è¿æ¥æ¶ˆé™¤ |
| **æŠ•å½±ä¸‹æ¨** | ä¸­ | SELECTåˆ— | O(1) | âœ… æ”¯æŒ | åªé€‰æ‹©éœ€è¦çš„åˆ— |

### éš”ç¦»çº§åˆ«ä¸æŸ¥è¯¢ä¼˜åŒ–å½±å“å¯¹æ¯”çŸ©é˜µ

| éš”ç¦»çº§åˆ« | æŸ¥è¯¢ä¼˜åŒ–è‡ªç”±åº¦ | ç´¢å¼•ä½¿ç”¨ | è¿æ¥ä¼˜åŒ– | ç»Ÿè®¡ä¿¡æ¯å½±å“ | PostgreSQLå®ç° |
| --- | --- | --- | --- | --- | --- |
| **READ UNCOMMITTED** | é«˜ | å®Œå…¨æ”¯æŒ | å®Œå…¨æ”¯æŒ | æ— å½±å“ | âŒ ä¸æ”¯æŒ |
| **READ COMMITTED** | é«˜ | å®Œå…¨æ”¯æŒ | å®Œå…¨æ”¯æŒ | å®æ—¶ç»Ÿè®¡ | âœ… é»˜è®¤ |
| **REPEATABLE READ** | ä¸­ | æ”¯æŒ | æ”¯æŒ | å¿«ç…§ç»Ÿè®¡ | âœ… æ”¯æŒ |
| **SERIALIZABLE** | ä½ | å—é™ | å—é™ | å¿«ç…§ç»Ÿè®¡ | âœ… æ”¯æŒ |

---

## ğŸŒ Wikipediaå¯¹é½

### æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Query optimization](https://en.wikipedia.org/wiki/Query_optimization)

> Query optimization is a feature of many relational database management systems and other databases such as NoSQL and graph databases. The query optimizer attempts to determine the most efficient way to execute a given query by considering the possible query plans.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒæŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè®¡åˆ’
- âœ… **æ ¸å¿ƒåŠŸèƒ½**: éƒ½æåˆ°ä»£ä»·ä¼°ç®—å’Œæ‰§è¡Œè®¡åˆ’é€‰æ‹©
- âœ… **ä¼˜åŒ–ç›®æ ‡**: éƒ½å¼ºè°ƒæ€§èƒ½æœ€ä¼˜åŒ–

### å…³ç³»ä»£æ•°æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Relational algebra](https://en.wikipedia.org/wiki/Relational_algebra)

> Relational algebra is a family of algebras with a well-founded semantics used for modeling the data stored in relational databases, and defining queries on it.

**å¯¹é½è¯´æ˜**:

- âœ… **ç†è®ºåŸºç¡€**: PostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨åŸºäºå…³ç³»ä»£æ•°
- âœ… **æ“ä½œç¬¦**: éƒ½åŒ…å«é€‰æ‹©ã€æŠ•å½±ã€è¿æ¥ç­‰æ“ä½œ
- âœ… **ç­‰ä»·æ€§**: éƒ½å¼ºè°ƒæŸ¥è¯¢é‡å†™çš„ç­‰ä»·æ€§

### åŠ¨æ€è§„åˆ’æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Dynamic programming](https://en.wikipedia.org/wiki/Dynamic_programming)

> Dynamic programming is both a mathematical optimization method and a computer programming method. It refers to simplifying a complicated problem by breaking it down into simpler sub-problems in a recursive manner.

**å¯¹é½è¯´æ˜**:

- âœ… **ç®—æ³•åº”ç”¨**: PostgreSQLçš„è¿æ¥é¡ºåºä¼˜åŒ–ä½¿ç”¨åŠ¨æ€è§„åˆ’
- âœ… **å­é—®é¢˜**: éƒ½å¼ºè°ƒå°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå­é—®é¢˜
- âœ… **æœ€ä¼˜å­ç»“æ„**: éƒ½åˆ©ç”¨æœ€ä¼˜å­ç»“æ„æ€§è´¨

---

## 1. å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­å°†ç”¨æˆ·æŸ¥è¯¢è½¬æ¢ä¸ºé«˜æ•ˆæ‰§è¡Œè®¡åˆ’çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡ä»£ä»·æ¨¡å‹é€‰æ‹©æœ€ä¼˜æ‰§è¡Œç­–ç•¥ï¼Œç¡®ä¿æŸ¥è¯¢æ€§èƒ½çš„æœ€ä¼˜åŒ–ã€‚

**English Definition**: A query optimizer is a core component in database systems that transforms user queries into efficient execution plans by selecting optimal strategies through cost models, ensuring optimal query performance.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\query}{\mathcal{Q}}
\newcommand{\plan}{\mathcal{P}}
\newcommand{\cost}{\mathcal{C}}
\newcommand{\optimizer}{\mathcal{O}}

% æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰
\optimizer: \query \rightarrow \plan

ä¼˜åŒ–ç›®æ ‡ï¼š\min_{\plan \in \mathcal{P}(\query)} \cost(\plan)

å…¶ä¸­ï¼š
\mathcal{P}(\query) = \{\plan_1, \plan_2, \ldots, \plan_n\} \text{ ä¸ºæŸ¥è¯¢çš„æ‰€æœ‰å¯èƒ½æ‰§è¡Œè®¡åˆ’}
\cost(\plan) = \cost_{IO}(\plan) + \cost_{CPU}(\plan) + \cost_{Memory}(\plan)
```

### 1.3 æ ¸å¿ƒå±æ€§

- **æ­£ç¡®æ€§**: ä¿è¯æŸ¥è¯¢ç»“æœæ­£ç¡®
- **æœ€ä¼˜æ€§**: é€‰æ‹©æœ€ä½ä»£ä»·çš„æ‰§è¡Œè®¡åˆ’
- **é€‚åº”æ€§**: æ ¹æ®æ•°æ®åˆ†å¸ƒåŠ¨æ€è°ƒæ•´
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤æ‚æŸ¥è¯¢ä¼˜åŒ–

## 2. ç†è®ºåŸºç¡€

### 2.1 æŸ¥è¯¢ä»£ä»·æ¨¡å‹

æŸ¥è¯¢ä»£ä»·æ¨¡å‹æ˜¯PostgreSQLä¼˜åŒ–å™¨çš„æ ¸å¿ƒï¼Œç”¨äºä¼°ç®—ä¸åŒæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬å¹¶é€‰æ‹©æœ€ä¼˜è®¡åˆ’ã€‚

**ä»£ä»·æ¨¡å‹å®šä¹‰**:

```latex
\begin{theorem}[æŸ¥è¯¢ä»£ä»·æ¨¡å‹]
æŸ¥è¯¢ä»£ä»·ç”±ä»¥ä¸‹å› ç´ å†³å®šï¼š
1. I/Oä»£ä»·ï¼š\cost_{IO} = \sum_{i} \text{page\_reads}_i \times \text{page\_cost}
2. CPUä»£ä»·ï¼š\cost_{CPU} = \sum_{i} \text{tuples\_processed}_i \times \text{cpu\_tuple\_cost}
3. å†…å­˜ä»£ä»·ï¼š\cost_{Memory} = \text{memory\_usage} \times \text{memory\_cost}

æ€»ä»£ä»·ï¼š\cost_{total} = \cost_{IO} + \cost_{CPU} + \cost_{Memory}
\end{theorem}
```

**ä»£ä»·å‚æ•°è¯¦è§£**:

```sql
-- æŸ¥çœ‹æ‰€æœ‰ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ä»£ä»·å‚æ•°é…ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ä»£ä»·å‚æ•°å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name LIKE '%cost%' OR name LIKE '%page%'
ORDER BY name;

-- ä¸»è¦ä»£ä»·å‚æ•°
-- I/Oä»£ä»·å‚æ•°
seq_page_cost = 1.0          -- é¡ºåºé¡µè¯»å–ä»£ä»·ï¼ˆåŸºå‡†ï¼‰
random_page_cost = 4.0       -- éšæœºé¡µè¯»å–ä»£ä»·ï¼ˆSSDå»ºè®®1.0-1.1ï¼‰
effective_cache_size = 4GB   -- æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆå½±å“ç´¢å¼•é€‰æ‹©ï¼‰

-- CPUä»£ä»·å‚æ•°
cpu_tuple_cost = 0.01        -- å¤„ç†ä¸€ä¸ªå…ƒç»„çš„CPUä»£ä»·
cpu_index_tuple_cost = 0.005 -- å¤„ç†ä¸€ä¸ªç´¢å¼•å…ƒç»„çš„CPUä»£ä»·
cpu_operator_cost = 0.0025   -- æ‰§è¡Œä¸€ä¸ªæ“ä½œç¬¦çš„CPUä»£ä»·

-- å¹¶è¡ŒæŸ¥è¯¢ä»£ä»·å‚æ•°
parallel_tuple_cost = 0.1     -- å¹¶è¡Œä¼ è¾“ä¸€ä¸ªå…ƒç»„çš„ä»£ä»·
parallel_setup_cost = 1000.0 -- å¹¶è¡ŒæŸ¥è¯¢å¯åŠ¨ä»£ä»·
```

**ä»£ä»·è®¡ç®—ç¤ºä¾‹**:

```sql
-- é¡ºåºæ‰«æä»£ä»·è®¡ç®—
-- cost = (pages * seq_page_cost) + (tuples * cpu_tuple_cost)
-- å‡è®¾ï¼š1000é¡µï¼Œ100000è¡Œ
-- cost = (1000 * 1.0) + (100000 * 0.01) = 1000 + 1000 = 2000

-- ç´¢å¼•æ‰«æä»£ä»·è®¡ç®—
-- cost = (index_pages * random_page_cost) +
--        (index_tuples * cpu_index_tuple_cost) +
--        (heap_pages * random_page_cost) +
--        (tuples * cpu_tuple_cost)
-- å‡è®¾ï¼šç´¢å¼•50é¡µï¼Œ10000è¡Œï¼Œå †100é¡µ
-- cost = (50 * 4.0) + (10000 * 0.005) + (100 * 4.0) + (10000 * 0.01)
--      = 200 + 50 + 400 + 100 = 750

-- æŸ¥çœ‹å®é™…æ‰§è¡Œè®¡åˆ’ä»£ä»·
EXPLAIN (ANALYZE, BUFFERS, COSTS)
SELECT * FROM large_table WHERE id = 12345;
```

**PostgreSQL 18æ”¹è¿›**:

- åŸºæ•°ä¼°è®¡å‡†ç¡®æ€§æå‡ï¼šè¯¯å·®ä»25%é™è‡³15%
- æ›´æ™ºèƒ½çš„ä»£ä»·ä¼°ç®—ï¼šè€ƒè™‘æ•°æ®åˆ†å¸ƒå’Œç›¸å…³æ€§
- æ”¹è¿›çš„å¹¶è¡ŒæŸ¥è¯¢ä»£ä»·æ¨¡å‹

**ä»£ä»·è°ƒä¼˜å®è·µ**:

```sql
-- 1. æ ¹æ®å­˜å‚¨ç±»å‹è°ƒæ•´random_page_costï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- SSD/NVMeç¯å¢ƒ
        -- SET random_page_cost = 1.1;  -- ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®ç¯å¢ƒè°ƒæ•´

        -- HDDç¯å¢ƒ
        -- SET random_page_cost = 4.0;  -- ç¤ºä¾‹

        RAISE NOTICE 'æç¤ºï¼šæ ¹æ®å­˜å‚¨ç±»å‹è°ƒæ•´random_page_costï¼ŒSSDå»ºè®®1.0-1.1ï¼ŒHDDå»ºè®®4.0';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. è°ƒæ•´effective_cache_sizeï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        -- è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%
        -- SET effective_cache_size = '8GB';  -- ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®ç³»ç»Ÿå†…å­˜è°ƒæ•´

        RAISE NOTICE 'æç¤ºï¼šeffective_cache_sizeåº”è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%%';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®effective_cache_sizeå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æŸ¥çœ‹ä»£ä»·ä¼°ç®—å‡†ç¡®æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ä»£ä»·ä¼°ç®—';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹ä»£ä»·ä¼°ç®—å‡†ç¡®æ€§ï¼ˆå¯¹æ¯”ä¼°ç®—è¡Œæ•°å’Œå®é™…è¡Œæ•°ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ä»£ä»·ä¼°ç®—å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM table1 WHERE column1 = 'value';
-- å¯¹æ¯”ä¼°ç®—è¡Œæ•°ï¼ˆrowsï¼‰å’Œå®é™…è¡Œæ•°ï¼ˆactual rowsï¼‰
```

**ä»£ä»·æ¨¡å‹éªŒè¯**:

```sql
-- å¯¹æ¯”ä¸åŒæ‰§è¡Œè®¡åˆ’çš„ä»£ä»·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•å¯¹æ¯”æ‰§è¡Œè®¡åˆ’';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹å¯¹æ¯”ä¸åŒæ‰§è¡Œè®¡åˆ’çš„ä»£ä»·';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯¹æ¯”æ‰§è¡Œè®¡åˆ’å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (COSTS, BUFFERS)
SELECT * FROM table1 WHERE id = 123;

-- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•æ‰«æï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET enable_seqscan = off;
        RAISE NOTICE 'å·²ç¦ç”¨é¡ºåºæ‰«æï¼Œå¼ºåˆ¶ä½¿ç”¨ç´¢å¼•æ‰«æ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¦ç”¨é¡ºåºæ‰«æå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (COSTS, BUFFERS)
SELECT * FROM table1 WHERE id = 123;

-- æ¢å¤é»˜è®¤ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET enable_seqscan = on;
        RAISE NOTICE 'å·²æ¢å¤é¡ºåºæ‰«æé»˜è®¤è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¢å¤é»˜è®¤è®¾ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

### 2.2 æŸ¥è¯¢é‡å†™ç†è®º

```latex
\begin{theorem}[æŸ¥è¯¢é‡å†™ç­‰ä»·æ€§]
æŸ¥è¯¢é‡å†™ä¿æŒè¯­ä¹‰ç­‰ä»·æ€§ï¼š
\forall \query, \forall \plan_1, \plan_2 \in \mathcal{P}(\query):
\text{result}(\plan_1) = \text{result}(\plan_2) \Rightarrow \plan_1 \equiv \plan_2
\end{theorem}
```

### 2.3 è¿æ¥é¡ºåºä¼˜åŒ–

```latex
\begin{theorem}[è¿æ¥é¡ºåºæœ€ä¼˜æ€§]
å¯¹äºnä¸ªè¡¨çš„è¿æ¥ï¼Œæœ€ä¼˜è¿æ¥é¡ºåºæ»¡è¶³ï¼š
\min_{\sigma \in S_n} \cost(\text{join}_{\sigma(1)} \bowtie \text{join}_{\sigma(2)} \bowtie \ldots \bowtie \text{join}_{\sigma(n)})
\end{theorem}
```

## 3. PostgreSQLä¼˜åŒ–å™¨æ¶æ„

### 3.1 ä¼˜åŒ–å™¨ç»„ä»¶

```sql
-- æŸ¥çœ‹ä¼˜åŒ–å™¨é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_enable_hashjoin TEXT;
    v_enable_mergejoin TEXT;
    v_enable_nestloop TEXT;
    v_enable_seqscan TEXT;
    v_enable_indexscan TEXT;
    v_enable_bitmapscan TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_enable_hashjoin FROM pg_settings WHERE name = 'enable_hashjoin';
        SELECT setting INTO v_enable_mergejoin FROM pg_settings WHERE name = 'enable_mergejoin';
        SELECT setting INTO v_enable_nestloop FROM pg_settings WHERE name = 'enable_nestloop';
        SELECT setting INTO v_enable_seqscan FROM pg_settings WHERE name = 'enable_seqscan';
        SELECT setting INTO v_enable_indexscan FROM pg_settings WHERE name = 'enable_indexscan';
        SELECT setting INTO v_enable_bitmapscan FROM pg_settings WHERE name = 'enable_bitmapscan';

        RAISE NOTICE 'ä¼˜åŒ–å™¨é…ç½®ï¼š';
        RAISE NOTICE '  enable_hashjoin: %, enable_mergejoin: %, enable_nestloop: %',
            v_enable_hashjoin, v_enable_mergejoin, v_enable_nestloop;
        RAISE NOTICE '  enable_seqscan: %, enable_indexscan: %, enable_bitmapscan: %',
            v_enable_seqscan, v_enable_indexscan, v_enable_bitmapscan;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ä¼˜åŒ–å™¨é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›´æ¥æŸ¥è¯¢ï¼ˆç¤ºä¾‹ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    config_value text;
BEGIN
    BEGIN
        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_hashjoin';
        RAISE NOTICE 'enable_hashjoin: %', config_value;

        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_mergejoin';
        RAISE NOTICE 'enable_mergejoin: %', config_value;

        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_nestloop';
        RAISE NOTICE 'enable_nestloop: %', config_value;

        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_seqscan';
        RAISE NOTICE 'enable_seqscan: %', config_value;

        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_indexscan';
        RAISE NOTICE 'enable_indexscan: %', config_value;

        SELECT setting INTO config_value FROM pg_settings WHERE name = 'enable_bitmapscan';
        RAISE NOTICE 'enable_bitmapscan: %', config_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹ä»£ä»·å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    v_seq_page_cost TEXT;
    v_random_page_cost TEXT;
    v_cpu_tuple_cost TEXT;
    v_cpu_index_tuple_cost TEXT;
    v_cpu_operator_cost TEXT;
BEGIN
    BEGIN
        SELECT setting INTO v_seq_page_cost FROM pg_settings WHERE name = 'seq_page_cost';
        SELECT setting INTO v_random_page_cost FROM pg_settings WHERE name = 'random_page_cost';
        SELECT setting INTO v_cpu_tuple_cost FROM pg_settings WHERE name = 'cpu_tuple_cost';
        SELECT setting INTO v_cpu_index_tuple_cost FROM pg_settings WHERE name = 'cpu_index_tuple_cost';
        SELECT setting INTO v_cpu_operator_cost FROM pg_settings WHERE name = 'cpu_operator_cost';

        RAISE NOTICE 'ä»£ä»·å‚æ•°ï¼š';
        RAISE NOTICE '  seq_page_cost: %, random_page_cost: %', v_seq_page_cost, v_random_page_cost;
        RAISE NOTICE '  cpu_tuple_cost: %, cpu_index_tuple_cost: %, cpu_operator_cost: %',
            v_cpu_tuple_cost, v_cpu_index_tuple_cost, v_cpu_operator_cost;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ä»£ä»·å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- ç›´æ¥æŸ¥è¯¢ï¼ˆç¤ºä¾‹ï¼‰
SHOW seq_page_cost;
SHOW random_page_cost;
SHOW cpu_tuple_cost;
SHOW cpu_index_tuple_cost;
SHOW cpu_operator_cost;
```

### 3.2 æŸ¥è¯¢è§£æ

```sql
-- æŸ¥çœ‹æŸ¥è¯¢è§£ææ ‘ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æŸ¥è¯¢è§£ææ ‘';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æŸ¥è¯¢è§£ææ ‘';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æŸ¥è¯¢è§£ææ ‘å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (VERBOSE, BUFFERS)
SELECT e.name, d.dept_name, e.salary
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000
ORDER BY e.salary DESC;

-- æŸ¥çœ‹æŸ¥è¯¢é‡å†™ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹æŸ¥è¯¢é‡å†™';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹æŸ¥è¯¢é‡å†™ï¼ˆINå­æŸ¥è¯¢ä¼˜åŒ–ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹æŸ¥è¯¢é‡å†™å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (VERBOSE)
SELECT * FROM employees WHERE emp_id IN (
    SELECT emp_id FROM employees WHERE salary > 50000
);
```

### 3.3 ç»Ÿè®¡ä¿¡æ¯

ç»Ÿè®¡ä¿¡æ¯æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè®¡åˆ’çš„å…³é”®ä¾æ®ã€‚PostgreSQLé€šè¿‡ANALYZEå‘½ä»¤æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚

**è¡¨çº§ç»Ÿè®¡ä¿¡æ¯**:

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    BEGIN
        SELECT COUNT(*) INTO table_count
        FROM pg_stat_user_tables;

        IF table_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªç”¨æˆ·è¡¨çš„ç»Ÿè®¡ä¿¡æ¯', table_count;
        ELSE
            RAISE WARNING 'æœªæ‰¾åˆ°ç”¨æˆ·è¡¨ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    n_tup_ins,          -- æ’å…¥çš„å…ƒç»„æ•°
    n_tup_upd,          -- æ›´æ–°çš„å…ƒç»„æ•°
    n_tup_del,          -- åˆ é™¤çš„å…ƒç»„æ•°
    n_live_tup,         -- æ´»è·ƒå…ƒç»„æ•°
    n_dead_tup,         -- æ­»å…ƒç»„æ•°
    last_vacuum,         -- æœ€åVACUUMæ—¶é—´
    last_autovacuum,     -- æœ€åè‡ªåŠ¨VACUUMæ—¶é—´
    last_analyze,        -- æœ€åANALYZEæ—¶é—´
    last_autoanalyze,    -- æœ€åè‡ªåŠ¨ANALYZEæ—¶é—´
    vacuum_count,        -- VACUUMæ¬¡æ•°
    autovacuum_count,    -- è‡ªåŠ¨VACUUMæ¬¡æ•°
    analyze_count,       -- ANALYZEæ¬¡æ•°
    autoanalyze_count    -- è‡ªåŠ¨ANALYZEæ¬¡æ•°
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;

-- æ‰‹åŠ¨æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
ANALYZE table_name;

-- æ”¶é›†æ‰€æœ‰è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE;
```

**åˆ—çº§ç»Ÿè®¡ä¿¡æ¯**:

```sql
-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯';
            RETURN;
        END IF;

        SELECT COUNT(*) INTO stats_count
        FROM pg_stats
        WHERE schemaname = 'public' AND tablename = 'employees';

        IF stats_count > 0 THEN
            RAISE NOTICE 'æ‰¾åˆ° % ä¸ªåˆ—çš„ç»Ÿè®¡ä¿¡æ¯', stats_count;
        ELSE
            RAISE WARNING 'è¡¨ employees çš„åˆ—ç»Ÿè®¡ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è¿è¡ŒANALYZE';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE schemaname = 'public' AND tablename = 'employees';
```

## 4. æŸ¥è¯¢é‡å†™ä¼˜åŒ–

### 4.1 è°“è¯ä¸‹æ¨

è°“è¯ä¸‹æ¨æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨çš„é‡è¦ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†WHEREæ¡ä»¶å°½å¯èƒ½ä¸‹æ¨åˆ°æ•°æ®æºï¼Œå‡å°‘éœ€è¦å¤„ç†çš„æ•°æ®é‡ã€‚

**è°“è¯ä¸‹æ¨åŸç†**:

ä¼˜åŒ–å™¨ä¼šå°†WHEREæ¡ä»¶ä»å¤–å±‚æŸ¥è¯¢ä¸‹æ¨åˆ°å­æŸ¥è¯¢ã€è§†å›¾æˆ–è¿æ¥æ“ä½œä¸­ï¼Œåœ¨æ•°æ®è¯»å–é˜¶æ®µå°±è¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„è¡Œã€‚

**åŸºæœ¬è°“è¯ä¸‹æ¨**:

```sql
-- ç¤ºä¾‹1ï¼šç®€å•è°“è¯ä¸‹æ¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºè°“è¯ä¸‹æ¨';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºç®€å•è°“è¯ä¸‹æ¨ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000 AND d.budget > 1000000;

-- ä¼˜åŒ–å™¨ä¼šå°†æ¡ä»¶ä¸‹æ¨ï¼š
-- - e.salary > 50000 ä¸‹æ¨åˆ° employees è¡¨æ‰«æ
-- - d.budget > 1000000 ä¸‹æ¨åˆ° departments è¡¨æ‰«æ
-- å‡å°‘è¿æ¥æ“ä½œéœ€è¦å¤„ç†çš„è¡Œæ•°
```

**å­æŸ¥è¯¢è°“è¯ä¸‹æ¨**:

```sql
-- ç¤ºä¾‹2ï¼šå­æŸ¥è¯¢ä¼˜åŒ–ï¼ˆINå­å¥ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå­æŸ¥è¯¢ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºINå­æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå°†é‡å†™ä¸ºåŠè¿æ¥ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE dept_id IN (
    SELECT dept_id FROM departments WHERE budget > 1000000
);

-- PostgreSQLä¼˜åŒ–å™¨ä¼šå°†æ­¤æŸ¥è¯¢é‡å†™ä¸ºï¼š
-- SELECT e.* FROM employees e
-- JOIN departments d ON e.dept_id = d.dept_id
-- WHERE d.budget > 1000000
-- ä½¿ç”¨åŠè¿æ¥ï¼ˆSemi-Joinï¼‰ä¼˜åŒ–

-- ç¤ºä¾‹3ï¼šEXISTSå­æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºEXISTSå­æŸ¥è¯¢ä¼˜åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºEXISTSå­æŸ¥è¯¢ä¼˜åŒ–';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees e
WHERE EXISTS (
    SELECT 1 FROM departments d
    WHERE d.dept_id = e.dept_id AND d.budget > 1000000
);
-- ä¼˜åŒ–å™¨ä¼šä½¿ç”¨åŠè¿æ¥æˆ–ååŠè¿æ¥ä¼˜åŒ–
```

**è§†å›¾è°“è¯ä¸‹æ¨**:

```sql
-- åˆ›å»ºè§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'high_salary_employees') THEN
            RAISE NOTICE 'è§†å›¾ high_salary_employees å·²å­˜åœ¨';
        ELSE
            CREATE VIEW high_salary_employees AS
            SELECT e.*, d.dept_name
            FROM employees e
            JOIN departments d ON e.dept_id = d.dept_id
            WHERE e.salary > 50000;
            RAISE NOTICE 'è§†å›¾ high_salary_employees åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è§†å›¾ high_salary_employees å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢è§†å›¾æ—¶ï¼Œæ¡ä»¶å¯ä»¥ä¸‹æ¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'high_salary_employees') THEN
            RAISE WARNING 'è§†å›¾ high_salary_employees ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºè§†å›¾æŸ¥è¯¢æ¡ä»¶ä¸‹æ¨ï¼ˆä¼˜åŒ–å™¨ä¼šå°†æ¡ä»¶ä¸‹æ¨åˆ°è§†å›¾å®šä¹‰ä¸­ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è§†å›¾å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM high_salary_employees
WHERE dept_name = 'Engineering';
-- ä¼˜åŒ–å™¨ä¼šå°† dept_name = 'Engineering' ä¸‹æ¨åˆ°è§†å›¾å®šä¹‰ä¸­

**PostgreSQL 18æ”¹è¿›**:

- æ›´æ™ºèƒ½çš„è°“è¯ä¸‹æ¨ï¼šè¯†åˆ«æ›´å¤šå¯ä»¥ä¸‹æ¨çš„æ¡ä»¶
- æ”¹è¿›çš„å­æŸ¥è¯¢ä¼˜åŒ–ï¼šæ›´å¥½çš„INå’ŒEXISTSå­æŸ¥è¯¢å¤„ç†
- è§†å›¾ä¼˜åŒ–å¢å¼ºï¼šæ›´é«˜æ•ˆçš„è§†å›¾å±•å¼€å’Œè°“è¯ä¸‹æ¨

### 4.2 å¸¸é‡æŠ˜å 

å¸¸é‡æŠ˜å æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨ç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡è¡¨è¾¾å¼çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå‡å°‘è¿è¡Œæ—¶è®¡ç®—å¼€é”€ã€‚

**å¸¸é‡æŠ˜å åŸç†**:

ä¼˜åŒ–å™¨ä¼šåœ¨æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆé˜¶æ®µè®¡ç®—æ‰€æœ‰å¸¸é‡è¡¨è¾¾å¼ï¼Œå°†ç»“æœç›´æ¥æ›¿æ¢åˆ°æŸ¥è¯¢è®¡åˆ’ä¸­ã€‚

**åŸºæœ¬å¸¸é‡æŠ˜å **:

```sql
-- ç¤ºä¾‹1ï¼šç®—æœ¯è¡¨è¾¾å¼æŠ˜å ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå¸¸é‡æŠ˜å ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºç®—æœ¯è¡¨è¾¾å¼æŠ˜å ï¼ˆ50000 + 1000 å°†æŠ˜å ä¸º 51000ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE salary > 50000 + 1000;

-- ä¼˜åŒ–å™¨ä¼šå°† 50000 + 1000 æŠ˜å ä¸º 51000
-- å®é™…æ‰§è¡Œï¼šWHERE salary > 51000

-- ç¤ºä¾‹2ï¼šå‡½æ•°è°ƒç”¨æŠ˜å ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå‡½æ•°è°ƒç”¨æŠ˜å ';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå‡½æ•°è°ƒç”¨æŠ˜å ï¼ˆNOW() - INTERVALå°†æŠ˜å ä¸ºå…·ä½“æ—¶é—´æˆ³ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE created_at > NOW() - INTERVAL '1 year';

-- å¦‚æœNOW()åœ¨æŸ¥è¯¢ç¼–è¯‘æ—¶å·²çŸ¥ï¼Œä¼šæŠ˜å ä¸ºå…·ä½“æ—¶é—´æˆ³
```

**è¡¨è¾¾å¼ç®€åŒ–**:

```sql
-- ç¤ºä¾‹3ï¼šè¡¨è¾¾å¼ç®€åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºè¡¨è¾¾å¼ç®€åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºè¡¨è¾¾å¼ç®€åŒ–ï¼ˆsalary * 1.1 > 55000 å°†ç®€åŒ–ä¸º salary > 50000ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE salary * 1.1 > 55000;

-- ä¼˜åŒ–å™¨å¯èƒ½ç®€åŒ–ä¸ºï¼š
-- WHERE salary > 55000 / 1.1
-- WHERE salary > 50000

-- ç¤ºä¾‹4ï¼šå¸ƒå°”è¡¨è¾¾å¼ç®€åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå¸ƒå°”è¡¨è¾¾å¼ç®€åŒ–';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå¸ƒå°”è¡¨è¾¾å¼ç®€åŒ–ï¼ˆAND TRUE å°†è¢«ç§»é™¤ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE salary > 50000 AND TRUE;
-- ç®€åŒ–ä¸ºï¼šWHERE salary > 50000

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE salary > 50000 AND FALSE;
-- ç®€åŒ–ä¸ºï¼šWHERE FALSEï¼ˆå¯èƒ½ç›´æ¥è¿”å›ç©ºç»“æœï¼‰
```

**å¸¸é‡æŠ˜å é™åˆ¶**:

```sql
-- ä»¥ä¸‹æƒ…å†µä¸ä¼šæŠ˜å ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰ï¼š
-- 1. æ¶‰åŠéç¡®å®šæ€§å‡½æ•°
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºéç¡®å®šæ€§å‡½æ•°';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºéç¡®å®šæ€§å‡½æ•°ï¼ˆNOW()æ¯æ¬¡è°ƒç”¨ç»“æœä¸åŒï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM employees
WHERE created_at > NOW();  -- NOW()æ¯æ¬¡è°ƒç”¨ç»“æœä¸åŒ

-- 2. æ¶‰åŠç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆé™¤éæ ‡è®°ä¸ºIMMUTABLEï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'get_threshold') THEN
            RAISE NOTICE 'å‡½æ•° get_threshold å·²å­˜åœ¨';
        ELSE
            CREATE FUNCTION get_threshold() RETURNS int AS $$
                SELECT 50000;
            $$ LANGUAGE SQL STABLE;  -- STABLEå‡½æ•°ä¸ä¼šæŠ˜å 
            RAISE NOTICE 'å‡½æ•° get_threshold åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_function THEN
            RAISE WARNING 'å‡½æ•° get_threshold å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. æ¶‰åŠå­æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå­æŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå­æŸ¥è¯¢ï¼ˆæ¶‰åŠå­æŸ¥è¯¢ä¸ä¼šæŠ˜å ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM employees
WHERE salary > (SELECT AVG(salary) FROM employees);
```

**å¸¸é‡æŠ˜å ä¼˜åŒ–æŠ€å·§**:

```sql
-- ä½¿ç”¨IMMUTABLEå‡½æ•°æ”¯æŒå¸¸é‡æŠ˜å ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'calculate_bonus') THEN
            RAISE NOTICE 'å‡½æ•° calculate_bonus å·²å­˜åœ¨';
        ELSE
            CREATE FUNCTION calculate_bonus(base_salary int)
            RETURNS int AS $$
                SELECT base_salary * 1.1;
            $$ LANGUAGE SQL IMMUTABLE;
            RAISE NOTICE 'å‡½æ•° calculate_bonus åˆ›å»ºæˆåŠŸï¼ˆIMMUTABLEæ ‡è®°æ”¯æŒå¸¸é‡æŠ˜å ï¼‰';
        END IF;
    EXCEPTION
        WHEN duplicate_function THEN
            RAISE WARNING 'å‡½æ•° calculate_bonus å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºå‡½æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢æ—¶å¯ä»¥æŠ˜å ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºIMMUTABLEå‡½æ•°æŠ˜å ';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'calculate_bonus') THEN
            RAISE WARNING 'å‡½æ•° calculate_bonus ä¸å­˜åœ¨';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºIMMUTABLEå‡½æ•°å¸¸é‡æŠ˜å ï¼ˆcalculate_bonus(50000) å°†æŠ˜å ä¸º 55000ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM employees
WHERE salary > calculate_bonus(50000);
-- ä¼˜åŒ–å™¨ä¼šæŠ˜å ä¸ºï¼šWHERE salary > 55000

### 4.3 è§†å›¾å±•å¼€

```sql
-- åˆ›å»ºè§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè§†å›¾';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'emp_summary') THEN
            RAISE NOTICE 'è§†å›¾ emp_summary å·²å­˜åœ¨';
        ELSE
            CREATE VIEW emp_summary AS
            SELECT dept_id, COUNT(*) as emp_count, AVG(salary) as avg_salary
            FROM employees
            GROUP BY dept_id;
            RAISE NOTICE 'è§†å›¾ emp_summary åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è§†å›¾ emp_summary å·²å­˜åœ¨';
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- è§†å›¾å±•å¼€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.views WHERE table_schema = 'public' AND table_name = 'emp_summary') THEN
            RAISE WARNING 'è§†å›¾ emp_summary ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºè§†å›¾å±•å¼€';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºè§†å›¾å±•å¼€ï¼ˆè§†å›¾å°†è¢«å±•å¼€ä¸ºåº•å±‚æŸ¥è¯¢ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM emp_summary WHERE emp_count > 10;

## 5. è¿æ¥ä¼˜åŒ–

### 5.1 è¿æ¥ç®—æ³•é€‰æ‹©

PostgreSQLæ”¯æŒä¸‰ç§ä¸»è¦çš„è¿æ¥ç®—æ³•ï¼šåµŒå¥—å¾ªç¯è¿æ¥ã€å“ˆå¸Œè¿æ¥å’Œåˆå¹¶è¿æ¥ã€‚ä¼˜åŒ–å™¨ä¼šæ ¹æ®æ•°æ®é‡ã€ç´¢å¼•å’Œæ’åºæƒ…å†µé€‰æ‹©æœ€ä¼˜ç®—æ³•ã€‚

#### 1. åµŒå¥—å¾ªç¯è¿æ¥ï¼ˆNested Loop Joinï¼‰

é€‚åˆå°æ•°æ®é›†æˆ–å†…è¡¨æœ‰ç´¢å¼•çš„æƒ…å†µã€‚

```sql
-- åµŒå¥—å¾ªç¯è¿æ¥ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºåµŒå¥—å¾ªç¯è¿æ¥';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºåµŒå¥—å¾ªç¯è¿æ¥ï¼ˆNested Loop Joinï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e, departments d
WHERE e.dept_id = d.dept_id;

-- ç®—æ³•åŸç†ï¼š
-- FOR each row in employees:
--     FOR each row in departments WHERE dept_id = e.dept_id:
--         output row
--
-- å¦‚æœdepartments.dept_idæœ‰ç´¢å¼•ï¼Œæ€§èƒ½å¾ˆå¥½
-- æ—¶é—´å¤æ‚åº¦ï¼šO(n * log(m))ï¼Œnä¸ºå¤–è¡¨è¡Œæ•°ï¼Œmä¸ºå†…è¡¨è¡Œæ•°

-- å¼ºåˆ¶ä½¿ç”¨åµŒå¥—å¾ªç¯è¿æ¥
SET enable_hashjoin = off;
SET enable_mergejoin = off;
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;
RESET enable_hashjoin;
RESET enable_mergejoin;
```

#### å“ˆå¸Œè¿æ¥ï¼ˆHash Joinï¼‰

é€‚åˆä¸­ç­‰å¤§å°çš„æ•°æ®é›†ï¼Œå†…è¡¨å¯ä»¥å®Œå…¨æ”¾å…¥å†…å­˜ã€‚

```sql
-- å“ˆå¸Œè¿æ¥ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºå“ˆå¸Œè¿æ¥';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºå“ˆå¸Œè¿æ¥ï¼ˆHash Joinï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- ç®—æ³•åŸç†ï¼š
-- 1. å¯¹å†…è¡¨ï¼ˆdepartmentsï¼‰å»ºç«‹å“ˆå¸Œè¡¨
-- 2. æ‰«æå¤–è¡¨ï¼ˆemployeesï¼‰ï¼Œåœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾åŒ¹é…
--
-- æ—¶é—´å¤æ‚åº¦ï¼šO(n + m)ï¼Œnå’Œmåˆ†åˆ«ä¸ºä¸¤ä¸ªè¡¨çš„è¡Œæ•°
-- å†…å­˜éœ€æ±‚ï¼šéœ€è¦èƒ½å®¹çº³å†…è¡¨çš„å“ˆå¸Œè¡¨

-- å“ˆå¸Œè¿æ¥é…ç½®
-- work_memå½±å“å“ˆå¸Œè¡¨å¤§å°
SET work_mem = '256MB';
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;
```

#### åˆå¹¶è¿æ¥ï¼ˆMerge Joinï¼‰

é€‚åˆä¸¤ä¸ªè¡¨éƒ½å·²æ’åºæˆ–å¯ä»¥é«˜æ•ˆæ’åºçš„æƒ…å†µã€‚

```sql
-- åˆå¹¶è¿æ¥ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'departments') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºåˆå¹¶è¿æ¥';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºåˆå¹¶è¿æ¥ï¼ˆMerge Joinï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
ORDER BY e.dept_id;

-- ç®—æ³•åŸç†ï¼š
-- 1. ä¸¤ä¸ªè¡¨éƒ½æŒ‰è¿æ¥é”®æ’åº
-- 2. åŒæ—¶æ‰«æä¸¤ä¸ªè¡¨ï¼Œåˆå¹¶åŒ¹é…çš„è¡Œ
--
-- æ—¶é—´å¤æ‚åº¦ï¼šO(n + m + sort_cost)
-- å¦‚æœè¡¨å·²æ’åºï¼Œæ€§èƒ½æœ€ä¼˜

-- åˆå¹¶è¿æ¥éœ€è¦æ’åº
-- å¦‚æœè¿æ¥é”®ä¸Šæœ‰ç´¢å¼•ï¼Œå¯èƒ½ä½¿ç”¨ç´¢å¼•æ‰«æé¿å…æ’åº
CREATE INDEX idx_emp_dept ON employees(dept_id);
CREATE INDEX idx_dept_id ON departments(dept_id);

EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;
```

**è¿æ¥ç®—æ³•é€‰æ‹©ç­–ç•¥**:

| åœºæ™¯ | æ¨èç®—æ³• | åŸå›  |
| --- | --- | --- |
| å°è¡¨è¿æ¥ | åµŒå¥—å¾ªç¯ | å¼€é”€å°ï¼Œå†…è¡¨æœ‰ç´¢å¼•æ—¶æ€§èƒ½å¥½ |
| ä¸­ç­‰è¡¨ï¼Œå†…è¡¨å¯æ”¾å…¥å†…å­˜ | å“ˆå¸Œè¿æ¥ | æ€§èƒ½ç¨³å®šï¼ŒO(n+m)å¤æ‚åº¦ |
| å¤§è¡¨ï¼Œå·²æ’åºæˆ–å¯æ’åº | åˆå¹¶è¿æ¥ | é¿å…å“ˆå¸Œè¡¨å†…å­˜é™åˆ¶ |
| å†…è¡¨æœ‰ç´¢å¼• | åµŒå¥—å¾ªç¯ | åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾ |
| éœ€è¦æ’åºç»“æœ | åˆå¹¶è¿æ¥ | è¿æ¥å’Œæ’åºä¸€æ¬¡å®Œæˆ |

**è¿æ¥ç®—æ³•é…ç½®**:

```sql
-- å¯ç”¨/ç¦ç”¨ç‰¹å®šè¿æ¥ç®—æ³•
SET enable_nestloop = on;    -- åµŒå¥—å¾ªç¯ï¼ˆé»˜è®¤onï¼‰
SET enable_hashjoin = on;    -- å“ˆå¸Œè¿æ¥ï¼ˆé»˜è®¤onï¼‰
SET enable_mergejoin = on;   -- åˆå¹¶è¿æ¥ï¼ˆé»˜è®¤onï¼‰

-- æŸ¥çœ‹è¿æ¥ç®—æ³•ä½¿ç”¨æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id;
```

**PostgreSQL 18è¿æ¥ç®—æ³•æ”¹è¿›**:

- æ›´æ™ºèƒ½çš„ç®—æ³•é€‰æ‹©ï¼šæ”¹è¿›çš„ä»£ä»·ä¼°ç®—
- å¹¶è¡Œè¿æ¥æ”¯æŒï¼šæ”¯æŒå¹¶è¡Œå“ˆå¸Œè¿æ¥å’Œå¹¶è¡Œåˆå¹¶è¿æ¥
- æ”¹è¿›çš„å“ˆå¸Œè¿æ¥ï¼šæ›´å¥½çš„å†…å­˜ç®¡ç†å’Œæº¢å‡ºå¤„ç†

### 5.2 è¿æ¥é¡ºåºä¼˜åŒ–

è¿æ¥é¡ºåºä¼˜åŒ–æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œå¯¹äºå¤šè¡¨è¿æ¥æŸ¥è¯¢çš„æ€§èƒ½å½±å“å·¨å¤§ã€‚

**è¿æ¥é¡ºåºé—®é¢˜**:

å¯¹äºnä¸ªè¡¨çš„è¿æ¥ï¼Œå¯èƒ½çš„è¿æ¥é¡ºåºæœ‰n!ç§ã€‚PostgreSQLä½¿ç”¨åŠ¨æ€è§„åˆ’ç®—æ³•å’Œé—ä¼ ç®—æ³•æ¥é€‰æ‹©æœ€ä¼˜è¿æ¥é¡ºåºã€‚

**åŠ¨æ€è§„åˆ’ç®—æ³•**:

```sql
-- å¤šè¡¨è¿æ¥ç¤ºä¾‹
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    e.name,
    d.dept_name,
    p.project_name,
    c.client_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id
JOIN clients c ON p.client_id = c.client_id
WHERE e.salary > 50000
  AND d.budget > 1000000
  AND p.status = 'active';

-- ä¼˜åŒ–å™¨ä¼šå°è¯•æ‰€æœ‰å¯èƒ½çš„è¿æ¥é¡ºåºï¼š
-- 1. e -> d -> p -> c
-- 2. e -> p -> d -> c
-- 3. d -> e -> p -> c
-- ... (å…±24ç§å¯èƒ½)
-- é€‰æ‹©ä»£ä»·æœ€ä½çš„é¡ºåº
```

**è¿æ¥é¡ºåºä¼˜åŒ–ç­–ç•¥**:

1. **å°è¡¨ä¼˜å…ˆ**: å…ˆè¿æ¥è¾ƒå°çš„è¡¨ï¼Œå‡å°‘ä¸­é—´ç»“æœé›†å¤§å°
2. **é€‰æ‹©æ€§é«˜çš„æ¡ä»¶ä¼˜å…ˆ**: å…ˆåº”ç”¨é€‰æ‹©æ€§é«˜çš„WHEREæ¡ä»¶
3. **ç´¢å¼•åˆ©ç”¨**: ä¼˜å…ˆä½¿ç”¨æœ‰ç´¢å¼•çš„è¿æ¥é”®

**è¿æ¥é¡ºåºé…ç½®**:

```sql
-- join_collapse_limit: æ§åˆ¶è¿æ¥é¡ºåºä¼˜åŒ–çš„è¡¨æ•°é‡
-- é»˜è®¤å€¼ï¼š8ï¼ˆPostgreSQL 18ï¼‰
-- å¦‚æœè¡¨æ•°è¶…è¿‡æ­¤å€¼ï¼Œä¼˜åŒ–å™¨ä¼šä½¿ç”¨é—ä¼ ç®—æ³•

SET join_collapse_limit = 8;  -- é»˜è®¤å€¼
SET join_collapse_limit = 1;   -- å¼ºåˆ¶ä½¿ç”¨æŸ¥è¯¢ä¸­çš„è¿æ¥é¡ºåº

-- from_collapse_limit: æ§åˆ¶FROMå­å¥é‡å†™çš„è¡¨æ•°é‡
SET from_collapse_limit = 8;   -- é»˜è®¤å€¼

-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW join_collapse_limit;
SHOW from_collapse_limit;
```

**è¿æ¥é¡ºåºä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- ç¤ºä¾‹1ï¼šä¼˜åŒ–å™¨è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜é¡ºåº
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id
WHERE e.salary > 50000;

-- ç¤ºä¾‹2ï¼šå¼ºåˆ¶è¿æ¥é¡ºåºï¼ˆè°ƒè¯•ç”¨ï¼‰
SET join_collapse_limit = 1;
EXPLAIN (ANALYZE, BUFFERS)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.manager_id
WHERE e.salary > 50000;
RESET join_collapse_limit;
```

**è¿æ¥é¡ºåºä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨å­æŸ¥è¯¢æ§åˆ¶è¿æ¥é¡ºåº
SELECT e.name, d.dept_name
FROM (
    SELECT * FROM employees WHERE salary > 50000
) e
JOIN departments d ON e.dept_id = d.dept_id;

-- 2. ä½¿ç”¨CTEä¼˜åŒ–è¿æ¥é¡ºåº
WITH filtered_employees AS (
    SELECT * FROM employees WHERE salary > 50000
)
SELECT e.name, d.dept_name
FROM filtered_employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- 3. ç¡®ä¿è¿æ¥é”®ä¸Šæœ‰ç´¢å¼•
CREATE INDEX idx_emp_dept ON employees(dept_id);
CREATE INDEX idx_proj_manager ON projects(manager_id);
```

**PostgreSQL 18è¿æ¥é¡ºåºæ”¹è¿›**:

- æ›´æ™ºèƒ½çš„è¿æ¥é¡ºåºé€‰æ‹©
- æ”¹è¿›çš„ä»£ä»·ä¼°ç®—å‡†ç¡®æ€§
- æ›´å¥½çš„å¹¶è¡Œè¿æ¥æ”¯æŒ

**è¿æ¥é¡ºåºé—®é¢˜è¯Šæ–­**:

```sql
-- æŸ¥çœ‹è¿æ¥é¡ºåºé€‰æ‹©ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table2') OR
           NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table3') THEN
            RAISE WARNING 'å¿…éœ€çš„è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹è¿æ¥é¡ºåºé€‰æ‹©';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹è¿æ¥é¡ºåºé€‰æ‹©';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹è¿æ¥é¡ºåºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id
JOIN table3 t3 ON t2.id = t3.id;

-- å¦‚æœæ€§èƒ½ä¸ä½³ï¼Œæ£€æŸ¥ï¼š
-- 1. è¿æ¥é”®æ˜¯å¦æœ‰ç´¢å¼•
-- 2. ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦å‡†ç¡®
-- 3. è¿æ¥é¡ºåºæ˜¯å¦åˆç†

-- å¯¹æ¯”ä¸åŒè¿æ¥é¡ºåºçš„æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET join_collapse_limit = 1;
        RAISE NOTICE 'å·²è®¾ç½® join_collapse_limit = 1ï¼ˆä½¿ç”¨æŸ¥è¯¢ä¸­çš„é¡ºåºï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½® join_collapse_limit å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id
JOIN table3 t3 ON t2.id = t3.id;  -- ä½¿ç”¨æŸ¥è¯¢ä¸­çš„é¡ºåº

DO $$
BEGIN
    BEGIN
        SET join_collapse_limit = 8;
        RAISE NOTICE 'å·²è®¾ç½® join_collapse_limit = 8ï¼ˆä½¿ç”¨ä¼˜åŒ–å™¨é€‰æ‹©çš„é¡ºåºï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½® join_collapse_limit å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id
JOIN table3 t3 ON t2.id = t3.id;  -- ä½¿ç”¨ä¼˜åŒ–å™¨é€‰æ‹©çš„é¡ºåº
```

### 5.3 è¿æ¥ä¼˜åŒ–é…ç½®

```sql
-- è¿æ¥ä¼˜åŒ–å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    param_value text;
BEGIN
    BEGIN
        SELECT setting INTO param_value FROM pg_settings WHERE name = 'join_collapse_limit';
        RAISE NOTICE 'join_collapse_limit: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'from_collapse_limit';
        RAISE NOTICE 'from_collapse_limit: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'geqo';
        RAISE NOTICE 'geqo: %', param_value;

        SELECT setting INTO param_value FROM pg_settings WHERE name = 'geqo_threshold';
        RAISE NOTICE 'geqo_threshold: %', param_value;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢è¿æ¥ä¼˜åŒ–å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- é—ä¼ æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET geqo = on;
        SET geqo_threshold = 12;
        RAISE NOTICE 'å·²å¯ç”¨é—ä¼ æŸ¥è¯¢ä¼˜åŒ–ï¼ˆgeqo = on, geqo_threshold = 12ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®é—ä¼ æŸ¥è¯¢ä¼˜åŒ–å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, t11, t12, t13
WHERE t1.id = t2.id AND t2.id = t3.id AND t3.id = t4.id;
```

## 6. ç´¢å¼•ä¼˜åŒ–

### 6.1 ç´¢å¼•é€‰æ‹©

ä¼˜åŒ–å™¨ä¼šæ ¹æ®æŸ¥è¯¢æ¡ä»¶ã€è¡¨å¤§å°ã€ç´¢å¼•é€‰æ‹©æ€§ç­‰å› ç´ é€‰æ‹©ä½¿ç”¨å“ªä¸ªç´¢å¼•ã€‚

**ç´¢å¼•é€‰æ‹©å› ç´ **:

1. **ç´¢å¼•é€‰æ‹©æ€§**: ç´¢å¼•èƒ½è¿‡æ»¤æ‰å¤šå°‘æ•°æ®
2. **ç´¢å¼•å¤§å°**: ç´¢å¼•æ‰«æçš„æˆæœ¬
3. **æŸ¥è¯¢æ¡ä»¶**: WHEREå­å¥ä¸­çš„æ¡ä»¶
4. **æ’åºéœ€æ±‚**: ORDER BYæ˜¯å¦å¯ä»¥åˆ©ç”¨ç´¢å¼•

**ç´¢å¼•é€‰æ‹©ç¤ºä¾‹**:

```sql
-- åˆ›å»ºå¤šä¸ªç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_dept') THEN
            CREATE INDEX idx_emp_dept ON employees(dept_id);
            RAISE NOTICE 'ç´¢å¼• idx_emp_dept åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_salary') THEN
            CREATE INDEX idx_emp_salary ON employees(salary);
            RAISE NOTICE 'ç´¢å¼• idx_emp_salary åˆ›å»ºæˆåŠŸ';
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_dept_salary') THEN
            CREATE INDEX idx_emp_dept_salary ON employees(dept_id, salary);
            RAISE NOTICE 'ç´¢å¼• idx_emp_dept_salary åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥è¯¢1ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_deptï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'æŸ¥è¯¢1ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_dept';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE dept_id = 10;
-- ä½¿ç”¨ç´¢å¼•æ‰«æï¼šIndex Scan using idx_emp_dept

-- æŸ¥è¯¢2ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_salaryï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'æŸ¥è¯¢2ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_salary';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE salary > 50000;
-- ä½¿ç”¨ç´¢å¼•æ‰«æï¼šIndex Scan using idx_emp_salary

-- æŸ¥è¯¢3ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_dept_salaryï¼ˆç»„åˆç´¢å¼•ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢';
            RETURN;
        END IF;
        RAISE NOTICE 'æŸ¥è¯¢3ï¼šä¼˜åŒ–å™¨é€‰æ‹©idx_emp_dept_salaryï¼ˆç»„åˆç´¢å¼•ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE dept_id = 10 AND salary > 50000;
-- ä½¿ç”¨ç´¢å¼•æ‰«æï¼šIndex Scan using idx_emp_dept_salary
```

**ç´¢å¼•é€‰æ‹©ç­–ç•¥**:

```sql
-- 1. é€‰æ‹©æ€§é«˜çš„ç´¢å¼•ä¼˜å…ˆ
-- é€‰æ‹©æ€§ = ä¸åŒå€¼æ•°é‡ / æ€»è¡Œæ•°
-- é€‰æ‹©æ€§è¶Šé«˜ï¼Œç´¢å¼•è¶Šæœ‰ç”¨

-- æŸ¥çœ‹ç´¢å¼•é€‰æ‹©æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_record RECORD;
    index_count int := 0;
BEGIN
    BEGIN
        FOR index_record IN
            SELECT
                schemaname,
                tablename,
                indexname,
                idx_scan,
                idx_tup_read,
                idx_tup_fetch
            FROM pg_stat_user_indexes
            WHERE schemaname = 'public'
            ORDER BY idx_scan DESC
            LIMIT 10
        LOOP
            index_count := index_count + 1;
            RAISE NOTICE 'ç´¢å¼•: %.%.%, æ‰«ææ¬¡æ•°: %, è¯»å–å…ƒç»„: %, è·å–å…ƒç»„: %',
                index_record.schemaname, index_record.tablename, index_record.indexname,
                index_record.idx_scan, index_record.idx_tup_read, index_record.idx_tup_fetch;
        END LOOP;

        IF index_count = 0 THEN
            RAISE WARNING 'æœªæ‰¾åˆ°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥çœ‹ç´¢å¼•é€‰æ‹©æ€§å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;

-- 2. ç»„åˆç´¢å¼•åˆ—é¡ºåºå¾ˆé‡è¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç»„åˆç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_dept_salary') THEN
            CREATE INDEX idx_emp_dept_salary ON employees(dept_id, salary);
            RAISE NOTICE 'ç»„åˆç´¢å¼• idx_emp_dept_salary åˆ›å»ºæˆåŠŸï¼ˆdept_idé€‰æ‹©æ€§é«˜ï¼Œæ”¾åœ¨å‰é¢ï¼‰';
        ELSE
            RAISE NOTICE 'ç»„åˆç´¢å¼• idx_emp_dept_salary å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_emp_dept_salary å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç»„åˆç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºéƒ¨åˆ†ç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_high_salary') THEN
            CREATE INDEX idx_high_salary ON employees(salary)
            WHERE salary > 50000;
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_high_salary åˆ›å»ºæˆåŠŸï¼ˆåªç´¢å¼•é«˜è–ªå‘˜å·¥ï¼Œå‡å°‘ç´¢å¼•å¤§å°ï¼‰';
        ELSE
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_high_salary å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_high_salary å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºéƒ¨åˆ†ç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**ç´¢å¼•ç±»å‹é€‰æ‹©**:

```sql
-- B-Treeç´¢å¼•ï¼šé»˜è®¤ç´¢å¼•ï¼Œé€‚åˆç­‰å€¼å’ŒèŒƒå›´æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºB-Treeç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'table1' AND indexname = 'idx_btree') THEN
            CREATE INDEX idx_btree ON table1(column1);
            RAISE NOTICE 'B-Treeç´¢å¼• idx_btree åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_btree å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºB-Treeç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- Hashç´¢å¼•ï¼šåªæ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼ŒPostgreSQL 10+ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºHashç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'table1' AND indexname = 'idx_hash') THEN
            CREATE INDEX idx_hash ON table1 USING hash(column1);
            RAISE NOTICE 'Hashç´¢å¼• idx_hash åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_hash å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºHashç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- GINç´¢å¼•ï¼šå…¨æ–‡æœç´¢ã€æ•°ç»„ã€JSONBï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºGINç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'table1' AND indexname = 'idx_gin') THEN
            CREATE INDEX idx_gin ON table1 USING gin(column1 gin_trgm_ops);
            RAISE NOTICE 'GINç´¢å¼• idx_gin åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_gin å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºGINç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- GiSTç´¢å¼•ï¼šç©ºé—´æ•°æ®ã€å…¨æ–‡æœç´¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'table1') THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºGiSTç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'table1' AND indexname = 'idx_gist') THEN
            CREATE INDEX idx_gist ON table1 USING gist(column1);
            RAISE NOTICE 'GiSTç´¢å¼• idx_gist åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ table1 ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_gist å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºGiSTç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- BRINç´¢å¼•ï¼šå¤§è¡¨èŒƒå›´æŸ¥è¯¢ï¼Œå—çº§ç´¢å¼•
CREATE INDEX idx_brin ON table1 USING brin(column1);

-- HNSWç´¢å¼•ï¼šå‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼ˆpgvectorï¼‰
CREATE INDEX idx_hnsw ON table1 USING hnsw(embedding vector_l2_ops);
```

**PostgreSQL 18ç´¢å¼•é€‰æ‹©æ”¹è¿›**:

- æ›´æ™ºèƒ½çš„ç´¢å¼•é€‰æ‹©ï¼šæ”¹è¿›çš„ä»£ä»·ä¼°ç®—
- æ›´å¥½çš„ç»„åˆç´¢å¼•åˆ©ç”¨ï¼šè¯†åˆ«æ›´å¤šå¯ä»¥ä½¿ç”¨ç»„åˆç´¢å¼•çš„åœºæ™¯
- æ”¹è¿›çš„éƒ¨åˆ†ç´¢å¼•æ”¯æŒï¼šæ›´é«˜æ•ˆçš„éƒ¨åˆ†ç´¢å¼•ä½¿ç”¨

### 6.2 ç´¢å¼•æ‰«æä¼˜åŒ–

ç´¢å¼•æ‰«ææœ‰å¤šç§æ–¹å¼ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®æ•°æ®åˆ†å¸ƒé€‰æ‹©æœ€ä¼˜æ‰«ææ–¹å¼ã€‚

**ç´¢å¼•æ‰«æç±»å‹**:

PostgreSQLæ”¯æŒä¸‰ç§ä¸»è¦çš„ç´¢å¼•æ‰«ææ–¹å¼ï¼š

#### Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰

é¡ºåºæ‰«æç´¢å¼•ï¼Œç„¶åå›è¡¨è·å–æ•°æ®ï¼Œé€‚åˆéœ€è¦å›è¡¨çš„æƒ…å†µã€‚

```sql
-- Index Scanç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºIndex Scan';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºIndex Scan';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE dept_id = 10;
-- Index Scan using idx_emp_dept on employees
--   Index Cond: (dept_id = 10)
```

#### Index Only Scanï¼ˆä»…ç´¢å¼•æ‰«æï¼‰

åªæ‰«æç´¢å¼•ï¼Œä¸å›è¡¨ï¼Œéœ€è¦æŸ¥è¯¢çš„åˆ—éƒ½åœ¨ç´¢å¼•ä¸­ã€‚

```sql
-- Index Only Scanç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_emp_dept_name') THEN
            CREATE INDEX idx_emp_dept_name ON employees(dept_id, name);
            RAISE NOTICE 'ç´¢å¼• idx_emp_dept_name åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_emp_dept_name å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_emp_dept_name å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT dept_id, name FROM employees WHERE dept_id = 10;
-- Index Only Scan using idx_emp_dept_name on employees
--   Index Cond: (dept_id = 10)
--   Heap Fetches: 0  -- ä¸éœ€è¦å›è¡¨
```

#### Bitmap Index Scanï¼ˆä½å›¾ç´¢å¼•æ‰«æï¼‰

å…ˆæ‰«æç´¢å¼•æ„å»ºä½å›¾ï¼Œç„¶åå›è¡¨ï¼Œé€‚åˆå¤šä¸ªæ¡ä»¶æˆ–å¤§é‡æ•°æ®ã€‚

```sql
-- Bitmap Index Scanç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•æ¼”ç¤ºBitmap Index Scan';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æ¼”ç¤ºBitmap Index Scan';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¼”ç¤ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees
WHERE dept_id = 10 AND salary > 50000;
-- Bitmap Heap Scan on employees
--   Recheck Cond: ((dept_id = 10) AND (salary > 50000))
--   -> Bitmap Index Scan on idx_emp_dept
--         Index Cond: (dept_id = 10)
--   -> Bitmap Index Scan on idx_emp_salary
--         Index Cond: (salary > 50000)
```

**ç´¢å¼•æ‰«æä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºè¦†ç›–ç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_covering') THEN
            CREATE INDEX idx_covering ON employees(dept_id, name, salary);
            RAISE NOTICE 'è¦†ç›–ç´¢å¼• idx_covering åˆ›å»ºæˆåŠŸ';
        ELSE
            RAISE NOTICE 'è¦†ç›–ç´¢å¼• idx_covering å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_covering å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºè¦†ç›–ç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
-- å¦‚æœæŸ¥è¯¢åªéœ€è¦è¿™äº›åˆ—ï¼Œå¯ä»¥ä½¿ç”¨Index Only Scan

-- 2. è°ƒæ•´ç´¢å¼•åˆ—é¡ºåºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_optimal') THEN
            CREATE INDEX idx_optimal ON employees(dept_id, salary, name);
            RAISE NOTICE 'ç´¢å¼• idx_optimal åˆ›å»ºæˆåŠŸï¼ˆdept_idç”¨äºç­‰å€¼æŸ¥è¯¢ï¼Œæ”¾åœ¨æœ€å‰é¢ï¼‰';
        ELSE
            RAISE NOTICE 'ç´¢å¼• idx_optimal å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_optimal å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å‡å°‘ç´¢å¼•å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'employees') THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºéƒ¨åˆ†ç´¢å¼•';
            RETURN;
        END IF;

        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'employees' AND indexname = 'idx_partial') THEN
            CREATE INDEX idx_partial ON employees(salary)
            WHERE salary > 50000;
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_partial åˆ›å»ºæˆåŠŸï¼ˆåªç´¢å¼•é«˜è–ªå‘˜å·¥ï¼‰';
        ELSE
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_partial å·²å­˜åœ¨';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ employees ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_partial å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'åˆ›å»ºéƒ¨åˆ†ç´¢å¼•å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    unused_index_count int := 0;
    index_record RECORD;
BEGIN
    BEGIN
        FOR index_record IN
            SELECT
                schemaname,
                tablename,
                indexname,
                idx_scan,
                idx_tup_read,
                idx_tup_fetch
            FROM pg_stat_user_indexes
            WHERE idx_scan = 0
            LIMIT 10
        LOOP
            unused_index_count := unused_index_count + 1;
            RAISE NOTICE 'æœªä½¿ç”¨çš„ç´¢å¼•: %.%.% (æ‰«ææ¬¡æ•°: %)',
                index_record.schemaname, index_record.tablename, index_record.indexname, index_record.idx_scan;
        END LOOP;

        IF unused_index_count = 0 THEN
            RAISE NOTICE 'æœªå‘ç°æœªä½¿ç”¨çš„ç´¢å¼•';
        ELSE
            RAISE WARNING 'å‘ç° % ä¸ªæœªä½¿ç”¨çš„ç´¢å¼•ï¼Œå»ºè®®è€ƒè™‘åˆ é™¤', unused_index_count;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0;  -- æœªä½¿ç”¨çš„ç´¢å¼•
```

**ç´¢å¼•æ‰«ææ€§èƒ½è°ƒä¼˜**:

```sql
-- 1. è°ƒæ•´random_page_costï¼ˆSSDç¯å¢ƒï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET random_page_cost = 1.1;  -- SSDé»˜è®¤å€¼4.0å¤ªé«˜
        RAISE NOTICE 'å·²è®¾ç½® random_page_cost = 1.1ï¼ˆSSDç¯å¢ƒï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½® random_page_cost å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. è°ƒæ•´effective_cache_sizeï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET effective_cache_size = '8GB';  -- è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%
        RAISE NOTICE 'å·²è®¾ç½® effective_cache_size = 8GB';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½® effective_cache_size å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆè°ƒè¯•ç”¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET enable_seqscan = off;
        RAISE NOTICE 'å·²ç¦ç”¨é¡ºåºæ‰«æï¼Œå¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆè°ƒè¯•ç”¨ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç¦ç”¨é¡ºåºæ‰«æå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

EXPLAIN ANALYZE
SELECT * FROM table1 WHERE column1 = 'value';

DO $$
BEGIN
    BEGIN
        SET enable_seqscan = on;
        RAISE NOTICE 'å·²æ¢å¤é¡ºåºæ‰«æé»˜è®¤è®¾ç½®';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ¢å¤é¡ºåºæ‰«æè®¾ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

## 7. èšåˆä¼˜åŒ–

### 7.1 èšåˆç®—æ³•

PostgreSQLæ”¯æŒå¤šç§èšåˆç®—æ³•ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®æ•°æ®é‡å’Œå†…å­˜æƒ…å†µé€‰æ‹©æœ€ä¼˜ç®—æ³•ã€‚

**Hashèšåˆï¼ˆHash Aggregationï¼‰**:

é€‚åˆæ•°æ®é‡å¤§ã€åˆ†ç»„é”®åŸºæ•°é«˜çš„æƒ…å†µã€‚

```sql
-- Hashèšåˆç¤ºä¾‹
EXPLAIN (ANALYZE, BUFFERS)
SELECT dept_id, COUNT(*), AVG(salary), SUM(salary)
FROM employees
GROUP BY dept_id;

-- Hashèšåˆç®—æ³•ï¼š
-- 1. åœ¨å†…å­˜ä¸­æ„å»ºå“ˆå¸Œè¡¨
-- 2. å¯¹æ¯ä¸ªåˆ†ç»„é”®è®¡ç®—èšåˆå€¼
-- 3. å†…å­˜ä¸è¶³æ—¶ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶

-- Hashèšåˆé…ç½®
SET work_mem = '256MB';  -- å½±å“å“ˆå¸Œè¡¨å¤§å°
```

**Sortèšåˆï¼ˆSort Aggregationï¼‰**:

é€‚åˆæ•°æ®é‡å°æˆ–åˆ†ç»„é”®åŸºæ•°ä½çš„æƒ…å†µã€‚

```sql
-- Sortèšåˆç¤ºä¾‹
EXPLAIN (ANALYZE, BUFFERS)
SELECT dept_id, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id
ORDER BY dept_id;

-- Sortèšåˆç®—æ³•ï¼š
-- 1. æŒ‰åˆ†ç»„é”®æ’åº
-- 2. é¡ºåºæ‰«æè®¡ç®—èšåˆå€¼
-- 3. å¦‚æœå·²æœ‰æ’åºï¼Œæ€§èƒ½æ›´å¥½
```

**æ··åˆèšåˆï¼ˆMixed Aggregationï¼‰**:

PostgreSQL 18æ”¯æŒæ··åˆèšåˆï¼Œç»“åˆHashå’ŒSortçš„ä¼˜åŠ¿ã€‚

```sql
-- æ··åˆèšåˆç¤ºä¾‹
EXPLAIN (ANALYZE, BUFFERS)
SELECT dept_id, category, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id, category;

-- ä¼˜åŒ–å™¨å¯èƒ½é€‰æ‹©ï¼š
-- 1. å…ˆæŒ‰dept_idåˆ†ç»„ï¼ˆHashï¼‰
-- 2. å†æŒ‰categoryåˆ†ç»„ï¼ˆSortï¼‰
```

**èšåˆç®—æ³•é€‰æ‹©**:

| åœºæ™¯ | æ¨èç®—æ³• | åŸå›  |
| --- | --- | --- |
| åˆ†ç»„é”®åŸºæ•°é«˜ | Hashèšåˆ | å“ˆå¸Œè¡¨æŸ¥æ‰¾å¿« |
| åˆ†ç»„é”®åŸºæ•°ä½ | Sortèšåˆ | æ’åºå¼€é”€å° |
| éœ€è¦æ’åºç»“æœ | Sortèšåˆ | ä¸€æ¬¡æ’åºå®Œæˆ |
| å†…å­˜å……è¶³ | Hashèšåˆ | æ€§èƒ½æ›´å¥½ |
| å†…å­˜å—é™ | Sortèšåˆ | ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ |

**èšåˆä¼˜åŒ–é…ç½®**:

```sql
-- work_memå½±å“èšåˆç®—æ³•é€‰æ‹©
SET work_mem = '256MB';  -- å¢åŠ work_memå¯èƒ½é€‰æ‹©Hashèšåˆ

-- æŸ¥çœ‹èšåˆç»Ÿè®¡
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT dept_id, COUNT(*), AVG(salary)
FROM employees
GROUP BY dept_id;
```

**PostgreSQL 18èšåˆæ”¹è¿›**:

- æ”¹è¿›çš„Hashèšåˆï¼šæ›´å¥½çš„å†…å­˜ç®¡ç†
- æ··åˆèšåˆæ”¯æŒï¼šç»“åˆHashå’ŒSortä¼˜åŠ¿
- å¹¶è¡Œèšåˆå¢å¼ºï¼šæ›´å¥½çš„å¹¶è¡Œèšåˆæ”¯æŒ

### 7.2 çª—å£å‡½æ•°ä¼˜åŒ–

çª—å£å‡½æ•°å…è®¸åœ¨æŸ¥è¯¢ç»“æœé›†ä¸Šæ‰§è¡Œè®¡ç®—ï¼Œè€Œä¸éœ€è¦åˆ†ç»„ã€‚

**çª—å£å‡½æ•°ç±»å‹**:

```sql
-- 1. æ’åå‡½æ•°
SELECT
    name,
    salary,
    RANK() OVER (ORDER BY salary DESC) as rank,
    DENSE_RANK() OVER (ORDER BY salary DESC) as dense_rank,
    ROW_NUMBER() OVER (ORDER BY salary DESC) as row_num
FROM employees;

-- 2. èšåˆçª—å£å‡½æ•°
SELECT
    dept_id,
    name,
    salary,
    AVG(salary) OVER (PARTITION BY dept_id) as dept_avg,
    SUM(salary) OVER (PARTITION BY dept_id) as dept_total
FROM employees;

-- 3. çª—å£å¸§å‡½æ•°
SELECT
    name,
    salary,
    SUM(salary) OVER (
        ORDER BY salary
        ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
    ) as moving_sum
FROM employees;
```

**çª—å£å‡½æ•°ä¼˜åŒ–**:

```sql
-- 1. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–çª—å£å‡½æ•°
CREATE INDEX idx_emp_dept_salary ON employees(dept_id, salary);

-- çª—å£å‡½æ•°å¯ä»¥åˆ©ç”¨ç´¢å¼•æ’åº
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    dept_id,
    name,
    salary,
    RANK() OVER (PARTITION BY dept_id ORDER BY salary DESC)
FROM employees;
-- å¯ä»¥ä½¿ç”¨ç´¢å¼•é¿å…æ’åº

-- 2. å¹¶è¡Œçª—å£å‡½æ•°ï¼ˆPostgreSQL 18ï¼‰
SET max_parallel_workers_per_gather = 4;
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    dept_id,
    COUNT(*) OVER (PARTITION BY dept_id)
FROM employees;
-- å¯èƒ½ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œ
```

**çª—å£å‡½æ•°æ€§èƒ½ä¼˜åŒ–**:

```sql
-- 1. å‡å°‘çª—å£å‡½æ•°æ•°é‡
-- é¿å…å¤šä¸ªçª—å£å‡½æ•°ä½¿ç”¨ä¸åŒçš„PARTITION BY

-- 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—
CREATE MATERIALIZED VIEW emp_stats AS
SELECT
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary
FROM employees
GROUP BY dept_id;

-- 3. ä½¿ç”¨CTEä¼˜åŒ–å¤æ‚çª—å£å‡½æ•°
WITH ranked_employees AS (
    SELECT
        dept_id,
        name,
        salary,
        RANK() OVER (PARTITION BY dept_id ORDER BY salary DESC) as rank
    FROM employees
)
SELECT * FROM ranked_employees WHERE rank <= 10;
```

**PostgreSQL 18çª—å£å‡½æ•°æ”¹è¿›**:

- å¹¶è¡Œçª—å£å‡½æ•°æ”¯æŒï¼šæ”¯æŒå¹¶è¡Œæ‰§è¡Œçª—å£å‡½æ•°
- æ”¹è¿›çš„æ’åºä¼˜åŒ–ï¼šæ›´å¥½çš„çª—å£å‡½æ•°æ’åºæ€§èƒ½
- çª—å£å¸§ä¼˜åŒ–ï¼šæ›´é«˜æ•ˆçš„çª—å£å¸§è®¡ç®—

## 8. PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–å™¨æ–°ç‰¹æ€§

### 8.1 æ”¹è¿›çš„æŸ¥è¯¢è®¡åˆ’å™¨

PostgreSQL 18å¯¹æŸ¥è¯¢è®¡åˆ’å™¨è¿›è¡Œäº†å…¨é¢æ”¹è¿›ï¼Œæ˜¾è‘—æå‡äº†å¤æ‚æŸ¥è¯¢çš„æ€§èƒ½å’Œè®¡åˆ’è´¨é‡ã€‚

**æŸ¥è¯¢è®¡åˆ’å™¨æ”¹è¿›**ï¼š

```sql
-- PostgreSQL 18æŸ¥è¯¢è®¡åˆ’å™¨æ”¹è¿›ç¤ºä¾‹
-- 1. æ›´å‡†ç¡®çš„åŸºæ•°ä¼°è®¡
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT e.name, d.dept_name, p.project_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.lead_emp_id
WHERE e.salary > 50000
AND d.location = 'New York'
AND p.status = 'active';

-- PostgreSQL 18: åŸºæ•°ä¼°è®¡è¯¯å·®ä»25%é™ä½åˆ°15%
-- æ›´å‡†ç¡®çš„åŸºæ•°ä¼°è®¡å¸¦æ¥æ›´å¥½çš„è¿æ¥é¡ºåºé€‰æ‹©
```

**æ”¹è¿›ç‚¹**ï¼š

- åŸºæ•°ä¼°è®¡å‡†ç¡®æ€§æå‡ï¼šè¯¯å·®ä»25%é™ä½åˆ°15%
- æ›´æ™ºèƒ½çš„JOINæ–¹æ³•é€‰æ‹©
- æ”¹è¿›çš„æŸ¥è¯¢è®¡åˆ’æœç´¢ç©ºé—´æ¢ç´¢

### 8.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

PostgreSQL 18å¯¹è™šæ‹Ÿç”Ÿæˆåˆ—çš„æŸ¥è¯¢ä¼˜åŒ–è¿›è¡Œäº†ä¸“é—¨ä¼˜åŒ–ã€‚

**è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºå¸¦è™šæ‹Ÿç”Ÿæˆåˆ—çš„è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) VIRTUAL
);

-- ä¸ºè™šæ‹Ÿç”Ÿæˆåˆ—åˆ›å»ºç´¢å¼•ï¼ˆPostgreSQL 18æ”¯æŒï¼‰
CREATE INDEX idx_products_final_price ON products (final_price);

-- æŸ¥è¯¢ä¼˜åŒ–å™¨åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM products
WHERE final_price BETWEEN 50 AND 100;
-- PostgreSQL 18: å¯ä»¥ä½¿ç”¨final_priceä¸Šçš„ç´¢å¼•è¿›è¡Œä¼˜åŒ–
```

**ä¼˜åŠ¿**ï¼š

- æ”¯æŒåœ¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•
- ä¼˜åŒ–å™¨èƒ½å¤Ÿè¯†åˆ«è™šæ‹Ÿç”Ÿæˆåˆ—çš„æŸ¥è¯¢æ¨¡å¼
- è‡ªåŠ¨åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–

### 8.3 æ”¹è¿›çš„JOINæ–¹æ³•é€‰æ‹©

PostgreSQL 18æ”¹è¿›äº†JOINæ–¹æ³•é€‰æ‹©ç®—æ³•ï¼Œèƒ½å¤Ÿæ›´å‡†ç¡®åœ°é€‰æ‹©æœ€ä¼˜çš„JOINæ–¹æ³•ã€‚

**JOINæ–¹æ³•é€‰æ‹©æ”¹è¿›**ï¼š

```sql
-- å¤§è¡¨JOINä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT COUNT(*)
FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id
WHERE t1.category = 'A'
AND t2.status = 'active';

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´å‡†ç¡®çš„è¿æ¥åŸºæ•°ä¼°è®¡
-- 2. æ›´æ™ºèƒ½çš„å“ˆå¸Œè¿æ¥vsåˆå¹¶è¿æ¥é€‰æ‹©
-- 3. è€ƒè™‘å†…å­˜ä½¿ç”¨å’ŒI/Oæˆæœ¬çš„ç»¼åˆè¯„ä¼°
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´å‡†ç¡®çš„è¿æ¥åŸºæ•°ä¼°è®¡
- è€ƒè™‘å†…å­˜ä½¿ç”¨å’ŒI/Oæˆæœ¬çš„ç»¼åˆè¯„ä¼°
- æ›´æ™ºèƒ½çš„å“ˆå¸Œè¿æ¥vsåˆå¹¶è¿æ¥é€‰æ‹©

### 8.4 æ”¹è¿›çš„è¿æ¥é¡ºåºä¼˜åŒ–

PostgreSQL 18æ”¹è¿›äº†è¿æ¥é¡ºåºä¼˜åŒ–ç®—æ³•ï¼Œèƒ½å¤Ÿå¤„ç†æ›´å¤æ‚çš„å¤šè¡¨è¿æ¥æŸ¥è¯¢ã€‚

**è¿æ¥é¡ºåºä¼˜åŒ–æ”¹è¿›**ï¼š

```sql
-- å¤šè¡¨è¿æ¥ä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT e.name, d.dept_name, p.project_name, c.client_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
JOIN projects p ON e.emp_id = p.lead_emp_id
JOIN clients c ON p.client_id = c.client_id
WHERE e.salary > 50000
AND d.location = 'New York'
AND p.status = 'active'
AND c.industry = 'Technology';

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´æ™ºèƒ½çš„è¿æ¥é¡ºåºé€‰æ‹©
-- 2. è€ƒè™‘ç»Ÿè®¡ä¿¡æ¯å’Œç´¢å¼•å¯ç”¨æ€§çš„ç»¼åˆè¯„ä¼°
-- 3. æ”¯æŒæ›´å¤æ‚çš„è¿æ¥å›¾ä¼˜åŒ–
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´æ™ºèƒ½çš„è¿æ¥é¡ºåºé€‰æ‹©
- è€ƒè™‘ç»Ÿè®¡ä¿¡æ¯å’Œç´¢å¼•å¯ç”¨æ€§çš„ç»¼åˆè¯„ä¼°
- æ”¯æŒæ›´å¤æ‚çš„è¿æ¥å›¾ä¼˜åŒ–

### 8.5 æ”¹è¿›çš„ç´¢å¼•é€‰æ‹©

PostgreSQL 18æ”¹è¿›äº†ç´¢å¼•é€‰æ‹©ç®—æ³•ï¼Œèƒ½å¤Ÿæ›´å‡†ç¡®åœ°é€‰æ‹©æœ€ä¼˜ç´¢å¼•ã€‚

**ç´¢å¼•é€‰æ‹©æ”¹è¿›**ï¼š

```sql
-- å¤åˆæ¡ä»¶æŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰
CREATE INDEX idx_emp_dept_salary ON employees (dept_id, salary);
CREATE INDEX idx_emp_salary ON employees (salary);

EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees
WHERE dept_id = 1 AND salary > 50000;

-- PostgreSQL 18æ”¹è¿›ï¼š
-- 1. æ›´å‡†ç¡®çš„ç´¢å¼•é€‰æ‹©æ€§ä¼°è®¡
-- 2. æ›´æ™ºèƒ½çš„ç´¢å¼•ç»„åˆé€‰æ‹©
-- 3. è€ƒè™‘ç´¢å¼•ç»´æŠ¤æˆæœ¬çš„ç»¼åˆè¯„ä¼°
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´å‡†ç¡®çš„ç´¢å¼•é€‰æ‹©æ€§ä¼°è®¡
- æ›´æ™ºèƒ½çš„ç´¢å¼•ç»„åˆé€‰æ‹©
- è€ƒè™‘ç´¢å¼•ç»´æŠ¤æˆæœ¬çš„ç»¼åˆè¯„ä¼°

### 8.6 PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–å™¨æœ€ä½³å®è·µ

**æœ€ä½³å®è·µæ€»ç»“**ï¼š

```sql
-- 1. åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) VIRTUAL
);
CREATE INDEX idx_products_final_price ON products (final_price);

-- 2. ç¡®ä¿ç»Ÿè®¡ä¿¡æ¯åŠæ—¶æ›´æ–°
ANALYZE employees;
ANALYZE departments;

-- 3. åˆ›å»ºåˆé€‚çš„ç´¢å¼•æ”¯æŒæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_emp_dept_salary ON employees (dept_id, salary);

-- 4. ç›‘æ§æŸ¥è¯¢è®¡åˆ’è´¨é‡
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM employees WHERE dept_id = 1 AND salary > 50000;

-- 5. åˆ©ç”¨PostgreSQL 18çš„æ”¹è¿›åŸºæ•°ä¼°è®¡
-- ç¡®ä¿ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®ï¼Œè®©ä¼˜åŒ–å™¨åšå‡ºæ›´å¥½çš„å†³ç­–
```

## 9. æ€§èƒ½è°ƒä¼˜

### 9.1 ä¼˜åŒ–å™¨é…ç½®è°ƒä¼˜

```sql
-- å·¥ä½œå†…å­˜é…ç½®
SET work_mem = '256MB';
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id;

-- ç»´æŠ¤å·¥ä½œå†…å­˜
SET maintenance_work_mem = '1GB';
VACUUM ANALYZE large_table;

-- æœ‰æ•ˆç¼“å­˜å¤§å°
SET effective_cache_size = '8GB';
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE salary > 50000;
```

### 9.2 æŸ¥è¯¢æç¤º

```sql
-- ä½¿ç”¨æç¤ºæ§åˆ¶ä¼˜åŒ–å™¨
EXPLAIN (ANALYZE, BUFFERS)
SELECT /*+ HashJoin(e d) */ e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- å¼ºåˆ¶ç´¢å¼•ä½¿ç”¨
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE emp_id = 1001;
-- é€šè¿‡è®¾ç½®å‚æ•°å¼ºåˆ¶ç´¢å¼•æ‰«æ
SET enable_seqscan = off;
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employees WHERE emp_id = 1001;
```

## 10. å®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¤æ‚åˆ†ææŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
WITH dept_stats AS (
    SELECT
        dept_id,
        COUNT(*) as emp_count,
        AVG(salary) as avg_salary,
        MAX(salary) as max_salary
    FROM employees
    GROUP BY dept_id
),
ranked_employees AS (
    SELECT
        e.*,
        ROW_NUMBER() OVER (PARTITION BY e.dept_id ORDER BY e.salary DESC) as salary_rank
    FROM employees e
)
SELECT
    d.dept_name,
    ds.emp_count,
    ds.avg_salary,
    re.name as top_earner,
    re.salary as top_salary
FROM departments d
JOIN dept_stats ds ON d.dept_id = ds.dept_id
JOIN ranked_employees re ON d.dept_id = re.dept_id AND re.salary_rank = 1
WHERE ds.emp_count > 10
ORDER BY ds.avg_salary DESC;
```

### 9.2 å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM large_table
ORDER BY id
LIMIT 20 OFFSET 1000000;

-- ä½¿ç”¨æ¸¸æ ‡ä¼˜åŒ–
BEGIN;
DECLARE cur CURSOR FOR
SELECT * FROM large_table ORDER BY id;
FETCH 20 FROM cur;
FETCH 20 FROM cur;
CLOSE cur;
COMMIT;
```

## 11. ç›¸å…³æ¦‚å¿µ

### 11.1 ä¸Šä½æ¦‚å¿µ

- **æŸ¥è¯¢å¤„ç†**: æ›´å¹¿æ³›çš„æŸ¥è¯¢å¤„ç†æœºåˆ¶
- **æ•°æ®åº“ä¼˜åŒ–**: æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
- **æ‰§è¡Œå¼•æ“**: æŸ¥è¯¢æ‰§è¡Œæœºåˆ¶

### 11.2 ä¸‹ä½æ¦‚å¿µ

- **ä»£ä»·æ¨¡å‹**: æŸ¥è¯¢ä»£ä»·ä¼°ç®—
- **æŸ¥è¯¢é‡å†™**: æŸ¥è¯¢è½¬æ¢æœºåˆ¶
- **è¿æ¥ä¼˜åŒ–**: è¿æ¥ç®—æ³•é€‰æ‹©
- **ç´¢å¼•ä¼˜åŒ–**: ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–

### 11.3 å¹³è¡Œæ¦‚å¿µ

- **æŸ¥è¯¢è®¡åˆ’å™¨**: æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
- **ç»Ÿè®¡ä¿¡æ¯**: æ•°æ®åˆ†å¸ƒç»Ÿè®¡
- **æ‰§è¡Œå¼•æ“**: æŸ¥è¯¢æ‰§è¡Œæœºåˆ¶

## 12. ç›¸å…³æ–‡æ¡£

- [ç»Ÿè®¡ä¿¡æ¯ä¸æŸ¥è¯¢è°ƒä¼˜](./02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ç»Ÿè®¡ä¿¡æ¯ç®¡ç†
- [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–ã€åˆ—å­˜å‚¨ä»£ä»·ä¼°ç®—ğŸ†•
- [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../../25-ç†è®ºä½“ç³»/25.01-å½¢å¼åŒ–æ–¹æ³•/01.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - æŸ¥è¯¢ä¼˜åŒ–å™¨ç­‰ä»·æ€§éªŒè¯
- [å­¦æœ¯ç ”ç©¶å‰æ²¿](../../25-ç†è®ºä½“ç³»/25.01-å½¢å¼åŒ–æ–¹æ³•/01.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - æŸ¥è¯¢ä¼˜åŒ–ç†è®ºç ”ç©¶

### 11.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å®æˆ˜æ¡ˆä¾‹](../../19-å®æˆ˜æ¡ˆä¾‹/README.md) â­ - å®Œæ•´çš„å®æˆ˜æ¡ˆä¾‹é›†åˆ
- [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - æŸ¥è¯¢ä¼˜åŒ–å®è·µæ¡ˆä¾‹
- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](./02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æ€§èƒ½åˆ†æå®è·µ

## 13. å‚è€ƒæ–‡çŒ®

1. Selinger, P. G., et al. (1979). Access path selection in a relational database management system. ACM SIGMOD Record, 8(2), 23-34.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. Graefe, G. (1995). The Cascades framework for query optimization. IEEE Data Engineering Bulletin, 18(3), 19-29.
4. Ioannidis, Y. E. (1996). Query optimization. ACM Computing Surveys, 28(1), 121-123.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

## 14. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### æŸ¥è¯¢ä¸ä¼˜åŒ–

- â­â­â­ [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](./02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æ‰§è¡Œè®¡åˆ’åˆ†æå®è·µ
- â­â­â­ [ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹](./02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ç»Ÿè®¡ä¿¡æ¯å¯¹ä¼˜åŒ–å™¨çš„å½±å“
- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](./02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - ç´¢å¼•é€‰æ‹©ä¼˜åŒ–
- â­â­ [å¹¶è¡ŒæŸ¥è¯¢å¤„ç†](./02.05-å¹¶è¡ŒæŸ¥è¯¢å¤„ç†.md) - å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†](../../01-æ ¸å¿ƒåŸºç¡€/01.04-SQLè¯­è¨€/01.03-SQLè¯­è¨€è§„èŒƒä¸æ ‡å‡†.md) - SQLè¯­è¨€åŸºç¡€
- â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - åˆ—å­˜å‚¨æ¶æ„ã€åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ–ğŸ†•
- â­ [å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º](../../01-æ ¸å¿ƒåŸºç¡€/01.03-æ•°æ®æ¨¡å‹/01.02-å…³ç³»æ•°æ®æ¨¡å‹ä¸ç†è®º.md) - å…³ç³»æ¨¡å‹ç†è®ºåŸºç¡€

#### æ•°æ®æ¨¡å‹è®¾è®¡

- â­â­ [æ•°æ®æ¨¡å‹è®¾è®¡](../../17-æ•°æ®æ¨¡å‹è®¾è®¡/README.md) - æŸ¥è¯¢åˆ†æå®è·µ

#### ç†è®ºåŸºç¡€

- â­â­ [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../../25-ç†è®ºä½“ç³»/25.01-å½¢å¼åŒ–æ–¹æ³•/01.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - æŸ¥è¯¢ä¼˜åŒ–å™¨å½¢å¼åŒ–éªŒè¯
- â­ [å­¦æœ¯ç ”ç©¶å‰æ²¿](../../25-ç†è®ºä½“ç³»/25.01-å½¢å¼åŒ–æ–¹æ³•/01.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - æŸ¥è¯¢ä¼˜åŒ–ç ”ç©¶

#### éƒ¨ç½²æ¶æ„

- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜å®è·µæŒ‡å—

#### è¿ç»´å®è·µ

- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- â­â­ [æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“](../../16-åº”ç”¨è®¾è®¡ä¸å¼€å‘/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - ä¼˜åŒ–å™¨é—®é¢˜æ¡ˆä¾‹

### å¤–éƒ¨èµ„æº

- [PostgreSQLæŸ¥è¯¢è§„åˆ’å™¨æ–‡æ¡£](https://www.postgresql.org/docs/current/planner-optimizer.html)
- [PostgreSQLæŸ¥è¯¢ä¼˜åŒ–é…ç½®](https://www.postgresql.org/docs/current/runtime-config-query.html)
- [PostgreSQLæŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ](https://wiki.postgresql.org/wiki/Performance_Optimization)

---

## 15. Wikidataå¯¹é½

### 14.1 æŸ¥è¯¢ä¼˜åŒ–å™¨æ¦‚å¿µå¯¹é½

- **Wikidata ID**: Q192490 (Query optimization)
- **ç›¸å…³å±æ€§**:
  - P31: Q192490 (instance of: database optimization technique)
  - P361: Q176165 (part of: database management system)
  - P1382: Q192490 (partially coincident with: algorithm)
- **å¤–éƒ¨é“¾æ¥**:
  - [Wikipedia - Query optimization](https://en.wikipedia.org/wiki/Query_optimization)
  - [Wikipedia - Relational algebra](https://en.wikipedia.org/wiki/Relational_algebra)
  - [Wikipedia - Dynamic programming](https://en.wikipedia.org/wiki/Dynamic_programming)

### 14.2 PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨å¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/planner-optimizer.html>
  - <https://www.postgresql.org/docs/current/runtime-config-query.html>

---

## 16. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯

### 15.1 æŸ¥è¯¢é‡å†™ç­‰ä»·æ€§è¯æ˜

**å®šç†**: å¦‚æœæŸ¥è¯¢ Qâ‚ å’Œ Qâ‚‚ åœ¨å…³ç³»ä»£æ•°ä¸Šç­‰ä»·ï¼Œåˆ™å®ƒä»¬çš„æ‰§è¡Œç»“æœç›¸åŒã€‚

**è¯æ˜**:

```latex
\begin{theorem}[æŸ¥è¯¢é‡å†™ç­‰ä»·æ€§]
è®¾æŸ¥è¯¢ Q_1 å’Œ Q_2 åœ¨å…³ç³»ä»£æ•°ä¸Šç­‰ä»·ï¼Œå³ Q_1 \equiv Q_2ã€‚

ç­‰ä»·æ€§å®šä¹‰ï¼š
Q_1 \equiv Q_2 \Leftrightarrow \forall D: Q_1(D) = Q_2(D)

å…¶ä¸­ D ä¸ºä»»æ„æ•°æ®åº“å®ä¾‹ã€‚

å…³ç³»ä»£æ•°ç­‰ä»·æ€§è§„åˆ™ï¼š
1. é€‰æ‹©äº¤æ¢å¾‹ï¼š\sigma_{p_1}(\sigma_{p_2}(R)) = \sigma_{p_2}(\sigma_{p_1}(R))
2. æŠ•å½±äº¤æ¢å¾‹ï¼š\pi_{A_1}(\pi_{A_2}(R)) = \pi_{A_1}(R)ï¼ˆå¦‚æœ A_1 \subseteq A_2ï¼‰
3. é€‰æ‹©ä¸æŠ•å½±äº¤æ¢ï¼š\pi_A(\sigma_p(R)) = \sigma_p(\pi_A(R))ï¼ˆå¦‚æœ p åªæ¶‰åŠ A ä¸­çš„å±æ€§ï¼‰

åŸºäºè¿™äº›è§„åˆ™ï¼Œå¯ä»¥è¯æ˜æŸ¥è¯¢é‡å†™çš„ç­‰ä»·æ€§ã€‚

å› æ­¤ï¼Œå¦‚æœ Q_1 \equiv Q_2ï¼Œåˆ™ \forall D: Q_1(D) = Q_2(D)ã€‚
\end{theorem}
```

### 15.2 è¿æ¥é¡ºåºä¼˜åŒ–æœ€ä¼˜æ€§è¯æ˜

**å®šç†**: åŠ¨æ€è§„åˆ’ç®—æ³•å¯ä»¥æ‰¾åˆ°è¿æ¥é¡ºåºçš„å±€éƒ¨æœ€ä¼˜è§£ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[è¿æ¥é¡ºåºä¼˜åŒ–æœ€ä¼˜æ€§]
è®¾ n ä¸ªè¡¨çš„è¿æ¥æŸ¥è¯¢ï¼ŒåŠ¨æ€è§„åˆ’ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º O(2^n \times n^2)ã€‚

æœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼š
è®¾æœ€ä¼˜è¿æ¥é¡ºåºä¸º T_1 \bowtie T_2 \bowtie \ldots \bowtie T_nã€‚

å¯¹äºä»»æ„åˆ†å‰²ç‚¹ kï¼Œæœ‰ï¼š
\text{Cost}(T_1 \bowtie \ldots \bowtie T_n) = \min_{k} \{\text{Cost}(T_1 \bowtie \ldots \bowtie T_k) + \text{Cost}(T_{k+1} \bowtie \ldots \bowtie T_n) + \text{Cost}(\text{join}(T_{1..k}, T_{k+1..n}))\}

åŠ¨æ€è§„åˆ’é€’æ¨å…³ç³»ï¼š
\text{DP}[S] = \min_{T_i \in S} \{\text{DP}[S \setminus \{T_i\}] + \text{Cost}(\text{join}(S \setminus \{T_i\}, T_i))\}

å…¶ä¸­ S ä¸ºè¡¨çš„å­é›†ã€‚

ç”±äºæ»¡è¶³æœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼ŒåŠ¨æ€è§„åˆ’ç®—æ³•å¯ä»¥æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜è§£ã€‚

æ—¶é—´å¤æ‚åº¦ï¼šO(2^n \times n^2)
ç©ºé—´å¤æ‚åº¦ï¼šO(2^n)
\end{theorem}
```

### 15.3 è°“è¯ä¸‹æ¨æ­£ç¡®æ€§è¯æ˜

**å®šç†**: è°“è¯ä¸‹æ¨ä¸ä¼šæ”¹å˜æŸ¥è¯¢ç»“æœï¼Œä½†å¯èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[è°“è¯ä¸‹æ¨æ­£ç¡®æ€§]
è®¾æŸ¥è¯¢ Q = \sigma_p(R_1 \bowtie R_2)ï¼Œå…¶ä¸­ p ä¸ºè°“è¯æ¡ä»¶ã€‚

åŸå§‹æŸ¥è¯¢ï¼š
Q = \sigma_p(R_1 \bowtie R_2)

è°“è¯ä¸‹æ¨åï¼š
Q' = (\sigma_{p_1}(R_1)) \bowtie (\sigma_{p_2}(R_2))

å…¶ä¸­ p = p_1 \land p_2ï¼Œp_1 åªæ¶‰åŠ R_1 çš„å±æ€§ï¼Œp_2 åªæ¶‰åŠ R_2 çš„å±æ€§ã€‚

ç­‰ä»·æ€§è¯æ˜ï¼š
\sigma_p(R_1 \bowtie R_2) = \sigma_{p_1 \land p_2}(R_1 \bowtie R_2)
= \sigma_{p_1}(\sigma_{p_2}(R_1 \bowtie R_2))
= \sigma_{p_1}(R_1 \bowtie \sigma_{p_2}(R_2))
= (\sigma_{p_1}(R_1)) \bowtie (\sigma_{p_2}(R_2))

å› æ­¤ï¼ŒQ \equiv Q'ã€‚

æ€§èƒ½æå‡ï¼š
- å‡å°‘è¿æ¥æ“ä½œçš„è¾“å…¥å¤§å°
- å¯èƒ½åˆ©ç”¨ç´¢å¼•åŠ é€Ÿè¿‡æ»¤
- å‡å°‘ä¸­é—´ç»“æœé›†å¤§å°

å› æ­¤ï¼Œè°“è¯ä¸‹æ¨ä¸ä¼šæ”¹å˜æŸ¥è¯¢ç»“æœï¼Œä½†å¯èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚
\end{theorem}
```

## åˆå¹¶æ¥æºä¸æ˜ å°„ï¼ˆæ•´åˆä¸­ï¼‰

- 1.1.4-æŸ¥è¯¢ä¼˜åŒ–-å¢å¼ºç‰ˆ.md
- 1.1.4-æŸ¥è¯¢ä¼˜åŒ–-å¢å¼ºç‰ˆ.md
- 1.1.7-æŸ¥è¯¢ä¼˜åŒ–.md
- 1.1.148-PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨å›½é™…åŒ–æ ‡å‡†å®šä¹‰.md
- 1.1.49-é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ.mdï¼ˆè¯¯å·®ç•Œä¸ç»Ÿè®¡éƒ¨åˆ†é“¾æ¥è‡³ 02.03ï¼‰

### å¾…åŠäº‹é¡¹

ä»¥ä¸‹äº‹é¡¹è®¡åˆ’åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„ï¼š

#### 1. æ¥å£æè¿°ç»Ÿä¸€

- [ ] ç»Ÿä¸€ä»£ä»·æ¨¡å‹ä¸ç»Ÿè®¡æ¥å£æè¿°
  - ç›®æ ‡ï¼šç¡®ä¿ä»£ä»·æ¨¡å‹å’Œç»Ÿè®¡ä¿¡æ¯æ¥å£æè¿°çš„ä¸€è‡´æ€§
  - ä¼˜å…ˆçº§ï¼šä¸­
  - è®¡åˆ’ï¼šåˆ›å»ºç»Ÿä¸€çš„æ¥å£è§„èŒƒæ–‡æ¡£

#### 2. å†…å®¹å»é‡

- [ ] å»é‡è¿æ¥é¡ºåºä¸è®¿é—®è·¯å¾„ç« èŠ‚
  - ç›®æ ‡ï¼šæ¶ˆé™¤é‡å¤å†…å®¹ï¼Œæé«˜æ–‡æ¡£æ¸…æ™°åº¦
  - ä¼˜å…ˆçº§ï¼šä¸­
  - è®¡åˆ’ï¼šåˆå¹¶é‡å¤ç« èŠ‚ï¼Œå»ºç«‹æ¸…æ™°çš„å¼•ç”¨å…³ç³»

#### 3. å½¢å¼åŒ–è¯æ˜å¤–é“¾

- [ ] å°†éƒ¨åˆ†å½¢å¼åŒ–è¯æ˜å¤–é“¾è‡³ç†è®ºåŸºç¡€æ–‡æ¡£ï¼ˆ`æ•°æ®åº“ç†è®º/`ï¼‰
  - ç›®æ ‡ï¼šå°†è¯¦ç»†çš„å½¢å¼åŒ–è¯æ˜ç§»è‡³ç†è®ºåŸºç¡€æ–‡æ¡£ï¼Œä¿æŒæœ¬æ–‡æ¡£çš„å®ç”¨æ€§
  - ä¼˜å…ˆçº§ï¼šä½
  - è®¡åˆ’ï¼šè¯†åˆ«éœ€è¦å¤–é“¾çš„å½¢å¼åŒ–è¯æ˜ï¼Œå»ºç«‹å¼•ç”¨é“¾æ¥
