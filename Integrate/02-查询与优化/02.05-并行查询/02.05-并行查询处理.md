---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL/03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.05-å¹¶è¡ŒæŸ¥è¯¢å¤„ç†.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¹¶è¡ŒæŸ¥è¯¢å¤„ç†

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å¹¶è¡ŒæŸ¥è¯¢ã€å¤§æ•°æ®åˆ†æã€æ€§èƒ½ä¼˜åŒ–
> ğŸ†• **PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**: å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½æå‡30-40%ã€æ›´æ™ºèƒ½çš„å¹¶è¡Œåº¦å†³ç­–ã€parallel_leader_participationæ–°å‚æ•°ã€æ›´å¥½çš„è´Ÿè½½å‡è¡¡ã€å¼‚æ­¥I/Oæå‡å¹¶è¡ŒI/Oæ€§èƒ½2-3å€ã€BRINç´¢å¼•å¹¶è¡Œæ„å»ºã€æ”¹è¿›çš„å¹¶è¡Œèšåˆç®—æ³•

---

## ğŸ“‹ ç›®å½•

- [å¹¶è¡ŒæŸ¥è¯¢å¤„ç†](#å¹¶è¡ŒæŸ¥è¯¢å¤„ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#-å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [å¹¶è¡ŒæŸ¥è¯¢ç±»å‹å¯¹æ¯”çŸ©é˜µ](#å¹¶è¡ŒæŸ¥è¯¢ç±»å‹å¯¹æ¯”çŸ©é˜µ)
    - [å¹¶è¡Œåº¦é…ç½®å¯¹æ¯”çŸ©é˜µ](#å¹¶è¡Œåº¦é…ç½®å¯¹æ¯”çŸ©é˜µ)
    - [å¹¶è¡Œç®—æ³•å¯¹æ¯”çŸ©é˜µ](#å¹¶è¡Œç®—æ³•å¯¹æ¯”çŸ©é˜µ)
  - [ğŸŒ Wikipediaå¯¹é½](#-wikipediaå¯¹é½)
    - [å¹¶è¡Œè®¡ç®—æ¦‚å¿µå¯¹é½](#å¹¶è¡Œè®¡ç®—æ¦‚å¿µå¯¹é½)
    - [Amdahlå®šå¾‹å¯¹é½](#amdahlå®šå¾‹å¯¹é½)
    - [è´Ÿè½½å‡è¡¡æ¦‚å¿µå¯¹é½](#è´Ÿè½½å‡è¡¡æ¦‚å¿µå¯¹é½)
  - [1. å®šä¹‰ä¸å½¢å¼åŒ–](#1-å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1 å¹¶è¡Œè®¡ç®—ç†è®º](#21-å¹¶è¡Œè®¡ç®—ç†è®º)
    - [2.2 è´Ÿè½½å‡è¡¡ç†è®º](#22-è´Ÿè½½å‡è¡¡ç†è®º)
  - [3. PostgreSQLå¹¶è¡ŒæŸ¥è¯¢æ¶æ„](#3-postgresqlå¹¶è¡ŒæŸ¥è¯¢æ¶æ„)
    - [3.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®](#31-å¹¶è¡ŒæŸ¥è¯¢é…ç½®)
    - [3.2 å¹¶è¡ŒæŸ¥è¯¢å¯ç”¨](#32-å¹¶è¡ŒæŸ¥è¯¢å¯ç”¨)
  - [4. å¹¶è¡Œæ‰«æ](#4-å¹¶è¡Œæ‰«æ)
    - [4.1 å¹¶è¡Œé¡ºåºæ‰«æ](#41-å¹¶è¡Œé¡ºåºæ‰«æ)
    - [4.2 å¹¶è¡Œç´¢å¼•æ‰«æ](#42-å¹¶è¡Œç´¢å¼•æ‰«æ)
    - [4.3 å¹¶è¡Œåˆ†åŒºæ‰«æ](#43-å¹¶è¡Œåˆ†åŒºæ‰«æ)
  - [5. å¹¶è¡Œè¿æ¥](#5-å¹¶è¡Œè¿æ¥)
    - [5.1 å¹¶è¡Œå“ˆå¸Œè¿æ¥](#51-å¹¶è¡Œå“ˆå¸Œè¿æ¥)
    - [5.2 å¹¶è¡ŒåµŒå¥—å¾ªç¯è¿æ¥](#52-å¹¶è¡ŒåµŒå¥—å¾ªç¯è¿æ¥)
    - [5.3 å¹¶è¡Œåˆå¹¶è¿æ¥](#53-å¹¶è¡Œåˆå¹¶è¿æ¥)
  - [6. å¹¶è¡Œèšåˆ](#6-å¹¶è¡Œèšåˆ)
    - [6.1 å¹¶è¡Œå“ˆå¸Œèšåˆ](#61-å¹¶è¡Œå“ˆå¸Œèšåˆ)
    - [6.2 å¹¶è¡Œæ’åºèšåˆ](#62-å¹¶è¡Œæ’åºèšåˆ)
    - [6.3 å¹¶è¡Œçª—å£å‡½æ•°](#63-å¹¶è¡Œçª—å£å‡½æ•°)
  - [7. PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢æ–°ç‰¹æ€§](#7-postgresql-18å¹¶è¡ŒæŸ¥è¯¢æ–°ç‰¹æ€§)
    - [7.1 parallel\_leader\_participationå‚æ•°](#71-parallel_leader_participationå‚æ•°)
    - [7.2 æ›´æ™ºèƒ½çš„å¹¶è¡Œåº¦å†³ç­–](#72-æ›´æ™ºèƒ½çš„å¹¶è¡Œåº¦å†³ç­–)
    - [7.3 æ”¹è¿›çš„å¹¶è¡Œèšåˆç®—æ³•](#73-æ”¹è¿›çš„å¹¶è¡Œèšåˆç®—æ³•)
    - [7.4 å¼‚æ­¥I/Oæå‡å¹¶è¡ŒI/Oæ€§èƒ½](#74-å¼‚æ­¥ioæå‡å¹¶è¡Œioæ€§èƒ½)
    - [7.5 BRINç´¢å¼•å¹¶è¡Œæ„å»º](#75-brinç´¢å¼•å¹¶è¡Œæ„å»º)
  - [8. å¹¶è¡Œç»´æŠ¤æ“ä½œ](#8-å¹¶è¡Œç»´æŠ¤æ“ä½œ)
    - [8.1 å¹¶è¡ŒVACUUM](#81-å¹¶è¡Œvacuum)
    - [8.2 å¹¶è¡Œç´¢å¼•æ„å»º](#82-å¹¶è¡Œç´¢å¼•æ„å»º)
    - [8.3 å¹¶è¡Œæ•°æ®åŠ è½½](#83-å¹¶è¡Œæ•°æ®åŠ è½½)
  - [9. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#9-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
    - [9.1 å¹¶è¡Œåº¦ä¼˜åŒ–](#91-å¹¶è¡Œåº¦ä¼˜åŒ–)
    - [9.2 è´Ÿè½½å‡è¡¡ä¼˜åŒ–](#92-è´Ÿè½½å‡è¡¡ä¼˜åŒ–)
    - [9.3 å†…å­˜ä¼˜åŒ–](#93-å†…å­˜ä¼˜åŒ–)
  - [10. å®é™…åº”ç”¨æ¡ˆä¾‹](#10-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 å¤§æ•°æ®åˆ†ææŸ¥è¯¢](#101-å¤§æ•°æ®åˆ†ææŸ¥è¯¢)
    - [10.2 å¹¶è¡Œæ•°æ®è¿ç§»](#102-å¹¶è¡Œæ•°æ®è¿ç§»)
    - [10.3 å¹¶è¡ŒæŠ¥è¡¨ç”Ÿæˆ](#103-å¹¶è¡ŒæŠ¥è¡¨ç”Ÿæˆ)
    - [10.4 PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢æœ€ä½³å®è·µ](#104-postgresql-18å¹¶è¡ŒæŸ¥è¯¢æœ€ä½³å®è·µ)
  - [11. æ€§èƒ½ç›‘æ§](#11-æ€§èƒ½ç›‘æ§)
    - [11.1 å¹¶è¡ŒæŸ¥è¯¢ç›‘æ§](#111-å¹¶è¡ŒæŸ¥è¯¢ç›‘æ§)
    - [11.2 å·¥ä½œè¿›ç¨‹ç›‘æ§](#112-å·¥ä½œè¿›ç¨‹ç›‘æ§)
  - [12. ç›¸å…³æ¦‚å¿µ](#12-ç›¸å…³æ¦‚å¿µ)
    - [12.1 ä¸Šä½æ¦‚å¿µ](#121-ä¸Šä½æ¦‚å¿µ)
    - [12.2 ä¸‹ä½æ¦‚å¿µ](#122-ä¸‹ä½æ¦‚å¿µ)
    - [12.3 å¹³è¡Œæ¦‚å¿µ](#123-å¹³è¡Œæ¦‚å¿µ)
  - [13. å‚è€ƒæ–‡çŒ®](#13-å‚è€ƒæ–‡çŒ®)
  - [14. Wikidataå¯¹é½](#14-wikidataå¯¹é½)
  - [15. äº¤å‰å¼•ç”¨](#15-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¹¶è¡ŒæŸ¥è¯¢å¤„ç†))
    ç†è®ºåŸºç¡€
      å¹¶è¡Œè®¡ç®—ç†è®º
        Amdahlå®šå¾‹
        Gustafsonå®šå¾‹
        å¹¶è¡Œåº¦ç†è®º
      è´Ÿè½½å‡è¡¡ç†è®º
        å·¥ä½œåˆ†é…
        è´Ÿè½½å‡è¡¡ç®—æ³•
        åŠ¨æ€è°ƒæ•´
    PostgreSQLæ¶æ„
      å¹¶è¡Œé…ç½®
        å¹¶è¡Œåº¦è®¾ç½®
        å·¥ä½œè¿›ç¨‹é…ç½®
        å†…å­˜é…ç½®
      å¹¶è¡Œå¯ç”¨
        è‡ªåŠ¨å¯ç”¨
        æ‰‹åŠ¨æ§åˆ¶
        æŸ¥è¯¢æç¤º
      å¹¶è¡Œåº¦å†³ç­–
        ä»£ä»·ä¼°ç®—
        èµ„æºå¯ç”¨æ€§
        æŸ¥è¯¢å¤æ‚åº¦
    å¹¶è¡Œæ‰«æ
      é¡ºåºæ‰«æ
        å—èŒƒå›´åˆ†é…
        åŠ¨æ€è´Ÿè½½å‡è¡¡
      ç´¢å¼•æ‰«æ
        å¹¶è¡Œç´¢å¼•æ‰«æ
        å¹¶è¡Œä½å›¾æ‰«æ
      åˆ†åŒºæ‰«æ
        åˆ†åŒºå¹¶è¡Œ
        è·¨åˆ†åŒºå¹¶è¡Œ
    å¹¶è¡Œè¿æ¥
      å“ˆå¸Œè¿æ¥
        å¹¶è¡Œå“ˆå¸Œæ„å»º
        å¹¶è¡Œå“ˆå¸Œæ¢æµ‹
      åµŒå¥—å¾ªç¯
        å¹¶è¡ŒåµŒå¥—å¾ªç¯
        åŠ¨æ€åˆ†åŒº
      åˆå¹¶è¿æ¥
        å¹¶è¡Œæ’åº
        å¹¶è¡Œåˆå¹¶
    å¹¶è¡Œèšåˆ
      å“ˆå¸Œèšåˆ
        å¹¶è¡Œå“ˆå¸Œèšåˆ
        ä¸¤é˜¶æ®µèšåˆ
      æ’åºèšåˆ
        å¹¶è¡Œæ’åº
        å¹¶è¡Œåˆ†ç»„
      çª—å£å‡½æ•°
        å¹¶è¡Œçª—å£å‡½æ•°
        å¹¶è¡Œæ’åº
    å¹¶è¡Œç»´æŠ¤
      VACUUM
        å¹¶è¡ŒVACUUM
        å¹¶è¡Œæ¸…ç†
      ç´¢å¼•æ„å»º
        å¹¶è¡Œç´¢å¼•æ„å»º
        å¹¶è¡Œæ’åº
      æ•°æ®åŠ è½½
        å¹¶è¡ŒCOPY
        å¹¶è¡Œæ’å…¥
    æ€§èƒ½ä¼˜åŒ–
      å¹¶è¡Œåº¦ä¼˜åŒ–
        æœ€ä¼˜å¹¶è¡Œåº¦
        èµ„æºé™åˆ¶
      è´Ÿè½½å‡è¡¡
        å·¥ä½œåˆ†é…
        åŠ¨æ€è°ƒæ•´
      å†…å­˜ä¼˜åŒ–
        å…±äº«å†…å­˜
        å·¥ä½œå†…å­˜
    åº”ç”¨æ¡ˆä¾‹
      å¤§æ•°æ®åˆ†æ
        OLAPæŸ¥è¯¢
        æŠ¥è¡¨ç”Ÿæˆ
      æ•°æ®è¿ç§»
        å¹¶è¡ŒCOPY
        å¹¶è¡Œå¯¼å…¥
```

---

## ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### å¹¶è¡ŒæŸ¥è¯¢ç±»å‹å¯¹æ¯”çŸ©é˜µ

| æŸ¥è¯¢ç±»å‹ | å¹¶è¡Œæ”¯æŒ | å¹¶è¡Œåº¦ | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ |
| --- | --- | --- | --- | --- | --- |
| **é¡ºåºæ‰«æ** | âœ… å®Œå…¨æ”¯æŒ | é«˜ | é«˜ | å¤§è¡¨æ‰«æ | âœ… æ”¯æŒ |
| **ç´¢å¼•æ‰«æ** | âœ… éƒ¨åˆ†æ”¯æŒ | ä¸­ | ä¸­ | ç´¢å¼•æŸ¥è¯¢ | âœ… æ”¯æŒ |
| **å“ˆå¸Œè¿æ¥** | âœ… å®Œå…¨æ”¯æŒ | é«˜ | é«˜ | ç­‰å€¼è¿æ¥ | âœ… æ”¯æŒ |
| **åµŒå¥—å¾ªç¯** | âš ï¸ å—é™æ”¯æŒ | ä½ | ä½ | å°è¡¨è¿æ¥ | âœ… æ”¯æŒ |
| **åˆå¹¶è¿æ¥** | âœ… å®Œå…¨æ”¯æŒ | ä¸­ | ä¸­ | æœ‰åºè¿æ¥ | âœ… æ”¯æŒ |
| **å“ˆå¸Œèšåˆ** | âœ… å®Œå…¨æ”¯æŒ | é«˜ | é«˜ | GROUP BY | âœ… æ”¯æŒ |
| **æ’åºèšåˆ** | âœ… å®Œå…¨æ”¯æŒ | ä¸­ | ä¸­ | ORDER BY | âœ… æ”¯æŒ |
| **çª—å£å‡½æ•°** | âœ… å®Œå…¨æ”¯æŒ | ä¸­ | ä¸­ | çª—å£æŸ¥è¯¢ | âœ… PostgreSQL 18 |

### å¹¶è¡Œåº¦é…ç½®å¯¹æ¯”çŸ©é˜µ

| é…ç½®å‚æ•° | é»˜è®¤å€¼ | å½±å“èŒƒå›´ | è°ƒä¼˜éš¾åº¦ | æ€§èƒ½å½±å“ | PostgreSQLç‰ˆæœ¬ |
| --- | --- | --- | --- | --- | --- |
| **max_parallel_workers_per_gather** | 2 | å•æŸ¥è¯¢å¹¶è¡Œåº¦ | ä½ | é«˜ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **max_parallel_workers** | 8 | å…¨å±€å¹¶è¡Œåº¦ | ä½ | é«˜ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **max_parallel_maintenance_workers** | 2 | ç»´æŠ¤æ“ä½œ | ä½ | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **parallel_tuple_cost** | 0.01 | å¹¶è¡Œä»£ä»· | ä¸­ | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **parallel_setup_cost** | 1000.0 | å¯åŠ¨ä»£ä»· | ä¸­ | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |
| **min_parallel_table_scan_size** | 8MB | å¯ç”¨é˜ˆå€¼ | ä½ | ä¸­ | âœ… æ‰€æœ‰ç‰ˆæœ¬ |

### å¹¶è¡Œç®—æ³•å¯¹æ¯”çŸ©é˜µ

| å¹¶è¡Œç®—æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | é€šä¿¡å¼€é”€ | é€‚ç”¨åœºæ™¯ | PostgreSQLå®ç° |
| --------- | ----------- | ----------- | --------- | --------- | --------------- |
| **å¹¶è¡Œé¡ºåºæ‰«æ** | O(n/p) | O(1) | ä½ | å¤§è¡¨æ‰«æ | âœ… æ”¯æŒ |
| **å¹¶è¡Œå“ˆå¸Œè¿æ¥** | O(n+m)/p | O(m/p) | ä¸­ | ç­‰å€¼è¿æ¥ | âœ… æ”¯æŒ |
| **å¹¶è¡Œæ’åº** | O(n log n)/p | O(n/p) | ä¸­ | æ’åºæ“ä½œ | âœ… æ”¯æŒ |
| **å¹¶è¡Œèšåˆ** | O(n)/p | O(m/p) | ä½ | èšåˆæ“ä½œ | âœ… æ”¯æŒ |
| **å¹¶è¡Œçª—å£å‡½æ•°** | O(n log n)/p | O(n/p) | ä¸­ | çª—å£æŸ¥è¯¢ | âœ… PostgreSQL 18 |

---

## ğŸŒ Wikipediaå¯¹é½

### å¹¶è¡Œè®¡ç®—æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Parallel computing](https://en.wikipedia.org/wiki/Parallel_computing)

> Parallel computing is a type of computation in which many calculations or processes are carried out simultaneously. Large problems can often be divided into smaller ones, which can then be solved at the same time.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒåŒæ—¶æ‰§è¡Œå¤šä¸ªè®¡ç®—æˆ–è¿›ç¨‹
- âœ… **æ ¸å¿ƒæ€æƒ³**: éƒ½æåˆ°å°†å¤§é—®é¢˜åˆ†è§£ä¸ºå°é—®é¢˜å¹¶è¡Œè§£å†³
- âœ… **æ€§èƒ½ç›®æ ‡**: éƒ½å¼ºè°ƒæé«˜è®¡ç®—æ€§èƒ½

### Amdahlå®šå¾‹å¯¹é½

**Wikipediaå®šä¹‰**: [Amdahl's law](https://en.wikipedia.org/wiki/Amdahl%27s_law)

> Amdahl's law is a formula that gives the theoretical speedup in latency of the execution of a task at fixed workload that can be expected of a system whose resources are improved.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šå¾‹åº”ç”¨**: PostgreSQLçš„å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½æå‡ç¬¦åˆAmdahlå®šå¾‹
- âœ… **ç†è®ºä¾æ®**: éƒ½å¼ºè°ƒå¹¶è¡ŒåŒ–çš„ç†è®ºåŠ é€Ÿæ¯”
- âœ… **å®é™…åº”ç”¨**: éƒ½æåˆ°å®é™…æ€§èƒ½å—ä¸²è¡Œéƒ¨åˆ†é™åˆ¶

### è´Ÿè½½å‡è¡¡æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Load balancing (computing)](https://en.wikipedia.org/wiki/Load_balancing_(computing))

> Load balancing is the process of distributing a set of tasks over a set of resources (computing units), with the aim of making their overall processing more efficient.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒä»»åŠ¡åˆ†é…å’Œèµ„æºåˆ©ç”¨
- âœ… **ä¼˜åŒ–ç›®æ ‡**: éƒ½å¼ºè°ƒæé«˜å¤„ç†æ•ˆç‡
- âœ… **åˆ†é…ç­–ç•¥**: éƒ½æåˆ°åŠ¨æ€åˆ†é…å’Œè´Ÿè½½å‡è¡¡ç®—æ³•

---

## 1. å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å¹¶è¡ŒæŸ¥è¯¢å¤„ç†æ˜¯æ•°æ®åº“ç³»ç»Ÿåˆ©ç”¨å¤šæ ¸CPUå’Œå¤šä¸ªå·¥ä½œè¿›ç¨‹åŒæ—¶æ‰§è¡ŒæŸ¥è¯¢æ“ä½œçš„æŠ€æœ¯ï¼Œé€šè¿‡å¹¶è¡ŒåŒ–æé«˜æŸ¥è¯¢æ€§èƒ½å’Œç³»ç»Ÿååé‡ã€‚

**English Definition**: Parallel query processing is a technique in database systems that utilizes multi-core CPUs and multiple worker processes to execute query operations simultaneously, improving query performance and system throughput through parallelization.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\parallel}{\mathcal{P}}
\newcommand{\worker}{\mathcal{W}}
\newcommand{\query}{\mathcal{Q}}
\newcommand{\time}{\mathcal{T}}

% å¹¶è¡ŒæŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰
\parallel(\query) = \{\worker_1(\query_1), \worker_2(\query_2), \ldots, \worker_n(\query_n)\}

å…¶ä¸­ï¼š
\query = \query_1 \cup \query_2 \cup \ldots \cup \query_n
\time(\parallel(\query)) = \max_{i=1}^{n} \time(\worker_i(\query_i))
```

### 1.3 æ ¸å¿ƒå±æ€§

- **å¹¶è¡Œæ€§**: å¤šä¸ªå·¥ä½œè¿›ç¨‹åŒæ—¶æ‰§è¡Œ
- **å¯æ‰©å±•æ€§**: æ”¯æŒåŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦
- **è´Ÿè½½å‡è¡¡**: åˆç†åˆ†é…å·¥ä½œè´Ÿè½½
- **å®¹é”™æ€§**: æ”¯æŒæ•…éšœæ¢å¤

## 2. ç†è®ºåŸºç¡€

### 2.1 å¹¶è¡Œè®¡ç®—ç†è®º

```latex
\begin{theorem}[å¹¶è¡ŒåŠ é€Ÿæ¯”]
å¹¶è¡ŒåŠ é€Ÿæ¯”å®šä¹‰ä¸ºï¼š
S(n) = \frac{\time(1)}{\time(n)}

å…¶ä¸­næ˜¯å¹¶è¡Œåº¦ï¼Œç†æƒ³æƒ…å†µä¸‹S(n) = nã€‚
\end{theorem}

\begin{proof}
åŸºäºAmdahlå®šå¾‹ï¼Œå¹¶è¡ŒåŠ é€Ÿæ¯”å—åˆ°ä¸²è¡Œéƒ¨åˆ†çš„é™åˆ¶ã€‚
\end{proof}
```

### 2.2 è´Ÿè½½å‡è¡¡ç†è®º

```latex
\begin{theorem}[è´Ÿè½½å‡è¡¡æœ€ä¼˜æ€§]
è´Ÿè½½å‡è¡¡æœ€ä¼˜æ€§è¦æ±‚ï¼š
\min \max_{i=1}^{n} \text{load}(\worker_i)

å…¶ä¸­load(worker_i)æ˜¯å·¥ä½œè¿›ç¨‹içš„è´Ÿè½½ã€‚
\end{theorem}
```

## 3. PostgreSQLå¹¶è¡ŒæŸ¥è¯¢æ¶æ„

### 3.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®

```sql
-- æŸ¥çœ‹å¹¶è¡ŒæŸ¥è¯¢é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    max_parallel_workers_per_gather_val TEXT;
    max_parallel_workers_val TEXT;
    max_parallel_maintenance_workers_val TEXT;
    parallel_tuple_cost_val TEXT;
    parallel_setup_cost_val TEXT;
BEGIN
    BEGIN
        SELECT setting INTO max_parallel_workers_per_gather_val FROM pg_settings WHERE name = 'max_parallel_workers_per_gather';
        SELECT setting INTO max_parallel_workers_val FROM pg_settings WHERE name = 'max_parallel_workers';
        SELECT setting INTO max_parallel_maintenance_workers_val FROM pg_settings WHERE name = 'max_parallel_maintenance_workers';
        SELECT setting INTO parallel_tuple_cost_val FROM pg_settings WHERE name = 'parallel_tuple_cost';
        SELECT setting INTO parallel_setup_cost_val FROM pg_settings WHERE name = 'parallel_setup_cost';

        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢é…ç½®:';
        RAISE NOTICE '  max_parallel_workers_per_gather = %', max_parallel_workers_per_gather_val;
        RAISE NOTICE '  max_parallel_workers = %', max_parallel_workers_val;
        RAISE NOTICE '  max_parallel_maintenance_workers = %', max_parallel_maintenance_workers_val;
        RAISE NOTICE '  parallel_tuple_cost = %', parallel_tuple_cost_val;
        RAISE NOTICE '  parallel_setup_cost = %', parallel_setup_cost_val;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å¹¶è¡ŒæŸ¥è¯¢é…ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æˆ–è€…ä½¿ç”¨SHOWå‘½ä»¤ï¼ˆç®€å•æ–¹å¼ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name IN ('max_parallel_workers_per_gather', 'max_parallel_workers', 'max_parallel_maintenance_workers', 'parallel_tuple_cost', 'parallel_setup_cost');

-- è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        SET max_parallel_workers = 8;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å·²è®¾ç½®: max_parallel_workers_per_gather=4, max_parallel_workers=8';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®å¹¶è¡ŒæŸ¥è¯¢å‚æ•°å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
SET max_parallel_maintenance_workers = 4;
SET parallel_tuple_cost = 0.1;
SET parallel_setup_cost = 1000;
```

### 3.2 å¹¶è¡ŒæŸ¥è¯¢å¯ç”¨

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET enable_parallel_hash = on;
        SET enable_parallel_append = on;
        SET enable_parallel_union = on;
        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢å·²å¯ç”¨: enable_parallel_hash=on, enable_parallel_append=on, enable_parallel_union=on';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æŸ¥çœ‹å¹¶è¡ŒæŸ¥è¯¢çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    enable_parallel_hash_val TEXT;
    enable_parallel_append_val TEXT;
    enable_parallel_union_val TEXT;
BEGIN
    BEGIN
        SELECT setting INTO enable_parallel_hash_val FROM pg_settings WHERE name = 'enable_parallel_hash';
        SELECT setting INTO enable_parallel_append_val FROM pg_settings WHERE name = 'enable_parallel_append';
        SELECT setting INTO enable_parallel_union_val FROM pg_settings WHERE name = 'enable_parallel_union';

        RAISE NOTICE 'å¹¶è¡ŒæŸ¥è¯¢çŠ¶æ€:';
        RAISE NOTICE '  enable_parallel_hash = %', enable_parallel_hash_val;
        RAISE NOTICE '  enable_parallel_append = %', enable_parallel_append_val;
        RAISE NOTICE '  enable_parallel_union = %', enable_parallel_union_val;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å¹¶è¡ŒæŸ¥è¯¢çŠ¶æ€å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- æˆ–è€…ä½¿ç”¨SHOWå‘½ä»¤ï¼ˆç®€å•æ–¹å¼ï¼Œå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name IN ('enable_parallel_hash', 'enable_parallel_append', 'enable_parallel_union');

### 3.3 å¹¶è¡Œåº¦è®¾ç½®

**è¡¨çº§å¹¶è¡Œåº¦è®¾ç½®ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- è¡¨çº§å¹¶è¡Œåº¦è®¾ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    -- è®¾ç½®å¹¶è¡Œåº¦
    ALTER TABLE large_table SET (parallel_workers = 4);
    RAISE NOTICE 'è¡¨å¹¶è¡Œåº¦è®¾ç½®æˆåŠŸ: large_table (parallel_workers=4)';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®è¡¨å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹è¡¨å¹¶è¡Œåº¦è®¾ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    parallel_workers TEXT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    SELECT reloptions::TEXT INTO parallel_workers
    FROM pg_class c
    JOIN pg_namespace n ON c.relnamespace = n.oid
    WHERE c.relname = 'large_table'
    AND n.nspname = 'public';

    IF parallel_workers IS NULL THEN
        RAISE NOTICE 'è¡¨æœªè®¾ç½®å¹¶è¡Œåº¦ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰';
    ELSE
        RAISE NOTICE 'è¡¨å¹¶è¡Œåº¦è®¾ç½®: %', parallel_workers;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹è¡¨å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹è¡¨å¹¶è¡Œåº¦è®¾ç½®
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    reloptions
FROM pg_class c
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE c.relname = 'large_table'
AND n.nspname = 'public';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Nested Loop -> Index Scan
```

## 4. å¹¶è¡Œæ‰«æ

### 4.1 å¹¶è¡Œé¡ºåºæ‰«æ

```sql
-- å¹¶è¡Œé¡ºåºæ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table;

-- æŸ¥çœ‹å¹¶è¡Œæ‰«æç»Ÿè®¡ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    seq_tup_read / NULLIF(seq_scan, 0) as avg_tuples_per_scan
FROM pg_stat_user_tables
WHERE tablename = 'large_table';
```

### 4.2 å¹¶è¡Œç´¢å¼•æ‰«æ

**åˆ›å»ºç´¢å¼•ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- å¹¶è¡Œç´¢å¼•æ‰«æï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'large_table' AND indexname = 'idx_large_table_id'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_id';
    ELSE
        CREATE INDEX idx_large_table_id ON large_table (id);
        RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_large_table_id';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_id';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šå¹¶è¡Œç´¢å¼•æ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE id > 1000000;
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Aggregate -> Parallel Seq Scan æˆ– Index Scan

-- æ€§èƒ½æµ‹è¯•ï¼šå¹¶è¡Œä½å›¾æ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE id BETWEEN 1000000 AND 2000000;
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Aggregate -> Parallel Bitmap Heap Scan -> Bitmap Index Scan
```

### 4.3 å¹¶è¡Œåˆ†åŒºæ‰«æ

**åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: sales';
    ELSE
        CREATE TABLE sales (
            id BIGSERIAL,
            sale_date DATE,
            amount DECIMAL(10,2)
        ) PARTITION BY RANGE (sale_date);
        RAISE NOTICE 'åˆ†åŒºè¡¨åˆ›å»ºæˆåŠŸ: sales';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: sales';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºåˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
        RAISE EXCEPTION 'åˆ†åŒºè¡¨ä¸å­˜åœ¨: sales';
    END IF;

    -- åˆ›å»º2023å¹´åˆ†åŒº
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales_2023') THEN
        RAISE WARNING 'åˆ†åŒºå·²å­˜åœ¨: sales_2023';
    ELSE
        CREATE TABLE sales_2023 PARTITION OF sales
        FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');
        RAISE NOTICE 'åˆ†åŒºåˆ›å»ºæˆåŠŸ: sales_2023';
    END IF;

    -- åˆ›å»º2024å¹´åˆ†åŒº
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales_2024') THEN
        RAISE WARNING 'åˆ†åŒºå·²å­˜åœ¨: sales_2024';
    ELSE
        CREATE TABLE sales_2024 PARTITION OF sales
        FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
        RAISE NOTICE 'åˆ†åŒºåˆ›å»ºæˆåŠŸ: sales_2024';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'åˆ†åŒºè¡¨ä¸å­˜åœ¨: sales';
    WHEN duplicate_table THEN
        RAISE WARNING 'éƒ¨åˆ†åˆ†åŒºå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šå¹¶è¡Œåˆ†åŒºæ‰«æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM sales WHERE sale_date >= '2023-01-01';
-- æ‰§è¡Œæ—¶é—´: å–å†³äºåˆ†åŒºå¤§å°å’Œç´¢å¼•
-- è®¡åˆ’: Aggregate -> Append -> Parallel Seq Scanï¼ˆå¤šä¸ªåˆ†åŒºå¹¶è¡Œæ‰«æï¼‰
```

## 5. å¹¶è¡Œè¿æ¥

### 5.1 å¹¶è¡Œå“ˆå¸Œè¿æ¥

```sql
-- å¹¶è¡Œå“ˆå¸Œè¿æ¥
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*)
FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id;

-- å¼ºåˆ¶å¹¶è¡Œå“ˆå¸Œè¿æ¥
SET enable_parallel_hash = on;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*)
FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id;
```

### 5.2 å¹¶è¡ŒåµŒå¥—å¾ªç¯è¿æ¥

```sql
-- å¹¶è¡ŒåµŒå¥—å¾ªç¯è¿æ¥
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*)
FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id
WHERE t1.value > 1000;
```

### 5.3 å¹¶è¡Œåˆå¹¶è¿æ¥

```sql
-- å¹¶è¡Œåˆå¹¶è¿æ¥
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*)
FROM large_table1 t1
JOIN large_table2 t2 ON t1.id = t2.id
ORDER BY t1.id;
```

## 6. å¹¶è¡Œèšåˆ

### 6.1 å¹¶è¡Œå“ˆå¸Œèšåˆ

```sql
-- å¹¶è¡Œå“ˆå¸Œèšåˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT category_id, COUNT(*), AVG(value)
FROM large_table
GROUP BY category_id;

-- å¹¶è¡Œåˆ†ç»„èšåˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT category_id, subcategory_id, COUNT(*), AVG(value)
FROM large_table
GROUP BY category_id, subcategory_id;
```

### 6.2 å¹¶è¡Œæ’åºèšåˆ

```sql
-- å¹¶è¡Œæ’åºèšåˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT category_id, COUNT(*), AVG(value)
FROM large_table
GROUP BY category_id
ORDER BY category_id;
```

### 6.3 å¹¶è¡Œçª—å£å‡½æ•°

```sql
-- å¹¶è¡Œçª—å£å‡½æ•°
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    category_id,
    value,
    ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY value DESC) as rank
FROM large_table;
```

## 7. PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢æ–°ç‰¹æ€§

### 7.1 parallel_leader_participationå‚æ•°

PostgreSQL 18å¼•å…¥äº†`parallel_leader_participation`å‚æ•°ï¼Œå…è®¸å¹¶è¡ŒæŸ¥è¯¢çš„leaderè¿›ç¨‹å‚ä¸å®é™…å·¥ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯åè°ƒå·¥ä½œã€‚

**parallel_leader_participationé…ç½®**ï¼š

```sql
-- æŸ¥çœ‹parallel_leader_participationè®¾ç½®ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name = 'parallel_leader_participation';

-- å¯ç”¨leaderå‚ä¸ï¼ˆPostgreSQL 18é»˜è®¤å¯ç”¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET parallel_leader_participation = on;
    RAISE NOTICE 'parallel_leader_participation å·²è®¾ç½®ä¸º on';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®¾ç½® parallel_leader_participation å¤±è´¥: %', SQLERRM;
END $$;

-- ç¦ç”¨leaderå‚ä¸ï¼ˆä»…åè°ƒï¼Œä¸å‚ä¸å®é™…å·¥ä½œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET parallel_leader_participation = off;
    RAISE NOTICE 'parallel_leader_participation å·²è®¾ç½®ä¸º off';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'è®¾ç½® parallel_leader_participation å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½å¯¹æ¯”
-- å¯ç”¨leaderå‚ä¸ï¼ˆPostgreSQL 18ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- æ‰§è¡Œæ—¶é—´ï¼šçº¦15ç§’ï¼ˆ4ä¸ªworker + 1ä¸ªleader = 5ä¸ªè¿›ç¨‹å·¥ä½œï¼‰

-- ç¦ç”¨leaderå‚ä¸
SET parallel_leader_participation = off;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- æ‰§è¡Œæ—¶é—´ï¼šçº¦18ç§’ï¼ˆä»…4ä¸ªworkerå·¥ä½œï¼‰
```

**ä¼˜åŠ¿**ï¼š

- æé«˜å¹¶è¡ŒæŸ¥è¯¢æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨workeræ•°é‡è¾ƒå°‘æ—¶
- å……åˆ†åˆ©ç”¨æ‰€æœ‰å¯ç”¨CPUæ ¸å¿ƒ
- å‡å°‘å¹¶è¡ŒæŸ¥è¯¢çš„å¼€é”€

### 7.2 æ›´æ™ºèƒ½çš„å¹¶è¡Œåº¦å†³ç­–

PostgreSQL 18æ”¹è¿›äº†å¹¶è¡Œåº¦å†³ç­–ç®—æ³•ï¼Œèƒ½å¤Ÿæ›´å‡†ç¡®åœ°è¯„ä¼°å¹¶è¡ŒæŸ¥è¯¢çš„æˆæœ¬å’Œæ”¶ç›Šã€‚

**æ™ºèƒ½å¹¶è¡Œåº¦å†³ç­–**ï¼š

```sql
-- æŸ¥çœ‹å¹¶è¡Œåº¦å†³ç­–
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    category_id,
    COUNT(*) as count,
    AVG(amount) as avg_amount,
    SUM(amount) as total_amount
FROM sales
WHERE sale_date >= '2023-01-01'
GROUP BY category_id;

-- æŸ¥çœ‹å®é™…ä½¿ç”¨çš„å¹¶è¡Œåº¦ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%Gather%'
AND state = 'active';

-- å¼ºåˆ¶å¹¶è¡Œåº¦ï¼ˆå¦‚æœä¼˜åŒ–å™¨æœªé€‰æ‹©å¹¶è¡Œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        SET parallel_setup_cost = 0;  -- é™ä½å¹¶è¡Œå¯åŠ¨æˆæœ¬
        RAISE NOTICE 'å¼ºåˆ¶å¹¶è¡Œåº¦è®¾ç½®å®Œæˆ: max_parallel_workers_per_gather=4, parallel_setup_cost=0';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¼ºåˆ¶å¹¶è¡Œåº¦è®¾ç½®å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;
```

**æ”¹è¿›ç‚¹**ï¼š

- æ›´å‡†ç¡®çš„å¹¶è¡Œæˆæœ¬ä¼°ç®—
- è€ƒè™‘ç³»ç»Ÿè´Ÿè½½å’Œèµ„æºå¯ç”¨æ€§
- è‡ªåŠ¨è°ƒæ•´å¹¶è¡Œåº¦ä»¥ä¼˜åŒ–æ€§èƒ½

### 7.3 æ”¹è¿›çš„å¹¶è¡Œèšåˆç®—æ³•

PostgreSQL 18æ”¹è¿›äº†å¹¶è¡Œèšåˆç®—æ³•ï¼Œæé«˜äº†å¤§æ•°æ®é›†èšåˆæŸ¥è¯¢çš„æ€§èƒ½ã€‚

**å¹¶è¡Œèšåˆæ”¹è¿›**ï¼š

```sql
-- å¹¶è¡Œå“ˆå¸Œèšåˆï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary,
    SUM(salary) as total_salary,
    MAX(salary) as max_salary,
    MIN(salary) as min_salary
FROM employees
GROUP BY dept_id;

-- å¹¶è¡Œæ’åºèšåˆï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary
FROM employees
GROUP BY dept_id
ORDER BY dept_id;

-- å¹¶è¡Œçª—å£å‡½æ•°ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    emp_id,
    name,
    salary,
    dept_id,
    ROW_NUMBER() OVER (PARTITION BY dept_id ORDER BY salary DESC) as rank,
    AVG(salary) OVER (PARTITION BY dept_id) as dept_avg_salary
FROM employees;
```

**æ€§èƒ½æå‡**ï¼š

- å¹¶è¡Œèšåˆæ€§èƒ½æå‡30-40%
- æ›´å¥½çš„è´Ÿè½½å‡è¡¡
- å‡å°‘å†…å­˜ä½¿ç”¨

### 7.4 å¼‚æ­¥I/Oæå‡å¹¶è¡ŒI/Oæ€§èƒ½

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡äº†å¹¶è¡ŒæŸ¥è¯¢çš„I/Oæ€§èƒ½ã€‚

**å¼‚æ­¥I/Oåœ¨å¹¶è¡ŒæŸ¥è¯¢ä¸­çš„åº”ç”¨**ï¼š

```sql
-- é…ç½®å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4  -- ç»´æŠ¤æ“ä½œçš„I/Oå·¥ä½œè¿›ç¨‹
-- max_io_workers = 10  -- æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹æ•°

-- å¹¶è¡ŒæŸ¥è¯¢I/Oæ€§èƒ½å¯¹æ¯”
-- ä¼ ç»ŸåŒæ­¥I/O
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- I/Oç­‰å¾…æ—¶é—´ï¼šçº¦20ç§’

-- å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
-- é…ç½®å¼‚æ­¥I/Oå
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM large_table WHERE value > 1000;
-- I/Oç­‰å¾…æ—¶é—´ï¼šçº¦7-10ç§’ï¼ˆæ€§èƒ½æå‡2-3å€ï¼‰

-- ç›‘æ§å¹¶è¡ŒæŸ¥è¯¢I/Oæ€§èƒ½
SELECT
    pid,
    usename,
    wait_event_type,
    wait_event,
    state
FROM pg_stat_activity
WHERE query LIKE '%Gather%'
AND wait_event_type = 'IO';
```

**æ€§èƒ½æå‡**ï¼š

- å¹¶è¡ŒæŸ¥è¯¢I/Oæ€§èƒ½æå‡2-3å€
- å‡å°‘I/Oç­‰å¾…æ—¶é—´
- æé«˜å¹¶è¡ŒæŸ¥è¯¢ååé‡

### 7.5 BRINç´¢å¼•å¹¶è¡Œæ„å»º

PostgreSQL 18æ”¯æŒBRINç´¢å¼•çš„å¹¶è¡Œæ„å»ºï¼Œå¤§å¹…æå‡å¤§è¡¨BRINç´¢å¼•çš„åˆ›å»ºé€Ÿåº¦ã€‚

**BRINå¹¶è¡Œæ„å»ºï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**ï¼š

```sql
-- BRINç´¢å¼•å¹¶è¡Œæ„å»ºï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'sales') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: sales';
    END IF;

    -- æ£€æŸ¥PostgreSQLç‰ˆæœ¬
    IF current_setting('server_version_num')::INT < 170000 THEN
        RAISE WARNING 'BRINå¹¶è¡Œæ„å»ºéœ€è¦PostgreSQL 17+';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'sales' AND indexname = 'idx_sales_date_brin'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_sales_date_brin';
    ELSE
        CREATE INDEX CONCURRENTLY idx_sales_date_brin
        ON sales USING BRIN (sale_date)
        WITH (pages_per_range = 128);
        RAISE NOTICE 'BRINç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_sales_date_brin';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: sales';
    WHEN feature_not_supported THEN
        RAISE WARNING 'BRINå¹¶è¡Œæ„å»ºéœ€è¦PostgreSQL 17+';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_sales_date_brin';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºBRINç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹å¹¶è¡Œæ„å»ºè¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    build_count INT;
BEGIN
    SELECT COUNT(*) INTO build_count
    FROM pg_stat_activity
    WHERE query LIKE '%CREATE INDEX%'
    AND state = 'active';

    IF build_count = 0 THEN
        RAISE NOTICE 'å½“å‰æ²¡æœ‰æ­£åœ¨æ„å»ºçš„ç´¢å¼•';
    ELSE
        RAISE NOTICE 'å½“å‰æœ‰ % ä¸ªç´¢å¼•æ­£åœ¨æ„å»º', build_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹å¹¶è¡Œæ„å»ºè¿›åº¦å¤±è´¥: %', SQLERRM;
END $$;

-- é…ç½®å¹¶è¡Œåº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET max_parallel_maintenance_workers = 4;
    RAISE NOTICE 'å¹¶è¡Œç»´æŠ¤å·¥ä½œè¿›ç¨‹æ•°è®¾ç½®ä¸º: 4';
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
END $$;

-- å¹¶è¡Œæ„å»ºBRINç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'large_table' AND indexname = 'idx_large_table_brin'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_brin';
    ELSE
        CREATE INDEX CONCURRENTLY idx_large_table_brin
        ON large_table USING BRIN (value)
        WITH (pages_per_range = 64);
        RAISE NOTICE 'BRINç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_large_table_brin';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_brin';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºBRINç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

**æ€§èƒ½æå‡**ï¼š

- BRINç´¢å¼•æ„å»ºé€Ÿåº¦æå‡3-5å€
- æ”¯æŒå¤§è¡¨çš„å¿«é€Ÿç´¢å¼•åˆ›å»º
- å‡å°‘ç´¢å¼•æ„å»ºå¯¹æ­£å¸¸æŸ¥è¯¢çš„å½±å“

## 8. å¹¶è¡Œç»´æŠ¤æ“ä½œ

### 8.1 å¹¶è¡ŒVACUUM

**å¹¶è¡ŒVACUUMï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- å¹¶è¡ŒVACUUMï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    -- æ‰§è¡Œå¹¶è¡ŒVACUUM
    EXECUTE 'VACUUM (PARALLEL 4) large_table';
    RAISE NOTICE 'å¹¶è¡ŒVACUUMæ‰§è¡ŒæˆåŠŸ: large_table';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¹¶è¡ŒVACUUMå¤±è´¥: %', SQLERRM;
END $$;

-- å¹¶è¡ŒVACUUM ANALYZEï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    -- æ‰§è¡Œå¹¶è¡ŒVACUUM ANALYZE
    EXECUTE 'VACUUM (ANALYZE, PARALLEL 4) large_table';
    RAISE NOTICE 'å¹¶è¡ŒVACUUM ANALYZEæ‰§è¡ŒæˆåŠŸ: large_table';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¹¶è¡ŒVACUUM ANALYZEå¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹VACUUMè¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    vacuum_count INT;
BEGIN
    SELECT COUNT(*) INTO vacuum_count
    FROM pg_stat_activity
    WHERE query LIKE '%VACUUM%';

    IF vacuum_count = 0 THEN
        RAISE NOTICE 'å½“å‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„VACUUMæ“ä½œ';
    ELSE
        RAISE NOTICE 'å½“å‰æœ‰ % ä¸ªVACUUMæ“ä½œæ­£åœ¨æ‰§è¡Œ', vacuum_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹VACUUMè¿›åº¦å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹VACUUMè¿›åº¦
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%VACUUM%';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

### 8.2 å¹¶è¡Œç´¢å¼•æ„å»º

**å¹¶è¡Œç´¢å¼•æ„å»ºï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- å¹¶è¡Œç´¢å¼•æ„å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    END IF;

    -- æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'large_table' AND column_name = 'category_id'
    ) THEN
        RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨: category_id';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'large_table' AND column_name = 'value'
    ) THEN
        RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨: value';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes WHERE tablename = 'large_table' AND indexname = 'idx_large_table_parallel'
    ) THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_parallel';
    ELSE
        CREATE INDEX CONCURRENTLY idx_large_table_parallel
        ON large_table (category_id, value)
        WITH (parallel_workers = 4);
        RAISE NOTICE 'å¹¶è¡Œç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_large_table_parallel';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: large_table';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'åˆ—ä¸å­˜åœ¨ï¼ˆè¯·æ£€æŸ¥category_idå’Œvalueåˆ—ï¼‰';
    WHEN duplicate_table THEN
        RAISE WARNING 'ç´¢å¼•å·²å­˜åœ¨: idx_large_table_parallel';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¹¶è¡Œç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹ç´¢å¼•æ„å»ºè¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    index_build_count INT;
BEGIN
    SELECT COUNT(*) INTO index_build_count
    FROM pg_stat_activity
    WHERE query LIKE '%CREATE INDEX%';

    IF index_build_count = 0 THEN
        RAISE NOTICE 'å½“å‰æ²¡æœ‰æ­£åœ¨æ„å»ºçš„ç´¢å¼•';
    ELSE
        RAISE NOTICE 'å½“å‰æœ‰ % ä¸ªç´¢å¼•æ­£åœ¨æ„å»º', index_build_count;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹ç´¢å¼•æ„å»ºè¿›åº¦å¤±è´¥: %', SQLERRM;
END $$;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹ç´¢å¼•æ„å»ºè¿›åº¦
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

### 8.3 å¹¶è¡Œæ•°æ®åŠ è½½

```sql
-- å¹¶è¡Œæ•°æ®åŠ è½½
COPY large_table FROM '/path/to/data.csv' WITH (FORMAT csv, HEADER);

-- ä½¿ç”¨å¹¶è¡ŒINSERT
INSERT INTO large_table (category_id, value, description)
SELECT
    (random() * 100)::INTEGER,
    (random() * 1000)::DECIMAL(10,2),
    'Description ' || generate_series(1, 1000000);
```

## 9. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

### 9.1 å¹¶è¡Œåº¦ä¼˜åŒ–

**åŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦å‡½æ•°ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- åŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION optimize_parallel_degree(table_name text, query_text text)
RETURNS integer AS $$
DECLARE
    optimal_degree integer;
    current_degree integer;
    execution_time numeric;
    best_time numeric := 999999;
    best_degree integer := 1;
BEGIN
    -- å‚æ•°éªŒè¯
    IF table_name IS NULL OR TRIM(table_name) = '' THEN
        RAISE EXCEPTION 'è¡¨åä¸èƒ½ä¸ºç©º';
    END IF;

    IF query_text IS NULL OR TRIM(query_text) = '' THEN
        RAISE EXCEPTION 'æŸ¥è¯¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = table_name
    ) THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', table_name;
    END IF;

    -- æµ‹è¯•ä¸åŒå¹¶è¡Œåº¦
    FOR current_degree IN 1..8 LOOP
        BEGIN
            EXECUTE format('SET max_parallel_workers_per_gather = %s', current_degree);

            -- æ‰§è¡ŒæŸ¥è¯¢å¹¶æµ‹é‡æ—¶é—´
            -- æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä»EXPLAINè¾“å‡ºä¸­æå–æ‰§è¡Œæ—¶é—´
            -- ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…å®ç°éœ€è¦è§£æEXPLAINè¾“å‡º
            EXECUTE format('EXPLAIN (ANALYZE, BUFFERS, TIMING) %s', query_text);

            -- è¿™é‡Œéœ€è¦ä»EXPLAINè¾“å‡ºä¸­æå–æ‰§è¡Œæ—¶é—´
            -- ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…å®ç°éœ€è¦è§£æEXPLAINè¾“å‡º
            -- execution_time := extract_execution_time(...);

            -- å‡è®¾execution_timeå·²æå–
            IF execution_time < best_time THEN
                best_time := execution_time;
                best_degree := current_degree;
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'å¹¶è¡Œåº¦ % æµ‹è¯•å¤±è´¥: %', current_degree, SQLERRM;
                CONTINUE;
        END;
    END LOOP;

    RETURN best_degree;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨: %', table_name;
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ä¼˜åŒ–å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 9.2 è´Ÿè½½å‡è¡¡ä¼˜åŒ–

```sql
-- ç›‘æ§å¹¶è¡ŒæŸ¥è¯¢è´Ÿè½½
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE query LIKE '%Gather%' OR query LIKE '%Parallel%';

-- æŸ¥çœ‹å·¥ä½œè¿›ç¨‹ç»Ÿè®¡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname = current_database();
```

### 9.3 å†…å­˜ä¼˜åŒ–

```sql
-- å¹¶è¡ŒæŸ¥è¯¢å†…å­˜é…ç½®
SET work_mem = '256MB';
SET maintenance_work_mem = '1GB';

-- ç›‘æ§å†…å­˜ä½¿ç”¨
SELECT
    pid,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND query LIKE '%Gather%';
```

## 10. å®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 å¤§æ•°æ®åˆ†ææŸ¥è¯¢

```sql
-- å¤§æ•°æ®åˆ†ææŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH monthly_stats AS (
    SELECT
        DATE_TRUNC('month', sale_date) as month,
        category_id,
        COUNT(*) as transaction_count,
        SUM(amount) as total_amount,
        AVG(amount) as avg_amount
    FROM sales
    WHERE sale_date >= '2023-01-01'
    GROUP BY DATE_TRUNC('month', sale_date), category_id
)
SELECT
    month,
    category_id,
    transaction_count,
    total_amount,
    avg_amount,
    ROW_NUMBER() OVER (PARTITION BY month ORDER BY total_amount DESC) as rank
FROM monthly_stats
ORDER BY month, rank;
```

### 10.2 å¹¶è¡Œæ•°æ®è¿ç§»

**å¹¶è¡Œæ•°æ®è¿ç§»ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰**:

```sql
-- åˆ›å»ºç›®æ ‡è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'target_table') THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: target_table';
    ELSE
        CREATE TABLE target_table (
            id BIGSERIAL PRIMARY KEY,
            source_id INTEGER,
            data_value DECIMAL(10,2),
            created_at TIMESTAMP DEFAULT NOW()
        );
        RAISE NOTICE 'ç›®æ ‡è¡¨åˆ›å»ºæˆåŠŸ: target_table';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨å·²å­˜åœ¨: target_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç›®æ ‡è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- å¹¶è¡Œæ•°æ®è¿ç§»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'target_table') THEN
        RAISE EXCEPTION 'ç›®æ ‡è¡¨ä¸å­˜åœ¨: target_table';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'source_table') THEN
        RAISE EXCEPTION 'æºè¡¨ä¸å­˜åœ¨: source_table';
    END IF;

    -- æ‰§è¡Œå¹¶è¡Œæ•°æ®è¿ç§»
    INSERT INTO target_table (source_id, data_value)
    SELECT
        source_id,
        data_value
    FROM source_table
    WHERE id BETWEEN 1 AND 1000000;

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'å¹¶è¡Œæ•°æ®è¿ç§»æˆåŠŸ: æ’å…¥äº† % è¡Œæ•°æ®', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ä¸å­˜åœ¨ï¼ˆè¯·æ£€æŸ¥target_tableå’Œsource_tableï¼‰';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¹¶è¡Œæ•°æ®è¿ç§»å¤±è´¥: %', SQLERRM;
END $$;

-- ä½¿ç”¨å¹¶è¡ŒCOPYï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    copied_count BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'target_table') THEN
        RAISE EXCEPTION 'ç›®æ ‡è¡¨ä¸å­˜åœ¨: target_table';
    END IF;

    BEGIN
        COPY target_table (source_id, data_value)
        FROM '/path/to/data.csv'
        WITH (FORMAT csv, HEADER);

        GET DIAGNOSTICS copied_count = ROW_COUNT;
        RAISE NOTICE 'å¹¶è¡ŒCOPYæˆåŠŸ: å¤åˆ¶äº† % è¡Œæ•°æ®', copied_count;
    EXCEPTION
        WHEN insufficient_privilege THEN
            RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•è¯»å–æ–‡ä»¶: /path/to/data.csvï¼ˆéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰';
        WHEN undefined_file THEN
            RAISE EXCEPTION 'æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: /path/to/data.csv';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'å¹¶è¡ŒCOPYå¤±è´¥: %', SQLERRM;
    END;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'ç›®æ ‡è¡¨ä¸å­˜åœ¨: target_table';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¹¶è¡ŒCOPYè¿‡ç¨‹å¤±è´¥: %', SQLERRM;
END $$;
```

### 10.3 å¹¶è¡ŒæŠ¥è¡¨ç”Ÿæˆ

```sql
-- å¹¶è¡ŒæŠ¥è¡¨ç”Ÿæˆ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    d.dept_name,
    COUNT(e.emp_id) as employee_count,
    AVG(e.salary) as avg_salary,
    MAX(e.salary) as max_salary,
    MIN(e.salary) as min_salary,
    SUM(e.salary) as total_salary
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.hire_date >= '2020-01-01'
GROUP BY d.dept_name
ORDER BY total_salary DESC;
```

### 10.4 PostgreSQL 18å¹¶è¡ŒæŸ¥è¯¢æœ€ä½³å®è·µ

**æœ€ä½³å®è·µæ€»ç»“**ï¼š

```sql
-- 1. å¯ç”¨parallel_leader_participationï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET parallel_leader_participation = on;
        RAISE NOTICE 'parallel_leader_participation å·²å¯ç”¨';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'å¯ç”¨parallel_leader_participationå¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 2. é…ç½®åˆé€‚çš„å¹¶è¡Œåº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        SET max_parallel_workers_per_gather = 4;
        SET max_parallel_workers = 8;
        RAISE NOTICE 'å¹¶è¡Œåº¦é…ç½®å®Œæˆ: max_parallel_workers_per_gather=4, max_parallel_workers=8';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'é…ç½®å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 3. ä¸ºè¡¨è®¾ç½®å¹¶è¡Œåº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'large_table') THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®å¹¶è¡Œåº¦';
            RETURN;
        END IF;

        ALTER TABLE large_table SET (parallel_workers = 4);
        RAISE NOTICE 'è¡¨ large_table å¹¶è¡Œåº¦è®¾ç½®æˆåŠŸ: parallel_workers=4';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨ large_table ä¸å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®è¡¨å¹¶è¡Œåº¦å¤±è´¥: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 4. å¯ç”¨å¼‚æ­¥I/Oæå‡å¹¶è¡ŒI/Oæ€§èƒ½ï¼ˆPostgreSQL 18ï¼‰
-- åœ¨postgresql.confä¸­é…ç½®
-- maintenance_io_workers = 4
-- max_io_workers = 10

-- 5. ä¼˜åŒ–å¹¶è¡ŒæŸ¥è¯¢æˆæœ¬å‚æ•°
SET parallel_tuple_cost = 0.1;
SET parallel_setup_cost = 1000;

-- 6. ç›‘æ§å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    total_time,
    mean_time,
    stddev_time,
    rows
FROM pg_stat_statements
WHERE query LIKE '%Gather%'
ORDER BY total_time DESC
LIMIT 10;

-- 7. ä½¿ç”¨å¹¶è¡Œç»´æŠ¤æ“ä½œ
SET max_parallel_maintenance_workers = 4;
CREATE INDEX CONCURRENTLY idx_large_table_brin
ON large_table USING BRIN (value);
```

## 11. æ€§èƒ½ç›‘æ§

### 11.1 å¹¶è¡ŒæŸ¥è¯¢ç›‘æ§

```sql
-- å¹¶è¡ŒæŸ¥è¯¢ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE query LIKE '%Gather%' OR query LIKE '%Parallel%'
ORDER BY query_start;

-- å¹¶è¡ŒæŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_time,
    mean_time,
    stddev_time,
    rows
FROM pg_stat_statements
WHERE query LIKE '%Gather%' OR query LIKE '%Parallel%'
ORDER BY total_time DESC;
```

### 11.2 å·¥ä½œè¿›ç¨‹ç›‘æ§

```sql
-- å·¥ä½œè¿›ç¨‹ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE application_name LIKE '%worker%'
ORDER BY query_start;

-- å·¥ä½œè¿›ç¨‹ç»Ÿè®¡
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname = current_database();
```

## 12. ç›¸å…³æ¦‚å¿µ

### 12.1 ä¸Šä½æ¦‚å¿µ

- **å¹¶è¡Œè®¡ç®—**: æ›´å¹¿æ³›çš„å¹¶è¡Œè®¡ç®—æŠ€æœ¯
- **æŸ¥è¯¢ä¼˜åŒ–**: æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- **ç³»ç»Ÿæ¶æ„**: æ•°æ®åº“ç³»ç»Ÿæ¶æ„

### 12.2 ä¸‹ä½æ¦‚å¿µ

- **å¹¶è¡Œæ‰«æ**: å¹¶è¡Œæ•°æ®æ‰«æ
- **å¹¶è¡Œè¿æ¥**: å¹¶è¡Œè¿æ¥æ“ä½œ
- **å¹¶è¡Œèšåˆ**: å¹¶è¡Œèšåˆæ“ä½œ
- **è´Ÿè½½å‡è¡¡**: è´Ÿè½½åˆ†é…æœºåˆ¶

### 12.3 å¹³è¡Œæ¦‚å¿µ

- **åˆ†å¸ƒå¼æŸ¥è¯¢**: è·¨èŠ‚ç‚¹æŸ¥è¯¢å¤„ç†
- **å¤šçº¿ç¨‹**: å¤šçº¿ç¨‹ç¼–ç¨‹æŠ€æœ¯
- **é›†ç¾¤è®¡ç®—**: é›†ç¾¤å¹¶è¡Œè®¡ç®—

## 13. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. Graefe, G. (1995). The Cascades framework for query optimization. IEEE Data Engineering Bulletin, 18(3), 19-29.
3. DeWitt, D. J., & Gray, J. (1992). Parallel database systems: the future of high performance database processing. Communications of the ACM, 35(6), 85-98.
4. Amdahl, G. M. (1967). Validity of the single processor approach to achieving large scale computing capabilities. AFIPS Conference Proceedings, 30, 483-485.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

## 14. Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/parallel-query.html>
  - <https://www.postgresql.org/docs/current/runtime-config-query.html>

---

## 15. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](./02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–ç†è®ºåŸºç¡€
- â­â­â­ [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](./02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æ‰§è¡Œè®¡åˆ’åˆ†æ
- â­â­ [ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹](./02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ç»Ÿè®¡ä¿¡æ¯å¯¹å¹¶è¡ŒæŸ¥è¯¢çš„å½±å“
- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](./02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - å¹¶è¡Œç´¢å¼•æ‰«æä¼˜åŒ–
- â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../../04-å­˜å‚¨ä¸æ¢å¤/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - åˆ—å­˜å‚¨å¹¶è¡ŒæŸ¥è¯¢ã€åˆ—å­˜å‚¨èšåˆä¼˜åŒ–ğŸ†•
- â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](../../../01-æ ¸å¿ƒåŸºç¡€/01.02-ç³»ç»Ÿæ¶æ„/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - è¿›ç¨‹æ¨¡å‹å’Œå†…å­˜ç®¡ç†
- â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜å®è·µæŒ‡å—
- â­ [ç›‘æ§ä¸è¯Šæ–­](../../../12-ç›‘æ§ä¸è¯Šæ–­/README.md) - å¹¶è¡ŒæŸ¥è¯¢ç›‘æ§æ–¹æ³•

### å¤–éƒ¨èµ„æº

- [PostgreSQLå¹¶è¡ŒæŸ¥è¯¢æ–‡æ¡£](https://www.postgresql.org/docs/current/parallel-query.html)
- [PostgreSQLå¹¶è¡ŒæŸ¥è¯¢é…ç½®](https://www.postgresql.org/docs/current/runtime-config-query.html#RUNTIME-CONFIG-QUERY-ENABLE)
- [PostgreSQLå¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/parallel-query.html#PARALLEL-QUERY-PERFORMANCE)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team

```
