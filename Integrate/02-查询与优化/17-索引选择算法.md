---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `DataBaseTheory\05-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–\17-ç´¢å¼•é€‰æ‹©ç®—æ³•.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# PostgreSQLç´¢å¼•é€‰æ‹©ç®—æ³•æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•

- [PostgreSQLç´¢å¼•é€‰æ‹©ç®—æ³•æ·±åº¦è§£æ](#postgresqlç´¢å¼•é€‰æ‹©ç®—æ³•æ·±åº¦è§£æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç´¢å¼•é€‰æ‹©é—®é¢˜](#1-ç´¢å¼•é€‰æ‹©é—®é¢˜)
    - [1.1 ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹](#11-ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹)
  - [2. é€‰æ‹©æ€§åˆ†æ](#2-é€‰æ‹©æ€§åˆ†æ)
    - [2.1 è®¡ç®—é€‰æ‹©æ€§](#21-è®¡ç®—é€‰æ‹©æ€§)
  - [3. æˆæœ¬ä¼°ç®—](#3-æˆæœ¬ä¼°ç®—)
    - [3.1 ç´¢å¼•æ‰«ææˆæœ¬](#31-ç´¢å¼•æ‰«ææˆæœ¬)
  - [4. å¤šåˆ—ç´¢å¼•é¡ºåº](#4-å¤šåˆ—ç´¢å¼•é¡ºåº)
    - [4.1 æœ€ä¼˜é¡ºåºé€‰æ‹©](#41-æœ€ä¼˜é¡ºåºé€‰æ‹©)
    - [4.2 é€‰æ‹©æ€§æ’åº](#42-é€‰æ‹©æ€§æ’åº)
  - [5. éƒ¨åˆ†ç´¢å¼•å†³ç­–](#5-éƒ¨åˆ†ç´¢å¼•å†³ç­–)
    - [5.1 ä½•æ—¶ä½¿ç”¨](#51-ä½•æ—¶ä½¿ç”¨)
  - [6. ç´¢å¼•ç»´æŠ¤ç­–ç•¥](#6-ç´¢å¼•ç»´æŠ¤ç­–ç•¥)
    - [6.1 ä½•æ—¶é‡å»º](#61-ä½•æ—¶é‡å»º)
  - [7. å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
    - [7.1 ç”µå•†è®¢å•ç´¢å¼•è®¾è®¡](#71-ç”µå•†è®¢å•ç´¢å¼•è®¾è®¡)

## 1. ç´¢å¼•é€‰æ‹©é—®é¢˜

### 1.1 ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹

```text
æŸ¥è¯¢: SELECT * FROM users WHERE age > 25 AND city = 'NYC';

å¯ç”¨ç´¢å¼•:
â”œâ”€ idx_age: (age)
â”œâ”€ idx_city: (city)
â””â”€ idx_age_city: (age, city)

ä¼˜åŒ–å™¨è¯„ä¼°:
1. å…¨è¡¨æ‰«æ
   Cost = seq_page_cost Ã— pages + cpu_tuple_cost Ã— rows

2. idx_ageæ‰«æ
   Cost = index_scan_cost + filter_cost(city)

3. idx_cityæ‰«æ
   Cost = index_scan_cost + filter_cost(age)

4. idx_age_cityæ‰«æ
   Cost = index_scan_cost (æœ€ä¼˜)

5. Bitmapæ‰«æ(idx_age + idx_city)
   Cost = bitmap_cost + recheck_cost

é€‰æ‹©æˆæœ¬æœ€ä½çš„è®¡åˆ’
```

---

## 2. é€‰æ‹©æ€§åˆ†æ

### 2.1 è®¡ç®—é€‰æ‹©æ€§

```sql
-- æŸ¥çœ‹åˆ—çš„é€‰æ‹©æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹é€‰æ‹©æ€§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹åˆ—çš„é€‰æ‹©æ€§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    attname,
    n_distinct,
    CASE
        WHEN n_distinct > 0 THEN 1.0 / n_distinct
        WHEN n_distinct < 0 THEN -n_distinct
        ELSE 0
    END AS selectivity
FROM pg_stats
WHERE tablename = 'users';

/*
åˆ—         n_distinct   selectivity
user_id    -1.0         1.0 (å”¯ä¸€)
email      -0.99        0.99 (å‡ ä¹å”¯ä¸€)
city       50           0.02 (50ä¸ªåŸå¸‚)
status     3            0.33 (3ç§çŠ¶æ€)

selectivityè¶Šä½ï¼Œç´¢å¼•è¶Šæœ‰æ•ˆ
*/

-- ç»„åˆé€‰æ‹©æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—ç»„åˆé€‰æ‹©æ€§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—ç»„åˆé€‰æ‹©æ€§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    COUNT(DISTINCT (age, city))::float / COUNT(*) AS combined_selectivity
FROM users;
```

---

## 3. æˆæœ¬ä¼°ç®—

### 3.1 ç´¢å¼•æ‰«ææˆæœ¬

```sql
-- æŸ¥çœ‹æˆæœ¬å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    seq_cost REAL;
    random_cost REAL;
    tuple_cost REAL;
    index_tuple_cost REAL;
BEGIN
    BEGIN
        SELECT current_setting('seq_page_cost')::REAL INTO seq_cost;
        SELECT current_setting('random_page_cost')::REAL INTO random_cost;
        SELECT current_setting('cpu_tuple_cost')::REAL INTO tuple_cost;
        SELECT current_setting('cpu_index_tuple_cost')::REAL INTO index_tuple_cost;

        RAISE NOTICE 'æˆæœ¬å‚æ•°:';
        RAISE NOTICE '  seq_page_cost: %', seq_cost;
        RAISE NOTICE '  random_page_cost: %', random_cost;
        RAISE NOTICE '  cpu_tuple_cost: %', tuple_cost;
        RAISE NOTICE '  cpu_index_tuple_cost: %', index_tuple_cost;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'è·å–æˆæœ¬å‚æ•°å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- ä¼°ç®—å…¬å¼
/*
Index Scanæˆæœ¬:
= index_startup_cost
+ index_pages Ã— random_page_cost
+ index_tuples Ã— cpu_index_tuple_cost
+ heap_pages Ã— random_page_cost
+ heap_tuples Ã— cpu_tuple_cost

Seq Scanæˆæœ¬:
= pages Ã— seq_page_cost
+ tuples Ã— cpu_tuple_cost
*/

-- æŸ¥çœ‹å®é™…æˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹å®é™…æˆæœ¬';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹æŸ¥çœ‹å®é™…æˆæœ¬';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, COSTS, BUFFERS, TIMING, VERBOSE)
SELECT * FROM users WHERE city = 'NYC';
```

---

## 4. å¤šåˆ—ç´¢å¼•é¡ºåº

### 4.1 æœ€ä¼˜é¡ºåºé€‰æ‹©

```sql
-- æŸ¥è¯¢æ¨¡å¼åˆ†æ
/*
æŸ¥è¯¢1: WHERE a = ? AND b = ?          (é¢‘ç‡: 1000æ¬¡/ç§’)
æŸ¥è¯¢2: WHERE a = ?                     (é¢‘ç‡: 500æ¬¡/ç§’)
æŸ¥è¯¢3: WHERE b = ?                     (é¢‘ç‡: 100æ¬¡/ç§’)
æŸ¥è¯¢4: WHERE a = ? ORDER BY c          (é¢‘ç‡: 200æ¬¡/ç§’)
*/

-- æ–¹æ¡ˆ1: (a, b, c)
CREATE INDEX idx_abc ON table(a, b, c);
-- æŸ¥è¯¢1: âœ“ å®Œå…¨ä½¿ç”¨
-- æŸ¥è¯¢2: âœ“ ä½¿ç”¨a
-- æŸ¥è¯¢3: âœ— æ— æ³•ä½¿ç”¨ (PostgreSQL 18: Skip Scanå¯ä»¥!)
-- æŸ¥è¯¢4: âœ“ ä½¿ç”¨aï¼Œæ’åºc

-- æ–¹æ¡ˆ2: (b, a, c)
CREATE INDEX idx_bac ON table(b, a, c);
-- æŸ¥è¯¢1: âœ“ å®Œå…¨ä½¿ç”¨
-- æŸ¥è¯¢2: âœ— æ— æ³•ä½¿ç”¨
-- æŸ¥è¯¢3: âœ“ ä½¿ç”¨b
-- æŸ¥è¯¢4: âœ— æ— æ³•ä¼˜åŒ–æ’åº

-- é€‰æ‹©: æ–¹æ¡ˆ1 (é«˜é¢‘æŸ¥è¯¢ä¼˜å…ˆ)
```

### 4.2 é€‰æ‹©æ€§æ’åº

```sql
-- è§„åˆ™: é€‰æ‹©æ€§é«˜çš„åˆ—åœ¨å‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•è®¡ç®—é€‰æ‹©æ€§';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹è®¡ç®—åˆ—é€‰æ‹©æ€§';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æŸ¥è¯¢å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT
    'age' AS column,
    COUNT(DISTINCT age)::float / COUNT(*) AS selectivity
FROM users
UNION ALL
SELECT 'city', COUNT(DISTINCT city)::float / COUNT(*) FROM users
UNION ALL
SELECT 'status', COUNT(DISTINCT status)::float / COUNT(*) FROM users;

/*
column    selectivity
age       0.05 (20ç§å¹´é¾„æ®µ)
city      0.02 (50ä¸ªåŸå¸‚)
status    0.33 (3ç§çŠ¶æ€)

æ’åº: city, age, status
*/

-- åˆ›å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'users' AND indexname = 'idx_city_age_status') THEN
            RAISE WARNING 'ç´¢å¼• idx_city_age_status å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_city_age_status ON users(city, age, status);
            RAISE NOTICE 'ç´¢å¼• idx_city_age_status åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ users ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_city_age_status å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 5. éƒ¨åˆ†ç´¢å¼•å†³ç­–

### 5.1 ä½•æ—¶ä½¿ç”¨

```sql
-- åœºæ™¯: æŸ¥è¯¢åªå…³æ³¨æ´»è·ƒç”¨æˆ·ï¼ˆå 10%ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users') THEN
            RAISE WARNING 'è¡¨ users ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        -- æ£€æŸ¥statusåˆ—æ˜¯å¦å­˜åœ¨
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_schema = 'public' AND table_name = 'users' AND column_name = 'status'
        ) THEN
            RAISE EXCEPTION 'åˆ— status ä¸å­˜åœ¨';
        END IF;

        -- æ–¹æ¡ˆ1: å…¨ç´¢å¼•ï¼ˆä»…ä½œå¯¹æ¯”ï¼Œå®é™…ä¸åˆ›å»ºï¼‰
        -- CREATE INDEX idx_status_full ON users(status);
        -- å¤§å°: 100MB
        -- æŸ¥è¯¢æ´»è·ƒç”¨æˆ·: ä½¿ç”¨ç´¢å¼•

        -- æ–¹æ¡ˆ2: éƒ¨åˆ†ç´¢å¼•ï¼ˆæ¨èï¼‰
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'users' AND indexname = 'idx_status_active') THEN
            RAISE WARNING 'ç´¢å¼• idx_status_active å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_status_active ON users(status) WHERE status = 'active';
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_status_active åˆ›å»ºæˆåŠŸ';
            -- å¤§å°: 10MB (-90%)
            -- æŸ¥è¯¢æ´»è·ƒç”¨æˆ·: ä½¿ç”¨ç´¢å¼•
            -- æŸ¥è¯¢éæ´»è·ƒ: å…¨è¡¨æ‰«æï¼ˆä½†æ•°æ®å°‘ï¼‰
        END IF;

        RAISE NOTICE 'é€‰æ‹©: éƒ¨åˆ†ç´¢å¼•ï¼ˆèŠ‚çœ90%ç©ºé—´å’Œå†™å…¥å¼€é”€ï¼‰';
        RAISE NOTICE 'é€‚ç”¨æ¡ä»¶:';
        RAISE NOTICE '  âœ“ æŸ¥è¯¢é›†ä¸­åœ¨æŸä¸ªå­é›†';
        RAISE NOTICE '  âœ“ å­é›†å æ¯”<20%%';
        RAISE NOTICE '  âœ“ å…¶ä»–æ•°æ®æŸ¥è¯¢é¢‘ç‡ä½';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ users ä¸å­˜åœ¨';
        WHEN undefined_column THEN
            RAISE EXCEPTION 'åˆ— status ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'ç´¢å¼• idx_status_active å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºéƒ¨åˆ†ç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;
```

---

## 6. ç´¢å¼•ç»´æŠ¤ç­–ç•¥

### 6.1 ä½•æ—¶é‡å»º

```sql
-- æ£€æŸ¥ç´¢å¼•è†¨èƒ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        RAISE NOTICE 'å¼€å§‹æ£€æŸ¥ç´¢å¼•è†¨èƒ€';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'æ£€æŸ¥å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
WITH index_stats AS (
    SELECT
        schemaname,
        tablename,
        indexname,
        pg_relation_size(indexrelid) AS index_size,
        idx_scan,
        idx_tup_read,
        idx_tup_fetch
    FROM pg_stat_user_indexes
)
SELECT
    indexname,
    pg_size_pretty(index_size) AS size,
    idx_scan,
    CASE
        WHEN idx_scan = 0 THEN 'æœªä½¿ç”¨'
        WHEN idx_tup_fetch::float / NULLIF(idx_scan, 0) < 10 THEN 'æ•ˆç‡ä½'
        WHEN index_size > 1073741824 THEN 'è€ƒè™‘é‡å»º'
        ELSE 'æ­£å¸¸'
    END AS status
FROM index_stats
WHERE index_size > 104857600  -- >100MB
ORDER BY index_size DESC;

-- é‡å»ºç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_indexes
            WHERE schemaname = 'public' AND indexname = 'idx_users_email'
        ) THEN
            RAISE WARNING 'ç´¢å¼• idx_users_email ä¸å­˜åœ¨ï¼Œæ— æ³•é‡å»º';
            RETURN;
        END IF;

        RAISE NOTICE 'å¼€å§‹é‡å»ºç´¢å¼• idx_users_email';
        -- REINDEX INDEX CONCURRENTLY idx_users_email;
        -- æ³¨æ„ï¼šREINDEX CONCURRENTLYéœ€è¦PostgreSQL 12+ï¼Œä¸”ä¸èƒ½åœ¨äº‹åŠ¡å—ä¸­æ‰§è¡Œ
        RAISE NOTICE 'ç´¢å¼•é‡å»ºå‘½ä»¤å·²å‡†å¤‡ï¼ˆè¯·æ‰‹åŠ¨æ‰§è¡Œ: REINDEX INDEX CONCURRENTLY idx_users_email;ï¼‰';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'ç´¢å¼•é‡å»ºå‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- å®šæœŸç»´æŠ¤å»ºè®®
-- æ¯æœˆé‡å»ºå¤§ç´¢å¼•ï¼ˆ>1GBï¼‰
-- æ¯å­£åº¦é‡å»ºæ‰€æœ‰ç´¢å¼•
```

---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 ç”µå•†è®¢å•ç´¢å¼•è®¾è®¡

```sql
-- è®¢å•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders å·²å­˜åœ¨';
        ELSE
            CREATE TABLE orders (
                order_id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL,
                status VARCHAR(20) NOT NULL,
                amount NUMERIC(12,2) NOT NULL,
                created_at TIMESTAMPTZ NOT NULL DEFAULT now()
            );
            RAISE NOTICE 'è¡¨ orders åˆ›å»ºæˆåŠŸ';
        END IF;
    EXCEPTION
        WHEN duplicate_table THEN
            RAISE WARNING 'è¡¨ orders å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºè¡¨ orders å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- æŸ¥è¯¢æ¨¡å¼åˆ†æ
/*
Q1: WHERE user_id = ? ORDER BY created_at DESC  (90%)
Q2: WHERE status = 'pending'                     (5%)
Q3: WHERE created_at > ? AND status = ?          (3%)
Q4: WHERE amount > 1000                          (2%)
*/

-- ç´¢å¼•è®¾è®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
            RETURN;
        END IF;

        -- ä¸»ç´¢å¼•ï¼ˆè¦†ç›–Q1ï¼‰
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_user_created') THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_user_created å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_orders_user_created ON orders(user_id, created_at DESC);
            RAISE NOTICE 'ä¸»ç´¢å¼• idx_orders_user_created åˆ›å»ºæˆåŠŸ';
        END IF;

        -- éƒ¨åˆ†ç´¢å¼•ï¼ˆè¦†ç›–Q2ï¼‰
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_pending') THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_pending å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_orders_pending ON orders(status, created_at)
            WHERE status = 'pending';
            RAISE NOTICE 'éƒ¨åˆ†ç´¢å¼• idx_orders_pending åˆ›å»ºæˆåŠŸ';
        END IF;

        -- ç»„åˆç´¢å¼•ï¼ˆè¦†ç›–Q3ï¼‰
        IF EXISTS (SELECT 1 FROM pg_indexes WHERE tablename = 'orders' AND indexname = 'idx_orders_created_status') THEN
            RAISE WARNING 'ç´¢å¼• idx_orders_created_status å·²å­˜åœ¨';
        ELSE
            CREATE INDEX idx_orders_created_status ON orders(created_at, status);
            RAISE NOTICE 'ç»„åˆç´¢å¼• idx_orders_created_status åˆ›å»ºæˆåŠŸ';
        END IF;

        RAISE NOTICE 'Q4: é¢‘ç‡ä½ï¼Œå…¨è¡¨æ‰«æå¯æ¥å—';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨ orders ä¸å­˜åœ¨';
        WHEN duplicate_table THEN
            RAISE WARNING 'éƒ¨åˆ†ç´¢å¼•å·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
    END;
END $$;

-- éªŒè¯ï¼ˆå¸¦æ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'orders') THEN
            RAISE WARNING 'è¡¨ orders ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯';
            RETURN;
        END IF;
        RAISE NOTICE 'å¼€å§‹éªŒè¯ç´¢å¼•ä½¿ç”¨æƒ…å†µ';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'éªŒè¯å‡†å¤‡å¤±è´¥: %', SQLERRM;
    END;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM orders WHERE user_id = 123 ORDER BY created_at DESC LIMIT 10;
-- ä½¿ç”¨: idx_orders_user_created
```

---

**å®Œæˆ**: PostgreSQLç´¢å¼•é€‰æ‹©ç®—æ³•æ·±åº¦è§£æ
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: ä¼˜åŒ–å™¨å†³ç­–ã€é€‰æ‹©æ€§åˆ†æã€æˆæœ¬ä¼°ç®—ã€å¤šåˆ—ç´¢å¼•ã€éƒ¨åˆ†ç´¢å¼•ã€å®æˆ˜æ¡ˆä¾‹
