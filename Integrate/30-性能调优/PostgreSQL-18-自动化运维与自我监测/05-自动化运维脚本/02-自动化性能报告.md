# 5.2 自动化性能报告

> **所属主题**: 05-自动化运维脚本
> **章节编号**: 5.2
> **创建日期**: 2025年1月
> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐
> **相关章节**: [5.1 自动化健康检查](./01-自动化健康检查.md) | [5.3 自动化告警系统](./03-自动化告警系统.md)

---

## 📋 目录

- [5.2 自动化性能报告](#52-自动化性能报告)
  - [📋 目录](#-目录)
  - [5.2.1 概述与背景](#521-概述与背景)
  - [5.2.2 自动化性能报告系统](#522-自动化性能报告系统)
    - [5.2.2.1 完整性能报告脚本](#5221-完整性能报告脚本)
  - [5.2.3 创建性能报告函数](#523-创建性能报告函数)
    - [5.2.3.1 可重用函数版本](#5231-可重用函数版本)
  - [5.2.4 报告内容说明](#524-报告内容说明)
    - [5.2.4.1 数据库级别统计](#5241-数据库级别统计)
    - [5.2.4.2 表级别统计](#5242-表级别统计)
    - [5.2.4.3 索引级别统计](#5243-索引级别统计)
  - [5.2.5 PostgreSQL 18增强统计](#525-postgresql-18增强统计)
  - [5.2.6 定时生成性能报告](#526-定时生成性能报告)
    - [5.2.6.1 使用pg\_cron定时生成](#5261-使用pg_cron定时生成)
  - [5.2.7 报告输出格式](#527-报告输出格式)
    - [5.2.7.1 文本格式输出](#5271-文本格式输出)
    - [5.2.7.2 JSON格式输出](#5272-json格式输出)
  - [5.2.8 PostgreSQL 18自动化特性](#528-postgresql-18自动化特性)
  - [5.2.9 注意事项与最佳实践](#529-注意事项与最佳实践)
    - [5.2.9.1 注意事项](#5291-注意事项)
    - [5.2.9.2 最佳实践](#5292-最佳实践)
  - [5.2.10 导航](#5210-导航)
    - [5.2.10.1 章节导航](#52101-章节导航)
    - [5.2.10.2 相关章节](#52102-相关章节)
  - [📚 相关资源](#-相关资源)

---

## 5.2.1 概述与背景

PostgreSQL 18自动化性能报告系统可以自动生成详细的性能报告，包括数据库级别统计、表级别统计、索引级别统计等，帮助全面了解数据库性能状况。

---

## 5.2.2 自动化性能报告系统

### 5.2.2.1 完整性能报告脚本

```sql
-- PostgreSQL 18 自动化性能报告系统（带错误处理和性能测试）
DO $$
DECLARE
    report_date timestamp := NOW();
    db_stats RECORD;
    table_stats RECORD;
    index_stats RECORD;
BEGIN
    BEGIN
        RAISE NOTICE '=== PostgreSQL 18自动化性能报告 ===';
        RAISE NOTICE '报告生成时间: %', report_date;
        RAISE NOTICE '';

        -- 数据库级别统计
        SELECT
            datname,
            numbackends,
            xact_commit,
            xact_rollback,
            blks_read,
            blks_hit,
            ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio,
            temp_files,
            temp_bytes,
            deadlocks
        INTO db_stats
        FROM pg_stat_database
        WHERE datname = current_database();

        RAISE NOTICE '=== 数据库级别统计 ===';
        RAISE NOTICE '数据库名: %', db_stats.datname;
        RAISE NOTICE '活跃连接: %', db_stats.numbackends;
        RAISE NOTICE '事务提交: % | 回滚: %', db_stats.xact_commit, db_stats.xact_rollback;
        RAISE NOTICE '缓存命中率: %%', db_stats.cache_hit_ratio;
        RAISE NOTICE '临时文件: % (%.2f MB)',
            db_stats.temp_files,
            ROUND(db_stats.temp_bytes::numeric / 1024 / 1024, 2);
        RAISE NOTICE '死锁次数: %', db_stats.deadlocks;
        RAISE NOTICE '';

        -- 表级别统计（Top 10）
        RAISE NOTICE '=== 表级别统计（Top 10） ===';
        FOR table_stats IN
            SELECT
                schemaname,
                tablename,
                n_tup_ins + n_tup_upd + n_tup_del AS total_changes,
                n_live_tup,
                n_dead_tup,
                seq_scan,
                idx_scan,
                last_vacuum,
                last_autovacuum,
                last_analyze,
                last_autoanalyze
            FROM pg_stat_user_tables
            ORDER BY n_tup_ins + n_tup_upd + n_tup_del DESC
            LIMIT 10
        LOOP
            RAISE NOTICE '表: %.%', table_stats.schemaname, table_stats.tablename;
            RAISE NOTICE '  总变更: % | 活元组: % | 死元组: %',
                table_stats.total_changes, table_stats.n_live_tup, table_stats.n_dead_tup;
            RAISE NOTICE '  全表扫描: % | 索引扫描: %',
                table_stats.seq_scan, table_stats.idx_scan;
            RAISE NOTICE '';
        END LOOP;

        -- 索引级别统计（Top 10）
        RAISE NOTICE '=== 索引级别统计（Top 10） ===';
        FOR index_stats IN
            SELECT
                schemaname,
                tablename,
                indexrelname,
                idx_scan,
                idx_tup_read,
                idx_tup_fetch,
                pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
            FROM pg_stat_user_indexes
            ORDER BY idx_scan DESC
            LIMIT 10
        LOOP
            RAISE NOTICE '索引: %.%.%',
                index_stats.schemaname, index_stats.tablename, index_stats.indexrelname;
            RAISE NOTICE '  扫描次数: % | 读取行数: % | 获取行数: %',
                index_stats.idx_scan, index_stats.idx_tup_read, index_stats.idx_tup_fetch;
            RAISE NOTICE '  索引大小: %', index_stats.index_size;
            RAISE NOTICE '';
        END LOOP;

        -- PostgreSQL 18增强统计
        IF (SELECT current_setting('server_version_num')::int) >= 180000 THEN
            RAISE NOTICE '=== PostgreSQL 18增强统计 ===';
            RAISE NOTICE '- pg_stat_io: I/O详细统计';
            RAISE NOTICE '- pg_stat_get_backend_io(): 后端I/O追踪';
            RAISE NOTICE '- 连接阶段耗时记录';
            RAISE NOTICE '- WAL详细统计';
        END IF;

        RAISE NOTICE '';
        RAISE NOTICE '报告生成完成';
        RAISE NOTICE '';
        RAISE NOTICE 'PostgreSQL 18自动化特性:';
        RAISE NOTICE '- 自动生成性能报告';
        RAISE NOTICE '- 自动分析性能趋势';
        RAISE NOTICE '- 自动识别性能问题';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '自动化性能报告生成失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 5.2.3 创建性能报告函数

### 5.2.3.1 可重用函数版本

```sql
-- 创建自动化性能报告函数
CREATE OR REPLACE FUNCTION pg18_performance_report()
RETURNS TABLE(
    report_section TEXT,
    report_item TEXT,
    report_value TEXT,
    report_time TIMESTAMP
) AS $$
DECLARE
    report_time TIMESTAMP := NOW();
    db_stats RECORD;
    table_stats RECORD;
    index_stats RECORD;
BEGIN
    -- 数据库级别统计
    SELECT
        datname,
        numbackends,
        xact_commit,
        xact_rollback,
        ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio,
        temp_files,
        deadlocks
    INTO db_stats
    FROM pg_stat_database
    WHERE datname = current_database();

    RETURN QUERY SELECT '数据库统计', '数据库名', db_stats.datname::TEXT, report_time;
    RETURN QUERY SELECT '数据库统计', '活跃连接', db_stats.numbackends::TEXT, report_time;
    RETURN QUERY SELECT '数据库统计', '事务提交', db_stats.xact_commit::TEXT, report_time;
    RETURN QUERY SELECT '数据库统计', '事务回滚', db_stats.xact_rollback::TEXT, report_time;
    RETURN QUERY SELECT '数据库统计', '缓存命中率', db_stats.cache_hit_ratio::TEXT || '%', report_time;
    RETURN QUERY SELECT '数据库统计', '临时文件', db_stats.temp_files::TEXT, report_time;
    RETURN QUERY SELECT '数据库统计', '死锁次数', db_stats.deadlocks::TEXT, report_time;

    -- 表级别统计（Top 5）
    FOR table_stats IN
        SELECT
            schemaname || '.' || tablename AS table_name,
            n_tup_ins + n_tup_upd + n_tup_del AS total_changes,
            n_live_tup,
            n_dead_tup,
            seq_scan,
            idx_scan
        FROM pg_stat_user_tables
        ORDER BY n_tup_ins + n_tup_upd + n_tup_del DESC
        LIMIT 5
    LOOP
        RETURN QUERY SELECT '表统计', table_stats.table_name,
            format('变更:%s 活元组:%s 死元组:%s',
                table_stats.total_changes,
                table_stats.n_live_tup,
                table_stats.n_dead_tup),
            report_time;
    END LOOP;

    -- 索引级别统计（Top 5）
    FOR index_stats IN
        SELECT
            schemaname || '.' || tablename || '.' || indexrelname AS index_name,
            idx_scan,
            pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
        FROM pg_stat_user_indexes
        ORDER BY idx_scan DESC
        LIMIT 5
    LOOP
        RETURN QUERY SELECT '索引统计', index_stats.index_name,
            format('扫描:%s 大小:%s', index_stats.idx_scan, index_stats.index_size),
            report_time;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT * FROM pg18_performance_report();
```

---

## 5.2.4 报告内容说明

### 5.2.4.1 数据库级别统计

- **数据库名**：当前数据库名称
- **活跃连接**：当前活跃连接数
- **事务提交/回滚**：事务统计
- **缓存命中率**：缓冲区命中率
- **临时文件**：临时文件使用情况
- **死锁次数**：死锁统计

### 5.2.4.2 表级别统计

- **总变更**：插入、更新、删除的总数
- **活元组/死元组**：表的元组统计
- **全表扫描/索引扫描**：扫描统计

### 5.2.4.3 索引级别统计

- **扫描次数**：索引使用频率
- **读取行数/获取行数**：索引效率
- **索引大小**：索引占用空间

---

## 5.2.5 PostgreSQL 18增强统计

PostgreSQL 18新增的统计功能：

1. **pg_stat_io**：I/O详细统计（read_bytes、write_bytes列）
2. **pg_stat_get_backend_io()**：后端I/O追踪
3. **连接阶段耗时记录**：连接性能分析（log_connections细粒度配置）
4. **WAL详细统计**：WAL性能分析（pg_stat_checkpointer增强）
5. **并行查询追踪**：pg_stat_statements的并行查询列

---

## 5.2.6 定时生成性能报告

### 5.2.6.1 使用pg_cron定时生成

```sql
-- 每天凌晨2点生成性能报告
SELECT cron.schedule(
    'performance-report-daily',
    '0 2 * * *',
    $$SELECT * FROM pg18_performance_report()$$
);
```

---

## 5.2.7 报告输出格式

### 5.2.7.1 文本格式输出

```sql
-- 文本格式输出
SELECT
    report_section || ' | ' || report_item || ' | ' || report_value AS report_line
FROM pg18_performance_report()
ORDER BY report_section, report_item;
```

### 5.2.7.2 JSON格式输出

```sql
-- JSON格式输出
SELECT json_agg(
    json_build_object(
        'section', report_section,
        'item', report_item,
        'value', report_value,
        'time', report_time
    )
)
FROM pg18_performance_report();
```

---

## 5.2.8 PostgreSQL 18自动化特性

PostgreSQL 18自动化性能报告系统的核心特性：

1. **自动生成性能报告**：自动生成详细的性能报告
2. **自动分析性能趋势**：分析性能变化趋势
3. **自动识别性能问题**：识别潜在性能问题
4. **I/O统计增强**：使用PostgreSQL 18的I/O统计增强进行更准确的I/O分析
5. **并行查询分析**：使用并行查询追踪列分析并行查询效率

---

## 5.2.9 注意事项与最佳实践

### 5.2.9.1 注意事项

⚠️ **重要提醒**：

1. **报告频率**：根据实际情况设置报告生成频率，建议每天或每周
2. **数据保留**：考虑报告数据的保留策略，建议保留30-90天
3. **性能影响**：报告生成会有轻微性能影响，建议在低峰期生成

### 5.2.9.2 最佳实践

✅ **推荐做法**：

1. **定时生成**：使用pg_cron定时生成性能报告
2. **格式选择**：根据需求选择合适的输出格式（文本/JSON/CSV）
3. **存储策略**：将报告保存到文件系统或数据库中
4. **趋势分析**：定期分析性能趋势，识别潜在问题

---

## 5.2.10 导航

### 5.2.10.1 章节导航

- **上一节**：[5.1 自动化健康检查](./01-自动化健康检查.md)
- **下一节**：[5.3 自动化告警系统](./03-自动化告警系统.md)
- **返回主题目录**：[05-自动化运维脚本](./README.md)
- **返回主文档**：[PostgreSQL-18-自动化运维与自我监测](../README.md)

### 5.2.10.2 相关章节

- [5.1 自动化健康检查](./01-自动化健康检查.md) - 健康检查脚本
- [5.3 自动化告警系统](./03-自动化告警系统.md) - 告警系统
- [4.1 自动慢查询检测](../04-自动化诊断/01-自动慢查询检测.md) - 慢查询检测
- [7.1 监控仪表板设计](../07-监控仪表板/01-监控仪表板设计.md) - 监控仪表板

---

## 📚 相关资源

- [PostgreSQL 18 pg_stat_database文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW)
- [pg_stat_user_tables文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-USER-TABLES-VIEW)
- [pg_stat_user_indexes文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-USER-INDEXES-VIEW)
- [PostgreSQL性能调优指南](../../PostgreSQL性能调优完整指南.md)

---

**最后更新**: 2025年1月
**文档版本**: v2.0（已添加完整目录、章节编号、详细内容）
