# 自动化健康检查

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐
> **相关章节**: [自动资源瓶颈检测](../04-自动化诊断/03-自动资源瓶颈检测.md) | [自动化性能报告](./02-自动化性能报告.md)

---

## 概述

PostgreSQL 18自动化健康检查系统可以自动检查数据库的健康状态，包括连接状态、锁等待、死元组、统计信息、I/O性能等关键指标。

---

## 自动化健康检查脚本

### 完整健康检查脚本

```sql
-- PostgreSQL 18 自动化健康检查系统（带错误处理和性能测试）
DO $$
DECLARE
    health_status text := '健康';
    health_issues text[] := ARRAY[]::text[];
    check_result RECORD;
BEGIN
    BEGIN
        RAISE NOTICE '=== PostgreSQL 18自动化健康检查系统 ===';
        RAISE NOTICE '开始健康检查...';
        RAISE NOTICE '';

        -- 检查1: 数据库连接
        SELECT COUNT(*) INTO check_result
        FROM pg_stat_activity
        WHERE datname = current_database();

        IF check_result.count = 0 THEN
            health_issues := array_append(health_issues, '数据库连接异常');
        ELSE
            RAISE NOTICE '✓ 数据库连接正常: % 个连接', check_result.count;
        END IF;

        -- 检查2: 锁等待
        SELECT COUNT(*) INTO check_result
        FROM pg_catalog.pg_locks blocked_locks
        JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
        WHERE NOT blocked_locks.granted;

        IF check_result.count > 5 THEN
            health_issues := array_append(health_issues, format('锁等待过多: % 个', check_result.count));
        ELSE
            RAISE NOTICE '✓ 锁状态正常: % 个等待', check_result.count;
        END IF;

        -- 检查3: 死元组（PostgreSQL 18）
        SELECT
            SUM(n_dead_tup) AS total_dead_tuples,
            SUM(n_live_tup) AS total_live_tuples
        INTO check_result
        FROM pg_stat_user_tables;

        IF check_result.total_dead_tuples > 0 THEN
            DECLARE
                dead_ratio numeric;
            BEGIN
                dead_ratio := 100.0 * check_result.total_dead_tuples /
                              NULLIF(check_result.total_dead_tuples + check_result.total_live_tuples, 0);
                IF dead_ratio > 10 THEN
                    health_issues := array_append(health_issues,
                        format('死元组比例过高: %.2f%%', dead_ratio));
                ELSE
                    RAISE NOTICE '✓ 死元组比例正常: %.2f%%', dead_ratio;
                END IF;
            END;
        ELSE
            RAISE NOTICE '✓ 无死元组';
        END IF;

        -- 检查4: 统计信息（PostgreSQL 18）
        SELECT COUNT(*) INTO check_result
        FROM pg_stat_user_tables
        WHERE last_autoanalyze IS NULL
           OR last_autoanalyze < NOW() - INTERVAL '7 days';

        IF check_result.count > 10 THEN
            health_issues := array_append(health_issues,
                format('统计信息过期表过多: % 个', check_result.count));
        ELSE
            RAISE NOTICE '✓ 统计信息正常: % 个表需要更新', check_result.count;
        END IF;

        -- 检查5: I/O性能（PostgreSQL 18）
        IF (SELECT current_setting('server_version_num')::int) >= 180000 THEN
            SELECT
                SUM(reads + writes) AS total_io,
                SUM(read_bytes + write_bytes) AS total_bytes
            INTO check_result
            FROM pg_stat_io;

            IF check_result.total_io > 0 THEN
                RAISE NOTICE '✓ I/O统计正常: % 次操作, %.2f MB',
                    check_result.total_io,
                    ROUND(check_result.total_bytes::numeric / 1024 / 1024, 2);
            END IF;
        END IF;

        -- 汇总健康状态
        RAISE NOTICE '';
        IF array_length(health_issues, 1) > 0 THEN
            health_status := '警告';
            RAISE WARNING '健康状态: %', health_status;
            RAISE NOTICE '发现的问题:';
            FOREACH check_result.count IN ARRAY health_issues
            LOOP
                RAISE NOTICE '  - %', check_result.count;
            END LOOP;
        ELSE
            RAISE NOTICE '健康状态: %', health_status;
            RAISE NOTICE '所有检查项均正常';
        END IF;

        RAISE NOTICE '';
        RAISE NOTICE 'PostgreSQL 18自动化特性:';
        RAISE NOTICE '- 自动健康检查';
        RAISE NOTICE '- 自动问题识别';
        RAISE NOTICE '- 自动生成报告';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '自动化健康检查失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 健康检查项说明

### 1. 数据库连接检查

检查当前数据库的连接数，确保数据库可以正常连接。

**检查标准**：

- 连接数 > 0：正常
- 连接数 = 0：异常

### 2. 锁等待检查

检查当前锁等待的数量，识别可能的锁竞争问题。

**检查标准**：

- 锁等待数 ≤ 5：正常
- 锁等待数 > 5：警告

### 3. 死元组检查

检查死元组比例，识别表膨胀问题。

**检查标准**：

- 死元组比例 ≤ 10%：正常
- 死元组比例 > 10%：警告

### 4. 统计信息检查

检查统计信息的时效性，确保查询优化器有准确的统计信息。

**检查标准**：

- 过期表数 ≤ 10：正常
- 过期表数 > 10：警告

### 5. I/O性能检查（PostgreSQL 18）

检查I/O统计信息，识别I/O性能问题。

**检查标准**：

- I/O操作数 > 0：正常（有I/O活动）

---

## 创建健康检查函数

### 可重用函数版本

```sql
-- 创建自动化健康检查函数
CREATE OR REPLACE FUNCTION pg18_health_check()
RETURNS TABLE(
    check_item TEXT,
    check_status TEXT,
    check_message TEXT,
    check_time TIMESTAMP
) AS $$
DECLARE
    check_item TEXT;
    check_status TEXT;
    check_message TEXT;
    check_time TIMESTAMP := NOW();
    check_result RECORD;
BEGIN
    -- 检查1: 数据库连接
    SELECT COUNT(*) INTO check_result
    FROM pg_stat_activity
    WHERE datname = current_database();

    check_item := '数据库连接';
    IF check_result.count = 0 THEN
        check_status := '异常';
        check_message := '数据库连接数为0';
    ELSE
        check_status := '正常';
        check_message := format('连接数: %', check_result.count);
    END IF;
    RETURN QUERY SELECT check_item, check_status, check_message, check_time;

    -- 检查2: 锁等待
    SELECT COUNT(*) INTO check_result
    FROM pg_catalog.pg_locks blocked_locks
    JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
    WHERE NOT blocked_locks.granted;

    check_item := '锁等待';
    IF check_result.count > 5 THEN
        check_status := '警告';
        check_message := format('锁等待数: %', check_result.count);
    ELSE
        check_status := '正常';
        check_message := format('锁等待数: %', check_result.count);
    END IF;
    RETURN QUERY SELECT check_item, check_status, check_message, check_time;

    -- 检查3: 死元组
    SELECT
        SUM(n_dead_tup) AS total_dead_tuples,
        SUM(n_live_tup) AS total_live_tuples
    INTO check_result
    FROM pg_stat_user_tables;

    check_item := '死元组';
    IF check_result.total_dead_tuples > 0 THEN
        DECLARE
            dead_ratio numeric;
        BEGIN
            dead_ratio := 100.0 * check_result.total_dead_tuples /
                          NULLIF(check_result.total_dead_tuples + check_result.total_live_tuples, 0);
            IF dead_ratio > 10 THEN
                check_status := '警告';
                check_message := format('死元组比例: %.2f%%', dead_ratio);
            ELSE
                check_status := '正常';
                check_message := format('死元组比例: %.2f%%', dead_ratio);
            END IF;
        END;
    ELSE
        check_status := '正常';
        check_message := '无死元组';
    END IF;
    RETURN QUERY SELECT check_item, check_status, check_message, check_time;

    -- 检查4: 统计信息
    SELECT COUNT(*) INTO check_result
    FROM pg_stat_user_tables
    WHERE last_autoanalyze IS NULL
       OR last_autoanalyze < NOW() - INTERVAL '7 days';

    check_item := '统计信息';
    IF check_result.count > 10 THEN
        check_status := '警告';
        check_message := format('过期表数: %', check_result.count);
    ELSE
        check_status := '正常';
        check_message := format('过期表数: %', check_result.count);
    END IF;
    RETURN QUERY SELECT check_item, check_status, check_message, check_time;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT * FROM pg18_health_check();
```

---

## 定时执行健康检查

### 使用pg_cron定时执行

```sql
-- 安装pg_cron扩展（如果未安装）
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 每小时执行健康检查
SELECT cron.schedule(
    'health-check-hourly',
    '0 * * * *',
    $$SELECT * FROM pg18_health_check()$$
);
```

---

## PostgreSQL 18自动化特性

1. **自动健康检查**：自动检查数据库健康状态
2. **自动问题识别**：自动识别潜在问题
3. **自动生成报告**：自动生成健康检查报告

---

## 注意事项

1. **检查频率**：根据实际情况设置检查频率
2. **阈值调整**：根据实际情况调整检查阈值
3. **性能影响**：健康检查本身会有轻微性能影响

---

## 相关资源

- [pg_stat_activity文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW)
- [pg_locks文档](https://www.postgresql.org/docs/18/view-pg-locks.html)
- [pg_cron文档](https://github.com/citusdata/pg_cron)

---

**上一节**: [自动资源瓶颈检测](../04-自动化诊断/03-自动资源瓶颈检测.md)
**下一节**: [自动化性能报告](./02-自动化性能报告.md)
**返回**: [自动化运维脚本目录](./README.md)
