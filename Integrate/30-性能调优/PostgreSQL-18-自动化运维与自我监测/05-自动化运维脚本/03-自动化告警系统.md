# 自动化告警系统

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐⭐
> **相关章节**: [自动化性能报告](./02-自动化性能报告.md) | [自动化健康检查](./01-自动化健康检查.md)

---

## 概述

PostgreSQL 18自动化告警系统可以自动检测各种告警条件，包括连接数告警、死锁告警、缓存命中率告警、死元组告警、锁等待告警等，并自动分级告警。

---

## 自动化告警系统脚本

### 完整告警系统脚本

```sql
-- PostgreSQL 18 自动化告警系统（带错误处理和性能测试）
DO $$
DECLARE
    alert_count int := 0;
    alert_level text;
    alert_message text;
BEGIN
    BEGIN
        RAISE NOTICE '=== PostgreSQL 18自动化告警系统 ===';
        RAISE NOTICE '扫描告警条件...';
        RAISE NOTICE '';

        -- 告警1: 连接数告警
        DECLARE
            current_connections int;
            max_connections int;
        BEGIN
            SELECT COUNT(*) INTO current_connections
            FROM pg_stat_activity
            WHERE datname = current_database();

            SELECT setting::int INTO max_connections
            FROM pg_settings
            WHERE name = 'max_connections';

            IF current_connections > max_connections * 0.9 THEN
                alert_count := alert_count + 1;
                alert_level := '严重';
                alert_message := format('连接数告警: % / % (使用率超过90%%)',
                    current_connections, max_connections);
                RAISE WARNING '[%] %', alert_level, alert_message;
            ELSIF current_connections > max_connections * 0.8 THEN
                alert_count := alert_count + 1;
                alert_level := '警告';
                alert_message := format('连接数告警: % / % (使用率超过80%%)',
                    current_connections, max_connections);
                RAISE NOTICE '[%] %', alert_level, alert_message;
            END IF;
        END;

        -- 告警2: 死锁告警
        DECLARE
            deadlock_count bigint;
        BEGIN
            SELECT deadlocks INTO deadlock_count
            FROM pg_stat_database
            WHERE datname = current_database();

            IF deadlock_count > 10 THEN
                alert_count := alert_count + 1;
                alert_level := '严重';
                alert_message := format('死锁告警: 检测到 % 个死锁', deadlock_count);
                RAISE WARNING '[%] %', alert_level, alert_message;
            ELSIF deadlock_count > 5 THEN
                alert_count := alert_count + 1;
                alert_level := '警告';
                alert_message := format('死锁告警: 检测到 % 个死锁', deadlock_count);
                RAISE NOTICE '[%] %', alert_level, alert_message;
            END IF;
        END;

        -- 告警3: 缓存命中率告警
        DECLARE
            cache_hit_ratio numeric;
        BEGIN
            SELECT ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2)
            INTO cache_hit_ratio
            FROM pg_stat_database
            WHERE datname = current_database();

            IF cache_hit_ratio < 80 THEN
                alert_count := alert_count + 1;
                alert_level := '警告';
                alert_message := format('缓存命中率告警: %.2f%% (建议>90%%)', cache_hit_ratio);
                RAISE NOTICE '[%] %', alert_level, alert_message;
            END IF;
        END;

        -- 告警4: 死元组告警（PostgreSQL 18）
        DECLARE
            dead_tuple_ratio numeric;
        BEGIN
            SELECT
                ROUND(100.0 * SUM(n_dead_tup) / NULLIF(SUM(n_dead_tup + n_live_tup), 0), 2)
            INTO dead_tuple_ratio
            FROM pg_stat_user_tables;

            IF dead_tuple_ratio > 20 THEN
                alert_count := alert_count + 1;
                alert_level := '严重';
                alert_message := format('死元组告警: %.2f%% (建议<10%%)', dead_tuple_ratio);
                RAISE WARNING '[%] %', alert_level, alert_message;
            ELSIF dead_tuple_ratio > 10 THEN
                alert_count := alert_count + 1;
                alert_level := '警告';
                alert_message := format('死元组告警: %.2f%% (建议<10%%)', dead_tuple_ratio);
                RAISE NOTICE '[%] %', alert_level, alert_message;
            END IF;
        END;

        -- 告警5: 锁等待告警
        DECLARE
            lock_wait_count int;
        BEGIN
            SELECT COUNT(*) INTO lock_wait_count
            FROM pg_catalog.pg_locks blocked_locks
            JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
            WHERE NOT blocked_locks.granted
            AND EXTRACT(EPOCH FROM (NOW() - blocked_activity.query_start)) > 30;  -- 等待超过30秒

            IF lock_wait_count > 0 THEN
                alert_count := alert_count + 1;
                alert_level := '严重';
                alert_message := format('锁等待告警: % 个查询等待超过30秒', lock_wait_count);
                RAISE WARNING '[%] %', alert_level, alert_message;
            END IF;
        END;

        -- 汇总告警
        RAISE NOTICE '';
        IF alert_count = 0 THEN
            RAISE NOTICE '✓ 未发现告警条件';
        ELSE
            RAISE NOTICE '共发现 % 个告警', alert_count;
        END IF;

        RAISE NOTICE '';
        RAISE NOTICE 'PostgreSQL 18自动化特性:';
        RAISE NOTICE '- 自动检测告警条件';
        RAISE NOTICE '- 自动分级告警';
        RAISE NOTICE '- 自动生成告警报告';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '自动化告警系统失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 创建告警函数

### 可重用函数版本

```sql
-- 创建自动化告警函数
CREATE OR REPLACE FUNCTION pg18_alert_check()
RETURNS TABLE(
    alert_level TEXT,
    alert_type TEXT,
    alert_message TEXT,
    alert_time TIMESTAMP
) AS $$
DECLARE
    alert_time TIMESTAMP := NOW();
    current_connections int;
    max_connections int;
    deadlock_count bigint;
    cache_hit_ratio numeric;
    dead_tuple_ratio numeric;
    lock_wait_count int;
BEGIN
    -- 告警1: 连接数告警
    SELECT COUNT(*) INTO current_connections
    FROM pg_stat_activity
    WHERE datname = current_database();

    SELECT setting::int INTO max_connections
    FROM pg_settings
    WHERE name = 'max_connections';

    IF current_connections > max_connections * 0.9 THEN
        RETURN QUERY SELECT '严重', '连接数告警',
            format('连接数: % / % (使用率超过90%%)', current_connections, max_connections),
            alert_time;
    ELSIF current_connections > max_connections * 0.8 THEN
        RETURN QUERY SELECT '警告', '连接数告警',
            format('连接数: % / % (使用率超过80%%)', current_connections, max_connections),
            alert_time;
    END IF;

    -- 告警2: 死锁告警
    SELECT deadlocks INTO deadlock_count
    FROM pg_stat_database
    WHERE datname = current_database();

    IF deadlock_count > 10 THEN
        RETURN QUERY SELECT '严重', '死锁告警',
            format('检测到 % 个死锁', deadlock_count),
            alert_time;
    ELSIF deadlock_count > 5 THEN
        RETURN QUERY SELECT '警告', '死锁告警',
            format('检测到 % 个死锁', deadlock_count),
            alert_time;
    END IF;

    -- 告警3: 缓存命中率告警
    SELECT ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2)
    INTO cache_hit_ratio
    FROM pg_stat_database
    WHERE datname = current_database();

    IF cache_hit_ratio < 80 THEN
        RETURN QUERY SELECT '警告', '缓存命中率告警',
            format('缓存命中率: %.2f%% (建议>90%%)', cache_hit_ratio),
            alert_time;
    END IF;

    -- 告警4: 死元组告警
    SELECT
        ROUND(100.0 * SUM(n_dead_tup) / NULLIF(SUM(n_dead_tup + n_live_tup), 0), 2)
    INTO dead_tuple_ratio
    FROM pg_stat_user_tables;

    IF dead_tuple_ratio > 20 THEN
        RETURN QUERY SELECT '严重', '死元组告警',
            format('死元组比例: %.2f%% (建议<10%%)', dead_tuple_ratio),
            alert_time;
    ELSIF dead_tuple_ratio > 10 THEN
        RETURN QUERY SELECT '警告', '死元组告警',
            format('死元组比例: %.2f%% (建议<10%%)', dead_tuple_ratio),
            alert_time;
    END IF;

    -- 告警5: 锁等待告警
    SELECT COUNT(*) INTO lock_wait_count
    FROM pg_catalog.pg_locks blocked_locks
    JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
    WHERE NOT blocked_locks.granted
    AND EXTRACT(EPOCH FROM (NOW() - blocked_activity.query_start)) > 30;

    IF lock_wait_count > 0 THEN
        RETURN QUERY SELECT '严重', '锁等待告警',
            format('% 个查询等待超过30秒', lock_wait_count),
            alert_time;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT * FROM pg18_alert_check();
```

---

## 告警级别说明

### 严重告警

需要立即处理的告警：

- **连接数告警**：连接数使用率超过90%
- **死锁告警**：死锁次数超过10次
- **死元组告警**：死元组比例超过20%
- **锁等待告警**：查询等待超过30秒

### 警告告警

需要关注的告警：

- **连接数告警**：连接数使用率超过80%
- **死锁告警**：死锁次数超过5次
- **缓存命中率告警**：缓存命中率低于80%
- **死元组告警**：死元组比例超过10%

---

## 告警阈值配置

### 自定义告警阈值

```sql
-- 创建告警阈值配置表
CREATE TABLE IF NOT EXISTS pg18_alert_thresholds (
    alert_type TEXT PRIMARY KEY,
    warning_threshold NUMERIC,
    critical_threshold NUMERIC,
    enabled BOOLEAN DEFAULT TRUE
);

-- 插入默认阈值
INSERT INTO pg18_alert_thresholds VALUES
    ('connection_usage', 80, 90, TRUE),
    ('deadlock_count', 5, 10, TRUE),
    ('cache_hit_ratio', 80, NULL, TRUE),
    ('dead_tuple_ratio', 10, 20, TRUE),
    ('lock_wait_seconds', 30, 60, TRUE)
ON CONFLICT (alert_type) DO NOTHING;
```

---

## 定时执行告警检查

### 使用pg_cron定时执行

```sql
-- 每5分钟执行告警检查
SELECT cron.schedule(
    'alert-check-5min',
    '*/5 * * * *',
    $$SELECT * FROM pg18_alert_check()$$
);
```

---

## 告警通知集成

### 邮件通知示例

```sql
-- 创建告警通知函数（需要配置邮件服务器）
CREATE OR REPLACE FUNCTION pg18_send_alert_email(
    alert_level TEXT,
    alert_message TEXT
)
RETURNS void AS $$
BEGIN
    -- 这里可以集成邮件发送逻辑
    -- 例如使用pg_mail扩展或其他邮件服务
    RAISE NOTICE '发送告警邮件: [%] %', alert_level, alert_message;
END;
$$ LANGUAGE plpgsql;
```

---

## PostgreSQL 18自动化特性

1. **自动检测告警条件**：自动检测各种告警条件
2. **自动分级告警**：自动分级告警（严重/警告）
3. **自动生成告警报告**：自动生成告警报告

---

## 注意事项

1. **告警频率**：合理设置告警检查频率，避免过于频繁
2. **告警阈值**：根据实际情况调整告警阈值
3. **告警通知**：配置合适的告警通知方式

---

## 相关资源

- [pg_stat_database文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW)
- [pg_locks文档](https://www.postgresql.org/docs/18/view-pg-locks.html)
- [pg_cron文档](https://github.com/citusdata/pg_cron)

---

**上一节**: [自动化性能报告](./02-自动化性能报告.md)
**返回**: [自动化运维脚本目录](./README.md)
