# 推荐做法与注意事项

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐
> **相关章节**: [故障排查流程与脚本](../09-故障排查/01-故障排查流程与脚本.md) | [自动化运维架构](../06-综合方案/01-自动化运维架构.md)

---

## 概述

本文档总结了PostgreSQL 18自动化运维与自我监测的推荐做法和注意事项，帮助用户更好地利用PostgreSQL 18的新特性实现自动化运维。

---

## ✅ 推荐做法

### 1. 启用pg_stat_statements扩展

追踪所有查询性能，利用PostgreSQL 18新增的并行查询追踪列：

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
ALTER SYSTEM SET pg_stat_statements.track = 'all';
```

### 2. 定期运行自动化检查

使用cron或pg_cron定期执行健康检查：

```sql
-- 每小时执行健康检查
SELECT cron.schedule(
    'health-check-hourly',
    '0 * * * *',
    $$SELECT * FROM pg18_health_check()$$
);
```

### 3. 监控关键指标

监控以下关键指标：

- 连接数
- 缓存命中率
- 死元组比例
- 锁等待
- I/O性能（PostgreSQL 18增强）

### 4. 利用PostgreSQL 18新特性

充分利用PostgreSQL 18的新特性：

- **pg_stat_io的read_bytes/write_bytes列**：进行I/O分析
- **pg_stat_get_backend_io()**：进行后端级别I/O追踪
- **log_connections细粒度配置**：进行连接性能分析
- **pg_stat_statements的parallel_workers_to_launch/parallel_workers_launched列**：进行并行查询分析
- **pg_stat_checkpointer的num_done列**：进行检查点分析

### 5. 启用异步I/O

在PostgreSQL 18中配置io_method和max_io_workers提升并发性能：

```sql
ALTER SYSTEM SET io_method = 'worker';
ALTER SYSTEM SET max_io_workers = 10;
ALTER SYSTEM SET maintenance_io_workers = 4;
```

### 6. NUMA架构优化

在大型服务器上编译时启用--with-libnuma，使用pg_shmem_allocations_numa监控内存分布：

```bash
./configure --with-libnuma --prefix=/usr/local/pgsql
```

### 7. 自动化运维脚本

建立完整的自动化运维脚本库：

- 健康检查脚本
- 性能报告脚本
- 告警系统脚本
- 故障恢复脚本

### 8. VACUUM优化

利用PostgreSQL 18的并行VACUUM和精细化控制参数：

```sql
ALTER SYSTEM SET autovacuum_max_workers = 6;
ALTER SYSTEM SET autovacuum_vacuum_scale_factor = 0.05;
ALTER SYSTEM SET vacuum_truncate = on;
```

### 9. EXPLAIN增强

使用PostgreSQL 18的EXPLAIN增强功能进行即时性能诊断：

```sql
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS, TIMING)
SELECT /* 查询语句 */;
```

### 10. SET语句追踪

利用参数化SET语句追踪减少pg_stat_statements膨胀：

PostgreSQL 18自动将SET语句参数化，减少统计信息膨胀。

### 11. 升级优化

使用pg_upgrade的统计信息保留和并行检查功能：

```bash
pg_upgrade --old-bindir=/usr/local/pgsql17/bin \
           --new-bindir=/usr/local/pgsql18/bin \
           --old-datadir=/data/pgsql17 \
           --new-datadir=/data/pgsql18 \
           --check
```

### 12. 客户端工具

利用psql的管道查询和\conninfo命令提升运维效率：

```bash
# 管道查询
psql -d mydb -c "SELECT * FROM users" | grep "admin"

# \conninfo命令
\conninfo
```

---

## ⚠️ 注意事项

### 1. 不要过度监控

监控本身也会消耗资源，合理设置监控频率：

- 健康检查：每小时或每30分钟
- 性能报告：每天
- 告警检查：每5-15分钟

### 2. 定期清理统计信息

使用pg_stat_statements_reset()定期清理，避免统计信息表过大：

```sql
-- 每周清理一次
SELECT pg_stat_statements_reset();
```

### 3. 备份监控数据

重要监控数据需要备份，便于历史趋势分析：

```sql
-- 创建监控数据备份表
CREATE TABLE pg18_monitoring_history AS
SELECT * FROM pg18_performance_benchmark();
```

### 4. 测试告警系统

确保告警系统正常工作，避免误报和漏报：

- 定期测试告警触发
- 验证告警通知
- 调整告警阈值

### 5. 异步I/O配置

异步I/O需要系统支持：

- **io_uring**：需要Linux 5.1+内核
- **worker**：PostgreSQL 18默认支持

### 6. NUMA编译

NUMA支持需要在编译时启用，运行时无法动态启用：

```bash
./configure --with-libnuma
```

### 7. 并行查询监控

并行查询追踪会增加pg_stat_statements的开销，合理设置max参数：

```sql
ALTER SYSTEM SET pg_stat_statements.max = 10000;
```

### 8. 连接日志

细粒度连接日志会增加日志量，注意日志轮转和存储空间：

```ini
# postgresql.conf
log_connections = on
log_rotation_age = 1d
log_rotation_size = 100MB
```

### 9. EXPLAIN性能

EXPLAIN ANALYZE会实际执行查询，注意对生产环境的影响：

- 避免在高负载时执行EXPLAIN ANALYZE
- 使用EXPLAIN（不包含ANALYZE）进行计划分析

### 10. pg_upgrade使用

--swap选项会直接交换目录，确保有足够的备份：

```bash
# 使用--swap前确保有完整备份
pg_basebackup -D /backup/pgsql18 -Ft -z -P
```

### 11. SET语句追踪

参数化SET语句追踪可能影响某些监控工具，需要测试兼容性：

- 测试监控工具是否支持参数化SET语句
- 必要时调整监控工具配置

### 12. psql管道查询

管道查询需要注意输出格式，可能影响脚本解析：

```bash
# 使用格式化输出
psql -d mydb -c "SELECT * FROM users" --csv | grep "admin"
```

---

## 快速开始检查清单

**PostgreSQL 18自动化运维快速开始检查清单**：

- [ ] 启用pg_stat_statements扩展
- [ ] 配置PostgreSQL 18异步I/O（io_method, max_io_workers）
- [ ] 优化autovacuum配置（利用PostgreSQL 18新特性）
- [ ] 配置log_connections细粒度日志
- [ ] 创建自动化健康检查函数
- [ ] 设置自动化性能基准测试
- [ ] 配置自动化告警系统
- [ ] 使用pg_cron调度自动化任务
- [ ] 建立监控数据历史记录
- [ ] 定期审查和优化配置

---

## PostgreSQL 18核心价值

PostgreSQL 18通过自身技术栈实现了完全自动化运维和自我监测，核心价值包括：

1. **零外部依赖**：完全基于PostgreSQL内置功能，无需第三方工具
2. **实时监测**：利用pg_stat_*视图实现实时性能监测
3. **自动优化**：autovacuum、autoanalyze自动维护数据库健康
4. **智能诊断**：EXPLAIN增强提供即时性能诊断和优化建议
5. **性能提升**：异步I/O、NUMA支持等新特性显著提升性能

---

## 关键成功因素

实现PostgreSQL 18完全自动化运维的关键成功因素：

| 因素 | 说明 | PostgreSQL 18优势 |
|------|------|------------------|
| **配置优化** | 合理的autovacuum和参数配置 | 异步I/O支持更激进的配置 |
| **监控完善** | 全面的性能监控和告警 | pg_stat_io增强、后端I/O追踪 |
| **自动化脚本** | 完善的自动化运维脚本 | 利用PostgreSQL 18新特性 |
| **定期维护** | 定期执行健康检查和优化 | pg_cron调度自动化任务 |
| **持续改进** | 根据监控数据持续优化 | 性能基准测试和趋势分析 |

---

## 相关资源

- [PostgreSQL 18官方文档](https://www.postgresql.org/docs/18/)
- [PostgreSQL 18 Release Notes](https://www.postgresql.org/docs/18/release-18.html)
- [pg_stat_statements文档](https://www.postgresql.org/docs/18/pgstatstatements.html)
- [监控与诊断深度应用指南](../../12-监控与诊断/监控与诊断深度应用指南.md)

---

**上一节**: [故障排查流程与脚本](../09-故障排查/01-故障排查流程与脚本.md)
**返回**: [最佳实践目录](./README.md)
