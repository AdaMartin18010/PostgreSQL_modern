# PostgreSQL 18监控仪表板设计

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐
> **相关章节**: [自动化性能报告](../05-自动化运维脚本/02-自动化性能报告.md) | [Prometheus-Grafana集成](./02-Prometheus-Grafana集成.md)

---

## 概述

PostgreSQL 18监控仪表板基于内置视图设计，提供数据库概览、性能指标、I/O性能、查询性能等关键指标的实时监控。

---

## 监控仪表板视图

### 基础监控仪表板视图

```sql
-- PostgreSQL 18 监控仪表板视图（带错误处理和性能测试）
CREATE OR REPLACE VIEW pg18_monitoring_dashboard AS
SELECT
    '数据库概览' AS category,
    '数据库大小' AS metric_name,
    pg_size_pretty(pg_database_size(current_database())) AS metric_value,
    'normal' AS status
UNION ALL
SELECT
    '数据库概览',
    '活跃连接数',
    COUNT(*)::text,
    CASE
        WHEN COUNT(*) > (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') * 0.8 THEN 'warning'
        ELSE 'normal'
    END
FROM pg_stat_activity
WHERE datname = current_database() AND state = 'active'
UNION ALL
SELECT
    '性能指标',
    '缓存命中率(%)',
    ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2)::text,
    CASE
        WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) >= 95 THEN 'normal'
        WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) >= 90 THEN 'warning'
        ELSE 'critical'
    END
FROM pg_stat_database
WHERE datname = current_database()
UNION ALL
SELECT
    '性能指标',
    '事务提交率(%)',
    ROUND(100.0 * xact_commit / NULLIF(xact_commit + xact_rollback, 0), 2)::text,
    CASE
        WHEN ROUND(100.0 * xact_commit / NULLIF(xact_commit + xact_rollback, 0), 2) >= 99 THEN 'normal'
        WHEN ROUND(100.0 * xact_commit / NULLIF(xact_commit + xact_rollback, 0), 2) >= 95 THEN 'warning'
        ELSE 'critical'
    END
FROM pg_stat_database
WHERE datname = current_database()
UNION ALL
SELECT
    'I/O性能',
    'I/O总吞吐量(GB)',
    CASE
        WHEN (SELECT current_setting('server_version_num')::int) >= 180000 THEN
            ROUND(SUM(read_bytes + write_bytes)::numeric / 1024 / 1024 / 1024, 2)::text
        ELSE 'N/A'
    END,
    'normal'
FROM pg_stat_io
WHERE (SELECT current_setting('server_version_num')::int) >= 180000
UNION ALL
SELECT
    '查询性能',
    '慢查询数',
    COUNT(*)::text,
    CASE
        WHEN COUNT(*) = 0 THEN 'normal'
        WHEN COUNT(*) <= 5 THEN 'warning'
        ELSE 'critical'
    END
FROM pg_stat_statements
WHERE mean_exec_time > 1000
AND EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements');

-- 使用示例
SELECT * FROM pg18_monitoring_dashboard ORDER BY category, metric_name;
```

---

## 实时监控查询模板

### 实时监控函数

```sql
-- PostgreSQL 18 实时监控查询模板库
CREATE OR REPLACE FUNCTION pg18_realtime_monitoring(monitoring_type TEXT DEFAULT 'overview')
RETURNS TABLE(
    metric_category TEXT,
    metric_name TEXT,
    metric_value TEXT,
    metric_unit TEXT,
    status TEXT,
    recommendation TEXT
) AS $$
DECLARE
    pg_version int;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    IF pg_version < 180000 THEN
        RAISE WARNING 'PostgreSQL 18实时监控需要PostgreSQL 18+';
        RETURN;
    END IF;

    CASE monitoring_type
        WHEN 'overview' THEN
            -- 概览监控
            RETURN QUERY
            SELECT
                '数据库概览'::TEXT,
                '数据库大小'::TEXT,
                pg_size_pretty(pg_database_size(current_database()))::TEXT,
                ''::TEXT,
                'normal'::TEXT,
                ''::TEXT
            UNION ALL
            SELECT
                '数据库概览',
                '活跃连接',
                COUNT(*)::TEXT,
                '个',
                CASE WHEN COUNT(*) > 100 THEN 'warning' ELSE 'normal' END,
                CASE WHEN COUNT(*) > 100 THEN '建议检查连接池配置' ELSE '' END
            FROM pg_stat_activity
            WHERE datname = current_database() AND state = 'active';

        WHEN 'performance' THEN
            -- 性能监控
            RETURN QUERY
            SELECT
                '性能指标',
                '缓存命中率',
                ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2)::TEXT || '%',
                '%',
                CASE
                    WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) >= 95 THEN 'normal'
                    WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) >= 90 THEN 'warning'
                    ELSE 'critical'
                END,
                CASE
                    WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) < 90 THEN '建议增加shared_buffers'
                    ELSE ''
                END
            FROM pg_stat_database
            WHERE datname = current_database();

        WHEN 'io' THEN
            -- I/O监控（PostgreSQL 18增强）
            RETURN QUERY
            SELECT
                'I/O性能',
                '读取吞吐量',
                ROUND(SUM(read_bytes)::numeric / 1024 / 1024 / 1024, 2)::TEXT || ' GB',
                'GB',
                'normal',
                ''
            FROM pg_stat_io
            UNION ALL
            SELECT
                'I/O性能',
                '写入吞吐量',
                ROUND(SUM(write_bytes)::numeric / 1024 / 1024 / 1024, 2)::TEXT || ' GB',
                'GB',
                'normal',
                ''
            FROM pg_stat_io;

        WHEN 'queries' THEN
            -- 查询监控（PostgreSQL 18增强）
            IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
                RETURN QUERY
                SELECT
                    '查询性能',
                    '慢查询数',
                    COUNT(*)::TEXT,
                    '个',
                    CASE WHEN COUNT(*) > 10 THEN 'warning' ELSE 'normal' END,
                    CASE WHEN COUNT(*) > 10 THEN '建议优化慢查询' ELSE '' END
                FROM pg_stat_statements
                WHERE mean_exec_time > 1000
                UNION ALL
                SELECT
                    '查询性能',
                    '并行查询平均效率',
                    ROUND(AVG(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0)), 2)::TEXT || '%',
                    '%',
                    CASE
                        WHEN AVG(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0)) >= 90 THEN 'normal'
                        WHEN AVG(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0)) >= 80 THEN 'warning'
                        ELSE 'critical'
                    END,
                    CASE
                        WHEN AVG(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0)) < 80 THEN '建议检查并行查询配置'
                        ELSE ''
                    END
                FROM pg_stat_statements
                WHERE parallel_workers_to_launch > 0;
            END IF;

        ELSE
            RAISE WARNING '未知的监控类型: %', monitoring_type;
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT * FROM pg18_realtime_monitoring('overview');
SELECT * FROM pg18_realtime_monitoring('performance');
SELECT * FROM pg18_realtime_monitoring('io');
SELECT * FROM pg18_realtime_monitoring('queries');
```

---

## 监控指标说明

### 数据库概览

- **数据库大小**：当前数据库大小
- **活跃连接数**：当前活跃连接数

### 性能指标

- **缓存命中率**：缓冲区命中率（≥95%优秀）
- **事务提交率**：事务提交率（≥99%优秀）

### I/O性能（PostgreSQL 18增强）

- **I/O总吞吐量**：使用pg_stat_io的read_bytes/write_bytes
- **读取/写入吞吐量**：分别统计读取和写入吞吐量

### 查询性能（PostgreSQL 18增强）

- **慢查询数**：平均执行时间超过1秒的查询数
- **并行查询平均效率**：使用pg_stat_statements的并行查询追踪列

---

## 状态说明

### 状态类型

- **normal**：正常状态
- **warning**：警告状态
- **critical**：严重状态

### 状态判断标准

- **缓存命中率**：≥95%正常，≥90%警告，<90%严重
- **事务提交率**：≥99%正常，≥95%警告，<95%严重
- **连接数**：<80%正常，≥80%警告
- **慢查询数**：0个正常，≤5个警告，>5个严重

---

## PostgreSQL 18增强特性

1. **I/O统计增强**：使用pg_stat_io的字节级别统计
2. **并行查询追踪**：使用pg_stat_statements的并行查询列
3. **更详细的监控**：提供更全面的性能监控

---

## 注意事项

1. **性能影响**：监控查询本身会有轻微性能影响
2. **查询频率**：合理设置查询频率
3. **数据保留**：考虑监控数据的保留策略

---

## 相关资源

- [pg_stat_database文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW)
- [pg_stat_io文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW)
- [pg_stat_statements文档](https://www.postgresql.org/docs/18/pgstatstatements.html)

---

**上一节**: [自动化性能报告](../05-自动化运维脚本/02-自动化性能报告.md)
**下一节**: [Prometheus-Grafana集成](./02-Prometheus-Grafana集成.md)
**返回**: [监控仪表板目录](./README.md)
