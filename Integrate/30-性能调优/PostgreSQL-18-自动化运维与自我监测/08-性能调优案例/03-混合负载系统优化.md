# 案例3: 混合负载系统动态优化

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐⭐⭐
> **相关章节**: [数据仓库OLAP系统优化](./02-数据仓库OLAP系统优化.md) | [故障排查流程](../09-故障排查/01-故障排查流程与脚本.md)

---

## 业务场景

- **系统类型**：SaaS平台（OLTP + OLAP混合）
- **特点**：工作时间OLTP，夜间批处理OLAP
- **数据库版本**：PostgreSQL 18
- **问题**：需要根据负载动态调整配置

---

## 动态优化方案

### PostgreSQL 18动态参数调优函数

```sql
-- PostgreSQL 18动态参数调优函数
CREATE OR REPLACE FUNCTION pg18_dynamic_workload_optimization()
RETURNS void AS $$
DECLARE
    current_hour int;
    current_load text;
    active_connections int;
    io_intensive boolean;
    cpu_intensive boolean;
BEGIN
    current_hour := EXTRACT(HOUR FROM NOW());
    SELECT COUNT(*) INTO active_connections FROM pg_stat_activity WHERE state = 'active';

    -- 判断负载类型
    SELECT SUM(reads + writes) > 1000000 INTO io_intensive FROM pg_stat_io;
    SELECT COUNT(*) > 5 INTO cpu_intensive FROM pg_stat_activity WHERE wait_event_type = 'CPU';

    -- 工作时间（9-18点）：OLTP模式
    IF current_hour >= 9 AND current_hour < 18 THEN
        current_load := 'OLTP';

        -- OLTP优化配置
        PERFORM set_config('work_mem', '4MB', false);
        PERFORM set_config('max_parallel_workers_per_gather', '2', false);
        PERFORM set_config('effective_io_concurrency', '200', false);
        PERFORM set_config('maintenance_work_mem', '1GB', false);

        RAISE NOTICE '切换到OLTP模式: work_mem=4MB, max_parallel_workers_per_gather=2';

    -- 非工作时间：OLAP模式
    ELSE
        current_load := 'OLAP';

        -- OLAP优化配置
        PERFORM set_config('work_mem', '64MB', false);
        PERFORM set_config('max_parallel_workers_per_gather', '8', false);
        PERFORM set_config('effective_io_concurrency', '300', false);
        PERFORM set_config('maintenance_work_mem', '4GB', false);

        RAISE NOTICE '切换到OLAP模式: work_mem=64MB, max_parallel_workers_per_gather=8';
    END IF;

    -- 根据实际负载微调
    IF io_intensive THEN
        PERFORM set_config('effective_io_concurrency', '400', false);
        RAISE NOTICE '检测到I/O密集型负载，增加effective_io_concurrency';
    END IF;

    IF cpu_intensive THEN
        PERFORM set_config('max_parallel_workers_per_gather',
            LEAST(8, (SELECT setting::int FROM pg_settings WHERE name = 'max_parallel_workers'))::text,
            false);
        RAISE NOTICE '检测到CPU密集型负载，增加并行度';
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 使用pg_cron定时执行（每小时）
SELECT cron.schedule(
    'dynamic-workload-optimization',
    '0 * * * *',
    $$SELECT pg18_dynamic_workload_optimization()$$
);
```

---

## 优化效果

| 时间段 | 模式 | 平均响应时间 | QPS | 资源利用率 |
|--------|------|-------------|-----|-----------|
| 工作时间 | OLTP | 50ms | 1000+ | CPU: 60%, I/O: 40% |
| 夜间批处理 | OLAP | 5分钟 | 10 | CPU: 85%, I/O: 70% |

---

## 关键优化点

1. **动态调优**：根据时间自动切换OLTP/OLAP模式
2. **工作内存**：OLTP模式使用较小work_mem，OLAP模式使用较大work_mem
3. **并行度**：OLTP模式较低并行度，OLAP模式较高并行度
4. **I/O并发**：根据负载类型调整effective_io_concurrency
5. **负载感知**：根据实际负载（I/O密集型/CPU密集型）微调配置

---

## PostgreSQL 18特性应用

1. **I/O统计增强**：使用pg_stat_io判断I/O密集型负载
2. **动态配置**：使用set_config动态调整参数
3. **定时调度**：使用pg_cron定时执行动态调优

---

## 注意事项

1. **配置切换**：动态配置切换需要谨慎，避免频繁切换
2. **监控**：持续监控动态调优效果
3. **测试**：在生产环境前充分测试动态调优逻辑

---

## 相关资源

- [应用场景案例](../06-综合方案/04-应用场景案例.md)
- [异步I/O文档](../02-自动化性能调优/01-异步I-O支持.md)
- [自动参数调优文档](../02-自动化性能调优/05-自动参数调优.md)

---

**上一节**: [数据仓库OLAP系统优化](./02-数据仓库OLAP系统优化.md)
**返回**: [性能调优案例目录](./README.md)
