# 8.3 æ¡ˆä¾‹3: æ··åˆè´Ÿè½½ç³»ç»ŸåŠ¨æ€ä¼˜åŒ–

> **æ‰€å±žä¸»é¢˜**: 08-æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹
> **ç« èŠ‚ç¼–å·**: 8.3
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **PostgreSQLç‰ˆæœ¬**: 18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­â­
> **ç›¸å…³ç« èŠ‚**: [8.2 æ•°æ®ä»“åº“OLAPç³»ç»Ÿä¼˜åŒ–](./02-æ•°æ®ä»“åº“OLAPç³»ç»Ÿä¼˜åŒ–.md) | [9.1 æ•…éšœæŽ’æŸ¥æµç¨‹](../09-æ•…éšœæŽ’æŸ¥/01-æ•…éšœæŽ’æŸ¥æµç¨‹ä¸Žè„šæœ¬.md)

---

## ðŸ“‹ ç›®å½•

- [8.3 æ¡ˆä¾‹3: æ··åˆè´Ÿè½½ç³»ç»ŸåŠ¨æ€ä¼˜åŒ–](#83-æ¡ˆä¾‹3-æ··åˆè´Ÿè½½ç³»ç»ŸåŠ¨æ€ä¼˜åŒ–)
  - [ðŸ“‹ ç›®å½•](#-ç›®å½•)
  - [8.3.1 ä¸šåŠ¡åœºæ™¯](#831-ä¸šåŠ¡åœºæ™¯)
  - [8.3.2 åŠ¨æ€ä¼˜åŒ–æ–¹æ¡ˆ](#832-åŠ¨æ€ä¼˜åŒ–æ–¹æ¡ˆ)
    - [8.3.2.1 PostgreSQL 18åŠ¨æ€å‚æ•°è°ƒä¼˜å‡½æ•°](#8321-postgresql-18åŠ¨æ€å‚æ•°è°ƒä¼˜å‡½æ•°)
  - [8.3.3 ä¼˜åŒ–æ•ˆæžœ](#833-ä¼˜åŒ–æ•ˆæžœ)
  - [8.3.4 ç»éªŒæ€»ç»“](#834-ç»éªŒæ€»ç»“)
    - [8.3.4.1 å…³é”®ä¼˜åŒ–ç‚¹](#8341-å…³é”®ä¼˜åŒ–ç‚¹)
    - [8.3.4.2 PostgreSQL 18ç‰¹æ€§åº”ç”¨](#8342-postgresql-18ç‰¹æ€§åº”ç”¨)
    - [8.3.4.3 æœ€ä½³å®žè·µ](#8343-æœ€ä½³å®žè·µ)
    - [8.3.4.4 æ³¨æ„äº‹é¡¹](#8344-æ³¨æ„äº‹é¡¹)
  - [8.3.5 å¯¼èˆª](#835-å¯¼èˆª)
    - [8.3.5.1 ç« èŠ‚å¯¼èˆª](#8351-ç« èŠ‚å¯¼èˆª)
    - [8.3.5.2 ç›¸å…³ç« èŠ‚](#8352-ç›¸å…³ç« èŠ‚)
  - [ðŸ“š ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

---

## 8.3.1 ä¸šåŠ¡åœºæ™¯

- **ç³»ç»Ÿç±»åž‹**ï¼šSaaSå¹³å°ï¼ˆOLTP + OLAPæ··åˆï¼‰
- **ç‰¹ç‚¹**ï¼šå·¥ä½œæ—¶é—´OLTPï¼Œå¤œé—´æ‰¹å¤„ç†OLAP
- **æ•°æ®åº“ç‰ˆæœ¬**ï¼šPostgreSQL 18
- **é—®é¢˜**ï¼šéœ€è¦æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´é…ç½®

---

## 8.3.2 åŠ¨æ€ä¼˜åŒ–æ–¹æ¡ˆ

### 8.3.2.1 PostgreSQL 18åŠ¨æ€å‚æ•°è°ƒä¼˜å‡½æ•°

```sql
-- PostgreSQL 18åŠ¨æ€å‚æ•°è°ƒä¼˜å‡½æ•°
CREATE OR REPLACE FUNCTION pg18_dynamic_workload_optimization()
RETURNS void AS $$
DECLARE
    current_hour int;
    current_load text;
    active_connections int;
    io_intensive boolean;
    cpu_intensive boolean;
BEGIN
    current_hour := EXTRACT(HOUR FROM NOW());
    SELECT COUNT(*) INTO active_connections FROM pg_stat_activity WHERE state = 'active';

    -- åˆ¤æ–­è´Ÿè½½ç±»åž‹
    SELECT SUM(reads + writes) > 1000000 INTO io_intensive FROM pg_stat_io;
    SELECT COUNT(*) > 5 INTO cpu_intensive FROM pg_stat_activity WHERE wait_event_type = 'CPU';

    -- å·¥ä½œæ—¶é—´ï¼ˆ9-18ç‚¹ï¼‰ï¼šOLTPæ¨¡å¼
    IF current_hour >= 9 AND current_hour < 18 THEN
        current_load := 'OLTP';

        -- OLTPä¼˜åŒ–é…ç½®
        PERFORM set_config('work_mem', '4MB', false);
        PERFORM set_config('max_parallel_workers_per_gather', '2', false);
        PERFORM set_config('effective_io_concurrency', '200', false);
        PERFORM set_config('maintenance_work_mem', '1GB', false);

        RAISE NOTICE 'åˆ‡æ¢åˆ°OLTPæ¨¡å¼: work_mem=4MB, max_parallel_workers_per_gather=2';

    -- éžå·¥ä½œæ—¶é—´ï¼šOLAPæ¨¡å¼
    ELSE
        current_load := 'OLAP';

        -- OLAPä¼˜åŒ–é…ç½®
        PERFORM set_config('work_mem', '64MB', false);
        PERFORM set_config('max_parallel_workers_per_gather', '8', false);
        PERFORM set_config('effective_io_concurrency', '300', false);
        PERFORM set_config('maintenance_work_mem', '4GB', false);

        RAISE NOTICE 'åˆ‡æ¢åˆ°OLAPæ¨¡å¼: work_mem=64MB, max_parallel_workers_per_gather=8';
    END IF;

    -- æ ¹æ®å®žé™…è´Ÿè½½å¾®è°ƒ
    IF io_intensive THEN
        PERFORM set_config('effective_io_concurrency', '400', false);
        RAISE NOTICE 'æ£€æµ‹åˆ°I/Oå¯†é›†åž‹è´Ÿè½½ï¼Œå¢žåŠ effective_io_concurrency';
    END IF;

    IF cpu_intensive THEN
        PERFORM set_config('max_parallel_workers_per_gather',
            LEAST(8, (SELECT setting::int FROM pg_settings WHERE name = 'max_parallel_workers'))::text,
            false);
        RAISE NOTICE 'æ£€æµ‹åˆ°CPUå¯†é›†åž‹è´Ÿè½½ï¼Œå¢žåŠ å¹¶è¡Œåº¦';
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨pg_cronå®šæ—¶æ‰§è¡Œï¼ˆæ¯å°æ—¶ï¼‰
SELECT cron.schedule(
    'dynamic-workload-optimization',
    '0 * * * *',
    $$SELECT pg18_dynamic_workload_optimization()$$
);
```

---

## 8.3.3 ä¼˜åŒ–æ•ˆæžœ

| æ—¶é—´æ®µ | æ¨¡å¼ | å¹³å‡å“åº”æ—¶é—´ | QPS | èµ„æºåˆ©ç”¨çŽ‡ |
|--------|------|-------------|-----|-----------|
| å·¥ä½œæ—¶é—´ | OLTP | 50ms | 1000+ | CPU: 60%, I/O: 40% |
| å¤œé—´æ‰¹å¤„ç† | OLAP | 5åˆ†é’Ÿ | 10 | CPU: 85%, I/O: 70% |

---

## 8.3.4 ç»éªŒæ€»ç»“

### 8.3.4.1 å…³é”®ä¼˜åŒ–ç‚¹

1. **åŠ¨æ€è°ƒä¼˜**ï¼šæ ¹æ®æ—¶é—´è‡ªåŠ¨åˆ‡æ¢OLTP/OLAPæ¨¡å¼
2. **å·¥ä½œå†…å­˜**ï¼šOLTPæ¨¡å¼ä½¿ç”¨è¾ƒå°work_memï¼ŒOLAPæ¨¡å¼ä½¿ç”¨è¾ƒå¤§work_mem
3. **å¹¶è¡Œåº¦**ï¼šOLTPæ¨¡å¼è¾ƒä½Žå¹¶è¡Œåº¦ï¼ŒOLAPæ¨¡å¼è¾ƒé«˜å¹¶è¡Œåº¦
4. **I/Oå¹¶å‘**ï¼šæ ¹æ®è´Ÿè½½ç±»åž‹è°ƒæ•´effective_io_concurrency
5. **è´Ÿè½½æ„ŸçŸ¥**ï¼šæ ¹æ®å®žé™…è´Ÿè½½ï¼ˆI/Oå¯†é›†åž‹/CPUå¯†é›†åž‹ï¼‰å¾®è°ƒé…ç½®

### 8.3.4.2 PostgreSQL 18ç‰¹æ€§åº”ç”¨

1. **I/Oç»Ÿè®¡å¢žå¼º**ï¼šä½¿ç”¨pg_stat_ioåˆ¤æ–­I/Oå¯†é›†åž‹è´Ÿè½½
2. **åŠ¨æ€é…ç½®**ï¼šä½¿ç”¨set_configåŠ¨æ€è°ƒæ•´å‚æ•°
3. **å®šæ—¶è°ƒåº¦**ï¼šä½¿ç”¨pg_cronå®šæ—¶æ‰§è¡ŒåŠ¨æ€è°ƒä¼˜

### 8.3.4.3 æœ€ä½³å®žè·µ

âœ… **æŽ¨èåšæ³•**ï¼š

- æ··åˆè´Ÿè½½ç³»ç»Ÿéœ€è¦åŠ¨æ€è°ƒä¼˜ç­–ç•¥
- æ ¹æ®ä¸šåŠ¡æ—¶é—´è§„å¾‹è‡ªåŠ¨åˆ‡æ¢é…ç½®æ¨¡å¼
- æŒç»­ç›‘æŽ§è°ƒä¼˜æ•ˆæžœï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥
- å……åˆ†æµ‹è¯•åŠ¨æ€è°ƒä¼˜é€»è¾‘åŽå†åº”ç”¨åˆ°ç”Ÿäº§çŽ¯å¢ƒ

### 8.3.4.4 æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. **é…ç½®åˆ‡æ¢**ï¼šåŠ¨æ€é…ç½®åˆ‡æ¢éœ€è¦è°¨æ…Žï¼Œé¿å…é¢‘ç¹åˆ‡æ¢
2. **ç›‘æŽ§**ï¼šæŒç»­ç›‘æŽ§åŠ¨æ€è°ƒä¼˜æ•ˆæžœ
3. **æµ‹è¯•**ï¼šåœ¨ç”Ÿäº§çŽ¯å¢ƒå‰å……åˆ†æµ‹è¯•åŠ¨æ€è°ƒä¼˜é€»è¾‘

---

## 8.3.5 å¯¼èˆª

### 8.3.5.1 ç« èŠ‚å¯¼èˆª

- **ä¸Šä¸€èŠ‚**ï¼š[8.2 æ•°æ®ä»“åº“OLAPç³»ç»Ÿä¼˜åŒ–](./02-æ•°æ®ä»“åº“OLAPç³»ç»Ÿä¼˜åŒ–.md)
- **ä¸‹ä¸€èŠ‚**ï¼šæ— ï¼ˆæœ¬ç« ä¸º08-æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹çš„æœ€åŽä¸€èŠ‚ï¼‰
- **è¿”å›žä¸»é¢˜ç›®å½•**ï¼š[08-æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹](./README.md)
- **è¿”å›žä¸»æ–‡æ¡£**ï¼š[PostgreSQL-18-è‡ªåŠ¨åŒ–è¿ç»´ä¸Žè‡ªæˆ‘ç›‘æµ‹](../README.md)

### 8.3.5.2 ç›¸å…³ç« èŠ‚

- [6.4 åº”ç”¨åœºæ™¯æ¡ˆä¾‹](../06-ç»¼åˆæ–¹æ¡ˆ/04-åº”ç”¨åœºæ™¯æ¡ˆä¾‹.md) - æ··åˆè´Ÿè½½åœºæ™¯é…ç½®
- [2.5 è‡ªåŠ¨å‚æ•°è°ƒä¼˜](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/05-è‡ªåŠ¨å‚æ•°è°ƒä¼˜.md) - è‡ªåŠ¨å‚æ•°è°ƒä¼˜
- [9.1 æ•…éšœæŽ’æŸ¥æµç¨‹](../09-æ•…éšœæŽ’æŸ¥/01-æ•…éšœæŽ’æŸ¥æµç¨‹ä¸Žè„šæœ¬.md) - æ•…éšœæŽ’æŸ¥

---

## ðŸ“š ç›¸å…³èµ„æº

- [åº”ç”¨åœºæ™¯æ¡ˆä¾‹](../06-ç»¼åˆæ–¹æ¡ˆ/04-åº”ç”¨åœºæ™¯æ¡ˆä¾‹.md)
- [å¼‚æ­¥I/Oæ–‡æ¡£](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/01-å¼‚æ­¥I-Oæ”¯æŒ.md)
- [è‡ªåŠ¨å‚æ•°è°ƒä¼˜æ–‡æ¡£](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/05-è‡ªåŠ¨å‚æ•°è°ƒä¼˜.md)
- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](../../PostgreSQLæ€§èƒ½è°ƒä¼˜å®Œæ•´æŒ‡å—.md)

---

**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆå·²æ·»åŠ å®Œæ•´ç›®å½•ã€ç« èŠ‚ç¼–å·ã€è¯¦ç»†å†…å®¹ï¼‰
