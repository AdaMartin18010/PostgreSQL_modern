# 3.2 后端I/O追踪

> **所属主题**: 03-自我监测系统
> **章节编号**: 3.2
> **创建日期**: 2025年1月
> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐

---

## 📋 目录

- [3.2 后端I/O追踪](#32-后端io追踪)
  - [📋 目录](#-目录)
  - [3.2.1 概述与背景](#321-概述与背景)
    - [3.2.1.1 什么是后端I/O追踪](#3211-什么是后端io追踪)
    - [3.2.1.2 问题背景](#3212-问题背景)
    - [3.2.1.3 PostgreSQL 18特性](#3213-postgresql-18特性)
  - [3.2.2 后端I/O追踪原理](#322-后端io追踪原理)
    - [3.2.2.1 追踪流程](#3221-追踪流程)
  - [3.2.3 使用决策树](#323-使用决策树)
    - [3.2.3.1 后端I/O追踪使用决策树](#3231-后端io追踪使用决策树)
    - [3.2.3.2 追踪决策论证](#3232-追踪决策论证)
  - [3.2.4 pg\_stat\_get\_backend\_io()函数](#324-pg_stat_get_backend_io函数)
    - [3.2.4.1 函数说明](#3241-函数说明)
  - [3.2.5 使用示例与实践](#325-使用示例与实践)
  - [3.2.6 重置后端统计](#326-重置后端统计)
    - [3.2.6.1 重置函数说明](#3261-重置函数说明)
    - [3.2.6.2 使用示例](#3262-使用示例)
  - [3.2.7 性能优势与论证](#327-性能优势与论证)
    - [3.2.7.1 性能优势分析](#3271-性能优势分析)
    - [3.2.7.2 性能优势论证](#3272-性能优势论证)
  - [3.2.8 注意事项与最佳实践](#328-注意事项与最佳实践)
    - [3.2.8.1 注意事项](#3281-注意事项)
    - [3.2.8.2 最佳实践](#3282-最佳实践)
    - [3.2.8.3 故障排查](#3283-故障排查)
  - [3.2.9 导航](#329-导航)
    - [3.2.9.1 章节导航](#3291-章节导航)
    - [3.2.9.2 相关章节](#3292-相关章节)
  - [📚 参考资料](#-参考资料)

---

## 3.2.1 概述与背景

### 3.2.1.1 什么是后端I/O追踪

PostgreSQL 18新增`pg_stat_get_backend_io()`函数，支持后端级别的I/O追踪，可以查看单个后端的I/O统计信息，便于定位慢查询的I/O瓶颈。

### 3.2.1.2 问题背景

**I/O问题诊断的挑战**：

- ❌ 只能看到全局I/O统计，无法定位具体后端
- ❌ 难以识别哪个查询导致I/O瓶颈
- ❌ 无法分析单个后端的I/O模式

**PostgreSQL 18的解决方案**：

- ✅ 后端级别的I/O追踪
- ✅ 可以查看单个后端的I/O统计
- ✅ 便于定位慢查询的I/O瓶颈

### 3.2.1.3 PostgreSQL 18特性

1. **pg_stat_get_backend_io()**：获取指定后端的I/O统计
2. **pg_stat_reset_backend_stats()**：重置后端统计
3. **后端级别分析**：支持后端级别的I/O性能分析

---

## 3.2.2 后端I/O追踪原理

### 3.2.2.1 追踪流程

```
┌─────────────────────────────────────────────────────────┐
│          PostgreSQL 18 后端I/O追踪流程                    │
└─────────────────────────────────────────────────────────┘

后端进程执行I/O操作
    │
    ├─→ 记录I/O统计
    │   ├─→ 后端PID
    │   ├─→ I/O操作类型
    │   ├─→ I/O操作次数
    │   └─→ I/O操作字节数
    │
    ├─→ 存储后端统计
    │   └─→ 每个后端独立的统计信息
    │
    └─→ 查询统计信息
        └─→ pg_stat_get_backend_io(pid)
```

---

## 3.2.3 使用决策树

### 3.2.3.1 后端I/O追踪使用决策树

```
开始：是否需要后端I/O追踪？
│
├─→ 是否有慢查询问题？
│   ├─→ [是] ✅ 需要后端I/O追踪
│   │   └─→ 理由：需要定位慢查询的I/O瓶颈
│   │
│   └─→ [否] 继续
│
├─→ 是否需要分析特定后端的I/O模式？
│   ├─→ [是] ✅ 需要后端I/O追踪
│   │   └─→ 理由：需要分析后端I/O模式
│   │
│   └─→ [否] ⚠️  可选追踪
│
└─→ 最终决策
    └─→ 根据需求决定是否使用后端I/O追踪
```

### 3.2.3.2 追踪决策论证

**论证：为什么需要后端I/O追踪？**

```
前提条件：
P1: 慢查询可能由I/O瓶颈导致
P2: 全局I/O统计无法定位具体后端
P3: PostgreSQL 18提供后端级别I/O追踪

推理过程：
R1: 如果P1，则需要定位I/O瓶颈
R2: 如果P2，则无法定位具体后端
R3: 如果P3，则可以定位具体后端的I/O瓶颈

结论：
C1: 应该使用后端I/O追踪功能
C2: 可以定位慢查询的I/O瓶颈
C3: 可以优化慢查询性能
```

---

## 3.2.4 pg_stat_get_backend_io()函数

### 3.2.4.1 函数说明

**函数签名**：

```sql
pg_stat_get_backend_io(pid integer) RETURNS record
```

**功能**：获取指定后端的I/O统计信息

**参数**：

- `pid`：后端进程ID

**返回值**：包含I/O统计信息的记录

---

## 3.2.5 使用示例与实践

```sql
-- PostgreSQL 18 后端I/O追踪（带错误处理和性能测试）
DO $$
DECLARE
    backend_io RECORD;
BEGIN
    BEGIN
        -- 检查PostgreSQL版本
        IF (SELECT current_setting('server_version_num')::int) < 180000 THEN
            RAISE WARNING 'pg_stat_get_backend_io()函数需要PostgreSQL 18+';
            RETURN;
        END IF;

        RAISE NOTICE '=== PostgreSQL 18后端I/O追踪 ===';
        RAISE NOTICE '活跃后端I/O统计（PostgreSQL 18新增）:';
        RAISE NOTICE '';

        -- 查询活跃后端的I/O统计
        FOR backend_io IN
            SELECT
                pid,
                usename,
                application_name,
                state,
                wait_event_type,
                wait_event,
                pg_stat_get_backend_io(pid) AS io_stats
            FROM pg_stat_activity
            WHERE pid != pg_backend_pid()
            AND state = 'active'
            ORDER BY pid
            LIMIT 10
        LOOP
            RAISE NOTICE '后端PID: % | 用户: % | 应用: %',
                backend_io.pid, backend_io.usename, backend_io.application_name;
            RAISE NOTICE '  状态: % | 等待事件: % / %',
                backend_io.state, backend_io.wait_event_type, backend_io.wait_event;
            RAISE NOTICE '  I/O统计: %', backend_io.io_stats;
            RAISE NOTICE '';
        END LOOP;

        RAISE NOTICE 'PostgreSQL 18新增特性:';
        RAISE NOTICE '- pg_stat_get_backend_io(): 获取单个后端的I/O统计';
        RAISE NOTICE '- pg_stat_reset_backend_stats(): 重置后端统计';
        RAISE NOTICE '- 支持后端级别的I/O性能分析';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '后端I/O追踪失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3.2.6 重置后端统计

### 3.2.6.1 重置函数说明

PostgreSQL 18新增`pg_stat_reset_backend_stats()`函数，可以重置指定后端的统计信息：

**函数签名**：

```sql
pg_stat_reset_backend_stats(pid integer) RETURNS void
```

**功能**：重置指定后端的统计信息

### 3.2.6.2 使用示例

```sql
-- 重置特定后端的统计信息（带错误处理）
DO $$
BEGIN
    BEGIN
        -- 检查PostgreSQL版本
        IF (SELECT current_setting('server_version_num')::int) < 180000 THEN
            RAISE WARNING 'pg_stat_reset_backend_stats()函数需要PostgreSQL 18+';
            RETURN;
        END IF;

        -- 检查进程是否存在（示例PID: 12345）
        IF EXISTS (SELECT 1 FROM pg_stat_activity WHERE pid = 12345) THEN
            PERFORM pg_stat_reset_backend_stats(12345);
            RAISE NOTICE '已重置后端PID 12345的统计信息';
        ELSE
            RAISE WARNING '后端PID 12345不存在';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '重置后端统计信息失败: %', SQLERRM;
            RAISE;
    END;
END $$;

-- 重置所有后端的统计信息（谨慎使用，带错误处理）
DO $$
DECLARE
    backend_pid INTEGER;
    reset_count INTEGER := 0;
BEGIN
    BEGIN
        -- 检查PostgreSQL版本
        IF (SELECT current_setting('server_version_num')::int) < 180000 THEN
            RAISE WARNING 'pg_stat_reset_backend_stats()函数需要PostgreSQL 18+';
            RETURN;
        END IF;

        -- 重置所有后端的统计信息（排除当前连接）
        FOR backend_pid IN
            SELECT pid
            FROM pg_stat_activity
            WHERE pid != pg_backend_pid()
        LOOP
            BEGIN
                PERFORM pg_stat_reset_backend_stats(backend_pid);
                reset_count := reset_count + 1;
            EXCEPTION
                WHEN OTHERS THEN
                    RAISE WARNING '重置后端PID %的统计信息失败: %', backend_pid, SQLERRM;
            END;
        END LOOP;

        RAISE NOTICE '已重置 % 个后端的统计信息', reset_count;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING '批量重置后端统计信息失败: %', SQLERRM;
            RAISE;
    END;
END $$;
```

---

## 3.2.7 性能优势与论证

### 3.2.7.1 性能优势分析

| 优势项 | 说明 | 价值 |
|--------|------|------|
| **后端级别追踪** | 可以查看单个后端的I/O统计 | 精确定位I/O瓶颈 |
| **慢查询诊断** | 便于定位慢查询的I/O瓶颈 | 快速诊断问题 |
| **性能优化** | 可以针对性地优化慢查询 | 提升查询性能 |

### 3.2.7.2 性能优势论证

**论证：后端I/O追踪提升诊断效率**

```
前提条件：
P1: 慢查询可能由I/O瓶颈导致
P2: 全局I/O统计无法定位具体后端
P3: 后端I/O追踪可以定位具体后端

推理过程：
R1: 如果P1，则需要定位I/O瓶颈
R2: 如果P2，则诊断效率低
R3: 如果P3，则可以快速定位问题

结论：
C1: 后端I/O追踪可以提升诊断效率
C2: 可以快速定位慢查询的I/O瓶颈
C3: 可以针对性优化，提升性能
```

---

## 3.2.8 注意事项与最佳实践

### 3.2.8.1 注意事项

⚠️ **重要提醒**：

1. **版本要求**：需要PostgreSQL 18+

   ```sql
   -- 检查PostgreSQL版本（带错误处理）
   DO $$
   BEGIN
       BEGIN
           IF (SELECT current_setting('server_version_num')::int) < 180000 THEN
               RAISE WARNING '后端I/O追踪需要PostgreSQL 18+，当前版本: %',
                   current_setting('server_version');
               RETURN;
           END IF;
           RAISE NOTICE 'PostgreSQL版本检查通过: %', current_setting('server_version');
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING '版本检查失败: %', SQLERRM;
               RAISE;
       END;
   END $$;
   ```

2. **权限要求**：需要超级用户权限或监控权限

3. **统计重置**：后端断开连接后统计信息会重置

### 3.2.8.2 最佳实践

✅ **推荐做法**：

1. **定期查询**：定期查询活跃后端的I/O统计

   ```sql
   -- 定期查询活跃后端的I/O统计（带错误处理和性能测试）
   DO $$
   DECLARE
       backend_io RECORD;
       active_count INTEGER := 0;
   BEGIN
       BEGIN
           -- 检查PostgreSQL版本
           IF (SELECT current_setting('server_version_num')::int) < 180000 THEN
               RAISE WARNING 'pg_stat_get_backend_io()函数需要PostgreSQL 18+';
               RETURN;
           END IF;

           RAISE NOTICE '=== 活跃后端I/O统计（定期监控） ===';
           RAISE NOTICE '';

           -- 查询活跃后端的I/O统计
           FOR backend_io IN
               SELECT
                   pid,
                   usename,
                   application_name,
                   state,
                   wait_event_type,
                   wait_event,
                   pg_stat_get_backend_io(pid) AS io_stats
               FROM pg_stat_activity
               WHERE pid != pg_backend_pid()
               AND state = 'active'
               ORDER BY pid
               LIMIT 20
           LOOP
               active_count := active_count + 1;
               RAISE NOTICE '后端PID: % | 用户: % | 应用: %',
                   backend_io.pid, backend_io.usename, backend_io.application_name;
               RAISE NOTICE '  状态: % | 等待事件: % / %',
                   backend_io.state, backend_io.wait_event_type, backend_io.wait_event;
               RAISE NOTICE '  I/O统计: %', backend_io.io_stats;
               RAISE NOTICE '';
           END LOOP;

           RAISE NOTICE '活跃后端总数: %', active_count;

           -- 性能测试：查询执行计划
           RAISE NOTICE '=== 性能测试：查询执行计划 ===';
           PERFORM *
           FROM (
               EXPLAIN (ANALYZE, BUFFERS, TIMING)
               SELECT
                   pid,
                   usename,
                   application_name,
                   state,
                   pg_stat_get_backend_io(pid) AS io_stats
               FROM pg_stat_activity
               WHERE pid != pg_backend_pid()
               AND state = 'active'
               ORDER BY pid
               LIMIT 20
           ) AS explain_result;
       EXCEPTION
           WHEN OTHERS THEN
               RAISE WARNING '定期I/O统计查询失败: %', SQLERRM;
               RAISE;
       END;
   END $$;
   ```

2. **慢查询分析**：结合慢查询检测，分析I/O瓶颈

3. **趋势分析**：记录历史数据，分析I/O趋势

### 3.2.8.3 故障排查

🔧 **常见问题**：

1. **函数不存在**
   - 检查PostgreSQL版本（需要18+）
   - 检查函数名拼写

2. **统计信息为空**
   - 检查后端是否执行了I/O操作
   - 检查后端是否已断开连接

---

## 3.2.9 导航

### 3.2.9.1 章节导航

- **上一节**：[3.1 pg_stat_io增强监控](./01-pg_stat_io增强监控.md)
- **下一节**：[3.3 连接性能监测](./03-连接性能监测.md)
- **返回主题目录**：[03-自我监测系统](./README.md)
- **返回主文档**：[PostgreSQL-18-自动化运维与自我监测](../README.md)

### 3.2.9.2 相关章节

- [3.1 pg_stat_io增强监控](./01-pg_stat_io增强监控.md) - 全局I/O监控
- [3.3 连接性能监测](./03-连接性能监测.md) - 连接监测
- [4.1 自动慢查询检测](../04-自动化诊断/01-自动慢查询检测.md) - 慢查询诊断

---

## 📚 参考资料

- [PostgreSQL 18 后端统计文档](https://www.postgresql.org/docs/18/monitoring-stats.html)
- [PostgreSQL性能调优指南](../../PostgreSQL性能调优完整指南.md)

---

**最后更新**: 2025年1月
**文档版本**: v2.0（已添加决策树、推理论证、完整目录）
