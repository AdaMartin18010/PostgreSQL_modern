# 01-è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„

> **æ‰€å±ä¸»é¢˜**: 06-ç»¼åˆæ–¹æ¡ˆ
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **PostgreSQLç‰ˆæœ¬**: 18+

---

## ğŸ“‹ ç›®å½•

- [01-è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„](#01-è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
  - [è‡ªåŠ¨åŒ–è¿ç»´å®ç°](#è‡ªåŠ¨åŒ–è¿ç»´å®ç°)
  - [è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ](#è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ)
  - [å¯¼èˆª](#å¯¼èˆª)

---

## æ¦‚è¿°

PostgreSQL 18é€šè¿‡è‡ªèº«æŠ€æœ¯æ ˆå®ç°å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨å·¥å…·ã€‚æœ¬ç« èŠ‚ä»‹ç»è‡ªåŠ¨åŒ–è¿ç»´çš„æ¶æ„è®¾è®¡å’Œå®ç°æ–¹æ¡ˆã€‚

---

## æ¶æ„è®¾è®¡

PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„ï¼š

```mermaid
flowchart TD
    A[PostgreSQL 18æ•°æ®åº“] --> B[è‡ªåŠ¨åŒ–è¿ç»´å±‚]
    B --> C[è‡ªåŠ¨å‚æ•°è°ƒä¼˜]
    B --> D[è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–]
    B --> E[è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°]
    B --> F[è‡ªåŠ¨VACUUMä¼˜åŒ–]

    A --> G[è‡ªæˆ‘ç›‘æµ‹å±‚]
    G --> H[pg_stat_ioç›‘æ§]
    G --> I[pg_stat_activityç›‘æ§]
    G --> J[pg_stat_statementsç›‘æ§]
    G --> K[EXPLAINè¯Šæ–­]

    H --> L[è‡ªåŠ¨åŒ–è¯Šæ–­]
    I --> L
    J --> L
    K --> L

    L --> M[è‡ªåŠ¨åŒ–å‘Šè­¦]
    M --> N[è‡ªåŠ¨åŒ–ä¿®å¤]

    C --> O[æ€§èƒ½ä¼˜åŒ–]
    D --> O
    E --> O
    F --> O
    N --> O

    style A fill:#FFD700
    style B fill:#90EE90
    style G fill:#87CEEB
    style L fill:#FFA500
    style O fill:#FF6B6B
```

---

## è‡ªåŠ¨åŒ–è¿ç»´å®ç°

**PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬**ï¼š

```sql
-- PostgreSQL 18 å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION pg18_auto_operations()
RETURNS TABLE(
    operation_type TEXT,
    operation_status TEXT,
    operation_details TEXT,
    operation_time TIMESTAMP
) AS $$
DECLARE
    op_type TEXT;
    op_status TEXT;
    op_details TEXT;
    op_time TIMESTAMP := NOW();
BEGIN
    -- 1. è‡ªåŠ¨å‚æ•°è°ƒä¼˜
    BEGIN
        op_type := 'å‚æ•°è°ƒä¼˜';
        op_status := 'æˆåŠŸ';
        op_details := 'åŸºäºå·¥ä½œè´Ÿè½½è‡ªåŠ¨è°ƒæ•´å‚æ•°';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 2. è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–
    BEGIN
        op_type := 'ç´¢å¼•ä¼˜åŒ–';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨è¯†åˆ«ç¼ºå¤±ç´¢å¼•';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 3. è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
    BEGIN
        op_type := 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 4. è‡ªåŠ¨VACUUMä¼˜åŒ–
    BEGIN
        op_type := 'VACUUMä¼˜åŒ–';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨VACUUMä¼˜åŒ–';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 5. è‡ªåŠ¨æ€§èƒ½è¯Šæ–­
    BEGIN
        op_type := 'æ€§èƒ½è¯Šæ–­';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨æ€§èƒ½è¯Šæ–­';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM pg18_auto_operations();
```

---

## è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ

**PostgreSQL 18è‡ªæˆ‘ç›‘æµ‹ç»¼åˆè„šæœ¬**ï¼š

```sql
-- PostgreSQL 18 è‡ªæˆ‘ç›‘æµ‹ç»¼åˆç³»ç»Ÿ
CREATE OR REPLACE FUNCTION pg18_self_monitoring()
RETURNS TABLE(
    metric_name TEXT,
    metric_value TEXT,
    metric_status TEXT,
    metric_timestamp TIMESTAMP
) AS $$
DECLARE
    metric_name TEXT;
    metric_value TEXT;
    metric_status TEXT;
    metric_timestamp TIMESTAMP := NOW();
    pg_version int;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    -- I/Oæ€§èƒ½ç›‘æµ‹ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
    IF pg_version >= 180000 THEN
        SELECT
            'I/Oæ€»ååé‡',
            ROUND(SUM(read_bytes + write_bytes)::numeric / 1024 / 1024 / 1024, 2)::TEXT || ' GB',
            CASE WHEN SUM(reads + writes) > 1000000 THEN 'è­¦å‘Š' ELSE 'æ­£å¸¸' END
        INTO metric_name, metric_value, metric_status
        FROM pg_stat_io
        WHERE reads > 0 OR writes > 0;

        RETURN QUERY SELECT metric_name, metric_value, metric_status, metric_timestamp;
    END IF;

    -- è¿æ¥æ€§èƒ½ç›‘æµ‹
    SELECT
        'è¿æ¥æ•°',
        COUNT(*)::TEXT || ' / ' || (SELECT setting FROM pg_settings WHERE name = 'max_connections'),
        CASE WHEN COUNT(*) > (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') * 0.8 THEN 'è­¦å‘Š' ELSE 'æ­£å¸¸' END
    INTO metric_name, metric_value, metric_status
    FROM pg_stat_activity
    WHERE datname = current_database();

    RETURN QUERY SELECT metric_name, metric_value, metric_status, metric_timestamp;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM pg18_self_monitoring();
```

---

## å¯¼èˆª

- [è¿”å›ä¸»é¢˜ç›®å½•](./README.md)
- [è¿”å›ä¸»æ–‡æ¡£](../README.md)
- [ä¸‹ä¸€èŠ‚ï¼š02-Autovacuumé…ç½®](./02-Autovacuumé…ç½®.md)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
