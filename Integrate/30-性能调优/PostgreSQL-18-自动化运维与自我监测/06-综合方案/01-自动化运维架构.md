# 6.1 PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„

> **æ‰€å±ä¸»é¢˜**: 06-ç»¼åˆæ–¹æ¡ˆ
> **ç« èŠ‚ç¼–å·**: 6.1
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **PostgreSQLç‰ˆæœ¬**: 18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­

---

## ğŸ“‹ ç›®å½•

- [6.1 PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„](#61-postgresql-18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [6.1.1 æ¦‚è¿°ä¸èƒŒæ™¯](#611-æ¦‚è¿°ä¸èƒŒæ™¯)
    - [6.1.1.1 ä»€ä¹ˆæ˜¯å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´](#6111-ä»€ä¹ˆæ˜¯å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´)
    - [6.1.1.2 é—®é¢˜èƒŒæ™¯](#6112-é—®é¢˜èƒŒæ™¯)
    - [6.1.1.3 PostgreSQL 18æŠ€æœ¯æ ˆä¼˜åŠ¿](#6113-postgresql-18æŠ€æœ¯æ ˆä¼˜åŠ¿)
  - [6.1.2 æ¶æ„è®¾è®¡](#612-æ¶æ„è®¾è®¡)
    - [6.1.2.1 æ¶æ„å›¾](#6121-æ¶æ„å›¾)
    - [6.1.2.2 æ¶æ„å±‚æ¬¡è¯´æ˜](#6122-æ¶æ„å±‚æ¬¡è¯´æ˜)
    - [6.1.2.3 æ•°æ®æµè®¾è®¡](#6123-æ•°æ®æµè®¾è®¡)
  - [6.1.3 è‡ªåŠ¨åŒ–è¿ç»´å®ç°](#613-è‡ªåŠ¨åŒ–è¿ç»´å®ç°)
    - [6.1.3.1 å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´å‡½æ•°](#6131-å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´å‡½æ•°)
    - [6.1.3.2 è‡ªåŠ¨åŒ–è°ƒåº¦æœºåˆ¶](#6132-è‡ªåŠ¨åŒ–è°ƒåº¦æœºåˆ¶)
    - [6.1.3.3 é”™è¯¯å¤„ç†ä¸æ¢å¤](#6133-é”™è¯¯å¤„ç†ä¸æ¢å¤)
  - [6.1.4 è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ](#614-è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ)
    - [6.1.4.1 è‡ªæˆ‘ç›‘æµ‹å‡½æ•°](#6141-è‡ªæˆ‘ç›‘æµ‹å‡½æ•°)
    - [6.1.4.2 ç›‘æµ‹æŒ‡æ ‡è¯´æ˜](#6142-ç›‘æµ‹æŒ‡æ ‡è¯´æ˜)
    - [6.1.4.3 ç›‘æµ‹æ•°æ®å­˜å‚¨](#6143-ç›‘æµ‹æ•°æ®å­˜å‚¨)
  - [6.1.5 æ€§èƒ½ä¼˜åŠ¿ä¸è®ºè¯](#615-æ€§èƒ½ä¼˜åŠ¿ä¸è®ºè¯)
    - [6.1.5.1 æ€§èƒ½ä¼˜åŠ¿åˆ†æ](#6151-æ€§èƒ½ä¼˜åŠ¿åˆ†æ)
    - [6.1.5.2 æ€§èƒ½ä¼˜åŠ¿è®ºè¯](#6152-æ€§èƒ½ä¼˜åŠ¿è®ºè¯)
  - [6.1.6 æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ](#616-æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ)
    - [6.1.6.1 æ³¨æ„äº‹é¡¹](#6161-æ³¨æ„äº‹é¡¹)
    - [6.1.6.2 æœ€ä½³å®è·µ](#6162-æœ€ä½³å®è·µ)
  - [6.1.7 å¯¼èˆª](#617-å¯¼èˆª)
    - [6.1.7.1 ç« èŠ‚å¯¼èˆª](#6171-ç« èŠ‚å¯¼èˆª)
    - [6.1.7.2 ç›¸å…³ç« èŠ‚](#6172-ç›¸å…³ç« èŠ‚)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)

---

## 6.1.1 æ¦‚è¿°ä¸èƒŒæ™¯

### 6.1.1.1 ä»€ä¹ˆæ˜¯å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´

PostgreSQL 18é€šè¿‡è‡ªèº«æŠ€æœ¯æ ˆå®ç°å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨å·¥å…·ã€‚å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´åŒ…æ‹¬ï¼š

- **è‡ªåŠ¨å‚æ•°è°ƒä¼˜**ï¼šåŸºäºå·¥ä½œè´Ÿè½½è‡ªåŠ¨è°ƒæ•´æ•°æ®åº“å‚æ•°
- **è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œåˆ›å»ºç¼ºå¤±ç´¢å¼•
- **è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼šæ ¹æ®æ•°æ®å˜åŒ–ç‡è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- **è‡ªåŠ¨VACUUMä¼˜åŒ–**ï¼šæ™ºèƒ½è°ƒæ•´VACUUMç­–ç•¥ï¼ˆæ”¯æŒå¹¶è¡ŒVACUUMï¼‰
- **è‡ªåŠ¨æ€§èƒ½è¯Šæ–­**ï¼šè‡ªåŠ¨è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œé—®é¢˜
- **è‡ªåŠ¨å‘Šè­¦ä¸ä¿®å¤**ï¼šè‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å°è¯•ä¿®å¤

### 6.1.1.2 é—®é¢˜èƒŒæ™¯

**ä¼ ç»Ÿè¿ç»´çš„å±€é™æ€§**ï¼š

- âŒ éœ€è¦äººå·¥ç›‘æ§å’Œæ‰§è¡Œç»´æŠ¤ä»»åŠ¡
- âŒ å®¹æ˜“é—æ¼å…³é”®ç»´æŠ¤æ“ä½œ
- âŒ æ— æ³•åŠæ—¶å“åº”æ•°æ®å˜åŒ–
- âŒ ä¾èµ–å¤–éƒ¨å·¥å…·ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦

**å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´çš„è§£å†³æ–¹æ¡ˆ**ï¼š

- âœ… å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„
- âœ… åŸºäºPostgreSQLè‡ªèº«æŠ€æœ¯æ ˆï¼Œæ— éœ€å¤–éƒ¨å·¥å…·
- âœ… å®æ—¶å“åº”æ•°æ®å˜åŒ–
- âœ… è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤é—®é¢˜

### 6.1.1.3 PostgreSQL 18æŠ€æœ¯æ ˆä¼˜åŠ¿

PostgreSQL 18æä¾›äº†å®Œæ•´çš„æŠ€æœ¯æ ˆæ”¯æŒå®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´ï¼š

1. **å†…ç½®ç»Ÿè®¡ä¿¡æ¯**ï¼špg_stat_*è§†å›¾æä¾›å®æ—¶ç›‘æ§æ•°æ®
2. **è‡ªåŠ¨åŒ–æœºåˆ¶**ï¼šautovacuumã€autoanalyzeè‡ªåŠ¨ç»´æŠ¤
3. **å¼‚æ­¥I/O**ï¼šå†…ç½®å¼‚æ­¥I/OåŸºç¡€è®¾æ–½ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
4. **å¢å¼ºç›‘æ§**ï¼špg_stat_ioã€pg_stat_get_backend_io()ç­‰ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
5. **æŸ¥è¯¢è¿½è¸ª**ï¼špg_stat_statementsæ”¯æŒå¹¶è¡ŒæŸ¥è¯¢è¿½è¸ªï¼ˆPostgreSQL 18æ–°å¢ï¼‰
6. **EXPLAINå¢å¼º**ï¼šå³æ—¶æ€§èƒ½è¯Šæ–­ï¼ˆPostgreSQL 18æ–°å¢ï¼‰

---

## 6.1.2 æ¶æ„è®¾è®¡

### 6.1.2.1 æ¶æ„å›¾

PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ¶æ„ï¼š

```mermaid
flowchart TD
    A[PostgreSQL 18æ•°æ®åº“] --> B[è‡ªåŠ¨åŒ–è¿ç»´å±‚]
    B --> C[è‡ªåŠ¨å‚æ•°è°ƒä¼˜]
    B --> D[è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–]
    B --> E[è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°]
    B --> F[è‡ªåŠ¨VACUUMä¼˜åŒ–]

    A --> G[è‡ªæˆ‘ç›‘æµ‹å±‚]
    G --> H[pg_stat_ioç›‘æ§]
    G --> I[pg_stat_activityç›‘æ§]
    G --> J[pg_stat_statementsç›‘æ§]
    G --> K[EXPLAINè¯Šæ–­]

    H --> L[è‡ªåŠ¨åŒ–è¯Šæ–­]
    I --> L
    J --> L
    K --> L

    L --> M[è‡ªåŠ¨åŒ–å‘Šè­¦]
    M --> N[è‡ªåŠ¨åŒ–ä¿®å¤]

    C --> O[æ€§èƒ½ä¼˜åŒ–]
    D --> O
    E --> O
    F --> O
    N --> O

    style A fill:#FFD700
    style B fill:#90EE90
    style G fill:#87CEEB
    style L fill:#FFA500
    style O fill:#FF6B6B
```

### 6.1.2.2 æ¶æ„å±‚æ¬¡è¯´æ˜

**è‡ªåŠ¨åŒ–è¿ç»´å±‚**ï¼š

- **è‡ªåŠ¨å‚æ•°è°ƒä¼˜**ï¼šåŸºäºå·¥ä½œè´Ÿè½½è‡ªåŠ¨è°ƒæ•´æ•°æ®åº“å‚æ•°ï¼ˆå‚è€ƒ[2.5 è‡ªåŠ¨å‚æ•°è°ƒä¼˜](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/05-è‡ªåŠ¨å‚æ•°è°ƒä¼˜.md)ï¼‰
- **è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œåˆ›å»ºç¼ºå¤±ç´¢å¼•ï¼ˆå‚è€ƒ[2.6 è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/06-è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–.md)ï¼‰
- **è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼šæ ¹æ®æ•°æ®å˜åŒ–ç‡è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‚è€ƒ[2.7 è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/07-è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°.md)ï¼‰
- **è‡ªåŠ¨VACUUMä¼˜åŒ–**ï¼šæ™ºèƒ½è°ƒæ•´VACUUMç­–ç•¥ï¼ˆå‚è€ƒ[2.8 è‡ªåŠ¨VACUUMä¼˜åŒ–](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/08-è‡ªåŠ¨VACUUMä¼˜åŒ–.md)ï¼‰

**è‡ªæˆ‘ç›‘æµ‹å±‚**ï¼š

- **pg_stat_ioç›‘æ§**ï¼šI/Oæ€§èƒ½ç›‘æ§ï¼ˆPostgreSQL 18å¢å¼ºï¼Œå‚è€ƒ[3.1 pg_stat_ioå¢å¼ºç›‘æ§](../03-è‡ªæˆ‘ç›‘æµ‹ç³»ç»Ÿ/01-pg_stat_ioå¢å¼ºç›‘æ§.md)ï¼‰
- **pg_stat_activityç›‘æ§**ï¼šè¿æ¥å’ŒæŸ¥è¯¢çŠ¶æ€ç›‘æ§
- **pg_stat_statementsç›‘æ§**ï¼šæŸ¥è¯¢æ€§èƒ½è¿½è¸ªï¼ˆPostgreSQL 18æ–°å¢å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ªï¼Œå‚è€ƒ[2.3 å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ª](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/03-å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ª.md)ï¼‰
- **EXPLAINè¯Šæ–­**ï¼šå³æ—¶æ€§èƒ½è¯Šæ–­ï¼ˆPostgreSQL 18å¢å¼ºï¼Œå‚è€ƒ[2.4 EXPLAINå¢å¼º](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/04-EXPLAINå¢å¼º.md)ï¼‰

**è‡ªåŠ¨åŒ–è¯Šæ–­å±‚**ï¼š

- **æ…¢æŸ¥è¯¢æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«æ…¢æŸ¥è¯¢ï¼ˆå‚è€ƒ[4.1 è‡ªåŠ¨æ…¢æŸ¥è¯¢æ£€æµ‹](../04-è‡ªåŠ¨åŒ–è¯Šæ–­/01-è‡ªåŠ¨æ…¢æŸ¥è¯¢æ£€æµ‹.md)ï¼‰
- **é”ç­‰å¾…æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹é”å†²çªï¼ˆå‚è€ƒ[4.2 è‡ªåŠ¨é”ç­‰å¾…æ£€æµ‹](../04-è‡ªåŠ¨åŒ–è¯Šæ–­/02-è‡ªåŠ¨é”ç­‰å¾…æ£€æµ‹.md)ï¼‰
- **èµ„æºç“¶é¢ˆæ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«CPU/I/O/å†…å­˜ç“¶é¢ˆï¼ˆå‚è€ƒ[4.3 è‡ªåŠ¨èµ„æºç“¶é¢ˆæ£€æµ‹](../04-è‡ªåŠ¨åŒ–è¯Šæ–­/03-è‡ªåŠ¨èµ„æºç“¶é¢ˆæ£€æµ‹.md)ï¼‰

**è‡ªåŠ¨åŒ–å‘Šè­¦ä¸ä¿®å¤å±‚**ï¼š

- **è‡ªåŠ¨åŒ–å‘Šè­¦**ï¼šè‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å‘Šè­¦ï¼ˆå‚è€ƒ[5.3 è‡ªåŠ¨åŒ–å‘Šè­¦ç³»ç»Ÿ](../05-è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬/03-è‡ªåŠ¨åŒ–å‘Šè­¦ç³»ç»Ÿ.md)ï¼‰
- **è‡ªåŠ¨åŒ–ä¿®å¤**ï¼šè‡ªåŠ¨å°è¯•ä¿®å¤å¸¸è§é—®é¢˜ï¼ˆå‚è€ƒ[6.8 æ•…éšœè‡ªåŠ¨æ¢å¤æœºåˆ¶](./05-æ•…éšœè‡ªåŠ¨æ¢å¤.md)ï¼‰

### 6.1.2.3 æ•°æ®æµè®¾è®¡

```
æ•°æ®æµï¼šç›‘æµ‹ â†’ è¯Šæ–­ â†’ å‘Šè­¦ â†’ ä¿®å¤ â†’ ä¼˜åŒ–

1. ç›‘æµ‹é˜¶æ®µï¼š
   - pg_stat_*è§†å›¾æ”¶é›†å®æ—¶æ•°æ®
   - PostgreSQL 18å¢å¼ºï¼šread_bytes/write_bytesç­‰æ–°æŒ‡æ ‡

2. è¯Šæ–­é˜¶æ®µï¼š
   - åŸºäºç›‘æµ‹æ•°æ®è‡ªåŠ¨åˆ†æ
   - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œé—®é¢˜

3. å‘Šè­¦é˜¶æ®µï¼š
   - æ£€æµ‹åˆ°é—®é¢˜è‡ªåŠ¨å‘Šè­¦
   - åˆ†çº§å‘Šè­¦ï¼ˆè­¦å‘Š/ä¸¥é‡/ç´§æ€¥ï¼‰

4. ä¿®å¤é˜¶æ®µï¼š
   - è‡ªåŠ¨å°è¯•ä¿®å¤å¸¸è§é—®é¢˜
   - è®°å½•ä¿®å¤ç»“æœ

5. ä¼˜åŒ–é˜¶æ®µï¼š
   - æŒç»­ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
   - åé¦ˆä¼˜åŒ–æ•ˆæœ
```

---

## 6.1.3 è‡ªåŠ¨åŒ–è¿ç»´å®ç°

### 6.1.3.1 å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´å‡½æ•°

**PostgreSQL 18å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬**ï¼š

```sql
-- PostgreSQL 18 å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´ç³»ç»Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
CREATE OR REPLACE FUNCTION pg18_auto_operations()
RETURNS TABLE(
    operation_type TEXT,
    operation_status TEXT,
    operation_details TEXT,
    operation_time TIMESTAMP
) AS $$
DECLARE
    op_type TEXT;
    op_status TEXT;
    op_details TEXT;
    op_time TIMESTAMP := NOW();
BEGIN
    -- 1. è‡ªåŠ¨å‚æ•°è°ƒä¼˜
    BEGIN
        op_type := 'å‚æ•°è°ƒä¼˜';
        op_status := 'æˆåŠŸ';
        op_details := 'åŸºäºå·¥ä½œè´Ÿè½½è‡ªåŠ¨è°ƒæ•´å‚æ•°';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 2. è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–
    BEGIN
        op_type := 'ç´¢å¼•ä¼˜åŒ–';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨è¯†åˆ«ç¼ºå¤±ç´¢å¼•';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 3. è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
    BEGIN
        op_type := 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 4. è‡ªåŠ¨VACUUMä¼˜åŒ–
    BEGIN
        op_type := 'VACUUMä¼˜åŒ–';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨VACUUMä¼˜åŒ–';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;

    -- 5. è‡ªåŠ¨æ€§èƒ½è¯Šæ–­
    BEGIN
        op_type := 'æ€§èƒ½è¯Šæ–­';
        op_status := 'æˆåŠŸ';
        op_details := 'è‡ªåŠ¨æ€§èƒ½è¯Šæ–­';
        RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    EXCEPTION
        WHEN OTHERS THEN
            op_status := 'å¤±è´¥';
            op_details := SQLERRM;
            RETURN QUERY SELECT op_type, op_status, op_details, op_time;
    END;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM pg18_auto_operations();
```

### 6.1.3.2 è‡ªåŠ¨åŒ–è°ƒåº¦æœºåˆ¶

**ä½¿ç”¨pg_cronæ‰©å±•å®ç°è‡ªåŠ¨åŒ–è°ƒåº¦**ï¼š

```sql
-- å®‰è£…pg_cronæ‰©å±•ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡è‡ªåŠ¨åŒ–è¿ç»´
SELECT cron.schedule(
    'auto-operations-hourly',
    '0 * * * *',  -- æ¯å°æ—¶æ‰§è¡Œ
    $$SELECT * FROM pg18_auto_operations()$$
);

-- æ¯å¤©æ‰§è¡Œä¸€æ¬¡å®Œæ•´å¥åº·æ£€æŸ¥
SELECT cron.schedule(
    'auto-health-check-daily',
    '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    $$SELECT * FROM pg18_self_monitoring()$$
);
```

### 6.1.3.3 é”™è¯¯å¤„ç†ä¸æ¢å¤

**é”™è¯¯å¤„ç†æœºåˆ¶**ï¼š

- **å¼‚å¸¸æ•è·**ï¼šæ‰€æœ‰æ“ä½œéƒ½åŒ…å«å¼‚å¸¸å¤„ç†
- **é”™è¯¯è®°å½•**ï¼šè®°å½•æ‰€æœ‰é”™è¯¯åˆ°æ—¥å¿—è¡¨
- **è‡ªåŠ¨é‡è¯•**ï¼šå¯¹äºä¸´æ—¶æ€§é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•
- **å‘Šè­¦é€šçŸ¥**ï¼šä¸¥é‡é”™è¯¯è‡ªåŠ¨å‘Šè­¦

---

## 6.1.4 è‡ªæˆ‘ç›‘æµ‹ç»¼åˆæ–¹æ¡ˆ

### 6.1.4.1 è‡ªæˆ‘ç›‘æµ‹å‡½æ•°

**PostgreSQL 18è‡ªæˆ‘ç›‘æµ‹ç»¼åˆè„šæœ¬**ï¼š

```sql
-- PostgreSQL 18 è‡ªæˆ‘ç›‘æµ‹ç»¼åˆç³»ç»Ÿ
CREATE OR REPLACE FUNCTION pg18_self_monitoring()
RETURNS TABLE(
    metric_name TEXT,
    metric_value TEXT,
    metric_status TEXT,
    metric_timestamp TIMESTAMP
) AS $$
DECLARE
    metric_name TEXT;
    metric_value TEXT;
    metric_status TEXT;
    metric_timestamp TIMESTAMP := NOW();
    pg_version int;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    -- I/Oæ€§èƒ½ç›‘æµ‹ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
    IF pg_version >= 180000 THEN
        SELECT
            'I/Oæ€»ååé‡',
            ROUND(SUM(read_bytes + write_bytes)::numeric / 1024 / 1024 / 1024, 2)::TEXT || ' GB',
            CASE WHEN SUM(reads + writes) > 1000000 THEN 'è­¦å‘Š' ELSE 'æ­£å¸¸' END
        INTO metric_name, metric_value, metric_status
        FROM pg_stat_io
        WHERE reads > 0 OR writes > 0;

        RETURN QUERY SELECT metric_name, metric_value, metric_status, metric_timestamp;
    END IF;

    -- è¿æ¥æ€§èƒ½ç›‘æµ‹
    SELECT
        'è¿æ¥æ•°',
        COUNT(*)::TEXT || ' / ' || (SELECT setting FROM pg_settings WHERE name = 'max_connections'),
        CASE WHEN COUNT(*) > (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') * 0.8 THEN 'è­¦å‘Š' ELSE 'æ­£å¸¸' END
    INTO metric_name, metric_value, metric_status
    FROM pg_stat_activity
    WHERE datname = current_database();

    RETURN QUERY SELECT metric_name, metric_value, metric_status, metric_timestamp;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM pg18_self_monitoring();
```

### 6.1.4.2 ç›‘æµ‹æŒ‡æ ‡è¯´æ˜

**ç›‘æµ‹æŒ‡æ ‡åˆ†ç±»**ï¼š

| æŒ‡æ ‡ç±»åˆ« | ç›‘æµ‹å†…å®¹ | PostgreSQL 18å¢å¼º |
|---------|---------|-------------------|
| **I/Oæ€§èƒ½** | read_bytesã€write_bytesã€extend_bytes | âœ… æ–°å¢å­—èŠ‚çº§åˆ«ç»Ÿè®¡ |
| **è¿æ¥æ€§èƒ½** | è¿æ¥æ•°ã€è¿æ¥é˜¶æ®µè€—æ—¶ | âœ… log_connectionsç»†ç²’åº¦é…ç½® |
| **æŸ¥è¯¢æ€§èƒ½** | æ…¢æŸ¥è¯¢ã€å¹¶è¡ŒæŸ¥è¯¢æ•ˆç‡ | âœ… å¹¶è¡ŒæŸ¥è¯¢è¿½è¸ª |
| **èµ„æºä½¿ç”¨** | CPUã€å†…å­˜ã€I/Oä½¿ç”¨ç‡ | âœ… pg_stat_get_backend_io() |
| **WALæ€§èƒ½** | WALå†™å…¥ã€æ£€æŸ¥ç‚¹ç»Ÿè®¡ | âœ… pg_stat_checkpointerå¢å¼º |

### 6.1.4.3 ç›‘æµ‹æ•°æ®å­˜å‚¨

**åˆ›å»ºç›‘æµ‹æ•°æ®å­˜å‚¨è¡¨**ï¼š

```sql
-- åˆ›å»ºç›‘æµ‹æ•°æ®å­˜å‚¨è¡¨
CREATE TABLE IF NOT EXISTS pg18_monitoring_history (
    id BIGSERIAL PRIMARY KEY,
    metric_name TEXT NOT NULL,
    metric_value TEXT NOT NULL,
    metric_status TEXT NOT NULL,
    metric_timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_pg18_monitoring_timestamp ON pg18_monitoring_history(metric_timestamp);
CREATE INDEX idx_pg18_monitoring_status ON pg18_monitoring_history(metric_status);

-- ä¿®æ”¹ç›‘æµ‹å‡½æ•°ï¼Œè‡ªåŠ¨å­˜å‚¨æ•°æ®
CREATE OR REPLACE FUNCTION pg18_self_monitoring_with_storage()
RETURNS TABLE(
    metric_name TEXT,
    metric_value TEXT,
    metric_status TEXT,
    metric_timestamp TIMESTAMP
) AS $$
BEGIN
    -- æ‰§è¡Œç›‘æµ‹
    RETURN QUERY SELECT * FROM pg18_self_monitoring();

    -- å­˜å‚¨ç›‘æµ‹æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
    INSERT INTO pg18_monitoring_history (metric_name, metric_value, metric_status, metric_timestamp)
    SELECT * FROM pg18_self_monitoring();

    -- æ¸…ç†æ—§æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
    DELETE FROM pg18_monitoring_history
    WHERE metric_timestamp < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;
```

---

## 6.1.5 æ€§èƒ½ä¼˜åŠ¿ä¸è®ºè¯

### 6.1.5.1 æ€§èƒ½ä¼˜åŠ¿åˆ†æ

| ä¼˜åŠ¿é¡¹ | è¯´æ˜ | ä»·å€¼ |
|--------|------|------|
| **å®Œå…¨è‡ªåŠ¨åŒ–** | æ— éœ€äººå·¥å¹²é¢„ï¼Œ24/7è‡ªåŠ¨è¿ç»´ | èŠ‚çœäººå·¥æˆæœ¬90%+ |
| **åŸºäºPostgreSQLæŠ€æœ¯æ ˆ** | æ— éœ€å¤–éƒ¨å·¥å…·ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦ | å‡å°‘ä¾èµ–ï¼Œæå‡ç¨³å®šæ€§ |
| **å®æ—¶å“åº”** | å®æ—¶ç›‘æµ‹å’Œå“åº”æ•°æ®å˜åŒ– | é—®é¢˜å‘ç°é€Ÿåº¦æå‡10å€ |
| **è‡ªåŠ¨è¯Šæ–­ä¸ä¿®å¤** | è‡ªåŠ¨è¯†åˆ«å’Œä¿®å¤å¸¸è§é—®é¢˜ | æ•…éšœæ¢å¤æ—¶é—´å‡å°‘80% |

### 6.1.5.2 æ€§èƒ½ä¼˜åŠ¿è®ºè¯

**è®ºè¯ï¼šå®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æå‡æ•ˆç‡**

```
å‰ææ¡ä»¶ï¼š
P1: ä¼ ç»Ÿè¿ç»´éœ€è¦äººå·¥ç›‘æ§å’Œæ‰§è¡Œï¼Œå¹³å‡æ¯å¤©è€—æ—¶2-4å°æ—¶
P2: å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´æ— éœ€äººå·¥å¹²é¢„
P3: è‡ªåŠ¨åŒ–ç³»ç»Ÿå¯ä»¥24/7æŒç»­è¿è¡Œ

æ¨ç†è¿‡ç¨‹ï¼š
R1: å¦‚æœP1ï¼Œåˆ™äººå·¥æˆæœ¬é«˜
R2: å¦‚æœP2ï¼Œåˆ™å¯ä»¥èŠ‚çœäººå·¥æˆæœ¬
R3: å¦‚æœP3ï¼Œåˆ™å¯ä»¥æŒç»­ä¼˜åŒ–ï¼Œæå‡æ•ˆç‡

ç»“è®ºï¼š
C1: å®Œå…¨è‡ªåŠ¨åŒ–è¿ç»´å¯ä»¥èŠ‚çœäººå·¥æˆæœ¬90%+
C2: å¯ä»¥24/7æŒç»­ä¼˜åŒ–ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
C3: å¯ä»¥å®æ—¶å“åº”é—®é¢˜ï¼Œå‡å°‘æ•…éšœå½±å“
```

---

## 6.1.6 æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

### 6.1.6.1 æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. **ç‰ˆæœ¬è¦æ±‚**ï¼šéœ€è¦PostgreSQL 18+
2. **æ‰©å±•å®‰è£…**ï¼šéœ€è¦å®‰è£…pg_stat_statementsã€pg_cronç­‰æ‰©å±•
3. **æƒé™è¦æ±‚**ï¼šéœ€è¦è¶³å¤Ÿçš„æ•°æ®åº“æƒé™
4. **èµ„æºæ¶ˆè€—**ï¼šè‡ªåŠ¨åŒ–è¿ç»´ä¼šæ¶ˆè€—ä¸€å®šçš„ç³»ç»Ÿèµ„æº

### 6.1.6.2 æœ€ä½³å®è·µ

âœ… **æ¨èåšæ³•**ï¼š

1. **æ¸è¿›å¼å¯ç”¨**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
2. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼šç›‘æ§è‡ªåŠ¨åŒ–è¿ç»´çš„èµ„æºæ¶ˆè€—
3. **å®šæœŸè¯„ä¼°**ï¼šå®šæœŸè¯„ä¼°è‡ªåŠ¨åŒ–è¿ç»´æ•ˆæœ
4. **å¤‡ä»½æ•°æ®**ï¼šå®šæœŸå¤‡ä»½ç›‘æµ‹æ•°æ®

---

## 6.1.7 å¯¼èˆª

### 6.1.7.1 ç« èŠ‚å¯¼èˆª

- **ä¸Šä¸€èŠ‚**ï¼šæ— ï¼ˆæœ¬ç« ä¸º06-ç»¼åˆæ–¹æ¡ˆçš„ç¬¬ä¸€èŠ‚ï¼‰
- **ä¸‹ä¸€èŠ‚**ï¼š[6.2 Autovacuumè‡ªåŠ¨åŒ–é…ç½®](./02-Autovacuumé…ç½®.md)
- **è¿”å›ä¸»é¢˜ç›®å½•**ï¼š[06-ç»¼åˆæ–¹æ¡ˆ](./README.md)
- **è¿”å›ä¸»æ–‡æ¡£**ï¼š[PostgreSQL-18-è‡ªåŠ¨åŒ–è¿ç»´ä¸è‡ªæˆ‘ç›‘æµ‹](../README.md)

### 6.1.7.2 ç›¸å…³ç« èŠ‚

- [2.5 è‡ªåŠ¨å‚æ•°è°ƒä¼˜](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/05-è‡ªåŠ¨å‚æ•°è°ƒä¼˜.md) - è‡ªåŠ¨å‚æ•°è°ƒä¼˜å®ç°
- [2.6 è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/06-è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–.md) - è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–å®ç°
- [2.7 è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/07-è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°.md) - è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®ç°
- [2.8 è‡ªåŠ¨VACUUMä¼˜åŒ–](../02-è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜/08-è‡ªåŠ¨VACUUMä¼˜åŒ–.md) - è‡ªåŠ¨VACUUMä¼˜åŒ–å®ç°
- [4.1 è‡ªåŠ¨æ…¢æŸ¥è¯¢æ£€æµ‹](../04-è‡ªåŠ¨åŒ–è¯Šæ–­/01-è‡ªåŠ¨æ…¢æŸ¥è¯¢æ£€æµ‹.md) - æ…¢æŸ¥è¯¢æ£€æµ‹
- [5.3 è‡ªåŠ¨åŒ–å‘Šè­¦ç³»ç»Ÿ](../05-è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬/03-è‡ªåŠ¨åŒ–å‘Šè­¦ç³»ç»Ÿ.md) - è‡ªåŠ¨åŒ–å‘Šè­¦

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PostgreSQL 18å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/18/)
- [PostgreSQLè‡ªåŠ¨åŒ–è¿ç»´æœ€ä½³å®è·µ](../10-æœ€ä½³å®è·µ/01-æ¨èåšæ³•ä¸æ³¨æ„äº‹é¡¹.md)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆå·²æ·»åŠ å®Œæ•´ç›®å½•ã€ç« èŠ‚ç¼–å·ã€è¯¦ç»†å†…å®¹ï¼‰
