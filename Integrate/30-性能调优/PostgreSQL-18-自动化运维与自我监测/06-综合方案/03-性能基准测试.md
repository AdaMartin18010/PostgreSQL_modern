# 自动化性能基准测试

> **PostgreSQL版本**: 18+
> **难度等级**: ⭐⭐⭐⭐
> **相关章节**: [Autovacuum配置](./02-Autovacuum配置.md) | [应用场景案例](./04-应用场景案例.md)

---

## 概述

PostgreSQL 18自动化性能基准测试系统可以自动测试和评估数据库的性能指标，包括缓存性能、I/O性能、连接性能、查询性能、存储性能和并行查询性能等。

---

## 自动化性能基准测试系统

### 性能基准测试函数

```sql
-- PostgreSQL 18 自动化性能基准测试系统（带错误处理和性能测试）
CREATE OR REPLACE FUNCTION pg18_performance_benchmark()
RETURNS TABLE(
    benchmark_name TEXT,
    metric_name TEXT,
    metric_value NUMERIC,
    benchmark_time TIMESTAMP,
    status TEXT
) AS $$
DECLARE
    pg_version int;
    benchmark_time TIMESTAMP := NOW();
    cache_hit_ratio numeric;
    io_throughput_mb numeric;
    connection_count int;
    slow_query_count bigint;
    dead_tuple_ratio numeric;
BEGIN
    SELECT current_setting('server_version_num')::int INTO pg_version;

    IF pg_version < 180000 THEN
        RAISE WARNING 'PostgreSQL 18性能基准测试需要PostgreSQL 18+';
        RETURN;
    END IF;

    -- 基准1: 缓存命中率
    BEGIN
        SELECT ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2)
        INTO cache_hit_ratio
        FROM pg_stat_database
        WHERE datname = current_database();

        RETURN QUERY SELECT
            '缓存性能',
            '缓存命中率',
            cache_hit_ratio,
            benchmark_time,
            CASE
                WHEN cache_hit_ratio >= 95 THEN '优秀'
                WHEN cache_hit_ratio >= 90 THEN '良好'
                WHEN cache_hit_ratio >= 80 THEN '一般'
                ELSE '需要优化'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                '缓存性能',
                '缓存命中率',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;

    -- 基准2: I/O吞吐量（PostgreSQL 18增强）
    BEGIN
        SELECT ROUND(SUM(read_bytes + write_bytes)::numeric / 1024 / 1024, 2)
        INTO io_throughput_mb
        FROM pg_stat_io
        WHERE reads > 0 OR writes > 0;

        RETURN QUERY SELECT
            'I/O性能',
            'I/O吞吐量(MB)',
            io_throughput_mb,
            benchmark_time,
            CASE
                WHEN io_throughput_mb > 10000 THEN '高负载'
                WHEN io_throughput_mb > 1000 THEN '中等负载'
                ELSE '低负载'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                'I/O性能',
                'I/O吞吐量(MB)',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;

    -- 基准3: 连接数
    BEGIN
        SELECT COUNT(*) INTO connection_count
        FROM pg_stat_activity
        WHERE datname = current_database();

        DECLARE
            max_connections int;
            connection_usage numeric;
        BEGIN
            SELECT setting::int INTO max_connections FROM pg_settings WHERE name = 'max_connections';
            connection_usage := ROUND(100.0 * connection_count / max_connections, 2);

            RETURN QUERY SELECT
                '连接性能',
                '连接使用率(%)',
                connection_usage,
                benchmark_time,
                CASE
                    WHEN connection_usage < 50 THEN '优秀'
                    WHEN connection_usage < 70 THEN '良好'
                    WHEN connection_usage < 90 THEN '一般'
                    ELSE '需要优化'
                END;
        END;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                '连接性能',
                '连接使用率(%)',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;

    -- 基准4: 慢查询数（PostgreSQL 18增强）
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            SELECT COUNT(*) INTO slow_query_count
            FROM pg_stat_statements
            WHERE mean_exec_time > 1000;  -- 平均执行时间超过1秒

            RETURN QUERY SELECT
                '查询性能',
                '慢查询数',
                slow_query_count::numeric,
                benchmark_time,
                CASE
                    WHEN slow_query_count = 0 THEN '优秀'
                    WHEN slow_query_count <= 5 THEN '良好'
                    WHEN slow_query_count <= 20 THEN '一般'
                    ELSE '需要优化'
                END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                '查询性能',
                '慢查询数',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;

    -- 基准5: 死元组比例
    BEGIN
        SELECT ROUND(100.0 * SUM(n_dead_tup) / NULLIF(SUM(n_dead_tup + n_live_tup), 0), 2)
        INTO dead_tuple_ratio
        FROM pg_stat_user_tables;

        RETURN QUERY SELECT
            '存储性能',
            '死元组比例(%)',
            dead_tuple_ratio,
            benchmark_time,
            CASE
                WHEN dead_tuple_ratio < 5 THEN '优秀'
                WHEN dead_tuple_ratio < 10 THEN '良好'
                WHEN dead_tuple_ratio < 20 THEN '一般'
                ELSE '需要VACUUM'
            END;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                '存储性能',
                '死元组比例(%)',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;

    -- 基准6: 并行查询效率（PostgreSQL 18新增）
    BEGIN
        IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
            DECLARE
                parallel_efficiency numeric;
            BEGIN
                SELECT ROUND(AVG(100.0 * parallel_workers_launched / NULLIF(parallel_workers_to_launch, 0)), 2)
                INTO parallel_efficiency
                FROM pg_stat_statements
                WHERE parallel_workers_to_launch > 0;

                IF parallel_efficiency IS NOT NULL THEN
                    RETURN QUERY SELECT
                        '并行查询性能',
                        '并行效率(%)',
                        parallel_efficiency,
                        benchmark_time,
                        CASE
                            WHEN parallel_efficiency >= 90 THEN '优秀'
                            WHEN parallel_efficiency >= 80 THEN '良好'
                            WHEN parallel_efficiency >= 70 THEN '一般'
                            ELSE '需要优化'
                        END;
                END IF;
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY SELECT
                '并行查询性能',
                '并行效率(%)',
                NULL::numeric,
                benchmark_time,
                '错误: ' || SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT * FROM pg18_performance_benchmark();
```

---

## 基准测试指标说明

### 1. 缓存性能

- **指标**: 缓存命中率
- **优秀**: ≥95%
- **良好**: ≥90%
- **一般**: ≥80%
- **需要优化**: <80%

### 2. I/O性能

- **指标**: I/O吞吐量(MB)
- **高负载**: >10000 MB
- **中等负载**: >1000 MB
- **低负载**: ≤1000 MB

### 3. 连接性能

- **指标**: 连接使用率(%)
- **优秀**: <50%
- **良好**: <70%
- **一般**: <90%
- **需要优化**: ≥90%

### 4. 查询性能

- **指标**: 慢查询数
- **优秀**: 0个
- **良好**: ≤5个
- **一般**: ≤20个
- **需要优化**: >20个

### 5. 存储性能

- **指标**: 死元组比例(%)
- **优秀**: <5%
- **良好**: <10%
- **一般**: <20%
- **需要VACUUM**: ≥20%

### 6. 并行查询性能（PostgreSQL 18新增）

- **指标**: 并行效率(%)
- **优秀**: ≥90%
- **良好**: ≥80%
- **一般**: ≥70%
- **需要优化**: <70%

---

## 定时执行基准测试

### 使用pg_cron定时执行

```sql
-- 每天凌晨2点执行性能基准测试
SELECT cron.schedule(
    'performance-benchmark-daily',
    '0 2 * * *',
    $$SELECT * FROM pg18_performance_benchmark()$$
);
```

---

## 基准测试结果分析

### 查询基准测试结果

```sql
-- 查询基准测试结果
SELECT
    benchmark_name,
    metric_name,
    metric_value,
    status,
    benchmark_time
FROM pg18_performance_benchmark()
ORDER BY benchmark_time DESC, benchmark_name, metric_name;
```

### 生成基准测试报告

```sql
-- 生成基准测试报告
SELECT
    benchmark_name,
    COUNT(*) AS metric_count,
    COUNT(*) FILTER (WHERE status = '优秀') AS excellent_count,
    COUNT(*) FILTER (WHERE status = '良好') AS good_count,
    COUNT(*) FILTER (WHERE status = '一般') AS normal_count,
    COUNT(*) FILTER (WHERE status IN ('需要优化', '需要VACUUM')) AS need_improvement_count
FROM pg18_performance_benchmark()
GROUP BY benchmark_name;
```

---

## PostgreSQL 18增强特性

1. **I/O吞吐量统计**：使用pg_stat_io的read_bytes/write_bytes列
2. **并行查询效率**：使用pg_stat_statements的并行查询追踪列
3. **更详细的性能指标**：提供更全面的性能评估

---

## 注意事项

1. **测试时机**：在系统稳定运行时进行基准测试
2. **结果对比**：定期对比基准测试结果，识别性能趋势
3. **阈值调整**：根据实际情况调整评估阈值

---

## 相关资源

- [性能调优文档](https://www.postgresql.org/docs/18/performance-tips.html)
- [pg_stat_statements文档](https://www.postgresql.org/docs/18/pgstatstatements.html)
- [pg_stat_io文档](https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW)

---

**上一节**: [Autovacuum配置](./02-Autovacuum配置.md)
**下一节**: [应用场景案例](./04-应用场景案例.md)
**返回**: [综合方案目录](./README.md)
