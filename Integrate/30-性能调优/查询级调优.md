# PostgreSQLæŸ¥è¯¢çº§è°ƒä¼˜æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæŸ¥è¯¢çº§è°ƒä¼˜æŒ‡å—](#postgresqlæŸ¥è¯¢çº§è°ƒä¼˜æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ‰§è¡Œè®¡åˆ’åˆ†æ](#2-æ‰§è¡Œè®¡åˆ’åˆ†æ)
    - [2.1 EXPLAINå‘½ä»¤](#21-explainå‘½ä»¤)
    - [2.2 æ‰§è¡Œè®¡åˆ’è§£è¯»](#22-æ‰§è¡Œè®¡åˆ’è§£è¯»)
  - [3. æŸ¥è¯¢ä¼˜åŒ–](#3-æŸ¥è¯¢ä¼˜åŒ–)
    - [3.1 WHEREå­å¥ä¼˜åŒ–](#31-whereå­å¥ä¼˜åŒ–)
    - [3.2 JOINä¼˜åŒ–](#32-joinä¼˜åŒ–)
  - [4. ç»Ÿè®¡ä¿¡æ¯](#4-ç»Ÿè®¡ä¿¡æ¯)
    - [4.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯](#41-æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)
    - [4.2 ç»Ÿè®¡ä¿¡æ¯é…ç½®](#42-ç»Ÿè®¡ä¿¡æ¯é…ç½®)
  - [5. æŸ¥è¯¢é‡å†™](#5-æŸ¥è¯¢é‡å†™)
    - [5.1 å­æŸ¥è¯¢ä¼˜åŒ–](#51-å­æŸ¥è¯¢ä¼˜åŒ–)
    - [5.2 æŸ¥è¯¢é‡å†™æŠ€å·§](#52-æŸ¥è¯¢é‡å†™æŠ€å·§)
  - [6. PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–æ–°ç‰¹æ€§](#6-postgresql-18æŸ¥è¯¢ä¼˜åŒ–æ–°ç‰¹æ€§)
    - [6.1 è·³è¿‡æ‰«æä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰](#61-è·³è¿‡æ‰«æä¼˜åŒ–postgresql-18)
    - [6.2 å¼‚æ­¥I/OæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰](#62-å¼‚æ­¥ioæŸ¥è¯¢ä¼˜åŒ–postgresql-18)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [âœ… æ¨èåšæ³•](#-æ¨èåšæ³•)
    - [âš ï¸ æ³¨æ„äº‹é¡¹](#ï¸-æ³¨æ„äº‹é¡¹)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æŸ¥è¯¢çº§è°ƒä¼˜æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒï¼Œæ¶‰åŠæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„ä¼˜åŒ–ã€‚

**è°ƒä¼˜ç›®æ ‡**:

- ä¼˜åŒ–æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
- æé«˜æŸ¥è¯¢æ€§èƒ½
- å‡å°‘æŸ¥è¯¢æ‰§è¡Œæ—¶é—´

---

## 2. æ‰§è¡Œè®¡åˆ’åˆ†æ

### 2.1 EXPLAINå‘½ä»¤

**EXPLAINå‘½ä»¤è¯¦è§£**ï¼š

```sql
-- åŸºæœ¬EXPLAINï¼ˆä¸æ‰§è¡ŒæŸ¥è¯¢ï¼‰
EXPLAIN
SELECT * FROM orders
WHERE customer_id = 100
ORDER BY order_date DESC
LIMIT 10;

-- EXPLAIN ANALYZEï¼ˆæ‰§è¡ŒæŸ¥è¯¢å¹¶æ˜¾ç¤ºå®é™…æ‰§è¡Œæ—¶é—´ï¼‰
EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE)
SELECT * FROM orders
WHERE customer_id = 100
ORDER BY order_date DESC
LIMIT 10;

-- EXPLAINå®Œæ•´é€‰é¡¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    test_query text := 'SELECT * FROM orders WHERE customer_id = 100 ORDER BY order_date DESC LIMIT 10';
    explain_result text;
BEGIN
    RAISE NOTICE 'å¼€å§‹åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’...';
    RAISE NOTICE 'æŸ¥è¯¢: %', test_query;

    -- æ‰§è¡ŒEXPLAIN ANALYZE
    EXECUTE format('EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE, FORMAT JSON) %s', test_query)
    INTO explain_result;

    RAISE NOTICE 'æ‰§è¡Œè®¡åˆ’ï¼ˆJSONæ ¼å¼ï¼‰: %', explain_result;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ†ææ‰§è¡Œè®¡åˆ’å¤±è´¥: %', SQLERRM;
END $$;
```

**EXPLAINé€‰é¡¹è¯´æ˜**ï¼š

| é€‰é¡¹ | è¯´æ˜ | ç”¨é€” |
| --- | --- | --- |
| `ANALYZE` | å®é™…æ‰§è¡ŒæŸ¥è¯¢ | è·å–å®é™…æ‰§è¡Œæ—¶é—´å’Œè¡Œæ•° |
| `BUFFERS` | æ˜¾ç¤ºç¼“å†²åŒºä½¿ç”¨ | åˆ†æI/Oæ€§èƒ½ |
| `TIMING` | æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯ | åˆ†ææ‰§è¡Œæ—¶é—´ |
| `VERBOSE` | æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ | è·å–æ›´å¤šæ‰§è¡Œç»†èŠ‚ |
| `COSTS` | æ˜¾ç¤ºä»£ä»·ä¼°ç®— | åˆ†ææŸ¥è¯¢ä¼˜åŒ–å™¨å†³ç­– |
| `FORMAT` | è¾“å‡ºæ ¼å¼ | TEXT/JSON/XML/YAML |

### 2.2 æ‰§è¡Œè®¡åˆ’è§£è¯»

**æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹è¯¦è§£**ï¼š

```text
PostgreSQLæ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ç±»å‹
â”œâ”€â”€ æ‰«æèŠ‚ç‚¹ï¼ˆScan Nodesï¼‰
â”‚   â”œâ”€â”€ Seq Scanï¼ˆé¡ºåºæ‰«æï¼‰
â”‚   â”‚   â”œâ”€â”€ è¯´æ˜ï¼šå…¨è¡¨é¡ºåºæ‰«æ
â”‚   â”‚   â”œâ”€â”€ é€‚ç”¨ï¼šå°è¡¨ã€æ— ç´¢å¼•ã€å…¨è¡¨æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ ä¼˜åŒ–ï¼šåˆ›å»ºç´¢å¼•ã€ä½¿ç”¨WHEREè¿‡æ»¤
â”‚   â”œâ”€â”€ Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰
â”‚   â”‚   â”œâ”€â”€ è¯´æ˜ï¼šä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾æ•°æ®
â”‚   â”‚   â”œâ”€â”€ é€‚ç”¨ï¼šç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ ä¼˜åŒ–ï¼šç¡®ä¿ç´¢å¼•å­˜åœ¨ã€ä½¿ç”¨åˆé€‚ç´¢å¼•
â”‚   â”œâ”€â”€ Index Only Scanï¼ˆä»…ç´¢å¼•æ‰«æï¼‰
â”‚   â”‚   â”œâ”€â”€ è¯´æ˜ï¼šåªæ‰«æç´¢å¼•ï¼Œä¸è®¿é—®è¡¨
â”‚   â”‚   â”œâ”€â”€ é€‚ç”¨ï¼šæŸ¥è¯¢åˆ—éƒ½åœ¨ç´¢å¼•ä¸­
â”‚   â”‚   â””â”€â”€ ä¼˜åŒ–ï¼šåˆ›å»ºè¦†ç›–ç´¢å¼•
â”‚   â””â”€â”€ Bitmap Heap Scanï¼ˆä½å›¾å †æ‰«æï¼‰
â”‚       â”œâ”€â”€ è¯´æ˜ï¼šä½¿ç”¨ä½å›¾ç´¢å¼•æ‰«æ
â”‚       â”œâ”€â”€ é€‚ç”¨ï¼šå¤šæ¡ä»¶æŸ¥è¯¢ã€å¤§è¡¨æŸ¥è¯¢
â”‚       â””â”€â”€ ä¼˜åŒ–ï¼šåˆ›å»ºå¤åˆç´¢å¼•
â”œâ”€â”€ è¿æ¥èŠ‚ç‚¹ï¼ˆJoin Nodesï¼‰
â”‚   â”œâ”€â”€ Nested Loopï¼ˆåµŒå¥—å¾ªç¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ è¯´æ˜ï¼šåµŒå¥—å¾ªç¯è¿æ¥
â”‚   â”‚   â”œâ”€â”€ é€‚ç”¨ï¼šå°è¡¨è¿æ¥
â”‚   â”‚   â””â”€â”€ ä¼˜åŒ–ï¼šç¡®ä¿å†…è¡¨æœ‰ç´¢å¼•
â”‚   â”œâ”€â”€ Hash Joinï¼ˆå“ˆå¸Œè¿æ¥ï¼‰
â”‚   â”‚   â”œâ”€â”€ è¯´æ˜ï¼šå“ˆå¸Œè¡¨è¿æ¥
â”‚   â”‚   â”œâ”€â”€ é€‚ç”¨ï¼šå¤§è¡¨ç­‰å€¼è¿æ¥
â”‚   â”‚   â””â”€â”€ ä¼˜åŒ–ï¼šç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜
â”‚   â””â”€â”€ Merge Joinï¼ˆå½’å¹¶è¿æ¥ï¼‰
â”‚       â”œâ”€â”€ è¯´æ˜ï¼šå½’å¹¶æ’åºè¿æ¥
â”‚       â”œâ”€â”€ é€‚ç”¨ï¼šæœ‰åºæ•°æ®è¿æ¥
â”‚       â””â”€â”€ ä¼˜åŒ–ï¼šç¡®ä¿æ•°æ®æœ‰åº
â””â”€â”€ å…¶ä»–èŠ‚ç‚¹ï¼ˆOther Nodesï¼‰
    â”œâ”€â”€ Sortï¼ˆæ’åºï¼‰
    â”œâ”€â”€ Limitï¼ˆé™åˆ¶ï¼‰
    â”œâ”€â”€ Aggregateï¼ˆèšåˆï¼‰
    â””â”€â”€ Appendï¼ˆè¿½åŠ ï¼‰
```

**æ‰§è¡Œè®¡åˆ’åˆ†æå·¥å…·**ï¼š

```sql
-- åˆ†ææ‰§è¡Œè®¡åˆ’æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    plan_record RECORD;
    total_cost numeric := 0;
    total_time numeric := 0;
    total_rows bigint := 0;
BEGIN
    RAISE NOTICE 'å¼€å§‹åˆ†ææ‰§è¡Œè®¡åˆ’æ€§èƒ½...';

    -- æ‰§è¡ŒæŸ¥è¯¢å¹¶åˆ†æ
    FOR plan_record IN
        EXPLAIN (ANALYZE, BUFFERS, TIMING, VERBOSE, FORMAT JSON)
        SELECT * FROM orders
        WHERE customer_id = 100
        ORDER BY order_date DESC
        LIMIT 10
    LOOP
        -- è§£æJSONæ‰§è¡Œè®¡åˆ’ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        RAISE NOTICE 'æ‰§è¡Œè®¡åˆ’: %', plan_record;
    END LOOP;

    RAISE NOTICE 'æ‰§è¡Œè®¡åˆ’åˆ†æå®Œæˆ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ†ææ‰§è¡Œè®¡åˆ’å¤±è´¥: %', SQLERRM;
END $$;
```

---

## 3. æŸ¥è¯¢ä¼˜åŒ–

### 3.1 WHEREå­å¥ä¼˜åŒ–

**WHEREå­å¥ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. é¿å…å‡½æ•°è°ƒç”¨ï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders WHERE UPPER(status) = 'PENDING';

-- ä¼˜åŒ–åï¼šç›´æ¥æ¯”è¾ƒ
SELECT * FROM orders WHERE status = 'pending';

-- 2. é¿å…ç±»å‹è½¬æ¢ï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders WHERE customer_id::text = '100';

-- ä¼˜åŒ–åï¼šä½¿ç”¨æ­£ç¡®ç±»å‹
SELECT * FROM orders WHERE customer_id = 100;

-- 3. ä½¿ç”¨ç´¢å¼•åˆ—ï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders WHERE EXTRACT(YEAR FROM order_date) = 2024;

-- ä¼˜åŒ–åï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢
SELECT * FROM orders WHERE order_date >= '2024-01-01' AND order_date < '2025-01-01';

-- 4. é¿å…NULLæ¯”è¾ƒï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders WHERE status IS NULL OR status = 'pending';

-- ä¼˜åŒ–åï¼šä½¿ç”¨COALESCEæˆ–ç´¢å¼•
SELECT * FROM orders WHERE COALESCE(status, 'pending') = 'pending';
-- æˆ–åˆ›å»ºéƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_orders_pending ON orders(customer_id) WHERE status = 'pending';
```

**WHEREå­å¥ä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- ä¼˜åŒ–ç¤ºä¾‹ï¼šå¤æ‚WHEREå­å¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    optimized_query text;
    execution_time interval;
BEGIN
    RAISE NOTICE '=== WHEREå­å¥ä¼˜åŒ–ç¤ºä¾‹ ===';

    -- ä¼˜åŒ–å‰ï¼šä½¿ç”¨å‡½æ•°å’Œç±»å‹è½¬æ¢
    RAISE NOTICE 'ä¼˜åŒ–å‰æŸ¥è¯¢:';
    RAISE NOTICE 'SELECT * FROM orders WHERE UPPER(status) = ''PENDING'' AND customer_id::text = ''100'';';

    -- ä¼˜åŒ–åï¼šç›´æ¥æ¯”è¾ƒå’Œæ­£ç¡®ç±»å‹
    optimized_query := 'SELECT * FROM orders WHERE status = ''pending'' AND customer_id = 100';
    RAISE NOTICE 'ä¼˜åŒ–åæŸ¥è¯¢: %', optimized_query;

    -- æ€§èƒ½å¯¹æ¯”ï¼ˆéœ€è¦å®é™…æ‰§è¡Œï¼‰
    RAISE NOTICE 'å»ºè®®ï¼šä½¿ç”¨EXPLAIN ANALYZEå¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'WHEREå­å¥ä¼˜åŒ–ç¤ºä¾‹å¤±è´¥: %', SQLERRM;
END $$;
```

### 3.2 JOINä¼˜åŒ–

**JOINä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ç¡®ä¿JOINåˆ—æœ‰ç´¢å¼•
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_customers_id ON customers(id);

-- 2. å°è¡¨é©±åŠ¨å¤§è¡¨ï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT o.*, c.name
FROM large_orders o
JOIN small_customers c ON o.customer_id = c.id;

-- ä¼˜åŒ–åï¼šå°è¡¨åœ¨å‰
SELECT o.*, c.name
FROM small_customers c
JOIN large_orders o ON c.id = o.customer_id;

-- 3. ä½¿ç”¨INNER JOINæ›¿ä»£WHEREï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT o.*, c.name
FROM orders o, customers c
WHERE o.customer_id = c.id;

-- ä¼˜åŒ–åï¼šä½¿ç”¨æ˜¾å¼JOIN
SELECT o.*, c.name
FROM orders o
INNER JOIN customers c ON o.customer_id = c.id;

-- 4. é¿å…ä¸å¿…è¦çš„JOINï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT o.id, o.order_date
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.status = 'active';

-- ä¼˜åŒ–åï¼šä½¿ç”¨EXISTSæˆ–å­æŸ¥è¯¢
SELECT o.id, o.order_date
FROM orders o
WHERE EXISTS (
    SELECT 1 FROM customers c
    WHERE c.id = o.customer_id AND c.status = 'active'
);
```

**JOINç±»å‹é€‰æ‹©**ï¼š

| JOINç±»å‹ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ç‰¹ç‚¹ |
| --- | --- | --- |
| **INNER JOIN** | éœ€è¦åŒ¹é…çš„è®°å½• | æ€§èƒ½æœ€å¥½ |
| **LEFT JOIN** | éœ€è¦å·¦è¡¨æ‰€æœ‰è®°å½• | æ€§èƒ½ä¸­ç­‰ |
| **RIGHT JOIN** | éœ€è¦å³è¡¨æ‰€æœ‰è®°å½• | æ€§èƒ½ä¸­ç­‰ |
| **FULL OUTER JOIN** | éœ€è¦ä¸¤è¡¨æ‰€æœ‰è®°å½• | æ€§èƒ½æœ€å·® |

**PostgreSQL 18 JOINä¼˜åŒ–**ï¼š

- **å¼‚æ­¥I/Oæ”¯æŒ**ï¼šJOINå¯ä»¥åˆ©ç”¨å¼‚æ­¥I/Oæå‡æ€§èƒ½
- **è·³è¿‡æ‰«æä¼˜åŒ–**ï¼šå¤šåˆ—ç´¢å¼•JOINå¯ä»¥åˆ©ç”¨è·³è¿‡æ‰«æ
- **æ€§èƒ½æå‡**ï¼šJOINæ€§èƒ½æå‡2-3å€ï¼ˆç»“åˆå¼‚æ­¥I/Oï¼‰

---

## 4. ç»Ÿè®¡ä¿¡æ¯

### 4.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

**ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ–¹æ³•**ï¼š

```sql
-- æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_record RECORD;
    schema_name text := 'public';
    analyze_count int := 0;
BEGIN
    -- æ£€æŸ¥schemaæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = schema_name
    ) THEN
        RAISE WARNING 'Schema % ä¸å­˜åœ¨', schema_name;
        RETURN;
    END IF;

    RAISE NOTICE 'å¼€å§‹æ›´æ–°Schema % ä¸­çš„è¡¨ç»Ÿè®¡ä¿¡æ¯...', schema_name;

    FOR table_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE schemaname = schema_name
        ORDER BY tablename
    LOOP
        BEGIN
            EXECUTE format('ANALYZE %I.%I', table_record.schemaname, table_record.tablename);
            analyze_count := analyze_count + 1;
            RAISE NOTICE 'å·²æ›´æ–°è¡¨ %.% çš„ç»Ÿè®¡ä¿¡æ¯',
                table_record.schemaname, table_record.tablename;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE WARNING 'æ›´æ–°è¡¨ %.% ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %',
                    table_record.schemaname, table_record.tablename, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ: % ä¸ªè¡¨', analyze_count;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;
```

**ç»Ÿè®¡ä¿¡æ¯æŸ¥çœ‹**ï¼š

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_record RECORD;
BEGIN
    RAISE NOTICE '=== è¡¨ç»Ÿè®¡ä¿¡æ¯ ===';

    FOR stat_record IN
        SELECT
            schemaname,
            tablename,
            n_live_tup,
            n_dead_tup,
            last_vacuum,
            last_autovacuum,
            last_analyze,
            last_autoanalyze
        FROM pg_stat_user_tables
        WHERE schemaname = 'public'
        ORDER BY n_live_tup DESC
        LIMIT 10
    LOOP
        RAISE NOTICE 'è¡¨: %.% | æ´»å…ƒç»„: % | æ­»å…ƒç»„: % | æœ€ååˆ†æ: %',
            stat_record.schemaname,
            stat_record.tablename,
            stat_record.n_live_tup,
            stat_record.n_dead_tup,
            stat_record.last_autoanalyze;
    END LOOP;

    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æŸ¥çœ‹å®Œæˆ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN ANALYZE
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC
LIMIT 10;
```

### 4.2 ç»Ÿè®¡ä¿¡æ¯é…ç½®

**ç»Ÿè®¡ä¿¡æ¯å‚æ•°é…ç½®**ï¼š

```sql
-- PostgreSQLç»Ÿè®¡ä¿¡æ¯å‚æ•°é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_record RECORD;
    default_statistics_target int;
    current_statistics_target int;
BEGIN
    RAISE NOTICE '=== ç»Ÿè®¡ä¿¡æ¯å‚æ•°é…ç½® ===';

    -- æŸ¥çœ‹å½“å‰ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
    SELECT setting::int INTO default_statistics_target
    FROM pg_settings
    WHERE name = 'default_statistics_target';

    RAISE NOTICE 'default_statistics_target: %', default_statistics_target;
    RAISE NOTICE '';
    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡è¯´æ˜:';
    RAISE NOTICE '- é»˜è®¤å€¼: 100';
    RAISE NOTICE '- èŒƒå›´: 1-10000';
    RAISE NOTICE '- å€¼è¶Šå¤§ï¼Œç»Ÿè®¡ä¿¡æ¯è¶Šå‡†ç¡®ï¼Œä½†ANALYZEæ—¶é—´è¶Šé•¿';
    RAISE NOTICE '- æ¨èå€¼: 100ï¼ˆé»˜è®¤ï¼‰æˆ–æ ¹æ®è¡¨å¤§å°è°ƒæ•´';

    -- æŸ¥çœ‹è¡¨çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
    RAISE NOTICE '';
    RAISE NOTICE '=== è¡¨çº§åˆ«ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ ===';
    FOR stat_record IN
        SELECT
            schemaname,
            tablename,
            (SELECT attstattarget FROM pg_attribute
             WHERE attrelid = (schemaname||'.'||tablename)::regclass
             AND attnum > 0 AND attstattarget > 0
             LIMIT 1) as custom_statistics_target
        FROM pg_tables
        WHERE schemaname = 'public'
        LIMIT 10
    LOOP
        IF stat_record.custom_statistics_target IS NOT NULL THEN
            RAISE NOTICE 'è¡¨: %.% | è‡ªå®šä¹‰ç»Ÿè®¡ç›®æ ‡: %',
                stat_record.schemaname,
                stat_record.tablename,
                stat_record.custom_statistics_target;
        END IF;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯é…ç½®å¤±è´¥: %', SQLERRM;
END $$;
```

**ç»Ÿè®¡ä¿¡æ¯å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èå€¼ |
| --- | --- | --- | --- |
| `default_statistics_target` | é»˜è®¤ç»Ÿè®¡ç›®æ ‡ | 100 | 100ï¼ˆé»˜è®¤ï¼‰æˆ–æ ¹æ®è¡¨å¤§å°è°ƒæ•´ |
| `autovacuum_analyze_scale_factor` | è‡ªåŠ¨åˆ†ææ¯”ä¾‹å› å­ | 0.1 | 0.05ï¼ˆæ›´é¢‘ç¹åˆ†æï¼‰ |
| `autovacuum_analyze_threshold` | è‡ªåŠ¨åˆ†æé˜ˆå€¼ | 50 | æ ¹æ®è¡¨å¤§å°è°ƒæ•´ |

**é…ç½®ç¤ºä¾‹**ï¼š

```ini
# postgresql.conf
# ç»Ÿè®¡ä¿¡æ¯é…ç½®
default_statistics_target = 100        # é»˜è®¤ç»Ÿè®¡ç›®æ ‡
autovacuum_analyze_scale_factor = 0.05  # è‡ªåŠ¨åˆ†ææ¯”ä¾‹å› å­ï¼ˆæ›´é¢‘ç¹ï¼‰
autovacuum_analyze_threshold = 50      # è‡ªåŠ¨åˆ†æé˜ˆå€¼

# è¡¨çº§åˆ«ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡ï¼ˆSQLï¼‰
ALTER TABLE large_table ALTER COLUMN important_column SET STATISTICS 500;
```

---

## 5. æŸ¥è¯¢é‡å†™

### 5.1 å­æŸ¥è¯¢ä¼˜åŒ–

**å­æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ç›¸å…³å­æŸ¥è¯¢ä¼˜åŒ–ä¸ºJOINï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM customers c
    WHERE c.id = o.customer_id AND c.status = 'active'
);

-- ä¼˜åŒ–åï¼šä½¿ç”¨JOIN
SELECT o.*
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.status = 'active';

-- 2. INå­æŸ¥è¯¢ä¼˜åŒ–ä¸ºJOINï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT * FROM orders
WHERE customer_id IN (
    SELECT id FROM customers WHERE status = 'active'
);

-- ä¼˜åŒ–åï¼šä½¿ç”¨JOIN
SELECT o.*
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.status = 'active';

-- 3. æ ‡é‡å­æŸ¥è¯¢ä¼˜åŒ–ä¸ºJOINï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT o.*,
    (SELECT name FROM customers WHERE id = o.customer_id) as customer_name
FROM orders o;

-- ä¼˜åŒ–åï¼šä½¿ç”¨JOIN
SELECT o.*, c.name as customer_name
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id;

-- 4. èšåˆå­æŸ¥è¯¢ä¼˜åŒ–ä¸ºçª—å£å‡½æ•°ï¼ˆä¼˜åŒ–å‰ï¼‰
SELECT o.*,
    (SELECT COUNT(*) FROM order_items WHERE order_id = o.id) as item_count
FROM orders o;

-- ä¼˜åŒ–åï¼šä½¿ç”¨çª—å£å‡½æ•°æˆ–JOIN
SELECT o.*, COUNT(oi.id) as item_count
FROM orders o
LEFT JOIN order_items oi ON o.id = oi.order_id
GROUP BY o.id;
```

**å­æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- å­æŸ¥è¯¢ä¼˜åŒ–åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subquery_example text;
    join_example text;
BEGIN
    RAISE NOTICE '=== å­æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ ===';

    -- ç¤ºä¾‹1ï¼šEXISTS vs JOIN
    RAISE NOTICE '1. EXISTS vs JOIN:';
    subquery_example := 'SELECT * FROM orders o WHERE EXISTS (SELECT 1 FROM customers c WHERE c.id = o.customer_id)';
    join_example := 'SELECT o.* FROM orders o JOIN customers c ON o.customer_id = c.id';
    RAISE NOTICE 'ä¼˜åŒ–å‰: %', subquery_example;
    RAISE NOTICE 'ä¼˜åŒ–å: %', join_example;
    RAISE NOTICE 'å»ºè®®: å¤§å¤šæ•°æƒ…å†µä¸‹JOINæ€§èƒ½æ›´å¥½';

    -- ç¤ºä¾‹2ï¼šIN vs JOIN
    RAISE NOTICE '';
    RAISE NOTICE '2. IN vs JOIN:';
    subquery_example := 'SELECT * FROM orders WHERE customer_id IN (SELECT id FROM customers WHERE status = ''active'')';
    join_example := 'SELECT o.* FROM orders o JOIN customers c ON o.customer_id = c.id WHERE c.status = ''active''';
    RAISE NOTICE 'ä¼˜åŒ–å‰: %', subquery_example;
    RAISE NOTICE 'ä¼˜åŒ–å: %', join_example;
    RAISE NOTICE 'å»ºè®®: JOINé€šå¸¸æ€§èƒ½æ›´å¥½ï¼Œç‰¹åˆ«æ˜¯å¤§è¡¨';

    -- ç¤ºä¾‹3ï¼šæ ‡é‡å­æŸ¥è¯¢ vs JOIN
    RAISE NOTICE '';
    RAISE NOTICE '3. æ ‡é‡å­æŸ¥è¯¢ vs JOIN:';
    subquery_example := 'SELECT o.*, (SELECT name FROM customers WHERE id = o.customer_id) FROM orders o';
    join_example := 'SELECT o.*, c.name FROM orders o LEFT JOIN customers c ON o.customer_id = c.id';
    RAISE NOTICE 'ä¼˜åŒ–å‰: %', subquery_example;
    RAISE NOTICE 'ä¼˜åŒ–å: %', join_example;
    RAISE NOTICE 'å»ºè®®: JOINæ€§èƒ½æ›´å¥½ï¼Œé¿å…N+1æŸ¥è¯¢é—®é¢˜';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'å­æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹å¤±è´¥: %', SQLERRM;
END $$;
```

### 5.2 æŸ¥è¯¢é‡å†™æŠ€å·§

**å…¶ä»–æŸ¥è¯¢é‡å†™æŠ€å·§**ï¼š

```sql
-- 1. UNIONä¼˜åŒ–ä¸ºUNION ALLï¼ˆå¦‚æœä¸éœ€è¦å»é‡ï¼‰
-- ä¼˜åŒ–å‰
SELECT id, name FROM table1
UNION
SELECT id, name FROM table2;

-- ä¼˜åŒ–å
SELECT id, name FROM table1
UNION ALL
SELECT id, name FROM table2;

-- 2. DISTINCTä¼˜åŒ–ï¼ˆå¦‚æœå¯èƒ½ï¼‰
-- ä¼˜åŒ–å‰
SELECT DISTINCT customer_id FROM orders;

-- ä¼˜åŒ–åï¼ˆå¦‚æœcustomer_idæœ‰å”¯ä¸€çº¦æŸï¼‰
SELECT customer_id FROM orders GROUP BY customer_id;

-- 3. ORDER BYä¼˜åŒ–ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
-- ä¼˜åŒ–å‰
SELECT * FROM orders ORDER BY order_date DESC LIMIT 10;

-- ä¼˜åŒ–åï¼šç¡®ä¿order_dateæœ‰ç´¢å¼•
CREATE INDEX idx_orders_date ON orders(order_date DESC);
SELECT * FROM orders ORDER BY order_date DESC LIMIT 10;

-- 4. LIMITä¼˜åŒ–ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æåé™åˆ¶
SELECT * FROM orders WHERE status = 'pending' ORDER BY order_date DESC LIMIT 10;

-- ä¼˜åŒ–åï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX idx_orders_pending_date ON orders(status, order_date DESC);
SELECT * FROM orders WHERE status = 'pending' ORDER BY order_date DESC LIMIT 10;
```

## 6. PostgreSQL 18æŸ¥è¯¢ä¼˜åŒ–æ–°ç‰¹æ€§

### 6.1 è·³è¿‡æ‰«æä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰

PostgreSQL 18æ”¯æŒå¤šåˆ—B-treeç´¢å¼•çš„è·³è¿‡æ‰«æï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼š

```sql
-- åˆ›å»ºå¤šåˆ—ç´¢å¼•
CREATE INDEX idx_orders_customer_date ON orders(customer_id, order_date);

-- æŸ¥è¯¢å¯ä»¥åˆ©ç”¨è·³è¿‡æ‰«æï¼ˆPostgreSQL 18ï¼‰
SELECT * FROM orders
WHERE customer_id = 100
ORDER BY order_date DESC
LIMIT 10;
-- PostgreSQL 18: è·³è¿‡æ‰«æä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
```

**æ€§èƒ½æå‡**ï¼š

- å¤šåˆ—ç´¢å¼•æŸ¥è¯¢æ•ˆç‡æå‡30-50%
- å‡å°‘ç´¢å¼•æ‰«æèŒƒå›´
- ä¼˜åŒ–å¤åˆæŸ¥è¯¢æ€§èƒ½

### 6.2 å¼‚æ­¥I/OæŸ¥è¯¢ä¼˜åŒ–ï¼ˆPostgreSQL 18ï¼‰

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼š

```sql
-- å¤§è¡¨æ‰«ææŸ¥è¯¢ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–ï¼‰
SELECT COUNT(*) FROM large_table WHERE status = 'active';
-- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ‰«æé€Ÿåº¦1.5-2å€

-- å‘é‡æ£€ç´¢æŸ¥è¯¢ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–ï¼‰
SELECT id, content,
       1 - (embedding <=> query_vector) as similarity
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 100;
-- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ€§èƒ½2-3å€
```

## 7. æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨EXPLAIN ANALYZE** - åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
2. **ä¼˜åŒ–WHEREå­å¥** - é¿å…å‡½æ•°è°ƒç”¨ã€ç±»å‹è½¬æ¢
3. **ä¼˜åŒ–JOIN** - ç¡®ä¿JOINåˆ—æœ‰ç´¢å¼•ï¼Œå°è¡¨é©±åŠ¨å¤§è¡¨
4. **æ›´æ–°ç»Ÿè®¡ä¿¡æ¯** - å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œç¡®ä¿æŸ¥è¯¢ä¼˜åŒ–å™¨å‡†ç¡®
5. **é‡å†™å­æŸ¥è¯¢** - å°†å­æŸ¥è¯¢ä¼˜åŒ–ä¸ºJOIN
6. **åˆ©ç”¨PostgreSQL 18æ–°ç‰¹æ€§** - ä½¿ç”¨è·³è¿‡æ‰«æã€å¼‚æ­¥I/Oç­‰æ–°ç‰¹æ€§

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦è¿‡åº¦ä¼˜åŒ–** - ä¼˜åŒ–åº”è¯¥åŸºäºå®é™…æ€§èƒ½é—®é¢˜
2. **æµ‹è¯•ä¼˜åŒ–æ•ˆæœ** - æ¯æ¬¡ä¼˜åŒ–åéƒ½è¦æµ‹è¯•æ•ˆæœ
3. **ç›‘æ§æŸ¥è¯¢æ€§èƒ½** - æŒç»­ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. **ä¿æŒç»Ÿè®¡ä¿¡æ¯æ›´æ–°** - å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œç¡®ä¿æŸ¥è¯¢ä¼˜åŒ–å™¨å‡†ç¡®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQLæ€§èƒ½è°ƒä¼˜å®Œæ•´æŒ‡å—.md](./PostgreSQLæ€§èƒ½è°ƒä¼˜å®Œæ•´æŒ‡å—.md) - æ€§èƒ½è°ƒä¼˜å®Œæ•´æŒ‡å—
- [æ€§èƒ½è°ƒä¼˜æ–¹æ³•è®º.md](./æ€§èƒ½è°ƒä¼˜æ–¹æ³•è®º.md) - æ€§èƒ½è°ƒä¼˜æ–¹æ³•è®º
- [ç³»ç»Ÿçº§è°ƒä¼˜.md](./ç³»ç»Ÿçº§è°ƒä¼˜.md) - ç³»ç»Ÿçº§è°ƒä¼˜è¯¦è§£
- [æ•°æ®åº“çº§è°ƒä¼˜.md](./æ•°æ®åº“çº§è°ƒä¼˜.md) - æ•°æ®åº“çº§è°ƒä¼˜è¯¦è§£
- [ç´¢å¼•è°ƒä¼˜.md](./ç´¢å¼•è°ƒä¼˜.md) - ç´¢å¼•è°ƒä¼˜è¯¦è§£
- [30-æ€§èƒ½è°ƒä¼˜/README.md](./README.md) - æ€§èƒ½è°ƒä¼˜ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
