# PostgreSQL查询级调优指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL查询级调优指南](#postgresql查询级调优指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 执行计划分析](#2-执行计划分析)
    - [2.1 EXPLAIN命令](#21-explain命令)
    - [2.2 执行计划解读](#22-执行计划解读)
  - [3. 查询优化](#3-查询优化)
    - [3.1 WHERE子句优化](#31-where子句优化)
    - [3.2 JOIN优化](#32-join优化)
  - [4. 统计信息](#4-统计信息)
    - [4.1 更新统计信息](#41-更新统计信息)
    - [4.2 统计信息配置](#42-统计信息配置)
  - [5. 查询重写](#5-查询重写)
    - [5.1 子查询优化](#51-子查询优化)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

查询级调优是性能优化的核心，涉及查询执行计划的优化。

**调优目标**:

- 优化查询执行计划
- 提高查询性能
- 减少查询执行时间

---

## 2. 执行计划分析

### 2.1 EXPLAIN命令

```sql
-- 查看执行计划
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE customer_id = 100
ORDER BY order_date DESC
LIMIT 10;
```

### 2.2 执行计划解读

```text
- Seq Scan: 顺序扫描
- Index Scan: 索引扫描
- Index Only Scan: 仅索引扫描
- Bitmap Heap Scan: 位图堆扫描
- Nested Loop: 嵌套循环
- Hash Join: 哈希连接
```

---

## 3. 查询优化

### 3.1 WHERE子句优化

```sql
-- 优化前
SELECT * FROM orders WHERE UPPER(status) = 'PENDING';

-- 优化后
SELECT * FROM orders WHERE status = 'pending';
```

### 3.2 JOIN优化

```sql
-- 使用索引优化JOIN
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_customers_id ON customers(id);

SELECT o.*, c.name
FROM orders o
JOIN customers c ON o.customer_id = c.id;
```

---

## 4. 统计信息

### 4.1 更新统计信息

```sql
-- 手动更新统计信息
ANALYZE orders;

-- 查看统计信息
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
WHERE tablename = 'orders';
```

### 4.2 统计信息配置

```sql
-- postgresql.conf
default_statistics_target = 100  -- 默认统计目标
```

---

## 5. 查询重写

### 5.1 子查询优化

```sql
-- 优化前：相关子查询
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM customers c
    WHERE c.id = o.customer_id AND c.status = 'active'
);

-- 优化后：JOIN
SELECT o.*
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.status = 'active';
```

---

## 📚 相关文档

- [PostgreSQL性能调优完整指南.md](./PostgreSQL性能调优完整指南.md) - 性能调优完整指南
- [索引调优.md](./索引调优.md) - 索引调优详解
- [30-性能调优/README.md](./README.md) - 性能调优主题

---

**最后更新**: 2025年1月
