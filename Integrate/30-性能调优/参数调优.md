# PostgreSQL参数调优指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL参数调优指南](#postgresql参数调优指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 内存参数](#2-内存参数)
    - [2.1 核心内存参数](#21-核心内存参数)
    - [2.2 内存参数计算](#22-内存参数计算)
  - [3. 连接参数](#3-连接参数)
    - [3.1 连接配置](#31-连接配置)
    - [3.2 连接池建议](#32-连接池建议)
  - [4. 查询参数](#4-查询参数)
    - [4.1 查询优化参数](#41-查询优化参数)
    - [4.2 并行查询参数](#42-并行查询参数)
  - [5. 维护参数](#5-维护参数)
    - [5.1 自动清理参数](#51-自动清理参数)
    - [5.2 检查点参数](#52-检查点参数)
  - [6. PostgreSQL 18参数优化新特性](#6-postgresql-18参数优化新特性)
    - [6.1 异步I/O参数（PostgreSQL 18）](#61-异步io参数postgresql-18)
    - [6.2 参数调优工具](#62-参数调优工具)
  - [7. 最佳实践](#7-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [⚠️ 注意事项](#️-注意事项)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

参数调优是PostgreSQL性能优化的重要组成部分。

**调优目标**:

- 优化数据库配置参数
- 提高数据库性能
- 优化资源使用

---

## 2. 内存参数

### 2.1 核心内存参数

**内存参数详细说明**：

```sql
-- PostgreSQL内存参数配置（带错误处理和性能测试）
DO $$
DECLARE
    total_mem_gb numeric := 64;  -- 系统总内存（GB）
    shared_buffers_gb numeric;
    effective_cache_size_gb numeric;
    work_mem_mb numeric;
    maintenance_work_mem_gb numeric;
    temp_buffers_mb numeric;
    max_connections int;
BEGIN
    RAISE NOTICE '=== PostgreSQL内存参数配置推荐 ===';
    RAISE NOTICE '系统总内存: %GB', total_mem_gb;

    -- 计算推荐配置
    shared_buffers_gb := total_mem_gb * 0.25;  -- 系统内存的25%
    effective_cache_size_gb := total_mem_gb * 0.75;  -- 系统内存的75%

    -- 获取最大连接数
    SELECT setting::int INTO max_connections
    FROM pg_settings
    WHERE name = 'max_connections';

    -- 计算work_mem（假设目标为每个连接4MB）
    work_mem_mb := CEIL((total_mem_gb * 1024 - shared_buffers_gb * 1024) / NULLIF(max_connections, 0) * 0.1);
    IF work_mem_mb > 256 THEN
        work_mem_mb := 256;  -- 限制最大256MB
    END IF;

    maintenance_work_mem_gb := total_mem_gb * 0.1;  -- 系统内存的10%
    IF maintenance_work_mem_gb > 2 THEN
        maintenance_work_mem_gb := 2;  -- 限制最大2GB
    END IF;

    temp_buffers_mb := 16;  -- 临时缓冲区（固定值）

    RAISE NOTICE 'shared_buffers: %GB (系统内存的25%%)', shared_buffers_gb;
    RAISE NOTICE 'effective_cache_size: %GB (系统内存的75%%)', effective_cache_size_gb;
    RAISE NOTICE 'work_mem: %MB (每个连接)', work_mem_mb;
    RAISE NOTICE 'maintenance_work_mem: %GB (维护操作)', maintenance_work_mem_gb;
    RAISE NOTICE 'temp_buffers: %MB (临时缓冲区)', temp_buffers_mb;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'shared_buffers = %GB', shared_buffers_gb;
    RAISE NOTICE 'effective_cache_size = %GB', effective_cache_size_gb;
    RAISE NOTICE 'work_mem = %MB', work_mem_mb;
    RAISE NOTICE 'maintenance_work_mem = %GB', maintenance_work_mem_gb;
    RAISE NOTICE 'temp_buffers = %MB', temp_buffers_mb;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算内存参数失败: %', SQLERRM;
END $$;
```

**内存参数说明**：

| 参数 | 说明 | 推荐值 | 影响 | PostgreSQL 18优化 |
| --- | --- | --- | --- | --- |
| `shared_buffers` | 共享缓冲区大小 | 系统内存的25% | 影响缓存命中率 | 异步I/O减少缓冲区需求 |
| `effective_cache_size` | 有效缓存大小 | 系统内存的50-75% | 影响查询优化器决策 | 考虑操作系统缓存 |
| `work_mem` | 工作内存 | 根据连接数计算 | 影响排序、哈希操作 | 异步I/O减少内存需求 |
| `maintenance_work_mem` | 维护工作内存 | 系统内存的10% | 影响VACUUM、CREATE INDEX | 异步I/O提升维护性能 |
| `temp_buffers` | 临时缓冲区 | 16MB | 影响临时表操作 | 保持不变 |

### 2.2 内存参数计算

**内存参数计算公式**：

```sql
-- 内存参数自动计算工具（带错误处理和性能测试）
DO $$
DECLARE
    total_mem_gb numeric;
    max_connections int;
    shared_buffers_gb numeric;
    effective_cache_size_gb numeric;
    work_mem_mb numeric;
    maintenance_work_mem_gb numeric;
    total_work_mem_gb numeric;
    total_memory_usage_gb numeric;
    memory_warning_threshold numeric := 0.9;  -- 90%警告阈值
BEGIN
    -- 假设系统总内存（实际应从系统获取）
    total_mem_gb := 64;

    -- 获取最大连接数
    SELECT setting::int INTO max_connections
    FROM pg_settings
    WHERE name = 'max_connections';

    RAISE NOTICE '=== 内存参数自动计算 ===';
    RAISE NOTICE '系统总内存: %GB', total_mem_gb;
    RAISE NOTICE '最大连接数: %', max_connections;

    -- 计算内存参数
    shared_buffers_gb := total_mem_gb * 0.25;
    effective_cache_size_gb := total_mem_gb * 0.75;
    work_mem_mb := CEIL((total_mem_gb * 1024 - shared_buffers_gb * 1024) / NULLIF(max_connections, 0) * 0.1);
    IF work_mem_mb > 256 THEN
        work_mem_mb := 256;
    END IF;
    maintenance_work_mem_gb := LEAST(total_mem_gb * 0.1, 2);

    -- 计算总内存使用
    total_work_mem_gb := (work_mem_mb::numeric / 1024) * max_connections;
    total_memory_usage_gb := shared_buffers_gb + total_work_mem_gb + maintenance_work_mem_gb;

    RAISE NOTICE '';
    RAISE NOTICE '计算的内存参数:';
    RAISE NOTICE 'shared_buffers: %GB', shared_buffers_gb;
    RAISE NOTICE 'effective_cache_size: %GB', effective_cache_size_gb;
    RAISE NOTICE 'work_mem: %MB (每个连接)', work_mem_mb;
    RAISE NOTICE 'maintenance_work_mem: %GB', maintenance_work_mem_gb;
    RAISE NOTICE '';
    RAISE NOTICE '总内存使用估算:';
    RAISE NOTICE 'shared_buffers: %GB', shared_buffers_gb;
    RAISE NOTICE 'work_mem总计: %GB (%个连接 × %MB)', total_work_mem_gb, max_connections, work_mem_mb;
    RAISE NOTICE 'maintenance_work_mem: %GB', maintenance_work_mem_gb;
    RAISE NOTICE '总内存使用: %GB / %GB (%%%)',
        total_memory_usage_gb,
        total_mem_gb,
        ROUND(100.0 * total_memory_usage_gb / NULLIF(total_mem_gb, 0), 2);

    -- 检查内存使用
    IF total_memory_usage_gb / NULLIF(total_mem_gb, 0) > memory_warning_threshold THEN
        RAISE WARNING '内存使用超过%%，建议减少max_connections或work_mem',
            memory_warning_threshold * 100;
    ELSE
        RAISE NOTICE '内存使用正常';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '内存参数计算失败: %', SQLERRM;
END $$;
```

---

## 3. 连接参数

### 3.1 连接配置

**连接参数详细配置**：

```sql
-- PostgreSQL连接参数配置（带错误处理和性能测试）
DO $$
DECLARE
    total_mem_gb numeric := 64;  -- 系统总内存（GB）
    max_connections int;
    superuser_reserved_connections int;
    work_mem_mb numeric;
    shared_buffers_gb numeric;
    total_work_mem_gb numeric;
    memory_per_connection_mb numeric;
BEGIN
    RAISE NOTICE '=== PostgreSQL连接参数配置推荐 ===';
    RAISE NOTICE '系统总内存: %GB', total_mem_gb;

    -- 计算最大连接数（每GB内存约3-5个连接）
    max_connections := LEAST(total_mem_gb::int * 3, 500);
    superuser_reserved_connections := 3;

    -- 计算shared_buffers
    shared_buffers_gb := total_mem_gb * 0.25;

    -- 计算work_mem（假设每个连接需要4MB）
    work_mem_mb := CEIL((total_mem_gb * 1024 - shared_buffers_gb * 1024) / NULLIF(max_connections, 0) * 0.1);
    IF work_mem_mb > 256 THEN
        work_mem_mb := 256;  -- 限制最大256MB
    END IF;

    -- 计算总work_mem
    total_work_mem_gb := (work_mem_mb::numeric / 1024) * max_connections;
    memory_per_connection_mb := work_mem_mb;

    RAISE NOTICE 'max_connections: % (建议值)', max_connections;
    RAISE NOTICE 'superuser_reserved_connections: %', superuser_reserved_connections;
    RAISE NOTICE 'work_mem: %MB (每个连接)', work_mem_mb;
    RAISE NOTICE '总work_mem: %GB (%个连接)', total_work_mem_gb, max_connections;
    RAISE NOTICE '每个连接内存: %MB', memory_per_connection_mb;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'max_connections = %', max_connections;
    RAISE NOTICE 'superuser_reserved_connections = %', superuser_reserved_connections;
    RAISE NOTICE 'work_mem = %MB', work_mem_mb;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算连接参数失败: %', SQLERRM;
END $$;
```

**连接参数说明**：

| 参数 | 说明 | 推荐值 | 计算公式 | 注意事项 |
| --- | --- | --- | --- | --- |
| `max_connections` | 最大连接数 | 系统内存(GB) × 3-5 | `RAM_GB * 3` | 不要设置过大，影响性能 |
| `superuser_reserved_connections` | 超级用户保留连接 | 3 | 固定值 | 确保管理员可以连接 |
| `work_mem` | 工作内存 | 根据连接数计算 | `(RAM - shared_buffers) / (max_connections * 3)` | 每个连接都会使用 |

### 3.2 连接池建议

**连接池配置建议**：

```ini
# PgBouncer连接池配置（/etc/pgbouncer/pgbouncer.ini）
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
# 连接池模式
pool_mode = transaction          # 事务级连接池（推荐）

# 连接数配置
max_client_conn = 1000           # 最大客户端连接数
default_pool_size = 25           # 默认连接池大小
min_pool_size = 5                # 最小连接池大小
reserve_pool_size = 5            # 保留连接池大小
reserve_pool_timeout = 3         # 保留连接池超时（秒）

# 数据库连接限制
max_db_connections = 100         # 每个数据库最大连接数
max_user_connections = 50         # 每个用户最大连接数

# 统计和日志
stats_period = 60                # 统计周期（秒）
log_connections = 1              # 记录连接
log_disconnections = 1           # 记录断开连接
log_pooler_errors = 1            # 记录连接池错误
```

**连接池模式对比**：

| 模式 | 说明 | 适用场景 | 性能特点 |
| --- | --- | --- | --- |
| `session` | 会话级连接池 | 需要保持会话状态的应用 | 性能中等 |
| `transaction` | 事务级连接池 | 大多数Web应用（推荐） | 性能最好 |
| `statement` | 语句级连接池 | 简单查询应用 | 性能最好但限制多 |

---

## 4. 查询参数

### 4.1 查询优化参数

**查询优化参数详细配置**：

```sql
-- PostgreSQL查询优化参数配置（带错误处理和性能测试）
DO $$
DECLARE
    storage_type text := 'SSD';  -- 存储类型（SSD/NVMe/HDD）
    random_page_cost numeric;
    effective_io_concurrency int;
    maintenance_io_concurrency int;
    default_statistics_target int;
BEGIN
    RAISE NOTICE '=== PostgreSQL查询优化参数配置推荐 ===';
    RAISE NOTICE '存储类型: %', storage_type;

    -- 根据存储类型设置参数
    IF storage_type = 'SSD' OR storage_type = 'NVMe' THEN
        random_page_cost := 1.1;
        effective_io_concurrency := 200;  -- PostgreSQL 18推荐值
        maintenance_io_concurrency := 200;  -- PostgreSQL 18新增
        RAISE NOTICE 'SSD/NVMe配置:';
    ELSIF storage_type = 'HDD' THEN
        random_page_cost := 4.0;
        effective_io_concurrency := 2;
        maintenance_io_concurrency := 10;
        RAISE NOTICE 'HDD配置:';
    ELSE
        random_page_cost := 2.0;
        effective_io_concurrency := 100;
        maintenance_io_concurrency := 50;
        RAISE NOTICE '默认配置:';
    END IF;

    default_statistics_target := 100;  -- 默认统计目标

    RAISE NOTICE 'random_page_cost: %', random_page_cost;
    RAISE NOTICE 'effective_io_concurrency: % (PostgreSQL 18异步I/O)', effective_io_concurrency;
    RAISE NOTICE 'maintenance_io_concurrency: % (PostgreSQL 18新增)', maintenance_io_concurrency;
    RAISE NOTICE 'default_statistics_target: %', default_statistics_target;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'random_page_cost = %', random_page_cost;
    RAISE NOTICE 'effective_io_concurrency = %', effective_io_concurrency;
    RAISE NOTICE 'maintenance_io_concurrency = %', maintenance_io_concurrency;
    RAISE NOTICE 'default_statistics_target = %', default_statistics_target;
    RAISE NOTICE 'seq_page_cost = 1.0';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算查询优化参数失败: %', SQLERRM;
END $$;
```

**查询优化参数说明**：

| 参数 | 说明 | SSD推荐值 | HDD推荐值 | PostgreSQL 18优化 |
| --- | --- | --- | --- | --- |
| `random_page_cost` | 随机页面访问代价 | 1.1 | 4.0 | 异步I/O降低实际代价 |
| `seq_page_cost` | 顺序页面访问代价 | 1.0 | 1.0 | 保持不变 |
| `effective_io_concurrency` | 有效I/O并发数 | 200-300 | 2-4 | **PostgreSQL 18异步I/O核心参数** |
| `maintenance_io_concurrency` | 维护I/O并发数 | 200 | 10 | **PostgreSQL 18新增** |
| `default_statistics_target` | 默认统计目标 | 100 | 100 | 保持不变 |

### 4.2 并行查询参数

**并行查询参数详细配置**：

```sql
-- PostgreSQL并行查询参数配置（带错误处理和性能测试）
DO $$
DECLARE
    cpu_cores int := 8;  -- CPU核心数
    max_parallel_workers_per_gather int;
    max_parallel_workers int;
    max_worker_processes int;
    parallel_tuple_cost numeric;
    parallel_setup_cost numeric;
BEGIN
    RAISE NOTICE '=== PostgreSQL并行查询参数配置推荐 ===';
    RAISE NOTICE 'CPU核心数: %', cpu_cores;

    -- 计算推荐配置
    max_parallel_workers_per_gather := LEAST(cpu_cores / 2, 4);  -- 每个查询最多4个并行worker
    max_parallel_workers := cpu_cores;  -- 总并行worker数
    max_worker_processes := cpu_cores * 2;  -- 总worker进程数（包括并行和其他）
    parallel_tuple_cost := 0.1;  -- 并行元组处理代价
    parallel_setup_cost := 1000.0;  -- 并行设置代价

    RAISE NOTICE 'max_parallel_workers_per_gather: % (每个查询)', max_parallel_workers_per_gather;
    RAISE NOTICE 'max_parallel_workers: % (总并行worker)', max_parallel_workers;
    RAISE NOTICE 'max_worker_processes: % (总worker进程)', max_worker_processes;
    RAISE NOTICE 'parallel_tuple_cost: %', parallel_tuple_cost;
    RAISE NOTICE 'parallel_setup_cost: %', parallel_setup_cost;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'max_parallel_workers_per_gather = %', max_parallel_workers_per_gather;
    RAISE NOTICE 'max_parallel_workers = %', max_parallel_workers;
    RAISE NOTICE 'max_worker_processes = %', max_worker_processes;
    RAISE NOTICE 'parallel_tuple_cost = %', parallel_tuple_cost;
    RAISE NOTICE 'parallel_setup_cost = %', parallel_setup_cost;
    RAISE NOTICE 'min_parallel_table_scan_size = 8MB';
    RAISE NOTICE 'min_parallel_index_scan_size = 512KB';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算并行查询参数失败: %', SQLERRM;
END $$;
```

**并行查询参数说明**：

| 参数 | 说明 | 推荐值 | 影响 |
| --- | --- | --- | --- |
| `max_parallel_workers_per_gather` | 每个查询的最大并行worker数 | CPU核心数/2，最大4 | 影响并行查询性能 |
| `max_parallel_workers` | 系统最大并行worker数 | CPU核心数 | 限制总并行worker数 |
| `max_worker_processes` | 系统最大worker进程数 | CPU核心数*2 | 限制总worker进程数 |
| `parallel_tuple_cost` | 并行元组处理代价 | 0.1 | 影响并行查询选择 |
| `parallel_setup_cost` | 并行设置代价 | 1000.0 | 影响并行查询选择 |
| `min_parallel_table_scan_size` | 启用并行扫描的最小表大小 | 8MB | 控制并行扫描触发 |
| `min_parallel_index_scan_size` | 启用并行索引扫描的最小索引大小 | 512KB | 控制并行索引扫描触发 |

---

## 5. 维护参数

### 5.1 自动清理参数

**自动清理参数详细配置**：

```sql
-- PostgreSQL自动清理参数配置（带错误处理和性能测试）
DO $$
DECLARE
    cpu_cores int := 8;  -- CPU核心数
    autovacuum_max_workers int;
    autovacuum_naptime_sec int;
    autovacuum_vacuum_cost_delay_ms int;
    autovacuum_vacuum_cost_limit int;
    autovacuum_analyze_scale_factor numeric;
    autovacuum_analyze_threshold int;
BEGIN
    RAISE NOTICE '=== PostgreSQL自动清理参数配置推荐 ===';
    RAISE NOTICE 'CPU核心数: %', cpu_cores;

    -- 计算推荐配置
    autovacuum_max_workers := LEAST(cpu_cores / 2, 3);  -- CPU核心数的一半，最大3
    autovacuum_naptime_sec := 60;  -- 1分钟
    autovacuum_vacuum_cost_delay_ms := 2;  -- 2毫秒
    autovacuum_vacuum_cost_limit := 200;  -- 200
    autovacuum_analyze_scale_factor := 0.05;  -- 5%（更频繁分析）
    autovacuum_analyze_threshold := 50;  -- 50行

    RAISE NOTICE 'autovacuum_max_workers: %', autovacuum_max_workers;
    RAISE NOTICE 'autovacuum_naptime: %秒', autovacuum_naptime_sec;
    RAISE NOTICE 'autovacuum_vacuum_cost_delay: %ms', autovacuum_vacuum_cost_delay_ms;
    RAISE NOTICE 'autovacuum_vacuum_cost_limit: %', autovacuum_vacuum_cost_limit;
    RAISE NOTICE 'autovacuum_analyze_scale_factor: %', autovacuum_analyze_scale_factor;
    RAISE NOTICE 'autovacuum_analyze_threshold: %', autovacuum_analyze_threshold;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'autovacuum = on';
    RAISE NOTICE 'autovacuum_max_workers = %', autovacuum_max_workers;
    RAISE NOTICE 'autovacuum_naptime = %s', autovacuum_naptime_sec;
    RAISE NOTICE 'autovacuum_vacuum_cost_delay = %ms', autovacuum_vacuum_cost_delay_ms;
    RAISE NOTICE 'autovacuum_vacuum_cost_limit = %', autovacuum_vacuum_cost_limit;
    RAISE NOTICE 'autovacuum_analyze_scale_factor = %', autovacuum_analyze_scale_factor;
    RAISE NOTICE 'autovacuum_analyze_threshold = %', autovacuum_analyze_threshold;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算自动清理参数失败: %', SQLERRM;
END $$;
```

**自动清理参数说明**：

| 参数 | 说明 | 推荐值 | PostgreSQL 18优化 |
| --- | --- | --- | --- |
| `autovacuum` | 启用自动清理 | on | 必须启用 |
| `autovacuum_max_workers` | 自动清理最大工作进程 | CPU核心数/2，最大3 | 异步I/O提升清理性能 |
| `autovacuum_naptime` | 自动清理间隔 | 1分钟 | 根据负载调整 |
| `autovacuum_vacuum_cost_delay` | 清理成本延迟 | 2ms | 控制清理I/O负载 |
| `autovacuum_vacuum_cost_limit` | 清理成本限制 | 200 | 控制清理速度 |
| `autovacuum_analyze_scale_factor` | 自动分析比例因子 | 0.05 | 更频繁分析 |
| `autovacuum_analyze_threshold` | 自动分析阈值 | 50 | 根据表大小调整 |

### 5.2 检查点参数

**检查点参数详细配置**：

```sql
-- PostgreSQL检查点参数配置（带错误处理和性能测试）
DO $$
DECLARE
    total_mem_gb numeric := 64;  -- 系统总内存（GB）
    checkpoint_timeout_min int;
    checkpoint_completion_target numeric;
    max_wal_size_gb numeric;
    min_wal_size_gb numeric;
    wal_buffers_mb int;
BEGIN
    RAISE NOTICE '=== PostgreSQL检查点参数配置推荐 ===';
    RAISE NOTICE '系统总内存: %GB', total_mem_gb;

    -- 计算推荐配置
    checkpoint_timeout_min := 15;  -- 15分钟
    checkpoint_completion_target := 0.9;  -- 90%完成目标
    max_wal_size_gb := total_mem_gb * 0.1;  -- 系统内存的10%
    IF max_wal_size_gb > 4 THEN
        max_wal_size_gb := 4;  -- 限制最大4GB
    END IF;
    min_wal_size_gb := max_wal_size_gb * 0.25;  -- max_wal_size的25%
    wal_buffers_mb := LEAST(CEIL(total_mem_gb * 1024 * 0.01), 16);  -- 系统内存的1%，最大16MB

    RAISE NOTICE 'checkpoint_timeout: %分钟', checkpoint_timeout_min;
    RAISE NOTICE 'checkpoint_completion_target: %', checkpoint_completion_target;
    RAISE NOTICE 'max_wal_size: %GB', max_wal_size_gb;
    RAISE NOTICE 'min_wal_size: %GB', min_wal_size_gb;
    RAISE NOTICE 'wal_buffers: %MB', wal_buffers_mb;
    RAISE NOTICE '';
    RAISE NOTICE '配置示例（postgresql.conf）:';
    RAISE NOTICE 'checkpoint_timeout = %min', checkpoint_timeout_min;
    RAISE NOTICE 'checkpoint_completion_target = %', checkpoint_completion_target;
    RAISE NOTICE 'max_wal_size = %GB', max_wal_size_gb;
    RAISE NOTICE 'min_wal_size = %GB', min_wal_size_gb;
    RAISE NOTICE 'wal_buffers = %MB', wal_buffers_mb;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '计算检查点参数失败: %', SQLERRM;
END $$;
```

**检查点参数说明**：

| 参数 | 说明 | 推荐值 | PostgreSQL 18优化 |
| --- | --- | --- | --- |
| `checkpoint_timeout` | 检查点超时时间 | 15分钟 | 异步I/O提升检查点性能 |
| `checkpoint_completion_target` | 检查点完成目标 | 0.9 | 控制检查点写入速度 |
| `max_wal_size` | 最大WAL大小 | 系统内存的10% | 超过此值会强制检查点 |
| `min_wal_size` | 最小WAL大小 | max_wal_size的25% | WAL文件最小保留大小 |
| `wal_buffers` | WAL缓冲区大小 | 系统内存的1%，最大16MB | 异步I/O减少缓冲区需求 |

## 6. PostgreSQL 18参数优化新特性

### 6.1 异步I/O参数（PostgreSQL 18）

PostgreSQL 18新增异步I/O相关参数：

```ini
# postgresql.conf (PostgreSQL 18)
# 异步I/O配置（PostgreSQL 18新特性）
effective_io_concurrency = 200        # 查询异步I/O并发数（SSD推荐：200-300）
maintenance_io_concurrency = 200      # 维护操作异步I/O并发数（PostgreSQL 18新增）

# 性能提升
# - I/O性能提升2-3倍
# - 检查点性能提升2-3倍
# - WAL写入性能提升2-3倍
# - 自动清理性能提升2-3倍
```

### 6.2 参数调优工具

**参数调优辅助工具**：

```sql
-- 查看当前参数配置（带错误处理和性能测试）
DO $$
DECLARE
    param_record RECORD;
    param_categories text[] := ARRAY['memory', 'connection', 'query', 'maintenance', 'checkpoint', 'io'];
    category text;
BEGIN
    RAISE NOTICE '=== PostgreSQL参数配置查看 ===';

    FOREACH category IN ARRAY param_categories
    LOOP
        RAISE NOTICE '';
        RAISE NOTICE '=== %参数 ===', category;
        FOR param_record IN
            SELECT name, setting, unit, source, context
            FROM pg_settings
            WHERE name LIKE '%' || category || '%'
            OR (category = 'memory' AND (name LIKE '%buffer%' OR name LIKE '%cache%' OR name LIKE '%mem%'))
            OR (category = 'connection' AND name LIKE '%connection%')
            OR (category = 'query' AND (name LIKE '%cost%' OR name LIKE '%statistics%' OR name LIKE '%parallel%'))
            OR (category = 'maintenance' AND name LIKE '%vacuum%')
            OR (category = 'checkpoint' AND name LIKE '%checkpoint%')
            OR (category = 'io' AND (name LIKE '%io%' OR name LIKE '%wal%'))
            ORDER BY name
            LIMIT 20
        LOOP
            RAISE NOTICE '参数: % = % % (来源: % | 上下文: %)',
                param_record.name,
                param_record.setting,
                COALESCE(param_record.unit, ''),
                param_record.source,
                param_record.context;
        END LOOP;
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '查看参数配置失败: %', SQLERRM;
END $$;
```

## 7. 最佳实践

### ✅ 推荐做法

1. **根据系统资源计算参数** - 根据系统内存、CPU核心数计算参数
2. **测试参数效果** - 每次参数调整后测试效果
3. **监控参数影响** - 持续监控参数对系统的影响
4. **使用连接池** - 使用PgBouncer等连接池减少连接开销
5. **利用PostgreSQL 18新特性** - 使用异步I/O等新特性优化参数

### ⚠️ 注意事项

1. **不要过度配置** - 参数应该基于实际负载和系统资源
2. **备份配置** - 参数调整前备份原始配置
3. **渐进式调整** - 一次调整一个参数，测试效果后再继续
4. **监控影响** - 参数调整后持续监控系统影响

---

## 📚 相关文档

- [PostgreSQL性能调优完整指南.md](./PostgreSQL性能调优完整指南.md) - 性能调优完整指南
- [性能调优方法论.md](./性能调优方法论.md) - 性能调优方法论
- [系统级调优.md](./系统级调优.md) - 系统级调优详解
- [数据库级调优.md](./数据库级调优.md) - 数据库级调优详解
- [查询级调优.md](./查询级调优.md) - 查询级调优详解
- [索引调优.md](./索引调优.md) - 索引调优详解
- [30-性能调优/README.md](./README.md) - 性能调优主题

---

**最后更新**: 2025年1月
