# PostgreSQL灾难恢复计划完整指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级
> **适用场景**: 生产环境、关键业务系统、高可用架构

---

## 📋 目录

- [PostgreSQL灾难恢复计划完整指南](#postgresql灾难恢复计划完整指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 灾难恢复的重要性](#11-灾难恢复的重要性)
    - [1.2 RTO与RPO概念](#12-rto与rpo概念)
    - [1.3 灾难类型分类](#13-灾难类型分类)
  - [2. 计划制定](#2-计划制定)
    - [2.1 业务影响分析](#21-业务影响分析)
    - [2.2 风险评估](#22-风险评估)
    - [2.3 恢复目标设定](#23-恢复目标设定)
  - [3. 恢复策略](#3-恢复策略)
    - [3.1 策略选择](#31-策略选择)
    - [3.2 备份策略](#32-备份策略)
    - [3.3 复制策略](#33-复制策略)
    - [3.4 存储策略](#34-存储策略)
  - [4. 恢复流程](#4-恢复流程)
    - [4.1 标准恢复流程](#41-标准恢复流程)
    - [4.2 紧急恢复流程](#42-紧急恢复流程)
    - [4.3 PITR恢复流程](#43-pitr恢复流程)
    - [4.4 主从切换流程](#44-主从切换流程)
  - [5. 责任分工](#5-责任分工)
    - [5.1 角色定义](#51-角色定义)
    - [5.2 联系方式](#52-联系方式)
    - [5.3 应急响应团队](#53-应急响应团队)
  - [6. 测试与演练](#6-测试与演练)
    - [6.1 测试计划](#61-测试计划)
    - [6.2 演练流程](#62-演练流程)
    - [6.3 测试报告](#63-测试报告)
  - [7. 监控与告警](#7-监控与告警)
    - [7.1 监控指标](#71-监控指标)
    - [7.2 告警规则](#72-告警规则)
    - [7.3 故障检测](#73-故障检测)
  - [8. 计划模板](#8-计划模板)
    - [8.1 计划结构](#81-计划结构)
    - [8.2 检查清单](#82-检查清单)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

### 1.1 灾难恢复的重要性

灾难恢复计划（Disaster Recovery Plan, DRP）是确保在灾难发生时能够快速、有序恢复数据库服务的关键文档。

**核心价值**：

- **业务连续性**：确保关键业务不中断
- **数据安全**：保护数据不丢失
- **快速恢复**：最小化停机时间
- **合规要求**：满足行业监管要求

**灾难恢复成本**：

| 恢复时间 | 业务损失 | 恢复成本 |
|---------|---------|---------|
| < 1小时 | 低 | 高（主从自动切换） |
| 1-4小时 | 中 | 中（主从手动切换） |
| 4-24小时 | 高 | 低（备份恢复） |
| > 24小时 | 极高 | 极低（但业务损失巨大） |

### 1.2 RTO与RPO概念

**RTO (Recovery Time Objective)**：恢复时间目标

- **定义**：从灾难发生到系统恢复可用的最大允许时间
- **示例**：RTO = 1小时，意味着系统必须在1小时内恢复

**RPO (Recovery Point Objective)**：恢复点目标

- **定义**：允许丢失的数据量（时间窗口）
- **示例**：RPO = 15分钟，意味着最多丢失15分钟的数据

**RTO/RPO矩阵**：

| RTO/RPO | < 15分钟 | 15分钟-1小时 | 1-4小时 | > 4小时 |
|---------|---------|-------------|---------|---------|
| **< 1小时** | 主从自动切换+WAL同步 | 主从自动切换 | 主从手动切换 | 备份恢复 |
| **1-4小时** | 主从手动切换+WAL同步 | 主从手动切换 | 备份恢复 | 备份恢复 |
| **> 4小时** | 备份恢复+PITR | 备份恢复+PITR | 备份恢复 | 备份恢复 |

### 1.3 灾难类型分类

**灾难类型**：

1. **硬件故障**
   - 服务器故障
   - 存储故障
   - 网络故障

2. **软件故障**
   - 数据库崩溃
   - 数据损坏
   - 配置错误

3. **人为错误**
   - 误删除数据
   - 误操作
   - 恶意攻击

4. **自然灾害**
   - 火灾
   - 洪水
   - 地震

5. **网络攻击**
   - DDoS攻击
   - 数据泄露
   - 勒索软件

---

## 2. 计划制定

### 2.1 业务影响分析

**分析步骤**：

1. **识别关键业务系统**

   ```text
   - 列出所有数据库系统
   - 评估业务重要性
   - 确定关键系统列表
   ```

2. **评估业务影响**

   ```text
   - 停机时间影响
   - 数据丢失影响
   - 客户影响
   - 财务影响
   ```

3. **确定恢复优先级**

   ```text
   P0（最高优先级）：
   - 核心交易系统
   - 支付系统
   - 用户认证系统

   P1（高优先级）：
   - 订单系统
   - 库存系统

   P2（中优先级）：
   - 报表系统
   - 分析系统
   ```

4. **设定恢复目标**

   ```text
   P0系统：
   - RTO: < 15分钟
   - RPO: < 1分钟

   P1系统：
   - RTO: < 1小时
   - RPO: < 15分钟

   P2系统：
   - RTO: < 4小时
   - RPO: < 1小时
   ```

### 2.2 风险评估

**风险矩阵**：

| 风险类型 | 影响 | 概率 | 风险等级 | 应对措施 |
|---------|------|------|---------|---------|
| **硬件故障** | 高 | 中 | 高 | 主从复制、硬件冗余 |
| **数据损坏** | 高 | 低 | 中 | 备份恢复、数据校验 |
| **自然灾害** | 高 | 低 | 中 | 异地备份、多地域部署 |
| **人为错误** | 中 | 中 | 中 | 权限控制、审计日志 |
| **网络攻击** | 高 | 低 | 中 | 安全防护、入侵检测 |
| **软件故障** | 中 | 中 | 中 | 版本控制、测试流程 |

**风险评分**：

```text
风险评分 = 影响 × 概率

影响评分：
- 高：3分
- 中：2分
- 低：1分

概率评分：
- 高：3分
- 中：2分
- 低：1分

风险等级：
- 高风险：6-9分
- 中风险：4-5分
- 低风险：1-3分
```

### 2.3 恢复目标设定

**目标设定原则**：

1. **基于业务需求**
   - 业务连续性要求
   - 客户期望
   - 合规要求

2. **考虑成本效益**
   - 恢复成本
   - 业务损失
   - ROI分析

3. **技术可行性**
   - 技术能力
   - 基础设施
   - 预算限制

**目标设定示例**：

```yaml
恢复目标:
  核心交易系统:
    RTO: 15分钟
    RPO: 1分钟
    策略: 主从自动切换 + WAL同步
    成本: 高

  订单系统:
    RTO: 1小时
    RPO: 15分钟
    策略: 主从手动切换 + WAL归档
    成本: 中

  报表系统:
    RTO: 4小时
    RPO: 1小时
    策略: 备份恢复 + PITR
    成本: 低
```

---

## 3. 恢复策略

### 3.1 策略选择

**策略选择矩阵**：

| RTO/RPO | < 15分钟 | 15分钟-1小时 | 1-4小时 | > 4小时 |
|---------|---------|-------------|---------|---------|
| **< 1分钟** | 主从自动切换+WAL同步 | 主从自动切换 | 主从手动切换 | 备份恢复+PITR |
| **1-15分钟** | 主从自动切换 | 主从手动切换 | 备份恢复+PITR | 备份恢复+PITR |
| **15分钟-1小时** | 主从手动切换 | 备份恢复+PITR | 备份恢复+PITR | 备份恢复 |
| **> 1小时** | 备份恢复+PITR | 备份恢复+PITR | 备份恢复 | 备份恢复 |

**策略对比**：

| 策略 | RTO | RPO | 成本 | 复杂度 | 适用场景 |
|------|-----|-----|------|--------|---------|
| **主从自动切换** | < 1分钟 | < 1分钟 | 高 | 高 | 关键业务系统 |
| **主从手动切换** | 5-15分钟 | < 1分钟 | 中 | 中 | 重要业务系统 |
| **备份恢复+PITR** | 1-4小时 | < 15分钟 | 低 | 低 | 一般业务系统 |
| **备份恢复** | 4-24小时 | 1-24小时 | 极低 | 极低 | 非关键系统 |

### 3.2 备份策略

**3-2-1备份规则**：

- **3份数据**：原始数据 + 2份备份
- **2种介质**：本地 + 异地
- **1份离线**：至少1份离线备份

**完整备份策略**：

```bash
#!/bin/bash
# 每日全量备份脚本

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d)
RETENTION_DAYS=30

# 创建备份目录
mkdir -p ${BACKUP_DIR}/${DATE}

# 执行全量备份
pg_basebackup \
    -D ${BACKUP_DIR}/${DATE}/base \
    -Ft \
    -z \
    -P \
    -v \
    -U replicator \
    -h primary_host

# 压缩备份
tar -czf ${BACKUP_DIR}/${DATE}.tar.gz ${BACKUP_DIR}/${DATE}

# 上传到云存储
aws s3 cp ${BACKUP_DIR}/${DATE}.tar.gz s3://backup-bucket/postgresql/${DATE}.tar.gz

# 清理旧备份
find ${BACKUP_DIR} -type d -mtime +${RETENTION_DAYS} -exec rm -rf {} \;
```

**WAL归档配置**：

```sql
-- postgresql.conf
archive_mode = on
archive_command = 'test ! -f /backup/wal/%f && cp %p /backup/wal/%f'
wal_level = replica
max_wal_senders = 10
```

**备份验证**：

```bash
#!/bin/bash
# 备份验证脚本

BACKUP_FILE=$1

# 解压备份
tar -xzf ${BACKUP_FILE} -C /tmp/test_restore

# 验证备份完整性
pg_verifybackup -D /tmp/test_restore/base

# 清理测试目录
rm -rf /tmp/test_restore
```

### 3.3 复制策略

**流复制配置**：

```sql
-- 主库配置
-- postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

-- pg_hba.conf
host replication replicator 192.168.1.0/24 md5

-- 创建复制用户
CREATE USER replicator WITH REPLICATION PASSWORD 'password';
```

**主从切换脚本**：

```bash
#!/bin/bash
# 主从切换脚本

PRIMARY_HOST="primary.example.com"
STANDBY_HOST="standby.example.com"

# 1. 停止应用连接
# 2. 提升备库为主库
ssh postgres@${STANDBY_HOST} "pg_ctl promote -D /var/lib/postgresql/data"

# 3. 更新应用配置
# 4. 验证切换
# 5. 记录切换日志
```

### 3.4 存储策略

**存储层级**：

1. **本地存储**：快速恢复
   - NVMe SSD
   - 延迟：< 1ms
   - 用途：热备份

2. **网络存储**：中等恢复
   - NFS/SAN
   - 延迟：< 10ms
   - 用途：温备份

3. **云存储**：长期归档
   - S3/OSS
   - 延迟：< 100ms
   - 用途：冷备份

**存储策略示例**：

```yaml
存储策略:
  热备份:
    位置: 本地NVMe SSD
    保留期: 7天
    用途: 快速恢复

  温备份:
    位置: 网络存储
    保留期: 30天
    用途: 常规恢复

  冷备份:
    位置: 云存储
    保留期: 1年
    用途: 长期归档
```

---

## 4. 恢复流程

### 4.1 标准恢复流程

**完整恢复流程**：

```text
阶段1：发现与评估（0-5分钟）
├─ 1.1 发现故障
│   ├─ 监控告警
│   ├─ 用户报告
│   └─ 主动检查
├─ 1.2 评估影响
│   ├─ 影响范围
│   ├─ 业务影响
│   └─ 数据丢失
└─ 1.3 启动应急响应
    ├─ 通知团队
    ├─ 启动DRP
    └─ 分配任务

阶段2：决策与准备（5-15分钟）
├─ 2.1 选择恢复策略
│   ├─ 评估RTO/RPO
│   ├─ 选择策略
│   └─ 确认方案
├─ 2.2 准备恢复环境
│   ├─ 检查备用节点
│   ├─ 验证备份
│   └─ 准备工具
└─ 2.3 制定详细计划
    ├─ 恢复步骤
    ├─ 时间估算
    └─ 风险控制

阶段3：执行恢复（15分钟-4小时）
├─ 3.1 执行恢复操作
│   ├─ 主从切换
│   ├─ 备份恢复
│   └─ PITR恢复
├─ 3.2 数据验证
│   ├─ 数据完整性
│   ├─ 数据一致性
│   └─ 业务验证
└─ 3.3 服务恢复
    ├─ 应用连接
    ├─ 功能测试
    └─ 性能验证

阶段4：验证与总结（恢复后）
├─ 4.1 功能验证
│   ├─ 核心功能
│   ├─ 业务流程
│   └─ 性能指标
├─ 4.2 监控观察
│   ├─ 系统稳定性
│   ├─ 性能指标
│   └─ 错误日志
└─ 4.3 总结报告
    ├─ 故障原因
    ├─ 恢复过程
    └─ 改进建议
```

**恢复时间表**：

| 时间 | 操作 | 负责人 | 状态 |
|------|------|--------|------|
| 0分钟 | 发现故障 | 监控系统 | 自动 |
| 5分钟 | 评估影响 | DBA | 手动 |
| 10分钟 | 选择策略 | DBA+运维 | 手动 |
| 15分钟 | 开始恢复 | DBA | 手动 |
| 30分钟 | 恢复完成 | DBA | 手动 |
| 45分钟 | 验证完成 | 开发+测试 | 手动 |
| 60分钟 | 服务恢复 | 运维 | 手动 |

### 4.2 紧急恢复流程

**关键业务系统紧急流程**：

```text
步骤1：立即切换（< 1分钟）
├─ 检测主库故障
├─ 自动提升备库
└─ 更新DNS/负载均衡

步骤2：通知团队（1-2分钟）
├─ 发送告警
├─ 启动电话会议
└─ 分配任务

步骤3：验证服务（2-5分钟）
├─ 检查数据库状态
├─ 验证应用连接
└─ 测试核心功能

步骤4：数据验证（5-15分钟）
├─ 检查数据完整性
├─ 验证事务一致性
└─ 确认无数据丢失

步骤5：持续监控（15分钟+）
├─ 监控系统稳定性
├─ 观察性能指标
└─ 准备回滚方案
```

### 4.3 PITR恢复流程

**时间点恢复（Point-In-Time Recovery）**：

```bash
#!/bin/bash
# PITR恢复脚本

BACKUP_DIR="/backup/postgresql"
WAL_DIR="/backup/wal"
RESTORE_DIR="/var/lib/postgresql/data"
TARGET_TIME="2025-01-15 14:30:00"

# 1. 停止PostgreSQL
systemctl stop postgresql

# 2. 清理数据目录
rm -rf ${RESTORE_DIR}/*

# 3. 恢复基础备份
tar -xzf ${BACKUP_DIR}/20250115.tar.gz -C ${RESTORE_DIR}

# 4. 配置恢复参数
cat >> ${RESTORE_DIR}/postgresql.conf << EOF
restore_command = 'cp ${WAL_DIR}/%f %p'
recovery_target_time = '${TARGET_TIME}'
recovery_target_action = 'promote'
EOF

# 5. 创建恢复标记文件
touch ${RESTORE_DIR}/recovery.signal

# 6. 启动PostgreSQL
systemctl start postgresql

# 7. 验证恢复
psql -c "SELECT pg_is_in_recovery();"
```

**PITR恢复检查清单**：

- [ ] 确认目标时间点
- [ ] 验证基础备份可用
- [ ] 确认WAL归档完整
- [ ] 检查磁盘空间充足
- [ ] 配置恢复参数
- [ ] 执行恢复操作
- [ ] 验证数据完整性
- [ ] 测试应用功能

### 4.4 主从切换流程

**自动切换（使用Patroni/PgBouncer）**：

```yaml
# Patroni配置
scope: postgres-cluster
namespace: /db/
name: postgres-primary

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.10:8008

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
  initdb:
  - encoding: UTF8
  - data-checksums
  pg_hba:
  - host replication replicator 0.0.0.0/0 md5
  - host all all 0.0.0.0/0 md5

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.1.10:5432
  data_dir: /var/lib/postgresql/data
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: password
    superuser:
      username: postgres
      password: password
  parameters:
    wal_level: replica
    hot_standby: "on"
    max_connections: 100
    max_wal_senders: 10
    max_replication_slots: 10
```

**手动切换步骤**：

```bash
# 1. 检查主库状态
psql -h primary -c "SELECT pg_is_in_recovery();"

# 2. 停止主库写入
psql -h primary -c "SELECT pg_switch_wal();"

# 3. 提升备库
ssh standby "pg_ctl promote -D /var/lib/postgresql/data"

# 4. 更新应用配置
# 5. 验证切换
psql -h standby -c "SELECT pg_is_in_recovery();"
```

---

## 5. 责任分工

### 5.1 角色定义

**完整角色矩阵**：

| 角色 | 职责 | 技能要求 | 联系方式 |
|------|------|---------|---------|
| **DBA负责人** | 执行恢复操作、决策 | PostgreSQL专家 | 24/7待命 |
| **DBA成员** | 协助恢复、数据验证 | PostgreSQL中级 | 工作时间 |
| **运维负责人** | 准备环境、网络配置 | 系统运维专家 | 24/7待命 |
| **运维成员** | 监控系统、日志分析 | 系统运维中级 | 工作时间 |
| **开发负责人** | 验证数据、功能测试 | 应用开发专家 | 工作时间 |
| **开发成员** | 业务验证、性能测试 | 应用开发中级 | 工作时间 |
| **业务负责人** | 确认业务功能、决策 | 业务专家 | 工作时间 |
| **项目经理** | 协调资源、沟通 | 项目管理 | 工作时间 |

### 5.2 联系方式

**应急联系清单**：

```yaml
应急响应团队:
  一级响应（关键故障）:
    DBA负责人:
      电话: +86-138-xxxx-xxxx
      邮箱: dba-lead@example.com
      微信: dba-lead

    运维负责人:
      电话: +86-139-xxxx-xxxx
      邮箱: ops-lead@example.com
      微信: ops-lead

  二级响应（一般故障）:
    DBA成员:
      电话: +86-137-xxxx-xxxx
      邮箱: dba-team@example.com

    运维成员:
      电话: +86-136-xxxx-xxxx
      邮箱: ops-team@example.com

  三级响应（咨询支持）:
    开发团队:
      邮箱: dev-team@example.com

    业务团队:
      邮箱: business-team@example.com
```

**通知流程**：

```text
故障发现 → 一级响应（5分钟内）
         ↓
    评估影响
         ↓
    严重故障 → 二级响应（10分钟内）
         ↓
    启动DRP
         ↓
    通知所有相关人员（15分钟内）
```

### 5.3 应急响应团队

**团队结构**：

```text
应急响应团队
├─ 指挥组
│   ├─ 项目经理（总指挥）
│   ├─ DBA负责人（技术指挥）
│   └─ 业务负责人（业务决策）
│
├─ 技术组
│   ├─ DBA团队（数据库恢复）
│   ├─ 运维团队（基础设施）
│   └─ 开发团队（应用验证）
│
└─ 支持组
    ├─ 业务团队（业务验证）
    ├─ 测试团队（功能测试）
    └─ 沟通组（对外沟通）
```

**职责分工**：

- **指挥组**：决策、协调、沟通
- **技术组**：执行恢复、技术验证
- **支持组**：业务验证、功能测试

---

## 6. 测试与演练

### 6.1 测试计划

**测试类型**：

1. **备份验证测试**
   - 频率：每周
   - 内容：验证备份完整性、可恢复性
   - 方法：恢复测试环境、验证数据

2. **切换演练**
   - 频率：每月
   - 内容：主从切换、故障切换
   - 方法：模拟故障、执行切换

3. **完整恢复演练**
   - 频率：每季度
   - 内容：完整灾难恢复流程
   - 方法：模拟灾难场景、执行恢复

4. **压力测试**
   - 频率：每半年
   - 内容：恢复性能、RTO验证
   - 方法：大规模数据恢复测试

**测试计划表**：

| 测试类型 | 频率 | 负责人 | 预计时间 | 状态 |
|---------|------|--------|---------|------|
| 备份验证 | 每周 | DBA | 1小时 | 自动化 |
| 切换演练 | 每月 | DBA+运维 | 2小时 | 手动 |
| 完整演练 | 每季度 | 全团队 | 4小时 | 手动 |
| 压力测试 | 每半年 | DBA+测试 | 8小时 | 手动 |

### 6.2 演练流程

**演练步骤**：

```text
阶段1：准备（1周前）
├─ 制定演练计划
├─ 准备测试环境
├─ 通知相关人员
└─ 准备测试数据

阶段2：执行（演练日）
├─ 模拟故障场景
├─ 执行恢复流程
├─ 记录操作过程
└─ 测量恢复时间

阶段3：总结（演练后1周）
├─ 分析演练结果
├─ 识别问题
├─ 制定改进计划
└─ 更新DRP文档
```

**演练场景**：

1. **场景1：主库硬件故障**
   - 模拟：停止主库服务器
   - 目标：验证自动切换
   - RTO目标：< 1分钟

2. **场景2：数据损坏**
   - 模拟：删除关键表数据
   - 目标：验证PITR恢复
   - RPO目标：< 15分钟

3. **场景3：网络分区**
   - 模拟：断开主从网络
   - 目标：验证脑裂处理
   - 目标：数据一致性

### 6.3 测试报告

**报告模板**：

```markdown
# 灾难恢复演练报告

## 1. 演练信息
- 演练日期: 2025-01-15
- 演练类型: 完整恢复演练
- 参与人员: DBA团队、运维团队、开发团队

## 2. 演练过程
- 故障模拟: 主库硬件故障
- 恢复时间: 25分钟
- RTO目标: < 30分钟 ✅
- RPO实际: 2分钟
- RPO目标: < 5分钟 ✅

## 3. 发现的问题
1. 切换脚本需要优化
2. 监控告警延迟
3. 文档需要更新

## 4. 改进措施
1. 优化切换脚本（预计1周）
2. 改进监控告警（预计2周）
3. 更新DRP文档（预计1周）

## 5. 下次演练计划
- 日期: 2025-04-15
- 类型: 数据损坏恢复
- 准备: 提前2周通知
```

## 7. 监控与告警

### 7.1 监控指标

**关键监控指标**：

1. **数据库状态**
   - 主从复制延迟
   - 数据库连接数
   - 事务处理速率

2. **备份状态**
   - 备份成功率
   - 备份完成时间
   - 备份文件大小

3. **系统资源**
   - CPU使用率
   - 内存使用率
   - 磁盘使用率
   - 网络带宽

**监控SQL**：

```sql
-- 检查主从复制延迟
SELECT
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS replication_lag_bytes
FROM pg_stat_replication;

-- 检查备份状态
SELECT
    backup_name,
    backup_start_time,
    backup_end_time,
    backup_size
FROM pg_backup_history
ORDER BY backup_start_time DESC
LIMIT 10;
```

### 7.2 告警规则

**告警配置**：

```yaml
告警规则:
  主从延迟告警:
    条件: replication_lag > 1GB
    级别: Warning
    通知: DBA团队

  主库故障告警:
    条件: primary_status != 'running'
    级别: Critical
    通知: 应急响应团队

  备份失败告警:
    条件: backup_status == 'failed'
    级别: Warning
    通知: DBA团队

  磁盘空间告警:
    条件: disk_usage > 80%
    级别: Warning
    通知: 运维团队
```

### 7.3 故障检测

**自动故障检测**：

```bash
#!/bin/bash
# 故障检测脚本

PRIMARY_HOST="primary.example.com"
STANDBY_HOST="standby.example.com"

# 检查主库状态
if ! pg_isready -h ${PRIMARY_HOST}; then
    echo "Primary database is down!"
    # 发送告警
    send_alert "CRITICAL" "Primary database is down"
    # 启动切换流程
    execute_failover
fi

# 检查复制延迟
LAG=$(psql -h ${STANDBY_HOST} -t -c "SELECT pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) FROM pg_stat_replication")
if [ ${LAG} -gt 1073741824 ]; then
    echo "Replication lag is too high: ${LAG} bytes"
    send_alert "WARNING" "High replication lag"
fi
```

## 8. 计划模板

### 8.1 计划结构

**完整计划模板**：

```markdown
# [系统名称]灾难恢复计划

## 1. 系统信息
- 系统名称: [系统名称]
- 数据库版本: PostgreSQL 18
- 数据量: [数据量] GB
- 关键表: [关键表列表]
- 业务重要性: [P0/P1/P2]

## 2. 恢复目标
- RTO: < [时间]
- RPO: < [时间]
- 可用性目标: [99.9%/99.99%]

## 3. 恢复策略
- 策略类型: [主从自动切换/主从手动切换/备份恢复]
- 备份策略: [3-2-1规则]
- 复制策略: [流复制/逻辑复制]

## 4. 恢复流程
[详细恢复流程]

## 5. 责任分工
- DBA负责人: [姓名] [联系方式]
- 运维负责人: [姓名] [联系方式]
- 开发负责人: [姓名] [联系方式]

## 6. 测试计划
- 备份验证: [频率]
- 切换演练: [频率]
- 完整演练: [频率]

## 7. 监控告警
- 监控指标: [指标列表]
- 告警规则: [规则列表]

## 8. 附录
- 恢复脚本: [脚本路径]
- 联系方式: [联系清单]
- 相关文档: [文档链接]
```

### 8.2 检查清单

**DRP检查清单**：

- [ ] 系统信息完整
- [ ] 恢复目标明确
- [ ] 恢复策略可行
- [ ] 恢复流程详细
- [ ] 责任分工清晰
- [ ] 联系方式有效
- [ ] 测试计划制定
- [ ] 监控告警配置
- [ ] 文档定期更新
- [ ] 团队培训完成

---

## 📚 相关文档

- [灾难恢复完整指南.md](./灾难恢复完整指南.md) - 灾难恢复完整指南
- [RTO_RPO目标设定.md](./RTO_RPO目标设定.md) - RTO/RPO目标设定
- [灾难恢复演练.md](./灾难恢复演练.md) - 灾难恢复演练
- [13-高可用架构/README.md](../README.md) - 高可用架构主题

---

**最后更新**: 2025年1月
