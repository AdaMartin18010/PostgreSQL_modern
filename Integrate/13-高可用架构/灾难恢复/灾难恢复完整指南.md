# PostgreSQL灾难恢复完整指南

> **创建日期**: 2025年1月
> **技术版本**: PostgreSQL 17+/18+
> **难度等级**: ⭐⭐⭐⭐ 高级

---

## 📋 目录

- [PostgreSQL灾难恢复完整指南](#postgresql灾难恢复完整指南)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 恢复目标（RTO/RPO）](#2-恢复目标rtorpo)
    - [2.1 RTO（Recovery Time Objective）](#21-rtorecovery-time-objective)
    - [2.2 RPO（Recovery Point Objective）](#22-rporecovery-point-objective)
  - [3. 备份策略](#3-备份策略)
    - [3.1 全量备份](#31-全量备份)
    - [3.2 增量备份](#32-增量备份)
    - [3.3 备份计划](#33-备份计划)
  - [4. 恢复策略](#4-恢复策略)
    - [4.1 PITR（Point-in-Time Recovery）](#41-pitrpoint-in-time-recovery)
    - [4.2 主从切换](#42-主从切换)
    - [4.3 逻辑复制恢复](#43-逻辑复制恢复)
  - [5. 灾难恢复流程](#5-灾难恢复流程)
    - [5.1 恢复步骤](#51-恢复步骤)
    - [5.2 恢复检查清单](#52-恢复检查清单)
  - [6. 最佳实践](#6-最佳实践)
    - [✅ 推荐做法](#-推荐做法)
    - [❌ 避免做法](#-避免做法)
  - [📚 相关文档](#-相关文档)

---

## 1. 概述

灾难恢复是PostgreSQL高可用架构的重要组成部分。包括：

- **备份策略** - 全量备份、增量备份、WAL归档
- **恢复策略** - PITR、主从切换、逻辑复制
- **恢复目标** - RTO（恢复时间）、RPO（数据丢失）
- **恢复流程** - 标准化的恢复流程

---

## 2. 恢复目标（RTO/RPO）

### 2.1 RTO（Recovery Time Objective）

**定义**: 从灾难发生到系统恢复可用的最大时间

| RTO级别 | 时间 | 策略 |
|---------|------|------|
| **P0** | < 1分钟 | 主从自动切换 |
| **P1** | < 15分钟 | 主从手动切换 |
| **P2** | < 1小时 | 备份恢复 |
| **P3** | < 24小时 | 完整重建 |

### 2.2 RPO（Recovery Point Objective）

**定义**: 允许的最大数据丢失时间

| RPO级别 | 数据丢失 | 策略 |
|---------|---------|------|
| **P0** | 0丢失 | 同步复制 |
| **P1** | < 1分钟 | 异步复制 |
| **P2** | < 1小时 | WAL归档 |
| **P3** | < 24小时 | 定期备份 |

---

## 3. 备份策略

### 3.1 全量备份

```bash
#!/bin/bash
# 全量备份脚本（带错误处理）

set -euo pipefail

# 错误处理函数
error_exit() {
    echo "错误: $1" >&2
    exit 1
}

# 使用pg_basebackup（带错误处理）
BACKUP_DIR="/backup/base"
if [ ! -d "$(dirname "$BACKUP_DIR")" ]; then
    error_exit "备份目录的父目录不存在: $(dirname "$BACKUP_DIR")"
fi

if ! pg_basebackup -D "$BACKUP_DIR" -Ft -z -P; then
    error_exit "pg_basebackup失败"
fi

echo "pg_basebackup备份成功: $BACKUP_DIR"

# 使用pg_dump（带错误处理）
DB_NAME="mydb"
BACKUP_FILE="backup.dump"

if ! psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
    error_exit "数据库 $DB_NAME 不存在"
fi

if ! pg_dump -Fc "$DB_NAME" > "$BACKUP_FILE"; then
    error_exit "pg_dump失败"
fi

echo "pg_dump备份成功: $BACKUP_FILE"
```

### 3.2 增量备份

```bash
# WAL归档
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

### 3.3 备份计划

```bash
# 每日全量备份
0 2 * * * pg_basebackup -D /backup/base_$(date +\%Y\%m\%d) -Ft -z

# 持续WAL归档
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

---

## 4. 恢复策略

### 4.1 PITR（Point-in-Time Recovery）

```bash
#!/bin/bash
# PITR恢复脚本（带错误处理）

set -euo pipefail

# 错误处理函数
error_exit() {
    echo "错误: $1" >&2
    exit 1
}

DATA_DIR="/data"
BACKUP_WAL_DIR="/backup/wal"
RECOVERY_TARGET_TIME="2024-01-15 10:00:00"

# 1. 恢复基础备份（带错误处理）
if [ ! -d "$(dirname "$DATA_DIR")" ]; then
    error_exit "数据目录的父目录不存在: $(dirname "$DATA_DIR")"
fi

if ! pg_basebackup -D "$DATA_DIR" -Ft -z; then
    error_exit "pg_basebackup恢复基础备份失败"
fi

echo "基础备份恢复成功: $DATA_DIR"

# 2. 配置恢复（带错误处理）
POSTGRESQL_CONF="$DATA_DIR/postgresql.conf"
if [ ! -f "$POSTGRESQL_CONF" ]; then
    error_exit "postgresql.conf文件不存在: $POSTGRESQL_CONF"
fi

if [ ! -d "$BACKUP_WAL_DIR" ]; then
    error_exit "WAL备份目录不存在: $BACKUP_WAL_DIR"
fi

if ! echo "restore_command = 'cp $BACKUP_WAL_DIR/%f %p'" >> "$POSTGRESQL_CONF"; then
    error_exit "写入restore_command失败"
fi

if ! echo "recovery_target_time = '$RECOVERY_TARGET_TIME'" >> "$POSTGRESQL_CONF"; then
    error_exit "写入recovery_target_time失败"
fi

echo "恢复配置写入成功"

# 3. 启动恢复（带错误处理）
if ! pg_ctl start -D "$DATA_DIR"; then
    error_exit "pg_ctl启动恢复失败"
fi

echo "PITR恢复启动成功"
```

### 4.2 主从切换

```sql
-- 在主库执行（带错误处理）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_promote') THEN
        RAISE EXCEPTION 'pg_promote函数不存在';
    END IF;

    IF pg_is_in_recovery() THEN
        RAISE EXCEPTION '当前节点处于恢复模式（从库），无法执行pg_promote';
    END IF;

    PERFORM pg_promote();
    RAISE NOTICE '主库提升成功';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_promote函数不存在';
    WHEN OTHERS THEN
        RAISE EXCEPTION '主库提升失败: %', SQLERRM;
END $$;

-- 或手动切换（Bash脚本，带错误处理）
-- 1. 停止主库
-- 2. 提升从库
-- pg_ctl promote -D /data
```

### 4.3 逻辑复制恢复

```sql
-- 创建发布（带错误处理）
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_publication WHERE pubname = 'my_pub'
    ) THEN
        RAISE WARNING '发布my_pub已存在';
        RETURN;
    END IF;

    CREATE PUBLICATION my_pub FOR ALL TABLES;
    RAISE NOTICE '发布my_pub创建成功';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING '发布my_pub已存在';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION '权限不足，无法创建发布';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建发布失败: %', SQLERRM;
END $$;

-- 在目标库创建订阅（带错误处理）
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'my_sub'
    ) THEN
        RAISE WARNING '订阅my_sub已存在';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_publication WHERE pubname = 'my_pub'
    ) THEN
        RAISE EXCEPTION '发布my_pub不存在，请先在源库创建';
    END IF;

    CREATE SUBSCRIPTION my_sub
    CONNECTION 'host=source_db dbname=mydb'
    PUBLICATION my_pub;
    RAISE NOTICE '订阅my_sub创建成功';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING '订阅my_sub已存在';
    WHEN undefined_object THEN
        RAISE EXCEPTION '发布my_pub不存在';
    WHEN connection_exception THEN
        RAISE EXCEPTION '无法连接到源库，请检查连接字符串';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION '权限不足，无法创建订阅';
    WHEN OTHERS THEN
        RAISE EXCEPTION '创建订阅失败: %', SQLERRM;
END $$;
```

---

## 5. 灾难恢复流程

### 5.1 恢复步骤

```text
1. 评估灾难影响
   ↓
2. 选择恢复策略
   ↓
3. 执行恢复操作
   ↓
4. 验证数据完整性
   ↓
5. 恢复业务服务
   ↓
6. 记录恢复过程
```

### 5.2 恢复检查清单

- [ ] 确认灾难类型和影响范围
- [ ] 选择恢复策略（PITR/主从切换/备份恢复）
- [ ] 准备恢复环境
- [ ] 执行恢复操作
- [ ] 验证数据完整性
- [ ] 恢复业务服务
- [ ] 记录恢复过程

---

## 6. 最佳实践

### ✅ 推荐做法

1. **制定恢复计划** - 提前制定详细的恢复计划
2. **定期演练** - 定期进行灾难恢复演练
3. **多重备份** - 使用多种备份策略
4. **监控备份** - 监控备份状态和完整性
5. **文档化流程** - 详细记录恢复流程

### ❌ 避免做法

1. **不备份** - 必须定期备份
2. **不测试恢复** - 必须定期测试恢复
3. **单一备份** - 避免单一备份策略
4. **不监控** - 必须监控备份状态

---

## 📚 相关文档

- [灾难恢复方案.md](../灾难恢复方案.md) - 灾难恢复方案
- [备份与恢复/06.06-备份与恢复.md](../备份与恢复/06.06-备份与恢复.md) - 备份与恢复基础
- [04-存储与恢复/【深入】PostgreSQL备份恢复完善-PITR与灾备演练指南.md](../../04-存储与恢复/【深入】PostgreSQL备份恢复完善-PITR与灾备演练指南.md) - PITR指南
- [13-高可用架构/README.md](../README.md) - 高可用架构主题

---

**最后更新**: 2025年1月
