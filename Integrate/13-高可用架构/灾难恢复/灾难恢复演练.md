# ç¾éš¾æ¢å¤æ¼”ç»ƒæŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **éš¾åº¦ç­‰çº§**: â­â­â­â­ é«˜çº§

---

## ğŸ“‹ ç›®å½•

- [ç¾éš¾æ¢å¤æ¼”ç»ƒæŒ‡å—](#ç¾éš¾æ¢å¤æ¼”ç»ƒæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. æ¼”ç»ƒè®¡åˆ’](#2-æ¼”ç»ƒè®¡åˆ’)
    - [2.1 æ¼”ç»ƒé¢‘ç‡](#21-æ¼”ç»ƒé¢‘ç‡)
    - [2.2 æ¼”ç»ƒå‡†å¤‡](#22-æ¼”ç»ƒå‡†å¤‡)
  - [3. æ¼”ç»ƒåœºæ™¯](#3-æ¼”ç»ƒåœºæ™¯)
    - [3.1 åœºæ™¯ç±»å‹](#31-åœºæ™¯ç±»å‹)
    - [3.2 æ¼”ç»ƒåœºæ™¯è¯¦ç»†æ­¥éª¤](#32-æ¼”ç»ƒåœºæ™¯è¯¦ç»†æ­¥éª¤)
  - [4. æ¼”ç»ƒæ‰§è¡Œ](#4-æ¼”ç»ƒæ‰§è¡Œ)
    - [4.1 æ‰§è¡Œæ­¥éª¤](#41-æ‰§è¡Œæ­¥éª¤)
    - [4.2 æ‰§è¡Œæ£€æŸ¥æ¸…å•](#42-æ‰§è¡Œæ£€æŸ¥æ¸…å•)
    - [4.3 æ¼”ç»ƒæ‰§è¡Œè®°å½•](#43-æ¼”ç»ƒæ‰§è¡Œè®°å½•)
  - [5. æ¼”ç»ƒè¯„ä¼°](#5-æ¼”ç»ƒè¯„ä¼°)
    - [5.1 è¯„ä¼°æŒ‡æ ‡](#51-è¯„ä¼°æŒ‡æ ‡)
    - [5.2 æ”¹è¿›æªæ–½](#52-æ”¹è¿›æªæ–½)
    - [5.3 æ¼”ç»ƒæŠ¥å‘Šç”Ÿæˆ](#53-æ¼”ç»ƒæŠ¥å‘Šç”Ÿæˆ)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

ç¾éš¾æ¢å¤æ¼”ç»ƒæ˜¯éªŒè¯æ¢å¤è®¡åˆ’æœ‰æ•ˆæ€§çš„å…³é”®æ´»åŠ¨ã€‚

**æ¼”ç»ƒç›®æ ‡**:

- éªŒè¯æ¢å¤æµç¨‹
- æµ‹è¯•æ¢å¤æ—¶é—´
- å‘ç°æ½œåœ¨é—®é¢˜
- æå‡å›¢é˜Ÿèƒ½åŠ›

---

## 2. æ¼”ç»ƒè®¡åˆ’

### 2.1 æ¼”ç»ƒé¢‘ç‡

| ä¸šåŠ¡çº§åˆ« | æ¼”ç»ƒé¢‘ç‡ | æ¼”ç»ƒç±»å‹ |
|---------|---------|---------|
| **å…³é”®ä¸šåŠ¡** | å­£åº¦ | å®Œæ•´æ¼”ç»ƒ |
| **é‡è¦ä¸šåŠ¡** | åŠå¹´ | éƒ¨åˆ†æ¼”ç»ƒ |
| **ä¸€èˆ¬ä¸šåŠ¡** | å¹´åº¦ | æ¡Œé¢æ¼”ç»ƒ |

### 2.2 æ¼”ç»ƒå‡†å¤‡

**å‡†å¤‡æ­¥éª¤**ï¼š

```text
1. åˆ¶å®šæ¼”ç»ƒè®¡åˆ’
2. å‡†å¤‡æ¼”ç»ƒç¯å¢ƒ
3. é€šçŸ¥ç›¸å…³äººå‘˜
4. å‡†å¤‡æ¼”ç»ƒè„šæœ¬
5. è®¾å®šæ¼”ç»ƒç›®æ ‡
```

**æ¼”ç»ƒç¯å¢ƒå‡†å¤‡**ï¼š

```sql
-- åˆ›å»ºæ¼”ç»ƒç¯å¢ƒé…ç½®è¡¨
CREATE TABLE IF NOT EXISTS drill_environments (
    environment_id SERIAL PRIMARY KEY,
    environment_name VARCHAR(100) NOT NULL,
    environment_type VARCHAR(50),
    primary_host VARCHAR(200),
    standby_host VARCHAR(200),
    backup_location VARCHAR(500),
    network_config JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥æ¼”ç»ƒç¯å¢ƒé…ç½®
INSERT INTO drill_environments
(environment_name, environment_type, primary_host, standby_host, backup_location)
VALUES
('ç”Ÿäº§ç¯å¢ƒ', 'production', 'primary.prod.example.com', 'standby.prod.example.com', '/backup/prod'),
('æµ‹è¯•ç¯å¢ƒ', 'testing', 'primary.test.example.com', 'standby.test.example.com', '/backup/test'),
('æ¼”ç»ƒç¯å¢ƒ', 'drill', 'primary.drill.example.com', 'standby.drill.example.com', '/backup/drill');

-- éªŒè¯æ¼”ç»ƒç¯å¢ƒ
SELECT
    environment_name,
    environment_type,
    primary_host,
    standby_host,
    CASE
        WHEN primary_host IS NOT NULL AND standby_host IS NOT NULL THEN 'å°±ç»ª'
        ELSE 'æœªå°±ç»ª'
    END AS readiness_status
FROM drill_environments
WHERE environment_type = 'drill';
```

**æ¼”ç»ƒè„šæœ¬å‡†å¤‡**ï¼š

```bash
#!/bin/bash
# ç¾éš¾æ¢å¤æ¼”ç»ƒè„šæœ¬ç¤ºä¾‹

# é…ç½®å˜é‡
PRIMARY_HOST="primary.drill.example.com"
STANDBY_HOST="standby.drill.example.com"
BACKUP_DIR="/backup/drill"
LOG_FILE="/var/log/drill_$(date +%Y%m%d_%H%M%S).log"

# è®°å½•å¼€å§‹æ—¶é—´
echo "æ¼”ç»ƒå¼€å§‹æ—¶é—´: $(date)" >> $LOG_FILE

# æ­¥éª¤1: åœæ­¢ä¸»åº“
echo "æ­¥éª¤1: åœæ­¢ä¸»åº“æœåŠ¡"
ssh $PRIMARY_HOST "systemctl stop postgresql" >> $LOG_FILE 2>&1

# æ­¥éª¤2: éªŒè¯ä¸»åº“å·²åœæ­¢
echo "æ­¥éª¤2: éªŒè¯ä¸»åº“çŠ¶æ€"
if ! ssh $PRIMARY_HOST "systemctl is-active postgresql" | grep -q "inactive"; then
    echo "é”™è¯¯: ä¸»åº“æœªæˆåŠŸåœæ­¢" >> $LOG_FILE
    exit 1
fi

# æ­¥éª¤3: æå‡ä»åº“ä¸ºä¸»åº“
echo "æ­¥éª¤3: æå‡ä»åº“ä¸ºä¸»åº“"
ssh $STANDBY_HOST "sudo -u postgres /usr/pgsql-18/bin/pg_ctl promote -D /var/lib/pgsql/18/data" >> $LOG_FILE 2>&1

# æ­¥éª¤4: éªŒè¯æ–°ä¸»åº“çŠ¶æ€
echo "æ­¥éª¤4: éªŒè¯æ–°ä¸»åº“çŠ¶æ€"
if ssh $STANDBY_HOST "sudo -u postgres psql -c 'SELECT pg_is_in_recovery();'" | grep -q "f"; then
    echo "æˆåŠŸ: ä»åº“å·²æå‡ä¸ºä¸»åº“" >> $LOG_FILE
else
    echo "é”™è¯¯: ä»åº“æå‡å¤±è´¥" >> $LOG_FILE
    exit 1
fi

# æ­¥éª¤5: éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "æ­¥éª¤5: éªŒè¯æ•°æ®å®Œæ•´æ€§"
ssh $STANDBY_HOST "sudo -u postgres psql -c 'SELECT COUNT(*) FROM pg_stat_database;'" >> $LOG_FILE 2>&1

# è®°å½•ç»“æŸæ—¶é—´
echo "æ¼”ç»ƒç»“æŸæ—¶é—´: $(date)" >> $LOG_FILE
echo "æ¼”ç»ƒå®Œæˆï¼Œè¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹: $LOG_FILE"
```

---

## 3. æ¼”ç»ƒåœºæ™¯

### 3.1 åœºæ™¯ç±»å‹

**åœºæ™¯1: ä¸»åº“æ•…éšœ**:

```text
æ¨¡æ‹Ÿä¸»åº“æ•…éšœï¼Œåˆ‡æ¢åˆ°ä»åº“
- åœæ­¢ä¸»åº“æœåŠ¡
- æå‡ä»åº“ä¸ºä¸»åº“
- éªŒè¯æ•°æ®å®Œæ•´æ€§
- æ¢å¤åº”ç”¨è¿æ¥
```

**åœºæ™¯2: æ•°æ®æŸå**:

```text
æ¨¡æ‹Ÿæ•°æ®æŸåï¼Œä»å¤‡ä»½æ¢å¤
- æ¨¡æ‹Ÿæ•°æ®æŸå
- åœæ­¢æ•°æ®åº“æœåŠ¡
- ä»å¤‡ä»½æ¢å¤
- éªŒè¯æ•°æ®å®Œæ•´æ€§
```

**åœºæ™¯3: å¼‚åœ°ç¾éš¾**:

```text
æ¨¡æ‹Ÿå¼‚åœ°ç¾éš¾ï¼Œä»å¼‚åœ°å¤‡ä»½æ¢å¤
- æ¨¡æ‹Ÿä¸»ç«™ç‚¹æ•…éšœ
- ä»å¼‚åœ°å¤‡ä»½æ¢å¤
- å»ºç«‹æ–°ä¸»åº“
- æ¢å¤æœåŠ¡
```

**åœºæ™¯4: æ•°æ®æŸåæ¢å¤**:

```text
æ¨¡æ‹Ÿæ•°æ®æŸåï¼Œä»å¤‡ä»½æ¢å¤
- æ¨¡æ‹Ÿæ•°æ®æ–‡ä»¶æŸå
- åœæ­¢æ•°æ®åº“æœåŠ¡
- ä»å¤‡ä»½æ¢å¤æ•°æ®
- éªŒè¯æ•°æ®å®Œæ•´æ€§
- æ¢å¤æœåŠ¡
```

**åœºæ™¯5: ç½‘ç»œåˆ†åŒºæ¢å¤**:

```text
æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒºï¼Œå¤„ç†è„‘è£‚é—®é¢˜
- æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒº
- æ£€æµ‹è„‘è£‚æƒ…å†µ
- é€‰æ‹©ä¸»åº“
- æ¢å¤ç½‘ç»œè¿æ¥
- åŒæ­¥æ•°æ®
```

### 3.2 æ¼”ç»ƒåœºæ™¯è¯¦ç»†æ­¥éª¤

**ä¸»åº“æ•…éšœåˆ‡æ¢è¯¦ç»†æ­¥éª¤**ï¼š

```sql
-- æ­¥éª¤1: æ£€æµ‹ä¸»åº“æ•…éšœ
DO $$
DECLARE
    primary_status TEXT;
BEGIN
    -- å°è¯•è¿æ¥ä¸»åº“
    BEGIN
        PERFORM dblink_connect('primary_conn',
            'host=primary.prod.example.com port=5432 dbname=postgres user=monitor');
        primary_status := 'æ­£å¸¸';
        PERFORM dblink_disconnect('primary_conn');
    EXCEPTION
        WHEN OTHERS THEN
            primary_status := 'æ•…éšœ';
    END;

    IF primary_status = 'æ•…éšœ' THEN
        RAISE NOTICE 'ä¸»åº“æ•…éšœæ£€æµ‹: %', primary_status;
        -- è§¦å‘æ•…éšœåˆ‡æ¢æµç¨‹
    END IF;
END $$;

-- æ­¥éª¤2: æå‡ä»åº“ä¸ºä¸»åº“
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT pg_promote();

-- æ­¥éª¤3: éªŒè¯æ–°ä¸»åº“çŠ¶æ€
SELECT
    pg_is_in_recovery() AS is_recovery,
    pg_current_wal_lsn() AS current_lsn,
    now() AS promotion_time;

-- æ­¥éª¤4: æ›´æ–°åº”ç”¨è¿æ¥é…ç½®
-- æ›´æ–°è¿æ¥æ± é…ç½®æŒ‡å‘æ–°ä¸»åº“
-- æ›´æ–°DNSè®°å½•
-- é‡å¯åº”ç”¨æœåŠ¡

-- æ­¥éª¤5: éªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database
WHERE datname NOT IN ('template0', 'template1');
```

**æ•°æ®æŸåæ¢å¤è¯¦ç»†æ­¥éª¤**ï¼š

```sql
-- æ­¥éª¤1: æ£€æµ‹æ•°æ®æŸå
DO $$
DECLARE
    corruption_count INT;
BEGIN
    SELECT COUNT(*) INTO corruption_count
    FROM pg_stat_database
    WHERE checksum_failures > 0;

    IF corruption_count > 0 THEN
        RAISE WARNING 'æ£€æµ‹åˆ°æ•°æ®æŸå: % ä¸ªæ•°æ®åº“', corruption_count;
    END IF;
END $$;

-- æ­¥éª¤2: åœæ­¢æ•°æ®åº“æœåŠ¡
-- systemctl stop postgresql

-- æ­¥éª¤3: ä»å¤‡ä»½æ¢å¤
-- pg_basebackup -h backup_server -D /var/lib/pgsql/18/data -U replicator -P -Fp -R

-- æ­¥éª¤4: å¯åŠ¨æ•°æ®åº“æœåŠ¡
-- systemctl start postgresql

-- æ­¥éª¤5: éªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

---

## 4. æ¼”ç»ƒæ‰§è¡Œ

### 4.1 æ‰§è¡Œæ­¥éª¤

```text
1. å¯åŠ¨æ¼”ç»ƒ
   â†“
2. æ‰§è¡Œæ¢å¤æ“ä½œ
   â†“
3. è®°å½•æ‰§è¡Œè¿‡ç¨‹
   â†“
4. éªŒè¯æ¢å¤ç»“æœ
   â†“
5. æ¢å¤åŸå§‹çŠ¶æ€
   â†“
6. æ€»ç»“æ¼”ç»ƒ
```

### 4.2 æ‰§è¡Œæ£€æŸ¥æ¸…å•

- [ ] æ¼”ç»ƒç¯å¢ƒå‡†å¤‡å®Œæˆ
- [ ] ç›¸å…³äººå‘˜å·²é€šçŸ¥
- [ ] æ¼”ç»ƒè„šæœ¬å·²å‡†å¤‡
- [ ] ç›‘æ§å·¥å…·å·²é…ç½®
- [ ] æ¢å¤æ“ä½œå·²æ‰§è¡Œ
- [ ] æ•°æ®éªŒè¯å·²å®Œæˆ
- [ ] æ¼”ç»ƒè®°å½•å·²ä¿å­˜

### 4.3 æ¼”ç»ƒæ‰§è¡Œè®°å½•

**åˆ›å»ºæ¼”ç»ƒæ‰§è¡Œè®°å½•è¡¨**ï¼š

```sql
-- åˆ›å»ºæ¼”ç»ƒæ‰§è¡Œè®°å½•è¡¨
CREATE TABLE IF NOT EXISTS drill_execution_logs (
    log_id SERIAL PRIMARY KEY,
    drill_id INTEGER,
    drill_name VARCHAR(200),
    execution_date TIMESTAMPTZ DEFAULT NOW(),
    execution_steps JSONB,
    execution_duration INTERVAL,
    execution_status VARCHAR(20),
    issues_found TEXT[],
    lessons_learned TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è®°å½•æ¼”ç»ƒæ‰§è¡Œæ­¥éª¤
CREATE OR REPLACE FUNCTION log_drill_step(
    p_drill_id INTEGER,
    p_step_name VARCHAR(100),
    p_step_status VARCHAR(20),
    p_step_duration INTERVAL,
    p_step_notes TEXT DEFAULT NULL
)
RETURNS void AS $$
DECLARE
    v_steps JSONB;
BEGIN
    -- è·å–ç°æœ‰æ­¥éª¤è®°å½•
    SELECT execution_steps INTO v_steps
    FROM drill_execution_logs
    WHERE drill_id = p_drill_id
    ORDER BY execution_date DESC
    LIMIT 1;

    -- æ·»åŠ æ–°æ­¥éª¤
    IF v_steps IS NULL THEN
        v_steps := '[]'::JSONB;
    END IF;

    v_steps := v_steps || jsonb_build_object(
        'step_name', p_step_name,
        'step_status', p_step_status,
        'step_duration', p_step_duration::TEXT,
        'step_notes', p_step_notes,
        'step_time', NOW()::TEXT
    );

    -- æ›´æ–°æˆ–æ’å…¥è®°å½•
    INSERT INTO drill_execution_logs
    (drill_id, drill_name, execution_steps, execution_status)
    VALUES
    (p_drill_id, (SELECT drill_name FROM drill_plans WHERE drill_id = p_drill_id),
     v_steps, p_step_status)
    ON CONFLICT (log_id) DO UPDATE SET
        execution_steps = EXCLUDED.execution_steps,
        execution_status = EXCLUDED.execution_status;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT log_drill_step(1, 'åœæ­¢ä¸»åº“', 'æˆåŠŸ', INTERVAL '2 minutes', 'ä¸»åº“å·²æˆåŠŸåœæ­¢');
SELECT log_drill_step(1, 'æå‡ä»åº“', 'æˆåŠŸ', INTERVAL '5 minutes', 'ä»åº“å·²æå‡ä¸ºä¸»åº“');
SELECT log_drill_step(1, 'éªŒè¯æ•°æ®', 'æˆåŠŸ', INTERVAL '3 minutes', 'æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡');
```

**æ¼”ç»ƒæ‰§è¡Œç›‘æ§**ï¼š

```sql
-- å®æ—¶ç›‘æ§æ¼”ç»ƒæ‰§è¡ŒçŠ¶æ€
CREATE OR REPLACE VIEW drill_execution_status AS
SELECT
    d.drill_name,
    d.drill_type,
    d.next_drill_date,
    d.drill_status,
    l.execution_date,
    l.execution_duration,
    l.execution_status,
    jsonb_array_length(l.execution_steps) AS steps_completed,
    l.issues_found,
    l.lessons_learned
FROM drill_plans d
LEFT JOIN LATERAL (
    SELECT *
    FROM drill_execution_logs
    WHERE drill_id = d.drill_id
    ORDER BY execution_date DESC
    LIMIT 1
) l ON true;

-- æŸ¥è¯¢æ¼”ç»ƒæ‰§è¡ŒçŠ¶æ€
SELECT * FROM drill_execution_status
WHERE next_drill_date <= CURRENT_DATE + INTERVAL '1 month';
```

---

## 5. æ¼”ç»ƒè¯„ä¼°

### 5.1 è¯„ä¼°æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | å·®è· |
|------|------|------|------|
| **RTO** | < 1å°æ—¶ | xxx | xxx |
| **RPO** | < 15åˆ†é’Ÿ | xxx | xxx |
| **æ•°æ®å®Œæ•´æ€§** | 100% | xxx% | xxx% |
| **æœåŠ¡å¯ç”¨æ€§** | 100% | xxx% | xxx% |

### 5.2 æ”¹è¿›æªæ–½

**æ”¹è¿›æµç¨‹**ï¼š

```text
æ ¹æ®æ¼”ç»ƒç»“æœï¼š
1. è¯†åˆ«é—®é¢˜
2. åˆ†æåŸå› 
3. åˆ¶å®šæ”¹è¿›æªæ–½
4. æ›´æ–°æ¢å¤è®¡åˆ’
5. å®‰æ’ä¸‹æ¬¡æ¼”ç»ƒ
```

**é—®é¢˜è·Ÿè¸ªå’Œæ”¹è¿›**ï¼š

```sql
-- åˆ›å»ºé—®é¢˜è·Ÿè¸ªè¡¨
CREATE TABLE IF NOT EXISTS drill_issues (
    issue_id SERIAL PRIMARY KEY,
    drill_id INTEGER,
    issue_description TEXT NOT NULL,
    issue_severity VARCHAR(20),
    issue_category VARCHAR(50),
    root_cause TEXT,
    improvement_action TEXT,
    improvement_status VARCHAR(20),
    assigned_to VARCHAR(100),
    due_date DATE,
    resolved_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ’å…¥é—®é¢˜è®°å½•
INSERT INTO drill_issues
(drill_id, issue_description, issue_severity, issue_category, improvement_action, improvement_status)
VALUES
(1, 'æ•…éšœåˆ‡æ¢æ—¶é—´è¶…è¿‡RTOç›®æ ‡', 'é«˜', 'æ€§èƒ½é—®é¢˜', 'ä¼˜åŒ–æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢è„šæœ¬', 'è¿›è¡Œä¸­'),
(1, 'æ•°æ®éªŒè¯æ­¥éª¤è€—æ—¶è¿‡é•¿', 'ä¸­', 'æµç¨‹é—®é¢˜', 'ä¼˜åŒ–æ•°æ®éªŒè¯è„šæœ¬ï¼Œå¢åŠ å¹¶è¡ŒéªŒè¯', 'è®¡åˆ’ä¸­'),
(1, 'æ¼”ç»ƒç¯å¢ƒé…ç½®ä¸ä¸€è‡´', 'ä½', 'ç¯å¢ƒé—®é¢˜', 'æ ‡å‡†åŒ–æ¼”ç»ƒç¯å¢ƒé…ç½®', 'å·²å®Œæˆ');

-- æŸ¥è¯¢å¾…æ”¹è¿›é—®é¢˜
SELECT
    issue_description,
    issue_severity,
    improvement_action,
    improvement_status,
    due_date
FROM drill_issues
WHERE improvement_status IN ('è®¡åˆ’ä¸­', 'è¿›è¡Œä¸­')
ORDER BY
    CASE issue_severity
        WHEN 'é«˜' THEN 1
        WHEN 'ä¸­' THEN 2
        WHEN 'ä½' THEN 3
    END,
    due_date;
```

**æ”¹è¿›æ•ˆæœè¯„ä¼°**ï¼š

```sql
-- åˆ›å»ºæ”¹è¿›æ•ˆæœè¯„ä¼°è¡¨
CREATE TABLE IF NOT EXISTS improvement_effectiveness (
    improvement_id SERIAL PRIMARY KEY,
    issue_id INTEGER,
    improvement_description TEXT,
    before_metric NUMERIC,
    after_metric NUMERIC,
    improvement_percentage NUMERIC,
    evaluation_date DATE,
    evaluator VARCHAR(100),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è¯„ä¼°æ”¹è¿›æ•ˆæœ
INSERT INTO improvement_effectiveness
(issue_id, improvement_description, before_metric, after_metric, improvement_percentage, evaluation_date)
VALUES
(1, 'ä¼˜åŒ–æ•…éšœåˆ‡æ¢æ—¶é—´', 90, 45, 50.0, CURRENT_DATE),
(2, 'ä¼˜åŒ–æ•°æ®éªŒè¯æµç¨‹', 30, 15, 50.0, CURRENT_DATE);

-- æŸ¥è¯¢æ”¹è¿›æ•ˆæœ
SELECT
    i.issue_description,
    ie.improvement_description,
    ie.before_metric,
    ie.after_metric,
    ie.improvement_percentage,
    CASE
        WHEN ie.improvement_percentage >= 50 THEN 'ä¼˜ç§€'
        WHEN ie.improvement_percentage >= 30 THEN 'è‰¯å¥½'
        WHEN ie.improvement_percentage >= 10 THEN 'ä¸€èˆ¬'
        ELSE 'å¾…æ”¹è¿›'
    END AS effectiveness_level
FROM drill_issues i
JOIN improvement_effectiveness ie ON i.issue_id = ie.issue_id
ORDER BY ie.improvement_percentage DESC;
```

### 5.3 æ¼”ç»ƒæŠ¥å‘Šç”Ÿæˆ

**ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š**ï¼š

```sql
-- åˆ›å»ºæ¼”ç»ƒæŠ¥å‘Šè§†å›¾
CREATE OR REPLACE VIEW drill_reports AS
SELECT
    d.drill_id,
    d.drill_name,
    d.drill_type,
    d.drill_frequency,
    d.last_drill_date,
    d.next_drill_date,
    l.execution_date,
    l.execution_duration,
    l.execution_status,
    jsonb_array_length(l.execution_steps) AS total_steps,
    array_length(l.issues_found, 1) AS issues_count,
    (SELECT COUNT(*) FROM drill_issues WHERE drill_id = d.drill_id) AS total_issues,
    (SELECT COUNT(*) FROM drill_issues WHERE drill_id = d.drill_id AND improvement_status = 'å·²å®Œæˆ') AS resolved_issues
FROM drill_plans d
LEFT JOIN LATERAL (
    SELECT *
    FROM drill_execution_logs
    WHERE drill_id = d.drill_id
    ORDER BY execution_date DESC
    LIMIT 1
) l ON true;

-- ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š
SELECT
    drill_name,
    drill_type,
    execution_date,
    execution_duration,
    execution_status,
    total_steps,
    issues_count,
    total_issues,
    resolved_issues,
    CASE
        WHEN total_issues = 0 THEN 'æ— é—®é¢˜'
        WHEN resolved_issues::NUMERIC / NULLIF(total_issues, 0) >= 0.8 THEN 'è‰¯å¥½'
        WHEN resolved_issues::NUMERIC / NULLIF(total_issues, 0) >= 0.5 THEN 'ä¸€èˆ¬'
        ELSE 'éœ€æ”¹è¿›'
    END AS overall_status
FROM drill_reports
WHERE execution_date >= CURRENT_DATE - INTERVAL '6 months'
ORDER BY execution_date DESC;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç¾éš¾æ¢å¤å®Œæ•´æŒ‡å—.md](./ç¾éš¾æ¢å¤å®Œæ•´æŒ‡å—.md) - ç¾éš¾æ¢å¤å®Œæ•´æŒ‡å—
- [ç¾éš¾æ¢å¤è®¡åˆ’.md](./ç¾éš¾æ¢å¤è®¡åˆ’.md) - ç¾éš¾æ¢å¤è®¡åˆ’
- [RTO_RPOç›®æ ‡è®¾å®š.md](./RTO_RPOç›®æ ‡è®¾å®š.md) - RTO/RPOç›®æ ‡è®¾å®š
- [13-é«˜å¯ç”¨æ¶æ„/README.md](../README.md) - é«˜å¯ç”¨æ¶æ„ä¸»é¢˜

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
