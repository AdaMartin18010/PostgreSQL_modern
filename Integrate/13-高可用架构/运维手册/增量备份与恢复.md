---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\å¢é‡å¤‡ä»½ä¸æ¢å¤.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šå¢é‡å¤‡ä»½ä¸æ¢å¤ï¼ˆPostgreSQL 18ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½æ–‡æ¡£ï¼š`../å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md`

---

## ğŸ“‹ ç›®å½•

- [Runbookï¼šå¢é‡å¤‡ä»½ä¸æ¢å¤ï¼ˆPostgreSQL 18ï¼‰](#runbookå¢é‡å¤‡ä»½ä¸æ¢å¤postgresql-18)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç›®æ ‡](#ç›®æ ‡)
  - [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
    - [å‰ç½®é…ç½®](#å‰ç½®é…ç½®)
  - [æ­¥éª¤](#æ­¥éª¤)
    - [æ­¥éª¤1: åŸºç¡€å…¨é‡å¤‡ä»½](#æ­¥éª¤1-åŸºç¡€å…¨é‡å¤‡ä»½)
    - [æ­¥éª¤2: å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18ï¼‰](#æ­¥éª¤2-å¢é‡å¤‡ä»½postgresql-18)
    - [æ­¥éª¤3: å¤‡ä»½éªŒè¯](#æ­¥éª¤3-å¤‡ä»½éªŒè¯)
    - [æ­¥éª¤4: æ¢å¤å‡†å¤‡](#æ­¥éª¤4-æ¢å¤å‡†å¤‡)
    - [æ­¥éª¤5: æ‰§è¡Œæ¢å¤](#æ­¥éª¤5-æ‰§è¡Œæ¢å¤)
    - [æ­¥éª¤6: æ¢å¤éªŒè¯](#æ­¥éª¤6-æ¢å¤éªŒè¯)
  - [éªŒè¯æ¸…å•](#éªŒè¯æ¸…å•)
    - [å®Œæ•´éªŒè¯æµç¨‹](#å®Œæ•´éªŒè¯æµç¨‹)
  - [è‡ªåŠ¨åŒ–è„šæœ¬](#è‡ªåŠ¨åŒ–è„šæœ¬)
    - [å…¨é‡å¤‡ä»½è„šæœ¬](#å…¨é‡å¤‡ä»½è„šæœ¬)
    - [å¢é‡å¤‡ä»½è„šæœ¬](#å¢é‡å¤‡ä»½è„šæœ¬)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [è¯¦ç»†æœ€ä½³å®è·µ](#è¯¦ç»†æœ€ä½³å®è·µ)
  - [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
    - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [äº¤å‰å¼•ç”¨](#äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ç›®æ ‡

åˆ©ç”¨ PostgreSQL 18 çš„å¢é‡å¤‡ä»½åŠŸèƒ½ä¸ WAL å½’æ¡£ï¼Œæ„å»ºé«˜æ•ˆã€å¯æ¼”ç»ƒçš„å¤‡ä»½æ¢å¤æµç¨‹ï¼Œå®ç° RTO/RPO ç›®æ ‡ã€‚

## å‰ç½®æ¡ä»¶

- PostgreSQL 18+ ç‰ˆæœ¬
- é…ç½® WAL å½’æ¡£ï¼ˆarchive_modeã€archive_commandï¼‰
- é…ç½® WAL Summarizerï¼ˆPostgreSQL 18 é»˜è®¤å¯ç”¨ï¼‰
- å¤‡ä»½å­˜å‚¨ç©ºé—´è§„åˆ’
- ç›‘æ§å‘Šè­¦é…ç½®

### å‰ç½®é…ç½®

```sql
-- 1. å¯ç”¨WALå½’æ¡£
-- postgresql.conf
archive_mode = on
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'
wal_level = replica

-- 2. éªŒè¯WAL SummarizerçŠ¶æ€ï¼ˆPostgreSQL 18ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    summarizer_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_wal_summarizer'
    ) THEN
        RAISE WARNING 'pg_stat_wal_summarizerè§†å›¾ä¸å­˜åœ¨ï¼ˆå¯èƒ½éœ€è¦PostgreSQL 18+ï¼‰';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO summarizer_count
    FROM pg_stat_wal_summarizer;

    IF summarizer_count > 0 THEN
        RAISE NOTICE 'WAL Summarizerå·²å¯ç”¨ï¼Œå‘ç° % æ¡è®°å½•', summarizer_count;
    ELSE
        RAISE NOTICE 'WAL Summarizeræœªå¯ç”¨æˆ–æœªå‘ç°è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_wal_summarizerè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 18+ï¼‰';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯WAL SummarizerçŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_wal_summarizer;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- 3. æ£€æŸ¥å½’æ¡£çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    archiver_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_archiver'
    ) THEN
        RAISE WARNING 'pg_stat_archiverè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO archiver_count
    FROM pg_stat_archiver;

    IF archiver_count > 0 THEN
        RAISE NOTICE 'å½’æ¡£çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œå‘ç° % æ¡è®°å½•', archiver_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å½’æ¡£è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_archiverè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å½’æ¡£çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_archiver;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

## æ­¥éª¤

### æ­¥éª¤1: åŸºç¡€å…¨é‡å¤‡ä»½

```bash
# åˆ›å»ºå…¨é‡å¤‡ä»½ï¼ˆä½œä¸ºå¢é‡å¤‡ä»½çš„åŸºå‡†ï¼‰
pg_basebackup \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -v \
    -F plain

# è®°å½•å¤‡ä»½LSNï¼ˆç”¨äºåç»­å¢é‡å¤‡ä»½ï¼‰
psql -c "SELECT pg_current_wal_lsn();" > /backup/base/backup_lsn.txt

# éªŒè¯å¤‡ä»½
ls -lh /backup/base/
```

### æ­¥éª¤2: å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18ï¼‰

```bash
# PostgreSQL 18å¢é‡å¤‡ä»½
pg_basebackup \
    -D /backup/incremental/$(date +%Y%m%d_%H%M%S) \
    --incremental \
    --incremental-base=/backup/base/20241122_020000 \
    -X stream \
    -P \
    -v \
    -F plain

# å¢é‡å¤‡ä»½é€‰é¡¹è¯´æ˜ï¼š
# --incremental: å¯ç”¨å¢é‡å¤‡ä»½
# --incremental-base: æŒ‡å®šåŸºå‡†å¤‡ä»½è·¯å¾„
# -X stream: åŒæ—¶å¤‡ä»½WALæ–‡ä»¶
# -P: æ˜¾ç¤ºè¿›åº¦
# -v: è¯¦ç»†è¾“å‡º
```

### æ­¥éª¤3: å¤‡ä»½éªŒè¯

```bash
# 1. æ£€æŸ¥å¤‡ä»½ç›®å½•ç»“æ„
ls -lh /backup/incremental/

# 2. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
pg_checksums -D /backup/incremental/20241122_120000 --check

# 3. æ£€æŸ¥å¤‡ä»½å¤§å°
du -sh /backup/incremental/20241122_120000

# 4. éªŒè¯WALæ–‡ä»¶
ls -lh /backup/incremental/20241122_120000/pg_wal/
```

### æ­¥éª¤4: æ¢å¤å‡†å¤‡

```bash
# 1. åœæ­¢PostgreSQLæœåŠ¡ï¼ˆå¦‚æœæ¢å¤ï¼‰
systemctl stop postgresql

# 2. å¤‡ä»½å½“å‰æ•°æ®ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
mv /var/lib/postgresql/data /var/lib/postgresql/data.old

# 3. å‡†å¤‡æ¢å¤ç›®å½•
mkdir -p /var/lib/postgresql/data
```

### æ­¥éª¤5: æ‰§è¡Œæ¢å¤

```bash
# æ–¹æ³•1: ä»å…¨é‡å¤‡ä»½æ¢å¤
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ–¹æ³•2: ä»å¢é‡å¤‡ä»½æ¢å¤ï¼ˆéœ€è¦å…ˆæ¢å¤åŸºå‡†å¤‡ä»½ï¼‰
# æ­¥éª¤1: æ¢å¤åŸºå‡†å¤‡ä»½
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ­¥éª¤2: åº”ç”¨å¢é‡å¤‡ä»½
rsync -av /backup/incremental/20241122_120000/ /var/lib/postgresql/data/

# 3. é…ç½®æ¢å¤å‚æ•°
cat > /var/lib/postgresql/data/postgresql.auto.conf <<EOF
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2024-11-22 12:00:00'  # å¯é€‰ï¼šæ—¶é—´ç‚¹æ¢å¤
# recovery_target_lsn = '0/1234567'  # å¯é€‰ï¼šLSNæ¢å¤
# recovery_target_name = 'backup_point'  # å¯é€‰ï¼šå‘½åæ¢å¤ç‚¹
EOF

# 4. åˆ›å»ºæ¢å¤ä¿¡å·æ–‡ä»¶
touch /var/lib/postgresql/data/recovery.signal

# 5. å¯åŠ¨PostgreSQL
systemctl start postgresql

# 6. ç›‘æ§æ¢å¤è¿›åº¦
tail -f /var/log/postgresql/postgresql.log
```

### æ­¥éª¤6: æ¢å¤éªŒè¯

```sql
-- 1. æ£€æŸ¥æ¢å¤çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_in_recovery BOOLEAN;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_is_in_recovery') THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_is_in_recovery() INTO is_in_recovery;
    IF is_in_recovery THEN
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹å¤„äºæ¢å¤æ¨¡å¼';
    ELSE
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹å·²é€€å‡ºæ¢å¤æ¨¡å¼';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ¢å¤çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- 2. éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO table_count
    FROM pg_stat_user_tables;

    IF table_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç”¨æˆ·è¡¨', table_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç”¨æˆ·è¡¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯æ•°æ®ä¸€è‡´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_live_tup
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 3. æ£€æŸ¥æ¢å¤ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_standby BOOLEAN;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_is_in_recovery') THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_is_in_recovery() INTO is_standby;
    IF NOT is_standby THEN
        RAISE WARNING 'å½“å‰èŠ‚ç‚¹ä¸æ˜¯ä»åº“ï¼Œæ— æ³•æ£€æŸ¥æ¢å¤ç‚¹';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_last_wal_replay_lsn') THEN
        RAISE EXCEPTION 'pg_last_wal_replay_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_last_wal_replay_timestamp') THEN
        RAISE EXCEPTION 'pg_last_wal_replay_timestampå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥æ¢å¤ç‚¹';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ¢å¤ç‚¹å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_last_wal_replay_lsn(),
    pg_last_wal_replay_timestamp();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- 4. ä¸šåŠ¡æ•°æ®éªŒè¯ï¼ˆç¤ºä¾‹ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    orders_count BIGINT;
    users_count BIGINT;
    max_created_at TIMESTAMP;
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        SELECT COUNT(*), MAX(created_at) INTO orders_count, max_created_at FROM orders;
        RAISE NOTICE 'ordersè¡¨è®°å½•æ•°: %, æœ€æ–°åˆ›å»ºæ—¶é—´: %', orders_count, max_created_at;
    ELSE
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯';
    END IF;

    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'users'
    ) THEN
        SELECT COUNT(*) INTO users_count FROM users;
        RAISE NOTICE 'usersè¡¨è®°å½•æ•°: %', users_count;
    ELSE
        RAISE WARNING 'è¡¨usersä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ä¸šåŠ¡æ•°æ®éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM users;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT MAX(created_at) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

-- 5. å®Œæˆæ¢å¤ï¼ˆå¦‚æœä½¿ç”¨recovery.signalï¼‰
-- æ¢å¤å®Œæˆåï¼ŒPostgreSQLä¼šè‡ªåŠ¨é‡å‘½årecovery.signalä¸ºrecovery.done
```

## éªŒè¯æ¸…å•

- å¤‡ä»½å¯è¯»ã€æ ¡éªŒé€šè¿‡ï¼ˆhash/å¤§å°/ç›®å½•ç»“æ„ï¼‰
- æ¢å¤åç³»ç»Ÿä¸€è‡´ï¼ˆç³»ç»Ÿè¡¨ä¸ä¸šåŠ¡è¡¨è®¡æ•°/æŠ½æ ·å¯¹æ¯”ï¼‰
- ç›‘æ§äº‹ä»¶å®Œæ•´ï¼ˆå¤‡ä»½æ—¶é•¿ã€WAL é‡ã€é”™è¯¯æ—¥å¿—ï¼‰
- RTO/RPO è¾¾æ ‡å¹¶ç•™å­˜è®°å½•

### å®Œæ•´éªŒè¯æµç¨‹

**å¤‡ä»½éªŒè¯**:

```bash
# 1. å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥
pg_checksums -D /backup/base/20241122_020000 --check

# 2. å¤‡ä»½å¤§å°éªŒè¯
du -sh /backup/base/20241122_020000
du -sh /backup/incremental/20241122_120000

# 3. å¤‡ä»½æ¸…å•éªŒè¯
cat /backup/base/20241122_020000/backup_manifest
```

**æ¢å¤éªŒè¯**:

```sql
-- 1. ç³»ç»Ÿä¸€è‡´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    class_count BIGINT;
    attribute_count BIGINT;
BEGIN
    SELECT COUNT(*) INTO class_count FROM pg_class;
    SELECT COUNT(*) INTO attribute_count FROM pg_attribute;
    RAISE NOTICE 'ç³»ç»Ÿä¸€è‡´æ€§æ£€æŸ¥: pg_classè®°å½•æ•°=%, pg_attributeè®°å½•æ•°=%', class_count, attribute_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_classæˆ–pg_attributeè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç³»ç»Ÿä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM pg_class;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM pg_attribute;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Aggregate

-- 2. ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    orders_count BIGINT;
    users_count BIGINT;
    max_created_at TIMESTAMP;
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        SELECT COUNT(*), MAX(created_at) INTO orders_count, max_created_at FROM orders;
        RAISE NOTICE 'ordersè¡¨è®°å½•æ•°: %, æœ€æ–°åˆ›å»ºæ—¶é—´: %', orders_count, max_created_at;
    ELSE
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯';
    END IF;

    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'users'
    ) THEN
        SELECT COUNT(*) INTO users_count FROM users;
        RAISE NOTICE 'usersè¡¨è®°å½•æ•°: %', users_count;
    ELSE
        RAISE WARNING 'è¡¨usersä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM users;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT MAX(created_at) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

-- 3. æ•°æ®æŠ½æ ·éªŒè¯
SELECT * FROM orders ORDER BY created_at DESC LIMIT 10;
```

**RTO/RPOè®°å½•**:

```sql
-- åˆ›å»ºRTO/RPOè®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'backup_rto_rpo_log'
    ) THEN
        CREATE TABLE backup_rto_rpo_log (
            log_id SERIAL PRIMARY KEY,
            backup_time TIMESTAMP,
            recovery_time TIMESTAMP,
            rto_seconds INTEGER,
            rpo_bytes BIGINT,
            rpo_time_seconds INTEGER,
            backup_type VARCHAR(20),  -- 'full', 'incremental'
            recovery_type VARCHAR(20),  -- 'full', 'pitr'
            status VARCHAR(20)  -- 'success', 'failed', 'partial'
        );
        RAISE NOTICE 'RTO/RPOè®°å½•è¡¨backup_rto_rpo_logåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'RTO/RPOè®°å½•è¡¨backup_rto_rpo_logå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'RTO/RPOè®°å½•è¡¨backup_rto_rpo_logå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºRTO/RPOè®°å½•è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•RTO/RPOï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'backup_rto_rpo_log'
    ) THEN
        RAISE EXCEPTION 'è¡¨backup_rto_rpo_logä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    INSERT INTO backup_rto_rpo_log (
        backup_time,
        recovery_time,
        rto_seconds,
        rpo_bytes,
        backup_type,
        recovery_type,
        status
    )
    VALUES (
        '2024-11-22 02:00:00',
        '2024-11-22 02:05:00',
        300,  -- RTO: 5åˆ†é’Ÿ
        0,    -- RPO: 0å­—èŠ‚
        'incremental',
        'full',
        'success'
    )
    RETURNING log_id INTO inserted_id;

    IF inserted_id IS NOT NULL THEN
        RAISE NOTICE 'RTO/RPOè®°å½•æ’å…¥æˆåŠŸï¼Œlog_id: %', inserted_id;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨backup_rto_rpo_logä¸å­˜åœ¨';
    WHEN check_violation THEN
        RAISE WARNING 'RTO/RPOè®°å½•è¿åçº¦æŸæ¡ä»¶';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥RTO/RPOè®°å½•å¤±è´¥: %', SQLERRM;
END $$;
```

## è‡ªåŠ¨åŒ–è„šæœ¬

### å…¨é‡å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# full_backup.sh

BACKUP_BASE="/backup/base"
BACKUP_DIR="${BACKUP_BASE}/$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/postgresql/backup.log"

echo "$(date): Starting full backup to ${BACKUP_DIR}" >> ${LOG_FILE}

pg_basebackup \
    -D ${BACKUP_DIR} \
    -X stream \
    -P \
    -v \
    -F plain \
    2>&1 | tee -a ${LOG_FILE}

if [ $? -eq 0 ]; then
    psql -t -c "SELECT pg_current_wal_lsn();" > ${BACKUP_DIR}/backup_lsn.txt
    echo "$(date): Backup completed: ${BACKUP_DIR}" >> ${LOG_FILE}
    find ${BACKUP_BASE} -type d -mtime +7 -exec rm -rf {} \;
else
    echo "$(date): Backup failed!" >> ${LOG_FILE}
    exit 1
fi
```

### å¢é‡å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# incremental_backup.sh

BACKUP_BASE="/backup/base"
BACKUP_INCREMENTAL="/backup/incremental"
LATEST_BASE=$(ls -td ${BACKUP_BASE}/*/ | head -1)
BACKUP_DIR="${BACKUP_INCREMENTAL}/$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/postgresql/backup.log"

if [ -z "${LATEST_BASE}" ]; then
    echo "$(date): No base backup found, running full backup first" >> ${LOG_FILE}
    /usr/local/bin/full_backup.sh
    LATEST_BASE=$(ls -td ${BACKUP_BASE}/*/ | head -1)
fi

echo "$(date): Starting incremental backup to ${BACKUP_DIR}" >> ${LOG_FILE}

pg_basebackup \
    -D ${BACKUP_DIR} \
    --incremental \
    --incremental-base=${LATEST_BASE} \
    -X stream \
    -P \
    -v \
    -F plain \
    2>&1 | tee -a ${LOG_FILE}

if [ $? -eq 0 ]; then
    echo "$(date): Incremental backup completed: ${BACKUP_DIR}" >> ${LOG_FILE}
    find ${BACKUP_INCREMENTAL} -type d -mtime +30 -exec rm -rf {} \;
else
    echo "$(date): Incremental backup failed!" >> ${LOG_FILE}
    exit 1
fi
```

## æœ€ä½³å®è·µ

1. **å¤‡ä»½ç­–ç•¥**: å‘¨å…¨é‡ + æ—¥å¢é‡
2. **ä¿ç•™ç­–ç•¥**: å…¨é‡å¤‡ä»½ä¿ç•™7å¤©ï¼Œå¢é‡å¤‡ä»½ä¿ç•™30å¤©
3. **éªŒè¯é¢‘ç‡**: æ¯å‘¨æ‰§è¡Œä¸€æ¬¡æ¢å¤æ¼”ç»ƒ
4. **ç›‘æ§å‘Šè­¦**: å¤‡ä»½å¤±è´¥ã€æ¢å¤æ—¶é—´è¿‡é•¿ã€RPOè¶…æ ‡
5. **æ–‡æ¡£è®°å½•**: è®°å½•æ¯æ¬¡å¤‡ä»½å’Œæ¢å¤çš„RTO/RPOæŒ‡æ ‡

### è¯¦ç»†æœ€ä½³å®è·µ

**å¤‡ä»½ç­–ç•¥é€‰æ‹©**:

```bash
# ç­–ç•¥1: å‘¨å…¨é‡ + æ—¥å¢é‡ï¼ˆæ¨èç”¨äºå¤§å‹æ•°æ®åº“ï¼‰
# æ¯å‘¨æ—¥ï¼šå…¨é‡å¤‡ä»½
0 2 * * 0 /usr/local/bin/full_backup.sh

# æ¯å¤©ï¼šå¢é‡å¤‡ä»½
0 2 * * 1-6 /usr/local/bin/incremental_backup.sh

# ç­–ç•¥2: æœˆå…¨é‡ + æ—¥å¢é‡ï¼ˆæ¨èç”¨äºè¶…å¤§å‹æ•°æ®åº“ï¼‰
# æ¯æœˆ1å·ï¼šå…¨é‡å¤‡ä»½
0 2 1 * * /usr/local/bin/full_backup.sh

# æ¯å¤©ï¼šå¢é‡å¤‡ä»½
0 2 * * * /usr/local/bin/incremental_backup.sh
```

**ä¿ç•™ç­–ç•¥é…ç½®**:

```bash
# è‡ªåŠ¨åŒ–æ¸…ç†è„šæœ¬
#!/bin/bash
# cleanup_backups.sh

BACKUP_BASE="/backup/base"
BACKUP_INCREMENTAL="/backup/incremental"

# å…¨é‡å¤‡ä»½ï¼šä¿ç•™7å¤©
find ${BACKUP_BASE} -type d -mtime +7 -exec rm -rf {} \;

# å¢é‡å¤‡ä»½ï¼šä¿ç•™30å¤©
find ${BACKUP_INCREMENTAL} -type d -mtime +30 -exec rm -rf {} \;

# è®°å½•æ¸…ç†æ“ä½œ
echo "$(date): Cleaned up old backups" >> /var/log/postgresql/backup.log
```

**ç›‘æ§å‘Šè­¦é…ç½®**:

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: backup_monitoring
    rules:
      - alert: BackupFailed
        expr: pg_backup_status{status="failed"} == 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "å¤‡ä»½å¤±è´¥å‘Šè­¦"
          description: "å¤‡ä»½ä»»åŠ¡å¤±è´¥: {{ $labels.backup_type }}"

      - alert: BackupTooOld
        expr: (time() - pg_backup_last_success_time) > 86400  # 24å°æ—¶
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "å¤‡ä»½è¿‡æœŸå‘Šè­¦"
          description: "ä¸Šæ¬¡æˆåŠŸå¤‡ä»½æ—¶é—´: {{ $value }}ç§’å‰"
```

**RTO/RPOè®°å½•**:

```sql
-- åˆ›å»ºå¤‡ä»½è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'backup_records'
    ) THEN
        CREATE TABLE backup_records (
            backup_id SERIAL PRIMARY KEY,
            backup_time TIMESTAMP DEFAULT NOW(),
            backup_type VARCHAR(20),  -- 'full', 'incremental'
            backup_path TEXT,
            backup_size_bytes BIGINT,
            backup_duration_seconds INTEGER,
            rto_seconds INTEGER,
            rpo_bytes BIGINT,
            backup_status VARCHAR(20)  -- 'success', 'failed'
        );
        RAISE NOTICE 'å¤‡ä»½è®°å½•è¡¨backup_recordsåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'å¤‡ä»½è®°å½•è¡¨backup_recordså·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'å¤‡ä»½è®°å½•è¡¨backup_recordså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¤‡ä»½è®°å½•è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•å¤‡ä»½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'backup_records'
    ) THEN
        RAISE EXCEPTION 'è¡¨backup_recordsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    INSERT INTO backup_records (
        backup_type,
        backup_path,
        backup_size_bytes,
        backup_duration_seconds,
        backup_status
    ) VALUES (
        'incremental',
        '/backup/incremental/20241122_120000',
        1073741824,  -- 1GB
        300,  -- 5åˆ†é’Ÿ
        'success'
    )
    RETURNING backup_id INTO inserted_id;

    IF inserted_id IS NOT NULL THEN
        RAISE NOTICE 'å¤‡ä»½è®°å½•æ’å…¥æˆåŠŸï¼Œbackup_id: %', inserted_id;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨backup_recordsä¸å­˜åœ¨';
    WHEN check_violation THEN
        RAISE WARNING 'å¤‡ä»½è®°å½•è¿åçº¦æŸæ¡ä»¶';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥å¤‡ä»½è®°å½•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥è¯¢RTO/RPOè¶‹åŠ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    trend_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'backup_records'
    ) THEN
        RAISE WARNING 'è¡¨backup_recordsä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥è¯¢RTO/RPOè¶‹åŠ¿';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO trend_count
    FROM backup_records
    WHERE backup_status = 'success';

    IF trend_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡æˆåŠŸçš„å¤‡ä»½è®°å½•', trend_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æˆåŠŸçš„å¤‡ä»½è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨backup_recordsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢RTO/RPOè¶‹åŠ¿å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    DATE(backup_time) as backup_date,
    backup_type,
    AVG(rto_seconds) as avg_rto,
    AVG(rpo_bytes) as avg_rpo
FROM backup_records
WHERE backup_status = 'success'
GROUP BY DATE(backup_time), backup_type
ORDER BY backup_date DESC;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè®°å½•æ•°é‡ï¼‰
-- è®¡åˆ’: GroupAggregate -> Sort -> Seq Scan
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**é—®é¢˜1: å¢é‡å¤‡ä»½å¤±è´¥ - manifestæ–‡ä»¶ç¼ºå¤±**:

```bash
# æ£€æŸ¥manifestæ–‡ä»¶
ls -lh /backup/base/*/backup_manifest

# è§£å†³æ–¹æ³•ï¼šé‡æ–°åˆ›å»ºå…¨é‡å¤‡ä»½
pg_basebackup -D /backup/base/$(date +%Y%m%d) -X stream -F plain
```

**é—®é¢˜2: WAL Summarizeræœªè¿è¡Œ**:

```sql
-- æ£€æŸ¥WAL SummarizerçŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    summarizer_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_wal_summarizer'
    ) THEN
        RAISE WARNING 'pg_stat_wal_summarizerè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 18+ï¼‰';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO summarizer_count
    FROM pg_stat_wal_summarizer;

    IF summarizer_count > 0 THEN
        RAISE NOTICE 'WAL Summarizerå·²å¯ç”¨ï¼Œå‘ç° % æ¡è®°å½•', summarizer_count;
    ELSE
        RAISE NOTICE 'WAL Summarizeræœªå¯ç”¨æˆ–æœªå‘ç°è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_wal_summarizerè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 18+ï¼‰';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥WAL SummarizerçŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_stat_wal_summarizer;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- å¦‚æœä¸ºç©ºï¼Œæ£€æŸ¥é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    wal_level_val TEXT;
    archive_mode_val TEXT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_settings'
    ) THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT setting INTO wal_level_val
    FROM pg_settings
    WHERE name = 'wal_level';

    SELECT setting INTO archive_mode_val
    FROM pg_settings
    WHERE name = 'archive_mode';

    RAISE NOTICE 'wal_level: %, archive_mode: %', wal_level_val, archive_mode_val;

    IF wal_level_val NOT IN ('replica', 'logical') THEN
        RAISE WARNING 'wal_levelåº”è¯¥æ˜¯replicaæˆ–logicalï¼Œå½“å‰å€¼: %', wal_level_val;
    END IF;

    IF archive_mode_val != 'on' THEN
        RAISE WARNING 'archive_modeåº”è¯¥æ˜¯onï¼Œå½“å‰å€¼: %', archive_mode_val;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥é…ç½®å¤±è´¥: %', SQLERRM;
END $$;
```

**é—®é¢˜3: æ¢å¤æ—¶ç¼ºå°‘WALæ–‡ä»¶**:

```bash
# æ£€æŸ¥WALå½’æ¡£
ls -lh /archive/ | head -20

# æ£€æŸ¥æ¢å¤é…ç½®
cat /var/lib/postgresql/data/postgresql.auto.conf | grep restore_command

# æ‰‹åŠ¨å¤åˆ¶ç¼ºå¤±çš„WALæ–‡ä»¶
cp /archive/000000010000000000000001 /var/lib/postgresql/data/pg_wal/
```

---

## äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [å¢é‡å¤‡ä»½ä¸æ¢å¤](../å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - è¯¦ç»†å¢é‡å¤‡ä»½æŒ‡å—
- â­â­â­ [å¤‡ä»½ä¸æ¢å¤](../å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å®Œæ•´å¤‡ä»½æ¢å¤æŒ‡å—
- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§ç†è®ºåŸºç¡€
- â­ [PostgreSQL 18æ–°ç‰¹æ€§](../../18-ç‰ˆæœ¬ç‰¹æ€§/02.01-PostgreSQL-18-æ–°ç‰¹æ€§.md) - å¢é‡å¤‡ä»½æ–°ç‰¹æ€§

### å¤–éƒ¨èµ„æº

- [PostgreSQLå¤‡ä»½æ–‡æ¡£](https://www.postgresql.org/docs/current/backup.html)
- [pg_basebackupæ–‡æ¡£](https://www.postgresql.org/docs/current/app-pgbasebackup.html)
- [PostgreSQL 18å¢é‡å¤‡ä»½](https://www.postgresql.org/docs/18/backup-incremental.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
