---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\01-æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)

---

## ğŸ“‹ ç›®å½•

- [æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯ï¼ˆRunbookï¼‰](#æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. å‰ç½®æ£€æŸ¥](#2-å‰ç½®æ£€æŸ¥)
    - [2.1 ä¸šåŠ¡çª—å£ç¡®è®¤](#21-ä¸šåŠ¡çª—å£ç¡®è®¤)
    - [2.2 å¤‡ä»½å‡†å¤‡](#22-å¤‡ä»½å‡†å¤‡)
    - [2.3 å›æ»šè„šæœ¬å‡†å¤‡](#23-å›æ»šè„šæœ¬å‡†å¤‡)
    - [2.4 æŒ‡æ ‡é¢æ¿å‡†å¤‡](#24-æŒ‡æ ‡é¢æ¿å‡†å¤‡)
    - [2.5 å˜æ›´å‰æ£€æŸ¥æ¸…å•](#25-å˜æ›´å‰æ£€æŸ¥æ¸…å•)
  - [3. è¯Šæ–­å…¥å£](#3-è¯Šæ–­å…¥å£)
    - [3.1 è¯Šæ–­SQLè„šæœ¬](#31-è¯Šæ–­sqlè„šæœ¬)
    - [3.2 é—®é¢˜å®šä½æµç¨‹](#32-é—®é¢˜å®šä½æµç¨‹)
  - [4. å˜æ›´ç¥¨æ®æ¨¡æ¿](#4-å˜æ›´ç¥¨æ®æ¨¡æ¿)
    - [4.1 å˜æ›´è®°å½•è¡¨](#41-å˜æ›´è®°å½•è¡¨)
    - [4.2 å˜æ›´ç¥¨æ®æ¨¡æ¿ï¼ˆè¯¦ç»†ï¼‰](#42-å˜æ›´ç¥¨æ®æ¨¡æ¿è¯¦ç»†)
    - [4.3 å˜æ›´å®¡æ‰¹æµç¨‹](#43-å˜æ›´å®¡æ‰¹æµç¨‹)
  - [5. æ‰§è¡Œæ­¥éª¤](#5-æ‰§è¡Œæ­¥éª¤)
    - [5.1 å˜æ›´å‰å®¡è®¡è„šæœ¬](#51-å˜æ›´å‰å®¡è®¡è„šæœ¬)
    - [5.2 å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬](#52-å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬)
    - [5.3 ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬](#53-ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬)
    - [5.4 è§‚å¯ŸæœŸç›‘æ§è„šæœ¬](#54-è§‚å¯ŸæœŸç›‘æ§è„šæœ¬)
  - [6. å¸¸ç”¨å‚æ•°å»ºè®®ï¼ˆè¯¦ç»†ï¼‰](#6-å¸¸ç”¨å‚æ•°å»ºè®®è¯¦ç»†)
    - [6.1 è¿æ¥ä¸å¹¶å‘å‚æ•°](#61-è¿æ¥ä¸å¹¶å‘å‚æ•°)
    - [6.2 ç¼“å†²å‚æ•°](#62-ç¼“å†²å‚æ•°)
    - [6.3 å¹¶è¡Œå’ŒJITå‚æ•°](#63-å¹¶è¡Œå’Œjitå‚æ•°)
    - [6.4 I/Oå‚æ•°](#64-ioå‚æ•°)
    - [6.5 æ£€æŸ¥ç‚¹å’ŒWALå‚æ•°](#65-æ£€æŸ¥ç‚¹å’Œwalå‚æ•°)
    - [6.6 ç»´æŠ¤å‚æ•°](#66-ç»´æŠ¤å‚æ•°)
    - [6.7 å‚æ•°å˜æ›´æ£€æŸ¥æ¸…å•](#67-å‚æ•°å˜æ›´æ£€æŸ¥æ¸…å•)
  - [7. éªŒè¯æ¸…å•](#7-éªŒè¯æ¸…å•)
    - [7.1 éªŒè¯è„šæœ¬](#71-éªŒè¯è„šæœ¬)
    - [7.2 éªŒè¯æ ‡å‡†](#72-éªŒè¯æ ‡å‡†)
  - [8. å›æ»šä¸å¤ç›˜](#8-å›æ»šä¸å¤ç›˜)
    - [8.1 å›æ»šè„šæœ¬](#81-å›æ»šè„šæœ¬)
    - [8.2 å¤ç›˜æ¨¡æ¿](#82-å¤ç›˜æ¨¡æ¿)
    - [8.3 å¤ç›˜æŸ¥è¯¢](#83-å¤ç›˜æŸ¥è¯¢)

---

## 1. ç›®æ ‡

- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä»¥æœ€å°é£é™©å®Œæˆå‚æ•°/SQL/ç»“æ„ä¼˜åŒ–ï¼Œå½¢æˆâ€œç›‘æµ‹â†’è¯Šæ–­â†’å®šä½â†’å˜æ›´â†’éªŒè¯â†’å›æ»š/å›ºåŒ–â€çš„é—­ç¯ã€‚
- å¯¹é½æ–‡æ¡£ï¼š`../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md`ã€`../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md`ã€‚

## 2. å‰ç½®æ£€æŸ¥

- ä¸šåŠ¡çª—å£ï¼šç¡®è®¤ç°åº¦èŒƒå›´ä¸ä½å³°æ—¶æ®µï¼›
- å¤‡ä»½/å›æ»šï¼šé…ç½®å¤‡ä»½ç‚¹/å¿«ç…§ï¼›å‡†å¤‡å›æ»šè„šæœ¬ï¼ˆå‚æ•°æ—§å€¼ã€DDL å›æ»šæ–¹æ¡ˆï¼‰ã€‚
- æŒ‡æ ‡é¢æ¿ï¼šP95/P99ã€TPS/QPSã€å‘½ä¸­ç‡ã€WAL é€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€é”ç­‰å¾…ã€Autovacuum æ»åã€‚

### 2.1 ä¸šåŠ¡çª—å£ç¡®è®¤

```bash
# æ£€æŸ¥å½“å‰ä¸šåŠ¡è´Ÿè½½
psql -c "
SELECT
    date_trunc('hour', now()) as hour,
    COUNT(*) as active_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_queries
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY 1
ORDER BY 1 DESC
LIMIT 24;
"

# ç¡®è®¤ä½å³°æ—¶æ®µï¼ˆç¤ºä¾‹ï¼šå‡Œæ™¨2-6ç‚¹ï¼‰
LOW_TRAFFIC_WINDOW="02:00-06:00"

# æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨ä½å³°çª—å£
CURRENT_HOUR=$(date +%H)
if [ "${CURRENT_HOUR}" -ge 2 ] && [ "${CURRENT_HOUR}" -lt 6 ]; then
    echo "å½“å‰å¤„äºä½å³°æ—¶æ®µï¼Œå¯ä»¥è¿›è¡Œå˜æ›´"
else
    echo "è­¦å‘Šï¼šå½“å‰ä¸åœ¨ä½å³°æ—¶æ®µï¼Œå»ºè®®åœ¨ä½å³°æ—¶æ®µæ‰§è¡Œå˜æ›´"
fi
```

### 2.2 å¤‡ä»½å‡†å¤‡

```bash
# 1. åˆ›å»ºå‚æ•°å¤‡ä»½
psql -c "
SELECT name, setting, source
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'max_connections')
ORDER BY name;
" > /tmp/pg_params_backup_$(date +%Y%m%d_%H%M%S).txt

# 2. åˆ›å»ºé…ç½®å¤‡ä»½
cp $PGDATA/postgresql.conf $PGDATA/postgresql.conf.backup_$(date +%Y%m%d_%H%M%S)

# 3. åˆ›å»ºæ‰§è¡Œè®¡åˆ’åŸºçº¿
psql -c "
SELECT queryid, query, plan
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
" > /tmp/query_plans_baseline_$(date +%Y%m%d_%H%M%S).txt

# 4. åˆ›å»ºæ•°æ®åº“å¿«ç…§ï¼ˆå¦‚æœæ”¯æŒï¼‰
# pg_dump -F c -d mydb -f mydb_backup_$(date +%Y%m%d_%H%M%S).dump
```

### 2.3 å›æ»šè„šæœ¬å‡†å¤‡

```bash
# åˆ›å»ºå›æ»šè„šæœ¬æ¨¡æ¿
cat > /tmp/rollback_script_$(date +%Y%m%d_%H%M%S).sh <<'EOF'
#!/bin/bash
# å›æ»šè„šæœ¬

# 1. æ¢å¤å‚æ•°
psql -c "ALTER SYSTEM SET shared_buffers = '256MB';"
psql -c "SELECT pg_reload_conf();"

# 2. æ¢å¤é…ç½®
# cp $PGDATA/postgresql.conf.backup_* $PGDATA/postgresql.conf

# 3. åˆ é™¤æ–°åˆ›å»ºçš„ç´¢å¼•ï¼ˆå¦‚æœå˜æ›´æ¶‰åŠç´¢å¼•ï¼‰
# DROP INDEX CONCURRENTLY IF EXISTS idx_new_name;
EOF

chmod +x /tmp/rollback_script_*.sh
```

### 2.4 æŒ‡æ ‡é¢æ¿å‡†å¤‡

```sql
-- åˆ›å»ºæ€§èƒ½åŸºçº¿è§†å›¾
CREATE OR REPLACE VIEW performance_baseline AS
SELECT
    NOW() as baseline_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries,
    (SELECT SUM(total_exec_time) FROM pg_stat_statements) as total_exec_time,
    (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
     FROM pg_stat_database WHERE datname = current_database()) as cache_hit_ratio,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type IS NOT NULL) as waiting_queries;

-- åˆ›å»ºæ€§èƒ½ç›‘æ§è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_metrics'
    ) THEN
        CREATE TABLE performance_metrics (
            metric_id SERIAL PRIMARY KEY,
            metric_time TIMESTAMP DEFAULT NOW(),
            active_queries INTEGER,
            total_exec_time NUMERIC,
            cache_hit_ratio NUMERIC,
            waiting_queries INTEGER,
            tps NUMERIC,
            qps NUMERIC
        );
        RAISE NOTICE 'è¡¨performance_metricsåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨performance_metricså·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨performance_metricså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ€§èƒ½ç›‘æ§è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•å½“å‰æ€§èƒ½æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    active_queries INT;
    total_exec_time NUMERIC;
    cache_hit_ratio NUMERIC;
    waiting_queries INT;
    tps_count INT;
    qps_count BIGINT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_metrics'
    ) THEN
        RAISE EXCEPTION 'è¡¨performance_metricsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO active_queries
    FROM pg_stat_activity
    WHERE state = 'active';

    SELECT COALESCE(SUM(total_exec_time), 0) INTO total_exec_time
    FROM pg_stat_statements;

    SELECT COALESCE(
        SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100,
        0
    ) INTO cache_hit_ratio
    FROM pg_stat_database
    WHERE datname = current_database();

    SELECT COUNT(*) INTO waiting_queries
    FROM pg_stat_activity
    WHERE wait_event_type IS NOT NULL;

    SELECT COUNT(*) INTO tps_count
    FROM pg_stat_database
    WHERE datname = current_database();

    SELECT COALESCE(SUM(calls), 0) INTO qps_count
    FROM pg_stat_statements;

    INSERT INTO performance_metrics (
        active_queries,
        total_exec_time,
        cache_hit_ratio,
        waiting_queries,
        tps,
        qps
    ) VALUES (
        active_queries,
        total_exec_time,
        cache_hit_ratio,
        waiting_queries,
        tps_count,
        qps_count
    );

    RAISE NOTICE 'æ€§èƒ½æŒ‡æ ‡è®°å½•æˆåŠŸ: æ´»è·ƒæŸ¥è¯¢=%, æ€»æ‰§è¡Œæ—¶é—´=%, ç¼“å­˜å‘½ä¸­ç‡=%, ç­‰å¾…æŸ¥è¯¢=%, TPS=%, QPS=%',
        active_queries, total_exec_time, cache_hit_ratio, waiting_queries, tps_count, qps_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨performance_metricsæˆ–ç›¸å…³è§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•æ€§èƒ½æŒ‡æ ‡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active'),
    (SELECT SUM(total_exec_time) FROM pg_stat_statements),
    (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
     FROM pg_stat_database WHERE datname = current_database()),
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type IS NOT NULL),
    (SELECT COUNT(*) FROM pg_stat_database WHERE datname = current_database()),
    (SELECT SUM(calls) FROM pg_stat_statements);
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: SubPlan
```

### 2.5 å˜æ›´å‰æ£€æŸ¥æ¸…å•

```bash
# å®Œæ•´æ£€æŸ¥æ¸…å•è„šæœ¬
cat > /tmp/pre_change_checklist.sh <<'EOF'
#!/bin/bash

echo "=== å˜æ›´å‰æ£€æŸ¥æ¸…å• ==="

# 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
if ! psql -c "SELECT 1;" > /dev/null 2>&1; then
    echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
    exit 1
else
    echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
fi

# 2. æ£€æŸ¥å½“å‰è´Ÿè½½
ACTIVE_QUERIES=$(psql -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active';")
if [ "${ACTIVE_QUERIES}" -gt 10 ]; then
    echo "âš ï¸  å½“å‰æ´»è·ƒæŸ¥è¯¢æ•°: ${ACTIVE_QUERIES}ï¼Œå»ºè®®åœ¨ä½å³°æ—¶æ®µæ‰§è¡Œ"
else
    echo "âœ… å½“å‰æ´»è·ƒæŸ¥è¯¢æ•°: ${ACTIVE_QUERIES}"
fi

# 3. æ£€æŸ¥é•¿äº‹åŠ¡
LONG_TXNS=$(psql -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE state != 'idle' AND NOW() - xact_start > INTERVAL '5 minutes';")
if [ "${LONG_TXNS}" -gt 0 ]; then
    echo "âš ï¸  å­˜åœ¨é•¿äº‹åŠ¡: ${LONG_TXNS} ä¸ª"
else
    echo "âœ… æ— é•¿äº‹åŠ¡"
fi

# 4. æ£€æŸ¥é”ç­‰å¾…
LOCK_WAITS=$(psql -t -c "SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type = 'Lock';")
if [ "${LOCK_WAITS}" -gt 5 ]; then
    echo "âš ï¸  é”ç­‰å¾…æ•°: ${LOCK_WAITS}ï¼Œå»ºè®®ç­‰å¾…é”é‡Šæ”¾åå†æ‰§è¡Œå˜æ›´"
else
    echo "âœ… é”ç­‰å¾…æ•°: ${LOCK_WAITS}"
fi

# 5. æ£€æŸ¥å¤‡ä»½çŠ¶æ€
if [ -f "$PGDATA/postgresql.conf.backup_*" ]; then
    echo "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½"
else
    echo "âš ï¸  é…ç½®æ–‡ä»¶æœªå¤‡ä»½ï¼Œå»ºè®®å…ˆå¤‡ä»½"
fi

echo "=== æ£€æŸ¥å®Œæˆ ==="
EOF

chmod +x /tmp/pre_change_checklist.sh
/tmp/pre_change_checklist.sh
```

## 3. è¯Šæ–­å…¥å£

1) æ…¢æŸ¥è¯¢/ååä¸‹é™/å»¶è¿Ÿå‡é«˜å‘Šè­¦è§¦å‘ï¼›
2) æ‰§è¡Œ `sql/diagnostics.sql` ä¸­ TopN + ç­‰å¾…äº‹ä»¶ï¼›
3) å¯¹ç–‘ä¼¼è¯­å¥ `EXPLAIN (ANALYZE, BUFFERS, VERBOSE)`ï¼›
4) è¯„ä¼°ç­–ç•¥ï¼šç´¢å¼•/ç»Ÿè®¡/SQL/å‚æ•°/æ¶æ„ã€‚

### 3.1 è¯Šæ–­SQLè„šæœ¬

**å®Œæ•´è¯Šæ–­è„šæœ¬** (`sql/diagnostics.sql`):

```sql
-- ============================================
-- PostgreSQL æ€§èƒ½è¯Šæ–­è„šæœ¬
-- ============================================

-- 1. å½“å‰æ´»è·ƒä¼šè¯å’Œç­‰å¾…äº‹ä»¶
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query_start,
    state_change,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- 2. Top 10 æ…¢æŸ¥è¯¢ï¼ˆéœ€è¦pg_stat_statementsæ‰©å±•ï¼‰
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    round(mean_exec_time::numeric, 2) as mean_ms,
    round(max_exec_time::numeric, 2) as max_ms,
    round((100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0))::numeric, 2) as hit_ratio,
    rows
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. é”ç­‰å¾…æƒ…å†µ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 4. ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    datname,
    round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as hit_ratio
FROM pg_stat_database
GROUP BY datname;

-- 5. è¡¨æ‰«æç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    round(100.0 * idx_scan / NULLIF(seq_scan + idx_scan, 0), 2) as idx_scan_ratio,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio
FROM pg_stat_user_tables
WHERE seq_scan + idx_scan > 0
ORDER BY seq_scan DESC
LIMIT 20;

-- 6. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND pg_relation_size(indexname::regclass) > 1000000
ORDER BY pg_relation_size(indexname::regclass) DESC;

-- 7. WALå’Œæ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend
FROM pg_stat_bgwriter;

-- 8. AutovacuumçŠ¶æ€
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    n_dead_tup,
    n_live_tup
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

### 3.2 é—®é¢˜å®šä½æµç¨‹

**æ€§èƒ½é—®é¢˜å®šä½å†³ç­–æ ‘**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT wait_event_type, wait_event, COUNT(*) as count
FROM pg_stat_activity
WHERE state != 'idle'
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- å¦‚æœç­‰å¾…äº‹ä»¶æ˜¯ï¼š
-- - I/O: æ£€æŸ¥ç¼“å†²åŒºå‘½ä¸­ç‡ã€ç£ç›˜I/Oæ€§èƒ½
-- - Lock: æ£€æŸ¥é”ç­‰å¾…ã€æ­»é”
-- - CPU: æ£€æŸ¥æ…¢æŸ¥è¯¢ã€ç´¢å¼•ä½¿ç”¨æƒ…å†µ
-- - LWLock: æ£€æŸ¥WALå†™å…¥ã€æ£€æŸ¥ç‚¹

-- æ­¥éª¤2: åˆ†ææ…¢æŸ¥è¯¢
SELECT query, calls, mean_exec_time, max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´>100ms
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æ­¥éª¤3: å¯¹æ…¢æŸ¥è¯¢æ‰§è¡ŒEXPLAIN
-- EXPLAIN (ANALYZE, BUFFERS, VERBOSE) <æ…¢æŸ¥è¯¢SQL>;

-- æ­¥éª¤4: æ ¹æ®EXPLAINç»“æœé€‰æ‹©ä¼˜åŒ–ç­–ç•¥
-- - Seq Scan: è€ƒè™‘åˆ›å»ºç´¢å¼•
-- - é«˜cost: è€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
-- - é«˜buffers: è€ƒè™‘å¢åŠ shared_buffers
```

## 4. å˜æ›´ç¥¨æ®æ¨¡æ¿

```text
å˜æ›´é¡¹ï¼š<å‚æ•°/SQL/ç´¢å¼•/ç»“æ„>
å¯¹è±¡/èŒƒå›´ï¼š<åº“/è¡¨/ç´¢å¼•/æœåŠ¡>
æ—§å€¼â†’æ–°å€¼ï¼š<ä»> â†’ <åˆ°>
é¢„æœŸå½±å“ï¼š<å»¶è¿Ÿ/åå/èµ„æº>
éªŒè¯çª—å£ï¼š<èµ·æ­¢æ—¶é—´/ç°åº¦æ¯”ä¾‹>
å›æ»šæ¡ä»¶ï¼š<P95 æ¶åŒ–>10% / é”™è¯¯ç‡å‡ / é”å†²çªå‡>
è´Ÿè´£äºº/å®¡æ‰¹ï¼š<Owner/Reviewer>
```

### 4.1 å˜æ›´è®°å½•è¡¨

```sql
-- åˆ›å»ºå˜æ›´è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS performance_change_log (
    change_id SERIAL PRIMARY KEY,
    change_time TIMESTAMP DEFAULT NOW(),
    change_type VARCHAR(50),  -- 'parameter', 'index', 'sql', 'structure'
    change_target TEXT,
    old_value TEXT,
    new_value TEXT,
    change_by VARCHAR(100),
    expected_impact TEXT,
    verification_window TEXT,
    rollback_condition TEXT,
    change_status VARCHAR(20),  -- 'pending', 'in_progress', 'completed', 'rolled_back'
    actual_impact TEXT,
    notes TEXT
);

-- è®°å½•å˜æ›´
INSERT INTO performance_change_log (
    change_type,
    change_target,
    old_value,
    new_value,
    change_by,
    expected_impact,
    verification_window,
    rollback_condition
)
VALUES (
    'parameter',
    'shared_buffers',
    '256MB',
    '512MB',
    current_user,
    'æé«˜ç¼“å­˜å‘½ä¸­ç‡5-10%',
    '2025-11-22 02:00 - 06:00',
    'P95å»¶è¿Ÿå¢åŠ >10%æˆ–é”™è¯¯ç‡ä¸Šå‡'
);

-- æŸ¥è¯¢å˜æ›´å†å²
SELECT
    change_id,
    change_time,
    change_type,
    change_target,
    old_value,
    new_value,
    change_status,
    actual_impact
FROM performance_change_log
ORDER BY change_time DESC
LIMIT 20;
```

### 4.2 å˜æ›´ç¥¨æ®æ¨¡æ¿ï¼ˆè¯¦ç»†ï¼‰

```text
==========================================
å˜æ›´ç¥¨æ®
==========================================
å˜æ›´ID: CHG-2025-11-22-001
å˜æ›´æ—¶é—´: 2025-11-22 02:00:00
å˜æ›´ç±»å‹: [ ] å‚æ•° [âœ“] ç´¢å¼• [ ] SQL [ ] ç»“æ„

å˜æ›´é¡¹: shared_buffers
å¯¹è±¡/èŒƒå›´: æ•°æ®åº“å®ä¾‹ postgres
æ—§å€¼: 256MB
æ–°å€¼: 512MB

é¢„æœŸå½±å“:
- ç¼“å­˜å‘½ä¸­ç‡æå‡: 5-10%
- å†…å­˜ä½¿ç”¨å¢åŠ : 256MB
- æ€§èƒ½æå‡: P95å»¶è¿Ÿé™ä½5-10%

éªŒè¯çª—å£:
- å¼€å§‹æ—¶é—´: 2025-11-22 02:00:00
- ç»“æŸæ—¶é—´: 2025-11-22 06:00:00
- è§‚å¯ŸæœŸ: 4å°æ—¶

å›æ»šæ¡ä»¶:
- P95å»¶è¿Ÿå¢åŠ >10%
- é”™è¯¯ç‡ä¸Šå‡>5%
- é”ç­‰å¾…æ•°å¢åŠ >20%
- å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼

è´Ÿè´£äºº: DBA Team
å®¡æ‰¹äºº: Tech Lead
çŠ¶æ€: [ ] å¾…å®¡æ‰¹ [âœ“] å·²å®¡æ‰¹ [ ] æ‰§è¡Œä¸­ [ ] å·²å®Œæˆ [ ] å·²å›æ»š

å˜æ›´å‰æŒ‡æ ‡åŸºçº¿:
- æ´»è·ƒæŸ¥è¯¢æ•°: 5
- æ€»æ‰§è¡Œæ—¶é—´: 12345.67ms
- ç¼“å­˜å‘½ä¸­ç‡: 95.2%
- ç­‰å¾…æŸ¥è¯¢æ•°: 0

==========================================
```

### 4.3 å˜æ›´å®¡æ‰¹æµç¨‹

```bash
# å˜æ›´å®¡æ‰¹æ£€æŸ¥è„šæœ¬
cat > /tmp/change_approval_check.sh <<'EOF'
#!/bin/bash

CHANGE_ID=$1
if [ -z "$CHANGE_ID" ]; then
    echo "ç”¨æ³•: $0 <å˜æ›´ID>"
    exit 1
fi

# æ£€æŸ¥å˜æ›´æ˜¯å¦å·²å®¡æ‰¹
APPROVED=$(psql -t -c "
SELECT COUNT(*)
FROM performance_change_log
WHERE change_id = $CHANGE_ID
AND change_status = 'approved';
")

if [ "$APPROVED" -eq 0 ]; then
    echo "âŒ å˜æ›´ $CHANGE_ID æœªå®¡æ‰¹ï¼Œæ— æ³•æ‰§è¡Œ"
    exit 1
else
    echo "âœ… å˜æ›´ $CHANGE_ID å·²å®¡æ‰¹ï¼Œå¯ä»¥æ‰§è¡Œ"
fi

# æ£€æŸ¥å˜æ›´çª—å£
CURRENT_HOUR=$(date +%H)
if [ "${CURRENT_HOUR}" -ge 2 ] && [ "${CURRENT_HOUR}" -lt 6 ]; then
    echo "âœ… å½“å‰å¤„äºä½å³°æ—¶æ®µï¼Œå¯ä»¥æ‰§è¡Œå˜æ›´"
else
    echo "âš ï¸  å½“å‰ä¸åœ¨ä½å³°æ—¶æ®µï¼Œå»ºè®®åœ¨ä½å³°æ—¶æ®µæ‰§è¡Œ"
fi
EOF

chmod +x /tmp/change_approval_check.sh
```

## 5. æ‰§è¡Œæ­¥éª¤

1) å»ºç«‹å®¡è®¡ï¼šè®°å½•å‚æ•°æ—§å€¼ï¼ˆ`SHOW`/`pg_file_settings`ï¼‰ä¸è®¡åˆ’åŸºçº¿ï¼›
2) å•å˜é‡å°æ­¥å˜æ›´ï¼›
3) è§‚å¯Ÿ 15â€“30 åˆ†é’Ÿç¨³å®šçª—å£ï¼›
4) è¾¾æ ‡åˆ™å›ºåŒ–ä¸æ–‡æ¡£åŒ–ï¼›ä¸è¾¾æ ‡åˆ™å›æ»šã€‚

### 5.1 å˜æ›´å‰å®¡è®¡è„šæœ¬

```sql
-- 1. è®°å½•å½“å‰å‚æ•°å€¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        CREATE TABLE pg_tuning_audit (
            change_id SERIAL PRIMARY KEY,
            change_time TIMESTAMP DEFAULT NOW(),
            parameter_name TEXT,
            old_value TEXT,
            new_value TEXT,
            change_type TEXT,  -- 'parameter', 'index', 'sql', 'structure'
            change_reason TEXT,
            change_by TEXT
        );
        RAISE NOTICE 'å®¡è®¡è¡¨pg_tuning_auditåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'å®¡è®¡è¡¨pg_tuning_auditå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'å®¡è®¡è¡¨pg_tuning_auditå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå®¡è®¡è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•å‚æ•°å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_settings'
    ) THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    END IF;

    INSERT INTO pg_tuning_audit (parameter_name, old_value, change_type, change_reason, change_by)
    SELECT name, setting, 'parameter', 'Performance tuning', current_user
    FROM pg_settings
    WHERE name IN (
        'shared_buffers', 'work_mem', 'maintenance_work_mem',
        'effective_cache_size', 'max_connections',
        'checkpoint_timeout', 'max_wal_size', 'wal_buffers',
        'random_page_cost', 'effective_io_concurrency'
    );

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'æˆåŠŸè®°å½• % ä¸ªå‚æ•°å˜æ›´', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_auditæˆ–pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•å‚æ•°å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

-- 2. è®°å½•å½“å‰æ€§èƒ½åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_performance_baseline'
    ) THEN
        CREATE TABLE pg_performance_baseline (
            baseline_id SERIAL PRIMARY KEY,
            baseline_time TIMESTAMP DEFAULT NOW(),
            metric_name TEXT,
            metric_value NUMERIC,
            notes TEXT
        );
        RAISE NOTICE 'æ€§èƒ½åŸºçº¿è¡¨pg_performance_baselineåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'æ€§èƒ½åŸºçº¿è¡¨pg_performance_baselineå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'æ€§èƒ½åŸºçº¿è¡¨pg_performance_baselineå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ€§èƒ½åŸºçº¿è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•å…³é”®æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_database'
    ) THEN
        RAISE EXCEPTION 'pg_stat_databaseè§†å›¾ä¸å­˜åœ¨';
    END IF;

    INSERT INTO pg_performance_baseline (metric_name, metric_value, notes)
    SELECT 'buffer_hit_ratio',
           round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2),
           'Database: ' || datname
    FROM pg_stat_database
    WHERE datname = current_database()
    GROUP BY datname;

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'æˆåŠŸè®°å½• % æ¡æ€§èƒ½åŸºçº¿æŒ‡æ ‡', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨pg_performance_baselineæˆ–pg_stat_databaseè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—ç¼“å†²åŒºå‘½ä¸­ç‡æ—¶å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•æ€§èƒ½åŸºçº¿å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT 'buffer_hit_ratio',
       round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2),
       'Database: ' || datname
FROM pg_stat_database
WHERE datname = current_database()
GROUP BY datname;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 3. è®°å½•å½“å‰æ…¢æŸ¥è¯¢åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_query_baseline'
    ) THEN
        CREATE TABLE pg_query_baseline (
            baseline_id SERIAL PRIMARY KEY,
            baseline_time TIMESTAMP DEFAULT NOW(),
            query_id BIGINT,
            query TEXT,
            calls BIGINT,
            mean_exec_time NUMERIC,
            max_exec_time NUMERIC
        );
        RAISE NOTICE 'æ…¢æŸ¥è¯¢åŸºçº¿è¡¨pg_query_baselineåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'æ…¢æŸ¥è¯¢åŸºçº¿è¡¨pg_query_baselineå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'æ…¢æŸ¥è¯¢åŸºçº¿è¡¨pg_query_baselineå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ…¢æŸ¥è¯¢åŸºçº¿è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•Top 20æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_query_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_query_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    INSERT INTO pg_query_baseline (query_id, query, calls, mean_exec_time, max_exec_time)
    SELECT queryid, LEFT(query, 500), calls, mean_exec_time, max_exec_time
    FROM pg_stat_statements
    ORDER BY mean_exec_time DESC
    LIMIT 20;

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'æˆåŠŸè®°å½• % æ¡æ…¢æŸ¥è¯¢åŸºçº¿', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨pg_query_baselineæˆ–pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•æ…¢æŸ¥è¯¢åŸºçº¿å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT queryid, LEFT(query, 500), calls, mean_exec_time, max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

### 5.2 å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬

```sql
-- ç¤ºä¾‹ï¼šè°ƒæ•´shared_buffers
-- æ­¥éª¤1: è®°å½•æ—§å€¼
DO $$
DECLARE
    old_value TEXT;
BEGIN
    SELECT setting INTO old_value FROM pg_settings WHERE name = 'shared_buffers';
    INSERT INTO pg_tuning_audit (parameter_name, old_value, change_type, change_reason, change_by)
    VALUES ('shared_buffers', old_value, 'parameter', 'Increase buffer for better cache hit ratio', current_user);
END $$;

-- æ­¥éª¤2: åº”ç”¨æ–°å€¼ï¼ˆéœ€è¦é‡å¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ–¹æ³•1: ä½¿ç”¨ALTER SYSTEMï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    old_value TEXT;
BEGIN
    SELECT setting INTO old_value FROM pg_settings WHERE name = 'shared_buffers';

    ALTER SYSTEM SET shared_buffers = '4GB';
    RAISE NOTICE 'å‚æ•°shared_bufferså·²ä»%æ›´æ–°ä¸º4GB', old_value;

    PERFORM pg_reload_conf();
    RAISE NOTICE 'é…ç½®å·²é‡æ–°åŠ è½½ï¼ˆæ³¨æ„ï¼šshared_bufferséœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥shared_buffersçš„å€¼';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‚æ•°å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ³•2: ç›´æ¥ä¿®æ”¹postgresql.conf
-- shared_buffers = 4GB

-- æ­¥éª¤3: éªŒè¯å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_value TEXT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_settings'
    ) THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    END IF;

    SELECT setting INTO current_value
    FROM pg_settings
    WHERE name = 'shared_buffers';

    RAISE NOTICE 'å½“å‰shared_bufferså€¼: %', current_value;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, source
FROM pg_settings
WHERE name = 'shared_buffers';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ­¥éª¤4: æ›´æ–°å®¡è®¡è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
    new_value TEXT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°';
        RETURN;
    END IF;

    SELECT setting INTO new_value
    FROM pg_settings
    WHERE name = 'shared_buffers';

    UPDATE pg_tuning_audit
    SET new_value = new_value
    WHERE parameter_name = 'shared_buffers'
    AND change_id = (SELECT MAX(change_id) FROM pg_tuning_audit WHERE parameter_name = 'shared_buffers');

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    IF updated_count > 0 THEN
        RAISE NOTICE 'æˆåŠŸæ›´æ–° % æ¡å®¡è®¡è®°å½•', updated_count;
    ELSE
        RAISE WARNING 'æœªæ‰¾åˆ°éœ€è¦æ›´æ–°çš„å®¡è®¡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨pg_tuning_auditæˆ–pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°å®¡è®¡è®°å½•å¤±è´¥: %', SQLERRM;
END $$;
```

### 5.3 ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬

```sql
-- ç¤ºä¾‹ï¼šåˆ›å»ºæ–°ç´¢å¼•
-- æ­¥éª¤1: è®°å½•å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œè·³è¿‡è®°å½•';
        RETURN;
    END IF;

    INSERT INTO pg_tuning_audit (parameter_name, old_value, change_type, change_reason, change_by)
    VALUES ('idx_orders_customer_date', 'NOT EXISTS', 'index', 'Optimize customer order history query', current_user)
    RETURNING change_id INTO inserted_id;

    RAISE NOTICE 'å˜æ›´è®°å½•æˆåŠŸï¼Œchange_id: %', inserted_id;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤2: åˆ›å»ºç´¢å¼•ï¼ˆä½¿ç”¨CONCURRENTLYé¿å…é”è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_date'
    ) THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_customer_dateå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    CREATE INDEX CONCURRENTLY idx_orders_customer_date ON orders (customer_id, order_date DESC);
    RAISE NOTICE 'ç´¢å¼•idx_orders_customer_dateåˆ›å»ºæˆåŠŸï¼ˆå¹¶å‘æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_customer_dateå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤3: éªŒè¯ç´¢å¼•åˆ›å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_exists BOOLEAN;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_indexes'
    ) THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT EXISTS(
        SELECT 1 FROM pg_indexes
        WHERE indexname = 'idx_orders_customer_date'
    ) INTO index_exists;

    IF index_exists THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_customer_dateéªŒè¯æˆåŠŸ';
    ELSE
        RAISE WARNING 'ç´¢å¼•idx_orders_customer_dateä¸å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯ç´¢å¼•åˆ›å»ºå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE indexname = 'idx_orders_customer_date';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ­¥éª¤4: æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;
    RAISE NOTICE 'æŸ¥è¯¢æ€§èƒ½æµ‹è¯•å®Œæˆ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æµ‹è¯•æŸ¥è¯¢æ€§èƒ½å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders
WHERE customer_id = 100
ORDER BY order_date DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <50msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Index Scan (å¦‚æœä½¿ç”¨äº†ç´¢å¼•) æˆ– Seq Scan
```

### 5.4 è§‚å¯ŸæœŸç›‘æ§è„šæœ¬

```sql
-- å˜æ›´å15-30åˆ†é’Ÿè§‚å¯ŸæœŸç›‘æ§
-- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè®°å½•å…³é”®æŒ‡æ ‡

-- åˆ›å»ºç›‘æ§è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_monitoring'
    ) THEN
        CREATE TABLE pg_tuning_monitoring (
            monitor_id SERIAL PRIMARY KEY,
            monitor_time TIMESTAMP DEFAULT NOW(),
            change_id INTEGER REFERENCES pg_tuning_audit(change_id),
            buffer_hit_ratio NUMERIC,
            avg_query_time NUMERIC,
            active_connections INTEGER,
            lock_waits INTEGER,
            checkpoint_frequency NUMERIC
        );
        RAISE NOTICE 'ç›‘æ§è¡¨pg_tuning_monitoringåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'ç›‘æ§è¡¨pg_tuning_monitoringå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'ç›‘æ§è¡¨pg_tuning_monitoringå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç›‘æ§è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- ç›‘æ§è„šæœ¬ï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_monitoring'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_monitoringä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œchange_idå°†ä¸ºç©º';
    END IF;

    INSERT INTO pg_tuning_monitoring (
        change_id,
        buffer_hit_ratio,
        avg_query_time,
        active_connections,
        lock_waits,
        checkpoint_frequency
    )
    SELECT
        (SELECT MAX(change_id) FROM pg_tuning_audit) as change_id,
        (SELECT round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2)
         FROM pg_stat_database WHERE datname = current_database()) as buffer_hit_ratio,
        (SELECT round(avg(mean_exec_time), 2)
         FROM pg_stat_statements WHERE calls > 10) as avg_query_time,
        (SELECT count(*) FROM pg_stat_activity WHERE state != 'idle') as active_connections,
        (SELECT count(*) FROM pg_locks WHERE NOT granted) as lock_waits,
        (SELECT round(extract(epoch from now() - stats_reset) / NULLIF(checkpoints_timed + checkpoints_req, 0), 2)
         FROM pg_stat_bgwriter) as checkpoint_frequency;

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'æˆåŠŸæ’å…¥ % æ¡ç›‘æ§è®°å½•', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'ç›¸å…³è¡¨æˆ–è§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥ç›‘æ§è®°å½•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥çœ‹ç›‘æ§è¶‹åŠ¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    trend_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_monitoring'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_monitoringä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹ç›‘æ§è¶‹åŠ¿';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO trend_count
    FROM pg_tuning_monitoring
    WHERE change_id = (SELECT MAX(change_id) FROM pg_tuning_audit);

    IF trend_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡ç›‘æ§è¶‹åŠ¿è®°å½•', trend_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç›‘æ§è¶‹åŠ¿è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨pg_tuning_monitoringæˆ–pg_tuning_auditä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹ç›‘æ§è¶‹åŠ¿å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    monitor_time,
    buffer_hit_ratio,
    avg_query_time,
    active_connections,
    lock_waits
FROM pg_tuning_monitoring
WHERE change_id = (SELECT MAX(change_id) FROM pg_tuning_audit)
ORDER BY monitor_time DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <50msï¼ˆå–å†³äºç›‘æ§è®°å½•æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

## 6. å¸¸ç”¨å‚æ•°å»ºè®®ï¼ˆè¯¦ç»†ï¼‰

### 6.1 è¿æ¥ä¸å¹¶å‘å‚æ•°

```sql
-- max_connections: æœ€å¤§è¿æ¥æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šæ ¹æ®åº”ç”¨è¿æ¥æ± é…ç½®ï¼Œé€šå¸¸100-500
-- æ³¨æ„ï¼šæ¯ä¸ªè¿æ¥æ¶ˆè€—çº¦10MBå†…å­˜
DO $$
BEGIN
    ALTER SYSTEM SET max_connections = 200;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'max_connectionså·²è®¾ç½®ä¸º200ï¼ˆæ³¨æ„ï¼šéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'max_connectionså€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®max_connectionså¤±è´¥: %', SQLERRM;
END $$;

-- work_mem: æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šæ ¹æ®å¹¶å‘æ•°å’Œå¯ç”¨å†…å­˜è®¡ç®—
-- å…¬å¼ï¼šwork_mem = (å¯ç”¨å†…å­˜ - shared_buffers) / (max_connections * 2)
-- ç¤ºä¾‹ï¼š16GBå†…å­˜ï¼Œ4GB shared_buffersï¼Œ200è¿æ¥
-- work_mem = (16GB - 4GB) / (200 * 2) = 30MB
DO $$
BEGIN
    ALTER SYSTEM SET work_mem = '30MB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º30MB';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'work_memå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®work_memå¤±è´¥: %', SQLERRM;
END $$;

-- maintenance_work_mem: ç»´æŠ¤æ“ä½œå†…å­˜ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼š1-2GBï¼ˆç”¨äºVACUUMã€CREATE INDEXç­‰ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET maintenance_work_mem = '1GB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'maintenance_work_memå·²è®¾ç½®ä¸º1GB';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'maintenance_work_memå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®maintenance_work_memå¤±è´¥: %', SQLERRM;
END $$;
```

### 6.2 ç¼“å†²å‚æ•°

```sql
-- shared_buffers: å…±äº«ç¼“å†²åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šç³»ç»Ÿå†…å­˜çš„25%ï¼ˆLinuxï¼‰æˆ–40%ï¼ˆWindowsï¼‰
-- ç¤ºä¾‹ï¼š16GBå†…å­˜ç³»ç»Ÿï¼Œè®¾ç½®4GB
DO $$
BEGIN
    ALTER SYSTEM SET shared_buffers = '4GB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'shared_bufferså·²è®¾ç½®ä¸º4GBï¼ˆæ³¨æ„ï¼šéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'shared_bufferså€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®shared_bufferså¤±è´¥: %', SQLERRM;
END $$;

-- effective_cache_size: æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šç³»ç»Ÿå†…å­˜çš„50-75%
-- ç¤ºä¾‹ï¼š16GBå†…å­˜ç³»ç»Ÿï¼Œè®¾ç½®12GB
DO $$
BEGIN
    ALTER SYSTEM SET effective_cache_size = '12GB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'effective_cache_sizeå·²è®¾ç½®ä¸º12GB';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'effective_cache_sizeå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®effective_cache_sizeå¤±è´¥: %', SQLERRM;
END $$;
```

### 6.3 å¹¶è¡Œå’ŒJITå‚æ•°

```sql
-- max_parallel_workers_per_gather: æ¯ä¸ªGatherèŠ‚ç‚¹çš„æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šCPUæ ¸å¿ƒæ•°çš„50%
DO $$
BEGIN
    ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'max_parallel_workers_per_gatherå·²è®¾ç½®ä¸º4';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'max_parallel_workers_per_gatherå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®max_parallel_workers_per_gatherå¤±è´¥: %', SQLERRM;
END $$;

-- max_parallel_workers: ç³»ç»Ÿæœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šCPUæ ¸å¿ƒæ•°
DO $$
BEGIN
    ALTER SYSTEM SET max_parallel_workers = 8;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'max_parallel_workerså·²è®¾ç½®ä¸º8';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'max_parallel_workerså€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®max_parallel_workerså¤±è´¥: %', SQLERRM;
END $$;

-- jit: å¯ç”¨JITç¼–è¯‘ï¼ˆPostgreSQL 11+ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®ï¼šå¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œå¯ç”¨JITå¯ä»¥æå‡æ€§èƒ½
DO $$
BEGIN
    ALTER SYSTEM SET jit = on;
    ALTER SYSTEM SET jit_above_cost = 100000;  -- åªå¯¹é«˜costæŸ¥è¯¢å¯ç”¨JIT
    PERFORM pg_reload_conf();
    RAISE NOTICE 'JITå·²å¯ç”¨ï¼Œjit_above_costå·²è®¾ç½®ä¸º100000';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'JITå‚æ•°å€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®JITå‚æ•°å¤±è´¥: %', SQLERRM;
END $$;
```

### 6.4 I/Oå‚æ•°

```sql
-- random_page_cost: éšæœºé¡µé¢è®¿é—®æˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- SSD: 1.1-1.5ï¼ŒNVMe: 1.0-1.1ï¼ŒHDD: 4.0ï¼ˆé»˜è®¤ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET random_page_cost = 1.1;  -- SSDç¯å¢ƒ
    PERFORM pg_reload_conf();
    RAISE NOTICE 'random_page_costå·²è®¾ç½®ä¸º1.1ï¼ˆSSDç¯å¢ƒï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'random_page_costå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®random_page_costå¤±è´¥: %', SQLERRM;
END $$;

-- effective_io_concurrency: æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18å¢å¼ºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- SSD: 200-300ï¼ŒNVMe: 300-500ï¼ŒHDD: 50-100
DO $$
BEGIN
    ALTER SYSTEM SET effective_io_concurrency = 200;  -- SSDç¯å¢ƒ
    PERFORM pg_reload_conf();
    RAISE NOTICE 'effective_io_concurrencyå·²è®¾ç½®ä¸º200ï¼ˆSSDç¯å¢ƒï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'effective_io_concurrencyå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®effective_io_concurrencyå¤±è´¥: %', SQLERRM;
END $$;

-- maintenance_io_concurrency: ç»´æŠ¤æ“ä½œI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18æ–°å¢ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET maintenance_io_concurrency = 200;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'maintenance_io_concurrencyå·²è®¾ç½®ä¸º200';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'maintenance_io_concurrencyå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®maintenance_io_concurrencyå¤±è´¥: %', SQLERRM;
END $$;
```

### 6.5 æ£€æŸ¥ç‚¹å’ŒWALå‚æ•°

```sql
-- checkpoint_timeout: æ£€æŸ¥ç‚¹è¶…æ—¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼š15-30åˆ†é’Ÿ
DO $$
BEGIN
    ALTER SYSTEM SET checkpoint_timeout = '15min';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'checkpoint_timeoutå·²è®¾ç½®ä¸º15min';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'checkpoint_timeoutå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®checkpoint_timeoutå¤±è´¥: %', SQLERRM;
END $$;

-- max_wal_size: æœ€å¤§WALå¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼šæ ¹æ®å†™å…¥è´Ÿè½½ï¼Œé€šå¸¸2-8GB
DO $$
BEGIN
    ALTER SYSTEM SET max_wal_size = '4GB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'max_wal_sizeå·²è®¾ç½®ä¸º4GB';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'max_wal_sizeå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®max_wal_sizeå¤±è´¥: %', SQLERRM;
END $$;

-- checkpoint_completion_target: æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼š0.9ï¼ˆå¹³æ»‘å†™å…¥ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET checkpoint_completion_target = 0.9;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'checkpoint_completion_targetå·²è®¾ç½®ä¸º0.9';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'checkpoint_completion_targetå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®checkpoint_completion_targetå¤±è´¥: %', SQLERRM;
END $$;

-- wal_compression: WALå‹ç¼©ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®ï¼šå¯ç”¨å¯ä»¥å‡å°‘WALå¤§å°
DO $$
BEGIN
    ALTER SYSTEM SET wal_compression = on;
    PERFORM pg_reload_conf();
    RAISE NOTICE 'wal_compressionå·²å¯ç”¨';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'wal_compressionå€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®wal_compressionå¤±è´¥: %', SQLERRM;
END $$;

-- wal_buffers: WALç¼“å†²åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- å»ºè®®å€¼ï¼š16-32MBï¼ˆé«˜å†™å…¥è´Ÿè½½ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET wal_buffers = '16MB';
    PERFORM pg_reload_conf();
    RAISE NOTICE 'wal_bufferså·²è®¾ç½®ä¸º16MBï¼ˆæ³¨æ„ï¼šéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'wal_bufferså€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®wal_bufferså¤±è´¥: %', SQLERRM;
END $$;
```

### 6.6 ç»´æŠ¤å‚æ•°

```sql
-- autovacuumç›¸å…³å‚æ•°
-- autovacuumç›¸å…³å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    ALTER SYSTEM SET autovacuum = on;
    ALTER SYSTEM SET autovacuum_max_workers = 3;
    ALTER SYSTEM SET autovacuum_naptime = '1min';
    ALTER SYSTEM SET autovacuum_vacuum_scale_factor = 0.1;  -- 10%æ­»å…ƒç»„è§¦å‘
    ALTER SYSTEM SET autovacuum_analyze_scale_factor = 0.05;  -- 5%å˜æ›´è§¦å‘
    PERFORM pg_reload_conf();
    RAISE NOTICE 'autovacuumå‚æ•°å·²è®¾ç½®å®Œæˆ';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'autovacuumå‚æ•°å€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®autovacuumå‚æ•°å¤±è´¥: %', SQLERRM;
END $$;

-- maintenance_work_mem: ç»´æŠ¤å·¥ä½œå†…å­˜
ALTER SYSTEM SET maintenance_work_mem = '1GB';
```

### 6.7 å‚æ•°å˜æ›´æ£€æŸ¥æ¸…å•

```sql
-- æ£€æŸ¥å‚æ•°æ˜¯å¦ç”Ÿæ•ˆï¼ˆæŸäº›å‚æ•°éœ€è¦é‡å¯ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    param_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_settings'
    ) THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO param_count
    FROM pg_settings
    WHERE name IN (
        'shared_buffers', 'work_mem', 'max_connections',
        'checkpoint_timeout', 'max_wal_size'
    );

    IF param_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç›¸å…³å‚æ•°', param_count;
    ELSE
        RAISE WARNING 'æœªå‘ç°ç›¸å…³å‚æ•°';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å‚æ•°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT name, setting, unit, context, source
FROM pg_settings
WHERE name IN (
    'shared_buffers', 'work_mem', 'max_connections',
    'checkpoint_timeout', 'max_wal_size'
)
ORDER BY name;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- contextè¯´æ˜ï¼š
-- 'postmaster': éœ€è¦é‡å¯PostgreSQLæœåŠ¡
-- 'sighup': éœ€è¦é‡æ–°åŠ è½½é…ç½®ï¼ˆSELECT pg_reload_conf();ï¼‰
-- 'user': å¯ä»¥åœ¨ä¼šè¯çº§åˆ«è®¾ç½®
```

## 7. éªŒè¯æ¸…å•

- æŒ‡æ ‡å¯¹æ¯”ï¼šè°ƒä¼˜å‰/å P95ã€TPS/QPSã€å‘½ä¸­ç‡ã€WALã€æ£€æŸ¥ç‚¹ï¼›
- SQL å¯¹æ¯”ï¼šTopN æ˜¯å¦ä¸‹é™ã€ä¼°ç®—åå·®æ˜¯å¦ç¼“è§£ï¼›
- èµ„æºï¼šCPU/IO/å†…å­˜æ˜¯å¦åœ¨é˜ˆå€¼å†…ï¼›
- ä¸šåŠ¡ï¼šé”™è¯¯ç‡/è¶…æ—¶æ˜¯å¦æ­£å¸¸ã€‚

### 7.1 éªŒè¯è„šæœ¬

```sql
-- 1. æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    comparison_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_performance_baseline'
    ) THEN
        RAISE WARNING 'è¡¨pg_performance_baselineä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ€§èƒ½æŒ‡æ ‡å¯¹æ¯”';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_database'
    ) THEN
        RAISE WARNING 'pg_stat_databaseè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    WITH baseline AS (
        SELECT * FROM pg_performance_baseline
        WHERE baseline_id = (SELECT MAX(baseline_id) FROM pg_performance_baseline)
    ),
    current AS (
        SELECT
            round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as buffer_hit_ratio,
            sum(xact_commit) as commits,
            sum(xact_rollback) as rollbacks
        FROM pg_stat_database
        WHERE datname = current_database()
    )
    SELECT COUNT(*) INTO comparison_count
    FROM baseline, current
    WHERE baseline.metric_name = 'buffer_hit_ratio';

    IF comparison_count > 0 THEN
        RAISE NOTICE 'æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”å®Œæˆï¼Œå‘ç° % æ¡å¯¹æ¯”è®°å½•', comparison_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨æˆ–è§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH baseline AS (
    SELECT * FROM pg_performance_baseline
    WHERE baseline_id = (SELECT MAX(baseline_id) FROM pg_performance_baseline)
),
current AS (
    SELECT
        round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as buffer_hit_ratio,
        sum(xact_commit) as commits,
        sum(xact_rollback) as rollbacks
    FROM pg_stat_database
    WHERE datname = current_database()
)
SELECT
    'Buffer Hit Ratio' as metric,
    baseline.metric_value as baseline_value,
    current.buffer_hit_ratio as current_value,
    round((current.buffer_hit_ratio - baseline.metric_value)::numeric, 2) as improvement
FROM baseline, current
WHERE baseline.metric_name = 'buffer_hit_ratio';
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºåŸºçº¿æ•°æ®é‡ï¼‰
-- è®¡åˆ’: Nested Loop -> CTE Scan

-- 2. æ…¢æŸ¥è¯¢å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    comparison_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_query_baseline'
    ) THEN
        RAISE WARNING 'è¡¨pg_query_baselineä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œæ…¢æŸ¥è¯¢å¯¹æ¯”';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    WITH baseline AS (
        SELECT queryid, mean_exec_time as baseline_time
        FROM pg_query_baseline
        WHERE baseline_id = (SELECT MAX(baseline_id) FROM pg_query_baseline)
    ),
    current AS (
        SELECT queryid, mean_exec_time as current_time
        FROM pg_stat_statements
    )
    SELECT COUNT(*) INTO comparison_count
    FROM baseline b
    JOIN current c ON b.queryid = c.queryid
    WHERE c.current_time < b.baseline_time * 0.9;  -- æ€§èƒ½æå‡>10%

    IF comparison_count > 0 THEN
        RAISE NOTICE 'æ…¢æŸ¥è¯¢å¯¹æ¯”å®Œæˆï¼Œå‘ç° % æ¡æ€§èƒ½æå‡çš„æŸ¥è¯¢', comparison_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ€§èƒ½æå‡çš„æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨æˆ–è§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ…¢æŸ¥è¯¢å¯¹æ¯”å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH baseline AS (
    SELECT queryid, mean_exec_time as baseline_time
    FROM pg_query_baseline
    WHERE baseline_id = (SELECT MAX(baseline_id) FROM pg_query_baseline)
),
current AS (
    SELECT queryid, mean_exec_time as current_time
    FROM pg_stat_statements
)
SELECT
    LEFT(b.query, 100) as query_preview,
    b.baseline_time,
    c.current_time,
    round((b.baseline_time - c.current_time)::numeric, 2) as improvement_ms,
    round(((b.baseline_time - c.current_time) / NULLIF(b.baseline_time, 0) * 100)::numeric, 2) as improvement_pct
FROM baseline b
JOIN current c ON b.queryid = c.queryid
WHERE c.current_time < b.baseline_time * 0.9  -- æ€§èƒ½æå‡>10%
ORDER BY improvement_ms DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Hash Join -> CTE Scan

-- 3. èµ„æºä½¿ç”¨æ£€æŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_conn_count INT;
    lock_wait_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO active_conn_count
    FROM pg_stat_activity
    WHERE state != 'idle';

    SELECT COUNT(*) INTO lock_wait_count
    FROM pg_locks
    WHERE NOT granted;

    RAISE NOTICE 'æ´»è·ƒè¿æ¥æ•°: %, é”ç­‰å¾…æ•°: %', active_conn_count, lock_wait_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'èµ„æºä½¿ç”¨æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    'Active Connections' as metric,
    count(*) as value,
    (SELECT setting::integer FROM pg_settings WHERE name = 'max_connections') as max_value,
    round(100.0 * count(*) / NULLIF((SELECT setting::integer FROM pg_settings WHERE name = 'max_connections'), 0), 2) as usage_pct
FROM pg_stat_activity
WHERE state != 'idle'
UNION ALL
SELECT
    'Lock Waits' as metric,
    count(*) as value,
    NULL as max_value,
    NULL as usage_pct
FROM pg_locks
WHERE NOT granted;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Append -> Seq Scan

-- 4. æ£€æŸ¥ç‚¹é¢‘ç‡å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    checkpoint_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_bgwriter'
    ) THEN
        RAISE WARNING 'pg_stat_bgwriterè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO checkpoint_count
    FROM pg_stat_bgwriter;

    IF checkpoint_count > 0 THEN
        RAISE NOTICE 'æ£€æŸ¥ç‚¹é¢‘ç‡å¯¹æ¯”å®Œæˆï¼Œå‘ç° % æ¡è®°å½•', checkpoint_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ£€æŸ¥ç‚¹è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_bgwriterè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç‚¹é¢‘ç‡å¯¹æ¯”å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed + checkpoints_req as total_checkpoints,
    round(extract(epoch from now() - stats_reset) / NULLIF(checkpoints_timed + checkpoints_req, 0) / 60, 2) as avg_interval_minutes,
    checkpoint_write_time + checkpoint_sync_time as total_checkpoint_time_ms
FROM pg_stat_bgwriter;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

### 7.2 éªŒè¯æ ‡å‡†

**æ€§èƒ½æå‡æ ‡å‡†**:

- âœ… **ç¼“å†²åŒºå‘½ä¸­ç‡**: æå‡>2% æˆ– è¾¾åˆ°>99%
- âœ… **å¹³å‡æŸ¥è¯¢æ—¶é—´**: é™ä½>10%
- âœ… **P95/P99å»¶è¿Ÿ**: é™ä½>10%
- âœ… **TPS/QPS**: æå‡>5%
- âœ… **æ£€æŸ¥ç‚¹é¢‘ç‡**: é™ä½>20% æˆ– é—´éš”>10åˆ†é’Ÿ
- âœ… **é”ç­‰å¾…**: å‡å°‘>50%

**å›æ»šè§¦å‘æ¡ä»¶**:

- âŒ **ç¼“å†²åŒºå‘½ä¸­ç‡**: ä¸‹é™>2%
- âŒ **å¹³å‡æŸ¥è¯¢æ—¶é—´**: å¢åŠ >10%
- âŒ **P95/P99å»¶è¿Ÿ**: å¢åŠ >10%
- âŒ **é”™è¯¯ç‡**: å¢åŠ >1%
- âŒ **é”ç­‰å¾…**: å¢åŠ >50%
- âŒ **èµ„æºä½¿ç”¨**: CPU>90% æˆ– å†…å­˜>95%

## 8. å›æ»šä¸å¤ç›˜

- ç«‹å³æ¢å¤å‚æ•°æ—§å€¼/æ’¤é”€ç´¢å¼•æˆ–é‡å†™ï¼›
- é™„åŠ è¯æ®ï¼šæ—¥å¿—ã€æ…¢SQLã€EXPLAINã€é¢æ¿æˆªå›¾ï¼›
- å¤ç›˜æ¡ç›®ï¼šé—®é¢˜æ ¹å› ã€æ— æ•ˆå°è¯•ã€æœ‰æ•ˆæ‰‹æ®µã€å¯å¤ç”¨è„šæœ¬ã€‚

### 8.1 å›æ»šè„šæœ¬

```sql
-- 1. å‚æ•°å›æ»šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- ä»å®¡è®¡è¡¨è·å–æ—§å€¼å¹¶æ¢å¤
DO $$
DECLARE
    audit_record RECORD;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‚æ•°å›æ»š';
    END IF;

    SELECT parameter_name, old_value
    INTO audit_record
    FROM pg_tuning_audit
    WHERE change_id = (SELECT MAX(change_id) FROM pg_tuning_audit)
    AND change_type = 'parameter'
    LIMIT 1;

    IF audit_record.parameter_name IS NOT NULL THEN
        EXECUTE format('ALTER SYSTEM SET %I = %L',
                       audit_record.parameter_name,
                       audit_record.old_value);
        PERFORM pg_reload_conf();
        RAISE NOTICE 'å‚æ•°å›æ»šæˆåŠŸ: % å·²æ¢å¤ä¸º %',
                     audit_record.parameter_name,
                     audit_record.old_value;
    ELSE
        RAISE WARNING 'æœªæ‰¾åˆ°éœ€è¦å›æ»šçš„å‚æ•°å˜æ›´è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_auditä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆï¼Œæ— æ³•å›æ»š';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‚æ•°å›æ»šå¤±è´¥: %', SQLERRM;
END $$;

-- 2. ç´¢å¼•å›æ»šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- åˆ é™¤æ–°åˆ›å»ºçš„ç´¢å¼•
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'idx_orders_customer_date'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_customer_dateä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    DROP INDEX CONCURRENTLY IF EXISTS idx_orders_customer_date;
    RAISE NOTICE 'ç´¢å¼•idx_orders_customer_dateåˆ é™¤æˆåŠŸï¼ˆå¹¶å‘æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_customer_dateä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç´¢å¼•å›æ»šå¤±è´¥: %', SQLERRM;
END $$;

-- 3. è®°å½•å›æ»šæ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œè·³è¿‡å›æ»šè®°å½•';
        RETURN;
    END IF;

    INSERT INTO pg_tuning_audit (
        parameter_name,
        old_value,
        new_value,
        change_type,
        change_reason,
        change_by
    )
    SELECT
        parameter_name,
        new_value,  -- å½“å‰å€¼ä½œä¸ºold_value
        old_value,  -- åŸå§‹å€¼ä½œä¸ºnew_valueï¼ˆå›æ»šï¼‰
        'rollback',
        'Performance degradation detected',
        current_user
    FROM pg_tuning_audit
    WHERE change_id = (SELECT MAX(change_id) FROM pg_tuning_audit)
    RETURNING change_id INTO inserted_id;

    IF inserted_id IS NOT NULL THEN
        RAISE NOTICE 'å›æ»šæ“ä½œè®°å½•æˆåŠŸï¼Œchange_id: %', inserted_id;
    ELSE
        RAISE WARNING 'æœªæ‰¾åˆ°éœ€è¦å›æ»šçš„å˜æ›´è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•å›æ»šæ“ä½œå¤±è´¥: %', SQLERRM;
END $$;
```

### 8.2 å¤ç›˜æ¨¡æ¿

**å¤ç›˜è®°å½•è¡¨ç»“æ„**:

```sql
-- åˆ›å»ºå¤ç›˜è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_review'
    ) THEN
        CREATE TABLE pg_tuning_review (
            review_id SERIAL PRIMARY KEY,
            change_id INTEGER REFERENCES pg_tuning_audit(change_id),
            review_time TIMESTAMP DEFAULT NOW(),
            root_cause TEXT,
            attempted_solutions TEXT[],
            effective_solution TEXT,
            performance_improvement NUMERIC,
            lessons_learned TEXT,
            reusable_scripts TEXT,
            reviewed_by TEXT
        );
        RAISE NOTICE 'å¤ç›˜è®°å½•è¡¨pg_tuning_reviewåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'å¤ç›˜è®°å½•è¡¨pg_tuning_reviewå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'å¤ç›˜è®°å½•è¡¨pg_tuning_reviewå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¤ç›˜è®°å½•è¡¨å¤±è´¥: %', SQLERRM;
END $$;
```

**å¤ç›˜è®°å½•ç¤ºä¾‹**:

```sql
-- æ’å…¥å¤ç›˜è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_review'
    ) THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_reviewä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œchange_idå°†ä¸ºç©º';
    END IF;

    INSERT INTO pg_tuning_review (
        change_id,
        root_cause,
        attempted_solutions,
        effective_solution,
        performance_improvement,
        lessons_learned,
        reusable_scripts,
        reviewed_by
    )
    VALUES (
        (SELECT MAX(change_id) FROM pg_tuning_audit),
        'Slow customer order history query due to missing index on (customer_id, order_date)',
        ARRAY[
            'Increased work_mem - no improvement',
            'Updated statistics - no improvement',
            'Created composite index - 80% improvement'
        ],
        'Created composite index idx_orders_customer_date ON orders (customer_id, order_date DESC)',
        80.0,  -- 80%æ€§èƒ½æå‡
        'Composite indexes are effective for multi-column WHERE and ORDER BY clauses',
        'CREATE INDEX CONCURRENTLY idx_orders_customer_date ON orders (customer_id, order_date DESC);',
        current_user
    )
    RETURNING review_id INTO inserted_id;

    IF inserted_id IS NOT NULL THEN
        RAISE NOTICE 'å¤ç›˜è®°å½•æ’å…¥æˆåŠŸï¼Œreview_id: %', inserted_id;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨pg_tuning_reviewæˆ–pg_tuning_auditä¸å­˜åœ¨';
    WHEN check_violation THEN
        RAISE WARNING 'å¤ç›˜è®°å½•è¿åçº¦æŸæ¡ä»¶';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥å¤ç›˜è®°å½•å¤±è´¥: %', SQLERRM;
END $$;
```

### 8.3 å¤ç›˜æŸ¥è¯¢

```sql
-- æŸ¥çœ‹å†å²å˜æ›´å’Œå¤ç›˜è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    record_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œæ— æ³•æŸ¥çœ‹å†å²å˜æ›´';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO record_count
    FROM pg_tuning_audit a
    LEFT JOIN pg_tuning_review r ON a.change_id = r.change_id;

    IF record_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡å†å²å˜æ›´è®°å½•', record_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å†å²å˜æ›´è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥çœ‹å†å²å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    a.change_id,
    a.change_time,
    a.parameter_name,
    a.old_value,
    a.new_value,
    a.change_type,
    r.root_cause,
    r.effective_solution,
    r.performance_improvement,
    r.lessons_learned
FROM pg_tuning_audit a
LEFT JOIN pg_tuning_review r ON a.change_id = r.change_id
ORDER BY a.change_time DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè®°å½•æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Left Join

-- ç»Ÿè®¡æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ‰‹æ®µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_audit'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_auditä¸å­˜åœ¨ï¼Œæ— æ³•ç»Ÿè®¡ä¼˜åŒ–æ‰‹æ®µ';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'pg_tuning_review'
    ) THEN
        RAISE WARNING 'è¡¨pg_tuning_reviewä¸å­˜åœ¨ï¼Œæ— æ³•ç»Ÿè®¡ä¼˜åŒ–æ‰‹æ®µ';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO stat_count
    FROM pg_tuning_audit a
    JOIN pg_tuning_review r ON a.change_id = r.change_id
    WHERE r.performance_improvement > 0;

    IF stat_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡æœ‰æ•ˆä¼˜åŒ–è®°å½•', stat_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æœ‰æ•ˆä¼˜åŒ–è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç»Ÿè®¡ä¼˜åŒ–æ‰‹æ®µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    change_type,
    COUNT(*) as total_changes,
    AVG(r.performance_improvement) as avg_improvement,
    MAX(r.performance_improvement) as max_improvement
FROM pg_tuning_audit a
JOIN pg_tuning_review r ON a.change_id = r.change_id
WHERE r.performance_improvement > 0
GROUP BY change_type
ORDER BY avg_improvement DESC;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè®°å½•æ•°é‡ï¼‰
-- è®¡åˆ’: GroupAggregate -> Hash Join
```
