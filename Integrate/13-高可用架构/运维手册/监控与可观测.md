---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\ç›‘æ§ä¸å¯è§‚æµ‹.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šç›‘æ§ä¸å¯è§‚æµ‹ï¼ˆPostgreSQL 18ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)

---

## ğŸ“‹ ç›®å½•

- [Runbookï¼šç›‘æ§ä¸å¯è§‚æµ‹ï¼ˆPostgreSQL 18ï¼‰](#runbookç›‘æ§ä¸å¯è§‚æµ‹postgresql-18)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç›®æ ‡](#ç›®æ ‡)
  - [æŒ‡æ ‡åŸºçº¿](#æŒ‡æ ‡åŸºçº¿)
    - [1. å®ä¾‹æŒ‡æ ‡](#1-å®ä¾‹æŒ‡æ ‡)
    - [2. å­˜å‚¨/IOæŒ‡æ ‡](#2-å­˜å‚¨ioæŒ‡æ ‡)
    - [3. æŸ¥è¯¢æŒ‡æ ‡](#3-æŸ¥è¯¢æŒ‡æ ‡)
    - [4. è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡](#4-è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡)
  - [ä»ªè¡¨æ¿å»ºè®®](#ä»ªè¡¨æ¿å»ºè®®)
    - [Grafanaä»ªè¡¨æ¿é…ç½®](#grafanaä»ªè¡¨æ¿é…ç½®)
  - [æ•…éšœå®šä½è·¯å¾„ï¼ˆç¤ºæ„ï¼‰](#æ•…éšœå®šä½è·¯å¾„ç¤ºæ„)
    - [æ•…éšœå®šä½æµç¨‹](#æ•…éšœå®šä½æµç¨‹)
  - [å‘Šè­¦é—¨é™ï¼ˆå ä½ï¼‰](#å‘Šè­¦é—¨é™å ä½)
    - [å®Œæ•´å‘Šè­¦è§„åˆ™](#å®Œæ•´å‘Šè­¦è§„åˆ™)
  - [æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µï¼ˆå ä½ï¼‰](#æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µå ä½)
    - [å®Œæ•´ç›‘æ§æŸ¥è¯¢é›†åˆ](#å®Œæ•´ç›‘æ§æŸ¥è¯¢é›†åˆ)
  - [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
    - [å¸¸è§ç›‘æ§é—®é¢˜](#å¸¸è§ç›‘æ§é—®é¢˜)
    - [ç›‘æ§æ€§èƒ½ä¼˜åŒ–](#ç›‘æ§æ€§èƒ½ä¼˜åŒ–)
  - [äº¤å‰å¼•ç”¨](#äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ç›®æ ‡

å»ºç«‹æ€§èƒ½ä¸å¥åº·ç›‘æ§åŸºçº¿ï¼Œè¦†ç›–æŒ‡æ ‡ã€å‘Šè­¦ä¸æ•…éšœå®šä½è·¯å¾„ã€‚

## æŒ‡æ ‡åŸºçº¿

- å®ä¾‹ï¼šè¿æ¥æ•°ã€æ´»åŠ¨/ç­‰å¾…ä¼šè¯ã€æ£€æŸ¥ç‚¹ã€WAL é€Ÿç‡
- å­˜å‚¨/IOï¼š`pg_stat_io`ã€è¡¨/ç´¢å¼•è†¨èƒ€ã€è†¨èƒ€æ¯”
- æŸ¥è¯¢ï¼š`pg_stat_statements`ã€TopN æ…¢æŸ¥è¯¢ã€è®¡åˆ’å˜åŒ–
- è‡ªæ²»ä»»åŠ¡ï¼šVACUUM/ANALYZE è¿›åº¦ä¸ç§¯å‹

### 1. å®ä¾‹æŒ‡æ ‡

```sql
-- è¿æ¥æ•°ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    connection_count INT;
BEGIN
    SELECT COUNT(*) INTO connection_count
    FROM pg_stat_activity
    WHERE datname IS NOT NULL;

    RAISE NOTICE 'æ‰¾åˆ° % ä¸ªæ•°æ®åº“è¿æ¥', connection_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¿æ¥æ•°ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') as idle_connections,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_connections
FROM pg_stat_activity
WHERE datname IS NOT NULL
GROUP BY datname;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: HashAggregate

-- æ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥æ£€æŸ¥ç‚¹ç»Ÿè®¡';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_bgwriterè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç‚¹ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- WALé€Ÿç‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥WALé€Ÿç‡';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_walè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'WALé€Ÿç‡æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wal_records,
    wal_fpi,
    wal_bytes,
    wal_write,
    wal_sync,
    wal_write_time,
    wal_sync_time
FROM pg_stat_wal;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

### 2. å­˜å‚¨/IOæŒ‡æ ‡

```sql
-- pg_stat_ioï¼ˆPostgreSQL 16+ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥IOç»Ÿè®¡ï¼ˆéœ€è¦PostgreSQL 16+ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_ioè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 16+ï¼‰';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'IOç»Ÿè®¡æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    fsyncs / NULLIF(reads + writes, 0) * 100 as fsync_ratio
FROM pg_stat_io
ORDER BY reads + writes DESC;

-- è¡¨/ç´¢å¼•è†¨èƒ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    bloated_table_count INT;
BEGIN
    SELECT COUNT(*) INTO bloated_table_count
    FROM pg_stat_user_tables
    WHERE n_dead_tup > 1000;

    IF bloated_table_count = 0 THEN
        RAISE NOTICE 'æœªå‘ç°éœ€è¦å…³æ³¨çš„è¡¨è†¨èƒ€';
    ELSE
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨å­˜åœ¨è†¨èƒ€ï¼ˆæ­»å…ƒç»„>1000ï¼‰', bloated_table_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_total_relation_sizeæˆ–pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è¡¨/ç´¢å¼•è†¨èƒ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    n_live_tup,
    n_dead_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Seq Scan

-- ç´¢å¼•è†¨èƒ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    SELECT COUNT(*) INTO index_count
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public';

    RAISE NOTICE 'æ‰¾åˆ° % ä¸ªpublic schemaçš„ç´¢å¼•', index_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•è†¨èƒ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Seq Scan
```

### 3. æŸ¥è¯¢æŒ‡æ ‡

```sql
-- Top SQLï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    statement_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO statement_count
    FROM pg_stat_statements;

    IF statement_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡SQLç»Ÿè®¡è®°å½•', statement_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°SQLç»Ÿè®¡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Top SQLæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- è®¡åˆ’å˜åŒ–ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    plan_change_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO plan_change_count
    FROM pg_stat_statements
    WHERE plans > 1;

    IF plan_change_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªæŸ¥è¯¢å­˜åœ¨è®¡åˆ’å˜åŒ–', plan_change_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¡åˆ’å˜åŒ–';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¡åˆ’å˜åŒ–ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    plans,
    calls,
    mean_exec_time
FROM pg_stat_statements
WHERE plans > 1
ORDER BY plans DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

### 4. è‡ªæ²»ä»»åŠ¡æŒ‡æ ‡

```sql
-- VACUUM/ANALYZEè¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    vacuum_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO vacuum_count
    FROM pg_stat_user_tables
    WHERE last_autovacuum IS NOT NULL;

    IF vacuum_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨æœ‰autovacuumè®°å½•', vacuum_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°autovacuumè®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'VACUUM/ANALYZEè¿›åº¦æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count,
    n_dead_tup,
    n_mod_since_analyze
FROM pg_stat_user_tables
WHERE last_autovacuum IS NOT NULL
ORDER BY n_dead_tup DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- Autovacuumç§¯å‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    backlog_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO backlog_count
    FROM pg_stat_user_tables
    WHERE n_dead_tup > 10000;

    IF backlog_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨å­˜åœ¨autovacuumç§¯å‹ï¼ˆæ­»å…ƒç»„>10000ï¼‰', backlog_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°autovacuumç§¯å‹';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Autovacuumç§¯å‹æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent,
    last_autovacuum,
    NOW() - last_autovacuum as time_since_vacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

## ä»ªè¡¨æ¿å»ºè®®

- æ¦‚è§ˆã€æŸ¥è¯¢ã€å­˜å‚¨ã€å¤åˆ¶ã€å¤‡ä»½ã€é”™è¯¯ä¸å‘Šè­¦å…­æ¿å—

### Grafanaä»ªè¡¨æ¿é…ç½®

**æ¦‚è§ˆé¢æ¿**:

```json
{
  "panels": [
    {
      "title": "è¿æ¥æ•°",
      "targets": [
        {
          "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
        }
      ]
    },
    {
      "title": "äº‹åŠ¡é€Ÿç‡",
      "targets": [
        {
          "expr": "rate(pg_stat_database_xact_commit{datname=\"postgres\"}[5m])"
        }
      ]
    },
    {
      "title": "ç¼“å†²åŒºå‘½ä¸­ç‡",
      "targets": [
        {
          "expr": "100 * (pg_stat_database_blks_hit{datname=\"postgres\"} / (pg_stat_database_blks_hit{datname=\"postgres\"} + pg_stat_database_blks_read{datname=\"postgres\"}))"
        }
      ]
    }
  ]
}
```

**æŸ¥è¯¢é¢æ¿**:

```json
{
  "panels": [
    {
      "title": "Top 10 æ…¢æŸ¥è¯¢",
      "targets": [
        {
          "expr": "topk(10, pg_stat_statements_mean_exec_time)"
        }
      ]
    },
    {
      "title": "æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(pg_stat_statements_calls[5m]))"
        }
      ]
    }
  ]
}
```

**å­˜å‚¨é¢æ¿**:

```json
{
  "panels": [
    {
      "title": "æ•°æ®åº“å¤§å°",
      "targets": [
        {
          "expr": "pg_database_size_bytes{datname=\"postgres\"}"
        }
      ]
    },
    {
      "title": "è¡¨è†¨èƒ€",
      "targets": [
        {
          "expr": "pg_stat_user_tables_n_dead_tup"
        }
      ]
    }
  ]
}
```

## æ•…éšœå®šä½è·¯å¾„ï¼ˆç¤ºæ„ï¼‰

1) è´Ÿè½½é£™å‡ â†’ æ´»åŠ¨ä¼šè¯/ç­‰å¾…äº‹ä»¶ â†’ é¡¶å±‚ SQL â†’ è®¡åˆ’/é”
2) å¡é¡¿ â†’ `pg_locks`ã€`wait_event`ã€çƒ­ç‚¹ç´¢å¼•/è¡¨
3) è†¨èƒ€ â†’ é‡å»ºç´¢å¼•/è¡¨ç»´æŠ¤çª—å£ â†’ é£é™©è¯„ä¼°

### æ•…éšœå®šä½æµç¨‹

**åœºæ™¯1: è´Ÿè½½é£™å‡**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥æ´»åŠ¨ä¼šè¯
SELECT
    COUNT(*) as active_sessions,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_sessions
FROM pg_stat_activity
WHERE state = 'active';

-- æ­¥éª¤2: æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- æ­¥éª¤3: æ£€æŸ¥Top SQL
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- æ­¥éª¤4: æ£€æŸ¥æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
-- ç²˜è´´Top SQL

-- æ­¥éª¤5: æ£€æŸ¥é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**åœºæ™¯2: å¡é¡¿**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥é”
SELECT
    locktype,
    database,
    relation,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks
WHERE NOT granted
ORDER BY pid;

-- æ­¥éª¤2: æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT
    pid,
    usename,
    datname,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
ORDER BY state_change;

-- æ­¥éª¤3: æ£€æŸ¥çƒ­ç‚¹ç´¢å¼•/è¡¨
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
ORDER BY seq_scan + idx_scan DESC
LIMIT 20;
```

**åœºæ™¯3: è†¨èƒ€**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥è¡¨è†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_live_tup,
    n_dead_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 20;

-- æ­¥éª¤2: æ£€æŸ¥ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 20;

-- æ­¥éª¤3: è¯„ä¼°ç»´æŠ¤çª—å£
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_dead_tup,
    CASE
        WHEN pg_total_relation_size(schemaname||'.'||tablename) > 1073741824 THEN 'éœ€è¦ç»´æŠ¤çª—å£'
        ELSE 'å¯ä»¥åœ¨çº¿ç»´æŠ¤'
    END AS maintenance_risk
FROM pg_stat_user_tables
WHERE n_dead_tup > 100000
ORDER BY n_dead_tup DESC;
```

## å‘Šè­¦é—¨é™ï¼ˆå ä½ï¼‰

- è¿æ¥ä½¿ç”¨ç‡ã€å¤åˆ¶å»¶è¿Ÿã€WAL ç§¯å‹ã€æ…¢æŸ¥è¯¢æ¯”ä¾‹ã€ç£ç›˜ä½¿ç”¨ç‡

### å®Œæ•´å‘Šè­¦è§„åˆ™

```yaml
# prometheus_alerts.yml
groups:
  - name: postgresql_monitoring
    rules:
      # è¿æ¥ä½¿ç”¨ç‡å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: |
          pg_stat_database_numbackends{datname="postgres"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLé«˜è¿æ¥æ•°å‘Šè­¦"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°: {{ $value }}ï¼Œè¶…è¿‡é˜ˆå€¼80"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: PostgreSQLReplicationLag
        expr: |
          pg_wal_lsn_diff(
            pg_current_wal_lsn(),
            pg_last_wal_replay_lsn()
          ) > 1073741824  # 1GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿå‘Šè­¦"
          description: "å¤åˆ¶å»¶è¿Ÿ: {{ $value }} bytes"

      # WALç§¯å‹å‘Šè­¦
      - alert: PostgreSQLWALBacklog
        expr: |
          pg_stat_archiver_last_archived_wal_lag_bytes > 1073741824  # 1GB
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WALç§¯å‹å‘Šè­¦"
          description: "WALç§¯å‹: {{ $value }} bytes"

      # æ…¢æŸ¥è¯¢æ¯”ä¾‹å‘Šè­¦
      - alert: PostgreSQLHighSlowQueryRatio
        expr: |
          count(pg_stat_statements_mean_exec_time > 1000) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢æ¯”ä¾‹é«˜"
          description: "æ…¢æŸ¥è¯¢æ•°é‡: {{ $value }}"

      # ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: PostgreSQLHighDiskUsage
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql"} / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLç£ç›˜ä½¿ç”¨ç‡é«˜"
          description: "ç£ç›˜å¯ç”¨ç©ºé—´: {{ $value }}%"
```

## æ ‡å‡†æŸ¥è¯¢ç‰‡æ®µï¼ˆå ä½ï¼‰

```sql
-- Top SQLï¼ˆéœ€å¯ç”¨ pg_stat_statementsï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    extension_exists BOOLEAN;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) INTO extension_exists;

    IF NOT extension_exists THEN
        RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•è·å–Top SQL';
        RETURN;
    END IF;

    RAISE NOTICE 'æ­£åœ¨æŸ¥è¯¢Top SQL';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Top SQLæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT queryid, calls, total_exec_time, mean_exec_time, rows
FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Sort

-- ç­‰å¾…äº‹ä»¶åˆ†å¸ƒï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_query_count INT;
BEGIN
    SELECT COUNT(*) INTO active_query_count
    FROM pg_stat_activity
    WHERE state = 'active';

    IF active_query_count = 0 THEN
        RAISE NOTICE 'å½“å‰æ— æ´»è·ƒæŸ¥è¯¢';
    ELSE
        RAISE NOTICE 'å½“å‰æœ‰ % ä¸ªæ´»è·ƒæŸ¥è¯¢', active_query_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç­‰å¾…äº‹ä»¶åˆ†å¸ƒæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT wait_event_type, wait_event, count(*)
FROM pg_stat_activity WHERE state = 'active' GROUP BY 1,2 ORDER BY 3 DESC;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: HashAggregate

-- Autovacuum backlogï¼ˆç¤ºæ„ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    SELECT COUNT(*) INTO table_count
    FROM pg_stat_all_tables
    WHERE n_dead_tup > 0;

    IF table_count = 0 THEN
        RAISE NOTICE 'æœªå‘ç°æ­»å…ƒç»„';
    ELSE
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨å­˜åœ¨æ­»å…ƒç»„', table_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_all_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Autovacuum backlogæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT relname, n_dead_tup FROM pg_stat_all_tables ORDER BY n_dead_tup DESC LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Sort
```

### å®Œæ•´ç›‘æ§æŸ¥è¯¢é›†åˆ

```sql
-- 1. ç³»ç»Ÿæ¦‚è§ˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_conn INT;
    active_queries INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO total_conn FROM pg_stat_activity;
    SELECT COUNT(*) INTO active_queries FROM pg_stat_activity WHERE state = 'active';

    RAISE NOTICE 'ç³»ç»Ÿæ¦‚è§ˆ - æ€»è¿æ¥æ•°: %, æ´»è·ƒæŸ¥è¯¢: %', total_conn, active_queries;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'versionæˆ–pg_database_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç³»ç»Ÿæ¦‚è§ˆæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    version() as pg_version,
    pg_size_pretty(pg_database_size(current_database())) as db_size,
    (SELECT COUNT(*) FROM pg_stat_activity) as total_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Result -> SubPlan

-- 2. æ€§èƒ½æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    statement_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO statement_count
    FROM pg_stat_statements;

    IF statement_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡SQLç»Ÿè®¡è®°å½•', statement_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°SQLç»Ÿè®¡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    (SELECT SUM(total_exec_time) FROM pg_stat_statements) as total_query_time,
    (SELECT AVG(mean_exec_time) FROM pg_stat_statements WHERE calls > 100) as avg_query_time,
    (SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000) as slow_queries;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Result -> SubPlan

-- 3. èµ„æºä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    cache_hit_ratio NUMERIC;
    lock_waits INT;
    total_dead_tuples BIGINT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_database'
    ) THEN
        RAISE WARNING 'pg_stat_databaseè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
    INTO cache_hit_ratio
    FROM pg_stat_database
    WHERE datname = current_database();

    SELECT COUNT(*) INTO lock_waits
    FROM pg_stat_activity
    WHERE wait_event_type = 'Lock';

    SELECT SUM(n_dead_tup) INTO total_dead_tuples
    FROM pg_stat_user_tables;

    RAISE NOTICE 'èµ„æºä½¿ç”¨ - ç¼“å­˜å‘½ä¸­ç‡: %%%, é”ç­‰å¾…: %, æ€»æ­»å…ƒç»„: %',
                 COALESCE(cache_hit_ratio, 0), lock_waits, COALESCE(total_dead_tuples, 0);
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'èµ„æºä½¿ç”¨æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
     FROM pg_stat_database WHERE datname = current_database()) as cache_hit_ratio,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type = 'Lock') as lock_waits,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) as total_dead_tuples;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Result -> SubPlan

-- 4. å¤åˆ¶çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    replication_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_replication'
    ) THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨ï¼Œå¯èƒ½æ²¡æœ‰é…ç½®å¤åˆ¶';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO replication_count
    FROM pg_stat_replication;

    IF replication_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå¤åˆ¶è¿æ¥', replication_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å¤åˆ¶è¿æ¥';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¤åˆ¶çŠ¶æ€æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as replication_lag_bytes
FROM pg_stat_replication;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

---

## æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§ç›‘æ§é—®é¢˜

**é—®é¢˜1: æŒ‡æ ‡æ•°æ®ç¼ºå¤±**:

```sql
-- æ£€æŸ¥æ‰©å±•æ˜¯å¦å¯ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    extension_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_extension'
    ) THEN
        RAISE WARNING 'pg_extensionè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO extension_count
    FROM pg_extension
    WHERE extname IN ('pg_stat_statements', 'pg_stat_monitor');

    IF extension_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç›‘æ§æ‰©å±•å·²å¯ç”¨', extension_count;
    ELSE
        RAISE WARNING 'æœªå‘ç°ç›‘æ§æ‰©å±•ï¼ˆpg_stat_statementsæˆ–pg_stat_monitorï¼‰';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_extensionè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ‰©å±•å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_extension WHERE extname IN ('pg_stat_statements', 'pg_stat_monitor');
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æ”¶é›†ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    unanalyzed_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO unanalyzed_count
    FROM pg_stat_user_tables
    WHERE last_analyze IS NULL AND last_autoanalyze IS NULL;

    IF unanalyzed_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªè¡¨æœªæ”¶é›†ç»Ÿè®¡ä¿¡æ¯', unanalyzed_count;
    ELSE
        RAISE NOTICE 'æ‰€æœ‰è¡¨éƒ½å·²æ”¶é›†ç»Ÿè®¡ä¿¡æ¯';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT schemaname, tablename, last_analyze, last_autoanalyze
FROM pg_stat_user_tables
WHERE last_analyze IS NULL AND last_autoanalyze IS NULL;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Seq Scan

-- æ‰‹åŠ¨è§¦å‘ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    ANALYZE;
    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å®Œæˆ';
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å¤±è´¥: %', SQLERRM;
END $$;
```

**é—®é¢˜2: å‘Šè­¦è¯¯æŠ¥**:

```yaml
# è°ƒæ•´å‘Šè­¦é˜ˆå€¼
# æ ¹æ®å®é™…ä¸šåŠ¡è´Ÿè½½è°ƒæ•´å‘Šè­¦é˜ˆå€¼
# ä¾‹å¦‚ï¼šè¿æ¥æ•°å‘Šè­¦é˜ˆå€¼ä»80%è°ƒæ•´ä¸º85%
```

**é—®é¢˜3: Grafanaé¢æ¿æ— æ•°æ®**:

```bash
# æ£€æŸ¥Prometheusæ•°æ®æºè¿æ¥
# åœ¨Grafanaä¸­æµ‹è¯•æ•°æ®æºè¿æ¥

# æ£€æŸ¥postgres_exporteræ˜¯å¦è¿è¡Œ
systemctl status postgres_exporter

# æ£€æŸ¥PrometheusæŠ“å–é…ç½®
curl http://localhost:9187/metrics | head -20
```

### ç›‘æ§æ€§èƒ½ä¼˜åŒ–

```sql
-- 1. é™åˆ¶pg_stat_statementsè®°å½•æ•°
ALTER SYSTEM SET pg_stat_statements.max = 10000;
SELECT pg_reload_conf();

-- 2. å®šæœŸé‡ç½®ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
SELECT pg_stat_statements_reset();

-- 3. ä¼˜åŒ–ç›‘æ§æŸ¥è¯¢
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜å¸¸ç”¨ç›‘æ§æ•°æ®
CREATE MATERIALIZED VIEW monitoring_summary AS
SELECT
    NOW() as check_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries,
    (SELECT AVG(mean_exec_time) FROM pg_stat_statements WHERE calls > 100) as avg_query_time
WITH DATA;

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY monitoring_summary;
```

---

## äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§ç†è®ºåŸºç¡€å’ŒæŒ‡æ ‡ä½“ç³»
- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­è½åœ°æŒ‡å—](../ç›‘æ§ä¸è¯Šæ–­/12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - Prometheus + Grafanaå®Œæ•´éƒ¨ç½²
- â­â­ [æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯](./01-æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯.md) - æ€§èƒ½è°ƒä¼˜æµç¨‹
- â­â­ [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](../ç›‘æ§ä¸è¯Šæ–­/06.04-æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“.md) - å®é™…æ€§èƒ½é—®é¢˜æ¡ˆä¾‹
- â­â­ [æ—¥å¿—ä¸å¯è§‚æµ‹æ€§-è½åœ°æŒ‡å—](./06-æ—¥å¿—ä¸å¯è§‚æµ‹æ€§-è½åœ°æŒ‡å—.md) - æ—¥å¿—é…ç½®å’Œé‡‡é›†

### å¤–éƒ¨èµ„æº

- [PostgreSQLç›‘æ§æ–‡æ¡£](https://www.postgresql.org/docs/current/monitoring-stats.html)
- [pg_stat_statementsæ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafanaå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
