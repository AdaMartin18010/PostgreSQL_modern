---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\04-å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½ï¼š`../../04-é«˜çº§ç‰¹æ€§/03.05-å‘é‡æ•°æ®åº“æ”¯æŒ.md`

---

## ğŸ“‹ ç›®å½•

- [å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. å‰ç½®](#2-å‰ç½®)
    - [2.1 pgvectorå®‰è£…](#21-pgvectorå®‰è£…)
    - [2.2 å¯ç”¨æ‰©å±•](#22-å¯ç”¨æ‰©å±•)
    - [2.3 å‡†å¤‡æ•°æ®è¡¨](#23-å‡†å¤‡æ•°æ®è¡¨)
  - [3. æ­¥éª¤](#3-æ­¥éª¤)
    - [3.1 ç´¢å¼•ç±»å‹é€‰æ‹©](#31-ç´¢å¼•ç±»å‹é€‰æ‹©)
    - [3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰](#32-åœ¨çº¿æŸ¥è¯¢ç»“æ„åŒ–--å‘é‡)
    - [3.3 å…¨æ–‡ + å‘é‡èåˆ](#33-å…¨æ–‡--å‘é‡èåˆ)
  - [4. è¿è¡Œå‚æ•°](#4-è¿è¡Œå‚æ•°)
    - [4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜](#41-æ€§èƒ½å‚æ•°è°ƒä¼˜)
    - [4.2 æ€§èƒ½ç›‘æ§](#42-æ€§èƒ½ç›‘æ§)
    - [4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•](#43-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [5. éªŒè¯](#5-éªŒè¯)
    - [5.1 å¬å›ç‡éªŒè¯](#51-å¬å›ç‡éªŒè¯)
    - [5.2 æ€§èƒ½åŸºçº¿è®°å½•](#52-æ€§èƒ½åŸºçº¿è®°å½•)
  - [6. æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)
    - [6.1 å¸¸è§é—®é¢˜](#61-å¸¸è§é—®é¢˜)
  - [7. ç”Ÿäº§è¿ç»´å®è·µ](#7-ç”Ÿäº§è¿ç»´å®è·µ)
    - [7.1 ç›‘æ§æŒ‡æ ‡](#71-ç›‘æ§æŒ‡æ ‡)
      - [7.1.1 æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰](#711-æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰)
      - [7.1.2 ç›‘æ§æŸ¥è¯¢](#712-ç›‘æ§æŸ¥è¯¢)
      - [7.1.3 PrometheusæŒ‡æ ‡å¯¼å‡º](#713-prometheusæŒ‡æ ‡å¯¼å‡º)
    - [7.2 å‘Šè­¦è§„åˆ™](#72-å‘Šè­¦è§„åˆ™)
      - [7.2.1 å‘Šè­¦è§„åˆ™å®šä¹‰](#721-å‘Šè­¦è§„åˆ™å®šä¹‰)
      - [7.2.2 Prometheuså‘Šè­¦é…ç½®](#722-prometheuså‘Šè­¦é…ç½®)
    - [7.3 æ€§èƒ½ç›‘æ§](#73-æ€§èƒ½ç›‘æ§)
      - [7.3.1 å®æ—¶æ€§èƒ½ç›‘æ§](#731-å®æ—¶æ€§èƒ½ç›‘æ§)
      - [7.3.2 Grafanaä»ªè¡¨æ¿é…ç½®](#732-grafanaä»ªè¡¨æ¿é…ç½®)
    - [7.4 ç´¢å¼•å¥åº·åº¦ç›‘æ§](#74-ç´¢å¼•å¥åº·åº¦ç›‘æ§)
      - [7.4.1 ç´¢å¼•å¥åº·åº¦æ£€æŸ¥](#741-ç´¢å¼•å¥åº·åº¦æ£€æŸ¥)
      - [7.4.2 ç´¢å¼•é‡å»ºå»ºè®®](#742-ç´¢å¼•é‡å»ºå»ºè®®)
    - [7.5 æ•…éšœå¤„ç†æµç¨‹](#75-æ•…éšœå¤„ç†æµç¨‹)
      - [7.5.1 æ•…éšœåˆ†ç±»](#751-æ•…éšœåˆ†ç±»)
      - [7.5.2 æ•…éšœå¤„ç†æ­¥éª¤](#752-æ•…éšœå¤„ç†æ­¥éª¤)
      - [7.5.3 æ•…éšœå¤„ç†æ¸…å•](#753-æ•…éšœå¤„ç†æ¸…å•)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)

---

## 1. ç›®æ ‡

- å»ºç«‹"å‘é‡å¬å› + ç»“æ„åŒ–è¿‡æ»¤ + å…¨æ–‡æƒé‡"çš„æ··åˆæ£€ç´¢æµæ°´çº¿ï¼Œæ”¯æŒåœ¨çº¿æŸ¥è¯¢ä¸ç¦»çº¿é‡æ’ã€‚

## 2. å‰ç½®

- å®‰è£… `pgvector`ï¼›å‡†å¤‡ `docs(id, text, embedding vector(n))`ï¼›é€‰æ‹©ç´¢å¼•ï¼ˆHNSW/IVFFlat/PQï¼‰å¹¶ ANALYZEã€‚

### 2.1 pgvectorå®‰è£…

```bash
# æ–¹æ³•1: ä½¿ç”¨aptå®‰è£…ï¼ˆUbuntu/Debianï¼‰
sudo apt-get install postgresql-14-pgvector

# æ–¹æ³•2: ä»æºç ç¼–è¯‘
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# æ–¹æ³•3: ä½¿ç”¨Docker
docker pull pgvector/pgvector:pg14
```

### 2.2 å¯ç”¨æ‰©å±•

```sql
-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- éªŒè¯å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- æ£€æŸ¥ç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';
```

### 2.3 å‡†å¤‡æ•°æ®è¡¨

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE docs (
    id SERIAL PRIMARY KEY,
    text TEXT NOT NULL,
    embedding vector(1536),  -- OpenAI ada-002ç»´åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    category VARCHAR(100),
    metadata JSONB
);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX docs_text_gin ON docs USING gin(to_tsvector('simple', text));

-- åˆ›å»ºç»“æ„åŒ–å­—æ®µç´¢å¼•
CREATE INDEX docs_created_at_idx ON docs(created_at);
CREATE INDEX docs_category_idx ON docs(category);
```

## 3. æ­¥éª¤

1) åˆ›å»ºç´¢å¼•ï¼š

    ```sql
    CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
    ```

### 3.1 ç´¢å¼•ç±»å‹é€‰æ‹©

**HNSWç´¢å¼•ï¼ˆæ¨èç”¨äºé«˜ç»´å‘é‡ï¼‰**:

```sql
-- HNSWç´¢å¼•åˆ›å»º
CREATE INDEX docs_hnsw ON docs
USING hnsw (embedding vector_l2_ops)
WITH (
    m = 32,              -- æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼ˆ16-64ï¼‰
    ef_construction = 200  -- æ„å»ºæ—¶çš„å€™é€‰æ•°ï¼ˆ100-1000ï¼‰
);

-- æŸ¥è¯¢æ—¶è®¾ç½®ef_searchï¼ˆå½±å“å¬å›ç‡å’Œæ€§èƒ½ï¼‰
SET ivfflat.probes = 100;  -- æ³¨æ„ï¼šHNSWä½¿ç”¨ef_searchå‚æ•°
```

**IVFFlatç´¢å¼•ï¼ˆæ¨èç”¨äºå¤§è§„æ¨¡æ•°æ®ï¼‰**:

```sql
-- IVFFlatç´¢å¼•åˆ›å»º
CREATE INDEX docs_ivfflat ON docs
USING ivfflat (embedding vector_l2_ops)
WITH (
    lists = 100  -- èšç±»ä¸­å¿ƒæ•°ï¼ˆå»ºè®®ï¼šrows/1000ï¼‰
);

-- æŸ¥è¯¢æ—¶è®¾ç½®probes
SET ivfflat.probes = 10;  -- æœç´¢çš„èšç±»æ•°ï¼ˆ1-listsï¼‰
```

**ç´¢å¼•é€‰æ‹©å»ºè®®**:

| åœºæ™¯ | æ¨èç´¢å¼• | åŸå›  |
|------|---------|------|
| é«˜ç»´å‘é‡(>100ç»´) | HNSW | æ›´å¥½çš„å¬å›ç‡ |
| å¤§è§„æ¨¡æ•°æ®(>100ä¸‡) | IVFFlat | æ›´å¿«çš„æ„å»ºé€Ÿåº¦ |
| å®æ—¶æŸ¥è¯¢ | HNSW | æ›´ä½çš„å»¶è¿Ÿ |
| æ‰¹é‡æŸ¥è¯¢ | IVFFlat | æ›´å¥½çš„ååé‡ |

### 3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰

```sql
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- æ–¹æ³•1: å…ˆè¿‡æ»¤åæ’åºï¼ˆæ¨èï¼‰
SELECT id, text, embedding <-> $1 AS distance
FROM docs
WHERE created_at >= now() - interval '7 day'
  AND category = 'technology'
ORDER BY embedding <-> $1
LIMIT 50;

-- æ–¹æ³•2: ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–
WITH filtered AS (
    SELECT id, text, embedding
    FROM docs
    WHERE created_at >= now() - interval '7 day'
      AND category = 'technology'
)
SELECT id, text, embedding <-> $1 AS distance
FROM filtered
ORDER BY embedding <-> $1
LIMIT 50;
```

### 3.3 å…¨æ–‡ + å‘é‡èåˆ

```sql
WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
    ORDER BY tr DESC LIMIT 500
), v AS (
    SELECT id, embedding <-> $1 AS dist
    FROM docs
    WHERE id IN (SELECT id FROM s)
    ORDER BY dist ASC LIMIT 100
)
SELECT d.id, d.text, 0.6*(1.0/v.dist) + 0.4*s.tr AS score
FROM v d JOIN s ON d.id = s.id
ORDER BY score DESC LIMIT 50;
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- ä½¿ç”¨åŠ æƒèåˆ
WITH text_results AS (
    SELECT
        id,
        text,
        ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', $2)) AS text_score
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', $2)
    ORDER BY text_score DESC
    LIMIT 500
),
vector_results AS (
    SELECT
        id,
        embedding <-> $1 AS vector_distance
    FROM docs
    WHERE id IN (SELECT id FROM text_results)
    ORDER BY embedding <-> $1
    LIMIT 100
)
SELECT
    d.id,
    d.text,
    -- å½’ä¸€åŒ–åˆ†æ•°å¹¶åŠ æƒèåˆ
    0.6 * (1.0 / (1.0 + v.vector_distance)) + 0.4 * t.text_score AS combined_score
FROM vector_results v
JOIN text_results t ON v.id = t.id
JOIN docs d ON v.id = d.id
ORDER BY combined_score DESC
LIMIT 50;
```

## 4. è¿è¡Œå‚æ•°

- `SET ivfflat.probes = 10;` æŸ¥è¯¢é«˜å¬å›æ—¶è°ƒå¤§ï¼›
- æ§åˆ¶ `work_mem`ï¼Œé¿å…ANNä¸æ’åºå†…å­˜çˆ†ï¼›
- ç›‘æ§å»¶è¿ŸTP95/TP99 ä¸å¬å›æŒ‡æ ‡ã€‚

### 4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜

```sql
-- 1. è°ƒæ•´work_memï¼ˆå‘é‡æŸ¥è¯¢éœ€è¦æ›´å¤šå†…å­˜ï¼‰
SET work_mem = '256MB';

-- 2. è°ƒæ•´IVFFlat probesï¼ˆå¬å›ç‡ vs æ€§èƒ½æƒè¡¡ï¼‰
SET ivfflat.probes = 10;   -- é»˜è®¤å€¼ï¼Œå¿«é€Ÿä½†å¬å›ç‡è¾ƒä½
SET ivfflat.probes = 50;   -- å¹³è¡¡æ¨¡å¼
SET ivfflat.probes = 100;  -- é«˜å¬å›ç‡ï¼Œä½†è¾ƒæ…¢

-- 3. è°ƒæ•´HNSW ef_searchï¼ˆä»…HNSWç´¢å¼•ï¼‰
-- æ³¨æ„ï¼špgvectorçš„HNSWå®ç°å¯èƒ½ä½¿ç”¨ä¸åŒå‚æ•°å
-- æŸ¥è¯¢æ—¶åœ¨ORDER BYå­å¥ä¸­æŒ‡å®šLIMITä¼šå½±å“æœç´¢èŒƒå›´

-- 4. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
```

### 4.2 æ€§èƒ½ç›‘æ§

```sql
-- 1. æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;

-- 2. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'docs'
AND indexname LIKE '%vector%';

-- 3. è¡¨å¤§å°å’Œç´¢å¼•å¤§å°
SELECT
    pg_size_pretty(pg_relation_size('docs')) AS table_size,
    pg_size_pretty(pg_relation_size('docs_hnsw')) AS index_size;
```

### 4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åˆ›å»ºæµ‹è¯•å‡½æ•°
CREATE OR REPLACE FUNCTION benchmark_vector_search(
    query_vector vector(1536),
    limit_count INTEGER DEFAULT 50
)
RETURNS TABLE (
    execution_time_ms NUMERIC,
    result_count BIGINT
) AS $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    result_count BIGINT;
BEGIN
    start_time := clock_timestamp();

    SELECT COUNT(*) INTO result_count
    FROM (
        SELECT id
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT limit_count
    ) sub;

    end_time := clock_timestamp();

    RETURN QUERY SELECT
        EXTRACT(EPOCH FROM (end_time - start_time)) * 1000 AS execution_time_ms,
        result_count;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒåŸºå‡†æµ‹è¯•
SELECT * FROM benchmark_vector_search(
    (SELECT embedding FROM docs LIMIT 1),
    50
);
```

## 5. éªŒè¯

- ä¸æš´åŠ›çœŸå€¼å¯¹æ¯” Recall@kï¼›æ€§èƒ½åŸºçº¿è®°å½•ä¸å›å½’æ£€æŸ¥ã€‚

### 5.1 å¬å›ç‡éªŒè¯

```sql
-- åˆ›å»ºå¬å›ç‡éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION verify_recall_at_k(
    query_vector vector(1536),
    k INTEGER DEFAULT 50,
    ground_truth_limit INTEGER DEFAULT 1000
)
RETURNS TABLE (
    recall_at_k NUMERIC,
    precision_at_k NUMERIC
) AS $$
DECLARE
    approximate_results INTEGER[];
    ground_truth_results INTEGER[];
    intersection_count INTEGER;
BEGIN
    -- è¿‘ä¼¼æœç´¢ç»“æœ
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO approximate_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT k
    ) sub;

    -- çœŸå®ç»“æœï¼ˆæš´åŠ›æœç´¢ï¼‰
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO ground_truth_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT ground_truth_limit
    ) sub;

    -- è®¡ç®—äº¤é›†
    SELECT COUNT(*) INTO intersection_count
    FROM unnest(approximate_results) AS a(id)
    WHERE id = ANY(ground_truth_results[1:k]);

    RETURN QUERY SELECT
        intersection_count::NUMERIC / k AS recall_at_k,
        intersection_count::NUMERIC / k AS precision_at_k;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒéªŒè¯
SELECT * FROM verify_recall_at_k(
    (SELECT embedding FROM docs LIMIT 1),
    50,
    1000
);
```

### 5.2 æ€§èƒ½åŸºçº¿è®°å½•

```sql
-- åˆ›å»ºæ€§èƒ½åŸºçº¿è¡¨
CREATE TABLE IF NOT EXISTS vector_search_performance_baseline (
    test_id SERIAL PRIMARY KEY,
    test_time TIMESTAMP DEFAULT NOW(),
    query_type VARCHAR(50),  -- 'vector_only', 'hybrid', 'fulltext'
    index_type VARCHAR(50),   -- 'hnsw', 'ivfflat', 'none'
    k_value INTEGER,
    execution_time_ms NUMERIC,
    recall_at_k NUMERIC,
    result_count BIGINT,
    notes TEXT
);

-- è®°å½•æ€§èƒ½åŸºçº¿
INSERT INTO vector_search_performance_baseline (
    query_type,
    index_type,
    k_value,
    execution_time_ms,
    recall_at_k
)
VALUES (
    'vector_only',
    'hnsw',
    50,
    25.5,
    0.95
);
```

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: ç´¢å¼•æ„å»ºæ…¢**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ„å»ºè¿›åº¦
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%';

-- è§£å†³æ–¹æ¡ˆï¼šåˆ†æ‰¹æ„å»ºæˆ–ä½¿ç”¨CONCURRENTLY
CREATE INDEX CONCURRENTLY docs_hnsw ON docs USING hnsw (embedding vector_l2_ops);
```

**é—®é¢˜2: æŸ¥è¯¢æ€§èƒ½å·®**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, text
FROM docs
ORDER BY embedding <-> $1
LIMIT 50;

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. å¢åŠ ivfflat.probes
-- 2. æ£€æŸ¥work_memè®¾ç½®
-- 3. è€ƒè™‘é‡å»ºç´¢å¼•
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**:

```sql
-- æ£€æŸ¥å½“å‰work_mem
SHOW work_mem;

-- è§£å†³æ–¹æ¡ˆï¼šå¢åŠ work_memæˆ–å‡å°‘æŸ¥è¯¢èŒƒå›´
SET work_mem = '512MB';
```

## 7. ç”Ÿäº§è¿ç»´å®è·µ

### 7.1 ç›‘æ§æŒ‡æ ‡

#### 7.1.1 æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰

**æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡**:

- `p50_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿä¸­ä½æ•°
- `p95_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿ95åˆ†ä½
- `p99_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿ99åˆ†ä½
- `query_qps`: æ¯ç§’æŸ¥è¯¢æ•°
- `error_rate`: é”™è¯¯ç‡

**å¬å›ç‡æŒ‡æ ‡**:

- `recall_at_k`: Top-Kå¬å›ç‡
- `precision_at_k`: Top-Kç²¾ç¡®ç‡
- `mrr_score`: å¹³å‡å€’æ•°æ’å

**èµ„æºæŒ‡æ ‡**:

- `index_size_gb`: ç´¢å¼•å¤§å°
- `memory_usage_percent`: å†…å­˜ä½¿ç”¨ç‡
- `cpu_usage_percent`: CPUä½¿ç”¨ç‡
- `disk_io_read_mb_s`: ç£ç›˜è¯»IO
- `disk_io_write_mb_s`: ç£ç›˜å†™IO

#### 7.1.2 ç›‘æ§æŸ¥è¯¢

```sql
-- åˆ›å»ºç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW vector_search_metrics AS
SELECT
    NOW() AS timestamp,
    'vector_search' AS metric_type,
    COUNT(*) AS total_queries,
    PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY execution_time_ms) AS p50_latency_ms,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) AS p95_latency_ms,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY execution_time_ms) AS p99_latency_ms,
    AVG(execution_time_ms) AS avg_latency_ms,
    AVG(recall_at_k) AS avg_recall_at_k
FROM vector_search_performance_baseline
WHERE test_time >= NOW() - INTERVAL '1 hour';

-- æŸ¥è¯¢å½“å‰æŒ‡æ ‡
SELECT * FROM vector_search_metrics;
```

#### 7.1.3 PrometheusæŒ‡æ ‡å¯¼å‡º

```sql
-- åˆ›å»ºæ‰©å±•è¡¨ç”¨äºPrometheusæŠ“å–
CREATE TABLE IF NOT EXISTS vector_search_metrics_export (
    timestamp TIMESTAMP DEFAULT NOW(),
    metric_name TEXT,
    metric_value NUMERIC,
    labels JSONB
);

-- å®šæœŸæ›´æ–°æŒ‡æ ‡ï¼ˆé€šè¿‡å®šæ—¶ä»»åŠ¡ï¼‰
CREATE OR REPLACE FUNCTION update_vector_metrics()
RETURNS void AS $$
BEGIN
    -- æ’å…¥æŸ¥è¯¢å»¶è¿ŸæŒ‡æ ‡
    INSERT INTO vector_search_metrics_export (metric_name, metric_value, labels)
    SELECT
        'vector_search_p95_latency_ms',
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms),
        jsonb_build_object('index_type', index_type, 'query_type', query_type)
    FROM vector_search_performance_baseline
    WHERE test_time >= NOW() - INTERVAL '5 minutes'
    GROUP BY index_type, query_type;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 å‘Šè­¦è§„åˆ™

#### 7.2.1 å‘Šè­¦è§„åˆ™å®šä¹‰

**P0çº§å‘Šè­¦ï¼ˆä¸¥é‡ï¼‰**:

- æŸ¥è¯¢å»¶è¿Ÿ P95 > 100ms æŒç»­5åˆ†é’Ÿ
- é”™è¯¯ç‡ > 1% æŒç»­5åˆ†é’Ÿ
- å¬å›ç‡ < 90% æŒç»­10åˆ†é’Ÿ
- ç´¢å¼•æŸåæ£€æµ‹

**P1çº§å‘Šè­¦ï¼ˆè­¦å‘Šï¼‰**:

- æŸ¥è¯¢å»¶è¿Ÿ P95 > 50ms æŒç»­10åˆ†é’Ÿ
- å†…å­˜ä½¿ç”¨ç‡ > 80% æŒç»­5åˆ†é’Ÿ
- CPUä½¿ç”¨ç‡ > 85% æŒç»­10åˆ†é’Ÿ
- ç´¢å¼•å¤§å°å¢é•¿å¼‚å¸¸

#### 7.2.2 Prometheuså‘Šè­¦é…ç½®

```yaml
# prometheus-alerts.yml
groups:
  - name: vector_search_alerts
    interval: 30s
    rules:
      # P0: æŸ¥è¯¢å»¶è¿Ÿå‘Šè­¦
      - alert: VectorSearchHighLatency
        expr: vector_search_p95_latency_ms > 100
        for: 5m
        labels:
          severity: critical
          component: vector_search
        annotations:
          summary: "å‘é‡æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜"
          description: "P95å»¶è¿Ÿ {{ $value }}ms è¶…è¿‡é˜ˆå€¼ 100ms"

      # P0: é”™è¯¯ç‡å‘Šè­¦
      - alert: VectorSearchHighErrorRate
        expr: rate(vector_search_errors_total[5m]) / rate(vector_search_queries_total[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "å‘é‡æŸ¥è¯¢é”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡é˜ˆå€¼ 1%"

      # P1: å¬å›ç‡å‘Šè­¦
      - alert: VectorSearchLowRecall
        expr: vector_search_recall_at_k < 0.90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "å‘é‡æŸ¥è¯¢å¬å›ç‡åä½"
          description: "å¬å›ç‡ {{ $value }} ä½äºé˜ˆå€¼ 90%"

      # P1: å†…å­˜ä½¿ç”¨å‘Šè­¦
      - alert: VectorSearchHighMemory
        expr: vector_search_memory_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å‘é‡æœç´¢å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡ {{ $value }}% è¶…è¿‡é˜ˆå€¼ 80%"
```

### 7.3 æ€§èƒ½ç›‘æ§

#### 7.3.1 å®æ—¶æ€§èƒ½ç›‘æ§

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§å‡½æ•°
CREATE OR REPLACE FUNCTION monitor_vector_search_performance(
    time_window INTERVAL DEFAULT '1 hour'
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC,
    threshold_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'p95_latency_ms'::TEXT,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms),
        50.0,
        CASE
            WHEN PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) > 50 THEN 'ALERT'
            ELSE 'OK'
        END
    FROM vector_search_performance_baseline
    WHERE test_time >= NOW() - time_window
    GROUP BY 1;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æ§
SELECT * FROM monitor_vector_search_performance('1 hour');
```

#### 7.3.2 Grafanaä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "Vector Search Performance",
    "panels": [
      {
        "title": "Query Latency (P50/P95/P99)",
        "targets": [
          {
            "expr": "vector_search_p50_latency_ms",
            "legendFormat": "P50"
          },
          {
            "expr": "vector_search_p95_latency_ms",
            "legendFormat": "P95"
          },
          {
            "expr": "vector_search_p99_latency_ms",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "Query QPS",
        "targets": [
          {
            "expr": "rate(vector_search_queries_total[5m])",
            "legendFormat": "QPS"
          }
        ]
      },
      {
        "title": "Recall at K",
        "targets": [
          {
            "expr": "vector_search_recall_at_k",
            "legendFormat": "Recall@K"
          }
        ]
      }
    ]
  }
}
```

### 7.4 ç´¢å¼•å¥åº·åº¦ç›‘æ§

#### 7.4.1 ç´¢å¼•å¥åº·åº¦æ£€æŸ¥

```sql
-- ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_vector_index_health()
RETURNS TABLE (
    index_name TEXT,
    table_name TEXT,
    index_size_gb NUMERIC,
    bloat_ratio NUMERIC,
    index_scan_count BIGINT,
    index_usage_ratio NUMERIC,
    health_status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        i.indexname::TEXT,
        i.tablename::TEXT,
        pg_size_pretty(pg_relation_size(i.indexrelid))::NUMERIC / (1024*1024*1024) AS index_size_gb,
        -- ç®€åŒ–çš„è†¨èƒ€ç‡è®¡ç®—
        CASE
            WHEN pg_stat_user_indexes.idx_scan > 0 THEN
                (pg_relation_size(i.indexrelid) - pg_relation_size(i.indexrelid))::NUMERIC / pg_relation_size(i.indexrelid)
            ELSE 0
        END AS bloat_ratio,
        pg_stat_user_indexes.idx_scan AS index_scan_count,
        CASE
            WHEN pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan > 0 THEN
                pg_stat_user_indexes.idx_scan::NUMERIC /
                (pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan)
            ELSE 0
        END AS index_usage_ratio,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'UNUSED'
            WHEN (pg_stat_user_indexes.idx_scan::NUMERIC /
                  NULLIF(pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan, 0)) < 0.5 THEN 'UNDERUSED'
            ELSE 'HEALTHY'
        END AS health_status
    FROM pg_indexes i
    JOIN pg_stat_user_indexes ON i.indexname = pg_stat_user_indexes.indexname
    JOIN pg_stat_user_tables ON i.tablename = pg_stat_user_tables.relname
    WHERE i.indexname LIKE '%vector%' OR i.indexname LIKE '%hnsw%' OR i.indexname LIKE '%ivfflat%';
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ£€æŸ¥
SELECT * FROM check_vector_index_health();
```

#### 7.4.2 ç´¢å¼•é‡å»ºå»ºè®®

```sql
-- ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®
CREATE OR REPLACE FUNCTION get_index_rebuild_recommendations()
RETURNS TABLE (
    index_name TEXT,
    recommendation TEXT,
    priority TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        i.indexname::TEXT,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'ç´¢å¼•æœªè¢«ä½¿ç”¨ï¼Œè€ƒè™‘åˆ é™¤'
            WHEN pg_relation_size(i.indexrelid) > pg_relation_size(i.tablename)::regclass * 2 THEN 'ç´¢å¼•å¤§å°å¼‚å¸¸ï¼Œè€ƒè™‘é‡å»º'
            WHEN (pg_stat_user_indexes.idx_scan::NUMERIC /
                  NULLIF(pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan, 0)) < 0.3 THEN 'ç´¢å¼•ä½¿ç”¨ç‡ä½ï¼Œè€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢'
            ELSE 'ç´¢å¼•å¥åº·'
        END AS recommendation,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'LOW'
            WHEN pg_relation_size(i.indexrelid) > pg_relation_size(i.tablename)::regclass * 2 THEN 'HIGH'
            ELSE 'MEDIUM'
        END AS priority
    FROM pg_indexes i
    JOIN pg_stat_user_indexes ON i.indexname = pg_stat_user_indexes.indexname
    JOIN pg_stat_user_tables ON i.tablename = pg_stat_user_tables.relname
    WHERE i.indexname LIKE '%vector%';
END;
$$ LANGUAGE plpgsql;
```

### 7.5 æ•…éšœå¤„ç†æµç¨‹

#### 7.5.1 æ•…éšœåˆ†ç±»

**P0æ•…éšœï¼ˆä¸¥é‡ï¼‰**:

- æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- æ•°æ®æŸå
- ç´¢å¼•æŸå

**P1æ•…éšœï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**:

- æŸ¥è¯¢æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼ˆP95 > 100msï¼‰
- å¬å›ç‡æ˜¾è‘—ä¸‹é™ï¼ˆ< 85%ï¼‰
- èµ„æºè€—å°½ï¼ˆå†…å­˜/CPUï¼‰

**P2æ•…éšœï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**:

- æŸ¥è¯¢æ€§èƒ½è½»å¾®ä¸‹é™ï¼ˆP95 > 50msï¼‰
- èµ„æºä½¿ç”¨ç‡åé«˜

#### 7.5.2 æ•…éšœå¤„ç†æ­¥éª¤

**æ­¥éª¤1: é—®é¢˜å®šä½**:

```sql
-- æ£€æŸ¥å½“å‰æŸ¥è¯¢çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE query LIKE '%vector%' OR query LIKE '%embedding%'
ORDER BY query_start;

-- æ£€æŸ¥ç´¢å¼•çŠ¶æ€
SELECT * FROM check_vector_index_health();

-- æ£€æŸ¥èµ„æºä½¿ç”¨
SELECT
    pg_size_pretty(pg_database_size(current_database())) AS db_size,
    pg_size_pretty(sum(pg_relation_size(indexrelid))) AS total_index_size
FROM pg_stat_user_indexes
WHERE indexrelname LIKE '%vector%';
```

**æ­¥éª¤2: å¿«é€Ÿæ¢å¤**:

```sql
-- æ–¹æ¡ˆ1: å¢åŠ work_mem
SET work_mem = '1GB';

-- æ–¹æ¡ˆ2: é™ä½æŸ¥è¯¢ç²¾åº¦ï¼ˆä¸´æ—¶ï¼‰
SET ivfflat.probes = 5;  -- é™ä½probesä»¥æå‡é€Ÿåº¦

-- æ–¹æ¡ˆ3: ç»ˆæ­¢æ…¢æŸ¥è¯¢
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE query LIKE '%vector%'
  AND state = 'active'
  AND query_start < NOW() - INTERVAL '30 seconds';
```

**æ­¥éª¤3: æ ¹æœ¬è§£å†³**:

```sql
-- é‡å»ºç´¢å¼•ï¼ˆéœ€è¦ç»´æŠ¤çª—å£ï¼‰
REINDEX INDEX CONCURRENTLY docs_hnsw;

-- æˆ–åˆ é™¤é‡å»º
DROP INDEX CONCURRENTLY docs_hnsw;
CREATE INDEX CONCURRENTLY docs_hnsw ON docs
USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=64);

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE docs;
```

#### 7.5.3 æ•…éšœå¤„ç†æ¸…å•

**P0æ•…éšœå¤„ç†æ¸…å•**:

- [ ] ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
- [ ] æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé”™è¯¯æ—¥å¿—
- [ ] æ‰§è¡Œå¿«é€Ÿæ¢å¤æ“ä½œ
- [ ] éªŒè¯æœåŠ¡æ¢å¤
- [ ] è®°å½•æ•…éšœæ ¹å› 
- [ ] åˆ¶å®šé¢„é˜²æªæ–½

**P1æ•…éšœå¤„ç†æ¸…å•**:

- [ ] æ”¶é›†æ€§èƒ½æŒ‡æ ‡
- [ ] åˆ†ææ€§èƒ½ä¸‹é™åŸå› 
- [ ] æ‰§è¡Œä¼˜åŒ–æ“ä½œ
- [ ] éªŒè¯æ€§èƒ½æ”¹å–„
- [ ] è®°å½•ä¼˜åŒ–æªæ–½

## 8. æœ€ä½³å®è·µ

1. **ç´¢å¼•é€‰æ‹©**: é«˜ç»´å‘é‡ç”¨HNSWï¼Œå¤§è§„æ¨¡æ•°æ®ç”¨IVFFlat
2. **å‚æ•°è°ƒä¼˜**: æ ¹æ®å¬å›ç‡å’Œæ€§èƒ½éœ€æ±‚å¹³è¡¡probes/ef_search
3. **æ··åˆæŸ¥è¯¢**: å…ˆç»“æ„åŒ–è¿‡æ»¤ï¼Œå†å‘é‡æœç´¢ï¼Œæœ€åèåˆæ’åº
4. **ç›‘æ§æŒ‡æ ‡**: å®šæœŸæ£€æŸ¥æŸ¥è¯¢å»¶è¿Ÿã€å¬å›ç‡ã€ç´¢å¼•ä½¿ç”¨æƒ…å†µ
5. **å®šæœŸç»´æŠ¤**: å®šæœŸVACUUMå’ŒANALYZEï¼Œé‡å»ºç´¢å¼•ä»¥ä¼˜åŒ–æ€§èƒ½
