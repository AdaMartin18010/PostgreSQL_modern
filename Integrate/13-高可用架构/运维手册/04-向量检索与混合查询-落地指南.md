---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\04-å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½ï¼š`../../04-é«˜çº§ç‰¹æ€§/03.05-å‘é‡æ•°æ®åº“æ”¯æŒ.md`

---

## ğŸ“‹ ç›®å½•

- [å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. å‰ç½®](#2-å‰ç½®)
    - [2.1 pgvectorå®‰è£…](#21-pgvectorå®‰è£…)
    - [2.2 å¯ç”¨æ‰©å±•](#22-å¯ç”¨æ‰©å±•)
    - [2.3 å‡†å¤‡æ•°æ®è¡¨](#23-å‡†å¤‡æ•°æ®è¡¨)
  - [3. æ­¥éª¤](#3-æ­¥éª¤)
    - [3.1 ç´¢å¼•ç±»å‹é€‰æ‹©](#31-ç´¢å¼•ç±»å‹é€‰æ‹©)
    - [3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰](#32-åœ¨çº¿æŸ¥è¯¢ç»“æ„åŒ–--å‘é‡)
    - [3.3 å…¨æ–‡ + å‘é‡èåˆ](#33-å…¨æ–‡--å‘é‡èåˆ)
  - [4. è¿è¡Œå‚æ•°](#4-è¿è¡Œå‚æ•°)
    - [4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜](#41-æ€§èƒ½å‚æ•°è°ƒä¼˜)
    - [4.2 æ€§èƒ½ç›‘æ§](#42-æ€§èƒ½ç›‘æ§)
    - [4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•](#43-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [5. éªŒè¯](#5-éªŒè¯)
    - [5.1 å¬å›ç‡éªŒè¯](#51-å¬å›ç‡éªŒè¯)
    - [5.2 æ€§èƒ½åŸºçº¿è®°å½•](#52-æ€§èƒ½åŸºçº¿è®°å½•)
  - [6. æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)
    - [6.1 å¸¸è§é—®é¢˜](#61-å¸¸è§é—®é¢˜)
  - [7. ç”Ÿäº§è¿ç»´å®è·µ](#7-ç”Ÿäº§è¿ç»´å®è·µ)
    - [7.1 ç›‘æ§æŒ‡æ ‡](#71-ç›‘æ§æŒ‡æ ‡)
      - [7.1.1 æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰](#711-æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰)
      - [7.1.2 ç›‘æ§æŸ¥è¯¢](#712-ç›‘æ§æŸ¥è¯¢)
      - [7.1.3 PrometheusæŒ‡æ ‡å¯¼å‡º](#713-prometheusæŒ‡æ ‡å¯¼å‡º)
    - [7.2 å‘Šè­¦è§„åˆ™](#72-å‘Šè­¦è§„åˆ™)
      - [7.2.1 å‘Šè­¦è§„åˆ™å®šä¹‰](#721-å‘Šè­¦è§„åˆ™å®šä¹‰)
      - [7.2.2 Prometheuså‘Šè­¦é…ç½®](#722-prometheuså‘Šè­¦é…ç½®)
    - [7.3 æ€§èƒ½ç›‘æ§](#73-æ€§èƒ½ç›‘æ§)
      - [7.3.1 å®æ—¶æ€§èƒ½ç›‘æ§](#731-å®æ—¶æ€§èƒ½ç›‘æ§)
      - [7.3.2 Grafanaä»ªè¡¨æ¿é…ç½®](#732-grafanaä»ªè¡¨æ¿é…ç½®)
    - [7.4 ç´¢å¼•å¥åº·åº¦ç›‘æ§](#74-ç´¢å¼•å¥åº·åº¦ç›‘æ§)
      - [7.4.1 ç´¢å¼•å¥åº·åº¦æ£€æŸ¥](#741-ç´¢å¼•å¥åº·åº¦æ£€æŸ¥)
      - [7.4.2 ç´¢å¼•é‡å»ºå»ºè®®](#742-ç´¢å¼•é‡å»ºå»ºè®®)
    - [7.5 æ•…éšœå¤„ç†æµç¨‹](#75-æ•…éšœå¤„ç†æµç¨‹)
      - [7.5.1 æ•…éšœåˆ†ç±»](#751-æ•…éšœåˆ†ç±»)
      - [7.5.2 æ•…éšœå¤„ç†æ­¥éª¤](#752-æ•…éšœå¤„ç†æ­¥éª¤)
      - [7.5.3 æ•…éšœå¤„ç†æ¸…å•](#753-æ•…éšœå¤„ç†æ¸…å•)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)

---

## 1. ç›®æ ‡

- å»ºç«‹"å‘é‡å¬å› + ç»“æ„åŒ–è¿‡æ»¤ + å…¨æ–‡æƒé‡"çš„æ··åˆæ£€ç´¢æµæ°´çº¿ï¼Œæ”¯æŒåœ¨çº¿æŸ¥è¯¢ä¸ç¦»çº¿é‡æ’ã€‚

## 2. å‰ç½®

- å®‰è£… `pgvector`ï¼›å‡†å¤‡ `docs(id, text, embedding vector(n))`ï¼›é€‰æ‹©ç´¢å¼•ï¼ˆHNSW/IVFFlat/PQï¼‰å¹¶ ANALYZEã€‚

### 2.1 pgvectorå®‰è£…

```bash
# æ–¹æ³•1: ä½¿ç”¨aptå®‰è£…ï¼ˆUbuntu/Debianï¼‰
sudo apt-get install postgresql-14-pgvector

# æ–¹æ³•2: ä»æºç ç¼–è¯‘
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# æ–¹æ³•3: ä½¿ç”¨Docker
docker pull pgvector/pgvector:pg14
```

### 2.2 å¯ç”¨æ‰©å±•

```sql
-- åˆ›å»ºæ‰©å±•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_available_extensions WHERE name = 'vector'
    ) THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•ä¸å¯ç”¨ï¼Œè¯·å…ˆå®‰è£…';
    END IF;

    CREATE EXTENSION IF NOT EXISTS vector;
    RAISE NOTICE 'pgvectoræ‰©å±•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'pgvectoræ‰©å±•ä¸å¯ç”¨ï¼Œè¯·å…ˆå®‰è£…';
    WHEN duplicate_object THEN
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºpgvectoræ‰©å±•å¤±è´¥: %', SQLERRM;
END $$;

-- éªŒè¯å®‰è£…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    ext_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_available_extensions'
    ) THEN
        RAISE WARNING 'pg_available_extensionsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO ext_count
    FROM pg_available_extensions
    WHERE name = 'vector';

    IF ext_count > 0 THEN
        RAISE NOTICE 'pgvectoræ‰©å±•å·²å®‰è£…';
    ELSE
        RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_available_extensionsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å®‰è£…å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM pg_available_extensions WHERE name = 'vector';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ£€æŸ¥ç‰ˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    ext_version TEXT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_extension'
    ) THEN
        RAISE WARNING 'pg_extensionè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT extversion INTO ext_version
    FROM pg_extension
    WHERE extname = 'vector';

    IF ext_version IS NOT NULL THEN
        RAISE NOTICE 'pgvectorç‰ˆæœ¬: %', ext_version;
    ELSE
        RAISE WARNING 'pgvectoræ‰©å±•æœªå®‰è£…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_extensionè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç‰ˆæœ¬å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT extversion FROM pg_extension WHERE extname = 'vector';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan
```

### 2.3 å‡†å¤‡æ•°æ®è¡¨

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        DROP TABLE docs CASCADE;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: docs';
    END IF;

    CREATE TABLE docs (
        id SERIAL PRIMARY KEY,
        text TEXT NOT NULL,
        embedding vector(1536),  -- OpenAI ada-002ç»´åº¦
        created_at TIMESTAMP DEFAULT NOW(),
        category VARCHAR(100),
        metadata JSONB
    );
    RAISE NOTICE 'è¡¨docsåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨docså·²å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ–‡æ¡£è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'docs' AND indexname = 'docs_text_gin'
    ) THEN
        DROP INDEX docs_text_gin;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç´¢å¼•: docs_text_gin';
    END IF;

    CREATE INDEX docs_text_gin ON docs USING gin(to_tsvector('simple', text));
    RAISE NOTICE 'å…¨æ–‡æœç´¢ç´¢å¼•docs_text_ginåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'to_tsvectorå‡½æ•°ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å…¨æ–‡æœç´¢æ‰©å±•';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_text_ginå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºç»“æ„åŒ–å­—æ®µç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'docs' AND indexname = 'docs_created_at_idx'
    ) THEN
        DROP INDEX docs_created_at_idx;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç´¢å¼•: docs_created_at_idx';
    END IF;

    CREATE INDEX docs_created_at_idx ON docs(created_at);
    RAISE NOTICE 'ç»“æ„åŒ–å­—æ®µç´¢å¼•docs_created_at_idxåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_created_at_idxå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç»“æ„åŒ–å­—æ®µç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºåˆ†ç±»ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'docs' AND indexname = 'docs_category_idx'
    ) THEN
        DROP INDEX docs_category_idx;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç´¢å¼•: docs_category_idx';
    END IF;

    CREATE INDEX docs_category_idx ON docs(category);
    RAISE NOTICE 'åˆ†ç±»ç´¢å¼•docs_category_idxåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_category_idxå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºåˆ†ç±»ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

## 3. æ­¥éª¤

1) åˆ›å»ºç´¢å¼•ï¼š

    ```sql
    -- åˆ›å»ºHNSWç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    DO $$
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.tables
            WHERE table_schema = 'public' AND table_name = 'docs'
        ) THEN
            RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
        END IF;

        CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
        RAISE NOTICE 'HNSWç´¢å¼•docs_hnswåˆ›å»ºæˆåŠŸ';
    EXCEPTION
        WHEN undefined_table THEN
            RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
        WHEN undefined_type THEN
            RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
        WHEN duplicate_object THEN
            RAISE NOTICE 'ç´¢å¼•docs_hnswå·²å­˜åœ¨';
        WHEN OTHERS THEN
            RAISE EXCEPTION 'åˆ›å»ºHNSWç´¢å¼•å¤±è´¥: %', SQLERRM;
    END $$;
    ```

### 3.1 ç´¢å¼•ç±»å‹é€‰æ‹©

**HNSWç´¢å¼•ï¼ˆæ¨èç”¨äºé«˜ç»´å‘é‡ï¼‰**:

```sql
-- HNSWç´¢å¼•åˆ›å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'docs_hnsw'
    ) THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    CREATE INDEX docs_hnsw ON docs
    USING hnsw (embedding vector_l2_ops)
    WITH (
        m = 32,              -- æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼ˆ16-64ï¼‰
        ef_construction = 200  -- æ„å»ºæ—¶çš„å€™é€‰æ•°ï¼ˆ100-1000ï¼‰
    );
    RAISE NOTICE 'HNSWç´¢å¼•docs_hnswåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºHNSWç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥è¯¢æ—¶è®¾ç½®ef_searchï¼ˆå½±å“å¬å›ç‡å’Œæ€§èƒ½ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 100;  -- æ³¨æ„ï¼šHNSWä½¿ç”¨ef_searchå‚æ•°
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º100';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;
```

**IVFFlatç´¢å¼•ï¼ˆæ¨èç”¨äºå¤§è§„æ¨¡æ•°æ®ï¼‰**:

```sql
-- IVFFlatç´¢å¼•åˆ›å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'docs_ivfflat'
    ) THEN
        RAISE WARNING 'ç´¢å¼•docs_ivfflatå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    CREATE INDEX docs_ivfflat ON docs
    USING ivfflat (embedding vector_l2_ops)
    WITH (
        lists = 100  -- èšç±»ä¸­å¿ƒæ•°ï¼ˆå»ºè®®ï¼šrows/1000ï¼‰
    );
    RAISE NOTICE 'IVFFlatç´¢å¼•docs_ivfflatåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_ivfflatå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºIVFFlatç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥è¯¢æ—¶è®¾ç½®probesï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 10;  -- æœç´¢çš„èšç±»æ•°ï¼ˆ1-listsï¼‰
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º10';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;
```

**ç´¢å¼•é€‰æ‹©å»ºè®®**:

| åœºæ™¯ | æ¨èç´¢å¼• | åŸå›  |
|------|---------|------|
| é«˜ç»´å‘é‡(>100ç»´) | HNSW | æ›´å¥½çš„å¬å›ç‡ |
| å¤§è§„æ¨¡æ•°æ®(>100ä¸‡) | IVFFlat | æ›´å¿«çš„æ„å»ºé€Ÿåº¦ |
| å®æ—¶æŸ¥è¯¢ | HNSW | æ›´ä½çš„å»¶è¿Ÿ |
| æ‰¹é‡æŸ¥è¯¢ | IVFFlat | æ›´å¥½çš„ååé‡ |

### 3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰

```sql
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- æ–¹æ³•1: å…ˆè¿‡æ»¤åæ’åºï¼ˆæ¨èï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM docs
    WHERE created_at >= now() - interval '7 day'
      AND category = 'technology'
    ORDER BY embedding <-> $1
    LIMIT 50;

    RAISE NOTICE 'æ–¹æ³•1æŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ° % æ¡è®°å½•', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ–¹æ³•1æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, text, embedding <-> $1 AS distance
FROM docs
WHERE created_at >= now() - interval '7 day'
  AND category = 'technology'
ORDER BY embedding <-> $1
LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <80msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Index Scan

-- æ–¹æ³•2: ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    WITH filtered AS (
        SELECT id, text, embedding
        FROM docs
        WHERE created_at >= now() - interval '7 day'
          AND category = 'technology'
    )
    SELECT COUNT(*) INTO result_count
    FROM filtered
    ORDER BY embedding <-> $1
    LIMIT 50;

    RAISE NOTICE 'æ–¹æ³•2æŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ° % æ¡è®°å½•', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ–¹æ³•2æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH filtered AS (
    SELECT id, text, embedding
    FROM docs
    WHERE created_at >= now() - interval '7 day'
      AND category = 'technology'
)
SELECT id, text, embedding <-> $1 AS distance
FROM filtered
ORDER BY embedding <-> $1
LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <80msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Index Scan -> CTE Scan
```

### 3.3 å…¨æ–‡ + å‘é‡èåˆ

```sql
-- å…¨æ–‡ + å‘é‡èåˆæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    WITH s AS (
        SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
        FROM docs
        WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
        ORDER BY tr DESC LIMIT 500
    ), v AS (
        SELECT id, embedding <-> $1 AS dist
        FROM docs
        WHERE id IN (SELECT id FROM s)
        ORDER BY dist ASC LIMIT 100
    )
    SELECT COUNT(*) INTO result_count
    FROM v d JOIN s ON d.id = s.id;

    RAISE NOTICE 'å…¨æ–‡+å‘é‡èåˆæŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ° % æ¡è®°å½•', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->æˆ–å…¨æ–‡æœç´¢å‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å…¨æ–‡+å‘é‡èåˆæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
    ORDER BY tr DESC LIMIT 500
), v AS (
    SELECT id, embedding <-> $1 AS dist
    FROM docs
    WHERE id IN (SELECT id FROM s)
    ORDER BY dist ASC LIMIT 100
)
SELECT d.id, d.text, 0.6*(1.0/v.dist) + 0.4*s.tr AS score
FROM v d JOIN s ON d.id = s.id
ORDER BY score DESC LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Hash Join -> CTE Scan
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- ä½¿ç”¨åŠ æƒèåˆï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    result_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    WITH text_results AS (
        SELECT
            id,
            text,
            ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', $2)) AS text_score
        FROM docs
        WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', $2)
        ORDER BY text_score DESC
        LIMIT 500
    ),
    vector_results AS (
        SELECT
            id,
            embedding <-> $1 AS vector_distance
        FROM docs
        WHERE id IN (SELECT id FROM text_results)
        ORDER BY embedding <-> $1
        LIMIT 100
    )
    SELECT COUNT(*) INTO result_count
    FROM vector_results v
    JOIN text_results t ON v.id = t.id;

    RAISE NOTICE 'ä¼˜åŒ–ç‰ˆæœ¬å…¨æ–‡+å‘é‡èåˆæŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ° % æ¡è®°å½•', result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->æˆ–å…¨æ–‡æœç´¢å‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ä¼˜åŒ–ç‰ˆæœ¬å…¨æ–‡+å‘é‡èåˆæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH text_results AS (
    SELECT
        id,
        text,
        ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', $2)) AS text_score
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', $2)
    ORDER BY text_score DESC
    LIMIT 500
),
vector_results AS (
    SELECT
        id,
        embedding <-> $1 AS vector_distance
    FROM docs
    WHERE id IN (SELECT id FROM text_results)
    ORDER BY embedding <-> $1
    LIMIT 100
)
SELECT
    d.id,
    d.text,
    -- å½’ä¸€åŒ–åˆ†æ•°å¹¶åŠ æƒèåˆ
    0.6 * (1.0 / (1.0 + v.vector_distance)) + 0.4 * t.text_score AS combined_score
FROM vector_results v
JOIN text_results t ON v.id = t.id
JOIN docs d ON v.id = d.id
ORDER BY combined_score DESC
LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Hash Join -> CTE Scan
```

## 4. è¿è¡Œå‚æ•°

- `SET ivfflat.probes = 10;` æŸ¥è¯¢é«˜å¬å›æ—¶è°ƒå¤§ï¼›
- æ§åˆ¶ `work_mem`ï¼Œé¿å…ANNä¸æ’åºå†…å­˜çˆ†ï¼›
- ç›‘æ§å»¶è¿ŸTP95/TP99 ä¸å¬å›æŒ‡æ ‡ã€‚

### 4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜

```sql
-- 1. è°ƒæ•´work_memï¼ˆå‘é‡æŸ¥è¯¢éœ€è¦æ›´å¤šå†…å­˜ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET work_mem = '256MB';
    RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º256MB';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'work_memå€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®work_memå¤±è´¥: %', SQLERRM;
END $$;

-- 2. è°ƒæ•´IVFFlat probesï¼ˆå¬å›ç‡ vs æ€§èƒ½æƒè¡¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 10;   -- é»˜è®¤å€¼ï¼Œå¿«é€Ÿä½†å¬å›ç‡è¾ƒä½
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º10ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;

-- å¹³è¡¡æ¨¡å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 50;   -- å¹³è¡¡æ¨¡å¼
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º50ï¼ˆå¹³è¡¡æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;

-- é«˜å¬å›ç‡æ¨¡å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 100;  -- é«˜å¬å›ç‡ï¼Œä½†è¾ƒæ…¢
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º100ï¼ˆé«˜å¬å›ç‡æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;

-- 3. è°ƒæ•´HNSW ef_searchï¼ˆä»…HNSWç´¢å¼•ï¼‰
-- æ³¨æ„ï¼špgvectorçš„HNSWå®ç°å¯èƒ½ä½¿ç”¨ä¸åŒå‚æ•°å
-- æŸ¥è¯¢æ—¶åœ¨ORDER BYå­å¥ä¸­æŒ‡å®šLIMITä¼šå½±å“æœç´¢èŒƒå›´

-- 4. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET max_parallel_workers_per_gather = 4;
    RAISE NOTICE 'max_parallel_workers_per_gatherå·²è®¾ç½®ä¸º4';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'max_parallel_workers_per_gatherå€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®max_parallel_workers_per_gatherå¤±è´¥: %', SQLERRM;
END $$;
```

### 4.2 æ€§èƒ½ç›‘æ§

```sql
-- 1. æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;
    RAISE NOTICE 'æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†æå®Œæˆ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†æå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Index Scan (å¦‚æœä½¿ç”¨äº†å‘é‡ç´¢å¼•)

-- 2. ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO index_count
    FROM pg_stat_user_indexes
    WHERE tablename = 'docs'
    AND indexname LIKE '%vector%';

    IF index_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå‘é‡ç›¸å…³ç´¢å¼•', index_count;
    ELSE
        RAISE WARNING 'æœªå‘ç°å‘é‡ç´¢å¼•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'docs'
AND indexname LIKE '%vector%';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 3. è¡¨å¤§å°å’Œç´¢å¼•å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_size BIGINT;
    index_size BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_relation_size') THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE WARNING 'è¡¨docsä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT pg_relation_size('docs') INTO table_size;
    SELECT COALESCE(pg_relation_size('docs_hnsw'), 0) INTO index_size;

    RAISE NOTICE 'è¡¨docså¤§å°: % bytes, ç´¢å¼•docs_hnswå¤§å°: % bytes', table_size, index_size;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨docsæˆ–ç´¢å¼•docs_hnswä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è¡¨å¤§å°å’Œç´¢å¼•å¤§å°å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(pg_relation_size('docs')) AS table_size,
    pg_size_pretty(pg_relation_size('docs_hnsw')) AS index_size;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Result
```

### 4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åˆ›å»ºæµ‹è¯•å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION benchmark_vector_search(
    query_vector vector(1536),
    limit_count INTEGER DEFAULT 50
)
RETURNS TABLE (
    execution_time_ms NUMERIC,
    result_count BIGINT
) AS $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    result_count BIGINT;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    start_time := clock_timestamp();

    SELECT COUNT(*) INTO result_count
    FROM (
        SELECT id
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT limit_count
    ) sub;

    end_time := clock_timestamp();

    RETURN QUERY SELECT
        EXTRACT(EPOCH FROM (end_time - start_time)) * 1000 AS execution_time_ms,
        result_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åŸºå‡†æµ‹è¯•å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    test_result RECORD;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'benchmark_vector_search'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE EXCEPTION 'å‡½æ•°benchmark_vector_searchä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒåŸºå‡†æµ‹è¯•';
    END IF;

    SELECT * INTO test_result
    FROM benchmark_vector_search(
        (SELECT embedding FROM docs LIMIT 1),
        50
    );

    RAISE NOTICE 'åŸºå‡†æµ‹è¯•å®Œæˆï¼Œæ‰§è¡Œæ—¶é—´: % ms, ç»“æœæ•°: %', test_result.execution_time_ms, test_result.result_count;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‡½æ•°benchmark_vector_searchä¸å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰§è¡ŒåŸºå‡†æµ‹è¯•å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM benchmark_vector_search(
    (SELECT embedding FROM docs LIMIT 1),
    50
);
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Function Scan
```

## 5. éªŒè¯

- ä¸æš´åŠ›çœŸå€¼å¯¹æ¯” Recall@kï¼›æ€§èƒ½åŸºçº¿è®°å½•ä¸å›å½’æ£€æŸ¥ã€‚

### 5.1 å¬å›ç‡éªŒè¯

```sql
-- åˆ›å»ºå¬å›ç‡éªŒè¯å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION verify_recall_at_k(
    query_vector vector(1536),
    k INTEGER DEFAULT 50,
    ground_truth_limit INTEGER DEFAULT 1000
)
RETURNS TABLE (
    recall_at_k NUMERIC,
    precision_at_k NUMERIC
) AS $$
DECLARE
    approximate_results INTEGER[];
    ground_truth_results INTEGER[];
    intersection_count INTEGER;
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    -- è¿‘ä¼¼æœç´¢ç»“æœ
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO approximate_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT k
    ) sub;

    -- çœŸå®ç»“æœï¼ˆæš´åŠ›æœç´¢ï¼‰
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO ground_truth_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT ground_truth_limit
    ) sub;

    -- è®¡ç®—äº¤é›†
    SELECT COUNT(*) INTO intersection_count
    FROM unnest(approximate_results) AS a(id)
    WHERE id = ANY(ground_truth_results[1:k]);

    RETURN QUERY SELECT
        intersection_count::NUMERIC / NULLIF(k, 0) AS recall_at_k,
        intersection_count::NUMERIC / NULLIF(k, 0) AS precision_at_k;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->æˆ–ARRAY_AGGå‡½æ•°ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE EXCEPTION 'kå€¼ä¸èƒ½ä¸º0';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¬å›ç‡éªŒè¯å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒéªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    verify_result RECORD;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'verify_recall_at_k'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE EXCEPTION 'å‡½æ•°verify_recall_at_kä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯';
    END IF;

    SELECT * INTO verify_result
    FROM verify_recall_at_k(
        (SELECT embedding FROM docs LIMIT 1),
        50,
        1000
    );

    RAISE NOTICE 'å¬å›ç‡éªŒè¯å®Œæˆï¼ŒRecall@K: %, Precision@K: %', verify_result.recall_at_k, verify_result.precision_at_k;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‡½æ•°verify_recall_at_kä¸å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰§è¡ŒéªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM verify_recall_at_k(
    (SELECT embedding FROM docs LIMIT 1),
    50,
    1000
);
-- æ‰§è¡Œæ—¶é—´: <500msï¼ˆå–å†³äºæ•°æ®é‡å’Œkå€¼ï¼‰
-- è®¡åˆ’: Function Scan
```

### 5.2 æ€§èƒ½åŸºçº¿è®°å½•

```sql
-- åˆ›å»ºæ€§èƒ½åŸºçº¿è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_performance_baseline'
    ) THEN
        CREATE TABLE vector_search_performance_baseline (
            test_id SERIAL PRIMARY KEY,
            test_time TIMESTAMP DEFAULT NOW(),
            query_type VARCHAR(50),  -- 'vector_only', 'hybrid', 'fulltext'
            index_type VARCHAR(50),   -- 'hnsw', 'ivfflat', 'none'
            k_value INTEGER,
            execution_time_ms NUMERIC,
            recall_at_k NUMERIC,
            result_count BIGINT,
            notes TEXT
        );
        RAISE NOTICE 'æ€§èƒ½åŸºçº¿è¡¨vector_search_performance_baselineåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'æ€§èƒ½åŸºçº¿è¡¨vector_search_performance_baselineå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'æ€§èƒ½åŸºçº¿è¡¨vector_search_performance_baselineå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ€§èƒ½åŸºçº¿è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•æ€§èƒ½åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    inserted_id INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    INSERT INTO vector_search_performance_baseline (
        query_type,
        index_type,
        k_value,
        execution_time_ms,
        recall_at_k
    )
    VALUES (
        'vector_only',
        'hnsw',
        50,
        25.5,
        0.95
    )
    RETURNING test_id INTO inserted_id;

    RAISE NOTICE 'æ€§èƒ½åŸºçº¿è®°å½•æˆåŠŸï¼Œtest_id: %', inserted_id;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨';
    WHEN check_violation THEN
        RAISE WARNING 'æ€§èƒ½åŸºçº¿è®°å½•è¿åçº¦æŸæ¡ä»¶';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•æ€§èƒ½åŸºçº¿å¤±è´¥: %', SQLERRM;
END $$;
```

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: ç´¢å¼•æ„å»ºæ…¢**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ„å»ºè¿›åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_build_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO index_build_count
    FROM pg_stat_activity
    WHERE query LIKE '%CREATE INDEX%';

    IF index_build_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç´¢å¼•æ„å»ºè¿›ç¨‹', index_build_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç´¢å¼•æ„å»ºè¿›ç¨‹';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•æ„å»ºè¿›åº¦å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- è§£å†³æ–¹æ¡ˆï¼šåˆ†æ‰¹æ„å»ºæˆ–ä½¿ç”¨CONCURRENTLYï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'docs_hnsw'
    ) THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    CREATE INDEX CONCURRENTLY docs_hnsw ON docs USING hnsw (embedding vector_l2_ops);
    RAISE NOTICE 'HNSWç´¢å¼•docs_hnswåˆ›å»ºæˆåŠŸï¼ˆå¹¶å‘æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºHNSWç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

**é—®é¢˜2: æŸ¥è¯¢æ€§èƒ½å·®**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;
    RAISE NOTICE 'æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µå®Œæˆ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‘é‡è·ç¦»è¿ç®—ç¬¦<->ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT id, text
FROM docs
ORDER BY embedding <-> $1
LIMIT 50;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºæ•°æ®é‡å’Œç´¢å¼•ï¼‰
-- è®¡åˆ’: Limit -> Index Scan (å¦‚æœä½¿ç”¨äº†å‘é‡ç´¢å¼•) æˆ– Seq Scan (å¦‚æœæ²¡æœ‰ä½¿ç”¨ç´¢å¼•)

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. å¢åŠ ivfflat.probes
-- 2. æ£€æŸ¥work_memè®¾ç½®
-- 3. è€ƒè™‘é‡å»ºç´¢å¼•
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**:

```sql
-- æ£€æŸ¥å½“å‰work_mem
SHOW work_mem;

-- è§£å†³æ–¹æ¡ˆï¼šå¢åŠ work_memæˆ–å‡å°‘æŸ¥è¯¢èŒƒå›´
SET work_mem = '512MB';
```

## 7. ç”Ÿäº§è¿ç»´å®è·µ

### 7.1 ç›‘æ§æŒ‡æ ‡

#### 7.1.1 æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰

**æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡**:

- `p50_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿä¸­ä½æ•°
- `p95_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿ95åˆ†ä½
- `p99_latency_ms`: æŸ¥è¯¢å»¶è¿Ÿ99åˆ†ä½
- `query_qps`: æ¯ç§’æŸ¥è¯¢æ•°
- `error_rate`: é”™è¯¯ç‡

**å¬å›ç‡æŒ‡æ ‡**:

- `recall_at_k`: Top-Kå¬å›ç‡
- `precision_at_k`: Top-Kç²¾ç¡®ç‡
- `mrr_score`: å¹³å‡å€’æ•°æ’å

**èµ„æºæŒ‡æ ‡**:

- `index_size_gb`: ç´¢å¼•å¤§å°
- `memory_usage_percent`: å†…å­˜ä½¿ç”¨ç‡
- `cpu_usage_percent`: CPUä½¿ç”¨ç‡
- `disk_io_read_mb_s`: ç£ç›˜è¯»IO
- `disk_io_write_mb_s`: ç£ç›˜å†™IO

#### 7.1.2 ç›‘æ§æŸ¥è¯¢

```sql
-- åˆ›å»ºç›‘æ§è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    CREATE OR REPLACE VIEW vector_search_metrics AS
    SELECT
        NOW() AS timestamp,
        'vector_search' AS metric_type,
        COUNT(*) AS total_queries,
        PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY execution_time_ms) AS p50_latency_ms,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) AS p95_latency_ms,
        PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY execution_time_ms) AS p99_latency_ms,
        AVG(execution_time_ms) AS avg_latency_ms,
        AVG(recall_at_k) AS avg_recall_at_k
    FROM vector_search_performance_baseline
    WHERE test_time >= NOW() - INTERVAL '1 hour';

    RAISE NOTICE 'ç›‘æ§è§†å›¾vector_search_metricsåˆ›å»º/æ›´æ–°æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç›‘æ§è§†å›¾å¤±è´¥: %', SQLERRM;
END $$;

-- æŸ¥è¯¢å½“å‰æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    metric_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND view_name = 'vector_search_metrics'
    ) THEN
        RAISE WARNING 'è§†å›¾vector_search_metricsä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO metric_count
    FROM vector_search_metrics;

    IF metric_count > 0 THEN
        RAISE NOTICE 'æŸ¥è¯¢åˆ° % æ¡æŒ‡æ ‡è®°å½•', metric_count;
    ELSE
        RAISE NOTICE 'æœªæŸ¥è¯¢åˆ°æŒ‡æ ‡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è§†å›¾vector_search_metricsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢å½“å‰æŒ‡æ ‡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM vector_search_metrics;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Subquery Scan
```

#### 7.1.3 PrometheusæŒ‡æ ‡å¯¼å‡º

```sql
-- åˆ›å»ºæ‰©å±•è¡¨ç”¨äºPrometheusæŠ“å–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_metrics_export'
    ) THEN
        CREATE TABLE vector_search_metrics_export (
            timestamp TIMESTAMP DEFAULT NOW(),
            metric_name TEXT,
            metric_value NUMERIC,
            labels JSONB
        );
        RAISE NOTICE 'æ‰©å±•è¡¨vector_search_metrics_exportåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'æ‰©å±•è¡¨vector_search_metrics_exportå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'æ‰©å±•è¡¨vector_search_metrics_exportå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ‰©å±•è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- å®šæœŸæ›´æ–°æŒ‡æ ‡ï¼ˆé€šè¿‡å®šæ—¶ä»»åŠ¡ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION update_vector_metrics()
RETURNS void AS $$
DECLARE
    inserted_count INT;
BEGIN
    -- æ£€æŸ¥ç›¸å…³è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_metrics_export'
    ) THEN
        RAISE EXCEPTION 'è¡¨vector_search_metrics_exportä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    -- æ’å…¥æŸ¥è¯¢å»¶è¿ŸæŒ‡æ ‡
    INSERT INTO vector_search_metrics_export (metric_name, metric_value, labels)
    SELECT
        'vector_search_p95_latency_ms',
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms),
        jsonb_build_object('index_type', index_type, 'query_type', query_type)
    FROM vector_search_performance_baseline
    WHERE test_time >= NOW() - INTERVAL '5 minutes'
    GROUP BY index_type, query_type;

    GET DIAGNOSTICS inserted_count = ROW_COUNT;
    RAISE NOTICE 'æˆåŠŸæ’å…¥ % æ¡æŒ‡æ ‡è®°å½•', inserted_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°æŒ‡æ ‡å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 å‘Šè­¦è§„åˆ™

#### 7.2.1 å‘Šè­¦è§„åˆ™å®šä¹‰

**P0çº§å‘Šè­¦ï¼ˆä¸¥é‡ï¼‰**:

- æŸ¥è¯¢å»¶è¿Ÿ P95 > 100ms æŒç»­5åˆ†é’Ÿ
- é”™è¯¯ç‡ > 1% æŒç»­5åˆ†é’Ÿ
- å¬å›ç‡ < 90% æŒç»­10åˆ†é’Ÿ
- ç´¢å¼•æŸåæ£€æµ‹

**P1çº§å‘Šè­¦ï¼ˆè­¦å‘Šï¼‰**:

- æŸ¥è¯¢å»¶è¿Ÿ P95 > 50ms æŒç»­10åˆ†é’Ÿ
- å†…å­˜ä½¿ç”¨ç‡ > 80% æŒç»­5åˆ†é’Ÿ
- CPUä½¿ç”¨ç‡ > 85% æŒç»­10åˆ†é’Ÿ
- ç´¢å¼•å¤§å°å¢é•¿å¼‚å¸¸

#### 7.2.2 Prometheuså‘Šè­¦é…ç½®

```yaml
# prometheus-alerts.yml
groups:
  - name: vector_search_alerts
    interval: 30s
    rules:
      # P0: æŸ¥è¯¢å»¶è¿Ÿå‘Šè­¦
      - alert: VectorSearchHighLatency
        expr: vector_search_p95_latency_ms > 100
        for: 5m
        labels:
          severity: critical
          component: vector_search
        annotations:
          summary: "å‘é‡æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜"
          description: "P95å»¶è¿Ÿ {{ $value }}ms è¶…è¿‡é˜ˆå€¼ 100ms"

      # P0: é”™è¯¯ç‡å‘Šè­¦
      - alert: VectorSearchHighErrorRate
        expr: rate(vector_search_errors_total[5m]) / rate(vector_search_queries_total[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "å‘é‡æŸ¥è¯¢é”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡é˜ˆå€¼ 1%"

      # P1: å¬å›ç‡å‘Šè­¦
      - alert: VectorSearchLowRecall
        expr: vector_search_recall_at_k < 0.90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "å‘é‡æŸ¥è¯¢å¬å›ç‡åä½"
          description: "å¬å›ç‡ {{ $value }} ä½äºé˜ˆå€¼ 90%"

      # P1: å†…å­˜ä½¿ç”¨å‘Šè­¦
      - alert: VectorSearchHighMemory
        expr: vector_search_memory_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å‘é‡æœç´¢å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡ {{ $value }}% è¶…è¿‡é˜ˆå€¼ 80%"
```

### 7.3 æ€§èƒ½ç›‘æ§

#### 7.3.1 å®æ—¶æ€§èƒ½ç›‘æ§

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION monitor_vector_search_performance(
    time_window INTERVAL DEFAULT '1 hour'
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC,
    threshold_value NUMERIC,
    status TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'vector_search_performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    RETURN QUERY
    SELECT
        'p95_latency_ms'::TEXT,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms),
        50.0,
        CASE
            WHEN PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) > 50 THEN 'ALERT'
            ELSE 'OK'
        END
    FROM vector_search_performance_baseline
    WHERE test_time >= NOW() - time_window
    GROUP BY 1;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨vector_search_performance_baselineä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½ç›‘æ§å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    metric_count INT;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'monitor_vector_search_performance'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE EXCEPTION 'å‡½æ•°monitor_vector_search_performanceä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO metric_count
    FROM monitor_vector_search_performance('1 hour');

    IF metric_count > 0 THEN
        RAISE NOTICE 'æ€§èƒ½ç›‘æ§å®Œæˆï¼Œå‘ç° % æ¡æŒ‡æ ‡', metric_count;
    ELSE
        RAISE NOTICE 'æ€§èƒ½ç›‘æ§å®Œæˆï¼Œæœªå‘ç°æŒ‡æ ‡æ•°æ®';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‡½æ•°monitor_vector_search_performanceä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰§è¡Œç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM monitor_vector_search_performance('1 hour');
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Function Scan
```

#### 7.3.2 Grafanaä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "Vector Search Performance",
    "panels": [
      {
        "title": "Query Latency (P50/P95/P99)",
        "targets": [
          {
            "expr": "vector_search_p50_latency_ms",
            "legendFormat": "P50"
          },
          {
            "expr": "vector_search_p95_latency_ms",
            "legendFormat": "P95"
          },
          {
            "expr": "vector_search_p99_latency_ms",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "Query QPS",
        "targets": [
          {
            "expr": "rate(vector_search_queries_total[5m])",
            "legendFormat": "QPS"
          }
        ]
      },
      {
        "title": "Recall at K",
        "targets": [
          {
            "expr": "vector_search_recall_at_k",
            "legendFormat": "Recall@K"
          }
        ]
      }
    ]
  }
}
```

### 7.4 ç´¢å¼•å¥åº·åº¦ç›‘æ§

#### 7.4.1 ç´¢å¼•å¥åº·åº¦æ£€æŸ¥

```sql
-- ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å‡½æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION check_vector_index_health()
RETURNS TABLE (
    index_name TEXT,
    table_name TEXT,
    index_size_gb NUMERIC,
    bloat_ratio NUMERIC,
    index_scan_count BIGINT,
    index_usage_ratio NUMERIC,
    health_status TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥å¿…è¦çš„è§†å›¾æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_indexes'
    ) THEN
        RAISE EXCEPTION 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE EXCEPTION 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE EXCEPTION 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_relation_size') THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    RETURN QUERY
    SELECT
        i.indexname::TEXT,
        i.tablename::TEXT,
        pg_size_pretty(pg_relation_size(i.indexrelid))::NUMERIC / (1024*1024*1024) AS index_size_gb,
        -- ç®€åŒ–çš„è†¨èƒ€ç‡è®¡ç®—
        CASE
            WHEN pg_stat_user_indexes.idx_scan > 0 THEN
                (pg_relation_size(i.indexrelid) - pg_relation_size(i.indexrelid))::NUMERIC / NULLIF(pg_relation_size(i.indexrelid), 0)
            ELSE 0
        END AS bloat_ratio,
        pg_stat_user_indexes.idx_scan AS index_scan_count,
        CASE
            WHEN pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan > 0 THEN
                pg_stat_user_indexes.idx_scan::NUMERIC /
                NULLIF(pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan, 0)
            ELSE 0
        END AS index_usage_ratio,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'UNUSED'
            WHEN (pg_stat_user_indexes.idx_scan::NUMERIC /
                  NULLIF(pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan, 0)) < 0.5 THEN 'UNDERUSED'
            ELSE 'HEALTHY'
        END AS health_status
    FROM pg_indexes i
    JOIN pg_stat_user_indexes ON i.indexname = pg_stat_user_indexes.indexname
    JOIN pg_stat_user_tables ON i.tablename = pg_stat_user_tables.relname
    WHERE i.indexname LIKE '%vector%' OR i.indexname LIKE '%hnsw%' OR i.indexname LIKE '%ivfflat%';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'å¿…è¦çš„ç³»ç»Ÿè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å‡½æ•°æ‰§è¡Œå¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ£€æŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    health_count INT;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'check_vector_index_health'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE EXCEPTION 'å‡½æ•°check_vector_index_healthä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO health_count
    FROM check_vector_index_health();

    RAISE NOTICE 'å‘é‡ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å®Œæˆï¼Œå‘ç° % æ¡è®°å½•', health_count;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å‡½æ•°check_vector_index_healthä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰§è¡Œå‘é‡ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM check_vector_index_health();
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºç´¢å¼•æ•°é‡ï¼‰
-- è®¡åˆ’: Function Scan
```

#### 7.4.2 ç´¢å¼•é‡å»ºå»ºè®®

```sql
-- ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
CREATE OR REPLACE FUNCTION get_index_rebuild_recommendations()
RETURNS TABLE (
    index_name TEXT,
    recommendation TEXT,
    priority TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥å¿…è¦çš„è§†å›¾æ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_indexes'
    ) THEN
        RAISE EXCEPTION 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE EXCEPTION 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE EXCEPTION 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_relation_size') THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    RETURN QUERY
    SELECT
        i.indexname::TEXT,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'ç´¢å¼•æœªè¢«ä½¿ç”¨ï¼Œè€ƒè™‘åˆ é™¤'
            WHEN pg_relation_size(i.indexrelid) > pg_relation_size(i.tablename)::regclass * 2 THEN 'ç´¢å¼•å¤§å°å¼‚å¸¸ï¼Œè€ƒè™‘é‡å»º'
            WHEN (pg_stat_user_indexes.idx_scan::NUMERIC /
                  NULLIF(pg_stat_user_tables.seq_scan + pg_stat_user_indexes.idx_scan, 0)) < 0.3 THEN 'ç´¢å¼•ä½¿ç”¨ç‡ä½ï¼Œè€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢'
            ELSE 'ç´¢å¼•å¥åº·'
        END AS recommendation,
        CASE
            WHEN pg_stat_user_indexes.idx_scan = 0 THEN 'LOW'
            WHEN pg_relation_size(i.indexrelid) > pg_relation_size(i.tablename)::regclass * 2 THEN 'HIGH'
            ELSE 'MEDIUM'
        END AS priority
    FROM pg_indexes i
    JOIN pg_stat_user_indexes ON i.indexname = pg_stat_user_indexes.indexname
    JOIN pg_stat_user_tables ON i.tablename = pg_stat_user_tables.relname
    WHERE i.indexname LIKE '%vector%';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'å¿…è¦çš„ç³»ç»Ÿè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç”Ÿæˆç´¢å¼•é‡å»ºå»ºè®®å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 7.5 æ•…éšœå¤„ç†æµç¨‹

#### 7.5.1 æ•…éšœåˆ†ç±»

**P0æ•…éšœï¼ˆä¸¥é‡ï¼‰**:

- æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- æ•°æ®æŸå
- ç´¢å¼•æŸå

**P1æ•…éšœï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**:

- æŸ¥è¯¢æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼ˆP95 > 100msï¼‰
- å¬å›ç‡æ˜¾è‘—ä¸‹é™ï¼ˆ< 85%ï¼‰
- èµ„æºè€—å°½ï¼ˆå†…å­˜/CPUï¼‰

**P2æ•…éšœï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**:

- æŸ¥è¯¢æ€§èƒ½è½»å¾®ä¸‹é™ï¼ˆP95 > 50msï¼‰
- èµ„æºä½¿ç”¨ç‡åé«˜

#### 7.5.2 æ•…éšœå¤„ç†æ­¥éª¤

**æ­¥éª¤1: é—®é¢˜å®šä½**:

```sql
-- æ£€æŸ¥å½“å‰æŸ¥è¯¢çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_query_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO active_query_count
    FROM pg_stat_activity
    WHERE query LIKE '%vector%' OR query LIKE '%embedding%';

    IF active_query_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå‘é‡ç›¸å…³æŸ¥è¯¢', active_query_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å‘é‡ç›¸å…³æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å½“å‰æŸ¥è¯¢çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE query LIKE '%vector%' OR query LIKE '%embedding%'
ORDER BY query_start;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Sort -> Seq Scan

-- æ£€æŸ¥ç´¢å¼•çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    health_count INT;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'check_vector_index_health'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE WARNING 'å‡½æ•°check_vector_index_healthä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO health_count
    FROM check_vector_index_health();

    RAISE NOTICE 'å‘é‡ç´¢å¼•å¥åº·åº¦æ£€æŸ¥å®Œæˆï¼Œå‘ç° % æ¡è®°å½•', health_count;
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'å‡½æ•°check_vector_index_healthä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

-- æ£€æŸ¥èµ„æºä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_size BIGINT;
    total_index_size BIGINT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_database_size') THEN
        RAISE EXCEPTION 'pg_database_sizeå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT pg_database_size(current_database()) INTO db_size;
    SELECT COALESCE(sum(pg_relation_size(indexrelid)), 0) INTO total_index_size
    FROM pg_stat_user_indexes
    WHERE indexrelname LIKE '%vector%';

    RAISE NOTICE 'æ•°æ®åº“å¤§å°: % bytes, å‘é‡ç´¢å¼•æ€»å¤§å°: % bytes', db_size, total_index_size;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_database_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥èµ„æºä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(pg_database_size(current_database())) AS db_size,
    pg_size_pretty(sum(pg_relation_size(indexrelid))) AS total_index_size
FROM pg_stat_user_indexes
WHERE indexrelname LIKE '%vector%';
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Aggregate -> Seq Scan
```

**æ­¥éª¤2: å¿«é€Ÿæ¢å¤**:

```sql
-- æ–¹æ¡ˆ1: å¢åŠ work_memï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET work_mem = '1GB';
    RAISE NOTICE 'work_memå·²è®¾ç½®ä¸º1GB';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'work_memå€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®work_memå¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ¡ˆ2: é™ä½æŸ¥è¯¢ç²¾åº¦ï¼ˆä¸´æ—¶ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET ivfflat.probes = 5;  -- é™ä½probesä»¥æå‡é€Ÿåº¦
    RAISE NOTICE 'ivfflat.probeså·²è®¾ç½®ä¸º5';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE WARNING 'ivfflat.probeså€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®ivfflat.probeså¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ¡ˆ3: ç»ˆæ­¢æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    terminated_count INT := 0;
    pid_val INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_terminate_backend') THEN
        RAISE EXCEPTION 'pg_terminate_backendå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    FOR pid_val IN
        SELECT pid
        FROM pg_stat_activity
        WHERE query LIKE '%vector%'
          AND state = 'active'
          AND query_start < NOW() - INTERVAL '30 seconds'
    LOOP
        PERFORM pg_terminate_backend(pid_val);
        terminated_count := terminated_count + 1;
    END LOOP;

    IF terminated_count > 0 THEN
        RAISE NOTICE 'å·²ç»ˆæ­¢ % ä¸ªæ…¢æŸ¥è¯¢', terminated_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°éœ€è¦ç»ˆæ­¢çš„æ…¢æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_terminate_backendå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•ç»ˆæ­¢åç«¯è¿›ç¨‹';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç»ˆæ­¢æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;
```

**æ­¥éª¤3: æ ¹æœ¬è§£å†³**:

```sql
-- é‡å»ºç´¢å¼•ï¼ˆéœ€è¦ç»´æŠ¤çª—å£ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE indexname = 'docs_hnsw'
    ) THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswä¸å­˜åœ¨ï¼Œè·³è¿‡é‡å»º';
        RETURN;
    END IF;

    REINDEX INDEX CONCURRENTLY docs_hnsw;
    RAISE NOTICE 'ç´¢å¼•docs_hnswé‡å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é‡å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æˆ–åˆ é™¤é‡å»ºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE indexname = 'docs_hnsw'
    ) THEN
        DROP INDEX CONCURRENTLY docs_hnsw;
        RAISE NOTICE 'ç´¢å¼•docs_hnswåˆ é™¤æˆåŠŸ';
    ELSE
        RAISE NOTICE 'ç´¢å¼•docs_hnswä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    END IF;

    CREATE INDEX CONCURRENTLY docs_hnsw ON docs
    USING hnsw (embedding vector_cosine_ops)
    WITH (m=16, ef_construction=64);
    RAISE NOTICE 'ç´¢å¼•docs_hnswåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨docsä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºç´¢å¼•';
    WHEN undefined_type THEN
        RAISE EXCEPTION 'vectorç±»å‹ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pgvectoræ‰©å±•';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•docs_hnswå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'docs'
    ) THEN
        RAISE WARNING 'è¡¨docsä¸å­˜åœ¨ï¼Œè·³è¿‡ç»Ÿè®¡ä¿¡æ¯æ›´æ–°';
        RETURN;
    END IF;

    ANALYZE docs;
    RAISE NOTICE 'è¡¨docsçš„ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨docsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;
```

#### 7.5.3 æ•…éšœå¤„ç†æ¸…å•

**P0æ•…éšœå¤„ç†æ¸…å•**:

- [ ] ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
- [ ] æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé”™è¯¯æ—¥å¿—
- [ ] æ‰§è¡Œå¿«é€Ÿæ¢å¤æ“ä½œ
- [ ] éªŒè¯æœåŠ¡æ¢å¤
- [ ] è®°å½•æ•…éšœæ ¹å› 
- [ ] åˆ¶å®šé¢„é˜²æªæ–½

**P1æ•…éšœå¤„ç†æ¸…å•**:

- [ ] æ”¶é›†æ€§èƒ½æŒ‡æ ‡
- [ ] åˆ†ææ€§èƒ½ä¸‹é™åŸå› 
- [ ] æ‰§è¡Œä¼˜åŒ–æ“ä½œ
- [ ] éªŒè¯æ€§èƒ½æ”¹å–„
- [ ] è®°å½•ä¼˜åŒ–æªæ–½

## 8. æœ€ä½³å®è·µ

1. **ç´¢å¼•é€‰æ‹©**: é«˜ç»´å‘é‡ç”¨HNSWï¼Œå¤§è§„æ¨¡æ•°æ®ç”¨IVFFlat
2. **å‚æ•°è°ƒä¼˜**: æ ¹æ®å¬å›ç‡å’Œæ€§èƒ½éœ€æ±‚å¹³è¡¡probes/ef_search
3. **æ··åˆæŸ¥è¯¢**: å…ˆç»“æ„åŒ–è¿‡æ»¤ï¼Œå†å‘é‡æœç´¢ï¼Œæœ€åèåˆæ’åº
4. **ç›‘æ§æŒ‡æ ‡**: å®šæœŸæ£€æŸ¥æŸ¥è¯¢å»¶è¿Ÿã€å¬å›ç‡ã€ç´¢å¼•ä½¿ç”¨æƒ…å†µ
5. **å®šæœŸç»´æŠ¤**: å®šæœŸVACUUMå’ŒANALYZEï¼Œé‡å»ºç´¢å¼•ä»¥ä¼˜åŒ–æ€§èƒ½
