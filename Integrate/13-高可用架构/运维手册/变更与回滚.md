---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\å˜æ›´ä¸å›æ»š.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šå˜æ›´ä¸å›æ»šï¼ˆPostgreSQL 18ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)

---

## ğŸ“‹ ç›®å½•

- [Runbookï¼šå˜æ›´ä¸å›æ»šï¼ˆPostgreSQL 18ï¼‰](#runbookå˜æ›´ä¸å›æ»špostgresql-18)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [èŒƒå›´](#èŒƒå›´)
  - [åŸåˆ™](#åŸåˆ™)
  - [æµç¨‹ï¼ˆç¤ºæ„ï¼‰](#æµç¨‹ç¤ºæ„)
    - [1. å˜æ›´è¯„å®¡](#1-å˜æ›´è¯„å®¡)
    - [2. å˜æ›´çª—å£å‡†å¤‡](#2-å˜æ›´çª—å£å‡†å¤‡)
    - [3. å˜æ›´æ‰§è¡Œ](#3-å˜æ›´æ‰§è¡Œ)
    - [4. éªŒè¯](#4-éªŒè¯)
  - [å›æ»šç­–ç•¥ï¼ˆç¤ºä¾‹ï¼‰](#å›æ»šç­–ç•¥ç¤ºä¾‹)
    - [å›æ»šæ‰§è¡Œ](#å›æ»šæ‰§è¡Œ)
  - [æ£€æŸ¥æ¸…å•ï¼ˆå ä½ï¼‰](#æ£€æŸ¥æ¸…å•å ä½)
    - [å®Œæ•´æ£€æŸ¥æ¸…å•](#å®Œæ•´æ£€æŸ¥æ¸…å•)
  - [æ¼”ç»ƒé¢‘ç‡ï¼ˆå»ºè®®ï¼‰](#æ¼”ç»ƒé¢‘ç‡å»ºè®®)
    - [æ¼”ç»ƒè„šæœ¬](#æ¼”ç»ƒè„šæœ¬)
  - [äº¤å‰å¼•ç”¨](#äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## èŒƒå›´

å‚æ•°å˜æ›´ã€DDL å˜æ›´ã€ç´¢å¼•/åˆ†åŒºå˜æ›´ã€ç‰ˆæœ¬å‡çº§å°æ­¥æ¨è¿›ã€‚

## åŸåˆ™

- è“ç»¿/é‡‘ä¸é›€ï¼šä¼˜å…ˆå¯¹è¯»æµé‡è¯•ç‚¹ï¼Œé€æ­¥æ‰©å¤§
- å¯å›æ»šï¼šä¿ç•™æ—§ç»“æ„ä¸æ•°æ®è·¯å¾„ã€å½±å­ç´¢å¼•/è¡¨
- å¯è§‚æµ‹ï¼šæ ‡å‡†åŒ–å‰åæŒ‡æ ‡å¯¹æ¯”

## æµç¨‹ï¼ˆç¤ºæ„ï¼‰

1) è¯„å®¡ï¼šå½±å“è¯„ä¼°ã€å›æ»šè·¯å¾„ã€éªŒè¯è®¡åˆ’
2) å˜æ›´çª—å£ï¼šåªè¯»æœŸ/ä½å³°æœŸï¼Œå†»ç»“é•¿äº‹åŠ¡
3) æ‰§è¡Œï¼šåˆ†æ‰¹ã€å¹‚ç­‰è„šæœ¬ã€é”™è¯¯å³åœ
4) éªŒè¯ï¼šåŠŸèƒ½/æ€§èƒ½/ä¸€è‡´æ€§ï¼›è‹¥å¤±è´¥èµ°å›æ»š

### 1. å˜æ›´è¯„å®¡

**å½±å“è¯„ä¼°**:

```sql
-- 1. è¯†åˆ«å—å½±å“å¯¹è±¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_indexes'
    ) THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO index_count
    FROM pg_indexes
    WHERE tablename = 'target_table';

    IF index_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç›¸å…³ç´¢å¼•', index_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç›¸å…³ç´¢å¼•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¯†åˆ«å—å½±å“å¯¹è±¡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname
FROM pg_indexes
WHERE tablename = 'target_table';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 2. æ£€æŸ¥ä¾èµ–å…³ç³»ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    dependency_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_depend'
    ) THEN
        RAISE WARNING 'pg_dependè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO dependency_count
    FROM pg_depend
    JOIN pg_rewrite ON pg_depend.objid = pg_rewrite.oid
    JOIN pg_class as dependent_view ON pg_rewrite.ev_class = dependent_view.oid
    JOIN pg_class as source_table ON pg_depend.refobjid = source_table.oid
    JOIN pg_namespace dependent_ns ON dependent_view.relnamespace = dependent_ns.oid
    JOIN pg_namespace source_ns ON source_table.relnamespace = source_ns.oid
    WHERE source_table.relname = 'target_table';

    IF dependency_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªä¾èµ–å…³ç³»', dependency_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ä¾èµ–å…³ç³»';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³ç³»ç»Ÿè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä¾èµ–å…³ç³»å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    dependent_ns.nspname as dependent_schema,
    dependent_view.relname as dependent_view,
    source_ns.nspname as source_schema,
    source_table.relname as source_table
FROM pg_depend
JOIN pg_rewrite ON pg_depend.objid = pg_rewrite.oid
JOIN pg_class as dependent_view ON pg_rewrite.ev_class = dependent_view.oid
JOIN pg_class as source_table ON pg_depend.refobjid = source_table.oid
JOIN pg_namespace dependent_ns ON dependent_view.relnamespace = dependent_ns.oid
JOIN pg_namespace source_ns ON source_table.relnamespace = source_ns.oid
WHERE source_table.relname = 'target_table';
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºä¾èµ–å…³ç³»æ•°é‡ï¼‰
-- è®¡åˆ’: Nested Loop -> Hash Join

-- 3. æ£€æŸ¥è®¢é˜…ï¼ˆé€»è¾‘å¤åˆ¶ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription'
    ) THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO subscription_count
    FROM pg_subscription
    WHERE subpublications && ARRAY['target_publication'];

    IF subscription_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç›¸å…³è®¢é˜…', subscription_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç›¸å…³è®¢é˜…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¢é˜…å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subpublications,
    subenabled
FROM pg_subscription
WHERE subpublications && ARRAY['target_publication'];
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**å›æ»šè·¯å¾„è®¾è®¡**:

```sql
-- åˆ›å»ºå˜æ›´è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'change_log'
    ) THEN
        CREATE TABLE change_log (
            change_id SERIAL PRIMARY KEY,
            change_time TIMESTAMP DEFAULT NOW(),
            change_type VARCHAR(50),  -- 'parameter', 'ddl', 'index', 'partition', 'upgrade'
            change_target TEXT,
            old_value TEXT,
            new_value TEXT,
            rollback_script TEXT,
            change_by VARCHAR(100),
            change_status VARCHAR(20),  -- 'planned', 'in_progress', 'completed', 'rolled_back'
            verification_result TEXT
        );
        RAISE NOTICE 'å˜æ›´è®°å½•è¡¨change_logåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'å˜æ›´è®°å½•è¡¨change_logå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'å˜æ›´è®°å½•è¡¨change_logå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå˜æ›´è®°å½•è¡¨å¤±è´¥: %', SQLERRM;
END $$;
```

### 2. å˜æ›´çª—å£å‡†å¤‡

**å†»ç»“é•¿äº‹åŠ¡**:

```sql
-- 1. è¯†åˆ«é•¿äº‹åŠ¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    long_txn_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO long_txn_count
    FROM pg_stat_activity
    WHERE state = 'active'
    AND NOW() - query_start > INTERVAL '5 minutes';

    IF long_txn_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªé•¿äº‹åŠ¡', long_txn_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°é•¿äº‹åŠ¡';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¯†åˆ«é•¿äº‹åŠ¡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pid,
    usename,
    datname,
    state,
    query_start,
    NOW() - query_start as duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND NOW() - query_start > INTERVAL '5 minutes'
ORDER BY query_start;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Sort -> Seq Scan

-- 2. ç»ˆæ­¢é•¿äº‹åŠ¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    terminated_count INT := 0;
    backend_pid INT;
    target_pid INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_terminate_backend') THEN
        RAISE EXCEPTION 'pg_terminate_backendå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_backend_pid') THEN
        RAISE EXCEPTION 'pg_backend_pidå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_backend_pid() INTO backend_pid;

    FOR target_pid IN
        SELECT pid
        FROM pg_stat_activity
        WHERE state = 'active'
        AND NOW() - query_start > INTERVAL '10 minutes'
        AND pid != backend_pid
    LOOP
        PERFORM pg_terminate_backend(target_pid);
        terminated_count := terminated_count + 1;
    END LOOP;

    IF terminated_count > 0 THEN
        RAISE NOTICE 'å·²ç»ˆæ­¢ % ä¸ªé•¿äº‹åŠ¡', terminated_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°éœ€è¦ç»ˆæ­¢çš„é•¿äº‹åŠ¡';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_terminate_backendæˆ–pg_backend_pidå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•ç»ˆæ­¢åç«¯è¿›ç¨‹';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç»ˆæ­¢é•¿äº‹åŠ¡å¤±è´¥: %', SQLERRM;
END $$;

-- 3. æ£€æŸ¥é”ç­‰å¾…ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    lock_wait_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_locks'
    ) THEN
        RAISE WARNING 'pg_locksè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO lock_wait_count
    FROM pg_catalog.pg_locks blocked_locks
    JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
    JOIN pg_catalog.pg_locks blocking_locks
        ON blocking_locks.locktype = blocked_locks.locktype
        AND blocking_locks.pid != blocked_locks.pid
    JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
    WHERE NOT blocked_locks.granted;

    IF lock_wait_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªé”ç­‰å¾…', lock_wait_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°é”ç­‰å¾…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³ç³»ç»Ÿè¡¨æˆ–è§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥é”ç­‰å¾…å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºé”ç­‰å¾…æ•°é‡ï¼‰
-- è®¡åˆ’: Hash Join -> Nested Loop
```

**ä½å³°æœŸç¡®è®¤**:

```sql
-- æ£€æŸ¥å½“å‰è´Ÿè½½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_conn INT;
    active_queries INT;
    waiting_queries INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT
        COUNT(*),
        COUNT(*) FILTER (WHERE state = 'active'),
        COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL)
    INTO total_conn, active_queries, waiting_queries
    FROM pg_stat_activity
    WHERE datname = current_database();

    RAISE NOTICE 'å½“å‰è´Ÿè½½ - æ€»è¿æ¥æ•°: %, æ´»è·ƒæŸ¥è¯¢: %, ç­‰å¾…æŸ¥è¯¢: %', total_conn, active_queries, waiting_queries;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å½“å‰è´Ÿè½½å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_queries,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_queries
FROM pg_stat_activity
WHERE datname = current_database();
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Aggregate -> Seq Scan
```

### 3. å˜æ›´æ‰§è¡Œ

**å‚æ•°å˜æ›´**:

```sql
-- æ–¹æ³•1: ALTER SYSTEM SETï¼ˆæ¨èï¼ŒæŒä¹…åŒ–ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    old_value TEXT;
BEGIN
    SELECT setting INTO old_value
    FROM pg_settings
    WHERE name = 'shared_buffers';

    ALTER SYSTEM SET shared_buffers = '512MB';
    RAISE NOTICE 'å‚æ•°shared_bufferså·²ä»%æ›´æ–°ä¸º512MB', old_value;

    PERFORM pg_reload_conf();
    RAISE NOTICE 'é…ç½®å·²é‡æ–°åŠ è½½ï¼ˆæ³¨æ„ï¼šéƒ¨åˆ†å‚æ•°éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥shared_buffersçš„å€¼';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‚æ•°å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ³•2: ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶
-- ç¼–è¾‘ postgresql.conf
-- shared_buffers = 512MB
-- ç„¶åé‡å¯æˆ–reload

-- è®°å½•å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    old_value TEXT;
    change_log_exists BOOLEAN;
BEGIN
    -- æ£€æŸ¥change_logè¡¨æ˜¯å¦å­˜åœ¨
    SELECT EXISTS(
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'change_log'
    ) INTO change_log_exists;

    IF NOT change_log_exists THEN
        RAISE WARNING 'è¡¨change_logä¸å­˜åœ¨ï¼Œè·³è¿‡å˜æ›´è®°å½•';
        RETURN;
    END IF;

    SELECT setting INTO old_value
    FROM pg_settings
    WHERE name = 'shared_buffers';

    INSERT INTO change_log (
        change_type,
        change_target,
        old_value,
        new_value,
        rollback_script,
        change_by
    )
    VALUES (
        'parameter',
        'shared_buffers',
        old_value,
        '512MB',
        'ALTER SYSTEM SET shared_buffers = ''256MB'';',
        current_user
    );
    RAISE NOTICE 'å˜æ›´è®°å½•å·²ä¿å­˜';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨change_logæˆ–pg_settingsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;
```

**DDLå˜æ›´**:

```sql
-- ç¤ºä¾‹ï¼šæ·»åŠ åˆ—ï¼ˆä½¿ç”¨IF NOT EXISTSç¡®ä¿å¹‚ç­‰ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ALTER TABLE orders
    ADD COLUMN IF NOT EXISTS new_column VARCHAR(100);
    RAISE NOTICE 'åˆ—new_columnæ·»åŠ æˆåŠŸï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_column THEN
        RAISE NOTICE 'åˆ—new_columnå·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
END $$;

-- ç¤ºä¾‹ï¼šä¿®æ”¹åˆ—ç±»å‹ï¼ˆéœ€è¦æ•°æ®è½¬æ¢ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ­¥éª¤1: æ·»åŠ æ–°åˆ—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'status_new'
    ) THEN
        RAISE NOTICE 'åˆ—status_newå·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ';
        RETURN;
    END IF;

    ALTER TABLE orders
    ADD COLUMN status_new INTEGER;
    RAISE NOTICE 'åˆ—status_newæ·»åŠ æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_column THEN
        RAISE NOTICE 'åˆ—status_newå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤2: æ•°æ®è¿ç§»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'status'
    ) THEN
        RAISE WARNING 'åˆ—statusä¸å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®è¿ç§»';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'status_new'
    ) THEN
        RAISE EXCEPTION 'åˆ—status_newä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ';
    END IF;

    UPDATE orders
    SET status_new = CASE
        WHEN status = 'pending' THEN 1
        WHEN status = 'processing' THEN 2
        WHEN status = 'completed' THEN 3
        ELSE 0
    END;

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RAISE NOTICE 'æ•°æ®è¿ç§»å®Œæˆï¼Œæ›´æ–°äº† % æ¡è®°å½•', updated_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'åˆ—statusæˆ–status_newä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®è¿ç§»å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤3: åˆ é™¤æ—§åˆ—ï¼ˆåœ¨éªŒè¯åï¼‰
-- ALTER TABLE orders DROP COLUMN status;
-- ALTER TABLE orders RENAME COLUMN status_new TO status;

-- å›æ»šè„šæœ¬
-- ALTER TABLE orders DROP COLUMN IF EXISTS status_new;
```

**ç´¢å¼•å˜æ›´**:

```sql
-- åœ¨çº¿åˆ›å»ºç´¢å¼•ï¼ˆä¸é˜»å¡å†™æ“ä½œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND tablename = 'orders' AND indexname = 'idx_orders_created_at_new'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    CREATE INDEX CONCURRENTLY idx_orders_created_at_new ON orders(created_at);
    RAISE NOTICE 'ç´¢å¼•åˆ›å»ºæˆåŠŸ: idx_orders_created_at_new';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_exists BOOLEAN;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders'
        AND indexname = 'idx_orders_created_at_new'
    ) INTO index_exists;

    IF NOT index_exists THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_created_at_newä¸å­˜åœ¨';
    ELSE
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newåˆ›å»ºæˆåŠŸ';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'orders'
AND indexname = 'idx_orders_created_at_new';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- åˆ‡æ¢ç´¢å¼•ï¼ˆä½¿ç”¨è§†å›¾æˆ–åº”ç”¨å±‚åˆ‡æ¢ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ­¥éª¤1: åˆ›å»ºè§†å›¾æ¡¥æ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    CREATE OR REPLACE VIEW orders_view AS
    SELECT * FROM orders;
    RAISE NOTICE 'è§†å›¾orders_viewåˆ›å»º/æ›´æ–°æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè§†å›¾å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤2: åº”ç”¨åˆ‡æ¢åˆ°æ–°ç´¢å¼•
-- æ­¥éª¤3: åˆ é™¤æ—§ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'idx_orders_created_at_old'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_oldä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    DROP INDEX CONCURRENTLY IF EXISTS idx_orders_created_at_old;
    RAISE NOTICE 'ç´¢å¼•åˆ é™¤æˆåŠŸ: idx_orders_created_at_old';
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_oldä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ é™¤ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- å›æ»šè„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- DO $$
-- BEGIN
--     DROP INDEX CONCURRENTLY IF EXISTS idx_orders_created_at_new;
--     RAISE NOTICE 'å›æ»šå®Œæˆï¼šå·²åˆ é™¤ç´¢å¼•idx_orders_created_at_new';
-- EXCEPTION
--     WHEN undefined_table THEN
--         RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newä¸å­˜åœ¨';
--     WHEN OTHERS THEN
--         RAISE EXCEPTION 'å›æ»šå¤±è´¥: %', SQLERRM;
-- END $$;
```

**åˆ†åŒºå˜æ›´**:

```sql
-- ç¤ºä¾‹ï¼šæ·»åŠ æ–°åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    CREATE TABLE IF NOT EXISTS orders_2025_12 PARTITION OF orders
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
    RAISE NOTICE 'åˆ†åŒºorders_2025_12åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE NOTICE 'åˆ†åŒºorders_2025_12å·²å­˜åœ¨ï¼Œè·³è¿‡';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ·»åŠ åˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;

-- ç¤ºä¾‹ï¼šåˆ é™¤æ—§åˆ†åŒºï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ­¥éª¤1: è¿ç§»æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders_2024_12'
    ) THEN
        RAISE WARNING 'åˆ†åŒºorders_2024_12ä¸å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®è¿ç§»';
        RETURN;
    END IF;

    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders_2024_12_backup'
    ) THEN
        DROP TABLE orders_2024_12_backup;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰å¤‡ä»½è¡¨: orders_2024_12_backup';
    END IF;

    CREATE TABLE orders_2024_12_backup AS
    SELECT * FROM orders_2024_12;
    RAISE NOTICE 'æ•°æ®è¿ç§»å®Œæˆ: orders_2024_12 -> orders_2024_12_backup';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'åˆ†åŒºorders_2024_12ä¸å­˜åœ¨';
    WHEN duplicate_table THEN
        RAISE WARNING 'å¤‡ä»½è¡¨orders_2024_12_backupå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®è¿ç§»å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤2: åˆ†ç¦»åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders_2024_12'
    ) THEN
        RAISE WARNING 'åˆ†åŒºorders_2024_12ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ†ç¦»';
        RETURN;
    END IF;

    ALTER TABLE orders DETACH PARTITION orders_2024_12;
    RAISE NOTICE 'åˆ†åŒºåˆ†ç¦»æˆåŠŸ: orders_2024_12';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersæˆ–åˆ†åŒºorders_2024_12ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ†ç¦»åˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤3: åˆ é™¤åˆ†åŒºï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders_2024_12'
    ) THEN
        RAISE WARNING 'åˆ†åŒºorders_2024_12ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    DROP TABLE orders_2024_12;
    RAISE NOTICE 'åˆ†åŒºåˆ é™¤æˆåŠŸ: orders_2024_12';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'åˆ†åŒºorders_2024_12ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ é™¤åˆ†åŒºå¤±è´¥: %', SQLERRM;
END $$;

-- å›æ»šè„šæœ¬
-- ALTER TABLE orders ATTACH PARTITION orders_2024_12
-- FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

### 4. éªŒè¯

**åŠŸèƒ½éªŒè¯**:

```sql
-- 1. éªŒè¯å¯¹è±¡å­˜åœ¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    SELECT COUNT(*) INTO index_count
    FROM pg_indexes
    WHERE tablename = 'target_table';

    IF index_count = 0 THEN
        RAISE WARNING 'è¡¨target_tableæœªæ‰¾åˆ°ç´¢å¼•';
    ELSE
        RAISE NOTICE 'è¡¨target_tableæ‰¾åˆ° % ä¸ªç´¢å¼•', index_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å¯¹è±¡å­˜åœ¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname
FROM pg_indexes
WHERE tablename = 'target_table';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 2. éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_count BIGINT;
    new_column_count BIGINT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'target_table'
    ) THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO total_count FROM target_table;
    RAISE NOTICE 'è¡¨target_tableæ€»è®°å½•æ•°: %', total_count;

    IF EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'target_table' AND column_name = 'new_column'
    ) THEN
        SELECT COUNT(*) INTO new_column_count FROM target_table WHERE new_column IS NOT NULL;
        RAISE NOTICE 'new_columnéç©ºè®°å½•æ•°: %', new_column_count;
    ELSE
        RAISE WARNING 'åˆ—new_columnä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE WARNING 'åˆ—new_columnä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯æ•°æ®å®Œæ•´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM target_table;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM target_table WHERE new_column IS NOT NULL;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

-- 3. éªŒè¯çº¦æŸï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    constraint_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'target_table'
    ) THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO constraint_count
    FROM pg_constraint
    WHERE conrelid = 'target_table'::regclass;

    IF constraint_count = 0 THEN
        RAISE NOTICE 'è¡¨target_tableæœªæ‰¾åˆ°çº¦æŸ';
    ELSE
        RAISE NOTICE 'è¡¨target_tableæ‰¾åˆ° % ä¸ªçº¦æŸ', constraint_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_get_constraintdefå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯çº¦æŸå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    conname,
    contype,
    pg_get_constraintdef(oid) as definition
FROM pg_constraint
WHERE conrelid = 'target_table'::regclass;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**æ€§èƒ½éªŒè¯**:

```sql
-- å¯¹æ¯”å˜æ›´å‰åçš„æ€§èƒ½æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    baseline_exists BOOLEAN;
    before_count INT;
    after_count INT;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_baseline'
    ) INTO baseline_exists;

    IF NOT baseline_exists THEN
        RAISE WARNING 'è¡¨performance_baselineä¸å­˜åœ¨ï¼Œè·³è¿‡æ€§èƒ½å¯¹æ¯”';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO before_count
    FROM performance_baseline
    WHERE baseline_time < NOW() - INTERVAL '1 hour';

    SELECT COUNT(*) INTO after_count
    FROM performance_baseline;

    IF before_count = 0 OR after_count = 0 THEN
        RAISE WARNING 'æ€§èƒ½åŸºçº¿æ•°æ®ä¸è¶³ï¼Œæ— æ³•å¯¹æ¯”';
        RETURN;
    END IF;

    RAISE NOTICE 'å˜æ›´å‰åŸºçº¿è®°å½•æ•°: %, å˜æ›´ååŸºçº¿è®°å½•æ•°: %', before_count, after_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨performance_baselineä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
WITH before AS (
    SELECT * FROM performance_baseline
    WHERE baseline_time = (SELECT MAX(baseline_time) FROM performance_baseline WHERE baseline_time < NOW() - INTERVAL '1 hour')
),
after AS (
    SELECT * FROM performance_baseline
    WHERE baseline_time = (SELECT MAX(baseline_time) FROM performance_baseline)
)
SELECT
    'Active Queries' as metric,
    before.active_queries as before_value,
    after.active_queries as after_value,
    after.active_queries - before.active_queries as delta
FROM before, after;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Nested Loop
```

**ä¸€è‡´æ€§éªŒè¯**:

```sql
-- éªŒè¯ä¸»ä»ä¸€è‡´æ€§ï¼ˆå¦‚æœæœ‰å¤åˆ¶ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    replication_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_replication'
    ) THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨ï¼Œå¯èƒ½æ²¡æœ‰é…ç½®å¤åˆ¶';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO replication_count
    FROM pg_stat_replication;

    IF replication_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå¤åˆ¶è¿æ¥', replication_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å¤åˆ¶è¿æ¥';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯ä¸»ä»ä¸€è‡´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as lag_bytes
FROM pg_stat_replication;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO table_count
    FROM pg_stat_user_tables
    WHERE schemaname = 'public';

    IF table_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç”¨æˆ·è¡¨', table_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç”¨æˆ·è¡¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯æ•°æ®ä¸€è‡´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Sort -> Seq Scan
```

## å›æ»šç­–ç•¥ï¼ˆç¤ºä¾‹ï¼‰

- å‚æ•°ï¼šä¿å­˜åŸé…ç½®å¹¶å¯ä¸€é”®æ¢å¤
- DDLï¼šä¿ç•™æ—§å¯¹è±¡ï¼Œä½¿ç”¨è§†å›¾æˆ–è§¦å‘å™¨æ¡¥æ¥
- ç´¢å¼•ï¼šåœ¨çº¿åˆ›å»ºï¼Œæ–°æ—§å¹¶å­˜ï¼Œåˆ‡æ¢åæ—§ç´¢å¼•å›æ”¶

### å›æ»šæ‰§è¡Œ

**å‚æ•°å›æ»š**:

```sql
-- ä»å˜æ›´è®°å½•è·å–å›æ»šè„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    rollback_script_text TEXT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'change_log'
    ) THEN
        RAISE WARNING 'è¡¨change_logä¸å­˜åœ¨ï¼Œæ— æ³•è·å–å›æ»šè„šæœ¬';
        RETURN;
    END IF;

    SELECT rollback_script INTO rollback_script_text
    FROM change_log
    WHERE change_id = <change_id>  -- æ›¿æ¢ä¸ºå®é™…çš„change_id
    AND change_status = 'in_progress'
    LIMIT 1;

    IF rollback_script_text IS NOT NULL THEN
        RAISE NOTICE 'æ‰¾åˆ°å›æ»šè„šæœ¬: %', LEFT(rollback_script_text, 100);
    ELSE
        RAISE WARNING 'æœªæ‰¾åˆ°å›æ»šè„šæœ¬';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨change_logä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è·å–å›æ»šè„šæœ¬å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT rollback_script
FROM change_log
WHERE change_id = <change_id>  -- æ›¿æ¢ä¸ºå®é™…çš„change_id
AND change_status = 'in_progress';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ‰§è¡Œå›æ»šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    old_value TEXT;
BEGIN
    -- ä»change_logè·å–æ—§å€¼
    SELECT old_value INTO old_value
    FROM change_log
    WHERE change_id = <change_id>  -- æ›¿æ¢ä¸ºå®é™…çš„change_id
    AND change_status = 'applied';

    IF old_value IS NULL THEN
        RAISE EXCEPTION 'æœªæ‰¾åˆ°å˜æ›´è®°å½•æˆ–å˜æ›´æœªåº”ç”¨';
    END IF;

    ALTER SYSTEM SET shared_buffers = old_value;
    RAISE NOTICE 'å‚æ•°å·²æ¢å¤åˆ°æ—§å€¼: %', old_value;

    PERFORM pg_reload_conf();
    RAISE NOTICE 'é…ç½®å·²é‡æ–°åŠ è½½';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'change_logè¡¨æˆ–pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å›æ»šå¤±è´¥: %', SQLERRM;
END $$;

-- æ›´æ–°å˜æ›´è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_rows INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'change_log'
    ) THEN
        RAISE WARNING 'è¡¨change_logä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°';
        RETURN;
    END IF;

    UPDATE change_log
    SET
        change_status = 'rolled_back',
        verification_result = 'å›æ»šåŸå› ï¼šæ€§èƒ½æŒ‡æ ‡ä¸‹é™10%'
    WHERE change_id = <change_id>;  -- æ›¿æ¢ä¸ºå®é™…çš„change_id

    GET DIAGNOSTICS updated_rows = ROW_COUNT;
    IF updated_rows = 0 THEN
        RAISE WARNING 'æœªæ‰¾åˆ°åŒ¹é…çš„å˜æ›´è®°å½•';
    ELSE
        RAISE NOTICE 'å˜æ›´è®°å½•å·²æ›´æ–°: % è¡Œ', updated_rows;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨change_logä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°å˜æ›´è®°å½•å¤±è´¥: %', SQLERRM;
END $$;
```

**DDLå›æ»š**:

```sql
-- ç¤ºä¾‹ï¼šå›æ»šæ·»åŠ åˆ—ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œæ— æ³•å›æ»š';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'new_column'
    ) THEN
        RAISE NOTICE 'åˆ—new_columnä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    ALTER TABLE orders DROP COLUMN IF EXISTS new_column;
    RAISE NOTICE 'åˆ—new_columnåˆ é™¤æˆåŠŸï¼ˆå›æ»šå®Œæˆï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å›æ»šæ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
END $$;

-- ç¤ºä¾‹ï¼šå›æ»šä¿®æ”¹åˆ—ç±»å‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ¢å¤æ—§åˆ—
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œæ— æ³•å›æ»š';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'status_new'
    ) THEN
        RAISE NOTICE 'åˆ—status_newä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    ALTER TABLE orders DROP COLUMN IF EXISTS status_new;
    RAISE NOTICE 'åˆ—status_newåˆ é™¤æˆåŠŸï¼ˆå›æ»šå®Œæˆï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å›æ»šä¿®æ”¹åˆ—ç±»å‹å¤±è´¥: %', SQLERRM;
END $$;

-- æˆ–æ¢å¤æ—§æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- DO $$
-- BEGIN
--     IF NOT EXISTS (
--         SELECT 1 FROM information_schema.tables
--         WHERE table_schema = 'public' AND table_name = 'orders_backup'
--     ) THEN
--         RAISE WARNING 'å¤‡ä»½è¡¨orders_backupä¸å­˜åœ¨ï¼Œæ— æ³•æ¢å¤æ•°æ®';
--         RETURN;
--     END IF;
--     UPDATE orders SET status = ... FROM orders_backup WHERE ...;
--     RAISE NOTICE 'æ•°æ®æ¢å¤å®Œæˆ';
-- EXCEPTION
--     WHEN undefined_table THEN
--         RAISE WARNING 'ç›¸å…³è¡¨ä¸å­˜åœ¨';
--     WHEN OTHERS THEN
--         RAISE EXCEPTION 'æ¢å¤æ—§æ•°æ®å¤±è´¥: %', SQLERRM;
-- END $$;
```

**ç´¢å¼•å›æ»š**:

```sql
-- åˆ é™¤æ–°ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'idx_orders_created_at_new'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
        RETURN;
    END IF;

    DROP INDEX CONCURRENTLY IF EXISTS idx_orders_created_at_new;
    RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_newåˆ é™¤æˆåŠŸï¼ˆå¹¶å‘æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_created_at_newä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ é™¤ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- æ¢å¤æ—§ç´¢å¼•ï¼ˆå¦‚æœå·²åˆ é™¤ï¼Œéœ€è¦é‡å»ºï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œæ— æ³•é‡å»ºç´¢å¼•';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE schemaname = 'public' AND indexname = 'idx_orders_created_at_old'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_oldå·²å­˜åœ¨ï¼Œè·³è¿‡é‡å»º';
        RETURN;
    END IF;

    CREATE INDEX CONCURRENTLY idx_orders_created_at_old ON orders(created_at);
    RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_oldé‡å»ºæˆåŠŸï¼ˆå¹¶å‘æ¨¡å¼ï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_at_oldå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é‡å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

## æ£€æŸ¥æ¸…å•ï¼ˆå ä½ï¼‰

- å˜æ›´è„šæœ¬å·²å¹²è·‘ï¼ˆéç”Ÿäº§ï¼‰ä¸”é€šè¿‡
- å—å½±å“å¯¹è±¡ä¸ä¾èµ–æ¸…å•å·²ç¡®è®¤ï¼ˆè§†å›¾/è§¦å‘å™¨/å‡½æ•°/è®¢é˜…ï¼‰
- ç›‘æ§çœ‹æ¿ä¸é—¨é™å·²è®¾å®šï¼ˆå‰/ä¸­/åå¯¹æ¯”ï¼‰
- å›æ»šè„šæœ¬ä¸æ­¥éª¤å·²æ ¡éªŒ

### å®Œæ•´æ£€æŸ¥æ¸…å•

**å˜æ›´å‰æ£€æŸ¥**:

```sql
-- 1. å˜æ›´è„šæœ¬éªŒè¯ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒï¼‰
-- æ‰§è¡Œå˜æ›´è„šæœ¬å¹¶éªŒè¯ç»“æœ

-- 2. å—å½±å“å¯¹è±¡æ¸…å•ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    object_count INT;
BEGIN
    SELECT COUNT(*) INTO object_count
    FROM (
        SELECT schemaname || '.' || tablename as object_name
        FROM pg_tables
        WHERE tablename LIKE 'target%'
        UNION ALL
        SELECT schemaname || '.' || viewname
        FROM pg_views
        WHERE viewname LIKE 'target%'
        UNION ALL
        SELECT n.nspname || '.' || p.proname
        FROM pg_proc p
        JOIN pg_namespace n ON p.pronamespace = n.oid
        WHERE p.proname LIKE 'target%'
    ) objects;

    IF object_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå—å½±å“å¯¹è±¡', object_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å—å½±å“å¯¹è±¡';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³ç³»ç»Ÿè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å—å½±å“å¯¹è±¡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    'Tables' as object_type,
    schemaname || '.' || tablename as object_name
FROM pg_tables
WHERE tablename LIKE 'target%'
UNION ALL
SELECT
    'Views',
    schemaname || '.' || viewname
FROM pg_views
WHERE viewname LIKE 'target%'
UNION ALL
SELECT
    'Functions',
    n.nspname || '.' || p.proname
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE p.proname LIKE 'target%';
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºå¯¹è±¡æ•°é‡ï¼‰
-- è®¡åˆ’: Append -> Union All

-- 3. ä¾èµ–å…³ç³»æ£€æŸ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    dependency_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_depend'
    ) THEN
        RAISE WARNING 'pg_dependè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO dependency_count
    FROM pg_depend
    JOIN pg_rewrite ON pg_depend.objid = pg_rewrite.oid
    JOIN pg_class as dependent_view ON pg_rewrite.ev_class = dependent_view.oid
    JOIN pg_class as source_table ON pg_depend.refobjid = source_table.oid
    JOIN pg_namespace dependent_ns ON dependent_view.relnamespace = dependent_ns.oid
    JOIN pg_namespace source_ns ON source_table.relnamespace = source_ns.oid
    WHERE source_table.relname = 'target_table';

    IF dependency_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªä¾èµ–å…³ç³»', dependency_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ä¾èµ–å…³ç³»';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³ç³»ç»Ÿè¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä¾èµ–å…³ç³»å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    dependent_ns.nspname || '.' || dependent_view.relname as dependent_object,
    source_ns.nspname || '.' || source_table.relname as source_object
FROM pg_depend
JOIN pg_rewrite ON pg_depend.objid = pg_rewrite.oid
JOIN pg_class as dependent_view ON pg_rewrite.ev_class = dependent_view.oid
JOIN pg_class as source_table ON pg_depend.refobjid = source_table.oid
JOIN pg_namespace dependent_ns ON dependent_view.relnamespace = dependent_ns.oid
JOIN pg_namespace source_ns ON source_table.relnamespace = source_ns.oid
WHERE source_table.relname = 'target_table';
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºä¾èµ–å…³ç³»æ•°é‡ï¼‰
-- è®¡åˆ’: Nested Loop -> Hash Join
```

**å˜æ›´ä¸­ç›‘æ§**:

```sql
-- å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_queries INT;
    avg_query_time NUMERIC;
    lock_waits INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO active_queries
    FROM pg_stat_activity
    WHERE state = 'active';

    IF EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        SELECT AVG(mean_exec_time) INTO avg_query_time
        FROM pg_stat_statements
        WHERE calls > 100;
    ELSE
        avg_query_time := NULL;
        RAISE NOTICE 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè·³è¿‡å¹³å‡æŸ¥è¯¢æ—¶é—´ç»Ÿè®¡';
    END IF;

    SELECT COUNT(*) INTO lock_waits
    FROM pg_stat_activity
    WHERE wait_event_type = 'Lock';

    RAISE NOTICE 'ç›‘æ§æŒ‡æ ‡ - æ´»è·ƒæŸ¥è¯¢: %, å¹³å‡æŸ¥è¯¢æ—¶é—´: % ms, é”ç­‰å¾…: %',
                 active_queries, COALESCE(avg_query_time, 0), lock_waits;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³ç³»ç»Ÿè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å®æ—¶ç›‘æ§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    NOW() as check_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries,
    (SELECT AVG(mean_exec_time) FROM pg_stat_statements WHERE calls > 100) as avg_query_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type = 'Lock') as lock_waits;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Result -> SubPlan
```

**å˜æ›´åéªŒè¯**:

```sql
-- 1. åŠŸèƒ½éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    row_count BIGINT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'target_table'
    ) THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    SELECT COUNT(*) INTO row_count FROM target_table;
    RAISE NOTICE 'è¡¨target_tableåŒ…å« % è¡Œæ•°æ®', row_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨target_tableä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åŠŸèƒ½éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM target_table;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨å¤§å°ï¼‰
-- è®¡åˆ’: Aggregate

-- 2. æ€§èƒ½éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    func_exists BOOLEAN;
    result_count INT;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_proc
        WHERE proname = 'verify_performance_change'
    ) INTO func_exists;

    IF NOT func_exists THEN
        RAISE WARNING 'å‡½æ•°verify_performance_changeä¸å­˜åœ¨ï¼Œè·³è¿‡æ€§èƒ½éªŒè¯';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO result_count
    FROM verify_performance_change();

    IF result_count > 0 THEN
        RAISE NOTICE 'æ€§èƒ½éªŒè¯å®Œæˆï¼Œå‘ç° % æ¡è®°å½•', result_count;
    ELSE
        RAISE NOTICE 'æ€§èƒ½éªŒè¯å®Œæˆï¼Œæœªå‘ç°è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'å‡½æ•°verify_performance_changeä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ€§èƒ½éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM verify_performance_change();
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºå‡½æ•°å®ç°ï¼‰
-- è®¡åˆ’: Function Scan

-- 3. ä¸€è‡´æ€§éªŒè¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO table_count
    FROM pg_stat_user_tables
    WHERE schemaname = 'public';

    IF table_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç”¨æˆ·è¡¨', table_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç”¨æˆ·è¡¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ä¸€è‡´æ€§éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables
WHERE schemaname = 'public';
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Seq Scan
```

## æ¼”ç»ƒé¢‘ç‡ï¼ˆå»ºè®®ï¼‰

- æœˆåº¦ï¼šå¸¸è§„å‚æ•°ä¸ç´¢å¼•è°ƒæ•´æ¼”ç»ƒ
- å­£åº¦ï¼šDDL ç»“æ„æ€§å˜æ›´ä¸è·¨ç‰ˆæœ¬å‡çº§é¢„æ¼”

### æ¼”ç»ƒè„šæœ¬

```bash
#!/bin/bash
# change_drill.sh

# æ¼”ç»ƒåœºæ™¯ï¼šå‚æ•°å˜æ›´
echo "=== å˜æ›´æ¼”ç»ƒå¼€å§‹ ==="

# 1. è®°å½•å½“å‰çŠ¶æ€
psql -c "SELECT name, setting FROM pg_settings WHERE name = 'shared_buffers';" > /tmp/before_change.txt

# 2. æ‰§è¡Œå˜æ›´
psql -c "ALTER SYSTEM SET shared_buffers = '512MB';"
psql -c "SELECT pg_reload_conf();"

# 3. éªŒè¯å˜æ›´
psql -c "SELECT name, setting FROM pg_settings WHERE name = 'shared_buffers';" > /tmp/after_change.txt

# 4. è§‚å¯ŸæœŸï¼ˆ5åˆ†é’Ÿï¼‰
sleep 300

# 5. å›æ»š
psql -c "ALTER SYSTEM SET shared_buffers = '256MB';"
psql -c "SELECT pg_reload_conf();"

# 6. éªŒè¯å›æ»š
psql -c "SELECT name, setting FROM pg_settings WHERE name = 'shared_buffers';" > /tmp/after_rollback.txt

echo "=== å˜æ›´æ¼”ç»ƒå®Œæˆ ==="
```

---

## äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯](./01-æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯.md) - æ€§èƒ½è°ƒä¼˜å˜æ›´æµç¨‹
- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§ç†è®ºåŸºç¡€
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜è¯¦ç»†æŒ‡å—
- â­â­ [é›†ç¾¤ä¸é«˜å¯ç”¨æ¼”ç»ƒSOP](./03-é›†ç¾¤ä¸é«˜å¯ç”¨-æ¼”ç»ƒSOP.md) - é«˜å¯ç”¨æ¼”ç»ƒæµç¨‹
- â­ [æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º](./æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º.md) - æ•…éšœåˆ‡æ¢æµç¨‹

### å¤–éƒ¨èµ„æº

- [PostgreSQLå˜æ›´ç®¡ç†æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/maintenance.html)
- [PostgreSQL DDLæ–‡æ¡£](https://www.postgresql.org/docs/current/ddl.html)
- [PostgreSQLå‚æ•°é…ç½®](https://www.postgresql.org/docs/current/runtime-config.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
