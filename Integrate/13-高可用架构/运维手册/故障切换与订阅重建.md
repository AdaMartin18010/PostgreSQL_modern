---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šæ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»ºï¼ˆPostgreSQL 18ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)

---

## ğŸ“‹ ç›®å½•

- [Runbookï¼šæ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»ºï¼ˆPostgreSQL 18ï¼‰](#runbookæ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»ºpostgresql-18)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [åœºæ™¯](#åœºæ™¯)
  - [æ­¥éª¤ï¼ˆç¤ºæ„ï¼‰](#æ­¥éª¤ç¤ºæ„)
    - [1. æ•…éšœåˆ‡æ¢æµç¨‹](#1-æ•…éšœåˆ‡æ¢æµç¨‹)
    - [2. é€»è¾‘è®¢é˜…é‡å»º](#2-é€»è¾‘è®¢é˜…é‡å»º)
    - [3. å®Œæ•´åˆ‡æ¢è„šæœ¬](#3-å®Œæ•´åˆ‡æ¢è„šæœ¬)
  - [æ£€æŸ¥æ¸…å•](#æ£€æŸ¥æ¸…å•)
    - [å®Œæ•´æ£€æŸ¥æ¸…å•](#å®Œæ•´æ£€æŸ¥æ¸…å•)
  - [æ¼”ç»ƒé¢‘ç‡ï¼ˆå»ºè®®ï¼‰](#æ¼”ç»ƒé¢‘ç‡å»ºè®®)
    - [æ¼”ç»ƒè„šæœ¬](#æ¼”ç»ƒè„šæœ¬)
  - [äº¤å‰å¼•ç”¨](#äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## åœºæ™¯

ä¸»åº“æ•…éšœï¼Œå¯ç”¨ä»åº“å¹¶å¹³æ»‘æ¢å¤é€»è¾‘è®¢é˜…ã€‚

## æ­¥éª¤ï¼ˆç¤ºæ„ï¼‰

1. åˆ‡ä¸»ï¼šPromote åªè¯»å‰¯æœ¬ï¼›ç¡®è®¤å¤åˆ¶å»¶è¿Ÿ
2. æ›´æ–°è¿æ¥ï¼šåº”ç”¨ä¸è®¢é˜…æŒ‡å‘æ–°ä¸»
3. åˆ·æ–°ï¼š`ALTER SUBSCRIPTION ... REFRESH PUBLICATION`ï¼Œæ ¡éªŒå¤åˆ¶æ§½
4. éªŒè¯ï¼šå»¶è¿Ÿã€å†²çªã€ç¼ºå¤±è¡¨ä¸æƒé™

### 1. æ•…éšœåˆ‡æ¢æµç¨‹

**æ­¥éª¤1: ç¡®è®¤ä¸»åº“æ•…éšœ**:

```bash
# æ£€æŸ¥ä¸»åº“è¿æ¥
psql -h primary_host -U postgres -c "SELECT 1;" || echo "ä¸»åº“ä¸å¯ç”¨"

# æ£€æŸ¥ä¸»åº“æœåŠ¡çŠ¶æ€
systemctl status postgresql@14-main || echo "ä¸»åº“æœåŠ¡åœæ­¢"

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping -c 3 primary_host || echo "ä¸»åº“ç½‘ç»œä¸å¯è¾¾"
```

**æ­¥éª¤2: æ£€æŸ¥ä»åº“çŠ¶æ€**:

```sql
-- æ£€æŸ¥ä»åº“å¤åˆ¶çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    replication_count INT;
BEGIN
    SELECT COUNT(*) INTO replication_count
    FROM pg_stat_replication;

    IF replication_count = 0 THEN
        RAISE WARNING 'æœªæ‰¾åˆ°å¤åˆ¶è¿æ¥';
    ELSE
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªå¤åˆ¶è¿æ¥', replication_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_current_wal_lsnæˆ–pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä»åº“å¤åˆ¶çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as replication_lag_bytes,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) as replication_lag
FROM pg_stat_replication;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- æ£€æŸ¥ä»åº“æ˜¯å¦åœ¨æ¢å¤æ¨¡å¼ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    is_in_recovery BOOLEAN;
BEGIN
    SELECT pg_is_in_recovery() INTO is_in_recovery;
    IF is_in_recovery THEN
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹å¤„äºæ¢å¤æ¨¡å¼ï¼ˆä»åº“ï¼‰';
    ELSE
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹ä¸ºä¸»åº“';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ¢å¤æ¨¡å¼å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result
-- åº”è¯¥è¿”å›: t (trueï¼Œè¡¨ç¤ºæ˜¯ä»åº“)

-- æ£€æŸ¥WALæ¥æ”¶çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_standby BOOLEAN;
BEGIN
    SELECT pg_is_in_recovery() INTO is_standby;
    IF NOT is_standby THEN
        RAISE WARNING 'å½“å‰èŠ‚ç‚¹ä¸æ˜¯ä»åº“ï¼Œæ— æ³•æ£€æŸ¥WALæ¥æ”¶çŠ¶æ€';
        RETURN;
    END IF;

    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥WALæ¥æ”¶çŠ¶æ€';
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'pg_is_in_recoveryã€pg_last_wal_receive_lsnæˆ–pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥WALæ¥æ”¶çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_last_wal_receive_lsn(),
    pg_last_wal_replay_lsn(),
    pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) as lag_bytes;
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result
```

**æ­¥éª¤3: Promoteä»åº“ä¸ºä¸»åº“**:

```bash
# æ–¹æ³•1: ä½¿ç”¨pg_ctl promoteï¼ˆæ¨èï¼‰
pg_ctl -D /var/lib/postgresql/data promote

# æ–¹æ³•2: ä½¿ç”¨SQLå‘½ä»¤
psql -c "SELECT pg_promote();"

# æ–¹æ³•3: åˆ›å»ºpromoteæ–‡ä»¶
touch /var/lib/postgresql/data/promote

# éªŒè¯æå‡æˆåŠŸ
psql -c "SELECT pg_is_in_recovery();"
# åº”è¯¥è¿”å›: f (falseï¼Œè¡¨ç¤ºå·²æå‡ä¸ºä¸»åº“)
```

**æ­¥éª¤4: æ›´æ–°åº”ç”¨è¿æ¥**:

```bash
# æ›´æ–°è¿æ¥å­—ç¬¦ä¸²
# æ—§: postgresql://primary_host:5432/mydb
# æ–°: postgresql://standby_host:5432/mydb

# æ›´æ–°è´Ÿè½½å‡è¡¡é…ç½®
# HAProxyé…ç½®
# server pg1 standby_host:5432 check

# æ›´æ–°DNS
# pg-primary.example.com -> standby_host
```

**æ­¥éª¤5: éªŒè¯æ–°ä¸»åº“åŠŸèƒ½**:

```sql
-- 1. éªŒè¯å¯å†™ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'failover_test'
    ) THEN
        DROP TABLE failover_test;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è¡¨: failover_test';
    END IF;

    CREATE TABLE failover_test (id SERIAL PRIMARY KEY, test_time TIMESTAMP DEFAULT NOW());
    INSERT INTO failover_test DEFAULT VALUES;
    RAISE NOTICE 'è¡¨failover_teståˆ›å»ºå¹¶æ’å…¥æ•°æ®æˆåŠŸ';
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨failover_testå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å¯å†™å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM failover_test;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- 2. éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    order_count BIGINT;
    max_created_at TIMESTAMP;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®å®Œæ•´æ€§éªŒè¯';
        RETURN;
    END IF;

    SELECT COUNT(*), MAX(created_at) INTO order_count, max_created_at
    FROM orders;

    RAISE NOTICE 'è®¢å•æ€»æ•°: %, æœ€æ–°åˆ›å»ºæ—¶é—´: %', order_count, max_created_at;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯æ•°æ®å®Œæ•´æ€§å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT MAX(created_at) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100ms (å–å†³äºè¡¨å¤§å°)
-- è®¡åˆ’: Aggregate

-- 3. éªŒè¯å¤åˆ¶æ§½ï¼ˆå¦‚æœæœ‰ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slot_count INT;
BEGIN
    SELECT COUNT(*) INTO slot_count
    FROM pg_replication_slots;

    IF slot_count = 0 THEN
        RAISE NOTICE 'æœªæ‰¾åˆ°å¤åˆ¶æ§½';
    ELSE
        RAISE NOTICE 'æ‰¾åˆ° % ä¸ªå¤åˆ¶æ§½', slot_count;
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_current_wal_lsnæˆ–pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'éªŒè¯å¤åˆ¶æ§½å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    slot_name,
    slot_type,
    database,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as lag_bytes
FROM pg_replication_slots;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

### 2. é€»è¾‘è®¢é˜…é‡å»º

**æ­¥éª¤1: æ£€æŸ¥è®¢é˜…çŠ¶æ€**:

```sql
-- æ£€æŸ¥è®¢é˜…åˆ—è¡¨
SELECT
    subname,
    subpublications,
    subenabled,
    subslotname
FROM pg_subscription;

-- æ£€æŸ¥è®¢é˜…çŠ¶æ€ï¼ˆéœ€è¦è¿æ¥åˆ°è®¢é˜…æ•°æ®åº“ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_exists BOOLEAN;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) INTO subscription_exists;

    IF NOT subscription_exists THEN
        RAISE WARNING 'è®¢é˜…my_subscriptionä¸å­˜åœ¨';
    ELSE
        RAISE NOTICE 'è®¢é˜…my_subscriptionå­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¢é˜…çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subenabled,
    subslotname,
    subpublications
FROM pg_subscription
WHERE subname = 'my_subscription';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**æ­¥éª¤2: æ›´æ–°è®¢é˜…è¿æ¥**:

```sql
-- æ–¹æ³•1: åˆ é™¤æ—§è®¢é˜…å¹¶åˆ›å»ºæ–°è®¢é˜…ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) THEN
        DROP SUBSCRIPTION my_subscription;
        RAISE NOTICE 'æ—§è®¢é˜…my_subscriptionå·²åˆ é™¤';
    ELSE
        RAISE NOTICE 'è®¢é˜…my_subscriptionä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN dependent_objects_still_exist THEN
        RAISE WARNING 'è®¢é˜…my_subscriptionä»æœ‰ä¾èµ–å¯¹è±¡ï¼Œæ— æ³•åˆ é™¤';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ é™¤è®¢é˜…å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ›å»ºæ–°è®¢é˜…ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) THEN
        RAISE WARNING 'è®¢é˜…my_subscriptionå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_publication WHERE pubname = 'my_publication'
    ) THEN
        RAISE EXCEPTION 'å‘å¸ƒmy_publicationä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    CREATE SUBSCRIPTION my_subscription
    CONNECTION 'host=new_primary port=5432 dbname=mydb user=replication'
    PUBLICATION my_publication
    WITH (
        copy_data = false,  -- å¦‚æœæ•°æ®å·²å­˜åœ¨
        create_slot = true,
        enabled = true
    );
    RAISE NOTICE 'è®¢é˜…my_subscriptionåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING 'è®¢é˜…my_subscriptionå·²å­˜åœ¨';
    WHEN undefined_object THEN
        RAISE EXCEPTION 'å‘å¸ƒmy_publicationä¸å­˜åœ¨';
    WHEN connection_exception THEN
        RAISE EXCEPTION 'æ— æ³•è¿æ¥åˆ°æ–°ä¸»åº“';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ›å»ºè®¢é˜…';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºè®¢é˜…å¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ³•2: åˆ·æ–°è®¢é˜…ï¼ˆPostgreSQL 10+ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) THEN
        RAISE EXCEPTION 'è®¢é˜…my_subscriptionä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°';
    END IF;

    ALTER SUBSCRIPTION my_subscription
    CONNECTION 'host=new_primary port=5432 dbname=mydb user=replication';
    RAISE NOTICE 'è®¢é˜…è¿æ¥å·²æ›´æ–°';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'è®¢é˜…my_subscriptionä¸å­˜åœ¨';
    WHEN connection_exception THEN
        RAISE EXCEPTION 'æ— æ³•è¿æ¥åˆ°æ–°ä¸»åº“';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°è®¢é˜…è¿æ¥å¤±è´¥: %', SQLERRM;
END $$;

-- åˆ·æ–°å‘å¸ƒï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) THEN
        RAISE EXCEPTION 'è®¢é˜…my_subscriptionä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°å‘å¸ƒ';
    END IF;

    ALTER SUBSCRIPTION my_subscription REFRESH PUBLICATION;
    RAISE NOTICE 'è®¢é˜…å‘å¸ƒå·²åˆ·æ–°';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'è®¢é˜…my_subscriptionä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ·æ–°å‘å¸ƒå¤±è´¥: %', SQLERRM;
END $$;
```

**æ­¥éª¤3: éªŒè¯å¤åˆ¶æ§½**:

```sql
-- åœ¨æ–°ä¸»åº“æ£€æŸ¥å¤åˆ¶æ§½ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slot_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_replication_slots'
    ) THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO slot_count
    FROM pg_replication_slots
    WHERE slot_name LIKE '%subscription%';

    IF slot_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè®¢é˜…ç›¸å…³çš„å¤åˆ¶æ§½', slot_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¢é˜…ç›¸å…³çš„å¤åˆ¶æ§½';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å¤åˆ¶æ§½å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    slot_name,
    slot_type,
    database,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as lag_bytes
FROM pg_replication_slots
WHERE slot_name LIKE '%subscription%';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- æ£€æŸ¥æ§½çš„WALä¿ç•™ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_slots INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_replication_slots'
    ) THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO total_slots
    FROM pg_replication_slots;

    IF total_slots > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå¤åˆ¶æ§½', total_slots;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å¤åˆ¶æ§½';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_current_wal_lsnæˆ–pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ§½çš„WALä¿ç•™å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    slot_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as wal_retained
FROM pg_replication_slots;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**æ­¥éª¤4: æ£€æŸ¥è®¢é˜…å»¶è¿Ÿ**:

```sql
-- åœ¨è®¢é˜…ç«¯æ£€æŸ¥å»¶è¿Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription'
    ) THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription_rel'
    ) THEN
        RAISE WARNING 'pg_subscription_relè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO subscription_count
    FROM pg_subscription
    JOIN pg_subscription_rel ON pg_subscription.oid = pg_subscription_rel.srsubid
    WHERE subname = 'my_subscription';

    IF subscription_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡è®¢é˜…å…³ç³»è®°å½•', subscription_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¢é˜…å…³ç³»è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è§†å›¾æˆ–è¡¨ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¢é˜…å»¶è¿Ÿå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subenabled,
    subslotname,
    pg_subscription_rel.substate,
    pg_subscription_rel.srsubstate
FROM pg_subscription
JOIN pg_subscription_rel ON pg_subscription.oid = pg_subscription_rel.srsubid
WHERE subname = 'my_subscription';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Hash Join -> Seq Scan

-- æ£€æŸ¥åº”ç”¨å»¶è¿Ÿï¼ˆéœ€è¦pg_stat_subscriptionï¼ŒPostgreSQL 10+ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stat_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_subscription'
    ) THEN
        RAISE WARNING 'pg_stat_subscriptionè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 10+ï¼‰';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO stat_count
    FROM pg_stat_subscription;

    IF stat_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡è®¢é˜…ç»Ÿè®¡è®°å½•', stat_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¢é˜…ç»Ÿè®¡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_subscriptionè§†å›¾ä¸å­˜åœ¨ï¼ˆéœ€è¦PostgreSQL 10+ï¼‰';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥åº”ç”¨å»¶è¿Ÿå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    apply_lsn,
    sync_lsn,
    pg_wal_lsn_diff(sync_lsn, apply_lsn) as lag_bytes
FROM pg_stat_subscription;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**æ­¥éª¤5: å¤„ç†å†²çªå’Œç¼ºå¤±å¯¹è±¡**:

```sql
-- æ£€æŸ¥å†²çªï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_exists BOOLEAN;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription'
    ) THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT EXISTS(
        SELECT 1 FROM pg_subscription WHERE subname = 'my_subscription'
    ) INTO subscription_exists;

    IF subscription_exists THEN
        RAISE NOTICE 'è®¢é˜…my_subscriptionå­˜åœ¨ï¼Œæ­£åœ¨æ£€æŸ¥å†²çª';
    ELSE
        RAISE WARNING 'è®¢é˜…my_subscriptionä¸å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å†²çªå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subenabled,
    subslotname
FROM pg_subscription
WHERE subname = 'my_subscription';
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- æ£€æŸ¥ç¼ºå¤±è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    missing_table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_tables'
    ) THEN
        RAISE WARNING 'pg_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_publication_tables'
    ) THEN
        RAISE WARNING 'pg_publication_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO missing_table_count
    FROM pg_tables
    WHERE schemaname = 'public'
    AND tablename NOT IN (
        SELECT tablename
        FROM pg_publication_tables
        WHERE pubname = 'my_publication'
    );

    IF missing_table_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç¼ºå¤±çš„è¡¨', missing_table_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç¼ºå¤±çš„è¡¨';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç¼ºå¤±è¡¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename
FROM pg_tables
WHERE schemaname = 'public'
AND tablename NOT IN (
    SELECT tablename
    FROM pg_publication_tables
    WHERE pubname = 'my_publication'
);
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Hash Anti Join -> Seq Scan

-- æ£€æŸ¥ç¼ºå¤±æƒé™ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    permission_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'information_schema' AND table_name = 'role_table_grants'
    ) THEN
        RAISE WARNING 'information_schema.role_table_grantsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO permission_count
    FROM information_schema.role_table_grants
    WHERE table_schema = 'public'
    AND table_name = 'target_table';

    IF permission_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡æƒé™è®°å½•', permission_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æƒé™è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'information_schema.role_table_grantsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç¼ºå¤±æƒé™å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    grantee,
    privilege_type
FROM information_schema.role_table_grants
WHERE table_schema = 'public'
AND table_name = 'target_table';
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

### 3. å®Œæ•´åˆ‡æ¢è„šæœ¬

```bash
#!/bin/bash
# failover_and_subscription_recovery.sh

PRIMARY_HOST="primary.example.com"
STANDBY_HOST="standby.example.com"
DB_NAME="mydb"
SUBSCRIPTION_NAME="my_subscription"
PUBLICATION_NAME="my_publication"

echo "=== æ•…éšœåˆ‡æ¢å¼€å§‹ ==="

# æ­¥éª¤1: ç¡®è®¤ä¸»åº“æ•…éšœ
if ! psql -h ${PRIMARY_HOST} -U postgres -d ${DB_NAME} -c "SELECT 1;" > /dev/null 2>&1; then
    echo "ä¸»åº“ä¸å¯ç”¨ï¼Œå¼€å§‹æ•…éšœåˆ‡æ¢"
else
    echo "ä¸»åº“å¯ç”¨ï¼Œé€€å‡º"
    exit 1
fi

# æ­¥éª¤2: æ£€æŸ¥ä»åº“çŠ¶æ€
REPLICATION_LAG=$(psql -h ${STANDBY_HOST} -U postgres -d ${DB_NAME} -t -c "
    SELECT pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        pg_last_wal_replay_lsn()
    );
")

if [ "${REPLICATION_LAG}" -gt 1073741824 ]; then  # 1GB
    echo "è­¦å‘Šï¼šå¤åˆ¶å»¶è¿Ÿè¶…è¿‡1GB: ${REPLICATION_LAG} bytes"
fi

# æ­¥éª¤3: Promoteä»åº“
echo "æå‡ä»åº“ä¸ºä¸»åº“..."
psql -h ${STANDBY_HOST} -U postgres -d ${DB_NAME} -c "SELECT pg_promote();"

# ç­‰å¾…æå‡å®Œæˆ
sleep 5

# éªŒè¯æå‡
IS_RECOVERY=$(psql -h ${STANDBY_HOST} -U postgres -d ${DB_NAME} -t -c "SELECT pg_is_in_recovery();")
if [ "${IS_RECOVERY}" = "f" ]; then
    echo "ä»åº“å·²æˆåŠŸæå‡ä¸ºä¸»åº“"
else
    echo "é”™è¯¯ï¼šä»åº“æå‡å¤±è´¥"
    exit 1
fi

# æ­¥éª¤4: æ›´æ–°è®¢é˜…
echo "æ›´æ–°é€»è¾‘è®¢é˜…..."
psql -h ${STANDBY_HOST} -U postgres -d ${DB_NAME} <<EOF
ALTER SUBSCRIPTION ${SUBSCRIPTION_NAME}
CONNECTION 'host=${STANDBY_HOST} port=5432 dbname=${DB_NAME} user=replication';

ALTER SUBSCRIPTION ${SUBSCRIPTION_NAME} REFRESH PUBLICATION;
EOF

# æ­¥éª¤5: éªŒè¯
echo "éªŒè¯è®¢é˜…çŠ¶æ€..."
psql -h ${STANDBY_HOST} -U postgres -d ${DB_NAME} -c "
SELECT
    subname,
    subenabled,
    subslotname
FROM pg_subscription
WHERE subname = '${SUBSCRIPTION_NAME}';
"

echo "=== æ•…éšœåˆ‡æ¢å®Œæˆ ==="
```

## æ£€æŸ¥æ¸…å•

- è®¢é˜…çŠ¶æ€ã€å¤åˆ¶æ§½çŠ¶æ€ã€å†²çªä¸é‡æ”¾ã€åº”ç”¨å¯ç”¨æ€§
- å¤åˆ¶å»¶è¿Ÿä¸ç¼ºå¤±å¯¹è±¡æ ¸å¯¹
- åº”ç”¨è¿æ¥æ± åˆ·æ–°ä¸é”™è¯¯ç‡

### å®Œæ•´æ£€æŸ¥æ¸…å•

**åˆ‡æ¢å‰æ£€æŸ¥**:

```sql
-- 1. ä¸»åº“çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_primary BOOLEAN;
    current_lsn PG_LSN;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_is_in_recovery') THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_is_in_recovery() INTO is_primary;
    SELECT pg_current_wal_lsn() INTO current_lsn;

    IF NOT is_primary THEN
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹ä¸ºä¸»åº“ï¼Œå½“å‰WAL LSN: %', current_lsn;
    ELSE
        RAISE WARNING 'å½“å‰èŠ‚ç‚¹ä¸æ˜¯ä¸»åº“ï¼ˆå¤„äºæ¢å¤æ¨¡å¼ï¼‰';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä¸»åº“çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery(), pg_current_wal_lsn();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- 2. ä»åº“çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_standby BOOLEAN;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_is_in_recovery') THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_is_in_recovery() INTO is_standby;
    IF NOT is_standby THEN
        RAISE WARNING 'å½“å‰èŠ‚ç‚¹ä¸æ˜¯ä»åº“ï¼Œæ— æ³•æ£€æŸ¥ä»åº“çŠ¶æ€';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_last_wal_receive_lsn') THEN
        RAISE EXCEPTION 'pg_last_wal_receive_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_last_wal_replay_lsn') THEN
        RAISE EXCEPTION 'pg_last_wal_replay_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥ä»åº“çŠ¶æ€';
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä»åº“çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_is_in_recovery(),
    pg_last_wal_receive_lsn(),
    pg_last_wal_replay_lsn(),
    pg_wal_lsn_diff(pg_current_wal_lsn(), pg_last_wal_replay_lsn()) as lag_bytes;
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- 3. è®¢é˜…çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription'
    ) THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO subscription_count
    FROM pg_subscription;

    IF subscription_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè®¢é˜…', subscription_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¢é˜…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¢é˜…çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subenabled,
    subslotname,
    subpublications
FROM pg_subscription;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan
```

**åˆ‡æ¢åæ£€æŸ¥**:

```sql
-- 1. æ–°ä¸»åº“çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_primary BOOLEAN;
    current_lsn PG_LSN;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_is_in_recovery') THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT pg_is_in_recovery() INTO is_primary;
    SELECT pg_current_wal_lsn() INTO current_lsn;

    IF NOT is_primary THEN
        RAISE NOTICE 'æ–°ä¸»åº“çŠ¶æ€æ­£å¸¸ï¼Œå½“å‰WAL LSN: %', current_lsn;
    ELSE
        RAISE WARNING 'æ–°ä¸»åº“ä»å¤„äºæ¢å¤æ¨¡å¼';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥æ–°ä¸»åº“çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery(), pg_current_wal_lsn();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- 2. è®¢é˜…çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    subscription_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_subscription'
    ) THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO subscription_count
    FROM pg_subscription;

    IF subscription_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè®¢é˜…', subscription_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è®¢é˜…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_subscriptionè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¢é˜…çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    subname,
    subenabled,
    subslotname
FROM pg_subscription;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 3. å¤åˆ¶æ§½çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slot_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_replication_slots'
    ) THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO slot_count
    FROM pg_replication_slots;

    IF slot_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå¤åˆ¶æ§½', slot_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å¤åˆ¶æ§½';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_replication_slotsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å¤åˆ¶æ§½çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    slot_name,
    slot_type,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as lag_bytes
FROM pg_replication_slots;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 4. æ•°æ®ä¸€è‡´æ€§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    order_count BIGINT;
    max_created_at TIMESTAMP;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®ä¸€è‡´æ€§éªŒè¯';
        RETURN;
    END IF;

    SELECT COUNT(*), MAX(created_at) INTO order_count, max_created_at
    FROM orders;

    RAISE NOTICE 'æ•°æ®ä¸€è‡´æ€§éªŒè¯ - è®¢å•æ€»æ•°: %, æœ€æ–°åˆ›å»ºæ—¶é—´: %', order_count, max_created_at;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨å¤§å°ï¼‰
-- è®¡åˆ’: Aggregate

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT MAX(created_at) FROM orders;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨å¤§å°ï¼‰
-- è®¡åˆ’: Aggregate

-- 5. åº”ç”¨è¿æ¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    total_conn INT;
    active_queries INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO total_conn
    FROM pg_stat_activity
    WHERE datname = current_database();

    SELECT COUNT(*) INTO active_queries
    FROM pg_stat_activity
    WHERE datname = current_database() AND state = 'active';

    RAISE NOTICE 'åº”ç”¨è¿æ¥ - æ€»è¿æ¥æ•°: %, æ´»è·ƒæŸ¥è¯¢: %', total_conn, active_queries;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥åº”ç”¨è¿æ¥å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_queries
FROM pg_stat_activity
WHERE datname = current_database();
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Aggregate -> Seq Scan
```

## æ¼”ç»ƒé¢‘ç‡ï¼ˆå»ºè®®ï¼‰

- æœˆåº¦ï¼šåªè¯»å‰¯æœ¬ Promote ä¸å›åˆ‡
- åŒæœˆï¼šè®¢é˜…åˆ·æ–°/é‡å»ºæ¼”ç»ƒ

### æ¼”ç»ƒè„šæœ¬

```bash
#!/bin/bash
# failover_drill.sh

echo "=== æ•…éšœåˆ‡æ¢æ¼”ç»ƒå¼€å§‹ ==="

# 1. è®°å½•å½“å‰çŠ¶æ€
psql -c "SELECT pg_current_wal_lsn();" > /tmp/before_promote_lsn.txt

# 2. æ‰§è¡ŒPromote
psql -c "SELECT pg_promote();"

# 3. éªŒè¯
sleep 5
IS_RECOVERY=$(psql -t -c "SELECT pg_is_in_recovery();")
if [ "${IS_RECOVERY}" = "f" ]; then
    echo "PromoteæˆåŠŸ"
else
    echo "Promoteå¤±è´¥"
    exit 1
fi

# 4. å›åˆ‡ï¼ˆæ¼”ç»ƒåï¼‰
# psql -c "SELECT pg_demote();"  # å¦‚æœæ”¯æŒ

echo "=== æ•…éšœåˆ‡æ¢æ¼”ç»ƒå®Œæˆ ==="
```

---

## äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [é›†ç¾¤ä¸é«˜å¯ç”¨æ¼”ç»ƒSOP](./03-é›†ç¾¤ä¸é«˜å¯ç”¨-æ¼”ç»ƒSOP.md) - å®Œæ•´æ•…éšœåˆ‡æ¢æ¼”ç»ƒæµç¨‹
- â­â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../../11-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„è®¾è®¡
- â­â­ [é€»è¾‘å¤åˆ¶](../../00-å½’æ¡£-é¡¹ç›®ç®¡ç†æ–‡æ¡£/README.md) - é€»è¾‘å¤åˆ¶ç†è®ºåŸºç¡€
- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•
- â­ [å˜æ›´ä¸å›æ»š](./å˜æ›´ä¸å›æ»š.md) - å˜æ›´ç®¡ç†æµç¨‹

### å¤–éƒ¨èµ„æº

- [PostgreSQLæ•…éšœè½¬ç§»æ–‡æ¡£](https://www.postgresql.org/docs/current/high-availability.html)
- [PostgreSQLé€»è¾‘å¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/logical-replication.html)
- [PostgreSQLè®¢é˜…ç®¡ç†](https://www.postgresql.org/docs/current/sql-createsubscription.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
