---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\è¿ç»´æ‰‹å†Œ\02-ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)

---

## ğŸ“‹ ç›®å½•

- [ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç»„ä»¶](#1-ç»„ä»¶)
  - [2. æ­¥éª¤](#2-æ­¥éª¤)
    - [2.1 å®Œæ•´éƒ¨ç½²æ­¥éª¤](#21-å®Œæ•´éƒ¨ç½²æ­¥éª¤)
    - [2.2 å…³é”®æŒ‡æ ‡æŸ¥è¯¢](#22-å…³é”®æŒ‡æ ‡æŸ¥è¯¢)
  - [3. æ—¥å¿—å»ºè®®](#3-æ—¥å¿—å»ºè®®)
  - [4. è¯Šæ–­SQL](#4-è¯Šæ–­sql)
    - [4.1 å®Œæ•´è¯Šæ–­SQLè„šæœ¬](#41-å®Œæ•´è¯Šæ–­sqlè„šæœ¬)
    - [4.2 æ…¢æŸ¥è¯¢åˆ†ææµç¨‹](#42-æ…¢æŸ¥è¯¢åˆ†ææµç¨‹)
  - [5. å‘Šè­¦é—¨æ§›ï¼ˆç¤ºä¾‹ï¼‰](#5-å‘Šè­¦é—¨æ§›ç¤ºä¾‹)
    - [5.1 Prometheuså‘Šè­¦è§„åˆ™](#51-prometheuså‘Šè­¦è§„åˆ™)
    - [5.2 å‘Šè­¦é˜ˆå€¼å»ºè®®](#52-å‘Šè­¦é˜ˆå€¼å»ºè®®)
    - [5.3 å‘Šè­¦é€šçŸ¥é…ç½®](#53-å‘Šè­¦é€šçŸ¥é…ç½®)

---

## 1. ç»„ä»¶

- postgres_exporterã€Prometheusã€Grafanaã€æ—¥å¿—ç®¡é“ï¼ˆFilebeat/Vector â†’ Loki/Elasticï¼‰ã€‚
- å‚è€ƒï¼š`../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md`ã€‚

## 2. æ­¥éª¤

1) åˆ›å»ºç›‘æ§ç”¨æˆ·ï¼š

    ```sql
    CREATE ROLE metrics WITH LOGIN PASSWORD '***';
    GRANT pg_monitor TO metrics;
    -- ç»†ç²’åº¦ï¼šGRANT pg_read_all_stats TO metrics;
    ```

2) å¯åŠ¨ exporterï¼š

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

3) Prometheus æŠ“å–ï¼š

    ```yaml
    scrape_configs:
    - job_name: pg
        scrape_interval: 15s
        static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
    ```

4) Grafana å¯¼å…¥ï¼šè¿æ¥/äº‹åŠ¡ã€å‘½ä¸­ç‡/WALã€æ£€æŸ¥ç‚¹ã€Autovacuumã€é”ç­‰å¾…ã€Top æŸ¥è¯¢ã€‚

### 2.1 å®Œæ•´éƒ¨ç½²æ­¥éª¤

**æ­¥éª¤1: åˆ›å»ºç›‘æ§ç”¨æˆ·å’Œæƒé™**:

```sql
-- åˆ›å»ºç›‘æ§ç”¨æˆ·
CREATE ROLE metrics WITH LOGIN PASSWORD 'your_secure_password';

-- æˆäºˆç›‘æ§æƒé™ï¼ˆPostgreSQL 10+ï¼‰
GRANT pg_monitor TO metrics;

-- æˆ–è€…ç»†ç²’åº¦æƒé™ï¼ˆPostgreSQL 9.6-ï¼‰
GRANT pg_read_all_stats TO metrics;
GRANT pg_read_all_settings TO metrics;

-- å…è®¸è¿æ¥åˆ°æ•°æ®åº“
GRANT CONNECT ON DATABASE postgres TO metrics;

-- éªŒè¯æƒé™
\du metrics
```

**æ­¥éª¤2: å®‰è£…å’Œé…ç½®postgres_exporter**:

```bash
# ä¸‹è½½postgres_exporter
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz
tar -xzf postgres_exporter-0.15.0.linux-amd64.tar.gz
cd postgres_exporter-0.15.0.linux-amd64

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > .env <<EOF
DATA_SOURCE_NAME="postgresql://metrics:your_secure_password@localhost:5432/postgres?sslmode=disable"
EOF

# å¯åŠ¨exporter
./postgres_exporter

# æˆ–ä½¿ç”¨systemdæœåŠ¡
cat > /etc/systemd/system/postgres_exporter.service <<EOF
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
EnvironmentFile=/etc/postgres_exporter/.env
ExecStart=/usr/local/bin/postgres_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable postgres_exporter
systemctl start postgres_exporter
```

**æ­¥éª¤3: é…ç½®Prometheus**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgres'
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'db1:9187'
          - 'db2:9187'
          - 'db3:9187'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'
```

**æ­¥éª¤4: Grafanaä»ªè¡¨æ¿é…ç½®**:

```json
{
  "dashboard": {
    "title": "PostgreSQL Performance",
    "panels": [
      {
        "title": "Connection Count",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
          }
        ]
      },
      {
        "title": "Buffer Hit Ratio",
        "targets": [
          {
            "expr": "100 * (pg_stat_database_blks_hit{datname=\"postgres\"} / (pg_stat_database_blks_hit{datname=\"postgres\"} + pg_stat_database_blks_read{datname=\"postgres\"}))"
          }
        ]
      }
    ]
  }
}
```

### 2.2 å…³é”®æŒ‡æ ‡æŸ¥è¯¢

**PrometheusæŸ¥è¯¢ç¤ºä¾‹**:

```promql
# è¿æ¥æ•°
pg_stat_database_numbackends{datname="postgres"}

# ç¼“å†²åŒºå‘½ä¸­ç‡
100 * (pg_stat_database_blks_hit{datname="postgres"} /
       (pg_stat_database_blks_hit{datname="postgres"} +
        pg_stat_database_blks_read{datname="postgres"}))

# äº‹åŠ¡æäº¤ç‡
rate(pg_stat_database_xact_commit{datname="postgres"}[5m])

# WALå†™å…¥é€Ÿç‡
rate(pg_stat_wal_wal_bytes[5m])

# æ£€æŸ¥ç‚¹é¢‘ç‡
rate(pg_stat_bgwriter_checkpoints_timed[5m]) +
rate(pg_stat_bgwriter_checkpoints_req[5m])

# æ…¢æŸ¥è¯¢æ•°ï¼ˆéœ€è¦pg_stat_statementsï¼‰
rate(pg_stat_statements_calls{mean_exec_time > 1000}[5m])

# é”ç­‰å¾…æ•°
pg_locks_granted{locktype="relation"} - pg_locks_granted{locktype="relation",granted="true"}
```

## 3. æ—¥å¿—å»ºè®®

```text
log_line_prefix = '%m [%p] %u@%d %r %a '
log_min_duration_statement = 500ms
log_checkpoints = on
log_autovacuum_min_duration = 1s
log_lock_waits = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

## 4. è¯Šæ–­SQL

- è§ `sql/diagnostics.sql`ï¼›æ…¢SQLé¢æ¿ TopN ä¸ EXPLAIN ç»“åˆã€‚

### 4.1 å®Œæ•´è¯Šæ–­SQLè„šæœ¬

**æ–‡ä»¶**: `sql/diagnostics.sql`

```sql
-- ============================================
-- PostgreSQL å®Œæ•´è¯Šæ–­è„šæœ¬
-- ============================================

-- 1. ç³»ç»Ÿæ¦‚è§ˆ
SELECT
    version() as pg_version,
    pg_size_pretty(pg_database_size(current_database())) as db_size,
    (SELECT count(*) FROM pg_stat_activity WHERE state != 'idle') as active_connections,
    (SELECT setting FROM pg_settings WHERE name = 'max_connections')::integer as max_connections;

-- 2. å½“å‰æ´»è·ƒä¼šè¯
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    wait_event_type,
    wait_event,
    query_start,
    state_change,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

-- 3. ç­‰å¾…äº‹ä»¶ç»Ÿè®¡
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- 4. é”ç­‰å¾…æƒ…å†µ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    blocked_locks.locktype,
    blocked_locks.mode
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 5. Top 10 æ…¢æŸ¥è¯¢ï¼ˆéœ€è¦pg_stat_statementsæ‰©å±•ï¼‰
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    round(mean_exec_time::numeric, 2) as mean_ms,
    round(max_exec_time::numeric, 2) as max_ms,
    round(total_exec_time::numeric, 2) as total_ms,
    round((100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0))::numeric, 2) as hit_ratio,
    rows
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 6. ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    datname,
    round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2) as hit_ratio,
    sum(blks_hit) as blks_hit,
    sum(blks_read) as blks_read
FROM pg_stat_database
GROUP BY datname
ORDER BY hit_ratio;

-- 7. è¡¨æ‰«æç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    round(100.0 * idx_scan / NULLIF(seq_scan + idx_scan, 0), 2) as idx_scan_ratio,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE seq_scan + idx_scan > 0
ORDER BY seq_scan DESC
LIMIT 20;

-- 8. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as index_size,
    CASE
        WHEN idx_scan = 0 THEN 'UNUSED'
        WHEN idx_tup_read / NULLIF(idx_scan, 0) > 10000 THEN 'INEFFICIENT'
        ELSE 'EFFICIENT'
    END as status
FROM pg_stat_user_indexes
WHERE pg_relation_size(indexname::regclass) > 1000000  -- å¤§äº1MB
ORDER BY idx_scan DESC;

-- 9. WALå’Œæ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT
    checkpoints_timed,
    checkpoints_req,
    round((checkpoint_write_time + checkpoint_sync_time) / 1000.0, 2) as total_checkpoint_time_sec,
    round(extract(epoch from now() - stats_reset) / NULLIF(checkpoints_timed + checkpoints_req, 0) / 60, 2) as avg_interval_minutes,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend
FROM pg_stat_bgwriter;

-- 10. AutovacuumçŠ¶æ€
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    CASE
        WHEN last_vacuum IS NULL AND last_autovacuum IS NULL THEN 'Never vacuumed'
        WHEN last_vacuum > last_autovacuum THEN last_vacuum::text
        ELSE last_autovacuum::text
    END as last_vacuum_time
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;
```

### 4.2 æ…¢æŸ¥è¯¢åˆ†ææµç¨‹

```sql
-- æ­¥éª¤1: è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT
    queryid,
    LEFT(query, 200) as query_preview,
    calls,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´>100ms
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æ­¥éª¤2: è·å–å®Œæ•´æŸ¥è¯¢ï¼ˆä½¿ç”¨queryidï¼‰
SELECT query
FROM pg_stat_statements
WHERE queryid = <queryid_from_step1>;

-- æ­¥éª¤3: æ‰§è¡ŒEXPLAINåˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE, TIMING)
<query_from_step2>;

-- æ­¥éª¤4: åˆ†ææ‰§è¡Œè®¡åˆ’
-- æ£€æŸ¥ï¼š
-- - Seq Scan: è€ƒè™‘åˆ›å»ºç´¢å¼•
-- - é«˜cost: è€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢
-- - é«˜buffers: è€ƒè™‘å¢åŠ shared_buffers
-- - é«˜execution time: è€ƒè™‘æŸ¥è¯¢é‡å†™
```

## 5. å‘Šè­¦é—¨æ§›ï¼ˆç¤ºä¾‹ï¼‰

- è¿æ¥ä½¿ç”¨ç‡ > 80%ï¼›ç¼“å†²å‘½ä¸­ç‡ < 95%ï¼›WAL é€Ÿç‡éª¤å¢ï¼›æ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹ï¼›Autovacuum æ»åï¼›æ­»é”äº‹ä»¶ã€‚

### 5.1 Prometheuså‘Šè­¦è§„åˆ™

**æ–‡ä»¶**: `alerts/postgresql_alerts.yml`

```yaml
groups:
  - name: postgresql
    interval: 30s
    rules:
      # è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: (pg_stat_database_numbackends{datname="postgres"} /
               pg_settings_max_connections{name="max_connections"}) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"
          description: "æ•°æ®åº“è¿æ¥æ•°ä½¿ç”¨ç‡è¶…è¿‡80%: {{ $value | humanizePercentage }}"

      # ç¼“å†²åŒºå‘½ä¸­ç‡å‘Šè­¦
      - alert: PostgreSQLLowBufferHitRatio
        expr: 100 * (pg_stat_database_blks_hit{datname="postgres"} /
                      (pg_stat_database_blks_hit{datname="postgres"} +
                       pg_stat_database_blks_read{datname="postgres"})) < 95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç¼“å†²åŒºå‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å†²åŒºå‘½ä¸­ç‡ä½äº95%: {{ $value }}%"

      # WALé€Ÿç‡å‘Šè­¦
      - alert: PostgreSQLHighWALRate
        expr: rate(pg_stat_wal_wal_bytes[5m]) > 100000000  # 100MB/s
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WALå†™å…¥é€Ÿç‡è¿‡é«˜"
          description: "WALå†™å…¥é€Ÿç‡: {{ $value | humanize }}B/s"

      # æ£€æŸ¥ç‚¹é¢‘ç‡å‘Šè­¦
      - alert: PostgreSQLFrequentCheckpoints
        expr: (rate(pg_stat_bgwriter_checkpoints_timed[5m]) +
               rate(pg_stat_bgwriter_checkpoints_req[5m])) > 0.1  # æ¯10åˆ†é’Ÿä¸€æ¬¡
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹"
          description: "æ£€æŸ¥ç‚¹é¢‘ç‡: {{ $value }}æ¬¡/ç§’"

      # é”ç­‰å¾…å‘Šè­¦
      - alert: PostgreSQLLockWaits
        expr: pg_locks_not_granted > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLé”ç­‰å¾…è¿‡å¤š"
          description: "æœªæˆäºˆçš„é”æ•°é‡: {{ $value }}"

      # æ­»é”å‘Šè­¦
      - alert: PostgreSQLDeadlocks
        expr: increase(pg_stat_database_deadlocks{datname="postgres"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLæ£€æµ‹åˆ°æ­»é”"
          description: "æ•°æ®åº“å‘ç”Ÿæ­»é”äº‹ä»¶"

      # Autovacuumæ»åå‘Šè­¦
      - alert: PostgreSQLAutovacuumLag
        expr: (pg_stat_user_tables_n_dead_tup /
               NULLIF(pg_stat_user_tables_n_live_tup, 0)) > 0.2
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL Autovacuumæ»å"
          description: "è¡¨ {{ $labels.schemaname }}.{{ $labels.relname }} æ­»å…ƒç»„æ¯”ä¾‹è¶…è¿‡20%"

      # æ…¢æŸ¥è¯¢å‘Šè­¦
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_calls{mean_exec_time > 1000}[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢è¿‡å¤š"
          description: "å¹³å‡æ‰§è¡Œæ—¶é—´>1ç§’çš„æŸ¥è¯¢è°ƒç”¨é¢‘ç‡: {{ $value }}æ¬¡/ç§’"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦ï¼ˆæµå¤åˆ¶åœºæ™¯ï¼‰
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 10485760  # 10MB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
          description: "å¤åˆ¶å»¶è¿Ÿ: {{ $value | humanize }}B"
```

### 5.2 å‘Šè­¦é˜ˆå€¼å»ºè®®

**å‘Šè­¦é˜ˆå€¼è¡¨**:

| æŒ‡æ ‡ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| è¿æ¥ä½¿ç”¨ç‡ | >80% | >95% | æ¥è¿‘æœ€å¤§è¿æ¥æ•° |
| ç¼“å†²åŒºå‘½ä¸­ç‡ | <95% | <90% | I/Oæ€§èƒ½ä¸‹é™ |
| WALå†™å…¥é€Ÿç‡ | >100MB/s | >500MB/s | å†™å…¥è´Ÿè½½è¿‡é«˜ |
| æ£€æŸ¥ç‚¹é¢‘ç‡ | >0.1æ¬¡/ç§’ | >0.2æ¬¡/ç§’ | æ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹ |
| é”ç­‰å¾…æ•° | >10 | >50 | å¹¶å‘å†²çª |
| æ­»é”äº‹ä»¶ | >0 | >0 | ç«‹å³å‘Šè­¦ |
| æ­»å…ƒç»„æ¯”ä¾‹ | >20% | >40% | Autovacuumæ»å |
| æ…¢æŸ¥è¯¢é¢‘ç‡ | >10æ¬¡/ç§’ | >50æ¬¡/ç§’ | æŸ¥è¯¢æ€§èƒ½é—®é¢˜ |

### 5.3 å‘Šè­¦é€šçŸ¥é…ç½®

**Alertmanageré…ç½®ç¤ºä¾‹**:

```yaml
# alertmanager.yml
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        severity: warning
      receiver: 'warning-alerts'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alert-receiver:9093/webhook'

  - name: 'critical-alerts'
    email_configs:
      - to: 'dba-team@example.com'
        subject: 'PostgreSQL Critical Alert: {{ .GroupLabels.alertname }}'
    webhook_configs:
      - url: 'http://alert-receiver:9093/webhook'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
        channel: '#postgresql-alerts'
        title: 'PostgreSQL Critical Alert'
        text: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.description }}'

  - name: 'warning-alerts'
    email_configs:
      - to: 'dba-team@example.com'
        subject: 'PostgreSQL Warning: {{ .GroupLabels.alertname }}'
```
