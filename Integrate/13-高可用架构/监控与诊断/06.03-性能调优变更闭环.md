---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\ç›‘æ§ä¸è¯Šæ–­\30-æ€§èƒ½è°ƒä¼˜/README.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½æ–‡æ¡£ï¼š`../../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md`ã€`./06.01-ç›‘æ§ä¸è¯Šæ–­.md`

---

## ğŸ“‹ ç›®å½•

- [æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯ï¼ˆRunbookï¼‰](#æ€§èƒ½è°ƒä¼˜-å˜æ›´é—­ç¯runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. å‰ç½®æ£€æŸ¥](#2-å‰ç½®æ£€æŸ¥)
    - [2.1 ä¸šåŠ¡çª—å£ç¡®è®¤](#21-ä¸šåŠ¡çª—å£ç¡®è®¤)
    - [2.2 å¤‡ä»½å‡†å¤‡](#22-å¤‡ä»½å‡†å¤‡)
    - [2.3 æŒ‡æ ‡é¢æ¿å‡†å¤‡](#23-æŒ‡æ ‡é¢æ¿å‡†å¤‡)
  - [3. è¯Šæ–­å…¥å£](#3-è¯Šæ–­å…¥å£)
    - [3.1 è¯Šæ–­SQLè„šæœ¬](#31-è¯Šæ–­sqlè„šæœ¬)
    - [3.2 æ‰§è¡Œè®¡åˆ’åˆ†æ](#32-æ‰§è¡Œè®¡åˆ’åˆ†æ)
  - [4. å˜æ›´ç¥¨æ®æ¨¡æ¿](#4-å˜æ›´ç¥¨æ®æ¨¡æ¿)
    - [4.1 å˜æ›´è®°å½•è¡¨](#41-å˜æ›´è®°å½•è¡¨)
  - [5. æ‰§è¡Œæ­¥éª¤](#5-æ‰§è¡Œæ­¥éª¤)
    - [5.1 å˜æ›´å‰å®¡è®¡è„šæœ¬](#51-å˜æ›´å‰å®¡è®¡è„šæœ¬)
    - [5.2 å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬](#52-å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬)
    - [5.3 ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬](#53-ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬)
    - [5.4 è§‚å¯ŸæœŸç›‘æ§è„šæœ¬](#54-è§‚å¯ŸæœŸç›‘æ§è„šæœ¬)
  - [6. å¸¸ç”¨å‚æ•°å»ºè®®ï¼ˆæ‘˜ï¼‰](#6-å¸¸ç”¨å‚æ•°å»ºè®®æ‘˜)
    - [6.1 å‚æ•°æ¨èé…ç½®](#61-å‚æ•°æ¨èé…ç½®)
  - [7. éªŒè¯æ¸…å•](#7-éªŒè¯æ¸…å•)
    - [7.1 æ€§èƒ½å¯¹æ¯”è„šæœ¬](#71-æ€§èƒ½å¯¹æ¯”è„šæœ¬)
    - [7.2 éªŒè¯æ ‡å‡†](#72-éªŒè¯æ ‡å‡†)
  - [8. å›æ»šä¸å¤ç›˜](#8-å›æ»šä¸å¤ç›˜)
    - [8.1 å›æ»šè„šæœ¬](#81-å›æ»šè„šæœ¬)
    - [8.2 å¤ç›˜è®°å½•](#82-å¤ç›˜è®°å½•)

---

## 1. ç›®æ ‡

- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä»¥æœ€å°é£é™©å®Œæˆå‚æ•°/SQL/ç»“æ„ä¼˜åŒ–ï¼Œå½¢æˆ"ç›‘æµ‹â†’è¯Šæ–­â†’å®šä½â†’å˜æ›´â†’éªŒè¯â†’å›æ»š/å›ºåŒ–"çš„é—­ç¯ã€‚
- å¯¹é½æ–‡æ¡£ï¼š`../../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md`ã€`./06.01-ç›‘æ§ä¸è¯Šæ–­.md`ã€‚

## 2. å‰ç½®æ£€æŸ¥

- ä¸šåŠ¡çª—å£ï¼šç¡®è®¤ç°åº¦èŒƒå›´ä¸ä½å³°æ—¶æ®µï¼›
- å¤‡ä»½/å›æ»šï¼šé…ç½®å¤‡ä»½ç‚¹/å¿«ç…§ï¼›å‡†å¤‡å›æ»šè„šæœ¬ï¼ˆå‚æ•°æ—§å€¼ã€DDL å›æ»šæ–¹æ¡ˆï¼‰ã€‚
- æŒ‡æ ‡é¢æ¿ï¼šP95/P99ã€TPS/QPSã€å‘½ä¸­ç‡ã€WAL é€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€é”ç­‰å¾…ã€Autovacuum æ»åã€‚

### 2.1 ä¸šåŠ¡çª—å£ç¡®è®¤

```bash
# æ£€æŸ¥å½“å‰ä¸šåŠ¡è´Ÿè½½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
psql -c "
DO \$\$
DECLARE
    activity_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO activity_count
    FROM pg_stat_activity
    WHERE datname = current_database();

    IF activity_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå½“å‰æ•°æ®åº“çš„æ´»åŠ¨è¿æ¥', activity_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ´»åŠ¨è¿æ¥';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä¸šåŠ¡è´Ÿè½½å¤±è´¥: %', SQLERRM;
END \$\$;

SELECT
    date_trunc('hour', now()) as hour,
    COUNT(*) as active_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_queries
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY 1
ORDER BY 1 DESC
LIMIT 24;
"

# ç¡®è®¤ä½å³°æ—¶æ®µï¼ˆç¤ºä¾‹ï¼šå‡Œæ™¨2-6ç‚¹ï¼‰
LOW_TRAFFIC_WINDOW="02:00-06:00"
```

### 2.2 å¤‡ä»½å‡†å¤‡

```bash
# 1. åˆ›å»ºå‚æ•°å¤‡ä»½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
psql -c "
DO \$\$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_settings'
    ) THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;
    RAISE NOTICE 'æ­£åœ¨å¤‡ä»½å‚æ•°é…ç½®';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‚æ•°å¤‡ä»½å¤±è´¥: %', SQLERRM;
END \$\$;

SELECT name, setting, source
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'max_connections')
ORDER BY name;
" > /tmp/pg_params_backup_$(date +%Y%m%d_%H%M%S).txt

# 2. åˆ›å»ºé…ç½®å¤‡ä»½
cp $PGDATA/postgresql.conf $PGDATA/postgresql.conf.backup_$(date +%Y%m%d_%H%M%S)

# 3. åˆ›å»ºæ‰§è¡Œè®¡åˆ’åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
psql -c "
DO \$\$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;
    RAISE NOTICE 'æ­£åœ¨åˆ›å»ºæ‰§è¡Œè®¡åˆ’åŸºçº¿';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ‰§è¡Œè®¡åˆ’åŸºçº¿å¤±è´¥: %', SQLERRM;
END \$\$;

SELECT queryid, query, plan
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
" > /tmp/query_plans_baseline_$(date +%Y%m%d_%H%M%S).txt
```

### 2.3 æŒ‡æ ‡é¢æ¿å‡†å¤‡

```sql
-- åˆ›å»ºæ€§èƒ½åŸºçº¿è§†å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'performance_baseline'
    ) THEN
        DROP VIEW performance_baseline;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰è§†å›¾performance_baseline';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ é™¤ç°æœ‰è§†å›¾å¤±è´¥: %', SQLERRM;
END $$;

CREATE OR REPLACE VIEW performance_baseline AS
-- åˆ›å»ºæ€§èƒ½åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    baseline_time TIMESTAMP;
    active_queries INT;
    total_exec_time NUMERIC;
    cache_hit_ratio NUMERIC;
    waiting_queries INT;
BEGIN
    baseline_time := NOW();

    SELECT COUNT(*) INTO active_queries
    FROM pg_stat_activity
    WHERE state = 'active';

    SELECT COALESCE(SUM(total_exec_time), 0) INTO total_exec_time
    FROM pg_stat_statements;

    SELECT COALESCE(
        SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100,
        0
    ) INTO cache_hit_ratio
    FROM pg_stat_database
    WHERE datname = current_database();

    SELECT COUNT(*) INTO waiting_queries
    FROM pg_stat_activity
    WHERE wait_event_type IS NOT NULL;

    RAISE NOTICE 'æ€§èƒ½åŸºçº¿: æ´»è·ƒæŸ¥è¯¢=%, æ€»æ‰§è¡Œæ—¶é—´=%, ç¼“å­˜å‘½ä¸­ç‡=%, ç­‰å¾…æŸ¥è¯¢=%',
        active_queries, total_exec_time, cache_hit_ratio, waiting_queries;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityæˆ–pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'current_databaseå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ€§èƒ½åŸºçº¿å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    NOW() as baseline_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries,
    (SELECT SUM(total_exec_time) FROM pg_stat_statements) as total_exec_time,
    (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
     FROM pg_stat_database WHERE datname = current_database()) as cache_hit_ratio,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type IS NOT NULL) as waiting_queries;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: SubPlan

-- è®°å½•åŸºçº¿ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_baseline'
    ) THEN
        RAISE EXCEPTION 'è¡¨performance_baselineä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    INSERT INTO performance_baseline
    SELECT * FROM performance_baseline
    LIMIT 0;  -- ä»…å¤åˆ¶ç»“æ„ï¼Œä¸å¤åˆ¶æ•°æ®

    RAISE NOTICE 'æ€§èƒ½åŸºçº¿è®°å½•å®Œæˆ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨performance_baselineä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•åŸºçº¿å¤±è´¥: %', SQLERRM;
END $$;
```

## 3. è¯Šæ–­å…¥å£

1) æ…¢æŸ¥è¯¢/ååä¸‹é™/å»¶è¿Ÿå‡é«˜å‘Šè­¦è§¦å‘ï¼›
2) æ‰§è¡Œ `sql/diagnostics.sql` ä¸­ TopN + ç­‰å¾…äº‹ä»¶ï¼›
3) å¯¹ç–‘ä¼¼è¯­å¥ `EXPLAIN (ANALYZE, BUFFERS, TIMING)`ï¼›
4) è¯„ä¼°ç­–ç•¥ï¼šç´¢å¼•/ç»Ÿè®¡/SQL/å‚æ•°/æ¶æ„ã€‚

### 3.1 è¯Šæ–­SQLè„šæœ¬

```sql
-- diagnostics.sql

-- 1. Top 10 æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slow_query_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements
    WHERE total_exec_time > 1000;

    IF slow_query_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªæ…¢æŸ¥è¯¢ï¼ˆæ€»æ‰§è¡Œæ—¶é—´>1ç§’ï¼‰', slow_query_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ…¢æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 2. ç­‰å¾…äº‹ä»¶åˆ†å¸ƒï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    wait_event_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO wait_event_count
    FROM pg_stat_activity
    WHERE wait_event_type IS NOT NULL;

    RAISE NOTICE 'ç­‰å¾…äº‹ä»¶æ•°: %', wait_event_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢ç­‰å¾…äº‹ä»¶åˆ†å¸ƒå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: GroupAggregate -> Seq Scan

-- 3. é”ç­‰å¾…æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    lock_wait_count INT;
BEGIN
    SELECT COUNT(*) INTO lock_wait_count
    FROM pg_catalog.pg_locks blocked_locks
    WHERE NOT blocked_locks.granted;

    IF lock_wait_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªé”ç­‰å¾…', lock_wait_count;
    ELSE
        RAISE NOTICE 'æ— é”ç­‰å¾…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_locksæˆ–pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢é”ç­‰å¾…æƒ…å†µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Nested Loop -> Hash Join

-- 4. è¡¨è†¨èƒ€æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    bloated_table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO bloated_table_count
    FROM pg_stat_user_tables
    WHERE n_dead_tup > 1000;

    IF bloated_table_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªè¡¨å­˜åœ¨è†¨èƒ€ï¼ˆæ­»å…ƒç»„>1000ï¼‰', bloated_table_count;
    ELSE
        RAISE NOTICE 'æ— è¡¨è†¨èƒ€é—®é¢˜';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢è¡¨è†¨èƒ€æƒ…å†µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_live_tup,
    n_dead_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <200ms
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 5. ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    unused_index_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO unused_index_count
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public' AND idx_scan = 0;

    IF unused_index_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªæœªä½¿ç”¨çš„ç´¢å¼•ï¼ˆæ‰«ææ¬¡æ•°=0ï¼‰', unused_index_count;
    ELSE
        RAISE NOTICE 'æ— æœªä½¿ç”¨çš„ç´¢å¼•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æŸ¥è¯¢ç´¢å¼•ä½¿ç”¨æƒ…å†µå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

### 3.2 æ‰§è¡Œè®¡åˆ’åˆ†æ

```sql
-- å¯¹æ…¢æŸ¥è¯¢æ‰§è¡Œè¯¦ç»†åˆ†æï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
-- æ³¨æ„ï¼šéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„æ…¢æŸ¥è¯¢SQL
DO $$
BEGIN
    RAISE NOTICE 'è¯·æ›¿æ¢ä¸ºå®é™…çš„æ…¢æŸ¥è¯¢SQLï¼Œç„¶åæ‰§è¡ŒEXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)';
    RAISE NOTICE 'ç¤ºä¾‹: EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING) SELECT * FROM orders WHERE ...';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ‰§è¡Œè®¡åˆ’åˆ†æè¯´æ˜å¤±è´¥: %', SQLERRM;
END $$;

-- EXPLAIN (ANALYZE, BUFFERS, VERBOSE, COSTS, TIMING)
-- SELECT /* æ…¢æŸ¥è¯¢SQL */;

-- æ£€æŸ¥è®¡åˆ’ç¼“å­˜ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    plan_change_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO plan_change_count
    FROM pg_stat_statements
    WHERE plans > 1;

    IF plan_change_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªæŸ¥è¯¢å­˜åœ¨è®¡åˆ’å˜åŒ–ï¼ˆplans>1ï¼‰', plan_change_count;
    ELSE
        RAISE NOTICE 'æ— è®¡åˆ’å˜åŒ–';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥è®¡åˆ’ç¼“å­˜å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    plans,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
WHERE plans > 1
ORDER BY plans DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

## 4. å˜æ›´ç¥¨æ®æ¨¡æ¿

```text
å˜æ›´é¡¹ï¼š<å‚æ•°/SQL/ç´¢å¼•/ç»“æ„>
å¯¹è±¡/èŒƒå›´ï¼š<åº“/è¡¨/ç´¢å¼•/æœåŠ¡>
æ—§å€¼â†’æ–°å€¼ï¼š<ä»> â†’ <åˆ°>
é¢„æœŸå½±å“ï¼š<å»¶è¿Ÿ/åå/èµ„æº>
éªŒè¯çª—å£ï¼š<èµ·æ­¢æ—¶é—´/ç°åº¦æ¯”ä¾‹>
å›æ»šæ¡ä»¶ï¼š<P95 æ¶åŒ–>10% / é”™è¯¯ç‡å‡ / é”å†²çªå‡>
è´Ÿè´£äºº/å®¡æ‰¹ï¼š<Owner/Reviewer>
```

### 4.1 å˜æ›´è®°å½•è¡¨

```sql
-- åˆ›å»ºå˜æ›´è®°å½•è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_change_log'
    ) THEN
        CREATE TABLE performance_change_log (
            change_id SERIAL PRIMARY KEY,
            change_time TIMESTAMP DEFAULT NOW(),
            change_type VARCHAR(50),  -- 'parameter', 'index', 'sql', 'structure'
            change_target TEXT,
            old_value TEXT,
            new_value TEXT,
            change_by VARCHAR(100),
            expected_impact TEXT,
            verification_window TEXT,
            rollback_condition TEXT,
            change_status VARCHAR(20),  -- 'pending', 'in_progress', 'completed', 'rolled_back'
            actual_impact TEXT,
            notes TEXT
        );
        RAISE NOTICE 'è¡¨performance_change_logåˆ›å»ºæˆåŠŸ';
    ELSE
        RAISE NOTICE 'è¡¨performance_change_logå·²å­˜åœ¨';
    END IF;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE WARNING 'è¡¨performance_change_logå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå˜æ›´è®°å½•è¡¨å¤±è´¥: %', SQLERRM;
END $$;

-- è®°å½•å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_change_log'
    ) THEN
        RAISE EXCEPTION 'è¡¨performance_change_logä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    INSERT INTO performance_change_log (
        change_type,
        change_target,
        old_value,
        new_value,
        change_by,
        expected_impact,
        verification_window,
        rollback_condition
    )
    VALUES (
        'parameter',
        'shared_buffers',
        '256MB',
        '512MB',
        'dba_user',
        'æé«˜ç¼“å­˜å‘½ä¸­ç‡5-10%',
        '2025-11-22 02:00 - 06:00',
        'P95å»¶è¿Ÿå¢åŠ >10%æˆ–é”™è¯¯ç‡ä¸Šå‡'
    );

    RAISE NOTICE 'å˜æ›´è®°å½•æ’å…¥æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨performance_change_logä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    WHEN check_violation THEN
        RAISE WARNING 'å˜æ›´è®°å½•æ•°æ®è¿åçº¦æŸ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®°å½•å˜æ›´å¤±è´¥: %', SQLERRM;
END $$;
```

## 5. æ‰§è¡Œæ­¥éª¤

1) å»ºç«‹å®¡è®¡ï¼šè®°å½•å‚æ•°æ—§å€¼ï¼ˆ`SHOW`/`pg_file_settings`ï¼‰ä¸è®¡åˆ’åŸºçº¿ï¼›
2) å•å˜é‡å°æ­¥å˜æ›´ï¼›
3) è§‚å¯Ÿ 15â€“30 åˆ†é’Ÿç¨³å®šçª—å£ï¼›
4) è¾¾æ ‡åˆ™å›ºåŒ–ä¸æ–‡æ¡£åŒ–ï¼›ä¸è¾¾æ ‡åˆ™å›æ»šã€‚

### 5.1 å˜æ›´å‰å®¡è®¡è„šæœ¬

```sql
-- è®°å½•å½“å‰å‚æ•°å€¼
SELECT
    name,
    setting,
    unit,
    source,
    sourcefile,
    sourceline
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'max_connections')
ORDER BY name;

-- è®°å½•æ€§èƒ½åŸºçº¿
INSERT INTO performance_baseline
SELECT * FROM performance_baseline;

-- è®°å½•æŸ¥è¯¢è®¡åˆ’åŸºçº¿
SELECT
    queryid,
    query,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_exec_time DESC
LIMIT 20;
```

### 5.2 å‚æ•°å˜æ›´æ‰§è¡Œè„šæœ¬

```sql
-- æ–¹æ³•1: ALTER SYSTEM SETï¼ˆéœ€è¦é‡å¯æˆ–reloadï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_reload_conf') THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    ALTER SYSTEM SET shared_buffers = '512MB';
    PERFORM pg_reload_conf();  -- ä»…å¯¹éƒ¨åˆ†å‚æ•°ç”Ÿæ•ˆ
    RAISE NOTICE 'å‚æ•°shared_bufferså·²è®¾ç½®ä¸º512MBå¹¶é‡æ–°åŠ è½½é…ç½®';
EXCEPTION
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿå‚æ•°';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆ: shared_buffers = 512MB';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ALTER SYSTEM SETå¤±è´¥: %', SQLERRM;
END $$;

-- æ–¹æ³•2: ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å¯ï¼‰
-- ç¼–è¾‘ postgresql.conf
-- shared_buffers = 512MB
-- æ³¨æ„ï¼šæ­¤æ–¹æ³•éœ€è¦æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶å¹¶é‡å¯PostgreSQL

-- æ–¹æ³•3: ä¼šè¯çº§è®¾ç½®ï¼ˆä»…å½“å‰ä¼šè¯ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    SET work_mem = '64MB';
    RAISE NOTICE 'ä¼šè¯çº§å‚æ•°work_memå·²è®¾ç½®ä¸º64MBï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰';
EXCEPTION
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆ: work_mem = 64MB';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'SET work_memå¤±è´¥: %', SQLERRM;
END $$;

-- éªŒè¯å˜æ›´ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    shared_buffers_val TEXT;
BEGIN
    SHOW shared_buffers INTO shared_buffers_val;
    RAISE NOTICE 'å½“å‰shared_bufferså€¼: %', shared_buffers_val;
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'æ— æ³•è·å–shared_bufferså€¼: %', SQLERRM;
END $$;
```

### 5.3 ç´¢å¼•å˜æ›´æ‰§è¡Œè„šæœ¬

```sql
-- åœ¨çº¿åˆ›å»ºç´¢å¼•ï¼ˆä¸é˜»å¡å†™æ“ä½œï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders' AND indexname = 'idx_orders_created_at'
    ) THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_created_atå·²å­˜åœ¨';
        RETURN;
    END IF;

    CREATE INDEX CONCURRENTLY idx_orders_created_at ON orders(created_at);
    RAISE NOTICE 'ç´¢å¼•idx_orders_created_atåˆ›å»ºæˆåŠŸï¼ˆåœ¨çº¿åˆ›å»ºï¼Œä¸é˜»å¡å†™æ“ä½œï¼‰';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_created_atå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- åœ¨çº¿åˆ é™¤ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders' AND indexname = 'idx_orders_old'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_oldä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤';
        RETURN;
    END IF;

    DROP INDEX CONCURRENTLY IF EXISTS idx_orders_old;
    RAISE NOTICE 'ç´¢å¼•idx_orders_oldåˆ é™¤æˆåŠŸï¼ˆåœ¨çº¿åˆ é™¤ï¼Œä¸é˜»å¡å†™æ“ä½œï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'åˆ é™¤ç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- é‡å»ºç´¢å¼•ï¼ˆåœ¨çº¿ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders' AND indexname = 'idx_orders_created_at'
    ) THEN
        RAISE EXCEPTION 'ç´¢å¼•idx_orders_created_atä¸å­˜åœ¨ï¼Œæ— æ³•é‡å»º';
    END IF;

    REINDEX INDEX CONCURRENTLY idx_orders_created_at;
    RAISE NOTICE 'ç´¢å¼•idx_orders_created_até‡å»ºæˆåŠŸï¼ˆåœ¨çº¿é‡å»ºï¼Œä¸é˜»å¡å†™æ“ä½œï¼‰';
EXCEPTION
    WHEN undefined_object THEN
        RAISE EXCEPTION 'ç´¢å¼•idx_orders_created_atä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é‡å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;
```

### 5.4 è§‚å¯ŸæœŸç›‘æ§è„šæœ¬

```sql
-- å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    active_query_count INT;
    avg_query_time_val NUMERIC;
    cache_hit_ratio_val NUMERIC;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO active_query_count
    FROM pg_stat_activity
    WHERE state = 'active';

    IF EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') THEN
        SELECT COALESCE(AVG(mean_exec_time), 0) INTO avg_query_time_val
        FROM pg_stat_statements
        WHERE calls > 100;
    ELSE
        avg_query_time_val := 0;
        RAISE NOTICE 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œæ— æ³•è·å–å¹³å‡æŸ¥è¯¢æ—¶é—´';
    END IF;

    SELECT COALESCE(
        SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100,
        0
    ) INTO cache_hit_ratio_val
    FROM pg_stat_database
    WHERE datname = current_database();

    RAISE NOTICE 'ç›‘æ§æŒ‡æ ‡: æ´»è·ƒæŸ¥è¯¢=%, å¹³å‡æŸ¥è¯¢æ—¶é—´=%, ç¼“å­˜å‘½ä¸­ç‡=%',
        active_query_count, avg_query_time_val, cache_hit_ratio_val;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'å¿…è¦çš„ç³»ç»Ÿè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'current_databaseå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    NOW() as check_time,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') as active_queries,
    (SELECT AVG(mean_exec_time) FROM pg_stat_statements WHERE calls > 100) as avg_query_time,
    (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
     FROM pg_stat_database WHERE datname = current_database()) as cache_hit_ratio;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: SubPlan

-- ç›‘æ§æ…¢æŸ¥è¯¢å˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slow_query_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsæ‰©å±•æœªå®‰è£…ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements
    WHERE mean_exec_time > 100;

    IF slow_query_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªæ…¢æŸ¥è¯¢ï¼ˆå¹³å‡æ‰§è¡Œæ—¶é—´>100msï¼‰', slow_query_count;
    ELSE
        RAISE NOTICE 'æ— æ…¢æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æ§æ…¢æŸ¥è¯¢å˜åŒ–å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    mean_exec_time,
    mean_exec_time - LAG(mean_exec_time) OVER (ORDER BY queryid) as time_delta
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_exec_time DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Limit -> WindowAgg -> Sort -> Seq Scan
```

## 6. å¸¸ç”¨å‚æ•°å»ºè®®ï¼ˆæ‘˜ï¼‰

- è¿æ¥ä¸å¹¶å‘ï¼š`max_connections`ã€`work_mem`ï¼›
- ç¼“å†²ï¼š`shared_buffers`ã€`effective_cache_size`ï¼›
- å¹¶è¡Œ/JITï¼š`max_parallel_workers_per_gather`ã€`jit`ï¼›
- I/Oï¼š`random_page_cost`ã€`effective_io_concurrency`ï¼›
- æ£€æŸ¥ç‚¹/WALï¼š`checkpoint_timeout`ã€`max_wal_size`ã€`checkpoint_completion_target`ã€`wal_compression`ï¼›
- ç»´æŠ¤ï¼š`autovacuum_*`ã€`maintenance_work_mem`ã€‚

### 6.1 å‚æ•°æ¨èé…ç½®

```sql
-- è¿æ¥ä¸å¹¶å‘
max_connections = 200  -- æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´
work_mem = 64MB  -- æ¯ä¸ªæ“ä½œå¯ç”¨å†…å­˜ï¼Œæ€»å†…å­˜ = work_mem * max_connections

-- ç¼“å†²
shared_buffers = 25% of RAM  -- ç”Ÿäº§ç¯å¢ƒæ¨è
effective_cache_size = 75% of RAM  -- æŸ¥è¯¢è§„åˆ’å™¨ä½¿ç”¨

-- å¹¶è¡Œ
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_worker_processes = 8

-- I/Oï¼ˆSSDç¯å¢ƒï¼‰
random_page_cost = 1.1  -- SSDæ¨èå€¼
effective_io_concurrency = 200  -- SSDæ¨èå€¼

-- æ£€æŸ¥ç‚¹/WAL
checkpoint_timeout = 15min
max_wal_size = 4GB
checkpoint_completion_target = 0.9
wal_compression = on

-- ç»´æŠ¤
maintenance_work_mem = 1GB
autovacuum_max_workers = 3
autovacuum_naptime = 10s
```

## 7. éªŒè¯æ¸…å•

- æŒ‡æ ‡å¯¹æ¯”ï¼šè°ƒä¼˜å‰/å P95ã€TPS/QPSã€å‘½ä¸­ç‡ã€WALã€æ£€æŸ¥ç‚¹ï¼›
- SQL å¯¹æ¯”ï¼šTopN æ˜¯å¦ä¸‹é™ã€ä¼°ç®—åå·®æ˜¯å¦ç¼“è§£ï¼›
- èµ„æºï¼šCPU/IO/å†…å­˜æ˜¯å¦åœ¨é˜ˆå€¼å†…ï¼›
- ä¸šåŠ¡ï¼šé”™è¯¯ç‡/è¶…æ—¶æ˜¯å¦æ­£å¸¸ã€‚

### 7.1 æ€§èƒ½å¯¹æ¯”è„šæœ¬

```sql
-- å¯¹æ¯”å˜æ›´å‰åçš„æ€§èƒ½æŒ‡æ ‡
WITH baseline AS (
    SELECT * FROM performance_baseline
    WHERE baseline_time = (SELECT MAX(baseline_time) FROM performance_baseline WHERE baseline_time < NOW() - INTERVAL '1 hour')
),
current AS (
    SELECT * FROM performance_baseline
    WHERE baseline_time = (SELECT MAX(baseline_time) FROM performance_baseline)
)
SELECT
    'Active Queries' as metric,
    baseline.active_queries as before_value,
    current.active_queries as after_value,
    current.active_queries - baseline.active_queries as delta,
    ROUND((current.active_queries - baseline.active_queries)::numeric / NULLIF(baseline.active_queries, 0) * 100, 2) as percent_change
FROM baseline, current
UNION ALL
SELECT
    'Cache Hit Ratio',
    baseline.cache_hit_ratio,
    current.cache_hit_ratio,
    current.cache_hit_ratio - baseline.cache_hit_ratio,
    ROUND((current.cache_hit_ratio - baseline.cache_hit_ratio)::numeric / NULLIF(baseline.cache_hit_ratio, 0) * 100, 2)
FROM baseline, current;
```

### 7.2 éªŒè¯æ ‡å‡†

```sql
-- åˆ›å»ºéªŒè¯æ£€æŸ¥æ¸…å•
CREATE OR REPLACE FUNCTION verify_performance_change()
RETURNS TABLE (
    check_item TEXT,
    status TEXT,
    details TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥1: P95å»¶è¿Ÿ
    RETURN QUERY
    SELECT
        'P95 Query Time'::TEXT,
        CASE
            WHEN (SELECT percentile_cont(0.95) WITHIN GROUP (ORDER BY mean_exec_time) FROM pg_stat_statements) < 1000
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        'P95 query time check'::TEXT;

    -- æ£€æŸ¥2: ç¼“å­˜å‘½ä¸­ç‡
    RETURN QUERY
    SELECT
        'Cache Hit Ratio'::TEXT,
        CASE
            WHEN (SELECT SUM(blks_hit)::float / NULLIF(SUM(blks_hit) + SUM(blks_read), 0) * 100
                  FROM pg_stat_database WHERE datname = current_database()) > 95
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        'Cache hit ratio check'::TEXT;

    -- æ£€æŸ¥3: é”ç­‰å¾…
    RETURN QUERY
    SELECT
        'Lock Waits'::TEXT,
        CASE
            WHEN (SELECT COUNT(*) FROM pg_stat_activity WHERE wait_event_type = 'Lock') < 5
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        'Lock wait check'::TEXT;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒéªŒè¯
SELECT * FROM verify_performance_change();
```

## 8. å›æ»šä¸å¤ç›˜

- ç«‹å³æ¢å¤å‚æ•°æ—§å€¼/æ’¤é”€ç´¢å¼•æˆ–é‡å†™ï¼›
- é™„åŠ è¯æ®ï¼šæ—¥å¿—ã€æ…¢SQLã€EXPLAINã€é¢æ¿æˆªå›¾ï¼›
- å¤ç›˜æ¡ç›®ï¼šé—®é¢˜æ ¹å› ã€æ— æ•ˆå°è¯•ã€æœ‰æ•ˆæ‰‹æ®µã€å¯å¤ç”¨è„šæœ¬ã€‚

### 8.1 å›æ»šè„šæœ¬

```sql
-- å‚æ•°å›æ»šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_reload_conf') THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    ALTER SYSTEM SET shared_buffers = '256MB';  -- æ¢å¤åˆ°æ—§å€¼
    PERFORM pg_reload_conf();
    RAISE NOTICE 'å‚æ•°shared_bufferså·²å›æ»šåˆ°256MBå¹¶é‡æ–°åŠ è½½é…ç½®';
EXCEPTION
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ç³»ç»Ÿå‚æ•°';
    WHEN invalid_parameter_value THEN
        RAISE EXCEPTION 'å‚æ•°å€¼æ— æ•ˆ: shared_buffers = 256MB';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_reload_confå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å‚æ•°å›æ»šå¤±è´¥: %', SQLERRM;
END $$;

-- ç´¢å¼•å›æ»šï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders' AND indexname = 'idx_orders_created_at'
    ) THEN
        RAISE NOTICE 'ç´¢å¼•idx_orders_created_atä¸å­˜åœ¨ï¼Œæ— éœ€å›æ»š';
        RETURN;
    END IF;

    DROP INDEX CONCURRENTLY IF EXISTS idx_orders_created_at;
    RAISE NOTICE 'ç´¢å¼•idx_orders_created_atå›æ»šæˆåŠŸï¼ˆåœ¨çº¿åˆ é™¤ï¼Œä¸é˜»å¡å†™æ“ä½œï¼‰';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'ç´¢å¼•å›æ»šå¤±è´¥: %', SQLERRM;
END $$;

-- æ›´æ–°å˜æ›´è®°å½•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    change_id_val INT := <change_id>;  -- éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„change_id
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'performance_change_log'
    ) THEN
        RAISE EXCEPTION 'è¡¨performance_change_logä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM performance_change_log
        WHERE change_id = change_id_val
    ) THEN
        RAISE EXCEPTION 'å˜æ›´è®°å½•change_id=%ä¸å­˜åœ¨', change_id_val;
    END IF;

    UPDATE performance_change_log
    SET
        change_status = 'rolled_back',
        notes = 'å›æ»šåŸå› ï¼šP95å»¶è¿Ÿå¢åŠ 15%ï¼Œè¶…è¿‡é˜ˆå€¼10%'
    WHERE change_id = change_id_val;

    RAISE NOTICE 'å˜æ›´è®°å½•æ›´æ–°æˆåŠŸ: change_id=%', change_id_val;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨performance_change_logä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°å˜æ›´è®°å½•å¤±è´¥: %', SQLERRM;
END $$;
```

### 8.2 å¤ç›˜è®°å½•

```sql
-- åˆ›å»ºå¤ç›˜è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS performance_tuning_review (
    review_id SERIAL PRIMARY KEY,
    review_date TIMESTAMP DEFAULT NOW(),
    change_id INTEGER REFERENCES performance_change_log(change_id),
    root_cause TEXT,
    failed_attempts TEXT[],
    successful_approaches TEXT[],
    reusable_scripts TEXT,
    lessons_learned TEXT
);

-- è®°å½•å¤ç›˜
INSERT INTO performance_tuning_review (
    change_id,
    root_cause,
    failed_attempts,
    successful_approaches,
    reusable_scripts
)
VALUES (
    1,
    'shared_buffersè®¾ç½®è¿‡å¤§å¯¼è‡´æ“ä½œç³»ç»Ÿç¼“å­˜å‡å°‘',
    ARRAY['ç›´æ¥è®¾ç½®ä¸º1GB', 'æœªè€ƒè™‘æ“ä½œç³»ç»Ÿç¼“å­˜éœ€æ±‚'],
    ARRAY['é€æ­¥å¢åŠ å¹¶è§‚å¯Ÿ', 'ä½¿ç”¨25% RAMè§„åˆ™'],
    'æ€§èƒ½å¯¹æ¯”è„šæœ¬ã€éªŒè¯å‡½æ•°'
);
```
