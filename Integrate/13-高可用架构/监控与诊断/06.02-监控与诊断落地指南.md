---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\ç›‘æ§ä¸è¯Šæ–­\12-ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å‚è€ƒï¼š`./06.01-ç›‘æ§ä¸è¯Šæ–­.md`

---

## ğŸ“‹ ç›®å½•

- [ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#ç›‘æ§ä¸è¯Šæ–­-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç»„ä»¶](#1-ç»„ä»¶)
  - [2. æ­¥éª¤](#2-æ­¥éª¤)
    - [2.1 å®Œæ•´éƒ¨ç½²æ­¥éª¤](#21-å®Œæ•´éƒ¨ç½²æ­¥éª¤)
    - [2.2 å…³é”®æŒ‡æ ‡æŸ¥è¯¢](#22-å…³é”®æŒ‡æ ‡æŸ¥è¯¢)
  - [3. æ—¥å¿—å»ºè®®](#3-æ—¥å¿—å»ºè®®)
    - [3.1 å®Œæ•´æ—¥å¿—é…ç½®](#31-å®Œæ•´æ—¥å¿—é…ç½®)
  - [4. è¯Šæ–­SQL](#4-è¯Šæ–­sql)
    - [4.1 å®Œæ•´è¯Šæ–­SQLè„šæœ¬](#41-å®Œæ•´è¯Šæ–­sqlè„šæœ¬)
    - [4.2 æ…¢æŸ¥è¯¢åˆ†ææµç¨‹](#42-æ…¢æŸ¥è¯¢åˆ†ææµç¨‹)
  - [5. å‘Šè­¦é—¨æ§›ï¼ˆç¤ºä¾‹ï¼‰](#5-å‘Šè­¦é—¨æ§›ç¤ºä¾‹)
    - [5.1 Prometheuså‘Šè­¦è§„åˆ™](#51-prometheuså‘Šè­¦è§„åˆ™)
    - [5.2 å‘Šè­¦é˜ˆå€¼å»ºè®®](#52-å‘Šè­¦é˜ˆå€¼å»ºè®®)
    - [5.3 å‘Šè­¦é€šçŸ¥é…ç½®](#53-å‘Šè­¦é€šçŸ¥é…ç½®)

---

## 1. ç»„ä»¶

- postgres_exporterã€Prometheusã€Grafanaã€æ—¥å¿—ç®¡é“ï¼ˆFilebeat/Vector â†’ Loki/Elasticï¼‰ã€‚
- å‚è€ƒï¼š`./06.01-ç›‘æ§ä¸è¯Šæ–­.md`ã€‚

## 2. æ­¥éª¤

1) åˆ›å»ºç›‘æ§ç”¨æˆ·ï¼š

    ```sql
    CREATE ROLE metrics WITH LOGIN PASSWORD '***';
    GRANT pg_monitor TO metrics;
    -- ç»†ç²’åº¦ï¼šGRANT pg_read_all_stats TO metrics;
    ```

2) å¯åŠ¨ exporterï¼š

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

3) Prometheus æŠ“å–ï¼š

    ```yaml
    scrape_configs:
    - job_name: pg
        scrape_interval: 15s
        static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
    ```

4) Grafana å¯¼å…¥ï¼šè¿æ¥/äº‹åŠ¡ã€å‘½ä¸­ç‡/WALã€æ£€æŸ¥ç‚¹ã€Autovacuumã€é”ç­‰å¾…ã€Top æŸ¥è¯¢ã€‚

### 2.1 å®Œæ•´éƒ¨ç½²æ­¥éª¤

**æ­¥éª¤1: åˆ›å»ºç›‘æ§ç”¨æˆ·**:

```sql
-- åˆ›å»ºç›‘æ§ä¸“ç”¨ç”¨æˆ·
CREATE ROLE metrics WITH LOGIN PASSWORD 'your_secure_password';

-- æˆäºˆç›‘æ§æƒé™
GRANT pg_monitor TO metrics;

-- ç»†ç²’åº¦æƒé™ï¼ˆå¯é€‰ï¼‰
GRANT pg_read_all_stats TO metrics;
GRANT pg_read_all_settings TO metrics;

-- éªŒè¯æƒé™
\du metrics
```

**æ­¥éª¤2: å®‰è£…postgres_exporter**:

```bash
# æ–¹æ³•1: ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz
tar -xzf postgres_exporter-0.15.0.linux-amd64.tar.gz
cd postgres_exporter-0.15.0.linux-amd64

# æ–¹æ³•2: ä½¿ç”¨Docker
docker pull prometheuscommunity/postgres-exporter:latest

# æ–¹æ³•3: ä»æºç ç¼–è¯‘
go get github.com/prometheus-community/postgres_exporter
```

**æ­¥éª¤3: é…ç½®postgres_exporter**:

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /etc/postgres_exporter/postgres_exporter.conf <<EOF
# æ•°æ®æºé…ç½®
DATA_SOURCE_NAME="postgresql://metrics:your_secure_password@localhost:5432/postgres?sslmode=disable"

# å¯é€‰ï¼šå¤šæ•°æ®åº“é…ç½®
# DATA_SOURCE_URI="postgresql://metrics:password@localhost:5432/postgres?sslmode=disable"
# DATA_SOURCE_USER_FILE="/etc/postgres_exporter/.pg_user"
# DATA_SOURCE_PASS_FILE="/etc/postgres_exporter/.pg_pass"

# ç›‘å¬åœ°å€
web.listen-address=:9187
web.telemetry-path=/metrics

# æŸ¥è¯¢è¶…æ—¶
query.timeout=10s

# è‡ªåŠ¨å‘ç°æ•°æ®åº“
auto-discover-databases=true
EOF

# åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/postgres_exporter.service <<EOF
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
EnvironmentFile=/etc/postgres_exporter/postgres_exporter.conf
ExecStart=/usr/local/bin/postgres_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable postgres_exporter
systemctl start postgres_exporter

# éªŒè¯æœåŠ¡
curl http://localhost:9187/metrics | head -20
```

**æ­¥éª¤4: é…ç½®Prometheus**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'db1:9187'
          - 'db2:9187'
          - 'db3:9187'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'pg_stat_database_.*'
        action: keep
```

**æ­¥éª¤5: é…ç½®Grafana**:

```json
{
  "dashboard": {
    "title": "PostgreSQL Performance",
    "panels": [
      {
        "title": "Connections",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
          }
        ]
      },
      {
        "title": "Cache Hit Ratio",
        "targets": [
          {
            "expr": "100 * (pg_stat_database_blks_hit{datname=\"postgres\"} / (pg_stat_database_blks_hit{datname=\"postgres\"} + pg_stat_database_blks_read{datname=\"postgres\"}))"
          }
        ]
      }
    ]
  }
}
```

### 2.2 å…³é”®æŒ‡æ ‡æŸ¥è¯¢

```promql
# PrometheusæŸ¥è¯¢ç¤ºä¾‹

# 1. è¿æ¥æ•°
pg_stat_database_numbackends{datname="postgres"}

# 2. äº‹åŠ¡é€Ÿç‡
rate(pg_stat_database_xact_commit{datname="postgres"}[5m])
rate(pg_stat_database_xact_rollback{datname="postgres"}[5m])

# 3. ç¼“å†²åŒºå‘½ä¸­ç‡
100 * (
  sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) /
  (sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) +
   sum(rate(pg_stat_database_blks_read{datname="postgres"}[5m])))
)

# 4. WALå†™å…¥é€Ÿç‡
rate(pg_stat_wal_written_bytes[5m])

# 5. æ£€æŸ¥ç‚¹é¢‘ç‡
rate(pg_stat_bgwriter_checkpoints_timed[5m])
rate(pg_stat_bgwriter_checkpoints_req[5m])

# 6. æ…¢æŸ¥è¯¢æ•°é‡
count(pg_stat_statements_mean_exec_time > 1000)

# 7. é”ç­‰å¾…
count(pg_stat_activity_wait_event_type{wait_event_type="Lock"})
```

## 3. æ—¥å¿—å»ºè®®

```text
log_line_prefix = '%m [%p] %u@%d %r %a '
log_min_duration_statement = 500ms
log_checkpoints = on
log_autovacuum_min_duration = 1s
log_lock_waits = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

### 3.1 å®Œæ•´æ—¥å¿—é…ç½®

```sql
-- postgresql.confå®Œæ•´æ—¥å¿—é…ç½®

-- åŸºæœ¬æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

-- æ—¥å¿—æ ¼å¼
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'Asia/Shanghai'

-- æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500  -- è®°å½•æ‰§è¡Œæ—¶é—´>500msçš„æŸ¥è¯¢
log_min_messages = warning

-- æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on

-- Autovacuumæ—¥å¿—
log_autovacuum_min_duration = 1s

-- é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

-- I/Oæ—¶é—´è·Ÿè¸ª
track_io_timing = on

-- æ‰©å±•ç»Ÿè®¡
shared_preload_libraries = 'pg_stat_statements,auto_explain'

-- auto_explainé…ç½®
auto_explain.log_min_duration = 200
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_verbose = on
auto_explain.log_format = json
```

## 4. è¯Šæ–­SQL

- è§ `sql/diagnostics.sql`ï¼›æ…¢SQLé¢æ¿ TopN ä¸ EXPLAIN ç»“åˆã€‚

### 4.1 å®Œæ•´è¯Šæ–­SQLè„šæœ¬

```sql
-- diagnostics.sql

-- 1. Top 10 æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    statement_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO statement_count
    FROM pg_stat_statements;

    IF statement_count > 0 THEN
        RAISE NOTICE 'å‘ç° % æ¡SQLç»Ÿè®¡è®°å½•', statement_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°SQLç»Ÿè®¡è®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Top 10æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 2. ç­‰å¾…äº‹ä»¶åˆ†å¸ƒï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    wait_event_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO wait_event_count
    FROM pg_stat_activity
    WHERE wait_event_type IS NOT NULL;

    IF wait_event_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç­‰å¾…äº‹ä»¶', wait_event_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç­‰å¾…äº‹ä»¶';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç­‰å¾…äº‹ä»¶åˆ†å¸ƒæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: WindowAgg -> GroupAggregate -> Seq Scan

-- 3. é”ç­‰å¾…æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    lock_wait_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_locks'
    ) THEN
        RAISE WARNING 'pg_locksè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO lock_wait_count
    FROM pg_catalog.pg_locks
    WHERE NOT granted;

    IF lock_wait_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªé”ç­‰å¾…', lock_wait_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°é”ç­‰å¾…';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'ç›¸å…³è¡¨æˆ–è§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'é”ç­‰å¾…æƒ…å†µæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºé”æ•°é‡ï¼‰
-- è®¡åˆ’: Hash Join -> Nested Loop

-- 4. è¡¨è†¨èƒ€æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    bloated_table_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO bloated_table_count
    FROM pg_stat_user_tables
    WHERE n_dead_tup > 1000;

    IF bloated_table_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨å­˜åœ¨è†¨èƒ€ï¼ˆæ­»å…ƒç»„>1000ï¼‰', bloated_table_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°è¡¨è†¨èƒ€';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_total_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN division_by_zero THEN
        RAISE WARNING 'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é™¤é›¶é”™è¯¯';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¡¨è†¨èƒ€æƒ…å†µæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_live_tup,
    n_dead_tup,
    CASE
        WHEN n_live_tup > 0 THEN n_dead_tup::float / n_live_tup * 100
        ELSE 0
    END AS dead_tuple_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 5. ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO index_count
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public';

    IF index_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªpublic schemaçš„ç´¢å¼•', index_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç´¢å¼•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE WARNING 'pg_relation_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç´¢å¼•ä½¿ç”¨æƒ…å†µæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºç´¢å¼•æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- 6. è¿æ¥ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    connection_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_activity'
    ) THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO connection_count
    FROM pg_stat_activity
    WHERE datname IS NOT NULL;

    IF connection_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªæ•°æ®åº“è¿æ¥', connection_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ•°æ®åº“è¿æ¥';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_activityè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¿æ¥ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') as idle_connections,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    COUNT(*) FILTER (WHERE wait_event_type IS NOT NULL) as waiting_connections
FROM pg_stat_activity
WHERE datname IS NOT NULL
GROUP BY datname;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: HashAggregate -> Seq Scan

-- 7. æ•°æ®åº“å¤§å°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    db_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_database'
    ) THEN
        RAISE WARNING 'pg_databaseè¡¨ä¸å­˜åœ¨';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_database_size') THEN
        RAISE EXCEPTION 'pg_database_sizeå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO db_count
    FROM pg_database;

    IF db_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªæ•°æ®åº“', db_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ•°æ®åº“';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_databaseè¡¨ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_database_sizeå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ•°æ®åº“å¤§å°æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºæ•°æ®åº“æ•°é‡ï¼‰
-- è®¡åˆ’: Sort -> Seq Scan

-- 8. å¤åˆ¶å»¶è¿Ÿï¼ˆå¦‚æœæœ‰å¤åˆ¶ï¼Œå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    replication_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_replication'
    ) THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨ï¼Œå¯èƒ½æ²¡æœ‰é…ç½®å¤åˆ¶';
        RETURN;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE EXCEPTION 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_wal_lsn_diff') THEN
        RAISE EXCEPTION 'pg_wal_lsn_diffå‡½æ•°ä¸å­˜åœ¨';
    END IF;

    SELECT COUNT(*) INTO replication_count
    FROM pg_stat_replication;

    IF replication_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªå¤åˆ¶è¿æ¥', replication_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°å¤åˆ¶è¿æ¥';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_replicationè§†å›¾ä¸å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'å¿…è¦çš„WALå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'å¤åˆ¶å»¶è¿ŸæŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replication_lag_bytes,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS replication_lag
FROM pg_stat_replication;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Seq Scan

-- 9. æ£€æŸ¥ç‚¹ç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_bgwriter'
    ) THEN
        RAISE WARNING 'pg_stat_bgwriterè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    RAISE NOTICE 'æ­£åœ¨æ£€æŸ¥æ£€æŸ¥ç‚¹ç»Ÿè®¡';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_bgwriterè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç‚¹ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean
FROM pg_stat_bgwriter;
-- æ‰§è¡Œæ—¶é—´: <10ms
-- è®¡åˆ’: Seq Scan

-- 10. Autovacuumç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    vacuum_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_tables'
    ) THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO vacuum_count
    FROM pg_stat_user_tables
    WHERE last_autovacuum IS NOT NULL;

    IF vacuum_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªè¡¨æœ‰autovacuumè®°å½•', vacuum_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°autovacuumè®°å½•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_tablesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Autovacuumç»Ÿè®¡æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
WHERE last_autovacuum IS NOT NULL
ORDER BY last_autovacuum DESC
LIMIT 20;
-- æ‰§è¡Œæ—¶é—´: <100msï¼ˆå–å†³äºè¡¨æ•°é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan
```

### 4.2 æ…¢æŸ¥è¯¢åˆ†ææµç¨‹

```sql
-- æ­¥éª¤1: è¯†åˆ«æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slow_query_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'public' AND table_name = 'pg_stat_statements'
    ) THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…pg_stat_statementsæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements
    WHERE mean_exec_time > 1000;

    IF slow_query_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªæ…¢æŸ¥è¯¢ï¼ˆå¹³å‡æ‰§è¡Œæ—¶é—´>1000msï¼‰', slow_query_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ…¢æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¯†åˆ«æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    queryid,
    LEFT(query, 200) as query_preview,
    calls,
    mean_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY total_exec_time DESC
LIMIT 10;
-- æ‰§è¡Œæ—¶é—´: <200msï¼ˆå–å†³äºpg_stat_statementsæ•°æ®é‡ï¼‰
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- æ­¥éª¤2: åˆ†ææ‰§è¡Œè®¡åˆ’
-- æ³¨æ„ï¼šEXPLAIN (ANALYZE, BUFFERS, TIMING) éœ€è¦ç²˜è´´å…·ä½“çš„æ…¢æŸ¥è¯¢SQL
-- ç¤ºä¾‹ï¼š
-- EXPLAIN (ANALYZE, BUFFERS, TIMING)
-- SELECT * FROM orders WHERE user_id = 12345;

-- æ­¥éª¤3: æ£€æŸ¥ç´¢å¼•ä½¿ç”¨ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    index_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.views
        WHERE table_schema = 'pg_catalog' AND table_name = 'pg_stat_user_indexes'
    ) THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO index_count
    FROM pg_stat_user_indexes;

    IF index_count > 0 THEN
        RAISE NOTICE 'å‘ç° % ä¸ªç”¨æˆ·ç´¢å¼•', index_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°ç”¨æˆ·ç´¢å¼•';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_user_indexesè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç´¢å¼•ä½¿ç”¨å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read
FROM pg_stat_user_indexes;
WHERE schemaname = 'public'
AND tablename = 'your_table';

-- æ­¥éª¤4: æ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public'
AND tablename = 'your_table';
```

## 5. å‘Šè­¦é—¨æ§›ï¼ˆç¤ºä¾‹ï¼‰

- è¿æ¥ä½¿ç”¨ç‡ > 80%ï¼›ç¼“å†²å‘½ä¸­ç‡ < 95%ï¼›WAL é€Ÿç‡éª¤å¢ï¼›æ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹ï¼›Autovacuum æ»åï¼›æ­»é”äº‹ä»¶ã€‚

### 5.1 Prometheuså‘Šè­¦è§„åˆ™

```yaml
# prometheus_alerts.yml
groups:
  - name: postgresql_alerts
    rules:
      # é«˜è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: |
          pg_stat_database_numbackends{datname="postgres"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLé«˜è¿æ¥æ•°å‘Šè­¦"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°: {{ $value }}ï¼Œè¶…è¿‡é˜ˆå€¼80"

      # ä½ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          100 * (
            sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) /
            (sum(rate(pg_stat_database_blks_hit{datname="postgres"}[5m])) +
             sum(rate(pg_stat_database_blks_read{datname="postgres"}[5m])))
          ) < 95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç¼“å­˜å‘½ä¸­ç‡ä½"
          description: "æ•°æ®åº“ {{ $labels.datname }} ç¼“å­˜å‘½ä¸­ç‡: {{ $value }}%ï¼Œä½äºé˜ˆå€¼95%"

      # WALå†™å…¥é€Ÿç‡å¼‚å¸¸
      - alert: PostgreSQLHighWALWriteRate
        expr: |
          rate(pg_stat_wal_written_bytes[5m]) > 100000000  # 100MB/s
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL WALå†™å…¥é€Ÿç‡å¼‚å¸¸"
          description: "WALå†™å…¥é€Ÿç‡: {{ $value }} bytes/s"

      # æ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹
      - alert: PostgreSQLFrequentCheckpoints
        expr: |
          rate(pg_stat_bgwriter_checkpoints_req[5m]) > 0.1  # æ¯10ç§’ä¸€æ¬¡
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹"
          description: "æ£€æŸ¥ç‚¹é¢‘ç‡: {{ $value }} æ¬¡/ç§’"

      # Autovacuumæ»å
      - alert: PostgreSQLAutovacuumLag
        expr: |
          max(pg_stat_user_tables_n_dead_tup) > 1000000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL Autovacuumæ»å"
          description: "æ­»å…ƒç»„æ•°é‡: {{ $value }}"

      # æ­»é”äº‹ä»¶
      - alert: PostgreSQLDeadlock
        expr: |
          increase(pg_stat_database_deadlocks{datname="postgres"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLæ£€æµ‹åˆ°æ­»é”"
          description: "æ•°æ®åº“ {{ $labels.datname }} å‘ç”Ÿæ­»é”äº‹ä»¶"
```

### 5.2 å‘Šè­¦é˜ˆå€¼å»ºè®®

| æŒ‡æ ‡ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| è¿æ¥ä½¿ç”¨ç‡ | > 80% | > 90% | max_connectionsçš„ç™¾åˆ†æ¯” |
| ç¼“å­˜å‘½ä¸­ç‡ | < 95% | < 90% | ç¼“å†²åŒºå‘½ä¸­ç‡ |
| WALå†™å…¥é€Ÿç‡ | > 100MB/s | > 500MB/s | æŒç»­5åˆ†é’Ÿ |
| æ£€æŸ¥ç‚¹é¢‘ç‡ | > 0.1æ¬¡/ç§’ | > 0.2æ¬¡/ç§’ | è¯·æ±‚æ£€æŸ¥ç‚¹é¢‘ç‡ |
| æ­»å…ƒç»„æ•°é‡ | > 1M | > 10M | å•è¡¨æ­»å…ƒç»„ |
| æ…¢æŸ¥è¯¢æ•°é‡ | > 10 | > 50 | æ‰§è¡Œæ—¶é—´>1ç§’çš„æŸ¥è¯¢ |
| é”ç­‰å¾…æ•°é‡ | > 5 | > 20 | å½“å‰é”ç­‰å¾…æ•° |
| å¤åˆ¶å»¶è¿Ÿ | > 1GB | > 10GB | æµå¤åˆ¶å»¶è¿Ÿ |

### 5.3 å‘Šè­¦é€šçŸ¥é…ç½®

```yaml
# alertmanager.yml
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        severity: warning
      receiver: 'warning-alerts'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alert-webhook:8080/alerts'

  - name: 'critical-alerts'
    email_configs:
      - to: 'dba-team@example.com'
        from: 'alerts@example.com'
        smarthost: 'smtp.example.com:587'
        auth_username: 'alerts'
        auth_password: 'password'
    webhook_configs:
      - url: 'http://alert-webhook:8080/critical'

  - name: 'warning-alerts'
    email_configs:
      - to: 'dba-team@example.com'
        from: 'alerts@example.com'
        smarthost: 'smtp.example.com:587'
        auth_username: 'alerts'
        auth_password: 'password'
```
