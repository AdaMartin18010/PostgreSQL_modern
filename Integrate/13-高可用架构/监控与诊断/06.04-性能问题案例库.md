---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\ç›‘æ§ä¸è¯Šæ–­\06.04-æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“

ç»“æ„ï¼šé—®é¢˜ â†’ è¯æ® â†’ å˜æ›´ â†’ æ•ˆæœ â†’ é˜²å†å‘

## æ¡ˆä¾‹1ï¼šä¼°ç®—åå·®å¯¼è‡´é”™è¯¯è¿æ¥é¡ºåº

- è¯æ®ï¼š`pg_stat_statements` TopNã€EXPLAIN æ˜¾ç¤º Seq Scan + é«˜å›è¡¨ï¼›
- å˜æ›´ï¼š`SET STATISTICS 2000`ã€æ‰©å±•ç»Ÿè®¡ï¼ˆdependenciesï¼‰ï¼Œæ–°å¢è¡¨è¾¾å¼ç´¢å¼•ï¼›
- æ•ˆæœï¼šP95 â†“ 45%ï¼ŒCPU é™ä½ 20%ï¼›
- é˜²å†å‘ï¼šå®šæœŸ ANALYZEã€æ–°å¢å­—æ®µå˜æ›´çº³å…¥ç»Ÿè®¡ç­–ç•¥ã€‚

### æ¡ˆä¾‹1è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

ç”µå•†ç³»ç»Ÿè®¢å•æŸ¥è¯¢æ€§èƒ½ä¸‹é™ï¼ŒP95å»¶è¿Ÿä»200mså¢åŠ åˆ°800msï¼ŒCPUä½¿ç”¨ç‡ä»40%å¢åŠ åˆ°70%ã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: è¯†åˆ«æ…¢æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    slow_query_count INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_class WHERE relname = 'pg_stat_statements') THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO slow_query_count
    FROM pg_stat_statements
    WHERE mean_exec_time > 500;

    IF slow_query_count > 0 THEN
        RAISE WARNING 'å‘ç° % ä¸ªæ…¢æŸ¥è¯¢ï¼ˆå¹³å‡æ‰§è¡Œæ—¶é—´>500msï¼‰', slow_query_count;
    ELSE
        RAISE NOTICE 'æœªå‘ç°æ…¢æŸ¥è¯¢';
    END IF;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_stat_statementsè§†å›¾ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ‰©å±•';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è¯†åˆ«æ…¢æŸ¥è¯¢å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    LEFT(query, 200) as query_preview,
    calls,
    mean_exec_time,
    max_exec_time,
    rows
FROM pg_stat_statements
WHERE mean_exec_time > 500
ORDER BY mean_exec_time DESC
LIMIT 5;
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Limit -> Sort -> Seq Scan

-- ç»“æœï¼šå‘ç°è®¢å•å…³è”æŸ¥è¯¢
-- SELECT o.*, u.name, p.name
-- FROM orders o
-- JOIN users u ON o.user_id = u.id
-- JOIN products p ON o.product_id = p.id
-- WHERE o.created_at >= '2024-01-01' AND o.status = 'pending'

-- æ­¥éª¤2: æ‰§è¡ŒEXPLAINåˆ†æ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT o.*, u.name, p.name
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN products p ON o.product_id = p.id
WHERE o.created_at >= '2024-01-01' AND o.status = 'pending';

-- é—®é¢˜å‘ç°ï¼š
-- - ä¼˜åŒ–å™¨é€‰æ‹©äº†é”™è¯¯çš„è¿æ¥é¡ºåºï¼ˆå…ˆè¿æ¥productsï¼Œå¯¼è‡´å¤§é‡å›è¡¨ï¼‰
-- - ä¼°ç®—è¡Œæ•°ï¼š1000è¡Œï¼ˆå®é™…ï¼š50000è¡Œï¼‰
-- - ä½¿ç”¨äº†Seq Scanè€ŒéIndex Scan

-- æ­¥éª¤3: æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    stats_count INT;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_class WHERE relname = 'pg_stats') THEN
        RAISE WARNING 'pg_statsè§†å›¾ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT COUNT(*) INTO stats_count
    FROM pg_stats
    WHERE tablename IN ('orders', 'users', 'products')
      AND attname IN ('user_id', 'product_id', 'created_at', 'status');

    RAISE NOTICE 'æ‰¾åˆ° % æ¡ç»Ÿè®¡ä¿¡æ¯è®°å½•', stats_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'pg_statsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs
FROM pg_stats
WHERE tablename IN ('orders', 'users', 'products')
AND attname IN ('user_id', 'product_id', 'created_at', 'status');
-- æ‰§è¡Œæ—¶é—´: <100ms
-- è®¡åˆ’: Seq Scan

-- å‘ç°ï¼šordersè¡¨çš„created_atå’Œstatusåˆ—ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- 1. æå‡ç»Ÿè®¡ä¿¡æ¯ç²¾åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ALTER TABLE orders ALTER COLUMN created_at SET STATISTICS 2000;
    ALTER TABLE orders ALTER COLUMN status SET STATISTICS 2000;
    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯ç²¾åº¦å·²æå‡: created_atå’Œstatusåˆ—è®¾ç½®ä¸º2000';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'åˆ—created_atæˆ–statusä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æå‡ç»Ÿè®¡ä¿¡æ¯ç²¾åº¦å¤±è´¥: %', SQLERRM;
END $$;

-- 2. åˆ›å»ºæ‰©å±•ç»Ÿè®¡ï¼ˆPostgreSQL 10+ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_statistic_ext
        WHERE stxname = 'orders_created_status_dependencies'
    ) THEN
        DROP STATISTICS orders_created_status_dependencies;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰æ‰©å±•ç»Ÿè®¡: orders_created_status_dependencies';
    END IF;

    CREATE STATISTICS orders_created_status_dependencies
    ON orders (created_at, status);
    RAISE NOTICE 'æ‰©å±•ç»Ÿè®¡åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'æ‰©å±•ç»Ÿè®¡orders_created_status_dependencieså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºæ‰©å±•ç»Ÿè®¡å¤±è´¥: %', SQLERRM;
END $$;

-- 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    ANALYZE orders;
    RAISE NOTICE 'ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æˆåŠŸ: ordersè¡¨';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %', SQLERRM;
END $$;

-- 4. åˆ›å»ºå¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_indexes
        WHERE tablename = 'orders' AND indexname = 'idx_orders_created_status'
    ) THEN
        DROP INDEX CONCURRENTLY idx_orders_created_status;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç´¢å¼•: idx_orders_created_status';
    END IF;

    CREATE INDEX CONCURRENTLY idx_orders_created_status
    ON orders (created_at, status)
    WHERE status = 'pending';
    RAISE NOTICE 'å¤åˆç´¢å¼•åˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_object THEN
        RAISE WARNING 'ç´¢å¼•idx_orders_created_statuså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¤åˆç´¢å¼•å¤±è´¥: %', SQLERRM;
END $$;

-- 5. éªŒè¯ä¼˜åŒ–æ•ˆæœ
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT o.*, u.name, p.name
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN products p ON o.product_id = p.id
WHERE o.created_at >= '2024-01-01' AND o.status = 'pending';
-- ç»“æœï¼šä½¿ç”¨Index Scanï¼Œè¿æ¥é¡ºåºæ­£ç¡®ï¼Œæ‰§è¡Œæ—¶é—´ä»800msé™è‡³150ms
```

**æ•ˆæœéªŒè¯**:

```sql
-- æ€§èƒ½å¯¹æ¯”
-- ä¼˜åŒ–å‰ï¼š
-- - P95å»¶è¿Ÿï¼š800ms
-- - CPUä½¿ç”¨ç‡ï¼š70%
-- - ç¼“å†²åŒºå‘½ä¸­ç‡ï¼š85%

-- ä¼˜åŒ–åï¼š
-- - P95å»¶è¿Ÿï¼š150msï¼ˆâ†“81%ï¼‰
-- - CPUä½¿ç”¨ç‡ï¼š50%ï¼ˆâ†“29%ï¼‰
-- - ç¼“å†²åŒºå‘½ä¸­ç‡ï¼š98%ï¼ˆâ†‘15%ï¼‰

-- ç›‘æ§éªŒè¯
SELECT
    LEFT(query, 200) as query_preview,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE query LIKE '%orders%JOIN%users%JOIN%products%'
ORDER BY mean_exec_time DESC;
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. å®šæœŸANALYZEï¼ˆé€šè¿‡cronæˆ–pg_cronï¼‰
-- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
SELECT cron.schedule('analyze-orders', '0 2 * * *', 'ANALYZE orders;');

-- 2. æ–°å¢å­—æ®µæ—¶è‡ªåŠ¨è®¾ç½®ç»Ÿè®¡ç²¾åº¦ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_proc
        WHERE proname = 'set_column_statistics'
    ) THEN
        DROP FUNCTION set_column_statistics();
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰å‡½æ•°: set_column_statistics';
    END IF;

    CREATE OR REPLACE FUNCTION set_column_statistics()
    RETURNS TRIGGER AS $$
    BEGIN
        -- æ–°å­—æ®µè‡ªåŠ¨è®¾ç½®ç»Ÿè®¡ç²¾åº¦
        EXECUTE format('ALTER TABLE %I ALTER COLUMN %I SET STATISTICS 2000',
                       TG_TABLE_NAME, NEW.column_name);
        RETURN NEW;
    EXCEPTION
        WHEN undefined_table THEN
            RAISE WARNING 'è¡¨%ä¸å­˜åœ¨', TG_TABLE_NAME;
            RETURN NEW;
        WHEN undefined_column THEN
            RAISE WARNING 'åˆ—%ä¸å­˜åœ¨', NEW.column_name;
            RETURN NEW;
        WHEN OTHERS THEN
            RAISE WARNING 'è®¾ç½®ç»Ÿè®¡ç²¾åº¦å¤±è´¥: %', SQLERRM;
            RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    RAISE NOTICE 'å‡½æ•°set_column_statisticsåˆ›å»ºæˆåŠŸ';
EXCEPTION
    WHEN duplicate_function THEN
        RAISE WARNING 'å‡½æ•°set_column_statisticså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå‡½æ•°set_column_statisticså¤±è´¥: %', SQLERRM;
END $$;

-- 3. ç›‘æ§ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze,
    CASE
        WHEN last_analyze IS NULL AND last_autoanalyze IS NULL THEN 'Never analyzed'
        WHEN last_analyze > last_autoanalyze THEN last_analyze::text
        ELSE last_autoanalyze::text
    END as last_analyze_time
FROM pg_stat_user_tables
WHERE last_analyze < NOW() - interval '7 days'
OR last_autoanalyze < NOW() - interval '7 days';
```

## æ¡ˆä¾‹2ï¼šé”ç­‰å¾…é“¾å¯¼è‡´å»¶è¿Ÿå°–åˆº

- è¯æ®ï¼š`pg_locks` æœªæˆäºˆé”ã€é•¿äº‹åŠ¡æŒé”ï¼›
- å˜æ›´ï¼šæ‹†åˆ† DDLã€æ‰¹é‡å†™åºåŒ–ã€åˆç†ç´¢å¼•é¿å…çƒ­ç‚¹æ‰«æï¼›
- æ•ˆæœï¼šè¶…æ—¶ç‡ä» 2% é™è‡³ 0.1%ï¼›
- é˜²å†å‘ï¼šé”ç­‰å¾…å‘Šè­¦ã€DDL å˜æ›´çª—å£å®¡æ‰¹ã€‚

### æ¡ˆä¾‹2è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

ç³»ç»Ÿåœ¨ä¸šåŠ¡é«˜å³°æœŸå‡ºç°å»¶è¿Ÿå°–åˆºï¼ŒP99å»¶è¿Ÿä»500msçªç„¶å¢åŠ åˆ°5ç§’ï¼Œè¶…æ—¶ç‡ä»0.1%å¢åŠ åˆ°2%ï¼Œå¤§é‡ç”¨æˆ·è¯·æ±‚è¶…æ—¶ã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥é”ç­‰å¾…æƒ…å†µ
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    blocked_locks.locktype,
    blocked_locks.mode,
    blocked_activity.query_start,
    now() - blocked_activity.query_start AS blocked_duration
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
ORDER BY blocked_activity.query_start;

-- å‘ç°ï¼šå¤§é‡INSERTè¯­å¥è¢«é˜»å¡ï¼Œé˜»å¡æºæ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ALTER TABLEè¯­å¥

-- æ­¥éª¤2: æ£€æŸ¥é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    xact_start,
    now() - xact_start AS transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND now() - xact_start > interval '1 minute'
ORDER BY xact_start;

-- å‘ç°ï¼šæœ‰ä¸€ä¸ªALTER TABLE ADD COLUMNè¯­å¥å·²ç»è¿è¡Œäº†10åˆ†é’Ÿ

-- æ­¥éª¤3: æ£€æŸ¥è¡¨é”
SELECT
    l.pid,
    l.mode,
    l.locktype,
    l.relation::regclass,
    a.query,
    a.query_start,
    age(now(), a.query_start) AS age
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.locktype = 'relation'
AND l.mode LIKE '%ExclusiveLock%'
ORDER BY a.query_start;
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- 1. ç«‹å³ç»ˆæ­¢é˜»å¡çš„DDLæ“ä½œï¼ˆå¦‚æœå…è®¸ï¼‰
SELECT pg_terminate_backend(blocking_pid)
FROM (
    SELECT DISTINCT blocking_locks.pid AS blocking_pid
    FROM pg_catalog.pg_locks blocked_locks
    JOIN pg_catalog.pg_locks blocking_locks
        ON blocking_locks.locktype = blocked_locks.locktype
        AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
        AND blocking_locks.pid != blocked_locks.pid
    WHERE NOT blocked_locks.granted
) t;

-- 2. ä½¿ç”¨CONCURRENTLYé€‰é¡¹é‡å»ºDDLï¼ˆé¿å…é”è¡¨ï¼‰
-- åŸDDLï¼šALTER TABLE orders ADD COLUMN new_field VARCHAR(100);
-- æ”¹ä¸ºï¼šä½¿ç”¨ALTER TABLE ... ADD COLUMN ... NOT NULL DEFAULT ...ï¼ˆPostgreSQL 11+ï¼‰
-- æˆ–è€…ï¼šåˆ†æ­¥éª¤æ‰§è¡Œ

-- æ­¥éª¤1: æ·»åŠ å¯ç©ºåˆ—ï¼ˆå¿«é€Ÿï¼Œä¸é”è¡¨ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'new_field'
    ) THEN
        RAISE WARNING 'åˆ—new_fieldå·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ';
        RETURN;
    END IF;

    ALTER TABLE orders ADD COLUMN new_field VARCHAR(100);
    RAISE NOTICE 'åˆ—new_fieldæ·»åŠ æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN duplicate_column THEN
        RAISE WARNING 'åˆ—new_fieldå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤2: æ‰¹é‡æ›´æ–°é»˜è®¤å€¼ï¼ˆåœ¨ä½å³°æœŸï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    updated_count INT;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'new_field'
    ) THEN
        RAISE EXCEPTION 'åˆ—new_fieldä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ';
    END IF;

    UPDATE orders SET new_field = 'default_value' WHERE new_field IS NULL;
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RAISE NOTICE 'æ›´æ–°äº† % æ¡è®°å½•çš„é»˜è®¤å€¼', updated_count;
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'åˆ—new_fieldä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰¹é‡æ›´æ–°é»˜è®¤å€¼å¤±è´¥: %', SQLERRM;
END $$;

-- æ­¥éª¤3: è®¾ç½®NOT NULLçº¦æŸï¼ˆéœ€è¦é”è¡¨ï¼Œä½†æ—¶é—´çŸ­ï¼Œå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = 'orders' AND column_name = 'new_field'
    ) THEN
        RAISE EXCEPTION 'åˆ—new_fieldä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ';
    END IF;

    ALTER TABLE orders ALTER COLUMN new_field SET NOT NULL;
    RAISE NOTICE 'NOT NULLçº¦æŸè®¾ç½®æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
    WHEN undefined_column THEN
        RAISE EXCEPTION 'åˆ—new_fieldä¸å­˜åœ¨';
    WHEN check_violation THEN
        RAISE EXCEPTION 'å­˜åœ¨NULLå€¼ï¼Œæ— æ³•è®¾ç½®NOT NULLçº¦æŸ';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'è®¾ç½®NOT NULLçº¦æŸå¤±è´¥: %', SQLERRM;
END $$;

-- 3. ä¼˜åŒ–æ‰¹é‡å†™å…¥ï¼ˆé¿å…çƒ­ç‚¹ï¼‰
-- åŸä»£ç ï¼šå•æ¡INSERT
-- INSERT INTO orders (user_id, product_id, amount) VALUES (?, ?, ?);

-- ä¼˜åŒ–ï¼šæ‰¹é‡INSERTï¼Œä½¿ç”¨äº‹åŠ¡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'orders'
    ) THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º';
    END IF;

    BEGIN;
    INSERT INTO orders (user_id, product_id, amount) VALUES
        (1, 1, 100.0), (2, 2, 200.0), (3, 3, 300.0);
    COMMIT;
    RAISE NOTICE 'æ‰¹é‡æ’å…¥æˆåŠŸ';
EXCEPTION
    WHEN undefined_table THEN
        RAISE EXCEPTION 'è¡¨ordersä¸å­˜åœ¨';
        IF FOUND THEN ROLLBACK; END IF;
    WHEN check_violation THEN
        RAISE WARNING 'æ•°æ®è¿åçº¦æŸï¼Œå›æ»šäº‹åŠ¡';
        ROLLBACK;
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ‰¹é‡æ’å…¥å¤±è´¥: %', SQLERRM;
        IF FOUND THEN ROLLBACK; END IF;
END $$;

-- 4. åˆ›å»ºåˆç†ç´¢å¼•é¿å…çƒ­ç‚¹æ‰«æ
-- æ£€æŸ¥çƒ­ç‚¹ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan > 1000000
ORDER BY idx_scan DESC;

-- å¦‚æœå‘ç°é¡ºåºæ’å…¥å¯¼è‡´B-treeçƒ­ç‚¹ï¼Œè€ƒè™‘ï¼š
-- - ä½¿ç”¨fillfactorå‡å°‘é¡µé¢åˆ†è£‚
ALTER TABLE orders SET (fillfactor = 90);

-- - æˆ–ä½¿ç”¨å“ˆå¸Œåˆ†å¸ƒï¼ˆå¦‚æœé€‚ç”¨ï¼‰
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - P99å»¶è¿Ÿï¼š5ç§’
-- - è¶…æ—¶ç‡ï¼š2%
-- - é”ç­‰å¾…æ•°ï¼š50+

-- ä¼˜åŒ–åï¼š
-- - P99å»¶è¿Ÿï¼š300msï¼ˆâ†“94%ï¼‰
-- - è¶…æ—¶ç‡ï¼š0.05%ï¼ˆâ†“97%ï¼‰
-- - é”ç­‰å¾…æ•°ï¼š<5

-- ç›‘æ§éªŒè¯
SELECT
    COUNT(*) as lock_waits,
    MAX(now() - query_start) as max_wait_time
FROM pg_stat_activity
WHERE wait_event_type = 'Lock';
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. é”ç­‰å¾…å‘Šè­¦ï¼ˆPrometheusï¼‰
-- alert: PostgreSQLLockWaits
-- expr: count(pg_stat_activity{wait_event_type="Lock"}) > 10
-- for: 2m

-- 2. DDLå˜æ›´å®¡æ‰¹æµç¨‹
-- - æ‰€æœ‰DDLå˜æ›´å¿…é¡»åœ¨ä½å³°æœŸæ‰§è¡Œ
-- - ä½¿ç”¨CONCURRENTLYé€‰é¡¹ï¼ˆå¦‚æœæ”¯æŒï¼‰
-- - æå‰é€šçŸ¥ä¸šåŠ¡æ–¹

-- 3. é•¿äº‹åŠ¡ç›‘æ§
SELECT
    pid,
    usename,
    application_name,
    now() - xact_start AS transaction_duration,
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND now() - xact_start > interval '5 minutes'
ORDER BY xact_start;
```

## æ¡ˆä¾‹3ï¼šæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹

- è¯æ®ï¼š`log_checkpoints`ã€WAL æš´æ¶¨ã€å»¶è¿Ÿå°–åˆºï¼›
- å˜æ›´ï¼šæå‡ `max_wal_size`ã€`checkpoint_timeout`ã€`checkpoint_completion_target`ï¼›
- æ•ˆæœï¼šP95 ç¨³å®šï¼Œç£ç›˜å†™çªåˆºé™ä½ï¼›
- é˜²å†å‘ï¼šé˜ˆå€¼å‘Šè­¦ä¸å®¹é‡è§„åˆ’ã€‚

### æ¡ˆä¾‹3è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

ç³»ç»Ÿåœ¨é«˜å³°æœŸå‡ºç°å‘¨æœŸæ€§å»¶è¿Ÿå°–åˆºï¼Œæ¯5-10åˆ†é’Ÿå‡ºç°ä¸€æ¬¡ï¼ŒP95å»¶è¿Ÿä»200msçªç„¶å¢åŠ åˆ°2ç§’ï¼ŒæŒç»­æ—¶é—´1-2åˆ†é’Ÿã€‚æ£€æŸ¥æ—¥å¿—å‘ç°æ£€æŸ¥ç‚¹éå¸¸é¢‘ç¹ã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend,
    stats_reset,
    round(extract(epoch from now() - stats_reset) /
          NULLIF(checkpoints_timed + checkpoints_req, 0) / 60, 2) as avg_interval_minutes
FROM pg_stat_bgwriter;

-- å‘ç°ï¼š
-- - checkpoints_reqï¼ˆè¯·æ±‚æ£€æŸ¥ç‚¹ï¼‰æ•°é‡å¾ˆå¤šï¼Œè¯´æ˜WALå¤§å°é¢‘ç¹è¾¾åˆ°max_wal_size
-- - å¹³å‡æ£€æŸ¥ç‚¹é—´éš”ï¼š3-5åˆ†é’Ÿï¼ˆæ­£å¸¸åº”è¯¥æ˜¯15åˆ†é’Ÿä»¥ä¸Šï¼‰

-- æ­¥éª¤2: æ£€æŸ¥WALå¤§å°å’Œå†™å…¥é€Ÿç‡
SELECT
    pg_size_pretty(pg_current_wal_lsn() - '0/0') as current_wal_size,
    pg_size_pretty(pg_walfile_name_offset(pg_current_wal_lsn())) as current_wal_file;

-- æŸ¥çœ‹WALå†™å…¥ç»Ÿè®¡
SELECT
    wal_records,
    wal_write,
    wal_sync,
    wal_bytes,
    wal_write_time,
    wal_sync_time
FROM pg_stat_wal;

-- æ­¥éª¤3: æ£€æŸ¥å½“å‰é…ç½®
SELECT name, setting, unit, context
FROM pg_settings
WHERE name IN (
    'checkpoint_timeout',
    'max_wal_size',
    'min_wal_size',
    'checkpoint_completion_target',
    'wal_buffers'
);

-- å‘ç°ï¼š
-- - max_wal_size = 1GBï¼ˆå¤ªå°ï¼Œå¯¹äºé«˜å†™å…¥è´Ÿè½½ï¼‰
-- - checkpoint_timeout = 5minï¼ˆé»˜è®¤å€¼ï¼Œå¯ä»¥å¢åŠ ï¼‰
-- - checkpoint_completion_target = 0.9ï¼ˆæ­£å¸¸ï¼‰
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- 1. å¢åŠ max_wal_sizeï¼ˆå…è®¸æ›´å¤§çš„WALï¼‰
ALTER SYSTEM SET max_wal_size = '4GB';  -- ä»1GBå¢åŠ åˆ°4GB

-- 2. å¢åŠ checkpoint_timeoutï¼ˆå»¶é•¿æ£€æŸ¥ç‚¹é—´éš”ï¼‰
ALTER SYSTEM SET checkpoint_timeout = '15min';  -- ä»5minå¢åŠ åˆ°15min

-- 3. å¢åŠ wal_buffersï¼ˆå‡å°‘WALå†™å…¥é¢‘ç‡ï¼‰
ALTER SYSTEM SET wal_buffers = '32MB';  -- ä»16MBå¢åŠ åˆ°32MB

-- 4. å¯ç”¨WALå‹ç¼©ï¼ˆå‡å°‘WALå¤§å°ï¼‰
ALTER SYSTEM SET wal_compression = on;

-- 5. é‡æ–°åŠ è½½é…ç½®ï¼ˆæŸäº›å‚æ•°éœ€è¦é‡å¯ï¼‰
SELECT pg_reload_conf();

-- æ³¨æ„ï¼šmax_wal_sizeå’Œcheckpoint_timeoutçš„å˜æ›´éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆ
-- åœ¨ä½å³°æœŸæ‰§è¡Œé‡å¯
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - æ£€æŸ¥ç‚¹é¢‘ç‡ï¼šæ¯3-5åˆ†é’Ÿä¸€æ¬¡
-- - P95å»¶è¿Ÿï¼šå‘¨æœŸæ€§å°–åˆºåˆ°2ç§’
-- - ç£ç›˜I/Oï¼šæ£€æŸ¥ç‚¹æœŸé—´å†™çªåˆº

-- ä¼˜åŒ–åï¼š
-- - æ£€æŸ¥ç‚¹é¢‘ç‡ï¼šæ¯15-20åˆ†é’Ÿä¸€æ¬¡
-- - P95å»¶è¿Ÿï¼šç¨³å®šåœ¨200-300ms
-- - ç£ç›˜I/Oï¼šå¹³æ»‘å†™å…¥

-- ç›‘æ§éªŒè¯
SELECT
    checkpoints_timed,
    checkpoints_req,
    round(extract(epoch from now() - stats_reset) /
          NULLIF(checkpoints_timed + checkpoints_req, 0) / 60, 2) as avg_interval_minutes,
    round((checkpoint_write_time + checkpoint_sync_time) / 1000.0, 2) as total_checkpoint_time_sec
FROM pg_stat_bgwriter;

-- æ£€æŸ¥ç‚¹è¯·æ±‚æ¯”ä¾‹ï¼ˆåº”è¯¥<50%ï¼‰
SELECT
    round(100.0 * checkpoints_req / NULLIF(checkpoints_timed + checkpoints_req, 0), 2) as req_ratio
FROM pg_stat_bgwriter;
-- req_ratio > 50% è¡¨ç¤ºéœ€è¦è¿›ä¸€æ­¥å¢åŠ max_wal_size
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. æ£€æŸ¥ç‚¹é¢‘ç‡å‘Šè­¦
-- Prometheuså‘Šè­¦è§„åˆ™
-- alert: PostgreSQLFrequentCheckpoints
-- expr: (rate(pg_stat_bgwriter_checkpoints_timed[5m]) +
--        rate(pg_stat_bgwriter_checkpoints_req[5m])) > 0.1
-- for: 10m

-- 2. WALå¤§å°ç›‘æ§
-- WALä½¿ç”¨ç‡ç›‘æ§ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    current_wal_size BIGINT;
    max_wal_size_bytes BIGINT;
    wal_usage_pct NUMERIC;
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'pg_current_wal_lsn') THEN
        RAISE WARNING 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
        RETURN;
    END IF;

    SELECT pg_current_wal_lsn() - '0/0' INTO current_wal_size;
    SELECT (setting::bigint * 1024 * 1024) INTO max_wal_size_bytes
    FROM pg_settings
    WHERE name = 'max_wal_size';

    IF max_wal_size_bytes > 0 THEN
        wal_usage_pct := round(100.0 * current_wal_size / max_wal_size_bytes, 2);
        RAISE NOTICE 'WALä½¿ç”¨ç‡: %', wal_usage_pct;
        IF wal_usage_pct > 80 THEN
            RAISE WARNING 'WALä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå»ºè®®æ£€æŸ¥checkpointé…ç½®';
        END IF;
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE WARNING 'pg_current_wal_lsnå‡½æ•°ä¸å­˜åœ¨';
    WHEN undefined_table THEN
        RAISE WARNING 'pg_settingsè§†å›¾ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'ç›‘æ§WALä½¿ç”¨ç‡å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    pg_size_pretty(pg_current_wal_lsn() - '0/0') as current_wal_size,
    (SELECT setting FROM pg_settings WHERE name = 'max_wal_size')::bigint * 1024 * 1024 as max_wal_size_bytes,
    round(100.0 * (pg_current_wal_lsn() - '0/0') /
          ((SELECT setting FROM pg_settings WHERE name = 'max_wal_size')::bigint * 1024 * 1024), 2) as wal_usage_pct;
-- æ‰§è¡Œæ—¶é—´: <50ms
-- è®¡åˆ’: Result

-- 3. å®¹é‡è§„åˆ’
-- æ ¹æ®å†™å…¥è´Ÿè½½è®¡ç®—åˆé€‚çš„max_wal_size
-- å…¬å¼ï¼šmax_wal_size = å†™å…¥é€Ÿç‡(MB/s) * checkpoint_timeout(ç§’) * 2ï¼ˆå®‰å…¨ç³»æ•°ï¼‰
-- ç¤ºä¾‹ï¼šå†™å…¥é€Ÿç‡50MB/sï¼Œcheckpoint_timeout=15min=900ç§’
-- max_wal_size = 50 * 900 * 2 / 1024 â‰ˆ 88GBï¼ˆå®é™…è®¾ç½®4-8GBé€šå¸¸è¶³å¤Ÿï¼‰
```

## æ¡ˆä¾‹4ï¼šåˆ†åŒºè£å‰ªä¸ç”Ÿæ•ˆ

- è¯æ®ï¼šè®¡åˆ’æ˜¾ç¤ºæ‰«ææ‰€æœ‰åˆ†åŒºï¼›è°“è¯éåˆ†åŒºé”®è¡¨è¾¾å¼ï¼›
- å˜æ›´ï¼šæ”¹å†™è°“è¯ä½¿å¯è£å‰ªã€å¢åŠ åˆ†åŒºé”®å†—ä½™åˆ—æˆ–ç”Ÿæˆåˆ—ï¼›
- æ•ˆæœï¼šè®¡åˆ’æ—¶é—´ä¸‹é™ï¼ŒI/O æ˜¾è‘—é™ä½ï¼›
- é˜²å†å‘ï¼šåˆ†åŒºè®¾è®¡è¯„å®¡ä¸æŸ¥è¯¢è§„èŒƒã€‚

### æ¡ˆä¾‹4è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

æ—¥å¿—è¡¨æŒ‰æœˆä»½åˆ†åŒºï¼ŒæŸ¥è¯¢æœ€è¿‘7å¤©çš„æ—¥å¿—æ—¶ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾ç¤ºæ‰«æäº†æ‰€æœ‰åˆ†åŒºï¼ˆ12ä¸ªæœˆï¼‰ï¼ŒæŸ¥è¯¢æ—¶é—´ä»é¢„æœŸçš„å‡ ç§’å¢åŠ åˆ°å‡ åˆ†é’Ÿã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥åˆ†åŒºè¡¨ç»“æ„
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE tablename LIKE 'log_entries_%'
ORDER BY tablename;

-- æ­¥éª¤2: æ‰§è¡ŒæŸ¥è¯¢å¹¶æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
-- åˆ†åŒºè£å‰ªé—®é¢˜è¯Šæ–­ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = 'log_entries'
    ) THEN
        RAISE WARNING 'è¡¨log_entriesä¸å­˜åœ¨ï¼Œè·³è¿‡è¯Šæ–­';
        RETURN;
    END IF;

    RAISE NOTICE 'æ‰§è¡ŒEXPLAINåˆ†æ...';
EXCEPTION
    WHEN undefined_table THEN
        RAISE WARNING 'è¡¨log_entriesä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ†åŒºè£å‰ªé—®é¢˜è¯Šæ–­å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM log_entries
WHERE DATE_TRUNC('month', log_time) = DATE_TRUNC('month', CURRENT_DATE);
-- æ‰§è¡Œæ—¶é—´: å–å†³äºè¡¨å¤§å°
-- è®¡åˆ’: å¯èƒ½æ— æ³•ä½¿ç”¨åˆ†åŒºè£å‰ª

-- é—®é¢˜å‘ç°ï¼š
-- - æ‰§è¡Œè®¡åˆ’æ˜¾ç¤ºï¼šSeq Scan on log_entries_2024_01, Seq Scan on log_entries_2024_02, ...
-- - æ‰«æäº†æ‰€æœ‰12ä¸ªåˆ†åŒº
-- - å®é™…åªéœ€è¦æ‰«æ1-2ä¸ªåˆ†åŒº

-- æ­¥éª¤3: æ£€æŸ¥åˆ†åŒºé”®å’Œçº¦æŸ
SELECT
    n.nspname as schema_name,
    c.relname as table_name,
    pg_get_expr(c.relpartbound, c.oid) as partition_bound
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relispartition = true
AND c.relname LIKE 'log_entries_%'
ORDER BY c.relname;

-- æ­¥éª¤4: æ£€æŸ¥æŸ¥è¯¢è°“è¯
-- é—®é¢˜ï¼šä½¿ç”¨äº†DATE_TRUNCå‡½æ•°ï¼Œä¼˜åŒ–å™¨æ— æ³•è¯†åˆ«åˆ†åŒºé”®èŒƒå›´
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: æ”¹å†™æŸ¥è¯¢è°“è¯ï¼ˆæ¨èï¼‰
-- åŸæŸ¥è¯¢ï¼ˆæ— æ³•è£å‰ªï¼‰ï¼š
SELECT * FROM log_entries
WHERE DATE_TRUNC('month', log_time) = DATE_TRUNC('month', CURRENT_DATE);

-- ä¼˜åŒ–æŸ¥è¯¢ï¼ˆå¯ä»¥è£å‰ªï¼‰ï¼š
SELECT * FROM log_entries
WHERE log_time >= DATE_TRUNC('month', CURRENT_DATE)
AND log_time < DATE_TRUNC('month', CURRENT_DATE) + interval '1 month';

-- æ–¹æ¡ˆ2: ä½¿ç”¨ç”Ÿæˆåˆ—ï¼ˆPostgreSQL 12+ï¼‰
-- æ·»åŠ ç”Ÿæˆåˆ—å­˜å‚¨æœˆä»½
ALTER TABLE log_entries ADD COLUMN log_month DATE
GENERATED ALWAYS AS (DATE_TRUNC('month', log_time)::DATE) STORED;

-- æŒ‰ç”Ÿæˆåˆ—åˆ†åŒº
CREATE TABLE log_entries_new (
    LIKE log_entries INCLUDING ALL
) PARTITION BY RANGE (log_month);

-- è¿ç§»æ•°æ®ååˆ‡æ¢è¡¨

-- æ–¹æ¡ˆ3: ä½¿ç”¨å†—ä½™åˆ—ï¼ˆå¦‚æœæ— æ³•ä½¿ç”¨ç”Ÿæˆåˆ—ï¼‰
ALTER TABLE log_entries ADD COLUMN log_month DATE;
UPDATE log_entries SET log_month = DATE_TRUNC('month', log_time)::DATE;
CREATE INDEX idx_log_entries_month ON log_entries (log_month);

-- æŸ¥è¯¢æ—¶ä½¿ç”¨å†—ä½™åˆ—
SELECT * FROM log_entries
WHERE log_month = DATE_TRUNC('month', CURRENT_DATE)::DATE;
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - æ‰«æåˆ†åŒºæ•°ï¼š12ä¸ª
-- - æ‰§è¡Œæ—¶é—´ï¼š120ç§’
-- - I/Oè¯»å–ï¼š50GB

-- ä¼˜åŒ–åï¼š
-- - æ‰«æåˆ†åŒºæ•°ï¼š1-2ä¸ªï¼ˆåªæ‰«æç›¸å…³æœˆä»½ï¼‰
-- - æ‰§è¡Œæ—¶é—´ï¼š5ç§’ï¼ˆâ†“96%ï¼‰
-- - I/Oè¯»å–ï¼š4GBï¼ˆâ†“92%ï¼‰

-- éªŒè¯åˆ†åŒºè£å‰ª
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM log_entries
WHERE log_time >= CURRENT_DATE - interval '7 days'
AND log_time < CURRENT_DATE;
-- åº”è¯¥åªæ˜¾ç¤ºç›¸å…³åˆ†åŒºçš„æ‰«æ
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. åˆ†åŒºè®¾è®¡è¯„å®¡æ¸…å•
-- - åˆ†åŒºé”®é€‰æ‹©ï¼šä½¿ç”¨å¸¸ç”¨æŸ¥è¯¢æ¡ä»¶çš„åˆ—
-- - é¿å…åœ¨åˆ†åŒºé”®ä¸Šä½¿ç”¨å‡½æ•°
-- - ä½¿ç”¨èŒƒå›´åˆ†åŒºè€Œéåˆ—è¡¨åˆ†åŒºï¼ˆå¦‚æœé€‚ç”¨ï¼‰

-- 2. æŸ¥è¯¢è§„èŒƒ
-- - é¿å…åœ¨WHEREå­å¥ä¸­å¯¹åˆ†åŒºé”®ä½¿ç”¨å‡½æ•°
-- - ä½¿ç”¨èŒƒå›´æŸ¥è¯¢è€Œéå‡½æ•°è°ƒç”¨
-- - ç¤ºä¾‹ï¼š
--   é”™è¯¯ï¼šWHERE DATE_TRUNC('month', log_time) = ...
--   æ­£ç¡®ï¼šWHERE log_time >= ... AND log_time < ...

-- 3. ç›‘æ§åˆ†åŒºè£å‰ª
-- æ£€æŸ¥æ‰§è¡Œè®¡åˆ’æ˜¯å¦ä½¿ç”¨äº†åˆ†åŒºè£å‰ª
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan
FROM pg_stat_user_tables
WHERE tablename LIKE 'log_entries_%'
ORDER BY seq_scan DESC;
-- å¦‚æœæ‰€æœ‰åˆ†åŒºéƒ½æœ‰seq_scanï¼Œè¯´æ˜åˆ†åŒºè£å‰ªå¯èƒ½ä¸ç”Ÿæ•ˆ
```

## æ¡ˆä¾‹5ï¼šç»Ÿè®¡ä¿¡æ¯ç¼ºå¤±å¯¼è‡´Bitmapå †ä½æ•ˆ

- è¯æ®ï¼šä¼°ç®—åå·®ã€Bitmap Heap Recheck è¿‡å¤šï¼›
- å˜æ›´ï¼šæå‡ `default_statistics_target`ï¼Œé’ˆå¯¹åˆ—è®¾ç½®æ›´é«˜ç»Ÿè®¡ï¼›
- æ•ˆæœï¼šå›è¡¨å‡å°‘ï¼ŒP95 ä¸‹é™ï¼›
- é˜²å†å‘ï¼šæ‰¹é‡å¯¼å…¥å ANALYZEã€å®šæœŸç»Ÿè®¡ç»´æŠ¤ã€‚

### æ¡ˆä¾‹5è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

ç”¨æˆ·è¡¨æŸ¥è¯¢æ€§èƒ½ä¸‹é™ï¼ŒEXPLAINæ˜¾ç¤ºå¤§é‡"Bitmap Heap Recheck"ï¼Œå®é™…æ‰§è¡Œæ—¶é—´æ¯”ä¼°ç®—æ—¶é—´é«˜10å€ä»¥ä¸Šã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ‰§è¡ŒæŸ¥è¯¢å¹¶æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users
WHERE age BETWEEN 25 AND 35
AND city = 'Beijing'
AND status = 'active';

-- é—®é¢˜å‘ç°ï¼š
-- - ä½¿ç”¨Bitmap Index Scan + Bitmap Heap Scan
-- - Bitmap Heap Recheck: 50000 rowsï¼ˆå¤§é‡å›è¡¨ï¼‰
-- - ä¼°ç®—è¡Œæ•°ï¼š5000è¡Œï¼ˆå®é™…ï¼š50000è¡Œï¼Œåå·®10å€ï¼‰

-- æ­¥éª¤2: æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE tablename = 'users'
AND attname IN ('age', 'city', 'status');

-- å‘ç°ï¼š
-- - ageåˆ—ï¼šn_distinct = -1ï¼ˆè¡¨ç¤ºå”¯ä¸€å€¼å¾ˆå¤šï¼‰ï¼Œä½†ç›´æ–¹å›¾ä¸å¤Ÿè¯¦ç»†
-- - cityåˆ—ï¼šmost_common_valsåªæœ‰10ä¸ªå€¼ï¼ˆå®é™…æœ‰100+åŸå¸‚ï¼‰
-- - ç»Ÿè®¡ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œå¯¼è‡´ä¼°ç®—åå·®

-- æ­¥éª¤3: æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
SELECT
    schemaname,
    tablename,
    attname,
    attstattarget
FROM pg_attribute a
JOIN pg_class c ON a.attrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE c.relname = 'users'
AND a.attname IN ('age', 'city', 'status')
AND a.attnum > 0;

-- å‘ç°ï¼šattstattarget = -1ï¼ˆä½¿ç”¨é»˜è®¤å€¼100ï¼‰ï¼Œå¯¹äºå¤§è¡¨ä¸å¤Ÿ
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- 1. æå‡é»˜è®¤ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
ALTER SYSTEM SET default_statistics_target = 500;  -- ä»100å¢åŠ åˆ°500
SELECT pg_reload_conf();

-- 2. é’ˆå¯¹ç‰¹å®šåˆ—è®¾ç½®æ›´é«˜ç»Ÿè®¡ç²¾åº¦
ALTER TABLE users ALTER COLUMN age SET STATISTICS 1000;
ALTER TABLE users ALTER COLUMN city SET STATISTICS 500;
ALTER TABLE users ALTER COLUMN status SET STATISTICS 200;

-- 3. åˆ›å»ºæ‰©å±•ç»Ÿè®¡ï¼ˆPostgreSQL 10+ï¼‰
-- å¯¹äºå¤šåˆ—ç»„åˆæŸ¥è¯¢ï¼Œåˆ›å»ºæ‰©å±•ç»Ÿè®¡
CREATE STATISTICS users_age_city_dependencies
ON age, city
FROM users;

CREATE STATISTICS users_city_status_dependencies
ON city, status
FROM users;

-- 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;

-- 5. éªŒè¯ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    array_length(most_common_vals, 1) as mcv_count,
    array_length(histogram_bounds, 1) as histogram_buckets
FROM pg_stats
WHERE tablename = 'users'
AND attname IN ('age', 'city', 'status');
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - ä¼°ç®—è¡Œæ•°ï¼š5000è¡Œ
-- - å®é™…è¡Œæ•°ï¼š50000è¡Œ
-- - Bitmap Heap Recheckï¼š50000è¡Œ
-- - æ‰§è¡Œæ—¶é—´ï¼š2ç§’

-- ä¼˜åŒ–åï¼š
-- - ä¼°ç®—è¡Œæ•°ï¼š48000è¡Œï¼ˆæ›´å‡†ç¡®ï¼‰
-- - å®é™…è¡Œæ•°ï¼š50000è¡Œ
-- - Bitmap Heap Recheckï¼š50000è¡Œï¼ˆä½†ä¼˜åŒ–å™¨é€‰æ‹©äº†æ›´å¥½çš„è®¡åˆ’ï¼‰
-- - æ‰§è¡Œæ—¶é—´ï¼š0.5ç§’ï¼ˆâ†“75%ï¼‰

-- éªŒè¯æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM users
WHERE age BETWEEN 25 AND 35
AND city = 'Beijing'
AND status = 'active';
-- åº”è¯¥çœ‹åˆ°æ›´å‡†ç¡®çš„ä¼°ç®—å’Œæ›´å¥½çš„æ‰§è¡Œè®¡åˆ’
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. æ‰¹é‡å¯¼å…¥åè‡ªåŠ¨ANALYZE
-- åœ¨å¯¼å…¥è„šæœ¬ä¸­æ·»åŠ 
COPY users FROM '/path/to/users.csv' WITH (FORMAT csv, HEADER);
ANALYZE users;

-- æˆ–ä½¿ç”¨pg_cronå®šæœŸANALYZE
SELECT cron.schedule('analyze-users', '0 3 * * *', 'ANALYZE users;');

-- 2. ç›‘æ§ç»Ÿè®¡ä¿¡æ¯æ—¶æ•ˆæ€§
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze,
    n_live_tup,
    n_mod_since_analyze,
    round(100.0 * n_mod_since_analyze / NULLIF(n_live_tup, 0), 2) as mod_ratio
FROM pg_stat_user_tables
WHERE n_mod_since_analyze > n_live_tup * 0.1  -- å˜æ›´è¶…è¿‡10%
ORDER BY mod_ratio DESC;

-- 3. ç»Ÿè®¡ä¿¡æ¯å‘Šè­¦
-- Prometheuså‘Šè­¦ï¼šè¡¨ç»Ÿè®¡ä¿¡æ¯è¶…è¿‡7å¤©æœªæ›´æ–°
-- alert: PostgreSQLStaleStatistics
-- expr: (now() - pg_stat_user_tables_last_autoanalyze) > 7d
```

## æ¡ˆä¾‹6ï¼šRLS ç­–ç•¥è¯¯é…å½±å“è®¡åˆ’

- è¯æ®ï¼šæ¯æ¬¡è®¿é—®é™„å¸¦å¤æ‚ç­–ç•¥è¿‡æ»¤ï¼Œè®¡åˆ’å˜æ…¢ï¼›
- å˜æ›´ï¼šä¼˜åŒ–ç­–ç•¥ä¸ºå¯ç´¢å¼•è°“è¯ï¼Œå¿…è¦æ—¶ç­–ç•¥åˆ†å±‚æˆ–ç»•è¿‡åªè¯»æŠ¥è¡¨ï¼›
- æ•ˆæœï¼šTP95 æ˜æ˜¾ä¸‹é™ï¼›
- é˜²å†å‘ï¼šRLS å˜æ›´è¯„å®¡ä¸è®¡åˆ’å¯¹æ¯”ã€‚

### æ¡ˆä¾‹6è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

å¤šç§Ÿæˆ·ç³»ç»Ÿå¯ç”¨RLSï¼ˆRow Level Securityï¼‰åï¼ŒæŸ¥è¯¢æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼ŒP95å»¶è¿Ÿä»100mså¢åŠ åˆ°800msã€‚æ‰€æœ‰æŸ¥è¯¢éƒ½å˜æ…¢ï¼Œå³ä½¿ç®€å•çš„SELECTæŸ¥è¯¢ã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥RLSç­–ç•¥
SELECT
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies
WHERE tablename = 'orders';

-- å‘ç°ï¼šç­–ç•¥ä½¿ç”¨äº†å¤æ‚çš„å­æŸ¥è¯¢å’Œå‡½æ•°è°ƒç”¨
-- CREATE POLICY tenant_isolation ON orders
-- FOR ALL
-- TO application_role
-- USING (
--     tenant_id IN (
--         SELECT tenant_id FROM user_tenants
--         WHERE user_id = current_setting('app.user_id')::integer
--     )
-- );

-- æ­¥éª¤2: æ‰§è¡ŒæŸ¥è¯¢å¹¶æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders WHERE order_date >= CURRENT_DATE - interval '7 days';

-- é—®é¢˜å‘ç°ï¼š
-- - æ‰§è¡Œè®¡åˆ’åŒ…å«SubPlanï¼ˆå­æŸ¥è¯¢è®¡åˆ’ï¼‰
-- - æ¯æ¬¡æ‰«æè¡Œéƒ½è¦æ‰§è¡Œå­æŸ¥è¯¢
-- - æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–

-- æ­¥éª¤3: æ£€æŸ¥ç­–ç•¥å¯¹æ€§èƒ½çš„å½±å“
SET row_security = on;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders LIMIT 100;

SET row_security = off;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders LIMIT 100;
-- å¯¹æ¯”æ‰§è¡Œæ—¶é—´å·®å¼‚
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: ä¼˜åŒ–ç­–ç•¥ä¸ºå¯ç´¢å¼•è°“è¯ï¼ˆæ¨èï¼‰
-- åŸç­–ç•¥ï¼ˆå¤æ‚å­æŸ¥è¯¢ï¼‰ï¼š
DROP POLICY IF EXISTS tenant_isolation ON orders;
CREATE POLICY tenant_isolation ON orders
FOR ALL
TO application_role
USING (tenant_id = current_setting('app.tenant_id')::integer);
-- ä½¿ç”¨ç®€å•çš„ç­‰å€¼æ¯”è¾ƒï¼Œå¯ä»¥åˆ›å»ºç´¢å¼•

-- åˆ›å»ºç´¢å¼•æ”¯æŒç­–ç•¥
CREATE INDEX idx_orders_tenant_id ON orders (tenant_id);

-- æ–¹æ¡ˆ2: ä½¿ç”¨å‡½æ•°è¿”å›ç§Ÿæˆ·åˆ—è¡¨ï¼ˆå¦‚æœå¿…é¡»æ”¯æŒå¤šç§Ÿæˆ·ï¼‰
CREATE OR REPLACE FUNCTION get_user_tenants()
RETURNS TABLE(tenant_id integer) AS $$
BEGIN
    RETURN QUERY
    SELECT ut.tenant_id
    FROM user_tenants ut
    WHERE ut.user_id = current_setting('app.user_id')::integer;
END;
$$ LANGUAGE plpgsql STABLE;

-- ä¼˜åŒ–ç­–ç•¥
DROP POLICY IF EXISTS tenant_isolation ON orders;
CREATE POLICY tenant_isolation ON orders
FOR ALL
TO application_role
USING (tenant_id = ANY(get_user_tenants()));
-- STABLEå‡½æ•°å¯ä»¥æ›´å¥½åœ°ä¼˜åŒ–

-- æ–¹æ¡ˆ3: ç­–ç•¥åˆ†å±‚ï¼ˆåªè¯»æŠ¥è¡¨ä½¿ç”¨ä¸åŒç­–ç•¥ï¼‰
-- ä¸ºåªè¯»æŠ¥è¡¨åˆ›å»ºä¸“ç”¨ç­–ç•¥
CREATE POLICY tenant_isolation_readonly ON orders
FOR SELECT
TO readonly_role
USING (tenant_id = current_setting('app.tenant_id')::integer);

-- æ–¹æ¡ˆ4: ç»•è¿‡RLSï¼ˆä»…ç”¨äºåªè¯»æŠ¥è¡¨ï¼Œè°¨æ…ä½¿ç”¨ï¼‰
-- åˆ›å»ºç»•è¿‡RLSçš„è§†å›¾
CREATE VIEW orders_readonly AS
SELECT * FROM orders;

-- æˆäºˆåªè¯»è§’è‰²è®¿é—®è§†å›¾ï¼ˆä¸åº”ç”¨RLSï¼‰
GRANT SELECT ON orders_readonly TO readonly_role;
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - P95å»¶è¿Ÿï¼š800ms
-- - æ‰§è¡Œè®¡åˆ’ï¼šåŒ…å«SubPlanï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•
-- - CPUä½¿ç”¨ç‡ï¼šé«˜ï¼ˆæ¯æ¬¡è¡Œéƒ½è¦æ‰§è¡Œå­æŸ¥è¯¢ï¼‰

-- ä¼˜åŒ–åï¼š
-- - P95å»¶è¿Ÿï¼š120msï¼ˆâ†“85%ï¼‰
-- - æ‰§è¡Œè®¡åˆ’ï¼šä½¿ç”¨Index Scan
-- - CPUä½¿ç”¨ç‡ï¼šæ­£å¸¸

-- éªŒè¯æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders WHERE order_date >= CURRENT_DATE - interval '7 days';
-- åº”è¯¥çœ‹åˆ°Index Scanè€ŒéSeq Scan + SubPlan
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. RLSç­–ç•¥è¯„å®¡æ¸…å•
-- - é¿å…åœ¨ç­–ç•¥ä¸­ä½¿ç”¨å­æŸ¥è¯¢
-- - ä½¿ç”¨ç®€å•çš„ç­‰å€¼æˆ–èŒƒå›´æ¯”è¾ƒ
-- - ç¡®ä¿ç­–ç•¥æ¡ä»¶å¯ä»¥åˆ›å»ºç´¢å¼•
-- - ä½¿ç”¨STABLEå‡½æ•°è€ŒéVOLATILEå‡½æ•°

-- 2. ç­–ç•¥å˜æ›´å‰åå¯¹æ¯”æ‰§è¡Œè®¡åˆ’
-- å˜æ›´å‰è®°å½•
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders LIMIT 100;

-- å˜æ›´åå¯¹æ¯”
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT * FROM orders LIMIT 100;

-- 3. ç›‘æ§RLSæ€§èƒ½å½±å“
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
WHERE tablename = 'orders';
-- å¦‚æœseq_scanæ˜¾è‘—å¢åŠ ï¼Œå¯èƒ½æ˜¯RLSç­–ç•¥å½±å“
```

## æ¡ˆä¾‹7ï¼šå¤–é”®ç¼ºç´¢å¼•å¯¼è‡´å†™æ”¾å¤§

- è¯æ®ï¼šæ’å…¥/æ›´æ–°å¤–é”®è¡Œæ—¶é˜»å¡ä¸å…¨è¡¨æ‰«æï¼›
- å˜æ›´ï¼šä¸ºå¤–é”®åˆ—è¡¥å……ç´¢å¼•ï¼›
- æ•ˆæœï¼šå†™å»¶è¿Ÿä¸‹é™ï¼Œé”ç­‰å¾…å‡å°‘ï¼›
- é˜²å†å‘ï¼šDDL å®¡è®¡è§„åˆ™å¼ºåˆ¶å¤–é”®å»ºç´¢å¼•ã€‚

### æ¡ˆä¾‹7è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

è®¢å•è¡¨æ’å…¥æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å³°æœŸï¼Œæ’å…¥å»¶è¿Ÿä»10mså¢åŠ åˆ°500msã€‚åŒæ—¶å‡ºç°é”ç­‰å¾…ï¼Œå½±å“å…¶ä»–æŸ¥è¯¢ã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥è¡¨ç»“æ„
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_name = 'orders';

-- å‘ç°ï¼šordersè¡¨æœ‰å¤–é”®çº¦æŸ
-- - user_id REFERENCES users(id)
-- - product_id REFERENCES products(id)

-- æ­¥éª¤2: æ£€æŸ¥å¤–é”®åˆ—æ˜¯å¦æœ‰ç´¢å¼•
SELECT
    t.relname AS table_name,
    a.attname AS column_name,
    i.relname AS index_name
FROM pg_class t
JOIN pg_attribute a ON a.attrelid = t.oid
LEFT JOIN pg_index ix ON ix.indrelid = t.oid AND a.attnum = ANY(ix.indkey)
LEFT JOIN pg_class i ON i.oid = ix.indexrelid
WHERE t.relname = 'orders'
AND a.attname IN ('user_id', 'product_id')
AND a.attnum > 0;

-- å‘ç°ï¼šå¤–é”®åˆ—æ²¡æœ‰ç´¢å¼•

-- æ­¥éª¤3: æ£€æŸ¥æ’å…¥æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
INSERT INTO orders (user_id, product_id, amount, order_date)
VALUES (100, 200, 99.99, NOW());

-- é—®é¢˜å‘ç°ï¼š
-- - æ’å…¥æ—¶éœ€è¦æ£€æŸ¥å¤–é”®çº¦æŸ
-- - ç”±äºæ²¡æœ‰ç´¢å¼•ï¼Œéœ€è¦å…¨è¡¨æ‰«æuserså’Œproductsè¡¨
-- - å¯¼è‡´é”ç­‰å¾…å’Œæ€§èƒ½ä¸‹é™

-- æ­¥éª¤4: æ£€æŸ¥é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.query AS blocked_query,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- 1. ä¸ºå¤–é”®åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX CONCURRENTLY idx_orders_user_id ON orders (user_id);
CREATE INDEX CONCURRENTLY idx_orders_product_id ON orders (product_id);

-- 2. éªŒè¯ç´¢å¼•åˆ›å»º
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'orders'
AND indexname LIKE 'idx_orders_%';

-- 3. å¦‚æœå¤–é”®åˆ—ç»å¸¸ä¸€èµ·æŸ¥è¯¢ï¼Œåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX CONCURRENTLY idx_orders_user_product
ON orders (user_id, product_id);
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - æ’å…¥å»¶è¿Ÿï¼š500ms
-- - é”ç­‰å¾…ï¼šé¢‘ç¹
-- - å¤–é”®æ£€æŸ¥ï¼šå…¨è¡¨æ‰«æ

-- ä¼˜åŒ–åï¼š
-- - æ’å…¥å»¶è¿Ÿï¼š15msï¼ˆâ†“97%ï¼‰
-- - é”ç­‰å¾…ï¼šæ˜¾è‘—å‡å°‘
-- - å¤–é”®æ£€æŸ¥ï¼šç´¢å¼•æ‰«æ

-- éªŒè¯æ’å…¥æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
INSERT INTO orders (user_id, product_id, amount, order_date)
VALUES (100, 200, 99.99, NOW());
-- åº”è¯¥çœ‹åˆ°Index Scanè€ŒéSeq Scan
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. DDLå®¡è®¡è§„åˆ™ï¼ˆä½¿ç”¨è§¦å‘å™¨æˆ–æ‰©å±•ï¼‰
-- æ£€æŸ¥æ–°åˆ›å»ºçš„å¤–é”®æ˜¯å¦æœ‰ç´¢å¼•
CREATE OR REPLACE FUNCTION check_foreign_key_index()
RETURNS TRIGGER AS $$
DECLARE
    fk_record RECORD;
    index_exists BOOLEAN;
BEGIN
    -- æ£€æŸ¥æ‰€æœ‰å¤–é”®çº¦æŸ
    FOR fk_record IN
        SELECT
            tc.table_name,
            kcu.column_name,
            ccu.table_name AS foreign_table_name
        FROM information_schema.table_constraints AS tc
        JOIN information_schema.key_column_usage AS kcu
            ON tc.constraint_name = kcu.constraint_name
        JOIN information_schema.constraint_column_usage AS ccu
            ON ccu.constraint_name = tc.constraint_name
        WHERE tc.constraint_type = 'FOREIGN KEY'
        AND tc.table_schema = 'public'
    LOOP
        -- æ£€æŸ¥æ˜¯å¦æœ‰ç´¢å¼•
        SELECT EXISTS (
            SELECT 1
            FROM pg_indexes
            WHERE tablename = fk_record.table_name
            AND indexdef LIKE '%' || fk_record.column_name || '%'
        ) INTO index_exists;

        IF NOT index_exists THEN
            RAISE WARNING 'Foreign key % on %(%) missing index',
                fk_record.table_name,
                fk_record.column_name,
                fk_record.foreign_table_name;
        END IF;
    END LOOP;

    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- 2. å®šæœŸæ£€æŸ¥å¤–é”®ç´¢å¼•
SELECT
    tc.table_name,
    kcu.column_name,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM pg_indexes
            WHERE tablename = tc.table_name
            AND indexdef LIKE '%' || kcu.column_name || '%'
        ) THEN 'HAS INDEX'
        ELSE 'MISSING INDEX'
    END as index_status
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_schema = 'public';
```

## æ¡ˆä¾‹8ï¼šé¡ºåºé”®æ’å…¥çƒ­ç‚¹é¡µå¯¼è‡´B-Treeåˆ†è£‚

- è¯æ®ï¼šæ’å…¥çƒ­ç‚¹é›†ä¸­ï¼Œç´¢å¼•åˆ†è£‚ä¸é¡µæŠ–åŠ¨ï¼›
- å˜æ›´ï¼šä½¿ç”¨ `fillfactor`ã€åè½¬IDæˆ–å“ˆå¸Œåˆ†å¸ƒã€åˆ†åŒºï¼›
- æ•ˆæœï¼šå†™æŠ–åŠ¨ä¸‹é™ï¼›
- é˜²å†å‘ï¼šå»ºæ¨¡é˜¶æ®µè¯„å®¡è‡ªå¢/é¡ºåºé”®ç­–ç•¥ã€‚

### æ¡ˆä¾‹8è¯¦ç»†å±•å¼€

**é—®é¢˜æè¿°**:

ä½¿ç”¨è‡ªå¢IDä½œä¸ºä¸»é”®çš„è®¢å•è¡¨ï¼Œåœ¨é«˜å¹¶å‘å†™å…¥æ—¶å‡ºç°æ€§èƒ½æŠ–åŠ¨ï¼Œæ’å…¥å»¶è¿Ÿä»5mså‘¨æœŸæ€§å¢åŠ åˆ°200msï¼ŒI/Oä½¿ç”¨ç‡å‡ºç°å°–åˆºã€‚

**è¯Šæ–­è¿‡ç¨‹**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥è¡¨ç»“æ„
SELECT
    c.relname,
    a.attname,
    a.attnum,
    CASE
        WHEN a.attnum = (SELECT indkey[1] FROM pg_index WHERE indrelid = c.oid AND indisprimary)
        THEN 'PRIMARY KEY'
        ELSE 'NOT PK'
    END as is_pk
FROM pg_class c
JOIN pg_attribute a ON a.attrelid = c.oid
WHERE c.relname = 'orders'
AND a.attnum > 0
AND NOT a.attisdropped;

-- å‘ç°ï¼šä½¿ç”¨BIGSERIALï¼ˆè‡ªå¢ï¼‰ä½œä¸ºä¸»é”®

-- æ­¥éª¤2: æ£€æŸ¥ç´¢å¼•ç»“æ„
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'orders'
AND indexname LIKE '%_pkey';

-- æ­¥éª¤3: æ£€æŸ¥æ’å…¥æ¨¡å¼
SELECT
    COUNT(*) as total_inserts,
    MIN(id) as min_id,
    MAX(id) as max_id,
    MAX(id) - MIN(id) as id_range
FROM orders
WHERE created_at >= CURRENT_DATE;

-- å‘ç°ï¼šIDæ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œæ‰€æœ‰æ’å…¥éƒ½é›†ä¸­åœ¨ç´¢å¼•çš„å³ä¾§ï¼ˆçƒ­ç‚¹é¡µï¼‰

-- æ­¥éª¤4: æ£€æŸ¥I/Oå’Œé”ç­‰å¾…
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;

-- å‘ç°ï¼šå¤§é‡I/Oç­‰å¾…å’ŒB-treeé¡µé¢åˆ†è£‚
```

**å˜æ›´æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: ä½¿ç”¨fillfactorå‡å°‘é¡µé¢åˆ†è£‚ï¼ˆæ¨èï¼Œç®€å•ï¼‰
ALTER TABLE orders SET (fillfactor = 90);  -- é¢„ç•™10%ç©ºé—´
-- éœ€è¦é‡å»ºè¡¨æ‰èƒ½ç”Ÿæ•ˆ
CLUSTER orders USING orders_pkey;

-- æ–¹æ¡ˆ2: ä½¿ç”¨UUIDæ›¿ä»£è‡ªå¢IDï¼ˆå¦‚æœä¸šåŠ¡å…è®¸ï¼‰
-- åˆ›å»ºæ–°è¡¨ä½¿ç”¨UUID
CREATE TABLE orders_new (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- å…¶ä»–åˆ—...
) WITH (fillfactor = 90);

-- æ–¹æ¡ˆ3: ä½¿ç”¨åå‘IDï¼ˆPostgreSQLç‰¹æœ‰æŠ€å·§ï¼‰
-- å°†è‡ªå¢IDåè½¬å­˜å‚¨
CREATE TABLE orders_new (
    id BIGSERIAL PRIMARY KEY,
    reversed_id BIGINT GENERATED ALWAYS AS ((-id)) STORED,
    -- å…¶ä»–åˆ—...
);

-- åœ¨reversed_idä¸Šåˆ›å»ºç´¢å¼•ç”¨äºæŸ¥è¯¢
CREATE INDEX idx_orders_reversed_id ON orders_new (reversed_id);

-- æ–¹æ¡ˆ4: ä½¿ç”¨å“ˆå¸Œåˆ†å¸ƒï¼ˆå¦‚æœæŸ¥è¯¢æ¨¡å¼å…è®¸ï¼‰
-- ä½¿ç”¨å“ˆå¸Œå‡½æ•°åˆ†æ•£æ’å…¥
CREATE TABLE orders_new (
    id BIGSERIAL,
    hash_id INTEGER GENERATED ALWAYS AS (hashtext(id::text) % 1000) STORED,
    PRIMARY KEY (id, hash_id)
) PARTITION BY HASH (hash_id);

-- æ–¹æ¡ˆ5: ä½¿ç”¨æ—¶é—´åˆ†åŒºï¼ˆå¦‚æœæŸ¥è¯¢æŒ‰æ—¶é—´èŒƒå›´ï¼‰
CREATE TABLE orders_new (
    id BIGSERIAL,
    created_at TIMESTAMP NOT NULL,
    -- å…¶ä»–åˆ—...
) PARTITION BY RANGE (created_at);

-- æŒ‰æœˆåˆ†åŒºï¼Œåˆ†æ•£å†™å…¥çƒ­ç‚¹
CREATE TABLE orders_2024_01 PARTITION OF orders_new
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

**æ•ˆæœéªŒè¯**:

```sql
-- ä¼˜åŒ–å‰ï¼š
-- - æ’å…¥å»¶è¿Ÿï¼šå‘¨æœŸæ€§5-200ms
-- - I/Oä½¿ç”¨ç‡ï¼šå‘¨æœŸæ€§å°–åˆº
-- - ç´¢å¼•åˆ†è£‚ï¼šé¢‘ç¹

-- ä¼˜åŒ–åï¼ˆä½¿ç”¨fillfactorï¼‰ï¼š
-- - æ’å…¥å»¶è¿Ÿï¼šç¨³å®šåœ¨5-10ms
-- - I/Oä½¿ç”¨ç‡ï¼šå¹³æ»‘
-- - ç´¢å¼•åˆ†è£‚ï¼šå‡å°‘

-- éªŒè¯æ’å…¥æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS)
INSERT INTO orders (user_id, product_id, amount, order_date)
VALUES (100, 200, 99.99, NOW());
```

**é˜²å†å‘æªæ–½**:

```sql
-- 1. å»ºæ¨¡é˜¶æ®µè¯„å®¡æ¸…å•
-- - è¯„ä¼°æ˜¯å¦éœ€è¦è‡ªå¢ID
-- - è€ƒè™‘ä½¿ç”¨UUIDï¼ˆå¦‚æœåˆ†å¸ƒå¼ç³»ç»Ÿï¼‰
-- - è€ƒè™‘ä½¿ç”¨æ—¶é—´åˆ†åŒºåˆ†æ•£å†™å…¥
-- - è¯„ä¼°fillfactorè®¾ç½®

-- 2. ç›‘æ§æ’å…¥çƒ­ç‚¹
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_tup_ins > 1000000  -- é«˜æ’å…¥è´Ÿè½½
ORDER BY n_tup_ins DESC;

-- 3. æ£€æŸ¥ç´¢å¼•è†¨èƒ€ï¼ˆçƒ­ç‚¹å†™å…¥å¯¼è‡´ï¼‰
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as index_size,
    pg_size_pretty(pg_relation_size(tablename::regclass)) as table_size,
    round(100.0 * pg_relation_size(indexname::regclass) /
          NULLIF(pg_relation_size(tablename::regclass), 0), 2) as size_ratio
FROM pg_indexes
WHERE tablename = 'orders'
ORDER BY pg_relation_size(indexname::regclass) DESC;
```

---

## æ¡ˆä¾‹æ€»ç»“ä¸ç´¢å¼•

### é—®é¢˜ç±»å‹ç´¢å¼•

| æ¡ˆä¾‹ | é—®é¢˜ç±»å‹ | ä¸»è¦ç—‡çŠ¶ | å…³é”®æŒ‡æ ‡ | è§£å†³ç­–ç•¥ |
|------|---------|---------|---------|---------|
| æ¡ˆä¾‹1 | ä¼°ç®—åå·® | é”™è¯¯è¿æ¥é¡ºåºã€Seq Scan | P95å»¶è¿Ÿâ†‘ã€CPUä½¿ç”¨ç‡â†‘ | æå‡ç»Ÿè®¡ç²¾åº¦ã€æ‰©å±•ç»Ÿè®¡ã€è¡¨è¾¾å¼ç´¢å¼• |
| æ¡ˆä¾‹2 | é”ç­‰å¾…é“¾ | å»¶è¿Ÿå°–åˆºã€è¶…æ—¶ç‡â†‘ | P99å»¶è¿Ÿâ†‘ã€é”ç­‰å¾…æ•°â†‘ | æ‹†åˆ†DDLã€æ‰¹é‡å†™åºåŒ–ã€åˆç†ç´¢å¼• |
| æ¡ˆä¾‹3 | æ£€æŸ¥ç‚¹é¢‘ç¹ | I/OæŠ–åŠ¨ã€WALç§¯å‹ | æ£€æŸ¥ç‚¹é¢‘ç‡â†‘ã€I/Oç­‰å¾…â†‘ | è°ƒæ•´checkpointå‚æ•°ã€ä¼˜åŒ–WALé…ç½® |
| æ¡ˆä¾‹4 | åˆ†åŒºè£å‰ªå¤±æ•ˆ | å…¨è¡¨æ‰«æã€æŸ¥è¯¢æ…¢ | æ‰«æè¡Œæ•°â†‘ã€æ‰§è¡Œæ—¶é—´â†‘ | ä¿®å¤åˆ†åŒºé”®ã€ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶ |
| æ¡ˆä¾‹5 | ç»Ÿè®¡ä¿¡æ¯ç¼ºå¤± | Bitmapå †ä½æ•ˆ | ç¼“å†²åŒºå‘½ä¸­ç‡â†“ã€I/Oâ†‘ | æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€åˆ›å»ºç´¢å¼• |
| æ¡ˆä¾‹6 | RLSç­–ç•¥è¯¯é… | è®¡åˆ’ç¼“å­˜å¤±æ•ˆ | è®¡åˆ’æ—¶é—´â†‘ã€æ‰§è¡Œæ—¶é—´â†‘ | ä¼˜åŒ–RLSç­–ç•¥ã€ä½¿ç”¨ç¨³å®šå‡½æ•° |
| æ¡ˆä¾‹7 | å¤–é”®ç¼ºç´¢å¼• | å†™æ”¾å¤§ã€é”ç«äº‰ | æ’å…¥å»¶è¿Ÿâ†‘ã€é”ç­‰å¾…â†‘ | åœ¨å¤–é”®åˆ—åˆ›å»ºç´¢å¼• |
| æ¡ˆä¾‹8 | é¡ºåºé”®çƒ­ç‚¹ | æ’å…¥æŠ–åŠ¨ã€I/Oå°–åˆº | æ’å…¥å»¶è¿Ÿå‘¨æœŸæ€§â†‘ã€I/Oå°–åˆº | fillfactorã€UUIDã€åå‘IDã€åˆ†åŒº |

### è¯Šæ–­å·¥å…·ç´¢å¼•

| å·¥å…·/è§†å›¾ | ç”¨é€” | é€‚ç”¨æ¡ˆä¾‹ |
|----------|------|---------|
| `pg_stat_statements` | æ…¢æŸ¥è¯¢è¯†åˆ« | æ¡ˆä¾‹1, æ¡ˆä¾‹2, æ¡ˆä¾‹4, æ¡ˆä¾‹5 |
| `EXPLAIN (ANALYZE, BUFFERS, TIMING)` | æ‰§è¡Œè®¡åˆ’åˆ†æ | æ¡ˆä¾‹1, æ¡ˆä¾‹4, æ¡ˆä¾‹5, æ¡ˆä¾‹6 |
| `pg_locks` | é”ç­‰å¾…åˆ†æ | æ¡ˆä¾‹2, æ¡ˆä¾‹7 |
| `pg_stat_archiver` | å½’æ¡£çŠ¶æ€æ£€æŸ¥ | æ¡ˆä¾‹3 |
| `pg_stat_bgwriter` | æ£€æŸ¥ç‚¹ç»Ÿè®¡ | æ¡ˆä¾‹3 |
| `pg_stats` | ç»Ÿè®¡ä¿¡æ¯æ£€æŸ¥ | æ¡ˆä¾‹1, æ¡ˆä¾‹5 |
| `pg_stat_user_tables` | è¡¨ç»Ÿè®¡ä¿¡æ¯ | æ¡ˆä¾‹1, æ¡ˆä¾‹5, æ¡ˆä¾‹8 |
| `pg_stat_activity` | æ´»åŠ¨ä¼šè¯ç›‘æ§ | æ¡ˆä¾‹2, æ¡ˆä¾‹7, æ¡ˆä¾‹8 |

### ä¼˜åŒ–ç­–ç•¥ç´¢å¼•

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | æ¡ˆä¾‹ |
|------|---------|------|
| æå‡ç»Ÿè®¡ç²¾åº¦ | ä¼°ç®—åå·®ã€åŸºæ•°é”™è¯¯ | æ¡ˆä¾‹1, æ¡ˆä¾‹5 |
| æ‰©å±•ç»Ÿè®¡ | å¤šåˆ—ç›¸å…³æ€§ã€è¿æ¥é¡ºåºé”™è¯¯ | æ¡ˆä¾‹1 |
| è¡¨è¾¾å¼ç´¢å¼• | å‡½æ•°æŸ¥è¯¢ã€éƒ¨åˆ†ç´¢å¼• | æ¡ˆä¾‹1, æ¡ˆä¾‹4 |
| æ‹†åˆ†DDL | é”ç­‰å¾…ã€é•¿äº‹åŠ¡ | æ¡ˆä¾‹2 |
| æ‰¹é‡å†™åºåŒ– | é”ç«äº‰ã€æ­»é” | æ¡ˆä¾‹2 |
| è°ƒæ•´checkpointå‚æ•° | æ£€æŸ¥ç‚¹é¢‘ç¹ã€I/OæŠ–åŠ¨ | æ¡ˆä¾‹3 |
| ä¿®å¤åˆ†åŒºé”® | åˆ†åŒºè£å‰ªå¤±æ•ˆ | æ¡ˆä¾‹4 |
| å¤–é”®ç´¢å¼• | å¤–é”®çº¦æŸã€å†™æ”¾å¤§ | æ¡ˆä¾‹7 |
| fillfactor | é¡ºåºé”®çƒ­ç‚¹ã€é¡µé¢åˆ†è£‚ | æ¡ˆä¾‹8 |
| UUID/åå‘ID | åˆ†å¸ƒå¼ç³»ç»Ÿã€çƒ­ç‚¹åˆ†æ•£ | æ¡ˆä¾‹8 |

### é˜²å†å‘æªæ–½ç´¢å¼•

| æªæ–½ | é€‚ç”¨æ¡ˆä¾‹ | å®æ–½æ–¹æ³• |
|------|---------|---------|
| å®šæœŸANALYZE | æ¡ˆä¾‹1, æ¡ˆä¾‹5 | pg_cronå®šæ—¶ä»»åŠ¡ |
| ç»Ÿè®¡ä¿¡æ¯ç›‘æ§ | æ¡ˆä¾‹1, æ¡ˆä¾‹5 | ç›‘æ§è§†å›¾ã€å‘Šè­¦è§„åˆ™ |
| é”ç­‰å¾…å‘Šè­¦ | æ¡ˆä¾‹2, æ¡ˆä¾‹7 | Prometheuså‘Šè­¦ |
| DDLå˜æ›´çª—å£ | æ¡ˆä¾‹2 | å˜æ›´ç®¡ç†æµç¨‹ |
| æ£€æŸ¥ç‚¹ç›‘æ§ | æ¡ˆä¾‹3 | Grafanaé¢æ¿ |
| åˆ†åŒºé”®å®¡æŸ¥ | æ¡ˆä¾‹4 | è®¾è®¡è¯„å®¡ |
| RLSç­–ç•¥å®¡æŸ¥ | æ¡ˆä¾‹6 | å®‰å…¨ç­–ç•¥è¯„å®¡ |
| å¤–é”®ç´¢å¼•æ£€æŸ¥ | æ¡ˆä¾‹7 | è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬ |
| çƒ­ç‚¹ç›‘æ§ | æ¡ˆä¾‹8 | æ’å…¥æ¨¡å¼åˆ†æ |

---

## äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](./06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§æŒ‡æ ‡å’Œè¯Šæ–­æµç¨‹
- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­è½åœ°æŒ‡å—](./06.01-ç›‘æ§ä¸è¯Šæ–­.md) - Prometheus + Grafanaéƒ¨ç½²
- â­â­â­ [æ€§èƒ½è°ƒä¼˜å˜æ›´é—­ç¯](../../30-æ€§èƒ½è°ƒä¼˜/README.md) - å˜æ›´ç®¡ç†æµç¨‹
- â­â­ [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.03-æ‰§è¡Œè®¡åˆ’/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æŸ¥è¯¢ä¼˜åŒ–
- â­â­ [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.02-ç´¢å¼•ç»“æ„/02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - ç´¢å¼•ä¼˜åŒ–
- â­â­ [ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹](../../02-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.04-ç»Ÿè®¡ä¿¡æ¯/02.03-ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ä»·æ¨¡å‹.md) - ç»Ÿè®¡ä¿¡æ¯
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../11-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜æŒ‡å—

### å¤–éƒ¨èµ„æº

- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://www.postgresql.org/docs/current/performance-tips.html)
- [pg_stat_statementsæ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [PostgreSQLé”æ–‡æ¡£](https://www.postgresql.org/docs/current/explicit-locking.html)
- [PostgreSQLåˆ†åŒºæ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-partitioning.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
