---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL_View\06-æ¶æ„è®¾è®¡\é«˜å¯ç”¨æ¶æ„\é«˜å¯ç”¨æ¶æ„è®¾è®¡.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# é«˜å¯ç”¨æ¶æ„è®¾è®¡

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 06-04-01

## ğŸ“‘ ç›®å½•

- [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
- [1.2 æ¶æ„å®šä½](#12-æ¶æ„å®šä½)
- [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
- [2.1 ä¸»ä»å¤åˆ¶æ¶æ„](#21-ä¸»ä»å¤åˆ¶æ¶æ„)
- [2.2 æµå¤åˆ¶æ¶æ„](#22-æµå¤åˆ¶æ¶æ„)
- [2.3 é›†ç¾¤æ¶æ„](#23-é›†ç¾¤æ¶æ„)
- [3.1 è‡ªåŠ¨æ•…éšœè½¬ç§»](#31-è‡ªåŠ¨æ•…éšœè½¬ç§»)
- [3.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»](#32-æ‰‹åŠ¨æ•…éšœè½¬ç§»)
- [3.3 æ•…éšœæ¢å¤](#33-æ•…éšœæ¢å¤)
- [4.1 è¯»å†™åˆ†ç¦»](#41-è¯»å†™åˆ†ç¦»)
- [4.2 è¿æ¥æ± ](#42-è¿æ¥æ± )
- [4.3 è´Ÿè½½å‡è¡¡å™¨](#43-è´Ÿè½½å‡è¡¡å™¨)
- [5.1 å¥åº·æ£€æŸ¥](#51-å¥åº·æ£€æŸ¥)
- [5.2 æ€§èƒ½ç›‘æ§](#52-æ€§èƒ½ç›‘æ§)
- [5.3 å‘Šè­¦é…ç½®](#53-å‘Šè­¦é…ç½®)
- [6.1 æ¶æ„è®¾è®¡å»ºè®®](#61-æ¶æ„è®¾è®¡å»ºè®®)
- [6.2 è¿ç»´å»ºè®®](#62-è¿ç»´å»ºè®®)
- [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
- [7.2 å­¦æœ¯è®ºæ–‡](#72-å­¦æœ¯è®ºæ–‡)
- [7.3 æŠ€æœ¯åšå®¢](#73-æŠ€æœ¯åšå®¢)
- [7.4 ç›¸å…³èµ„æº](#74-ç›¸å…³èµ„æº)
- [8.1 Patroni é«˜å¯ç”¨é›†ç¾¤é…ç½®](#81-patroni-é«˜å¯ç”¨é›†ç¾¤é…ç½®)
- [8.2 æµå¤åˆ¶é…ç½®ç¤ºä¾‹](#82-æµå¤åˆ¶é…ç½®ç¤ºä¾‹)
- [8.3 HAProxy è´Ÿè½½å‡è¡¡é…ç½®](#83-haproxy-è´Ÿè½½å‡è¡¡é…ç½®)
- [7.1 æ¡ˆä¾‹ï¼šé‡‘èç³»ç»Ÿé«˜å¯ç”¨æ¶æ„å®æ–½](#71-æ¡ˆä¾‹é‡‘èç³»ç»Ÿé«˜å¯ç”¨æ¶æ„å®æ–½)
- [7.2 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°é«˜å¯ç”¨æ¶æ„å®æ–½](#72-æ¡ˆä¾‹ç”µå•†å¹³å°é«˜å¯ç”¨æ¶æ„å®æ–½)
---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

é«˜å¯ç”¨æ¶æ„éœ€è¦ä¿è¯æ•°æ®åº“æœåŠ¡çš„æŒç»­å¯ç”¨æ€§ï¼Œé€šè¿‡ä¸»ä»å¤åˆ¶ã€æ•…éšœè½¬ç§»ã€è´Ÿè½½å‡è¡¡ç­‰æŠ€æœ¯å®ç°é«˜å¯ç”¨ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2010 å¹´**: PostgreSQL 9.0 å¼•å…¥æµå¤åˆ¶
1. **2015 å¹´**: è‡ªåŠ¨æ•…éšœè½¬ç§»å·¥å…·æˆç†Ÿ
1. **2020 å¹´**: é«˜å¯ç”¨æ–¹æ¡ˆæ ‡å‡†åŒ–
1. **2025 å¹´**: PostgreSQL 18 ä¼˜åŒ–é«˜å¯ç”¨ç‰¹æ€§

### 1.2 æ¶æ„å®šä½

é«˜å¯ç”¨æ¶æ„è®¾è®¡æä¾› PostgreSQL é«˜å¯ç”¨éƒ¨ç½²æ–¹æ¡ˆï¼Œä¿è¯æœåŠ¡çš„æŒç»­å¯ç”¨æ€§ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

- **é«˜å¯ç”¨æ€§**: ä¿è¯æœåŠ¡æŒç»­å¯ç”¨
- **è‡ªåŠ¨æ¢å¤**: è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ¢å¤
- **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–è¯»å†™æ€§èƒ½
- **æ•°æ®å®‰å…¨**: ä¿è¯æ•°æ®å®‰å…¨

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ä¸»ä»å¤åˆ¶æ¶æ„

**æ¶æ„å›¾**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Primary    â”‚
â”‚  (Master)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WAL Streaming
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚   Replica   â”‚
â”‚  (Standby)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹**:

```sql
-- Primary é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†è¯´æ˜ï¼‰
-- æ³¨æ„ï¼šè¿™äº›é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡SQLæ‰§è¡Œ
DO $$
BEGIN
    RAISE NOTICE 'ä»¥ä¸‹é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®:';
    RAISE NOTICE 'wal_level = replica';
    RAISE NOTICE 'max_wal_senders = 3';
    RAISE NOTICE 'max_replication_slots = 3';
    RAISE NOTICE 'hot_standby = on (Replicaé…ç½®)';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'é…ç½®è¯´æ˜å¤±è´¥: %', SQLERRM;
END $$;
```

### 2.2 æµå¤åˆ¶æ¶æ„

**æµå¤åˆ¶é…ç½®**:

```sql
-- Primary åˆ›å»ºå¤åˆ¶ç”¨æˆ·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_roles
        WHERE rolname = 'replicator'
    ) THEN
        DROP USER replicator;
        RAISE NOTICE 'å·²åˆ é™¤ç°æœ‰ç”¨æˆ·: replicator';
    END IF;

    CREATE USER replicator WITH REPLICATION PASSWORD 'password';
    RAISE NOTICE 'å¤åˆ¶ç”¨æˆ·åˆ›å»ºæˆåŠŸ: replicator';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING 'ç”¨æˆ·replicatorå·²å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¤åˆ¶ç”¨æˆ·å¤±è´¥: %', SQLERRM;
END $$;

-- Replica é…ç½®æ¢å¤ï¼ˆåœ¨postgresql.confæˆ–recovery.confä¸­é…ç½®ï¼‰
-- primary_conninfo = 'host=primary_host port=5432 user=replicator password=password'
-- æ³¨æ„ï¼šæ­¤é…ç½®éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡SQLæ‰§è¡Œ
```

### 2.3 é›†ç¾¤æ¶æ„

**å¤šèŠ‚ç‚¹é›†ç¾¤**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Primary    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â”´â”€â”€â” â”Œâ”€â”€â”´â”€â”€â”
â”‚ R1  â”‚ â”‚ R2  â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•…éšœè½¬ç§»

### 3.1 è‡ªåŠ¨æ•…éšœè½¬ç§»

**è‡ªåŠ¨åˆ‡æ¢**:

- **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ä¸»èŠ‚ç‚¹å¥åº·
- **è‡ªåŠ¨æå‡**: ä¸»èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æå‡ä»èŠ‚ç‚¹
- **VIP åˆ‡æ¢**: è‡ªåŠ¨åˆ‡æ¢è™šæ‹Ÿ IP

### 3.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»

**æ‰‹åŠ¨åˆ‡æ¢æ­¥éª¤**:

1. åœæ­¢ä¸»èŠ‚ç‚¹å†™å…¥
1. æå‡ä»èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹
1. æ›´æ–°åº”ç”¨è¿æ¥é…ç½®
1. å¯åŠ¨æ–°ä¸»èŠ‚ç‚¹

### 3.3 æ•…éšœæ¢å¤

**æ¢å¤æµç¨‹**:

1. ä¿®å¤æ•…éšœèŠ‚ç‚¹
1. é‡æ–°åŒæ­¥æ•°æ®
1. é…ç½®ä¸ºä»èŠ‚ç‚¹
1. åŠ å…¥é›†ç¾¤

---

## 4. è´Ÿè½½å‡è¡¡

### 4.1 è¯»å†™åˆ†ç¦»

**è¯»å†™åˆ†ç¦»é…ç½®**:

```python
# ä½¿ç”¨è¿æ¥æ± å®ç°è¯»å†™åˆ†ç¦»
from sqlalchemy import create_engine

# å†™è¿æ¥ï¼ˆä¸»èŠ‚ç‚¹ï¼‰
write_engine = create_engine("postgresql://user:pass@primary/db")

# è¯»è¿æ¥ï¼ˆä»èŠ‚ç‚¹ï¼‰
read_engine = create_engine("postgresql://user:pass@replica/db")
```

### 4.2 è¿æ¥æ± 

**è¿æ¥æ± é…ç½®**:

```python
from sqlalchemy.pool import QueuePool

engine = create_engine(
    connection_string,
    poolclass=QueuePool,
    pool_size=10,
    max_overflow=20
)
```

### 4.3 è´Ÿè½½å‡è¡¡å™¨

**è´Ÿè½½å‡è¡¡é…ç½®**:

- **PgBouncer**: è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡
- **HAProxy**: é«˜å¯ç”¨è´Ÿè½½å‡è¡¡
- **Keepalived**: VIP ç®¡ç†

---

## 5. ç›‘æ§ä¸å‘Šè­¦

### 5.1 å¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥**:

```sql
-- æ£€æŸ¥ä¸»èŠ‚ç‚¹çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    is_in_recovery BOOLEAN;
BEGIN
    SELECT pg_is_in_recovery() INTO is_in_recovery;

    IF is_in_recovery THEN
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹å¤„äºæ¢å¤æ¨¡å¼ï¼ˆStandbyï¼‰';
    ELSE
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_is_in_recoveryå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥ä¸»èŠ‚ç‚¹çŠ¶æ€å¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT pg_is_in_recovery();
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result

-- æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½æµ‹è¯•ï¼‰
DO $$
DECLARE
    replication_lag INTERVAL;
BEGIN
    IF pg_is_in_recovery() THEN
        SELECT now() - pg_last_xact_replay_timestamp() INTO replication_lag;
        RAISE NOTICE 'å¤åˆ¶å»¶è¿Ÿ: %', replication_lag;
    ELSE
        RAISE NOTICE 'å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œæ— å¤åˆ¶å»¶è¿Ÿ';
    END IF;
EXCEPTION
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_last_xact_replay_timestampå‡½æ•°ä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿå¤±è´¥: %', SQLERRM;
END $$;

EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS replication_lag_seconds;
-- æ‰§è¡Œæ—¶é—´: <1ms
-- è®¡åˆ’: Result
```

### 5.2 æ€§èƒ½ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:

- **è¿æ¥æ•°**: å½“å‰è¿æ¥æ•°
- **æŸ¥è¯¢æ€§èƒ½**: æŸ¥è¯¢å»¶è¿Ÿ
- **å¤åˆ¶å»¶è¿Ÿ**: ä¸»ä»å¤åˆ¶å»¶è¿Ÿ
- **èµ„æºä½¿ç”¨**: CPUã€å†…å­˜ã€ç£ç›˜

### 5.3 å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™**:

- **ä¸»èŠ‚ç‚¹æ•…éšœ**: ä¸»èŠ‚ç‚¹ä¸å¯ç”¨å‘Šè­¦
- **å¤åˆ¶å»¶è¿Ÿ**: å¤åˆ¶å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼å‘Šè­¦
- **èµ„æºå‘Šè­¦**: èµ„æºä½¿ç”¨è¶…è¿‡é˜ˆå€¼å‘Šè­¦

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¶æ„è®¾è®¡å»ºè®®

- **å†—ä½™è®¾è®¡**: è‡³å°‘ 2 ä¸ªä»èŠ‚ç‚¹
- **åœ°ç†åˆ†å¸ƒ**: è·¨åœ°åŸŸéƒ¨ç½²
- **è‡ªåŠ¨åˆ‡æ¢**: é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»

### 6.2 è¿ç»´å»ºè®®

- **å®šæœŸæ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®å®Œå–„çš„ç›‘æ§å‘Šè­¦
- **å¤‡ä»½ç­–ç•¥**: åˆ¶å®šå¤‡ä»½å’Œæ¢å¤ç­–ç•¥

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL é«˜å¯ç”¨æ–‡æ¡£](https://www.postgresql.org/docs/current/high-availability.html)**
  - ç‰ˆæœ¬: PostgreSQL 9.0+
  - å†…å®¹: PostgreSQL é«˜å¯ç”¨éƒ¨ç½²çš„å®Œæ•´æŒ‡å—
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL æµå¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/warm-standby.html)**
  - å†…å®¹: PostgreSQL æµå¤åˆ¶çš„è¯¦ç»†è¯´æ˜å’Œé…ç½®æ–¹æ³•

- **[PostgreSQL é€»è¾‘å¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/logical-replication.html)**
  - å†…å®¹: PostgreSQL é€»è¾‘å¤åˆ¶çš„å®Œæ•´æ–‡æ¡£

### 7.2 å­¦æœ¯è®ºæ–‡

- **Gray, J., & Reuter, A. (1993). "Transaction Processing: Concepts and Techniques."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: é«˜å¯ç”¨ç³»ç»Ÿçš„ç†è®ºåŸºç¡€

### 7.3 æŠ€æœ¯åšå®¢

- **[Patroni é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ](https://patroni.readthedocs.io/)**
  - æ¥æº: Patroni
  - å†…å®¹: Patroni çš„å®Œæ•´æ–‡æ¡£ï¼Œç”¨äºå®ç° PostgreSQL é«˜å¯ç”¨é›†ç¾¤

- **[PgBouncer è¿æ¥æ± ](https://www.pgbouncer.org/)**
  - å†…å®¹: PgBouncer è¿æ¥æ± çš„æ–‡æ¡£ï¼Œç”¨äºé«˜å¯ç”¨æ¶æ„ä¸­çš„è¿æ¥ç®¡ç†

- **[HAProxy è´Ÿè½½å‡è¡¡](http://www.haproxy.org/)**
  - å†…å®¹: HAProxy çš„æ–‡æ¡£ï¼Œç”¨äº PostgreSQL é«˜å¯ç”¨æ¶æ„ä¸­çš„è´Ÿè½½å‡è¡¡

### 7.4 ç›¸å…³èµ„æº

- **[PostgreSQL é«˜å¯ç”¨æ¶æ„æ¨¡å¼](https://www.postgresql.org/docs/current/high-availability.html)**
  - å†…å®¹: å„ç§é«˜å¯ç”¨æ¶æ„æ¨¡å¼çš„å¯¹æ¯”å’Œé€‰æ‹©æŒ‡å—

- **[Keepalived VIP ç®¡ç†](https://www.keepalived.org/)**
  - å†…å®¹: Keepalived çš„æ–‡æ¡£ï¼Œç”¨äºè™šæ‹Ÿ IP ç®¡ç†

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 Patroni é«˜å¯ç”¨é›†ç¾¤é…ç½®

**Patroni é…ç½®æ–‡ä»¶ (patroni.yml)**:

```yaml
scope: postgres_cluster
namespace: /db/
name: postgres-node-1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.10:8008

etcd3:
  hosts: 192.168.1.20:2379,192.168.1.21:2379,192.168.1.22:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        max_connections: 100
        max_prepared_transactions: 0
        max_locks_per_transaction: 64
        wal_level: replica
        hot_standby: "on"
        wal_keep_segments: 8
        max_wal_senders: 3
        max_replication_slots: 3
        checkpoint_timeout: 15min
        wal_log_hints: "on"

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.1.10:5432
  data_dir: /var/lib/postgresql/14/main
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: secret
    superuser:
      username: postgres
      password: secret
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```

**Patroni é›†ç¾¤ç®¡ç†è„šæœ¬**:

```python
import requests
import json
from typing import Dict, List

class PatroniClusterManager:
    """Patroni é«˜å¯ç”¨é›†ç¾¤ç®¡ç†å™¨"""

    def __init__(self, patroni_url: str):
        self.patroni_url = patroni_url.rstrip('/')

    def get_cluster_status(self) -> Dict:
        """è·å–é›†ç¾¤çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.get(f"{self.patroni_url}/cluster", timeout=10)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"è·å–Patronié›†ç¾¤çŠ¶æ€å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"è§£æPatronié›†ç¾¤çŠ¶æ€å¤±è´¥: {e}")

    def get_node_status(self, node_name: str) -> Dict:
        """è·å–èŠ‚ç‚¹çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.get(f"{self.patroni_url}/patroni/{node_name}", timeout=10)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"è·å–PatronièŠ‚ç‚¹çŠ¶æ€å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"è§£æPatronièŠ‚ç‚¹çŠ¶æ€å¤±è´¥: {e}")

    def get_leader(self) -> Dict:
        """è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            cluster = self.get_cluster_status()
            for member in cluster.get('members', []):
                if member.get('role') == 'Leader':
                    return member
            return None
        except Exception as e:
            raise Exception(f"è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥: {e}")

    def failover(self, candidate: str = None) -> Dict:
        """æ‰§è¡Œæ•…éšœè½¬ç§»ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            url = f"{self.patroni_url}/cluster"
            data = {'candidate': candidate} if candidate else {}
            response = requests.post(f"{url}/failover", json=data, timeout=30)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"æ‰§è¡Œæ•…éšœè½¬ç§»å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"æ•…éšœè½¬ç§»æ“ä½œå¤±è´¥: {e}")

    def restart_node(self, node_name: str) -> Dict:
        """é‡å¯èŠ‚ç‚¹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.post(f"{self.patroni_url}/patroni/{node_name}/restart", timeout=60)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"é‡å¯PatronièŠ‚ç‚¹å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"é‡å¯èŠ‚ç‚¹æ“ä½œå¤±è´¥: {e}")

    def reload_config(self, node_name: str) -> Dict:
        """é‡æ–°åŠ è½½é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.post(f"{self.patroni_url}/patroni/{node_name}/reload", timeout=30)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"é‡æ–°åŠ è½½Patronié…ç½®å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"é‡æ–°åŠ è½½é…ç½®æ“ä½œå¤±è´¥: {e}")

# ä½¿ç”¨ç¤ºä¾‹
manager = PatroniClusterManager("http://192.168.1.10:8008")

# è·å–é›†ç¾¤çŠ¶æ€
status = manager.get_cluster_status()
print(f"é›†ç¾¤çŠ¶æ€: {status}")

# è·å–ä¸»èŠ‚ç‚¹
leader = manager.get_leader()
print(f"ä¸»èŠ‚ç‚¹: {leader}")

# æ‰§è¡Œæ•…éšœè½¬ç§»
failover_result = manager.failover()
print(f"æ•…éšœè½¬ç§»ç»“æœ: {failover_result}")
```

### 8.2 æµå¤åˆ¶é…ç½®ç¤ºä¾‹

**ä¸»åº“é…ç½® (postgresql.conf)**:

```conf
# æµå¤åˆ¶é…ç½®
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on
wal_keep_segments = 32
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'

# è¿æ¥é…ç½®
listen_addresses = '*'
port = 5432
```

**ä¸»åº“ pg_hba.conf**:

```conf
# å…è®¸å¤åˆ¶è¿æ¥
host    replication     replicator      192.168.1.0/24         md5
```

**ä»åº“é…ç½® (recovery.conf)**:

```conf
standby_mode = 'on'
primary_conninfo = 'host=192.168.1.10 port=5432 user=replicator password=secret'
primary_slot_name = 'standby_slot'
trigger_file = '/tmp/postgresql.trigger'
```

**Python æµå¤åˆ¶ç®¡ç†è„šæœ¬**:

```python
import psycopg2
from typing import Dict, List

class StreamingReplicationManager:
    """æµå¤åˆ¶ç®¡ç†å™¨"""

    def __init__(self, primary_conn_str: str):
        self.primary_conn = psycopg2.connect(primary_conn_str)
        self.primary_cur = self.primary_conn.cursor()

    def create_replication_slot(self, slot_name: str) -> Dict:
        """åˆ›å»ºå¤åˆ¶æ§½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            # æ£€æŸ¥å¤åˆ¶æ§½æ˜¯å¦å·²å­˜åœ¨
            self.primary_cur.execute(
                "SELECT slot_name FROM pg_replication_slots WHERE slot_name = %s",
                (slot_name,)
            )
            if self.primary_cur.fetchone():
                raise ValueError(f"å¤åˆ¶æ§½ {slot_name} å·²å­˜åœ¨")

            self.primary_cur.execute(
                "SELECT * FROM pg_create_physical_replication_slot(%s)",
                (slot_name,)
            )
            result = self.primary_cur.fetchone()
            self.primary_conn.commit()
            return {
                'slot_name': result[0],
                'plugin': result[1],
                'slot_type': result[2],
                'active': result[3]
            }
        except psycopg2.Error as e:
            self.primary_conn.rollback()
            raise Exception(f"åˆ›å»ºå¤åˆ¶æ§½å¤±è´¥: {e}")
        except Exception as e:
            self.primary_conn.rollback()
            raise

    def get_replication_slots(self) -> List[Dict]:
        """è·å–æ‰€æœ‰å¤åˆ¶æ§½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            self.primary_cur.execute("""
                SELECT
                    slot_name,
                    plugin,
                    slot_type,
                    active,
                    restart_lsn,
                    confirmed_flush_lsn
                FROM pg_replication_slots
            """)

            slots = []
            for row in self.primary_cur.fetchall():
                slots.append({
                    'slot_name': row[0],
                    'plugin': row[1],
                    'slot_type': row[2],
                    'active': row[3],
                    'restart_lsn': str(row[4]) if row[4] else None,
                    'confirmed_flush_lsn': str(row[5]) if row[5] else None
                })
            return slots
        except psycopg2.Error as e:
            raise Exception(f"è·å–å¤åˆ¶æ§½å¤±è´¥: {e}")
        except Exception as e:
            raise

    def get_replication_status(self) -> List[Dict]:
        """è·å–å¤åˆ¶çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            self.primary_cur.execute("""
                SELECT
                    pid,
                    usename,
                    application_name,
                    client_addr,
                    state,
                    sync_state,
                    sync_priority,
                    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
                    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag,
                    pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag,
                    pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag
                FROM pg_stat_replication
            """)

            replications = []
            for row in self.primary_cur.fetchall():
                replications.append({
                    'pid': row[0],
                    'username': row[1],
                    'application_name': row[2],
                    'client_addr': row[3],
                    'state': row[4],
                    'sync_state': row[5],
                    'sync_priority': row[6],
                    'sent_lag': row[7],
                    'write_lag': row[8],
                    'flush_lag': row[9],
                    'replay_lag': row[10]
                })
            return replications
        except psycopg2.Error as e:
            raise Exception(f"è·å–å¤åˆ¶çŠ¶æ€å¤±è´¥: {e}")
        except Exception as e:
            raise

    def promote_standby(self, standby_conn_str: str):
        """æå‡ä»åº“ä¸ºä¸»åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        standby_conn = None
        try:
            standby_conn = psycopg2.connect(standby_conn_str)
            standby_cur = standby_conn.cursor()

            # æ£€æŸ¥æ˜¯å¦å¤„äºæ¢å¤æ¨¡å¼
            standby_cur.execute("SELECT pg_is_in_recovery()")
            is_in_recovery = standby_cur.fetchone()[0]

            if not is_in_recovery:
                raise ValueError("å½“å‰èŠ‚ç‚¹ä¸æ˜¯ä»åº“ï¼Œæ— æ³•æå‡")

            standby_cur.execute("SELECT pg_promote()")
            result = standby_cur.fetchone()[0]
            standby_conn.commit()

            if result:
                print("ä»åº“å·²æå‡ä¸ºä¸»åº“")
            else:
                raise Exception("pg_promote()è¿”å›Falseï¼Œæå‡å¤±è´¥")
        except psycopg2.Error as e:
            if standby_conn:
                standby_conn.rollback()
            raise Exception(f"æå‡ä»åº“å¤±è´¥: {e}")
        except Exception as e:
            if standby_conn:
                standby_conn.rollback()
            raise
        finally:
            if standby_conn:
                standby_conn.close()

# ä½¿ç”¨ç¤ºä¾‹
manager = StreamingReplicationManager(
    "host=192.168.1.10 dbname=postgres user=postgres password=secret"
)

# åˆ›å»ºå¤åˆ¶æ§½
slot = manager.create_replication_slot('standby_slot')
print(f"å¤åˆ¶æ§½å·²åˆ›å»º: {slot}")

# è·å–å¤åˆ¶çŠ¶æ€
status = manager.get_replication_status()
for rep in status:
    print(f"å¤åˆ¶çŠ¶æ€: {rep['application_name']}, å»¶è¿Ÿ: {rep['replay_lag']} bytes")
```

### 8.3 HAProxy è´Ÿè½½å‡è¡¡é…ç½®

**HAProxy é…ç½®æ–‡ä»¶ (haproxy.cfg)**:

```conf
global
    log /dev/log local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend postgres_frontend
    bind *:5432
    default_backend postgres_backend

backend postgres_backend
    option pgsql-check user postgres
    balance roundrobin
    server postgres1 192.168.1.10:5432 check
    server postgres2 192.168.1.11:5432 check backup
    server postgres3 192.168.1.12:5432 check backup

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
```

**HAProxy ç®¡ç†è„šæœ¬**:

```python
import requests
from typing import Dict, List

class HAProxyManager:
    """HAProxy ç®¡ç†å™¨"""

    def __init__(self, stats_url: str):
        self.stats_url = stats_url.rstrip('/')

    def get_stats(self) -> List[Dict]:
        """è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.get(f"{self.stats_url}/stats;csv", timeout=10)
            response.raise_for_status()  # æ£€æŸ¥HTTPé”™è¯¯

            lines = response.text.strip().split('\n')
            if not lines:
                raise ValueError("HAProxyç»Ÿè®¡ä¿¡æ¯ä¸ºç©º")

            # è§£æ CSV
            stats = []
            headers = lines[0].split(',')
            for line in lines[1:]:
                if not line.strip():
                    continue
                values = line.split(',')
                if len(values) != len(headers):
                    continue  # è·³è¿‡æ ¼å¼ä¸æ­£ç¡®çš„è¡Œ
                stat = dict(zip(headers, values))
                stats.append(stat)
            return stats
        except requests.exceptions.RequestException as e:
            raise Exception(f"è·å–HAProxyç»Ÿè®¡ä¿¡æ¯å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"è§£æHAProxyç»Ÿè®¡ä¿¡æ¯å¤±è´¥: {e}")

    def get_backend_servers(self, backend_name: str = 'postgres_backend') -> List[Dict]:
        """è·å–åç«¯æœåŠ¡å™¨çŠ¶æ€ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            stats = self.get_stats()
            servers = []
            for stat in stats:
                if stat.get('svname') != 'BACKEND' and stat.get('pxname') == backend_name:
                    servers.append({
                        'name': stat.get('svname'),
                        'status': stat.get('status'),
                        'check_status': stat.get('check_status'),
                        'sessions': stat.get('scur'),
                        'bytes_in': stat.get('bin'),
                        'bytes_out': stat.get('bout')
                    })
            return servers
        except Exception as e:
            raise Exception(f"è·å–åç«¯æœåŠ¡å™¨çŠ¶æ€å¤±è´¥: {e}")

    def enable_server(self, backend: str, server: str):
        """å¯ç”¨æœåŠ¡å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.get(
                f"{self.stats_url}/stats",
                params={'backend': backend, 'server': server, 'action': 'enable'},
                timeout=10
            )
            response.raise_for_status()
            return response.status_code == 200
        except requests.exceptions.RequestException as e:
            raise Exception(f"å¯ç”¨æœåŠ¡å™¨å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"å¯ç”¨æœåŠ¡å™¨æ“ä½œå¤±è´¥: {e}")

    def disable_server(self, backend: str, server: str):
        """ç¦ç”¨æœåŠ¡å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
        try:
            response = requests.get(
                f"{self.stats_url}/stats",
                params={'backend': backend, 'server': server, 'action': 'disable'},
                timeout=10
            )
            response.raise_for_status()
            return response.status_code == 200
        except requests.exceptions.RequestException as e:
            raise Exception(f"ç¦ç”¨æœåŠ¡å™¨å¤±è´¥: {e}")
        except Exception as e:
            raise Exception(f"ç¦ç”¨æœåŠ¡å™¨æ“ä½œå¤±è´¥: {e}")

# ä½¿ç”¨ç¤ºä¾‹
haproxy = HAProxyManager("http://192.168.1.5:8404")

# è·å–åç«¯æœåŠ¡å™¨çŠ¶æ€
servers = haproxy.get_backend_servers()
for server in servers:
    print(f"æœåŠ¡å™¨ {server['name']}: {server['status']}")

# ç¦ç”¨æœåŠ¡å™¨
haproxy.disable_server('postgres_backend', 'postgres2')
```

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šé‡‘èç³»ç»Ÿé«˜å¯ç”¨æ¶æ„å®æ–½

**ä¸šåŠ¡åœºæ™¯**:

æŸé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **æ•°æ®è§„æ¨¡**: 50TB
- **äº¤æ˜“é‡**: æ¯ç§’10000ç¬”
- **å¯ç”¨æ€§è¦æ±‚**: 99.99%
- **æ•…éšœæ¢å¤æ—¶é—´**: <2åˆ†é’Ÿ

**é«˜å¯ç”¨æ¶æ„**:

```sql
-- 1. é…ç½®ä¸»ä»æµå¤åˆ¶ï¼ˆå¸¦é”™è¯¯å¤„ç†è¯´æ˜ï¼‰
-- æ³¨æ„ï¼šè¿™äº›é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡SQLæ‰§è¡Œ
DO $$
BEGIN
    RAISE NOTICE 'ä»¥ä¸‹é…ç½®éœ€è¦åœ¨postgresql.confæ–‡ä»¶ä¸­è®¾ç½®:';
    RAISE NOTICE 'wal_level = replica';
    RAISE NOTICE 'max_wal_senders = 5';
    RAISE NOTICE 'max_replication_slots = 5';
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'é…ç½®è¯´æ˜å¤±è´¥: %', SQLERRM;
END $$;

-- 2. åˆ›å»ºå¤åˆ¶æ§½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_replication_slots
        WHERE slot_name = 'standby_slot'
    ) THEN
        RAISE NOTICE 'å¤åˆ¶æ§½standby_slotå·²å­˜åœ¨';
        RETURN;
    END IF;

    PERFORM pg_create_physical_replication_slot('standby_slot');
    RAISE NOTICE 'å¤åˆ¶æ§½åˆ›å»ºæˆåŠŸ: standby_slot';
EXCEPTION
    WHEN duplicate_object THEN
        RAISE WARNING 'å¤åˆ¶æ§½standby_slotå·²å­˜åœ¨';
    WHEN undefined_function THEN
        RAISE EXCEPTION 'pg_create_physical_replication_slotå‡½æ•°ä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼Œéœ€è¦è¶…çº§ç”¨æˆ·æƒé™';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'åˆ›å»ºå¤åˆ¶æ§½å¤±è´¥: %', SQLERRM;
END $$;

-- 3. é…ç½®Patroniè‡ªåŠ¨æ•…éšœè½¬ç§»
-- patroni.yml
scope: postgres_cluster
namespace: /db/
name: postgres1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.10:8008

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
  initdb:
    - encoding: UTF8
    - locale: en_US.UTF-8
  pg_hba:
    - host replication replicator 192.168.1.0/24 md5
    - host all all 0.0.0.0/0 md5
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **ç³»ç»Ÿå¯ç”¨æ€§** | 99.5% | **99.99%** | **+0.49%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 30åˆ†é’Ÿ | **<2åˆ†é’Ÿ** | **93%** â¬‡ï¸ |
| **æ•°æ®ä¸¢å¤±é£é™©** | é«˜ | **æä½** | **æ˜¾è‘—é™ä½** |
| **RPO** | 1å°æ—¶ | **<1åˆ†é’Ÿ** | **98%** â¬‡ï¸ |

### 7.2 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°é«˜å¯ç”¨æ¶æ„å®æ–½

**ä¸šåŠ¡åœºæ™¯**:

æŸå¤§å‹ç”µå•†å¹³å°ï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **æ•°æ®è§„æ¨¡**: 200TB
- **æŸ¥è¯¢QPS**: 50000
- **å¯ç”¨æ€§è¦æ±‚**: 99.95%
- **è¯»å†™åˆ†ç¦»**: æ”¯æŒè¯»å†™åˆ†ç¦»

**é«˜å¯ç”¨æ¶æ„**:

```sql
-- 1. é…ç½®è¯»å†™åˆ†ç¦»
-- ä½¿ç”¨HAProxyå®ç°è¯»å†™åˆ†ç¦»
-- haproxy.cfg
global
    log /dev/log local0
    maxconn 4096

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# å†™æœåŠ¡ï¼ˆä¸»åº“ï¼‰
frontend postgres_write
    bind *:5432
    default_backend postgres_master

backend postgres_master
    option pgsql-check user postgres
    server postgres1 192.168.1.10:5432 check

# è¯»æœåŠ¡ï¼ˆä»åº“ï¼‰
frontend postgres_read
    bind *:5433
    default_backend postgres_slaves
    balance roundrobin

backend postgres_slaves
    option pgsql-check user postgres
    server postgres2 192.168.1.11:5432 check
    server postgres3 192.168.1.12:5432 check
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **ç³»ç»Ÿå¯ç”¨æ€§** | 99.0% | **99.97%** | **+0.97%** |
| **æŸ¥è¯¢ååé‡** | 20000 QPS | **50000+ QPS** | **2.5å€** â¬†ï¸ |
| **æ•…éšœæ¢å¤æ—¶é—´** | 1å°æ—¶ | **<5åˆ†é’Ÿ** | **92%** â¬‡ï¸ |
| **è¯»å†™åˆ†ç¦»æ•ˆæœ** | ä¸æ”¯æŒ | **æ”¯æŒ** | **æ–°å¢åŠŸèƒ½** |

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
