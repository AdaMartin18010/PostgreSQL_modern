---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\å¤‡ä»½ä¸æ¢å¤\06.06-å¤‡ä»½ä¸æ¢å¤.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# å¤‡ä»½ä¸æ¢å¤

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°
> ğŸ†• **PostgreSQL 18 æ–°ç‰¹æ€§**
>
> PostgreSQL 18å¼•å…¥äº†**å¢é‡å¤‡ä»½**åŠŸèƒ½ï¼Œå¯æ˜¾è‘—å‡å°‘å¤‡ä»½æ—¶é—´ï¼ˆæœ€å¤š95%ï¼‰å’Œå­˜å‚¨ç©ºé—´ï¼ˆæœ€å¤š99%ï¼‰ï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„é‡å¤§æ”¹è¿›ï¼

---

## ğŸ“‹ ç›®å½•

- [å¤‡ä»½ä¸æ¢å¤](#å¤‡ä»½ä¸æ¢å¤)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç­–ç•¥æ€»è§ˆ](#1-ç­–ç•¥æ€»è§ˆ)
    - [1.1 å¤‡ä»½ç­–ç•¥é€‰æ‹©](#11-å¤‡ä»½ç­–ç•¥é€‰æ‹©)
  - [2. é€»è¾‘å¤‡ä»½](#2-é€»è¾‘å¤‡ä»½)
    - [2.1 é€»è¾‘å¤‡ä»½è¯¦è§£](#21-é€»è¾‘å¤‡ä»½è¯¦è§£)
  - [3. ç‰©ç†å¤‡ä»½ä¸WALå½’æ¡£](#3-ç‰©ç†å¤‡ä»½ä¸walå½’æ¡£)
    - [3.1 WALå½’æ¡£é…ç½®è¯¦è§£](#31-walå½’æ¡£é…ç½®è¯¦è§£)
    - [3.2 ç‰©ç†å¤‡ä»½è¯¦è§£](#32-ç‰©ç†å¤‡ä»½è¯¦è§£)
    - [3.3 ç‰©ç†å¤‡ä»½æ¢å¤](#33-ç‰©ç†å¤‡ä»½æ¢å¤)
  - [4. å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰](#4-å¢é‡å¤‡ä»½postgresql-18æ–°ç‰¹æ€§)
    - [4.1 åŠŸèƒ½è¯´æ˜](#41-åŠŸèƒ½è¯´æ˜)
    - [4.2 åŸºæœ¬ä½¿ç”¨](#42-åŸºæœ¬ä½¿ç”¨)
    - [4.3 ç”Ÿäº§ç¯å¢ƒå¤‡ä»½ç­–ç•¥](#43-ç”Ÿäº§ç¯å¢ƒå¤‡ä»½ç­–ç•¥)
      - [ç­–ç•¥Aï¼šå‘¨å…¨é‡ + æ—¥å¢é‡](#ç­–ç•¥aå‘¨å…¨é‡--æ—¥å¢é‡)
      - [ç­–ç•¥Bï¼šæœˆå…¨é‡ + æ—¥å¢é‡](#ç­–ç•¥bæœˆå…¨é‡--æ—¥å¢é‡)
    - [4.4 æ€§èƒ½å¯¹æ¯”](#44-æ€§èƒ½å¯¹æ¯”)
    - [4.5 æ¢å¤æµç¨‹](#45-æ¢å¤æµç¨‹)
    - [4.6 ç›‘æ§ä¸å‘Šè­¦](#46-ç›‘æ§ä¸å‘Šè­¦)
    - [4.7 æœ€ä½³å®è·µ](#47-æœ€ä½³å®è·µ)
      - [âœ… DO - æ¨èåšæ³•](#-do---æ¨èåšæ³•)
      - [âŒ DON'T - é¿å…åšæ³•](#-dont---é¿å…åšæ³•)
    - [4.8 æ•…éšœæ’æŸ¥](#48-æ•…éšœæ’æŸ¥)
      - [é—®é¢˜1: å¢é‡å¤‡ä»½å¤±è´¥](#é—®é¢˜1-å¢é‡å¤‡ä»½å¤±è´¥)
      - [é—®é¢˜2: æ¢å¤æ—¶ç¼ºå°‘ä¸­é—´å¤‡ä»½](#é—®é¢˜2-æ¢å¤æ—¶ç¼ºå°‘ä¸­é—´å¤‡ä»½)
      - [é—®é¢˜3: å­˜å‚¨ç©ºé—´ä¸è¶³](#é—®é¢˜3-å­˜å‚¨ç©ºé—´ä¸è¶³)
    - [4.9 ç”Ÿäº§æ¡ˆä¾‹](#49-ç”Ÿäº§æ¡ˆä¾‹)
      - [æ¡ˆä¾‹ï¼šç”µå•†å¹³å°ï¼ˆ5TBæ•°æ®åº“ï¼‰](#æ¡ˆä¾‹ç”µå•†å¹³å°5tbæ•°æ®åº“)
  - [5. æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰](#5-æ—¶é—´ç‚¹æ¢å¤pitr)
    - [5.1 PITRè¯¦ç»†æµç¨‹](#51-pitrè¯¦ç»†æµç¨‹)
    - [5.2 PITRæ•…éšœæ’æŸ¥](#52-pitræ•…éšœæ’æŸ¥)
  - [5. ç¾å¤‡ä¸æ¼”ç»ƒ](#5-ç¾å¤‡ä¸æ¼”ç»ƒ)
    - [5.1 çº§è”å¤åˆ¶é…ç½®](#51-çº§è”å¤åˆ¶é…ç½®)
    - [5.2 ç¾å¤‡æ¼”ç»ƒSOP](#52-ç¾å¤‡æ¼”ç»ƒsop)
  - [6. åˆè§„ä¸å®‰å…¨](#6-åˆè§„ä¸å®‰å…¨)
    - [6.1 å¤‡ä»½åŠ å¯†](#61-å¤‡ä»½åŠ å¯†)
    - [6.2 å¤‡ä»½ç•™å­˜ç­–ç•¥](#62-å¤‡ä»½ç•™å­˜ç­–ç•¥)
    - [6.3 å¤‡ä»½å®¡è®¡](#63-å¤‡ä»½å®¡è®¡)
  - [7. å¸¸è§é—®é¢˜](#7-å¸¸è§é—®é¢˜)
    - [7.1 å½’æ¡£å µå¡é—®é¢˜](#71-å½’æ¡£å µå¡é—®é¢˜)
    - [7.2 åŸºçº¿è¿‡æ—§é—®é¢˜](#72-åŸºçº¿è¿‡æ—§é—®é¢˜)
    - [7.3 è·¨ç‰ˆæœ¬è¿˜åŸ](#73-è·¨ç‰ˆæœ¬è¿˜åŸ)
  - [8. äº¤å‰å¼•ç”¨](#8-äº¤å‰å¼•ç”¨)
    - [ç‰ˆæœ¬ç‰¹æ€§](#ç‰ˆæœ¬ç‰¹æ€§)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
    - [8.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#81-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)

---

## 1. ç­–ç•¥æ€»è§ˆ

- **é€»è¾‘å¤‡ä»½**ï¼š`pg_dump/pg_restore`ï¼Œé€‚åˆç»“æ„è¿ç§»ä¸å°ä¸­è§„æ¨¡æ•°æ®
- **ç‰©ç†å¤‡ä»½**ï¼š`pg_basebackup` + WAL å½’æ¡£ï¼Œé€‚åˆå¤§è§„æ¨¡ä¸PITR
- **å¢é‡å¤‡ä»½** (â­ PG17æ–°å¢)ï¼šä»…å¤‡ä»½å˜æ›´æ•°æ®ï¼Œå¤§å¹…å‡å°‘å¤‡ä»½æ—¶é—´å’Œå­˜å‚¨
- **é¢‘æ¬¡ä¸RPO/RTO**ï¼šå…¨é‡ + å¢é‡ï¼ˆWALï¼‰ï¼ŒæŒ‰ä¸šåŠ¡SLAåˆ¶å®šçª—å£ï¼›å¤šåŒºåŸŸ/å¤šå‰¯æœ¬å†—ä½™

### 1.1 å¤‡ä»½ç­–ç•¥é€‰æ‹©

| å¤‡ä»½ç±»å‹ | é€‚ç”¨åœºæ™¯ | å¤‡ä»½æ—¶é—´ | æ¢å¤æ—¶é—´ | å­˜å‚¨ç©ºé—´ | PostgreSQLç‰ˆæœ¬ |
|---------|---------|---------|---------|---------|--------------|
| é€»è¾‘å¤‡ä»½ | å°å‹æ•°æ®åº“(<100GB) | ä¸­ç­‰ | æ…¢ | ä¸­ç­‰ | æ‰€æœ‰ç‰ˆæœ¬ |
| ç‰©ç†å…¨é‡å¤‡ä»½ | ä¸­å¤§å‹æ•°æ®åº“ | é•¿ | å¿« | å¤§ | æ‰€æœ‰ç‰ˆæœ¬ |
| **å¢é‡å¤‡ä»½** | **å¤§å‹æ•°æ®åº“(>500GB)** | **æå¿«** â­ | **å¿«** | **æå°** â­ | **18+** |
| WALå½’æ¡£ | PITRéœ€æ±‚ | æŒç»­ | å¿« | æŒç»­å¢é•¿ | æ‰€æœ‰ç‰ˆæœ¬ |

## 2. é€»è¾‘å¤‡ä»½

```bash
# å•åº“é€»è¾‘å¤‡ä»½
pg_dump -h <host> -U <user> -F c -j 4 -d mydb -f mydb_$(date +%F).dump

# è¿˜åŸ
pg_restore -h <host> -U <user> -j 4 -d mydb_restored mydb_2025-09-11.dump
```

### 2.1 é€»è¾‘å¤‡ä»½è¯¦è§£

**å¤‡ä»½æ ¼å¼é€‰æ‹©**:

```bash
# æ ¼å¼1: è‡ªå®šä¹‰æ ¼å¼ï¼ˆæ¨èï¼Œæ”¯æŒå¹¶è¡Œæ¢å¤ï¼‰
pg_dump -F c -j 4 -d mydb -f mydb.dump
# ä¼˜ç‚¹ï¼šæ”¯æŒå¹¶è¡Œæ¢å¤ã€å‹ç¼©ã€é€‰æ‹©æ€§æ¢å¤
# ç¼ºç‚¹ï¼šåªèƒ½ä½¿ç”¨pg_restoreæ¢å¤

# æ ¼å¼2: ç›®å½•æ ¼å¼ï¼ˆæ”¯æŒå¹¶è¡Œå¤‡ä»½å’Œæ¢å¤ï¼‰
pg_dump -F d -j 4 -d mydb -f mydb_dir
# ä¼˜ç‚¹ï¼šæ”¯æŒå¹¶è¡Œã€å¯é€‰æ‹©æ€§æ¢å¤
# ç¼ºç‚¹ï¼šç›®å½•ç»“æ„å¤æ‚

# æ ¼å¼3: SQLæ ¼å¼ï¼ˆçº¯æ–‡æœ¬ï¼‰
pg_dump -F p -d mydb -f mydb.sql
# ä¼˜ç‚¹ï¼šå¯è¯»ã€å¯ç¼–è¾‘ã€è·¨ç‰ˆæœ¬å…¼å®¹
# ç¼ºç‚¹ï¼šä¸æ”¯æŒå¹¶è¡Œã€æ–‡ä»¶å¤§

# æ ¼å¼4: Taræ ¼å¼
pg_dump -F t -d mydb -f mydb.tar
# ä¼˜ç‚¹ï¼šå‹ç¼©ã€å¯é€‰æ‹©æ€§æ¢å¤
# ç¼ºç‚¹ï¼šä¸æ”¯æŒå¹¶è¡Œ
```

**å®Œæ•´å¤‡ä»½æµç¨‹**:

```bash
# 1. å•åº“å¤‡ä»½ï¼ˆæ¨èç”¨äºä¸­å°å‹æ•°æ®åº“ï¼‰
pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -j 4 \
    -d mydb \
    -f mydb_$(date +%Y%m%d_%H%M%S).dump \
    -v

# 2. å…¨åº“å¤‡ä»½ï¼ˆå¤‡ä»½æ‰€æœ‰æ•°æ®åº“ï¼‰
pg_dumpall \
    -h localhost \
    -U postgres \
    -f all_databases_$(date +%Y%m%d_%H%M%S).sql \
    -v

# 3. ä»…å¤‡ä»½ç»“æ„ï¼ˆä¸åŒ…å«æ•°æ®ï¼‰
pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -d mydb \
    -s \
    -f mydb_schema.dump

# 4. ä»…å¤‡ä»½æ•°æ®ï¼ˆä¸åŒ…å«ç»“æ„ï¼‰
pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -d mydb \
    -a \
    -f mydb_data.dump

# 5. å¤‡ä»½ç‰¹å®šè¡¨
pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -d mydb \
    -t orders \
    -t customers \
    -f specific_tables.dump

# 6. æ’é™¤ç‰¹å®šè¡¨
pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -d mydb \
    -T temp_table \
    -T log_table \
    -f exclude_tables.dump
```

**æ¢å¤æ–¹æ³•**:

```bash
# æ–¹æ³•1: ä½¿ç”¨pg_restoreæ¢å¤ï¼ˆè‡ªå®šä¹‰æ ¼å¼ï¼‰
pg_restore \
    -h localhost \
    -U postgres \
    -d mydb_restored \
    -j 4 \
    -v \
    mydb_20250911.dump

# æ–¹æ³•2: æ¢å¤åˆ°æ–°æ•°æ®åº“
createdb -h localhost -U postgres mydb_restored
pg_restore \
    -h localhost \
    -U postgres \
    -d mydb_restored \
    -j 4 \
    mydb_20250911.dump

# æ–¹æ³•3: ä»…æ¢å¤ç»“æ„
pg_restore \
    -h localhost \
    -U postgres \
    -d mydb_restored \
    -s \
    mydb_20250911.dump

# æ–¹æ³•4: ä»…æ¢å¤æ•°æ®
pg_restore \
    -h localhost \
    -U postgres \
    -d mydb_restored \
    -a \
    mydb_20250911.dump

# æ–¹æ³•5: é€‰æ‹©æ€§æ¢å¤ï¼ˆäº¤äº’å¼ï¼‰
pg_restore \
    -h localhost \
    -U postgres \
    -d mydb_restored \
    -i \
    mydb_20250911.dump

# æ–¹æ³•6: SQLæ ¼å¼æ¢å¤
psql -h localhost -U postgres -d mydb_restored -f mydb.sql
```

**æœ€ä½³å®è·µ**:

```bash
# 1. å¤‡ä»½å‰æ£€æŸ¥æ•°æ®åº“å¤§å°
psql -h localhost -U postgres -c "
SELECT
    pg_size_pretty(pg_database_size('mydb')) as db_size;
"

# 2. å¤‡ä»½æ—¶ä½¿ç”¨å‹ç¼©ï¼ˆå¦‚æœç½‘ç»œå¸¦å®½æœ‰é™ï¼‰
pg_dump -F c -Z 9 -d mydb -f mydb_compressed.dump

# 3. å¤‡ä»½åˆ°è¿œç¨‹å­˜å‚¨
pg_dump -F c -d mydb | \
    gzip | \
    aws s3 cp - s3://backup-bucket/mydb_$(date +%Y%m%d).dump.gz

# 4. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
pg_restore -l mydb_20250911.dump > backup_list.txt
# æ£€æŸ¥å¤‡ä»½åˆ—è¡¨ï¼Œç¡®è®¤æ‰€æœ‰å¯¹è±¡éƒ½åœ¨

# 5. è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
#!/bin/bash
# backup_logical.sh

DB_NAME="mydb"
BACKUP_DIR="/backup/logical"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.dump"

mkdir -p ${BACKUP_DIR}

pg_dump \
    -h localhost \
    -U postgres \
    -F c \
    -j 4 \
    -d ${DB_NAME} \
    -f ${BACKUP_FILE} \
    -v

if [ $? -eq 0 ]; then
    echo "$(date): Backup successful: ${BACKUP_FILE}" >> /var/log/postgresql/backup.log
    # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
    find ${BACKUP_DIR} -name "${DB_NAME}_*.dump" -mtime +30 -delete
else
    echo "$(date): Backup failed!" >> /var/log/postgresql/backup.log
    exit 1
fi
```

## 3. ç‰©ç†å¤‡ä»½ä¸WALå½’æ¡£

```bash
# å¼€å¯å½’æ¡£ï¼ˆpostgresql.confï¼‰
archive_mode = on
archive_command = 'test ! -f /arch/%f && cp %p /arch/%f'
wal_level = replica
max_wal_senders = 10

# åŸºç¡€å¤‡ä»½ï¼ˆåœ¨çº¿ï¼‰
pg_basebackup -h <primary> -U repl -D /data/basebackup -X stream -P -R
```

### 3.1 WALå½’æ¡£é…ç½®è¯¦è§£

**å½’æ¡£é…ç½®**:

```sql
-- postgresql.confé…ç½®
archive_mode = on
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'
wal_level = replica  -- æˆ– logicalï¼ˆé€»è¾‘å¤åˆ¶åœºæ™¯ï¼‰
max_wal_senders = 10

-- å½’æ¡£å‚æ•°è¯´æ˜ï¼š
-- %p: WALæ–‡ä»¶å®Œæ•´è·¯å¾„
-- %f: WALæ–‡ä»¶å
-- archive_command: å½’æ¡£å‘½ä»¤ï¼Œè¿”å›0è¡¨ç¤ºæˆåŠŸ

-- é«˜çº§å½’æ¡£é…ç½®
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f && gzip /archive/%f'
-- å½’æ¡£æ—¶å‹ç¼©

archive_command = 'aws s3 cp %p s3://backup-bucket/wal-archive/%f'
-- å½’æ¡£åˆ°S3

archive_command = 'rsync -av %p backup-server:/archive/%f'
-- å½’æ¡£åˆ°è¿œç¨‹æœåŠ¡å™¨
```

**å½’æ¡£ç›‘æ§**:

```sql
-- 1. æ£€æŸ¥å½’æ¡£çŠ¶æ€
SELECT
    archived_count,
    last_archived_wal,
    last_archived_time,
    failed_count,
    last_failed_wal,
    last_failed_time,
    stats_reset
FROM pg_stat_archiver;

-- 2. æ£€æŸ¥å½’æ¡£å»¶è¿Ÿ
SELECT
    pg_walfile_name(pg_current_wal_lsn()) as current_wal,
    last_archived_wal,
    CASE
        WHEN pg_walfile_name(pg_current_wal_lsn()) != last_archived_wal
        THEN 'LAG'
        ELSE 'OK'
    END as archive_status
FROM pg_stat_archiver;

-- 3. æ£€æŸ¥WALæ–‡ä»¶åˆ—è¡¨
SELECT
    name,
    size,
    modification
FROM pg_ls_waldir()
ORDER BY modification DESC
LIMIT 20;
```

### 3.2 ç‰©ç†å¤‡ä»½è¯¦è§£

**åŸºç¡€å¤‡ä»½æ–¹æ³•**:

```bash
# æ–¹æ³•1: æµå¼å¤‡ä»½ï¼ˆæ¨èï¼Œåœ¨çº¿å¤‡ä»½ï¼‰
pg_basebackup \
    -h localhost \
    -U replication \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -v \
    -F plain

# æ–¹æ³•2: Taræ ¼å¼å¤‡ä»½ï¼ˆå‹ç¼©ï¼‰
pg_basebackup \
    -h localhost \
    -U replication \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -F tar \
    -z \
    -Z 6

# æ–¹æ³•3: å¹¶è¡Œå¤‡ä»½ï¼ˆPostgreSQL 18+ï¼‰
pg_basebackup \
    -h localhost \
    -U replication \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -j 4 \
    -v

# æ–¹æ³•4: å¤‡ä»½åˆ°è¿œç¨‹ï¼ˆé€šè¿‡SSHï¼‰
pg_basebackup \
    -h localhost \
    -U replication \
    -D - \
    -X stream \
    -F tar \
    | ssh backup-server "cat > /backup/base/backup_$(date +%Y%m%d).tar"
```

**å¤‡ä»½é€‰é¡¹è¯´æ˜**:

```bash
# -D: å¤‡ä»½ç›®æ ‡ç›®å½•
# -X stream: åŒæ—¶å¤‡ä»½WALæ–‡ä»¶ï¼ˆæ¨èï¼‰
# -X fetch: å¤‡ä»½åè·å–WALæ–‡ä»¶ï¼ˆéœ€è¦ä¸¤æ¬¡è¿æ¥ï¼‰
# -P: æ˜¾ç¤ºè¿›åº¦
# -v: è¯¦ç»†è¾“å‡º
# -F plain: æ™®é€šæ ¼å¼ï¼ˆç›®å½•ç»“æ„ï¼‰
# -F tar: Taræ ¼å¼ï¼ˆå‹ç¼©ï¼‰
# -z: å‹ç¼©ï¼ˆTaræ ¼å¼ï¼‰
# -Z: å‹ç¼©çº§åˆ«ï¼ˆ0-9ï¼‰
# -j: å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°ï¼ˆPostgreSQL 18+ï¼‰
# -R: è‡ªåŠ¨é…ç½®æ¢å¤ï¼ˆåˆ›å»ºstandby.signalå’Œpostgresql.auto.confï¼‰
# -c fast: å¿«é€Ÿæ£€æŸ¥ç‚¹ï¼ˆå‡å°‘å¤‡ä»½æ—¶é—´ï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½ï¼‰
# -l: å¤‡ä»½æ ‡ç­¾
```

**å¤‡ä»½éªŒè¯**:

```bash
# 1. æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§
pg_checksums -D /backup/base/20241122_020000 --check

# 2. æ£€æŸ¥å¤‡ä»½å¤§å°
du -sh /backup/base/20241122_020000

# 3. æ£€æŸ¥å¤‡ä»½å†…å®¹
ls -lh /backup/base/20241122_020000/

# 4. éªŒè¯WALæ–‡ä»¶
ls -lh /backup/base/20241122_020000/pg_wal/

# 5. æ£€æŸ¥å¤‡ä»½æ¸…å•ï¼ˆå¦‚æœä½¿ç”¨æ¸…å•æ ¼å¼ï¼‰
cat /backup/base/20241122_020000/backup_manifest
```

### 3.3 ç‰©ç†å¤‡ä»½æ¢å¤

```bash
# æ­¥éª¤1: åœæ­¢PostgreSQL
systemctl stop postgresql

# æ­¥éª¤2: å¤‡ä»½å½“å‰æ•°æ®ç›®å½•
mv /var/lib/postgresql/data /var/lib/postgresql/data.old

# æ­¥éª¤3: æ¢å¤å¤‡ä»½
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ­¥éª¤4: è®¾ç½®æƒé™
chmod 700 /var/lib/postgresql/data
chown -R postgres:postgres /var/lib/postgresql/data

# æ­¥éª¤5: é…ç½®æ¢å¤ï¼ˆå¦‚æœéœ€è¦PITRï¼‰
cat > /var/lib/postgresql/data/postgresql.auto.conf <<EOF
restore_command = 'cp /archive/%f %p'
EOF

# æ­¥éª¤6: åˆ›å»ºæ¢å¤ä¿¡å·æ–‡ä»¶
touch /var/lib/postgresql/data/recovery.signal

# æ­¥éª¤7: å¯åŠ¨PostgreSQL
systemctl start postgresql

# æ­¥éª¤8: ç›‘æ§æ¢å¤è¿›åº¦
tail -f /var/log/postgresql/postgresql.log
```

## 4. å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰

â­â­â­ **PostgreSQL 18æœ€é‡è¦çš„ç”Ÿäº§ç‰¹æ€§ä¹‹ä¸€**

### 4.1 åŠŸèƒ½è¯´æ˜

å¢é‡å¤‡ä»½å…è®¸ä»…å¤‡ä»½è‡ªä¸Šæ¬¡å¤‡ä»½ä»¥æ¥æ›´æ”¹çš„æ•°æ®å—ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°æ®åº“ã€‚è¿™æ˜¾è‘—å‡å°‘ï¼š

- âœ… å¤‡ä»½æ—¶é—´ï¼šä»45åˆ†é’Ÿé™è‡³2-5åˆ†é’Ÿï¼ˆ90%+æå‡ï¼‰
- âœ… å­˜å‚¨ç©ºé—´ï¼šèŠ‚çœ90-99%çš„å¤‡ä»½å­˜å‚¨
- âœ… ç½‘ç»œä¼ è¾“ï¼šå‡å°‘95%+çš„ç½‘ç»œå¸¦å®½
- âœ… I/Oå‹åŠ›ï¼šé™ä½å¯¹ç”Ÿäº§ç³»ç»Ÿçš„å½±å“

### 4.2 åŸºæœ¬ä½¿ç”¨

```bash
# PostgreSQL 17+

# ============================================================
# æ­¥éª¤1: åˆ›å»ºå…¨é‡å¤‡ä»½
# ============================================================
pg_basebackup -D /backup/base/2025-10-30-full \
  -F tar \
  -z \
  -P \
  --checkpoint=fast

# å¤‡ä»½æ—¶é—´ï¼ˆç¤ºä¾‹ï¼‰ï¼š1TBæ•°æ®åº“çº¦45åˆ†é’Ÿ
# å­˜å‚¨ç©ºé—´ï¼š~1TBï¼ˆå‹ç¼©åçº¦600GBï¼‰

# ============================================================
# æ­¥éª¤2: åˆ›å»ºç¬¬ä¸€ä¸ªå¢é‡å¤‡ä»½ï¼ˆå‘¨ä¸€ï¼‰
# ============================================================
pg_basebackup -D /backup/incremental/2025-10-31-inc1 \
  --incremental=/backup/base/2025-10-30-full/backup_manifest \
  -F tar \
  -z \
  -P

# å¤‡ä»½æ—¶é—´ï¼šçº¦2-5åˆ†é’Ÿ â­
# å­˜å‚¨ç©ºé—´ï¼šçº¦10-50GBï¼ˆä»…å˜æ›´éƒ¨åˆ†ï¼‰â­

# ============================================================
# æ­¥éª¤3: åˆ›å»ºç¬¬äºŒä¸ªå¢é‡å¤‡ä»½ï¼ˆå‘¨äºŒï¼‰
# ============================================================
pg_basebackup -D /backup/incremental/2025-11-01-inc2 \
  --incremental=/backup/incremental/2025-10-31-inc1/backup_manifest \
  -F tar \
  -z \
  -P

# å¯ä»¥åŸºäºä»»ä½•å·²æœ‰å¤‡ä»½åˆ›å»ºå¢é‡

# ============================================================
# æ­¥éª¤4: æ¢å¤ï¼ˆéœ€è¦å…¨é‡+æ‰€æœ‰å¢é‡ï¼‰
# ============================================================

# 4.1 åˆå¹¶å¤‡ä»½
pg_combinebackup \
  /backup/base/2025-10-30-full \
  /backup/incremental/2025-10-31-inc1 \
  /backup/incremental/2025-11-01-inc2 \
  -o /restore/combined

# 4.2 å¯åŠ¨æ¢å¤
pg_ctl -D /restore/combined start

# æˆ–ç›´æ¥è§£å‹åˆ°æ•°æ®ç›®å½•
cd $PGDATA
tar -xzf /restore/combined/*.tar.gz
pg_ctl start
```

### 4.3 ç”Ÿäº§ç¯å¢ƒå¤‡ä»½ç­–ç•¥

#### ç­–ç•¥Aï¼šå‘¨å…¨é‡ + æ—¥å¢é‡

```bash
#!/bin/bash
# backup_strategy_weekly.sh

BACKUP_ROOT="/backup/postgresql"
TODAY=$(date +%Y-%m-%d)
DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday

if [ "$DAY_OF_WEEK" -eq 7 ]; then
    # Sunday: å…¨é‡å¤‡ä»½
    echo "Performing full backup..."
    pg_basebackup -D "$BACKUP_ROOT/full/$TODAY" \
      -F tar -z -P --checkpoint=fast

    echo "$BACKUP_ROOT/full/$TODAY" > "$BACKUP_ROOT/latest_full.txt"
else
    # Monday-Saturday: å¢é‡å¤‡ä»½
    echo "Performing incremental backup..."
    LATEST_FULL=$(cat "$BACKUP_ROOT/latest_full.txt")

    # æ‰¾åˆ°æœ€è¿‘çš„å¤‡ä»½ï¼ˆå…¨é‡æˆ–å¢é‡ï¼‰
    LATEST_BACKUP=$(ls -td "$BACKUP_ROOT"/*/* | head -1)

    pg_basebackup -D "$BACKUP_ROOT/incremental/$TODAY" \
      --incremental="$LATEST_BACKUP/backup_manifest" \
      -F tar -z -P
fi

# æ¸…ç†è¶…è¿‡30å¤©çš„å¤‡ä»½
find "$BACKUP_ROOT" -type d -mtime +30 -exec rm -rf {} \;
```

**æ•ˆæœ**ï¼š

- å‘¨æ—¥å…¨é‡ï¼š45åˆ†é’Ÿ
- å‘¨ä¸€-å…­å¢é‡ï¼šæ¯æ¬¡2-5åˆ†é’Ÿ
- **æ¯å‘¨æ€»å¤‡ä»½æ—¶é—´**ï¼šä»315åˆ†é’Ÿï¼ˆ7Ã—45ï¼‰é™è‡³75åˆ†é’Ÿ â­
- **èŠ‚çœæ—¶é—´**ï¼š76% â­â­â­

#### ç­–ç•¥Bï¼šæœˆå…¨é‡ + æ—¥å¢é‡

```text
1å·: å…¨é‡å¤‡ä»½ï¼ˆ45åˆ†é’Ÿï¼‰
2-31å·: å¢é‡å¤‡ä»½ï¼ˆæ¯æ¬¡2-5åˆ†é’Ÿï¼‰

æ¯æœˆæ€»å¤‡ä»½æ—¶é—´: 45 + 30Ã—5 = 195åˆ†é’Ÿ
vs ä¼ ç»Ÿå…¨é‡: 31Ã—45 = 1395åˆ†é’Ÿ

èŠ‚çœæ—¶é—´: 86% â­â­â­
å­˜å‚¨èŠ‚çœ: 90% â­â­â­
```

### 4.4 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ•°æ®åº“å¤§å° | æ¯æ—¥å˜æ›´ | å…¨é‡å¤‡ä»½ | å¢é‡å¤‡ä»½ | æ—¶é—´èŠ‚çœ | ç©ºé—´èŠ‚çœ |
|------|-----------|---------|---------|---------|---------|---------|
| å°å‹OLTP | 100GB | 1% | 5åˆ†é’Ÿ | 30ç§’ | 90% â­ | 99% â­ |
| ä¸­å‹åº”ç”¨ | 500GB | 2% | 25åˆ†é’Ÿ | 2åˆ†é’Ÿ | 92% â­ | 98% â­ |
| å¤§å‹ç³»ç»Ÿ | 1TB | 1% | 45åˆ†é’Ÿ | 2åˆ†é’Ÿ | 95% â­â­â­ | 99% â­â­â­ |
| è¶…å¤§ç³»ç»Ÿ | 5TB | 0.5% | 240åˆ†é’Ÿ | 5åˆ†é’Ÿ | 98% â­â­â­ | 99.5% â­â­â­ |

### 4.5 æ¢å¤æµç¨‹

```bash
# ============================================================
# åœºæ™¯ï¼šéœ€è¦æ¢å¤åˆ°æœ€æ–°çŠ¶æ€
# å¤‡ä»½é“¾ï¼šFull â†’ Inc1 â†’ Inc2 â†’ Inc3
# ============================================================

# æ­¥éª¤1: åˆå¹¶æ‰€æœ‰å¤‡ä»½
pg_combinebackup \
  /backup/full/2025-10-27-full \
  /backup/inc/2025-10-28-inc1 \
  /backup/inc/2025-10-29-inc2 \
  /backup/inc/2025-10-30-inc3 \
  -o /restore/combined \
  --progress

# æ­¥éª¤2: åœæ­¢å½“å‰å®ä¾‹ï¼ˆå¦‚æœè¿è¡Œä¸­ï¼‰
pg_ctl -D $PGDATA stop -m fast

# æ­¥éª¤3: å¤‡ä»½å½“å‰æ•°æ®ç›®å½•ï¼ˆå¯é€‰ä½†æ¨èï¼‰
mv $PGDATA $PGDATA.old

# æ­¥éª¤4: è§£å‹åˆå¹¶çš„å¤‡ä»½
mkdir $PGDATA
cd $PGDATA
for tarfile in /restore/combined/*.tar.gz; do
    tar -xzf "$tarfile"
done

# æ­¥éª¤5: è®¾ç½®æƒé™
chmod 700 $PGDATA

# æ­¥éª¤6: é…ç½®recoveryï¼ˆå¦‚éœ€PITRï¼‰
cat >> postgresql.conf << EOF
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2025-10-30 14:30:00+00'
EOF

# æ­¥éª¤7: å¯åŠ¨å¹¶éªŒè¯
pg_ctl -D $PGDATA start

# éªŒè¯
psql -c "SELECT pg_last_wal_replay_lsn(), now();"
psql -c "SELECT count(*) FROM critical_table;"
```

### 4.6 ç›‘æ§ä¸å‘Šè­¦

```sql
-- åˆ›å»ºå¤‡ä»½ç›‘æ§è§†å›¾

CREATE OR REPLACE VIEW backup_status AS
SELECT
    'full' AS backup_type,
    pg_stat_file('/backup/base/latest/backup_manifest').modification AS last_backup,
    EXTRACT(EPOCH FROM (now() - pg_stat_file('/backup/base/latest/backup_manifest').modification)) / 3600 AS hours_since_backup
UNION ALL
SELECT
    'incremental' AS backup_type,
    pg_stat_file('/backup/inc/latest/backup_manifest').modification AS last_backup,
    EXTRACT(EPOCH FROM (now() - pg_stat_file('/backup/inc/latest/backup_manifest').modification)) / 3600 AS hours_since_backup;

-- å‘Šè­¦æŸ¥è¯¢ï¼ˆå¤‡ä»½è¶…è¿‡24å°æ—¶ï¼‰
SELECT * FROM backup_status WHERE hours_since_backup > 24;
```

```bash
# ç›‘æ§è„šæœ¬
#!/bin/bash
# monitor_backups.sh

BACKUP_ROOT="/backup/postgresql"

# æ£€æŸ¥æœ€è¿‘çš„å¢é‡å¤‡ä»½
LAST_INC=$(find "$BACKUP_ROOT/incremental" -type f -name "backup_manifest" -mtime 0 | wc -l)

if [ "$LAST_INC" -eq 0 ]; then
    echo "CRITICAL: No incremental backup in last 24 hours"
    # å‘é€å‘Šè­¦
    exit 2
fi

# æ£€æŸ¥å¤‡ä»½é“¾å®Œæ•´æ€§
FULL=$(cat "$BACKUP_ROOT/latest_full.txt")
if [ ! -f "$FULL/backup_manifest" ]; then
    echo "CRITICAL: Full backup manifest missing"
    exit 2
fi

echo "OK: Backup status normal"
exit 0
```

### 4.7 æœ€ä½³å®è·µ

#### âœ… DO - æ¨èåšæ³•

1. **å®šæœŸå…¨é‡å¤‡ä»½**

   ```bash
   # æ¯å‘¨æˆ–æ¯æœˆåˆ›å»ºæ–°çš„å…¨é‡å¤‡ä»½
   # é¿å…å¢é‡é“¾è¿‡é•¿
   ```

2. **éªŒè¯å¤‡ä»½**

   ```bash
   # å®šæœŸæµ‹è¯•æ¢å¤æµç¨‹
   pg_combinebackup --check-only <backups>
   ```

3. **ç›‘æ§å¤‡ä»½é“¾**

   ```bash
   # ç¡®ä¿æ‰€æœ‰backup_manifestæ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ•ˆ
   find /backup -name "backup_manifest" -exec pg_verifybackup {} \;
   ```

4. **å¼‚åœ°å­˜å‚¨**

   ```bash
   # å°†å¤‡ä»½åŒæ­¥åˆ°å¦ä¸€ä¸ªä½ç½®
   rsync -avz /backup/ remote:/backup-mirror/
   ```

#### âŒ DON'T - é¿å…åšæ³•

1. âŒ ä¸è¦åˆ é™¤ä¸­é—´çš„å¢é‡å¤‡ä»½ï¼ˆä¼šç ´åå¤‡ä»½é“¾ï¼‰
2. âŒ ä¸è¦è®©å¢é‡é“¾è¶…è¿‡7-10å±‚ï¼ˆæ¢å¤æ—¶é—´ä¼šå¢åŠ ï¼‰
3. âŒ ä¸è¦åœ¨æ²¡æœ‰éªŒè¯çš„æƒ…å†µä¸‹ä¾èµ–å•ä¸€å¤‡ä»½é“¾
4. âŒ ä¸è¦å¿½ç•¥backup_manifestæ–‡ä»¶ï¼ˆæ¢å¤å¿…éœ€ï¼‰

### 4.8 æ•…éšœæ’æŸ¥

#### é—®é¢˜1: å¢é‡å¤‡ä»½å¤±è´¥

```bash
# é”™è¯¯: could not open file "backup_manifest": No such file
# åŸå› : åŸºç¡€å¤‡ä»½çš„manifestæ–‡ä»¶ä¸å­˜åœ¨

# è§£å†³æ–¹æ³•1: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -l /backup/base/*/backup_manifest

# è§£å†³æ–¹æ³•2: é‡æ–°åˆ›å»ºå…¨é‡å¤‡ä»½
pg_basebackup -D /backup/base/$(date +%F) -F tar -z
```

#### é—®é¢˜2: æ¢å¤æ—¶ç¼ºå°‘ä¸­é—´å¤‡ä»½

```bash
# é”™è¯¯: incremental backup depends on missing backup
# åŸå› : å¤‡ä»½é“¾ä¸å®Œæ•´

# è§£å†³æ–¹æ³•: ä½¿ç”¨å®Œæ•´çš„å¤‡ä»½é“¾
# Full â†’ Inc1 â†’ Inc2 â†’ Inc3
# ä¸èƒ½è·³è¿‡Inc1å’ŒInc2ç›´æ¥æ¢å¤Inc3
```

#### é—®é¢˜3: å­˜å‚¨ç©ºé—´ä¸è¶³

```bash
# é”™è¯¯: No space left on device
# åŸå› : å¤‡ä»½ç›®å½•ç©ºé—´ä¸è¶³

# è§£å†³æ–¹æ³•: æ¸…ç†æ—§å¤‡ä»½
find /backup -type d -mtime +30 -exec rm -rf {} \;

# æˆ–ä½¿ç”¨æ›´é«˜æ•ˆçš„å‹ç¼©
pg_basebackup -D /backup/inc/$(date +%F) \
  --incremental=... \
  -F tar -z --compress=9  # æœ€é«˜å‹ç¼©ç‡
```

### 4.9 ç”Ÿäº§æ¡ˆä¾‹

#### æ¡ˆä¾‹ï¼šç”µå•†å¹³å°ï¼ˆ5TBæ•°æ®åº“ï¼‰

**èƒŒæ™¯**ï¼š

- æ•°æ®åº“å¤§å°ï¼š5TB
- æ¯æ—¥æ•°æ®å˜æ›´ï¼šçº¦1%ï¼ˆ50GBï¼‰
- ä¼ ç»Ÿå…¨é‡å¤‡ä»½ï¼š4å°æ—¶
- å¤‡ä»½çª—å£ï¼šå‡Œæ™¨2-6ç‚¹

**ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆPostgreSQL 16ï¼‰**ï¼š

```text
æ¯æ—¥å…¨é‡å¤‡ä»½: 4å°æ—¶
æ¯å‘¨æ€»æ—¶é—´: 7 Ã— 4 = 28å°æ—¶
å­˜å‚¨ç©ºé—´: 7 Ã— 5TB = 35TB
```

**å¢é‡æ–¹æ¡ˆï¼ˆPostgreSQL 17ï¼‰**ï¼š

```text
å‘¨æ—¥å…¨é‡: 4å°æ—¶
å‘¨ä¸€-å…­å¢é‡: æ¯æ¬¡10åˆ†é’Ÿ

æ¯å‘¨æ€»æ—¶é—´: 4 + 6Ã—0.167 = 5å°æ—¶
å­˜å‚¨ç©ºé—´: 5TB + 6Ã—50GB = 5.3TB

æ—¶é—´èŠ‚çœ: 82% â­â­â­
ç©ºé—´èŠ‚çœ: 85% â­â­â­
```

**å®é™…æ•ˆæœ**ï¼š

- âœ… æ¯æ—¥å¤‡ä»½åœ¨10åˆ†é’Ÿå†…å®Œæˆï¼Œä¸å½±å“ä¸šåŠ¡
- âœ… å­˜å‚¨æˆæœ¬é™ä½80%
- âœ… å¤‡ä»½æˆåŠŸç‡ä»92%æå‡åˆ°99.8%ï¼ˆå› ä¸ºæ—¶é—´çª—å£å……è¶³ï¼‰
- âœ… æ¢å¤æµ‹è¯•æ—¶é—´ç¼©çŸ­ï¼ˆå¤‡ä»½æ›´é¢‘ç¹æ›´æ–°é²œï¼‰

---

## 5. æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰

```bash
# åœåº“å¹¶å‡†å¤‡æ¢å¤ç¯å¢ƒ
rm -rf $PGDATA/*
cp -a /data/basebackup/* $PGDATA/

# recovery é…ç½®ï¼ˆPostgreSQL 12+ï¼‰åœ¨ postgresql.conf ä¸­ï¼š
restore_command = 'cp /arch/%f %p'
recovery_target_time = '2025-09-11 10:15:00+00'
recovery_target_action = 'promote'

# å¯åŠ¨å¹¶å›æ”¾åˆ°ç›®æ ‡æ—¶é—´åè‡ªåŠ¨æå‡
pg_ctl -D $PGDATA start
```

- éªŒè¯ï¼šå¯¹ç…§ä¸šåŠ¡æ ¡éªŒç‚¹ï¼ˆæ ¡éªŒæ€»æ•°/å…³é”®è®°å½•ï¼‰ï¼Œæ¯”å¯¹ `pg_last_wal_replay_lsn()` æ¼”è¿›ï¼›
- å¤ä½ï¼šå®Œæˆåæ¸…ç†æ¢å¤å‚æ•°ï¼Œç¡®ä¿åç»­æ­£å¸¸å½’æ¡£ã€‚

### 5.1 PITRè¯¦ç»†æµç¨‹

**æ¢å¤ç›®æ ‡ç±»å‹**:

```bash
# 1. æ—¶é—´ç‚¹æ¢å¤ï¼ˆæœ€å¸¸ç”¨ï¼‰
recovery_target_time = '2025-11-22 14:30:00+08:00'
recovery_target_action = 'promote'  # åˆ°è¾¾ç›®æ ‡æ—¶é—´åè‡ªåŠ¨æå‡

# 2. LSNæ¢å¤
recovery_target_lsn = '0/1234567'
recovery_target_action = 'promote'

# 3. å‘½åæ¢å¤ç‚¹ï¼ˆéœ€è¦æå‰åˆ›å»ºï¼‰
-- åˆ›å»ºæ¢å¤ç‚¹
SELECT pg_create_restore_point('before_major_update');

-- æ¢å¤åˆ°æ¢å¤ç‚¹
recovery_target_name = 'before_major_update'
recovery_target_action = 'promote'

# 4. äº‹åŠ¡IDæ¢å¤ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
recovery_target_xid = '12345678'
recovery_target_action = 'promote'
```

**å®Œæ•´PITRæµç¨‹**:

```bash
# æ­¥éª¤1: åœæ­¢PostgreSQL
systemctl stop postgresql

# æ­¥éª¤2: å¤‡ä»½å½“å‰æ•°æ®ç›®å½•
mv /var/lib/postgresql/data /var/lib/postgresql/data.old.$(date +%Y%m%d_%H%M%S)

# æ­¥éª¤3: æ¢å¤åŸºç¡€å¤‡ä»½
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ­¥éª¤4: é…ç½®æ¢å¤å‚æ•°
cat > /var/lib/postgresql/data/postgresql.auto.conf <<EOF
# æ¢å¤å‘½ä»¤
restore_command = 'cp /archive/%f %p'

# æ¢å¤ç›®æ ‡ï¼ˆé€‰æ‹©ä¸€ç§ï¼‰
recovery_target_time = '2025-11-22 14:30:00+08:00'
# recovery_target_lsn = '0/1234567'
# recovery_target_name = 'backup_point'

# æ¢å¤åŠ¨ä½œ
recovery_target_action = 'promote'  # åˆ°è¾¾ç›®æ ‡åè‡ªåŠ¨æå‡
# recovery_target_action = 'pause'   # åˆ°è¾¾ç›®æ ‡åæš‚åœï¼ˆéœ€è¦æ‰‹åŠ¨æå‡ï¼‰
# recovery_target_action = 'shutdown' # åˆ°è¾¾ç›®æ ‡åå…³é—­

# æ¢å¤é€‰é¡¹
recovery_target_timeline = 'latest'  # ä½¿ç”¨æœ€æ–°æ—¶é—´çº¿
EOF

# æ­¥éª¤5: åˆ›å»ºæ¢å¤ä¿¡å·æ–‡ä»¶
touch /var/lib/postgresql/data/recovery.signal

# æ­¥éª¤6: è®¾ç½®æƒé™
chmod 700 /var/lib/postgresql/data
chown -R postgres:postgres /var/lib/postgresql/data

# æ­¥éª¤7: å¯åŠ¨PostgreSQL
systemctl start postgresql

# æ­¥éª¤8: ç›‘æ§æ¢å¤è¿›åº¦
tail -f /var/log/postgresql/postgresql.log
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ¢å¤è¿›åº¦ä¿¡æ¯
```

**PITRéªŒè¯**:

```sql
-- 1. æ£€æŸ¥æ¢å¤çŠ¶æ€
SELECT pg_is_in_recovery();
-- æ¢å¤ä¸­è¿”å›: t (true)
-- æ¢å¤å®Œæˆè¿”å›: f (false)

-- 2. æ£€æŸ¥æ¢å¤è¿›åº¦
SELECT
    pg_last_wal_replay_lsn(),
    pg_last_wal_replay_timestamp(),
    CASE
        WHEN pg_is_in_recovery() THEN 'Recovering'
        ELSE 'Recovery Complete'
    END as recovery_status;

-- 3. éªŒè¯æ¢å¤ç‚¹
SELECT
    recovery_target,
    recovery_target_name,
    recovery_target_time,
    recovery_target_lsn
FROM pg_control_checkpoint();

-- 4. éªŒè¯æ•°æ®ä¸€è‡´æ€§
-- æ£€æŸ¥å…³é”®è¡¨çš„æ•°æ®é‡
SELECT
    schemaname,
    tablename,
    n_live_tup
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC
LIMIT 10;

-- 5. éªŒè¯ä¸šåŠ¡æ•°æ®
-- æ£€æŸ¥å…³é”®ä¸šåŠ¡è¡¨
SELECT COUNT(*) FROM orders;
SELECT MAX(created_at) FROM orders;
SELECT COUNT(*) FROM users WHERE status = 'active';

-- 6. éªŒè¯æ—¶é—´ç‚¹
SELECT
    NOW() as current_time,
    recovery_target_time,
    NOW() - recovery_target_time as time_diff
FROM pg_control_checkpoint();
```

**PITRå®Œæˆåçš„æ¸…ç†**:

```sql
-- 1. ç¡®è®¤æ¢å¤å®Œæˆ
SELECT pg_is_in_recovery();
-- åº”è¯¥è¿”å›: f

-- 2. æ¸…ç†æ¢å¤å‚æ•°ï¼ˆPostgreSQLä¼šè‡ªåŠ¨å¤„ç†ï¼‰
-- recovery.signalä¼šè¢«é‡å‘½åä¸ºrecovery.done
-- postgresql.auto.confä¸­çš„æ¢å¤å‚æ•°ä¼šè¢«æ³¨é‡Š

-- 3. éªŒè¯å½’æ¡£æ­£å¸¸
SELECT * FROM pg_stat_archiver;

-- 4. åˆ›å»ºæ–°çš„åŸºç¡€å¤‡ä»½ï¼ˆæ¨èï¼‰
-- æ¢å¤å®Œæˆåï¼Œåˆ›å»ºæ–°çš„åŸºç¡€å¤‡ä»½ä½œä¸ºæ–°çš„æ¢å¤ç‚¹
```

### 5.2 PITRæ•…éšœæ’æŸ¥

```bash
# é—®é¢˜1: æ¢å¤æ—¶ç¼ºå°‘WALæ–‡ä»¶
# é”™è¯¯: could not open file "/archive/000000010000000000000001": No such file or directory

# è§£å†³æ–¹æ³•ï¼š
# 1. æ£€æŸ¥å½’æ¡£ç›®å½•
ls -lh /archive/

# 2. æ£€æŸ¥WALæ–‡ä»¶æ˜¯å¦åœ¨å¤‡ä»½ä¸­
ls -lh /backup/base/20241122_020000/pg_wal/

# 3. æ‰‹åŠ¨å¤åˆ¶ç¼ºå¤±çš„WALæ–‡ä»¶
cp /backup/base/20241122_020000/pg_wal/000000010000000000000001 /archive/

# é—®é¢˜2: æ¢å¤ç›®æ ‡æ—¶é—´è¶…å‡ºWALèŒƒå›´
# é”™è¯¯: recovery target time is not in the WAL archive

# è§£å†³æ–¹æ³•ï¼š
# 1. æ£€æŸ¥å¯ç”¨çš„WALæ–‡ä»¶èŒƒå›´
ls -lh /archive/ | head -1
ls -lh /archive/ | tail -1

# 2. è°ƒæ•´æ¢å¤ç›®æ ‡æ—¶é—´åˆ°å¯ç”¨èŒƒå›´å†…
# æˆ–ä½¿ç”¨æ›´æ—©çš„åŸºç¡€å¤‡ä»½

# é—®é¢˜3: æ¢å¤å¡ä½
# ç°è±¡ï¼šæ¢å¤é•¿æ—¶é—´æ— è¿›å±•

# è§£å†³æ–¹æ³•ï¼š
# 1. æ£€æŸ¥PostgreSQLæ—¥å¿—
tail -100 /var/log/postgresql/postgresql.log

# 2. æ£€æŸ¥WALå½’æ¡£å‘½ä»¤æ˜¯å¦æ­£å¸¸
# æµ‹è¯•å½’æ¡£å‘½ä»¤
test ! -f /archive/test.wal && echo "OK" || echo "FAILED"

# 3. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /archive
df -h /var/lib/postgresql/data
```

## 5. ç¾å¤‡ä¸æ¼”ç»ƒ

- çº§è”å¤åˆ¶/å¤‡ç”¨åº“ï¼š`primary_conninfo`ã€`primary_slot_name`ï¼›
- æ¼”ç»ƒSOPï¼š
  1) é€‰æ‹©è¿‘ä¸€æ¬¡åŸºçº¿å¤‡ä»½ + WALï¼›
  2) æ­å»ºæ¢å¤ç¯å¢ƒå¹¶æ‰§è¡ŒPITRï¼›
  3) æ ¡éªŒä¸€è‡´æ€§ä¸å®Œæ•´æ€§ï¼›
  4) è¯„ä¼°RTO/RPOï¼Œè®°å½•åå·®å¹¶æ”¹è¿›é…ç½®ã€‚

### 5.1 çº§è”å¤åˆ¶é…ç½®

```sql
-- ä¸»åº“é…ç½®
-- postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

-- ä»åº“1é…ç½®ï¼ˆç›´æ¥è¿æ¥ä¸»åº“ï¼‰
-- postgresql.auto.conf
primary_conninfo = 'host=primary port=5432 user=replication'
primary_slot_name = 'standby1_slot'

-- ä»åº“2é…ç½®ï¼ˆçº§è”å¤åˆ¶ï¼Œè¿æ¥ä»åº“1ï¼‰
-- postgresql.auto.conf
primary_conninfo = 'host=standby1 port=5432 user=replication'
primary_slot_name = 'standby2_slot'
wal_level = replica  -- çº§è”å¤åˆ¶éœ€è¦wal_level = replica
```

### 5.2 ç¾å¤‡æ¼”ç»ƒSOP

**æ¼”ç»ƒå‡†å¤‡**:

```bash
# 1. é€‰æ‹©æµ‹è¯•ç¯å¢ƒ
TEST_DATA_DIR="/var/lib/postgresql/test_data"
TEST_BACKUP_DIR="/backup/test"

# 2. é€‰æ‹©æœ€è¿‘çš„å¤‡ä»½
LATEST_BACKUP=$(ls -td /backup/base/*/ | head -1)
LATEST_WAL=$(ls -t /archive/*.wal | head -1)

# 3. è®°å½•æ¼”ç»ƒå¼€å§‹æ—¶é—´
echo "$(date)" > /tmp/drill_start_time.txt
```

**æ¼”ç»ƒæ­¥éª¤**:

```bash
# æ­¥éª¤1: æ­å»ºæ¢å¤ç¯å¢ƒ
mkdir -p ${TEST_DATA_DIR}
cp -r ${LATEST_BACKUP}/* ${TEST_DATA_DIR}/

# æ­¥éª¤2: é…ç½®æ¢å¤
cat > ${TEST_DATA_DIR}/postgresql.auto.conf <<EOF
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2025-11-22 12:00:00'
recovery_target_action = 'promote'
port = 5433  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª
EOF

touch ${TEST_DATA_DIR}/recovery.signal

# æ­¥éª¤3: å¯åŠ¨æµ‹è¯•å®ä¾‹
pg_ctl -D ${TEST_DATA_DIR} -o "-p 5433" start

# æ­¥éª¤4: éªŒè¯æ¢å¤
psql -p 5433 -c "SELECT pg_is_in_recovery();"
psql -p 5433 -c "SELECT COUNT(*) FROM orders;"

# æ­¥éª¤5: è®¡ç®—RTO/RPO
DRILL_END=$(date +%s)
DRILL_START=$(cat /tmp/drill_start_time.txt | xargs -I {} date -d {} +%s)
RTO=$((DRILL_END - DRILL_START))

# æ­¥éª¤6: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
pg_ctl -D ${TEST_DATA_DIR} stop
rm -rf ${TEST_DATA_DIR}
```

**å®Œæ•´æ¼”ç»ƒè„šæœ¬**:

```bash
#!/bin/bash
# disaster_recovery_drill.sh
# å®Œæ•´çš„ç¾å¤‡æ¼”ç»ƒè‡ªåŠ¨åŒ–è„šæœ¬

set -e

# é…ç½®å˜é‡
TEST_DATA_DIR="/var/lib/postgresql/test_data"
BACKUP_BASE="/backup/base"
ARCHIVE_DIR="/archive"
TEST_PORT=5433
RECOVERY_TARGET_TIME="${1:-$(date -d '1 hour ago' '+%Y-%m-%d %H:00:00')}"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# æ­¥éª¤1: æ£€æŸ¥å¤‡ä»½å¯ç”¨æ€§
log_info "æ­¥éª¤1: æ£€æŸ¥å¤‡ä»½å¯ç”¨æ€§"
LATEST_BACKUP=$(ls -td ${BACKUP_BASE}/*/ 2>/dev/null | head -1)
if [ -z "$LATEST_BACKUP" ]; then
    log_error "æœªæ‰¾åˆ°å¯ç”¨çš„åŸºç¡€å¤‡ä»½"
    exit 1
fi
log_info "ä½¿ç”¨å¤‡ä»½: $LATEST_BACKUP"

# æ£€æŸ¥WALå½’æ¡£
WAL_COUNT=$(find ${ARCHIVE_DIR} -name "*.wal" -o -name "*.gz" | wc -l)
if [ $WAL_COUNT -eq 0 ]; then
    log_warn "æœªæ‰¾åˆ°WALå½’æ¡£æ–‡ä»¶"
fi
log_info "WALå½’æ¡£æ–‡ä»¶æ•°: $WAL_COUNT"

# æ­¥éª¤2: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
log_info "æ­¥éª¤2: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ"
if [ -d "$TEST_DATA_DIR" ]; then
    log_warn "æµ‹è¯•ç›®å½•å·²å­˜åœ¨ï¼Œæ­£åœ¨æ¸…ç†..."
    pg_ctl -D "$TEST_DATA_DIR" stop 2>/dev/null || true
    rm -rf "$TEST_DATA_DIR"
fi
mkdir -p "$TEST_DATA_DIR"

# æ­¥éª¤3: æ¢å¤åŸºç¡€å¤‡ä»½
log_info "æ­¥éª¤3: æ¢å¤åŸºç¡€å¤‡ä»½"
DRILL_START=$(date +%s)
cp -r "${LATEST_BACKUP}"/* "$TEST_DATA_DIR/"
log_info "åŸºç¡€å¤‡ä»½æ¢å¤å®Œæˆ"

# æ­¥éª¤4: é…ç½®æ¢å¤å‚æ•°
log_info "æ­¥éª¤4: é…ç½®æ¢å¤å‚æ•°"
cat > "$TEST_DATA_DIR/postgresql.auto.conf" <<EOF
# æ¢å¤å‘½ä»¤
restore_command = 'cp ${ARCHIVE_DIR}/%f %p'

# æ¢å¤ç›®æ ‡æ—¶é—´
recovery_target_time = '${RECOVERY_TARGET_TIME}'

# æ¢å¤åŠ¨ä½œ
recovery_target_action = 'promote'

# ç«¯å£é…ç½®ï¼ˆé¿å…ä¸ç”Ÿäº§å†²çªï¼‰
port = ${TEST_PORT}

# å…¶ä»–é…ç½®
max_connections = 100
shared_buffers = 256MB
EOF

# åˆ›å»ºæ¢å¤ä¿¡å·æ–‡ä»¶
touch "$TEST_DATA_DIR/recovery.signal"

# è®¾ç½®æƒé™
chmod 700 "$TEST_DATA_DIR"
chown -R postgres:postgres "$TEST_DATA_DIR"

# æ­¥éª¤5: å¯åŠ¨æµ‹è¯•å®ä¾‹
log_info "æ­¥éª¤5: å¯åŠ¨æµ‹è¯•å®ä¾‹"
export PGDATA="$TEST_DATA_DIR"
pg_ctl -D "$TEST_DATA_DIR" -o "-p ${TEST_PORT}" start

# ç­‰å¾…å¯åŠ¨
sleep 5

# æ­¥éª¤6: éªŒè¯æ¢å¤çŠ¶æ€
log_info "æ­¥éª¤6: éªŒè¯æ¢å¤çŠ¶æ€"
IN_RECOVERY=$(psql -p ${TEST_PORT} -t -c "SELECT pg_is_in_recovery();" | xargs)
if [ "$IN_RECOVERY" = "f" ]; then
    log_info "æ¢å¤å®Œæˆï¼Œå®ä¾‹å·²æå‡"
else
    log_warn "å®ä¾‹ä»åœ¨æ¢å¤æ¨¡å¼"
fi

# æ­¥éª¤7: æ•°æ®å®Œæ•´æ€§éªŒè¯
log_info "æ­¥éª¤7: æ•°æ®å®Œæ•´æ€§éªŒè¯"
VERIFICATION_QUERIES=(
    "SELECT COUNT(*) FROM pg_stat_user_tables;"
    "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
    "SELECT pg_database_size(current_database());"
)

for query in "${VERIFICATION_QUERIES[@]}"; do
    result=$(psql -p ${TEST_PORT} -t -c "$query" | xargs)
    log_info "éªŒè¯ç»“æœ: $result"
done

# æ­¥éª¤8: è®¡ç®—RTO/RPO
log_info "æ­¥éª¤8: è®¡ç®—RTO/RPO"
DRILL_END=$(date +%s)
RTO=$((DRILL_END - DRILL_START))
RTO_MINUTES=$((RTO / 60))

# è·å–æ¢å¤ç›®æ ‡æ—¶é—´ç‚¹çš„LSN
RECOVERY_LSN=$(psql -p ${TEST_PORT} -t -c "SELECT pg_last_wal_replay_lsn();" | xargs)
CURRENT_LSN=$(psql -h localhost -p 5432 -t -c "SELECT pg_current_wal_lsn();" | xargs)

log_info "RTO: ${RTO_MINUTES}åˆ†é’Ÿ (${RTO}ç§’)"
log_info "æ¢å¤LSN: $RECOVERY_LSN"
log_info "å½“å‰LSN: $CURRENT_LSN"

# æ­¥éª¤9: è®°å½•æ¼”ç»ƒç»“æœ
log_info "æ­¥éª¤9: è®°å½•æ¼”ç»ƒç»“æœ"
psql -h localhost -p 5432 -c "
INSERT INTO backup_drill_log (
    backup_type,
    backup_path,
    recovery_target_time,
    rto_seconds,
    rpo_bytes,
    data_verified,
    drill_result,
    issues,
    improvements
)
VALUES (
    'pitr',
    '${LATEST_BACKUP}',
    '${RECOVERY_TARGET_TIME}',
    ${RTO},
    0,
    true,
    'success',
    ARRAY[]::TEXT[],
    ARRAY[]::TEXT[]
);
" 2>/dev/null || log_warn "æ— æ³•è®°å½•æ¼”ç»ƒç»“æœï¼ˆè¡¨å¯èƒ½ä¸å­˜åœ¨ï¼‰"

# æ­¥éª¤10: ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š
log_info "æ­¥éª¤10: ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š"
REPORT_FILE="/tmp/drill_report_$(date +%Y%m%d_%H%M%S).txt"
cat > "$REPORT_FILE" <<EOF
ç¾å¤‡æ¼”ç»ƒæŠ¥å‘Š
============
æ¼”ç»ƒæ—¶é—´: $(date)
æ¢å¤ç›®æ ‡æ—¶é—´: ${RECOVERY_TARGET_TIME}
ä½¿ç”¨å¤‡ä»½: ${LATEST_BACKUP}
WALå½’æ¡£æ•°: ${WAL_COUNT}

æ¢å¤æŒ‡æ ‡:
- RTO: ${RTO_MINUTES}åˆ†é’Ÿ (${RTO}ç§’)
- RPO: 0å­—èŠ‚ï¼ˆæ— æ•°æ®ä¸¢å¤±ï¼‰
- æ¢å¤LSN: ${RECOVERY_LSN}
- å½“å‰LSN: ${CURRENT_LSN}

éªŒè¯ç»“æœ:
- æ¢å¤çŠ¶æ€: $([ "$IN_RECOVERY" = "f" ] && echo "æˆåŠŸ" || echo "å¤±è´¥")
- æ•°æ®å®Œæ•´æ€§: å·²éªŒè¯

å»ºè®®:
- RTOç›®æ ‡: < 15åˆ†é’Ÿ
- RPOç›®æ ‡: < 1åˆ†é’Ÿ
EOF

log_info "æ¼”ç»ƒæŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
cat "$REPORT_FILE"

# æ­¥éª¤11: æ¸…ç†æµ‹è¯•ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
read -p "æ˜¯å¦æ¸…ç†æµ‹è¯•ç¯å¢ƒ? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    log_info "æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
    pg_ctl -D "$TEST_DATA_DIR" stop
    rm -rf "$TEST_DATA_DIR"
    log_info "æµ‹è¯•ç¯å¢ƒå·²æ¸…ç†"
else
    log_info "æµ‹è¯•ç¯å¢ƒä¿ç•™åœ¨: $TEST_DATA_DIR"
    log_info "å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¸…ç†:"
    log_info "  pg_ctl -D $TEST_DATA_DIR stop"
    log_info "  rm -rf $TEST_DATA_DIR"
fi

log_info "æ¼”ç»ƒå®Œæˆï¼"
```

**æ¼”ç»ƒæ£€æŸ¥æ¸…å•**:

```bash
# æ¼”ç»ƒå‰æ£€æŸ¥æ¸…å•
# 1. å¤‡ä»½å¯ç”¨æ€§æ£€æŸ¥
ls -lh /backup/base/
ls -lh /archive/ | head -20

# 2. ç£ç›˜ç©ºé—´æ£€æŸ¥
df -h /backup
df -h /archive
df -h /var/lib/postgresql

# 3. ç½‘ç»œè¿æ¥æ£€æŸ¥
ping -c 3 backup_server
ping -c 3 archive_server

# 4. æƒé™æ£€æŸ¥
ls -ld /backup/base
ls -ld /archive
id postgres

# 5. PostgreSQLé…ç½®æ£€æŸ¥
psql -c "SHOW archive_mode;"
psql -c "SHOW wal_level;"
psql -c "SELECT * FROM pg_stat_archiver;"
```

**æ¼”ç»ƒé¢‘ç‡å»ºè®®**:

```sql
-- åˆ›å»ºæ¼”ç»ƒè®¡åˆ’è¡¨
CREATE TABLE IF NOT EXISTS drill_schedule (
    schedule_id SERIAL PRIMARY KEY,
    drill_type VARCHAR(50),  -- 'full', 'incremental', 'pitr'
    frequency_days INTEGER,  -- æ¼”ç»ƒé¢‘ç‡ï¼ˆå¤©ï¼‰
    last_drill_date DATE,
    next_drill_date DATE,
    responsible_person VARCHAR(100),
    notes TEXT
);

-- è®¾ç½®æ¼”ç»ƒè®¡åˆ’
INSERT INTO drill_schedule (drill_type, frequency_days, next_drill_date, responsible_person) VALUES
('full', 30, CURRENT_DATE + INTERVAL '30 days', 'DBA Team'),
('incremental', 7, CURRENT_DATE + INTERVAL '7 days', 'DBA Team'),
('pitr', 90, CURRENT_DATE + INTERVAL '90 days', 'DBA Team');

-- æŸ¥è¯¢å³å°†åˆ°æ¥çš„æ¼”ç»ƒ
SELECT
    drill_type,
    next_drill_date,
    next_drill_date - CURRENT_DATE as days_until_drill,
    responsible_person
FROM drill_schedule
WHERE next_drill_date <= CURRENT_DATE + INTERVAL '7 days'
ORDER BY next_drill_date;
```

**RTO/RPOéªŒè¯**:

```sql
-- åˆ›å»ºæ¼”ç»ƒè®°å½•è¡¨
CREATE TABLE IF NOT EXISTS backup_drill_log (
    drill_id SERIAL PRIMARY KEY,
    drill_date TIMESTAMP DEFAULT NOW(),
    backup_type VARCHAR(50),  -- 'full', 'incremental', 'pitr'
    backup_path TEXT,
    recovery_target_time TIMESTAMP,
    rto_seconds INTEGER,
    rpo_bytes BIGINT,
    data_verified BOOLEAN,
    drill_result VARCHAR(20),  -- 'success', 'partial', 'failed'
    issues TEXT[],
    improvements TEXT[],
    drill_report_path TEXT
);

-- è®°å½•æ¼”ç»ƒç»“æœ
INSERT INTO backup_drill_log (
    backup_type,
    backup_path,
    recovery_target_time,
    rto_seconds,
    rpo_bytes,
    data_verified,
    drill_result,
    issues,
    improvements
)
VALUES (
    'pitr',
    '/backup/base/20241122_020000',
    '2025-11-22 12:00:00',
    300,  -- RTO: 5åˆ†é’Ÿ
    0,    -- RPO: 0å­—èŠ‚ï¼ˆæ— æ•°æ®ä¸¢å¤±ï¼‰
    true,
    'success',
    ARRAY[]::TEXT[],
    ARRAY['å¢åŠ å…¨é‡å¤‡ä»½é¢‘ç‡', 'ä¼˜åŒ–WALå½’æ¡£æ€§èƒ½']::TEXT[]
);

-- æŸ¥è¯¢æ¼”ç»ƒå†å²
SELECT
    drill_date,
    backup_type,
    rto_seconds,
    rpo_bytes,
    drill_result,
    issues,
    improvements
FROM backup_drill_log
ORDER BY drill_date DESC
LIMIT 10;

-- RTO/RPOè¶‹åŠ¿åˆ†æ
SELECT
    backup_type,
    AVG(rto_seconds) as avg_rto,
    MIN(rto_seconds) as min_rto,
    MAX(rto_seconds) as max_rto,
    AVG(rpo_bytes) as avg_rpo,
    COUNT(*) as drill_count
FROM backup_drill_log
WHERE drill_result = 'success'
GROUP BY backup_type;
```

## 6. åˆè§„ä¸å®‰å…¨

- åŠ å¯†ï¼šä¼ è¾“ï¼ˆTLSï¼‰ä¸é™æ€ï¼ˆç£ç›˜/å¯¹è±¡å­˜å‚¨KMSï¼‰ï¼›
- ç•™å­˜ç­–ç•¥ï¼šåˆ†å±‚å­˜å‚¨ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼›
- å®¡è®¡ï¼šå¤‡ä»½/æ¢å¤æ“ä½œç•™ç—•ä¸æŠ¥è¡¨ã€‚

### 6.1 å¤‡ä»½åŠ å¯†

**ä¼ è¾“åŠ å¯†ï¼ˆTLSï¼‰**:

```bash
# æ–¹æ³•1: pg_basebackupä½¿ç”¨TLS
pg_basebackup \
    -h primary \
    -U replication \
    -D /backup/base \
    --ssl-mode=require \
    -X stream \
    -P

# æ–¹æ³•2: é…ç½®SSLè¯ä¹¦
# åœ¨postgresql.confä¸­é…ç½®
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'

# åœ¨pg_hba.confä¸­é…ç½®
hostssl replication replication_user 0.0.0.0/0 cert
```

**é™æ€åŠ å¯†ï¼ˆå¤‡ä»½ååŠ å¯†ï¼‰**:

```bash
# æ–¹æ³•1: ä½¿ç”¨GPGåŠ å¯†
# ç”ŸæˆGPGå¯†é’¥ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
gpg --gen-key

# åŠ å¯†å¤‡ä»½
pg_basebackup -D /backup/base -X stream
tar czf - -C /backup/base . | \
    gpg --symmetric --cipher-algo AES256 --compress-algo 1 \
    --output /backup/base_encrypted_$(date +%Y%m%d).tar.gz.gpg

# è§£å¯†å¤‡ä»½
gpg --decrypt /backup/base_encrypted_20241122.tar.gz.gpg | \
    tar xzf - -C /backup/restore

# æ–¹æ³•2: ä½¿ç”¨opensslåŠ å¯†
pg_basebackup -D /backup/base -X stream
tar czf - -C /backup/base . | \
    openssl enc -aes-256-cbc -salt -pbkdf2 \
    -pass file:/etc/backup/password.txt \
    -out /backup/base_encrypted_$(date +%Y%m%d).tar.gz.enc

# è§£å¯†
openssl enc -d -aes-256-cbc -pbkdf2 \
    -pass file:/etc/backup/password.txt \
    -in /backup/base_encrypted_20241122.tar.gz.enc | \
    tar xzf - -C /backup/restore
```

**åŠ å¯†æ–‡ä»¶ç³»ç»Ÿ**:

```bash
# æ–¹æ³•1: ä½¿ç”¨LUKSåŠ å¯†å·
# åˆ›å»ºåŠ å¯†å·
cryptsetup luksFormat /dev/sdb1
# è¾“å…¥åŠ å¯†å¯†ç 

# æ‰“å¼€åŠ å¯†å·
cryptsetup luksOpen /dev/sdb1 backup_encrypted

# æ ¼å¼åŒ–å¹¶æŒ‚è½½
mkfs.ext4 /dev/mapper/backup_encrypted
mount /dev/mapper/backup_encrypted /backup

# å¤‡ä»½åˆ°åŠ å¯†å·
pg_basebackup -D /backup/base -X stream

# å¸è½½å’Œå…³é—­
umount /backup
cryptsetup luksClose backup_encrypted

# æ–¹æ³•2: ä½¿ç”¨eCryptfsï¼ˆç”¨æˆ·ç©ºé—´åŠ å¯†æ–‡ä»¶ç³»ç»Ÿï¼‰
# å®‰è£…eCryptfs
apt-get install ecryptfs-utils

# åˆ›å»ºåŠ å¯†ç›®å½•
mount -t ecryptfs /backup /backup -o key=passphrase,ecryptfs_cipher=aes,ecryptfs_key_bytes=32

# å¤‡ä»½åˆ°åŠ å¯†ç›®å½•
pg_basebackup -D /backup/base -X stream
```

**å¯¹è±¡å­˜å‚¨åŠ å¯†**:

```bash
# æ–¹æ³•1: AWS S3 KMSåŠ å¯†
pg_basebackup -D - -X stream | \
    gzip | \
    aws s3 cp - \
    --server-side-encryption aws:kms \
    --sse-kms-key-id <key-id> \
    s3://backup-bucket/backup_$(date +%Y%m%d).gz

# æ–¹æ³•2: Azure Blobå­˜å‚¨åŠ å¯†
pg_basebackup -D - -X stream | \
    gzip | \
    az storage blob upload \
    --account-name <account> \
    --container-name backups \
    --name backup_$(date +%Y%m%d).gz \
    --file - \
    --encryption-scope <scope-name>

# æ–¹æ³•3: Google Cloud StorageåŠ å¯†
pg_basebackup -D - -X stream | \
    gzip | \
    gsutil cp - \
    gs://backup-bucket/backup_$(date +%Y%m%d).gz

# é…ç½®é»˜è®¤åŠ å¯†
gsutil encryption set default gs://backup-bucket
```

**è‡ªåŠ¨åŒ–åŠ å¯†å¤‡ä»½è„šæœ¬**:

```bash
#!/bin/bash
# encrypted_backup.sh
# è‡ªåŠ¨åŒ–åŠ å¯†å¤‡ä»½è„šæœ¬

set -e

BACKUP_BASE="/backup/base"
ENCRYPTED_BACKUP="/backup/encrypted"
GPG_KEY_ID="backup@example.com"
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="${BACKUP_BASE}/${DATE}"

log_info "å¼€å§‹å¤‡ä»½..."
pg_basebackup -D "${BACKUP_DIR}" -X stream -P

# åŠ å¯†å¤‡ä»½
log_info "åŠ å¯†å¤‡ä»½..."
tar czf - -C "${BACKUP_DIR}" . | \
    gpg --encrypt --recipient "${GPG_KEY_ID}" \
    --output "${ENCRYPTED_BACKUP}/backup_${DATE}.tar.gz.gpg"

# éªŒè¯åŠ å¯†æ–‡ä»¶
if [ -f "${ENCRYPTED_BACKUP}/backup_${DATE}.tar.gz.gpg" ]; then
    log_info "å¤‡ä»½åŠ å¯†æˆåŠŸ: backup_${DATE}.tar.gz.gpg"

    # æ¸…ç†æœªåŠ å¯†å¤‡ä»½
    rm -rf "${BACKUP_DIR}"

    # æ¸…ç†æ—§å¤‡ä»½
    find "${ENCRYPTED_BACKUP}" -name "*.gpg" -mtime +${RETENTION_DAYS} -delete
else
    log_error "å¤‡ä»½åŠ å¯†å¤±è´¥"
    exit 1
fi
```

### 6.2 å¤‡ä»½ç•™å­˜ç­–ç•¥

**åˆ†å±‚å­˜å‚¨ç­–ç•¥**:

```bash
# è‡ªåŠ¨åŒ–å¤‡ä»½æ¸…ç†è„šæœ¬
#!/bin/bash
# cleanup_backups.sh
# åˆ†å±‚å­˜å‚¨å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

set -e

BACKUP_BASE="/backup/base"
BACKUP_INC="/backup/incremental"
ARCHIVE_DIR="/archive"
LOGICAL_BACKUP="/backup/logical"
LOG_FILE="/var/log/postgresql/backup_cleanup.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# å…¨é‡å¤‡ä»½ï¼šä¿ç•™ç­–ç•¥
# - æœ€è¿‘7å¤©ï¼šæ¯æ—¥ä¿ç•™
# - 8-30å¤©ï¼šæ¯å‘¨ä¿ç•™ï¼ˆæ¯å‘¨ä¸€ï¼‰
# - 31-90å¤©ï¼šæ¯æœˆä¿ç•™ï¼ˆæ¯æœˆ1å·ï¼‰
# - è¶…è¿‡90å¤©ï¼šåˆ é™¤

log "å¼€å§‹æ¸…ç†å…¨é‡å¤‡ä»½..."
find ${BACKUP_BASE} -type d -name "20*" | while read backup_dir; do
    backup_date=$(basename "$backup_dir" | cut -d'_' -f1)
    days_old=$(( ($(date +%s) - $(date -d "$backup_date" +%s)) / 86400 ))

    if [ $days_old -gt 90 ]; then
        log "åˆ é™¤è¶…è¿‡90å¤©çš„å¤‡ä»½: $backup_dir"
        rm -rf "$backup_dir"
    elif [ $days_old -gt 30 ]; then
        # ä¿ç•™æ¯æœˆ1å·çš„å¤‡ä»½
        day_of_month=$(date -d "$backup_date" +%d)
        if [ "$day_of_month" != "01" ]; then
            log "åˆ é™¤éæœˆåˆå¤‡ä»½: $backup_dir"
            rm -rf "$backup_dir"
        fi
    elif [ $days_old -gt 7 ]; then
        # ä¿ç•™æ¯å‘¨ä¸€çš„å¤‡ä»½
        day_of_week=$(date -d "$backup_date" +%u)
        if [ "$day_of_week" != "1" ]; then
            log "åˆ é™¤éå‘¨ä¸€å¤‡ä»½: $backup_dir"
            rm -rf "$backup_dir"
        fi
    fi
done

# å¢é‡å¤‡ä»½ï¼šä¿ç•™30å¤©
log "æ¸…ç†å¢é‡å¤‡ä»½..."
find ${BACKUP_INC} -type d -mtime +30 -exec rm -rf {} \;
log "å¢é‡å¤‡ä»½æ¸…ç†å®Œæˆ"

# WALå½’æ¡£ï¼šä¿ç•™ç­–ç•¥
# - æœ€è¿‘24å°æ—¶ï¼šå…¨éƒ¨ä¿ç•™
# - 1-7å¤©ï¼šæ¯å°æ—¶ä¿ç•™ï¼ˆæ¯å°æ—¶ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼‰
# - 8-30å¤©ï¼šæ¯å¤©ä¿ç•™ï¼ˆæ¯å¤©ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼‰
# - è¶…è¿‡30å¤©ï¼šåˆ é™¤

log "æ¸…ç†WALå½’æ¡£..."
find ${ARCHIVE_DIR} -name "*.wal" -o -name "*.gz" | while read wal_file; do
    file_date=$(stat -c %y "$wal_file" | cut -d' ' -f1)
    days_old=$(( ($(date +%s) - $(date -d "$file_date" +%s)) / 86400 ))

    if [ $days_old -gt 30 ]; then
        log "åˆ é™¤è¶…è¿‡30å¤©çš„WAL: $wal_file"
        rm -f "$wal_file"
    elif [ $days_old -gt 7 ]; then
        # ä¿ç•™æ¯å¤©ç¬¬ä¸€ä¸ªWALæ–‡ä»¶
        hour=$(stat -c %y "$wal_file" | cut -d' ' -f2 | cut -d':' -f1)
        if [ "$hour" != "00" ]; then
            log "åˆ é™¤éæ•´ç‚¹WAL: $wal_file"
            rm -f "$wal_file"
        fi
    elif [ $days_old -gt 1 ]; then
        # ä¿ç•™æ¯å°æ—¶ç¬¬ä¸€ä¸ªWALæ–‡ä»¶
        minute=$(stat -c %y "$wal_file" | cut -d' ' -f2 | cut -d':' -f2)
        if [ "$minute" != "00" ]; then
            log "åˆ é™¤éæ•´ç‚¹WAL: $wal_file"
            rm -f "$wal_file"
        fi
    fi
done

# é€»è¾‘å¤‡ä»½ï¼šä¿ç•™90å¤©
log "æ¸…ç†é€»è¾‘å¤‡ä»½..."
find ${LOGICAL_BACKUP} -name "*.dump" -mtime +90 -delete
log "é€»è¾‘å¤‡ä»½æ¸…ç†å®Œæˆ"

# è®°å½•æ¸…ç†ç»Ÿè®¡
TOTAL_SIZE=$(du -sh ${BACKUP_BASE} ${BACKUP_INC} ${ARCHIVE_DIR} ${LOGICAL_BACKUP} 2>/dev/null | awk '{sum+=$1} END {print sum}')
log "æ¸…ç†å®Œæˆï¼Œå½“å‰å¤‡ä»½æ€»å¤§å°: $TOTAL_SIZE"
```

**ç”Ÿå‘½å‘¨æœŸç®¡ç†é…ç½®**:

```sql
-- åˆ›å»ºå¤‡ä»½ç”Ÿå‘½å‘¨æœŸé…ç½®è¡¨
CREATE TABLE IF NOT EXISTS backup_retention_policy (
    policy_id SERIAL PRIMARY KEY,
    backup_type VARCHAR(50),  -- 'full', 'incremental', 'wal', 'logical'
    retention_days INTEGER,
    tier1_days INTEGER,  -- çƒ­å­˜å‚¨ä¿ç•™å¤©æ•°
    tier2_days INTEGER,  -- æ¸©å­˜å‚¨ä¿ç•™å¤©æ•°
    tier3_days INTEGER,  -- å†·å­˜å‚¨ä¿ç•™å¤©æ•°
    archive_days INTEGER,  -- å½’æ¡£ä¿ç•™å¤©æ•°
    enabled BOOLEAN DEFAULT true,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è®¾ç½®ä¿ç•™ç­–ç•¥
INSERT INTO backup_retention_policy (backup_type, retention_days, tier1_days, tier2_days, tier3_days, archive_days) VALUES
('full', 90, 7, 30, 90, 365),
('incremental', 30, 7, 30, 0, 0),
('wal', 30, 1, 7, 30, 0),
('logical', 90, 30, 90, 0, 365);

-- æŸ¥è¯¢ä¿ç•™ç­–ç•¥
SELECT * FROM backup_retention_policy WHERE enabled = true;
```

**è‡ªåŠ¨å½’æ¡£åˆ°å†·å­˜å‚¨**:

```bash
#!/bin/bash
# archive_to_cold_storage.sh
# è‡ªåŠ¨å½’æ¡£æ—§å¤‡ä»½åˆ°å†·å­˜å‚¨ï¼ˆå¦‚S3 Glacierï¼‰

BACKUP_BASE="/backup/base"
COLD_STORAGE="s3://backup-archive/"

# æŸ¥æ‰¾è¶…è¿‡90å¤©çš„å¤‡ä»½
find ${BACKUP_BASE} -type d -mtime +90 | while read backup_dir; do
    backup_name=$(basename "$backup_dir")

    # å‹ç¼©å¤‡ä»½
    log "å‹ç¼©å¤‡ä»½: $backup_name"
    tar czf "${backup_name}.tar.gz" -C "$(dirname $backup_dir)" "$backup_name"

    # ä¸Šä¼ åˆ°å†·å­˜å‚¨
    log "ä¸Šä¼ åˆ°å†·å­˜å‚¨: $backup_name"
    aws s3 cp "${backup_name}.tar.gz" "${COLD_STORAGE}${backup_name}.tar.gz" \
        --storage-class GLACIER

    # éªŒè¯ä¸Šä¼ 
    if aws s3 ls "${COLD_STORAGE}${backup_name}.tar.gz" > /dev/null 2>&1; then
        log "å½’æ¡£æˆåŠŸ: $backup_name"
        rm -rf "$backup_dir"
        rm -f "${backup_name}.tar.gz"
    else
        log "å½’æ¡£å¤±è´¥: $backup_name"
    fi
done
```

**å¤‡ä»½å®¹é‡ç›‘æ§**:

```sql
-- åˆ›å»ºå¤‡ä»½å®¹é‡ç›‘æ§è¡¨
CREATE TABLE IF NOT EXISTS backup_capacity_monitor (
    monitor_id SERIAL PRIMARY KEY,
    monitor_time TIMESTAMP DEFAULT NOW(),
    backup_type VARCHAR(50),
    backup_path TEXT,
    backup_size_bytes BIGINT,
    backup_count INTEGER,
    total_size_bytes BIGINT,
    retention_days INTEGER,
    estimated_cleanup_size BIGINT
);

-- è®°å½•å¤‡ä»½å®¹é‡
INSERT INTO backup_capacity_monitor (
    backup_type,
    backup_path,
    backup_size_bytes,
    backup_count,
    total_size_bytes
)
SELECT
    'full',
    '/backup/base',
    pg_size_bytes(pg_size_pretty(SUM(pg_database_size(datname)))),
    COUNT(*),
    pg_size_bytes(pg_size_pretty(SUM(pg_database_size(datname))))
FROM pg_database
WHERE datname NOT IN ('template0', 'template1', 'postgres');

-- æŸ¥è¯¢å¤‡ä»½å®¹é‡è¶‹åŠ¿
SELECT
    DATE(monitor_time) as monitor_date,
    backup_type,
    pg_size_pretty(SUM(total_size_bytes)) as total_size,
    AVG(backup_count) as avg_backup_count
FROM backup_capacity_monitor
WHERE monitor_time >= NOW() - INTERVAL '30 days'
GROUP BY DATE(monitor_time), backup_type
ORDER BY monitor_date DESC;
```

### 6.3 å¤‡ä»½å®¡è®¡

```sql
-- åˆ›å»ºå¤‡ä»½å®¡è®¡è¡¨
CREATE TABLE IF NOT EXISTS backup_audit (
    audit_id SERIAL PRIMARY KEY,
    backup_time TIMESTAMP DEFAULT NOW(),
    backup_type VARCHAR(50),  -- 'full', 'incremental', 'logical'
    backup_path TEXT,
    backup_size BIGINT,
    backup_duration_seconds INTEGER,
    backup_by VARCHAR(100),
    backup_status VARCHAR(20),  -- 'success', 'failed'
    notes TEXT
);

-- åˆ›å»ºæ¢å¤å®¡è®¡è¡¨
CREATE TABLE IF NOT EXISTS restore_audit (
    audit_id SERIAL PRIMARY KEY,
    restore_time TIMESTAMP DEFAULT NOW(),
    backup_path TEXT,
    restore_target_time TIMESTAMP,
    restore_duration_seconds INTEGER,
    restore_by VARCHAR(100),
    restore_status VARCHAR(20),  -- 'success', 'failed', 'partial'
    data_verified BOOLEAN,
    notes TEXT
);

-- æŸ¥è¯¢å¤‡ä»½å†å²
SELECT
    backup_time,
    backup_type,
    pg_size_pretty(backup_size) as backup_size,
    backup_duration_seconds,
    backup_status
FROM backup_audit
ORDER BY backup_time DESC
LIMIT 20;
```

## 7. å¸¸è§é—®é¢˜

- å½’æ¡£å µå¡ï¼šç›‘æ§ `archiver` å¤±è´¥ï¼Œæ£€æŸ¥å½’æ¡£ç›®å½•å®¹é‡ä¸æƒé™ï¼›
- åŸºçº¿è¿‡æ—§ï¼šæ¢å¤æ—¶é—´æ‹‰é•¿ï¼Œé€‚å½“æå‡å…¨é‡é¢‘æ¬¡æˆ–æ‰“å¼€å¢é‡åŸºç¡€å¤‡ä»½æ–¹æ¡ˆï¼›
- è·¨ç‰ˆæœ¬è¿˜åŸï¼šé€»è¾‘å¤‡ä»½ä¼˜å…ˆï¼Œæˆ–ä½¿ç”¨å…¼å®¹çš„å‡çº§è·¯å¾„ï¼ˆ`pg_upgrade`ï¼‰ã€‚

### 7.1 å½’æ¡£å µå¡é—®é¢˜

**é—®é¢˜è¯Šæ–­**:

```sql
-- æ£€æŸ¥å½’æ¡£çŠ¶æ€
SELECT
    archived_count,
    failed_count,
    last_failed_wal,
    last_failed_time,
    last_archived_wal,
    last_archived_time,
    stats_reset
FROM pg_stat_archiver;

-- æ£€æŸ¥å½’æ¡£å»¶è¿Ÿ
SELECT
    pg_current_wal_lsn() as current_lsn,
    pg_last_wal_replay_lsn() as last_replay_lsn,
    pg_wal_lsn_diff(
        pg_current_wal_lsn(),
        pg_last_wal_replay_lsn()
    ) as lag_bytes;

-- æ£€æŸ¥WALæ–‡ä»¶ç§¯å‹
SELECT
    COUNT(*) as wal_files,
    pg_size_pretty(SUM(size)) as total_size
FROM pg_ls_waldir();
```

**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ³•**:

```bash
# 1. å½’æ¡£ç›®å½•ç©ºé—´ä¸è¶³
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /archive
du -sh /archive/*

# è§£å†³æ–¹æ³•ï¼šæ¸…ç†æ—§å½’æ¡£
find /archive -name "*.wal" -mtime +7 -delete
find /archive -name "*.gz" -mtime +7 -delete

# æˆ–å¢åŠ å­˜å‚¨
# æ‰©å±•LVMå·
lvextend -L +100G /dev/vg/archive_lv
resize2fs /dev/vg/archive_lv

# 2. å½’æ¡£ç›®å½•æƒé™é—®é¢˜
# æ£€æŸ¥æƒé™
ls -ld /archive
ls -l /archive | head -10

# è§£å†³æ–¹æ³•ï¼šä¿®å¤æƒé™
chown -R postgres:postgres /archive
chmod 700 /archive

# 3. å½’æ¡£å‘½ä»¤å¤±è´¥
# æµ‹è¯•å½’æ¡£å‘½ä»¤
test ! -f /archive/test.wal && \
    cp /var/lib/postgresql/data/pg_wal/000000010000000000000001 /archive/test.wal

# æ£€æŸ¥å½’æ¡£å‘½ä»¤é…ç½®
psql -c "SHOW archive_command;"

# è§£å†³æ–¹æ³•ï¼šä¿®å¤å½’æ¡£å‘½ä»¤
# åœ¨postgresql.confä¸­
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'

# æˆ–ä½¿ç”¨rsyncï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
archive_command = 'rsync -a %p /archive/%f'

# 4. å½’æ¡£ç›®å½•ä¸å­˜åœ¨
# æ£€æŸ¥ç›®å½•
ls -ld /archive

# è§£å†³æ–¹æ³•ï¼šåˆ›å»ºç›®å½•
mkdir -p /archive
chown postgres:postgres /archive
chmod 700 /archive

# 5. ç½‘ç»œé—®é¢˜ï¼ˆè¿œç¨‹å½’æ¡£ï¼‰
# æµ‹è¯•ç½‘ç»œè¿æ¥
ping -c 3 archive_server
nc -zv archive_server 22

# è§£å†³æ–¹æ³•ï¼šæ£€æŸ¥ç½‘ç»œé…ç½®
# ä½¿ç”¨scpå½’æ¡£
archive_command = 'scp %p archive_server:/archive/%f'

# æˆ–ä½¿ç”¨NFSæŒ‚è½½
mount -t nfs archive_server:/archive /archive

# 6. å½’æ¡£å‘½ä»¤æ‰§è¡Œæ—¶é—´è¿‡é•¿
# æ£€æŸ¥å½’æ¡£å‘½ä»¤æ€§èƒ½
time cp /var/lib/postgresql/data/pg_wal/000000010000000000000001 /archive/test.wal

# è§£å†³æ–¹æ³•ï¼šä¼˜åŒ–å½’æ¡£å‘½ä»¤
# ä½¿ç”¨å‹ç¼©å½’æ¡£ï¼ˆå‡å°‘I/Oï¼‰
archive_command = 'gzip < %p > /archive/%f.gz'

# æˆ–ä½¿ç”¨å¹¶è¡Œå½’æ¡£
archive_command = 'pg_archivecleanup /archive %f && cp %p /archive/%f'
```

**è‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# diagnose_archive_issues.sh
# è‡ªåŠ¨è¯Šæ–­å½’æ¡£é—®é¢˜

ARCHIVE_DIR="/archive"
PGDATA="/var/lib/postgresql/data"

log_error() {
    echo "[ERROR] $1" >&2
}

log_info() {
    echo "[INFO] $1"
}

# æ£€æŸ¥1: å½’æ¡£çŠ¶æ€
log_info "æ£€æŸ¥å½’æ¡£çŠ¶æ€..."
ARCHIVE_STATUS=$(psql -t -c "
SELECT
    CASE
        WHEN failed_count > 0 THEN 'FAILED'
        WHEN last_archived_time < NOW() - INTERVAL '5 minutes' THEN 'DELAYED'
        ELSE 'OK'
    END
FROM pg_stat_archiver;
" | xargs)

if [ "$ARCHIVE_STATUS" != "OK" ]; then
    log_error "å½’æ¡£çŠ¶æ€å¼‚å¸¸: $ARCHIVE_STATUS"
    psql -c "SELECT * FROM pg_stat_archiver;"
fi

# æ£€æŸ¥2: ç£ç›˜ç©ºé—´
log_info "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
DISK_USAGE=$(df -h "$ARCHIVE_DIR" | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 80 ]; then
    log_error "å½’æ¡£ç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%"
    log_info "å»ºè®®æ¸…ç†æ—§å½’æ¡£æ–‡ä»¶"
fi

# æ£€æŸ¥3: ç›®å½•æƒé™
log_info "æ£€æŸ¥ç›®å½•æƒé™..."
if [ ! -w "$ARCHIVE_DIR" ]; then
    log_error "å½’æ¡£ç›®å½•ä¸å¯å†™"
    log_info "å½“å‰æƒé™: $(ls -ld $ARCHIVE_DIR)"
fi

# æ£€æŸ¥4: WALæ–‡ä»¶ç§¯å‹
log_info "æ£€æŸ¥WALæ–‡ä»¶ç§¯å‹..."
WAL_COUNT=$(psql -t -c "SELECT COUNT(*) FROM pg_ls_waldir();" | xargs)
if [ "$WAL_COUNT" -gt 16 ]; then
    log_error "WALæ–‡ä»¶ç§¯å‹: $WAL_COUNT ä¸ªæ–‡ä»¶"
    log_info "å»ºè®®æ£€æŸ¥å½’æ¡£å‘½ä»¤æ˜¯å¦æ­£å¸¸æ‰§è¡Œ"
fi

# æ£€æŸ¥5: å½’æ¡£å‘½ä»¤æµ‹è¯•
log_info "æµ‹è¯•å½’æ¡£å‘½ä»¤..."
ARCHIVE_CMD=$(psql -t -c "SHOW archive_command;" | xargs)
if [ -n "$ARCHIVE_CMD" ]; then
    TEST_WAL=$(psql -t -c "SELECT name FROM pg_ls_waldir() LIMIT 1;" | xargs)
    if [ -n "$TEST_WAL" ]; then
        TEST_CMD=$(echo "$ARCHIVE_CMD" | sed "s|%p|$PGDATA/pg_wal/$TEST_WAL|g" | sed "s|%f|$TEST_WAL|g")
        if eval "$TEST_CMD" 2>/dev/null; then
            log_info "å½’æ¡£å‘½ä»¤æµ‹è¯•æˆåŠŸ"
        else
            log_error "å½’æ¡£å‘½ä»¤æµ‹è¯•å¤±è´¥"
            log_info "å‘½ä»¤: $TEST_CMD"
        fi
    fi
fi

log_info "è¯Šæ–­å®Œæˆ"
```

**é¢„é˜²æªæ–½**:

```sql
-- åˆ›å»ºå½’æ¡£ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW archive_monitor AS
SELECT
    archived_count,
    failed_count,
    last_failed_wal,
    last_failed_time,
    CASE
        WHEN failed_count > 0 THEN 'CRITICAL'
        WHEN last_archived_time < NOW() - INTERVAL '5 minutes' THEN 'WARNING'
        ELSE 'OK'
    END as status,
    NOW() - last_archived_time as archive_delay
FROM pg_stat_archiver;

-- æŸ¥è¯¢å½’æ¡£ç›‘æ§
SELECT * FROM archive_monitor;

-- è®¾ç½®å‘Šè­¦ï¼ˆä½¿ç”¨pg_cronï¼‰
CREATE EXTENSION IF NOT EXISTS pg_cron;

SELECT cron.schedule(
    'archive-monitor',
    '*/5 * * * *',  -- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    $$
    DO $$
    DECLARE
        archive_status TEXT;
    BEGIN
        SELECT status INTO archive_status FROM archive_monitor;
        IF archive_status != 'OK' THEN
            -- å‘é€å‘Šè­¦ï¼ˆè¿™é‡Œå¯ä»¥é›†æˆå‘Šè­¦ç³»ç»Ÿï¼‰
            RAISE WARNING 'Archive status: %', archive_status;
        END IF;
    END $$;
    $$
);
```

### 7.2 åŸºçº¿è¿‡æ—§é—®é¢˜

```bash
# é—®é¢˜ï¼šæ¢å¤æ—¶éœ€è¦åº”ç”¨å¤§é‡WALæ–‡ä»¶ï¼Œæ¢å¤æ—¶é—´è¿‡é•¿

# è§£å†³æ–¹æ³•1: å¢åŠ å…¨é‡å¤‡ä»½é¢‘ç‡
# ä»æ¯å‘¨å…¨é‡æ”¹ä¸ºæ¯3å¤©å…¨é‡

# è§£å†³æ–¹æ³•2: ä½¿ç”¨å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18ï¼‰
# å‘¨å…¨é‡ + æ—¥å¢é‡ï¼Œå‡å°‘æ¢å¤é“¾é•¿åº¦

# è§£å†³æ–¹æ³•3: å®šæœŸåˆ›å»ºæ–°çš„åŸºç¡€å¤‡ä»½
# æ¯æœˆåˆ›å»ºæ–°çš„åŸºç¡€å¤‡ä»½ï¼Œæ¸…ç†æ—§çš„å¤‡ä»½é“¾
```

### 7.3 è·¨ç‰ˆæœ¬è¿˜åŸ

**é—®é¢˜è¯´æ˜**:

ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰åªèƒ½åœ¨ç›¸åŒä¸»ç‰ˆæœ¬ä¹‹é—´æ¢å¤ï¼Œä¾‹å¦‚ï¼š

- PostgreSQL 16 â†’ PostgreSQL 16 âœ…
- PostgreSQL 16 â†’ PostgreSQL 18 âŒ

è·¨ç‰ˆæœ¬æ¢å¤éœ€è¦ä½¿ç”¨é€»è¾‘å¤‡ä»½æˆ–å‡çº§å·¥å…·ã€‚

**è§£å†³æ–¹æ³•1: ä½¿ç”¨é€»è¾‘å¤‡ä»½ï¼ˆæ¨èï¼‰**:

```bash
# æ­¥éª¤1: åœ¨æ—§ç‰ˆæœ¬å¯¼å‡º
pg_dump -F c -j 4 -d old_db -f old_db.dump

# æ­¥éª¤2: åœ¨æ–°ç‰ˆæœ¬åˆ›å»ºæ•°æ®åº“
createdb new_db

# æ­¥éª¤3: åœ¨æ–°ç‰ˆæœ¬æ¢å¤
pg_restore -d new_db -j 4 old_db.dump

# éªŒè¯æ¢å¤
psql -d new_db -c "\dt"
psql -d new_db -c "SELECT COUNT(*) FROM your_table;"
```

**è§£å†³æ–¹æ³•2: ä½¿ç”¨pg_upgradeï¼ˆåŸåœ°å‡çº§ï¼‰**:

```bash
# å‰ç½®æ£€æŸ¥
pg_upgrade --check \
    --old-datadir=/var/lib/postgresql/16/data \
    --new-datadir=/var/lib/postgresql/18/data \
    --old-bindir=/usr/lib/postgresql/16/bin \
    --new-bindir=/usr/lib/postgresql/18/bin

# å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œæ‰§è¡Œå‡çº§
pg_upgrade \
    --old-datadir=/var/lib/postgresql/16/data \
    --new-datadir=/var/lib/postgresql/18/data \
    --old-bindir=/usr/lib/postgresql/16/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --link  # ä½¿ç”¨ç¡¬é“¾æ¥åŠ é€Ÿï¼ˆå¯é€‰ï¼‰

# å‡çº§åæ¸…ç†
./delete_old_cluster.sh
```

**è§£å†³æ–¹æ³•3: ä½¿ç”¨é€»è¾‘å¤åˆ¶ï¼ˆè·¨ç‰ˆæœ¬è¿ç§»ï¼‰**:

```sql
-- åœ¨æºåº“ï¼ˆPostgreSQL 16ï¼‰åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION my_pub FOR ALL TABLES;

-- åœ¨ç›®æ ‡åº“ï¼ˆPostgreSQL 18ï¼‰åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=source_host port=5432 user=replicator password=password dbname=mydb'
PUBLICATION my_pub;

-- ç­‰å¾…åŒæ­¥å®Œæˆ
SELECT * FROM pg_subscription;
SELECT * FROM pg_stat_subscription;

-- éªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT COUNT(*) FROM source_table;  -- æºåº“
SELECT COUNT(*) FROM source_table;  -- ç›®æ ‡åº“

-- åˆ‡æ¢åº”ç”¨è¿æ¥åï¼Œåˆ é™¤è®¢é˜…
DROP SUBSCRIPTION my_sub;
```

**è§£å†³æ–¹æ³•4: ä½¿ç”¨pg_dumpallï¼ˆå…¨åº“è¿ç§»ï¼‰**:

```bash
# å¯¼å‡ºæ‰€æœ‰æ•°æ®åº“
pg_dumpall -h old_host -U postgres -f all_databases.sql

# åœ¨æ–°ç‰ˆæœ¬æ¢å¤
psql -h new_host -U postgres -f all_databases.sql

# æ³¨æ„ï¼šéœ€è¦å…ˆåˆ›å»ºç”¨æˆ·å’Œè§’è‰²
pg_dumpall -h old_host -U postgres --globals-only -f globals.sql
psql -h new_host -U postgres -f globals.sql
```

**ç‰ˆæœ¬å…¼å®¹æ€§çŸ©é˜µ**:

| æºç‰ˆæœ¬ | ç›®æ ‡ç‰ˆæœ¬ | ç‰©ç†å¤‡ä»½ | é€»è¾‘å¤‡ä»½ | pg_upgrade | é€»è¾‘å¤åˆ¶ |
|--------|---------|---------|---------|-----------|---------|
| 16 â†’ 16 | âœ… | âœ… | âœ… | âœ… | âœ… |
| 16 â†’ 17 | âŒ | âœ… | âœ… | âœ… | âœ… |
| 16 â†’ 18 | âŒ | âœ… | âœ… | âœ… | âœ… |
| 17 â†’ 18 | âŒ | âœ… | âœ… | âœ… | âœ… |

**æœ€ä½³å®è·µ**:

```bash
# 1. è·¨ç‰ˆæœ¬è¿ç§»å‰æ£€æŸ¥
# æ£€æŸ¥æ‰©å±•å…¼å®¹æ€§
psql -d old_db -c "\dx"

# æ£€æŸ¥è‡ªå®šä¹‰å‡½æ•°
psql -d old_db -c "\df"

# æ£€æŸ¥æ•°æ®ç±»å‹
psql -d old_db -c "\dT+"

# 2. ä½¿ç”¨é€»è¾‘å¤‡ä»½è¿ç§»ï¼ˆæ¨èç”¨äºè·¨ç‰ˆæœ¬ï¼‰
#!/bin/bash
# cross_version_migration.sh

OLD_HOST="old_host"
NEW_HOST="new_host"
DB_NAME="mydb"

# å¯¼å‡º
pg_dump -h "$OLD_HOST" -F c -j 4 -d "$DB_NAME" -f "${DB_NAME}.dump"

# åœ¨æ–°ç‰ˆæœ¬åˆ›å»ºæ•°æ®åº“
createdb -h "$NEW_HOST" "$DB_NAME"

# æ¢å¤
pg_restore -h "$NEW_HOST" -d "$DB_NAME" -j 4 "${DB_NAME}.dump"

# éªŒè¯
psql -h "$NEW_HOST" -d "$DB_NAME" -c "\dt"
psql -h "$NEW_HOST" -d "$DB_NAME" -c "SELECT version();"
```

**æ•…éšœæ’æŸ¥**:

```bash
# é—®é¢˜1: pg_upgradeæ£€æŸ¥å¤±è´¥
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pg_upgrade --check --verbose

# å¸¸è§é—®é¢˜ï¼š
# - æ‰©å±•ä¸å…¼å®¹ï¼šéœ€è¦åœ¨æ–°ç‰ˆæœ¬å®‰è£…å…¼å®¹ç‰ˆæœ¬
# - æ•°æ®ç±»å‹ä¸å…¼å®¹ï¼šéœ€è¦æ‰‹åŠ¨è¿ç§»
# - å‡½æ•°ä¸å…¼å®¹ï¼šéœ€è¦æ›´æ–°å‡½æ•°å®šä¹‰

# é—®é¢˜2: é€»è¾‘å¤‡ä»½æ¢å¤å¤±è´¥
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pg_restore -d new_db backup.dump 2>&1 | tee restore.log

# å¸¸è§é—®é¢˜ï¼š
# - æƒé™ä¸è¶³ï¼šéœ€è¦æˆäºˆç›¸åº”æƒé™
# - æ‰©å±•ç¼ºå¤±ï¼šéœ€è¦å…ˆå®‰è£…æ‰©å±•
# - æ•°æ®ç±»å‹ä¸å…¼å®¹ï¼šéœ€è¦æ‰‹åŠ¨è°ƒæ•´

# é—®é¢˜3: é€»è¾‘å¤åˆ¶åŒæ­¥å¤±è´¥
# æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_subscription;
SELECT * FROM pg_replication_slots;

# æŸ¥çœ‹é”™è¯¯
SELECT * FROM pg_stat_subscription_stats;
```

## 8. äº¤å‰å¼•ç”¨

**ç›¸å…³æ–‡æ¡£**ï¼š

### ç‰ˆæœ¬ç‰¹æ€§

- â­â­â­ [PostgreSQL 18æ–°ç‰¹æ€§](../../02-ç‰ˆæœ¬ç‰¹æ€§/02.01-PostgreSQL-18-æ–°ç‰¹æ€§.md) - å¢é‡å¤‡ä»½è¯¦è§£
- â­â­ [ç‰ˆæœ¬å¯¹æ¯”ä¸è¿ç§»æŒ‡å—](../../02-ç‰ˆæœ¬ç‰¹æ€§/02.03-ç‰ˆæœ¬å¯¹æ¯”ä¸è¿ç§»æŒ‡å—.md) - ç‰ˆæœ¬è¿ç§»

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - WALæœºåˆ¶
- â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡æ¢å¤

#### éƒ¨ç½²æ¶æ„

- â­â­ [å•æœºéƒ¨ç½²ä¸é…ç½®](../../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.01-å•æœºéƒ¨ç½²ä¸é…ç½®.md) - åˆå§‹é…ç½®
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../../05-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - å¤åˆ¶ä¸å¤‡ç”¨åº“

#### è¿ç»´å®è·µ

- â­â­â­ [å¢é‡å¤‡ä»½ä¸æ¢å¤](../06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - PostgreSQL 18å¢é‡å¤‡ä»½å®è·µ
- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - å¤‡ä»½ç›‘æ§

### 8.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
- [Dockeréƒ¨ç½²æŒ‡å—](../../05-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å¤‡ä»½é…ç½®å®è·µ
- [å¢é‡å¤‡ä»½ä¸æ¢å¤](../å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - PostgreSQL 18å¢é‡å¤‡ä»½å®è·µ

**å®˜æ–¹èµ„æº**ï¼š

- [PostgreSQL 18 Backup Documentation](https://www.postgresql.org/docs/18/backup.html)
- [pg_basebackup Documentation](https://www.postgresql.org/docs/18/app-pgbasebackup.html)
- [pg_combinebackup Documentation](https://www.postgresql.org/docs/18/app-pgcombinebackup.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**æœ€åæ›´æ–°**: 2025-11-12
**ç»´æŠ¤è€…**: Documentation Team

**å˜æ›´å†å²**:

- 2025-11-12 v2.1: æ›´æ–°è‡³PostgreSQL 18ï¼Œæ›´æ–°æ‰€æœ‰é“¾æ¥å’Œç‰ˆæœ¬å¼•ç”¨
- 2025-10-30 v2.0: å¢åŠ PostgreSQL 17å¢é‡å¤‡ä»½å®Œæ•´æŒ‡å—
- åŸç‰ˆæœ¬: åŸºç¡€å¤‡ä»½ä¸æ¢å¤æ–‡æ¡£
