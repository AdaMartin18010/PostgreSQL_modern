---

> **ğŸ“‹ æ–‡æ¡£æ¥æº**: `PostgreSQL\06-è¿ç»´å®è·µ\å¤‡ä»½ä¸æ¢å¤\06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md`
> **ğŸ“… å¤åˆ¶æ—¥æœŸ**: 2025-12-22
> **âš ï¸ æ³¨æ„**: æœ¬æ–‡æ¡£ä¸ºå¤åˆ¶ç‰ˆæœ¬ï¼ŒåŸæ–‡ä»¶ä¿æŒä¸å˜

---

# Runbookï¼šå¢é‡å¤‡ä»½ä¸æ¢å¤ï¼ˆPostgreSQL 18ï¼‰

## ç›®æ ‡

åˆ©ç”¨ PostgreSQL 18 çš„å¢é‡å¤‡ä»½åŠŸèƒ½ä¸ WAL å½’æ¡£ï¼Œæ„å»ºé«˜æ•ˆã€å¯æ¼”ç»ƒçš„å¤‡ä»½æ¢å¤æµç¨‹ï¼Œå®ç° RTO/RPO ç›®æ ‡ã€‚

## å‰ç½®æ¡ä»¶

- PostgreSQL 18+ ç‰ˆæœ¬
- é…ç½® WAL å½’æ¡£ï¼ˆarchive_modeã€archive_commandï¼‰
- é…ç½® WAL Summarizerï¼ˆPostgreSQL 18 é»˜è®¤å¯ç”¨ï¼‰
- å¤‡ä»½å­˜å‚¨ç©ºé—´è§„åˆ’
- ç›‘æ§å‘Šè­¦é…ç½®

### å‰ç½®é…ç½®

```sql
-- 1. å¯ç”¨WALå½’æ¡£
-- postgresql.conf
archive_mode = on
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'
wal_level = replica

-- 2. éªŒè¯WAL SummarizerçŠ¶æ€ï¼ˆPostgreSQL 18ï¼‰
SELECT * FROM pg_stat_wal_summarizer;

-- 3. æ£€æŸ¥å½’æ¡£çŠ¶æ€
SELECT * FROM pg_stat_archiver;
```

## æ­¥éª¤

### æ­¥éª¤1: åŸºç¡€å…¨é‡å¤‡ä»½

```bash
# åˆ›å»ºå…¨é‡å¤‡ä»½ï¼ˆä½œä¸ºå¢é‡å¤‡ä»½çš„åŸºå‡†ï¼‰
pg_basebackup \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -v \
    -F plain

# è®°å½•å¤‡ä»½LSNï¼ˆç”¨äºåç»­å¢é‡å¤‡ä»½ï¼‰
psql -c "SELECT pg_current_wal_lsn();" > /backup/base/backup_lsn.txt

# éªŒè¯å¤‡ä»½
ls -lh /backup/base/
```

### æ­¥éª¤2: å¢é‡å¤‡ä»½ï¼ˆPostgreSQL 18ï¼‰

```bash
# PostgreSQL 18å¢é‡å¤‡ä»½
pg_basebackup \
    -D /backup/incremental/$(date +%Y%m%d_%H%M%S) \
    --incremental \
    --incremental-base=/backup/base/20241122_020000 \
    -X stream \
    -P \
    -v \
    -F plain

# å¢é‡å¤‡ä»½é€‰é¡¹è¯´æ˜ï¼š
# --incremental: å¯ç”¨å¢é‡å¤‡ä»½
# --incremental-base: æŒ‡å®šåŸºå‡†å¤‡ä»½è·¯å¾„
# -X stream: åŒæ—¶å¤‡ä»½WALæ–‡ä»¶
# -P: æ˜¾ç¤ºè¿›åº¦
# -v: è¯¦ç»†è¾“å‡º
```

### æ­¥éª¤3: å¤‡ä»½éªŒè¯

```bash
# 1. æ£€æŸ¥å¤‡ä»½ç›®å½•ç»“æ„
ls -lh /backup/incremental/

# 2. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
pg_checksums -D /backup/incremental/20241122_120000 --check

# 3. æ£€æŸ¥å¤‡ä»½å¤§å°
du -sh /backup/incremental/20241122_120000

# 4. éªŒè¯WALæ–‡ä»¶
ls -lh /backup/incremental/20241122_120000/pg_wal/
```

### æ­¥éª¤4: æ¢å¤å‡†å¤‡

```bash
# 1. åœæ­¢PostgreSQLæœåŠ¡ï¼ˆå¦‚æœæ¢å¤ï¼‰
systemctl stop postgresql

# 2. å¤‡ä»½å½“å‰æ•°æ®ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
mv /var/lib/postgresql/data /var/lib/postgresql/data.old

# 3. å‡†å¤‡æ¢å¤ç›®å½•
mkdir -p /var/lib/postgresql/data
```

### æ­¥éª¤5: æ‰§è¡Œæ¢å¤

```bash
# æ–¹æ³•1: ä»å…¨é‡å¤‡ä»½æ¢å¤
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ–¹æ³•2: ä»å¢é‡å¤‡ä»½æ¢å¤ï¼ˆéœ€è¦å…ˆæ¢å¤åŸºå‡†å¤‡ä»½ï¼‰
# æ­¥éª¤1: æ¢å¤åŸºå‡†å¤‡ä»½
cp -r /backup/base/20241122_020000/* /var/lib/postgresql/data/

# æ­¥éª¤2: åº”ç”¨å¢é‡å¤‡ä»½
rsync -av /backup/incremental/20241122_120000/ /var/lib/postgresql/data/

# 3. é…ç½®æ¢å¤å‚æ•°
cat > /var/lib/postgresql/data/postgresql.auto.conf <<EOF
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2024-11-22 12:00:00'  # å¯é€‰ï¼šæ—¶é—´ç‚¹æ¢å¤
# recovery_target_lsn = '0/1234567'  # å¯é€‰ï¼šLSNæ¢å¤
# recovery_target_name = 'backup_point'  # å¯é€‰ï¼šå‘½åæ¢å¤ç‚¹
EOF

# 4. åˆ›å»ºæ¢å¤ä¿¡å·æ–‡ä»¶
touch /var/lib/postgresql/data/recovery.signal

# 5. å¯åŠ¨PostgreSQL
systemctl start postgresql

# 6. ç›‘æ§æ¢å¤è¿›åº¦
tail -f /var/log/postgresql/postgresql.log
```

### æ­¥éª¤6: æ¢å¤éªŒè¯

```sql
-- 1. æ£€æŸ¥æ¢å¤çŠ¶æ€
SELECT pg_is_in_recovery();

-- 2. éªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT
    schemaname,
    tablename,
    n_live_tup
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC
LIMIT 10;

-- 3. æ£€æŸ¥æ¢å¤ç‚¹
SELECT
    pg_last_wal_replay_lsn(),
    pg_last_wal_replay_timestamp();

-- 4. ä¸šåŠ¡æ•°æ®éªŒè¯ï¼ˆç¤ºä¾‹ï¼‰
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM users;
SELECT MAX(created_at) FROM orders;

-- 5. å®Œæˆæ¢å¤ï¼ˆå¦‚æœä½¿ç”¨recovery.signalï¼‰
-- æ¢å¤å®Œæˆåï¼ŒPostgreSQLä¼šè‡ªåŠ¨é‡å‘½årecovery.signalä¸ºrecovery.done
```

## éªŒè¯æ¸…å•

- å¤‡ä»½å¯è¯»ã€æ ¡éªŒé€šè¿‡ï¼ˆhash/å¤§å°/ç›®å½•ç»“æ„ï¼‰
- æ¢å¤åç³»ç»Ÿä¸€è‡´ï¼ˆç³»ç»Ÿè¡¨ä¸ä¸šåŠ¡è¡¨è®¡æ•°/æŠ½æ ·å¯¹æ¯”ï¼‰
- ç›‘æ§äº‹ä»¶å®Œæ•´ï¼ˆå¤‡ä»½æ—¶é•¿ã€WAL é‡ã€é”™è¯¯æ—¥å¿—ï¼‰
- RTO/RPO è¾¾æ ‡å¹¶ç•™å­˜è®°å½•

### è¯¦ç»†éªŒè¯æ­¥éª¤

```bash
# 1. å¤‡ä»½å®Œæ•´æ€§éªŒè¯
pg_checksums -D /backup/incremental/20241122_120000 --check
# è¾“å‡ºï¼šChecksum operation completed
# è¾“å‡ºï¼šFiles scanned: XXXX
# è¾“å‡ºï¼šBlocks scanned: XXXX
# è¾“å‡ºï¼šBad checksums: 0

# 2. å¤‡ä»½å¤§å°éªŒè¯
du -sh /backup/base/20241122_020000
du -sh /backup/incremental/20241122_120000
# å¢é‡å¤‡ä»½åº”è¯¥æ˜æ˜¾å°äºå…¨é‡å¤‡ä»½ï¼ˆé€šå¸¸èŠ‚çœ90%+ç©ºé—´ï¼‰

# 3. WALæ–‡ä»¶éªŒè¯
ls -lh /backup/incremental/20241122_120000/pg_wal/
# åº”è¯¥åŒ…å«å¿…è¦çš„WALæ–‡ä»¶

# 4. æ¢å¤åæ•°æ®éªŒè¯
psql -c "SELECT pg_database_size('postgres');"
psql -c "SELECT COUNT(*) FROM pg_stat_user_tables;"
psql -c "SELECT COUNT(*) FROM orders WHERE created_at >= '2024-11-22';"
```

## è‡ªåŠ¨åŒ–è„šæœ¬

### å…¨é‡å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# full_backup.sh

BACKUP_BASE="/backup/base"
BACKUP_DIR="${BACKUP_BASE}/$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/postgresql/backup.log"

echo "$(date): Starting full backup to ${BACKUP_DIR}" >> ${LOG_FILE}

pg_basebackup \
    -D ${BACKUP_DIR} \
    -X stream \
    -P \
    -v \
    -F plain \
    2>&1 | tee -a ${LOG_FILE}

if [ $? -eq 0 ]; then
    # è®°å½•å¤‡ä»½LSN
    psql -t -c "SELECT pg_current_wal_lsn();" > ${BACKUP_DIR}/backup_lsn.txt

    # è®°å½•å¤‡ä»½å…ƒæ•°æ®
    echo "$(date): Backup completed: ${BACKUP_DIR}" >> ${LOG_FILE}
    echo "Backup size: $(du -sh ${BACKUP_DIR} | cut -f1)" >> ${LOG_FILE}

    # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
    find ${BACKUP_BASE} -type d -mtime +7 -exec rm -rf {} \;
else
    echo "$(date): Backup failed!" >> ${LOG_FILE}
    exit 1
fi
```

### å¢é‡å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# incremental_backup.sh

BACKUP_BASE="/backup/base"
BACKUP_INCREMENTAL="/backup/incremental"
LATEST_BASE=$(ls -td ${BACKUP_BASE}/*/ | head -1)
BACKUP_DIR="${BACKUP_INCREMENTAL}/$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/postgresql/backup.log"

if [ -z "${LATEST_BASE}" ]; then
    echo "$(date): No base backup found, running full backup first" >> ${LOG_FILE}
    /usr/local/bin/full_backup.sh
    LATEST_BASE=$(ls -td ${BACKUP_BASE}/*/ | head -1)
fi

echo "$(date): Starting incremental backup to ${BACKUP_DIR}" >> ${LOG_FILE}
echo "$(date): Base backup: ${LATEST_BASE}" >> ${LOG_FILE}

pg_basebackup \
    -D ${BACKUP_DIR} \
    --incremental \
    --incremental-base=${LATEST_BASE} \
    -X stream \
    -P \
    -v \
    -F plain \
    2>&1 | tee -a ${LOG_FILE}

if [ $? -eq 0 ]; then
    echo "$(date): Incremental backup completed: ${BACKUP_DIR}" >> ${LOG_FILE}
    echo "Backup size: $(du -sh ${BACKUP_DIR} | cut -f1)" >> ${LOG_FILE}

    # æ¸…ç†æ—§å¢é‡å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
    find ${BACKUP_INCREMENTAL} -type d -mtime +30 -exec rm -rf {} \;
else
    echo "$(date): Incremental backup failed!" >> ${LOG_FILE}
    exit 1
fi
```

### æ¢å¤è„šæœ¬

```bash
#!/bin/bash
# restore.sh

BACKUP_PATH=$1
RECOVERY_TIME=$2  # å¯é€‰ï¼šæ—¶é—´ç‚¹æ¢å¤
DATA_DIR="/var/lib/postgresql/data"

if [ -z "${BACKUP_PATH}" ]; then
    echo "Usage: $0 <backup_path> [recovery_time]"
    exit 1
fi

echo "Stopping PostgreSQL..."
systemctl stop postgresql

echo "Backing up current data directory..."
mv ${DATA_DIR} ${DATA_DIR}.old.$(date +%Y%m%d_%H%M%S)

echo "Restoring from backup: ${BACKUP_PATH}"
cp -r ${BACKUP_PATH}/* ${DATA_DIR}/

echo "Configuring recovery..."
cat > ${DATA_DIR}/postgresql.auto.conf <<EOF
restore_command = 'cp /archive/%f %p'
EOF

if [ -n "${RECOVERY_TIME}" ]; then
    echo "recovery_target_time = '${RECOVERY_TIME}'" >> ${DATA_DIR}/postgresql.auto.conf
fi

touch ${DATA_DIR}/recovery.signal

echo "Starting PostgreSQL..."
systemctl start postgresql

echo "Monitoring recovery..."
tail -f /var/log/postgresql/postgresql.log
```

## ç›‘æ§ä¸å‘Šè­¦

### å¤‡ä»½ç›‘æ§

```sql
-- 1. æ£€æŸ¥WAL SummarizerçŠ¶æ€
SELECT * FROM pg_stat_wal_summarizer;

-- 2. æ£€æŸ¥å½’æ¡£çŠ¶æ€
SELECT
    archived_count,
    last_archived_wal,
    last_archived_time,
    failed_count,
    last_failed_wal,
    last_failed_time
FROM pg_stat_archiver;

-- 3. æ£€æŸ¥å¤‡ä»½ç›®å½•
SELECT
    pg_size_pretty(pg_database_size(current_database())) as db_size,
    pg_size_pretty(
        (SELECT sum(pg_tablespace_size(spcname)) FROM pg_tablespace)
    ) as total_size;
```

### Prometheuså‘Šè­¦è§„åˆ™

```yaml
groups:
  - name: postgresql_backup
    rules:
      - alert: PostgreSQLBackupFailed
        expr: increase(pg_stat_archiver_failed_count[1h]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLå¤‡ä»½å¤±è´¥"
          description: "å½’æ¡£å¤±è´¥æ¬¡æ•°: {{ $value }}"

      - alert: PostgreSQLBackupLag
        expr: (now() - pg_stat_archiver_last_archived_time) > 1h
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLå¤‡ä»½å»¶è¿Ÿ"
          description: "æœ€åå½’æ¡£æ—¶é—´: {{ $value }}"
```

## æœ€ä½³å®è·µ

### å¤‡ä»½ç­–ç•¥

```bash
# æ¨èç­–ç•¥ï¼šå‘¨å…¨é‡ + æ—¥å¢é‡
# å‘¨ä¸€ï¼šå…¨é‡å¤‡ä»½
0 2 * * 1 /usr/local/bin/full_backup.sh

# å‘¨äºŒè‡³å‘¨æ—¥ï¼šå¢é‡å¤‡ä»½
0 2 * * 2-7 /usr/local/bin/incremental_backup.sh

# æ¸…ç†ç­–ç•¥
# å…¨é‡å¤‡ä»½ï¼šä¿ç•™4å‘¨
# å¢é‡å¤‡ä»½ï¼šä¿ç•™30å¤©
# WALå½’æ¡£ï¼šä¿ç•™7å¤©
```

### æ¢å¤æ¼”ç»ƒ

```bash
# æ¯æœˆæ‰§è¡Œä¸€æ¬¡æ¢å¤æ¼”ç»ƒ
# 1. åœ¨æµ‹è¯•ç¯å¢ƒæ¢å¤æœ€æ–°å¤‡ä»½
# 2. éªŒè¯æ•°æ®å®Œæ•´æ€§
# 3. æµ‹è¯•æ—¶é—´ç‚¹æ¢å¤
# 4. è®°å½•RTO/RPOæŒ‡æ ‡
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: å¢é‡å¤‡ä»½å¤±è´¥

**å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ³•**:

```bash
# é”™è¯¯1: could not open file "backup_manifest": No such file or directory
# åŸå› : åŸºç¡€å¤‡ä»½çš„manifestæ–‡ä»¶ä¸å­˜åœ¨æˆ–æŸå

# è§£å†³æ–¹æ³•1: æ£€æŸ¥manifestæ–‡ä»¶
ls -lh /backup/base/*/backup_manifest
cat /backup/base/*/backup_manifest | head -20

# è§£å†³æ–¹æ³•2: éªŒè¯å¤‡ä»½å®Œæ•´æ€§
pg_verifybackup -D /backup/base/20241122_020000

# è§£å†³æ–¹æ³•3: é‡æ–°åˆ›å»ºå…¨é‡å¤‡ä»½
pg_basebackup \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -F plain

# é”™è¯¯2: WAL summarizer is not running
# åŸå› : WAL Summarizeræœªå¯ç”¨æˆ–å·²åœæ­¢

# è§£å†³æ–¹æ³•1: æ£€æŸ¥WAL SummarizerçŠ¶æ€
psql -c "SELECT * FROM pg_stat_wal_summarizer;"

# è§£å†³æ–¹æ³•2: æ£€æŸ¥é…ç½®
psql -c "SHOW wal_level;"
psql -c "SHOW archive_mode;"

# è§£å†³æ–¹æ³•3: å¯ç”¨WAL Summarizerï¼ˆPostgreSQL 18é»˜è®¤å¯ç”¨ï¼‰
# åœ¨postgresql.confä¸­ç¡®ä¿ï¼š
# wal_level = replica  # æˆ– logical
# archive_mode = on

# é”™è¯¯3: No space left on device
# åŸå› : å¤‡ä»½ç›®å½•ç©ºé—´ä¸è¶³

# è§£å†³æ–¹æ³•1: æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /backup
du -sh /backup/base/*
du -sh /backup/incremental/*

# è§£å†³æ–¹æ³•2: æ¸…ç†æ—§å¤‡ä»½
find /backup/base -type d -mtime +30 -exec rm -rf {} \;
find /backup/incremental -type d -mtime +7 -exec rm -rf {} \;

# è§£å†³æ–¹æ³•3: ä½¿ç”¨å‹ç¼©å¤‡ä»½
pg_basebackup \
    -D /backup/incremental/$(date +%Y%m%d_%H%M%S) \
    --incremental \
    --incremental-base=/backup/base/20241122_020000 \
    -X stream \
    -F tar \
    -z

# é”™è¯¯4: could not read incremental backup manifest
# åŸå› : å¢é‡å¤‡ä»½çš„manifestæ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯

# è§£å†³æ–¹æ³•1: æ£€æŸ¥manifestæ–‡ä»¶
cat /backup/incremental/*/backup_manifest | head -50

# è§£å†³æ–¹æ³•2: éªŒè¯å¤‡ä»½
pg_verifybackup -D /backup/incremental/20241122_120000

# è§£å†³æ–¹æ³•3: é‡æ–°åˆ›å»ºå¢é‡å¤‡ä»½
# åˆ é™¤æŸåçš„å¢é‡å¤‡ä»½ï¼Œé‡æ–°åˆ›å»º

# é”™è¯¯5: base backup is too old
# åŸå› : åŸºç¡€å¤‡ä»½å¤ªæ—§ï¼ŒWALæ–‡ä»¶å·²æ¸…ç†

# è§£å†³æ–¹æ³•1: æ£€æŸ¥åŸºç¡€å¤‡ä»½å¹´é¾„
ls -lh /backup/base/
psql -c "SELECT pg_current_wal_lsn();"

# è§£å†³æ–¹æ³•2: åˆ›å»ºæ–°çš„åŸºç¡€å¤‡ä»½
pg_basebackup \
    -D /backup/base/$(date +%Y%m%d_%H%M%S) \
    -X stream \
    -P \
    -F plain

# è§£å†³æ–¹æ³•3: è°ƒæ•´WALä¿ç•™ç­–ç•¥
# åœ¨postgresql.confä¸­ï¼š
# max_wal_size = 4GB  # å¢åŠ WALä¿ç•™å¤§å°
# min_wal_size = 1GB
```

**è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# diagnose_incremental_backup.sh
# å¢é‡å¤‡ä»½æ•…éšœè¯Šæ–­è„šæœ¬

BASE_BACKUP="${1:-/backup/base/$(ls -td /backup/base/*/ | head -1 | xargs basename)}"
INCREMENTAL_BACKUP="${2:-/backup/incremental/$(ls -td /backup/incremental/*/ | head -1 | xargs basename)}"

echo "=== å¢é‡å¤‡ä»½è¯Šæ–­ ==="
echo "åŸºç¡€å¤‡ä»½: $BASE_BACKUP"
echo "å¢é‡å¤‡ä»½: $INCREMENTAL_BACKUP"
echo ""

# æ£€æŸ¥1: åŸºç¡€å¤‡ä»½æ˜¯å¦å­˜åœ¨
echo "1. æ£€æŸ¥åŸºç¡€å¤‡ä»½..."
if [ -d "$BASE_BACKUP" ]; then
    echo "   âœ“ åŸºç¡€å¤‡ä»½ç›®å½•å­˜åœ¨"
    if [ -f "$BASE_BACKUP/backup_manifest" ]; then
        echo "   âœ“ backup_manifestæ–‡ä»¶å­˜åœ¨"
        MANIFEST_SIZE=$(stat -f%z "$BASE_BACKUP/backup_manifest" 2>/dev/null || stat -c%s "$BASE_BACKUP/backup_manifest" 2>/dev/null)
        echo "   - manifestå¤§å°: $MANIFEST_SIZE å­—èŠ‚"
    else
        echo "   âœ— backup_manifestæ–‡ä»¶ä¸å­˜åœ¨"
    fi
else
    echo "   âœ— åŸºç¡€å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
fi

# æ£€æŸ¥2: WAL SummarizerçŠ¶æ€
echo ""
echo "2. æ£€æŸ¥WAL SummarizerçŠ¶æ€..."
WAL_SUM=$(psql -t -c "SELECT COUNT(*) FROM pg_stat_wal_summarizer;" 2>/dev/null | xargs)
if [ "$WAL_SUM" -gt 0 ]; then
    echo "   âœ“ WAL Summarizeræ­£åœ¨è¿è¡Œ"
    psql -c "SELECT * FROM pg_stat_wal_summarizer;" 2>/dev/null
else
    echo "   âœ— WAL Summarizeræœªè¿è¡Œ"
    echo "   æ£€æŸ¥é…ç½®: wal_level, archive_mode"
fi

# æ£€æŸ¥3: ç£ç›˜ç©ºé—´
echo ""
echo "3. æ£€æŸ¥ç£ç›˜ç©ºé—´..."
df -h /backup | tail -1

# æ£€æŸ¥4: å¢é‡å¤‡ä»½å®Œæ•´æ€§
echo ""
echo "4. æ£€æŸ¥å¢é‡å¤‡ä»½..."
if [ -d "$INCREMENTAL_BACKUP" ]; then
    echo "   âœ“ å¢é‡å¤‡ä»½ç›®å½•å­˜åœ¨"
    if [ -f "$INCREMENTAL_BACKUP/backup_manifest" ]; then
        echo "   âœ“ backup_manifestæ–‡ä»¶å­˜åœ¨"
        # éªŒè¯å¤‡ä»½
        pg_verifybackup -D "$INCREMENTAL_BACKUP" 2>&1 | head -20
    else
        echo "   âœ— backup_manifestæ–‡ä»¶ä¸å­˜åœ¨"
    fi
else
    echo "   âœ— å¢é‡å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
fi

# æ£€æŸ¥5: PostgreSQLæ—¥å¿—
echo ""
echo "5. æ£€æŸ¥PostgreSQLæ—¥å¿—ï¼ˆæœ€è¿‘é”™è¯¯ï¼‰..."
tail -50 /var/log/postgresql/postgresql.log | grep -i "error\|fail\|backup" | tail -10
```

### é—®é¢˜2: æ¢å¤æ—¶ç¼ºå°‘WALæ–‡ä»¶

**å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ³•**:

```bash
# é”™è¯¯1: could not open WAL file
# åŸå› : WALæ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯

# è§£å†³æ–¹æ³•1: æ£€æŸ¥WALå½’æ¡£ç›®å½•
ls -lh /archive/ | head -20
ls -lh /archive/ | grep "$(psql -t -c "SELECT pg_walfile_name(pg_last_wal_replay_lsn());" | xargs)"

# è§£å†³æ–¹æ³•2: æ£€æŸ¥æ¢å¤é…ç½®
cat /var/lib/postgresql/data/postgresql.auto.conf | grep restore_command

# è§£å†³æ–¹æ³•3: æ‰‹åŠ¨å¤åˆ¶ç¼ºå¤±çš„WALæ–‡ä»¶
# æŸ¥æ‰¾éœ€è¦çš„WALæ–‡ä»¶
psql -t -c "SELECT pg_walfile_name(pg_last_wal_replay_lsn());" | xargs -I {} cp /archive/{} /var/lib/postgresql/data/pg_wal/

# é”™è¯¯2: WAL file is from different database system
# åŸå› : WALæ–‡ä»¶æ¥è‡ªä¸åŒçš„æ•°æ®åº“å®ä¾‹

# è§£å†³æ–¹æ³•1: æ£€æŸ¥æ•°æ®åº“ç³»ç»Ÿæ ‡è¯†ç¬¦
psql -c "SELECT system_identifier FROM pg_control_system();"
# ä¸å¤‡ä»½çš„ç³»ç»Ÿæ ‡è¯†ç¬¦å¯¹æ¯”

# è§£å†³æ–¹æ³•2: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å¤‡ä»½å’ŒWALæ–‡ä»¶
# ä¸è¦æ··ç”¨ä¸åŒå®ä¾‹çš„å¤‡ä»½å’ŒWALæ–‡ä»¶

# é”™è¯¯3: requested WAL segment has already been removed
# åŸå› : éœ€è¦çš„WALæ–‡ä»¶å·²è¢«æ¸…ç†

# è§£å†³æ–¹æ³•1: æ£€æŸ¥WALä¿ç•™ç­–ç•¥
psql -c "SHOW max_wal_size;"
psql -c "SHOW min_wal_size;"
psql -c "SELECT * FROM pg_stat_archiver;"

# è§£å†³æ–¹æ³•2: ä½¿ç”¨æ›´è¿‘çš„åŸºç¡€å¤‡ä»½
# å¦‚æœWALæ–‡ä»¶å·²è¢«æ¸…ç†ï¼Œéœ€è¦ä½¿ç”¨åŒ…å«æ‰€éœ€WALçš„åŸºç¡€å¤‡ä»½

# è§£å†³æ–¹æ³•3: ä»å½’æ¡£æ¢å¤WALæ–‡ä»¶
# å¦‚æœæœ‰å¼‚åœ°å½’æ¡£ï¼Œä»å½’æ¡£æ¢å¤WALæ–‡ä»¶

# é”™è¯¯4: restore_command failed
# åŸå› : restore_commandé…ç½®é”™è¯¯æˆ–å‘½ä»¤æ‰§è¡Œå¤±è´¥

# è§£å†³æ–¹æ³•1: æµ‹è¯•restore_command
# æ‰‹åŠ¨æ‰§è¡Œrestore_commandæµ‹è¯•
test ! -f /archive/000000010000000000000001 && \
    cp /var/lib/postgresql/data/pg_wal/000000010000000000000001 /archive/000000010000000000000001

# è§£å†³æ–¹æ³•2: æ£€æŸ¥æƒé™
ls -ld /archive
ls -l /archive/000000010000000000000001

# è§£å†³æ–¹æ³•3: ä½¿ç”¨ç»å¯¹è·¯å¾„
# åœ¨postgresql.auto.confä¸­ï¼š
restore_command = 'cp /archive/%f %p'
# è€Œä¸æ˜¯ç›¸å¯¹è·¯å¾„

# é”™è¯¯5: timeline mismatch
# åŸå› : æ—¶é—´çº¿ä¸åŒ¹é…

# è§£å†³æ–¹æ³•1: æ£€æŸ¥æ—¶é—´çº¿
psql -c "SELECT timeline_id FROM pg_control_checkpoint();"

# è§£å†³æ–¹æ³•2: ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´çº¿
# åœ¨postgresql.auto.confä¸­ï¼š
recovery_target_timeline = 'latest'
# æˆ–æŒ‡å®šå…·ä½“æ—¶é—´çº¿
recovery_target_timeline = '2'
```

**è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# diagnose_wal_restore.sh
# WALæ¢å¤æ•…éšœè¯Šæ–­è„šæœ¬

PGDATA="${PGDATA:-/var/lib/postgresql/data}"
ARCHIVE_DIR="${ARCHIVE_DIR:-/archive}"

echo "=== WALæ¢å¤è¯Šæ–­ ==="
echo "æ•°æ®ç›®å½•: $PGDATA"
echo "å½’æ¡£ç›®å½•: $ARCHIVE_DIR"
echo ""

# æ£€æŸ¥1: æ¢å¤çŠ¶æ€
echo "1. æ£€æŸ¥æ¢å¤çŠ¶æ€..."
if [ -f "$PGDATA/recovery.signal" ]; then
    echo "   âœ“ æ¢å¤æ¨¡å¼å·²å¯ç”¨"
    RECOVERY_LSN=$(psql -t -c "SELECT pg_last_wal_replay_lsn();" 2>/dev/null | xargs)
    echo "   - å½“å‰æ¢å¤LSN: $RECOVERY_LSN"
    if [ -n "$RECOVERY_LSN" ]; then
        WAL_FILE=$(psql -t -c "SELECT pg_walfile_name('$RECOVERY_LSN');" 2>/dev/null | xargs)
        echo "   - éœ€è¦çš„WALæ–‡ä»¶: $WAL_FILE"

        # æ£€æŸ¥WALæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$ARCHIVE_DIR/$WAL_FILE" ]; then
            echo "   âœ“ WALæ–‡ä»¶å­˜åœ¨äºå½’æ¡£ç›®å½•"
        else
            echo "   âœ— WALæ–‡ä»¶ä¸å­˜åœ¨äºå½’æ¡£ç›®å½•"
            echo "   æŸ¥æ‰¾ç›¸ä¼¼æ–‡ä»¶:"
            ls -lh "$ARCHIVE_DIR" | grep "${WAL_FILE:0:8}" | head -5
        fi
    fi
else
    echo "   âœ— æœªåœ¨æ¢å¤æ¨¡å¼"
fi

# æ£€æŸ¥2: restore_commandé…ç½®
echo ""
echo "2. æ£€æŸ¥restore_commandé…ç½®..."
RESTORE_CMD=$(grep restore_command "$PGDATA/postgresql.auto.conf" 2>/dev/null | cut -d"'" -f2)
if [ -n "$RESTORE_CMD" ]; then
    echo "   - restore_command: $RESTORE_CMD"
    # æµ‹è¯•å‘½ä»¤
    TEST_WAL="000000010000000000000001"
    TEST_CMD=$(echo "$RESTORE_CMD" | sed "s|%f|$TEST_WAL|g" | sed "s|%p|$PGDATA/pg_wal/$TEST_WAL|g")
    echo "   - æµ‹è¯•å‘½ä»¤: $TEST_CMD"
else
    echo "   âœ— restore_commandæœªé…ç½®"
fi

# æ£€æŸ¥3: WALå½’æ¡£ç›®å½•
echo ""
echo "3. æ£€æŸ¥WALå½’æ¡£ç›®å½•..."
if [ -d "$ARCHIVE_DIR" ]; then
    echo "   âœ“ å½’æ¡£ç›®å½•å­˜åœ¨"
    WAL_COUNT=$(find "$ARCHIVE_DIR" -name "*.wal" -o -name "*.gz" | wc -l)
    echo "   - WALæ–‡ä»¶æ•°: $WAL_COUNT"
    echo "   - æœ€æ–°WALæ–‡ä»¶:"
    ls -lht "$ARCHIVE_DIR" | head -5
else
    echo "   âœ— å½’æ¡£ç›®å½•ä¸å­˜åœ¨"
fi

# æ£€æŸ¥4: PostgreSQLæ—¥å¿—
echo ""
echo "4. æ£€æŸ¥PostgreSQLæ—¥å¿—ï¼ˆWALç›¸å…³é”™è¯¯ï¼‰..."
if [ -f /var/log/postgresql/postgresql.log ]; then
    tail -100 /var/log/postgresql/postgresql.log | grep -i "wal\|restore\|archive" | tail -10
fi
```

### é—®é¢˜3: æ¢å¤åæ•°æ®ä¸ä¸€è‡´

**éªŒè¯æ­¥éª¤**:

```sql
-- æ­¥éª¤1: æ£€æŸ¥æ¢å¤ç‚¹
SELECT
    pg_last_wal_replay_lsn() as replay_lsn,
    pg_last_wal_replay_timestamp() as replay_time,
    pg_is_in_recovery() as in_recovery;

-- æ­¥éª¤2: æ£€æŸ¥æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as db_size
FROM pg_database
WHERE datistemplate = false
ORDER BY pg_database_size(datname) DESC;

-- æ­¥éª¤3: æ£€æŸ¥è¡¨æ•°æ®
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC
LIMIT 20;

-- æ­¥éª¤4: æ£€æŸ¥å…³é”®è¡¨æ•°æ®å®Œæ•´æ€§
-- å¯¹æ¯”æºåº“å’Œç›®æ ‡åº“çš„è®°å½•æ•°
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM products;

-- æ­¥éª¤5: æ£€æŸ¥æ•°æ®æ ¡éªŒå’Œï¼ˆå¦‚æœå¯ç”¨ï¼‰
SELECT
    schemaname,
    tablename,
    attname,
    checksum
FROM pg_stat_user_tables t
JOIN pg_attribute a ON a.attrelid = t.relid
WHERE t.schemaname = 'public'
AND a.attnum > 0
AND NOT a.attisdropped;
```

**å¸¸è§ä¸ä¸€è‡´é—®é¢˜å’Œè§£å†³æ–¹æ³•**:

```sql
-- é—®é¢˜1: è¡¨è®°å½•æ•°ä¸åŒ¹é…
-- åŸå› : æ¢å¤æœªå®Œæˆæˆ–éƒ¨åˆ†æ•°æ®ä¸¢å¤±

-- è§£å†³æ–¹æ³•1: æ£€æŸ¥æ¢å¤æ˜¯å¦å®Œæˆ
SELECT pg_is_in_recovery();
-- å¦‚æœè¿”å›trueï¼Œè¯´æ˜æ¢å¤ä»åœ¨è¿›è¡Œ

-- è§£å†³æ–¹æ³•2: æ£€æŸ¥æ¢å¤ç›®æ ‡
SELECT
    recovery_target_time,
    recovery_target_lsn,
    recovery_target_name
FROM pg_settings
WHERE name LIKE 'recovery_target%';

-- è§£å†³æ–¹æ³•3: é‡æ–°æ‰§è¡Œæ¢å¤
-- åœæ­¢PostgreSQLï¼Œé‡æ–°é…ç½®æ¢å¤å‚æ•°ï¼Œé‡æ–°å¯åŠ¨

-- é—®é¢˜2: å¤–é”®çº¦æŸå¤±è´¥
-- åŸå› : æ•°æ®æ¢å¤é¡ºåºé—®é¢˜æˆ–æ•°æ®ä¸å®Œæ•´

-- è§£å†³æ–¹æ³•1: æ£€æŸ¥å¤–é”®çº¦æŸ
SELECT
    conname,
    conrelid::regclass,
    confrelid::regclass
FROM pg_constraint
WHERE contype = 'f'
AND NOT convalidated;

-- è§£å†³æ–¹æ³•2: éªŒè¯å¤–é”®
ALTER TABLE orders VALIDATE CONSTRAINT orders_user_id_fkey;

-- è§£å†³æ–¹æ³•3: é‡æ–°åŠ è½½æ•°æ®
-- å¦‚æœå¤–é”®éªŒè¯å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ¢å¤

-- é—®é¢˜3: ç´¢å¼•ä¸ä¸€è‡´
-- åŸå› : ç´¢å¼•æŸåæˆ–æœªæ­£ç¡®é‡å»º

-- è§£å†³æ–¹æ³•1: æ£€æŸ¥ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;

-- è§£å†³æ–¹æ³•2: é‡å»ºç´¢å¼•
REINDEX TABLE CONCURRENTLY orders;
REINDEX TABLE CONCURRENTLY users;

-- è§£å†³æ–¹æ³•3: æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;

-- é—®é¢˜4: åºåˆ—å€¼ä¸åŒ¹é…
-- åŸå› : åºåˆ—æœªæ­£ç¡®æ¢å¤

-- è§£å†³æ–¹æ³•1: æ£€æŸ¥åºåˆ—å€¼
SELECT
    schemaname,
    sequencename,
    last_value
FROM pg_sequences
WHERE schemaname = 'public';

-- è§£å†³æ–¹æ³•2: é‡ç½®åºåˆ—å€¼
SELECT setval('orders_id_seq', (SELECT MAX(id) FROM orders));

-- é—®é¢˜5: ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶
-- åŸå› : ç»Ÿè®¡ä¿¡æ¯æœªæ›´æ–°

-- è§£å†³æ–¹æ³•1: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- è§£å†³æ–¹æ³•2: æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY last_analyze DESC NULLS LAST;
```

**æ•°æ®ä¸€è‡´æ€§éªŒè¯è„šæœ¬**:

```bash
#!/bin/bash
# verify_restore_consistency.sh
# æ¢å¤åæ•°æ®ä¸€è‡´æ€§éªŒè¯è„šæœ¬

SOURCE_DB="${1:-source_db}"
TARGET_DB="${2:-target_db}"
SOURCE_HOST="${3:-localhost}"
TARGET_HOST="${4:-localhost}"

echo "=== æ•°æ®ä¸€è‡´æ€§éªŒè¯ ==="
echo "æºåº“: $SOURCE_HOST/$SOURCE_DB"
echo "ç›®æ ‡åº“: $TARGET_HOST/$TARGET_DB"
echo ""

# æ£€æŸ¥1: æ•°æ®åº“å¤§å°å¯¹æ¯”
echo "1. æ•°æ®åº“å¤§å°å¯¹æ¯”..."
SOURCE_SIZE=$(psql -h "$SOURCE_HOST" -d "$SOURCE_DB" -t -c "SELECT pg_database_size('$SOURCE_DB');" | xargs)
TARGET_SIZE=$(psql -h "$TARGET_HOST" -d "$TARGET_DB" -t -c "SELECT pg_database_size('$TARGET_DB');" | xargs)
echo "   æºåº“å¤§å°: $SOURCE_SIZE å­—èŠ‚"
echo "   ç›®æ ‡åº“å¤§å°: $TARGET_SIZE å­—èŠ‚"
SIZE_DIFF=$((SOURCE_SIZE - TARGET_SIZE))
if [ $SIZE_DIFF -lt 0 ]; then
    SIZE_DIFF=$((SIZE_DIFF * -1))
fi
SIZE_DIFF_PCT=$((SIZE_DIFF * 100 / SOURCE_SIZE))
echo "   å·®å¼‚: $SIZE_DIFF å­—èŠ‚ ($SIZE_DIFF_PCT%)"

# æ£€æŸ¥2: è¡¨è®°å½•æ•°å¯¹æ¯”
echo ""
echo "2. è¡¨è®°å½•æ•°å¯¹æ¯”..."
psql -h "$SOURCE_HOST" -d "$SOURCE_DB" -t -c "
SELECT tablename FROM pg_tables WHERE schemaname = 'public';
" | while read table; do
    if [ -n "$table" ]; then
        SOURCE_COUNT=$(psql -h "$SOURCE_HOST" -d "$SOURCE_DB" -t -c "SELECT COUNT(*) FROM $table;" | xargs)
        TARGET_COUNT=$(psql -h "$TARGET_HOST" -d "$TARGET_DB" -t -c "SELECT COUNT(*) FROM $table;" | xargs)
        if [ "$SOURCE_COUNT" != "$TARGET_COUNT" ]; then
            echo "   âœ— $table: æº=$SOURCE_COUNT, ç›®æ ‡=$TARGET_COUNT"
        else
            echo "   âœ“ $table: $SOURCE_COUNT"
        fi
    fi
done

# æ£€æŸ¥3: å…³é”®è¡¨æ•°æ®é‡‡æ ·å¯¹æ¯”
echo ""
echo "3. å…³é”®è¡¨æ•°æ®é‡‡æ ·å¯¹æ¯”..."
for table in orders users products; do
    echo "   æ£€æŸ¥è¡¨: $table"
    SOURCE_SAMPLE=$(psql -h "$SOURCE_HOST" -d "$SOURCE_DB" -t -c "SELECT COUNT(*) FROM $table WHERE id < 1000;" | xargs)
    TARGET_SAMPLE=$(psql -h "$TARGET_HOST" -d "$TARGET_DB" -t -c "SELECT COUNT(*) FROM $table WHERE id < 1000;" | xargs)
    if [ "$SOURCE_SAMPLE" = "$TARGET_SAMPLE" ]; then
        echo "     âœ“ é‡‡æ ·æ•°æ®ä¸€è‡´"
    else
        echo "     âœ— é‡‡æ ·æ•°æ®ä¸ä¸€è‡´: æº=$SOURCE_SAMPLE, ç›®æ ‡=$TARGET_SAMPLE"
    fi
done

echo ""
echo "éªŒè¯å®Œæˆ"
```
