# ç°ä»£PostgreSQLé«˜å¯ç”¨æ¶æ„è®¾è®¡

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 19-04-01

---

## ğŸ“‘ ç›®å½•

- [ç°ä»£PostgreSQLé«˜å¯ç”¨æ¶æ„è®¾è®¡](#ç°ä»£postgresqlé«˜å¯ç”¨æ¶æ„è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿](#11-ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿)
    - [1.2 é«˜å¯ç”¨ä»·å€¼è®ºè¯](#12-é«˜å¯ç”¨ä»·å€¼è®ºè¯)
  - [2. é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#2-é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
    - [2.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ](#21-å·¥å…·å¯¹æ¯”çŸ©é˜µ)
    - [2.2 æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#22-æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [3. æ¶æ„è®¾è®¡å†³ç­–æ ‘](#3-æ¶æ„è®¾è®¡å†³ç­–æ ‘)
  - [4. ç”Ÿäº§çº§æ¶æ„è®¾è®¡](#4-ç”Ÿäº§çº§æ¶æ„è®¾è®¡)
    - [4.1 Patronié«˜å¯ç”¨æ¶æ„](#41-patronié«˜å¯ç”¨æ¶æ„)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„](#51-æ¡ˆä¾‹é‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„)
  - [6. pg\_auto\_failoveræ¶æ„è®¾è®¡](#6-pg_auto_failoveræ¶æ„è®¾è®¡)
    - [6.1 pg\_auto\_failoveré…ç½®](#61-pg_auto_failoveré…ç½®)
    - [6.2 å¤šåŒºåŸŸé«˜å¯ç”¨æ¶æ„](#62-å¤šåŒºåŸŸé«˜å¯ç”¨æ¶æ„)
  - [7. è¯»å†™åˆ†ç¦»æ¶æ„](#7-è¯»å†™åˆ†ç¦»æ¶æ„)
    - [7.1 è¯»å†™åˆ†ç¦»é…ç½®](#71-è¯»å†™åˆ†ç¦»é…ç½®)
    - [7.2 æ™ºèƒ½è·¯ç”±](#72-æ™ºèƒ½è·¯ç”±)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 é«˜å¯ç”¨æ¶æ„åŸºç¡€å¸¸è§é—®é¢˜](#81-é«˜å¯ç”¨æ¶æ„åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•é€‰æ‹©é«˜å¯ç”¨æ–¹æ¡ˆï¼Ÿ](#q1-å¦‚ä½•é€‰æ‹©é«˜å¯ç”¨æ–¹æ¡ˆ)
      - [Q2: å¦‚ä½•å®ç°å¤šåŒºåŸŸé«˜å¯ç”¨ï¼Ÿ](#q2-å¦‚ä½•å®ç°å¤šåŒºåŸŸé«˜å¯ç”¨)
    - [8.2 é«˜å¯ç”¨æ€§èƒ½ä¼˜åŒ–å¸¸è§é—®é¢˜](#82-é«˜å¯ç”¨æ€§èƒ½ä¼˜åŒ–å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–é«˜å¯ç”¨æ¶æ„æ€§èƒ½ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–é«˜å¯ç”¨æ¶æ„æ€§èƒ½)

---

## 1. æ¦‚è¿°

### 1.1 ç°ä»£é«˜å¯ç”¨è¶‹åŠ¿

**2024-2025è¶‹åŠ¿**ï¼š

1. **è‡ªåŠ¨åŒ–æ•…éšœè½¬ç§»**ï¼šæ•…éšœæ¢å¤æ—¶é—´ < 30ç§’
2. **å¤šåŒºåŸŸéƒ¨ç½²**ï¼šè·¨åŒºåŸŸé«˜å¯ç”¨
3. **è¯»å†™åˆ†ç¦»ä¼˜åŒ–**ï¼šæ™ºèƒ½è·¯ç”±
4. **äº‘åŸç”Ÿé›†æˆ**ï¼šKubernetes Operator

### 1.2 é«˜å¯ç”¨ä»·å€¼è®ºè¯

| ä»·å€¼ç»´åº¦ | è¯´æ˜ | é‡åŒ–æ•°æ® |
|---------|------|---------|
| **å¯ç”¨æ€§** | è‡ªåŠ¨æ•…éšœæ¢å¤ | **99.9%** å¯ç”¨æ€§ |
| **æ¢å¤æ—¶é—´** | å¿«é€Ÿæ•…éšœæ¢å¤ | **< 30ç§’** |
| **æ•°æ®ä¸€è‡´æ€§** | å¼ºä¸€è‡´æ€§ä¿è¯ | **100%** |
| **è¿ç»´æˆæœ¬** | è‡ªåŠ¨åŒ–è¿ç»´ | **-70%** æˆæœ¬ |

---

## 2. é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

### 2.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ

| å·¥å…· | æ•…éšœæ¢å¤æ—¶é—´ | æ•°æ®ä¸€è‡´æ€§ | è¿ç»´å¤æ‚åº¦ | æˆæœ¬ | å¯æ‰©å±•æ€§ | ç»¼åˆè¯„åˆ† |
|------|------------|-----------|-----------|------|---------|---------|
| **Patroni** | < 30ç§’ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | **4.1** |
| **pg_auto_failover** | < 1åˆ†é’Ÿ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | **4.3** |
| **Citus** | < 1åˆ†é’Ÿ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | **3.8** |
| **repmgr** | < 2åˆ†é’Ÿ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­ | **3.5** |

### 2.2 æ¶æ„æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ–¹æ¡ˆ | å¯ç”¨æ€§ | æ€§èƒ½ | æˆæœ¬ | å¤æ‚åº¦ | é€‚ç”¨è§„æ¨¡ | ç»¼åˆè¯„åˆ† |
|---------|--------|------|------|--------|---------|---------|
| **ä¸»ä»å¤åˆ¶** | 99.9% | â­â­â­â­ | â­â­â­â­â­ | â­â­ | ä¸­å°å‹ | **3.8** |
| **Patronié›†ç¾¤** | 99.99% | â­â­â­â­ | â­â­â­â­ | â­â­â­ | ä¸­å¤§å‹ | **4.1** |
| **Citusåˆ†å¸ƒå¼** | 99.99% | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | è¶…å¤§å‹ | **4.0** |
| **å¤šåŒºåŸŸéƒ¨ç½²** | 99.999% | â­â­â­â­ | â­â­ | â­â­â­â­â­ | å¤§å‹ | **3.5** |

---

## 3. æ¶æ„è®¾è®¡å†³ç­–æ ‘

```text
éœ€è¦é«˜å¯ç”¨ï¼Ÿ
â”œâ”€ æ˜¯
â”‚  â”œâ”€ æ•°æ®è§„æ¨¡ï¼Ÿ
â”‚  â”‚  â”œâ”€ å°å‹ï¼ˆ< 100GBï¼‰ â†’ ä¸»ä»å¤åˆ¶
â”‚  â”‚  â”œâ”€ ä¸­å‹ï¼ˆ100GB-1TBï¼‰ â†’ Patronié›†ç¾¤
â”‚  â”‚  â””â”€ å¤§å‹ï¼ˆ> 1TBï¼‰ â†’ Citusåˆ†å¸ƒå¼
â”‚  â”œâ”€ æ•…éšœæ¢å¤æ—¶é—´è¦æ±‚ï¼Ÿ
â”‚  â”‚  â”œâ”€ < 30ç§’ â†’ Patroni
â”‚  â”‚  â”œâ”€ < 1åˆ†é’Ÿ â†’ pg_auto_failover
â”‚  â”‚  â””â”€ < 5åˆ†é’Ÿ â†’ repmgr
â”‚  â””â”€ åŒºåŸŸè¦æ±‚ï¼Ÿ
â”‚     â”œâ”€ å•åŒºåŸŸ â†’ æœ¬åœ°é«˜å¯ç”¨
â”‚     â””â”€ å¤šåŒºåŸŸ â†’ è·¨åŒºåŸŸé«˜å¯ç”¨
â””â”€ å¦ â†’ å•æœºéƒ¨ç½²
```

---

## 4. ç”Ÿäº§çº§æ¶æ„è®¾è®¡

### 4.1 Patronié«˜å¯ç”¨æ¶æ„

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[HAProxyè´Ÿè½½å‡è¡¡]
    B --> C1[PostgreSQLä¸»èŠ‚ç‚¹]
    B --> C2[PostgreSQLä»èŠ‚ç‚¹1]
    B --> C3[PostgreSQLä»èŠ‚ç‚¹2]
    C1 --> D[æµå¤åˆ¶]
    D --> C2
    D --> C3
    C1 --> E[Patroni]
    C2 --> E
    C3 --> E
    E --> F[etcd/ZooKeeper]

    style C1 fill:#90EE90
    style E fill:#87CEEB
    style F fill:#FFD700
```

**æ¶æ„ç‰¹ç‚¹**ï¼š

- è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¼ºä¸€è‡´æ€§ä¿è¯
- è¯»å†™åˆ†ç¦»

---

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šé‡‘èäº¤æ˜“ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„

**ä¸šåŠ¡åœºæ™¯**ï¼š

- é‡‘èäº¤æ˜“ç³»ç»Ÿ
- æ¯ç§’10ä¸‡+äº¤æ˜“
- 99.99%å¯ç”¨æ€§è¦æ±‚
- é›¶æ•°æ®ä¸¢å¤±

**å®æ–½æ–¹æ¡ˆ**ï¼š

```yaml
# Patronié…ç½®
scope: finance-cluster
namespace: /db/
name: postgres-primary

restapi:
  listen: 0.0.0.0:8008
  connect_address: 10.0.1.10:8008

etcd:
  hosts: 10.0.1.20:2379,10.0.1.21:2379,10.0.1.22:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        max_wal_senders: 10
        synchronous_commit: on
        synchronous_standby_names: 'ANY 2 (standby1, standby2)'

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 10.0.1.10:5432
  data_dir: /var/lib/postgresql/17/main
  authentication:
    replication:
      username: replicator
      password: replicator_password
```

**HAProxyé…ç½®**ï¼š

```haproxy
global
    log /dev/log local0
    maxconn 100

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend postgresql_frontend
    bind *:5432
    default_backend postgresql_backend

backend postgresql_backend
    option pgsql-check user postgres
    server postgresql1 10.0.1.10:5432 check
    server postgresql2 10.0.1.11:5432 check backup
    server postgresql3 10.0.1.12:5432 check backup
```

**å®æ–½æ•ˆæœ**ï¼š

| æŒ‡æ ‡ | å®æ–½å‰ | å®æ–½å | æå‡ |
|------|--------|--------|------|
| **å¯ç”¨æ€§** | 99.5% | 99.99% | **+0.49%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 15åˆ†é’Ÿ | 25ç§’ | **-97%** |
| **æ•°æ®ä¸¢å¤±é£é™©** | ä¸­ç­‰ | é›¶ä¸¢å¤± | **-100%** |
| **äº¤æ˜“å¤„ç†èƒ½åŠ›** | 5ä¸‡TPS | 10ä¸‡TPS | **2x** |

---

## 6. pg_auto_failoveræ¶æ„è®¾è®¡

### 6.1 pg_auto_failoveré…ç½®

**pg_auto_failoveré…ç½®ç¤ºä¾‹**ï¼š

```bash
# 1. åˆå§‹åŒ–MonitorèŠ‚ç‚¹
pg_autoctl create monitor \
  --pgdata /var/lib/postgresql/monitor \
  --pgport 5432 \
  --pgctl /usr/lib/postgresql/17/bin/pg_ctl \
  --run

# 2. åˆå§‹åŒ–ä¸»èŠ‚ç‚¹
pg_autoctl create postgres \
  --pgdata /var/lib/postgresql/primary \
  --pgport 5433 \
  --monitor 'postgres://autoctl_node@monitor:5432/pg_auto_failover' \
  --pgctl /usr/lib/postgresql/17/bin/pg_ctl \
  --run

# 3. æ·»åŠ ä»èŠ‚ç‚¹
pg_autoctl create postgres \
  --pgdata /var/lib/postgresql/standby \
  --pgport 5434 \
  --monitor 'postgres://autoctl_node@monitor:5432/pg_auto_failover' \
  --pgctl /usr/lib/postgresql/17/bin/pg_ctl \
  --run
```

### 6.2 å¤šåŒºåŸŸé«˜å¯ç”¨æ¶æ„

**è·¨åŒºåŸŸéƒ¨ç½²é…ç½®**ï¼š

```yaml
# ä¸»åŒºåŸŸï¼ˆUS-Eastï¼‰
scope: postgres-cluster-us
name: postgres-primary-us

etcd:
  hosts: us-etcd-1:2379,us-etcd-2:2379,us-etcd-3:2379

postgresql:
  connect_address: us-postgres-1:5432

# å¤‡åŒºåŸŸï¼ˆEU-Westï¼‰
scope: postgres-cluster-eu
name: postgres-standby-eu

etcd:
  hosts: eu-etcd-1:2379,eu-etcd-2:2379,eu-etcd-3:2379

postgresql:
  connect_address: eu-postgres-1:5432
```

---

## 7. è¯»å†™åˆ†ç¦»æ¶æ„

### 7.1 è¯»å†™åˆ†ç¦»é…ç½®

**ä½¿ç”¨HAProxyå®ç°è¯»å†™åˆ†ç¦»**ï¼š

```haproxy
global
    log /dev/log local0
    maxconn 100

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# å†™æœåŠ¡ï¼ˆä¸»èŠ‚ç‚¹ï¼‰
frontend postgresql_write
    bind *:5432
    default_backend postgresql_primary

backend postgresql_primary
    option pgsql-check user postgres
    server postgresql1 10.0.1.10:5432 check

# è¯»æœåŠ¡ï¼ˆä»èŠ‚ç‚¹ï¼‰
frontend postgresql_read
    bind *:5433
    default_backend postgresql_replicas
    balance roundrobin

backend postgresql_replicas
    option pgsql-check user postgres
    server postgresql2 10.0.1.11:5432 check
    server postgresql3 10.0.1.12:5432 check
```

### 7.2 æ™ºèƒ½è·¯ç”±

**åº”ç”¨å±‚è·¯ç”±é…ç½®**ï¼š

```typescript
// è¯»å†™åˆ†ç¦»è·¯ç”±
const writePool = new Pool({
  host: 'postgresql-write.example.com',
  port: 5432,
  database: 'mydb',
});

const readPool = new Pool({
  host: 'postgresql-read.example.com',
  port: 5433,
  database: 'mydb',
});

// æŸ¥è¯¢è·¯ç”±å‡½æ•°
async function query(sql: string, params: any[], isWrite: boolean = false) {
  const pool = isWrite ? writePool : readPool;
  return pool.query(sql, params);
}
```

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 é«˜å¯ç”¨æ¶æ„åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•é€‰æ‹©é«˜å¯ç”¨æ–¹æ¡ˆï¼Ÿ

**é€‰æ‹©å†³ç­–çŸ©é˜µ**ï¼š

| åœºæ™¯ | Patroni | pg_auto_failover | repmgr | æ¨è |
|------|---------|------------------|--------|------|
| **æ•…éšœæ¢å¤æ—¶é—´ < 30ç§’** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | Patroni |
| **é…ç½®ç®€å•** | â­â­â­ | â­â­â­â­â­ | â­â­â­ | pg_auto_failover |
| **åŠŸèƒ½å®Œæ•´** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | Patroni |
| **æˆæœ¬æ•æ„Ÿ** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | pg_auto_failover |

#### Q2: å¦‚ä½•å®ç°å¤šåŒºåŸŸé«˜å¯ç”¨ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **è·¨åŒºåŸŸæµå¤åˆ¶**ï¼š

    ```sql
    -- ä¸»åŒºåŸŸé…ç½®
    ALTER SYSTEM SET wal_level = replica;
    ALTER SYSTEM SET max_wal_senders = 10;

    -- å¤‡åŒºåŸŸé…ç½®
    -- ä½¿ç”¨pg_basebackupä»ä¸»åŒºåŸŸå¤‡ä»½
    ```

2. **ä½¿ç”¨é€»è¾‘å¤åˆ¶**ï¼ˆæ¨èï¼‰ï¼š

    ```sql
    -- ä¸»åŒºåŸŸ
    CREATE PUBLICATION global_publication FOR ALL TABLES;

    -- å¤‡åŒºåŸŸ
    CREATE SUBSCRIPTION eu_subscription
    CONNECTION 'host=us-postgres.example.com port=5432 user=replicator password=xxx dbname=mydb'
    PUBLICATION global_publication;
    ```

### 8.2 é«˜å¯ç”¨æ€§èƒ½ä¼˜åŒ–å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–é«˜å¯ç”¨æ¶æ„æ€§èƒ½ï¼Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

1. **åŒæ­¥å¤åˆ¶ä¼˜åŒ–**ï¼š

    ```yaml
    synchronous_standby_names: "ANY 2 (standby1, standby2)"
    # å…è®¸ä»»æ„2ä¸ªä»èŠ‚ç‚¹åŒæ­¥ï¼Œæé«˜æ€§èƒ½
    ```

2. **è¯»å†™åˆ†ç¦»**ï¼š

    ```yaml
    # ä½¿ç”¨HAProxyå®ç°è¯»å†™åˆ†ç¦»
    # å†™è¯·æ±‚è·¯ç”±åˆ°ä¸»èŠ‚ç‚¹
    # è¯»è¯·æ±‚è·¯ç”±åˆ°ä»èŠ‚ç‚¹
    ```

3. **è¿æ¥æ± ä¼˜åŒ–**ï¼š

```yaml
# ä½¿ç”¨PgBouncerè¿æ¥æ± 
# å‡å°‘è¿æ¥å¼€é”€
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 19-04-01
