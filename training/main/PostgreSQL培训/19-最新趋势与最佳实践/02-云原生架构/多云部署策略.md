# PostgreSQLå¤šäº‘éƒ¨ç½²ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 19-02-04

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå¤šäº‘éƒ¨ç½²ç­–ç•¥](#postgresqlå¤šäº‘éƒ¨ç½²ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 å¤šäº‘éƒ¨ç½²ä»·å€¼](#11-å¤šäº‘éƒ¨ç½²ä»·å€¼)
  - [2. å¤šäº‘éƒ¨ç½²æ¶æ„](#2-å¤šäº‘éƒ¨ç½²æ¶æ„)
    - [2.1 æ¶æ„æ€ç»´å¯¼å›¾](#21-æ¶æ„æ€ç»´å¯¼å›¾)
  - [3. äº‘å¹³å°å¯¹æ¯”çŸ©é˜µ](#3-äº‘å¹³å°å¯¹æ¯”çŸ©é˜µ)
  - [4. éƒ¨ç½²ç­–ç•¥å†³ç­–æ ‘](#4-éƒ¨ç½²ç­–ç•¥å†³ç­–æ ‘)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šè·¨å›½ä¼ä¸šå¤šäº‘éƒ¨ç½²](#51-æ¡ˆä¾‹è·¨å›½ä¼ä¸šå¤šäº‘éƒ¨ç½²)
  - [6. è·¨äº‘æ•°æ®åŒæ­¥æŠ€æœ¯è¯¦è§£](#6-è·¨äº‘æ•°æ®åŒæ­¥æŠ€æœ¯è¯¦è§£)
    - [6.1 é€»è¾‘å¤åˆ¶é…ç½®](#61-é€»è¾‘å¤åˆ¶é…ç½®)
    - [6.2 æµå¤åˆ¶é…ç½®ï¼ˆè·¨äº‘ï¼‰](#62-æµå¤åˆ¶é…ç½®è·¨äº‘)
    - [6.3 æ•°æ®åŒæ­¥ç›‘æ§](#63-æ•°æ®åŒæ­¥ç›‘æ§)
  - [7. æ•…éšœè½¬ç§»ç­–ç•¥](#7-æ•…éšœè½¬ç§»ç­–ç•¥)
    - [7.1 è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®](#71-è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®)
    - [7.2 DNSæ•…éšœè½¬ç§»](#72-dnsæ•…éšœè½¬ç§»)
  - [8. æˆæœ¬ä¼˜åŒ–ç­–ç•¥](#8-æˆæœ¬ä¼˜åŒ–ç­–ç•¥)
    - [8.1 äº‘å¹³å°æˆæœ¬å¯¹æ¯”](#81-äº‘å¹³å°æˆæœ¬å¯¹æ¯”)
    - [8.2 æˆæœ¬ä¼˜åŒ–æŠ€å·§](#82-æˆæœ¬ä¼˜åŒ–æŠ€å·§)
  - [9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#9-å¸¸è§é—®é¢˜faq)
    - [9.1 å¤šäº‘éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜](#91-å¤šäº‘éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•å®ç°è·¨äº‘æ•°æ®åŒæ­¥ï¼Ÿ](#q1-å¦‚ä½•å®ç°è·¨äº‘æ•°æ®åŒæ­¥)
      - [Q2: å¦‚ä½•ä¿è¯è·¨äº‘æ•°æ®ä¸€è‡´æ€§ï¼Ÿ](#q2-å¦‚ä½•ä¿è¯è·¨äº‘æ•°æ®ä¸€è‡´æ€§)
    - [9.2 æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜](#92-æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å®ç°è·¨äº‘è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Ÿ](#q3-å¦‚ä½•å®ç°è·¨äº‘è‡ªåŠ¨æ•…éšœè½¬ç§»)

---

## 1. æ¦‚è¿°

### 1.1 å¤šäº‘éƒ¨ç½²ä»·å€¼

**å¤šäº‘éƒ¨ç½²çš„æ ¸å¿ƒä»·å€¼**ï¼š

| ä»·å€¼ç»´åº¦ | è¯´æ˜ | é‡åŒ–æ•°æ® |
|---------|------|---------|
| **é«˜å¯ç”¨æ€§** | è·¨äº‘å®¹ç¾ | **99.99%** å¯ç”¨æ€§ |
| **æˆæœ¬ä¼˜åŒ–** | é€‰æ‹©æœ€ä¼˜äº‘å¹³å° | **-30%** æˆæœ¬ |
| **é£é™©åˆ†æ•£** | é¿å…å•ç‚¹æ•…éšœ | **-80%** é£é™© |
| **çµæ´»æ€§** | è·¨äº‘è¿ç§» | **+100%** çµæ´»æ€§ |

---

## 2. å¤šäº‘éƒ¨ç½²æ¶æ„

### 2.1 æ¶æ„æ€ç»´å¯¼å›¾

```mermaid
graph TD
    A[å¤šäº‘PostgreSQL] --> B[ä¸»äº‘å¹³å°]
    A --> C[å¤‡äº‘å¹³å°]
    A --> D[æ•°æ®åŒæ­¥]

    B --> B1[AWS RDS]
    B --> B2[Azure Database]
    B --> B3[Google Cloud SQL]

    C --> C1[è·¨äº‘å¤åˆ¶]
    C --> C2[é€»è¾‘å¤åˆ¶]
    C --> C3[æµå¤åˆ¶]

    D --> D1[å®æ—¶åŒæ­¥]
    D --> D2[å»¶è¿ŸåŒæ­¥]
    D --> D3[å¼‚æ­¥åŒæ­¥]

    style B fill:#90EE90
    style C fill:#87CEEB
    style D fill:#FFD700
```

---

## 3. äº‘å¹³å°å¯¹æ¯”çŸ©é˜µ

| äº‘å¹³å° | æ€§èƒ½ | æˆæœ¬ | æ˜“ç”¨æ€§ | å¯æ‰©å±•æ€§ | ç»¼åˆè¯„åˆ† |
|--------|------|------|--------|---------|---------|
| **AWS RDS** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | **4.2** |
| **Azure Database** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | **3.8** |
| **Google Cloud SQL** | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | **3.8** |
| **è‡ªå»ºPostgreSQL** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­ | **3.5** |

---

## 4. éƒ¨ç½²ç­–ç•¥å†³ç­–æ ‘

```text
å¤šäº‘éƒ¨ç½²éœ€æ±‚ï¼Ÿ
â”œâ”€ æ˜¯
â”‚  â”œâ”€ ä¸»è¦ç›®æ ‡ï¼Ÿ
â”‚  â”‚  â”œâ”€ é«˜å¯ç”¨ â†’ ä¸»å¤‡è·¨äº‘éƒ¨ç½²
â”‚  â”‚  â”œâ”€ æˆæœ¬ä¼˜åŒ– â†’ é€‰æ‹©æœ€ä¼˜äº‘å¹³å°
â”‚  â”‚  â””â”€ é£é™©åˆ†æ•£ â†’ å¤šåŒºåŸŸéƒ¨ç½²
â”‚  â””â”€ æ•°æ®åŒæ­¥æ–¹å¼ï¼Ÿ
â”‚     â”œâ”€ å®æ—¶åŒæ­¥ â†’ æµå¤åˆ¶
â”‚     â”œâ”€ è¿‘å®æ—¶åŒæ­¥ â†’ é€»è¾‘å¤åˆ¶
â”‚     â””â”€ å¼‚æ­¥åŒæ­¥ â†’ å®šæœŸåŒæ­¥
â””â”€ å¦ â†’ å•äº‘éƒ¨ç½²
```

---

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šè·¨å›½ä¼ä¸šå¤šäº‘éƒ¨ç½²

**ä¸šåŠ¡åœºæ™¯**ï¼š

- è·¨å›½ä¼ä¸šå…¨çƒä¸šåŠ¡
- éœ€è¦è·¨åŒºåŸŸé«˜å¯ç”¨
- åˆè§„è¦æ±‚ï¼ˆæ•°æ®æœ¬åœ°åŒ–ï¼‰
- æˆæœ¬ä¼˜åŒ–éœ€æ±‚

**å®æ–½æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä¸»äº‘ï¼ˆAWS RDSï¼‰é…ç½®
-- ä¸»æ•°æ®åº“åœ¨AWS US-East
CREATE PUBLICATION global_publication FOR ALL TABLES;

-- 2. å¤‡äº‘ï¼ˆAzure Databaseï¼‰é…ç½®
-- ä»æ•°æ®åº“åœ¨Azure EU-West
CREATE SUBSCRIPTION azure_subscription
CONNECTION 'host=azure-db.example.com port=5432 user=replicator password=xxx dbname=mydb'
PUBLICATION global_publication
WITH (copy_data = true, create_slot = true);

-- 3. é€»è¾‘å¤åˆ¶ç›‘æ§
SELECT
    subname,
    pid,
    relid::regclass,
    last_error_message,
    last_error_timestamp
FROM pg_stat_subscription;

-- 4. è·¨äº‘æ•…éšœè½¬ç§»
-- æ‰‹åŠ¨åˆ‡æ¢ï¼ˆæˆ–ä½¿ç”¨Patroniè‡ªåŠ¨åˆ‡æ¢ï¼‰
SELECT pg_promote();
```

**æ¶æ„è®¾è®¡**ï¼š

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[å…¨çƒè´Ÿè½½å‡è¡¡å™¨]
    B --> C1[AWS US-Eastä¸»åº“]
    B --> C2[Azure EU-Westä»åº“]
    B --> C3[GCP Asia-Pacificä»åº“]
    C1 --> D[é€»è¾‘å¤åˆ¶]
    D --> C2
    D --> C3

    style C1 fill:#90EE90
    style C2 fill:#87CEEB
    style C3 fill:#FFD700
```

**å®æ–½æ•ˆæœ**ï¼š

| æŒ‡æ ‡ | å®æ–½å‰ | å®æ–½å | æå‡ |
|------|--------|--------|------|
| **å¯ç”¨æ€§** | 99.5% | 99.99% | **+0.49%** |
| **æˆæœ¬** | 100% | 70% | **-30%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | 30åˆ†é’Ÿ | 2åˆ†é’Ÿ | **-93%** |
| **åˆè§„æ€§** | 60% | 100% | **+67%** |

---

## 6. è·¨äº‘æ•°æ®åŒæ­¥æŠ€æœ¯è¯¦è§£

### 6.1 é€»è¾‘å¤åˆ¶é…ç½®

**é€»è¾‘å¤åˆ¶åŸç†**ï¼š

é€»è¾‘å¤åˆ¶åŸºäºWALï¼ˆWrite-Ahead Logï¼‰çš„é€»è¾‘è§£ç ï¼Œå…è®¸åœ¨ä¸åŒPostgreSQLç‰ˆæœ¬ä¹‹é—´å¤åˆ¶æ•°æ®ã€‚

**ä¸»åº“é…ç½®ï¼ˆAWS RDSï¼‰**ï¼š

```sql
-- 1. å¯ç”¨é€»è¾‘å¤åˆ¶
ALTER SYSTEM SET wal_level = logical;
SELECT pg_reload_conf();

-- 2. åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION global_publication FOR ALL TABLES;

-- 3. æˆ–è€…ä¸ºç‰¹å®šè¡¨åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION user_publication FOR TABLE users, orders;

-- 4. æŸ¥çœ‹å‘å¸ƒçŠ¶æ€
SELECT * FROM pg_publication;
SELECT * FROM pg_publication_tables;
```

**ä»åº“é…ç½®ï¼ˆAzure Databaseï¼‰**ï¼š

```sql
-- 1. åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION azure_subscription
CONNECTION 'host=aws-rds.example.com port=5432 user=replicator password=xxx dbname=mydb sslmode=require'
PUBLICATION global_publication
WITH (
    copy_data = true,
    create_slot = true,
    enabled = true,
    slot_name = 'azure_subscription_slot'
);

-- 2. æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT
    subname,
    pid,
    relid::regclass,
    received_lsn,
    last_msg_send_time,
    last_msg_receipt_time,
    latest_end_lsn,
    latest_end_time
FROM pg_stat_subscription;

-- 3. æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    subname,
    pg_wal_lsn_diff(pg_current_wal_lsn(), received_lsn) AS replication_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), latest_end_lsn) AS apply_lag_bytes
FROM pg_stat_subscription;
```

### 6.2 æµå¤åˆ¶é…ç½®ï¼ˆè·¨äº‘ï¼‰

**æµå¤åˆ¶åŸç†**ï¼š

æµå¤åˆ¶åŸºäºWALçš„ç‰©ç†å¤åˆ¶ï¼Œé€‚ç”¨äºç›¸åŒPostgreSQLç‰ˆæœ¬ä¹‹é—´çš„å¤åˆ¶ã€‚

**ä¸»åº“é…ç½®**ï¼š

```sql
-- 1. é…ç½®æµå¤åˆ¶
ALTER SYSTEM SET wal_level = replica;
ALTER SYSTEM SET max_wal_senders = 10;
ALTER SYSTEM SET wal_keep_size = '1GB';
SELECT pg_reload_conf();

-- 2. åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER replicator WITH REPLICATION PASSWORD 'replicator_password';

-- 3. é…ç½®pg_hba.conf
-- host replication replicator 0.0.0.0/0 md5
```

**ä»åº“é…ç½®**ï¼š

```bash
# 1. åŸºç¡€å¤‡ä»½
pg_basebackup -h aws-rds.example.com -D /var/lib/postgresql/data \
  -U replicator -P -v -R -W

# 2. é…ç½®recovery.confï¼ˆPostgreSQL 12+ï¼‰
# primary_conninfo = 'host=aws-rds.example.com port=5432 user=replicator password=xxx'
# standby_mode = 'on'
```

### 6.3 æ•°æ®åŒæ­¥ç›‘æ§

**ç›‘æ§è„šæœ¬**ï¼š

```sql
-- 1. ç›‘æ§é€»è¾‘å¤åˆ¶å»¶è¿Ÿ
CREATE OR REPLACE FUNCTION monitor_logical_replication()
RETURNS TABLE (
    subscription_name TEXT,
    lag_bytes BIGINT,
    lag_seconds INTERVAL,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        s.subname::TEXT,
        pg_wal_lsn_diff(pg_current_wal_lsn(), s.received_lsn) AS lag_bytes,
        NOW() - s.last_msg_receipt_time AS lag_seconds,
        CASE
            WHEN s.pid IS NULL THEN 'stopped'
            WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), s.received_lsn) > 104857600 THEN 'delayed'
            ELSE 'healthy'
        END AS status
    FROM pg_stat_subscription s;
END;
$$ LANGUAGE plpgsql;

-- 2. å®šæœŸæ£€æŸ¥
SELECT * FROM monitor_logical_replication();
```

---

## 7. æ•…éšœè½¬ç§»ç­–ç•¥

### 7.1 è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®

**ä½¿ç”¨Patroniå®ç°è·¨äº‘æ•…éšœè½¬ç§»**ï¼š

```yaml
# patroni.yml (ä¸»äº‘ï¼šAWS)
scope: postgres-cluster
namespace: /db/
name: postgres-primary

etcd:
  hosts: aws-etcd-1:2379,aws-etcd-2:2379,aws-etcd-3:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        max_wal_senders: 10
        synchronous_commit: "on"
        synchronous_standby_names: "ANY 2 (azure-standby1, azure-standby2)"

postgresql:
  listen: 0.0.0.0:5432
  connect_address: aws-rds.example.com:5432
```

### 7.2 DNSæ•…éšœè½¬ç§»

**ä½¿ç”¨Route 53å®ç°DNSæ•…éšœè½¬ç§»**ï¼š

```json
{
  "Name": "postgres.example.com",
  "Type": "CNAME",
  "TTL": 60,
  "ResourceRecords": [
    {
      "Value": "aws-rds-primary.example.com"
    }
  ],
  "HealthCheckId": "health-check-id",
  "Failover": "PRIMARY"
}
```

---

## 8. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### 8.1 äº‘å¹³å°æˆæœ¬å¯¹æ¯”

**æˆæœ¬åˆ†æçŸ©é˜µ**ï¼š

| äº‘å¹³å° | è®¡ç®—æˆæœ¬/æœˆ | å­˜å‚¨æˆæœ¬/æœˆ | ç½‘ç»œæˆæœ¬/æœˆ | æ€»æˆæœ¬/æœˆ | æ€§ä»·æ¯” |
|--------|-----------|-----------|-----------|---------|--------|
| **AWS RDS** | $500 | $200 | $100 | $800 | â­â­â­ |
| **Azure Database** | $450 | $180 | $90 | $720 | â­â­â­â­ |
| **Google Cloud SQL** | $480 | $190 | $80 | $750 | â­â­â­ |
| **è‡ªå»ºPostgreSQL** | $300 | $150 | $50 | $500 | â­â­â­â­â­ |

### 8.2 æˆæœ¬ä¼˜åŒ–æŠ€å·§

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **ä½¿ç”¨é¢„ç•™å®ä¾‹**ï¼š
   - AWS Reserved Instancesï¼šèŠ‚çœ30-50%
   - Azure Reserved Capacityï¼šèŠ‚çœ30-50%
   - Google Committed Use Discountsï¼šèŠ‚çœ30-50%

2. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨å‹ç¼©å­˜å‚¨ï¼šèŠ‚çœ50-70%
   - å†·çƒ­æ•°æ®åˆ†ç¦»ï¼šèŠ‚çœ30-50%

3. **ç½‘ç»œä¼˜åŒ–**ï¼š
   - ä½¿ç”¨äº‘å†…ç½‘ç»œï¼šèŠ‚çœ50-80%
   - ä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼šå‡å°‘è·¨åŒºåŸŸä¼ è¾“

---

## 9. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 9.1 å¤šäº‘éƒ¨ç½²åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•å®ç°è·¨äº‘æ•°æ®åŒæ­¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é€»è¾‘å¤åˆ¶**ï¼ˆæ¨èï¼‰ï¼š

    ```sql
    -- ä¸»åº“
    CREATE PUBLICATION global_publication FOR ALL TABLES;

    -- ä»åº“
    CREATE SUBSCRIPTION azure_subscription
    CONNECTION 'host=aws-rds.example.com port=5432 user=replicator password=xxx dbname=mydb'
    PUBLICATION global_publication;
    ```

2. **æµå¤åˆ¶**ï¼ˆåŒç‰ˆæœ¬ï¼‰ï¼š

    ```bash
    pg_basebackup -h aws-rds.example.com -D /var/lib/postgresql/data \
      -U replicator -P -v -R -W
    ```

#### Q2: å¦‚ä½•ä¿è¯è·¨äº‘æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **åŒæ­¥å¤åˆ¶**ï¼š

    ```sql
    -- ä¸»åº“é…ç½®
    ALTER SYSTEM SET synchronous_commit = "on";
    ALTER SYSTEM SET synchronous_standby_names = "ANY 2 (azure-standby1, azure-standby2)";
    ```

2. **ç›‘æ§å¤åˆ¶å»¶è¿Ÿ**ï¼š

    ```sql
    SELECT
        subname,
        pg_wal_lsn_diff(pg_current_wal_lsn(), received_lsn) AS lag_bytes
    FROM pg_stat_subscription;
    ```

### 9.2 æ•…éšœè½¬ç§»å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å®ç°è·¨äº‘è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨Patroni + DNSæ•…éšœè½¬ç§»ï¼š

1. **Patronié…ç½®**ï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰
2. **DNSé…ç½®**ï¼ˆRoute 53å¥åº·æ£€æŸ¥ï¼‰
3. **åº”ç”¨å±‚é‡è¯•**ï¼ˆè¿æ¥å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 19-02-04
