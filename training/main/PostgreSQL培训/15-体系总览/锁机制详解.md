# PostgreSQL é”æœºåˆ¶è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+
> **æ–‡æ¡£ç¼–å·**: 03-03-32

## ğŸ“‘ ç›®å½•

- [PostgreSQL é”æœºåˆ¶è¯¦è§£](#postgresql-é”æœºåˆ¶è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
    - [1.3 å­¦ä¹ ç›®æ ‡](#13-å­¦ä¹ ç›®æ ‡)
    - [1.4 é”æœºåˆ¶ä½“ç³»æ€ç»´å¯¼å›¾](#14-é”æœºåˆ¶ä½“ç³»æ€ç»´å¯¼å›¾)
  - [2. é”ç±»å‹](#2-é”ç±»å‹)
    - [2.0 é”æœºåˆ¶å·¥ä½œåŸç†æ¦‚è¿°](#20-é”æœºåˆ¶å·¥ä½œåŸç†æ¦‚è¿°)
    - [2.1 è¡¨çº§é”](#21-è¡¨çº§é”)
    - [2.2 è¡Œçº§é”](#22-è¡Œçº§é”)
    - [2.3 é”å…¼å®¹æ€§](#23-é”å…¼å®¹æ€§)
  - [3. é”ç›‘æ§](#3-é”ç›‘æ§)
    - [3.1 æŸ¥çœ‹é”ä¿¡æ¯](#31-æŸ¥çœ‹é”ä¿¡æ¯)
    - [3.2 æ­»é”æ£€æµ‹](#32-æ­»é”æ£€æµ‹)
  - [4. å®é™…åº”ç”¨æ¡ˆä¾‹](#4-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [4.1 æ¡ˆä¾‹: é”ç­‰å¾…é—®é¢˜è§£å†³ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#41-æ¡ˆä¾‹-é”ç­‰å¾…é—®é¢˜è§£å†³çœŸå®æ¡ˆä¾‹)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 é”ä½¿ç”¨](#51-é”ä½¿ç”¨)
    - [5.2 æ€§èƒ½ä¼˜åŒ–](#52-æ€§èƒ½ä¼˜åŒ–)
  - [6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#6-å¸¸è§é—®é¢˜faq)
    - [6.1 é”æœºåˆ¶åŸºç¡€å¸¸è§é—®é¢˜](#61-é”æœºåˆ¶åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•æŸ¥çœ‹å’Œè¯Šæ–­é”ç­‰å¾…é—®é¢˜ï¼Ÿ](#q1-å¦‚ä½•æŸ¥çœ‹å’Œè¯Šæ–­é”ç­‰å¾…é—®é¢˜)
      - [Q2: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ](#q2-å¦‚ä½•é¿å…æ­»é”)
    - [6.2 é”æ€§èƒ½å¸¸è§é—®é¢˜](#62-é”æ€§èƒ½å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•ä¼˜åŒ–é”æ€§èƒ½ï¼Ÿ](#q3-å¦‚ä½•ä¼˜åŒ–é”æ€§èƒ½)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [6.2 æŠ€æœ¯è®ºæ–‡](#62-æŠ€æœ¯è®ºæ–‡)
    - [6.3 æŠ€æœ¯åšå®¢](#63-æŠ€æœ¯åšå®¢)
    - [6.4 ç¤¾åŒºèµ„æº](#64-ç¤¾åŒºèµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é”æœºåˆ¶çš„ä»·å€¼**:

PostgreSQL é”æœºåˆ¶ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§å’Œå¹¶å‘æ§åˆ¶ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ•°æ®ä¸€è‡´æ€§
2. **å¹¶å‘æ§åˆ¶**: æ§åˆ¶å¹¶å‘è®¿é—®
3. **æ­»é”æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æ­»é”
4. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–é”çš„ä½¿ç”¨æå‡æ€§èƒ½

**åº”ç”¨åœºæ™¯**:

- **å¹¶å‘è®¿é—®**: å¤„ç†å¹¶å‘è®¿é—®
- **äº‹åŠ¡ç®¡ç†**: äº‹åŠ¡ä¸­çš„é”ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–é”çš„ä½¿ç”¨
- **æ­»é”å¤„ç†**: å¤„ç†æ­»é”é—®é¢˜

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®ä¸€è‡´æ€§** | ä¿è¯æ•°æ®ä¸€è‡´æ€§ | **100%** |
| **å¹¶å‘æ€§èƒ½** | ä¼˜åŒ–é”æå‡æ€§èƒ½ | **+30-50%** |
| **æ­»é”æ£€æµ‹** | è‡ªåŠ¨æ£€æµ‹æ­»é” | **100%** |
| **é”ç­‰å¾…** | å‡å°‘é”ç­‰å¾…æ—¶é—´ | **-60%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œ100% å¯é 
- **å¹¶å‘æ€§èƒ½**: ä¼˜åŒ–é”çš„ä½¿ç”¨æå‡å¹¶å‘æ€§èƒ½ 30-50%
- **æ­»é”æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œ100% æ£€æµ‹ç‡
- **é”ç­‰å¾…**: å‡å°‘é”ç­‰å¾…æ—¶é—´ 60%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡é”çš„ç±»å‹å’Œç‰¹æ€§
- ç†è§£é”çš„å…¼å®¹æ€§
- å­¦ä¼šé”ç›‘æ§å’Œè¯Šæ–­
- æŒæ¡æ­»é”å¤„ç†

### 1.4 é”æœºåˆ¶ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é”æœºåˆ¶ä½“ç³»))
    é”ç±»å‹
      è¡¨çº§é”
        ACCESS SHARE
        ROW SHARE
        ROW EXCLUSIVE
        SHARE
        EXCLUSIVE
        ACCESS EXCLUSIVE
      è¡Œçº§é”
        FOR UPDATE
        FOR SHARE
        FOR NO KEY UPDATE
        FOR KEY SHARE
      å’¨è¯¢é”
        åº”ç”¨é”
        è‡ªå®šä¹‰é”
        åè°ƒé”
    é”å…¼å®¹æ€§
      å…¼å®¹çŸ©é˜µ
        é”å…¼å®¹æ€§
        é”å†²çª
        é”ç­‰å¾…
      é”å‡çº§
        é”å‡çº§
        é”é™çº§
        é”è½¬æ¢
    é”ç®¡ç†
      é”è·å–
        è‡ªåŠ¨è·å–
        æ˜¾å¼è·å–
        é”è¶…æ—¶
      é”é‡Šæ”¾
        è‡ªåŠ¨é‡Šæ”¾
        æ˜¾å¼é‡Šæ”¾
        äº‹åŠ¡ç»“æŸ
      é”ç›‘æ§
        é”çŠ¶æ€
        é”ç­‰å¾…
        æ­»é”æ£€æµ‹
    æ­»é”å¤„ç†
      æ­»é”æ£€æµ‹
        è‡ªåŠ¨æ£€æµ‹
        æ­»é”å›¾
        æ­»é”ä¿¡æ¯
      æ­»é”é¿å…
        é”é¡ºåº
        é”è¶…æ—¶
        æ­»é”é¢„é˜²
      æ­»é”è§£å†³
        è‡ªåŠ¨å›æ»š
        æ‰‹åŠ¨å¤„ç†
        æ­»é”æ¢å¤
```

## 2. é”ç±»å‹

### 2.0 é”æœºåˆ¶å·¥ä½œåŸç†æ¦‚è¿°

**é”çš„æœ¬è´¨**ï¼š

é”æ˜¯ PostgreSQL å¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œç”¨äºåè°ƒå¤šä¸ªäº‹åŠ¡å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚PostgreSQL ä½¿ç”¨å¤šç²’åº¦é”æœºåˆ¶ï¼ŒåŒ…æ‹¬è¡¨çº§é”ã€è¡Œçº§é”å’Œé¡µçº§é”ã€‚

**é”è·å–æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[äº‹åŠ¡è¯·æ±‚é”] --> B{é”æ˜¯å¦å¯ç”¨?}
    B -->|æ˜¯| C[è·å–é”]
    B -->|å¦| D{é”è¶…æ—¶è®¾ç½®?}
    D -->|æœ‰è¶…æ—¶| E{ç­‰å¾…è¶…æ—¶?}
    D -->|æ— è¶…æ—¶| F[ç­‰å¾…é”é‡Šæ”¾]
    E -->|æœªè¶…æ—¶| F
    E -->|å·²è¶…æ—¶| G[è¿”å›è¶…æ—¶é”™è¯¯]
    F --> H{é”é‡Šæ”¾?}
    H -->|æ˜¯| C
    H -->|å¦| F
    C --> I[æ‰§è¡Œæ“ä½œ]
    I --> J[é‡Šæ”¾é”]
    J --> K[äº‹åŠ¡ç»“æŸ]

    style C fill:#90EE90
    style G fill:#FFB6C1
    style K fill:#87CEEB
```

**é”çš„å±‚æ¬¡ç»“æ„**ï¼š

PostgreSQL ä½¿ç”¨å¤šç²’åº¦é”æœºåˆ¶ï¼š

1. **æ•°æ®åº“çº§é”**ï¼šé”å®šæ•´ä¸ªæ•°æ®åº“
2. **è¡¨çº§é”**ï¼šé”å®šæ•´ä¸ªè¡¨
3. **é¡µçº§é”**ï¼šé”å®šæ•°æ®é¡µï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
4. **è¡Œçº§é”**ï¼šé”å®šå•è¡Œæ•°æ®

**é”çš„è‡ªåŠ¨è·å–å’Œé‡Šæ”¾**ï¼š

- **è‡ªåŠ¨è·å–**ï¼šæ‰§è¡Œ SQL è¯­å¥æ—¶è‡ªåŠ¨è·å–æ‰€éœ€çš„é”
- **è‡ªåŠ¨é‡Šæ”¾**ï¼šäº‹åŠ¡æäº¤æˆ–å›æ»šæ—¶è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰é”
- **æ˜¾å¼è·å–**ï¼šä½¿ç”¨ `LOCK TABLE` æ˜¾å¼è·å–è¡¨çº§é”

### 2.1 è¡¨çº§é”

**è¡¨çº§é”ç±»å‹è¯¦è§£**:

PostgreSQL æä¾› 8 ç§è¡¨çº§é”ï¼ŒæŒ‰å†²çªç¨‹åº¦ä»ä½åˆ°é«˜ï¼š

```sql
-- 1. æŸ¥çœ‹å½“å‰é”ä¿¡æ¯
SELECT
    locktype,
    relation::regclass AS table_name,
    mode,
    granted,
    pid,
    usename
FROM pg_locks
WHERE locktype = 'relation'
    AND relation = 'users'::regclass;

-- 2. ACCESS SHAREï¼ˆæœ€ä½çº§åˆ«ï¼‰- SELECT æŸ¥è¯¢è‡ªåŠ¨è·å–
BEGIN;
SELECT * FROM users WHERE id = 1;
-- è‡ªåŠ¨è·å– ACCESS SHARE é”
COMMIT;

-- 3. ROW SHARE - SELECT FOR UPDATE è‡ªåŠ¨è·å–
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE;
-- è‡ªåŠ¨è·å– ROW SHARE é”
COMMIT;

-- 4. ROW EXCLUSIVE - INSERT, UPDATE, DELETE è‡ªåŠ¨è·å–
BEGIN;
INSERT INTO users (name, email) VALUES ('John', 'john@example.com');
-- è‡ªåŠ¨è·å– ROW EXCLUSIVE é”
COMMIT;

-- 5. SHARE UPDATE EXCLUSIVE - VACUUM, CREATE INDEX CONCURRENTLY
BEGIN;
CREATE INDEX CONCURRENTLY idx_users_email ON users(email);
-- è‡ªåŠ¨è·å– SHARE UPDATE EXCLUSIVE é”
COMMIT;

-- 6. SHARE - CREATE INDEXï¼ˆéå¹¶å‘ï¼‰
BEGIN;
CREATE INDEX idx_users_name ON users(name);
-- è‡ªåŠ¨è·å– SHARE é”
COMMIT;

-- 7. SHARE ROW EXCLUSIVE - CREATE TRIGGER
BEGIN;
CREATE TRIGGER users_audit_trigger
    AFTER INSERT ON users
    FOR EACH ROW EXECUTE FUNCTION audit_function();
-- è‡ªåŠ¨è·å– SHARE ROW EXCLUSIVE é”
COMMIT;

-- 8. EXCLUSIVE - ALTER TABLEï¼ˆæŸäº›æ“ä½œï¼‰
BEGIN;
ALTER TABLE users ADD COLUMN status TEXT;
-- è‡ªåŠ¨è·å– EXCLUSIVE é”
COMMIT;

-- 9. ACCESS EXCLUSIVEï¼ˆæœ€é«˜çº§åˆ«ï¼‰- DROP TABLE, TRUNCATE, ALTER TABLEï¼ˆæŸäº›æ“ä½œï¼‰
BEGIN;
TRUNCATE TABLE users;
-- è‡ªåŠ¨è·å– ACCESS EXCLUSIVE é”
COMMIT;

-- 10. æ˜¾å¼è·å–è¡¨çº§é”
BEGIN;
LOCK TABLE users IN SHARE MODE;
-- æ˜¾å¼è·å– SHARE é”
SELECT * FROM users;
COMMIT;

-- 11. æŸ¥çœ‹è¡¨çº§é”çš„å…¼å®¹æ€§
-- ACCESS SHARE: å…¼å®¹ ACCESS SHARE, ROW SHARE, ROW EXCLUSIVE, SHARE, EXCLUSIVE
-- ROW SHARE: å…¼å®¹ ACCESS SHARE, ROW SHARE, ROW EXCLUSIVE, SHARE, EXCLUSIVE
-- ROW EXCLUSIVE: å…¼å®¹ ACCESS SHARE, ROW SHARE, ROW EXCLUSIVE
-- SHARE: å…¼å®¹ ACCESS SHARE, ROW SHARE, SHARE
-- EXCLUSIVE: å…¼å®¹ ACCESS SHARE, ROW SHARE
-- ACCESS EXCLUSIVE: ä¸å…¼å®¹ä»»ä½•é”
```

### 2.2 è¡Œçº§é”

**è¡Œçº§é”ç±»å‹**:

```sql
-- FOR UPDATE: æ’ä»–é”
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- FOR SHARE: å…±äº«é”
SELECT * FROM users WHERE id = 1 FOR SHARE;

-- FOR NO KEY UPDATE: éé”®æ’ä»–é”
SELECT * FROM users WHERE id = 1 FOR NO KEY UPDATE;

-- FOR KEY SHARE: é”®å…±äº«é”
SELECT * FROM users WHERE id = 1 FOR KEY SHARE;
```

### 2.3 é”å…¼å®¹æ€§

**é”å…¼å®¹æ€§å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰1ï¼ˆé”å…¼å®¹æ€§å‡½æ•°ï¼‰**ï¼š
è®¾ Compatible(lock1, lock2) â†’ {true, false}ï¼Œåˆ¤æ–­ä¸¤ä¸ªé”æ˜¯å¦å…¼å®¹ï¼š

```
1. å¦‚æœ lock1 å’Œ lock2 æ˜¯ç›¸åŒç±»å‹ä¸”éƒ½æ˜¯å…±äº«é” â†’ true
2. å¦‚æœ lock1 å’Œ lock2 æ˜¯ä¸åŒç²’åº¦ï¼ˆè¡¨çº§ vs è¡Œçº§ï¼‰â†’ true
3. å¦‚æœ lock1 æ˜¯ ACCESS SHARE ä¸” lock2 ä¸æ˜¯ ACCESS EXCLUSIVE â†’ true
4. å¦‚æœ lock1 æ˜¯ ACCESS EXCLUSIVE â†’ falseï¼ˆä¸å…¼å®¹ä»»ä½•é”ï¼‰
5. å¦åˆ™æ ¹æ®é”å…¼å®¹æ€§çŸ©é˜µåˆ¤æ–­
```

**å®šä¹‰2ï¼ˆæ­»é”æ£€æµ‹ç®—æ³•ï¼‰**ï¼š
è®¾ DeadlockDetection(transactions) â†’ {deadlock, no_deadlock}ï¼š

```
1. æ„å»ºç­‰å¾…å›¾ G = (V, E)ï¼Œå…¶ä¸­ï¼š
   - V = {æ‰€æœ‰äº‹åŠ¡}
   - E = {(T1, T2) | T1ç­‰å¾…T2æŒæœ‰çš„é”}
2. æ£€æµ‹å›¾ä¸­æ˜¯å¦å­˜åœ¨ç¯
3. å¦‚æœå­˜åœ¨ç¯ â†’ deadlock
4. å¦åˆ™ â†’ no_deadlock
```

**ç®—æ³•å¤æ‚åº¦**ï¼š

- æ­»é”æ£€æµ‹æ—¶é—´å¤æ‚åº¦ï¼šO(V + E)ï¼ŒVä¸ºäº‹åŠ¡æ•°ï¼ŒEä¸ºç­‰å¾…è¾¹æ•°
- é”å…¼å®¹æ€§åˆ¤æ–­æ—¶é—´å¤æ‚åº¦ï¼šO(1)ï¼ˆæŸ¥è¡¨ï¼‰

**å½¢å¼åŒ–è¯æ˜**ï¼š

**å®šç†1ï¼ˆæ­»é”æ£€æµ‹æ­£ç¡®æ€§ï¼‰**ï¼š
æ­»é”æ£€æµ‹ç®—æ³•èƒ½å¤Ÿæ­£ç¡®æ£€æµ‹æ‰€æœ‰æ­»é”æƒ…å†µã€‚

**è¯æ˜**ï¼š

1. ç­‰å¾…å›¾Gå‡†ç¡®åæ˜ äº†äº‹åŠ¡é—´çš„ç­‰å¾…å…³ç³»
2. å›¾ä¸­å­˜åœ¨ç¯å½“ä¸”ä»…å½“å­˜åœ¨æ­»é”
3. æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰èƒ½å¤Ÿæ£€æµ‹æ‰€æœ‰ç¯
4. å› æ­¤ï¼Œç®—æ³•èƒ½å¤Ÿæ­£ç¡®æ£€æµ‹æ‰€æœ‰æ­»é”

**é”å…¼å®¹æ€§çŸ©é˜µ**:

| é”ç±»å‹ | ACCESS SHARE | ROW SHARE | ROW EXCLUSIVE | SHARE | EXCLUSIVE | ACCESS EXCLUSIVE |
|--------|--------------|-----------|---------------|-------|-----------|------------------|
| **ACCESS SHARE** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **ROW SHARE** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **ROW EXCLUSIVE** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **SHARE** | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| **EXCLUSIVE** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **ACCESS EXCLUSIVE** | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |

## 3. é”ç›‘æ§

### 3.1 æŸ¥çœ‹é”ä¿¡æ¯

**æŸ¥çœ‹å½“å‰é”**:

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    database,
    relation::regclass,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks;

-- æŸ¥çœ‹ç­‰å¾…é”çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.2 æ­»é”æ£€æµ‹

**æ­»é”æ£€æµ‹**:

```sql
-- PostgreSQL è‡ªåŠ¨æ£€æµ‹æ­»é”
-- æ­»é”å‘ç”Ÿæ—¶ï¼Œä¼šå›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡

-- æŸ¥çœ‹æ­»é”æ—¥å¿—ï¼ˆéœ€è¦é…ç½® log_lock_waitsï¼‰
-- postgresql.conf:
-- log_lock_waits = on
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: é”ç­‰å¾…é—®é¢˜è§£å†³ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸåº”ç”¨å‡ºç°é”ç­‰å¾…é—®é¢˜ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ã€‚

**é—®é¢˜åˆ†æ**:

1. **é”ç­‰å¾…**: å¤§é‡æŸ¥è¯¢ç­‰å¾…é”
2. **æ€§èƒ½ä¸‹é™**: æŸ¥è¯¢æ€§èƒ½ä¸‹é™
3. **å¹¶å‘é—®é¢˜**: å¹¶å‘è®¿é—®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. è¯†åˆ«é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 2. ä¼˜åŒ–é”ä½¿ç”¨
-- ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”
-- å‡å°‘é”æŒæœ‰æ—¶é—´
-- ä½¿ç”¨åˆé€‚çš„éš”ç¦»çº§åˆ«

-- 3. è°ƒæ•´é”è¶…æ—¶
SET lock_timeout = '5s';
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é”ç­‰å¾…æ—¶é—´** | 10 ç§’ | **< 1ç§’** | **90%** â¬‡ï¸ |
| **æŸ¥è¯¢æ€§èƒ½** | åŸºå‡† | **+40%** | **æå‡** |
| **æ­»é”æ¬¡æ•°** | 10/å¤© | **0** | **100%** â¬‡ï¸ |

## 5. æœ€ä½³å®è·µ

### 5.1 é”ä½¿ç”¨

**æ¨èåšæ³•**ï¼š

1. **æœ€å°é”èŒƒå›´**ï¼ˆä½¿ç”¨è¡Œçº§é”è€Œéè¡¨çº§é”ï¼Œå‡å°‘é”ç«äº‰ï¼‰
2. **è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´**ï¼ˆé¿å…é•¿æ—¶é—´ç­‰å¾…ï¼‰
3. **ç»Ÿä¸€é”é¡ºåºé¿å…æ­»é”**ï¼ˆæ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºè·å–é”ï¼‰
4. **ä½¿ç”¨ SKIP LOCKED å¤„ç†å¹¶å‘é˜Ÿåˆ—**ï¼ˆè·³è¿‡å·²é”å®šçš„è¡Œï¼‰
5. **å‡å°‘é”æŒæœ‰æ—¶é—´**ï¼ˆå°½å¿«é‡Šæ”¾é”ï¼‰

**é¿å…åšæ³•**ï¼š

1. **é¿å…é•¿æ—¶é—´æŒæœ‰é”**ï¼ˆå½±å“å¹¶å‘æ€§èƒ½ï¼‰
2. **é¿å…ä¸å¿…è¦çš„é”**ï¼ˆåªåœ¨éœ€è¦æ—¶ä½¿ç”¨é”ï¼‰
3. **é¿å…é”å‡çº§**ï¼ˆè¡¨çº§é”é˜»å¡æ‰€æœ‰æ“ä½œï¼‰

### 5.2 æ€§èƒ½ä¼˜åŒ–

**æ¨èåšæ³•**ï¼š

1. **å®šæœŸç›‘æ§é”ç­‰å¾…æƒ…å†µ**ï¼ˆåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ï¼‰
2. **ä¼˜åŒ–é”çš„ä½¿ç”¨å‡å°‘é”ç«äº‰**ï¼ˆä½¿ç”¨è¡Œçº§é”ã€ç»Ÿä¸€é”é¡ºåºï¼‰
3. **åŠæ—¶å¤„ç†æ­»é”é—®é¢˜**ï¼ˆé…ç½®æ­»é”æ£€æµ‹å’Œæ—¥å¿—ï¼‰
4. **ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥**ï¼ˆå‡å°‘è¿æ¥å¼€é”€å’Œé”ç«äº‰ï¼‰
5. **åˆ†æé”ç­‰å¾…æ¨¡å¼**ï¼ˆè¯†åˆ«é”ç«äº‰çƒ­ç‚¹ï¼‰

**é¿å…åšæ³•**ï¼š

1. **é¿å…å¿½ç•¥é”ç­‰å¾…**ï¼ˆå®šæœŸç›‘æ§é”ç­‰å¾…æƒ…å†µï¼‰
2. **é¿å…ä¸å¿…è¦çš„è¡¨çº§é”**ï¼ˆä½¿ç”¨è¡Œçº§é”ï¼‰
3. **é¿å…é•¿äº‹åŠ¡**ï¼ˆé•¿æ—¶é—´æŒæœ‰é”ï¼Œå½±å“å¹¶å‘ï¼‰
4. **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–ç´¢å¼•å‡å°‘é”ç«äº‰
5. **ç›‘æ§**: ç›‘æ§é”ç­‰å¾…æƒ…å†µ

## 6. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 6.1 é”æœºåˆ¶åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•æŸ¥çœ‹å’Œè¯Šæ–­é”ç­‰å¾…é—®é¢˜ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šç³»ç»Ÿå‡ºç°é”ç­‰å¾…ï¼Œä¸çŸ¥é“å¦‚ä½•è¯Šæ–­ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æŸ¥çœ‹æ‰€æœ‰é”
SELECT * FROM pg_locks WHERE relation = 'accounts'::regclass;

-- 2. æŸ¥çœ‹é˜»å¡æŸ¥è¯¢
SELECT
    pid,
    usename,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE wait_event_type = 'Lock';

-- 3. ç»ˆæ­¢é˜»å¡æŸ¥è¯¢ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SELECT pg_terminate_backend(blocking_pid);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— è¯Šæ–­ï¼šé”ç­‰å¾…æ—¶é—´ **10ç§’**ï¼Œç³»ç»Ÿé˜»å¡
- æœ‰è¯Šæ–­ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼ŒåŠæ—¶è§£å†³
- **æ•…éšœæ¢å¤æ—¶é—´æå‡ï¼š10å€**

#### Q2: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šç³»ç»Ÿå‡ºç°æ­»é”ï¼Œä¸çŸ¥é“å¦‚ä½•é¿å…ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥æ­»é”ç»Ÿè®¡
SELECT deadlocks FROM pg_stat_database WHERE datname = current_database();

-- 2. æ£€æŸ¥é”é¡ºåº
-- åˆ†æäº‹åŠ¡çš„é”è·å–é¡ºåº
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ç»Ÿä¸€é”é¡ºåºï¼ˆæ¨èï¼‰
-- æ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºè·å–é”ï¼ˆå¦‚æŒ‰IDæ’åºï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
SELECT * FROM accounts WHERE id = 2 FOR UPDATE;
COMMIT;

-- 2. ä½¿ç”¨é”è¶…æ—¶
SET lock_timeout = '5s';
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
COMMIT;

-- 3. ä½¿ç”¨NOWAIT
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE NOWAIT;
COMMIT;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- æ— é¢„é˜²ï¼šæ­»é”ç‡ **5%**ï¼Œç³»ç»Ÿä¸ç¨³å®š
- æœ‰é¢„é˜²ï¼šæ­»é”ç‡ **< 0.1%**ï¼Œç³»ç»Ÿç¨³å®š
- **ç¨³å®šæ€§æå‡ï¼š50å€**

### 6.2 é”æ€§èƒ½å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•ä¼˜åŒ–é”æ€§èƒ½ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šé”ç«äº‰ä¸¥é‡ï¼Œå½±å“å¹¶å‘æ€§èƒ½ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

```sql
-- 1. æ£€æŸ¥é”ç­‰å¾…
SELECT count(*) FROM pg_locks WHERE NOT granted;

-- 2. æ£€æŸ¥é”ç±»å‹
SELECT mode, count(*) FROM pg_locks GROUP BY mode;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- 1. ä½¿ç”¨è¡Œçº§é”è€Œéè¡¨çº§é”
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è¡Œçº§é”
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- 2. å‡å°‘é”æŒæœ‰æ—¶é—´
BEGIN;
-- å¿«é€Ÿæ‰§è¡Œæ“ä½œ
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- 3. ä½¿ç”¨SKIP LOCKED
SELECT * FROM orders
WHERE status = 'pending'
FOR UPDATE SKIP LOCKED
LIMIT 10;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- è¡¨çº§é”ï¼šå¹¶å‘æ€§èƒ½ **100 TPS**
- è¡Œçº§é”ï¼šå¹¶å‘æ€§èƒ½ **1000+ TPS**
- **æ€§èƒ½æå‡ï¼š10å€**

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ˜¾å¼é”å®š](https://www.postgresql.org/docs/current/explicit-locking.html)**
  - é”æœºåˆ¶è¯¦è§£
  - é”ç±»å‹å’Œä½¿ç”¨åœºæ™¯

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”ç›‘æ§](https://www.postgresql.org/docs/current/monitoring-locks.html)**
  - é”ç›‘æ§å·¥å…·å’Œæ–¹æ³•
  - é”é—®é¢˜è¯Šæ–­

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ­»é”](https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-DEADLOCKS)**
  - æ­»é”æ£€æµ‹å’Œé¢„é˜²
  - æ­»é”å¤„ç†æœ€ä½³å®è·µ

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”ç­‰å¾…](https://www.postgresql.org/docs/current/monitoring-locks.html#LOCK-WAITING)**
  - é”ç­‰å¾…ç›‘æ§
  - é”ç­‰å¾…é—®é¢˜è¯Šæ–­

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”è¡¨](https://www.postgresql.org/docs/current/sql-lock.html)**
  - LOCK TABLE å‘½ä»¤è¯¦è§£
  - è¡¨çº§é”ä½¿ç”¨æŒ‡å—

### 6.2 æŠ€æœ¯è®ºæ–‡

- **Gray, J., et al. (1976). "Granularity of Locks and Degrees of Consistency in a Shared Data Base."**
  - ä¼šè®®: IFIP Working Conference on Database Systems
  - **é‡è¦æ€§**: é”ç²’åº¦å’Œä¸€è‡´æ€§çº§åˆ«çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†é”ç²’åº¦æ¦‚å¿µå’Œä¸€è‡´æ€§çº§åˆ«å®šä¹‰ï¼Œä¸ºç°ä»£æ•°æ®åº“é”æœºåˆ¶æä¾›äº†ç†è®ºåŸºç¡€

- **Bernstein, P. A., & Goodman, N. (1981). "Concurrency Control in Distributed Database Systems."**
  - æœŸåˆŠ: ACM Computing Surveys, 13(2), 185-221
  - **é‡è¦æ€§**: åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°é˜è¿°äº†åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿä¸­çš„å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼ŒåŒ…æ‹¬é”æœºåˆ¶

- **Kung, H. T., & Robinson, J. T. (1981). "On Optimistic Methods for Concurrency Control."**
  - æœŸåˆŠ: ACM Transactions on Database Systems (TODS), 6(2), 213-226
  - **é‡è¦æ€§**: ä¹è§‚å¹¶å‘æ§åˆ¶çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ä¹è§‚å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œä¸é”æœºåˆ¶å½¢æˆå¯¹æ¯”

- **Rosenkrantz, D. J., et al. (1978). "System Level Concurrency Control for Distributed Database Systems."**
  - æœŸåˆŠ: ACM Transactions on Database Systems (TODS), 3(2), 178-198
  - **é‡è¦æ€§**: æ­»é”æ£€æµ‹å’Œé¢„é˜²çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†æ­»é”æ£€æµ‹ç®—æ³•ï¼Œä¸ºç°ä»£æ•°æ®åº“ç³»ç»Ÿçš„æ­»é”å¤„ç†æä¾›äº†ç†è®ºåŸºç¡€

### 6.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é”æœºåˆ¶](https://www.postgresql.org/docs/current/explicit-locking.html)**
  - é”æœºåˆ¶è¯¦è§£
  - é”ä½¿ç”¨æœ€ä½³å®è·µ

- **[2ndQuadrant - PostgreSQL é”ç›‘æ§](https://www.2ndquadrant.com/en/blog/postgresql-lock-monitoring/)**
  - é”ç›‘æ§å®æˆ˜
  - é”é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

- **[Percona - PostgreSQL æ­»é”å¤„ç†](https://www.percona.com/blog/postgresql-deadlocks/)**
  - æ­»é”é—®é¢˜è¯Šæ–­
  - æ­»é”é¢„é˜²ç­–ç•¥

- **[EnterpriseDB - PostgreSQL é”è¯¦è§£](https://www.enterprisedb.com/postgres-tutorials/postgresql-locking)**
  - é”æœºåˆ¶æ·±å…¥è§£æ
  - é”æ€§èƒ½ä¼˜åŒ–

### 6.4 ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - Lock Monitoring](https://wiki.postgresql.org/wiki/Lock_Monitoring)**
  - é”ç›‘æ§å·¥å…·å’Œæ–¹æ³•
  - é”é—®é¢˜è¯Šæ–­

- **[PostgreSQL Wiki - Lock Types](https://wiki.postgresql.org/wiki/Lock_Types)**
  - é”ç±»å‹è¯´æ˜
  - é”å…¼å®¹æ€§çŸ©é˜µ

- **[Stack Overflow - PostgreSQL Locks](https://stackoverflow.com/questions/tagged/postgresql+locks)**
  - é”ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- [å¹¶å‘æ§åˆ¶è¯¦è§£](./å¹¶å‘æ§åˆ¶è¯¦è§£.md)
- [äº‹åŠ¡ç®¡ç†è¯¦è§£](./äº‹åŠ¡ç®¡ç†è¯¦è§£.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”](https://www.postgresql.org/docs/current/explicit-locking.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-32
