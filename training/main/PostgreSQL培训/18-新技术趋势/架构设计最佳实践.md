# æ¶æ„è®¾è®¡æœ€ä½³å®è·µï¼šPostgreSQL ç³»ç»Ÿæ¶æ„è®¾è®¡æŒ‡å—

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 17+/18+ æ¶æ„è®¾è®¡
> **æ–‡æ¡£ç¼–å·**: 03-03-TREND-32

## ğŸ“‘ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» PostgreSQL ç³»ç»Ÿæ¶æ„è®¾è®¡çš„æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬é«˜å¯ç”¨æ¶æ„ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ç¼“å­˜ç­–ç•¥ã€ç›‘æ§ä½“ç³»ç­‰æ¶æ„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ æ ¸å¿ƒä»·å€¼

- **é«˜å¯ç”¨æ¶æ„**ï¼šå¯é çš„é«˜å¯ç”¨æ¶æ„è®¾è®¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ€§èƒ½ä¼˜åŒ–çš„æ¶æ„æ¨¡å¼
- **å¯æ‰©å±•æ€§**ï¼šå¯æ‰©å±•çš„æ¶æ„è®¾è®¡
- **å®‰å…¨æ€§**ï¼šå®‰å…¨çš„æ¶æ„è®¾è®¡
- **å¯ç»´æŠ¤æ€§**ï¼šæ˜“äºç»´æŠ¤çš„æ¶æ„è®¾è®¡

## ğŸ“š ç›®å½•

- [æ¶æ„è®¾è®¡æœ€ä½³å®è·µï¼šPostgreSQL ç³»ç»Ÿæ¶æ„è®¾è®¡æŒ‡å—](#æ¶æ„è®¾è®¡æœ€ä½³å®è·µpostgresql-ç³»ç»Ÿæ¶æ„è®¾è®¡æŒ‡å—)
  - [ğŸ“‘ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æ ¸å¿ƒä»·å€¼](#-æ ¸å¿ƒä»·å€¼)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [1. æ¶æ„è®¾è®¡åŸåˆ™](#1-æ¶æ„è®¾è®¡åŸåˆ™)
    - [1.0 æ¶æ„è®¾è®¡æœ€ä½³å®è·µçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#10-æ¶æ„è®¾è®¡æœ€ä½³å®è·µçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.0 æ¶æ„è®¾è®¡å·¥ä½œåŸç†æ¦‚è¿°](#10-æ¶æ„è®¾è®¡å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 è®¾è®¡åŸåˆ™](#11-è®¾è®¡åŸåˆ™)
    - [1.2 æ¶æ„å±‚æ¬¡](#12-æ¶æ„å±‚æ¬¡)
  - [2. é«˜å¯ç”¨æ¶æ„](#2-é«˜å¯ç”¨æ¶æ„)
    - [2.1 ä¸»ä»å¤åˆ¶æ¶æ„](#21-ä¸»ä»å¤åˆ¶æ¶æ„)
    - [2.2 Patroni é«˜å¯ç”¨æ¶æ„](#22-patroni-é«˜å¯ç”¨æ¶æ„)
    - [2.3 é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”](#23-é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”)
  - [3. è¯»å†™åˆ†ç¦»æ¶æ„](#3-è¯»å†™åˆ†ç¦»æ¶æ„)
    - [3.1 è¯»å†™åˆ†ç¦»æ¶æ„](#31-è¯»å†™åˆ†ç¦»æ¶æ„)
    - [3.2 PgPool-II é…ç½®](#32-pgpool-ii-é…ç½®)
    - [3.3 åº”ç”¨å±‚è¯»å†™åˆ†ç¦»](#33-åº”ç”¨å±‚è¯»å†™åˆ†ç¦»)
  - [4. åˆ†åº“åˆ†è¡¨æ¶æ„](#4-åˆ†åº“åˆ†è¡¨æ¶æ„)
    - [4.1 å‚ç›´åˆ†åº“](#41-å‚ç›´åˆ†åº“)
    - [4.2 æ°´å¹³åˆ†è¡¨](#42-æ°´å¹³åˆ†è¡¨)
    - [4.3 åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶](#43-åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶)
  - [5. ç¼“å­˜æ¶æ„](#5-ç¼“å­˜æ¶æ„)
    - [5.1 å¤šçº§ç¼“å­˜æ¶æ„](#51-å¤šçº§ç¼“å­˜æ¶æ„)
    - [5.2 Redis ç¼“å­˜ç­–ç•¥](#52-redis-ç¼“å­˜ç­–ç•¥)
    - [5.3 ç¼“å­˜æ›´æ–°ç­–ç•¥](#53-ç¼“å­˜æ›´æ–°ç­–ç•¥)
  - [6. ç›‘æ§æ¶æ„](#6-ç›‘æ§æ¶æ„)
    - [6.1 ç›‘æ§ä½“ç³»](#61-ç›‘æ§ä½“ç³»)
    - [6.2 ç›‘æ§æŒ‡æ ‡](#62-ç›‘æ§æŒ‡æ ‡)
    - [6.3 å‘Šè­¦è§„åˆ™](#63-å‘Šè­¦è§„åˆ™)
  - [7. å®é™…æ¡ˆä¾‹](#7-å®é™…æ¡ˆä¾‹)
    - [7.1 æ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿæ¶æ„](#71-æ¡ˆä¾‹ç”µå•†ç³»ç»Ÿæ¶æ„)
    - [7.2 æ¡ˆä¾‹ï¼šIoT å¹³å°æ¶æ„](#72-æ¡ˆä¾‹iot-å¹³å°æ¶æ„)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯è®ºæ–‡](#æŠ€æœ¯è®ºæ–‡)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç¤¾åŒºèµ„æº](#ç¤¾åŒºèµ„æº)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
  - [8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#8-å¸¸è§é—®é¢˜faq)
    - [8.1 æ¶æ„è®¾è®¡åŸºç¡€å¸¸è§é—®é¢˜](#81-æ¶æ„è®¾è®¡åŸºç¡€å¸¸è§é—®é¢˜)
      - [Q1: å¦‚ä½•è®¾è®¡é«˜å¯ç”¨æ¶æ„ï¼Ÿ](#q1-å¦‚ä½•è®¾è®¡é«˜å¯ç”¨æ¶æ„)
      - [Q2: å¦‚ä½•å®ç°è¯»å†™åˆ†ç¦»ï¼Ÿ](#q2-å¦‚ä½•å®ç°è¯»å†™åˆ†ç¦»)
    - [8.2 æ‰©å±•æ€§è®¾è®¡å¸¸è§é—®é¢˜](#82-æ‰©å±•æ€§è®¾è®¡å¸¸è§é—®é¢˜)
      - [Q3: å¦‚ä½•å®ç°æ°´å¹³æ‰©å±•ï¼Ÿ](#q3-å¦‚ä½•å®ç°æ°´å¹³æ‰©å±•)
  - [ğŸ“š å‚è€ƒèµ„æ–™1](#-å‚è€ƒèµ„æ–™1)

---

## 1. æ¶æ„è®¾è®¡åŸåˆ™

### 1.0 æ¶æ„è®¾è®¡æœ€ä½³å®è·µçŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ¶æ„è®¾è®¡æœ€ä½³å®è·µ))
    é«˜å¯ç”¨æ¶æ„
      ä¸»ä»å¤åˆ¶æ¶æ„
        æ¶æ„è®¾è®¡
        æ¶æ„ä¼˜åŒ–
      Patronié«˜å¯ç”¨æ¶æ„
        æ¶æ„è®¾è®¡
        æ¶æ„ä¼˜åŒ–
      é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”
        æ–¹æ¡ˆå¯¹æ¯”
        æ–¹æ¡ˆé€‰æ‹©
    è¯»å†™åˆ†ç¦»æ¶æ„
      è¯»å†™åˆ†ç¦»æ¶æ„
        æ¶æ„è®¾è®¡
        æ¶æ„ä¼˜åŒ–
      PgPool-IIé…ç½®
        é…ç½®æ–¹æ³•
        é…ç½®ä¼˜åŒ–
      åº”ç”¨å±‚è¯»å†™åˆ†ç¦»
        åˆ†ç¦»æ–¹æ³•
        åˆ†ç¦»ä¼˜åŒ–
    åˆ†åº“åˆ†è¡¨æ¶æ„
      å‚ç›´åˆ†åº“
        åˆ†åº“æ–¹æ³•
        åˆ†åº“ä¼˜åŒ–
      æ°´å¹³åˆ†è¡¨
        åˆ†è¡¨æ–¹æ³•
        åˆ†è¡¨ä¼˜åŒ–
      åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶
        ä¸­é—´ä»¶é€‰æ‹©
        ä¸­é—´ä»¶é…ç½®
    ç¼“å­˜æ¶æ„
      å¤šçº§ç¼“å­˜æ¶æ„
        æ¶æ„è®¾è®¡
        æ¶æ„ä¼˜åŒ–
      Redisç¼“å­˜ç­–ç•¥
        ç­–ç•¥è®¾è®¡
        ç­–ç•¥ä¼˜åŒ–
      ç¼“å­˜æ›´æ–°ç­–ç•¥
        æ›´æ–°ç­–ç•¥
        æ›´æ–°ä¼˜åŒ–
    ç›‘æ§æ¶æ„
      ç›‘æ§ä½“ç³»
        ä½“ç³»è®¾è®¡
        ä½“ç³»ä¼˜åŒ–
      ç›‘æ§æŒ‡æ ‡
        æŒ‡æ ‡è®¾è®¡
        æŒ‡æ ‡ä¼˜åŒ–
      å‘Šè­¦è§„åˆ™
        è§„åˆ™è®¾è®¡
        è§„åˆ™ä¼˜åŒ–
```

### 1.0 æ¶æ„è®¾è®¡å·¥ä½œåŸç†æ¦‚è¿°

**æ¶æ„è®¾è®¡çš„æœ¬è´¨**ï¼š

PostgreSQL ç³»ç»Ÿæ¶æ„è®¾è®¡æ˜¯ä¸€ä¸ªç³»ç»ŸåŒ–çš„è¿‡ç¨‹ï¼Œé€šè¿‡åˆç†è®¾è®¡é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„æ¶æ„ï¼Œæ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚
æ¶æ„è®¾è®¡éœ€è¦éµå¾ª"é«˜å¯ç”¨ä¼˜å…ˆ"çš„åŸåˆ™ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

**æ¶æ„è®¾è®¡æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[ä¸šåŠ¡éœ€æ±‚] --> B[æ¶æ„è®¾è®¡]
    B --> C{æ¶æ„ç±»å‹}
    C -->|é«˜å¯ç”¨| D[ä¸»ä»å¤åˆ¶æ¶æ„]
    C -->|é«˜æ€§èƒ½| E[è¯»å†™åˆ†ç¦»æ¶æ„]
    C -->|å¯æ‰©å±•| F[åˆ†åº“åˆ†è¡¨æ¶æ„]
    C -->|ç¼“å­˜| G[å¤šçº§ç¼“å­˜æ¶æ„]
    D --> H[å®æ–½æ¶æ„]
    E --> H
    F --> H
    G --> H
    H --> I[ç›‘æ§å’Œè¿ç»´]
    I --> J{æ€§èƒ½è¾¾æ ‡?}
    J -->|å¦| B
    J -->|æ˜¯| K[æŒç»­ä¼˜åŒ–]

    style C fill:#FFD700
    style H fill:#90EE90
    style K fill:#87CEEB
```

**æ¶æ„è®¾è®¡å…³é”®æŒ‡æ ‡**ï¼š

- **å¯ç”¨æ€§**ï¼šç³»ç»Ÿå¯ç”¨æ€§ï¼ˆç›®æ ‡ > 99.9%ï¼‰
- **æ€§èƒ½**ï¼šTPS/QPSã€å“åº”æ—¶é—´ï¼ˆP50ã€P95ã€P99ï¼‰
- **å¯æ‰©å±•æ€§**ï¼šæ°´å¹³æ‰©å±•èƒ½åŠ›ï¼ˆæ”¯æŒåŠ¨æ€æ‰©å®¹ï¼‰
- **å®‰å…¨æ€§**ï¼šæ•°æ®å®‰å…¨å’Œè®¿é—®æ§åˆ¶ï¼ˆåŠ å¯†ã€å®¡è®¡ï¼‰
- **å¯ç»´æŠ¤æ€§**ï¼šç›‘æ§å’Œè¿ç»´èƒ½åŠ›ï¼ˆè‡ªåŠ¨åŒ–è¿ç»´ï¼‰

### 1.1 è®¾è®¡åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼š

- **é«˜å¯ç”¨**ï¼šç³»ç»Ÿå¯ç”¨æ€§ > 99.9%ï¼ˆä¸»ä»å¤åˆ¶ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰
- **é«˜æ€§èƒ½**ï¼šæ»¡è¶³æ€§èƒ½è¦æ±‚ï¼ˆç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç¼“å­˜ï¼‰
- **å¯æ‰©å±•**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ï¼‰
- **å®‰å…¨æ€§**ï¼šæ•°æ®å®‰å…¨å’Œè®¿é—®æ§åˆ¶ï¼ˆåŠ å¯†ã€å®¡è®¡ã€æƒé™æ§åˆ¶ï¼‰
- **å¯ç»´æŠ¤**ï¼šæ˜“äºè¿ç»´å’Œç›‘æ§ï¼ˆè‡ªåŠ¨åŒ–è¿ç»´ã€ç›‘æ§å‘Šè­¦ï¼‰

**æ¶æ„è®¾è®¡ä¼˜å…ˆçº§**ï¼š

1. **é«˜ä¼˜å…ˆçº§**ï¼šé«˜å¯ç”¨æ¶æ„ï¼ˆç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ï¼‰
2. **ä¸­ä¼˜å…ˆçº§**ï¼šæ€§èƒ½ä¼˜åŒ–æ¶æ„ï¼ˆæå‡ç³»ç»Ÿæ€§èƒ½ï¼‰
3. **ä½ä¼˜å…ˆçº§**ï¼šå¯æ‰©å±•æ¶æ„ï¼ˆæ”¯æŒæœªæ¥æ‰©å±•ï¼‰

### 1.2 æ¶æ„å±‚æ¬¡

**å…¸å‹æ¶æ„å±‚æ¬¡**ï¼š

```text
åº”ç”¨å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
    â†“
æ¥å…¥å±‚ï¼ˆè´Ÿè½½å‡è¡¡ã€APIç½‘å…³ï¼‰
    â†“
æœåŠ¡å±‚ï¼ˆåº”ç”¨æœåŠ¡ã€å¾®æœåŠ¡ï¼‰
    â†“
æ•°æ®å±‚ï¼ˆPostgreSQLã€ç¼“å­˜ï¼‰
    â†“
å­˜å‚¨å±‚ï¼ˆç£ç›˜/SSDã€å¯¹è±¡å­˜å‚¨ï¼‰
```

**æ¶æ„å±‚æ¬¡è¯´æ˜**ï¼š

- **åº”ç”¨å±‚**ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¾®æœåŠ¡ã€APIï¼‰
- **æ¥å…¥å±‚**ï¼šæµé‡åˆ†å‘å’Œè´Ÿè½½å‡è¡¡ï¼ˆNginxã€HAProxyï¼‰
- **æœåŠ¡å±‚**ï¼šåº”ç”¨æœåŠ¡å’Œä¸­é—´ä»¶ï¼ˆåº”ç”¨æœåŠ¡å™¨ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- **æ•°æ®å±‚**ï¼šæ•°æ®åº“å’Œç¼“å­˜ï¼ˆPostgreSQLã€Redisï¼‰
- **å­˜å‚¨å±‚**ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆç£ç›˜ã€SSDã€å¯¹è±¡å­˜å‚¨ï¼‰

---

## 2. é«˜å¯ç”¨æ¶æ„

### 2.1 ä¸»ä»å¤åˆ¶æ¶æ„

**ä¸»ä»å¤åˆ¶æ¶æ„æ¦‚è¿°**ï¼š

ä¸»ä»å¤åˆ¶æ¶æ„é€šè¿‡æµå¤åˆ¶å®ç°æ•°æ®åŒæ­¥ï¼Œä¸»åº“å¤„ç†å†™æ“ä½œï¼Œä»åº“å¤„ç†è¯»æ“ä½œï¼Œæå‡ç³»ç»Ÿå¯ç”¨æ€§å’Œæ€§èƒ½ã€‚

**ä¸»ä»å¤åˆ¶æ¶æ„æµç¨‹å›¾**ï¼š

```mermaid
flowchart LR
    A[ä¸»åº“ Primary] -->|WAL æµå¤åˆ¶| B[ä»åº“1 Standby]
    A -->|WAL æµå¤åˆ¶| C[ä»åº“2 Standby]
    A -->|WAL æµå¤åˆ¶| D[ä»åº“3 Standby]
    B -->|è¯»è¯·æ±‚| E[åº”ç”¨]
    C -->|è¯»è¯·æ±‚| E
    D -->|è¯»è¯·æ±‚| E
    A -->|å†™è¯·æ±‚| E
    A -.æ•…éšœ.-> F[æ•…éšœè½¬ç§»]
    B -.æå‡ä¸ºä¸»åº“.-> F

    style A fill:#FF6B6B
    style B fill:#4ECDC4
    style C fill:#4ECDC4
    style D fill:#4ECDC4
    style F fill:#FFD700
```

**ä¸»ä»å¤åˆ¶é…ç½®**ï¼š

```sql
-- 1. ä¸»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
wal_level = replica
max_wal_senders = 10
wal_keep_size = 1GB
hot_standby = on

-- 2. ä¸»åº“é…ç½®ï¼ˆpg_hba.confï¼‰
host replication replicator 192.168.1.0/24 md5

-- 3. åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER replicator WITH REPLICATION PASSWORD 'replicator_password';

-- 4. ä»åº“é…ç½®ï¼ˆpostgresql.confï¼‰
hot_standby = on
max_standby_streaming_delay = 30s

-- 5. ä»åº“é…ç½®ï¼ˆrecovery.conf æˆ– postgresql.confï¼‰
primary_conninfo = 'host=192.168.1.10 port=5432 user=replicator password=replicator_password'
primary_slot_name = 'standby_slot'

-- 6. åˆ›å»ºå¤åˆ¶æ§½ï¼ˆä¸»åº“ï¼‰
SELECT pg_create_physical_replication_slot('standby_slot');

-- 7. æŸ¥çœ‹å¤åˆ¶çŠ¶æ€ï¼ˆä¸»åº“ï¼‰
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS lag_bytes
FROM pg_stat_replication;
```

**ä¸»ä»å¤åˆ¶æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼ˆå…³é”®æ•°æ®ï¼‰
-- ä¸»åº“é…ç½®
synchronous_standby_names = 'FIRST 2 (standby1, standby2)'

-- âœ… å¥½ï¼šç›‘æ§å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn) AS write_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn) AS flush_lag_bytes
FROM pg_stat_replication;

-- âœ… å¥½ï¼šè®¾ç½®åˆç†çš„ WAL ä¿ç•™å¤§å°
wal_keep_size = 1GB  -- æ ¹æ®ç½‘ç»œå»¶è¿Ÿå’Œä»åº“æ•°é‡è°ƒæ•´

-- âŒ ä¸å¥½ï¼šå¿½ç•¥å¤åˆ¶å»¶è¿Ÿç›‘æ§ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰
-- âŒ ä¸å¥½ï¼šWAL ä¿ç•™å¤ªå°ï¼ˆå¯èƒ½å¯¼è‡´ä»åº“æ— æ³•åŒæ­¥ï¼‰
```

### 2.2 Patroni é«˜å¯ç”¨æ¶æ„

```yaml
# Patroni é…ç½®ç¤ºä¾‹
scope: postgres-cluster
namespace: /db/
name: postgres-node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.10:8008

etcd3:
  hosts: 192.168.1.20:2379,192.168.1.21:2379,192.168.1.22:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
  initdb:
    - encoding: UTF8
    - locale: en_US.UTF-8
  pg_hba:
    - host replication replicator 0.0.0.0/0 md5
    - host all all 0.0.0.0/0 md5
  users:
    admin:
      password: admin
      options:
        - createrole
        - createdb

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.1.10:5432
  data_dir: /var/lib/postgresql/17/main
  pgpass: /var/lib/postgresql/.pgpass
  authentication:
    replication:
      username: replicator
      password: replicator
    superuser:
      username: postgres
      password: postgres
  parameters:
    max_connections: 200
    shared_buffers: 2GB
    wal_level: replica
    hot_standby: on
```

### 2.3 é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¯ç”¨æ€§ | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|------|---------|
| **æµå¤åˆ¶** | 99.9% | ä½ | ä½ | ä¸­å°è§„æ¨¡ |
| **Patroni** | 99.99% | ä¸­ | ä¸­ | ä¸­å¤§è§„æ¨¡ |
| **PgPool-II** | 99.9% | ä¸­ | ä½ | è¯»å†™åˆ†ç¦» |
| **äº‘æ‰˜ç®¡** | 99.99% | ä½ | é«˜ | äº‘ç¯å¢ƒ |

---

## 3. è¯»å†™åˆ†ç¦»æ¶æ„

### 3.1 è¯»å†™åˆ†ç¦»æ¶æ„

**è¯»å†™åˆ†ç¦»æ¶æ„æ¦‚è¿°**ï¼š

è¯»å†™åˆ†ç¦»æ¶æ„é€šè¿‡ä¸­é—´ä»¶å°†å†™è¯·æ±‚è·¯ç”±åˆ°ä¸»åº“ï¼Œè¯»è¯·æ±‚è·¯ç”±åˆ°ä»åº“ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

**è¯»å†™åˆ†ç¦»æ¶æ„æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[åº”ç”¨] -->|SQLè¯·æ±‚| B[è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶]
    B -->|å†™è¯·æ±‚| C[ä¸»åº“ Primary]
    B -->|è¯»è¯·æ±‚| D[ä»åº“1 Standby]
    B -->|è¯»è¯·æ±‚| E[ä»åº“2 Standby]
    B -->|è¯»è¯·æ±‚| F[ä»åº“3 Standby]
    C -->|æµå¤åˆ¶| D
    C -->|æµå¤åˆ¶| E
    C -->|æµå¤åˆ¶| F

    style B fill:#FFD700
    style C fill:#FF6B6B
    style D fill:#4ECDC4
    style E fill:#4ECDC4
    style F fill:#4ECDC4
```

**è¯»å†™åˆ†ç¦»é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- 1. åº”ç”¨å±‚è¯»å†™åˆ†ç¦»ï¼ˆæ¨èï¼‰
-- Python SQLAlchemy ç¤ºä¾‹
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# ä¸»åº“ï¼ˆå†™ï¼‰
primary_engine = create_engine(
    'postgresql://user:password@primary_host:5432/dbname',
    pool_size=20,
    max_overflow=10
)

# ä»åº“ï¼ˆè¯»ï¼‰
replica_engine = create_engine(
    'postgresql://user:password@replica_host:5432/dbname',
    pool_size=20,
    max_overflow=10
)

# è¯»å†™åˆ†ç¦»è·¯ç”±
class ReadWriteRouter:
    def get_engine(self, is_write=False):
        return primary_engine if is_write else replica_engine

# ä½¿ç”¨ç¤ºä¾‹
router = ReadWriteRouter()

# å†™æ“ä½œ
write_session = sessionmaker(bind=router.get_engine(is_write=True))()
write_session.execute("INSERT INTO orders (customer_id, amount) VALUES (1, 100)")

# è¯»æ“ä½œ
read_session = sessionmaker(bind=router.get_engine(is_write=False))()
result = read_session.execute("SELECT * FROM orders WHERE customer_id = 1")
```

**è¯»å†™åˆ†ç¦»æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½ï¼šä½¿ç”¨è¿æ¥æ± ï¼ˆæå‡æ€§èƒ½ï¼‰
-- ä¸»åº“è¿æ¥æ± 
max_connections = 200
pool_size = 20

-- âœ… å¥½ï¼šè¯»è¯·æ±‚è´Ÿè½½å‡è¡¡ï¼ˆå¤šä¸ªä»åº“ï¼‰
-- åº”ç”¨å±‚è½®è¯¢æˆ–éšæœºé€‰æ‹©ä»åº“
replica_hosts = ['replica1', 'replica2', 'replica3']

-- âœ… å¥½ï¼šç›‘æ§è¯»å†™åˆ†ç¦»æ•ˆæœ
SELECT
    datname,
    numbackends,
    xact_commit,
    xact_rollback
FROM pg_stat_database
WHERE datname = current_database();

-- âŒ ä¸å¥½ï¼šå†™è¯·æ±‚è·¯ç”±åˆ°ä»åº“ï¼ˆä¼šå¯¼è‡´é”™è¯¯ï¼‰
-- âŒ ä¸å¥½ï¼šå¿½ç•¥è¿æ¥æ± é…ç½®ï¼ˆå¯èƒ½å¯¼è‡´è¿æ¥è€—å°½ï¼‰
```

### 3.2 PgPool-II é…ç½®

```conf
# pgpool.conf
listen_addresses = '*'
port = 9999
socket_dir = '/var/run/postgresql'

# ä¸»ä»é…ç½®
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 1
backend_flag0 = 'ALLOW_TO_FAILOVER'

backend_hostname1 = 'standby_host'
backend_port1 = 5432
backend_weight1 = 1
backend_flag1 = 'ALLOW_TO_FAILOVER'

# è´Ÿè½½å‡è¡¡
load_balance_mode = on
master_slave_mode = on
master_slave_sub_mode = 'stream'
```

### 3.3 åº”ç”¨å±‚è¯»å†™åˆ†ç¦»

```python
# Python åº”ç”¨å±‚è¯»å†™åˆ†ç¦»
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# ä¸»åº“ï¼ˆå†™ï¼‰
primary_engine = create_engine(
    'postgresql://user:password@primary_host:5432/dbname'
)

# ä»åº“ï¼ˆè¯»ï¼‰
replica_engine = create_engine(
    'postgresql://user:password@replica_host:5432/dbname'
)

# è¯»å†™åˆ†ç¦»è·¯ç”±
class ReadWriteRouter:
    def get_engine(self, is_write=False):
        return primary_engine if is_write else replica_engine

# ä½¿ç”¨ç¤ºä¾‹
router = ReadWriteRouter()

# å†™æ“ä½œ
write_session = sessionmaker(bind=router.get_engine(is_write=True))()

# è¯»æ“ä½œ
read_session = sessionmaker(bind=router.get_engine(is_write=False))()
```

---

## 4. åˆ†åº“åˆ†è¡¨æ¶æ„

### 4.1 å‚ç›´åˆ†åº“

**å‚ç›´åˆ†åº“æ¦‚è¿°**ï¼š

å‚ç›´åˆ†åº“æŒ‰ç…§ä¸šåŠ¡æ¨¡å—å°†æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ï¼Œå‡å°‘å•åº“å‹åŠ›ï¼Œæå‡ç³»ç»Ÿå¯æ‰©å±•æ€§ã€‚

**å‚ç›´åˆ†åº“æ¶æ„å›¾**ï¼š

```mermaid
flowchart TD
    A[åº”ç”¨] --> B[ç”¨æˆ·åº“ user_db]
    A --> C[è®¢å•åº“ order_db]
    A --> D[å•†å“åº“ product_db]
    B --> E[ç”¨æˆ·è¡¨ users]
    B --> F[ç”¨æˆ·ä¿¡æ¯è¡¨ user_profiles]
    C --> G[è®¢å•è¡¨ orders]
    C --> H[è®¢å•è¯¦æƒ…è¡¨ order_items]
    D --> I[å•†å“è¡¨ products]
    D --> J[å•†å“åˆ†ç±»è¡¨ categories]

    style A fill:#FFD700
    style B fill:#4ECDC4
    style C fill:#4ECDC4
    style D fill:#4ECDC4
```

**å‚ç›´åˆ†åº“é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- 1. åˆ›å»ºç”¨æˆ·åº“
CREATE DATABASE user_db;

-- 2. åˆ›å»ºè®¢å•åº“
CREATE DATABASE order_db;

-- 3. åˆ›å»ºå•†å“åº“
CREATE DATABASE product_db;

-- 4. ç”¨æˆ·åº“è¡¨ç»“æ„
\c user_db
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    full_name VARCHAR(100),
    phone VARCHAR(20),
    address TEXT
);

-- 5. è®¢å•åº“è¡¨ç»“æ„
\c order_db
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,  -- å¼•ç”¨ç”¨æˆ·åº“çš„ç”¨æˆ·ID
    total_amount DECIMAL(10,2),
    status VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER NOT NULL,  -- å¼•ç”¨å•†å“åº“çš„å•†å“ID
    quantity INTEGER,
    price DECIMAL(10,2)
);

-- 6. å•†å“åº“è¡¨ç»“æ„
\c product_db
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2),
    stock INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    parent_id INTEGER REFERENCES categories(id)
);
```

**å‚ç›´åˆ†åº“æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†ï¼ˆå‡å°‘è·¨åº“æŸ¥è¯¢ï¼‰
-- ç”¨æˆ·ç›¸å…³æŸ¥è¯¢ â†’ user_db
-- è®¢å•ç›¸å…³æŸ¥è¯¢ â†’ order_db
-- å•†å“ç›¸å…³æŸ¥è¯¢ â†’ product_db

-- âœ… å¥½ï¼šä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
-- ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰æˆ– Saga æ¨¡å¼

-- âŒ ä¸å¥½ï¼šé¢‘ç¹è·¨åº“æŸ¥è¯¢ï¼ˆæ€§èƒ½å·®ï¼‰
-- âŒ ä¸å¥½ï¼šå¿½ç•¥äº‹åŠ¡ä¸€è‡´æ€§ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰
```

### 4.2 æ°´å¹³åˆ†è¡¨

**æ°´å¹³åˆ†è¡¨æ¦‚è¿°**ï¼š

æ°´å¹³åˆ†è¡¨æŒ‰ç…§åˆ†ç‰‡é”®å°†æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ï¼Œå‡å°‘å•è¡¨æ•°æ®é‡ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚

**æ°´å¹³åˆ†è¡¨æ¶æ„å›¾**ï¼š

```mermaid
flowchart TD
    A[åº”ç”¨] --> B[åˆ†è¡¨è·¯ç”±]
    B -->|user_id % 10 = 0| C[orders_0]
    B -->|user_id % 10 = 1| D[orders_1]
    B -->|user_id % 10 = 2| E[orders_2]
    B -->|user_id % 10 = 9| F[orders_9]

    style B fill:#FFD700
    style C fill:#4ECDC4
    style D fill:#4ECDC4
    style E fill:#4ECDC4
    style F fill:#4ECDC4
```

**æ°´å¹³åˆ†è¡¨é…ç½®ç¤ºä¾‹**ï¼š

```sql
-- 1. åˆ›å»ºåˆ†è¡¨ï¼ˆæŒ‰ç”¨æˆ·IDå–æ¨¡åˆ†10å¼ è¡¨ï¼‰
CREATE TABLE orders_0 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_1 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_2 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_3 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_4 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_5 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_6 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_7 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_8 (LIKE orders INCLUDING ALL);
CREATE TABLE orders_9 (LIKE orders INCLUDING ALL);

-- 2. åˆ†è¡¨è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_order_table(user_id INTEGER)
RETURNS TEXT
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    RETURN 'orders_' || (user_id % 10);
END;
$$;

-- 3. æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†è¡¨ï¼‰
CREATE OR REPLACE FUNCTION insert_order(
    p_user_id INTEGER,
    p_total_amount DECIMAL,
    p_status VARCHAR
)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_table_name TEXT;
    v_order_id INTEGER;
BEGIN
    v_table_name := get_order_table(p_user_id);
    EXECUTE format(
        'INSERT INTO %I (user_id, total_amount, status) VALUES ($1, $2, $3) RETURNING id',
        v_table_name
    ) USING p_user_id, p_total_amount, p_status INTO v_order_id;
    RETURN v_order_id;
END;
$$;

-- 4. æŸ¥è¯¢æ•°æ®ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†è¡¨ï¼‰
CREATE OR REPLACE FUNCTION get_orders_by_user(p_user_id INTEGER)
RETURNS TABLE (
    id INTEGER,
    user_id INTEGER,
    total_amount DECIMAL,
    status VARCHAR,
    created_at TIMESTAMP
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_table_name TEXT;
BEGIN
    v_table_name := get_order_table(p_user_id);
    RETURN QUERY EXECUTE format(
        'SELECT id, user_id, total_amount, status, created_at FROM %I WHERE user_id = $1',
        v_table_name
    ) USING p_user_id;
END;
$$;

-- 5. ä½¿ç”¨ç¤ºä¾‹
SELECT insert_order(123, 100.00, 'pending');
SELECT * FROM get_orders_by_user(123);
```

**æ°´å¹³åˆ†è¡¨æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½ï¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰
-- ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºåˆ†ç‰‡é”®ï¼ˆåˆ†å¸ƒå‡åŒ€ï¼‰

-- âœ… å¥½ï¼šé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼ˆæ€§èƒ½å·®ï¼‰
-- æŸ¥è¯¢æ—¶å¸¦ä¸Šåˆ†ç‰‡é”®æ¡ä»¶

-- âœ… å¥½ï¼šä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆPostgreSQL åŸç”Ÿæ”¯æŒï¼‰
CREATE TABLE orders (
    id SERIAL,
    user_id INTEGER,
    total_amount DECIMAL,
    created_at TIMESTAMP
) PARTITION BY HASH (user_id);

CREATE TABLE orders_0 PARTITION OF orders FOR VALUES WITH (MODULUS 10, REMAINDER 0);
CREATE TABLE orders_1 PARTITION OF orders FOR VALUES WITH (MODULUS 10, REMAINDER 1);
-- ... å…¶ä»–åˆ†åŒº

-- âŒ ä¸å¥½ï¼šåˆ†ç‰‡é”®é€‰æ‹©ä¸å½“ï¼ˆæ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼‰
-- âŒ ä¸å¥½ï¼šé¢‘ç¹è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼ˆæ€§èƒ½å·®ï¼‰
```

### 4.3 åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶

```yaml
# ShardingSphere é…ç½®ç¤ºä¾‹
dataSources:
  ds0:
    url: jdbc:postgresql://host1:5432/db0
  ds1:
    url: jdbc:postgresql://host2:5432/db1

rules:
  - !SHARDING
    tables:
      orders:
        actualDataNodes: ds$->{0..1}.orders_$->{0..9}
        tableStrategy:
          standard:
            shardingColumn: user_id
            shardingAlgorithmName: mod_10
    shardingAlgorithms:
      mod_10:
        type: MOD
        props:
          sharding-count: 10
```

---

## 5. ç¼“å­˜æ¶æ„

### 5.1 å¤šçº§ç¼“å­˜æ¶æ„

**å¤šçº§ç¼“å­˜æ¶æ„æ¦‚è¿°**ï¼š

å¤šçº§ç¼“å­˜æ¶æ„é€šè¿‡æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰å‡å°‘æ•°æ®åº“è®¿é—®ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

**å¤šçº§ç¼“å­˜æ¶æ„æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[åº”ç”¨è¯·æ±‚] --> B{L1 æœ¬åœ°ç¼“å­˜}
    B -->|å‘½ä¸­| C[è¿”å›æ•°æ®]
    B -->|æœªå‘½ä¸­| D{L2 Redisç¼“å­˜}
    D -->|å‘½ä¸­| E[å†™å…¥L1ç¼“å­˜]
    E --> C
    D -->|æœªå‘½ä¸­| F[æŸ¥è¯¢æ•°æ®åº“]
    F --> G[å†™å…¥L2ç¼“å­˜]
    G --> H[å†™å…¥L1ç¼“å­˜]
    H --> C

    style B fill:#FFD700
    style D fill:#4ECDC4
    style F fill:#FF6B6B
```

**å¤šçº§ç¼“å­˜é…ç½®ç¤ºä¾‹**ï¼š

```python
# Python å¤šçº§ç¼“å­˜ç¤ºä¾‹
import redis
import json
from functools import lru_cache
from typing import Optional

redis_client = redis.Redis(host='localhost', port=6379, db=0)

class MultiLevelCache:
    def __init__(self):
        self.local_cache = {}  # L1 æœ¬åœ°ç¼“å­˜
        self.redis_client = redis_client  # L2 Redisç¼“å­˜

    def get(self, key: str) -> Optional[dict]:
        # 1. å°è¯•ä» L1 ç¼“å­˜è·å–
        if key in self.local_cache:
            return self.local_cache[key]

        # 2. å°è¯•ä» L2 ç¼“å­˜è·å–
        cached = self.redis_client.get(key)
        if cached:
            data = json.loads(cached)
            # å†™å…¥ L1 ç¼“å­˜
            self.local_cache[key] = data
            return data

        # 3. ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿”å› None
        return None

    def set(self, key: str, value: dict, expire: int = 3600):
        # 1. å†™å…¥ L1 ç¼“å­˜
        self.local_cache[key] = value

        # 2. å†™å…¥ L2 ç¼“å­˜
        self.redis_client.setex(
            key,
            expire,
            json.dumps(value)
        )

    def delete(self, key: str):
        # 1. åˆ é™¤ L1 ç¼“å­˜
        if key in self.local_cache:
            del self.local_cache[key]

        # 2. åˆ é™¤ L2 ç¼“å­˜
        self.redis_client.delete(key)

# ä½¿ç”¨ç¤ºä¾‹
cache = MultiLevelCache()

# æŸ¥è¯¢ç”¨æˆ·è®¢å•ï¼ˆå¸¦ç¼“å­˜ï¼‰
def get_user_orders(user_id: int):
    cache_key = f"user_orders:{user_id}"

    # å°è¯•ä»ç¼“å­˜è·å–
    cached = cache.get(cache_key)
    if cached:
        return cached

    # æŸ¥è¯¢æ•°æ®åº“
    orders = query_database(f"SELECT * FROM orders WHERE user_id = {user_id}")

    # å†™å…¥ç¼“å­˜
    cache.set(cache_key, orders, expire=3600)

    return orders
```

**å¤šçº§ç¼“å­˜æœ€ä½³å®è·µ**ï¼š

```python
# âœ… å¥½ï¼šä½¿ç”¨å¤šçº§ç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
# L1 ç¼“å­˜ï¼šçƒ­ç‚¹æ•°æ®ï¼Œå¿«é€Ÿè®¿é—®
# L2 ç¼“å­˜ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›

# âœ… å¥½ï¼šè®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
cache.set("user:123", user_data, expire=3600)  # 1å°æ—¶

# âœ… å¥½ï¼šç¼“å­˜æ›´æ–°ç­–ç•¥ï¼ˆCache-Asideï¼‰
def update_user(user_id: int, user_data: dict):
    # 1. æ›´æ–°æ•°æ®åº“
    update_database(user_id, user_data)

    # 2. åˆ é™¤ç¼“å­˜ï¼ˆä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½ï¼‰
    cache.delete(f"user:{user_id}")

# âŒ ä¸å¥½ï¼šç¼“å­˜ç©¿é€ï¼ˆæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼‰
# è§£å†³ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æˆ–ç¼“å­˜ç©ºå€¼

# âŒ ä¸å¥½ï¼šç¼“å­˜é›ªå´©ï¼ˆå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼‰
# è§£å†³ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
import random
expire = 3600 + random.randint(0, 600)  # 3600-4200ç§’
```

### 5.2 Redis ç¼“å­˜ç­–ç•¥

```python
# Python Redis ç¼“å­˜ç¤ºä¾‹
import redis
import json
from functools import wraps

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cache_result(expire=3600):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            cache_key = f"{func.__name__}:{args}:{kwargs}"

            # å°è¯•ä»ç¼“å­˜è·å–
            cached = redis_client.get(cache_key)
            if cached:
                return json.loads(cached)

            # æ‰§è¡Œå‡½æ•°
            result = func(*args, **kwargs)

            # å†™å…¥ç¼“å­˜
            redis_client.setex(
                cache_key,
                expire,
                json.dumps(result)
            )

            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@cache_result(expire=3600)
def get_user_orders(user_id):
    # æ•°æ®åº“æŸ¥è¯¢
    return db.query("SELECT * FROM orders WHERE user_id = %s", user_id)
```

### 5.3 ç¼“å­˜æ›´æ–°ç­–ç•¥

```sql
-- ç¼“å­˜å¤±æ•ˆç­–ç•¥
-- 1. å†™å…¥æ—¶å¤±æ•ˆ
CREATE OR REPLACE FUNCTION invalidate_cache()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    -- é€šçŸ¥åº”ç”¨å±‚å¤±æ•ˆç¼“å­˜
    PERFORM pg_notify('cache_invalidate', TG_TABLE_NAME || ':' || NEW.id);
    RETURN NEW;
END;
$$;

-- 2. å®šæ—¶åˆ·æ–°
SELECT cron.schedule(
    'refresh-cache',
    '0 * * * *',  -- æ¯å°æ—¶
    'SELECT refresh_materialized_views();'
);
```

---

## 6. ç›‘æ§æ¶æ„

### 6.1 ç›‘æ§ä½“ç³»

```text
PostgreSQL
    â†“
Prometheus (æŒ‡æ ‡æ”¶é›†)
    â†“
Grafana (å¯è§†åŒ–)
    â†“
Alertmanager (å‘Šè­¦)
```

### 6.2 ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheus é…ç½®
scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']
    metrics_path: /metrics
```

### 6.3 å‘Šè­¦è§„åˆ™

```yaml
# Alertmanager è§„åˆ™
groups:
  - name: postgres_alerts
    rules:
      - alert: HighConnections
        expr: pg_stat_database_numbackends > 150
        for: 5m
        annotations:
          summary: "High database connections"

      - alert: SlowQueries
        expr: pg_stat_statements_mean_exec_time > 1000
        for: 5m
        annotations:
          summary: "Slow queries detected"
```

---

## 7. å®é™…æ¡ˆä¾‹

### 7.1 æ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿæ¶æ„

```text
æ¶æ„è®¾è®¡ï¼š
â”œâ”€â”€ æ¥å…¥å±‚
â”‚   â””â”€â”€ Nginx (è´Ÿè½½å‡è¡¡)
â”œâ”€â”€ åº”ç”¨å±‚
â”‚   â”œâ”€â”€ ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ è®¢å•æœåŠ¡
â”‚   â””â”€â”€ å•†å“æœåŠ¡
â”œâ”€â”€ æ•°æ®å±‚
â”‚   â”œâ”€â”€ ä¸»åº“ (å†™)
â”‚   â”œâ”€â”€ ä»åº“ Ã— 3 (è¯»)
â”‚   â””â”€â”€ Redis (ç¼“å­˜)
â””â”€â”€ ç›‘æ§å±‚
    â”œâ”€â”€ Prometheus
    â””â”€â”€ Grafana
```

### 7.2 æ¡ˆä¾‹ï¼šIoT å¹³å°æ¶æ„

```text
æ¶æ„è®¾è®¡ï¼š
â”œâ”€â”€ æ•°æ®é‡‡é›†å±‚
â”‚   â””â”€â”€ MQTT Broker
â”œâ”€â”€ æ•°æ®å¤„ç†å±‚
â”‚   â””â”€â”€ æµå¤„ç†æœåŠ¡
â”œâ”€â”€ æ•°æ®å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ TimescaleDB (æ—¶åºæ•°æ®)
â”‚   â””â”€â”€ PostgreSQL (å…ƒæ•°æ®)
â””â”€â”€ æ•°æ®æœåŠ¡å±‚
    â””â”€â”€ API æœåŠ¡
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå®Œæ•´å‚è€ƒ
  - æµå¤åˆ¶å’Œé€»è¾‘å¤åˆ¶

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¤åˆ¶](https://www.postgresql.org/docs/current/replication.html)**
  - å¤åˆ¶æ–¹æ¡ˆè¯´æ˜
  - å¤åˆ¶é…ç½®æŒ‡å—

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)**
  - ç›‘æ§å·¥å…·å’Œæ–¹æ³•
  - æ€§èƒ½ç›‘æ§æŒ‡å—

- **[PostgreSQL å®˜æ–¹æ–‡æ¡£ - è¿æ¥æ± ](https://www.postgresql.org/docs/current/runtime-config-connection.html)**
  - è¿æ¥æ± é…ç½®
  - è¿æ¥ç®¡ç†æœ€ä½³å®è·µ

### æŠ€æœ¯è®ºæ–‡

- **Kemme, B., & Alonso, G. (2000). "Database Replication: A Tale of Research across Communities."**
  - ä¼šè®®: VLDB 2000
  - **é‡è¦æ€§**: æ•°æ®åº“å¤åˆ¶æŠ€æœ¯çš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°æ€»ç»“äº†æ•°æ®åº“å¤åˆ¶çš„å„ç§æ–¹æ³•å’ŒæŒ‘æˆ˜

- **Bernstein, P. A., et al. (1987). "Concurrency Control and Recovery in Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: æ•°æ®åº“å¹¶å‘æ§åˆ¶å’Œæ¢å¤çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†é˜è¿°äº†æ•°æ®åº“å¤åˆ¶å’Œæ•…éšœæ¢å¤çš„ç†è®ºåŸºç¡€

- **Stonebraker, M., et al. (2011). "The VoltDB Main Memory DBMS."**
  - ä¼šè®®: ICDE 2011
  - **é‡è¦æ€§**: åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡çš„åŸºç¡€ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†åˆ†å¸ƒå¼æ•°æ®åº“çš„æ¶æ„è®¾è®¡ï¼Œä¸ºé«˜å¯ç”¨æ¶æ„æä¾›äº†ç†è®ºåŸºç¡€

### æŠ€æœ¯åšå®¢

- **[PostgreSQL å®˜æ–¹åšå®¢ - é«˜å¯ç”¨](https://www.postgresql.org/docs/current/high-availability.html)**
  - é«˜å¯ç”¨æ–¹æ¡ˆè¯¦è§£
  - é«˜å¯ç”¨æœ€ä½³å®è·µ

- **[2ndQuadrant - PostgreSQL é«˜å¯ç”¨æ–¹æ¡ˆ](https://www.2ndquadrant.com/en/blog/postgresql-high-availability/)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå®æˆ˜
  - æ•…éšœè½¬ç§»æ¡ˆä¾‹

- **[Percona - PostgreSQL æ¶æ„è®¾è®¡](https://www.percona.com/blog/postgresql-architecture-design/)**
  - æ¶æ„è®¾è®¡æœ€ä½³å®è·µ
  - é«˜å¯ç”¨æ¶æ„æ¡ˆä¾‹

- **[EnterpriseDB - PostgreSQL æ¶æ„è®¾è®¡](https://www.enterprisedb.com/postgres-tutorials/postgresql-architecture-design)**
  - æ¶æ„è®¾è®¡æ·±å…¥è§£æ
  - å¯æ‰©å±•æ¶æ„è®¾è®¡æŒ‡å—

### ç¤¾åŒºèµ„æº

- **[PostgreSQL Wiki - High Availability](https://wiki.postgresql.org/wiki/High_Availability)**
  - é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”
  - é«˜å¯ç”¨å·¥å…·æ¨è

- **[PostgreSQL Wiki - Replication](https://wiki.postgresql.org/wiki/Replication)**
  - å¤åˆ¶æ–¹æ¡ˆè¯´æ˜
  - å¤åˆ¶é…ç½®æŒ‡å—

- **[Stack Overflow - PostgreSQL Architecture](https://stackoverflow.com/questions/tagged/postgresql+architecture)**
  - æ¶æ„è®¾è®¡ç›¸å…³é—®é¢˜è§£ç­”
  - å®é™…åº”ç”¨æ¡ˆä¾‹

- **[Patroni å®˜æ–¹æ–‡æ¡£](https://patroni.readthedocs.io/)**
  - Patroni é«˜å¯ç”¨å·¥å…·æ–‡æ¡£
  - è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®

## ğŸ“Š æ€»ç»“

PostgreSQL ç³»ç»Ÿæ¶æ„è®¾è®¡éœ€è¦ç»¼åˆè€ƒè™‘é«˜å¯ç”¨ã€æ€§èƒ½ã€å¯æ‰©å±•æ€§ã€å®‰å…¨æ€§ç­‰å¤šä¸ªæ–¹é¢ã€‚
é€šè¿‡åˆç†ä½¿ç”¨é«˜å¯ç”¨æ¶æ„ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ç¼“å­˜ç­–ç•¥ç­‰æ–¹æ³•ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ„å»ºç¨³å®šã€é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç³»ç»Ÿæ¶æ„ã€‚
å»ºè®®éµå¾ªæ¶æ„è®¾è®¡åŸåˆ™ï¼Œæ ¹æ®å®é™…åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¶æ„æ¨¡å¼ï¼Œå¹¶å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»ã€‚

---

## 8. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 8.1 æ¶æ„è®¾è®¡åŸºç¡€å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•è®¾è®¡é«˜å¯ç”¨æ¶æ„ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šä¸çŸ¥é“å¦‚ä½•è®¾è®¡é«˜å¯ç”¨æ¶æ„ã€‚

**è®¾è®¡æ–¹æ³•**ï¼š

1. **ä¸»ä»å¤åˆ¶æ¶æ„**ï¼š

    ```sql
    -- âœ… å¥½ï¼šé…ç½®ä¸»ä»å¤åˆ¶
    -- ä¸»åº“é…ç½®
    ALTER SYSTEM SET synchronous_standby_names = 'ANY 1 (standby1)';
    SELECT pg_reload_conf();
    -- é…ç½®åŒæ­¥å¤åˆ¶ï¼Œé›¶æ•°æ®ä¸¢å¤±
    ```

2. **ä½¿ç”¨Patroni**ï¼š

    ```yaml
    # âœ… å¥½ï¼šä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: patroni-config
    data:
      patroni.yml: |
        scope: postgres
        name: postgresql1
        restapi:
          listen: 0.0.0.0:8008
        etcd:
          host: etcd:2379
    # ä½¿ç”¨Patroniå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
    ```

3. **å¤šåŒºåŸŸéƒ¨ç½²**ï¼š

    ```yaml
    # âœ… å¥½ï¼šå¤šåŒºåŸŸéƒ¨ç½²
    spec:
      replicas: 3
      template:
        spec:
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - postgresql
                  topologyKey: kubernetes.io/hostname
    # è·¨èŠ‚ç‚¹éƒ¨ç½²ï¼Œæé«˜å¯ç”¨æ€§
    ```

**æœ€ä½³å®è·µ**ï¼š

- **å¤šå‰¯æœ¬**ï¼šé…ç½®è‡³å°‘3ä¸ªå‰¯æœ¬
- **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šä½¿ç”¨Patroniç­‰å·¥å…·
- **è·¨åŒºåŸŸéƒ¨ç½²**ï¼šè·¨åŒºåŸŸéƒ¨ç½²æé«˜å¯ç”¨æ€§

#### Q2: å¦‚ä½•å®ç°è¯»å†™åˆ†ç¦»ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°è¯»å†™åˆ†ç¦»ï¼Œæå‡æ€§èƒ½ã€‚

**å®ç°æ–¹æ³•**ï¼š

1. **é…ç½®åªè¯»å‰¯æœ¬**ï¼š

    ```sql
    -- âœ… å¥½ï¼šé…ç½®åªè¯»å‰¯æœ¬
    -- ä»åº“é…ç½®
    ALTER SYSTEM SET hot_standby = on;
    SELECT pg_reload_conf();
    -- å¯ç”¨çƒ­å¤‡ï¼Œæ”¯æŒåªè¯»æŸ¥è¯¢
    ```

2. **ä½¿ç”¨è¿æ¥æ± **ï¼š

    ```yaml
    # âœ… å¥½ï¼šä½¿ç”¨PgPool-IIå®ç°è¯»å†™åˆ†ç¦»
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: pgpool
    spec:
      template:
        spec:
          containers:
          - name: pgpool
            image: pgpool/pgpool
            env:
            - name: PGPOOL_BACKEND_HOSTNAME0
              value: "postgresql-primary"
            - name: PGPOOL_BACKEND_HOSTNAME1
              value: "postgresql-replica"
    # ä½¿ç”¨PgPool-IIå®ç°è¯»å†™åˆ†ç¦»
    ```

3. **åº”ç”¨å±‚è·¯ç”±**ï¼š

    ```python
    # âœ… å¥½ï¼šåº”ç”¨å±‚è·¯ç”±
    def get_db_connection(read_only=False):
        if read_only:
            return connect_to_replica()
        else:
            return connect_to_primary()
    # æ ¹æ®æ“ä½œç±»å‹é€‰æ‹©è¿æ¥
    ```

**æ€§èƒ½æ•°æ®**ï¼š

- å•åº“ï¼šæŸ¥è¯¢æ€§èƒ½ 1000 QPS
- è¯»å†™åˆ†ç¦»ï¼šæŸ¥è¯¢æ€§èƒ½ 3000 QPS
- **æ€§èƒ½æå‡ï¼š3å€**

### 8.2 æ‰©å±•æ€§è®¾è®¡å¸¸è§é—®é¢˜

#### Q3: å¦‚ä½•å®ç°æ°´å¹³æ‰©å±•ï¼Ÿ

**é—®é¢˜æè¿°**ï¼šéœ€è¦å®ç°æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒæ›´å¤§æ•°æ®é‡ã€‚

**å®ç°æ–¹æ³•**ï¼š

1. **ä½¿ç”¨Citusåˆ†ç‰‡**ï¼š

    ```sql
    -- âœ… å¥½ï¼šä½¿ç”¨Citusåˆ†ç‰‡
    CREATE TABLE distributed_table (
        id BIGSERIAL,
        data TEXT
    );
    SELECT create_distributed_table('distributed_table', 'id');
    -- æŒ‰idåˆ†ç‰‡ï¼Œå®ç°æ°´å¹³æ‰©å±•
    ```

2. **ä½¿ç”¨åˆ†åŒºè¡¨**ï¼š

    ```sql
    -- âœ… å¥½ï¼šä½¿ç”¨åˆ†åŒºè¡¨
    CREATE TABLE partitioned_table (
        id SERIAL,
        created_at TIMESTAMP NOT NULL,
        data TEXT
    ) PARTITION BY RANGE (created_at);
    -- æŒ‰æ—¶é—´åˆ†åŒºï¼Œå®ç°æ°´å¹³æ‰©å±•
    ```

3. **ä½¿ç”¨TimescaleDB**ï¼š

    ```sql
    -- âœ… å¥½ï¼šä½¿ç”¨TimescaleDB
    CREATE TABLE sensor_data (
        time TIMESTAMPTZ NOT NULL,
        sensor_id INTEGER,
        value DOUBLE PRECISION
    );
    SELECT create_hypertable('sensor_data', 'time');
    -- è‡ªåŠ¨åˆ†åŒºï¼Œå®ç°æ°´å¹³æ‰©å±•
    ```

**æœ€ä½³å®è·µ**ï¼š

- **é€‰æ‹©åˆ†ç‰‡é”®**ï¼šé€‰æ‹©é«˜åŸºæ•°çš„åˆ—ä½œä¸ºåˆ†ç‰‡é”®
- **åˆ†åŒºç­–ç•¥**ï¼šæ ¹æ®æ•°æ®ç‰¹å¾é€‰æ‹©åˆ†åŒºç­–ç•¥
- **ç›‘æ§åˆ†ç‰‡**ï¼šç›‘æ§åˆ†ç‰‡çŠ¶æ€å’Œæ€§èƒ½

## ğŸ“š å‚è€ƒèµ„æ–™1

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-TREND-32
