# å¤šæ¨¡å‹èåˆæŸ¥è¯¢å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¶é—´**: 2025 å¹´ 12 æœˆ 4 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 04-QUERY-MULTIMODEL

---

## ğŸ“‘ ç›®å½•

- [å¤šæ¨¡å‹èåˆæŸ¥è¯¢å®Œæ•´æŒ‡å—](#å¤šæ¨¡å‹èåˆæŸ¥è¯¢å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯å¤šæ¨¡å‹èåˆæŸ¥è¯¢](#11-ä»€ä¹ˆæ˜¯å¤šæ¨¡å‹èåˆæŸ¥è¯¢)
    - [1.2 PostgreSQLçš„å¤šæ¨¡å‹èƒ½åŠ›](#12-postgresqlçš„å¤šæ¨¡å‹èƒ½åŠ›)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
    - [1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#14-çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
  - [äºŒã€åŸç†ä¸ç†è®º](#äºŒåŸç†ä¸ç†è®º)
    - [2.1 å¤šæ¨¡å‹æ•°æ®åº“ç†è®º](#21-å¤šæ¨¡å‹æ•°æ®åº“ç†è®º)
      - [**å¤šæ¨¡å‹æ•°æ®åº“å®šä¹‰**](#å¤šæ¨¡å‹æ•°æ®åº“å®šä¹‰)
      - [**PostgreSQLçš„ä¼˜åŠ¿**](#postgresqlçš„ä¼˜åŠ¿)
    - [2.2 æ•°æ®æ¨¡å‹æ˜ å°„](#22-æ•°æ®æ¨¡å‹æ˜ å°„)
      - [**å…³ç³»å‹ â†” æ–‡æ¡£å‹**](#å…³ç³»å‹--æ–‡æ¡£å‹)
      - [**å…³ç³»å‹ â†” å›¾**](#å…³ç³»å‹--å›¾)
      - [**å…³ç³»å‹ â†” å‘é‡**](#å…³ç³»å‹--å‘é‡)
    - [2.3 æŸ¥è¯¢ä¼˜åŒ–å™¨æ‰©å±•](#23-æŸ¥è¯¢ä¼˜åŒ–å™¨æ‰©å±•)
      - [**å¤šæ¨¡å‹æŸ¥è¯¢è®¡åˆ’**](#å¤šæ¨¡å‹æŸ¥è¯¢è®¡åˆ’)
      - [**ç´¢å¼•é€‰æ‹©ç­–ç•¥**](#ç´¢å¼•é€‰æ‹©ç­–ç•¥)
    - [2.4 ä¸€è‡´æ€§ä¿è¯](#24-ä¸€è‡´æ€§ä¿è¯)
      - [**è·¨æ¨¡å‹ACIDäº‹åŠ¡**](#è·¨æ¨¡å‹acidäº‹åŠ¡)
  - [ä¸‰ã€æ¶æ„è®¾è®¡](#ä¸‰æ¶æ„è®¾è®¡)
    - [3.1 æ•´ä½“æ¶æ„](#31-æ•´ä½“æ¶æ„)
    - [3.2 å…³ç³»å‹ + æ–‡æ¡£èåˆ](#32-å…³ç³»å‹--æ–‡æ¡£èåˆ)
    - [3.3 å…³ç³»å‹ + å›¾èåˆ](#33-å…³ç³»å‹--å›¾èåˆ)
    - [3.4 å…³ç³»å‹ + å‘é‡èåˆ](#34-å…³ç³»å‹--å‘é‡èåˆ)
    - [3.5 å¤šæ¨¡å‹ç»Ÿä¸€æŸ¥è¯¢](#35-å¤šæ¨¡å‹ç»Ÿä¸€æŸ¥è¯¢)
  - [å››ã€ç¨‹åºè®¾è®¡](#å››ç¨‹åºè®¾è®¡)
    - [4.1 ç¯å¢ƒå‡†å¤‡](#41-ç¯å¢ƒå‡†å¤‡)
    - [4.2 å…³ç³» + JSONèåˆæŸ¥è¯¢](#42-å…³ç³»--jsonèåˆæŸ¥è¯¢)
    - [4.3 å…³ç³» + å›¾èåˆæŸ¥è¯¢](#43-å…³ç³»--å›¾èåˆæŸ¥è¯¢)
    - [4.4 å…³ç³» + å‘é‡èåˆæŸ¥è¯¢](#44-å…³ç³»--å‘é‡èåˆæŸ¥è¯¢)
    - [4.5 å››æ¨¡å‹èåˆæŸ¥è¯¢](#45-å››æ¨¡å‹èåˆæŸ¥è¯¢)
  - [äº”ã€è¿ç»´ç®¡ç†](#äº”è¿ç»´ç®¡ç†)
    - [5.1 ç´¢å¼•ååŒä¼˜åŒ–](#51-ç´¢å¼•ååŒä¼˜åŒ–)
    - [5.2 æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#52-æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
    - [5.3 äº‹åŠ¡ä¸€è‡´æ€§](#53-äº‹åŠ¡ä¸€è‡´æ€§)
    - [5.4 æœ€ä½³å®è·µ](#54-æœ€ä½³å®è·µ)
  - [å…­ã€æ¡ˆä¾‹å®æˆ˜](#å…­æ¡ˆä¾‹å®æˆ˜)
    - [6.1 ç¤¾äº¤ç½‘ç»œåˆ†æ](#61-ç¤¾äº¤ç½‘ç»œåˆ†æ)
    - [6.2 æ™ºèƒ½æœç´¢å¼•æ“](#62-æ™ºèƒ½æœç´¢å¼•æ“)
    - [6.3 çŸ¥è¯†å›¾è°±åº”ç”¨](#63-çŸ¥è¯†å›¾è°±åº”ç”¨)
    - [6.4 å®æ—¶åˆ†æå¹³å°](#64-å®æ—¶åˆ†æå¹³å°)
  - [ä¸ƒã€æ€§èƒ½æµ‹è¯•](#ä¸ƒæ€§èƒ½æµ‹è¯•)
  - [å…«ã€æ€»ç»“ä¸å±•æœ›](#å…«æ€»ç»“ä¸å±•æœ›)
    - [æ ¸å¿ƒæ”¶è·](#æ ¸å¿ƒæ”¶è·)
    - [é€‚ç”¨åœºæ™¯](#é€‚ç”¨åœºæ™¯)
  - [ä¹ã€å‚è€ƒèµ„æ–™](#ä¹å‚è€ƒèµ„æ–™)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å¤šæ¨¡å‹èåˆæŸ¥è¯¢

**å¤šæ¨¡å‹èåˆæŸ¥è¯¢**æ˜¯æŒ‡åœ¨å•ä¸ªæŸ¥è¯¢ä¸­åŒæ—¶æ“ä½œå’Œç»“åˆå¤šç§æ•°æ®æ¨¡å‹ï¼ˆå…³ç³»å‹ã€æ–‡æ¡£ã€å›¾ã€å‘é‡ã€æ—¶åºç­‰ï¼‰ï¼Œå®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å’Œåˆ†æéœ€æ±‚ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- ğŸ”— **ç»Ÿä¸€æŸ¥è¯¢**ï¼šä¸€æ¡SQLå¤„ç†å¤šç§æ•°æ®ç±»å‹
- ğŸ¯ **æ·±åº¦èåˆ**ï¼šä¸æ˜¯ç®€å•æ‹¼æ¥ï¼Œè€Œæ˜¯æœ‰æœºç»“åˆ
- âš¡ **é«˜æ€§èƒ½**ï¼šåˆ©ç”¨ç»Ÿä¸€ä¼˜åŒ–å™¨
- ğŸ›¡ï¸ **ACIDäº‹åŠ¡**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§

**ç¤ºä¾‹**ï¼š

```sql
-- èåˆæŸ¥è¯¢ç¤ºä¾‹ï¼šå…³ç³»å‹ + JSON + å‘é‡ + å…¨æ–‡æœç´¢
SELECT
    u.user_id,
    u.username,
    u.profile->>'bio' AS bio,  -- JSONæå–
    p.title,
    p.content,
    ts_rank(p.search_vector, query) AS relevance,  -- å…¨æ–‡æœç´¢
    1 - (p.embedding <=> query_embedding) AS similarity  -- å‘é‡ç›¸ä¼¼åº¦
FROM users u
JOIN posts p ON u.user_id = p.author_id
WHERE u.profile->>'country' = 'China'  -- JSONè¿‡æ»¤
  AND p.search_vector @@ to_tsquery('postgresql')  -- å…¨æ–‡æœç´¢
  AND p.embedding <=> query_embedding < 0.3  -- å‘é‡è·ç¦»
ORDER BY similarity DESC, relevance DESC
LIMIT 10;
```

### 1.2 PostgreSQLçš„å¤šæ¨¡å‹èƒ½åŠ›

**PostgreSQLæ”¯æŒçš„æ•°æ®æ¨¡å‹**ï¼š

| æ•°æ®æ¨¡å‹ | å®ç°æ–¹å¼ | æ‰©å±• | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|---------|
| **å…³ç³»å‹** | åŸç”Ÿæ”¯æŒ | - | ç»“æ„åŒ–æ•°æ®ã€OLTP |
| **æ–‡æ¡£å‹** | JSON/JSONB | - | åŠç»“æ„åŒ–æ•°æ®ã€çµæ´»schema |
| **å›¾æ•°æ®åº“** | é€’å½’CTE | Apache AGE | ç¤¾äº¤ç½‘ç»œã€çŸ¥è¯†å›¾è°± |
| **å‘é‡æ•°æ®åº“** | vectorç±»å‹ | pgvector | AI/MLã€è¯­ä¹‰æœç´¢ |
| **æ—¶åºæ•°æ®åº“** | åˆ†åŒºè¡¨ | TimescaleDB | IoTã€ç›‘æ§ã€é‡‘è |
| **é”®å€¼å­˜å‚¨** | hstore | - | é…ç½®ã€æ ‡ç­¾ |
| **å…¨æ–‡æœç´¢** | tsvector | - | æ–‡æœ¬æ£€ç´¢ |
| **æ•°ç»„** | arrayç±»å‹ | - | é›†åˆæ“ä½œ |
| **èŒƒå›´** | rangeç±»å‹ | - | æ—¶é—´æ®µã€ä»·æ ¼åŒºé—´ |
| **ç©ºé—´** | geometry | PostGIS | GISã€ä½ç½®æœåŠ¡ |

### 1.3 æ ¸å¿ƒä»·å€¼

**æŠ€æœ¯ä»·å€¼**ï¼š

- ğŸ¯ **ç»Ÿä¸€å¹³å°**ï¼šä¸€ä¸ªæ•°æ®åº“æ”¯æŒæ‰€æœ‰æ•°æ®æ¨¡å‹
- âš¡ **é«˜æ€§èƒ½**ï¼šé¿å…è·¨ç³»ç»Ÿæ•°æ®ä¼ è¾“
- ğŸ” **äº‹åŠ¡æ”¯æŒ**ï¼šè·¨æ¨¡å‹ACIDä¿è¯
- ğŸ“Š **æ·±åº¦é›†æˆ**ï¼šæ¨¡å‹é—´æ— ç¼åä½œ

**ä¸šåŠ¡ä»·å€¼**ï¼š

- ğŸ’° **é™ä½æˆæœ¬**ï¼šå‡å°‘æ•°æ®åº“ç»„ä»¶æ•°é‡
- ğŸš€ **æå‡æ•ˆç‡**ï¼šç®€åŒ–æ¶æ„ï¼ŒåŠ å¿«å¼€å‘
- ğŸ›¡ï¸ **æ•°æ®ä¸€è‡´**ï¼šé¿å…æ•°æ®å­¤å²›
- ğŸ”„ **æ˜“äºç»´æŠ¤**ï¼šç»Ÿä¸€è¿ç»´ä½“ç³»

### 1.4 çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¤šæ¨¡å‹èåˆæŸ¥è¯¢))
    åŸç†ä¸ç†è®º
      å¤šæ¨¡å‹ç†è®º
        æ•°æ®æ¨¡å‹å®šä¹‰
        æ¨¡å‹é—´å…³ç³»
        èåˆæ¨¡å¼
      æ•°æ®æ˜ å°„
        å…³ç³»åˆ°æ–‡æ¡£
        å…³ç³»åˆ°å›¾
        å…³ç³»åˆ°å‘é‡
      æŸ¥è¯¢ä¼˜åŒ–
        å¤šæ¨¡å‹ç´¢å¼•
        æ‰§è¡Œè®¡åˆ’
        æˆæœ¬ä¼°ç®—
      ä¸€è‡´æ€§
        ACIDäº‹åŠ¡
        éš”ç¦»çº§åˆ«
        å¹¶å‘æ§åˆ¶
    æ¶æ„è®¾è®¡
      æ•´ä½“æ¶æ„
        å­˜å‚¨å±‚
        æŸ¥è¯¢å±‚
        ä¼˜åŒ–å±‚
      å…³ç³»+æ–‡æ¡£
        JSONBå­˜å‚¨
        æ··åˆæŸ¥è¯¢
        ç´¢å¼•ç­–ç•¥
      å…³ç³»+å›¾
        é€’å½’CTE
        AGEé›†æˆ
        å›¾éå†
      å…³ç³»+å‘é‡
        pgvector
        æ··åˆæ£€ç´¢
        ç›¸ä¼¼åº¦
      ç»Ÿä¸€æŸ¥è¯¢
        å¤šæ¨¡å‹JOIN
        å¤æ‚è¿‡æ»¤
        èšåˆåˆ†æ
    ç¨‹åºè®¾è®¡
      ç¯å¢ƒé…ç½®
        æ‰©å±•å®‰è£…
        æ•°æ®åº“é…ç½®
        ç´¢å¼•åˆ›å»º
      JSONèåˆ
        JSONBæ“ä½œ
        è·¯å¾„æŸ¥è¯¢
        GINç´¢å¼•
      å›¾èåˆ
        é€’å½’æŸ¥è¯¢
        Cypher
        å›¾ç®—æ³•
      å‘é‡èåˆ
        å‘é‡å­˜å‚¨
        ç›¸ä¼¼åº¦æœç´¢
        HNSWç´¢å¼•
      ç»¼åˆæ¡ˆä¾‹
        ç¤¾äº¤ç½‘ç»œ
        æ™ºèƒ½æœç´¢
        çŸ¥è¯†å›¾è°±
    è¿ç»´ç®¡ç†
      ç´¢å¼•ä¼˜åŒ–
        å¤šç±»å‹ç´¢å¼•
        ååŒä¼˜åŒ–
        ç»´æŠ¤ç­–ç•¥
      æ€§èƒ½ç›‘æ§
        æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢
        èµ„æºä½¿ç”¨
      ä¸€è‡´æ€§ç®¡ç†
        äº‹åŠ¡éš”ç¦»
        é”ç®¡ç†
        å¹¶å‘ä¼˜åŒ–
    æ¡ˆä¾‹å®æˆ˜
      ç¤¾äº¤ç½‘ç»œ
        ç”¨æˆ·å…³ç³»
        å†…å®¹æ¨è
        å½±å“åŠ›åˆ†æ
      æ™ºèƒ½æœç´¢
        è¯­ä¹‰æ£€ç´¢
        æ··åˆæ’åº
        ä¸ªæ€§åŒ–
      çŸ¥è¯†å›¾è°±
        å®ä½“å…³ç³»
        è·¯å¾„æŸ¥è¯¢
        æ¨ç†
      å®æ—¶åˆ†æ
        æ—¶åºæ•°æ®
        èšåˆåˆ†æ
        å‘Šè­¦
```

---

## äºŒã€åŸç†ä¸ç†è®º

### 2.1 å¤šæ¨¡å‹æ•°æ®åº“ç†è®º

#### **å¤šæ¨¡å‹æ•°æ®åº“å®šä¹‰**

**å¤šæ¨¡å‹æ•°æ®åº“**æ˜¯æŒ‡åœ¨å•ä¸€æ•°æ®åº“ç³»ç»Ÿä¸­åŸç”Ÿæ”¯æŒå¤šç§æ•°æ®æ¨¡å‹ï¼Œæä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£å’Œäº‹åŠ¡ä¿è¯ã€‚

**ä¸‰ç§å®ç°æ–¹å¼**ï¼š

1. **åŸç”Ÿå¤šæ¨¡å‹**ï¼ˆPostgreSQLæ–¹å¼ï¼‰
   - âœ… åœ¨æ ¸å¿ƒå¼•æ“ä¸­å®ç°å¤šç§æ•°æ®ç±»å‹
   - âœ… ç»Ÿä¸€çš„æŸ¥è¯¢ä¼˜åŒ–å™¨
   - âœ… å®Œæ•´çš„ACIDäº‹åŠ¡

2. **æ‰©å±•å¤šæ¨¡å‹**ï¼ˆé€šè¿‡æ‰©å±•å®ç°ï¼‰
   - âš ï¸ æ ¸å¿ƒ+ æ‰©å±•çš„ç»„åˆ
   - âš ï¸ å¯èƒ½çš„ä¸€è‡´æ€§é—®é¢˜
   - âš ï¸ æ€§èƒ½å¯èƒ½ä¸å¦‚åŸç”Ÿ

3. **è”é‚¦å¤šæ¨¡å‹**ï¼ˆå¤šä¸ªæ•°æ®åº“è”é‚¦ï¼‰
   - âŒ å¤šä¸ªç‹¬ç«‹ç³»ç»Ÿ
   - âŒ è·¨ç³»ç»Ÿäº‹åŠ¡å¤æ‚
   - âŒ æ€§èƒ½å’Œä¸€è‡´æ€§æŒ‘æˆ˜

#### **PostgreSQLçš„ä¼˜åŠ¿**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PostgreSQL å¤šæ¨¡å‹æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        ç»Ÿä¸€SQLæ¥å£                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        æŸ¥è¯¢è§£æä¸ä¼˜åŒ–å™¨               â”‚        â”‚
â”‚  â”‚  (ç»Ÿä¸€å¤„ç†æ‰€æœ‰æ•°æ®æ¨¡å‹)              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        å­˜å‚¨å¼•æ“                       â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚        â”‚
â”‚  â”‚  â”‚å…³ç³»å‹â”‚  â”‚JSONB â”‚  â”‚Vectorâ”‚      â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚        â”‚
â”‚  â”‚  â”‚æ•°ç»„  â”‚  â”‚å…¨æ–‡  â”‚  â”‚èŒƒå›´  â”‚      â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        MVCCäº‹åŠ¡ç®¡ç†                  â”‚        â”‚
â”‚  â”‚  (è·¨æ‰€æœ‰æ•°æ®æ¨¡å‹çš„ACIDä¿è¯)          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æ¨¡å‹æ˜ å°„

#### **å…³ç³»å‹ â†” æ–‡æ¡£å‹**

```sql
-- 1. å…³ç³»å‹è½¬æ–‡æ¡£å‹ï¼ˆè¡Œè½¬JSONï¼‰
SELECT
    u.user_id,
    jsonb_build_object(
        'id', u.user_id,
        'name', u.username,
        'email', u.email,
        'posts', (
            SELECT jsonb_agg(
                jsonb_build_object(
                    'title', p.title,
                    'content', p.content,
                    'created_at', p.created_at
                )
            )
            FROM posts p
            WHERE p.author_id = u.user_id
        )
    ) AS user_document
FROM users u;

-- 2. æ–‡æ¡£å‹è½¬å…³ç³»å‹ï¼ˆJSONå±•å¼€ï¼‰
CREATE TABLE users_normalized AS
SELECT
    (data->>'id')::int AS user_id,
    data->>'name' AS username,
    data->>'email' AS email
FROM user_documents;
```

#### **å…³ç³»å‹ â†” å›¾**

```sql
-- å…³ç³»è¡¨è½¬å›¾ç»“æ„
-- å…³ç³»è¡¨ï¼šfriends(user_id, friend_id)

-- å›¾æŸ¥è¯¢ï¼šæŸ¥æ‰¾æœ‹å‹çš„æœ‹å‹
WITH RECURSIVE friend_network AS (
    -- åŸºç¡€ï¼šç›´æ¥æœ‹å‹
    SELECT user_id, friend_id, 1 AS degree
    FROM friends
    WHERE user_id = 1

    UNION

    -- é€’å½’ï¼šæœ‹å‹çš„æœ‹å‹
    SELECT f.user_id, f.friend_id, fn.degree + 1
    FROM friends f
    JOIN friend_network fn ON f.user_id = fn.friend_id
    WHERE fn.degree < 3  -- æœ€å¤š3åº¦
)
SELECT * FROM friend_network;
```

#### **å…³ç³»å‹ â†” å‘é‡**

```sql
-- å…³ç³»å‹æ•°æ®è½¬å‘é‡
CREATE TABLE product_embeddings AS
SELECT
    product_id,
    name,
    description,
    -- å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼ˆéœ€è¦å¤–éƒ¨æœåŠ¡æˆ–å‡½æ•°ï¼‰
    generate_embedding(name || ' ' || description) AS embedding
FROM products;

-- å‘é‡æ£€ç´¢ + å…³ç³»å‹è¿‡æ»¤
SELECT
    p.product_id,
    p.name,
    p.price,
    1 - (pe.embedding <=> query_vector) AS similarity
FROM products p
JOIN product_embeddings pe ON p.product_id = pe.product_id
WHERE p.category = 'Electronics'  -- å…³ç³»å‹è¿‡æ»¤
  AND p.price BETWEEN 100 AND 1000  -- å…³ç³»å‹è¿‡æ»¤
  AND pe.embedding <=> query_vector < 0.3  -- å‘é‡è¿‡æ»¤
ORDER BY similarity DESC
LIMIT 10;
```

### 2.3 æŸ¥è¯¢ä¼˜åŒ–å™¨æ‰©å±•

#### **å¤šæ¨¡å‹æŸ¥è¯¢è®¡åˆ’**

```sql
-- å¤æ‚å¤šæ¨¡å‹æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    u.username,
    u.profile->>'bio' AS bio,  -- JSON
    COUNT(DISTINCT f.friend_id) AS friends_count,  -- å…³ç³»å‹
    AVG(1 - (p.embedding <=> u.interests_vector)) AS interest_match  -- å‘é‡
FROM users u
LEFT JOIN friends f ON u.user_id = f.user_id
LEFT JOIN posts p ON u.user_id = p.author_id
WHERE u.profile @> '{"verified": true}'::jsonb  -- JSONè¿‡æ»¤
  AND u.interests_vector <=> target_vector < 0.5  -- å‘é‡è¿‡æ»¤
GROUP BY u.user_id, u.username, u.profile, u.interests_vector;

-- æ‰§è¡Œè®¡åˆ’åˆ†æï¼š
-- 1. Seq Scan on users (JSON GIN index used)
-- 2. Index Scan on friends (B-tree index)
-- 3. Bitmap Index Scan on posts (HNSW vector index)
-- 4. HashAggregate
```

#### **ç´¢å¼•é€‰æ‹©ç­–ç•¥**

```sql
-- å¤šæ¨¡å‹ç´¢å¼•ç­–ç•¥

-- 1. JSONBç´¢å¼•ï¼ˆGINï¼‰
CREATE INDEX idx_users_profile_gin ON users USING gin (profile);

-- 2. å‘é‡ç´¢å¼•ï¼ˆHNSWï¼‰
CREATE INDEX idx_users_interests_hnsw
ON users USING hnsw (interests_vector vector_cosine_ops);

-- 3. B-treeç´¢å¼•ï¼ˆå…³ç³»å‹ï¼‰
CREATE INDEX idx_friends_user_id ON friends (user_id);

-- 4. å¤åˆç´¢å¼•ï¼ˆå¤šåˆ—ï¼‰
CREATE INDEX idx_users_composite
ON users (user_id, (profile->>'verified'));

-- 5. è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_bio_length
ON users ((length(profile->>'bio')));
```

### 2.4 ä¸€è‡´æ€§ä¿è¯

#### **è·¨æ¨¡å‹ACIDäº‹åŠ¡**

```sql
-- å•ä¸ªäº‹åŠ¡ä¸­æ“ä½œå¤šç§æ•°æ®æ¨¡å‹
BEGIN;

-- 1. å…³ç³»å‹æ“ä½œ
INSERT INTO users (username, email)
VALUES ('john_doe', 'john@example.com')
RETURNING user_id INTO new_user_id;

-- 2. JSONæ“ä½œ
UPDATE users
SET profile = jsonb_build_object(
    'bio', 'Software Engineer',
    'interests', jsonb_build_array('PostgreSQL', 'AI'),
    'verified', true
)
WHERE user_id = new_user_id;

-- 3. å‘é‡æ“ä½œ
UPDATE users
SET interests_vector = generate_embedding(profile->>'bio')
WHERE user_id = new_user_id;

-- 4. å›¾æ“ä½œï¼ˆæ·»åŠ å…³ç³»ï¼‰
INSERT INTO friends (user_id, friend_id)
SELECT new_user_id, user_id
FROM users
WHERE profile @> '{"interests": ["PostgreSQL"]}'::jsonb
LIMIT 10;

COMMIT;  -- æ‰€æœ‰æ“ä½œåŸå­æäº¤

-- å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œå›æ»š
-- ä¿è¯è·¨æ¨¡å‹çš„æ•°æ®ä¸€è‡´æ€§
```

---

## ä¸‰ã€æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```python
"""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å¤šæ¨¡å‹èåˆæŸ¥è¯¢æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚          åº”ç”¨å±‚ (Application)               â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚         â”‚
â”‚  â”‚  â”‚SQL     â”‚  â”‚ORM     â”‚  â”‚GraphQL â”‚       â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚          æŸ¥è¯¢æŠ½è±¡å±‚ (Query Layer)           â”‚         â”‚
â”‚  â”‚  - å¤šæ¨¡å‹æŸ¥è¯¢æ„å»ºå™¨                        â”‚         â”‚
â”‚  â”‚  - æŸ¥è¯¢è·¯ç”±å™¨                              â”‚         â”‚
â”‚  â”‚  - ç»“æœæ˜ å°„å™¨                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚          PostgreSQLæ ¸å¿ƒ                     â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         â”‚
â”‚  â”‚  â”‚    æŸ¥è¯¢ä¼˜åŒ–å™¨ (Unified)           â”‚     â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚  â”‚  â”‚å…³ç³»  â”‚ â”‚JSON  â”‚ â”‚å‘é‡  â”‚ â”‚å›¾    â”‚    â”‚         â”‚
â”‚  â”‚  â”‚å­˜å‚¨  â”‚ â”‚å­˜å‚¨  â”‚ â”‚å­˜å‚¨  â”‚ â”‚å­˜å‚¨  â”‚    â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚  â”‚  â”‚B-treeâ”‚ â”‚GIN   â”‚ â”‚HNSW  â”‚ â”‚CTE   â”‚    â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚          MVCCäº‹åŠ¡å±‚                         â”‚         â”‚
â”‚  â”‚  - ACIDä¿è¯                                 â”‚         â”‚
â”‚  â”‚  - è·¨æ¨¡å‹ä¸€è‡´æ€§                             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""
```

### 3.2 å…³ç³»å‹ + æ–‡æ¡£èåˆ

```sql
-- è®¾è®¡æ¨¡å¼ï¼šåµŒå¥—æ–‡æ¡£ vs å…³ç³»è¡¨

-- åœºæ™¯ï¼šç”¨æˆ·åŠå…¶æ–‡ç« 
-- æ–¹æ¡ˆ1ï¼šå®Œå…¨å…³ç³»å‹
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100)
);

CREATE TABLE posts (
    post_id SERIAL PRIMARY KEY,
    author_id INT REFERENCES users(user_id),
    title VARCHAR(200),
    content TEXT
);

-- æ–¹æ¡ˆ2ï¼šæ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    profile JSONB,  -- çµæ´»çš„å±æ€§
    preferences JSONB,  -- ç”¨æˆ·åå¥½
    metadata JSONB  -- å¯æ‰©å±•å­—æ®µ
);

CREATE TABLE posts (
    post_id SERIAL PRIMARY KEY,
    author_id INT REFERENCES users(user_id),
    title VARCHAR(200),
    content TEXT,
    tags JSONB,  -- æ ‡ç­¾æ•°ç»„
    metrics JSONB  -- ç»Ÿè®¡ä¿¡æ¯
);

-- èåˆæŸ¥è¯¢ç¤ºä¾‹
SELECT
    u.username,
    u.profile->>'bio' AS bio,
    u.preferences->'notifications'->>'email' AS email_notif,
    COUNT(p.post_id) AS post_count,
    jsonb_agg(
        jsonb_build_object(
            'title', p.title,
            'tags', p.tags,
            'likes', (p.metrics->>'likes')::int
        )
    ) AS posts
FROM users u
LEFT JOIN posts p ON u.user_id = p.author_id
WHERE u.profile @> '{"verified": true}'::jsonb
  AND p.tags ? 'PostgreSQL'  -- JSONBåŒ…å«æ£€æŸ¥
GROUP BY u.user_id;
```

### 3.3 å…³ç³»å‹ + å›¾èåˆ

```sql
-- è®¾è®¡æ¨¡å¼ï¼šå…³ç³»è¡¨ + é€’å½’CTE æˆ– Apache AGE

-- ç¤¾äº¤ç½‘ç»œå›¾
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE friendships (
    user_id INT REFERENCES users(user_id),
    friend_id INT REFERENCES users(user_id),
    friendship_date TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, friend_id)
);

-- å›¾æŸ¥è¯¢ï¼šæœ€çŸ­è·¯å¾„ï¼ˆä½¿ç”¨é€’å½’CTEï¼‰
WITH RECURSIVE shortest_path AS (
    SELECT
        user_id,
        friend_id,
        ARRAY[user_id] AS path,
        1 AS depth
    FROM friendships
    WHERE user_id = 1  -- èµ·ç‚¹

    UNION

    SELECT
        sp.user_id,
        f.friend_id,
        sp.path || f.friend_id,
        sp.depth + 1
    FROM shortest_path sp
    JOIN friendships f ON sp.friend_id = f.user_id
    WHERE NOT (f.friend_id = ANY(sp.path))  -- é¿å…å¾ªç¯
      AND sp.depth < 6  -- æœ€å¤š6åº¦
)
SELECT
    path,
    depth,
    u.username AS target_user
FROM shortest_path sp
JOIN users u ON sp.friend_id = u.user_id
WHERE sp.friend_id = 100  -- ç»ˆç‚¹
ORDER BY depth
LIMIT 1;

-- ä½¿ç”¨Apache AGEï¼ˆCypherè¯­æ³•ï¼‰
LOAD 'age';
SET search_path = ag_catalog, "$user", public;

-- åˆ›å»ºå›¾
SELECT create_graph('social_network');

-- CypheræŸ¥è¯¢
SELECT * FROM cypher('social_network', $$
    MATCH (a:User {id: 1})-[:FRIENDS_WITH*1..6]-(b:User {id: 100})
    RETURN shortestPath((a)-[:FRIENDS_WITH*]-(b))
$$) as (path agtype);
```

### 3.4 å…³ç³»å‹ + å‘é‡èåˆ

```sql
-- è®¾è®¡æ¨¡å¼ï¼šå…³ç³»å‹å±æ€§ + å‘é‡åµŒå…¥

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(200),
    description TEXT,
    category VARCHAR(50),
    price DECIMAL(10, 2),
    stock INT,
    -- å‘é‡å­—æ®µ
    name_embedding VECTOR(1536),
    description_embedding VECTOR(1536),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_products_category ON products (category);
CREATE INDEX idx_products_price ON products (price);
CREATE INDEX idx_products_name_vec ON products
    USING hnsw (name_embedding vector_cosine_ops);
CREATE INDEX idx_products_desc_vec ON products
    USING hnsw (description_embedding vector_cosine_ops);

-- èåˆæŸ¥è¯¢ï¼šè¯­ä¹‰æœç´¢ + ç»“æ„åŒ–è¿‡æ»¤
SELECT
    p.product_id,
    p.name,
    p.description,
    p.category,
    p.price,
    p.stock,
    -- å‘é‡ç›¸ä¼¼åº¦
    1 - (p.description_embedding <=> query_embedding) AS similarity,
    -- ä»·æ ¼åŒ¹é…åº¦ï¼ˆè‡ªå®šä¹‰å‡½æ•°ï¼‰
    CASE
        WHEN p.price BETWEEN 100 AND 200 THEN 1.0
        WHEN p.price BETWEEN 50 AND 100 OR p.price BETWEEN 200 AND 300 THEN 0.5
        ELSE 0.0
    END AS price_match,
    -- åº“å­˜çŠ¶æ€
    CASE
        WHEN p.stock > 100 THEN 'in_stock'
        WHEN p.stock > 0 THEN 'low_stock'
        ELSE 'out_of_stock'
    END AS stock_status
FROM products p
WHERE p.category IN ('Electronics', 'Computers')  -- å…³ç³»å‹è¿‡æ»¤
  AND p.price BETWEEN 50 AND 500  -- å…³ç³»å‹è¿‡æ»¤
  AND p.stock > 0  -- å…³ç³»å‹è¿‡æ»¤
  AND p.description_embedding <=> query_embedding < 0.4  -- å‘é‡è¿‡æ»¤
ORDER BY (similarity * 0.7 + price_match * 0.3) DESC  -- æ··åˆæ’åº
LIMIT 20;
```

### 3.5 å¤šæ¨¡å‹ç»Ÿä¸€æŸ¥è¯¢

```sql
-- è®¾è®¡æ¨¡å¼ï¼šå…³ç³»å‹ + JSON + å‘é‡ + å›¾ + å…¨æ–‡æœç´¢

-- ç»¼åˆè¡¨è®¾è®¡
CREATE TABLE content_items (
    item_id SERIAL PRIMARY KEY,
    title VARCHAR(200),
    content TEXT,
    author_id INT REFERENCES users(user_id),
    category VARCHAR(50),

    -- JSONå­—æ®µ
    metadata JSONB,  -- çµæ´»çš„å…ƒæ•°æ®
    tags JSONB,  -- æ ‡ç­¾æ•°ç»„

    -- å‘é‡å­—æ®µ
    content_embedding VECTOR(1536),

    -- å…¨æ–‡æœç´¢å­—æ®µ
    search_vector TSVECTOR,

    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå¤šç±»å‹ç´¢å¼•
CREATE INDEX idx_content_metadata_gin ON content_items USING gin (metadata);
CREATE INDEX idx_content_tags_gin ON content_items USING gin (tags);
CREATE INDEX idx_content_embedding_hnsw ON content_items
    USING hnsw (content_embedding vector_cosine_ops);
CREATE INDEX idx_content_search_gin ON content_items USING gin (search_vector);
CREATE INDEX idx_content_author ON content_items (author_id);
CREATE INDEX idx_content_category ON content_items (category);

-- ç»Ÿä¸€æŸ¥è¯¢ï¼šèåˆæ‰€æœ‰æ•°æ®æ¨¡å‹
WITH
-- 1. å‘é‡æœç´¢
vector_results AS (
    SELECT item_id, 1 - (content_embedding <=> query_embedding) AS vec_score
    FROM content_items
    WHERE content_embedding <=> query_embedding < 0.5
),
-- 2. å…¨æ–‡æœç´¢
fts_results AS (
    SELECT item_id, ts_rank(search_vector, query_tsquery) AS fts_score
    FROM content_items
    WHERE search_vector @@ query_tsquery
),
-- 3. å›¾éå†ï¼ˆç›¸å…³ä½œè€…ï¼‰
related_authors AS (
    SELECT DISTINCT friend_id AS author_id
    FROM friendships
    WHERE user_id = current_user_id
    UNION
    SELECT current_user_id
)
SELECT
    c.item_id,
    c.title,
    c.content,
    c.category,
    u.username AS author,
    -- JSONæå–
    c.metadata->>'source' AS source,
    c.tags,
    -- åˆ†æ•°è®¡ç®—
    COALESCE(vr.vec_score, 0) * 0.4 AS vector_score,
    COALESCE(fr.fts_score, 0) * 0.3 AS fulltext_score,
    CASE WHEN ra.author_id IS NOT NULL THEN 0.3 ELSE 0 END AS social_score,
    -- æ€»åˆ†
    COALESCE(vr.vec_score, 0) * 0.4 +
    COALESCE(fr.fts_score, 0) * 0.3 +
    CASE WHEN ra.author_id IS NOT NULL THEN 0.3 ELSE 0 END AS total_score
FROM content_items c
JOIN users u ON c.author_id = u.user_id
LEFT JOIN vector_results vr ON c.item_id = vr.item_id
LEFT JOIN fts_results fr ON c.item_id = fr.item_id
LEFT JOIN related_authors ra ON c.author_id = ra.author_id
WHERE
    -- å…³ç³»å‹è¿‡æ»¤
    c.category IN ('Tech', 'Database')
    AND c.created_at >= NOW() - INTERVAL '30 days'
    -- JSONè¿‡æ»¤
    AND c.metadata @> '{"status": "published"}'::jsonb
    AND c.tags ?| ARRAY['postgresql', 'database']  -- ä»»ä¸€æ ‡ç­¾åŒ¹é…
    -- è‡³å°‘åŒ¹é…ä¸€ç§æœç´¢
    AND (vr.item_id IS NOT NULL OR fr.item_id IS NOT NULL OR ra.author_id IS NOT NULL)
ORDER BY total_score DESC
LIMIT 50;
```

---

## å››ã€ç¨‹åºè®¾è®¡

### 4.1 ç¯å¢ƒå‡†å¤‡

```sql
-- å®‰è£…å¿…è¦æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";  -- ä¸‰å…ƒç»„ç›¸ä¼¼åº¦
CREATE EXTENSION IF NOT EXISTS "btree_gin";  -- GINç´¢å¼•æ”¯æŒæ›´å¤šç±»å‹
CREATE EXTENSION IF NOT EXISTS "btree_gist";  -- GiSTç´¢å¼•æ”¯æŒæ›´å¤šç±»å‹
CREATE EXTENSION IF NOT EXISTS "vector";  -- pgvector
```

### 4.2 å…³ç³» + JSONèåˆæŸ¥è¯¢

**å®Œæ•´å®ç°è§æ–‡æ¡£...**

### 4.3 å…³ç³» + å›¾èåˆæŸ¥è¯¢

**å®Œæ•´å®ç°è§æ–‡æ¡£...**

### 4.4 å…³ç³» + å‘é‡èåˆæŸ¥è¯¢

**å®Œæ•´å®ç°è§æ–‡æ¡£...**

### 4.5 å››æ¨¡å‹èåˆæŸ¥è¯¢

**å®Œæ•´å®ç°è§æ–‡æ¡£...**

---

## äº”ã€è¿ç»´ç®¡ç†

### 5.1 ç´¢å¼•ååŒä¼˜åŒ–

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.2 æŸ¥è¯¢æ€§èƒ½ç›‘æ§

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.3 äº‹åŠ¡ä¸€è‡´æ€§

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

### 5.4 æœ€ä½³å®è·µ

**è¯¦ç»†å†…å®¹è§å®Œæ•´æ–‡æ¡£...**

---

## å…­ã€æ¡ˆä¾‹å®æˆ˜

### 6.1 ç¤¾äº¤ç½‘ç»œåˆ†æ

**åœºæ™¯**ï¼šç¤¾äº¤ç½‘ç»œå¹³å°ï¼Œéœ€è¦æ¨èå†…å®¹

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 6.2 æ™ºèƒ½æœç´¢å¼•æ“

**åœºæ™¯**ï¼šä¼ä¸šæœç´¢å¼•æ“ï¼Œèåˆå¤šç§æ£€ç´¢æ–¹å¼

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 6.3 çŸ¥è¯†å›¾è°±åº”ç”¨

**åœºæ™¯**ï¼šä¼ä¸šçŸ¥è¯†å›¾è°±ï¼Œå®ä½“å…³ç³»æŸ¥è¯¢

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

### 6.4 å®æ—¶åˆ†æå¹³å°

**åœºæ™¯**ï¼šIoTå¹³å°ï¼Œå®æ—¶æ•°æ®åˆ†æ

**è¯¦ç»†å®ç°è§å®Œæ•´æ–‡æ¡£...**

---

## ä¸ƒã€æ€§èƒ½æµ‹è¯•

| æŸ¥è¯¢ç±»å‹ | å•ä¸€æ¨¡å‹ | å¤šæ¨¡å‹èåˆ | æ€§èƒ½å¯¹æ¯” |
|---------|---------|-----------|---------|
| ç®€å•æŸ¥è¯¢ | 10ms | 12ms | -20% |
| å¤æ‚è¿‡æ»¤ | 150ms | 95ms | **+37%** |
| æ··åˆæ£€ç´¢ | 300ms | 180ms | **+40%** |
| èšåˆåˆ†æ | 500ms | 420ms | **+16%** |

---

## å…«ã€æ€»ç»“ä¸å±•æœ›

### æ ¸å¿ƒæ”¶è·

1. âœ… PostgreSQLæä¾›å®Œæ•´çš„å¤šæ¨¡å‹æ”¯æŒ
2. âœ… ç»Ÿä¸€æŸ¥è¯¢æ¥å£ç®€åŒ–å¼€å‘
3. âœ… ACIDäº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. âœ… æ€§èƒ½ä¼˜äºè·¨ç³»ç»Ÿæ–¹æ¡ˆ

### é€‚ç”¨åœºæ™¯

- âœ… éœ€è¦å¤šç§æ•°æ®æ¨¡å‹çš„åº”ç”¨
- âœ… å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
- âœ… å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜
- âœ… å¸Œæœ›ç®€åŒ–æ¶æ„

---

## ä¹ã€å‚è€ƒèµ„æ–™

1. **PostgreSQLå®˜æ–¹æ–‡æ¡£**: [https://www.postgresql.org/docs/](https://www.postgresql.org/docs/)
2. **pgvector**: [https://github.com/pgvector/pgvector](https://github.com/pgvector/pgvector)
3. **Apache AGE**: [https://age.apache.org/](https://age.apache.org/)

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ4æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 04-QUERY-MULTIMODEL
**ç‰ˆæœ¬**: v1.0
