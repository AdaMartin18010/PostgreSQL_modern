# éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡

> **æ–‡æ¡£ç¼–å·**: AI-07-03
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ
> **ä¸»é¢˜**: 07-å®æ–½è·¯å¾„
> **å­ä¸»é¢˜**: 03-éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡

## ğŸ“‘ ç›®å½•

- [éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡](#éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾](#11-éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾)
    - [1.2 éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘](#12-éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘)
  - [äºŒã€éƒ¨ç½²æ¶æ„é€‰æ‹©](#äºŒéƒ¨ç½²æ¶æ„é€‰æ‹©)
    - [2.1 Serverlesséƒ¨ç½²](#21-serverlesséƒ¨ç½²)
    - [2.2 æ ‡å‡†éƒ¨ç½²](#22-æ ‡å‡†éƒ¨ç½²)
    - [2.3 é«˜å¯ç”¨éƒ¨ç½²](#23-é«˜å¯ç”¨éƒ¨ç½²)
  - [ä¸‰ã€ç¯å¢ƒå‡†å¤‡](#ä¸‰ç¯å¢ƒå‡†å¤‡)
    - [3.1 ç¡¬ä»¶è¦æ±‚](#31-ç¡¬ä»¶è¦æ±‚)
    - [3.2 è½¯ä»¶è¦æ±‚](#32-è½¯ä»¶è¦æ±‚)
    - [3.3 ç½‘ç»œé…ç½®](#33-ç½‘ç»œé…ç½®)
  - [å››ã€å®‰è£…é…ç½®](#å››å®‰è£…é…ç½®)
    - [4.1 PostgreSQLå®‰è£…](#41-postgresqlå®‰è£…)
    - [4.2 æ‰©å±•å®‰è£…](#42-æ‰©å±•å®‰è£…)
    - [4.3 å‚æ•°é…ç½®](#43-å‚æ•°é…ç½®)
  - [äº”ã€é«˜å¯ç”¨é…ç½®](#äº”é«˜å¯ç”¨é…ç½®)
    - [5.1 ä¸»ä»å¤åˆ¶](#51-ä¸»ä»å¤åˆ¶)
    - [5.2 è‡ªåŠ¨æ•…éšœè½¬ç§»](#52-è‡ªåŠ¨æ•…éšœè½¬ç§»)
    - [5.3 è´Ÿè½½å‡è¡¡](#53-è´Ÿè½½å‡è¡¡)
  - [å…­ã€ç›‘æ§å‘Šè­¦](#å…­ç›‘æ§å‘Šè­¦)
    - [6.1 ç›‘æ§æŒ‡æ ‡](#61-ç›‘æ§æŒ‡æ ‡)
    - [6.2 å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
    - [6.3 æ—¥å¿—ç®¡ç†](#63-æ—¥å¿—ç®¡ç†)
  - [ä¸ƒã€å¤‡ä»½æ¢å¤](#ä¸ƒå¤‡ä»½æ¢å¤)
    - [7.1 å¤‡ä»½ç­–ç•¥](#71-å¤‡ä»½ç­–ç•¥)
    - [7.2 æ¢å¤æµ‹è¯•](#72-æ¢å¤æµ‹è¯•)
    - [7.3 ç¾éš¾æ¢å¤](#73-ç¾éš¾æ¢å¤)
  - [å…«ã€å®‰å…¨é…ç½®](#å…«å®‰å…¨é…ç½®)
    - [8.1 è®¿é—®æ§åˆ¶](#81-è®¿é—®æ§åˆ¶)
    - [8.2 æ•°æ®åŠ å¯†](#82-æ•°æ®åŠ å¯†)
    - [8.3 å®¡è®¡æ—¥å¿—](#83-å®¡è®¡æ—¥å¿—)
  - [ä¹ã€æœ€ä½³å®è·µ](#ä¹æœ€ä½³å®è·µ)
  - [åã€å…³è”ä¸»é¢˜](#åå…³è”ä¸»é¢˜)
  - [åä¸€ã€å¯¹æ ‡èµ„æº](#åä¸€å¯¹æ ‡èµ„æº)
    - [æŠ€æœ¯æ–‡æ¡£](#æŠ€æœ¯æ–‡æ¡£)
    - [å·¥å…·](#å·¥å…·)

## ä¸€ã€æ¦‚è¿°

PostgreSQL AIåº”ç”¨çš„éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡ï¼Œæ¶µç›–Serverlessã€æ ‡å‡†éƒ¨ç½²ã€é«˜å¯ç”¨éƒ¨ç½²ç­‰å¤šç§æ–¹æ¡ˆï¼Œæä¾›å®Œæ•´çš„éƒ¨ç½²æŒ‡å—å’Œæœ€ä½³å®è·µã€‚

### 1.1 éƒ¨ç½²æ–¹æ¡ˆæ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((éƒ¨ç½²æ–¹æ¡ˆ))
    Serverlesséƒ¨ç½²
      Neon
        æŒ‰éœ€è®¡è´¹
        è‡ªåŠ¨æ‰©ç¼©å®¹
        åˆ†æ”¯åŠŸèƒ½
      Supabase
        å®æ—¶è®¢é˜…
        è‡ªåŠ¨API
        å­˜å‚¨ç®¡ç†
    æ ‡å‡†éƒ¨ç½²
      å•æœºéƒ¨ç½²
        å¼€å‘ç¯å¢ƒ
        æµ‹è¯•ç¯å¢ƒ
      ä¸»ä»éƒ¨ç½²
        è¯»å†™åˆ†ç¦»
        æ•…éšœè½¬ç§»
    é«˜å¯ç”¨éƒ¨ç½²
      ä¸»å¤‡æ¶æ„
        å®æ—¶å¤åˆ¶
        è‡ªåŠ¨åˆ‡æ¢
      é›†ç¾¤æ¶æ„
        Citusåˆ†å¸ƒå¼
        è´Ÿè½½å‡è¡¡
    ç›‘æ§å‘Šè­¦
      æ€§èƒ½ç›‘æ§
        Prometheus
        Grafana
      æ—¥å¿—ç®¡ç†
        ELK Stack
        Loki
      å‘Šè­¦ç³»ç»Ÿ
        AlertManager
        PagerDuty
```

### 1.2 éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦éƒ¨ç½²PostgreSQL AI?] --> B{éƒ¨ç½²ç¯å¢ƒ?}

    B -->|å¼€å‘/æµ‹è¯•| C[Serverlesséƒ¨ç½²]
    B -->|ç”Ÿäº§ç¯å¢ƒ| D{è§„æ¨¡è¦æ±‚?}

    C --> E{äº‘å¹³å°?}
    E -->|Neon| F[Neon Serverless]
    E -->|Supabase| G[Supabase Serverless]

    D -->|å°è§„æ¨¡| H[æ ‡å‡†éƒ¨ç½²]
    D -->|å¤§è§„æ¨¡| I[é«˜å¯ç”¨éƒ¨ç½²]

    H --> J{å¯ç”¨æ€§è¦æ±‚?}
    J -->|é«˜| K[ä¸»ä»éƒ¨ç½²]
    J -->|ä¸­| L[å•æœºéƒ¨ç½²]

    I --> M{æ‰©å±•éœ€æ±‚?}
    M -->|æ°´å¹³æ‰©å±•| N[Citusé›†ç¾¤]
    M -->|å‚ç›´æ‰©å±•| O[ä¸»å¤‡æ¶æ„]

    F --> P[é…ç½®ç›‘æ§]
    G --> P
    K --> P
    L --> P
    N --> P
    O --> P
```

## äºŒã€éƒ¨ç½²æ¶æ„é€‰æ‹©

### 2.1 Serverlesséƒ¨ç½²

**é€‚ç”¨åœºæ™¯**:

- å¿«é€ŸåŸå‹å¼€å‘
- å°åˆ°ä¸­ç­‰è§„æ¨¡åº”ç”¨
- é›¶è¿ç»´éœ€æ±‚

**æ¨èæ–¹æ¡ˆ**: Neon / Supabase

**ä¼˜åŠ¿**:

- é›¶è¿ç»´æˆæœ¬
- è‡ªåŠ¨æ‰©å±•
- Scale-to-Zero
- æŒ‰éœ€ä»˜è´¹

**é…ç½®ç¤ºä¾‹**:

```bash
# Neonéƒ¨ç½²
neon projects create my-ai-app
neon branches create main

# è¿æ¥å­—ç¬¦ä¸²
postgresql://user:pass@host/db?branch=main
```

### 2.2 æ ‡å‡†éƒ¨ç½²

**é€‚ç”¨åœºæ™¯**:

- ç”Ÿäº§ç¯å¢ƒ
- ä¸­ç­‰è§„æ¨¡åº”ç”¨
- éœ€è¦è‡ªå®šä¹‰é…ç½®

**éƒ¨ç½²æ­¥éª¤**:

```bash
# 1. å®‰è£…PostgreSQL
sudo apt-get install postgresql-16

# 2. å®‰è£…æ‰©å±•
sudo apt-get install postgresql-16-pgvector

# 3. åˆ›å»ºæ•°æ®åº“
createdb ai_app

# 4. å®‰è£…æ‰©å±•
psql -d ai_app -c "CREATE EXTENSION vector;"
psql -d ai_app -c "CREATE EXTENSION pgai;"
```

### 2.3 é«˜å¯ç”¨éƒ¨ç½²

**é€‚ç”¨åœºæ™¯**:

- å…³é”®ä¸šåŠ¡ç³»ç»Ÿ
- é«˜å¯ç”¨è¦æ±‚
- å¤§è§„æ¨¡åº”ç”¨

**æ¶æ„**:

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[è´Ÿè½½å‡è¡¡å™¨]
    B --> C[ä¸»èŠ‚ç‚¹]
    B --> D[ä»èŠ‚ç‚¹1]
    B --> E[ä»èŠ‚ç‚¹2]

    C --> F[æµå¤åˆ¶]
    D --> F
    E --> F
```

## ä¸‰ã€ç¯å¢ƒå‡†å¤‡

### 3.1 ç¡¬ä»¶è¦æ±‚

| åœºæ™¯ | CPU | å†…å­˜ | å­˜å‚¨ |
|------|:---:|:----:|:----:|
| å°è§„æ¨¡ | 4æ ¸ | 16GB | 100GB SSD |
| ä¸­ç­‰è§„æ¨¡ | 16æ ¸ | 64GB | 500GB NVMe |
| å¤§è§„æ¨¡ | 32æ ¸+ | 128GB+ | 2TB+ NVMe |

### 3.2 è½¯ä»¶è¦æ±‚

```bash
# PostgreSQLç‰ˆæœ¬
PostgreSQL >= 12

# æ‰©å±•ç‰ˆæœ¬
pgvector >= 0.5.0
pgai >= 0.1.0

# æ“ä½œç³»ç»Ÿ
Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
```

### 3.3 ç½‘ç»œé…ç½®

```bash
# é˜²ç«å¢™é…ç½®
sudo ufw allow 5432/tcp

# PostgreSQLé…ç½®
# postgresql.conf
listen_addresses = '*'
port = 5432

# pg_hba.conf
host    all    all    0.0.0.0/0    md5
```

## å››ã€å®‰è£…é…ç½®

### 4.1 PostgreSQLå®‰è£…

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install postgresql-16 postgresql-contrib-16

# CentOS/RHEL
sudo yum install postgresql16-server postgresql16

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 4.2 æ‰©å±•å®‰è£…

```bash
# å®‰è£…pgvector
# ä»æºç ç¼–è¯‘
git clone https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# æˆ–ä½¿ç”¨åŒ…ç®¡ç†å™¨
sudo apt-get install postgresql-16-pgvector

# å®‰è£…pgai
git clone https://github.com/pgai/pgai.git
cd pgai
make
sudo make install
```

### 4.3 å‚æ•°é…ç½®

```sql
-- postgresql.confä¼˜åŒ–
shared_buffers = 8GB
effective_cache_size = 24GB
work_mem = 256MB
maintenance_work_mem = 2GB
max_connections = 200

-- å‘é‡æŸ¥è¯¢ä¼˜åŒ–
hnsw.ef_search = 200

-- é‡å¯æœåŠ¡
sudo systemctl restart postgresql
```

## äº”ã€é«˜å¯ç”¨é…ç½®

### 5.1 ä¸»ä»å¤åˆ¶

```sql
-- ä¸»èŠ‚ç‚¹é…ç½®
-- postgresql.conf
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3

-- pg_hba.conf
host    replication    replica_user    slave_ip/32    md5

-- ä»èŠ‚ç‚¹é…ç½®
-- ä½¿ç”¨pg_basebackupåˆå§‹åŒ–
pg_basebackup -h master_host -U replica_user -D /var/lib/postgresql/data -P -W

-- recovery.conf
standby_mode = 'on'
primary_conninfo = 'host=master_host port=5432 user=replica_user'
```

### 5.2 è‡ªåŠ¨æ•…éšœè½¬ç§»

```bash
# ä½¿ç”¨Patroniå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
pip install patroni[etcd]

# é…ç½®æ–‡ä»¶
# patroni.yml
scope: postgres
name: postgresql1
restapi:
  listen: 0.0.0.0:8008
  connect_address: localhost:8008
etcd:
  host: localhost:2379
bootstrap:
  dcs:
    postgresql:
      use_pg_rewind: true
postgresql:
  listen: 0.0.0.0:5432
  connect_address: localhost:5432
  data_dir: /var/lib/postgresql/data
```

### 5.3 è´Ÿè½½å‡è¡¡

```bash
# ä½¿ç”¨PgBouncerå®ç°è¿æ¥æ± 
sudo apt-get install pgbouncer

# pgbouncer.ini
[databases]
ai_app = host=localhost port=5432 dbname=ai_app

[pgbouncer]
pool_mode = transaction
max_client_conn = 10000
default_pool_size = 25
```

## å…­ã€ç›‘æ§å‘Šè­¦

### 6.1 ç›‘æ§æŒ‡æ ‡

```sql
-- å¯ç”¨ç›‘æ§æ‰©å±•
CREATE EXTENSION pg_stat_statements;

-- å…³é”®æŒ‡æ ‡
SELECT
    'connections' AS metric,
    COUNT(*) AS value
FROM pg_stat_activity;

SELECT
    'cache_hit_ratio' AS metric,
    ROUND(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2) AS value
FROM pg_statio_user_tables;
```

### 6.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: postgresql
    rules:
      - alert: HighConnections
        expr: pg_stat_database_numbackends > 150
        for: 5m
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"

      - alert: SlowQueries
        expr: pg_stat_statements_mean_exec_time > 1000
        for: 5m
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢"
```

### 6.3 æ—¥å¿—ç®¡ç†

```sql
-- postgresql.conf
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_min_duration_statement = 1000  -- è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
```

## ä¸ƒã€å¤‡ä»½æ¢å¤

### 7.1 å¤‡ä»½ç­–ç•¥

```bash
# å…¨é‡å¤‡ä»½
pg_dump -h localhost -U postgres -d ai_app -F c -f backup.dump

# å¢é‡å¤‡ä»½ï¼ˆWALå½’æ¡£ï¼‰
# postgresql.conf
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'

# å®šæ—¶å¤‡ä»½
0 2 * * * pg_dump -h localhost -U postgres -d ai_app -F c -f /backup/daily_$(date +\%Y\%m\%d).dump
```

### 7.2 æ¢å¤æµ‹è¯•

```bash
# æ¢å¤æ•°æ®åº“
pg_restore -h localhost -U postgres -d ai_app -c backup.dump

# æ¢å¤WAL
# åˆ›å»ºrecovery.conf
restore_command = 'cp /backup/wal/%f %p'
recovery_target_time = '2024-01-01 12:00:00'
```

### 7.3 ç¾éš¾æ¢å¤

```bash
# ç¾éš¾æ¢å¤æµç¨‹
# 1. æ¢å¤æœ€æ–°å…¨é‡å¤‡ä»½
pg_restore -h localhost -U postgres -d ai_app -c latest_backup.dump

# 2. æ¢å¤WALæ—¥å¿—
# é…ç½®recovery.conf
restore_command = 'cp /backup/wal/%f %p'

# 3. å¯åŠ¨æ•°æ®åº“
# PostgreSQLä¼šè‡ªåŠ¨åº”ç”¨WALæ—¥å¿—
```

## å…«ã€å®‰å…¨é…ç½®

### 8.1 è®¿é—®æ§åˆ¶

```sql
-- åˆ›å»ºä¸“ç”¨ç”¨æˆ·
CREATE USER ai_app_user WITH PASSWORD 'strong_password';

-- æˆäºˆæƒé™
GRANT CONNECT ON DATABASE ai_app TO ai_app_user;
GRANT USAGE ON SCHEMA public TO ai_app_user;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO ai_app_user;

-- è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_access ON documents
    FOR ALL
    TO ai_app_user
    USING (user_id = current_setting('app.user_id')::INTEGER);
```

### 8.2 æ•°æ®åŠ å¯†

```sql
-- ä¼ è¾“åŠ å¯†ï¼ˆSSLï¼‰
-- postgresql.conf
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'

-- æ•°æ®åŠ å¯†ï¼ˆä½¿ç”¨pgcryptoï¼‰
CREATE EXTENSION pgcrypto;

-- åŠ å¯†æ•æ„Ÿæ•°æ®
INSERT INTO users (email, password)
VALUES (
    'user@example.com',
    crypt('password', gen_salt('bf'))
);
```

### 8.3 å®¡è®¡æ—¥å¿—

```sql
-- å¯ç”¨å®¡è®¡æ‰©å±•
CREATE EXTENSION pg_audit;

-- å®¡è®¡æ‰€æœ‰æ“ä½œ
ALTER TABLE documents ENABLE AUDIT;

-- æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM pg_audit_log
WHERE table_name = 'documents'
ORDER BY timestamp DESC;
```

## ä¹ã€æœ€ä½³å®è·µ

1. **éƒ¨ç½²é€‰æ‹©**:
   - å¿«é€ŸåŸå‹ï¼šServerless
   - ç”Ÿäº§ç¯å¢ƒï¼šæ ‡å‡†éƒ¨ç½²
   - å…³é”®ä¸šåŠ¡ï¼šé«˜å¯ç”¨éƒ¨ç½²

2. **ç›‘æ§å‘Šè­¦**:
   - è®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§
   - é…ç½®å‘Šè­¦è§„åˆ™
   - å®šæœŸæ£€æŸ¥æ—¥å¿—

3. **å¤‡ä»½æ¢å¤**:
   - å®šæœŸå…¨é‡å¤‡ä»½
   - å¯ç”¨WALå½’æ¡£
   - å®šæœŸæ¢å¤æµ‹è¯•

4. **å®‰å…¨é…ç½®**:
   - æœ€å°æƒé™åŸåˆ™
   - å¯ç”¨SSLåŠ å¯†
   - é…ç½®å®¡è®¡æ—¥å¿—

## åã€å…³è”ä¸»é¢˜

- [æ¸è¿›å¼æ¼”è¿›è·¯çº¿](./æ¸è¿›å¼æ¼”è¿›è·¯çº¿.md) - æ¼”è¿›è·¯å¾„
- [æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™](./æ€§èƒ½è°ƒä¼˜é»„é‡‘æ³•åˆ™.md) - æ€§èƒ½ä¼˜åŒ–
- [æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](../03-æ ¸å¿ƒèƒ½åŠ›/æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯.md) - è¯¦ç»†ä¼˜åŒ–

## åä¸€ã€å¯¹æ ‡èµ„æº

### æŠ€æœ¯æ–‡æ¡£

- [PostgreSQLéƒ¨ç½²æŒ‡å—](https://www.postgresql.org/docs/current/admin.html)
- [Neonéƒ¨ç½²æ–‡æ¡£](https://neon.tech/docs)
- [Supabaseéƒ¨ç½²æ–‡æ¡£](https://supabase.com/docs)

### å·¥å…·

- [Patroni](https://patroni.readthedocs.io/)
- [PgBouncer](https://www.pgbouncer.org/)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: AI-07-03
