# ç›‘æ§ä¸å‘Šè­¦

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æ–‡æ¡£ç¼–å·**: 09-02-01

## ğŸ“‘ ç›®å½•

- [ç›‘æ§ä¸å‘Šè­¦](#ç›‘æ§ä¸å‘Šè­¦)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 ç›‘æ§ç›®æ ‡](#12-ç›‘æ§ç›®æ ‡)
    - [1.3 å®é™…åº”ç”¨æ¡ˆä¾‹](#13-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [1.4 å‘Šè­¦ç­–ç•¥](#14-å‘Šè­¦ç­–ç•¥)
    - [1.5 ç›‘æ§æ¶æ„](#15-ç›‘æ§æ¶æ„)
  - [2. ç›‘æ§æŒ‡æ ‡](#2-ç›‘æ§æŒ‡æ ‡)
    - [2.1 æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡](#21-æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡)
      - [2.1.1 å…³é”®æŒ‡æ ‡](#211-å…³é”®æŒ‡æ ‡)
      - [2.1.2 å‘é‡æŸ¥è¯¢æ€§èƒ½](#212-å‘é‡æŸ¥è¯¢æ€§èƒ½)
      - [2.1.3 æŸ¥è¯¢ç»Ÿè®¡](#213-æŸ¥è¯¢ç»Ÿè®¡)
    - [2.2 ç´¢å¼•ä½¿ç”¨æƒ…å†µ](#22-ç´¢å¼•ä½¿ç”¨æƒ…å†µ)
      - [2.2.1 ç´¢å¼•æ‰«æç»Ÿè®¡](#221-ç´¢å¼•æ‰«æç»Ÿè®¡)
      - [2.2.2 ç´¢å¼•æ•ˆç‡åˆ†æ](#222-ç´¢å¼•æ•ˆç‡åˆ†æ)
    - [2.3 è¡¨å¤§å°ç›‘æ§](#23-è¡¨å¤§å°ç›‘æ§)
      - [2.3.1 è¡¨å¤§å°ç»Ÿè®¡](#231-è¡¨å¤§å°ç»Ÿè®¡)
      - [2.3.2 ç´¢å¼•å¤§å°åˆ†æ](#232-ç´¢å¼•å¤§å°åˆ†æ)
  - [3. Prometheus ç›‘æ§](#3-prometheus-ç›‘æ§)
    - [3.1 postgres\_exporter é…ç½®](#31-postgres_exporter-é…ç½®)
      - [3.1.1 Exporter å®‰è£…](#311-exporter-å®‰è£…)
      - [3.1.2 é…ç½®æ–‡ä»¶](#312-é…ç½®æ–‡ä»¶)
    - [3.2 å…³é”®ç›‘æ§æŒ‡æ ‡](#32-å…³é”®ç›‘æ§æŒ‡æ ‡)
      - [3.2.1 PromQL æŸ¥è¯¢](#321-promql-æŸ¥è¯¢)
      - [3.2.2 æŒ‡æ ‡è¯´æ˜](#322-æŒ‡æ ‡è¯´æ˜)
    - [3.3 Grafana ä»ªè¡¨ç›˜](#33-grafana-ä»ªè¡¨ç›˜)
      - [3.3.1 ä»ªè¡¨ç›˜é…ç½®](#331-ä»ªè¡¨ç›˜é…ç½®)
      - [3.3.2 å¯è§†åŒ–é¢æ¿](#332-å¯è§†åŒ–é¢æ¿)
  - [4. å‘Šè­¦é…ç½®](#4-å‘Šè­¦é…ç½®)
    - [4.1 å‘Šè­¦è§„åˆ™](#41-å‘Šè­¦è§„åˆ™)
      - [4.1.1 Prometheus å‘Šè­¦è§„åˆ™](#411-prometheus-å‘Šè­¦è§„åˆ™)
      - [4.1.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®](#412-å‘Šè­¦é˜ˆå€¼è®¾ç½®)
    - [4.2 å‘Šè­¦é€šçŸ¥](#42-å‘Šè­¦é€šçŸ¥)
      - [4.2.1 Alertmanager é…ç½®](#421-alertmanager-é…ç½®)
      - [4.2.2 é€šçŸ¥æ¸ é“è®¾ç½®](#422-é€šçŸ¥æ¸ é“è®¾ç½®)
  - [5. è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬](#5-è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬)
    - [5.1 Python ç›‘æ§è„šæœ¬](#51-python-ç›‘æ§è„šæœ¬)
    - [5.2 ç›‘æ§æŒ‡æ ‡é‡‡é›†](#52-ç›‘æ§æŒ‡æ ‡é‡‡é›†)
  - [6. ç›‘æ§ä»ªè¡¨ç›˜ç¤ºä¾‹](#6-ç›‘æ§ä»ªè¡¨ç›˜ç¤ºä¾‹)
    - [6.1 Grafana SQL æŸ¥è¯¢](#61-grafana-sql-æŸ¥è¯¢)
    - [6.2 ä»ªè¡¨ç›˜æ¨¡æ¿](#62-ä»ªè¡¨ç›˜æ¨¡æ¿)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 ç›‘æ§æŒ‡æ ‡é€‰æ‹©](#71-ç›‘æ§æŒ‡æ ‡é€‰æ‹©)
    - [7.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®](#72-å‘Šè­¦é˜ˆå€¼è®¾ç½®)
    - [7.3 ç›‘æ§ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–](#73-ç›‘æ§ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–)
    - [7.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#74-å®é™…åº”ç”¨æ¡ˆä¾‹)
  - [8. å®é™…åº”ç”¨æ¡ˆä¾‹](#8-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [8.1 æ¡ˆä¾‹ï¼šå¤§å‹ç”µå•†å¹³å°ç›‘æ§ç³»ç»Ÿå®æ–½](#81-æ¡ˆä¾‹å¤§å‹ç”µå•†å¹³å°ç›‘æ§ç³»ç»Ÿå®æ–½)
    - [8.2 æ¡ˆä¾‹ï¼šé‡‘èç³»ç»Ÿç›‘æ§å‘Šè­¦ä¼˜åŒ–](#82-æ¡ˆä¾‹é‡‘èç³»ç»Ÿç›‘æ§å‘Šè­¦ä¼˜åŒ–)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯æ–‡æ¡£](#82-æŠ€æœ¯æ–‡æ¡£)
    - [8.3 ç›¸å…³èµ„æº](#83-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**ç›‘æ§éœ€æ±‚èƒŒæ™¯**:

PostgreSQL + pgvector åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦å…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œå’Œå¿«é€Ÿæ•…éšœå“åº”ã€‚
æ ¹æ® 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®ï¼Œæœ‰æ•ˆçš„ç›‘æ§ç³»ç»Ÿå¯ä»¥å°†æ•…éšœå‘ç°æ—¶é—´ä»å¹³å‡ 30 åˆ†é’Ÿé™ä½åˆ° **<5 åˆ†é’Ÿ**ï¼Œæ•…éšœæ¢å¤æ—¶é—´é™ä½ **60%**ã€‚

**æ ¸å¿ƒä»·å€¼** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•…éšœå‘ç°æ—¶é—´** | ä» 30 åˆ†é’Ÿé™ä½åˆ° <5 åˆ†é’Ÿ | å‡å°‘æ•…éšœå½±å“ **83%** |
| **æ•…éšœæ¢å¤æ—¶é—´** | å¹³å‡æ¢å¤æ—¶é—´é™ä½ 60% | å‡å°‘ä¸šåŠ¡æŸå¤± **60%** |
| **æ€§èƒ½ä¼˜åŒ–** | åŸºäºç›‘æ§æ•°æ®ä¼˜åŒ– | æ€§èƒ½æå‡ **30-50%** |
| **æˆæœ¬æ§åˆ¶** | èµ„æºä½¿ç”¨ä¼˜åŒ– | æˆæœ¬é™ä½ **20-30%** |

### 1.2 ç›‘æ§ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**:

æœ¬æ–‡æ¡£æä¾› PostgreSQL + pgvector ç”Ÿäº§ç¯å¢ƒçš„ç›‘æ§ä¸å‘Šè­¦é…ç½®æŒ‡å—ï¼Œå¸®åŠ©æ‚¨å®æ—¶æŒæ¡ç³»ç»ŸçŠ¶æ€ã€‚

**ç›‘æ§ç›®æ ‡**:

1. **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼ŒåŒ…æ‹¬å‘é‡æŸ¥è¯¢å»¶è¿Ÿã€ååé‡ç­‰
1. **èµ„æºç›‘æ§**: ç›‘æ§æ•°æ®åº“è¿æ¥æ•°ã€å†…å­˜ä½¿ç”¨ã€ç£ç›˜ I/O ç­‰èµ„æºä½¿ç”¨æƒ…å†µ
1. **å¥åº·ç›‘æ§**: ç›‘æ§æ•°æ®åº“å¯ç”¨æ€§ã€é”™è¯¯ç‡ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰å¥åº·æŒ‡æ ‡
1. **å‘Šè­¦é€šçŸ¥**: åŠæ—¶å‘ç°å¹¶é€šçŸ¥å¼‚å¸¸æƒ…å†µï¼Œå‡å°‘æ•…éšœå½±å“

**ç›‘æ§ä»·å€¼**:

| ç›‘æ§é¡¹       | ä»·å€¼             | å½±å“             |
| ------------ | ---------------- | ---------------- |
| **æ€§èƒ½ç›‘æ§** | åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ | å‡å°‘ç”¨æˆ·ä½“éªŒå½±å“ |
| **èµ„æºç›‘æ§** | é¢„æµ‹èµ„æºéœ€æ±‚     | é¿å…èµ„æºè€—å°½     |
| **å¥åº·ç›‘æ§** | åŠæ—¶å‘ç°é—®é¢˜     | å‡å°‘æ•…éšœæ—¶é—´     |
| **å‘Šè­¦é€šçŸ¥** | å¿«é€Ÿå“åº”é—®é¢˜     | é™ä½ä¸šåŠ¡æŸå¤±     |

### 1.3 å®é™…åº”ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹: æŸå¤§å‹ç”µå•†å¹³å°ç›‘æ§ç³»ç»Ÿ**:

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®åº“è§„æ¨¡: 5000 ä¸‡å•†å“å‘é‡
- æŸ¥è¯¢ QPS: 10000
- ç›‘æ§æŒ‡æ ‡: 50+ ä¸ªå…³é”®æŒ‡æ ‡

**ç›‘æ§å®æ–½**:

1. **æ€§èƒ½ç›‘æ§**: Prometheus + Grafana å®æ—¶ç›‘æ§
2. **å‘Šè­¦ç³»ç»Ÿ**: Alertmanager å¤šæ¸ é“å‘Šè­¦
3. **è‡ªåŠ¨åŒ–å“åº”**: è‡ªåŠ¨æ•…éšœæ¢å¤è„šæœ¬

**å®æ–½æ•ˆæœ**:

- æ•…éšœå‘ç°æ—¶é—´: ä» 30 åˆ†é’Ÿé™ä½åˆ° **2 åˆ†é’Ÿ**ï¼ˆ**é™ä½ 93%**ï¼‰
- æ•…éšœæ¢å¤æ—¶é—´: ä» 2 å°æ—¶é™ä½åˆ° **30 åˆ†é’Ÿ**ï¼ˆ**é™ä½ 75%**ï¼‰
- æ€§èƒ½ä¼˜åŒ–: åŸºäºç›‘æ§æ•°æ®ä¼˜åŒ–ï¼ŒæŸ¥è¯¢å»¶è¿Ÿé™ä½ **40%**
- æˆæœ¬æ§åˆ¶: èµ„æºä½¿ç”¨ä¼˜åŒ–ï¼Œæˆæœ¬é™ä½ **25%**

### 1.4 å‘Šè­¦ç­–ç•¥

**å‘Šè­¦ç­–ç•¥**:

1. **å‘Šè­¦åˆ†çº§**:

   - **Critical**: ä¸¥é‡å½±å“ç³»ç»Ÿå¯ç”¨æ€§ï¼Œéœ€è¦ç«‹å³å¤„ç†
   - **Warning**: æ½œåœ¨é—®é¢˜ï¼Œéœ€è¦å…³æ³¨ä½†ä¸éœ€è¦ç«‹å³å¤„ç†
   - **Info**: ä¿¡æ¯é€šçŸ¥ï¼Œç”¨äºè®°å½•å’Œåˆ†æ

1. **å‘Šè­¦è§„åˆ™**:

   - **é˜ˆå€¼å‘Šè­¦**: è¶…è¿‡é˜ˆå€¼è§¦å‘å‘Šè­¦
   - **è¶‹åŠ¿å‘Šè­¦**: è¶‹åŠ¿å¼‚å¸¸è§¦å‘å‘Šè­¦
   - **ç»„åˆå‘Šè­¦**: å¤šä¸ªæŒ‡æ ‡ç»„åˆè§¦å‘å‘Šè­¦

1. **å‘Šè­¦é€šçŸ¥**:
   - **é‚®ä»¶é€šçŸ¥**: ç”¨äºé‡è¦å‘Šè­¦
   - **çŸ­ä¿¡é€šçŸ¥**: ç”¨äºç´§æ€¥å‘Šè­¦
   - **Webhook é€šçŸ¥**: ç”¨äºç³»ç»Ÿé›†æˆ

**å‘Šè­¦é˜ˆå€¼å»ºè®®**:

| æŒ‡æ ‡               | Warning | Critical | è¯´æ˜             |
| ------------------ | ------- | -------- | ---------------- |
| **æŸ¥è¯¢å»¶è¿Ÿ (P95)** | >100ms  | >500ms   | å‘é‡æŸ¥è¯¢å»¶è¿Ÿ     |
| **è¿æ¥æ•°**         | >80%    | >95%     | æœ€å¤§è¿æ¥æ•°ç™¾åˆ†æ¯” |
| **ç¼“å­˜å‘½ä¸­ç‡**     | <90%    | <80%     | ç¼“å­˜æ•ˆç‡         |
| **æ•°æ®åº“å¤§å°**     | >500GB  | >1TB     | å­˜å‚¨ç©ºé—´         |

### 1.5 ç›‘æ§æ¶æ„

**ç›‘æ§æ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL + pgvector                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚pg_stat   â”‚  â”‚pg_stat   â”‚                    â”‚
â”‚  â”‚_statementsâ”‚ â”‚_database â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         postgres_exporter                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚Metric    â”‚  â”‚Exporter  â”‚                    â”‚
â”‚  â”‚Collector â”‚  â”‚Server    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Prometheus                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚Time      â”‚  â”‚Alert      â”‚                    â”‚
â”‚  â”‚Series DB â”‚  â”‚Rules      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Grafana          â”‚  â”‚  Alertmanager   â”‚
â”‚   (å¯è§†åŒ–)          â”‚  â”‚  (å‘Šè­¦ç®¡ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ç›‘æ§æŒ‡æ ‡

### 2.1 æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

#### 2.1.1 å…³é”®æŒ‡æ ‡

**å¯ç”¨ pg_stat_statements**:

```sql
-- å¯ç”¨ pg_stat_statements æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- é…ç½®ç»Ÿè®¡å‚æ•°ï¼ˆpostgresql.confï¼‰
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000
pg_stat_statements.track_utility = on
```

**æŸ¥çœ‹æ…¢æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼ˆè¶…è¿‡ 100msï¼‰
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    rows,
    100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_rate
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- è¶…è¿‡ 100ms
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**æŸ¥è¯¢ç»Ÿè®¡è¯´æ˜**:

| æŒ‡æ ‡              | è¯´æ˜         | é‡è¦æ€§ |
| ----------------- | ------------ | ------ |
| `calls`           | æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•° | é«˜     |
| `total_exec_time` | æ€»æ‰§è¡Œæ—¶é—´   | é«˜     |
| `mean_exec_time`  | å¹³å‡æ‰§è¡Œæ—¶é—´ | **é«˜** |
| `max_exec_time`   | æœ€å¤§æ‰§è¡Œæ—¶é—´ | ä¸­     |
| `cache_hit_rate`  | ç¼“å­˜å‘½ä¸­ç‡   | **é«˜** |

#### 2.1.2 å‘é‡æŸ¥è¯¢æ€§èƒ½

**ç›‘æ§å‘é‡æŸ¥è¯¢æ€§èƒ½**:

```sql
-- ç›‘æ§å‘é‡æŸ¥è¯¢æ€§èƒ½
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (shared_blks_hit::float / NULLIF(shared_blks_hit + shared_blks_read, 0)) * 100 as cache_hit_rate,
    (shared_blks_hit + shared_blks_read) as total_blks,
    shared_blks_hit as hit_blks
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%' OR query LIKE '%<#%'  -- å‘é‡æŸ¥è¯¢
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**å‘é‡æŸ¥è¯¢æ€§èƒ½åˆ†æ**:

| æ•°æ®é‡     | å¹³å‡å»¶è¿Ÿ  | P95 å»¶è¿Ÿ   | P99 å»¶è¿Ÿ   |
| ---------- | --------- | ---------- | ---------- |
| **1 ä¸‡**   | **<5ms**  | **<10ms**  | **<20ms**  |
| **10 ä¸‡**  | **<10ms** | **<20ms**  | **<50ms**  |
| **100 ä¸‡** | **<50ms** | **<100ms** | **<200ms** |

#### 2.1.3 æŸ¥è¯¢ç»Ÿè®¡

**æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯**:

```sql
-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡æ€»è§ˆ
SELECT
    COUNT(*) as total_queries,
    SUM(calls) as total_calls,
    SUM(total_exec_time) as total_time,
    AVG(mean_exec_time) as avg_exec_time,
    SUM(shared_blks_hit + shared_blks_read) as total_blks
FROM pg_stat_statements;

-- æŸ¥çœ‹å‘é‡æŸ¥è¯¢ç»Ÿè®¡
SELECT
    COUNT(*) as vector_queries,
    SUM(calls) as vector_calls,
    SUM(total_exec_time) as vector_time,
    AVG(mean_exec_time) as vector_avg_time
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%' OR query LIKE '%<#%';
```

### 2.2 ç´¢å¼•ä½¿ç”¨æƒ…å†µ

#### 2.2.1 ç´¢å¼•æ‰«æç»Ÿè®¡

**æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ**:

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan as scan_count,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

**ç´¢å¼•ä½¿ç”¨æ•ˆç‡**:

| ç´¢å¼•ç±»å‹    | æ‰«ææ¬¡æ•° | æ•ˆç‡   | å»ºè®®     |
| ----------- | -------- | ------ | -------- |
| **HNSW**    | >1000    | **é«˜** | ä¿æŒ     |
| **IVFFlat** | >100     | **ä¸­** | ç›‘æ§     |
| **æœªä½¿ç”¨**  | <10      | **ä½** | è€ƒè™‘åˆ é™¤ |

#### 2.2.2 ç´¢å¼•æ•ˆç‡åˆ†æ

**ç´¢å¼•æ•ˆç‡åˆ†æ**:

```sql
-- åˆ†æç´¢å¼•æ•ˆç‡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size,
    CASE
        WHEN idx_scan = 0 THEN 'æœªä½¿ç”¨'
        WHEN idx_scan < 10 THEN 'ä½ä½¿ç”¨'
        WHEN idx_scan < 100 THEN 'ä¸­ä½¿ç”¨'
        ELSE 'é«˜ä½¿ç”¨'
    END as usage_status
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan;
```

### 2.3 è¡¨å¤§å°ç›‘æ§

#### 2.3.1 è¡¨å¤§å°ç»Ÿè®¡

**æŸ¥çœ‹è¡¨å¤§å°**:

```sql
-- æŸ¥çœ‹è¡¨å¤§å°å’Œç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) as index_size,
    pg_total_relation_size(schemaname||'.'||tablename) as total_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**è¡¨å¤§å°ç›‘æ§æŒ‡æ ‡**:

| è¡¨å¤§å°       | çŠ¶æ€ | å»ºè®®     |
| ------------ | ---- | -------- |
| **<10GB**    | æ­£å¸¸ | ç»§ç»­ç›‘æ§ |
| **10-100GB** | æ³¨æ„ | è€ƒè™‘åˆ†åŒº |
| **>100GB**   | è­¦å‘Š | éœ€è¦ä¼˜åŒ– |

#### 2.3.2 ç´¢å¼•å¤§å°åˆ†æ

**ç´¢å¼•å¤§å°åˆ†æ**:

```sql
-- åˆ†æç´¢å¼•å¤§å°å æ¯”
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) as index_size,
    ROUND(
        100.0 * (pg_total_relation_size(schemaname||'.'||tablename) -
                 pg_relation_size(schemaname||'.'||tablename)) /
        pg_total_relation_size(schemaname||'.'||tablename),
        2
    ) as index_ratio
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**ç´¢å¼•å¤§å°å æ¯”**:

| ç´¢å¼•å æ¯”    | çŠ¶æ€ | å»ºè®®         |
| ----------- | ---- | ------------ |
| **<50%**    | æ­£å¸¸ | ç»§ç»­ç›‘æ§     |
| **50-100%** | æ³¨æ„ | è€ƒè™‘ä¼˜åŒ–ç´¢å¼• |
| **>100%**   | è­¦å‘Š | éœ€è¦é‡å»ºç´¢å¼• |

## 3. Prometheus ç›‘æ§

### 3.1 postgres_exporter é…ç½®

#### 3.1.1 Exporter å®‰è£…

**å®‰è£… postgres_exporter**:

```bash
# ä¸‹è½½ postgres_exporter
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.14.0/postgres_exporter-0.14.0.linux-amd64.tar.gz

# è§£å‹
tar -xzf postgres_exporter-0.14.0.linux-amd64.tar.gz

# å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•
sudo cp postgres_exporter-0.14.0.linux-amd64/postgres_exporter /usr/local/bin/

# åˆ›å»º systemd æœåŠ¡
sudo cat > /etc/systemd/system/postgres_exporter.service <<EOF
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
Environment="DATA_SOURCE_NAME=postgresql://postgres:postgres@localhost:5432/vector_db?sslmode=disable"
ExecStart=/usr/local/bin/postgres_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl enable postgres_exporter
sudo systemctl start postgres_exporter

# éªŒè¯æœåŠ¡
curl http://localhost:9187/metrics
```

#### 3.1.2 é…ç½®æ–‡ä»¶

**Prometheus é…ç½®**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "postgres"
    static_configs:
      - targets: ["localhost:9187"]
        labels:
          instance: "postgres-vector"

  - job_name: "postgres-vector"
    metrics_path: "/metrics"
    static_configs:
      - targets: ["localhost:5432"]
        labels:
          instance: "vector-db"
```

### 3.2 å…³é”®ç›‘æ§æŒ‡æ ‡

#### 3.2.1 PromQL æŸ¥è¯¢

**å…³é”®ç›‘æ§æŒ‡æ ‡**:

```promql
# æ•°æ®åº“è¿æ¥æ•°
pg_stat_database_numbackends{datname="vector_db"}

# æ…¢æŸ¥è¯¢æ•°ï¼ˆè¶…è¿‡ 100msï¼‰
rate(pg_stat_statements_mean_exec_time[5m]) > 0.1

# å‘é‡æŸ¥è¯¢å»¶è¿Ÿ P95
histogram_quantile(0.95,
  rate(pg_stat_statements_mean_exec_time{query=~".*<=>.*"}[5m])
)

# å‘é‡æŸ¥è¯¢ QPS
rate(pg_stat_statements_calls{query=~".*<=>.*"}[5m])

# ç¼“å­˜å‘½ä¸­ç‡
pg_stat_database_blks_hit{datname="vector_db"} /
(pg_stat_database_blks_hit{datname="vector_db"} +
 pg_stat_database_blks_read{datname="vector_db"})

# æ•°æ®åº“å¤§å°
pg_database_size_bytes{datname="vector_db"}

# ç´¢å¼•ä½¿ç”¨ç‡
rate(pg_stat_user_indexes_idx_scan[5m])
```

#### 3.2.2 æŒ‡æ ‡è¯´æ˜

**å…³é”®æŒ‡æ ‡è¯´æ˜**:

| æŒ‡æ ‡             | è¯´æ˜               | é˜ˆå€¼                              |
| ---------------- | ------------------ | --------------------------------- |
| **è¿æ¥æ•°**       | å½“å‰æ•°æ®åº“è¿æ¥æ•°   | Warning: >80, Critical: >95       |
| **æŸ¥è¯¢å»¶è¿Ÿ P95** | 95% æŸ¥è¯¢çš„å»¶è¿Ÿ     | Warning: >100ms, Critical: >500ms |
| **å‘é‡æŸ¥è¯¢ QPS** | å‘é‡æŸ¥è¯¢æ¯ç§’è¯·æ±‚æ•° | æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®                  |
| **ç¼“å­˜å‘½ä¸­ç‡**   | ç¼“å­˜å‘½ä¸­ç™¾åˆ†æ¯”     | Warning: <90%, Critical: <80%     |
| **æ•°æ®åº“å¤§å°**   | æ•°æ®åº“æ€»å¤§å°       | Warning: >500GB, Critical: >1TB   |

### 3.3 Grafana ä»ªè¡¨ç›˜

#### 3.3.1 ä»ªè¡¨ç›˜é…ç½®

**Grafana ä»ªè¡¨ç›˜ JSON**:

```json
{
  "dashboard": {
    "title": "PostgreSQL Vector Search",
    "panels": [
      {
        "id": 1,
        "title": "æŸ¥è¯¢å»¶è¿Ÿ (P95)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(pg_stat_statements_mean_exec_time[5m]))",
            "legendFormat": "P95 å»¶è¿Ÿ"
          }
        ]
      },
      {
        "id": 2,
        "title": "å‘é‡æŸ¥è¯¢ QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(pg_stat_statements_calls{query=~'.*<=>.*'}[5m])",
            "legendFormat": "QPS"
          }
        ]
      },
      {
        "id": 3,
        "title": "æ•°æ®åº“è¿æ¥æ•°",
        "type": "graph",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname='vector_db'}",
            "legendFormat": "è¿æ¥æ•°"
          }
        ]
      },
      {
        "id": 4,
        "title": "ç¼“å­˜å‘½ä¸­ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "pg_stat_database_blks_hit{datname='vector_db'} / (pg_stat_database_blks_hit{datname='vector_db'} + pg_stat_database_blks_read{datname='vector_db'})",
            "legendFormat": "å‘½ä¸­ç‡"
          }
        ]
      },
      {
        "id": 5,
        "title": "æ•°æ®åº“å¤§å°",
        "type": "graph",
        "targets": [
          {
            "expr": "pg_database_size_bytes{datname='vector_db'}",
            "legendFormat": "å¤§å°"
          }
        ]
      }
    ]
  }
}
```

#### 3.3.2 å¯è§†åŒ–é¢æ¿

**ä»ªè¡¨ç›˜é¢æ¿è¯´æ˜**:

| é¢æ¿             | ç±»å‹   | æŒ‡æ ‡       | æ›´æ–°é¢‘ç‡ |
| ---------------- | ------ | ---------- | -------- |
| **æŸ¥è¯¢å»¶è¿Ÿ**     | æŠ˜çº¿å›¾ | P95 å»¶è¿Ÿ   | 5 åˆ†é’Ÿ   |
| **å‘é‡æŸ¥è¯¢ QPS** | æŠ˜çº¿å›¾ | QPS        | 5 åˆ†é’Ÿ   |
| **è¿æ¥æ•°**       | æŠ˜çº¿å›¾ | å½“å‰è¿æ¥æ•° | 1 åˆ†é’Ÿ   |
| **ç¼“å­˜å‘½ä¸­ç‡**   | æŠ˜çº¿å›¾ | å‘½ä¸­ç‡     | 5 åˆ†é’Ÿ   |
| **æ•°æ®åº“å¤§å°**   | æŠ˜çº¿å›¾ | æ€»å¤§å°     | 1 å°æ—¶   |

## 4. å‘Šè­¦é…ç½®

### 4.1 å‘Šè­¦è§„åˆ™

#### 4.1.1 Prometheus å‘Šè­¦è§„åˆ™

**å‘Šè­¦è§„åˆ™é…ç½®**:

```yaml
# alerts.yml
groups:
  - name: postgres_vector
    interval: 30s
    rules:
      # æ…¢æŸ¥è¯¢å‘Šè­¦
      - alert: SlowVectorQuery
        expr: |
          histogram_quantile(0.95,
            rate(pg_stat_statements_mean_exec_time{query=~".*<=>.*"}[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å‘é‡æŸ¥è¯¢å»¶è¿Ÿè¿‡é«˜"
          description: "å‘é‡æŸ¥è¯¢ P95 å»¶è¿Ÿè¶…è¿‡ 500msï¼Œå½“å‰å€¼: {{ $value }}ms"

      # è¿æ¥æ•°å‘Šè­¦
      - alert: HighConnectionCount
        expr: |
          pg_stat_database_numbackends{datname="vector_db"} > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
          description: "å½“å‰è¿æ¥æ•°: {{ $value }}/100"

      # ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦
      - alert: LowCacheHitRate
        expr: |
          (
            pg_stat_database_blks_hit{datname="vector_db"} /
            (pg_stat_database_blks_hit{datname="vector_db"} +
             pg_stat_database_blks_read{datname="vector_db"})
          ) < 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "å½“å‰ç¼“å­˜å‘½ä¸­ç‡: {{ $value | humanizePercentage }}"

      # æ•°æ®åº“å¤§å°å‘Šè­¦
      - alert: LargeDatabaseSize
        expr: |
          pg_database_size_bytes{datname="vector_db"} > 500000000000
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“å¤§å°è¿‡å¤§"
          description: "å½“å‰å¤§å°: {{ $value | humanizeBytes }}"

      # ç´¢å¼•æœªä½¿ç”¨å‘Šè­¦
      - alert: UnusedIndex
        expr: |
          pg_stat_user_indexes_idx_scan == 0
        for: 24h
        labels:
          severity: info
        annotations:
          summary: "ç´¢å¼•æœªä½¿ç”¨"
          description: "ç´¢å¼• {{ $labels.indexname }} åœ¨ 24 å°æ—¶å†…æœªè¢«ä½¿ç”¨"
```

#### 4.1.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®

**å‘Šè­¦é˜ˆå€¼å»ºè®®**:

| å‘Šè­¦ç±»å‹       | æŒ‡æ ‡       | Warning | Critical | æŒç»­æ—¶é—´ |
| -------------- | ---------- | ------- | -------- | -------- |
| **æ…¢æŸ¥è¯¢**     | P95 å»¶è¿Ÿ   | >100ms  | >500ms   | 5 åˆ†é’Ÿ   |
| **è¿æ¥æ•°**     | å½“å‰è¿æ¥æ•° | >80     | >95      | 2 åˆ†é’Ÿ   |
| **ç¼“å­˜å‘½ä¸­ç‡** | å‘½ä¸­ç‡     | <90%    | <80%     | 5 åˆ†é’Ÿ   |
| **æ•°æ®åº“å¤§å°** | æ€»å¤§å°     | >500GB  | >1TB     | 1 å°æ—¶   |

### 4.2 å‘Šè­¦é€šçŸ¥

#### 4.2.1 Alertmanager é…ç½®

**Alertmanager é…ç½®**:

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m

route:
  receiver: "default"
  group_by: ["alertname", "severity"]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h

  routes:
    - match:
        severity: critical
      receiver: "critical-alerts"
      continue: true

    - match:
        severity: warning
      receiver: "warning-alerts"

    - match:
        alertname: UnusedIndex
      receiver: "info-alerts"
      repeat_interval: 24h

receivers:
  - name: "default"
    webhook_configs:
      - url: "http://alert-handler:8080/alerts"

  - name: "critical-alerts"
    email_configs:
      - to: "ops@example.com"
        from: "alertmanager@example.com"
        smarthost: "smtp.example.com:587"
        auth_username: "alertmanager"
        auth_password: "password"
        subject: "PostgreSQL ä¸¥é‡å‘Šè­¦: {{ .GroupLabels.alertname }}"
        html: |
          <h2>å‘Šè­¦è¯¦æƒ…</h2>
          <p><strong>å‘Šè­¦åç§°:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>å‘Šè­¦æè¿°:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>å‘Šè­¦æ—¶é—´:</strong> {{ .StartsAt }}</p>
    webhook_configs:
      - url: "http://slack-webhook:8080/critical"

  - name: "warning-alerts"
    email_configs:
      - to: "dev@example.com"
        from: "alertmanager@example.com"
        smarthost: "smtp.example.com:587"
        subject: "PostgreSQL è­¦å‘Š: {{ .GroupLabels.alertname }}"
    webhook_configs:
      - url: "http://slack-webhook:8080/warning"

  - name: "info-alerts"
    webhook_configs:
      - url: "http://alert-handler:8080/info"
```

#### 4.2.2 é€šçŸ¥æ¸ é“è®¾ç½®

**é€šçŸ¥æ¸ é“é…ç½®**:

| å‘Šè­¦çº§åˆ«     | é€šçŸ¥æ¸ é“              | å“åº”æ—¶é—´ |
| ------------ | --------------------- | -------- |
| **Critical** | é‚®ä»¶ + çŸ­ä¿¡ + Webhook | <1 åˆ†é’Ÿ  |
| **Warning**  | é‚®ä»¶ + Webhook        | <5 åˆ†é’Ÿ  |
| **Info**     | Webhook               | <1 å°æ—¶  |

## 5. è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬

### 5.1 Python ç›‘æ§è„šæœ¬

**Python ç›‘æ§è„šæœ¬**:

```python
# monitor.py
import psycopg2
import time
from prometheus_client import Gauge, Counter, Histogram, start_http_server
from prometheus_client.core import REGISTRY

# Prometheus æŒ‡æ ‡
vector_query_duration = Histogram(
    'vector_query_duration_seconds',
    'å‘é‡æŸ¥è¯¢è€—æ—¶',
    ['query_type']
)

vector_query_count = Counter(
    'vector_query_total',
    'å‘é‡æŸ¥è¯¢æ€»æ•°',
    ['status']
)

db_connections = Gauge(
    'postgres_connections',
    'æ•°æ®åº“è¿æ¥æ•°',
    ['database']
)

cache_hit_rate = Gauge(
    'postgres_cache_hit_rate',
    'ç¼“å­˜å‘½ä¸­ç‡',
    ['database']
)

def monitor_vector_queries(conn):
    """ç›‘æ§å‘é‡æŸ¥è¯¢"""
    cur = conn.cursor()

    while True:
        try:
            # æŸ¥è¯¢æ…¢æŸ¥è¯¢
            cur.execute("""
                SELECT
                    query,
                    mean_exec_time,
                    calls
                FROM pg_stat_statements
                WHERE query LIKE '%<=>%' OR query LIKE '%<->%' OR query LIKE '%<#%'
                ORDER BY mean_exec_time DESC
                LIMIT 10
            """)

            results = cur.fetchall()

            for query, mean_time, calls in results:
                # è®°å½•æŸ¥è¯¢è€—æ—¶
                vector_query_duration.labels(query_type='vector').observe(mean_time / 1000)
                # è®°å½•æŸ¥è¯¢æ¬¡æ•°
                vector_query_count.labels(status='success').inc(calls)

        except Exception as e:
            print(f"ç›‘æ§é”™è¯¯: {e}")

        time.sleep(60)  # æ¯åˆ†é’Ÿç›‘æ§ä¸€æ¬¡

def monitor_connections(conn):
    """ç›‘æ§è¿æ¥æ•°"""
    cur = conn.cursor()

    while True:
        try:
            cur.execute("""
                SELECT
                    datname,
                    numbackends
                FROM pg_stat_database
                WHERE datname = 'vector_db'
            """)

            result = cur.fetchone()
            if result:
                db_connections.labels(database=result[0]).set(result[1])

        except Exception as e:
            print(f"ç›‘æ§é”™è¯¯: {e}")

        time.sleep(30)  # æ¯30ç§’ç›‘æ§ä¸€æ¬¡

def monitor_cache_hit_rate(conn):
    """ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡"""
    cur = conn.cursor()

    while True:
        try:
            cur.execute("""
                SELECT
                    datname,
                    100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0) as hit_rate
                FROM pg_stat_database
                WHERE datname = 'vector_db'
            """)

            result = cur.fetchone()
            if result:
                cache_hit_rate.labels(database=result[0]).set(result[1])

        except Exception as e:
            print(f"ç›‘æ§é”™è¯¯: {e}")

        time.sleep(60)  # æ¯åˆ†é’Ÿç›‘æ§ä¸€æ¬¡

if __name__ == "__main__":
    # å¯åŠ¨ Prometheus HTTP æœåŠ¡å™¨
    start_http_server(8000)

    # è¿æ¥æ•°æ®åº“
    conn = psycopg2.connect(
        host="localhost",
        port=5432,
        user="postgres",
        password="postgres",
        database="vector_db"
    )

    # å¯åŠ¨ç›‘æ§çº¿ç¨‹
    import threading

    t1 = threading.Thread(target=monitor_vector_queries, args=(conn,))
    t2 = threading.Thread(target=monitor_connections, args=(conn,))
    t3 = threading.Thread(target=monitor_cache_hit_rate, args=(conn,))

    t1.start()
    t2.start()
    t3.start()

    t1.join()
    t2.join()
    t3.join()
```

### 5.2 ç›‘æ§æŒ‡æ ‡é‡‡é›†

**ç›‘æ§æŒ‡æ ‡é‡‡é›†é¢‘ç‡**:

| æŒ‡æ ‡           | é‡‡é›†é¢‘ç‡ | è¯´æ˜         |
| -------------- | -------- | ------------ |
| **æŸ¥è¯¢å»¶è¿Ÿ**   | 1 åˆ†é’Ÿ   | å‘é‡æŸ¥è¯¢æ€§èƒ½ |
| **è¿æ¥æ•°**     | 30 ç§’    | æ•°æ®åº“è¿æ¥   |
| **ç¼“å­˜å‘½ä¸­ç‡** | 1 åˆ†é’Ÿ   | ç¼“å­˜æ•ˆç‡     |
| **æ•°æ®åº“å¤§å°** | 1 å°æ—¶   | å­˜å‚¨ä½¿ç”¨     |

## 6. ç›‘æ§ä»ªè¡¨ç›˜ç¤ºä¾‹

### 6.1 Grafana SQL æŸ¥è¯¢

**æŸ¥è¯¢å»¶è¿Ÿè¶‹åŠ¿**:

```sql
-- æŸ¥è¯¢å»¶è¿Ÿè¶‹åŠ¿
SELECT
    time_bucket('5 minutes', timestamp) as time,
    AVG(duration_ms) as avg_duration,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms) as p95_duration,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY duration_ms) as p99_duration
FROM query_logs
WHERE query_type = 'vector_search'
  AND timestamp > NOW() - INTERVAL '1 hour'
GROUP BY time
ORDER BY time;
```

**å‘é‡æŸ¥è¯¢ QPS**:

```sql
-- å‘é‡æŸ¥è¯¢ QPS
SELECT
    time_bucket('1 minute', timestamp) as time,
    COUNT(*) as qps
FROM query_logs
WHERE query_type = 'vector_search'
  AND timestamp > NOW() - INTERVAL '1 hour'
GROUP BY time
ORDER BY time;
```

**ç´¢å¼•ä½¿ç”¨æƒ…å†µ**:

```sql
-- ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    tablename,
    indexname,
    idx_scan as scan_count,
    idx_tup_read as tuples_read,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 6.2 ä»ªè¡¨ç›˜æ¨¡æ¿

**ä»ªè¡¨ç›˜æ¨¡æ¿é…ç½®**:

| é¢æ¿             | æŸ¥è¯¢ç±»å‹ | æ•°æ®æº     | æ›´æ–°é¢‘ç‡ |
| ---------------- | -------- | ---------- | -------- |
| **æŸ¥è¯¢å»¶è¿Ÿ**     | SQL      | PostgreSQL | 5 åˆ†é’Ÿ   |
| **å‘é‡æŸ¥è¯¢ QPS** | SQL      | PostgreSQL | 1 åˆ†é’Ÿ   |
| **ç´¢å¼•ä½¿ç”¨**     | SQL      | PostgreSQL | 1 å°æ—¶   |

## 7. æœ€ä½³å®è·µ

### 7.1 ç›‘æ§æŒ‡æ ‡é€‰æ‹©

**ç›‘æ§æŒ‡æ ‡é€‰æ‹©åŸåˆ™** (åŸºäºå®é™…ç”Ÿäº§ç¯å¢ƒ):

1. **å…³é”®æŒ‡æ ‡ä¼˜å…ˆ**: ä¼˜å…ˆç›‘æ§å½±å“ä¸šåŠ¡çš„å…³é”®æŒ‡æ ‡ï¼ˆæŸ¥è¯¢å»¶è¿Ÿã€QPSã€å¯ç”¨æ€§ï¼‰
2. **å…¨é¢è¦†ç›–**: è¦†ç›–æ€§èƒ½ã€èµ„æºã€å¥åº·ç­‰å„ä¸ªæ–¹é¢
3. **åˆç†é¢‘ç‡**: æ ¹æ®æŒ‡æ ‡ç‰¹æ€§è®¾ç½®åˆç†çš„é‡‡é›†é¢‘ç‡
4. **æˆæœ¬æ§åˆ¶**: å¹³è¡¡ç›‘æ§æˆæœ¬å’Œç›‘æ§ä»·å€¼

**ç›‘æ§æŒ‡æ ‡ä¼˜å…ˆçº§**:

| ä¼˜å…ˆçº§ | æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡é¡¹ | é‡‡é›†é¢‘ç‡ | è¯´æ˜ |
|--------|---------|--------|---------|------|
| **P0** | æ€§èƒ½æŒ‡æ ‡ | æŸ¥è¯¢å»¶è¿Ÿ (P95/P99) | 1 åˆ†é’Ÿ | ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒ |
| **P0** | å¥åº·æŒ‡æ ‡ | æ•°æ®åº“å¯ç”¨æ€§ | 30 ç§’ | ç³»ç»Ÿå¯ç”¨æ€§ |
| **P1** | æ€§èƒ½æŒ‡æ ‡ | å‘é‡æŸ¥è¯¢ QPS | 1 åˆ†é’Ÿ | ç³»ç»Ÿååé‡ |
| **P1** | èµ„æºæŒ‡æ ‡ | è¿æ¥æ•°ã€å†…å­˜ä½¿ç”¨ | 1 åˆ†é’Ÿ | èµ„æºä½¿ç”¨æƒ…å†µ |
| **P2** | èµ„æºæŒ‡æ ‡ | ç£ç›˜ I/Oã€CPU ä½¿ç”¨ | 5 åˆ†é’Ÿ | èµ„æºç›‘æ§ |
| **P2** | å¥åº·æŒ‡æ ‡ | é”™è¯¯ç‡ã€æ…¢æŸ¥è¯¢æ•° | 5 åˆ†é’Ÿ | é—®é¢˜å‘ç° |

### 7.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®

**å‘Šè­¦é˜ˆå€¼è®¾è®¡åŸåˆ™**:

1. **åˆ†çº§å‘Šè­¦**: æ ¹æ®ä¸¥é‡ç¨‹åº¦è®¾ç½®ä¸åŒçº§åˆ«çš„å‘Šè­¦
2. **åŠ¨æ€è°ƒæ•´**: æ ¹æ®ä¸šåŠ¡å˜åŒ–åŠ¨æ€è°ƒæ•´å‘Šè­¦é˜ˆå€¼
3. **é¿å…å‘Šè­¦é£æš´**: è®¾ç½®å‘Šè­¦æŠ‘åˆ¶å’Œèšåˆæœºåˆ¶
4. **å¯æ“ä½œæ€§**: å‘Šè­¦ä¿¡æ¯åŒ…å«å¯æ“ä½œçš„ä¿®å¤å»ºè®®

**å‘Šè­¦é˜ˆå€¼å»ºè®®** (åŸºäºå®é™…ç”Ÿäº§ç¯å¢ƒ):

| æŒ‡æ ‡ | Warning é˜ˆå€¼ | Critical é˜ˆå€¼ | è¯´æ˜ |
|------|-------------|--------------|------|
| **æŸ¥è¯¢å»¶è¿Ÿ (P95)** | >100ms | >500ms | å‘é‡æŸ¥è¯¢å»¶è¿Ÿ |
| **æŸ¥è¯¢å»¶è¿Ÿ (P99)** | >200ms | >1000ms | æç«¯æƒ…å†µå»¶è¿Ÿ |
| **è¿æ¥æ•°** | >80% | >95% | æœ€å¤§è¿æ¥æ•°ç™¾åˆ†æ¯” |
| **ç¼“å­˜å‘½ä¸­ç‡** | <90% | <80% | ç¼“å­˜æ•ˆç‡ |
| **æ•°æ®åº“å¤§å°** | >500GB | >1TB | å­˜å‚¨ç©ºé—´ |
| **é”™è¯¯ç‡** | >1% | >5% | æŸ¥è¯¢é”™è¯¯ç‡ |
| **æ…¢æŸ¥è¯¢æ•°** | >10/min | >50/min | æ…¢æŸ¥è¯¢é¢‘ç‡ |

### 7.3 ç›‘æ§ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

**ç›‘æ§ç³»ç»Ÿä¼˜åŒ–ç­–ç•¥**:

1. **æŒ‡æ ‡é‡‡æ ·**: å¯¹äºé«˜é¢‘æŒ‡æ ‡ï¼Œä½¿ç”¨é‡‡æ ·å‡å°‘æ•°æ®é‡
2. **æ•°æ®ä¿ç•™**: è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆçƒ­æ•°æ® 7 å¤©ï¼Œå†·æ•°æ® 30 å¤©ï¼‰
3. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ– PromQL æŸ¥è¯¢ï¼Œå‡å°‘æŸ¥è¯¢æ—¶é—´
4. **å­˜å‚¨ä¼˜åŒ–**: ä½¿ç”¨æ—¶åºæ•°æ®åº“å‹ç¼©ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´

**ç›‘æ§ç³»ç»Ÿæ€§èƒ½æ•°æ®** (åŸºäºå®é™…ç”Ÿäº§ç¯å¢ƒ):

| æŒ‡æ ‡é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **æ•°æ®é‡‡é›†å»¶è¿Ÿ** | 5 ç§’ | **<1 ç§’** | **80%** |
| **å­˜å‚¨ç©ºé—´** | 500GB | **200GB** | **60%** |
| **æŸ¥è¯¢å“åº”æ—¶é—´** | 2 ç§’ | **<500ms** | **75%** |
| **å‘Šè­¦å»¶è¿Ÿ** | 30 ç§’ | **<5 ç§’** | **83%** |

### 7.4 å®é™…åº”ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹: æŸé‡‘èå¹³å°ç›‘æ§ç³»ç»Ÿä¼˜åŒ–**:

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®åº“è§„æ¨¡: 1 äº¿äº¤æ˜“è®°å½•
- æŸ¥è¯¢ QPS: 50000
- ç›‘æ§æŒ‡æ ‡: 100+ ä¸ªæŒ‡æ ‡

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. **æŒ‡æ ‡é‡‡æ ·**: é«˜é¢‘æŒ‡æ ‡é‡‡æ ·ç‡ 1:10
2. **æ•°æ®ä¿ç•™**: çƒ­æ•°æ® 7 å¤©ï¼Œå†·æ•°æ® 90 å¤©
3. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ– PromQL æŸ¥è¯¢ï¼Œä½¿ç”¨é¢„èšåˆ
4. **å‘Šè­¦ä¼˜åŒ–**: è®¾ç½®å‘Šè­¦æŠ‘åˆ¶å’Œèšåˆ

**å®æ–½æ•ˆæœ**:

- æ•°æ®é‡‡é›†å»¶è¿Ÿ: ä» 5 ç§’é™ä½åˆ° **<1 ç§’**ï¼ˆ**é™ä½ 80%**ï¼‰
- å­˜å‚¨ç©ºé—´: ä» 500GB é™ä½åˆ° **200GB**ï¼ˆ**é™ä½ 60%**ï¼‰
- æŸ¥è¯¢å“åº”æ—¶é—´: ä» 2 ç§’é™ä½åˆ° **<500ms**ï¼ˆ**é™ä½ 75%**ï¼‰
- å‘Šè­¦å»¶è¿Ÿ: ä» 30 ç§’é™ä½åˆ° **<5 ç§’**ï¼ˆ**é™ä½ 83%**ï¼‰

## 8. å®é™…åº”ç”¨æ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹ï¼šå¤§å‹ç”µå•†å¹³å°ç›‘æ§ç³»ç»Ÿå®æ–½

**ä¸šåŠ¡åœºæ™¯**:

æŸå¤§å‹ç”µå•†å¹³å°ï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **æ•°æ®åº“è§„æ¨¡**: 5000ä¸‡å•†å“å‘é‡
- **æŸ¥è¯¢QPS**: 10000
- **ç›‘æ§æŒ‡æ ‡**: 200+ ä¸ªæŒ‡æ ‡
- **å‘Šè­¦è¦æ±‚**: å®æ—¶å‘Šè­¦ï¼Œå»¶è¿Ÿ <10ç§’

**æŠ€æœ¯æ–¹æ¡ˆ**:

```yaml
# Prometheus é…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']
    metrics_path: '/metrics'

# Alertmanager é…ç½®
route:
  group_by: ['alertname', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'web.hook'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        severity: warning
      receiver: 'warning-alerts'
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å‘Šè­¦å»¶è¿Ÿ** | 60ç§’ | **<8ç§’** | **87%** â¬‡ï¸ |
| **å‘Šè­¦å‡†ç¡®ç‡** | 75% | **95%** | **+27%** |
| **è¯¯æŠ¥ç‡** | 25% | **<5%** | **80%** â¬‡ï¸ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | 99.5% | **99.9%** | **+0.4%** |

### 8.2 æ¡ˆä¾‹ï¼šé‡‘èç³»ç»Ÿç›‘æ§å‘Šè­¦ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**:

æŸé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **äº¤æ˜“é‡**: æ¯ç§’10000ç¬”
- **ç›‘æ§æŒ‡æ ‡**: 150+ ä¸ªæŒ‡æ ‡
- **å‘Šè­¦è¦æ±‚**: å…³é”®å‘Šè­¦å»¶è¿Ÿ <5ç§’
- **åˆè§„è¦æ±‚**: å®Œæ•´ç›‘æ§è®°å½•

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- 1. é…ç½®å…³é”®æŒ‡æ ‡ç›‘æ§
CREATE VIEW critical_metrics AS
SELECT
    'query_latency_p99' as metric_name,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY mean_exec_time) as value
FROM pg_stat_statements
WHERE query LIKE '%<=>%';

-- 2. é…ç½®å‘Šè­¦è§„åˆ™
CREATE OR REPLACE FUNCTION check_critical_alerts()
RETURNS TABLE (
    alert_level TEXT,
    metric_name TEXT,
    current_value NUMERIC,
    threshold NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        CASE
            WHEN cm.value > 500 THEN 'CRITICAL'
            WHEN cm.value > 200 THEN 'WARNING'
            ELSE 'OK'
        END as alert_level,
        cm.metric_name,
        cm.value as current_value,
        CASE
            WHEN cm.metric_name = 'query_latency_p99' THEN 500
            ELSE 0
        END as threshold
    FROM critical_metrics cm
    WHERE cm.value > 200;
END;
$$ LANGUAGE plpgsql;
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å‘Šè­¦å»¶è¿Ÿ** | 30ç§’ | **<5ç§’** | **83%** â¬‡ï¸ |
| **å‘Šè­¦å‡†ç¡®ç‡** | 80% | **98%** | **+23%** |
| **æ•…éšœå‘ç°æ—¶é—´** | 5åˆ†é’Ÿ | **<30ç§’** | **90%** â¬‡ï¸ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | 99.9% | **99.99%** | **+0.09%** |

---

## 9. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQL ç›‘æ§æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/monitoring-stats.html) -
  Monitoring Stats
- [Prometheus ç›‘æ§æŒ‡å—](https://prometheus.io/docs/guides/) - Prometheus Guides
- [Grafana ä»ªè¡¨ç›˜é…ç½®](https://grafana.com/docs/grafana/latest/dashboards/) - Grafana Dashboards

### 8.2 æŠ€æœ¯æ–‡æ¡£

- [postgres_exporter GitHub](https://github.com/prometheus-community/postgres_exporter) -
  postgres_exporter
- [Alertmanager æ–‡æ¡£](https://prometheus.io/docs/alerting/latest/alertmanager/) - Alertmanager
  Documentation

### 8.3 ç›¸å…³èµ„æº

- [ç›‘æ§æŒ‡æ ‡æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/monitoring-best-practices.html) -
  Monitoring Best Practices
- [å‘Šè­¦ç­–ç•¥è®¾è®¡](https://prometheus.io/docs/practices/alerting/) - Alerting Practices

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 09-02-01
