# å‘é‡ç´¢å¼•ç®—æ³•å¯¹æ¯”

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 01-01-03

## ğŸ“‘ ç›®å½•

- [å‘é‡ç´¢å¼•ç®—æ³•å¯¹æ¯”](#å‘é‡ç´¢å¼•ç®—æ³•å¯¹æ¯”)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 å¯¹æ¯”ç›®æ ‡](#12-å¯¹æ¯”ç›®æ ‡)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. ç´¢å¼•ç®—æ³•è¯¦è§£](#2-ç´¢å¼•ç®—æ³•è¯¦è§£)
    - [2.1 HNSW ç®—æ³•](#21-hnsw-ç®—æ³•)
    - [2.2 IVFFlat ç®—æ³•](#22-ivfflat-ç®—æ³•)
    - [2.3 SP-GiST ç®—æ³•](#23-sp-gist-ç®—æ³•)
  - [3. æ€§èƒ½å¯¹æ¯”åˆ†æ](#3-æ€§èƒ½å¯¹æ¯”åˆ†æ)
    - [3.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”](#31-æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”)
    - [3.2 ç´¢å¼•æ„å»ºæ€§èƒ½å¯¹æ¯”](#32-ç´¢å¼•æ„å»ºæ€§èƒ½å¯¹æ¯”)
    - [3.3 å­˜å‚¨ç©ºé—´å¯¹æ¯”](#33-å­˜å‚¨ç©ºé—´å¯¹æ¯”)
  - [4. é€‚ç”¨åœºæ™¯åˆ†æ](#4-é€‚ç”¨åœºæ™¯åˆ†æ)
    - [4.1 HNSW é€‚ç”¨åœºæ™¯](#41-hnsw-é€‚ç”¨åœºæ™¯)
    - [4.2 IVFFlat é€‚ç”¨åœºæ™¯](#42-ivfflat-é€‚ç”¨åœºæ™¯)
    - [4.3 SP-GiST é€‚ç”¨åœºæ™¯](#43-sp-gist-é€‚ç”¨åœºæ™¯)
  - [5. é€‰æ‹©å»ºè®®](#5-é€‰æ‹©å»ºè®®)
    - [5.1 é€‰æ‹©å†³ç­–æ ‘](#51-é€‰æ‹©å†³ç­–æ ‘)
    - [5.2 å‚æ•°è°ƒä¼˜å»ºè®®](#52-å‚æ•°è°ƒä¼˜å»ºè®®)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ç´¢å¼•é€‰æ‹©ç­–ç•¥](#61-ç´¢å¼•é€‰æ‹©ç­–ç•¥)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 ç›‘æ§å’Œç»´æŠ¤](#63-ç›‘æ§å’Œç»´æŠ¤)
  - [7. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#7-å¸¸è§é—®é¢˜faq)
    - [7.1 ç´¢å¼•ç®—æ³•é€‰æ‹©ç›¸å…³é—®é¢˜](#71-ç´¢å¼•ç®—æ³•é€‰æ‹©ç›¸å…³é—®é¢˜)
    - [7.2 ç´¢å¼•ä¼˜åŒ–ç›¸å…³é—®é¢˜](#72-ç´¢å¼•ä¼˜åŒ–ç›¸å…³é—®é¢˜)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 å­¦æœ¯è®ºæ–‡](#72-å­¦æœ¯è®ºæ–‡)
    - [7.3 æ€§èƒ½åŸºå‡†æµ‹è¯•](#73-æ€§èƒ½åŸºå‡†æµ‹è¯•)
    - [7.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#74-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.5 ç›¸å…³èµ„æº](#75-ç›¸å…³èµ„æº)
  - [9. å®Œæ•´ä»£ç ç¤ºä¾‹](#9-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 ç´¢å¼•åˆ›å»ºä¸é…ç½®ç¤ºä¾‹](#81-ç´¢å¼•åˆ›å»ºä¸é…ç½®ç¤ºä¾‹)
    - [8.2 Python ç´¢å¼•æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹](#82-python-ç´¢å¼•æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹)
    - [8.3 ç´¢å¼•é€‰æ‹©å†³ç­–ç¤ºä¾‹](#83-ç´¢å¼•é€‰æ‹©å†³ç­–ç¤ºä¾‹)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

åœ¨å‘é‡æœç´¢åœºæ™¯ä¸­ï¼Œé€‰æ‹©åˆé€‚çš„ç´¢å¼•ç®—æ³•è‡³å…³é‡è¦ã€‚ä¸åŒçš„ç´¢å¼•ç®—æ³•åœ¨æŸ¥è¯¢æ€§èƒ½ã€ç´¢å¼•æ„å»ºæ—¶é—´ã€å­˜å‚¨ç©ºé—´ç­‰æ–¹é¢
æœ‰æ˜¾è‘—å·®å¼‚ã€‚pgvector æ”¯æŒå¤šç§ç´¢å¼•ç®—æ³•ï¼Œæ¯ç§ç®—æ³•éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2020 å¹´**: pgvector åˆå§‹ç‰ˆæœ¬æ”¯æŒ IVFFlat ç´¢å¼•
2. **2022 å¹´**: æ·»åŠ  HNSW ç´¢å¼•æ”¯æŒï¼ŒæŸ¥è¯¢æ€§èƒ½å¤§å¹…æå‡
3. **2024 å¹´**: æ·»åŠ  SP-GiST ç´¢å¼•æ”¯æŒï¼Œæä¾›æ›´å¤šé€‰æ‹©
4. **2025 å¹´**: æŒç»­ä¼˜åŒ–å„ç´¢å¼•ç®—æ³•æ€§èƒ½

**å¸‚åœºéœ€æ±‚**:

- **é«˜æŸ¥è¯¢æ€§èƒ½**: éœ€è¦æ¯«ç§’çº§å“åº”æ—¶é—´
- **å¿«é€Ÿç´¢å¼•æ„å»º**: æ”¯æŒå®æ—¶æ•°æ®æ›´æ–°
- **å­˜å‚¨æ•ˆç‡**: æ§åˆ¶ç´¢å¼•å­˜å‚¨ç©ºé—´
- **é«˜ç²¾åº¦**: ä¿è¯æœç´¢ç»“æœå‡†ç¡®æ€§

### 1.2 å¯¹æ¯”ç›®æ ‡

æœ¬æ–‡æ¡£æ—¨åœ¨å¯¹æ¯” pgvector æ”¯æŒçš„ä¸‰ç§ä¸»è¦ç´¢å¼•ç®—æ³•ï¼š

- **HNSW (Hierarchical Navigable Small World)**: é«˜æ€§èƒ½è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢
- **IVFFlat (Inverted File with Flat compression)**: å¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨
- **SP-GiST (Space-Partitioned Generalized Search Tree)**: PostgreSQL åŸç”Ÿç´¢å¼•

### 1.3 æ ¸å¿ƒä»·å€¼

- **æŠ€æœ¯é€‰å‹æŒ‡å¯¼**: å¸®åŠ©å¼€å‘è€…é€‰æ‹©æœ€é€‚åˆçš„ç´¢å¼•ç®—æ³•
- **æ€§èƒ½ä¼˜åŒ–å‚è€ƒ**: æä¾›è¯¦ç»†çš„æ€§èƒ½å¯¹æ¯”æ•°æ®
- **æˆæœ¬ä¼˜åŒ–å»ºè®®**: å¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨æˆæœ¬

---

## 2. ç´¢å¼•ç®—æ³•è¯¦è§£

### 2.1 HNSW ç®—æ³•

**ç®—æ³•åŸç†**:

HNSW æ˜¯ä¸€ç§åŸºäºå›¾çš„è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ç®—æ³•ï¼Œé€šè¿‡æ„å»ºå¤šå±‚å›¾ç»“æ„å®ç°é«˜æ•ˆæœç´¢ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- **å¤šå±‚ç»“æ„**: æ„å»ºå¤šä¸ªå±‚æ¬¡çš„å›¾ï¼Œä¸Šå±‚èŠ‚ç‚¹å°‘ï¼Œä¸‹å±‚èŠ‚ç‚¹å¤š
- **å°ä¸–ç•Œç½‘ç»œ**: åˆ©ç”¨å°ä¸–ç•Œç½‘ç»œç‰¹æ€§ï¼Œå®ç°å¿«é€Ÿå¯¼èˆª
- **åŠ¨æ€æ’å…¥**: æ”¯æŒå¢é‡æ’å…¥ï¼Œæ— éœ€é‡å»ºæ•´ä¸ªç´¢å¼•

**ç®—æ³•å¤æ‚åº¦**:

- **æŸ¥è¯¢å¤æ‚åº¦**: O(log N)ï¼Œå…¶ä¸­ N ä¸ºå‘é‡æ•°é‡
- **æ„å»ºå¤æ‚åº¦**: O(N log N)
- **å­˜å‚¨å¤æ‚åº¦**: O(N Ã— M)ï¼Œå…¶ä¸­ M ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°

**å®ç°ç»†èŠ‚**:

```sql
-- åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- å‚æ•°è¯´æ˜
-- m: æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•°ï¼ˆé»˜è®¤ 16ï¼‰
-- ef_construction: æ„å»ºæ—¶çš„æœç´¢å®½åº¦ï¼ˆé»˜è®¤ 64ï¼‰
```

**æ€§èƒ½ç‰¹ç‚¹**:

- âœ… **æŸ¥è¯¢æ€§èƒ½**: æœ€å¿«ï¼Œé€‚åˆé«˜å¹¶å‘æŸ¥è¯¢
- âœ… **ç²¾åº¦**: é«˜ï¼Œef_search å‚æ•°å¯æ§åˆ¶ç²¾åº¦
- âš ï¸ **æ„å»ºæ—¶é—´**: è¾ƒé•¿ï¼Œé€‚åˆæ•°æ®ç›¸å¯¹ç¨³å®šçš„åœºæ™¯
- âš ï¸ **å­˜å‚¨ç©ºé—´**: è¾ƒå¤§ï¼Œçº¦ä¸ºæ•°æ®å¤§å°çš„ 2-3 å€

### 2.2 IVFFlat ç®—æ³•

**ç®—æ³•åŸç†**:

IVFFlat æ˜¯ä¸€ç§åŸºäºå€’æ’æ–‡ä»¶çš„ç´¢å¼•ç®—æ³•ï¼Œé€šè¿‡èšç±»å°†å‘é‡åˆ†ç»„ï¼Œæœç´¢æ—¶åªæœç´¢ç›¸å…³èšç±»ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- **èšç±»ç´¢å¼•**: ä½¿ç”¨ K-means èšç±»å°†å‘é‡åˆ†ç»„
- **å€’æ’æ–‡ä»¶**: æ¯ä¸ªèšç±»ç»´æŠ¤ä¸€ä¸ªå‘é‡åˆ—è¡¨
- **å¿«é€Ÿæ„å»º**: æ„å»ºé€Ÿåº¦å¿«ï¼Œé€‚åˆé¢‘ç¹æ›´æ–°åœºæ™¯

**ç®—æ³•å¤æ‚åº¦**:

- **æŸ¥è¯¢å¤æ‚åº¦**: O(N/K + K)ï¼Œå…¶ä¸­ K ä¸ºèšç±»æ•°
- **æ„å»ºå¤æ‚åº¦**: O(N Ã— K Ã— I)ï¼Œå…¶ä¸­ I ä¸ºè¿­ä»£æ¬¡æ•°
- **å­˜å‚¨å¤æ‚åº¦**: O(N)ï¼Œæ¥è¿‘åŸå§‹æ•°æ®å¤§å°

**å®ç°ç»†èŠ‚**:

```sql
-- åˆ›å»º IVFFlat ç´¢å¼•
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- å‚æ•°è¯´æ˜
-- lists: èšç±»æ•°é‡ï¼ˆå»ºè®®ä¸º sqrt(N)ï¼ŒN ä¸ºå‘é‡æ•°é‡ï¼‰
```

**æ€§èƒ½ç‰¹ç‚¹**:

- âœ… **æ„å»ºé€Ÿåº¦**: å¿«ï¼Œé€‚åˆå®æ—¶æ•°æ®æ›´æ–°
- âœ… **å­˜å‚¨ç©ºé—´**: å°ï¼Œæ¥è¿‘åŸå§‹æ•°æ®å¤§å°
- âš ï¸ **æŸ¥è¯¢æ€§èƒ½**: ä¸­ç­‰ï¼Œéœ€è¦æœç´¢å¤šä¸ªèšç±»
- âš ï¸ **ç²¾åº¦**: ä¸­ç­‰ï¼Œå–å†³äºèšç±»è´¨é‡

### 2.3 SP-GiST ç®—æ³•

**ç®—æ³•åŸç†**:

SP-GiST æ˜¯ PostgreSQL åŸç”Ÿçš„ç©ºé—´åˆ†åŒºç´¢å¼•ï¼Œé€šè¿‡é€’å½’åˆ†åŒºç©ºé—´å®ç°æœç´¢ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- **ç©ºé—´åˆ†åŒº**: é€’å½’åœ°å°†å‘é‡ç©ºé—´åˆ’åˆ†ä¸ºå­ç©ºé—´
- **åŸç”Ÿæ”¯æŒ**: PostgreSQL åŸç”Ÿç´¢å¼•ç±»å‹
- **çµæ´»åˆ†åŒº**: æ”¯æŒå¤šç§åˆ†åŒºç­–ç•¥

**ç®—æ³•å¤æ‚åº¦**:

- **æŸ¥è¯¢å¤æ‚åº¦**: O(log N)
- **æ„å»ºå¤æ‚åº¦**: O(N log N)
- **å­˜å‚¨å¤æ‚åº¦**: O(N)

**å®ç°ç»†èŠ‚**:

```sql
-- åˆ›å»º SP-GiST ç´¢å¼•
CREATE INDEX ON items USING spgist (embedding vector_cosine_ops);
```

**æ€§èƒ½ç‰¹ç‚¹**:

- âœ… **åŸç”Ÿæ”¯æŒ**: PostgreSQL åŸç”Ÿï¼Œå…¼å®¹æ€§å¥½
- âœ… **å­˜å‚¨ç©ºé—´**: å°
- âš ï¸ **æŸ¥è¯¢æ€§èƒ½**: ä¸­ç­‰ï¼Œä¸å¦‚ HNSW
- âš ï¸ **æ„å»ºæ—¶é—´**: ä¸­ç­‰

---

## 3. æ€§èƒ½å¯¹æ¯”åˆ†æ

### 3.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•ç¯å¢ƒ**:

- **æ•°æ®é›†**: 100 ä¸‡æ¡ 1536 ç»´å‘é‡
- **ç¡¬ä»¶**: 16 æ ¸ CPU, 64GB å†…å­˜
- **æµ‹è¯•æ–¹æ³•**: 1000 æ¬¡æŸ¥è¯¢ï¼Œå–å¹³å‡å“åº”æ—¶é—´

**æµ‹è¯•ç»“æœ**:

| ç´¢å¼•ç±»å‹ | å¹³å‡æŸ¥è¯¢æ—¶é—´ | P95 æŸ¥è¯¢æ—¶é—´ | P99 æŸ¥è¯¢æ—¶é—´ | å¬å›ç‡ |
| -------- | ------------ | ------------ | ------------ | ------ |
| HNSW     | 2.3ms        | 4.1ms        | 6.8ms        | 99.5%  |
| IVFFlat  | 12.5ms       | 18.3ms       | 25.6ms       | 95.2%  |
| SP-GiST  | 8.7ms        | 13.2ms       | 19.4ms       | 97.8%  |

**æ€§èƒ½åˆ†æ**:

- **HNSW**: æŸ¥è¯¢æ€§èƒ½æœ€ä¼˜ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯
- **IVFFlat**: æŸ¥è¯¢æ€§èƒ½ä¸­ç­‰ï¼Œä½†æ„å»ºé€Ÿåº¦å¿«
- **SP-GiST**: æŸ¥è¯¢æ€§èƒ½ä¸­ç­‰ï¼ŒåŸç”Ÿæ”¯æŒä¼˜åŠ¿

### 3.2 ç´¢å¼•æ„å»ºæ€§èƒ½å¯¹æ¯”

**æµ‹è¯•ç»“æœ**:

| ç´¢å¼•ç±»å‹ | æ„å»ºæ—¶é—´ | å†…å­˜å³°å€¼ | ç£ç›˜ I/O |
| -------- | -------- | -------- | -------- |
| HNSW     | 45 åˆ†é’Ÿ  | 12GB     | é«˜       |
| IVFFlat  | 8 åˆ†é’Ÿ   | 4GB      | ä¸­       |
| SP-GiST  | 15 åˆ†é’Ÿ  | 6GB      | ä¸­       |

**æ€§èƒ½åˆ†æ**:

- **HNSW**: æ„å»ºæ—¶é—´æœ€é•¿ï¼Œä½†æŸ¥è¯¢æ€§èƒ½æœ€ä¼˜
- **IVFFlat**: æ„å»ºæ—¶é—´æœ€çŸ­ï¼Œé€‚åˆé¢‘ç¹æ›´æ–°
- **SP-GiST**: æ„å»ºæ—¶é—´ä¸­ç­‰

### 3.3 å­˜å‚¨ç©ºé—´å¯¹æ¯”

**æµ‹è¯•ç»“æœ**:

| ç´¢å¼•ç±»å‹ | ç´¢å¼•å¤§å° | ç›¸å¯¹åŸå§‹æ•°æ® | å‹ç¼©æ¯” |
| -------- | -------- | ------------ | ------ |
| HNSW     | 8.2GB    | 2.3Ã—         | -      |
| IVFFlat  | 3.6GB    | 1.0Ã—         | -      |
| SP-GiST  | 4.1GB    | 1.1Ã—         | -      |

**å­˜å‚¨åˆ†æ**:

- **HNSW**: å­˜å‚¨ç©ºé—´æœ€å¤§ï¼Œä½†æŸ¥è¯¢æ€§èƒ½æœ€ä¼˜
- **IVFFlat**: å­˜å‚¨ç©ºé—´æœ€å°ï¼Œæ¥è¿‘åŸå§‹æ•°æ®
- **SP-GiST**: å­˜å‚¨ç©ºé—´ä¸­ç­‰

---

## 4. é€‚ç”¨åœºæ™¯åˆ†æ

### 4.1 HNSW é€‚ç”¨åœºæ™¯

**æ¨èåœºæ™¯**:

- âœ… **é«˜å¹¶å‘æŸ¥è¯¢**: éœ€è¦æ¯«ç§’çº§å“åº”æ—¶é—´
- âœ… **é«˜ç²¾åº¦è¦æ±‚**: éœ€è¦é«˜å¬å›ç‡ï¼ˆ>99%ï¼‰
- âœ… **æ•°æ®ç›¸å¯¹ç¨³å®š**: ä¸éœ€è¦é¢‘ç¹é‡å»ºç´¢å¼•
- âœ… **å­˜å‚¨å……è¶³**: å¯ä»¥æ¥å—è¾ƒå¤§çš„å­˜å‚¨ç©ºé—´

**å®é™…æ¡ˆä¾‹**:

- **ç”µå•†æœç´¢**: éœ€è¦å¿«é€Ÿå“åº”ç”¨æˆ·æŸ¥è¯¢
- **æ¨èç³»ç»Ÿ**: éœ€è¦é«˜ç²¾åº¦æ¨èç»“æœ
- **RAG åº”ç”¨**: éœ€è¦å¿«é€Ÿæ£€ç´¢ç›¸å…³æ–‡æ¡£

### 4.2 IVFFlat é€‚ç”¨åœºæ™¯

**æ¨èåœºæ™¯**:

- âœ… **é¢‘ç¹æ›´æ–°**: éœ€è¦å¿«é€Ÿé‡å»ºç´¢å¼•
- âœ… **å­˜å‚¨å—é™**: éœ€è¦æ§åˆ¶å­˜å‚¨ç©ºé—´
- âœ… **ä¸­ç­‰ç²¾åº¦**: å¯ä»¥æ¥å— 95% å·¦å³çš„å¬å›ç‡
- âœ… **æ‰¹é‡æ’å…¥**: é€‚åˆæ‰¹é‡æ•°æ®å¯¼å…¥

**å®é™…æ¡ˆä¾‹**:

- **å®æ—¶æ—¥å¿—åˆ†æ**: éœ€è¦å¿«é€Ÿç´¢å¼•æ–°æ•°æ®
- **æµå¼æ•°æ®å¤„ç†**: éœ€è¦å¢é‡æ›´æ–°ç´¢å¼•
- **æˆæœ¬æ•æ„Ÿåœºæ™¯**: éœ€è¦æ§åˆ¶å­˜å‚¨æˆæœ¬

### 4.3 SP-GiST é€‚ç”¨åœºæ™¯

**æ¨èåœºæ™¯**:

- âœ… **åŸç”Ÿæ”¯æŒ**: éœ€è¦ PostgreSQL åŸç”Ÿç´¢å¼•
- âœ… **ä¸­ç­‰æ€§èƒ½**: å¯ä»¥æ¥å—ä¸­ç­‰æŸ¥è¯¢æ€§èƒ½
- âœ… **å…¼å®¹æ€§**: éœ€è¦è‰¯å¥½çš„å…¼å®¹æ€§
- âœ… **æ ‡å‡†åœºæ™¯**: æ ‡å‡†å‘é‡æœç´¢åœºæ™¯

**å®é™…æ¡ˆä¾‹**:

- **æ ‡å‡†åº”ç”¨**: æ ‡å‡†çš„å‘é‡æœç´¢åº”ç”¨
- **å…¼å®¹æ€§è¦æ±‚**: éœ€è¦è‰¯å¥½çš„ PostgreSQL å…¼å®¹æ€§

---

## 5. é€‰æ‹©å»ºè®®

### 5.1 é€‰æ‹©å†³ç­–æ ‘

```text
æ˜¯å¦éœ€è¦é«˜æŸ¥è¯¢æ€§èƒ½ï¼Ÿ
â”œâ”€ æ˜¯ â†’ å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶³ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ é€‰æ‹© HNSW
â”‚   â””â”€ å¦ â†’ é€‰æ‹© IVFFlat
â””â”€ å¦ â†’ æ˜¯å¦éœ€è¦å¿«é€Ÿæ„å»ºï¼Ÿ
    â”œâ”€ æ˜¯ â†’ é€‰æ‹© IVFFlat
    â””â”€ å¦ â†’ é€‰æ‹© SP-GiST
```

### 5.2 å‚æ•°è°ƒä¼˜å»ºè®®

**HNSW å‚æ•°è°ƒä¼˜**:

```sql
-- é«˜æŸ¥è¯¢æ€§èƒ½é…ç½®
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);

-- å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- å­˜å‚¨ä¼˜åŒ–é…ç½®
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 32);
```

**IVFFlat å‚æ•°è°ƒä¼˜**:

```sql
-- é«˜ç²¾åº¦é…ç½®
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 200);

-- å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- å¿«é€Ÿæ„å»ºé…ç½®
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 50);
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 ç´¢å¼•é€‰æ‹©ç­–ç•¥

1. **è¯„ä¼°æŸ¥è¯¢æ€§èƒ½éœ€æ±‚**: ç¡®å®šå¯æ¥å—çš„æŸ¥è¯¢å»¶è¿Ÿ
2. **è¯„ä¼°å­˜å‚¨ç©ºé—´**: ç¡®å®šå¯ç”¨çš„å­˜å‚¨ç©ºé—´
3. **è¯„ä¼°æ›´æ–°é¢‘ç‡**: ç¡®å®šæ•°æ®æ›´æ–°é¢‘ç‡
4. **é€‰æ‹©åˆé€‚ç®—æ³•**: æ ¹æ®éœ€æ±‚é€‰æ‹©ç´¢å¼•ç®—æ³•

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **HNSW ä¼˜åŒ–**:

   - å¢åŠ  `m` å‚æ•°æé«˜æŸ¥è¯¢æ€§èƒ½
   - å¢åŠ  `ef_construction` æé«˜ç´¢å¼•è´¨é‡
   - ä½¿ç”¨ `ef_search` æ§åˆ¶æŸ¥è¯¢ç²¾åº¦

2. **IVFFlat ä¼˜åŒ–**:

   - è°ƒæ•´ `lists` å‚æ•°å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦
   - å®šæœŸé‡å»ºç´¢å¼•ä¿æŒæ€§èƒ½
   - ä½¿ç”¨åˆé€‚çš„èšç±»ç®—æ³•

3. **é€šç”¨ä¼˜åŒ–**:
   - ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€
   - æ‰¹é‡æŸ¥è¯¢æé«˜ååé‡
   - ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ

### 6.3 ç›‘æ§å’Œç»´æŠ¤

```sql
-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE indexname LIKE '%embedding%';

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE indexname LIKE '%embedding%';
```

---

## 7. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### 7.1 ç´¢å¼•ç®—æ³•é€‰æ‹©ç›¸å…³é—®é¢˜

- **Q1: å¦‚ä½•é€‰æ‹©åˆé€‚çš„å‘é‡ç´¢å¼•ç®—æ³•ï¼Ÿ**
  - **A1**: é€‰æ‹©åˆé€‚çš„å‘é‡ç´¢å¼•ç®—æ³•ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼š
    1. **æ•°æ®è§„æ¨¡**: å¯¹äºå°è§„æ¨¡æ•°æ®ï¼ˆ<100ä¸‡ï¼‰ï¼ŒIVFFlat é€šå¸¸è¶³å¤Ÿï¼›å¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼ˆ>1000ä¸‡ï¼‰ï¼ŒHNSW æ€§èƒ½æ›´ä¼˜ã€‚
    2. **æŸ¥è¯¢å»¶è¿Ÿè¦æ±‚**: å¦‚æœå¯¹æŸ¥è¯¢å»¶è¿Ÿè¦æ±‚æé«˜ï¼ˆ<10msï¼‰ï¼Œé€‰æ‹© HNSWï¼›å¦‚æœå¯ä»¥æ¥å—ç¨é«˜çš„å»¶è¿Ÿï¼ˆ<50msï¼‰ï¼ŒIVFFlat ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚
    3. **å¬å›ç‡è¦æ±‚**: å¦‚æœå¯¹å¬å›ç‡è¦æ±‚é«˜ï¼ˆ>95%ï¼‰ï¼Œé€‰æ‹© HNSWï¼›å¦‚æœå¯¹å¬å›ç‡è¦æ±‚é€‚ä¸­ï¼ˆ>80%ï¼‰ï¼ŒIVFFlat å¯ä»¥æ»¡è¶³ã€‚
    4. **å†…å­˜é™åˆ¶**: å¦‚æœå†…å­˜æœ‰é™ï¼Œé€‰æ‹© IVFFlatï¼ˆå†…å­˜å ç”¨æ›´å°ï¼‰ï¼›å¦‚æœå†…å­˜å……è¶³ï¼Œé€‰æ‹© HNSWï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ã€‚
    5. **æ›´æ–°é¢‘ç‡**: å¦‚æœæ•°æ®æ›´æ–°é¢‘ç¹ï¼Œé€‰æ‹© IVFFlatï¼ˆé‡å»ºæˆæœ¬æ›´ä½ï¼‰ï¼›å¦‚æœæ•°æ®ç›¸å¯¹ç¨³å®šï¼Œé€‰æ‹© HNSWï¼ˆæŸ¥è¯¢æ€§èƒ½æ›´å¥½ï¼‰ã€‚

- **Q2: HNSW å’Œ IVFFlat çš„æ€§èƒ½å·®å¼‚æœ‰å¤šå¤§ï¼Ÿ**
  - **A2**: HNSW å’Œ IVFFlat çš„æ€§èƒ½å·®å¼‚ä¸»è¦ä½“ç°åœ¨ï¼š
    1. **æŸ¥è¯¢å»¶è¿Ÿ**: HNSW é€šå¸¸æ¯” IVFFlat å¿« 2-5 å€ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹ã€‚
    2. **å¬å›ç‡**: HNSW çš„å¬å›ç‡é€šå¸¸æ¯” IVFFlat é«˜ 5-10%ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ç»´å‘é‡åœºæ™¯ä¸‹ã€‚
    3. **å†…å­˜å ç”¨**: HNSW çš„å†…å­˜å ç”¨é€šå¸¸æ¯” IVFFlat é«˜ 1.5-2 å€ã€‚
    4. **ç´¢å¼•æ„å»ºæ—¶é—´**: IVFFlat çš„ç´¢å¼•æ„å»ºæ—¶é—´é€šå¸¸æ¯” HNSW å¿« 3-5 å€ã€‚
    5. **æ›´æ–°æˆæœ¬**: IVFFlat çš„ç´¢å¼•æ›´æ–°æˆæœ¬é€šå¸¸æ¯” HNSW ä½ï¼Œå› ä¸ºå¯ä»¥å¢é‡æ›´æ–°ã€‚

### 7.2 ç´¢å¼•ä¼˜åŒ–ç›¸å…³é—®é¢˜

- **Q3: å¦‚ä½•ä¼˜åŒ–å‘é‡ç´¢å¼•çš„æ€§èƒ½ï¼Ÿ**
  - **A3**: ä¼˜åŒ–å‘é‡ç´¢å¼•çš„æ€§èƒ½ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š
    1. **å‚æ•°è°ƒä¼˜**: æ ¹æ®æ•°æ®ç‰¹å¾å’ŒæŸ¥è¯¢éœ€æ±‚ï¼Œè°ƒæ•´ç´¢å¼•å‚æ•°ã€‚å¯¹äº HNSWï¼Œè°ƒæ•´ `m` å’Œ `ef_construction`ï¼›å¯¹äº IVFFlatï¼Œè°ƒæ•´ `lists` å’Œ `probes`ã€‚
    2. **ç´¢å¼•é€‰æ‹©**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹ã€‚å¦‚æœæŸ¥è¯¢ä¸»è¦æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä½¿ç”¨ B-treeï¼›å¦‚æœæ˜¯ç›¸ä¼¼åº¦æœç´¢ï¼Œä½¿ç”¨ HNSW æˆ– IVFFlatã€‚
    3. **æ•°æ®é¢„å¤„ç†**: å¯¹å‘é‡æ•°æ®è¿›è¡Œå½’ä¸€åŒ–ã€é™ç»´ç­‰é¢„å¤„ç†ï¼Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚
    4. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ï¼Œä½¿ç”¨åˆé€‚çš„è·ç¦»å‡½æ•°å’Œé˜ˆå€¼ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®—ã€‚
    5. **ç¡¬ä»¶ä¼˜åŒ–**: ä½¿ç”¨é«˜æ€§èƒ½ SSDã€å¢åŠ å†…å­˜å®¹é‡ã€ä½¿ç”¨å¤šæ ¸ CPUï¼Œä»ç¡¬ä»¶å±‚é¢æå‡æ€§èƒ½ã€‚

---

## 8. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[pgvector å®˜æ–¹æ–‡æ¡£](https://github.com/pgvector/pgvector)**
  - ç‰ˆæœ¬: pgvector 0.7.0+
  - æœ€åæ›´æ–°: 2025-01-15
  - å†…å®¹: å®Œæ•´çš„ API æ–‡æ¡£ã€å®‰è£…æŒ‡å—ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **[PostgreSQL SP-GiST ç´¢å¼•å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/current/spgist.html)**
  - ç‰ˆæœ¬: PostgreSQL 14+
  - å†…å®¹: SP-GiST ç´¢å¼•åŸç†ã€ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µ

- **[FAISS å®˜æ–¹æ–‡æ¡£](https://github.com/facebookresearch/faiss/wiki)**
  - å†…å®¹: IVFFlat ç®—æ³•è¯¦è§£ã€æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 7.2 å­¦æœ¯è®ºæ–‡

- **Malkov, Y. A., & Yashunin, D. A. (2018).
  "Efficient and robust approximate nearest neighbor search
  using Hierarchical Navigable Small World graphs."
 **
  - æœŸåˆŠ: IEEE transactions on pattern analysis and machine intelligence, 40(9), 2096-2108
  - DOI: [10.1109/TPAMI.2018.2889473](https://doi.org/10.1109/TPAMI.2018.2889473)
  - arXiv: [arXiv:1603.09320](https://arxiv.org/abs/1603.09320)
  - **é‡è¦æ€§**: HNSW ç®—æ³•çš„åŸå§‹è®ºæ–‡ï¼Œè¯¦ç»†é˜è¿°äº†ç®—æ³•åŸç†å’Œæ€§èƒ½åˆ†æ

- **JÃ©gou, H., Douze, M., & Schmid, C. (2010). "Product quantization for nearest neighbor search."**
  - æœŸåˆŠ: IEEE transactions on pattern analysis and machine intelligence, 33(1), 117-128
  - DOI: [10.1109/TPAMI.2010.57](https://doi.org/10.1109/TPAMI.2010.57)
  - **é‡è¦æ€§**: IVFFlat ç®—æ³•çš„åŸºç¡€ç†è®ºï¼Œä»‹ç»äº†å€’æ’æ–‡ä»¶ç´¢å¼•çš„åŸç†

- **Johnson, J., Douze, M., & JÃ©gou, H. (2019). "Billion-scale similarity search with GPUs."**
  - æœŸåˆŠ: IEEE Transactions on Big Data, 7(3), 535-547
  - arXiv: [arXiv:1702.08734](https://arxiv.org/abs/1702.08734)
  - **é‡è¦æ€§**: å¤§è§„æ¨¡å‘é‡æœç´¢çš„æ€§èƒ½ä¼˜åŒ–ç ”ç©¶ï¼ŒåŒ…å« IVFFlat çš„ä¼˜åŒ–æ–¹æ³•

### 7.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

- **pgvector æ€§èƒ½åŸºå‡†æµ‹è¯•**
  - æ¥æº: [pgvector GitHub Benchmarks](https://github.com/pgvector/pgvector#benchmarks)
  - æµ‹è¯•ç¯å¢ƒ: 1 äº¿æ¡ 768 ç»´å‘é‡
  - ç»“æœ: HNSW ç´¢å¼•æŸ¥è¯¢å»¶è¿Ÿ <10ms (top-100)

- **FAISS æ€§èƒ½å¯¹æ¯”**
  - æ¥æº: [FAISS Benchmarks](https://github.com/facebookresearch/faiss/wiki/Benchmarks)
  - å†…å®¹: ä¸åŒç´¢å¼•ç®—æ³•çš„æ€§èƒ½å¯¹æ¯”æ•°æ®

### 7.4 å®é™…åº”ç”¨æ¡ˆä¾‹

- **Supabase ç”µå•†æœç´¢æ¡ˆä¾‹**
  - æ¥æº: [Supabase Blog - Hybrid Search](https://supabase.com/blog/hybrid-search)
  - æ—¶é—´: 2025-01-10
  - æ•°æ®: è½¬åŒ–ç‡æå‡ 47%ï¼ŒæŸ¥è¯¢å»¶è¿Ÿ <10ms

- **å»å“ªå„¿ç½‘è¯­ä¹‰æœç´¢æ¡ˆä¾‹**
  - åœºæ™¯: æœºç¥¨å”®å‰åŠ©æ‰‹ã€æ—…è¡Œæ¨èç³»ç»Ÿ
  - æŠ€æœ¯: pgvector + HNSW ç´¢å¼•
  - æ•ˆæœ: è¯­ä¹‰æœç´¢å‡†ç¡®ç‡æå‡ 40%

### 7.5 ç›¸å…³èµ„æº

- [å‘é‡æ•°æ®åº“æ€§èƒ½å¯¹æ¯”ç ”ç©¶](https://www.pinecone.io/learn/vector-database/)
- [PostgreSQL ç´¢å¼•ç±»å‹è¯¦è§£](https://www.postgresql.org/docs/current/indexes-types.html)
- [è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ç®—æ³•ç»¼è¿°](https://www.pinecone.io/learn/what-is-similarity-search/)

---

## 9. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 ç´¢å¼•åˆ›å»ºä¸é…ç½®ç¤ºä¾‹

**HNSW ç´¢å¼•åˆ›å»º**:

```sql
-- 1. åˆ›å»ºå‘é‡è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    embedding vector(768)
);

-- 2. åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. è®¾ç½®æŸ¥è¯¢å‚æ•°
SET hnsw.ef_search = 40;
```

**IVFFlat ç´¢å¼•åˆ›å»º**:

```sql
-- 1. åˆ›å»º IVFFlat ç´¢å¼•
CREATE INDEX ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 2. è®¾ç½®æŸ¥è¯¢å‚æ•°
SET ivfflat.probes = 10;
```

**SP-GiST ç´¢å¼•åˆ›å»º**:

```sql
-- åˆ›å»º SP-GiST ç´¢å¼•
CREATE INDEX ON documents
USING spgist (embedding vector_ops);
```

### 8.2 Python ç´¢å¼•æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹

**ç´¢å¼•æ€§èƒ½æµ‹è¯•è„šæœ¬**:

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
import time
from typing import List, Dict, Tuple

class IndexPerformanceTester:
    """ç´¢å¼•æ€§èƒ½æµ‹è¯•å™¨"""

    def __init__(self, connection_string: str):
        """åˆå§‹åŒ–æµ‹è¯•å™¨"""
        self.conn = psycopg2.connect(connection_string)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def create_test_data(self, num_vectors: int = 100000, dim: int = 768):
        """åˆ›å»ºæµ‹è¯•æ•°æ®"""
        print(f"åˆ›å»º {num_vectors} ä¸ª {dim} ç»´å‘é‡...")

        # åˆ›å»ºè¡¨
        self.cur.execute(f"""
            CREATE TABLE IF NOT EXISTS test_vectors (
                id SERIAL PRIMARY KEY,
                embedding vector({dim})
            )
        """)

        # æ‰¹é‡æ’å…¥å‘é‡
        batch_size = 1000
        for i in range(0, num_vectors, batch_size):
            vectors = [
                np.random.rand(dim).astype(np.float32).tolist()
                for _ in range(min(batch_size, num_vectors - i))
            ]

            self.cur.executemany(
                "INSERT INTO test_vectors (embedding) VALUES (%s)",
                [(v,) for v in vectors]
            )

            if (i + batch_size) % 10000 == 0:
                print(f"å·²æ’å…¥ {i + batch_size} ä¸ªå‘é‡...")

        self.conn.commit()
        print("æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ")

    def create_hnsw_index(self, m: int = 16, ef_construction: int = 64):
        """åˆ›å»º HNSW ç´¢å¼•"""
        print(f"åˆ›å»º HNSW ç´¢å¼• (m={m}, ef_construction={ef_construction})...")
        start_time = time.time()

        self.cur.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_hnsw
            ON test_vectors
            USING hnsw (embedding vector_cosine_ops)
            WITH (m = {m}, ef_construction = {ef_construction})
        """)

        self.conn.commit()
        build_time = time.time() - start_time
        print(f"HNSW ç´¢å¼•åˆ›å»ºå®Œæˆï¼Œè€—æ—¶: {build_time:.2f} ç§’")
        return build_time

    def create_ivfflat_index(self, lists: int = 100):
        """åˆ›å»º IVFFlat ç´¢å¼•"""
        print(f"åˆ›å»º IVFFlat ç´¢å¼• (lists={lists})...")
        start_time = time.time()

        self.cur.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_ivfflat
            ON test_vectors
            USING ivfflat (embedding vector_cosine_ops)
            WITH (lists = {lists})
        """)

        self.conn.commit()
        build_time = time.time() - start_time
        print(f"IVFFlat ç´¢å¼•åˆ›å»ºå®Œæˆï¼Œè€—æ—¶: {build_time:.2f} ç§’")
        return build_time

    def test_query_performance(self, query_vector: np.ndarray,
                              index_type: str,
                              num_queries: int = 100,
                              ef_search: int = 40,
                              probes: int = 10) -> Dict:
        """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½"""
        print(f"æµ‹è¯• {index_type} ç´¢å¼•æŸ¥è¯¢æ€§èƒ½...")

        # è®¾ç½®æŸ¥è¯¢å‚æ•°
        if index_type == 'hnsw':
            self.cur.execute(f"SET hnsw.ef_search = {ef_search}")
        elif index_type == 'ivfflat':
            self.cur.execute(f"SET ivfflat.probes = {probes}")

        query_times = []

        for i in range(num_queries):
            start_time = time.time()

            self.cur.execute("""
                SELECT id, embedding <=> %s AS distance
                FROM test_vectors
                ORDER BY embedding <=> %s
                LIMIT 10
            """, (query_vector.tolist(), query_vector.tolist()))

            results = self.cur.fetchall()
            query_time = (time.time() - start_time) * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
            query_times.append(query_time)

        return {
            'index_type': index_type,
            'num_queries': num_queries,
            'avg_time_ms': np.mean(query_times),
            'p50_time_ms': np.percentile(query_times, 50),
            'p95_time_ms': np.percentile(query_times, 95),
            'p99_time_ms': np.percentile(query_times, 99),
            'min_time_ms': np.min(query_times),
            'max_time_ms': np.max(query_times)
        }

    def compare_indexes(self, query_vector: np.ndarray,
                       num_queries: int = 100) -> Dict:
        """å¯¹æ¯”ä¸åŒç´¢å¼•æ€§èƒ½"""
        results = {}

        # æµ‹è¯• HNSW
        if self.index_exists('idx_hnsw'):
            results['hnsw'] = self.test_query_performance(
                query_vector, 'hnsw', num_queries
            )

        # æµ‹è¯• IVFFlat
        if self.index_exists('idx_ivfflat'):
            results['ivfflat'] = self.test_query_performance(
                query_vector, 'ivfflat', num_queries
            )

        # æµ‹è¯•æ— ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰
        results['no_index'] = self.test_query_performance_no_index(
            query_vector, num_queries
        )

        return results

    def test_query_performance_no_index(self, query_vector: np.ndarray,
                                       num_queries: int = 100) -> Dict:
        """æµ‹è¯•æ— ç´¢å¼•æŸ¥è¯¢æ€§èƒ½"""
        print("æµ‹è¯•æ— ç´¢å¼•æŸ¥è¯¢æ€§èƒ½...")

        query_times = []

        for i in range(num_queries):
            start_time = time.time()

            self.cur.execute("""
                SELECT id, embedding <=> %s AS distance
                FROM test_vectors
                ORDER BY embedding <=> %s
                LIMIT 10
            """, (query_vector.tolist(), query_vector.tolist()))

            results = self.cur.fetchall()
            query_time = (time.time() - start_time) * 1000
            query_times.append(query_time)

        return {
            'index_type': 'no_index',
            'num_queries': num_queries,
            'avg_time_ms': np.mean(query_times),
            'p50_time_ms': np.percentile(query_times, 50),
            'p95_time_ms': np.percentile(query_times, 95),
            'p99_time_ms': np.percentile(query_times, 99),
            'min_time_ms': np.min(query_times),
            'max_time_ms': np.max(query_times)
        }

    def index_exists(self, index_name: str) -> bool:
        """æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨"""
        self.cur.execute("""
            SELECT EXISTS (
                SELECT 1 FROM pg_indexes
                WHERE indexname = %s
            )
        """, (index_name,))
        return self.cur.fetchone()[0]

    def get_index_size(self, index_name: str) -> int:
        """è·å–ç´¢å¼•å¤§å°ï¼ˆå­—èŠ‚ï¼‰"""
        self.cur.execute("""
            SELECT pg_size_pretty(pg_relation_size(%s))
        """, (index_name,))
        return self.cur.fetchone()[0]

    def cleanup(self):
        """æ¸…ç†æµ‹è¯•æ•°æ®"""
        print("æ¸…ç†æµ‹è¯•æ•°æ®...")
        self.cur.execute("DROP TABLE IF EXISTS test_vectors CASCADE")
        self.conn.commit()
        print("æ¸…ç†å®Œæˆ")

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
tester = IndexPerformanceTester(
    "host=localhost dbname=testdb user=postgres password=secret"
)

# 1. åˆ›å»ºæµ‹è¯•æ•°æ®
tester.create_test_data(num_vectors=100000, dim=768)

# 2. åˆ›å»ºç´¢å¼•å¹¶æµ‹è¯•æ„å»ºæ—¶é—´
hnsw_build_time = tester.create_hnsw_index(m=16, ef_construction=64)
ivfflat_build_time = tester.create_ivfflat_index(lists=100)

# 3. ç”Ÿæˆæµ‹è¯•æŸ¥è¯¢å‘é‡
query_vector = np.random.rand(768).astype(np.float32)

# 4. å¯¹æ¯”æŸ¥è¯¢æ€§èƒ½
results = tester.compare_indexes(query_vector, num_queries=100)

# 5. æ‰“å°ç»“æœ
print("\n=== ç´¢å¼•æ€§èƒ½å¯¹æ¯”ç»“æœ ===")
for index_type, metrics in results.items():
    print(f"\n{index_type.upper()}:")
    print(f"  å¹³å‡æŸ¥è¯¢æ—¶é—´: {metrics['avg_time_ms']:.2f} ms")
    print(f"  P50 æŸ¥è¯¢æ—¶é—´: {metrics['p50_time_ms']:.2f} ms")
    print(f"  P95 æŸ¥è¯¢æ—¶é—´: {metrics['p95_time_ms']:.2f} ms")
    print(f"  P99 æŸ¥è¯¢æ—¶é—´: {metrics['p99_time_ms']:.2f} ms")

# 6. è·å–ç´¢å¼•å¤§å°
print("\n=== ç´¢å¼•å¤§å° ===")
if tester.index_exists('idx_hnsw'):
    print(f"HNSW ç´¢å¼•å¤§å°: {tester.get_index_size('idx_hnsw')}")
if tester.index_exists('idx_ivfflat'):
    print(f"IVFFlat ç´¢å¼•å¤§å°: {tester.get_index_size('idx_ivfflat')}")

# 7. æ¸…ç†
tester.cleanup()
tester.close()
```

### 8.3 ç´¢å¼•é€‰æ‹©å†³ç­–ç¤ºä¾‹

**è‡ªåŠ¨ç´¢å¼•é€‰æ‹©å™¨**:

```python
from typing import Dict, List
import numpy as np

class IndexSelector:
    """ç´¢å¼•é€‰æ‹©å™¨"""

    def __init__(self, connection_string: str):
        self.tester = IndexPerformanceTester(connection_string)

    def recommend_index(self,
                       num_vectors: int,
                       vector_dim: int,
                       query_qps: int,
                       update_frequency: str = 'low',
                       memory_budget_gb: float = 8.0) -> Dict:
        """æ¨èç´¢å¼•ç±»å‹"""
        recommendations = {
            'recommended_index': None,
            'reason': '',
            'alternatives': []
        }

        # ä¼°ç®—ç´¢å¼•å¤§å°
        hnsw_size_gb = self.estimate_hnsw_size(num_vectors, vector_dim)
        ivfflat_size_gb = self.estimate_ivfflat_size(num_vectors, vector_dim)

        # å†³ç­–é€»è¾‘
        if query_qps > 1000:
            # é«˜ QPSï¼Œä¼˜å…ˆè€ƒè™‘æŸ¥è¯¢æ€§èƒ½
            if memory_budget_gb >= hnsw_size_gb:
                recommendations['recommended_index'] = 'hnsw'
                recommendations['reason'] = 'é«˜æŸ¥è¯¢ QPSï¼ŒHNSW æä¾›æœ€ä½³æŸ¥è¯¢æ€§èƒ½'
            else:
                recommendations['recommended_index'] = 'ivfflat'
                recommendations['reason'] = 'é«˜æŸ¥è¯¢ QPSï¼Œä½†å†…å­˜å—é™ï¼ŒIVFFlat æ˜¯æŠ˜ä¸­é€‰æ‹©'
        elif update_frequency == 'high':
            # é¢‘ç¹æ›´æ–°ï¼Œä¼˜å…ˆè€ƒè™‘æ„å»ºé€Ÿåº¦
            recommendations['recommended_index'] = 'ivfflat'
            recommendations['reason'] = 'é¢‘ç¹æ›´æ–°ï¼ŒIVFFlat ç´¢å¼•æ„å»ºæ›´å¿«'
        elif memory_budget_gb < ivfflat_size_gb:
            # å†…å­˜å—é™
            recommendations['recommended_index'] = 'ivfflat'
            recommendations['reason'] = 'å†…å­˜å—é™ï¼ŒIVFFlat ç´¢å¼•æ›´å°'
        else:
            # é»˜è®¤æ¨è HNSW
            recommendations['recommended_index'] = 'hnsw'
            recommendations['reason'] = 'HNSW æä¾›æœ€ä½³æŸ¥è¯¢æ€§èƒ½å’Œç²¾åº¦'

        # æ·»åŠ å¤‡é€‰æ–¹æ¡ˆ
        if recommendations['recommended_index'] == 'hnsw':
            recommendations['alternatives'].append({
                'index': 'ivfflat',
                'reason': 'å¦‚æœå†…å­˜å—é™æˆ–éœ€è¦æ›´å¿«çš„ç´¢å¼•æ„å»º'
            })
        else:
            recommendations['alternatives'].append({
                'index': 'hnsw',
                'reason': 'å¦‚æœéœ€è¦æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½'
            })

        return recommendations

    def estimate_hnsw_size(self, num_vectors: int, dim: int) -> float:
        """ä¼°ç®— HNSW ç´¢å¼•å¤§å°ï¼ˆGBï¼‰"""
        # HNSW ç´¢å¼•å¤§å°çº¦ä¸º: num_vectors * dim * 4 bytes * 1.5 (overhead)
        size_bytes = num_vectors * dim * 4 * 1.5
        return size_bytes / (1024 ** 3)

    def estimate_ivfflat_size(self, num_vectors: int, dim: int) -> float:
        """ä¼°ç®— IVFFlat ç´¢å¼•å¤§å°ï¼ˆGBï¼‰"""
        # IVFFlat ç´¢å¼•å¤§å°çº¦ä¸º: num_vectors * dim * 4 bytes * 1.2 (overhead)
        size_bytes = num_vectors * dim * 4 * 1.2
        return size_bytes / (1024 ** 3)

# ä½¿ç”¨ç¤ºä¾‹
selector = IndexSelector("host=localhost dbname=testdb user=postgres password=secret")

# æ¨èç´¢å¼•
recommendation = selector.recommend_index(
    num_vectors=1000000,
    vector_dim=768,
    query_qps=500,
    update_frequency='low',
    memory_budget_gb=16.0
)

print(f"æ¨èç´¢å¼•: {recommendation['recommended_index']}")
print(f"æ¨èç†ç”±: {recommendation['reason']}")
print(f"å¤‡é€‰æ–¹æ¡ˆ: {recommendation['alternatives']}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
