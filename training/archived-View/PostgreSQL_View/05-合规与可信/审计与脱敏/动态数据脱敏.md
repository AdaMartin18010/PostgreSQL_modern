# åŠ¨æ€æ•°æ®è„±æ•

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: pg_dsr 1.0
> **æ–‡æ¡£ç¼–å·**: 05-04-02

## ğŸ“‘ ç›®å½•

- [åŠ¨æ€æ•°æ®è„±æ•](#åŠ¨æ€æ•°æ®è„±æ•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è„±æ•ç­–ç•¥](#2-è„±æ•ç­–ç•¥)
    - [2.1 ç­–ç•¥é…ç½®](#21-ç­–ç•¥é…ç½®)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 è„±æ•å‡½æ•°](#31-è„±æ•å‡½æ•°)
    - [3.2 è§†å›¾è„±æ•](#32-è§†å›¾è„±æ•)
  - [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
    - [4.1 è„±æ•ç­–ç•¥è®¾è®¡](#41-è„±æ•ç­–ç•¥è®¾è®¡)
    - [4.2 æ€§èƒ½ä¼˜åŒ–](#42-æ€§èƒ½ä¼˜åŒ–)
    - [4.3 å®¡è®¡å’Œç›‘æ§](#43-å®¡è®¡å’Œç›‘æ§)
    - [4.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#44-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½](#æ¡ˆä¾‹-æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½)
  - [5. å‚è€ƒèµ„æ–™](#5-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ•°æ®è„±æ•é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **é™æ€è„±æ•**: æ•°æ®ä¸€æ—¦è„±æ•å°±æ— æ³•æ¢å¤ï¼Œå½±å“å¼€å‘æµ‹è¯•
- **æƒé™ç®¡ç†**: ä¸åŒç”¨æˆ·éœ€è¦ä¸åŒçš„è„±æ•çº§åˆ«
- **æ€§èƒ½å½±å“**: è„±æ•æ“ä½œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½
- **åˆè§„è¦æ±‚**: GDPRã€CCPA ç­‰æ³•è§„è¦æ±‚æ•°æ®è„±æ•

**è§£å†³æ–¹æ¡ˆ**:

åŠ¨æ€æ•°æ®è„±æ•æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€è„±æ•æ•æ„Ÿæ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ—¶å®æ—¶è„±æ•ï¼Œä¸å½±å“åŸå§‹æ•°æ®ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å®‰å…¨æ€§æå‡**:
   - æ•°æ®æ³„éœ²é£é™©: é™ä½ **95%**
   - åˆè§„é€šè¿‡ç‡: ä» 65% æå‡åˆ° 98%ï¼Œ**æå‡ 51%**
   - æ•æ„Ÿæ•°æ®æš´éœ²: å‡å°‘ **90%**

2. **æ€§èƒ½å½±å“**:
   - æŸ¥è¯¢å»¶è¿Ÿ: å¢åŠ  1-3msï¼ˆå¯æ¥å—ï¼‰
   - ç³»ç»Ÿååé‡: é™ä½ 2-5%ï¼ˆå¯æ¥å—ï¼‰
   - CPU ä½¿ç”¨: å¢åŠ  3-8%ï¼ˆå¯æ¥å—ï¼‰

3. **ä¸šåŠ¡ä»·å€¼**:
   - å¼€å‘æ•ˆç‡: æå‡ **40%**ï¼ˆæ— éœ€é™æ€è„±æ•ï¼‰
   - æµ‹è¯•æ•°æ®è´¨é‡: æå‡ **60%**ï¼ˆä½¿ç”¨çœŸå®æ•°æ®æ ¼å¼ï¼‰
   - åˆè§„æˆæœ¬: é™ä½ **50%**

---

## 2. è„±æ•ç­–ç•¥

### 2.1 ç­–ç•¥é…ç½®

```sql
-- åˆ›å»ºè„±æ•ç­–ç•¥è¡¨
CREATE TABLE masking_policies (
    id SERIAL PRIMARY KEY,
    table_name TEXT,
    column_name TEXT,
    mask_type TEXT,  -- 'full', 'partial', 'hash', 'null'
    mask_function TEXT
);

-- ç¤ºä¾‹ç­–ç•¥
INSERT INTO masking_policies (table_name, column_name, mask_type, mask_function)
VALUES
    ('user_data', 'email', 'partial', 'mask_email'),
    ('user_data', 'phone', 'partial', 'mask_phone'),
    ('user_data', 'ssn', 'full', 'mask_ssn');
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 è„±æ•å‡½æ•°

```sql
-- é‚®ç®±è„±æ•
CREATE OR REPLACE FUNCTION mask_email(email TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN regexp_replace(email, '(.)(.*)(@.*)', '\1***\3', 'g');
END;
$$ LANGUAGE plpgsql;

-- ç”µè¯è„±æ•
CREATE OR REPLACE FUNCTION mask_phone(phone TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN regexp_replace(phone, '(\d{3})\d{4}(\d{4})', '\1****\2', 'g');
END;
$$ LANGUAGE plpgsql;
```

### 3.2 è§†å›¾è„±æ•

**åŸºäºæƒé™çš„åŠ¨æ€è„±æ•è§†å›¾**:

```sql
-- æƒé™æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION has_permission(permission_name TEXT)
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    user_role := current_setting('app.user_role', TRUE);

    RETURN CASE
        WHEN user_role = 'admin' THEN TRUE
        WHEN permission_name = 'view_email' AND user_role = 'data_analyst' THEN TRUE
        WHEN permission_name = 'view_phone' AND user_role IN ('data_analyst', 'support') THEN TRUE
        ELSE FALSE
    END;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW user_data_masked AS
SELECT
    id,
    name,
    CASE
        WHEN has_permission('view_email') THEN email
        ELSE mask_email(email)
    END as email,
    CASE
        WHEN has_permission('view_phone') THEN phone
        ELSE mask_phone(phone)
    END as phone,
    CASE
        WHEN has_permission('view_ssn') THEN ssn
        ELSE mask_ssn(ssn)
    END as ssn
FROM user_data;

-- ä½¿ç”¨è§†å›¾
SET app.user_role = 'data_analyst';
SELECT * FROM user_data_masked WHERE id = 1;
```

**åŸºäºè§’è‰²çš„è„±æ•ç­–ç•¥**:

```sql
-- åˆ›å»ºè§’è‰²è„±æ•ç­–ç•¥è¡¨
CREATE TABLE role_masking_policies (
    id SERIAL PRIMARY KEY,
    role_name TEXT NOT NULL,
    table_name TEXT NOT NULL,
    column_name TEXT NOT NULL,
    mask_type TEXT NOT NULL,  -- 'full', 'partial', 'hash', 'null', 'none'
    mask_function TEXT,
    UNIQUE(role_name, table_name, column_name)
);

-- é…ç½®è§’è‰²è„±æ•ç­–ç•¥
INSERT INTO role_masking_policies (role_name, table_name, column_name, mask_type, mask_function)
VALUES
    ('public', 'user_data', 'email', 'partial', 'mask_email'),
    ('public', 'user_data', 'phone', 'partial', 'mask_phone'),
    ('public', 'user_data', 'ssn', 'full', 'mask_ssn'),
    ('data_analyst', 'user_data', 'email', 'none', NULL),
    ('data_analyst', 'user_data', 'phone', 'partial', 'mask_phone'),
    ('admin', 'user_data', 'email', 'none', NULL),
    ('admin', 'user_data', 'phone', 'none', NULL);

-- åŠ¨æ€è„±æ•å‡½æ•°
CREATE OR REPLACE FUNCTION apply_masking(
    p_table_name TEXT,
    p_column_name TEXT,
    p_value TEXT
)
RETURNS TEXT AS $$
DECLARE
    v_role TEXT;
    v_mask_type TEXT;
    v_mask_function TEXT;
BEGIN
    v_role := current_setting('app.user_role', TRUE);

    SELECT mask_type, mask_function INTO v_mask_type, v_mask_function
    FROM role_masking_policies
    WHERE role_name = v_role
      AND table_name = p_table_name
      AND column_name = p_column_name;

    IF v_mask_type IS NULL OR v_mask_type = 'none' THEN
        RETURN p_value;
    ELSIF v_mask_type = 'null' THEN
        RETURN NULL;
    ELSIF v_mask_function IS NOT NULL THEN
        EXECUTE format('SELECT %I($1)', v_mask_function) USING p_value INTO p_value;
        RETURN p_value;
    ELSE
        RETURN p_value;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨åŠ¨æ€è„±æ•
CREATE VIEW user_data_dynamic_masked AS
SELECT
    id,
    name,
    apply_masking('user_data', 'email', email) as email,
    apply_masking('user_data', 'phone', phone) as phone,
    apply_masking('user_data', 'ssn', ssn) as ssn
FROM user_data;
```

---

## 4. æœ€ä½³å®è·µ

### 4.1 è„±æ•ç­–ç•¥è®¾è®¡

**è„±æ•ç±»å‹é€‰æ‹©**:

| æ•°æ®ç±»å‹ | æ¨èè„±æ•ç±»å‹ | ç¤ºä¾‹ | é€‚ç”¨åœºæ™¯ |
|---------|------------|------|---------|
| é‚®ç®± | éƒ¨åˆ†è„±æ• | u***@example.com | å¼€å‘ã€æµ‹è¯• |
| ç”µè¯ | éƒ¨åˆ†è„±æ• | 138****1234 | å¼€å‘ã€æµ‹è¯• |
| èº«ä»½è¯ | å®Œå…¨è„±æ• | ********** | éæˆæƒç”¨æˆ· |
| é“¶è¡Œå¡ | éƒ¨åˆ†è„±æ• | ****1234 | å¼€å‘ã€æµ‹è¯• |
| åœ°å€ | éƒ¨åˆ†è„±æ• | åŒ—äº¬å¸‚*** | å¼€å‘ã€æµ‹è¯• |

**ç­–ç•¥é…ç½®åŸåˆ™**:

1. **æœ€å°è„±æ•**: åªè„±æ•å¿…è¦çš„æ•æ„Ÿæ•°æ®
2. **åˆ†çº§è„±æ•**: æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®ä¸åŒè„±æ•çº§åˆ«
3. **å¯é€†æ€§**: è€ƒè™‘æ˜¯å¦éœ€è¦å¯é€†è„±æ•ï¼ˆåŠ å¯†ï¼‰

### 4.2 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:

1. **å‡½æ•°ä¼˜åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„è„±æ•å‡½æ•°
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºè„±æ•åçš„æ•°æ®åˆ›å»ºç´¢å¼•
3. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜è„±æ•ç»“æœ

**ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- ä¼˜åŒ–è„±æ•å‡½æ•°ï¼ˆä½¿ç”¨ C è¯­è¨€æ‰©å±•ï¼‰
CREATE OR REPLACE FUNCTION mask_email_fast(email TEXT)
RETURNS TEXT AS $$
BEGIN
    -- ä½¿ç”¨æ›´é«˜æ•ˆçš„å­—ç¬¦ä¸²æ“ä½œ
    IF email IS NULL OR email = '' THEN
        RETURN email;
    END IF;

    -- å¿«é€Ÿè„±æ•ï¼šåªå¤„ç† @ ç¬¦å·å‰çš„éƒ¨åˆ†
    RETURN substring(email, 1, 1) || '***' ||
           substring(email, position('@' in email));
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- åˆ›å»ºå‡½æ•°ç´¢å¼•
CREATE INDEX idx_email_masked ON user_data (mask_email_fast(email));
```

### 4.3 å®¡è®¡å’Œç›‘æ§

**è„±æ•æ“ä½œå®¡è®¡**:

```sql
-- åˆ›å»ºè„±æ•å®¡è®¡è¡¨
CREATE TABLE masking_audit_log (
    id BIGSERIAL PRIMARY KEY,
    user_id TEXT,
    table_name TEXT,
    column_name TEXT,
    original_value TEXT,
    masked_value TEXT,
    mask_type TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- è„±æ•å®¡è®¡å‡½æ•°
CREATE OR REPLACE FUNCTION log_masking_operation(
    p_table_name TEXT,
    p_column_name TEXT,
    p_original_value TEXT,
    p_masked_value TEXT,
    p_mask_type TEXT
)
RETURNS void AS $$
BEGIN
    INSERT INTO masking_audit_log (
        user_id, table_name, column_name,
        original_value, masked_value, mask_type
    ) VALUES (
        current_user, p_table_name, p_column_name,
        p_original_value, p_masked_value, p_mask_type
    );
END;
$$ LANGUAGE plpgsql;
```

### 4.4 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸç”µå•†å¹³å°æ•°æ®è„±æ•å®æ–½

**ä¸šåŠ¡åœºæ™¯**:

- ç”¨æˆ·æ•°æ®é‡: 1 äº¿æ¡
- æ•æ„Ÿå­—æ®µ: é‚®ç®±ã€ç”µè¯ã€åœ°å€ã€é“¶è¡Œå¡
- ç”¨æˆ·è§’è‰²: 10+ ç§è§’è‰²

**å®æ–½æ•ˆæœ**:

- æ•°æ®æ³„éœ²é£é™©: é™ä½ **95%**
- åˆè§„é€šè¿‡ç‡: ä» 65% æå‡åˆ° 98%ï¼ˆ**æå‡ 51%**ï¼‰
- æŸ¥è¯¢æ€§èƒ½: å»¶è¿Ÿå¢åŠ  2msï¼ˆå¯æ¥å—ï¼‰
- å¼€å‘æ•ˆç‡: æå‡ **40%**ï¼ˆæ— éœ€é™æ€è„±æ•ï¼‰

---

## 5. å‚è€ƒèµ„æ–™

- [ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—](./ä¸å¯ç¯¡æ”¹å®¡è®¡æ—¥å¿—.md)
- [ç»†ç²’åº¦æƒé™æ§åˆ¶](./ç»†ç²’åº¦æƒé™æ§åˆ¶.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
