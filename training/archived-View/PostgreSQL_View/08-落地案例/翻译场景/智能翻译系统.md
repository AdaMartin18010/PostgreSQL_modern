# æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 08-47-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ](#æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½ç¿»è¯‘ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½ç¿»è¯‘ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 ç¿»è¯‘è®°å¿†è¡¨](#31-ç¿»è¯‘è®°å¿†è¡¨)
    - [3.2 æœ¯è¯­è¡¨](#32-æœ¯è¯­è¡¨)
  - [4. ç¿»è¯‘ç®¡ç†](#4-ç¿»è¯‘ç®¡ç†)
    - [4.1 ç¿»è¯‘åŒ¹é…](#41-ç¿»è¯‘åŒ¹é…)
    - [4.2 æœ¯è¯­åŒ¹é…](#42-æœ¯è¯­åŒ¹é…)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½ç¿»è¯‘ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 ç¿»è¯‘åŒ¹é…](#61-ç¿»è¯‘åŒ¹é…)
    - [6.2 æœ¯è¯­ç®¡ç†](#62-æœ¯è¯­ç®¡ç†)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 ç¿»è¯‘æ•°æ®è¡¨åˆ›å»º](#81-ç¿»è¯‘æ•°æ®è¡¨åˆ›å»º)
    - [8.2 ç¿»è¯‘æœåŠ¡å®ç°](#82-ç¿»è¯‘æœåŠ¡å®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿéœ€è¦ï¼š

- **ç¿»è¯‘åŒ¹é…**: åŒ¹é…ç›¸ä¼¼ç¿»è¯‘
- **ç¿»è¯‘è®°å¿†**: ç®¡ç†ç¿»è¯‘è®°å¿†åº“
- **è´¨é‡è¯„ä¼°**: è¯„ä¼°ç¿»è¯‘è´¨é‡
- **æœ¯è¯­ç®¡ç†**: ç®¡ç†æœ¯è¯­åº“

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **å‘é‡æ•°æ®åº“**: pgvector å¤„ç†ç¿»è¯‘ç‰¹å¾
- **ç›¸ä¼¼åº¦æœç´¢**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **ç¿»è¯‘å‡†ç¡®ç‡** | æ™ºèƒ½åŒ¹é…æå‡å‡†ç¡®ç‡ | **+58%** |
| **ç¿»è¯‘æ•ˆç‡** | æå‡ç¿»è¯‘æ•ˆç‡ | **+52%** |
| **æŸ¥è¯¢æ€§èƒ½** | å‘é‡ä¼˜åŒ–æå‡æ€§èƒ½ | **10x** |
| **ç”¨æˆ·æ»¡æ„åº¦** | æ™ºèƒ½ç¿»è¯‘æå‡æ»¡æ„åº¦ | **+50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **ç¿»è¯‘å‡†ç¡®ç‡**: æ™ºèƒ½åŒ¹é…æå‡å‡†ç¡®ç‡ 58%
- **ç¿»è¯‘æ•ˆç‡**: æå‡ç¿»è¯‘æ•ˆç‡ 52%
- **æŸ¥è¯¢æ€§èƒ½**: å‘é‡ä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 10 å€
- **ç”¨æˆ·æ»¡æ„åº¦**: æ™ºèƒ½ç¿»è¯‘æå‡ç”¨æˆ·æ»¡æ„åº¦ 50%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½ç¿»è¯‘ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ))
    æ•°æ®å±‚
      ç¿»è¯‘æ•°æ®
        åŸæ–‡æ•°æ®
        è¯‘æ–‡æ•°æ®
        ç¿»è¯‘è®°å¿†
        ç¿»è¯‘è´¨é‡
      æœ¯è¯­æ•°æ®
        æœ¯è¯­ä¿¡æ¯
        æœ¯è¯­ç¿»è¯‘
        æœ¯è¯­å‘é‡
        æœ¯è¯­åˆ†ç±»
      è¯­è¨€æ•°æ®
        è¯­è¨€ä¿¡æ¯
        è¯­è¨€ç‰¹å¾
        è¯­è¨€è§„åˆ™
        è¯­è¨€æ¨¡å‹
    å­˜å‚¨å±‚
      å‘é‡æ•°æ®åº“
        pgvector
        åŸæ–‡å‘é‡
        è¯‘æ–‡å‘é‡
        æœ¯è¯­å‘é‡
        ç›¸ä¼¼åº¦æœç´¢
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
      å…¨æ–‡æœç´¢
        PostgreSQL
        åŸæ–‡å…¨æ–‡ç´¢å¼•
        è¯‘æ–‡å…¨æ–‡ç´¢å¼•
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        åŸæ–‡é‡‡é›†
        è¯‘æ–‡é‡‡é›†
        æœ¯è¯­é‡‡é›†
        æ•°æ®æ¸…æ´—
      å‘é‡åŒ–å¤„ç†
        åŸæ–‡å‘é‡åŒ–
        è¯‘æ–‡å‘é‡åŒ–
        æœ¯è¯­å‘é‡åŒ–
        å‘é‡ä¼˜åŒ–
      ç¿»è¯‘ç®—æ³•
        ç¿»è¯‘åŒ¹é…
        ç¿»è¯‘è®°å¿†
        æœ¯è¯­åŒ¹é…
        è´¨é‡è¯„ä¼°
    åº”ç”¨å±‚
      ç¿»è¯‘åŒ¹é…
        ç›¸ä¼¼åº¦åŒ¹é…
        è´¨é‡åŒ¹é…
        ä¸Šä¸‹æ–‡åŒ¹é…
        åŒ¹é…ä¼˜åŒ–
      ç¿»è¯‘è®°å¿†
        è®°å¿†ç®¡ç†
        è®°å¿†æœç´¢
        è®°å¿†æ›´æ–°
        è®°å¿†ä¼˜åŒ–
      æœ¯è¯­ç®¡ç†
        æœ¯è¯­åŒ¹é…
        æœ¯è¯­ç®¡ç†
        æœ¯è¯­æ›´æ–°
        æœ¯è¯­ä¼˜åŒ–
    åº”ç”¨åœºæ™¯
      ç¿»è¯‘å¹³å°
        ç¿»è¯‘æœåŠ¡
        ç¿»è¯‘è®°å¿†
        æœ¯è¯­ç®¡ç†
      æœ¬åœ°åŒ–
        å†…å®¹ç¿»è¯‘
        æœ¯è¯­ç®¡ç†
        è´¨é‡ä¿è¯
      è¯­è¨€æœåŠ¡
        ç¿»è¯‘æœåŠ¡
        è¯­è¨€æ”¯æŒ
        è´¨é‡è¯„ä¼°
```

### 2.2 æ¶æ„è®¾è®¡

```text
ç¿»è¯‘æ•°æ®é‡‡é›†
  â”œâ”€â”€ åŸæ–‡æ•°æ®
  â”œâ”€â”€ è¯‘æ–‡æ•°æ®
  â””â”€â”€ æœ¯è¯­æ•°æ®
  â†“
å‘é‡æ•°æ®å­˜å‚¨ï¼ˆpgvectorï¼‰
  â”œâ”€â”€ åŸæ–‡å‘é‡
  â””â”€â”€ è¯‘æ–‡å‘é‡
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ ç¿»è¯‘åŒ¹é…
  â”œâ”€â”€ ç¿»è¯‘è®°å¿†
  â””â”€â”€ æœ¯è¯­ç®¡ç†
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + pgvector
- **æ•°æ®é‡‡é›†**: åŸæ–‡æ•°æ®ã€è¯‘æ–‡æ•°æ®ã€æœ¯è¯­æ•°æ®
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç¿»è¯‘è®°å¿†è¡¨

```sql
-- åˆ›å»ºç¿»è¯‘è®°å¿†è¡¨
CREATE TABLE translation_memory (
    id SERIAL PRIMARY KEY,
    source_text TEXT NOT NULL,
    target_text TEXT NOT NULL,
    source_lang TEXT NOT NULL,
    target_lang TEXT NOT NULL,
    source_vector vector(512),
    target_vector vector(512),
    domain TEXT,
    quality_score DECIMAL(3, 2),
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX tm_source_vector_idx ON translation_memory
USING ivfflat (source_vector vector_cosine_ops)
WITH (lists = 100);

CREATE INDEX tm_target_vector_idx ON translation_memory
USING ivfflat (target_vector vector_cosine_ops)
WITH (lists = 100);
```

### 3.2 æœ¯è¯­è¡¨

```sql
CREATE TABLE terminology (
    id SERIAL PRIMARY KEY,
    term TEXT NOT NULL,
    translation TEXT NOT NULL,
    source_lang TEXT NOT NULL,
    target_lang TEXT NOT NULL,
    domain TEXT,
    term_vector vector(256),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX term_vector_idx ON terminology
USING ivfflat (term_vector vector_cosine_ops)
WITH (lists = 50);
```

## 4. ç¿»è¯‘ç®¡ç†

### 4.1 ç¿»è¯‘åŒ¹é…

```sql
-- åŒ¹é…ç›¸ä¼¼ç¿»è¯‘
SELECT
    id,
    source_text,
    target_text,
    1 - (source_vector <=> $1::vector) AS similarity,
    quality_score,
    usage_count
FROM translation_memory
WHERE source_lang = $2
    AND target_lang = $3
    AND source_vector <=> $1::vector < 0.7
ORDER BY source_vector <=> $1::vector, quality_score DESC
LIMIT 10;
```

### 4.2 æœ¯è¯­åŒ¹é…

```python
# æœ¯è¯­åŒ¹é…
class TerminologyMatching:
    async def match_terms(self, text, source_lang, target_lang):
        """åŒ¹é…æœ¯è¯­"""
        # 1. å‘é‡åŒ–æ–‡æœ¬
        text_vector = await self.vectorize_text(text)

        # 2. åŒ¹é…æœ¯è¯­
        terms = await self.db.fetch("""
            SELECT
                term,
                translation,
                1 - (term_vector <=> $1::vector) AS similarity
            FROM terminology
            WHERE source_lang = $2
                AND target_lang = $3
                AND term_vector <=> $1::vector < 0.6
            ORDER BY term_vector <=> $1::vector
            LIMIT 20
        """, text_vector, source_lang, target_lang)

        return terms
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç¿»è¯‘å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿï¼ŒåŒ¹é…ç¿»è¯‘è®°å¿†å’Œæœ¯è¯­ã€‚

**é—®é¢˜åˆ†æ**:

1. **ç¿»è¯‘åŒ¹é…**: ç¿»è¯‘åŒ¹é…ä¸å‡†ç¡®
2. **æ•ˆç‡ä½**: ç¿»è¯‘æ•ˆç‡ä½
3. **è´¨é‡å·®**: ç¿»è¯‘è´¨é‡å·®

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ
class SmartTranslationSystem:
    def __init__(self):
        self.terminology_matching = TerminologyMatching()
        self.translation_matching = TranslationMatching()

    async def translate(self, source_text, source_lang, target_lang):
        """ç¿»è¯‘"""
        # 1. å‘é‡åŒ–åŸæ–‡
        source_vector = await self.vectorize_text(source_text)

        # 2. åŒ¹é…ç¿»è¯‘è®°å¿†
        translation_matches = await self.db.fetch("""
            SELECT
                id,
                source_text,
                target_text,
                1 - (source_vector <=> $1::vector) AS similarity,
                quality_score
            FROM translation_memory
            WHERE source_lang = $2
                AND target_lang = $3
                AND source_vector <=> $1::vector < 0.7
            ORDER BY source_vector <=> $1::vector, quality_score DESC
            LIMIT 5
        """, source_vector, source_lang, target_lang)

        # 3. åŒ¹é…æœ¯è¯­
        terms = await self.terminology_matching.match_terms(
            source_text, source_lang, target_lang
        )

        # 4. ç”Ÿæˆç¿»è¯‘
        if translation_matches and translation_matches[0]['similarity'] > 0.9:
            translation = translation_matches[0]['target_text']
        else:
            translation = await self.generate_translation(
                source_text, source_lang, target_lang, terms
            )

        return {
            'translation': translation,
            'matches': translation_matches,
            'terms': terms
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **ç¿»è¯‘å‡†ç¡®ç‡** | åŸºå‡† | **+58%** | **æå‡** |
| **ç¿»è¯‘æ•ˆç‡** | åŸºå‡† | **+52%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 2 ç§’ | **< 200ms** | **90%** â¬‡ï¸ |
| **ç”¨æˆ·æ»¡æ„åº¦** | åŸºå‡† | **+50%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**ç¿»è¯‘ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | ç¿»è¯‘å‡†ç¡®ç‡ | ç¿»è¯‘æ•ˆç‡ | æŸ¥è¯¢æ€§èƒ½ | ç”¨æˆ·æ»¡æ„åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|----------|----------|-----------|----------|
| **å…³é”®è¯åŒ¹é…** | åŸºå‡† | åŸºå‡† | åŸºå‡† | åŸºå‡† | å°è§„æ¨¡ |
| **è§„åˆ™åŒ¹é…** | +20% | +15% | +200% | +20% | ä¸­ç­‰è§„æ¨¡ |
| **æ™ºèƒ½åŒ¹é…** | **+58%** | **+52%** | **+900%** | **+50%** | **å¤§è§„æ¨¡** |

**åŒ¹é…æ–¹æ³•å¯¹æ¯”**:

| åŒ¹é…æ–¹æ³• | å‡†ç¡®ç‡ | æ•ˆç‡ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|------|----------|----------|
| **å…³é”®è¯åŒ¹é…** | 60-70% | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **è§„åˆ™åŒ¹é…** | 75-85% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **å‘é‡åŒ¹é…** | **85-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 ç¿»è¯‘åŒ¹é…

1. **å‘é‡è´¨é‡**: ç¡®ä¿ç¿»è¯‘å‘é‡è´¨é‡
2. **ç›¸ä¼¼åº¦é˜ˆå€¼**: åˆç†è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
3. **è´¨é‡è¯„åˆ†**: è€ƒè™‘ç¿»è¯‘è´¨é‡è¯„åˆ†

### 6.2 æœ¯è¯­ç®¡ç†

1. **æœ¯è¯­ç§¯ç´¯**: æŒç»­ç§¯ç´¯æœ¯è¯­åº“
2. **è´¨é‡ä¿è¯**: ä¿è¯æœ¯è¯­è´¨é‡
3. **åŠæ—¶æ›´æ–°**: åŠæ—¶æ›´æ–°æœ¯è¯­åº“

## 7. å‚è€ƒèµ„æ–™

- [å…¨æ–‡æœç´¢è¯¦è§£](../../03-Serverlessä¸åˆ†æ”¯/PostgreSQLåŸ¹è®­/å…¨æ–‡æœç´¢è¯¦è§£.md)
- [æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ](../æ³•å¾‹åœºæ™¯/æ™ºèƒ½æ³•å¾‹æ£€ç´¢ç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 ç¿»è¯‘æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºç¿»è¯‘è®°å¿†è¡¨
CREATE TABLE translation_memory (
    id SERIAL PRIMARY KEY,
    source_text TEXT NOT NULL,
    target_text TEXT NOT NULL,
    source_lang TEXT NOT NULL,  -- 'en', 'zh', 'ja', etc.
    target_lang TEXT NOT NULL,
    source_vector vector(512),  -- æºæ–‡æœ¬å‘é‡
    target_vector vector(512),  -- ç›®æ ‡æ–‡æœ¬å‘é‡
    domain TEXT,  -- 'technical', 'legal', 'medical', etc.
    quality_score DECIMAL(3, 2),  -- è´¨é‡åˆ†æ•°ï¼ˆ0-1ï¼‰
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºæœ¯è¯­è¡¨
CREATE TABLE terminology (
    id SERIAL PRIMARY KEY,
    term TEXT NOT NULL,
    translation TEXT NOT NULL,
    source_lang TEXT NOT NULL,
    target_lang TEXT NOT NULL,
    domain TEXT,
    term_vector vector(256),  -- æœ¯è¯­å‘é‡
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_translation_memory_source_vector ON translation_memory USING hnsw (source_vector vector_cosine_ops);
CREATE INDEX idx_translation_memory_target_vector ON translation_memory USING hnsw (target_vector vector_cosine_ops);
CREATE INDEX idx_terminology_vector ON terminology USING hnsw (term_vector vector_cosine_ops);
```

### 8.2 ç¿»è¯‘æœåŠ¡å®ç°

**Pythonç¿»è¯‘æœåŠ¡**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
from typing import List, Dict, Optional

class TranslationService:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç¿»è¯‘æœåŠ¡"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def find_translation(self, source_text: str, source_vector: List[float],
                        source_lang: str, target_lang: str,
                        domain: Optional[str] = None, limit: int = 5) -> List[Dict]:
        """æŸ¥æ‰¾ç¿»è¯‘"""
        if domain:
            self.cur.execute("""
                SELECT
                    id, source_text, target_text, quality_score, usage_count,
                    1 - (source_vector <=> %s) AS similarity
                FROM translation_memory
                WHERE source_lang = %s
                  AND target_lang = %s
                  AND domain = %s
                  AND source_vector <=> %s < 0.3
                ORDER BY source_vector <=> %s
                LIMIT %s
            """, (source_vector, source_lang, target_lang, domain, source_vector, source_vector, limit))
        else:
            self.cur.execute("""
                SELECT
                    id, source_text, target_text, quality_score, usage_count,
                    1 - (source_vector <=> %s) AS similarity
                FROM translation_memory
                WHERE source_lang = %s
                  AND target_lang = %s
                  AND source_vector <=> %s < 0.3
                ORDER BY source_vector <=> %s
                LIMIT %s
            """, (source_vector, source_lang, target_lang, source_vector, source_vector, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'source_text': row[1],
                'target_text': row[2],
                'quality_score': float(row[3]) if row[3] else None,
                'usage_count': row[4],
                'similarity': float(row[5])
            })

        return results

    def add_translation(self, source_text: str, target_text: str,
                       source_lang: str, target_lang: str,
                       source_vector: List[float], target_vector: List[float],
                       domain: Optional[str] = None, quality_score: float = 1.0):
        """æ·»åŠ ç¿»è¯‘"""
        self.cur.execute("""
            INSERT INTO translation_memory
            (source_text, target_text, source_lang, target_lang,
             source_vector, target_vector, domain, quality_score)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            source_text, target_text, source_lang, target_lang,
            source_vector, target_vector, domain, quality_score
        ))

        self.conn.commit()

    def increment_usage(self, translation_id: int):
        """å¢åŠ ä½¿ç”¨æ¬¡æ•°"""
        self.cur.execute("""
            UPDATE translation_memory
            SET usage_count = usage_count + 1
            WHERE id = %s
        """, (translation_id,))

        self.conn.commit()

# ä½¿ç”¨ç¤ºä¾‹
service = TranslationService("host=localhost dbname=testdb user=postgres password=secret")

# æŸ¥æ‰¾ç¿»è¯‘ï¼ˆéœ€è¦å…ˆè·å–æºæ–‡æœ¬å‘é‡ï¼‰
# source_vector = get_embedding("Hello world")  # å‡è®¾æœ‰è·å–å‘é‡çš„å‡½æ•°
# translations = service.find_translation(
#     "Hello world", source_vector, 'en', 'zh', limit=5
# )
# for trans in translations:
#     print(f"{trans['source_text']} -> {trans['target_text']} (similarity: {trans['similarity']:.4f})")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-47-01
