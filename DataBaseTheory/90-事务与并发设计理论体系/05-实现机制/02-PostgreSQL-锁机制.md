# 02 | PostgreSQL-é”æœºåˆ¶

> **å®ç°å®šä½**: æœ¬æ–‡æ¡£æ·±å…¥åˆ†æPostgreSQLçš„å¤šç²’åº¦é”æœºåˆ¶ï¼Œä»è¡¨é”åˆ°è¡Œé”çš„å®Œæ•´å®ç°ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | PostgreSQL-é”æœºåˆ¶](#02--postgresql-é”æœºåˆ¶)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [0.0 é” (Lock) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#00-é”-lock-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
    - [0.0.0 æƒå¨å®šä¹‰ä¸æ¥æº](#000-æƒå¨å®šä¹‰ä¸æ¥æº)
    - [0.0.1 å½¢å¼åŒ–å®šä¹‰](#001-å½¢å¼åŒ–å®šä¹‰)
    - [0.0.2 ç†è®ºæ€è„‰](#002-ç†è®ºæ€è„‰)
    - [0.0.3 å®Œæ•´è®ºè¯](#003-å®Œæ•´è®ºè¯)
    - [0.0.4 å…³è”è§£é‡Š](#004-å…³è”è§£é‡Š)
    - [0.0.5 æ€§èƒ½å½±å“åˆ†æ](#005-æ€§èƒ½å½±å“åˆ†æ)
    - [0.0.6 æ€»ç»“](#006-æ€»ç»“)
  - [ä¸€ã€PostgreSQLé”æœºåˆ¶å®ç°èƒŒæ™¯ä¸æ¼”è¿›](#ä¸€postgresqlé”æœºåˆ¶å®ç°èƒŒæ™¯ä¸æ¼”è¿›)
    - [0.1 ä¸ºä»€ä¹ˆéœ€è¦æ·±å…¥ç†è§£PostgreSQLé”æœºåˆ¶å®ç°ï¼Ÿ](#01-ä¸ºä»€ä¹ˆéœ€è¦æ·±å…¥ç†è§£postgresqlé”æœºåˆ¶å®ç°)
    - [0.2 PostgreSQLé”æœºåˆ¶çš„æ ¸å¿ƒæŒ‘æˆ˜](#02-postgresqlé”æœºåˆ¶çš„æ ¸å¿ƒæŒ‘æˆ˜)
  - [äºŒã€é”å±‚æ¬¡ç»“æ„](#äºŒé”å±‚æ¬¡ç»“æ„)
    - [1.1 é”ç²’åº¦å±‚æ¬¡](#11-é”ç²’åº¦å±‚æ¬¡)
    - [1.2 é”æ¨¡å¼](#12-é”æ¨¡å¼)
  - [äºŒã€è¡¨çº§é”](#äºŒè¡¨çº§é”)
    - [2.1 æ•°æ®ç»“æ„](#21-æ•°æ®ç»“æ„)
    - [2.2 åŠ é”æµç¨‹](#22-åŠ é”æµç¨‹)
    - [2.3 å¸¸è§æ“ä½œçš„é”](#23-å¸¸è§æ“ä½œçš„é”)
  - [ä¸‰ã€è¡Œçº§é”](#ä¸‰è¡Œçº§é”)
    - [3.1 å®ç°æ–¹å¼](#31-å®ç°æ–¹å¼)
    - [3.2 å››ç§è¡Œé”æ¨¡å¼](#32-å››ç§è¡Œé”æ¨¡å¼)
    - [3.3 åŠ è¡Œé”å®ç°](#33-åŠ è¡Œé”å®ç°)
  - [3.5 æ­»é” (Deadlock) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#35-æ­»é”-deadlock-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
    - [3.5.0 æƒå¨å®šä¹‰ä¸æ¥æº](#350-æƒå¨å®šä¹‰ä¸æ¥æº)
    - [3.5.1 å½¢å¼åŒ–å®šä¹‰](#351-å½¢å¼åŒ–å®šä¹‰)
    - [3.5.2 ç†è®ºæ€è„‰](#352-ç†è®ºæ€è„‰)
    - [3.5.3 å®Œæ•´è®ºè¯](#353-å®Œæ•´è®ºè¯)
    - [3.5.4 å…³è”è§£é‡Š](#354-å…³è”è§£é‡Š)
    - [3.5.5 æ€§èƒ½å½±å“åˆ†æ](#355-æ€§èƒ½å½±å“åˆ†æ)
    - [3.5.6 æ€»ç»“](#356-æ€»ç»“)
  - [å››ã€æ­»é”æ£€æµ‹](#å››æ­»é”æ£€æµ‹)
    - [4.1 ç­‰å¾…å›¾](#41-ç­‰å¾…å›¾)
    - [4.2 ç¯æ£€æµ‹ç®—æ³•](#42-ç¯æ£€æµ‹ç®—æ³•)
    - [4.3 æ­»é”è§£é™¤](#43-æ­»é”è§£é™¤)
  - [äº”ã€é”ä¼˜åŒ–](#äº”é”ä¼˜åŒ–)
    - [5.1 å¿«é€Ÿè·¯å¾„](#51-å¿«é€Ÿè·¯å¾„)
    - [5.2 é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–](#52-é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–)
  - [å…­ã€æ€»ç»“](#å…­æ€»ç»“)
    - [6.1 æ ¸å¿ƒç‰¹ç‚¹](#61-æ ¸å¿ƒç‰¹ç‚¹)
    - [6.2 æœ€ä½³å®è·µ](#62-æœ€ä½³å®è·µ)
  - [ä¸ƒã€å®Œæ•´æºç åˆ†æ](#ä¸ƒå®Œæ•´æºç åˆ†æ)
    - [7.1 é”ç®¡ç†å™¨åˆå§‹åŒ–](#71-é”ç®¡ç†å™¨åˆå§‹åŒ–)
    - [7.2 é”å†²çªæ£€æµ‹è¯¦ç»†å®ç°](#72-é”å†²çªæ£€æµ‹è¯¦ç»†å®ç°)
    - [7.3 è¡Œé”è¯¦ç»†å®ç°](#73-è¡Œé”è¯¦ç»†å®ç°)
  - [å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#å…«å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: é«˜å¹¶å‘æ›´æ–°å¯¼è‡´çš„é”ç«äº‰](#æ¡ˆä¾‹1-é«˜å¹¶å‘æ›´æ–°å¯¼è‡´çš„é”ç«äº‰)
    - [æ¡ˆä¾‹2: DDLæ“ä½œé˜»å¡æŸ¥è¯¢](#æ¡ˆä¾‹2-ddlæ“ä½œé˜»å¡æŸ¥è¯¢)
  - [ä¹ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜](#ä¹æ€§èƒ½ä¼˜åŒ–å®æˆ˜)
    - [9.1 å¿«é€Ÿè·¯å¾„é”ä¼˜åŒ–](#91-å¿«é€Ÿè·¯å¾„é”ä¼˜åŒ–)
    - [9.2 æ­»é”æ£€æµ‹ä¼˜åŒ–](#92-æ­»é”æ£€æµ‹ä¼˜åŒ–)
  - [åã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#ååä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: é•¿äº‹åŠ¡æŒæœ‰é”](#åä¾‹1-é•¿äº‹åŠ¡æŒæœ‰é”)
    - [åä¾‹2: é”ç²’åº¦ä¸å½“](#åä¾‹2-é”ç²’åº¦ä¸å½“)
    - [åä¾‹3: æ­»é”æ£€æµ‹å®ç°é”™è¯¯](#åä¾‹3-æ­»é”æ£€æµ‹å®ç°é”™è¯¯)
    - [åä¾‹4: é”ç­‰å¾…é˜Ÿåˆ—æœªä¼˜åŒ–](#åä¾‹4-é”ç­‰å¾…é˜Ÿåˆ—æœªä¼˜åŒ–)
    - [åä¾‹5: å¿«é€Ÿè·¯å¾„é”ä½¿ç”¨ä¸å½“](#åä¾‹5-å¿«é€Ÿè·¯å¾„é”ä½¿ç”¨ä¸å½“)
    - [åä¾‹6: é”è¯Šæ–­å·¥å…·ä½¿ç”¨ä¸å½“](#åä¾‹6-é”è¯Šæ–­å·¥å…·ä½¿ç”¨ä¸å½“)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 é”ç®¡ç†å™¨å®Œæ•´å®ç°](#111-é”ç®¡ç†å™¨å®Œæ•´å®ç°)
    - [11.2 æ­»é”æ£€æµ‹ç®—æ³•å®Œæ•´å®ç°](#112-æ­»é”æ£€æµ‹ç®—æ³•å®Œæ•´å®ç°)
    - [11.3 å¿«é€Ÿè·¯å¾„é”å®Œæ•´å®ç°](#113-å¿«é€Ÿè·¯å¾„é”å®Œæ•´å®ç°)
  - [åäºŒã€å®ç°æ¶æ„å¯è§†åŒ–](#åäºŒå®ç°æ¶æ„å¯è§†åŒ–)
    - [12.1 é”ç®¡ç†å™¨æ¶æ„å›¾](#121-é”ç®¡ç†å™¨æ¶æ„å›¾)
    - [12.2 åŠ é”æµç¨‹è®¾è®¡å›¾](#122-åŠ é”æµç¨‹è®¾è®¡å›¾)
    - [12.3 æ­»é”æ£€æµ‹æµç¨‹å›¾](#123-æ­»é”æ£€æµ‹æµç¨‹å›¾)

---

## 0.0 é” (Lock) å®Œæ•´å®šä¹‰ä¸åˆ†æ

### 0.0.0 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> A lock is a mechanism used in database systems to control concurrent access to data. Locks prevent multiple transactions from simultaneously modifying the same data item, ensuring data consistency and preventing conflicts. There are two main types of locks: shared locks (S), which allow multiple transactions to read a data item simultaneously, and exclusive locks (X), which allow only one transaction to both read and write a data item.

**Eswaran et al. (1976) å®šä¹‰**:

> A lock is a mechanism that grants a transaction exclusive or shared access to a data item. Locks are used in two-phase locking (2PL) protocols to ensure serializability and prevent conflicts between concurrent transactions.

**Gray & Reuter (1993) å®šä¹‰**:

> A lock is a synchronization mechanism that controls access to shared resources in a database system. Locks ensure that transactions execute correctly by preventing conflicting operations from executing simultaneously.

**ANSI SQLæ ‡å‡†å®šä¹‰** (SQL:2016):

> A lock is a mechanism that controls concurrent access to data items, ensuring that transactions execute correctly and maintain database consistency.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLé€šè¿‡å¤šç²’åº¦é”æœºåˆ¶å®ç°å¹¶å‘æ§åˆ¶ï¼š

```python
class LockManager:
    """
    PostgreSQLé”å®ç°

    æ ¸å¿ƒæœºåˆ¶:
    1. å¤šç²’åº¦é”: æ•°æ®åº“ã€è¡¨ã€è¡Œçº§é”
    2. é”æ¨¡å¼: å…±äº«é”ã€æ’ä»–é”ç­‰8ç§æ¨¡å¼
    3. é”å…¼å®¹æ€§: é”å…¼å®¹æ€§çŸ©é˜µ
    4. æ­»é”æ£€æµ‹: ç­‰å¾…å›¾ + ç¯æ£€æµ‹
    """
    def __init__(self):
        self.lock_table = {}  # é”è¡¨
        self.wait_queue = []  # ç­‰å¾…é˜Ÿåˆ—
        self.deadlock_detector = DeadlockDetector()

    def acquire_lock(self, transaction, resource, lock_mode):
        # 1. æ£€æŸ¥é”å…¼å®¹æ€§
        if self.is_compatible(resource, lock_mode):
            # 2. æˆäºˆé”
            self.grant_lock(transaction, resource, lock_mode)
            return SUCCESS
        else:
            # 3. åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
            self.wait_for_lock(transaction, resource, lock_mode)
            # 4. æ£€æµ‹æ­»é”
            if self.deadlock_detector.detect():
                return DEADLOCK
            return WAIT
```

**æœ¬ä½“ç³»å®šä¹‰**:

é”æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­æ§åˆ¶å¹¶å‘è®¿é—®çš„åŒæ­¥æœºåˆ¶ï¼Œé€šè¿‡æˆäºˆäº‹åŠ¡å¯¹æ•°æ®é¡¹çš„ç‹¬å æˆ–å…±äº«è®¿é—®æƒé™ï¼Œé˜²æ­¢å¹¶å‘äº‹åŠ¡åŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®é¡¹ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œé˜²æ­¢å†²çªã€‚
PostgreSQLé€šè¿‡å¤šç²’åº¦é”æœºåˆ¶ï¼ˆæ•°æ®åº“é”ã€è¡¨é”ã€è¡Œé”ï¼‰å’Œé”å…¼å®¹æ€§çŸ©é˜µå®ç°é”æœºåˆ¶ã€‚

**é”ä¸å¹¶å‘æ§åˆ¶çš„å…³ç³»**:

```text
é”ä¸å¹¶å‘æ§åˆ¶:
â”‚
â”œâ”€ é” (Lock) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: æ§åˆ¶å¹¶å‘è®¿é—®çš„åŒæ­¥æœºåˆ¶
â”‚       â””â”€ ä½œç”¨: å®ç°å¹¶å‘æ§åˆ¶
â”‚           â”œâ”€ æ–¹æ³•: å…±äº«é”ã€æ’ä»–é”
â”‚           â””â”€ åè®®: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚
â””â”€ å¹¶å‘æ§åˆ¶ (Concurrency Control)
    â””â”€ å®šä¹‰: åè°ƒå¹¶å‘äº‹åŠ¡æ‰§è¡Œçš„æœºåˆ¶
        â””â”€ å®ç°: é€šè¿‡é”æœºåˆ¶å®ç°ï¼ˆ2PLï¼‰
```

---

### 0.0.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰0.0.1 (é” - Eswaran et al., 1976)**:

é”æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ï¼š

$$Lock = (Resource, Mode)$$

å…¶ä¸­ï¼š

- $Resource$: è¢«é”å®šçš„èµ„æºï¼ˆæ•°æ®é¡¹ã€è¡¨ã€è¡Œç­‰ï¼‰
- $Mode$: é”æ¨¡å¼ï¼ˆå…±äº«é”Sã€æ’ä»–é”Xç­‰ï¼‰

**å®šä¹‰0.0.2 (é”å…¼å®¹æ€§)**:

ä¸¤ä¸ªé”å…¼å®¹å½“ä¸”ä»…å½“ï¼š

$$Compatible(Lock_1, Lock_2) \iff Mode_1 \text{ compatible with } Mode_2$$

é”å…¼å®¹æ€§çŸ©é˜µï¼š

| Lock Mode | Shared (S) | Exclusive (X) |
|-----------|-----------|---------------|
| **Shared (S)** | âœ“ | âœ— |
| **Exclusive (X)** | âœ— | âœ— |

**å®šä¹‰0.0.3 (ä¸¤é˜¶æ®µé”åè®® - 2PL)**:

äº‹åŠ¡ $T$ éµå¾ª2PLåè®®å½“ä¸”ä»…å½“ï¼š

$$\forall T: \text{Lock}(T) = \text{GrowingPhase}(T) \cup \text{ShrinkingPhase}(T)$$

å…¶ä¸­ï¼š

- $\text{GrowingPhase}(T)$: å¢é•¿é˜¶æ®µï¼ˆè·å–é”ï¼Œä¸é‡Šæ”¾ï¼‰
- $\text{ShrinkingPhase}(T)$: æ”¶ç¼©é˜¶æ®µï¼ˆé‡Šæ”¾é”ï¼Œä¸è·å–ï¼‰

**å®šä¹‰0.0.4 (æ­»é”)**:

æ­»é”æ˜¯äº‹åŠ¡é›†åˆ $\{T_1, T_2, ..., T_n\}$ ä¸­çš„å¾ªç¯ç­‰å¾…ï¼š

$$Deadlock \iff \exists T_1, T_2, ..., T_n: T_1 \text{ waits for } T_2 \land T_2 \text{ waits for } T_3 \land ... \land T_n \text{ waits for } T_1$$

---

### 0.0.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1976å¹´**: Eswaran et al. æå‡ºä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰
   - é¦–æ¬¡å½¢å¼åŒ–å®šä¹‰é”æœºåˆ¶
   - è¯æ˜2PLå¯ä»¥ä¿è¯å¯ä¸²è¡ŒåŒ–

2. **1980å¹´ä»£**: é”æœºåˆ¶å¹¿æ³›åº”ç”¨
   - å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿé‡‡ç”¨2PL
   - å¤šç²’åº¦é”æœºåˆ¶å‘å±•

3. **1990å¹´ä»£**: é”æœºåˆ¶ä¼˜åŒ–
   - å¿«é€Ÿè·¯å¾„é”
   - æ­»é”æ£€æµ‹ä¼˜åŒ–

4. **2000å¹´ä»£è‡³ä»Š**: é”æœºåˆ¶æˆç†Ÿ
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–é”æ€§èƒ½
   - é”è¯Šæ–­å·¥å…·å‘å±•

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ**

1. **æ•°æ®ä¸€è‡´æ€§çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ— é”æ—¶ï¼Œå¹¶å‘äº‹åŠ¡ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
   - **åæœ**: æ•°æ®ä¸ä¸€è‡´ï¼Œä¸šåŠ¡é€»è¾‘é”™è¯¯
   - **ç¤ºä¾‹**: ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹åŒä¸€è´¦æˆ·ä½™é¢ï¼Œå¯¼è‡´ä½™é¢é”™è¯¯

2. **é”çš„ä¼˜åŠ¿**:
   - **æ­£ç¡®æ€§**: ä¿è¯å¹¶å‘äº‹åŠ¡æ‰§è¡Œæ­£ç¡®
   - **ç®€å•æ€§**: é”æœºåˆ¶ç®€å•ç›´è§‚
   - **å¯é æ€§**: 2PLä¿è¯å¯ä¸²è¡ŒåŒ–

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - æ‰€æœ‰æ•°æ®åº“ç³»ç»Ÿéƒ½éœ€è¦é”æœºåˆ¶
   - é«˜å†²çªåœºæ™¯éœ€è¦é”æœºåˆ¶
   - å†™æ“ä½œéœ€è¦é”æœºåˆ¶

**ç†è®ºä½ç½®**:

```text
å¹¶å‘æ§åˆ¶ç†è®ºä½“ç³»:
â”‚
â”œâ”€ å¹¶å‘æ§åˆ¶ç†è®º
â”‚   â””â”€ æ–¹æ³•: MVCCã€2PLã€OCCã€æ—¶é—´æˆ³æ’åº
â”‚
â”œâ”€ é”ç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚       â”œâ”€ å…±äº«é”: å…è®¸å¤šä¸ªè¯»
â”‚       â”œâ”€ æ’ä»–é”: åªå…è®¸ä¸€ä¸ªå†™
â”‚       â””â”€ æ­»é”: å¾ªç¯ç­‰å¾…
â”‚
â””â”€ MVCCç†è®º
    â””â”€ å®ç°: å¿«ç…§éš”ç¦»ï¼ˆè¯»æ— é”ï¼‰
```

**é”ä¸å¹¶å‘æ§åˆ¶çš„å…³ç³»**:

```text
é”ä¸å¹¶å‘æ§åˆ¶:
â”‚
â”œâ”€ é”æ˜¯æœºåˆ¶
â”‚   â””â”€ é€šè¿‡å…±äº«é”ã€æ’ä»–é”å®ç°
â”‚
â””â”€ å¹¶å‘æ§åˆ¶æ˜¯ç›®æ ‡
    â””â”€ é€šè¿‡é”æœºåˆ¶å®ç°ï¼ˆ2PLï¼‰
```

**ç†è®ºæ¨å¯¼**:

```text
ä»ä¸šåŠ¡éœ€æ±‚åˆ°é”æœºåˆ¶é€‰æ‹©çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: æ•°æ®ä¸€è‡´æ€§ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: å†™å†™å†²çªå¤„ç†ï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: ç®€å•å¯é ï¼ˆé‡è¦ï¼‰

2. é”æœºåˆ¶è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
   â”œâ”€ æœºåˆ¶: å…±äº«é”ã€æ’ä»–é”
   â””â”€ ä¿è¯: å¯ä¸²è¡ŒåŒ–

3. å®ç°é€‰æ‹©
   â”œâ”€ å…±äº«é”: å…è®¸å¤šä¸ªè¯»
   â”œâ”€ æ’ä»–é”: åªå…è®¸ä¸€ä¸ªå†™
   â””â”€ æ­»é”æ£€æµ‹: æ£€æµ‹å¾ªç¯ç­‰å¾…

4. ç»“è®º
   â””â”€ é”æœºåˆ¶æ˜¯å®ç°å¹¶å‘æ§åˆ¶çš„æ ‡å‡†æ–¹æ³•ï¼ˆ2PLï¼‰
```

---

### 0.0.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: å…±äº«é”å®ç°å¹¶å‘è¯»**:

```sql
-- åœºæ™¯: å¤šä¸ªè¯»äº‹åŠ¡å¹¶å‘æ‰§è¡Œ
-- éœ€æ±‚: å…è®¸å¤šä¸ªè¯»ï¼Œä¸é˜»å¡

-- äº‹åŠ¡T1
BEGIN;
SELECT * FROM products WHERE id = 1;  -- è·å–å…±äº«é”
-- è¯»å–æ•°æ® âœ“
COMMIT;  -- é‡Šæ”¾å…±äº«é”

-- äº‹åŠ¡T2ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
BEGIN;
SELECT * FROM products WHERE id = 1;  -- è·å–å…±äº«é”ï¼ˆå…¼å®¹ï¼‰
-- è¯»å–æ•°æ® âœ“
COMMIT;  -- é‡Šæ”¾å…±äº«é”

-- ç»“æœ: å¤šä¸ªè¯»äº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œä¸é˜»å¡ âœ“
```

**åˆ†æ**:

- âœ… é”æœºåˆ¶ä¿è¯ï¼šå…±äº«é”å…è®¸å¤šä¸ªè¯»
- âœ… å¹¶å‘æ€§èƒ½ï¼šå¤šä¸ªè¯»äº‹åŠ¡å¹¶å‘æ‰§è¡Œ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šå…±äº«é”ä¿è¯è¯»ä¸€è‡´æ€§

---

**æ­£ä¾‹2: æ’ä»–é”å®ç°å†™å†™å†²çªå¤„ç†**:

```sql
-- åœºæ™¯: å†™å†™å†²çªå¤„ç†
-- éœ€æ±‚: åªå…è®¸ä¸€ä¸ªå†™ï¼Œé˜²æ­¢å†²çª

-- äº‹åŠ¡T1
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–æ’ä»–é”
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- é‡Šæ”¾æ’ä»–é”

-- äº‹åŠ¡T2ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- ç­‰å¾…æ’ä»–é”
-- ç­‰å¾…T1é‡Šæ”¾é”åç»§ç»­æ‰§è¡Œ âœ“
UPDATE accounts SET balance = balance - 300 WHERE id = 1;
COMMIT;  -- é‡Šæ”¾æ’ä»–é”

-- ç»“æœ: å†™å†™å†²çªè¢«æ­£ç¡®å¤„ç†ï¼Œæ•°æ®ä¸€è‡´ âœ“
```

**åˆ†æ**:

- âœ… é”æœºåˆ¶ä¿è¯ï¼šæ’ä»–é”é˜²æ­¢å†™å†™å†²çª
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šå†™æ“ä½œä¸²è¡ŒåŒ–æ‰§è¡Œ
- âœ… å†²çªå¤„ç†ï¼šé”æœºåˆ¶æ­£ç¡®å¤„ç†å†²çª

---

**åä¾‹åˆ†æ**:

**åä¾‹1: æ— é”å¯¼è‡´æ•°æ®ä¸ä¸€è‡´**:

```sql
-- é”™è¯¯åœºæ™¯: æ— é”ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- é—®é¢˜: å¹¶å‘å†™å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

-- äº‹åŠ¡T1
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
-- è¯»å–: balance = 1000
-- å†™å…¥: balance = 800

-- äº‹åŠ¡T2ï¼ˆå¹¶å‘æ‰§è¡Œï¼Œæ— é”ï¼‰
UPDATE accounts SET balance = balance - 300 WHERE id = 1;
-- è¯»å–: balance = 1000ï¼ˆæœªçœ‹åˆ°T1çš„ä¿®æ”¹ï¼‰âœ—
-- å†™å…¥: balance = 700ï¼ˆè¦†ç›–T1çš„ä¿®æ”¹ï¼‰âœ—

-- ç»“æœ: æ•°æ®ä¸ä¸€è‡´ï¼ˆåº”è¯¥ä¸º500ï¼Œå®é™…ä¸º700ï¼‰âœ—
```

**é”™è¯¯åŸå› **:

- æ— é”ï¼Œå¹¶å‘å†™å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- ä¸¢å¤±æ›´æ–°ï¼Œæ•°æ®é”™è¯¯
- æ— æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨æ’ä»–é”ï¼ˆé˜²æ­¢å†™å†™å†²çªï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–æ’ä»–é”
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- é‡Šæ”¾æ’ä»–é”
-- é”æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: å¹¶å‘å†™å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: å¯¼è‡´ä¸šåŠ¡æ“ä½œé”™è¯¯
- **ç³»ç»Ÿä¸å¯é **: æ— æ³•ä¿è¯æ•°æ®æ­£ç¡®æ€§

---

**åä¾‹2: é•¿äº‹åŠ¡æŒæœ‰é”å¯¼è‡´æ€§èƒ½ä¸‹é™**:

```sql
-- é”™è¯¯åœºæ™¯: é•¿äº‹åŠ¡æŒæœ‰é”
-- é—®é¢˜: å…¶ä»–äº‹åŠ¡é•¿æ—¶é—´ç­‰å¾…

-- äº‹åŠ¡T1ï¼ˆé•¿äº‹åŠ¡ï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–æ’ä»–é”
-- æ‰§è¡Œé•¿æ—¶é—´ä¸šåŠ¡é€»è¾‘ï¼ˆ10ç§’ï¼‰âœ—
-- é”è¢«æŒæœ‰10ç§’ï¼Œå…¶ä»–äº‹åŠ¡ç­‰å¾… âœ—
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- é‡Šæ”¾æ’ä»–é”

-- äº‹åŠ¡T2ï¼ˆç­‰å¾…é”ï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- ç­‰å¾…é”ï¼ˆ10ç§’ï¼‰âœ—
-- å»¶è¿Ÿ: 10ç§’ âœ—
COMMIT;

-- ç»“æœ: æ€§èƒ½ä¸¥é‡ä¸‹é™ âœ—
```

**é”™è¯¯åŸå› **:

- é•¿äº‹åŠ¡æŒæœ‰é”ï¼Œå…¶ä»–äº‹åŠ¡é•¿æ—¶é—´ç­‰å¾…
- æ€§èƒ½ä¸¥é‡ä¸‹é™
- ç”¨æˆ·ä½“éªŒå·®

**æ­£ç¡®åšæ³•**:

```sql
-- ç¼©çŸ­äº‹åŠ¡æ—¶é—´ï¼Œå¿«é€Ÿé‡Šæ”¾é”
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- å¿«é€Ÿé‡Šæ”¾é” âœ“
-- é”æŒæœ‰æ—¶é—´çŸ­ï¼Œæ€§èƒ½é«˜ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½å´©æºƒ**: å»¶è¿Ÿå¢åŠ 10ç§’
- **ç”¨æˆ·ä½“éªŒå·®**: å“åº”æ—¶é—´è¿‡é•¿
- **ç³»ç»Ÿä¸ç¨³å®š**: æ— æ³•æ»¡è¶³ä¸šåŠ¡éœ€æ±‚

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘è¯»ç³»ç»Ÿä½¿ç”¨å…±äº«é”**:

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘è¯»ç³»ç»Ÿï¼ˆ1000+ QPSï¼‰
- è¯»å¤šå†™å°‘ï¼ˆ90%è¯»ï¼Œ10%å†™ï¼‰
- éœ€è¦é«˜æ€§èƒ½

**ä¸ºä»€ä¹ˆéœ€è¦é”**:

- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šå…±äº«é”ä¿è¯è¯»ä¸€è‡´æ€§
- âœ… é«˜æ€§èƒ½ï¼šå…±äº«é”å…è®¸å¤šä¸ªè¯»å¹¶å‘
- âœ… ä¸šåŠ¡è¿ç»­æ€§ï¼šä¿è¯ä¸šåŠ¡æ­£å¸¸è¿è¡Œ

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ä½¿ç”¨å…±äº«é”ï¼ˆSELECTè‡ªåŠ¨è·å–ï¼‰
BEGIN;
SELECT * FROM products WHERE id = 1;  -- è‡ªåŠ¨è·å–å…±äº«é”
COMMIT;  -- è‡ªåŠ¨é‡Šæ”¾å…±äº«é”
```

**æ•ˆæœåˆ†æ**:

- **é”æœºåˆ¶**: å…±äº«é”å®ç°é«˜å¹¶å‘è¯» âœ“
- **æ€§èƒ½**: TPS = 50,000+ âœ“
- **ä¸€è‡´æ€§**: å…±äº«é”ä¿è¯è¯»ä¸€è‡´æ€§ âœ“

---

**åœºæ™¯2: é«˜å†²çªå†™ç³»ç»Ÿä½¿ç”¨æ’ä»–é”**:

**åœºæ™¯æè¿°**:

- é«˜å†²çªå†™ç³»ç»Ÿï¼ˆå†²çªç‡>10%ï¼‰
- å†™å¤šè¯»å°‘ï¼ˆ70%å†™ï¼Œ30%è¯»ï¼‰
- éœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§

**ä¸ºä»€ä¹ˆéœ€è¦é”**:

- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ’ä»–é”é˜²æ­¢å†™å†™å†²çª
- âœ… ä¸¥æ ¼ä¸€è‡´æ€§ï¼šé”æœºåˆ¶ä¿è¯ä¸€è‡´æ€§
- âœ… ä¸šåŠ¡å¯é æ€§ï¼šä¿è¯ä¸šåŠ¡æ“ä½œæ­£ç¡®

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ä½¿ç”¨æ’ä»–é”ï¼ˆSELECT FOR UPDATEï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–æ’ä»–é”
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- é‡Šæ”¾æ’ä»–é”
```

**æ•ˆæœåˆ†æ**:

- **é”æœºåˆ¶**: æ’ä»–é”é˜²æ­¢å†™å†™å†²çª âœ“
- **æ€§èƒ½**: TPS = 10,000+ï¼ˆå¯æ¥å—ï¼‰âœ“
- **ä¸€è‡´æ€§**: ä¸¥æ ¼ä¸€è‡´æ€§ä¿è¯ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»ä¸šåŠ¡éœ€æ±‚åˆ°é”æœºåˆ¶é€‰æ‹©çš„æ¨ç†**:

```text
å‰æ1: ä¸šåŠ¡éœ€æ±‚æ˜¯æ•°æ®ä¸€è‡´æ€§ï¼ˆå¿…é¡»ï¼‰
å‰æ2: ä¸šåŠ¡éœ€æ±‚æ˜¯å†™å†™å†²çªå¤„ç†ï¼ˆå¿…é¡»ï¼‰
å‰æ3: éœ€è¦é”æœºåˆ¶ä¿è¯ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©é”æœºåˆ¶
æ¨ç†æ­¥éª¤2: 2PLä¿è¯å¯ä¸²è¡ŒåŒ–ï¼ˆæ»¡è¶³å‰æ1,2ï¼‰
æ¨ç†æ­¥éª¤3: å…±äº«é”é€‚åˆè¯»ï¼Œæ’ä»–é”é€‚åˆå†™

ç»“è®º: ä½¿ç”¨é”æœºåˆ¶å®ç°å¹¶å‘æ§åˆ¶ âœ“
```

**æ¨ç†é“¾æ¡2: ä»é”æœºåˆ¶åˆ°å¹¶å‘æ§åˆ¶å®ç°çš„æ¨ç†**:

```text
å‰æ1: é”æœºåˆ¶æ§åˆ¶å¹¶å‘è®¿é—®
å‰æ2: å¹¶å‘æ§åˆ¶éœ€è¦é”æœºåˆ¶å®ç°
å‰æ3: 2PLä¿è¯å¯ä¸²è¡ŒåŒ–

æ¨ç†æ­¥éª¤1: é”æœºåˆ¶ä¿è¯å¹¶å‘è®¿é—®æ­£ç¡®
æ¨ç†æ­¥éª¤2: å¹¶å‘æ§åˆ¶é€šè¿‡é”æœºåˆ¶å®ç°
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼Œé”æœºåˆ¶æ˜¯å®ç°å¹¶å‘æ§åˆ¶çš„æ‰‹æ®µ

ç»“è®º: é”æœºåˆ¶æ˜¯å®ç°å¹¶å‘æ§åˆ¶çš„æ‰‹æ®µï¼ˆ2PLï¼‰âœ“
```

---

### 0.0.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¹¶å‘æ§åˆ¶çš„å…³ç³»**:
   - é”æ˜¯å¹¶å‘æ§åˆ¶çš„ä¸€ç§æœºåˆ¶
   - 2PLä½¿ç”¨é”æœºåˆ¶å®ç°å¹¶å‘æ§åˆ¶
   - é”æœºåˆ¶æ˜¯2PLçš„æ ¸å¿ƒ

2. **ä¸äº‹åŠ¡çš„å…³ç³»**:
   - é”åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶è·å–å’Œé‡Šæ”¾
   - 2PLä¿è¯äº‹åŠ¡çš„å¯ä¸²è¡ŒåŒ–
   - äº‹åŠ¡æ˜¯é”çš„åŸºæœ¬å•å…ƒ

3. **ä¸æ­»é”çš„å…³ç³»**:
   - æ­»é”æ˜¯é”æœºåˆ¶çš„é—®é¢˜
   - æ­»é”æ£€æµ‹æ˜¯é”æœºåˆ¶çš„ä¸€éƒ¨åˆ†
   - æ­»é”é¢„é˜²æ˜¯é”æœºåˆ¶çš„è®¾è®¡ç›®æ ‡

4. **ä¸MVCCçš„å…³ç³»**:
   - MVCCè¯»æ“ä½œæ— é”ï¼ˆå¿«ç…§è¯»ï¼‰
   - MVCCå†™æ“ä½œä½¿ç”¨é”ï¼ˆè¡Œé”ï¼‰
   - MVCCå’Œé”æœºåˆ¶äº’è¡¥

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQLé”å®ç°
   - å¤šç²’åº¦é”ï¼ˆæ•°æ®åº“ã€è¡¨ã€è¡Œï¼‰
   - é”å…¼å®¹æ€§çŸ©é˜µ
   - æ­»é”æ£€æµ‹

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - é” â‰ˆ Mutex/RwLock
   - å…±äº«é” â‰ˆ RwLockè¯»é”
   - æ’ä»–é” â‰ˆ Mutex/RwLockå†™é”

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - é” â‰ˆ åˆ†å¸ƒå¼é”
   - æ­»é” â‰ˆ åˆ†å¸ƒå¼æ­»é”
   - é”åè°ƒ â‰ˆ åˆ†å¸ƒå¼åè°ƒ

**å®ç°ç»†èŠ‚**:

**PostgreSQLé”å®ç°æ¶æ„**:

```c
// src/backend/storage/lmgr/lock.c

// é”ç®¡ç†å™¨
typedef struct LockManager {
    HTAB *lockHashTable;      // é”å“ˆå¸Œè¡¨
    SHM_QUEUE waitQueue;      // ç­‰å¾…é˜Ÿåˆ—
    DeadlockDetector *detector; // æ­»é”æ£€æµ‹å™¨
} LockManager;

// è·å–é”
LockAcquireResult LockAcquire(LOCKTAG *locktag, LOCKMODE lockmode)
{
    // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºé”
    LOCK *lock = LockHashTableLookup(locktag);

    // 2. æ£€æŸ¥é”å…¼å®¹æ€§
    if (LockCheckConflicts(lock, lockmode)) {
        // 3. æˆäºˆé”
        GrantLock(lock, lockmode);
        return LOCKACQUIRE_OK;
    } else {
        // 4. åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
        WaitOnLock(lock, lockmode);
        // 5. æ£€æµ‹æ­»é”
        if (CheckDeadLock()) {
            return LOCKACQUIRE_DEADLOCK;
        }
        return LOCKACQUIRE_NOT_AVAIL;
    }
}
```

**é”æœºåˆ¶ä¿è¯**:

```python
def ensure_lock_mechanism(transaction):
    """
    ç¡®ä¿é”æœºåˆ¶

    æœºåˆ¶:
    1. å…±äº«é”: å…è®¸å¤šä¸ªè¯»
    2. æ’ä»–é”: åªå…è®¸ä¸€ä¸ªå†™
    3. æ­»é”æ£€æµ‹: æ£€æµ‹å¾ªç¯ç­‰å¾…
    """
    # 1. è¯»æ“ä½œè·å–å…±äº«é”
    if operation.type == 'READ':
        acquire_shared_lock(operation.resource)

    # 2. å†™æ“ä½œè·å–æ’ä»–é”
    if operation.type == 'WRITE':
        acquire_exclusive_lock(operation.resource)

    # 3. æ‰§è¡Œæ“ä½œ
    execute_operation(operation)

    # 4. é‡Šæ”¾é”ï¼ˆäº‹åŠ¡ç»“æŸæ—¶ï¼‰
    release_locks(transaction)

    return True
```

**æ€§èƒ½å½±å“**:

1. **é”å¼€é”€**:
   - é”è·å–: $O(1)$ - å“ˆå¸Œè¡¨æŸ¥æ‰¾
   - é”é‡Šæ”¾: $O(1)$ - å“ˆå¸Œè¡¨æ›´æ–°
   - æ­»é”æ£€æµ‹: $O(V + E)$ - å›¾éå†

2. **æ€»ä½“æ€§èƒ½**:
   - å…±äº«é”: å¼€é”€å°ï¼ˆ1-5Î¼sï¼‰
   - æ’ä»–é”: å¼€é”€ä¸­ç­‰ï¼ˆ1-10Î¼sï¼‰
   - æ­»é”æ£€æµ‹: å¼€é”€è¾ƒå¤§ï¼ˆ10-100Î¼sï¼‰

---

### 0.0.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**é”å¼€é”€**:

$$T_{lock} = T_{acquire} + T_{wait} + T_{release} + T_{deadlock\_detection}$$

å…¶ä¸­ï¼š

- $T_{acquire} = O(1)$ - é”è·å–æ—¶é—´ï¼ˆå“ˆå¸Œè¡¨æŸ¥æ‰¾ï¼‰
- $T_{wait}$ - é”ç­‰å¾…æ—¶é—´ï¼ˆå–å†³äºå†²çªï¼‰
- $T_{release} = O(1)$ - é”é‡Šæ”¾æ—¶é—´
- $T_{deadlock\_detection} = O(V + E)$ - æ­»é”æ£€æµ‹æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | é”è·å–å¼€é”€ | é”ç­‰å¾…å¼€é”€ | æ­»é”æ£€æµ‹å¼€é”€ | æ€»ä½“å½±å“ | è¯´æ˜ |
|-----|----------|----------|------------|---------|------|
| **å…±äº«é”ï¼ˆæ— å†²çªï¼‰** | 1-5Î¼s | 0Î¼s | 0Î¼s | 1-5% | å¼€é”€å¾ˆå° |
| **æ’ä»–é”ï¼ˆæ— å†²çªï¼‰** | 1-10Î¼s | 0Î¼s | 0Î¼s | 5-10% | å¼€é”€å¯æ¥å— |
| **æ’ä»–é”ï¼ˆæœ‰å†²çªï¼‰** | 1-10Î¼s | 1-100ms | 10-100Î¼s | 50-90% | ç­‰å¾…æ˜¯ä¸»è¦ç“¶é¢ˆ |
| **æ­»é”åœºæ™¯** | 1-10Î¼s | 1-100ms | 10-100Î¼s | 90%+ | æ­»é”æ£€æµ‹å¼€é”€å¤§ |

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘é”ç­‰å¾…**:
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´
   - å‡å°‘é”æŒæœ‰æ—¶é—´
   - ä¼˜åŒ–é”ç²’åº¦

2. **ä¼˜åŒ–æ­»é”æ£€æµ‹**:
   - å¢é‡æ­»é”æ£€æµ‹
   - ä¼˜åŒ–ç­‰å¾…å›¾æ„å»º
   - å‡å°‘æ­»é”é¢‘ç‡

3. **ä½¿ç”¨å¿«é€Ÿè·¯å¾„é”**:
   - ä½¿ç”¨å¿«é€Ÿè·¯å¾„é”ï¼ˆPostgreSQLï¼‰
   - å‡å°‘å…±äº«å†…å­˜è®¿é—®
   - æå‡é”æ€§èƒ½

---

### 0.0.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: é”æ˜¯æ§åˆ¶å¹¶å‘è®¿é—®çš„åŒæ­¥æœºåˆ¶
2. **ç±»å‹**: å…±äº«é”ï¼ˆå…è®¸å¤šä¸ªè¯»ï¼‰ã€æ’ä»–é”ï¼ˆåªå…è®¸ä¸€ä¸ªå†™ï¼‰
3. **åè®®**: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰ä¿è¯å¯ä¸²è¡ŒåŒ–
4. **æ€§èƒ½**: é”å¼€é”€å¯æ¥å—ï¼Œä½†ç­‰å¾…æ˜¯ä¸»è¦ç“¶é¢ˆ

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºé”å°±æ˜¯æ’ä»–é”
   - **é”™è¯¯**: é”åŒ…æ‹¬å…±äº«é”å’Œæ’ä»–é”
   - **æ­£ç¡®**: å…±äº«é”å…è®¸å¤šä¸ªè¯»ï¼Œæ’ä»–é”åªå…è®¸ä¸€ä¸ªå†™

2. **è¯¯åŒº2**: è®¤ä¸ºæ‰€æœ‰åœºæ™¯éƒ½éœ€è¦é”
   - **é”™è¯¯**: MVCCè¯»æ“ä½œæ— é”ï¼ˆå¿«ç…§è¯»ï¼‰
   - **æ­£ç¡®**: å†™æ“ä½œéœ€è¦é”ï¼Œè¯»æ“ä½œå¯èƒ½æ— é”ï¼ˆMVCCï¼‰

3. **è¯¯åŒº3**: å¿½ç•¥æ­»é”çš„é‡è¦æ€§
   - **é”™è¯¯**: è®¤ä¸ºæ­»é”ä¸ä¼šå‘ç”Ÿ
   - **æ­£ç¡®**: æ­»é”æ˜¯é”æœºåˆ¶çš„é—®é¢˜ï¼Œéœ€è¦æ£€æµ‹å’Œå¤„ç†

**æœ€ä½³å®è·µ**:

1. **ç†è§£é”ç±»å‹**: ç†è§£å…±äº«é”å’Œæ’ä»–é”çš„åŒºåˆ«
2. **ç¼©çŸ­é”æŒæœ‰æ—¶é—´**: ç¼©çŸ­äº‹åŠ¡æ—¶é—´ï¼Œå¿«é€Ÿé‡Šæ”¾é”
3. **é¿å…æ­»é”**: ç»Ÿä¸€é”é¡ºåºï¼Œé¿å…å¾ªç¯ç­‰å¾…
4. **ç›‘æ§é”æ€§èƒ½**: ç›‘æ§é”ç­‰å¾…ã€æ­»é”é¢‘ç‡ç­‰æŒ‡æ ‡

---

## ä¸€ã€PostgreSQLé”æœºåˆ¶å®ç°èƒŒæ™¯ä¸æ¼”è¿›

### 0.1 ä¸ºä»€ä¹ˆéœ€è¦æ·±å…¥ç†è§£PostgreSQLé”æœºåˆ¶å®ç°ï¼Ÿ

**å†å²èƒŒæ™¯**:

PostgreSQLçš„é”æœºåˆ¶æ˜¯MVCCçš„é‡è¦è¡¥å……ï¼Œç”¨äºå¤„ç†å†™å†™å†²çªå’ŒDDLæ“ä½œã€‚ä»PostgreSQLæ—©æœŸç‰ˆæœ¬å¼€å§‹ï¼Œå°±å®ç°äº†å¤šç²’åº¦é”æœºåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®åº“é”ã€è¡¨é”ã€è¡Œé”ç­‰ã€‚éšç€ç‰ˆæœ¬æ¼”è¿›ï¼ŒPostgreSQLä¸æ–­ä¼˜åŒ–é”æœºåˆ¶ï¼ŒåŒ…æ‹¬å¿«é€Ÿè·¯å¾„é”ã€æ­»é”æ£€æµ‹ä¼˜åŒ–ç­‰ã€‚ç†è§£PostgreSQLé”æœºåˆ¶çš„æºç å®ç°ï¼Œæœ‰åŠ©äºä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ã€é¿å…æ­»é”ã€è¯Šæ–­é”ç«äº‰é—®é¢˜ã€‚

**ç†è®ºåŸºç¡€**:

```text
PostgreSQLé”æœºåˆ¶å®ç°çš„æ ¸å¿ƒ:
â”œâ”€ é—®é¢˜: å¦‚ä½•åœ¨æºç å±‚é¢å®ç°å¤šç²’åº¦é”ï¼Ÿ
â”œâ”€ ç†è®º: é”ç†è®ºï¼ˆå¤šç²’åº¦é”ã€æ­»é”æ£€æµ‹ï¼‰
â””â”€ å®ç°: Cæºç å®ç°ï¼ˆé”ç®¡ç†å™¨ã€æ­»é”æ£€æµ‹ï¼‰

ä¸ºä»€ä¹ˆéœ€è¦æ·±å…¥ç†è§£å®ç°?
â”œâ”€ ç†è®ºç†è§£: å°†ç†è®ºä¸å®ç°å¯¹åº”
â”œâ”€ æ€§èƒ½ä¼˜åŒ–: ç†è§£å®ç°ç»†èŠ‚ï¼Œä¼˜åŒ–æ€§èƒ½
â””â”€ é—®é¢˜è¯Šæ–­: ç†è§£å®ç°ï¼Œè¯Šæ–­é”é—®é¢˜
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
PostgreSQLé”æœºåˆ¶å®ç°æ¼”è¿›:
â”œâ”€ æ—©æœŸç‰ˆæœ¬ (1990s-2000s)
â”‚   â”œâ”€ åŸºç¡€é”æœºåˆ¶
â”‚   â”œâ”€ å¤šç²’åº¦é”
â”‚   â””â”€ æ­»é”æ£€æµ‹
â”‚
â”œâ”€ ä¼˜åŒ–é˜¶æ®µ (2000s-2010s)
â”‚   â”œâ”€ å¿«é€Ÿè·¯å¾„é” (PostgreSQL 9.3)
â”‚   â”œâ”€ é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–
â”‚   â””â”€ æ­»é”æ£€æµ‹ä¼˜åŒ–
â”‚
â””â”€ ç°ä»£ç‰ˆæœ¬ (2010s+)
    â”œâ”€ é”æ€§èƒ½æŒç»­ä¼˜åŒ–
    â”œâ”€ é”è¯Šæ–­å·¥å…·
    â””â”€ é”ç›‘æ§å¢å¼º
```

**ä¸ºä»€ä¹ˆPostgreSQLé”æœºåˆ¶å®ç°é‡è¦ï¼Ÿ**:

1. **ç†è®ºæ˜ å°„**: å°†é”ç†è®ºä¸å®é™…å®ç°å¯¹åº”
2. **æ€§èƒ½ä¼˜åŒ–**: ç†è§£å®ç°ç»†èŠ‚ï¼Œä¼˜åŒ–é”æ€§èƒ½
3. **é—®é¢˜è¯Šæ–­**: ç†è§£å®ç°ï¼Œè¯Šæ–­æ­»é”å’Œé”ç«äº‰
4. **ç³»ç»Ÿè®¾è®¡**: ä¸ºè®¾è®¡æ–°ç³»ç»Ÿæä¾›å‚è€ƒ

**åä¾‹: ä¸ç†è§£é”å®ç°å¯¼è‡´çš„é—®é¢˜**:

```text
é”™è¯¯è®¾è®¡: ä¸ç†è§£é”å®ç°ï¼Œç›²ç›®ä¼˜åŒ–
â”œâ”€ åœºæ™¯: é«˜å¹¶å‘æ›´æ–°é”ç«äº‰é—®é¢˜
â”œâ”€ é—®é¢˜: ä¸ç†è§£è¡Œé”å®ç°
â”œâ”€ ç»“æœ: ä¼˜åŒ–æ–¹å‘é”™è¯¯ï¼Œé”ç«äº‰æœªç¼“è§£
â””â”€ åæœ: æ€§èƒ½æœªæå‡ âœ—

æ­£ç¡®è®¾è®¡: æ·±å…¥ç†è§£é”å®ç°
â”œâ”€ æ–¹æ¡ˆ: ç†è§£è¡Œé”å®ç°ï¼Œä¼˜åŒ–é”ç²’åº¦
â”œâ”€ ç»“æœ: é’ˆå¯¹æ€§åœ°ä¼˜åŒ–ï¼Œé”ç«äº‰ç¼“è§£
â””â”€ æ•ˆæœ: æ€§èƒ½æå‡30%+ âœ“
```

### 0.2 PostgreSQLé”æœºåˆ¶çš„æ ¸å¿ƒæŒ‘æˆ˜

**å†å²èƒŒæ™¯**:

PostgreSQLé”æœºåˆ¶é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜åŒ…æ‹¬ï¼šå¦‚ä½•é«˜æ•ˆåœ°ç®¡ç†é”ã€å¦‚ä½•å¿«é€Ÿæ£€æµ‹æ­»é”ã€å¦‚ä½•é¿å…é”ç«äº‰ã€å¦‚ä½•ä¼˜åŒ–é”æ€§èƒ½ç­‰ã€‚è¿™äº›æŒ‘æˆ˜ä¿ƒä½¿PostgreSQLä¸æ–­ä¼˜åŒ–é”æœºåˆ¶å®ç°ã€‚

**ç†è®ºåŸºç¡€**:

```text
é”æœºåˆ¶å®ç°æŒ‘æˆ˜:
â”œâ”€ ç®¡ç†æŒ‘æˆ˜: å¦‚ä½•é«˜æ•ˆç®¡ç†å¤§é‡é”
â”œâ”€ æ­»é”æŒ‘æˆ˜: å¦‚ä½•å¿«é€Ÿæ£€æµ‹æ­»é”
â”œâ”€ ç«äº‰æŒ‘æˆ˜: å¦‚ä½•é¿å…é”ç«äº‰
â””â”€ æ€§èƒ½æŒ‘æˆ˜: å¦‚ä½•ä¼˜åŒ–é”æ€§èƒ½

PostgreSQLè§£å†³æ–¹æ¡ˆ:
â”œâ”€ ç®¡ç†: é”ç®¡ç†å™¨ + å¿«é€Ÿè·¯å¾„
â”œâ”€ æ­»é”: ç­‰å¾…å›¾ + ç¯æ£€æµ‹
â”œâ”€ ç«äº‰: é”ç²’åº¦ä¼˜åŒ–
â””â”€ æ€§èƒ½: å¿«é€Ÿè·¯å¾„é” + é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–
```

---

## äºŒã€é”å±‚æ¬¡ç»“æ„

### 1.1 é”ç²’åº¦å±‚æ¬¡

```text
æ•°æ®åº“é” (DATABASE)
    â†“
Schemaé” (SCHEMA)
    â†“
è¡¨é” (TABLE)
    â†“
é¡µé” (PAGE) - PostgreSQLä¸ä½¿ç”¨
    â†“
è¡Œé” (ROW)
    â†“
å…ƒç»„é” (TUPLE)
```

### 1.2 é”æ¨¡å¼

**è¡¨çº§é”æ¨¡å¼** (8ç§):

```c
typedef enum LockMode {
    AccessShareLock,      // SELECT
    RowShareLock,         // SELECT FOR UPDATE
    RowExclusiveLock,     // INSERT/UPDATE/DELETE
    ShareUpdateExclusiveLock,  // VACUUM
    ShareLock,            // CREATE INDEX
    ShareRowExclusiveLock,
    ExclusiveLock,        // LOCK TABLE ... EXCLUSIVE
    AccessExclusiveLock   // ALTER TABLE/DROP TABLE
} LockMode;
```

**å…¼å®¹æ€§çŸ©é˜µ**:

|  | AS | RS | RE | SUE | S | SRE | E | AE |
|--|----|----|----|----|----|----|---|---|
| AS | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ— |
| RS | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | âœ— |
| RE | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | âœ— | âœ— | âœ— |
| SUE | âœ“ | âœ“ | âœ“ | âœ— | âœ— | âœ— | âœ— | âœ— |
| S | âœ“ | âœ“ | âœ— | âœ— | âœ“ | âœ— | âœ— | âœ— |
| SRE | âœ“ | âœ“ | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— |
| E | âœ“ | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— |
| AE | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— | âœ— |

---

## äºŒã€è¡¨çº§é”

### 2.1 æ•°æ®ç»“æ„

**LOCKç»“æ„**:

```c
typedef struct LOCK {
    LOCKTAG tag;           /* é”æ ‡è¯† */
    LOCKMASK granted;      /* å·²æˆäºˆçš„é”æ¨¡å¼ */
    LOCKMASK waiting;      /* ç­‰å¾…ä¸­çš„é”æ¨¡å¼ */
    SHM_QUEUE procLocks;   /* æŒæœ‰é”çš„è¿›ç¨‹åˆ—è¡¨ */
    PROC_QUEUE waitProcs;  /* ç­‰å¾…é˜Ÿåˆ— */
    int nRequested;        /* è¯·æ±‚æ•° */
    int nGranted;          /* å·²æˆäºˆæ•° */
    ...
} LOCK;
```

**LOCKTAG** (é”æ ‡è¯†):

```c
typedef struct LOCKTAG {
    uint32 locktag_field1;  /* database OID */
    uint32 locktag_field2;  /* relation OID */
    uint32 locktag_field3;  /* page/tuple */
    uint16 locktag_field4;
    uint8 locktag_type;     /* é”ç±»å‹ */
    uint8 locktag_lockmethodid;
} LOCKTAG;
```

### 2.2 åŠ é”æµç¨‹

**æºç ä½ç½®**: `src/backend/storage/lmgr/lock.c`

```c
bool
LockAcquire(const LOCKTAG *locktag,
            LOCKMODE lockmode,
            bool sessionLock,
            bool dontWait)
{
    LOCK *lock;
    PROCLOCK *proclock;

    /* 1. æŸ¥æ‰¾æˆ–åˆ›å»ºLOCKå¯¹è±¡ */
    lock = (LOCK *) hash_search_with_hash_value(
        LockMethodLockHash, (void *) locktag,
        hashcode, HASH_ENTER_NULL, &found);

    if (!found) {
        /* åˆå§‹åŒ–æ–°é” */
        lock->granted = 0;
        lock->waiting = 0;
        SHMQueueInit(&lock->procLocks);
    }

    /* 2. æ£€æŸ¥å…¼å®¹æ€§ */
    if (LockCheckConflicts(lockmode, lock)) {
        /* å†²çªï¼šåŠ å…¥ç­‰å¾…é˜Ÿåˆ— */
        if (dontWait) {
            return false;  /* NOWAITé€‰é¡¹ */
        }

        WaitOnLock(lock, lockmode);
    }

    /* 3. æˆäºˆé” */
    GrantLock(lock, proclock, lockmode);

    return true;
}
```

### 2.3 å¸¸è§æ“ä½œçš„é”

| SQL | è¡¨é”æ¨¡å¼ | è¯´æ˜ |
|-----|---------|------|
| `SELECT` | AccessShareLock | ä¸é˜»å¡ä»»ä½•SELECT/DML |
| `INSERT/UPDATE/DELETE` | RowExclusiveLock | é˜»å¡DDLï¼Œä¸é˜»å¡DML |
| `SELECT FOR UPDATE` | RowShareLock | é˜»å¡ALTER TABLE |
| `CREATE INDEX` | ShareLock | é˜»å¡å†™ï¼Œä¸é˜»å¡è¯» |
| `CREATE INDEX CONCURRENTLY` | ShareUpdateExclusiveLock | ä¸é˜»å¡å†™ |
| `ALTER TABLE` | AccessExclusiveLock | é˜»å¡æ‰€æœ‰ |

---

## ä¸‰ã€è¡Œçº§é”

### 3.1 å®ç°æ–¹å¼

**PostgreSQLè¡Œé”ç‰¹ç‚¹**: å­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨ï¼ˆæ— ç‹¬ç«‹é”è¡¨ï¼‰

```c
typedef struct HeapTupleFields {
    TransactionId t_xmin;
    TransactionId t_xmax;

    union {
        CommandId t_cid;  /* å‘½ä»¤ID */
        TransactionId t_xvac;
    } t_field3;
} HeapTupleFields;
```

**t_infomaskæ ‡å¿—ä½**:

```c
#define HEAP_XMAX_IS_LOCKED_ONLY   0x0080
#define HEAP_XMAX_EXCL_LOCK        0x0040
#define HEAP_XMAX_KEYSHR_LOCK      0x0010
#define HEAP_XMAX_SHR_LOCK         0x0020
```

### 3.2 å››ç§è¡Œé”æ¨¡å¼

| é”æ¨¡å¼ | SQL | infomask | ç”¨é€” |
|-------|-----|---------|------|
| **FOR KEY SHARE** | SELECT FOR KEY SHARE | KEYSHR_LOCK | é˜²æ­¢DELETE |
| **FOR SHARE** | SELECT FOR SHARE | SHR_LOCK | é˜²æ­¢UPDATE/DELETE |
| **FOR NO KEY UPDATE** | SELECT FOR NO KEY UPDATE | EXCL_LOCK | é˜²æ­¢DELETEå’Œé”®æ›´æ–° |
| **FOR UPDATE** | SELECT FOR UPDATE | EXCL_LOCK+KEYS | é˜²æ­¢æ‰€æœ‰ä¿®æ”¹ |

**å…¼å®¹æ€§**:

|  | KEY SHARE | SHARE | NO KEY UPDATE | UPDATE |
|--|-----------|-------|---------------|--------|
| KEY SHARE | âœ“ | âœ“ | âœ“ | âœ— |
| SHARE | âœ“ | âœ“ | âœ— | âœ— |
| NO KEY UPDATE | âœ“ | âœ— | âœ— | âœ— |
| UPDATE | âœ— | âœ— | âœ— | âœ— |

### 3.3 åŠ è¡Œé”å®ç°

**æºç ä½ç½®**: `src/backend/access/heap/heapam.c`

```c
TM_Result
heap_lock_tuple(Relation relation, HeapTuple tuple,
                CommandId cid, LockTupleMode mode, ...)
{
    Buffer buffer;
    HeapTupleData mytup;
    TransactionId xid = GetCurrentTransactionId();

    /* 1. è¯»å–å…ƒç»„ */
    buffer = ReadBuffer(relation, ItemPointerGetBlockNumber(&tuple->t_self));
    LockBuffer(buffer, BUFFER_LOCK_EXCLUSIVE);

    /* 2. æ£€æŸ¥å¯è§æ€§ */
    if (!HeapTupleSatisfiesUpdate(mytup, cid, buffer)) {
        /* å…ƒç»„å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ */
        UnlockReleaseBuffer(buffer);
        return TM_Updated;
    }

    /* 3. æ£€æŸ¥ç°æœ‰é” */
    xmax = HeapTupleHeaderGetXmax(mytup.t_data);
    if (TransactionIdIsValid(xmax)) {
        /* å·²æœ‰é”ï¼Œæ£€æŸ¥å…¼å®¹æ€§ */
        if (!LockModeCompatible(existing_mode, mode)) {
            /* ä¸å…¼å®¹ï¼Œç­‰å¾… */
            XactLockTableWait(xmax);
        }
    }

    /* 4. è®¾ç½®é” */
    HeapTupleHeaderSetXmax(mytup.t_data, xid);
    mytup.t_data->t_infomask &= ~HEAP_XMAX_BITS;
    mytup.t_data->t_infomask |= compute_infomask_flags(mode);

    /* 5. æ ‡è®°é¡µé¢ä¸ºè„ */
    MarkBufferDirty(buffer);
    UnlockReleaseBuffer(buffer);

    return TM_Ok;
}
```

---

## 3.5 æ­»é” (Deadlock) å®Œæ•´å®šä¹‰ä¸åˆ†æ

### 3.5.0 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> A deadlock is a situation in concurrent systems where two or more transactions are each waiting for the other to release a resource, creating a circular wait condition. In database systems, deadlocks occur when transactions hold locks on resources and wait for locks held by other transactions, forming a cycle in the wait-for graph.

**Eswaran et al. (1976) å®šä¹‰**:

> A deadlock is a circular wait condition in which a set of transactions are each waiting for resources held by others in the set. Deadlocks can be detected by constructing a wait-for graph and checking for cycles.

**Gray & Reuter (1993) å®šä¹‰**:

> A deadlock is a situation where two or more transactions are blocked, each waiting for the other to release a lock, resulting in a circular dependency. Deadlock detection algorithms identify cycles in the wait-for graph and resolve them by aborting one or more transactions.

**ANSI SQLæ ‡å‡†å®šä¹‰** (SQL:2016):

> A deadlock is a circular wait condition where transactions are waiting for each other to release resources. Database systems must detect and resolve deadlocks to ensure system progress.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLé€šè¿‡ç­‰å¾…å›¾å’ŒDFSç¯æ£€æµ‹å®ç°æ­»é”æ£€æµ‹ï¼š

```python
class DeadlockDetector:
    """
    PostgreSQLæ­»é”æ£€æµ‹å®ç°

    æ ¸å¿ƒæœºåˆ¶:
    1. ç­‰å¾…å›¾: æ„å»ºäº‹åŠ¡ç­‰å¾…å…³ç³»å›¾
    2. ç¯æ£€æµ‹: DFSæ£€æµ‹ç­‰å¾…å›¾ä¸­çš„ç¯
    3. ç‰ºç‰²è€…é€‰æ‹©: é€‰æ‹©æ­»é”ç¯ä¸­çš„ç‰ºç‰²è€…
    4. æ­»é”è§£é™¤: å›æ»šç‰ºç‰²è€…äº‹åŠ¡
    """
    def __init__(self):
        self.wait_graph = {}  # ç­‰å¾…å›¾: {waiter: {holders}}

    def detect_deadlock(self):
        # 1. æ„å»ºç­‰å¾…å›¾
        self.build_wait_graph()

        # 2. DFSæ£€æµ‹ç¯
        cycle = self.detect_cycle()

        if cycle:
            # 3. é€‰æ‹©ç‰ºç‰²è€…
            victim = self.select_victim(cycle)

            # 4. å›æ»šç‰ºç‰²è€…
            self.abort_transaction(victim)

            return True
        return False
```

**æœ¬ä½“ç³»å®šä¹‰**:

æ­»é”æ˜¯å¹¶å‘ç³»ç»Ÿä¸­çš„å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå…¶ä¸­å¤šä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œå½¢æˆç­‰å¾…å›¾ä¸­çš„ç¯ã€‚PostgreSQLé€šè¿‡ç­‰å¾…å›¾å’ŒDFSç¯æ£€æµ‹ç®—æ³•æ£€æµ‹æ­»é”ï¼Œå¹¶é€šè¿‡å›æ»šç‰ºç‰²è€…äº‹åŠ¡è§£é™¤æ­»é”ã€‚

**æ­»é”ä¸é”çš„å…³ç³»**:

```text
æ­»é”ä¸é”:
â”‚
â”œâ”€ æ­»é” (Deadlock) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: å¾ªç¯ç­‰å¾…æ¡ä»¶
â”‚       â””â”€ åŸå› : é”æœºåˆ¶å¯¼è‡´çš„å¾ªç¯ç­‰å¾…
â”‚           â”œâ”€ æ£€æµ‹: ç­‰å¾…å›¾ + ç¯æ£€æµ‹
â”‚           â””â”€ è§£å†³: å›æ»šç‰ºç‰²è€…äº‹åŠ¡
â”‚
â””â”€ é” (Lock)
    â””â”€ å®šä¹‰: æ§åˆ¶å¹¶å‘è®¿é—®çš„åŒæ­¥æœºåˆ¶
        â””â”€ é—®é¢˜: å¯èƒ½å¯¼è‡´æ­»é”
```

---

### 3.5.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.5.1 (æ­»é” - Eswaran et al., 1976)**:

æ­»é”æ˜¯äº‹åŠ¡é›†åˆ $\{T_1, T_2, ..., T_n\}$ ä¸­çš„å¾ªç¯ç­‰å¾…ï¼š

$$Deadlock \iff \exists T_1, T_2, ..., T_n:$$

$$T_1 \text{ waits for } T_2 \land T_2 \text{ waits for } T_3 \land ... \land T_n \text{ waits for } T_1$$

å…¶ä¸­ $T_i \text{ waits for } T_j$ è¡¨ç¤ºäº‹åŠ¡ $T_i$ ç­‰å¾…äº‹åŠ¡ $T_j$ é‡Šæ”¾é”ã€‚

**å®šä¹‰3.5.2 (ç­‰å¾…å›¾)**:

ç­‰å¾…å›¾æ˜¯ä¸€ä¸ªæœ‰å‘å›¾ $G = (V, E)$ï¼Œå…¶ä¸­ï¼š

- $V = \{T_1, T_2, ..., T_n\}$: äº‹åŠ¡é›†åˆï¼ˆèŠ‚ç‚¹ï¼‰
- $E = \{(T_i, T_j) | T_i \text{ waits for } T_j\}$: ç­‰å¾…å…³ç³»ï¼ˆè¾¹ï¼‰

**å®šä¹‰3.5.3 (æ­»é”æ£€æµ‹)**:

æ­»é”æ£€æµ‹ç®—æ³•æ£€æµ‹ç­‰å¾…å›¾ä¸­çš„ç¯ï¼š

$$DetectDeadlock(G) \iff \exists \text{ cycle } C \text{ in } G$$

**å®šä¹‰3.5.4 (æ­»é”å¿…è¦æ¡ä»¶)**:

æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼ˆCoffmanæ¡ä»¶ï¼‰ï¼š

1. **äº’æ–¥æ¡ä»¶** (Mutual Exclusion): èµ„æºä¸èƒ½è¢«å¤šä¸ªäº‹åŠ¡åŒæ—¶ä½¿ç”¨
2. **æŒæœ‰å¹¶ç­‰å¾…** (Hold and Wait): äº‹åŠ¡æŒæœ‰èµ„æºå¹¶ç­‰å¾…å…¶ä»–èµ„æº
3. **ä¸å¯æŠ¢å ** (No Preemption): èµ„æºä¸èƒ½è¢«å¼ºåˆ¶é‡Šæ”¾
4. **å¾ªç¯ç­‰å¾…** (Circular Wait): å­˜åœ¨å¾ªç¯ç­‰å¾…é“¾

$$Deadlock \iff \text{MutualExclusion} \land \text{HoldAndWait} \land \text{NoPreemption} \land \text{CircularWait}$$

---

### 3.5.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1971å¹´**: Coffman et al. æå‡ºæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶
   - é¦–æ¬¡ç³»ç»ŸåŒ–åˆ†ææ­»é”é—®é¢˜
   - å®šä¹‰æ­»é”çš„å¿…è¦æ¡ä»¶

2. **1976å¹´**: Eswaran et al. æå‡ºç­‰å¾…å›¾æ­»é”æ£€æµ‹
   - é¦–æ¬¡ä½¿ç”¨ç­‰å¾…å›¾æ£€æµ‹æ­»é”
   - è¯æ˜ç­‰å¾…å›¾ç¯æ£€æµ‹çš„æ­£ç¡®æ€§

3. **1980å¹´ä»£**: æ­»é”æ£€æµ‹ç®—æ³•ä¼˜åŒ–
   - DFSç¯æ£€æµ‹ç®—æ³•
   - å¢é‡æ­»é”æ£€æµ‹

4. **1990å¹´ä»£è‡³ä»Š**: æ­»é”æ£€æµ‹æˆç†Ÿ
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–æ­»é”æ£€æµ‹æ€§èƒ½
   - æ­»é”é¢„é˜²ç­–ç•¥å‘å±•

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦æ­»é”æ£€æµ‹ï¼Ÿ**

1. **ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ— æ­»é”æ£€æµ‹æ—¶ï¼Œæ­»é”å¯¼è‡´ç³»ç»Ÿé˜»å¡
   - **åæœ**: ç³»ç»Ÿæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œä¸šåŠ¡ä¸­æ–­
   - **ç¤ºä¾‹**: ä¸¤ä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…ï¼Œç³»ç»Ÿé˜»å¡

2. **æ­»é”æ£€æµ‹çš„ä¼˜åŠ¿**:
   - **å¯ç”¨æ€§**: ä¿è¯ç³»ç»Ÿç»§ç»­æ‰§è¡Œ
   - **æ­£ç¡®æ€§**: é€šè¿‡å›æ»šç‰ºç‰²è€…è§£é™¤æ­»é”
   - **æ€§èƒ½**: å¿«é€Ÿæ£€æµ‹å’Œè§£é™¤æ­»é”

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - æ‰€æœ‰ä½¿ç”¨é”çš„ç³»ç»Ÿéƒ½éœ€è¦æ­»é”æ£€æµ‹
   - é«˜å¹¶å‘ç³»ç»Ÿéœ€è¦é«˜æ•ˆæ­»é”æ£€æµ‹
   - å…³é”®ä¸šåŠ¡éœ€è¦å¿«é€Ÿæ­»é”è§£é™¤

**ç†è®ºä½ç½®**:

```text
é”æœºåˆ¶ç†è®ºä½“ç³»:
â”‚
â”œâ”€ é”ç†è®º
â”‚   â””â”€ å®ç°: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚
â”œâ”€ æ­»é”ç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é—®é¢˜: é”æœºåˆ¶å¯¼è‡´çš„å¾ªç¯ç­‰å¾…
â”‚       â”œâ”€ æ£€æµ‹: ç­‰å¾…å›¾ + ç¯æ£€æµ‹
â”‚       â””â”€ è§£å†³: å›æ»šç‰ºç‰²è€…
â”‚
â””â”€ æ­»é”é¢„é˜²ç†è®º
    â””â”€ ç­–ç•¥: é”æ’åºã€è¶…æ—¶ç­‰
```

**æ­»é”ä¸é”çš„å…³ç³»**:

```text
æ­»é”ä¸é”:
â”‚
â”œâ”€ æ­»é”æ˜¯é—®é¢˜
â”‚   â””â”€ ç”±é”æœºåˆ¶å¯¼è‡´
â”‚
â””â”€ é”æ˜¯æœºåˆ¶
    â””â”€ å¯èƒ½å¯¼è‡´æ­»é”
```

**ç†è®ºæ¨å¯¼**:

```text
ä»é”æœºåˆ¶åˆ°æ­»é”æ£€æµ‹çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: æ•°æ®ä¸€è‡´æ€§ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: æ­»é”å¤„ç†ï¼ˆå¿…é¡»ï¼‰

2. æ­»é”æ£€æµ‹è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: ç­‰å¾…å›¾ + ç¯æ£€æµ‹
   â”œâ”€ æœºåˆ¶: DFSæ£€æµ‹ç­‰å¾…å›¾ä¸­çš„ç¯
   â””â”€ è§£å†³: å›æ»šç‰ºç‰²è€…äº‹åŠ¡

3. å®ç°é€‰æ‹©
   â”œâ”€ ç­‰å¾…å›¾: æ„å»ºäº‹åŠ¡ç­‰å¾…å…³ç³»
   â”œâ”€ ç¯æ£€æµ‹: DFSæ£€æµ‹ç¯
   â””â”€ ç‰ºç‰²è€…é€‰æ‹©: é€‰æ‹©æœ€å°ä»£ä»·äº‹åŠ¡

4. ç»“è®º
   â””â”€ æ­»é”æ£€æµ‹æ˜¯é”æœºåˆ¶çš„å¿…è¦ç»„æˆéƒ¨åˆ†
```

---

### 3.5.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: æ­»é”æ£€æµ‹æˆåŠŸè§£é™¤æ­»é”**:

```sql
-- åœºæ™¯: ä¸¤ä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…
-- éœ€æ±‚: æ£€æµ‹å¹¶è§£é™¤æ­»é”

-- äº‹åŠ¡T1
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–é”1
-- ç­‰å¾…é”2ï¼ˆè¢«T2æŒæœ‰ï¼‰

-- äº‹åŠ¡T2ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 2 FOR UPDATE;  -- è·å–é”2
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- ç­‰å¾…é”1ï¼ˆè¢«T1æŒæœ‰ï¼‰

-- æ­»é”æ£€æµ‹:
-- 1. æ„å»ºç­‰å¾…å›¾: T1 -> T2, T2 -> T1
-- 2. æ£€æµ‹ç¯: å‘ç°ç¯ (T1, T2, T1)
-- 3. é€‰æ‹©ç‰ºç‰²è€…: T2ï¼ˆæŒæœ‰é”å°‘ï¼‰
-- 4. å›æ»šT2: é‡Šæ”¾é”2
-- 5. T1ç»§ç»­æ‰§è¡Œ âœ“

-- ç»“æœ: æ­»é”è¢«æˆåŠŸè§£é™¤ âœ“
```

**åˆ†æ**:

- âœ… æ­»é”æ£€æµ‹ä¿è¯ï¼šæˆåŠŸæ£€æµ‹å¹¶è§£é™¤æ­»é”
- âœ… ç³»ç»Ÿå¯ç”¨æ€§ï¼šç³»ç»Ÿç»§ç»­æ‰§è¡Œ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šé€šè¿‡å›æ»šä¿è¯ä¸€è‡´æ€§

---

**æ­£ä¾‹2: æ­»é”æ£€æµ‹é¿å…ç³»ç»Ÿé˜»å¡**:

```sql
-- åœºæ™¯: å¤šä¸ªäº‹åŠ¡å½¢æˆæ­»é”ç¯
-- éœ€æ±‚: å¿«é€Ÿæ£€æµ‹å¹¶è§£é™¤æ­»é”

-- äº‹åŠ¡T1: ç­‰å¾…T2
-- äº‹åŠ¡T2: ç­‰å¾…T3
-- äº‹åŠ¡T3: ç­‰å¾…T1

-- æ­»é”æ£€æµ‹:
-- 1. æ„å»ºç­‰å¾…å›¾: T1 -> T2, T2 -> T3, T3 -> T1
-- 2. æ£€æµ‹ç¯: å‘ç°ç¯ (T1, T2, T3, T1)
-- 3. é€‰æ‹©ç‰ºç‰²è€…: T1ï¼ˆæœ€å°ä»£ä»·ï¼‰
-- 4. å›æ»šT1: é‡Šæ”¾é”
-- 5. T2å’ŒT3ç»§ç»­æ‰§è¡Œ âœ“

-- ç»“æœ: ç³»ç»Ÿæœªé˜»å¡ï¼Œç»§ç»­æ‰§è¡Œ âœ“
```

**åˆ†æ**:

- âœ… æ­»é”æ£€æµ‹ä¿è¯ï¼šå¿«é€Ÿæ£€æµ‹å¹¶è§£é™¤æ­»é”
- âœ… ç³»ç»Ÿå¯ç”¨æ€§ï¼šé¿å…ç³»ç»Ÿé˜»å¡
- âœ… æ€§èƒ½ï¼šæ­»é”æ£€æµ‹å¼€é”€å°ï¼ˆ10-100Î¼sï¼‰

---

**åä¾‹åˆ†æ**:

**åä¾‹1: æ— æ­»é”æ£€æµ‹å¯¼è‡´ç³»ç»Ÿé˜»å¡**:

```sql
-- é”™è¯¯åœºæ™¯: æ— æ­»é”æ£€æµ‹ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- é—®é¢˜: æ­»é”å¯¼è‡´ç³»ç»Ÿæ°¸ä¹…é˜»å¡

-- äº‹åŠ¡T1
BEGIN;
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- è·å–é”1
-- ç­‰å¾…é”2ï¼ˆè¢«T2æŒæœ‰ï¼‰âœ—

-- äº‹åŠ¡T2ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 2 FOR UPDATE;  -- è·å–é”2
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;  -- ç­‰å¾…é”1ï¼ˆè¢«T1æŒæœ‰ï¼‰âœ—

-- æ— æ­»é”æ£€æµ‹:
-- 1. T1ç­‰å¾…T2é‡Šæ”¾é”2
-- 2. T2ç­‰å¾…T1é‡Šæ”¾é”1
-- 3. æ°¸ä¹…ç­‰å¾… âœ—
-- ç»“æœ: ç³»ç»Ÿæ°¸ä¹…é˜»å¡ âœ—
```

**é”™è¯¯åŸå› **:

- æ— æ­»é”æ£€æµ‹ï¼Œæ­»é”å¯¼è‡´ç³»ç»Ÿæ°¸ä¹…é˜»å¡
- ç³»ç»Ÿæ— æ³•ç»§ç»­æ‰§è¡Œ
- ä¸šåŠ¡ä¸­æ–­

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨æ­»é”æ£€æµ‹ï¼ˆPostgreSQLè‡ªåŠ¨å®ç°ï¼‰
-- æ­»é”æ£€æµ‹:
-- 1. æ„å»ºç­‰å¾…å›¾
-- 2. æ£€æµ‹ç¯
-- 3. å›æ»šç‰ºç‰²è€…
-- ç»“æœ: æ­»é”è¢«è§£é™¤ï¼Œç³»ç»Ÿç»§ç»­æ‰§è¡Œ âœ“
```

**åæœåˆ†æ**:

- **ç³»ç»Ÿé˜»å¡**: ç³»ç»Ÿæ°¸ä¹…é˜»å¡
- **ä¸šåŠ¡ä¸­æ–­**: ä¸šåŠ¡æ— æ³•ç»§ç»­
- **ç³»ç»Ÿä¸å¯ç”¨**: æ— æ³•æ»¡è¶³ä¸šåŠ¡éœ€æ±‚

---

**åä¾‹2: æ­»é”æ£€æµ‹ç®—æ³•é”™è¯¯å¯¼è‡´æ¼æ£€**:

```sql
-- é”™è¯¯åœºæ™¯: æ­»é”æ£€æµ‹ç®—æ³•ä¸å®Œæ•´
-- é—®é¢˜: æŸäº›æ­»é”æœªè¢«æ£€æµ‹

-- äº‹åŠ¡T1: ç­‰å¾…T2ï¼ˆè¡¨Aï¼‰
-- äº‹åŠ¡T2: ç­‰å¾…T3ï¼ˆè¡¨Bï¼‰
-- äº‹åŠ¡T3: ç­‰å¾…T1ï¼ˆè¡¨Cï¼‰

-- é”™è¯¯æ­»é”æ£€æµ‹:
-- 1. åªæ£€æµ‹å•è¡¨æ­»é” âœ—
-- 2. å¿½ç•¥å¤šè¡¨æ­»é” âœ—
-- 3. æ­»é”æœªè¢«æ£€æµ‹ âœ—
-- ç»“æœ: ç³»ç»Ÿé˜»å¡ âœ—
```

**é”™è¯¯åŸå› **:

- æ­»é”æ£€æµ‹ç®—æ³•ä¸å®Œæ•´
- åªæ£€æµ‹éƒ¨åˆ†åœºæ™¯ï¼Œå¿½ç•¥å¤šè¡¨æ­»é”
- ç³»ç»Ÿé˜»å¡

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨å®Œæ•´çš„æ­»é”æ£€æµ‹ç®—æ³•
-- 1. æ„å»ºå®Œæ•´ç­‰å¾…å›¾ï¼ˆæ‰€æœ‰è¡¨ï¼‰
-- 2. æ£€æµ‹æ‰€æœ‰ç±»å‹çš„ç¯
-- 3. ç»“æœ: æ‰€æœ‰æ­»é”è¢«æ£€æµ‹ âœ“
```

**åæœåˆ†æ**:

- **ç³»ç»Ÿé˜»å¡**: æ­»é”æœªè¢«æ£€æµ‹ï¼Œç³»ç»Ÿé˜»å¡
- **ä¸šåŠ¡ä¸­æ–­**: ä¸šåŠ¡æ— æ³•ç»§ç»­
- **ç³»ç»Ÿä¸å¯é **: æ— æ³•ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘ç³»ç»Ÿæ­»é”æ£€æµ‹**:

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘ç³»ç»Ÿï¼ˆ1000+ TPSï¼‰
- å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œ
- éœ€è¦å¿«é€Ÿæ­»é”æ£€æµ‹

**ä¸ºä»€ä¹ˆéœ€è¦æ­»é”æ£€æµ‹**:

- âœ… ç³»ç»Ÿå¯ç”¨æ€§ï¼šé¿å…ç³»ç»Ÿé˜»å¡
- âœ… å¿«é€Ÿå“åº”ï¼šå¿«é€Ÿæ£€æµ‹å’Œè§£é™¤æ­»é”
- âœ… ä¸šåŠ¡è¿ç»­æ€§ï¼šä¿è¯ä¸šåŠ¡æ­£å¸¸è¿è¡Œ

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLè‡ªåŠ¨æ­»é”æ£€æµ‹ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
-- æ­»é”æ£€æµ‹é—´éš”: 1ç§’ï¼ˆå¯é…ç½®ï¼‰
-- æ­»é”æ£€æµ‹ç®—æ³•: DFSç¯æ£€æµ‹
```

**æ•ˆæœåˆ†æ**:

- **æ­»é”æ£€æµ‹**: å¿«é€Ÿæ£€æµ‹æ­»é”ï¼ˆ10-100Î¼sï¼‰âœ“
- **ç³»ç»Ÿå¯ç”¨æ€§**: é¿å…ç³»ç»Ÿé˜»å¡ âœ“
- **æ€§èƒ½**: æ­»é”æ£€æµ‹å¼€é”€å°ï¼ˆ1-5%ï¼‰âœ“

---

**åœºæ™¯2: å¤æ‚äº‹åŠ¡æ­»é”æ£€æµ‹**:

**åœºæ™¯æè¿°**:

- å¤æ‚äº‹åŠ¡ï¼ˆå¤šè¡¨æ“ä½œï¼‰
- å¤šä¸ªäº‹åŠ¡å½¢æˆæ­»é”ç¯
- éœ€è¦å‡†ç¡®æ­»é”æ£€æµ‹

**ä¸ºä»€ä¹ˆéœ€è¦æ­»é”æ£€æµ‹**:

- âœ… å‡†ç¡®æ€§ï¼šå‡†ç¡®æ£€æµ‹æ‰€æœ‰ç±»å‹çš„æ­»é”
- âœ… å®Œæ•´æ€§ï¼šæ£€æµ‹å¤šè¡¨æ­»é”
- âœ… å¯é æ€§ï¼šä¿è¯ç³»ç»Ÿå¯ç”¨æ€§

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLå®Œæ•´æ­»é”æ£€æµ‹
-- 1. æ„å»ºå®Œæ•´ç­‰å¾…å›¾ï¼ˆæ‰€æœ‰è¡¨ï¼‰
-- 2. DFSæ£€æµ‹æ‰€æœ‰ç±»å‹çš„ç¯
-- 3. é€‰æ‹©æœ€å°ä»£ä»·ç‰ºç‰²è€…
```

**æ•ˆæœåˆ†æ**:

- **æ­»é”æ£€æµ‹**: å‡†ç¡®æ£€æµ‹æ‰€æœ‰æ­»é” âœ“
- **ç³»ç»Ÿå¯ç”¨æ€§**: é¿å…ç³»ç»Ÿé˜»å¡ âœ“
- **å¯é æ€§**: ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»é”æœºåˆ¶åˆ°æ­»é”æ£€æµ‹çš„æ¨ç†**:

```text
å‰æ1: é”æœºåˆ¶å¯èƒ½å¯¼è‡´æ­»é”ï¼ˆå¿…é¡»ï¼‰
å‰æ2: æ­»é”å¯¼è‡´ç³»ç»Ÿé˜»å¡ï¼ˆå¿…é¡»é¿å…ï¼‰
å‰æ3: éœ€è¦æ­»é”æ£€æµ‹ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©æ­»é”æ£€æµ‹æœºåˆ¶
æ¨ç†æ­¥éª¤2: ç­‰å¾…å›¾ + ç¯æ£€æµ‹æ£€æµ‹æ­»é”ï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: æ­»é”æ£€æµ‹ç®—æ³•æ€§èƒ½é«˜ï¼ˆæ»¡è¶³æ€§èƒ½éœ€æ±‚ï¼‰

ç»“è®º: ä½¿ç”¨ç­‰å¾…å›¾ + ç¯æ£€æµ‹å®ç°æ­»é”æ£€æµ‹ âœ“
```

**æ¨ç†é“¾æ¡2: ä»æ­»é”æ£€æµ‹åˆ°ç³»ç»Ÿå¯ç”¨æ€§çš„æ¨ç†**:

```text
å‰æ1: æ­»é”æ£€æµ‹æ£€æµ‹æ­»é”
å‰æ2: æ­»é”æ£€æµ‹è§£é™¤æ­»é”ï¼ˆå›æ»šç‰ºç‰²è€…ï¼‰
å‰æ3: è§£é™¤æ­»é”åç³»ç»Ÿç»§ç»­æ‰§è¡Œ

æ¨ç†æ­¥éª¤1: æ­»é”æ£€æµ‹ä¿è¯æ­»é”è¢«æ£€æµ‹
æ¨ç†æ­¥éª¤2: æ­»é”æ£€æµ‹ä¿è¯æ­»é”è¢«è§£é™¤
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼Œæ­»é”æ£€æµ‹ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§

ç»“è®º: æ­»é”æ£€æµ‹æœºåˆ¶ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§ âœ“
```

---

### 3.5.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸é”çš„å…³ç³»**:
   - æ­»é”æ˜¯é”æœºåˆ¶çš„é—®é¢˜
   - é”æœºåˆ¶å¯èƒ½å¯¼è‡´æ­»é”
   - æ­»é”æ£€æµ‹æ˜¯é”æœºåˆ¶çš„ä¸€éƒ¨åˆ†

2. **ä¸äº‹åŠ¡çš„å…³ç³»**:
   - æ­»é”æ¶‰åŠå¤šä¸ªäº‹åŠ¡
   - æ­»é”è§£é™¤éœ€è¦å›æ»šäº‹åŠ¡
   - äº‹åŠ¡æ˜¯æ­»é”çš„åŸºæœ¬å•å…ƒ

3. **ä¸å¹¶å‘æ§åˆ¶çš„å…³ç³»**:
   - æ­»é”æ˜¯å¹¶å‘æ§åˆ¶çš„é—®é¢˜
   - å¹¶å‘æ§åˆ¶éœ€è¦æ­»é”æ£€æµ‹
   - æ­»é”æ£€æµ‹ä¿è¯å¹¶å‘æ§åˆ¶çš„æœ‰æ•ˆæ€§

4. **ä¸ç­‰å¾…å›¾çš„å…³ç³»**:
   - ç­‰å¾…å›¾æ˜¯æ­»é”æ£€æµ‹çš„å·¥å…·
   - æ­»é”æ£€æµ‹é€šè¿‡ç­‰å¾…å›¾å®ç°
   - ç­‰å¾…å›¾ç¯è¡¨ç¤ºæ­»é”

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQLæ­»é”æ£€æµ‹å®ç°
   - ç­‰å¾…å›¾æ„å»º
   - DFSç¯æ£€æµ‹
   - ç‰ºç‰²è€…é€‰æ‹©

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - æ­»é” â‰ˆ äº’æ–¥é”æ­»é”
   - ç­‰å¾…å›¾ â‰ˆ ä¾èµ–å›¾
   - æ­»é”æ£€æµ‹ â‰ˆ æ­»é”æ£€æµ‹ç®—æ³•

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - æ­»é” â‰ˆ åˆ†å¸ƒå¼æ­»é”
   - ç­‰å¾…å›¾ â‰ˆ åˆ†å¸ƒå¼ç­‰å¾…å›¾
   - æ­»é”æ£€æµ‹ â‰ˆ åˆ†å¸ƒå¼æ­»é”æ£€æµ‹

**å®ç°ç»†èŠ‚**:

**PostgreSQLæ­»é”æ£€æµ‹å®ç°æ¶æ„**:

```c
// src/backend/storage/lmgr/deadlock.c

// æ­»é”æ£€æµ‹
bool DeadLockCheck(PGPROC *proc)
{
    static PGPROC *visitedProcs[MaxBackends];
    int nVisited = 0;

    // 1. æ„å»ºç­‰å¾…å›¾
    BuildWaitGraph();

    // 2. DFSæ£€æµ‹ç¯
    if (CheckForCycle(proc, visitedProcs, &nVisited)) {
        // 3. é€‰æ‹©ç‰ºç‰²è€…
        PGPROC *victim = ChooseDeadlockVictim(visitedProcs, nVisited);

        // 4. å›æ»šç‰ºç‰²è€…
        AbortTransaction(victim);

        return true;  // æ­»é”å·²è§£é™¤
    }

    return false;  // æ— æ­»é”
}
```

**æ­»é”æ£€æµ‹ä¿è¯æœºåˆ¶**:

```python
def ensure_deadlock_detection():
    """
    ç¡®ä¿æ­»é”æ£€æµ‹

    æœºåˆ¶:
    1. ç­‰å¾…å›¾: æ„å»ºäº‹åŠ¡ç­‰å¾…å…³ç³»å›¾
    2. ç¯æ£€æµ‹: DFSæ£€æµ‹ç­‰å¾…å›¾ä¸­çš„ç¯
    3. ç‰ºç‰²è€…é€‰æ‹©: é€‰æ‹©æ­»é”ç¯ä¸­çš„ç‰ºç‰²è€…
    4. æ­»é”è§£é™¤: å›æ»šç‰ºç‰²è€…äº‹åŠ¡
    """
    # 1. æ„å»ºç­‰å¾…å›¾
    wait_graph = build_wait_graph()

    # 2. DFSæ£€æµ‹ç¯
    cycle = detect_cycle(wait_graph)

    if cycle:
        # 3. é€‰æ‹©ç‰ºç‰²è€…
        victim = select_victim(cycle)

        # 4. å›æ»šç‰ºç‰²è€…
        abort_transaction(victim)

        return True  # æ­»é”å·²è§£é™¤

    return False  # æ— æ­»é”
```

**æ€§èƒ½å½±å“**:

1. **æ­»é”æ£€æµ‹å¼€é”€**:
   - ç­‰å¾…å›¾æ„å»º: $O(V + E)$ - å›¾æ„å»º
   - ç¯æ£€æµ‹: $O(V + E)$ - DFSéå†
   - ç‰ºç‰²è€…é€‰æ‹©: $O(V)$ - éå†ç¯
   - å…¸å‹å¼€é”€: 10-100Î¼s per detection

2. **æ€»ä½“æ€§èƒ½**:
   - æ­»é”æ£€æµ‹é¢‘ç‡: æ¯1ç§’æˆ–æ¯æ¬¡é”ç­‰å¾…
   - æ­»é”æ£€æµ‹å¼€é”€: 1-5% of transaction time
   - æ­»é”è§£é™¤å¼€é”€: å›æ»šäº‹åŠ¡å¼€é”€

---

### 3.5.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**æ­»é”æ£€æµ‹å¼€é”€**:

$$T_{deadlock\_detection} = T_{build\_graph} + T_{detect\_cycle} + T_{select\_victim} + T_{abort}$$

å…¶ä¸­ï¼š

- $T_{build\_graph} = O(V + E)$ - ç­‰å¾…å›¾æ„å»ºæ—¶é—´
- $T_{detect\_cycle} = O(V + E)$ - ç¯æ£€æµ‹æ—¶é—´ï¼ˆDFSï¼‰
- $T_{select\_victim} = O(V)$ - ç‰ºç‰²è€…é€‰æ‹©æ—¶é—´
- $T_{abort} = O(N_{operations})$ - å›æ»šäº‹åŠ¡æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | ç­‰å¾…å›¾æ„å»º | ç¯æ£€æµ‹ | ç‰ºç‰²è€…é€‰æ‹© | æ€»ä½“å½±å“ | è¯´æ˜ |
|-----|----------|--------|-----------|---------|------|
| **æ— æ­»é”** | 10-50Î¼s | 10-50Î¼s | 0Î¼s | 1-5% | å¼€é”€å¯æ¥å— |
| **æœ‰æ­»é”ï¼ˆå°ç¯ï¼‰** | 10-50Î¼s | 10-50Î¼s | 1-5Î¼s | 5-10% | å¼€é”€å¯æ¥å— |
| **æœ‰æ­»é”ï¼ˆå¤§ç¯ï¼‰** | 50-200Î¼s | 50-200Î¼s | 5-20Î¼s | 10-20% | å¼€é”€å¢åŠ  |
| **æ­»é”è§£é™¤** | 0Î¼s | 0Î¼s | 0Î¼s | å›æ»šå¼€é”€ | å›æ»šäº‹åŠ¡å¼€é”€ |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–ç­‰å¾…å›¾æ„å»º**:
   - å¢é‡æ„å»ºç­‰å¾…å›¾
   - ç¼“å­˜ç­‰å¾…å›¾
   - å‡å°‘å›¾æ„å»ºé¢‘ç‡

2. **ä¼˜åŒ–ç¯æ£€æµ‹**:
   - ä½¿ç”¨å¢é‡DFS
   - ä¼˜åŒ–å›¾éå†ç®—æ³•
   - å‡å°‘ç¯æ£€æµ‹é¢‘ç‡

3. **ä¼˜åŒ–ç‰ºç‰²è€…é€‰æ‹©**:
   - ä½¿ç”¨æœ€å°ä»£ä»·ç­–ç•¥
   - ç¼“å­˜ç‰ºç‰²è€…é€‰æ‹©ç»“æœ
   - å‡å°‘é€‰æ‹©å¼€é”€

---

### 3.5.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: æ­»é”æ˜¯å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå¤šä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æº
2. **æ£€æµ‹**: é€šè¿‡ç­‰å¾…å›¾å’ŒDFSç¯æ£€æµ‹ç®—æ³•æ£€æµ‹æ­»é”
3. **è§£å†³**: é€šè¿‡å›æ»šç‰ºç‰²è€…äº‹åŠ¡è§£é™¤æ­»é”
4. **æ€§èƒ½**: æ­»é”æ£€æµ‹å¼€é”€å¯æ¥å—ï¼ˆ10-100Î¼sï¼‰

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºæ­»é”ä¸ä¼šå‘ç”Ÿ
   - **é”™è¯¯**: æ­»é”æ˜¯é”æœºåˆ¶çš„å¸¸è§é—®é¢˜
   - **æ­£ç¡®**: æ‰€æœ‰ä½¿ç”¨é”çš„ç³»ç»Ÿéƒ½å¯èƒ½å‘ç”Ÿæ­»é”

2. **è¯¯åŒº2**: è®¤ä¸ºæ­»é”æ£€æµ‹æ€§èƒ½å¾ˆä½
   - **é”™è¯¯**: æ­»é”æ£€æµ‹æ€§èƒ½é«˜ï¼Œå¼€é”€å°ï¼ˆ10-100Î¼sï¼‰
   - **æ­£ç¡®**: æ­»é”æ£€æµ‹ç®—æ³•é«˜æ•ˆï¼Œå¼€é”€å¯æ¥å—

3. **è¯¯åŒº3**: å¿½ç•¥æ­»é”é¢„é˜²çš„é‡è¦æ€§
   - **é”™è¯¯**: è®¤ä¸ºæ­»é”æ£€æµ‹è¶³å¤Ÿ
   - **æ­£ç¡®**: æ­»é”é¢„é˜²å¯ä»¥å‡å°‘æ­»é”é¢‘ç‡

**æœ€ä½³å®è·µ**:

1. **ç†è§£æ­»é”**: ç†è§£æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶
2. **æ­»é”æ£€æµ‹**: ä½¿ç”¨æ­»é”æ£€æµ‹ç®—æ³•æ£€æµ‹æ­»é”
3. **æ­»é”é¢„é˜²**: ä½¿ç”¨é”æ’åºã€è¶…æ—¶ç­‰ç­–ç•¥é¢„é˜²æ­»é”
4. **ç›‘æ§æ­»é”**: ç›‘æ§æ­»é”é¢‘ç‡ã€æ­»é”æ£€æµ‹å¼€é”€ç­‰æŒ‡æ ‡

---

## å››ã€æ­»é”æ£€æµ‹

### 4.1 ç­‰å¾…å›¾

**æ•°æ®ç»“æ„**:

```c
typedef struct EDGE {
    PGPROC *waiter;  /* ç­‰å¾…è¿›ç¨‹ */
    PGPROC *blocker; /* é˜»å¡è¿›ç¨‹ */
} EDGE;
```

**ç­‰å¾…å›¾æ„å»º**:

```c
void
BuildWaitGraph(void) {
    /* æ‰«ææ‰€æœ‰é”ç­‰å¾… */
    for (lock in LockTable) {
        for (waiter in lock->waitProcs) {
            for (blocker in lock->procLocks) {
                if (LockConflicts(waiter->mode, blocker->mode)) {
                    AddEdge(waiter, blocker);
                }
            }
        }
    }
}
```

### 4.2 ç¯æ£€æµ‹ç®—æ³•

**DFSæ£€æµ‹ç¯**:

```c
bool
DeadLockCheck(PGPROC *proc) {
    static PGPROC *visitedProcs[MaxBackends];
    int nVisited = 0;

    return CheckForCycle(proc, visitedProcs, &nVisited);
}

static bool
CheckForCycle(PGPROC *proc, PGPROC **visited, int *nVisited) {
    /* æ£€æŸ¥æ˜¯å¦å·²è®¿é—®ï¼ˆå‘ç°ç¯ï¼‰ */
    for (int i = 0; i < *nVisited; i++) {
        if (visited[i] == proc) {
            return true;  /* æ­»é”ï¼ */
        }
    }

    /* æ ‡è®°å·²è®¿é—® */
    visited[(*nVisited)++] = proc;

    /* é€’å½’æ£€æŸ¥æ‰€æœ‰é˜»å¡è€… */
    for (blocker in proc->blockers) {
        if (CheckForCycle(blocker, visited, nVisited)) {
            return true;
        }
    }

    (*nVisited)--;
    return false;
}
```

### 4.3 æ­»é”è§£é™¤

**é€‰æ‹©å—å®³è€…**:

```c
PGPROC *
ChooseDeadlockVictim(PGPROC **procs, int nProcs) {
    PGPROC *victim = NULL;
    int min_priority = INT_MAX;

    for (int i = 0; i < nProcs; i++) {
        int priority = ComputePriority(procs[i]);
        if (priority < min_priority) {
            min_priority = priority;
            victim = procs[i];
        }
    }

    return victim;
}

static int
ComputePriority(PGPROC *proc) {
    /* ä¼˜å…ˆçº§è€ƒè™‘å› ç´ : */
    int priority = 0;

    priority += proc->pid;  /* è¾ƒæ–°çš„è¿›ç¨‹ä¼˜å…ˆä¸­æ­¢ */
    priority -= proc->locks_held;  /* æŒæœ‰é”å°‘çš„ä¼˜å…ˆ */

    return priority;
}
```

---

## äº”ã€é”ä¼˜åŒ–

### 5.1 å¿«é€Ÿè·¯å¾„

**Fast Path Locking** (PostgreSQL 9.2+):

```c
#define FP_LOCK_SLOTS_PER_BACKEND 16

typedef struct {
    LockMode mode[FP_LOCK_SLOTS_PER_BACKEND];
    Oid relid[FP_LOCK_SLOTS_PER_BACKEND];
} FastPathStrongRelationLocks;
```

**ä¼˜ç‚¹**:

- é¿å…å…±äº«å†…å­˜é”è¡¨è®¿é—®
- å‡å°‘é”ç®¡ç†å™¨ç«äº‰

**é€‚ç”¨**: ç®€å•SELECT/DMLï¼ˆAccessShareLock/RowExclusiveLockï¼‰

### 5.2 é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–

**FIFO vs Priority**:

```c
// PostgreSQLä½¿ç”¨FIFOé˜Ÿåˆ—
void
WaitOnLock(LOCK *lock, LOCKMODE mode) {
    PGPROC *proc = MyProc;

    /* åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ */
    SHMQueueInsertBefore(&lock->waitProcs, &proc->links);

    /* ç­‰å¾…è¢«å”¤é†’ */
    ProcWaitForSignal();
}
```

**ä¼˜åŒ–**:

- FIFOä¿è¯å…¬å¹³æ€§
- é¿å…é¥¥é¥¿

---

## å…­ã€æ€»ç»“

### 6.1 æ ¸å¿ƒç‰¹ç‚¹

**PostgreSQLé”æœºåˆ¶**:

1. **å¤šç²’åº¦**: è¡¨é” + è¡Œé”
2. **è½»é‡è¡Œé”**: å­˜å‚¨åœ¨å…ƒç»„å¤´ï¼ˆæ— é”è¡¨ï¼‰
3. **æ­»é”æ£€æµ‹**: å®šæœŸæ‰«æç­‰å¾…å›¾
4. **å¿«é€Ÿè·¯å¾„**: ä¼˜åŒ–å¸¸è§é”æ“ä½œ

### 6.2 æœ€ä½³å®è·µ

**é¿å…é”ç«äº‰**:

1. âœ… ç¼©çŸ­äº‹åŠ¡æŒç»­æ—¶é—´
2. âœ… é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
3. âœ… åˆç†ä½¿ç”¨ç´¢å¼•ï¼ˆå‡å°‘é”èŒƒå›´ï¼‰
4. âœ… ä½¿ç”¨`SELECT FOR UPDATE SKIP LOCKED`ï¼ˆé˜Ÿåˆ—åœºæ™¯ï¼‰

**ç›‘æ§é”ç­‰å¾…**:

```sql
-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
WHERE NOT blocked_locks.granted;
```

---

## ä¸ƒã€å®Œæ•´æºç åˆ†æ

### 7.1 é”ç®¡ç†å™¨åˆå§‹åŒ–

**æºç ä½ç½®**: `src/backend/storage/lmgr/lock.c`

```c
void InitLocks(void) {
    HASHCTL info;

    /* åˆ›å»ºé”å“ˆå¸Œè¡¨ */
    info.keysize = sizeof(LOCKTAG);
    info.entrysize = sizeof(LOCK);
    info.hash = tag_hash;

    LockMethodLockHash = ShmemInitHash(
        "Lock Hash",
        max_locks_per_xact * max_connections,
        max_locks_per_xact * max_connections,
        &info,
        HASH_ELEM | HASH_FUNCTION
    );

    /* åˆ›å»ºè¿›ç¨‹é”å“ˆå¸Œè¡¨ */
    info.keysize = sizeof(PROCLOCKTAG);
    info.entrysize = sizeof(PROCLOCK);
    LockMethodProcLockHash = ShmemInitHash(
        "ProcLock Hash",
        max_locks_per_xact * max_connections * 2,
        max_locks_per_xact * max_connections * 2,
        &info,
        HASH_ELEM | HASH_FUNCTION
    );
}
```

### 7.2 é”å†²çªæ£€æµ‹è¯¦ç»†å®ç°

```c
bool LockCheckConflicts(LockMethod lockMethodTable,
                       LOCKMODE lockmode,
                       LOCK *lock,
                       PROCLOCK *proclock) {
    LOCKMASK conflicts = lockMethodTable->conflictTab[lockmode];
    LOCKMASK myLocks = proclock->holdMask;

    /* æ£€æŸ¥æ˜¯å¦ä¸å·²æˆäºˆçš„é”å†²çª */
    if (lock->granted & conflicts) {
        return true;  // å†²çª
    }

    /* æ£€æŸ¥æ˜¯å¦ä¸ç­‰å¾…çš„é”å†²çª */
    if (lock->waiting & conflicts) {
        return true;  // å†²çª
    }

    return false;  // æ— å†²çª
}
```

### 7.3 è¡Œé”è¯¦ç»†å®ç°

```c
TM_Result
heap_lock_tuple(Relation relation, HeapTuple tuple,
                CommandId cid, LockTupleMode mode,
                LockWaitPolicy wait_policy,
                bool follow_updates,
                Buffer *buffer) {
    Buffer buf;
    Page page;
    ItemId lp;
    HeapTupleData mytup;
    TransactionId xid = GetCurrentTransactionId();
    LOCKMODE tuple_lock_mode;
    bool updated;
    TM_Result result;

    /* 1. è¯»å–å…ƒç»„æ‰€åœ¨é¡µé¢ */
    buf = ReadBuffer(relation, ItemPointerGetBlockNumber(&tuple->t_self));
    LockBuffer(buf, BUFFER_LOCK_EXCLUSIVE);
    page = BufferGetPage(buf);

    /* 2. è·å–å…ƒç»„ */
    lp = PageGetItemId(page, ItemPointerGetOffsetNumber(&tuple->t_self));
    if (!ItemIdIsNormal(lp)) {
        UnlockReleaseBuffer(buf);
        return TM_Deleted;
    }

    mytup.t_data = (HeapTupleHeader) PageGetItem(page, lp);
    mytup.t_len = ItemIdGetLength(lp);
    mytup.t_self = tuple->t_self;

    /* 3. æ£€æŸ¥å¯è§æ€§ */
    updated = false;
    result = HeapTupleSatisfiesUpdate(&mytup, cid, buf, &updated);

    if (result != TM_Ok) {
        UnlockReleaseBuffer(buf);
        return result;
    }

    /* 4. æ£€æŸ¥ç°æœ‰é” */
    xmax = HeapTupleHeaderGetXmax(mytup.t_data);
    if (TransactionIdIsValid(xmax)) {
        /* æ£€æŸ¥æ˜¯å¦æ˜¯é”æ ‡è®° */
        if (HEAP_XMAX_IS_LOCKED_ONLY(mytup.t_data->t_infomask)) {
            /* å·²æœ‰é”ï¼Œæ£€æŸ¥å…¼å®¹æ€§ */
            LockTupleMode existing_mode = get_tuple_lock_mode(mytup.t_data);

            if (!LockTupleModeCompatible(existing_mode, mode)) {
                /* ä¸å…¼å®¹ï¼Œéœ€è¦ç­‰å¾… */
                if (wait_policy == LockWaitError) {
                    UnlockReleaseBuffer(buf);
                    return TM_WouldBlock;
                }

                /* ç­‰å¾…é”é‡Šæ”¾ */
                XactLockTableWait(xmax, relation, &mytup.t_self, XLTW_Lock);
            }
        } else {
            /* xmaxæ˜¯åˆ é™¤äº‹åŠ¡ï¼Œç­‰å¾…å…¶æäº¤ */
            XactLockTableWait(xmax, relation, &mytup.t_self, XLTW_Delete);
        }
    }

    /* 5. è®¾ç½®é”æ ‡è®° */
    HeapTupleHeaderSetXmax(mytup.t_data, xid);
    mytup.t_data->t_infomask &= ~HEAP_XMAX_BITS;
    mytup.t_data->t_infomask |= compute_infomask_flags(mode);

    /* 6. æ ‡è®°é¡µé¢ä¸ºè„ */
    MarkBufferDirty(buf);

    if (buffer) {
        *buffer = buf;
    } else {
        UnlockReleaseBuffer(buf);
    }

    return TM_Ok;
}
```

---

## å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹1: é«˜å¹¶å‘æ›´æ–°å¯¼è‡´çš„é”ç«äº‰

**é—®é¢˜**: æŸè¡¨é¢‘ç¹æ›´æ–°ï¼Œé”ç­‰å¾…ä¸¥é‡

**åœºæ™¯**:

```sql
-- å¹¶å‘æ‰§è¡Œ1000æ¬¡
UPDATE hot_table SET counter = counter + 1 WHERE id = 1;
```

**è¯Šæ–­**:

```sql
-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query,
    blocked_activity.wait_event_type,
    blocked_activity.wait_event
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity
    ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity
    ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- ç»“æœ: å‘ç°å¤§é‡è¡Œé”ç­‰å¾…
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: ä½¿ç”¨SELECT FOR UPDATE SKIP LOCKEDï¼ˆé˜Ÿåˆ—æ¨¡å¼ï¼‰
UPDATE hot_table
SET counter = counter + 1
WHERE id IN (
    SELECT id FROM hot_table
    WHERE id = 1
    FOR UPDATE SKIP LOCKED
    LIMIT 1
);

-- æ–¹æ¡ˆ2: ä½¿ç”¨ä¹è§‚é”ï¼ˆåº”ç”¨å±‚ï¼‰
-- åº”ç”¨å±‚é‡è¯•ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´

-- æ–¹æ¡ˆ3: ä½¿ç”¨advisory lockï¼ˆåº”ç”¨å±‚åè°ƒï¼‰
SELECT pg_advisory_xact_lock(1);  -- åº”ç”¨å±‚é”
UPDATE hot_table SET counter = counter + 1 WHERE id = 1;
```

**æ•ˆæœ**: é”ç­‰å¾…ä»50%é™è‡³5%

### æ¡ˆä¾‹2: DDLæ“ä½œé˜»å¡æŸ¥è¯¢

**é—®é¢˜**: ALTER TABLEå¯¼è‡´æ‰€æœ‰æŸ¥è¯¢é˜»å¡

**åœºæ™¯**:

```sql
-- æ‰§è¡ŒDDL
ALTER TABLE large_table ADD COLUMN new_col INT;

-- åŒæ—¶æœ‰å¤§é‡SELECTæŸ¥è¯¢
SELECT * FROM large_table WHERE ...;
```

**è¯Šæ–­**:

```sql
-- æŸ¥çœ‹è¡¨é”
SELECT
    l.locktype,
    l.database,
    l.relation::regclass,
    l.mode,
    l.granted,
    a.query,
    a.state
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.relation = 'large_table'::regclass;

-- ç»“æœ:
-- ALTER TABLEæŒæœ‰AccessExclusiveLock
-- SELECTæŸ¥è¯¢ç­‰å¾…AccessShareLock
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: ä½¿ç”¨CONCURRENTLYï¼ˆPostgreSQL 12+ï¼‰
CREATE INDEX CONCURRENTLY idx_name ON large_table(column);

-- æ–¹æ¡ˆ2: åœ¨ä½å³°æœŸæ‰§è¡ŒDDL
-- ä½¿ç”¨pg_terminate_backend()ç»ˆæ­¢é˜»å¡æŸ¥è¯¢ï¼ˆè°¨æ…ï¼ï¼‰

-- æ–¹æ¡ˆ3: ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆé¿å…å…¨è¡¨é”ï¼‰
ALTER TABLE large_table ADD COLUMN new_col INT;  -- åªé”å•ä¸ªåˆ†åŒº
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜

### 9.1 å¿«é€Ÿè·¯å¾„é”ä¼˜åŒ–

**é—®é¢˜**: ç®€å•SELECTæ“ä½œé”å¼€é”€å¤§

**ä¼˜åŒ–**: Fast Path Locking

```c
// å¿«é€Ÿè·¯å¾„ï¼šé¿å…å…±äº«å†…å­˜é”è¡¨
bool FastPathGrantRelationLock(Oid relid, LOCKMODE lockmode) {
    uint32 f;
    uint32 mask = FAST_PATH_MASK(lockmode);

    if (MyProc->fpRelId[FAST_PATH_GET_BITSETPOS(relid)] & mask) {
        return true;  // å·²æŒæœ‰
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨å¿«é€Ÿè·¯å¾„
    if (lockmode == AccessShareLock || lockmode == RowExclusiveLock) {
        MyProc->fpRelId[FAST_PATH_GET_BITSETPOS(relid)] |= mask;
        return true;
    }

    return false;  // å›é€€åˆ°æ…¢é€Ÿè·¯å¾„
}
```

**æ€§èƒ½æå‡**: SELECTé”è·å–å»¶è¿Ÿä»5Î¼sé™è‡³0.5Î¼sï¼ˆ10Ã—ï¼‰

### 9.2 æ­»é”æ£€æµ‹ä¼˜åŒ–

**é—®é¢˜**: æ­»é”æ£€æµ‹é¢‘ç¹æ‰«æï¼ŒCPUå ç”¨é«˜

**ä¼˜åŒ–**: å»¶è¿Ÿæ£€æµ‹ + å¢é‡æ‰«æ

```c
// ä¼˜åŒ–ï¼šå»¶è¿Ÿæ­»é”æ£€æµ‹
void CheckDeadLock(void) {
    static TimestampTz last_check = 0;
    TimestampTz now = GetCurrentTimestamp();

    // æ¯1ç§’æ£€æµ‹ä¸€æ¬¡ï¼ˆè€Œéæ¯æ¬¡é”ç­‰å¾…ï¼‰
    if (now - last_check < 1000000) {  // 1ç§’
        return;
    }

    last_check = now;

    // å¢é‡æ„å»ºç­‰å¾…å›¾ï¼ˆåªæ‰«ææ–°ç­‰å¾…ï¼‰
    BuildWaitGraphIncremental();

    // DFSæ£€æµ‹ç¯
    if (DeadLockCheck()) {
        HandleDeadlock();
    }
}
```

**æ•ˆæœ**: CPUå ç”¨ä»15%é™è‡³3%

---

## åã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: é•¿äº‹åŠ¡æŒæœ‰é”

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
def process_order(order_id):
    conn.begin()

    # è·å–é”
    cursor.execute("SELECT * FROM orders WHERE id = %s FOR UPDATE", (order_id,))

    # è€—æ—¶æ“ä½œï¼ˆæŒæœ‰é”ï¼‰
    time.sleep(10)  # å¤–éƒ¨APIè°ƒç”¨

    cursor.execute("UPDATE orders SET status = 'processed' WHERE id = %s", (order_id,))
    conn.commit()
```

**é—®é¢˜**: é”æŒæœ‰æ—¶é—´è¿‡é•¿ï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: ç¼©çŸ­é”æŒæœ‰æ—¶é—´
def process_order(order_id):
    # 1. å…ˆæ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆæ— é”ï¼‰
    result = call_external_api(order_id)

    # 2. å†è·å–é”å¹¶æ›´æ–°
    conn.begin()
    cursor.execute("SELECT * FROM orders WHERE id = %s FOR UPDATE", (order_id,))
    cursor.execute("UPDATE orders SET status = 'processed' WHERE id = %s", (order_id,))
    conn.commit()  # é”æŒæœ‰æ—¶é—´<10ms
```

### åä¾‹2: é”ç²’åº¦ä¸å½“

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: è¡¨çº§é”ï¼ˆé˜»å¡æ‰€æœ‰æ“ä½œï¼‰
LOCK TABLE orders IN EXCLUSIVE MODE;
UPDATE orders SET status = 'processed' WHERE id = 1;
UNLOCK TABLE orders;
```

**é—®é¢˜**: é˜»å¡æ‰€æœ‰å…¶ä»–æŸ¥è¯¢

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: è¡Œçº§é”ï¼ˆåªé”å®šç‰¹å®šè¡Œï¼‰
BEGIN;
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
UPDATE orders SET status = 'processed' WHERE id = 1;
COMMIT;  -- åªé”å®šid=1çš„è¡Œ
```

### åä¾‹3: æ­»é”æ£€æµ‹å®ç°é”™è¯¯

**é”™è¯¯è®¾è®¡**: æ­»é”æ£€æµ‹ç®—æ³•å®ç°ä¸å®Œæ•´

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: PostgreSQLé”æœºåˆ¶
â”œâ”€ é—®é¢˜: æ­»é”æ£€æµ‹åªæ£€æµ‹éƒ¨åˆ†åœºæ™¯
â”œâ”€ ç»“æœ: æŸäº›æ­»é”æœªè¢«æ£€æµ‹
â””â”€ åæœ: ç³»ç»Ÿé˜»å¡ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸæ•°æ®åº“ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: æ­»é”æ£€æµ‹å¿½ç•¥å¤šè¡¨æ­»é”
â”œâ”€ ç»“æœ: å¤šè¡¨æ­»é”æœªè¢«æ£€æµ‹
â””â”€ åæœ: ç³»ç»Ÿé˜»å¡ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: å®Œæ•´çš„æ­»é”æ£€æµ‹ç®—æ³•
â”œâ”€ å®ç°: æ£€æµ‹æ‰€æœ‰ç±»å‹çš„æ­»é”
â””â”€ ç»“æœ: æ‰€æœ‰æ­»é”è¢«æ£€æµ‹ âœ“
```

### åä¾‹4: é”ç­‰å¾…é˜Ÿåˆ—æœªä¼˜åŒ–

**é”™è¯¯è®¾è®¡**: é”ç­‰å¾…é˜Ÿåˆ—å®ç°æœªä¼˜åŒ–

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: PostgreSQLé”æœºåˆ¶
â”œâ”€ é—®é¢˜: é”ç­‰å¾…é˜Ÿåˆ—æœªä¼˜åŒ–
â”œâ”€ ç»“æœ: é«˜å¹¶å‘æ—¶é”ç­‰å¾…æ—¶é—´é•¿
â””â”€ æ€§èƒ½: å»¶è¿Ÿå¢åŠ  âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸé«˜å¹¶å‘æ•°æ®åº“
â”œâ”€ é—®é¢˜: é”ç­‰å¾…é˜Ÿåˆ—FIFOï¼Œä¸å…¬å¹³
â”œâ”€ ç»“æœ: æŸäº›äº‹åŠ¡é•¿æ—¶é—´ç­‰å¾…
â””â”€ åæœ: ç”¨æˆ·ä½“éªŒå·® âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: é”ç­‰å¾…é˜Ÿåˆ—ä¼˜åŒ–
â”œâ”€ å®ç°: ä¼˜å…ˆçº§é˜Ÿåˆ—æˆ–å…¬å¹³è°ƒåº¦
â””â”€ ç»“æœ: é”ç­‰å¾…æ—¶é—´é™ä½ âœ“
```

### åä¾‹5: å¿«é€Ÿè·¯å¾„é”ä½¿ç”¨ä¸å½“

**é”™è¯¯è®¾è®¡**: å¿«é€Ÿè·¯å¾„é”ä½¿ç”¨ä¸å½“

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: PostgreSQLé”æœºåˆ¶
â”œâ”€ é—®é¢˜: æ‰€æœ‰é”éƒ½èµ°å¿«é€Ÿè·¯å¾„
â”œâ”€ ç»“æœ: å¿«é€Ÿè·¯å¾„é”å†²çª
â””â”€ æ€§èƒ½: æ€§èƒ½ä¸‹é™ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸæ•°æ®åº“ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: é«˜å¹¶å‘æ—¶å¿«é€Ÿè·¯å¾„é”å†²çª
â”œâ”€ ç»“æœ: å¿«é€Ÿè·¯å¾„å¤±æ•ˆï¼Œå›é€€åˆ°æ…¢é€Ÿè·¯å¾„
â””â”€ åæœ: æ€§èƒ½ä¸‹é™ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: åˆç†ä½¿ç”¨å¿«é€Ÿè·¯å¾„é”
â”œâ”€ å®ç°: ä½å†²çªåœºæ™¯ç”¨å¿«é€Ÿè·¯å¾„ï¼Œé«˜å†²çªç”¨æ…¢é€Ÿè·¯å¾„
â””â”€ ç»“æœ: æ€§èƒ½ä¼˜åŒ– âœ“
```

### åä¾‹6: é”è¯Šæ–­å·¥å…·ä½¿ç”¨ä¸å½“

**é”™è¯¯è®¾è®¡**: é”è¯Šæ–­å·¥å…·ä½¿ç”¨ä¸å½“

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: PostgreSQLé”æœºåˆ¶
â”œâ”€ é—®é¢˜: ä¸ç†è§£é”è¯Šæ–­å·¥å…·è¾“å‡º
â”œâ”€ ç»“æœ: æ— æ³•è¯Šæ–­é”é—®é¢˜
â””â”€ åæœ: é”é—®é¢˜æ— æ³•è§£å†³ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸæ•°æ®åº“ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ä¸ç†è§£pg_locksè¾“å‡º
â”œâ”€ ç»“æœ: æ— æ³•å®šä½é”ç«äº‰
â””â”€ åæœ: æ€§èƒ½é—®é¢˜æ— æ³•è§£å†³ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: ç†è§£é”è¯Šæ–­å·¥å…·
â”œâ”€ å®ç°: æ­£ç¡®ä½¿ç”¨pg_locksã€pg_stat_activity
â””â”€ ç»“æœ: å¿«é€Ÿå®šä½å’Œè§£å†³é”é—®é¢˜ âœ“
```

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 é”ç®¡ç†å™¨å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: Pythonæ¨¡æ‹ŸPostgreSQLé”ç®¡ç†å™¨

```python
from dataclasses import dataclass
from typing import Dict, List, Set, Optional
from enum import Enum
from collections import defaultdict
import threading

class LockMode(Enum):
    """é”æ¨¡å¼"""
    ACCESS_SHARE = "AccessShareLock"
    ROW_SHARE = "RowShareLock"
    ROW_EXCLUSIVE = "RowExclusiveLock"
    SHARE_UPDATE_EXCLUSIVE = "ShareUpdateExclusiveLock"
    SHARE = "ShareLock"
    SHARE_ROW_EXCLUSIVE = "ShareRowExclusiveLock"
    EXCLUSIVE = "ExclusiveLock"
    ACCESS_EXCLUSIVE = "AccessExclusiveLock"

# é”å…¼å®¹æ€§çŸ©é˜µ
LOCK_COMPATIBILITY = {
    LockMode.ACCESS_SHARE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE, LockMode.ROW_EXCLUSIVE,
        LockMode.SHARE_UPDATE_EXCLUSIVE, LockMode.SHARE, LockMode.SHARE_ROW_EXCLUSIVE,
        LockMode.EXCLUSIVE
    },
    LockMode.ROW_SHARE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE, LockMode.ROW_EXCLUSIVE,
        LockMode.SHARE_UPDATE_EXCLUSIVE, LockMode.SHARE, LockMode.SHARE_ROW_EXCLUSIVE
    },
    LockMode.ROW_EXCLUSIVE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE, LockMode.ROW_EXCLUSIVE,
        LockMode.SHARE_UPDATE_EXCLUSIVE
    },
    LockMode.SHARE_UPDATE_EXCLUSIVE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE, LockMode.ROW_EXCLUSIVE
    },
    LockMode.SHARE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE, LockMode.SHARE
    },
    LockMode.SHARE_ROW_EXCLUSIVE: {
        LockMode.ACCESS_SHARE, LockMode.ROW_SHARE
    },
    LockMode.EXCLUSIVE: {
        LockMode.ACCESS_SHARE
    },
    LockMode.ACCESS_EXCLUSIVE: set()  # ä¸å…¼å®¹ä»»ä½•é”
}

@dataclass
class LockRequest:
    """é”è¯·æ±‚"""
    transaction_id: int
    lock_mode: LockMode
    resource_id: str
    granted: bool = False

class LockManager:
    """é”ç®¡ç†å™¨"""

    def __init__(self):
        self.locks: Dict[str, Dict[LockMode, Set[int]]] = defaultdict(lambda: defaultdict(set))
        self.wait_queue: Dict[str, List[LockRequest]] = defaultdict(list)
        self.lock = threading.Lock()

    def acquire_lock(
        self,
        transaction_id: int,
        resource_id: str,
        lock_mode: LockMode
    ) -> bool:
        """è·å–é”"""
        with self.lock:
            # æ£€æŸ¥æ˜¯å¦å·²æŒæœ‰å…¼å®¹é”
            if self._has_compatible_lock(transaction_id, resource_id, lock_mode):
                return True

            # æ£€æŸ¥æ˜¯å¦å¯ä»¥ç«‹å³è·å–
            if self._can_grant_immediately(resource_id, lock_mode):
                self._grant_lock(transaction_id, resource_id, lock_mode)
                return True

            # æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—
            request = LockRequest(transaction_id, lock_mode, resource_id)
            self.wait_queue[resource_id].append(request)
            return False

    def release_lock(
        self,
        transaction_id: int,
        resource_id: str,
        lock_mode: LockMode
    ):
        """é‡Šæ”¾é”"""
        with self.lock:
            if resource_id in self.locks and lock_mode in self.locks[resource_id]:
                self.locks[resource_id][lock_mode].discard(transaction_id)

                # æ¸…ç†ç©ºé”
                if not self.locks[resource_id][lock_mode]:
                    del self.locks[resource_id][lock_mode]
                if not self.locks[resource_id]:
                    del self.locks[resource_id]

            # å”¤é†’ç­‰å¾…é˜Ÿåˆ—
            self._wakeup_waiters(resource_id)

    def _has_compatible_lock(
        self,
        transaction_id: int,
        resource_id: str,
        lock_mode: LockMode
    ) -> bool:
        """æ£€æŸ¥æ˜¯å¦å·²æŒæœ‰å…¼å®¹é”"""
        if resource_id not in self.locks:
            return False

        for mode, holders in self.locks[resource_id].items():
            if transaction_id in holders:
                # æ£€æŸ¥æ˜¯å¦å…¼å®¹
                if lock_mode in LOCK_COMPATIBILITY.get(mode, set()):
                    return True
        return False

    def _can_grant_immediately(
        self,
        resource_id: str,
        lock_mode: LockMode
    ) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥ç«‹å³æˆäºˆé”"""
        if resource_id not in self.locks:
            return True

        # æ£€æŸ¥ä¸ç°æœ‰é”çš„å…¼å®¹æ€§
        compatible_modes = LOCK_COMPATIBILITY.get(lock_mode, set())
        for mode in self.locks[resource_id]:
            if mode not in compatible_modes:
                return False

        return True

    def _grant_lock(
        self,
        transaction_id: int,
        resource_id: str,
        lock_mode: LockMode
    ):
        """æˆäºˆé”"""
        self.locks[resource_id][lock_mode].add(transaction_id)

    def _wakeup_waiters(self, resource_id: str):
        """å”¤é†’ç­‰å¾…è€…"""
        if resource_id not in self.wait_queue:
            return

        # æ£€æŸ¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
        granted = []
        remaining = []

        for request in self.wait_queue[resource_id]:
            if self._can_grant_immediately(resource_id, request.lock_mode):
                self._grant_lock(request.transaction_id, resource_id, request.lock_mode)
                request.granted = True
                granted.append(request)
            else:
                remaining.append(request)

        self.wait_queue[resource_id] = remaining
        return granted

    def detect_deadlock(self) -> Optional[List[int]]:
        """æ£€æµ‹æ­»é”ï¼ˆè¿”å›æ­»é”ç¯ï¼‰"""
        # æ„å»ºç­‰å¾…å›¾
        wait_graph = defaultdict(set)

        for resource_id, requests in self.wait_queue.items():
            # è·å–å½“å‰æŒæœ‰é”çš„äº‹åŠ¡
            holders = set()
            if resource_id in self.locks:
                for mode, txs in self.locks[resource_id].items():
                    holders.update(txs)

            # ç­‰å¾…è€… -> æŒæœ‰è€…
            for request in requests:
                if not request.granted:
                    for holder in holders:
                        wait_graph[request.transaction_id].add(holder)

        # DFSæ£€æµ‹ç¯
        visited = set()
        rec_stack = set()
        cycle = []

        def dfs(node):
            visited.add(node)
            rec_stack.add(node)
            cycle.append(node)

            for neighbor in wait_graph.get(node, []):
                if neighbor not in visited:
                    if dfs(neighbor):
                        return True
                elif neighbor in rec_stack:
                    # æ‰¾åˆ°ç¯
                    cycle.append(neighbor)
                    return True

            rec_stack.remove(node)
            cycle.pop()
            return False

        for node in wait_graph:
            if node not in visited:
                if dfs(node):
                    return cycle

        return None

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    lock_mgr = LockManager()

    # äº‹åŠ¡1è·å–AccessShareLock
    lock_mgr.acquire_lock(1, "table1", LockMode.ACCESS_SHARE)
    print("äº‹åŠ¡1è·å–AccessShareLockæˆåŠŸ")

    # äº‹åŠ¡2å°è¯•è·å–AccessExclusiveLockï¼ˆåº”è¯¥ç­‰å¾…ï¼‰
    result = lock_mgr.acquire_lock(2, "table1", LockMode.ACCESS_EXCLUSIVE)
    print(f"äº‹åŠ¡2è·å–AccessExclusiveLock: {'æˆåŠŸ' if result else 'ç­‰å¾…'}")

    # æ£€æµ‹æ­»é”
    cycle = lock_mgr.detect_deadlock()
    if cycle:
        print(f"æ£€æµ‹åˆ°æ­»é”: {cycle}")

    # é‡Šæ”¾é”
    lock_mgr.release_lock(1, "table1", LockMode.ACCESS_SHARE)
    print("äº‹åŠ¡1é‡Šæ”¾é”")
```

### 11.2 æ­»é”æ£€æµ‹ç®—æ³•å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: æ­»é”æ£€æµ‹çš„å®Œæ•´å®ç°

```python
from typing import Dict, List, Set, Optional
from collections import defaultdict

class DeadlockDetector:
    """æ­»é”æ£€æµ‹å™¨"""

    def __init__(self):
        self.wait_graph: Dict[int, Set[int]] = defaultdict(set)

    def add_wait(self, waiter: int, holder: int):
        """æ·»åŠ ç­‰å¾…å…³ç³»"""
        self.wait_graph[waiter].add(holder)

    def remove_wait(self, waiter: int, holder: int):
        """ç§»é™¤ç­‰å¾…å…³ç³»"""
        if waiter in self.wait_graph:
            self.wait_graph[waiter].discard(holder)
            if not self.wait_graph[waiter]:
                del self.wait_graph[waiter]

    def detect_cycle(self) -> Optional[List[int]]:
        """æ£€æµ‹æ­»é”ç¯"""
        visited = set()
        rec_stack = set()
        path = []

        def dfs(node):
            visited.add(node)
            rec_stack.add(node)
            path.append(node)

            for neighbor in self.wait_graph.get(node, []):
                if neighbor not in visited:
                    if dfs(neighbor):
                        return True
                elif neighbor in rec_stack:
                    # æ‰¾åˆ°ç¯
                    # æ‰¾åˆ°ç¯çš„èµ·å§‹ä½ç½®
                    start_idx = path.index(neighbor)
                    cycle = path[start_idx:] + [neighbor]
                    return cycle

            rec_stack.remove(node)
            path.pop()
            return False

        for node in self.wait_graph:
            if node not in visited:
                result = dfs(node)
                if result:
                    if isinstance(result, list):
                        return result
                    # å¦‚æœè¿”å›Trueï¼Œä»pathä¸­æå–ç¯
                    return path

        return None

    def find_victim(self, cycle: List[int]) -> int:
        """é€‰æ‹©æ­»é”ç‰ºç‰²è€…ï¼ˆé€‰æ‹©æŒæœ‰é”æœ€å°‘çš„äº‹åŠ¡ï¼‰"""
        # ç®€åŒ–: é€‰æ‹©ç¬¬ä¸€ä¸ªäº‹åŠ¡
        return cycle[0]

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    detector = DeadlockDetector()

    # æ„å»ºç­‰å¾…å›¾: T1ç­‰å¾…T2, T2ç­‰å¾…T3, T3ç­‰å¾…T1
    detector.add_wait(1, 2)
    detector.add_wait(2, 3)
    detector.add_wait(3, 1)

    # æ£€æµ‹æ­»é”
    cycle = detector.detect_cycle()
    if cycle:
        print(f"æ£€æµ‹åˆ°æ­»é”ç¯: {cycle}")
        victim = detector.find_victim(cycle)
        print(f"é€‰æ‹©ç‰ºç‰²è€…: äº‹åŠ¡{victim}")
```

### 11.3 å¿«é€Ÿè·¯å¾„é”å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: Fast Path Lockingå®ç°

```python
from typing import Dict, Set
from dataclasses import dataclass

@dataclass
class FastPathLock:
    """å¿«é€Ÿè·¯å¾„é”"""
    rel_id: int
    lock_mode: LockMode

    def __hash__(self):
        return hash((self.rel_id, self.lock_mode))

    def __eq__(self, other):
        return (self.rel_id, self.lock_mode) == (other.rel_id, other.lock_mode)

class FastPathLockManager:
    """å¿«é€Ÿè·¯å¾„é”ç®¡ç†å™¨"""

    def __init__(self, max_fast_path_locks: int = 16):
        self.max_fast_path_locks = max_fast_path_locks
        self.fast_path_locks: Set[FastPathLock] = set()
        self.slow_path_locks: Dict[int, Set[LockMode]] = {}

    def acquire_fast_path_lock(
        self,
        transaction_id: int,
        rel_id: int,
        lock_mode: LockMode
    ) -> bool:
        """å°è¯•å¿«é€Ÿè·¯å¾„è·å–é”"""
        # å¿«é€Ÿè·¯å¾„åªæ”¯æŒç‰¹å®šé”æ¨¡å¼
        if lock_mode not in [LockMode.ACCESS_SHARE, LockMode.ROW_EXCLUSIVE]:
            return False

        # æ£€æŸ¥å¿«é€Ÿè·¯å¾„æ˜¯å¦å·²æ»¡
        if len(self.fast_path_locks) >= self.max_fast_path_locks:
            return False

        lock = FastPathLock(rel_id, lock_mode)

        # æ£€æŸ¥æ˜¯å¦å·²æŒæœ‰
        if lock in self.fast_path_locks:
            return True

        # æ·»åŠ åˆ°å¿«é€Ÿè·¯å¾„
        self.fast_path_locks.add(lock)
        return True

    def release_fast_path_lock(
        self,
        transaction_id: int,
        rel_id: int,
        lock_mode: LockMode
    ):
        """é‡Šæ”¾å¿«é€Ÿè·¯å¾„é”"""
        lock = FastPathLock(rel_id, lock_mode)
        self.fast_path_locks.discard(lock)

    def promote_to_slow_path(
        self,
        transaction_id: int,
        rel_id: int,
        lock_mode: LockMode
    ):
        """æå‡åˆ°æ…¢é€Ÿè·¯å¾„"""
        # ä»å¿«é€Ÿè·¯å¾„ç§»é™¤
        self.release_fast_path_lock(transaction_id, rel_id, lock_mode)

        # æ·»åŠ åˆ°æ…¢é€Ÿè·¯å¾„
        if rel_id not in self.slow_path_locks:
            self.slow_path_locks[rel_id] = set()
        self.slow_path_locks[rel_id].add(lock_mode)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    fast_mgr = FastPathLockManager()

    # å¿«é€Ÿè·¯å¾„è·å–é”
    result = fast_mgr.acquire_fast_path_lock(1, 100, LockMode.ACCESS_SHARE)
    print(f"å¿«é€Ÿè·¯å¾„è·å–é”: {'æˆåŠŸ' if result else 'å¤±è´¥'}")

    # é‡Šæ”¾é”
    fast_mgr.release_fast_path_lock(1, 100, LockMode.ACCESS_SHARE)
    print("å¿«é€Ÿè·¯å¾„é‡Šæ”¾é”")
```

---

## åäºŒã€å®ç°æ¶æ„å¯è§†åŒ–

### 12.1 é”ç®¡ç†å™¨æ¶æ„å›¾

**å®Œæ•´é”ç®¡ç†å™¨æ¶æ„** (Mermaid):

```mermaid
classDiagram
    class Lock {
        +LOCKTAG tag
        +LOCKMODE grantMask
        +LOCKMODE waitMask
        +SHM_QUEUE waitProcs
        +int nRequested
        +int nGranted
    }

    class PROCLOCK {
        +LOCK* lock
        +PGPROC* groupLeader
        +LOCKMODE holdMask
        +SHM_QUEUE lockLink
    }

    class PGPROC {
        +TransactionId xid
        +LOCKMODE waitLockMode
        +PROCLOCK* waitProcLock
        +SHM_QUEUE lockLink
    }

    class LockMethod {
        +int numLockModes
        +LOCKMASK* conflictTab
    }

    Lock -->|ç®¡ç†| PROCLOCK : æŒæœ‰è€…åˆ—è¡¨
    PROCLOCK -->|å…³è”| PGPROC : è¿›ç¨‹ç»“æ„
    LockMethod -->|æ§åˆ¶| Lock : é”æ¨¡å¼è§„åˆ™
```

**é”ç®¡ç†å™¨å±‚æ¬¡è¯´æ˜**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: é”å¯¹è±¡å±‚                            â”‚
â”‚  Lock (é”å¯¹è±¡)                           â”‚
â”‚  â”œâ”€ tag: é”æ ‡è¯† (å…³ç³»/äº‹åŠ¡/å¯¹è±¡)         â”‚
â”‚  â”œâ”€ grantMask: å·²æˆäºˆçš„é”æ¨¡å¼           â”‚
â”‚  â”œâ”€ waitMask: ç­‰å¾…çš„é”æ¨¡å¼              â”‚
â”‚  â””â”€ waitProcs: ç­‰å¾…é˜Ÿåˆ—                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å…³è”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: è¿›ç¨‹é”å…³è”å±‚                        â”‚
â”‚  PROCLOCK (è¿›ç¨‹-é”å…³è”)                  â”‚
â”‚  â”œâ”€ lock: æŒ‡å‘é”å¯¹è±¡                     â”‚
â”‚  â”œâ”€ groupLeader: ç»„é¢†å¯¼è€…               â”‚
â”‚  â””â”€ holdMask: æŒæœ‰çš„é”æ¨¡å¼              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å…³è”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: è¿›ç¨‹å±‚                              â”‚
â”‚  PGPROC (åç«¯è¿›ç¨‹)                       â”‚
â”‚  â”œâ”€ xid: äº‹åŠ¡ID                         â”‚
â”‚  â”œâ”€ waitLockMode: ç­‰å¾…çš„é”æ¨¡å¼          â”‚
â”‚  â””â”€ waitProcLock: ç­‰å¾…çš„é”å…³è”          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æ§åˆ¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: é”æ–¹æ³•å±‚                            â”‚
â”‚  LockMethod (é”æ–¹æ³•è¡¨)                   â”‚
â”‚  â”œâ”€ numLockModes: é”æ¨¡å¼æ•°é‡            â”‚
â”‚  â””â”€ conflictTab: å†²çªè¡¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 åŠ é”æµç¨‹è®¾è®¡å›¾

**å®Œæ•´åŠ é”æµç¨‹** (Mermaid):

```mermaid
flowchart TD
    START([è¯·æ±‚åŠ é”]) --> CHECK_FAST{å¿«é€Ÿè·¯å¾„?}

    CHECK_FAST -->|æ˜¯| FAST_PATH[å¿«é€Ÿè·¯å¾„åŠ é”]
    CHECK_FAST -->|å¦| SLOW_PATH[æ…¢é€Ÿè·¯å¾„åŠ é”]

    FAST_PATH --> CHECK_FAST_COMPAT{å…¼å®¹æ€§æ£€æŸ¥}
    CHECK_FAST_COMPAT -->|å…¼å®¹| GRANT_FAST[æˆäºˆé”]
    CHECK_FAST_COMPAT -->|ä¸å…¼å®¹| PROMOTE[æå‡åˆ°æ…¢é€Ÿè·¯å¾„]

    SLOW_PATH --> CHECK_SLOW_COMPAT{å…¼å®¹æ€§æ£€æŸ¥}
    CHECK_SLOW_COMPAT -->|å…¼å®¹| GRANT_SLOW[æˆäºˆé”]
    CHECK_SLOW_COMPAT -->|ä¸å…¼å®¹| WAIT[åŠ å…¥ç­‰å¾…é˜Ÿåˆ—]

    WAIT --> DEADLOCK_CHECK{æ­»é”æ£€æµ‹}
    DEADLOCK_CHECK -->|æ£€æµ‹åˆ°æ­»é”| ABORT[ä¸­æ­¢äº‹åŠ¡]
    DEADLOCK_CHECK -->|æ— æ­»é”| WAIT_TIMEOUT{ç­‰å¾…è¶…æ—¶?}

    WAIT_TIMEOUT -->|è¶…æ—¶| TIMEOUT_ERROR[è¶…æ—¶é”™è¯¯]
    WAIT_TIMEOUT -->|æœªè¶…æ—¶| RETRY[é‡è¯•è·å–é”]

    GRANT_FAST --> END([å®Œæˆ])
    GRANT_SLOW --> END
    ABORT --> END
    TIMEOUT_ERROR --> END
    RETRY --> CHECK_SLOW_COMPAT
    PROMOTE --> CHECK_SLOW_COMPAT
```

**åŠ é”å†³ç­–æ ‘**:

```text
                è¯·æ±‚åŠ é”
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   é”ç±»å‹åˆ¤æ–­          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
   å¿«é€Ÿè·¯å¾„é”      æ…¢é€Ÿè·¯å¾„é”      ç‰¹æ®Šé”
  (AccessShare)   (å…¶ä»–æ¨¡å¼)     (AccessExclusive)
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
  æ£€æŸ¥å…¼å®¹æ€§      æ£€æŸ¥å…¼å®¹æ€§      ç›´æ¥æ…¢é€Ÿè·¯å¾„
      â”‚               â”‚               â”‚
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
  å…¼å®¹â†’æˆäºˆ      å…¼å®¹â†’æˆäºˆ      æ£€æŸ¥å†²çª
  ä¸å…¼å®¹â†’æå‡    ä¸å…¼å®¹â†’ç­‰å¾…    å†²çªâ†’ç­‰å¾…
```

### 12.3 æ­»é”æ£€æµ‹æµç¨‹å›¾

**æ­»é”æ£€æµ‹å®Œæ•´æµç¨‹** (Mermaid):

```mermaid
sequenceDiagram
    participant Proc1 as è¿›ç¨‹1
    participant Proc2 as è¿›ç¨‹2
    participant LockMgr as é”ç®¡ç†å™¨
    participant DeadlockDetector as æ­»é”æ£€æµ‹å™¨

    Proc1->>LockMgr: è¯·æ±‚é”A (å·²æŒæœ‰é”B)
    LockMgr->>LockMgr: æ£€æŸ¥å†²çª
    LockMgr-->>Proc1: ç­‰å¾…é”A

    Proc2->>LockMgr: è¯·æ±‚é”B (å·²æŒæœ‰é”A)
    LockMgr->>LockMgr: æ£€æŸ¥å†²çª
    LockMgr-->>Proc2: ç­‰å¾…é”B

    Note over Proc1,Proc2: æ£€æµ‹åˆ°ç­‰å¾…è¶…æ—¶

    LockMgr->>DeadlockDetector: è§¦å‘æ­»é”æ£€æµ‹
    DeadlockDetector->>DeadlockDetector: æ„å»ºç­‰å¾…å›¾
    DeadlockDetector->>DeadlockDetector: DFSæœç´¢ç¯

    alt æ£€æµ‹åˆ°ç¯
        DeadlockDetector->>DeadlockDetector: é€‰æ‹©ç‰ºç‰²è€… (æœ€æ–°äº‹åŠ¡)
        DeadlockDetector->>Proc1: ä¸­æ­¢äº‹åŠ¡
        Proc1->>LockMgr: é‡Šæ”¾é”B
        LockMgr->>Proc2: æˆäºˆé”B
        Proc2-->>Proc2: ç»§ç»­æ‰§è¡Œ
    else æœªæ£€æµ‹åˆ°ç¯
        DeadlockDetector-->>LockMgr: ç»§ç»­ç­‰å¾…
    end
```

**æ­»é”æ£€æµ‹ç®—æ³•æµç¨‹**:

```text
æ­»é”æ£€æµ‹æµç¨‹:
â”œâ”€ Step 1: è§¦å‘æ¡ä»¶
â”‚   â””â”€ deadlock_timeout (é»˜è®¤1ç§’)
â”‚
â”œâ”€ Step 2: æ„å»ºç­‰å¾…å›¾
â”‚   â”œâ”€ èŠ‚ç‚¹: äº‹åŠ¡ (PGPROC)
â”‚   â””â”€ è¾¹: ç­‰å¾…å…³ç³» (Aç­‰å¾…BæŒæœ‰çš„é”)
â”‚
â”œâ”€ Step 3: DFSæœç´¢ç¯
â”‚   â”œâ”€ ä»æ¯ä¸ªèŠ‚ç‚¹å¼€å§‹DFS
â”‚   â”œâ”€ è®°å½•è®¿é—®è·¯å¾„
â”‚   â””â”€ æ£€æµ‹å›è¾¹ (å½¢æˆç¯)
â”‚
â”œâ”€ Step 4: é€‰æ‹©ç‰ºç‰²è€…
â”‚   â”œâ”€ é€‰æ‹©æœ€æ–°äº‹åŠ¡ (xidæœ€å¤§)
â”‚   â””â”€ æˆ–é€‰æ‹©ä»£ä»·æœ€å°çš„äº‹åŠ¡
â”‚
â””â”€ Step 5: è§£é™¤æ­»é”
    â”œâ”€ ä¸­æ­¢ç‰ºç‰²è€…äº‹åŠ¡
    â”œâ”€ é‡Šæ”¾å…¶æŒæœ‰çš„é”
    â””â”€ å”¤é†’ç­‰å¾…çš„è¿›ç¨‹
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´æºç åˆ†æã€å®é™…æ¡ˆä¾‹ã€æ€§èƒ½ä¼˜åŒ–ã€åä¾‹ã€å®Œæ•´å®ç°ä»£ç ã€å®ç°æ¶æ„å¯è§†åŒ–ï¼ˆé”ç®¡ç†å™¨æ¶æ„å›¾ã€åŠ é”æµç¨‹è®¾è®¡å›¾ã€æ­»é”æ£€æµ‹æµç¨‹å›¾ï¼‰ã€PostgreSQLé”æœºåˆ¶å®ç°èƒŒæ™¯ä¸æ¼”è¿›ï¼ˆä¸ºä»€ä¹ˆéœ€è¦æ·±å…¥ç†è§£PostgreSQLé”æœºåˆ¶å®ç°ã€å†å²èƒŒæ™¯ã€ç†è®ºåŸºç¡€ã€æ ¸å¿ƒæŒ‘æˆ˜ï¼‰ã€PostgreSQLé”æœºåˆ¶åä¾‹è¡¥å……ï¼ˆ6ä¸ªæ–°å¢åä¾‹ï¼šæ­»é”æ£€æµ‹å®ç°é”™è¯¯ã€é”ç­‰å¾…é˜Ÿåˆ—æœªä¼˜åŒ–ã€å¿«é€Ÿè·¯å¾„é”ä½¿ç”¨ä¸å½“ã€é”è¯Šæ–­å·¥å…·ä½¿ç”¨ä¸å½“ï¼‰

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md`
- `05-å®ç°æœºåˆ¶/01-PostgreSQL-MVCCå®ç°.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md`
- `11-å·¥å…·ä¸è‡ªåŠ¨åŒ–/08-æ­»é”åˆ†æå™¨.md` (æ­»é”åˆ†æå·¥å…·)
