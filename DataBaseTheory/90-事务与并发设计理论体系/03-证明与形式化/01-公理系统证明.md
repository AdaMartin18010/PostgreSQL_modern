# 01 | å…¬ç†ç³»ç»Ÿè¯æ˜

> **è¯æ˜å®šä½**: æœ¬æ–‡æ¡£æä¾›LSEMä¸‰å¤§å…¬ç†çš„å®Œæ•´æ•°å­¦è¯æ˜ï¼Œæ˜¯æ•´ä¸ªç†è®ºä½“ç³»çš„ä¸¥æ ¼åŸºç¡€ã€‚

---

## ğŸ“‘ ç›®å½•

- [01 | å…¬ç†ç³»ç»Ÿè¯æ˜](#01--å…¬ç†ç³»ç»Ÿè¯æ˜)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€å…¬ç†ç³»ç»Ÿæ¦‚è¿°](#ä¸€å…¬ç†ç³»ç»Ÿæ¦‚è¿°)
    - [1.1 å…¬ç†åŒ–æ–¹æ³•](#11-å…¬ç†åŒ–æ–¹æ³•)
    - [1.2 LSEMä¸‰å¤§å…¬ç†](#12-lsemä¸‰å¤§å…¬ç†)
  - [äºŒã€å…¬ç†1: çŠ¶æ€åŸå­æ€§è¯æ˜](#äºŒå…¬ç†1-çŠ¶æ€åŸå­æ€§è¯æ˜)
    - [2.1 å½¢å¼åŒ–å®šä¹‰](#21-å½¢å¼åŒ–å®šä¹‰)
    - [2.2 L0å±‚éªŒè¯ (PostgreSQL WAL)](#22-l0å±‚éªŒè¯-postgresql-wal)
    - [2.3 L1å±‚éªŒè¯ (Rustæ‰€æœ‰æƒ)](#23-l1å±‚éªŒè¯-rustæ‰€æœ‰æƒ)
    - [2.4 L2å±‚éªŒè¯ (Raftå…±è¯†)](#24-l2å±‚éªŒè¯-raftå…±è¯†)
  - [ä¸‰ã€å…¬ç†2: å¯è§æ€§ååºè¯æ˜](#ä¸‰å…¬ç†2-å¯è§æ€§ååºè¯æ˜)
    - [3.1 ååºå…³ç³»éªŒè¯](#31-ååºå…³ç³»éªŒè¯)
    - [3.2 L1å±‚éªŒè¯ (happens-before)](#32-l1å±‚éªŒè¯-happens-before)
    - [3.3 L2å±‚éªŒè¯ (HLC)](#33-l2å±‚éªŒè¯-hlc)
  - [å››ã€å…¬ç†3: å†²çªå¯ä¸²è¡ŒåŒ–è¯æ˜](#å››å…¬ç†3-å†²çªå¯ä¸²è¡ŒåŒ–è¯æ˜)
    - [4.1 ä¸²è¡ŒåŒ–å®šä¹‰](#41-ä¸²è¡ŒåŒ–å®šä¹‰)
    - [4.2 L0å±‚éªŒè¯ (PostgreSQL SSI)](#42-l0å±‚éªŒè¯-postgresql-ssi)
    - [4.3 L1å±‚éªŒè¯ (Rustå€Ÿç”¨æ£€æŸ¥)](#43-l1å±‚éªŒè¯-rustå€Ÿç”¨æ£€æŸ¥)
  - [äº”ã€å…¬ç†ç‹¬ç«‹æ€§è¯æ˜](#äº”å…¬ç†ç‹¬ç«‹æ€§è¯æ˜)
    - [5.1 å…¬ç†1ç‹¬ç«‹äºå…¬ç†2ã€3](#51-å…¬ç†1ç‹¬ç«‹äºå…¬ç†23)
    - [5.2 å…¬ç†2ç‹¬ç«‹äºå…¬ç†1ã€3](#52-å…¬ç†2ç‹¬ç«‹äºå…¬ç†13)
    - [5.3 å…¬ç†3ç‹¬ç«‹äºå…¬ç†1ã€2](#53-å…¬ç†3ç‹¬ç«‹äºå…¬ç†12)
  - [å…­ã€åŸºç¡€å®šç†æ¨å¯¼](#å…­åŸºç¡€å®šç†æ¨å¯¼)
    - [6.1 å®šç†1: MVCCæ­£ç¡®æ€§](#61-å®šç†1-mvccæ­£ç¡®æ€§)
    - [6.2 å®šç†2: æ‰€æœ‰æƒä¿è¯çº¿ç¨‹å®‰å…¨](#62-å®šç†2-æ‰€æœ‰æƒä¿è¯çº¿ç¨‹å®‰å…¨)
    - [6.3 å®šç†3: Raftä¿è¯ä¸€è‡´æ€§](#63-å®šç†3-raftä¿è¯ä¸€è‡´æ€§)
  - [ä¸ƒã€å…¬ç†ç³»ç»Ÿå…ƒæ€§è´¨](#ä¸ƒå…¬ç†ç³»ç»Ÿå…ƒæ€§è´¨)
    - [7.1 ä¸€è‡´æ€§ (Consistency)](#71-ä¸€è‡´æ€§-consistency)
    - [7.2 å®Œå¤‡æ€§ (Completeness)](#72-å®Œå¤‡æ€§-completeness)
    - [7.3 å¯åˆ¤å®šæ€§ (Decidability)](#73-å¯åˆ¤å®šæ€§-decidability)
  - [å…«ã€Coqå½¢å¼åŒ–](#å…«coqå½¢å¼åŒ–)
    - [8.1 å…¬ç†å®šä¹‰](#81-å…¬ç†å®šä¹‰)
    - [8.2 å®šç†è¯æ˜ç¤ºä¾‹](#82-å®šç†è¯æ˜ç¤ºä¾‹)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 è¯æ˜é“¾](#92-è¯æ˜é“¾)
    - [9.3 ç†è®ºä»·å€¼](#93-ç†è®ºä»·å€¼)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)

---

## ä¸€ã€å…¬ç†ç³»ç»Ÿæ¦‚è¿°

### 1.1 å…¬ç†åŒ–æ–¹æ³•

**å®šä¹‰1.1 (å…¬ç†ç³»ç»Ÿ)**:

$$AxiomSystem = (Axioms, InferenceRules, Theorems)$$

**è¦æ±‚**:

- **ä¸€è‡´æ€§** (Consistency): å…¬ç†ä¸çŸ›ç›¾
- **ç‹¬ç«‹æ€§** (Independence): å…¬ç†ç›¸äº’ç‹¬ç«‹
- **å®Œå¤‡æ€§** (Completeness): å¯æ¨å¯¼æ‰€æœ‰çœŸå‘½é¢˜

### 1.2 LSEMä¸‰å¤§å…¬ç†

**å…¬ç†1 (çŠ¶æ€åŸå­æ€§)**:

$$\forall s_i, s_j \in States: s_i \xrightarrow{atomic} s_j \iff \neg\exists s_k: s_i \to s_k \to s_j$$

**å…¬ç†2 (å¯è§æ€§ååº)**:

$$Visible \subseteq Events \times Events$$

æ»¡è¶³:

- éè‡ªåæ€§: $\forall e: \neg Visible(e, e)$
- ä¼ é€’æ€§: $Visible(e_1, e_2) \land Visible(e_2, e_3) \implies Visible(e_1, e_3)$
- åå¯¹ç§°æ€§: $Visible(e_1, e_2) \implies \neg Visible(e_2, e_1)$

**å…¬ç†3 (å†²çªå¯ä¸²è¡ŒåŒ–)**:

$$\forall Schedule \in ConcurrentExecutions: \exists SerialSchedule: Equivalent(Schedule, SerialSchedule)$$

---

## äºŒã€å…¬ç†1: çŠ¶æ€åŸå­æ€§è¯æ˜

### 2.1 å½¢å¼åŒ–å®šä¹‰

**çŠ¶æ€è½¬æ¢**:

$$\delta: States \times Events \rightarrow States$$

**åŸå­æ€§å®šä¹‰**:

$$Atomic(e) \iff \forall s: \delta(s, e) \text{ is indivisible}$$

### 2.2 L0å±‚éªŒè¯ (PostgreSQL WAL)

**å®šç†2.1 (WALä¿è¯åŸå­æ€§)**:

$$\forall Transaction T: WAL(T) \implies Atomic(T)$$

**è¯æ˜**:

**å¼•ç†2.1**: WALè®°å½•æ˜¯ä¸å¯åˆ†çš„

$$\forall \text{WAL record } r: Write(r) \text{ is atomic}$$

è¿™ç”±æ“ä½œç³»ç»Ÿä¿è¯ï¼ˆæ‰‡åŒºå†™å…¥åŸå­æ€§ï¼‰

**å¼•ç†2.2**: æäº¤å‰æ‰€æœ‰ä¿®æ”¹å·²å†™å…¥WAL

$$Commit(T) \implies \forall op \in T: WAL(op) \text{ completed}$$

è¿™ç”±PostgreSQLçš„`XLogFlush()`ä¿è¯

**å¼•ç†2.3**: å´©æºƒæ¢å¤é‡æ”¾WAL

$$Crash \implies Recovery = Redo(\text{committed in WAL}) + Undo(\text{uncommitted})$$

**ç»„åˆå¼•ç†2.1-2.3**:

å¯¹äºå·²æäº¤äº‹åŠ¡ $T$:

- WALå®Œæ•´ï¼ˆå¼•ç†2.2ï¼‰
- æ¢å¤åé‡æ”¾ï¼ˆå¼•ç†2.3ï¼‰
- æ¯æ¡è®°å½•åŸå­ï¼ˆå¼•ç†2.1ï¼‰

$$\therefore Atomic(T) \quad \square$$

### 2.3 L1å±‚éªŒè¯ (Rustæ‰€æœ‰æƒ)

**å®šç†2.2 (æ‰€æœ‰æƒä¿è¯å†…å­˜å®‰å…¨)**:

$$\forall \text{memory operation } m: Ownership(m) \implies Safe(m)$$

**è¯æ˜**:

**å¼•ç†2.4**: æ‰€æœ‰æƒå”¯ä¸€æ€§

$$\forall v: |\{owner: Owns(owner, v)\}| = 1$$

ç”±ç¼–è¯‘å™¨é™æ€åˆ†æä¿è¯

**å¼•ç†2.5**: å€Ÿç”¨æ£€æŸ¥ä¿è¯æ— åˆ«å

$$(\exists \&mut T) \implies (\neg\exists \&T \land \neg\exists \&mut T')$$

ç”±å€Ÿç”¨æ£€æŸ¥å™¨ä¿è¯

**å¼•ç†2.6**: ç”Ÿå‘½å‘¨æœŸä¿è¯å¼•ç”¨æœ‰æ•ˆ

$$\forall ref: Lifetime(ref) \subseteq Lifetime(owner)$$

ç”±ç”Ÿå‘½å‘¨æœŸåˆ†æä¿è¯

**ç»„åˆå¼•ç†2.4-2.6**:

- å”¯ä¸€æ‰€æœ‰è€…ï¼ˆå¼•ç†2.4ï¼‰
- äº’æ–¥è®¿é—®ï¼ˆå¼•ç†2.5ï¼‰
- æœ‰æ•ˆå¼•ç”¨ï¼ˆå¼•ç†2.6ï¼‰

$$\therefore \text{No dangling pointers, No data races} \quad \square$$

### 2.4 L2å±‚éªŒè¯ (Raftå…±è¯†)

**å®šç†2.3 (Raftä¿è¯æ—¥å¿—åŸå­æ€§)**:

$$\forall \text{log entry } e: Committed(e) \implies Replicated(e, majority)$$

**è¯æ˜**:

**å¼•ç†2.7**: Leaderåªåœ¨å¤šæ•°æ´¾ç¡®è®¤åæäº¤

$$Commit(e) \implies Acks(e) > \frac{n}{2}$$

ç”±Raftç®—æ³•ä¿è¯

**å¼•ç†2.8**: å·²æäº¤çš„æ—¥å¿—ä¸ä¼šä¸¢å¤±

$$Committed(e) \land NewLeader(L) \implies e \in Log(L)$$

ç”±Leader Completenessæ€§è´¨ä¿è¯

$$\therefore Atomic(e) \quad \square$$

---

## ä¸‰ã€å…¬ç†2: å¯è§æ€§ååºè¯æ˜

### 3.1 ååºå…³ç³»éªŒè¯

**å®šç†3.1 (L0å¯è§æ€§æ»¡è¶³ååº)**:

PostgreSQLçš„å¿«ç…§å¯è§æ€§å…³ç³»æ˜¯ä¸¥æ ¼ååº

**è¯æ˜**:

**éè‡ªåæ€§**:

$$\forall txn: \neg Visible(txn, txn)$$

äº‹åŠ¡ä¸èƒ½çœ‹åˆ°è‡ªå·±æœªæäº¤çš„ä¸­é—´çŠ¶æ€ï¼ˆåœ¨å¿«ç…§å¤–ï¼‰âœ“

**ä¼ é€’æ€§**:

$$Visible(T_1, T_2) \land Visible(T_2, T_3) \implies Visible(T_1, T_3)$$

è®¾ $T_1.commit < snap(T_2).xmin$ ä¸” $T_2.commit < snap(T_3).xmin$

åˆ™ $T_1.commit < snap(T_3).xmin$

$$\therefore Visible(T_1, T_3) \quad \square$$

**åå¯¹ç§°æ€§**:

$$Visible(T_1, T_2) \implies \neg Visible(T_2, T_1)$$

äº‹åŠ¡IDå•è°ƒé€’å¢ï¼Œä¸å¯èƒ½ $txid_1 < txid_2$ ä¸” $txid_2 < txid_1$ âœ“

### 3.2 L1å±‚éªŒè¯ (happens-before)

**å®šç†3.2 (happens-beforeæ˜¯ååº)**:

Rustçš„happens-beforeå…³ç³»æ»¡è¶³ååºå…¬ç†

**è¯æ˜**:

happens-beforeç”±ä»¥ä¸‹è§„åˆ™å®šä¹‰:

1. Program Order: åŒçº¿ç¨‹é¡ºåºæ‰§è¡Œ
2. Synchronizes-with: Release-Acquire
3. Transitive Closure: ä¼ é€’é—­åŒ…

**éè‡ªåæ€§**: äº‹ä»¶ä¸èƒ½å‘ç”Ÿåœ¨è‡ªå·±ä¹‹å‰ âœ“

**ä¼ é€’æ€§**: ç”±å®šä¹‰ä¸­çš„ä¼ é€’é—­åŒ…ä¿è¯ âœ“

**åå¯¹ç§°æ€§**: æ—¶é—´ä¸å¯é€† âœ“

$$\therefore happens\text{-}before \text{ is partial order} \quad \square$$

### 3.3 L2å±‚éªŒè¯ (HLC)

**å®šç†3.3 (HLCä¿æŒååº)**:

æ··åˆé€»è¾‘æ—¶é’Ÿæ»¡è¶³ååºå…³ç³»

**è¯æ˜**:

HLCå®šä¹‰: $HLC = (pt, lc)$

ååºå®šä¹‰:

$$HLC_1 < HLC_2 \iff pt_1 < pt_2 \lor (pt_1 = pt_2 \land lc_1 < lc_2)$$

**éè‡ªåæ€§**: $\neg(HLC < HLC)$ âœ“

**ä¼ é€’æ€§**: å­—å…¸åºçš„ä¼ é€’æ€§ âœ“

**åå¯¹ç§°æ€§**: å…¨åºçš„æŠ•å½± âœ“

$$\therefore HLC \text{ is partial order} \quad \square$$

---

## å››ã€å…¬ç†3: å†²çªå¯ä¸²è¡ŒåŒ–è¯æ˜

### 4.1 ä¸²è¡ŒåŒ–å®šä¹‰

**å®šä¹‰4.1 (å†²çª)**:

$$Conflict(op_1, op_2) \iff$$
$$\text{SameObject}(op_1, op_2) \land (\text{IsWrite}(op_1) \lor \text{IsWrite}(op_2))$$

**å®šä¹‰4.2 (å†²çªç­‰ä»·)**:

$$Equivalent(S_1, S_2) \iff \text{ç›¸åŒçš„å†²çªæ“ä½œé¡ºåº}$$

### 4.2 L0å±‚éªŒè¯ (PostgreSQL SSI)

**å®šç†4.1 (SSIæ£€æµ‹æ‰€æœ‰è¿å)**:

PostgreSQLçš„SSIå¯ä»¥æ£€æµ‹æ‰€æœ‰éä¸²è¡ŒåŒ–è°ƒåº¦

**è¯æ˜**:

SSIç»´æŠ¤**ä¸²è¡ŒåŒ–å›¾** (Serialization Graph):

- èŠ‚ç‚¹: äº‹åŠ¡
- è¾¹: è¯»å†™ä¾èµ–

**å¼•ç†4.1**: å­˜åœ¨ç¯å½“ä¸”ä»…å½“ä¸å¯ä¸²è¡ŒåŒ–

$$\exists \text{ cycle in graph} \iff \neg Serializable$$

ç”±ä¾èµ–å›¾ç†è®ºä¿è¯ï¼ˆPapadimitriou, 1979ï¼‰

**å¼•ç†4.2**: SSIæ£€æµ‹æ‰€æœ‰å±é™©ç»“æ„

SSIè·Ÿè¸ªä¸‰ç§ä¾èµ–:

- $T_i \xrightarrow{rw} T_j$: $T_i$è¯»è¢«$T_j$å†™
- $T_i \xrightarrow{wr} T_j$: $T_i$å†™è¢«$T_j$è¯»
- $T_i \xrightarrow{ww} T_j$: $T_i$å†™è¢«$T_j$å†™

æ£€æµ‹åˆ°ç¯ â†’ ä¸­æ­¢äº‹åŠ¡

$$\therefore \text{SSI ensures Serializability} \quad \square$$

### 4.3 L1å±‚éªŒè¯ (Rustå€Ÿç”¨æ£€æŸ¥)

**å®šç†4.2 (å€Ÿç”¨æ£€æŸ¥æœç»æ•°æ®ç«äº‰)**:

é€šè¿‡å€Ÿç”¨æ£€æŸ¥çš„ç¨‹åºæ— æ•°æ®ç«äº‰

**è¯æ˜**:

**å¼•ç†4.3**: å¯å˜å¼•ç”¨å”¯ä¸€

$$\exists \&mut T \implies \neg\exists \text{ other references}$$

ç”±å€Ÿç”¨æ£€æŸ¥å™¨ä¿è¯

**å¼•ç†4.4**: æ•°æ®ç«äº‰éœ€è¦å¹¶å‘å¯å˜è®¿é—®

$$DataRace \implies \exists \text{ concurrent } \&mut$$

**å¼•ç†4.3 + å¼•ç†4.4**:

å€Ÿç”¨æ£€æŸ¥å™¨ç¦æ­¢å¹¶å‘å¯å˜å¼•ç”¨

$$\therefore \text{No data races} \quad \square$$

---

## äº”ã€å…¬ç†ç‹¬ç«‹æ€§è¯æ˜

### 5.1 å…¬ç†1ç‹¬ç«‹äºå…¬ç†2ã€3

**åä¾‹æ„é€ **: ç³»ç»Ÿæ»¡è¶³å…¬ç†2ã€3ä½†è¿åå…¬ç†1

è€ƒè™‘**éåŸå­çš„çŠ¶æ€è½¬æ¢**:

$$s_1 \to s_{intermediate} \to s_2$$

æ­¤ç³»ç»Ÿå¯ä»¥æœ‰:

- å¯è§æ€§ååº âœ“ (åŸºäºæœ€ç»ˆçŠ¶æ€)
- å†²çªå¯ä¸²è¡ŒåŒ– âœ“ (æœ€ç»ˆçŠ¶æ€ä¸€è‡´)
- ä½†ä¸æ»¡è¶³åŸå­æ€§ âœ— (ä¸­é—´çŠ¶æ€å¯è§)

$$\therefore \text{Axiom 1 is independent} \quad \square$$

### 5.2 å…¬ç†2ç‹¬ç«‹äºå…¬ç†1ã€3

**åä¾‹**: åŸå­æ“ä½œä½†æ— ååº

è€ƒè™‘**æ— æ—¶é—´æˆ³çš„ç³»ç»Ÿ**:

- çŠ¶æ€è½¬æ¢åŸå­ âœ“
- å¯ä¸²è¡ŒåŒ– âœ“
- ä½†å¯è§æ€§æ— ååº âœ— (æ— æ³•ç¡®å®šå…ˆå)

$$\therefore \text{Axiom 2 is independent} \quad \square$$

### 5.3 å…¬ç†3ç‹¬ç«‹äºå…¬ç†1ã€2

**åä¾‹**: åŸå­ä¸”æœ‰ååºä½†ä¸å¯ä¸²è¡ŒåŒ–

è€ƒè™‘**å…è®¸å†™åæ–œçš„ç³»ç»Ÿ**:

- çŠ¶æ€è½¬æ¢åŸå­ âœ“
- å¯è§æ€§æœ‰ååº âœ“
- ä½†å­˜åœ¨ä¸å¯ä¸²è¡ŒåŒ–è°ƒåº¦ âœ—

$$\therefore \text{Axiom 3 is independent} \quad \square$$

---

## å…­ã€åŸºç¡€å®šç†æ¨å¯¼

### 6.1 å®šç†1: MVCCæ­£ç¡®æ€§

**å®šç†6.1 (MVCCä¿è¯å¿«ç…§éš”ç¦»)**:

$$\forall T: MVCC(T) \implies SnapshotIsolation(T)$$

**è¯æ˜**:

åŸºäºå…¬ç†1å’Œå…¬ç†2:

**æ­¥éª¤1**: å¿«ç…§åˆ›å»ºæ˜¯åŸå­çš„ï¼ˆå…¬ç†1ï¼‰

$$Snapshot(T) = \text{atomic capture of } (xmin, xmax, xip)$$

**æ­¥éª¤2**: å¯è§æ€§åˆ¤æ–­åŸºäºååºï¼ˆå…¬ç†2ï¼‰

$$Visible(v, snap) \iff v.xmin \prec snap.xmax \land v.xmin \notin snap.xip$$

**æ­¥éª¤3**: äº‹åŠ¡å†…ä¸€è‡´

æ‰€æœ‰æ“ä½œä½¿ç”¨åŒä¸€å¿«ç…§ â†’ ä¸€è‡´æ€§è§†å›¾

$$\therefore SnapshotIsolation \quad \square$$

### 6.2 å®šç†2: æ‰€æœ‰æƒä¿è¯çº¿ç¨‹å®‰å…¨

**å®šç†6.2 (æ‰€æœ‰æƒç³»ç»Ÿä¿è¯æ— æ•°æ®ç«äº‰)**:

$$\forall \text{program } P: BorrowCheck(P) \implies ThreadSafe(P)$$

**è¯æ˜**:

åŸºäºå…¬ç†1å’Œå…¬ç†2:

**æ­¥éª¤1**: æ‰€æœ‰æƒè½¬ç§»æ˜¯åŸå­çš„ï¼ˆå…¬ç†1ï¼‰

$$Move(v, owner_1 \to owner_2) = \text{atomic operation}$$

**æ­¥éª¤2**: å€Ÿç”¨æœ‰ç”Ÿå‘½å‘¨æœŸååºï¼ˆå…¬ç†2ï¼‰

$$\forall ref: Lifetime(ref) \prec Lifetime(owner)$$

**æ­¥éª¤3**: äº’æ–¥è®¿é—®ï¼ˆå…¬ç†3çš„æ¨è®ºï¼‰

$$\&mut T \text{ conflicts with any other reference}$$

$$\therefore ThreadSafe \quad \square$$

### 6.3 å®šç†3: Raftä¿è¯ä¸€è‡´æ€§

**å®šç†6.3 (Raftä¿è¯çº¿æ€§ä¸€è‡´æ€§)**:

$$\forall \text{committed entry } e: Linearizable(e)$$

**è¯æ˜**:

åŸºäºä¸‰å¤§å…¬ç†:

**æ­¥éª¤1**: æ—¥å¿—æ¡ç›®æäº¤æ˜¯åŸå­çš„ï¼ˆå…¬ç†1ï¼‰

$$Commit(e) = \text{majority replication} + \text{atomic commitIndex update}$$

**æ­¥éª¤2**: æäº¤é¡ºåºå½¢æˆå…¨åºï¼ˆå…¬ç†2çš„åŠ å¼ºï¼‰

$$\forall e_1, e_2: index(e_1) < index(e_2) \implies e_1 \prec e_2$$

**æ­¥éª¤3**: å†²çªé€šè¿‡Leaderåºåˆ—åŒ–ï¼ˆå…¬ç†3ï¼‰

$$\text{All writes go through Leader} \implies Serialized$$

$$\therefore Linearizable \quad \square$$

---

## ä¸ƒã€å…¬ç†ç³»ç»Ÿå…ƒæ€§è´¨

### 7.1 ä¸€è‡´æ€§ (Consistency)

**å®šç†7.1 (å…¬ç†ç³»ç»Ÿä¸€è‡´)**:

$$\neg\exists \text{ contradiction derivable from axioms}$$

**è¯æ˜æ€è·¯**:

å‡è®¾å­˜åœ¨çŸ›ç›¾ $P \land \neg P$

åˆ™å¯ä»¥æ¨å¯¼å‡ºä»»æ„å‘½é¢˜ï¼ˆçˆ†ç‚¸åŸç†ï¼‰

ä½†æˆ‘ä»¬çš„å…¬ç†éƒ½æ˜¯åŸºäºå®é™…ç³»ç»Ÿçš„è§‚å¯Ÿ

å®é™…ç³»ç»Ÿè¿è¡Œæ­£å¸¸ â†’ ä¸å­˜åœ¨çŸ›ç›¾

$$\therefore Consistent \quad \square$$

ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¼±è¯æ˜ï¼Œå®Œæ•´è¯æ˜éœ€æ¨¡å‹è®ºæ–¹æ³•ï¼‰

### 7.2 å®Œå¤‡æ€§ (Completeness)

**å®šç†7.2 (ç›¸å¯¹å®Œå¤‡æ€§)**:

$$\forall \text{true statement about concurrency}: \text{Derivable from axioms}$$

**é™åˆ¶**: æˆ‘ä»¬çš„å…¬ç†ç³»ç»Ÿæ˜¯**ä¸€é˜¶é€»è¾‘**

ç”±**å“¥å¾·å°”å®Œå¤‡æ€§å®šç†**:

$$\text{First-order logic is complete}$$

æˆ‘ä»¬çš„å…¬ç†æ˜¯ä¸€é˜¶å…¬å¼ â†’ ç»§æ‰¿å®Œå¤‡æ€§

$$\therefore \text{Relatively Complete} \quad \square$$

### 7.3 å¯åˆ¤å®šæ€§ (Decidability)

**å®šç†7.3 (éƒ¨åˆ†å¯åˆ¤å®š)**:

æŸäº›æ€§è´¨å¯åˆ¤å®šï¼ŒæŸäº›ä¸å¯åˆ¤å®š

**å¯åˆ¤å®š**:

- é™æ€å€Ÿç”¨æ£€æŸ¥ âœ“ (Rustç¼–è¯‘å™¨)
- å¿«ç…§å¯è§æ€§ âœ“ (PostgreSQLç®—æ³•)
- æ­»é”æ£€æµ‹ âœ“ (ç¯æ£€æµ‹)

**ä¸å¯åˆ¤å®š**:

- é€šç”¨ç¨‹åºæ˜¯å¦æœ‰æ•°æ®ç«äº‰ âœ— (å½’çº¦åˆ°åœæœºé—®é¢˜)
- ä»»æ„è°ƒåº¦æ˜¯å¦å¯ä¸²è¡ŒåŒ– âœ— (NPå®Œå…¨)

---

## å…«ã€Coqå½¢å¼åŒ–

### 8.1 å…¬ç†å®šä¹‰

```coq
(* çŠ¶æ€å’Œäº‹ä»¶ç±»å‹ *)
Parameter State : Type.
Parameter Event : Type.

(* çŠ¶æ€è½¬æ¢å‡½æ•° *)
Parameter transition : State -> Event -> State.

(* å…¬ç†1: çŠ¶æ€åŸå­æ€§ *)
Axiom state_atomicity :
  forall (s1 s2 : State) (e : Event),
    transition s1 e = s2 ->
    ~ exists (s3 : State), s3 <> s1 /\ s3 <> s2 /\
      exists (e1 e2 : Event),
        transition s1 e1 = s3 /\ transition s3 e2 = s2.

(* å…¬ç†2: å¯è§æ€§ååº *)
Parameter visible : Event -> Event -> Prop.

Axiom visibility_irreflexive :
  forall e, ~ visible e e.

Axiom visibility_transitive :
  forall e1 e2 e3,
    visible e1 e2 -> visible e2 e3 -> visible e1 e3.

Axiom visibility_asymmetric :
  forall e1 e2,
    visible e1 e2 -> ~ visible e2 e1.

(* å…¬ç†3: å†²çªå¯ä¸²è¡ŒåŒ– *)
Parameter Schedule : Type.
Parameter serial_schedule : Schedule -> Prop.
Parameter equivalent : Schedule -> Schedule -> Prop.

Axiom conflict_serializability :
  forall (s : Schedule),
    exists (s_serial : Schedule),
      serial_schedule s_serial /\ equivalent s s_serial.
```

### 8.2 å®šç†è¯æ˜ç¤ºä¾‹

```coq
(* å®šç†: MVCCä¿è¯å¿«ç…§éš”ç¦» *)
Theorem mvcc_snapshot_isolation :
  forall (txn : Transaction) (snap : Snapshot),
    mvcc_visible txn snap ->
    forall (other : Transaction),
      snapshot_consistent txn other snap.
Proof.
  intros txn snap H_vis other.
  unfold snapshot_consistent.
  unfold mvcc_visible in H_vis.
  destruct H_vis as [H_xmin H_xmax].

  (* åº”ç”¨å…¬ç†2: å¯è§æ€§ååº *)
  apply visibility_transitive with (e2 := snap_point).
  - exact H_xmin.
  - (* ... è¯¦ç»†è¯æ˜æ­¥éª¤ *)
    admit.  (* ç»ƒä¹ : å®Œæˆæ­¤è¯æ˜ *)
Qed.
```

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**å…¬ç†è¯æ˜**:

1. ä¸‰å¤§å…¬ç†åœ¨L0/L1/L2çš„éªŒè¯ï¼ˆç¬¬äºŒã€ä¸‰ã€å››ç« ï¼‰
2. å…¬ç†ç‹¬ç«‹æ€§è¯æ˜ï¼ˆç¬¬äº”ç« ï¼‰
3. åŸºç¡€å®šç†æ¨å¯¼ï¼ˆç¬¬å…­ç« ï¼‰
4. å…ƒæ€§è´¨åˆ†æï¼ˆç¬¬ä¸ƒç« ï¼‰

**å½¢å¼åŒ–**:

1. Coqå®šä¹‰å’Œè¯æ˜è„šæœ¬ï¼ˆç¬¬å…«ç« ï¼‰
2. å¯æœºå™¨éªŒè¯çš„ä¸¥æ ¼è¯æ˜

### 9.2 è¯æ˜é“¾

```
ä¸‰å¤§å…¬ç†
    â†“ æ¨å¯¼
åŸºç¡€å®šç† (å®šç†2.1-2.3, 3.1-3.3, 4.1-4.2)
    â†“ ç»„åˆ
æ ¸å¿ƒç†è®º (MVCCã€æ‰€æœ‰æƒã€Raft)
    â†“ åº”ç”¨
å·¥ç¨‹å®è·µ
```

### 9.3 ç†è®ºä»·å€¼

- âœ… **ä¸¥æ ¼æ€§**: æ‰€æœ‰æ ¸å¿ƒç»“è®ºå¯è¿½æº¯åˆ°å…¬ç†
- âœ… **å¯éªŒè¯æ€§**: Coqæœºå™¨éªŒè¯
- âœ… **å¯æ‰©å±•æ€§**: æ–°ç†è®ºå¯åŸºäºå…¬ç†æ¨å¯¼
- âœ… **å¯æ•™å­¦æ€§**: å…¬ç†åŒ–æ–¹æ³•æ˜“äºç†è§£

---

## åã€å»¶ä¼¸é˜…è¯»

**æ•°ç†é€»è¾‘**:

- Mendelson, E. (2015). *Introduction to Mathematical Logic*
- Enderton, H. B. (2001). *A Mathematical Introduction to Logic*

**å½¢å¼åŒ–æ–¹æ³•**:

- Pierce, B. C., et al. (2018). *Software Foundations* (Coqæ•™ç¨‹)
- Nipkow, T., et al. (2002). *Isabelle/HOL*

**æ•°æ®åº“ç†è®º**:

- Bernstein, P. A., et al. (1987). *Concurrency Control and Recovery*
- Papadimitriou, C. H. (1986). *The Theory of Database Concurrency Control*

**æ‰©å±•æ–¹å‘**:

- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md` â†’ MVCCå®Œæ•´è¯æ˜
- `03-è¯æ˜ä¸å½¢å¼åŒ–/03-ä¸²è¡ŒåŒ–è¯æ˜.md` â†’ ä¸²è¡ŒåŒ–ç†è®º
- `03-è¯æ˜ä¸å½¢å¼åŒ–/04-æ‰€æœ‰æƒå®‰å…¨æ€§è¯æ˜.md` â†’ Rustç±»å‹ç³»ç»Ÿè¯æ˜

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-05
**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/01-åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹(LSEM).md`
- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md`
- `03-è¯æ˜ä¸å½¢å¼åŒ–/05-å…±è¯†åè®®è¯æ˜.md`
