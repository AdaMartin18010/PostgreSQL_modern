# 05 | å…±è¯†åè®®è¯æ˜

> **è¯æ˜å®šä½**: æœ¬æ–‡æ¡£æä¾›Raftå…±è¯†åè®®çš„å®Œæ•´æ­£ç¡®æ€§è¯æ˜ï¼ŒåŒ…æ‹¬å®‰å…¨æ€§ã€æ´»æ€§ã€åä¾‹åˆ†æã€‚

---

## ğŸ“‘ ç›®å½•

- [05 | å…±è¯†åè®®è¯æ˜](#05--å…±è¯†åè®®è¯æ˜)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€Raftå®‰å…¨æ€§è¯æ˜](#ä¸€raftå®‰å…¨æ€§è¯æ˜)
    - [1.1 é€‰ä¸¾å®‰å…¨æ€§ï¼ˆè¯¦ç»†è¯æ˜ï¼‰](#11-é€‰ä¸¾å®‰å…¨æ€§è¯¦ç»†è¯æ˜)
    - [1.2 æ—¥å¿—åŒ¹é…æ€§è´¨](#12-æ—¥å¿—åŒ¹é…æ€§è´¨)
  - [äºŒã€Leader Completenessè¯æ˜](#äºŒleader-completenessè¯æ˜)
    - [2.1 å®Œæ•´è¯æ˜ï¼ˆåè¯æ³•ï¼‰](#21-å®Œæ•´è¯æ˜åè¯æ³•)
    - [2.2 åä¾‹ï¼šå¦‚æœæ²¡æœ‰æ—¥å¿—æ–°æ—§æ£€æŸ¥](#22-åä¾‹å¦‚æœæ²¡æœ‰æ—¥å¿—æ–°æ—§æ£€æŸ¥)
  - [ä¸‰ã€State Machine Safetyè¯æ˜](#ä¸‰state-machine-safetyè¯æ˜)
    - [3.1 è¯¦ç»†è¯æ˜](#31-è¯¦ç»†è¯æ˜)
    - [3.2 åä¾‹ï¼šæ—¥å¿—ä¸åŒ¹é…çš„åæœ](#32-åä¾‹æ—¥å¿—ä¸åŒ¹é…çš„åæœ)
  - [å››ã€æ´»æ€§è¯æ˜](#å››æ´»æ€§è¯æ˜)
    - [4.1 Leaderé€‰ä¸¾æ´»æ€§ï¼ˆè¯¦ç»†è¯æ˜ï¼‰](#41-leaderé€‰ä¸¾æ´»æ€§è¯¦ç»†è¯æ˜)
    - [4.2 åä¾‹ï¼šå›ºå®šè¶…æ—¶çš„é—®é¢˜](#42-åä¾‹å›ºå®šè¶…æ—¶çš„é—®é¢˜)
    - [4.3 ç½‘ç»œåˆ†åŒºä¸‹çš„æ´»æ€§](#43-ç½‘ç»œåˆ†åŒºä¸‹çš„æ´»æ€§)
  - [äº”ã€åä¾‹ä¸è¾¹ç•Œæ¡ä»¶](#äº”åä¾‹ä¸è¾¹ç•Œæ¡ä»¶)
    - [5.1 åä¾‹ï¼šRaftä¸ä¿è¯ä»€ä¹ˆ](#51-åä¾‹raftä¸ä¿è¯ä»€ä¹ˆ)
    - [5.2 è¾¹ç•Œæ¡ä»¶åˆ†æ](#52-è¾¹ç•Œæ¡ä»¶åˆ†æ)
  - [å…­ã€æ‹œå åº­å®¹é”™åè¯](#å…­æ‹œå åº­å®¹é”™åè¯)
    - [6.1 Raftä¸èƒ½å®¹å¿æ‹œå åº­æ•…éšœ](#61-raftä¸èƒ½å®¹å¿æ‹œå åº­æ•…éšœ)
  - [ä¸ƒã€æ€»ç»“](#ä¸ƒæ€»ç»“)
    - [7.1 æ ¸å¿ƒå®šç†æ€»è§ˆ](#71-æ ¸å¿ƒå®šç†æ€»è§ˆ)
    - [7.2 åä¾‹æ€»ç»“](#72-åä¾‹æ€»ç»“)
    - [7.3 å½¢å¼åŒ–æ€»ç»“ï¼ˆTLA+ç‰‡æ®µï¼‰](#73-å½¢å¼åŒ–æ€»ç»“tlaç‰‡æ®µ)

---

## ä¸€ã€Raftå®‰å…¨æ€§è¯æ˜

### 1.1 é€‰ä¸¾å®‰å…¨æ€§ï¼ˆè¯¦ç»†è¯æ˜ï¼‰

**å®šç†1.1 (é€‰ä¸¾å®‰å…¨æ€§)**:

\[
\forall term: |\{L | L \text{ is leader in } term\}| \leq 1
\]

**è¯æ˜ï¼ˆåè¯æ³•ï¼‰**:

å‡è®¾åœ¨åŒä¸€termå†…å­˜åœ¨ä¸¤ä¸ªLeader: \(L_1\) å’Œ \(L_2\)

åˆ™:
\begin{align*}
Votes(L_1) &> \frac{n}{2} \\
Votes(L_2) &> \frac{n}{2}
\end{align*}

æ¨å¯¼:
\begin{align*}
Votes(L_1) + Votes(L_2) &> \frac{n}{2} + \frac{n}{2} = n
\end{align*}

ä½†æ˜¯:

- æ¯ä¸ªèŠ‚ç‚¹åœ¨ä¸€ä¸ªtermåªèƒ½æŠ•ä¸€ç¥¨
- æ€»ç¥¨æ•° = \(n\)
- å› æ­¤ \(Votes(L_1) + Votes(L_2) \leq n\)

**çŸ›ç›¾**!

\[
\therefore \text{ä¸å¯èƒ½å­˜åœ¨ä¸¤ä¸ªLeader} \quad \blacksquare
\]

**åä¾‹åˆ†æ**: å¦‚æœå…è®¸ä¸€ä¸ªèŠ‚ç‚¹æŠ•å¤šç¥¨ä¼šæ€æ ·ï¼Ÿ

```text
åä¾‹åœºæ™¯:
â”œâ”€ èŠ‚ç‚¹æ•°: 5
â”œâ”€ å…è®¸æ¯èŠ‚ç‚¹æŠ•2ç¥¨
â”œâ”€ L1è·å¾—: {N1, N2, N3} = 6ç¥¨ (æ¯èŠ‚ç‚¹2ç¥¨)
â”œâ”€ L2è·å¾—: {N3, N4, N5} = 6ç¥¨
â””â”€ ä¸¤ä¸ªLeaderåŒæ—¶å­˜åœ¨ï¼ï¼ˆè„‘è£‚ï¼‰

åæœ:
â”œâ”€ ä¸¤ä¸ªLeaderåŒæ—¶å†™å…¥
â”œâ”€ æ—¥å¿—åˆ†å‰
â”œâ”€ çŠ¶æ€ä¸ä¸€è‡´
â””â”€ ç³»ç»Ÿå´©æºƒ

ç»“è®º: "æ¯termæ¯èŠ‚ç‚¹åªèƒ½æŠ•ä¸€ç¥¨"æ˜¯å¿…è¦çš„
```

### 1.2 æ—¥å¿—åŒ¹é…æ€§è´¨

**æ€§è´¨1.2 (Log Matching)**:

\[
\forall i, j, k: (Log_i[k].term = Log_j[k].term) \implies Log_i[1:k] = Log_j[1:k]
\]

**è¯æ˜ï¼ˆå½’çº³æ³•ï¼‰**:

**Base case** (\(k=1\)):

æ—¥å¿—ç¬¬ä¸€ä¸ªæ¡ç›®å¦‚æœtermç›¸åŒï¼Œåˆ™å¿…ç„¶ç›¸åŒï¼ˆLeaderåœ¨ä¸€ä¸ªtermåªåˆ›å»ºä¸€æ¬¡æ—¥å¿—æ¡ç›®ï¼‰

\[
\therefore Log_i[1] = Log_j[1] \quad \checkmark
\]

**Inductive step**:

å‡è®¾ \(Log_i[1:k-1] = Log_j[1:k-1]\) å·²æˆç«‹

è‹¥ \(Log_i[k].term = Log_j[k].term = t\)

åˆ™:

1. è¯¥æ¡ç›®ç”±term \(t\)çš„Leaderåˆ›å»º
2. Leaderåœ¨åˆ›å»ºLog[k]æ—¶æ£€æŸ¥Log[k-1]åŒ¹é…
3. AppendEntries RPCçš„prevLogIndexå’ŒprevLogTermä¿è¯ä¸€è‡´æ€§

\[
\therefore Log_i[k-1] = Log_j[k-1]
\]

ç»“åˆå½’çº³å‡è®¾:

\[
\therefore Log_i[1:k] = Log_j[1:k] \quad \blacksquare
\]

**åä¾‹**: å¦‚æœä¸æ£€æŸ¥prevLogIndexä¼šæ€æ ·ï¼Ÿ

```text
åä¾‹åœºæ™¯ï¼ˆæ— Log Matchingæ£€æŸ¥ï¼‰:
T1: L1åˆ›å»ºLog[5] (term=3)
T2: ç½‘ç»œåˆ†åŒºï¼ŒL2å½“é€‰ (term=4)
T3: L2åˆ›å»ºLog[5] (term=4)
T4: L1çš„Log[5]å’ŒL2çš„Log[5]ä¸åŒï¼Œä½†ä½ç½®ç›¸åŒ

åæœ:
â”œâ”€ çŠ¶æ€æœºåœ¨ç´¢å¼•5åº”ç”¨ä¸åŒå‘½ä»¤
â”œâ”€ å‰¯æœ¬ä¹‹é—´çŠ¶æ€ä¸ä¸€è‡´
â””â”€ è¿åä¸€è‡´æ€§

Raftè§£å†³:
AppendEntriesæ£€æŸ¥: prevLogIndex=4, prevLogTerm=3
å¦‚æœä¸åŒ¹é…ï¼Œæ‹’ç»è¿½åŠ  âœ“
```

---

## äºŒã€Leader Completenessè¯æ˜

### 2.1 å®Œæ•´è¯æ˜ï¼ˆåè¯æ³•ï¼‰

**å®šç†2.1 (Leader Completeness)**:

\[
\forall e: Committed(e, term_c) \implies \forall L_{term>term_c}: e \in Log(L)
\]

**è¯æ˜ï¼ˆåè¯æ³•+æ•°å­¦å½’çº³ï¼‰**:

å‡è®¾å­˜åœ¨å·²æäº¤æ¡ç›®\(e\)ï¼ˆåœ¨term \(term_c\)æäº¤ï¼‰ï¼Œä½†æŸä¸ªterm \(term_{new} > term_c\)çš„Leader \(L_{new}\)ä¸åŒ…å«\(e\)

**åˆ†ææäº¤æ¡ä»¶**:

æ¡ç›®\(e\)è¢«æäº¤æ„å‘³ç€:
\[
|\{S | e \in Log(S)\}| > \frac{n}{2}
\]

å³å¤šæ•°æ´¾èŠ‚ç‚¹åŒ…å«\(e\)

**åˆ†æé€‰ä¸¾æ¡ä»¶**:

\(L_{new}\)å½“é€‰éœ€è¦:
\[
|\{V | V \text{ voted for } L_{new}\}| > \frac{n}{2}
\]

**å…³é”®æ¨ç†**:

ä¸¤ä¸ªå¤šæ•°æ´¾å¿…æœ‰äº¤é›†:

\[
|\{S | e \in Log(S)\}| \cap |\{V\}| \geq 1
\]

è®¾äº¤é›†èŠ‚ç‚¹ä¸º\(N_{common}\)

åˆ™:

- \(N_{common}\)åŒ…å«\(e\)
- \(N_{common}\)æŠ•ç¥¨ç»™\(L_{new}\)

**Rafté€‰ä¸¾è§„åˆ™**: æŠ•ç¥¨å‰æ£€æŸ¥æ—¥å¿—æ–°æ—§

\[
UpToDate(L_{new}, N_{common}) = \begin{cases}
L_{new}.lastTerm > N_{common}.lastTerm \lor \\
(L_{new}.lastTerm = N_{common}.lastTerm \land L_{new}.lastIndex \geq N_{common}.lastIndex)
\end{cases}
\]

è‹¥\(L_{new}\)æ—¥å¿—æ›´æ–°ï¼Œåˆ™å¿…ç„¶åŒ…å«\(e\)ï¼ˆçŸ›ç›¾åŸå‡è®¾ï¼‰

è‹¥\(L_{new}\)æ—¥å¿—ä¸å¤Ÿæ–°ï¼Œåˆ™\(N_{common}\)ä¸ä¼šæŠ•ç¥¨ï¼ˆçŸ›ç›¾"è·å¾—æŠ•ç¥¨"ï¼‰

**çŸ›ç›¾**ï¼

\[
\therefore \text{Leader Completenessæˆç«‹} \quad \blacksquare
\]

### 2.2 åä¾‹ï¼šå¦‚æœæ²¡æœ‰æ—¥å¿—æ–°æ—§æ£€æŸ¥

**åä¾‹åœºæ™¯**:

```text
æ—¶é—´çº¿:
T1: L1 (term=1)åˆ›å»ºå¹¶æäº¤entry e @ index 10
    å¤åˆ¶åˆ°: {N1, N2, N3} (å¤šæ•°æ´¾)

T2: L1å´©æºƒï¼Œç½‘ç»œåˆ†åŒº: {N4, N5}ä¸{N1,N2,N3}éš”ç¦»

T3: N4è¶…æ—¶ï¼Œå‘èµ·é€‰ä¸¾ (term=2)
    æ²¡æœ‰æ—¥å¿—æ–°æ—§æ£€æŸ¥ â†’ N5æŠ•ç¥¨
    N4å½“é€‰Leader (è·å¾—N4, N5çš„2ç¥¨ï¼Œä½†ä¸æ˜¯å¤šæ•°æ´¾)

é”™è¯¯: N4æ—¥å¿—ä¸åŒ…å«entry eï¼Œä½†è‡ªè®¤ä¸ºæ˜¯Leader

T4: ç½‘ç»œæ¢å¤
    N4å’ŒL1éƒ½è®¤ä¸ºè‡ªå·±æ˜¯Leaderï¼ˆè„‘è£‚ï¼ï¼‰

åæœ:
â”œâ”€ ä¸¤ä¸ªLeaderå¹¶å­˜
â”œâ”€ N4è¦†ç›–entry e
â”œâ”€ æ•°æ®ä¸¢å¤±
â””â”€ ç³»ç»Ÿå´©æºƒ

Rafté˜²æŠ¤:
RequestVote RPCæ‹’ç»æ—¥å¿—è¿‡æ—§çš„å€™é€‰äºº
N5æ£€æµ‹åˆ°N4æ—¥å¿—ç¼ºå°‘entry e â†’ æ‹’ç»æŠ•ç¥¨ âœ“
```

---

## ä¸‰ã€State Machine Safetyè¯æ˜

### 3.1 è¯¦ç»†è¯æ˜

**å®šç†3.1 (çŠ¶æ€æœºå®‰å…¨)**:

\[
\forall i, j, k: (AppliedIndex_i = AppliedIndex_j = k) \implies (StateMachine_i = StateMachine_j)
\]

**è¯æ˜ï¼ˆå½’çº³æ³•ï¼‰**:

**Base case** (\(k=0\)): åˆå§‹çŠ¶æ€ç›¸åŒ

\[
StateMachine_i = StateMachine_j = \emptyset \quad \checkmark
\]

**Inductive step**:

å‡è®¾\(k-1\)æ—¶çŠ¶æ€ç›¸åŒ

è¯æ˜åº”ç”¨Log[k]åçŠ¶æ€ä»ç›¸åŒ

ç”±Log Matchingï¼ˆæ€§è´¨1.2ï¼‰:
\[
Log_i[k] = Log_j[k]
\]

çŠ¶æ€æœºè½¬ç§»å‡½æ•°\(F\)æ˜¯ç¡®å®šæ€§çš„:
\[
StateMachine' = F(StateMachine, Log[k])
\]

å› æ­¤:
\begin{align*}
StateMachine_i' &= F(StateMachine_i, Log_i[k]) \\
                &= F(StateMachine_j, Log_j[k]) \quad (\text{å½’çº³å‡è®¾+Log Matching}) \\
                &= StateMachine_j'
\end{align*}

\[
\therefore \text{State Machine Safety} \quad \blacksquare
\]

### 3.2 åä¾‹ï¼šæ—¥å¿—ä¸åŒ¹é…çš„åæœ

**æ„é€ åä¾‹**ï¼ˆè¿åLog Matchingï¼‰:

```text
å‡è®¾: å…è®¸ç›¸åŒç´¢å¼•ä¸åŒå†…å®¹

èŠ‚ç‚¹çŠ¶æ€:
N1: Log[5] = "SET x=1"
N2: Log[5] = "SET x=2"  (ä¸åŒ!)

éƒ½åº”ç”¨åˆ°index 5:
â”œâ”€ N1: x=1
â”œâ”€ N2: x=2
â””â”€ çŠ¶æ€ä¸ä¸€è‡´ï¼

æŸ¥è¯¢ç»“æœ:
â”œâ”€ å®¢æˆ·ç«¯æŸ¥N1: x=1
â”œâ”€ å®¢æˆ·ç«¯æŸ¥N2: x=2
â””â”€ åŒä¸€ä¸ªç³»ç»Ÿè¿”å›ä¸åŒç»“æœï¼ˆè¿åä¸€è‡´æ€§ï¼‰

å®é™…æ¡ˆä¾‹:
æŸé“¶è¡Œä½¿ç”¨è‡ªç ”å…±è¯†åè®®ï¼Œæœªä¸¥æ ¼å®ç°Log Matching
â†’ ä¸»å¤‡æ•°æ®ä¸ä¸€è‡´
â†’ è´¦æˆ·ä½™é¢åœ¨ä¸åŒå‰¯æœ¬ä¸åŒ
â†’ å®¡è®¡å¤±è´¥ï¼Œç›‘ç®¡å¤„ç½š
```

---

## å››ã€æ´»æ€§è¯æ˜

### 4.1 Leaderé€‰ä¸¾æ´»æ€§ï¼ˆè¯¦ç»†è¯æ˜ï¼‰

**å®šç†4.1 (Leader Election Liveness)**:

åœ¨æœ€ç»ˆåŒæ­¥ç½‘ç»œä¸­ï¼Œå¦‚æœä¸å­˜åœ¨Leaderï¼Œç³»ç»Ÿæœ€ç»ˆä¼šé€‰å‡ºLeader

**è¯æ˜**:

**å‡è®¾**:

- ç½‘ç»œæœ€ç»ˆåŒæ­¥ï¼ˆæ¶ˆæ¯æœ€ç»ˆé€è¾¾ï¼‰
- èŠ‚ç‚¹ä½¿ç”¨éšæœºelection timeout: \([T, 2T]\)

**åˆ†æ**:

æ— Leaderæ—¶:

1. æ‰€æœ‰Followerè¶…æ—¶è®¡æ—¶å™¨è¿è¡Œ
2. æŸä¸ªèŠ‚ç‚¹\(N_i\)çš„timeoutå…ˆåˆ°è¾¾ï¼ˆæ¦‚ç‡>0ï¼‰
3. \(N_i\)è½¬ä¸ºCandidateï¼Œterm+1ï¼Œå‘RequestVote
4. å¦‚æœ\(N_i\)æ—¥å¿—è¶³å¤Ÿæ–°ï¼Œè·å¾—å¤šæ•°æ´¾æŠ•ç¥¨
5. \(N_i\)æˆä¸ºLeader

**å…³é”®**: éšæœºè¶…æ—¶é¿å…å†²çª

**æ¦‚ç‡åˆ†æ**:

\(P(\text{èŠ‚ç‚¹}i\text{å…ˆè¶…æ—¶}) = \frac{1}{n}\)

\(P(\text{é€‰ä¸¾æˆåŠŸ}) = P(\text{å…ˆè¶…æ—¶}) \times P(\text{æ—¥å¿—å¤Ÿæ–°}) \times P(\text{è·å¾—å¤šæ•°æ´¾})\)

åœ¨æœ€ç»ˆåŒæ­¥ç½‘ç»œä¸­:

- \(P(\text{è·å¾—å¤šæ•°æ´¾}) \to 1\) (æ¶ˆæ¯æœ€ç»ˆé€è¾¾)

å› æ­¤:
\[
P(\text{æœ€ç»ˆé€‰å‡ºLeader}) = 1 \quad \blacksquare
\]

### 4.2 åä¾‹ï¼šå›ºå®šè¶…æ—¶çš„é—®é¢˜

**åä¾‹åœºæ™¯**ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ç›¸åŒè¶…æ—¶ï¼‰:

```text
é…ç½®: election_timeout = 150ms (å›ºå®š)

æ—¶é—´çº¿:
T1: æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶è¶…æ—¶
T2: æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å‘èµ·é€‰ä¸¾ (term=2)
T3: æ‰€æœ‰èŠ‚ç‚¹æŠ•ç¥¨ç»™è‡ªå·±
T4: æ— èŠ‚ç‚¹è·å¾—å¤šæ•°æ´¾ï¼ˆæ¯ä¸ªåªæœ‰1ç¥¨ï¼‰
T5: é€‰ä¸¾å¤±è´¥ï¼Œé‡æ–°è¶…æ—¶
T6: é‡å¤T1-T5... (æ´»é”!)

ç»“æœ: æ°¸è¿œé€‰ä¸å‡ºLeader

å®é™…æ¡ˆä¾‹:
æŸå…¬å¸é…ç½®3èŠ‚ç‚¹etcdé›†ç¾¤ï¼Œè¯¯è®¾ç›¸åŒè¶…æ—¶
â†’ é€‰ä¸¾é£æš´ï¼ˆåå¤å¤±è´¥ï¼‰
â†’ æœåŠ¡ä¸å¯ç”¨30åˆ†é’Ÿ
â†’ ç›´åˆ°æ‰‹åŠ¨é‡å¯é”™å¼€æ—¶é—´

Raftè§£å†³:
éšæœºè¶…æ—¶: [150ms, 300ms]
â†’ èŠ‚ç‚¹é”™å¼€ï¼Œé¿å…å†²çª
â†’ é€‰ä¸¾æˆåŠŸç‡>95%
```

### 4.3 ç½‘ç»œåˆ†åŒºä¸‹çš„æ´»æ€§

**å®šç†4.2 (åˆ†åŒºå®¹é”™)**:

åœ¨ç½‘ç»œåˆ†åŒºä¸‹ï¼Œå¤šæ•°æ´¾åˆ†åŒºä¿æŒå¯ç”¨æ€§

**è¯æ˜**:

è®¾ç½‘ç»œåˆ†ä¸ºä¸¤ä¸ªåˆ†åŒº: \(P_1\) (åŒ…å«\(n_1\)ä¸ªèŠ‚ç‚¹), \(P_2\) (åŒ…å«\(n_2\)ä¸ªèŠ‚ç‚¹)

å…¶ä¸­ \(n_1 + n_2 = n\), \(n_1 > \frac{n}{2}\) (å¤šæ•°æ´¾åˆ†åŒº)

åˆ†æ:

- \(P_1\)å¯ä»¥é€‰ä¸¾Leaderï¼ˆå¤šæ•°æ´¾åœ¨\(P_1\)å†…ï¼‰
- \(P_1\)å¯ä»¥æäº¤æ¡ç›®ï¼ˆå¤šæ•°æ´¾ç¡®è®¤ï¼‰
- \(P_2\)æ— æ³•é€‰ä¸¾ï¼ˆå°‘æ•°æ´¾ï¼‰
- \(P_2\)å˜ä¸ºåªè¯»

\[
\therefore P_1\text{ä¿æŒå¯ç”¨æ€§} \quad \blacksquare
\]

**åä¾‹**: å°‘æ•°æ´¾åˆ†åŒºä¼šæ€æ ·ï¼Ÿ

```text
åˆ†åŒº: {N1, N2} vs {N3, N4, N5}

å°‘æ•°æ´¾{N1, N2}:
â”œâ”€ æ— æ³•é€‰ä¸¾Leader (2ç¥¨ < 3ç¥¨)
â”œâ”€ å¦‚æœN1æ˜¯è€Leaderï¼Œæ— æ³•æäº¤æ–°æ¡ç›®
â”œâ”€ åªèƒ½æä¾›åªè¯»æœåŠ¡ï¼ˆstale readï¼‰
â””â”€ ç½‘ç»œæ¢å¤åè¿½èµ¶æ—¥å¿—

å¤šæ•°æ´¾{N3, N4, N5}:
â”œâ”€ å¯ä»¥é€‰ä¸¾æ–°Leader
â”œâ”€ å¯ä»¥æäº¤æ–°æ¡ç›®
â””â”€ æ­£å¸¸æœåŠ¡ âœ“

è¿™æ˜¯CPç³»ç»Ÿçš„æƒè¡¡:
ä¸€è‡´æ€§ âœ“ (å°‘æ•°æ´¾ä¸æä¾›æœåŠ¡)
å¯ç”¨æ€§ ~ (ä»…å¤šæ•°æ´¾å¯ç”¨)
```

---

## äº”ã€åä¾‹ä¸è¾¹ç•Œæ¡ä»¶

### 5.1 åä¾‹ï¼šRaftä¸ä¿è¯ä»€ä¹ˆ

**åä¾‹1: Raftä¸ä¿è¯çº¿æ€§åŒ–è¯»**

```text
åœºæ™¯:
T1: å®¢æˆ·ç«¯å†™å…¥x=1åˆ°Leader
T2: Leaderå·²æäº¤ä½†æœªåº”ç”¨åˆ°çŠ¶æ€æœº
T3: å®¢æˆ·ç«¯ä»Followerè¯»å–x
T4: Followerè¿˜æ˜¯æ—§å€¼x=0

é—®é¢˜: åˆšå†™å…¥çš„å€¼è¯»ä¸åˆ°ï¼(è¿åçº¿æ€§åŒ–)

åŸå› : Followerçš„appliedIndexæ»å

è§£å†³æ–¹æ¡ˆ:
1. ReadIndex: Leaderç¡®è®¤è‡ªå·±ä»æ˜¯Leaderåï¼Œç­‰å¾…appliedIndexè¿½ä¸Š
2. Lease Read: Leaderåœ¨leaseæœŸå†…ç›´æ¥è¯»ï¼ˆé£é™©clock skewï¼‰
3. å¼ºåˆ¶ä»Leaderè¯»å–

RaftåŸºç¡€åè®®åªä¿è¯:
âœ“ ä¸²è¡ŒåŒ– (Serializable)
âœ— çº¿æ€§åŒ– (Linearizable)

éœ€è¦é¢å¤–æœºåˆ¶å®ç°çº¿æ€§åŒ–è¯»
```

**åä¾‹2: å¯¹ç§°ç½‘ç»œåˆ†åŒº**

```text
åœºæ™¯: 5èŠ‚ç‚¹é›†ç¾¤ï¼Œå¯¹ç§°åˆ†åŒº

åˆ†åŒº: {N1, N2} | {N3, N4, N5}

é—®é¢˜: å°‘æ•°æ´¾{N1, N2}ä¸­çš„Leaderä¼šæ€æ ·ï¼Ÿ

æ—¶é—´çº¿:
T1: N1æ˜¯term=5çš„Leader
T2: ç½‘ç»œåˆ†åŒº
T3: N1æ— æ³•è”ç³»å¤šæ•°æ´¾
T4: N1æ— æ³•æäº¤æ–°æ¡ç›®ï¼ˆå¿ƒè·³å¤±è´¥ï¼‰
T5: N1æœ€ç»ˆstep downï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰

T6: {N3, N4, N5}é€‰ä¸¾å‡ºN3ä¸ºæ–°Leader (term=6)

ç½‘ç»œæ¢å¤å:
â”œâ”€ N1å‘ç°term=6 > 5
â”œâ”€ N1è‡ªåŠ¨è½¬ä¸ºFollower
â”œâ”€ N1å›æ»šæœªæäº¤æ¡ç›®
â””â”€ ä»N3åŒæ­¥æ—¥å¿—

å…³é”®: Leaderæ— æ³•è”ç³»å¤šæ•°æ´¾æ—¶ï¼Œè‡ªåŠ¨step down
â†’ é¿å…è„‘è£‚
```

### 5.2 è¾¹ç•Œæ¡ä»¶åˆ†æ

**è¾¹ç•Œ1: 2èŠ‚ç‚¹é›†ç¾¤**

```text
é…ç½®: {N1, N2}
å¤šæ•°æ´¾: 2

é—®é¢˜:
â”œâ”€ ä»»ä¸€èŠ‚ç‚¹æ•…éšœ â†’ æ— å¤šæ•°æ´¾
â”œâ”€ æ— æ³•é€‰ä¸¾Leader
â”œâ”€ ç³»ç»Ÿåœæ­¢æœåŠ¡
â””â”€ å¯ç”¨æ€§ = 0% (æœ€å·®!)

ç»“è®º: 2èŠ‚ç‚¹é›†ç¾¤æ²¡æœ‰å®¹é”™èƒ½åŠ›
æ¨è: æœ€å°‘3èŠ‚ç‚¹
```

**è¾¹ç•Œ2: å¶æ•°èŠ‚ç‚¹é›†ç¾¤**

```text
4èŠ‚ç‚¹ vs 3èŠ‚ç‚¹:

å®¹é”™èƒ½åŠ›:
â”œâ”€ 3èŠ‚ç‚¹: å…è®¸1ä¸ªæ•…éšœ (2/3å¤šæ•°æ´¾)
â”œâ”€ 4èŠ‚ç‚¹: å…è®¸1ä¸ªæ•…éšœ (3/4å¤šæ•°æ´¾)
â””â”€ å®¹é”™èƒ½åŠ›ç›¸åŒ!

æˆæœ¬:
â”œâ”€ 4èŠ‚ç‚¹: å¤š33%ç¡¬ä»¶æˆæœ¬
â””â”€ ä½†å®¹é”™èƒ½åŠ›ä¸å¢åŠ 

ç»“è®º: æ¨èå¥‡æ•°èŠ‚ç‚¹ï¼ˆ3/5/7ï¼‰
é¿å…å¶æ•°èŠ‚ç‚¹ï¼ˆ4/6/8ï¼‰æµªè´¹èµ„æº
```

---

## å…­ã€æ‹œå åº­å®¹é”™åè¯

### 6.1 Raftä¸èƒ½å®¹å¿æ‹œå åº­æ•…éšœ

**å®šç†6.1**: Raftæ— æ³•å®¹å¿æ¶æ„èŠ‚ç‚¹

**åè¯æ³•**:

å‡è®¾Raftå¯ä»¥å®¹å¿\(f\)ä¸ªæ‹œå åº­èŠ‚ç‚¹ï¼ˆæ¶æ„ï¼‰

**æ„é€ æ‹œå åº­æ”»å‡»**:

```text
åœºæ™¯: 5èŠ‚ç‚¹é›†ç¾¤ï¼ŒN5æ˜¯æ¶æ„èŠ‚ç‚¹

æ”»å‡»1: åŒé‡æŠ•ç¥¨
â”œâ”€ N5å¯¹N1æŠ•ç¥¨ (term=3)
â”œâ”€ N5å¯¹N2ä¹ŸæŠ•ç¥¨ (term=3)
â””â”€ å¯¼è‡´ä¸¤ä¸ªLeaderï¼ˆè¿åé€‰ä¸¾å®‰å…¨æ€§ï¼‰

æ”»å‡»2: ä¼ªé€ æ—¥å¿—
â”œâ”€ N5ä¼ªé€ Log[10]å†…å®¹
â”œâ”€ å‘é€ç»™ä¸åŒèŠ‚ç‚¹ä¸åŒç‰ˆæœ¬
â””â”€ ç ´åLog Matching

æ”»å‡»3: æ‹’ç»æœåŠ¡
â”œâ”€ N5æ‹’ç»æ‰€æœ‰AppendEntries
â”œâ”€ æ‹’ç»æ‰€æœ‰RequestVote
â””â”€ é™ä½å¯ç”¨æ€§

Rafté˜²æŠ¤:
âœ— æ— æ³•æ£€æµ‹åŒé‡æŠ•ç¥¨ï¼ˆæ— ç­¾åéªŒè¯ï¼‰
âœ— æ— æ³•æ£€æµ‹ä¼ªé€ æ—¥å¿—ï¼ˆæ— åŠ å¯†å“ˆå¸Œï¼‰
âœ— æ— æ³•å¼ºåˆ¶è¯šå®è¡Œä¸º

ç»“è®º: Raftè®¾è®¡å‡è®¾"å´©æºƒæ•…éšœ"ï¼Œä¸è€ƒè™‘æ‹œå åº­
```

**æ‹œå åº­å®¹é”™éœ€è¦**:

\[
n \geq 3f + 1
\]

å…¶ä¸­\(f\)æ˜¯æ‹œå åº­èŠ‚ç‚¹æ•°

**å¯¹æ¯”**:

| å®¹é”™ç±»å‹ | Raft | PBFT (æ‹œå åº­) |
|---------|------|--------------|
| æ•…éšœæ¨¡å‹ | å´©æºƒæ•…éšœ | æ‹œå åº­æ•…éšœ |
| èŠ‚ç‚¹è¦æ±‚ | \(n \geq 2f+1\) | \(n \geq 3f+1\) |
| å®¹å¿1æ•…éšœ | 3èŠ‚ç‚¹ | 4èŠ‚ç‚¹ |
| å®¹å¿2æ•…éšœ | 5èŠ‚ç‚¹ | 7èŠ‚ç‚¹ |
| æ€§èƒ½ | é«˜ | ä½ï¼ˆ3å€æ¶ˆæ¯ï¼‰ |

**é€‚ç”¨åœºæ™¯**:

- Raft: å†…éƒ¨å¯ä¿¡ç¯å¢ƒï¼ˆæ•°æ®ä¸­å¿ƒï¼‰
- PBFT: ä¸å¯ä¿¡ç¯å¢ƒï¼ˆè”ç›Ÿé“¾ï¼‰

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒå®šç†æ€»è§ˆ

| å®šç† | å†…å®¹ | è¯æ˜æ–¹æ³• | é‡è¦æ€§ |
|-----|------|---------|--------|
| é€‰ä¸¾å®‰å…¨æ€§ | æ¯termè‡³å¤š1ä¸ªLeader | åè¯æ³• | â­â­â­â­â­ |
| Log Matching | ç›¸åŒç´¢å¼•termç›¸åŒâ†’å‰ç¼€ç›¸åŒ | å½’çº³æ³• | â­â­â­â­â­ |
| Leader Completeness | å·²æäº¤æ¡ç›®åœ¨æœªæ¥Leaderä¸­ | åè¯æ³•+å½’çº³ | â­â­â­â­â­ |
| State Machine Safety | ç›¸åŒcommitIndexâ†’ç›¸åŒçŠ¶æ€ | ç»„åˆå‰è¿°å®šç† | â­â­â­â­â­ |
| Election Liveness | æœ€ç»ˆé€‰å‡ºLeader | æ¦‚ç‡åˆ†æ | â­â­â­â­ |

### 7.2 åä¾‹æ€»ç»“

**5ä¸ªå…³é”®åä¾‹**:

1. âŒ å…è®¸å¤šæ¬¡æŠ•ç¥¨ â†’ è„‘è£‚
2. âŒ ä¸æ£€æŸ¥æ—¥å¿—æ–°æ—§ â†’ æ•°æ®ä¸¢å¤±
3. âŒ ä¸æ£€æŸ¥prevLog â†’ æ—¥å¿—ä¸ä¸€è‡´
4. âŒ å›ºå®šè¶…æ—¶ â†’ é€‰ä¸¾æ´»é”
5. âŒ 2èŠ‚ç‚¹é›†ç¾¤ â†’ æ— å®¹é”™èƒ½åŠ›

**é˜²æŠ¤æœºåˆ¶**:

1. âœ… æ¯termå•æ¬¡æŠ•ç¥¨
2. âœ… RequestVoteæ£€æŸ¥æ—¥å¿—
3. âœ… AppendEntriesæ£€æŸ¥prevLog
4. âœ… éšæœºelection timeout
5. âœ… è¦æ±‚å¥‡æ•°èŠ‚ç‚¹â‰¥3

### 7.3 å½¢å¼åŒ–æ€»ç»“ï¼ˆTLA+ç‰‡æ®µï¼‰

```tla
\* Raftæ ¸å¿ƒä¸å˜å¼
TypeOK == /\ \A s \in Server : state[s] \in {Leader, Follower, Candidate}
          /\ \A s \in Server : currentTerm[s] \in Nat

ElectionSafety ==
    \A s1, s2 \in Server :
        (state[s1] = Leader /\ state[s2] = Leader /\ currentTerm[s1] = currentTerm[s2])
        => s1 = s2

LogMatching ==
    \A s1, s2 \in Server, i \in DOMAIN log[s1] \cap DOMAIN log[s2] :
        log[s1][i].term = log[s2][i].term
        => SubSeq(log[s1], 1, i) = SubSeq(log[s2], 1, i)

LeaderCompleteness ==
    \A s \in Server, i \in DOMAIN log[s] :
        (log[s][i].term < currentTerm[s] /\ Committed(log[s][i]))
        => \A leader \in Server :
            (state[leader] = Leader /\ currentTerm[leader] > log[s][i].term)
            => log[s][i] \in log[leader]

StateMachineSafety ==
    \A s1, s2 \in Server :
        commitIndex[s1] = commitIndex[s2]
        => AppliedState(s1, commitIndex[s1]) = AppliedState(s2, commitIndex[s2])
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: åä¾‹åˆ†æã€è¾¹ç•Œæ¡ä»¶ã€æ‹œå åº­åè¯

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/08-å…±è¯†åè®®ç†è®º.md`
- `04-åˆ†å¸ƒå¼æ‰©å±•/03-å…±è¯†åè®®(Raft_Paxos).md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/07-åˆ†å¸ƒå¼ç¼“å­˜.md` (Raftåº”ç”¨)

**å‚è€ƒè®ºæ–‡**:

- "In Search of an Understandable Consensus Algorithm" (Ongaro & Ousterhout, 2014)
- "Paxos Made Simple" (Lamport, 2001)
- TLA+ Raftè§„èŒƒ: <https://github.com/ongardie/raft.tla>
