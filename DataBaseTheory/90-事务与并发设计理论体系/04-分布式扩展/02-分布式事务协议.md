# 02 | åˆ†å¸ƒå¼äº‹åŠ¡åè®®

> **åè®®å®šä½**: æœ¬æ–‡æ¡£åˆ†æ2PCã€3PCç­‰åˆ†å¸ƒå¼äº‹åŠ¡åè®®çš„åŸç†ã€ä¼˜ç¼ºç‚¹åŠåº”ç”¨åœºæ™¯ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | åˆ†å¸ƒå¼äº‹åŠ¡åè®®](#02--åˆ†å¸ƒå¼äº‹åŠ¡åè®®)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°](#ä¸€åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°)
    - [1.1 ACIDæŒ‘æˆ˜](#11-acidæŒ‘æˆ˜)
    - [1.2 æ ¸å¿ƒé—®é¢˜](#12-æ ¸å¿ƒé—®é¢˜)
  - [äºŒã€ä¸¤é˜¶æ®µæäº¤(2PC)](#äºŒä¸¤é˜¶æ®µæäº¤2pc)
    - [2.1 åè®®æµç¨‹](#21-åè®®æµç¨‹)
    - [2.2 ä¼ªä»£ç å®ç°](#22-ä¼ªä»£ç å®ç°)
    - [2.3 æ•…éšœå¤„ç†](#23-æ•…éšœå¤„ç†)
    - [2.4 æ€§èƒ½åˆ†æ](#24-æ€§èƒ½åˆ†æ)
  - [ä¸‰ã€ä¸‰é˜¶æ®µæäº¤(3PC)](#ä¸‰ä¸‰é˜¶æ®µæäº¤3pc)
    - [3.1 æ”¹è¿›åŠ¨æœº](#31-æ”¹è¿›åŠ¨æœº)
    - [3.2 åè®®æµç¨‹](#32-åè®®æµç¨‹)
    - [3.3 è¶…æ—¶å¤„ç†](#33-è¶…æ—¶å¤„ç†)
    - [3.4 3PCçš„é—®é¢˜](#34-3pcçš„é—®é¢˜)
  - [å››ã€Sagaæ¨¡å¼](#å››sagaæ¨¡å¼)
    - [4.1 æ ¸å¿ƒæ€æƒ³](#41-æ ¸å¿ƒæ€æƒ³)
    - [4.2 ç¤ºä¾‹ï¼šè®¢å•å¤„ç†](#42-ç¤ºä¾‹è®¢å•å¤„ç†)
    - [4.3 Saga vs 2PC](#43-saga-vs-2pc)
  - [äº”ã€TCCæ¨¡å¼](#äº”tccæ¨¡å¼)
    - [5.1 ä¸‰é˜¶æ®µ](#51-ä¸‰é˜¶æ®µ)
    - [5.2 å®ç°ç¤ºä¾‹](#52-å®ç°ç¤ºä¾‹)
    - [5.3 TCC vs Saga](#53-tcc-vs-saga)
  - [å…­ã€åè®®å¯¹æ¯”](#å…­åè®®å¯¹æ¯”)
    - [6.1 ç»¼åˆå¯¹æ¯”çŸ©é˜µ](#61-ç»¼åˆå¯¹æ¯”çŸ©é˜µ)
    - [6.2 é€‰æ‹©å†³ç­–æ ‘](#62-é€‰æ‹©å†³ç­–æ ‘)
    - [6.3 å»¶è¿Ÿå¯¹æ¯”](#63-å»¶è¿Ÿå¯¹æ¯”)
  - [ä¸ƒã€æ€»ç»“](#ä¸ƒæ€»ç»“)
    - [7.1 æ ¸å¿ƒæ´å¯Ÿ](#71-æ ¸å¿ƒæ´å¯Ÿ)
    - [7.2 å®è·µå»ºè®®](#72-å®è·µå»ºè®®)
  - [å…«ã€å®Œæ•´å®ç°ä»£ç ](#å…«å®Œæ•´å®ç°ä»£ç )
    - [8.1 2PCåè°ƒå™¨å®Œæ•´å®ç°](#81-2pcåè°ƒå™¨å®Œæ•´å®ç°)
    - [8.2 Sagaåè°ƒå™¨å®ç°](#82-sagaåè°ƒå™¨å®ç°)
    - [8.3 TCCå®Œæ•´å®ç°](#83-tccå®Œæ•´å®ç°)
  - [ä¹ã€å®é™…ç”Ÿäº§æ¡ˆä¾‹](#ä¹å®é™…ç”Ÿäº§æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: å¾®æœåŠ¡è®¢å•ç³»ç»Ÿï¼ˆSagaæ¨¡å¼ï¼‰](#æ¡ˆä¾‹1-å¾®æœåŠ¡è®¢å•ç³»ç»Ÿsagaæ¨¡å¼)
    - [æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿï¼ˆTCCæ¨¡å¼ï¼‰](#æ¡ˆä¾‹2-é‡‘èè½¬è´¦ç³»ç»Ÿtccæ¨¡å¼)
  - [åã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#ååä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: 2PCåè°ƒå™¨å•ç‚¹æ•…éšœ](#åä¾‹1-2pcåè°ƒå™¨å•ç‚¹æ•…éšœ)
    - [åä¾‹2: Sagaè¡¥å¿ä¸å¹‚ç­‰](#åä¾‹2-sagaè¡¥å¿ä¸å¹‚ç­‰)

---

## ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°

### 1.1 ACIDæŒ‘æˆ˜

**å•æœºäº‹åŠ¡**: ä¾èµ–æœ¬åœ°æ—¥å¿—å’Œé”

$$ACID_{local} = \text{Easy to guarantee}$$

**åˆ†å¸ƒå¼äº‹åŠ¡**: è·¨èŠ‚ç‚¹åè°ƒ

$$ACID_{distributed} = \text{Network failures + Node crashes}$$

### 1.2 æ ¸å¿ƒé—®é¢˜

**é—®é¢˜1**: åŸå­æ€§è·¨èŠ‚ç‚¹

å¦‚ä½•ä¿è¯å¤šä¸ªèŠ‚ç‚¹è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Ÿ

**é—®é¢˜2**: ä¸€è‡´æ€§è·¨èŠ‚ç‚¹

å¦‚ä½•åœ¨ç½‘ç»œåˆ†åŒºæ—¶ä¿æŒæ•°æ®ä¸€è‡´ï¼Ÿ

**é—®é¢˜3**: æ€§èƒ½æƒè¡¡

åè°ƒå¼€é”€ vs ä¸€è‡´æ€§ä¿è¯

---

## äºŒã€ä¸¤é˜¶æ®µæäº¤(2PC)

### 2.1 åè®®æµç¨‹

**Phase 1: Prepare (å‡†å¤‡é˜¶æ®µ)**

```
Coordinator                 Participant
    |                            |
    |------- PREPARE ----------->|
    |                            | (1) æ‰§è¡Œäº‹åŠ¡æ“ä½œ
    |                            | (2) å†™undo/redoæ—¥å¿—
    |                            | (3) æŒä¹…åŒ–
    |<------- YES/NO ------------|
```

**Phase 2: Commit (æäº¤é˜¶æ®µ)**

```
Coordinator                 Participant
    |                            |
    |------- COMMIT ------------>|
    |                            | (1) æäº¤äº‹åŠ¡
    |                            | (2) é‡Šæ”¾èµ„æº
    |<------- ACK ---------------|
```

### 2.2 ä¼ªä»£ç å®ç°

**Coordinatoré€»è¾‘**:

```python
class TwoPhaseCoordinator:
    def __init__(self, participants):
        self.participants = participants
        self.state = 'INIT'

    def execute_transaction(self, operations):
        # Phase 1: Prepare
        votes = []
        for p in self.participants:
            vote = p.prepare(operations)
            votes.append(vote)

        # å†³ç­–
        if all(v == 'YES' for v in votes):
            decision = 'COMMIT'
        else:
            decision = 'ABORT'

        # æŒä¹…åŒ–å†³ç­–
        self.log_decision(decision)

        # Phase 2: Commit/Abort
        for p in self.participants:
            if decision == 'COMMIT':
                p.commit()
            else:
                p.abort()

        return decision
```

**Participanté€»è¾‘**:

```python
class TwoPhaseParticipant:
    def prepare(self, operations):
        try:
            # æ‰§è¡Œæ“ä½œ
            self.execute_local(operations)

            # å†™æ—¥å¿—ï¼ˆæŒä¹…åŒ–ï¼‰
            self.write_log('PREPARED')

            # åŠ é”ï¼ˆæŒæœ‰èµ„æºç›´åˆ°commit/abortï¼‰
            self.lock_resources()

            return 'YES'
        except Exception as e:
            self.write_log('ABORT')
            return 'NO'

    def commit(self):
        # æäº¤æœ¬åœ°äº‹åŠ¡
        self.local_commit()

        # å†™æ—¥å¿—
        self.write_log('COMMITTED')

        # é‡Šæ”¾é”
        self.release_locks()

    def abort(self):
        # å›æ»š
        self.local_rollback()
        self.write_log('ABORTED')
        self.release_locks()
```

### 2.3 æ•…éšœå¤„ç†

**Case 1: Coordinatoræ•…éšœï¼ˆPrepareåï¼‰**

```
ParticipantçŠ¶æ€: PREPARED (æŒæœ‰é”)
æ¢å¤ç­–ç•¥:
  - ç­‰å¾…Coordinatoræ¢å¤
  - æˆ–è¿è¡Œæ¢å¤åè®®ï¼ˆè¯¢é—®å…¶ä»–å‚ä¸è€…ï¼‰
```

**é—®é¢˜**: **é˜»å¡é—®é¢˜** - å‚ä¸è€…æ— é™æœŸç­‰å¾…

**Case 2: Participantæ•…éšœï¼ˆPrepareå‰ï¼‰**

```
Coordinator: è¶…æ—¶åä¸­æ­¢äº‹åŠ¡
```

**Case 3: ç½‘ç»œåˆ†åŒº**

```
Coordinatorä¸éƒ¨åˆ†Participantå¤±è”
â†’ Coordinatorä¸­æ­¢äº‹åŠ¡
â†’ Partition healingåå›æ»š
```

### 2.4 æ€§èƒ½åˆ†æ

**å»¶è¿Ÿ**:

$$Latency_{2PC} = 2 \times RTT + 2 \times DiskSync$$

**ååé‡**:

$$TPS_{2PC} = \frac{1}{Latency_{2PC} + LockHoldTime}$$

**å…¸å‹å€¼** (3èŠ‚ç‚¹ï¼ŒRTT=1ms):

$$Latency \approx 2 \times 1ms + 2 \times 5ms = 12ms$$

$$TPS \approx 83 \text{ transactions/sec (å•åè°ƒå™¨)}$$

---

## ä¸‰ã€ä¸‰é˜¶æ®µæäº¤(3PC)

### 3.1 æ”¹è¿›åŠ¨æœº

**2PCé—®é¢˜**: Coordinatoræ•…éšœå¯¼è‡´å‚ä¸è€…é˜»å¡

**3PCæ”¹è¿›**: å¼•å…¥è¶…æ—¶æœºåˆ¶ï¼Œå‡å°‘é˜»å¡

### 3.2 åè®®æµç¨‹

**Phase 1: CanCommit**

```
Coordinator â†’ Participants: "Can you commit?"
Participants â†’ Coordinator: YES/NO
```

**Phase 2: PreCommit**

```
Coordinator â†’ Participants: "Prepare to commit"
Participants: æ‰§è¡Œæ“ä½œï¼Œå†™æ—¥å¿—ï¼Œä½†ä¸æäº¤
```

**Phase 3: DoCommit**

```
Coordinator â†’ Participants: "Commit now"
Participants: æäº¤å¹¶é‡Šæ”¾èµ„æº
```

### 3.3 è¶…æ—¶å¤„ç†

**å‚ä¸è€…è¶…æ—¶é€»è¾‘**:

```python
class ThreePhaseParticipant:
    def wait_for_precommit(self, timeout=10):
        msg = self.wait_message(timeout)

        if msg == 'PRECOMMIT':
            self.precommit()
            return self.wait_for_docommit(timeout)
        elif msg == 'ABORT':
            self.abort()
        else:
            # è¶…æ—¶ â†’ ä¸»åŠ¨ä¸­æ­¢
            self.abort()

    def wait_for_docommit(self, timeout=10):
        msg = self.wait_message(timeout)

        if msg == 'DOCOMMIT':
            self.commit()
        elif msg == 'ABORT':
            self.abort()
        else:
            # è¶…æ—¶ â†’ å‡è®¾å¯ä»¥æäº¤ï¼ˆå±é™©ï¼ï¼‰
            self.commit()
```

### 3.4 3PCçš„é—®é¢˜

**ç½‘ç»œåˆ†åŒºåœºæ™¯**:

```
Partition 1: Coordinator + P1 (æ”¶åˆ°PRECOMMIT)
Partition 2: P2, P3 (è¶…æ—¶ï¼Œå†³å®šCOMMIT)

â†’ ä¸ä¸€è‡´ï¼
```

**ç»“è®º**: 3PCåœ¨åˆ†åŒºæ—¶ä»ä¸å®‰å…¨

---

## å››ã€Sagaæ¨¡å¼

### 4.1 æ ¸å¿ƒæ€æƒ³

**Saga**: é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ + è¡¥å¿æ“ä½œ

$$Saga = T_1 \to T_2 \to ... \to T_n$$

**è¡¥å¿**: æ¯ä¸ª$T_i$æœ‰å¯¹åº”çš„$C_i$ï¼ˆé€†æ“ä½œï¼‰

### 4.2 ç¤ºä¾‹ï¼šè®¢å•å¤„ç†

```python
class OrderSaga:
    def execute(self):
        try:
            # T1: åˆ›å»ºè®¢å•
            order_id = self.create_order()

            # T2: æ‰£å‡åº“å­˜
            self.reduce_inventory(order_id)

            # T3: æ‰£æ¬¾
            self.charge_payment(order_id)

            # T4: å‘è´§
            self.ship_order(order_id)

        except Exception as e:
            # è¡¥å¿ï¼ˆåå‘æ‰§è¡Œï¼‰
            self.compensate(e.step)

    def compensate(self, failed_step):
        if failed_step >= 4:
            self.cancel_shipping()
        if failed_step >= 3:
            self.refund_payment()
        if failed_step >= 2:
            self.restore_inventory()
        if failed_step >= 1:
            self.cancel_order()
```

### 4.3 Saga vs 2PC

| ç»´åº¦ | 2PC | Saga |
|-----|-----|------|
| **åŸå­æ€§** | å¼ºï¼ˆå…¨å±€é”ï¼‰ | å¼±ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰ |
| **é”æŒæœ‰** | é•¿ï¼ˆé˜»å¡ï¼‰ | çŸ­ï¼ˆç«‹å³æäº¤ï¼‰ |
| **æ€§èƒ½** | ä½ | é«˜ |
| **å¤æ‚åº¦** | åè®®å¤æ‚ | è¡¥å¿é€»è¾‘å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | çŸ­äº‹åŠ¡ | é•¿äº‹åŠ¡ |

---

## äº”ã€TCCæ¨¡å¼

### 5.1 ä¸‰é˜¶æ®µ

**Try**: é¢„ç•™èµ„æº

```sql
-- é¢„ç•™è´¦æˆ·ä½™é¢
UPDATE accounts
SET reserved = reserved + 100
WHERE id = 123;
```

**Confirm**: ç¡®è®¤æäº¤

```sql
-- æ‰£å‡é¢„ç•™é‡‘é¢
UPDATE accounts
SET balance = balance - 100,
    reserved = reserved - 100
WHERE id = 123;
```

**Cancel**: å–æ¶ˆå›æ»š

```sql
-- é‡Šæ”¾é¢„ç•™
UPDATE accounts
SET reserved = reserved - 100
WHERE id = 123;
```

### 5.2 å®ç°ç¤ºä¾‹

```python
class TCCTransaction:
    def __init__(self):
        self.participants = []

    def try_phase(self):
        """é¢„ç•™èµ„æº"""
        for p in self.participants:
            if not p.try_reserve():
                return False
        return True

    def confirm_phase(self):
        """ç¡®è®¤æäº¤"""
        for p in self.participants:
            p.confirm()

    def cancel_phase(self):
        """å–æ¶ˆå›æ»š"""
        for p in self.participants:
            p.cancel()
```

### 5.3 TCC vs Saga

| ç»´åº¦ | TCC | Saga |
|-----|-----|------|
| **èµ„æºé¢„ç•™** | æ˜¯ï¼ˆTryé˜¶æ®µï¼‰ | å¦ |
| **ä¸€è‡´æ€§** | å¼º | æœ€ç»ˆä¸€è‡´ |
| **å®ç°å¤æ‚åº¦** | é«˜ï¼ˆéœ€ä¸‰ä¸ªæ¥å£ï¼‰ | ä¸­ï¼ˆéœ€è¡¥å¿æ¥å£ï¼‰ |
| **æ€§èƒ½** | ä¸­ | é«˜ |

---

## å…­ã€åè®®å¯¹æ¯”

### 6.1 ç»¼åˆå¯¹æ¯”çŸ©é˜µ

| åè®® | ä¸€è‡´æ€§ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é˜»å¡ |
|-----|-------|--------|------|--------|------|
| **2PC** | å¼º | ä½ | ä½ | ä¸­ | æ˜¯ |
| **3PC** | å¼º | ä¸­ | ä½ | é«˜ | éƒ¨åˆ† |
| **Saga** | æœ€ç»ˆ | é«˜ | é«˜ | ä¸­ | å¦ |
| **TCC** | å¼º | é«˜ | ä¸­ | é«˜ | å¦ |

### 6.2 é€‰æ‹©å†³ç­–æ ‘

```
éœ€è¦å¼ºä¸€è‡´æ€§ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ çŸ­äº‹åŠ¡ï¼Ÿ
    â”‚       â”œâ”€ æ˜¯ â†’ 2PC
    â”‚       â””â”€ å¦ â†’ TCC
    â””â”€ å¦ â†’ é•¿äº‹åŠ¡ï¼Ÿ
            â”œâ”€ æ˜¯ â†’ Saga
            â””â”€ å¦ â†’ æœ€ç»ˆä¸€è‡´æ€§
```

### 6.3 å»¶è¿Ÿå¯¹æ¯”

| åè®® | é˜¶æ®µæ•° | åŒæ­¥ç‚¹ | å…¸å‹å»¶è¿Ÿ |
|-----|-------|--------|---------|
| 2PC | 2 | 2 | 10-20ms |
| 3PC | 3 | 3 | 15-30ms |
| Saga | N | N | 50-500ms |
| TCC | 2 | 2 | 15-25ms |

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒæ´å¯Ÿ

**2PC**:

- âœ… ä¿è¯åŸå­æ€§
- âŒ é˜»å¡é—®é¢˜
- é€‚ç”¨: çŸ­äº‹åŠ¡ï¼Œå¼ºä¸€è‡´æ€§

**Saga**:

- âœ… é«˜æ€§èƒ½
- âŒ æœ€ç»ˆä¸€è‡´æ€§
- é€‚ç”¨: é•¿äº‹åŠ¡ï¼Œå¾®æœåŠ¡

**TCC**:

- âœ… å¼ºä¸€è‡´æ€§ + é«˜å¯ç”¨
- âŒ å®ç°å¤æ‚
- é€‚ç”¨: é‡‘èåœºæ™¯

### 7.2 å®è·µå»ºè®®

1. **ä¼˜å…ˆæœ¬åœ°äº‹åŠ¡**: é¿å…åˆ†å¸ƒå¼äº‹åŠ¡
2. **çŸ­äº‹åŠ¡ç”¨2PC**: ç®€å•å¯é 
3. **é•¿äº‹åŠ¡ç”¨Saga**: æ€§èƒ½ä¼˜å…ˆ
4. **é‡‘èåœºæ™¯ç”¨TCC**: ä¸€è‡´æ€§ä¼˜å…ˆ

---

## å…«ã€å®Œæ•´å®ç°ä»£ç 

### 8.1 2PCåè°ƒå™¨å®Œæ•´å®ç°

```rust
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use tokio::time::{Duration, timeout};

#[derive(Debug, Clone)]
enum TransactionState {
    Initial,
    Prepared,
    Committed,
    Aborted,
}

struct Participant {
    id: String,
    endpoint: String,
    state: Arc<Mutex<TransactionState>>,
}

pub struct TwoPhaseCoordinator {
    participants: Vec<Participant>,
    decision: Arc<Mutex<Option<bool>>>,  // None/Some(true)=commit/Some(false)=abort
    timeout: Duration,
}

impl TwoPhaseCoordinator {
    pub fn new(participants: Vec<Participant>) -> Self {
        Self {
            participants,
            decision: Arc::new(Mutex::new(None)),
            timeout: Duration::from_secs(30),
        }
    }

    pub async fn execute_transaction(&self, operations: Vec<Operation>) -> Result<bool, String> {
        // Phase 1: Prepare
        let mut votes = Vec::new();

        for participant in &self.participants {
            let vote = match timeout(
                self.timeout,
                self.send_prepare(participant, &operations)
            ).await {
                Ok(Ok(vote)) => vote,
                Ok(Err(e)) => {
                    // Prepareå¤±è´¥ï¼Œä¸­æ­¢äº‹åŠ¡
                    self.abort_all().await;
                    return Err(format!("Participant {} prepare failed: {}", participant.id, e));
                }
                Err(_) => {
                    // è¶…æ—¶ï¼Œä¸­æ­¢äº‹åŠ¡
                    self.abort_all().await;
                    return Err(format!("Participant {} timeout", participant.id));
                }
            };

            votes.push(vote);
        }

        // å†³ç­–ï¼šæ‰€æœ‰å‚ä¸è€…éƒ½æŠ•ç¥¨YESæ‰èƒ½æäº¤
        let decision = votes.iter().all(|v| *v);

        // æŒä¹…åŒ–å†³ç­–
        self.log_decision(decision).await?;

        // Phase 2: Commit/Abort
        if decision {
            self.commit_all().await?;
        } else {
            self.abort_all().await?;
        }

        Ok(decision)
    }

    async fn send_prepare(&self, participant: &Participant, operations: &[Operation]) -> Result<bool, String> {
        // å‘é€PREPAREè¯·æ±‚
        let response = self.http_post(
            &format!("{}/prepare", participant.endpoint),
            operations
        ).await?;

        if response.status == "YES" {
            *participant.state.lock().unwrap() = TransactionState::Prepared;
            Ok(true)
        } else {
            Ok(false)
        }
    }

    async fn commit_all(&self) -> Result<(), String> {
        *self.decision.lock().unwrap() = Some(true);

        for participant in &self.participants {
            self.http_post(
                &format!("{}/commit", participant.endpoint),
                &()
            ).await?;

            *participant.state.lock().unwrap() = TransactionState::Committed;
        }

        Ok(())
    }

    async fn abort_all(&self) -> Result<(), String> {
        *self.decision.lock().unwrap() = Some(false);

        for participant in &self.participants {
            // å¿½ç•¥é”™è¯¯ï¼ˆå¯èƒ½å·²ç»å¤±è´¥ï¼‰
            let _ = self.http_post(
                &format!("{}/abort", participant.endpoint),
                &()
            ).await;

            *participant.state.lock().unwrap() = TransactionState::Aborted;
        }

        Ok(())
    }

    async fn log_decision(&self, decision: bool) -> Result<(), String> {
        // æŒä¹…åŒ–å†³ç­–åˆ°WAL
        // å®ç°ç»†èŠ‚...
        Ok(())
    }
}
```

### 8.2 Sagaåè°ƒå™¨å®ç°

```python
from dataclasses import dataclass
from typing import List, Callable, Optional
from enum import Enum

class SagaStepStatus(Enum):
    PENDING = "pending"
    COMPLETED = "completed"
    FAILED = "failed"
    COMPENSATED = "compensated"

@dataclass
class SagaStep:
    name: str
    execute: Callable
    compensate: Callable
    status: SagaStepStatus = SagaStepStatus.PENDING

class SagaCoordinator:
    def __init__(self):
        self.steps: List[SagaStep] = []
        self.executed_steps: List[SagaStep] = []

    def add_step(self, step: SagaStep):
        self.steps.append(step)

    def execute(self) -> bool:
        """æ‰§è¡ŒSagaäº‹åŠ¡"""
        try:
            for step in self.steps:
                # æ‰§è¡Œæ­¥éª¤
                result = step.execute()
                step.status = SagaStepStatus.COMPLETED
                self.executed_steps.append(step)

                if not result:
                    # æ­¥éª¤å¤±è´¥ï¼Œå¼€å§‹è¡¥å¿
                    self.compensate(step)
                    return False

            return True

        except Exception as e:
            # å¼‚å¸¸ï¼Œè¡¥å¿æ‰€æœ‰å·²æ‰§è¡Œæ­¥éª¤
            self.compensate_all()
            return False

    def compensate(self, failed_step: SagaStep):
        """è¡¥å¿å•ä¸ªæ­¥éª¤"""
        # åå‘æ‰§è¡Œå·²å®Œæˆçš„æ­¥éª¤
        for step in reversed(self.executed_steps):
            try:
                step.compensate()
                step.status = SagaStepStatus.COMPENSATED
            except Exception as e:
                # è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
                print(f"Compensation failed for {step.name}: {e}")

    def compensate_all(self):
        """è¡¥å¿æ‰€æœ‰æ­¥éª¤"""
        self.compensate(self.steps[-1] if self.steps else None)

# ä½¿ç”¨ç¤ºä¾‹
def create_order_saga():
    saga = SagaCoordinator()

    # Step 1: åˆ›å»ºè®¢å•
    saga.add_step(SagaStep(
        name="create_order",
        execute=lambda: create_order(),
        compensate=lambda: cancel_order()
    ))

    # Step 2: æ‰£å‡åº“å­˜
    saga.add_step(SagaStep(
        name="reduce_inventory",
        execute=lambda: reduce_inventory(),
        compensate=lambda: restore_inventory()
    ))

    # Step 3: æ‰£æ¬¾
    saga.add_step(SagaStep(
        name="charge_payment",
        execute=lambda: charge_payment(),
        compensate=lambda: refund_payment()
    ))

    return saga
```

### 8.3 TCCå®Œæ•´å®ç°

```rust
use async_trait::async_trait;

#[async_trait]
trait TCCParticipant {
    async fn try_reserve(&self, amount: u64) -> Result<(), String>;
    async fn confirm(&self, amount: u64) -> Result<(), String>;
    async fn cancel(&self, amount: u64) -> Result<(), String>;
}

struct AccountService {
    account_id: String,
    db: Arc<dyn Database>,
}

#[async_trait]
impl TCCParticipant for AccountService {
    async fn try_reserve(&self, amount: u64) -> Result<(), String> {
        // Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
        self.db.execute(
            "UPDATE accounts SET reserved = reserved + ? WHERE id = ? AND balance >= ?",
            &[amount, &self.account_id, amount]
        ).await?;

        Ok(())
    }

    async fn confirm(&self, amount: u64) -> Result<(), String> {
        // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£æ¬¾
        self.db.execute(
            "UPDATE accounts SET balance = balance - ?, reserved = reserved - ? WHERE id = ?",
            &[amount, amount, &self.account_id]
        ).await?;

        Ok(())
    }

    async fn cancel(&self, amount: u64) -> Result<(), String> {
        // Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„ç•™
        self.db.execute(
            "UPDATE accounts SET reserved = reserved - ? WHERE id = ?",
            &[amount, &self.account_id]
        ).await?;

        Ok(())
    }
}

pub struct TCCTransaction {
    participants: Vec<Arc<dyn TCCParticipant>>,
}

impl TCCTransaction {
    pub async fn execute(&self, operations: Vec<(Arc<dyn TCCParticipant>, u64)>) -> Result<(), String> {
        // Phase 1: Tryï¼ˆé¢„ç•™èµ„æºï¼‰
        let mut reserved = Vec::new();

        for (participant, amount) in &operations {
            match participant.try_reserve(*amount).await {
                Ok(_) => reserved.push((participant.clone(), *amount)),
                Err(e) => {
                    // Tryå¤±è´¥ï¼Œå–æ¶ˆæ‰€æœ‰é¢„ç•™
                    self.cancel_all(&reserved).await;
                    return Err(e);
                }
            }
        }

        // Phase 2: Confirmï¼ˆç¡®è®¤æäº¤ï¼‰
        for (participant, amount) in &reserved {
            if let Err(e) = participant.confirm(*amount).await {
                // Confirmå¤±è´¥ï¼Œå°è¯•è¡¥å¿
                self.cancel_all(&reserved).await;
                return Err(e);
            }
        }

        Ok(())
    }

    async fn cancel_all(&self, reserved: &[(Arc<dyn TCCParticipant>, u64)]) {
        for (participant, amount) in reserved.iter().rev() {
            let _ = participant.cancel(*amount).await;
        }
    }
}
```

---

## ä¹ã€å®é™…ç”Ÿäº§æ¡ˆä¾‹

### æ¡ˆä¾‹1: å¾®æœåŠ¡è®¢å•ç³»ç»Ÿï¼ˆSagaæ¨¡å¼ï¼‰

**æ¶æ„**:

```text
è®¢å•æœåŠ¡ (Order Service)
    â”œâ”€ åˆ›å»ºè®¢å•
    â”œâ”€ è°ƒç”¨åº“å­˜æœåŠ¡ (Inventory Service)
    â”œâ”€ è°ƒç”¨æ”¯ä»˜æœåŠ¡ (Payment Service)
    â””â”€ è°ƒç”¨ç‰©æµæœåŠ¡ (Shipping Service)
```

**Sagaå®ç°**:

```python
class OrderSaga:
    def __init__(self):
        self.inventory_client = InventoryClient()
        self.payment_client = PaymentClient()
        self.shipping_client = ShippingClient()

    def execute(self, order_data):
        saga = SagaCoordinator()

        # Step 1: åˆ›å»ºè®¢å•
        saga.add_step(SagaStep(
            name="create_order",
            execute=lambda: self.create_order(order_data),
            compensate=lambda: self.cancel_order(order_data['order_id'])
        ))

        # Step 2: æ‰£å‡åº“å­˜
        saga.add_step(SagaStep(
            name="reduce_inventory",
            execute=lambda: self.inventory_client.reduce(order_data['items']),
            compensate=lambda: self.inventory_client.restore(order_data['items'])
        ))

        # Step 3: æ‰£æ¬¾
        saga.add_step(SagaStep(
            name="charge_payment",
            execute=lambda: self.payment_client.charge(order_data['amount']),
            compensate=lambda: self.payment_client.refund(order_data['amount'])
        ))

        # Step 4: å‘è´§
        saga.add_step(SagaStep(
            name="ship_order",
            execute=lambda: self.shipping_client.ship(order_data['order_id']),
            compensate=lambda: self.shipping_client.cancel(order_data['order_id'])
        ))

        return saga.execute()
```

**æ€§èƒ½æ•°æ®**:

| æŒ‡æ ‡ | 2PC | Saga |
|-----|-----|------|
| å¹³å‡å»¶è¿Ÿ | 150ms | 80ms |
| ååé‡ | 500 TPS | 2000 TPS |
| å¯ç”¨æ€§ | 99.5% | 99.9% |

### æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿï¼ˆTCCæ¨¡å¼ï¼‰

**åœºæ™¯**: è·¨è¡Œè½¬è´¦ï¼Œéœ€è¦å¼ºä¸€è‡´æ€§

**TCCå®ç°**:

```rust
// è½¬è´¦Saga
struct TransferTCC {
    from_account: Arc<AccountService>,
    to_account: Arc<AccountService>,
    amount: u64,
}

impl TransferTCC {
    async fn execute(&self) -> Result<(), String> {
        let tcc = TCCTransaction::new();

        // Try: ä»è´¦æˆ·é¢„ç•™ï¼Œå‘è´¦æˆ·é¢„ç•™ï¼ˆæ¥æ”¶ï¼‰
        tcc.add_participant(self.from_account.clone(), self.amount);
        tcc.add_participant(self.to_account.clone(), self.amount);

        // æ‰§è¡ŒTCC
        tcc.execute().await?;

        Ok(())
    }
}
```

**æ•ˆæœ**: å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œè½¬è´¦æˆåŠŸç‡99.99%

---

## åã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: 2PCåè°ƒå™¨å•ç‚¹æ•…éšœ

**é”™è¯¯è®¾è®¡**:

```rust
// é”™è¯¯: åè°ƒå™¨æ— é«˜å¯ç”¨
struct Coordinator {
    // å•ç‚¹æ•…éšœ
}
```

**é—®é¢˜**: åè°ƒå™¨æ•…éšœå¯¼è‡´æ‰€æœ‰å‚ä¸è€…é˜»å¡

**æ­£ç¡®è®¾è®¡**:

```rust
// æ­£ç¡®: åè°ƒå™¨é«˜å¯ç”¨ï¼ˆRaftå…±è¯†ï¼‰
struct HighAvailabilityCoordinator {
    raft_cluster: RaftCluster,  // å¤šå‰¯æœ¬
    decision_log: WAL,  // æŒä¹…åŒ–å†³ç­–
}

impl HighAvailabilityCoordinator {
    async fn execute_transaction(&self, ops: Vec<Operation>) -> Result<bool, String> {
        // é€šè¿‡Raftå…±è¯†å†³ç­–
        let decision = self.raft_cluster.propose(ops).await?;
        // ...
    }
}
```

### åä¾‹2: Sagaè¡¥å¿ä¸å¹‚ç­‰

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: è¡¥å¿æ“ä½œä¸å¹‚ç­‰
def refund_payment(order_id):
    # å¦‚æœå¤šæ¬¡è°ƒç”¨ï¼Œä¼šé‡å¤é€€æ¬¾ï¼
    amount = get_order_amount(order_id)
    account.balance += amount
```

**é—®é¢˜**: é‡å¤è¡¥å¿å¯¼è‡´æ•°æ®é”™è¯¯

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: è¡¥å¿æ“ä½œå¹‚ç­‰
def refund_payment(order_id):
    # æ£€æŸ¥æ˜¯å¦å·²é€€æ¬¾
    if is_refunded(order_id):
        return  # å·²é€€æ¬¾ï¼Œç›´æ¥è¿”å›

    amount = get_order_amount(order_id)
    account.balance += amount
    mark_as_refunded(order_id)  # æ ‡è®°å·²é€€æ¬¾
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Rust/Pythonå®ç°ã€ç”Ÿäº§æ¡ˆä¾‹ã€åä¾‹åˆ†æ

**å…³è”æ–‡æ¡£**:

- `04-åˆ†å¸ƒå¼æ‰©å±•/01-åˆ†å¸ƒå¼MVCC(Percolator).md`
- `04-åˆ†å¸ƒå¼æ‰©å±•/03-å…±è¯†åè®®(Raft_Paxos).md`
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/04-CAPç†è®ºä¸æƒè¡¡.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md` (Sagaåº”ç”¨)
