# 03 | å­˜å‚¨å¼€é”€åˆ†æž

> **åˆ†æžå®šä½**: æœ¬æ–‡æ¡£æ·±åº¦é‡åŒ–åˆ†æžMVCCçš„å­˜å‚¨å¼€é”€ï¼ŒåŒ…å«ç†è®ºæŽ¨å¯¼ã€åä¾‹åˆ†æžã€å®žé™…æµ‹è¯•æ•°æ®å’Œä¼˜åŒ–ç­–ç•¥ã€‚

---

## ðŸ“‘ ç›®å½•

- [03 | å­˜å‚¨å¼€é”€åˆ†æž](#03--å­˜å‚¨å¼€é”€åˆ†æž)
  - [ðŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€å­˜å‚¨å¼€é”€ç†è®ºæ¨¡åž‹](#ä¸€å­˜å‚¨å¼€é”€ç†è®ºæ¨¡åž‹)
    - [1.1 å®Œæ•´æ•°å­¦æ¨¡åž‹](#11-å®Œæ•´æ•°å­¦æ¨¡åž‹)
    - [1.2 PostgreSQLå…ƒç»„ç»“æž„å¼€é”€](#12-postgresqlå…ƒç»„ç»“æž„å¼€é”€)
  - [äºŒã€ç‰ˆæœ¬é“¾å¼€é”€æ·±åº¦åˆ†æž](#äºŒç‰ˆæœ¬é“¾å¼€é”€æ·±åº¦åˆ†æž)
    - [2.1 ç‰ˆæœ¬ç´¯ç§¯å¾®åˆ†æ–¹ç¨‹](#21-ç‰ˆæœ¬ç´¯ç§¯å¾®åˆ†æ–¹ç¨‹)
    - [2.2 å®žé™…æ¡ˆä¾‹è®¡ç®—](#22-å®žé™…æ¡ˆä¾‹è®¡ç®—)
    - [2.3 ç‰ˆæœ¬é“¾å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“](#23-ç‰ˆæœ¬é“¾å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“)
  - [ä¸‰ã€ç´¢å¼•è†¨èƒ€æœºåˆ¶](#ä¸‰ç´¢å¼•è†¨èƒ€æœºåˆ¶)
    - [3.1 ç´¢å¼•è†¨èƒ€çš„æ ¹æº](#31-ç´¢å¼•è†¨èƒ€çš„æ ¹æº)
    - [3.2 HOTï¼ˆHeap-Only Tupleï¼‰ä¼˜åŒ–](#32-hotheap-only-tupleä¼˜åŒ–)
    - [3.3 Fillfactorä¼˜åŒ–](#33-fillfactorä¼˜åŒ–)
  - [å››ã€çœŸå®žæ¡ˆä¾‹åˆ†æž](#å››çœŸå®žæ¡ˆä¾‹åˆ†æž)
    - [æ¡ˆä¾‹1: æŸç”µå•†å…¬å¸è®¢å•è¡¨è†¨èƒ€](#æ¡ˆä¾‹1-æŸç”µå•†å…¬å¸è®¢å•è¡¨è†¨èƒ€)
  - [äº”ã€åä¾‹ä¸Žé”™è¯¯ä¼˜åŒ–](#äº”åä¾‹ä¸Žé”™è¯¯ä¼˜åŒ–)
    - [åä¾‹1: VACUUMä¸æ˜¯è¶Šé¢‘ç¹è¶Šå¥½](#åä¾‹1-vacuumä¸æ˜¯è¶Šé¢‘ç¹è¶Šå¥½)
    - [åä¾‹2: fillfactorè¶Šå°è¶Šå¥½ï¼Ÿ](#åä¾‹2-fillfactorè¶Šå°è¶Šå¥½)
  - [å…­ã€ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—](#å…­ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—)
    - [6.1 å†³ç­–æ ‘](#61-å†³ç­–æ ‘)
    - [6.2 ç›‘æŽ§SQLå·¥å…·åŒ…](#62-ç›‘æŽ§sqlå·¥å…·åŒ…)
  - [ä¸ƒã€å·¥å…·ä¸Žç›‘æŽ§](#ä¸ƒå·¥å…·ä¸Žç›‘æŽ§)
    - [7.1 pgstattupleæ‰©å±•](#71-pgstattupleæ‰©å±•)
    - [7.2 è‡ªåŠ¨åŒ–å‘Šè­¦](#72-è‡ªåŠ¨åŒ–å‘Šè­¦)
  - [å…«ã€å®Œæ•´å­˜å‚¨åˆ†æžå·¥å…·å®žçŽ°](#å…«å®Œæ•´å­˜å‚¨åˆ†æžå·¥å…·å®žçŽ°)
    - [8.1 ç‰ˆæœ¬é“¾é•¿åº¦åˆ†æžå·¥å…·](#81-ç‰ˆæœ¬é“¾é•¿åº¦åˆ†æžå·¥å…·)
    - [8.2 å­˜å‚¨è†¨èƒ€ç›‘æŽ§å·¥å…·](#82-å­˜å‚¨è†¨èƒ€ç›‘æŽ§å·¥å…·)
  - [ä¹ã€å®žé™…åº”ç”¨æ¡ˆä¾‹](#ä¹å®žé™…åº”ç”¨æ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹: è®¢å•è¡¨å­˜å‚¨ä¼˜åŒ–](#91-æ¡ˆä¾‹-è®¢å•è¡¨å­˜å‚¨ä¼˜åŒ–)
    - [9.2 æ¡ˆä¾‹: ç´¢å¼•è†¨èƒ€ä¼˜åŒ–](#92-æ¡ˆä¾‹-ç´¢å¼•è†¨èƒ€ä¼˜åŒ–)

---

## ä¸€ã€å­˜å‚¨å¼€é”€ç†è®ºæ¨¡åž‹

### 1.1 å®Œæ•´æ•°å­¦æ¨¡åž‹

**å®šç†1.1 (MVCCå­˜å‚¨æ€»å¼€é”€)**:

\[
Storage_{total} = Storage_{base} + Storage_{versions} + Storage_{indexes} + Storage_{overhead} + Storage_{WAL}
\]

**è¯¦ç»†æŽ¨å¯¼**:

**åŸºç¡€å­˜å‚¨**:
\[
Storage_{base} = \sum_{table} TupleSize \times RowCount_{active}
\]

**ç‰ˆæœ¬é“¾å­˜å‚¨**:
\[
Storage_{versions} = \sum_{table} TupleSize \times \sum_{row} (ChainLength_i - 1)
\]

**ç´¢å¼•å­˜å‚¨**ï¼ˆè€ƒè™‘è†¨èƒ€ï¼‰:
\[
Storage_{indexes} = \sum_{index} IndexEntrySize \times NumEntries \times (1 + BloatFactor)
\]

**å¼€é”€å…ƒæ•°æ®**ï¼ˆtuple header, page headerç­‰ï¼‰:
\[
Storage_{overhead} = \sum_{page} (PageHeaderSize + \sum_{tuple} TupleHeaderSize)
\]

**WALå½’æ¡£**ï¼ˆå¦‚æžœå¯ç”¨ï¼‰:
\[
Storage_{WAL} = WAL_{generation\_rate} \times Retention_{period}
\]

### 1.2 PostgreSQLå…ƒç»„ç»“æž„å¼€é”€

**å®Œæ•´å…ƒç»„ç»“æž„**ï¼ˆæºç åˆ†æžï¼‰:

```c
// src/include/access/htup_details.h
struct HeapTupleHeaderData {
    union {
        HeapTupleFields t_heap;  // xmin, xmax, cid, cmax
        DatumTupleFields t_datum;
    } t_choice;

    ItemPointerData t_ctid;  // 6 bytes: ç‰ˆæœ¬é“¾æŒ‡é’ˆ

    uint16 t_infomask2;      // 2 bytes: å±žæ€§æ•°é‡ç­‰
    uint16 t_infomask;       // 2 bytes: çŠ¶æ€æ ‡å¿—
    uint8  t_hoff;           // 1 byte: å¤´éƒ¨åç§»

    bits8  t_bits[FLEXIBLE_ARRAY_MEMBER];  // NULL bitmap
};

// æœ€å°å…ƒç»„å¤´éƒ¨ = 23 bytes
// åŠ ä¸Šå¯¹é½ = 24 bytes
```

**å®žé™…å¼€é”€è®¡ç®—**:

```sql
CREATE TABLE storage_test (
    id INTEGER,
    name VARCHAR(50),
    value BIGINT
);

-- å­—æ®µå¤§å°:
-- id: 4 bytes
-- name: æœ€å¤š50 bytes + 1 byte (é•¿åº¦)
-- value: 8 bytes

-- ç†è®ºæœ€å°: 4 + 51 + 8 = 63 bytes

-- å®žé™…å¤§å°:
INSERT INTO storage_test VALUES (1, 'test', 100);

SELECT pg_column_size(storage_test.*) AS tuple_size,
       pg_total_relation_size('storage_test') AS total_size
FROM storage_test;

-- ç»“æžœ: tuple_size = 93 bytes
-- ç»„æˆ: 24 (header) + 4 (id) + 51 (name) + 8 (value) + 6 (alignment) = 93
```

**å¼€é”€å æ¯”**:

- å¤´éƒ¨: 24 / 93 = **25.8%**ï¼ˆå›ºå®šå¼€é”€ï¼ï¼‰
- æ•°æ®: 63 / 93 = 67.7%
- å¯¹é½: 6 / 93 = 6.5%

**ç»“è®º**: å°å…ƒç»„çš„å…ƒæ•°æ®å¼€é”€å¾ˆæ˜¾è‘—

---

## äºŒã€ç‰ˆæœ¬é“¾å¼€é”€æ·±åº¦åˆ†æž

### 2.1 ç‰ˆæœ¬ç´¯ç§¯å¾®åˆ†æ–¹ç¨‹

**å»ºç«‹åŠ¨æ€æ¨¡åž‹**:

\[
\frac{dV(t)}{dt} = R_{update}(t) - R_{vacuum}(t)
\]

å…¶ä¸­:

- \(V(t)\): æ—¶åˆ»\(t\)çš„æ­»å…ƒç»„æ€»æ•°
- \(R_{update}(t)\): æ›´æ–°é€ŸçŽ‡ï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰
- \(R_{vacuum}(t)\): æ¸…ç†é€ŸçŽ‡

**ç¨³æ€è§£ï¼ˆå‡è®¾é€ŸçŽ‡æ’å®šï¼‰**:

\[
V_{steady} = R_{update} \times T_{vacuum}
\]

å…¶ä¸­\(T_{vacuum}\)æ˜¯VACUUMé—´éš”ã€‚

**æŽ¨å¯¼å¹³å‡é“¾é•¿**:

å‡è®¾æ›´æ–°å‡åŒ€åˆ†å¸ƒåœ¨\(N\)è¡Œï¼š

\[
AvgChainLength = 1 + \frac{V_{steady}}{N} = 1 + \frac{R_{update} \times T_{vacuum}}{N}
\]

### 2.2 å®žé™…æ¡ˆä¾‹è®¡ç®—

**æ¡ˆä¾‹1: ç”µå•†è®¢å•è¡¨**:

```sql
-- è¡¨ç»“æž„
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    status VARCHAR(20),  -- é¢‘ç¹æ›´æ–°
    amount DECIMAL(10,2),
    created_at TIMESTAMP
);

-- ä¸šåŠ¡å‚æ•°:
-- æ€»è®¢å•æ•°: N = 10,000,000 (1åƒä¸‡)
-- çŠ¶æ€æ›´æ–°é¢‘çŽ‡: 100/ç§’ (æ”¯ä»˜/å‘è´§/å®Œæˆ)
-- VACUUMé—´éš”: 60ç§’

-- è®¡ç®—:
AvgChainLength = 1 + (100 Ã— 60) / 10,000,000
               = 1 + 6000 / 10,000,000
               = 1.0006

-- å­˜å‚¨è†¨èƒ€: 1.0006Ã— (å‡ ä¹Žæ— è†¨èƒ€) âœ“
```

**æ¡ˆä¾‹2: ç¤¾äº¤å¸–å­è¡¨ï¼ˆç¾éš¾æ€§è†¨èƒ€ï¼‰**:

```sql
-- è¡¨ç»“æž„
CREATE TABLE posts (
    post_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    like_count INTEGER,  -- æžé«˜é¢‘æ›´æ–°ï¼
    comment_count INTEGER,
    content TEXT
);

-- ä¸šåŠ¡å‚æ•°:
-- æ€»å¸–å­æ•°: N = 1,000,000 (100ä¸‡çƒ­é—¨å¸–)
-- ç‚¹èµžæ›´æ–°: 10,000/ç§’ (çƒ­é—¨å¸–é¢‘ç¹æ›´æ–°)
-- VACUUMé—´éš”: 60ç§’

-- è®¡ç®—:
AvgChainLength = 1 + (10,000 Ã— 60) / 1,000,000
               = 1 + 600,000 / 1,000,000
               = 1.6

-- å­˜å‚¨è†¨èƒ€: 1.6Ã— (+60%å­˜å‚¨!) âš ï¸

-- å¦‚æžœVACUUMé—´éš”å»¶è¿Ÿåˆ°5åˆ†é’Ÿ:
AvgChainLength = 1 + (10,000 Ã— 300) / 1,000,000
               = 1 + 3 = 4

-- å­˜å‚¨è†¨èƒ€: 4Ã— (+300%!) ðŸ”´ ç¾éš¾ï¼
```

**çœŸå®žç›‘æŽ§æ•°æ®**:

```sql
-- æŸ¥è¯¢å®žé™…è†¨èƒ€æƒ…å†µ
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
       pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                     pg_relation_size(schemaname||'.'||tablename)) AS index_size,
       n_dead_tup,
       n_live_tup,
       ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC
LIMIT 10;

-- ç»“æžœç¤ºä¾‹:
-- postsè¡¨: 100ä¸‡æ´»å…ƒç»„, 250ä¸‡æ­»å…ƒç»„, è†¨èƒ€çŽ‡250% ðŸ”´
```

### 2.3 ç‰ˆæœ¬é“¾å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“

**å®šç†2.1**: ç‰ˆæœ¬é“¾è¶Šé•¿ï¼Œå…¨è¡¨æ‰«æè¶Šæ…¢

**è¯æ˜Ž**: é¡ºåºæ‰«æéœ€è¦æ£€æŸ¥æ¯ä¸ªå…ƒç»„å¯è§æ€§

\[
T_{scan} = \sum_{page} (T_{IO}(page) + \sum_{tuple \in page} T_{visibility}(tuple))
\]

ç‰ˆæœ¬é“¾é•¿åº¦ä¸º\(L\)æ—¶ï¼š

- æ­»å…ƒç»„æ•° = \(N \times (L-1)\)
- éœ€è¦æ£€æŸ¥çš„å…ƒç»„ = \(N \times L\)

\[
T_{scan}(L) = N \times L \times T_{visibility}
\]

**åä¾‹**: ç´¢å¼•æ‰«æä¸ä¸€å®šå¿«

```sql
-- åœºæ™¯: æŸ¥è¯¢æœ€è¿‘è®¢å•
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE created_at > NOW() - INTERVAL '1 day'
ORDER BY created_at DESC
LIMIT 100;

-- ç´¢å¼•æ‰«æç»“æžœ:
Index Scan using orders_created_at_idx
  -> è¯»å–105ä¸ªç´¢å¼•æ¡ç›®
  -> è®¿é—®105ä¸ªheapå…ƒç»„
  -> ä½†å…¶ä¸­80ä¸ªæ˜¯æ­»å…ƒç»„(ç‰ˆæœ¬é“¾)ï¼
  -> å®žé™…åªè¿”å›ž25ä¸ªæ´»å…ƒç»„
  -> éœ€è¦ç»§ç»­æ‰«æç›´åˆ°100ä¸ª

-- ç‰ˆæœ¬é“¾è¶Šé•¿ï¼Œç´¢å¼•æ‰«æè¶Šæ…¢ï¼
```

---

## ä¸‰ã€ç´¢å¼•è†¨èƒ€æœºåˆ¶

### 3.1 ç´¢å¼•è†¨èƒ€çš„æ ¹æº

**PostgreSQLç´¢å¼•ç‰¹ç‚¹**: ç´¢å¼•æ¡ç›®æŒ‡å‘æ¯ä¸ªå…ƒç»„ç‰ˆæœ¬

```text
UPDATEæ“ä½œå¯¹ç´¢å¼•çš„å½±å“:

åŽŸå§‹çŠ¶æ€:
Row(id=1, name='Alice') â†’ Index[1] â†’ TID(0,1)

UPDATE name='Bob':
â”œâ”€ åˆ›å»ºæ–°ç‰ˆæœ¬: TID(0,2)
â”œâ”€ æ—§ç‰ˆæœ¬(0,1): æ ‡è®°åˆ é™¤
â””â”€ æ–°ç´¢å¼•æ¡ç›®: Index[1] â†’ TID(0,2)

ç»“æžœ: ç´¢å¼•æœ‰2ä¸ªæ¡ç›®æŒ‡å‘åŒä¸€ä¸ªidï¼

å¤šæ¬¡UPDATEåŽ:
Index[1] â†’ TID(0,1) [dead]
Index[1] â†’ TID(0,2) [dead]
Index[1] â†’ TID(0,3) [dead]
Index[1] â†’ TID(0,4) [alive]

ç´¢å¼•è†¨èƒ€4å€ï¼
```

### 3.2 HOTï¼ˆHeap-Only Tupleï¼‰ä¼˜åŒ–

**HOTæœºåˆ¶**: å¦‚æžœæ›´æ–°çš„åˆ—ä¸åœ¨ç´¢å¼•ä¸­ï¼Œä¸”åŒä¸€é¡µæœ‰ç©ºé—´ï¼Œåˆ™åªæ›´æ–°heapï¼Œä¸æ›´æ–°ç´¢å¼•

**HOTæ¡ä»¶**:

1. æ›´æ–°çš„åˆ—ä¸åŒ…å«åœ¨**ä»»ä½•**ç´¢å¼•ä¸­
2. æ–°ç‰ˆæœ¬èƒ½æ”¾å…¥åŒä¸€ä¸ªpage
3. é¡µé¢æœ‰è¶³å¤Ÿfree space

**åä¾‹**: HOTå¤±æ•ˆçš„æƒ…å†µ

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255),
    name VARCHAR(100),
    age INTEGER,
    updated_at TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_name ON users(name);

-- æ›´æ–°ageï¼ˆä¸åœ¨ç´¢å¼•ä¸­ï¼‰
UPDATE users SET age = age + 1 WHERE id = 1;
-- HOT: âœ“ (ageä¸åœ¨ä»»ä½•ç´¢å¼•)

-- æ›´æ–°nameï¼ˆåœ¨ç´¢å¼•ä¸­ï¼‰
UPDATE users SET name = 'NewName' WHERE id = 1;
-- HOT: âœ— (nameåœ¨idx_users_name)
-- å¿…é¡»æ›´æ–°ç´¢å¼• â†’ ç´¢å¼•è†¨èƒ€

-- æ›´æ–°updated_atï¼ˆä¸åœ¨ç´¢å¼•ä½†...)
UPDATE users SET updated_at = NOW() WHERE id = 1;
-- HOT: âœ“ å¦‚æžœé¡µé¢æœ‰ç©ºé—´
-- HOT: âœ— å¦‚æžœé¡µé¢å·²æ»¡ï¼ˆéœ€è¦æ–°é¡µé¢ï¼‰
```

**HOTæ•ˆæžœé‡åŒ–**:

```sql
-- ç›‘æŽ§HOTæ•ˆæžœ
SELECT schemaname, tablename,
       n_tup_upd AS total_updates,
       n_tup_hot_upd AS hot_updates,
       ROUND(100.0 * n_tup_hot_upd / NULLIF(n_tup_upd, 0), 2) AS hot_ratio
FROM pg_stat_user_tables
ORDER BY n_tup_upd DESC;

-- ç»“æžœåˆ†æž:
-- hot_ratio > 90%: ä¼˜ç§€ âœ“
-- hot_ratio 50-90%: ä¸€èˆ¬
-- hot_ratio < 50%: å·® âš ï¸ (å¤§é‡ç´¢å¼•æ›´æ–°)
```

### 3.3 Fillfactorä¼˜åŒ–

**å®šç†3.1**: Fillfactorä¸º\(f\)æ—¶ï¼ŒHOTæ¦‚çŽ‡æå‡

```sql
-- é»˜è®¤fillfactor=100 (é¡µé¢å¡«æ»¡)
CREATE TABLE t1 (id INT, val INT);

-- UPDATEæ—¶:
-- é¡µé¢å·²æ»¡ â†’ æ–°ç‰ˆæœ¬å¿…é¡»åŽ»æ–°é¡µé¢ â†’ HOTå¤±æ•ˆ âœ—

-- ä¼˜åŒ–: é¢„ç•™20%ç©ºé—´
ALTER TABLE t1 SET (fillfactor = 80);

-- UPDATEæ—¶:
-- é¡µé¢æœ‰ç©ºé—´ â†’ æ–°ç‰ˆæœ¬åœ¨åŒé¡µ â†’ HOTæˆåŠŸ âœ“
```

**ä»£ä»·**: 20%ç©ºé—´æ¢å–HOT â†’ æ˜¯å¦å€¼å¾—ï¼Ÿ

**é‡åŒ–åˆ†æž**:

```text
åœºæ™¯: 100ä¸‡è¡Œè¡¨ï¼Œæ¯è¡Œ100 bytes

é»˜è®¤(fillfactor=100):
â”œâ”€ è¡¨å¤§å°: 100MB
â”œâ”€ HOTçŽ‡: 30%
â”œâ”€ ç´¢å¼•å¤§å°: 50MB + è†¨èƒ€35MB = 85MB
â””â”€ æ€»è®¡: 100MB + 85MB = 185MB

ä¼˜åŒ–(fillfactor=80):
â”œâ”€ è¡¨å¤§å°: 125MB (+25MB due to fillfactor)
â”œâ”€ HOTçŽ‡: 90% (æ˜¾è‘—æå‡)
â”œâ”€ ç´¢å¼•å¤§å°: 50MB + è†¨èƒ€5MB = 55MB (-30MB)
â””â”€ æ€»è®¡: 125MB + 55MB = 180MB (-5MB, -2.7%)

ç»“è®º: fillfactor=80å€¼å¾—ï¼
```

---

## å››ã€çœŸå®žæ¡ˆä¾‹åˆ†æž

### æ¡ˆä¾‹1: æŸç”µå•†å…¬å¸è®¢å•è¡¨è†¨èƒ€

**èƒŒæ™¯**:

- è®¢å•è¡¨1äº¿è¡Œ
- è®¢å•çŠ¶æ€é¢‘ç¹æ›´æ–°ï¼ˆå¾…æ”¯ä»˜â†’å·²æ”¯ä»˜â†’å·²å‘è´§â†’å·²å®Œæˆï¼‰
- é—®é¢˜: è¡¨ä»Ž200GBè†¨èƒ€åˆ°800GB

**è¯Šæ–­**:

```sql
-- æ£€æŸ¥è†¨èƒ€
SELECT pg_size_pretty(pg_total_relation_size('orders')) AS total,
       pg_size_pretty(pg_relation_size('orders')) AS table_only,
       n_dead_tup, n_live_tup,
       ROUND(100.0 * n_dead_tup / n_live_tup, 2) AS bloat_pct
FROM pg_stat_user_tables
WHERE tablename = 'orders';

-- ç»“æžœ:
-- total: 800GB
-- table_only: 750GB
-- dead_tup: 300,000,000
-- live_tup: 100,000,000
-- bloat_pct: 300% ðŸ”´

-- åˆ†æž:
-- 3äº¿æ­»å…ƒç»„ï¼å¹³å‡æ¯è¡Œæœ‰4ä¸ªç‰ˆæœ¬
-- VACUUMä¸åŠæ—¶å¯¼è‡´
```

**æ ¹å› **:

```sql
-- æ£€æŸ¥VACUUMåŽ†å²
SELECT schemaname, tablename,
       last_vacuum, last_autovacuum,
       n_tup_upd, n_tup_hot_upd
FROM pg_stat_user_tables
WHERE tablename = 'orders';

-- å‘çŽ°:
-- last_autovacuum: 3 hours ago
-- n_tup_upd: 50,000,000 (5åƒä¸‡æ¬¡æ›´æ–°)
-- n_tup_hot_upd: 5,000,000 (HOTçŽ‡ä»…10%ï¼)

-- é—®é¢˜1: VACUUMé—´éš”å¤ªé•¿ï¼ˆ3å°æ—¶ï¼‰
-- é—®é¢˜2: HOTçŽ‡æžä½Žï¼ˆstatuså­—æ®µæœ‰ç´¢å¼•ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: æé«˜VACUUMé¢‘çŽ‡
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- é»˜è®¤0.2
    autovacuum_vacuum_threshold = 5000
);

-- æ–¹æ¡ˆ2: æ‹†åˆ†çƒ­ç‚¹å­—æ®µ
CREATE TABLE order_status (
    order_id BIGINT PRIMARY KEY,
    status VARCHAR(20),
    updated_at TIMESTAMP
) WITH (fillfactor = 70);  -- é¢„ç•™30%ç©ºé—´ç»™HOT

-- ä¸»è¡¨åŽ»æŽ‰statuså­—æ®µå’Œç´¢å¼•
ALTER TABLE orders DROP COLUMN status;
DROP INDEX idx_orders_status;

-- æ–¹æ¡ˆ3: åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆï¼‰
CREATE TABLE orders_2025_01 PARTITION OF orders
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**æ•ˆæžœ**:

- è¡¨å¤§å°: 800GB â†’ 250GB (-68.8%)
- æŸ¥è¯¢æ€§èƒ½: +150%
- VACUUMæ—¶é—´: 4å°æ—¶ â†’ 20åˆ†é’Ÿ

---

## äº”ã€åä¾‹ä¸Žé”™è¯¯ä¼˜åŒ–

### åä¾‹1: VACUUMä¸æ˜¯è¶Šé¢‘ç¹è¶Šå¥½

**é”™è¯¯åšæ³•**:

```sql
-- è®¾ç½®è¶…é¢‘ç¹VACUUM
ALTER TABLE hot_table SET (
    autovacuum_vacuum_scale_factor = 0.001,
    autovacuum_vacuum_threshold = 10
);

-- åŽæžœ:
-- VACUUMæ¯10è¡Œæ›´æ–°å°±è§¦å‘
-- CPUå ç”¨90% (VACUUMè¿›ç¨‹)
-- æ­£å¸¸æŸ¥è¯¢è¢«é˜»å¡žï¼ˆVACUUMèŽ·å–ShareLockï¼‰
-- TPSä»Ž10000é™åˆ°3000 (-70%)
```

**åä¾‹æ•°æ®**:

```text
VACUUMé¢‘çŽ‡å¯¹æ¯”:

é¢‘çŽ‡: æ¯10ç§’
â”œâ”€ å¹³å‡è†¨èƒ€: 1.05Ã—
â”œâ”€ VACUUM CPU: 15%
â”œâ”€ TPS: 9000
â””â”€ è¯„ä»·: è‰¯å¥½ âœ“

é¢‘çŽ‡: æ¯1ç§’
â”œâ”€ å¹³å‡è†¨èƒ€: 1.01Ã—
â”œâ”€ VACUUM CPU: 45%
â”œâ”€ TPS: 6500 (-27.8%)
â””â”€ è¯„ä»·: è¿‡åº¦ä¼˜åŒ– âš ï¸

é¢‘çŽ‡: æ¯0.1ç§’
â”œâ”€ å¹³å‡è†¨èƒ€: 1.001Ã—
â”œâ”€ VACUUM CPU: 85%
â”œâ”€ TPS: 2000 (-77.8%)
â””â”€ è¯„ä»·: ç¾éš¾ ðŸ”´
```

**æ­£ç¡®åšæ³•**: å¹³è¡¡è†¨èƒ€çŽ‡å’ŒVACUUMå¼€é”€

\[
OptimalInterval = \sqrt{\frac{VacuumCost}{BloatCost}}
\]

### åä¾‹2: fillfactorè¶Šå°è¶Šå¥½ï¼Ÿ

**é”™è¯¯æ€è·¯**: "fillfactor=50é¢„ç•™50%ç©ºé—´ï¼ŒHOTè‚¯å®šå¥½"

**å®žé™…æµ‹è¯•**:

```sql
-- æµ‹è¯•è¡¨
CREATE TABLE filltest (id SERIAL, val INT, data TEXT);

-- æ’å…¥100ä¸‡è¡Œ
INSERT INTO filltest SELECT generate_series(1,1000000), 0, repeat('x', 50);

-- æµ‹è¯•ä¸åŒfillfactor
ALTER TABLE filltest SET (fillfactor = 100);
-- å¤§å°: 100MB
-- HOTçŽ‡: 30%
-- æŸ¥è¯¢: 120ms

ALTER TABLE filltest SET (fillfactor = 50);
VACUUM FULL;
-- å¤§å°: 200MB (+100%!)
-- HOTçŽ‡: 95%
-- æŸ¥è¯¢: 180ms (+50% æ›´æ…¢ï¼)

-- åŽŸå› : æ‰«æé¡µé¢æ•°ç¿»å€
```

**ç»“è®º**: fillfactor=70-80æ˜¯æœ€ä½³å¹³è¡¡ç‚¹

---

## å…­ã€ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—

### 6.1 å†³ç­–æ ‘

```text
å­˜å‚¨è†¨èƒ€é—®é¢˜åˆ†æž:

1. æ£€æŸ¥è†¨èƒ€çŽ‡
   n_dead_tup / n_live_tup > 0.2? â†’ YES â†’ ç»§ç»­
                                  â†’ NO â†’ æ— é—®é¢˜

2. æ£€æŸ¥HOTçŽ‡
   n_tup_hot_upd / n_tup_upd < 0.5? â†’ YES â†’ ç´¢å¼•è¿‡å¤šæˆ–fillfactor=100
                                    â†’ NO â†’ ç»§ç»­

3. æ£€æŸ¥VACUUMé¢‘çŽ‡
   last_autovacuum > 1å°æ—¶? â†’ YES â†’ æé«˜VACUUMé¢‘çŽ‡
                           â†’ NO â†’ æ›´æ–°é€ŸçŽ‡è¿‡é«˜

4. ä¼˜åŒ–æ–¹æ¡ˆ:
   â”œâ”€ HOTçŽ‡ä½Ž â†’ å‡å°‘ç´¢å¼•ã€é™ä½Žfillfactor
   â”œâ”€ VACUUMæ…¢ â†’ åˆ†åŒºè¡¨ã€å¹¶è¡ŒVACUUM
   â””â”€ æ›´æ–°è¿‡å¿« â†’ æ‹†åˆ†çƒ­ç‚¹å­—æ®µã€ç¼“å­˜
```

### 6.2 ç›‘æŽ§SQLå·¥å…·åŒ…

```sql
-- å®Œæ•´ç›‘æŽ§è„šæœ¬
CREATE OR REPLACE VIEW storage_health AS
SELECT
    schemaname || '.' || tablename AS table_name,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    n_live_tup,
    n_dead_tup,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup, 0), 2) AS bloat_pct,
    ROUND(100.0 * n_tup_hot_upd / NULLIF(n_tup_upd, 0), 2) AS hot_pct,
    last_vacuum,
    last_autovacuum,
    CASE
        WHEN n_dead_tup::FLOAT / NULLIF(n_live_tup, 0) > 0.5 THEN 'ðŸ”´ Critical'
        WHEN n_dead_tup::FLOAT / NULLIF(n_live_tup, 0) > 0.2 THEN 'ðŸŸ¡ Warning'
        ELSE 'ðŸŸ¢ Good'
    END AS health_status
FROM pg_stat_user_tables
WHERE n_live_tup > 1000
ORDER BY n_dead_tup DESC;

-- ä½¿ç”¨
SELECT * FROM storage_health WHERE health_status != 'ðŸŸ¢ Good';
```

---

## ä¸ƒã€å·¥å…·ä¸Žç›‘æŽ§

### 7.1 pgstattupleæ‰©å±•

```sql
-- å®‰è£…
CREATE EXTENSION pgstattuple;

-- è¯¦ç»†è†¨èƒ€åˆ†æž
SELECT * FROM pgstattuple('orders');

-- ç»“æžœè§£è¯»:
-- table_len: ç‰©ç†å¤§å°
-- tuple_count: æ´»å…ƒç»„æ•°
-- tuple_len: æ´»å…ƒç»„æ€»å­—èŠ‚
-- dead_tuple_count: æ­»å…ƒç»„æ•°
-- free_space: å¯ç”¨ç©ºé—´
-- è†¨èƒ€çŽ‡ = (table_len - tuple_len) / table_len
```

### 7.2 è‡ªåŠ¨åŒ–å‘Šè­¦

```python
import psycopg2

def check_bloat_alert(conn, threshold=0.3):
    """æ£€æµ‹è¡¨è†¨èƒ€å¹¶å‘Šè­¦"""
    cur = conn.cursor()

    cur.execute("""
        SELECT tablename,
               n_dead_tup,
               n_live_tup,
               n_dead_tup::FLOAT / NULLIF(n_live_tup, 0) AS bloat_ratio
        FROM pg_stat_user_tables
        WHERE n_live_tup > 10000
          AND n_dead_tup::FLOAT / NULLIF(n_live_tup, 0) > %s
        ORDER BY bloat_ratio DESC
    """, (threshold,))

    alerts = []
    for row in cur.fetchall():
        table, dead, live, ratio = row
        alerts.append({
            'table': table,
            'dead_tuples': dead,
            'live_tuples': live,
            'bloat_ratio': f"{ratio*100:.1f}%",
            'action': 'VACUUM ANALYZE' if ratio < 0.5 else 'VACUUM FULL'
        })

    return alerts

# ä½¿ç”¨
alerts = check_bloat_alert(conn, threshold=0.2)
for alert in alerts:
    print(f"âš ï¸ {alert['table']}: {alert['bloat_ratio']} bloat")
    print(f"   Action: {alert['action']}")
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®žï¼‰
**æœ€åŽæ›´æ–°**: 2025-12-05
**æ–°å¢žå†…å®¹**: å¾®åˆ†æ–¹ç¨‹æ¨¡åž‹ã€çœŸå®žæ¡ˆä¾‹ã€åä¾‹åˆ†æžã€å®Œæ•´å·¥å…·

**å…³è”æ–‡æ¡£**:

- `02-è®¾è®¡æƒè¡¡åˆ†æž/05-å­˜å‚¨-å¹¶å‘æƒè¡¡.md`
- `05-å®žçŽ°æœºåˆ¶/03-PostgreSQL-VACUUMæœºåˆ¶.md`
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/05-IoTæ—¶åºæ•°æ®.md` (å¤§è¡¨ç®¡ç†)

**å‚è€ƒ**:

- PostgreSQLæºç : `src/backend/access/heap/`
- pgstattupleæ–‡æ¡£: <https://www.postgresql.org/docs/current/pgstattuple.html>
