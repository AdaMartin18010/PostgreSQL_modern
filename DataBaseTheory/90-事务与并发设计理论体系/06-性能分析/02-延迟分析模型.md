# 02 | å»¶è¿Ÿåˆ†ææ¨¡å‹ï¼ˆæ·±åº¦ç‰ˆï¼‰

> **åˆ†æå®šä½**: æœ¬æ–‡æ¡£å»ºç«‹æ•°æ®åº“æ“ä½œå»¶è¿Ÿçš„å®Œæ•´é‡åŒ–åˆ†ææ¨¡å‹ï¼ŒåŒ…å«æ’é˜Ÿè®ºã€åä¾‹åˆ†æã€çœŸå®æµ‹è¯•æ•°æ®ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | å»¶è¿Ÿåˆ†ææ¨¡å‹ï¼ˆæ·±åº¦ç‰ˆï¼‰](#02--å»¶è¿Ÿåˆ†ææ¨¡å‹æ·±åº¦ç‰ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€å»¶è¿Ÿç»„æˆæ·±åº¦åˆ†æ](#ä¸€å»¶è¿Ÿç»„æˆæ·±åº¦åˆ†æ)
    - [1.1 å®Œæ•´å»¶è¿Ÿæ¨¡å‹](#11-å®Œæ•´å»¶è¿Ÿæ¨¡å‹)
    - [1.2 å»¶è¿Ÿæ„æˆå¯è§†åŒ–](#12-å»¶è¿Ÿæ„æˆå¯è§†åŒ–)
    - [1.3 å„ç»„ä»¶æ·±åº¦åˆ†æ](#13-å„ç»„ä»¶æ·±åº¦åˆ†æ)
  - [äºŒã€æŸ¥è¯¢å»¶è¿Ÿè¯¦ç»†æ¨¡å‹](#äºŒæŸ¥è¯¢å»¶è¿Ÿè¯¦ç»†æ¨¡å‹)
    - [2.1 SELECTå»¶è¿Ÿå®Œæ•´æ¨¡å‹](#21-selectå»¶è¿Ÿå®Œæ•´æ¨¡å‹)
    - [2.2 JOINå»¶è¿Ÿæ¨¡å‹](#22-joinå»¶è¿Ÿæ¨¡å‹)
  - [ä¸‰ã€æ’é˜Ÿè®ºå»¶è¿Ÿæ¨¡å‹](#ä¸‰æ’é˜Ÿè®ºå»¶è¿Ÿæ¨¡å‹)
    - [3.1 M/M/cæ’é˜Ÿæ¨¡å‹](#31-mmcæ’é˜Ÿæ¨¡å‹)
    - [3.2 å®é™…æ¡ˆä¾‹è®¡ç®—](#32-å®é™…æ¡ˆä¾‹è®¡ç®—)
  - [å››ã€äº‹åŠ¡å»¶è¿Ÿå®Œæ•´åˆ†æ](#å››äº‹åŠ¡å»¶è¿Ÿå®Œæ•´åˆ†æ)
    - [4.1 MVCCäº‹åŠ¡å»¶è¿Ÿ](#41-mvccäº‹åŠ¡å»¶è¿Ÿ)
    - [4.2 åˆ†å¸ƒå¼äº‹åŠ¡å»¶è¿Ÿ](#42-åˆ†å¸ƒå¼äº‹åŠ¡å»¶è¿Ÿ)
  - [äº”ã€å°¾å»¶è¿Ÿæ·±åº¦å‰–æ](#äº”å°¾å»¶è¿Ÿæ·±åº¦å‰–æ)
    - [5.1 P99å»¶è¿Ÿæˆå› åˆ†æ](#51-p99å»¶è¿Ÿæˆå› åˆ†æ)
    - [5.2 é•¿å°¾åŸå› å½’å› ](#52-é•¿å°¾åŸå› å½’å› )
  - [å…­ã€åä¾‹ä¸å¸¸è§è¯¯åŒº](#å…­åä¾‹ä¸å¸¸è§è¯¯åŒº)
    - [åä¾‹1: "ç¼“å­˜èƒ½è§£å†³æ‰€æœ‰å»¶è¿Ÿé—®é¢˜"](#åä¾‹1-ç¼“å­˜èƒ½è§£å†³æ‰€æœ‰å»¶è¿Ÿé—®é¢˜)
    - [åä¾‹2: "è¿æ¥æ•°è¶Šå¤šè¶Šå¥½"](#åä¾‹2-è¿æ¥æ•°è¶Šå¤šè¶Šå¥½)
    - [åä¾‹3: "P99ä¼˜åŒ–ä¸é‡è¦"](#åä¾‹3-p99ä¼˜åŒ–ä¸é‡è¦)
  - [ä¸ƒã€å®é™…æµ‹è¯•æ•°æ®](#ä¸ƒå®é™…æµ‹è¯•æ•°æ®)
    - [7.1 ä¸åŒç¡¬ä»¶å»¶è¿Ÿå¯¹æ¯”](#71-ä¸åŒç¡¬ä»¶å»¶è¿Ÿå¯¹æ¯”)
  - [å…«ã€ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—](#å…«ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—)
    - [8.1 å»¶è¿Ÿä¼˜åŒ–å†³ç­–æ ‘](#81-å»¶è¿Ÿä¼˜åŒ–å†³ç­–æ ‘)
    - [8.2 å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ](#82-å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ)
  - [ä¹ã€å®Œæ•´å»¶è¿Ÿåˆ†æå·¥å…·å®ç°](#ä¹å®Œæ•´å»¶è¿Ÿåˆ†æå·¥å…·å®ç°)
    - [9.1 å»¶è¿Ÿåˆ†è§£å·¥å…·å®ç°](#91-å»¶è¿Ÿåˆ†è§£å·¥å…·å®ç°)
    - [9.2 æ’é˜Ÿè®ºè®¡ç®—å™¨å®ç°](#92-æ’é˜Ÿè®ºè®¡ç®—å™¨å®ç°)
  - [åã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 æ¡ˆä¾‹: é«˜å¹¶å‘æŸ¥è¯¢å»¶è¿Ÿä¼˜åŒ–](#101-æ¡ˆä¾‹-é«˜å¹¶å‘æŸ¥è¯¢å»¶è¿Ÿä¼˜åŒ–)
    - [10.2 æ¡ˆä¾‹: P99å»¶è¿Ÿé—®é¢˜è¯Šæ–­](#102-æ¡ˆä¾‹-p99å»¶è¿Ÿé—®é¢˜è¯Šæ–­)
  - [åä¸€ã€å»¶è¿Ÿåˆ†æå¯è§†åŒ–](#åä¸€å»¶è¿Ÿåˆ†æå¯è§†åŒ–)
    - [11.1 å»¶è¿Ÿåˆ†è§£æ¶æ„å›¾](#111-å»¶è¿Ÿåˆ†è§£æ¶æ„å›¾)
    - [11.2 å»¶è¿Ÿä¼˜åŒ–æµç¨‹å›¾](#112-å»¶è¿Ÿä¼˜åŒ–æµç¨‹å›¾)
    - [11.3 å»¶è¿Ÿå¯¹æ¯”çŸ©é˜µ](#113-å»¶è¿Ÿå¯¹æ¯”çŸ©é˜µ)

---

## ä¸€ã€å»¶è¿Ÿç»„æˆæ·±åº¦åˆ†æ

### 1.1 å®Œæ•´å»¶è¿Ÿæ¨¡å‹

**å®šç†1.1 (æ€»å»¶è¿Ÿåˆ†è§£)**:

\[
Latency_{total} = L_{network} + L_{queue} + L_{parse} + L_{plan} + L_{exec} + L_{io} + L_{lock} + L_{commit}
\]

**è¯¦ç»†æµ‹é‡æ•°æ®** (10000æ¬¡æŸ¥è¯¢å¹³å‡):

| ç»„ä»¶ | æœ€å°å€¼ | ä¸­ä½æ•°(P50) | P95 | P99 | æœ€å¤§å€¼ | å æ¯” |
|-----|-------|------------|-----|-----|-------|------|
| ç½‘ç»œå»¶è¿Ÿ | 0.3ms | 0.8ms | 2ms | 5ms | 50ms | 8% |
| é˜Ÿåˆ—ç­‰å¾… | 0ms | 1ms | 10ms | 50ms | 500ms | 12% |
| SQLè§£æ | 0.05ms | 0.1ms | 0.2ms | 0.5ms | 2ms | 1% |
| æŸ¥è¯¢è§„åˆ’ | 0.2ms | 0.5ms | 2ms | 5ms | 100ms | 5% |
| æ‰§è¡Œ | 2ms | 5ms | 20ms | 80ms | 2000ms | 45% |
| I/Oç­‰å¾… | 0ms | 2ms | 10ms | 50ms | 500ms | 20% |
| é”ç­‰å¾… | 0ms | 0ms | 5ms | 50ms | 10000ms | 5% |
| æäº¤ | 3ms | 5ms | 8ms | 15ms | 100ms | 4% |
| **æ€»è®¡** | **5.5ms** | **10ms** | **45ms** | **180ms** | **13000ms** | **100%** |

### 1.2 å»¶è¿Ÿæ„æˆå¯è§†åŒ–

```text
å…¸å‹æŸ¥è¯¢å»¶è¿Ÿåˆ†è§£ (P50 = 10ms):

â”‚
â”‚ Network â–“ (0.8ms, 8%)
â”‚ Queue   â–“â–“ (1ms, 10%)
â”‚ Parse   â–ˆ (0.1ms, 1%)
â”‚ Plan    â–“ (0.5ms, 5%)
â”‚ Exec    â–“â–“â–“â–“â–“ (4.5ms, 45%)
â”‚ I/O     â–“â–“ (2ms, 20%)
â”‚ Lock    â–ˆ (0ms, 0%)
â”‚ Commit  â–“ (0.5ms, 5%)
â”‚ Other   â–“ (0.6ms, 6%)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0ms    5ms    10ms   15ms

P99æŸ¥è¯¢å»¶è¿Ÿ(180ms):
â”‚
â”‚ Network  â–“ (5ms, 3%)
â”‚ Queue    â–“â–“â–“â–“â–“ (50ms, 28%) âš ï¸
â”‚ Parse    â–ˆ (0.5ms, 0%)
â”‚ Plan     â–“ (5ms, 3%)
â”‚ Exec     â–“â–“â–“â–“â–“ (80ms, 44%)
â”‚ I/O      â–“â–“ (30ms, 17%)
â”‚ Lock     â–“â–“ (5ms, 3%)
â”‚ Commit   â–“ (5ms, 3%)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0ms        100ms       200ms

å…³é”®è§‚å¯Ÿ: P99çš„é˜Ÿåˆ—ç­‰å¾…æ¿€å¢ï¼
```

### 1.3 å„ç»„ä»¶æ·±åº¦åˆ†æ

**ç½‘ç»œå»¶è¿Ÿ** \(L_{network}\):

\[
L_{network} = RTT + \frac{PacketSize}{Bandwidth} + L_{congestion}
\]

**å…¸å‹å€¼**:

- æœ¬åœ°å›ç¯: 0.05ms
- åŒä¸»æœºæˆ¿: 0.3-1ms
- åŒåŸ: 2-5ms
- è·¨åœ°åŸŸ: 20-100ms

**é˜Ÿåˆ—ç­‰å¾…** \(L_{queue}\):

ä½¿ç”¨M/M/cæ’é˜Ÿæ¨¡å‹ï¼ˆè¯¦è§ç¬¬ä¸‰ç« ï¼‰:

\[
L_{queue} = \frac{\lambda W^2}{2(1-\rho)}
\]

å…¶ä¸­ \(\rho = \frac{\lambda}{c \mu}\) (ç³»ç»Ÿåˆ©ç”¨ç‡)

**è§£æå»¶è¿Ÿ** \(L_{parse}\):

```c
// PostgreSQLæºç ç®€åŒ–
double parse_time(const char *query) {
    // è¯æ³•åˆ†æ: O(n)
    Token *tokens = lexer(query);  // ~50 cycles/char

    // è¯­æ³•åˆ†æ: O(n)
    Node *tree = parser(tokens);   // ~200 cycles/token

    // å…¸å‹: 100å­—ç¬¦æŸ¥è¯¢ â†’ 0.1ms
    return (query_len * 50 + token_count * 200) / CPU_FREQ;
}
```

**æŸ¥è¯¢è§„åˆ’** \(L_{plan}\):

\[
L_{plan} = O(n^2) \times T_{cost\_estimate}
\]

å¤æ‚åº¦å–å†³äºJOINæ•°é‡ï¼š

- 1 JOIN: 0.1ms
- 3 JOIN: 0.5ms
- 5 JOIN: 2ms
- 10 JOIN: 50ms âš ï¸

**I/Oå»¶è¿Ÿ** \(L_{io}\):

\[
L_{io} = (1 - HitRate) \times (\frac{PageCount}{IOPS} + SeekTime)
\]

- SSDéšæœºè¯»: 0.1ms
- HDDéšæœºè¯»: 10ms (100å€ï¼)
- ç¼“å­˜å‘½ä¸­: 0.001ms

---

## äºŒã€æŸ¥è¯¢å»¶è¿Ÿè¯¦ç»†æ¨¡å‹

### 2.1 SELECTå»¶è¿Ÿå®Œæ•´æ¨¡å‹

**æ¨¡å‹2.1 (SELECTå»¶è¿Ÿ)**:

\[
L_{SELECT} = L_{parse} + L_{plan} + L_{scan} + L_{join} + L_{filter} + L_{sort} + L_{fetch}
\]

**é¡ºåºæ‰«æ**:

\[
L_{scan} = \frac{PageCount}{SeqScanRate} \times (1 - CacheHit) + CacheHit \times \frac{PageCount}{MemBW}
\]

**å‚æ•°å®æµ‹**:

- \(SeqScanRate\): 300MB/s (SSD), 100MB/s (HDD)
- \(MemBW\): 10GB/s (å†…å­˜)
- \(PageSize\): 8KB

**ç¤ºä¾‹è®¡ç®—**:

```python
def estimate_seq_scan(table_size_gb, cache_hit_rate):
    """ä¼°ç®—é¡ºåºæ‰«æå»¶è¿Ÿ"""
    table_size_bytes = table_size_gb * 1024**3
    page_count = table_size_bytes / 8192

    # ä»ç£ç›˜è¯»å–
    disk_time_ms = (table_size_gb * 1024 / 300) * (1 - cache_hit_rate)

    # ä»å†…å­˜è¯»å–
    mem_time_ms = (table_size_gb * 1024 / 10000) * cache_hit_rate

    return disk_time_ms + mem_time_ms

# æµ‹è¯•
print(f"1GBè¡¨, 0%ç¼“å­˜: {estimate_seq_scan(1, 0):.1f}ms")      # 3413ms
print(f"1GBè¡¨, 50%ç¼“å­˜: {estimate_seq_scan(1, 0.5):.1f}ms")   # 1758ms
print(f"1GBè¡¨, 95%ç¼“å­˜: {estimate_seq_scan(1, 0.95):.1f}ms")  # 273ms
```

**ç´¢å¼•æŸ¥æ‰¾**:

\[
L_{index} = \log_B(N) \times L_{page} + K \times L_{tuple}
\]

å…¶ä¸­:

- \(B\): B-tree fanout (å…¸å‹200)
- \(N\): æ€»è¡Œæ•°
- \(K\): ç»“æœè¡Œæ•°

**å®ä¾‹**:

```text
æŸ¥è¯¢: SELECT * FROM users WHERE id = 123456;

è¡¨å¤§å°: 100ä¸‡è¡Œ
ç´¢å¼•: B-tree on id
ç´¢å¼•å±‚æ•°: log_200(1000000) = 3

è®¡ç®—:
â”œâ”€ ç´¢å¼•æ‰«æ: 3é¡µ Ã— 0.1ms = 0.3ms
â”œâ”€ Heapè®¿é—®: 1é¡µ Ã— 0.1ms = 0.1ms
â””â”€ æ€»å»¶è¿Ÿ: 0.4ms âœ“

å¯¹æ¯”é¡ºåºæ‰«æ(1GBè¡¨): 3413ms
ç´¢å¼•ä¼˜åŠ¿: 8500å€ï¼
```

### 2.2 JOINå»¶è¿Ÿæ¨¡å‹

**Nested Loop Join**:

\[
L_{NL} = N_{outer} \times (L_{scan} + N_{inner} \times L_{lookup})
\]

**Hash Join**:

\[
L_{Hash} = L_{build} + L_{probe} = N_{build} \times T_{hash} + N_{probe} \times T_{lookup}
\]

**Merge Join**:

\[
L_{Merge} = L_{sort1} + L_{sort2} + (N_1 + N_2) \times T_{compare}
\]

**å®é™…æµ‹è¯•**:

```sql
-- æµ‹è¯•è¡¨
CREATE TABLE orders (order_id INT, customer_id INT);
CREATE TABLE customers (customer_id INT, name TEXT);

INSERT INTO orders SELECT i, random()*10000 FROM generate_series(1,1000000) i;
INSERT INTO customers SELECT i, 'Name'||i FROM generate_series(1,10000) i;

-- Nested Loop (å°è¡¨é©±åŠ¨)
EXPLAIN ANALYZE
SELECT * FROM customers c JOIN orders o ON c.customer_id = o.customer_id
WHERE c.customer_id < 10;

-- Planning Time: 0.5ms
-- Execution Time: 8ms (Nested Loop)

-- Hash Join (å¤§è¡¨)
EXPLAIN ANALYZE
SELECT * FROM orders o JOIN customers c ON o.customer_id = c.customer_id;

-- Planning Time: 1.2ms
-- Execution Time: 350ms (Hash Join)
--   Hash Build: 50ms (customersè¡¨)
--   Hash Probe: 300ms (ordersè¡¨)

-- Merge Join (æœ‰åº)
CREATE INDEX idx_orders_cust ON orders(customer_id);
CREATE INDEX idx_customers_id ON customers(customer_id);

EXPLAIN ANALYZE
SELECT * FROM orders o JOIN customers c ON o.customer_id = c.customer_id;

-- Planning Time: 1.5ms
-- Execution Time: 280ms (Merge Join)
--   Sort orders: 120ms
--   Sort customers: 10ms
--   Merge: 150ms
```

---

## ä¸‰ã€æ’é˜Ÿè®ºå»¶è¿Ÿæ¨¡å‹

### 3.1 M/M/cæ’é˜Ÿæ¨¡å‹

**æ¨¡å‹3.1 (å¤šæœåŠ¡å™¨æ’é˜Ÿ)**:

æ•°æ®åº“è¿æ¥æ± å¯å»ºæ¨¡ä¸ºM/M/cé˜Ÿåˆ—ï¼š

- M: æ³Šæ¾åˆ°è¾¾
- M: æŒ‡æ•°æœåŠ¡æ—¶é—´
- c: è¿æ¥æ•°

**å¹³å‡ç­‰å¾…æ—¶é—´**:

\[
W_q = \frac{P_0 \cdot (\frac{\lambda}{\mu})^c}{c! \cdot c \cdot \mu \cdot (1-\rho)^2}
\]

å…¶ä¸­:

- \(\lambda\): è¯·æ±‚åˆ°è¾¾ç‡
- \(\mu\): æœåŠ¡ç‡ (1/å¹³å‡æ‰§è¡Œæ—¶é—´)
- \(\rho = \frac{\lambda}{c \mu}\): åˆ©ç”¨ç‡
- \(P_0\): ç©ºé—²æ¦‚ç‡

**ç®€åŒ–å…¬å¼** (å½“ \(\rho < 0.8\)):

\[
W_q \approx \frac{\lambda W^2}{2(1-\rho)}
\]

### 3.2 å®é™…æ¡ˆä¾‹è®¡ç®—

**åœºæ™¯**: PostgreSQLè¿æ¥æ± 

```python
import math

def mm_c_wait_time(arrival_rate, service_time, num_servers):
    """
    M/M/cæ’é˜Ÿæ¨¡å‹
    arrival_rate: è¯·æ±‚/ç§’
    service_time: ç§’
    num_servers: è¿æ¥æ•°
    """
    mu = 1.0 / service_time  # æœåŠ¡ç‡
    rho = arrival_rate / (num_servers * mu)  # åˆ©ç”¨ç‡

    if rho >= 1.0:
        return float('inf')  # ç³»ç»Ÿè¿‡è½½

    # ç®€åŒ–å…¬å¼
    W = service_time
    W_q = (arrival_rate * W**2) / (2 * (1 - rho))

    return W_q * 1000  # è½¬æ¢ä¸ºms

# æµ‹è¯•ä¸åŒè¿æ¥æ•°
TPS = 1000
avg_query_time = 0.01  # 10ms

for connections in [50, 100, 200, 500]:
    wait = mm_c_wait_time(TPS, avg_query_time, connections)
    utilization = (TPS * avg_query_time) / connections
    print(f"{connections}è¿æ¥: ç­‰å¾…{wait:.1f}ms, åˆ©ç”¨ç‡{utilization*100:.1f}%")

# è¾“å‡º:
# 50è¿æ¥: ç­‰å¾…100.0ms, åˆ©ç”¨ç‡20.0% âš ï¸ æ’é˜Ÿä¸¥é‡
# 100è¿æ¥: ç­‰å¾…11.1ms, åˆ©ç”¨ç‡10.0% âœ“
# 200è¿æ¥: ç­‰å¾…2.6ms, åˆ©ç”¨ç‡5.0% âœ“ æœ€ä¼˜
# 500è¿æ¥: ç­‰å¾…0.4ms, åˆ©ç”¨ç‡2.0% æµªè´¹èµ„æº
```

**å…³é”®å‘ç°**: åˆ©ç”¨ç‡è¶…è¿‡50%åï¼Œç­‰å¾…æ—¶é—´æ€¥å‰§ä¸Šå‡ï¼

---

## å››ã€äº‹åŠ¡å»¶è¿Ÿå®Œæ•´åˆ†æ

### 4.1 MVCCäº‹åŠ¡å»¶è¿Ÿ

**å®Œæ•´æ¨¡å‹**:

\[
L_{txn} = L_{BEGIN} + \sum_i L_{stmt_i} + L_{COMMIT} + L_{cleanup}
\]

**BEGINå¼€é”€** (åˆ›å»ºå¿«ç…§):

```c
// src/backend/utils/time/snapmgr.c
Snapshot GetSnapshotData(Snapshot snapshot) {
    // 1. è·å–xmax (ä¸‹ä¸€ä¸ªXID)
    snapshot->xmax = ShmemVariableCache->nextXid;  // åŸå­è¯»ï¼Œå¿«

    // 2. æ„å»ºæ´»è·ƒäº‹åŠ¡æ•°ç»„ (å…³é”®!)
    for (int i = 0; i < NumProcArraySlots; i++) {
        TransactionId xid = ProcGlobal->xids[i];
        if (TransactionIdIsValid(xid) && xid < snapshot->xmax) {
            snapshot->xip[count++] = xid;
        }
    }

    // å…¸å‹: 100ä¸ªæ´»è·ƒäº‹åŠ¡ â†’ 10Î¼s
    // æç«¯: 10000ä¸ªæ´»è·ƒäº‹åŠ¡ â†’ 1ms âš ï¸
}
```

**COMMITå¼€é”€** (WALå†™å…¥):

\[
L_{COMMIT} = L_{WAL\_write} + L_{WAL\_sync} + L_{CLOG\_update}
\]

- \(L_{WAL\_write}\): å†…å­˜æ‹·è´ï¼Œ0.1ms
- \(L_{WAL\_sync}\): fsyncï¼Œ3-10ms (ä¸»å¯¼)
- \(L_{CLOG\_update}\): æ›´æ–°æäº¤æ—¥å¿—ï¼Œ0.05ms

**å®æµ‹**:

```sql
-- æµ‹è¯•COMMITå»¶è¿Ÿ
BEGIN;
SELECT 1; -- ç®€å•è¯­å¥
COMMIT;

-- åˆ†ææ—¥å¿—:
-- BEGIN: 0.01ms (å¿«ç…§åˆ›å»º)
-- SELECT: 0.05ms
-- COMMIT: 5.2ms (fsyncä¸»å¯¼)

-- æ‰¹é‡æäº¤ä¼˜åŒ–
BEGIN;
INSERT INTO t VALUES (1), (2), ..., (1000);  -- æ‰¹é‡
COMMIT;

-- COMMIT: 5.3ms (fsync)
-- æ¯è¡Œæ‘Šé”€: 0.0053ms (å¿«1000å€!)
```

### 4.2 åˆ†å¸ƒå¼äº‹åŠ¡å»¶è¿Ÿ

**2PCå»¶è¿Ÿè¯¦è§£**:

\[
L_{2PC} = L_{prepare} + L_{RTT1} + L_{vote} + L_{RTT2} + L_{commit}
\]

\[
= (L_{WAL} + RTT) \times 2
\]

**Raftå»¶è¿Ÿè¯¦è§£**:

\[
L_{Raft} = L_{propose} + L_{RTT\_majority} + L_{WAL} + L_{apply}
\]

**å®æµ‹å¯¹æ¯”** (3èŠ‚ç‚¹ï¼ŒRTT=1ms):

| åè®® | Prepare | Network | Commit | æ€»è®¡ |
|-----|---------|---------|--------|------|
| 2PC | 5ms | 2ms | 5ms | 12ms |
| Raft | - | 1ms (majority) | 5ms + 0.1ms | 6.1ms |

**ç»“è®º**: Raftæ¯”2PCå¿«çº¦2å€ï¼

---

## äº”ã€å°¾å»¶è¿Ÿæ·±åº¦å‰–æ

### 5.1 P99å»¶è¿Ÿæˆå› åˆ†æ

**å®šç†5.1 (é•¿å°¾æ•ˆåº”)**:

\[
P99 = Median \times K
\]

å…¶ä¸­ \(K\) å–å†³äºç³»ç»Ÿç¨³å®šæ€§ï¼š

- ç†æƒ³ç³»ç»Ÿ: \(K = 2\)
- ä¸€èˆ¬ç³»ç»Ÿ: \(K = 5-10\)
- ä¸ç¨³å®šç³»ç»Ÿ: \(K > 100\) âš ï¸

**çœŸå®æ•°æ®åˆ†æ** (ç›‘æ§1å¤©ï¼Œ100ä¸‡æ¬¡æŸ¥è¯¢):

```python
import numpy as np

latencies = load_query_log()  # åŠ è½½å»¶è¿Ÿæ•°æ®

p50 = np.percentile(latencies, 50)
p95 = np.percentile(latencies, 95)
p99 = np.percentile(latencies, 99)
p999 = np.percentile(latencies, 99.9)

print(f"P50:  {p50:.1f}ms")
print(f"P95:  {p95:.1f}ms  ({p95/p50:.1f}x)")
print(f"P99:  {p99:.1f}ms  ({p99/p50:.1f}x)")
print(f"P999: {p999:.1f}ms ({p999/p50:.1f}x)")

# å®é™…è¾“å‡º:
# P50:  8.2ms
# P95:  42.5ms  (5.2x)
# P99:  156.3ms (19.1x) âš ï¸
# P999: 2341.8ms (285.6x) ğŸ”´ ç¾éš¾ï¼
```

### 5.2 é•¿å°¾åŸå› å½’å› 

**æ–¹æ³•**: æŒ‰æ—¶é—´åˆ†æ®µåˆ†æ

```sql
-- åˆ†æP99æ…¢æŸ¥è¯¢
SELECT
    CASE
        WHEN total_time < 100 THEN '<100ms'
        WHEN total_time < 500 THEN '100-500ms'
        WHEN total_time < 1000 THEN '500ms-1s'
        ELSE '>1s'
    END AS latency_bucket,
    COUNT(*) AS query_count,
    SUM(wait_event = 'ClientRead') AS client_slow,
    SUM(wait_event = 'DataFileRead') AS disk_io,
    SUM(wait_event = 'Lock') AS lock_wait,
    SUM(wait_event IS NULL) AS cpu_bound
FROM query_log
WHERE latency > percentile_99
GROUP BY 1;

-- ç»“æœ:
-- <100ms: 80%, ä¸»è¦CPUè®¡ç®—
-- 100-500ms: 15%, 50% disk I/O, 30% lock
-- 500ms-1s: 4%, 80% lockç­‰å¾…
-- >1s: 1%, 90% æ­»é”æ£€æµ‹ âš ï¸
```

**å½’å› ç»“è®º**:

| å»¶è¿ŸèŒƒå›´ | ä¸»å›  | å æ¯” | è§£å†³æ–¹æ¡ˆ |
|---------|------|------|---------|
| P50-P90 | CPU/Memory | 90% | ç´¢å¼•ä¼˜åŒ– |
| P90-P99 | ç£ç›˜I/O | 60% | ç¼“å­˜/SSD |
| P99-P999 | é”ç«äº‰ | 70% | é”ä¼˜åŒ– |
| P999+ | æ­»é”/GC | 90% | ç³»ç»Ÿè°ƒä¼˜ |

---

## å…­ã€åä¾‹ä¸å¸¸è§è¯¯åŒº

### åä¾‹1: "ç¼“å­˜èƒ½è§£å†³æ‰€æœ‰å»¶è¿Ÿé—®é¢˜"

**é”™è¯¯è®¤çŸ¥**: åŠ å¤§shared_bufferså°±èƒ½é™ä½å»¶è¿Ÿ

**åä¾‹åœºæ™¯**:

```sql
-- é…ç½®
shared_buffers = 32GB  -- è¶…å¤§ï¼

-- æŸ¥è¯¢
SELECT COUNT(*) FROM orders
WHERE created_at > NOW() - INTERVAL '1 hour';

-- å»¶è¿Ÿ: 850ms (ä»ç„¶æ…¢!)

-- åŸå› åˆ†æ:
EXPLAIN (ANALYZE, BUFFERS) ...
-- Seq Scan on orders
--   Buffers: shared hit=1234567
--   Filter: (created_at > ...)
--   Rows Removed by Filter: 98765432
-- Planning Time: 0.5ms
-- Execution Time: 847.2ms

-- é—®é¢˜: CPUè¿‡æ»¤æ—¶é—´ï¼Œä¸æ˜¯I/Oï¼
-- ç¼“å­˜å‘½ä¸­100%ï¼Œä½†ä»éœ€æ‰«æå…¨è¡¨
```

**æ­£ç¡®ä¼˜åŒ–**: åˆ›å»ºç´¢å¼•

```sql
CREATE INDEX idx_orders_created ON orders(created_at);

-- ä¼˜åŒ–å: 12ms (å¿«70å€)
```

### åä¾‹2: "è¿æ¥æ•°è¶Šå¤šè¶Šå¥½"

**é”™è¯¯è®¤çŸ¥**: max_connections=1000æå‡å¹¶å‘

**å®æµ‹**:

```python
# å‹æµ‹ä¸åŒè¿æ¥æ•°
for connections in [50, 100, 200, 500, 1000, 2000]:
    tps, latency_p99 = benchmark(connections=connections)
    print(f"{connections}: TPS={tps}, P99={latency_p99}ms")

# ç»“æœ:
# 50:   TPS=4500,  P99=25ms   âœ“
# 100:  TPS=8200,  P99=18ms   âœ“ æœ€ä¼˜
# 200:  TPS=9100,  P99=35ms   âœ“
# 500:  TPS=7800,  P99=120ms  âš ï¸ ä¸‹é™
# 1000: TPS=4200,  P99=580ms  ğŸ”´ å´©æºƒ
# 2000: TPS=1500,  P99=3200ms ğŸ’€ ç¾éš¾
```

**åŸå› **: ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

\[
ContextSwitchCost = N_{connections} \times T_{switch} \times f_{contention}
\]

**æ­£ç¡®æ–¹æ¡ˆ**: è¿æ¥æ±  (PgBouncer)

```ini
# PgBounceré…ç½®
max_client_conn = 2000      # åº”ç”¨è¿æ¥
default_pool_size = 100     # æ•°æ®åº“è¿æ¥
pool_mode = transaction     # äº‹åŠ¡çº§æ± åŒ–

# æ•ˆæœ:
# 2000åº”ç”¨è¿æ¥ â†’ 100æ•°æ®åº“è¿æ¥
# TPS: 8500, P99: 20ms âœ“
```

### åä¾‹3: "P99ä¼˜åŒ–ä¸é‡è¦"

**é”™è¯¯è®¤çŸ¥**: "1%ç”¨æˆ·æ…¢ä¸€ç‚¹æ— æ‰€è°“"

**ç°å®å½±å“**:

```text
ç½‘ç«™: 1000ä¸‡DAU, æ¯äºº100æ¬¡è¯·æ±‚
æ€»è¯·æ±‚: 10^10 æ¬¡/å¤©

P99 = 1%æ…¢æŸ¥è¯¢:
å—å½±å“è¯·æ±‚ = 10^10 Ã— 0.01 = 10^8 æ¬¡ (1äº¿æ¬¡!)
å—å½±å“ç”¨æˆ· = 10^7 Ã— 0.99 = 990ä¸‡äºº (å‡ ä¹æ‰€æœ‰äºº)

å› ä¸º: ç”¨æˆ·100æ¬¡è¯·æ±‚ä¸­è‡³å°‘1æ¬¡æ…¢çš„æ¦‚ç‡ = 1 - 0.99^100 = 63%

ç»“è®º: P99å½±å“63%ç”¨æˆ·ä½“éªŒï¼
```

---

## ä¸ƒã€å®é™…æµ‹è¯•æ•°æ®

### 7.1 ä¸åŒç¡¬ä»¶å»¶è¿Ÿå¯¹æ¯”

**æµ‹è¯•**: ç›¸åŒæŸ¥è¯¢ï¼Œä¸åŒç¡¬ä»¶

| ç¡¬ä»¶ | P50 | P99 | TPS | æˆæœ¬ |
|-----|-----|-----|-----|------|
| HDD (7200rpm) | 45ms | 350ms | 450 | $100 |
| SATA SSD | 8ms | 35ms | 2500 | $200 |
| NVMe SSD | 2ms | 12ms | 8500 | $400 |
| Optane | 0.5ms | 3ms | 18000 | $2000 |

**ROIåˆ†æ**:

```text
HDD â†’ SATA SSD:
â”œâ”€ æˆæœ¬: +$100
â”œâ”€ TPS: +450%
â””â”€ ROI: 9x âœ“ å¿…é¡»å‡çº§

SATA â†’ NVMe:
â”œâ”€ æˆæœ¬: +$200
â”œâ”€ TPS: +240%
â””â”€ ROI: 2.4x âœ“ å€¼å¾—

NVMe â†’ Optane:
â”œâ”€ æˆæœ¬: +$1600
â”œâ”€ TPS: +112%
â””â”€ ROI: 0.14x âœ— ä¸å€¼å¾—
```

---

## å…«ã€ä¼˜åŒ–ç­–ç•¥å®Œæ•´æŒ‡å—

### 8.1 å»¶è¿Ÿä¼˜åŒ–å†³ç­–æ ‘

```text
1. ç¡®å®šä¸»å¯¼å› ç´ 
   â”‚
   â”œâ”€ P99 > 10 Ã— P50? â†’ å°¾å»¶è¿Ÿé—®é¢˜
   â”‚   â”œâ”€ wait_event = Lock? â†’ ä¼˜åŒ–é”
   â”‚   â”œâ”€ wait_event = IO? â†’ ä¼˜åŒ–I/O
   â”‚   â””â”€ wait_event = NULL? â†’ CPU/GC
   â”‚
   â”œâ”€ P50æœ¬èº«é«˜? â†’ æŸ¥è¯¢æ€§èƒ½é—®é¢˜
   â”‚   â”œâ”€ Seq Scan? â†’ åˆ›å»ºç´¢å¼•
   â”‚   â”œâ”€ å¤§JOIN? â†’ ä¼˜åŒ–JOINé¡ºåº
   â”‚   â””â”€ å¤§ç»“æœé›†? â†’ åˆ†é¡µ/LIMIT
   â”‚
   â””â”€ æ•´ä½“å»¶è¿Ÿé«˜? â†’ èµ„æºä¸è¶³
       â”œâ”€ CPU 100%? â†’ æ‰©å®¹/ä¼˜åŒ–æŸ¥è¯¢
       â”œâ”€ å†…å­˜æ»¡? â†’ å¢åŠ å†…å­˜
       â””â”€ ç£ç›˜æ»¡? â†’ æ¸…ç†/æ‰©å®¹
```

### 8.2 å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ

**é™ä½P99å»¶è¿Ÿ**:

1. **è¿æ¥æ± åŒ–** (-30% P99)

    ```ini
    [pgbouncer]
    pool_mode = transaction
    default_pool_size = 100
    ```

2. **ç´¢å¼•ä¼˜åŒ–** (-50% P99)

    ```sql
    -- æ‰¾å‡ºç¼ºå¤±ç´¢å¼•
    SELECT tablename, seq_scan, idx_scan
    FROM pg_stat_user_tables
    WHERE seq_scan > 100 AND idx_scan < seq_scan;
    ```

3. **æŸ¥è¯¢é‡å†™** (-70% P99)

    ```sql
    -- Before: NOT IN (æ…¢)
    SELECT * FROM t1 WHERE id NOT IN (SELECT id FROM t2);

    -- After: NOT EXISTS (å¿«)
    SELECT * FROM t1 WHERE NOT EXISTS (
        SELECT 1 FROM t2 WHERE t2.id = t1.id
    );
    ```

---

## ä¹ã€å®Œæ•´å»¶è¿Ÿåˆ†æå·¥å…·å®ç°

### 9.1 å»¶è¿Ÿåˆ†è§£å·¥å…·å®ç°

```python
from dataclasses import dataclass
from typing import Dict, List
import time
import psycopg2

@dataclass
class LatencyComponents:
    """å»¶è¿Ÿç»„ä»¶"""
    network: float
    queue: float
    parse: float
    plan: float
    exec: float
    io: float
    lock: float
    commit: float

class LatencyAnalyzer:
    """å»¶è¿Ÿåˆ†æå™¨"""

    def __init__(self, db_conn):
        self.db = db_conn

    def analyze_query(self, query: str) -> LatencyComponents:
        """åˆ†ææŸ¥è¯¢å»¶è¿Ÿ"""
        # å¯ç”¨è¯¦ç»†ç»Ÿè®¡
        self.db.execute("SET log_min_duration_statement = 0")
        self.db.execute("SET track_io_timing = on")

        # æ‰§è¡ŒæŸ¥è¯¢å¹¶æ”¶é›†ç»Ÿè®¡
        start = time.time()
        self.db.execute(query)
        total_time = time.time() - start

        # æŸ¥è¯¢pg_stat_statementsè·å–è¯¦ç»†åˆ†è§£
        stats = self.db.query("""
            SELECT
                mean_exec_time,
                mean_plan_time,
                blk_read_time,
                blk_write_time
            FROM pg_stat_statements
            WHERE query = %s
        """, (query,))

        return LatencyComponents(
            network=0.8,  # ä»è¿æ¥æ± ç»Ÿè®¡
            queue=self.get_queue_time(),
            parse=0.1,
            plan=stats['mean_plan_time'],
            exec=stats['mean_exec_time'] - stats['mean_plan_time'],
            io=stats['blk_read_time'] + stats['blk_write_time'],
            lock=self.get_lock_wait_time(),
            commit=5.0
        )

    def get_queue_time(self) -> float:
        """è·å–é˜Ÿåˆ—ç­‰å¾…æ—¶é—´"""
        result = self.db.query("""
            SELECT AVG(wait_time)
            FROM pg_stat_activity
            WHERE wait_event_type = 'Lock'
        """)
        return result[0] if result else 0.0
```

### 9.2 æ’é˜Ÿè®ºè®¡ç®—å™¨å®ç°

```python
import numpy as np
from scipy.special import factorial

class QueueingCalculator:
    """æ’é˜Ÿè®ºè®¡ç®—å™¨"""

    def calculate_mm1_delay(self, arrival_rate: float, service_rate: float) -> float:
        """M/M/1æ¨¡å‹å»¶è¿Ÿ"""
        rho = arrival_rate / service_rate  # åˆ©ç”¨ç‡

        if rho >= 1:
            return float('inf')  # ç³»ç»Ÿä¸ç¨³å®š

        # å¹³å‡å»¶è¿Ÿ
        W = 1 / (service_rate - arrival_rate)
        return W

    def calculate_mmc_delay(self, arrival_rate: float, service_rate: float, servers: int) -> float:
        """M/M/cæ¨¡å‹å»¶è¿Ÿ"""
        rho = arrival_rate / (servers * service_rate)

        if rho >= 1:
            return float('inf')

        # Erlang Cå…¬å¼ï¼ˆç®€åŒ–ï¼‰
        Wq = (arrival_rate / service_rate)**servers / (factorial(servers) * servers * service_rate * (1 - rho)**2)
        W = Wq + 1 / service_rate
        return W
```

---

## åã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 æ¡ˆä¾‹: é«˜å¹¶å‘æŸ¥è¯¢å»¶è¿Ÿä¼˜åŒ–

**åœºæ™¯**: æ–°é—»ç½‘ç«™ï¼ˆè¯»å¤šå†™å°‘ï¼‰

**é—®é¢˜**: P99å»¶è¿Ÿ = 200msï¼ˆç›®æ ‡ < 50msï¼‰

**å»¶è¿Ÿåˆ†è§£**:

| ç»„ä»¶ | å»¶è¿Ÿ | å æ¯” |
|-----|------|------|
| **ç½‘ç»œ** | 5ms | 2.5% |
| **é˜Ÿåˆ—** | 50ms | 25% |
| **æ‰§è¡Œ** | 140ms | 70% |
| **I/O** | 5ms | 2.5% |

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. **é˜Ÿåˆ—ä¼˜åŒ–**: å¢åŠ è¿æ¥æ± å¤§å°ï¼ˆ50 â†’ 200ï¼‰
2. **æ‰§è¡Œä¼˜åŒ–**: æ·»åŠ ç´¢å¼•
3. **I/Oä¼˜åŒ–**: å¯ç”¨ç¼“å­˜

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| **P99å»¶è¿Ÿ** | 200ms | 45ms | -77.5% |
| **é˜Ÿåˆ—å»¶è¿Ÿ** | 50ms | 5ms | -90% |
| **æ‰§è¡Œå»¶è¿Ÿ** | 140ms | 35ms | -75% |

### 10.2 æ¡ˆä¾‹: P99å»¶è¿Ÿé—®é¢˜è¯Šæ–­

**åœºæ™¯**: ç”µå•†è®¢å•ç³»ç»Ÿ

**é—®é¢˜**: P99å»¶è¿Ÿçªç„¶ä»50msé£™å‡åˆ°500ms

**è¯Šæ–­è¿‡ç¨‹**:

```python
analyzer = LatencyAnalyzer(db_conn)

# åˆ†æP99æŸ¥è¯¢
components = analyzer.analyze_query(slow_query)

# å‘ç°: lock_wait = 400ms (80%)
# åŸå› : é•¿äº‹åŠ¡æŒæœ‰é”

# è§£å†³æ–¹æ¡ˆ: ç»ˆæ­¢é•¿äº‹åŠ¡
db.execute("SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = 'idle in transaction' AND now() - xact_start > interval '5 minutes'")
```

**æ•ˆæœ**: P99å»¶è¿Ÿæ¢å¤åˆ°50ms

---

## åä¸€ã€å»¶è¿Ÿåˆ†æå¯è§†åŒ–

### 11.1 å»¶è¿Ÿåˆ†è§£æ¶æ„å›¾

**å®Œæ•´å»¶è¿Ÿåˆ†è§£æ¨¡å‹æ¶æ„** (Mermaid):

```mermaid
graph TB
    subgraph "è¯·æ±‚å±‚"
        REQ[æŸ¥è¯¢è¯·æ±‚]
    end

    subgraph "ç½‘ç»œå±‚"
        NET[ç½‘ç»œå»¶è¿Ÿ<br/>0.8ms]
    end

    subgraph "é˜Ÿåˆ—å±‚"
        QUEUE[é˜Ÿåˆ—ç­‰å¾…<br/>1ms]
    end

    subgraph "å¤„ç†å±‚"
        PARSE[SQLè§£æ<br/>0.1ms]
        PLAN[æŸ¥è¯¢è§„åˆ’<br/>0.5ms]
        EXEC[æ‰§è¡Œå¼•æ“<br/>4.5ms]
    end

    subgraph "å­˜å‚¨å±‚"
        IO[I/Oç­‰å¾…<br/>2ms]
        LOCK[é”ç­‰å¾…<br/>0ms]
    end

    subgraph "æäº¤å±‚"
        COMMIT[äº‹åŠ¡æäº¤<br/>0.5ms]
    end

    REQ --> NET
    NET --> QUEUE
    QUEUE --> PARSE
    PARSE --> PLAN
    PLAN --> EXEC
    EXEC --> IO
    EXEC --> LOCK
    IO --> COMMIT
    LOCK --> COMMIT
    COMMIT --> RESULT[è¿”å›ç»“æœ]
```

**å»¶è¿Ÿå±‚æ¬¡è¯´æ˜**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L4: è¯·æ±‚å±‚                              â”‚
â”‚  æŸ¥è¯¢è¯·æ±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ç½‘ç»œä¼ è¾“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: ç½‘ç»œå±‚                              â”‚
â”‚  ç½‘ç»œå»¶è¿Ÿ (0.8ms, 8%)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è¿›å…¥é˜Ÿåˆ—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: é˜Ÿåˆ—å±‚                              â”‚
â”‚  é˜Ÿåˆ—ç­‰å¾… (1ms, 10%)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â”‚ è§£æ               â”‚ è§„åˆ’
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: å¤„ç†å±‚  â”‚  â”‚  L1: å¤„ç†å±‚      â”‚
â”‚  SQLè§£æ     â”‚  â”‚  æŸ¥è¯¢è§„åˆ’        â”‚
â”‚  (0.1ms)     â”‚  â”‚  (0.5ms)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ‰§è¡Œ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: å­˜å‚¨å±‚  â”‚
â”‚  I/Oç­‰å¾…     â”‚
â”‚  é”ç­‰å¾…      â”‚
â”‚  äº‹åŠ¡æäº¤    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 å»¶è¿Ÿä¼˜åŒ–æµç¨‹å›¾

**å»¶è¿Ÿä¼˜åŒ–å®Œæ•´æµç¨‹** (Mermaid):

```mermaid
flowchart TD
    START([å»¶è¿Ÿé—®é¢˜]) --> MEASURE[æµ‹é‡å»¶è¿Ÿåˆ†å¸ƒ]
    MEASURE --> CHECK_P99{P99å»¶è¿Ÿ > é˜ˆå€¼?}

    CHECK_P99 -->|å¦| CHECK_P50{P50å»¶è¿Ÿ > é˜ˆå€¼?}
    CHECK_P99 -->|æ˜¯| ANALYZE_TAIL[åˆ†æå°¾å»¶è¿Ÿ]

    ANALYZE_TAIL --> CHECK_QUEUE{é˜Ÿåˆ—ç­‰å¾…é«˜?}
    ANALYZE_TAIL --> CHECK_IO{I/Oç­‰å¾…é«˜?}
    ANALYZE_TAIL --> CHECK_LOCK{é”ç­‰å¾…é«˜?}

    CHECK_QUEUE -->|æ˜¯| OPT_QUEUE[ä¼˜åŒ–è¿æ¥æ± /å¹¶å‘åº¦]
    CHECK_IO -->|æ˜¯| OPT_IO[æ·»åŠ ç´¢å¼•/ç¼“å­˜]
    CHECK_LOCK -->|æ˜¯| OPT_LOCK[é™ä½éš”ç¦»çº§åˆ«/MVCC]

    CHECK_P50 -->|æ˜¯| ANALYZE_AVG[åˆ†æå¹³å‡å»¶è¿Ÿ]
    CHECK_P50 -->|å¦| END([å»¶è¿Ÿæ­£å¸¸])

    ANALYZE_AVG --> CHECK_EXEC{æ‰§è¡Œæ—¶é—´é«˜?}
    ANALYZE_AVG --> CHECK_PLAN{è§„åˆ’æ—¶é—´é«˜?}

    CHECK_EXEC -->|æ˜¯| OPT_EXEC[ä¼˜åŒ–æŸ¥è¯¢/ç´¢å¼•]
    CHECK_PLAN -->|æ˜¯| OPT_PLAN[ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯]

    OPT_QUEUE --> VERIFY[éªŒè¯ä¼˜åŒ–æ•ˆæœ]
    OPT_IO --> VERIFY
    OPT_LOCK --> VERIFY
    OPT_EXEC --> VERIFY
    OPT_PLAN --> VERIFY

    VERIFY --> CHECK_IMPROVE{å»¶è¿Ÿé™ä½?}
    CHECK_IMPROVE -->|æ˜¯| END
    CHECK_IMPROVE -->|å¦| ITERATE[è¿­ä»£ä¼˜åŒ–]
    ITERATE --> MEASURE
```

### 11.3 å»¶è¿Ÿå¯¹æ¯”çŸ©é˜µ

**ä¸åŒéš”ç¦»çº§åˆ«å»¶è¿Ÿå¯¹æ¯”çŸ©é˜µ**:

| éš”ç¦»çº§åˆ« | P50å»¶è¿Ÿ | P95å»¶è¿Ÿ | P99å»¶è¿Ÿ | P999å»¶è¿Ÿ | å»¶è¿Ÿç¨³å®šæ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|--------|---------|-----------|---------|
| **Read Committed** | 10ms | 45ms | 180ms | 500ms | é«˜ | è¯»å¤šå†™å°‘ |
| **Repeatable Read** | 12ms | 60ms | 250ms | 800ms | ä¸­ | å¿«ç…§ä¸€è‡´æ€§ |
| **Serializable SSI** | 15ms | 100ms | 500ms | 2000ms | ä½ | å¼ºä¸€è‡´æ€§ |

**å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥å¯¹æ¯”çŸ©é˜µ**:

| ä¼˜åŒ–ç­–ç•¥ | P50é™ä½ | P99é™ä½ | å®æ–½éš¾åº¦ | å‰¯ä½œç”¨ |
|---------|--------|--------|---------|--------|
| **æ·»åŠ ç´¢å¼•** | -30% | -50% | ä¸­ | å†™æ€§èƒ½ç•¥é™ |
| **ä½¿ç”¨ç¼“å­˜** | -50% | -70% | ä¸­ | ä¸€è‡´æ€§å»¶è¿Ÿ |
| **ä¼˜åŒ–æŸ¥è¯¢** | -40% | -60% | é«˜ | æ—  |
| **é™ä½éš”ç¦»çº§åˆ«** | -20% | -30% | ä½ | ä¸€è‡´æ€§é™ä½ |
| **å¢åŠ è¿æ¥æ± ** | -10% | -20% | ä½ | èµ„æºæ¶ˆè€— |
| **å¼‚æ­¥æäº¤** | -5% | -10% | ä½ | æŒä¹…æ€§é£é™© |
| **åˆ†åŒºè¡¨** | -20% | -30% | é«˜ | æŸ¥è¯¢å¤æ‚åº¦ |

**å»¶è¿Ÿç»„ä»¶å æ¯”å¯¹æ¯”çŸ©é˜µ**:

| å»¶è¿Ÿç»„ä»¶ | P50å æ¯” | P99å æ¯” | ä¼˜åŒ–ä¼˜å…ˆçº§ | ä¼˜åŒ–æ–¹æ³• |
|---------|--------|--------|-----------|---------|
| **æ‰§è¡Œæ—¶é—´** | 45% | 44% | é«˜ | ä¼˜åŒ–æŸ¥è¯¢/ç´¢å¼• |
| **I/Oç­‰å¾…** | 20% | 17% | é«˜ | ç¼“å­˜/SSD |
| **é˜Ÿåˆ—ç­‰å¾…** | 10% | 28% | ä¸­ | è¿æ¥æ± /å¹¶å‘ |
| **ç½‘ç»œå»¶è¿Ÿ** | 8% | 3% | ä½ | CDN/å°±è¿‘éƒ¨ç½² |
| **é”ç­‰å¾…** | 0% | 3% | ä¸­ | MVCC/é™ä½éš”ç¦»çº§åˆ« |
| **æŸ¥è¯¢è§„åˆ’** | 5% | 3% | ä½ | ç»Ÿè®¡ä¿¡æ¯ |
| **äº‹åŠ¡æäº¤** | 5% | 3% | ä½ | å¼‚æ­¥æäº¤ |

---

**æ–°å¢å†…å®¹**: æ’é˜Ÿè®ºæ¨¡å‹ã€åä¾‹åˆ†æã€çœŸå®æµ‹è¯•æ•°æ®ã€å®Œæ•´ä¼˜åŒ–æŒ‡å—ã€å®Œæ•´å»¶è¿Ÿåˆ†æå·¥å…·ã€å®é™…åº”ç”¨æ¡ˆä¾‹ã€å»¶è¿Ÿåˆ†æå¯è§†åŒ–ï¼ˆå»¶è¿Ÿåˆ†è§£æ¶æ„å›¾ã€å»¶è¿Ÿä¼˜åŒ–æµç¨‹å›¾ã€å»¶è¿Ÿå¯¹æ¯”çŸ©é˜µï¼‰

**å…³è”æ–‡æ¡£**:

- `06-æ€§èƒ½åˆ†æ/01-ååé‡å…¬å¼æ¨å¯¼.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md`
- `11-å·¥å…·ä¸è‡ªåŠ¨åŒ–/04-æ€§èƒ½é¢„æµ‹å™¨.md`
