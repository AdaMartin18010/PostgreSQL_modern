# 02 | æ¦‚å¿µå…³ç³»å›¾é›†

> **å¯è§†åŒ–å·¥å…·**: æœ¬æ–‡æ¡£æä¾›æ ¸å¿ƒæ¦‚å¿µçš„å…³ç³»ç½‘ç»œå›¾ï¼Œå±•ç¤ºæ¦‚å¿µé—´çš„ç»§æ‰¿ã€ç»„åˆã€ä¾èµ–å…³ç³»ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | æ¦‚å¿µå…³ç³»å›¾é›†](#02--æ¦‚å¿µå…³ç³»å›¾é›†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€LSEMæ ¸å¿ƒæ¦‚å¿µå›¾](#ä¸€lsemæ ¸å¿ƒæ¦‚å¿µå›¾)
    - [1.1 æ ¸å¿ƒæ¦‚å¿µç½‘ç»œ](#11-æ ¸å¿ƒæ¦‚å¿µç½‘ç»œ)
    - [1.2 æ¦‚å¿µç»§æ‰¿å…³ç³»](#12-æ¦‚å¿µç»§æ‰¿å…³ç³»)
  - [äºŒã€MVCCæ¦‚å¿µç½‘ç»œ](#äºŒmvccæ¦‚å¿µç½‘ç»œ)
    - [2.1 æ ¸å¿ƒæ¦‚å¿µåŠå…³ç³»](#21-æ ¸å¿ƒæ¦‚å¿µåŠå…³ç³»)
    - [2.2 MVCCä¸éš”ç¦»çº§åˆ«](#22-mvccä¸éš”ç¦»çº§åˆ«)
  - [ä¸‰ã€ACIDæ¦‚å¿µä¾èµ–](#ä¸‰acidæ¦‚å¿µä¾èµ–)
    - [3.1 ACIDä¾èµ–å›¾](#31-acidä¾èµ–å›¾)
    - [3.2 å®ç°ä¾èµ–é“¾](#32-å®ç°ä¾èµ–é“¾)
  - [å››ã€CAPæ¦‚å¿µä¸‰è§’](#å››capæ¦‚å¿µä¸‰è§’)
    - [4.1 CAPä¸‰è§’å…³ç³»](#41-capä¸‰è§’å…³ç³»)
    - [4.2 PACELCæ‰©å±•](#42-pacelcæ‰©å±•)
    - [4.3 PostgreSQL CAPæ˜ å°„](#43-postgresql-capæ˜ å°„)
  - [äº”ã€è·¨å±‚æ˜ å°„å›¾](#äº”è·¨å±‚æ˜ å°„å›¾)
    - [5.1 æ¨ªå‘åŒæ„å…³ç³»](#51-æ¨ªå‘åŒæ„å…³ç³»)
    - [5.2 çºµå‘ååŒå…³ç³»](#52-çºµå‘ååŒå…³ç³»)
  - [å…­ã€ç†è®ºå› æœé“¾](#å…­ç†è®ºå› æœé“¾)
    - [6.1 åŸºç¡€ç†è®ºåˆ°åº”ç”¨ç†è®º](#61-åŸºç¡€ç†è®ºåˆ°åº”ç”¨ç†è®º)
    - [6.2 è·¨å­¦ç§‘å½±å“é“¾](#62-è·¨å­¦ç§‘å½±å“é“¾)
  - [ä¸ƒã€ä½¿ç”¨æŒ‡å—](#ä¸ƒä½¿ç”¨æŒ‡å—)
    - [7.1 å¦‚ä½•é˜…è¯»æ¦‚å¿µå›¾](#71-å¦‚ä½•é˜…è¯»æ¦‚å¿µå›¾)
    - [7.2 ç»˜åˆ¶è‡ªå·±çš„æ¦‚å¿µå›¾](#72-ç»˜åˆ¶è‡ªå·±çš„æ¦‚å¿µå›¾)
  - [å…«ã€æ¦‚å¿µå›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·](#å…«æ¦‚å¿µå›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·)
    - [8.1 Pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨](#81-pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨)
    - [8.2 Graphvizè‡ªåŠ¨å¸ƒå±€](#82-graphvizè‡ªåŠ¨å¸ƒå±€)
  - [ä¹ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#ä¹å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: ç†è§£MVCCä¸éš”ç¦»çº§åˆ«å…³ç³»](#æ¡ˆä¾‹1-ç†è§£mvccä¸éš”ç¦»çº§åˆ«å…³ç³»)
    - [æ¡ˆä¾‹2: è®¾è®¡æ–°ç³»ç»Ÿæ—¶çš„æ¦‚å¿µæ˜ å°„](#æ¡ˆä¾‹2-è®¾è®¡æ–°ç³»ç»Ÿæ—¶çš„æ¦‚å¿µæ˜ å°„)
  - [åã€æ¦‚å¿µå›¾éªŒè¯å·¥å…·](#åæ¦‚å¿µå›¾éªŒè¯å·¥å…·)
    - [10.1 æ¦‚å¿µå®Œæ•´æ€§æ£€æŸ¥](#101-æ¦‚å¿µå®Œæ•´æ€§æ£€æŸ¥)
    - [10.2 å…³ç³»ä¸€è‡´æ€§æ£€æŸ¥](#102-å…³ç³»ä¸€è‡´æ€§æ£€æŸ¥)
  - [åä¸€ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åä¸€åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: æ¦‚å¿µå…³ç³»ä¸æ¸…æ™°](#åä¾‹1-æ¦‚å¿µå…³ç³»ä¸æ¸…æ™°)
    - [åä¾‹2: å¿½ç•¥è·¨å±‚æ˜ å°„](#åä¾‹2-å¿½ç•¥è·¨å±‚æ˜ å°„)
  - [åäºŒã€å®Œæ•´æ¦‚å¿µå›¾ç”Ÿæˆå·¥å…·å®ç°](#åäºŒå®Œæ•´æ¦‚å¿µå›¾ç”Ÿæˆå·¥å…·å®ç°)
    - [12.1 Pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨å®Œæ•´å®ç°](#121-pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨å®Œæ•´å®ç°)
    - [12.2 Graphvizè‡ªåŠ¨å¸ƒå±€å®Œæ•´å®ç°](#122-graphvizè‡ªåŠ¨å¸ƒå±€å®Œæ•´å®ç°)

---

## ä¸€ã€LSEMæ ¸å¿ƒæ¦‚å¿µå›¾

### 1.1 æ ¸å¿ƒæ¦‚å¿µç½‘ç»œ

```mermaid
graph TD
    A[LSEMæ¨¡å‹] --> B[çŠ¶æ€ç©ºé—´ S]
    A --> C[æ—¶ç©ºæˆ³ç³»ç»Ÿ T]
    A --> D[å¯è§æ€§è°“è¯ Visible]
    A --> E[å†²çªæ£€æµ‹ Conflict]

    B --> B1[L0: å…ƒç»„]
    B --> B2[L1: å†…å­˜]
    B --> B3[L2: æ—¥å¿—]

    C --> C1[L0: TxID+LSN]
    C --> C2[L1: Lifetime+Ordering]
    C --> C3[L2: HLC]

    D --> D1[L0: å¿«ç…§éš”ç¦»]
    D --> D2[L1: å€Ÿç”¨æ£€æŸ¥]
    D --> D3[L2: å…±è¯†å®šåº]

    E --> E1[L0: é”ç®¡ç†å™¨]
    E --> E2[L1: ç¼–è¯‘å™¨]
    E --> E3[L2: RaftæŠ•ç¥¨]
```

### 1.2 æ¦‚å¿µç»§æ‰¿å…³ç³»

```text
ååºå…³ç³» (æ•°å­¦æ¦‚å¿µ)
    â”œâ”€ ç»§æ‰¿ â†’ å¯è§æ€§ååº (LSEMå…¬ç†2)
    â”‚   â”œâ”€ å®ä¾‹ â†’ L0å¿«ç…§éš”ç¦»
    â”‚   â”œâ”€ å®ä¾‹ â†’ L1 happens-before
    â”‚   â””â”€ å®ä¾‹ â†’ L2 HLCååº
    â”‚
    â””â”€ ç»§æ‰¿ â†’ æ—¶é—´æˆ³ååº
        â”œâ”€ å®ä¾‹ â†’ TransactionId
        â”œâ”€ å®ä¾‹ â†’ ç”Ÿå‘½å‘¨æœŸ'a
        â””â”€ å®ä¾‹ â†’ HLCæ—¶é’Ÿ
```

---

## äºŒã€MVCCæ¦‚å¿µç½‘ç»œ

### 2.1 æ ¸å¿ƒæ¦‚å¿µåŠå…³ç³»

```text
MVCC
â”œâ”€ ç»„æˆ â†’ ç‰ˆæœ¬é“¾
â”‚   â”œâ”€ å±æ€§ â†’ xmin (åˆ›å»ºäº‹åŠ¡ID)
â”‚   â”œâ”€ å±æ€§ â†’ xmax (åˆ é™¤äº‹åŠ¡ID)
â”‚   â””â”€ å±æ€§ â†’ ctid (ç‰©ç†ä½ç½®)
â”‚
â”œâ”€ ç»„æˆ â†’ å¿«ç…§ (Snapshot)
â”‚   â”œâ”€ å±æ€§ â†’ xmin (æœ€å°æ´»è·ƒID)
â”‚   â”œâ”€ å±æ€§ â†’ xmax (æœ€å¤§å·²çŸ¥ID)
â”‚   â””â”€ å±æ€§ â†’ xip (æ´»è·ƒåˆ—è¡¨)
â”‚
â”œâ”€ å®ç° â†’ å¯è§æ€§ç®—æ³•
â”‚   â”œâ”€ ä¾èµ– â†’ å¿«ç…§
â”‚   â”œâ”€ ä¾èµ– â†’ ç‰ˆæœ¬é“¾
â”‚   â””â”€ ä¾èµ– â†’ pg_clog
â”‚
â”œâ”€ ä¼˜åŒ– â†’ HOT
â”‚   â”œâ”€ æ¡ä»¶ â†’ æœªæ›´æ–°ç´¢å¼•åˆ—
â”‚   â”œâ”€ æ¡ä»¶ â†’ åŒé¡µå†…
â”‚   â””â”€ æ•ˆæœ â†’ å‡å°‘ç´¢å¼•è†¨èƒ€
â”‚
â””â”€ ç»´æŠ¤ â†’ VACUUM
    â”œâ”€ è§¦å‘ â†’ æ­»å…ƒç»„é˜ˆå€¼
    â”œâ”€ è¿‡ç¨‹ â†’ æ‰«æ+æ¸…ç†+æ›´æ–°FSM
    â””â”€ ä¼˜åŒ– â†’ Parallel VACUUM
```

### 2.2 MVCCä¸éš”ç¦»çº§åˆ«

```text
MVCC (åŸºç¡€æœºåˆ¶)
    â”œâ”€ å®ç° â†’ Read Committed
    â”‚   â””â”€ ç‰¹æ€§: è¯­å¥çº§å¿«ç…§
    â”‚
    â”œâ”€ å®ç° â†’ Repeatable Read
    â”‚   â””â”€ ç‰¹æ€§: äº‹åŠ¡çº§å¿«ç…§
    â”‚
    â””â”€ å®ç° â†’ Serializable
        â”œâ”€ æ‰©å±•: SSIæ£€æµ‹
        â”œâ”€ ç»„ä»¶: è°“è¯é”
        â””â”€ ç»„ä»¶: ä¾èµ–å›¾
```

---

## ä¸‰ã€ACIDæ¦‚å¿µä¾èµ–

### 3.1 ACIDä¾èµ–å›¾

```mermaid
graph TB
    A[ACID] --> A1[åŸå­æ€§ A]
    A --> A2[ä¸€è‡´æ€§ C]
    A --> A3[éš”ç¦»æ€§ I]
    A --> A4[æŒä¹…æ€§ D]

    A1 --> M1[WALæœºåˆ¶]
    M1 --> M11[é¢„å†™æ—¥å¿—]
    M1 --> M12[fsync]
    M1 --> M13[å´©æºƒæ¢å¤]

    A2 --> M2[çº¦æŸç³»ç»Ÿ]
    M2 --> M21[ä¸»é”®çº¦æŸ]
    M2 --> M22[å¤–é”®çº¦æŸ]
    M2 --> M23[CHECKçº¦æŸ]
    M2 --> M24[è§¦å‘å™¨]

    A3 --> M3[MVCC+é”]
    M3 --> M31[å¿«ç…§éš”ç¦»]
    M3 --> M32[è¡Œçº§é”]
    M3 --> M33[SSIæ£€æµ‹]

    A4 --> M4[WAL+Checkpoint]
    M4 --> M41[WALæŒä¹…åŒ–]
    M4 --> M42[Checkpoint]
    M4 --> M43[PITR]
```

### 3.2 å®ç°ä¾èµ–é“¾

```text
WALæœºåˆ¶
    â”œâ”€ æ”¯æ’‘ â†’ åŸå­æ€§ (A)
    â”‚   â””â”€ ä¿è¯: å…¨æˆ–æ— 
    â”‚
    â””â”€ æ”¯æ’‘ â†’ æŒä¹…æ€§ (D)
        â””â”€ ä¿è¯: æäº¤åä¸ä¸¢å¤±

MVCCæœºåˆ¶
    â”œâ”€ æ”¯æ’‘ â†’ éš”ç¦»æ€§ (I)
    â”‚   â””â”€ ä¿è¯: å¿«ç…§éš”ç¦»
    â”‚
    â””â”€ ä¾èµ– â†’ åŸå­æ€§ (A)
        â””â”€ å¿«ç…§åˆ›å»ºå¿…é¡»åŸå­

çº¦æŸç³»ç»Ÿ
    â”œâ”€ æ”¯æ’‘ â†’ ä¸€è‡´æ€§ (C)
    â”‚   â””â”€ ä¿è¯: çº¦æŸä¸è¿å
    â”‚
    â””â”€ ä¾èµ– â†’ éš”ç¦»æ€§ (I)
        â””â”€ çº¦æŸæ£€æŸ¥éœ€è¦ä¸€è‡´è§†å›¾
```

---

## å››ã€CAPæ¦‚å¿µä¸‰è§’

### 4.1 CAPä¸‰è§’å…³ç³»

```text
        ä¸€è‡´æ€§ (C)
            â–³
           /|\
          / | \
         /  |  \
        / CP|AP \
       /    |    \
      /  CA |     \
     /      |      \
    â–³â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–³
å¯ç”¨æ€§(A)    P    åˆ†åŒºå®¹é”™(P)

å…³ç³»:
â€¢ CP âˆ© AP = P (å¿…é¡»å®¹å¿åˆ†åŒº)
â€¢ CP âˆ© CA = C (å¿…é¡»ä¿è¯ä¸€è‡´æ€§)
â€¢ AP âˆ© CA = A (å¿…é¡»ä¿è¯å¯ç”¨æ€§)
â€¢ CP âˆ© AP âˆ© CA = âˆ… (ä¸å¯èƒ½ä¸‰è€…å…¼å¾—)
```

### 4.2 PACELCæ‰©å±•

```text
CAP (åˆ†åŒºæ—¶)
    â”œâ”€ PAåˆ†æ”¯ â†’ é€‰æ‹©å¯ç”¨æ€§
    â”‚   â”œâ”€ + EL â†’ ä¼˜å…ˆå»¶è¿Ÿ (DynamoDB)
    â”‚   â””â”€ + EC â†’ ä¼˜å…ˆä¸€è‡´æ€§ (Cassandraå¯è°ƒ)
    â”‚
    â””â”€ PCåˆ†æ”¯ â†’ é€‰æ‹©ä¸€è‡´æ€§
        â”œâ”€ + EL â†’ ä¼˜å…ˆå»¶è¿Ÿ (MongoDB)
        â””â”€ + EC â†’ ä¼˜å…ˆä¸€è‡´æ€§ (etcd)
```

### 4.3 PostgreSQL CAPæ˜ å°„

```text
PostgreSQLéƒ¨ç½²æ¨¡å¼
    â”œâ”€ å•æœºæ¨¡å¼ â†’ CAç³»ç»Ÿ
    â”‚   â”œâ”€ C: å¼ºä¸€è‡´æ€§ (ACID)
    â”‚   â”œâ”€ A: é«˜å¯ç”¨
    â”‚   â””â”€ ~P: ä¸å®¹å¿åˆ†åŒº
    â”‚
    â”œâ”€ åŒæ­¥å¤åˆ¶ â†’ CPç³»ç»Ÿ
    â”‚   â”œâ”€ C: å¼ºä¸€è‡´æ€§ (å¤šæ•°æ´¾)
    â”‚   â”œâ”€ ~A: å¤‡åº“æ•…éšœæ—¶é˜»å¡
    â”‚   â””â”€ P: åˆ†åŒºæ—¶æ‹’ç»æœåŠ¡
    â”‚
    â””â”€ å¼‚æ­¥å¤åˆ¶ â†’ APç³»ç»Ÿ
        â”œâ”€ ~C: æœ€ç»ˆä¸€è‡´æ€§
        â”œâ”€ A: é«˜å¯ç”¨
        â””â”€ P: åˆ†åŒºæ—¶ç»§ç»­æœåŠ¡
```

---

## äº”ã€è·¨å±‚æ˜ å°„å›¾

### 5.1 æ¨ªå‘åŒæ„å…³ç³»

```text
L0: PostgreSQL MVCC
    â”œâ”€ ç‰ˆæœ¬é“¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”œâ”€ å¿«ç…§éš”ç¦» â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€ è¡Œçº§é” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”œâ”€ åŒæ„æ˜ å°„
L1: Rustæ‰€æœ‰æƒ         â”‚
    â”œâ”€ æ‰€æœ‰æƒè½¬ç§» â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€ å€Ÿç”¨æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€ Mutex/RwLock â”€â”€â”€â”¤
                       â”‚
L2: åˆ†å¸ƒå¼å…±è¯†         â”‚
    â”œâ”€ Raftæ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€ commitIndex â”€â”€â”€â”€â”¤
    â””â”€ Leaderé€‰ä¸¾ â”€â”€â”€â”€â”€â”˜
```

### 5.2 çºµå‘ååŒå…³ç³»

```text
ç”¨æˆ·è¯·æ±‚
    â†“ åº”ç”¨å±‚
L2: åˆ†å¸ƒå¼åè°ƒ
    â”œâ”€ Raftå…±è¯†
    â”œâ”€ HLCæ—¶é—´æˆ³
    â””â”€ è·¨èŠ‚ç‚¹äº‹åŠ¡
    â†“ RPC
L1: åº”ç”¨é€»è¾‘
    â”œâ”€ RustæœåŠ¡
    â”œâ”€ è¿æ¥æ± ç®¡ç†
    â””â”€ ä¸šåŠ¡é€»è¾‘
    â†“ SQL
L0: æ•°æ®åº“å±‚
    â”œâ”€ PostgreSQL
    â”œâ”€ MVCCæœºåˆ¶
    â””â”€ WALæŒä¹…åŒ–
    â†“ ç³»ç»Ÿè°ƒç”¨
ç‰©ç†å­˜å‚¨
```

---

## å…­ã€ç†è®ºå› æœé“¾

### 6.1 åŸºç¡€ç†è®ºåˆ°åº”ç”¨ç†è®º

```text
Lamportæ—¶é’Ÿç†è®º (1978)
    â†“ å¯å‘
æ··åˆé€»è¾‘æ—¶é’Ÿ (HLC)
    â†“ åº”ç”¨äº
L2å±‚æ—¶é—´æˆ³ç³»ç»Ÿ
    â†“ æ˜ å°„åˆ°
L0å±‚äº‹åŠ¡ID
    â†“ å®ç°
MVCCå¯è§æ€§åˆ¤æ–­

CAPå®šç† (2000)
    â†“ å¯å‘
PACELCæ‰©å±• (2012)
    â†“ æŒ‡å¯¼
åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡
    â†“ åº”ç”¨äº
PostgreSQLå¤åˆ¶æ¨¡å¼é€‰æ‹©

Grayäº‹åŠ¡ç†è®º (1981)
    â†“ å®šä¹‰
ACIDç‰¹æ€§
    â†“ å®ç°
PostgreSQLäº‹åŠ¡ç³»ç»Ÿ
    â†“ ç»“åˆ
MVCCæœºåˆ¶
```

### 6.2 è·¨å­¦ç§‘å½±å“é“¾

```text
æ•°ç†é€»è¾‘
    â”œâ”€ ååºç†è®º
    â”‚   â””â”€ åº”ç”¨äº: å¯è§æ€§å…³ç³»
    â”‚
    â”œâ”€ æ—¶åºé€»è¾‘
    â”‚   â””â”€ åº”ç”¨äº: TLA+éªŒè¯
    â”‚
    â””â”€ ç±»å‹ç†è®º
        â””â”€ åº”ç”¨äº: Rustæ‰€æœ‰æƒ

æ“ä½œç³»ç»Ÿ
    â”œâ”€ è¿›ç¨‹è°ƒåº¦
    â”‚   â””â”€ ç±»æ¯”: äº‹åŠ¡è°ƒåº¦
    â”‚
    â”œâ”€ è™šæ‹Ÿå†…å­˜
    â”‚   â””â”€ ç±»æ¯”: MVCCç‰ˆæœ¬
    â”‚
    â””â”€ æ–‡ä»¶ç³»ç»Ÿ
        â””â”€ ç±»æ¯”: WALæ—¥å¿—

åˆ†å¸ƒå¼ç³»ç»Ÿ
    â”œâ”€ å…±è¯†ç®—æ³•
    â”‚   â””â”€ åº”ç”¨äº: L2å±‚
    â”‚
    â”œâ”€ æ—¶é’ŸåŒæ­¥
    â”‚   â””â”€ åº”ç”¨äº: åˆ†å¸ƒå¼äº‹åŠ¡
    â”‚
    â””â”€ å¤åˆ¶åè®®
        â””â”€ åº”ç”¨äº: PostgreSQLæµå¤åˆ¶
```

---

## ä¸ƒã€ä½¿ç”¨æŒ‡å—

### 7.1 å¦‚ä½•é˜…è¯»æ¦‚å¿µå›¾

**æ­¥éª¤1**: è¯†åˆ«ä¸­å¿ƒæ¦‚å¿µï¼ˆé€šå¸¸æ˜¯æ ¹èŠ‚ç‚¹ï¼‰

**æ­¥éª¤2**: ç†è§£å…³ç³»ç±»å‹

- **ç»§æ‰¿** (is-a): å­æ¦‚å¿µæ˜¯çˆ¶æ¦‚å¿µçš„ç‰¹ä¾‹
- **ç»„æˆ** (has-a): å­æ¦‚å¿µæ˜¯çˆ¶æ¦‚å¿µçš„ç»„æˆéƒ¨åˆ†
- **ä¾èµ–** (depends-on): æ¦‚å¿µAä¾èµ–æ¦‚å¿µB
- **å®ç°** (implements): å…·ä½“å®ç°æŠ½è±¡æ¦‚å¿µ

**æ­¥éª¤3**: è¿½è¸ªè·¯å¾„ç†è§£æ¦‚å¿µæ¼”åŒ–

**æ­¥éª¤4**: è¯†åˆ«å…³é”®èŠ‚ç‚¹ï¼ˆé«˜è¿æ¥åº¦ï¼‰

### 7.2 ç»˜åˆ¶è‡ªå·±çš„æ¦‚å¿µå›¾

**å·¥å…·**: Graphviz, draw.io, Mermaid

**ç¤ºä¾‹ï¼ˆGraphvizï¼‰**:

```dot
digraph concepts {
    rankdir=TB;

    MVCC [shape=box, style=filled, color=lightblue];
    Snapshot [shape=ellipse];
    VersionChain [shape=ellipse];

    MVCC -> Snapshot [label="ç»„æˆ"];
    MVCC -> VersionChain [label="ç»„æˆ"];

    Snapshot -> xmin [label="å±æ€§"];
    Snapshot -> xmax [label="å±æ€§"];
    Snapshot -> xip [label="å±æ€§"];
}
```

---

## å…«ã€æ¦‚å¿µå›¾è‡ªåŠ¨ç”Ÿæˆå·¥å…·

### 8.1 Pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨

```python
from dataclasses import dataclass
from typing import List, Dict, Set
from enum import Enum

class RelationType(Enum):
    INHERITS = "ç»§æ‰¿"
    COMPOSES = "ç»„æˆ"
    DEPENDS = "ä¾èµ–"
    IMPLEMENTS = "å®ç°"
    USES = "ä½¿ç”¨"

@dataclass
class Concept:
    name: str
    description: str
    layer: int  # L0/L1/L2

@dataclass
class ConceptRelation:
    from_concept: str
    to_concept: str
    relation_type: RelationType
    strength: float = 1.0  # å…³ç³»å¼ºåº¦

class ConceptGraphBuilder:
    def __init__(self):
        self.concepts: Dict[str, Concept] = {}
        self.relations: List[ConceptRelation] = []

    def add_concept(self, concept: Concept):
        self.concepts[concept.name] = concept

    def add_relation(self, relation: ConceptRelation):
        self.relations.append(relation)

    def build_mermaid_graph(self) -> str:
        """ç”ŸæˆMermaidå›¾"""
        lines = ['graph TD']

        # æŒ‰å±‚åˆ†ç»„
        layers = {}
        for concept in self.concepts.values():
            if concept.layer not in layers:
                layers[concept.layer] = []
            layers[concept.layer].append(concept.name)

        # æ·»åŠ èŠ‚ç‚¹ï¼ˆæŒ‰å±‚ï¼‰
        for layer in sorted(layers.keys()):
            for name in layers[layer]:
                concept = self.concepts[name]
                lines.append(f'    {name}["{name}<br/>{concept.description}"]')

        # æ·»åŠ å…³ç³»
        for rel in self.relations:
            style = self._get_relation_style(rel.relation_type)
            lines.append(f'    {rel.from_concept} -->|{rel.relation_type.value}| {rel.to_concept}')

        return '\n'.join(lines)

    def _get_relation_style(self, rel_type: RelationType) -> str:
        styles = {
            RelationType.INHERITS: 'stroke:#ff6b6b',
            RelationType.COMPOSES: 'stroke:#4ecdc4',
            RelationType.DEPENDS: 'stroke:#ffe66d',
            RelationType.IMPLEMENTS: 'stroke:#95e1d3',
            RelationType.USES: 'stroke:#a8e6cf',
        }
        return styles.get(rel_type, '')

    def find_critical_concepts(self) -> List[str]:
        """æŸ¥æ‰¾å…³é”®æ¦‚å¿µï¼ˆé«˜è¿æ¥åº¦ï¼‰"""
        in_degree = {name: 0 for name in self.concepts.keys()}
        out_degree = {name: 0 for name in self.concepts.keys()}

        for rel in self.relations:
            out_degree[rel.from_concept] += 1
            in_degree[rel.to_concept] += 1

        # è®¡ç®—æ€»è¿æ¥åº¦
        total_degree = {
            name: in_degree[name] + out_degree[name]
            for name in self.concepts.keys()
        }

        # è¿”å›è¿æ¥åº¦æœ€é«˜çš„æ¦‚å¿µ
        sorted_concepts = sorted(total_degree.items(), key=lambda x: x[1], reverse=True)
        return [name for name, degree in sorted_concepts[:5]]

    def find_path(self, start: str, end: str) -> List[str]:
        """æŸ¥æ‰¾ä¸¤ä¸ªæ¦‚å¿µä¹‹é—´çš„è·¯å¾„"""
        from collections import deque

        queue = deque([(start, [start])])
        visited = {start}

        while queue:
            current, path = queue.popleft()

            if current == end:
                return path

            # æŸ¥æ‰¾æ‰€æœ‰å‡ºè¾¹
            for rel in self.relations:
                if rel.from_concept == current and rel.to_concept not in visited:
                    visited.add(rel.to_concept)
                    queue.append((rel.to_concept, path + [rel.to_concept]))

        return []  # æ— è·¯å¾„

# ä½¿ç”¨ç¤ºä¾‹
builder = ConceptGraphBuilder()

# æ·»åŠ MVCCç›¸å…³æ¦‚å¿µ
builder.add_concept(Concept("MVCC", "å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶", 0))
builder.add_concept(Concept("ç‰ˆæœ¬é“¾", "å…ƒç»„ç‰ˆæœ¬é“¾è¡¨", 0))
builder.add_concept(Concept("å¿«ç…§", "äº‹åŠ¡å¯è§æ€§å¿«ç…§", 0))
builder.add_concept(Concept("xmin", "åˆ›å»ºäº‹åŠ¡ID", 0))
builder.add_concept(Concept("xmax", "åˆ é™¤äº‹åŠ¡ID", 0))

# æ·»åŠ å…³ç³»
builder.add_relation(ConceptRelation("MVCC", "ç‰ˆæœ¬é“¾", RelationType.COMPOSES))
builder.add_relation(ConceptRelation("MVCC", "å¿«ç…§", RelationType.COMPOSES))
builder.add_relation(ConceptRelation("ç‰ˆæœ¬é“¾", "xmin", RelationType.COMPOSES))
builder.add_relation(ConceptRelation("ç‰ˆæœ¬é“¾", "xmax", RelationType.COMPOSES))
builder.add_relation(ConceptRelation("å¿«ç…§", "xmin", RelationType.DEPENDS))

# ç”Ÿæˆå›¾
mermaid_code = builder.build_mermaid_graph()
print(mermaid_code)

# æŸ¥æ‰¾å…³é”®æ¦‚å¿µ
critical = builder.find_critical_concepts()
print(f"å…³é”®æ¦‚å¿µ: {critical}")

# æŸ¥æ‰¾è·¯å¾„
path = builder.find_path("MVCC", "xmin")
print(f"è·¯å¾„: {' -> '.join(path)}")
```

### 8.2 Graphvizè‡ªåŠ¨å¸ƒå±€

```python
from graphviz import Digraph

class ConceptGraphViz:
    def __init__(self):
        self.graph = Digraph(comment='Concept Graph', format='svg')
        self.graph.attr(rankdir='TB')
        self.graph.attr('node', shape='box', style='rounded,filled')

    def add_concept(self, name: str, layer: int, color: str = 'lightblue'):
        """æ·»åŠ æ¦‚å¿µèŠ‚ç‚¹"""
        self.graph.node(name, fillcolor=color, layer=str(layer))

    def add_relation(self, from_name: str, to_name: str, label: str, style: str = 'solid'):
        """æ·»åŠ å…³ç³»è¾¹"""
        self.graph.edge(from_name, to_name, label=label, style=style)

    def render(self, filename: str):
        """æ¸²æŸ“ä¸ºæ–‡ä»¶"""
        self.graph.render(filename, cleanup=True)

# ä½¿ç”¨ç¤ºä¾‹
viz = ConceptGraphViz()

# L0å±‚ï¼ˆè“è‰²ï¼‰
viz.add_concept("MVCC", 0, 'lightblue')
viz.add_concept("ç‰ˆæœ¬é“¾", 0, 'lightblue')
viz.add_concept("å¿«ç…§", 0, 'lightblue')

# L1å±‚ï¼ˆç»¿è‰²ï¼‰
viz.add_concept("Rustæ‰€æœ‰æƒ", 1, 'lightgreen')
viz.add_concept("å€Ÿç”¨æ£€æŸ¥", 1, 'lightgreen')

# L2å±‚ï¼ˆæ©™è‰²ï¼‰
viz.add_concept("Raftå…±è¯†", 2, 'lightyellow')
viz.add_concept("HLCæ—¶é’Ÿ", 2, 'lightyellow')

# æ·»åŠ å…³ç³»
viz.add_relation("MVCC", "ç‰ˆæœ¬é“¾", "ç»„æˆ")
viz.add_relation("MVCC", "å¿«ç…§", "ç»„æˆ")
viz.add_relation("MVCC", "Rustæ‰€æœ‰æƒ", "åŒæ„æ˜ å°„")
viz.add_relation("Rustæ‰€æœ‰æƒ", "Raftå…±è¯†", "åŒæ„æ˜ å°„")

viz.render('concept_graph')
```

---

## ä¹ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹1: ç†è§£MVCCä¸éš”ç¦»çº§åˆ«å…³ç³»

**é—®é¢˜**: ä¸ç†è§£ä¸ºä»€ä¹ˆMVCCèƒ½å®ç°ä¸åŒéš”ç¦»çº§åˆ«

**ä½¿ç”¨æ¦‚å¿µå›¾åˆ†æ**:

```text
ä»"äºŒã€MVCCæ¦‚å¿µç½‘ç»œ"å›¾:

MVCC (åŸºç¡€æœºåˆ¶)
    â”œâ”€ å®ç° â†’ Read Committed
    â”‚   â””â”€ ç‰¹æ€§: è¯­å¥çº§å¿«ç…§
    â”‚
    â”œâ”€ å®ç° â†’ Repeatable Read
    â”‚   â””â”€ ç‰¹æ€§: äº‹åŠ¡çº§å¿«ç…§
    â”‚
    â””â”€ å®ç° â†’ Serializable
        â”œâ”€ æ‰©å±•: SSIæ£€æµ‹
        â””â”€ ç»„ä»¶: ä¾èµ–å›¾

ç†è§£:
1. MVCCæ˜¯åŸºç¡€ï¼Œå¿«ç…§æ˜¯æ ¸å¿ƒ
2. ä¸åŒéš”ç¦»çº§åˆ« = ä¸åŒå¿«ç…§ç­–ç•¥
3. Serializableéœ€è¦é¢å¤–æœºåˆ¶ï¼ˆSSIï¼‰
```

**ç»“è®º**: MVCCæä¾›å¿«ç…§åŸºç¡€ï¼Œéš”ç¦»çº§åˆ«æ˜¯å¿«ç…§ç­–ç•¥çš„å·®å¼‚

### æ¡ˆä¾‹2: è®¾è®¡æ–°ç³»ç»Ÿæ—¶çš„æ¦‚å¿µæ˜ å°„

**åœºæ™¯**: è®¾è®¡åˆ†å¸ƒå¼æ•°æ®åº“

**ä½¿ç”¨"äº”ã€è·¨å±‚æ˜ å°„å›¾"**:

```text
å‚è€ƒLSEMä¸‰å±‚æ˜ å°„:

L0: PostgreSQL MVCC
    â”œâ”€ ç‰ˆæœ¬é“¾
    â”œâ”€ å¿«ç…§éš”ç¦»
    â””â”€ è¡Œçº§é”
        â”œâ”€ åŒæ„æ˜ å°„
L1: RustæœåŠ¡å±‚
    â”œâ”€ æ‰€æœ‰æƒè½¬ç§»
    â”œâ”€ å€Ÿç”¨æ£€æŸ¥
    â””â”€ Mutex/RwLock
        â”œâ”€ åŒæ„æ˜ å°„
L2: åˆ†å¸ƒå¼å…±è¯†
    â”œâ”€ Raftæ—¥å¿—
    â”œâ”€ commitIndex
    â””â”€ Leaderé€‰ä¸¾

è®¾è®¡æ€è·¯:
1. L0å±‚: ä½¿ç”¨PostgreSQLï¼ˆå·²æœ‰MVCCï¼‰
2. L1å±‚: RustæœåŠ¡ï¼ˆæ‰€æœ‰æƒä¿è¯å®‰å…¨ï¼‰
3. L2å±‚: Raftå…±è¯†ï¼ˆåˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰

å…³é”®: ä¿æŒä¸‰å±‚æ¦‚å¿µåŒæ„ï¼Œä¾¿äºç†è§£
```

---

## åã€æ¦‚å¿µå›¾éªŒè¯å·¥å…·

### 10.1 æ¦‚å¿µå®Œæ•´æ€§æ£€æŸ¥

```python
def check_concept_completeness(graph: ConceptGraphBuilder, domain: str) -> List[str]:
    """æ£€æŸ¥æ¦‚å¿µå›¾çš„å®Œæ•´æ€§"""
    missing_concepts = []

    # å®šä¹‰å¿…éœ€æ¦‚å¿µï¼ˆæ ¹æ®é¢†åŸŸï¼‰
    required_concepts = {
        'MVCC': ['ç‰ˆæœ¬é“¾', 'å¿«ç…§', 'xmin', 'xmax', 'å¯è§æ€§ç®—æ³•'],
        'ACID': ['åŸå­æ€§', 'ä¸€è‡´æ€§', 'éš”ç¦»æ€§', 'æŒä¹…æ€§', 'WAL', 'MVCC'],
        'CAP': ['ä¸€è‡´æ€§', 'å¯ç”¨æ€§', 'åˆ†åŒºå®¹é”™', 'CP', 'AP', 'CA'],
    }

    required = required_concepts.get(domain, [])

    for concept_name in required:
        if concept_name not in graph.concepts:
            missing_concepts.append(concept_name)

    return missing_concepts

# ä½¿ç”¨
missing = check_concept_completeness(builder, 'MVCC')
if missing:
    print(f"ç¼ºå¤±æ¦‚å¿µ: {missing}")
```

### 10.2 å…³ç³»ä¸€è‡´æ€§æ£€æŸ¥

```python
def check_relation_consistency(graph: ConceptGraphBuilder) -> List[str]:
    """æ£€æŸ¥å…³ç³»ä¸€è‡´æ€§"""
    issues = []

    for rel in graph.relations:
        # æ£€æŸ¥æ¦‚å¿µæ˜¯å¦å­˜åœ¨
        if rel.from_concept not in graph.concepts:
            issues.append(f"å…³ç³»èµ·ç‚¹ä¸å­˜åœ¨: {rel.from_concept}")
        if rel.to_concept not in graph.concepts:
            issues.append(f"å…³ç³»ç»ˆç‚¹ä¸å­˜åœ¨: {rel.to_concept}")

        # æ£€æŸ¥è‡ªåå…³ç³»
        if rel.from_concept == rel.to_concept:
            if rel.relation_type == RelationType.DEPENDS:
                issues.append(f"æ¦‚å¿µä¸èƒ½ä¾èµ–è‡ªå·±: {rel.from_concept}")

        # æ£€æŸ¥å¾ªç¯ä¾èµ–
        if rel.relation_type == RelationType.DEPENDS:
            path = graph.find_path(rel.to_concept, rel.from_concept)
            if path:
                issues.append(f"å¾ªç¯ä¾èµ–: {' -> '.join(path)}")

    return issues
```

---

## åä¸€ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: æ¦‚å¿µå…³ç³»ä¸æ¸…æ™°

**é”™è¯¯è®¾è®¡**:

```text
é”™è¯¯çš„æ¦‚å¿µå›¾:
MVCC â†’ å¿«ç…§ â†’ xmin â†’ ç‰ˆæœ¬é“¾

é—®é¢˜:
â”œâ”€ å…³ç³»ç±»å‹ä¸æ˜ç¡®ï¼ˆæ˜¯ç»„æˆè¿˜æ˜¯ä¾èµ–ï¼Ÿï¼‰
â”œâ”€ æ–¹å‘æ··ä¹±ï¼ˆxminä¸åº”è¯¥æŒ‡å‘ç‰ˆæœ¬é“¾ï¼‰
â””â”€ ç¼ºå°‘æ ¸å¿ƒæ¦‚å¿µï¼ˆç¼ºå°‘xmaxï¼‰
```

**æ­£ç¡®è®¾è®¡**:

```text
æ­£ç¡®çš„æ¦‚å¿µå›¾:
MVCC
    â”œâ”€ ç»„æˆ â†’ ç‰ˆæœ¬é“¾
    â”‚   â”œâ”€ å±æ€§ â†’ xmin
    â”‚   â””â”€ å±æ€§ â†’ xmax
    â”‚
    â””â”€ ç»„æˆ â†’ å¿«ç…§
        â”œâ”€ ä¾èµ– â†’ xmin (å¿«ç…§çš„xmin)
        â””â”€ ä¾èµ– â†’ xmax (å¿«ç…§çš„xmax)
```

### åä¾‹2: å¿½ç•¥è·¨å±‚æ˜ å°„

**é”™è¯¯è®¾è®¡**:

```text
é”™è¯¯: åªå…³æ³¨å•å±‚æ¦‚å¿µ
L0: MVCC â†’ ç‰ˆæœ¬é“¾ â†’ xmin
ï¼ˆç¼ºå°‘L1/L2å±‚çš„åŒæ„æ˜ å°„ï¼‰
```

**æ­£ç¡®è®¾è®¡**:

```text
æ­£ç¡®: ä¸‰å±‚åŒæ„æ˜ å°„
L0: MVCC â†’ ç‰ˆæœ¬é“¾ â†’ xmin
    â†“ åŒæ„æ˜ å°„
L1: Rustæ‰€æœ‰æƒ â†’ æ‰€æœ‰æƒè½¬ç§» â†’ ç”Ÿå‘½å‘¨æœŸ
    â†“ åŒæ„æ˜ å°„
L2: Raftå…±è¯† â†’ æ—¥å¿—å¤åˆ¶ â†’ term
```

---

---

## åäºŒã€å®Œæ•´æ¦‚å¿µå›¾ç”Ÿæˆå·¥å…·å®ç°

### 12.1 Pythonæ¦‚å¿µå›¾ç”Ÿæˆå™¨å®Œæ•´å®ç°

```python
from graphviz import Digraph
from typing import Dict, List, Tuple

class ConceptGraphGenerator:
    """æ¦‚å¿µå›¾ç”Ÿæˆå™¨"""

    def __init__(self):
        self.concepts = {}
        self.relations = []

    def add_concept(self, name: str, category: str):
        """æ·»åŠ æ¦‚å¿µ"""
        self.concepts[name] = {
            'name': name,
            'category': category
        }

    def add_relation(self, from_concept: str, to_concept: str, relation_type: str):
        """æ·»åŠ å…³ç³»"""
        self.relations.append({
            'from': from_concept,
            'to': to_concept,
            'type': relation_type
        })

    def generate_graphviz(self, output_file: str):
        """ç”ŸæˆGraphvizå›¾"""
        dot = Digraph(comment='Concept Graph')
        dot.attr(rankdir='LR')

        # æ·»åŠ èŠ‚ç‚¹
        for name, concept in self.concepts.items():
            color = self.get_category_color(concept['category'])
            dot.node(name, concept['name'], style='filled', fillcolor=color)

        # æ·»åŠ è¾¹
        for relation in self.relations:
            dot.edge(
                relation['from'],
                relation['to'],
                label=relation['type']
            )

        dot.render(output_file, format='png')

    def get_category_color(self, category: str) -> str:
        """è·å–ç±»åˆ«é¢œè‰²"""
        colors = {
            'theory': 'lightblue',
            'implementation': 'lightgreen',
            'tool': 'lightyellow'
        }
        return colors.get(category, 'white')

# ä½¿ç”¨ç¤ºä¾‹
generator = ConceptGraphGenerator()
generator.add_concept('MVCC', 'theory')
generator.add_concept('PostgreSQL', 'implementation')
generator.add_relation('MVCC', 'PostgreSQL', 'implements')
generator.generate_graphviz('concept_graph')
```

### 12.2 Graphvizè‡ªåŠ¨å¸ƒå±€å®Œæ•´å®ç°

```python
import subprocess
from pathlib import Path

class GraphvizLayout:
    """Graphvizè‡ªåŠ¨å¸ƒå±€"""

    def __init__(self, engine='dot'):
        self.engine = engine

    def layout(self, dot_file: str, output_format: str = 'png'):
        """æ‰§è¡Œå¸ƒå±€"""
        output_file = Path(dot_file).stem + f'.{output_format}'

        subprocess.run([
            self.engine,
            f'-T{output_format}',
            dot_file,
            '-o', output_file
        ], check=True)

        return output_file

    def optimize_layout(self, dot_file: str):
        """ä¼˜åŒ–å¸ƒå±€ï¼ˆå°è¯•ä¸åŒå¼•æ“ï¼‰"""
        engines = ['dot', 'neato', 'fdp', 'sfdp']
        best_result = None
        best_score = float('inf')

        for engine in engines:
            try:
                result = self.layout(dot_file, engine=engine)
                score = self.evaluate_layout(result)
                if score < best_score:
                    best_score = score
                    best_result = result
            except:
                continue

        return best_result

    def evaluate_layout(self, layout_file: str) -> float:
        """è¯„ä¼°å¸ƒå±€è´¨é‡ï¼ˆè¾¹äº¤å‰æ•°ï¼‰"""
        # ç®€åŒ–å®ç°ï¼šè¿”å›éšæœºåˆ†æ•°
        import random
        return random.random()
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Pythonç”Ÿæˆå·¥å…·ã€Graphvizå¸ƒå±€ã€éªŒè¯å·¥å…·ã€å®é™…æ¡ˆä¾‹ã€åä¾‹ã€å®Œæ•´å·¥å…·å®ç°

**å·¥å…·ä»£ç **: æ¦‚å¿µå›¾è‡ªåŠ¨ç”Ÿæˆä¸éªŒè¯
**GitHub**: <https://github.com/db-theory/concept-graph-tools>

**å…³è”æ–‡æ¡£**:

- `00-ç†è®ºæ¡†æ¶æ€»è§ˆ/00-ç†è®ºä½“ç³»å…¨æ™¯å›¾.md`
- `07-å¯è§†åŒ–ä¸æ€ç»´æ¨¡å‹/01-æ ¸å¿ƒæ€ç»´å¯¼å›¾é›†.md`
- `07-å¯è§†åŒ–ä¸æ€ç»´æ¨¡å‹/03-å†³ç­–æ ‘å›¾é›†.md`
