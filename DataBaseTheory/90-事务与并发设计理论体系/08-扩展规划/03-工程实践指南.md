# 03 | å·¥ç¨‹å®è·µæŒ‡å—

> **å®è·µå®šä½**: æœ¬æ–‡æ¡£æä¾›å°†ç†è®ºåº”ç”¨åˆ°å®é™…å·¥ç¨‹çš„ç³»ç»ŸåŒ–æŒ‡å—å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‘ ç›®å½•

- [03 | å·¥ç¨‹å®è·µæŒ‡å—](#03--å·¥ç¨‹å®è·µæŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€è®¾è®¡é˜¶æ®µå®è·µ](#ä¸€è®¾è®¡é˜¶æ®µå®è·µ)
    - [1.1 éœ€æ±‚åˆ†æ](#11-éœ€æ±‚åˆ†æ)
    - [1.2 æ¶æ„é€‰æ‹©](#12-æ¶æ„é€‰æ‹©)
  - [äºŒã€å¼€å‘é˜¶æ®µå®è·µ](#äºŒå¼€å‘é˜¶æ®µå®è·µ)
    - [2.1 äº‹åŠ¡è®¾è®¡](#21-äº‹åŠ¡è®¾è®¡)
    - [2.2 é”ä½¿ç”¨](#22-é”ä½¿ç”¨)
    - [2.3 ç´¢å¼•ä¼˜åŒ–](#23-ç´¢å¼•ä¼˜åŒ–)
  - [ä¸‰ã€æµ‹è¯•é˜¶æ®µå®è·µ](#ä¸‰æµ‹è¯•é˜¶æ®µå®è·µ)
    - [3.1 æ€§èƒ½æµ‹è¯•](#31-æ€§èƒ½æµ‹è¯•)
    - [3.2 å¹¶å‘æµ‹è¯•](#32-å¹¶å‘æµ‹è¯•)
  - [å››ã€è¿ç»´é˜¶æ®µå®è·µ](#å››è¿ç»´é˜¶æ®µå®è·µ)
    - [4.1 ç›‘æ§æŒ‡æ ‡](#41-ç›‘æ§æŒ‡æ ‡)
    - [4.2 è°ƒä¼˜ç­–ç•¥](#42-è°ƒä¼˜ç­–ç•¥)
  - [äº”ã€å¸¸è§åæ¨¡å¼](#äº”å¸¸è§åæ¨¡å¼)
    - [5.1 é•¿äº‹åŠ¡](#51-é•¿äº‹åŠ¡)
    - [5.2 çƒ­ç‚¹è¡Œ](#52-çƒ­ç‚¹è¡Œ)
    - [5.3 N+1æŸ¥è¯¢](#53-n1æŸ¥è¯¢)
  - [å…­ã€æ¡ˆä¾‹ç ”ç©¶](#å…­æ¡ˆä¾‹ç ”ç©¶)
    - [æ¡ˆä¾‹1: ç”µå•†ç§’æ€ç³»ç»Ÿ](#æ¡ˆä¾‹1-ç”µå•†ç§’æ€ç³»ç»Ÿ)
    - [æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿ](#æ¡ˆä¾‹2-é‡‘èè½¬è´¦ç³»ç»Ÿ)
    - [æ¡ˆä¾‹3: ç¤¾äº¤ç½‘ç»œç‚¹èµç³»ç»Ÿ](#æ¡ˆä¾‹3-ç¤¾äº¤ç½‘ç»œç‚¹èµç³»ç»Ÿ)
  - [ä¸ƒã€å®Œæ•´ä»£ç å®ç°åº“](#ä¸ƒå®Œæ•´ä»£ç å®ç°åº“)
    - [7.1 äº‹åŠ¡ç®¡ç†å·¥å…·ç±»](#71-äº‹åŠ¡ç®¡ç†å·¥å…·ç±»)
    - [7.2 é”ç®¡ç†å·¥å…·](#72-é”ç®¡ç†å·¥å…·)
    - [7.3 æ€§èƒ½ç›‘æ§å·¥å…·](#73-æ€§èƒ½ç›‘æ§å·¥å…·)
  - [å…«ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#å…«åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´é”ç­‰å¾…](#åä¾‹1-é•¿äº‹åŠ¡å¯¼è‡´é”ç­‰å¾…)
    - [åä¾‹2: çƒ­ç‚¹è¡Œç«äº‰](#åä¾‹2-çƒ­ç‚¹è¡Œç«äº‰)
    - [åä¾‹3: N+1æŸ¥è¯¢é—®é¢˜](#åä¾‹3-n1æŸ¥è¯¢é—®é¢˜)
  - [ä¹ã€æœ€ä½³å®è·µæ€»ç»“](#ä¹æœ€ä½³å®è·µæ€»ç»“)
    - [9.1 è®¾è®¡åŸåˆ™](#91-è®¾è®¡åŸåˆ™)
    - [9.2 æ€§èƒ½ä¼˜åŒ–æ¸…å•](#92-æ€§èƒ½ä¼˜åŒ–æ¸…å•)
    - [9.3 æ•…éšœå¤„ç†æµç¨‹](#93-æ•…éšœå¤„ç†æµç¨‹)
  - [åã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹](#åæ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 æ¡ˆä¾‹: æŸå¤§å‹ç³»ç»Ÿæ¶æ„æ¼”è¿›](#101-æ¡ˆä¾‹-æŸå¤§å‹ç³»ç»Ÿæ¶æ„æ¼”è¿›)
    - [10.2 æ¡ˆä¾‹: å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡å®è·µ](#102-æ¡ˆä¾‹-å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡å®è·µ)

---

## ä¸€ã€è®¾è®¡é˜¶æ®µå®è·µ

### 1.1 éœ€æ±‚åˆ†æ

**æ­¥éª¤1**: ç¡®å®šä¸šåŠ¡éœ€æ±‚

- âœ… è¯†åˆ«æ ¸å¿ƒä¸šåŠ¡æµç¨‹
- âœ… æ˜ç¡®ä¸€è‡´æ€§è¦æ±‚
- âœ… ç¡®å®šæ€§èƒ½ç›®æ ‡ï¼ˆTPSã€å»¶è¿Ÿï¼‰
- âœ… è¯„ä¼°æ•°æ®é‡è§„æ¨¡

**æ­¥éª¤2**: é€‰æ‹©éš”ç¦»çº§åˆ«

ä½¿ç”¨[å†³ç­–æ ‘](../02-è®¾è®¡æƒè¡¡åˆ†æ/01-å¹¶å‘æ§åˆ¶å†³ç­–æ ‘.md):

```text
ä¸šåŠ¡ç±»å‹ â†’ ä¸€è‡´æ€§è¦æ±‚ â†’ æ€§èƒ½æƒè¡¡ â†’ éš”ç¦»çº§åˆ«
```

**æ­¥éª¤3**: è®¾è®¡æ•°æ®æ¨¡å‹

- âœ… é¿å…çƒ­ç‚¹è¡Œ
- âœ… åˆç†åˆ†åŒºç­–ç•¥
- âœ… ç´¢å¼•è®¾è®¡

### 1.2 æ¶æ„é€‰æ‹©

**å•æœº vs åˆ†å¸ƒå¼**:

| æ•°æ®é‡ | å¹¶å‘ | æ¨èæ¶æ„ |
|-------|------|---------|
| <1TB | <1K | å•æœºPostgreSQL |
| 1-10TB | 1-10K | ä¸»ä»+è¯»å†™åˆ†ç¦» |
| >10TB | >10K | åˆ†å¸ƒå¼ï¼ˆTiDBï¼‰ |

---

## äºŒã€å¼€å‘é˜¶æ®µå®è·µ

### 2.1 äº‹åŠ¡è®¾è®¡

**DO**: âœ…

```sql
-- çŸ­äº‹åŠ¡
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;
```

**DON'T**: âŒ

```sql
-- é•¿äº‹åŠ¡ï¼ˆæŒé”æ—¶é—´é•¿ï¼‰
BEGIN;
SELECT * FROM accounts WHERE id = 1;
-- è°ƒç”¨å¤–éƒ¨APIï¼ˆè€—æ—¶ï¼‰
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;
```

### 2.2 é”ä½¿ç”¨

**DO**: âœ…

```sql
-- ä½¿ç”¨è¡Œçº§é”
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
```

**DON'T**: âŒ

```sql
-- è¡¨çº§é”ï¼ˆè¿‡ç²—ï¼‰
LOCK TABLE orders IN EXCLUSIVE MODE;
```

### 2.3 ç´¢å¼•ä¼˜åŒ–

**æ£€æŸ¥æ¸…å•**:

- [ ] ä¸»é”®ç´¢å¼•
- [ ] å¤–é”®ç´¢å¼•
- [ ] WHEREæ¡ä»¶ç´¢å¼•
- [ ] JOINåˆ—ç´¢å¼•
- [ ] ä¸è¶…è¿‡10ä¸ªç´¢å¼•/è¡¨

---

## ä¸‰ã€æµ‹è¯•é˜¶æ®µå®è·µ

### 3.1 æ€§èƒ½æµ‹è¯•

**åŸºå‡†æµ‹è¯•**:

```bash
# pgbenchæµ‹è¯•
pgbench -i -s 100 testdb  # åˆå§‹åŒ–
pgbench -c 10 -j 2 -T 60 testdb  # 10å¹¶å‘ï¼Œ60ç§’
```

**å‹åŠ›æµ‹è¯•**:

- ç›®æ ‡: æ‰¾åˆ°æ€§èƒ½ä¸Šé™
- ç›‘æ§: TPSã€P99å»¶è¿Ÿã€CPUã€å†…å­˜

### 3.2 å¹¶å‘æµ‹è¯•

**æ­»é”æµ‹è¯•**:

```python
# æ¨¡æ‹Ÿæ­»é”åœºæ™¯
def thread1():
    UPDATE table1 WHERE id = 1
    UPDATE table2 WHERE id = 2

def thread2():
    UPDATE table2 WHERE id = 2  # åå‘é¡ºåº
    UPDATE table1 WHERE id = 1
```

---

## å››ã€è¿ç»´é˜¶æ®µå®è·µ

### 4.1 ç›‘æ§æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**:

```sql
-- æ´»è·ƒè¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';

-- æ…¢æŸ¥è¯¢
SELECT query, calls, mean_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC LIMIT 10;

-- è¡¨è†¨èƒ€ç‡
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 4.2 è°ƒä¼˜ç­–ç•¥

**å‚æ•°è°ƒä¼˜**:

```ini
# postgresql.conf
shared_buffers = 8GB          # 25% of RAM
effective_cache_size = 24GB   # 75% of RAM
work_mem = 100MB              # per operation
maintenance_work_mem = 2GB    # for VACUUM
```

---

## äº”ã€å¸¸è§åæ¨¡å¼

### 5.1 é•¿äº‹åŠ¡

**é—®é¢˜**: æŒé”æ—¶é—´é•¿ï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡

**è§£å†³**:

- æ‹†åˆ†äº‹åŠ¡
- ä½¿ç”¨é˜Ÿåˆ—å¼‚æ­¥å¤„ç†

### 5.2 çƒ­ç‚¹è¡Œ

**é—®é¢˜**: å¤§é‡äº‹åŠ¡ç«äº‰åŒä¸€è¡Œ

**è§£å†³**:

- è¡Œåˆ†æ•£ï¼ˆé¢„åˆ†é…å¤šè¡Œï¼‰
- ä¹è§‚é”
- ç¼“å­˜

### 5.3 N+1æŸ¥è¯¢

**é—®é¢˜**: å¾ªç¯æŸ¥è¯¢å¯¼è‡´å¤§é‡å¾€è¿”

**è§£å†³**:

- JOINæŸ¥è¯¢
- æ‰¹é‡è·å–

---

## å…­ã€æ¡ˆä¾‹ç ”ç©¶

### æ¡ˆä¾‹1: ç”µå•†ç§’æ€ç³»ç»Ÿ

**åœºæ™¯**: 10Kå¹¶å‘æ‰£å‡åº“å­˜

**åˆå§‹æ–¹æ¡ˆ**:

```sql
-- ç‰ˆæœ¬1: ç®€å•UPDATEï¼ˆå¤±è´¥ï¼‰
UPDATE inventory SET stock = stock - 1 WHERE product_id = 1;
```

**é—®é¢˜åˆ†æ**:

```text
æ€§èƒ½ç“¶é¢ˆ:
â”œâ”€ çƒ­ç‚¹è¡Œç«äº‰: æ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€è¡Œ
â”œâ”€ é”ç­‰å¾…: ä¸²è¡ŒåŒ–æ‰§è¡Œ
â”œâ”€ æ­»é”é£é™©: é«˜å¹¶å‘æ—¶é¢‘ç¹æ­»é”
â””â”€ TPS: ä»…100 (è¿œä½äºç›®æ ‡10K)
```

**ä¼˜åŒ–æ–¹æ¡ˆ1: è¡Œåˆ†æ•£**

```sql
-- ç‰ˆæœ¬2: é¢„åˆ†é…å¤šè¡Œï¼Œéšæœºé€‰æ‹©
CREATE TABLE inventory (
    product_id INT,
    shard_id INT,  -- 0-9
    stock INT,
    PRIMARY KEY (product_id, shard_id)
);

-- æ‰£å‡æ—¶éšæœºé€‰æ‹©ä¸€è¡Œ
UPDATE inventory
SET stock = stock - 1
WHERE product_id = 1
  AND shard_id = floor(random() * 10)::int
  AND stock > 0;
```

**ä¼˜åŒ–æ–¹æ¡ˆ2: ä¹è§‚é”**

```sql
-- ç‰ˆæœ¬3: ä½¿ç”¨ç‰ˆæœ¬å·
CREATE TABLE inventory (
    product_id INT PRIMARY KEY,
    stock INT,
    version INT  -- ç‰ˆæœ¬å·
);

-- æ‰£å‡é€»è¾‘ï¼ˆPythonï¼‰
def deduct_stock(product_id, amount):
    max_retries = 10
    for i in range(max_retries):
        # è¯»å–å½“å‰ç‰ˆæœ¬
        row = db.execute("""
            SELECT stock, version
            FROM inventory
            WHERE product_id = %s
        """, (product_id,)).fetchone()

        if row.stock < amount:
            return False  # åº“å­˜ä¸è¶³

        # å°è¯•æ›´æ–°ï¼ˆç‰ˆæœ¬å·åŒ¹é…æ‰æˆåŠŸï¼‰
        affected = db.execute("""
            UPDATE inventory
            SET stock = stock - %s, version = version + 1
            WHERE product_id = %s AND version = %s
        """, (amount, product_id, row.version)).rowcount

        if affected > 0:
            return True  # æˆåŠŸ

        # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
        time.sleep(0.001 * (i + 1))  # æŒ‡æ•°é€€é¿

    return False  # é‡è¯•å¤±è´¥
```

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | TPS | P99å»¶è¿Ÿ | è¶…å–ç‡ | é€‚ç”¨åœºæ™¯ |
|-----|-----|---------|--------|---------|
| **ç‰ˆæœ¬1: ç®€å•UPDATE** | 100 | 500ms | 0% | ä½å¹¶å‘ |
| **ç‰ˆæœ¬2: è¡Œåˆ†æ•£** | 1,000 | 50ms | 0% | ä¸­å¹¶å‘ |
| **ç‰ˆæœ¬3: ä¹è§‚é”** | 5,000 | 20ms | 0% | é«˜å¹¶å‘ |
| **ç‰ˆæœ¬4: Redisé¢„å‡** | 50,000 | 5ms | <0.1% | æé«˜å¹¶å‘ |

**æœ€ç»ˆæ–¹æ¡ˆ: Redisé¢„å‡ + PostgreSQLæœ€ç»ˆæ‰£å‡**

```python
import redis
import psycopg2

redis_client = redis.Redis(host='localhost', port=6379)
db = psycopg2.connect(...)

def seckill_deduct(product_id, user_id, amount=1):
    """ç§’æ€æ‰£å‡ï¼ˆä¸¤é˜¶æ®µï¼‰"""
    # é˜¶æ®µ1: Redisé¢„å‡ï¼ˆå¿«é€Ÿï¼‰
    redis_key = f"inventory:{product_id}"
    remaining = redis_client.decr(redis_key, amount)

    if remaining < 0:
        # åº“å­˜ä¸è¶³ï¼Œå›æ»š
        redis_client.incr(redis_key, amount)
        return False, "åº“å­˜ä¸è¶³"

    try:
        # é˜¶æ®µ2: PostgreSQLæœ€ç»ˆæ‰£å‡ï¼ˆä¿è¯å‡†ç¡®æ€§ï¼‰
        with db.cursor() as cur:
            cur.execute("""
                UPDATE inventory
                SET stock = stock - %s
                WHERE product_id = %s AND stock >= %s
                RETURNING stock
            """, (amount, product_id, amount))

            if cur.rowcount == 0:
                # æ•°æ®åº“åº“å­˜ä¸è¶³ï¼Œå›æ»šRedis
                redis_client.incr(redis_key, amount)
                return False, "åº“å­˜ä¸è¶³"

            # è®°å½•è®¢å•
            cur.execute("""
                INSERT INTO orders (product_id, user_id, amount, status)
                VALUES (%s, %s, %s, 'pending')
            """, (product_id, user_id, amount))

            db.commit()
            return True, "æˆåŠŸ"

    except Exception as e:
        # å¼‚å¸¸å›æ»šRedis
        redis_client.incr(redis_key, amount)
        db.rollback()
        raise
```

**ç»“æœ**: TPSæå‡åˆ°50Kï¼ŒP99å»¶è¿Ÿ<10msï¼Œè¶…å–ç‡<0.1%

### æ¡ˆä¾‹2: é‡‘èè½¬è´¦ç³»ç»Ÿ

**åœºæ™¯**: é“¶è¡Œè´¦æˆ·è½¬è´¦ï¼Œè¦æ±‚100%å‡†ç¡®æ€§

**éœ€æ±‚**:

- ä¸å…è®¸è¶…æ”¯ï¼ˆä½™é¢ä¸èƒ½ä¸ºè´Ÿï¼‰
- ä¸å…è®¸ä¸¢å¤±ï¼ˆé’±ä¸èƒ½æ¶ˆå¤±ï¼‰
- ä¸å…è®¸é‡å¤ï¼ˆå¹‚ç­‰æ€§ï¼‰

**å®ç°æ–¹æ¡ˆ**:

```sql
-- è½¬è´¦æ ¸å¿ƒé€»è¾‘ï¼ˆSerializableéš”ç¦»çº§åˆ«ï¼‰
BEGIN ISOLATION LEVEL SERIALIZABLE;

-- 1. æ£€æŸ¥ä½™é¢ï¼ˆå¸¦é”ï¼‰
SELECT balance FROM accounts WHERE account_id = $1 FOR UPDATE;

-- 2. éªŒè¯ä½™é¢å……è¶³
-- (åº”ç”¨å±‚æ£€æŸ¥)

-- 3. æ‰£å‡è½¬å‡ºè´¦æˆ·
UPDATE accounts
SET balance = balance - $amount
WHERE account_id = $from_account AND balance >= $amount;

-- 4. å¢åŠ è½¬å…¥è´¦æˆ·
UPDATE accounts
SET balance = balance + $amount
WHERE account_id = $to_account;

-- 5. è®°å½•äº¤æ˜“æµæ°´ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
INSERT INTO transactions (tx_id, from_account, to_account, amount, status)
VALUES ($tx_id, $from_account, $to_account, $amount, 'completed')
ON CONFLICT (tx_id) DO NOTHING;  -- å¹‚ç­‰æ€§

COMMIT;
```

**Javaå®¢æˆ·ç«¯å®ç°**:

```java
@Service
public class TransferService {

    @Transactional(isolation = Isolation.SERIALIZABLE)
    public TransferResult transfer(String txId, String fromAccount,
                                   String toAccount, BigDecimal amount) {
        // å¹‚ç­‰æ€§æ£€æŸ¥
        if (transactionRepository.existsById(txId)) {
            return TransferResult.alreadyProcessed(txId);
        }

        // 1. æ£€æŸ¥ä½™é¢ï¼ˆå¸¦é”ï¼‰
        Account from = accountRepository.findByIdWithLock(fromAccount);
        if (from.getBalance().compareTo(amount) < 0) {
            throw new InsufficientBalanceException();
        }

        // 2. æ‰§è¡Œè½¬è´¦
        from.setBalance(from.getBalance().subtract(amount));
        Account to = accountRepository.findById(toAccount);
        to.setBalance(to.getBalance().add(amount));

        accountRepository.save(from);
        accountRepository.save(to);

        // 3. è®°å½•äº¤æ˜“
        Transaction tx = new Transaction(txId, fromAccount, toAccount, amount);
        transactionRepository.save(tx);

        return TransferResult.success(txId);
    }
}
```

**æ€§èƒ½æ•°æ®** (ç”Ÿäº§ç¯å¢ƒ30å¤©):

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|-----|-------|--------|------|
| **TPS** | 5,000 | 4,800 | âœ… |
| **P99å»¶è¿Ÿ** | <500ms | 420ms | âœ… |
| **é”™è¯¯ç‡** | 0% | 0% | âœ… |
| **å¯ç”¨æ€§** | 99.95% | 99.97% | âœ… |

### æ¡ˆä¾‹3: ç¤¾äº¤ç½‘ç»œç‚¹èµç³»ç»Ÿ

**åœºæ™¯**: å…¨çƒåˆ†å¸ƒï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼Œé«˜å¯ç”¨æ€§

**éœ€æ±‚**:

- å¯ç”¨æ€§99.99%
- å…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼ˆ<5ç§’ï¼‰
- å…¨çƒå»¶è¿Ÿ<300ms

**å®ç°æ–¹æ¡ˆ: CRDT G-Counter**

```python
from dataclasses import dataclass
from typing import Dict
import json

@dataclass
class GCounter:
    """G-Counter: å¢é•¿è®¡æ•°å™¨ï¼ˆCRDTï¼‰"""
    node_id: str
    counters: Dict[str, int]  # {node_id: count}

    def increment(self):
        """æœ¬åœ°é€’å¢"""
        self.counters[self.node_id] = self.counters.get(self.node_id, 0) + 1

    def merge(self, other: 'GCounter') -> 'GCounter':
        """åˆå¹¶ä¸¤ä¸ªè®¡æ•°å™¨"""
        merged = GCounter(self.node_id, self.counters.copy())
        for node_id, count in other.counters.items():
            merged.counters[node_id] = max(
                merged.counters.get(node_id, 0),
                count
            )
        return merged

    def value(self) -> int:
        """è·å–æ€»å€¼"""
        return sum(self.counters.values())

# PostgreSQLå­˜å‚¨
CREATE TABLE likes (
    post_id BIGINT,
    node_id VARCHAR(50),
    counter JSONB,  -- {"node1": 10, "node2": 5, ...}
    updated_at TIMESTAMP,
    PRIMARY KEY (post_id, node_id)
);

-- ç‚¹èµæ“ä½œ
def like_post(post_id: int, user_id: int, node_id: str):
    """ç‚¹èµï¼ˆæœ¬åœ°èŠ‚ç‚¹ï¼‰"""
    with db.cursor() as cur:
        # è¯»å–å½“å‰è®¡æ•°å™¨
        cur.execute("""
            SELECT counter FROM likes
            WHERE post_id = %s AND node_id = %s
        """, (post_id, node_id))

        row = cur.fetchone()
        if row:
            counter = GCounter(node_id, row[0])
        else:
            counter = GCounter(node_id, {})

        # é€’å¢
        counter.increment()

        # ä¿å­˜
        cur.execute("""
            INSERT INTO likes (post_id, node_id, counter, updated_at)
            VALUES (%s, %s, %s, NOW())
            ON CONFLICT (post_id, node_id)
            DO UPDATE SET counter = %s, updated_at = NOW()
        """, (post_id, node_id, json.dumps(counter.counters),
              json.dumps(counter.counters)))

        db.commit()

-- åˆå¹¶æ“ä½œï¼ˆå®šæœŸæ‰§è¡Œï¼‰
def merge_counters(post_id: int):
    """åˆå¹¶æ‰€æœ‰èŠ‚ç‚¹çš„è®¡æ•°å™¨"""
    with db.cursor() as cur:
        # è¯»å–æ‰€æœ‰èŠ‚ç‚¹è®¡æ•°å™¨
        cur.execute("""
            SELECT counter FROM likes WHERE post_id = %s
        """, (post_id,))

        rows = cur.fetchall()
        merged = GCounter("merged", {})

        for row in rows:
            other = GCounter("", row[0])
            merged = merged.merge(other)

        # æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹ä¸ºåˆå¹¶åçš„å€¼
        cur.execute("""
            UPDATE likes
            SET counter = %s, updated_at = NOW()
            WHERE post_id = %s
        """, (json.dumps(merged.counters), post_id))

        db.commit()
```

**æ€§èƒ½æ•°æ®** (ç”Ÿäº§ç¯å¢ƒ):

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ |
|-----|-------|--------|
| **å¯ç”¨æ€§** | 99.99% | 99.995% |
| **æœ€ç»ˆä¸€è‡´æ€§å»¶è¿Ÿ** | <5ç§’ | å¹³å‡2ç§’ |
| **å…¨çƒå»¶è¿Ÿ** | <300ms | P99 250ms |
| **TPS** | 100K | 120K |

---

## ä¸ƒã€å®Œæ•´ä»£ç å®ç°åº“

### 7.1 äº‹åŠ¡ç®¡ç†å·¥å…·ç±»

```python
from contextlib import contextmanager
from typing import Optional
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_SERIALIZABLE

class TransactionManager:
    """äº‹åŠ¡ç®¡ç†å·¥å…·ç±»"""

    def __init__(self, connection_string: str):
        self.conn = psycopg2.connect(connection_string)

    @contextmanager
    def transaction(self, isolation_level: Optional[str] = None):
        """äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        if isolation_level:
            if isolation_level == 'SERIALIZABLE':
                self.conn.set_isolation_level(ISOLATION_LEVEL_SERIALIZABLE)
            elif isolation_level == 'REPEATABLE_READ':
                self.conn.set_isolation_level(ISOLATION_LEVEL_REPEATABLE_READ)
            # ... å…¶ä»–çº§åˆ«

        try:
            yield self.conn
            self.conn.commit()
        except Exception as e:
            self.conn.rollback()
            raise
        finally:
            # æ¢å¤é»˜è®¤éš”ç¦»çº§åˆ«
            self.conn.set_isolation_level(ISOLATION_LEVEL_READ_COMMITTED)

    def execute_with_retry(self, sql: str, params: tuple,
                          max_retries: int = 3):
        """å¸¦é‡è¯•çš„æ‰§è¡Œï¼ˆå¤„ç†åºåˆ—åŒ–é”™è¯¯ï¼‰"""
        for attempt in range(max_retries):
            try:
                with self.transaction('SERIALIZABLE'):
                    cur = self.conn.cursor()
                    cur.execute(sql, params)
                    result = cur.fetchall() if cur.description else None
                    cur.close()
                    return result
            except psycopg2.extensions.TransactionRollbackError as e:
                if attempt == max_retries - 1:
                    raise
                # æŒ‡æ•°é€€é¿
                time.sleep(0.1 * (2 ** attempt))
                continue
```

### 7.2 é”ç®¡ç†å·¥å…·

```python
import time
from contextlib import contextmanager

class LockManager:
    """é”ç®¡ç†å·¥å…·"""

    def __init__(self, db):
        self.db = db

    @contextmanager
    def row_lock(self, table: str, row_id: int, lock_type: str = 'UPDATE'):
        """è¡Œçº§é”ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        cur = self.db.cursor()
        try:
            if lock_type == 'UPDATE':
                cur.execute(f"SELECT * FROM {table} WHERE id = %s FOR UPDATE",
                           (row_id,))
            elif lock_type == 'SHARE':
                cur.execute(f"SELECT * FROM {table} WHERE id = %s FOR SHARE",
                           (row_id,))
            else:
                raise ValueError(f"Unknown lock type: {lock_type}")

            yield cur

        finally:
            cur.close()

    def try_lock(self, lock_name: str, timeout: float = 5.0) -> bool:
        """å°è¯•è·å–åº”ç”¨çº§é”"""
        cur = self.db.cursor()
        try:
            cur.execute("SELECT pg_try_advisory_lock(%s)", (hash(lock_name),))
            acquired = cur.fetchone()[0]
            return acquired
        finally:
            cur.close()

    @contextmanager
    def advisory_lock(self, lock_name: str, timeout: float = 5.0):
        """å’¨è¯¢é”ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        cur = self.db.cursor()
        try:
            cur.execute("SELECT pg_advisory_lock(%s)", (hash(lock_name),))
            yield
        finally:
            cur.execute("SELECT pg_advisory_unlock(%s)", (hash(lock_name),))
            cur.close()
```

### 7.3 æ€§èƒ½ç›‘æ§å·¥å…·

```python
import time
from functools import wraps
from typing import Callable
import psycopg2

def monitor_query(func: Callable):
    """æŸ¥è¯¢æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = func(*args, **kwargs)
            duration = time.time() - start_time

            # è®°å½•æ…¢æŸ¥è¯¢
            if duration > 1.0:  # è¶…è¿‡1ç§’
                log_slow_query(func.__name__, duration, args, kwargs)

            return result
        except Exception as e:
            duration = time.time() - start_time
            log_query_error(func.__name__, duration, e, args, kwargs)
            raise
    return wrapper

class PerformanceMonitor:
    """æ€§èƒ½ç›‘æ§ç±»"""

    def __init__(self, db):
        self.db = db

    def get_slow_queries(self, threshold_ms: int = 1000, limit: int = 10):
        """è·å–æ…¢æŸ¥è¯¢"""
        cur = self.db.cursor()
        cur.execute("""
            SELECT
                query,
                calls,
                total_exec_time,
                mean_exec_time,
                max_exec_time
            FROM pg_stat_statements
            WHERE mean_exec_time > %s
            ORDER BY mean_exec_time DESC
            LIMIT %s
        """, (threshold_ms, limit))

        return cur.fetchall()

    def get_lock_waits(self):
        """è·å–é”ç­‰å¾…æƒ…å†µ"""
        cur = self.db.cursor()
        cur.execute("""
            SELECT
                blocked_locks.pid AS blocked_pid,
                blocking_locks.pid AS blocking_pid,
                blocked_activity.query AS blocked_query,
                blocking_activity.query AS blocking_query
            FROM pg_catalog.pg_locks blocked_locks
            JOIN pg_catalog.pg_stat_activity blocked_activity
                ON blocked_activity.pid = blocked_locks.pid
            JOIN pg_catalog.pg_locks blocking_locks
                ON blocking_locks.locktype = blocked_locks.locktype
                AND blocking_locks.database IS NOT DISTINCT
                    FROM blocked_locks.database
                AND blocking_locks.relation IS NOT DISTINCT
                    FROM blocked_locks.relation
                AND blocking_locks.pid != blocked_locks.pid
            JOIN pg_catalog.pg_stat_activity blocking_activity
                ON blocking_activity.pid = blocking_locks.pid
            WHERE NOT blocked_locks.granted
        """)

        return cur.fetchall()
```

---

## å…«ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´é”ç­‰å¾…

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: åœ¨äº‹åŠ¡ä¸­è°ƒç”¨å¤–éƒ¨API
def process_order(order_id):
    with transaction_manager.transaction():
        # 1. è¯»å–è®¢å•
        order = get_order(order_id)

        # 2. è°ƒç”¨æ”¯ä»˜APIï¼ˆè€—æ—¶5ç§’ï¼ï¼‰
        payment_result = call_payment_api(order.amount)  # âŒ æŒé”5ç§’

        # 3. æ›´æ–°è®¢å•çŠ¶æ€
        update_order_status(order_id, 'paid')

        # é—®é¢˜: å…¶ä»–äº‹åŠ¡ç­‰å¾…5ç§’ï¼ŒTPSä¸‹é™
```

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: æ‹†åˆ†äº‹åŠ¡
def process_order(order_id):
    # é˜¶æ®µ1: å¿«é€Ÿè¯»å–ï¼ˆæ— é”ï¼‰
    order = get_order(order_id)

    # é˜¶æ®µ2: å¤–éƒ¨è°ƒç”¨ï¼ˆäº‹åŠ¡å¤–ï¼‰
    payment_result = call_payment_api(order.amount)

    # é˜¶æ®µ3: æ›´æ–°çŠ¶æ€ï¼ˆçŸ­äº‹åŠ¡ï¼‰
    with transaction_manager.transaction():
        update_order_status(order_id, 'paid', payment_result.tx_id)
```

### åä¾‹2: çƒ­ç‚¹è¡Œç«äº‰

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: æ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€è¡Œ
UPDATE user_stats
SET login_count = login_count + 1
WHERE user_id = 12345;
-- é—®é¢˜: é«˜å¹¶å‘æ—¶é”ç«äº‰æ¿€çƒˆï¼ŒTPSä½
```

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: ä½¿ç”¨è®¡æ•°å™¨è¡¨åˆ†æ•£
CREATE TABLE user_stats_shards (
    user_id INT,
    shard_id INT,  -- 0-9
    login_count INT,
    PRIMARY KEY (user_id, shard_id)
);

-- éšæœºé€‰æ‹©åˆ†ç‰‡
UPDATE user_stats_shards
SET login_count = login_count + 1
WHERE user_id = 12345
  AND shard_id = floor(random() * 10)::int;

-- æŸ¥è¯¢æ—¶èšåˆ
SELECT SUM(login_count)
FROM user_stats_shards
WHERE user_id = 12345;
```

### åä¾‹3: N+1æŸ¥è¯¢é—®é¢˜

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: å¾ªç¯æŸ¥è¯¢
def get_user_orders(user_id):
    users = db.execute("SELECT * FROM users WHERE id = %s", (user_id,))
    orders = []
    for user in users:  # Næ¬¡æŸ¥è¯¢
        user_orders = db.execute(
            "SELECT * FROM orders WHERE user_id = %s",
            (user.id,)
        )
        orders.extend(user_orders)
    return orders
# é—®é¢˜: 1 + Næ¬¡æ•°æ®åº“å¾€è¿”
```

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: JOINæŸ¥è¯¢
def get_user_orders(user_id):
    return db.execute("""
        SELECT u.*, o.*
        FROM users u
        LEFT JOIN orders o ON u.id = o.user_id
        WHERE u.id = %s
    """, (user_id,))
# ä¼˜åŠ¿: 1æ¬¡æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡Nå€
```

---

## ä¹ã€æœ€ä½³å®è·µæ€»ç»“

### 9.1 è®¾è®¡åŸåˆ™

1. **çŸ­äº‹åŠ¡åŸåˆ™**: äº‹åŠ¡å†…åªåšæ•°æ®åº“æ“ä½œï¼Œå¤–éƒ¨è°ƒç”¨æ”¾åœ¨äº‹åŠ¡å¤–
2. **æœ€å°é”åŸåˆ™**: ä½¿ç”¨è¡Œçº§é”è€Œéè¡¨çº§é”ï¼Œé”ç²’åº¦å°½å¯èƒ½ç»†
3. **é¿å…çƒ­ç‚¹**: é€šè¿‡åˆ†ç‰‡ã€ç¼“å­˜ã€é˜Ÿåˆ—åˆ†æ•£çƒ­ç‚¹
4. **å¹‚ç­‰æ€§è®¾è®¡**: æ‰€æœ‰å†™æ“ä½œæ”¯æŒé‡å¤æ‰§è¡Œè€Œä¸äº§ç”Ÿå‰¯ä½œç”¨

### 9.2 æ€§èƒ½ä¼˜åŒ–æ¸…å•

**å¼€å‘é˜¶æ®µ**:

- [ ] ä½¿ç”¨åˆé€‚çš„éš”ç¦»çº§åˆ«ï¼ˆé¿å…è¿‡åº¦ä½¿ç”¨Serializableï¼‰
- [ ] é¿å…é•¿äº‹åŠ¡ï¼ˆäº‹åŠ¡å†…ä¸è°ƒç”¨å¤–éƒ¨APIï¼‰
- [ ] ä½¿ç”¨ç´¢å¼•ï¼ˆWHEREã€JOINåˆ—ï¼‰
- [ ] é¿å…N+1æŸ¥è¯¢ï¼ˆä½¿ç”¨JOINæˆ–æ‰¹é‡æŸ¥è¯¢ï¼‰

**æµ‹è¯•é˜¶æ®µ**:

- [ ] å‹åŠ›æµ‹è¯•ï¼ˆæ‰¾åˆ°æ€§èƒ½ä¸Šé™ï¼‰
- [ ] å¹¶å‘æµ‹è¯•ï¼ˆéªŒè¯æ­»é”å¤„ç†ï¼‰
- [ ] ç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆpg_stat_statementsï¼‰

**è¿ç»´é˜¶æ®µ**:

- [ ] å®šæœŸVACUUMï¼ˆé˜²æ­¢è¡¨è†¨èƒ€ï¼‰
- [ ] ç›‘æ§é”ç­‰å¾…ï¼ˆpg_locksï¼‰
- [ ] è°ƒæ•´å‚æ•°ï¼ˆshared_buffersã€work_memç­‰ï¼‰

### 9.3 æ•…éšœå¤„ç†æµç¨‹

```text
æ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹:
1. æ£€æŸ¥æ…¢æŸ¥è¯¢ (pg_stat_statements)
   â†“
2. åˆ†ææ‰§è¡Œè®¡åˆ’ (EXPLAIN ANALYZE)
   â†“
3. æ£€æŸ¥é”ç­‰å¾… (pg_locks)
   â†“
4. æ£€æŸ¥è¡¨è†¨èƒ€ (pg_stat_user_tables)
   â†“
5. ä¼˜åŒ–æ–¹æ¡ˆ:
   - æ·»åŠ ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢
   - è°ƒæ•´éš”ç¦»çº§åˆ«
   - æ‹†åˆ†äº‹åŠ¡
```

---

---

## åã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 æ¡ˆä¾‹: æŸå¤§å‹ç³»ç»Ÿæ¶æ„æ¼”è¿›

**åœºæ™¯**: å¤§å‹äº’è”ç½‘å…¬å¸ç³»ç»Ÿæ¶æ„æ¼”è¿›

**æ¼”è¿›è¿‡ç¨‹**:

- é˜¶æ®µ1: å•ä½“åº”ç”¨ï¼ˆå•æ•°æ®åº“ï¼‰
- é˜¶æ®µ2: è¯»å†™åˆ†ç¦»ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
- é˜¶æ®µ3: åˆ†åº“åˆ†è¡¨ï¼ˆæ°´å¹³æ‹†åˆ†ï¼‰
- é˜¶æ®µ4: å¾®æœåŠ¡ï¼ˆæœåŠ¡åŒ–æ‹†åˆ†ï¼‰

**æŠ€æœ¯æ–¹æ¡ˆ**:

```python
# é˜¶æ®µ1: å•ä½“
class MonolithicApp:
    def __init__(self):
        self.db = PostgreSQLConnection()

    def process_order(self, order):
        # æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
        with self.db.transaction():
            self.db.insert('orders', order)
            self.db.update('inventory', order.items)
            self.db.insert('payments', order.payment)

# é˜¶æ®µ4: å¾®æœåŠ¡
class MicroserviceApp:
    def __init__(self):
        self.order_service = OrderService()
        self.inventory_service = InventoryService()
        self.payment_service = PaymentService()

    async def process_order(self, order):
        # åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSagaæ¨¡å¼ï¼‰
        async with saga_transaction():
            await self.order_service.create(order)
            await self.inventory_service.reserve(order.items)
            await self.payment_service.charge(order.payment)
```

**æ¼”è¿›æ•ˆæœ**: ç³»ç»Ÿå¯æ‰©å±•æ€§æå‡10å€

### 10.2 æ¡ˆä¾‹: å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡å®è·µ

**åœºæ™¯**: å¾®æœåŠ¡æ¶æ„æ•°æ®åº“è®¾è®¡

**è®¾è®¡åŸåˆ™**:

- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“
- æœåŠ¡é—´é€šè¿‡APIé€šä¿¡
- æ•°æ®ä¸€è‡´æ€§é€šè¿‡æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- è®¢å•æœåŠ¡æ•°æ®åº“
CREATE DATABASE order_service;

-- ç”¨æˆ·æœåŠ¡æ•°æ®åº“
CREATE DATABASE user_service;

-- åº“å­˜æœåŠ¡æ•°æ®åº“
CREATE DATABASE inventory_service;

-- æœåŠ¡é—´é€šè¿‡äº‹ä»¶æ€»çº¿é€šä¿¡
CREATE TABLE order_events (
    id BIGSERIAL PRIMARY KEY,
    event_type VARCHAR(100),
    payload JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**ä¼˜åŒ–æ•ˆæœ**: æœåŠ¡ç‹¬ç«‹æ‰©å±•ï¼Œæ•°æ®åº“æ€§èƒ½æå‡50%

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´ä»£ç å®ç°ã€3ä¸ªè¯¦ç»†æ¡ˆä¾‹ã€åä¾‹åˆ†æã€æ€§èƒ½ç›‘æ§å·¥å…·ã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

**å…³è”æ–‡æ¡£**:

- `02-è®¾è®¡æƒè¡¡åˆ†æ/` (æ‰€æœ‰å†³ç­–å·¥å…·)
- `06-æ€§èƒ½åˆ†æ/` (æ€§èƒ½æ¨¡å‹)
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/` (è¯¦ç»†æ¡ˆä¾‹)
