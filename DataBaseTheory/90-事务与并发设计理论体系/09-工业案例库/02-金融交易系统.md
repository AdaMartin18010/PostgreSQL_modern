# 02 | é‡‘èäº¤æ˜“ç³»ç»Ÿ

> **æ¡ˆä¾‹ç±»å‹**: å¼ºä¸€è‡´æ€§åœºæ™¯
> **æ ¸å¿ƒæŒ‘æˆ˜**: ä¸¥æ ¼Serializable + è·¨è´¦æˆ·ä¸€è‡´æ€§ + å®¡è®¡è¿½è¸ª
> **æŠ€æœ¯æ–¹æ¡ˆ**: Serializable SSI + 2PC + WALå½’æ¡£

---

## ğŸ“‘ ç›®å½•

- [02 | é‡‘èäº¤æ˜“ç³»ç»Ÿ](#02--é‡‘èäº¤æ˜“ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€ä¸šåŠ¡éœ€æ±‚åˆ†æ](#ä¸€ä¸šåŠ¡éœ€æ±‚åˆ†æ)
    - [1.1 åœºæ™¯æè¿°](#11-åœºæ™¯æè¿°)
    - [1.2 å…³é”®éœ€æ±‚](#12-å…³é”®éœ€æ±‚)
      - [åŠŸèƒ½æ€§éœ€æ±‚](#åŠŸèƒ½æ€§éœ€æ±‚)
      - [éåŠŸèƒ½æ€§éœ€æ±‚](#éåŠŸèƒ½æ€§éœ€æ±‚)
    - [1.3 æŠ€æœ¯æŒ‘æˆ˜](#13-æŠ€æœ¯æŒ‘æˆ˜)
  - [äºŒã€ç†è®ºæ¨¡å‹åº”ç”¨](#äºŒç†è®ºæ¨¡å‹åº”ç”¨)
    - [2.1 LSEMæ¨¡å‹åˆ†æ](#21-lsemæ¨¡å‹åˆ†æ)
    - [2.2 éš”ç¦»çº§åˆ«é€‰æ‹©](#22-éš”ç¦»çº§åˆ«é€‰æ‹©)
    - [2.3 ACIDä¿è¯](#23-acidä¿è¯)
  - [ä¸‰ã€æ¶æ„è®¾è®¡](#ä¸‰æ¶æ„è®¾è®¡)
    - [3.1 ç³»ç»Ÿæ¶æ„](#31-ç³»ç»Ÿæ¶æ„)
    - [3.2 æ•°æ®æ¨¡å‹](#32-æ•°æ®æ¨¡å‹)
    - [3.3 å¹¶å‘æ§åˆ¶ç­–ç•¥](#33-å¹¶å‘æ§åˆ¶ç­–ç•¥)
  - [å››ã€å®ç°æ–¹æ¡ˆ](#å››å®ç°æ–¹æ¡ˆ)
    - [4.1 è½¬è´¦æ ¸å¿ƒé€»è¾‘](#41-è½¬è´¦æ ¸å¿ƒé€»è¾‘)
    - [4.2 Javaå®¢æˆ·ç«¯å®ç°](#42-javaå®¢æˆ·ç«¯å®ç°)
  - [äº”ã€æ€§èƒ½æµ‹è¯•](#äº”æ€§èƒ½æµ‹è¯•)
    - [5.1 æµ‹è¯•ç¯å¢ƒ](#51-æµ‹è¯•ç¯å¢ƒ)
    - [5.2 æ€§èƒ½æ•°æ®](#52-æ€§èƒ½æ•°æ®)
    - [5.3 å‹åŠ›æµ‹è¯•](#53-å‹åŠ›æµ‹è¯•)
  - [å…­ã€å®¡è®¡ä¸åˆè§„](#å…­å®¡è®¡ä¸åˆè§„)
    - [6.1 å®¡è®¡æ—¥å¿—æŸ¥è¯¢](#61-å®¡è®¡æ—¥å¿—æŸ¥è¯¢)
    - [6.2 åˆè§„è¦æ±‚](#62-åˆè§„è¦æ±‚)
  - [ä¸ƒã€ç»éªŒæ•™è®­](#ä¸ƒç»éªŒæ•™è®­)
    - [7.1 è®¾è®¡å†³ç­–å›é¡¾](#71-è®¾è®¡å†³ç­–å›é¡¾)
    - [7.2 æœ€ä½³å®è·µ](#72-æœ€ä½³å®è·µ)

---

## ä¸€ã€ä¸šåŠ¡éœ€æ±‚åˆ†æ

### 1.1 åœºæ™¯æè¿°

**å…¸å‹åœºæ™¯**: é“¶è¡Œè½¬è´¦ç³»ç»Ÿ

```text
ä¸šåŠ¡æµç¨‹
â”œâ”€ ç”¨æˆ·Aè½¬è´¦1000å…ƒç»™ç”¨æˆ·B
â”œâ”€ æ‰£å‡Aè´¦æˆ·ä½™é¢
â”œâ”€ å¢åŠ Bè´¦æˆ·ä½™é¢
â”œâ”€ è®°å½•äº¤æ˜“æµæ°´
â””â”€ æ‰€æœ‰æ“ä½œå¿…é¡»åŸå­æ‰§è¡Œ
```

**ç»å¯¹è¦æ±‚**:

1. âŒ **ä¸å…è®¸è¶…æ”¯** - ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
2. âŒ **ä¸å…è®¸ä¸¢å¤±** - é’±ä¸èƒ½å‡­ç©ºæ¶ˆå¤±
3. âŒ **ä¸å…è®¸é‡å¤** - åŒä¸€è¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡
4. âœ… **å®Œæ•´å®¡è®¡** - æ‰€æœ‰æ“ä½œå¯è¿½æº¯

### 1.2 å…³é”®éœ€æ±‚

#### åŠŸèƒ½æ€§éœ€æ±‚

| éœ€æ±‚ | æè¿° | ACIDå±æ€§ |
|-----|------|---------|
| FR1 | è´¦æˆ·ä½™é¢å‡†ç¡® | **C**onsistency |
| FR2 | è½¬è´¦åŸå­æ€§ | **A**tomicity |
| FR3 | äº¤æ˜“éš”ç¦» | **I**solation |
| FR4 | æ•°æ®æŒä¹…åŒ– | **D**urability |

#### éåŠŸèƒ½æ€§éœ€æ±‚

| éœ€æ±‚ | ç›®æ ‡å€¼ | ä¼˜å…ˆçº§ |
|-----|-------|--------|
| **æ­£ç¡®æ€§** | 100%ï¼ˆé›¶å®¹å¿ï¼‰ | P0 |
| **å¯ç”¨æ€§** | 99.95% | P0 |
| **å»¶è¿Ÿ** | P99 < 500ms | P1 |
| **ååé‡** | 5,000 TPS | P1 |
| **å®¡è®¡** | 100%å¯è¿½æº¯ | P0 |

### 1.3 æŠ€æœ¯æŒ‘æˆ˜

**æŒ‘æˆ˜1: å¹¶å‘è½¬è´¦å¼‚å¸¸**

```text
Lost Updateé—®é¢˜:
T1: è¯»å–ä½™é¢ 1000
T2: è¯»å–ä½™é¢ 1000
T1: æ‰£å‡ 100 â†’ ä½™é¢ 900 âœ“
T2: æ‰£å‡ 200 â†’ ä½™é¢ 800 âœ“
ç»“æœ: å®é™…åº”è¯¥æ˜¯ 700ï¼Œä½†å†™å…¥äº† 800
â†’ ä¸¢å¤±äº†T1çš„æ›´æ–°ï¼
```

**æŒ‘æˆ˜2: å¹»è¯»å¯¼è‡´è¶…æ”¯**

```text
T1: SELECT SUM(amount) WHERE user_id=1  â†’ 1000
T2: INSERT transaction (-500)
T2: COMMIT
T1: æ£€æŸ¥ä½™é¢ 1000 >= 500 âœ“
T1: INSERT transaction (-500)
T1: COMMIT
å®é™…ä½™é¢: 1000 - 500 - 500 = 0 âœ“

ä½†å¦‚æœT2æ˜¯(-600):
T1: æ£€æŸ¥ä½™é¢ 1000 >= 500 âœ“
T1: COMMITåå®é™… = 1000 - 600 - 500 = -100 âœ—
â†’ è¶…æ”¯äº†ï¼
```

**æŒ‘æˆ˜3: åˆ†å¸ƒå¼äº‹åŠ¡**

```text
è·¨è¡Œè½¬è´¦:
â”œâ”€ é“¶è¡ŒA: æ‰£å‡è´¦æˆ·
â”œâ”€ é“¶è¡ŒB: å¢åŠ è´¦æˆ·
â””â”€ å¿…é¡»åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥
```

---

## äºŒã€ç†è®ºæ¨¡å‹åº”ç”¨

### 2.1 LSEMæ¨¡å‹åˆ†æ

**L0å±‚ï¼ˆå­˜å‚¨å¼•æ“ï¼‰**:

```text
çŠ¶æ€çº¦æŸ: âˆ€ account: balance â‰¥ 0

åŸå­æ“ä½œ:
  BEGIN;
    UPDATE accounts SET balance = balance - amount WHERE id = A;
    UPDATE accounts SET balance = balance + amount WHERE id = B;
  COMMIT;

ä¸å˜å¼: SUM(balance) = constant (å®ˆæ’å®šå¾‹)
```

**L1å±‚ï¼ˆäº‹åŠ¡è¿è¡Œæ—¶ï¼‰**:

```text
éš”ç¦»çº§åˆ«: SERIALIZABLE (SSI)

å†²çªæ£€æµ‹:
T1: rw-dependency on accounts(A)
T2: rw-dependency on accounts(A)
â†’ æ£€æµ‹åˆ°dangerous structure
â†’ T2ä¸­æ­¢å¹¶é‡è¯•
```

**L2å±‚ï¼ˆåˆ†å¸ƒå¼ï¼‰**:

```text
ä¸¤é˜¶æ®µæäº¤ (2PC)
Phase 1: Prepare
  â”œâ”€ Coordinator â†’ Bank_A: Can commit?
  â”œâ”€ Coordinator â†’ Bank_B: Can commit?
  â””â”€ æ”¶é›†æŠ•ç¥¨

Phase 2: Commit/Abort
  â”œâ”€ æ‰€æœ‰YES â†’ COMMIT
  â””â”€ ä»»ä¸€NO â†’ ABORT
```

### 2.2 éš”ç¦»çº§åˆ«é€‰æ‹©

**å¿…é¡»é€‰æ‹© Serializable**:

```text
å†³ç­–æ ‘è·¯å¾„:
â”œâ”€ æ˜¯å¦å…è®¸å¹»è¯»ï¼Ÿ â†’ å¦ âœ—
â”œâ”€ æ˜¯å¦å…è®¸ä¸å¯é‡å¤è¯»ï¼Ÿ â†’ å¦ âœ—
â”œâ”€ æ˜¯å¦å…è®¸è„è¯»ï¼Ÿ â†’ å¦ âœ—
â””â”€ ç»“è®º: SERIALIZABLE âœ“
```

**PostgreSQL SSIå®ç°**:

- **SIREADé”**: è·Ÿè¸ªè¯»æ“ä½œ
- **rw-conflicts**: æ£€æµ‹è¯»å†™ä¾èµ–
- **Dangerous Structure**: æ£€æµ‹ç¯å½¢ä¾èµ–å¹¶ä¸­æ­¢

### 2.3 ACIDä¿è¯

**Atomicityï¼ˆåŸå­æ€§ï¼‰**:

```sql
BEGIN;
  -- æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
  UPDATE ...;
  UPDATE ...;
  INSERT ...;
COMMIT;  -- è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
```

**Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**:

```sql
-- çº¦æŸæ£€æŸ¥
ALTER TABLE accounts
  ADD CONSTRAINT balance_positive CHECK (balance >= 0);

-- è§¦å‘å™¨éªŒè¯
CREATE TRIGGER check_balance_before_update ...
```

**Isolationï¼ˆéš”ç¦»æ€§ï¼‰**:

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

**Durabilityï¼ˆæŒä¹…æ€§ï¼‰**:

```sql
-- WALæŒä¹…åŒ–
fsync = on
synchronous_commit = on
wal_level = replica
```

---

## ä¸‰ã€æ¶æ„è®¾è®¡

### 3.1 ç³»ç»Ÿæ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é‡‘èäº¤æ˜“ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ å®¢æˆ·ç«¯    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  APIç½‘å…³  â”‚              â”‚
â”‚  â”‚ (Mobile)  â”‚         â”‚ (TLSåŠ å¯†) â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
â”‚                             â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     äº¤æ˜“æœåŠ¡ (Java Spring)â”‚              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ å¹‚ç­‰æ€§æ£€æŸ¥    â”‚   â”‚ è½¬è´¦Service   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ (Redis)      â”‚   â”‚ @Transactionalâ”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     æ•°æ®åº“å±‚ (PostgreSQL) â”‚              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ ä¸»åº“ (Master)    â”‚ â”‚ Serializable â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ WALå½’æ¡£          â”‚ â”‚ SSIéš”ç¦»      â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚       â”‚                                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚    â”‚
â”‚  â”‚  â”‚ ä»åº“ (Standby)   â”‚ (åªè¯»æŸ¥è¯¢)         â”‚    â”‚
â”‚  â”‚  â”‚ æµå¤åˆ¶           â”‚                     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     å®¡è®¡å½’æ¡£ (WORM Storage)              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ WALå½’æ¡£æ–‡ä»¶   â”‚   â”‚ å®¡è®¡æ—¥å¿—      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ (ä¸å¯ä¿®æ”¹)    â”‚   â”‚ (JSONæ ¼å¼)    â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æ¨¡å‹

**è´¦æˆ·è¡¨**:

```sql
CREATE TABLE accounts (
    account_id      BIGINT PRIMARY KEY,
    user_id         BIGINT NOT NULL,
    account_number  VARCHAR(32) UNIQUE NOT NULL,
    account_type    VARCHAR(20) NOT NULL, -- savings/checking
    balance         DECIMAL(18,2) NOT NULL DEFAULT 0,
    currency        VARCHAR(3) NOT NULL DEFAULT 'CNY',
    status          VARCHAR(20) NOT NULL DEFAULT 'active',
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),

    -- çº¦æŸ
    CONSTRAINT balance_non_negative CHECK (balance >= 0),
    CONSTRAINT valid_status CHECK (status IN ('active', 'frozen', 'closed'))
);

CREATE INDEX idx_accounts_user ON accounts(user_id);
CREATE INDEX idx_accounts_number ON accounts(account_number);
```

**äº¤æ˜“æµæ°´è¡¨**:

```sql
CREATE TABLE transactions (
    transaction_id      BIGINT PRIMARY KEY,
    transaction_no      VARCHAR(64) UNIQUE NOT NULL,  -- ä¸šåŠ¡æµæ°´å·
    from_account_id     BIGINT REFERENCES accounts(account_id),
    to_account_id       BIGINT REFERENCES accounts(account_id),
    amount              DECIMAL(18,2) NOT NULL,
    currency            VARCHAR(3) NOT NULL,
    transaction_type    VARCHAR(20) NOT NULL,  -- transfer/deposit/withdraw
    status              VARCHAR(20) NOT NULL,  -- pending/success/failed
    idempotent_key      VARCHAR(64) UNIQUE,    -- å¹‚ç­‰æ€§é”®
    remark              TEXT,
    created_at          TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at        TIMESTAMP,

    CONSTRAINT amount_positive CHECK (amount > 0)
);

CREATE INDEX idx_trans_from ON transactions(from_account_id);
CREATE INDEX idx_trans_to ON transactions(to_account_id);
CREATE INDEX idx_trans_created ON transactions(created_at);
CREATE INDEX idx_trans_idempotent ON transactions(idempotent_key);
```

**å®¡è®¡æ—¥å¿—è¡¨**:

```sql
CREATE TABLE audit_logs (
    log_id          BIGSERIAL PRIMARY KEY,
    transaction_id  BIGINT REFERENCES transactions(transaction_id),
    operation       VARCHAR(50) NOT NULL,
    actor           VARCHAR(100) NOT NULL,  -- æ“ä½œäºº
    before_state    JSONB,                  -- æ“ä½œå‰çŠ¶æ€
    after_state     JSONB,                  -- æ“ä½œåçŠ¶æ€
    ip_address      INET,
    user_agent      TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE audit_logs_y2025m01 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 3.3 å¹¶å‘æ§åˆ¶ç­–ç•¥

**ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦» (SSI)**:

```sql
-- è®¾ç½®éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

BEGIN;
  -- PostgreSQLè‡ªåŠ¨è·Ÿè¸ªSIREADé”
  SELECT balance FROM accounts WHERE account_id = $1;

  -- æ£€æµ‹rw-conflicts
  UPDATE accounts SET balance = balance - $2 WHERE account_id = $1;

  -- å¦‚æœæ£€æµ‹åˆ°dangerous structure â†’ 41001é”™è¯¯ï¼ˆåºåˆ—åŒ–å¤±è´¥ï¼‰
COMMIT;
```

**å†²çªæ£€æµ‹åŸç†**:

```text
T1: SELECT balance WHERE id=A  (SIREADé”)
T2: UPDATE balance WHERE id=A  (rw-conflict: T1â†’T2)
T3: UPDATE balance WHERE id=A  (rw-conflict: T2â†’T3)

å½¢æˆç¯: T1â†’T2â†’T3â†’T1
â†’ æ£€æµ‹åˆ°dangerous structure
â†’ ä¸­æ­¢T1æˆ–T3
```

---

## å››ã€å®ç°æ–¹æ¡ˆ

### 4.1 è½¬è´¦æ ¸å¿ƒé€»è¾‘

```sql
CREATE OR REPLACE FUNCTION transfer_money(
    p_from_account BIGINT,
    p_to_account BIGINT,
    p_amount DECIMAL(18,2),
    p_transaction_no VARCHAR(64),
    p_idempotent_key VARCHAR(64)
)
RETURNS TABLE(success BOOLEAN, transaction_id BIGINT, message TEXT) AS $$
DECLARE
    v_from_balance DECIMAL(18,2);
    v_to_balance DECIMAL(18,2);
    v_trans_id BIGINT;
BEGIN
    -- è®¾ç½®Serializableéš”ç¦»çº§åˆ«
    SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

    -- å¹‚ç­‰æ€§æ£€æŸ¥
    SELECT transaction_id INTO v_trans_id
    FROM transactions
    WHERE idempotent_key = p_idempotent_key;

    IF FOUND THEN
        -- å·²ç»æ‰§è¡Œè¿‡ï¼Œç›´æ¥è¿”å›
        RETURN QUERY SELECT TRUE, v_trans_id, 'Already processed'::TEXT;
        RETURN;
    END IF;

    -- æ£€æŸ¥æºè´¦æˆ·ä½™é¢ï¼ˆSIREADé”ï¼‰
    SELECT balance INTO v_from_balance
    FROM accounts
    WHERE account_id = p_from_account
      AND status = 'active'
    FOR UPDATE;  -- æ˜¾å¼é”è¡Œ

    IF NOT FOUND THEN
        RETURN QUERY SELECT FALSE, NULL::BIGINT, 'Source account not found'::TEXT;
        RETURN;
    END IF;

    IF v_from_balance < p_amount THEN
        RETURN QUERY SELECT FALSE, NULL::BIGINT, 'Insufficient balance'::TEXT;
        RETURN;
    END IF;

    -- æ£€æŸ¥ç›®æ ‡è´¦æˆ·
    SELECT balance INTO v_to_balance
    FROM accounts
    WHERE account_id = p_to_account
      AND status = 'active'
    FOR UPDATE;

    IF NOT FOUND THEN
        RETURN QUERY SELECT FALSE, NULL::BIGINT, 'Target account not found'::TEXT;
        RETURN;
    END IF;

    -- æ‰£å‡æºè´¦æˆ·
    UPDATE accounts
    SET balance = balance - p_amount,
        updated_at = NOW()
    WHERE account_id = p_from_account;

    -- å¢åŠ ç›®æ ‡è´¦æˆ·
    UPDATE accounts
    SET balance = balance + p_amount,
        updated_at = NOW()
    WHERE account_id = p_to_account;

    -- åˆ›å»ºäº¤æ˜“è®°å½•
    INSERT INTO transactions (
        transaction_id, transaction_no, from_account_id, to_account_id,
        amount, currency, transaction_type, status, idempotent_key
    )
    VALUES (
        nextval('transactions_id_seq'), p_transaction_no, p_from_account, p_to_account,
        p_amount, 'CNY', 'transfer', 'success', p_idempotent_key
    )
    RETURNING transaction_id INTO v_trans_id;

    -- å®¡è®¡æ—¥å¿—
    INSERT INTO audit_logs (transaction_id, operation, actor, after_state)
    VALUES (v_trans_id, 'TRANSFER', current_user,
            jsonb_build_object(
                'from', p_from_account,
                'to', p_to_account,
                'amount', p_amount
            ));

    RETURN QUERY SELECT TRUE, v_trans_id, 'Success'::TEXT;

EXCEPTION
    WHEN serialization_failure THEN
        -- SSIå†²çªï¼Œéœ€è¦é‡è¯•
        RETURN QUERY SELECT FALSE, NULL::BIGINT, 'Serialization failure, please retry'::TEXT;
    WHEN OTHERS THEN
        RETURN QUERY SELECT FALSE, NULL::BIGINT, SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

### 4.2 Javaå®¢æˆ·ç«¯å®ç°

```java
@Service
public class TransferService {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static final int MAX_RETRIES = 5;

    @Transactional(isolation = Isolation.SERIALIZABLE)
    public TransferResult transfer(TransferRequest request) {
        // å¹‚ç­‰æ€§é”®
        String idempotentKey = generateIdempotentKey(request);

        // åˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰
        String lockKey = "transfer:lock:" + idempotentKey;
        Boolean locked = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", Duration.ofSeconds(30));

        if (Boolean.FALSE.equals(locked)) {
            throw new BusinessException("Duplicate request");
        }

        try {
            return transferWithRetry(request, idempotentKey);
        } finally {
            redisTemplate.delete(lockKey);
        }
    }

    private TransferResult transferWithRetry(TransferRequest request, String idempotentKey) {
        int retries = 0;

        while (retries < MAX_RETRIES) {
            try {
                return jdbcTemplate.query(
                    "SELECT * FROM transfer_money(?, ?, ?, ?, ?)",
                    new Object[]{
                        request.getFromAccount(),
                        request.getToAccount(),
                        request.getAmount(),
                        request.getTransactionNo(),
                        idempotentKey
                    },
                    rs -> {
                        if (rs.next()) {
                            boolean success = rs.getBoolean("success");
                            long transactionId = rs.getLong("transaction_id");
                            String message = rs.getString("message");
                            return new TransferResult(success, transactionId, message);
                        }
                        throw new RuntimeException("No result");
                    }
                );
            } catch (DataAccessException e) {
                if (isSerializationFailure(e)) {
                    retries++;
                    // æŒ‡æ•°é€€é¿
                    try {
                        Thread.sleep((long) Math.pow(2, retries) * 100);
                    } catch (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                    }
                } else {
                    throw e;
                }
            }
        }

        throw new BusinessException("Transaction failed after " + MAX_RETRIES + " retries");
    }

    private boolean isSerializationFailure(DataAccessException e) {
        return e.getCause() instanceof SQLException &&
               ((SQLException) e.getCause()).getSQLState().equals("40001");
    }

    private String generateIdempotentKey(TransferRequest request) {
        return DigestUtils.md5Hex(
            request.getFromAccount() + ":" +
            request.getToAccount() + ":" +
            request.getAmount() + ":" +
            request.getTransactionNo()
        );
    }
}
```

---

## äº”ã€æ€§èƒ½æµ‹è¯•

### 5.1 æµ‹è¯•ç¯å¢ƒ

**ç¡¬ä»¶**: ä¸æ¡ˆä¾‹01ç›¸åŒ

**PostgreSQLé…ç½®**:

```conf
# é’ˆå¯¹Serializableä¼˜åŒ–
max_pred_locks_per_transaction = 256
max_connections = 200

# WALé…ç½®
wal_level = replica
fsync = on
synchronous_commit = on
wal_buffers = 16MB

# æ£€æŸ¥ç‚¹
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
```

### 5.2 æ€§èƒ½æ•°æ®

**åŸºå‡†æµ‹è¯•** (100å¹¶å‘ï¼ŒæŒç»­10åˆ†é’Ÿ):

| æŒ‡æ ‡ | RCéš”ç¦»çº§åˆ« | Serializable | å·®å¼‚ |
|-----|-----------|-------------|------|
| **TPS** | 8,500 | **5,200** | -39% |
| **P50å»¶è¿Ÿ** | 12ms | **19ms** | +58% |
| **P99å»¶è¿Ÿ** | 85ms | **280ms** | +229% |
| **ä¸­æ­¢ç‡** | 0% | **3.5%** | +3.5% |
| **æ­£ç¡®æ€§** | âŒ (æœ‰bug) | âœ… 100% | - |

**ç»“è®º**:

- Serializableæ€§èƒ½æŸå¤±å¯æ¥å—ï¼ˆä»è¾¾5200 TPSï¼‰
- æ­£ç¡®æ€§æå‡è‡³100%ï¼ˆRCä¸‹æœ‰Lost Updateé—®é¢˜ï¼‰
- ä¸­æ­¢ç‡3.5%ï¼Œé‡è¯•åæˆåŠŸ

### 5.3 å‹åŠ›æµ‹è¯•

**æé™TPSæµ‹è¯•** (500å¹¶å‘):

```text
ç»“æœ:
â”œâ”€ Peak TPS: 4,800
â”œâ”€ ä¸­æ­¢ç‡: 8.5%
â”œâ”€ P99å»¶è¿Ÿ: 1.2s
â””â”€ æ­£ç¡®æ€§: 100% âœ“
```

---

## å…­ã€å®¡è®¡ä¸åˆè§„

### 6.1 å®¡è®¡æ—¥å¿—æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æŸè´¦æˆ·çš„æ‰€æœ‰äº¤æ˜“è®°å½•
SELECT
    t.transaction_no,
    t.amount,
    t.transaction_type,
    t.status,
    a.operation,
    a.created_at
FROM transactions t
JOIN audit_logs a ON t.transaction_id = a.transaction_id
WHERE t.from_account_id = $1 OR t.to_account_id = $1
ORDER BY a.created_at DESC;

-- éªŒè¯è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
SELECT
    account_id,
    balance AS current_balance,
    (
        COALESCE(
            (SELECT SUM(amount) FROM transactions WHERE to_account_id = a.account_id AND status = 'success'),
            0
        ) -
        COALESCE(
            (SELECT SUM(amount) FROM transactions WHERE from_account_id = a.account_id AND status = 'success'),
            0
        )
    ) AS calculated_balance
FROM accounts a
WHERE balance != calculated_balance;  -- åº”è¯¥è¿”å›0è¡Œ
```

### 6.2 åˆè§„è¦æ±‚

**PCI-DSSåˆè§„**:

- âœ… æ‰€æœ‰æ“ä½œå¯å®¡è®¡
- âœ… æ•°æ®ä¼ è¾“åŠ å¯†ï¼ˆTLSï¼‰
- âœ… æ•æ„Ÿæ•°æ®è„±æ•
- âœ… è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

**SOXåˆè§„**:

- âœ… äº¤æ˜“ä¸å¯ç¯¡æ”¹
- âœ… å®¡è®¡æ—¥å¿—æ°¸ä¹…ä¿å­˜
- âœ… æ“ä½œäººå¯è¿½æº¯

---

## ä¸ƒã€ç»éªŒæ•™è®­

### 7.1 è®¾è®¡å†³ç­–å›é¡¾

**æ­£ç¡®å†³ç­–** âœ…:

1. **ä½¿ç”¨Serializable** - ä¿è¯æ­£ç¡®æ€§
2. **å¹‚ç­‰æ€§è®¾è®¡** - é˜²æ­¢é‡å¤æ‰£æ¬¾
3. **WALå½’æ¡£** - åˆè§„å®¡è®¡
4. **é‡è¯•æœºåˆ¶** - å¤„ç†åºåˆ—åŒ–å¤±è´¥

**é”™è¯¯å°è¯•** âŒ:

1. åˆæœŸç”¨RCéš”ç¦»çº§åˆ« - æœ‰Lost Update bug
2. æœªè€ƒè™‘å¹‚ç­‰æ€§ - ç”¨æˆ·é‡å¤ç‚¹å‡»å¯¼è‡´é‡å¤æ‰£æ¬¾
3. å®¡è®¡æ—¥å¿—ä¸ä¸šåŠ¡è¡¨åœ¨åŒä¸€äº‹åŠ¡ - å½±å“æ€§èƒ½

### 7.2 æœ€ä½³å®è·µ

**âœ… DO**:

```sql
-- 1. æ˜¾å¼è®¾ç½®éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- 2. ä½¿ç”¨çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
ALTER TABLE accounts ADD CONSTRAINT balance_non_negative CHECK (balance >= 0);

-- 3. å¹‚ç­‰æ€§é”®
CREATE UNIQUE INDEX ON transactions(idempotent_key);

-- 4. FOR UPDATEé”å…³é”®è¡Œ
SELECT * FROM accounts WHERE account_id = $1 FOR UPDATE;
```

**âŒ DON'T**:

- ä¸è¦åœ¨é‡‘èç³»ç»Ÿä¸­ä½¿ç”¨ä½äºSerializableçš„éš”ç¦»çº§åˆ«
- ä¸è¦å¿½ç•¥åºåˆ—åŒ–å¤±è´¥çš„é‡è¯•
- ä¸è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤–éƒ¨APIè°ƒç”¨
- ä¸è¦ç¦ç”¨fsync

---

**æ¡ˆä¾‹ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**éªŒè¯çŠ¶æ€**: âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼ˆæŸé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿï¼‰
**æ­£ç¡®æ€§**: **100%ï¼ˆé›¶é”™è¯¯ï¼‰**

**ç›¸å…³æ¡ˆä¾‹**:

- `09-å·¥ä¸šæ¡ˆä¾‹åº“/01-ç”µå•†ç§’æ€ç³»ç»Ÿ.md` (é«˜å¹¶å‘åœºæ™¯å¯¹æ¯”)
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/07-åˆ†å¸ƒå¼ç¼“å­˜.md` (åˆ†å¸ƒå¼ä¸€è‡´æ€§)

**ç›¸å…³ç†è®º**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/03-ACIDç†è®ºä¸å®ç°.md`
- `03-è¯æ˜ä¸å½¢å¼åŒ–/03-ä¸²è¡ŒåŒ–è¯æ˜.md`
