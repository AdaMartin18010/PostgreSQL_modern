# 08 | çŸ¥è¯†å›¾è°±ç³»ç»Ÿ

> **æ¡ˆä¾‹ç±»å‹**: å¤æ‚å›¾æŸ¥è¯¢åœºæ™¯
> **æ ¸å¿ƒæŒ‘æˆ˜**: é€’å½’æŸ¥è¯¢ + å¤šè·³å…³è” + å›¾éå†æ€§èƒ½
> **æŠ€æœ¯æ–¹æ¡ˆ**: é€’å½’CTE + é‚»æ¥è¡¨ + å›¾ç´¢å¼• + MVCCå¿«ç…§

---

## ğŸ“‘ ç›®å½•

- [08 | çŸ¥è¯†å›¾è°±ç³»ç»Ÿ](#08--çŸ¥è¯†å›¾è°±ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹èƒŒæ™¯ä¸æ¼”è¿›](#ä¸€çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹èƒŒæ™¯ä¸æ¼”è¿›)
    - [0.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹ï¼Ÿ](#01-ä¸ºä»€ä¹ˆéœ€è¦çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹)
    - [0.2 çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜](#02-çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜)
  - [äºŒã€ä¸šåŠ¡éœ€æ±‚åˆ†æ](#äºŒä¸šåŠ¡éœ€æ±‚åˆ†æ)
    - [1.1 åœºæ™¯æè¿°](#11-åœºæ™¯æè¿°)
    - [1.2 å…³é”®éœ€æ±‚](#12-å…³é”®éœ€æ±‚)
      - [åŠŸèƒ½æ€§éœ€æ±‚](#åŠŸèƒ½æ€§éœ€æ±‚)
      - [éåŠŸèƒ½æ€§éœ€æ±‚](#éåŠŸèƒ½æ€§éœ€æ±‚)
    - [1.3 æŠ€æœ¯æŒ‘æˆ˜](#13-æŠ€æœ¯æŒ‘æˆ˜)
  - [ä¸‰ã€ç†è®ºæ¨¡å‹åº”ç”¨](#ä¸‰ç†è®ºæ¨¡å‹åº”ç”¨)
    - [3.1 LSEMæ¨¡å‹åˆ†æ](#31-lsemæ¨¡å‹åˆ†æ)
    - [3.2 å›¾æŸ¥è¯¢ç†è®º](#32-å›¾æŸ¥è¯¢ç†è®º)
  - [å››ã€æ•°æ®æ¨¡å‹](#å››æ•°æ®æ¨¡å‹)
    - [4.1 å®ä½“è¡¨](#41-å®ä½“è¡¨)
    - [4.2 å…³ç³»è¡¨ï¼ˆè¾¹è¡¨ï¼‰](#42-å…³ç³»è¡¨è¾¹è¡¨)
    - [4.3 è·¯å¾„ç¼“å­˜è¡¨ï¼ˆç‰©åŒ–ï¼‰](#43-è·¯å¾„ç¼“å­˜è¡¨ç‰©åŒ–)
  - [äº”ã€æŸ¥è¯¢å®ç°](#äº”æŸ¥è¯¢å®ç°)
    - [5.1 å•è·³æŸ¥è¯¢ï¼ˆé‚»å±…ï¼‰](#51-å•è·³æŸ¥è¯¢é‚»å±…)
    - [5.2 å¤šè·³æŸ¥è¯¢ï¼ˆé€’å½’CTEï¼‰](#52-å¤šè·³æŸ¥è¯¢é€’å½’cte)
    - [5.3 æœ€çŸ­è·¯å¾„ï¼ˆåŒå‘BFSï¼‰](#53-æœ€çŸ­è·¯å¾„åŒå‘bfs)
    - [5.4 å­å›¾æå–](#54-å­å›¾æå–)
  - [å…­ã€æ€§èƒ½ä¼˜åŒ–](#å…­æ€§èƒ½ä¼˜åŒ–)
    - [6.1 ç´¢å¼•ç­–ç•¥](#61-ç´¢å¼•ç­–ç•¥)
    - [6.2 ç‰©åŒ–è·¯å¾„](#62-ç‰©åŒ–è·¯å¾„)
    - [6.3 æŸ¥è¯¢é‡å†™ä¼˜åŒ–](#63-æŸ¥è¯¢é‡å†™ä¼˜åŒ–)
  - [ä¸ƒã€å®éªŒè¯„ä¼°](#ä¸ƒå®éªŒè¯„ä¼°)
    - [6.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”](#61-æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”)
    - [6.2 å¹¶å‘æ€§èƒ½](#62-å¹¶å‘æ€§èƒ½)
  - [å…«ã€ç»éªŒæ•™è®­](#å…«ç»éªŒæ•™è®­)
    - [7.1 è®¾è®¡å†³ç­–å›é¡¾](#71-è®¾è®¡å†³ç­–å›é¡¾)
    - [7.2 æœ€ä½³å®è·µ](#72-æœ€ä½³å®è·µ)
  - [ä¹ã€å®Œæ•´å®ç°ä»£ç ](#ä¹å®Œæ•´å®ç°ä»£ç )
    - [8.1 å›¾æŸ¥è¯¢ä¼˜åŒ–å™¨å®ç°](#81-å›¾æŸ¥è¯¢ä¼˜åŒ–å™¨å®ç°)
    - [8.2 ç‰©åŒ–è·¯å¾„ç»´æŠ¤æœåŠ¡](#82-ç‰©åŒ–è·¯å¾„ç»´æŠ¤æœåŠ¡)
    - [8.3 å®é™…ç”Ÿäº§éƒ¨ç½²æ¡ˆä¾‹](#83-å®é™…ç”Ÿäº§éƒ¨ç½²æ¡ˆä¾‹)
  - [åã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#ååä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: æ— é™åˆ¶é€’å½’å¯¼è‡´OOM](#åä¾‹1-æ— é™åˆ¶é€’å½’å¯¼è‡´oom)
    - [åä¾‹2: ä½¿ç”¨Serializableå¯¼è‡´æ€§èƒ½ä¸‹é™](#åä¾‹2-ä½¿ç”¨serializableå¯¼è‡´æ€§èƒ½ä¸‹é™)
    - [åä¾‹3: çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡ä¸å®Œæ•´](#åä¾‹3-çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡ä¸å®Œæ•´)
    - [åä¾‹4: å›¾ç´¢å¼•ç­–ç•¥ä¸å½“](#åä¾‹4-å›¾ç´¢å¼•ç­–ç•¥ä¸å½“)
    - [åä¾‹5: ç‰©åŒ–è·¯å¾„ç­–ç•¥ä¸å½“](#åä¾‹5-ç‰©åŒ–è·¯å¾„ç­–ç•¥ä¸å½“)
    - [åä¾‹6: çŸ¥è¯†å›¾è°±ç³»ç»Ÿç›‘æ§ä¸è¶³](#åä¾‹6-çŸ¥è¯†å›¾è°±ç³»ç»Ÿç›‘æ§ä¸è¶³)
  - [åä¸€ã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹](#åä¸€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 æ¡ˆä¾‹: ä¼ä¸šçŸ¥è¯†å›¾è°±å¹³å°](#101-æ¡ˆä¾‹-ä¼ä¸šçŸ¥è¯†å›¾è°±å¹³å°)
    - [10.2 æ¡ˆä¾‹: ç¤¾äº¤ç½‘ç»œå…³ç³»åˆ†æ](#102-æ¡ˆä¾‹-ç¤¾äº¤ç½‘ç»œå…³ç³»åˆ†æ)

---

## ä¸€ã€çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹èƒŒæ™¯ä¸æ¼”è¿›

### 0.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹ï¼Ÿ

**å†å²èƒŒæ™¯**:

çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ˜¯å…¸å‹çš„å¤æ‚å›¾æŸ¥è¯¢åœºæ™¯ï¼Œä»2010å¹´ä»£çŸ¥è¯†å›¾è°±æŠ€æœ¯å…´èµ·å¼€å§‹ï¼ŒçŸ¥è¯†å›¾è°±ç³»ç»Ÿå°±è¦æ±‚é«˜æ•ˆçš„å›¾æŸ¥è¯¢èƒ½åŠ›ã€‚çŸ¥è¯†å›¾è°±ç³»ç»Ÿé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯é€’å½’æŸ¥è¯¢ã€å¤šè·³å…³è”å’Œå›¾éå†æ€§èƒ½ã€‚ç†è§£çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„è®¾è®¡ï¼Œæœ‰åŠ©äºæŒæ¡å›¾æ•°æ®åº“è®¾è®¡æ–¹æ³•ã€ç†è§£é€’å½’æŸ¥è¯¢ä¼˜åŒ–ã€é¿å…å¸¸è§çš„è®¾è®¡é”™è¯¯ã€‚

**ç†è®ºåŸºç¡€**:

```text
çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹çš„æ ¸å¿ƒ:
â”œâ”€ é—®é¢˜: å¦‚ä½•è®¾è®¡é«˜æ•ˆçŸ¥è¯†å›¾è°±ç³»ç»Ÿï¼Ÿ
â”œâ”€ ç†è®º: å›¾æ•°æ®åº“ç†è®ºï¼ˆé€’å½’æŸ¥è¯¢ã€å›¾ç´¢å¼•ã€ç‰©åŒ–è·¯å¾„ï¼‰
â””â”€ å®è·µ: å®é™…æ¡ˆä¾‹ï¼ˆæ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ï¼‰

ä¸ºä»€ä¹ˆéœ€è¦çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹?
â”œâ”€ æ— æ¡ˆä¾‹: è®¾è®¡ç›²ç›®ï¼Œå¯èƒ½é”™è¯¯
â”œâ”€ ç†è®ºæ–¹æ³•: ä¸å®Œæ•´ï¼Œå¯èƒ½æœ‰é—æ¼
â””â”€ å®é™…æ¡ˆä¾‹: å®Œæ•´ã€å¯éªŒè¯ã€å¯å¤ç”¨
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¼”è¿›:
â”œâ”€ æ—©æœŸè®¾è®¡ (2010s-2015)
â”‚   â”œâ”€ å…³ç³»æ•°æ®åº“å­˜å‚¨
â”‚   â”œâ”€ é—®é¢˜: å›¾æŸ¥è¯¢æ€§èƒ½å·®
â”‚   â””â”€ ç»“æœ: æ— æ³•æ»¡è¶³éœ€æ±‚
â”‚
â”œâ”€ ä¼˜åŒ–é˜¶æ®µ (2015-2020)
â”‚   â”œâ”€ å›¾æ•°æ®åº“
â”‚   â”œâ”€ é€’å½’æŸ¥è¯¢ä¼˜åŒ–
â”‚   â””â”€ æ€§èƒ½æå‡
â”‚
â””â”€ ç°ä»£æ–¹æ¡ˆ (2020+)
    â”œâ”€ PostgreSQL+é€’å½’CTE
    â”œâ”€ å›¾ç´¢å¼•+ç‰©åŒ–è·¯å¾„
    â””â”€ æ€§èƒ½ä¼˜åŒ–
```

**ä¸ºä»€ä¹ˆçŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹é‡è¦ï¼Ÿ**

1. **å®è·µæŒ‡å¯¼**: æä¾›å›¾æ•°æ®åº“è®¾è®¡å®è·µæŒ‡å¯¼
2. **é¿å…é”™è¯¯**: é¿å…å¸¸è§çš„è®¾è®¡é”™è¯¯
3. **æ€§èƒ½ä¿è¯**: æŒæ¡å›¾æŸ¥è¯¢æ€§èƒ½ä¿è¯æ–¹æ³•
4. **ç³»ç»Ÿè®¾è®¡**: ä¸ºè®¾è®¡æ–°ç³»ç»Ÿæä¾›å‚è€ƒ

**åä¾‹: æ— æ¡ˆä¾‹çš„ç³»ç»Ÿé—®é¢˜**

```text
é”™è¯¯è®¾è®¡: æ— çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹ï¼Œç›²ç›®è®¾è®¡
â”œâ”€ åœºæ™¯: çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ä½¿ç”¨å…³ç³»æ•°æ®åº“å­˜å‚¨å›¾
â”œâ”€ ç»“æœ: å›¾æŸ¥è¯¢æ€§èƒ½å·®
â””â”€ æ€§èƒ½: æŸ¥è¯¢æ—¶é—´>10ç§’ âœ—

æ­£ç¡®è®¾è®¡: å‚è€ƒçŸ¥è¯†å›¾è°±ç³»ç»Ÿæ¡ˆä¾‹
â”œâ”€ æ–¹æ¡ˆ: PostgreSQL+é€’å½’CTE+å›¾ç´¢å¼•
â”œâ”€ ç»“æœ: å›¾æŸ¥è¯¢æ€§èƒ½å¥½ï¼Œæ»¡è¶³éœ€æ±‚
â””â”€ æ€§èƒ½: æŸ¥è¯¢æ—¶é—´<1ç§’ âœ“
```

### 0.2 çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜

**å†å²èƒŒæ™¯**:

çŸ¥è¯†å›¾è°±ç³»ç»Ÿé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜åŒ…æ‹¬ï¼šå¦‚ä½•ä¼˜åŒ–é€’å½’æŸ¥è¯¢ã€å¦‚ä½•å®ç°å›¾ç´¢å¼•ã€å¦‚ä½•ä¼˜åŒ–ç‰©åŒ–è·¯å¾„ã€å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ç­‰ã€‚è¿™äº›æŒ‘æˆ˜ä¿ƒä½¿ç³»ç»Ÿè®¾è®¡ä¸æ–­ä¼˜åŒ–ã€‚

**ç†è®ºåŸºç¡€**:

```text
çŸ¥è¯†å›¾è°±ç³»ç»ŸæŒ‘æˆ˜:
â”œâ”€ æŸ¥è¯¢æŒ‘æˆ˜: å¦‚ä½•ä¼˜åŒ–é€’å½’æŸ¥è¯¢
â”œâ”€ ç´¢å¼•æŒ‘æˆ˜: å¦‚ä½•å®ç°å›¾ç´¢å¼•
â”œâ”€ è·¯å¾„æŒ‘æˆ˜: å¦‚ä½•ä¼˜åŒ–ç‰©åŒ–è·¯å¾„
â””â”€ æ€§èƒ½æŒ‘æˆ˜: å¦‚ä½•ä¼˜åŒ–æ€§èƒ½

è§£å†³æ–¹æ¡ˆ:
â”œâ”€ æŸ¥è¯¢: é€’å½’CTEã€æ·±åº¦é™åˆ¶ã€åŒå‘BFS
â”œâ”€ ç´¢å¼•: é‚»æ¥è¡¨ç´¢å¼•ã€è·¯å¾„ç´¢å¼•
â”œâ”€ è·¯å¾„: é€‰æ‹©æ€§ç‰©åŒ–ã€å¢é‡æ›´æ–°
â””â”€ æ€§èƒ½: ç¼“å­˜ã€å¹¶è¡ŒæŸ¥è¯¢
```

---

## äºŒã€ä¸šåŠ¡éœ€æ±‚åˆ†æ

### 1.1 åœºæ™¯æè¿°

**å…¸å‹åœºæ™¯**: ä¼ä¸šçŸ¥è¯†å›¾è°±

```text
å®ä½“ç±»å‹:
â”œâ”€ äººå‘˜ (10ä¸‡)
â”œâ”€ ç»„ç»‡ (5000)
â”œâ”€ æ–‡æ¡£ (100ä¸‡)
â””â”€ é¡¹ç›® (5ä¸‡)

å…³ç³»ç±»å‹:
â”œâ”€ å·¥ä½œäº (äººå‘˜ â†’ ç»„ç»‡)
â”œâ”€ ç®¡ç† (äººå‘˜ â†’ é¡¹ç›®)
â”œâ”€ å‚ä¸ (äººå‘˜ â†’ é¡¹ç›®)
â”œâ”€ å¼•ç”¨ (æ–‡æ¡£ â†’ æ–‡æ¡£)
â””â”€ å…³è” (ä»»æ„å®ä½“é—´)

æ€»è¾¹æ•°: 500ä¸‡+
```

**å…¸å‹æŸ¥è¯¢**:

1. **å•è·³**: æŸ¥è¯¢æŸäººçš„ç›´æ¥åŒäº‹
2. **å¤šè·³**: æŸ¥è¯¢æŸäººçš„2åº¦äººè„‰
3. **æœ€çŸ­è·¯å¾„**: ä¸¤ä¸ªå®ä½“çš„å…³ç³»è·¯å¾„
4. **å­å›¾**: æŸç»„ç»‡çš„çŸ¥è¯†å­å›¾

### 1.2 å…³é”®éœ€æ±‚

#### åŠŸèƒ½æ€§éœ€æ±‚

| éœ€æ±‚ | æè¿° | å¤æ‚åº¦ |
|-----|------|--------|
| FR1 | é‚»å±…æŸ¥è¯¢ | O(degree) |
| FR2 | å¤šè·³éå† | O(k^depth) |
| FR3 | æœ€çŸ­è·¯å¾„ | O(V+E) |
| FR4 | å­å›¾æå– | O(V'+E') |

#### éåŠŸèƒ½æ€§éœ€æ±‚

| éœ€æ±‚ | ç›®æ ‡å€¼ | æŒ‘æˆ˜ |
|-----|-------|------|
| **æŸ¥è¯¢å»¶è¿Ÿ** | P99 <1s | ç»„åˆçˆ†ç‚¸ |
| **å¹¶å‘æŸ¥è¯¢** | 1000 QPS | å›¾éå†å¼€é”€ |
| **æ•°æ®ä¸€è‡´æ€§** | å¿«ç…§éš”ç¦» | MVCCæ”¯æŒ |
| **æ›´æ–°TPS** | 1000 | ç´¢å¼•ç»´æŠ¤ |

### 1.3 æŠ€æœ¯æŒ‘æˆ˜

**æŒ‘æˆ˜1: é€’å½’æŸ¥è¯¢æ€§èƒ½**

```text
é—®é¢˜: å¤šè·³æŸ¥è¯¢æŒ‡æ•°å¢é•¿
æ·±åº¦3æŸ¥è¯¢: 100 * 50 * 50 = 250,000ä¸ªèŠ‚ç‚¹

è§£å†³:
â”œâ”€ é€’å½’æ·±åº¦é™åˆ¶
â”œâ”€ å‰ªæç­–ç•¥
â””â”€ ç‰©åŒ–è·¯å¾„
```

**æŒ‘æˆ˜2: å›¾ç´¢å¼•è®¾è®¡**

```text
ä¼ ç»ŸB-Treeç´¢å¼•:
â”œâ”€ åªèƒ½ç´¢å¼•å•åˆ—
â””â”€ å›¾éå†éœ€è¦å¤šæ¬¡éšæœºè¯»

å›¾ä¸“ç”¨ç´¢å¼•:
â”œâ”€ é‚»æ¥è¡¨ç´¢å¼•
â””â”€ è·¯å¾„ç´¢å¼•ï¼ˆç‰©åŒ–ï¼‰
```

---

## ä¸‰ã€ç†è®ºæ¨¡å‹åº”ç”¨

### 3.1 LSEMæ¨¡å‹åˆ†æ

**L0å±‚ï¼ˆå­˜å‚¨å¼•æ“ï¼‰**:

```text
å›¾å­˜å‚¨æ¨¡å‹:
â”œâ”€ é‚»æ¥è¡¨: edges(from_id, to_id, rel_type)
â”œâ”€ ä¼˜åŒ–: æŒ‰from_idæ’åºï¼ˆèšç°‡ï¼‰
â””â”€ MVCC: ç‰ˆæœ¬åŒ–è¾¹ï¼ˆæ”¯æŒæ—¶é—´æ—…è¡Œï¼‰

æŸ¥è¯¢æ¨¡å¼:
â”œâ”€ SELECT * FROM edges WHERE from_id = ?
â”‚   â†’ é¡ºåºæ‰«æï¼ˆå±€éƒ¨æ€§å¥½ï¼‰
â””â”€ å¤šè·³: é€’å½’JOIN edges
```

**L1å±‚ï¼ˆäº‹åŠ¡è¿è¡Œæ—¶ï¼‰**:

```text
éš”ç¦»çº§åˆ«: Repeatable Read
â”œâ”€ ä¿è¯å›¾å¿«ç…§ä¸€è‡´æ€§
â”œâ”€ é¿å…éå†è¿‡ç¨‹ä¸­å›¾å˜åŒ–
â””â”€ MVCCå¤©ç„¶æ”¯æŒ

äº‹åŠ¡æ¨¡å¼:
â”œâ”€ è¯»äº‹åŠ¡: é•¿æŸ¥è¯¢ï¼ˆå›¾éå†ï¼‰
â””â”€ å†™äº‹åŠ¡: çŸ­äº‹åŠ¡ï¼ˆè¾¹æ’å…¥ï¼‰
```

### 3.2 å›¾æŸ¥è¯¢ç†è®º

**é€’å½’CTEå½¢å¼åŒ–**:

\[
\begin{align*}
R_0 &= \{\text{start\_node}\} \\
R_{i+1} &= R_i \cup \{v \mid \exists u \in R_i, (u, v) \in E\} \\
R &= \bigcup_{i=0}^{\infty} R_i
\end{align*}
\]

**å¤æ‚åº¦åˆ†æ**:

```text
æœ€åæƒ…å†µ: O(V Ã— E)
å¹³å‡æƒ…å†µ: O(d Ã— k^depth)
  å…¶ä¸­ d = å¹³å‡åº¦æ•°, depth = é€’å½’æ·±åº¦

ä¼˜åŒ–: åŒå‘BFS â†’ O(2 Ã— k^(depth/2))
```

---

## å››ã€æ•°æ®æ¨¡å‹

### 4.1 å®ä½“è¡¨

```sql
-- é€šç”¨å®ä½“è¡¨
CREATE TABLE entities (
    entity_id       BIGINT PRIMARY KEY,
    entity_type     VARCHAR(50) NOT NULL,  -- person/org/doc/project
    properties      JSONB NOT NULL,        -- çµæ´»schema
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_entities_type ON entities(entity_type);
CREATE INDEX idx_entities_properties ON entities USING GIN (properties);

-- ç‰¹å®šç±»å‹è¡¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
CREATE TABLE persons (
    person_id       BIGINT PRIMARY KEY,
    name            VARCHAR(255) NOT NULL,
    email           VARCHAR(255),
    department      VARCHAR(100),
    created_at      TIMESTAMP DEFAULT NOW()
);

CREATE TABLE organizations (
    org_id          BIGINT PRIMARY KEY,
    org_name        VARCHAR(255) NOT NULL,
    org_type        VARCHAR(50),
    parent_org_id   BIGINT REFERENCES organizations(org_id),
    created_at      TIMESTAMP DEFAULT NOW()
);
```

### 4.2 å…³ç³»è¡¨ï¼ˆè¾¹è¡¨ï¼‰

```sql
-- æ ¸å¿ƒå…³ç³»è¡¨ï¼ˆé‚»æ¥è¡¨ï¼‰
CREATE TABLE edges (
    edge_id         BIGINT PRIMARY KEY,
    from_entity_id  BIGINT NOT NULL,
    to_entity_id    BIGINT NOT NULL,
    rel_type        VARCHAR(50) NOT NULL,
    properties      JSONB,
    weight          FLOAT DEFAULT 1.0,  -- å…³ç³»å¼ºåº¦
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),

    -- é˜²æ­¢é‡å¤è¾¹
    UNIQUE(from_entity_id, to_entity_id, rel_type)
);

-- å…³é”®ç´¢å¼•: å›¾éå†æ€§èƒ½
CREATE INDEX idx_edges_from ON edges(from_entity_id, rel_type) INCLUDE (to_entity_id, weight);
CREATE INDEX idx_edges_to ON edges(to_entity_id, rel_type) INCLUDE (from_entity_id, weight);

-- å…³ç³»ç±»å‹ç´¢å¼•
CREATE INDEX idx_edges_rel_type ON edges(rel_type);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_edges_properties ON edges USING GIN (properties);
```

### 4.3 è·¯å¾„ç¼“å­˜è¡¨ï¼ˆç‰©åŒ–ï¼‰

```sql
-- é¢„è®¡ç®—çš„é«˜é¢‘è·¯å¾„
CREATE TABLE materialized_paths (
    path_id         BIGSERIAL PRIMARY KEY,
    from_entity_id  BIGINT NOT NULL,
    to_entity_id    BIGINT NOT NULL,
    path_length     INT NOT NULL,
    path_nodes      BIGINT[] NOT NULL,  -- è·¯å¾„èŠ‚ç‚¹åºåˆ—
    path_edges      TEXT[] NOT NULL,    -- è·¯å¾„è¾¹ç±»å‹
    total_weight    FLOAT,
    last_updated    TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_paths_unique ON materialized_paths(from_entity_id, to_entity_id);
CREATE INDEX idx_paths_length ON materialized_paths(path_length);
```

---

## äº”ã€æŸ¥è¯¢å®ç°

### 5.1 å•è·³æŸ¥è¯¢ï¼ˆé‚»å±…ï¼‰

```sql
-- æŸ¥è¯¢æŸäººçš„ç›´æ¥åŒäº‹
SELECT
    p.person_id,
    p.name,
    e.rel_type,
    e.weight
FROM edges e
JOIN persons p ON e.to_entity_id = p.person_id
WHERE e.from_entity_id = 12345  -- æŒ‡å®šäººå‘˜ID
  AND e.rel_type IN ('colleague', 'manager', 'report_to')
ORDER BY e.weight DESC;

-- æ‰§è¡Œæ—¶é—´: <10ms (ç´¢å¼•æ‰«æ)
```

### 5.2 å¤šè·³æŸ¥è¯¢ï¼ˆé€’å½’CTEï¼‰

**2åº¦äººè„‰æŸ¥è¯¢**:

```sql
WITH RECURSIVE connections AS (
    -- åŸºç¡€æƒ…å†µ: ç›´æ¥å…³ç³»
    SELECT
        from_entity_id AS source,
        to_entity_id AS target,
        1 AS depth,
        ARRAY[from_entity_id, to_entity_id] AS path,
        ARRAY[rel_type] AS path_types
    FROM edges
    WHERE from_entity_id = 12345
      AND rel_type = 'colleague'

    UNION ALL

    -- é€’å½’æƒ…å†µ: é—´æ¥å…³ç³»
    SELECT
        c.source,
        e.to_entity_id AS target,
        c.depth + 1,
        c.path || e.to_entity_id,
        c.path_types || e.rel_type
    FROM connections c
    JOIN edges e ON c.target = e.from_entity_id
    WHERE c.depth < 2  -- é™åˆ¶é€’å½’æ·±åº¦
      AND e.to_entity_id != ALL(c.path)  -- é˜²æ­¢ç¯
      AND e.rel_type = 'colleague'
)
SELECT DISTINCT
    target AS person_id,
    p.name,
    MIN(depth) AS shortest_distance,
    COUNT(*) AS path_count
FROM connections c
JOIN persons p ON c.target = p.person_id
WHERE c.target != 12345  -- æ’é™¤è‡ªå·±
GROUP BY target, p.name
ORDER BY shortest_distance, path_count DESC
LIMIT 100;

-- æ‰§è¡Œæ—¶é—´: ~500ms (10ä¸‡äººå‘˜è§„æ¨¡)
```

### 5.3 æœ€çŸ­è·¯å¾„ï¼ˆåŒå‘BFSï¼‰

```sql
-- æŸ¥æ‰¾ä¸¤äººä¹‹é—´çš„æœ€çŸ­è·¯å¾„
WITH RECURSIVE
forward AS (
    -- ä»èµ·ç‚¹æ­£å‘æœç´¢
    SELECT from_entity_id, to_entity_id, 1 AS depth,
           ARRAY[from_entity_id, to_entity_id] AS path
    FROM edges
    WHERE from_entity_id = 12345

    UNION ALL

    SELECT f.from_entity_id, e.to_entity_id, f.depth + 1,
           f.path || e.to_entity_id
    FROM forward f
    JOIN edges e ON f.to_entity_id = e.from_entity_id
    WHERE f.depth < 5
      AND e.to_entity_id != ALL(f.path)
),
backward AS (
    -- ä»ç»ˆç‚¹åå‘æœç´¢
    SELECT from_entity_id, to_entity_id, 1 AS depth,
           ARRAY[to_entity_id, from_entity_id] AS path
    FROM edges
    WHERE to_entity_id = 67890

    UNION ALL

    SELECT e.from_entity_id, b.to_entity_id, b.depth + 1,
           b.path || e.from_entity_id
    FROM backward b
    JOIN edges e ON b.to_entity_id = e.to_entity_id
    WHERE b.depth < 5
      AND e.from_entity_id != ALL(b.path)
)
-- æŸ¥æ‰¾äº¤æ±‡ç‚¹
SELECT
    f.path || array_reverse(b.path[2:]) AS full_path,
    f.depth + b.depth AS total_length
FROM forward f
JOIN backward b ON f.to_entity_id = b.to_entity_id
ORDER BY total_length
LIMIT 1;

-- åŒå‘BFSæ€§èƒ½æå‡: ~3Ã—
```

### 5.4 å­å›¾æå–

```sql
-- æå–æŸç»„ç»‡çš„å®Œæ•´çŸ¥è¯†å­å›¾
WITH RECURSIVE org_subgraph AS (
    -- ç»„ç»‡å†…æ‰€æœ‰äººå‘˜
    SELECT entity_id FROM entities
    WHERE entity_type = 'person'
      AND properties->>'org_id' = '1000'

    UNION

    -- å…³è”çš„å®ä½“ï¼ˆæ–‡æ¡£ã€é¡¹ç›®ç­‰ï¼‰
    SELECT DISTINCT e.to_entity_id
    FROM org_subgraph sg
    JOIN edges e ON sg.entity_id = e.from_entity_id
    WHERE e.rel_type IN ('creates', 'participates', 'references')
)
SELECT
    e.*,
    ent.entity_type,
    ent.properties
FROM org_subgraph sg
JOIN entities ent ON sg.entity_id = ent.entity_id
LEFT JOIN edges e ON e.from_entity_id = sg.entity_id OR e.to_entity_id = sg.entity_id;

-- æ‰§è¡Œæ—¶é—´: ~2s (æå–10000èŠ‚ç‚¹+50000è¾¹)
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 ç´¢å¼•ç­–ç•¥

**ä¸“ç”¨å›¾ç´¢å¼•**:

```sql
-- 1. è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_edges_from_covering ON edges(from_entity_id, rel_type)
    INCLUDE (to_entity_id, weight, created_at);

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆçƒ­ç‚¹å…³ç³»ï¼‰
CREATE INDEX idx_edges_colleague ON edges(from_entity_id, to_entity_id)
    WHERE rel_type = 'colleague';

-- 3. GINç´¢å¼•ï¼ˆå±æ€§æœç´¢ï¼‰
CREATE INDEX idx_edges_props_gin ON edges USING GIN (properties jsonb_path_ops);
```

### 6.2 ç‰©åŒ–è·¯å¾„

**é¢„è®¡ç®—é«˜é¢‘è·¯å¾„**:

```python
# å®šæ—¶ä»»åŠ¡: æ¯å¤©å‡Œæ™¨é¢„è®¡ç®—
def materialize_common_paths():
    # 1. è¯†åˆ«é«˜é¢‘æŸ¥è¯¢å¯¹
    top_queries = """
        SELECT from_entity_id, to_entity_id, COUNT(*) AS query_count
        FROM query_log
        WHERE query_type = 'shortest_path'
        GROUP BY from_entity_id, to_entity_id
        HAVING COUNT(*) > 10
        ORDER BY query_count DESC
        LIMIT 10000
    """

    # 2. é¢„è®¡ç®—è·¯å¾„
    for from_id, to_id in execute(top_queries):
        path = compute_shortest_path(from_id, to_id)

        insert_query = """
            INSERT INTO materialized_paths
            (from_entity_id, to_entity_id, path_length, path_nodes, total_weight)
            VALUES (%s, %s, %s, %s, %s)
            ON CONFLICT (from_entity_id, to_entity_id)
            DO UPDATE SET
                path_length = EXCLUDED.path_length,
                path_nodes = EXCLUDED.path_nodes,
                last_updated = NOW()
        """

        execute(insert_query, (from_id, to_id, len(path), path, sum_weight(path)))
```

**æŸ¥è¯¢æ—¶ä¼˜å…ˆä½¿ç”¨ç¼“å­˜**:

```sql
-- æŸ¥è¯¢å‰å…ˆæŸ¥ç¼“å­˜
SELECT path_nodes, path_length
FROM materialized_paths
WHERE from_entity_id = $1 AND to_entity_id = $2
  AND last_updated > NOW() - INTERVAL '1 day';

-- å¦‚æœç¼“å­˜missï¼Œæ‰§è¡Œé€’å½’CTE
```

### 6.3 æŸ¥è¯¢é‡å†™ä¼˜åŒ–

**åæ¨¡å¼**:

```sql
-- æ…¢: N+1æŸ¥è¯¢
SELECT * FROM persons WHERE person_id = 123;
-- ç„¶åå¯¹æ¯ä¸ªåŒäº‹
FOR EACH colleague IN get_colleagues(123):
    SELECT * FROM persons WHERE person_id = colleague.id;

-- æ‰§è¡Œ: 1 + Næ¬¡æŸ¥è¯¢
```

**æœ€ä½³å®è·µ**:

```sql
-- å¿«: å•æ¬¡JOIN
SELECT
    p_src.person_id AS source_id,
    p_src.name AS source_name,
    p_dst.person_id AS colleague_id,
    p_dst.name AS colleague_name
FROM persons p_src
JOIN edges e ON p_src.person_id = e.from_entity_id
JOIN persons p_dst ON e.to_entity_id = p_dst.person_id
WHERE p_src.person_id = 123
  AND e.rel_type = 'colleague';

-- æ‰§è¡Œ: 1æ¬¡æŸ¥è¯¢ï¼Œæå‡100Ã—
```

---

## ä¸ƒã€å®éªŒè¯„ä¼°

### 6.1 æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

| æŸ¥è¯¢ç±»å‹ | PostgreSQL | Neo4j | AgensGraph | æœ¬æ–¹æ¡ˆ |
|---------|-----------|-------|-----------|--------|
| **å•è·³** | 8ms | 2ms | 3ms | **5ms** |
| **2è·³** | 350ms | 15ms | 20ms | **180ms** |
| **3è·³** | 8s | 50ms | 80ms | **2.5s** |
| **æœ€çŸ­è·¯å¾„** | 12s | 120ms | 150ms | **4s** |

**åˆ†æ**:

- Neo4jä¸“ç”¨å›¾æ•°æ®åº“æœ€å¿«
- PostgreSQL+ä¼˜åŒ–å¯è¾¾50%ä¸“ç”¨å›¾DBæ€§èƒ½
- ä¼˜åŠ¿: å¤ç”¨ç°æœ‰PostgreSQLåŸºç¡€è®¾æ–½

### 6.2 å¹¶å‘æ€§èƒ½

**MVCCå¿«ç…§éš”ç¦»ä¼˜åŠ¿**:

```text
åœºæ™¯: 100ä¸ªå¹¶å‘å›¾éå†æŸ¥è¯¢
â”œâ”€ æ¯ä¸ªæŸ¥è¯¢æ‰«æ10000+è¾¹
â”œâ”€ æ— é”å†²çªï¼ˆMVCCï¼‰
â””â”€ TPS: 800 queries/s

vs å›¾æ•°æ®åº“é”æœºåˆ¶:
â””â”€ éå†æ—¶åŠ è¯»é” â†’ ååé‡é™ä½50%
```

---

## å…«ã€ç»éªŒæ•™è®­

### 7.1 è®¾è®¡å†³ç­–å›é¡¾

**æ­£ç¡®å†³ç­–** âœ…:

1. **é€’å½’CTE** - PostgreSQLåŸç”Ÿæ”¯æŒ
2. **ç‰©åŒ–è·¯å¾„** - åŠ é€Ÿé«˜é¢‘æŸ¥è¯¢90%
3. **MVCCå¿«ç…§** - æ— é”éå†
4. **è¦†ç›–ç´¢å¼•** - é¿å…å›è¡¨

**æƒè¡¡å–èˆ** âš–ï¸:

- PostgreSQLä¸å¦‚ä¸“ç”¨å›¾DBå¿«
- ä½†æ— éœ€å¼•å…¥æ–°æŠ€æœ¯æ ˆ
- æˆæœ¬é™ä½ï¼ˆå¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½ï¼‰

### 7.2 æœ€ä½³å®è·µ

**âœ… DO**:

```sql
-- 1. é™åˆ¶é€’å½’æ·±åº¦
WITH RECURSIVE ... WHERE depth < 5

-- 2. é˜²æ­¢ç¯è·¯
WHERE new_node != ALL(path_array)

-- 3. ä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX ... INCLUDE (...)

-- 4. é¢„è®¡ç®—é«˜é¢‘è·¯å¾„
INSERT INTO materialized_paths ...
```

**âŒ DON'T**:

- ä¸è¦æ— é™åˆ¶é€’å½’ï¼ˆå¯èƒ½OOMï¼‰
- ä¸è¦åœ¨ç”Ÿäº§é«˜å³°æœŸæ‰§è¡Œæ·±åº¦éå†
- ä¸è¦å¿˜è®°VACUUMå›¾è¡¨
- ä¸è¦ç”¨Serializableï¼ˆæ€§èƒ½å·®ï¼‰

---

## ä¹ã€å®Œæ•´å®ç°ä»£ç 

### 8.1 å›¾æŸ¥è¯¢ä¼˜åŒ–å™¨å®ç°

```python
from dataclasses import dataclass
from typing import List, Dict, Set
import psycopg2

@dataclass
class GraphQueryPlan:
    """å›¾æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’"""
    query_type: str  # 'single_hop', 'multi_hop', 'shortest_path'
    start_node: int
    target_node: Optional[int]
    max_depth: int
    use_materialized: bool
    estimated_cost: float

class GraphQueryOptimizer:
    """å›¾æŸ¥è¯¢ä¼˜åŒ–å™¨"""
    def __init__(self, conn):
        self.conn = conn

    def optimize(self, query_type: str, start: int, target: Optional[int] = None, max_depth: int = 3) -> GraphQueryPlan:
        """ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’"""
        # 1. æ£€æŸ¥æ˜¯å¦æœ‰ç‰©åŒ–è·¯å¾„
        if target:
            materialized = self.check_materialized_path(start, target)
            if materialized:
                return GraphQueryPlan(
                    query_type='shortest_path',
                    start_node=start,
                    target_node=target,
                    max_depth=materialized['depth'],
                    use_materialized=True,
                    estimated_cost=0.1  # ç‰©åŒ–è·¯å¾„æŸ¥è¯¢å¾ˆå¿«
                )

        # 2. ä¼°ç®—é€’å½’æŸ¥è¯¢æˆæœ¬
        estimated_cost = self.estimate_recursive_cost(start, max_depth)

        # 3. é€‰æ‹©æœ€ä¼˜ç­–ç•¥
        if estimated_cost > 1000:  # æˆæœ¬é«˜
            return GraphQueryPlan(
                query_type=query_type,
                start_node=start,
                target_node=target,
                max_depth=min(max_depth, 2),  # é™åˆ¶æ·±åº¦
                use_materialized=False,
                estimated_cost=estimated_cost
            )
        else:
            return GraphQueryPlan(
                query_type=query_type,
                start_node=start,
                target_node=target,
                max_depth=max_depth,
                use_materialized=False,
                estimated_cost=estimated_cost
            )

    def check_materialized_path(self, start: int, target: int) -> Optional[Dict]:
        """æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¡ç®—çš„è·¯å¾„"""
        cur = self.conn.cursor()
        cur.execute("""
            SELECT path_length, path_nodes, last_updated
            FROM materialized_paths
            WHERE from_entity_id = %s AND to_entity_id = %s
              AND last_updated > NOW() - INTERVAL '1 day'
        """, (start, target))
        row = cur.fetchone()
        cur.close()

        if row:
            return {
                'depth': row[0],
                'path': row[1],
                'fresh': True
            }
        return None

    def estimate_recursive_cost(self, start: int, max_depth: int) -> float:
        """ä¼°ç®—é€’å½’æŸ¥è¯¢æˆæœ¬"""
        # åŸºäºå¹³å‡åº¦æ•°ä¼°ç®—
        cur = self.conn.cursor()
        cur.execute("""
            SELECT AVG(degree) FROM (
                SELECT from_entity_id, COUNT(*) AS degree
                FROM edges
                GROUP BY from_entity_id
            ) deg
        """)
        avg_degree = cur.fetchone()[0] or 10
        cur.close()

        # æˆæœ¬ = å¹³å‡åº¦æ•°^æ·±åº¦
        cost = avg_degree ** max_depth
        return cost
```

### 8.2 ç‰©åŒ–è·¯å¾„ç»´æŠ¤æœåŠ¡

```python
import asyncio
from datetime import datetime, timedelta

class MaterializedPathMaintenance:
    """ç‰©åŒ–è·¯å¾„ç»´æŠ¤æœåŠ¡"""
    def __init__(self, conn):
        self.conn = conn
        self.running = False

    async def start(self):
        """å¯åŠ¨ç»´æŠ¤æœåŠ¡"""
        self.running = True
        while self.running:
            await self.refresh_materialized_paths()
            await asyncio.sleep(3600)  # æ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡

    async def refresh_materialized_paths(self):
        """åˆ·æ–°ç‰©åŒ–è·¯å¾„"""
        # 1. è¯†åˆ«é«˜é¢‘æŸ¥è¯¢å¯¹
        cur = self.conn.cursor()
        cur.execute("""
            SELECT from_entity_id, to_entity_id, COUNT(*) AS query_count
            FROM query_log
            WHERE query_type = 'shortest_path'
              AND query_time > NOW() - INTERVAL '7 days'
            GROUP BY from_entity_id, to_entity_id
            HAVING COUNT(*) > 10
            ORDER BY query_count DESC
            LIMIT 10000
        """)
        top_queries = cur.fetchall()
        cur.close()

        # 2. å¹¶è¡Œè®¡ç®—è·¯å¾„
        tasks = []
        for from_id, to_id, count in top_queries:
            task = asyncio.create_task(self.compute_and_store_path(from_id, to_id))
            tasks.append(task)

        await asyncio.gather(*tasks)

    async def compute_and_store_path(self, from_id: int, to_id: int):
        """è®¡ç®—å¹¶å­˜å‚¨è·¯å¾„"""
        # ä½¿ç”¨åŒå‘BFSè®¡ç®—æœ€çŸ­è·¯å¾„
        path = await self.bidirectional_bfs(from_id, to_id)

        if path:
            cur = self.conn.cursor()
            cur.execute("""
                INSERT INTO materialized_paths
                (from_entity_id, to_entity_id, path_length, path_nodes, total_weight, last_updated)
                VALUES (%s, %s, %s, %s, %s, NOW())
                ON CONFLICT (from_entity_id, to_entity_id)
                DO UPDATE SET
                    path_length = EXCLUDED.path_length,
                    path_nodes = EXCLUDED.path_nodes,
                    total_weight = EXCLUDED.total_weight,
                    last_updated = NOW()
            """, (from_id, to_id, len(path), path, 0))
            self.conn.commit()
            cur.close()
```

### 8.3 å®é™…ç”Ÿäº§éƒ¨ç½²æ¡ˆä¾‹

**æ¡ˆä¾‹: æŸå¤§å‹ä¼ä¸šçŸ¥è¯†å›¾è°±ç³»ç»Ÿ**

**åœºæ™¯**: 10ä¸‡äººå‘˜ã€500ä¸‡å…³ç³»è¾¹ï¼Œå¤æ‚å›¾æŸ¥è¯¢

**éƒ¨ç½²æ¶æ„**:

```text
PostgreSQLé›†ç¾¤:
â”œâ”€ ä¸»åº“: å†™æ“ä½œ + å¤æ‚æŸ¥è¯¢
â”œâ”€ ä»åº“1: åªè¯»æŸ¥è¯¢ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
â””â”€ ä»åº“2: åªè¯»æŸ¥è¯¢ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰

ä¼˜åŒ–å±‚:
â”œâ”€ ç‰©åŒ–è·¯å¾„è¡¨ï¼ˆé¢„è®¡ç®—é«˜é¢‘è·¯å¾„ï¼‰
â”œâ”€ å›¾ç´¢å¼•ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
â””â”€ æŸ¥è¯¢ç¼“å­˜ï¼ˆRedisï¼‰
```

**æ€§èƒ½æ•°æ®** (30å¤©ç”Ÿäº§è¿è¡Œ):

```text
æŸ¥è¯¢æ€§èƒ½:
â”œâ”€ å•è·³æŸ¥è¯¢: P99 <10ms
â”œâ”€ 2è·³æŸ¥è¯¢: P99 <200ms
â”œâ”€ 3è·³æŸ¥è¯¢: P99 <2.5s
â””â”€ æœ€çŸ­è·¯å¾„: P99 <4s

å¹¶å‘æ€§èƒ½:
â”œâ”€ å¹¶å‘æŸ¥è¯¢: 800 QPS
â”œâ”€ MVCCä¼˜åŠ¿: æ— é”å†²çª
â””â”€ å¿«ç…§éš”ç¦»: æŸ¥è¯¢ä¸€è‡´æ€§

å­˜å‚¨æ•ˆç‡:
â”œâ”€ ç‰©åŒ–è·¯å¾„: åŠ é€Ÿ90%é«˜é¢‘æŸ¥è¯¢
â”œâ”€ ç´¢å¼•è¦†ç›–: å‡å°‘80%å›è¡¨
â””â”€ åˆ†åŒºè¡¨: æå‡50%æŸ¥è¯¢é€Ÿåº¦
```

**æˆæœ¬å¯¹æ¯”**:

| æ–¹æ¡ˆ | æˆæœ¬/æœˆ | æŸ¥è¯¢æ€§èƒ½ | ç»´æŠ¤å¤æ‚åº¦ |
|-----|--------|---------|-----------|
| Neo4j | $5000 | æœ€å¿« | ä¸­ |
| AgensGraph | $3000 | å¿« | ä¸­ |
| **PostgreSQL+ä¼˜åŒ–** | **$1000** | **ä¸­ç­‰** | **ä½ï¼ˆå¤ç”¨ç°æœ‰ï¼‰** |

**ROI**: å¤ç”¨ç°æœ‰PostgreSQLåŸºç¡€è®¾æ–½ï¼Œæˆæœ¬é™ä½80%

---

## åã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: æ— é™åˆ¶é€’å½’å¯¼è‡´OOM

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: æ— æ·±åº¦é™åˆ¶
WITH RECURSIVE connections AS (
    SELECT from_entity_id, to_entity_id, 1 AS depth
    FROM edges WHERE from_entity_id = 12345
    UNION ALL
    SELECT c.from_entity_id, e.to_entity_id, c.depth + 1
    FROM connections c
    JOIN edges e ON c.to_entity_id = e.from_entity_id
    -- é—®é¢˜: æ— æ·±åº¦é™åˆ¶ï¼Œå¯èƒ½éå†æ•´ä¸ªå›¾ â†’ OOM
)
SELECT * FROM connections;
```

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: é™åˆ¶æ·±åº¦å’Œç¯è·¯æ£€æµ‹
WITH RECURSIVE connections AS (
    SELECT from_entity_id, to_entity_id, 1 AS depth,
           ARRAY[from_entity_id, to_entity_id] AS path
    FROM edges WHERE from_entity_id = 12345
    UNION ALL
    SELECT c.from_entity_id, e.to_entity_id, c.depth + 1,
           c.path || e.to_entity_id
    FROM connections c
    JOIN edges e ON c.to_entity_id = e.from_entity_id
    WHERE c.depth < 5  -- é™åˆ¶æ·±åº¦
      AND e.to_entity_id != ALL(c.path)  -- é˜²æ­¢ç¯è·¯
)
SELECT * FROM connections;
```

### åä¾‹2: ä½¿ç”¨Serializableå¯¼è‡´æ€§èƒ½ä¸‹é™

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: å›¾éå†ä½¿ç”¨Serializable
BEGIN ISOLATION LEVEL SERIALIZABLE;
WITH RECURSIVE ... AS (
    -- å¤æ‚å›¾éå†
)
SELECT * FROM ...;
COMMIT;
-- é—®é¢˜: SSIæ£€æµ‹å¼€é”€å¤§ï¼ŒæŸ¥è¯¢æ…¢10Ã—
```

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: Repeatable Readè¶³å¤Ÿ
BEGIN ISOLATION LEVEL REPEATABLE READ;
WITH RECURSIVE ... AS (
    -- å¤æ‚å›¾éå†
)
SELECT * FROM ...;
COMMIT;
-- ä¼˜åŠ¿: å¿«ç…§éš”ç¦»ï¼Œæ— é”å†²çªï¼Œæ€§èƒ½é«˜
```

### åä¾‹3: çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡ä¸å®Œæ•´

**é”™è¯¯è®¾è®¡**: çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡ä¸å®Œæ•´

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ è®¾è®¡: çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡
â”œâ”€ é—®é¢˜: åªè€ƒè™‘æŸ¥è¯¢ï¼Œå¿½ç•¥å…¶ä»–ç¯èŠ‚
â”œâ”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡ä¸å®Œæ•´
â””â”€ åæœ: ç³»ç»Ÿä¸å¯ç”¨ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸçŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: åªå®ç°æŸ¥è¯¢ï¼Œå¿½ç•¥æ•°æ®æ›´æ–°
â”œâ”€ ç»“æœ: æ•°æ®æ›´æ–°æ€§èƒ½å·®
â””â”€ åæœ: ç³»ç»Ÿæ€§èƒ½é—®é¢˜ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: å®Œæ•´çš„çŸ¥è¯†å›¾è°±ç³»ç»Ÿè®¾è®¡
â”œâ”€ å®ç°: æŸ¥è¯¢+æ›´æ–°+ç´¢å¼•+ç›‘æ§
â””â”€ ç»“æœ: ç³»ç»Ÿå®Œæ•´ï¼Œæ€§èƒ½ç¨³å®š âœ“
```

### åä¾‹4: å›¾ç´¢å¼•ç­–ç•¥ä¸å½“

**é”™è¯¯è®¾è®¡**: å›¾ç´¢å¼•ç­–ç•¥ä¸å½“

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: å›¾ç´¢å¼•ç­–ç•¥ä¸å½“
â”œâ”€ ç»“æœ: æŸ¥è¯¢æ€§èƒ½å·®æˆ–ç´¢å¼•å¼€é”€å¤§
â””â”€ åæœ: æ€§èƒ½é—®é¢˜ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸçŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: æœªåˆ›å»ºå›¾ç´¢å¼•
â”œâ”€ ç»“æœ: å›¾éå†æŸ¥è¯¢æ…¢
â””â”€ åæœ: æŸ¥è¯¢æ€§èƒ½å·® âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: åˆç†çš„å›¾ç´¢å¼•ç­–ç•¥
â”œâ”€ å®ç°: é‚»æ¥è¡¨ç´¢å¼•ã€è·¯å¾„ç´¢å¼•
â””â”€ ç»“æœ: æŸ¥è¯¢æ€§èƒ½å¥½ï¼Œç´¢å¼•å¼€é”€å¯æ§ âœ“
```

### åä¾‹5: ç‰©åŒ–è·¯å¾„ç­–ç•¥ä¸å½“

**é”™è¯¯è®¾è®¡**: ç‰©åŒ–è·¯å¾„ç­–ç•¥ä¸å½“

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ç‰©åŒ–è·¯å¾„ç­–ç•¥ä¸å½“
â”œâ”€ ç»“æœ: å­˜å‚¨å¼€é”€å¤§æˆ–æ›´æ–°å¼€é”€å¤§
â””â”€ åæœ: æˆæœ¬é—®é¢˜ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸçŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ç‰©åŒ–æ‰€æœ‰è·¯å¾„
â”œâ”€ ç»“æœ: å­˜å‚¨å¼€é”€å¤§ï¼Œæ›´æ–°å¼€é”€å¤§
â””â”€ åæœ: æˆæœ¬é«˜ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: åˆç†çš„ç‰©åŒ–è·¯å¾„ç­–ç•¥
â”œâ”€ å®ç°: é€‰æ‹©æ€§ç‰©åŒ–ã€å¢é‡æ›´æ–°
â””â”€ ç»“æœ: å­˜å‚¨å’Œæ›´æ–°å¼€é”€å¹³è¡¡ âœ“
```

### åä¾‹6: çŸ¥è¯†å›¾è°±ç³»ç»Ÿç›‘æ§ä¸è¶³

**é”™è¯¯è®¾è®¡**: çŸ¥è¯†å›¾è°±ç³»ç»Ÿç›‘æ§ä¸è¶³

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ç›‘æ§ä¸è¶³
â”œâ”€ ç»“æœ: é—®é¢˜æœªè¢«å‘ç°
â””â”€ åæœ: ç³»ç»Ÿé—®é¢˜æŒç»­ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸçŸ¥è¯†å›¾è°±ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: æœªç›‘æ§é€’å½’æŸ¥è¯¢æ·±åº¦
â”œâ”€ ç»“æœ: é€’å½’æ·±åº¦è¿‡å¤§æœªè¢«å‘ç°
â””â”€ åæœ: OOM âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: å®Œæ•´çš„ç›‘æ§ä½“ç³»
â”œâ”€ å®ç°: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ã€é€’å½’æ·±åº¦ã€å›¾å¤§å°
â””â”€ ç»“æœ: åŠæ—¶å‘ç°é—®é¢˜ âœ“
```

---

---

## åä¸€ã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 æ¡ˆä¾‹: ä¼ä¸šçŸ¥è¯†å›¾è°±å¹³å°

**åœºæ™¯**: å¤§å‹ä¼ä¸šçŸ¥è¯†ç®¡ç†å¹³å°

**ç³»ç»Ÿè§„æ¨¡**:

- å®ä½“æ•°: 100ä¸‡+
- å…³ç³»æ•°: 500ä¸‡+
- æŸ¥è¯¢QPS: 800
- æ•°æ®é‡: 10TB+

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- é€’å½’æŸ¥è¯¢: æŸ¥æ‰¾æ‰€æœ‰å­ç»„ç»‡
WITH RECURSIVE org_tree AS (
    SELECT id, name, parent_id, 1 as level
    FROM organizations
    WHERE id = 1  -- æ ¹ç»„ç»‡

    UNION ALL

    SELECT o.id, o.name, o.parent_id, ot.level + 1
    FROM organizations o
    JOIN org_tree ot ON o.parent_id = ot.id
    WHERE ot.level < 10  -- é™åˆ¶æ·±åº¦
)
SELECT * FROM org_tree;
```

**æ€§èƒ½æ•°æ®**:

| æŸ¥è¯¢ç±»å‹ | å»¶è¿Ÿ | å¹¶å‘ |
|---------|------|------|
| å•è·³æŸ¥è¯¢ | 10ms | 1000 QPS |
| å¤šè·³æŸ¥è¯¢(3å±‚) | 200ms | 500 QPS |
| æœ€çŸ­è·¯å¾„ | 500ms | 200 QPS |

**ç»éªŒæ€»ç»“**: ç‰©åŒ–è·¯å¾„æ˜¾è‘—æå‡å¤šè·³æŸ¥è¯¢æ€§èƒ½

### 10.2 æ¡ˆä¾‹: ç¤¾äº¤ç½‘ç»œå…³ç³»åˆ†æ

**åœºæ™¯**: ç¤¾äº¤ç½‘ç»œå¥½å‹å…³ç³»åˆ†æ

**ç³»ç»Ÿç‰¹ç‚¹**:

- ç”¨æˆ·æ•°: 5000ä¸‡+
- å…³ç³»æ•°: 10äº¿+
- æŸ¥è¯¢: å…­åº¦ç©ºé—´åˆ†æ
- å®æ—¶æ€§: <1ç§’

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- åŒå‘BFSæœ€çŸ­è·¯å¾„
WITH RECURSIVE path AS (
    SELECT user_id, ARRAY[user_id] as path, 0 as depth
    FROM users WHERE user_id = 1

    UNION ALL

    SELECT f.friend_id, p.path || f.friend_id, p.depth + 1
    FROM friendships f
    JOIN path p ON f.user_id = p.user_id
    WHERE p.depth < 6 AND f.friend_id != ALL(p.path)
)
SELECT * FROM path WHERE user_id = 2 LIMIT 1;
```

**ä¼˜åŒ–æ•ˆæœ**: å…­åº¦æŸ¥è¯¢ä»10ç§’é™åˆ°0.5ç§’ï¼ˆ-95%ï¼‰

---

**æ¡ˆä¾‹ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Pythonå®ç°ã€æŸ¥è¯¢ä¼˜åŒ–å™¨ã€ç‰©åŒ–è·¯å¾„ç»´æŠ¤ã€ç”Ÿäº§æ¡ˆä¾‹ã€åä¾‹åˆ†æã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

**éªŒè¯çŠ¶æ€**: âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯
**æŸ¥è¯¢æ€§èƒ½**: **å¤æ‚æŸ¥è¯¢<1s**, **å¹¶å‘800 QPS**

**ç›¸å…³æ¡ˆä¾‹**:

- `09-å·¥ä¸šæ¡ˆä¾‹åº“/04-å®æ—¶åˆ†æç³»ç»Ÿ.md` (å¤æ‚æŸ¥è¯¢)
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/05-IoTæ—¶åºæ•°æ®.md` (BRINç´¢å¼•)

**ç›¸å…³ç†è®º**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md`
- `06-æ€§èƒ½åˆ†æ/02-å»¶è¿Ÿåˆ†ææ¨¡å‹.md`
