# 01 | åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹ (LSEM)

> **ç†è®ºå®šä½**: Layered State Evolution Model (LSEM) æ˜¯æœ¬ä½“ç³»çš„æ ¸å¿ƒå…ƒæ¨¡å‹ï¼Œå°†å¹¶å‘æ§åˆ¶é—®é¢˜æŠ½è±¡ä¸ºè·¨å±‚æ¬¡çš„çŠ¶æ€æ¼”åŒ–ä¸å¯è§æ€§æ§åˆ¶é—®é¢˜ã€‚

---

## ä¸€ã€ç†è®ºåŠ¨æœºä¸é—®é¢˜å®šä¹‰

### 1.1 æ ¸å¿ƒé—®é¢˜

æ‰€æœ‰å¹¶å‘ç³»ç»Ÿé¢ä¸´çš„æœ¬è´¨é—®é¢˜ï¼š

$$\text{Who can see What State at When Time?}$$

**å…·ä½“åŒ–**:

- **Who**: äº‹åŠ¡ã€çº¿ç¨‹ã€èŠ‚ç‚¹
- **What**: æ•°æ®ç‰ˆæœ¬ã€å†…å­˜å€¼ã€å…¨å±€çŠ¶æ€
- **When**: æ—¶é—´æˆ³ã€äº‹åŠ¡IDã€é€»è¾‘æ—¶é’Ÿ

**ä¼ ç»Ÿæ–¹æ³•çš„å±€é™**:

- æ•°æ®åº“ç†è®ºï¼šå…³æ³¨å­˜å‚¨å±‚çš„äº‹åŠ¡éš”ç¦»
- ç¼–ç¨‹è¯­è¨€ç†è®ºï¼šå…³æ³¨å†…å­˜å±‚çš„çº¿ç¨‹å®‰å…¨
- åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºï¼šå…³æ³¨ç½‘ç»œå±‚çš„ä¸€è‡´æ€§

**ç¼ºä¹ç»Ÿä¸€æ¡†æ¶**ï¼Œå¯¼è‡´ï¼š

- æ¦‚å¿µé‡å¤å®šä¹‰ï¼ˆå¦‚"å¯è§æ€§"åœ¨ä¸åŒé¢†åŸŸæœ‰ä¸åŒå«ä¹‰ï¼‰
- è®¾è®¡æ¨¡å¼æ— æ³•è·¨å±‚å¤ç”¨
- ç†è®ºå­¤å²›éš¾ä»¥èåˆ

### 1.2 LSEMçš„åˆ›æ–°

**æ ¸å¿ƒæ´å¯Ÿ**:
> æ•°æ®åº“MVCCã€Rustæ‰€æœ‰æƒã€åˆ†å¸ƒå¼å…±è¯†**æœ¬è´¨åŒæ„**â€”â€”éƒ½æ˜¯åœ¨ä¸åŒæ—¶ç©ºç»´åº¦ä¸Šç®¡ç†çŠ¶æ€æ¼”åŒ–çš„å¯è§æ€§ã€‚

**ç»Ÿä¸€æ¡†æ¶**:

```
LSEM = çŠ¶æ€ç©ºé—´ + æ—¶ç©ºæˆ³ç³»ç»Ÿ + å¯è§æ€§è§„åˆ™ + å†²çªä»²è£æœºåˆ¶
```

---

## äºŒã€å½¢å¼åŒ–å®šä¹‰

### 2.1 çŠ¶æ€ç©ºé—´ (State Space)

$$\mathcal{S} = \{s_1, s_2, ..., s_n\}$$

**åˆ†å±‚å®šä¹‰**:

- **L0 (å­˜å‚¨å±‚)**: ç£ç›˜é¡µå†…çš„å…ƒç»„ç‰ˆæœ¬é“¾
  $$s \in \mathcal{S}_{\text{L0}} := \text{Tuple}(xmin, xmax, data, ctid)$$

- **L1 (è¿è¡Œæ—¶å±‚)**: å †/æ ˆå†…å­˜ä½ç½®
  $$s \in \mathcal{S}_{\text{L1}} := \text{MemLoc}(address, value, lifetime)$$

- **L2 (åˆ†å¸ƒå¼å±‚)**: è·¨èŠ‚ç‚¹çš„å¤åˆ¶çŠ¶æ€æœº
  $$s \in \mathcal{S}_{\text{L2}} := \text{RSM}(logIndex, command, committed)$$

### 2.2 æ—¶ç©ºæˆ³ç³»ç»Ÿ (Timestamp System)

$$\mathcal{T} = (\text{Domain}, \prec)$$

å…¶ä¸­ $\prec$ æ˜¯ååºå…³ç³»ï¼Œæ»¡è¶³ï¼š

- **éè‡ªåæ€§**: $\forall t: \neg(t \prec t)$
- **ä¼ é€’æ€§**: $t_1 \prec t_2 \land t_2 \prec t_3 \Rightarrow t_1 \prec t_3$
- **åå¯¹ç§°æ€§**: $t_1 \prec t_2 \Rightarrow \neg(t_2 \prec t_1)$

**åˆ†å±‚å®ç°**:

| å±‚æ¬¡ | æ—¶é—´åŸŸ | ååºå®šä¹‰ | ç‰©ç†å«ä¹‰ |
|-----|-------|---------|---------|
| **L0** | $(xid, lsn) \in \mathbb{N} \times \mathbb{N}$ | $(xid_1, lsn_1) \prec (xid_2, lsn_2)$ iff $xid_1 < xid_2$ | äº‹åŠ¡æäº¤é¡ºåº |
| **L1** | $('a, \text{Ordering})$ | $hb(e_1, e_2)$ via Acquire/Release | happens-beforeå…³ç³» |
| **L2** | $(pt, lc) \in \mathbb{R} \times \mathbb{N}$ | HLCæ··åˆé€»è¾‘æ—¶é’Ÿ | ç‰©ç†+é€»è¾‘æ—¶é—´ |

### 2.3 çŠ¶æ€è½¬æ¢å‡½æ•° (State Transition)

$$\delta: \mathcal{S} \times \text{Event} \rightarrow \mathcal{S}$$

**å…¬ç†1 (çŠ¶æ€åŸå­æ€§)**:

$$\forall s_i, s_j \in \mathcal{S}: s_i \xrightarrow{\delta(e)} s_j \implies \text{Atomic}(e)$$

**è¯æ˜**: è§ `03-è¯æ˜ä¸å½¢å¼åŒ–/01-å…¬ç†ç³»ç»Ÿè¯æ˜.md#å®šç†1.1`

### 2.4 å¯è§æ€§è°“è¯ (Visibility Predicate)

$$Visible: \mathcal{S} \times \mathcal{T} \times \text{Observer} \rightarrow \{\text{true}, \text{false}\}$$

**å…¬ç†2 (å¯è§æ€§ååº)**:

$$Visible(s, t, obs) \land (s \xrightarrow{\delta} s') \implies$$
$$\exists t': t \prec t' \land Visible(s', t', obs)$$

**åˆ†å±‚å®šä¹‰**:

**L0: å¿«ç…§å¯è§æ€§**

```python
def visible_L0(tuple, snapshot, txid):
    # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬æ°¸è¿œå¯è§
    if tuple.xmin == txid:
        return True

    # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤æˆ–åœ¨å¿«ç…§åå¯åŠ¨
    if not committed(tuple.xmin) or tuple.xmin >= snapshot.xmax:
        return False

    # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨
    if tuple.xmin in snapshot.xip:
        return False

    # è§„åˆ™4: æ£€æŸ¥åˆ é™¤æ ‡è®°
    if tuple.xmax != 0:
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤
        if committed(tuple.xmax) and tuple.xmax < snapshot.xmin:
            return False  # å·²åˆ é™¤

    return True
```

**L1: å€Ÿç”¨å¯è§æ€§**

```rust
// ç¼–è¯‘æœŸæ£€æŸ¥
fn visible_L1<'a, T>(reference: &'a T, observer: &'a mut Processor) -> bool {
    // å€Ÿç”¨æ£€æŸ¥å™¨ä¿è¯ï¼š
    // 1. ç”Ÿå‘½å‘¨æœŸ'aæœ‰æ•ˆæœŸé—´ï¼ŒTçš„æ‰€æœ‰æƒæœªè½¬ç§»
    // 2. ä¸å­˜åœ¨å¯å˜å¼•ç”¨ä¸ä¸å¯å˜å¼•ç”¨åŒæ—¶å­˜åœ¨
    // 3. ç¼–è¯‘æœŸè¯æ˜æ— æ•°æ®ç«äº‰
    true  // ç¼–è¯‘é€šè¿‡å³å¯è§
}
```

**L2: å…±è¯†å¯è§æ€§**

```python
def visible_L2(log_entry, commit_index, node_id):
    # Raftåè®®å¯è§æ€§è§„åˆ™
    if log_entry.index <= commit_index:
        return True  # å·²æäº¤çš„æ—¥å¿—å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯è§

    # æœªæäº¤çš„æ—¥å¿—ä»…å¯¹Leaderå¯è§
    return node_id == current_leader_id
```

### 2.5 å†²çªæ£€æµ‹å‡½æ•° (Conflict Detection)

$$Conflict: \text{Event} \times \text{Event} \rightarrow \{\text{true}, \text{false}\}$$

**å…¬ç†3 (å†²çªå¯ä¸²è¡ŒåŒ–)**:

$$\forall e_1, e_2: Conflict(e_1, e_2) \implies$$
$$\exists \text{SerialOrder}: (e_1 \to e_2) \lor (e_2 \to e_1)$$

**å†²çªçŸ©é˜µ** (é€šç”¨å½¢å¼):

| æ“ä½œç±»å‹ | è¯»(R) | å†™(W) |
|---------|------|------|
| **è¯»(R)** | âœ“ | âœ— (L0: MVCCå…è®¸) |
| **å†™(W)** | âœ— (L0: MVCCå…è®¸) | âœ— (éœ€ä»²è£) |

**åˆ†å±‚å®ç°**:

| å±‚æ¬¡ | å†²çªæ£€æµ‹æ—¶æœº | ä»²è£æœºåˆ¶ |
|-----|------------|---------|
| **L0** | UPDATE/DELETEæ—¶æ£€æŸ¥xmax | é”ç­‰å¾… / SSIä¸­æ­¢ |
| **L1** | ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥ | ç¼–è¯‘é”™è¯¯ |
| **L2** | æ—¥å¿—å¤åˆ¶æ—¶å†²çª | å…±è¯†æŠ•ç¥¨ |

---

## ä¸‰ã€ä¸‰å±‚æ¶æ„è¯¦è§£

### 3.1 L0: å­˜å‚¨å¼•æ“å±‚

**è®¾è®¡æ¨¡å¼**: **å¤šç‰ˆæœ¬æ—¶é—´æ—…è¡Œ (Multi-Version Time Travel, MVTT)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL MVCC Architecture        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Page Layout:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tuple1      â”‚  Tuple2      â”‚  ...   â”‚ â”‚
â”‚  â”‚ (xmin=100,   â”‚ (xmin=105,   â”‚        â”‚ â”‚
â”‚  â”‚  xmax=105)   â”‚  xmax=0)     â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                â†“                 â”‚
â”‚    æ—§ç‰ˆæœ¬(æ­»å…ƒç»„)      æ–°ç‰ˆæœ¬(æ´»å…ƒç»„)       â”‚
â”‚                                            â”‚
â”‚  Snapshot:                                 â”‚
â”‚  xmin=100, xmax=110, xip=[102,103,108]     â”‚
â”‚                                            â”‚
â”‚  Visibility Check:                         â”‚
â”‚  Tuple1: visible (100 < 100) â†’ False      â”‚
â”‚  Tuple2: visible (105 in xip) â†’ False     â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```
åˆå§‹çŠ¶æ€: Tuple(xmin=50, xmax=0, data='A')
    â†“ UPDATE (TxID=100)
æ—§ç‰ˆæœ¬:   Tuple(xmin=50, xmax=100, data='A')  â† æ ‡è®°æ­»äº¡
æ–°ç‰ˆæœ¬:   Tuple(xmin=100, xmax=0, data='B')  â† æ’å…¥æ–°ç‰ˆæœ¬
    â†“ COMMIT
pg_clog[100] = COMMITTED
    â†“ VACUUM (when xmin < oldestXmin)
æ—§ç‰ˆæœ¬: [æ¸…ç†] â†’ ç©ºé—²ç©ºé—´
```

**å…³é”®ç‰¹æ€§**:

- âœ… **è¯»æ— é”**: è¯»æ“ä½œè®¿é—®å†å²å¿«ç…§ï¼Œä¸é˜»å¡å†™
- âœ… **å†™æ—¶å¤åˆ¶**: UPDATE = DELETE + INSERT
- âŒ **å­˜å‚¨è†¨èƒ€**: éœ€è¦VACUUMæ¸…ç†æ­»å…ƒç»„
- âŒ **ç‰ˆæœ¬éå†å¼€é”€**: é•¿ç‰ˆæœ¬é“¾å¯¼è‡´å¯è§æ€§æ£€æŸ¥å˜æ…¢

### 3.2 L1: è¿è¡Œæ—¶å±‚

**è®¾è®¡æ¨¡å¼**: **æ‰€æœ‰æƒæ—¶åºéš”ç¦» (Ownership Temporal Isolation, OTI)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Rust Ownership System                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Lifetime Graph:                           â”‚
â”‚  'a: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚       â†“                        â†“           â”‚
â”‚  'b: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€       â”‚
â”‚       â†“         â†“                  â†“       â”‚
â”‚      ref1      ref2              ref3      â”‚
â”‚                                            â”‚
â”‚  Borrow Checker Rules:                     â”‚
â”‚  âœ“ ref1: &'a T  (shared, valid in 'a)     â”‚
â”‚  âœ— ref2: &'b mut T (if 'b overlaps 'a)    â”‚
â”‚                                            â”‚
â”‚  Memory Ordering:                          â”‚
â”‚  Thread1: store(Release) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  Thread2: load(Acquire)  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â†“                                â”‚
â”‚      happens-beforeå…³ç³»å»ºç«‹                â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```rust
// æ‰€æœ‰æƒè½¬ç§»
let data = vec![1, 2, 3];  // dataæ‹¥æœ‰æ‰€æœ‰æƒ
let handle = thread::spawn(move || {
    // dataæ‰€æœ‰æƒè½¬ç§»åˆ°æ–°çº¿ç¨‹
    println!("{:?}", data);
});
// æ­¤å¤„dataä¸å†å¯ç”¨ï¼ˆç¼–è¯‘é”™è¯¯ï¼‰
```

**å…³é”®ç‰¹æ€§**:

- âœ… **ç¼–è¯‘æœŸä¿è¯**: é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… **æ— æ•°æ®ç«äº‰**: ç±»å‹ç³»ç»Ÿè¯æ˜çº¿ç¨‹å®‰å…¨
- âŒ **å­¦ä¹ æ›²çº¿**: éœ€ç†è§£ç”Ÿå‘½å‘¨æœŸæ ‡è®°
- âŒ **çµæ´»æ€§å—é™**: æŸäº›å®‰å…¨çš„æ¨¡å¼è¢«ç¦æ­¢

### 3.3 L2: åˆ†å¸ƒå¼å±‚

**è®¾è®¡æ¨¡å¼**: **æ—¶ç©ºå…±è¯†æ—¥å¿— (Spacetime Consensus Log, SCL)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Raft Consensus Protocol            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Log Replication:                          â”‚
â”‚  Leader:   [1] [2] [3] [4] [5]            â”‚
â”‚  Follower1:[1] [2] [3] [4] [-]            â”‚
â”‚  Follower2:[1] [2] [3] [-] [-]            â”‚
â”‚                       â†‘                    â”‚
â”‚                  commitIndex=3             â”‚
â”‚                                            â”‚
â”‚  Visibility Rule:                          â”‚
â”‚  index <= commitIndex â†’ Visible            â”‚
â”‚  index > commitIndex  â†’ Invisible          â”‚
â”‚                                            â”‚
â”‚  HLC Timestamp:                            â”‚
â”‚  (physical_time=1638360000, logical=5)     â”‚
â”‚         â†“                                  â”‚
â”‚  å…¨å±€ååº: HLC1 < HLC2 iff ...             â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```
å®¢æˆ·ç«¯è¯·æ±‚: SET x=10
    â†“
Leader: append(LogEntry(index=5, cmd='SET x=10'))
    â†“ å¹¶è¡Œå¤åˆ¶
Follower1: receive(LogEntry(5))
Follower2: receive(LogEntry(5))
    â†“ å¤šæ•°æ´¾åº”ç­”
Leader: commitIndex = 5
    â†“ åº”ç”¨åˆ°çŠ¶æ€æœº
StateMachine: x = 10 (å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯è§)
```

**å…³é”®ç‰¹æ€§**:

- âœ… **å¼ºä¸€è‡´æ€§**: çº¿æ€§ä¸€è‡´æ€§æˆ–ä¸²è¡ŒåŒ–
- âœ… **å®¹é”™æ€§**: å®¹å¿ âŒŠn/2âŒ‹ èŠ‚ç‚¹æ•…éšœ
- âŒ **é«˜å»¶è¿Ÿ**: ç½‘ç»œå¾€è¿” + å…±è¯†æŠ•ç¥¨
- âŒ **å¤æ‚æ€§**: éœ€å¤„ç†ç½‘ç»œåˆ†åŒºã€è„‘è£‚

---

## å››ã€è·¨å±‚æ˜ å°„å…³ç³»

### 4.1 åŒæ„æ€§è¯æ˜

**å®šç†4.1 (å±‚é—´åŒæ„)**: ä¸‰å±‚çš„å¯è§æ€§å…³ç³»éƒ½æ»¡è¶³ä¸¥æ ¼ååº

$$\text{Visible}_{\text{L0}} \cong \text{Visible}_{\text{L1}} \cong \text{Visible}_{\text{L2}}$$

**è¯æ˜**:

**ç¬¬ä¸€æ­¥**: è¯æ˜æ¯å±‚çš„å¯è§æ€§å…³ç³»éƒ½æ»¡è¶³ååºå…¬ç†

- **L0**: $xmin_1 < xmin_2 \implies \text{Snapshot}(xmin_1) \prec \text{Snapshot}(xmin_2)$
  - éè‡ªå: äº‹åŠ¡IDä¸ä¼šå°äºè‡ªèº« âœ“
  - ä¼ é€’: $xid_1 < xid_2 < xid_3 \implies xid_1 < xid_3$ âœ“
  - åå¯¹ç§°: $xid_1 < xid_2 \implies \neg(xid_2 < xid_1)$ âœ“

- **L1**: happens-beforeå…³ç³» (Rustå†…å­˜æ¨¡å‹)
  - éè‡ªå: äº‹ä»¶ä¸ä¼šå‘ç”Ÿåœ¨è‡ªå·±ä¹‹å‰ âœ“
  - ä¼ é€’: $e_1 \xrightarrow{hb} e_2 \xrightarrow{hb} e_3 \implies e_1 \xrightarrow{hb} e_3$ âœ“
  - åå¯¹ç§°: $e_1 \xrightarrow{hb} e_2 \implies \neg(e_2 \xrightarrow{hb} e_1)$ âœ“

- **L2**: HLCæ—¶é’Ÿçš„ååº
  - éè‡ªå: $(pt, lc) \not\prec (pt, lc)$ âœ“
  - ä¼ é€’: HLCå®šä¹‰ä¿è¯ âœ“
  - åå¯¹ç§°: å…¨åºæŠ•å½±ä¿è¯ âœ“

**ç¬¬äºŒæ­¥**: æ„é€ åŒæ„æ˜ å°„

$$\phi_{\text{L0} \to \text{L1}}: \text{TransactionId} \mapsto \text{Epoch}$$
$$\phi_{\text{L1} \to \text{L2}}: \text{ThreadId} \mapsto \text{NodeId}$$

**ç»“è®º**: ä¸‰å±‚éƒ½æ˜¯å¯¹**ååºæ—¶ç©º**çš„ä¸åŒå·¥ç¨‹å®ç° âˆ

### 4.2 é”æœºåˆ¶çš„è·¨å±‚æ˜ å°„

| L0 (PostgreSQL) | L1 (Rust) | L2 (åˆ†å¸ƒå¼) | ç»Ÿä¸€è¯­ä¹‰ |
|----------------|-----------|------------|---------|
| `FOR UPDATE` | `Mutex<T>` | `2PC Prepare Lock` | ç‹¬å è®¿é—® |
| `FOR SHARE` | `RwLock<T>::read()` | `Read Quorum` | å…±äº«è¯» |
| SSIè°“è¯é” | ç¼–è¯‘æœŸæ•°æ®ç«äº‰æ£€æµ‹ | åˆ†å¸ƒå¼æ­»é”æ£€æµ‹ | å†²çªé¢„é˜² |
| æ­»é”æ£€æµ‹(ç­‰å¾…å›¾) | æ— ï¼ˆç¼–è¯‘æœŸæœç»ï¼‰ | è¶…æ—¶å›æ»š | æ´»æ€§ä¿è¯ |

### 4.3 å¿«ç…§çš„è·¨å±‚ä¼ æ’­

```
ç”¨æˆ·å‘èµ·äº‹åŠ¡
    â†“
L2: åè°ƒè€…åˆ†é…å…¨å±€æ—¶é—´æˆ³ HLC(1638360000, 5)
    â†“ RPCè°ƒç”¨
L1: RustæœåŠ¡æ¥æ”¶è¯·æ±‚ï¼Œç”¨AtomicU64å­˜å‚¨HLC
    â†“ æ•°æ®åº“è¿æ¥
L0: PostgreSQLæ‰§è¡Œ SET TRANSACTION SNAPSHOT 'xxxx'
    â†“ åˆ›å»ºå¿«ç…§
    Snapshot(xmin=100, xmax=110, xip=[102,108])
    â†“
    æ‰€æœ‰åç»­æŸ¥è¯¢ä½¿ç”¨æ­¤å¿«ç…§ï¼ˆå¯é‡å¤è¯»ï¼‰
```

---

## äº”ã€LSEMçš„è®¾è®¡ä¼˜åŠ¿

### 5.1 ç†è®ºä¼˜åŠ¿

âœ… **ç»Ÿä¸€è¯­ä¹‰**: é¿å…æ¦‚å¿µé‡å¤å®šä¹‰ï¼ˆå¦‚"ä¸€è‡´æ€§"åœ¨ACIDå’ŒCAPä¸­å«ä¹‰ä¸åŒï¼‰
âœ… **å¯ç»„åˆæ€§**: ä¸åŒå±‚çš„æœºåˆ¶å¯ä»¥ç»„åˆï¼ˆå¦‚PostgreSQL + Rust + Raftï¼‰
âœ… **å¯è¯æ˜æ€§**: å…¬ç†åŒ–æ–¹æ³•ä¿è¯ä¸¥æ ¼æ¨å¯¼
âœ… **å¯æ‰©å±•æ€§**: æ–°å¢å±‚æ¬¡ï¼ˆå¦‚L3: è·¨æ•°æ®ä¸­å¿ƒï¼‰éµå¾ªç›¸åŒæŠ½è±¡

### 5.2 å·¥ç¨‹ä¼˜åŠ¿

âœ… **è®¾è®¡å¤ç”¨**: åŒä¸€è®¾è®¡æ¨¡å¼è·¨å±‚åº”ç”¨ï¼ˆå¦‚ç‰ˆæœ¬é“¾ â†’ æ—¥å¿—é“¾ï¼‰
âœ… **è°ƒè¯•å‹å¥½**: ç»Ÿä¸€çš„å¯è§æ€§è¯­ä¹‰ä¾¿äºè·Ÿè¸ªé”™è¯¯
âœ… **æ€§èƒ½ä¼˜åŒ–**: è¯†åˆ«ç“¶é¢ˆå±‚æ¬¡å¹¶é’ˆå¯¹æ€§ä¼˜åŒ–
âœ… **è·¨å›¢é˜Ÿåä½œ**: ç»Ÿä¸€æœ¯è¯­é™ä½æ²Ÿé€šæˆæœ¬

### 5.3 æ•™è‚²ä¼˜åŠ¿

âœ… **å­¦ä¹ æ›²çº¿å¹³æ»‘**: æŒæ¡ä¸€å±‚åå¿«é€Ÿç†è§£å…¶ä»–å±‚
âœ… **çŸ¥è¯†è¿ç§»**: æ•°æ®åº“çŸ¥è¯†è¿ç§»åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿ
âœ… **ç³»ç»Ÿæ€ç»´**: åŸ¹å…»è·¨æ ˆçš„å…¨å±€è§†è§’

---

## å…­ã€LSEMçš„å±€é™ä¸æŒ‘æˆ˜

### 6.1 ç†è®ºå±€é™

âŒ **æŠ½è±¡æŸå¤±**: è¿‡åº¦æŠ½è±¡å¯èƒ½å¿½ç•¥ç‰¹å®šå±‚çš„ç»†èŠ‚ï¼ˆå¦‚L0çš„ç‰©ç†I/Oï¼‰
âŒ **æ€§èƒ½å¼€é”€**: è·¨å±‚æ˜ å°„å¯èƒ½å¼•å…¥è½¬æ¢å¼€é”€
âŒ **ä¸å®Œå…¨å¯¹åº”**: æŸäº›L1ç‰¹æ€§ï¼ˆå¦‚ç”Ÿå‘½å‘¨æœŸæ ‡è®°ï¼‰éš¾ä»¥æ˜ å°„åˆ°L0

### 6.2 å·¥ç¨‹æŒ‘æˆ˜

âŒ **å­¦ä¹ æˆæœ¬**: éœ€è¦åŒæ—¶ç†è§£æ•°æ®åº“ã€ç¼–ç¨‹è¯­è¨€ã€åˆ†å¸ƒå¼ç³»ç»Ÿ
âŒ **å·¥å…·æ”¯æŒ**: ç¼ºä¹ç»Ÿä¸€çš„å¯è§†åŒ–/è°ƒè¯•å·¥å…·
âŒ **æ ‡å‡†åŒ–**: ä¸åŒç³»ç»Ÿçš„å®ç°å·®å¼‚å¤§ï¼ˆå¦‚MySQL MVCC vs PostgreSQLï¼‰

### 6.3 æœªæ¥æ–¹å‘

ğŸ”¬ **å½¢å¼åŒ–éªŒè¯**: ç”¨Coq/Leanè¯æ˜LSEMçš„æ­£ç¡®æ€§
ğŸ”¬ **è‡ªåŠ¨æ˜ å°„**: å¼€å‘å·¥å…·è‡ªåŠ¨ç”Ÿæˆè·¨å±‚æ˜ å°„ä»£ç 
ğŸ”¬ **æ€§èƒ½æ¨¡å‹**: å»ºç«‹ç»Ÿä¸€çš„æ€§èƒ½åˆ†ææ¡†æ¶
ğŸ”¬ **æ–°å±‚æ¬¡**: æ‰©å±•åˆ°ç¡¬ä»¶å±‚ï¼ˆå¦‚PMEMï¼‰ã€é‡å­å±‚

---

## ä¸ƒã€å®ä¾‹åˆ†æ

### 7.1 æ¡ˆä¾‹: è½¬è´¦äº‹åŠ¡çš„ä¸‰å±‚è§†è§’

**ä¸šåŠ¡éœ€æ±‚**: ä»è´¦æˆ·Aè½¬è´¦100åˆ°è´¦æˆ·B

**L2è§†è§’ (åˆ†å¸ƒå¼åè°ƒ)**:

```python
# 1. å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾Raft Leader
leader.propose(LogEntry(cmd='TRANSFER Aâ†’B 100', hlc=HLC.now()))

# 2. å¤åˆ¶åˆ°å¤šæ•°æ´¾èŠ‚ç‚¹
for follower in majority:
    follower.replicate(log_entry)

# 3. æäº¤åå‘ä¸‹ä¼ æ’­
if replicated_count >= quorum:
    commit_index = log_entry.index
    # ä¼ æ’­åˆ°L1å±‚
```

**L1è§†è§’ (Ruståº”ç”¨å±‚)**:

```rust
// æ¥æ”¶L2çš„æäº¤é€šçŸ¥
async fn handle_transfer(db_pool: Arc<PgPool>, amount: i32) -> Result<()> {
    let mut conn = db_pool.acquire().await?;  // è·å–è¿æ¥ï¼ˆL1â†’L0è¾¹ç•Œï¼‰

    let mut tx = conn.begin().await?;  // å¼€å¯L0äº‹åŠ¡

    // æ‰£æ¬¾ï¼ˆå‘é€åˆ°L0ï¼‰
    sqlx::query!("UPDATE accounts SET balance = balance - $1 WHERE id = 'A'", amount)
        .execute(&mut tx).await?;

    // å…¥è´¦
    sqlx::query!("UPDATE accounts SET balance = balance + $1 WHERE id = 'B'", amount)
        .execute(&mut tx).await?;

    tx.commit().await?;  // L0æäº¤
    Ok(())
}
```

**L0è§†è§’ (PostgreSQL MVCC)**:

```sql
-- æ‰£æ¬¾æ“ä½œ
BEGIN; -- TxID=200, è·å–å¿«ç…§ Snapshot(xmin=195, xmax=201, xip=[198])

UPDATE accounts SET balance = balance - 100 WHERE id = 'A';
-- å†…éƒ¨æµç¨‹:
-- 1. é€šè¿‡ç´¢å¼•å®šä½å…ƒç»„ ctid=(1,5)
-- 2. è·å–è¡Œé” (FOR UPDATE)
-- 3. å¯è§æ€§æ£€æŸ¥:
--    æ—§å…ƒç»„(xmin=150, xmax=0) â†’ Visible(True)
-- 4. åˆ›å»ºæ–°ç‰ˆæœ¬:
--    æ—§å…ƒç»„(xmin=150, xmax=200) â† æ ‡è®°æ­»äº¡
--    æ–°å…ƒç»„(xmin=200, xmax=0, balance=900)
-- 5. å†™WALæ—¥å¿—

UPDATE accounts SET balance = balance + 100 WHERE id = 'B';
-- ç±»ä¼¼æµç¨‹...

COMMIT; -- pg_clog[200] = COMMITTED, é‡Šæ”¾é”
```

**è·¨å±‚åŒæ­¥**:

```
L2: commitIndex=5 (å…¨å±€å¯è§)
    â†“ è§¦å‘L1å›è°ƒ
L1: RustæœåŠ¡æ”¶åˆ°é€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜
    â†“ å¼‚æ­¥åˆ·æ–°
L0: VACUUMæ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆxmax=200 < oldestXminï¼‰
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè´¡çŒ®

LSEMæ¨¡å‹çš„ä¸‰å¤§è´¡çŒ®ï¼š

1. **ç»Ÿä¸€æ¡†æ¶**: é¦–æ¬¡å°†å­˜å‚¨ã€è¿è¡Œæ—¶ã€åˆ†å¸ƒå¼å±‚çš„å¹¶å‘æ§åˆ¶ç»Ÿä¸€å»ºæ¨¡
2. **å…¬ç†åŒ–åŸºç¡€**: ä¸‰å¤§å…¬ç†ä¸ºæ‰€æœ‰å±‚æä¾›ä¸¥æ ¼çš„ç†è®ºåŸºç¡€
3. **è·¨å±‚æ˜ å°„**: æ­ç¤ºä¸åŒæŠ½è±¡å±‚æ¬¡çš„åŒæ„å…³ç³»

### 8.2 å…³é”®å…¬å¼

$$\boxed{\text{LSEM} = (Layers, States, Timestamps, Visibility, Conflict)}$$

å…¶ä¸­ï¼š

- $Layers = \{L0, L1, L2\}$
- $States = \bigcup_{i=0}^{2} \mathcal{S}_{L_i}$
- $Timestamps = \bigcup_{i=0}^{2} \mathcal{T}_{L_i}$
- $Visibility: States \times Timestamps \times Observer \to \{0,1\}$
- $Conflict: Event \times Event \to \{0,1\}$

### 8.3 å®è·µæŒ‡å—

**è®¾è®¡ç³»ç»Ÿæ—¶é—®è‡ªå·±**:

1. æˆ‘åœ¨å“ªä¸€å±‚ï¼Ÿï¼ˆL0/L1/L2ï¼‰
2. çŠ¶æ€å•å…ƒæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå…ƒç»„/å†…å­˜/æ—¥å¿—ï¼‰
3. æ—¶é—´æˆ³å¦‚ä½•å®šä¹‰ï¼Ÿï¼ˆTxID/Lifetime/HLCï¼‰
4. å¯è§æ€§è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¿«ç…§/å€Ÿç”¨/å…±è¯†ï¼‰
5. å†²çªå¦‚ä½•ä»²è£ï¼Ÿï¼ˆé”/ç¼–è¯‘å™¨/æŠ•ç¥¨ï¼‰

**è·¨å±‚è®¾è®¡åŸåˆ™**:

- âœ… åœ¨æ¯ä¸€å±‚ä½¿ç”¨æœ€é€‚åˆçš„åè°ƒæœºåˆ¶
- âœ… é¿å…è·¨å±‚é”è¯­ä¹‰æ··æ·†ï¼ˆå¦‚L1çš„Mutexä¸åº”é”L0çš„æ•°æ®åº“è¡Œï¼‰
- âœ… åˆ©ç”¨å±‚é—´æ˜ å°„å¤ç”¨è®¾è®¡æ¨¡å¼
- âœ… ç”¨å…¬ç†éªŒè¯è®¾è®¡æ­£ç¡®æ€§

---

## ä¹ã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Lamport, L. (1978). "Time, Clocks, and the Ordering of Events" â†’ æ—¶é—´æˆ³ç³»ç»Ÿ
- Herlihy, M. & Wing, J. (1990). "Linearizability" â†’ ä¸€è‡´æ€§æ¨¡å‹
- Gray, J. & Reuter, A. (1993). *Transaction Processing* â†’ L0å±‚ç†è®º

**å®ç°å‚è€ƒ**:

- PostgreSQL MVCCæºç : `src/backend/access/heap/heapam_visibility.c`
- Rustæ‰€æœ‰æƒç³»ç»Ÿ: *The Rust Programming Language* Chapter 4
- Raftåè®®: Diego Ongaro's PhD Thesis (2014)

**æ‰©å±•æ–¹å‘**:

- `02-è®¾è®¡æƒè¡¡åˆ†æ/01-å¹¶å‘æ§åˆ¶å†³ç­–æ ‘.md` â†’ å¦‚ä½•é€‰æ‹©åˆé€‚çš„å±‚å’Œæœºåˆ¶
- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md` â†’ LSEMçš„å½¢å¼åŒ–éªŒè¯
- `04-åˆ†å¸ƒå¼æ‰©å±•/01-åˆ†å¸ƒå¼MVCC(Percolator).md` â†’ L0+L2çš„èåˆ

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-05
**å…³è”æ–‡æ¡£**: `00-ç†è®ºæ¡†æ¶æ€»è§ˆ/00-ç†è®ºä½“ç³»å…¨æ™¯å›¾.md`
