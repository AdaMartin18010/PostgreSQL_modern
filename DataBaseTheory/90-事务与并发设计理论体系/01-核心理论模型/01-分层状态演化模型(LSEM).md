# 01 | åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹ (LSEM)

> **ç†è®ºå®šä½**: Layered State Evolution Model (LSEM) æ˜¯æœ¬ä½“ç³»çš„æ ¸å¿ƒå…ƒæ¨¡å‹ï¼Œå°†å¹¶å‘æ§åˆ¶é—®é¢˜æŠ½è±¡ä¸ºè·¨å±‚æ¬¡çš„çŠ¶æ€æ¼”åŒ–ä¸å¯è§æ€§æ§åˆ¶é—®é¢˜ã€‚

---

## ğŸ“‘ ç›®å½•

- [01 | åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹ (LSEM)](#01--åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹-lsem)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€LSEMç†è®ºèƒŒæ™¯ä¸æ¼”è¿›](#ä¸€lsemç†è®ºèƒŒæ™¯ä¸æ¼”è¿›)
    - [0.0 ç†è®ºåŸºç¡€](#00-ç†è®ºåŸºç¡€)
      - [0.0.1 ç»å…¸ç†è®ºæ¥æº](#001-ç»å…¸ç†è®ºæ¥æº)
      - [0.0.2 æœ¬ä½“ç³»çš„åˆ›æ–°ç‚¹](#002-æœ¬ä½“ç³»çš„åˆ›æ–°ç‚¹)
      - [0.0.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»](#003-ä¸ç»å…¸ç†è®ºçš„å…³ç³»)
    - [0.2 LSEMç†è®ºçš„æ ¸å¿ƒæŒ‘æˆ˜](#02-lsemç†è®ºçš„æ ¸å¿ƒæŒ‘æˆ˜)
  - [äºŒã€ç†è®ºåŠ¨æœºä¸é—®é¢˜å®šä¹‰](#äºŒç†è®ºåŠ¨æœºä¸é—®é¢˜å®šä¹‰)
    - [2.1 æ ¸å¿ƒé—®é¢˜](#21-æ ¸å¿ƒé—®é¢˜)
    - [2.2 LSEMçš„åˆ›æ–°](#22-lsemçš„åˆ›æ–°)
    - [3.5 å†²çªæ£€æµ‹å‡½æ•° (Conflict Detection)](#35-å†²çªæ£€æµ‹å‡½æ•°-conflict-detection)
  - [å››ã€ä¸‰å±‚æ¶æ„è¯¦è§£](#å››ä¸‰å±‚æ¶æ„è¯¦è§£)
    - [4.1 L0: å­˜å‚¨å¼•æ“å±‚](#41-l0-å­˜å‚¨å¼•æ“å±‚)
      - [4.1.1 ç¡¬ä»¶ä½“ç³»ç»“æ„èƒŒæ™¯æ¨¡å‹](#411-ç¡¬ä»¶ä½“ç³»ç»“æ„èƒŒæ™¯æ¨¡å‹)
    - [4.2 L1: è¿è¡Œæ—¶å±‚](#42-l1-è¿è¡Œæ—¶å±‚)
      - [4.2.1 Readæäº¤ç­‰æ¦‚å¿µçš„èƒŒæ™¯è§£é‡Šä¸è®ºè¯](#421-readæäº¤ç­‰æ¦‚å¿µçš„èƒŒæ™¯è§£é‡Šä¸è®ºè¯)
    - [4.3 L2: åˆ†å¸ƒå¼å±‚](#43-l2-åˆ†å¸ƒå¼å±‚)
  - [äº”ã€è·¨å±‚æ˜ å°„å…³ç³»](#äº”è·¨å±‚æ˜ å°„å…³ç³»)
    - [5.1 åŒæ„æ€§è¯æ˜](#51-åŒæ„æ€§è¯æ˜)
    - [5.2 é”æœºåˆ¶çš„è·¨å±‚æ˜ å°„](#52-é”æœºåˆ¶çš„è·¨å±‚æ˜ å°„)
    - [5.3 å¿«ç…§çš„è·¨å±‚ä¼ æ’­](#53-å¿«ç…§çš„è·¨å±‚ä¼ æ’­)
  - [å…­ã€LSEMçš„è®¾è®¡ä¼˜åŠ¿](#å…­lsemçš„è®¾è®¡ä¼˜åŠ¿)
    - [6.1 ç†è®ºä¼˜åŠ¿](#61-ç†è®ºä¼˜åŠ¿)
    - [6.2 å·¥ç¨‹ä¼˜åŠ¿](#62-å·¥ç¨‹ä¼˜åŠ¿)
    - [6.3 æ•™è‚²ä¼˜åŠ¿](#63-æ•™è‚²ä¼˜åŠ¿)
  - [ä¸ƒã€LSEMçš„å±€é™ä¸æŒ‘æˆ˜](#ä¸ƒlsemçš„å±€é™ä¸æŒ‘æˆ˜)
    - [7.1 ç†è®ºå±€é™](#71-ç†è®ºå±€é™)
    - [7.2 å·¥ç¨‹æŒ‘æˆ˜](#72-å·¥ç¨‹æŒ‘æˆ˜)
    - [7.3 æœªæ¥æ–¹å‘](#73-æœªæ¥æ–¹å‘)
  - [å…«ã€å®ä¾‹åˆ†æ](#å…«å®ä¾‹åˆ†æ)
    - [8.1 æ¡ˆä¾‹: è½¬è´¦äº‹åŠ¡çš„ä¸‰å±‚è§†è§’](#81-æ¡ˆä¾‹-è½¬è´¦äº‹åŠ¡çš„ä¸‰å±‚è§†è§’)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®å…¬å¼](#92-å…³é”®å…¬å¼)
    - [9.3 å®è·µæŒ‡å—](#93-å®è·µæŒ‡å—)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 LSEMç»Ÿä¸€æ¡†æ¶å®ç°](#111-lsemç»Ÿä¸€æ¡†æ¶å®ç°)
    - [11.2 L0å±‚å®ç° (PostgreSQL MVCC)](#112-l0å±‚å®ç°-postgresql-mvcc)
    - [11.3 L1å±‚å®ç° (Rustæ‰€æœ‰æƒ)](#113-l1å±‚å®ç°-rustæ‰€æœ‰æƒ)
    - [11.4 L2å±‚å®ç° (Raftå…±è¯†)](#114-l2å±‚å®ç°-raftå…±è¯†)
    - [11.5 è·¨å±‚æ˜ å°„å·¥å…·](#115-è·¨å±‚æ˜ å°„å·¥å…·)
  - [åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åäºŒå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [12.1 æ¡ˆä¾‹: ä¸‰å±‚ååŒçš„è½¬è´¦ç³»ç»Ÿ](#121-æ¡ˆä¾‹-ä¸‰å±‚ååŒçš„è½¬è´¦ç³»ç»Ÿ)
    - [12.2 æ¡ˆä¾‹: è·¨å±‚æ€§èƒ½ä¼˜åŒ–](#122-æ¡ˆä¾‹-è·¨å±‚æ€§èƒ½ä¼˜åŒ–)
  - [åäºŒã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åäºŒåä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: è·¨å±‚é”è¯­ä¹‰æ··æ·†](#åä¾‹1-è·¨å±‚é”è¯­ä¹‰æ··æ·†)
    - [åä¾‹2: å¿½ç•¥å±‚é—´æ—¶é—´æˆ³åŒæ­¥](#åä¾‹2-å¿½ç•¥å±‚é—´æ—¶é—´æˆ³åŒæ­¥)
    - [åä¾‹3: LSEMç†è®ºåº”ç”¨ä¸å½“](#åä¾‹3-lsemç†è®ºåº”ç”¨ä¸å½“)
    - [åä¾‹4: è·¨å±‚æ˜ å°„å®ç°ä¸å®Œæ•´](#åä¾‹4-è·¨å±‚æ˜ å°„å®ç°ä¸å®Œæ•´)
    - [åä¾‹5: LSEMæ€§èƒ½ä¼˜åŒ–è¢«å¿½ç•¥](#åä¾‹5-lsemæ€§èƒ½ä¼˜åŒ–è¢«å¿½ç•¥)
    - [åä¾‹6: LSEMç³»ç»Ÿç›‘æ§ä¸è¶³](#åä¾‹6-lsemç³»ç»Ÿç›‘æ§ä¸è¶³)
  - [åä¸‰ã€LSEMå¯è§†åŒ–](#åä¸‰lsemå¯è§†åŒ–)
    - [13.1 LSEMä¸‰å±‚æ¶æ„å›¾](#131-lsemä¸‰å±‚æ¶æ„å›¾)
    - [13.2 è·¨å±‚æ˜ å°„å…³ç³»å›¾](#132-è·¨å±‚æ˜ å°„å…³ç³»å›¾)
    - [13.3 LSEMåº”ç”¨å†³ç­–æ ‘](#133-lsemåº”ç”¨å†³ç­–æ ‘)

---

## ä¸€ã€LSEMç†è®ºèƒŒæ™¯ä¸æ¼”è¿›

### 0.0 ç†è®ºåŸºç¡€

æœ¬æ–‡æ¡£çš„ç†è®ºåŸºç¡€ä¸»è¦æ¥æºäºä»¥ä¸‹ç»å…¸æ–‡çŒ®å’Œç†è®ºæ¡†æ¶ï¼š

#### 0.0.1 ç»å…¸ç†è®ºæ¥æº

1. **Lamport, L. (1978)**: "Time, Clocks, and the Ordering of Events in a Distributed System"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†é€»è¾‘æ—¶é’Ÿå’Œhappens-beforeå…³ç³»ï¼Œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶æ’åºæä¾›äº†ç†è®ºåŸºç¡€
   - **LSEMæ˜ å°„**: L2å±‚çš„HLCï¼ˆæ··åˆé€»è¾‘æ—¶é’Ÿï¼‰ç›´æ¥åŸºäºLamportæ—¶é’Ÿç†è®º
   - **å…³ç³»**: LSEMçš„æ—¶ç©ºæˆ³ç³»ç»Ÿï¼ˆTimestamp Systemï¼‰æ˜¯å¯¹Lamportæ—¶é’Ÿçš„æ‰©å±•å’Œåˆ†å±‚æŠ½è±¡

2. **Herlihy, M., & Wing, J. M. (1990)**: "Linearizability: A Correctness Condition for Concurrent Objects"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†çº¿æ€§åŒ–æ€§ï¼ˆLinearizabilityï¼‰ä½œä¸ºå¹¶å‘å¯¹è±¡æ­£ç¡®æ€§çš„æ ‡å‡†
   - **LSEMæ˜ å°„**: LSEMçš„å¯è§æ€§ååºï¼ˆVisibility Partial Orderï¼‰å…¬ç†ä¸çº¿æ€§åŒ–æ€§å¯†åˆ‡ç›¸å…³
   - **å…³ç³»**: LSEMå°†çº¿æ€§åŒ–æ€§æ‰©å±•åˆ°è·¨å±‚æ¬¡çš„ä¸€è‡´æ€§ä¿è¯

3. **Bernstein, P. A., & Goodman, N. (1981)**: "Concurrency Control in Distributed Database Systems"
   - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»ŸåŒ–åœ°åˆ†æäº†48ç§å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œæä¾›äº†å¹¶å‘æ§åˆ¶çš„åˆ†ç±»æ¡†æ¶
   - **LSEMæ˜ å°„**: LSEMç»Ÿä¸€æ¡†æ¶æ¶µç›–äº†è¿™äº›æ–¹æ³•çš„æ ¸å¿ƒæŠ½è±¡ï¼ˆçŠ¶æ€æ¼”åŒ–ã€å†²çªæ£€æµ‹ï¼‰
   - **å…³ç³»**: LSEMæä¾›äº†è·¨å±‚æ¬¡çš„ç»Ÿä¸€è§†è§’ï¼Œæ­ç¤ºä¸åŒå¹¶å‘æ§åˆ¶æ–¹æ³•çš„æœ¬è´¨åŒæ„æ€§

4. **Gray, J., & Reuter, A. (1993)**: "Transaction Processing: Concepts and Techniques"
   - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†äº‹åŠ¡å¤„ç†çš„å®Œæ•´ç†è®ºæ¡†æ¶ï¼ŒåŒ…æ‹¬ACIDç‰¹æ€§ã€å¹¶å‘æ§åˆ¶ã€æ¢å¤æœºåˆ¶
   - **LSEMæ˜ å°„**: L0å±‚çš„MVCCå®ç°ç›´æ¥åŸºäºäº‹åŠ¡å¤„ç†ç†è®º
   - **å…³ç³»**: LSEMå°†äº‹åŠ¡å¤„ç†ç†è®ºæ‰©å±•åˆ°è¿è¡Œæ—¶å±‚ï¼ˆL1ï¼‰å’Œåˆ†å¸ƒå¼å±‚ï¼ˆL2ï¼‰

5. **Adya, A., et al. (2000)**: "Generalized Isolation Level Definitions"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¼±éš”ç¦»çº§åˆ«çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰
   - **LSEMæ˜ å°„**: L0å±‚çš„å¿«ç…§éš”ç¦»æ˜¯LSEMå¯è§æ€§æ§åˆ¶çš„å…·ä½“å®ç°
   - **å…³ç³»**: LSEMæ­ç¤ºäº†å¿«ç…§éš”ç¦»ä¸Rustç”Ÿå‘½å‘¨æœŸã€åˆ†å¸ƒå¼å¿«ç…§çš„æœ¬è´¨ç»Ÿä¸€æ€§

#### 0.0.2 æœ¬ä½“ç³»çš„åˆ›æ–°ç‚¹

ç›¸æ¯”ç»å…¸ç†è®ºï¼ŒLSEMçš„ä¸»è¦åˆ›æ–°ï¼š

1. **ç»Ÿä¸€æ¡†æ¶**: å°†å­˜å‚¨å±‚ï¼ˆL0ï¼‰ã€è¿è¡Œæ—¶å±‚ï¼ˆL1ï¼‰ã€åˆ†å¸ƒå¼å±‚ï¼ˆL2ï¼‰çš„å¹¶å‘æ§åˆ¶ç»Ÿä¸€å»ºæ¨¡
   - **ç»å…¸ç†è®º**: å„å±‚æ¬¡ç‹¬ç«‹ç ”ç©¶ï¼Œç¼ºä¹ç»Ÿä¸€æŠ½è±¡
   - **LSEMåˆ›æ–°**: æ­ç¤ºä¸‰å±‚é—´çš„åŒæ„å…³ç³»ï¼Œæä¾›ç»Ÿä¸€çš„çŠ¶æ€æ¼”åŒ–æ¨¡å‹

2. **è·¨å±‚æ˜ å°„**: è¯æ˜ä¸åŒå±‚æ¬¡é—´çš„åŒæ„æ€§ï¼ˆå®šç†4.1: å±‚é—´åŒæ„ï¼‰
   - **ç»å…¸ç†è®º**: å„å±‚æ¬¡ä½¿ç”¨ä¸åŒçš„æœ¯è¯­å’Œæ¦‚å¿µ
   - **LSEMåˆ›æ–°**: å»ºç«‹è·¨å±‚æ˜ å°„å…³ç³»ï¼Œå®ç°æ¦‚å¿µçš„ç»Ÿä¸€å’Œå¤ç”¨

3. **å½¢å¼åŒ–å…¬ç†ç³»ç»Ÿ**: æå‡ºä¸‰å¤§å…¬ç†ï¼ˆçŠ¶æ€åŸå­æ€§ã€å¯è§æ€§ååºã€å†²çªå¯ä¸²è¡ŒåŒ–ï¼‰
   - **ç»å…¸ç†è®º**: å„å±‚æ¬¡æœ‰å„è‡ªçš„æ­£ç¡®æ€§æ ‡å‡†
   - **LSEMåˆ›æ–°**: ç»Ÿä¸€çš„å…¬ç†ç³»ç»Ÿé€‚ç”¨äºæ‰€æœ‰å±‚æ¬¡

4. **å·¥ç¨‹å®è·µç»“åˆ**: ç´§å¯†ç»“åˆPostgreSQLã€Rustã€åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®é™…å®ç°
   - **ç»å…¸ç†è®º**: åé‡ç†è®ºåˆ†æ
   - **LSEMåˆ›æ–°**: ç†è®ºåˆ†æä¸å·¥ç¨‹å®ç°å¹¶é‡ï¼Œæä¾›å¯éªŒè¯çš„æ˜ å°„å…³ç³»

#### 0.0.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»

```text
LSEMä¸ç»å…¸ç†è®ºçš„å…³ç³»:
â”‚
â”œâ”€ Lamportæ—¶é’Ÿç†è®º
â”‚  â”œâ”€ è´¡çŒ®: äº‹ä»¶æ’åºã€é€»è¾‘æ—¶é’Ÿ
â”‚  â”œâ”€ LSEMæ‰©å±•: æ‰©å±•åˆ°ä¸‰å±‚æ¶æ„
â”‚  â””â”€ åº”ç”¨: L2å±‚HLCã€L1å±‚happens-beforeã€L0å±‚äº‹åŠ¡ID
â”‚
â”œâ”€ çº¿æ€§åŒ–æ€§ç†è®º
â”‚  â”œâ”€ è´¡çŒ®: å¹¶å‘å¯¹è±¡æ­£ç¡®æ€§æ ‡å‡†
â”‚  â”œâ”€ LSEMæ‰©å±•: æ‰©å±•åˆ°è·¨å±‚æ¬¡ä¸€è‡´æ€§
â”‚  â””â”€ åº”ç”¨: æ‰€æœ‰å±‚æ¬¡çš„å¯è§æ€§ä¿è¯
â”‚
â”œâ”€ å¹¶å‘æ§åˆ¶åˆ†ç±»ç†è®º
â”‚  â”œâ”€ è´¡çŒ®: 48ç§æ–¹æ³•çš„ç³»ç»ŸåŒ–åˆ†ç±»
â”‚  â”œâ”€ LSEMæ‰©å±•: ç»Ÿä¸€æ¡†æ¶ä¸‹çš„åˆ†ç±»
â”‚  â””â”€ åº”ç”¨: è·¨å±‚æ¬¡çš„æ–¹æ³•é€‰æ‹©å’Œå¯¹æ¯”
â”‚
â””â”€ äº‹åŠ¡å¤„ç†ç†è®º
   â”œâ”€ è´¡çŒ®: ACIDã€å¹¶å‘æ§åˆ¶ã€æ¢å¤
   â”œâ”€ LSEMæ‰©å±•: æ‰©å±•åˆ°è¿è¡Œæ—¶å’Œåˆ†å¸ƒå¼å±‚
   â””â”€ åº”ç”¨: å…¨æ ˆäº‹åŠ¡å¤„ç†æ¡†æ¶
```text

### 0.1 ä¸ºä»€ä¹ˆéœ€è¦LSEMç†è®ºï¼Ÿ

**å†å²èƒŒæ™¯**:

LSEMï¼ˆåˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹ï¼‰æ˜¯æœ¬ä½“ç³»çš„æ ¸å¿ƒå…ƒæ¨¡å‹ï¼Œä»2020å¹´ä»£å¼€å§‹ï¼Œç ”ç©¶è€…æ„è¯†åˆ°æ•°æ®åº“MVCCã€Rustæ‰€æœ‰æƒã€åˆ†å¸ƒå¼å…±è¯†åœ¨æœ¬è´¨ä¸Šæ˜¯åŒæ„çš„ã€‚LSEMå°†è¿™äº›å¹¶å‘æ§åˆ¶é—®é¢˜æŠ½è±¡ä¸ºè·¨å±‚æ¬¡çš„çŠ¶æ€æ¼”åŒ–ä¸å¯è§æ€§æ§åˆ¶é—®é¢˜ã€‚ç†è§£LSEMç†è®ºï¼Œæœ‰åŠ©äºæŒæ¡å¹¶å‘æ§åˆ¶çš„ç»Ÿä¸€æ¡†æ¶ã€ç†è§£è·¨å±‚æ˜ å°„å…³ç³»ã€é¿å…å¸¸è§çš„è®¾è®¡é”™è¯¯ã€‚

**ç†è®ºåŸºç¡€**:

```text
LSEMç†è®ºçš„æ ¸å¿ƒ:
â”œâ”€ é—®é¢˜: å¦‚ä½•ç»Ÿä¸€ç†è§£å¹¶å‘æ§åˆ¶é—®é¢˜ï¼Ÿ
â”œâ”€ ç†è®º: åˆ†å±‚çŠ¶æ€æ¼”åŒ–ç†è®ºï¼ˆL0/L1/L2ä¸‰å±‚æ¶æ„ï¼‰
â””â”€ æ–¹æ³•: LSEMç»Ÿä¸€æ¡†æ¶ï¼ˆçŠ¶æ€ç©ºé—´ã€æ—¶ç©ºæˆ³ã€å¯è§æ€§ã€å†²çªæ£€æµ‹ï¼‰

ä¸ºä»€ä¹ˆéœ€è¦LSEMç†è®º?
â”œâ”€ æ— ç†è®º: æ¦‚å¿µé‡å¤å®šä¹‰ï¼Œè®¾è®¡æ¨¡å¼æ— æ³•å¤ç”¨
â”œâ”€ ç»éªŒæ–¹æ³•: ä¸å®Œæ•´ï¼Œç†è®ºå­¤å²›éš¾ä»¥èåˆ
â””â”€ LSEMç†è®º: ç»Ÿä¸€æ¡†æ¶ã€è·¨å±‚å¤ç”¨ã€ç†è®ºèåˆ
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
LSEMç†è®ºæ¼”è¿›:
â”œâ”€ æ—©æœŸæ¢ç´¢ (1990s-2010s)
â”‚   â”œâ”€ å„é¢†åŸŸç‹¬ç«‹å‘å±•
â”‚   â”œâ”€ é—®é¢˜: ç¼ºä¹ç»Ÿä¸€æ¡†æ¶
â”‚   â””â”€ ç»“æœ: ç†è®ºå­¤å²›
â”‚
â”œâ”€ ç†è®ºå»ºç«‹ (2010s-2020s)
â”‚   â”œâ”€ è·¨å±‚æ˜ å°„å‘ç°
â”‚   â”œâ”€ LSEMç†è®ºæå‡º
â”‚   â””â”€ ç»Ÿä¸€æ¡†æ¶å»ºç«‹
â”‚
â””â”€ ç°ä»£åº”ç”¨ (2020s+)
    â”œâ”€ LSEMåº”ç”¨æ‰©å±•
    â”œâ”€ è·¨å±‚ä¼˜åŒ–
    â””â”€ ç†è®ºèåˆ
```

**ä¸ºä»€ä¹ˆLSEMç†è®ºé‡è¦ï¼Ÿ**

1. **ç»Ÿä¸€æ¡†æ¶**: ç»Ÿä¸€ç†è§£å¹¶å‘æ§åˆ¶é—®é¢˜
2. **è·¨å±‚å¤ç”¨**: è®¾è®¡æ¨¡å¼å¯ä»¥è·¨å±‚å¤ç”¨
3. **ç†è®ºèåˆ**: æ‰“ç ´ç†è®ºå­¤å²›ï¼Œä¿ƒè¿›ç†è®ºèåˆ
4. **ç³»ç»Ÿè®¾è®¡**: ä¸ºç³»ç»Ÿè®¾è®¡æä¾›ç»Ÿä¸€æŒ‡å¯¼

**åä¾‹: æ— LSEMç†è®ºçš„é—®é¢˜**:

```text
é”™è¯¯è®¾è®¡: æ— LSEMç†è®ºï¼Œå„å±‚ç‹¬ç«‹è®¾è®¡
â”œâ”€ åœºæ™¯: è·¨å±‚å¹¶å‘æ§åˆ¶ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: å„å±‚ç‹¬ç«‹è®¾è®¡ï¼Œæ¦‚å¿µé‡å¤å®šä¹‰
â”œâ”€ ç»“æœ: è®¾è®¡ä¸ä¸€è‡´ï¼Œæ€§èƒ½å·®
â””â”€ æ­£ç¡®æ€§: è®¾è®¡ä¸ä¸€è‡´ âœ—

æ­£ç¡®è®¾è®¡: ä½¿ç”¨LSEMç†è®º
â”œâ”€ æ–¹æ¡ˆ: ç»Ÿä¸€æ¡†æ¶ï¼Œè·¨å±‚æ˜ å°„
â”œâ”€ ç»“æœ: è®¾è®¡ä¸€è‡´ï¼Œæ€§èƒ½æ»¡è¶³éœ€æ±‚
â””â”€ æ­£ç¡®æ€§: è®¾è®¡ä¸€è‡´ï¼Œæ€§èƒ½æ»¡è¶³éœ€æ±‚ âœ“
```

**åè¯: ä¸ºä»€ä¹ˆLSEMç†è®ºæ˜¯å¿…è¦çš„ï¼Ÿ**

**å®šç†**: æ— ç»Ÿä¸€æ¡†æ¶çš„è·¨å±‚å¹¶å‘æ§åˆ¶è®¾è®¡å¿…ç„¶å­˜åœ¨æ¦‚å¿µé‡å¤å’Œè®¾è®¡ä¸ä¸€è‡´

**è¯æ˜ï¼ˆæ„é€ æ€§åè¯ï¼‰**:

```text
å‡è®¾: æ— ç»Ÿä¸€æ¡†æ¶ï¼Œå„å±‚ç‹¬ç«‹è®¾è®¡ä»èƒ½ä¿è¯ä¸€è‡´æ€§

æ„é€ åä¾‹:
â”œâ”€ L0å±‚: å®šä¹‰äº‹åŠ¡ID (xid) ä½œä¸ºæ—¶é—´æˆ³
â”œâ”€ L1å±‚: å®šä¹‰happens-beforeå…³ç³»ä½œä¸ºæ—¶é—´æˆ³
â”œâ”€ L2å±‚: å®šä¹‰HLCæ—¶é’Ÿä½œä¸ºæ—¶é—´æˆ³
â”œâ”€ é—®é¢˜: ä¸‰ä¸ªä¸åŒçš„æ—¶é—´æˆ³ç³»ç»Ÿï¼Œæ— æ³•å»ºç«‹è·¨å±‚å…³ç³»
â””â”€ ç»“æœ: è·¨å±‚å¯è§æ€§åˆ¤æ–­é”™è¯¯ âœ—

å¦‚æœæ— ç»Ÿä¸€æ¡†æ¶:
â”œâ”€ æ¦‚å¿µé‡å¤: æ¯å±‚éƒ½å®šä¹‰è‡ªå·±çš„æ—¶é—´æˆ³ã€å¯è§æ€§ã€å†²çªæ£€æµ‹
â”œâ”€ è®¾è®¡ä¸ä¸€è‡´: ä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„è®¾è®¡æ¨¡å¼
â”œâ”€ è·¨å±‚æ˜ å°„å›°éš¾: æ— æ³•å»ºç«‹å±‚é—´å…³ç³»
â””â”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™

å› æ­¤: LSEMç»Ÿä¸€æ¡†æ¶æ˜¯å¿…è¦çš„
```

**ç¡¬ä»¶å±‚é¢çš„åè¯**:

```text
ç¡¬ä»¶æ¼”è¿›å¯¹LSEMçš„å½±å“:
â”œâ”€ å•æ ¸æ—¶ä»£: L0å±‚ä¸ºä¸»ï¼ŒL1/L2å±‚ç®€å•
â”œâ”€ å¤šæ ¸æ—¶ä»£: L1å±‚é‡è¦æ€§å¢åŠ ï¼ˆç¼“å­˜ä¸€è‡´æ€§ï¼‰
â”œâ”€ NUMAæ—¶ä»£: L2å±‚é‡è¦æ€§å¢åŠ ï¼ˆåˆ†å¸ƒå¼ç‰¹æ€§ï¼‰
â””â”€ é—®é¢˜: ä¸åŒç¡¬ä»¶ç¯å¢ƒä¸‹ï¼Œå„å±‚é‡è¦æ€§ä¸åŒ

å¦‚æœæ— ç»Ÿä¸€æ¡†æ¶:
â”œâ”€ å•æ ¸ç³»ç»Ÿ: è¿‡åº¦è®¾è®¡L1/L2å±‚
â”œâ”€ å¤šæ ¸ç³»ç»Ÿ: å¿½ç•¥L1å±‚ä¼˜åŒ–
â”œâ”€ NUMAç³»ç»Ÿ: å¿½ç•¥L2å±‚è®¾è®¡
â””â”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡ä¸é€‚åº”ç¡¬ä»¶ç¯å¢ƒ âœ—

å› æ­¤: LSEMç»Ÿä¸€æ¡†æ¶åœ¨ç¡¬ä»¶å±‚é¢ä¹Ÿæ˜¯å¿…è¦çš„
```

**è¯­è¨€æœºåˆ¶å±‚é¢çš„åè¯**:

```text
è¯­è¨€æœºåˆ¶å¯¹LSEMçš„å½±å“:
â”œâ”€ C/C++: L0å±‚ä¸ºä¸»ï¼ŒL1å±‚ç®€å•ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰
â”œâ”€ Rust: L1å±‚é‡è¦æ€§å¢åŠ ï¼ˆæ‰€æœ‰æƒç³»ç»Ÿï¼‰
â”œâ”€ Java/Go: L1å±‚é‡è¦æ€§å¢åŠ ï¼ˆGCï¼‰
â””â”€ é—®é¢˜: ä¸åŒè¯­è¨€ç¯å¢ƒä¸‹ï¼Œå„å±‚é‡è¦æ€§ä¸åŒ

å¦‚æœæ— ç»Ÿä¸€æ¡†æ¶:
â”œâ”€ C/C++ç³»ç»Ÿ: å¿½ç•¥L1å±‚è®¾è®¡
â”œâ”€ Rustç³»ç»Ÿ: è¿‡åº¦è®¾è®¡L0å±‚
â”œâ”€ Javaç³»ç»Ÿ: å¿½ç•¥L0å±‚ä¼˜åŒ–
â””â”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡ä¸é€‚åº”è¯­è¨€ç¯å¢ƒ âœ—

å› æ­¤: LSEMç»Ÿä¸€æ¡†æ¶åœ¨è¯­è¨€æœºåˆ¶å±‚é¢ä¹Ÿæ˜¯å¿…è¦çš„
```

### 0.2 LSEMç†è®ºçš„æ ¸å¿ƒæŒ‘æˆ˜

**å†å²èƒŒæ™¯**:

LSEMç†è®ºé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜åŒ…æ‹¬ï¼šå¦‚ä½•å®šä¹‰ç»Ÿä¸€çš„çŠ¶æ€ç©ºé—´ã€å¦‚ä½•è®¾è®¡æ—¶ç©ºæˆ³ç³»ç»Ÿã€å¦‚ä½•å®šä¹‰å¯è§æ€§è§„åˆ™ã€å¦‚ä½•å®ç°è·¨å±‚æ˜ å°„ç­‰ã€‚è¿™äº›æŒ‘æˆ˜ä¿ƒä½¿ç†è®ºä¸æ–­ä¼˜åŒ–ã€‚

**ç†è®ºåŸºç¡€**:

```text
LSEMç†è®ºæŒ‘æˆ˜:
â”œâ”€ çŠ¶æ€æŒ‘æˆ˜: å¦‚ä½•å®šä¹‰ç»Ÿä¸€çš„çŠ¶æ€ç©ºé—´
â”œâ”€ æ—¶é—´æŒ‘æˆ˜: å¦‚ä½•è®¾è®¡æ—¶ç©ºæˆ³ç³»ç»Ÿ
â”œâ”€ å¯è§æ€§æŒ‘æˆ˜: å¦‚ä½•å®šä¹‰å¯è§æ€§è§„åˆ™
â””â”€ æ˜ å°„æŒ‘æˆ˜: å¦‚ä½•å®ç°è·¨å±‚æ˜ å°„

LSEMè§£å†³æ–¹æ¡ˆ:
â”œâ”€ çŠ¶æ€: åˆ†å±‚çŠ¶æ€ç©ºé—´å®šä¹‰
â”œâ”€ æ—¶é—´: åˆ†å±‚æ—¶ç©ºæˆ³ç³»ç»Ÿ
â”œâ”€ å¯è§æ€§: åˆ†å±‚å¯è§æ€§è§„åˆ™
â””â”€ æ˜ å°„: åŒæ„æ€§è¯æ˜ã€è·¨å±‚æ˜ å°„å·¥å…·
```

---

## äºŒã€ç†è®ºåŠ¨æœºä¸é—®é¢˜å®šä¹‰

### 2.1 æ ¸å¿ƒé—®é¢˜

æ‰€æœ‰å¹¶å‘ç³»ç»Ÿé¢ä¸´çš„æœ¬è´¨é—®é¢˜ï¼š

$$\text{Who can see What State at When Time?}$$

**å…·ä½“åŒ–**:

- **Who**: äº‹åŠ¡ã€çº¿ç¨‹ã€èŠ‚ç‚¹
- **What**: æ•°æ®ç‰ˆæœ¬ã€å†…å­˜å€¼ã€å…¨å±€çŠ¶æ€
- **When**: æ—¶é—´æˆ³ã€äº‹åŠ¡IDã€é€»è¾‘æ—¶é’Ÿ

**ä¼ ç»Ÿæ–¹æ³•çš„å±€é™**:

- æ•°æ®åº“ç†è®ºï¼šå…³æ³¨å­˜å‚¨å±‚çš„äº‹åŠ¡éš”ç¦»
- ç¼–ç¨‹è¯­è¨€ç†è®ºï¼šå…³æ³¨å†…å­˜å±‚çš„çº¿ç¨‹å®‰å…¨
- åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºï¼šå…³æ³¨ç½‘ç»œå±‚çš„ä¸€è‡´æ€§

**ç¼ºä¹ç»Ÿä¸€æ¡†æ¶**ï¼Œå¯¼è‡´ï¼š

- æ¦‚å¿µé‡å¤å®šä¹‰ï¼ˆå¦‚"å¯è§æ€§"åœ¨ä¸åŒé¢†åŸŸæœ‰ä¸åŒå«ä¹‰ï¼‰
- è®¾è®¡æ¨¡å¼æ— æ³•è·¨å±‚å¤ç”¨
- ç†è®ºå­¤å²›éš¾ä»¥èåˆ

### 2.2 LSEMçš„åˆ›æ–°

**æ ¸å¿ƒæ´å¯Ÿ**:
> æ•°æ®åº“MVCCã€Rustæ‰€æœ‰æƒã€åˆ†å¸ƒå¼å…±è¯†**æœ¬è´¨åŒæ„**â€”â€”éƒ½æ˜¯åœ¨ä¸åŒæ—¶ç©ºç»´åº¦ä¸Šç®¡ç†çŠ¶æ€æ¼”åŒ–çš„å¯è§æ€§ã€‚

**ç»Ÿä¸€æ¡†æ¶**:

```text
LSEM = çŠ¶æ€ç©ºé—´ + æ—¶ç©ºæˆ³ç³»ç»Ÿ + å¯è§æ€§è§„åˆ™ + å†²çªä»²è£æœºåˆ¶
```text

---

## ä¸‰ã€å½¢å¼åŒ–å®šä¹‰

### 3.1 çŠ¶æ€ç©ºé—´ (State Space)

$$\mathcal{S} = \{s_1, s_2, ..., s_n\}$$

**åˆ†å±‚å®šä¹‰**:

- **L0 (å­˜å‚¨å±‚)**: ç£ç›˜é¡µå†…çš„å…ƒç»„ç‰ˆæœ¬é“¾
  $$s \in \mathcal{S}_{\text{L0}} := \text{Tuple}(xmin, xmax, data, ctid)$$

- **L1 (è¿è¡Œæ—¶å±‚)**: å †/æ ˆå†…å­˜ä½ç½®
  $$s \in \mathcal{S}_{\text{L1}} := \text{MemLoc}(address, value, lifetime)$$

- **L2 (åˆ†å¸ƒå¼å±‚)**: è·¨èŠ‚ç‚¹çš„å¤åˆ¶çŠ¶æ€æœº
  $$s \in \mathcal{S}_{\text{L2}} := \text{RSM}(logIndex, command, committed)$$

### 3.2 æ—¶ç©ºæˆ³ç³»ç»Ÿ (Timestamp System)

$$\mathcal{T} = (\text{Domain}, \prec)$$

å…¶ä¸­ $\prec$ æ˜¯ååºå…³ç³»ï¼Œæ»¡è¶³ï¼š

- **éè‡ªåæ€§**: $\forall t: \neg(t \prec t)$
- **ä¼ é€’æ€§**: $t_1 \prec t_2 \land t_2 \prec t_3 \Rightarrow t_1 \prec t_3$
- **åå¯¹ç§°æ€§**: $t_1 \prec t_2 \Rightarrow \neg(t_2 \prec t_1)$

**åˆ†å±‚å®ç°**:

| å±‚æ¬¡ | æ—¶é—´åŸŸ | ååºå®šä¹‰ | ç‰©ç†å«ä¹‰ |
|-----|-------|---------|---------|
| **L0** | $(xid, lsn) \in \mathbb{N} \times \mathbb{N}$ | $(xid_1, lsn_1) \prec (xid_2, lsn_2)$ iff $xid_1 < xid_2$ | äº‹åŠ¡æäº¤é¡ºåº |
| **L1** | $('a, \text{Ordering})$ | $hb(e_1, e_2)$ via Acquire/Release | happens-beforeå…³ç³» |
| **L2** | $(pt, lc) \in \mathbb{R} \times \mathbb{N}$ | HLCæ··åˆé€»è¾‘æ—¶é’Ÿ | ç‰©ç†+é€»è¾‘æ—¶é—´ |

### 3.3 çŠ¶æ€è½¬æ¢å‡½æ•° (State Transition)

$$\delta: \mathcal{S} \times \text{Event} \rightarrow \mathcal{S}$$

**å…¬ç†1 (çŠ¶æ€åŸå­æ€§)**:

$$\forall s_i, s_j \in \mathcal{S}: s_i \xrightarrow{\delta(e)} s_j \implies \text{Atomic}(e)$$

**è¯æ˜**: è§ `03-è¯æ˜ä¸å½¢å¼åŒ–/01-å…¬ç†ç³»ç»Ÿè¯æ˜.md#å®šç†1.1`

### 3.4 å¯è§æ€§è°“è¯ (Visibility Predicate)

$$Visible: \mathcal{S} \times \mathcal{T} \times \text{Observer} \rightarrow \{\text{true}, \text{false}\}$$

**å…¬ç†2 (å¯è§æ€§ååº)**:

$$Visible(s, t, obs) \land (s \xrightarrow{\delta} s') \implies$$
$$\exists t': t \prec t' \land Visible(s', t', obs)$$

**åˆ†å±‚å®šä¹‰**:

**L0: å¿«ç…§å¯è§æ€§**:

```python
def visible_L0(tuple, snapshot, txid):
    # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬æ°¸è¿œå¯è§
    if tuple.xmin == txid:
        return True

    # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤æˆ–åœ¨å¿«ç…§åå¯åŠ¨
    if not committed(tuple.xmin) or tuple.xmin >= snapshot.xmax:
        return False

    # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨
    if tuple.xmin in snapshot.xip:
        return False

    # è§„åˆ™4: æ£€æŸ¥åˆ é™¤æ ‡è®°
    if tuple.xmax != 0:
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤
        if committed(tuple.xmax) and tuple.xmax < snapshot.xmin:
            return False  # å·²åˆ é™¤

    return True
```

**L1: å€Ÿç”¨å¯è§æ€§**:

```rust
// ç¼–è¯‘æœŸæ£€æŸ¥
fn visible_L1<'a, T>(reference: &'a T, observer: &'a mut Processor) -> bool {
    // å€Ÿç”¨æ£€æŸ¥å™¨ä¿è¯ï¼š
    // 1. ç”Ÿå‘½å‘¨æœŸ'aæœ‰æ•ˆæœŸé—´ï¼ŒTçš„æ‰€æœ‰æƒæœªè½¬ç§»
    // 2. ä¸å­˜åœ¨å¯å˜å¼•ç”¨ä¸ä¸å¯å˜å¼•ç”¨åŒæ—¶å­˜åœ¨
    // 3. ç¼–è¯‘æœŸè¯æ˜æ— æ•°æ®ç«äº‰
    true  // ç¼–è¯‘é€šè¿‡å³å¯è§
}
```

**L2: å…±è¯†å¯è§æ€§**:

```python
def visible_L2(log_entry, commit_index, node_id):
    # Raftåè®®å¯è§æ€§è§„åˆ™
    if log_entry.index <= commit_index:
        return True  # å·²æäº¤çš„æ—¥å¿—å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯è§

    # æœªæäº¤çš„æ—¥å¿—ä»…å¯¹Leaderå¯è§
    return node_id == current_leader_id
```

### 3.5 å†²çªæ£€æµ‹å‡½æ•° (Conflict Detection)

$$Conflict: \text{Event} \times \text{Event} \rightarrow \{\text{true}, \text{false}\}$$

**å…¬ç†3 (å†²çªå¯ä¸²è¡ŒåŒ–)**:

$$\forall e_1, e_2: Conflict(e_1, e_2) \implies$$
$$\exists \text{SerialOrder}: (e_1 \to e_2) \lor (e_2 \to e_1)$$

**å†²çªçŸ©é˜µ** (é€šç”¨å½¢å¼):

| æ“ä½œç±»å‹ | è¯»(R) | å†™(W) |
|---------|------|------|
| **è¯»(R)** | âœ“ | âœ— (L0: MVCCå…è®¸) |
| **å†™(W)** | âœ— (L0: MVCCå…è®¸) | âœ— (éœ€ä»²è£) |

**åˆ†å±‚å®ç°**:

| å±‚æ¬¡ | å†²çªæ£€æµ‹æ—¶æœº | ä»²è£æœºåˆ¶ |
|-----|------------|---------|
| **L0** | UPDATE/DELETEæ—¶æ£€æŸ¥xmax | é”ç­‰å¾… / SSIä¸­æ­¢ |
| **L1** | ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥ | ç¼–è¯‘é”™è¯¯ |
| **L2** | æ—¥å¿—å¤åˆ¶æ—¶å†²çª | å…±è¯†æŠ•ç¥¨ |

---

## å››ã€ä¸‰å±‚æ¶æ„è¯¦è§£

### 4.1 L0: å­˜å‚¨å¼•æ“å±‚

**è®¾è®¡æ¨¡å¼**: **å¤šç‰ˆæœ¬æ—¶é—´æ—…è¡Œ (Multi-Version Time Travel, MVTT)**

#### 4.1.1 ç¡¬ä»¶ä½“ç³»ç»“æ„èƒŒæ™¯æ¨¡å‹

**L0å±‚çš„ç¡¬ä»¶åŸºç¡€**:

ç°ä»£æ•°æ®åº“å­˜å‚¨å¼•æ“çš„è®¾è®¡å¿…é¡»è€ƒè™‘åº•å±‚ç¡¬ä»¶ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§æ·±åˆ»å½±å“äº†MVCCçš„å®ç°ç­–ç•¥ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç¡¬ä»¶å­˜å‚¨å±‚æ¬¡ç»“æ„ (Memory Hierarchy)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  L1 Cache (CPUå¯„å­˜å™¨)                      â”‚
â”‚  â”œâ”€ å»¶è¿Ÿ: ~1ns                             â”‚
â”‚  â”œâ”€ å®¹é‡: ~32KB/core                       â”‚
â”‚  â””â”€ ç”¨é€”: çƒ­æ•°æ®è®¿é—®                        â”‚
â”‚         â†“                                  â”‚
â”‚  L2/L3 Cache (CPUç¼“å­˜)                     â”‚
â”‚  â”œâ”€ å»¶è¿Ÿ: ~10ns                            â”‚
â”‚  â”œâ”€ å®¹é‡: ~1-32MB/core                      â”‚
â”‚  â””â”€ ç”¨é€”: ç¼“å­˜è¡Œå¯¹é½ä¼˜åŒ–                    â”‚
â”‚         â†“                                  â”‚
â”‚  DRAM (ä¸»å†…å­˜)                              â”‚
â”‚  â”œâ”€ å»¶è¿Ÿ: ~100ns                            â”‚
â”‚  â”œâ”€ å®¹é‡: ~16-512GB                         â”‚
â”‚  â””â”€ ç”¨é€”: ç¼“å†²æ±  (Buffer Pool)              â”‚
â”‚         â†“                                  â”‚
â”‚  SSD/NVMe (æŒä¹…åŒ–å­˜å‚¨)                      â”‚
â”‚  â”œâ”€ å»¶è¿Ÿ: ~10-100Î¼s                         â”‚
â”‚  â”œâ”€ å®¹é‡: ~1-100TB                          â”‚
â”‚  â””â”€ ç”¨é€”: æ•°æ®æ–‡ä»¶ + WAL                    â”‚
â”‚         â†“                                  â”‚
â”‚  HDD (å½’æ¡£å­˜å‚¨)                             â”‚
â”‚  â”œâ”€ å»¶è¿Ÿ: ~5-10ms                           â”‚
â”‚  â”œâ”€ å®¹é‡: ~10-100TB                         â”‚
â”‚  â””â”€ ç”¨é€”: å†·æ•°æ®å½’æ¡£                        â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¡¬ä»¶ç‰¹æ€§å¯¹MVCCè®¾è®¡çš„å½±å“**:

1. **ç¼“å­˜è¡Œå¯¹é½ (Cache Line Alignment)**:
   - ç°ä»£CPUç¼“å­˜è¡Œå¤§å°: 64å­—èŠ‚
   - PostgreSQLå…ƒç»„å¤´: 24å­—èŠ‚ (HeapTupleHeaderData)
   - **ä¼˜åŒ–**: å…ƒç»„æ•°æ®å°½é‡å¯¹é½ï¼Œå‡å°‘ç¼“å­˜æœªå‘½ä¸­

2. **å†™æ—¶å¤åˆ¶ (Copy-on-Write) çš„ç¡¬ä»¶æ”¯æŒ**:
   - CPUæ”¯æŒåŸå­æ“ä½œ (Compare-and-Swap)
   - **MVCCä¼˜åŠ¿**: UPDATEæ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬å¯è¢«å…¶ä»–äº‹åŠ¡å¹¶å‘è¯»å–
   - **ç¡¬ä»¶åŠ é€Ÿ**: åˆ©ç”¨CPUç¼“å­˜ä¸€è‡´æ€§åè®® (MESI)

3. **å†…å­˜å±éšœ (Memory Barrier)**:
   - **Releaseè¯­ä¹‰**: ç¡®ä¿å†™æ“ä½œåœ¨åç»­è¯»æ“ä½œä¹‹å‰å®Œæˆ
   - **Acquireè¯­ä¹‰**: ç¡®ä¿è¯»æ“ä½œåœ¨åç»­å†™æ“ä½œä¹‹å‰å®Œæˆ
   - **MVCCåº”ç”¨**: äº‹åŠ¡æäº¤æ—¶ä½¿ç”¨å†…å­˜å±éšœï¼Œç¡®ä¿pg_clogçŠ¶æ€å¯è§

4. **NUMAæ¶æ„ (Non-Uniform Memory Access)**:
   - å¤šCPUæ’æ§½ç³»ç»Ÿï¼Œæœ¬åœ°å†…å­˜ vs è¿œç¨‹å†…å­˜å»¶è¿Ÿå·®å¼‚
   - **PostgreSQLä¼˜åŒ–**: è¿›ç¨‹ç»‘å®šåˆ°ç‰¹å®šNUMAèŠ‚ç‚¹ï¼Œå‡å°‘è·¨èŠ‚ç‚¹è®¿é—®

**I/Oå­ç³»ç»Ÿå¯¹äº‹åŠ¡æäº¤çš„å½±å“**:

```text
äº‹åŠ¡æäº¤çš„ç¡¬ä»¶è·¯å¾„:
â”œâ”€ 1. CPUæ‰§è¡ŒCOMMITæŒ‡ä»¤
â”‚   â””â”€ è§¦å‘WALå†™å…¥
â”‚
â”œâ”€ 2. WALå†™å…¥è·¯å¾„
â”‚   â”œâ”€ åº”ç”¨å±‚ç¼“å†²åŒº (PostgreSQL WAL Buffer)
â”‚   â”œâ”€ OSé¡µç¼“å­˜ (Page Cache)
â”‚   â”œâ”€ å—è®¾å¤‡å±‚ (Block Device Layer)
â”‚   â””â”€ å­˜å‚¨è®¾å¤‡ (SSD/NVMe)
â”‚
â”œâ”€ 3. fsync()è°ƒç”¨
â”‚   â”œâ”€ å¼ºåˆ¶åˆ·æ–°OSé¡µç¼“å­˜åˆ°å­˜å‚¨è®¾å¤‡
â”‚   â”œâ”€ ç­‰å¾…å­˜å‚¨è®¾å¤‡ç¡®è®¤å†™å…¥å®Œæˆ
â”‚   â””â”€ è¿”å›æˆåŠŸ (ä¿è¯æŒä¹…æ€§)
â”‚
â””â”€ 4. å­˜å‚¨è®¾å¤‡ç¡®è®¤
    â”œâ”€ NVMe: å†™å…¥NANDé—ªå­˜
    â”œâ”€ å†™å…¥ç¡®è®¤è¿”å›
    â””â”€ äº‹åŠ¡æäº¤å®Œæˆ
```

**ç¡¬ä»¶æ€§èƒ½å‚æ•°å¯¹MVCCçš„å½±å“**:

| ç¡¬ä»¶å‚æ•° | å…¸å‹å€¼ | MVCCè®¾è®¡å½±å“ |
|---------|-------|------------|
| **CPUç¼“å­˜è¡Œå¤§å°** | 64å­—èŠ‚ | å…ƒç»„å¯¹é½ï¼Œå‡å°‘ç¼“å­˜æœªå‘½ä¸­ |
| **å†…å­˜å¸¦å®½** | ~50GB/s | ç‰ˆæœ¬é“¾éå†æ€§èƒ½ç“¶é¢ˆ |
| **SSDéšæœºè¯»å»¶è¿Ÿ** | ~10-50Î¼s | ç´¢å¼•æ‰«ææ€§èƒ½ |
| **SSDéšæœºå†™å»¶è¿Ÿ** | ~10-50Î¼s | WALå†™å…¥æ€§èƒ½ |
| **fsyncå»¶è¿Ÿ** | ~100-1000Î¼s | äº‹åŠ¡æäº¤å»¶è¿Ÿ |

**PostgreSQL MVCCæ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL MVCC Architecture       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Page Layout:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tuple1      â”‚  Tuple2      â”‚  ...   â”‚ â”‚
â”‚  â”‚ (xmin=100,   â”‚ (xmin=105,   â”‚        â”‚ â”‚
â”‚  â”‚  xmax=105)   â”‚  xmax=0)     â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                â†“                â”‚
â”‚    æ—§ç‰ˆæœ¬(æ­»å…ƒç»„)      æ–°ç‰ˆæœ¬(æ´»å…ƒç»„)       â”‚
â”‚                                            â”‚
â”‚  Snapshot:                                 â”‚
â”‚  xmin=100, xmax=110, xip=[102,103,108]     â”‚
â”‚                                            â”‚
â”‚  Visibility Check:                         â”‚
â”‚  Tuple1: visible (100 < 100) â†’ False      â”‚
â”‚  Tuple2: visible (105 in xip) â†’ False     â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```text
åˆå§‹çŠ¶æ€: Tuple(xmin=50, xmax=0, data='A')
    â†“ UPDATE (TxID=100)
æ—§ç‰ˆæœ¬:   Tuple(xmin=50, xmax=100, data='A')  â† æ ‡è®°æ­»äº¡
æ–°ç‰ˆæœ¬:   Tuple(xmin=100, xmax=0, data='B')  â† æ’å…¥æ–°ç‰ˆæœ¬
    â†“ COMMIT
pg_clog[100] = COMMITTED
    â†“ VACUUM (when xmin < oldestXmin)
æ—§ç‰ˆæœ¬: [æ¸…ç†] â†’ ç©ºé—²ç©ºé—´
```

**å…³é”®ç‰¹æ€§**:

- âœ… **è¯»æ— é”**: è¯»æ“ä½œè®¿é—®å†å²å¿«ç…§ï¼Œä¸é˜»å¡å†™
- âœ… **å†™æ—¶å¤åˆ¶**: UPDATE = DELETE + INSERT
- âŒ **å­˜å‚¨è†¨èƒ€**: éœ€è¦VACUUMæ¸…ç†æ­»å…ƒç»„
- âŒ **ç‰ˆæœ¬éå†å¼€é”€**: é•¿ç‰ˆæœ¬é“¾å¯¼è‡´å¯è§æ€§æ£€æŸ¥å˜æ…¢

### 4.2 L1: è¿è¡Œæ—¶å±‚

**è®¾è®¡æ¨¡å¼**: **æ‰€æœ‰æƒæ—¶åºéš”ç¦» (Ownership Temporal Isolation, OTI)**

#### 4.2.1 Readæäº¤ç­‰æ¦‚å¿µçš„èƒŒæ™¯è§£é‡Šä¸è®ºè¯

**ä¸ºä»€ä¹ˆéœ€è¦Read Committedéš”ç¦»çº§åˆ«ï¼Ÿ**

Read Committed (è¯»å·²æäº¤) æ˜¯æ•°æ®åº“äº‹åŠ¡éš”ç¦»çš„åŸºç¡€çº§åˆ«ï¼Œå…¶è®¾è®¡åŠ¨æœºæºäºå¯¹**ä¸€è‡´æ€§**å’Œ**æ€§èƒ½**çš„æƒè¡¡ï¼š

**ç†è®ºåŸºç¡€**:

1. **è„è¯»é—®é¢˜ (Dirty Read)**:

   ```text
   äº‹åŠ¡T1:                   äº‹åŠ¡T2:
   BEGIN;                    BEGIN;
   UPDATE x SET v=100;       SELECT v FROM x;  -- è¯»åˆ°v=100 (è„è¯»)
   (æœªæäº¤)                  COMMIT;
   ROLLBACK;                 -- T2åŸºäºé”™è¯¯æ•°æ®åšå†³ç­–
   ```

   - **é—®é¢˜**: è¯»å–åˆ°æœªæäº¤çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘é”™è¯¯
   - **Read Committedä¿è¯**: åªè¯»å–å·²æäº¤çš„æ•°æ®

2. **è¯­å¥çº§å¿«ç…§ (Statement-Level Snapshot)**:

   ```text
   Read Committedçš„å¯è§æ€§è§„åˆ™:
   â”œâ”€ æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ—¶è·å–å¿«ç…§
   â”œâ”€ å¿«ç…§åŒ…å«: xmin, xmax, xip (æ´»è·ƒäº‹åŠ¡åˆ—è¡¨)
   â””â”€ è¯­å¥æ‰§è¡ŒæœŸé—´å¿«ç…§ä¸å˜

   ç¤ºä¾‹:
   BEGIN;  -- äº‹åŠ¡T1å¼€å§‹ (xid=100)
   SELECT * FROM t;  -- è¯­å¥1: å¿«ç…§(xmin=100, xmax=110, xip=[])
   -- æ­¤æ—¶T2 (xid=105) æäº¤äº†UPDATE
   SELECT * FROM t;  -- è¯­å¥2: æ–°å¿«ç…§(xmin=100, xmax=115, xip=[])
                    -- å¯ä»¥çœ‹åˆ°T2çš„æ›´æ–°ï¼
   ```

   - **è®¾è®¡åŠ¨æœº**: å…è®¸äº‹åŠ¡çœ‹åˆ°å…¶ä»–äº‹åŠ¡çš„æäº¤ï¼Œæé«˜å¹¶å‘æ€§
   - **ä¸Repeatable Readå¯¹æ¯”**: RRåœ¨äº‹åŠ¡å¼€å§‹æ—¶è·å–å¿«ç…§ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´ä¸å˜

3. **å†™å†™å†²çªæ£€æµ‹ (Write-Write Conflict)**:

   ```text
   äº‹åŠ¡T1:                   äº‹åŠ¡T2:
   BEGIN;                    BEGIN;
   SELECT * FROM t           SELECT * FROM t
    WHERE id=1;               WHERE id=1;
   UPDATE t SET v=10         UPDATE t SET v=20
    WHERE id=1;                WHERE id=1;
   -- T1å…ˆæäº¤              -- T2åæäº¤
   COMMIT;                   -- T2æ£€æµ‹åˆ°å†²çªï¼Œç­‰å¾…æˆ–é‡è¯•
   ```

   - **Read Committedè¡Œä¸º**: åæäº¤çš„äº‹åŠ¡æ£€æµ‹åˆ°å†²çªï¼Œç­‰å¾…æˆ–é‡è¯•
   - **ç†è®ºåŸºç¡€**: åŸºäºé”çš„å†²çªæ£€æµ‹ï¼Œä¿è¯å†™æ“ä½œçš„åŸå­æ€§

**Read Committedçš„å¯è§æ€§è¯æ˜**:

**å®šç†4.2.1 (Read Committedå¯è§æ€§)**:

$$\forall \text{stmt} \in T, \forall \text{tuple } t: \text{Visible}(t, \text{Snapshot}(\text{stmt})) \iff$$

$$(\text{Committed}(t.\text{xmin}) \land t.\text{xmin} < \text{Snapshot}.\text{xmax} \land t.\text{xmin} \notin \text{Snapshot}.\text{xip}) \land$$

$$(\neg \text{Committed}(t.\text{xmax}) \lor t.\text{xmax} \geq \text{Snapshot}.\text{xmax} \lor t.\text{xmax} \in \text{Snapshot}.\text{xip})$$

**è¯æ˜**:

1. **å……åˆ†æ€§**: å¦‚æœtupleæ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™å¯¹å½“å‰è¯­å¥å¯è§
   - $t.\text{xmin}$å·²æäº¤ä¸”åœ¨å½“å‰å¿«ç…§ä¹‹å‰ â†’ åˆ›å»ºäº‹åŠ¡å·²å®Œæˆ
   - $t.\text{xmax}$æœªæäº¤æˆ–å¤§äºå¿«ç…§ â†’ åˆ é™¤äº‹åŠ¡æœªå®Œæˆæˆ–æœªå¼€å§‹
   - å› æ­¤tupleå¯¹å½“å‰è¯­å¥å¯è§ âœ“

2. **å¿…è¦æ€§**: å¦‚æœtupleå¯¹å½“å‰è¯­å¥å¯è§ï¼Œåˆ™å¿…é¡»æ»¡è¶³ä¸Šè¿°æ¡ä»¶
   - å¦‚æœ$t.\text{xmin}$æœªæäº¤ â†’ tupleåˆ›å»ºæœªå®Œæˆï¼Œä¸å¯è§ âœ—
   - å¦‚æœ$t.\text{xmax}$å·²æäº¤ä¸”å°äºå¿«ç…§ â†’ tupleå·²è¢«åˆ é™¤ï¼Œä¸å¯è§ âœ—
   - å› æ­¤å¿…é¡»æ»¡è¶³æ¡ä»¶ âœ“

**Read Committedä¸ç¡¬ä»¶å†…å­˜æ¨¡å‹çš„å¯¹åº”**:

```text
æ•°æ®åº“éš”ç¦»çº§åˆ« â†” CPUå†…å­˜æ¨¡å‹:
â”œâ”€ Read Committed â†” Release-Acquireè¯­ä¹‰
â”‚   â”œâ”€ äº‹åŠ¡æäº¤ = Releaseæ“ä½œ
â”‚   â”œâ”€ è¯­å¥å¼€å§‹ = Acquireæ“ä½œ
â”‚   â””â”€ ä¿è¯: æäº¤åçš„æ•°æ®å¯¹åç»­è¯­å¥å¯è§
â”‚
â”œâ”€ Repeatable Read â†” Sequential Consistency
â”‚   â”œâ”€ äº‹åŠ¡å¼€å§‹ = è·å–å…¨å±€å¿«ç…§
â”‚   â”œâ”€ æ•´ä¸ªäº‹åŠ¡æœŸé—´å¿«ç…§ä¸å˜
â”‚   â””â”€ ä¿è¯: äº‹åŠ¡å†…ä¸€è‡´æ€§è§†å›¾
â”‚
â””â”€ Serializable â†” Linearizability
    â”œâ”€ å…¨å±€é¡ºåºæ‰§è¡Œ
    â”œâ”€ å†™åæ–œæ£€æµ‹
    â””â”€ ä¿è¯: å¯åºåˆ—åŒ–æ‰§è¡Œ
```

**Rustæ‰€æœ‰æƒç³»ç»Ÿ**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Rust Ownership System                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Lifetime Graph:                           â”‚
â”‚  'a: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚       â†“                        â†“           â”‚
â”‚  'b: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€       â”‚
â”‚       â†“         â†“                  â†“       â”‚
â”‚      ref1      ref2              ref3      â”‚
â”‚                                            â”‚
â”‚  Borrow Checker Rules:                     â”‚
â”‚  âœ“ ref1: &'a T  (shared, valid in 'a)     â”‚
â”‚  âœ— ref2: &'b mut T (if 'b overlaps 'a)    â”‚
â”‚                                            â”‚
â”‚  Memory Ordering:                          â”‚
â”‚  Thread1: store(Release) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  Thread2: load(Acquire)  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â†“                                â”‚
â”‚      happens-beforeå…³ç³»å»ºç«‹                â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```rust
// æ‰€æœ‰æƒè½¬ç§»
let data = vec![1, 2, 3];  // dataæ‹¥æœ‰æ‰€æœ‰æƒ
let handle = thread::spawn(move || {
    // dataæ‰€æœ‰æƒè½¬ç§»åˆ°æ–°çº¿ç¨‹
    println!("{:?}", data);
});
// æ­¤å¤„dataä¸å†å¯ç”¨ï¼ˆç¼–è¯‘é”™è¯¯ï¼‰
```

**å…³é”®ç‰¹æ€§**:

- âœ… **ç¼–è¯‘æœŸä¿è¯**: é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… **æ— æ•°æ®ç«äº‰**: ç±»å‹ç³»ç»Ÿè¯æ˜çº¿ç¨‹å®‰å…¨
- âŒ **å­¦ä¹ æ›²çº¿**: éœ€ç†è§£ç”Ÿå‘½å‘¨æœŸæ ‡è®°
- âŒ **çµæ´»æ€§å—é™**: æŸäº›å®‰å…¨çš„æ¨¡å¼è¢«ç¦æ­¢

### 4.3 L2: åˆ†å¸ƒå¼å±‚

**è®¾è®¡æ¨¡å¼**: **æ—¶ç©ºå…±è¯†æ—¥å¿— (Spacetime Consensus Log, SCL)**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Raft Consensus Protocol           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Log Replication:                          â”‚
â”‚  Leader:   [1] [2] [3] [4] [5]             â”‚
â”‚  Follower1:[1] [2] [3] [4] [-]             â”‚
â”‚  Follower2:[1] [2] [3] [-] [-]             â”‚
â”‚                       â†‘                    â”‚
â”‚                  commitIndex=3             â”‚
â”‚                                            â”‚
â”‚  Visibility Rule:                          â”‚
â”‚  index <= commitIndex â†’ Visible            â”‚
â”‚  index > commitIndex  â†’ Invisible          â”‚
â”‚                                            â”‚
â”‚  HLC Timestamp:                            â”‚
â”‚  (physical_time=1638360000, logical=5)     â”‚
â”‚         â†“                                  â”‚
â”‚  å…¨å±€ååº: HLC1 < HLC2 iff ...              â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢ç¤ºä¾‹**:

```text
å®¢æˆ·ç«¯è¯·æ±‚: SET x=10
    â†“
Leader: append(LogEntry(index=5, cmd='SET x=10'))
    â†“ å¹¶è¡Œå¤åˆ¶
Follower1: receive(LogEntry(5))
Follower2: receive(LogEntry(5))
    â†“ å¤šæ•°æ´¾åº”ç­”
Leader: commitIndex = 5
    â†“ åº”ç”¨åˆ°çŠ¶æ€æœº
StateMachine: x = 10 (å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯è§)
```

**å…³é”®ç‰¹æ€§**:

- âœ… **å¼ºä¸€è‡´æ€§**: çº¿æ€§ä¸€è‡´æ€§æˆ–ä¸²è¡ŒåŒ–
- âœ… **å®¹é”™æ€§**: å®¹å¿ âŒŠn/2âŒ‹ èŠ‚ç‚¹æ•…éšœ
- âŒ **é«˜å»¶è¿Ÿ**: ç½‘ç»œå¾€è¿” + å…±è¯†æŠ•ç¥¨
- âŒ **å¤æ‚æ€§**: éœ€å¤„ç†ç½‘ç»œåˆ†åŒºã€è„‘è£‚

---

## äº”ã€è·¨å±‚æ˜ å°„å…³ç³»

### 5.1 åŒæ„æ€§è¯æ˜

**å®šç†5.1 (å±‚é—´åŒæ„)**: ä¸‰å±‚çš„å¯è§æ€§å…³ç³»éƒ½æ»¡è¶³ä¸¥æ ¼ååº

$$\text{Visible}_{\text{L0}} \cong \text{Visible}_{\text{L1}} \cong \text{Visible}_{\text{L2}}$$

**è¯æ˜**:

**ç¬¬ä¸€æ­¥**: è¯æ˜æ¯å±‚çš„å¯è§æ€§å…³ç³»éƒ½æ»¡è¶³ååºå…¬ç†

- **L0**: $xmin_1 < xmin_2 \implies \text{Snapshot}(xmin_1) \prec \text{Snapshot}(xmin_2)$
  - éè‡ªå: äº‹åŠ¡IDä¸ä¼šå°äºè‡ªèº« âœ“
  - ä¼ é€’: $xid_1 < xid_2 < xid_3 \implies xid_1 < xid_3$ âœ“
  - åå¯¹ç§°: $xid_1 < xid_2 \implies \neg(xid_2 < xid_1)$ âœ“

- **L1**: happens-beforeå…³ç³» (Rustå†…å­˜æ¨¡å‹)
  - éè‡ªå: äº‹ä»¶ä¸ä¼šå‘ç”Ÿåœ¨è‡ªå·±ä¹‹å‰ âœ“
  - ä¼ é€’: $e_1 \xrightarrow{hb} e_2 \xrightarrow{hb} e_3 \implies e_1 \xrightarrow{hb} e_3$ âœ“
  - åå¯¹ç§°: $e_1 \xrightarrow{hb} e_2 \implies \neg(e_2 \xrightarrow{hb} e_1)$ âœ“

- **L2**: HLCæ—¶é’Ÿçš„ååº
  - éè‡ªå: $(pt, lc) \not\prec (pt, lc)$ âœ“
  - ä¼ é€’: HLCå®šä¹‰ä¿è¯ âœ“
  - åå¯¹ç§°: å…¨åºæŠ•å½±ä¿è¯ âœ“

**ç¬¬äºŒæ­¥**: æ„é€ åŒæ„æ˜ å°„

$$\phi_{\text{L0} \to \text{L1}}: \text{TransactionId} \mapsto \text{Epoch}$$
$$\phi_{\text{L1} \to \text{L2}}: \text{ThreadId} \mapsto \text{NodeId}$$

**ç»“è®º**: ä¸‰å±‚éƒ½æ˜¯å¯¹**ååºæ—¶ç©º**çš„ä¸åŒå·¥ç¨‹å®ç° âˆ

### 5.2 é”æœºåˆ¶çš„è·¨å±‚æ˜ å°„

| L0 (PostgreSQL) | L1 (Rust) | L2 (åˆ†å¸ƒå¼) | ç»Ÿä¸€è¯­ä¹‰ |
|----------------|-----------|------------|---------|
| `FOR UPDATE` | `Mutex<T>` | `2PC Prepare Lock` | ç‹¬å è®¿é—® |
| `FOR SHARE` | `RwLock<T>::read()` | `Read Quorum` | å…±äº«è¯» |
| SSIè°“è¯é” | ç¼–è¯‘æœŸæ•°æ®ç«äº‰æ£€æµ‹ | åˆ†å¸ƒå¼æ­»é”æ£€æµ‹ | å†²çªé¢„é˜² |
| æ­»é”æ£€æµ‹(ç­‰å¾…å›¾) | æ— ï¼ˆç¼–è¯‘æœŸæœç»ï¼‰ | è¶…æ—¶å›æ»š | æ´»æ€§ä¿è¯ |

### 5.3 å¿«ç…§çš„è·¨å±‚ä¼ æ’­

```text
ç”¨æˆ·å‘èµ·äº‹åŠ¡
    â†“
L2: åè°ƒè€…åˆ†é…å…¨å±€æ—¶é—´æˆ³ HLC(1638360000, 5)
    â†“ RPCè°ƒç”¨
L1: RustæœåŠ¡æ¥æ”¶è¯·æ±‚ï¼Œç”¨AtomicU64å­˜å‚¨HLC
    â†“ æ•°æ®åº“è¿æ¥
L0: PostgreSQLæ‰§è¡Œ SET TRANSACTION SNAPSHOT 'xxxx'
    â†“ åˆ›å»ºå¿«ç…§
    Snapshot(xmin=100, xmax=110, xip=[102,108])
    â†“
    æ‰€æœ‰åç»­æŸ¥è¯¢ä½¿ç”¨æ­¤å¿«ç…§ï¼ˆå¯é‡å¤è¯»ï¼‰
```

---

## å…­ã€LSEMçš„è®¾è®¡ä¼˜åŠ¿

### 6.1 ç†è®ºä¼˜åŠ¿

âœ… **ç»Ÿä¸€è¯­ä¹‰**: é¿å…æ¦‚å¿µé‡å¤å®šä¹‰ï¼ˆå¦‚"ä¸€è‡´æ€§"åœ¨ACIDå’ŒCAPä¸­å«ä¹‰ä¸åŒï¼‰
âœ… **å¯ç»„åˆæ€§**: ä¸åŒå±‚çš„æœºåˆ¶å¯ä»¥ç»„åˆï¼ˆå¦‚PostgreSQL + Rust + Raftï¼‰
âœ… **å¯è¯æ˜æ€§**: å…¬ç†åŒ–æ–¹æ³•ä¿è¯ä¸¥æ ¼æ¨å¯¼
âœ… **å¯æ‰©å±•æ€§**: æ–°å¢å±‚æ¬¡ï¼ˆå¦‚L3: è·¨æ•°æ®ä¸­å¿ƒï¼‰éµå¾ªç›¸åŒæŠ½è±¡

### 6.2 å·¥ç¨‹ä¼˜åŠ¿

âœ… **è®¾è®¡å¤ç”¨**: åŒä¸€è®¾è®¡æ¨¡å¼è·¨å±‚åº”ç”¨ï¼ˆå¦‚ç‰ˆæœ¬é“¾ â†’ æ—¥å¿—é“¾ï¼‰
âœ… **è°ƒè¯•å‹å¥½**: ç»Ÿä¸€çš„å¯è§æ€§è¯­ä¹‰ä¾¿äºè·Ÿè¸ªé”™è¯¯
âœ… **æ€§èƒ½ä¼˜åŒ–**: è¯†åˆ«ç“¶é¢ˆå±‚æ¬¡å¹¶é’ˆå¯¹æ€§ä¼˜åŒ–
âœ… **è·¨å›¢é˜Ÿåä½œ**: ç»Ÿä¸€æœ¯è¯­é™ä½æ²Ÿé€šæˆæœ¬

### 6.3 æ•™è‚²ä¼˜åŠ¿

âœ… **å­¦ä¹ æ›²çº¿å¹³æ»‘**: æŒæ¡ä¸€å±‚åå¿«é€Ÿç†è§£å…¶ä»–å±‚
âœ… **çŸ¥è¯†è¿ç§»**: æ•°æ®åº“çŸ¥è¯†è¿ç§»åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿ
âœ… **ç³»ç»Ÿæ€ç»´**: åŸ¹å…»è·¨æ ˆçš„å…¨å±€è§†è§’

---

## ä¸ƒã€LSEMçš„å±€é™ä¸æŒ‘æˆ˜

### 7.1 ç†è®ºå±€é™

âŒ **æŠ½è±¡æŸå¤±**: è¿‡åº¦æŠ½è±¡å¯èƒ½å¿½ç•¥ç‰¹å®šå±‚çš„ç»†èŠ‚ï¼ˆå¦‚L0çš„ç‰©ç†I/Oï¼‰
âŒ **æ€§èƒ½å¼€é”€**: è·¨å±‚æ˜ å°„å¯èƒ½å¼•å…¥è½¬æ¢å¼€é”€
âŒ **ä¸å®Œå…¨å¯¹åº”**: æŸäº›L1ç‰¹æ€§ï¼ˆå¦‚ç”Ÿå‘½å‘¨æœŸæ ‡è®°ï¼‰éš¾ä»¥æ˜ å°„åˆ°L0

### 7.2 å·¥ç¨‹æŒ‘æˆ˜

âŒ **å­¦ä¹ æˆæœ¬**: éœ€è¦åŒæ—¶ç†è§£æ•°æ®åº“ã€ç¼–ç¨‹è¯­è¨€ã€åˆ†å¸ƒå¼ç³»ç»Ÿ
âŒ **å·¥å…·æ”¯æŒ**: ç¼ºä¹ç»Ÿä¸€çš„å¯è§†åŒ–/è°ƒè¯•å·¥å…·
âŒ **æ ‡å‡†åŒ–**: ä¸åŒç³»ç»Ÿçš„å®ç°å·®å¼‚å¤§ï¼ˆå¦‚MySQL MVCC vs PostgreSQLï¼‰

### 7.3 æœªæ¥æ–¹å‘

ğŸ”¬ **å½¢å¼åŒ–éªŒè¯**: ç”¨Coq/Leanè¯æ˜LSEMçš„æ­£ç¡®æ€§
ğŸ”¬ **è‡ªåŠ¨æ˜ å°„**: å¼€å‘å·¥å…·è‡ªåŠ¨ç”Ÿæˆè·¨å±‚æ˜ å°„ä»£ç 
ğŸ”¬ **æ€§èƒ½æ¨¡å‹**: å»ºç«‹ç»Ÿä¸€çš„æ€§èƒ½åˆ†ææ¡†æ¶
ğŸ”¬ **æ–°å±‚æ¬¡**: æ‰©å±•åˆ°ç¡¬ä»¶å±‚ï¼ˆå¦‚PMEMï¼‰ã€é‡å­å±‚

---

## å…«ã€å®ä¾‹åˆ†æ

### 8.1 æ¡ˆä¾‹: è½¬è´¦äº‹åŠ¡çš„ä¸‰å±‚è§†è§’

**ä¸šåŠ¡éœ€æ±‚**: ä»è´¦æˆ·Aè½¬è´¦100åˆ°è´¦æˆ·B

**L2è§†è§’ (åˆ†å¸ƒå¼åè°ƒ)**:

```python
# 1. å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾Raft Leader
leader.propose(LogEntry(cmd='TRANSFER Aâ†’B 100', hlc=HLC.now()))

# 2. å¤åˆ¶åˆ°å¤šæ•°æ´¾èŠ‚ç‚¹
for follower in majority:
    follower.replicate(log_entry)

# 3. æäº¤åå‘ä¸‹ä¼ æ’­
if replicated_count >= quorum:
    commit_index = log_entry.index
    # ä¼ æ’­åˆ°L1å±‚
```

**L1è§†è§’ (Ruståº”ç”¨å±‚)**:

```rust
// æ¥æ”¶L2çš„æäº¤é€šçŸ¥
async fn handle_transfer(db_pool: Arc<PgPool>, amount: i32) -> Result<()> {
    let mut conn = db_pool.acquire().await?;  // è·å–è¿æ¥ï¼ˆL1â†’L0è¾¹ç•Œï¼‰

    let mut tx = conn.begin().await?;  // å¼€å¯L0äº‹åŠ¡

    // æ‰£æ¬¾ï¼ˆå‘é€åˆ°L0ï¼‰
    sqlx::query!("UPDATE accounts SET balance = balance - $1 WHERE id = 'A'", amount)
        .execute(&mut tx).await?;

    // å…¥è´¦
    sqlx::query!("UPDATE accounts SET balance = balance + $1 WHERE id = 'B'", amount)
        .execute(&mut tx).await?;

    tx.commit().await?;  // L0æäº¤
    Ok(())
}
```

**L0è§†è§’ (PostgreSQL MVCC)**:

```sql
-- æ‰£æ¬¾æ“ä½œ
BEGIN; -- TxID=200, è·å–å¿«ç…§ Snapshot(xmin=195, xmax=201, xip=[198])

UPDATE accounts SET balance = balance - 100 WHERE id = 'A';
-- å†…éƒ¨æµç¨‹:
-- 1. é€šè¿‡ç´¢å¼•å®šä½å…ƒç»„ ctid=(1,5)
-- 2. è·å–è¡Œé” (FOR UPDATE)
-- 3. å¯è§æ€§æ£€æŸ¥:
--    æ—§å…ƒç»„(xmin=150, xmax=0) â†’ Visible(True)
-- 4. åˆ›å»ºæ–°ç‰ˆæœ¬:
--    æ—§å…ƒç»„(xmin=150, xmax=200) â† æ ‡è®°æ­»äº¡
--    æ–°å…ƒç»„(xmin=200, xmax=0, balance=900)
-- 5. å†™WALæ—¥å¿—

UPDATE accounts SET balance = balance + 100 WHERE id = 'B';
-- ç±»ä¼¼æµç¨‹...

COMMIT; -- pg_clog[200] = COMMITTED, é‡Šæ”¾é”
```

**è·¨å±‚åŒæ­¥**:

```text
L2: commitIndex=5 (å…¨å±€å¯è§)
    â†“ è§¦å‘L1å›è°ƒ
L1: RustæœåŠ¡æ”¶åˆ°é€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜
    â†“ å¼‚æ­¥åˆ·æ–°
L0: VACUUMæ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆxmax=200 < oldestXminï¼‰
```

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

LSEMæ¨¡å‹çš„ä¸‰å¤§è´¡çŒ®ï¼š

1. **ç»Ÿä¸€æ¡†æ¶**: é¦–æ¬¡å°†å­˜å‚¨ã€è¿è¡Œæ—¶ã€åˆ†å¸ƒå¼å±‚çš„å¹¶å‘æ§åˆ¶ç»Ÿä¸€å»ºæ¨¡
2. **å…¬ç†åŒ–åŸºç¡€**: ä¸‰å¤§å…¬ç†ä¸ºæ‰€æœ‰å±‚æä¾›ä¸¥æ ¼çš„ç†è®ºåŸºç¡€
3. **è·¨å±‚æ˜ å°„**: æ­ç¤ºä¸åŒæŠ½è±¡å±‚æ¬¡çš„åŒæ„å…³ç³»

### 9.2 å…³é”®å…¬å¼

$$\boxed{\text{LSEM} = (Layers, States, Timestamps, Visibility, Conflict)}$$

å…¶ä¸­ï¼š

- $Layers = \{L0, L1, L2\}$
- $States = \bigcup_{i=0}^{2} \mathcal{S}_{L_i}$
- $Timestamps = \bigcup_{i=0}^{2} \mathcal{T}_{L_i}$
- $Visibility: States \times Timestamps \times Observer \to \{0,1\}$
- $Conflict: Event \times Event \to \{0,1\}$

### 9.3 å®è·µæŒ‡å—

**è®¾è®¡ç³»ç»Ÿæ—¶é—®è‡ªå·±**:

1. æˆ‘åœ¨å“ªä¸€å±‚ï¼Ÿï¼ˆL0/L1/L2ï¼‰
2. çŠ¶æ€å•å…ƒæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå…ƒç»„/å†…å­˜/æ—¥å¿—ï¼‰
3. æ—¶é—´æˆ³å¦‚ä½•å®šä¹‰ï¼Ÿï¼ˆTxID/Lifetime/HLCï¼‰
4. å¯è§æ€§è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¿«ç…§/å€Ÿç”¨/å…±è¯†ï¼‰
5. å†²çªå¦‚ä½•ä»²è£ï¼Ÿï¼ˆé”/ç¼–è¯‘å™¨/æŠ•ç¥¨ï¼‰

**è·¨å±‚è®¾è®¡åŸåˆ™**:

- âœ… åœ¨æ¯ä¸€å±‚ä½¿ç”¨æœ€é€‚åˆçš„åè°ƒæœºåˆ¶
- âœ… é¿å…è·¨å±‚é”è¯­ä¹‰æ··æ·†ï¼ˆå¦‚L1çš„Mutexä¸åº”é”L0çš„æ•°æ®åº“è¡Œï¼‰
- âœ… åˆ©ç”¨å±‚é—´æ˜ å°„å¤ç”¨è®¾è®¡æ¨¡å¼
- âœ… ç”¨å…¬ç†éªŒè¯è®¾è®¡æ­£ç¡®æ€§

---

## åã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Lamport, L. (1978). "Time, Clocks, and the Ordering of Events" â†’ æ—¶é—´æˆ³ç³»ç»Ÿ
- Herlihy, M. & Wing, J. (1990). "Linearizability" â†’ ä¸€è‡´æ€§æ¨¡å‹
- Gray, J. & Reuter, A. (1993). *Transaction Processing* â†’ L0å±‚ç†è®º
- Bernstein, P. A., & Goodman, N. (1981). "Concurrency Control in Distributed Database Systems" â†’ å¹¶å‘æ§åˆ¶åˆ†ç±»

**æœ€æ–°ç ”ç©¶** (2020s+):

- **CCaaLF (2025)**: å­¦ä¹ å‹å¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–å¹¶å‘æ§åˆ¶ç­–ç•¥
  - **LSEMå…³è”**: CCaaLFå¯ä»¥åº”ç”¨äºLSEMçš„æ¯ä¸€å±‚ï¼Œä¼˜åŒ–çŠ¶æ€æ¼”åŒ–ã€å¯è§æ€§åˆ¤æ–­å’Œå†²çªæ£€æµ‹
  - **ç›¸å…³æ–‡æ¡£**: `10-å‰æ²¿ç ”ç©¶æ–¹å‘/09-å­¦ä¹ å‹å¹¶å‘æ§åˆ¶(CCaaLF).md`

- **ESSN (2025)**: æ‰©å±•ä¸²è¡Œå®‰å…¨ç½‘ï¼Œä½¿ç”¨å·²çŸ¥å…¨åº(KTO)ç®€åŒ–ä¸²è¡ŒåŒ–æ£€æµ‹
  - **LSEMå…³è”**: ESSNçš„çº¿æ€§æ—¶é—´å¤æ‚åº¦ä¼˜åŠ¿å¯ä»¥æå‡L0å±‚MVCCçš„ä¸²è¡ŒåŒ–æ£€æµ‹æ€§èƒ½
  - **ç›¸å…³æ–‡æ¡£**: `10-å‰æ²¿ç ”ç©¶æ–¹å‘/10-æ‰©å±•ä¸²è¡Œå®‰å…¨ç½‘(ESSN).md`

**å®ç°å‚è€ƒ**:

- PostgreSQL MVCCæºç : `src/backend/access/heap/heapam_visibility.c`
- Rustæ‰€æœ‰æƒç³»ç»Ÿ: *The Rust Programming Language* Chapter 4
- Raftåè®®: Diego Ongaro's PhD Thesis (2014)

**æ‰©å±•æ–¹å‘**:

- `02-è®¾è®¡æƒè¡¡åˆ†æ/01-å¹¶å‘æ§åˆ¶å†³ç­–æ ‘.md` â†’ å¦‚ä½•é€‰æ‹©åˆé€‚çš„å±‚å’Œæœºåˆ¶
- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md` â†’ LSEMçš„å½¢å¼åŒ–éªŒè¯
- `04-åˆ†å¸ƒå¼æ‰©å±•/01-åˆ†å¸ƒå¼MVCC(Percolator).md` â†’ L0+L2çš„èåˆ
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/è®¾è®¡æ¨¡å¼åº“.md` â†’ å¯å¤ç”¨çš„è®¾è®¡æ¨¡å¼ï¼ˆè·¨å±‚åº”ç”¨ï¼‰
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/æ¡ˆä¾‹å¯¹æ¯”åˆ†æ.md` â†’ ç³»ç»ŸåŒ–åœºæ™¯é€‰æ‹©æŒ‡å—
- `06-æ€§èƒ½åˆ†æ/04-é‡åŒ–å¯¹æ¯”å®éªŒ.md` â†’ æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–æŒ‡å—

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 LSEMç»Ÿä¸€æ¡†æ¶å®ç°

```python
from abc import ABC, abstractmethod
from typing import TypeVar, Generic, List, Optional
from dataclasses import dataclass
from enum import Enum

T = TypeVar('T')  # çŠ¶æ€ç±»å‹
TS = TypeVar('TS')  # æ—¶é—´æˆ³ç±»å‹

class Layer(Enum):
    L0 = "å­˜å‚¨å±‚"
    L1 = "è¿è¡Œæ—¶å±‚"
    L2 = "åˆ†å¸ƒå¼å±‚"

@dataclass
class State(Generic[T]):
    """çŠ¶æ€æŠ½è±¡"""
    layer: Layer
    data: T
    timestamp: Optional[TS] = None

@dataclass
class Snapshot(Generic[TS]):
    """å¿«ç…§æŠ½è±¡"""
    layer: Layer
    timestamp: TS
    active_set: List[TS]  # æ´»è·ƒäº‹åŠ¡/çº¿ç¨‹/èŠ‚ç‚¹é›†åˆ

class VisibilityPredicate(ABC, Generic[T, TS]):
    """å¯è§æ€§è°“è¯æ¥å£"""

    @abstractmethod
    def is_visible(self, state: State[T], snapshot: Snapshot[TS], observer: TS) -> bool:
        """åˆ¤æ–­çŠ¶æ€æ˜¯å¦å¯¹è§‚å¯Ÿè€…å¯è§"""
        pass

class ConflictDetector(ABC, Generic[T]):
    """å†²çªæ£€æµ‹æ¥å£"""

    @abstractmethod
    def has_conflict(self, event1: T, event2: T) -> bool:
        """æ£€æµ‹ä¸¤ä¸ªäº‹ä»¶æ˜¯å¦å†²çª"""
        pass

class LSEMFramework(Generic[T, TS]):
    """LSEMç»Ÿä¸€æ¡†æ¶"""

    def __init__(
        self,
        layer: Layer,
        visibility: VisibilityPredicate[T, TS],
        conflict: ConflictDetector[T]
    ):
        self.layer = layer
        self.visibility = visibility
        self.conflict = conflict
        self.states: List[State[T]] = []
        self.snapshots: List[Snapshot[TS]] = []

    def create_snapshot(self, timestamp: TS, active_set: List[TS]) -> Snapshot[TS]:
        """åˆ›å»ºå¿«ç…§"""
        snapshot = Snapshot(
            layer=self.layer,
            timestamp=timestamp,
            active_set=active_set
        )
        self.snapshots.append(snapshot)
        return snapshot

    def add_state(self, state: State[T]):
        """æ·»åŠ çŠ¶æ€"""
        self.states.append(state)

    def check_visibility(self, state: State[T], snapshot: Snapshot[TS], observer: TS) -> bool:
        """æ£€æŸ¥å¯è§æ€§"""
        return self.visibility.is_visible(state, snapshot, observer)

    def detect_conflict(self, event1: T, event2: T) -> bool:
        """æ£€æµ‹å†²çª"""
        return self.conflict.has_conflict(event1, event2)
```

### 11.2 L0å±‚å®ç° (PostgreSQL MVCC)

```python
from typing import List, Set

@dataclass
class TupleState:
    """L0å±‚çŠ¶æ€: PostgreSQLå…ƒç»„"""
    xmin: int  # åˆ›å»ºäº‹åŠ¡ID
    xmax: int  # åˆ é™¤äº‹åŠ¡ID
    data: str
    ctid: tuple  # (page, offset)

class L0Visibility(VisibilityPredicate[TupleState, int]):
    """L0å±‚å¯è§æ€§åˆ¤æ–­"""

    def is_visible(
        self,
        state: State[TupleState],
        snapshot: Snapshot[int],
        observer: int  # å½“å‰äº‹åŠ¡ID
    ) -> bool:
        tuple_state = state.data

        # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬
        if tuple_state.xmin == observer:
            if tuple_state.xmax == 0:
                return True
            if tuple_state.xmax == observer:
                return False
            return True  # åˆ é™¤äº‹åŠ¡æœªæäº¤

        # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤
        if tuple_state.xmin in snapshot.active_set:
            return False

        # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§å
        if tuple_state.xmin >= snapshot.timestamp:
            return False

        # è§„åˆ™4: æ£€æŸ¥åˆ é™¤æ ‡è®°
        if tuple_state.xmax != 0:
            if tuple_state.xmax == observer:
                return False
            if tuple_state.xmax not in snapshot.active_set and tuple_state.xmax < snapshot.timestamp:
                return False

        return True

class L0Conflict(ConflictDetector[TupleState]):
    """L0å±‚å†²çªæ£€æµ‹"""

    def has_conflict(self, event1: TupleState, event2: TupleState) -> bool:
        # å†™-å†™å†²çª: åŒä¸€è¡Œè¢«ä¸¤ä¸ªäº‹åŠ¡ä¿®æ”¹
        if event1.ctid == event2.ctid:
            if event1.xmin != event2.xmin:
                return True
        return False

# ä½¿ç”¨ç¤ºä¾‹
l0_framework = LSEMFramework(
    layer=Layer.L0,
    visibility=L0Visibility(),
    conflict=L0Conflict()
)

# åˆ›å»ºå¿«ç…§
snapshot = l0_framework.create_snapshot(
    timestamp=110,
    active_set=[102, 105, 108]
)

# æ·»åŠ çŠ¶æ€
tuple_state = State(
    layer=Layer.L0,
    data=TupleState(xmin=100, xmax=0, data="Alice", ctid=(1, 5)),
    timestamp=100
)
l0_framework.add_state(tuple_state)

# æ£€æŸ¥å¯è§æ€§
is_visible = l0_framework.check_visibility(tuple_state, snapshot, observer=109)
print(f"Tuple visible: {is_visible}")  # True (100 < 110, 100 not in [102,105,108])
```

### 11.3 L1å±‚å®ç° (Rustæ‰€æœ‰æƒ)

```rust
use std::sync::{Arc, Mutex};
use std::marker::PhantomData;

#[derive(Clone)]
struct MemState<T> {
    value: T,
    lifetime: Lifetime,
}

#[derive(Clone, Copy, PartialOrd, PartialEq)]
struct Lifetime {
    start: u64,
    end: u64,
}

struct L1Visibility;

impl<T> VisibilityPredicate<MemState<T>, Lifetime> for L1Visibility {
    fn is_visible(
        &self,
        state: &State<MemState<T>>,
        snapshot: &Snapshot<Lifetime>,
        observer: &Lifetime,
    ) -> bool {
        // Rustå€Ÿç”¨æ£€æŸ¥å™¨è§„åˆ™:
        // 1. ç”Ÿå‘½å‘¨æœŸå¿…é¡»æœ‰æ•ˆ
        // 2. ä¸å­˜åœ¨å¯å˜å€Ÿç”¨å†²çª

        let mem_state = &state.data;

        // æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸé‡å 
        lifetime_overlaps(&mem_state.lifetime, observer) &&
        // æ£€æŸ¥å€Ÿç”¨è§„åˆ™ï¼ˆç¼–è¯‘æœŸä¿è¯ï¼‰
        !has_borrow_conflict(state, snapshot)
    }
}

fn lifetime_overlaps(l1: &Lifetime, l2: &Lifetime) -> bool {
    l1.start < l2.end && l2.start < l1.end
}

fn has_borrow_conflict<T>(
    state: &State<MemState<T>>,
    snapshot: &Snapshot<Lifetime>,
) -> bool {
    // ç®€åŒ–: æ£€æŸ¥æ˜¯å¦æœ‰å¯å˜å€Ÿç”¨
    // å®é™…ç”±Rustç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸæ£€æŸ¥
    false
}

// ä½¿ç”¨ç¤ºä¾‹
let l1_framework = LSEMFramework::new(
    Layer::L1,
    L1Visibility,
    L1Conflict,
);

let mem_state = State {
    layer: Layer::L1,
    data: MemState {
        value: 42,
        lifetime: Lifetime { start: 0, end: 100 },
    },
    timestamp: Some(Lifetime { start: 0, end: 100 }),
};

let snapshot = l1_framework.create_snapshot(
    Lifetime { start: 0, end: 100 },
    vec![],  // æ— æ´»è·ƒå€Ÿç”¨
);

let is_visible = l1_framework.check_visibility(
    &mem_state,
    &snapshot,
    &Lifetime { start: 50, end: 150 },
);
```

### 11.4 L2å±‚å®ç° (Raftå…±è¯†)

```python
from dataclasses import dataclass
from typing import List, Optional

@dataclass
class LogEntry:
    """L2å±‚çŠ¶æ€: Raftæ—¥å¿—æ¡ç›®"""
    index: int
    term: int
    command: str
    committed: bool

class L2Visibility(VisibilityPredicate[LogEntry, int]):
    """L2å±‚å¯è§æ€§åˆ¤æ–­ (Raft)"""

    def is_visible(
        self,
        state: State[LogEntry],
        snapshot: Snapshot[int],  # commit_index
        observer: int  # èŠ‚ç‚¹ID
    ) -> bool:
        log_entry = state.data

        # Raftè§„åˆ™: å·²æäº¤çš„æ—¥å¿—å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯è§
        if log_entry.index <= snapshot.timestamp:  # commit_index
            return True

        # æœªæäº¤çš„æ—¥å¿—ä»…å¯¹Leaderå¯è§
        return observer == self.current_leader_id

    def __init__(self, current_leader_id: int):
        self.current_leader_id = current_leader_id

class L2Conflict(ConflictDetector[LogEntry]):
    """L2å±‚å†²çªæ£€æµ‹"""

    def has_conflict(self, event1: LogEntry, event2: LogEntry) -> bool:
        # åŒä¸€ç´¢å¼•ä½ç½®çš„ä¸åŒæ—¥å¿—æ¡ç›®å†²çª
        if event1.index == event2.index:
            if event1.term != event2.term:
                return True  # ä¸åŒtermçš„æ—¥å¿—å†²çª
        return False

# ä½¿ç”¨ç¤ºä¾‹
l2_framework = LSEMFramework(
    layer=Layer.L2,
    visibility=L2Visibility(current_leader_id=1),
    conflict=L2Conflict()
)

# åˆ›å»ºå¿«ç…§ (commit_index=5)
snapshot = l2_framework.create_snapshot(
    timestamp=5,  # commit_index
    active_set=[1, 2, 3]  # æ´»è·ƒèŠ‚ç‚¹
)

# æ·»åŠ æ—¥å¿—æ¡ç›®
log_entry = State(
    layer=Layer.L2,
    data=LogEntry(index=3, term=2, command="SET x=10", committed=True),
    timestamp=3
)
l2_framework.add_state(log_entry)

# æ£€æŸ¥å¯è§æ€§
is_visible = l2_framework.check_visibility(log_entry, snapshot, observer=2)
print(f"Log entry visible: {is_visible}")  # True (3 <= 5)
```

### 11.5 è·¨å±‚æ˜ å°„å·¥å…·

```python
class CrossLayerMapper:
    """è·¨å±‚æ˜ å°„å·¥å…·"""

    @staticmethod
    def map_l0_to_l1(txid: int) -> Lifetime:
        """å°†L0äº‹åŠ¡IDæ˜ å°„åˆ°L1ç”Ÿå‘½å‘¨æœŸ"""
        return Lifetime(start=txid, end=txid + 1000)

    @staticmethod
    def map_l1_to_l2(lifetime: Lifetime) -> int:
        """å°†L1ç”Ÿå‘½å‘¨æœŸæ˜ å°„åˆ°L2æ—¥å¿—ç´¢å¼•"""
        return lifetime.start // 1000

    @staticmethod
    def unify_snapshot(
        l0_snapshot: Snapshot[int],
        l1_snapshot: Snapshot[Lifetime],
        l2_snapshot: Snapshot[int]
    ) -> dict:
        """ç»Ÿä¸€ä¸‰å±‚å¿«ç…§"""
        return {
            'l0': {
                'xmax': l0_snapshot.timestamp,
                'xip': l0_snapshot.active_set
            },
            'l1': {
                'epoch': l1_snapshot.timestamp,
                'active_threads': l1_snapshot.active_set
            },
            'l2': {
                'commit_index': l2_snapshot.timestamp,
                'active_nodes': l2_snapshot.active_set
            }
        }

# ä½¿ç”¨ç¤ºä¾‹
mapper = CrossLayerMapper()

# è·¨å±‚æŸ¥è¯¢
def query_across_layers(key: str):
    # L0: æ•°æ®åº“æŸ¥è¯¢
    l0_result = l0_framework.query(key)

    # L1: å†…å­˜ç¼“å­˜
    l1_result = l1_framework.get_from_cache(key)

    # L2: åˆ†å¸ƒå¼çŠ¶æ€
    l2_result = l2_framework.get_from_consensus(key)

    # ç»Ÿä¸€ç»“æœ
    return {
        'storage': l0_result,
        'cache': l1_result,
        'distributed': l2_result
    }
```

---

## åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 12.1 æ¡ˆä¾‹: ä¸‰å±‚ååŒçš„è½¬è´¦ç³»ç»Ÿ

**æ¶æ„**: PostgreSQL (L0) + RustæœåŠ¡ (L1) + Raftåè°ƒ (L2)

```rust
use tokio_postgres::Client;
use std::sync::Arc;

struct TransferService {
    db: Arc<Client>,  // L0: PostgreSQL
    cache: Arc<Mutex<HashMap<String, i64>>>,  // L1: å†…å­˜ç¼“å­˜
    raft: Arc<RaftNode>,  // L2: Raftå…±è¯†
}

impl TransferService {
    async fn transfer(
        &self,
        from: String,
        to: String,
        amount: i64,
    ) -> Result<(), TransferError> {
        // L2: å…¨å±€åè°ƒï¼ˆåˆ†é…äº‹åŠ¡IDï¼‰
        let global_tx_id = self.raft.propose(format!("TRANSFER {} {} {}", from, to, amount)).await?;

        // L1: æœ¬åœ°ç¼“å­˜é¢„çƒ­
        let from_balance = self.cache.lock().unwrap().get(&from).copied();

        // L0: æ•°æ®åº“äº‹åŠ¡
        let mut tx = self.db.transaction().await?;

        // æ‰£æ¬¾
        tx.execute(
            "UPDATE accounts SET balance = balance - $1 WHERE id = $2",
            &[&amount, &from]
        ).await?;

        // å…¥è´¦
        tx.execute(
            "UPDATE accounts SET balance = balance + $1 WHERE id = $2",
            &[&amount, &to]
        ).await?;

        // L0: æäº¤
        tx.commit().await?;

        // L1: æ›´æ–°ç¼“å­˜
        self.cache.lock().unwrap().insert(from.clone(), from_balance.unwrap_or(0) - amount);
        self.cache.lock().unwrap().insert(to.clone(), from_balance.unwrap_or(0) + amount);

        // L2: ç¡®è®¤æäº¤
        self.raft.confirm_commit(global_tx_id).await?;

        Ok(())
    }
}
```

**LSEMåˆ†æ**:

- **L0**: PostgreSQL MVCCä¿è¯äº‹åŠ¡éš”ç¦»
- **L1**: Rustæ‰€æœ‰æƒä¿è¯çº¿ç¨‹å®‰å…¨
- **L2**: Raftä¿è¯åˆ†å¸ƒå¼ä¸€è‡´æ€§

### 12.2 æ¡ˆä¾‹: è·¨å±‚æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**: é«˜å¹¶å‘æŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ

**LSEMè¯Šæ–­**:

```python
class PerformanceProfiler:
    """è·¨å±‚æ€§èƒ½åˆ†æå™¨"""

    def profile_query(self, query: str) -> dict:
        """åˆ†ææŸ¥è¯¢åœ¨å„å±‚çš„è€—æ—¶"""
        profile = {
            'l0': 0,  # PostgreSQLæŸ¥è¯¢æ—¶é—´
            'l1': 0,  # åº”ç”¨å±‚å¤„ç†æ—¶é—´
            'l2': 0,  # åˆ†å¸ƒå¼åè°ƒæ—¶é—´
        }

        # L2: åˆ†å¸ƒå¼åè°ƒ
        start = time.time()
        global_snapshot = self.raft.get_commit_index()
        profile['l2'] = time.time() - start

        # L1: ç¼“å­˜æ£€æŸ¥
        start = time.time()
        cached = self.cache.get(query)
        profile['l1'] = time.time() - start

        if cached:
            return profile

        # L0: æ•°æ®åº“æŸ¥è¯¢
        start = time.time()
        result = self.db.execute(query)
        profile['l0'] = time.time() - start

        return profile

# ä½¿ç”¨
profiler = PerformanceProfiler()
profile = profiler.profile_query("SELECT * FROM orders WHERE user_id = 123")

# è¾“å‡º:
# {'l2': 0.001, 'l1': 0.0001, 'l0': 0.05}
# ç“¶é¢ˆåœ¨L0å±‚ â†’ ä¼˜åŒ–ç´¢å¼•æˆ–æ·»åŠ ç¼“å­˜
```

---

## åäºŒã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: è·¨å±‚é”è¯­ä¹‰æ··æ·†

**é”™è¯¯è®¾è®¡**:

```rust
// é”™è¯¯: ç”¨L1çš„Mutexé”L0çš„æ•°æ®åº“è¡Œ
let mutex = Arc::new(Mutex::new(()));

async fn update_account(db: &Client, id: i32, amount: i64) {
    let _lock = mutex.lock().unwrap();  // L1é”

    // é—®é¢˜: L1é”æ— æ³•é˜²æ­¢å…¶ä»–è¿›ç¨‹è®¿é—®L0æ•°æ®åº“
    db.execute(
        "UPDATE accounts SET balance = balance + $1 WHERE id = $2",
        &[&amount, &id]
    ).await?;
}
```

**é—®é¢˜**: L1å±‚çš„Mutexåªèƒ½ä¿æŠ¤åŒä¸€è¿›ç¨‹å†…çš„å¹¶å‘ï¼Œæ— æ³•é˜²æ­¢å…¶ä»–è¿›ç¨‹/èŠ‚ç‚¹è®¿é—®æ•°æ®åº“

**æ­£ç¡®è®¾è®¡**:

```rust
// æ­£ç¡®: åœ¨L0å±‚ä½¿ç”¨æ•°æ®åº“é”
async fn update_account(db: &Client, id: i32, amount: i64) {
    let mut tx = db.transaction().await?;

    // L0å±‚é”: FOR UPDATE
    tx.execute(
        "SELECT * FROM accounts WHERE id = $1 FOR UPDATE",
        &[&id]
    ).await?;

    tx.execute(
        "UPDATE accounts SET balance = balance + $1 WHERE id = $2",
        &[&amount, &id]
    ).await?;

    tx.commit().await?;
}
```

### åä¾‹2: å¿½ç•¥å±‚é—´æ—¶é—´æˆ³åŒæ­¥

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: L0å’ŒL2ä½¿ç”¨ä¸åŒçš„æ—¶é—´æˆ³ç³»ç»Ÿ
l0_txid = postgresql.get_next_xid()  # L0: æœ¬åœ°äº‹åŠ¡ID
l2_timestamp = raft.get_commit_index()  # L2: æ—¥å¿—ç´¢å¼•

# é—®é¢˜: æ— æ³•å»ºç«‹è·¨å±‚å¯è§æ€§å…³ç³»
if l0_txid < l2_timestamp:  # é”™è¯¯æ¯”è¾ƒï¼
    pass
```

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: ç»Ÿä¸€æ—¶é—´æˆ³ç³»ç»Ÿ
class UnifiedTimestamp:
    """ç»Ÿä¸€æ—¶é—´æˆ³ (HLCé£æ ¼)"""
    def __init__(self):
        self.physical_time = time.time()
        self.logical_counter = 0
        self.node_id = 1

    def get_timestamp(self) -> tuple:
        """è¿”å› (physical, logical, node)"""
        return (self.physical_time, self.logical_counter, self.node_id)

    def compare(self, ts1: tuple, ts2: tuple) -> int:
        """æ¯”è¾ƒæ—¶é—´æˆ³: -1(ts1<ts2), 0(ç›¸ç­‰), 1(ts1>ts2)"""
        if ts1[0] < ts2[0]:
            return -1
        if ts1[0] > ts2[0]:
            return 1
        if ts1[1] < ts2[1]:
            return -1
        if ts1[1] > ts2[1]:
            return 1
        return 0

# ä½¿ç”¨ç»Ÿä¸€æ—¶é—´æˆ³
timestamp_service = UnifiedTimestamp()

l0_timestamp = timestamp_service.get_timestamp()
l2_timestamp = timestamp_service.get_timestamp()

# æ­£ç¡®æ¯”è¾ƒ
if timestamp_service.compare(l0_timestamp, l2_timestamp) < 0:
    pass
```

### åä¾‹3: LSEMç†è®ºåº”ç”¨ä¸å½“

**é”™è¯¯è®¾è®¡**: LSEMç†è®ºåº”ç”¨ä¸å½“

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åº”ç”¨: LSEMç†è®º
â”œâ”€ é—®é¢˜: ä¸ç†è§£LSEMç»Ÿä¸€æ¡†æ¶ï¼Œç›²ç›®åº”ç”¨
â”œâ”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡é”™è¯¯
â””â”€ åæœ: ç³»ç»Ÿä¸å¯ç”¨ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸå¹¶å‘æ§åˆ¶ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: åœ¨å•æœºç³»ç»Ÿä½¿ç”¨L2å±‚è®¾è®¡
â”œâ”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡è¿‡åº¦å¤æ‚
â””â”€ åæœ: æ€§èƒ½å·®ï¼Œç»´æŠ¤å›°éš¾ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: æ·±å…¥ç†è§£LSEMç†è®º
â”œâ”€ å®ç°: æ ¹æ®ç³»ç»Ÿç±»å‹é€‰æ‹©åˆé€‚çš„å±‚
â””â”€ ç»“æœ: ç³»ç»Ÿè®¾è®¡åˆç†ï¼Œæ€§èƒ½æ»¡è¶³éœ€æ±‚ âœ“
```

### åä¾‹4: è·¨å±‚æ˜ å°„å®ç°ä¸å®Œæ•´

**é”™è¯¯è®¾è®¡**: è·¨å±‚æ˜ å°„å®ç°ä¸å®Œæ•´

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: è·¨å±‚å¹¶å‘æ§åˆ¶ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: è·¨å±‚æ˜ å°„å®ç°ä¸å®Œæ•´
â”œâ”€ ç»“æœ: è·¨å±‚çŠ¶æ€ä¸ä¸€è‡´
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸåˆ†å¸ƒå¼ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: L0å’ŒL2æ—¶é—´æˆ³æ˜ å°„ä¸å®Œæ•´
â”œâ”€ ç»“æœ: è·¨å±‚å¯è§æ€§é”™è¯¯
â””â”€ åæœ: æ•°æ®ä¸ä¸€è‡´ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: å®Œæ•´çš„è·¨å±‚æ˜ å°„å®ç°
â”œâ”€ å®ç°: ç»Ÿä¸€æ—¶é—´æˆ³ã€çŠ¶æ€æ˜ å°„ã€å¿«ç…§ä¼ æ’­
â””â”€ ç»“æœ: è·¨å±‚çŠ¶æ€ä¸€è‡´ï¼Œæ•°æ®ä¸€è‡´ âœ“
```

### åä¾‹5: LSEMæ€§èƒ½ä¼˜åŒ–è¢«å¿½ç•¥

**é”™è¯¯è®¾è®¡**: LSEMæ€§èƒ½ä¼˜åŒ–è¢«å¿½ç•¥

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: å¹¶å‘æ§åˆ¶ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: LSEMæ€§èƒ½ä¼˜åŒ–è¢«å¿½ç•¥
â”œâ”€ ç»“æœ: æ€§èƒ½å·®
â””â”€ æ€§èƒ½: æ€§èƒ½å·® âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸç³»ç»Ÿä½¿ç”¨LSEMæ¡†æ¶
â”œâ”€ é—®é¢˜: æœªè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå±‚
â”œâ”€ ç»“æœ: æ€§èƒ½ä¼˜åŒ–æ–¹å‘é”™è¯¯
â””â”€ åæœ: æ€§èƒ½å·® âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: LSEMæ€§èƒ½ä¼˜åŒ–
â”œâ”€ å®ç°: è·¨å±‚æ€§èƒ½åˆ†æã€è¯†åˆ«ç“¶é¢ˆå±‚ã€é’ˆå¯¹æ€§ä¼˜åŒ–
â””â”€ ç»“æœ: æ€§èƒ½æ»¡è¶³éœ€æ±‚ âœ“
```

### åä¾‹6: LSEMç³»ç»Ÿç›‘æ§ä¸è¶³

**é”™è¯¯è®¾è®¡**: LSEMç³»ç»Ÿç›‘æ§ä¸è¶³

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ ç³»ç»Ÿ: å¹¶å‘æ§åˆ¶ç³»ç»Ÿ
â”œâ”€ é—®é¢˜: ç›‘æ§ä¸è¶³
â”œâ”€ ç»“æœ: é—®é¢˜æœªè¢«å‘ç°
â””â”€ åæœ: ç³»ç»Ÿé—®é¢˜æŒç»­ âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: æŸç³»ç»Ÿä½¿ç”¨LSEMæ¡†æ¶
â”œâ”€ é—®é¢˜: æœªç›‘æ§è·¨å±‚çŠ¶æ€
â”œâ”€ ç»“æœ: è·¨å±‚çŠ¶æ€ä¸ä¸€è‡´æœªè¢«å‘ç°
â””â”€ åæœ: ç³»ç»Ÿé—®é¢˜æŒç»­ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: å®Œæ•´çš„ç›‘æ§ä½“ç³»
â”œâ”€ å®ç°: ç›‘æ§å„å±‚çŠ¶æ€ã€è·¨å±‚æ˜ å°„ã€æ€§èƒ½æŒ‡æ ‡
â””â”€ ç»“æœ: åŠæ—¶å‘ç°é—®é¢˜ âœ“
```

---

## åä¸‰ã€LSEMå¯è§†åŒ–

### 13.1 LSEMä¸‰å±‚æ¶æ„å›¾

**å®Œæ•´LSEMä¸‰å±‚æ¶æ„** (Mermaid):

```mermaid
graph TB
    subgraph "L2: åˆ†å¸ƒå¼å±‚"
        L2_N1[èŠ‚ç‚¹1<br/>Raft Leader]
        L2_N2[èŠ‚ç‚¹2<br/>Raft Follower]
        L2_N3[èŠ‚ç‚¹3<br/>Raft Follower]
        L2_TS[å…¨å±€æ—¶é—´æˆ³<br/>HLC/TrueTime]
    end

    subgraph "L1: è¿è¡Œæ—¶å±‚"
        L1_T1[çº¿ç¨‹1<br/>Rustæ‰€æœ‰æƒ]
        L1_T2[çº¿ç¨‹2<br/>Rustæ‰€æœ‰æƒ]
        L1_ARC[Arc<Mutex<T>>]
        L1_TS[é€»è¾‘æ—¶é’Ÿ<br/>Lamport Clock]
    end

    subgraph "L0: å­˜å‚¨å¼•æ“å±‚"
        L0_TXN1[äº‹åŠ¡T1<br/>PostgreSQL MVCC]
        L0_TXN2[äº‹åŠ¡T2<br/>PostgreSQL MVCC]
        L0_HEAP[å †è¡¨<br/>ç‰ˆæœ¬é“¾]
        L0_TS[äº‹åŠ¡ID<br/>TransactionId]
    end

    L2_N1 --> L2_TS
    L2_N2 --> L2_TS
    L2_N3 --> L2_TS

    L1_T1 --> L1_ARC
    L1_T2 --> L1_ARC
    L1_T1 --> L1_TS
    L1_T2 --> L1_TS

    L0_TXN1 --> L0_HEAP
    L0_TXN2 --> L0_HEAP
    L0_TXN1 --> L0_TS
    L0_TXN2 --> L0_TS

    L2_TS -.->|æ—¶é—´æˆ³æ˜ å°„| L1_TS
    L1_TS -.->|æ—¶é—´æˆ³æ˜ å°„| L0_TS
```

**LSEMç»Ÿä¸€æ¡†æ¶å±‚æ¬¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: åˆ†å¸ƒå¼å±‚                            â”‚
â”‚  â”œâ”€ èŠ‚ç‚¹çŠ¶æ€ (Raft Leader/Follower)      â”‚
â”‚  â”œâ”€ å…¨å±€æ—¶é—´æˆ³ (HLC/TrueTime)            â”‚
â”‚  â””â”€ å…±è¯†åè®® (Raft/Paxos)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â”‚ æ—¶é—´æˆ³æ˜ å°„         â”‚ çŠ¶æ€æ˜ å°„
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: è¿è¡Œæ—¶å±‚ â”‚  â”‚  L1: è¿è¡Œæ—¶å±‚    â”‚
â”‚  çº¿ç¨‹çŠ¶æ€     â”‚  â”‚  å†…å­˜æ‰€æœ‰æƒ      â”‚
â”‚  é€»è¾‘æ—¶é’Ÿ     â”‚  â”‚  å¹¶å‘åŸè¯­        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ—¶é—´æˆ³æ˜ å°„
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: å­˜å‚¨å±‚  â”‚
â”‚  äº‹åŠ¡çŠ¶æ€     â”‚
â”‚  ç‰ˆæœ¬é“¾       â”‚
â”‚  äº‹åŠ¡ID       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 è·¨å±‚æ˜ å°„å…³ç³»å›¾

**LSEMè·¨å±‚æ˜ å°„å…³ç³»** (Mermaid):

```mermaid
graph LR
    subgraph "L0: å­˜å‚¨å±‚"
        L0_MVCC[MVCC<br/>ç‰ˆæœ¬é“¾]
        L0_TXID[äº‹åŠ¡ID<br/>xid]
        L0_SNAP[å¿«ç…§<br/>Snapshot]
    end

    subgraph "L1: è¿è¡Œæ—¶å±‚"
        L1_OWN[æ‰€æœ‰æƒ<br/>Ownership]
        L1_BOR[å€Ÿç”¨<br/>Borrow]
        L1_ARC[Arc<Mutex>]
    end

    subgraph "L2: åˆ†å¸ƒå¼å±‚"
        L2_RAFT[Raft<br/>å…±è¯†]
        L2_HLC[HLC<br/>æ··åˆé€»è¾‘æ—¶é’Ÿ]
        L2_LOG[æ—¥å¿—<br/>Log]
    end

    L0_MVCC -.->|åŒæ„| L1_OWN
    L0_TXID -.->|æ˜ å°„| L1_BOR
    L0_SNAP -.->|æ˜ å°„| L1_ARC

    L1_OWN -.->|åŒæ„| L2_RAFT
    L1_BOR -.->|æ˜ å°„| L2_HLC
    L1_ARC -.->|æ˜ å°„| L2_LOG

    style L0_MVCC fill:#ffcccc
    style L1_OWN fill:#ccffcc
    style L2_RAFT fill:#ccccff
```

**è·¨å±‚æ¦‚å¿µæ˜ å°„çŸ©é˜µ**:

| L0 (å­˜å‚¨å±‚) | L1 (è¿è¡Œæ—¶å±‚) | L2 (åˆ†å¸ƒå¼å±‚) | æ ¸å¿ƒæ¦‚å¿µ |
|-----------|-------------|-------------|---------|
| **ç‰ˆæœ¬é“¾** | æ‰€æœ‰æƒè½¬ç§» | æ—¥å¿—å¤åˆ¶ | çŠ¶æ€æ¼”åŒ– |
| **äº‹åŠ¡ID** | ç”Ÿå‘½å‘¨æœŸ | é€»è¾‘æ—¶é’Ÿ | æ—¶é—´æˆ³ |
| **å¿«ç…§** | ä¸å¯å˜å¼•ç”¨ | ä¸€è‡´æ€§è§†å›¾ | å¯è§æ€§ |
| **å†²çªæ£€æµ‹** | å€Ÿç”¨æ£€æŸ¥ | å…±è¯†åè®® | ä»²è£æœºåˆ¶ |

### 13.3 LSEMåº”ç”¨å†³ç­–æ ‘

**LSEMå±‚é€‰æ‹©å†³ç­–æ ‘**:

```text
                é€‰æ‹©LSEMå±‚
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ç³»ç»Ÿç±»å‹åˆ†æ         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
   å•æœºç³»ç»Ÿ        å¤šçº¿ç¨‹ç³»ç»Ÿ      åˆ†å¸ƒå¼ç³»ç»Ÿ
   (å•è¿›ç¨‹)        (å¤šè¿›ç¨‹)        (å¤šèŠ‚ç‚¹)
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
    L0å±‚            L1å±‚            L2å±‚
  (å­˜å‚¨å±‚)        (è¿è¡Œæ—¶å±‚)      (åˆ†å¸ƒå¼å±‚)
      â”‚               â”‚               â”‚
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
  PostgreSQL      Rustæ‰€æœ‰æƒ      Raftå…±è¯†
  MVCC           å¹¶å‘åŸè¯­         åˆ†å¸ƒå¼åè®®
```

**LSEMè·¨å±‚ååŒå†³ç­–æ ‘**:

```text
                æ˜¯å¦éœ€è¦è·¨å±‚ååŒ?
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ç³»ç»Ÿå¤æ‚åº¦åˆ†æ       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚
   ç®€å•ç³»ç»Ÿ        ä¸­ç­‰ç³»ç»Ÿ        å¤æ‚ç³»ç»Ÿ
   (å•å±‚)          (ä¸¤å±‚)          (ä¸‰å±‚)
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
   å•å±‚å®ç°        L0+L1          L0+L1+L2
  (PostgreSQL)    (PostgreSQL    (åˆ†å¸ƒå¼
                  + Rust)         PostgreSQL)
      â”‚               â”‚               â”‚
      â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼
   æ— éœ€æ˜ å°„        æ—¶é—´æˆ³æ˜ å°„      å®Œæ•´æ˜ å°„
                 çŠ¶æ€æ˜ å°„          è·¨å±‚ååŒ
```

**LSEMå®ç°å¯¹æ¯”çŸ©é˜µ**:

| å®ç°å±‚æ¬¡ | å…¸å‹ç³»ç»Ÿ | æ—¶é—´æˆ³ç³»ç»Ÿ | çŠ¶æ€ç®¡ç† | å†²çªå¤„ç† | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------|---------|---------|---------|
| **L0** | PostgreSQL | TransactionId | ç‰ˆæœ¬é“¾ | MVCC | å•æœºæ•°æ®åº“ |
| **L1** | Rust | ç”Ÿå‘½å‘¨æœŸ | æ‰€æœ‰æƒ | å€Ÿç”¨æ£€æŸ¥ | å†…å­˜å®‰å…¨ |
| **L2** | Raft | HLC | æ—¥å¿—å¤åˆ¶ | å…±è¯†åè®® | åˆ†å¸ƒå¼ç³»ç»Ÿ |
| **L0+L1** | PostgreSQL + Rust | ç»Ÿä¸€æ—¶é—´æˆ³ | è·¨å±‚çŠ¶æ€ | æ··åˆæœºåˆ¶ | æ•°æ®åº“+åº”ç”¨ |
| **L0+L1+L2** | åˆ†å¸ƒå¼PostgreSQL | å…¨å±€æ—¶é—´æˆ³ | ä¸‰å±‚çŠ¶æ€ | å®Œæ•´æ˜ å°„ | åˆ†å¸ƒå¼æ•°æ®åº“ |

---

**ç‰ˆæœ¬**: 2.1.0ï¼ˆæœ€æ–°ç ”ç©¶å…³è”ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**:

- å®Œæ•´Python/Rustå®ç°ã€è·¨å±‚æ˜ å°„å·¥å…·ã€å®é™…åº”ç”¨æ¡ˆä¾‹ã€åä¾‹åˆ†æ
- LSEMå¯è§†åŒ–ï¼ˆLSEMä¸‰å±‚æ¶æ„å›¾ã€è·¨å±‚æ˜ å°„å…³ç³»å›¾ã€LSEMåº”ç”¨å†³ç­–æ ‘ï¼‰
- ç†è®ºåŸºç¡€ç« èŠ‚ï¼ˆæƒå¨æ–‡çŒ®å¼•ç”¨ï¼‰
- ä¸æœ€æ–°ç ”ç©¶çš„å…³è”ï¼ˆCCaaLFã€ESSNï¼‰

**å…³è”æ–‡æ¡£**:

- `00-ç†è®ºæ¡†æ¶æ€»è§ˆ/00-ç†è®ºä½“ç³»å…¨æ™¯å›¾.md` - ç†è®ºä½“ç³»æ€»è§ˆ
- `00-ç†è®ºæ¡†æ¶æ€»è§ˆ/01-æ ¸å¿ƒæ¦‚å¿µè¯å…¸.md` - æ ¸å¿ƒæ¦‚å¿µå®šä¹‰
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md` - L0å±‚å®ç°
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/06-æ‰€æœ‰æƒæ¨¡å‹(Rust).md` - L1å±‚å®ç°
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/08-å…±è¯†åè®®ç†è®º.md` - L2å±‚å®ç°
- `09-å·¥ä¸šæ¡ˆä¾‹åº“/è®¾è®¡æ¨¡å¼åº“.md` - å¯å¤ç”¨è®¾è®¡æ¨¡å¼
- `10-å‰æ²¿ç ”ç©¶æ–¹å‘/09-å­¦ä¹ å‹å¹¶å‘æ§åˆ¶(CCaaLF).md` - å­¦ä¹ å‹å¹¶å‘æ§åˆ¶
- `10-å‰æ²¿ç ”ç©¶æ–¹å‘/10-æ‰©å±•ä¸²è¡Œå®‰å…¨ç½‘(ESSN).md` - æ‰©å±•ä¸²è¡Œå®‰å…¨ç½‘
- `06-æ€§èƒ½åˆ†æ/04-é‡åŒ–å¯¹æ¯”å®éªŒ.md` - æ€§èƒ½åŸºå‡†æµ‹è¯•
