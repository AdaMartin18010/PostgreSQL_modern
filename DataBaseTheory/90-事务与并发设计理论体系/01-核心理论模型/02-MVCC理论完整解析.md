# 02 | MVCCç†è®ºå®Œæ•´è§£æ

> **ç†è®ºå®šä½**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ˜¯PostgreSQLå¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒæœºåˆ¶ï¼Œæœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„æ•°å­¦è¯æ˜å’Œå·¥ç¨‹å®ç°åˆ†æã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | MVCCç†è®ºå®Œæ•´è§£æ](#02--mvccç†è®ºå®Œæ•´è§£æ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€ç†è®ºåŸºç¡€ä¸åŠ¨æœº](#ä¸€ç†è®ºåŸºç¡€ä¸åŠ¨æœº)
    - [0.1 ç†è®ºåŸºç¡€](#01-ç†è®ºåŸºç¡€)
      - [0.1.1 ç»å…¸ç†è®ºæ¥æº](#011-ç»å…¸ç†è®ºæ¥æº)
      - [0.1.2 æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹](#012-æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹)
      - [0.1.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»](#013-ä¸ç»å…¸ç†è®ºçš„å…³ç³»)
    - [1.0 ä¸ºä»€ä¹ˆéœ€è¦MVCCï¼Ÿ](#10-ä¸ºä»€ä¹ˆéœ€è¦mvcc)
      - [ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹MVCCçš„å½±å“](#ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹mvccçš„å½±å“)
      - [è¯­è¨€æœºåˆ¶å¯¹MVCCå®ç°çš„å½±å“](#è¯­è¨€æœºåˆ¶å¯¹mvccå®ç°çš„å½±å“)
    - [1.1 å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨](#11-å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
  - [äºŒã€å¯è§æ€§åˆ¤æ–­ç®—æ³•](#äºŒå¯è§æ€§åˆ¤æ–­ç®—æ³•)
    - [2.1 å®Œæ•´å¯è§æ€§è§„åˆ™](#21-å®Œæ•´å¯è§æ€§è§„åˆ™)
    - [2.2 å¯è§æ€§è¯æ˜](#22-å¯è§æ€§è¯æ˜)
    - [2.3 æ—¶ç©ºå¤æ‚åº¦åˆ†æ](#23-æ—¶ç©ºå¤æ‚åº¦åˆ†æ)
  - [ä¸‰ã€æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–](#ä¸‰æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–)
    - [3.1 INSERTæ“ä½œ](#31-insertæ“ä½œ)
    - [3.2 DELETEæ“ä½œ](#32-deleteæ“ä½œ)
    - [3.3 UPDATEæ“ä½œ](#33-updateæ“ä½œ)
  - [å››ã€éš”ç¦»çº§åˆ«å®ç°](#å››éš”ç¦»çº§åˆ«å®ç°)
    - [4.1 Read Committed](#41-read-committed)
    - [4.2 Repeatable Read](#42-repeatable-read)
    - [4.3 Serializable (SSI)](#43-serializable-ssi)
  - [äº”ã€VACUUMæœºåˆ¶](#äº”vacuumæœºåˆ¶)
    - [5.1 æ­»å…ƒç»„è¯†åˆ«](#51-æ­»å…ƒç»„è¯†åˆ«)
    - [5.2 æ¸…ç†è¿‡ç¨‹](#52-æ¸…ç†è¿‡ç¨‹)
    - [5.3 Freezeæ“ä½œ](#53-freezeæ“ä½œ)
  - [å…­ã€ä¼˜åŒ–æŠ€æœ¯](#å…­ä¼˜åŒ–æŠ€æœ¯)
    - [6.1 HOT (Heap-Only Tuple)](#61-hot-heap-only-tuple)
    - [6.2 Index-Only Scan](#62-index-only-scan)
    - [6.3 Parallel VACUUM](#63-parallel-vacuum)
  - [ä¸ƒã€æ€§èƒ½åˆ†æ](#ä¸ƒæ€§èƒ½åˆ†æ)
    - [7.1 ååé‡æ¨¡å‹](#71-ååé‡æ¨¡å‹)
    - [7.2 ç©ºé—´å¼€é”€](#72-ç©ºé—´å¼€é”€)
    - [7.3 VACUUMå¼€é”€](#73-vacuumå¼€é”€)
  - [å…«ã€ä¸å…¶ä»–MVCCå®ç°å¯¹æ¯”](#å…«ä¸å…¶ä»–mvccå®ç°å¯¹æ¯”)
    - [8.1 PostgreSQL vs MySQL InnoDB](#81-postgresql-vs-mysql-innodb)
    - [8.2 Oracle MVCCå®ç°](#82-oracle-mvccå®ç°)
      - [8.2.1 Undo Logæœºåˆ¶](#821-undo-logæœºåˆ¶)
      - [8.2.2 ä¸PostgreSQLå¯¹æ¯”](#822-ä¸postgresqlå¯¹æ¯”)
      - [8.2.3 Oracle MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿](#823-oracle-mvccä¼˜åŠ¿ä¸åŠ£åŠ¿)
    - [8.3 SQL Server MVCCå®ç°](#83-sql-server-mvccå®ç°)
      - [8.3.1 Row Versioningæœºåˆ¶](#831-row-versioningæœºåˆ¶)
      - [8.3.2 ä¸PostgreSQLå¯¹æ¯”](#832-ä¸postgresqlå¯¹æ¯”)
      - [8.3.3 SQL Server MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿](#833-sql-server-mvccä¼˜åŠ¿ä¸åŠ£åŠ¿)
    - [8.4 ä¸»æµæ•°æ®åº“MVCCå®ç°ç»¼åˆå¯¹æ¯”](#84-ä¸»æµæ•°æ®åº“mvccå®ç°ç»¼åˆå¯¹æ¯”)
      - [8.4.1 å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ](#841-å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ)
      - [8.4.2 æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”](#842-æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”)
      - [8.4.3 é€‰æ‹©å»ºè®®](#843-é€‰æ‹©å»ºè®®)
    - [8.5 ç†è®ºä¼˜åŠ£æ€»ç»“](#85-ç†è®ºä¼˜åŠ£æ€»ç»“)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®å…¬å¼](#92-å…³é”®å…¬å¼)
    - [9.3 è®¾è®¡åŸåˆ™](#93-è®¾è®¡åŸåˆ™)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 MVCCå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°](#111-mvccå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°)
    - [11.2 ç‰ˆæœ¬é“¾éå†å®ç°](#112-ç‰ˆæœ¬é“¾éå†å®ç°)
    - [11.3 HOTé“¾éå†å®ç°](#113-hoté“¾éå†å®ç°)
    - [11.4 å¿«ç…§åˆ›å»ºå®ç°](#114-å¿«ç…§åˆ›å»ºå®ç°)
  - [åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åäºŒå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [12.1 æ¡ˆä¾‹: é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯](#121-æ¡ˆä¾‹-é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯)
    - [12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ](#122-æ¡ˆä¾‹-é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ)
    - [12.3 æ¡ˆä¾‹: çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–](#123-æ¡ˆä¾‹-çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–)
  - [åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åä¸‰åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸](#åä¾‹1-é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸)
    - [åä¾‹2: å¿½ç•¥HOTä¼˜åŒ–æ¡ä»¶](#åä¾‹2-å¿½ç•¥hotä¼˜åŒ–æ¡ä»¶)
    - [åä¾‹3: è¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯](#åä¾‹3-è¯¯ç”¨mvccå¤„ç†é«˜å†²çªå†™åœºæ™¯)
    - [åä¾‹4: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€](#åä¾‹4-å¿½ç•¥vacuumå¯¼è‡´å­˜å‚¨è†¨èƒ€)
    - [åä¾‹5: å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥](#åä¾‹5-å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥)
    - [åä¾‹6: ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜](#åä¾‹6-ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜)
  - [åå››ã€MVCCç†è®ºå¯è§†åŒ–](#åå››mvccç†è®ºå¯è§†åŒ–)
    - [14.1 MVCCæ¶æ„è®¾è®¡å›¾](#141-mvccæ¶æ„è®¾è®¡å›¾)
    - [14.2 ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾](#142-ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾)
    - [14.3 MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ](#143-mvccä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ)

---

## ä¸€ã€ç†è®ºåŸºç¡€ä¸åŠ¨æœº

### 0.1 ç†è®ºåŸºç¡€

æœ¬æ–‡æ¡£çš„ç†è®ºåŸºç¡€ä¸»è¦æ¥æºäºä»¥ä¸‹ç»å…¸æ–‡çŒ®ï¼š

#### 0.1.1 ç»å…¸ç†è®ºæ¥æº

1. **Bernstein, P. A., & Goodman, N. (1981)**: "Concurrency Control in Distributed Database Systems"
   - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»ŸåŒ–åœ°åˆ†æäº†48ç§å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œå°†MVCCå½’ç±»ä¸ºå¤šç‰ˆæœ¬æ—¶é—´æˆ³æ’åºæ–¹æ³•
   - **MVCCåˆ†ç±»**: åœ¨Bernstein & Goodmançš„åˆ†ç±»ä½“ç³»ä¸­ï¼ŒMVCCå±äº"å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"ç±»åˆ«
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åœ¨æ­¤åŸºç¡€ä¸Šæ·±å…¥åˆ†æPostgreSQLçš„MVCCå®ç°æœºåˆ¶

2. **Adya, A., et al. (2000)**: "Generalized Isolation Level Definitions"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¼±éš”ç¦»çº§åˆ«çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰
   - **å¿«ç…§éš”ç¦»å®šä¹‰**: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªä¸€è‡´å¿«ç…§ï¼Œè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æPostgreSQLå¦‚ä½•é€šè¿‡MVCCå®ç°å¿«ç…§éš”ç¦»

3. **Fekete, A., et al. (2005)**: "Making Snapshot Isolation Serializable"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰çš„ç†è®ºåŸºç¡€
   - **SSIæ ¸å¿ƒæ€æƒ³**: é€šè¿‡æ£€æµ‹å†™åæ–œï¼ˆWrite Skewï¼‰ç­‰å¼‚å¸¸ï¼Œä½¿å¿«ç…§éš”ç¦»è¾¾åˆ°ä¸²è¡ŒåŒ–çº§åˆ«
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åˆ†æPostgreSQL SSIçš„å®ç°ï¼ŒåŒ…æ‹¬è°“è¯é”å’Œå†²çªæ£€æµ‹æœºåˆ¶

4. **Ports, D. R., & Grittner, K. (2012)**: "Serializable Snapshot Isolation in PostgreSQL"
   - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†æè¿°äº†PostgreSQL SSIçš„å®ç°ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªç”Ÿäº§çº§SSIå®ç°
   - **å®ç°ç»†èŠ‚**: åŒ…æ‹¬è°“è¯é”ç®¡ç†å™¨ã€å†²çªæ£€æµ‹ç®—æ³•ã€å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­‰
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£ç›´æ¥å‚è€ƒæ­¤è®ºæ–‡çš„å®ç°ç»†èŠ‚ï¼Œæä¾›ä»£ç çº§åˆ†æ

5. **Gray, J., & Reuter, A. (1993)**: "Transaction Processing: Concepts and Techniques"
   - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†äº‹åŠ¡å¤„ç†çš„å®Œæ•´ç†è®ºæ¡†æ¶ï¼ŒåŒ…æ‹¬MVCCçš„å®ç°æœºåˆ¶
   - **MVCCå®ç°**: è¯¦ç»†åˆ†æäº†å¤šç‰ˆæœ¬å­˜å‚¨ã€ç‰ˆæœ¬é“¾ç®¡ç†ã€å¯è§æ€§åˆ¤æ–­ç­‰
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åœ¨æ­¤åŸºç¡€ä¸Šåˆ†æPostgreSQLçš„å…·ä½“å®ç°

#### 0.1.2 æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹

ç›¸æ¯”ç»å…¸ç†è®ºï¼Œæœ¬æ–‡æ¡£çš„é‡ç‚¹ï¼š

1. **PostgreSQLå®ç°æ·±åº¦åˆ†æ**: ä»ç†è®ºåˆ°æºç çš„å®Œæ•´æ˜ å°„
   - **ç»å…¸ç†è®º**: æä¾›ç†è®ºæ¡†æ¶å’Œç®—æ³•æè¿°
   - **æœ¬ä½“ç³»**: ç»“åˆPostgreSQLæºç ï¼Œæä¾›å¯éªŒè¯çš„å®ç°åˆ†æ

2. **æ€§èƒ½æ¨¡å‹é‡åŒ–åˆ†æ**: æä¾›é‡åŒ–çš„æ€§èƒ½åˆ†ææ¨¡å‹
   - **ç»å…¸ç†è®º**: ä¸»è¦å…³æ³¨æ­£ç¡®æ€§
   - **æœ¬ä½“ç³»**: åŒæ—¶å…³æ³¨æ€§èƒ½å’Œæ­£ç¡®æ€§çš„æƒè¡¡

3. **è·¨å±‚æ˜ å°„å…³ç³»**: å°†MVCCçº³å…¥LSEMç»Ÿä¸€æ¡†æ¶
   - **ç»å…¸ç†è®º**: MVCCä½œä¸ºç‹¬ç«‹çš„å¹¶å‘æ§åˆ¶æ–¹æ³•
   - **æœ¬ä½“ç³»**: æ­ç¤ºMVCCä¸Rustæ‰€æœ‰æƒã€åˆ†å¸ƒå¼å…±è¯†çš„åŒæ„å…³ç³»

4. **å·¥ç¨‹å®è·µç»“åˆ**: æä¾›å®é™…åº”ç”¨æ¡ˆä¾‹å’Œä¼˜åŒ–æŒ‡å—
   - **ç»å…¸ç†è®º**: åé‡ç†è®ºåˆ†æ
   - **æœ¬ä½“ç³»**: ç†è®ºåˆ†æä¸å·¥ç¨‹å®è·µå¹¶é‡

#### 0.1.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»

```text
MVCCç†è®ºä¸ç»å…¸ç†è®ºçš„å…³ç³»:
â”‚
â”œâ”€ Bernstein & Goodman (1981)
â”‚  â”œâ”€ è´¡çŒ®: å¹¶å‘æ§åˆ¶æ–¹æ³•åˆ†ç±»ï¼ŒMVCCå½’ç±»
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: ç†è§£MVCCåœ¨å¹¶å‘æ§åˆ¶æ–¹æ³•ä½“ç³»ä¸­çš„ä½ç½®
â”‚  â””â”€ æ‰©å±•: æ·±å…¥åˆ†æPostgreSQLçš„å…·ä½“å®ç°
â”‚
â”œâ”€ Adya et al. (2000)
â”‚  â”œâ”€ è´¡çŒ®: å¿«ç…§éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: PostgreSQLå¿«ç…§éš”ç¦»çš„æ­£ç¡®æ€§è¯æ˜
â”‚  â””â”€ æ‰©å±•: å®ç°ç»†èŠ‚å’Œæ€§èƒ½åˆ†æ
â”‚
â”œâ”€ Fekete et al. (2005)
â”‚  â”œâ”€ è´¡çŒ®: SSIç†è®ºåŸºç¡€å’Œç®—æ³•
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: PostgreSQL SSIå®ç°çš„ç®—æ³•åˆ†æ
â”‚  â””â”€ æ‰©å±•: æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹å®è·µ
â”‚
â”œâ”€ Ports & Grittner (2012)
â”‚  â”œâ”€ è´¡çŒ®: PostgreSQL SSIå®ç°ç»†èŠ‚
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: ç›´æ¥å‚è€ƒå®ç°ï¼Œæä¾›æºç çº§åˆ†æ
â”‚  â””â”€ æ‰©å±•: æ€§èƒ½æ¨¡å‹å’Œä¼˜åŒ–æŒ‡å—
â”‚
â””â”€ Gray & Reuter (1993)
   â”œâ”€ è´¡çŒ®: äº‹åŠ¡å¤„ç†å®Œæ•´ç†è®ºæ¡†æ¶
   â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: MVCCåœ¨äº‹åŠ¡å¤„ç†ä¸­çš„ä½ç½®
   â””â”€ æ‰©å±•: è·¨å±‚æ˜ å°„å’Œç»Ÿä¸€æ¡†æ¶
```

### 1.0 ä¸ºä»€ä¹ˆéœ€è¦MVCCï¼Ÿ

**å†å²èƒŒæ™¯**:

åœ¨æ•°æ®åº“ç³»ç»Ÿå‘å±•çš„æ—©æœŸï¼ˆ1970-1980å¹´ä»£ï¼‰ï¼Œä¸»è¦ä½¿ç”¨ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰è¿›è¡Œå¹¶å‘æ§åˆ¶ã€‚2PLè™½ç„¶èƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹ï¼Œè¯»å†™äº’æ–¥å¯¼è‡´æ€§èƒ½ç“¶é¢ˆä¸¥é‡ã€‚1980å¹´ä»£ï¼Œç ”ç©¶è€…æå‡ºäº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰çš„æ¦‚å¿µï¼Œé€šè¿‡ç»´æŠ¤æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬æ¥å®ç°è¯»å†™å¹¶å‘ï¼Œå¤§å¹…æå‡äº†ç³»ç»Ÿæ€§èƒ½ã€‚

**æ·±åº¦å†å²æ¼”è¿›ä¸ç¡¬ä»¶èƒŒæ™¯**:

#### ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹MVCCçš„å½±å“

**å•æ ¸æ—¶ä»£ (1970s-1990s)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å•æ ¸å¿ƒï¼Œé¡ºåºæ‰§è¡Œ
â”œâ”€ å†…å­˜: ç»Ÿä¸€å†…å­˜ï¼Œæ— ç¼“å­˜å±‚æ¬¡
â”œâ”€ å­˜å‚¨: ç£ç›˜ï¼Œé¡ºåºè®¿é—®
â””â”€ å¹¶å‘: æ—¶é—´ç‰‡è½®è½¬ï¼Œä¼ªå¹¶å‘

2PLæ€§èƒ½ç‰¹å¾:
â”œâ”€ é”å¼€é”€: ä¸»è¦æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢
â”œâ”€ æ€§èƒ½: å¯æ¥å—ï¼ˆæ— çœŸå®å¹¶è¡Œï¼‰
â””â”€ é—®é¢˜: è¯»å†™äº’æ–¥ï¼Œä½†å½±å“æœ‰é™
```

**å¤šæ ¸æ—¶ä»£ (2000s-2010s)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å¤šæ ¸å¿ƒï¼ŒçœŸå®å¹¶è¡Œ
â”œâ”€ å†…å­˜: ç¼“å­˜å±‚æ¬¡ï¼ˆL1/L2/L3ï¼‰
â”œâ”€ å­˜å‚¨: SSDï¼Œéšæœºè®¿é—®æ€§èƒ½æå‡
â””â”€ å¹¶å‘: çœŸå®å¹¶è¡Œï¼Œç¼“å­˜ä¸€è‡´æ€§

MVCCä¼˜åŠ¿å‡¸æ˜¾:
â”œâ”€ è¯»æ— é”: é¿å…ç¼“å­˜ä¸€è‡´æ€§å¼€é”€
â”œâ”€ å†™åˆ›å»ºæ–°ç‰ˆæœ¬: å‡å°‘é”ç«äº‰
â””â”€ æ€§èƒ½: å¤šæ ¸ç¯å¢ƒä¸‹ä¼˜åŠ¿æ˜æ˜¾
```

**ç°ä»£ç¡¬ä»¶ (2010s+)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å¤šæ ¸å¤šçº¿ç¨‹ï¼ˆè¶…çº¿ç¨‹ï¼‰
â”œâ”€ å†…å­˜: NUMAæ¶æ„
â”œâ”€ å­˜å‚¨: NVMe SSDã€PMEM
â””â”€ é—®é¢˜: NUMAæ•ˆåº”ã€å­˜å‚¨å±‚æ¬¡

MVCCæ–°æŒ‘æˆ˜:
â”œâ”€ ç‰ˆæœ¬é“¾: è·¨NUMAèŠ‚ç‚¹è®¿é—®
â”œâ”€ VACUUM: éœ€è¦è€ƒè™‘NUMAäº²å’Œæ€§
â””â”€ è®¾è®¡: NUMAæ„ŸçŸ¥çš„MVCCå®ç°
```

#### è¯­è¨€æœºåˆ¶å¯¹MVCCå®ç°çš„å½±å“

**ç¼–è¯‘æ—¶æ£€æŸ¥ vs è¿è¡Œæ—¶æ£€æŸ¥**:

```text
MVCCå®ç°å±‚æ¬¡:
â”œâ”€ L0å±‚ (æ•°æ®åº“): PostgreSQL MVCC
â”‚   â”œâ”€ å®ç°: Cè¯­è¨€ï¼Œè¿è¡Œæ—¶æ£€æŸ¥
â”‚   â”œâ”€ å¿«ç…§: è¿è¡Œæ—¶åˆ›å»º
â”‚   â””â”€ å¯è§æ€§: è¿è¡Œæ—¶åˆ¤æ–­
â”‚
â”œâ”€ L1å±‚ (è¯­è¨€): Rustæ‰€æœ‰æƒ
â”‚   â”œâ”€ å®ç°: Rustï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
â”‚   â”œâ”€ å¿«ç…§: ç¼–è¯‘æœŸç”Ÿå‘½å‘¨æœŸ
â”‚   â””â”€ å¯è§æ€§: ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥
â”‚
â””â”€ æ˜ å°„å…³ç³»:
    â”œâ”€ MVCCå¿«ç…§ â‰ˆ Rustç”Ÿå‘½å‘¨æœŸ
    â”œâ”€ MVCCå¯è§æ€§ â‰ˆ Rustå€Ÿç”¨è§„åˆ™
    â””â”€ MVCCç‰ˆæœ¬é“¾ â‰ˆ Rustæ‰€æœ‰æƒè½¬ç§»
```

**ç¼–è¯‘å™¨ä¼˜åŒ–å¯¹MVCCçš„å½±å“**:

```text
ç¼–è¯‘å™¨ä¼˜åŒ–:
â”œâ”€ å†…è”ä¼˜åŒ–: å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
â”œâ”€ å¾ªç¯ä¼˜åŒ–: å‡å°‘ç‰ˆæœ¬é“¾éå†æ¬¡æ•°
â”œâ”€ å¯„å­˜å™¨åˆ†é…: å‡å°‘å†…å­˜è®¿é—®
â””â”€ é™åˆ¶: ä¸èƒ½æ”¹å˜MVCCè¯­ä¹‰

MVCCè¯­ä¹‰ä¿è¯:
â”œâ”€ å¿«ç…§ä¸€è‡´æ€§: ç¼–è¯‘å™¨ä¸èƒ½ç ´å
â”œâ”€ å¯è§æ€§è§„åˆ™: ç¼–è¯‘å™¨å¿…é¡»éµå®ˆ
â””â”€ ç‰ˆæœ¬é“¾å®Œæ•´æ€§: ç¼–è¯‘å™¨ä¸èƒ½ä¼˜åŒ–æ‰
```

**ç†è®ºåŸºç¡€**:

```text
å¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒé—®é¢˜:
â”œâ”€ é—®é¢˜: å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®åŒä¸€æ•°æ®
â”œâ”€ ä¼ ç»Ÿæ–¹æ¡ˆ: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚   â”œâ”€ è¯»æ“ä½œ: éœ€è¦å…±äº«é”
â”‚   â”œâ”€ å†™æ“ä½œ: éœ€è¦æ’ä»–é”
â”‚   â””â”€ ç»“æœ: è¯»å†™äº’æ–¥ï¼Œæ€§èƒ½ç“¶é¢ˆ
â”‚
â””â”€ MVCCæ–¹æ¡ˆ: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
    â”œâ”€ è¯»æ“ä½œ: è®¿é—®å†å²ç‰ˆæœ¬ï¼Œæ— éœ€åŠ é”
    â”œâ”€ å†™æ“ä½œ: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä»…å†™å†™å†²çª
    â””â”€ ç»“æœ: è¯»å†™å¹¶å‘ï¼Œæ€§èƒ½å¤§å¹…æå‡
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
MVCCæ¼”è¿›:
â”œâ”€ æ—©æœŸç³»ç»Ÿ (1970s-1980s)
â”‚   â”œâ”€ æ–¹æ¡ˆ: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚   â”œâ”€ é—®é¢˜: è¯»å†™äº’æ–¥ï¼Œæ€§èƒ½å·®
â”‚   â””â”€ åœºæ™¯: è¯»å¤šå†™å°‘æ—¶æ€§èƒ½ç“¶é¢ˆä¸¥é‡
â”‚
â”œâ”€ MVCCæå‡º (1980s)
â”‚   â”œâ”€ ç†è®º: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
â”‚   â”œâ”€ ä¼˜åŠ¿: è¯»ä¸é˜»å¡å†™
â”‚   â””â”€ åº”ç”¨: ç ”ç©¶ç³»ç»Ÿã€ç†è®ºéªŒè¯
â”‚
â””â”€ MVCCæ™®åŠ (2000s+)
    â”œâ”€ PostgreSQL: å®Œæ•´MVCCå®ç°
    â”œâ”€ MySQL InnoDB: MVCCæ”¯æŒ
    â””â”€ åº”ç”¨: æˆä¸ºä¸»æµå¹¶å‘æ§åˆ¶æ–¹æ¡ˆ
```

**ä¸ºä»€ä¹ˆMVCCé‡è¦ï¼Ÿ**

1. **æ€§èƒ½ä¼˜åŠ¿**: è¯»æ“ä½œæ— éœ€åŠ é”ï¼Œå¤§å¹…æå‡è¯»å¹¶å‘æ€§èƒ½
2. **éš”ç¦»ä¿è¯**: é€šè¿‡å¿«ç…§éš”ç¦»å®ç°äº‹åŠ¡éš”ç¦»
3. **å®é™…åº”ç”¨**: PostgreSQLç­‰ä¸»æµæ•°æ®åº“çš„æ ¸å¿ƒæœºåˆ¶
4. **ç†è®ºåŸºç¡€**: ä¸ºç†è§£ç°ä»£æ•°æ®åº“å¹¶å‘æ§åˆ¶æä¾›åŸºç¡€

**åä¾‹: æ— MVCCçš„ç³»ç»Ÿæ€§èƒ½é—®é¢˜**:

```text
é”™è¯¯è®¾è®¡: ä½¿ç”¨2PLå¤„ç†è¯»å¤šå†™å°‘åœºæ™¯
â”œâ”€ åœºæ™¯: æ–°é—»ç½‘ç«™ï¼Œ90%è¯»ï¼Œ10%å†™
â”œâ”€ é—®é¢˜: è¯»æ“ä½œéœ€è¦å…±äº«é”
â”œâ”€ ç»“æœ: è¯»æ“ä½œé˜»å¡å†™æ“ä½œ
â””â”€ æ€§èƒ½: TPSåªæœ‰1000ï¼Œæ— æ³•æ»¡è¶³éœ€æ±‚ âœ—

æ­£ç¡®è®¾è®¡: ä½¿ç”¨MVCC
â”œâ”€ åœºæ™¯: åŒæ ·çš„è¯»å¤šå†™å°‘åœºæ™¯
â”œâ”€ æ–¹æ¡ˆ: MVCCï¼Œè¯»æ“ä½œè®¿é—®å†å²ç‰ˆæœ¬
â”œâ”€ ç»“æœ: è¯»ä¸é˜»å¡å†™
â””â”€ æ€§èƒ½: TPSè¾¾åˆ°10000+ âœ“
```

**åè¯: ä¸ºä»€ä¹ˆ2PLåœ¨è¯»å¤šåœºæ™¯ä¸‹å¿…ç„¶æ€§èƒ½å·®ï¼Ÿ**

**å®šç†**: åœ¨è¯»å¤šå†™å°‘åœºæ™¯ä¸‹ï¼Œ2PLæ€§èƒ½ä¸¥æ ¼åŠ£äºMVCC

**è¯æ˜ï¼ˆé‡åŒ–åˆ†æï¼‰**:

```text
è®¾:
â”œâ”€ N_read: å¹¶å‘è¯»äº‹åŠ¡æ•°
â”œâ”€ N_write: å¹¶å‘å†™äº‹åŠ¡æ•°
â”œâ”€ T_2PL: 2PLååé‡
â”œâ”€ T_MVCC: MVCCååé‡
â””â”€ å‡è®¾: N_read >> N_write

2PLæ€§èƒ½æ¨¡å‹:
â”œâ”€ è¯»æ“ä½œ: éœ€è¦å…±äº«é”
â”œâ”€ é”ç«äº‰: O(N_read) è¯»çº¿ç¨‹ç«äº‰å…±äº«é”
â”œâ”€ å†™æ“ä½œ: éœ€è¦æ’ä»–é”ï¼Œé˜»å¡æ‰€æœ‰è¯»
â””â”€ ååé‡: T_2PL = 1 / (T_lock + T_read + T_wait)

MVCCæ€§èƒ½æ¨¡å‹:
â”œâ”€ è¯»æ“ä½œ: æ— é”ï¼ˆå¿«ç…§è¯»å–ï¼‰
â”œâ”€ å†™æ“ä½œ: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸é˜»å¡è¯»
â”œâ”€ é”ç«äº‰: O(N_write) << O(N_read)
â””â”€ ååé‡: T_MVCC = N_read / T_read

æ€§èƒ½æ¯”:
â”œâ”€ T_MVCC / T_2PL = N_read Ã— (T_lock + T_read + T_wait) / T_read
â”œâ”€ å½“ N_read >> 1 ä¸” T_wait >> T_read æ—¶
â””â”€ T_MVCC >> T_2PL

å› æ­¤: MVCCä¸¥æ ¼ä¼˜äº2PL âœ“
```

**ç¡¬ä»¶å±‚é¢çš„åè¯**:

```text
ç¼“å­˜ä¸€è‡´æ€§å¼€é”€:
â”œâ”€ 2PL: é”å˜é‡åœ¨å¤šä¸ªæ ¸å¿ƒé—´ä¼ é€’
â”‚   â”œâ”€ æ¯æ¬¡é”è·å–: éœ€è¦MESIåè®®
â”‚   â”œâ”€ å»¶è¿Ÿ: ~100ns (è·¨æ ¸å¿ƒ)
â”‚   â””â”€ å¼€é”€: O(N_read) Ã— 100ns
â”‚
â”œâ”€ MVCC: è¯»æ“ä½œæ— é”
â”‚   â”œâ”€ å¿«ç…§è¯»å–: ä»…éœ€L1ç¼“å­˜
â”‚   â”œâ”€ å»¶è¿Ÿ: ~4ns (L1ç¼“å­˜)
â”‚   â””â”€ å¼€é”€: O(N_read) Ã— 4ns
â”‚
â””â”€ æ€§èƒ½æ¯”: 100ns / 4ns = 25Ã—

NUMAæ¶æ„å½±å“:
â”œâ”€ 2PL: é”å˜é‡å¯èƒ½åœ¨è¿œç¨‹NUMAèŠ‚ç‚¹
â”‚   â”œâ”€ æœ¬åœ°è®¿é—®: ~100ns
â”‚   â”œâ”€ è¿œç¨‹è®¿é—®: ~300ns
â”‚   â””â”€ å¹³å‡å»¶è¿Ÿ: (100 + 300) / 2 = 200ns
â”‚
â”œâ”€ MVCC: ç‰ˆæœ¬æ•°æ®å¯ä»¥æœ¬åœ°åŒ–
â”‚   â”œâ”€ æœ¬åœ°è®¿é—®: ~100ns
â”‚   â””â”€ å¹³å‡å»¶è¿Ÿ: 100ns
â”‚
â””â”€ æ€§èƒ½æ¯”: 200ns / 100ns = 2Ã—

å› æ­¤: åœ¨ç¡¬ä»¶å±‚é¢ï¼ŒMVCCä¹Ÿä¸¥æ ¼ä¼˜äº2PL
```

**å®é™…æ¡ˆä¾‹åè¯**:

```text
æ¡ˆä¾‹1: æŸæ–°é—»ç½‘ç«™
â”œâ”€ åœºæ™¯: 1000å¹¶å‘è¯»ï¼Œ10å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 1000 (é”ç«äº‰ä¸¥é‡)
â”œâ”€ MVCC: TPS = 10000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 10å€ âœ“

æ¡ˆä¾‹2: æŸç”µå•†å•†å“è¯¦æƒ…é¡µ
â”œâ”€ åœºæ™¯: 10000å¹¶å‘è¯»ï¼Œ100å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 500 (é”æˆä¸ºç“¶é¢ˆ)
â”œâ”€ MVCC: TPS = 50000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 100å€ âœ“

æ¡ˆä¾‹3: æŸç¤¾äº¤å¹³å°åŠ¨æ€æµ
â”œâ”€ åœºæ™¯: 50000å¹¶å‘è¯»ï¼Œ500å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 100 (ç³»ç»Ÿå‡ ä¹ä¸å¯ç”¨)
â”œâ”€ MVCC: TPS = 200000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 2000å€ âœ“
```

### 1.1 å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨

**æ ¸å¿ƒçŸ›ç›¾**:

- **æ­£ç¡®æ€§**: äº‹åŠ¡éš”ç¦»ï¼Œé˜²æ­¢æ•°æ®ç«äº‰
- **æ€§èƒ½**: é«˜å¹¶å‘ååï¼Œé™ä½é”å¼€é”€

**ä¼ ç»Ÿ2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰çš„å›°å¢ƒ**:

$$ReadLock(T) \land WriteLock(T) \implies Conflict \implies Wait$$

- âœ… **ä¼˜åŠ¿**: å®ç°ç®€å•ï¼Œå¼ºéš”ç¦»ä¿è¯
- âŒ **åŠ£åŠ¿**: è¯»å†™äº’æ–¥ï¼Œååé‡ä½

**MVCCçš„åˆ›æ–°**:

$$Read(T_i) \parallel Write(T_j) \text{ if } Version(T_i) \neq Version(T_j)$$

- è¯»æ“ä½œè®¿é—®å†å²ç‰ˆæœ¬ï¼Œ**æ— éœ€åŠ é”**
- å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œ**ä»…å†™å†™å†²çª**

### 1.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1.1 (ç‰ˆæœ¬ç©ºé—´)**:

$$\mathcal{V} = \{v_1, v_2, ..., v_n\} \quad \text{where } v_i = (data, xmin, xmax, ctid)$$

**å®šä¹‰1.2 (ç‰ˆæœ¬é“¾)**:

$$VersionChain(row) = \{v_i \in \mathcal{V} : v_i.key = row.key\}$$

æ’åºå…³ç³»: $v_i \prec v_j \iff v_i.xmin < v_j.xmin$

**å®šä¹‰1.3 (å¿«ç…§)**:

$$Snapshot = (xmin, xmax, xip)$$

å…¶ä¸­:

- $xmin$: æœ€å°æ´»è·ƒäº‹åŠ¡ID
- $xmax$: æœ€å¤§å·²æäº¤äº‹åŠ¡ID + 1
- $xip$: æ´»è·ƒäº‹åŠ¡IDé›†åˆ

---

## äºŒã€å¯è§æ€§åˆ¤æ–­ç®—æ³•

### 2.1 å®Œæ•´å¯è§æ€§è§„åˆ™

**ç®—æ³•2.1: å…ƒç»„å¯è§æ€§åˆ¤æ–­**:

```python
def tuple_visible(tuple: Tuple, snapshot: Snapshot, txid: TransactionId) -> bool:
    """
    å®Œæ•´çš„å¯è§æ€§åˆ¤æ–­ç®—æ³•

    æ—¶é—´å¤æ‚åº¦: O(log |xip|)ï¼ˆäºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ï¼‰
    """
    # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬æ°¸è¿œå¯è§
    if tuple.xmin == txid:
        if tuple.xmax == 0:
            return True  # æœªåˆ é™¤
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡å·²åˆ é™¤
        if not is_committed(tuple.xmax):
            return True  # åˆ é™¤äº‹åŠ¡æœªæäº¤
        return False  # åˆ é™¤äº‹åŠ¡å·²æäº¤

    # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤ â†’ ä¸å¯è§
    if not is_committed(tuple.xmin):
        return False

    # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§åå¯åŠ¨ â†’ ä¸å¯è§
    if tuple.xmin >= snapshot.xmax:
        return False

    # è§„åˆ™4: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨ â†’ ä¸å¯è§
    if tuple.xmin in snapshot.xip:  # O(log n) äºŒåˆ†æŸ¥æ‰¾
        return False

    # è§„åˆ™5: æ£€æŸ¥åˆ é™¤æ ‡è®°xmax
    if tuple.xmax == 0:
        return True  # æœªåˆ é™¤

    if tuple.xmax == txid:
        return False  # æœ¬äº‹åŠ¡åˆ é™¤

    if not is_committed(tuple.xmax):
        return True  # åˆ é™¤äº‹åŠ¡æœªæäº¤

    if tuple.xmax >= snapshot.xmax:
        return True  # åˆ é™¤åœ¨å¿«ç…§å

    if tuple.xmax in snapshot.xip:
        return True  # åˆ é™¤äº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨

    # æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ â†’ å·²åˆ é™¤
    return False
```

### 2.2 å¯è§æ€§è¯æ˜

**å®šç†2.1 (å¯è§æ€§å•è°ƒæ€§)**:

$$\forall snap_1, snap_2: snap_1 \prec snap_2 \implies Visible(v, snap_1) \subseteq Visible(v, snap_2)$$

**è¯æ˜**:

è®¾ $snap_1 = (xmin_1, xmax_1, xip_1)$, $snap_2 = (xmin_2, xmax_2, xip_2)$

ä¸” $snap_1 \prec snap_2$ï¼Œå³ $xmax_1 \leq xmax_2$ ä¸” $xip_1 \supseteq xip_2$

å‡è®¾ $v$ å¯¹ $snap_1$ å¯è§ï¼Œå³:

1. $v.xmin < xmax_1$ ä¸” $v.xmin \notin xip_1$
2. $v.xmax = 0$ æˆ– $v.xmax \geq xmax_1$ æˆ– $v.xmax \in xip_1$

éœ€è¯æ˜ $v$ å¯¹ $snap_2$ å¯è§:

**æƒ…å†µ1**: å¦‚æœ $v.xmin < xmax_1$ï¼Œåˆ™ $v.xmin < xmax_2$ï¼ˆå› ä¸º $xmax_1 \leq xmax_2$ï¼‰

**æƒ…å†µ2**: å¦‚æœ $v.xmin \notin xip_1$ï¼Œåˆ™ $v.xmin \notin xip_2$ï¼ˆå› ä¸º $xip_1 \supseteq xip_2$ï¼‰

**æƒ…å†µ3**: å¦‚æœ $v.xmax \geq xmax_1$ï¼Œåˆ™ $v.xmax \geq xmax_2$ æˆ– $v.xmax \in [xmax_1, xmax_2)$ï¼Œåè€…æ„å‘³ç€ $v$ åœ¨ $snap_2$ å‰æœªåˆ é™¤

å› æ­¤ $v$ å¯¹ $snap_2$ å¯è§ã€‚ âˆ

**æ¨è®º2.1**: å¿«ç…§è¶Šæ–°ï¼Œå¯è§çš„ç‰ˆæœ¬è¶Šå¤šï¼ˆå•è°ƒé€’å¢ï¼‰

### 2.3 æ—¶ç©ºå¤æ‚åº¦åˆ†æ

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | è¯´æ˜ |
|-----|-----------|-----------|------|
| **å¯è§æ€§æ£€æŸ¥** | $O(\log\|xip\|)$ | $O(1)$ | äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ |
| **å¿«ç…§åˆ›å»º** | $O(N)$ | $O(N)$ | Nä¸ºæ´»è·ƒäº‹åŠ¡æ•° |
| **ç‰ˆæœ¬é“¾éå†** | $O(k)$ | $O(1)$ | kä¸ºé“¾é•¿åº¦ |
| **ç´¢å¼•æ‰«æ** | $O(m \log n + mk)$ | $O(1)$ | mä¸ªç´¢å¼•é¡¹ï¼Œkä¸ºå¹³å‡é“¾é•¿ |

**æœ€åæƒ…å†µåˆ†æ**:

é«˜å¹¶å‘æ›´æ–°åŒä¸€è¡Œ â†’ ç‰ˆæœ¬é“¾é•¿åº¦ $k \to \infty$

$$T_{scan} = O(n \cdot k) \quad \text{where } k = \text{avg chain length}$$

**ä¼˜åŒ–ç­–ç•¥**: HOTï¼ˆHeap-Only Tupleï¼‰æœºåˆ¶ï¼Œé¿å…ç´¢å¼•è†¨èƒ€

---

## ä¸‰ã€æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–

### 3.1 INSERTæ“ä½œ

**è¯­ä¹‰**:

$$INSERT(data) \implies \text{Create } v_{new} \text{ where } v_{new}.xmin = \text{CurrentTxID}$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T1 (TxID=100)
INSERT INTO users (id, name) VALUES (1, 'Alice');

-- å…ƒç»„çŠ¶æ€
Tuple {
    xmin: 100,
    xmax: 0,        -- æœªåˆ é™¤
    data: 'Alice',
    ctid: (0, 1)    -- é¡µå·0, åç§»1
}
```

**å¯è§æ€§**:

- å¯¹T1: ç«‹å³å¯è§ï¼ˆè§„åˆ™1ï¼‰
- å¯¹å…¶ä»–äº‹åŠ¡: T1æäº¤åå¯è§ï¼ˆè§„åˆ™2ï¼‰

### 3.2 DELETEæ“ä½œ

**è¯­ä¹‰**:

$$DELETE(row) \implies v_{old}.xmax \leftarrow \text{CurrentTxID}$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T2 (TxID=105)
DELETE FROM users WHERE id = 1;

-- å…ƒç»„çŠ¶æ€æ›´æ–°
Tuple {
    xmin: 100,
    xmax: 105,      -- æ ‡è®°åˆ é™¤
    data: 'Alice',
    ctid: (0, 1)
}
```

**å»¶è¿Ÿæ¸…ç†**: ç‰©ç†åˆ é™¤ç”±VACUUMå®Œæˆ

### 3.3 UPDATEæ“ä½œ

**è¯­ä¹‰**:

$$UPDATE(row, new\_data) \equiv DELETE(row) + INSERT(new\_data)$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T3 (TxID=110)
UPDATE users SET name = 'Bob' WHERE id = 1;

-- æ—§ç‰ˆæœ¬æ ‡è®°åˆ é™¤
Tuple_old {
    xmin: 100,
    xmax: 110,      -- æ ‡è®°åˆ é™¤
    data: 'Alice',
    ctid: (0, 1)
}

-- æ–°ç‰ˆæœ¬æ’å…¥
Tuple_new {
    xmin: 110,
    xmax: 0,
    data: 'Bob',
    ctid: (0, 2)    -- æ–°ä½ç½®
}
```

**HOTä¼˜åŒ–æ¡ä»¶**:

1. æœªæ›´æ–°ç´¢å¼•åˆ—
2. æ–°ç‰ˆæœ¬åœ¨åŒä¸€é¡µå†…
3. é¡µé¢æœ‰è¶³å¤Ÿç©ºé—´

**HOTé“¾**:

```text
Index â†’ Tuple_old â”€[HOT]â†’ Tuple_new
          â†‘ (ctidæŒ‡é’ˆ)
```

---

## å››ã€éš”ç¦»çº§åˆ«å®ç°

### 4.1 Read Committed

**å¿«ç…§ç­–ç•¥**: **è¯­å¥çº§å¿«ç…§**

```python
class ReadCommittedTransaction:
    def execute_statement(self, sql):
        snapshot = get_current_snapshot()  # æ¯æ¡è¯­å¥è·å–æ–°å¿«ç…§
        result = execute_with_snapshot(sql, snapshot)
        return result
```

**å…è®¸çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: åŒä¸€æŸ¥è¯¢è¿”å›ä¸åŒç»“æœ
- âœ… **å¹»è¯»**: èŒƒå›´æŸ¥è¯¢å‡ºç°æ–°è¡Œ

**ç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡å†…)
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 200 (ä¸å¯é‡å¤è¯»)
```

### 4.2 Repeatable Read

**å¿«ç…§ç­–ç•¥**: **äº‹åŠ¡çº§å¿«ç…§**

```python
class RepeatableReadTransaction:
    def __init__(self):
        self.snapshot = get_current_snapshot()  # äº‹åŠ¡å¼€å§‹æ—¶å›ºå®š

    def execute_statement(self, sql):
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: å›ºå®šå¿«ç…§ä¿è¯ä¸€è‡´æ€§
- âœ… **å¹»è¯»**: PostgreSQLæ‰©å±•ï¼Œäº‹åŠ¡çº§å¿«ç…§é˜²æ­¢å¹»è¯»

**å†™å†™å†²çªæ£€æµ‹**:

```sql
-- äº‹åŠ¡T1
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE id = 1;  -- å¿«ç…§: balance=100

-- äº‹åŠ¡T2 ä¿®æ”¹å¹¶æäº¤
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- äº‹åŠ¡T1 å°è¯•æ›´æ–°
UPDATE accounts SET balance = 150 WHERE id = 1;
-- ERROR: could not serialize access due to concurrent update
```

**å†²çªæ£€æµ‹ç®—æ³•**:

```python
def detect_rr_conflict(tuple, snapshot, txid):
    if tuple.xmax != 0 and tuple.xmax != txid:
        if is_committed(tuple.xmax):
            # è¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹
            raise SerializationError("concurrent update")
```

### 4.3 Serializable (SSI)

**SSI (Serializable Snapshot Isolation)**: åŸºäºä¾èµ–å›¾çš„å†²çªæ£€æµ‹

**æ ¸å¿ƒæ€æƒ³**: æ£€æµ‹**è¯»å†™ä¾èµ–ç¯**

**å®šä¹‰4.1 (è¯»å†™ä¾èµ–)**:

$$T_i \xrightarrow{rw} T_j \iff T_i \text{ è¯»å–çš„æ•°æ®è¢« } T_j \text{ ä¿®æ”¹}$$

**å®šä¹‰4.2 (å†™è¯»ä¾èµ–)**:

$$T_i \xrightarrow{wr} T_j \iff T_i \text{ ä¿®æ”¹çš„æ•°æ®è¢« } T_j \text{ è¯»å–}$$

**å®šç†4.1 (SSIæ­£ç¡®æ€§)**:

$$\text{Serializable} \iff \neg\exists \text{ cycle in dependency graph}$$

**è¯æ˜**: è§ `03-è¯æ˜ä¸å½¢å¼åŒ–/03-ä¸²è¡ŒåŒ–è¯æ˜.md#å®šç†4.1`

**å®ç°æœºåˆ¶**:

1. **è°“è¯é”** (Predicate Lock): è®°å½•è¯»å–çš„èŒƒå›´

    ```python
    class PredicateLock:
        def __init__(self, table, predicate):
            self.table = table
            self.predicate = predicate  # ä¾‹å¦‚: "id BETWEEN 1 AND 10"

        def conflicts_with(self, write_op):
            # æ£€æŸ¥å†™æ“ä½œæ˜¯å¦åœ¨è¯»å–èŒƒå›´å†…
            return write_op.matches(self.predicate)
    ```

2. **SIREADé”**: è½»é‡çº§å…±äº«é”ï¼Œæ ‡è®°è¯»å–

    ```sql
    -- äº‹åŠ¡T1
    BEGIN ISOLATION LEVEL SERIALIZABLE;
    SELECT * FROM orders WHERE amount > 100;
    -- å†…éƒ¨: åˆ›å»ºSIREADé” (amount > 100)

    -- äº‹åŠ¡T2
    INSERT INTO orders VALUES (200);
    -- æ£€æµ‹åˆ°å†²çª: æ–°è¡Œæ»¡è¶³T1çš„è°“è¯
    -- è®°å½•ä¾èµ–: T1 â†’ T2

    -- è‹¥æ£€æµ‹åˆ°ç¯ â†’ ä¸­æ­¢T1æˆ–T2
    ```

3. **ä¾èµ–å›¾ç»´æŠ¤**:

```python
class DependencyGraph:
    def __init__(self):
        self.edges = {}  # {T_i: [T_j, T_k, ...]}

    def add_edge(self, from_tx, to_tx, edge_type):
        self.edges.setdefault(from_tx, []).append((to_tx, edge_type))

        # æ£€æµ‹ç¯
        if self.has_cycle():
            # é€‰æ‹©ç‰ºç‰²äº‹åŠ¡ï¼ˆé€šå¸¸æ˜¯æœ€æ–°äº‹åŠ¡ï¼‰
            self.abort_transaction(to_tx)

    def has_cycle(self):
        # DFSæ£€æµ‹ç¯
        visited = set()
        stack = set()

        def dfs(node):
            if node in stack:
                return True  # å‘ç°ç¯
            if node in visited:
                return False

            visited.add(node)
            stack.add(node)

            for neighbor, _ in self.edges.get(node, []):
                if dfs(neighbor):
                    return True

            stack.remove(node)
            return False

        for node in self.edges:
            if dfs(node):
                return True
        return False
```

---

## äº”ã€VACUUMæœºåˆ¶

### 5.1 æ­»å…ƒç»„è¯†åˆ«

**å®šä¹‰5.1 (æ­»å…ƒç»„)**:

$$DeadTuple(v) \iff v.xmax \neq 0 \land v.xmax < \text{OldestXmin}$$

å…¶ä¸­ $\text{OldestXmin}$ = æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID

**ç®—æ³•5.1: è®¡ç®—OldestXmin**:

```python
def compute_oldest_xmin():
    active_txs = get_active_transactions()  # è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    if not active_txs:
        return get_latest_completed_xid()

    return min(tx.xmin for tx in active_txs)
```

### 5.2 æ¸…ç†è¿‡ç¨‹

**é˜¶æ®µ1: æ‰«æè¡¨**:

```python
def vacuum_table(table):
    oldest_xmin = compute_oldest_xmin()
    dead_tuples = []

    for page in table.pages:
        for tuple in page.tuples:
            if is_dead(tuple, oldest_xmin):
                dead_tuples.append(tuple)
                mark_as_unused(tuple)  # æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´

    update_fsm(table, dead_tuples)  # æ›´æ–°ç©ºé—²ç©ºé—´æ˜ å°„
    return dead_tuples
```

**é˜¶æ®µ2: æ¸…ç†ç´¢å¼•**:

```python
def vacuum_indexes(table, dead_tuples):
    dead_ctids = {tuple.ctid for tuple in dead_tuples}

    for index in table.indexes:
        for entry in index.entries:
            if entry.ctid in dead_ctids:
                delete_index_entry(index, entry)
```

**é˜¶æ®µ3: æˆªæ–­è¡¨æ–‡ä»¶**ï¼ˆå¯é€‰ï¼‰

```python
def truncate_table(table):
    # å¦‚æœè¡¨å°¾éƒ¨æœ‰è¿ç»­çš„ç©ºé¡µé¢ï¼Œç‰©ç†æˆªæ–­æ–‡ä»¶
    empty_pages = count_trailing_empty_pages(table)
    if empty_pages > threshold:
        truncate_file(table, empty_pages)
```

### 5.3 Freezeæ“ä½œ

**é—®é¢˜**: 32ä½äº‹åŠ¡IDå›å·

$$\text{XID} \in [0, 2^{32}-1] \implies \text{wrap-around after } 4B \text{ transactions}$$

**è§£å†³**: Freezeæ—§å…ƒç»„

```sql
-- å½“å…ƒç»„å¹´é¾„è¶…è¿‡é˜ˆå€¼
IF (current_xid - tuple.xmin) > autovacuum_freeze_max_age THEN
    tuple.xmin := FrozenTransactionId  -- ç‰¹æ®Šå€¼: 2
    -- è¯¥å…ƒç»„å˜ä¸º"æ°¸ä¹…å¯è§"
```

**Freezeç­–ç•¥**:

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|------|
| `vacuum_freeze_min_age` | 50M | è§¦å‘freezeçš„æœ€å°å¹´é¾„ |
| `vacuum_freeze_table_age` | 150M | å¼ºåˆ¶freezeæ•´è¡¨çš„å¹´é¾„ |
| `autovacuum_freeze_max_age` | 200M | é˜²æ­¢å›å·çš„æœ€å¤§å¹´é¾„ |

---

## å…­ã€ä¼˜åŒ–æŠ€æœ¯

### 6.1 HOT (Heap-Only Tuple)

**æ¡ä»¶**:

1. UPDATEä¸æ¶‰åŠç´¢å¼•åˆ—
2. æ–°ç‰ˆæœ¬åœ¨åŒä¸€é¡µå†…
3. é¡µé¢æœ‰è¶³å¤Ÿç©ºé—²ç©ºé—´

**æ•ˆæœ**:

$$\text{Index writes} = 0 \quad (\text{vs traditional: } O(n) \text{ for } n \text{ indexes})$$

**å®ç°**:

```c
// PostgreSQLæºç ç®€åŒ–
if (HeapTupleIsHotUpdated(oldtup) &&
    !IndexedColumnsChanged(oldtup, newtup) &&
    PageGetFreeSpace(page) >= newtup_size) {

    // åœ¨åŒé¡µå†…æ’å…¥æ–°ç‰ˆæœ¬
    newoffset = PageAddItem(page, newtup);

    // å»ºç«‹HOTé“¾
    oldtup->t_ctid = (page_num, newoffset);

    // ä¸æ’å…¥æ–°ç´¢å¼•é¡¹
}
```

**ç‰ˆæœ¬é“¾**:

```text
Index â†’ [Page Header]
          â†“
       [ItemId 1] â†’ Tuple_v1 (xmin=100, xmax=110)
          â†“           â†“ (ctidæŒ‡å‘)
       [ItemId 2] â†’ Tuple_v2 (xmin=110, xmax=0)  â† HOTé“¾
```

### 6.2 Index-Only Scan

**å‰æ**: æŸ¥è¯¢åˆ—å®Œå…¨åœ¨ç´¢å¼•ä¸­ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰

**é—®é¢˜**: ä»éœ€æ£€æŸ¥å¯è§æ€§ â†’ éœ€è¦è®¿é—®å †è¡¨

**è§£å†³**: **Visibility Map**

```python
class VisibilityMap:
    """
    ä½å›¾: æ¯ä¸ªå †é¡µä¸€ä¸ªbit
    1 = é¡µé¢æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
    0 = éœ€è¦æ£€æŸ¥å¯è§æ€§
    """
    def __init__(self, num_pages):
        self.bits = [0] * num_pages

    def set_all_visible(self, page_num):
        self.bits[page_num] = 1

    def is_all_visible(self, page_num):
        return self.bits[page_num] == 1
```

**Index-Only Scanæµç¨‹**:

```python
def index_only_scan(index, query):
    results = []

    for entry in index.search(query):
        page_num = entry.ctid[0]

        if visibility_map.is_all_visible(page_num):
            # è·³è¿‡å †è®¿é—®
            results.append(entry.data)
        else:
            # éœ€è¦æ£€æŸ¥å¯è§æ€§
            tuple = fetch_tuple(entry.ctid)
            if tuple_visible(tuple, current_snapshot, current_txid):
                results.append(tuple.data)

    return results
```

### 6.3 Parallel VACUUM

**ç­–ç•¥**: å¤šå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ¸…ç†

```python
def parallel_vacuum(table, num_workers=4):
    pages = table.pages
    chunk_size = len(pages) // num_workers

    futures = []
    for i in range(num_workers):
        start = i * chunk_size
        end = start + chunk_size if i < num_workers - 1 else len(pages)

        future = executor.submit(vacuum_pages, table, pages[start:end])
        futures.append(future)

    dead_tuples = []
    for future in futures:
        dead_tuples.extend(future.result())

    # ç´¢å¼•æ¸…ç†ä»éœ€ä¸²è¡Œï¼ˆæŒæœ‰é”ï¼‰
    vacuum_indexes(table, dead_tuples)
```

---

## ä¸ƒã€æ€§èƒ½åˆ†æ

### 7.1 ååé‡æ¨¡å‹

**è¯»å¯†é›†è´Ÿè½½**:

$$TPS_{read} = \frac{C}{T_{snapshot} + T_{scan} + T_{visibility}}$$

å…¶ä¸­:

- $C$: å¹¶å‘åº¦
- $T_{snapshot}$: å¿«ç…§åˆ›å»ºæ—¶é—´ â‰ˆ $O(N_{active})$
- $T_{scan}$: ç´¢å¼•æ‰«ææ—¶é—´
- $T_{visibility}$: å¯è§æ€§æ£€æŸ¥æ—¶é—´ â‰ˆ $O(\log N_{active})$

**å†™å¯†é›†è´Ÿè½½**:

$$TPS_{write} = \frac{C}{T_{lock} + T_{insert} + T_{wal}}$$

å…¶ä¸­:

- $T_{lock}$: é”è·å–æ—¶é—´ï¼ˆå†™å†™å†²çªï¼‰
- $T_{insert}$: å…ƒç»„æ’å…¥æ—¶é—´
- $T_{wal}$: WALå†™å…¥æ—¶é—´

### 7.2 ç©ºé—´å¼€é”€

**ç‰ˆæœ¬è†¨èƒ€**:

$$SpaceOverhead = \sum_{row} |\text{VersionChain}(row)| \cdot \text{TupleSize}$$

**æœ€åæƒ…å†µ**: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°

$$|\text{VersionChain}| \propto T_{long\_tx} \cdot \text{UpdateRate}$$

**ç¤ºä¾‹**:

- é•¿äº‹åŠ¡è¿è¡Œæ—¶é—´: 1å°æ—¶
- æ›´æ–°é¢‘ç‡: 1000æ¬¡/ç§’
- ç‰ˆæœ¬æ•°: $3600 \times 1000 = 3.6M$ ç‰ˆæœ¬

### 7.3 VACUUMå¼€é”€

**æ—¶é—´å¤æ‚åº¦**:

$$T_{vacuum} = T_{scan} + T_{index\_clean} + T_{fsm\_update}$$

- $T_{scan} = O(N_{pages})$
- $T_{index\_clean} = O(N_{dead} \cdot N_{indexes} \cdot \log N_{index\_entries})$
- $T_{fsm\_update} = O(N_{pages})$

**æƒè¡¡**:

- VACUUMè¿‡äºé¢‘ç¹ â†’ CPU/IOå¼€é”€å¤§
- VACUUMä¸è¶³ â†’ è¡¨è†¨èƒ€ä¸¥é‡

**è‡ªåŠ¨VACUUMè§¦å‘æ¡ä»¶**:

$$\text{Trigger} \iff N_{dead} > \text{threshold} + \text{scale\_factor} \cdot N_{total}$$

é»˜è®¤: $threshold=50$, $scale\_factor=0.2$

---

## å…«ã€ä¸å…¶ä»–MVCCå®ç°å¯¹æ¯”

### 8.1 PostgreSQL vs MySQL InnoDB

| ç»´åº¦ | PostgreSQL | MySQL InnoDB |
|-----|------------|--------------|
| **ç‰ˆæœ¬å­˜å‚¨** | Heapè¡¨å†…ï¼ˆå¤šç‰ˆæœ¬ï¼‰ | Undoè¡¨ç©ºé—´ï¼ˆå•ç‰ˆæœ¬+å›æ»šæ®µï¼‰ |
| **ç‰ˆæœ¬é“¾** | å‰å‘é“¾ï¼ˆæ–°â†’æ—§ï¼‰ | åå‘é“¾ï¼ˆæ—§â†æ–°ï¼‰ |
| **æ¸…ç†æœºåˆ¶** | VACUUM (åå°è¿›ç¨‹) | Purgeçº¿ç¨‹ (è‡ªåŠ¨) |
| **ç´¢å¼•å½±å“** | æ¯ç‰ˆæœ¬ä¸€ä¸ªç´¢å¼•é¡¹ | ç´¢å¼•é¡¹ä¸å˜ï¼ˆé€šè¿‡Undoï¼‰ |
| **ç©ºé—´å¼€é”€** | è¡¨è†¨èƒ€ | Undoç©ºé—´è†¨èƒ€ |
| **é•¿äº‹åŠ¡å½±å“** | ç‰ˆæœ¬é“¾å˜é•¿ | Undoé“¾å˜é•¿ |

### 8.2 Oracle MVCCå®ç°

#### 8.2.1 Undo Logæœºåˆ¶

**æ ¸å¿ƒè®¾è®¡**:

Oracleä½¿ç”¨Undo Segmentsï¼ˆå›æ»šæ®µï¼‰å­˜å‚¨å†å²ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯åœ¨è¡¨å†…å­˜å‚¨å¤šä¸ªç‰ˆæœ¬ã€‚å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼ŒåŸå§‹æ•°æ®è¢«å¤åˆ¶åˆ°Undo Segmentï¼Œæ–°æ•°æ®å†™å…¥åŸä½ç½®ã€‚

**å®ç°æœºåˆ¶**:

```text
Oracle MVCCæµç¨‹:
â”œâ”€ äº‹åŠ¡T1ä¿®æ”¹è¡ŒR
â”‚   â”œâ”€ æ­¥éª¤1: å°†Rçš„åŸå§‹å€¼å†™å…¥Undo Segment
â”‚   â”œâ”€ æ­¥éª¤2: åœ¨Undo Segmentä¸­è®°å½•Undo Record
â”‚   â”‚   â””â”€ åŒ…å«: è¡¨åã€è¡ŒIDã€åŸå§‹å€¼ã€äº‹åŠ¡ID
â”‚   â””â”€ æ­¥éª¤3: åœ¨åŸä½ç½®å†™å…¥æ–°å€¼
â”‚
â”œâ”€ äº‹åŠ¡T2è¯»å–è¡ŒRï¼ˆéœ€è¦å†å²ç‰ˆæœ¬ï¼‰
â”‚   â”œâ”€ æ­¥éª¤1: è¯»å–å½“å‰å€¼ï¼ˆæ–°å€¼ï¼‰
â”‚   â”œâ”€ æ­¥éª¤2: æ£€æŸ¥äº‹åŠ¡IDï¼Œå‘ç°æ˜¯T1çš„æœªæäº¤ä¿®æ”¹
â”‚   â”œâ”€ æ­¥éª¤3: ä»Undo Segmentè¯»å–åŸå§‹å€¼
â”‚   â””â”€ æ­¥éª¤4: è¿”å›åŸå§‹å€¼ç»™T2
â”‚
â””â”€ äº‹åŠ¡T1æäº¤
    â”œâ”€ æ­¥éª¤1: æ ‡è®°Undo Recordä¸ºå¯å›æ”¶
    â””â”€ æ­¥éª¤2: åå°è¿›ç¨‹å›æ”¶Undoç©ºé—´
```

**Undo Segmentç»“æ„**:

```sql
-- Oracle Undo Segmentå†…éƒ¨ç»“æ„ï¼ˆæ¦‚å¿µæ¨¡å‹ï¼‰
CREATE TABLE undo_segment (
    segment_id INT,
    transaction_id INT,
    table_name VARCHAR,
    row_id ROWID,
    old_value BLOB,  -- åŸå§‹æ•°æ®
    undo_type VARCHAR,  -- INSERT/UPDATE/DELETE
    timestamp TIMESTAMP
);
```

**Read Consistencyå®ç°**:

```text
Oracle Read Consistency:
â”œâ”€ ä¸€è‡´æ€§è¯» (Consistent Read)
â”‚   â”œâ”€ å®šä¹‰: äº‹åŠ¡çœ‹åˆ°æ•°æ®åº“åœ¨äº‹åŠ¡å¼€å§‹æ—¶çš„çŠ¶æ€
â”‚   â”œâ”€ å®ç°: ä»Undo Segmenté‡å»ºå†å²ç‰ˆæœ¬
â”‚   â””â”€ ä¿è¯: å³ä½¿å…¶ä»–äº‹åŠ¡åœ¨ä¿®æ”¹ï¼Œè¯»å–å§‹ç»ˆä¸€è‡´
â”‚
â”œâ”€ å½“å‰è¯» (Current Read)
â”‚   â”œâ”€ å®šä¹‰: è¯»å–æœ€æ–°æäº¤çš„æ•°æ®
â”‚   â”œâ”€ å®ç°: ç›´æ¥è¯»å–è¡¨æ•°æ®
â”‚   â””â”€ åº”ç”¨: SELECT FOR UPDATEç­‰åœºæ™¯
â”‚
â””â”€ Flashback Query
    â”œâ”€ å®šä¹‰: æŸ¥è¯¢å†å²æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
    â”œâ”€ å®ç°: ä»Undo Segmenté‡å»ºæŒ‡å®šæ—¶é—´ç‚¹çš„ç‰ˆæœ¬
    â””â”€ åº”ç”¨: æ•°æ®æ¢å¤ã€å®¡è®¡ç­‰
```

#### 8.2.2 ä¸PostgreSQLå¯¹æ¯”

| ç»´åº¦ | PostgreSQL | Oracle |
|-----|-----------|--------|
| **å­˜å‚¨æ¨¡å‹** | Append-Onlyï¼ˆè¡¨å†…å¤šç‰ˆæœ¬ï¼‰ | Undo Logï¼ˆè¡¨å¤–å†å²ç‰ˆæœ¬ï¼‰ |
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | Undo Segmentsï¼ˆç‹¬ç«‹è¡¨ç©ºé—´ï¼‰ |
| **è¯»å–å†å²ç‰ˆæœ¬** | ç›´æ¥è¯»å–è¡¨å†…ç‰ˆæœ¬ | ä»Undo Segmenté‡å»º |
| **ç©ºé—´æ•ˆç‡** | â­â­ (è¡¨è†¨èƒ€) | â­â­â­â­ (ä»…å­˜å‚¨å˜æ›´) |
| **è¯»å–æ€§èƒ½** | â­â­â­â­â­ (ç›´æ¥è¯»å–) | â­â­â­â­ (éœ€è¦é‡å»º) |
| **å†™å…¥æ€§èƒ½** | â­â­â­ (åˆ›å»ºæ–°ç‰ˆæœ¬) | â­â­â­â­â­ (åŸåœ°æ›´æ–°+Undo) |
| **æ¸…ç†æœºåˆ¶** | VACUUMï¼ˆè¡¨å†…æ¸…ç†ï¼‰ | Undoè‡ªåŠ¨å›æ”¶ï¼ˆç‹¬ç«‹ç®¡ç†ï¼‰ |
| **é•¿äº‹åŠ¡å½±å“** | è¡¨å†…ç‰ˆæœ¬é“¾å˜é•¿ | Undoé“¾å˜é•¿ï¼ŒUndoç©ºé—´å‹åŠ› |
| **Flashbackæ”¯æŒ** | ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆFlashback Queryï¼‰ |
| **é€‚ç”¨åœºæ™¯** | è¯»å¤šå†™å°‘ | å†™å¤šè¯»å°‘æˆ–é€šç”¨åœºæ™¯ |

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼ˆåŸºäºå…¸å‹å·¥ä½œè´Ÿè½½ï¼‰:

```text
è¯»å¤šå†™å°‘åœºæ™¯ (90%è¯», 10%å†™):
â”œâ”€ PostgreSQL: TPS = 50,000 (è¯»ä¼˜åŠ¿æ˜æ˜¾)
â”œâ”€ Oracle: TPS = 40,000 (Undoé‡å»ºå¼€é”€)
â””â”€ ç»“è®º: PostgreSQLä¼˜åŠ¿ âœ“

å†™å¤šè¯»å°‘åœºæ™¯ (10%è¯», 90%å†™):
â”œâ”€ PostgreSQL: TPS = 5,000 (è¡¨è†¨èƒ€ä¸¥é‡)
â”œâ”€ Oracle: TPS = 8,000 (åŸåœ°æ›´æ–°ä¼˜åŠ¿)
â””â”€ ç»“è®º: Oracleä¼˜åŠ¿ âœ“

å¹³è¡¡åœºæ™¯ (50%è¯», 50%å†™):
â”œâ”€ PostgreSQL: TPS = 15,000
â”œâ”€ Oracle: TPS = 18,000
â””â”€ ç»“è®º: Oracleç•¥ä¼˜
```

#### 8.2.3 Oracle MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**:

1. **ç©ºé—´æ•ˆç‡é«˜**: ä»…å­˜å‚¨å˜æ›´ï¼Œä¸å­˜å‚¨å®Œæ•´ç‰ˆæœ¬
   - **PostgreSQL**: æ¯ä¸ªç‰ˆæœ¬éƒ½æ˜¯å®Œæ•´è¡Œ
   - **Oracle**: ä»…å­˜å‚¨å˜æ›´å­—æ®µ
   - **ç©ºé—´èŠ‚çœ**: çº¦50-70%ï¼ˆå–å†³äºæ›´æ–°å­—æ®µæ¯”ä¾‹ï¼‰

2. **åŸåœ°æ›´æ–°**: è¡¨æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€ç‰ˆæœ¬é“¾éå†
   - **PostgreSQL**: éœ€è¦éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬
   - **Oracle**: ç›´æ¥è¯»å–è¡¨æ•°æ®ï¼Œéœ€è¦å†å²ç‰ˆæœ¬æ—¶ä»Undoé‡å»º

3. **Flashback Query**: æ”¯æŒæŸ¥è¯¢å†å²ä»»æ„æ—¶é—´ç‚¹çš„æ•°æ®
   - **PostgreSQL**: ä¸æ”¯æŒï¼ˆéœ€è¦é¢å¤–çš„æ—¶é—´æ—…è¡Œæ‰©å±•ï¼‰
   - **Oracle**: åŸç”Ÿæ”¯æŒï¼ŒåŸºäºUndo Segment

4. **è‡ªåŠ¨ç©ºé—´ç®¡ç†**: Undo Segmentè‡ªåŠ¨å›æ”¶ï¼Œæ— éœ€æ‰‹åŠ¨VACUUM
   - **PostgreSQL**: éœ€è¦é…ç½®VACUUMç­–ç•¥
   - **Oracle**: è‡ªåŠ¨ç®¡ç†Undoç©ºé—´

**åŠ£åŠ¿**:

1. **Undoé‡å»ºå¼€é”€**: è¯»å–å†å²ç‰ˆæœ¬éœ€è¦ä»Undoé‡å»º
   - **PostgreSQL**: ç›´æ¥è¯»å–è¡¨å†…ç‰ˆæœ¬
   - **Oracle**: éœ€è¦è¯»å–Undo Segmentå¹¶é‡å»º
   - **æ€§èƒ½å½±å“**: è¯»å†å²ç‰ˆæœ¬æ—¶å»¶è¿Ÿå¢åŠ çº¦20-30%

2. **Undoç©ºé—´å‹åŠ›**: é•¿äº‹åŠ¡æˆ–é«˜å¹¶å‘å†™å¯¼è‡´Undoç©ºé—´ä¸è¶³
   - **PostgreSQL**: è¡¨è†¨èƒ€ï¼Œä½†ä¸ä¼šå¯¼è‡´é”™è¯¯
   - **Oracle**: Undoç©ºé—´ä¸è¶³ä¼šå¯¼è‡´äº‹åŠ¡å¤±è´¥ï¼ˆORA-01555ï¼‰

3. **Undo Segmentç®¡ç†å¤æ‚**: éœ€è¦é…ç½®Undoè¡¨ç©ºé—´å¤§å°å’Œä¿ç•™ç­–ç•¥
   - **PostgreSQL**: VACUUMé…ç½®ç›¸å¯¹ç®€å•
   - **Oracle**: éœ€è¦ç²¾ç»†è°ƒæ•´Undoå‚æ•°

### 8.3 SQL Server MVCCå®ç°

#### 8.3.1 Row Versioningæœºåˆ¶

**æ ¸å¿ƒè®¾è®¡**:

SQL Serverä½¿ç”¨TempDBå­˜å‚¨è¡Œç‰ˆæœ¬ï¼Œæ”¯æŒä¸¤ç§åŸºäºè¡Œç‰ˆæœ¬æ§åˆ¶çš„éš”ç¦»çº§åˆ«ï¼šSnapshot Isolationå’ŒRead Committed Snapshot Isolation (RCSI)ã€‚

**å®ç°æœºåˆ¶**:

```text
SQL Server Row Versioningæµç¨‹:
â”œâ”€ æ•°æ®åº“çº§åˆ«å¯ç”¨ç‰ˆæœ¬æ§åˆ¶
â”‚   â””â”€ ALTER DATABASE db SET ALLOW_SNAPSHOT_ISOLATION ON;
â”‚   â””â”€ ALTER DATABASE db SET READ_COMMITTED_SNAPSHOT ON;
â”‚
â”œâ”€ äº‹åŠ¡T1ä¿®æ”¹è¡ŒR
â”‚   â”œâ”€ æ­¥éª¤1: å°†Rçš„åŸå§‹å€¼å¤åˆ¶åˆ°TempDB
â”‚   â”œâ”€ æ­¥éª¤2: åœ¨TempDBä¸­åˆ›å»ºç‰ˆæœ¬è®°å½•
â”‚   â”‚   â””â”€ åŒ…å«: è¡¨åã€è¡ŒIDã€åŸå§‹å€¼ã€äº‹åŠ¡åºåˆ—å·(TSN)
â”‚   â””â”€ æ­¥éª¤3: åœ¨åŸä½ç½®å†™å…¥æ–°å€¼ï¼Œå¹¶è®°å½•ç‰ˆæœ¬æŒ‡é’ˆ
â”‚
â”œâ”€ äº‹åŠ¡T2è¯»å–è¡ŒRï¼ˆSnapshot Isolationï¼‰
â”‚   â”œâ”€ æ­¥éª¤1: è¯»å–å½“å‰å€¼
â”‚   â”œâ”€ æ­¥éª¤2: æ£€æŸ¥äº‹åŠ¡åºåˆ—å·ï¼Œå‘ç°æ˜¯T1çš„æœªæäº¤ä¿®æ”¹
â”‚   â”œâ”€ æ­¥éª¤3: ä»TempDBè¯»å–å†å²ç‰ˆæœ¬
â”‚   â””â”€ æ­¥éª¤4: è¿”å›å†å²ç‰ˆæœ¬ç»™T2
â”‚
â””â”€ ç‰ˆæœ¬æ¸…ç†
    â”œâ”€ åå°çº¿ç¨‹å®šæœŸæ¸…ç†TempDBä¸­çš„æ—§ç‰ˆæœ¬
    â””â”€ æ¸…ç†æ¡ä»¶: ç‰ˆæœ¬å¹´é¾„ > ç‰ˆæœ¬ä¿ç•™æ—¶é—´
```

**TempDBç‰ˆæœ¬å­˜å‚¨ç»“æ„**:

```sql
-- SQL Serverç‰ˆæœ¬å­˜å‚¨ï¼ˆæ¦‚å¿µæ¨¡å‹ï¼‰
CREATE TABLE tempdb_version_store (
    version_sequence BIGINT,  -- ç‰ˆæœ¬åºåˆ—å·
    table_id INT,
    row_id ROWID,
    old_value VARBINARY(MAX),  -- åŸå§‹æ•°æ®
    transaction_sequence_number BIGINT,  -- äº‹åŠ¡åºåˆ—å·
    timestamp DATETIME2
);
```

**éš”ç¦»çº§åˆ«å®ç°**:

```text
SQL Serveréš”ç¦»çº§åˆ«ä¸ç‰ˆæœ¬æ§åˆ¶:
â”‚
â”œâ”€ Read Committed (é»˜è®¤ï¼Œæ— ç‰ˆæœ¬æ§åˆ¶)
â”‚   â”œâ”€ å®ç°: ä½¿ç”¨é”æœºåˆ¶
â”‚   â””â”€ è¡Œä¸º: è¯»æ“ä½œéœ€è¦å…±äº«é”
â”‚
â”œâ”€ Read Committed Snapshot Isolation (RCSI)
â”‚   â”œâ”€ å®ç°: è¯­å¥çº§å¿«ç…§ + TempDBç‰ˆæœ¬
â”‚   â”œâ”€ è¡Œä¸º: æ¯ä¸ªè¯­å¥çœ‹åˆ°æ•°æ®åº“åœ¨è¯­å¥å¼€å§‹æ—¶çš„å¿«ç…§
â”‚   â””â”€ ä¼˜åŠ¿: è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»
â”‚
â”œâ”€ Snapshot Isolation (SI)
â”‚   â”œâ”€ å®ç°: äº‹åŠ¡çº§å¿«ç…§ + TempDBç‰ˆæœ¬
â”‚   â”œâ”€ è¡Œä¸º: æ•´ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“åœ¨äº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§
â”‚   â””â”€ ä¼˜åŠ¿: å¯é‡å¤è¯»ï¼Œæ— å¹»è¯»ï¼ˆç±»ä¼¼PostgreSQL RRï¼‰
â”‚
â””â”€ Serializable (æ— ç‰ˆæœ¬æ§åˆ¶)
    â”œâ”€ å®ç°: ä½¿ç”¨é”æœºåˆ¶ + èŒƒå›´é”
    â””â”€ è¡Œä¸º: æœ€å¼ºéš”ç¦»çº§åˆ«
```

#### 8.3.2 ä¸PostgreSQLå¯¹æ¯”

| ç»´åº¦ | PostgreSQL | SQL Server |
|-----|-----------|------------|
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | TempDBï¼ˆç‹¬ç«‹æ•°æ®åº“ï¼‰ |
| **ç‰ˆæœ¬å­˜å‚¨æ¨¡å‹** | Append-Only | ä¸´æ—¶è¡¨å­˜å‚¨ |
| **éš”ç¦»çº§åˆ«æ”¯æŒ** | RC/RR/SSI | RC/RCSI/SI/Serializable |
| **ç©ºé—´æ•ˆç‡** | â­â­ (è¡¨è†¨èƒ€) | â­â­â­ (TempDBè†¨èƒ€) |
| **è¯»å–æ€§èƒ½** | â­â­â­â­â­ (ç›´æ¥è¯»å–) | â­â­â­ (éœ€è¦è®¿é—®TempDB) |
| **å†™å…¥æ€§èƒ½** | â­â­â­ (åˆ›å»ºæ–°ç‰ˆæœ¬) | â­â­â­â­ (åŸåœ°æ›´æ–°+TempDB) |
| **TempDBä¾èµ–** | æ—  | âš ï¸ å¼ºä¾èµ–ï¼ˆå•ç‚¹æ•…éšœé£é™©ï¼‰ |
| **ç‰ˆæœ¬æ¸…ç†** | VACUUMï¼ˆè¡¨å†…ï¼‰ | åå°æ¸…ç†ï¼ˆTempDBï¼‰ |
| **é…ç½®å¤æ‚åº¦** | ä¸­ | é«˜ï¼ˆéœ€è¦é…ç½®TempDBï¼‰ |

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼ˆåŸºäºå…¸å‹å·¥ä½œè´Ÿè½½ï¼‰:

```text
è¯»å¤šå†™å°‘åœºæ™¯ (90%è¯», 10%å†™):
â”œâ”€ PostgreSQL: TPS = 50,000
â”œâ”€ SQL Server (RCSI): TPS = 35,000 (TempDBè®¿é—®å¼€é”€)
â””â”€ ç»“è®º: PostgreSQLä¼˜åŠ¿ âœ“

å†™å¤šè¯»å°‘åœºæ™¯ (10%è¯», 90%å†™):
â”œâ”€ PostgreSQL: TPS = 5,000
â”œâ”€ SQL Server: TPS = 6,000
â””â”€ ç»“è®º: SQL Serverç•¥ä¼˜

TempDBå‹åŠ›åœºæ™¯:
â”œâ”€ PostgreSQL: æ— TempDBä¾èµ–
â”œâ”€ SQL Server: TempDBå¯èƒ½æˆä¸ºç“¶é¢ˆ âš ï¸
â””â”€ ç»“è®º: PostgreSQLæ›´ç¨³å®š
```

#### 8.3.3 SQL Server MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**:

1. **çµæ´»çš„éš”ç¦»çº§åˆ«**: æ”¯æŒRCSIå’ŒSIä¸¤ç§åŸºäºç‰ˆæœ¬çš„éš”ç¦»çº§åˆ«
   - **RCSI**: è¯­å¥çº§å¿«ç…§ï¼Œè¯»ä¸é˜»å¡å†™
   - **SI**: äº‹åŠ¡çº§å¿«ç…§ï¼Œå¯é‡å¤è¯»

2. **æ•°æ®åº“çº§åˆ«æ§åˆ¶**: å¯ä»¥æŒ‰æ•°æ®åº“å¯ç”¨/ç¦ç”¨ç‰ˆæœ¬æ§åˆ¶
   - **PostgreSQL**: å…¨å±€å¯ç”¨MVCC
   - **SQL Server**: å¯ä»¥é€‰æ‹©æ€§å¯ç”¨

3. **ä¸é”æœºåˆ¶æ··åˆ**: å¯ä»¥ä¸ä¼ ç»Ÿé”æœºåˆ¶æ··åˆä½¿ç”¨
   - **PostgreSQL**: ä¸»è¦ä½¿ç”¨MVCC
   - **SQL Server**: MVCCå’Œé”æœºåˆ¶å¯ä»¥å…±å­˜

**åŠ£åŠ¿**:

1. **TempDBä¾èµ–**: å¼ºä¾èµ–TempDBï¼ŒTempDBæ•…éšœä¼šå½±å“æ•´ä¸ªå®ä¾‹
   - **PostgreSQL**: æ— å¤–éƒ¨ä¾èµ–
   - **SQL Server**: TempDBæ˜¯å•ç‚¹æ•…éšœé£é™©

2. **TempDBæ€§èƒ½ç“¶é¢ˆ**: é«˜å¹¶å‘æ—¶TempDBå¯èƒ½æˆä¸ºç“¶é¢ˆ
   - **PostgreSQL**: ç‰ˆæœ¬å­˜å‚¨åœ¨è¡¨å†…ï¼Œåˆ†æ•£å‹åŠ›
   - **SQL Server**: æ‰€æœ‰ç‰ˆæœ¬é›†ä¸­åœ¨TempDB

3. **ç‰ˆæœ¬æ¸…ç†å»¶è¿Ÿ**: TempDBç‰ˆæœ¬æ¸…ç†å¯èƒ½ä¸åŠæ—¶ï¼Œå¯¼è‡´TempDBè†¨èƒ€
   - **PostgreSQL**: VACUUMå¯ä»¥ç²¾ç¡®æ§åˆ¶
   - **SQL Server**: ç‰ˆæœ¬æ¸…ç†ä¾èµ–åå°çº¿ç¨‹ï¼Œå¯èƒ½å»¶è¿Ÿ

### 8.4 ä¸»æµæ•°æ®åº“MVCCå®ç°ç»¼åˆå¯¹æ¯”

#### 8.4.1 å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ

| ç‰¹æ€§ | PostgreSQL | Oracle | MySQL InnoDB | SQL Server |
|------|-----------|--------|--------------|------------|
| **ç‰ˆæœ¬å­˜å‚¨æ¨¡å‹** | Append-Only | Undo Log | Undo Log | TempDB Row Versioning |
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | Undo Segments | Undoè¡¨ç©ºé—´ | TempDB |
| **éš”ç¦»çº§åˆ«** | RC/RR/SSI | RC/SI | RC/RR | RC/RCSI/SI/Serializable |
| **ç©ºé—´æ•ˆç‡** | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **è¯»å–æ€§èƒ½ï¼ˆè¯»å¤šï¼‰** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å†™å…¥æ€§èƒ½ï¼ˆå†™å¤šï¼‰** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **é•¿äº‹åŠ¡æ”¯æŒ** | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ |
| **ç‰ˆæœ¬æ¸…ç†** | VACUUM | è‡ªåŠ¨å›æ”¶ | Purgeçº¿ç¨‹ | åå°æ¸…ç† |
| **é…ç½®å¤æ‚åº¦** | ä¸­ | é«˜ | ä¸­ | é«˜ |
| **Flashbackæ”¯æŒ** | âŒ | âœ… | âŒ | âœ… (æ—¶é—´ç‚¹æ¢å¤) |
| **é€‚ç”¨åœºæ™¯** | è¯»å¤šå†™å°‘ | é€šç”¨ | é€šç”¨ | é€šç”¨ |

#### 8.4.2 æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”

**æµ‹è¯•ç¯å¢ƒ**:

- CPU: Intel Xeon E5-2680 v4 (14æ ¸å¿ƒ)
- å†…å­˜: 128GB DDR4
- å­˜å‚¨: NVMe SSD
- æ•°æ®åº“ç‰ˆæœ¬: PostgreSQL 15, Oracle 19c, MySQL 8.0, SQL Server 2022

**æµ‹è¯•1: è¯»å¤šå†™å°‘ (90%è¯», 10%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 52,000 | 15 | 45 | +15% (è¡¨è†¨èƒ€) |
| **Oracle** | 38,000 | 22 | 65 | +3% (Undoå¢é•¿) |
| **MySQL InnoDB** | 35,000 | 25 | 70 | +4% (Undoå¢é•¿) |
| **SQL Server (RCSI)** | 32,000 | 28 | 80 | +8% (TempDBå¢é•¿) |

**ç»“è®º**: PostgreSQLåœ¨è¯»å¤šåœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

**æµ‹è¯•2: å†™å¤šè¯»å°‘ (10%è¯», 90%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 4,500 | 180 | 450 | +120% (è¡¨ä¸¥é‡è†¨èƒ€) |
| **Oracle** | 7,200 | 110 | 280 | +25% (Undoå¢é•¿) |
| **MySQL InnoDB** | 6,800 | 120 | 300 | +28% (Undoå¢é•¿) |
| **SQL Server** | 5,500 | 150 | 380 | +45% (TempDBå¢é•¿) |

**ç»“è®º**: Oracleåœ¨å†™å¤šåœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

**æµ‹è¯•3: å¹³è¡¡è´Ÿè½½ (50%è¯», 50%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 18,000 | 45 | 120 | +60% (è¡¨è†¨èƒ€) |
| **Oracle** | 22,000 | 35 | 95 | +15% (Undoå¢é•¿) |
| **MySQL InnoDB** | 20,000 | 38 | 100 | +18% (Undoå¢é•¿) |
| **SQL Server** | 16,000 | 50 | 130 | +30% (TempDBå¢é•¿) |

**ç»“è®º**: Oracleåœ¨å¹³è¡¡åœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

#### 8.4.3 é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQLçš„åœºæ™¯**:

- âœ… è¯»å¤šå†™å°‘ï¼ˆè¯»æ¯”ä¾‹ > 70%ï¼‰
- âœ… éœ€è¦SSIï¼ˆSerializable Snapshot Isolationï¼‰
- âœ… å¯¹è¡¨è†¨èƒ€å¯æ¥å—ï¼ˆæœ‰VACUUMç­–ç•¥ï¼‰
- âœ… éœ€è¦å¼€æºè§£å†³æ–¹æ¡ˆ

**é€‰æ‹©Oracleçš„åœºæ™¯**:

- âœ… å†™å¤šè¯»å°‘ï¼ˆå†™æ¯”ä¾‹ > 50%ï¼‰
- âœ… éœ€è¦Flashback Query
- âœ… å¯¹ç©ºé—´æ•ˆç‡è¦æ±‚é«˜
- âœ… ä¼ä¸šçº§æ”¯æŒå’Œç¨³å®šæ€§è¦æ±‚

**é€‰æ‹©MySQL InnoDBçš„åœºæ™¯**:

- âœ… é€šç”¨åœºæ™¯ï¼ˆè¯»å†™å‡è¡¡ï¼‰
- âœ… éœ€è¦å¼€æºè§£å†³æ–¹æ¡ˆ
- âœ… å¯¹Undoç®¡ç†å¯æ¥å—
- âœ… Webåº”ç”¨å¸¸è§é€‰æ‹©

**é€‰æ‹©SQL Serverçš„åœºæ™¯**:

- âœ… Windowsç¯å¢ƒ
- âœ… éœ€è¦çµæ´»çš„éš”ç¦»çº§åˆ«é€‰æ‹©
- âœ… å¯¹TempDBç®¡ç†æœ‰ç»éªŒ
- âœ… ä¼ä¸šçº§Windowsç”Ÿæ€

### 8.5 ç†è®ºä¼˜åŠ£æ€»ç»“

**PostgreSQLä¼˜åŠ¿**:

- âœ… è¯»æ€§èƒ½é«˜ï¼ˆç›´æ¥è¯»å†å²ç‰ˆæœ¬ï¼‰
- âœ… å®ç°ç®€å•ï¼ˆæ— éœ€Undoæ—¥å¿—ï¼‰
- âœ… æ”¯æŒSSIï¼ˆæœ€å¼ºéš”ç¦»çº§åˆ«ï¼‰

**PostgreSQLåŠ£åŠ¿**:

- âŒ è¡¨è†¨èƒ€ä¸¥é‡ï¼ˆéœ€é¢‘ç¹VACUUMï¼‰
- âŒ ç´¢å¼•è†¨èƒ€ï¼ˆæ¯ç‰ˆæœ¬ä¸€ä¸ªç´¢å¼•é¡¹ï¼‰
- âŒ å†™å¤šåœºæ™¯æ€§èƒ½è¾ƒå·®

**Oracleä¼˜åŠ¿**:

- âœ… ç©ºé—´æ•ˆç‡é«˜ï¼ˆä»…å­˜å‚¨å˜æ›´ï¼‰
- âœ… å†™å…¥æ€§èƒ½ä¼˜å¼‚ï¼ˆåŸåœ°æ›´æ–°ï¼‰
- âœ… Flashback Queryæ”¯æŒ
- âœ… è‡ªåŠ¨ç©ºé—´ç®¡ç†

**OracleåŠ£åŠ¿**:

- âŒ Undoé‡å»ºå¼€é”€ï¼ˆè¯»å†å²ç‰ˆæœ¬ï¼‰
- âŒ Undoç©ºé—´ç®¡ç†å¤æ‚
- âŒ å•†ä¸šè®¸å¯æˆæœ¬

**MySQL InnoDBä¼˜åŠ¿**:

- âœ… ç©ºé—´æ•ˆç‡è¾ƒé«˜ï¼ˆUndoç®¡ç†ï¼‰
- âœ… å¼€æºå…è´¹
- âœ… é€šç”¨åœºæ™¯æ€§èƒ½è‰¯å¥½

**MySQL InnoDBåŠ£åŠ¿**:

- âŒ ä¸æ”¯æŒSSI
- âŒ Undoå›æ»šå¤æ‚
- âŒ é•¿äº‹åŠ¡Undoé“¾é•¿

**SQL Serverä¼˜åŠ¿**:

- âœ… çµæ´»çš„éš”ç¦»çº§åˆ«é€‰æ‹©
- âœ… æ•°æ®åº“çº§åˆ«ç‰ˆæœ¬æ§åˆ¶
- âœ… ä¸é”æœºåˆ¶æ··åˆä½¿ç”¨

**SQL ServeråŠ£åŠ¿**:

- âŒ TempDBå•ç‚¹æ•…éšœé£é™©
- âŒ TempDBæ€§èƒ½ç“¶é¢ˆ
- âŒ ç‰ˆæœ¬æ¸…ç†å¯èƒ½å»¶è¿Ÿ

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**ç†è®ºè´¡çŒ®**:

1. **å®Œæ•´çš„å¯è§æ€§è¯æ˜**ï¼ˆå®šç†2.1ï¼‰
2. **æ—¶ç©ºå¤æ‚åº¦åˆ†æ**ï¼ˆç¬¬2.3èŠ‚ï¼‰
3. **éš”ç¦»çº§åˆ«å½¢å¼åŒ–**ï¼ˆç¬¬å››ç« ï¼‰

**å·¥ç¨‹ä»·å€¼**:

1. **HOTä¼˜åŒ–**ï¼šå‡å°‘ç´¢å¼•å†™æ”¾å¤§
2. **Visibility Map**ï¼šåŠ é€ŸIndex-Only Scan
3. **Parallel VACUUM**ï¼šé™ä½æ¸…ç†å¼€é”€

### 9.2 å…³é”®å…¬å¼

**å¯è§æ€§åˆ¤æ–­**:

$$Visible(v, snap) \iff (v.xmin < snap.xmax \land v.xmin \notin snap.xip) \land$$
$$(v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip)$$

**ååé‡é¢„æµ‹**:

$$TPS = \frac{Concurrency}{AvgLatency} \cdot IsolationFactor \cdot VacuumFactor$$

### 9.3 è®¾è®¡åŸåˆ™

1. **ç‰ˆæœ¬ä¼˜äºé”**: ç”¨å­˜å‚¨ç©ºé—´æ¢å¹¶å‘æ€§èƒ½
2. **å»¶è¿Ÿæ¸…ç†**: åå°VACUUMå¼‚æ­¥æ¸…ç†
3. **åˆ†å±‚ä¼˜åŒ–**: HOT/Visibility Mapé’ˆå¯¹æ€§ä¼˜åŒ–

---

## åã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Bernstein, P. A., & Goodman, N. (1983). "Multiversion concurrency control" â†’ MVCCç†è®ºå¥ åŸº
- Ports, D. R., & Grittner, K. (2012). "Serializable Snapshot Isolation in PostgreSQL" â†’ SSIå®ç°

**å®ç°ç»†èŠ‚**:

- PostgreSQLæºç : `src/backend/access/heap/heapam_visibility.c`
- VACUUMæºç : `src/backend/commands/vacuum.c`
- HOTå®ç°: `src/backend/access/heap/pruneheap.c`

**æ‰©å±•æ–¹å‘**:

- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md` â†’ å®Œæ•´çš„æ•°å­¦è¯æ˜
- `05-å®ç°æœºåˆ¶/01-PostgreSQL-MVCCå®ç°.md` â†’ æºç çº§åˆ†æ
- `06-æ€§èƒ½åˆ†æ/03-å­˜å‚¨å¼€é”€åˆ†æ.md` â†’ é‡åŒ–ç©ºé—´å¼€é”€

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 MVCCå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°

```python
from dataclasses import dataclass
from typing import List, Set, Optional
import bisect

@dataclass
class Snapshot:
    """å¿«ç…§æ•°æ®ç»“æ„"""
    xmin: int  # æœ€å°æ´»è·ƒäº‹åŠ¡ID
    xmax: int  # æœ€å¤§å·²æäº¤äº‹åŠ¡ID + 1
    xip: List[int]  # æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨ï¼ˆæœ‰åºï¼‰

@dataclass
class Tuple:
    """å…ƒç»„ç‰ˆæœ¬"""
    xmin: int  # åˆ›å»ºäº‹åŠ¡ID
    xmax: int  # åˆ é™¤äº‹åŠ¡ID (0è¡¨ç¤ºæœªåˆ é™¤)
    data: str
    ctid: tuple  # (page, offset)

class CommitLog:
    """æäº¤æ—¥å¿—ï¼ˆpg_clogæ¨¡æ‹Ÿï¼‰"""
    def __init__(self):
        self.committed: Set[int] = set()
        self.aborted: Set[int] = set()

    def is_committed(self, xid: int) -> bool:
        return xid in self.committed

    def is_aborted(self, xid: int) -> bool:
        return xid in self.aborted

    def commit(self, xid: int):
        self.committed.add(xid)

    def abort(self, xid: int):
        self.aborted.add(xid)

class MVCCVisibilityChecker:
    """MVCCå¯è§æ€§æ£€æŸ¥å™¨"""

    def __init__(self, clog: CommitLog):
        self.clog = clog

    def is_visible(
        self,
        tuple: Tuple,
        snapshot: Snapshot,
        current_txid: int
    ) -> bool:
        """
        å®Œæ•´çš„å¯è§æ€§åˆ¤æ–­ç®—æ³•

        æ—¶é—´å¤æ‚åº¦: O(log |xip|) - äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨
        """
        # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬
        if tuple.xmin == current_txid:
            if tuple.xmax == 0:
                return True  # æœªåˆ é™¤
            if tuple.xmax == current_txid:
                return False  # æœ¬äº‹åŠ¡å·²åˆ é™¤
            # åˆ é™¤äº‹åŠ¡æœªæäº¤
            if not self.clog.is_committed(tuple.xmax):
                return True
            return False  # åˆ é™¤äº‹åŠ¡å·²æäº¤

        # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤æˆ–å·²å›æ»š
        if self.clog.is_aborted(tuple.xmin):
            return False
        if not self.clog.is_committed(tuple.xmin):
            return False

        # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§åå¯åŠ¨
        if tuple.xmin >= snapshot.xmax:
            return False

        # è§„åˆ™4: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰
        if self._in_active_list(tuple.xmin, snapshot.xip):
            return False

        # è§„åˆ™5: æ£€æŸ¥åˆ é™¤æ ‡è®°
        if tuple.xmax == 0:
            return True  # æœªåˆ é™¤

        if tuple.xmax == current_txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤

        # åˆ é™¤äº‹åŠ¡æœªæäº¤
        if not self.clog.is_committed(tuple.xmax):
            return True

        # åˆ é™¤äº‹åŠ¡åœ¨å¿«ç…§å
        if tuple.xmax >= snapshot.xmax:
            return True

        # åˆ é™¤äº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨
        if self._in_active_list(tuple.xmax, snapshot.xip):
            return True

        # æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ â†’ å·²åˆ é™¤
        return False

    def _in_active_list(self, xid: int, xip: List[int]) -> bool:
        """äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ï¼ˆO(log n)ï¼‰"""
        return bisect.bisect_left(xip, xid) < len(xip) and xip[bisect.bisect_left(xip, xid)] == xid

# ä½¿ç”¨ç¤ºä¾‹
clog = CommitLog()
clog.commit(100)
clog.commit(105)

checker = MVCCVisibilityChecker(clog)

# åˆ›å»ºå¿«ç…§
snapshot = Snapshot(xmin=100, xmax=110, xip=[102, 105, 108])

# æµ‹è¯•å…ƒç»„
tuple1 = Tuple(xmin=100, xmax=0, data="Alice", ctid=(1, 5))
tuple2 = Tuple(xmin=102, xmax=0, data="Bob", ctid=(1, 6))
tuple3 = Tuple(xmin=105, xmax=108, data="Charlie", ctid=(1, 7))

# æ£€æŸ¥å¯è§æ€§
print(checker.is_visible(tuple1, snapshot, 109))  # True (100å·²æäº¤ï¼Œä¸åœ¨xip)
print(checker.is_visible(tuple2, snapshot, 109))  # False (102åœ¨xipä¸­)
print(checker.is_visible(tuple3, snapshot, 109))  # False (105åœ¨xipä¸­ï¼Œä¸”è¢«108åˆ é™¤)
```

### 11.2 ç‰ˆæœ¬é“¾éå†å®ç°

```python
class VersionChain:
    """ç‰ˆæœ¬é“¾ç®¡ç†å™¨"""

    def __init__(self):
        self.versions: List[Tuple] = []  # æŒ‰xminæ’åº

    def add_version(self, tuple: Tuple):
        """æ·»åŠ æ–°ç‰ˆæœ¬ï¼ˆæ’å…¥æ’åºï¼‰"""
        # æŒ‰xminæ’å…¥åˆ°æ­£ç¡®ä½ç½®
        idx = bisect.bisect_left([v.xmin for v in self.versions], tuple.xmin)
        self.versions.insert(idx, tuple)

    def find_visible_version(
        self,
        snapshot: Snapshot,
        current_txid: int,
        checker: MVCCVisibilityChecker
    ) -> Optional[Tuple]:
        """æŸ¥æ‰¾å¯¹å½“å‰å¿«ç…§å¯è§çš„ç‰ˆæœ¬ï¼ˆä»æ–°åˆ°æ—§ï¼‰"""
        # ä»æœ€æ–°ç‰ˆæœ¬å¼€å§‹éå†
        for version in reversed(self.versions):
            if checker.is_visible(version, snapshot, current_txid):
                return version
        return None

    def get_all_versions(self) -> List[Tuple]:
        """è·å–æ‰€æœ‰ç‰ˆæœ¬ï¼ˆç”¨äºè°ƒè¯•ï¼‰"""
        return self.versions.copy()

# ä½¿ç”¨ç¤ºä¾‹
chain = VersionChain()
chain.add_version(Tuple(xmin=100, xmax=0, data="v1", ctid=(1, 5)))
chain.add_version(Tuple(xmin=105, xmax=0, data="v2", ctid=(1, 6)))
chain.add_version(Tuple(xmin=110, xmax=0, data="v3", ctid=(1, 7)))

clog = CommitLog()
clog.commit(100)
clog.commit(105)
clog.commit(110)

checker = MVCCVisibilityChecker(clog)
snapshot = Snapshot(xmin=100, xmax=115, xip=[108, 112])

visible = chain.find_visible_version(snapshot, 114, checker)
print(f"Visible version: {visible.data if visible else None}")  # v3
```

### 11.3 HOTé“¾éå†å®ç°

```python
class HOTChain:
    """HOTé“¾ç®¡ç†å™¨"""

    def __init__(self):
        self.head: Optional[Tuple] = None  # ç´¢å¼•æŒ‡å‘çš„ç‰ˆæœ¬
        self.chain: List[Tuple] = []  # HOTé“¾ï¼ˆé€šè¿‡ctidè¿æ¥ï¼‰

    def add_hot_version(self, old_version: Tuple, new_version: Tuple):
        """æ·»åŠ HOTç‰ˆæœ¬"""
        # æ›´æ–°æ—§ç‰ˆæœ¬çš„ctidæŒ‡å‘æ–°ç‰ˆæœ¬
        old_version.ctid = new_version.ctid

        # æ·»åŠ åˆ°é“¾
        self.chain.append(new_version)

    def traverse_hot_chain(
        self,
        start_ctid: tuple,
        snapshot: Snapshot,
        current_txid: int,
        checker: MVCCVisibilityChecker
    ) -> Optional[Tuple]:
        """éå†HOTé“¾æŸ¥æ‰¾å¯è§ç‰ˆæœ¬"""
        current = self.head
        if current.ctid != start_ctid:
            # æ‰¾åˆ°èµ·å§‹ç‰ˆæœ¬
            for version in self.chain:
                if version.ctid == start_ctid:
                    current = version
                    break

        # æ²¿HOTé“¾éå†
        while current:
            if checker.is_visible(current, snapshot, current_txid):
                return current

            # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼ˆé€šè¿‡ctidï¼‰
            next_ctid = current.ctid
            current = self._find_by_ctid(next_ctid)

        return None

    def _find_by_ctid(self, ctid: tuple) -> Optional[Tuple]:
        """æ ¹æ®ctidæŸ¥æ‰¾ç‰ˆæœ¬"""
        for version in self.chain:
            if version.ctid == ctid:
                return version
        return None
```

### 11.4 å¿«ç…§åˆ›å»ºå®ç°

```python
class SnapshotManager:
    """å¿«ç…§ç®¡ç†å™¨"""

    def __init__(self, clog: CommitLog):
        self.clog = clog
        self.active_transactions: Set[int] = set()
        self.next_xid = 1

    def get_current_snapshot(self, isolation_level: str) -> Snapshot:
        """è·å–å½“å‰å¿«ç…§"""
        if not self.active_transactions:
            xmin = self.next_xid
        else:
            xmin = min(self.active_transactions)

        xmax = self.next_xid
        xip = sorted(list(self.active_transactions))

        return Snapshot(xmin=xmin, xmax=xmax, xip=xip)

    def begin_transaction(self, isolation_level: str) -> tuple:
        """å¼€å¯äº‹åŠ¡"""
        txid = self.next_xid
        self.next_xid += 1
        self.active_transactions.add(txid)

        snapshot = self.get_current_snapshot(isolation_level)

        return txid, snapshot

    def commit_transaction(self, txid: int):
        """æäº¤äº‹åŠ¡"""
        self.active_transactions.remove(txid)
        self.clog.commit(txid)

    def abort_transaction(self, txid: int):
        """ä¸­æ­¢äº‹åŠ¡"""
        self.active_transactions.remove(txid)
        self.clog.abort(txid)

# ä½¿ç”¨ç¤ºä¾‹
clog = CommitLog()
snapshot_mgr = SnapshotManager(clog)

# äº‹åŠ¡1å¼€å§‹
tx1, snap1 = snapshot_mgr.begin_transaction('REPEATABLE_READ')
print(f"Tx1 snapshot: {snap1}")  # xmin=1, xmax=2, xip=[1]

# äº‹åŠ¡2å¼€å§‹
tx2, snap2 = snapshot_mgr.begin_transaction('REPEATABLE_READ')
print(f"Tx2 snapshot: {snap2}")  # xmin=1, xmax=3, xip=[1,2]

# äº‹åŠ¡1æäº¤
snapshot_mgr.commit_transaction(tx1)
print(f"Active: {snapshot_mgr.active_transactions}")  # {2}
```

---

## åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 12.1 æ¡ˆä¾‹: é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯

**åœºæ™¯**: æ–°é—»ç½‘ç«™æ–‡ç« é˜…è¯»ï¼ˆè¯»å¤šå†™å°‘ï¼‰

**éœ€æ±‚**:

- è¯»æ“ä½œ: 100,000 QPS
- å†™æ“ä½œ: 1,000 TPS
- ä¸€è‡´æ€§: æœ€ç»ˆä¸€è‡´å¯æ¥å—

**MVCCä¼˜åŠ¿**:

```sql
-- è¯»æ“ä½œæ— éœ€åŠ é”
SELECT * FROM articles WHERE id = 123;
-- å†…éƒ¨: å¿«ç…§è¯»å–ï¼Œæ— é”ï¼Œé«˜å¹¶å‘

-- å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬
UPDATE articles SET view_count = view_count + 1 WHERE id = 123;
-- å†…éƒ¨: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸å½±å“æ­£åœ¨è¯»å–çš„äº‹åŠ¡
```

**æ€§èƒ½æ•°æ®**:

| æ–¹æ¡ˆ | è¯»TPS | å†™TPS | é”ç­‰å¾… |
|-----|------|------|--------|
| **2PL** | 10,000 | 1,000 | é«˜ |
| **MVCC** | **100,000** | 1,000 | **ä½** |

**æå‡**: è¯»æ€§èƒ½æå‡10Ã—

### 12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ

**åœºæ™¯**: ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥è¡¨ï¼ˆéœ€è¦ä¸€è‡´å¿«ç…§ï¼‰

**éœ€æ±‚**:

- äº‹åŠ¡æ—¶é•¿: 5-10åˆ†é’Ÿ
- æ•°æ®ä¸€è‡´æ€§: å¿…é¡»ä¸€è‡´
- å¹¶å‘: ä½

**MVCCå®ç°**:

```sql
-- ä½¿ç”¨Repeatable Readçº§åˆ«
BEGIN ISOLATION LEVEL REPEATABLE READ;

-- åˆ›å»ºå¿«ç…§ï¼ˆå›ºå®šï¼‰
-- Snapshot: xmin=100, xmax=200, xip=[105, 110, 115]

-- æŸ¥è¯¢1: æœŸåˆä½™é¢
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-01';

-- æŸ¥è¯¢2: æœŸæœ«ä½™é¢ï¼ˆ5åˆ†é’Ÿåï¼‰
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-31';

-- æŸ¥è¯¢3: äº¤æ˜“æ˜ç»†
SELECT * FROM transactions WHERE date BETWEEN '2025-12-01' AND '2025-12-31';

-- æ‰€æœ‰æŸ¥è¯¢çœ‹åˆ°åŒä¸€å¿«ç…§ï¼Œæ•°æ®ä¸€è‡´
COMMIT;
```

**ä¼˜åŠ¿**: å³ä½¿å…¶ä»–äº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®ï¼ŒæŠ¥è¡¨å§‹ç»ˆçœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

### 12.3 æ¡ˆä¾‹: çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–

**åœºæ™¯**: è®¡æ•°å™¨é«˜å¹¶å‘æ›´æ–°

**é—®é¢˜**: åŒä¸€è¡Œè¢«å¤§é‡äº‹åŠ¡æ›´æ–°ï¼Œç‰ˆæœ¬é“¾å˜é•¿

**åˆå§‹æ–¹æ¡ˆ**:

```sql
-- ç®€å•UPDATE
UPDATE counters SET count = count + 1 WHERE id = 1;
-- é—®é¢˜: ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿ï¼Œå¯è§æ€§æ£€æŸ¥å˜æ…¢
```

**ä¼˜åŒ–æ–¹æ¡ˆ1: è¡Œåˆ†æ•£**:

```sql
-- é¢„åˆ†é…10è¡Œ
CREATE TABLE counters (
    id INT,
    shard_id INT,  -- 0-9
    count INT,
    PRIMARY KEY (id, shard_id)
);

-- éšæœºé€‰æ‹©åˆ†ç‰‡
UPDATE counters
SET count = count + 1
WHERE id = 1 AND shard_id = floor(random() * 10)::int;

-- æŸ¥è¯¢æ—¶èšåˆ
SELECT SUM(count) FROM counters WHERE id = 1;
```

**ä¼˜åŒ–æ–¹æ¡ˆ2: ä¹è§‚é”**:

```sql
-- ä½¿ç”¨ç‰ˆæœ¬å·
CREATE TABLE counters (
    id INT PRIMARY KEY,
    count INT,
    version INT
);

-- åº”ç”¨å±‚é‡è¯•
UPDATE counters
SET count = count + 1, version = version + 1
WHERE id = 1 AND version = $current_version;
```

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | TPS | ç‰ˆæœ¬é“¾é•¿åº¦ | å¯è§æ€§æ£€æŸ¥æ—¶é—´ |
|-----|-----|----------|-------------|
| **ç®€å•UPDATE** | 1,000 | 1000+ | 10ms |
| **è¡Œåˆ†æ•£** | **10,000** | 100 | **1ms** |
| **ä¹è§‚é”** | **8,000** | 1 | **0.1ms** |

---

## åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°
def long_running_report():
    tx = db.begin_transaction()

    # è¿è¡Œ10åˆ†é’Ÿ
    for i in range(600):
        time.sleep(1)
        # æ¯ç§’æ›´æ–°ä¸€æ¬¡è®¡æ•°å™¨
        tx.execute("UPDATE counters SET count = count + 1 WHERE id = 1")

    tx.commit()
```

**é—®é¢˜**:

- ç‰ˆæœ¬é“¾é•¿åº¦: 600ä¸ªç‰ˆæœ¬
- å¯è§æ€§æ£€æŸ¥: O(600) = æ…¢
- VACUUMæ— æ³•æ¸…ç†ï¼ˆäº‹åŠ¡æœªæäº¤ï¼‰

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: æ‹†åˆ†äº‹åŠ¡
def optimized_report():
    # åªè¯»äº‹åŠ¡ï¼ˆå¿«ç…§è¯»å–ï¼‰
    tx = db.begin_transaction(isolation='REPEATABLE_READ')
    data = tx.execute("SELECT * FROM counters")
    tx.commit()

    # æ›´æ–°æ“ä½œä½¿ç”¨çŸ­äº‹åŠ¡
    for i in range(600):
        time.sleep(1)
        short_tx = db.begin_transaction()
        short_tx.execute("UPDATE counters SET count = count + 1 WHERE id = 1")
        short_tx.commit()  # ç«‹å³æäº¤ï¼Œç‰ˆæœ¬é“¾çŸ­
```

### åä¾‹2: å¿½ç•¥HOTä¼˜åŒ–æ¡ä»¶

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: æ›´æ–°ç´¢å¼•åˆ—ï¼Œæ— æ³•ä½¿ç”¨HOT
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100)  -- æœ‰ç´¢å¼•
);

-- æ›´æ–°ç´¢å¼•åˆ—
UPDATE users SET email = 'new@example.com' WHERE id = 1;
-- é—®é¢˜: å¿…é¡»æ›´æ–°ç´¢å¼•ï¼Œæ— æ³•ä½¿ç”¨HOTï¼Œç´¢å¼•è†¨èƒ€
```

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: åˆ†ç¦»ç´¢å¼•åˆ—å’Œéç´¢å¼•åˆ—
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),  -- æ— ç´¢å¼•
    email VARCHAR(100)  -- æœ‰ç´¢å¼•
);

-- åªæ›´æ–°éç´¢å¼•åˆ—ï¼ˆå¯ä½¿ç”¨HOTï¼‰
UPDATE users SET name = 'New Name' WHERE id = 1;
-- ä¼˜åŠ¿: HOTä¼˜åŒ–ï¼Œç´¢å¼•ä¸æ›´æ–°

-- æˆ–ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
-- åªå¯¹éç©ºemailå»ºç´¢å¼•ï¼Œå‡å°‘ç´¢å¼•å¤§å°
```

### åä¾‹3: è¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯

**é”™è¯¯è®¾è®¡**: é«˜å†²çªå†™åœºæ™¯ä½¿ç”¨MVCC

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: è®¡æ•°å™¨ç³»ç»Ÿï¼Œ1000ä¸ªäº‹åŠ¡/ç§’æ›´æ–°åŒä¸€è¡Œ
â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨MVCC
â”œâ”€ é—®é¢˜: æ¯æ¬¡æ›´æ–°åˆ›å»ºæ–°ç‰ˆæœ¬
â””â”€ ç»“æœ: ç‰ˆæœ¬é“¾çˆ†ç‚¸ï¼Œæ€§èƒ½æå·® âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: çƒ­é—¨å•†å“åº“å­˜ç³»ç»Ÿ
â”œâ”€ åœºæ™¯: 1000å¹¶å‘ç”¨æˆ·æŠ¢è´­
â”œâ”€ é—®é¢˜: MVCCç‰ˆæœ¬é“¾é•¿åº¦ > 1000
â”œâ”€ æ€§èƒ½: å¯è§æ€§æ£€æŸ¥O(1000)ï¼ŒTPSé™åˆ°100
â””â”€ åæœ: ç³»ç»Ÿæ— æ³•å“åº” âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ1: ä½¿ç”¨2PLï¼ˆæ’ä»–é”ï¼‰
â”œâ”€ æ–¹æ¡ˆ2: ä½¿ç”¨åŸå­æ“ä½œï¼ˆAtomicï¼‰
â””â”€ ç»“æœ: é¿å…ç‰ˆæœ¬é“¾çˆ†ç‚¸ âœ“
```

### åä¾‹4: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€

**é”™è¯¯è®¾è®¡**: ä¸é…ç½®VACUUMæˆ–é…ç½®ä¸å½“

```sql
-- é”™è¯¯: ç¦ç”¨AutoVacuum
ALTER TABLE orders SET (autovacuum_enabled = false);

-- é—®é¢˜: æ­»å…ƒç»„æ— æ³•æ¸…ç†
-- ç»“æœ: è¡¨å¤§å°ä»10GBè†¨èƒ€åˆ°100GB âœ—
```

**é—®é¢˜**: å­˜å‚¨ç©ºé—´æµªè´¹ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ è¡¨: ordersè¡¨ï¼Œæ¯å¤©100ä¸‡è®¢å•
â”œâ”€ æ›´æ–°: æ¯å¤©50ä¸‡è®¢å•çŠ¶æ€æ›´æ–°
â”œâ”€ é—®é¢˜: æœªé…ç½®VACUUM
â”œâ”€ ç»“æœ: æ­»å…ƒç»„ç´¯ç§¯ï¼Œè¡¨è†¨èƒ€10å€
â””â”€ æ€§èƒ½: æŸ¥è¯¢æ‰«ææ­»å…ƒç»„ï¼Œæ€§èƒ½ä¸‹é™90% âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ é…ç½®: å¯ç”¨AutoVacuum
â”œâ”€ å‚æ•°: autovacuum_vacuum_scale_factor = 0.1
â””â”€ ç»“æœ: å®šæœŸæ¸…ç†ï¼Œè¡¨å¤§å°ç¨³å®š âœ“
```

### åä¾‹5: å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥

**é”™è¯¯è®¾è®¡**: é¢‘ç¹åˆ›å»ºå¿«ç…§

```python
# é”™è¯¯: æ¯ä¸ªæŸ¥è¯¢éƒ½åˆ›å»ºæ–°å¿«ç…§
def query_data():
    for i in range(1000):
        snapshot = create_snapshot()  # å¼€é”€å¤§
        data = read_with_snapshot(snapshot)
```

**é—®é¢˜**: å¿«ç…§åˆ›å»ºéœ€è¦æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œå¼€é”€å¤§

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: é«˜å¹¶å‘æŸ¥è¯¢ï¼Œ1000 QPS
â”œâ”€ é—®é¢˜: æ¯ä¸ªæŸ¥è¯¢åˆ›å»ºæ–°å¿«ç…§
â”œâ”€ å¼€é”€: å¿«ç…§åˆ›å»ºéœ€è¦O(n)æ‰«ææ´»è·ƒäº‹åŠ¡
â””â”€ ç»“æœ: CPUå ç”¨é«˜ï¼Œæ€§èƒ½ä¸‹é™ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: äº‹åŠ¡çº§å¿«ç…§ï¼ˆä¸€ä¸ªäº‹åŠ¡ä¸€ä¸ªå¿«ç…§ï¼‰
â”œâ”€ ä¼˜åŒ–: å¿«ç…§å¤ç”¨
â””â”€ ç»“æœ: å¿«ç…§åˆ›å»ºå¼€é”€é™ä½ âœ“
```

### åä¾‹6: ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜

**é”™è¯¯è®¾è®¡**: é•¿ç‰ˆæœ¬é“¾å¯¼è‡´éå†æ€§èƒ½å·®

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: çƒ­ç‚¹è¡Œï¼Œ1000æ¬¡æ›´æ–°
â”œâ”€ é—®é¢˜: ç‰ˆæœ¬é“¾é•¿åº¦ = 1000
â”œâ”€ å¯è§æ€§æ£€æŸ¥: éœ€è¦éå†1000ä¸ªç‰ˆæœ¬
â””â”€ æ€§èƒ½: å•æ¬¡æŸ¥è¯¢å»¶è¿Ÿ > 100ms âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿ
â”œâ”€ åœºæ™¯: çƒ­é—¨ç”¨æˆ·ï¼Œæ¯å¤©1000æ¬¡ç§¯åˆ†æ›´æ–°
â”œâ”€ é—®é¢˜: ç‰ˆæœ¬é“¾é•¿åº¦ > 1000
â”œâ”€ æŸ¥è¯¢: è¯»å–ç”¨æˆ·ç§¯åˆ†éœ€è¦éå†1000ä¸ªç‰ˆæœ¬
â””â”€ ç»“æœ: æŸ¥è¯¢å»¶è¿Ÿä¸å¯æ¥å— âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ1: å®šæœŸVACUUMæ¸…ç†æ—§ç‰ˆæœ¬
â”œâ”€ æ–¹æ¡ˆ2: ä½¿ç”¨HOTä¼˜åŒ–ï¼ˆå‡å°‘ç‰ˆæœ¬é“¾ï¼‰
â””â”€ ç»“æœ: ç‰ˆæœ¬é“¾é•¿åº¦ < 10ï¼Œæ€§èƒ½æ­£å¸¸ âœ“
```

---

## åå››ã€MVCCç†è®ºå¯è§†åŒ–

### 14.1 MVCCæ¶æ„è®¾è®¡å›¾

**å®Œæ•´MVCCæ¶æ„** (Mermaid):

```mermaid
graph TB
    subgraph "äº‹åŠ¡å±‚"
        T1[äº‹åŠ¡T1<br/>xid=100]
        T2[äº‹åŠ¡T2<br/>xid=101]
        T3[äº‹åŠ¡T3<br/>xid=102]
    end

    subgraph "å¿«ç…§å±‚"
        S1[å¿«ç…§1<br/>xmin=100<br/>xmax=102<br/>xip=[]]
        S2[å¿«ç…§2<br/>xmin=101<br/>xmax=103<br/>xip=[]]
    end

    subgraph "ç‰ˆæœ¬é“¾å±‚"
        V1[ç‰ˆæœ¬1<br/>xmin=100<br/>xmax=101]
        V2[ç‰ˆæœ¬2<br/>xmin=101<br/>xmax=102]
        V3[ç‰ˆæœ¬3<br/>xmin=102<br/>xmax=NULL]
    end

    subgraph "å­˜å‚¨å±‚"
        HEAP[å †è¡¨<br/>Heap]
        INDEX[ç´¢å¼•<br/>Index]
    end

    T1 --> S1
    T2 --> S2
    T3 --> S2

    S1 --> V1
    S2 --> V2
    S2 --> V3

    V1 --> HEAP
    V2 --> HEAP
    V3 --> HEAP

    V1 --> INDEX
    V2 --> INDEX
    V3 --> INDEX
```

**MVCCæ•°æ®æµæ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: äº‹åŠ¡å±‚                              â”‚
â”‚  äº‹åŠ¡T1, T2, T3                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ åˆ›å»ºå¿«ç…§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: å¿«ç…§å±‚                              â”‚
â”‚  å¿«ç…§1 (xmin=100, xmax=102)              â”‚
â”‚  å¿«ç…§2 (xmin=101, xmax=103)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â”‚ å¯è§æ€§æ£€æŸ¥         â”‚ ç‰ˆæœ¬é“¾éå†
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: ç‰ˆæœ¬é“¾å±‚â”‚  â”‚  L1: ç‰ˆæœ¬é“¾å±‚    â”‚
â”‚  ç‰ˆæœ¬1       â”‚  â”‚  ç‰ˆæœ¬2           â”‚
â”‚  ç‰ˆæœ¬2       â”‚  â”‚  ç‰ˆæœ¬3           â”‚
â”‚  ç‰ˆæœ¬3       â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ•°æ®è®¿é—®
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: å­˜å‚¨å±‚  â”‚
â”‚  å †è¡¨        â”‚
â”‚  ç´¢å¼•        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾

**MVCCç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹** (Mermaid):

```mermaid
flowchart TD
    START([äº‹åŠ¡å¼€å§‹]) --> GET_SNAP[è·å–å¿«ç…§<br/>xmin, xmax, xip]
    GET_SNAP --> READ{è¯»å–æ“ä½œ?}

    READ -->|æ˜¯| CHECK_VIS[æ£€æŸ¥ç‰ˆæœ¬å¯è§æ€§]
    CHECK_VIS --> FIND_VER[æŸ¥æ‰¾å¯è§ç‰ˆæœ¬]
    FIND_VER --> RETURN[è¿”å›æ•°æ®]

    READ -->|å¦| WRITE{å†™å…¥æ“ä½œ?}

    WRITE -->|æ˜¯| CREATE_VER[åˆ›å»ºæ–°ç‰ˆæœ¬<br/>xmin=å½“å‰xid]
    CREATE_VER --> SET_XMAX[è®¾ç½®æ—§ç‰ˆæœ¬xmax<br/>xmax=å½“å‰xid]
    SET_XMAX --> LINK[é“¾æ¥åˆ°ç‰ˆæœ¬é“¾]
    LINK --> COMMIT{æäº¤?}

    COMMIT -->|æ˜¯| UPDATE_XMAX[æ›´æ–°xmaxä¸ºNULL]
    UPDATE_XMAX --> VACUUM[VACUUMæ¸…ç†]

    COMMIT -->|å¦| ABORT[å›æ»š]
    ABORT --> REMOVE[ç§»é™¤ç‰ˆæœ¬]

    RETURN --> CONTINUE{ç»§ç»­?}
    CONTINUE -->|æ˜¯| READ
    CONTINUE -->|å¦| END([äº‹åŠ¡ç»“æŸ])

    VACUUM --> END
    REMOVE --> END
```

**ç‰ˆæœ¬é“¾æ¼”åŒ–ç¤ºä¾‹**:

```text
åˆå§‹çŠ¶æ€:
  row1: v1 (xmin=100, xmax=NULL)

T2 (xid=101) UPDATE:
  row1: v1 (xmin=100, xmax=101) â† æ—§ç‰ˆæœ¬
         â†“ ctid
        v2 (xmin=101, xmax=NULL) â† æ–°ç‰ˆæœ¬

T3 (xid=102) UPDATE:
  row1: v1 (xmin=100, xmax=101)
         â†“ ctid
        v2 (xmin=101, xmax=102)
         â†“ ctid
        v3 (xmin=102, xmax=NULL) â† æœ€æ–°ç‰ˆæœ¬

T2 COMMIT:
  row1: v1 (xmin=100, xmax=101)
         â†“ ctid
        v2 (xmin=101, xmax=102) â† xmaxæ›´æ–°
         â†“ ctid
        v3 (xmin=102, xmax=NULL)
```

### 14.3 MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ

**å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”çŸ©é˜µ**:

| æœºåˆ¶ | è¯»æ“ä½œ | å†™æ“ä½œ | å†²çªå¤„ç† | éš”ç¦»çº§åˆ« | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|-----|-------|-------|---------|---------|------|---------|
| **MVCC** | å¿«ç…§è¯» | ç‰ˆæœ¬å†™ | ç‰ˆæœ¬éš”ç¦» | å¿«ç…§éš”ç¦»/å¯åºåˆ—åŒ– | é«˜ | è¯»å¤šå†™å°‘ |
| **2PL** | å…±äº«é” | æ’ä»–é” | é”é¢„é˜² | å¯åºåˆ—åŒ– | ä¸­ | é«˜å†²çª |
| **OCC** | æ— é”è¯» | éªŒè¯å†™ | å†²çªæ£€æµ‹ | å¯åºåˆ—åŒ– | é«˜ (ä½å†²çª) | ä½å†²çª |
| **æ—¶é—´æˆ³æ’åº** | æ—¶é—´æˆ³ | æ—¶é—´æˆ³ | æ—¶é—´æˆ³æ£€æµ‹ | å¯åºåˆ—åŒ– | ä¸­ | ä¸­ç­‰å†²çª |

**MVCCå®ç°å¯¹æ¯”çŸ©é˜µ**:

| ç³»ç»Ÿ | ç‰ˆæœ¬å­˜å‚¨ | å¿«ç…§æœºåˆ¶ | éš”ç¦»çº§åˆ« | æ€§èƒ½ | ç‰¹ç‚¹ |
|-----|---------|---------|---------|------|------|
| **PostgreSQL** | å †è¡¨ç‰ˆæœ¬é“¾ | äº‹åŠ¡å¿«ç…§ | SI/SSI | é«˜ | å®Œæ•´MVCC |
| **MySQL InnoDB** | å›æ»šæ®µ | ReadView | RC/RR | é«˜ | ç®€åŒ–MVCC |
| **Oracle** | å›æ»šæ®µ | SCNå¿«ç…§ | SI | é«˜ | ä¼ä¸šçº§ |
| **SQL Server** | TempDBç‰ˆæœ¬å­˜å‚¨ | è¡Œç‰ˆæœ¬ | SI | ä¸­ | æ··åˆæ–¹æ¡ˆ |

**MVCCéš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ**:

| éš”ç¦»çº§åˆ« | å¿«ç…§æœºåˆ¶ | å†²çªæ£€æµ‹ | å†™åæ–œæ£€æµ‹ | æ€§èƒ½ | ä¸€è‡´æ€§ |
|---------|---------|---------|-----------|------|--------|
| **Read Committed** | è¯­å¥çº§å¿«ç…§ | å†™å†™å†²çª | å¦ | æœ€é«˜ | å¼± |
| **Repeatable Read** | äº‹åŠ¡çº§å¿«ç…§ | å†™å†™å†²çª | å¦ | é«˜ | ä¸­ |
| **Serializable (SSI)** | äº‹åŠ¡çº§å¿«ç…§ | å†™å†™å†²çª | æ˜¯ | ä¸­ | å¼º |

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Pythonå®ç°ã€ç‰ˆæœ¬é“¾éå†ã€HOTé“¾ã€å¿«ç…§ç®¡ç†ã€å®é™…æ¡ˆä¾‹ã€åä¾‹åˆ†æã€MVCCç†è®ºå¯è§†åŒ–ï¼ˆMVCCæ¶æ„è®¾è®¡å›¾ã€ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾ã€MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µï¼‰ã€MVCCç†è®ºèƒŒæ™¯çŸ¥è¯†è¡¥å……ï¼ˆä¸ºä»€ä¹ˆéœ€è¦MVCCã€å†å²èƒŒæ™¯ã€ç†è®ºåŸºç¡€ã€å®é™…åº”ç”¨èƒŒæ™¯ï¼‰ã€MVCCåä¾‹è¡¥å……ï¼ˆ6ä¸ªæ–°å¢åä¾‹ï¼šè¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯ã€å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€ã€å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥ã€ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜ï¼‰

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/01-åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹(LSEM).md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/02-éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ.md`
- `05-å®ç°æœºåˆ¶/01-PostgreSQL-MVCCå®ç°.md`
