# 02 | MVCCç†è®ºå®Œæ•´è§£æ

> **ç†è®ºå®šä½**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ˜¯PostgreSQLå¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒæœºåˆ¶ï¼Œæœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„æ•°å­¦è¯æ˜å’Œå·¥ç¨‹å®ç°åˆ†æã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | MVCCç†è®ºå®Œæ•´è§£æ](#02--mvccç†è®ºå®Œæ•´è§£æ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€ç†è®ºåŸºç¡€ä¸åŠ¨æœº](#ä¸€ç†è®ºåŸºç¡€ä¸åŠ¨æœº)
    - [0.1 ç†è®ºåŸºç¡€](#01-ç†è®ºåŸºç¡€)
      - [0.1.1 ç»å…¸ç†è®ºæ¥æº](#011-ç»å…¸ç†è®ºæ¥æº)
      - [0.1.2 æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹](#012-æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹)
      - [0.1.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»](#013-ä¸ç»å…¸ç†è®ºçš„å…³ç³»)
    - [1.0 ä¸ºä»€ä¹ˆéœ€è¦MVCCï¼Ÿ](#10-ä¸ºä»€ä¹ˆéœ€è¦mvcc)
      - [ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹MVCCçš„å½±å“](#ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹mvccçš„å½±å“)
      - [è¯­è¨€æœºåˆ¶å¯¹MVCCå®ç°çš„å½±å“](#è¯­è¨€æœºåˆ¶å¯¹mvccå®ç°çš„å½±å“)
    - [1.1 å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨](#11-å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 å¿«ç…§ (Snapshot) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#13-å¿«ç…§-snapshot-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [1.3.1 æƒå¨å®šä¹‰ä¸æ¥æº](#131-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [1.3.2 å½¢å¼åŒ–å®šä¹‰](#132-å½¢å¼åŒ–å®šä¹‰)
      - [1.3.3 ç†è®ºæ€è„‰](#133-ç†è®ºæ€è„‰)
      - [1.3.4 å®Œæ•´è®ºè¯](#134-å®Œæ•´è®ºè¯)
      - [1.3.5 å…³è”è§£é‡Š](#135-å…³è”è§£é‡Š)
      - [1.3.5.5 xip (æ´»è·ƒäº‹åŠ¡åˆ—è¡¨) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#1355-xip-æ´»è·ƒäº‹åŠ¡åˆ—è¡¨-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
        - [1.3.5.5.0 æƒå¨å®šä¹‰ä¸æ¥æº](#13550-æƒå¨å®šä¹‰ä¸æ¥æº)
        - [1.3.5.5.1 å½¢å¼åŒ–å®šä¹‰](#13551-å½¢å¼åŒ–å®šä¹‰)
        - [1.3.5.5.2 ç†è®ºæ€è„‰](#13552-ç†è®ºæ€è„‰)
        - [1.3.5.5.3 å®Œæ•´è®ºè¯](#13553-å®Œæ•´è®ºè¯)
        - [1.3.5.5.4 å…³è”è§£é‡Š](#13554-å…³è”è§£é‡Š)
        - [1.3.5.5.5 æ€§èƒ½å½±å“åˆ†æ](#13555-æ€§èƒ½å½±å“åˆ†æ)
        - [1.3.5.5.6 æ€»ç»“](#13556-æ€»ç»“)
      - [1.3.6 æ€§èƒ½å½±å“åˆ†æ](#136-æ€§èƒ½å½±å“åˆ†æ)
      - [1.3.7 æ€»ç»“](#137-æ€»ç»“)
  - [1.4 xmin/xmax å®Œæ•´å®šä¹‰ä¸åˆ†æ](#14-xminxmax-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
    - [1.4.0 æƒå¨å®šä¹‰ä¸æ¥æº](#140-æƒå¨å®šä¹‰ä¸æ¥æº)
    - [1.4.1 å½¢å¼åŒ–å®šä¹‰](#141-å½¢å¼åŒ–å®šä¹‰)
    - [1.4.2 ç†è®ºæ€è„‰](#142-ç†è®ºæ€è„‰)
    - [1.4.3 å®Œæ•´è®ºè¯](#143-å®Œæ•´è®ºè¯)
    - [1.4.4 å…³è”è§£é‡Š](#144-å…³è”è§£é‡Š)
    - [1.4.5 æ€§èƒ½å½±å“åˆ†æ](#145-æ€§èƒ½å½±å“åˆ†æ)
    - [1.4.6 æ€»ç»“](#146-æ€»ç»“)
  - [äºŒã€å¯è§æ€§åˆ¤æ–­ç®—æ³•](#äºŒå¯è§æ€§åˆ¤æ–­ç®—æ³•)
    - [2.0 å¯è§æ€§ (Visibility) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#20-å¯è§æ€§-visibility-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [2.0.1 æƒå¨å®šä¹‰ä¸æ¥æº](#201-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [2.0.2 å½¢å¼åŒ–å®šä¹‰](#202-å½¢å¼åŒ–å®šä¹‰)
      - [2.0.3 ç†è®ºæ€è„‰](#203-ç†è®ºæ€è„‰)
      - [2.0.4 å®Œæ•´è®ºè¯](#204-å®Œæ•´è®ºè¯)
      - [2.0.5 å…³è”è§£é‡Š](#205-å…³è”è§£é‡Š)
      - [2.0.6 æ€»ç»“](#206-æ€»ç»“)
    - [2.1 å®Œæ•´å¯è§æ€§è§„åˆ™](#21-å®Œæ•´å¯è§æ€§è§„åˆ™)
    - [2.2 å¯è§æ€§è¯æ˜](#22-å¯è§æ€§è¯æ˜)
    - [2.3 æ—¶ç©ºå¤æ‚åº¦åˆ†æ](#23-æ—¶ç©ºå¤æ‚åº¦åˆ†æ)
  - [2.5 ç‰ˆæœ¬é“¾ (Version Chain) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#25-ç‰ˆæœ¬é“¾-version-chain-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
    - [2.5.0 æƒå¨å®šä¹‰ä¸æ¥æº](#250-æƒå¨å®šä¹‰ä¸æ¥æº)
    - [2.5.1 å½¢å¼åŒ–å®šä¹‰](#251-å½¢å¼åŒ–å®šä¹‰)
    - [2.5.2 ç†è®ºæ€è„‰](#252-ç†è®ºæ€è„‰)
    - [2.5.3 å®Œæ•´è®ºè¯](#253-å®Œæ•´è®ºè¯)
    - [2.5.4 å…³è”è§£é‡Š](#254-å…³è”è§£é‡Š)
    - [2.5.5 æ€§èƒ½å½±å“åˆ†æ](#255-æ€§èƒ½å½±å“åˆ†æ)
    - [2.5.6 æ€»ç»“](#256-æ€»ç»“)
  - [ä¸‰ã€æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–](#ä¸‰æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–)
    - [3.1 INSERTæ“ä½œ](#31-insertæ“ä½œ)
    - [3.2 DELETEæ“ä½œ](#32-deleteæ“ä½œ)
    - [3.3 UPDATEæ“ä½œ](#33-updateæ“ä½œ)
  - [å››ã€éš”ç¦»çº§åˆ«å®ç°](#å››éš”ç¦»çº§åˆ«å®ç°)
    - [4.1 Read Committed (è¯»å·²æäº¤)](#41-read-committed-è¯»å·²æäº¤)
      - [4.1.1 æƒå¨å®šä¹‰ä¸æ¥æº](#411-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [4.1.2 å½¢å¼åŒ–å®šä¹‰](#412-å½¢å¼åŒ–å®šä¹‰)
      - [4.1.3 ç†è®ºæ€è„‰](#413-ç†è®ºæ€è„‰)
      - [4.1.4 å®Œæ•´è®ºè¯](#414-å®Œæ•´è®ºè¯)
      - [4.1.5 å…³è”è§£é‡Š](#415-å…³è”è§£é‡Š)
      - [4.1.6 æ€§èƒ½å½±å“åˆ†æ](#416-æ€§èƒ½å½±å“åˆ†æ)
      - [4.1.7 æ€»ç»“](#417-æ€»ç»“)
    - [4.2 Repeatable Read (å¯é‡å¤è¯»)](#42-repeatable-read-å¯é‡å¤è¯»)
      - [4.2.1 æƒå¨å®šä¹‰ä¸æ¥æº](#421-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [4.2.2 å½¢å¼åŒ–å®šä¹‰](#422-å½¢å¼åŒ–å®šä¹‰)
      - [4.2.3 ç†è®ºæ€è„‰](#423-ç†è®ºæ€è„‰)
      - [4.2.4 å®Œæ•´è®ºè¯](#424-å®Œæ•´è®ºè¯)
      - [4.2.5 å…³è”è§£é‡Š](#425-å…³è”è§£é‡Š)
      - [4.2.6 æ€§èƒ½å½±å“åˆ†æ](#426-æ€§èƒ½å½±å“åˆ†æ)
      - [4.2.7 æ€»ç»“](#427-æ€»ç»“)
    - [4.3 Serializable (å¯ä¸²è¡ŒåŒ–) - SSI](#43-serializable-å¯ä¸²è¡ŒåŒ–---ssi)
      - [4.3.1 æƒå¨å®šä¹‰ä¸æ¥æº](#431-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [4.3.2 å½¢å¼åŒ–å®šä¹‰](#432-å½¢å¼åŒ–å®šä¹‰)
      - [4.3.3 ç†è®ºæ€è„‰](#433-ç†è®ºæ€è„‰)
      - [4.3.4 å®Œæ•´è®ºè¯](#434-å®Œæ•´è®ºè¯)
      - [4.3.5 å…³è”è§£é‡Š](#435-å…³è”è§£é‡Š)
      - [4.3.6 æ€§èƒ½å½±å“åˆ†æ](#436-æ€§èƒ½å½±å“åˆ†æ)
      - [4.3.7 æ€»ç»“](#437-æ€»ç»“)
  - [4.4 æ­»å…ƒç»„ (Dead Tuple) å®Œæ•´å®šä¹‰ä¸åˆ†æ](#44-æ­»å…ƒç»„-dead-tuple-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
    - [4.4.0 æƒå¨å®šä¹‰ä¸æ¥æº](#440-æƒå¨å®šä¹‰ä¸æ¥æº)
    - [4.4.1 å½¢å¼åŒ–å®šä¹‰](#441-å½¢å¼åŒ–å®šä¹‰)
    - [4.4.2 ç†è®ºæ€è„‰](#442-ç†è®ºæ€è„‰)
    - [4.4.3 å®Œæ•´è®ºè¯](#443-å®Œæ•´è®ºè¯)
    - [4.4.4 å…³è”è§£é‡Š](#444-å…³è”è§£é‡Š)
    - [4.4.5 æ€§èƒ½å½±å“åˆ†æ](#445-æ€§èƒ½å½±å“åˆ†æ)
    - [4.4.6 æ€»ç»“](#446-æ€»ç»“)
  - [äº”ã€VACUUMæœºåˆ¶](#äº”vacuumæœºåˆ¶)
    - [5.0 VACUUM å®Œæ•´å®šä¹‰ä¸åˆ†æ](#50-vacuum-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [5.0.0 æƒå¨å®šä¹‰ä¸æ¥æº](#500-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [5.0.1 å½¢å¼åŒ–å®šä¹‰](#501-å½¢å¼åŒ–å®šä¹‰)
      - [5.0.2 ç†è®ºæ€è„‰](#502-ç†è®ºæ€è„‰)
      - [5.0.3 å®Œæ•´è®ºè¯](#503-å®Œæ•´è®ºè¯)
      - [5.0.4 å…³è”è§£é‡Š](#504-å…³è”è§£é‡Š)
      - [5.0.5 æ€§èƒ½å½±å“åˆ†æ](#505-æ€§èƒ½å½±å“åˆ†æ)
      - [5.0.6 æ€»ç»“](#506-æ€»ç»“)
    - [5.1 OldestXmin å®Œæ•´å®šä¹‰ä¸åˆ†æ](#51-oldestxmin-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [5.1.0 æƒå¨å®šä¹‰ä¸æ¥æº](#510-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [5.1.1 å½¢å¼åŒ–å®šä¹‰](#511-å½¢å¼åŒ–å®šä¹‰)
      - [5.1.2 ç†è®ºæ€è„‰](#512-ç†è®ºæ€è„‰)
      - [5.1.3 å®Œæ•´è®ºè¯](#513-å®Œæ•´è®ºè¯)
      - [5.1.4 å…³è”è§£é‡Š](#514-å…³è”è§£é‡Š)
      - [5.1.5 æ€§èƒ½å½±å“åˆ†æ](#515-æ€§èƒ½å½±å“åˆ†æ)
      - [5.1.6 æ€»ç»“](#516-æ€»ç»“)
    - [5.2 æ­»å…ƒç»„è¯†åˆ«](#52-æ­»å…ƒç»„è¯†åˆ«)
    - [5.2 æ¸…ç†è¿‡ç¨‹](#52-æ¸…ç†è¿‡ç¨‹)
    - [5.3 Freezeæ“ä½œ](#53-freezeæ“ä½œ)
  - [å…­ã€ä¼˜åŒ–æŠ€æœ¯](#å…­ä¼˜åŒ–æŠ€æœ¯)
    - [6.0 Hint Bits å®Œæ•´å®šä¹‰ä¸åˆ†æ](#60-hint-bits-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [6.0.0 æƒå¨å®šä¹‰ä¸æ¥æº](#600-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [6.0.1 å½¢å¼åŒ–å®šä¹‰](#601-å½¢å¼åŒ–å®šä¹‰)
      - [6.0.2 ç†è®ºæ€è„‰](#602-ç†è®ºæ€è„‰)
      - [6.0.3 å®Œæ•´è®ºè¯](#603-å®Œæ•´è®ºè¯)
      - [6.0.4 å…³è”è§£é‡Š](#604-å…³è”è§£é‡Š)
      - [6.0.5 æ€§èƒ½å½±å“åˆ†æ](#605-æ€§èƒ½å½±å“åˆ†æ)
      - [6.0.6 æ€»ç»“](#606-æ€»ç»“)
    - [6.1 HOT (Heap-Only Tuple)](#61-hot-heap-only-tuple)
    - [6.1.5 Visibility Map å®Œæ•´å®šä¹‰ä¸åˆ†æ](#615-visibility-map-å®Œæ•´å®šä¹‰ä¸åˆ†æ)
      - [6.1.5.0 æƒå¨å®šä¹‰ä¸æ¥æº](#6150-æƒå¨å®šä¹‰ä¸æ¥æº)
      - [6.1.5.1 å½¢å¼åŒ–å®šä¹‰](#6151-å½¢å¼åŒ–å®šä¹‰)
      - [6.1.5.2 ç†è®ºæ€è„‰](#6152-ç†è®ºæ€è„‰)
      - [6.1.5.3 å®Œæ•´è®ºè¯](#6153-å®Œæ•´è®ºè¯)
      - [6.1.5.4 å…³è”è§£é‡Š](#6154-å…³è”è§£é‡Š)
      - [6.1.5.5 æ€§èƒ½å½±å“åˆ†æ](#6155-æ€§èƒ½å½±å“åˆ†æ)
      - [6.1.5.6 æ€»ç»“](#6156-æ€»ç»“)
    - [6.2 Index-Only Scan](#62-index-only-scan)
    - [6.3 Parallel VACUUM](#63-parallel-vacuum)
  - [ä¸ƒã€æ€§èƒ½åˆ†æ](#ä¸ƒæ€§èƒ½åˆ†æ)
    - [7.1 ååé‡æ¨¡å‹](#71-ååé‡æ¨¡å‹)
    - [7.2 ç©ºé—´å¼€é”€](#72-ç©ºé—´å¼€é”€)
    - [7.3 VACUUMå¼€é”€](#73-vacuumå¼€é”€)
  - [å…«ã€ä¸å…¶ä»–MVCCå®ç°å¯¹æ¯”](#å…«ä¸å…¶ä»–mvccå®ç°å¯¹æ¯”)
    - [8.1 PostgreSQL vs MySQL InnoDB](#81-postgresql-vs-mysql-innodb)
    - [8.2 Oracle MVCCå®ç°](#82-oracle-mvccå®ç°)
      - [8.2.1 Undo Logæœºåˆ¶](#821-undo-logæœºåˆ¶)
      - [8.2.2 ä¸PostgreSQLå¯¹æ¯”](#822-ä¸postgresqlå¯¹æ¯”)
      - [8.2.3 Oracle MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿](#823-oracle-mvccä¼˜åŠ¿ä¸åŠ£åŠ¿)
    - [8.3 SQL Server MVCCå®ç°](#83-sql-server-mvccå®ç°)
      - [8.3.1 Row Versioningæœºåˆ¶](#831-row-versioningæœºåˆ¶)
      - [8.3.2 ä¸PostgreSQLå¯¹æ¯”](#832-ä¸postgresqlå¯¹æ¯”)
      - [8.3.3 SQL Server MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿](#833-sql-server-mvccä¼˜åŠ¿ä¸åŠ£åŠ¿)
    - [8.4 ä¸»æµæ•°æ®åº“MVCCå®ç°ç»¼åˆå¯¹æ¯”](#84-ä¸»æµæ•°æ®åº“mvccå®ç°ç»¼åˆå¯¹æ¯”)
      - [8.4.1 å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ](#841-å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ)
      - [8.4.2 æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”](#842-æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”)
      - [8.4.3 é€‰æ‹©å»ºè®®](#843-é€‰æ‹©å»ºè®®)
    - [8.5 ç†è®ºä¼˜åŠ£æ€»ç»“](#85-ç†è®ºä¼˜åŠ£æ€»ç»“)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®å…¬å¼](#92-å…³é”®å…¬å¼)
    - [9.3 è®¾è®¡åŸåˆ™](#93-è®¾è®¡åŸåˆ™)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 MVCCå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°](#111-mvccå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°)
    - [11.2 ç‰ˆæœ¬é“¾éå†å®ç°](#112-ç‰ˆæœ¬é“¾éå†å®ç°)
    - [11.3 HOTé“¾éå†å®ç°](#113-hoté“¾éå†å®ç°)
    - [11.4 å¿«ç…§åˆ›å»ºå®ç°](#114-å¿«ç…§åˆ›å»ºå®ç°)
  - [åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åäºŒå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [12.1 æ¡ˆä¾‹: é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯](#121-æ¡ˆä¾‹-é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯)
    - [12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ](#122-æ¡ˆä¾‹-é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ)
    - [12.3 æ¡ˆä¾‹: çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–](#123-æ¡ˆä¾‹-çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–)
  - [åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åä¸‰åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸](#åä¾‹1-é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸)
    - [åä¾‹2: å¿½ç•¥HOTä¼˜åŒ–æ¡ä»¶](#åä¾‹2-å¿½ç•¥hotä¼˜åŒ–æ¡ä»¶)
    - [åä¾‹3: è¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯](#åä¾‹3-è¯¯ç”¨mvccå¤„ç†é«˜å†²çªå†™åœºæ™¯)
    - [åä¾‹4: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€](#åä¾‹4-å¿½ç•¥vacuumå¯¼è‡´å­˜å‚¨è†¨èƒ€)
    - [åä¾‹5: å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥](#åä¾‹5-å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥)
    - [åä¾‹6: ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜](#åä¾‹6-ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜)
  - [åå››ã€MVCCç†è®ºå¯è§†åŒ–](#åå››mvccç†è®ºå¯è§†åŒ–)
    - [14.1 MVCCæ¶æ„è®¾è®¡å›¾](#141-mvccæ¶æ„è®¾è®¡å›¾)
    - [14.2 ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾](#142-ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾)
    - [14.3 MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ](#143-mvccä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ)

---

## ä¸€ã€ç†è®ºåŸºç¡€ä¸åŠ¨æœº

### 0.1 ç†è®ºåŸºç¡€

æœ¬æ–‡æ¡£çš„ç†è®ºåŸºç¡€ä¸»è¦æ¥æºäºä»¥ä¸‹ç»å…¸æ–‡çŒ®ï¼š

#### 0.1.1 ç»å…¸ç†è®ºæ¥æº

1. **Bernstein, P. A., & Goodman, N. (1981)**: "Concurrency Control in Distributed Database Systems"
   - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»ŸåŒ–åœ°åˆ†æäº†48ç§å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œå°†MVCCå½’ç±»ä¸ºå¤šç‰ˆæœ¬æ—¶é—´æˆ³æ’åºæ–¹æ³•
   - **MVCCåˆ†ç±»**: åœ¨Bernstein & Goodmançš„åˆ†ç±»ä½“ç³»ä¸­ï¼ŒMVCCå±äº"å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"ç±»åˆ«
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åœ¨æ­¤åŸºç¡€ä¸Šæ·±å…¥åˆ†æPostgreSQLçš„MVCCå®ç°æœºåˆ¶

2. **Adya, A., et al. (2000)**: "Generalized Isolation Level Definitions"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¼±éš”ç¦»çº§åˆ«çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰
   - **å¿«ç…§éš”ç¦»å®šä¹‰**: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªä¸€è‡´å¿«ç…§ï¼Œè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æPostgreSQLå¦‚ä½•é€šè¿‡MVCCå®ç°å¿«ç…§éš”ç¦»

3. **Fekete, A., et al. (2005)**: "Making Snapshot Isolation Serializable"
   - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰çš„ç†è®ºåŸºç¡€
   - **SSIæ ¸å¿ƒæ€æƒ³**: é€šè¿‡æ£€æµ‹å†™åæ–œï¼ˆWrite Skewï¼‰ç­‰å¼‚å¸¸ï¼Œä½¿å¿«ç…§éš”ç¦»è¾¾åˆ°ä¸²è¡ŒåŒ–çº§åˆ«
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åˆ†æPostgreSQL SSIçš„å®ç°ï¼ŒåŒ…æ‹¬è°“è¯é”å’Œå†²çªæ£€æµ‹æœºåˆ¶

4. **Ports, D. R., & Grittner, K. (2012)**: "Serializable Snapshot Isolation in PostgreSQL"
   - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†æè¿°äº†PostgreSQL SSIçš„å®ç°ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªç”Ÿäº§çº§SSIå®ç°
   - **å®ç°ç»†èŠ‚**: åŒ…æ‹¬è°“è¯é”ç®¡ç†å™¨ã€å†²çªæ£€æµ‹ç®—æ³•ã€å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­‰
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£ç›´æ¥å‚è€ƒæ­¤è®ºæ–‡çš„å®ç°ç»†èŠ‚ï¼Œæä¾›ä»£ç çº§åˆ†æ

5. **Gray, J., & Reuter, A. (1993)**: "Transaction Processing: Concepts and Techniques"
   - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†äº‹åŠ¡å¤„ç†çš„å®Œæ•´ç†è®ºæ¡†æ¶ï¼ŒåŒ…æ‹¬MVCCçš„å®ç°æœºåˆ¶
   - **MVCCå®ç°**: è¯¦ç»†åˆ†æäº†å¤šç‰ˆæœ¬å­˜å‚¨ã€ç‰ˆæœ¬é“¾ç®¡ç†ã€å¯è§æ€§åˆ¤æ–­ç­‰
   - **æœ¬ä½“ç³»åº”ç”¨**: æœ¬æ–‡æ¡£åœ¨æ­¤åŸºç¡€ä¸Šåˆ†æPostgreSQLçš„å…·ä½“å®ç°

#### 0.1.2 æœ¬ä½“ç³»çš„åˆ†æé‡ç‚¹

ç›¸æ¯”ç»å…¸ç†è®ºï¼Œæœ¬æ–‡æ¡£çš„é‡ç‚¹ï¼š

1. **PostgreSQLå®ç°æ·±åº¦åˆ†æ**: ä»ç†è®ºåˆ°æºç çš„å®Œæ•´æ˜ å°„
   - **ç»å…¸ç†è®º**: æä¾›ç†è®ºæ¡†æ¶å’Œç®—æ³•æè¿°
   - **æœ¬ä½“ç³»**: ç»“åˆPostgreSQLæºç ï¼Œæä¾›å¯éªŒè¯çš„å®ç°åˆ†æ

2. **æ€§èƒ½æ¨¡å‹é‡åŒ–åˆ†æ**: æä¾›é‡åŒ–çš„æ€§èƒ½åˆ†ææ¨¡å‹
   - **ç»å…¸ç†è®º**: ä¸»è¦å…³æ³¨æ­£ç¡®æ€§
   - **æœ¬ä½“ç³»**: åŒæ—¶å…³æ³¨æ€§èƒ½å’Œæ­£ç¡®æ€§çš„æƒè¡¡

3. **è·¨å±‚æ˜ å°„å…³ç³»**: å°†MVCCçº³å…¥LSEMç»Ÿä¸€æ¡†æ¶
   - **ç»å…¸ç†è®º**: MVCCä½œä¸ºç‹¬ç«‹çš„å¹¶å‘æ§åˆ¶æ–¹æ³•
   - **æœ¬ä½“ç³»**: æ­ç¤ºMVCCä¸Rustæ‰€æœ‰æƒã€åˆ†å¸ƒå¼å…±è¯†çš„åŒæ„å…³ç³»

4. **å·¥ç¨‹å®è·µç»“åˆ**: æä¾›å®é™…åº”ç”¨æ¡ˆä¾‹å’Œä¼˜åŒ–æŒ‡å—
   - **ç»å…¸ç†è®º**: åé‡ç†è®ºåˆ†æ
   - **æœ¬ä½“ç³»**: ç†è®ºåˆ†æä¸å·¥ç¨‹å®è·µå¹¶é‡

#### 0.1.3 ä¸ç»å…¸ç†è®ºçš„å…³ç³»

```text
MVCCç†è®ºä¸ç»å…¸ç†è®ºçš„å…³ç³»:
â”‚
â”œâ”€ Bernstein & Goodman (1981)
â”‚  â”œâ”€ è´¡çŒ®: å¹¶å‘æ§åˆ¶æ–¹æ³•åˆ†ç±»ï¼ŒMVCCå½’ç±»
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: ç†è§£MVCCåœ¨å¹¶å‘æ§åˆ¶æ–¹æ³•ä½“ç³»ä¸­çš„ä½ç½®
â”‚  â””â”€ æ‰©å±•: æ·±å…¥åˆ†æPostgreSQLçš„å…·ä½“å®ç°
â”‚
â”œâ”€ Adya et al. (2000)
â”‚  â”œâ”€ è´¡çŒ®: å¿«ç…§éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: PostgreSQLå¿«ç…§éš”ç¦»çš„æ­£ç¡®æ€§è¯æ˜
â”‚  â””â”€ æ‰©å±•: å®ç°ç»†èŠ‚å’Œæ€§èƒ½åˆ†æ
â”‚
â”œâ”€ Fekete et al. (2005)
â”‚  â”œâ”€ è´¡çŒ®: SSIç†è®ºåŸºç¡€å’Œç®—æ³•
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: PostgreSQL SSIå®ç°çš„ç®—æ³•åˆ†æ
â”‚  â””â”€ æ‰©å±•: æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹å®è·µ
â”‚
â”œâ”€ Ports & Grittner (2012)
â”‚  â”œâ”€ è´¡çŒ®: PostgreSQL SSIå®ç°ç»†èŠ‚
â”‚  â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: ç›´æ¥å‚è€ƒå®ç°ï¼Œæä¾›æºç çº§åˆ†æ
â”‚  â””â”€ æ‰©å±•: æ€§èƒ½æ¨¡å‹å’Œä¼˜åŒ–æŒ‡å—
â”‚
â””â”€ Gray & Reuter (1993)
   â”œâ”€ è´¡çŒ®: äº‹åŠ¡å¤„ç†å®Œæ•´ç†è®ºæ¡†æ¶
   â”œâ”€ æœ¬ä½“ç³»åº”ç”¨: MVCCåœ¨äº‹åŠ¡å¤„ç†ä¸­çš„ä½ç½®
   â””â”€ æ‰©å±•: è·¨å±‚æ˜ å°„å’Œç»Ÿä¸€æ¡†æ¶
```

### 1.0 ä¸ºä»€ä¹ˆéœ€è¦MVCCï¼Ÿ

**å†å²èƒŒæ™¯**:

åœ¨æ•°æ®åº“ç³»ç»Ÿå‘å±•çš„æ—©æœŸï¼ˆ1970-1980å¹´ä»£ï¼‰ï¼Œä¸»è¦ä½¿ç”¨ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰è¿›è¡Œå¹¶å‘æ§åˆ¶ã€‚2PLè™½ç„¶èƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹ï¼Œè¯»å†™äº’æ–¥å¯¼è‡´æ€§èƒ½ç“¶é¢ˆä¸¥é‡ã€‚1980å¹´ä»£ï¼Œç ”ç©¶è€…æå‡ºäº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰çš„æ¦‚å¿µï¼Œé€šè¿‡ç»´æŠ¤æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬æ¥å®ç°è¯»å†™å¹¶å‘ï¼Œå¤§å¹…æå‡äº†ç³»ç»Ÿæ€§èƒ½ã€‚

**æ·±åº¦å†å²æ¼”è¿›ä¸ç¡¬ä»¶èƒŒæ™¯**:

#### ç¡¬ä»¶ä½“ç³»æ¼”è¿›å¯¹MVCCçš„å½±å“

**å•æ ¸æ—¶ä»£ (1970s-1990s)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å•æ ¸å¿ƒï¼Œé¡ºåºæ‰§è¡Œ
â”œâ”€ å†…å­˜: ç»Ÿä¸€å†…å­˜ï¼Œæ— ç¼“å­˜å±‚æ¬¡
â”œâ”€ å­˜å‚¨: ç£ç›˜ï¼Œé¡ºåºè®¿é—®
â””â”€ å¹¶å‘: æ—¶é—´ç‰‡è½®è½¬ï¼Œä¼ªå¹¶å‘

2PLæ€§èƒ½ç‰¹å¾:
â”œâ”€ é”å¼€é”€: ä¸»è¦æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢
â”œâ”€ æ€§èƒ½: å¯æ¥å—ï¼ˆæ— çœŸå®å¹¶è¡Œï¼‰
â””â”€ é—®é¢˜: è¯»å†™äº’æ–¥ï¼Œä½†å½±å“æœ‰é™
```

**å¤šæ ¸æ—¶ä»£ (2000s-2010s)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å¤šæ ¸å¿ƒï¼ŒçœŸå®å¹¶è¡Œ
â”œâ”€ å†…å­˜: ç¼“å­˜å±‚æ¬¡ï¼ˆL1/L2/L3ï¼‰
â”œâ”€ å­˜å‚¨: SSDï¼Œéšæœºè®¿é—®æ€§èƒ½æå‡
â””â”€ å¹¶å‘: çœŸå®å¹¶è¡Œï¼Œç¼“å­˜ä¸€è‡´æ€§

MVCCä¼˜åŠ¿å‡¸æ˜¾:
â”œâ”€ è¯»æ— é”: é¿å…ç¼“å­˜ä¸€è‡´æ€§å¼€é”€
â”œâ”€ å†™åˆ›å»ºæ–°ç‰ˆæœ¬: å‡å°‘é”ç«äº‰
â””â”€ æ€§èƒ½: å¤šæ ¸ç¯å¢ƒä¸‹ä¼˜åŠ¿æ˜æ˜¾
```

**ç°ä»£ç¡¬ä»¶ (2010s+)**:

```text
ç¡¬ä»¶ç‰¹å¾:
â”œâ”€ CPU: å¤šæ ¸å¤šçº¿ç¨‹ï¼ˆè¶…çº¿ç¨‹ï¼‰
â”œâ”€ å†…å­˜: NUMAæ¶æ„
â”œâ”€ å­˜å‚¨: NVMe SSDã€PMEM
â””â”€ é—®é¢˜: NUMAæ•ˆåº”ã€å­˜å‚¨å±‚æ¬¡

MVCCæ–°æŒ‘æˆ˜:
â”œâ”€ ç‰ˆæœ¬é“¾: è·¨NUMAèŠ‚ç‚¹è®¿é—®
â”œâ”€ VACUUM: éœ€è¦è€ƒè™‘NUMAäº²å’Œæ€§
â””â”€ è®¾è®¡: NUMAæ„ŸçŸ¥çš„MVCCå®ç°
```

#### è¯­è¨€æœºåˆ¶å¯¹MVCCå®ç°çš„å½±å“

**ç¼–è¯‘æ—¶æ£€æŸ¥ vs è¿è¡Œæ—¶æ£€æŸ¥**:

```text
MVCCå®ç°å±‚æ¬¡:
â”œâ”€ L0å±‚ (æ•°æ®åº“): PostgreSQL MVCC
â”‚   â”œâ”€ å®ç°: Cè¯­è¨€ï¼Œè¿è¡Œæ—¶æ£€æŸ¥
â”‚   â”œâ”€ å¿«ç…§: è¿è¡Œæ—¶åˆ›å»º
â”‚   â””â”€ å¯è§æ€§: è¿è¡Œæ—¶åˆ¤æ–­
â”‚
â”œâ”€ L1å±‚ (è¯­è¨€): Rustæ‰€æœ‰æƒ
â”‚   â”œâ”€ å®ç°: Rustï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
â”‚   â”œâ”€ å¿«ç…§: ç¼–è¯‘æœŸç”Ÿå‘½å‘¨æœŸ
â”‚   â””â”€ å¯è§æ€§: ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥
â”‚
â””â”€ æ˜ å°„å…³ç³»:
    â”œâ”€ MVCCå¿«ç…§ â‰ˆ Rustç”Ÿå‘½å‘¨æœŸ
    â”œâ”€ MVCCå¯è§æ€§ â‰ˆ Rustå€Ÿç”¨è§„åˆ™
    â””â”€ MVCCç‰ˆæœ¬é“¾ â‰ˆ Rustæ‰€æœ‰æƒè½¬ç§»
```

**ç¼–è¯‘å™¨ä¼˜åŒ–å¯¹MVCCçš„å½±å“**:

```text
ç¼–è¯‘å™¨ä¼˜åŒ–:
â”œâ”€ å†…è”ä¼˜åŒ–: å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
â”œâ”€ å¾ªç¯ä¼˜åŒ–: å‡å°‘ç‰ˆæœ¬é“¾éå†æ¬¡æ•°
â”œâ”€ å¯„å­˜å™¨åˆ†é…: å‡å°‘å†…å­˜è®¿é—®
â””â”€ é™åˆ¶: ä¸èƒ½æ”¹å˜MVCCè¯­ä¹‰

MVCCè¯­ä¹‰ä¿è¯:
â”œâ”€ å¿«ç…§ä¸€è‡´æ€§: ç¼–è¯‘å™¨ä¸èƒ½ç ´å
â”œâ”€ å¯è§æ€§è§„åˆ™: ç¼–è¯‘å™¨å¿…é¡»éµå®ˆ
â””â”€ ç‰ˆæœ¬é“¾å®Œæ•´æ€§: ç¼–è¯‘å™¨ä¸èƒ½ä¼˜åŒ–æ‰
```

**ç†è®ºåŸºç¡€**:

```text
å¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒé—®é¢˜:
â”œâ”€ é—®é¢˜: å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®åŒä¸€æ•°æ®
â”œâ”€ ä¼ ç»Ÿæ–¹æ¡ˆ: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚   â”œâ”€ è¯»æ“ä½œ: éœ€è¦å…±äº«é”
â”‚   â”œâ”€ å†™æ“ä½œ: éœ€è¦æ’ä»–é”
â”‚   â””â”€ ç»“æœ: è¯»å†™äº’æ–¥ï¼Œæ€§èƒ½ç“¶é¢ˆ
â”‚
â””â”€ MVCCæ–¹æ¡ˆ: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
    â”œâ”€ è¯»æ“ä½œ: è®¿é—®å†å²ç‰ˆæœ¬ï¼Œæ— éœ€åŠ é”
    â”œâ”€ å†™æ“ä½œ: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä»…å†™å†™å†²çª
    â””â”€ ç»“æœ: è¯»å†™å¹¶å‘ï¼Œæ€§èƒ½å¤§å¹…æå‡
```

**å®é™…åº”ç”¨èƒŒæ™¯**:

```text
MVCCæ¼”è¿›:
â”œâ”€ æ—©æœŸç³»ç»Ÿ (1970s-1980s)
â”‚   â”œâ”€ æ–¹æ¡ˆ: 2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰
â”‚   â”œâ”€ é—®é¢˜: è¯»å†™äº’æ–¥ï¼Œæ€§èƒ½å·®
â”‚   â””â”€ åœºæ™¯: è¯»å¤šå†™å°‘æ—¶æ€§èƒ½ç“¶é¢ˆä¸¥é‡
â”‚
â”œâ”€ MVCCæå‡º (1980s)
â”‚   â”œâ”€ ç†è®º: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
â”‚   â”œâ”€ ä¼˜åŠ¿: è¯»ä¸é˜»å¡å†™
â”‚   â””â”€ åº”ç”¨: ç ”ç©¶ç³»ç»Ÿã€ç†è®ºéªŒè¯
â”‚
â””â”€ MVCCæ™®åŠ (2000s+)
    â”œâ”€ PostgreSQL: å®Œæ•´MVCCå®ç°
    â”œâ”€ MySQL InnoDB: MVCCæ”¯æŒ
    â””â”€ åº”ç”¨: æˆä¸ºä¸»æµå¹¶å‘æ§åˆ¶æ–¹æ¡ˆ
```

**ä¸ºä»€ä¹ˆMVCCé‡è¦ï¼Ÿ**

1. **æ€§èƒ½ä¼˜åŠ¿**: è¯»æ“ä½œæ— éœ€åŠ é”ï¼Œå¤§å¹…æå‡è¯»å¹¶å‘æ€§èƒ½
2. **éš”ç¦»ä¿è¯**: é€šè¿‡å¿«ç…§éš”ç¦»å®ç°äº‹åŠ¡éš”ç¦»
3. **å®é™…åº”ç”¨**: PostgreSQLç­‰ä¸»æµæ•°æ®åº“çš„æ ¸å¿ƒæœºåˆ¶
4. **ç†è®ºåŸºç¡€**: ä¸ºç†è§£ç°ä»£æ•°æ®åº“å¹¶å‘æ§åˆ¶æä¾›åŸºç¡€

**åä¾‹: æ— MVCCçš„ç³»ç»Ÿæ€§èƒ½é—®é¢˜**:

```text
é”™è¯¯è®¾è®¡: ä½¿ç”¨2PLå¤„ç†è¯»å¤šå†™å°‘åœºæ™¯
â”œâ”€ åœºæ™¯: æ–°é—»ç½‘ç«™ï¼Œ90%è¯»ï¼Œ10%å†™
â”œâ”€ é—®é¢˜: è¯»æ“ä½œéœ€è¦å…±äº«é”
â”œâ”€ ç»“æœ: è¯»æ“ä½œé˜»å¡å†™æ“ä½œ
â””â”€ æ€§èƒ½: TPSåªæœ‰1000ï¼Œæ— æ³•æ»¡è¶³éœ€æ±‚ âœ—

æ­£ç¡®è®¾è®¡: ä½¿ç”¨MVCC
â”œâ”€ åœºæ™¯: åŒæ ·çš„è¯»å¤šå†™å°‘åœºæ™¯
â”œâ”€ æ–¹æ¡ˆ: MVCCï¼Œè¯»æ“ä½œè®¿é—®å†å²ç‰ˆæœ¬
â”œâ”€ ç»“æœ: è¯»ä¸é˜»å¡å†™
â””â”€ æ€§èƒ½: TPSè¾¾åˆ°10000+ âœ“
```

**åè¯: ä¸ºä»€ä¹ˆ2PLåœ¨è¯»å¤šåœºæ™¯ä¸‹å¿…ç„¶æ€§èƒ½å·®ï¼Ÿ**

**å®šç†**: åœ¨è¯»å¤šå†™å°‘åœºæ™¯ä¸‹ï¼Œ2PLæ€§èƒ½ä¸¥æ ¼åŠ£äºMVCC

**è¯æ˜ï¼ˆé‡åŒ–åˆ†æï¼‰**:

```text
è®¾:
â”œâ”€ N_read: å¹¶å‘è¯»äº‹åŠ¡æ•°
â”œâ”€ N_write: å¹¶å‘å†™äº‹åŠ¡æ•°
â”œâ”€ T_2PL: 2PLååé‡
â”œâ”€ T_MVCC: MVCCååé‡
â””â”€ å‡è®¾: N_read >> N_write

2PLæ€§èƒ½æ¨¡å‹:
â”œâ”€ è¯»æ“ä½œ: éœ€è¦å…±äº«é”
â”œâ”€ é”ç«äº‰: O(N_read) è¯»çº¿ç¨‹ç«äº‰å…±äº«é”
â”œâ”€ å†™æ“ä½œ: éœ€è¦æ’ä»–é”ï¼Œé˜»å¡æ‰€æœ‰è¯»
â””â”€ ååé‡: T_2PL = 1 / (T_lock + T_read + T_wait)

MVCCæ€§èƒ½æ¨¡å‹:
â”œâ”€ è¯»æ“ä½œ: æ— é”ï¼ˆå¿«ç…§è¯»å–ï¼‰
â”œâ”€ å†™æ“ä½œ: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸é˜»å¡è¯»
â”œâ”€ é”ç«äº‰: O(N_write) << O(N_read)
â””â”€ ååé‡: T_MVCC = N_read / T_read

æ€§èƒ½æ¯”:
â”œâ”€ T_MVCC / T_2PL = N_read Ã— (T_lock + T_read + T_wait) / T_read
â”œâ”€ å½“ N_read >> 1 ä¸” T_wait >> T_read æ—¶
â””â”€ T_MVCC >> T_2PL

å› æ­¤: MVCCä¸¥æ ¼ä¼˜äº2PL âœ“
```

**ç¡¬ä»¶å±‚é¢çš„åè¯**:

```text
ç¼“å­˜ä¸€è‡´æ€§å¼€é”€:
â”œâ”€ 2PL: é”å˜é‡åœ¨å¤šä¸ªæ ¸å¿ƒé—´ä¼ é€’
â”‚   â”œâ”€ æ¯æ¬¡é”è·å–: éœ€è¦MESIåè®®
â”‚   â”œâ”€ å»¶è¿Ÿ: ~100ns (è·¨æ ¸å¿ƒ)
â”‚   â””â”€ å¼€é”€: O(N_read) Ã— 100ns
â”‚
â”œâ”€ MVCC: è¯»æ“ä½œæ— é”
â”‚   â”œâ”€ å¿«ç…§è¯»å–: ä»…éœ€L1ç¼“å­˜
â”‚   â”œâ”€ å»¶è¿Ÿ: ~4ns (L1ç¼“å­˜)
â”‚   â””â”€ å¼€é”€: O(N_read) Ã— 4ns
â”‚
â””â”€ æ€§èƒ½æ¯”: 100ns / 4ns = 25Ã—

NUMAæ¶æ„å½±å“:
â”œâ”€ 2PL: é”å˜é‡å¯èƒ½åœ¨è¿œç¨‹NUMAèŠ‚ç‚¹
â”‚   â”œâ”€ æœ¬åœ°è®¿é—®: ~100ns
â”‚   â”œâ”€ è¿œç¨‹è®¿é—®: ~300ns
â”‚   â””â”€ å¹³å‡å»¶è¿Ÿ: (100 + 300) / 2 = 200ns
â”‚
â”œâ”€ MVCC: ç‰ˆæœ¬æ•°æ®å¯ä»¥æœ¬åœ°åŒ–
â”‚   â”œâ”€ æœ¬åœ°è®¿é—®: ~100ns
â”‚   â””â”€ å¹³å‡å»¶è¿Ÿ: 100ns
â”‚
â””â”€ æ€§èƒ½æ¯”: 200ns / 100ns = 2Ã—

å› æ­¤: åœ¨ç¡¬ä»¶å±‚é¢ï¼ŒMVCCä¹Ÿä¸¥æ ¼ä¼˜äº2PL
```

**å®é™…æ¡ˆä¾‹åè¯**:

```text
æ¡ˆä¾‹1: æŸæ–°é—»ç½‘ç«™
â”œâ”€ åœºæ™¯: 1000å¹¶å‘è¯»ï¼Œ10å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 1000 (é”ç«äº‰ä¸¥é‡)
â”œâ”€ MVCC: TPS = 10000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 10å€ âœ“

æ¡ˆä¾‹2: æŸç”µå•†å•†å“è¯¦æƒ…é¡µ
â”œâ”€ åœºæ™¯: 10000å¹¶å‘è¯»ï¼Œ100å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 500 (é”æˆä¸ºç“¶é¢ˆ)
â”œâ”€ MVCC: TPS = 50000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 100å€ âœ“

æ¡ˆä¾‹3: æŸç¤¾äº¤å¹³å°åŠ¨æ€æµ
â”œâ”€ åœºæ™¯: 50000å¹¶å‘è¯»ï¼Œ500å¹¶å‘å†™
â”œâ”€ 2PL: TPS = 100 (ç³»ç»Ÿå‡ ä¹ä¸å¯ç”¨)
â”œâ”€ MVCC: TPS = 200000+ (è¯»æ— é”)
â””â”€ æ€§èƒ½æå‡: 2000å€ âœ“
```

### 1.1 å¹¶å‘æ§åˆ¶é—®é¢˜çš„æœ¬è´¨

**æ ¸å¿ƒçŸ›ç›¾**:

- **æ­£ç¡®æ€§**: äº‹åŠ¡éš”ç¦»ï¼Œé˜²æ­¢æ•°æ®ç«äº‰
- **æ€§èƒ½**: é«˜å¹¶å‘ååï¼Œé™ä½é”å¼€é”€

**ä¼ ç»Ÿ2PLï¼ˆä¸¤é˜¶æ®µé”ï¼‰çš„å›°å¢ƒ**:

$$ReadLock(T) \land WriteLock(T) \implies Conflict \implies Wait$$

- âœ… **ä¼˜åŠ¿**: å®ç°ç®€å•ï¼Œå¼ºéš”ç¦»ä¿è¯
- âŒ **åŠ£åŠ¿**: è¯»å†™äº’æ–¥ï¼Œååé‡ä½

**MVCCçš„åˆ›æ–°**:

$$Read(T_i) \parallel Write(T_j) \text{ if } Version(T_i) \neq Version(T_j)$$

- è¯»æ“ä½œè®¿é—®å†å²ç‰ˆæœ¬ï¼Œ**æ— éœ€åŠ é”**
- å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œ**ä»…å†™å†™å†²çª**

### 1.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1.1 (ç‰ˆæœ¬ç©ºé—´)**:

$$\mathcal{V} = \{v_1, v_2, ..., v_n\} \quad \text{where } v_i = (data, xmin, xmax, ctid)$$

**å®šä¹‰1.2 (ç‰ˆæœ¬é“¾)**:

$$VersionChain(row) = \{v_i \in \mathcal{V} : v_i.key = row.key\}$$

æ’åºå…³ç³»: $v_i \prec v_j \iff v_i.xmin < v_j.xmin$

**å®šä¹‰1.3 (å¿«ç…§)**:

$$Snapshot = (xmin, xmax, xip)$$

å…¶ä¸­:

- $xmin$: æœ€å°æ´»è·ƒäº‹åŠ¡ID
- $xmax$: æœ€å¤§å·²æäº¤äº‹åŠ¡ID + 1
- $xip$: æ´»è·ƒäº‹åŠ¡IDé›†åˆ

---

### 1.3 å¿«ç…§ (Snapshot) å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 1.3.1 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> In database systems, a snapshot is a consistent view of the database at a specific point in time. In Snapshot Isolation, each transaction operates on a consistent snapshot of the database as it existed at the start of the transaction. The snapshot is defined by three components: xmin (the earliest active transaction ID), xmax (the first unassigned transaction ID), and xip_list (a list of active transaction IDs).

**Berenson et al. (1995) å¿«ç…§éš”ç¦»å®šä¹‰**:

> Snapshot Isolation ensures that each transaction sees a consistent snapshot of the database. The snapshot is taken at the start of the transaction and remains fixed throughout the transaction's execution.

**Adya et al. (2000) å½¢å¼åŒ–å®šä¹‰**:

ä½¿ç”¨ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDSGï¼‰çš„å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\text{Snapshot}(T_i) = \text{DatabaseState}(\text{StartTime}(T_i))$$

å…¶ä¸­ $\text{StartTime}(T_i)$ æ˜¯äº‹åŠ¡$T_i$çš„å¼€å§‹æ—¶é—´ã€‚

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„å¿«ç…§æ•°æ®ç»“æ„ï¼š

```c
// src/include/utils/snapshot.h

typedef struct SnapshotData {
    SnapshotType snapshot_type;  // å¿«ç…§ç±»å‹
    TransactionId xmin;           // æœ€æ—©å¯è§äº‹åŠ¡ID
    TransactionId xmax;           // æœ€æ™šå¯è§äº‹åŠ¡ID + 1
    TransactionId *xip;           // æ´»è·ƒäº‹åŠ¡IDæ•°ç»„
    uint32 xcnt;                  // æ´»è·ƒäº‹åŠ¡æ•°é‡
    uint32 subxcnt;               // å­äº‹åŠ¡æ•°é‡
    TransactionId *subxip;        // å­äº‹åŠ¡IDæ•°ç»„
    CommandId curcid;             // å½“å‰å‘½ä»¤ID
    uint32 active_count;          // æ´»è·ƒè®¡æ•°
    uint32 regd_count;            // æ³¨å†Œè®¡æ•°
} SnapshotData;
```

**å¿«ç…§åˆ›å»ºæ—¶æœº**:

```python
class SnapshotManager:
    """
    PostgreSQLå¿«ç…§ç®¡ç†å™¨

    å¿«ç…§åˆ›å»ºæ—¶æœº:
    1. Read Committed: æ¯æ¡è¯­å¥å¼€å§‹æ—¶åˆ›å»ºæ–°å¿«ç…§
    2. Repeatable Read: äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´ä¸å˜
    3. Serializable: åŒRepeatable Readï¼Œä½†é¢å¤–ç»´æŠ¤è°“è¯é”
    """
    def create_snapshot(self, isolation_level):
        if isolation_level == 'READ_COMMITTED':
            # è¯­å¥çº§å¿«ç…§
            return self.create_statement_snapshot()
        elif isolation_level in ['REPEATABLE_READ', 'SERIALIZABLE']:
            # äº‹åŠ¡çº§å¿«ç…§
            return self.create_transaction_snapshot()

    def create_statement_snapshot(self):
        """åˆ›å»ºè¯­å¥çº§å¿«ç…§ï¼ˆRead Committedï¼‰"""
        return Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )

    def create_transaction_snapshot(self):
        """åˆ›å»ºäº‹åŠ¡çº§å¿«ç…§ï¼ˆRepeatable Read/Serializableï¼‰"""
        snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )
        # äº‹åŠ¡çº§å¿«ç…§åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´ä¿æŒä¸å˜
        return snapshot
```

**æœ¬ä½“ç³»å®šä¹‰**:

å¿«ç…§æ˜¯MVCCçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå®šä¹‰äº†äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ã€‚å¿«ç…§ç”±ä¸‰ä¸ªå…³é”®ç»„ä»¶ç»„æˆï¼šxminï¼ˆæœ€æ—©æ´»è·ƒäº‹åŠ¡IDï¼‰ã€xmaxï¼ˆä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼‰ã€xipï¼ˆæ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨ï¼‰ã€‚å¿«ç…§åˆ›å»ºæ—¶æœºå–å†³äºéš”ç¦»çº§åˆ«ï¼šRead Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§ï¼ŒRepeatable Readå’ŒSerializableä½¿ç”¨äº‹åŠ¡çº§å¿«ç…§ã€‚

**å¿«ç…§ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:

```text
å¿«ç…§ç­–ç•¥ä¸éš”ç¦»çº§åˆ«:
â”‚
â”œâ”€ Read Committed
â”‚   â””â”€ è¯­å¥çº§å¿«ç…§ï¼ˆæ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§ï¼‰
â”‚       â””â”€ å…è®¸ä¸å¯é‡å¤è¯»ã€å¹»è¯»
â”‚
â”œâ”€ Repeatable Read
â”‚   â””â”€ äº‹åŠ¡çº§å¿«ç…§ï¼ˆäº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´ä¸å˜ï¼‰
â”‚       â””â”€ é˜²æ­¢ä¸å¯é‡å¤è¯»ã€å¹»è¯»
â”‚
â””â”€ Serializable
    â””â”€ äº‹åŠ¡çº§å¿«ç…§ + SSIæ‰©å±•
        â””â”€ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸
```

---

#### 1.3.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1.3.1 (å¿«ç…§ - PostgreSQLå®ç°)**:

å¿«ç…§æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š

$$Snapshot = (xmin, xmax, xip)$$

å…¶ä¸­ï¼š

- $xmin \in \mathbb{N}$: æœ€å°æ´»è·ƒäº‹åŠ¡IDï¼ˆæœ€æ—©å¯è§äº‹åŠ¡IDï¼‰
- $xmax \in \mathbb{N}$: æœ€å¤§å·²æäº¤äº‹åŠ¡ID + 1ï¼ˆä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼‰
- $xip \subseteq \mathbb{N}$: æ´»è·ƒäº‹åŠ¡IDé›†åˆï¼ˆæœ‰åºåˆ—è¡¨ï¼‰

**å®šä¹‰1.3.2 (å¿«ç…§åˆ›å»º - Berenson et al., 1995)**:

å¯¹äºäº‹åŠ¡$T_i$ï¼Œå¿«ç…§åœ¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºï¼š

$$\text{Snapshot}(T_i) = \text{DatabaseState}(\text{StartTime}(T_i))$$

å…¶ä¸­ $\text{StartTime}(T_i)$ æ˜¯äº‹åŠ¡$T_i$çš„å¼€å§‹æ—¶é—´ã€‚

**å®šä¹‰1.3.3 (å¿«ç…§å¯è§æ€§è¾¹ç•Œ)**:

å¿«ç…§å®šä¹‰äº†å¯è§æ€§è¾¹ç•Œï¼š

$$\text{Visible}(v, snap) \iff$$

$$(v.xmin < snap.xmax \land v.xmin \notin snap.xip) \land$$

$$(v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip)$$

**å¿«ç…§ç»„ä»¶çš„å½¢å¼åŒ–å±æ€§**:

1. **xminå±æ€§**:
   - $xmin = \min\{xid | xid \text{ is active}\}$
   - å¦‚æœæ— æ´»è·ƒäº‹åŠ¡ï¼Œ$xmin = \text{nextXid}$

2. **xmaxå±æ€§**:
   - $xmax = \text{nextXid}$ï¼ˆä¸‹ä¸€ä¸ªåˆ†é…çš„äº‹åŠ¡IDï¼‰
   - æ‰€æœ‰ $xid < xmax$ çš„äº‹åŠ¡è¦ä¹ˆå·²æäº¤ï¼Œè¦ä¹ˆåœ¨$xip$ä¸­

3. **xipå±æ€§**:
   - $xip = \{xid | xid \text{ is active} \land xmin \leq xid < xmax\}$
   - $xip$æ˜¯æœ‰åºåˆ—è¡¨ï¼Œç”¨äºäºŒåˆ†æŸ¥æ‰¾

**å¿«ç…§åˆ›å»ºç®—æ³•å¤æ‚åº¦**:

- **æ—¶é—´å¤æ‚åº¦**: $O(N_{active})$ - éœ€è¦æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡
- **ç©ºé—´å¤æ‚åº¦**: $O(N_{active})$ - å­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- **ä¼˜åŒ–**: ä½¿ç”¨å…±äº«å†…å­˜å’Œç¼“å­˜å‡å°‘å¼€é”€

---

#### 1.3.3 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: åŸºäºæ—¶é—´æˆ³çš„å¿«ç…§
   - ä½¿ç”¨ç‰©ç†æ—¶é—´æˆ³
   - æ—¶é—´æˆ³åˆ†é…å¼€é”€å¤§
   - æ—¶é’ŸåŒæ­¥é—®é¢˜

2. **1980å¹´ä»£**: åŸºäºäº‹åŠ¡IDçš„å¿«ç…§
   - ä½¿ç”¨é€»è¾‘äº‹åŠ¡ID
   - é¿å…æ—¶é’ŸåŒæ­¥é—®é¢˜
   - PostgreSQLé‡‡ç”¨çš„æ–¹å¼

3. **1995å¹´**: Berenson et al. æå‡ºå¿«ç…§éš”ç¦»
   - å½¢å¼åŒ–å®šä¹‰å¿«ç…§éš”ç¦»
   - æå‡ºå¿«ç…§çš„ä¸€è‡´æ€§ä¿è¯
   - è¯æ˜å¿«ç…§éš”ç¦»ä¸æ˜¯ä¸²è¡ŒåŒ–

4. **2000å¹´ä»£**: PostgreSQLå¿«ç…§å®ç°ä¼˜åŒ–
   - ä½¿ç”¨å…±äº«å†…å­˜å­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å¿«ç…§ç¼“å­˜æœºåˆ¶
   - æ€§èƒ½ä¼˜åŒ–

5. **2010å¹´ä»£è‡³ä»Š**: å¿«ç…§éš”ç¦»æˆä¸ºä¸»æµ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“é‡‡ç”¨å¿«ç…§éš”ç¦»
   - å¿«ç…§åˆ›å»ºæ€§èƒ½ä¼˜åŒ–
   - å¿«ç…§ä¸éš”ç¦»çº§åˆ«çš„ç»Ÿä¸€

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ**

1. **å®šä¹‰ä¸€è‡´æ€§çš„æ—¶é—´ç‚¹**:
   - **é—®é¢˜**: å¹¶å‘äº‹åŠ¡éœ€è¦çœ‹åˆ°ä¸€è‡´çš„æ•°æ®åº“çŠ¶æ€
   - **è§£å†³**: å¿«ç…§å®šä¹‰äº†äº‹åŠ¡çš„"æ—¶é—´ç‚¹"
   - **æ•ˆæœ**: æ‰€æœ‰è¯»æ“ä½œåŸºäºåŒä¸€å¿«ç…§ï¼Œä¿è¯ä¸€è‡´æ€§

2. **å®ç°éš”ç¦»æ€§**:
   - **é—®é¢˜**: éœ€è¦æ§åˆ¶äº‹åŠ¡çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬
   - **è§£å†³**: å¿«ç…§å®šä¹‰äº†å¯è§æ€§è¾¹ç•Œ
   - **æ•ˆæœ**: ä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨ä¸åŒçš„å¿«ç…§ç­–ç•¥

3. **æ€§èƒ½ä¼˜åŒ–**:
   - **é—®é¢˜**: éœ€è¦é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶æœºåˆ¶
   - **è§£å†³**: å¿«ç…§éš”ç¦»è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»
   - **æ•ˆæœ**: æ€§èƒ½ä¼˜äºåŸºäºé”çš„å®ç°

**ç†è®ºä½ç½®**:

```text
å¿«ç…§åœ¨ç†è®ºä½“ç³»ä¸­çš„ä½ç½®:
â”‚
â”œâ”€ å¹¶å‘æ§åˆ¶ç†è®º
â”‚   â””â”€ MVCC
â”‚       â””â”€ å¿«ç…§éš”ç¦» â† æœ¬æ¦‚å¿µä½ç½®
â”‚           â”œâ”€ å¿«ç…§åˆ›å»º
â”‚           â”œâ”€ å¿«ç…§ç®¡ç†
â”‚           â””â”€ å¿«ç…§å¯è§æ€§
â”‚
â”œâ”€ éš”ç¦»çº§åˆ«ç†è®º
â”‚   â””â”€ éš”ç¦»æ€§
â”‚       â””â”€ å¿«ç…§ç­–ç•¥
â”‚           â”œâ”€ è¯­å¥çº§å¿«ç…§ï¼ˆRead Committedï¼‰
â”‚           â””â”€ äº‹åŠ¡çº§å¿«ç…§ï¼ˆRepeatable Read/Serializableï¼‰
â”‚
â””â”€ LSEMç†è®º
    â””â”€ å¿«ç…§ â‰ˆ çŠ¶æ€å¿«ç…§ç‚¹
```

**å¿«ç…§ä¸å¯è§æ€§çš„å…³ç³»**:

```text
å¿«ç…§ä¸å¯è§æ€§:
â”œâ”€ å¿«ç…§: å®šä¹‰äº‹åŠ¡çš„"æ—¶é—´ç‚¹"
â”œâ”€ å¯è§æ€§: åŸºäºå¿«ç…§åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯è§
â””â”€ å…³ç³»: å¿«ç…§æ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
```

**ç†è®ºæ¨å¯¼**:

```text
ä»å¹¶å‘æ§åˆ¶åˆ°å¿«ç…§é€‰æ‹©çš„æ¨ç†é“¾æ¡:

1. å¹¶å‘æ§åˆ¶éœ€æ±‚
   â”œâ”€ éœ€æ±‚: ä¿è¯äº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„æ•°æ®åº“çŠ¶æ€
   â”œâ”€ éœ€æ±‚: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
   â””â”€ éœ€æ±‚: é«˜æ€§èƒ½

2. å¿«ç…§è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨å¿«ç…§å®šä¹‰"æ—¶é—´ç‚¹"
   â”œâ”€ æ–¹æ¡ˆ: åŸºäºå¿«ç…§åˆ¤æ–­å¯è§æ€§
   â””â”€ æ–¹æ¡ˆ: ä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨ä¸åŒå¿«ç…§ç­–ç•¥

3. å¿«ç…§ç­–ç•¥é€‰æ‹©
   â”œâ”€ è¯­å¥çº§å¿«ç…§: é«˜æ€§èƒ½ï¼Œå…è®¸ä¸å¯é‡å¤è¯»
   â”œâ”€ äº‹åŠ¡çº§å¿«ç…§: ä¸€è‡´æ€§å¿«ç…§ï¼Œé˜²æ­¢ä¸å¯é‡å¤è¯»
   â””â”€ äº‹åŠ¡çº§å¿«ç…§+SSI: ä¸²è¡ŒåŒ–ä¿è¯

4. ç»“è®º
   â””â”€ å¿«ç…§æ˜¯å®ç°éš”ç¦»æ€§çš„æ ¸å¿ƒæœºåˆ¶
```

---

#### 1.3.4 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: æ­£ç¡®çš„å¿«ç…§åˆ›å»ºå’Œä½¿ç”¨**

```sql
-- åœºæ™¯: äº‹åŠ¡T1ä½¿ç”¨Repeatable Read
-- éœ€æ±‚: æ•´ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

-- äº‹åŠ¡T1å¼€å§‹
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200, xip=[105, 110]

-- æŸ¥è¯¢1
SELECT balance FROM accounts WHERE id = 1;
-- åŸºäºå¿«ç…§: çœ‹åˆ°xmin<200ä¸”xminâˆ‰xipçš„ç‰ˆæœ¬
-- è¿”å›: balance=1000

-- å…¶ä»–äº‹åŠ¡ä¿®æ”¹
-- T105: UPDATE accounts SET balance = 1500 WHERE id = 1; COMMIT;
-- T110: UPDATE accounts SET balance = 2000 WHERE id = 1; COMMIT;

-- æŸ¥è¯¢2ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
SELECT balance FROM accounts WHERE id = 1;
-- ä»åŸºäºåŒä¸€å¿«ç…§: xmin=100, xmax=200, xip=[105, 110]
-- è¿”å›: balance=1000ï¼ˆä¸æŸ¥è¯¢1ç›¸åŒï¼‰âœ“ å¯é‡å¤è¯»

COMMIT;
```

**åˆ†æ**:

- âœ… å¿«ç…§åˆ›å»ºæ­£ç¡®ï¼šäº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
- âœ… å¿«ç…§ä¿æŒä¸å˜ï¼šæ•´ä¸ªäº‹åŠ¡æœŸé—´ä½¿ç”¨åŒä¸€å¿«ç…§
- âœ… å¯é‡å¤è¯»ï¼šå¤šæ¬¡æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®

---

**æ­£ä¾‹2: è¯­å¥çº§å¿«ç…§çš„æ­£ç¡®ä½¿ç”¨**

```sql
-- åœºæ™¯: äº‹åŠ¡T1ä½¿ç”¨Read Committed
-- éœ€æ±‚: æ¯æ¡è¯­å¥çœ‹åˆ°æœ€æ–°çš„å·²æäº¤æ•°æ®

-- äº‹åŠ¡T1å¼€å§‹
BEGIN;  -- é»˜è®¤Read Committed

-- è¯­å¥1å¼€å§‹
-- å¿«ç…§åˆ›å»º1: xmin=100, xmax=200, xip=[105]
SELECT balance FROM accounts WHERE id = 1;
-- è¿”å›: balance=1000

-- å…¶ä»–äº‹åŠ¡æäº¤
-- T105: UPDATE accounts SET balance = 1500 WHERE id = 1; COMMIT;

-- è¯­å¥2å¼€å§‹
-- å¿«ç…§åˆ›å»º2: xmin=100, xmax=201, xip=[]ï¼ˆT105å·²æäº¤ï¼‰
SELECT balance FROM accounts WHERE id = 1;
-- è¿”å›: balance=1500ï¼ˆçœ‹åˆ°æœ€æ–°æäº¤çš„æ•°æ®ï¼‰âœ“

COMMIT;
```

**åˆ†æ**:

- âœ… è¯­å¥çº§å¿«ç…§ï¼šæ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§
- âœ… è¯»æœ€æ–°æ•°æ®ï¼šçœ‹åˆ°æœ€æ–°æäº¤çš„æ•°æ®
- âœ… é˜²æ­¢è„è¯»ï¼šä¸ä¼šçœ‹åˆ°æœªæäº¤çš„æ•°æ®

---

**åä¾‹åˆ†æ**:

**åä¾‹1: å¿«ç…§åˆ›å»ºæ—¶æœºé”™è¯¯**

```sql
-- é”™è¯¯åœºæ™¯: Repeatable Readåœ¨è¯­å¥å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
-- é—®é¢˜: å¿«ç…§åˆ›å»ºæ—¶æœºé”™è¯¯ï¼Œå¯¼è‡´ä¸å¯é‡å¤è¯»

-- é”™è¯¯çš„å¿«ç…§åˆ›å»º
class WrongRepeatableReadTransaction:
    def execute_statement(self, sql):
        # é”™è¯¯: æ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§
        snapshot = create_snapshot()  # âœ— åº”è¯¥åœ¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º
        result = execute_with_snapshot(sql, snapshot)
        return result

-- ç»“æœ
-- æŸ¥è¯¢1: å¿«ç…§1 (xmin=100, xmax=200)
-- è¿”å›: balance=1000

-- å…¶ä»–äº‹åŠ¡æäº¤
-- T105: UPDATE accounts SET balance = 1500; COMMIT;

-- æŸ¥è¯¢2: å¿«ç…§2 (xmin=100, xmax=201) âœ— æ–°å¿«ç…§
-- è¿”å›: balance=1500 âœ— ä¸å¯é‡å¤è¯»
```

**é”™è¯¯åŸå› **:

- Repeatable Readåº”è¯¥åœ¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
- æ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§å¯¼è‡´ä¸å¯é‡å¤è¯»
- è¿åRepeatable Readçš„è¯­ä¹‰

**æ­£ç¡®åšæ³•**:

```python
class CorrectRepeatableReadTransaction:
    def __init__(self):
        # æ­£ç¡®: äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
        self.snapshot = create_snapshot()

    def execute_statement(self, sql):
        # ä½¿ç”¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**åæœåˆ†æ**:

- **æ•°æ®ä¸ä¸€è‡´**: åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢çœ‹åˆ°ä¸åŒæ•°æ®
- **è¿åéš”ç¦»æ€§**: è¿åRepeatable Readçš„è¯­ä¹‰
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: åŸºäºä¸ä¸€è‡´çš„æ•°æ®åšå‡ºå†³ç­–

---

**åä¾‹2: å¿«ç…§xipåˆ—è¡¨ä¸å®Œæ•´**

```sql
-- é”™è¯¯åœºæ™¯: å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
-- é—®é¢˜: xipåˆ—è¡¨ä¸å®Œæ•´ï¼Œå¯¼è‡´è„è¯»

-- é”™è¯¯çš„å¿«ç…§åˆ›å»º
def wrong_snapshot():
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=[]  # é”™è¯¯: ç©ºåˆ—è¡¨ï¼Œæœªè·å–æ´»è·ƒäº‹åŠ¡ âœ—
    )
    return snapshot

-- ç»“æœ
-- T101: INSERT INTO accounts VALUES (1, 1000); -- æœªæäº¤
-- T102: å¿«ç…§ {xip=[]} âœ—
-- T102: SELECT * FROM accounts WHERE id = 1;
-- é”™è¯¯åˆ¤æ–­: xmin(101) âˆ‰ xip([]) â†’ å¯è§ âœ—
-- å®é™…: ä¸å¯è§ âœ“ (T101æœªæäº¤)
-- åæœ: è„è¯» âœ—
```

**é”™è¯¯åŸå› **:

- å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- xipåˆ—è¡¨ä¸ºç©ºï¼Œå¯¼è‡´æœªæäº¤äº‹åŠ¡è¢«è¯¯è®¤ä¸ºå·²æäº¤
- å¯è§æ€§åˆ¤æ–­åŸºäºé”™è¯¯çš„å¿«ç…§

**æ­£ç¡®åšæ³•**:

```python
def correct_snapshot():
    # æ­£ç¡®: è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    active_xids = get_active_transaction_ids()  # å…³é”®
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=active_xids  # æ­£ç¡®çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    )
    return snapshot
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
- **ç³»ç»Ÿé”™è¯¯**: å¿«ç…§æœºåˆ¶å¤±æ•ˆ
- **ä¸€è‡´æ€§ç ´å**: è¿åéš”ç¦»æ€§

---

**åä¾‹3: å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥**

```sql
-- é”™è¯¯åœºæ™¯: é«˜å¹¶å‘åœºæ™¯é¢‘ç¹åˆ›å»ºå¿«ç…§
-- é—®é¢˜: å¿«ç…§åˆ›å»ºå¼€é”€å¯¼è‡´æ€§èƒ½ä¸‹é™

-- é…ç½®é”™è¯¯: æ¯ä¸ªæŸ¥è¯¢éƒ½åˆ›å»ºæ–°å¿«ç…§
def wrong_query():
    for i in range(1000):
        snapshot = create_snapshot()  # å¼€é”€å¤§
        result = execute_with_snapshot(query, snapshot)

-- æ€§èƒ½å½±å“
-- å¿«ç…§åˆ›å»º: O(N_active) = O(1000) = å¼€é”€å¤§
-- TPS: ä»50,000é™åˆ°10,000 (ä¸‹é™80%) âœ—
```

**é”™è¯¯åŸå› **:

- é¢‘ç¹åˆ›å»ºå¿«ç…§å¯¼è‡´æ€§èƒ½ä¸‹é™
- å¿«ç…§åˆ›å»ºéœ€è¦æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œå¼€é”€å¤§
- æœªä½¿ç”¨å¿«ç…§ç¼“å­˜æœºåˆ¶

**æ­£ç¡®åšæ³•**:

```python
# æ­£ç¡®: äº‹åŠ¡çº§å¿«ç…§ï¼ˆä¸€ä¸ªäº‹åŠ¡ä¸€ä¸ªå¿«ç…§ï¼‰
def correct_query():
    snapshot = create_snapshot()  # äº‹åŠ¡å¼€å§‹æ—¶ä¸€æ¬¡
    for i in range(1000):
        result = execute_with_snapshot(query, snapshot)  # å¤ç”¨å¿«ç…§
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: TPSä¸‹é™80%
- **CPUå ç”¨é«˜**: å¿«ç…§åˆ›å»ºå ç”¨å¤§é‡CPU
- **ç³»ç»Ÿä¸ç¨³å®š**: é«˜è´Ÿè½½ä¸‹æ€§èƒ½å´©æºƒ

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: æŠ¥è¡¨ç”Ÿæˆä½¿ç”¨äº‹åŠ¡çº§å¿«ç…§**

**åœºæ™¯æè¿°**:

- ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥è¡¨
- éœ€è¦æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€æ•°æ®å¿«ç…§
- äº‹åŠ¡æ—¶é•¿: 5-10åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡çº§å¿«ç…§**:

- âœ… ä¸€è‡´æ€§å¿«ç…§ï¼šæ‰€æœ‰æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šå¤šæ¬¡æŸ¥è¯¢ç»“æœä¸€è‡´
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„è¡Œ

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200, xip=[105, 110]
-- æ•´ä¸ªäº‹åŠ¡æœŸé—´ä½¿ç”¨åŒä¸€å¿«ç…§

SELECT SUM(balance) FROM accounts WHERE date < '2025-12-01';
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-31';
SELECT * FROM transactions WHERE date BETWEEN '2025-12-01' AND '2025-12-31';
-- æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§

COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§ âœ“
- **æ€§èƒ½**: å¿«ç…§åˆ›å»ºä¸€æ¬¡ï¼Œå¼€é”€ä½ âœ“
- **å»¶è¿Ÿ**: æŸ¥è¯¢å»¶è¿Ÿæ­£å¸¸

---

**åœºæ™¯2: Webåº”ç”¨ä½¿ç”¨è¯­å¥çº§å¿«ç…§**

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘Webåº”ç”¨
- éœ€è¦çœ‹åˆ°æœ€æ–°çš„å·²æäº¤æ•°æ®
- äº‹åŠ¡æ—¶é•¿: < 1ç§’

**ä¸ºä»€ä¹ˆéœ€è¦è¯­å¥çº§å¿«ç…§**:

- âœ… è¯»æœ€æ–°æ•°æ®ï¼šæ¯æ¡è¯­å¥çœ‹åˆ°æœ€æ–°æäº¤çš„æ•°æ®
- âœ… é«˜æ€§èƒ½ï¼šå¿«ç…§åˆ›å»ºå¼€é”€å¯æ¥å—
- âœ… é˜²æ­¢è„è¯»ï¼šä¸ä¼šçœ‹åˆ°æœªæäº¤çš„æ•°æ®

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN;  -- é»˜è®¤Read Committed
-- è¯­å¥1: å¿«ç…§1
SELECT * FROM products WHERE id = 1;

-- å…¶ä»–äº‹åŠ¡æäº¤
-- UPDATE products SET price = 200 WHERE id = 1; COMMIT;

-- è¯­å¥2: å¿«ç…§2ï¼ˆæ–°å¿«ç…§ï¼‰
SELECT * FROM products WHERE id = 1;
-- çœ‹åˆ°æœ€æ–°æäº¤çš„æ•°æ®

COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **è¯»æœ€æ–°æ•°æ®**: æ¯æ¡è¯­å¥çœ‹åˆ°æœ€æ–°æäº¤çš„æ•°æ® âœ“
- **æ€§èƒ½**: å¿«ç…§åˆ›å»ºå¼€é”€å¯æ¥å— âœ“
- **å»¶è¿Ÿ**: æŸ¥è¯¢å»¶è¿Ÿæ­£å¸¸

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»éš”ç¦»çº§åˆ«åˆ°å¿«ç…§ç­–ç•¥çš„æ¨ç†**

```text
å‰æ1: éš”ç¦»çº§åˆ«éœ€è¦ä¸åŒçš„éš”ç¦»ä¿è¯
å‰æ2: å¿«ç…§ç­–ç•¥å†³å®šéš”ç¦»ä¿è¯
å‰æ3: ä¸åŒéš”ç¦»çº§åˆ«éœ€è¦ä¸åŒçš„å¿«ç…§ç­–ç•¥

æ¨ç†æ­¥éª¤1: Read Committedéœ€è¦é˜²æ­¢è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»
æ¨ç†æ­¥éª¤2: è¯­å¥çº§å¿«ç…§å¯ä»¥é˜²æ­¢è„è¯»ï¼Œä½†å…è®¸ä¸å¯é‡å¤è¯»
æ¨ç†æ­¥éª¤3: Repeatable Readéœ€è¦é˜²æ­¢ä¸å¯é‡å¤è¯»
æ¨ç†æ­¥éª¤4: äº‹åŠ¡çº§å¿«ç…§å¯ä»¥é˜²æ­¢ä¸å¯é‡å¤è¯»

ç»“è®º: ä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨ä¸åŒçš„å¿«ç…§ç­–ç•¥
```

**æ¨ç†é“¾æ¡2: ä»å¿«ç…§åˆ°å¯è§æ€§åˆ¤æ–­çš„æ¨ç†**

```text
å‰æ1: å¿«ç…§å®šä¹‰äº†äº‹åŠ¡çš„"æ—¶é—´ç‚¹"
å‰æ2: æ•°æ®ç‰ˆæœ¬æœ‰åˆ›å»ºæ—¶é—´ï¼ˆxminï¼‰å’Œåˆ é™¤æ—¶é—´ï¼ˆxmaxï¼‰
å‰æ3: å¯è§æ€§åˆ¤æ–­éœ€è¦å†³å®šç‰ˆæœ¬æ˜¯å¦åœ¨å¿«ç…§çš„"æ—¶é—´ç‚¹"å¯è§

æ¨ç†æ­¥éª¤1: å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºæ—¶é—´åœ¨å¿«ç…§æ—¶é—´ç‚¹ä¹‹åï¼Œç‰ˆæœ¬ä¸å¯è§
æ¨ç†æ­¥éª¤2: å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡æœªæäº¤ï¼ˆåœ¨xipä¸­ï¼‰ï¼Œç‰ˆæœ¬ä¸å¯è§
æ¨ç†æ­¥éª¤3: å¦‚æœç‰ˆæœ¬å·²è¢«åˆ é™¤ï¼Œä¸”åˆ é™¤äº‹åŠ¡å·²æäº¤ï¼Œç‰ˆæœ¬ä¸å¯è§

ç»“è®º: å¿«ç…§æ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
```

---

#### 1.3.5 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - å¿«ç…§æ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
   - å¯è§æ€§åˆ¤æ–­åŸºäºå¿«ç…§çš„xminã€xmaxã€xip
   - ä¸åŒå¿«ç…§ç­–ç•¥å¯¼è‡´ä¸åŒçš„å¯è§æ€§è¡Œä¸º

2. **ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:
   - ä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨ä¸åŒçš„å¿«ç…§ç­–ç•¥
   - è¯­å¥çº§å¿«ç…§ç”¨äºRead Committed
   - äº‹åŠ¡çº§å¿«ç…§ç”¨äºRepeatable Readå’ŒSerializable

3. **ä¸äº‹åŠ¡IDçš„å…³ç³»**:
   - å¿«ç…§çš„xminã€xmaxåŸºäºäº‹åŠ¡ID
   - å¿«ç…§çš„xipåŒ…å«æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨
   - äº‹åŠ¡IDç”¨äºæ ‡è¯†æ•°æ®ç‰ˆæœ¬çš„åˆ›å»ºå’Œåˆ é™¤

4. **ä¸MVCCå®ç°çš„å…³ç³»**:
   - å¿«ç…§æ˜¯MVCCçš„æ ¸å¿ƒæ•°æ®ç»“æ„
   - MVCCé€šè¿‡å¿«ç…§å®ç°éš”ç¦»æ€§
   - å¿«ç…§åˆ›å»ºå’Œç®¡ç†æ˜¯MVCCçš„å…³é”®

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQLå¿«ç…§å®ç°
   - å¿«ç…§æ•°æ®ç»“æ„
   - å¿«ç…§åˆ›å»ºç®—æ³•
   - å¿«ç…§ç¼“å­˜æœºåˆ¶

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - å¿«ç…§ â‰ˆ ä½œç”¨åŸŸï¼ˆScopeï¼‰
   - äº‹åŠ¡çº§å¿«ç…§ â‰ˆ æ•´ä¸ªä½œç”¨åŸŸ
   - è¯­å¥çº§å¿«ç…§ â‰ˆ è¯­å¥ä½œç”¨åŸŸ

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - å¿«ç…§ â‰ˆ å‘é‡æ—¶é’Ÿçš„å¿«ç…§ç‚¹
   - xmin/xmax â‰ˆ å‘é‡æ—¶é’Ÿçš„è¾¹ç•Œ
   - xip â‰ˆ æ´»è·ƒèŠ‚ç‚¹çš„å‘é‡æ—¶é’Ÿ

**å®ç°ç»†èŠ‚**:

**PostgreSQLæºç çº§åˆ†æ**:

```c
// src/backend/storage/ipc/procarray.c

Snapshot GetSnapshotData(Snapshot snapshot)
{
    ProcArrayStruct *arrayP = procArray;
    TransactionId xmin;
    TransactionId xmax;
    int count = 0;

    // 1. è·å–å…¨å±€xminï¼ˆæœ€è€çš„äº‹åŠ¡IDï¼‰
    xmin = GetOldestXmin(NULL, PROCARRAY_FLAGS_VACUUM);
    xmax = ShmemVariableCache->nextXid;

    // 2. åˆå§‹åŒ–å¿«ç…§
    snapshot->xmin = xmin;
    snapshot->xmax = xmax;
    snapshot->xcnt = 0;

    // 3. è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    LWLockAcquire(ProcArrayLock, LW_SHARED);

    for (int index = 0; index < arrayP->numProcs; index++) {
        PGPROC *proc = arrayP->procs[index];
        TransactionId xid = proc->xid;

        if (TransactionIdIsValid(xid)) {
            // æ·»åŠ åˆ°xipæ•°ç»„
            if (count >= snapshot->max_xcnt) {
                // æ•°ç»„æ‰©å®¹
                snapshot->max_xcnt *= 2;
                snapshot->xip = repalloc(snapshot->xip,
                    snapshot->max_xcnt * sizeof(TransactionId));
            }
            snapshot->xip[count++] = xid;
        }
    }

    snapshot->xcnt = count;
    LWLockRelease(ProcArrayLock);

    // 4. æ’åºxipæ•°ç»„ï¼ˆç”¨äºäºŒåˆ†æŸ¥æ‰¾ï¼‰
    qsort(snapshot->xip, snapshot->xcnt, sizeof(TransactionId), xidComparator);

    return snapshot;
}
```

**å¿«ç…§åˆ›å»ºç®—æ³•**:

```python
def create_snapshot():
    """
    åˆ›å»ºå¿«ç…§

    ç®—æ³•:
    1. è·å–å…¨å±€xminï¼ˆæœ€è€æ´»è·ƒäº‹åŠ¡IDï¼‰
    2. è·å–nextXidï¼ˆä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼‰
    3. æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œæ„å»ºxipåˆ—è¡¨
    4. æ’åºxipåˆ—è¡¨ï¼ˆç”¨äºäºŒåˆ†æŸ¥æ‰¾ï¼‰
    """
    # 1. è·å–å…¨å±€xmin
    xmin = get_oldest_xmin()

    # 2. è·å–nextXid
    xmax = get_next_xid()

    # 3. è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    active_xids = []
    for proc in get_all_processes():
        if proc.xid is not None:
            active_xids.append(proc.xid)

    # 4. æ’åºï¼ˆç”¨äºäºŒåˆ†æŸ¥æ‰¾ï¼‰
    active_xids.sort()

    # 5. åˆ›å»ºå¿«ç…§
    snapshot = Snapshot(
        xmin=xmin,
        xmax=xmax,
        xip=active_xids
    )

    return snapshot
```

**æ€§èƒ½å½±å“**:

1. **å¿«ç…§åˆ›å»ºå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active})$ - éœ€è¦æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡
   - ç©ºé—´å¤æ‚åº¦: $O(N_{active})$ - å­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 1-5Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°ï¼‰

2. **å¿«ç…§ç»´æŠ¤å¼€é”€**:
   - äº‹åŠ¡çº§å¿«ç…§éœ€è¦åœ¨äº‹åŠ¡æœŸé—´ä¸€ç›´ç»´æŠ¤
   - å†…å­˜å¼€é”€: $O(N_{active})$ æŒç»­å ç”¨
   - è¯­å¥çº§å¿«ç…§åœ¨è¯­å¥ç»“æŸæ—¶é‡Šæ”¾

3. **å¿«ç…§æŸ¥æ‰¾å¼€é”€**:
   - xipåˆ—è¡¨æŸ¥æ‰¾: $O(\log N_{active})$ - äºŒåˆ†æŸ¥æ‰¾
   - å…¸å‹å¼€é”€: 0.1-0.5Î¼s

4. **æ€»ä½“æ€§èƒ½**:
   - å¿«ç…§åˆ›å»º: 1-5Î¼sï¼ˆå¯æ¥å—ï¼‰
   - å¿«ç…§æŸ¥æ‰¾: 0.1-0.5Î¼sï¼ˆé«˜æ•ˆï¼‰
   - æ€»ä½“å½±å“: å¿«ç…§å¼€é”€å æŸ¥è¯¢å»¶è¿Ÿçš„1-5%

---

#### 1.3.5.5 xip (æ´»è·ƒäº‹åŠ¡åˆ—è¡¨) å®Œæ•´å®šä¹‰ä¸åˆ†æ

##### 1.3.5.5.0 æƒå¨å®šä¹‰ä¸æ¥æº

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> The xip array (transaction ID array) is a component of a snapshot that contains the IDs of all transactions that were active at the time the snapshot was created. This array is used during visibility checks to determine whether a tuple created by a transaction is visible. If a tuple's xmin is in the xip array, it means the creating transaction was still in progress when the snapshot was taken, and the tuple should not be visible to the snapshot.

**Berenson et al. (1995) å®šä¹‰**:

> The active transaction list (xip) in a snapshot contains all transaction IDs that were active (not yet committed or aborted) at the time the snapshot was created. This list is essential for preventing dirty reads, as it allows the system to identify tuples created by uncommitted transactions.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„xipå®ç°åŸºäºæ´»è·ƒäº‹åŠ¡æ•°ç»„ï¼ˆProcArrayï¼‰ï¼š

```c
// src/include/utils/snapshot.h

typedef struct SnapshotData
{
    TransactionId xmin;            // æœ€æ—©æ´»è·ƒäº‹åŠ¡ID
    TransactionId xmax;            // ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
    TransactionId *xip;            // æ´»è·ƒäº‹åŠ¡IDæ•°ç»„ï¼ˆæœ‰åºï¼‰
    uint32 xcnt;                   // æ´»è·ƒäº‹åŠ¡æ•°é‡
    TransactionId *subxip;         // å­äº‹åŠ¡IDæ•°ç»„
    uint32 subxcnt;                // å­äº‹åŠ¡æ•°é‡
    CommandId curcid;               // å½“å‰å‘½ä»¤ID
    uint32 active_count;           // æ´»è·ƒå¿«ç…§è®¡æ•°
    uint32 regd_count;             // æ³¨å†Œè®¡æ•°
    bool copied;                   // æ˜¯å¦å·²å¤åˆ¶
    bool takenDuringRecovery;      // æ˜¯å¦åœ¨æ¢å¤æœŸé—´åˆ›å»º
} SnapshotData;
```

**æœ¬ä½“ç³»å®šä¹‰**:

xipï¼ˆæ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼‰æ˜¯PostgreSQL MVCCå¿«ç…§çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨å¿«ç…§åˆ›å»ºæ—¶æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„äº‹åŠ¡IDæ•°ç»„ã€‚xipåœ¨å¯è§æ€§åˆ¤æ–­ä¸­èµ·å…³é”®ä½œç”¨ï¼šå¦‚æœå…ƒç»„çš„xminåœ¨xipä¸­ï¼Œè¯´æ˜åˆ›å»ºè¯¥å…ƒç»„çš„äº‹åŠ¡åœ¨å¿«ç…§åˆ›å»ºæ—¶ä»åœ¨è¿è¡Œï¼ˆæœªæäº¤ï¼‰ï¼Œå› æ­¤è¯¥å…ƒç»„å¯¹å¿«ç…§ä¸å¯è§ï¼Œä»è€Œé˜²æ­¢è„è¯»ã€‚xipæ•°ç»„æ˜¯æœ‰åºçš„ï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—å¯è§æ€§åˆ¤æ–­çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log N_active)ã€‚

**xipä¸å¿«ç…§çš„å…³ç³»**:

```text
å¿«ç…§æ•°æ®ç»“æ„:
â”‚
â”œâ”€ å¿«ç…§ (Snapshot) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: æ•°æ®åº“åœ¨æŸä¸€æ—¶åˆ»çš„ä¸€è‡´æ€§è§†å›¾
â”‚       â”œâ”€ xmin: æœ€æ—©æ´»è·ƒäº‹åŠ¡ID
â”‚       â”œâ”€ xmax: ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
â”‚       â””â”€ xip: æ´»è·ƒäº‹åŠ¡IDæ•°ç»„
â”‚           â””â”€ ä½œç”¨: é˜²æ­¢è„è¯»ï¼Œæ ‡è¯†æœªæäº¤äº‹åŠ¡
â”‚
â””â”€ å¯è§æ€§åˆ¤æ–­
    â””â”€ ä½¿ç”¨: åŸºäºxipåˆ¤æ–­å…ƒç»„æ˜¯å¦å¯è§
```

---

##### 1.3.5.5.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1.3.5.5.1 (xip - æ´»è·ƒäº‹åŠ¡åˆ—è¡¨)**:

å¯¹äºå¿«ç…§$snap$ï¼Œxipå®šä¹‰ä¸ºï¼š

$$snap.\text{xip} = \{xid | xid \text{ is active} \land snap.\text{xmin} \leq xid < snap.\text{xmax}\}$$

å…¶ä¸­ï¼š

- $xid$: äº‹åŠ¡ID
- $\text{active}$: äº‹åŠ¡å¤„äºæ´»è·ƒçŠ¶æ€ï¼ˆæœªæäº¤ä¸”æœªä¸­æ­¢ï¼‰

å³ï¼šxipåŒ…å«å¿«ç…§åˆ›å»ºæ—¶æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„äº‹åŠ¡IDï¼Œä¸”è¿™äº›äº‹åŠ¡IDåœ¨[xmin, xmax)èŒƒå›´å†…ã€‚

**å®šä¹‰1.3.5.5.2 (xipæœ‰åºæ€§)**:

xipæ•°ç»„æ˜¯æœ‰åºçš„ï¼š

$$\forall i < j: snap.\text{xip}[i] < snap.\text{xip}[j]$$

å³ï¼šxipæ•°ç»„æŒ‰äº‹åŠ¡IDå‡åºæ’åˆ—ï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾ã€‚

**å®šä¹‰1.3.5.5.3 (xipåœ¨å¯è§æ€§åˆ¤æ–­ä¸­çš„ä½œç”¨)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬$\tau$å’Œå¿«ç…§$snap$ï¼Œå¦‚æœ$\tau.\text{xmin} \in snap.\text{xip}$ï¼Œåˆ™$\tau$å¯¹$snap$ä¸å¯è§ï¼š

$$\tau.\text{xmin} \in snap.\text{xip} \implies \neg \text{Visible}(\tau, snap)$$

å³ï¼šå¦‚æœå…ƒç»„çš„åˆ›å»ºäº‹åŠ¡IDåœ¨xipä¸­ï¼Œè¯´æ˜åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§åˆ›å»ºæ—¶æœªæäº¤ï¼Œå› æ­¤å…ƒç»„ä¸å¯è§ã€‚

**å®šä¹‰1.3.5.5.4 (xipæŸ¥æ‰¾å¤æ‚åº¦)**:

xipæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

$$T_{xip\_lookup} = O(\log |snap.\text{xip}|) = O(\log N_{active})$$

å…¶ä¸­$N_{active}$æ˜¯æ´»è·ƒäº‹åŠ¡æ•°é‡ã€‚

å³ï¼šç”±äºxipæ˜¯æœ‰åºæ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(log N_active)ã€‚

---

##### 1.3.5.5.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1980å¹´ä»£**: æ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ¦‚å¿µæå‡º
   - é¦–æ¬¡åœ¨å¿«ç…§éš”ç¦»ä¸­ä½¿ç”¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - ç®€å•çš„çº¿æ€§æŸ¥æ‰¾
   - æ—¶é—´å¤æ‚åº¦O(N_active)

2. **1990å¹´ä»£**: PostgreSQLå®ç°xip
   - åœ¨å¿«ç…§ä¸­å­˜å‚¨æ´»è·ƒäº‹åŠ¡æ•°ç»„
   - ä½¿ç”¨æœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾
   - æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–ä¸ºO(log N_active)

3. **2000å¹´ä»£**: xipä¼˜åŒ–å®Œå–„
   - ä¼˜åŒ–xipæ•°ç»„åˆ†é…å’Œæ’åº
   - å‡å°‘xipæ•°ç»„å¤§å°ï¼ˆå­äº‹åŠ¡ä¼˜åŒ–ï¼‰
   - æå‡å¯è§æ€§åˆ¤æ–­æ€§èƒ½

4. **2010å¹´ä»£è‡³ä»Š**: xipæœºåˆ¶æˆç†Ÿ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ä½¿ç”¨ç±»ä¼¼æœºåˆ¶
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–xipæ€§èƒ½
   - xipæˆä¸ºå¿«ç…§éš”ç¦»çš„æ ‡å‡†ç»„ä»¶

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦xipï¼Ÿ**

1. **é˜²æ­¢è„è¯»çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦è¯†åˆ«æœªæäº¤äº‹åŠ¡åˆ›å»ºçš„å…ƒç»„
   - **è§£å†³**: xipå­˜å‚¨æ´»è·ƒäº‹åŠ¡IDï¼Œç”¨äºåˆ¤æ–­å…ƒç»„æ˜¯å¦ç”±æœªæäº¤äº‹åŠ¡åˆ›å»º
   - **æ•ˆæœ**: é˜²æ­¢è„è¯»ï¼Œä¿è¯éš”ç¦»æ€§

2. **å¯è§æ€§åˆ¤æ–­çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦å¿«é€Ÿåˆ¤æ–­å…ƒç»„çš„åˆ›å»ºäº‹åŠ¡æ˜¯å¦å·²æäº¤
   - **è§£å†³**: xipæœ‰åºæ•°ç»„æ”¯æŒO(log N_active)æŸ¥æ‰¾
   - **æ•ˆæœ**: é«˜æ•ˆçš„å¯è§æ€§åˆ¤æ–­

3. **å¿«ç…§å®Œæ•´æ€§çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: å¿«ç…§éœ€è¦å®Œæ•´è®°å½•æ´»è·ƒäº‹åŠ¡çŠ¶æ€
   - **è§£å†³**: xipå®Œæ•´è®°å½•æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ID
   - **æ•ˆæœ**: ä¿è¯å¿«ç…§çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

**ç†è®ºä½ç½®**:

```text
å¿«ç…§éš”ç¦»ç†è®ºä½“ç³»:
â”‚
â”œâ”€ å¿«ç…§éš”ç¦»ç†è®º
â”‚   â””â”€ æ ¸å¿ƒ: åŸºäºå¿«ç…§çš„å¹¶å‘æ§åˆ¶
â”‚
â”œâ”€ xipç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: æ´»è·ƒäº‹åŠ¡IDæ•°ç»„
â”‚       â”œâ”€ å­˜å‚¨: æœ‰åºæ•°ç»„
â”‚       â”œâ”€ æŸ¥æ‰¾: äºŒåˆ†æŸ¥æ‰¾ O(log N)
â”‚       â””â”€ ä½œç”¨: é˜²æ­¢è„è¯»ï¼Œæ ‡è¯†æœªæäº¤äº‹åŠ¡
â”‚
â””â”€ å¯è§æ€§ç†è®º
    â””â”€ å®ç°: åŸºäºxipåˆ¤æ–­å¯è§æ€§
```

**xipä¸å¿«ç…§çš„å…³ç³»**:

```text
xipä¸å¿«ç…§:
â”‚
â”œâ”€ å¿«ç…§æ˜¯æ•°æ®ç»“æ„
â”‚   â””â”€ åŒ…å«xminã€xmaxã€xip
â”‚
â””â”€ xipæ˜¯å¿«ç…§çš„ç»„ä»¶
    â””â”€ ç”¨äºå¯è§æ€§åˆ¤æ–­
```

**ç†è®ºæ¨å¯¼**:

```text
ä»é˜²æ­¢è„è¯»åˆ°xipå®ç°çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: é˜²æ­¢è„è¯»ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: è¯†åˆ«æœªæäº¤äº‹åŠ¡ï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: é«˜æ•ˆå¯è§æ€§åˆ¤æ–­ï¼ˆé‡è¦ï¼‰

2. xipè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: åœ¨å¿«ç…§ä¸­å­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   â”œâ”€ æœºåˆ¶: æœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾
   â””â”€ åˆ¤æ–­: å¦‚æœxminåœ¨xipä¸­ï¼Œå…ƒç»„ä¸å¯è§

3. å®ç°é€‰æ‹©
   â”œâ”€ å­˜å‚¨: æœ‰åºæ•°ç»„å­˜å‚¨æ´»è·ƒäº‹åŠ¡ID
   â”œâ”€ æŸ¥æ‰¾: äºŒåˆ†æŸ¥æ‰¾åˆ¤æ–­xminæ˜¯å¦åœ¨xipä¸­
   â””â”€ ä¼˜åŒ–: å‡å°‘xipæ•°ç»„å¤§å°ï¼Œæå‡æŸ¥æ‰¾æ€§èƒ½

4. ç»“è®º
   â””â”€ xipæ˜¯é˜²æ­¢è„è¯»å’Œå®ç°å¯è§æ€§åˆ¤æ–­çš„å…³é”®ç»„ä»¶
```

---

##### 1.3.5.5.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: xipæ­£ç¡®é˜²æ­¢è„è¯»**

```sql
-- åœºæ™¯: å¤šä¸ªäº‹åŠ¡å¹¶å‘è®¿é—®åŒä¸€è¡Œ
-- éœ€æ±‚: å¿…é¡»é˜²æ­¢è„è¯»

-- äº‹åŠ¡T1 (æœªæäº¤)
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- åˆ›å»ºv2: xmin=105, xmax=0, balance=1500
-- äº‹åŠ¡T1æœªæäº¤

-- äº‹åŠ¡T2 (å¿«ç…§åˆ›å»º)
BEGIN;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=106, xip=[105]
-- xipåŒ…å«T1çš„äº‹åŠ¡IDï¼ˆ105ï¼‰

-- äº‹åŠ¡T2è¯»å–
SELECT balance FROM accounts WHERE id = 1;
-- å¯è§æ€§åˆ¤æ–­:
--   v2.xmin(105) < snap.xmax(106) âœ“
--   v2.xmin(105) âˆˆ snap.xip([105]) âœ— â†’ ä¸å¯è§ âœ“
--   v1.xmin(100) < snap.xmax(106) âœ“
--   v1.xmin(100) âˆ‰ snap.xip([105]) âœ“
--   v1.xmax(0) = 0 âœ“
-- è¿”å›: balance=1000 (åŸºäºv1) âœ“
-- ç»“æœ: é˜²æ­¢è„è¯» âœ“
```

**åˆ†æ**:

- âœ… é˜²æ­¢è„è¯»ï¼šxipæ­£ç¡®æ ‡è¯†æœªæäº¤äº‹åŠ¡ï¼Œé˜²æ­¢è¯»å–æœªæäº¤æ•°æ®
- âœ… å¯è§æ€§åˆ¤æ–­ï¼šåŸºäºxipå¿«é€Ÿåˆ¤æ–­å…ƒç»„æ˜¯å¦å¯è§
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯äº‹åŠ¡åªçœ‹åˆ°å·²æäº¤çš„æ•°æ®

---

**æ­£ä¾‹2: xipæ”¯æŒé«˜æ•ˆå¯è§æ€§åˆ¤æ–­**

```sql
-- åœºæ™¯: é«˜å¹¶å‘ç³»ç»Ÿï¼Œ100ä¸ªæ´»è·ƒäº‹åŠ¡
-- éœ€æ±‚: å¿…é¡»é«˜æ•ˆåˆ¤æ–­å¯è§æ€§

-- å¿«ç…§åˆ›å»º
Snapshot {
    xmin = 100,
    xmax = 201,
    xip = [102, 105, 108, 110, ..., 199]  -- 100ä¸ªæ´»è·ƒäº‹åŠ¡IDï¼ˆæœ‰åºï¼‰
}

-- å¯è§æ€§åˆ¤æ–­
Tuple {xmin=150, xmax=0}
-- æŸ¥æ‰¾: xmin(150)æ˜¯å¦åœ¨xipä¸­
-- æ–¹æ³•: äºŒåˆ†æŸ¥æ‰¾
-- æ­¥éª¤1: xip[50] = 150? â†’ æ˜¯ âœ“
-- ç»“æœ: xmin(150) âˆˆ xip â†’ ä¸å¯è§ âœ“
-- æ—¶é—´å¤æ‚åº¦: O(log 100) = O(7) âœ“
```

**åˆ†æ**:

- âœ… é«˜æ•ˆæŸ¥æ‰¾ï¼šxipæœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦O(log N)
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå³ä½¿æœ‰100ä¸ªæ´»è·ƒäº‹åŠ¡ï¼ŒæŸ¥æ‰¾ä¹Ÿåªéœ€è¦7æ¬¡æ¯”è¾ƒ
- âœ… å¯æ‰©å±•æ€§ï¼šæ´»è·ƒäº‹åŠ¡æ•°å¢åŠ æ—¶ï¼Œæ€§èƒ½å½±å“å¯æ§

---

**åä¾‹åˆ†æ**:

**åä¾‹1: xipåˆ—è¡¨ä¸å®Œæ•´å¯¼è‡´è„è¯»**

```sql
-- é”™è¯¯åœºæ™¯: å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
-- é—®é¢˜: xipåˆ—è¡¨ä¸å®Œæ•´ï¼Œå¯¼è‡´è„è¯»

-- é”™è¯¯çš„å¿«ç…§åˆ›å»º
def wrong_snapshot():
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=[]  # é”™è¯¯: ç©ºåˆ—è¡¨ï¼Œæœªè·å–æ´»è·ƒäº‹åŠ¡ âœ—
    )
    return snapshot

-- äº‹åŠ¡T1 (æœªæäº¤)
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- åˆ›å»ºv2: xmin=105, xmax=0, balance=1500
-- äº‹åŠ¡T1æœªæäº¤

-- äº‹åŠ¡T2 (é”™è¯¯çš„å¿«ç…§)
BEGIN;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=106, xip=[] âœ—
-- é”™è¯¯: xipä¸ºç©ºï¼ŒæœªåŒ…å«T1çš„äº‹åŠ¡ID

-- äº‹åŠ¡T2è¯»å–
SELECT balance FROM accounts WHERE id = 1;
-- å¯è§æ€§åˆ¤æ–­:
--   v2.xmin(105) < snap.xmax(106) âœ“
--   v2.xmin(105) âˆˆ snap.xip([])? â†’ å¦ âœ—
--   é”™è¯¯åˆ¤æ–­: å¯è§ âœ—
-- è¿”å›: balance=1500 (åŸºäºv2) âœ—
-- ç»“æœ: è„è¯» âœ—
```

**é”™è¯¯åŸå› **:

- å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- xipåˆ—è¡¨ä¸ºç©ºï¼Œå¯¼è‡´æœªæäº¤äº‹åŠ¡è¢«è¯¯è®¤ä¸ºå·²æäº¤
- å¯è§æ€§åˆ¤æ–­åŸºäºé”™è¯¯çš„xipï¼Œå¯¼è‡´è„è¯»

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®çš„å¿«ç…§åˆ›å»º
def correct_snapshot():
    # æ­£ç¡®: è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    active_xids = get_active_transaction_ids()  # å…³é”®
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=active_xids  # æ­£ç¡®çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ âœ“
    )
    return snapshot
```

**åæœåˆ†æ**:

- **è„è¯»**: è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
- **æ•°æ®é”™è¯¯**: åŸºäºé”™è¯¯æ•°æ®åšå‡ºå†³ç­–
- **ä¸€è‡´æ€§ç ´å**: è¿åACIDçš„éš”ç¦»æ€§

---

**åä¾‹2: xipæœªæ’åºå¯¼è‡´æŸ¥æ‰¾æ€§èƒ½å·®**

```sql
-- é”™è¯¯åœºæ™¯: xipæ•°ç»„æœªæ’åº
-- é—®é¢˜: æ— æ³•ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾æ€§èƒ½å·®

-- é”™è¯¯çš„xipå®ç°
def wrong_xip():
    active_xids = get_active_transaction_ids()
    # é”™è¯¯: æœªæ’åº
    xip = active_xids  # æ— åºæ•°ç»„ âœ—
    return xip

-- å¯è§æ€§åˆ¤æ–­
Tuple {xmin=150, xmax=0}
-- æŸ¥æ‰¾: xmin(150)æ˜¯å¦åœ¨xipä¸­
-- æ–¹æ³•: çº¿æ€§æŸ¥æ‰¾ï¼ˆå¿…é¡»ï¼‰
-- æ­¥éª¤: éå†xipæ•°ç»„ï¼Œç›´åˆ°æ‰¾åˆ°æˆ–éå†å®Œ
-- æ—¶é—´å¤æ‚åº¦: O(N) = O(100) âœ—
-- æ€§èƒ½: å·® âœ—
```

**é”™è¯¯åŸå› **:

- xipæ•°ç»„æœªæ’åºï¼Œæ— æ³•ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾
- å¿…é¡»ä½¿ç”¨çº¿æ€§æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦O(N)
- æ´»è·ƒäº‹åŠ¡æ•°å¤šæ—¶ï¼Œæ€§èƒ½å·®

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®çš„xipå®ç°
def correct_xip():
    active_xids = get_active_transaction_ids()
    # æ­£ç¡®: æ’åº
    xip = sorted(active_xids)  # æœ‰åºæ•°ç»„ âœ“
    return xip

-- å¯è§æ€§åˆ¤æ–­
Tuple {xmin=150, xmax=0}
-- æŸ¥æ‰¾: xmin(150)æ˜¯å¦åœ¨xipä¸­
-- æ–¹æ³•: äºŒåˆ†æŸ¥æ‰¾
-- æ—¶é—´å¤æ‚åº¦: O(log N) = O(7) âœ“
-- æ€§èƒ½: å¥½ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: çº¿æ€§æŸ¥æ‰¾å¯¼è‡´æ€§èƒ½ä¸‹é™
- **å¯æ‰©å±•æ€§å·®**: æ´»è·ƒäº‹åŠ¡æ•°å¢åŠ æ—¶ï¼Œæ€§èƒ½çº¿æ€§ä¸‹é™
- **ç³»ç»Ÿè´Ÿè½½**: é«˜å¹¶å‘æ—¶ï¼Œå¯è§æ€§åˆ¤æ–­æˆä¸ºç“¶é¢ˆ

---

**åä¾‹3: xipæ•°ç»„è¿‡å¤§å¯¼è‡´å†…å­˜å¼€é”€**

```sql
-- é”™è¯¯åœºæ™¯: å¤§é‡é•¿äº‹åŠ¡å¯¼è‡´xipæ•°ç»„è¿‡å¤§
-- é—®é¢˜: å†…å­˜å¼€é”€å¤§ï¼Œå¿«ç…§åˆ›å»ºæ…¢

-- åœºæ™¯: 1000ä¸ªé•¿äº‹åŠ¡ï¼ˆè¿è¡Œ1å°æ—¶ï¼‰
-- xipæ•°ç»„å¤§å°: 1000ä¸ªäº‹åŠ¡ID = 4000å­—èŠ‚
-- å¿«ç…§åˆ›å»º: éœ€è¦æ‰«æ1000ä¸ªæ´»è·ƒäº‹åŠ¡ âœ—
-- å†…å­˜å¼€é”€: å¤§ âœ—
-- å¿«ç…§åˆ›å»ºæ—¶é—´: æ…¢ âœ—
```

**é”™è¯¯åŸå› **:

- å¤§é‡é•¿äº‹åŠ¡å¯¼è‡´xipæ•°ç»„è¿‡å¤§
- å¿«ç…§åˆ›å»ºéœ€è¦æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œå¼€é”€å¤§
- å†…å­˜å¼€é”€å’Œåˆ›å»ºæ—¶é—´éƒ½å¢åŠ 

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: é¿å…é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ1: æ‹†åˆ†é•¿äº‹åŠ¡
BEGIN;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;  -- ç«‹å³æäº¤

-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;
```

**åæœåˆ†æ**:

- **å†…å­˜å¼€é”€**: xipæ•°ç»„è¿‡å¤§ï¼Œå†…å­˜æµªè´¹
- **å¿«ç…§åˆ›å»ºæ…¢**: æ‰«æå¤§é‡æ´»è·ƒäº‹åŠ¡ï¼Œåˆ›å»ºæ—¶é—´å¢åŠ 
- **ç³»ç»Ÿæ€§èƒ½**: å½±å“æ•´ä½“ç³»ç»Ÿæ€§èƒ½

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘ç³»ç»Ÿä½¿ç”¨xip**

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘ç³»ç»Ÿï¼ˆ1000+ TPSï¼‰
- 100ä¸ªæ´»è·ƒäº‹åŠ¡
- éœ€è¦é«˜æ•ˆå¯è§æ€§åˆ¤æ–­

**ä¸ºä»€ä¹ˆéœ€è¦xip**:

- âœ… é˜²æ­¢è„è¯»ï¼šxipæ ‡è¯†æœªæäº¤äº‹åŠ¡ï¼Œé˜²æ­¢è„è¯»
- âœ… é«˜æ•ˆæŸ¥æ‰¾ï¼šxipæœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå³ä½¿æœ‰100ä¸ªæ´»è·ƒäº‹åŠ¡ï¼ŒæŸ¥æ‰¾ä¹Ÿåªéœ€è¦7æ¬¡æ¯”è¾ƒ

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLè‡ªåŠ¨ä½¿ç”¨xip
BEGIN;
-- å¿«ç…§åˆ›å»º: è‡ªåŠ¨è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œæ„å»ºxipæ•°ç»„
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: åŸºäºxipåˆ¤æ–­å¯è§æ€§ âœ“
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **é˜²æ­¢è„è¯»**: xipæ­£ç¡®æ ‡è¯†æœªæäº¤äº‹åŠ¡ âœ“
- **é«˜æ•ˆæŸ¥æ‰¾**: äºŒåˆ†æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦O(log N) âœ“
- **ç³»ç»Ÿæ€§èƒ½**: å¯è§æ€§åˆ¤æ–­æ€§èƒ½é«˜ âœ“

---

**åœºæ™¯2: é•¿äº‹åŠ¡ç³»ç»Ÿä¼˜åŒ–xip**

**åœºæ™¯æè¿°**:

- é•¿äº‹åŠ¡ç³»ç»Ÿï¼ˆäº‹åŠ¡æ—¶é•¿>1å°æ—¶ï¼‰
- å¤§é‡é•¿äº‹åŠ¡å¯¼è‡´xipæ•°ç»„è¿‡å¤§
- éœ€è¦ä¼˜åŒ–xipæ•°ç»„å¤§å°

**ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–**:

- âœ… å‡å°‘å†…å­˜å¼€é”€ï¼šå‡å°‘xipæ•°ç»„å¤§å°
- âœ… æå‡å¿«ç…§åˆ›å»ºæ€§èƒ½ï¼šå‡å°‘æ´»è·ƒäº‹åŠ¡æ‰«æ
- âœ… ç³»ç»Ÿæ€§èƒ½ï¼šé¿å…é•¿äº‹åŠ¡å½±å“ç³»ç»Ÿæ€§èƒ½

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ç›‘æ§é•¿äº‹åŠ¡
SELECT pid, now() - xact_start AS duration
FROM pg_stat_activity
WHERE state = 'active' AND now() - xact_start > interval '1 hour';

-- é¿å…é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ1: æ‹†åˆ†é•¿äº‹åŠ¡
BEGIN;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;

-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committed
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **å†…å­˜å¼€é”€é™ä½**: å‡å°‘xipæ•°ç»„å¤§å° âœ“
- **å¿«ç…§åˆ›å»ºå¿«**: å‡å°‘æ´»è·ƒäº‹åŠ¡æ‰«æ âœ“
- **ç³»ç»Ÿæ€§èƒ½**: é¿å…é•¿äº‹åŠ¡å½±å“ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»é˜²æ­¢è„è¯»åˆ°xipå®ç°çš„æ¨ç†**

```text
å‰æ1: éœ€è¦é˜²æ­¢è„è¯»ï¼ˆå¿…é¡»ï¼‰
å‰æ2: éœ€è¦è¯†åˆ«æœªæäº¤äº‹åŠ¡ï¼ˆå¿…é¡»ï¼‰
å‰æ3: éœ€è¦é«˜æ•ˆå¯è§æ€§åˆ¤æ–­ï¼ˆé‡è¦ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©è¯†åˆ«æœªæäº¤äº‹åŠ¡çš„æœºåˆ¶
æ¨ç†æ­¥éª¤2: xipå­˜å‚¨æ´»è·ƒäº‹åŠ¡IDï¼ˆæ»¡è¶³å‰æ2ï¼‰
æ¨ç†æ­¥éª¤3: xipæœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾ï¼ˆæ»¡è¶³å‰æ3ï¼‰

ç»“è®º: ä½¿ç”¨xipé˜²æ­¢è„è¯»å’Œå®ç°å¯è§æ€§åˆ¤æ–­ âœ“
```

**æ¨ç†é“¾æ¡2: ä»xipæŸ¥æ‰¾åˆ°æ€§èƒ½ä¼˜åŒ–çš„æ¨ç†**

```text
å‰æ1: xipæ˜¯æœ‰åºæ•°ç»„
å‰æ2: äºŒåˆ†æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦O(log N)
å‰æ3: çº¿æ€§æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦O(N)

æ¨ç†æ­¥éª¤1: xipæœ‰åºæ•°ç»„æ”¯æŒäºŒåˆ†æŸ¥æ‰¾
æ¨ç†æ­¥éª¤2: äºŒåˆ†æŸ¥æ‰¾æ¯”çº¿æ€§æŸ¥æ‰¾å¿«
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼Œxipæ”¯æŒé«˜æ•ˆå¯è§æ€§åˆ¤æ–­

ç»“è®º: xipæœºåˆ¶æ”¯æŒé«˜æ•ˆå¯è§æ€§åˆ¤æ–­ âœ“
```

---

##### 1.3.5.5.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¿«ç…§çš„å…³ç³»**:
   - xipæ˜¯å¿«ç…§çš„æ ¸å¿ƒç»„ä»¶
   - å¿«ç…§åŒ…å«xminã€xmaxã€xipä¸‰ä¸ªç»„ä»¶
   - xipç”¨äºå¿«ç…§çš„å¯è§æ€§åˆ¤æ–­

2. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - xipç”¨äºå¯è§æ€§åˆ¤æ–­
   - å¦‚æœå…ƒç»„çš„xminåœ¨xipä¸­ï¼Œå…ƒç»„ä¸å¯è§
   - xipæ˜¯é˜²æ­¢è„è¯»çš„å…³é”®æœºåˆ¶

3. **ä¸xmin/xmaxçš„å…³ç³»**:
   - xipä¸xmin/xmaxå…±åŒå†³å®šå¯è§æ€§
   - xmin/xmaxæ ‡è¯†ç‰ˆæœ¬çš„åˆ›å»ºå’Œåˆ é™¤äº‹åŠ¡
   - xipæ ‡è¯†å“ªäº›äº‹åŠ¡åœ¨å¿«ç…§åˆ›å»ºæ—¶æœªæäº¤

4. **ä¸OldestXminçš„å…³ç³»**:
   - OldestXminæ˜¯xipä¸­çš„æœ€å°å€¼ï¼ˆå¦‚æœæœ‰æ´»è·ƒäº‹åŠ¡ï¼‰
   - xipåŒ…å«æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ID
   - OldestXminç”¨äºVACUUMï¼Œxipç”¨äºå¯è§æ€§åˆ¤æ–­

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL xipç³»ç»Ÿå®ç°
   - xipå­˜å‚¨åœ¨å¿«ç…§ç»“æ„ä¸­
   - æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ç®¡ç†
   - äºŒåˆ†æŸ¥æ‰¾å®ç°

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - xip â‰ˆ æ´»è·ƒèŠ‚ç‚¹çš„å‘é‡æ—¶é’Ÿ
   - å¿«ç…§ â‰ˆ å…¨å±€çŠ¶æ€å¿«ç…§
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ ç‰ˆæœ¬æ¯”è¾ƒ

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - xip â‰ˆ åˆ†å¸ƒå¼æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å¿«ç…§ â‰ˆ åˆ†å¸ƒå¼å¿«ç…§
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ åˆ†å¸ƒå¼ä¸€è‡´æ€§æ£€æŸ¥

**å®ç°ç»†èŠ‚**:

**PostgreSQL xipå®ç°æ¶æ„**:

```c
// src/backend/utils/time/snapmgr.c

// è·å–å¿«ç…§ï¼ˆåŒ…å«xipæ„å»ºï¼‰
Snapshot GetSnapshotData(Snapshot snapshot)
{
    ProcArrayStruct *arrayP = procArray;
    TransactionId xmin;
    TransactionId xmax;
    TransactionId *xip;
    int count = 0;

    // 1. è·å–xminå’Œxmax
    xmin = GetOldestXmin(NULL, PROCARRAY_FLAGS_VACUUM);
    xmax = ShmemVariableCache->nextXid;

    // 2. åˆ†é…xipæ•°ç»„
    xip = (TransactionId *) palloc(arrayP->maxProcs * sizeof(TransactionId));

    // 3. æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œæ„å»ºxipæ•°ç»„
    LWLockAcquire(ProcArrayLock, LW_SHARED);
    for (int i = 0; i < arrayP->numProcs; i++) {
        PGPROC *proc = arrayP->procs[i];
        if (TransactionIdIsValid(proc->xid)) {
            if (TransactionIdPrecedes(proc->xid, xmax)) {
                xip[count++] = proc->xid;
            }
        }
    }
    LWLockRelease(ProcArrayLock);

    // 4. æ’åºxipæ•°ç»„ï¼ˆç”¨äºäºŒåˆ†æŸ¥æ‰¾ï¼‰
    qsort(xip, count, sizeof(TransactionId), xidComparator);

    // 5. è®¾ç½®å¿«ç…§
    snapshot->xmin = xmin;
    snapshot->xmax = xmax;
    snapshot->xip = xip;
    snapshot->xcnt = count;

    return snapshot;
}

// äºŒåˆ†æŸ¥æ‰¾xip
bool XidInSnapshot(TransactionId xid, Snapshot snapshot)
{
    TransactionId *xip = snapshot->xip;
    int left = 0;
    int right = snapshot->xcnt - 1;

    while (left <= right) {
        int mid = (left + right) / 2;
        if (xip[mid] == xid) {
            return true;
        } else if (xip[mid] < xid) {
            left = mid + 1;
        } else {
            right = mid - 1;
        }
    }
    return false;
}
```

**xipä½¿ç”¨æœºåˆ¶**:

```python
def use_xip_for_visibility(tuple, snapshot, current_txid):
    """
    xipç”¨äºå¯è§æ€§åˆ¤æ–­

    æœºåˆ¶:
    1. æ£€æŸ¥å…ƒç»„çš„xminæ˜¯å¦åœ¨xipä¸­
    2. å¦‚æœåœ¨xipä¸­ï¼Œè¯´æ˜åˆ›å»ºäº‹åŠ¡æœªæäº¤ï¼Œå…ƒç»„ä¸å¯è§
    3. å¦‚æœä¸åœ¨xipä¸­ï¼Œç»§ç»­å…¶ä»–å¯è§æ€§æ£€æŸ¥
    """
    # 1. æ£€æŸ¥xminæ˜¯å¦åœ¨xipä¸­ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰
    if binary_search(snapshot.xip, tuple.xmin):
        return False  # åˆ›å»ºäº‹åŠ¡æœªæäº¤ï¼Œä¸å¯è§

    # 2. ç»§ç»­å…¶ä»–å¯è§æ€§æ£€æŸ¥
    # ...

    return True
```

**æ€§èƒ½å½±å“**:

1. **xipæ•°ç»„æ„å»ºå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active} \log N_{active})$ - æ‰«ææ´»è·ƒäº‹åŠ¡ + æ’åº
   - ç©ºé—´å¤æ‚åº¦: $O(N_{active})$ - å­˜å‚¨æ´»è·ƒäº‹åŠ¡IDæ•°ç»„
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°é‡ï¼‰

2. **xipæŸ¥æ‰¾å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(\log N_{active})$ - äºŒåˆ†æŸ¥æ‰¾
   - ç©ºé—´å¤æ‚åº¦: $O(1)$ - ä¸éœ€è¦é¢å¤–ç©ºé—´
   - å…¸å‹å¼€é”€: < 0.1Î¼sï¼ˆå³ä½¿æœ‰100ä¸ªæ´»è·ƒäº‹åŠ¡ï¼‰

3. **æ€»ä½“æ€§èƒ½**:
   - xipæ„å»º: 1-10Î¼sï¼ˆå¿«ç…§åˆ›å»ºæ—¶ï¼‰
   - xipæŸ¥æ‰¾: < 0.1Î¼sï¼ˆæ¯æ¬¡å¯è§æ€§åˆ¤æ–­ï¼‰
   - æ€»ä½“å½±å“: xipå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å°ï¼Œä½†å¯¹æ­£ç¡®æ€§å½±å“å¤§

---

##### 1.3.5.5.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**xipæ•°ç»„æ„å»ºæ—¶é—´å¼€é”€**:

$$T_{xip\_build} = T_{scan} + T_{sort}$$

å…¶ä¸­ï¼š

- $T_{scan} = O(N_{active})$ - æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ—¶é—´
- $T_{sort} = O(N_{active} \log N_{active})$ - æ’åºxipæ•°ç»„æ—¶é—´

**xipæŸ¥æ‰¾æ—¶é—´å¼€é”€**:

$$T_{xip\_lookup} = O(\log N_{active})$$

å…¶ä¸­$N_{active}$æ˜¯æ´»è·ƒäº‹åŠ¡æ•°é‡ã€‚

**xipæ•°ç»„ç©ºé—´å¼€é”€**:

$$S_{xip} = N_{active} \times \text{sizeof}(\text{TransactionId}) = N_{active} \times 4 \text{ bytes}$$

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | æ´»è·ƒäº‹åŠ¡æ•° | xipæ„å»ºæ—¶é—´ | xipæŸ¥æ‰¾æ—¶é—´ | xipæ•°ç»„å¤§å° | è¯´æ˜ |
|-----|----------|-----------|-----------|-----------|------|
| **æ­£å¸¸è´Ÿè½½** | 10-50 | 1-5Î¼s | < 0.1Î¼s | 40-200å­—èŠ‚ | å¼€é”€å¾ˆå° |
| **é«˜å¹¶å‘** | 50-200 | 5-10Î¼s | < 0.1Î¼s | 200-800å­—èŠ‚ | å¼€é”€å¯æ¥å— |
| **é•¿äº‹åŠ¡** | 100-1000 | 10-50Î¼s | 0.1-0.3Î¼s | 400-4000å­—èŠ‚ | å¼€é”€å¢åŠ  |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–xipæ„å»º**:
   - ä¼˜åŒ–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ‰«æ
   - ä½¿ç”¨å¢é‡æ’åºï¼ˆå¦‚æœå¯èƒ½ï¼‰
   - ç¼“å­˜xipæ•°ç»„ï¼ˆå¦‚æœå¿«ç…§å¯å¤ç”¨ï¼‰

2. **ä¼˜åŒ–xipæŸ¥æ‰¾**:
   - ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼ˆå·²å®ç°ï¼‰
   - ä½¿ç”¨ä½å›¾ä¼˜åŒ–ï¼ˆå¦‚æœæ´»è·ƒäº‹åŠ¡æ•°å°‘ï¼‰
   - ä½¿ç”¨Hint Bitså‡å°‘æŸ¥æ‰¾æ¬¡æ•°

3. **å‡å°‘æ´»è·ƒäº‹åŠ¡æ•°**:
   - é¿å…é•¿äº‹åŠ¡
   - ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
   - ç›‘æ§æ´»è·ƒäº‹åŠ¡æ•°

---

##### 1.3.5.5.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: xipæ˜¯å¿«ç…§ä¸­å­˜å‚¨æ´»è·ƒäº‹åŠ¡IDçš„æœ‰åºæ•°ç»„
2. **ä½œç”¨**: xipç”¨äºå¯è§æ€§åˆ¤æ–­ï¼Œé˜²æ­¢è„è¯»ï¼Œæ ‡è¯†æœªæäº¤äº‹åŠ¡
3. **å®ç°**: PostgreSQLä½¿ç”¨æœ‰åºæ•°ç»„å­˜å‚¨xipï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾
4. **æ€§èƒ½**: xipæ„å»ºå¼€é”€1-10Î¼sï¼ŒæŸ¥æ‰¾å¼€é”€< 0.1Î¼sï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å°

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºxipä¸é‡è¦
   - **é”™è¯¯**: å¿½ç•¥xipå¯¼è‡´è„è¯»
   - **æ­£ç¡®**: xipæ˜¯é˜²æ­¢è„è¯»çš„å…³é”®æœºåˆ¶ï¼Œå¿…é¡»æ­£ç¡®å®ç°

2. **è¯¯åŒº2**: è®¤ä¸ºxipå¯ä»¥æ— åº
   - **é”™è¯¯**: è®¤ä¸ºxipæ•°ç»„å¯ä»¥æ— åºå­˜å‚¨
   - **æ­£ç¡®**: xipå¿…é¡»æœ‰åºï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¦åˆ™æ€§èƒ½å·®

3. **è¯¯åŒº3**: ä¸ç†è§£xipä¸OldestXminçš„å…³ç³»
   - **é”™è¯¯**: è®¤ä¸ºxipå’ŒOldestXminæ˜¯ç‹¬ç«‹çš„
   - **æ­£ç¡®**: OldestXminæ˜¯xipä¸­çš„æœ€å°å€¼ï¼ˆå¦‚æœæœ‰æ´»è·ƒäº‹åŠ¡ï¼‰ï¼Œä¸¤è€…ç›¸å…³ä½†ç”¨é€”ä¸åŒ

**æœ€ä½³å®è·µ**:

1. **ç†è§£xipæœºåˆ¶**: ç†è§£xipå¦‚ä½•é˜²æ­¢è„è¯»å’Œå®ç°å¯è§æ€§åˆ¤æ–­
2. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´xipæ•°ç»„è¿‡å¤§
3. **ç›‘æ§æ´»è·ƒäº‹åŠ¡**: ç›‘æ§æ´»è·ƒäº‹åŠ¡æ•°ï¼Œé¿å…è¿‡å¤šæ´»è·ƒäº‹åŠ¡
4. **ä¼˜åŒ–xipæŸ¥æ‰¾**: ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½

---

#### 1.3.6 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**å¿«ç…§åˆ›å»ºæ€§èƒ½**:

$$T_{snapshot} = T_{xmin} + T_{xmax} + T_{xip} + T_{sort}$$

å…¶ä¸­ï¼š

- $T_{xmin} = O(1)$ - è·å–å…¨å±€xminæ—¶é—´
- $T_{xmax} = O(1)$ - è·å–nextXidæ—¶é—´
- $T_{xip} = O(N_{active})$ - æ‰«ææ´»è·ƒäº‹åŠ¡æ—¶é—´
- $T_{sort} = O(N_{active} \log N_{active})$ - æ’åºæ—¶é—´

**å¿«ç…§æŸ¥æ‰¾æ€§èƒ½**:

$$T_{lookup} = O(\log N_{active})$$

äºŒåˆ†æŸ¥æ‰¾xipåˆ—è¡¨çš„æ—¶é—´å¤æ‚åº¦ã€‚

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| æ´»è·ƒäº‹åŠ¡æ•° | å¿«ç…§åˆ›å»ºæ—¶é—´ | xipæŸ¥æ‰¾æ—¶é—´ | è¯´æ˜ |
|-----------|------------|-----------|------|
| 10 | 0.5Î¼s | 0.1Î¼s | ä½å¹¶å‘ï¼Œå¼€é”€å° |
| 100 | 2Î¼s | 0.3Î¼s | ä¸­ç­‰å¹¶å‘ï¼Œå¼€é”€å¯æ¥å— |
| 1000 | 10Î¼s | 0.5Î¼s | é«˜å¹¶å‘ï¼Œå¼€é”€å¢åŠ  |

**å¿«ç…§ç¼“å­˜ä¼˜åŒ–**:

PostgreSQLä½¿ç”¨å¿«ç…§ç¼“å­˜å‡å°‘åˆ›å»ºå¼€é”€ï¼š

```c
// å¿«ç…§ç¼“å­˜æœºåˆ¶
static Snapshot cached_snapshot = NULL;
static TransactionId cached_xid = 0;

Snapshot GetCachedSnapshot(void)
{
    TransactionId current_xid = GetCurrentTransactionId();

    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
    if (cached_snapshot != NULL && cached_xid == current_xid) {
        return cached_snapshot;  // è¿”å›ç¼“å­˜çš„å¿«ç…§
    }

    // åˆ›å»ºæ–°å¿«ç…§
    cached_snapshot = GetSnapshotData(&CurrentSnapshotData);
    cached_xid = current_xid;

    return cached_snapshot;
}
```

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘æ´»è·ƒäº‹åŠ¡æ•°**:
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´
   - é¿å…é•¿äº‹åŠ¡
   - ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥

2. **ä½¿ç”¨å¿«ç…§ç¼“å­˜**:
   - PostgreSQLè‡ªåŠ¨ä½¿ç”¨å¿«ç…§ç¼“å­˜
   - åŒä¸€äº‹åŠ¡å†…å¤ç”¨å¿«ç…§

3. **ä¼˜åŒ–xipæŸ¥æ‰¾**:
   - ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼ˆå·²å®ç°ï¼‰
   - ä½¿ç”¨Hint Bitså‡å°‘æŸ¥æ‰¾æ¬¡æ•°

---

#### 1.3.7 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: å¿«ç…§æ˜¯MVCCçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå®šä¹‰äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬
2. **ç»„æˆ**: å¿«ç…§ç”±xminã€xmaxã€xipä¸‰ä¸ªç»„ä»¶ç»„æˆ
3. **ç­–ç•¥**: ä¸åŒéš”ç¦»çº§åˆ«ä½¿ç”¨ä¸åŒçš„å¿«ç…§ç­–ç•¥ï¼ˆè¯­å¥çº§æˆ–äº‹åŠ¡çº§ï¼‰
4. **æ€§èƒ½**: å¿«ç…§åˆ›å»ºå¼€é”€å¯æ¥å—ï¼ŒæŸ¥æ‰¾æ•ˆç‡é«˜

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºå¿«ç…§å°±æ˜¯æ—¶é—´æˆ³
   - **é”™è¯¯**: å¿«ç…§ä½¿ç”¨äº‹åŠ¡IDè€Œéç‰©ç†æ—¶é—´æˆ³
   - **æ­£ç¡®**: å¿«ç…§æ˜¯é€»è¾‘æ—¶é—´ç‚¹ï¼ŒåŸºäºäº‹åŠ¡ID

2. **è¯¯åŒº2**: è®¤ä¸ºå¿«ç…§åˆ›å»ºå¼€é”€å¾ˆå¤§
   - **é”™è¯¯**: å¿«ç…§åˆ›å»ºå¼€é”€é€šå¸¸åªæœ‰1-5Î¼s
   - **æ­£ç¡®**: å¿«ç…§åˆ›å»ºå¼€é”€å¯æ¥å—ï¼Œä¸æ˜¯æ€§èƒ½ç“¶é¢ˆ

3. **è¯¯åŒº3**: ä¸ç†è§£å¿«ç…§ç­–ç•¥çš„å·®å¼‚
   - **é”™è¯¯**: ä¸ç†è§£è¯­å¥çº§å¿«ç…§å’Œäº‹åŠ¡çº§å¿«ç…§çš„åŒºåˆ«
   - **æ­£ç¡®**: è¯­å¥çº§å¿«ç…§ç”¨äºRead Committedï¼Œäº‹åŠ¡çº§å¿«ç…§ç”¨äºRepeatable Read

**æœ€ä½³å®è·µ**:

1. **ç†è§£å¿«ç…§ç­–ç•¥**: ç†è§£ä¸åŒéš”ç¦»çº§åˆ«çš„å¿«ç…§ç­–ç•¥
2. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´å¿«ç…§ç»´æŠ¤å¼€é”€
3. **ç›‘æ§æ´»è·ƒäº‹åŠ¡**: ç›‘æ§æ´»è·ƒäº‹åŠ¡æ•°ï¼Œé¿å…è¿‡å¤šæ´»è·ƒäº‹åŠ¡
4. **ä½¿ç”¨å¿«ç…§ç¼“å­˜**: åˆ©ç”¨PostgreSQLçš„å¿«ç…§ç¼“å­˜æœºåˆ¶

---

## 1.4 xmin/xmax å®Œæ•´å®šä¹‰ä¸åˆ†æ

### 1.4.0 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> In PostgreSQL's MVCC implementation, `xmin` and `xmax` are transaction ID fields stored in the tuple header. `xmin` (transaction ID minimum) records the transaction ID that created the tuple version, while `xmax` (transaction ID maximum) records the transaction ID that deleted or updated the tuple. These fields are essential for visibility determination in MVCC systems.

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> Each row version in a table has an `xmin` and `xmax` field. The `xmin` field stores the transaction ID of the transaction that inserted the row version. The `xmax` field stores the transaction ID of the transaction that deleted the row version (or 0 if the row version has not been deleted). These fields are used by the visibility rules to determine which row versions are visible to a transaction.

**Gray & Reuter (1993) å®šä¹‰**:

> In multi-version concurrency control, each version of a data item is tagged with the transaction ID that created it (xmin) and the transaction ID that deleted it (xmax). These transaction IDs form the basis for visibility determination, allowing the system to determine which versions are visible to a given transaction based on its snapshot.

**Berenson et al. (1995) å½¢å¼åŒ–å®šä¹‰**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬ $\tau$ï¼Œxminå’Œxmaxå®šä¹‰ä¸ºï¼š

$$
\tau.\text{xmin} = \text{TransactionID}(\text{CreateTransaction}(\tau))
$$

$$
\tau.\text{xmax} = \begin{cases}
\text{TransactionID}(\text{DeleteTransaction}(\tau)) & \text{if } \tau \text{ is deleted} \\
0 & \text{otherwise}
\end{cases}
$$

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLåœ¨`HeapTupleHeader`ç»“æ„ä¸­å­˜å‚¨xminå’Œxmaxï¼š

```c
// src/include/access/htup_details.h
typedef struct HeapTupleFields
{
    TransactionId t_xmin;    /* åˆ›å»ºäº‹åŠ¡ID */
    TransactionId t_xmax;    /* åˆ é™¤/æ›´æ–°äº‹åŠ¡ID */
    union
    {
        CommandId t_cid;     /* å‘½ä»¤ID */
        TransactionId t_xvac; /* VACUUMæ“ä½œçš„äº‹åŠ¡ID */
    } t_field3;
} HeapTupleFields;
```

**æœ¬ä½“ç³»å®šä¹‰**:

xminå’Œxmaxæ˜¯PostgreSQL MVCCä¸­å…ƒç»„å¤´éƒ¨çš„ä¸¤ä¸ªæ ¸å¿ƒäº‹åŠ¡IDå­—æ®µã€‚xminè®°å½•åˆ›å»ºè¯¥å…ƒç»„ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼Œxmaxè®°å½•åˆ é™¤æˆ–æ›´æ–°è¯¥å…ƒç»„ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼ˆå¦‚æœæœªè¢«åˆ é™¤åˆ™ä¸º0ï¼‰ã€‚è¿™ä¸¤ä¸ªå­—æ®µæ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€ï¼Œé€šè¿‡æ¯”è¾ƒå…ƒç»„çš„xmin/xmaxä¸äº‹åŠ¡å¿«ç…§çš„xmin/xmax/xipï¼Œç³»ç»Ÿå¯ä»¥ç¡®å®šè¯¥å…ƒç»„ç‰ˆæœ¬æ˜¯å¦å¯¹å½“å‰äº‹åŠ¡å¯è§ã€‚

**xmin/xmaxä¸MVCCçš„å…³ç³»**:

```text
xmin/xmaxä¸MVCC:
â”‚
â”œâ”€ xmin/xmax (äº‹åŠ¡IDå­—æ®µ) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: å…ƒç»„å¤´éƒ¨çš„äº‹åŠ¡IDå­—æ®µ
â”‚       â”œâ”€ xmin: åˆ›å»ºäº‹åŠ¡ID
â”‚       â””â”€ xmax: åˆ é™¤äº‹åŠ¡ID
â”‚           â””â”€ ä½œç”¨: å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
â”‚
â””â”€ MVCC (Multi-Version Concurrency Control)
    â””â”€ å®ç°: é€šè¿‡xmin/xmaxå®ç°å¯è§æ€§åˆ¤æ–­
        â””â”€ æœºåˆ¶: æ¯”è¾ƒå…ƒç»„çš„xmin/xmaxä¸å¿«ç…§çš„xmin/xmax/xip
```

---

### 1.4.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰1.4.1 (xmin - PostgreSQLå®ç°)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬ $\tau$ï¼Œxminå®šä¹‰ä¸ºï¼š

$$\tau.\text{xmin} = \text{TransactionID}(T_i) \quad \text{where } T_i \text{ created } \tau$$

å³ï¼šxminæ˜¯åˆ›å»ºè¯¥å…ƒç»„ç‰ˆæœ¬çš„äº‹åŠ¡IDã€‚

**å®šä¹‰1.4.2 (xmax - PostgreSQLå®ç°)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬ $\tau$ï¼Œxmaxå®šä¹‰ä¸ºï¼š

$$
\tau.\text{xmax} = \begin{cases}
\text{TransactionID}(T_j) & \text{if } T_j \text{ deleted/updated } \tau \\
0 & \text{if } \tau \text{ is not deleted}
\end{cases}
$$

å³ï¼šxmaxæ˜¯åˆ é™¤æˆ–æ›´æ–°è¯¥å…ƒç»„ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼Œå¦‚æœå…ƒç»„æœªè¢«åˆ é™¤åˆ™ä¸º0ã€‚

**å®šä¹‰1.4.3 (xmin/xmaxä¸å˜å¼)**:

ç‰ˆæœ¬é“¾ä¸­çš„xmin/xmaxå¿…é¡»æ»¡è¶³ä¸å˜å¼ï¼š

$$
\forall \tau_i, \tau_{i+1} \in \text{Chain}(r, k): \tau_i.\text{xmax} = \tau_{i+1}.\text{xmin} \land \tau_i.\text{xmax} \neq 0
$$

å³ï¼šæ—§ç‰ˆæœ¬çš„xmaxå¿…é¡»ç­‰äºæ–°ç‰ˆæœ¬çš„xminï¼Œä¸”æ—§ç‰ˆæœ¬å¿…é¡»è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ï¼ˆxmax â‰  0ï¼‰ã€‚

**å®šä¹‰1.4.4 (xmin/xmaxä¸å¯è§æ€§çš„å…³ç³»)**:

å…ƒç»„ç‰ˆæœ¬ $\tau$ å¯¹å¿«ç…§ $snap$ å¯è§å½“ä¸”ä»…å½“ï¼š

$$\text{Visible}(\tau, snap) \iff$$

$$(\tau.\text{xmin} < snap.\text{xmax} \land \tau.\text{xmin} \notin snap.\text{xip}) \land$$

$$(\tau.\text{xmax} = 0 \lor \tau.\text{xmax} \geq snap.\text{xmax} \lor \tau.\text{xmax} \in snap.\text{xip})$$

å³ï¼šåˆ›å»ºäº‹åŠ¡å¿…é¡»åœ¨å¿«ç…§å‰ä¸”ä¸åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œä¸”åˆ é™¤äº‹åŠ¡å¿…é¡»æœªæäº¤æˆ–åœ¨å¿«ç…§åã€‚

---

### 1.4.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: äº‹åŠ¡IDæ¦‚å¿µæå‡º
   - é¦–æ¬¡ä½¿ç”¨äº‹åŠ¡IDæ ‡è¯†äº‹åŠ¡
   - åŸºäºæ—¶é—´æˆ³çš„äº‹åŠ¡æ’åº
   - ç®€å•çš„å¯è§æ€§åˆ¤æ–­è§„åˆ™

2. **1980å¹´ä»£**: MVCCä¸­çš„äº‹åŠ¡IDåº”ç”¨
   - ä½¿ç”¨äº‹åŠ¡IDæ ‡è®°ç‰ˆæœ¬åˆ›å»ºå’Œåˆ é™¤
   - xmin/xmaxå­—æ®µå¼•å…¥
   - åŸºäºäº‹åŠ¡IDçš„å¯è§æ€§åˆ¤æ–­

3. **1990å¹´ä»£**: PostgreSQLå®ç°xmin/xmax
   - åœ¨å…ƒç»„å¤´éƒ¨å­˜å‚¨xmin/xmax
   - ä¼˜åŒ–äº‹åŠ¡IDåˆ†é…
   - å¼•å…¥Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­

4. **2000å¹´ä»£è‡³ä»Š**: xmin/xmaxæœºåˆ¶æˆç†Ÿ
   - 32ä½äº‹åŠ¡IDå›å·é—®é¢˜è§£å†³ï¼ˆFreezeæœºåˆ¶ï¼‰
   - 64ä½äº‹åŠ¡IDæ”¯æŒï¼ˆéƒ¨åˆ†ç³»ç»Ÿï¼‰
   - æ€§èƒ½ä¼˜åŒ–ï¼ˆHint Bitsã€Visibility Mapï¼‰

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦xmin/xmaxï¼Ÿ**

1. **ç‰ˆæœ¬æ ‡è¯†çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦æ ‡è¯†æ¯ä¸ªç‰ˆæœ¬çš„åˆ›å»ºè€…å’Œåˆ é™¤è€…
   - **è§£å†³**: xminæ ‡è¯†åˆ›å»ºè€…ï¼Œxmaxæ ‡è¯†åˆ é™¤è€…
   - **æ•ˆæœ**: æ”¯æŒå¤šç‰ˆæœ¬å­˜å‚¨å’Œå¯è§æ€§åˆ¤æ–­

2. **å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€**:
   - **é—®é¢˜**: éœ€è¦åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯¹äº‹åŠ¡å¯è§
   - **è§£å†³**: é€šè¿‡æ¯”è¾ƒxmin/xmaxä¸å¿«ç…§çš„xmin/xmax/xip
   - **æ•ˆæœ**: å®ç°å¿«ç…§éš”ç¦»å’ŒMVCC

3. **ç‰ˆæœ¬é“¾ç®¡ç†**:
   - **é—®é¢˜**: éœ€è¦ç®¡ç†ç‰ˆæœ¬é“¾çš„å®Œæ•´æ€§
   - **è§£å†³**: xmin/xmaxä¿è¯ç‰ˆæœ¬é“¾ä¸å˜å¼
   - **æ•ˆæœ**: ç‰ˆæœ¬é“¾éå†å’Œæ¸…ç†

**ç†è®ºä½ç½®**:

```text
MVCCç†è®ºä½“ç³»:
â”‚
â”œâ”€ MVCCç†è®º
â”‚   â””â”€ æ ¸å¿ƒ: å¤šç‰ˆæœ¬å­˜å‚¨
â”‚
â”œâ”€ xmin/xmaxç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: äº‹åŠ¡IDå­—æ®µ
â”‚       â”œâ”€ xmin: åˆ›å»ºäº‹åŠ¡ID
â”‚       â”œâ”€ xmax: åˆ é™¤äº‹åŠ¡ID
â”‚       â””â”€ ä½œç”¨: å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
â”‚
â””â”€ å¯è§æ€§ç†è®º
    â””â”€ å®ç°: åŸºäºxmin/xmaxåˆ¤æ–­å¯è§æ€§
```

**xmin/xmaxä¸MVCCçš„å…³ç³»**:

```text
xmin/xmaxä¸MVCC:
â”‚
â”œâ”€ xmin/xmaxæ˜¯æ•°æ®
â”‚   â””â”€ å­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨
â”‚
â””â”€ MVCCæ˜¯æœºåˆ¶
    â””â”€ ä½¿ç”¨xmin/xmaxå®ç°å¯è§æ€§åˆ¤æ–­
```

**ç†è®ºæ¨å¯¼**:

```text
ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°xmin/xmaxå®ç°çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: ç‰ˆæœ¬æ ‡è¯†ï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: å¯è§æ€§åˆ¤æ–­ï¼ˆå¿…é¡»ï¼‰

2. xmin/xmaxè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨äº‹åŠ¡IDæ ‡è¯†ç‰ˆæœ¬
   â”œâ”€ æœºåˆ¶: xminæ ‡è¯†åˆ›å»ºè€…ï¼Œxmaxæ ‡è¯†åˆ é™¤è€…
   â””â”€ åˆ¤æ–­: åŸºäºxmin/xmaxä¸å¿«ç…§æ¯”è¾ƒ

3. å®ç°é€‰æ‹©
   â”œâ”€ å­˜å‚¨: å…ƒç»„å¤´éƒ¨å­˜å‚¨xmin/xmax
   â”œâ”€ åˆ†é…: äº‹åŠ¡å¼€å§‹æ—¶åˆ†é…äº‹åŠ¡ID
   â””â”€ åˆ¤æ–­: å¯è§æ€§è§„åˆ™åŸºäºxmin/xmax

4. ç»“è®º
   â””â”€ xmin/xmaxæ˜¯å®ç°MVCCçš„åŸºç¡€å­—æ®µ
```

---

### 1.4.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: xmin/xmaxæ”¯æŒå¯è§æ€§åˆ¤æ–­**

```sql
-- åœºæ™¯: å¤šä¸ªäº‹åŠ¡å¹¶å‘è®¿é—®åŒä¸€è¡Œ
-- éœ€æ±‚: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ­£ç¡®çš„ç‰ˆæœ¬

-- åˆå§‹çŠ¶æ€
INSERT INTO accounts (id, balance) VALUES (1, 1000);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0, balance=1000

-- äº‹åŠ¡T1 (å¿«ç…§: xmin=100, xmax=200, xip=[])
BEGIN;
SELECT balance FROM accounts WHERE id = 1;
-- å¯è§æ€§åˆ¤æ–­:
--   v1.xmin(100) < snap.xmax(200) âœ“
--   v1.xmin(100) âˆ‰ snap.xip([]) âœ“
--   v1.xmax(0) = 0 âœ“
-- è¿”å›: balance=1000 âœ“

-- äº‹åŠ¡T2 (ä¿®æ”¹å¹¶æäº¤)
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- åˆ›å»ºv2: xmin=105, xmax=0, balance=1500
-- æ›´æ–°v1: xmax=105, ctidâ†’v2
COMMIT;

-- äº‹åŠ¡T1 (ç»§ç»­è¯»å–)
SELECT balance FROM accounts WHERE id = 1;
-- å¯è§æ€§åˆ¤æ–­:
--   v2.xmin(105) < snap.xmax(200) âœ“
--   v2.xmin(105) âˆ‰ snap.xip([]) âœ“
--   ä½†: v2.xmin(105) >= snap.xmax(200)? âœ—
--   å®é™…ä¸Š: 105 < 200 âœ“
--   ç»§ç»­: v1.xmin(100) < snap.xmax(200) âœ“
--   è¿”å›: balance=1000 (åŸºäºå¿«ç…§) âœ“

COMMIT;
```

**åˆ†æ**:

- âœ… xmin/xmaxä¿è¯ï¼šæ­£ç¡®æ ‡è¯†ç‰ˆæœ¬çš„åˆ›å»ºè€…å’Œåˆ é™¤è€…
- âœ… å¯è§æ€§åˆ¤æ–­ï¼šåŸºäºxmin/xmaxä¸å¿«ç…§æ¯”è¾ƒ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

---

**æ­£ä¾‹2: xmin/xmaxæ”¯æŒç‰ˆæœ¬é“¾ç®¡ç†**

```sql
-- åœºæ™¯: å¤šä¸ªäº‹åŠ¡è¿ç»­æ›´æ–°åŒä¸€è¡Œ
-- éœ€æ±‚: ç‰ˆæœ¬é“¾å®Œæ•´æ€§

-- åˆå§‹çŠ¶æ€
INSERT INTO products (id, stock) VALUES (1, 100);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0, stock=100

-- äº‹åŠ¡T2 (æ›´æ–°)
BEGIN;
UPDATE products SET stock = 80 WHERE id = 1;
-- åˆ›å»ºv2: xmin=105, xmax=0, stock=80
-- æ›´æ–°v1: xmax=105, ctidâ†’v2
-- ç‰ˆæœ¬é“¾: v1 â†’ v2
COMMIT;

-- äº‹åŠ¡T3 (æ›´æ–°)
BEGIN;
UPDATE products SET stock = 60 WHERE id = 1;
-- åˆ›å»ºv3: xmin=110, xmax=0, stock=60
-- æ›´æ–°v2: xmax=110, ctidâ†’v3
-- ç‰ˆæœ¬é“¾: v1 â†’ v2 â†’ v3

-- ç‰ˆæœ¬é“¾å®Œæ•´æ€§æ£€æŸ¥:
--   v1.xmax(105) = v2.xmin(105) âœ“
--   v2.xmax(110) = v3.xmin(110) âœ“
-- ç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¿è¯ âœ“
COMMIT;
```

**åˆ†æ**:

- âœ… xmin/xmaxä¿è¯ï¼šç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¸å˜å¼
- âœ… ç‰ˆæœ¬é“¾ç®¡ç†ï¼šé€šè¿‡xmin/xmaxé“¾æ¥ç‰ˆæœ¬
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šç‰ˆæœ¬é“¾éå†æ­£ç¡®

---

**åä¾‹åˆ†æ**:

**åä¾‹1: xmin/xmaxè®¾ç½®é”™è¯¯å¯¼è‡´å¯è§æ€§åˆ¤æ–­é”™è¯¯**

```sql
-- é”™è¯¯åœºæ™¯: xmin/xmaxè®¾ç½®é”™è¯¯
-- é—®é¢˜: å¯è§æ€§åˆ¤æ–­é”™è¯¯

-- é”™è¯¯å®ç°ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- ç‰ˆæœ¬v1: xmin=100, xmax=0
-- äº‹åŠ¡T2åˆ é™¤v1ï¼Œä½†é”™è¯¯è®¾ç½®xmax=0ï¼ˆåº”è¯¥è®¾ç½®ä¸º105ï¼‰

-- äº‹åŠ¡T1 (å¿«ç…§: xmin=100, xmax=200)
BEGIN;
SELECT * FROM accounts WHERE id = 1;
-- å¯è§æ€§åˆ¤æ–­:
--   v1.xmin(100) < snap.xmax(200) âœ“
--   v1.xmax(0) = 0 â†’ æœªåˆ é™¤ âœ“
-- è¿”å›: v1 (é”™è¯¯ï¼šåº”è¯¥ä¸å¯è§) âœ—
```

**é”™è¯¯åŸå› **:

- xmaxè®¾ç½®é”™è¯¯ï¼Œæœªæ ‡è®°ä¸ºå·²åˆ é™¤
- å¯è§æ€§åˆ¤æ–­åŸºäºé”™è¯¯çš„xmaxå€¼
- å¯¼è‡´å·²åˆ é™¤çš„ç‰ˆæœ¬ä»ç„¶å¯è§

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®å®ç°
-- äº‹åŠ¡T2åˆ é™¤v1
UPDATE accounts SET ... WHERE id = 1;
-- æ­£ç¡®è®¾ç½®: v1.xmax=105 âœ“
-- å¯è§æ€§åˆ¤æ–­:
--   v1.xmax(105) != 0 â†’ å·²åˆ é™¤
--   v1.xmax(105) < snap.xmax(200) â†’ åˆ é™¤äº‹åŠ¡å·²æäº¤
-- è¿”å›: ä¸å¯è§ âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: å·²åˆ é™¤çš„ç‰ˆæœ¬ä»ç„¶å¯è§
- **ä¸€è‡´æ€§ç ´å**: è¿åMVCCçš„å¯è§æ€§è§„åˆ™
- **ç³»ç»Ÿé”™è¯¯**: å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

---

**åä¾‹2: ç‰ˆæœ¬é“¾xmin/xmaxä¸ä¸€è‡´å¯¼è‡´éå†é”™è¯¯**

```sql
-- é”™è¯¯åœºæ™¯: ç‰ˆæœ¬é“¾xmin/xmaxä¸ä¸€è‡´
-- é—®é¢˜: ç‰ˆæœ¬é“¾éå†é”™è¯¯

-- é”™è¯¯å®ç°ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=110, xmax=0  -- é”™è¯¯ï¼šåº”è¯¥æ˜¯xmin=105

-- ç‰ˆæœ¬é“¾å®Œæ•´æ€§æ£€æŸ¥:
--   v1.xmax(105) != v2.xmin(110) âœ—
-- ç‰ˆæœ¬é“¾æ–­è£‚ âœ—

-- ç‰ˆæœ¬é“¾éå†:
--   ä»v1å¼€å§‹ï¼Œxmax=105
--   æŸ¥æ‰¾xmin=105çš„ç‰ˆæœ¬ â†’ ä¸å­˜åœ¨ âœ—
--   ç‰ˆæœ¬é“¾éå†å¤±è´¥ âœ—
```

**é”™è¯¯åŸå› **:

- ç‰ˆæœ¬é“¾xmin/xmaxä¸ä¸€è‡´
- è¿åç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¸å˜å¼
- ç‰ˆæœ¬é“¾éå†å¤±è´¥

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®å®ç°
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=105, xmax=0  -- æ­£ç¡®ï¼šxmin=105 âœ“

-- ç‰ˆæœ¬é“¾å®Œæ•´æ€§æ£€æŸ¥:
--   v1.xmax(105) = v2.xmin(105) âœ“
-- ç‰ˆæœ¬é“¾å®Œæ•´ âœ“

-- ç‰ˆæœ¬é“¾éå†:
--   ä»v1å¼€å§‹ï¼Œxmax=105
--   æŸ¥æ‰¾xmin=105çš„ç‰ˆæœ¬ â†’ v2 âœ“
--   ç‰ˆæœ¬é“¾éå†æˆåŠŸ âœ“
```

**åæœåˆ†æ**:

- **ç‰ˆæœ¬é“¾æ–­è£‚**: æ— æ³•éå†å®Œæ•´çš„ç‰ˆæœ¬é“¾
- **æ•°æ®ä¸¢å¤±**: æŸäº›ç‰ˆæœ¬æ— æ³•è®¿é—®
- **ç³»ç»Ÿé”™è¯¯**: ç‰ˆæœ¬é“¾ç®¡ç†å¤±æ•ˆ

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘ç³»ç»Ÿä½¿ç”¨xmin/xmax**

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘ç³»ç»Ÿï¼ˆ1000+ TPSï¼‰
- éœ€è¦å¿«é€Ÿå¯è§æ€§åˆ¤æ–­
- xmin/xmaxå­—æ®µæ˜¯å…³é”®

**ä¸ºä»€ä¹ˆéœ€è¦xmin/xmax**:

- âœ… å¯è§æ€§åˆ¤æ–­ï¼šå¿«é€Ÿåˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯è§
- âœ… ç‰ˆæœ¬æ ‡è¯†ï¼šæ ‡è¯†ç‰ˆæœ¬çš„åˆ›å»ºè€…å’Œåˆ é™¤è€…
- âœ… æ€§èƒ½ï¼šxmin/xmaxæ¯”è¾ƒå¼€é”€å°

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLè‡ªåŠ¨ä½¿ç”¨xmin/xmax
BEGIN;
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: åŸºäºxmin/xmaxåˆ¤æ–­å¯è§æ€§ âœ“
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **å¯è§æ€§åˆ¤æ–­**: åŸºäºxmin/xmaxï¼Œæ€§èƒ½é«˜ âœ“
- **ç‰ˆæœ¬æ ‡è¯†**: xmin/xmaxæ­£ç¡®æ ‡è¯†ç‰ˆæœ¬ âœ“
- **ç³»ç»Ÿæ€§èƒ½**: xmin/xmaxæ¯”è¾ƒå¼€é”€å° âœ“

---

**åœºæ™¯2: ç‰ˆæœ¬é“¾ç®¡ç†ä½¿ç”¨xmin/xmax**

**åœºæ™¯æè¿°**:

- é«˜é¢‘æ›´æ–°ç³»ç»Ÿ
- ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿
- éœ€è¦ä¿è¯ç‰ˆæœ¬é“¾å®Œæ•´æ€§

**ä¸ºä»€ä¹ˆéœ€è¦xmin/xmax**:

- âœ… ç‰ˆæœ¬é“¾å®Œæ•´æ€§ï¼šxmin/xmaxä¿è¯ç‰ˆæœ¬é“¾ä¸å˜å¼
- âœ… ç‰ˆæœ¬é“¾æ¥ï¼šé€šè¿‡xmin/xmaxé“¾æ¥ç‰ˆæœ¬
- âœ… ç‰ˆæœ¬æ¸…ç†ï¼šåŸºäºxmin/xmaxè¯†åˆ«æ­»å…ƒç»„

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- æ›´æ–°æ“ä½œè‡ªåŠ¨ç»´æŠ¤xmin/xmax
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- å†…éƒ¨:
--   åˆ›å»ºv2: xmin=å½“å‰xid, xmax=0
--   æ›´æ–°v1: xmax=å½“å‰xid, ctidâ†’v2
--   ä¿è¯: v1.xmax = v2.xmin âœ“
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ç‰ˆæœ¬é“¾å®Œæ•´æ€§**: xmin/xmaxä¿è¯ä¸å˜å¼ âœ“
- **ç‰ˆæœ¬é“¾æ¥**: é€šè¿‡xmin/xmaxæ­£ç¡®é“¾æ¥ âœ“
- **ç‰ˆæœ¬æ¸…ç†**: åŸºäºxmin/xmaxè¯†åˆ«æ­»å…ƒç»„ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°xmin/xmaxå®ç°çš„æ¨ç†**

```text
å‰æ1: MVCCéœ€è¦å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
å‰æ2: éœ€è¦æ ‡è¯†æ¯ä¸ªç‰ˆæœ¬çš„åˆ›å»ºè€…å’Œåˆ é™¤è€…ï¼ˆå¿…é¡»ï¼‰
å‰æ3: éœ€è¦å¿«é€Ÿå¯è§æ€§åˆ¤æ–­ï¼ˆé‡è¦ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©ç‰ˆæœ¬æ ‡è¯†æ–¹æ³•
æ¨ç†æ­¥éª¤2: äº‹åŠ¡IDæ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæ»¡è¶³å‰æ2ï¼‰
æ¨ç†æ­¥éª¤3: xmin/xmaxå­˜å‚¨äº‹åŠ¡IDï¼Œæ”¯æŒå¿«é€Ÿæ¯”è¾ƒï¼ˆæ»¡è¶³å‰æ3ï¼‰

ç»“è®º: ä½¿ç”¨xmin/xmaxæ ‡è¯†ç‰ˆæœ¬ âœ“
```

**æ¨ç†é“¾æ¡2: ä»xmin/xmaxåˆ°å¯è§æ€§åˆ¤æ–­çš„æ¨ç†**

```text
å‰æ1: å…ƒç»„ç‰ˆæœ¬æœ‰xminï¼ˆåˆ›å»ºäº‹åŠ¡IDï¼‰å’Œxmaxï¼ˆåˆ é™¤äº‹åŠ¡IDï¼‰
å‰æ2: äº‹åŠ¡å¿«ç…§æœ‰xminï¼ˆæœ€æ—©æ´»è·ƒäº‹åŠ¡IDï¼‰ã€xmaxï¼ˆä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼‰ã€xipï¼ˆæ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼‰
å‰æ3: éœ€è¦åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯¹äº‹åŠ¡å¯è§

æ¨ç†æ­¥éª¤1: å¦‚æœåˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§å‰ä¸”ä¸åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œç‰ˆæœ¬å¯èƒ½å¯è§
æ¨ç†æ­¥éª¤2: å¦‚æœåˆ é™¤äº‹åŠ¡æœªæäº¤æˆ–åœ¨å¿«ç…§åï¼Œç‰ˆæœ¬å¯èƒ½å¯è§
æ¨ç†æ­¥éª¤3: ç»¼åˆxmin/xmaxä¸å¿«ç…§æ¯”è¾ƒï¼Œåˆ¤æ–­å¯è§æ€§

ç»“è®º: xmin/xmaxæ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€ âœ“
```

---

### 1.4.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - å¯è§æ€§åˆ¤æ–­åŸºäºxmin/xmaxä¸å¿«ç…§æ¯”è¾ƒ
   - xmin/xmaxæ˜¯å¯è§æ€§åˆ¤æ–­çš„è¾“å…¥
   - å¯è§æ€§è§„åˆ™ä½¿ç”¨xmin/xmaxå­—æ®µ

2. **ä¸å¿«ç…§çš„å…³ç³»**:
   - å¿«ç…§çš„xmin/xmax/xipç”¨äºä¸å…ƒç»„çš„xmin/xmaxæ¯”è¾ƒ
   - å…ƒç»„çš„xmin/xmaxå®šä¹‰ç‰ˆæœ¬çš„åˆ›å»ºå’Œåˆ é™¤æ—¶é—´
   - å¿«ç…§å’Œxmin/xmaxå…±åŒå†³å®šå¯è§æ€§

3. **ä¸ç‰ˆæœ¬é“¾çš„å…³ç³»**:
   - ç‰ˆæœ¬é“¾é€šè¿‡xmin/xmaxé“¾æ¥ç‰ˆæœ¬
   - ç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¸å˜å¼åŸºäºxmin/xmax
   - xmin/xmaxä¿è¯ç‰ˆæœ¬é“¾çš„æ­£ç¡®æ€§

4. **ä¸VACUUMçš„å…³ç³»**:
   - VACUUMåŸºäºxmin/xmaxè¯†åˆ«æ­»å…ƒç»„
   - æ­»å…ƒç»„åˆ¤æ–­ï¼šxmax < OldestXmin ä¸” xmaxå·²æäº¤
   - xmin/xmaxå½±å“VACUUMçš„æ¸…ç†ç­–ç•¥

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL xmin/xmaxå®ç°
   - å…ƒç»„å¤´éƒ¨å­˜å‚¨xmin/xmax
   - äº‹åŠ¡IDåˆ†é…å’Œç®¡ç†
   - å¯è§æ€§åˆ¤æ–­ç®—æ³•

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - xmin/xmax â‰ˆ ç‰ˆæœ¬å·ï¼ˆVersion Numberï¼‰
   - äº‹åŠ¡ID â‰ˆ æ—¶é—´æˆ³ï¼ˆTimestampï¼‰
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ ç‰ˆæœ¬æ¯”è¾ƒ

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - xmin/xmax â‰ˆ å‘é‡æ—¶é’Ÿï¼ˆVector Clockï¼‰
   - äº‹åŠ¡ID â‰ˆ å…¨å±€æ—¶é’Ÿï¼ˆGlobal Clockï¼‰
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ å› æœä¸€è‡´æ€§ï¼ˆCausal Consistencyï¼‰

**å®ç°ç»†èŠ‚**:

**PostgreSQL xmin/xmaxå®ç°æ¶æ„**:

```c
// src/include/access/htup_details.h

// è·å–xmin
# define HeapTupleHeaderGetXmin(tup) \
    ((tup)->t_choice.t_heap.t_xmin)

// è·å–xmax
# define HeapTupleHeaderGetXmax(tup) \
    ((tup)->t_choice.t_heap.t_xmax)

// è®¾ç½®xmin
# define HeapTupleHeaderSetXmin(tup, xid) \
    ((tup)->t_choice.t_heap.t_xmin = (xid))

// è®¾ç½®xmax
# define HeapTupleHeaderSetXmax(tup, xid) \
    ((tup)->t_choice.t_heap.t_xmax = (xid))
```

**xmin/xmaxä¿è¯æœºåˆ¶**:

```python
def ensure_xmin_xmax(tuple, transaction_id, operation):
    """
    ç¡®ä¿xmin/xmaxæ­£ç¡®è®¾ç½®

    æœºåˆ¶:
    1. INSERT: è®¾ç½®xmin=å½“å‰xid, xmax=0
    2. UPDATE: åˆ›å»ºæ–°ç‰ˆæœ¬xmin=å½“å‰xid, æ›´æ–°æ—§ç‰ˆæœ¬xmax=å½“å‰xid
    3. DELETE: è®¾ç½®xmax=å½“å‰xid
    """
    if operation == 'INSERT':
        tuple.xmin = transaction_id
        tuple.xmax = 0
    elif operation == 'UPDATE':
        # åˆ›å»ºæ–°ç‰ˆæœ¬
        new_tuple.xmin = transaction_id
        new_tuple.xmax = 0
        # æ›´æ–°æ—§ç‰ˆæœ¬
        tuple.xmax = transaction_id
    elif operation == 'DELETE':
        tuple.xmax = transaction_id
```

**æ€§èƒ½å½±å“**:

1. **xmin/xmaxå­˜å‚¨å¼€é”€**:
   - æ¯ä¸ªå…ƒç»„: 8å­—èŠ‚ï¼ˆxmin 4å­—èŠ‚ + xmax 4å­—èŠ‚ï¼‰
   - å…¸å‹å¼€é”€: å¯å¿½ç•¥ï¼ˆç›¸å¯¹äºå…ƒç»„å¤§å°ï¼‰
   - ç©ºé—´æ•ˆç‡: é«˜

2. **xmin/xmaxæ¯”è¾ƒå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - ç®€å•çš„æ•´æ•°æ¯”è¾ƒ
   - å…¸å‹å¼€é”€: < 0.1Î¼s
   - CPUå¼€é”€: æä½

3. **æ€»ä½“æ€§èƒ½**:
   - xmin/xmaxæ˜¯MVCCçš„åŸºç¡€ï¼Œå¼€é”€æå°
   - å¯è§æ€§åˆ¤æ–­ä¸»è¦å¼€é”€åœ¨å¿«ç…§åˆ›å»ºå’Œæ´»è·ƒäº‹åŠ¡åˆ—è¡¨æŸ¥æ‰¾
   - xmin/xmaxæœ¬èº«å¯¹æ€§èƒ½å½±å“å¯å¿½ç•¥

---

### 1.4.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**xmin/xmaxå­˜å‚¨å¼€é”€**:

$$S_{xmin\_xmax} = 8 \text{ bytes per tuple}$$

å…¶ä¸­ï¼š

- xmin: 4å­—èŠ‚ï¼ˆTransactionIdï¼‰
- xmax: 4å­—èŠ‚ï¼ˆTransactionIdï¼‰

**xmin/xmaxæ¯”è¾ƒå¼€é”€**:

$$T_{compare} = T_{read\_xmin} + T_{read\_xmax} + T_{compare\_ops}$$

å…¶ä¸­ï¼š

- $T_{read\_xmin} = O(1)$ - è¯»å–xminæ—¶é—´
- $T_{read\_xmax} = O(1)$ - è¯»å–xmaxæ—¶é—´
- $T_{compare\_ops} = O(1)$ - æ¯”è¾ƒæ“ä½œæ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| æ“ä½œ | æ—¶é—´ | è¯´æ˜ |
|-----|------|------|
| **è¯»å–xmin** | < 0.01Î¼s | å†…å­˜è¯»å– |
| **è¯»å–xmax** | < 0.01Î¼s | å†…å­˜è¯»å– |
| **æ¯”è¾ƒxmin/xmax** | < 0.1Î¼s | æ•´æ•°æ¯”è¾ƒ |
| **æ€»ä½“å¼€é”€** | < 0.2Î¼s | å¯å¿½ç•¥ |

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘xmin/xmaxè®¿é—®**:
   - ä½¿ç”¨Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
   - ä½¿ç”¨Visibility Mapè·³è¿‡ä¸å¯è§é¡µé¢
   - ä¼˜åŒ–ç‰ˆæœ¬é“¾éå†ç®—æ³•

2. **ä¼˜åŒ–xmin/xmaxå­˜å‚¨**:
   - ä½¿ç”¨å‹ç¼©å­˜å‚¨ï¼ˆå¦‚æœå¯èƒ½ï¼‰
   - ä¼˜åŒ–å…ƒç»„å¤´éƒ¨å¸ƒå±€
   - å‡å°‘å¯¹é½å¡«å……

3. **ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­**:
   - åŸºäºxmin/xmaxçš„å¿«é€Ÿè·¯å¾„
   - ä½¿ç”¨ä½å›¾ä¼˜åŒ–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨æŸ¥æ‰¾
   - ç¼“å­˜å¸¸è§çš„äº‹åŠ¡IDæ¯”è¾ƒç»“æœ

---

### 1.4.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: xminæ˜¯åˆ›å»ºäº‹åŠ¡IDï¼Œxmaxæ˜¯åˆ é™¤äº‹åŠ¡ID
2. **ä½œç”¨**: xmin/xmaxæ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€
3. **å­˜å‚¨**: å­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨ï¼Œæ¯ä¸ªå…ƒç»„8å­—èŠ‚
4. **æ€§èƒ½**: xmin/xmaxæ¯”è¾ƒå¼€é”€æå°ï¼Œå¯å¿½ç•¥

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºxmin/xmaxæ˜¯æ—¶é—´æˆ³
   - **é”™è¯¯**: xmin/xmaxæ˜¯äº‹åŠ¡IDï¼Œä¸æ˜¯æ—¶é—´æˆ³
   - **æ­£ç¡®**: äº‹åŠ¡IDæ˜¯é€’å¢çš„æ•´æ•°ï¼Œç”¨äºæ’åºå’Œæ¯”è¾ƒ

2. **è¯¯åŒº2**: è®¤ä¸ºxmax=0è¡¨ç¤ºæœªåˆ é™¤
   - **é”™è¯¯**: xmax=0ç¡®å®è¡¨ç¤ºæœªåˆ é™¤ï¼Œä½†è¿™æ˜¯PostgreSQLçš„å®ç°ç»†èŠ‚
   - **æ­£ç¡®**: xmax=0è¡¨ç¤ºå…ƒç»„æœªè¢«åˆ é™¤ï¼Œxmaxâ‰ 0è¡¨ç¤ºå…ƒç»„å·²è¢«åˆ é™¤æˆ–æ›´æ–°

3. **è¯¯åŒº3**: å¿½ç•¥ç‰ˆæœ¬é“¾xmin/xmaxä¸€è‡´æ€§
   - **é”™è¯¯**: è®¤ä¸ºç‰ˆæœ¬é“¾çš„xmin/xmaxå¯ä»¥ä¸ä¸€è‡´
   - **æ­£ç¡®**: ç‰ˆæœ¬é“¾å¿…é¡»æ»¡è¶³ $\tau_i.\text{xmax} = \tau_{i+1}.\text{xmin}$ ä¸å˜å¼

**æœ€ä½³å®è·µ**:

1. **ç†è§£xmin/xmax**: ç†è§£xmin/xmaxçš„å«ä¹‰å’Œä½œç”¨
2. **ä¿è¯ç‰ˆæœ¬é“¾å®Œæ•´æ€§**: ç¡®ä¿ç‰ˆæœ¬é“¾çš„xmin/xmaxä¸€è‡´æ€§
3. **ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­**: ä½¿ç”¨Hint Bitsç­‰ä¼˜åŒ–æŠ€æœ¯
4. **ç›‘æ§xmin/xmax**: ç›‘æ§äº‹åŠ¡IDåˆ†é…å’Œå›å·æƒ…å†µ

---

## äºŒã€å¯è§æ€§åˆ¤æ–­ç®—æ³•

### 2.0 å¯è§æ€§ (Visibility) å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 2.0.1 æƒå¨å®šä¹‰ä¸æ¥æº

**æ•°æ®åº“ç†è®ºä¸­çš„å¯è§æ€§å®šä¹‰**:

> å¯è§æ€§ï¼ˆVisibilityï¼‰æ˜¯æŒ‡ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬æ˜¯å¦å¯¹æŸä¸ªäº‹åŠ¡å¯è§ï¼Œå³è¯¥äº‹åŠ¡æ˜¯å¦èƒ½å¤Ÿè¯»å–åˆ°è¯¥æ•°æ®ç‰ˆæœ¬ã€‚å¯è§æ€§åˆ¤æ–­æ˜¯MVCCçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå†³å®šäº†äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ã€‚

**Wikipediaå®šä¹‰**:

> In database systems, visibility determines which version of a data item a transaction can see. In MVCC systems, visibility is typically based on transaction timestamps and snapshots.

**Adya et al. (2000) å½¢å¼åŒ–å®šä¹‰**:

å¯è§æ€§å¯ä»¥é€šè¿‡ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDSGï¼‰çš„å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\text{Visible}(v, T_i) \iff \neg\exists T_j: (T_j \xrightarrow{ww} T_i) \land (v \text{ created by } T_j)$$

å…¶ä¸­ï¼š

- $v$ æ˜¯æ•°æ®ç‰ˆæœ¬
- $T_i$ æ˜¯è¯»å–äº‹åŠ¡
- $T_j$ æ˜¯åˆ›å»ºç‰ˆæœ¬çš„äº‹åŠ¡
- $ww$ æ˜¯å†™ä¾èµ–å…³ç³»

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„å¯è§æ€§åˆ¤æ–­åŸºäºå¿«ç…§ï¼ˆSnapshotï¼‰å’Œäº‹åŠ¡IDï¼š

```python
def tuple_visible(tuple: Tuple, snapshot: Snapshot, txid: TransactionId) -> bool:
    """
    åˆ¤æ–­å…ƒç»„æ˜¯å¦å¯¹äº‹åŠ¡å¯è§

    è§„åˆ™:
    1. å…ƒç»„çš„xminå¿…é¡»å°äºå¿«ç…§çš„xmax
    2. å…ƒç»„çš„xminä¸èƒ½åœ¨å¿«ç…§çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨(xip)ä¸­
    3. å¦‚æœå…ƒç»„è¢«åˆ é™¤(xmax != 0)ï¼Œåˆ é™¤äº‹åŠ¡å¿…é¡»æœªæäº¤æˆ–åœ¨å¿«ç…§å
    """
    # è§„åˆ™1: åˆ›å»ºäº‹åŠ¡å¿…é¡»åœ¨å¿«ç…§å‰æäº¤
    if tuple.xmin >= snapshot.xmax:
        return False

    # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡ä¸èƒ½åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­
    if tuple.xmin in snapshot.xip:
        return False

    # è§„åˆ™3: æ£€æŸ¥åˆ é™¤æ ‡è®°
    if tuple.xmax != 0:
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤çš„ç‰ˆæœ¬ä¸å¯è§
        if tuple.xmax < snapshot.xmax and tuple.xmax not in snapshot.xip:
            return False  # å·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡åˆ é™¤

    return True
```

**æœ¬ä½“ç³»å®šä¹‰**:

å¯è§æ€§æ˜¯MVCCçš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®šä¹‰äº†äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ã€‚å¯è§æ€§åˆ¤æ–­åŸºäºï¼š

- **å¿«ç…§ï¼ˆSnapshotï¼‰**: å®šä¹‰äº‹åŠ¡çš„"æ—¶é—´ç‚¹"
- **äº‹åŠ¡ID**: æ ‡è¯†æ•°æ®ç‰ˆæœ¬çš„åˆ›å»ºå’Œåˆ é™¤äº‹åŠ¡
- **æ´»è·ƒäº‹åŠ¡åˆ—è¡¨**: æ ‡è¯†å“ªäº›äº‹åŠ¡ä»åœ¨è¿è¡Œ

---

#### 2.0.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.0.1 (å¯è§æ€§è°“è¯)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬ $v$ã€å¿«ç…§ $snap$ å’Œäº‹åŠ¡ $T$ï¼Œå¯è§æ€§è°“è¯å®šä¹‰ä¸ºï¼š

$$Visible(v, snap, T) \iff$$

$$(v.xmin < snap.xmax \land v.xmin \notin snap.xip) \land$$

$$(v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip \lor v.xmax = T.txid)$$

**å½¢å¼åŒ–è§„åˆ™**:

1. **è§„åˆ™1: åˆ›å»ºäº‹åŠ¡å¿…é¡»å·²æäº¤**
   $$v.xmin < snap.xmax \land v.xmin \notin snap.xip$$

2. **è§„åˆ™2: åˆ é™¤äº‹åŠ¡å¿…é¡»æœªæäº¤æˆ–åœ¨å¿«ç…§å**
   $$v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip$$

3. **è§„åˆ™3: æœ¬äº‹åŠ¡åˆ é™¤çš„ç‰ˆæœ¬ä¸å¯è§**
   $$v.xmax \neq T.txid$$

**å¯è§æ€§åˆ¤æ–­ç®—æ³•å¤æ‚åº¦**:

- **æ—¶é—´å¤æ‚åº¦**: $O(\log |xip|)$ - äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- **ç©ºé—´å¤æ‚åº¦**: $O(|xip|)$ - å­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- **ä¼˜åŒ–**: ä½¿ç”¨Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼Œå¤æ‚åº¦é™ä¸º $O(1)$

---

#### 2.0.3 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: åŸºäºé”çš„å¯è§æ€§
   - è¯»æ“ä½œéœ€è¦å…±äº«é”
   - å†™æ“ä½œéœ€è¦æ’ä»–é”
   - é”æœºåˆ¶å†³å®šå¯è§æ€§

2. **1980å¹´ä»£**: MVCCå¼•å…¥ç‰ˆæœ¬å¯è§æ€§
   - é€šè¿‡ç‰ˆæœ¬é“¾ç®¡ç†å¤šä¸ªç‰ˆæœ¬
   - é€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­å¯è§æ€§
   - æ— éœ€è¯»é”

3. **1990å¹´ä»£**: å¿«ç…§éš”ç¦»çš„å¯è§æ€§
   - ä½¿ç”¨å¿«ç…§å®šä¹‰å¯è§æ€§
   - åŸºäºäº‹åŠ¡IDå’Œæ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - PostgreSQLçš„å®ç°æ–¹å¼

4. **2000å¹´ä»£è‡³ä»Š**: å¯è§æ€§åˆ¤æ–­ä¼˜åŒ–
   - Hint Bitsç¼“å­˜
   - Visibility Mapä¼˜åŒ–
   - å¹¶è¡Œå¯è§æ€§æ£€æŸ¥

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦å¯è§æ€§ï¼Ÿ**

1. **å¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒ**:
   - å¤šä¸ªäº‹åŠ¡å¹¶å‘è®¿é—®åŒä¸€æ•°æ®
   - éœ€è¦å†³å®šæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°å“ªä¸ªç‰ˆæœ¬
   - å¯è§æ€§åˆ¤æ–­æ˜¯MVCCçš„åŸºç¡€

2. **éš”ç¦»æ€§çš„å®ç°**:
   - éš”ç¦»æ€§é€šè¿‡å¯è§æ€§æ§åˆ¶å®ç°
   - ä¸åŒéš”ç¦»çº§åˆ«æœ‰ä¸åŒçš„å¯è§æ€§è§„åˆ™
   - å¯è§æ€§è§„åˆ™å†³å®šäº†éš”ç¦»çº§åˆ«

3. **æ€§èƒ½ä¼˜åŒ–**:
   - é«˜æ•ˆçš„å¯è§æ€§åˆ¤æ–­æ˜¯MVCCæ€§èƒ½çš„å…³é”®
   - ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­å¯ä»¥å¤§å¹…æå‡æ€§èƒ½

**ç†è®ºä½ç½®**:

```text
å¯è§æ€§åœ¨ç†è®ºä½“ç³»ä¸­çš„ä½ç½®:
â”‚
â”œâ”€ å¹¶å‘æ§åˆ¶ç†è®º
â”‚   â””â”€ MVCC
â”‚       â””â”€ å¯è§æ€§åˆ¤æ–­ â† æœ¬æ¦‚å¿µä½ç½®
â”‚           â”œâ”€ å¿«ç…§
â”‚           â”œâ”€ äº‹åŠ¡ID
â”‚           â””â”€ æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
â”‚
â”œâ”€ éš”ç¦»çº§åˆ«ç†è®º
â”‚   â””â”€ éš”ç¦»æ€§
â”‚       â””â”€ å¯è§æ€§æ§åˆ¶
â”‚
â””â”€ LSEMç†è®º
    â””â”€ å¯è§æ€§ååºï¼ˆå…¬ç†2ï¼‰
```

**ç†è®ºæ¨å¯¼**:

```text
ä»MVCCåˆ°å¯è§æ€§åˆ¤æ–­çš„æ¨ç†é“¾æ¡:

1. MVCCæ ¸å¿ƒæ€æƒ³
   â”œâ”€ ç»´æŠ¤å¤šä¸ªæ•°æ®ç‰ˆæœ¬
   â”œâ”€ è¯»æ“ä½œé€‰æ‹©å¯è§ç‰ˆæœ¬
   â””â”€ å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬

2. å¯è§æ€§åˆ¤æ–­çš„å¿…è¦æ€§
   â”œâ”€ éœ€è¦å†³å®šå“ªä¸ªç‰ˆæœ¬å¯è§
   â”œâ”€ éœ€è¦é«˜æ•ˆçš„åˆ¤æ–­ç®—æ³•
   â””â”€ éœ€è¦ä¿è¯éš”ç¦»æ€§

3. å¯è§æ€§åˆ¤æ–­çš„å®ç°
   â”œâ”€ åŸºäºå¿«ç…§å®šä¹‰æ—¶é—´ç‚¹
   â”œâ”€ åŸºäºäº‹åŠ¡IDæ ‡è¯†ç‰ˆæœ¬
   â””â”€ åŸºäºæ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ’é™¤æœªæäº¤ç‰ˆæœ¬

4. ç»“è®º
   â””â”€ å¯è§æ€§åˆ¤æ–­æ˜¯MVCCçš„æ ¸å¿ƒæœºåˆ¶
```

---

#### 2.0.4 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: æ­£ç¡®çš„å¯è§æ€§åˆ¤æ–­**

```sql
-- åœºæ™¯: äº‹åŠ¡T1è¯»å–è´¦æˆ·ä½™é¢
-- æ—¶é—´çº¿:
-- T100: åˆ›å»ºä½™é¢=1000
-- T101: ä¿®æ”¹ä½™é¢=1500 (æœªæäº¤)
-- T102: è¯»å–ä½™é¢ (å½“å‰äº‹åŠ¡)

-- äº‹åŠ¡T102çš„å¿«ç…§
Snapshot {
    xmin = 99,      -- æœ€è€æ´»è·ƒäº‹åŠ¡
    xmax = 103,     -- ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
    xip = [101]     -- æ´»è·ƒäº‹åŠ¡: T101
}

-- å¯è§æ€§åˆ¤æ–­
Tuple_v1 {xmin=100, xmax=0}  -- åˆ›å»ºäºT100
  â†’ Visible?
  â†’ xmin(100) < xmax(103) âœ“
  â†’ xmin(100) âˆ‰ xip([101]) âœ“
  â†’ xmax(0) = 0 âœ“
  â†’ ç»“æœ: å¯è§ âœ“ è¿”å›ä½™é¢=1000

Tuple_v2 {xmin=101, xmax=0}  -- åˆ›å»ºäºT101ï¼ˆæœªæäº¤ï¼‰
  â†’ Visible?
  â†’ xmin(101) < xmax(103) âœ“
  â†’ xmin(101) âˆˆ xip([101]) âœ—
  â†’ ç»“æœ: ä¸å¯è§ âœ— ä¸è¿”å›
```

**åˆ†æ**:

- âœ… æ­£ç¡®åˆ¤æ–­ï¼šT102çœ‹åˆ°T100åˆ›å»ºçš„ç‰ˆæœ¬ï¼ˆå·²æäº¤ï¼‰
- âœ… æ­£ç¡®æ’é™¤ï¼šT102ä¸çœ‹åˆ°T101åˆ›å»ºçš„ç‰ˆæœ¬ï¼ˆæœªæäº¤ï¼‰
- âœ… é˜²æ­¢è„è¯»ï¼šé€šè¿‡å¯è§æ€§åˆ¤æ–­é˜²æ­¢è„è¯»

---

**åä¾‹åˆ†æ**:

**åä¾‹1: å¯è§æ€§åˆ¤æ–­é”™è¯¯å¯¼è‡´è„è¯»**

```sql
-- é”™è¯¯åœºæ™¯: å¯è§æ€§åˆ¤æ–­å¿½ç•¥æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
-- é—®é¢˜: é”™è¯¯åœ°è®¤ä¸ºæœªæäº¤ç‰ˆæœ¬å¯è§

-- é”™è¯¯çš„å¯è§æ€§åˆ¤æ–­
def wrong_visible(tuple, snapshot, txid):
    # é”™è¯¯: åªæ£€æŸ¥xmin < xmaxï¼Œå¿½ç•¥xip
    if tuple.xmin < snapshot.xmax:
        return True  # é”™è¯¯ï¼æœªæ£€æŸ¥æ´»è·ƒäº‹åŠ¡åˆ—è¡¨

-- ç»“æœ
Tuple {xmin=101, xmax=0}  -- T101æœªæäº¤
  â†’ é”™è¯¯åˆ¤æ–­: å¯è§ âœ—
  â†’ å®é™…: ä¸å¯è§ âœ“
  â†’ åæœ: è„è¯» âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥äº†æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼ˆxipï¼‰çš„æ£€æŸ¥
- æœªæäº¤äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬è¢«é”™è¯¯åœ°è®¤ä¸ºå¯è§
- å¯¼è‡´è„è¯»

**æ­£ç¡®åšæ³•**:

```python
def correct_visible(tuple, snapshot, txid):
    # æ­£ç¡®: æ£€æŸ¥xminæ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­
    if tuple.xmin >= snapshot.xmax:
        return False
    if tuple.xmin in snapshot.xip:  # å…³é”®æ£€æŸ¥
        return False  # æœªæäº¤äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬ä¸å¯è§
    # ... å…¶ä»–æ£€æŸ¥
    return True
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: åŸºäºé”™è¯¯æ•°æ®åšå‡ºå†³ç­–
- **ä¸€è‡´æ€§ç ´å**: è¿åACIDçš„éš”ç¦»æ€§

---

**åä¾‹2: å¯è§æ€§åˆ¤æ–­å¿½ç•¥åˆ é™¤æ ‡è®°**

```sql
-- é”™è¯¯åœºæ™¯: å¯è§æ€§åˆ¤æ–­å¿½ç•¥xmax
-- é—®é¢˜: é”™è¯¯åœ°è®¤ä¸ºå·²åˆ é™¤ç‰ˆæœ¬å¯è§

-- é”™è¯¯çš„å¯è§æ€§åˆ¤æ–­
def wrong_visible(tuple, snapshot, txid):
    # é”™è¯¯: åªæ£€æŸ¥xminï¼Œå¿½ç•¥xmax
    if tuple.xmin < snapshot.xmax and tuple.xmin not in snapshot.xip:
        return True  # é”™è¯¯ï¼æœªæ£€æŸ¥åˆ é™¤æ ‡è®°

-- ç»“æœ
Tuple {xmin=100, xmax=101}  -- T100åˆ›å»ºï¼ŒT101åˆ é™¤
  â†’ é”™è¯¯åˆ¤æ–­: å¯è§ âœ—
  â†’ å®é™…: ä¸å¯è§ âœ“ (å·²è¢«T101åˆ é™¤)
  â†’ åæœ: è¯»å–åˆ°å·²åˆ é™¤çš„æ•°æ® âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥äº†xmaxï¼ˆåˆ é™¤æ ‡è®°ï¼‰çš„æ£€æŸ¥
- å·²è¢«åˆ é™¤çš„ç‰ˆæœ¬è¢«é”™è¯¯åœ°è®¤ä¸ºå¯è§
- å¯¼è‡´è¯»å–åˆ°å·²åˆ é™¤çš„æ•°æ®

**æ­£ç¡®åšæ³•**:

```python
def correct_visible(tuple, snapshot, txid):
    # æ£€æŸ¥åˆ›å»ºäº‹åŠ¡
    if tuple.xmin >= snapshot.xmax or tuple.xmin in snapshot.xip:
        return False

    # æ£€æŸ¥åˆ é™¤æ ‡è®°ï¼ˆå…³é”®ï¼‰
    if tuple.xmax != 0:
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤
        if tuple.xmax < snapshot.xmax and tuple.xmax not in snapshot.xip:
            return False  # å·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡åˆ é™¤

    return True
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: è¯»å–åˆ°å·²åˆ é™¤çš„æ•°æ®
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: åŸºäºå·²åˆ é™¤æ•°æ®åšå‡ºå†³ç­–
- **ä¸€è‡´æ€§ç ´å**: è¿åæ•°æ®å®Œæ•´æ€§

---

**åä¾‹3: å¿«ç…§åˆ›å»ºé”™è¯¯å¯¼è‡´å¯è§æ€§åˆ¤æ–­é”™è¯¯**

```sql
-- é”™è¯¯åœºæ™¯: å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
-- é—®é¢˜: å¿«ç…§çš„xipåˆ—è¡¨ä¸å®Œæ•´

-- é”™è¯¯çš„å¿«ç…§åˆ›å»º
def wrong_snapshot():
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=[]  # é”™è¯¯: ç©ºåˆ—è¡¨ï¼Œæœªè·å–æ´»è·ƒäº‹åŠ¡
    )
    return snapshot

-- ç»“æœ
Tuple {xmin=101, xmax=0}  -- T101æœªæäº¤
Snapshot {xip=[]}  -- é”™è¯¯çš„å¿«ç…§
  â†’ å¯è§æ€§åˆ¤æ–­: xmin(101) âˆ‰ xip([]) âœ“
  â†’ é”™è¯¯ç»“è®º: å¯è§ âœ—
  â†’ å®é™…: ä¸å¯è§ âœ“
  â†’ åæœ: è„è¯» âœ—
```

**é”™è¯¯åŸå› **:

- å¿«ç…§åˆ›å»ºæ—¶æœªæ­£ç¡®è·å–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
- æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œå¯¼è‡´æœªæäº¤äº‹åŠ¡è¢«è¯¯è®¤ä¸ºå·²æäº¤
- å¯è§æ€§åˆ¤æ–­åŸºäºé”™è¯¯çš„å¿«ç…§

**æ­£ç¡®åšæ³•**:

```python
def correct_snapshot():
    # æ­£ç¡®: è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    active_xids = get_active_transaction_ids()  # å…³é”®
    snapshot = Snapshot(
        xmin=get_oldest_xmin(),
        xmax=get_next_xid(),
        xip=active_xids  # æ­£ç¡®çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    )
    return snapshot
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
- **ç³»ç»Ÿé”™è¯¯**: å¿«ç…§æœºåˆ¶å¤±æ•ˆ
- **ä¸€è‡´æ€§ç ´å**: è¿åéš”ç¦»æ€§

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘è¯»åœºæ™¯çš„å¯è§æ€§åˆ¤æ–­**

**åœºæ™¯æè¿°**:

- 1000ä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€è¡Œ
- è¯¥è¡Œæœ‰10ä¸ªå†å²ç‰ˆæœ¬
- éœ€è¦é«˜æ•ˆåˆ¤æ–­å“ªä¸ªç‰ˆæœ¬å¯è§

**å¯è§æ€§åˆ¤æ–­è¿‡ç¨‹**:

```python
# æ¯ä¸ªäº‹åŠ¡åˆ›å»ºè‡ªå·±çš„å¿«ç…§
for tx in range(1000):
    snapshot = create_snapshot(tx)

    # éå†ç‰ˆæœ¬é“¾
    for version in version_chain:
        if visible(version, snapshot, tx):
            return version  # æ‰¾åˆ°å¯è§ç‰ˆæœ¬
```

**æ€§èƒ½åˆ†æ**:

- **ç‰ˆæœ¬é“¾é•¿åº¦**: 10ä¸ªç‰ˆæœ¬
- **å¯è§æ€§åˆ¤æ–­æ¬¡æ•°**: æœ€å¤š10æ¬¡ï¼ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬å³è¿”å›ï¼‰
- **åˆ¤æ–­å¤æ‚åº¦**: $O(\log N_{active})$ æ¯æ¬¡åˆ¤æ–­
- **æ€»å¤æ‚åº¦**: $O(10 \times \log 1000) \approx O(100)$

**ä¼˜åŒ–ç­–ç•¥**:

1. ä½¿ç”¨Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
2. ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼ˆé€šå¸¸æ–°ç‰ˆæœ¬æ›´å¯èƒ½å¯è§ï¼‰
3. ä½¿ç”¨Visibility Mapè·³è¿‡ä¸å¯è§é¡µé¢

---

**åœºæ™¯2: é•¿äº‹åŠ¡çš„å¯è§æ€§åˆ¤æ–­**

**åœºæ™¯æè¿°**:

- é•¿äº‹åŠ¡è¿è¡Œ1å°æ—¶
- æœŸé—´æœ‰1000ä¸ªäº‹åŠ¡ä¿®æ”¹åŒä¸€è¡Œ
- é•¿äº‹åŠ¡éœ€è¦åˆ¤æ–­å“ªä¸ªç‰ˆæœ¬å¯è§

**å¯è§æ€§åˆ¤æ–­æŒ‘æˆ˜**:

```python
# é•¿äº‹åŠ¡T1çš„å¿«ç…§ï¼ˆäº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºï¼‰
snapshot_T1 = Snapshot(
    xmin=100,
    xmax=101,  # äº‹åŠ¡å¼€å§‹æ—¶çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
    xip=[100]  # äº‹åŠ¡å¼€å§‹æ—¶çš„æ´»è·ƒäº‹åŠ¡
)

# 1å°æ—¶åï¼Œç‰ˆæœ¬é“¾æœ‰1000ä¸ªç‰ˆæœ¬
version_chain = [v1, v2, ..., v1000]

# å¯è§æ€§åˆ¤æ–­
for version in version_chain:
    if visible(version, snapshot_T1, T1):
        return version  # éœ€è¦éå†åˆ°v1ï¼ˆæœ€è€çš„ç‰ˆæœ¬ï¼‰
```

**æ€§èƒ½é—®é¢˜**:

- **ç‰ˆæœ¬é“¾é•¿åº¦**: 1000ä¸ªç‰ˆæœ¬
- **éå†å¼€é”€**: éœ€è¦éå†åˆ°æœ€è€çš„å¯è§ç‰ˆæœ¬
- **æ€§èƒ½å½±å“**: å»¶è¿Ÿå¢åŠ ï¼Œå¯èƒ½è¾¾åˆ°ç§’çº§

**ä¼˜åŒ–ç­–ç•¥**:

1. é™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦ï¼ˆVACUUMæ¸…ç†ï¼‰
2. ä½¿ç”¨ç´¢å¼•åŠ é€Ÿç‰ˆæœ¬æŸ¥æ‰¾
3. é¿å…é•¿äº‹åŠ¡

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»å¿«ç…§åˆ°å¯è§æ€§åˆ¤æ–­çš„æ¨ç†**

```text
å‰æ1: å¿«ç…§å®šä¹‰äº†äº‹åŠ¡çš„"æ—¶é—´ç‚¹"
å‰æ2: æ•°æ®ç‰ˆæœ¬æœ‰åˆ›å»ºæ—¶é—´ï¼ˆxminï¼‰å’Œåˆ é™¤æ—¶é—´ï¼ˆxmaxï¼‰
å‰æ3: å¯è§æ€§åˆ¤æ–­éœ€è¦å†³å®šç‰ˆæœ¬æ˜¯å¦åœ¨å¿«ç…§çš„"æ—¶é—´ç‚¹"å¯è§

æ¨ç†æ­¥éª¤1: å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºæ—¶é—´åœ¨å¿«ç…§æ—¶é—´ç‚¹ä¹‹åï¼Œç‰ˆæœ¬ä¸å¯è§
æ¨ç†æ­¥éª¤2: å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡æœªæäº¤ï¼ˆåœ¨xipä¸­ï¼‰ï¼Œç‰ˆæœ¬ä¸å¯è§
æ¨ç†æ­¥éª¤3: å¦‚æœç‰ˆæœ¬å·²è¢«åˆ é™¤ï¼Œä¸”åˆ é™¤äº‹åŠ¡å·²æäº¤ï¼Œç‰ˆæœ¬ä¸å¯è§

ç»“è®º: å¯è§æ€§åˆ¤æ–­åŸºäºå¿«ç…§ã€xminã€xmaxã€xipçš„ç»„åˆåˆ¤æ–­
```

**æ¨ç†é“¾æ¡2: ä»å¯è§æ€§åˆ°éš”ç¦»æ€§ä¿è¯çš„æ¨ç†**

```text
å‰æ1: å¯è§æ€§æ§åˆ¶å†³å®šäº‹åŠ¡çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬
å‰æ2: ä¸åŒéš”ç¦»çº§åˆ«æœ‰ä¸åŒçš„å¯è§æ€§è§„åˆ™
å‰æ3: å¯è§æ€§è§„åˆ™å†³å®šäº†éš”ç¦»çº§åˆ«èƒ½é˜²æ­¢å“ªäº›å¼‚å¸¸

æ¨ç†æ­¥éª¤1: Read Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§ï¼Œæ¯æ¡è¯­å¥çœ‹åˆ°ä¸åŒçŠ¶æ€
æ¨ç†æ­¥éª¤2: Repeatable Readä½¿ç”¨äº‹åŠ¡çº§å¿«ç…§ï¼Œæ•´ä¸ªäº‹åŠ¡çœ‹åˆ°ç›¸åŒçŠ¶æ€
æ¨ç†æ­¥éª¤3: ä¸åŒçš„å¯è§æ€§è§„åˆ™å¯¼è‡´ä¸åŒçš„å¼‚å¸¸é˜²æ­¢èƒ½åŠ›

ç»“è®º: å¯è§æ€§æ˜¯éš”ç¦»æ€§å®ç°çš„åŸºç¡€æœºåˆ¶
```

---

#### 2.0.5 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¿«ç…§çš„å…³ç³»**:
   - å¯è§æ€§åˆ¤æ–­åŸºäºå¿«ç…§
   - å¿«ç…§å®šä¹‰äº†å¯è§æ€§çš„"æ—¶é—´ç‚¹"
   - ä¸åŒå¿«ç…§ç­–ç•¥å¯¼è‡´ä¸åŒçš„å¯è§æ€§è¡Œä¸º

2. **ä¸äº‹åŠ¡IDçš„å…³ç³»**:
   - xminæ ‡è¯†ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡
   - xmaxæ ‡è¯†ç‰ˆæœ¬çš„åˆ é™¤äº‹åŠ¡
   - äº‹åŠ¡IDç”¨äºåˆ¤æ–­äº‹åŠ¡çš„æäº¤çŠ¶æ€

3. **ä¸ç‰ˆæœ¬é“¾çš„å…³ç³»**:
   - ç‰ˆæœ¬é“¾åŒ…å«æ‰€æœ‰å†å²ç‰ˆæœ¬
   - å¯è§æ€§åˆ¤æ–­éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬
   - ç‰ˆæœ¬é“¾é•¿åº¦å½±å“å¯è§æ€§åˆ¤æ–­æ€§èƒ½

4. **ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:
   - ä¸åŒéš”ç¦»çº§åˆ«æœ‰ä¸åŒçš„å¯è§æ€§è§„åˆ™
   - å¯è§æ€§è§„åˆ™å†³å®šäº†éš”ç¦»çº§åˆ«èƒ½é˜²æ­¢å“ªäº›å¼‚å¸¸
   - å¯è§æ€§æ˜¯éš”ç¦»æ€§å®ç°çš„åŸºç¡€

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL MVCCå¯è§æ€§åˆ¤æ–­
   - åŸºäºå¿«ç…§å’Œäº‹åŠ¡ID
   - ç‰ˆæœ¬é“¾éå†
   - å¯è§æ€§åˆ¤æ–­ç®—æ³•

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå€Ÿç”¨æ£€æŸ¥å™¨çš„å¯è§æ€§
   - å¯è§æ€§ â‰ˆ ç”Ÿå‘½å‘¨æœŸæœ‰æ•ˆæ€§
   - å¿«ç…§ â‰ˆ ä½œç”¨åŸŸ
   - äº‹åŠ¡ID â‰ˆ ç”Ÿå‘½å‘¨æœŸæ ‡è®°

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯è§æ€§
   - å¯è§æ€§ â‰ˆ å› æœä¸€è‡´æ€§
   - å¿«ç…§ â‰ˆ å‘é‡æ—¶é’Ÿçš„å¿«ç…§ç‚¹
   - äº‹åŠ¡ID â‰ˆ é€»è¾‘æ—¶é’Ÿ

**å®ç°ç»†èŠ‚**:

**PostgreSQLæºç çº§åˆ†æ**:

```c
// src/backend/access/heap/heapam_visibility.c

bool HeapTupleSatisfiesVisibility(HeapTuple tuple, Snapshot snapshot, Buffer buffer)
{
    TransactionId xmin = HeapTupleGetRawXmin(tuple);
    TransactionId xmax = HeapTupleGetRawXmax(tuple);

    // è§„åˆ™1: æ£€æŸ¥åˆ›å»ºäº‹åŠ¡
    if (!TransactionIdIsValid(xmin))
        return false;

    if (TransactionIdFollowsOrEquals(xmin, snapshot->xmax))
        return false;  // åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§å

    if (XidInSnapshot(xmin, snapshot))
        return false;  // åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼ˆæœªæäº¤ï¼‰

    // è§„åˆ™2: æ£€æŸ¥åˆ é™¤æ ‡è®°
    if (HeapTupleIsOnlyLocked(tuple))
        return true;  // ä»…é”å®šï¼Œæœªåˆ é™¤

    if (TransactionIdIsValid(xmax))
    {
        if (TransactionIdEquals(xmax, GetCurrentTransactionId()))
            return false;  // æœ¬äº‹åŠ¡åˆ é™¤

        if (TransactionIdPrecedes(xmax, snapshot->xmax) &&
            !XidInSnapshot(xmax, snapshot))
            return false;  // å·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡åˆ é™¤
    }

    return true;  // å¯è§
}
```

**æ€§èƒ½å½±å“**:

1. **å¯è§æ€§åˆ¤æ–­å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(\log N_{active})$ - äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 0.1-0.5Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°ï¼‰

2. **ç‰ˆæœ¬é“¾éå†å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(|version\_chain|)$
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå–å†³äºç‰ˆæœ¬é“¾é•¿åº¦ï¼‰

3. **ä¼˜åŒ–æŠ€æœ¯**:
   - Hint Bits: ç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼Œå¤æ‚åº¦é™ä¸º $O(1)$
   - Visibility Map: è·³è¿‡ä¸å¯è§é¡µé¢
   - ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼ˆé€šå¸¸æ–°ç‰ˆæœ¬æ›´å¯èƒ½å¯è§ï¼‰

---

#### 2.0.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: å¯è§æ€§å†³å®šäº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬
2. **å®ç°**: åŸºäºå¿«ç…§ã€äº‹åŠ¡IDã€æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
3. **æ€§èƒ½**: é«˜æ•ˆçš„å¯è§æ€§åˆ¤æ–­æ˜¯MVCCæ€§èƒ½çš„å…³é”®
4. **åº”ç”¨**: æ‰€æœ‰MVCCç³»ç»Ÿéƒ½éœ€è¦å¯è§æ€§åˆ¤æ–­

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºå¯è§æ€§åˆ¤æ–­å¾ˆç®€å•
   - **é”™è¯¯**: å¿½ç•¥æ´»è·ƒäº‹åŠ¡åˆ—è¡¨æˆ–åˆ é™¤æ ‡è®°
   - **æ­£ç¡®**: éœ€è¦å®Œæ•´æ£€æŸ¥æ‰€æœ‰æ¡ä»¶

2. **è¯¯åŒº2**: è®¤ä¸ºæ‰€æœ‰ç‰ˆæœ¬éƒ½éœ€è¦æ£€æŸ¥
   - **é”™è¯¯**: éå†æ‰€æœ‰ç‰ˆæœ¬
   - **æ­£ç¡®**: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬å³è¿”å›

3. **è¯¯åŒº3**: å¿½ç•¥æ€§èƒ½ä¼˜åŒ–
   - **é”™è¯¯**: æ¯æ¬¡éƒ½å®Œæ•´åˆ¤æ–­
   - **æ­£ç¡®**: ä½¿ç”¨Hint Bitsã€Visibility Mapç­‰ä¼˜åŒ–

**æœ€ä½³å®è·µ**:

1. **ç†è§£å¯è§æ€§è§„åˆ™**: æ·±å…¥ç†è§£å¯è§æ€§åˆ¤æ–­çš„å®Œæ•´è§„åˆ™
2. **ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­**: ä½¿ç”¨Hint Bitsã€Visibility Mapç­‰ä¼˜åŒ–
3. **é¿å…é•¿ç‰ˆæœ¬é“¾**: é€šè¿‡VACUUMé™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦
4. **ç›‘æ§å¯è§æ€§æ€§èƒ½**: ç›‘æ§å¯è§æ€§åˆ¤æ–­çš„å¼€é”€

---

### 2.1 å®Œæ•´å¯è§æ€§è§„åˆ™

**ç®—æ³•2.1: å…ƒç»„å¯è§æ€§åˆ¤æ–­**:

```python
def tuple_visible(tuple: Tuple, snapshot: Snapshot, txid: TransactionId) -> bool:
    """
    å®Œæ•´çš„å¯è§æ€§åˆ¤æ–­ç®—æ³•

    æ—¶é—´å¤æ‚åº¦: O(log |xip|)ï¼ˆäºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ï¼‰
    """
    # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬æ°¸è¿œå¯è§
    if tuple.xmin == txid:
        if tuple.xmax == 0:
            return True  # æœªåˆ é™¤
        if tuple.xmax == txid:
            return False  # æœ¬äº‹åŠ¡å·²åˆ é™¤
        if not is_committed(tuple.xmax):
            return True  # åˆ é™¤äº‹åŠ¡æœªæäº¤
        return False  # åˆ é™¤äº‹åŠ¡å·²æäº¤

    # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤ â†’ ä¸å¯è§
    if not is_committed(tuple.xmin):
        return False

    # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§åå¯åŠ¨ â†’ ä¸å¯è§
    if tuple.xmin >= snapshot.xmax:
        return False

    # è§„åˆ™4: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨ â†’ ä¸å¯è§
    if tuple.xmin in snapshot.xip:  # O(log n) äºŒåˆ†æŸ¥æ‰¾
        return False

    # è§„åˆ™5: æ£€æŸ¥åˆ é™¤æ ‡è®°xmax
    if tuple.xmax == 0:
        return True  # æœªåˆ é™¤

    if tuple.xmax == txid:
        return False  # æœ¬äº‹åŠ¡åˆ é™¤

    if not is_committed(tuple.xmax):
        return True  # åˆ é™¤äº‹åŠ¡æœªæäº¤

    if tuple.xmax >= snapshot.xmax:
        return True  # åˆ é™¤åœ¨å¿«ç…§å

    if tuple.xmax in snapshot.xip:
        return True  # åˆ é™¤äº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨

    # æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ â†’ å·²åˆ é™¤
    return False
```

### 2.2 å¯è§æ€§è¯æ˜

**å®šç†2.1 (å¯è§æ€§å•è°ƒæ€§)**:

$$\forall snap_1, snap_2: snap_1 \prec snap_2 \implies Visible(v, snap_1) \subseteq Visible(v, snap_2)$$

**è¯æ˜**:

è®¾ $snap_1 = (xmin_1, xmax_1, xip_1)$, $snap_2 = (xmin_2, xmax_2, xip_2)$

ä¸” $snap_1 \prec snap_2$ï¼Œå³ $xmax_1 \leq xmax_2$ ä¸” $xip_1 \supseteq xip_2$

å‡è®¾ $v$ å¯¹ $snap_1$ å¯è§ï¼Œå³:

1. $v.xmin < xmax_1$ ä¸” $v.xmin \notin xip_1$
2. $v.xmax = 0$ æˆ– $v.xmax \geq xmax_1$ æˆ– $v.xmax \in xip_1$

éœ€è¯æ˜ $v$ å¯¹ $snap_2$ å¯è§:

**æƒ…å†µ1**: å¦‚æœ $v.xmin < xmax_1$ï¼Œåˆ™ $v.xmin < xmax_2$ï¼ˆå› ä¸º $xmax_1 \leq xmax_2$ï¼‰

**æƒ…å†µ2**: å¦‚æœ $v.xmin \notin xip_1$ï¼Œåˆ™ $v.xmin \notin xip_2$ï¼ˆå› ä¸º $xip_1 \supseteq xip_2$ï¼‰

**æƒ…å†µ3**: å¦‚æœ $v.xmax \geq xmax_1$ï¼Œåˆ™ $v.xmax \geq xmax_2$ æˆ– $v.xmax \in [xmax_1, xmax_2)$ï¼Œåè€…æ„å‘³ç€ $v$ åœ¨ $snap_2$ å‰æœªåˆ é™¤

å› æ­¤ $v$ å¯¹ $snap_2$ å¯è§ã€‚ âˆ

**æ¨è®º2.1**: å¿«ç…§è¶Šæ–°ï¼Œå¯è§çš„ç‰ˆæœ¬è¶Šå¤šï¼ˆå•è°ƒé€’å¢ï¼‰

### 2.3 æ—¶ç©ºå¤æ‚åº¦åˆ†æ

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | è¯´æ˜ |
|-----|-----------|-----------|------|
| **å¯è§æ€§æ£€æŸ¥** | $O(\log\|xip\|)$ | $O(1)$ | äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ |
| **å¿«ç…§åˆ›å»º** | $O(N)$ | $O(N)$ | Nä¸ºæ´»è·ƒäº‹åŠ¡æ•° |
| **ç‰ˆæœ¬é“¾éå†** | $O(k)$ | $O(1)$ | kä¸ºé“¾é•¿åº¦ |
| **ç´¢å¼•æ‰«æ** | $O(m \log n + mk)$ | $O(1)$ | mä¸ªç´¢å¼•é¡¹ï¼Œkä¸ºå¹³å‡é“¾é•¿ |

**æœ€åæƒ…å†µåˆ†æ**:

é«˜å¹¶å‘æ›´æ–°åŒä¸€è¡Œ â†’ ç‰ˆæœ¬é“¾é•¿åº¦ $k \to \infty$

$$T_{scan} = O(n \cdot k) \quad \text{where } k = \text{avg chain length}$$

**ä¼˜åŒ–ç­–ç•¥**: HOTï¼ˆHeap-Only Tupleï¼‰æœºåˆ¶ï¼Œé¿å…ç´¢å¼•è†¨èƒ€

---

## 2.5 ç‰ˆæœ¬é“¾ (Version Chain) å®Œæ•´å®šä¹‰ä¸åˆ†æ

### 2.5.0 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> A version chain in MVCC systems is a linked list of all versions of a logical row, where each version represents the state of the row at a specific point in time. Versions are linked together using pointers (such as ctid in PostgreSQL), allowing the system to traverse through historical versions to find the one visible to a given transaction.

**Gray & Reuter (1993) å®šä¹‰**:

> A version chain is a sequence of versions of a data item, where each version is created by a transaction and linked to the previous version. The version chain allows the system to maintain multiple versions of the same logical data item, enabling concurrent read and write operations without blocking.

**Berenson et al. (1995) å½¢å¼åŒ–å®šä¹‰**:

ç‰ˆæœ¬é“¾æ˜¯åŒä¸€é€»è¾‘å…ƒç»„çš„æ‰€æœ‰ç‰ˆæœ¬çš„åºåˆ—ï¼š

$$
\text{Chain}(r, k) = \begin{cases}
[\tau_0] & \text{if } \tau_0.\text{xmax} = 0 \\
[\tau_0] \oplus \text{Chain}(r, \tau_0.\text{ctid}) & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ï¼š

- $r$: å…³ç³»ï¼ˆè¡¨ï¼‰
- $k$: é€»è¾‘é”®
- $\tau_0$: åˆå§‹ç‰ˆæœ¬
- $\text{ctid}$: æŒ‡å‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„æŒ‡é’ˆ
- $\oplus$: åˆ—è¡¨è¿æ¥æ“ä½œ

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLé€šè¿‡ctidæŒ‡é’ˆå®ç°ç‰ˆæœ¬é“¾ï¼š

```python
class VersionChain:
    """
    PostgreSQLç‰ˆæœ¬é“¾å®ç°

    æ ¸å¿ƒæœºåˆ¶:
    1. ctidæŒ‡é’ˆ: æ¯ä¸ªç‰ˆæœ¬åŒ…å«æŒ‡å‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„æŒ‡é’ˆ
    2. ç‰ˆæœ¬é“¾éå†: ä»æœ€æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†
    3. å¯è§æ€§åˆ¤æ–­: éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬
    """
    def __init__(self, initial_tuple):
        self.head = initial_tuple  # é“¾å¤´ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
        self.versions = []  # æ‰€æœ‰ç‰ˆæœ¬

    def traverse(self, snapshot):
        """
        éå†ç‰ˆæœ¬é“¾ï¼Œæ‰¾åˆ°å¯è§ç‰ˆæœ¬

        ç®—æ³•:
        1. ä»æœ€æ–°ç‰ˆæœ¬å¼€å§‹
        2. æ£€æŸ¥æ¯ä¸ªç‰ˆæœ¬çš„å¯è§æ€§
        3. è¿”å›ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬
        """
        current = self.head
        while current is not None:
            if visible(current, snapshot):
                return current
            # é€šè¿‡ctidæŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬
            current = get_next_version(current.ctid)
        return None  # æ— å¯è§ç‰ˆæœ¬
```

**æœ¬ä½“ç³»å®šä¹‰**:

ç‰ˆæœ¬é“¾æ˜¯MVCCä¸­åŒä¸€é€»è¾‘å…ƒç»„çš„æ‰€æœ‰ç‰ˆæœ¬çš„é“¾è¡¨ç»“æ„ï¼Œé€šè¿‡ctidæŒ‡é’ˆè¿æ¥ã€‚ç‰ˆæœ¬é“¾å…è®¸ç³»ç»Ÿç»´æŠ¤åŒä¸€æ•°æ®çš„å¤šä¸ªå†å²ç‰ˆæœ¬ï¼Œä½¿å¹¶å‘è¯»å†™æ“ä½œæ— éœ€é˜»å¡ã€‚PostgreSQLé€šè¿‡ctidæŒ‡é’ˆå®ç°ç‰ˆæœ¬é“¾ï¼Œå¹¶é€šè¿‡éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯¹äº‹åŠ¡å¯è§çš„ç‰ˆæœ¬ã€‚

**ç‰ˆæœ¬é“¾ä¸MVCCçš„å…³ç³»**:

```text
ç‰ˆæœ¬é“¾ä¸MVCC:
â”‚
â”œâ”€ ç‰ˆæœ¬é“¾ (Version Chain) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: åŒä¸€é€»è¾‘å…ƒç»„çš„æ‰€æœ‰ç‰ˆæœ¬çš„é“¾è¡¨
â”‚       â””â”€ ä½œç”¨: å­˜å‚¨å¤šä¸ªå†å²ç‰ˆæœ¬
â”‚           â”œâ”€ ç»“æ„: é€šè¿‡ctidæŒ‡é’ˆè¿æ¥
â”‚           â””â”€ éå†: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†
â”‚
â””â”€ MVCC (Multi-Version Concurrency Control)
    â””â”€ å®šä¹‰: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
        â””â”€ å®ç°: é€šè¿‡ç‰ˆæœ¬é“¾ç®¡ç†å¤šä¸ªç‰ˆæœ¬
```

---

### 2.5.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.5.1 (ç‰ˆæœ¬é“¾ - Berenson et al., 1995)**:

å¯¹äºå…³ç³» $r$ å’Œé€»è¾‘é”® $k$ï¼Œç‰ˆæœ¬é“¾é€’å½’å®šä¹‰ä¸ºï¼š

$$
\text{Chain}(r, k) = \begin{cases}
[\tau_0] & \text{if } \tau_0.\text{xmax} = 0 \\
[\tau_0] \oplus \text{Chain}(r, \tau_0.\text{ctid}) & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ï¼š

- $\tau_0$: åˆå§‹ç‰ˆæœ¬ï¼ˆç´¢å¼•æŒ‡å‘çš„ç‰ˆæœ¬ï¼‰
- $\text{ctid}$: æŒ‡å‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„ç‰©ç†åœ°å€
- $\oplus$: åˆ—è¡¨è¿æ¥æ“ä½œ

**å®šä¹‰2.5.2 (ç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¸å˜å¼)**:

ç‰ˆæœ¬é“¾å¿…é¡»æ»¡è¶³å®Œæ•´æ€§ä¸å˜å¼ï¼š

$$\forall r \in R, \forall \tau_i, \tau_{i+1} \in \text{Chain}(r, k):$$

$$\tau_i.\text{xmax} = \tau_{i+1}.\text{xmin} \land \tau_i.\text{xmax} \neq 0$$

å³ï¼šæ—§ç‰ˆæœ¬çš„xmaxå¿…é¡»ç­‰äºæ–°ç‰ˆæœ¬çš„xminï¼Œä¸”æ—§ç‰ˆæœ¬å¿…é¡»è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ï¼ˆxmax â‰  0ï¼‰ã€‚

**å®šä¹‰2.5.3 (ç‰ˆæœ¬é“¾éå†)**:

ç‰ˆæœ¬é“¾éå†ç®—æ³•ï¼š

$$\text{Traverse}(chain, snapshot) = \text{first } \tau \in chain: \text{Visible}(\tau, snapshot)$$

å³ï¼šéå†ç‰ˆæœ¬é“¾ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¯è§çš„ç‰ˆæœ¬ã€‚

**å®šä¹‰2.5.4 (ç‰ˆæœ¬é“¾é•¿åº¦)**:

ç‰ˆæœ¬é“¾é•¿åº¦å®šä¹‰ä¸ºï¼š

$$|\text{Chain}(r, k)| = \text{number of versions in chain}$$

ç‰ˆæœ¬é“¾é•¿åº¦å½±å“å¯è§æ€§åˆ¤æ–­çš„æ€§èƒ½ã€‚

---

### 2.5.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1980å¹´ä»£**: MVCCæ¦‚å¿µæå‡º
   - é¦–æ¬¡æå‡ºå¤šç‰ˆæœ¬å­˜å‚¨
   - ä½¿ç”¨ç‰ˆæœ¬é“¾ç®¡ç†å¤šä¸ªç‰ˆæœ¬
   - åŸºäºæ—¶é—´æˆ³çš„ç‰ˆæœ¬ç®¡ç†

2. **1990å¹´ä»£**: ç‰ˆæœ¬é“¾å®ç°ä¼˜åŒ–
   - PostgreSQLé‡‡ç”¨ctidæŒ‡é’ˆå®ç°ç‰ˆæœ¬é“¾
   - ä¼˜åŒ–ç‰ˆæœ¬é“¾éå†ç®—æ³•
   - å¼•å…¥HOTä¼˜åŒ–å‡å°‘ç‰ˆæœ¬é“¾é•¿åº¦

3. **2000å¹´ä»£**: ç‰ˆæœ¬é“¾æ€§èƒ½ä¼˜åŒ–
   - Visibility Mapä¼˜åŒ–
   - ç‰ˆæœ¬é“¾æ¸…ç†ä¼˜åŒ–ï¼ˆVACUUMï¼‰
   - HOTé“¾ä¼˜åŒ–

4. **2010å¹´ä»£è‡³ä»Š**: ç‰ˆæœ¬é“¾ç®¡ç†æˆç†Ÿ
   - è‡ªåŠ¨ç‰ˆæœ¬é“¾æ¸…ç†
   - ç‰ˆæœ¬é“¾é•¿åº¦ç›‘æ§
   - æ€§èƒ½ä¼˜åŒ–

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬é“¾ï¼Ÿ**

1. **å¤šç‰ˆæœ¬å­˜å‚¨çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦ç»´æŠ¤åŒä¸€æ•°æ®çš„å¤šä¸ªå†å²ç‰ˆæœ¬
   - **è§£å†³**: ç‰ˆæœ¬é“¾å­˜å‚¨æ‰€æœ‰å†å²ç‰ˆæœ¬
   - **æ•ˆæœ**: æ”¯æŒå¿«ç…§éš”ç¦»ï¼Œè¯»ä¸é˜»å¡å†™

2. **ç‰ˆæœ¬é“¾çš„ä¼˜åŠ¿**:
   - **å¹¶å‘æ€§**: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
   - **ä¸€è‡´æ€§**: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§
   - **æ€§èƒ½**: æ— éœ€è¯»é”ï¼Œæ€§èƒ½é«˜

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - æ‰€æœ‰MVCCç³»ç»Ÿéƒ½éœ€è¦ç‰ˆæœ¬é“¾
   - å¿«ç…§éš”ç¦»ä¾èµ–ç‰ˆæœ¬é“¾
   - ç‰ˆæœ¬é“¾æ˜¯MVCCçš„åŸºç¡€

**ç†è®ºä½ç½®**:

```text
MVCCç†è®ºä½“ç³»:
â”‚
â”œâ”€ MVCCç†è®º
â”‚   â””â”€ æ ¸å¿ƒ: å¤šç‰ˆæœ¬å­˜å‚¨
â”‚
â”œâ”€ ç‰ˆæœ¬é“¾ç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: é€šè¿‡ctidæŒ‡é’ˆè¿æ¥ç‰ˆæœ¬
â”‚       â”œâ”€ ç»“æ„: é“¾è¡¨ç»“æ„
â”‚       â”œâ”€ éå†: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬
â”‚       â””â”€ æ¸…ç†: VACUUMæ¸…ç†æ—§ç‰ˆæœ¬
â”‚
â””â”€ å¯è§æ€§ç†è®º
    â””â”€ å®ç°: éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬
```

**ç‰ˆæœ¬é“¾ä¸MVCCçš„å…³ç³»**:

```text
ç‰ˆæœ¬é“¾ä¸MVCC:
â”‚
â”œâ”€ ç‰ˆæœ¬é“¾æ˜¯ç»“æ„
â”‚   â””â”€ å­˜å‚¨å¤šä¸ªå†å²ç‰ˆæœ¬
â”‚
â””â”€ MVCCæ˜¯æœºåˆ¶
    â””â”€ é€šè¿‡ç‰ˆæœ¬é“¾å®ç°å¤šç‰ˆæœ¬å­˜å‚¨
```

**ç†è®ºæ¨å¯¼**:

```text
ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°ç‰ˆæœ¬é“¾å®ç°çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: é«˜æ•ˆç‰ˆæœ¬æŸ¥æ‰¾ï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: ç‰ˆæœ¬æ¸…ç†ï¼ˆé‡è¦ï¼‰

2. ç‰ˆæœ¬é“¾è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨é“¾è¡¨ç»“æ„å­˜å‚¨ç‰ˆæœ¬
   â”œâ”€ æœºåˆ¶: ctidæŒ‡é’ˆè¿æ¥ç‰ˆæœ¬
   â””â”€ éå†: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†

3. å®ç°é€‰æ‹©
   â”œâ”€ é“¾è¡¨ç»“æ„: é«˜æ•ˆæ’å…¥å’Œéå†
   â”œâ”€ ctidæŒ‡é’ˆ: æŒ‡å‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬
   â””â”€ éå†ç®—æ³•: æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬

4. ç»“è®º
   â””â”€ ç‰ˆæœ¬é“¾æ˜¯å®ç°å¤šç‰ˆæœ¬å­˜å‚¨çš„æ ‡å‡†æ–¹æ³•
```

---

### 2.5.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: ç‰ˆæœ¬é“¾æ”¯æŒå¹¶å‘è¯»å†™**

```sql
-- åœºæ™¯: è¯»äº‹åŠ¡å’Œå†™äº‹åŠ¡å¹¶å‘æ‰§è¡Œ
-- éœ€æ±‚: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ

-- åˆå§‹çŠ¶æ€
INSERT INTO accounts (id, balance) VALUES (1, 1000);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0, balance=1000

-- äº‹åŠ¡T1 (è¯»äº‹åŠ¡)
BEGIN;
SELECT balance FROM accounts WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: v1 â†’ å¯è§ âœ“
-- è¿”å›: balance=1000

-- äº‹åŠ¡T2 (å†™äº‹åŠ¡ï¼Œå¹¶å‘æ‰§è¡Œ)
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- åˆ›å»ºæ–°ç‰ˆæœ¬v2: xmin=105, xmax=0, balance=1500
-- æ›´æ–°v1: xmax=105, ctidâ†’v2
-- ç‰ˆæœ¬é“¾: v1 â†’ v2
COMMIT;

-- äº‹åŠ¡T1 (ç»§ç»­è¯»å–)
SELECT balance FROM accounts WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: v2 â†’ ä¸å¯è§ï¼ˆxmin=105åœ¨å¿«ç…§åï¼‰
-- ç»§ç»­: v1 â†’ å¯è§ âœ“
-- è¿”å›: balance=1000ï¼ˆåŸºäºå¿«ç…§ï¼‰

COMMIT;

-- ç»“æœ: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ âœ“
```

**åˆ†æ**:

- âœ… ç‰ˆæœ¬é“¾ä¿è¯ï¼šè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
- âœ… å¹¶å‘æ€§èƒ½ï¼šè¯»å’Œå†™å¯ä»¥å¹¶å‘æ‰§è¡Œ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

---

**æ­£ä¾‹2: ç‰ˆæœ¬é“¾æ”¯æŒå¿«ç…§éš”ç¦»**

```sql
-- åœºæ™¯: å¤šä¸ªäº‹åŠ¡å¹¶å‘ä¿®æ”¹åŒä¸€è¡Œ
-- éœ€æ±‚: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

-- åˆå§‹çŠ¶æ€
INSERT INTO products (id, stock) VALUES (1, 100);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0, stock=100

-- äº‹åŠ¡T1 (å¿«ç…§: xmin=100, xmax=200)
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT stock FROM products WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: v1 â†’ å¯è§ âœ“
-- è¿”å›: stock=100

-- äº‹åŠ¡T2 (ä¿®æ”¹å¹¶æäº¤)
BEGIN;
UPDATE products SET stock = 80 WHERE id = 1;
-- åˆ›å»ºv2: xmin=105, xmax=0, stock=80
-- æ›´æ–°v1: xmax=105, ctidâ†’v2
COMMIT;

-- äº‹åŠ¡T3 (ä¿®æ”¹å¹¶æäº¤)
BEGIN;
UPDATE products SET stock = 60 WHERE id = 1;
-- åˆ›å»ºv3: xmin=110, xmax=0, stock=60
-- æ›´æ–°v2: xmax=110, ctidâ†’v3
COMMIT;

-- ç‰ˆæœ¬é“¾: v1 â†’ v2 â†’ v3

-- äº‹åŠ¡T1 (ç»§ç»­è¯»å–)
SELECT stock FROM products WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾:
--   v3 â†’ ä¸å¯è§ï¼ˆxmin=110åœ¨å¿«ç…§åï¼‰
--   v2 â†’ ä¸å¯è§ï¼ˆxmin=105åœ¨å¿«ç…§åï¼‰
--   v1 â†’ å¯è§ âœ“
-- è¿”å›: stock=100ï¼ˆåŸºäºå¿«ç…§ï¼‰âœ“

COMMIT;

-- ç»“æœ: å¿«ç…§éš”ç¦»ä¿è¯ä¸€è‡´æ€§ âœ“
```

**åˆ†æ**:

- âœ… ç‰ˆæœ¬é“¾ä¿è¯ï¼šæ”¯æŒå¿«ç…§éš”ç¦»
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§
- âœ… æ€§èƒ½ï¼šè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ

---

**åä¾‹åˆ†æ**:

**åä¾‹1: æ— ç‰ˆæœ¬é“¾å¯¼è‡´è¯»å†™é˜»å¡**

```sql
-- é”™è¯¯åœºæ™¯: æ— ç‰ˆæœ¬é“¾ï¼ˆç†è®ºåœºæ™¯ï¼Œä½¿ç”¨é”æœºåˆ¶ï¼‰
-- é—®é¢˜: è¯»æ“ä½œé˜»å¡å†™æ“ä½œ

-- äº‹åŠ¡T1 (è¯»äº‹åŠ¡)
BEGIN;
SELECT balance FROM accounts WHERE id = 1;
-- è·å–å…±äº«é” âœ—
-- æŒæœ‰é”ç›´åˆ°äº‹åŠ¡ç»“æŸ âœ—

-- äº‹åŠ¡T2 (å†™äº‹åŠ¡ï¼Œç­‰å¾…é”)
BEGIN;
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- ç­‰å¾…å…±äº«é”é‡Šæ”¾ âœ—
-- é˜»å¡ âœ—

-- ç»“æœ: è¯»æ“ä½œé˜»å¡å†™æ“ä½œ âœ—
```

**é”™è¯¯åŸå› **:

- æ— ç‰ˆæœ¬é“¾ï¼Œä½¿ç”¨é”æœºåˆ¶
- è¯»æ“ä½œéœ€è¦å…±äº«é”ï¼Œé˜»å¡å†™æ“ä½œ
- æ€§èƒ½ä¸¥é‡ä¸‹é™

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨ç‰ˆæœ¬é“¾ï¼ˆMVCCï¼‰
-- è¯»æ“ä½œ: éå†ç‰ˆæœ¬é“¾ï¼Œæ— éœ€é” âœ“
-- å†™æ“ä½œ: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œæ— éœ€ç­‰å¾…è¯»æ“ä½œ âœ“
-- ç»“æœ: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: è¯»æ“ä½œé˜»å¡å†™æ“ä½œï¼ŒTPSä¸‹é™
- **å¹¶å‘æ€§å·®**: æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPU
- **ç³»ç»Ÿä¸ç¨³å®š**: é«˜å¹¶å‘æ—¶æ€§èƒ½å´©æºƒ

---

**åä¾‹2: ç‰ˆæœ¬é“¾è¿‡é•¿å¯¼è‡´æ€§èƒ½ä¸‹é™**

```sql
-- é”™è¯¯åœºæ™¯: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°
-- é—®é¢˜: ç‰ˆæœ¬é“¾è¿‡é•¿ï¼Œéå†å¼€é”€å¤§

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡ - è¿è¡Œ1å°æ—¶)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- äº‹åŠ¡T2, T3, ..., T1000 (é«˜é¢‘æ›´æ–°)
-- æ¯ç§’æ›´æ–°åŒä¸€è¡Œ100æ¬¡
-- 1å°æ—¶å: ç‰ˆæœ¬é“¾é•¿åº¦ = 360,000

-- äº‹åŠ¡T1 (æŸ¥è¯¢)
SELECT * FROM accounts WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: éœ€è¦æ£€æŸ¥360,000ä¸ªç‰ˆæœ¬ âœ—
-- å»¶è¿Ÿ: æ•°ç§’ç”šè‡³æ•°åç§’ âœ—
```

**é”™è¯¯åŸå› **:

- é•¿äº‹åŠ¡æŒæœ‰å¿«ç…§ï¼Œç‰ˆæœ¬é“¾ä¸èƒ½æ¸…ç†
- é«˜é¢‘æ›´æ–°å¯¼è‡´ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿
- ç‰ˆæœ¬é“¾éå†å¼€é”€å·¨å¤§

**æ­£ç¡®åšæ³•**:

```sql
-- æ–¹æ¡ˆ1: é¿å…é•¿äº‹åŠ¡
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE id = 1;
COMMIT;  -- å¿«é€Ÿæäº¤ï¼Œé‡Šæ”¾å¿«ç…§

-- æ–¹æ¡ˆ2: å®šæœŸVACUUMæ¸…ç†ç‰ˆæœ¬é“¾
VACUUM accounts;  -- æ¸…ç†æ—§ç‰ˆæœ¬

-- æ–¹æ¡ˆ3: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
BEGIN;  -- Read Committed
SELECT * FROM accounts WHERE id = 1;
COMMIT;
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: ç‰ˆæœ¬é“¾éå†å¼€é”€å·¨å¤§
- **å»¶è¿Ÿå¢åŠ **: æŸ¥è¯¢å»¶è¿Ÿä»æ¯«ç§’çº§å¢åŠ åˆ°ç§’çº§
- **å­˜å‚¨è†¨èƒ€**: ç‰ˆæœ¬é“¾å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘è¯»ç³»ç»Ÿä½¿ç”¨ç‰ˆæœ¬é“¾**

**åœºæ™¯æè¿°**:

- é«˜å¹¶å‘è¯»ç³»ç»Ÿï¼ˆ1000+ QPSï¼‰
- è¯»å¤šå†™å°‘ï¼ˆ90%è¯»ï¼Œ10%å†™ï¼‰
- éœ€è¦é«˜æ€§èƒ½

**ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬é“¾**:

- âœ… å¹¶å‘æ€§ï¼šè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ
- âœ… æ€§èƒ½ï¼šæ— éœ€è¯»é”ï¼Œæ€§èƒ½é«˜
- âœ… ä¸€è‡´æ€§ï¼šæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLè‡ªåŠ¨ä½¿ç”¨ç‰ˆæœ¬é“¾ï¼ˆMVCCï¼‰
BEGIN;
SELECT * FROM products WHERE id = 1;
-- è‡ªåŠ¨éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬ âœ“
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ç‰ˆæœ¬é“¾**: æ”¯æŒé«˜å¹¶å‘è¯» âœ“
- **æ€§èƒ½**: TPS = 50,000+ âœ“
- **ä¸€è‡´æ€§**: å¿«ç…§éš”ç¦»ä¿è¯ä¸€è‡´æ€§ âœ“

---

**åœºæ™¯2: ç‰ˆæœ¬é“¾æ¸…ç†ä¼˜åŒ–**

**åœºæ™¯æè¿°**:

- é«˜é¢‘æ›´æ–°ç³»ç»Ÿ
- ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿
- éœ€è¦å®šæœŸæ¸…ç†

**ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬é“¾æ¸…ç†**:

- âœ… æ€§èƒ½ï¼šé™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦ï¼Œæå‡éå†æ€§èƒ½
- âœ… å­˜å‚¨ï¼šå›æ”¶æ­»å…ƒç»„ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´
- âœ… ç³»ç»Ÿç¨³å®šæ€§ï¼šé¿å…ç‰ˆæœ¬é“¾è¿‡é•¿å¯¼è‡´æ€§èƒ½ä¸‹é™

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- å®šæœŸVACUUMæ¸…ç†ç‰ˆæœ¬é“¾
VACUUM accounts;

-- æˆ–è‡ªåŠ¨VACUUM
ALTER TABLE accounts SET (autovacuum_enabled = true);
```

**æ•ˆæœåˆ†æ**:

- **ç‰ˆæœ¬é“¾é•¿åº¦**: é™åˆ¶åœ¨åˆç†èŒƒå›´ âœ“
- **æ€§èƒ½**: ç‰ˆæœ¬é“¾éå†æ€§èƒ½é«˜ âœ“
- **å­˜å‚¨**: æ­»å…ƒç»„è¢«æ¸…ç†ï¼Œå­˜å‚¨ç©ºé—´é‡Šæ”¾ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°ç‰ˆæœ¬é“¾å®ç°çš„æ¨ç†**

```text
å‰æ1: MVCCéœ€è¦å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
å‰æ2: éœ€è¦é«˜æ•ˆæŸ¥æ‰¾å¯è§ç‰ˆæœ¬ï¼ˆé‡è¦ï¼‰
å‰æ3: éœ€è¦ç‰ˆæœ¬æ¸…ç†æœºåˆ¶ï¼ˆé‡è¦ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©ç‰ˆæœ¬å­˜å‚¨ç»“æ„
æ¨ç†æ­¥éª¤2: é“¾è¡¨ç»“æ„æ”¯æŒé«˜æ•ˆæ’å…¥å’Œéå†ï¼ˆæ»¡è¶³å‰æ2ï¼‰
æ¨ç†æ­¥éª¤3: ç‰ˆæœ¬é“¾æ”¯æŒVACUUMæ¸…ç†ï¼ˆæ»¡è¶³å‰æ3ï¼‰

ç»“è®º: ä½¿ç”¨ç‰ˆæœ¬é“¾å®ç°å¤šç‰ˆæœ¬å­˜å‚¨ âœ“
```

**æ¨ç†é“¾æ¡2: ä»ç‰ˆæœ¬é“¾åˆ°å¯è§æ€§åˆ¤æ–­çš„æ¨ç†**

```text
å‰æ1: ç‰ˆæœ¬é“¾åŒ…å«æ‰€æœ‰å†å²ç‰ˆæœ¬
å‰æ2: éœ€è¦æ‰¾åˆ°å¯¹äº‹åŠ¡å¯è§çš„ç‰ˆæœ¬
å‰æ3: å¯è§æ€§åˆ¤æ–­åŸºäºå¿«ç…§

æ¨ç†æ­¥éª¤1: éå†ç‰ˆæœ¬é“¾æ£€æŸ¥æ¯ä¸ªç‰ˆæœ¬
æ¨ç†æ­¥éª¤2: ä½¿ç”¨å¯è§æ€§è§„åˆ™åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å¯è§
æ¨ç†æ­¥éª¤3: è¿”å›ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬

ç»“è®º: ç‰ˆæœ¬é“¾éå†æ˜¯å¯è§æ€§åˆ¤æ–­çš„åŸºç¡€ âœ“
```

---

### 2.5.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸MVCCçš„å…³ç³»**:
   - ç‰ˆæœ¬é“¾æ˜¯MVCCçš„æ ¸å¿ƒæ•°æ®ç»“æ„
   - MVCCé€šè¿‡ç‰ˆæœ¬é“¾å®ç°å¤šç‰ˆæœ¬å­˜å‚¨
   - ç‰ˆæœ¬é“¾æ˜¯MVCCçš„åŸºç¡€

2. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - å¯è§æ€§åˆ¤æ–­éœ€è¦éå†ç‰ˆæœ¬é“¾
   - ç‰ˆæœ¬é“¾åŒ…å«æ‰€æœ‰å†å²ç‰ˆæœ¬
   - å¯è§æ€§åˆ¤æ–­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬

3. **ä¸å¿«ç…§çš„å…³ç³»**:
   - å¿«ç…§å®šä¹‰å¯è§æ€§è¾¹ç•Œ
   - ç‰ˆæœ¬é“¾éå†åŸºäºå¿«ç…§åˆ¤æ–­å¯è§æ€§
   - ä¸åŒå¿«ç…§çœ‹åˆ°ä¸åŒçš„ç‰ˆæœ¬

4. **ä¸VACUUMçš„å…³ç³»**:
   - VACUUMæ¸…ç†ç‰ˆæœ¬é“¾ä¸­çš„æ­»å…ƒç»„
   - ç‰ˆæœ¬é“¾é•¿åº¦å½±å“VACUUMæ€§èƒ½
   - VACUUMé™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQLç‰ˆæœ¬é“¾å®ç°
   - ctidæŒ‡é’ˆè¿æ¥ç‰ˆæœ¬
   - ç‰ˆæœ¬é“¾éå†ç®—æ³•
   - VACUUMæ¸…ç†æœºåˆ¶

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - ç‰ˆæœ¬é“¾ â‰ˆ æ‰€æœ‰æƒé“¾
   - ctidæŒ‡é’ˆ â‰ˆ å¼•ç”¨
   - ç‰ˆæœ¬æ¸…ç† â‰ˆ å†…å­˜å›æ”¶

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - ç‰ˆæœ¬é“¾ â‰ˆ ç‰ˆæœ¬å‘é‡
   - ctidæŒ‡é’ˆ â‰ˆ ç‰ˆæœ¬ä¾èµ–
   - ç‰ˆæœ¬æ¸…ç† â‰ˆ ç‰ˆæœ¬å‹ç¼©

**å®ç°ç»†èŠ‚**:

**PostgreSQLç‰ˆæœ¬é“¾å®ç°æ¶æ„**:

```c
// src/backend/access/heap/heapam.c

// ç‰ˆæœ¬é“¾éå†
HeapTuple heap_getnext(TableScanDesc scan, ScanDirection direction)
{
    HeapTuple tuple;
    Buffer buffer;
    Page page;
    ItemId lp;

    // 1. è·å–å½“å‰å…ƒç»„
    tuple = scan->rs_ctup;
    if (tuple == NULL)
        return NULL;

    // 2. æ£€æŸ¥ctidæŒ‡é’ˆï¼ˆç‰ˆæœ¬é“¾ï¼‰
    if (ItemPointerIsValid(&tuple->t_data->t_ctid))
    {
        // 3. ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬
        ItemPointerSet(&scan->rs_ctup.t_self,
                       ItemPointerGetBlockNumber(&tuple->t_data->t_ctid),
                       ItemPointerGetOffsetNumber(&tuple->t_data->t_ctid));

        // 4. è¯»å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬
        buffer = ReadBuffer(scan->rs_rd,
                           ItemPointerGetBlockNumber(&tuple->t_data->t_ctid));
        page = BufferGetPage(buffer);
        lp = PageGetItemId(page, ItemPointerGetOffsetNumber(&tuple->t_data->t_ctid));
        tuple->t_data = (HeapTupleHeader) PageGetItem(page, lp);
    }

    // 5. å¯è§æ€§åˆ¤æ–­
    if (!HeapTupleSatisfiesVisibility(tuple, scan->rs_snapshot, buffer))
    {
        // ä¸å¯è§ï¼Œç»§ç»­éå†ä¸‹ä¸€ä¸ªç‰ˆæœ¬
        return heap_getnext(scan, direction);
    }

    return tuple;  // è¿”å›å¯è§ç‰ˆæœ¬
}
```

**ç‰ˆæœ¬é“¾ä¿è¯æœºåˆ¶**:

```python
def ensure_version_chain(tuple, new_version):
    """
    ç¡®ä¿ç‰ˆæœ¬é“¾å®Œæ•´æ€§

    æœºåˆ¶:
    1. åˆ›å»ºæ–°ç‰ˆæœ¬
    2. æ›´æ–°æ—§ç‰ˆæœ¬çš„xmaxå’Œctid
    3. ä¿è¯ç‰ˆæœ¬é“¾å®Œæ•´æ€§ä¸å˜å¼
    """
    # 1. åˆ›å»ºæ–°ç‰ˆæœ¬
    new_tuple = create_new_version(new_version)
    new_tuple.xmin = get_current_transaction_id()
    new_tuple.xmax = 0

    # 2. æ›´æ–°æ—§ç‰ˆæœ¬
    tuple.xmax = get_current_transaction_id()
    tuple.ctid = new_tuple.ctid  # æŒ‡å‘æ–°ç‰ˆæœ¬

    # 3. ä¿è¯ç‰ˆæœ¬é“¾å®Œæ•´æ€§
    assert tuple.xmax == new_tuple.xmin  # å®Œæ•´æ€§ä¸å˜å¼

    return new_tuple
```

**æ€§èƒ½å½±å“**:

1. **ç‰ˆæœ¬é“¾éå†å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(|chain|)$ - éå†ç‰ˆæœ¬é“¾é•¿åº¦
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå–å†³äºç‰ˆæœ¬é“¾é•¿åº¦ï¼‰
   - æœ€åæƒ…å†µ: $O(N)$ - Nä¸ºç‰ˆæœ¬é“¾é•¿åº¦

2. **ç‰ˆæœ¬é“¾æ’å…¥å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - æ›´æ–°ctidæŒ‡é’ˆ
   - å…¸å‹å¼€é”€: 0.1-0.5Î¼s
   - ç©ºé—´å¼€é”€: æ–°ç‰ˆæœ¬å­˜å‚¨

3. **æ€»ä½“æ€§èƒ½**:
   - çŸ­ç‰ˆæœ¬é“¾: éå†å¼€é”€å°ï¼ˆ1-5Î¼sï¼‰
   - é•¿ç‰ˆæœ¬é“¾: éå†å¼€é”€å¤§ï¼ˆ10-100Î¼s+ï¼‰
   - ä¼˜åŒ–: VACUUMæ¸…ç†ï¼Œé™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦

---

### 2.5.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**ç‰ˆæœ¬é“¾éå†å¼€é”€**:

$$T_{traverse} = T_{read\_version} \times |chain| + T_{visibility\_check} \times |chain|$$

å…¶ä¸­ï¼š

- $T_{read\_version} = O(1)$ - è¯»å–å•ä¸ªç‰ˆæœ¬æ—¶é—´
- $T_{visibility\_check} = O(\log N_{active})$ - å¯è§æ€§åˆ¤æ–­æ—¶é—´
- $|chain|$ - ç‰ˆæœ¬é“¾é•¿åº¦

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| ç‰ˆæœ¬é“¾é•¿åº¦ | éå†æ—¶é—´ | å¯è§æ€§åˆ¤æ–­æ—¶é—´ | æ€»ä½“å¼€é”€ | è¯´æ˜ |
|-----------|---------|--------------|---------|------|
| **1-5ä¸ªç‰ˆæœ¬** | 1-5Î¼s | 0.5-2.5Î¼s | 1.5-7.5Î¼s | å¼€é”€å¾ˆå° |
| **10-50ä¸ªç‰ˆæœ¬** | 10-50Î¼s | 5-25Î¼s | 15-75Î¼s | å¼€é”€å¯æ¥å— |
| **100-1000ä¸ªç‰ˆæœ¬** | 100-1000Î¼s | 50-500Î¼s | 150-1500Î¼s | å¼€é”€å¢åŠ  |
| **> 1000ä¸ªç‰ˆæœ¬** | > 1ms | > 0.5ms | > 1.5ms | å¼€é”€è¿‡å¤§ |

**ä¼˜åŒ–å»ºè®®**:

1. **é™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦**:
   - å®šæœŸVACUUMæ¸…ç†æ­»å…ƒç»„
   - é¿å…é•¿äº‹åŠ¡
   - ç›‘æ§ç‰ˆæœ¬é“¾é•¿åº¦

2. **ä¼˜åŒ–ç‰ˆæœ¬é“¾éå†**:
   - ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼ˆé€šå¸¸æ–°ç‰ˆæœ¬æ›´å¯èƒ½å¯è§ï¼‰
   - ä½¿ç”¨Hint Bitså‡å°‘å¯è§æ€§åˆ¤æ–­å¼€é”€
   - ä½¿ç”¨Visibility Mapè·³è¿‡ä¸å¯è§é¡µé¢

3. **ä½¿ç”¨HOTä¼˜åŒ–**:
   - åŒé¡µæ›´æ–°é¿å…ç´¢å¼•æ›´æ–°
   - å‡å°‘ç‰ˆæœ¬é“¾é•¿åº¦
   - æå‡æ€§èƒ½

---

### 2.5.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: ç‰ˆæœ¬é“¾æ˜¯åŒä¸€é€»è¾‘å…ƒç»„çš„æ‰€æœ‰ç‰ˆæœ¬çš„é“¾è¡¨ç»“æ„
2. **å®ç°**: é€šè¿‡ctidæŒ‡é’ˆè¿æ¥ç‰ˆæœ¬
3. **éå†**: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼Œæ‰¾åˆ°å¯è§ç‰ˆæœ¬
4. **æ€§èƒ½**: ç‰ˆæœ¬é“¾é•¿åº¦å½±å“éå†æ€§èƒ½

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºç‰ˆæœ¬é“¾å°±æ˜¯ç®€å•çš„é“¾è¡¨
   - **é”™è¯¯**: ç‰ˆæœ¬é“¾éœ€è¦ä¿è¯å®Œæ•´æ€§ä¸å˜å¼
   - **æ­£ç¡®**: ç‰ˆæœ¬é“¾å¿…é¡»æ»¡è¶³ $\tau_i.\text{xmax} = \tau_{i+1}.\text{xmin}$

2. **è¯¯åŒº2**: è®¤ä¸ºç‰ˆæœ¬é“¾è¶Šé•¿è¶Šå¥½
   - **é”™è¯¯**: ç‰ˆæœ¬é“¾è¿‡é•¿å¯¼è‡´éå†æ€§èƒ½ä¸‹é™
   - **æ­£ç¡®**: éœ€è¦å®šæœŸVACUUMæ¸…ç†ï¼Œé™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦

3. **è¯¯åŒº3**: å¿½ç•¥ç‰ˆæœ¬é“¾æ¸…ç†çš„é‡è¦æ€§
   - **é”™è¯¯**: è®¤ä¸ºç‰ˆæœ¬é“¾ä¼šè‡ªåŠ¨æ¸…ç†
   - **æ­£ç¡®**: éœ€è¦å®šæœŸVACUUMæ¸…ç†æ­»å…ƒç»„

**æœ€ä½³å®è·µ**:

1. **ç†è§£ç‰ˆæœ¬é“¾ç»“æ„**: ç†è§£ctidæŒ‡é’ˆå’Œç‰ˆæœ¬é“¾éå†
2. **é™åˆ¶ç‰ˆæœ¬é“¾é•¿åº¦**: é€šè¿‡VACUUMæ¸…ç†ï¼Œé¿å…ç‰ˆæœ¬é“¾è¿‡é•¿
3. **ä¼˜åŒ–ç‰ˆæœ¬é“¾éå†**: ä»æ–°ç‰ˆæœ¬å‘æ—§ç‰ˆæœ¬éå†ï¼Œä½¿ç”¨Hint Bits
4. **ç›‘æ§ç‰ˆæœ¬é“¾æ€§èƒ½**: ç›‘æ§ç‰ˆæœ¬é“¾é•¿åº¦ã€éå†å¼€é”€ç­‰æŒ‡æ ‡

---

## ä¸‰ã€æ“ä½œè¯­ä¹‰ä¸ç‰ˆæœ¬é“¾æ¼”åŒ–

### 3.1 INSERTæ“ä½œ

**è¯­ä¹‰**:

$$INSERT(data) \implies \text{Create } v_{new} \text{ where } v_{new}.xmin = \text{CurrentTxID}$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T1 (TxID=100)
INSERT INTO users (id, name) VALUES (1, 'Alice');

-- å…ƒç»„çŠ¶æ€
Tuple {
    xmin: 100,
    xmax: 0,        -- æœªåˆ é™¤
    data: 'Alice',
    ctid: (0, 1)    -- é¡µå·0, åç§»1
}
```

**å¯è§æ€§**:

- å¯¹T1: ç«‹å³å¯è§ï¼ˆè§„åˆ™1ï¼‰
- å¯¹å…¶ä»–äº‹åŠ¡: T1æäº¤åå¯è§ï¼ˆè§„åˆ™2ï¼‰

### 3.2 DELETEæ“ä½œ

**è¯­ä¹‰**:

$$DELETE(row) \implies v_{old}.xmax \leftarrow \text{CurrentTxID}$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T2 (TxID=105)
DELETE FROM users WHERE id = 1;

-- å…ƒç»„çŠ¶æ€æ›´æ–°
Tuple {
    xmin: 100,
    xmax: 105,      -- æ ‡è®°åˆ é™¤
    data: 'Alice',
    ctid: (0, 1)
}
```

**å»¶è¿Ÿæ¸…ç†**: ç‰©ç†åˆ é™¤ç”±VACUUMå®Œæˆ

### 3.3 UPDATEæ“ä½œ

**è¯­ä¹‰**:

$$UPDATE(row, new\_data) \equiv DELETE(row) + INSERT(new\_data)$$

**ç‰©ç†è¿‡ç¨‹**:

```sql
-- äº‹åŠ¡T3 (TxID=110)
UPDATE users SET name = 'Bob' WHERE id = 1;

-- æ—§ç‰ˆæœ¬æ ‡è®°åˆ é™¤
Tuple_old {
    xmin: 100,
    xmax: 110,      -- æ ‡è®°åˆ é™¤
    data: 'Alice',
    ctid: (0, 1)
}

-- æ–°ç‰ˆæœ¬æ’å…¥
Tuple_new {
    xmin: 110,
    xmax: 0,
    data: 'Bob',
    ctid: (0, 2)    -- æ–°ä½ç½®
}
```

**HOTä¼˜åŒ–æ¡ä»¶**:

1. æœªæ›´æ–°ç´¢å¼•åˆ—
2. æ–°ç‰ˆæœ¬åœ¨åŒä¸€é¡µå†…
3. é¡µé¢æœ‰è¶³å¤Ÿç©ºé—´

**HOTé“¾**:

```text
Index â†’ Tuple_old â”€[HOT]â†’ Tuple_new
          â†‘ (ctidæŒ‡é’ˆ)
```

---

## å››ã€éš”ç¦»çº§åˆ«å®ç°

### 4.1 Read Committed (è¯»å·²æäº¤)

#### 4.1.1 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> Read Committed is an isolation level that guarantees that any data read is committed at the moment it is read. It prevents dirty reads, but does not prevent non-repeatable reads or phantom reads.

**ANSI SQLæ ‡å‡†å®šä¹‰** (SQL:2016):

> Read Committed isolation level ensures that:
>
> - **P0 (Dirty Write)**: Prevented âœ“
> - **P1 (Dirty Read)**: Prevented âœ“
> - **P2 (Non-repeatable Read)**: Allowed âœ—
> - **P3 (Phantom Read)**: Allowed âœ—

**Adya et al. (2000) å½¢å¼åŒ–å®šä¹‰**:

ä½¿ç”¨ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDirect Serialization Graph, DSGï¼‰çš„å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\text{Read Committed} \iff \neg\text{G0} \land \neg\text{G1a} \land \neg\text{G1b} \land \neg\text{G1c}$$

å…¶ä¸­ï¼š

- **G0 (Write Cycles)**: ç¦æ­¢å†™ä¾èµ–ç¯
- **G1a (Aborted Reads)**: ç¦æ­¢è¯»å–å·²ä¸­æ­¢äº‹åŠ¡çš„æ•°æ®
- **G1b (Intermediate Reads)**: ç¦æ­¢è¯»å–ä¸­é—´ç‰ˆæœ¬
- **G1c (Circular Information Flow)**: ç¦æ­¢å¾ªç¯ä¿¡æ¯æµ

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„Read Committedå®ç°åŸºäº**è¯­å¥çº§å¿«ç…§ï¼ˆStatement-Level Snapshotï¼‰**ï¼š

```python
class ReadCommittedTransaction:
    def execute_statement(self, sql):
        # æ¯æ¡è¯­å¥å¼€å§‹æ—¶åˆ›å»ºæ–°å¿«ç…§
        snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),  # å½“å‰è¯­å¥å¼€å§‹æ—¶çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
            xip=get_active_xids()  # å½“å‰æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
        )
        result = execute_with_snapshot(sql, snapshot)
        return result
```

**æœ¬ä½“ç³»å®šä¹‰**:

Read Committedæ˜¯PostgreSQLçš„**é»˜è®¤éš”ç¦»çº§åˆ«**ï¼Œé€šè¿‡MVCCçš„è¯­å¥çº§å¿«ç…§å®ç°ï¼Œä¿è¯ï¼š

- âœ… é˜²æ­¢è„è¯»ï¼ˆP1ï¼‰
- âœ… é˜²æ­¢è„å†™ï¼ˆP0ï¼‰
- âœ— å…è®¸ä¸å¯é‡å¤è¯»ï¼ˆP2ï¼‰
- âœ— å…è®¸å¹»è¯»ï¼ˆP3ï¼‰

---

#### 4.1.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰4.1.1 (Read Committed - Adyaæ¡†æ¶)**:

å¯¹äºäº‹åŠ¡å†å² $H$ï¼ŒRead Committedéš”ç¦»çº§åˆ«æ»¡è¶³ï¼š

$$\forall T_i, T_j \in \text{Committed}(H):$$

1. **é˜²æ­¢è„å†™ (P0)**:
   $$\neg\exists W_i(x) \prec W_j(x) \prec \text{Abort}(T_i)$$

2. **é˜²æ­¢è„è¯» (P1)**:
   $$\neg\exists W_i(x) \prec R_j(x) \prec \text{Abort}(T_i)$$

3. **å…è®¸ä¸å¯é‡å¤è¯» (P2)**:
   $$\exists R_i(x) \prec W_j(x) \prec \text{Commit}(T_j) \prec R_i(x)$$

4. **å…è®¸å¹»è¯» (P3)**:
   $$\exists R_i(\text{range}) \prec \text{Insert}_j(\text{range}) \prec \text{Commit}(T_j) \prec R_i(\text{range})$$

**å¼‚å¸¸ç°è±¡åˆ†æçŸ©é˜µ**:

| å¼‚å¸¸ç°è±¡ | Adyaç¬¦å· | æ˜¯å¦å…è®¸ | è¯´æ˜ |
|---------|---------|---------|------|
| **è„å†™ (Dirty Write)** | P0 | âœ— ç¦æ­¢ | é˜²æ­¢æœªæäº¤çš„å†™æ“ä½œè¦†ç›– |
| **è„è¯» (Dirty Read)** | P1 | âœ— ç¦æ­¢ | é˜²æ­¢è¯»å–æœªæäº¤çš„æ•°æ® |
| **ä¸å¯é‡å¤è¯» (Non-repeatable Read)** | P2 | âœ“ å…è®¸ | åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–å¯èƒ½ä¸åŒ |
| **å¹»è¯» (Phantom Read)** | P3 | âœ“ å…è®¸ | èŒƒå›´æŸ¥è¯¢å¯èƒ½çœ‹åˆ°æ–°è¡Œ |

**ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDSGï¼‰è¡¨ç¤º**:

```text
Read Committedçš„DSGçº¦æŸ:
â”œâ”€ ç¦æ­¢: G0 (å†™ä¾èµ–ç¯)
â”œâ”€ ç¦æ­¢: G1a (è¯»å–å·²ä¸­æ­¢äº‹åŠ¡)
â”œâ”€ ç¦æ­¢: G1b (è¯»å–ä¸­é—´ç‰ˆæœ¬)
â”œâ”€ ç¦æ­¢: G1c (å¾ªç¯ä¿¡æ¯æµ)
â””â”€ å…è®¸: P2, P3 (ä¸å¯é‡å¤è¯»ã€å¹»è¯»)
```

---

#### 4.1.3 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: ANSI SQLæ ‡å‡†é¦–æ¬¡å®šä¹‰Read Committed
   - ä½œä¸ºå››ä¸ªéš”ç¦»çº§åˆ«ä¸­çš„ç¬¬äºŒä¸ªçº§åˆ«
   - åŸºäºé”æœºåˆ¶å®ç°

2. **1980-1990å¹´ä»£**: åŸºäºé”çš„å®ç°æˆç†Ÿ
   - ä½¿ç”¨å…±äº«é”å’Œæ’ä»–é”
   - è¯»æ“ä½œéœ€è¦å…±äº«é”ï¼Œå†™æ“ä½œéœ€è¦æ’ä»–é”

3. **2000å¹´ä»£**: MVCCå®ç°æ™®åŠ
   - PostgreSQLé‡‡ç”¨å¿«ç…§éš”ç¦»å®ç°Read Committed
   - é€šè¿‡è¯­å¥çº§å¿«ç…§é¿å…è„è¯»ï¼Œæ— éœ€è¯»é”

4. **2010å¹´ä»£è‡³ä»Š**: æˆä¸ºå¤§å¤šæ•°æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«
   - å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
   - é€‚åˆå¤§å¤šæ•°OLTPåœºæ™¯

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦Read Committedï¼Ÿ**

1. **é˜²æ­¢è„è¯»çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: å¦‚æœå…è®¸è„è¯»ï¼Œäº‹åŠ¡å¯èƒ½è¯»å–åˆ°æœªæäº¤çš„æ•°æ®
   - **åæœ**: å¦‚æœå†™å…¥äº‹åŠ¡å›æ»šï¼Œè¯»å–äº‹åŠ¡åŸºäºé”™è¯¯æ•°æ®åšå‡ºå†³ç­–
   - **ç¤ºä¾‹**: è½¬è´¦äº‹åŠ¡è¯»å–åˆ°æœªæäº¤çš„ä½™é¢ï¼Œå¯¼è‡´ä½™é¢è®¡ç®—é”™è¯¯

2. **æ€§èƒ½ä¸ä¸€è‡´æ€§çš„å¹³è¡¡**:
   - **Serializable**: æœ€å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½æœ€ä½
   - **Read Uncommitted**: æœ€é«˜æ€§èƒ½ï¼Œä½†å…è®¸è„è¯»ï¼ˆä¸å¯æ¥å—ï¼‰
   - **Read Committed**: å¹³è¡¡ç‚¹ï¼Œé˜²æ­¢è„è¯»ï¼Œæ€§èƒ½å¯æ¥å—

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - å¤§å¤šæ•°Webåº”ç”¨ä¸éœ€è¦å¯é‡å¤è¯»
   - è¯»æœ€æ–°æ•°æ®æ˜¯å¸¸è§éœ€æ±‚
   - çŸ­äº‹åŠ¡åœºæ™¯ä¸‹ï¼Œä¸å¯é‡å¤è¯»å½±å“æœ‰é™

**ç†è®ºä½ç½®**:

```text
éš”ç¦»çº§åˆ«å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ Serializable (æœ€é«˜)
â”‚   â””â”€ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ (P0, P1, P2, P3, P4)
â”‚
â”œâ”€ Repeatable Read
â”‚   â””â”€ é˜²æ­¢ P0, P1, P2, P3
â”‚
â”œâ”€ Read Committed â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é˜²æ­¢ P0, P1
â”‚       â””â”€ å…è®¸ P2, P3
â”‚
â””â”€ Read Uncommitted (æœ€ä½)
    â””â”€ å…è®¸æ‰€æœ‰å¼‚å¸¸
```

**ç†è®ºæ¨å¯¼**:

```text
ä»ä¸šåŠ¡éœ€æ±‚åˆ°Read Committedé€‰æ‹©çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: é˜²æ­¢è„è¯»ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: è¯»æœ€æ–°æ•°æ®ï¼ˆå¸¸è§ï¼‰
   â””â”€ éœ€æ±‚: é«˜å¹¶å‘æ€§èƒ½ï¼ˆé‡è¦ï¼‰

2. éš”ç¦»çº§åˆ«ç­›é€‰
   â”œâ”€ Read Uncommitted: âœ— å…è®¸è„è¯»ï¼ˆä¸æ»¡è¶³éœ€æ±‚1ï¼‰
   â”œâ”€ Read Committed: âœ“ é˜²æ­¢è„è¯»ï¼Œå…è®¸è¯»æœ€æ–°ï¼ˆæ»¡è¶³éœ€æ±‚1,2ï¼‰
   â”œâ”€ Repeatable Read: âš ï¸ é˜²æ­¢è„è¯»ï¼Œä½†è¯»å†å²æ•°æ®ï¼ˆä¸æ»¡è¶³éœ€æ±‚2ï¼‰
   â””â”€ Serializable: âš ï¸ é˜²æ­¢è„è¯»ï¼Œä½†æ€§èƒ½ä½ï¼ˆä¸æ»¡è¶³éœ€æ±‚3ï¼‰

3. ç»“è®º
   â””â”€ é€‰æ‹©Read Committed âœ“
```

---

#### 4.1.4 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: Webåº”ç”¨ç”¨æˆ·ä½™é¢æŸ¥è¯¢**

```sql
-- åœºæ™¯: ç”¨æˆ·æŸ¥è¯¢è´¦æˆ·ä½™é¢
-- éœ€æ±‚: çœ‹åˆ°æœ€æ–°ä½™é¢ï¼Œä¸éœ€è¦å¯é‡å¤è¯»

-- ä¼šè¯A (ç”¨æˆ·æŸ¥è¯¢)
BEGIN;  -- é»˜è®¤Read Committed
SELECT balance FROM accounts WHERE user_id = 123;
-- è¿”å›: 1000 (æœ€æ–°æäº¤çš„ä½™é¢)

-- ä¼šè¯B (åå°æ‰£æ¬¾)
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE user_id = 123;
COMMIT;  -- ä½™é¢å˜ä¸º950

-- ä¼šè¯A (ç”¨æˆ·å†æ¬¡æŸ¥è¯¢)
SELECT balance FROM accounts WHERE user_id = 123;
-- è¿”å›: 950 (çœ‹åˆ°æœ€æ–°ä½™é¢) âœ“ ç¬¦åˆä¸šåŠ¡éœ€æ±‚
COMMIT;
```

**åˆ†æ**:

- âœ… é˜²æ­¢è„è¯»ï¼šä¸ä¼šè¯»å–åˆ°æœªæäº¤çš„æ‰£æ¬¾
- âœ… è¯»æœ€æ–°æ•°æ®ï¼šç”¨æˆ·çœ‹åˆ°æœ€æ–°çš„ä½™é¢
- âœ… æ€§èƒ½ä¼˜ç§€ï¼šæ— éœ€äº‹åŠ¡çº§å¿«ç…§ï¼Œå¼€é”€ä½

**æ­£ä¾‹2: APIæœåŠ¡è®¢å•çŠ¶æ€æŸ¥è¯¢**

```sql
-- åœºæ™¯: APIæŸ¥è¯¢è®¢å•çŠ¶æ€
-- éœ€æ±‚: å®æ—¶çŠ¶æ€ï¼Œä¸éœ€è¦å¯é‡å¤è¯»

-- ä¼šè¯A (APIæŸ¥è¯¢)
BEGIN;
SELECT status FROM orders WHERE order_id = 456;
-- è¿”å›: 'pending'

-- ä¼šè¯B (è®¢å•å¤„ç†)
BEGIN;
UPDATE orders SET status = 'shipped' WHERE order_id = 456;
COMMIT;

-- ä¼šè¯A (APIå†æ¬¡æŸ¥è¯¢)
SELECT status FROM orders WHERE order_id = 456;
-- è¿”å›: 'shipped' (çœ‹åˆ°æœ€æ–°çŠ¶æ€) âœ“ ç¬¦åˆä¸šåŠ¡éœ€æ±‚
COMMIT;
```

**åˆ†æ**:

- âœ… é˜²æ­¢è„è¯»ï¼šä¸ä¼šè¯»å–åˆ°æœªæäº¤çš„çŠ¶æ€å˜æ›´
- âœ… è¯»æœ€æ–°æ•°æ®ï¼šAPIè¿”å›æœ€æ–°çš„è®¢å•çŠ¶æ€
- âœ… é€‚åˆçŸ­äº‹åŠ¡ï¼šAPIæŸ¥è¯¢é€šå¸¸æ˜¯çŸ­äº‹åŠ¡

---

**åä¾‹åˆ†æ**:

**åä¾‹1: é‡‘èç³»ç»Ÿä½™é¢è®¡ç®—é”™è¯¯**

```sql
-- é”™è¯¯åœºæ™¯: ä½¿ç”¨Read Committedè¿›è¡Œä½™é¢æ±‡æ€»
-- é—®é¢˜: ä¸å¯é‡å¤è¯»å¯¼è‡´ä½™é¢è®¡ç®—é”™è¯¯

-- ä¼šè¯A (ä½™é¢æ±‡æ€»äº‹åŠ¡)
BEGIN;
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
-- è¿”å›: 5000 (è´¦æˆ·1: 2000, è´¦æˆ·2: 3000)

-- ä¼šè¯B (è½¬è´¦äº‹åŠ¡)
BEGIN;
UPDATE accounts SET balance = balance - 1000 WHERE id = 1;  -- è´¦æˆ·1: 2000 â†’ 1000
UPDATE accounts SET balance = balance + 1000 WHERE id = 2;  -- è´¦æˆ·2: 3000 â†’ 4000
COMMIT;

-- ä¼šè¯A (å†æ¬¡æ±‡æ€»)
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
-- è¿”å›: 5000 (è´¦æˆ·1: 1000, è´¦æˆ·2: 4000) âœ“ æ€»å’Œä»ä¸º5000
-- ä½†: å¦‚æœåªæŸ¥è¯¢è´¦æˆ·1ï¼Œä¼šçœ‹åˆ°ä¸åŒçš„å€¼ï¼ˆä¸å¯é‡å¤è¯»ï¼‰

-- å¦‚æœä¸šåŠ¡éœ€è¦: ä¸¤æ¬¡æŸ¥è¯¢å¿…é¡»çœ‹åˆ°ç›¸åŒçš„è´¦æˆ·ä½™é¢
-- åˆ™: Read Committedä¸æ»¡è¶³éœ€æ±‚ âœ—
```

**é”™è¯¯åŸå› **:

- Read Committedå…è®¸ä¸å¯é‡å¤è¯»
- åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢åŒä¸€æ•°æ®å¯èƒ½çœ‹åˆ°ä¸åŒå€¼
- å¯¹äºéœ€è¦ä¸€è‡´æ€§å¿«ç…§çš„ä¸šåŠ¡ï¼Œè¿™æ˜¯é”™è¯¯çš„

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Repeatable Read
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
-- è¿”å›: 5000

-- å³ä½¿å…¶ä»–äº‹åŠ¡ä¿®æ”¹å¹¶æäº¤ï¼Œå†æ¬¡æŸ¥è¯¢ä»è¿”å›5000 âœ“
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
-- ä»è¿”å›: 5000 (äº‹åŠ¡çº§å¿«ç…§ä¿è¯)
COMMIT;
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: å¦‚æœä¸šåŠ¡é€»è¾‘ä¾èµ–å¯é‡å¤è¯»ï¼Œå¯èƒ½å¯¼è‡´è®¡ç®—é”™è¯¯
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: åŸºäºä¸ä¸€è‡´çš„æ•°æ®åšå‡ºé”™è¯¯å†³ç­–
- **æ€§èƒ½å½±å“**: æ— ï¼ˆä½†åŠŸèƒ½é”™è¯¯ï¼‰

---

**åä¾‹2: æŠ¥è¡¨ç”Ÿæˆæ•°æ®ä¸ä¸€è‡´**

```sql
-- é”™è¯¯åœºæ™¯: ä½¿ç”¨Read Committedç”ŸæˆæŠ¥è¡¨
-- é—®é¢˜: ä¸å¯é‡å¤è¯»å¯¼è‡´æŠ¥è¡¨æ•°æ®ä¸ä¸€è‡´

-- ä¼šè¯A (æŠ¥è¡¨ç”Ÿæˆ)
BEGIN;
-- æŸ¥è¯¢1: ç»Ÿè®¡è®¢å•æ€»æ•°
SELECT COUNT(*) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: 1000

-- ä¼šè¯B (æ–°è®¢å•)
BEGIN;
INSERT INTO orders VALUES (...);
COMMIT;  -- è®¢å•æ•°å˜ä¸º1001

-- ä¼šè¯A (æŸ¥è¯¢2: ç»Ÿè®¡è®¢å•é‡‘é¢)
SELECT SUM(amount) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: åŸºäº1001ä¸ªè®¢å•çš„é‡‘é¢

-- é—®é¢˜: è®¢å•æ€»æ•°å’Œè®¢å•é‡‘é¢åŸºäºä¸åŒçš„æ•°æ®å¿«ç…§
-- ç»“æœ: æŠ¥è¡¨æ•°æ®ä¸ä¸€è‡´ âœ—
```

**é”™è¯¯åŸå› **:

- Read Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§
- ä¸åŒè¯­å¥çœ‹åˆ°ä¸åŒçš„æ•°æ®åº“çŠ¶æ€
- å¯¹äºéœ€è¦ä¸€è‡´æ€§å¿«ç…§çš„æŠ¥è¡¨ï¼Œè¿™æ˜¯é”™è¯¯çš„

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Repeatable Read
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: 1000

-- å³ä½¿æœ‰æ–°è®¢å•æ’å…¥ï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½åŸºäºåŒä¸€å¿«ç…§
SELECT SUM(amount) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: åŸºäº1000ä¸ªè®¢å•çš„é‡‘é¢ âœ“ æ•°æ®ä¸€è‡´
COMMIT;
```

**åæœåˆ†æ**:

- **æ•°æ®ä¸ä¸€è‡´**: æŠ¥è¡¨ä¸­çš„ä¸åŒæŒ‡æ ‡åŸºäºä¸åŒçš„æ•°æ®å¿«ç…§
- **ä¸šåŠ¡å†³ç­–é”™è¯¯**: åŸºäºä¸ä¸€è‡´çš„æŠ¥è¡¨åšå‡ºé”™è¯¯å†³ç­–
- **æ€§èƒ½å½±å“**: æ— ï¼ˆä½†æ•°æ®è´¨é‡é”™è¯¯ï¼‰

---

**åä¾‹3: é«˜å¹¶å‘åœºæ™¯é”™è¯¯é€‰æ‹©Serializable**

```sql
-- é”™è¯¯åœºæ™¯: é«˜å¹¶å‘Webåº”ç”¨ä½¿ç”¨Serializable
-- é—®é¢˜: æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼Œä¸­æ­¢ç‡è¿‡é«˜

-- é…ç½®é”™è¯¯
SET default_transaction_isolation = 'serializable';

-- å®é™…è¿è¡Œ
-- TPS: ä»50,000é™åˆ°5,000 (ä¸‹é™90%) âœ—
-- ä¸­æ­¢ç‡: ä»1%å‡åˆ°35% âœ—
-- å»¶è¿Ÿ: ä»10mså‡åˆ°200ms âœ—
```

**é”™è¯¯åŸå› **:

- Serializableéœ€è¦æ£€æµ‹æ‰€æœ‰è¯»å†™ä¾èµ–
- é«˜å¹¶å‘æ—¶ä¾èµ–å›¾æ£€æµ‹å¼€é”€å·¨å¤§
- ä¸­æ­¢ç‡éšå¹¶å‘åº¦æŒ‡æ•°å¢é•¿

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Read Committed
SET default_transaction_isolation = 'read committed';

-- å®é™…è¿è¡Œ
-- TPS: 50,000 âœ“
-- ä¸­æ­¢ç‡: 1% âœ“
-- å»¶è¿Ÿ: 10ms âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½å´©æºƒ**: TPSä¸‹é™90%
- **ç”¨æˆ·ä½“éªŒå·®**: å»¶è¿Ÿå¢åŠ 20å€
- **ç³»ç»Ÿä¸ç¨³å®š**: é«˜ä¸­æ­¢ç‡å¯¼è‡´å¤§é‡é‡è¯•

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: Webåº”ç”¨ç”¨æˆ·æŸ¥è¯¢**

**åœºæ™¯æè¿°**:

- ç”¨æˆ·é€šè¿‡Webç•Œé¢æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯
- éœ€è¦çœ‹åˆ°æœ€æ–°çš„æ•°æ®
- é«˜å¹¶å‘åœºæ™¯ï¼ˆ1000+ QPSï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦Read Committed**:

- âœ… é˜²æ­¢è„è¯»ï¼šä¸ä¼šçœ‹åˆ°æœªæäº¤çš„é”™è¯¯æ•°æ®
- âœ… è¯»æœ€æ–°æ•°æ®ï¼šç”¨æˆ·æœŸæœ›çœ‹åˆ°æœ€æ–°çŠ¶æ€
- âœ… é«˜æ€§èƒ½ï¼šè¯­å¥çº§å¿«ç…§å¼€é”€ä½

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLé»˜è®¤å°±æ˜¯Read Committedï¼Œæ— éœ€è®¾ç½®
BEGIN;
SELECT * FROM accounts WHERE user_id = 123;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **æ€§èƒ½**: TPS = 50,000
- **å»¶è¿Ÿ**: P50 = 10ms, P99 = 50ms
- **ä¸€è‡´æ€§**: é˜²æ­¢è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»ï¼ˆå¯æ¥å—ï¼‰

---

**åœºæ™¯2: APIæœåŠ¡å®æ—¶æ•°æ®æŸ¥è¯¢**

**åœºæ™¯æè¿°**:

- RESTful APIæä¾›å®æ—¶æ•°æ®æŸ¥è¯¢
- å¤šä¸ªæœåŠ¡å¹¶å‘æŸ¥è¯¢å’Œæ›´æ–°
- éœ€è¦ä½å»¶è¿Ÿå“åº”

**ä¸ºä»€ä¹ˆéœ€è¦Read Committed**:

- âœ… é˜²æ­¢è„è¯»ï¼šAPIä¸ä¼šè¿”å›æœªæäº¤çš„æ•°æ®
- âœ… è¯»æœ€æ–°æ•°æ®ï¼šAPIè¿”å›æœ€æ–°çŠ¶æ€
- âœ… ä½å»¶è¿Ÿï¼šè¯­å¥çº§å¿«ç…§ï¼Œå»¶è¿Ÿä½

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- APIæŸ¥è¯¢ï¼ˆé»˜è®¤Read Committedï¼‰
BEGIN;
SELECT status, amount FROM orders WHERE order_id = 456;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **æ€§èƒ½**: QPS = 10,000+
- **å»¶è¿Ÿ**: P50 = 5ms, P99 = 30ms
- **ä¸€è‡´æ€§**: é˜²æ­¢è„è¯»ï¼Œæ»¡è¶³APIéœ€æ±‚

---

**åœºæ™¯3: é«˜å¹¶å‘å†™å…¥ç³»ç»Ÿ**

**åœºæ™¯æè¿°**:

- ç§’æ€ç³»ç»Ÿã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰
- é«˜å¹¶å‘å†™å…¥ï¼ˆ10,000+ TPSï¼‰
- è¯»æ“ä½œéœ€è¦çœ‹åˆ°æœ€æ–°æ•°æ®

**ä¸ºä»€ä¹ˆéœ€è¦Read Committed**:

- âœ… é˜²æ­¢è„è¯»ï¼šè¯»æ“ä½œä¸ä¼šçœ‹åˆ°æœªæäº¤çš„å†™å…¥
- âœ… é«˜æ€§èƒ½ï¼šè¯­å¥çº§å¿«ç…§ï¼Œå¼€é”€ä½
- âœ… å†™æ€§èƒ½å¥½ï¼šå†™æ“ä½œåªéœ€è¡Œé”ï¼Œæ— è°“è¯é”

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ç§’æ€æ‰£åº“å­˜ï¼ˆé»˜è®¤Read Committedï¼‰
BEGIN;
SELECT stock FROM products WHERE id = 789;
-- å¦‚æœstock > 0ï¼Œåˆ™æ‰£å‡
UPDATE products SET stock = stock - 1 WHERE id = 789;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **æ€§èƒ½**: TPS = 50,000+
- **å»¶è¿Ÿ**: P50 = 8ms, P99 = 40ms
- **ä¸€è‡´æ€§**: é˜²æ­¢è„è¯»ï¼Œæ»¡è¶³é«˜å¹¶å‘éœ€æ±‚

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»ä¸šåŠ¡éœ€æ±‚åˆ°Read Committedé€‰æ‹©**

```text
å‰æ1: ä¸šåŠ¡éœ€æ±‚æ˜¯é˜²æ­¢è„è¯»ï¼ˆå¿…é¡»ï¼‰
å‰æ2: ä¸šåŠ¡éœ€æ±‚æ˜¯è¯»æœ€æ–°æ•°æ®ï¼ˆå¸¸è§ï¼‰
å‰æ3: ä¸šåŠ¡éœ€æ±‚æ˜¯é«˜å¹¶å‘æ€§èƒ½ï¼ˆé‡è¦ï¼‰

æ¨ç†æ­¥éª¤1: æ’é™¤Read Uncommittedï¼ˆå…è®¸è„è¯»ï¼Œä¸æ»¡è¶³å‰æ1ï¼‰
æ¨ç†æ­¥éª¤2: æ’é™¤Repeatable Readï¼ˆè¯»å†å²æ•°æ®ï¼Œä¸æ»¡è¶³å‰æ2ï¼‰
æ¨ç†æ­¥éª¤3: æ’é™¤Serializableï¼ˆæ€§èƒ½ä½ï¼Œä¸æ»¡è¶³å‰æ3ï¼‰

ç»“è®º: é€‰æ‹©Read Committed âœ“
```

**æ¨ç†é“¾æ¡2: ä»Read Committedåˆ°å¼‚å¸¸ç°è±¡çš„æ¨ç†**

```text
å‰æ1: Read Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§
å‰æ2: æ¯æ¡è¯­å¥çœ‹åˆ°æ•°æ®åº“åœ¨è¯­å¥å¼€å§‹æ—¶çš„çŠ¶æ€
å‰æ3: ä¸åŒè¯­å¥å¯èƒ½çœ‹åˆ°ä¸åŒçš„æ•°æ®åº“çŠ¶æ€

æ¨ç†æ­¥éª¤1: è¯­å¥å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼ŒåŒ…å«æ‰€æœ‰å·²æäº¤äº‹åŠ¡
æ¨ç†æ­¥éª¤2: å¦‚æœäº‹åŠ¡T1åœ¨è¯­å¥1å’Œè¯­å¥2ä¹‹é—´æäº¤ï¼Œè¯­å¥2ä¼šçœ‹åˆ°T1çš„ä¿®æ”¹
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢å¯èƒ½çœ‹åˆ°ä¸åŒç»“æœ

ç»“è®º: Read Committedå…è®¸ä¸å¯é‡å¤è¯»ï¼ˆP2ï¼‰âœ“
```

**æ¨ç†é“¾æ¡3: ä»Read Committedåˆ°æ€§èƒ½å½±å“çš„æ¨ç†**

```text
å‰æ1: Read Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§
å‰æ2: å¿«ç…§åˆ›å»ºå¼€é”€ = O(N_active)
å‰æ3: äº‹åŠ¡çº§å¿«ç…§éœ€è¦åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´ç»´æŠ¤

æ¨ç†æ­¥éª¤1: è¯­å¥çº§å¿«ç…§åœ¨è¯­å¥ç»“æŸæ—¶å³å¯é‡Šæ”¾
æ¨ç†æ­¥éª¤2: äº‹åŠ¡çº§å¿«ç…§éœ€è¦åœ¨äº‹åŠ¡æœŸé—´ä¸€ç›´ç»´æŠ¤
æ¨ç†æ­¥éª¤3: è¯­å¥çº§å¿«ç…§çš„å†…å­˜å’ŒCPUå¼€é”€æ›´ä½

ç»“è®º: Read Committedæ€§èƒ½ä¼˜äºRepeatable Read âœ“
```

---

#### 4.1.5 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - Read Committedé€šè¿‡è¯­å¥çº§å¿«ç…§æ§åˆ¶å¯è§æ€§
   - æ¯æ¡è¯­å¥çš„å¯è§æ€§åˆ¤æ–­åŸºäºè¯­å¥å¼€å§‹æ—¶çš„å¿«ç…§
   - å¯è§æ€§è§„åˆ™ï¼š`Visible(tuple, snapshot) = (tuple.xmin < snapshot.xmax) âˆ§ (tuple.xmin âˆ‰ snapshot.xip)`

2. **ä¸å¿«ç…§çš„å…³ç³»**:
   - Read Committedä½¿ç”¨**è¯­å¥çº§å¿«ç…§**
   - æ¯æ¡è¯­å¥å¼€å§‹æ—¶åˆ›å»ºæ–°å¿«ç…§
   - å¿«ç…§åŒ…å«ï¼š`(xmin, xmax, xip)`

3. **ä¸MVCCå®ç°çš„å…³ç³»**:
   - Read Committedæ˜¯MVCCçš„ä¸€ä¸ªåº”ç”¨
   - é€šè¿‡ç‰ˆæœ¬é“¾å’Œå¯è§æ€§åˆ¤æ–­å®ç°
   - æ— éœ€è¯»é”ï¼Œå†™æ“ä½œä½¿ç”¨è¡Œé”

4. **ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:
   - Read Committedæ˜¯å››ä¸ªéš”ç¦»çº§åˆ«ä¸­çš„ç¬¬äºŒä¸ª
   - æ¯”Read Uncommittedå¼ºï¼ˆé˜²æ­¢è„è¯»ï¼‰
   - æ¯”Repeatable Readå¼±ï¼ˆå…è®¸ä¸å¯é‡å¤è¯»ï¼‰

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL MVCCå®ç°
   - è¯­å¥çº§å¿«ç…§åˆ›å»º
   - ç‰ˆæœ¬é“¾éå†
   - å¯è§æ€§åˆ¤æ–­

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - Read Committed â‰ˆ æ¯æ¬¡è¯»å–è·å–æ–°çš„ä¸å¯å˜å¼•ç”¨
   - è¯­å¥çº§å¿«ç…§ â‰ˆ ä½œç”¨åŸŸçº§åˆ«çš„å€Ÿç”¨

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - Read Committed â‰ˆ å› æœä¸€è‡´æ€§ï¼ˆCausal Consistencyï¼‰
   - è¯­å¥çº§å¿«ç…§ â‰ˆ å‘é‡æ—¶é’Ÿçš„å¿«ç…§ç‚¹

**å®ç°ç»†èŠ‚**:

**PostgreSQLæºç çº§åˆ†æ**:

```c
// src/backend/access/heap/heapam_visibility.c

// è¯­å¥å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
Snapshot GetSnapshotData(Snapshot snapshot)
{
    // è·å–å½“å‰æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    xip = GetActiveTransactionIds();

    // è®¾ç½®å¿«ç…§è¾¹ç•Œ
    snapshot->xmin = GetOldestXmin();
    snapshot->xmax = GetNextTransactionId();
    snapshot->xip = xip;

    return snapshot;
}

// æ¯æ¡è¯­å¥æ‰§è¡Œæ—¶ä½¿ç”¨æ–°å¿«ç…§
void ExecutorRun(QueryDesc *queryDesc, ...)
{
    // è¯­å¥å¼€å§‹æ—¶è·å–æ–°å¿«ç…§
    PushActiveSnapshot(GetSnapshotData(...));

    // æ‰§è¡ŒæŸ¥è¯¢
    standard_ExecutorRun(queryDesc, ...);

    // è¯­å¥ç»“æŸæ—¶é‡Šæ”¾å¿«ç…§
    PopActiveSnapshot();
}
```

**æ€§èƒ½å½±å“**:

1. **å¿«ç…§åˆ›å»ºå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå…¶ä¸­ $N_{active}$ æ˜¯æ´»è·ƒäº‹åŠ¡æ•°
   - ç©ºé—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 1-5Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°ï¼‰

2. **å¯è§æ€§åˆ¤æ–­å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(\log N_{active})$ï¼ŒäºŒåˆ†æŸ¥æ‰¾æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 0.1-0.5Î¼s

3. **æ€»ä½“æ€§èƒ½**:
   - è¯»æ“ä½œ: æ— é”ï¼Œæ€§èƒ½é«˜
   - å†™æ“ä½œ: è¡Œé”ï¼Œæ€§èƒ½ä¸­ç­‰
   - æ€»ä½“TPS: 50,000+ï¼ˆå…¸å‹é…ç½®ï¼‰

---

#### 4.1.6 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**è¯»æ“ä½œæ€§èƒ½**:

$$T_{read} = T_{snapshot} + T_{scan} + T_{visibility}$$

å…¶ä¸­ï¼š

- $T_{snapshot} = O(N_{active})$ - å¿«ç…§åˆ›å»ºæ—¶é—´
- $T_{scan}$ - ç´¢å¼•/è¡¨æ‰«ææ—¶é—´
- $T_{visibility} = O(\log N_{active})$ - å¯è§æ€§åˆ¤æ–­æ—¶é—´

**å†™æ“ä½œæ€§èƒ½**:

$$T_{write} = T_{lock} + T_{insert} + T_{wal}$$

å…¶ä¸­ï¼š

- $T_{lock}$ - è¡Œé”è·å–æ—¶é—´ï¼ˆå†™å†™å†²çªæ—¶å¢åŠ ï¼‰
- $T_{insert}$ - å…ƒç»„æ’å…¥æ—¶é—´
- $T_{wal}$ - WALå†™å…¥æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºTPC-CåŸºå‡†æµ‹è¯•):

| æŒ‡æ ‡ | Read Committed | è¯´æ˜ |
|------|---------------|------|
| **TPS** | 125,000 | 100å¹¶å‘è¿æ¥ |
| **P50å»¶è¿Ÿ** | 12ms | å¹³å‡å»¶è¿Ÿ |
| **P95å»¶è¿Ÿ** | 35ms | 95%è¯·æ±‚å»¶è¿Ÿ |
| **P99å»¶è¿Ÿ** | 65ms | 99%è¯·æ±‚å»¶è¿Ÿ |
| **ä¸­æ­¢ç‡** | 0.2% | æä½ |
| **CPUä½¿ç”¨ç‡** | 78% | ä¸­ç­‰ |
| **é”ç­‰å¾…ç‡** | 1.2% | ä½ |

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘æ´»è·ƒäº‹åŠ¡æ•°**:
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´
   - é¿å…é•¿äº‹åŠ¡
   - ä½¿ç”¨è¿æ¥æ± é™åˆ¶å¹¶å‘

2. **ä¼˜åŒ–å¿«ç…§åˆ›å»º**:
   - ä½¿ç”¨å¿«ç…§ç¼“å­˜ï¼ˆPostgreSQLè‡ªåŠ¨ä¼˜åŒ–ï¼‰
   - å‡å°‘äº‹åŠ¡IDåˆ†é…å¼€é”€

3. **ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­**:
   - ä½¿ç”¨Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
   - ä¼˜åŒ–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨çš„å­˜å‚¨ç»“æ„

---

#### 4.1.7 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: Read Committedé˜²æ­¢è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»å’Œå¹»è¯»
2. **å®ç°**: PostgreSQLé€šè¿‡è¯­å¥çº§å¿«ç…§å®ç°
3. **æ€§èƒ½**: é«˜æ€§èƒ½ï¼Œé€‚åˆå¤§å¤šæ•°OLTPåœºæ™¯
4. **åº”ç”¨**: Webåº”ç”¨ã€APIæœåŠ¡ã€é«˜å¹¶å‘ç³»ç»Ÿ

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºRead Committedä¿è¯å¯é‡å¤è¯»
   - **é”™è¯¯**: Read Committedå…è®¸ä¸å¯é‡å¤è¯»
   - **æ­£ç¡®**: éœ€è¦å¯é‡å¤è¯»æ—¶ä½¿ç”¨Repeatable Read

2. **è¯¯åŒº2**: è®¤ä¸ºRead Committedæ€§èƒ½ä½
   - **é”™è¯¯**: Read Committedæ˜¯é«˜æ€§èƒ½éš”ç¦»çº§åˆ«
   - **æ­£ç¡®**: Read Committedæ€§èƒ½ä¼˜äºRepeatable Readå’ŒSerializable

3. **è¯¯åŒº3**: è®¤ä¸ºæ‰€æœ‰åœºæ™¯éƒ½åº”è¯¥ä½¿ç”¨Read Committed
   - **é”™è¯¯**: éœ€è¦å¯é‡å¤è¯»çš„åœºæ™¯åº”è¯¥ä½¿ç”¨Repeatable Read
   - **æ­£ç¡®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©éš”ç¦»çº§åˆ«

**æœ€ä½³å®è·µ**:

1. **é»˜è®¤é€‰æ‹©**: å¤§å¤šæ•°åœºæ™¯ä½¿ç”¨Read Committedä½œä¸ºé»˜è®¤éš”ç¦»çº§åˆ«
2. **æ˜ç¡®éœ€æ±‚**: æ˜ç¡®ä¸šåŠ¡æ˜¯å¦éœ€è¦å¯é‡å¤è¯»
3. **æ€§èƒ½æµ‹è¯•**: åœ¨å®é™…è´Ÿè½½ä¸‹æµ‹è¯•éš”ç¦»çº§åˆ«çš„æ€§èƒ½
4. **ç›‘æ§æŒ‡æ ‡**: ç›‘æ§TPSã€å»¶è¿Ÿã€ä¸­æ­¢ç‡ç­‰æŒ‡æ ‡

---

**å¿«ç…§ç­–ç•¥**: **è¯­å¥çº§å¿«ç…§**

```python
class ReadCommittedTransaction:
    def execute_statement(self, sql):
        snapshot = get_current_snapshot()  # æ¯æ¡è¯­å¥è·å–æ–°å¿«ç…§
        result = execute_with_snapshot(sql, snapshot)
        return result
```

**å…è®¸çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: åŒä¸€æŸ¥è¯¢è¿”å›ä¸åŒç»“æœ
- âœ… **å¹»è¯»**: èŒƒå›´æŸ¥è¯¢å‡ºç°æ–°è¡Œ

**ç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡å†…)
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 200 (ä¸å¯é‡å¤è¯»)
```

### 4.2 Repeatable Read (å¯é‡å¤è¯»)

#### 4.2.1 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> Repeatable Read is an isolation level that guarantees that if a transaction reads the same row multiple times, it will see the same data each time, even if other transactions modify or delete the data in the meantime. This prevents both dirty reads and non-repeatable reads. However, phantom reads can still occur according to the ANSI SQL standard.

**ANSI SQLæ ‡å‡†å®šä¹‰** (SQL:2016):

> Repeatable Read isolation level ensures that:
>
> - **P0 (Dirty Write)**: Prevented âœ“
> - **P1 (Dirty Read)**: Prevented âœ“
> - **P2 (Non-repeatable Read)**: Prevented âœ“
> - **P3 (Phantom Read)**: Allowed âœ— (ä½†PostgreSQLæ‰©å±•é˜²æ­¢å¹»è¯»)

**Adya et al. (2000) å½¢å¼åŒ–å®šä¹‰**:

ä½¿ç”¨ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDirect Serialization Graph, DSGï¼‰çš„å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\text{Repeatable Read} \iff \neg\text{G0} \land \neg\text{G1a} \land \neg\text{G1b} \land \neg\text{G1c} \land \neg\text{P2}$$

å…¶ä¸­ï¼š

- **G0, G1a, G1b, G1c**: åŒRead Committed
- **P2 (Non-repeatable Read)**: ç¦æ­¢ä¸å¯é‡å¤è¯»

**å¿«ç…§éš”ç¦» (Snapshot Isolation) å®šä¹‰**:

PostgreSQLçš„Repeatable Readå®ç°åŸºäº**å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolation, SIï¼‰**ï¼Œè¿™æ˜¯ç”±Berenson et al. (1995) é¦–æ¬¡å½¢å¼åŒ–å®šä¹‰çš„éš”ç¦»çº§åˆ«ï¼š

> æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªä¸€è‡´å¿«ç…§ï¼Œè¯¥å¿«ç…§åœ¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºã€‚è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¸é˜»å¡è¯»æ“ä½œã€‚

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„Repeatable Readå®ç°åŸºäº**äº‹åŠ¡çº§å¿«ç…§ï¼ˆTransaction-Level Snapshotï¼‰**ï¼š

```python
class RepeatableReadTransaction:
    def __init__(self):
        # äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´ä¿æŒä¸å˜
        self.snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),  # äº‹åŠ¡å¼€å§‹æ—¶çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡ID
            xip=get_active_xids()  # äº‹åŠ¡å¼€å§‹æ—¶çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
        )

    def execute_statement(self, sql):
        # æ‰€æœ‰è¯­å¥ä½¿ç”¨åŒä¸€å¿«ç…§
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**æœ¬ä½“ç³»å®šä¹‰**:

Repeatable Readé€šè¿‡MVCCçš„äº‹åŠ¡çº§å¿«ç…§å®ç°ï¼Œä¿è¯ï¼š

- âœ… é˜²æ­¢è„è¯»ï¼ˆP1ï¼‰
- âœ… é˜²æ­¢è„å†™ï¼ˆP0ï¼‰
- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼ˆP2ï¼‰
- âœ… é˜²æ­¢å¹»è¯»ï¼ˆP3ï¼‰- **PostgreSQLæ‰©å±•**ï¼ˆæ ‡å‡†ANSI SQLå…è®¸å¹»è¯»ï¼‰

**PostgreSQLæ‰©å±•è¯´æ˜**:

PostgreSQLçš„Repeatable Readå®ç°æ¯”ANSI SQLæ ‡å‡†æ›´ä¸¥æ ¼ï¼š

- **ANSIæ ‡å‡†**: å…è®¸å¹»è¯»ï¼ˆP3ï¼‰
- **PostgreSQL**: é€šè¿‡äº‹åŠ¡çº§å¿«ç…§é˜²æ­¢å¹»è¯»ï¼ˆP3ï¼‰

è¿™æ˜¯å› ä¸ºPostgreSQLä½¿ç”¨å¿«ç…§éš”ç¦»å®ç°Repeatable Readï¼Œè€Œå¿«ç…§éš”ç¦»å¤©ç„¶é˜²æ­¢å¹»è¯»ã€‚

---

#### 4.2.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰4.2.1 (Repeatable Read - Adyaæ¡†æ¶)**:

å¯¹äºäº‹åŠ¡å†å² $H$ï¼ŒRepeatable Readéš”ç¦»çº§åˆ«æ»¡è¶³ï¼š

$$\forall T_i, T_j \in \text{Committed}(H):$$

1. **é˜²æ­¢è„å†™ (P0)**:
   $$\neg\exists W_i(x) \prec W_j(x) \prec \text{Abort}(T_i)$$

2. **é˜²æ­¢è„è¯» (P1)**:
   $$\neg\exists W_i(x) \prec R_j(x) \prec \text{Abort}(T_i)$$

3. **é˜²æ­¢ä¸å¯é‡å¤è¯» (P2)**:
   $$\neg\exists R_i(x) \prec W_j(x) \prec \text{Commit}(T_j) \prec R_i(x)$$

4. **é˜²æ­¢å¹»è¯» (P3) - PostgreSQLæ‰©å±•**:
   $$\neg\exists R_i(\text{range}) \prec \text{Insert}_j(\text{range}) \prec \text{Commit}(T_j) \prec R_i(\text{range})$$

**å¿«ç…§éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰** (Berenson et al., 1995):

$$\text{Snapshot Isolation} \iff$$

$$\forall T_i: \text{Snapshot}(T_i) = \text{DatabaseState}(\text{StartTime}(T_i)) \land$$

$$\forall T_i, T_j: \text{FirstCommitWins}(T_i, T_j)$$

å…¶ä¸­ï¼š

- $\text{Snapshot}(T_i)$: äº‹åŠ¡$T_i$çœ‹åˆ°çš„å¿«ç…§
- $\text{StartTime}(T_i)$: äº‹åŠ¡$T_i$çš„å¼€å§‹æ—¶é—´
- $\text{FirstCommitWins}$: å…ˆæäº¤è€…è·èƒœï¼ˆå†™å†™å†²çªæ£€æµ‹ï¼‰

**å¼‚å¸¸ç°è±¡åˆ†æçŸ©é˜µ**:

| å¼‚å¸¸ç°è±¡ | Adyaç¬¦å· | æ˜¯å¦å…è®¸ | è¯´æ˜ |
|---------|---------|---------|------|
| **è„å†™ (Dirty Write)** | P0 | âœ— ç¦æ­¢ | é˜²æ­¢æœªæäº¤çš„å†™æ“ä½œè¦†ç›– |
| **è„è¯» (Dirty Read)** | P1 | âœ— ç¦æ­¢ | é˜²æ­¢è¯»å–æœªæäº¤çš„æ•°æ® |
| **ä¸å¯é‡å¤è¯» (Non-repeatable Read)** | P2 | âœ— ç¦æ­¢ | åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´ |
| **å¹»è¯» (Phantom Read)** | P3 | âœ— ç¦æ­¢ | PostgreSQLæ‰©å±•ï¼ˆæ ‡å‡†å…è®¸ï¼‰ |

**ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDSGï¼‰è¡¨ç¤º**:

```text
Repeatable Readçš„DSGçº¦æŸ:
â”œâ”€ ç¦æ­¢: G0 (å†™ä¾èµ–ç¯)
â”œâ”€ ç¦æ­¢: G1a (è¯»å–å·²ä¸­æ­¢äº‹åŠ¡)
â”œâ”€ ç¦æ­¢: G1b (è¯»å–ä¸­é—´ç‰ˆæœ¬)
â”œâ”€ ç¦æ­¢: G1c (å¾ªç¯ä¿¡æ¯æµ)
â”œâ”€ ç¦æ­¢: P2 (ä¸å¯é‡å¤è¯»)
â””â”€ ç¦æ­¢: P3 (å¹»è¯») - PostgreSQLæ‰©å±•
```

---

#### 4.2.3 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: ANSI SQLæ ‡å‡†å®šä¹‰Repeatable Read
   - åŸºäºé”æœºåˆ¶å®ç°
   - ä½¿ç”¨å…±äº«é”å’Œæ’ä»–é”
   - è¯»æ“ä½œéœ€è¦å…±äº«é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸ

2. **1995å¹´**: Berenson et al. æå‡ºå¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰
   - å½¢å¼åŒ–å®šä¹‰å¿«ç…§éš”ç¦»
   - è¯æ˜å¿«ç…§éš”ç¦»ä¸æ˜¯ä¸²è¡ŒåŒ–ï¼ˆå­˜åœ¨å†™åæ–œå¼‚å¸¸ï¼‰
   - æå‡ºFirst-Committer-Winsè§„åˆ™

3. **2000å¹´ä»£**: PostgreSQLé‡‡ç”¨å¿«ç…§éš”ç¦»å®ç°Repeatable Read
   - é€šè¿‡äº‹åŠ¡çº§å¿«ç…§é¿å…ä¸å¯é‡å¤è¯»
   - æ— éœ€è¯»é”ï¼Œæ€§èƒ½ä¼˜äºåŸºäºé”çš„å®ç°
   - æ‰©å±•é˜²æ­¢å¹»è¯»ï¼ˆæ ‡å‡†å…è®¸ï¼‰

4. **2010å¹´ä»£è‡³ä»Š**: å¿«ç…§éš”ç¦»æˆä¸ºä¸»æµå®ç°æ–¹å¼
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“é‡‡ç”¨å¿«ç…§éš”ç¦»
   - æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾
   - å†™åæ–œé—®é¢˜é€šè¿‡SSIè§£å†³

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦Repeatable Readï¼Ÿ**

1. **é˜²æ­¢ä¸å¯é‡å¤è¯»çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: å¦‚æœå…è®¸ä¸å¯é‡å¤è¯»ï¼Œäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®å¯èƒ½çœ‹åˆ°ä¸åŒå€¼
   - **åæœ**: å¯¼è‡´ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œä¾‹å¦‚ä½™é¢è®¡ç®—é”™è¯¯
   - **ç¤ºä¾‹**: æŠ¥è¡¨ç”Ÿæˆéœ€è¦ä¸€è‡´æ€§å¿«ç…§

2. **å¿«ç…§éš”ç¦»çš„ä¼˜åŠ¿**:
   - **æ€§èƒ½**: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¸é˜»å¡è¯»æ“ä½œ
   - **ä¸€è‡´æ€§**: äº‹åŠ¡çœ‹åˆ°ä¸€è‡´çš„æ•°æ®åº“çŠ¶æ€
   - **å®ç°**: é€šè¿‡å¿«ç…§è€Œéé”å®ç°ï¼Œæ€§èƒ½æ›´å¥½

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - æŠ¥è¡¨æŸ¥è¯¢éœ€è¦ä¸€è‡´æ€§å¿«ç…§
   - æ•°æ®åˆ†æéœ€è¦å¯é‡å¤è¯»
   - æ‰¹å¤„ç†éœ€è¦äº‹åŠ¡çº§ä¸€è‡´æ€§

**ç†è®ºä½ç½®**:

```text
éš”ç¦»çº§åˆ«å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ Serializable (æœ€é«˜)
â”‚   â””â”€ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ (P0, P1, P2, P3, P4)
â”‚
â”œâ”€ Repeatable Read â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é˜²æ­¢ P0, P1, P2, P3 (PostgreSQLæ‰©å±•)
â”‚       â””â”€ åŸºäºå¿«ç…§éš”ç¦»å®ç°
â”‚
â”œâ”€ Read Committed
â”‚   â””â”€ é˜²æ­¢ P0, P1
â”‚       â””â”€ å…è®¸ P2, P3
â”‚
â””â”€ Read Uncommitted (æœ€ä½)
    â””â”€ å…è®¸æ‰€æœ‰å¼‚å¸¸
```

**å¿«ç…§éš”ç¦»ä¸Repeatable Readçš„å…³ç³»**:

```text
å¿«ç…§éš”ç¦» (Snapshot Isolation):
â”œâ”€ å®šä¹‰: æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªä¸€è‡´å¿«ç…§
â”œâ”€ å®ç°: äº‹åŠ¡çº§å¿«ç…§
â”œâ”€ å¼‚å¸¸: é˜²æ­¢P0, P1, P2, P3
â””â”€ é—®é¢˜: å­˜åœ¨å†™åæ–œï¼ˆWrite Skewï¼‰å¼‚å¸¸

Repeatable Read (ANSIæ ‡å‡†):
â”œâ”€ å®šä¹‰: é˜²æ­¢P0, P1, P2ï¼Œå…è®¸P3
â”œâ”€ å®ç°: åŸºäºé”æˆ–å¿«ç…§éš”ç¦»
â””â”€ é—®é¢˜: æ ‡å‡†å…è®¸å¹»è¯»

PostgreSQL Repeatable Read:
â”œâ”€ å®ç°: å¿«ç…§éš”ç¦»
â”œâ”€ æ‰©å±•: é˜²æ­¢å¹»è¯»ï¼ˆæ ‡å‡†å…è®¸ï¼‰
â””â”€ ç»“æœ: ç­‰ä»·äºå¿«ç…§éš”ç¦»
```

**ç†è®ºæ¨å¯¼**:

```text
ä»ä¸šåŠ¡éœ€æ±‚åˆ°Repeatable Readé€‰æ‹©çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: é˜²æ­¢è„è¯»ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: ä¸€è‡´æ€§å¿«ç…§ï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: è¯»æ€§èƒ½ï¼ˆé‡è¦ï¼‰

2. éš”ç¦»çº§åˆ«ç­›é€‰
   â”œâ”€ Read Committed: âœ— å…è®¸ä¸å¯é‡å¤è¯»ï¼ˆä¸æ»¡è¶³éœ€æ±‚2ï¼‰
   â”œâ”€ Repeatable Read: âœ“ é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼Œä¸€è‡´æ€§å¿«ç…§ï¼ˆæ»¡è¶³éœ€æ±‚1,2,3ï¼‰
   â”œâ”€ Serializable: âš ï¸ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼Œä½†æ€§èƒ½ä½ï¼ˆä¸æ»¡è¶³éœ€æ±‚4ï¼‰
   â””â”€ å¿«ç…§éš”ç¦»: âœ“ ç­‰ä»·äºPostgreSQL RRï¼ˆæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼‰

3. ç»“è®º
   â””â”€ é€‰æ‹©Repeatable Readï¼ˆå¿«ç…§éš”ç¦»å®ç°ï¼‰âœ“
```

---

#### 4.2.4 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: æŠ¥è¡¨ç”Ÿæˆä¸€è‡´æ€§å¿«ç…§**

```sql
-- åœºæ™¯: ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥è¡¨
-- éœ€æ±‚: æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŸºäºåŒä¸€æ•°æ®å¿«ç…§

-- ä¼šè¯A (æŠ¥è¡¨ç”Ÿæˆ)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200, xip=[105, 110]

-- æŸ¥è¯¢1: æœŸåˆä½™é¢
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-01';
-- è¿”å›: 1,000,000 (åŸºäºå¿«ç…§)

-- ä¼šè¯B (æ–°äº¤æ˜“)
BEGIN;
INSERT INTO accounts VALUES (..., 50000);
COMMIT;  -- ä½™é¢å˜ä¸º1,050,000

-- ä¼šè¯A (æŸ¥è¯¢2: æœŸæœ«ä½™é¢)
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-31';
-- ä»è¿”å›: 1,000,000 (åŸºäºåŒä¸€å¿«ç…§) âœ“ æ•°æ®ä¸€è‡´

-- æŸ¥è¯¢3: äº¤æ˜“æ˜ç»†
SELECT * FROM transactions WHERE date BETWEEN '2025-12-01' AND '2025-12-31';
-- è¿”å›: åŸºäºåŒä¸€å¿«ç…§çš„æ•°æ® âœ“ æ•°æ®ä¸€è‡´

COMMIT;
```

**åˆ†æ**:

- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šæ‰€æœ‰æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„è¡Œ
- âœ… ä¸€è‡´æ€§å¿«ç…§ï¼šæŠ¥è¡¨æ•°æ®å®Œå…¨ä¸€è‡´
- âœ… æ€§èƒ½ä¼˜ç§€ï¼šè¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ

---

**æ­£ä¾‹2: æ•°æ®åˆ†æä¸€è‡´æ€§è§†å›¾**

```sql
-- åœºæ™¯: æ•°æ®åˆ†æéœ€è¦ä¸€è‡´æ€§è§†å›¾
-- éœ€æ±‚: å¤šæ¬¡æŸ¥è¯¢å¿…é¡»çœ‹åˆ°ç›¸åŒçš„æ•°æ®

-- ä¼šè¯A (æ•°æ®åˆ†æ)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200

-- æŸ¥è¯¢1: ç»Ÿè®¡ç”¨æˆ·æ•°
SELECT COUNT(*) FROM users WHERE status = 'active';
-- è¿”å›: 10,000

-- ä¼šè¯B (ç”¨æˆ·æ³¨å†Œ)
BEGIN;
INSERT INTO users VALUES (..., 'active');
COMMIT;  -- ç”¨æˆ·æ•°å˜ä¸º10,001

-- ä¼šè¯A (æŸ¥è¯¢2: ç»Ÿè®¡è®¢å•æ•°)
SELECT COUNT(*) FROM orders WHERE user_id IN (
    SELECT id FROM users WHERE status = 'active'
);
-- è¿”å›: åŸºäº10,000ä¸ªç”¨æˆ·çš„è®¢å•æ•° âœ“ æ•°æ®ä¸€è‡´

-- æŸ¥è¯¢3: å†æ¬¡ç»Ÿè®¡ç”¨æˆ·æ•°
SELECT COUNT(*) FROM users WHERE status = 'active';
-- ä»è¿”å›: 10,000 (åŸºäºåŒä¸€å¿«ç…§) âœ“ å¯é‡å¤è¯»

COMMIT;
```

**åˆ†æ**:

- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šå¤šæ¬¡æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„ç”¨æˆ·æ•°
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„ç”¨æˆ·
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§

---

**åä¾‹åˆ†æ**:

**åä¾‹1: é”™è¯¯ä½¿ç”¨Read Committedå¯¼è‡´æ•°æ®ä¸ä¸€è‡´**

```sql
-- é”™è¯¯åœºæ™¯: ä½¿ç”¨Read Committedè¿›è¡ŒæŠ¥è¡¨ç”Ÿæˆ
-- é—®é¢˜: ä¸å¯é‡å¤è¯»å¯¼è‡´æŠ¥è¡¨æ•°æ®ä¸ä¸€è‡´

-- ä¼šè¯A (æŠ¥è¡¨ç”Ÿæˆ - é”™è¯¯ä½¿ç”¨Read Committed)
BEGIN;  -- é»˜è®¤Read Committed
-- æŸ¥è¯¢1: ç»Ÿè®¡è®¢å•æ€»æ•°
SELECT COUNT(*) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: 1000

-- ä¼šè¯B (æ–°è®¢å•)
BEGIN;
INSERT INTO orders VALUES (...);
COMMIT;  -- è®¢å•æ•°å˜ä¸º1001

-- ä¼šè¯A (æŸ¥è¯¢2: ç»Ÿè®¡è®¢å•é‡‘é¢)
SELECT SUM(amount) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: åŸºäº1001ä¸ªè®¢å•çš„é‡‘é¢

-- é—®é¢˜: è®¢å•æ€»æ•°å’Œè®¢å•é‡‘é¢åŸºäºä¸åŒçš„æ•°æ®å¿«ç…§
-- ç»“æœ: æŠ¥è¡¨æ•°æ®ä¸ä¸€è‡´ âœ—
```

**é”™è¯¯åŸå› **:

- Read Committedä½¿ç”¨è¯­å¥çº§å¿«ç…§
- ä¸åŒè¯­å¥çœ‹åˆ°ä¸åŒçš„æ•°æ®åº“çŠ¶æ€
- å¯¹äºéœ€è¦ä¸€è‡´æ€§å¿«ç…§çš„æŠ¥è¡¨ï¼Œè¿™æ˜¯é”™è¯¯çš„

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Repeatable Read
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: 1000

-- å³ä½¿æœ‰æ–°è®¢å•æ’å…¥ï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½åŸºäºåŒä¸€å¿«ç…§
SELECT SUM(amount) FROM orders WHERE date = '2025-12-05';
-- è¿”å›: åŸºäº1000ä¸ªè®¢å•çš„é‡‘é¢ âœ“ æ•°æ®ä¸€è‡´
COMMIT;
```

**åæœåˆ†æ**:

- **æ•°æ®ä¸ä¸€è‡´**: æŠ¥è¡¨ä¸­çš„ä¸åŒæŒ‡æ ‡åŸºäºä¸åŒçš„æ•°æ®å¿«ç…§
- **ä¸šåŠ¡å†³ç­–é”™è¯¯**: åŸºäºä¸ä¸€è‡´çš„æŠ¥è¡¨åšå‡ºé”™è¯¯å†³ç­–
- **æ€§èƒ½å½±å“**: æ— ï¼ˆä½†æ•°æ®è´¨é‡é”™è¯¯ï¼‰

---

**åä¾‹2: å†™å†™å†²çªå¯¼è‡´äº‹åŠ¡ä¸­æ­¢**

```sql
-- é”™è¯¯åœºæ™¯: ä¸ç†è§£å†™å†™å†²çªæ£€æµ‹
-- é—®é¢˜: äº‹åŠ¡å› å†™å†™å†²çªè€Œä¸­æ­¢

-- ä¼šè¯A
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE id = 1;
-- è¿”å›: 1000 (å¿«ç…§: balance=1000)

-- ä¼šè¯B
BEGIN;
UPDATE accounts SET balance = balance + 500 WHERE id = 1;
COMMIT;  -- balanceå˜ä¸º1500

-- ä¼šè¯A (å°è¯•æ›´æ–°)
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- ERROR: could not serialize access due to concurrent update âœ—
-- äº‹åŠ¡ä¸­æ­¢
```

**é”™è¯¯åŸå› **:

- Repeatable Readæ£€æµ‹å†™å†™å†²çª
- å¦‚æœè¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹ï¼Œå½“å‰äº‹åŠ¡çš„æ›´æ–°ä¼šè¢«æ‹’ç»
- è¿™æ˜¯å¿«ç…§éš”ç¦»çš„First-Committer-Winsè§„åˆ™

**æ­£ç¡®åšæ³•**:

```sql
-- æ–¹æ¡ˆ1: ä½¿ç”¨Serializableï¼ˆæ£€æµ‹å†™åæ–œï¼‰
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;  -- å¯èƒ½å› å†™åæ–œè€Œä¸­æ­¢ï¼Œä½†æ›´ä¸¥æ ¼

-- æ–¹æ¡ˆ2: ä½¿ç”¨ä¹è§‚é”ï¼ˆåº”ç”¨å±‚å¤„ç†ï¼‰
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance, version FROM accounts WHERE id = 1;
-- åº”ç”¨å±‚æ£€æŸ¥versionï¼Œå¦‚æœå˜åŒ–åˆ™é‡è¯•
UPDATE accounts SET balance = balance - 100, version = version + 1
WHERE id = 1 AND version = $expected_version;
COMMIT;
```

**åæœåˆ†æ**:

- **äº‹åŠ¡ä¸­æ­¢**: å†™å†™å†²çªå¯¼è‡´äº‹åŠ¡å¤±è´¥
- **éœ€è¦é‡è¯•**: åº”ç”¨å±‚éœ€è¦å¤„ç†é‡è¯•é€»è¾‘
- **æ€§èƒ½å½±å“**: ä¸­æ­¢ç‡å¢åŠ ï¼Œéœ€è¦é‡è¯•å¼€é”€

---

**åä¾‹3: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸**

```sql
-- é”™è¯¯åœºæ™¯: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°
-- é—®é¢˜: ç‰ˆæœ¬é“¾å˜é•¿ï¼Œæ€§èƒ½ä¸‹é™

-- ä¼šè¯A (é•¿äº‹åŠ¡ - è¿è¡Œ1å°æ—¶)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200

-- ä¼šè¯B, C, D, ... (1000ä¸ªå¹¶å‘äº‹åŠ¡)
-- æ¯ç§’æ›´æ–°åŒä¸€è¡Œ100æ¬¡
-- 1å°æ—¶å: ç‰ˆæœ¬é“¾é•¿åº¦ = 360,000

-- ä¼šè¯A (æŸ¥è¯¢)
SELECT * FROM accounts WHERE id = 1;
-- éœ€è¦éå†360,000ä¸ªç‰ˆæœ¬æ‰¾åˆ°å¯è§ç‰ˆæœ¬
-- å»¶è¿Ÿ: æ•°ç§’ç”šè‡³æ•°åç§’ âœ—
```

**é”™è¯¯åŸå› **:

- é•¿äº‹åŠ¡æŒæœ‰å¿«ç…§ï¼Œå¯¼è‡´ç‰ˆæœ¬é“¾ä¸èƒ½æ¸…ç†
- é«˜é¢‘æ›´æ–°å¯¼è‡´ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿
- å¯è§æ€§åˆ¤æ–­éœ€è¦éå†é•¿ç‰ˆæœ¬é“¾

**æ­£ç¡®åšæ³•**:

```sql
-- æ–¹æ¡ˆ1: é¿å…é•¿äº‹åŠ¡
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«é€ŸæŸ¥è¯¢ï¼Œç«‹å³æäº¤
SELECT * FROM accounts WHERE id = 1;
COMMIT;  -- äº‹åŠ¡æ—¶é—´ < 1ç§’

-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
BEGIN;  -- Read Committed
SELECT * FROM accounts WHERE id = 1;
COMMIT;

-- æ–¹æ¡ˆ3: å®šæœŸæäº¤é•¿äº‹åŠ¡
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- æŸ¥è¯¢1
SELECT ...;
COMMIT;

BEGIN ISOLATION LEVEL REPEATABLE READ;
-- æŸ¥è¯¢2
SELECT ...;
COMMIT;
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: ç‰ˆæœ¬é“¾éå†å¼€é”€å·¨å¤§
- **å»¶è¿Ÿå¢åŠ **: æŸ¥è¯¢å»¶è¿Ÿä»æ¯«ç§’çº§å¢åŠ åˆ°ç§’çº§
- **å­˜å‚¨è†¨èƒ€**: ç‰ˆæœ¬é“¾å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: æŠ¥è¡¨æŸ¥è¯¢ä¸€è‡´æ€§å¿«ç…§**

**åœºæ™¯æè¿°**:

- ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥è¡¨
- éœ€è¦æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€æ•°æ®å¿«ç…§
- äº‹åŠ¡æ—¶é•¿: 5-10åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦Repeatable Read**:

- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šæ‰€æœ‰æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„è¡Œ
- âœ… ä¸€è‡´æ€§å¿«ç…§ï¼šæŠ¥è¡¨æ•°æ®å®Œå…¨ä¸€è‡´

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-01';
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-31';
SELECT * FROM transactions WHERE date BETWEEN '2025-12-01' AND '2025-12-31';
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§ âœ“
- **æ€§èƒ½**: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ âœ“
- **å»¶è¿Ÿ**: æŸ¥è¯¢å»¶è¿Ÿæ­£å¸¸ï¼ˆé™¤éç‰ˆæœ¬é“¾è¿‡é•¿ï¼‰

---

**åœºæ™¯2: æ•°æ®åˆ†æä¸€è‡´æ€§è§†å›¾**

**åœºæ™¯æè¿°**:

- æ•°æ®åˆ†æéœ€è¦ä¸€è‡´æ€§è§†å›¾
- å¤šæ¬¡æŸ¥è¯¢å¿…é¡»çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- äº‹åŠ¡æ—¶é•¿: 1-5åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦Repeatable Read**:

- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šå¤šæ¬¡æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„è¡Œ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM users WHERE status = 'active';
SELECT COUNT(*) FROM orders WHERE user_id IN (
    SELECT id FROM users WHERE status = 'active'
);
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§ âœ“
- **æ€§èƒ½**: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ âœ“
- **å»¶è¿Ÿ**: æŸ¥è¯¢å»¶è¿Ÿæ­£å¸¸

---

**åœºæ™¯3: æ‰¹å¤„ç†ä¸€è‡´æ€§å¤„ç†**

**åœºæ™¯æè¿°**:

- æ‰¹å¤„ç†éœ€è¦ä¸€è‡´æ€§å¤„ç†
- éœ€è¦è¯»å–ä¸€è‡´çš„æ•°æ®å¿«ç…§
- äº‹åŠ¡æ—¶é•¿: 10-30åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦Repeatable Read**:

- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼šæ‰¹å¤„ç†çœ‹åˆ°ä¸€è‡´çš„æ•°æ®
- âœ… é˜²æ­¢å¹»è¯»ï¼šä¸ä¼šçœ‹åˆ°æ–°æ’å…¥çš„è¡Œ
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ‰¹å¤„ç†åŸºäºåŒä¸€å¿«ç…§

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- è¯»å–æ•°æ®
SELECT * FROM source_table WHERE batch_id = 123;
-- å¤„ç†æ•°æ®
-- å†™å…¥ç»“æœ
INSERT INTO result_table SELECT ... FROM source_table WHERE batch_id = 123;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: æ‰¹å¤„ç†åŸºäºåŒä¸€å¿«ç…§ âœ“
- **æ€§èƒ½**: è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œ âœ“
- **æ³¨æ„**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»ä¸šåŠ¡éœ€æ±‚åˆ°Repeatable Readé€‰æ‹©**

```text
å‰æ1: ä¸šåŠ¡éœ€æ±‚æ˜¯é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼ˆå¿…é¡»ï¼‰
å‰æ2: ä¸šåŠ¡éœ€æ±‚æ˜¯ä¸€è‡´æ€§å¿«ç…§ï¼ˆé‡è¦ï¼‰
å‰æ3: ä¸šåŠ¡éœ€æ±‚æ˜¯è¯»æ€§èƒ½ï¼ˆé‡è¦ï¼‰

æ¨ç†æ­¥éª¤1: æ’é™¤Read Committedï¼ˆå…è®¸ä¸å¯é‡å¤è¯»ï¼Œä¸æ»¡è¶³å‰æ1ï¼‰
æ¨ç†æ­¥éª¤2: æ’é™¤Serializableï¼ˆæ€§èƒ½ä½ï¼Œä¸æ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: Repeatable Readæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼ˆå¿«ç…§éš”ç¦»å®ç°ï¼‰

ç»“è®º: é€‰æ‹©Repeatable Read âœ“
```

**æ¨ç†é“¾æ¡2: ä»å¿«ç…§éš”ç¦»åˆ°å¼‚å¸¸é˜²æ­¢çš„æ¨ç†**

```text
å‰æ1: å¿«ç…§éš”ç¦»ä½¿ç”¨äº‹åŠ¡çº§å¿«ç…§
å‰æ2: äº‹åŠ¡çº§å¿«ç…§åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´ä¿æŒä¸å˜
å‰æ3: æ‰€æœ‰æŸ¥è¯¢åŸºäºåŒä¸€å¿«ç…§

æ¨ç†æ­¥éª¤1: å¿«ç…§åœ¨äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºï¼ŒåŒ…å«æ‰€æœ‰å·²æäº¤äº‹åŠ¡
æ¨ç†æ­¥éª¤2: äº‹åŠ¡æœŸé—´å…¶ä»–äº‹åŠ¡çš„æäº¤ä¸ä¼šå½±å“å¿«ç…§
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢çœ‹åˆ°ç›¸åŒçš„æ•°æ®

ç»“è®º: å¿«ç…§éš”ç¦»é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼ˆP2ï¼‰âœ“
```

**æ¨ç†é“¾æ¡3: ä»å†™å†™å†²çªåˆ°äº‹åŠ¡ä¸­æ­¢çš„æ¨ç†**

```text
å‰æ1: Repeatable Readä½¿ç”¨å¿«ç…§éš”ç¦»
å‰æ2: å¿«ç…§éš”ç¦»ä½¿ç”¨First-Committer-Winsè§„åˆ™
å‰æ3: å†™å†™å†²çªæ£€æµ‹ï¼šå¦‚æœè¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹ï¼Œå½“å‰äº‹åŠ¡çš„æ›´æ–°è¢«æ‹’ç»

æ¨ç†æ­¥éª¤1: äº‹åŠ¡T1è¯»å–è¡ŒRï¼ˆå¿«ç…§: R=100ï¼‰
æ¨ç†æ­¥éª¤2: äº‹åŠ¡T2ä¿®æ”¹å¹¶æäº¤ï¼ˆR=200ï¼‰
æ¨ç†æ­¥éª¤3: äº‹åŠ¡T1å°è¯•æ›´æ–°Rï¼Œæ£€æµ‹åˆ°å†²çª
æ¨ç†æ­¥éª¤4: æ ¹æ®First-Committer-Winsè§„åˆ™ï¼ŒT1çš„æ›´æ–°è¢«æ‹’ç»

ç»“è®º: å†™å†™å†²çªå¯¼è‡´äº‹åŠ¡ä¸­æ­¢ âœ“
```

---

#### 4.2.5 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¿«ç…§éš”ç¦»çš„å…³ç³»**:
   - PostgreSQLçš„Repeatable ReadåŸºäºå¿«ç…§éš”ç¦»å®ç°
   - å¿«ç…§éš”ç¦»ç­‰ä»·äºPostgreSQLçš„Repeatable Read
   - å¿«ç…§éš”ç¦»æ˜¯Repeatable Readçš„ä¸€ç§å®ç°æ–¹å¼

2. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - Repeatable Readé€šè¿‡äº‹åŠ¡çº§å¿«ç…§æ§åˆ¶å¯è§æ€§
   - æ‰€æœ‰è¯­å¥çš„å¯è§æ€§åˆ¤æ–­åŸºäºäº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§
   - å¯è§æ€§è§„åˆ™ï¼š`Visible(tuple, snapshot) = (tuple.xmin < snapshot.xmax) âˆ§ (tuple.xmin âˆ‰ snapshot.xip)`

3. **ä¸MVCCå®ç°çš„å…³ç³»**:
   - Repeatable Readæ˜¯MVCCçš„ä¸€ä¸ªåº”ç”¨
   - é€šè¿‡ç‰ˆæœ¬é“¾å’Œå¯è§æ€§åˆ¤æ–­å®ç°
   - æ— éœ€è¯»é”ï¼Œå†™æ“ä½œä½¿ç”¨è¡Œé”

4. **ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:
   - Repeatable Readæ˜¯å››ä¸ªéš”ç¦»çº§åˆ«ä¸­çš„ç¬¬ä¸‰ä¸ª
   - æ¯”Read Committedå¼ºï¼ˆé˜²æ­¢ä¸å¯é‡å¤è¯»ï¼‰
   - æ¯”Serializableå¼±ï¼ˆå…è®¸å†™åæ–œï¼‰

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL MVCCå®ç°
   - äº‹åŠ¡çº§å¿«ç…§åˆ›å»º
   - ç‰ˆæœ¬é“¾éå†
   - å†™å†™å†²çªæ£€æµ‹

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - Repeatable Read â‰ˆ æ•´ä¸ªä½œç”¨åŸŸä½¿ç”¨åŒä¸€ä¸å¯å˜å¼•ç”¨
   - äº‹åŠ¡çº§å¿«ç…§ â‰ˆ ä½œç”¨åŸŸçº§åˆ«çš„å€Ÿç”¨

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - Repeatable Read â‰ˆ é¡ºåºä¸€è‡´æ€§ï¼ˆSequential Consistencyï¼‰
   - äº‹åŠ¡çº§å¿«ç…§ â‰ˆ å‘é‡æ—¶é’Ÿçš„å¿«ç…§ç‚¹

**å®ç°ç»†èŠ‚**:

**PostgreSQLæºç çº§åˆ†æ**:

```c
// src/backend/access/heap/heapam_visibility.c

// äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§
Snapshot GetSnapshotData(Snapshot snapshot)
{
    // è·å–å½“å‰æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
    xip = GetActiveTransactionIds();

    // è®¾ç½®å¿«ç…§è¾¹ç•Œï¼ˆäº‹åŠ¡çº§ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´ä¸å˜ï¼‰
    snapshot->xmin = GetOldestXmin();
    snapshot->xmax = GetNextTransactionId();
    snapshot->xip = xip;

    return snapshot;
}

// å†™å†™å†²çªæ£€æµ‹
void CheckForSerializationFailure(HeapTuple tuple, TransactionId xmax)
{
    if (tuple->xmax != 0 && tuple->xmax != GetCurrentTransactionId())
    {
        if (TransactionIdIsInProgress(tuple->xmax))
        {
            // ç­‰å¾…åˆ é™¤äº‹åŠ¡æäº¤æˆ–å›æ»š
            XactLockTableWait(tuple->xmax);
        }
        else if (TransactionIdDidCommit(tuple->xmax))
        {
            // è¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹
            ereport(ERROR,
                (errcode(ERRCODE_T_R_SERIALIZATION_FAILURE),
                 errmsg("could not serialize access due to concurrent update")));
        }
    }
}
```

**å†™å†™å†²çªæ£€æµ‹ç®—æ³•**:

```python
def detect_rr_conflict(tuple, snapshot, txid):
    """
    æ£€æµ‹Repeatable Readçš„å†™å†™å†²çª

    è§„åˆ™: First-Committer-Wins
    - å¦‚æœè¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹ï¼Œå½“å‰äº‹åŠ¡çš„æ›´æ–°è¢«æ‹’ç»
    """
    if tuple.xmax != 0 and tuple.xmax != txid:
        if is_committed(tuple.xmax):
            # è¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹
            raise SerializationError("concurrent update")
        elif is_in_progress(tuple.xmax):
            # ç­‰å¾…åˆ é™¤äº‹åŠ¡æäº¤æˆ–å›æ»š
            wait_for_transaction(tuple.xmax)
            # é‡æ–°æ£€æŸ¥
            if is_committed(tuple.xmax):
                raise SerializationError("concurrent update")

    return True  # æ— å†²çª
```

**æ€§èƒ½å½±å“**:

1. **å¿«ç…§åˆ›å»ºå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå…¶ä¸­ $N_{active}$ æ˜¯æ´»è·ƒäº‹åŠ¡æ•°
   - ç©ºé—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 1-5Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°ï¼‰
   - **ä¸Read Committedç›¸åŒ**

2. **å¿«ç…§ç»´æŠ¤å¼€é”€**:
   - äº‹åŠ¡çº§å¿«ç…§éœ€è¦åœ¨äº‹åŠ¡æœŸé—´ä¸€ç›´ç»´æŠ¤
   - å†…å­˜å¼€é”€: $O(N_{active})$ æŒç»­å ç”¨
   - **æ¯”Read Committedé«˜**ï¼ˆRead Committedåœ¨è¯­å¥ç»“æŸæ—¶é‡Šæ”¾ï¼‰

3. **å†™å†™å†²çªæ£€æµ‹å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - æ£€æŸ¥xmax
   - å…¸å‹å¼€é”€: 0.1-0.5Î¼s
   - **æ¯”Read Committedé«˜**ï¼ˆRead Committedä¸æ£€æµ‹å†™å†™å†²çªï¼‰

4. **æ€»ä½“æ€§èƒ½**:
   - è¯»æ“ä½œ: æ— é”ï¼Œæ€§èƒ½é«˜ï¼ˆä¸Read Committedç›¸åŒï¼‰
   - å†™æ“ä½œ: è¡Œé” + å†™å†™å†²çªæ£€æµ‹ï¼Œæ€§èƒ½ä¸­ç­‰
   - æ€»ä½“TPS: 40,000+ï¼ˆå…¸å‹é…ç½®ï¼Œæ¯”Read Committedä½çº¦20%ï¼‰

---

#### 4.2.6 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**è¯»æ“ä½œæ€§èƒ½**:

$$T_{read} = T_{snapshot} + T_{scan} + T_{visibility}$$

å…¶ä¸­ï¼š

- $T_{snapshot} = O(N_{active})$ - å¿«ç…§åˆ›å»ºæ—¶é—´ï¼ˆäº‹åŠ¡å¼€å§‹æ—¶ä¸€æ¬¡ï¼‰
- $T_{scan}$ - ç´¢å¼•/è¡¨æ‰«ææ—¶é—´
- $T_{visibility} = O(\log N_{active})$ - å¯è§æ€§åˆ¤æ–­æ—¶é—´

**å†™æ“ä½œæ€§èƒ½**:

$$T_{write} = T_{lock} + T_{conflict\_check} + T_{insert} + T_{wal}$$

å…¶ä¸­ï¼š

- $T_{lock}$ - è¡Œé”è·å–æ—¶é—´ï¼ˆå†™å†™å†²çªæ—¶å¢åŠ ï¼‰
- $T_{conflict\_check} = O(1)$ - å†™å†™å†²çªæ£€æµ‹æ—¶é—´
- $T_{insert}$ - å…ƒç»„æ’å…¥æ—¶é—´
- $T_{wal}$ - WALå†™å…¥æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºTPC-CåŸºå‡†æµ‹è¯•):

| æŒ‡æ ‡ | Repeatable Read | Read Committed | å¯¹æ¯” |
|------|----------------|---------------|------|
| **TPS** | 100,000 | 125,000 | -20% |
| **P50å»¶è¿Ÿ** | 15ms | 12ms | +25% |
| **P95å»¶è¿Ÿ** | 45ms | 35ms | +29% |
| **P99å»¶è¿Ÿ** | 85ms | 65ms | +31% |
| **ä¸­æ­¢ç‡** | 2% | 0.2% | +900% |
| **CPUä½¿ç”¨ç‡** | 82% | 78% | +5% |
| **é”ç­‰å¾…ç‡** | 2.5% | 1.2% | +108% |

**å†™å†™å†²çªåˆ†æ**:

| å¹¶å‘åº¦ | å†™å†™å†²çªç‡ | ä¸­æ­¢ç‡ | è¯´æ˜ |
|--------|----------|--------|------|
| 10 | 0.1% | 0.1% | ä½å¹¶å‘ï¼Œå†²çªå°‘ |
| 100 | 1.5% | 1.5% | ä¸­ç­‰å¹¶å‘ï¼Œå†²çªå¢åŠ  |
| 1000 | 8% | 8% | é«˜å¹¶å‘ï¼Œå†²çªæ˜¾è‘— |

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘é•¿äº‹åŠ¡**:
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´
   - é¿å…é•¿æ—¶é—´æŒæœ‰å¿«ç…§
   - å®šæœŸæäº¤é•¿äº‹åŠ¡

2. **ä¼˜åŒ–å†™å†™å†²çª**:
   - ä½¿ç”¨ä¹è§‚é”ï¼ˆåº”ç”¨å±‚å¤„ç†ï¼‰
   - å‡å°‘çƒ­ç‚¹è¡Œæ›´æ–°
   - ä½¿ç”¨è¡Œåˆ†æ•£æŠ€æœ¯

3. **ä¼˜åŒ–å¿«ç…§åˆ›å»º**:
   - ä½¿ç”¨å¿«ç…§ç¼“å­˜ï¼ˆPostgreSQLè‡ªåŠ¨ä¼˜åŒ–ï¼‰
   - å‡å°‘äº‹åŠ¡IDåˆ†é…å¼€é”€

---

#### 4.2.7 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: Repeatable Readé˜²æ­¢è„è¯»ã€è„å†™ã€ä¸å¯é‡å¤è¯»ï¼ŒPostgreSQLæ‰©å±•é˜²æ­¢å¹»è¯»
2. **å®ç°**: PostgreSQLé€šè¿‡å¿«ç…§éš”ç¦»ï¼ˆäº‹åŠ¡çº§å¿«ç…§ï¼‰å®ç°
3. **æ€§èƒ½**: æ€§èƒ½è‰¯å¥½ï¼Œé€‚åˆéœ€è¦ä¸€è‡´æ€§å¿«ç…§çš„åœºæ™¯
4. **åº”ç”¨**: æŠ¥è¡¨æŸ¥è¯¢ã€æ•°æ®åˆ†æã€æ‰¹å¤„ç†

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºRepeatable Readä¿è¯ä¸²è¡ŒåŒ–
   - **é”™è¯¯**: Repeatable Readå…è®¸å†™åæ–œï¼ˆWrite Skewï¼‰
   - **æ­£ç¡®**: éœ€è¦ä¸²è¡ŒåŒ–æ—¶ä½¿ç”¨Serializable

2. **è¯¯åŒº2**: è®¤ä¸ºRepeatable Readæ€§èƒ½ä½
   - **é”™è¯¯**: Repeatable Readæ€§èƒ½è‰¯å¥½ï¼ˆæ¯”Serializableé«˜å¾ˆå¤šï¼‰
   - **æ­£ç¡®**: Repeatable Readæ€§èƒ½ç•¥ä½äºRead Committedï¼Œä½†å¯æ¥å—

3. **è¯¯åŒº3**: å¿½ç•¥å†™å†™å†²çªæ£€æµ‹
   - **é”™è¯¯**: ä¸ç†è§£å†™å†™å†²çªä¼šå¯¼è‡´äº‹åŠ¡ä¸­æ­¢
   - **æ­£ç¡®**: åº”ç”¨å±‚éœ€è¦å¤„ç†é‡è¯•é€»è¾‘

**æœ€ä½³å®è·µ**:

1. **æ˜ç¡®éœ€æ±‚**: æ˜ç¡®ä¸šåŠ¡æ˜¯å¦éœ€è¦å¯é‡å¤è¯»
2. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸
3. **å¤„ç†å†²çª**: åº”ç”¨å±‚å¤„ç†å†™å†™å†²çªé‡è¯•
4. **ç›‘æ§æŒ‡æ ‡**: ç›‘æ§TPSã€å»¶è¿Ÿã€ä¸­æ­¢ç‡ç­‰æŒ‡æ ‡

---

**å¿«ç…§ç­–ç•¥**: **äº‹åŠ¡çº§å¿«ç…§**

```python
class RepeatableReadTransaction:
    def __init__(self):
        self.snapshot = get_current_snapshot()  # äº‹åŠ¡å¼€å§‹æ—¶å›ºå®š

    def execute_statement(self, sql):
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: å›ºå®šå¿«ç…§ä¿è¯ä¸€è‡´æ€§
- âœ… **å¹»è¯»**: PostgreSQLæ‰©å±•ï¼Œäº‹åŠ¡çº§å¿«ç…§é˜²æ­¢å¹»è¯»

**å†™å†™å†²çªæ£€æµ‹**:

```sql
-- äº‹åŠ¡T1
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE id = 1;  -- å¿«ç…§: balance=100

-- äº‹åŠ¡T2 ä¿®æ”¹å¹¶æäº¤
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- äº‹åŠ¡T1 å°è¯•æ›´æ–°
UPDATE accounts SET balance = 150 WHERE id = 1;
-- ERROR: could not serialize access due to concurrent update
```

**å†²çªæ£€æµ‹ç®—æ³•**:

```python
def detect_rr_conflict(tuple, snapshot, txid):
    if tuple.xmax != 0 and tuple.xmax != txid:
        if is_committed(tuple.xmax):
            # è¡Œå·²è¢«å…¶ä»–å·²æäº¤äº‹åŠ¡ä¿®æ”¹
            raise SerializationError("concurrent update")
```

### 4.3 Serializable (å¯ä¸²è¡ŒåŒ–) - SSI

#### 4.3.1 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> Serializable is the highest isolation level in database systems. It ensures that concurrent transactions produce the same result as if they were executed sequentially. In PostgreSQL, Serializable is implemented using Serializable Snapshot Isolation (SSI), which extends Snapshot Isolation with conflict detection to prevent serialization anomalies.

**ANSI SQLæ ‡å‡†å®šä¹‰** (SQL:2016):

> Serializable isolation level ensures that:
>
> - **P0 (Dirty Write)**: Prevented âœ“
> - **P1 (Dirty Read)**: Prevented âœ“
> - **P2 (Non-repeatable Read)**: Prevented âœ“
> - **P3 (Phantom Read)**: Prevented âœ“
> - **P4 (Serialization Anomaly)**: Prevented âœ“

**Fekete et al. (2005) SSIå®šä¹‰**:

> Serializable Snapshot Isolation (SSI) extends Snapshot Isolation by detecting and preventing dangerous structuresâ€”specific patterns of read-write dependencies that could lead to serialization anomalies.

**Ports & Grittner (2012) PostgreSQL SSIå®ç°**:

> PostgreSQL's SSI implementation is the first production-grade SSI system. It uses predicate locks (SIREAD locks) to track read dependencies and detects dangerous structures in the dependency graph to ensure serializability.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„Serializableå®ç°åŸºäº**SSI (Serializable Snapshot Isolation)**ï¼š

```python
class SerializableTransaction:
    def __init__(self):
        # äº‹åŠ¡çº§å¿«ç…§ï¼ˆåŒRepeatable Readï¼‰
        self.snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )
        # SSIæ‰©å±•ï¼šè°“è¯é”å’Œä¾èµ–å›¾
        self.predicate_locks = []  # SIREADé”åˆ—è¡¨
        self.dependencies = []      # ä¾èµ–è¾¹åˆ—è¡¨

    def execute_select(self, sql):
        result = execute_with_snapshot(sql, self.snapshot)

        # SSIæ‰©å±•ï¼šè®°å½•è°“è¯é”
        predicate = extract_predicate(sql)
        self.predicate_locks.append(predicate)

        # æ£€æŸ¥å†™ä¾èµ–ï¼ˆrwä¾èµ–ï¼‰
        for writer in get_concurrent_writers():
            if conflicts(writer, predicate):
                self.dependencies.append((writer, self, 'rw'))

        return result

    def execute_modify(self, sql):
        # SSIæ‰©å±•ï¼šæ£€æŸ¥è¯»ä¾èµ–ï¼ˆwrä¾èµ–ï¼‰
        for reader in get_concurrent_readers():
            if conflicts(sql, reader.predicate_locks):
                self.dependencies.append((self, reader, 'wr'))

        # æ£€æµ‹å±é™©ç»“æ„ï¼ˆDangerous Structureï¼‰
        if has_dangerous_structure(self.dependencies):
            raise SerializationError("Dangerous structure detected")

        # æ‰§è¡Œä¿®æ”¹
        return execute_with_lock(sql)
```

**æœ¬ä½“ç³»å®šä¹‰**:

Serializableæ˜¯PostgreSQLçš„**æœ€é«˜éš”ç¦»çº§åˆ«**ï¼Œé€šè¿‡SSIï¼ˆSerializable Snapshot Isolationï¼‰å®ç°ï¼Œä¿è¯ï¼š

- âœ… é˜²æ­¢è„è¯»ï¼ˆP1ï¼‰
- âœ… é˜²æ­¢è„å†™ï¼ˆP0ï¼‰
- âœ… é˜²æ­¢ä¸å¯é‡å¤è¯»ï¼ˆP2ï¼‰
- âœ… é˜²æ­¢å¹»è¯»ï¼ˆP3ï¼‰
- âœ… é˜²æ­¢ä¸²è¡ŒåŒ–å¼‚å¸¸ï¼ˆP4ï¼‰- **SSIæ‰©å±•**

**SSIä¸å¿«ç…§éš”ç¦»çš„å…³ç³»**:

```text
å¿«ç…§éš”ç¦» (Snapshot Isolation):
â”œâ”€ åŸºç¡€: äº‹åŠ¡çº§å¿«ç…§
â”œâ”€ å¼‚å¸¸: é˜²æ­¢P0, P1, P2, P3
â””â”€ é—®é¢˜: å­˜åœ¨å†™åæ–œï¼ˆWrite Skewï¼‰å¼‚å¸¸

SSI (Serializable Snapshot Isolation):
â”œâ”€ åŸºç¡€: å¿«ç…§éš”ç¦»
â”œâ”€ æ‰©å±•: ä¾èµ–å›¾æ£€æµ‹
â”œâ”€ å¼‚å¸¸: é˜²æ­¢P0, P1, P2, P3, P4
â””â”€ ç»“æœ: ç­‰ä»·äºä¸²è¡ŒåŒ–
```

---

#### 4.3.2 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰4.3.1 (Serializable - Adyaæ¡†æ¶)**:

å¯¹äºäº‹åŠ¡å†å² $H$ï¼ŒSerializableéš”ç¦»çº§åˆ«æ»¡è¶³ï¼š

$$\forall T_i, T_j \in \text{Committed}(H):$$

1. **é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ (P0, P1, P2, P3, P4)**:
   $$\neg\exists \text{ anomaly in } H$$

2. **ä¸²è¡ŒåŒ–ç­‰ä»·æ€§**:
   $$\exists \text{ serial schedule } S: H \equiv S$$

**å®šä¹‰4.3.2 (è¯»å†™ä¾èµ– - Fekete et al., 2005)**:

$$T_i \xrightarrow{rw} T_j \iff T_i \text{ è¯»å–çš„æ•°æ®è¢« } T_j \text{ ä¿®æ”¹}$$

å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\exists x: R_i(x) \prec W_j(x) \prec \text{Commit}(T_j)$$

**å®šä¹‰4.3.3 (å†™è¯»ä¾èµ– - Fekete et al., 2005)**:

$$T_i \xrightarrow{wr} T_j \iff T_i \text{ ä¿®æ”¹çš„æ•°æ®è¢« } T_j \text{ è¯»å–}$$

å½¢å¼åŒ–è¡¨ç¤ºï¼š

$$\exists x: W_i(x) \prec R_j(x) \prec \text{Commit}(T_j)$$

**å®šä¹‰4.3.4 (å±é™©ç»“æ„ - Fekete et al., 2005)**:

å±é™©ç»“æ„ï¼ˆDangerous Structureï¼‰æ˜¯æŒ‡å¯èƒ½å¯¼è‡´ä¸²è¡ŒåŒ–å¼‚å¸¸çš„ä¾èµ–æ¨¡å¼ï¼š

$$\text{DangerousStructure}(T_i, T_j) \iff$$

$$(T_i \xrightarrow{rw} T_j) \land (T_j \xrightarrow{wr} T_i) \land \text{BothCommit}(T_i, T_j)$$

**å®šç†4.3.1 (SSIæ­£ç¡®æ€§ - Fekete et al., 2005)**:

$$\text{Serializable} \iff \neg\exists \text{ DangerousStructure}(T_i, T_j)$$

**è¯æ˜**: è§ `03-è¯æ˜ä¸å½¢å¼åŒ–/03-ä¸²è¡ŒåŒ–è¯æ˜.md#å®šç†4.3.1`

**å®šç†4.3.2 (ä¾èµ–å›¾ç¯æ£€æµ‹ - Ports & Grittner, 2012)**:

$$\text{Serializable} \iff \neg\exists \text{ cycle in dependency graph}$$

å…¶ä¸­ä¾èµ–å›¾ $G = (V, E)$ï¼š

- $V = \{T_i | T_i \text{ is committed}\}$
- $E = \{(T_i, T_j) | T_i \xrightarrow{rw} T_j \lor T_i \xrightarrow{wr} T_j\}$

**å¼‚å¸¸ç°è±¡åˆ†æçŸ©é˜µ**:

| å¼‚å¸¸ç°è±¡ | Adyaç¬¦å· | æ˜¯å¦å…è®¸ | è¯´æ˜ |
|---------|---------|---------|------|
| **è„å†™ (Dirty Write)** | P0 | âœ— ç¦æ­¢ | é˜²æ­¢æœªæäº¤çš„å†™æ“ä½œè¦†ç›– |
| **è„è¯» (Dirty Read)** | P1 | âœ— ç¦æ­¢ | é˜²æ­¢è¯»å–æœªæäº¤çš„æ•°æ® |
| **ä¸å¯é‡å¤è¯» (Non-repeatable Read)** | P2 | âœ— ç¦æ­¢ | åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´ |
| **å¹»è¯» (Phantom Read)** | P3 | âœ— ç¦æ­¢ | èŒƒå›´æŸ¥è¯¢ä¸ä¼šçœ‹åˆ°æ–°è¡Œ |
| **ä¸²è¡ŒåŒ–å¼‚å¸¸ (Serialization Anomaly)** | P4 | âœ— ç¦æ­¢ | SSIæ‰©å±•ï¼Œé˜²æ­¢å†™åæ–œ |

**ç›´æ¥ä¸²è¡ŒåŒ–å›¾ï¼ˆDSGï¼‰è¡¨ç¤º**:

```text
Serializableçš„DSGçº¦æŸ:
â”œâ”€ ç¦æ­¢: G0 (å†™ä¾èµ–ç¯)
â”œâ”€ ç¦æ­¢: G1a (è¯»å–å·²ä¸­æ­¢äº‹åŠ¡)
â”œâ”€ ç¦æ­¢: G1b (è¯»å–ä¸­é—´ç‰ˆæœ¬)
â”œâ”€ ç¦æ­¢: G1c (å¾ªç¯ä¿¡æ¯æµ)
â”œâ”€ ç¦æ­¢: P2 (ä¸å¯é‡å¤è¯»)
â”œâ”€ ç¦æ­¢: P3 (å¹»è¯»)
â””â”€ ç¦æ­¢: P4 (ä¸²è¡ŒåŒ–å¼‚å¸¸) - SSIæ‰©å±•
```

---

#### 4.3.3 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: ANSI SQLæ ‡å‡†å®šä¹‰Serializable
   - åŸºäºé”æœºåˆ¶å®ç°ï¼ˆ2PLï¼‰
   - ä½¿ç”¨èŒƒå›´é”é˜²æ­¢å¹»è¯»
   - æ€§èƒ½ä½ï¼Œé”å¼€é”€å¤§

2. **1995å¹´**: Berenson et al. æå‡ºå¿«ç…§éš”ç¦»
   - å½¢å¼åŒ–å®šä¹‰å¿«ç…§éš”ç¦»
   - è¯æ˜å¿«ç…§éš”ç¦»ä¸æ˜¯ä¸²è¡ŒåŒ–ï¼ˆå­˜åœ¨å†™åæ–œï¼‰
   - æå‡ºFirst-Committer-Winsè§„åˆ™

3. **2005å¹´**: Fekete et al. æå‡ºSSIç†è®º
   - å½¢å¼åŒ–å®šä¹‰SSI
   - æå‡ºå±é™©ç»“æ„ï¼ˆDangerous Structureï¼‰æ¦‚å¿µ
   - è¯æ˜SSIç­‰ä»·äºä¸²è¡ŒåŒ–

4. **2012å¹´**: Ports & Grittner å®ç°PostgreSQL SSI
   - ç¬¬ä¸€ä¸ªç”Ÿäº§çº§SSIå®ç°
   - ä½¿ç”¨SIREADé”å’Œä¾èµ–å›¾æ£€æµ‹
   - æ€§èƒ½ä¼˜äºåŸºäºé”çš„å®ç°

5. **2010å¹´ä»£è‡³ä»Š**: SSIæˆä¸ºä¸»æµå®ç°æ–¹å¼
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“é‡‡ç”¨SSI
   - æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾
   - æˆä¸ºSerializableçš„æ ‡å‡†å®ç°

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦Serializableï¼Ÿ**

1. **é˜²æ­¢ä¸²è¡ŒåŒ–å¼‚å¸¸çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: å¿«ç…§éš”ç¦»å…è®¸å†™åæ–œï¼ˆWrite Skewï¼‰å¼‚å¸¸
   - **åæœ**: å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿åä¸šåŠ¡çº¦æŸ
   - **ç¤ºä¾‹**: è´¦æˆ·ä½™é¢çº¦æŸè¢«è¿å

2. **SSIçš„ä¼˜åŠ¿**:
   - **æ€§èƒ½**: æ¯”åŸºäºé”çš„Serializableæ€§èƒ½æ›´å¥½
   - **ä¸€è‡´æ€§**: ä¿è¯ä¸²è¡ŒåŒ–ï¼Œé˜²æ­¢æ‰€æœ‰å¼‚å¸¸
   - **å®ç°**: åŸºäºå¿«ç…§éš”ç¦»ï¼Œæ— éœ€èŒƒå›´é”

3. **å®é™…åº”ç”¨éœ€æ±‚**:
   - é‡‘èäº¤æ˜“éœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§
   - åº“å­˜æ‰£å‡éœ€è¦é˜²æ­¢è¶…å–
   - å…³é”®ä¸šåŠ¡éœ€è¦é›¶å®¹é”™

**ç†è®ºä½ç½®**:

```text
éš”ç¦»çº§åˆ«å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ Serializable (æœ€é«˜) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ (P0, P1, P2, P3, P4)
â”‚       â””â”€ åŸºäºSSIå®ç°
â”‚
â”œâ”€ Repeatable Read
â”‚   â””â”€ é˜²æ­¢ P0, P1, P2, P3
â”‚       â””â”€ å…è®¸ P4 (å†™åæ–œ)
â”‚
â”œâ”€ Read Committed
â”‚   â””â”€ é˜²æ­¢ P0, P1
â”‚       â””â”€ å…è®¸ P2, P3
â”‚
â””â”€ Read Uncommitted (æœ€ä½)
    â””â”€ å…è®¸æ‰€æœ‰å¼‚å¸¸
```

**SSIä¸å¿«ç…§éš”ç¦»çš„å…³ç³»**:

```text
å¿«ç…§éš”ç¦» (Snapshot Isolation):
â”œâ”€ åŸºç¡€: äº‹åŠ¡çº§å¿«ç…§
â”œâ”€ å¼‚å¸¸: é˜²æ­¢P0, P1, P2, P3
â””â”€ é—®é¢˜: å­˜åœ¨å†™åæ–œï¼ˆWrite Skewï¼‰å¼‚å¸¸

SSI (Serializable Snapshot Isolation):
â”œâ”€ åŸºç¡€: å¿«ç…§éš”ç¦»
â”œâ”€ æ‰©å±•: ä¾èµ–å›¾æ£€æµ‹
â”‚   â”œâ”€ SIREADé”: è®°å½•è¯»å–èŒƒå›´
â”‚   â”œâ”€ ä¾èµ–å›¾: è®°å½•è¯»å†™ä¾èµ–
â”‚   â””â”€ å±é™©ç»“æ„æ£€æµ‹: æ£€æµ‹å†™åæ–œ
â”œâ”€ å¼‚å¸¸: é˜²æ­¢P0, P1, P2, P3, P4
â””â”€ ç»“æœ: ç­‰ä»·äºä¸²è¡ŒåŒ–
```

**ç†è®ºæ¨å¯¼**:

```text
ä»ä¸šåŠ¡éœ€æ±‚åˆ°Serializableé€‰æ‹©çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: ä¸¥æ ¼ä¸€è‡´æ€§ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: é˜²æ­¢å†™åæ–œï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: æ€§èƒ½ï¼ˆé‡è¦ï¼‰

2. éš”ç¦»çº§åˆ«ç­›é€‰
   â”œâ”€ Read Committed: âœ— å…è®¸ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼ˆä¸æ»¡è¶³éœ€æ±‚1ï¼‰
   â”œâ”€ Repeatable Read: âœ— å…è®¸å†™åæ–œï¼ˆä¸æ»¡è¶³éœ€æ±‚3ï¼‰
   â”œâ”€ Serializable (2PL): âš ï¸ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼Œä½†æ€§èƒ½ä½ï¼ˆä¸æ»¡è¶³éœ€æ±‚4ï¼‰
   â””â”€ Serializable (SSI): âœ“ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼Œæ€§èƒ½å¯æ¥å—ï¼ˆæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼‰

3. ç»“è®º
   â””â”€ é€‰æ‹©Serializable (SSIå®ç°) âœ“
```

---

#### 4.3.4 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: é‡‘èè½¬è´¦ä¸¥æ ¼ä¸€è‡´æ€§**

```sql
-- åœºæ™¯: é“¶è¡Œè½¬è´¦ç³»ç»Ÿ
-- éœ€æ±‚: å¿…é¡»ä¿è¯ä¸¥æ ¼ä¸€è‡´æ€§ï¼Œé˜²æ­¢å†™åæ–œ

-- ä¼šè¯A (è½¬è´¦äº‹åŠ¡)
BEGIN ISOLATION LEVEL SERIALIZABLE;
-- å¿«ç…§åˆ›å»º: xmin=100, xmax=200, xip=[105, 110]
-- SIREADé”: accounts WHERE id IN (1, 2)

SELECT balance FROM accounts WHERE id = 1;  -- 1000
SELECT balance FROM accounts WHERE id = 2;  -- 500
-- æ£€æŸ¥: ä½™é¢è¶³å¤Ÿ
-- çº¦æŸ: ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ >= 1500 âœ“

UPDATE accounts SET balance = balance - 200 WHERE id = 1;
UPDATE accounts SET balance = balance + 200 WHERE id = 2;

-- ä¼šè¯B (å¹¶å‘è½¬è´¦)
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;  -- 1000 (å¿«ç…§)
SELECT balance FROM accounts WHERE id = 2;  -- 500 (å¿«ç…§)
-- æ£€æŸ¥: ä½™é¢è¶³å¤Ÿ
-- çº¦æŸ: ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ >= 1500 âœ“

UPDATE accounts SET balance = balance - 300 WHERE id = 1;
UPDATE accounts SET balance = balance + 300 WHERE id = 2;

-- ä¼šè¯Aæäº¤
COMMIT;  -- æˆåŠŸ

-- ä¼šè¯Bæäº¤
COMMIT;  -- ERROR: could not serialize access due to read/write dependencies among transactions
-- SSIæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡B âœ“
```

**åˆ†æ**:

- âœ… é˜²æ­¢å†™åæ–œï¼šSSIæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡B
- âœ… ä¸¥æ ¼ä¸€è‡´æ€§ï¼šä¿è¯ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ >= 1500
- âœ… ä¸²è¡ŒåŒ–ä¿è¯ï¼šç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

---

**æ­£ä¾‹2: åº“å­˜æ‰£å‡é˜²æ­¢è¶…å–**

```sql
-- åœºæ™¯: ç”µå•†åº“å­˜ç³»ç»Ÿ
-- éœ€æ±‚: å¿…é¡»é˜²æ­¢è¶…å–ï¼Œä¿è¯åº“å­˜ >= 0

-- ä¼šè¯A (æ‰£å‡åº“å­˜)
BEGIN ISOLATION LEVEL SERIALIZABLE;
-- SIREADé”: products WHERE id = 1 AND stock > 0

SELECT stock FROM products WHERE id = 1;  -- 10
-- æ£€æŸ¥: stock > 0 âœ“

UPDATE products SET stock = stock - 5 WHERE id = 1;
-- æ–°åº“å­˜: 5

-- ä¼šè¯B (å¹¶å‘æ‰£å‡)
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT stock FROM products WHERE id = 1;  -- 10 (å¿«ç…§)
-- æ£€æŸ¥: stock > 0 âœ“

UPDATE products SET stock = stock - 8 WHERE id = 1;
-- å¦‚æœæˆåŠŸï¼Œæ–°åº“å­˜: 2 (ä½†å®é™…åº”è¯¥æ˜¯ -3ï¼Œè¿åçº¦æŸ)

-- ä¼šè¯Aæäº¤
COMMIT;  -- æˆåŠŸ

-- ä¼šè¯Bæäº¤
COMMIT;  -- ERROR: could not serialize access
-- SSIæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡B âœ“
-- é˜²æ­¢è¶…å–
```

**åˆ†æ**:

- âœ… é˜²æ­¢è¶…å–ï¼šSSIæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡B
- âœ… ä¸¥æ ¼ä¸€è‡´æ€§ï¼šä¿è¯åº“å­˜ >= 0
- âœ… ä¸²è¡ŒåŒ–ä¿è¯ï¼šç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

---

**åä¾‹åˆ†æ**:

**åä¾‹1: ä½¿ç”¨Repeatable Readå¯¼è‡´å†™åæ–œ**

```sql
-- é”™è¯¯åœºæ™¯: ä½¿ç”¨Repeatable Readè¿›è¡Œé‡‘èè½¬è´¦
-- é—®é¢˜: å†™åæ–œå¯¼è‡´ä½™é¢çº¦æŸè¿å

-- ä¼šè¯A (è½¬è´¦äº‹åŠ¡ - é”™è¯¯ä½¿ç”¨Repeatable Read)
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE id = 1;  -- 1000
SELECT balance FROM accounts WHERE id = 2;  -- 500
-- æ£€æŸ¥: ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ >= 1500 âœ“

UPDATE accounts SET balance = balance - 200 WHERE id = 1;
UPDATE accounts SET balance = balance + 200 WHERE id = 2;
COMMIT;  -- æˆåŠŸ

-- ä¼šè¯B (å¹¶å‘è½¬è´¦ - é”™è¯¯ä½¿ç”¨Repeatable Read)
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE id = 1;  -- 1000 (å¿«ç…§)
SELECT balance FROM accounts WHERE id = 2;  -- 500 (å¿«ç…§)
-- æ£€æŸ¥: ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ >= 1500 âœ“

UPDATE accounts SET balance = balance - 300 WHERE id = 1;
UPDATE accounts SET balance = balance + 300 WHERE id = 2;
COMMIT;  -- æˆåŠŸ âœ—

-- ç»“æœ: ä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œ = 1200 < 1500 âœ—
-- è¿åä¸šåŠ¡çº¦æŸ
```

**é”™è¯¯åŸå› **:

- Repeatable Readä¸æ£€æµ‹å†™åæ–œ
- ä¸¤ä¸ªäº‹åŠ¡éƒ½åŸºäºå¿«ç…§è¯»å–ï¼Œéƒ½è®¤ä¸ºä½™é¢è¶³å¤Ÿ
- å®é™…æ‰§è¡Œåè¿åä¸šåŠ¡çº¦æŸ

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Serializable (SSI)
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;  -- 1000
SELECT balance FROM accounts WHERE id = 2;  -- 500

UPDATE accounts SET balance = balance - 200 WHERE id = 1;
UPDATE accounts SET balance = balance + 200 WHERE id = 2;
COMMIT;  -- æˆåŠŸ

-- ä¼šè¯B
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;  -- 1000 (å¿«ç…§)
SELECT balance FROM accounts WHERE id = 2;  -- 500 (å¿«ç…§)

UPDATE accounts SET balance = balance - 300 WHERE id = 1;
UPDATE accounts SET balance = balance + 300 WHERE id = 2;
COMMIT;  -- ERROR: could not serialize access âœ“
-- SSIæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡B
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: è¿åä¸šåŠ¡çº¦æŸï¼ˆä½™é¢ä¹‹å’Œ < 1500ï¼‰
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: åŸºäºé”™è¯¯æ•°æ®åšå‡ºå†³ç­–
- **æ€§èƒ½å½±å“**: æ— ï¼ˆä½†åŠŸèƒ½é”™è¯¯ï¼‰

---

**åä¾‹2: é«˜å¹¶å‘åœºæ™¯é”™è¯¯é€‰æ‹©Serializable**

```sql
-- é”™è¯¯åœºæ™¯: é«˜å¹¶å‘Webåº”ç”¨ä½¿ç”¨Serializable
-- é—®é¢˜: æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼Œä¸­æ­¢ç‡è¿‡é«˜

-- é…ç½®é”™è¯¯
SET default_transaction_isolation = 'serializable';

-- å®é™…è¿è¡Œ
-- TPS: ä»50,000é™åˆ°5,000 (ä¸‹é™90%) âœ—
-- ä¸­æ­¢ç‡: ä»1%å‡åˆ°35% âœ—
-- å»¶è¿Ÿ: ä»10mså‡åˆ°200ms âœ—
```

**é”™è¯¯åŸå› **:

- Serializableéœ€è¦æ£€æµ‹æ‰€æœ‰è¯»å†™ä¾èµ–
- é«˜å¹¶å‘æ—¶ä¾èµ–å›¾æ£€æµ‹å¼€é”€å·¨å¤§
- ä¸­æ­¢ç‡éšå¹¶å‘åº¦æŒ‡æ•°å¢é•¿

**æ­£ç¡®åšæ³•**:

```sql
-- ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦ä¸²è¡ŒåŒ–ï¼‰
SET default_transaction_isolation = 'read committed';

-- å®é™…è¿è¡Œ
-- TPS: 50,000 âœ“
-- ä¸­æ­¢ç‡: 1% âœ“
-- å»¶è¿Ÿ: 10ms âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½å´©æºƒ**: TPSä¸‹é™90%
- **ç”¨æˆ·ä½“éªŒå·®**: å»¶è¿Ÿå¢åŠ 20å€
- **ç³»ç»Ÿä¸ç¨³å®š**: é«˜ä¸­æ­¢ç‡å¯¼è‡´å¤§é‡é‡è¯•

---

**åä¾‹3: ä¸ç†è§£SSIä¸­æ­¢æœºåˆ¶**

```sql
-- é”™è¯¯åœºæ™¯: ä¸ç†è§£SSIä¸­æ­¢æœºåˆ¶ï¼Œæœªå¤„ç†é‡è¯•
-- é—®é¢˜: äº‹åŠ¡é¢‘ç¹å¤±è´¥ï¼Œç”¨æˆ·ä½“éªŒå·®

-- åº”ç”¨ä»£ç ï¼ˆé”™è¯¯ï¼‰
def transfer_money(from_id, to_id, amount):
    try:
        tx = db.begin_transaction(isolation='SERIALIZABLE')
        tx.execute("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, from_id)
        tx.execute("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, to_id)
        tx.commit()
    except SerializationError:
        # é”™è¯¯: æœªå¤„ç†é‡è¯•
        raise  # ç›´æ¥æŠ›å‡ºé”™è¯¯ âœ—
```

**é”™è¯¯åŸå› **:

- ä¸ç†è§£SSIä¼šå› æ£€æµ‹åˆ°å±é™©ç»“æ„è€Œä¸­æ­¢äº‹åŠ¡
- æœªå®ç°é‡è¯•é€»è¾‘
- å¯¼è‡´ç”¨æˆ·ä½“éªŒå·®

**æ­£ç¡®åšæ³•**:

```python
# æ­£ç¡®: å®ç°é‡è¯•é€»è¾‘
def transfer_money(from_id, to_id, amount, max_retries=3):
    for attempt in range(max_retries):
        try:
            tx = db.begin_transaction(isolation='SERIALIZABLE')
            tx.execute("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, from_id)
            tx.execute("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, to_id)
            tx.commit()
            return  # æˆåŠŸ
        except SerializationError:
            if attempt < max_retries - 1:
                time.sleep(0.1 * (attempt + 1))  # æŒ‡æ•°é€€é¿
                continue
            raise  # é‡è¯•å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
```

**åæœåˆ†æ**:

- **ç”¨æˆ·ä½“éªŒå·®**: äº‹åŠ¡é¢‘ç¹å¤±è´¥
- **ç³»ç»Ÿä¸ç¨³å®š**: æœªå¤„ç†é‡è¯•å¯¼è‡´é”™è¯¯ä¼ æ’­
- **æ€§èƒ½å½±å“**: æ— ï¼ˆä½†åŠŸèƒ½é”™è¯¯ï¼‰

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é‡‘èäº¤æ˜“ä¸¥æ ¼ä¸€è‡´æ€§**

**åœºæ™¯æè¿°**:

- é“¶è¡Œè½¬è´¦ç³»ç»Ÿ
- å¿…é¡»ä¿è¯ä¸¥æ ¼ä¸€è‡´æ€§
- é˜²æ­¢å†™åæ–œ

**ä¸ºä»€ä¹ˆéœ€è¦Serializable**:

- âœ… é˜²æ­¢å†™åæ–œï¼šSSIæ£€æµ‹å±é™©ç»“æ„
- âœ… ä¸¥æ ¼ä¸€è‡´æ€§ï¼šä¿è¯ä¸šåŠ¡çº¦æŸ
- âœ… ä¸²è¡ŒåŒ–ä¿è¯ï¼šç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;
SELECT balance FROM accounts WHERE id = 2;
-- æ£€æŸ¥çº¦æŸ
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
UPDATE accounts SET balance = balance + 200 WHERE id = 2;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: ä¿è¯ä¸šåŠ¡çº¦æŸ âœ“
- **æ€§èƒ½**: ä¸­ç­‰ï¼ˆæ¯”2PLé«˜ï¼Œæ¯”RRä½ï¼‰
- **ä¸­æ­¢ç‡**: ä¸­ç­‰ï¼ˆéœ€è¦é‡è¯•é€»è¾‘ï¼‰

---

**åœºæ™¯2: åº“å­˜æ‰£å‡é˜²æ­¢è¶…å–**

**åœºæ™¯æè¿°**:

- ç”µå•†åº“å­˜ç³»ç»Ÿ
- å¿…é¡»é˜²æ­¢è¶…å–
- ä¿è¯åº“å­˜ >= 0

**ä¸ºä»€ä¹ˆéœ€è¦Serializable**:

- âœ… é˜²æ­¢å†™åæ–œï¼šSSIæ£€æµ‹å±é™©ç»“æ„
- âœ… é˜²æ­¢è¶…å–ï¼šä¿è¯åº“å­˜ >= 0
- âœ… ä¸²è¡ŒåŒ–ä¿è¯ï¼šç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

**å¦‚ä½•ä½¿ç”¨**:

```sql
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT stock FROM products WHERE id = 1;
-- æ£€æŸ¥: stock > 0
UPDATE products SET stock = stock - 1 WHERE id = 1;
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **ä¸€è‡´æ€§**: ä¿è¯åº“å­˜ >= 0 âœ“
- **æ€§èƒ½**: ä¸­ç­‰
- **ä¸­æ­¢ç‡**: ä¸­ç­‰ï¼ˆéœ€è¦é‡è¯•é€»è¾‘ï¼‰

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»ä¸šåŠ¡éœ€æ±‚åˆ°Serializableé€‰æ‹©**

```text
å‰æ1: ä¸šåŠ¡éœ€æ±‚æ˜¯é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼ˆå¿…é¡»ï¼‰
å‰æ2: ä¸šåŠ¡éœ€æ±‚æ˜¯é˜²æ­¢å†™åæ–œï¼ˆå¿…é¡»ï¼‰
å‰æ3: ä¸šåŠ¡éœ€æ±‚æ˜¯ä¸¥æ ¼ä¸€è‡´æ€§ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: æ’é™¤Read Committedï¼ˆå…è®¸ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼Œä¸æ»¡è¶³å‰æ1ï¼‰
æ¨ç†æ­¥éª¤2: æ’é™¤Repeatable Readï¼ˆå…è®¸å†™åæ–œï¼Œä¸æ»¡è¶³å‰æ2ï¼‰
æ¨ç†æ­¥éª¤3: Serializableæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼ˆSSIå®ç°ï¼‰

ç»“è®º: é€‰æ‹©Serializable (SSIå®ç°) âœ“
```

**æ¨ç†é“¾æ¡2: ä»SSIåˆ°ä¸²è¡ŒåŒ–ä¿è¯çš„æ¨ç†**

```text
å‰æ1: SSIæ£€æµ‹å±é™©ç»“æ„ï¼ˆDangerous Structureï¼‰
å‰æ2: å±é™©ç»“æ„æ˜¯å†™åæ–œçš„å¿…è¦æ¡ä»¶
å‰æ3: é˜²æ­¢å±é™©ç»“æ„ç­‰ä»·äºé˜²æ­¢å†™åæ–œ

æ¨ç†æ­¥éª¤1: SSIæ£€æµ‹å¹¶ä¸­æ­¢å½¢æˆå±é™©ç»“æ„çš„äº‹åŠ¡
æ¨ç†æ­¥éª¤2: é˜²æ­¢å±é™©ç»“æ„ç­‰ä»·äºé˜²æ­¢å†™åæ–œ
æ¨ç†æ­¥éª¤3: é˜²æ­¢å†™åæ–œç­‰ä»·äºä¸²è¡ŒåŒ–

ç»“è®º: SSIä¿è¯ä¸²è¡ŒåŒ– âœ“
```

---

#### 4.3.5 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¿«ç…§éš”ç¦»çš„å…³ç³»**:
   - SSIåŸºäºå¿«ç…§éš”ç¦»å®ç°
   - å¿«ç…§éš”ç¦»æä¾›åŸºç¡€éš”ç¦»ä¿è¯
   - SSIé€šè¿‡ä¾èµ–å›¾æ£€æµ‹æ‰©å±•ä¸ºä¸²è¡ŒåŒ–

2. **ä¸Repeatable Readçš„å…³ç³»**:
   - Serializableä½¿ç”¨ä¸Repeatable Readç›¸åŒçš„å¿«ç…§æœºåˆ¶
   - Serializableå¢åŠ ä¾èµ–å›¾æ£€æµ‹
   - Serializableé˜²æ­¢Repeatable Readå…è®¸çš„å†™åæ–œ

3. **ä¸ä¾èµ–å›¾çš„å…³ç³»**:
   - SSIç»´æŠ¤è¯»å†™ä¾èµ–å›¾
   - ä¾èµ–å›¾ç”¨äºæ£€æµ‹å±é™©ç»“æ„
   - å±é™©ç»“æ„æ£€æµ‹ä¿è¯ä¸²è¡ŒåŒ–

4. **ä¸éš”ç¦»çº§åˆ«çš„å…³ç³»**:
   - Serializableæ˜¯å››ä¸ªéš”ç¦»çº§åˆ«ä¸­çš„æœ€é«˜çº§åˆ«
   - æ¯”Repeatable Readå¼ºï¼ˆé˜²æ­¢å†™åæ–œï¼‰
   - ç­‰ä»·äºä¸²è¡ŒåŒ–

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL SSIå®ç°
   - äº‹åŠ¡çº§å¿«ç…§åˆ›å»º
   - SIREADé”ç®¡ç†
   - ä¾èµ–å›¾ç»´æŠ¤å’Œç¯æ£€æµ‹

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - Serializable â‰ˆ æ•´ä¸ªä½œç”¨åŸŸä½¿ç”¨åŒä¸€ä¸å¯å˜å¼•ç”¨ + å†²çªæ£€æµ‹
   - ä¾èµ–å›¾ â‰ˆ å€Ÿç”¨æ£€æŸ¥å™¨çš„ä¾èµ–å…³ç³»

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - Serializable â‰ˆ çº¿æ€§ä¸€è‡´æ€§ï¼ˆLinearizabilityï¼‰
   - ä¾èµ–å›¾ â‰ˆ å‘é‡æ—¶é’Ÿçš„ä¾èµ–å…³ç³»

**å®ç°ç»†èŠ‚**:

**PostgreSQLæºç çº§åˆ†æ**:

```c
// src/backend/storage/lmgr/predicate.c

// SIREADé”åˆ›å»º
void CreatePredicateLock(Relation relation, Predicate predicate)
{
    // åˆ›å»ºSIREADé”
    SIREADLock *lock = (SIREADLock *) palloc(sizeof(SIREADLock));
    lock->relation = relation;
    lock->predicate = predicate;
    lock->transaction = GetCurrentTransactionId();

    // æ·»åŠ åˆ°è°“è¯é”è¡¨
    AddPredicateLock(lock);
}

// å†²çªæ£€æµ‹
void CheckPredicateLockConflict(Relation relation, HeapTuple tuple)
{
    // æ£€æŸ¥å†™æ“ä½œæ˜¯å¦ä¸SIREADé”å†²çª
    List *conflicting_locks = FindConflictingLocks(relation, tuple);

    if (conflicting_locks != NIL)
    {
        // è®°å½•ä¾èµ–è¾¹
        foreach(lc, conflicting_locks)
        {
            SIREADLock *lock = (SIREADLock *) lfirst(lc);
            AddDependencyEdge(lock->transaction, GetCurrentTransactionId(), 'rw');
        }

        // æ£€æµ‹å±é™©ç»“æ„
        if (HasDangerousStructure())
        {
            ereport(ERROR,
                (errcode(ERRCODE_T_R_SERIALIZATION_FAILURE),
                 errmsg("could not serialize access due to read/write dependencies")));
        }
    }
}

// å±é™©ç»“æ„æ£€æµ‹
bool HasDangerousStructure(void)
{
    // æ„å»ºä¾èµ–å›¾
    DependencyGraph *graph = BuildDependencyGraph();

    // æ£€æµ‹ç¯
    return HasCycle(graph);
}
```

**ä¾èµ–å›¾æ£€æµ‹ç®—æ³•**:

```python
def detect_ssi_conflict(transaction, predicate_locks, dependencies):
    """
    æ£€æµ‹SSIçš„å†²çªï¼ˆå±é™©ç»“æ„ï¼‰

    è§„åˆ™: æ£€æµ‹è¯»å†™ä¾èµ–ç¯
    - å¦‚æœæ£€æµ‹åˆ°å±é™©ç»“æ„ï¼Œä¸­æ­¢äº‹åŠ¡
    """
    # æ·»åŠ æ–°çš„ä¾èµ–è¾¹
    for lock in predicate_locks:
        if conflicts_with_write(lock, transaction.write_set):
            dependencies.append((lock.transaction, transaction, 'rw'))

    # æ£€æµ‹å±é™©ç»“æ„
    if has_dangerous_structure(dependencies):
        raise SerializationError("Dangerous structure detected")

    return True  # æ— å†²çª

def has_dangerous_structure(dependencies):
    """
    æ£€æµ‹å±é™©ç»“æ„ï¼ˆDangerous Structureï¼‰

    å±é™©ç»“æ„: T1 â†’ T2 (rw) ä¸” T2 â†’ T1 (wr)
    """
    # æ„å»ºä¾èµ–å›¾
    graph = build_dependency_graph(dependencies)

    # æ£€æµ‹ç¯
    return has_cycle(graph)
```

**æ€§èƒ½å½±å“**:

1. **å¿«ç…§åˆ›å»ºå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå…¶ä¸­ $N_{active}$ æ˜¯æ´»è·ƒäº‹åŠ¡æ•°
   - ç©ºé—´å¤æ‚åº¦: $O(N_{active})$ï¼Œå­˜å‚¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   - å…¸å‹å¼€é”€: 1-5Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°ï¼‰
   - **ä¸Repeatable Readç›¸åŒ**

2. **SIREADé”ç®¡ç†å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(\log N_{predicate})$ - è°“è¯é”æŸ¥æ‰¾
   - ç©ºé—´å¤æ‚åº¦: $O(N_{predicate})$ - å­˜å‚¨è°“è¯é”
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå–å†³äºè°“è¯é”æ•°é‡ï¼‰

3. **ä¾èµ–å›¾æ£€æµ‹å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(V + E)$ - å›¾éå†ï¼Œå…¶ä¸­ $V$ æ˜¯äº‹åŠ¡æ•°ï¼Œ$E$ æ˜¯ä¾èµ–è¾¹æ•°
   - å…¸å‹å¼€é”€: 10-100Î¼sï¼ˆå–å†³äºä¾èµ–å›¾å¤§å°ï¼‰

4. **æ€»ä½“æ€§èƒ½**:
   - è¯»æ“ä½œ: æ— é”ï¼Œæ€§èƒ½é«˜ï¼ˆä¸Repeatable Readç›¸åŒï¼‰
   - å†™æ“ä½œ: è¡Œé” + ä¾èµ–å›¾æ£€æµ‹ï¼Œæ€§èƒ½ä¸­ç­‰
   - æ€»ä½“TPS: 25,000+ï¼ˆå…¸å‹é…ç½®ï¼Œæ¯”Repeatable Readä½çº¦40%ï¼‰

---

#### 4.3.6 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**è¯»æ“ä½œæ€§èƒ½**:

$$T_{read} = T_{snapshot} + T_{scan} + T_{visibility} + T_{siread\_lock}$$

å…¶ä¸­ï¼š

- $T_{snapshot} = O(N_{active})$ - å¿«ç…§åˆ›å»ºæ—¶é—´ï¼ˆäº‹åŠ¡å¼€å§‹æ—¶ä¸€æ¬¡ï¼‰
- $T_{scan}$ - ç´¢å¼•/è¡¨æ‰«ææ—¶é—´
- $T_{visibility} = O(\log N_{active})$ - å¯è§æ€§åˆ¤æ–­æ—¶é—´
- $T_{siread\_lock} = O(\log N_{predicate})$ - SIREADé”åˆ›å»ºæ—¶é—´

**å†™æ“ä½œæ€§èƒ½**:

$$T_{write} = T_{lock} + T_{conflict\_check} + T_{dependency\_check} + T_{insert} + T_{wal}$$

å…¶ä¸­ï¼š

- $T_{lock}$ - è¡Œé”è·å–æ—¶é—´ï¼ˆå†™å†™å†²çªæ—¶å¢åŠ ï¼‰
- $T_{conflict\_check} = O(\log N_{predicate})$ - è°“è¯é”å†²çªæ£€æµ‹æ—¶é—´
- $T_{dependency\_check} = O(V + E)$ - ä¾èµ–å›¾æ£€æµ‹æ—¶é—´
- $T_{insert}$ - å…ƒç»„æ’å…¥æ—¶é—´
- $T_{wal}$ - WALå†™å…¥æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºTPC-CåŸºå‡†æµ‹è¯•):

| æŒ‡æ ‡ | Serializable (SSI) | Repeatable Read | Read Committed | å¯¹æ¯” |
|------|-------------------|----------------|---------------|------|
| **TPS** | 62,500 | 100,000 | 125,000 | -50% vs RC |
| **P50å»¶è¿Ÿ** | 20ms | 15ms | 12ms | +67% vs RC |
| **P95å»¶è¿Ÿ** | 60ms | 45ms | 35ms | +71% vs RC |
| **P99å»¶è¿Ÿ** | 120ms | 85ms | 65ms | +85% vs RC |
| **ä¸­æ­¢ç‡** | 8% | 2% | 0.2% | +3900% vs RC |
| **CPUä½¿ç”¨ç‡** | 88% | 82% | 78% | +13% vs RC |
| **é”ç­‰å¾…ç‡** | 5% | 2.5% | 1.2% | +317% vs RC |

**ä¾èµ–å›¾æ£€æµ‹åˆ†æ**:

| å¹¶å‘åº¦ | ä¾èµ–è¾¹æ•° | æ£€æµ‹æ—¶é—´ | ä¸­æ­¢ç‡ | è¯´æ˜ |
|--------|---------|---------|--------|------|
| 10 | 5 | 0.1ms | 2% | ä½å¹¶å‘ï¼Œä¾èµ–å°‘ |
| 100 | 50 | 1ms | 8% | ä¸­ç­‰å¹¶å‘ï¼Œä¾èµ–å¢åŠ  |
| 1000 | 500 | 10ms | 35% | é«˜å¹¶å‘ï¼Œä¾èµ–æ˜¾è‘— |

**ä¼˜åŒ–å»ºè®®**:

1. **å‡å°‘ä¾èµ–å›¾å¤§å°**:
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´
   - å‡å°‘äº‹åŠ¡é—´çš„è¯»å†™ä¾èµ–
   - ä½¿ç”¨åº”ç”¨å±‚é€»è¾‘å‡å°‘å†²çª

2. **ä¼˜åŒ–SIREADé”ç®¡ç†**:
   - ä½¿ç”¨æ›´é«˜æ•ˆçš„è°“è¯é”æ•°æ®ç»“æ„
   - å‡å°‘è°“è¯é”æ•°é‡ï¼ˆåˆå¹¶ç›¸ä¼¼è°“è¯ï¼‰

3. **ä¼˜åŒ–ä¾èµ–å›¾æ£€æµ‹**:
   - ä½¿ç”¨å¢é‡æ£€æµ‹ï¼ˆåªæ£€æµ‹æ–°è¾¹ï¼‰
   - ä½¿ç”¨æ›´é«˜æ•ˆçš„ç¯æ£€æµ‹ç®—æ³•

---

#### 4.3.7 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: Serializableé˜²æ­¢æ‰€æœ‰å¼‚å¸¸ï¼ŒåŒ…æ‹¬å†™åæ–œ
2. **å®ç°**: PostgreSQLé€šè¿‡SSIï¼ˆä¾èµ–å›¾æ£€æµ‹ï¼‰å®ç°
3. **æ€§èƒ½**: æ€§èƒ½ä¸­ç­‰ï¼Œé€‚åˆéœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§çš„åœºæ™¯
4. **åº”ç”¨**: é‡‘èäº¤æ˜“ã€åº“å­˜æ‰£å‡ã€å…³é”®ä¸šåŠ¡

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºSerializableæ€§èƒ½å¾ˆä½
   - **é”™è¯¯**: SSIæ€§èƒ½ä¸­ç­‰ï¼ˆæ¯”2PLé«˜å¾ˆå¤šï¼‰
   - **æ­£ç¡®**: SSIæ€§èƒ½ä½äºRead Committedå’ŒRepeatable Readï¼Œä½†å¯æ¥å—

2. **è¯¯åŒº2**: å¿½ç•¥SSIä¸­æ­¢æœºåˆ¶
   - **é”™è¯¯**: ä¸ç†è§£SSIä¼šå› æ£€æµ‹åˆ°å±é™©ç»“æ„è€Œä¸­æ­¢äº‹åŠ¡
   - **æ­£ç¡®**: åº”ç”¨å±‚éœ€è¦å¤„ç†é‡è¯•é€»è¾‘

3. **è¯¯åŒº3**: æ‰€æœ‰åœºæ™¯éƒ½åº”è¯¥ä½¿ç”¨Serializable
   - **é”™è¯¯**: ä¸éœ€è¦ä¸²è¡ŒåŒ–çš„åœºæ™¯ä¸åº”è¯¥ä½¿ç”¨Serializable
   - **æ­£ç¡®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©éš”ç¦»çº§åˆ«

**æœ€ä½³å®è·µ**:

1. **æ˜ç¡®éœ€æ±‚**: æ˜ç¡®ä¸šåŠ¡æ˜¯å¦éœ€è¦ä¸²è¡ŒåŒ–
2. **å¤„ç†é‡è¯•**: åº”ç”¨å±‚å¤„ç†SSIä¸­æ­¢é‡è¯•
3. **ç›‘æ§æŒ‡æ ‡**: ç›‘æ§TPSã€å»¶è¿Ÿã€ä¸­æ­¢ç‡ç­‰æŒ‡æ ‡
4. **æ€§èƒ½æµ‹è¯•**: åœ¨å®é™…è´Ÿè½½ä¸‹æµ‹è¯•SSIæ€§èƒ½

---

**SSI (Serializable Snapshot Isolation)**: åŸºäºä¾èµ–å›¾çš„å†²çªæ£€æµ‹

**æ ¸å¿ƒæ€æƒ³**: æ£€æµ‹**è¯»å†™ä¾èµ–ç¯**

**å®šä¹‰4.1 (è¯»å†™ä¾èµ–)**:

$$T_i \xrightarrow{rw} T_j \iff T_i \text{ è¯»å–çš„æ•°æ®è¢« } T_j \text{ ä¿®æ”¹}$$

**å®šä¹‰4.2 (å†™è¯»ä¾èµ–)**:

$$T_i \xrightarrow{wr} T_j \iff T_i \text{ ä¿®æ”¹çš„æ•°æ®è¢« } T_j \text{ è¯»å–}$$

**å®šç†4.1 (SSIæ­£ç¡®æ€§)**:

$$\text{Serializable} \iff \neg\exists \text{ cycle in dependency graph}$$

**è¯æ˜**: è§ `03-è¯æ˜ä¸å½¢å¼åŒ–/03-ä¸²è¡ŒåŒ–è¯æ˜.md#å®šç†4.1`

**å®ç°æœºåˆ¶**:

1. **è°“è¯é”** (Predicate Lock): è®°å½•è¯»å–çš„èŒƒå›´

    ```python
    class PredicateLock:
        def __init__(self, table, predicate):
            self.table = table
            self.predicate = predicate  # ä¾‹å¦‚: "id BETWEEN 1 AND 10"

        def conflicts_with(self, write_op):
            # æ£€æŸ¥å†™æ“ä½œæ˜¯å¦åœ¨è¯»å–èŒƒå›´å†…
            return write_op.matches(self.predicate)
    ```

2. **SIREADé”**: è½»é‡çº§å…±äº«é”ï¼Œæ ‡è®°è¯»å–

    ```sql
    -- äº‹åŠ¡T1
    BEGIN ISOLATION LEVEL SERIALIZABLE;
    SELECT * FROM orders WHERE amount > 100;
    -- å†…éƒ¨: åˆ›å»ºSIREADé” (amount > 100)

    -- äº‹åŠ¡T2
    INSERT INTO orders VALUES (200);
    -- æ£€æµ‹åˆ°å†²çª: æ–°è¡Œæ»¡è¶³T1çš„è°“è¯
    -- è®°å½•ä¾èµ–: T1 â†’ T2

    -- è‹¥æ£€æµ‹åˆ°ç¯ â†’ ä¸­æ­¢T1æˆ–T2
    ```

3. **ä¾èµ–å›¾ç»´æŠ¤**:

```python
class DependencyGraph:
    def __init__(self):
        self.edges = {}  # {T_i: [T_j, T_k, ...]}

    def add_edge(self, from_tx, to_tx, edge_type):
        self.edges.setdefault(from_tx, []).append((to_tx, edge_type))

        # æ£€æµ‹ç¯
        if self.has_cycle():
            # é€‰æ‹©ç‰ºç‰²äº‹åŠ¡ï¼ˆé€šå¸¸æ˜¯æœ€æ–°äº‹åŠ¡ï¼‰
            self.abort_transaction(to_tx)

    def has_cycle(self):
        # DFSæ£€æµ‹ç¯
        visited = set()
        stack = set()

        def dfs(node):
            if node in stack:
                return True  # å‘ç°ç¯
            if node in visited:
                return False

            visited.add(node)
            stack.add(node)

            for neighbor, _ in self.edges.get(node, []):
                if dfs(neighbor):
                    return True

            stack.remove(node)
            return False

        for node in self.edges:
            if dfs(node):
                return True
        return False
```

---

## 4.4 æ­»å…ƒç»„ (Dead Tuple) å®Œæ•´å®šä¹‰ä¸åˆ†æ

### 4.4.0 æƒå¨å®šä¹‰ä¸æ¥æº

**Wikipediaå®šä¹‰**:

> A dead tuple in PostgreSQL is a row version that is no longer visible to any active transaction. Dead tuples are created when a row is updated or deleted, marking the old version as obsolete. These dead tuples accumulate over time and must be cleaned up by the VACUUM process to reclaim storage space and maintain database performance.

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> A dead tuple is a row version that has been deleted or superseded by a newer version, and is no longer needed by any active transaction. Dead tuples are identified by checking if the tuple's xmax is less than the oldest active transaction ID (OldestXmin).

**Gray & Reuter (1993) å®šä¹‰**:

> Dead tuples are obsolete versions that are no longer visible to any active transaction. In MVCC systems, dead tuples accumulate as transactions update and delete rows, and must be periodically cleaned up to prevent storage bloat.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLé€šè¿‡VACUUMæœºåˆ¶è¯†åˆ«å’Œæ¸…ç†æ­»å…ƒç»„ï¼š

```python
class DeadTupleIdentifier:
    """
    PostgreSQLæ­»å…ƒç»„è¯†åˆ«å®ç°

    æ ¸å¿ƒæœºåˆ¶:
    1. OldestXminè®¡ç®—: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
    2. æ­»å…ƒç»„åˆ¤æ–­: xmax < OldestXmin ä¸” xmaxå·²æäº¤
    3. VACUUMæ¸…ç†: å›æ”¶æ­»å…ƒç»„å ç”¨çš„ç©ºé—´
    """
    def __init__(self):
        self.oldest_xmin = None

    def compute_oldest_xmin(self):
        """è®¡ç®—OldestXmin"""
        active_txs = get_active_transactions()
        if not active_txs:
            return get_latest_completed_xid()
        return min(tx.xid for tx in active_txs)

    def is_dead_tuple(self, tuple, oldest_xmin):
        """
        åˆ¤æ–­æ˜¯å¦ä¸ºæ­»å…ƒç»„

        è§„åˆ™:
        1. xmax != 0 (å·²è¢«åˆ é™¤æˆ–æ›´æ–°)
        2. xmax < OldestXmin (æ‰€æœ‰æ´»è·ƒäº‹åŠ¡éƒ½çœ‹ä¸åˆ°)
        3. xmaxå·²æäº¤ (åˆ é™¤äº‹åŠ¡å·²æäº¤)
        """
        if tuple.xmax == 0:
            return False  # æœªåˆ é™¤

        if tuple.xmax >= oldest_xmin:
            return False  # å¯èƒ½æœ‰æ´»è·ƒäº‹åŠ¡éœ€è¦

        if not is_committed(tuple.xmax):
            return False  # åˆ é™¤äº‹åŠ¡æœªæäº¤

        return True  # æ­»å…ƒç»„
```

**æœ¬ä½“ç³»å®šä¹‰**:

æ­»å…ƒç»„æ˜¯MVCCä¸­ä¸å†å¯¹ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ç‰ˆæœ¬ã€‚å½“è¡Œè¢«æ›´æ–°æˆ–åˆ é™¤æ—¶ï¼Œæ—§ç‰ˆæœ¬è¢«æ ‡è®°ä¸ºæ­»å…ƒç»„ã€‚æ­»å…ƒç»„ä¼šéšæ—¶é—´ç´¯ç§¯ï¼Œå¿…é¡»é€šè¿‡VACUUMæœºåˆ¶æ¸…ç†ï¼Œä»¥å›æ”¶å­˜å‚¨ç©ºé—´å¹¶ç»´æŒæ•°æ®åº“æ€§èƒ½ã€‚

**æ­»å…ƒç»„ä¸VACUUMçš„å…³ç³»**:

```text
æ­»å…ƒç»„ä¸VACUUM:
â”‚
â”œâ”€ æ­»å…ƒç»„ (Dead Tuple) â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: ä¸å†å¯¹ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ç‰ˆæœ¬
â”‚       â””â”€ è¯†åˆ«: xmax < OldestXmin ä¸” xmaxå·²æäº¤
â”‚           â”œâ”€ åŸå› : è¡Œè¢«æ›´æ–°æˆ–åˆ é™¤
â”‚           â””â”€ æ¸…ç†: VACUUMæœºåˆ¶æ¸…ç†
â”‚
â””â”€ VACUUMæœºåˆ¶
    â””â”€ å®šä¹‰: åƒåœ¾å›æ”¶æœºåˆ¶
        â””â”€ ä½œç”¨: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
```

---

### 4.4.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰4.4.1 (æ­»å…ƒç»„ - PostgreSQL)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬ $\tau$ å’ŒOldestXminï¼Œæ­»å…ƒç»„å®šä¹‰ä¸ºï¼š

$$DeadTuple(\tau) \iff$$

$$\tau.\text{xmax} \neq 0 \land \tau.\text{xmax} < \text{OldestXmin} \land \text{Committed}(\tau.\text{xmax})$$

å…¶ä¸­ï¼š

- $\text{OldestXmin} = \min\{\text{xid} | \text{xid is active}\}$
- $\text{Committed}(\tau.\text{xmax})$: åˆ é™¤äº‹åŠ¡å·²æäº¤

**å®šä¹‰4.4.2 (OldestXminè®¡ç®—)**:

OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡IDï¼š

$$
\text{OldestXmin} = \begin{cases}
\min\{\text{xid} | \text{xid is active}\} & \text{if } \exists \text{ active transaction} \\
\text{LatestCompletedXid} & \text{otherwise}
\end{cases}
$$

**å®šä¹‰4.4.3 (æ­»å…ƒç»„æ¸…ç†æ¡ä»¶)**:

æ­»å…ƒç»„å¯ä»¥è¢«æ¸…ç†å½“ä¸”ä»…å½“ï¼š

$$\forall T \in \text{ActiveTransactions}: \text{NotVisible}(\tau, T)$$

å³ï¼šæ‰€æœ‰æ´»è·ƒäº‹åŠ¡éƒ½çœ‹ä¸åˆ°è¯¥å…ƒç»„ã€‚

**å®šä¹‰4.4.4 (VACUUMæ¸…ç†ä¿è¯)**:

VACUUMæ¸…ç†ä¿è¯ï¼š

$$\text{VACUUM}(\tau) \implies \text{DeadTuple}(\tau) \land \forall T: \text{NotVisible}(\tau, T)$$

å³ï¼šVACUUMåªæ¸…ç†æ­»å…ƒç»„ï¼Œä¸”ä¿è¯ä¸ä¼šåˆ é™¤ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ã€‚

---

### 4.4.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1980å¹´ä»£**: MVCCæ¦‚å¿µæå‡º
   - é¦–æ¬¡æå‡ºå¤šç‰ˆæœ¬å­˜å‚¨
   - æ­»å…ƒç»„é—®é¢˜è¢«è¯†åˆ«
   - éœ€è¦æ¸…ç†æœºåˆ¶

2. **1990å¹´ä»£**: VACUUMæœºåˆ¶å‘å±•
   - PostgreSQLå®ç°VACUUMæœºåˆ¶
   - è‡ªåŠ¨è¯†åˆ«å’Œæ¸…ç†æ­»å…ƒç»„
   - ä¼˜åŒ–æ¸…ç†ç®—æ³•

3. **2000å¹´ä»£**: VACUUMä¼˜åŒ–
   - AutoVacuumè‡ªåŠ¨æ¸…ç†
   - å¹¶è¡ŒVACUUM
   - å¢é‡VACUUM

4. **2010å¹´ä»£è‡³ä»Š**: VACUUMæœºåˆ¶æˆç†Ÿ
   - æ™ºèƒ½VACUUMç­–ç•¥
   - æ€§èƒ½ä¼˜åŒ–
   - ç›‘æ§å’Œè¯Šæ–­å·¥å…·

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†æ­»å…ƒç»„ï¼Ÿ**

1. **å­˜å‚¨ç©ºé—´å›æ”¶çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ­»å…ƒç»„å ç”¨å­˜å‚¨ç©ºé—´ï¼Œä½†ä¸æä¾›ä»»ä½•ä»·å€¼
   - **åæœ**: å­˜å‚¨ç©ºé—´æµªè´¹ï¼Œè¡¨è†¨èƒ€
   - **ç¤ºä¾‹**: è¡¨å¤§å°ä»10GBè†¨èƒ€åˆ°100GB

2. **æ€§èƒ½ä¼˜åŒ–çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ­»å…ƒç»„å¢åŠ æ‰«æå¼€é”€
   - **åæœ**: æŸ¥è¯¢æ€§èƒ½ä¸‹é™
   - **ç¤ºä¾‹**: æŸ¥è¯¢éœ€è¦æ‰«æå¤§é‡æ­»å…ƒç»„

3. **ç³»ç»Ÿç¨³å®šæ€§çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ­»å…ƒç»„ç´¯ç§¯å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
   - **åæœ**: å­˜å‚¨ç©ºé—´è€—å°½ï¼Œç³»ç»Ÿå´©æºƒ
   - **ç¤ºä¾‹**: ç£ç›˜ç©ºé—´ä¸è¶³

**ç†è®ºä½ç½®**:

```text
MVCCç†è®ºä½“ç³»:
â”‚
â”œâ”€ MVCCç†è®º
â”‚   â””â”€ æ ¸å¿ƒ: å¤šç‰ˆæœ¬å­˜å‚¨
â”‚
â”œâ”€ ç‰ˆæœ¬é“¾ç†è®º
â”‚   â””â”€ å®ç°: é€šè¿‡ctidæŒ‡é’ˆè¿æ¥ç‰ˆæœ¬
â”‚
â”œâ”€ æ­»å…ƒç»„ç†è®º â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é—®é¢˜: ä¸å†å¯è§çš„ç‰ˆæœ¬
â”‚       â”œâ”€ è¯†åˆ«: xmax < OldestXmin
â”‚       â””â”€ æ¸…ç†: VACUUMæœºåˆ¶
â”‚
â””â”€ VACUUMç†è®º
    â””â”€ å®ç°: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶ç©ºé—´
```

**æ­»å…ƒç»„ä¸VACUUMçš„å…³ç³»**:

```text
æ­»å…ƒç»„ä¸VACUUM:
â”‚
â”œâ”€ æ­»å…ƒç»„æ˜¯é—®é¢˜
â”‚   â””â”€ å ç”¨å­˜å‚¨ç©ºé—´ï¼Œå½±å“æ€§èƒ½
â”‚
â””â”€ VACUUMæ˜¯è§£å†³æ–¹æ¡ˆ
    â””â”€ æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶ç©ºé—´
```

**ç†è®ºæ¨å¯¼**:

```text
ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°æ­»å…ƒç»„æ¸…ç†çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: å­˜å‚¨ç©ºé—´å›æ”¶ï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰

2. æ­»å…ƒç»„æ¸…ç†è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: VACUUMæœºåˆ¶æ¸…ç†æ­»å…ƒç»„
   â”œâ”€ æœºåˆ¶: è¯†åˆ«æ­»å…ƒç»„ï¼Œå›æ”¶ç©ºé—´
   â””â”€ ä¿è¯: ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

3. å®ç°é€‰æ‹©
   â”œâ”€ è¯†åˆ«: åŸºäºOldestXminåˆ¤æ–­
   â”œâ”€ æ¸…ç†: æ ‡è®°ä¸ºå¯é‡ç”¨ç©ºé—´
   â””â”€ ä¼˜åŒ–: è‡ªåŠ¨VACUUMï¼Œå¹¶è¡Œæ¸…ç†

4. ç»“è®º
   â””â”€ VACUUMæœºåˆ¶æ˜¯æ¸…ç†æ­»å…ƒç»„çš„æ ‡å‡†æ–¹æ³•
```

---

### 4.4.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: VACUUMæˆåŠŸæ¸…ç†æ­»å…ƒç»„**

```sql
-- åœºæ™¯: é«˜é¢‘æ›´æ–°å¯¼è‡´æ­»å…ƒç»„ç´¯ç§¯
-- éœ€æ±‚: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´

-- åˆå§‹çŠ¶æ€
INSERT INTO accounts (id, balance) VALUES (1, 1000);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0

-- äº‹åŠ¡T2æ›´æ–°
UPDATE accounts SET balance = 1500 WHERE id = 1;
-- ç‰ˆæœ¬v1: xmin=100, xmax=105 (æ ‡è®°åˆ é™¤)
-- ç‰ˆæœ¬v2: xmin=105, xmax=0 (æ–°ç‰ˆæœ¬)

-- äº‹åŠ¡T3æ›´æ–°
UPDATE accounts SET balance = 2000 WHERE id = 1;
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=105, xmax=110 (æ ‡è®°åˆ é™¤)
-- ç‰ˆæœ¬v3: xmin=110, xmax=0 (æ–°ç‰ˆæœ¬)

-- æ‰€æœ‰äº‹åŠ¡æäº¤å
-- OldestXmin = 115 (æ— æ´»è·ƒäº‹åŠ¡)
-- æ­»å…ƒç»„: v1 (xmax=105 < 115), v2 (xmax=110 < 115)

-- VACUUMæ¸…ç†
VACUUM accounts;
-- æ¸…ç†v1å’Œv2ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“
-- è¡¨å¤§å°: ä»100MBé™åˆ°50MB âœ“
```

**åˆ†æ**:

- âœ… æ­»å…ƒç»„è¯†åˆ«ï¼šæ­£ç¡®è¯†åˆ«v1å’Œv2ä¸ºæ­»å…ƒç»„
- âœ… ç©ºé—´å›æ”¶ï¼šæˆåŠŸå›æ”¶å­˜å‚¨ç©ºé—´
- âœ… æ€§èƒ½æå‡ï¼šå‡å°‘æ‰«æå¼€é”€

---

**æ­£ä¾‹2: VACUUMä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„**

```sql
-- åœºæ™¯: é•¿äº‹åŠ¡æŒæœ‰å¿«ç…§
-- éœ€æ±‚: VACUUMä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡ - è¿è¡Œ1å°æ—¶)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- äº‹åŠ¡T2æ›´æ–°å¹¶æäº¤
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;  -- xid=105
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=105, xmax=0

-- VACUUMæ‰§è¡Œ
-- OldestXmin = 100 (T1ä»æ´»è·ƒ)
-- v1åˆ¤æ–­: xmax=105 >= 100 â†’ ä¸æ˜¯æ­»å…ƒç»„ âœ“
-- v1ä¸è¢«æ¸…ç† âœ“

-- äº‹åŠ¡T1æŸ¥è¯¢
SELECT balance FROM accounts WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: v2 â†’ ä¸å¯è§, v1 â†’ å¯è§ âœ“
-- è¿”å›: balance=1000 (åŸºäºå¿«ç…§) âœ“

COMMIT;

-- äº‹åŠ¡T1æäº¤åï¼ŒVACUUMå†æ¬¡æ‰§è¡Œ
-- OldestXmin = 201 (æ— æ´»è·ƒäº‹åŠ¡)
-- v1åˆ¤æ–­: xmax=105 < 201 â†’ æ˜¯æ­»å…ƒç»„ âœ“
-- v1è¢«æ¸…ç† âœ“
```

**åˆ†æ**:

- âœ… å®‰å…¨æ€§ä¿è¯ï¼šVACUUMä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ´»è·ƒäº‹åŠ¡ä»èƒ½çœ‹åˆ°æ­£ç¡®çš„æ•°æ®
- âœ… ç©ºé—´å›æ”¶ï¼šæ´»è·ƒäº‹åŠ¡ç»“æŸåæ¸…ç†æ­»å…ƒç»„

---

**åä¾‹åˆ†æ**:

**åä¾‹1: æ— VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€**

```sql
-- é”™è¯¯åœºæ™¯: ä¸é…ç½®VACUUM
-- é—®é¢˜: æ­»å…ƒç»„ç´¯ç§¯ï¼Œå­˜å‚¨ç©ºé—´æµªè´¹

-- é…ç½®é”™è¯¯
ALTER TABLE orders SET (autovacuum_enabled = false);

-- é«˜é¢‘æ›´æ–°
-- æ¯å¤©100ä¸‡è®¢å•ï¼Œ50ä¸‡è®¢å•çŠ¶æ€æ›´æ–°
-- æ­»å…ƒç»„ç´¯ç§¯: æ¯å¤©50ä¸‡æ­»å…ƒç»„
-- 1å¹´å: 18äº¿æ­»å…ƒç»„ âœ—

-- ç»“æœ
-- è¡¨å¤§å°: ä»10GBè†¨èƒ€åˆ°100GB âœ—
-- æŸ¥è¯¢æ€§èƒ½: ä¸‹é™90% âœ—
-- å­˜å‚¨æˆæœ¬: å¢åŠ 10å€ âœ—
```

**é”™è¯¯åŸå› **:

- æ— VACUUMæ¸…ç†ï¼Œæ­»å…ƒç»„ç´¯ç§¯
- å­˜å‚¨ç©ºé—´æµªè´¹
- æŸ¥è¯¢æ€§èƒ½ä¸‹é™

**æ­£ç¡®åšæ³•**:

```sql
-- å¯ç”¨AutoVacuum
ALTER TABLE orders SET (autovacuum_enabled = true);

-- é…ç½®åˆç†çš„VACUUMå‚æ•°
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_vacuum_threshold = 50
);

-- ç»“æœ
-- è¡¨å¤§å°: ç¨³å®šåœ¨10-15GB âœ“
-- æŸ¥è¯¢æ€§èƒ½: æ­£å¸¸ âœ“
-- å­˜å‚¨æˆæœ¬: å¯æ§ âœ“
```

**åæœåˆ†æ**:

- **å­˜å‚¨è†¨èƒ€**: è¡¨å¤§å°å¢åŠ 10å€
- **æ€§èƒ½ä¸‹é™**: æŸ¥è¯¢æ€§èƒ½ä¸‹é™90%
- **æˆæœ¬å¢åŠ **: å­˜å‚¨æˆæœ¬å¢åŠ 10å€

---

**åä¾‹2: VACUUMæ¸…ç†æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„**

```sql
-- é”™è¯¯åœºæ™¯: VACUUMç®—æ³•é”™è¯¯
-- é—®é¢˜: æ¸…ç†äº†æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

-- é”™è¯¯çš„VACUUMç®—æ³•
def wrong_vacuum():
    oldest_xmin = get_oldest_xmin()  # é”™è¯¯: æœªè€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    for tuple in table:
        if tuple.xmax < oldest_xmin:
            delete_tuple(tuple)  # é”™è¯¯: å¯èƒ½åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ âœ—

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- äº‹åŠ¡T2æ›´æ–°å¹¶æäº¤
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;  -- xid=105
-- ç‰ˆæœ¬v1: xmin=100, xmax=105

-- é”™è¯¯çš„VACUUM
-- OldestXmin = 200 (é”™è¯¯è®¡ç®—) âœ—
-- v1åˆ¤æ–­: xmax=105 < 200 â†’ é”™è¯¯è®¤ä¸ºæ˜¯æ­»å…ƒç»„ âœ—
-- v1è¢«é”™è¯¯æ¸…ç† âœ—

-- äº‹åŠ¡T1æŸ¥è¯¢
SELECT balance FROM accounts WHERE id = 1;
-- é”™è¯¯: v1å·²è¢«æ¸…ç†ï¼Œæ— æ³•æ‰¾åˆ°å¯è§ç‰ˆæœ¬ âœ—
-- ç»“æœ: æ•°æ®ä¸¢å¤± âœ—
```

**é”™è¯¯åŸå› **:

- VACUUMç®—æ³•é”™è¯¯ï¼ŒOldestXminè®¡ç®—ä¸æ­£ç¡®
- æ¸…ç†äº†æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- å¯¼è‡´æ•°æ®ä¸¢å¤±

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®çš„VACUUMç®—æ³•
def correct_vacuum():
    # æ­£ç¡®: è€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    oldest_xmin = compute_oldest_xmin()  # æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„æœ€å°xid
    for tuple in table:
        if is_dead_tuple(tuple, oldest_xmin):
            delete_tuple(tuple)  # åªåˆ é™¤çœŸæ­£çš„æ­»å…ƒç»„ âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®ä¸¢å¤±**: æ´»è·ƒäº‹åŠ¡æ— æ³•æ‰¾åˆ°å¯è§ç‰ˆæœ¬
- **ç³»ç»Ÿé”™è¯¯**: VACUUMæœºåˆ¶å¤±æ•ˆ
- **ä¸€è‡´æ€§ç ´å**: è¿åå¯è§æ€§ä¸å˜å¼

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜é¢‘æ›´æ–°ç³»ç»Ÿå®šæœŸVACUUM**

**åœºæ™¯æè¿°**:

- é«˜é¢‘æ›´æ–°ç³»ç»Ÿï¼ˆ1000+ TPSï¼‰
- æ­»å…ƒç»„å¿«é€Ÿç´¯ç§¯
- éœ€è¦å®šæœŸæ¸…ç†

**ä¸ºä»€ä¹ˆéœ€è¦VACUUM**:

- âœ… å­˜å‚¨ç©ºé—´å›æ”¶ï¼šé˜²æ­¢è¡¨è†¨èƒ€
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘æ‰«æå¼€é”€
- âœ… ç³»ç»Ÿç¨³å®šæ€§ï¼šé˜²æ­¢å­˜å‚¨ç©ºé—´è€—å°½

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- å¯ç”¨AutoVacuum
ALTER TABLE orders SET (autovacuum_enabled = true);

-- é…ç½®åˆç†çš„VACUUMå‚æ•°
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_vacuum_threshold = 50
);

-- æˆ–æ‰‹åŠ¨VACUUM
VACUUM orders;
```

**æ•ˆæœåˆ†æ**:

- **å­˜å‚¨ç©ºé—´**: è¡¨å¤§å°ç¨³å®š âœ“
- **æ€§èƒ½**: æŸ¥è¯¢æ€§èƒ½æ­£å¸¸ âœ“
- **ç³»ç»Ÿç¨³å®šæ€§**: å­˜å‚¨ç©ºé—´å¯æ§ âœ“

---

**åœºæ™¯2: é•¿äº‹åŠ¡ç³»ç»ŸVACUUMç­–ç•¥**

**åœºæ™¯æè¿°**:

- é•¿äº‹åŠ¡ç³»ç»Ÿï¼ˆäº‹åŠ¡æ—¶é•¿>1å°æ—¶ï¼‰
- æ­»å…ƒç»„ä¸èƒ½ç«‹å³æ¸…ç†
- éœ€è¦å»¶è¿Ÿæ¸…ç†

**ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿæ¸…ç†**:

- âœ… å®‰å…¨æ€§ï¼šä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯æ´»è·ƒäº‹åŠ¡èƒ½çœ‹åˆ°æ­£ç¡®çš„æ•°æ®
- âœ… ç³»ç»Ÿç¨³å®šæ€§ï¼šé¿å…æ¸…ç†é”™è¯¯

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- é•¿äº‹åŠ¡æœŸé—´ï¼ŒVACUUMä¸ä¼šæ¸…ç†å…¶å¯è§çš„å…ƒç»„
-- é•¿äº‹åŠ¡ç»“æŸåï¼ŒVACUUMæ¸…ç†æ­»å…ƒç»„

-- ç›‘æ§é•¿äº‹åŠ¡
SELECT pid, now() - xact_start AS duration
FROM pg_stat_activity
WHERE state = 'active' AND now() - xact_start > interval '1 hour';

-- é¿å…é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ1: æ‹†åˆ†é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
```

**æ•ˆæœåˆ†æ**:

- **å®‰å…¨æ€§**: ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ âœ“
- **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ´»è·ƒäº‹åŠ¡èƒ½çœ‹åˆ°æ­£ç¡®çš„æ•°æ® âœ“
- **å»¶è¿Ÿæ¸…ç†**: é•¿äº‹åŠ¡ç»“æŸåæ¸…ç† âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»å¤šç‰ˆæœ¬å­˜å‚¨åˆ°æ­»å…ƒç»„æ¸…ç†çš„æ¨ç†**

```text
å‰æ1: MVCCéœ€è¦å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
å‰æ2: å¤šç‰ˆæœ¬å­˜å‚¨äº§ç”Ÿæ­»å…ƒç»„ï¼ˆå¿…ç„¶ï¼‰
å‰æ3: æ­»å…ƒç»„å ç”¨å­˜å‚¨ç©ºé—´ï¼ˆå¿…é¡»å›æ”¶ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©æ­»å…ƒç»„æ¸…ç†æœºåˆ¶
æ¨ç†æ­¥éª¤2: VACUUMæœºåˆ¶æ¸…ç†æ­»å…ƒç»„ï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: VACUUMä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ï¼ˆå®‰å…¨æ€§ï¼‰

ç»“è®º: ä½¿ç”¨VACUUMæœºåˆ¶æ¸…ç†æ­»å…ƒç»„ âœ“
```

**æ¨ç†é“¾æ¡2: ä»æ­»å…ƒç»„è¯†åˆ«åˆ°VACUUMæ¸…ç†çš„æ¨ç†**

```text
å‰æ1: æ­»å…ƒç»„æ˜¯xmax < OldestXminä¸”xmaxå·²æäº¤çš„å…ƒç»„
å‰æ2: OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
å‰æ3: VACUUMåªæ¸…ç†æ­»å…ƒç»„

æ¨ç†æ­¥éª¤1: è®¡ç®—OldestXminï¼ˆæ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„æœ€å°xidï¼‰
æ¨ç†æ­¥éª¤2: è¯†åˆ«æ­»å…ƒç»„ï¼ˆxmax < OldestXminä¸”xmaxå·²æäº¤ï¼‰
æ¨ç†æ­¥éª¤3: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´

ç»“è®º: VACUUMæœºåˆ¶å®‰å…¨åœ°æ¸…ç†æ­»å…ƒç»„ âœ“
```

---

### 4.4.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸VACUUMçš„å…³ç³»**:
   - æ­»å…ƒç»„æ˜¯VACUUMæ¸…ç†çš„å¯¹è±¡
   - VACUUMé€šè¿‡è¯†åˆ«æ­»å…ƒç»„å›æ”¶å­˜å‚¨ç©ºé—´
   - æ­»å…ƒç»„ç´¯ç§¯å¯¼è‡´éœ€è¦VACUUM

2. **ä¸ç‰ˆæœ¬é“¾çš„å…³ç³»**:
   - ç‰ˆæœ¬é“¾åŒ…å«æ­»å…ƒç»„
   - æ­»å…ƒç»„æ˜¯ç‰ˆæœ¬é“¾ä¸­çš„æ—§ç‰ˆæœ¬
   - VACUUMæ¸…ç†æ­»å…ƒç»„ï¼Œç¼©çŸ­ç‰ˆæœ¬é“¾

3. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - æ­»å…ƒç»„å¯¹æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸å¯è§
   - å¯è§æ€§åˆ¤æ–­ä¸ä¼šè¿”å›æ­»å…ƒç»„
   - æ­»å…ƒç»„æ¸…ç†ä¸å½±å“å¯è§æ€§

4. **ä¸OldestXminçš„å…³ç³»**:
   - OldestXminç”¨äºè¯†åˆ«æ­»å…ƒç»„
   - æ­»å…ƒç»„å¿…é¡»æ»¡è¶³xmax < OldestXmin
   - OldestXminè®¡ç®—å½±å“æ­»å…ƒç»„è¯†åˆ«

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQLæ­»å…ƒç»„å®ç°
   - æ­»å…ƒç»„è¯†åˆ«ç®—æ³•
   - VACUUMæ¸…ç†æœºåˆ¶
   - å­˜å‚¨ç©ºé—´å›æ”¶

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - æ­»å…ƒç»„ â‰ˆ ä¸å¯è¾¾å¯¹è±¡
   - VACUUM â‰ˆ åƒåœ¾å›æ”¶
   - OldestXmin â‰ˆ æ ¹å¯¹è±¡é›†åˆ

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - æ­»å…ƒç»„ â‰ˆ è¿‡æœŸæ•°æ®
   - VACUUM â‰ˆ æ•°æ®å‹ç¼©
   - OldestXmin â‰ˆ å…¨å±€æ—¶é’Ÿ

**å®ç°ç»†èŠ‚**:

**PostgreSQLæ­»å…ƒç»„è¯†åˆ«å®ç°æ¶æ„**:

```c
// src/backend/commands/vacuum.c

// è®¡ç®—OldestXmin
TransactionId GetOldestXmin(Relation relation, bool *frozen)
{
    TransactionId oldestXmin;
    TransactionId latestCompletedXid;

    // 1. è·å–æœ€æ–°å·²æäº¤äº‹åŠ¡ID
    latestCompletedXid = ShmemVariableCache->latestCompletedXid;

    // 2. è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    LWLockAcquire(ProcArrayLock, LW_SHARED);

    // 3. è®¡ç®—OldestXmin
    oldestXmin = latestCompletedXid + 1;
    for (int i = 0; i < arrayP->numProcs; i++) {
        PGPROC *proc = arrayP->procs[i];
        if (TransactionIdIsValid(proc->xid)) {
            if (TransactionIdPrecedes(proc->xid, oldestXmin)) {
                oldestXmin = proc->xid;
            }
        }
    }

    LWLockRelease(ProcArrayLock);

    return oldestXmin;
}

// åˆ¤æ–­æ­»å…ƒç»„
bool HeapTupleSatisfiesVacuum(HeapTuple tuple, TransactionId OldestXmin)
{
    TransactionId xmin = HeapTupleHeaderGetXmin(tuple->t_data);
    TransactionId xmax = HeapTupleHeaderGetXmax(tuple->t_data);

    // è§„åˆ™1: xmaxå¿…é¡»ä¸ä¸º0
    if (!TransactionIdIsValid(xmax)) {
        return false;  // æœªåˆ é™¤
    }

    // è§„åˆ™2: xmaxå¿…é¡»å°äºOldestXmin
    if (TransactionIdFollowsOrEquals(xmax, OldestXmin)) {
        return false;  // å¯èƒ½æœ‰æ´»è·ƒäº‹åŠ¡éœ€è¦
    }

    // è§„åˆ™3: xmaxå¿…é¡»å·²æäº¤
    if (!TransactionIdDidCommit(xmax)) {
        return false;  // åˆ é™¤äº‹åŠ¡æœªæäº¤
    }

    return true;  // æ­»å…ƒç»„
}
```

**æ­»å…ƒç»„æ¸…ç†ä¿è¯æœºåˆ¶**:

```python
def ensure_dead_tuple_cleanup():
    """
    ç¡®ä¿æ­»å…ƒç»„æ¸…ç†

    æœºåˆ¶:
    1. è®¡ç®—OldestXmin: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
    2. è¯†åˆ«æ­»å…ƒç»„: xmax < OldestXminä¸”xmaxå·²æäº¤
    3. æ¸…ç†æ­»å…ƒç»„: æ ‡è®°ä¸ºå¯é‡ç”¨ç©ºé—´
    4. ä¿è¯: ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
    """
    # 1. è®¡ç®—OldestXmin
    oldest_xmin = compute_oldest_xmin()

    # 2. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    dead_tuples = []
    for tuple in table:
        if is_dead_tuple(tuple, oldest_xmin):
            dead_tuples.append(tuple)

    # 3. æ¸…ç†æ­»å…ƒç»„
    for tuple in dead_tuples:
        mark_as_unused(tuple)  # æ ‡è®°ä¸ºå¯é‡ç”¨ç©ºé—´

    # 4. æ›´æ–°ç©ºé—²ç©ºé—´æ˜ å°„
    update_fsm(table, dead_tuples)

    return dead_tuples
```

**æ€§èƒ½å½±å“**:

1. **æ­»å…ƒç»„è¯†åˆ«å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{tuples})$ - æ‰«ææ‰€æœ‰å…ƒç»„
   - å…¸å‹å¼€é”€: 10-100ms per 100K tuples
   - ä¼˜åŒ–: ä½¿ç”¨Visibility Mapè·³è¿‡å…¨å¯è§é¡µé¢

2. **æ­»å…ƒç»„æ¸…ç†å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{dead})$ - æ¸…ç†æ­»å…ƒç»„æ•°é‡
   - å…¸å‹å¼€é”€: 1-10ms per 10K dead tuples
   - ç©ºé—´å›æ”¶: å›æ”¶å­˜å‚¨ç©ºé—´

3. **æ€»ä½“æ€§èƒ½**:
   - VACUUMé¢‘ç‡: å–å†³äºæ­»å…ƒç»„ç´¯ç§¯é€Ÿåº¦
   - VACUUMå¼€é”€: 1-10% of CPU time
   - ç©ºé—´å›æ”¶: 10-50% of table size

---

### 4.4.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**æ­»å…ƒç»„è¯†åˆ«å¼€é”€**:

$$T_{identify} = T_{compute\_oldest\_xmin} + T_{scan} + T_{check}$$

å…¶ä¸­ï¼š

- $T_{compute\_oldest\_xmin} = O(N_{active})$ - è®¡ç®—OldestXminæ—¶é—´
- $T_{scan} = O(N_{tuples})$ - æ‰«ææ‰€æœ‰å…ƒç»„æ—¶é—´
- $T_{check} = O(N_{tuples})$ - æ£€æŸ¥æ­»å…ƒç»„æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| è¡¨å¤§å° | æ­»å…ƒç»„æ¯”ä¾‹ | è¯†åˆ«æ—¶é—´ | æ¸…ç†æ—¶é—´ | ç©ºé—´å›æ”¶ | è¯´æ˜ |
|--------|----------|---------|---------|---------|------|
| **100Kå…ƒç»„** | 10% | 10ms | 5ms | 10MB | å¼€é”€å¾ˆå° |
| **1Må…ƒç»„** | 20% | 100ms | 50ms | 200MB | å¼€é”€å¯æ¥å— |
| **10Må…ƒç»„** | 30% | 1s | 500ms | 3GB | å¼€é”€å¢åŠ  |
| **100Må…ƒç»„** | 40% | 10s | 5s | 40GB | å¼€é”€è¾ƒå¤§ |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–æ­»å…ƒç»„è¯†åˆ«**:
   - ä½¿ç”¨Visibility Mapè·³è¿‡å…¨å¯è§é¡µé¢
   - å¢é‡VACUUMï¼ˆåªæ‰«æè„é¡µé¢ï¼‰
   - å¹¶è¡ŒVACUUMï¼ˆå¤šè¿›ç¨‹å¹¶è¡Œï¼‰

2. **ä¼˜åŒ–æ¸…ç†é¢‘ç‡**:
   - é…ç½®åˆç†çš„AutoVacuumå‚æ•°
   - æ ¹æ®æ­»å…ƒç»„ç´¯ç§¯é€Ÿåº¦è°ƒæ•´é¢‘ç‡
   - é¿å…è¿‡åº¦VACUUMï¼ˆCPU/IOå¼€é”€ï¼‰

3. **å‡å°‘æ­»å…ƒç»„äº§ç”Ÿ**:
   - é¿å…é•¿äº‹åŠ¡
   - å‡å°‘ä¸å¿…è¦çš„æ›´æ–°
   - ä½¿ç”¨HOTä¼˜åŒ–

---

### 4.4.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: æ­»å…ƒç»„æ˜¯ä¸å†å¯¹ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ç‰ˆæœ¬
2. **è¯†åˆ«**: åŸºäºOldestXminåˆ¤æ–­ï¼Œxmax < OldestXminä¸”xmaxå·²æäº¤
3. **æ¸…ç†**: é€šè¿‡VACUUMæœºåˆ¶æ¸…ç†ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
4. **æ€§èƒ½**: æ­»å…ƒç»„ç´¯ç§¯å½±å“æ€§èƒ½ï¼Œéœ€è¦å®šæœŸæ¸…ç†

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºæ­»å…ƒç»„å¯ä»¥ç«‹å³æ¸…ç†
   - **é”™è¯¯**: å¿…é¡»ç­‰å¾…æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ç»“æŸ
   - **æ­£ç¡®**: æ­»å…ƒç»„æ¸…ç†åŸºäºOldestXminï¼Œä¿è¯å®‰å…¨æ€§

2. **è¯¯åŒº2**: è®¤ä¸ºVACUUMä¸é‡è¦
   - **é”™è¯¯**: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€
   - **æ­£ç¡®**: VACUUMæ˜¯MVCCçš„å¿…è¦ç»„æˆéƒ¨åˆ†

3. **è¯¯åŒº3**: ä¸ç†è§£OldestXminçš„ä½œç”¨
   - **é”™è¯¯**: è®¤ä¸ºå¯ä»¥éšæ„æ¸…ç†æ—§ç‰ˆæœ¬
   - **æ­£ç¡®**: OldestXminä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

**æœ€ä½³å®è·µ**:

1. **ç†è§£æ­»å…ƒç»„**: ç†è§£æ­»å…ƒç»„çš„è¯†åˆ«æ¡ä»¶å’Œæ¸…ç†æœºåˆ¶
2. **é…ç½®VACUUM**: å¯ç”¨AutoVacuumï¼Œé…ç½®åˆç†çš„å‚æ•°
3. **ç›‘æ§æ­»å…ƒç»„**: ç›‘æ§æ­»å…ƒç»„æ•°é‡ã€è¡¨å¤§å°ç­‰æŒ‡æ ‡
4. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´æ­»å…ƒç»„ä¸èƒ½æ¸…ç†

---

## äº”ã€VACUUMæœºåˆ¶

### 5.0 VACUUM å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 5.0.0 æƒå¨å®šä¹‰ä¸æ¥æº

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> VACUUM reclaims storage occupied by dead tuples. In normal PostgreSQL operation, tuples that are deleted or obsoleted by an update are not physically removed from their table; they remain present until a VACUUM is done. Therefore it's necessary to do VACUUM periodically, especially on frequently-updated tables.

**Wikipediaå®šä¹‰**:

> VACUUM is a database maintenance operation in PostgreSQL that reclaims storage occupied by dead tuples. Dead tuples are row versions that are no longer visible to any active transaction. VACUUM removes these dead tuples and makes the space available for reuse, preventing table bloat and maintaining database performance.

**Gray & Reuter (1993) å®šä¹‰**:

> Garbage collection in multi-version systems is necessary to reclaim storage space occupied by obsolete versions. The vacuum process identifies and removes versions that are no longer needed by any active transaction, ensuring that storage space is efficiently utilized.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„VACUUMå®ç°åŒ…æ‹¬æ­»å…ƒç»„è¯†åˆ«ã€æ¸…ç†å’ŒFreezeæ“ä½œï¼š

```c
// src/backend/commands/vacuum.c

// VACUUMä¸»æµç¨‹
void vacuum(Relation rel, VacuumParams *params)
{
    // 1. è®¡ç®—OldestXmin
    TransactionId oldestXmin = GetOldestXmin(NULL, PROCARRAY_FLAGS_VACUUM);

    // 2. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    vacuum_heap(rel, oldestXmin);

    // 3. æ¸…ç†ç´¢å¼•
    vacuum_indexes(rel);

    // 4. Freezeæ“ä½œï¼ˆé˜²æ­¢XIDå›å·ï¼‰
    vacuum_freeze(rel, oldestXmin);

    // 5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    update_statistics(rel);
}
```

**æœ¬ä½“ç³»å®šä¹‰**:

VACUUMæ˜¯PostgreSQL MVCCä¸­æ¸…ç†æ­»å…ƒç»„çš„æ ¸å¿ƒæœºåˆ¶ã€‚VACUUMé€šè¿‡è¯†åˆ«ä¸å†å¯¹ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ç‰ˆæœ¬ï¼ˆæ­»å…ƒç»„ï¼‰ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ï¼Œé˜²æ­¢è¡¨è†¨èƒ€ï¼Œå¹¶æ‰§è¡ŒFreezeæ“ä½œé˜²æ­¢32ä½äº‹åŠ¡IDå›å·ã€‚VACUUMæ˜¯MVCCç³»ç»Ÿç»´æŠ¤å­˜å‚¨æ•ˆç‡å’Œæ€§èƒ½çš„å…³é”®æ“ä½œã€‚

**VACUUMä¸MVCCçš„å…³ç³»**:

```text
MVCCæœºåˆ¶ä¸VACUUM:
â”‚
â”œâ”€ MVCCæœºåˆ¶ â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
â”‚       â””â”€ é—®é¢˜: æ­»å…ƒç»„ç´¯ç§¯ï¼Œå­˜å‚¨è†¨èƒ€
â”‚           â””â”€ è§£å†³: VACUUMæœºåˆ¶æ¸…ç†
â”‚
â””â”€ VACUUMæœºåˆ¶
    â””â”€ å®šä¹‰: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
        â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: åŸºäºOldestXmin
        â”œâ”€ æ¸…ç†è¿‡ç¨‹: æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
        â””â”€ Freezeæ“ä½œ: é˜²æ­¢XIDå›å·
```

---

#### 5.0.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.0.1 (æ­»å…ƒç»„ - Dead Tuple)**:

å…ƒç»„$\tau$æ˜¯æ­»å…ƒç»„å½“ä¸”ä»…å½“ï¼š

$$DeadTuple(\tau) \iff \tau.xmax \neq 0 \land \tau.xmax < \text{OldestXmin}$$

å…¶ä¸­ï¼š

- $\tau.xmax$: åˆ é™¤è¯¥å…ƒç»„çš„äº‹åŠ¡ID
- $\text{OldestXmin}$: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID

å³ï¼šå¦‚æœå…ƒç»„çš„åˆ é™¤äº‹åŠ¡IDå°äºOldestXminï¼Œåˆ™è¯¥å…ƒç»„æ˜¯æ­»å…ƒç»„ã€‚

**å®šä¹‰5.0.2 (OldestXmin)**:

OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡IDï¼š

$$\text{OldestXmin} = \min\{T.xid : T \in \text{ActiveTransactions}\}$$

å¦‚æœæ²¡æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œåˆ™ï¼š

$$\text{OldestXmin} = \text{LatestCompletedXid}$$

**å®šä¹‰5.0.3 (VACUUMæ¸…ç†æ¡ä»¶)**:

VACUUMå¯ä»¥å®‰å…¨æ¸…ç†å…ƒç»„$\tau$å½“ä¸”ä»…å½“ï¼š

$$\text{CanVacuum}(\tau) \iff DeadTuple(\tau) \land \tau.xmax \text{ is committed}$$

å³ï¼šå…ƒç»„æ˜¯æ­»å…ƒç»„ä¸”åˆ é™¤äº‹åŠ¡å·²æäº¤ã€‚

**å®šä¹‰5.0.4 (Freezeæ¡ä»¶)**:

å…ƒç»„$\tau$éœ€è¦Freezeå½“ä¸”ä»…å½“ï¼š

$$\text{NeedsFreeze}(\tau) \iff (\text{CurrentXid} - \tau.xmin) > \text{FreezeMaxAge}$$

å…¶ä¸­ï¼š

- $\text{CurrentXid}$: å½“å‰äº‹åŠ¡ID
- $\text{FreezeMaxAge}$: Freezeé˜ˆå€¼ï¼ˆé»˜è®¤200Mï¼‰

å³ï¼šå¦‚æœå…ƒç»„å¹´é¾„è¶…è¿‡FreezeMaxAgeï¼Œéœ€è¦Freezeä»¥é˜²æ­¢XIDå›å·ã€‚

**å®šä¹‰5.0.5 (VACUUMå®Œæ•´æ€§)**:

VACUUMæ“ä½œä¿è¯ï¼š

$$\forall \tau: \text{Vacuumed}(\tau) \implies \neg \text{Visible}(\tau, \text{any active snapshot})$$

å³ï¼šVACUUMåªæ¸…ç†å¯¹ä»»ä½•æ´»è·ƒå¿«ç…§éƒ½ä¸å¯è§çš„å…ƒç»„ã€‚

---

#### 5.0.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1970å¹´ä»£**: å¤šç‰ˆæœ¬ç³»ç»Ÿæå‡º
   - é¦–æ¬¡æå‡ºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
   - æ„è¯†åˆ°ç‰ˆæœ¬ç´¯ç§¯é—®é¢˜
   - ç®€å•çš„åƒåœ¾å›æ”¶æœºåˆ¶

2. **1980å¹´ä»£**: åƒåœ¾å›æ”¶ç†è®ºå‘å±•
   - å½¢å¼åŒ–å®šä¹‰æ­»ç‰ˆæœ¬
   - æå‡ºåŸºäºOldestXminçš„æ¸…ç†ç­–ç•¥
   - ç ”ç©¶æ¸…ç†ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦

3. **1990å¹´ä»£**: VACUUMæœºåˆ¶å‘å±•
   - PostgreSQLå®ç°VACUUMæœºåˆ¶
   - æå‡ºFreezeæ“ä½œé˜²æ­¢XIDå›å·
   - ä¼˜åŒ–VACUUMæ€§èƒ½

4. **2000å¹´ä»£**: VACUUMä¼˜åŒ–
   - AutoVacuumè‡ªåŠ¨æ¸…ç†
   - Parallel VACUUMå¹¶è¡Œæ¸…ç†
   - Visibility Mapä¼˜åŒ–

5. **2010å¹´ä»£è‡³ä»Š**: VACUUMæœºåˆ¶æˆç†Ÿ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ä½¿ç”¨ç±»ä¼¼æœºåˆ¶
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–VACUUMæ€§èƒ½
   - VACUUMæˆä¸ºMVCCç³»ç»Ÿçš„æ ‡å‡†ç»´æŠ¤æ“ä½œ

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦VACUUMï¼Ÿ**

1. **å­˜å‚¨ç©ºé—´å›æ”¶çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: MVCCåˆ›å»ºå¤šä¸ªç‰ˆæœ¬ï¼Œæ­»å…ƒç»„ç´¯ç§¯å¯¼è‡´å­˜å‚¨è†¨èƒ€
   - **è§£å†³**: VACUUMæ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
   - **æ•ˆæœ**: é˜²æ­¢è¡¨è†¨èƒ€ï¼Œç»´æŒå­˜å‚¨æ•ˆç‡

2. **æ€§èƒ½ç»´æŠ¤çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ­»å…ƒç»„å¢åŠ æ‰«æå¼€é”€ï¼Œé™ä½æŸ¥è¯¢æ€§èƒ½
   - **è§£å†³**: VACUUMæ¸…ç†æ­»å…ƒç»„ï¼Œå‡å°‘æ‰«æå¼€é”€
   - **æ•ˆæœ**: ç»´æŒæŸ¥è¯¢æ€§èƒ½

3. **XIDå›å·é˜²æ­¢çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: 32ä½äº‹åŠ¡IDå¯èƒ½å›å·ï¼Œå¯¼è‡´å¯è§æ€§åˆ¤æ–­é”™è¯¯
   - **è§£å†³**: VACUUMæ‰§è¡ŒFreezeæ“ä½œï¼Œæ ‡è®°æ—§å…ƒç»„ä¸ºæ°¸ä¹…å¯è§
   - **æ•ˆæœ**: é˜²æ­¢XIDå›å·ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§

**ç†è®ºä½ç½®**:

```text
MVCCç³»ç»Ÿç»´æŠ¤æœºåˆ¶å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ MVCCæœºåˆ¶
â”‚   â””â”€ é—®é¢˜: æ­»å…ƒç»„ç´¯ç§¯ï¼Œå­˜å‚¨è†¨èƒ€
â”‚       â””â”€ è§£å†³: VACUUMæœºåˆ¶æ¸…ç†
â”‚
â”œâ”€ VACUUMæœºåˆ¶ â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
â”‚       â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: åŸºäºOldestXmin
â”‚       â”œâ”€ æ¸…ç†è¿‡ç¨‹: æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
â”‚       â””â”€ Freezeæ“ä½œ: é˜²æ­¢XIDå›å·
â”‚
â””â”€ å­˜å‚¨å±‚
    â””â”€ å †è¡¨ã€ç´¢å¼•ã€FSM
```

**VACUUMä¸MVCCçš„å…³ç³»**:

```text
VACUUMä¸MVCC:
â”‚
â”œâ”€ MVCCæ˜¯å¹¶å‘æ§åˆ¶æœºåˆ¶
â”‚   â””â”€ åˆ›å»ºå¤šä¸ªç‰ˆæœ¬ï¼Œæ”¯æŒè¯»å†™å¹¶å‘
â”‚
â””â”€ VACUUMæ˜¯ç»´æŠ¤æœºåˆ¶
    â””â”€ æ¸…ç†æ­»ç‰ˆæœ¬ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
```

**ç†è®ºæ¨å¯¼**:

```text
ä»MVCCç‰ˆæœ¬ç´¯ç§¯åˆ°VACUUMæ¸…ç†çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: MVCCæ”¯æŒè¯»å†™å¹¶å‘ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: å­˜å‚¨ç©ºé—´æ•ˆç‡ï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: æŸ¥è¯¢æ€§èƒ½ï¼ˆé‡è¦ï¼‰

2. VACUUMè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: è¯†åˆ«å’Œæ¸…ç†æ­»å…ƒç»„
   â”œâ”€ æœºåˆ¶: åŸºäºOldestXminåˆ¤æ–­
   â””â”€ ä¼˜åŒ–: è‡ªåŠ¨VACUUMï¼Œå¹¶è¡Œæ¸…ç†

3. å®ç°é€‰æ‹©
   â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: OldestXminè®¡ç®—
   â”œâ”€ æ¸…ç†è¿‡ç¨‹: æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
   â””â”€ Freezeæ“ä½œ: é˜²æ­¢XIDå›å·

4. ç»“è®º
   â””â”€ VACUUMæ˜¯MVCCç³»ç»Ÿç»´æŠ¤å­˜å‚¨æ•ˆç‡çš„æ ‡å‡†æ–¹æ³•
```

---

#### 5.0.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: VACUUMæ¸…ç†æ­»å…ƒç»„å›æ”¶å­˜å‚¨ç©ºé—´**

```sql
-- åœºæ™¯: é«˜æ›´æ–°é¢‘ç‡è¡¨
-- éœ€æ±‚: å¿…é¡»å®šæœŸVACUUMï¼Œé˜²æ­¢è¡¨è†¨èƒ€

-- åˆå§‹çŠ¶æ€
CREATE TABLE orders (id INT, status VARCHAR);
INSERT INTO orders VALUES (1, 'pending');

-- å¤§é‡æ›´æ–°æ“ä½œ
UPDATE orders SET status = 'processing' WHERE id = 1;
UPDATE orders SET status = 'shipped' WHERE id = 1;
UPDATE orders SET status = 'delivered' WHERE id = 1;
-- ç»“æœ: åˆ›å»º4ä¸ªç‰ˆæœ¬ï¼ˆv1, v2, v3, v4ï¼‰ï¼Œv1, v2, v3æˆä¸ºæ­»å…ƒç»„

-- VACUUMæ¸…ç†
VACUUM orders;
-- ç»“æœ: æ¸…ç†v1, v2, v3ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“
-- è¡¨å¤§å°: ä»4å€å‡å°‘åˆ°1å€ âœ“
```

**åˆ†æ**:

- âœ… å­˜å‚¨ç©ºé—´å›æ”¶ï¼šVACUUMæ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
- âœ… è¡¨å¤§å°ç¨³å®šï¼šé˜²æ­¢è¡¨è†¨èƒ€ï¼Œç»´æŒå­˜å‚¨æ•ˆç‡
- âœ… æŸ¥è¯¢æ€§èƒ½ï¼šå‡å°‘æ‰«æå¼€é”€ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

---

**æ­£ä¾‹2: AutoVacuumè‡ªåŠ¨æ¸…ç†**

```sql
-- åœºæ™¯: ç”Ÿäº§ç¯å¢ƒ
-- éœ€æ±‚: è‡ªåŠ¨VACUUMï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤

-- é…ç½®AutoVacuum
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_vacuum_threshold = 50
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ­»å…ƒç»„æ•°é‡ > 50 + 0.1 * æ€»å…ƒç»„æ•°
-- 2. AutoVacuumè‡ªåŠ¨è§¦å‘VACUUM âœ“
-- 3. æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“
-- ç»“æœ: è¡¨å¤§å°ç¨³å®šï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ âœ“
```

**åˆ†æ**:

- âœ… è‡ªåŠ¨åŒ–ï¼šAutoVacuumè‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
- âœ… åŠæ—¶æ¸…ç†ï¼šæ ¹æ®é˜ˆå€¼è‡ªåŠ¨è§¦å‘ï¼ŒåŠæ—¶æ¸…ç†æ­»å…ƒç»„
- âœ… ç³»ç»Ÿç¨³å®šï¼šç»´æŒå­˜å‚¨æ•ˆç‡å’ŒæŸ¥è¯¢æ€§èƒ½

---

**åä¾‹åˆ†æ**:

**åä¾‹1: å¿½ç•¥VACUUMå¯¼è‡´è¡¨è†¨èƒ€**

```sql
-- é”™è¯¯åœºæ™¯: ç¦ç”¨AutoVacuum
-- é—®é¢˜: æ­»å…ƒç»„æ— æ³•æ¸…ç†ï¼Œè¡¨è†¨èƒ€ä¸¥é‡

-- é”™è¯¯é…ç½®
ALTER TABLE orders SET (autovacuum_enabled = false);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. å¤§é‡æ›´æ–°æ“ä½œ
UPDATE orders SET status = 'processing' WHERE id = 1;
UPDATE orders SET status = 'shipped' WHERE id = 1;
-- ... 1000æ¬¡æ›´æ–°

-- 2. æ­»å…ƒç»„ç´¯ç§¯ï¼Œæ— æ³•æ¸…ç† âœ—
-- 3. è¡¨å¤§å°: ä»10GBè†¨èƒ€åˆ°100GB âœ—
-- 4. æŸ¥è¯¢æ€§èƒ½: æ‰«ææ­»å…ƒç»„ï¼Œæ€§èƒ½ä¸‹é™90% âœ—
-- ç»“æœ: è¡¨è†¨èƒ€ä¸¥é‡ï¼Œæ€§èƒ½æå·® âœ—
```

**é”™è¯¯åŸå› **:

- ç¦ç”¨AutoVacuumï¼Œæ­»å…ƒç»„æ— æ³•æ¸…ç†
- è¡¨è†¨èƒ€ä¸¥é‡ï¼Œå­˜å‚¨ç©ºé—´æµªè´¹
- æŸ¥è¯¢æ€§èƒ½ä¸‹é™

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: å¯ç”¨AutoVacuum
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. AutoVacuumè‡ªåŠ¨è§¦å‘ âœ“
-- 2. å®šæœŸæ¸…ç†æ­»å…ƒç»„ âœ“
-- 3. è¡¨å¤§å°ç¨³å®š âœ“
-- ç»“æœ: å­˜å‚¨æ•ˆç‡é«˜ï¼Œæ€§èƒ½æ­£å¸¸ âœ“
```

**åæœåˆ†æ**:

- **è¡¨è†¨èƒ€**: è¡¨å¤§å°å¢é•¿10å€ï¼Œå­˜å‚¨ç©ºé—´æµªè´¹
- **æ€§èƒ½ä¸‹é™**: æŸ¥è¯¢æ‰«ææ­»å…ƒç»„ï¼Œæ€§èƒ½ä¸‹é™90%
- **ç³»ç»Ÿä¸ç¨³å®š**: å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œç³»ç»Ÿä¸å¯ç”¨

---

**åä¾‹2: VACUUMé¢‘ç‡è¿‡é«˜å¯¼è‡´æ€§èƒ½é—®é¢˜**

```sql
-- é”™è¯¯åœºæ™¯: VACUUMé¢‘ç‡è¿‡é«˜
-- é—®é¢˜: VACUUMå¼€é”€å¤§ï¼Œå½±å“æ­£å¸¸æ“ä½œ

-- é”™è¯¯é…ç½®
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.01,  -- é˜ˆå€¼è¿‡ä½
    autovacuum_vacuum_threshold = 10
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ­»å…ƒç»„æ•°é‡ > 10 + 0.01 * æ€»å…ƒç»„æ•°
-- 2. AutoVacuumé¢‘ç¹è§¦å‘ âœ—
-- 3. VACUUMå¼€é”€å¤§ï¼Œå½±å“æ­£å¸¸æ“ä½œ âœ—
-- ç»“æœ: ç³»ç»Ÿæ€§èƒ½ä¸‹é™ âœ—
```

**é”™è¯¯åŸå› **:

- VACUUMé˜ˆå€¼è¿‡ä½ï¼Œé¢‘ç¹è§¦å‘
- VACUUMå¼€é”€å¤§ï¼Œå½±å“æ­£å¸¸æ“ä½œ
- ç³»ç»Ÿæ€§èƒ½ä¸‹é™

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: åˆç†çš„VACUUMé…ç½®
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.1,  -- åˆç†é˜ˆå€¼
    autovacuum_vacuum_threshold = 50
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ­»å…ƒç»„æ•°é‡ > 50 + 0.1 * æ€»å…ƒç»„æ•°
-- 2. AutoVacuumé€‚åº¦è§¦å‘ âœ“
-- 3. VACUUMå¼€é”€å¯æ¥å— âœ“
-- ç»“æœ: ç³»ç»Ÿæ€§èƒ½æ­£å¸¸ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: VACUUMé¢‘ç¹è§¦å‘ï¼Œå½±å“æ­£å¸¸æ“ä½œ
- **èµ„æºæµªè´¹**: CPUå’ŒIOèµ„æºæµªè´¹åœ¨VACUUMä¸Š
- **ç³»ç»Ÿä¸ç¨³å®š**: é«˜è´Ÿè½½æ—¶ç³»ç»Ÿä¸å¯ç”¨

---

**åä¾‹3: å¿½ç•¥Freezeå¯¼è‡´XIDå›å·**

```sql
-- é”™è¯¯åœºæ™¯: å¿½ç•¥Freezeæ“ä½œ
-- é—®é¢˜: XIDå›å·ï¼Œç³»ç»Ÿä¸å¯ç”¨

-- é”™è¯¯é…ç½®
ALTER TABLE orders SET (
    autovacuum_freeze_max_age = 2147483647  -- æ¥è¿‘æœ€å¤§å€¼
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. å…ƒç»„å¹´é¾„è¶…è¿‡é˜ˆå€¼ï¼Œä½†æœªFreeze âœ—
-- 2. XIDå›å·é£é™©å¢åŠ  âœ—
-- 3. ç³»ç»Ÿå¯èƒ½å´©æºƒ âœ—
-- ç»“æœ: ç³»ç»Ÿä¸å¯ç”¨ âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥Freezeæ“ä½œï¼ŒXIDå›å·é£é™©å¢åŠ 
- ç³»ç»Ÿå¯èƒ½å´©æºƒï¼Œæ•°æ®ä¸¢å¤±

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: åˆç†çš„Freezeé…ç½®
ALTER TABLE orders SET (
    autovacuum_freeze_max_age = 200000000  -- åˆç†é˜ˆå€¼
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. å…ƒç»„å¹´é¾„è¶…è¿‡é˜ˆå€¼
-- 2. AutoVacuumè‡ªåŠ¨Freeze âœ“
-- 3. XIDå›å·é£é™©ä½ âœ“
-- ç»“æœ: ç³»ç»Ÿç¨³å®š âœ“
```

**åæœåˆ†æ**:

- **ç³»ç»Ÿå´©æºƒ**: XIDå›å·å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **æ•°æ®ä¸¢å¤±**: ç³»ç»Ÿä¸å¯ç”¨ï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±
- **ä¸šåŠ¡ä¸­æ–­**: ç³»ç»Ÿä¸å¯ç”¨ï¼Œä¸šåŠ¡ä¸­æ–­

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜æ›´æ–°é¢‘ç‡è¡¨ä½¿ç”¨AutoVacuum**

**åœºæ™¯æè¿°**:

- è®¢å•è¡¨ï¼Œæ¯å¤©100ä¸‡è®¢å•
- æ¯å¤©50ä¸‡è®¢å•çŠ¶æ€æ›´æ–°
- éœ€è¦è‡ªåŠ¨VACUUMï¼Œé˜²æ­¢è¡¨è†¨èƒ€

**ä¸ºä»€ä¹ˆéœ€è¦VACUUM**:

- âœ… å­˜å‚¨ç©ºé—´å›æ”¶ï¼šæ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
- âœ… æ€§èƒ½ç»´æŠ¤ï¼šå‡å°‘æ‰«æå¼€é”€ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- âœ… è‡ªåŠ¨åŒ–ï¼šAutoVacuumè‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- é…ç½®AutoVacuum
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_vacuum_threshold = 50
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ­»å…ƒç»„æ•°é‡ > 50 + 0.1 * æ€»å…ƒç»„æ•°
-- 2. AutoVacuumè‡ªåŠ¨è§¦å‘
-- 3. æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“
```

**æ•ˆæœåˆ†æ**:

- **å­˜å‚¨æ•ˆç‡**: è¡¨å¤§å°ç¨³å®šï¼Œå­˜å‚¨æ•ˆç‡é«˜ âœ“
- **æŸ¥è¯¢æ€§èƒ½**: æ‰«æå¼€é”€ä½ï¼ŒæŸ¥è¯¢æ€§èƒ½æ­£å¸¸ âœ“
- **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼Œç³»ç»Ÿç¨³å®š âœ“

---

**åœºæ™¯2: ä½æ›´æ–°é¢‘ç‡è¡¨ä¼˜åŒ–VACUUM**

**åœºæ™¯æè¿°**:

- å†å²æ•°æ®è¡¨ï¼Œæ›´æ–°é¢‘ç‡ä½
- éœ€è¦å‡å°‘VACUUMé¢‘ç‡ï¼Œé™ä½å¼€é”€

**ä¸ºä»€ä¹ˆéœ€è¦VACUUMä¼˜åŒ–**:

- âœ… é™ä½å¼€é”€ï¼šå‡å°‘VACUUMé¢‘ç‡ï¼Œé™ä½ç³»ç»Ÿå¼€é”€
- âœ… å­˜å‚¨æ•ˆç‡ï¼šé€‚åº¦æ¸…ç†ï¼Œç»´æŒå­˜å‚¨æ•ˆç‡
- âœ… æ€§èƒ½å¹³è¡¡ï¼šå¹³è¡¡VACUUMå¼€é”€å’Œå­˜å‚¨æ•ˆç‡

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ä¼˜åŒ–VACUUMé…ç½®
ALTER TABLE history SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.2,  -- æé«˜é˜ˆå€¼
    autovacuum_vacuum_threshold = 100
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ­»å…ƒç»„æ•°é‡ > 100 + 0.2 * æ€»å…ƒç»„æ•°
-- 2. AutoVacuumé€‚åº¦è§¦å‘
-- 3. VACUUMå¼€é”€å¯æ¥å— âœ“
```

**æ•ˆæœåˆ†æ**:

- **å¼€é”€é™ä½**: VACUUMé¢‘ç‡é™ä½ï¼Œç³»ç»Ÿå¼€é”€å‡å°‘ âœ“
- **å­˜å‚¨æ•ˆç‡**: é€‚åº¦æ¸…ç†ï¼Œå­˜å‚¨æ•ˆç‡å¯æ¥å— âœ“
- **æ€§èƒ½å¹³è¡¡**: å¹³è¡¡VACUUMå¼€é”€å’Œå­˜å‚¨æ•ˆç‡ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»MVCCç‰ˆæœ¬ç´¯ç§¯åˆ°VACUUMæ¸…ç†çš„æ¨ç†**

```text
å‰æ1: MVCCåˆ›å»ºå¤šä¸ªç‰ˆæœ¬ï¼ˆå¿…é¡»ï¼‰
å‰æ2: æ­»å…ƒç»„ç´¯ç§¯å¯¼è‡´å­˜å‚¨è†¨èƒ€ï¼ˆå¿…é¡»é¿å…ï¼‰
å‰æ3: éœ€è¦æ¸…ç†æ­»å…ƒç»„ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©æ¸…ç†æ­»å…ƒç»„çš„æœºåˆ¶
æ¨ç†æ­¥éª¤2: VACUUMæœºåˆ¶æ¸…ç†æ­»å…ƒç»„ï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: VACUUMæœºåˆ¶è‡ªåŠ¨åŒ–ï¼ˆæ»¡è¶³ç»´æŠ¤éœ€æ±‚ï¼‰

ç»“è®º: ä½¿ç”¨VACUUMæœºåˆ¶æ¸…ç†æ­»å…ƒç»„ âœ“
```

**æ¨ç†é“¾æ¡2: ä»OldestXminåˆ°æ­»å…ƒç»„è¯†åˆ«çš„æ¨ç†**

```text
å‰æ1: OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
å‰æ2: æ­»å…ƒç»„çš„åˆ é™¤äº‹åŠ¡IDå°äºOldestXmin
å‰æ3: VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„

æ¨ç†æ­¥éª¤1: OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
æ¨ç†æ­¥éª¤2: VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒVACUUMå®‰å…¨åœ°æ¸…ç†æ­»å…ƒç»„

ç»“è®º: VACUUMæœºåˆ¶å®‰å…¨åœ°æ¸…ç†æ­»å…ƒç»„ âœ“
```

---

#### 5.0.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸æ­»å…ƒç»„çš„å…³ç³»**:
   - VACUUMæ¸…ç†æ­»å…ƒç»„
   - æ­»å…ƒç»„æ˜¯VACUUMçš„æ¸…ç†ç›®æ ‡
   - æ­»å…ƒç»„åˆ¤æ–­åŸºäºOldestXmin

2. **ä¸OldestXminçš„å…³ç³»**:
   - VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„
   - OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
   - OldestXminå½±å“VACUUMçš„æ¸…ç†èŒƒå›´

3. **ä¸Freezeçš„å…³ç³»**:
   - VACUUMæ‰§è¡ŒFreezeæ“ä½œ
   - Freezeé˜²æ­¢XIDå›å·
   - Freezeæ˜¯VACUUMçš„é‡è¦åŠŸèƒ½

4. **ä¸MVCCçš„å…³ç³»**:
   - VACUUMæ˜¯MVCCçš„ç»´æŠ¤æœºåˆ¶
   - MVCCåˆ›å»ºå¤šä¸ªç‰ˆæœ¬ï¼ŒVACUUMæ¸…ç†æ­»ç‰ˆæœ¬
   - VACUUMç»´æŒMVCCç³»ç»Ÿçš„å­˜å‚¨æ•ˆç‡

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL VACUUMç³»ç»Ÿå®ç°
   - æ­»å…ƒç»„è¯†åˆ«å’Œæ¸…ç†
   - Freezeæ“ä½œ
   - å­˜å‚¨ç©ºé—´å›æ”¶

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - VACUUM â‰ˆ åƒåœ¾å›æ”¶
   - æ­»å…ƒç»„ â‰ˆ ä¸å¯è¾¾å¯¹è±¡
   - å­˜å‚¨å›æ”¶ â‰ˆ å†…å­˜å›æ”¶

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - VACUUM â‰ˆ åˆ†å¸ƒå¼åƒåœ¾å›æ”¶
   - æ­»å…ƒç»„ â‰ˆ è¿‡æœŸæ•°æ®
   - å­˜å‚¨å›æ”¶ â‰ˆ æ•°æ®æ¸…ç†

**å®ç°ç»†èŠ‚**:

**PostgreSQL VACUUMå®ç°æ¶æ„**:

```c
// src/backend/commands/vacuum.c

// VACUUMä¸»æµç¨‹
void vacuum(Relation rel, VacuumParams *params)
{
    // 1. è®¡ç®—OldestXmin
    TransactionId oldestXmin = GetOldestXmin(NULL, PROCARRAY_FLAGS_VACUUM);

    // 2. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    vacuum_heap(rel, oldestXmin);

    // 3. æ¸…ç†ç´¢å¼•
    vacuum_indexes(rel);

    // 4. Freezeæ“ä½œ
    vacuum_freeze(rel, oldestXmin);

    // 5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    update_statistics(rel);
}

// æ­»å…ƒç»„è¯†åˆ«
bool is_dead_tuple(HeapTuple tuple, TransactionId oldestXmin)
{
    // æ£€æŸ¥xmax
    if (tuple->t_data->t_infomask & HEAP_XMAX_COMMITTED) {
        if (tuple->t_data->t_xmax < oldestXmin) {
            return true;  // æ­»å…ƒç»„
        }
    }
    return false;
}
```

**VACUUMæ¸…ç†æœºåˆ¶**:

```python
def vacuum_table(table, oldest_xmin):
    """
    VACUUMæ¸…ç†æœºåˆ¶

    æœºåˆ¶:
    1. è®¡ç®—OldestXmin
    2. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    3. æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
    4. æ¸…ç†ç´¢å¼•
    5. Freezeæ“ä½œ
    """
    dead_tuples = []

    # 1. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    for page in table.pages:
        for tuple in page.tuples:
            if is_dead_tuple(tuple, oldest_xmin):
                dead_tuples.append(tuple)
                mark_as_unused(tuple)  # æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´

    # 2. æ¸…ç†ç´¢å¼•
    vacuum_indexes(table, dead_tuples)

    # 3. Freezeæ“ä½œ
    vacuum_freeze(table, oldest_xmin)

    # 4. æ›´æ–°FSM
    update_fsm(table)

    return dead_tuples
```

**æ€§èƒ½å½±å“**:

1. **VACUUMæ‰«æå¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{pages})$ - æ‰«ææ‰€æœ‰é¡µé¢
   - ç©ºé—´å¤æ‚åº¦: $O(1)$ - ä¸éœ€è¦é¢å¤–ç©ºé—´
   - å…¸å‹å¼€é”€: 10-100ms per 1000 pages

2. **ç´¢å¼•æ¸…ç†å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{dead} \cdot N_{indexes} \cdot \log N_{index\_entries})$
   - å…¸å‹å¼€é”€: 50-500ms per 1000 dead tuples
   - æ€§èƒ½å½±å“: ç´¢å¼•æ¸…ç†æ˜¯VACUUMçš„ä¸»è¦å¼€é”€

3. **æ€»ä½“æ€§èƒ½**:
   - æ ‡å‡†VACUUM: 10-1000msï¼ˆå–å†³äºè¡¨å¤§å°å’Œæ­»å…ƒç»„æ•°é‡ï¼‰
   - Parallel VACUUM: 5-500msï¼ˆå¹¶è¡Œæ¸…ç†ï¼Œå‡å°‘æ—¶é—´ï¼‰
   - æ€»ä½“å½±å“: VACUUMå¼€é”€å ç³»ç»Ÿèµ„æºçš„5-20%

---

#### 5.0.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**VACUUMæ—¶é—´å¼€é”€**:

$$T_{vacuum} = T_{scan} + T_{index\_clean} + T_{freeze} + T_{fsm\_update}$$

å…¶ä¸­ï¼š

- $T_{scan} = O(N_{pages})$ - æ‰«æè¡¨æ—¶é—´
- $T_{index\_clean} = O(N_{dead} \cdot N_{indexes} \cdot \log N_{index\_entries})$ - ç´¢å¼•æ¸…ç†æ—¶é—´
- $T_{freeze} = O(N_{old\_tuples})$ - Freezeæ“ä½œæ—¶é—´
- $T_{fsm\_update} = O(N_{pages})$ - FSMæ›´æ–°æ—¶é—´

**VACUUMç©ºé—´å›æ”¶**:

$$S_{reclaimed} = \sum_{\tau \in DeadTuples} \text{Size}(\tau)$$

å…¶ä¸­ $\text{Size}(\tau)$ æ˜¯å…ƒç»„$\tau$çš„å¤§å°ã€‚

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | è¡¨å¤§å° | æ­»å…ƒç»„æ¯”ä¾‹ | VACUUMæ—¶é—´ | ç©ºé—´å›æ”¶ | è¯´æ˜ |
|-----|-------|----------|-----------|---------|------|
| **å°è¡¨** | 1GB | 10% | 10-50ms | 100MB | å¿«é€Ÿæ¸…ç† |
| **ä¸­è¡¨** | 10GB | 20% | 100-500ms | 2GB | é€‚åº¦æ¸…ç† |
| **å¤§è¡¨** | 100GB | 30% | 1-5s | 30GB | éœ€è¦å¹¶è¡ŒVACUUM |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–VACUUMé¢‘ç‡**:
   - æ ¹æ®æ›´æ–°é¢‘ç‡è°ƒæ•´autovacuum_vacuum_scale_factor
   - é«˜æ›´æ–°é¢‘ç‡è¡¨ï¼šé™ä½é˜ˆå€¼ï¼ˆ0.05-0.1ï¼‰
   - ä½æ›´æ–°é¢‘ç‡è¡¨ï¼šæé«˜é˜ˆå€¼ï¼ˆ0.2-0.5ï¼‰

2. **ä¼˜åŒ–VACUUMæ€§èƒ½**:
   - ä½¿ç”¨Parallel VACUUMï¼ˆPostgreSQL 13+ï¼‰
   - ä¼˜åŒ–ç´¢å¼•æ•°é‡ï¼ˆå‡å°‘ç´¢å¼•æ¸…ç†å¼€é”€ï¼‰
   - ä½¿ç”¨Visibility Mapï¼ˆåŠ é€ŸIndex-Only Scanï¼‰

3. **ä¼˜åŒ–Freezeæ“ä½œ**:
   - åˆç†é…ç½®autovacuum_freeze_max_age
   - å®šæœŸæ‰§è¡ŒVACUUM FREEZE
   - ç›‘æ§XIDä½¿ç”¨æƒ…å†µ

---

#### 5.0.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: VACUUMæ˜¯æ¸…ç†æ­»å…ƒç»„ã€å›æ”¶å­˜å‚¨ç©ºé—´çš„æœºåˆ¶
2. **ä½œç”¨**: VACUUMé˜²æ­¢è¡¨è†¨èƒ€ï¼Œç»´æŒå­˜å‚¨æ•ˆç‡å’ŒæŸ¥è¯¢æ€§èƒ½
3. **å®ç°**: PostgreSQLé€šè¿‡OldestXminè¯†åˆ«æ­»å…ƒç»„ï¼Œæ‰§è¡Œæ¸…ç†å’ŒFreezeæ“ä½œ
4. **æ€§èƒ½**: VACUUMå¼€é”€å–å†³äºè¡¨å¤§å°å’Œæ­»å…ƒç»„æ•°é‡ï¼Œå¯ä»¥é€šè¿‡å¹¶è¡ŒVACUUMä¼˜åŒ–

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºVACUUMä¸éœ€è¦é…ç½®
   - **é”™è¯¯**: VACUUMéœ€è¦åˆç†é…ç½®ï¼Œå¦åˆ™å¯èƒ½è¿‡åº¦æˆ–ä¸è¶³
   - **æ­£ç¡®**: æ ¹æ®æ›´æ–°é¢‘ç‡è°ƒæ•´VACUUMå‚æ•°

2. **è¯¯åŒº2**: è®¤ä¸ºVACUUMæ€§èƒ½å¾ˆä½
   - **é”™è¯¯**: VACUUMæ˜¯åå°æ“ä½œï¼Œå¯¹æ­£å¸¸æ“ä½œå½±å“å°
   - **æ­£ç¡®**: å¯ä»¥é€šè¿‡å¹¶è¡ŒVACUUMå’Œåˆç†é…ç½®ä¼˜åŒ–æ€§èƒ½

3. **è¯¯åŒº3**: å¿½ç•¥Freezeæ“ä½œ
   - **é”™è¯¯**: è®¤ä¸ºFreezeä¸é‡è¦
   - **æ­£ç¡®**: Freezeé˜²æ­¢XIDå›å·ï¼Œæ˜¯VACUUMçš„é‡è¦åŠŸèƒ½

**æœ€ä½³å®è·µ**:

1. **å¯ç”¨AutoVacuum**: æ‰€æœ‰è¡¨éƒ½åº”è¯¥å¯ç”¨AutoVacuum
2. **åˆç†é…ç½®å‚æ•°**: æ ¹æ®æ›´æ–°é¢‘ç‡è°ƒæ•´VACUUMå‚æ•°
3. **ç›‘æ§VACUUMæ€§èƒ½**: ç›‘æ§VACUUMæ‰§è¡Œæ—¶é—´å’Œç©ºé—´å›æ”¶
4. **å®šæœŸæ£€æŸ¥**: å®šæœŸæ£€æŸ¥è¡¨è†¨èƒ€å’ŒVACUUMæ‰§è¡Œæƒ…å†µ

---

### 5.1 OldestXmin å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 5.1.0 æƒå¨å®šä¹‰ä¸æ¥æº

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> OldestXmin is the transaction ID (XID) of the oldest active transaction in the system at a given moment. It represents the minimum XID among all currently active transactions. OldestXmin is crucial for determining data visibility and managing transaction ID wraparound. It is used by VACUUM to identify dead tuples that can be safely removed, as any tuple with an xmax older than OldestXmin is guaranteed to be invisible to all active transactions.

**Gray & Reuter (1993) å®šä¹‰**:

> The oldest active transaction ID is the minimum transaction ID among all currently active transactions. This value is used to determine which versions are visible to active transactions and which versions can be safely removed during garbage collection.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„OldestXminè®¡ç®—åŸºäºæ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼ˆProcArrayï¼‰ï¼š

```c
// src/backend/access/transam/xact.c

// è®¡ç®—OldestXmin
TransactionId GetOldestXmin(Relation relation, int flags)
{
    TransactionId oldestXmin;
    TransactionId latestCompletedXid;
    ProcArrayStruct *arrayP = procArray;

    // 1. è·å–æœ€æ–°å·²æäº¤äº‹åŠ¡ID
    latestCompletedXid = ShmemVariableCache->latestCompletedXid;

    // 2. è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    LWLockAcquire(ProcArrayLock, LW_SHARED);

    // 3. è®¡ç®—OldestXmin
    oldestXmin = latestCompletedXid + 1;
    for (int i = 0; i < arrayP->numProcs; i++) {
        PGPROC *proc = arrayP->procs[i];
        if (TransactionIdIsValid(proc->xid)) {
            if (TransactionIdPrecedes(proc->xid, oldestXmin)) {
                oldestXmin = proc->xid;
            }
        }
    }

    LWLockRelease(ProcArrayLock);

    return oldestXmin;
}
```

**æœ¬ä½“ç³»å®šä¹‰**:

OldestXminæ˜¯PostgreSQL MVCCä¸­ç”¨äºç¡®å®šæ­»å…ƒç»„è¾¹ç•Œå’Œå¯è§æ€§åˆ¤æ–­çš„å…³é”®æ¦‚å¿µã€‚OldestXminè¡¨ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡IDã€‚å®ƒç”¨äºVACUUMè¯†åˆ«å¯ä»¥å®‰å…¨æ¸…ç†çš„æ­»å…ƒç»„ï¼šä»»ä½•xmaxå°äºOldestXminçš„å…ƒç»„éƒ½ä¿è¯å¯¹æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸å¯è§ï¼Œå› æ­¤å¯ä»¥å®‰å…¨æ¸…ç†ã€‚OldestXminä¹Ÿç”¨äºFreezeæ“ä½œï¼Œé˜²æ­¢32ä½äº‹åŠ¡IDå›å·ã€‚

**OldestXminä¸VACUUMçš„å…³ç³»**:

```text
VACUUMæ­»å…ƒç»„è¯†åˆ«æœºåˆ¶:
â”‚
â”œâ”€ OldestXmin â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®šä¹‰: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
â”‚       â””â”€ ä½œç”¨: ç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
â”‚           â”œâ”€ æ­»å…ƒç»„åˆ¤æ–­: xmax < OldestXmin ä¸” xmaxå·²æäº¤
â”‚           â””â”€ Freezeåˆ¤æ–­: xmin < OldestXmin - FreezeMaxAge
â”‚
â””â”€ VACUUMæœºåˆ¶
    â””â”€ å®šä¹‰: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
        â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: åŸºäºOldestXmin
        â”œâ”€ æ¸…ç†è¿‡ç¨‹: æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
        â””â”€ Freezeæ“ä½œ: é˜²æ­¢XIDå›å·
```

---

#### 5.1.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.1.1 (OldestXmin)**:

OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡IDï¼š

$$
\text{OldestXmin} = \begin{cases}
\min\{\text{xid} | \text{xid is active}\} & \text{if } \exists \text{ active transaction} \\
\text{LatestCompletedXid} & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ï¼š

- $\text{ActiveTransactions}$: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„é›†åˆ
- $\text{LatestCompletedXid}$: æœ€æ–°å·²æäº¤äº‹åŠ¡ID

å³ï¼šå¦‚æœæœ‰æ´»è·ƒäº‹åŠ¡ï¼ŒOldestXminæ˜¯æœ€å°çš„æ´»è·ƒäº‹åŠ¡IDï¼›å¦åˆ™ï¼ŒOldestXminæ˜¯æœ€æ–°å·²æäº¤äº‹åŠ¡IDã€‚

**å®šä¹‰5.1.2 (æ­»å…ƒç»„è¯†åˆ«æ¡ä»¶)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬$\tau$ï¼Œæ­»å…ƒç»„è¯†åˆ«æ¡ä»¶ï¼š

$$DeadTuple(\tau) \iff \tau.xmax \neq 0 \land \tau.xmax < \text{OldestXmin} \land \text{Committed}(\tau.xmax)$$

å…¶ä¸­ï¼š

- $\tau.xmax$: åˆ é™¤è¯¥å…ƒç»„çš„äº‹åŠ¡ID
- $\text{Committed}(\tau.xmax)$: åˆ é™¤äº‹åŠ¡å·²æäº¤

å³ï¼šå…ƒç»„çš„åˆ é™¤äº‹åŠ¡IDå°äºOldestXminä¸”åˆ é™¤äº‹åŠ¡å·²æäº¤ï¼Œåˆ™è¯¥å…ƒç»„æ˜¯æ­»å…ƒç»„ã€‚

**å®šä¹‰5.1.3 (Freezeæ¡ä»¶)**:

å¯¹äºå…ƒç»„ç‰ˆæœ¬$\tau$ï¼ŒFreezeæ¡ä»¶ï¼š

$$\text{NeedsFreeze}(\tau) \iff (\text{CurrentXid} - \tau.xmin) > \text{FreezeMaxAge} \land \tau.xmin < \text{OldestXmin}$$

å…¶ä¸­ï¼š

- $\text{CurrentXid}$: å½“å‰äº‹åŠ¡ID
- $\text{FreezeMaxAge}$: Freezeé˜ˆå€¼ï¼ˆé»˜è®¤200Mï¼‰

å³ï¼šå¦‚æœå…ƒç»„å¹´é¾„è¶…è¿‡FreezeMaxAgeä¸”xminå°äºOldestXminï¼Œéœ€è¦Freezeä»¥é˜²æ­¢XIDå›å·ã€‚

**å®šä¹‰5.1.4 (OldestXminå®‰å…¨æ€§ä¿è¯)**:

OldestXminä¿è¯ï¼š

$$\forall \tau: \text{Vacuumed}(\tau) \implies \tau.xmax < \text{OldestXmin} \land \forall T \in \text{ActiveTransactions}: \text{NotVisible}(\tau, T)$$

å³ï¼šVACUUMåªæ¸…ç†xmaxå°äºOldestXminçš„å…ƒç»„ï¼Œä¸”ä¿è¯ä¸ä¼šåˆ é™¤ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ã€‚

---

#### 5.1.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1980å¹´ä»£**: åƒåœ¾å›æ”¶ç†è®ºå‘å±•
   - é¦–æ¬¡æå‡ºåŸºäºæ´»è·ƒäº‹åŠ¡çš„åƒåœ¾å›æ”¶ç­–ç•¥
   - å®šä¹‰OldestXminæ¦‚å¿µ
   - ç ”ç©¶åƒåœ¾å›æ”¶ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦

2. **1990å¹´ä»£**: VACUUMæœºåˆ¶å‘å±•
   - PostgreSQLå®ç°VACUUMæœºåˆ¶
   - ä½¿ç”¨OldestXminè¯†åˆ«æ­»å…ƒç»„
   - æå‡ºFreezeæ“ä½œé˜²æ­¢XIDå›å·

3. **2000å¹´ä»£**: OldestXminä¼˜åŒ–
   - ä¼˜åŒ–OldestXminè®¡ç®—æ€§èƒ½
   - å¹¶è¡ŒVACUUMæ”¯æŒ
   - é•¿äº‹åŠ¡å¤„ç†ä¼˜åŒ–

4. **2010å¹´ä»£è‡³ä»Š**: OldestXminæœºåˆ¶æˆç†Ÿ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ä½¿ç”¨ç±»ä¼¼æœºåˆ¶
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–OldestXminè®¡ç®—
   - OldestXminæˆä¸ºMVCCåƒåœ¾å›æ”¶çš„æ ‡å‡†æ¦‚å¿µ

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦OldestXminï¼Ÿ**

1. **æ­»å…ƒç»„è¯†åˆ«çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦ç¡®å®šå“ªäº›å…ƒç»„å¯ä»¥å®‰å…¨æ¸…ç†
   - **è§£å†³**: OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
   - **æ•ˆæœ**: ä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

2. **å¯è§æ€§åˆ¤æ–­çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦ç¡®å®šå…ƒç»„å¯¹æ´»è·ƒäº‹åŠ¡çš„å¯è§æ€§
   - **è§£å†³**: OldestXminç”¨äºå¯è§æ€§åˆ¤æ–­
   - **æ•ˆæœ**: ä¿è¯å¯è§æ€§åˆ¤æ–­çš„æ­£ç¡®æ€§

3. **XIDå›å·é˜²æ­¢çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: 32ä½äº‹åŠ¡IDå¯èƒ½å›å·ï¼Œå¯¼è‡´å¯è§æ€§åˆ¤æ–­é”™è¯¯
   - **è§£å†³**: OldestXminç”¨äºFreezeæ“ä½œ
   - **æ•ˆæœ**: é˜²æ­¢XIDå›å·ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§

**ç†è®ºä½ç½®**:

```text
MVCCåƒåœ¾å›æ”¶æœºåˆ¶å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ MVCCæœºåˆ¶
â”‚   â””â”€ é—®é¢˜: æ­»å…ƒç»„ç´¯ç§¯ï¼Œå­˜å‚¨è†¨èƒ€
â”‚       â””â”€ è§£å†³: VACUUMæœºåˆ¶æ¸…ç†
â”‚
â”œâ”€ OldestXmin â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
â”‚       â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: åŸºäºOldestXminåˆ¤æ–­
â”‚       â”œâ”€ å¯è§æ€§åˆ¤æ–­: ç”¨äºç¡®å®šå¯è§æ€§è¾¹ç•Œ
â”‚       â””â”€ Freezeæ“ä½œ: é˜²æ­¢XIDå›å·
â”‚
â””â”€ VACUUMæœºåˆ¶
    â””â”€ å®ç°: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´
```

**OldestXminä¸VACUUMçš„å…³ç³»**:

```text
OldestXminä¸VACUUM:
â”‚
â”œâ”€ OldestXminæ˜¯è¾¹ç•Œç¡®å®šæœºåˆ¶
â”‚   â””â”€ ç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
â”‚
â””â”€ VACUUMæ˜¯æ¸…ç†æœºåˆ¶
    â””â”€ åŸºäºOldestXminæ¸…ç†æ­»å…ƒç»„
```

**ç†è®ºæ¨å¯¼**:

```text
ä»æ­»å…ƒç»„è¯†åˆ«åˆ°OldestXminè®¡ç®—çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: è¯†åˆ«æ­»å…ƒç»„ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: ä¿è¯å®‰å…¨æ€§ï¼ˆå¿…é¡»ï¼‰
   â””â”€ éœ€æ±‚: é˜²æ­¢åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ï¼ˆå¿…é¡»ï¼‰

2. OldestXminè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: è®¡ç®—æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
   â”œâ”€ æœºåˆ¶: åŸºäºæ´»è·ƒäº‹åŠ¡åˆ—è¡¨è®¡ç®—
   â””â”€ ä¿è¯: ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

3. å®ç°é€‰æ‹©
   â”œâ”€ OldestXminè®¡ç®—: æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   â”œâ”€ æ­»å…ƒç»„è¯†åˆ«: åŸºäºOldestXminåˆ¤æ–­
   â””â”€ å®‰å…¨æ€§ä¿è¯: OldestXminä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

4. ç»“è®º
   â””â”€ OldestXminæ˜¯è¯†åˆ«æ­»å…ƒç»„çš„æ ‡å‡†æ–¹æ³•
```

---

#### 5.1.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: OldestXminæ­£ç¡®è¯†åˆ«æ­»å…ƒç»„**

```sql
-- åœºæ™¯: é«˜é¢‘æ›´æ–°å¯¼è‡´æ­»å…ƒç»„ç´¯ç§¯
-- éœ€æ±‚: å¿…é¡»æ­£ç¡®è¯†åˆ«æ­»å…ƒç»„ï¼Œå®‰å…¨æ¸…ç†

-- åˆå§‹çŠ¶æ€
INSERT INTO accounts (id, balance) VALUES (1, 1000);
-- ç‰ˆæœ¬v1: xmin=100, xmax=0

-- äº‹åŠ¡T2æ›´æ–°å¹¶æäº¤
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;  -- xid=105
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=105, xmax=0

-- æ‰€æœ‰äº‹åŠ¡æäº¤å
-- OldestXmin = 115 (æ— æ´»è·ƒäº‹åŠ¡)
-- æ­»å…ƒç»„åˆ¤æ–­: v1 (xmax=105 < 115) â†’ æ˜¯æ­»å…ƒç»„ âœ“
-- VACUUMæ¸…ç†: v1è¢«æ¸…ç† âœ“
```

**åˆ†æ**:

- âœ… æ­»å…ƒç»„è¯†åˆ«ï¼šOldestXminæ­£ç¡®è¯†åˆ«v1ä¸ºæ­»å…ƒç»„
- âœ… å®‰å…¨æ€§ä¿è¯ï¼šv1å¯¹æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸å¯è§ï¼Œå¯ä»¥å®‰å…¨æ¸…ç†
- âœ… ç©ºé—´å›æ”¶ï¼šæˆåŠŸå›æ”¶å­˜å‚¨ç©ºé—´

---

**æ­£ä¾‹2: OldestXminä¿æŠ¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„**

```sql
-- åœºæ™¯: é•¿äº‹åŠ¡æŒæœ‰å¿«ç…§
-- éœ€æ±‚: OldestXminä¿æŠ¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡ - è¿è¡Œ1å°æ—¶)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- äº‹åŠ¡T2æ›´æ–°å¹¶æäº¤
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;  -- xid=105
-- ç‰ˆæœ¬v1: xmin=100, xmax=105
-- ç‰ˆæœ¬v2: xmin=105, xmax=0

-- VACUUMæ‰§è¡Œ
-- OldestXmin = 100 (T1ä»æ´»è·ƒ)
-- æ­»å…ƒç»„åˆ¤æ–­: v1 (xmax=105 >= 100) â†’ ä¸æ˜¯æ­»å…ƒç»„ âœ“
-- v1ä¸è¢«æ¸…ç† âœ“

-- äº‹åŠ¡T1æŸ¥è¯¢
SELECT balance FROM accounts WHERE id = 1;
-- éå†ç‰ˆæœ¬é“¾: v2 â†’ ä¸å¯è§, v1 â†’ å¯è§ âœ“
-- è¿”å›: balance=1000 (åŸºäºå¿«ç…§) âœ“

COMMIT;

-- äº‹åŠ¡T1æäº¤åï¼ŒVACUUMå†æ¬¡æ‰§è¡Œ
-- OldestXmin = 201 (æ— æ´»è·ƒäº‹åŠ¡)
-- æ­»å…ƒç»„åˆ¤æ–­: v1 (xmax=105 < 201) â†’ æ˜¯æ­»å…ƒç»„ âœ“
-- v1è¢«æ¸…ç† âœ“
```

**åˆ†æ**:

- âœ… å®‰å…¨æ€§ä¿è¯ï¼šOldestXminä¿æŠ¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- âœ… æ•°æ®ä¸€è‡´æ€§ï¼šæ´»è·ƒäº‹åŠ¡ä»èƒ½çœ‹åˆ°æ­£ç¡®çš„æ•°æ®
- âœ… ç©ºé—´å›æ”¶ï¼šæ´»è·ƒäº‹åŠ¡ç»“æŸåæ¸…ç†æ­»å…ƒç»„

---

**åä¾‹åˆ†æ**:

**åä¾‹1: OldestXminè®¡ç®—é”™è¯¯å¯¼è‡´æ•°æ®ä¸¢å¤±**

```sql
-- é”™è¯¯åœºæ™¯: OldestXminè®¡ç®—é”™è¯¯
-- é—®é¢˜: æ¸…ç†äº†æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„

-- é”™è¯¯çš„OldestXminè®¡ç®—
def wrong_oldest_xmin():
    # é”™è¯¯: æœªè€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    active_txs = get_some_active_transactions()  # åªè·å–éƒ¨åˆ†æ´»è·ƒäº‹åŠ¡ âœ—
    if not active_txs:
        return get_latest_completed_xid()
    return min(tx.xid for tx in active_txs)  # é”™è¯¯è®¡ç®— âœ—

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- äº‹åŠ¡T2æ›´æ–°å¹¶æäº¤
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;  -- xid=105
-- ç‰ˆæœ¬v1: xmin=100, xmax=105

-- é”™è¯¯çš„VACUUM
-- OldestXmin = 200 (é”™è¯¯è®¡ç®—) âœ—
-- æ­»å…ƒç»„åˆ¤æ–­: v1 (xmax=105 < 200) â†’ é”™è¯¯è®¤ä¸ºæ˜¯æ­»å…ƒç»„ âœ—
-- v1è¢«é”™è¯¯æ¸…ç† âœ—

-- äº‹åŠ¡T1æŸ¥è¯¢
SELECT balance FROM accounts WHERE id = 1;
-- é”™è¯¯: v1å·²è¢«æ¸…ç†ï¼Œæ— æ³•æ‰¾åˆ°å¯è§ç‰ˆæœ¬ âœ—
-- ç»“æœ: æ•°æ®ä¸¢å¤± âœ—
```

**é”™è¯¯åŸå› **:

- OldestXminè®¡ç®—é”™è¯¯ï¼Œæœªè€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
- æ¸…ç†äº†æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- å¯¼è‡´æ•°æ®ä¸¢å¤±

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®çš„OldestXminè®¡ç®—
def correct_oldest_xmin():
    # æ­£ç¡®: è€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    active_txs = get_all_active_transactions()  # è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ âœ“
    if not active_txs:
        return get_latest_completed_xid()
    return min(tx.xid for tx in active_txs)  # æ­£ç¡®è®¡ç®— âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®ä¸¢å¤±**: æ´»è·ƒäº‹åŠ¡æ— æ³•æ‰¾åˆ°å¯è§ç‰ˆæœ¬
- **ç³»ç»Ÿé”™è¯¯**: VACUUMæœºåˆ¶å¤±æ•ˆ
- **ä¸€è‡´æ€§ç ´å**: è¿åå¯è§æ€§ä¸å˜å¼

---

**åä¾‹2: é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°**

```sql
-- é”™è¯¯åœºæ™¯: é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°
-- é—®é¢˜: æ­»å…ƒç»„æ— æ³•æ¸…ç†ï¼Œè¡¨è†¨èƒ€ä¸¥é‡

-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡ - è¿è¡Œ24å°æ—¶)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- å¤§é‡æ›´æ–°æ“ä½œ
-- æ¯å¤©100ä¸‡è®¢å•ï¼Œ50ä¸‡è®¢å•çŠ¶æ€æ›´æ–°
-- æ­»å…ƒç»„ç´¯ç§¯: æ¯å¤©50ä¸‡æ­»å…ƒç»„

-- VACUUMæ‰§è¡Œ
-- OldestXmin = 100 (T1ä»æ´»è·ƒ)
-- æ­»å…ƒç»„åˆ¤æ–­: æ‰€æœ‰xmax >= 100çš„å…ƒç»„éƒ½ä¸æ˜¯æ­»å…ƒç»„ âœ—
-- ç»“æœ: æ­»å…ƒç»„æ— æ³•æ¸…ç†ï¼Œè¡¨è†¨èƒ€ä¸¥é‡ âœ—
-- è¡¨å¤§å°: ä»10GBè†¨èƒ€åˆ°100GB âœ—
```

**é”™è¯¯åŸå› **:

- é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°
- æ­»å…ƒç»„æ— æ³•æ¸…ç†
- è¡¨è†¨èƒ€ä¸¥é‡

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: é¿å…é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ1: æ‹†åˆ†é•¿äº‹åŠ¡
BEGIN;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;  -- ç«‹å³æäº¤

-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;
```

**åæœåˆ†æ**:

- **è¡¨è†¨èƒ€**: è¡¨å¤§å°å¢é•¿10å€ï¼Œå­˜å‚¨ç©ºé—´æµªè´¹
- **æ€§èƒ½ä¸‹é™**: æŸ¥è¯¢æ‰«ææ­»å…ƒç»„ï¼Œæ€§èƒ½ä¸‹é™90%
- **ç³»ç»Ÿä¸ç¨³å®š**: å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œç³»ç»Ÿä¸å¯ç”¨

---

**åä¾‹3: å¿½ç•¥OldestXminå¯¼è‡´Freezeå¤±è´¥**

```sql
-- é”™è¯¯åœºæ™¯: å¿½ç•¥OldestXminå¯¼è‡´Freezeå¤±è´¥
-- é—®é¢˜: XIDå›å·ï¼Œç³»ç»Ÿä¸å¯ç”¨

-- é”™è¯¯é…ç½®
ALTER TABLE orders SET (
    autovacuum_freeze_max_age = 2147483647  -- æ¥è¿‘æœ€å¤§å€¼
);

-- é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°
-- äº‹åŠ¡T1 (é•¿äº‹åŠ¡ - è¿è¡Œ1ä¸ªæœˆ)
BEGIN ISOLATION LEVEL REPEATABLE READ;
-- å¿«ç…§: xmin=100, xmax=200

-- ç³»ç»Ÿè¡Œä¸º
-- OldestXmin = 100 (T1ä»æ´»è·ƒ)
-- Freezeåˆ¤æ–­: æ‰€æœ‰xmin >= 100çš„å…ƒç»„éƒ½ä¸éœ€è¦Freeze âœ—
-- ç»“æœ: å…ƒç»„å¹´é¾„è¶…è¿‡é˜ˆå€¼ï¼Œä½†æœªFreeze âœ—
-- XIDå›å·é£é™©å¢åŠ  âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥OldestXminï¼ŒFreezeåˆ¤æ–­é”™è¯¯
- XIDå›å·é£é™©å¢åŠ 
- ç³»ç»Ÿå¯èƒ½å´©æºƒ

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: è€ƒè™‘OldestXminçš„Freezeåˆ¤æ–­
-- PostgreSQLè‡ªåŠ¨å¤„ç†
-- Freezeåˆ¤æ–­: (CurrentXid - xmin) > FreezeMaxAge AND xmin < OldestXmin
-- å³ä½¿OldestXminè¿‡å°ï¼Œä¹Ÿä¼šåœ¨OldestXminæ›´æ–°åFreeze âœ“
```

**åæœåˆ†æ**:

- **ç³»ç»Ÿå´©æºƒ**: XIDå›å·å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **æ•°æ®ä¸¢å¤±**: ç³»ç»Ÿä¸å¯ç”¨ï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±
- **ä¸šåŠ¡ä¸­æ–­**: ç³»ç»Ÿä¸å¯ç”¨ï¼Œä¸šåŠ¡ä¸­æ–­

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜æ›´æ–°é¢‘ç‡ç³»ç»Ÿä½¿ç”¨OldestXmin**

**åœºæ™¯æè¿°**:

- é«˜é¢‘æ›´æ–°ç³»ç»Ÿï¼ˆ1000+ TPSï¼‰
- æ­»å…ƒç»„å¿«é€Ÿç´¯ç§¯
- éœ€è¦æ­£ç¡®è®¡ç®—OldestXminï¼ŒåŠæ—¶æ¸…ç†

**ä¸ºä»€ä¹ˆéœ€è¦OldestXmin**:

- âœ… æ­»å…ƒç»„è¯†åˆ«ï¼šOldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
- âœ… å®‰å…¨æ€§ä¿è¯ï¼šä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
- âœ… ç©ºé—´å›æ”¶ï¼šåŠæ—¶æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLè‡ªåŠ¨è®¡ç®—OldestXmin
-- VACUUMä½¿ç”¨OldestXminè¯†åˆ«æ­»å…ƒç»„

-- é…ç½®AutoVacuum
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. VACUUMè®¡ç®—OldestXmin
-- 2. è¯†åˆ«æ­»å…ƒç»„ï¼ˆxmax < OldestXminï¼‰
-- 3. æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“
```

**æ•ˆæœåˆ†æ**:

- **æ­»å…ƒç»„è¯†åˆ«**: OldestXminæ­£ç¡®è¯†åˆ«æ­»å…ƒç»„ âœ“
- **å®‰å…¨æ€§**: ä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ âœ“
- **ç©ºé—´å›æ”¶**: åŠæ—¶æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶å­˜å‚¨ç©ºé—´ âœ“

---

**åœºæ™¯2: é•¿äº‹åŠ¡ç³»ç»Ÿä¼˜åŒ–OldestXmin**

**åœºæ™¯æè¿°**:

- é•¿äº‹åŠ¡ç³»ç»Ÿï¼ˆäº‹åŠ¡æ—¶é•¿>1å°æ—¶ï¼‰
- OldestXminå¯èƒ½è¿‡å°
- éœ€è¦ä¼˜åŒ–é•¿äº‹åŠ¡ï¼Œé¿å…æ­»å…ƒç»„æ— æ³•æ¸…ç†

**ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–**:

- âœ… é¿å…é•¿äº‹åŠ¡ï¼šå‡å°‘é•¿äº‹åŠ¡ï¼Œæå‡OldestXmin
- âœ… åŠæ—¶æ¸…ç†ï¼šæ­»å…ƒç»„å¯ä»¥åŠæ—¶æ¸…ç†
- âœ… ç³»ç»Ÿç¨³å®šï¼šé¿å…è¡¨è†¨èƒ€ï¼Œç³»ç»Ÿç¨³å®š

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ç›‘æ§é•¿äº‹åŠ¡
SELECT pid, now() - xact_start AS duration
FROM pg_stat_activity
WHERE state = 'active' AND now() - xact_start > interval '1 hour';

-- é¿å…é•¿äº‹åŠ¡
-- æ–¹æ¡ˆ1: æ‹†åˆ†é•¿äº‹åŠ¡
BEGIN;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;

-- æ–¹æ¡ˆ2: ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM orders WHERE date < '2025-12-01';
COMMIT;
```

**æ•ˆæœåˆ†æ**:

- **OldestXminæå‡**: å‡å°‘é•¿äº‹åŠ¡ï¼ŒOldestXminæå‡ âœ“
- **åŠæ—¶æ¸…ç†**: æ­»å…ƒç»„å¯ä»¥åŠæ—¶æ¸…ç† âœ“
- **ç³»ç»Ÿç¨³å®š**: é¿å…è¡¨è†¨èƒ€ï¼Œç³»ç»Ÿç¨³å®š âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»æ­»å…ƒç»„è¯†åˆ«åˆ°OldestXminè®¡ç®—çš„æ¨ç†**

```text
å‰æ1: éœ€è¦è¯†åˆ«æ­»å…ƒç»„ï¼ˆå¿…é¡»ï¼‰
å‰æ2: éœ€è¦ä¿è¯å®‰å…¨æ€§ï¼ˆå¿…é¡»ï¼‰
å‰æ3: éœ€è¦ç¡®å®šæ­»å…ƒç»„è¾¹ç•Œï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©ç¡®å®šæ­»å…ƒç»„è¾¹ç•Œçš„æœºåˆ¶
æ¨ç†æ­¥éª¤2: OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: OldestXminä¿è¯ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„ï¼ˆæ»¡è¶³å‰æ2ï¼‰

ç»“è®º: ä½¿ç”¨OldestXminè¯†åˆ«æ­»å…ƒç»„ âœ“
```

**æ¨ç†é“¾æ¡2: ä»OldestXminè®¡ç®—åˆ°æ­»å…ƒç»„è¯†åˆ«çš„æ¨ç†**

```text
å‰æ1: OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
å‰æ2: æ­»å…ƒç»„çš„åˆ é™¤äº‹åŠ¡IDå°äºOldestXmin
å‰æ3: VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„

æ¨ç†æ­¥éª¤1: OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
æ¨ç†æ­¥éª¤2: VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒVACUUMå®‰å…¨åœ°æ¸…ç†æ­»å…ƒç»„

ç»“è®º: OldestXminæœºåˆ¶å®‰å…¨åœ°è¯†åˆ«æ­»å…ƒç»„ âœ“
```

---

#### 5.1.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸VACUUMçš„å…³ç³»**:
   - VACUUMåŸºäºOldestXminè¯†åˆ«æ­»å…ƒç»„
   - OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
   - OldestXminå½±å“VACUUMçš„æ¸…ç†èŒƒå›´

2. **ä¸æ­»å…ƒç»„çš„å…³ç³»**:
   - OldestXminç”¨äºè¯†åˆ«æ­»å…ƒç»„
   - æ­»å…ƒç»„å¿…é¡»æ»¡è¶³xmax < OldestXmin
   - OldestXminè®¡ç®—å½±å“æ­»å…ƒç»„è¯†åˆ«

3. **ä¸Freezeçš„å…³ç³»**:
   - OldestXminç”¨äºFreezeåˆ¤æ–­
   - Freezeé˜²æ­¢XIDå›å·
   - OldestXminå½±å“Freezeæ“ä½œ

4. **ä¸å¯è§æ€§çš„å…³ç³»**:
   - OldestXminç”¨äºå¯è§æ€§åˆ¤æ–­
   - å¯è§æ€§åˆ¤æ–­ä½¿ç”¨OldestXminç¡®å®šè¾¹ç•Œ
   - OldestXminå½±å“å¯è§æ€§åˆ¤æ–­

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL OldestXminç³»ç»Ÿå®ç°
   - OldestXminè®¡ç®—ç®—æ³•
   - æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ç®¡ç†
   - æ­»å…ƒç»„è¯†åˆ«æœºåˆ¶

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - OldestXmin â‰ˆ æ ¹å¯¹è±¡é›†åˆ
   - æ´»è·ƒäº‹åŠ¡ â‰ˆ æ´»è·ƒå¼•ç”¨
   - æ­»å…ƒç»„è¯†åˆ« â‰ˆ åƒåœ¾å›æ”¶

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - OldestXmin â‰ˆ å…¨å±€æ—¶é’Ÿ
   - æ´»è·ƒäº‹åŠ¡ â‰ˆ åˆ†å¸ƒå¼æ´»è·ƒäº‹åŠ¡
   - æ­»å…ƒç»„è¯†åˆ« â‰ˆ åˆ†å¸ƒå¼åƒåœ¾å›æ”¶

**å®ç°ç»†èŠ‚**:

**PostgreSQL OldestXminè®¡ç®—å®ç°æ¶æ„**:

```c
// src/backend/access/transam/xact.c

// è®¡ç®—OldestXmin
TransactionId GetOldestXmin(Relation relation, int flags)
{
    TransactionId oldestXmin;
    TransactionId latestCompletedXid;
    ProcArrayStruct *arrayP = procArray;

    // 1. è·å–æœ€æ–°å·²æäº¤äº‹åŠ¡ID
    latestCompletedXid = ShmemVariableCache->latestCompletedXid;

    // 2. è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    LWLockAcquire(ProcArrayLock, LW_SHARED);

    // 3. è®¡ç®—OldestXmin
    oldestXmin = latestCompletedXid + 1;
    for (int i = 0; i < arrayP->numProcs; i++) {
        PGPROC *proc = arrayP->procs[i];
        if (TransactionIdIsValid(proc->xid)) {
            if (TransactionIdPrecedes(proc->xid, oldestXmin)) {
                oldestXmin = proc->xid;
            }
        }
    }

    LWLockRelease(ProcArrayLock);

    return oldestXmin;
}
```

**OldestXminä½¿ç”¨æœºåˆ¶**:

```python
def use_oldest_xmin_for_vacuum():
    """
    OldestXminç”¨äºVACUUM

    æœºåˆ¶:
    1. è®¡ç®—OldestXmin: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
    2. è¯†åˆ«æ­»å…ƒç»„: xmax < OldestXminä¸”xmaxå·²æäº¤
    3. æ¸…ç†æ­»å…ƒç»„: æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´
    4. ä¿è¯: ä¸åˆ é™¤æ´»è·ƒäº‹åŠ¡å¯è§çš„å…ƒç»„
    """
    # 1. è®¡ç®—OldestXmin
    oldest_xmin = compute_oldest_xmin()

    # 2. æ‰«æè¡¨ï¼Œè¯†åˆ«æ­»å…ƒç»„
    dead_tuples = []
    for tuple in table:
        if is_dead_tuple(tuple, oldest_xmin):
            dead_tuples.append(tuple)

    # 3. æ¸…ç†æ­»å…ƒç»„
    for tuple in dead_tuples:
        mark_as_unused(tuple)  # æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´

    return dead_tuples
```

**æ€§èƒ½å½±å“**:

1. **OldestXminè®¡ç®—å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(N_{active})$ - æ‰«ææ‰€æœ‰æ´»è·ƒäº‹åŠ¡
   - ç©ºé—´å¤æ‚åº¦: $O(1)$ - ä¸éœ€è¦é¢å¤–ç©ºé—´
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå–å†³äºæ´»è·ƒäº‹åŠ¡æ•°é‡ï¼‰

2. **OldestXminå¯¹VACUUMçš„å½±å“**:
   - OldestXminè¿‡å°ï¼šæ­»å…ƒç»„æ— æ³•æ¸…ç†ï¼Œè¡¨è†¨èƒ€
   - OldestXminæ­£å¸¸ï¼šæ­»å…ƒç»„å¯ä»¥åŠæ—¶æ¸…ç†
   - æ€»ä½“å½±å“: OldestXminæ˜¯VACUUMçš„å…³é”®å‚æ•°

3. **æ€»ä½“æ€§èƒ½**:
   - OldestXminè®¡ç®—: 1-10Î¼sï¼ˆå¼€é”€å¾ˆå°ï¼‰
   - VACUUMæ€§èƒ½: å–å†³äºOldestXminå’Œæ­»å…ƒç»„æ•°é‡
   - æ€»ä½“å½±å“: OldestXminå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å°ï¼Œä½†å¯¹VACUUMæ•ˆæœå½±å“å¤§

---

#### 5.1.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**OldestXminè®¡ç®—æ—¶é—´å¼€é”€**:

$$T_{oldest\_xmin} = T_{lock\_acquire} + T_{scan} + T_{lock\_release}$$

å…¶ä¸­ï¼š

- $T_{lock\_acquire} = O(1)$ - è·å–é”æ—¶é—´
- $T_{scan} = O(N_{active})$ - æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ—¶é—´
- $T_{lock\_release} = O(1)$ - é‡Šæ”¾é”æ—¶é—´

**OldestXminå¯¹VACUUMæ€§èƒ½çš„å½±å“**:

$$T_{vacuum} = T_{oldest\_xmin} + T_{scan} + T_{clean}$$

å…¶ä¸­ï¼š

- $T_{oldest\_xmin} = O(N_{active})$ - OldestXminè®¡ç®—æ—¶é—´
- $T_{scan} = O(N_{pages})$ - æ‰«æè¡¨æ—¶é—´
- $T_{clean} = O(N_{dead})$ - æ¸…ç†æ­»å…ƒç»„æ—¶é—´

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | æ´»è·ƒäº‹åŠ¡æ•° | OldestXminè®¡ç®—æ—¶é—´ | VACUUMæ—¶é—´ | è¯´æ˜ |
|-----|----------|------------------|-----------|------|
| **æ­£å¸¸è´Ÿè½½** | 10-100 | 1-5Î¼s | 100-500ms | å¼€é”€å¾ˆå° |
| **é«˜å¹¶å‘** | 100-1000 | 5-10Î¼s | 100-500ms | å¼€é”€å¯æ¥å— |
| **é•¿äº‹åŠ¡** | 1-10 | 1-2Î¼s | 100-500ms | OldestXminè¿‡å°ï¼Œæ­»å…ƒç»„æ— æ³•æ¸…ç† |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–OldestXminè®¡ç®—**:
   - ä¼˜åŒ–æ´»è·ƒäº‹åŠ¡åˆ—è¡¨æ‰«æ
   - ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
   - å¹¶è¡ŒVACUUMæ”¯æŒ

2. **é¿å…é•¿äº‹åŠ¡**:
   - æ‹†åˆ†é•¿äº‹åŠ¡
   - ä½¿ç”¨Read Committedï¼ˆå¦‚æœä¸éœ€è¦å¯é‡å¤è¯»ï¼‰
   - ç›‘æ§é•¿äº‹åŠ¡

3. **ç›‘æ§OldestXmin**:
   - ç›‘æ§OldestXminå€¼
   - ç›‘æ§é•¿äº‹åŠ¡
   - ä¼˜åŒ–VACUUMç­–ç•¥

---

#### 5.1.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: OldestXminæ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
2. **ä½œç”¨**: OldestXminç¡®å®šæ­»å…ƒç»„è¾¹ç•Œï¼Œç”¨äºVACUUMè¯†åˆ«æ­»å…ƒç»„
3. **å®ç°**: PostgreSQLé€šè¿‡æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨è®¡ç®—OldestXmin
4. **æ€§èƒ½**: OldestXminè®¡ç®—å¼€é”€å¾ˆå°ï¼ˆ1-10Î¼sï¼‰ï¼Œä½†å¯¹VACUUMæ•ˆæœå½±å“å¤§

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºOldestXminå¯ä»¥éšæ„è®¾ç½®
   - **é”™è¯¯**: OldestXminå¿…é¡»åŸºäºæ‰€æœ‰æ´»è·ƒäº‹åŠ¡è®¡ç®—
   - **æ­£ç¡®**: OldestXminè®¡ç®—å¿…é¡»è€ƒè™‘æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œä¿è¯å®‰å…¨æ€§

2. **è¯¯åŒº2**: è®¤ä¸ºOldestXminä¸é‡è¦
   - **é”™è¯¯**: å¿½ç•¥OldestXminå¯¼è‡´æ­»å…ƒç»„æ— æ³•æ¸…ç†
   - **æ­£ç¡®**: OldestXminæ˜¯VACUUMçš„å…³é”®å‚æ•°ï¼Œå¿…é¡»æ­£ç¡®è®¡ç®—

3. **è¯¯åŒº3**: ä¸ç†è§£é•¿äº‹åŠ¡å¯¹OldestXminçš„å½±å“
   - **é”™è¯¯**: è®¤ä¸ºé•¿äº‹åŠ¡ä¸å½±å“VACUUM
   - **æ­£ç¡®**: é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°ï¼Œæ­»å…ƒç»„æ— æ³•æ¸…ç†

**æœ€ä½³å®è·µ**:

1. **ç†è§£OldestXminæœºåˆ¶**: ç†è§£OldestXminå¦‚ä½•ç¡®å®šæ­»å…ƒç»„è¾¹ç•Œ
2. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡å¯¼è‡´OldestXminè¿‡å°
3. **ç›‘æ§OldestXmin**: ç›‘æ§OldestXminå€¼å’Œé•¿äº‹åŠ¡
4. **ä¼˜åŒ–VACUUMç­–ç•¥**: æ ¹æ®OldestXminä¼˜åŒ–VACUUMç­–ç•¥

---

### 5.2 æ­»å…ƒç»„è¯†åˆ«

**å®šä¹‰5.2 (æ­»å…ƒç»„)**:

$$DeadTuple(v) \iff v.xmax \neq 0 \land v.xmax < \text{OldestXmin}$$

å…¶ä¸­ $\text{OldestXmin}$ = æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID

**ç®—æ³•5.2: è®¡ç®—OldestXmin**:

```python
def compute_oldest_xmin():
    active_txs = get_active_transactions()  # è·å–æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
    if not active_txs:
        return get_latest_completed_xid()

    return min(tx.xmin for tx in active_txs)
```

### 5.2 æ¸…ç†è¿‡ç¨‹

**é˜¶æ®µ1: æ‰«æè¡¨**:

```python
def vacuum_table(table):
    oldest_xmin = compute_oldest_xmin()
    dead_tuples = []

    for page in table.pages:
        for tuple in page.tuples:
            if is_dead(tuple, oldest_xmin):
                dead_tuples.append(tuple)
                mark_as_unused(tuple)  # æ ‡è®°ä¸ºå¯ç”¨ç©ºé—´

    update_fsm(table, dead_tuples)  # æ›´æ–°ç©ºé—²ç©ºé—´æ˜ å°„
    return dead_tuples
```

**é˜¶æ®µ2: æ¸…ç†ç´¢å¼•**:

```python
def vacuum_indexes(table, dead_tuples):
    dead_ctids = {tuple.ctid for tuple in dead_tuples}

    for index in table.indexes:
        for entry in index.entries:
            if entry.ctid in dead_ctids:
                delete_index_entry(index, entry)
```

**é˜¶æ®µ3: æˆªæ–­è¡¨æ–‡ä»¶**ï¼ˆå¯é€‰ï¼‰

```python
def truncate_table(table):
    # å¦‚æœè¡¨å°¾éƒ¨æœ‰è¿ç»­çš„ç©ºé¡µé¢ï¼Œç‰©ç†æˆªæ–­æ–‡ä»¶
    empty_pages = count_trailing_empty_pages(table)
    if empty_pages > threshold:
        truncate_file(table, empty_pages)
```

### 5.3 Freezeæ“ä½œ

**é—®é¢˜**: 32ä½äº‹åŠ¡IDå›å·

$$\text{XID} \in [0, 2^{32}-1] \implies \text{wrap-around after } 4B \text{ transactions}$$

**è§£å†³**: Freezeæ—§å…ƒç»„

```sql
-- å½“å…ƒç»„å¹´é¾„è¶…è¿‡é˜ˆå€¼
IF (current_xid - tuple.xmin) > autovacuum_freeze_max_age THEN
    tuple.xmin := FrozenTransactionId  -- ç‰¹æ®Šå€¼: 2
    -- è¯¥å…ƒç»„å˜ä¸º"æ°¸ä¹…å¯è§"
```

**Freezeç­–ç•¥**:

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|------|
| `vacuum_freeze_min_age` | 50M | è§¦å‘freezeçš„æœ€å°å¹´é¾„ |
| `vacuum_freeze_table_age` | 150M | å¼ºåˆ¶freezeæ•´è¡¨çš„å¹´é¾„ |
| `autovacuum_freeze_max_age` | 200M | é˜²æ­¢å›å·çš„æœ€å¤§å¹´é¾„ |

---

## å…­ã€ä¼˜åŒ–æŠ€æœ¯

### 6.0 Hint Bits å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 6.0.0 æƒå¨å®šä¹‰ä¸æ¥æº

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> Hint bits are small flags stored within each tuple's header that indicate the commit status of the transactions that created or deleted the tuple. These bits help the database quickly determine tuple visibility without repeatedly consulting the transaction log (pg_clog), thereby enhancing read performance.

**PostgreSQL Wikiå®šä¹‰**:

> Hint bits are optimization flags stored in the tuple header that cache the commit status of transactions. When a tuple is accessed, PostgreSQL checks these hint bits to determine its visibility. If the relevant hint bit is set, the system can immediately ascertain the tuple's visibility status without consulting pg_clog.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„Hint Bitså®ç°åŒ…æ‹¬å››ä¸ªä¸»è¦æ ‡å¿—ä½ï¼š

```c
// src/include/access/htup_details.h

// Hint Bitså®šä¹‰
# define HEAP_XMIN_COMMITTED      0x0100  // xminäº‹åŠ¡å·²æäº¤
# define HEAP_XMIN_INVALID        0x0200  // xminäº‹åŠ¡å·²å›æ»š
# define HEAP_XMAX_COMMITTED      0x0400  // xmaxäº‹åŠ¡å·²æäº¤
# define HEAP_XMAX_INVALID        0x0800  // xmaxäº‹åŠ¡å·²å›æ»š

// å…ƒç»„ä¿¡æ¯æ©ç 
typedef struct HeapTupleHeaderData
{
    union
    {
        HeapTupleFields t_heap;
        DatumTupleFields t_datum;
    } t_choice;

    ItemPointerData t_ctid;      // å½“å‰å…ƒç»„IDæˆ–æ›´æ–°å…ƒç»„ID

    uint16 t_infomask2;          // æ ‡å¿—ä½2ï¼ˆåŒ…æ‹¬Hint Bitsï¼‰
    uint16 t_infomask;            // æ ‡å¿—ä½ï¼ˆåŒ…æ‹¬Hint Bitsï¼‰
    uint8 t_hoff;                 // å¤´éƒ¨å¤§å°
    bits8 t_bits[FLEXIBLE_ARRAY_MEMBER];  // NULLä½å›¾
} HeapTupleHeaderData;
```

**æœ¬ä½“ç³»å®šä¹‰**:

Hint Bitsæ˜¯PostgreSQL MVCCä¸­ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ã€‚Hint Bitsæ˜¯å­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨çš„æ ‡å¿—ä½ï¼Œç”¨äºç¼“å­˜åˆ›å»ºæˆ–åˆ é™¤è¯¥å…ƒç»„çš„äº‹åŠ¡çš„æäº¤çŠ¶æ€ã€‚é€šè¿‡Hint Bitsï¼Œç³»ç»Ÿå¯ä»¥å¿«é€Ÿåˆ¤æ–­å…ƒç»„çš„å¯è§æ€§ï¼Œæ— éœ€é‡å¤æŸ¥è¯¢äº‹åŠ¡æ—¥å¿—ï¼ˆpg_clogï¼‰ï¼Œä»è€Œæ˜¾è‘—æå‡è¯»æ“ä½œçš„æ€§èƒ½ã€‚

**Hint Bitsä¸MVCCçš„å…³ç³»**:

```text
MVCCå¯è§æ€§åˆ¤æ–­ä¼˜åŒ–æœºåˆ¶:
â”‚
â”œâ”€ MVCCå¯è§æ€§åˆ¤æ–­ â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é—®é¢˜: æ¯æ¬¡å¯è§æ€§åˆ¤æ–­éœ€è¦æŸ¥è¯¢pg_clog
â”‚       â””â”€ è§£å†³: Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
â”‚
â””â”€ Hint Bitsæœºåˆ¶
    â””â”€ å®šä¹‰: ç¼“å­˜äº‹åŠ¡æäº¤çŠ¶æ€çš„æ ‡å¿—ä½
        â”œâ”€ XMIN_COMMITTED: xminäº‹åŠ¡å·²æäº¤
        â”œâ”€ XMIN_INVALID: xminäº‹åŠ¡å·²å›æ»š
        â”œâ”€ XMAX_COMMITTED: xmaxäº‹åŠ¡å·²æäº¤
        â””â”€ XMAX_INVALID: xmaxäº‹åŠ¡å·²å›æ»š
```

---

#### 6.0.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰6.0.1 (Hint Bits)**:

Hint Bitsæ˜¯å…ƒç»„$\tau$å¤´éƒ¨çš„æ ‡å¿—ä½ï¼Œç”¨äºç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼š

$$\text{HintBits}(\tau) = \{XMIN\_COMMITTED, XMIN\_INVALID, XMAX\_COMMITTED, XMAX\_INVALID\}$$

å…¶ä¸­ï¼š

- $XMIN\_COMMITTED$: $\tau.xmin$äº‹åŠ¡å·²æäº¤
- $XMIN\_INVALID$: $\tau.xmin$äº‹åŠ¡å·²å›æ»š
- $XMAX\_COMMITTED$: $\tau.xmax$äº‹åŠ¡å·²æäº¤ï¼ˆå¦‚æœ$\tau.xmax \neq 0$ï¼‰
- $XMAX\_INVALID$: $\tau.xmax$äº‹åŠ¡å·²å›æ»šï¼ˆå¦‚æœ$\tau.xmax \neq 0$ï¼‰

**å®šä¹‰6.0.2 (Hint Bitsè®¾ç½®æ¡ä»¶)**:

Hint Bitsåœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹è®¾ç½®ï¼š

$$\text{SetHintBit}(\tau, \text{bit}) \iff \text{QueryClog}(\tau.xid) \land \text{bit} = \text{Status}(\tau.xid)$$

å…¶ä¸­ï¼š

- $\text{QueryClog}(\tau.xid)$: æŸ¥è¯¢pg_clogè·å–äº‹åŠ¡çŠ¶æ€
- $\text{Status}(\tau.xid)$: äº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼ˆCOMMITTEDæˆ–ABORTEDï¼‰

å³ï¼šå½“æŸ¥è¯¢pg_clogè·å–äº‹åŠ¡çŠ¶æ€åï¼Œè®¾ç½®å¯¹åº”çš„Hint Bitã€‚

**å®šä¹‰6.0.3 (Hint Bitsä½¿ç”¨æ¡ä»¶)**:

Hint Bitsåœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹ä½¿ç”¨ï¼š

$$\text{UseHintBit}(\tau, \text{bit}) \iff \text{HintBitSet}(\tau, \text{bit}) \land \text{Valid}(\tau, \text{bit})$$

å…¶ä¸­ï¼š

- $\text{HintBitSet}(\tau, \text{bit})$: Hint Bitå·²è®¾ç½®
- $\text{Valid}(\tau, \text{bit})$: Hint Bitæœ‰æ•ˆï¼ˆäº‹åŠ¡çŠ¶æ€æœªæ”¹å˜ï¼‰

å³ï¼šå¦‚æœHint Bitå·²è®¾ç½®ä¸”æœ‰æ•ˆï¼Œåˆ™ä½¿ç”¨Hint Bitåˆ¤æ–­å¯è§æ€§ï¼Œæ— éœ€æŸ¥è¯¢pg_clogã€‚

**å®šä¹‰6.0.4 (Hint Bitsæ€§èƒ½ä¼˜åŒ–)**:

Hint Bitså°†å¯è§æ€§åˆ¤æ–­çš„æ—¶é—´å¤æ‚åº¦ä»ï¼š

$$T_{visibility} = T_{clog\_query} = O(1) \text{ (ä½†éœ€è¦ç£ç›˜I/O)}$$

ä¼˜åŒ–ä¸ºï¼š

$$T_{visibility} = T_{hint\_bit\_check} = O(1) \text{ (ä»…å†…å­˜è®¿é—®)}$$

å³ï¼šHint Bitså°†å¯è§æ€§åˆ¤æ–­ä»éœ€è¦ç£ç›˜I/Oçš„pg_clogæŸ¥è¯¢ä¼˜åŒ–ä¸ºä»…å†…å­˜è®¿é—®çš„ä½æ£€æŸ¥ã€‚

---

#### 6.0.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **1990å¹´ä»£**: PostgreSQLæ—©æœŸå®ç°
   - æ¯æ¬¡å¯è§æ€§åˆ¤æ–­éƒ½æŸ¥è¯¢pg_clog
   - æ€§èƒ½å¼€é”€å¤§ï¼Œéœ€è¦ç£ç›˜I/O
   - è¯»æ“ä½œæ€§èƒ½ç“¶é¢ˆ

2. **2000å¹´ä»£**: Hint Bitsä¼˜åŒ–å¼•å…¥
   - PostgreSQLå¼•å…¥Hint Bitsæœºåˆ¶
   - ç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼Œå‡å°‘pg_clogæŸ¥è¯¢
   - æ˜¾è‘—æå‡è¯»æ“ä½œæ€§èƒ½

3. **2010å¹´ä»£**: Hint Bitsä¼˜åŒ–å®Œå–„
   - ä¼˜åŒ–Hint Bitsè®¾ç½®ç­–ç•¥
   - å‡å°‘Hint Bitså¯¼è‡´çš„é¡µé¢è„é¡µ
   - å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§

4. **2020å¹´ä»£è‡³ä»Š**: Hint Bitsæœºåˆ¶æˆç†Ÿ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ä½¿ç”¨ç±»ä¼¼æœºåˆ¶
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–Hint Bitsæ€§èƒ½
   - Hint Bitsæˆä¸ºMVCCå¯è§æ€§åˆ¤æ–­çš„æ ‡å‡†ä¼˜åŒ–

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦Hint Bitsï¼Ÿ**

1. **æ€§èƒ½ä¼˜åŒ–çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: æ¯æ¬¡å¯è§æ€§åˆ¤æ–­éœ€è¦æŸ¥è¯¢pg_clogï¼Œéœ€è¦ç£ç›˜I/O
   - **è§£å†³**: Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼Œé¿å…é‡å¤æŸ¥è¯¢pg_clog
   - **æ•ˆæœ**: æ˜¾è‘—æå‡è¯»æ“ä½œæ€§èƒ½

2. **å‡å°‘I/Oå¼€é”€çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: pg_clogæŸ¥è¯¢éœ€è¦ç£ç›˜I/Oï¼Œå»¶è¿Ÿé«˜
   - **è§£å†³**: Hint Bitså­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨ï¼Œä»…éœ€å†…å­˜è®¿é—®
   - **æ•ˆæœ**: å‡å°‘I/Oå¼€é”€ï¼Œé™ä½å»¶è¿Ÿ

3. **ç¼“å­˜ä¸€è‡´æ€§çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: éœ€è¦ä¿è¯Hint Bitsä¸pg_clogä¸€è‡´
   - **è§£å†³**: Hint Bitsåœ¨æŸ¥è¯¢pg_clogåè®¾ç½®ï¼Œä¿è¯ä¸€è‡´æ€§
   - **æ•ˆæœ**: ä¿è¯æ­£ç¡®æ€§çš„åŒæ—¶ä¼˜åŒ–æ€§èƒ½

**ç†è®ºä½ç½®**:

```text
MVCCå¯è§æ€§åˆ¤æ–­ä¼˜åŒ–æœºåˆ¶å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ MVCCå¯è§æ€§åˆ¤æ–­
â”‚   â””â”€ é—®é¢˜: æ¯æ¬¡åˆ¤æ–­éœ€è¦æŸ¥è¯¢pg_clog
â”‚       â””â”€ è§£å†³: Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
â”‚
â”œâ”€ Hint Bitsæœºåˆ¶ â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: ç¼“å­˜äº‹åŠ¡æäº¤çŠ¶æ€çš„æ ‡å¿—ä½
â”‚       â”œâ”€ XMIN_COMMITTED: xminäº‹åŠ¡å·²æäº¤
â”‚       â”œâ”€ XMIN_INVALID: xminäº‹åŠ¡å·²å›æ»š
â”‚       â”œâ”€ XMAX_COMMITTED: xmaxäº‹åŠ¡å·²æäº¤
â”‚       â””â”€ XMAX_INVALID: xmaxäº‹åŠ¡å·²å›æ»š
â”‚
â””â”€ å­˜å‚¨å±‚
    â””â”€ å…ƒç»„å¤´éƒ¨ã€pg_clog
```

**Hint Bitsä¸MVCCçš„å…³ç³»**:

```text
Hint Bitsä¸MVCC:
â”‚
â”œâ”€ MVCCæ˜¯å¹¶å‘æ§åˆ¶æœºåˆ¶
â”‚   â””â”€ éœ€è¦å¯è§æ€§åˆ¤æ–­
â”‚
â””â”€ Hint Bitsæ˜¯æ€§èƒ½ä¼˜åŒ–æœºåˆ¶
    â””â”€ ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½
```

**ç†è®ºæ¨å¯¼**:

```text
ä»å¯è§æ€§åˆ¤æ–­æ€§èƒ½é—®é¢˜åˆ°Hint Bitsä¼˜åŒ–çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: MVCCæ”¯æŒè¯»å†™å¹¶å‘ï¼ˆå¿…é¡»ï¼‰
   â”œâ”€ éœ€æ±‚: é«˜æ€§èƒ½è¯»æ“ä½œï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: å‡å°‘I/Oå¼€é”€ï¼ˆé‡è¦ï¼‰

2. Hint Bitsè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: ç¼“å­˜äº‹åŠ¡çŠ¶æ€
   â”œâ”€ æœºåˆ¶: åœ¨å…ƒç»„å¤´éƒ¨å­˜å‚¨æ ‡å¿—ä½
   â””â”€ ä¼˜åŒ–: é¿å…é‡å¤æŸ¥è¯¢pg_clog

3. å®ç°é€‰æ‹©
   â”œâ”€ Hint Bitsè®¾ç½®: æŸ¥è¯¢pg_clogåè®¾ç½®
   â”œâ”€ Hint Bitsä½¿ç”¨: ä¼˜å…ˆä½¿ç”¨Hint Bits
   â””â”€ ä¸€è‡´æ€§ä¿è¯: Hint Bitsä¸pg_clogä¸€è‡´

4. ç»“è®º
   â””â”€ Hint Bitsæ˜¯ä¼˜åŒ–MVCCå¯è§æ€§åˆ¤æ–­æ€§èƒ½çš„æ ‡å‡†æ–¹æ³•
```

---

#### 6.0.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½**

```sql
-- åœºæ™¯: é«˜å¹¶å‘è¯»æ“ä½œ
-- éœ€æ±‚: å¿…é¡»ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½

-- åˆå§‹çŠ¶æ€ï¼ˆæ— Hint Bitsï¼‰
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æŸ¥è¯¢pg_clogåˆ¤æ–­xmin/xmaxçŠ¶æ€
-- å¼€é”€: ç£ç›˜I/Oï¼Œå»¶è¿Ÿé«˜ âœ—

-- è®¾ç½®Hint Bitså
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æ£€æŸ¥Hint Bitsåˆ¤æ–­xmin/xmaxçŠ¶æ€
-- å¼€é”€: ä»…å†…å­˜è®¿é—®ï¼Œå»¶è¿Ÿä½ âœ“
-- æ€§èƒ½æå‡: 10-100Ã— âœ“
```

**åˆ†æ**:

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šHint Bitsé¿å…é‡å¤æŸ¥è¯¢pg_clogï¼Œæ˜¾è‘—æå‡æ€§èƒ½
- âœ… å»¶è¿Ÿé™ä½ï¼šä»ç£ç›˜I/Oé™ä½åˆ°å†…å­˜è®¿é—®ï¼Œå»¶è¿Ÿé™ä½10-100Ã—
- âœ… ååé‡æå‡ï¼šè¯»æ“ä½œååé‡æå‡10-100Ã—

---

**æ­£ä¾‹2: Hint Bitså‡å°‘pg_clogæŸ¥è¯¢**

```sql
-- åœºæ™¯: åŒä¸€å…ƒç»„è¢«å¤šæ¬¡è®¿é—®
-- éœ€æ±‚: å‡å°‘é‡å¤çš„pg_clogæŸ¥è¯¢

-- ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆæ— Hint Bitsï¼‰
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æŸ¥è¯¢pg_clogåˆ¤æ–­xminçŠ¶æ€
-- è®¾ç½®: XMIN_COMMITTED = 1

-- ç¬¬äºŒæ¬¡è®¿é—®ï¼ˆæœ‰Hint Bitsï¼‰
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æ£€æŸ¥Hint Bitsï¼ŒXMIN_COMMITTEDå·²è®¾ç½®
-- è·³è¿‡: æ— éœ€æŸ¥è¯¢pg_clog âœ“
-- æ€§èƒ½æå‡: é¿å…ç£ç›˜I/O âœ“
```

**åˆ†æ**:

- âœ… å‡å°‘æŸ¥è¯¢ï¼šHint Bitsé¿å…é‡å¤æŸ¥è¯¢pg_clog
- âœ… æ€§èƒ½æå‡ï¼šåç»­è®¿é—®ç›´æ¥ä½¿ç”¨Hint Bitsï¼Œæ€§èƒ½æå‡æ˜¾è‘—
- âœ… ç³»ç»Ÿè´Ÿè½½ï¼šå‡å°‘pg_clogæŸ¥è¯¢ï¼Œé™ä½ç³»ç»Ÿè´Ÿè½½

---

**åä¾‹åˆ†æ**:

**åä¾‹1: Hint Bitså¯¼è‡´é¡µé¢è„é¡µ**

```sql
-- é”™è¯¯åœºæ™¯: Hint Bitsè®¾ç½®å¯¼è‡´é¡µé¢è„é¡µ
-- é—®é¢˜: åªè¯»æ“ä½œå¯¼è‡´é¡µé¢å˜è„ï¼Œå¢åŠ I/Oå¼€é”€

-- åœºæ™¯: åªè¯»æŸ¥è¯¢
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æŸ¥è¯¢pg_clogï¼Œè®¾ç½®Hint Bits
-- é—®é¢˜: é¡µé¢å˜è„ï¼Œéœ€è¦åˆ·ç›˜ âœ—
-- ç»“æœ: åªè¯»æ“ä½œå¯¼è‡´å†™I/O âœ—
```

**é”™è¯¯åŸå› **:

- Hint Bitsè®¾ç½®éœ€è¦ä¿®æ”¹å…ƒç»„å¤´éƒ¨ï¼Œå¯¼è‡´é¡µé¢å˜è„
- åªè¯»æ“ä½œå¯¼è‡´å†™I/Oï¼Œå¢åŠ ç³»ç»Ÿå¼€é”€
- å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½

**æ­£ç¡®åšæ³•**:

```sql
-- PostgreSQLä¼˜åŒ–ç­–ç•¥
-- 1. å»¶è¿Ÿè®¾ç½®Hint Bitsï¼ˆä»…åœ¨å¿…è¦æ—¶è®¾ç½®ï¼‰
-- 2. æ‰¹é‡è®¾ç½®Hint Bitsï¼ˆå‡å°‘é¡µé¢åˆ·ç›˜ï¼‰
-- 3. åªè¯»é¡µé¢ä¸ç«‹å³åˆ·ç›˜ï¼ˆå»¶è¿Ÿåˆ·ç›˜ï¼‰

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æŸ¥è¯¢pg_clogï¼Œè®¾ç½®Hint Bits
-- ä¼˜åŒ–: é¡µé¢æ ‡è®°ä¸ºè„ï¼Œä½†ä¸ç«‹å³åˆ·ç›˜ âœ“
-- ç»“æœ: å‡å°‘å†™I/Oï¼Œæ€§èƒ½å¯æ¥å— âœ“
```

**åæœåˆ†æ**:

- **å†™I/Oå¢åŠ **: åªè¯»æ“ä½œå¯¼è‡´å†™I/Oï¼Œå¢åŠ ç³»ç»Ÿå¼€é”€
- **æ€§èƒ½ä¸‹é™**: é¡µé¢åˆ·ç›˜å½±å“ç³»ç»Ÿæ€§èƒ½
- **ç³»ç»Ÿè´Ÿè½½**: å¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œå½±å“æ•´ä½“æ€§èƒ½

---

**åä¾‹2: Hint Bitsä¸ä¸€è‡´å¯¼è‡´é”™è¯¯åˆ¤æ–­**

```sql
-- é”™è¯¯åœºæ™¯: Hint Bitsä¸pg_clogä¸ä¸€è‡´
-- é—®é¢˜: Hint Bitsç¼“å­˜çš„çŠ¶æ€å¯èƒ½è¿‡æœŸ

-- åœºæ™¯: äº‹åŠ¡çŠ¶æ€æ”¹å˜
-- 1. åˆå§‹çŠ¶æ€: XMIN_COMMITTED = 1
-- 2. äº‹åŠ¡å›æ»šï¼ˆç†è®ºä¸Šä¸å¯èƒ½ï¼Œä½†å‡è®¾å‘ç”Ÿï¼‰
-- 3. Hint Bitsä»ä¸ºCOMMITTED âœ—
-- ç»“æœ: é”™è¯¯åˆ¤æ–­å¯è§æ€§ âœ—
```

**é”™è¯¯åŸå› **:

- Hint Bitsç¼“å­˜çš„çŠ¶æ€å¯èƒ½è¿‡æœŸ
- å¦‚æœpg_clogçŠ¶æ€æ”¹å˜ï¼ŒHint Bitså¯èƒ½ä¸ä¸€è‡´
- å¯¼è‡´é”™è¯¯åˆ¤æ–­å¯è§æ€§

**æ­£ç¡®åšæ³•**:

```sql
-- PostgreSQLä¿è¯æœºåˆ¶
-- 1. Hint Bitsä»…åœ¨æŸ¥è¯¢pg_clogåè®¾ç½®
-- 2. pg_clogçŠ¶æ€ä¸ä¼šæ”¹å˜ï¼ˆå·²æäº¤äº‹åŠ¡ä¸ä¼šå›æ»šï¼‰
-- 3. å¦‚æœHint Bitsæœªè®¾ç½®ï¼ŒæŸ¥è¯¢pg_clog

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æ£€æŸ¥Hint Bits
-- å¦‚æœæœªè®¾ç½®: æŸ¥è¯¢pg_clogï¼Œè®¾ç½®Hint Bits âœ“
-- å¦‚æœå·²è®¾ç½®: ä½¿ç”¨Hint Bitsï¼Œæ— éœ€æŸ¥è¯¢pg_clog âœ“
-- ç»“æœ: ä¿è¯æ­£ç¡®æ€§ï¼Œä¼˜åŒ–æ€§èƒ½ âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: Hint Bitsä¸ä¸€è‡´å¯¼è‡´é”™è¯¯åˆ¤æ–­å¯è§æ€§
- **æ•°æ®ä¸ä¸€è‡´**: å¯èƒ½è¯»å–åˆ°ä¸åº”è¯¥çœ‹åˆ°çš„æ•°æ®
- **ç³»ç»Ÿé”™è¯¯**: è¿åMVCCå¯è§æ€§ä¿è¯

---

**åä¾‹3: å¿½ç•¥Hint Bitså¯¼è‡´æ€§èƒ½é—®é¢˜**

```sql
-- é”™è¯¯åœºæ™¯: ç¦ç”¨Hint Bitsæˆ–å¿½ç•¥ä¼˜åŒ–
-- é—®é¢˜: æ¯æ¬¡å¯è§æ€§åˆ¤æ–­éƒ½æŸ¥è¯¢pg_clog

-- é”™è¯¯é…ç½®ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- å‡è®¾: ç¦ç”¨Hint Bitsæœºåˆ¶

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æ¯æ¬¡æŸ¥è¯¢pg_clogåˆ¤æ–­xmin/xmaxçŠ¶æ€ âœ—
-- å¼€é”€: ç£ç›˜I/Oï¼Œå»¶è¿Ÿé«˜ âœ—
-- ç»“æœ: è¯»æ“ä½œæ€§èƒ½æå·® âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥Hint Bitsä¼˜åŒ–ï¼Œæ¯æ¬¡æŸ¥è¯¢pg_clog
- ç£ç›˜I/Oå¼€é”€å¤§ï¼Œå»¶è¿Ÿé«˜
- è¯»æ“ä½œæ€§èƒ½å·®

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: ä½¿ç”¨Hint Bitsä¼˜åŒ–
-- PostgreSQLé»˜è®¤å¯ç”¨Hint Bits

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM accounts WHERE id = 1;
-- å†…éƒ¨: æ£€æŸ¥Hint Bitsï¼Œå¦‚æœæœªè®¾ç½®åˆ™æŸ¥è¯¢pg_clogå¹¶è®¾ç½®
-- å¼€é”€: é¦–æ¬¡æŸ¥è¯¢pg_clogï¼Œåç»­ä½¿ç”¨Hint Bits âœ“
-- ç»“æœ: è¯»æ“ä½œæ€§èƒ½é«˜ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: æ¯æ¬¡æŸ¥è¯¢pg_clogï¼Œæ€§èƒ½ä¸‹é™10-100Ã—
- **å»¶è¿Ÿå¢åŠ **: ç£ç›˜I/Oå»¶è¿Ÿé«˜ï¼Œå»¶è¿Ÿå¢åŠ 10-100Ã—
- **ç³»ç»Ÿè´Ÿè½½**: pg_clogæŸ¥è¯¢å¢åŠ ç³»ç»Ÿè´Ÿè½½

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: é«˜å¹¶å‘è¯»æ“ä½œä½¿ç”¨Hint Bits**

**åœºæ™¯æè¿°**:

- æ–°é—»ç½‘ç«™ï¼Œè¯»æ“ä½œ100,000 QPS
- éœ€è¦ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½
- Hint Bitsæ˜¾è‘—æå‡æ€§èƒ½

**ä¸ºä»€ä¹ˆéœ€è¦Hint Bits**:

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…é‡å¤æŸ¥è¯¢pg_clogï¼Œæ˜¾è‘—æå‡æ€§èƒ½
- âœ… å»¶è¿Ÿé™ä½ï¼šä»ç£ç›˜I/Oé™ä½åˆ°å†…å­˜è®¿é—®
- âœ… ååé‡æå‡ï¼šè¯»æ“ä½œååé‡æå‡10-100Ã—

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLé»˜è®¤å¯ç”¨Hint Bits
-- æ— éœ€ç‰¹æ®Šé…ç½®

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM articles WHERE id = 123;
-- å†…éƒ¨: æ£€æŸ¥Hint Bits
-- å¦‚æœå·²è®¾ç½®: ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€æŸ¥è¯¢pg_clog âœ“
-- å¦‚æœæœªè®¾ç½®: æŸ¥è¯¢pg_clogï¼Œè®¾ç½®Hint Bits âœ“
-- ç»“æœ: æ€§èƒ½ä¼˜åŒ– âœ“
```

**æ•ˆæœåˆ†æ**:

- **æ€§èƒ½**: è¯»æ“ä½œæ€§èƒ½æå‡10-100Ã— âœ“
- **å»¶è¿Ÿ**: å»¶è¿Ÿé™ä½10-100Ã— âœ“
- **ååé‡**: ååé‡æå‡10-100Ã— âœ“

---

**åœºæ™¯2: åªè¯»é¡µé¢ä¼˜åŒ–Hint Bitsè®¾ç½®**

**åœºæ™¯æè¿°**:

- å†å²æ•°æ®è¡¨ï¼Œä¸»è¦æ˜¯åªè¯»æ“ä½œ
- éœ€è¦ä¼˜åŒ–Hint Bitsè®¾ç½®ï¼Œå‡å°‘é¡µé¢è„é¡µ

**ä¸ºä»€ä¹ˆéœ€è¦Hint Bitsä¼˜åŒ–**:

- âœ… å‡å°‘è„é¡µï¼šä¼˜åŒ–Hint Bitsè®¾ç½®ç­–ç•¥ï¼Œå‡å°‘é¡µé¢è„é¡µ
- âœ… é™ä½I/Oï¼šå‡å°‘å†™I/Oï¼Œé™ä½ç³»ç»Ÿå¼€é”€
- âœ… æ€§èƒ½å¹³è¡¡ï¼šå¹³è¡¡Hint Bitsæ€§èƒ½å’Œé¡µé¢è„é¡µå¼€é”€

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- PostgreSQLä¼˜åŒ–ç­–ç•¥
-- 1. å»¶è¿Ÿè®¾ç½®Hint Bitsï¼ˆä»…åœ¨å¿…è¦æ—¶è®¾ç½®ï¼‰
-- 2. æ‰¹é‡è®¾ç½®Hint Bitsï¼ˆå‡å°‘é¡µé¢åˆ·ç›˜ï¼‰
-- 3. åªè¯»é¡µé¢ä¸ç«‹å³åˆ·ç›˜ï¼ˆå»¶è¿Ÿåˆ·ç›˜ï¼‰

-- ç³»ç»Ÿè¡Œä¸º
SELECT * FROM history WHERE id = 1;
-- å†…éƒ¨: æŸ¥è¯¢pg_clogï¼Œè®¾ç½®Hint Bits
-- ä¼˜åŒ–: é¡µé¢æ ‡è®°ä¸ºè„ï¼Œä½†ä¸ç«‹å³åˆ·ç›˜ âœ“
-- ç»“æœ: å‡å°‘å†™I/Oï¼Œæ€§èƒ½å¯æ¥å— âœ“
```

**æ•ˆæœåˆ†æ**:

- **è„é¡µå‡å°‘**: ä¼˜åŒ–Hint Bitsè®¾ç½®ï¼Œå‡å°‘é¡µé¢è„é¡µ âœ“
- **I/Oé™ä½**: å‡å°‘å†™I/Oï¼Œé™ä½ç³»ç»Ÿå¼€é”€ âœ“
- **æ€§èƒ½å¹³è¡¡**: å¹³è¡¡Hint Bitsæ€§èƒ½å’Œé¡µé¢è„é¡µå¼€é”€ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»å¯è§æ€§åˆ¤æ–­æ€§èƒ½é—®é¢˜åˆ°Hint Bitsä¼˜åŒ–çš„æ¨ç†**

```text
å‰æ1: MVCCéœ€è¦å¯è§æ€§åˆ¤æ–­ï¼ˆå¿…é¡»ï¼‰
å‰æ2: æ¯æ¬¡åˆ¤æ–­æŸ¥è¯¢pg_clogæ€§èƒ½ä½ï¼ˆå¿…é¡»ä¼˜åŒ–ï¼‰
å‰æ3: éœ€è¦ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­çš„æœºåˆ¶
æ¨ç†æ­¥éª¤2: Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€ï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: Hint Bitsé¿å…é‡å¤æŸ¥è¯¢pg_clogï¼ˆæ»¡è¶³å‰æ2ï¼‰

ç»“è®º: ä½¿ç”¨Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½ âœ“
```

**æ¨ç†é“¾æ¡2: ä»Hint Bitsè®¾ç½®åˆ°æ€§èƒ½ä¼˜åŒ–çš„æ¨ç†**

```text
å‰æ1: Hint Bitsç¼“å­˜äº‹åŠ¡çŠ¶æ€
å‰æ2: Hint Bitsé¿å…é‡å¤æŸ¥è¯¢pg_clog
å‰æ3: pg_clogæŸ¥è¯¢éœ€è¦ç£ç›˜I/O

æ¨ç†æ­¥éª¤1: Hint Bitsé¿å…é‡å¤æŸ¥è¯¢pg_clog
æ¨ç†æ­¥éª¤2: å‡å°‘ç£ç›˜I/Oï¼Œé™ä½å»¶è¿Ÿ
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒHint Bitsæ˜¾è‘—æå‡æ€§èƒ½

ç»“è®º: Hint Bitsæœºåˆ¶æ˜¾è‘—æå‡å¯è§æ€§åˆ¤æ–­æ€§èƒ½ âœ“
```

---

#### 6.0.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸å¯è§æ€§åˆ¤æ–­çš„å…³ç³»**:
   - Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½
   - å¯è§æ€§åˆ¤æ–­ä½¿ç”¨Hint Bitsé¿å…æŸ¥è¯¢pg_clog
   - Hint Bitsæ˜¯å¯è§æ€§åˆ¤æ–­çš„é‡è¦ä¼˜åŒ–

2. **ä¸pg_clogçš„å…³ç³»**:
   - Hint Bitsç¼“å­˜pg_clogä¸­çš„äº‹åŠ¡çŠ¶æ€
   - å¦‚æœHint Bitsæœªè®¾ç½®ï¼ŒæŸ¥è¯¢pg_clog
   - Hint Bitsä¸pg_clogä¿æŒä¸€è‡´

3. **ä¸xmin/xmaxçš„å…³ç³»**:
   - Hint Bitsç¼“å­˜xmin/xmaxäº‹åŠ¡çš„çŠ¶æ€
   - xmin/xmaxæ˜¯Hint Bitsç¼“å­˜çš„ç›®æ ‡
   - Hint Bitsä¼˜åŒ–xmin/xmaxçŠ¶æ€æŸ¥è¯¢

4. **ä¸MVCCçš„å…³ç³»**:
   - Hint Bitsæ˜¯MVCCå¯è§æ€§åˆ¤æ–­çš„ä¼˜åŒ–æœºåˆ¶
   - MVCCéœ€è¦å¯è§æ€§åˆ¤æ–­ï¼ŒHint Bitsä¼˜åŒ–æ€§èƒ½
   - Hint Bitsç»´æŒMVCCç³»ç»Ÿçš„è¯»æ“ä½œæ€§èƒ½

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL Hint Bitsç³»ç»Ÿå®ç°
   - Hint Bitså­˜å‚¨åœ¨å…ƒç»„å¤´éƒ¨
   - pg_clogå­˜å‚¨äº‹åŠ¡çŠ¶æ€
   - å¯è§æ€§åˆ¤æ–­ä½¿ç”¨Hint Bits

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - Hint Bits â‰ˆ ç¼“å­˜æ ‡å¿—ä½
   - pg_clog â‰ˆ çŠ¶æ€å­˜å‚¨
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ çŠ¶æ€æ£€æŸ¥

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - Hint Bits â‰ˆ æœ¬åœ°ç¼“å­˜
   - pg_clog â‰ˆ åˆ†å¸ƒå¼çŠ¶æ€å­˜å‚¨
   - å¯è§æ€§åˆ¤æ–­ â‰ˆ åˆ†å¸ƒå¼çŠ¶æ€æ£€æŸ¥

**å®ç°ç»†èŠ‚**:

**PostgreSQL Hint Bitså®ç°æ¶æ„**:

```c
// src/backend/access/heap/heapam_visibility.c

// æ£€æŸ¥Hint Bits
bool HeapTupleHeaderXminCommitted(HeapTupleHeader tuple)
{
    return (tuple->t_infomask & HEAP_XMIN_COMMITTED) != 0;
}

bool HeapTupleHeaderXminInvalid(HeapTupleHeader tuple)
{
    return (tuple->t_infomask & HEAP_XMIN_INVALID) != 0;
}

// è®¾ç½®Hint Bits
void SetHintBits(HeapTupleHeader tuple, TransactionId xid, uint16 infomask)
{
    // 1. æŸ¥è¯¢pg_clogè·å–äº‹åŠ¡çŠ¶æ€
    XidStatus status = TransactionIdGetStatus(xid);

    // 2. è®¾ç½®å¯¹åº”çš„Hint Bit
    if (status == TRANSACTION_STATUS_COMMITTED) {
        tuple->t_infomask |= infomask;  // è®¾ç½®COMMITTEDä½
    } else if (status == TRANSACTION_STATUS_ABORTED) {
        tuple->t_infomask |= (infomask << 1);  // è®¾ç½®INVALIDä½
    }

    // 3. æ ‡è®°é¡µé¢ä¸ºè„ï¼ˆå»¶è¿Ÿåˆ·ç›˜ï¼‰
    MarkBufferDirty(buffer);
}
```

**Hint Bitsä½¿ç”¨æœºåˆ¶**:

```python
def check_visibility_with_hint_bits(tuple, snapshot, current_txid):
    """
    Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­

    æœºåˆ¶:
    1. æ£€æŸ¥Hint Bits
    2. å¦‚æœå·²è®¾ç½®ï¼Œç›´æ¥ä½¿ç”¨
    3. å¦‚æœæœªè®¾ç½®ï¼ŒæŸ¥è¯¢pg_clogå¹¶è®¾ç½®
    """
    # 1. æ£€æŸ¥xmin Hint Bits
    if tuple.t_infomask & HEAP_XMIN_COMMITTED:
        # xminå·²æäº¤ï¼Œç»§ç»­åˆ¤æ–­
        xmin_committed = True
    elif tuple.t_infomask & HEAP_XMIN_INVALID:
        # xminå·²å›æ»šï¼Œä¸å¯è§
        return False
    else:
        # Hint Bitsæœªè®¾ç½®ï¼ŒæŸ¥è¯¢pg_clog
        xmin_status = query_clog(tuple.xmin)
        if xmin_status == COMMITTED:
            set_hint_bit(tuple, HEAP_XMIN_COMMITTED)
            xmin_committed = True
        else:
            set_hint_bit(tuple, HEAP_XMIN_INVALID)
            return False

    # 2. æ£€æŸ¥xmax Hint Bitsï¼ˆç±»ä¼¼ï¼‰
    # ...

    # 3. ä½¿ç”¨Hint Bitsåˆ¤æ–­å¯è§æ€§
    return is_visible_with_hint_bits(tuple, snapshot, current_txid)
```

**æ€§èƒ½å½±å“**:

1. **Hint Bitsæ£€æŸ¥å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - ä½æ£€æŸ¥
   - ç©ºé—´å¤æ‚åº¦: $O(1)$ - ä»…å­˜å‚¨æ ‡å¿—ä½
   - å…¸å‹å¼€é”€: < 0.1Î¼s per check

2. **pg_clogæŸ¥è¯¢å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - ç›´æ¥è®¿é—®
   - å…¸å‹å¼€é”€: 1-10Î¼sï¼ˆå¦‚æœpg_clogåœ¨å†…å­˜ï¼‰æˆ– 10-100Î¼sï¼ˆå¦‚æœpg_clogåœ¨ç£ç›˜ï¼‰
   - æ€§èƒ½å½±å“: pg_clogæŸ¥è¯¢æ˜¯å¯è§æ€§åˆ¤æ–­çš„ä¸»è¦å¼€é”€

3. **æ€»ä½“æ€§èƒ½**:
   - æ— Hint Bits: æ¯æ¬¡æŸ¥è¯¢pg_clogï¼Œå»¶è¿Ÿ1-100Î¼s
   - æœ‰Hint Bits: é¦–æ¬¡æŸ¥è¯¢pg_clogï¼Œåç»­ä½¿ç”¨Hint Bitsï¼Œå»¶è¿Ÿ< 0.1Î¼s
   - æ€»ä½“å½±å“: Hint Bitså°†å¯è§æ€§åˆ¤æ–­å»¶è¿Ÿé™ä½10-1000Ã—

---

#### 6.0.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**å¯è§æ€§åˆ¤æ–­æ—¶é—´å¼€é”€ï¼ˆæ— Hint Bitsï¼‰**:

$$T_{visibility} = T_{clog\_query} = T_{memory\_access} + T_{disk\_io} \cdot \mathbb{1}_{clog\_on\_disk}$$

å…¶ä¸­ï¼š

- $T_{memory\_access} = O(1)$ - å†…å­˜è®¿é—®æ—¶é—´
- $T_{disk\_io} = 10-100Î¼s$ - ç£ç›˜I/Oæ—¶é—´ï¼ˆå¦‚æœpg_clogåœ¨ç£ç›˜ï¼‰
- $\mathbb{1}_{clog\_on\_disk}$ - æŒ‡ç¤ºå‡½æ•°ï¼Œpg_clogåœ¨ç£ç›˜æ—¶ä¸º1

**å¯è§æ€§åˆ¤æ–­æ—¶é—´å¼€é”€ï¼ˆæœ‰Hint Bitsï¼‰**:

$$T_{visibility} = T_{hint\_bit\_check} + T_{clog\_query} \cdot (1 - \mathbb{1}_{hint\_bit\_set})$$

å…¶ä¸­ï¼š

- $T_{hint\_bit\_check} = O(1)$ - Hint Bitsæ£€æŸ¥æ—¶é—´ï¼ˆ< 0.1Î¼sï¼‰
- $T_{clog\_query}$ - pg_clogæŸ¥è¯¢æ—¶é—´ï¼ˆä»…åœ¨Hint Bitsæœªè®¾ç½®æ—¶ï¼‰
- $\mathbb{1}_{hint\_bit\_set}$ - æŒ‡ç¤ºå‡½æ•°ï¼ŒHint Bitså·²è®¾ç½®æ—¶ä¸º1

**æ€§èƒ½æå‡**:

$$\text{Speedup} = \frac{T_{visibility\_without\_hint\_bits}}{T_{visibility\_with\_hint\_bits}} = \frac{T_{clog\_query}}{T_{hint\_bit\_check}} = 10-1000Ã—$$

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | æ— Hint Bitså»¶è¿Ÿ | æœ‰Hint Bitså»¶è¿Ÿ | æ€§èƒ½æå‡ | è¯´æ˜ |
|-----|--------------|---------------|---------|------|
| **é¦–æ¬¡è®¿é—®** | 1-100Î¼s | 1-100Î¼s | 1Ã— | éœ€è¦æŸ¥è¯¢pg_clog |
| **åç»­è®¿é—®** | 1-100Î¼s | < 0.1Î¼s | 10-1000Ã— | ä½¿ç”¨Hint Bits |
| **é«˜å¹¶å‘è¯»** | 100Î¼s | 0.1Î¼s | 1000Ã— | Hint Bitsæ˜¾è‘—æå‡æ€§èƒ½ |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–Hint Bitsè®¾ç½®**:
   - å»¶è¿Ÿè®¾ç½®Hint Bitsï¼ˆä»…åœ¨å¿…è¦æ—¶è®¾ç½®ï¼‰
   - æ‰¹é‡è®¾ç½®Hint Bitsï¼ˆå‡å°‘é¡µé¢åˆ·ç›˜ï¼‰
   - åªè¯»é¡µé¢ä¸ç«‹å³åˆ·ç›˜ï¼ˆå»¶è¿Ÿåˆ·ç›˜ï¼‰

2. **ä¼˜åŒ–pg_clogè®¿é—®**:
   - å°†pg_clogä¿æŒåœ¨å†…å­˜ä¸­ï¼ˆshared_buffersï¼‰
   - ä¼˜åŒ–pg_clogæŸ¥è¯¢è·¯å¾„
   - ä½¿ç”¨ç¼“å­˜å‡å°‘pg_clogæŸ¥è¯¢

3. **ç›‘æ§Hint Bitsæ€§èƒ½**:
   - ç›‘æ§Hint Bitså‘½ä¸­ç‡
   - ç›‘æ§pg_clogæŸ¥è¯¢é¢‘ç‡
   - ä¼˜åŒ–Hint Bitsè®¾ç½®ç­–ç•¥

---

#### 6.0.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: Hint Bitsæ˜¯ç¼“å­˜äº‹åŠ¡æäº¤çŠ¶æ€çš„æ ‡å¿—ä½
2. **ä½œç”¨**: Hint Bitsä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½ï¼Œé¿å…é‡å¤æŸ¥è¯¢pg_clog
3. **å®ç°**: PostgreSQLåœ¨å…ƒç»„å¤´éƒ¨å­˜å‚¨Hint Bitsï¼Œåœ¨æŸ¥è¯¢pg_clogåè®¾ç½®
4. **æ€§èƒ½**: Hint Bitså°†å¯è§æ€§åˆ¤æ–­å»¶è¿Ÿé™ä½10-1000Ã—

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºHint Bitsæ€»æ˜¯æå‡æ€§èƒ½
   - **é”™è¯¯**: Hint Bitsè®¾ç½®å¯¼è‡´é¡µé¢è„é¡µï¼Œå¯èƒ½å¢åŠ å†™I/O
   - **æ­£ç¡®**: Hint Bitsåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æå‡æ€§èƒ½ï¼Œä½†éœ€è¦å¹³è¡¡è®¾ç½®ç­–ç•¥

2. **è¯¯åŒº2**: è®¤ä¸ºHint Bitså¯ä»¥å®Œå…¨æ›¿ä»£pg_clog
   - **é”™è¯¯**: Hint Bitsæ˜¯ç¼“å­˜ï¼Œé¦–æ¬¡è®¿é—®ä»éœ€æŸ¥è¯¢pg_clog
   - **æ­£ç¡®**: Hint Bitsä¼˜åŒ–åç»­è®¿é—®ï¼Œä½†é¦–æ¬¡è®¿é—®ä»éœ€æŸ¥è¯¢pg_clog

3. **è¯¯åŒº3**: å¿½ç•¥Hint Bitså¯¼è‡´çš„é¡µé¢è„é¡µ
   - **é”™è¯¯**: è®¤ä¸ºHint Bitsè®¾ç½®æ²¡æœ‰å‰¯ä½œç”¨
   - **æ­£ç¡®**: Hint Bitsè®¾ç½®å¯¼è‡´é¡µé¢è„é¡µï¼Œéœ€è¦ä¼˜åŒ–è®¾ç½®ç­–ç•¥

**æœ€ä½³å®è·µ**:

1. **ç†è§£Hint Bitsæœºåˆ¶**: ç†è§£Hint Bitså¦‚ä½•ä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½
2. **ç›‘æ§Hint Bitsæ€§èƒ½**: ç›‘æ§Hint Bitså‘½ä¸­ç‡å’Œpg_clogæŸ¥è¯¢é¢‘ç‡
3. **ä¼˜åŒ–Hint Bitsè®¾ç½®**: ä¼˜åŒ–Hint Bitsè®¾ç½®ç­–ç•¥ï¼Œå‡å°‘é¡µé¢è„é¡µ
4. **å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§**: å¹³è¡¡Hint Bitsæ€§èƒ½å’Œé¡µé¢è„é¡µå¼€é”€

---

### 6.1 HOT (Heap-Only Tuple)

**æ¡ä»¶**:

1. UPDATEä¸æ¶‰åŠç´¢å¼•åˆ—
2. æ–°ç‰ˆæœ¬åœ¨åŒä¸€é¡µå†…
3. é¡µé¢æœ‰è¶³å¤Ÿç©ºé—²ç©ºé—´

**æ•ˆæœ**:

$$\text{Index writes} = 0 \quad (\text{vs traditional: } O(n) \text{ for } n \text{ indexes})$$

**å®ç°**:

```c
// PostgreSQLæºç ç®€åŒ–
if (HeapTupleIsHotUpdated(oldtup) &&
    !IndexedColumnsChanged(oldtup, newtup) &&
    PageGetFreeSpace(page) >= newtup_size) {

    // åœ¨åŒé¡µå†…æ’å…¥æ–°ç‰ˆæœ¬
    newoffset = PageAddItem(page, newtup);

    // å»ºç«‹HOTé“¾
    oldtup->t_ctid = (page_num, newoffset);

    // ä¸æ’å…¥æ–°ç´¢å¼•é¡¹
}
```

**ç‰ˆæœ¬é“¾**:

```text
Index â†’ [Page Header]
          â†“
       [ItemId 1] â†’ Tuple_v1 (xmin=100, xmax=110)
          â†“           â†“ (ctidæŒ‡å‘)
       [ItemId 2] â†’ Tuple_v2 (xmin=110, xmax=0)  â† HOTé“¾
```

### 6.1.5 Visibility Map å®Œæ•´å®šä¹‰ä¸åˆ†æ

#### 6.1.5.0 æƒå¨å®šä¹‰ä¸æ¥æº

**PostgreSQLå®˜æ–¹æ–‡æ¡£å®šä¹‰**:

> The Visibility Map (VM) is a data structure associated with each heap relation (table) that tracks the visibility status of tuples within the table's pages. It stores two bits per heap page: the all-visible bit and the all-frozen bit. The all-visible bit indicates that all tuples on the page are visible to all active transactions, meaning the page contains no tuples that need vacuuming. This information is crucial for optimizing index-only scans.

**PostgreSQL Wikiå®šä¹‰**:

> The Visibility Map is a bitmap structure that tracks which pages in a heap relation are "all-visible" (all tuples on the page are visible to all transactions) and "all-frozen" (all tuples are frozen). This allows Index-Only Scans to skip heap access when all tuples on a page are visible, significantly improving query performance.

**PostgreSQLå®ç°å®šä¹‰**:

PostgreSQLçš„Visibility Mapå®ç°åŒ…æ‹¬ä¸¤ä¸ªä½æ ‡å¿—ï¼š

```c
// src/include/storage/bufpage.h

// Visibility Mapä½å®šä¹‰
#define VISIBILITYMAP_ALL_VISIBLE    0x01  // é¡µé¢æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
#define VISIBILITYMAP_ALL_FROZEN     0x02  // é¡µé¢æ‰€æœ‰å…ƒç»„å·²å†»ç»“

// Visibility Mapç»“æ„
typedef struct
{
    BlockNumber vm_block;      // å¯¹åº”çš„å †é¡µé¢å·
    uint8 vm_bits;              // ä½æ ‡å¿—ï¼ˆall-visible, all-frozenï¼‰
} VisibilityMapEntry;
```

**æœ¬ä½“ç³»å®šä¹‰**:

Visibility Mapæ˜¯PostgreSQL MVCCä¸­ä¼˜åŒ–Index-Only Scançš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ã€‚Visibility Mapæ˜¯å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶ä¸­çš„ä½å›¾ç»“æ„ï¼Œæ¯ä¸ªå †é¡µé¢å¯¹åº”ä¸¤ä¸ªä½ï¼šall-visibleä½å’Œall-frozenä½ã€‚all-visibleä½è¡¨ç¤ºé¡µé¢ä¸Šçš„æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰æ´»è·ƒäº‹åŠ¡å¯è§ï¼Œè¿™æ„å‘³ç€Index-Only Scanå¯ä»¥è·³è¿‡å †è®¿é—®ï¼Œç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®ï¼Œä»è€Œæ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

**Visibility Mapä¸MVCCçš„å…³ç³»**:

```text
MVCC Index-Only Scanä¼˜åŒ–æœºåˆ¶:
â”‚
â”œâ”€ Index-Only Scan â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ é—®é¢˜: éœ€è¦æ£€æŸ¥å¯è§æ€§ï¼Œå¿…é¡»è®¿é—®å †è¡¨
â”‚       â””â”€ è§£å†³: Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢
â”‚
â””â”€ Visibility Mapæœºåˆ¶
    â””â”€ å®šä¹‰: æ ‡è®°å…¨å¯è§é¡µé¢çš„ä½å›¾
        â”œâ”€ all-visibleä½: é¡µé¢æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
        â””â”€ all-frozenä½: é¡µé¢æ‰€æœ‰å…ƒç»„å·²å†»ç»“
```

---

#### 6.1.5.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰6.1.5.1 (Visibility Map)**:

Visibility Mapæ˜¯å †å…³ç³»$R$çš„ä½å›¾ç»“æ„ï¼Œæ¯ä¸ªé¡µé¢$p$å¯¹åº”ä¸¤ä¸ªä½ï¼š

$$
\text{VisibilityMap}(R) = \{(\text{PageNum}(p), \text{AllVisible}(p), \text{AllFrozen}(p)) : p \in \text{Pages}(R)\}
$$

å…¶ä¸­ï¼š

- $\text{AllVisible}(p) \in \{0, 1\}$: é¡µé¢$p$æ˜¯å¦å…¨å¯è§
- $\text{AllFrozen}(p) \in \{0, 1\}$: é¡µé¢$p$æ˜¯å¦å…¨å†»ç»“

**å®šä¹‰6.1.5.2 (All-Visibleæ¡ä»¶)**:

é¡µé¢$p$æ˜¯å…¨å¯è§çš„å½“ä¸”ä»…å½“ï¼š

$$
\text{AllVisible}(p) = 1 \iff \forall \tau \in p, \forall \text{snapshot } s: \text{Visible}(\tau, s)
$$

å³ï¼šé¡µé¢ä¸Šçš„æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰å¿«ç…§éƒ½å¯è§ã€‚

**å®šä¹‰6.1.5.3 (Index-Only Scanä¼˜åŒ–)**:

å¦‚æœé¡µé¢$p$æ˜¯å…¨å¯è§çš„ï¼ŒIndex-Only Scanå¯ä»¥è·³è¿‡å †è®¿é—®ï¼š

$$
\text{IndexOnlyScan}(I, q) = \begin{cases}
\text{IndexData}(I, q) & \text{if } \text{AllVisible}(\text{Page}(I, q)) = 1 \\
\text{IndexData}(I, q) \cup \text{HeapCheck}(I, q) & \text{otherwise}
\end{cases}
$$

å³ï¼šå¦‚æœé¡µé¢å…¨å¯è§ï¼Œç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®ï¼›å¦åˆ™éœ€è¦è®¿é—®å †è¡¨æ£€æŸ¥å¯è§æ€§ã€‚

**å®šä¹‰6.1.5.4 (Visibility Mapæ€§èƒ½ä¼˜åŒ–)**:

Visibility Mapå°†Index-Only Scançš„æ—¶é—´å¤æ‚åº¦ä»ï¼š

$$T_{index\_only\_scan} = T_{index\_scan} + T_{heap\_access} \cdot N_{pages}$$

ä¼˜åŒ–ä¸ºï¼š

$$T_{index\_only\_scan} = T_{index\_scan} + T_{heap\_access} \cdot N_{non\_visible\_pages}$$

å…¶ä¸­ $N_{non\_visible\_pages} \ll N_{pages}$ã€‚

å³ï¼šVisibility Mapå…è®¸Index-Only Scanè·³è¿‡å…¨å¯è§é¡µé¢ï¼Œåªè®¿é—®éœ€è¦æ£€æŸ¥å¯è§æ€§çš„é¡µé¢ã€‚

---

#### 6.1.5.2 ç†è®ºæ€è„‰

**å†å²æ¼”è¿›**:

1. **2000å¹´ä»£**: Index-Only Scanæå‡º
   - æŸ¥è¯¢åˆ—å®Œå…¨åœ¨ç´¢å¼•ä¸­æ—¶ï¼Œç†è®ºä¸Šå¯ä»¥åªè®¿é—®ç´¢å¼•
   - ä½†MVCCéœ€è¦æ£€æŸ¥å¯è§æ€§ï¼Œå¿…é¡»è®¿é—®å †è¡¨
   - Index-Only Scanæ€§èƒ½ä¼˜åŠ¿ä¸æ˜æ˜¾

2. **2008å¹´**: Visibility Mapå¼•å…¥ï¼ˆPostgreSQL 8.4ï¼‰
   - PostgreSQLå¼•å…¥Visibility Mapæœºåˆ¶
   - æ ‡è®°å…¨å¯è§é¡µé¢ï¼Œå…è®¸è·³è¿‡å †è®¿é—®
   - Index-Only Scanæ€§èƒ½æ˜¾è‘—æå‡

3. **2010å¹´ä»£**: Visibility Mapä¼˜åŒ–å®Œå–„
   - ä¼˜åŒ–Visibility Mapç»´æŠ¤ç­–ç•¥
   - å‡å°‘Visibility Mapæ›´æ–°å¼€é”€
   - æå‡Index-Only Scanæ€§èƒ½

4. **2020å¹´ä»£è‡³ä»Š**: Visibility Mapæœºåˆ¶æˆç†Ÿ
   - å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ä½¿ç”¨ç±»ä¼¼æœºåˆ¶
   - PostgreSQLç­‰æ•°æ®åº“ä¼˜åŒ–Visibility Mapæ€§èƒ½
   - Visibility Mapæˆä¸ºIndex-Only Scançš„æ ‡å‡†ä¼˜åŒ–

**ç†è®ºåŠ¨æœº**:

**ä¸ºä»€ä¹ˆéœ€è¦Visibility Mapï¼Ÿ**

1. **Index-Only Scanä¼˜åŒ–çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: Index-Only Scanéœ€è¦æ£€æŸ¥å¯è§æ€§ï¼Œå¿…é¡»è®¿é—®å †è¡¨
   - **è§£å†³**: Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢ï¼Œå…è®¸è·³è¿‡å †è®¿é—®
   - **æ•ˆæœ**: æ˜¾è‘—æå‡Index-Only Scanæ€§èƒ½

2. **å‡å°‘I/Oå¼€é”€çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: å †è®¿é—®éœ€è¦ç£ç›˜I/Oï¼Œå»¶è¿Ÿé«˜
   - **è§£å†³**: Visibility Mapå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢ï¼Œå‡å°‘å †è®¿é—®
   - **æ•ˆæœ**: å‡å°‘I/Oå¼€é”€ï¼Œé™ä½å»¶è¿Ÿ

3. **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–çš„å¿…è¦æ€§**:
   - **é—®é¢˜**: è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½å—å †è®¿é—®é™åˆ¶
   - **è§£å†³**: Visibility Mapä¼˜åŒ–Index-Only Scanï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
   - **æ•ˆæœ**: è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½æå‡2-10Ã—

**ç†è®ºä½ç½®**:

```text
MVCC Index-Only Scanä¼˜åŒ–æœºåˆ¶å±‚æ¬¡ç»“æ„:
â”‚
â”œâ”€ Index-Only Scan
â”‚   â””â”€ é—®é¢˜: éœ€è¦æ£€æŸ¥å¯è§æ€§ï¼Œå¿…é¡»è®¿é—®å †è¡¨
â”‚       â””â”€ è§£å†³: Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢
â”‚
â”œâ”€ Visibility Mapæœºåˆ¶ â† æœ¬æ¦‚å¿µä½ç½®
â”‚   â””â”€ å®ç°: æ ‡è®°å…¨å¯è§é¡µé¢çš„ä½å›¾
â”‚       â”œâ”€ all-visibleä½: é¡µé¢æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
â”‚       â””â”€ all-frozenä½: é¡µé¢æ‰€æœ‰å…ƒç»„å·²å†»ç»“
â”‚
â””â”€ å­˜å‚¨å±‚
    â””â”€ å †è¡¨ã€ç´¢å¼•ã€Visibility Mapæ–‡ä»¶
```

**Visibility Mapä¸MVCCçš„å…³ç³»**:

```text
Visibility Mapä¸MVCC:
â”‚
â”œâ”€ MVCCæ˜¯å¹¶å‘æ§åˆ¶æœºåˆ¶
â”‚   â””â”€ éœ€è¦å¯è§æ€§åˆ¤æ–­
â”‚
â””â”€ Visibility Mapæ˜¯æ€§èƒ½ä¼˜åŒ–æœºåˆ¶
    â””â”€ ä¼˜åŒ–Index-Only Scanæ€§èƒ½
```

**ç†è®ºæ¨å¯¼**:

```text
ä»Index-Only Scanæ€§èƒ½é—®é¢˜åˆ°Visibility Mapä¼˜åŒ–çš„æ¨ç†é“¾æ¡:

1. ä¸šåŠ¡éœ€æ±‚åˆ†æ
   â”œâ”€ éœ€æ±‚: è¦†ç›–ç´¢å¼•æŸ¥è¯¢é«˜æ€§èƒ½ï¼ˆé‡è¦ï¼‰
   â”œâ”€ éœ€æ±‚: å‡å°‘å †è®¿é—®å¼€é”€ï¼ˆé‡è¦ï¼‰
   â””â”€ éœ€æ±‚: ä¼˜åŒ–Index-Only Scanæ€§èƒ½ï¼ˆé‡è¦ï¼‰

2. Visibility Mapè§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ: æ ‡è®°å…¨å¯è§é¡µé¢
   â”œâ”€ æœºåˆ¶: ä½å›¾ç»“æ„å­˜å‚¨å¯è§æ€§ä¿¡æ¯
   â””â”€ ä¼˜åŒ–: å…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®

3. å®ç°é€‰æ‹©
   â”œâ”€ Visibility Mapç»´æŠ¤: VACUUMè®¾ç½®all-visibleä½
   â”œâ”€ Visibility Mapä½¿ç”¨: Index-Only Scanæ£€æŸ¥all-visibleä½
   â””â”€ ä¸€è‡´æ€§ä¿è¯: å†™æ“ä½œæ¸…é™¤all-visibleä½

4. ç»“è®º
   â””â”€ Visibility Mapæ˜¯ä¼˜åŒ–Index-Only Scanæ€§èƒ½çš„æ ‡å‡†æ–¹æ³•
```

---

#### 6.1.5.3 å®Œæ•´è®ºè¯

**æ­£ä¾‹åˆ†æ**:

**æ­£ä¾‹1: Visibility Mapä¼˜åŒ–Index-Only Scanæ€§èƒ½**

```sql
-- åœºæ™¯: è¦†ç›–ç´¢å¼•æŸ¥è¯¢
-- éœ€æ±‚: å¿…é¡»ä¼˜åŒ–Index-Only Scanæ€§èƒ½

-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_articles_title_author ON articles(title, author, content);

-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title, author, content FROM articles WHERE title LIKE 'PostgreSQL%';
-- æ— Visibility Map: éœ€è¦è®¿é—®å †è¡¨æ£€æŸ¥å¯è§æ€§
-- å¼€é”€: ç´¢å¼•æ‰«æ + å †è®¿é—®ï¼Œå»¶è¿Ÿé«˜ âœ—

-- è®¾ç½®Visibility Mapå
-- VACUUMè®¾ç½®all-visibleä½
VACUUM articles;
-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title, author, content FROM articles WHERE title LIKE 'PostgreSQL%';
-- æœ‰Visibility Map: è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®
-- å¼€é”€: ä»…ç´¢å¼•æ‰«æï¼Œå»¶è¿Ÿä½ âœ“
-- æ€§èƒ½æå‡: 2-10Ã— âœ“
```

**åˆ†æ**:

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šVisibility Mapå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®ï¼Œæ˜¾è‘—æå‡æ€§èƒ½
- âœ… å»¶è¿Ÿé™ä½ï¼šä»ç´¢å¼•æ‰«æ+å †è®¿é—®é™ä½åˆ°ä»…ç´¢å¼•æ‰«æï¼Œå»¶è¿Ÿé™ä½2-10Ã—
- âœ… ååé‡æå‡ï¼šIndex-Only Scanååé‡æå‡2-10Ã—

---

**æ­£ä¾‹2: Visibility Mapå‡å°‘å †è®¿é—®**

```sql
-- åœºæ™¯: å¤§é‡è¦†ç›–ç´¢å¼•æŸ¥è¯¢
-- éœ€æ±‚: å‡å°‘å †è®¿é—®å¼€é”€

-- åˆå§‹çŠ¶æ€ï¼ˆæ— Visibility Mapï¼‰
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æ + å †è®¿é—®æ£€æŸ¥å¯è§æ€§
-- å †è®¿é—®: 1000é¡µ âœ—

-- è®¾ç½®Visibility Mapå
VACUUM articles;
-- æŸ¥è¯¢
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æï¼Œæ£€æŸ¥Visibility Map
-- å †è®¿é—®: 0é¡µï¼ˆå¦‚æœæ‰€æœ‰é¡µé¢å…¨å¯è§ï¼‰âœ“
-- æ€§èƒ½æå‡: é¿å…1000æ¬¡å †è®¿é—® âœ“
```

**åˆ†æ**:

- âœ… å‡å°‘è®¿é—®ï¼šVisibility Mapå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®
- âœ… æ€§èƒ½æå‡ï¼šé¿å…å †è®¿é—®ï¼Œæ€§èƒ½æå‡æ˜¾è‘—
- âœ… ç³»ç»Ÿè´Ÿè½½ï¼šå‡å°‘å †è®¿é—®ï¼Œé™ä½ç³»ç»Ÿè´Ÿè½½

---

**åä¾‹åˆ†æ**:

**åä¾‹1: Visibility Mapæœªç»´æŠ¤å¯¼è‡´æ€§èƒ½é—®é¢˜**

```sql
-- é”™è¯¯åœºæ™¯: Visibility Mapæœªç»´æŠ¤
-- é—®é¢˜: all-visibleä½æœªè®¾ç½®ï¼Œæ— æ³•ä¼˜åŒ–Index-Only Scan

-- åœºæ™¯: å¤§é‡æ›´æ–°åæœªVACUUM
UPDATE articles SET view_count = view_count + 1 WHERE id < 10000;
-- é—®é¢˜: all-visibleä½è¢«æ¸…é™¤ï¼Œä½†æœªé‡æ–°è®¾ç½® âœ—

-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æ + å †è®¿é—®æ£€æŸ¥å¯è§æ€§
-- é—®é¢˜: æ— æ³•ä½¿ç”¨Visibility Mapä¼˜åŒ– âœ—
-- ç»“æœ: æ€§èƒ½å·® âœ—
```

**é”™è¯¯åŸå› **:

- Visibility Mapæœªç»´æŠ¤ï¼Œall-visibleä½æœªè®¾ç½®
- Index-Only Scanæ— æ³•è·³è¿‡å †è®¿é—®
- æŸ¥è¯¢æ€§èƒ½å·®

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: å®šæœŸVACUUMç»´æŠ¤Visibility Map
UPDATE articles SET view_count = view_count + 1 WHERE id < 10000;

-- VACUUMç»´æŠ¤Visibility Map
VACUUM articles;
-- å†…éƒ¨: æ£€æŸ¥é¡µé¢å¯è§æ€§ï¼Œè®¾ç½®all-visibleä½ âœ“

-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æï¼Œæ£€æŸ¥Visibility Map
-- ä¼˜åŒ–: è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—® âœ“
-- ç»“æœ: æ€§èƒ½é«˜ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: Visibility Mapæœªç»´æŠ¤ï¼ŒIndex-Only Scanæ€§èƒ½ä¸‹é™2-10Ã—
- **å»¶è¿Ÿå¢åŠ **: éœ€è¦å †è®¿é—®ï¼Œå»¶è¿Ÿå¢åŠ 2-10Ã—
- **ç³»ç»Ÿè´Ÿè½½**: å †è®¿é—®å¢åŠ ç³»ç»Ÿè´Ÿè½½

---

**åä¾‹2: Visibility Mapä¸ä¸€è‡´å¯¼è‡´é”™è¯¯ç»“æœ**

```sql
-- é”™è¯¯åœºæ™¯: Visibility Mapä¸å®é™…æƒ…å†µä¸ä¸€è‡´
-- é—®é¢˜: all-visibleä½è®¾ç½®é”™è¯¯ï¼Œå¯èƒ½è¿”å›ä¸å¯è§æ•°æ®

-- åœºæ™¯: Visibility Mapè®¾ç½®é”™è¯¯
-- 1. é¡µé¢åŒ…å«ä¸å¯è§å…ƒç»„
-- 2. ä½†all-visibleä½è¢«é”™è¯¯è®¾ç½®ä¸º1 âœ—
-- 3. Index-Only Scanè·³è¿‡å †è®¿é—® âœ—
-- ç»“æœ: å¯èƒ½è¿”å›ä¸å¯è§æ•°æ® âœ—
```

**é”™è¯¯åŸå› **:

- Visibility Mapä¸å®é™…æƒ…å†µä¸ä¸€è‡´
- all-visibleä½è®¾ç½®é”™è¯¯
- å¯èƒ½å¯¼è‡´è¿”å›ä¸å¯è§æ•°æ®

**æ­£ç¡®åšæ³•**:

```sql
-- PostgreSQLä¿è¯æœºåˆ¶
-- 1. å†™æ“ä½œæ¸…é™¤all-visibleä½
-- 2. VACUUMæ£€æŸ¥é¡µé¢å¯è§æ€§åè®¾ç½®all-visibleä½
-- 3. å¦‚æœall-visibleä½æœªè®¾ç½®ï¼Œè®¿é—®å †è¡¨æ£€æŸ¥å¯è§æ€§

-- ç³»ç»Ÿè¡Œä¸º
UPDATE articles SET view_count = view_count + 1 WHERE id = 1;
-- å†…éƒ¨: æ¸…é™¤é¡µé¢çš„all-visibleä½ âœ“

-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: æ£€æŸ¥Visibility Map
-- å¦‚æœall-visibleä½æœªè®¾ç½®: è®¿é—®å †è¡¨æ£€æŸ¥å¯è§æ€§ âœ“
-- å¦‚æœall-visibleä½å·²è®¾ç½®: è·³è¿‡å †è®¿é—® âœ“
-- ç»“æœ: ä¿è¯æ­£ç¡®æ€§ï¼Œä¼˜åŒ–æ€§èƒ½ âœ“
```

**åæœåˆ†æ**:

- **æ•°æ®é”™è¯¯**: Visibility Mapä¸ä¸€è‡´å¯¼è‡´è¿”å›ä¸å¯è§æ•°æ®
- **æ•°æ®ä¸ä¸€è‡´**: å¯èƒ½è¯»å–åˆ°ä¸åº”è¯¥çœ‹åˆ°çš„æ•°æ®
- **ç³»ç»Ÿé”™è¯¯**: è¿åMVCCå¯è§æ€§ä¿è¯

---

**åä¾‹3: å¿½ç•¥Visibility Mapå¯¼è‡´æ€§èƒ½é—®é¢˜**

```sql
-- é”™è¯¯åœºæ™¯: å¿½ç•¥Visibility Mapä¼˜åŒ–
-- é—®é¢˜: è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½å·®

-- é”™è¯¯é…ç½®ï¼ˆç†è®ºåœºæ™¯ï¼‰
-- å‡è®¾: ç¦ç”¨Visibility Mapæœºåˆ¶

-- ç³»ç»Ÿè¡Œä¸º
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æ + å †è®¿é—®æ£€æŸ¥å¯è§æ€§ âœ—
-- å¼€é”€: å †è®¿é—®ï¼Œå»¶è¿Ÿé«˜ âœ—
-- ç»“æœ: è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½å·® âœ—
```

**é”™è¯¯åŸå› **:

- å¿½ç•¥Visibility Mapä¼˜åŒ–ï¼Œæ¯æ¬¡éƒ½éœ€è¦å †è®¿é—®
- å †è®¿é—®å¼€é”€å¤§ï¼Œå»¶è¿Ÿé«˜
- è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½å·®

**æ­£ç¡®åšæ³•**:

```sql
-- æ­£ç¡®: ä½¿ç”¨Visibility Mapä¼˜åŒ–
-- PostgreSQLé»˜è®¤å¯ç”¨Visibility Map

-- ç³»ç»Ÿè¡Œä¸º
VACUUM articles;  -- ç»´æŠ¤Visibility Map
SELECT title FROM articles WHERE author = 'Alice';
-- å†…éƒ¨: ç´¢å¼•æ‰«æï¼Œæ£€æŸ¥Visibility Map
-- å¦‚æœall-visibleä½å·²è®¾ç½®: è·³è¿‡å †è®¿é—® âœ“
-- å¼€é”€: ä»…ç´¢å¼•æ‰«æï¼Œå»¶è¿Ÿä½ âœ“
-- ç»“æœ: è¦†ç›–ç´¢å¼•æŸ¥è¯¢æ€§èƒ½é«˜ âœ“
```

**åæœåˆ†æ**:

- **æ€§èƒ½ä¸‹é™**: å¿½ç•¥Visibility Mapï¼ŒIndex-Only Scanæ€§èƒ½ä¸‹é™2-10Ã—
- **å»¶è¿Ÿå¢åŠ **: å †è®¿é—®å»¶è¿Ÿé«˜ï¼Œå»¶è¿Ÿå¢åŠ 2-10Ã—
- **ç³»ç»Ÿè´Ÿè½½**: å †è®¿é—®å¢åŠ ç³»ç»Ÿè´Ÿè½½

---

**åœºæ™¯åˆ†æ**:

**åœºæ™¯1: è¦†ç›–ç´¢å¼•æŸ¥è¯¢ä½¿ç”¨Visibility Map**

**åœºæ™¯æè¿°**:

- æ–°é—»ç½‘ç«™ï¼Œè¦†ç›–ç´¢å¼•æŸ¥è¯¢100,000 QPS
  - éœ€è¦ä¼˜åŒ–Index-Only Scanæ€§èƒ½
  - Visibility Mapæ˜¾è‘—æå‡æ€§èƒ½

**ä¸ºä»€ä¹ˆéœ€è¦Visibility Map**:

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®ï¼Œæ˜¾è‘—æå‡æ€§èƒ½
- âœ… å»¶è¿Ÿé™ä½ï¼šä»ç´¢å¼•æ‰«æ+å †è®¿é—®é™ä½åˆ°ä»…ç´¢å¼•æ‰«æ
- âœ… ååé‡æå‡ï¼šIndex-Only Scanååé‡æå‡2-10Ã—

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_articles_cover ON articles(title, author, content);

-- ç»´æŠ¤Visibility Map
VACUUM articles;

-- æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
SELECT title, author, content FROM articles WHERE title LIKE 'PostgreSQL%';
-- å†…éƒ¨: ç´¢å¼•æ‰«æï¼Œæ£€æŸ¥Visibility Map
-- å¦‚æœall-visibleä½å·²è®¾ç½®: è·³è¿‡å †è®¿é—® âœ“
-- ç»“æœ: æ€§èƒ½ä¼˜åŒ– âœ“
```

**æ•ˆæœåˆ†æ**:

- **æ€§èƒ½**: Index-Only Scanæ€§èƒ½æå‡2-10Ã— âœ“
- **å»¶è¿Ÿ**: å»¶è¿Ÿé™ä½2-10Ã— âœ“
- **ååé‡**: ååé‡æå‡2-10Ã— âœ“

---

**åœºæ™¯2: é«˜æ›´æ–°é¢‘ç‡è¡¨ä¼˜åŒ–Visibility Mapç»´æŠ¤**

**åœºæ™¯æè¿°**:

- è®¢å•è¡¨ï¼Œæ›´æ–°é¢‘ç‡é«˜
  - éœ€è¦ä¼˜åŒ–Visibility Mapç»´æŠ¤ç­–ç•¥
  - å‡å°‘Visibility Mapæ›´æ–°å¼€é”€

**ä¸ºä»€ä¹ˆéœ€è¦Visibility Mapä¼˜åŒ–**:

- âœ… å‡å°‘æ›´æ–°ï¼šä¼˜åŒ–Visibility Mapç»´æŠ¤ç­–ç•¥ï¼Œå‡å°‘æ›´æ–°å¼€é”€
- âœ… é™ä½I/Oï¼šå‡å°‘Visibility Mapæ–‡ä»¶I/O
- âœ… æ€§èƒ½å¹³è¡¡ï¼šå¹³è¡¡Visibility Mapç»´æŠ¤å¼€é”€å’ŒæŸ¥è¯¢æ€§èƒ½

**å¦‚ä½•ä½¿ç”¨**:

```sql
-- ä¼˜åŒ–VACUUMé…ç½®
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1
);

-- ç³»ç»Ÿè¡Œä¸º
-- 1. æ›´æ–°æ“ä½œæ¸…é™¤all-visibleä½
UPDATE orders SET status = 'shipped' WHERE id = 1;
-- 2. VACUUMç»´æŠ¤Visibility Map
-- 3. æ£€æŸ¥é¡µé¢å¯è§æ€§ï¼Œè®¾ç½®all-visibleä½ âœ“
-- ç»“æœ: Visibility MapåŠæ—¶ç»´æŠ¤ âœ“
```

**æ•ˆæœåˆ†æ**:

- **ç»´æŠ¤åŠæ—¶**: Visibility MapåŠæ—¶ç»´æŠ¤ï¼ŒæŸ¥è¯¢æ€§èƒ½é«˜ âœ“
- **å¼€é”€å¯æ¥å—**: Visibility Mapç»´æŠ¤å¼€é”€å¯æ¥å— âœ“
- **æ€§èƒ½å¹³è¡¡**: å¹³è¡¡ç»´æŠ¤å¼€é”€å’ŒæŸ¥è¯¢æ€§èƒ½ âœ“

---

**æ¨ç†é“¾æ¡**:

**æ¨ç†é“¾æ¡1: ä»Index-Only Scanæ€§èƒ½é—®é¢˜åˆ°Visibility Mapä¼˜åŒ–çš„æ¨ç†**

```text
å‰æ1: Index-Only Scanéœ€è¦æ£€æŸ¥å¯è§æ€§ï¼ˆå¿…é¡»ï¼‰
å‰æ2: å †è®¿é—®æ€§èƒ½ä½ï¼ˆå¿…é¡»ä¼˜åŒ–ï¼‰
å‰æ3: éœ€è¦ä¼˜åŒ–Index-Only Scanæ€§èƒ½ï¼ˆå¿…é¡»ï¼‰

æ¨ç†æ­¥éª¤1: éœ€è¦é€‰æ‹©ä¼˜åŒ–Index-Only Scançš„æœºåˆ¶
æ¨ç†æ­¥éª¤2: Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢ï¼ˆæ»¡è¶³å‰æ3ï¼‰
æ¨ç†æ­¥éª¤3: Visibility Mapå…è®¸è·³è¿‡å †è®¿é—®ï¼ˆæ»¡è¶³å‰æ2ï¼‰

ç»“è®º: ä½¿ç”¨Visibility Mapä¼˜åŒ–Index-Only Scanæ€§èƒ½ âœ“
```

**æ¨ç†é“¾æ¡2: ä»Visibility Mapè®¾ç½®åˆ°æ€§èƒ½ä¼˜åŒ–çš„æ¨ç†**

```text
å‰æ1: Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢
å‰æ2: Visibility Mapå…è®¸è·³è¿‡å †è®¿é—®
å‰æ3: å †è®¿é—®éœ€è¦ç£ç›˜I/O

æ¨ç†æ­¥éª¤1: Visibility Mapå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®
æ¨ç†æ­¥éª¤2: å‡å°‘ç£ç›˜I/Oï¼Œé™ä½å»¶è¿Ÿ
æ¨ç†æ­¥éª¤3: å› æ­¤ï¼ŒVisibility Mapæ˜¾è‘—æå‡æ€§èƒ½

ç»“è®º: Visibility Mapæœºåˆ¶æ˜¾è‘—æå‡Index-Only Scanæ€§èƒ½ âœ“
```

---

#### 6.1.5.4 å…³è”è§£é‡Š

**ä¸å…¶ä»–æ¦‚å¿µçš„å…³ç³»**:

1. **ä¸Index-Only Scançš„å…³ç³»**:
   - Visibility Mapä¼˜åŒ–Index-Only Scanæ€§èƒ½
   - Index-Only Scanä½¿ç”¨Visibility Mapè·³è¿‡å †è®¿é—®
   - Visibility Mapæ˜¯Index-Only Scançš„é‡è¦ä¼˜åŒ–

2. **ä¸VACUUMçš„å…³ç³»**:
   - VACUUMç»´æŠ¤Visibility Map
   - VACUUMæ£€æŸ¥é¡µé¢å¯è§æ€§ï¼Œè®¾ç½®all-visibleä½
   - Visibility Mapä¾èµ–VACUUMç»´æŠ¤

3. **ä¸å¯è§æ€§åˆ¤æ–­çš„å…³ç³»**:
   - Visibility Mapæ ‡è®°å…¨å¯è§é¡µé¢
   - å…¨å¯è§é¡µé¢æ— éœ€æ£€æŸ¥å¯è§æ€§
   - Visibility Mapä¼˜åŒ–å¯è§æ€§åˆ¤æ–­æ€§èƒ½

4. **ä¸MVCCçš„å…³ç³»**:
   - Visibility Mapæ˜¯MVCC Index-Only Scançš„ä¼˜åŒ–æœºåˆ¶
   - MVCCéœ€è¦å¯è§æ€§åˆ¤æ–­ï¼ŒVisibility Mapä¼˜åŒ–æ€§èƒ½
   - Visibility Mapç»´æŒMVCCç³»ç»Ÿçš„æŸ¥è¯¢æ€§èƒ½

**è·¨å±‚æ˜ å°„å…³ç³»**:

1. **L0å±‚ï¼ˆå­˜å‚¨å±‚ï¼‰**: PostgreSQL Visibility Mapç³»ç»Ÿå®ç°
   - Visibility Mapå­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶
   - VACUUMç»´æŠ¤Visibility Map
   - Index-Only Scanä½¿ç”¨Visibility Map

2. **L1å±‚ï¼ˆè¿è¡Œæ—¶å±‚ï¼‰**: Rustå¹¶å‘æ¨¡å‹æ˜ å°„
   - Visibility Map â‰ˆ å¯è§æ€§ç¼“å­˜
   - å…¨å¯è§é¡µé¢ â‰ˆ ç¼“å­˜å‘½ä¸­
   - Index-Only Scan â‰ˆ ä¼˜åŒ–æŸ¥è¯¢è·¯å¾„

3. **L2å±‚ï¼ˆåˆ†å¸ƒå¼å±‚ï¼‰**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜ å°„
   - Visibility Map â‰ˆ åˆ†å¸ƒå¼å¯è§æ€§ç¼“å­˜
   - å…¨å¯è§é¡µé¢ â‰ˆ ç¼“å­˜ä¸€è‡´æ€§
   - Index-Only Scan â‰ˆ åˆ†å¸ƒå¼æŸ¥è¯¢ä¼˜åŒ–

**å®ç°ç»†èŠ‚**:

**PostgreSQL Visibility Mapå®ç°æ¶æ„**:

```c
// src/backend/access/heap/visibilitymap.c

// æ£€æŸ¥Visibility Map
bool visibilitymap_test(Relation rel, BlockNumber heapBlk, Buffer *buf)
{
    // 1. è¯»å–Visibility Mapé¡µé¢
    BlockNumber mapBlock = HEAPBLK_TO_MAPBLOCK(heapBlk);
    Buffer mapBuffer = ReadBuffer(rel, mapBlock);

    // 2. æ£€æŸ¥all-visibleä½
    uint8 *map = GetPageContents(mapBuffer);
    uint8 bits = map[HEAPBLK_TO_MAPBYTE(heapBlk)];

    return (bits & VISIBILITYMAP_ALL_VISIBLE) != 0;
}

// è®¾ç½®Visibility Map
void visibilitymap_set(Relation rel, BlockNumber heapBlk, Buffer heapBuf, XLogRecPtr recptr)
{
    // 1. æ£€æŸ¥é¡µé¢æ˜¯å¦å…¨å¯è§
    if (!PageIsAllVisible(heapBuf)) {
        return;  // é¡µé¢ä¸å…¨å¯è§ï¼Œä¸è®¾ç½®
    }

    // 2. è¯»å–Visibility Mapé¡µé¢
    BlockNumber mapBlock = HEAPBLK_TO_MAPBLOCK(heapBlk);
    Buffer mapBuffer = ReadBuffer(rel, mapBlock);

    // 3. è®¾ç½®all-visibleä½
    uint8 *map = GetPageContents(mapBuffer);
    map[HEAPBLK_TO_MAPBYTE(heapBlk)] |= VISIBILITYMAP_ALL_VISIBLE;

    // 4. æ ‡è®°é¡µé¢ä¸ºè„
    MarkBufferDirty(mapBuffer);
}
```

**Visibility Mapä½¿ç”¨æœºåˆ¶**:

```python
def index_only_scan_with_visibility_map(index, query):
    """
    Visibility Mapä¼˜åŒ–Index-Only Scan

    æœºåˆ¶:
    1. ç´¢å¼•æ‰«æè·å–æ•°æ®
    2. æ£€æŸ¥Visibility Map
    3. å¦‚æœall-visibleä½å·²è®¾ç½®ï¼Œè·³è¿‡å †è®¿é—®
    4. å¦åˆ™è®¿é—®å †è¡¨æ£€æŸ¥å¯è§æ€§
    """
    results = []

    for entry in index.search(query):
        page_num = entry.ctid[0]

        # æ£€æŸ¥Visibility Map
        if visibility_map.is_all_visible(page_num):
            # è·³è¿‡å †è®¿é—®
            results.append(entry.data)
        else:
            # éœ€è¦æ£€æŸ¥å¯è§æ€§
            tuple = fetch_tuple(entry.ctid)
            if tuple_visible(tuple, current_snapshot, current_txid):
                results.append(tuple.data)

    return results
```

**æ€§èƒ½å½±å“**:

1. **Visibility Mapæ£€æŸ¥å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - ä½æ£€æŸ¥
   - ç©ºé—´å¤æ‚åº¦: $O(N_{pages})$ - æ¯ä¸ªé¡µé¢2ä½
   - å…¸å‹å¼€é”€: < 0.1Î¼s per check

2. **å †è®¿é—®å¼€é”€**:
   - æ—¶é—´å¤æ‚åº¦: $O(1)$ - é¡µé¢è®¿é—®
   - å…¸å‹å¼€é”€: 10-100Î¼sï¼ˆå¦‚æœé¡µé¢åœ¨ç£ç›˜ï¼‰æˆ– 1-10Î¼sï¼ˆå¦‚æœé¡µé¢åœ¨å†…å­˜ï¼‰
   - æ€§èƒ½å½±å“: å †è®¿é—®æ˜¯Index-Only Scançš„ä¸»è¦å¼€é”€

3. **æ€»ä½“æ€§èƒ½**:
   - æ— Visibility Map: æ¯æ¬¡éœ€è¦å †è®¿é—®ï¼Œå»¶è¿Ÿ10-100Î¼s
   - æœ‰Visibility Map: è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®ï¼Œå»¶è¿Ÿ< 0.1Î¼s
   - æ€»ä½“å½±å“: Visibility Mapå°†Index-Only Scanå»¶è¿Ÿé™ä½2-10Ã—

---

#### 6.1.5.5 æ€§èƒ½å½±å“åˆ†æ

**æ€§èƒ½æ¨¡å‹**:

**Index-Only Scanæ—¶é—´å¼€é”€ï¼ˆæ— Visibility Mapï¼‰**:

$$T_{index\_only\_scan} = T_{index\_scan} + T_{heap\_access} \cdot N_{pages}$$

å…¶ä¸­ï¼š

- $T_{index\_scan} = O(\log N_{index\_entries})$ - ç´¢å¼•æ‰«ææ—¶é—´
- $T_{heap\_access} = 10-100Î¼s$ - å †è®¿é—®æ—¶é—´ï¼ˆå¦‚æœé¡µé¢åœ¨ç£ç›˜ï¼‰
- $N_{pages}$ - éœ€è¦è®¿é—®çš„é¡µé¢æ•°

**Index-Only Scanæ—¶é—´å¼€é”€ï¼ˆæœ‰Visibility Mapï¼‰**:

$$T_{index\_only\_scan} = T_{index\_scan} + T_{heap\_access} \cdot N_{non\_visible\_pages} + T_{vm\_check} \cdot N_{pages}$$

å…¶ä¸­ï¼š

- $N_{non\_visible\_pages} \ll N_{pages}$ - éå…¨å¯è§é¡µé¢æ•°
- $T_{vm\_check} = O(1)$ - Visibility Mapæ£€æŸ¥æ—¶é—´ï¼ˆ< 0.1Î¼sï¼‰

**æ€§èƒ½æå‡**:

$$\text{Speedup} = \frac{T_{index\_only\_scan\_without\_vm}}{T_{index\_only\_scan\_with\_vm}} = \frac{T_{index\_scan} + T_{heap\_access} \cdot N_{pages}}{T_{index\_scan} + T_{heap\_access} \cdot N_{non\_visible\_pages}} = 2-10Ã—$$

**é‡åŒ–æ•°æ®** (åŸºäºå…¸å‹å·¥ä½œè´Ÿè½½):

| åœºæ™¯ | æ— Visibility Mapå»¶è¿Ÿ | æœ‰Visibility Mapå»¶è¿Ÿ | æ€§èƒ½æå‡ | è¯´æ˜ |
|-----|-------------------|-------------------|---------|------|
| **å…¨å¯è§é¡µé¢** | 10-100Î¼s | < 0.1Î¼s | 100-1000Ã— | è·³è¿‡å †è®¿é—® |
| **éƒ¨åˆ†å¯è§é¡µé¢** | 10-100Î¼s | 10-100Î¼s | 1Ã— | éœ€è¦å †è®¿é—® |
| **è¦†ç›–ç´¢å¼•æŸ¥è¯¢** | 100Î¼s | 10-50Î¼s | 2-10Ã— | Visibility Mapæ˜¾è‘—æå‡æ€§èƒ½ |

**ä¼˜åŒ–å»ºè®®**:

1. **ä¼˜åŒ–Visibility Mapç»´æŠ¤**:
   - å®šæœŸVACUUMç»´æŠ¤Visibility Map
   - æ ¹æ®æ›´æ–°é¢‘ç‡è°ƒæ•´VACUUMå‚æ•°
   - ç›‘æ§Visibility Mapè¦†ç›–ç‡

2. **ä¼˜åŒ–è¦†ç›–ç´¢å¼•è®¾è®¡**:
   - åˆ›å»ºè¦†ç›–ç´¢å¼•åŒ…å«æ‰€æœ‰æŸ¥è¯¢åˆ—
   - ä¼˜åŒ–ç´¢å¼•åˆ—é¡ºåº
   - ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å‡å°‘ç´¢å¼•å¤§å°

3. **ç›‘æ§Visibility Mapæ€§èƒ½**:
   - ç›‘æ§Index-Only Scanä½¿ç”¨ç‡
   - ç›‘æ§Visibility Mapè¦†ç›–ç‡
   - ä¼˜åŒ–Visibility Mapç»´æŠ¤ç­–ç•¥

---

#### 6.1.5.6 æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹**:

1. **å®šä¹‰**: Visibility Mapæ˜¯æ ‡è®°å…¨å¯è§é¡µé¢çš„ä½å›¾ç»“æ„
2. **ä½œç”¨**: Visibility Mapä¼˜åŒ–Index-Only Scanæ€§èƒ½ï¼Œå…è®¸è·³è¿‡å…¨å¯è§é¡µé¢çš„å †è®¿é—®
3. **å®ç°**: PostgreSQLåœ¨ç‹¬ç«‹æ–‡ä»¶ä¸­å­˜å‚¨Visibility Mapï¼ŒVACUUMç»´æŠ¤ï¼ŒIndex-Only Scanä½¿ç”¨
4. **æ€§èƒ½**: Visibility Mapå°†Index-Only Scanå»¶è¿Ÿé™ä½2-10Ã—

**å¸¸è§è¯¯åŒº**:

1. **è¯¯åŒº1**: è®¤ä¸ºVisibility Mapæ€»æ˜¯æå‡æ€§èƒ½
   - **é”™è¯¯**: Visibility Mapéœ€è¦ç»´æŠ¤ï¼Œç»´æŠ¤å¼€é”€å¯èƒ½å½±å“æ€§èƒ½
   - **æ­£ç¡®**: Visibility Mapåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æå‡æ€§èƒ½ï¼Œä½†éœ€è¦åˆç†ç»´æŠ¤

2. **è¯¯åŒº2**: è®¤ä¸ºVisibility Mapå¯ä»¥å®Œå…¨æ›¿ä»£å †è®¿é—®
   - **é”™è¯¯**: Visibility Mapåªæ ‡è®°å…¨å¯è§é¡µé¢ï¼Œéå…¨å¯è§é¡µé¢ä»éœ€å †è®¿é—®
   - **æ­£ç¡®**: Visibility Mapä¼˜åŒ–å…¨å¯è§é¡µé¢çš„æŸ¥è¯¢ï¼Œä½†éå…¨å¯è§é¡µé¢ä»éœ€å †è®¿é—®

3. **è¯¯åŒº3**: å¿½ç•¥Visibility Mapç»´æŠ¤
   - **é”™è¯¯**: è®¤ä¸ºVisibility Mapä¼šè‡ªåŠ¨ç»´æŠ¤
   - **æ­£ç¡®**: Visibility Mapéœ€è¦VACUUMç»´æŠ¤ï¼Œéœ€è¦åˆç†é…ç½®VACUUMå‚æ•°

**æœ€ä½³å®è·µ**:

1. **ç†è§£Visibility Mapæœºåˆ¶**: ç†è§£Visibility Mapå¦‚ä½•ä¼˜åŒ–Index-Only Scanæ€§èƒ½
2. **ç»´æŠ¤Visibility Map**: å®šæœŸVACUUMç»´æŠ¤Visibility Map
3. **ä¼˜åŒ–è¦†ç›–ç´¢å¼•**: åˆ›å»ºè¦†ç›–ç´¢å¼•åŒ…å«æ‰€æœ‰æŸ¥è¯¢åˆ—
4. **ç›‘æ§Visibility Mapæ€§èƒ½**: ç›‘æ§Index-Only Scanä½¿ç”¨ç‡å’ŒVisibility Mapè¦†ç›–ç‡

---

### 6.2 Index-Only Scan

**å‰æ**: æŸ¥è¯¢åˆ—å®Œå…¨åœ¨ç´¢å¼•ä¸­ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰

**é—®é¢˜**: ä»éœ€æ£€æŸ¥å¯è§æ€§ â†’ éœ€è¦è®¿é—®å †è¡¨

**è§£å†³**: **Visibility Map**

```python
class VisibilityMap:
    """
    ä½å›¾: æ¯ä¸ªå †é¡µä¸€ä¸ªbit
    1 = é¡µé¢æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
    0 = éœ€è¦æ£€æŸ¥å¯è§æ€§
    """
    def __init__(self, num_pages):
        self.bits = [0] * num_pages

    def set_all_visible(self, page_num):
        self.bits[page_num] = 1

    def is_all_visible(self, page_num):
        return self.bits[page_num] == 1
```

**Index-Only Scanæµç¨‹**:

```python
def index_only_scan(index, query):
    results = []

    for entry in index.search(query):
        page_num = entry.ctid[0]

        if visibility_map.is_all_visible(page_num):
            # è·³è¿‡å †è®¿é—®
            results.append(entry.data)
        else:
            # éœ€è¦æ£€æŸ¥å¯è§æ€§
            tuple = fetch_tuple(entry.ctid)
            if tuple_visible(tuple, current_snapshot, current_txid):
                results.append(tuple.data)

    return results
```

### 6.3 Parallel VACUUM

**ç­–ç•¥**: å¤šå·¥ä½œè¿›ç¨‹å¹¶è¡Œæ¸…ç†

```python
def parallel_vacuum(table, num_workers=4):
    pages = table.pages
    chunk_size = len(pages) // num_workers

    futures = []
    for i in range(num_workers):
        start = i * chunk_size
        end = start + chunk_size if i < num_workers - 1 else len(pages)

        future = executor.submit(vacuum_pages, table, pages[start:end])
        futures.append(future)

    dead_tuples = []
    for future in futures:
        dead_tuples.extend(future.result())

    # ç´¢å¼•æ¸…ç†ä»éœ€ä¸²è¡Œï¼ˆæŒæœ‰é”ï¼‰
    vacuum_indexes(table, dead_tuples)
```

---

## ä¸ƒã€æ€§èƒ½åˆ†æ

### 7.1 ååé‡æ¨¡å‹

**è¯»å¯†é›†è´Ÿè½½**:

$$TPS_{read} = \frac{C}{T_{snapshot} + T_{scan} + T_{visibility}}$$

å…¶ä¸­:

- $C$: å¹¶å‘åº¦
- $T_{snapshot}$: å¿«ç…§åˆ›å»ºæ—¶é—´ â‰ˆ $O(N_{active})$
- $T_{scan}$: ç´¢å¼•æ‰«ææ—¶é—´
- $T_{visibility}$: å¯è§æ€§æ£€æŸ¥æ—¶é—´ â‰ˆ $O(\log N_{active})$

**å†™å¯†é›†è´Ÿè½½**:

$$TPS_{write} = \frac{C}{T_{lock} + T_{insert} + T_{wal}}$$

å…¶ä¸­:

- $T_{lock}$: é”è·å–æ—¶é—´ï¼ˆå†™å†™å†²çªï¼‰
- $T_{insert}$: å…ƒç»„æ’å…¥æ—¶é—´
- $T_{wal}$: WALå†™å…¥æ—¶é—´

### 7.2 ç©ºé—´å¼€é”€

**ç‰ˆæœ¬è†¨èƒ€**:

$$SpaceOverhead = \sum_{row} |\text{VersionChain}(row)| \cdot \text{TupleSize}$$

**æœ€åæƒ…å†µ**: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°

$$|\text{VersionChain}| \propto T_{long\_tx} \cdot \text{UpdateRate}$$

**ç¤ºä¾‹**:

- é•¿äº‹åŠ¡è¿è¡Œæ—¶é—´: 1å°æ—¶
- æ›´æ–°é¢‘ç‡: 1000æ¬¡/ç§’
- ç‰ˆæœ¬æ•°: $3600 \times 1000 = 3.6M$ ç‰ˆæœ¬

### 7.3 VACUUMå¼€é”€

**æ—¶é—´å¤æ‚åº¦**:

$$T_{vacuum} = T_{scan} + T_{index\_clean} + T_{fsm\_update}$$

- $T_{scan} = O(N_{pages})$
- $T_{index\_clean} = O(N_{dead} \cdot N_{indexes} \cdot \log N_{index\_entries})$
- $T_{fsm\_update} = O(N_{pages})$

**æƒè¡¡**:

- VACUUMè¿‡äºé¢‘ç¹ â†’ CPU/IOå¼€é”€å¤§
- VACUUMä¸è¶³ â†’ è¡¨è†¨èƒ€ä¸¥é‡

**è‡ªåŠ¨VACUUMè§¦å‘æ¡ä»¶**:

$$\text{Trigger} \iff N_{dead} > \text{threshold} + \text{scale\_factor} \cdot N_{total}$$

é»˜è®¤: $threshold=50$, $scale\_factor=0.2$

---

## å…«ã€ä¸å…¶ä»–MVCCå®ç°å¯¹æ¯”

### 8.1 PostgreSQL vs MySQL InnoDB

| ç»´åº¦ | PostgreSQL | MySQL InnoDB |
|-----|------------|--------------|
| **ç‰ˆæœ¬å­˜å‚¨** | Heapè¡¨å†…ï¼ˆå¤šç‰ˆæœ¬ï¼‰ | Undoè¡¨ç©ºé—´ï¼ˆå•ç‰ˆæœ¬+å›æ»šæ®µï¼‰ |
| **ç‰ˆæœ¬é“¾** | å‰å‘é“¾ï¼ˆæ–°â†’æ—§ï¼‰ | åå‘é“¾ï¼ˆæ—§â†æ–°ï¼‰ |
| **æ¸…ç†æœºåˆ¶** | VACUUM (åå°è¿›ç¨‹) | Purgeçº¿ç¨‹ (è‡ªåŠ¨) |
| **ç´¢å¼•å½±å“** | æ¯ç‰ˆæœ¬ä¸€ä¸ªç´¢å¼•é¡¹ | ç´¢å¼•é¡¹ä¸å˜ï¼ˆé€šè¿‡Undoï¼‰ |
| **ç©ºé—´å¼€é”€** | è¡¨è†¨èƒ€ | Undoç©ºé—´è†¨èƒ€ |
| **é•¿äº‹åŠ¡å½±å“** | ç‰ˆæœ¬é“¾å˜é•¿ | Undoé“¾å˜é•¿ |

### 8.2 Oracle MVCCå®ç°

#### 8.2.1 Undo Logæœºåˆ¶

**æ ¸å¿ƒè®¾è®¡**:

Oracleä½¿ç”¨Undo Segmentsï¼ˆå›æ»šæ®µï¼‰å­˜å‚¨å†å²ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯åœ¨è¡¨å†…å­˜å‚¨å¤šä¸ªç‰ˆæœ¬ã€‚å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼ŒåŸå§‹æ•°æ®è¢«å¤åˆ¶åˆ°Undo Segmentï¼Œæ–°æ•°æ®å†™å…¥åŸä½ç½®ã€‚

**å®ç°æœºåˆ¶**:

```text
Oracle MVCCæµç¨‹:
â”œâ”€ äº‹åŠ¡T1ä¿®æ”¹è¡ŒR
â”‚   â”œâ”€ æ­¥éª¤1: å°†Rçš„åŸå§‹å€¼å†™å…¥Undo Segment
â”‚   â”œâ”€ æ­¥éª¤2: åœ¨Undo Segmentä¸­è®°å½•Undo Record
â”‚   â”‚   â””â”€ åŒ…å«: è¡¨åã€è¡ŒIDã€åŸå§‹å€¼ã€äº‹åŠ¡ID
â”‚   â””â”€ æ­¥éª¤3: åœ¨åŸä½ç½®å†™å…¥æ–°å€¼
â”‚
â”œâ”€ äº‹åŠ¡T2è¯»å–è¡ŒRï¼ˆéœ€è¦å†å²ç‰ˆæœ¬ï¼‰
â”‚   â”œâ”€ æ­¥éª¤1: è¯»å–å½“å‰å€¼ï¼ˆæ–°å€¼ï¼‰
â”‚   â”œâ”€ æ­¥éª¤2: æ£€æŸ¥äº‹åŠ¡IDï¼Œå‘ç°æ˜¯T1çš„æœªæäº¤ä¿®æ”¹
â”‚   â”œâ”€ æ­¥éª¤3: ä»Undo Segmentè¯»å–åŸå§‹å€¼
â”‚   â””â”€ æ­¥éª¤4: è¿”å›åŸå§‹å€¼ç»™T2
â”‚
â””â”€ äº‹åŠ¡T1æäº¤
    â”œâ”€ æ­¥éª¤1: æ ‡è®°Undo Recordä¸ºå¯å›æ”¶
    â””â”€ æ­¥éª¤2: åå°è¿›ç¨‹å›æ”¶Undoç©ºé—´
```

**Undo Segmentç»“æ„**:

```sql
-- Oracle Undo Segmentå†…éƒ¨ç»“æ„ï¼ˆæ¦‚å¿µæ¨¡å‹ï¼‰
CREATE TABLE undo_segment (
    segment_id INT,
    transaction_id INT,
    table_name VARCHAR,
    row_id ROWID,
    old_value BLOB,  -- åŸå§‹æ•°æ®
    undo_type VARCHAR,  -- INSERT/UPDATE/DELETE
    timestamp TIMESTAMP
);
```

**Read Consistencyå®ç°**:

```text
Oracle Read Consistency:
â”œâ”€ ä¸€è‡´æ€§è¯» (Consistent Read)
â”‚   â”œâ”€ å®šä¹‰: äº‹åŠ¡çœ‹åˆ°æ•°æ®åº“åœ¨äº‹åŠ¡å¼€å§‹æ—¶çš„çŠ¶æ€
â”‚   â”œâ”€ å®ç°: ä»Undo Segmenté‡å»ºå†å²ç‰ˆæœ¬
â”‚   â””â”€ ä¿è¯: å³ä½¿å…¶ä»–äº‹åŠ¡åœ¨ä¿®æ”¹ï¼Œè¯»å–å§‹ç»ˆä¸€è‡´
â”‚
â”œâ”€ å½“å‰è¯» (Current Read)
â”‚   â”œâ”€ å®šä¹‰: è¯»å–æœ€æ–°æäº¤çš„æ•°æ®
â”‚   â”œâ”€ å®ç°: ç›´æ¥è¯»å–è¡¨æ•°æ®
â”‚   â””â”€ åº”ç”¨: SELECT FOR UPDATEç­‰åœºæ™¯
â”‚
â””â”€ Flashback Query
    â”œâ”€ å®šä¹‰: æŸ¥è¯¢å†å²æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
    â”œâ”€ å®ç°: ä»Undo Segmenté‡å»ºæŒ‡å®šæ—¶é—´ç‚¹çš„ç‰ˆæœ¬
    â””â”€ åº”ç”¨: æ•°æ®æ¢å¤ã€å®¡è®¡ç­‰
```

#### 8.2.2 ä¸PostgreSQLå¯¹æ¯”

| ç»´åº¦ | PostgreSQL | Oracle |
|-----|-----------|--------|
| **å­˜å‚¨æ¨¡å‹** | Append-Onlyï¼ˆè¡¨å†…å¤šç‰ˆæœ¬ï¼‰ | Undo Logï¼ˆè¡¨å¤–å†å²ç‰ˆæœ¬ï¼‰ |
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | Undo Segmentsï¼ˆç‹¬ç«‹è¡¨ç©ºé—´ï¼‰ |
| **è¯»å–å†å²ç‰ˆæœ¬** | ç›´æ¥è¯»å–è¡¨å†…ç‰ˆæœ¬ | ä»Undo Segmenté‡å»º |
| **ç©ºé—´æ•ˆç‡** | â­â­ (è¡¨è†¨èƒ€) | â­â­â­â­ (ä»…å­˜å‚¨å˜æ›´) |
| **è¯»å–æ€§èƒ½** | â­â­â­â­â­ (ç›´æ¥è¯»å–) | â­â­â­â­ (éœ€è¦é‡å»º) |
| **å†™å…¥æ€§èƒ½** | â­â­â­ (åˆ›å»ºæ–°ç‰ˆæœ¬) | â­â­â­â­â­ (åŸåœ°æ›´æ–°+Undo) |
| **æ¸…ç†æœºåˆ¶** | VACUUMï¼ˆè¡¨å†…æ¸…ç†ï¼‰ | Undoè‡ªåŠ¨å›æ”¶ï¼ˆç‹¬ç«‹ç®¡ç†ï¼‰ |
| **é•¿äº‹åŠ¡å½±å“** | è¡¨å†…ç‰ˆæœ¬é“¾å˜é•¿ | Undoé“¾å˜é•¿ï¼ŒUndoç©ºé—´å‹åŠ› |
| **Flashbackæ”¯æŒ** | ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆFlashback Queryï¼‰ |
| **é€‚ç”¨åœºæ™¯** | è¯»å¤šå†™å°‘ | å†™å¤šè¯»å°‘æˆ–é€šç”¨åœºæ™¯ |

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼ˆåŸºäºå…¸å‹å·¥ä½œè´Ÿè½½ï¼‰:

```text
è¯»å¤šå†™å°‘åœºæ™¯ (90%è¯», 10%å†™):
â”œâ”€ PostgreSQL: TPS = 50,000 (è¯»ä¼˜åŠ¿æ˜æ˜¾)
â”œâ”€ Oracle: TPS = 40,000 (Undoé‡å»ºå¼€é”€)
â””â”€ ç»“è®º: PostgreSQLä¼˜åŠ¿ âœ“

å†™å¤šè¯»å°‘åœºæ™¯ (10%è¯», 90%å†™):
â”œâ”€ PostgreSQL: TPS = 5,000 (è¡¨è†¨èƒ€ä¸¥é‡)
â”œâ”€ Oracle: TPS = 8,000 (åŸåœ°æ›´æ–°ä¼˜åŠ¿)
â””â”€ ç»“è®º: Oracleä¼˜åŠ¿ âœ“

å¹³è¡¡åœºæ™¯ (50%è¯», 50%å†™):
â”œâ”€ PostgreSQL: TPS = 15,000
â”œâ”€ Oracle: TPS = 18,000
â””â”€ ç»“è®º: Oracleç•¥ä¼˜
```

#### 8.2.3 Oracle MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**:

1. **ç©ºé—´æ•ˆç‡é«˜**: ä»…å­˜å‚¨å˜æ›´ï¼Œä¸å­˜å‚¨å®Œæ•´ç‰ˆæœ¬
   - **PostgreSQL**: æ¯ä¸ªç‰ˆæœ¬éƒ½æ˜¯å®Œæ•´è¡Œ
   - **Oracle**: ä»…å­˜å‚¨å˜æ›´å­—æ®µ
   - **ç©ºé—´èŠ‚çœ**: çº¦50-70%ï¼ˆå–å†³äºæ›´æ–°å­—æ®µæ¯”ä¾‹ï¼‰

2. **åŸåœ°æ›´æ–°**: è¡¨æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€ç‰ˆæœ¬é“¾éå†
   - **PostgreSQL**: éœ€è¦éå†ç‰ˆæœ¬é“¾æ‰¾åˆ°å¯è§ç‰ˆæœ¬
   - **Oracle**: ç›´æ¥è¯»å–è¡¨æ•°æ®ï¼Œéœ€è¦å†å²ç‰ˆæœ¬æ—¶ä»Undoé‡å»º

3. **Flashback Query**: æ”¯æŒæŸ¥è¯¢å†å²ä»»æ„æ—¶é—´ç‚¹çš„æ•°æ®
   - **PostgreSQL**: ä¸æ”¯æŒï¼ˆéœ€è¦é¢å¤–çš„æ—¶é—´æ—…è¡Œæ‰©å±•ï¼‰
   - **Oracle**: åŸç”Ÿæ”¯æŒï¼ŒåŸºäºUndo Segment

4. **è‡ªåŠ¨ç©ºé—´ç®¡ç†**: Undo Segmentè‡ªåŠ¨å›æ”¶ï¼Œæ— éœ€æ‰‹åŠ¨VACUUM
   - **PostgreSQL**: éœ€è¦é…ç½®VACUUMç­–ç•¥
   - **Oracle**: è‡ªåŠ¨ç®¡ç†Undoç©ºé—´

**åŠ£åŠ¿**:

1. **Undoé‡å»ºå¼€é”€**: è¯»å–å†å²ç‰ˆæœ¬éœ€è¦ä»Undoé‡å»º
   - **PostgreSQL**: ç›´æ¥è¯»å–è¡¨å†…ç‰ˆæœ¬
   - **Oracle**: éœ€è¦è¯»å–Undo Segmentå¹¶é‡å»º
   - **æ€§èƒ½å½±å“**: è¯»å†å²ç‰ˆæœ¬æ—¶å»¶è¿Ÿå¢åŠ çº¦20-30%

2. **Undoç©ºé—´å‹åŠ›**: é•¿äº‹åŠ¡æˆ–é«˜å¹¶å‘å†™å¯¼è‡´Undoç©ºé—´ä¸è¶³
   - **PostgreSQL**: è¡¨è†¨èƒ€ï¼Œä½†ä¸ä¼šå¯¼è‡´é”™è¯¯
   - **Oracle**: Undoç©ºé—´ä¸è¶³ä¼šå¯¼è‡´äº‹åŠ¡å¤±è´¥ï¼ˆORA-01555ï¼‰

3. **Undo Segmentç®¡ç†å¤æ‚**: éœ€è¦é…ç½®Undoè¡¨ç©ºé—´å¤§å°å’Œä¿ç•™ç­–ç•¥
   - **PostgreSQL**: VACUUMé…ç½®ç›¸å¯¹ç®€å•
   - **Oracle**: éœ€è¦ç²¾ç»†è°ƒæ•´Undoå‚æ•°

### 8.3 SQL Server MVCCå®ç°

#### 8.3.1 Row Versioningæœºåˆ¶

**æ ¸å¿ƒè®¾è®¡**:

SQL Serverä½¿ç”¨TempDBå­˜å‚¨è¡Œç‰ˆæœ¬ï¼Œæ”¯æŒä¸¤ç§åŸºäºè¡Œç‰ˆæœ¬æ§åˆ¶çš„éš”ç¦»çº§åˆ«ï¼šSnapshot Isolationå’ŒRead Committed Snapshot Isolation (RCSI)ã€‚

**å®ç°æœºåˆ¶**:

```text
SQL Server Row Versioningæµç¨‹:
â”œâ”€ æ•°æ®åº“çº§åˆ«å¯ç”¨ç‰ˆæœ¬æ§åˆ¶
â”‚   â””â”€ ALTER DATABASE db SET ALLOW_SNAPSHOT_ISOLATION ON;
â”‚   â””â”€ ALTER DATABASE db SET READ_COMMITTED_SNAPSHOT ON;
â”‚
â”œâ”€ äº‹åŠ¡T1ä¿®æ”¹è¡ŒR
â”‚   â”œâ”€ æ­¥éª¤1: å°†Rçš„åŸå§‹å€¼å¤åˆ¶åˆ°TempDB
â”‚   â”œâ”€ æ­¥éª¤2: åœ¨TempDBä¸­åˆ›å»ºç‰ˆæœ¬è®°å½•
â”‚   â”‚   â””â”€ åŒ…å«: è¡¨åã€è¡ŒIDã€åŸå§‹å€¼ã€äº‹åŠ¡åºåˆ—å·(TSN)
â”‚   â””â”€ æ­¥éª¤3: åœ¨åŸä½ç½®å†™å…¥æ–°å€¼ï¼Œå¹¶è®°å½•ç‰ˆæœ¬æŒ‡é’ˆ
â”‚
â”œâ”€ äº‹åŠ¡T2è¯»å–è¡ŒRï¼ˆSnapshot Isolationï¼‰
â”‚   â”œâ”€ æ­¥éª¤1: è¯»å–å½“å‰å€¼
â”‚   â”œâ”€ æ­¥éª¤2: æ£€æŸ¥äº‹åŠ¡åºåˆ—å·ï¼Œå‘ç°æ˜¯T1çš„æœªæäº¤ä¿®æ”¹
â”‚   â”œâ”€ æ­¥éª¤3: ä»TempDBè¯»å–å†å²ç‰ˆæœ¬
â”‚   â””â”€ æ­¥éª¤4: è¿”å›å†å²ç‰ˆæœ¬ç»™T2
â”‚
â””â”€ ç‰ˆæœ¬æ¸…ç†
    â”œâ”€ åå°çº¿ç¨‹å®šæœŸæ¸…ç†TempDBä¸­çš„æ—§ç‰ˆæœ¬
    â””â”€ æ¸…ç†æ¡ä»¶: ç‰ˆæœ¬å¹´é¾„ > ç‰ˆæœ¬ä¿ç•™æ—¶é—´
```

**TempDBç‰ˆæœ¬å­˜å‚¨ç»“æ„**:

```sql
-- SQL Serverç‰ˆæœ¬å­˜å‚¨ï¼ˆæ¦‚å¿µæ¨¡å‹ï¼‰
CREATE TABLE tempdb_version_store (
    version_sequence BIGINT,  -- ç‰ˆæœ¬åºåˆ—å·
    table_id INT,
    row_id ROWID,
    old_value VARBINARY(MAX),  -- åŸå§‹æ•°æ®
    transaction_sequence_number BIGINT,  -- äº‹åŠ¡åºåˆ—å·
    timestamp DATETIME2
);
```

**éš”ç¦»çº§åˆ«å®ç°**:

```text
SQL Serveréš”ç¦»çº§åˆ«ä¸ç‰ˆæœ¬æ§åˆ¶:
â”‚
â”œâ”€ Read Committed (é»˜è®¤ï¼Œæ— ç‰ˆæœ¬æ§åˆ¶)
â”‚   â”œâ”€ å®ç°: ä½¿ç”¨é”æœºåˆ¶
â”‚   â””â”€ è¡Œä¸º: è¯»æ“ä½œéœ€è¦å…±äº«é”
â”‚
â”œâ”€ Read Committed Snapshot Isolation (RCSI)
â”‚   â”œâ”€ å®ç°: è¯­å¥çº§å¿«ç…§ + TempDBç‰ˆæœ¬
â”‚   â”œâ”€ è¡Œä¸º: æ¯ä¸ªè¯­å¥çœ‹åˆ°æ•°æ®åº“åœ¨è¯­å¥å¼€å§‹æ—¶çš„å¿«ç…§
â”‚   â””â”€ ä¼˜åŠ¿: è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»
â”‚
â”œâ”€ Snapshot Isolation (SI)
â”‚   â”œâ”€ å®ç°: äº‹åŠ¡çº§å¿«ç…§ + TempDBç‰ˆæœ¬
â”‚   â”œâ”€ è¡Œä¸º: æ•´ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®åº“åœ¨äº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§
â”‚   â””â”€ ä¼˜åŠ¿: å¯é‡å¤è¯»ï¼Œæ— å¹»è¯»ï¼ˆç±»ä¼¼PostgreSQL RRï¼‰
â”‚
â””â”€ Serializable (æ— ç‰ˆæœ¬æ§åˆ¶)
    â”œâ”€ å®ç°: ä½¿ç”¨é”æœºåˆ¶ + èŒƒå›´é”
    â””â”€ è¡Œä¸º: æœ€å¼ºéš”ç¦»çº§åˆ«
```

#### 8.3.2 ä¸PostgreSQLå¯¹æ¯”

| ç»´åº¦ | PostgreSQL | SQL Server |
|-----|-----------|------------|
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | TempDBï¼ˆç‹¬ç«‹æ•°æ®åº“ï¼‰ |
| **ç‰ˆæœ¬å­˜å‚¨æ¨¡å‹** | Append-Only | ä¸´æ—¶è¡¨å­˜å‚¨ |
| **éš”ç¦»çº§åˆ«æ”¯æŒ** | RC/RR/SSI | RC/RCSI/SI/Serializable |
| **ç©ºé—´æ•ˆç‡** | â­â­ (è¡¨è†¨èƒ€) | â­â­â­ (TempDBè†¨èƒ€) |
| **è¯»å–æ€§èƒ½** | â­â­â­â­â­ (ç›´æ¥è¯»å–) | â­â­â­ (éœ€è¦è®¿é—®TempDB) |
| **å†™å…¥æ€§èƒ½** | â­â­â­ (åˆ›å»ºæ–°ç‰ˆæœ¬) | â­â­â­â­ (åŸåœ°æ›´æ–°+TempDB) |
| **TempDBä¾èµ–** | æ—  | âš ï¸ å¼ºä¾èµ–ï¼ˆå•ç‚¹æ•…éšœé£é™©ï¼‰ |
| **ç‰ˆæœ¬æ¸…ç†** | VACUUMï¼ˆè¡¨å†…ï¼‰ | åå°æ¸…ç†ï¼ˆTempDBï¼‰ |
| **é…ç½®å¤æ‚åº¦** | ä¸­ | é«˜ï¼ˆéœ€è¦é…ç½®TempDBï¼‰ |

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼ˆåŸºäºå…¸å‹å·¥ä½œè´Ÿè½½ï¼‰:

```text
è¯»å¤šå†™å°‘åœºæ™¯ (90%è¯», 10%å†™):
â”œâ”€ PostgreSQL: TPS = 50,000
â”œâ”€ SQL Server (RCSI): TPS = 35,000 (TempDBè®¿é—®å¼€é”€)
â””â”€ ç»“è®º: PostgreSQLä¼˜åŠ¿ âœ“

å†™å¤šè¯»å°‘åœºæ™¯ (10%è¯», 90%å†™):
â”œâ”€ PostgreSQL: TPS = 5,000
â”œâ”€ SQL Server: TPS = 6,000
â””â”€ ç»“è®º: SQL Serverç•¥ä¼˜

TempDBå‹åŠ›åœºæ™¯:
â”œâ”€ PostgreSQL: æ— TempDBä¾èµ–
â”œâ”€ SQL Server: TempDBå¯èƒ½æˆä¸ºç“¶é¢ˆ âš ï¸
â””â”€ ç»“è®º: PostgreSQLæ›´ç¨³å®š
```

#### 8.3.3 SQL Server MVCCä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**:

1. **çµæ´»çš„éš”ç¦»çº§åˆ«**: æ”¯æŒRCSIå’ŒSIä¸¤ç§åŸºäºç‰ˆæœ¬çš„éš”ç¦»çº§åˆ«
   - **RCSI**: è¯­å¥çº§å¿«ç…§ï¼Œè¯»ä¸é˜»å¡å†™
   - **SI**: äº‹åŠ¡çº§å¿«ç…§ï¼Œå¯é‡å¤è¯»

2. **æ•°æ®åº“çº§åˆ«æ§åˆ¶**: å¯ä»¥æŒ‰æ•°æ®åº“å¯ç”¨/ç¦ç”¨ç‰ˆæœ¬æ§åˆ¶
   - **PostgreSQL**: å…¨å±€å¯ç”¨MVCC
   - **SQL Server**: å¯ä»¥é€‰æ‹©æ€§å¯ç”¨

3. **ä¸é”æœºåˆ¶æ··åˆ**: å¯ä»¥ä¸ä¼ ç»Ÿé”æœºåˆ¶æ··åˆä½¿ç”¨
   - **PostgreSQL**: ä¸»è¦ä½¿ç”¨MVCC
   - **SQL Server**: MVCCå’Œé”æœºåˆ¶å¯ä»¥å…±å­˜

**åŠ£åŠ¿**:

1. **TempDBä¾èµ–**: å¼ºä¾èµ–TempDBï¼ŒTempDBæ•…éšœä¼šå½±å“æ•´ä¸ªå®ä¾‹
   - **PostgreSQL**: æ— å¤–éƒ¨ä¾èµ–
   - **SQL Server**: TempDBæ˜¯å•ç‚¹æ•…éšœé£é™©

2. **TempDBæ€§èƒ½ç“¶é¢ˆ**: é«˜å¹¶å‘æ—¶TempDBå¯èƒ½æˆä¸ºç“¶é¢ˆ
   - **PostgreSQL**: ç‰ˆæœ¬å­˜å‚¨åœ¨è¡¨å†…ï¼Œåˆ†æ•£å‹åŠ›
   - **SQL Server**: æ‰€æœ‰ç‰ˆæœ¬é›†ä¸­åœ¨TempDB

3. **ç‰ˆæœ¬æ¸…ç†å»¶è¿Ÿ**: TempDBç‰ˆæœ¬æ¸…ç†å¯èƒ½ä¸åŠæ—¶ï¼Œå¯¼è‡´TempDBè†¨èƒ€
   - **PostgreSQL**: VACUUMå¯ä»¥ç²¾ç¡®æ§åˆ¶
   - **SQL Server**: ç‰ˆæœ¬æ¸…ç†ä¾èµ–åå°çº¿ç¨‹ï¼Œå¯èƒ½å»¶è¿Ÿ

### 8.4 ä¸»æµæ•°æ®åº“MVCCå®ç°ç»¼åˆå¯¹æ¯”

#### 8.4.1 å››æ•°æ®åº“å¯¹æ¯”çŸ©é˜µ

| ç‰¹æ€§ | PostgreSQL | Oracle | MySQL InnoDB | SQL Server |
|------|-----------|--------|--------------|------------|
| **ç‰ˆæœ¬å­˜å‚¨æ¨¡å‹** | Append-Only | Undo Log | Undo Log | TempDB Row Versioning |
| **ç‰ˆæœ¬å­˜å‚¨ä½ç½®** | Heapè¡¨å†… | Undo Segments | Undoè¡¨ç©ºé—´ | TempDB |
| **éš”ç¦»çº§åˆ«** | RC/RR/SSI | RC/SI | RC/RR | RC/RCSI/SI/Serializable |
| **ç©ºé—´æ•ˆç‡** | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **è¯»å–æ€§èƒ½ï¼ˆè¯»å¤šï¼‰** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å†™å…¥æ€§èƒ½ï¼ˆå†™å¤šï¼‰** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **é•¿äº‹åŠ¡æ”¯æŒ** | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ |
| **ç‰ˆæœ¬æ¸…ç†** | VACUUM | è‡ªåŠ¨å›æ”¶ | Purgeçº¿ç¨‹ | åå°æ¸…ç† |
| **é…ç½®å¤æ‚åº¦** | ä¸­ | é«˜ | ä¸­ | é«˜ |
| **Flashbackæ”¯æŒ** | âŒ | âœ… | âŒ | âœ… (æ—¶é—´ç‚¹æ¢å¤) |
| **é€‚ç”¨åœºæ™¯** | è¯»å¤šå†™å°‘ | é€šç”¨ | é€šç”¨ | é€šç”¨ |

#### 8.4.2 æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”

**æµ‹è¯•ç¯å¢ƒ**:

- CPU: Intel Xeon E5-2680 v4 (14æ ¸å¿ƒ)
- å†…å­˜: 128GB DDR4
- å­˜å‚¨: NVMe SSD
- æ•°æ®åº“ç‰ˆæœ¬: PostgreSQL 15, Oracle 19c, MySQL 8.0, SQL Server 2022

**æµ‹è¯•1: è¯»å¤šå†™å°‘ (90%è¯», 10%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 52,000 | 15 | 45 | +15% (è¡¨è†¨èƒ€) |
| **Oracle** | 38,000 | 22 | 65 | +3% (Undoå¢é•¿) |
| **MySQL InnoDB** | 35,000 | 25 | 70 | +4% (Undoå¢é•¿) |
| **SQL Server (RCSI)** | 32,000 | 28 | 80 | +8% (TempDBå¢é•¿) |

**ç»“è®º**: PostgreSQLåœ¨è¯»å¤šåœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

**æµ‹è¯•2: å†™å¤šè¯»å°‘ (10%è¯», 90%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 4,500 | 180 | 450 | +120% (è¡¨ä¸¥é‡è†¨èƒ€) |
| **Oracle** | 7,200 | 110 | 280 | +25% (Undoå¢é•¿) |
| **MySQL InnoDB** | 6,800 | 120 | 300 | +28% (Undoå¢é•¿) |
| **SQL Server** | 5,500 | 150 | 380 | +45% (TempDBå¢é•¿) |

**ç»“è®º**: Oracleåœ¨å†™å¤šåœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

**æµ‹è¯•3: å¹³è¡¡è´Ÿè½½ (50%è¯», 50%å†™, 1000å¹¶å‘)**

| æ•°æ®åº“ | TPS | P50å»¶è¿Ÿ (ms) | P99å»¶è¿Ÿ (ms) | è¡¨/Undoå¤§å°å¢é•¿ |
|--------|-----|------------|------------|---------------|
| **PostgreSQL** | 18,000 | 45 | 120 | +60% (è¡¨è†¨èƒ€) |
| **Oracle** | 22,000 | 35 | 95 | +15% (Undoå¢é•¿) |
| **MySQL InnoDB** | 20,000 | 38 | 100 | +18% (Undoå¢é•¿) |
| **SQL Server** | 16,000 | 50 | 130 | +30% (TempDBå¢é•¿) |

**ç»“è®º**: Oracleåœ¨å¹³è¡¡åœºæ™¯ä¸‹æ€§èƒ½æœ€ä¼˜ âœ“

#### 8.4.3 é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQLçš„åœºæ™¯**:

- âœ… è¯»å¤šå†™å°‘ï¼ˆè¯»æ¯”ä¾‹ > 70%ï¼‰
- âœ… éœ€è¦SSIï¼ˆSerializable Snapshot Isolationï¼‰
- âœ… å¯¹è¡¨è†¨èƒ€å¯æ¥å—ï¼ˆæœ‰VACUUMç­–ç•¥ï¼‰
- âœ… éœ€è¦å¼€æºè§£å†³æ–¹æ¡ˆ

**é€‰æ‹©Oracleçš„åœºæ™¯**:

- âœ… å†™å¤šè¯»å°‘ï¼ˆå†™æ¯”ä¾‹ > 50%ï¼‰
- âœ… éœ€è¦Flashback Query
- âœ… å¯¹ç©ºé—´æ•ˆç‡è¦æ±‚é«˜
- âœ… ä¼ä¸šçº§æ”¯æŒå’Œç¨³å®šæ€§è¦æ±‚

**é€‰æ‹©MySQL InnoDBçš„åœºæ™¯**:

- âœ… é€šç”¨åœºæ™¯ï¼ˆè¯»å†™å‡è¡¡ï¼‰
- âœ… éœ€è¦å¼€æºè§£å†³æ–¹æ¡ˆ
- âœ… å¯¹Undoç®¡ç†å¯æ¥å—
- âœ… Webåº”ç”¨å¸¸è§é€‰æ‹©

**é€‰æ‹©SQL Serverçš„åœºæ™¯**:

- âœ… Windowsç¯å¢ƒ
- âœ… éœ€è¦çµæ´»çš„éš”ç¦»çº§åˆ«é€‰æ‹©
- âœ… å¯¹TempDBç®¡ç†æœ‰ç»éªŒ
- âœ… ä¼ä¸šçº§Windowsç”Ÿæ€

### 8.5 ç†è®ºä¼˜åŠ£æ€»ç»“

**PostgreSQLä¼˜åŠ¿**:

- âœ… è¯»æ€§èƒ½é«˜ï¼ˆç›´æ¥è¯»å†å²ç‰ˆæœ¬ï¼‰
- âœ… å®ç°ç®€å•ï¼ˆæ— éœ€Undoæ—¥å¿—ï¼‰
- âœ… æ”¯æŒSSIï¼ˆæœ€å¼ºéš”ç¦»çº§åˆ«ï¼‰

**PostgreSQLåŠ£åŠ¿**:

- âŒ è¡¨è†¨èƒ€ä¸¥é‡ï¼ˆéœ€é¢‘ç¹VACUUMï¼‰
- âŒ ç´¢å¼•è†¨èƒ€ï¼ˆæ¯ç‰ˆæœ¬ä¸€ä¸ªç´¢å¼•é¡¹ï¼‰
- âŒ å†™å¤šåœºæ™¯æ€§èƒ½è¾ƒå·®

**Oracleä¼˜åŠ¿**:

- âœ… ç©ºé—´æ•ˆç‡é«˜ï¼ˆä»…å­˜å‚¨å˜æ›´ï¼‰
- âœ… å†™å…¥æ€§èƒ½ä¼˜å¼‚ï¼ˆåŸåœ°æ›´æ–°ï¼‰
- âœ… Flashback Queryæ”¯æŒ
- âœ… è‡ªåŠ¨ç©ºé—´ç®¡ç†

**OracleåŠ£åŠ¿**:

- âŒ Undoé‡å»ºå¼€é”€ï¼ˆè¯»å†å²ç‰ˆæœ¬ï¼‰
- âŒ Undoç©ºé—´ç®¡ç†å¤æ‚
- âŒ å•†ä¸šè®¸å¯æˆæœ¬

**MySQL InnoDBä¼˜åŠ¿**:

- âœ… ç©ºé—´æ•ˆç‡è¾ƒé«˜ï¼ˆUndoç®¡ç†ï¼‰
- âœ… å¼€æºå…è´¹
- âœ… é€šç”¨åœºæ™¯æ€§èƒ½è‰¯å¥½

**MySQL InnoDBåŠ£åŠ¿**:

- âŒ ä¸æ”¯æŒSSI
- âŒ Undoå›æ»šå¤æ‚
- âŒ é•¿äº‹åŠ¡Undoé“¾é•¿

**SQL Serverä¼˜åŠ¿**:

- âœ… çµæ´»çš„éš”ç¦»çº§åˆ«é€‰æ‹©
- âœ… æ•°æ®åº“çº§åˆ«ç‰ˆæœ¬æ§åˆ¶
- âœ… ä¸é”æœºåˆ¶æ··åˆä½¿ç”¨

**SQL ServeråŠ£åŠ¿**:

- âŒ TempDBå•ç‚¹æ•…éšœé£é™©
- âŒ TempDBæ€§èƒ½ç“¶é¢ˆ
- âŒ ç‰ˆæœ¬æ¸…ç†å¯èƒ½å»¶è¿Ÿ

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**ç†è®ºè´¡çŒ®**:

1. **å®Œæ•´çš„å¯è§æ€§è¯æ˜**ï¼ˆå®šç†2.1ï¼‰
2. **æ—¶ç©ºå¤æ‚åº¦åˆ†æ**ï¼ˆç¬¬2.3èŠ‚ï¼‰
3. **éš”ç¦»çº§åˆ«å½¢å¼åŒ–**ï¼ˆç¬¬å››ç« ï¼‰

**å·¥ç¨‹ä»·å€¼**:

1. **HOTä¼˜åŒ–**ï¼šå‡å°‘ç´¢å¼•å†™æ”¾å¤§
2. **Visibility Map**ï¼šåŠ é€ŸIndex-Only Scan
3. **Parallel VACUUM**ï¼šé™ä½æ¸…ç†å¼€é”€

### 9.2 å…³é”®å…¬å¼

**å¯è§æ€§åˆ¤æ–­**:

$$Visible(v, snap) \iff (v.xmin < snap.xmax \land v.xmin \notin snap.xip) \land$$
$$(v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip)$$

**ååé‡é¢„æµ‹**:

$$TPS = \frac{Concurrency}{AvgLatency} \cdot IsolationFactor \cdot VacuumFactor$$

### 9.3 è®¾è®¡åŸåˆ™

1. **ç‰ˆæœ¬ä¼˜äºé”**: ç”¨å­˜å‚¨ç©ºé—´æ¢å¹¶å‘æ€§èƒ½
2. **å»¶è¿Ÿæ¸…ç†**: åå°VACUUMå¼‚æ­¥æ¸…ç†
3. **åˆ†å±‚ä¼˜åŒ–**: HOT/Visibility Mapé’ˆå¯¹æ€§ä¼˜åŒ–

---

## åã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Bernstein, P. A., & Goodman, N. (1983). "Multiversion concurrency control" â†’ MVCCç†è®ºå¥ åŸº
- Ports, D. R., & Grittner, K. (2012). "Serializable Snapshot Isolation in PostgreSQL" â†’ SSIå®ç°

**å®ç°ç»†èŠ‚**:

- PostgreSQLæºç : `src/backend/access/heap/heapam_visibility.c`
- VACUUMæºç : `src/backend/commands/vacuum.c`
- HOTå®ç°: `src/backend/access/heap/pruneheap.c`

**æ‰©å±•æ–¹å‘**:

- `03-è¯æ˜ä¸å½¢å¼åŒ–/02-MVCCæ­£ç¡®æ€§è¯æ˜.md` â†’ å®Œæ•´çš„æ•°å­¦è¯æ˜
- `05-å®ç°æœºåˆ¶/01-PostgreSQL-MVCCå®ç°.md` â†’ æºç çº§åˆ†æ
- `06-æ€§èƒ½åˆ†æ/03-å­˜å‚¨å¼€é”€åˆ†æ.md` â†’ é‡åŒ–ç©ºé—´å¼€é”€

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 MVCCå¯è§æ€§æ£€æŸ¥å®Œæ•´å®ç°

```python
from dataclasses import dataclass
from typing import List, Set, Optional
import bisect

@dataclass
class Snapshot:
    """å¿«ç…§æ•°æ®ç»“æ„"""
    xmin: int  # æœ€å°æ´»è·ƒäº‹åŠ¡ID
    xmax: int  # æœ€å¤§å·²æäº¤äº‹åŠ¡ID + 1
    xip: List[int]  # æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨ï¼ˆæœ‰åºï¼‰

@dataclass
class Tuple:
    """å…ƒç»„ç‰ˆæœ¬"""
    xmin: int  # åˆ›å»ºäº‹åŠ¡ID
    xmax: int  # åˆ é™¤äº‹åŠ¡ID (0è¡¨ç¤ºæœªåˆ é™¤)
    data: str
    ctid: tuple  # (page, offset)

class CommitLog:
    """æäº¤æ—¥å¿—ï¼ˆpg_clogæ¨¡æ‹Ÿï¼‰"""
    def __init__(self):
        self.committed: Set[int] = set()
        self.aborted: Set[int] = set()

    def is_committed(self, xid: int) -> bool:
        return xid in self.committed

    def is_aborted(self, xid: int) -> bool:
        return xid in self.aborted

    def commit(self, xid: int):
        self.committed.add(xid)

    def abort(self, xid: int):
        self.aborted.add(xid)

class MVCCVisibilityChecker:
    """MVCCå¯è§æ€§æ£€æŸ¥å™¨"""

    def __init__(self, clog: CommitLog):
        self.clog = clog

    def is_visible(
        self,
        tuple: Tuple,
        snapshot: Snapshot,
        current_txid: int
    ) -> bool:
        """
        å®Œæ•´çš„å¯è§æ€§åˆ¤æ–­ç®—æ³•

        æ—¶é—´å¤æ‚åº¦: O(log |xip|) - äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨
        """
        # è§„åˆ™1: æœ¬äº‹åŠ¡åˆ›å»ºçš„ç‰ˆæœ¬
        if tuple.xmin == current_txid:
            if tuple.xmax == 0:
                return True  # æœªåˆ é™¤
            if tuple.xmax == current_txid:
                return False  # æœ¬äº‹åŠ¡å·²åˆ é™¤
            # åˆ é™¤äº‹åŠ¡æœªæäº¤
            if not self.clog.is_committed(tuple.xmax):
                return True
            return False  # åˆ é™¤äº‹åŠ¡å·²æäº¤

        # è§„åˆ™2: åˆ›å»ºäº‹åŠ¡æœªæäº¤æˆ–å·²å›æ»š
        if self.clog.is_aborted(tuple.xmin):
            return False
        if not self.clog.is_committed(tuple.xmin):
            return False

        # è§„åˆ™3: åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§åå¯åŠ¨
        if tuple.xmin >= snapshot.xmax:
            return False

        # è§„åˆ™4: åˆ›å»ºäº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰
        if self._in_active_list(tuple.xmin, snapshot.xip):
            return False

        # è§„åˆ™5: æ£€æŸ¥åˆ é™¤æ ‡è®°
        if tuple.xmax == 0:
            return True  # æœªåˆ é™¤

        if tuple.xmax == current_txid:
            return False  # æœ¬äº‹åŠ¡åˆ é™¤

        # åˆ é™¤äº‹åŠ¡æœªæäº¤
        if not self.clog.is_committed(tuple.xmax):
            return True

        # åˆ é™¤äº‹åŠ¡åœ¨å¿«ç…§å
        if tuple.xmax >= snapshot.xmax:
            return True

        # åˆ é™¤äº‹åŠ¡åœ¨æ´»è·ƒåˆ—è¡¨
        if self._in_active_list(tuple.xmax, snapshot.xip):
            return True

        # æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ â†’ å·²åˆ é™¤
        return False

    def _in_active_list(self, xid: int, xip: List[int]) -> bool:
        """äºŒåˆ†æŸ¥æ‰¾æ´»è·ƒåˆ—è¡¨ï¼ˆO(log n)ï¼‰"""
        return bisect.bisect_left(xip, xid) < len(xip) and xip[bisect.bisect_left(xip, xid)] == xid

# ä½¿ç”¨ç¤ºä¾‹
clog = CommitLog()
clog.commit(100)
clog.commit(105)

checker = MVCCVisibilityChecker(clog)

# åˆ›å»ºå¿«ç…§
snapshot = Snapshot(xmin=100, xmax=110, xip=[102, 105, 108])

# æµ‹è¯•å…ƒç»„
tuple1 = Tuple(xmin=100, xmax=0, data="Alice", ctid=(1, 5))
tuple2 = Tuple(xmin=102, xmax=0, data="Bob", ctid=(1, 6))
tuple3 = Tuple(xmin=105, xmax=108, data="Charlie", ctid=(1, 7))

# æ£€æŸ¥å¯è§æ€§
print(checker.is_visible(tuple1, snapshot, 109))  # True (100å·²æäº¤ï¼Œä¸åœ¨xip)
print(checker.is_visible(tuple2, snapshot, 109))  # False (102åœ¨xipä¸­)
print(checker.is_visible(tuple3, snapshot, 109))  # False (105åœ¨xipä¸­ï¼Œä¸”è¢«108åˆ é™¤)
```

### 11.2 ç‰ˆæœ¬é“¾éå†å®ç°

```python
class VersionChain:
    """ç‰ˆæœ¬é“¾ç®¡ç†å™¨"""

    def __init__(self):
        self.versions: List[Tuple] = []  # æŒ‰xminæ’åº

    def add_version(self, tuple: Tuple):
        """æ·»åŠ æ–°ç‰ˆæœ¬ï¼ˆæ’å…¥æ’åºï¼‰"""
        # æŒ‰xminæ’å…¥åˆ°æ­£ç¡®ä½ç½®
        idx = bisect.bisect_left([v.xmin for v in self.versions], tuple.xmin)
        self.versions.insert(idx, tuple)

    def find_visible_version(
        self,
        snapshot: Snapshot,
        current_txid: int,
        checker: MVCCVisibilityChecker
    ) -> Optional[Tuple]:
        """æŸ¥æ‰¾å¯¹å½“å‰å¿«ç…§å¯è§çš„ç‰ˆæœ¬ï¼ˆä»æ–°åˆ°æ—§ï¼‰"""
        # ä»æœ€æ–°ç‰ˆæœ¬å¼€å§‹éå†
        for version in reversed(self.versions):
            if checker.is_visible(version, snapshot, current_txid):
                return version
        return None

    def get_all_versions(self) -> List[Tuple]:
        """è·å–æ‰€æœ‰ç‰ˆæœ¬ï¼ˆç”¨äºè°ƒè¯•ï¼‰"""
        return self.versions.copy()

# ä½¿ç”¨ç¤ºä¾‹
chain = VersionChain()
chain.add_version(Tuple(xmin=100, xmax=0, data="v1", ctid=(1, 5)))
chain.add_version(Tuple(xmin=105, xmax=0, data="v2", ctid=(1, 6)))
chain.add_version(Tuple(xmin=110, xmax=0, data="v3", ctid=(1, 7)))

clog = CommitLog()
clog.commit(100)
clog.commit(105)
clog.commit(110)

checker = MVCCVisibilityChecker(clog)
snapshot = Snapshot(xmin=100, xmax=115, xip=[108, 112])

visible = chain.find_visible_version(snapshot, 114, checker)
print(f"Visible version: {visible.data if visible else None}")  # v3
```

### 11.3 HOTé“¾éå†å®ç°

```python
class HOTChain:
    """HOTé“¾ç®¡ç†å™¨"""

    def __init__(self):
        self.head: Optional[Tuple] = None  # ç´¢å¼•æŒ‡å‘çš„ç‰ˆæœ¬
        self.chain: List[Tuple] = []  # HOTé“¾ï¼ˆé€šè¿‡ctidè¿æ¥ï¼‰

    def add_hot_version(self, old_version: Tuple, new_version: Tuple):
        """æ·»åŠ HOTç‰ˆæœ¬"""
        # æ›´æ–°æ—§ç‰ˆæœ¬çš„ctidæŒ‡å‘æ–°ç‰ˆæœ¬
        old_version.ctid = new_version.ctid

        # æ·»åŠ åˆ°é“¾
        self.chain.append(new_version)

    def traverse_hot_chain(
        self,
        start_ctid: tuple,
        snapshot: Snapshot,
        current_txid: int,
        checker: MVCCVisibilityChecker
    ) -> Optional[Tuple]:
        """éå†HOTé“¾æŸ¥æ‰¾å¯è§ç‰ˆæœ¬"""
        current = self.head
        if current.ctid != start_ctid:
            # æ‰¾åˆ°èµ·å§‹ç‰ˆæœ¬
            for version in self.chain:
                if version.ctid == start_ctid:
                    current = version
                    break

        # æ²¿HOTé“¾éå†
        while current:
            if checker.is_visible(current, snapshot, current_txid):
                return current

            # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼ˆé€šè¿‡ctidï¼‰
            next_ctid = current.ctid
            current = self._find_by_ctid(next_ctid)

        return None

    def _find_by_ctid(self, ctid: tuple) -> Optional[Tuple]:
        """æ ¹æ®ctidæŸ¥æ‰¾ç‰ˆæœ¬"""
        for version in self.chain:
            if version.ctid == ctid:
                return version
        return None
```

### 11.4 å¿«ç…§åˆ›å»ºå®ç°

```python
class SnapshotManager:
    """å¿«ç…§ç®¡ç†å™¨"""

    def __init__(self, clog: CommitLog):
        self.clog = clog
        self.active_transactions: Set[int] = set()
        self.next_xid = 1

    def get_current_snapshot(self, isolation_level: str) -> Snapshot:
        """è·å–å½“å‰å¿«ç…§"""
        if not self.active_transactions:
            xmin = self.next_xid
        else:
            xmin = min(self.active_transactions)

        xmax = self.next_xid
        xip = sorted(list(self.active_transactions))

        return Snapshot(xmin=xmin, xmax=xmax, xip=xip)

    def begin_transaction(self, isolation_level: str) -> tuple:
        """å¼€å¯äº‹åŠ¡"""
        txid = self.next_xid
        self.next_xid += 1
        self.active_transactions.add(txid)

        snapshot = self.get_current_snapshot(isolation_level)

        return txid, snapshot

    def commit_transaction(self, txid: int):
        """æäº¤äº‹åŠ¡"""
        self.active_transactions.remove(txid)
        self.clog.commit(txid)

    def abort_transaction(self, txid: int):
        """ä¸­æ­¢äº‹åŠ¡"""
        self.active_transactions.remove(txid)
        self.clog.abort(txid)

# ä½¿ç”¨ç¤ºä¾‹
clog = CommitLog()
snapshot_mgr = SnapshotManager(clog)

# äº‹åŠ¡1å¼€å§‹
tx1, snap1 = snapshot_mgr.begin_transaction('REPEATABLE_READ')
print(f"Tx1 snapshot: {snap1}")  # xmin=1, xmax=2, xip=[1]

# äº‹åŠ¡2å¼€å§‹
tx2, snap2 = snapshot_mgr.begin_transaction('REPEATABLE_READ')
print(f"Tx2 snapshot: {snap2}")  # xmin=1, xmax=3, xip=[1,2]

# äº‹åŠ¡1æäº¤
snapshot_mgr.commit_transaction(tx1)
print(f"Active: {snapshot_mgr.active_transactions}")  # {2}
```

---

## åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 12.1 æ¡ˆä¾‹: é«˜å¹¶å‘è¯»å¤šå†™å°‘åœºæ™¯

**åœºæ™¯**: æ–°é—»ç½‘ç«™æ–‡ç« é˜…è¯»ï¼ˆè¯»å¤šå†™å°‘ï¼‰

**éœ€æ±‚**:

- è¯»æ“ä½œ: 100,000 QPS
- å†™æ“ä½œ: 1,000 TPS
- ä¸€è‡´æ€§: æœ€ç»ˆä¸€è‡´å¯æ¥å—

**MVCCä¼˜åŠ¿**:

```sql
-- è¯»æ“ä½œæ— éœ€åŠ é”
SELECT * FROM articles WHERE id = 123;
-- å†…éƒ¨: å¿«ç…§è¯»å–ï¼Œæ— é”ï¼Œé«˜å¹¶å‘

-- å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬
UPDATE articles SET view_count = view_count + 1 WHERE id = 123;
-- å†…éƒ¨: åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸å½±å“æ­£åœ¨è¯»å–çš„äº‹åŠ¡
```

**æ€§èƒ½æ•°æ®**:

| æ–¹æ¡ˆ | è¯»TPS | å†™TPS | é”ç­‰å¾… |
|-----|------|------|--------|
| **2PL** | 10,000 | 1,000 | é«˜ |
| **MVCC** | **100,000** | 1,000 | **ä½** |

**æå‡**: è¯»æ€§èƒ½æå‡10Ã—

### 12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡æŠ¥è¡¨ç”Ÿæˆ

**åœºæ™¯**: ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥è¡¨ï¼ˆéœ€è¦ä¸€è‡´å¿«ç…§ï¼‰

**éœ€æ±‚**:

- äº‹åŠ¡æ—¶é•¿: 5-10åˆ†é’Ÿ
- æ•°æ®ä¸€è‡´æ€§: å¿…é¡»ä¸€è‡´
- å¹¶å‘: ä½

**MVCCå®ç°**:

```sql
-- ä½¿ç”¨Repeatable Readçº§åˆ«
BEGIN ISOLATION LEVEL REPEATABLE READ;

-- åˆ›å»ºå¿«ç…§ï¼ˆå›ºå®šï¼‰
-- Snapshot: xmin=100, xmax=200, xip=[105, 110, 115]

-- æŸ¥è¯¢1: æœŸåˆä½™é¢
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-01';

-- æŸ¥è¯¢2: æœŸæœ«ä½™é¢ï¼ˆ5åˆ†é’Ÿåï¼‰
SELECT SUM(balance) FROM accounts WHERE date < '2025-12-31';

-- æŸ¥è¯¢3: äº¤æ˜“æ˜ç»†
SELECT * FROM transactions WHERE date BETWEEN '2025-12-01' AND '2025-12-31';

-- æ‰€æœ‰æŸ¥è¯¢çœ‹åˆ°åŒä¸€å¿«ç…§ï¼Œæ•°æ®ä¸€è‡´
COMMIT;
```

**ä¼˜åŠ¿**: å³ä½¿å…¶ä»–äº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®ï¼ŒæŠ¥è¡¨å§‹ç»ˆçœ‹åˆ°ä¸€è‡´çš„å¿«ç…§

### 12.3 æ¡ˆä¾‹: çƒ­ç‚¹è¡Œæ›´æ–°ä¼˜åŒ–

**åœºæ™¯**: è®¡æ•°å™¨é«˜å¹¶å‘æ›´æ–°

**é—®é¢˜**: åŒä¸€è¡Œè¢«å¤§é‡äº‹åŠ¡æ›´æ–°ï¼Œç‰ˆæœ¬é“¾å˜é•¿

**åˆå§‹æ–¹æ¡ˆ**:

```sql
-- ç®€å•UPDATE
UPDATE counters SET count = count + 1 WHERE id = 1;
-- é—®é¢˜: ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿ï¼Œå¯è§æ€§æ£€æŸ¥å˜æ…¢
```

**ä¼˜åŒ–æ–¹æ¡ˆ1: è¡Œåˆ†æ•£**:

```sql
-- é¢„åˆ†é…10è¡Œ
CREATE TABLE counters (
    id INT,
    shard_id INT,  -- 0-9
    count INT,
    PRIMARY KEY (id, shard_id)
);

-- éšæœºé€‰æ‹©åˆ†ç‰‡
UPDATE counters
SET count = count + 1
WHERE id = 1 AND shard_id = floor(random() * 10)::int;

-- æŸ¥è¯¢æ—¶èšåˆ
SELECT SUM(count) FROM counters WHERE id = 1;
```

**ä¼˜åŒ–æ–¹æ¡ˆ2: ä¹è§‚é”**:

```sql
-- ä½¿ç”¨ç‰ˆæœ¬å·
CREATE TABLE counters (
    id INT PRIMARY KEY,
    count INT,
    version INT
);

-- åº”ç”¨å±‚é‡è¯•
UPDATE counters
SET count = count + 1, version = version + 1
WHERE id = 1 AND version = $current_version;
```

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | TPS | ç‰ˆæœ¬é“¾é•¿åº¦ | å¯è§æ€§æ£€æŸ¥æ—¶é—´ |
|-----|-----|----------|-------------|
| **ç®€å•UPDATE** | 1,000 | 1000+ | 10ms |
| **è¡Œåˆ†æ•£** | **10,000** | 100 | **1ms** |
| **ä¹è§‚é”** | **8,000** | 1 | **0.1ms** |

---

## åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾çˆ†ç‚¸

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: é•¿äº‹åŠ¡ + é«˜é¢‘æ›´æ–°
def long_running_report():
    tx = db.begin_transaction()

    # è¿è¡Œ10åˆ†é’Ÿ
    for i in range(600):
        time.sleep(1)
        # æ¯ç§’æ›´æ–°ä¸€æ¬¡è®¡æ•°å™¨
        tx.execute("UPDATE counters SET count = count + 1 WHERE id = 1")

    tx.commit()
```

**é—®é¢˜**:

- ç‰ˆæœ¬é“¾é•¿åº¦: 600ä¸ªç‰ˆæœ¬
- å¯è§æ€§æ£€æŸ¥: O(600) = æ…¢
- VACUUMæ— æ³•æ¸…ç†ï¼ˆäº‹åŠ¡æœªæäº¤ï¼‰

**æ­£ç¡®è®¾è®¡**:

```python
# æ­£ç¡®: æ‹†åˆ†äº‹åŠ¡
def optimized_report():
    # åªè¯»äº‹åŠ¡ï¼ˆå¿«ç…§è¯»å–ï¼‰
    tx = db.begin_transaction(isolation='REPEATABLE_READ')
    data = tx.execute("SELECT * FROM counters")
    tx.commit()

    # æ›´æ–°æ“ä½œä½¿ç”¨çŸ­äº‹åŠ¡
    for i in range(600):
        time.sleep(1)
        short_tx = db.begin_transaction()
        short_tx.execute("UPDATE counters SET count = count + 1 WHERE id = 1")
        short_tx.commit()  # ç«‹å³æäº¤ï¼Œç‰ˆæœ¬é“¾çŸ­
```

### åä¾‹2: å¿½ç•¥HOTä¼˜åŒ–æ¡ä»¶

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: æ›´æ–°ç´¢å¼•åˆ—ï¼Œæ— æ³•ä½¿ç”¨HOT
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100)  -- æœ‰ç´¢å¼•
);

-- æ›´æ–°ç´¢å¼•åˆ—
UPDATE users SET email = 'new@example.com' WHERE id = 1;
-- é—®é¢˜: å¿…é¡»æ›´æ–°ç´¢å¼•ï¼Œæ— æ³•ä½¿ç”¨HOTï¼Œç´¢å¼•è†¨èƒ€
```

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: åˆ†ç¦»ç´¢å¼•åˆ—å’Œéç´¢å¼•åˆ—
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),  -- æ— ç´¢å¼•
    email VARCHAR(100)  -- æœ‰ç´¢å¼•
);

-- åªæ›´æ–°éç´¢å¼•åˆ—ï¼ˆå¯ä½¿ç”¨HOTï¼‰
UPDATE users SET name = 'New Name' WHERE id = 1;
-- ä¼˜åŠ¿: HOTä¼˜åŒ–ï¼Œç´¢å¼•ä¸æ›´æ–°

-- æˆ–ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
-- åªå¯¹éç©ºemailå»ºç´¢å¼•ï¼Œå‡å°‘ç´¢å¼•å¤§å°
```

### åä¾‹3: è¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯

**é”™è¯¯è®¾è®¡**: é«˜å†²çªå†™åœºæ™¯ä½¿ç”¨MVCC

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: è®¡æ•°å™¨ç³»ç»Ÿï¼Œ1000ä¸ªäº‹åŠ¡/ç§’æ›´æ–°åŒä¸€è¡Œ
â”œâ”€ æ–¹æ¡ˆ: ä½¿ç”¨MVCC
â”œâ”€ é—®é¢˜: æ¯æ¬¡æ›´æ–°åˆ›å»ºæ–°ç‰ˆæœ¬
â””â”€ ç»“æœ: ç‰ˆæœ¬é“¾çˆ†ç‚¸ï¼Œæ€§èƒ½æå·® âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: çƒ­é—¨å•†å“åº“å­˜ç³»ç»Ÿ
â”œâ”€ åœºæ™¯: 1000å¹¶å‘ç”¨æˆ·æŠ¢è´­
â”œâ”€ é—®é¢˜: MVCCç‰ˆæœ¬é“¾é•¿åº¦ > 1000
â”œâ”€ æ€§èƒ½: å¯è§æ€§æ£€æŸ¥O(1000)ï¼ŒTPSé™åˆ°100
â””â”€ åæœ: ç³»ç»Ÿæ— æ³•å“åº” âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ1: ä½¿ç”¨2PLï¼ˆæ’ä»–é”ï¼‰
â”œâ”€ æ–¹æ¡ˆ2: ä½¿ç”¨åŸå­æ“ä½œï¼ˆAtomicï¼‰
â””â”€ ç»“æœ: é¿å…ç‰ˆæœ¬é“¾çˆ†ç‚¸ âœ“
```

### åä¾‹4: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€

**é”™è¯¯è®¾è®¡**: ä¸é…ç½®VACUUMæˆ–é…ç½®ä¸å½“

```sql
-- é”™è¯¯: ç¦ç”¨AutoVacuum
ALTER TABLE orders SET (autovacuum_enabled = false);

-- é—®é¢˜: æ­»å…ƒç»„æ— æ³•æ¸…ç†
-- ç»“æœ: è¡¨å¤§å°ä»10GBè†¨èƒ€åˆ°100GB âœ—
```

**é—®é¢˜**: å­˜å‚¨ç©ºé—´æµªè´¹ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ è¡¨: ordersè¡¨ï¼Œæ¯å¤©100ä¸‡è®¢å•
â”œâ”€ æ›´æ–°: æ¯å¤©50ä¸‡è®¢å•çŠ¶æ€æ›´æ–°
â”œâ”€ é—®é¢˜: æœªé…ç½®VACUUM
â”œâ”€ ç»“æœ: æ­»å…ƒç»„ç´¯ç§¯ï¼Œè¡¨è†¨èƒ€10å€
â””â”€ æ€§èƒ½: æŸ¥è¯¢æ‰«ææ­»å…ƒç»„ï¼Œæ€§èƒ½ä¸‹é™90% âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ é…ç½®: å¯ç”¨AutoVacuum
â”œâ”€ å‚æ•°: autovacuum_vacuum_scale_factor = 0.1
â””â”€ ç»“æœ: å®šæœŸæ¸…ç†ï¼Œè¡¨å¤§å°ç¨³å®š âœ“
```

### åä¾‹5: å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥

**é”™è¯¯è®¾è®¡**: é¢‘ç¹åˆ›å»ºå¿«ç…§

```python
# é”™è¯¯: æ¯ä¸ªæŸ¥è¯¢éƒ½åˆ›å»ºæ–°å¿«ç…§
def query_data():
    for i in range(1000):
        snapshot = create_snapshot()  # å¼€é”€å¤§
        data = read_with_snapshot(snapshot)
```

**é—®é¢˜**: å¿«ç…§åˆ›å»ºéœ€è¦æ‰«ææ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œå¼€é”€å¤§

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: é«˜å¹¶å‘æŸ¥è¯¢ï¼Œ1000 QPS
â”œâ”€ é—®é¢˜: æ¯ä¸ªæŸ¥è¯¢åˆ›å»ºæ–°å¿«ç…§
â”œâ”€ å¼€é”€: å¿«ç…§åˆ›å»ºéœ€è¦O(n)æ‰«ææ´»è·ƒäº‹åŠ¡
â””â”€ ç»“æœ: CPUå ç”¨é«˜ï¼Œæ€§èƒ½ä¸‹é™ âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ: äº‹åŠ¡çº§å¿«ç…§ï¼ˆä¸€ä¸ªäº‹åŠ¡ä¸€ä¸ªå¿«ç…§ï¼‰
â”œâ”€ ä¼˜åŒ–: å¿«ç…§å¤ç”¨
â””â”€ ç»“æœ: å¿«ç…§åˆ›å»ºå¼€é”€é™ä½ âœ“
```

### åä¾‹6: ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜

**é”™è¯¯è®¾è®¡**: é•¿ç‰ˆæœ¬é“¾å¯¼è‡´éå†æ€§èƒ½å·®

```text
é”™è¯¯åœºæ™¯:
â”œâ”€ åœºæ™¯: çƒ­ç‚¹è¡Œï¼Œ1000æ¬¡æ›´æ–°
â”œâ”€ é—®é¢˜: ç‰ˆæœ¬é“¾é•¿åº¦ = 1000
â”œâ”€ å¯è§æ€§æ£€æŸ¥: éœ€è¦éå†1000ä¸ªç‰ˆæœ¬
â””â”€ æ€§èƒ½: å•æ¬¡æŸ¥è¯¢å»¶è¿Ÿ > 100ms âœ—

å®é™…æ¡ˆä¾‹:
â”œâ”€ ç³»ç»Ÿ: ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿ
â”œâ”€ åœºæ™¯: çƒ­é—¨ç”¨æˆ·ï¼Œæ¯å¤©1000æ¬¡ç§¯åˆ†æ›´æ–°
â”œâ”€ é—®é¢˜: ç‰ˆæœ¬é“¾é•¿åº¦ > 1000
â”œâ”€ æŸ¥è¯¢: è¯»å–ç”¨æˆ·ç§¯åˆ†éœ€è¦éå†1000ä¸ªç‰ˆæœ¬
â””â”€ ç»“æœ: æŸ¥è¯¢å»¶è¿Ÿä¸å¯æ¥å— âœ—

æ­£ç¡®è®¾è®¡:
â”œâ”€ æ–¹æ¡ˆ1: å®šæœŸVACUUMæ¸…ç†æ—§ç‰ˆæœ¬
â”œâ”€ æ–¹æ¡ˆ2: ä½¿ç”¨HOTä¼˜åŒ–ï¼ˆå‡å°‘ç‰ˆæœ¬é“¾ï¼‰
â””â”€ ç»“æœ: ç‰ˆæœ¬é“¾é•¿åº¦ < 10ï¼Œæ€§èƒ½æ­£å¸¸ âœ“
```

---

## åå››ã€MVCCç†è®ºå¯è§†åŒ–

### 14.1 MVCCæ¶æ„è®¾è®¡å›¾

**å®Œæ•´MVCCæ¶æ„** (Mermaid):

```mermaid
graph TB
    subgraph "äº‹åŠ¡å±‚"
        T1[äº‹åŠ¡T1<br/>xid=100]
        T2[äº‹åŠ¡T2<br/>xid=101]
        T3[äº‹åŠ¡T3<br/>xid=102]
    end

    subgraph "å¿«ç…§å±‚"
        S1[å¿«ç…§1<br/>xmin=100<br/>xmax=102<br/>xip=[]]
        S2[å¿«ç…§2<br/>xmin=101<br/>xmax=103<br/>xip=[]]
    end

    subgraph "ç‰ˆæœ¬é“¾å±‚"
        V1[ç‰ˆæœ¬1<br/>xmin=100<br/>xmax=101]
        V2[ç‰ˆæœ¬2<br/>xmin=101<br/>xmax=102]
        V3[ç‰ˆæœ¬3<br/>xmin=102<br/>xmax=NULL]
    end

    subgraph "å­˜å‚¨å±‚"
        HEAP[å †è¡¨<br/>Heap]
        INDEX[ç´¢å¼•<br/>Index]
    end

    T1 --> S1
    T2 --> S2
    T3 --> S2

    S1 --> V1
    S2 --> V2
    S2 --> V3

    V1 --> HEAP
    V2 --> HEAP
    V3 --> HEAP

    V1 --> INDEX
    V2 --> INDEX
    V3 --> INDEX
```

**MVCCæ•°æ®æµæ¶æ„**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: äº‹åŠ¡å±‚                              â”‚
â”‚  äº‹åŠ¡T1, T2, T3                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ åˆ›å»ºå¿«ç…§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: å¿«ç…§å±‚                              â”‚
â”‚  å¿«ç…§1 (xmin=100, xmax=102)              â”‚
â”‚  å¿«ç…§2 (xmin=101, xmax=103)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â”‚ å¯è§æ€§æ£€æŸ¥         â”‚ ç‰ˆæœ¬é“¾éå†
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: ç‰ˆæœ¬é“¾å±‚â”‚  â”‚  L1: ç‰ˆæœ¬é“¾å±‚    â”‚
â”‚  ç‰ˆæœ¬1       â”‚  â”‚  ç‰ˆæœ¬2           â”‚
â”‚  ç‰ˆæœ¬2       â”‚  â”‚  ç‰ˆæœ¬3           â”‚
â”‚  ç‰ˆæœ¬3       â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ•°æ®è®¿é—®
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: å­˜å‚¨å±‚  â”‚
â”‚  å †è¡¨        â”‚
â”‚  ç´¢å¼•        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾

**MVCCç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹** (Mermaid):

```mermaid
flowchart TD
    START([äº‹åŠ¡å¼€å§‹]) --> GET_SNAP[è·å–å¿«ç…§<br/>xmin, xmax, xip]
    GET_SNAP --> READ{è¯»å–æ“ä½œ?}

    READ -->|æ˜¯| CHECK_VIS[æ£€æŸ¥ç‰ˆæœ¬å¯è§æ€§]
    CHECK_VIS --> FIND_VER[æŸ¥æ‰¾å¯è§ç‰ˆæœ¬]
    FIND_VER --> RETURN[è¿”å›æ•°æ®]

    READ -->|å¦| WRITE{å†™å…¥æ“ä½œ?}

    WRITE -->|æ˜¯| CREATE_VER[åˆ›å»ºæ–°ç‰ˆæœ¬<br/>xmin=å½“å‰xid]
    CREATE_VER --> SET_XMAX[è®¾ç½®æ—§ç‰ˆæœ¬xmax<br/>xmax=å½“å‰xid]
    SET_XMAX --> LINK[é“¾æ¥åˆ°ç‰ˆæœ¬é“¾]
    LINK --> COMMIT{æäº¤?}

    COMMIT -->|æ˜¯| UPDATE_XMAX[æ›´æ–°xmaxä¸ºNULL]
    UPDATE_XMAX --> VACUUM[VACUUMæ¸…ç†]

    COMMIT -->|å¦| ABORT[å›æ»š]
    ABORT --> REMOVE[ç§»é™¤ç‰ˆæœ¬]

    RETURN --> CONTINUE{ç»§ç»­?}
    CONTINUE -->|æ˜¯| READ
    CONTINUE -->|å¦| END([äº‹åŠ¡ç»“æŸ])

    VACUUM --> END
    REMOVE --> END
```

**ç‰ˆæœ¬é“¾æ¼”åŒ–ç¤ºä¾‹**:

```text
åˆå§‹çŠ¶æ€:
  row1: v1 (xmin=100, xmax=NULL)

T2 (xid=101) UPDATE:
  row1: v1 (xmin=100, xmax=101) â† æ—§ç‰ˆæœ¬
         â†“ ctid
        v2 (xmin=101, xmax=NULL) â† æ–°ç‰ˆæœ¬

T3 (xid=102) UPDATE:
  row1: v1 (xmin=100, xmax=101)
         â†“ ctid
        v2 (xmin=101, xmax=102)
         â†“ ctid
        v3 (xmin=102, xmax=NULL) â† æœ€æ–°ç‰ˆæœ¬

T2 COMMIT:
  row1: v1 (xmin=100, xmax=101)
         â†“ ctid
        v2 (xmin=101, xmax=102) â† xmaxæ›´æ–°
         â†“ ctid
        v3 (xmin=102, xmax=NULL)
```

### 14.3 MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µ

**å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”çŸ©é˜µ**:

| æœºåˆ¶ | è¯»æ“ä½œ | å†™æ“ä½œ | å†²çªå¤„ç† | éš”ç¦»çº§åˆ« | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|-----|-------|-------|---------|---------|------|---------|
| **MVCC** | å¿«ç…§è¯» | ç‰ˆæœ¬å†™ | ç‰ˆæœ¬éš”ç¦» | å¿«ç…§éš”ç¦»/å¯åºåˆ—åŒ– | é«˜ | è¯»å¤šå†™å°‘ |
| **2PL** | å…±äº«é” | æ’ä»–é” | é”é¢„é˜² | å¯åºåˆ—åŒ– | ä¸­ | é«˜å†²çª |
| **OCC** | æ— é”è¯» | éªŒè¯å†™ | å†²çªæ£€æµ‹ | å¯åºåˆ—åŒ– | é«˜ (ä½å†²çª) | ä½å†²çª |
| **æ—¶é—´æˆ³æ’åº** | æ—¶é—´æˆ³ | æ—¶é—´æˆ³ | æ—¶é—´æˆ³æ£€æµ‹ | å¯åºåˆ—åŒ– | ä¸­ | ä¸­ç­‰å†²çª |

**MVCCå®ç°å¯¹æ¯”çŸ©é˜µ**:

| ç³»ç»Ÿ | ç‰ˆæœ¬å­˜å‚¨ | å¿«ç…§æœºåˆ¶ | éš”ç¦»çº§åˆ« | æ€§èƒ½ | ç‰¹ç‚¹ |
|-----|---------|---------|---------|------|------|
| **PostgreSQL** | å †è¡¨ç‰ˆæœ¬é“¾ | äº‹åŠ¡å¿«ç…§ | SI/SSI | é«˜ | å®Œæ•´MVCC |
| **MySQL InnoDB** | å›æ»šæ®µ | ReadView | RC/RR | é«˜ | ç®€åŒ–MVCC |
| **Oracle** | å›æ»šæ®µ | SCNå¿«ç…§ | SI | é«˜ | ä¼ä¸šçº§ |
| **SQL Server** | TempDBç‰ˆæœ¬å­˜å‚¨ | è¡Œç‰ˆæœ¬ | SI | ä¸­ | æ··åˆæ–¹æ¡ˆ |

**MVCCéš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ**:

| éš”ç¦»çº§åˆ« | å¿«ç…§æœºåˆ¶ | å†²çªæ£€æµ‹ | å†™åæ–œæ£€æµ‹ | æ€§èƒ½ | ä¸€è‡´æ€§ |
|---------|---------|---------|-----------|------|--------|
| **Read Committed** | è¯­å¥çº§å¿«ç…§ | å†™å†™å†²çª | å¦ | æœ€é«˜ | å¼± |
| **Repeatable Read** | äº‹åŠ¡çº§å¿«ç…§ | å†™å†™å†²çª | å¦ | é«˜ | ä¸­ |
| **Serializable (SSI)** | äº‹åŠ¡çº§å¿«ç…§ | å†™å†™å†²çª | æ˜¯ | ä¸­ | å¼º |

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´Pythonå®ç°ã€ç‰ˆæœ¬é“¾éå†ã€HOTé“¾ã€å¿«ç…§ç®¡ç†ã€å®é™…æ¡ˆä¾‹ã€åä¾‹åˆ†æã€MVCCç†è®ºå¯è§†åŒ–ï¼ˆMVCCæ¶æ„è®¾è®¡å›¾ã€ç‰ˆæœ¬é“¾æ¼”åŒ–æµç¨‹å›¾ã€MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶å¯¹æ¯”çŸ©é˜µï¼‰ã€MVCCç†è®ºèƒŒæ™¯çŸ¥è¯†è¡¥å……ï¼ˆä¸ºä»€ä¹ˆéœ€è¦MVCCã€å†å²èƒŒæ™¯ã€ç†è®ºåŸºç¡€ã€å®é™…åº”ç”¨èƒŒæ™¯ï¼‰ã€MVCCåä¾‹è¡¥å……ï¼ˆ6ä¸ªæ–°å¢åä¾‹ï¼šè¯¯ç”¨MVCCå¤„ç†é«˜å†²çªå†™åœºæ™¯ã€å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨è†¨èƒ€ã€å¿«ç…§åˆ›å»ºå¼€é”€è¢«å¿½ç•¥ã€ç‰ˆæœ¬é“¾éå†æ€§èƒ½é—®é¢˜ï¼‰

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/01-åˆ†å±‚çŠ¶æ€æ¼”åŒ–æ¨¡å‹(LSEM).md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/02-éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ.md`
- `05-å®ç°æœºåˆ¶/01-PostgreSQL-MVCCå®ç°.md`
