# 01 | 核心理论模型

> **模块定位**: 本模块提供事务与并发设计的核心理论基础，包括LSEM统一框架、MVCC、ACID、CAP等关键理论的形式化定义和证明。

---

## 📚 文档目录

### ⭐ 已完成文档

#### [01-分层状态演化模型(LSEM).md](./01-分层状态演化模型(LSEM).md)

**核心创新**: 统一L0/L1/L2三层并发控制框架

**核心内容**:

- 形式化定义状态空间、时空戳系统、可见性谓词
- 三大公理体系（状态原子性、可见性偏序、冲突可串行化）
- L0存储层、L1运行时层、L2分布式层详解
- 跨层映射关系证明（定理4.1: 层间同构）

**关键公式**:

$$LSEM = (Layers, States, Timestamps, Visibility, Conflict)$$

**阅读时长**: 30-45分钟

---

#### [02-MVCC理论完整解析.md](./02-MVCC理论完整解析.md)

**核心贡献**: PostgreSQL MVCC的完整数学证明

**核心内容**:

- 可见性判断算法（算法2.1）及其正确性证明（定理2.1）
- 版本链演化（INSERT/UPDATE/DELETE/VACUUM）
- 隔离级别实现（RC/RR/Serializable SSI）
- 时空复杂度分析
- HOT优化、Visibility Map等工程技术

**关键定理**:

$$Visible(v, snap) \iff (v.xmin < snap.xmax \land v.xmin \notin snap.xip) \land$$
$$(v.xmax = 0 \lor v.xmax \geq snap.xmax \lor v.xmax \in snap.xip)$$

**阅读时长**: 45-60分钟

---

#### [03-ACID理论与实现.md](./03-ACID理论与实现.md)

**核心贡献**: 从理论到PostgreSQL实现的完整链路

**核心内容**:

- ACID四大特性形式化定义
- WAL机制保证原子性和持久性
- 约束系统保证一致性（主键、外键、CHECK、触发器）
- MVCC+锁保证隔离性
- Checkpoint机制和ARIES恢复算法
- ACID正确性证明（定理7.1）

**关键公式**:

$$ACID = Atomicity \land Consistency \land Isolation \land Durability \implies Correctness$$

**阅读时长**: 40-50分钟

---

#### [04-CAP理论与权衡.md](./04-CAP理论与权衡.md)

**核心贡献**: CAP定理证明及分布式系统设计指南

**核心内容**:

- CAP不可能定理形式化证明（定理2.1）
- CP系统设计（PostgreSQL同步复制、Raft、ZooKeeper）
- AP系统设计（Cassandra、DynamoDB、CRDT）
- PACELC扩展理论
- PostgreSQL的CAP定位（单机CA、同步CP、异步AP）
- 设计决策矩阵和流程

**关键洞察**:

$$\text{分布式系统} \implies P \text{ 必须} \implies \text{选择}: CP \text{ or } AP$$

**阅读时长**: 40-55分钟

---

### 📋 待创建文档

#### [05-并发控制理论.md](./05-并发控制理论.md)

**计划内容**:

- 并发控制分类（乐观、悲观、MVCC）
- 2PL（两阶段锁）理论
- OCC（乐观并发控制）理论
- MVCC vs 2PL vs OCC对比
- 冲突图与依赖图分析

**优先级**: P1
**预计完成**: 2025-02

---

#### [06-所有权模型(Rust).md](./06-所有权模型(Rust).md)

**计划内容**:

- 所有权三大规则
- 借用检查器算法
- 生命周期推导
- Send/Sync trait形式化
- 与LSEM L1层的映射关系

**优先级**: P1
**预计完成**: 2025-03

---

#### [07-内存模型与排序.md](./07-内存模型与排序.md)

**计划内容**:

- happens-before关系
- 内存排序（Relaxed、Acquire/Release、SeqCst）
- C++内存模型对比
- 原子操作语义
- 跨线程同步证明

**优先级**: P1
**预计完成**: 2025-03

---

#### [08-共识协议理论.md](./08-共识协议理论.md)

**计划内容**:

- Paxos协议详解
- Raft协议详解
- FLP不可能定理
- 拜占庭容错（PBFT）
- 与LSEM L2层的映射

**优先级**: P1
**预计完成**: 2025-03

---

## 🔗 学习路径

### 路径1: 从零开始（初学者）

```
01-LSEM模型 (理解整体框架)
    ↓
02-MVCC理论 (深入L0存储层)
    ↓
03-ACID理论 (理解事务保证)
    ↓
04-CAP理论 (扩展到分布式)
```

**预计学习时间**: 3-4天

### 路径2: 数据库专家

```
02-MVCC理论 (核心机制)
    ↓
03-ACID理论 (实现细节)
    ↓
01-LSEM模型 (统一框架)
    ↓
05-并发控制理论 (深入对比)
```

**预计学习时间**: 2-3天

### 路径3: 分布式系统专家

```
04-CAP理论 (分布式基础)
    ↓
08-共识协议理论 (一致性实现)
    ↓
01-LSEM模型 (跨层统一)
    ↓
02-MVCC理论 (单机实现)
```

**预计学习时间**: 2-3天

### 路径4: Rust开发者

```
06-所有权模型 (Rust并发)
    ↓
07-内存模型与排序 (底层原理)
    ↓
01-LSEM模型 (L1层映射)
    ↓
02-MVCC理论 (L0对比)
```

**预计学习时间**: 2-3天

---

## 🎯 核心概念速查

| 概念 | 定义 | 所在文档 |
|-----|------|---------|
| **LSEM** | 分层状态演化模型 | 01-LSEM |
| **MVCC** | 多版本并发控制 | 02-MVCC |
| **快照隔离** | 基于时间戳的可见性控制 | 02-MVCC#二 |
| **ACID** | 原子性、一致性、隔离性、持久性 | 03-ACID |
| **WAL** | 预写日志 | 03-ACID#二 |
| **CAP** | 一致性、可用性、分区容错性 | 04-CAP |
| **Raft** | 分布式共识协议 | 04-CAP#三 |
| **SSI** | 可序列化快照隔离 | 02-MVCC#4.3 |

---

## 📊 文档完成度

| 文档 | 状态 | 字数 | 完成度 |
|-----|------|------|--------|
| 01-LSEM | ✅ 已完成 | ~12,000 | 100% |
| 02-MVCC | ✅ 已完成 | ~14,000 | 100% |
| 03-ACID | ✅ 已完成 | ~13,000 | 100% |
| 04-CAP | ✅ 已完成 | ~12,000 | 100% |
| 05-并发控制 | 📋 待创建 | - | 0% |
| 06-所有权 | 📋 待创建 | - | 0% |
| 07-内存模型 | 📋 待创建 | - | 0% |
| 08-共识协议 | 📋 待创建 | - | 0% |

**总体完成度**: 4/8 = **50%** ✅

---

## 🔧 使用指南

### 如何阅读

1. **快速浏览**: 先看每个文档的"核心贡献"和"关键公式"
2. **深度学习**: 按章节顺序阅读，完成思考题
3. **实践验证**: 对照PostgreSQL源码或Rust代码验证理论

### 如何贡献

**发现错误**:

```bash
# 提交Issue
标题: [01-核心理论模型] 定理2.1证明有误
内容:
- 错误位置: 02-MVCC理论完整解析.md#2.2节
- 错误内容: ...
- 正确应为: ...
```

**补充内容**:

```bash
# 提交PR
- 添加新的定理证明
- 补充实现代码示例
- 改进可视化图表
```

---

## 🌐 与其他模块的关联

```
01-核心理论模型
    ├─→ 02-设计权衡分析 (应用理论进行决策)
    ├─→ 03-证明与形式化 (完整数学证明)
    ├─→ 04-分布式扩展 (L2层详细展开)
    ├─→ 05-实现机制 (理论到代码映射)
    └─→ 06-性能分析 (理论量化验证)
```

---

## 📖 参考文献

**核心论文**:

1. Bernstein, P. A. (1981). "Concurrency Control and Recovery in Database Systems"
2. Gray, J., & Reuter, A. (1993). *Transaction Processing: Concepts and Techniques*
3. Gilbert, S., & Lynch, N. (2002). "Brewer's Conjecture"
4. Ports, D. R., & Grittner, K. (2012). "Serializable Snapshot Isolation in PostgreSQL"

**源码参考**:

- PostgreSQL MVCC: `src/backend/access/heap/heapam_visibility.c`
- PostgreSQL WAL: `src/backend/access/transam/xlog.c`
- Rust所有权: *The Rust Programming Language* Chapter 4

---

## 🎓 思考题

### 01-LSEM模型

1. 为什么三层都满足严格偏序关系？
2. 如何证明L0/L1/L2的同构性？
3. 跨层锁语义混淆会导致什么问题？

### 02-MVCC理论

1. 为什么长事务会导致表膨胀？
2. HOT优化在什么情况下失效？
3. Serializable SSI如何检测幻读？

### 03-ACID理论

1. WAL如何保证原子性？
2. Checkpoint如何权衡性能和恢复时间？
3. 不同隔离级别如何影响并发度？

### 04-CAP理论

1. 为什么CAP不可能三者兼得？
2. PACELC如何扩展CAP？
3. PostgreSQL如何在CA/CP/AP间切换？

---

**最后更新**: 2025-12-05
**模块负责人**: PostgreSQL理论研究组
**版本**: 1.0.0

---

## 🚀 下一步

**立即行动**:

- [ ] 阅读 [01-LSEM模型](./01-分层状态演化模型(LSEM).md)
- [ ] 完成思考题
- [ ] 开始学习 [02-MVCC理论](./02-MVCC理论完整解析.md)

**深度学习**:

- [ ] 研读所有形式化证明
- [ ] 对照PostgreSQL源码
- [ ] 完成性能测试验证

**贡献代码**:

- [ ] Fork仓库
- [ ] 完善待创建文档
- [ ] 提交Pull Request
