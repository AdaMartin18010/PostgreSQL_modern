# 02 | éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ

> **å†³ç­–å·¥å…·**: æœ¬æ–‡æ¡£æä¾›ç³»ç»ŸåŒ–çš„éš”ç¦»çº§åˆ«é€‰æ‹©æŒ‡å—ï¼ŒåŒ…æ‹¬å¼‚å¸¸ç°è±¡ã€æ€§èƒ½å½±å“ã€åº”ç”¨åœºæ™¯çš„å®Œæ•´å¯¹æ¯”ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ](#02--éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰](#ä¸€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰)
    - [1.1 SQLæ ‡å‡†å®šä¹‰](#11-sqlæ ‡å‡†å®šä¹‰)
    - [1.2 å¼‚å¸¸ç°è±¡å®šä¹‰](#12-å¼‚å¸¸ç°è±¡å®šä¹‰)
  - [äºŒã€æ ¸å¿ƒæƒè¡¡çŸ©é˜µ](#äºŒæ ¸å¿ƒæƒè¡¡çŸ©é˜µ)
    - [2.1 å¼‚å¸¸ç°è±¡çŸ©é˜µ](#21-å¼‚å¸¸ç°è±¡çŸ©é˜µ)
    - [2.2 æ€§èƒ½å½±å“çŸ©é˜µ](#22-æ€§èƒ½å½±å“çŸ©é˜µ)
  - [ä¸‰ã€PostgreSQLå…·ä½“å®ç°](#ä¸‰postgresqlå…·ä½“å®ç°)
    - [3.1 Read Committed](#31-read-committed)
    - [3.2 Repeatable Read](#32-repeatable-read)
    - [3.3 Serializable (SSI)](#33-serializable-ssi)
  - [å››ã€å¤šç»´åº¦æƒè¡¡åˆ†æ](#å››å¤šç»´åº¦æƒè¡¡åˆ†æ)
    - [4.1 æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿](#41-æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿)
    - [4.2 ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»](#42-ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»)
    - [4.3 å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”](#43-å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”)
  - [äº”ã€åº”ç”¨åœºæ™¯æ˜ å°„](#äº”åº”ç”¨åœºæ™¯æ˜ å°„)
    - [5.1 åœºæ™¯å†³ç­–çŸ©é˜µ](#51-åœºæ™¯å†³ç­–çŸ©é˜µ)
    - [5.2 è¡Œä¸šæœ€ä½³å®è·µ](#52-è¡Œä¸šæœ€ä½³å®è·µ)
  - [å…­ã€æ€§èƒ½è°ƒä¼˜æŒ‡å—](#å…­æ€§èƒ½è°ƒä¼˜æŒ‡å—)
    - [6.1 éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥](#61-éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥)
    - [6.2 é™çº§ç­–ç•¥](#62-é™çº§ç­–ç•¥)
    - [6.3 é‡è¯•ç­–ç•¥](#63-é‡è¯•ç­–ç•¥)
  - [ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­](#ä¸ƒç›‘æ§ä¸è¯Šæ–­)
    - [7.1 å…³é”®ç›‘æ§æŒ‡æ ‡](#71-å…³é”®ç›‘æ§æŒ‡æ ‡)
    - [7.2 è¯Šæ–­æµç¨‹](#72-è¯Šæ–­æµç¨‹)
  - [å…«ã€æ€»ç»“](#å…«æ€»ç»“)
    - [8.1 æ ¸å¿ƒè´¡çŒ®](#81-æ ¸å¿ƒè´¡çŒ®)
    - [8.2 å…³é”®å†³ç­–è§„åˆ™](#82-å…³é”®å†³ç­–è§„åˆ™)
    - [8.3 æœ€ä½³å®è·µ](#83-æœ€ä½³å®è·µ)
  - [ä¹ã€åä¾‹ä¸é”™è¯¯é€‰æ‹©](#ä¹åä¾‹ä¸é”™è¯¯é€‰æ‹©)
    - [åä¾‹1: é«˜å¹¶å‘åœºæ™¯é€‰æ‹©Serializable](#åä¾‹1-é«˜å¹¶å‘åœºæ™¯é€‰æ‹©serializable)
    - [åä¾‹2: é‡‘èç³»ç»Ÿä½¿ç”¨Read Committed](#åä¾‹2-é‡‘èç³»ç»Ÿä½¿ç”¨read-committed)
    - [åä¾‹3: å¿½ç•¥æ€§èƒ½æµ‹è¯•ç›²ç›®é€‰æ‹©](#åä¾‹3-å¿½ç•¥æ€§èƒ½æµ‹è¯•ç›²ç›®é€‰æ‹©)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹](#åä¸€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿéš”ç¦»çº§åˆ«é€‰æ‹©](#101-æ¡ˆä¾‹-é‡‘èç³»ç»Ÿéš”ç¦»çº§åˆ«é€‰æ‹©)
    - [10.2 æ¡ˆä¾‹: ç”µå•†ç³»ç»Ÿéš”ç¦»çº§åˆ«ä¼˜åŒ–](#102-æ¡ˆä¾‹-ç”µå•†ç³»ç»Ÿéš”ç¦»çº§åˆ«ä¼˜åŒ–)
  - [åäºŒã€å®Œæ•´å®ç°ä»£ç ](#åäºŒå®Œæ•´å®ç°ä»£ç )
    - [12.1 éš”ç¦»çº§åˆ«æµ‹è¯•å·¥å…·å®Œæ•´å®ç°](#121-éš”ç¦»çº§åˆ«æµ‹è¯•å·¥å…·å®Œæ•´å®ç°)
    - [12.2 éš”ç¦»çº§åˆ«å†³ç­–å·¥å…·å®Œæ•´å®ç°](#122-éš”ç¦»çº§åˆ«å†³ç­–å·¥å…·å®Œæ•´å®ç°)
    - [12.3 éš”ç¦»çº§åˆ«æ€§èƒ½ç›‘æ§å·¥å…·å®Œæ•´å®ç°](#123-éš”ç¦»çº§åˆ«æ€§èƒ½ç›‘æ§å·¥å…·å®Œæ•´å®ç°)

---

## ä¸€ã€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰

### 1.1 SQLæ ‡å‡†å®šä¹‰

**å››å¤§éš”ç¦»çº§åˆ«**:

```text
Serializable (æœ€å¼º)
    â†“ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸
Repeatable Read
    â†“ é˜²æ­¢ä¸å¯é‡å¤è¯»
Read Committed
    â†“ é˜²æ­¢è„è¯»
Read Uncommitted (æœ€å¼±)
```

### 1.2 å¼‚å¸¸ç°è±¡å®šä¹‰

**P0: è„å†™ (Dirty Write)**:

$$T_1: W(x) \quad T_2: W(x) \quad T_1: Abort \quad \implies \text{Lost Update}$$

**P1: è„è¯» (Dirty Read)**:

$$T_1: W(x) \quad T_2: R(x) \quad T_1: Abort \quad \implies T_2 \text{ reads uncommitted}$$

**P2: ä¸å¯é‡å¤è¯» (Non-repeatable Read)**:

$$T_1: R(x) \quad T_2: W(x), Commit \quad T_1: R(x) \quad \implies \text{Different values}$$

**P3: å¹»è¯» (Phantom Read)**:

$$T_1: R(\text{range}) \quad T_2: Insert, Commit \quad T_1: R(\text{range}) \quad \implies \text{Different rows}$$

**P4: ä¸²è¡ŒåŒ–å¼‚å¸¸ (Serialization Anomaly)**:

$$\exists \text{cycle in serialization graph}$$

---

## äºŒã€æ ¸å¿ƒæƒè¡¡çŸ©é˜µ

### 2.1 å¼‚å¸¸ç°è±¡çŸ©é˜µ

| éš”ç¦»çº§åˆ« | P0 | P1 | P2 | P3 | P4 | è¯´æ˜ |
|---------|----|----|----|----|----|----|
| **Read Uncommitted** | âœ— | âœ— | âœ— | âœ— | âœ— | å…è®¸æ‰€æœ‰å¼‚å¸¸ |
| **Read Committed** | âœ“ | âœ“ | âœ— | âœ— | âœ— | ä»…é˜²æ­¢è„è¯»è„å†™ |
| **Repeatable Read** | âœ“ | âœ“ | âœ“ | ? | âœ— | SQLæ ‡å‡†å…è®¸å¹»è¯» |
| **PostgreSQL RR** | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | æ‰©å±•é˜²æ­¢å¹»è¯» |
| **Serializable** | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ |

**ç¬¦å·è¯´æ˜**:

- âœ“ : é˜²æ­¢æ­¤å¼‚å¸¸
- âœ— : å…è®¸æ­¤å¼‚å¸¸
- ? : ä¾å®ç°è€Œå®š

### 2.2 æ€§èƒ½å½±å“çŸ©é˜µ

| éš”ç¦»çº§åˆ« | ååé‡ | å»¶è¿Ÿ | ä¸­æ­¢ç‡ | é”å¼€é”€ | å­˜å‚¨å¼€é”€ |
|---------|--------|------|--------|--------|---------|
| **Read Committed** | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… (1%) | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| **Repeatable Read** | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† (5%) | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜†â˜† |
| **Serializable** | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜†â˜†â˜†â˜† (15%) | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜†â˜†â˜† |

**é‡åŒ–æ•°æ®** (åŸºå‡†: Read Committed = 1.0):

| æŒ‡æ ‡ | Read Committed | Repeatable Read | Serializable |
|-----|---------------|----------------|--------------|
| **ç›¸å¯¹ååé‡** | 1.0 | 0.8 | 0.5 |
| **ç›¸å¯¹å»¶è¿Ÿ** | 1.0 | 1.2 | 1.8 |
| **ä¸­æ­¢ç‡** | 1% | 5% | 15% |
| **å¿«ç…§åˆ›å»ºå¼€é”€** | ä½ (æ¯è¯­å¥) | ä¸­ (æ¯äº‹åŠ¡) | ä¸­ (æ¯äº‹åŠ¡) |
| **å†²çªæ£€æµ‹å¼€é”€** | ä½ | ä¸­ (å†™å†™) | é«˜ (è¯»å†™ç¯) |

---

## ä¸‰ã€PostgreSQLå…·ä½“å®ç°

### 3.1 Read Committed

**å¿«ç…§ç­–ç•¥**: æ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§

```python
class ReadCommittedTransaction:
    def execute_statement(self, sql):
        # æ¯æ¡è¯­å¥è·å–æ–°å¿«ç…§
        snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )

        result = execute_with_snapshot(sql, snapshot)
        return result
```

**è¡Œä¸ºç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡)
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 200 (ä¸å¯é‡å¤è¯»!)
```

**å…è®¸çš„å¼‚å¸¸**:

- âŒ **ä¸å¯é‡å¤è¯»**: åŒä¸€æŸ¥è¯¢è¿”å›ä¸åŒç»“æœ
- âŒ **å¹»è¯»**: èŒƒå›´æŸ¥è¯¢å‡ºç°æ–°è¡Œ

**é€‚ç”¨åœºæ™¯**:

- âœ… Webåº”ç”¨ï¼ˆè¯»æœ€æ–°æ•°æ®ï¼‰
- âœ… APIæœåŠ¡ï¼ˆçŸ­äº‹åŠ¡ï¼‰
- âœ… é«˜å¹¶å‘ç³»ç»Ÿï¼ˆé»˜è®¤é€‰æ‹©ï¼‰

### 3.2 Repeatable Read

**å¿«ç…§ç­–ç•¥**: äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼Œå…¨ç¨‹ä¸å˜

```python
class RepeatableReadTransaction:
    def __init__(self):
        # äº‹åŠ¡å¼€å§‹æ—¶å›ºå®šå¿«ç…§
        self.snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )

    def execute_statement(self, sql):
        # æ‰€æœ‰è¯­å¥ä½¿ç”¨åŒä¸€å¿«ç…§
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**è¡Œä¸ºç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡)
SELECT balance FROM accounts WHERE id = 1;  -- ä»è¿”å› 100 (å¯é‡å¤è¯»!)
```

**å†™å†™å†²çªå¤„ç†**:

```sql
-- ä¼šè¯A
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE id = 1;  -- å¿«ç…§: balance=100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A
UPDATE accounts SET balance = 150 WHERE id = 1;
-- ERROR: could not serialize access due to concurrent update
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: å¿«ç…§å›ºå®š
- âœ… **å¹»è¯»**: PostgreSQLæ‰©å±•ï¼ˆäº‹åŠ¡çº§å¿«ç…§ï¼‰

**é€‚ç”¨åœºæ™¯**:

- âœ… æŠ¥è¡¨æŸ¥è¯¢ï¼ˆéœ€è¦ä¸€è‡´æ€§å¿«ç…§ï¼‰
- âœ… æ‰¹å¤„ç†ï¼ˆé•¿æ—¶é—´è¿è¡Œï¼‰
- âœ… æ•°æ®åˆ†æï¼ˆä¸€è‡´æ€§è§†å›¾ï¼‰

### 3.3 Serializable (SSI)

**å¿«ç…§ç­–ç•¥**: åŒRepeatable Read + ä¾èµ–å›¾æ£€æµ‹

```python
class SerializableTransaction:
    def __init__(self):
        self.snapshot = get_snapshot()
        self.predicate_locks = []  # SIREADé”
        self.dependencies = []      # ä¾èµ–è¾¹

    def execute_select(self, sql):
        result = execute_with_snapshot(sql, self.snapshot)

        # è®°å½•è°“è¯é”
        predicate = extract_predicate(sql)
        self.predicate_locks.append(predicate)

        # æ£€æŸ¥å†™ä¾èµ–
        for writer in get_concurrent_writers():
            if conflicts(writer, predicate):
                self.dependencies.append((writer, self, 'rw'))

        return result

    def execute_modify(self, sql):
        # æ£€æŸ¥è¯»ä¾èµ–
        for reader in get_concurrent_readers():
            if conflicts(sql, reader.predicate_locks):
                self.dependencies.append((self, reader, 'wr'))

        # æ£€æµ‹å±é™©ç»“æ„
        if has_cycle(self.dependencies):
            raise SerializationError("Dangerous structure detected")

        # æ‰§è¡Œä¿®æ”¹
        return execute_with_lock(sql)
```

**æ£€æµ‹ç¤ºä¾‹**:

```sql
-- äº‹åŠ¡T1
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT COUNT(*) FROM orders WHERE amount > 100;  -- è¯»èŒƒå›´

-- äº‹åŠ¡T2
INSERT INTO orders VALUES (150);  -- å†™å…¥èŒƒå›´å†…

-- äº‹åŠ¡T1æäº¤
COMMIT;
-- æ£€æµ‹åˆ°: T1 è¯» â†’ T2 å†™ â†’ T1 æäº¤
-- å¯èƒ½ä¸­æ­¢T1æˆ–T2ï¼ˆå…ˆæäº¤å…ˆä¸­æ­¢ï¼‰
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **æ‰€æœ‰å¼‚å¸¸**: ç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

**é€‚ç”¨åœºæ™¯**:

- âœ… é‡‘èäº¤æ˜“ï¼ˆä¸¥æ ¼ä¸€è‡´æ€§ï¼‰
- âœ… åº“å­˜æ‰£å‡ï¼ˆé˜²æ­¢è¶…å–ï¼‰
- âœ… å…³é”®ä¸šåŠ¡ï¼ˆé›¶å®¹é”™ï¼‰

---

## å››ã€å¤šç»´åº¦æƒè¡¡åˆ†æ

### 4.1 æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿

```text
æ€§èƒ½ (TPS)
  â†‘
  â”‚  RC â—
  â”‚      \
  â”‚       \  RR â—
  â”‚            \
  â”‚             \
  â”‚              \  Serializable â—
  â”‚               \
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¸€è‡´æ€§å¼ºåº¦
```

**é‡åŒ–å…³ç³»**:

$$TPS_{RC} : TPS_{RR} : TPS_{Ser} \approx 10 : 8 : 5$$

### 4.2 ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»

```text
ä¸­æ­¢ç‡ (%)
  â†‘
  â”‚                    Serializable
  â”‚                 ï¼
  â”‚              ï¼
  â”‚           ï¼  Repeatable Read
  â”‚        ï¼
  â”‚     ï¼ Read Committed
  â”‚  ï¼
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å¹¶å‘åº¦
```

**å®éªŒæ•°æ®** (TPC-CåŸºå‡†):

| å¹¶å‘åº¦ | RCä¸­æ­¢ç‡ | RRä¸­æ­¢ç‡ | Serä¸­æ­¢ç‡ |
|-------|---------|---------|----------|
| 10 | 0.1% | 0.5% | 2% |
| 100 | 0.5% | 3% | 12% |
| 1000 | 2% | 10% | 35% |

### 4.3 å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”

**P50å»¶è¿Ÿ** (ms):

| éš”ç¦»çº§åˆ« | SELECT | UPDATE | å¤æ‚æŸ¥è¯¢ |
|---------|--------|--------|---------|
| RC | 1 | 5 | 50 |
| RR | 1.2 | 6 | 60 |
| Ser | 1.5 | 10 | 100 |

**P99å»¶è¿Ÿ** (ms):

| éš”ç¦»çº§åˆ« | SELECT | UPDATE | å¤æ‚æŸ¥è¯¢ |
|---------|--------|--------|---------|
| RC | 10 | 50 | 500 |
| RR | 15 | 80 | 800 |
| Ser | 30 | 200 | 2000 |

---

## äº”ã€åº”ç”¨åœºæ™¯æ˜ å°„

### 5.1 åœºæ™¯å†³ç­–çŸ©é˜µ

| ä¸šåŠ¡åœºæ™¯ | æ¨èçº§åˆ« | ç†ç”± | å¤‡é€‰æ–¹æ¡ˆ |
|---------|---------|------|---------|
| **Web API** | Read Committed | é«˜å¹¶å‘ã€çŸ­äº‹åŠ¡ | - |
| **æŠ¥è¡¨æŸ¥è¯¢** | Repeatable Read | ä¸€è‡´æ€§å¿«ç…§ | - |
| **é‡‘èè½¬è´¦** | Serializable | é›¶å®¹é”™ | RR + åº”ç”¨å±‚æ£€æŸ¥ |
| **åº“å­˜æ‰£å‡** | Serializable | é˜²æ­¢è¶…å– | RC + ä¹è§‚é” |
| **ç”¨æˆ·ç™»å½•** | Read Committed | è¯»æœ€æ–°å¯†ç  | - |
| **è®¢å•æŸ¥è¯¢** | Read Committed | å®æ—¶æ•°æ® | - |
| **æ•°æ®åˆ†æ** | Repeatable Read | ä¸€è‡´æ€§ç»Ÿè®¡ | - |
| **é…ç½®ç®¡ç†** | Repeatable Read | é¿å…é…ç½®ä¸ä¸€è‡´ | - |
| **å®¡è®¡æ—¥å¿—** | Read Committed | è¿½åŠ å†™ | - |
| **ç§’æ€ç³»ç»Ÿ** | Read Committed | é«˜å¹¶å‘ | + åº”ç”¨å±‚é™æµ |

### 5.2 è¡Œä¸šæœ€ä½³å®è·µ

**é‡‘èè¡Œä¸š**:

```sql
-- è½¬è´¦: å¼ºä¸€è‡´æ€§
BEGIN ISOLATION LEVEL SERIALIZABLE;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;

-- æŸ¥è¯¢ä½™é¢: å¯é‡å¤è¯»
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
```

**ç”µå•†è¡Œä¸š**:

```sql
-- ä¸‹å•: è¯»å·²æäº¤ï¼ˆé«˜å¹¶å‘ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
INSERT INTO orders (...) VALUES (...);
UPDATE inventory SET stock = stock - 1 WHERE product_id = 456
  AND stock > 0;  -- ä¹è§‚é”
COMMIT;

-- æŠ¥è¡¨: å¯é‡å¤è¯»
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT DATE(created_at), COUNT(*) FROM orders
GROUP BY DATE(created_at);
```

**ç¤¾äº¤ç½‘ç»œ**:

```sql
-- ç‚¹èµ: è¯»å·²æäº¤ï¼ˆæœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
INSERT INTO likes (post_id, user_id) VALUES (789, 123)
ON CONFLICT DO NOTHING;
COMMIT;

-- æ—¶é—´çº¿æŸ¥è¯¢: è¯»å·²æäº¤ï¼ˆè¯»æœ€æ–°ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM posts WHERE user_id IN (following_list)
ORDER BY created_at DESC LIMIT 20;
```

---

## å…­ã€æ€§èƒ½è°ƒä¼˜æŒ‡å—

### 6.1 éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥

**åŠ¨æ€åˆ‡æ¢**:

```python
class AdaptiveIsolationLevel:
    def choose_level(self, operation_type, workload):
        if operation_type == 'READ_ONLY':
            # åªè¯»äº‹åŠ¡: RCæˆ–RR
            if workload.consistency_required:
                return 'REPEATABLE_READ'
            else:
                return 'READ_COMMITTED'

        elif operation_type == 'WRITE_HEAVY':
            # å†™å¯†é›†: RCï¼ˆé™ä½å†²çªï¼‰
            return 'READ_COMMITTED'

        elif operation_type == 'CRITICAL':
            # å…³é”®ä¸šåŠ¡: Serializable
            return 'SERIALIZABLE'

        else:
            # é»˜è®¤
            return 'READ_COMMITTED'
```

### 6.2 é™çº§ç­–ç•¥

**ä»Serializableé™çº§åˆ°RR**:

```python
def execute_with_fallback(tx_func):
    # å…ˆå°è¯•Serializable
    try:
        return execute_transaction(tx_func, 'SERIALIZABLE')
    except SerializationError:
        # é™çº§åˆ°Repeatable Read
        logger.warning("Serializable failed, fallback to RR")
        try:
            return execute_transaction(tx_func, 'REPEATABLE_READ')
        except SerializationError:
            # æœ€ç»ˆé™çº§åˆ°Read Committed
            logger.error("RR failed, fallback to RC")
            return execute_transaction(tx_func, 'READ_COMMITTED')
```

**æƒè¡¡**:

- âœ… æé«˜æˆåŠŸç‡
- âŒ å¯èƒ½ç‰ºç‰²ä¸€è‡´æ€§ä¿è¯

### 6.3 é‡è¯•ç­–ç•¥

**æŒ‰éš”ç¦»çº§åˆ«å®šåˆ¶é‡è¯•**:

```python
def retry_config(isolation_level):
    if isolation_level == 'READ_COMMITTED':
        return RetryPolicy(
            max_attempts=1,      # å¾ˆå°‘éœ€è¦é‡è¯•
            base_delay=0,
            max_delay=0
        )
    elif isolation_level == 'REPEATABLE_READ':
        return RetryPolicy(
            max_attempts=3,      # ä¸­ç­‰é‡è¯•
            base_delay=100,      # ms
            max_delay=1000
        )
    elif isolation_level == 'SERIALIZABLE':
        return RetryPolicy(
            max_attempts=5,      # é«˜é‡è¯•æ¬¡æ•°
            base_delay=200,
            max_delay=5000
        )
```

---

## ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­

### 7.1 å…³é”®ç›‘æ§æŒ‡æ ‡

**ç³»ç»Ÿè§†å›¾**:

```sql
-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SHOW default_transaction_isolation;

-- æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€
SELECT
    pid,
    usename,
    state,
    backend_xid,
    backend_xmin,
    query
FROM pg_stat_activity
WHERE backend_xid IS NOT NULL;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked.pid AS blocked_pid,
    blocked.query AS blocked_query,
    blocker.pid AS blocker_pid,
    blocker.query AS blocker_query
FROM pg_stat_activity AS blocked
JOIN pg_stat_activity AS blocker
  ON blocker.pid = ANY(pg_blocking_pids(blocked.pid));
```

**æ€§èƒ½æŒ‡æ ‡**:

| æŒ‡æ ‡ | SQL | å‘Šè­¦é˜ˆå€¼ |
|-----|-----|---------|
| **ä¸­æ­¢ç‡** | `pg_stat_database.xact_rollback / xact_commit` | >5% |
| **é”ç­‰å¾…æ—¶é•¿** | `pg_stat_activity.wait_event = 'Lock'` | >1s |
| **é•¿äº‹åŠ¡** | `NOW() - xact_start` | >10min |
| **æ­»å…ƒç»„æ¯”ä¾‹** | `n_dead_tup / n_live_tup` | >10% |

### 7.2 è¯Šæ–­æµç¨‹

```text
æ€§èƒ½é—®é¢˜
    â†“
æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
    â†“
ä¸­æ­¢ç‡é«˜ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ é™ä½éš”ç¦»çº§åˆ«
    â”‚      æˆ–å‡å°äº‹åŠ¡ç²’åº¦
    â†“
é”ç­‰å¾…å¤šï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ£€æŸ¥æ…¢æŸ¥è¯¢
    â”‚      ä¼˜åŒ–ç´¢å¼•
    â†“
é•¿äº‹åŠ¡å¤šï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ‹†åˆ†äº‹åŠ¡
    â”‚      æˆ–å¼‚æ­¥å¤„ç†
    â†“
æ­»å…ƒç»„å¤šï¼Ÿ
    â””â”€ æ˜¯ â†’ è°ƒæ•´VACUUMç­–ç•¥
           å¢åŠ autovacuum_workers
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè´¡çŒ®

**ç†è®ºè´¡çŒ®**:

1. **å®Œæ•´çš„å¼‚å¸¸ç°è±¡å®šä¹‰**ï¼ˆP0-P4ï¼‰
2. **å¤šç»´åº¦æƒè¡¡çŸ©é˜µ**ï¼ˆæ€§èƒ½ã€ä¸€è‡´æ€§ã€é€‚ç”¨åœºæ™¯ï¼‰
3. **é‡åŒ–æ€§èƒ½æ¨¡å‹**ï¼ˆååé‡ã€å»¶è¿Ÿã€ä¸­æ­¢ç‡ï¼‰

**å·¥ç¨‹ä»·å€¼**:

1. **åœºæ™¯å†³ç­–çŸ©é˜µ**ï¼ˆ10+ä¸šåŠ¡åœºæ™¯ï¼‰
2. **åŠ¨æ€åˆ‡æ¢ç­–ç•¥**ï¼ˆè‡ªé€‚åº”é€‰æ‹©ï¼‰
3. **ç›‘æ§è¯Šæ–­æµç¨‹**ï¼ˆé—®é¢˜å®šä½ï¼‰

### 8.2 å…³é”®å†³ç­–è§„åˆ™

**è§„åˆ™1**: é»˜è®¤ä½¿ç”¨Read Committed

$$\text{Default} \implies \text{Read Committed (é«˜æ€§èƒ½)}$$

**è§„åˆ™2**: éœ€è¦ä¸€è‡´æ€§å¿«ç…§æ—¶ä½¿ç”¨Repeatable Read

$$\text{Consistent Snapshot Required} \implies \text{Repeatable Read}$$

**è§„åˆ™3**: é‡‘è/å…³é”®ä¸šåŠ¡ä½¿ç”¨Serializable

$$\text{Zero Tolerance} \implies \text{Serializable}$$

**è§„åˆ™4**: æ€§èƒ½ä¼˜å…ˆæ—¶è€ƒè™‘é™çº§

$$\text{Abort Rate} > 10\% \implies \text{Consider Downgrade}$$

### 8.3 æœ€ä½³å®è·µ

**1. çŸ­äº‹åŠ¡ä¼˜å…ˆ**:

$$\text{Transaction Time} < 1s \implies \text{Lower Conflict}$$

**2. æ˜¾å¼åŠ é”**:

```sql
-- æå‰é”å®šçƒ­ç‚¹è¡Œ
SELECT * FROM inventory WHERE product_id = 123 FOR UPDATE;
```

**3. ç›‘æ§é©±åŠ¨**:

```sql
-- å®šæœŸæ£€æŸ¥ä¸­æ­¢ç‡
SELECT
    datname,
    xact_rollback::float / NULLIF(xact_commit + xact_rollback, 0) AS abort_rate
FROM pg_stat_database
WHERE abort_rate > 0.05;  -- å‘Šè­¦é˜ˆå€¼5%
```

**4. åº”ç”¨å±‚é‡è¯•**:

```python
@retry(max_attempts=3, backoff=exponential)
def critical_transaction():
    with db.transaction(isolation='SERIALIZABLE'):
        # ä¸šåŠ¡é€»è¾‘
        ...
```

---

## ä¹ã€åä¾‹ä¸é”™è¯¯é€‰æ‹©

### åä¾‹1: é«˜å¹¶å‘åœºæ™¯é€‰æ‹©Serializable

**é”™è¯¯é€‰æ‹©**:

```sql
-- é”™è¯¯: é«˜å¹¶å‘è®¢å•ç³»ç»Ÿä½¿ç”¨Serializable
BEGIN ISOLATION LEVEL SERIALIZABLE;
INSERT INTO orders ...;
COMMIT;
-- ç»“æœ: TPSä»10Ké™åˆ°500ï¼Œä¸­æ­¢ç‡30%
```

**é—®é¢˜**: è¿‡åº¦è¿½æ±‚æ­£ç¡®æ€§ï¼Œå¿½ç•¥æ€§èƒ½

**æ­£ç¡®é€‰æ‹©**:

```sql
-- æ­£ç¡®: ä½¿ç”¨Read Committed + åº”ç”¨å±‚æ§åˆ¶
BEGIN ISOLATION LEVEL READ COMMITTED;
INSERT INTO orders ...;
COMMIT;
-- ç»“æœ: TPS 10Kï¼Œæ•°æ®é”™è¯¯ç‡<0.01%ï¼ˆå¯æ¥å—ï¼‰
```

### åä¾‹2: é‡‘èç³»ç»Ÿä½¿ç”¨Read Committed

**é”™è¯¯é€‰æ‹©**:

```sql
-- é”™è¯¯: è½¬è´¦ç³»ç»Ÿä½¿ç”¨Read Committed
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT balance FROM accounts WHERE id = 1;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;
-- ç»“æœ: å¯èƒ½å‡ºç°ä¸¢å¤±æ›´æ–°ï¼Œèµ„é‡‘é”™è¯¯
```

**é—®é¢˜**: å¿½ç•¥ä¸šåŠ¡æ­£ç¡®æ€§è¦æ±‚

**æ­£ç¡®é€‰æ‹©**:

```sql
-- æ­£ç¡®: ä½¿ç”¨Serializableæˆ–åº”ç”¨å±‚ä¹è§‚é”
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM accounts WHERE id = 1;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;
-- ç»“æœ: 100%æ­£ç¡®ï¼Œæ€§èƒ½å¯æ¥å—
```

### åä¾‹3: å¿½ç•¥æ€§èƒ½æµ‹è¯•ç›²ç›®é€‰æ‹©

**é”™è¯¯åšæ³•**:

```text
1. çœ‹æ–‡æ¡£è¯´"Repeatable Readæ€§èƒ½å¥½"
2. ç›´æ¥åº”ç”¨åˆ°æ‰€æœ‰åœºæ™¯
3. ä¸è¿›è¡Œæ€§èƒ½æµ‹è¯•
4. ç»“æœ: å®é™…æ€§èƒ½å·®ï¼Œéœ€è¦é‡æ„
```

**æ­£ç¡®åšæ³•**:

```text
1. ç†è®ºåˆ†æ + æ€§èƒ½æµ‹è¯•
2. ç”¨pgbenchæµ‹è¯•ä¸åŒéš”ç¦»çº§åˆ«
3. æ ¹æ®å®æµ‹æ•°æ®é€‰æ‹©
4. æŒç»­ç›‘æ§å’Œä¼˜åŒ–
```

---

## åã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Berenson, H., et al. (1995). "A Critique of ANSI SQL Isolation Levels"
- Adya, A. (1999). "Weak Consistency: A Generalized Theory"

**å®ç°ç»†èŠ‚**:

- PostgreSQLéš”ç¦»çº§åˆ«å®ç°: `src/backend/storage/lmgr/predicate.c`
- SSIè®ºæ–‡: Ports & Grittner (2012)

**æ‰©å±•æ–¹å‘**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md` â†’ MVCCè¯¦ç»†æœºåˆ¶
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md` â†’ é‡åŒ–æ€§èƒ½å½±å“
- `06-æ€§èƒ½åˆ†æ/04-é‡åŒ–å¯¹æ¯”å®éªŒ.md` â†’ å®æµ‹æ•°æ®

---

---

## åä¸€ã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 æ¡ˆä¾‹: é‡‘èç³»ç»Ÿéš”ç¦»çº§åˆ«é€‰æ‹©

**åœºæ™¯**: é“¶è¡Œæ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿ

**éœ€æ±‚åˆ†æ**:

- ä¸€è‡´æ€§: 100%ï¼ˆé›¶å®¹å¿é”™è¯¯ï¼‰
- å¹¶å‘åº¦: ä¸­ç­‰ï¼ˆTPS 5,000ï¼‰
- å»¶è¿Ÿ: å¯æ¥å—ï¼ˆP99 < 100msï¼‰

**å†³ç­–è¿‡ç¨‹**:

```sql
-- ä½¿ç”¨Serializable SSI
BEGIN ISOLATION LEVEL SERIALIZABLE;

-- è½¬è´¦æ“ä½œ
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

COMMIT;
-- å¦‚æœåºåˆ—åŒ–å¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•
```

**æ€§èƒ½æ•°æ®**:

| æŒ‡æ ‡ | æ•°å€¼ |
|-----|------|
| TPS | 5,000 |
| åºåˆ—åŒ–å¤±è´¥ç‡ | 0.5% |
| æ•°æ®æ­£ç¡®æ€§ | 100% |

**ç»éªŒæ€»ç»“**: é‡‘èç³»ç»Ÿä¼˜å…ˆæ­£ç¡®æ€§

### 10.2 æ¡ˆä¾‹: ç”µå•†ç³»ç»Ÿéš”ç¦»çº§åˆ«ä¼˜åŒ–

**åœºæ™¯**: å¤§å‹ç”µå•†å¹³å°

**ä¼˜åŒ–è¿‡ç¨‹**:

- åˆå§‹: å…¨éƒ¨ä½¿ç”¨Serializableï¼ˆæ€§èƒ½å·®ï¼‰
- ä¼˜åŒ–: æŒ‰ä¸šåŠ¡é€‰æ‹©éš”ç¦»çº§åˆ«
  - è®¢å•: Repeatable Read
  - åº“å­˜: Serializable
  - æµè§ˆ: Read Committed

**æŠ€æœ¯æ–¹æ¡ˆ**:

```python
# æŒ‰ä¸šåŠ¡é€‰æ‹©éš”ç¦»çº§åˆ«
def process_order(order):
    with transaction(isolation='REPEATABLE READ'):
        # è®¢å•å¤„ç†
        create_order(order)

def update_inventory(product_id, quantity):
    with transaction(isolation='SERIALIZABLE'):
        # åº“å­˜æ›´æ–°ï¼ˆå¿…é¡»å¼ºä¸€è‡´ï¼‰
        update_stock(product_id, quantity)

def get_product_info(product_id):
    with transaction(isolation='READ COMMITTED'):
        # å•†å“æµè§ˆï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
        return get_product(product_id)
```

**ä¼˜åŒ–æ•ˆæœ**: æ•´ä½“TPSæå‡50%

---

## åäºŒã€å®Œæ•´å®ç°ä»£ç 

### 12.1 éš”ç¦»çº§åˆ«æµ‹è¯•å·¥å…·å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: Pythonå·¥å…·ç”¨äºæµ‹è¯•ä¸åŒéš”ç¦»çº§åˆ«çš„è¡Œä¸º

```python
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_READ_COMMITTED, ISOLATION_LEVEL_REPEATABLE_READ, ISOLATION_LEVEL_SERIALIZABLE
from concurrent.futures import ThreadPoolExecutor
import time
from typing import List, Dict

class IsolationLevelTester:
    """éš”ç¦»çº§åˆ«æµ‹è¯•å™¨"""

    def __init__(self, conn_string: str):
        self.conn_string = conn_string

    def test_dirty_read(self, isolation_level: int) -> bool:
        """æµ‹è¯•è„è¯»"""
        conn1 = psycopg2.connect(self.conn_string)
        conn1.set_isolation_level(isolation_level)
        conn2 = psycopg2.connect(self.conn_string)
        conn2.set_isolation_level(isolation_level)

        try:
            # äº‹åŠ¡1: å†™å…¥æœªæäº¤
            cur1 = conn1.cursor()
            cur1.execute("CREATE TABLE IF NOT EXISTS test_dirty (id INT, value INT)")
            cur1.execute("TRUNCATE TABLE test_dirty")
            cur1.execute("INSERT INTO test_dirty VALUES (1, 100)")
            # ä¸æäº¤

            # äº‹åŠ¡2: è¯»å–
            cur2 = conn2.cursor()
            cur2.execute("SELECT value FROM test_dirty WHERE id = 1")
            result = cur2.fetchone()

            conn1.rollback()
            conn2.commit()

            # å¦‚æœè¯»åˆ°100ï¼Œè¯´æ˜å‘ç”Ÿè„è¯»
            return result is not None and result[0] == 100
        finally:
            conn1.close()
            conn2.close()

    def test_non_repeatable_read(self, isolation_level: int) -> bool:
        """æµ‹è¯•ä¸å¯é‡å¤è¯»"""
        conn1 = psycopg2.connect(self.conn_string)
        conn1.set_isolation_level(isolation_level)
        conn2 = psycopg2.connect(self.conn_string)
        conn2.set_isolation_level(isolation_level)

        try:
            cur1 = conn1.cursor()
            cur2 = conn2.cursor()

            cur1.execute("CREATE TABLE IF NOT EXISTS test_nrr (id INT, value INT)")
            cur1.execute("TRUNCATE TABLE test_nrr")
            cur1.execute("INSERT INTO test_nrr VALUES (1, 100)")
            conn1.commit()

            # äº‹åŠ¡1: ç¬¬ä¸€æ¬¡è¯»å–
            cur1.execute("SELECT value FROM test_nrr WHERE id = 1")
            value1 = cur1.fetchone()[0]

            # äº‹åŠ¡2: æ›´æ–°å¹¶æäº¤
            cur2.execute("UPDATE test_nrr SET value = 200 WHERE id = 1")
            conn2.commit()

            # äº‹åŠ¡1: ç¬¬äºŒæ¬¡è¯»å–
            cur1.execute("SELECT value FROM test_nrr WHERE id = 1")
            value2 = cur1.fetchone()[0]

            conn1.commit()

            # å¦‚æœä¸¤æ¬¡è¯»å–å€¼ä¸åŒï¼Œè¯´æ˜å‘ç”Ÿä¸å¯é‡å¤è¯»
            return value1 != value2
        finally:
            conn1.close()
            conn2.close()

    def test_phantom_read(self, isolation_level: int) -> bool:
        """æµ‹è¯•å¹»è¯»"""
        conn1 = psycopg2.connect(self.conn_string)
        conn1.set_isolation_level(isolation_level)
        conn2 = psycopg2.connect(self.conn_string)
        conn2.set_isolation_level(isolation_level)

        try:
            cur1 = conn1.cursor()
            cur2 = conn2.cursor()

            cur1.execute("CREATE TABLE IF NOT EXISTS test_phantom (id INT, value INT)")
            cur1.execute("TRUNCATE TABLE test_phantom")
            cur1.execute("INSERT INTO test_phantom VALUES (1, 100), (2, 200)")
            conn1.commit()

            # äº‹åŠ¡1: ç¬¬ä¸€æ¬¡èŒƒå›´è¯»å–
            cur1.execute("SELECT COUNT(*) FROM test_phantom WHERE value > 50")
            count1 = cur1.fetchone()[0]

            # äº‹åŠ¡2: æ’å…¥æ–°è¡Œå¹¶æäº¤
            cur2.execute("INSERT INTO test_phantom VALUES (3, 300)")
            conn2.commit()

            # äº‹åŠ¡1: ç¬¬äºŒæ¬¡èŒƒå›´è¯»å–
            cur1.execute("SELECT COUNT(*) FROM test_phantom WHERE value > 50")
            count2 = cur1.fetchone()[0]

            conn1.commit()

            # å¦‚æœä¸¤æ¬¡è¯»å–è¡Œæ•°ä¸åŒï¼Œè¯´æ˜å‘ç”Ÿå¹»è¯»
            return count1 != count2
        finally:
            conn1.close()
            conn2.close()

    def generate_report(self) -> Dict:
        """ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"""
        levels = {
            'READ COMMITTED': ISOLATION_LEVEL_READ_COMMITTED,
            'REPEATABLE READ': ISOLATION_LEVEL_REPEATABLE_READ,
            'SERIALIZABLE': ISOLATION_LEVEL_SERIALIZABLE,
        }

        report = {}
        for level_name, level_code in levels.items():
            report[level_name] = {
                'dirty_read': self.test_dirty_read(level_code),
                'non_repeatable_read': self.test_non_repeatable_read(level_code),
                'phantom_read': self.test_phantom_read(level_code),
            }

        return report

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    tester = IsolationLevelTester("dbname=test user=postgres")
    report = tester.generate_report()

    for level, results in report.items():
        print(f"\n{level}:")
        print(f"  è„è¯»: {'å¯èƒ½' if results['dirty_read'] else 'ä¸å¯èƒ½'}")
        print(f"  ä¸å¯é‡å¤è¯»: {'å¯èƒ½' if results['non_repeatable_read'] else 'ä¸å¯èƒ½'}")
        print(f"  å¹»è¯»: {'å¯èƒ½' if results['phantom_read'] else 'ä¸å¯èƒ½'}")
```

### 12.2 éš”ç¦»çº§åˆ«å†³ç­–å·¥å…·å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: æ ¹æ®åº”ç”¨åœºæ™¯è‡ªåŠ¨æ¨èéš”ç¦»çº§åˆ«

```python
from dataclasses import dataclass
from enum import Enum
from typing import List, Optional

class IsolationLevel(Enum):
    READ_COMMITTED = "READ COMMITTED"
    REPEATABLE_READ = "REPEATABLE READ"
    SERIALIZABLE = "SERIALIZABLE"

class ConsistencyRequirement(Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

class PerformanceRequirement(Enum):
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"

@dataclass
class TransactionProfile:
    """äº‹åŠ¡ç‰¹å¾"""
    name: str
    read_ratio: float  # è¯»æ“ä½œæ¯”ä¾‹
    write_ratio: float  # å†™æ“ä½œæ¯”ä¾‹
    consistency_requirement: ConsistencyRequirement
    performance_requirement: PerformanceRequirement
    allows_abort: bool  # æ˜¯å¦å…è®¸ä¸­æ­¢
    critical_data: bool  # æ˜¯å¦å…³é”®æ•°æ®

class IsolationLevelRecommender:
    """éš”ç¦»çº§åˆ«æ¨èå™¨"""

    def __init__(self):
        self.rules = self._build_rules()

    def _build_rules(self) -> List[callable]:
        """æ„å»ºå†³ç­–è§„åˆ™"""
        return [
            self._rule_critical_data,
            self._rule_consistency_requirement,
            self._rule_performance_requirement,
            self._rule_allows_abort,
        ]

    def recommend(self, profile: TransactionProfile) -> IsolationLevel:
        """æ¨èéš”ç¦»çº§åˆ«"""
        candidates = [IsolationLevel.SERIALIZABLE]

        # åº”ç”¨è§„åˆ™
        for rule in self.rules:
            candidates = rule(profile, candidates)
            if len(candidates) == 1:
                break

        return candidates[0]

    def _rule_critical_data(
        self,
        profile: TransactionProfile,
        candidates: List[IsolationLevel]
    ) -> List[IsolationLevel]:
        """è§„åˆ™1: å…³é”®æ•°æ®å¿…é¡»SERIALIZABLE"""
        if profile.critical_data:
            return [IsolationLevel.SERIALIZABLE]
        return candidates

    def _rule_consistency_requirement(
        self,
        profile: TransactionProfile,
        candidates: List[IsolationLevel]
    ) -> List[IsolationLevel]:
        """è§„åˆ™2: ä¸€è‡´æ€§è¦æ±‚"""
        if profile.consistency_requirement == ConsistencyRequirement.CRITICAL:
            return [IsolationLevel.SERIALIZABLE]
        elif profile.consistency_requirement == ConsistencyRequirement.HIGH:
            return [l for l in candidates if l != IsolationLevel.READ_COMMITTED]
        elif profile.consistency_requirement == ConsistencyRequirement.LOW:
            return [IsolationLevel.READ_COMMITTED]
        return candidates

    def _rule_performance_requirement(
        self,
        profile: TransactionProfile,
        candidates: List[IsolationLevel]
    ) -> List[IsolationLevel]:
        """è§„åˆ™3: æ€§èƒ½è¦æ±‚"""
        if profile.performance_requirement == PerformanceRequirement.HIGH:
            # æ€§èƒ½ä¼˜å…ˆï¼Œé€‰æ‹©æœ€å¼±çš„éš”ç¦»çº§åˆ«
            if IsolationLevel.READ_COMMITTED in candidates:
                return [IsolationLevel.READ_COMMITTED]
        return candidates

    def _rule_allows_abort(
        self,
        profile: TransactionProfile,
        candidates: List[IsolationLevel]
    ) -> List[IsolationLevel]:
        """è§„åˆ™4: æ˜¯å¦å…è®¸ä¸­æ­¢"""
        if not profile.allows_abort:
            # ä¸å…è®¸ä¸­æ­¢ï¼Œé€‰æ‹©è¾ƒå¼±çš„éš”ç¦»çº§åˆ«ï¼ˆå‡å°‘å†²çªï¼‰
            if IsolationLevel.REPEATABLE_READ in candidates:
                return [IsolationLevel.REPEATABLE_READ]
        return candidates

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    recommender = IsolationLevelRecommender()

    # é‡‘èäº¤æ˜“
    financial_tx = TransactionProfile(
        name="é‡‘èäº¤æ˜“",
        read_ratio=0.3,
        write_ratio=0.7,
        consistency_requirement=ConsistencyRequirement.CRITICAL,
        performance_requirement=PerformanceRequirement.MEDIUM,
        allows_abort=False,
        critical_data=True,
    )

    level = recommender.recommend(financial_tx)
    print(f"é‡‘èäº¤æ˜“æ¨èéš”ç¦»çº§åˆ«: {level.value}")

    # å•†å“æµè§ˆ
    product_browse = TransactionProfile(
        name="å•†å“æµè§ˆ",
        read_ratio=0.95,
        write_ratio=0.05,
        consistency_requirement=ConsistencyRequirement.LOW,
        performance_requirement=PerformanceRequirement.HIGH,
        allows_abort=True,
        critical_data=False,
    )

    level = recommender.recommend(product_browse)
    print(f"å•†å“æµè§ˆæ¨èéš”ç¦»çº§åˆ«: {level.value}")
```

### 12.3 éš”ç¦»çº§åˆ«æ€§èƒ½ç›‘æ§å·¥å…·å®Œæ•´å®ç°

**å®Œæ•´å®ç°**: ç›‘æ§ä¸åŒéš”ç¦»çº§åˆ«çš„æ€§èƒ½æŒ‡æ ‡

```python
import psycopg2
import time
from collections import defaultdict
from dataclasses import dataclass
from typing import Dict, List

@dataclass
class IsolationLevelMetrics:
    """éš”ç¦»çº§åˆ«æŒ‡æ ‡"""
    isolation_level: str
    tps: float  # æ¯ç§’äº‹åŠ¡æ•°
    avg_latency: float  # å¹³å‡å»¶è¿Ÿ(ms)
    abort_rate: float  # ä¸­æ­¢ç‡
    conflict_count: int  # å†²çªæ¬¡æ•°

class IsolationLevelMonitor:
    """éš”ç¦»çº§åˆ«ç›‘æ§å™¨"""

    def __init__(self, conn_string: str):
        self.conn_string = conn_string
        self.metrics: Dict[str, IsolationLevelMetrics] = {}

    def benchmark(
        self,
        isolation_level: str,
        duration: int = 60,
        concurrency: int = 10
    ) -> IsolationLevelMetrics:
        """æ€§èƒ½åŸºå‡†æµ‹è¯•"""
        from concurrent.futures import ThreadPoolExecutor

        start_time = time.time()
        transactions = 0
        aborts = 0
        conflicts = 0
        latencies = []

        def worker():
            nonlocal transactions, aborts, conflicts
            conn = psycopg2.connect(self.conn_string)
            conn.set_isolation_level(self._get_isolation_code(isolation_level))

            while time.time() - start_time < duration:
                try:
                    t_start = time.time()
                    cur = conn.cursor()
                    cur.execute("BEGIN")
                    cur.execute("SELECT * FROM test_table WHERE id = 1")
                    cur.execute("UPDATE test_table SET value = value + 1 WHERE id = 1")
                    cur.execute("COMMIT")
                    t_end = time.time()

                    transactions += 1
                    latencies.append((t_end - t_start) * 1000)  # ms
                except psycopg2.extensions.TransactionRollbackError as e:
                    aborts += 1
                    if "serialization failure" in str(e):
                        conflicts += 1
                    conn.rollback()

            conn.close()

        with ThreadPoolExecutor(max_workers=concurrency) as executor:
            futures = [executor.submit(worker) for _ in range(concurrency)]
            for future in futures:
                future.result()

        elapsed = time.time() - start_time
        tps = transactions / elapsed
        avg_latency = sum(latencies) / len(latencies) if latencies else 0
        abort_rate = aborts / transactions if transactions > 0 else 0

        return IsolationLevelMetrics(
            isolation_level=isolation_level,
            tps=tps,
            avg_latency=avg_latency,
            abort_rate=abort_rate,
            conflict_count=conflicts,
        )

    def _get_isolation_code(self, level: str) -> int:
        """è·å–éš”ç¦»çº§åˆ«ä»£ç """
        from psycopg2.extensions import (
            ISOLATION_LEVEL_READ_COMMITTED,
            ISOLATION_LEVEL_REPEATABLE_READ,
            ISOLATION_LEVEL_SERIALIZABLE,
        )

        mapping = {
            'READ COMMITTED': ISOLATION_LEVEL_READ_COMMITTED,
            'REPEATABLE READ': ISOLATION_LEVEL_REPEATABLE_READ,
            'SERIALIZABLE': ISOLATION_LEVEL_SERIALIZABLE,
        }
        return mapping[level]

    def compare_levels(self, levels: List[str]) -> Dict[str, IsolationLevelMetrics]:
        """å¯¹æ¯”ä¸åŒéš”ç¦»çº§åˆ«"""
        results = {}
        for level in levels:
            print(f"æµ‹è¯•éš”ç¦»çº§åˆ«: {level}")
            metrics = self.benchmark(level)
            results[level] = metrics
            print(f"  TPS: {metrics.tps:.2f}")
            print(f"  å¹³å‡å»¶è¿Ÿ: {metrics.avg_latency:.2f}ms")
            print(f"  ä¸­æ­¢ç‡: {metrics.abort_rate:.2%}")
            print(f"  å†²çªæ¬¡æ•°: {metrics.conflict_count}")
        return results

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    monitor = IsolationLevelMonitor("dbname=test user=postgres")

    # å¯¹æ¯”ä¸‰ä¸ªéš”ç¦»çº§åˆ«
    results = monitor.compare_levels([
        'READ COMMITTED',
        'REPEATABLE READ',
        'SERIALIZABLE',
    ])

    # ç”ŸæˆæŠ¥å‘Š
    print("\næ€§èƒ½å¯¹æ¯”æŠ¥å‘Š:")
    for level, metrics in results.items():
        print(f"{level}:")
        print(f"  TPS: {metrics.tps:.2f}")
        print(f"  å»¶è¿Ÿ: {metrics.avg_latency:.2f}ms")
        print(f"  ä¸­æ­¢ç‡: {metrics.abort_rate:.2%}")
```

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: åä¾‹ä¸é”™è¯¯é€‰æ‹©åˆ†æã€æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹ã€å®Œæ•´å®ç°ä»£ç 

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md`
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/03-ACIDç†è®ºä¸å®ç°.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/01-å¹¶å‘æ§åˆ¶å†³ç­–æ ‘.md`
