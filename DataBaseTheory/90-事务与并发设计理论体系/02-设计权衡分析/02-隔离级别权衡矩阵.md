# 02 | éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ

> **å†³ç­–å·¥å…·**: æœ¬æ–‡æ¡£æä¾›ç³»ç»ŸåŒ–çš„éš”ç¦»çº§åˆ«é€‰æ‹©æŒ‡å—ï¼ŒåŒ…æ‹¬å¼‚å¸¸ç°è±¡ã€æ€§èƒ½å½±å“ã€åº”ç”¨åœºæ™¯çš„å®Œæ•´å¯¹æ¯”ã€‚

---

## ğŸ“‘ ç›®å½•

- [02 | éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ](#02--éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰](#ä¸€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰)
    - [1.1 SQLæ ‡å‡†å®šä¹‰](#11-sqlæ ‡å‡†å®šä¹‰)
    - [1.2 å¼‚å¸¸ç°è±¡å®šä¹‰](#12-å¼‚å¸¸ç°è±¡å®šä¹‰)
  - [äºŒã€æ ¸å¿ƒæƒè¡¡çŸ©é˜µ](#äºŒæ ¸å¿ƒæƒè¡¡çŸ©é˜µ)
    - [2.1 å¼‚å¸¸ç°è±¡çŸ©é˜µ](#21-å¼‚å¸¸ç°è±¡çŸ©é˜µ)
    - [2.2 æ€§èƒ½å½±å“çŸ©é˜µ](#22-æ€§èƒ½å½±å“çŸ©é˜µ)
  - [ä¸‰ã€PostgreSQLå…·ä½“å®ç°](#ä¸‰postgresqlå…·ä½“å®ç°)
    - [3.1 Read Committed](#31-read-committed)
    - [3.2 Repeatable Read](#32-repeatable-read)
    - [3.3 Serializable (SSI)](#33-serializable-ssi)
  - [å››ã€å¤šç»´åº¦æƒè¡¡åˆ†æ](#å››å¤šç»´åº¦æƒè¡¡åˆ†æ)
    - [4.1 æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿](#41-æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿)
    - [4.2 ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»](#42-ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»)
    - [4.3 å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”](#43-å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”)
  - [äº”ã€åº”ç”¨åœºæ™¯æ˜ å°„](#äº”åº”ç”¨åœºæ™¯æ˜ å°„)
    - [5.1 åœºæ™¯å†³ç­–çŸ©é˜µ](#51-åœºæ™¯å†³ç­–çŸ©é˜µ)
    - [5.2 è¡Œä¸šæœ€ä½³å®è·µ](#52-è¡Œä¸šæœ€ä½³å®è·µ)
  - [å…­ã€æ€§èƒ½è°ƒä¼˜æŒ‡å—](#å…­æ€§èƒ½è°ƒä¼˜æŒ‡å—)
    - [6.1 éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥](#61-éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥)
    - [6.2 é™çº§ç­–ç•¥](#62-é™çº§ç­–ç•¥)
    - [6.3 é‡è¯•ç­–ç•¥](#63-é‡è¯•ç­–ç•¥)
  - [ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­](#ä¸ƒç›‘æ§ä¸è¯Šæ–­)
    - [7.1 å…³é”®ç›‘æ§æŒ‡æ ‡](#71-å…³é”®ç›‘æ§æŒ‡æ ‡)
    - [7.2 è¯Šæ–­æµç¨‹](#72-è¯Šæ–­æµç¨‹)
  - [å…«ã€æ€»ç»“](#å…«æ€»ç»“)
    - [8.1 æ ¸å¿ƒè´¡çŒ®](#81-æ ¸å¿ƒè´¡çŒ®)
    - [8.2 å…³é”®å†³ç­–è§„åˆ™](#82-å…³é”®å†³ç­–è§„åˆ™)
    - [8.3 æœ€ä½³å®è·µ](#83-æœ€ä½³å®è·µ)
  - [ä¹ã€å»¶ä¼¸é˜…è¯»](#ä¹å»¶ä¼¸é˜…è¯»)

---

## ä¸€ã€éš”ç¦»çº§åˆ«å®Œæ•´å®šä¹‰

### 1.1 SQLæ ‡å‡†å®šä¹‰

**å››å¤§éš”ç¦»çº§åˆ«**:

```
Serializable (æœ€å¼º)
    â†“ é˜²æ­¢æ‰€æœ‰å¼‚å¸¸
Repeatable Read
    â†“ é˜²æ­¢ä¸å¯é‡å¤è¯»
Read Committed
    â†“ é˜²æ­¢è„è¯»
Read Uncommitted (æœ€å¼±)
```

### 1.2 å¼‚å¸¸ç°è±¡å®šä¹‰

**P0: è„å†™ (Dirty Write)**:

$$T_1: W(x) \quad T_2: W(x) \quad T_1: Abort \quad \implies \text{Lost Update}$$

**P1: è„è¯» (Dirty Read)**:

$$T_1: W(x) \quad T_2: R(x) \quad T_1: Abort \quad \implies T_2 \text{ reads uncommitted}$$

**P2: ä¸å¯é‡å¤è¯» (Non-repeatable Read)**:

$$T_1: R(x) \quad T_2: W(x), Commit \quad T_1: R(x) \quad \implies \text{Different values}$$

**P3: å¹»è¯» (Phantom Read)**:

$$T_1: R(\text{range}) \quad T_2: Insert, Commit \quad T_1: R(\text{range}) \quad \implies \text{Different rows}$$

**P4: ä¸²è¡ŒåŒ–å¼‚å¸¸ (Serialization Anomaly)**:

$$\exists \text{cycle in serialization graph}$$

---

## äºŒã€æ ¸å¿ƒæƒè¡¡çŸ©é˜µ

### 2.1 å¼‚å¸¸ç°è±¡çŸ©é˜µ

| éš”ç¦»çº§åˆ« | P0 | P1 | P2 | P3 | P4 | è¯´æ˜ |
|---------|----|----|----|----|----|----|
| **Read Uncommitted** | âœ— | âœ— | âœ— | âœ— | âœ— | å…è®¸æ‰€æœ‰å¼‚å¸¸ |
| **Read Committed** | âœ“ | âœ“ | âœ— | âœ— | âœ— | ä»…é˜²æ­¢è„è¯»è„å†™ |
| **Repeatable Read** | âœ“ | âœ“ | âœ“ | ? | âœ— | SQLæ ‡å‡†å…è®¸å¹»è¯» |
| **PostgreSQL RR** | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | æ‰©å±•é˜²æ­¢å¹»è¯» |
| **Serializable** | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | é˜²æ­¢æ‰€æœ‰å¼‚å¸¸ |

**ç¬¦å·è¯´æ˜**:

- âœ“ : é˜²æ­¢æ­¤å¼‚å¸¸
- âœ— : å…è®¸æ­¤å¼‚å¸¸
- ? : ä¾å®ç°è€Œå®š

### 2.2 æ€§èƒ½å½±å“çŸ©é˜µ

| éš”ç¦»çº§åˆ« | ååé‡ | å»¶è¿Ÿ | ä¸­æ­¢ç‡ | é”å¼€é”€ | å­˜å‚¨å¼€é”€ |
|---------|--------|------|--------|--------|---------|
| **Read Committed** | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… (1%) | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| **Repeatable Read** | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† (5%) | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜†â˜† |
| **Serializable** | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜†â˜†â˜†â˜† (15%) | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜†â˜†â˜† |

**é‡åŒ–æ•°æ®** (åŸºå‡†: Read Committed = 1.0):

| æŒ‡æ ‡ | Read Committed | Repeatable Read | Serializable |
|-----|---------------|----------------|--------------|
| **ç›¸å¯¹ååé‡** | 1.0 | 0.8 | 0.5 |
| **ç›¸å¯¹å»¶è¿Ÿ** | 1.0 | 1.2 | 1.8 |
| **ä¸­æ­¢ç‡** | 1% | 5% | 15% |
| **å¿«ç…§åˆ›å»ºå¼€é”€** | ä½ (æ¯è¯­å¥) | ä¸­ (æ¯äº‹åŠ¡) | ä¸­ (æ¯äº‹åŠ¡) |
| **å†²çªæ£€æµ‹å¼€é”€** | ä½ | ä¸­ (å†™å†™) | é«˜ (è¯»å†™ç¯) |

---

## ä¸‰ã€PostgreSQLå…·ä½“å®ç°

### 3.1 Read Committed

**å¿«ç…§ç­–ç•¥**: æ¯æ¡è¯­å¥åˆ›å»ºæ–°å¿«ç…§

```python
class ReadCommittedTransaction:
    def execute_statement(self, sql):
        # æ¯æ¡è¯­å¥è·å–æ–°å¿«ç…§
        snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )

        result = execute_with_snapshot(sql, snapshot)
        return result
```

**è¡Œä¸ºç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡)
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 200 (ä¸å¯é‡å¤è¯»!)
```

**å…è®¸çš„å¼‚å¸¸**:

- âŒ **ä¸å¯é‡å¤è¯»**: åŒä¸€æŸ¥è¯¢è¿”å›ä¸åŒç»“æœ
- âŒ **å¹»è¯»**: èŒƒå›´æŸ¥è¯¢å‡ºç°æ–°è¡Œ

**é€‚ç”¨åœºæ™¯**:

- âœ… Webåº”ç”¨ï¼ˆè¯»æœ€æ–°æ•°æ®ï¼‰
- âœ… APIæœåŠ¡ï¼ˆçŸ­äº‹åŠ¡ï¼‰
- âœ… é«˜å¹¶å‘ç³»ç»Ÿï¼ˆé»˜è®¤é€‰æ‹©ï¼‰

### 3.2 Repeatable Read

**å¿«ç…§ç­–ç•¥**: äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºå¿«ç…§ï¼Œå…¨ç¨‹ä¸å˜

```python
class RepeatableReadTransaction:
    def __init__(self):
        # äº‹åŠ¡å¼€å§‹æ—¶å›ºå®šå¿«ç…§
        self.snapshot = Snapshot(
            xmin=get_oldest_xmin(),
            xmax=get_next_xid(),
            xip=get_active_xids()
        )

    def execute_statement(self, sql):
        # æ‰€æœ‰è¯­å¥ä½¿ç”¨åŒä¸€å¿«ç…§
        result = execute_with_snapshot(sql, self.snapshot)
        return result
```

**è¡Œä¸ºç¤ºä¾‹**:

```sql
-- ä¼šè¯A
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE id = 1;  -- è¿”å› 100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A (åŒä¸€äº‹åŠ¡)
SELECT balance FROM accounts WHERE id = 1;  -- ä»è¿”å› 100 (å¯é‡å¤è¯»!)
```

**å†™å†™å†²çªå¤„ç†**:

```sql
-- ä¼šè¯A
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM accounts WHERE id = 1;  -- å¿«ç…§: balance=100

-- ä¼šè¯B
UPDATE accounts SET balance = 200 WHERE id = 1;
COMMIT;

-- ä¼šè¯A
UPDATE accounts SET balance = 150 WHERE id = 1;
-- ERROR: could not serialize access due to concurrent update
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **ä¸å¯é‡å¤è¯»**: å¿«ç…§å›ºå®š
- âœ… **å¹»è¯»**: PostgreSQLæ‰©å±•ï¼ˆäº‹åŠ¡çº§å¿«ç…§ï¼‰

**é€‚ç”¨åœºæ™¯**:

- âœ… æŠ¥è¡¨æŸ¥è¯¢ï¼ˆéœ€è¦ä¸€è‡´æ€§å¿«ç…§ï¼‰
- âœ… æ‰¹å¤„ç†ï¼ˆé•¿æ—¶é—´è¿è¡Œï¼‰
- âœ… æ•°æ®åˆ†æï¼ˆä¸€è‡´æ€§è§†å›¾ï¼‰

### 3.3 Serializable (SSI)

**å¿«ç…§ç­–ç•¥**: åŒRepeatable Read + ä¾èµ–å›¾æ£€æµ‹

```python
class SerializableTransaction:
    def __init__(self):
        self.snapshot = get_snapshot()
        self.predicate_locks = []  # SIREADé”
        self.dependencies = []      # ä¾èµ–è¾¹

    def execute_select(self, sql):
        result = execute_with_snapshot(sql, self.snapshot)

        # è®°å½•è°“è¯é”
        predicate = extract_predicate(sql)
        self.predicate_locks.append(predicate)

        # æ£€æŸ¥å†™ä¾èµ–
        for writer in get_concurrent_writers():
            if conflicts(writer, predicate):
                self.dependencies.append((writer, self, 'rw'))

        return result

    def execute_modify(self, sql):
        # æ£€æŸ¥è¯»ä¾èµ–
        for reader in get_concurrent_readers():
            if conflicts(sql, reader.predicate_locks):
                self.dependencies.append((self, reader, 'wr'))

        # æ£€æµ‹å±é™©ç»“æ„
        if has_cycle(self.dependencies):
            raise SerializationError("Dangerous structure detected")

        # æ‰§è¡Œä¿®æ”¹
        return execute_with_lock(sql)
```

**æ£€æµ‹ç¤ºä¾‹**:

```sql
-- äº‹åŠ¡T1
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT COUNT(*) FROM orders WHERE amount > 100;  -- è¯»èŒƒå›´

-- äº‹åŠ¡T2
INSERT INTO orders VALUES (150);  -- å†™å…¥èŒƒå›´å†…

-- äº‹åŠ¡T1æäº¤
COMMIT;
-- æ£€æµ‹åˆ°: T1 è¯» â†’ T2 å†™ â†’ T1 æäº¤
-- å¯èƒ½ä¸­æ­¢T1æˆ–T2ï¼ˆå…ˆæäº¤å…ˆä¸­æ­¢ï¼‰
```

**é˜²æ­¢çš„å¼‚å¸¸**:

- âœ… **æ‰€æœ‰å¼‚å¸¸**: ç­‰ä»·äºä¸²è¡Œæ‰§è¡Œ

**é€‚ç”¨åœºæ™¯**:

- âœ… é‡‘èäº¤æ˜“ï¼ˆä¸¥æ ¼ä¸€è‡´æ€§ï¼‰
- âœ… åº“å­˜æ‰£å‡ï¼ˆé˜²æ­¢è¶…å–ï¼‰
- âœ… å…³é”®ä¸šåŠ¡ï¼ˆé›¶å®¹é”™ï¼‰

---

## å››ã€å¤šç»´åº¦æƒè¡¡åˆ†æ

### 4.1 æ€§èƒ½-ä¸€è‡´æ€§æ›²çº¿

```text
æ€§èƒ½ (TPS)
  â†‘
  â”‚  RC â—
  â”‚      \
  â”‚       \  RR â—
  â”‚            \
  â”‚             \
  â”‚              \  Serializable â—
  â”‚               \
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¸€è‡´æ€§å¼ºåº¦
```

**é‡åŒ–å…³ç³»**:

$$TPS_{RC} : TPS_{RR} : TPS_{Ser} \approx 10 : 8 : 5$$

### 4.2 ä¸­æ­¢ç‡-å¹¶å‘åº¦å…³ç³»

```
ä¸­æ­¢ç‡ (%)
  â†‘
  â”‚                    Serializable
  â”‚                 ï¼
  â”‚              ï¼
  â”‚           ï¼  Repeatable Read
  â”‚        ï¼
  â”‚     ï¼ Read Committed
  â”‚  ï¼
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å¹¶å‘åº¦
```

**å®éªŒæ•°æ®** (TPC-CåŸºå‡†):

| å¹¶å‘åº¦ | RCä¸­æ­¢ç‡ | RRä¸­æ­¢ç‡ | Serä¸­æ­¢ç‡ |
|-------|---------|---------|----------|
| 10 | 0.1% | 0.5% | 2% |
| 100 | 0.5% | 3% | 12% |
| 1000 | 2% | 10% | 35% |

### 4.3 å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”

**P50å»¶è¿Ÿ** (ms):

| éš”ç¦»çº§åˆ« | SELECT | UPDATE | å¤æ‚æŸ¥è¯¢ |
|---------|--------|--------|---------|
| RC | 1 | 5 | 50 |
| RR | 1.2 | 6 | 60 |
| Ser | 1.5 | 10 | 100 |

**P99å»¶è¿Ÿ** (ms):

| éš”ç¦»çº§åˆ« | SELECT | UPDATE | å¤æ‚æŸ¥è¯¢ |
|---------|--------|--------|---------|
| RC | 10 | 50 | 500 |
| RR | 15 | 80 | 800 |
| Ser | 30 | 200 | 2000 |

---

## äº”ã€åº”ç”¨åœºæ™¯æ˜ å°„

### 5.1 åœºæ™¯å†³ç­–çŸ©é˜µ

| ä¸šåŠ¡åœºæ™¯ | æ¨èçº§åˆ« | ç†ç”± | å¤‡é€‰æ–¹æ¡ˆ |
|---------|---------|------|---------|
| **Web API** | Read Committed | é«˜å¹¶å‘ã€çŸ­äº‹åŠ¡ | - |
| **æŠ¥è¡¨æŸ¥è¯¢** | Repeatable Read | ä¸€è‡´æ€§å¿«ç…§ | - |
| **é‡‘èè½¬è´¦** | Serializable | é›¶å®¹é”™ | RR + åº”ç”¨å±‚æ£€æŸ¥ |
| **åº“å­˜æ‰£å‡** | Serializable | é˜²æ­¢è¶…å– | RC + ä¹è§‚é” |
| **ç”¨æˆ·ç™»å½•** | Read Committed | è¯»æœ€æ–°å¯†ç  | - |
| **è®¢å•æŸ¥è¯¢** | Read Committed | å®æ—¶æ•°æ® | - |
| **æ•°æ®åˆ†æ** | Repeatable Read | ä¸€è‡´æ€§ç»Ÿè®¡ | - |
| **é…ç½®ç®¡ç†** | Repeatable Read | é¿å…é…ç½®ä¸ä¸€è‡´ | - |
| **å®¡è®¡æ—¥å¿—** | Read Committed | è¿½åŠ å†™ | - |
| **ç§’æ€ç³»ç»Ÿ** | Read Committed | é«˜å¹¶å‘ | + åº”ç”¨å±‚é™æµ |

### 5.2 è¡Œä¸šæœ€ä½³å®è·µ

**é‡‘èè¡Œä¸š**:

```sql
-- è½¬è´¦: å¼ºä¸€è‡´æ€§
BEGIN ISOLATION LEVEL SERIALIZABLE;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;

-- æŸ¥è¯¢ä½™é¢: å¯é‡å¤è¯»
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT SUM(balance) FROM accounts WHERE user_id = 123;
```

**ç”µå•†è¡Œä¸š**:

```sql
-- ä¸‹å•: è¯»å·²æäº¤ï¼ˆé«˜å¹¶å‘ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
INSERT INTO orders (...) VALUES (...);
UPDATE inventory SET stock = stock - 1 WHERE product_id = 456
  AND stock > 0;  -- ä¹è§‚é”
COMMIT;

-- æŠ¥è¡¨: å¯é‡å¤è¯»
BEGIN ISOLATION LEVEL REPEATABLE READ;
SELECT DATE(created_at), COUNT(*) FROM orders
GROUP BY DATE(created_at);
```

**ç¤¾äº¤ç½‘ç»œ**:

```sql
-- ç‚¹èµ: è¯»å·²æäº¤ï¼ˆæœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
INSERT INTO likes (post_id, user_id) VALUES (789, 123)
ON CONFLICT DO NOTHING;
COMMIT;

-- æ—¶é—´çº¿æŸ¥è¯¢: è¯»å·²æäº¤ï¼ˆè¯»æœ€æ–°ï¼‰
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT * FROM posts WHERE user_id IN (following_list)
ORDER BY created_at DESC LIMIT 20;
```

---

## å…­ã€æ€§èƒ½è°ƒä¼˜æŒ‡å—

### 6.1 éš”ç¦»çº§åˆ«åˆ‡æ¢ç­–ç•¥

**åŠ¨æ€åˆ‡æ¢**:

```python
class AdaptiveIsolationLevel:
    def choose_level(self, operation_type, workload):
        if operation_type == 'READ_ONLY':
            # åªè¯»äº‹åŠ¡: RCæˆ–RR
            if workload.consistency_required:
                return 'REPEATABLE_READ'
            else:
                return 'READ_COMMITTED'

        elif operation_type == 'WRITE_HEAVY':
            # å†™å¯†é›†: RCï¼ˆé™ä½å†²çªï¼‰
            return 'READ_COMMITTED'

        elif operation_type == 'CRITICAL':
            # å…³é”®ä¸šåŠ¡: Serializable
            return 'SERIALIZABLE'

        else:
            # é»˜è®¤
            return 'READ_COMMITTED'
```

### 6.2 é™çº§ç­–ç•¥

**ä»Serializableé™çº§åˆ°RR**:

```python
def execute_with_fallback(tx_func):
    # å…ˆå°è¯•Serializable
    try:
        return execute_transaction(tx_func, 'SERIALIZABLE')
    except SerializationError:
        # é™çº§åˆ°Repeatable Read
        logger.warning("Serializable failed, fallback to RR")
        try:
            return execute_transaction(tx_func, 'REPEATABLE_READ')
        except SerializationError:
            # æœ€ç»ˆé™çº§åˆ°Read Committed
            logger.error("RR failed, fallback to RC")
            return execute_transaction(tx_func, 'READ_COMMITTED')
```

**æƒè¡¡**:

- âœ… æé«˜æˆåŠŸç‡
- âŒ å¯èƒ½ç‰ºç‰²ä¸€è‡´æ€§ä¿è¯

### 6.3 é‡è¯•ç­–ç•¥

**æŒ‰éš”ç¦»çº§åˆ«å®šåˆ¶é‡è¯•**:

```python
def retry_config(isolation_level):
    if isolation_level == 'READ_COMMITTED':
        return RetryPolicy(
            max_attempts=1,      # å¾ˆå°‘éœ€è¦é‡è¯•
            base_delay=0,
            max_delay=0
        )
    elif isolation_level == 'REPEATABLE_READ':
        return RetryPolicy(
            max_attempts=3,      # ä¸­ç­‰é‡è¯•
            base_delay=100,      # ms
            max_delay=1000
        )
    elif isolation_level == 'SERIALIZABLE':
        return RetryPolicy(
            max_attempts=5,      # é«˜é‡è¯•æ¬¡æ•°
            base_delay=200,
            max_delay=5000
        )
```

---

## ä¸ƒã€ç›‘æ§ä¸è¯Šæ–­

### 7.1 å…³é”®ç›‘æ§æŒ‡æ ‡

**ç³»ç»Ÿè§†å›¾**:

```sql
-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SHOW default_transaction_isolation;

-- æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€
SELECT
    pid,
    usename,
    state,
    backend_xid,
    backend_xmin,
    query
FROM pg_stat_activity
WHERE backend_xid IS NOT NULL;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked.pid AS blocked_pid,
    blocked.query AS blocked_query,
    blocker.pid AS blocker_pid,
    blocker.query AS blocker_query
FROM pg_stat_activity AS blocked
JOIN pg_stat_activity AS blocker
  ON blocker.pid = ANY(pg_blocking_pids(blocked.pid));
```

**æ€§èƒ½æŒ‡æ ‡**:

| æŒ‡æ ‡ | SQL | å‘Šè­¦é˜ˆå€¼ |
|-----|-----|---------|
| **ä¸­æ­¢ç‡** | `pg_stat_database.xact_rollback / xact_commit` | >5% |
| **é”ç­‰å¾…æ—¶é•¿** | `pg_stat_activity.wait_event = 'Lock'` | >1s |
| **é•¿äº‹åŠ¡** | `NOW() - xact_start` | >10min |
| **æ­»å…ƒç»„æ¯”ä¾‹** | `n_dead_tup / n_live_tup` | >10% |

### 7.2 è¯Šæ–­æµç¨‹

```
æ€§èƒ½é—®é¢˜
    â†“
æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
    â†“
ä¸­æ­¢ç‡é«˜ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ é™ä½éš”ç¦»çº§åˆ«
    â”‚      æˆ–å‡å°äº‹åŠ¡ç²’åº¦
    â†“
é”ç­‰å¾…å¤šï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ£€æŸ¥æ…¢æŸ¥è¯¢
    â”‚      ä¼˜åŒ–ç´¢å¼•
    â†“
é•¿äº‹åŠ¡å¤šï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ‹†åˆ†äº‹åŠ¡
    â”‚      æˆ–å¼‚æ­¥å¤„ç†
    â†“
æ­»å…ƒç»„å¤šï¼Ÿ
    â””â”€ æ˜¯ â†’ è°ƒæ•´VACUUMç­–ç•¥
           å¢åŠ autovacuum_workers
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè´¡çŒ®

**ç†è®ºè´¡çŒ®**:

1. **å®Œæ•´çš„å¼‚å¸¸ç°è±¡å®šä¹‰**ï¼ˆP0-P4ï¼‰
2. **å¤šç»´åº¦æƒè¡¡çŸ©é˜µ**ï¼ˆæ€§èƒ½ã€ä¸€è‡´æ€§ã€é€‚ç”¨åœºæ™¯ï¼‰
3. **é‡åŒ–æ€§èƒ½æ¨¡å‹**ï¼ˆååé‡ã€å»¶è¿Ÿã€ä¸­æ­¢ç‡ï¼‰

**å·¥ç¨‹ä»·å€¼**:

1. **åœºæ™¯å†³ç­–çŸ©é˜µ**ï¼ˆ10+ä¸šåŠ¡åœºæ™¯ï¼‰
2. **åŠ¨æ€åˆ‡æ¢ç­–ç•¥**ï¼ˆè‡ªé€‚åº”é€‰æ‹©ï¼‰
3. **ç›‘æ§è¯Šæ–­æµç¨‹**ï¼ˆé—®é¢˜å®šä½ï¼‰

### 8.2 å…³é”®å†³ç­–è§„åˆ™

**è§„åˆ™1**: é»˜è®¤ä½¿ç”¨Read Committed

$$\text{Default} \implies \text{Read Committed (é«˜æ€§èƒ½)}$$

**è§„åˆ™2**: éœ€è¦ä¸€è‡´æ€§å¿«ç…§æ—¶ä½¿ç”¨Repeatable Read

$$\text{Consistent Snapshot Required} \implies \text{Repeatable Read}$$

**è§„åˆ™3**: é‡‘è/å…³é”®ä¸šåŠ¡ä½¿ç”¨Serializable

$$\text{Zero Tolerance} \implies \text{Serializable}$$

**è§„åˆ™4**: æ€§èƒ½ä¼˜å…ˆæ—¶è€ƒè™‘é™çº§

$$\text{Abort Rate} > 10\% \implies \text{Consider Downgrade}$$

### 8.3 æœ€ä½³å®è·µ

**1. çŸ­äº‹åŠ¡ä¼˜å…ˆ**:

$$\text{Transaction Time} < 1s \implies \text{Lower Conflict}$$

**2. æ˜¾å¼åŠ é”**:

```sql
-- æå‰é”å®šçƒ­ç‚¹è¡Œ
SELECT * FROM inventory WHERE product_id = 123 FOR UPDATE;
```

**3. ç›‘æ§é©±åŠ¨**:

```sql
-- å®šæœŸæ£€æŸ¥ä¸­æ­¢ç‡
SELECT
    datname,
    xact_rollback::float / NULLIF(xact_commit + xact_rollback, 0) AS abort_rate
FROM pg_stat_database
WHERE abort_rate > 0.05;  -- å‘Šè­¦é˜ˆå€¼5%
```

**4. åº”ç”¨å±‚é‡è¯•**:

```python
@retry(max_attempts=3, backoff=exponential)
def critical_transaction():
    with db.transaction(isolation='SERIALIZABLE'):
        # ä¸šåŠ¡é€»è¾‘
        ...
```

---

## ä¹ã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Berenson, H., et al. (1995). "A Critique of ANSI SQL Isolation Levels"
- Adya, A. (1999). "Weak Consistency: A Generalized Theory"

**å®ç°ç»†èŠ‚**:

- PostgreSQLéš”ç¦»çº§åˆ«å®ç°: `src/backend/storage/lmgr/predicate.c`
- SSIè®ºæ–‡: Ports & Grittner (2012)

**æ‰©å±•æ–¹å‘**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md` â†’ MVCCè¯¦ç»†æœºåˆ¶
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md` â†’ é‡åŒ–æ€§èƒ½å½±å“
- `06-æ€§èƒ½åˆ†æ/04-é‡åŒ–å¯¹æ¯”å®éªŒ.md` â†’ å®æµ‹æ•°æ®

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-05
**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md`
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/03-ACIDç†è®ºä¸å®ç°.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/01-å¹¶å‘æ§åˆ¶å†³ç­–æ ‘.md`
