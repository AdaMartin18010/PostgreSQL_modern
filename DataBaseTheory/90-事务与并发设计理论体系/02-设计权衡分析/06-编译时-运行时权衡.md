# 06 | ç¼–è¯‘æ—¶-è¿è¡Œæ—¶æƒè¡¡

> **å†³ç­–å·¥å…·**: æœ¬æ–‡æ¡£å¯¹æ¯”ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶å¹¶å‘æ§åˆ¶çš„æƒè¡¡ï¼Œé‡ç‚¹åˆ†æRustæ‰€æœ‰æƒ vs ä¼ ç»Ÿé”æœºåˆ¶ã€‚

---

## ğŸ“‘ ç›®å½•

- [06 | ç¼–è¯‘æ—¶-è¿è¡Œæ—¶æƒè¡¡](#06--ç¼–è¯‘æ—¶-è¿è¡Œæ—¶æƒè¡¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æƒè¡¡æ¡†æ¶](#ä¸€æƒè¡¡æ¡†æ¶)
    - [1.1 ç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶](#11-ç¼–è¯‘æ—¶-vs-è¿è¡Œæ—¶)
    - [1.2 æƒè¡¡ç©ºé—´](#12-æƒè¡¡ç©ºé—´)
  - [äºŒã€Rust vs C++å¯¹æ¯”](#äºŒrust-vs-cå¯¹æ¯”)
    - [2.1 å†…å­˜å®‰å…¨](#21-å†…å­˜å®‰å…¨)
    - [2.2 å¹¶å‘åŸè¯­å¯¹æ¯”](#22-å¹¶å‘åŸè¯­å¯¹æ¯”)
    - [2.3 æ€§èƒ½å¯¹æ¯”](#23-æ€§èƒ½å¯¹æ¯”)
  - [ä¸‰ã€Rust vs Java/Goå¯¹æ¯”](#ä¸‰rust-vs-javagoå¯¹æ¯”)
    - [3.1 å†…å­˜ç®¡ç†](#31-å†…å­˜ç®¡ç†)
    - [3.2 å¹¶å‘æ¨¡å‹](#32-å¹¶å‘æ¨¡å‹)
    - [3.3 æ€§èƒ½å¯¹æ¯”](#33-æ€§èƒ½å¯¹æ¯”)
  - [å››ã€æ€§èƒ½é‡åŒ–åˆ†æ](#å››æ€§èƒ½é‡åŒ–åˆ†æ)
    - [4.1 é›¶æˆæœ¬æŠ½è±¡éªŒè¯](#41-é›¶æˆæœ¬æŠ½è±¡éªŒè¯)
    - [4.2 è¿è¡Œæ—¶å¼€é”€å¯¹æ¯”](#42-è¿è¡Œæ—¶å¼€é”€å¯¹æ¯”)
    - [4.3 å­¦ä¹ æ›²çº¿é‡åŒ–](#43-å­¦ä¹ æ›²çº¿é‡åŒ–)
  - [äº”ã€å¼€å‘æ•ˆç‡æƒè¡¡](#äº”å¼€å‘æ•ˆç‡æƒè¡¡)
    - [5.1 å¼€å‘æ—¶é—´å¯¹æ¯”](#51-å¼€å‘æ—¶é—´å¯¹æ¯”)
    - [5.2 ç»´æŠ¤æˆæœ¬å¯¹æ¯”](#52-ç»´æŠ¤æˆæœ¬å¯¹æ¯”)
  - [å…­ã€é€‚ç”¨åœºæ™¯å†³ç­–](#å…­é€‚ç”¨åœºæ™¯å†³ç­–)
    - [6.1 å†³ç­–çŸ©é˜µ](#61-å†³ç­–çŸ©é˜µ)
    - [6.2 å†³ç­–æ ‘](#62-å†³ç­–æ ‘)
    - [6.3 æŠ€æœ¯æ ˆå»ºè®®](#63-æŠ€æœ¯æ ˆå»ºè®®)
  - [ä¸ƒã€æ··åˆç­–ç•¥](#ä¸ƒæ··åˆç­–ç•¥)
    - [7.1 Rust + Cé›†æˆ](#71-rust--cé›†æˆ)
    - [7.2 æ¸è¿›å¼è¿ç§»](#72-æ¸è¿›å¼è¿ç§»)
  - [å…«ã€å®è·µæ¡ˆä¾‹](#å…«å®è·µæ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: æ•°æ®åº“è¿æ¥æ± ](#æ¡ˆä¾‹1-æ•°æ®åº“è¿æ¥æ± )
    - [æ¡ˆä¾‹2: é«˜æ€§èƒ½è®¡æ•°å™¨](#æ¡ˆä¾‹2-é«˜æ€§èƒ½è®¡æ•°å™¨)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®ç»“è®º](#92-å…³é”®ç»“è®º)
    - [9.3 é€‰æ‹©å»ºè®®](#93-é€‰æ‹©å»ºè®®)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 Rustæ‰€æœ‰æƒæ£€æŸ¥å™¨æ¨¡æ‹Ÿå®ç°](#111-rustæ‰€æœ‰æƒæ£€æŸ¥å™¨æ¨¡æ‹Ÿå®ç°)
    - [11.2 è¿è¡Œæ—¶é”ç®¡ç†å™¨å®ç°](#112-è¿è¡Œæ—¶é”ç®¡ç†å™¨å®ç°)
  - [åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åäºŒå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [12.1 æ¡ˆä¾‹: æ•°æ®åº“è¿æ¥æ± ï¼ˆRust vs Goï¼‰](#121-æ¡ˆä¾‹-æ•°æ®åº“è¿æ¥æ± rust-vs-go)
    - [12.2 æ¡ˆä¾‹: é«˜å¹¶å‘è®¡æ•°å™¨ï¼ˆç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶ï¼‰](#122-æ¡ˆä¾‹-é«˜å¹¶å‘è®¡æ•°å™¨ç¼–è¯‘æ—¶-vs-è¿è¡Œæ—¶)
  - [åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åä¸‰åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: è¯¯ç”¨Unsafeç»•è¿‡æ£€æŸ¥](#åä¾‹1-è¯¯ç”¨unsafeç»•è¿‡æ£€æŸ¥)
    - [åä¾‹2: è¿‡åº¦ä¾èµ–è¿è¡Œæ—¶æ£€æŸ¥](#åä¾‹2-è¿‡åº¦ä¾èµ–è¿è¡Œæ—¶æ£€æŸ¥)

---

## ä¸€ã€æƒè¡¡æ¡†æ¶

### 1.1 ç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶

**æ ¸å¿ƒå·®å¼‚**:

| ç»´åº¦ | ç¼–è¯‘æ—¶ (Rust) | è¿è¡Œæ—¶ (C++/Java) |
|-----|--------------|------------------|
| **æ£€æŸ¥æ—¶æœº** | ç¼–è¯‘æœŸ | è¿è¡ŒæœŸ |
| **é”™è¯¯æ£€æµ‹** | ç¼–è¯‘å¤±è´¥ | å´©æºƒ/æ•°æ®ç«äº‰ |
| **æ€§èƒ½å¼€é”€** | é›¶ | 5-50% (å·¥å…·) |
| **çµæ´»æ€§** | å—é™ï¼ˆå€Ÿç”¨è§„åˆ™ï¼‰ | é«˜ï¼ˆç¨‹åºå‘˜è‡ªç”±ï¼‰ |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ |
| **å®‰å…¨ä¿è¯** | 100%ï¼ˆç±»å‹ç³»ç»Ÿï¼‰ | ä¾èµ–ç¨‹åºå‘˜ |

### 1.2 æƒè¡¡ç©ºé—´

```
å®‰å…¨æ€§
  â†‘
  â”‚     Rust â—
  â”‚         /
  â”‚        /
  â”‚       /  Java (GC) â—
  â”‚      /        /
  â”‚     /        /
  â”‚    /  C++ â—/
  â”‚   /      /
  â”‚  /      /
  â”‚ /      /
  â”‚/      /
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ€§èƒ½
    ä½         é«˜

çµæ´»æ€§ç»´åº¦ï¼ˆå‚ç›´ï¼‰:
C++ (æœ€çµæ´») > Java > Rust (æœ€å—é™)
```

---

## äºŒã€Rust vs C++å¯¹æ¯”

### 2.1 å†…å­˜å®‰å…¨

**C++é—®é¢˜**:

```cpp
// æ‚¬å‚æŒ‡é’ˆ
int* ptr = new int(42);
delete ptr;
int x = *ptr;  // âŒ UB: æœªå®šä¹‰è¡Œä¸º

// æ•°æ®ç«äº‰
int counter = 0;
std::thread t1([&]{ counter++; });
std::thread t2([&]{ counter++; });
// âŒ æ•°æ®ç«äº‰ï¼Œç»“æœä¸ç¡®å®š
```

**Rustè§£å†³**:

```rust
// ç¼–è¯‘æœŸæ‹’ç»æ‚¬å‚æŒ‡é’ˆ
let ptr = Box::new(42);
drop(ptr);
// let x = *ptr;  // âŒ ç¼–è¯‘é”™è¯¯: ptrå·²å¤±æ•ˆ

// ç¼–è¯‘æœŸæ‹’ç»æ•°æ®ç«äº‰
let mut counter = 0;
// thread::spawn(|| { counter += 1; });  // âŒ ç¼–è¯‘é”™è¯¯
// æ­£ç¡®åšæ³•: ä½¿ç”¨Arc<Mutex<T>>
```

**ä»£ä»·å¯¹æ¯”**:

| é—®é¢˜ç±»å‹ | C++ | Rust |
|---------|-----|------|
| **å¼€å‘é˜¶æ®µæ£€æµ‹** | è¿è¡Œæ—¶/æµ‹è¯• | ç¼–è¯‘æœŸ |
| **å·¥å…·å¼€é”€** | ThreadSanitizer (20-50%) | é›¶ |
| **è¦†ç›–ç‡** | å–å†³äºæµ‹è¯• | 100% |
| **ä¿®å¤æˆæœ¬** | é«˜ï¼ˆéœ€å›æº¯ï¼‰ | ä½ï¼ˆç«‹å³åé¦ˆï¼‰ |

### 2.2 å¹¶å‘åŸè¯­å¯¹æ¯”

| åŸè¯­ | C++ | Rust | å·®å¼‚ |
|-----|-----|------|------|
| **Mutex** | `std::mutex` | `Mutex<T>` | Rustç»‘å®šæ•°æ® |
| **RwLock** | `std::shared_mutex` | `RwLock<T>` | Rustç±»å‹å®‰å…¨ |
| **Atomic** | `std::atomic<T>` | `Atomic<T>` | ç›¸ä¼¼ |
| **RAII** | æ‰‹åŠ¨æˆ–æ™ºèƒ½æŒ‡é’ˆ | è‡ªåŠ¨ï¼ˆæ‰€æœ‰æƒï¼‰ | Rustç¼–è¯‘å™¨ä¿è¯ |

**Rustä¼˜åŠ¿**:

```rust
// Rust: é”ä¸æ•°æ®ç»‘å®š
let data = Mutex::new(vec![1, 2, 3]);

fn process(data: &Mutex<Vec<i32>>) {
    let guard = data.lock().unwrap();
    // guardæ˜¯Vec<i32>çš„ç‹¬å å¼•ç”¨
    // ç¼–è¯‘å™¨ä¿è¯: æŒæœ‰é”æ—¶æ‰èƒ½è®¿é—®æ•°æ®
}

// C++: é”ä¸æ•°æ®åˆ†ç¦»ï¼ˆæ˜“é”™ï¼‰
std::mutex mtx;
std::vector<int> data{1, 2, 3};

void process() {
    mtx.lock();
    // å¿˜è®°åŠ é”ä¹Ÿèƒ½è®¿é—®dataï¼ âŒ
    data.push_back(4);  // å¯èƒ½æ•°æ®ç«äº‰
    mtx.unlock();
}
```

### 2.3 æ€§èƒ½å¯¹æ¯”

**åŸºå‡†æµ‹è¯•** (1äº¿æ¬¡æ“ä½œ):

| æ“ä½œ | C++ | Rust | å·®å¼‚ |
|-----|-----|------|------|
| Atomic CAS | 10ns | 10ns | ç›¸åŒ |
| Mutex lock (æ— ç«äº‰) | 50ns | 50ns | ç›¸åŒ |
| Mutex lock (æœ‰ç«äº‰) | 500ns | 500ns | ç›¸åŒ |
| å¼•ç”¨è®¡æ•° | 30ns (shared_ptr) | 10ns (Arc) | Rustå¿«3Ã— |

**ç»“è®º**: ç›¸åŒçš„runtimeåŸè¯­æ€§èƒ½ç›¸å½“ï¼ŒRustç¼–è¯‘æœŸæ£€æŸ¥æ— é¢å¤–å¼€é”€

---

## ä¸‰ã€Rust vs Java/Goå¯¹æ¯”

### 3.1 å†…å­˜ç®¡ç†

| ç»´åº¦ | Rust | Java/Go |
|-----|------|---------|
| **ç®¡ç†æ–¹å¼** | ç¼–è¯‘æœŸRAII | GCåƒåœ¾å›æ”¶ |
| **åœé¡¿** | æ—  | æœ‰ï¼ˆms-ç§’çº§ï¼‰ |
| **ååé‡** | é«˜ | ä¸­ |
| **å»¶è¿Ÿå¯é¢„æµ‹æ€§** | é«˜ | ä½ï¼ˆGCä¸ç¡®å®šï¼‰ |
| **å†…å­˜å ç”¨** | ä½ | é«˜ï¼ˆGCå…ƒæ•°æ®ï¼‰ |

**GCåœé¡¿ç¤ºä¾‹**:

```
Javaåº”ç”¨å»¶è¿Ÿåˆ†å¸ƒ:
P50: 10ms
P99: 50ms
P99.9: 500ms  â† GCåœé¡¿
P99.99: 2000ms  â† Full GC
```

### 3.2 å¹¶å‘æ¨¡å‹

**Java**:

```java
// é” + synchronized
public class Counter {
    private int count = 0;

    public synchronized void increment() {
        count++;  // synchronizedä¿æŠ¤
    }
}
```

**Rust**:

```rust
// æ‰€æœ‰æƒ + ç±»å‹ç³»ç»Ÿ
pub struct Counter {
    count: Mutex<i32>,
}

impl Counter {
    pub fn increment(&self) {
        let mut guard = self.count.lock().unwrap();
        *guard += 1;
    }  // è‡ªåŠ¨è§£é”
}
```

**å·®å¼‚**:

- Java: è¿è¡Œæ—¶æ£€æŸ¥ï¼Œå¯èƒ½å¿˜è®°åŠ é”
- Rust: ç¼–è¯‘æœŸå¼ºåˆ¶ï¼Œæ— æ³•å¿˜è®°

### 3.3 æ€§èƒ½å¯¹æ¯”

**WebæœåŠ¡åŸºå‡†** (10Kå¹¶å‘):

| è¯­è¨€ | TPS | P99å»¶è¿Ÿ | å†…å­˜ | CPU |
|-----|-----|---------|------|-----|
| **Rust** | 100K | 10ms | 200MB | 50% |
| **Go** | 80K | 15ms | 500MB | 60% |
| **Java** | 70K | 30ms | 1GB | 70% |

**Rustä¼˜åŠ¿åœºæ™¯**:

- âœ… å»¶è¿Ÿæ•æ„Ÿï¼ˆé‡‘èäº¤æ˜“ï¼‰
- âœ… å†…å­˜å—é™ï¼ˆåµŒå…¥å¼ï¼‰
- âœ… é•¿æœŸè¿è¡Œï¼ˆæ— GCåœé¡¿ï¼‰

**Java/Goä¼˜åŠ¿åœºæ™¯**:

- âœ… å¿«é€Ÿå¼€å‘ï¼ˆç”Ÿæ€ä¸°å¯Œï¼‰
- âœ… å›¢é˜Ÿç†Ÿæ‚‰åº¦é«˜
- âœ… å†…å­˜å……è¶³ç¯å¢ƒ

---

## å››ã€æ€§èƒ½é‡åŒ–åˆ†æ

### 4.1 é›¶æˆæœ¬æŠ½è±¡éªŒè¯

**å®éªŒ**: æ‰‹å†™æ±‡ç¼– vs Rustç¼–è¯‘è¾“å‡º

```rust
// Rustä»£ç 
fn sum(arr: &[i32]) -> i32 {
    arr.iter().sum()
}

// ç¼–è¯‘åæ±‡ç¼–ï¼ˆä¼˜åŒ–ï¼‰
// ç­‰ä»·äºæ‰‹å†™çš„é«˜æ•ˆå¾ªç¯
// æ— é¢å¤–æŠ½è±¡å¼€é”€
```

**ç»“è®º**: RustæŠ½è±¡ç¼–è¯‘åä¸æ‰‹å†™Cç›¸åŒ

### 4.2 è¿è¡Œæ—¶å¼€é”€å¯¹æ¯”

**ThreadSanitizer (C++)**:

| æŒ‡æ ‡ | æ— å·¥å…· | ThreadSanitizer |
|-----|-------|----------------|
| TPS | 10K | 5K (-50%) |
| å»¶è¿Ÿ | 10ms | 20ms (+100%) |
| å†…å­˜ | 1GB | 5GB (+400%) |

**Rustå€Ÿç”¨æ£€æŸ¥å™¨**:

| æŒ‡æ ‡ | ç¼–è¯‘æ—¶é—´ | è¿è¡Œæ—¶ |
|-----|---------|--------|
| æ£€æŸ¥å¼€é”€ | +30% | 0% |
| TPS | - | 10K (æ— å½±å“) |
| å»¶è¿Ÿ | - | 10ms (æ— å½±å“) |
| å†…å­˜ | - | 1GB (æ— å½±å“) |

**ç»“è®º**: Rustç”¨**ç¼–è¯‘æ—¶é—´**æ¢**è¿è¡Œæ—¶æ€§èƒ½**

### 4.3 å­¦ä¹ æ›²çº¿é‡åŒ–

**ä¸Šæ‰‹æ—¶é—´ä¼°ç®—**:

| è¯­è¨€ | åŸºç¡€æŒæ¡ | å¹¶å‘æŒæ¡ | ç”Ÿäº§å¯ç”¨ |
|-----|---------|---------|---------|
| **C++** | 1å‘¨ | 1ä¸ªæœˆ | 3-6ä¸ªæœˆ |
| **Java** | 3å¤© | 2å‘¨ | 1-2ä¸ªæœˆ |
| **Go** | 1å¤© | 1å‘¨ | 2-4å‘¨ |
| **Rust** | 2å‘¨ | 2ä¸ªæœˆ | 4-8ä¸ªæœˆ |

**Rusté™¡å³­åŸå› **:

- æ–°æ¦‚å¿µå¤šï¼ˆæ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸï¼‰
- ç¼–è¯‘å™¨è¦æ±‚ä¸¥æ ¼
- é”™è¯¯ä¿¡æ¯å¤æ‚

**æŠ•èµ„å›æŠ¥**:

- é•¿æœŸé¡¹ç›®: å€¼å¾—ï¼ˆæ— å†…å­˜bugï¼‰
- çŸ­æœŸé¡¹ç›®: è€ƒè™‘å…¶ä»–è¯­è¨€

---

## äº”ã€å¼€å‘æ•ˆç‡æƒè¡¡

### 5.1 å¼€å‘æ—¶é—´å¯¹æ¯”

**ç›¸åŒåŠŸèƒ½å®ç°æ—¶é—´**:

| ä»»åŠ¡ | C++ | Rust | Java | Go |
|-----|-----|------|------|-----|
| HTTPæœåŠ¡å™¨ | 2å‘¨ | 3å‘¨ | 1å‘¨ | 3å¤© |
| å¹¶å‘å“ˆå¸Œè¡¨ | 1å‘¨ | 2å‘¨ | 3å¤© | 3å¤© |
| æ•°æ®åº“å®¢æˆ·ç«¯ | 1å‘¨ | 1å‘¨ | 3å¤© | 3å¤© |

**Rustæ…¢çš„åŸå› **:

- ä¸ç¼–è¯‘å™¨"æ–—äº‰"
- é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼ˆæ»¡è¶³å€Ÿç”¨è§„åˆ™ï¼‰

**Rustå¿«çš„æƒ…å†µ**:

- æ€§èƒ½æ•æ„Ÿä»£ç ï¼ˆæ— éœ€è¿è¡Œæ—¶è°ƒä¼˜ï¼‰
- é‡æ„ä»£ç ï¼ˆç¼–è¯‘å™¨ä¿è¯æ­£ç¡®æ€§ï¼‰

### 5.2 ç»´æŠ¤æˆæœ¬å¯¹æ¯”

**Bugä¿®å¤æ—¶é—´**:

| Bugç±»å‹ | C++ | Rust | å¯¹æ¯” |
|---------|-----|------|------|
| **å†…å­˜æ³„æ¼** | 4å°æ—¶ | 0 | Rustæœç» |
| **æ‚¬å‚æŒ‡é’ˆ** | 8å°æ—¶ | 0 | Rustæœç» |
| **æ•°æ®ç«äº‰** | 16å°æ—¶ | 0 | Rustæœç» |
| **é€»è¾‘é”™è¯¯** | 2å°æ—¶ | 2å°æ—¶ | ç›¸åŒ |

**é•¿æœŸROI**:

$$ROI_{Rust} = \frac{SavedBugFixTime}{ExtraDevTime}$$

å¯¹äºé•¿æœŸç»´æŠ¤é¡¹ç›®ï¼ˆ>1å¹´ï¼‰ï¼ŒRust ROI > 3Ã—

---

## å…­ã€é€‚ç”¨åœºæ™¯å†³ç­–

### 6.1 å†³ç­–çŸ©é˜µ

| åœºæ™¯ç‰¹å¾ | C++ | Rust | Java | Go |
|---------|-----|------|------|-----|
| **ç³»ç»Ÿç¼–ç¨‹** | â­â­â­â­â­ | â­â­â­â­â­ | â­â˜†â˜†â˜†â˜† | â­â­â˜†â˜†â˜† |
| **Webåç«¯** | â­â­â­â˜†â˜† | â­â­â­â­â˜† | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ•°æ®åº“å¼•æ“** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | â­â˜†â˜†â˜†â˜† |
| **å¾®æœåŠ¡** | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† | â­â­â­â­â­ | â­â­â­â­â­ |
| **CLIå·¥å…·** | â­â­â­â˜†â˜† | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† |
| **åµŒå…¥å¼** | â­â­â­â­â­ | â­â­â­â­â­ | â­â˜†â˜†â˜†â˜† | â­â­â˜†â˜†â˜† |

### 6.2 å†³ç­–æ ‘

```mermaid
graph TD
    A[é€‰æ‹©ç¼–ç¨‹è¯­è¨€] --> B{æ€§èƒ½è¦æ±‚?}
    B -->|æé«˜| C{å†…å­˜å®‰å…¨è¦æ±‚?}
    B -->|ä¸­ç­‰| D{ç”Ÿæ€æˆç†Ÿåº¦?}
    B -->|ä½| E[Python/Node.js]

    C -->|é«˜| F[Rust]
    C -->|ä¸­| G[C++]

    D -->|æˆç†Ÿ| H{GCåœé¡¿å¯æ¥å—?}
    D -->|æ–°å…´| F

    H -->|æ˜¯| I[Java/Go]
    H -->|å¦| F
```

### 6.3 æŠ€æœ¯æ ˆå»ºè®®

**åç«¯æœåŠ¡**:

| åœºæ™¯ | ä¸€çº¿æ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ | ç†ç”± |
|-----|---------|---------|------|
| **APIç½‘å…³** | Rust | Go | é«˜æ€§èƒ½+ä½å»¶è¿Ÿ |
| **ä¸šåŠ¡é€»è¾‘** | Java/Go | Rust | å¼€å‘æ•ˆç‡ |
| **æ•°æ®å¤„ç†** | Rust | C++ | æ€§èƒ½å…³é”® |
| **é˜Ÿåˆ—æ¶ˆè´¹** | Go | Rust | å¹¶å‘æ¨¡å‹ç®€å• |

**æ•°æ®åº“ç›¸å…³**:

| ç»„ä»¶ | æ¨èè¯­è¨€ | ç†ç”± |
|-----|---------|------|
| **å­˜å‚¨å¼•æ“** | Rust/C++ | æ€§èƒ½+å®‰å…¨ |
| **æŸ¥è¯¢æ‰§è¡Œå™¨** | Rust/C++ | æ€§èƒ½å…³é”® |
| **å®¢æˆ·ç«¯é©±åŠ¨** | Rust | å®‰å…¨+å¼‚æ­¥ |
| **ç®¡ç†å·¥å…·** | Go | å¿«é€Ÿå¼€å‘ |

---

## ä¸ƒã€æ··åˆç­–ç•¥

### 7.1 Rust + Cé›†æˆ

**åœºæ™¯**: åˆ©ç”¨ç°æœ‰Cåº“

```rust
// Rustè°ƒç”¨Cåº“
extern "C" {
    fn c_function(arg: i32) -> i32;
}

unsafe {
    let result = c_function(42);
}
```

**æƒè¡¡**:

- âœ… å¤ç”¨ç°æœ‰ä»£ç 
- âŒ unsafeå—å¤±å»å®‰å…¨ä¿è¯
- âš ï¸ éœ€è¦careful FFIè¾¹ç•Œè®¾è®¡

### 7.2 æ¸è¿›å¼è¿ç§»

**ç­–ç•¥**: ä»C++é€æ­¥è¿ç§»åˆ°Rust

```
ç¬¬ä¸€é˜¶æ®µ: æ–°åŠŸèƒ½ç”¨Rust
    â†“
ç¬¬äºŒé˜¶æ®µ: é‡å†™å…³é”®æ¨¡å—
    â†“
ç¬¬ä¸‰é˜¶æ®µ: æ ¸å¿ƒåº“è¿ç§»
    â†“
ç¬¬å››é˜¶æ®µ: å®Œå…¨Rust
```

**å…¸å‹æ—¶é—´çº¿**: 2-5å¹´

**æ¡ˆä¾‹**: Firefox (Servoå¼•æ“)ã€Dropboxã€Cloudflare

---

## å…«ã€å®è·µæ¡ˆä¾‹

### æ¡ˆä¾‹1: æ•°æ®åº“è¿æ¥æ± 

**éœ€æ±‚**: é«˜æ€§èƒ½ã€å†…å­˜å®‰å…¨çš„è¿æ¥æ± 

**C++å®ç°** (ä¼ ç»Ÿ):

```cpp
class ConnectionPool {
    std::mutex mutex_;
    std::vector<Connection*> connections_;

public:
    Connection* get() {
        std::lock_guard<std::mutex> lock(mutex_);
        // å¯èƒ½å¿˜è®°é”ï¼Œå¯¼è‡´æ•°æ®ç«äº‰ âš ï¸
        return connections_.back();
    }
};
```

**æ½œåœ¨é—®é¢˜**:

- å¿˜è®°åŠ é”
- è¿”å›æ‚¬å‚æŒ‡é’ˆ
- è¿æ¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨

**Rustå®ç°** (å®‰å…¨):

```rust
use std::sync::{Arc, Mutex};

pub struct ConnectionPool {
    connections: Arc<Mutex<Vec<Connection>>>,
}

impl ConnectionPool {
    pub fn get(&self) -> Connection {
        let mut pool = self.connections.lock().unwrap();
        pool.pop().unwrap()
    }
}
```

**ç¼–è¯‘å™¨ä¿è¯**:

- âœ… å¿…é¡»æŒæœ‰é”æ‰èƒ½è®¿é—®
- âœ… è¿æ¥æ‰€æœ‰æƒæ˜ç¡®
- âœ… æ— æ•°æ®ç«äº‰

**æ€§èƒ½**: ç›¸åŒï¼ˆé”å¼€é”€ç›¸åŒï¼‰
**å¼€å‘æ—¶é—´**: Rust +30%
**ç»´æŠ¤æˆæœ¬**: Rust -70%ï¼ˆæ— å†…å­˜bugï¼‰

### æ¡ˆä¾‹2: é«˜æ€§èƒ½è®¡æ•°å™¨

**éœ€æ±‚**: ç™¾ä¸‡çº§QPSè®¡æ•°

**æ–¹æ¡ˆå¯¹æ¯”**:

| è¯­è¨€ | å®ç° | TPS | å»¶è¿Ÿ | å†…å­˜å®‰å…¨ |
|-----|------|-----|------|---------|
| C++ | `atomic<int64_t>` | 10M | 100ns | âš ï¸ éœ€å·¥å…·éªŒè¯ |
| Rust | `AtomicI64` | 10M | 100ns | âœ… ç¼–è¯‘æœŸä¿è¯ |
| Java | `AtomicLong` | 8M | 125ns | âœ… GCä¿è¯ |
| Go | `atomic.Int64` | 9M | 110ns | âœ… GCä¿è¯ |

**ç»“è®º**: æ€§èƒ½ç›¸è¿‘ï¼ŒRustæ— GCå¼€é”€

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**å¯¹æ¯”åˆ†æ**:

1. Rust vs C++ï¼ˆç¬¬äºŒç« ï¼‰
2. Rust vs Java/Goï¼ˆç¬¬ä¸‰ç« ï¼‰
3. æ€§èƒ½é‡åŒ–ï¼ˆç¬¬å››ç« ï¼‰
4. å¼€å‘æ•ˆç‡ï¼ˆç¬¬äº”ç« ï¼‰

**å†³ç­–å·¥å…·**:

1. é€‚ç”¨åœºæ™¯çŸ©é˜µï¼ˆç¬¬6.1èŠ‚ï¼‰
2. å†³ç­–æ ‘ï¼ˆç¬¬6.2èŠ‚ï¼‰
3. æ··åˆç­–ç•¥ï¼ˆç¬¬ä¸ƒç« ï¼‰

### 9.2 å…³é”®ç»“è®º

**æ€§èƒ½**:

$$Performance_{Rust} \approx Performance_{C++} > Performance_{Java/Go}$$

**å®‰å…¨æ€§**:

$$Safety_{Rust} > Safety_{Java/Go} \gg Safety_{C++}$$

**å¼€å‘æ•ˆç‡**:

$$DevSpeed_{Go/Java} > DevSpeed_{C++} > DevSpeed_{Rust}$$

**é•¿æœŸç»´æŠ¤**:

$$Maintainability_{Rust} > Maintainability_{Java/Go} > Maintainability_{C++}$$

### 9.3 é€‰æ‹©å»ºè®®

**é€‰Rust if**:

- æ€§èƒ½å…³é”® + é•¿æœŸç»´æŠ¤
- å†…å­˜å®‰å…¨ä¸å¯å¦¥å
- å›¢é˜Ÿæ„¿æ„æŠ•èµ„å­¦ä¹ 

**é€‰C++ if**:

- ç°æœ‰å¤§é‡C++ä»£ç 
- éœ€è¦æè‡´çµæ´»æ€§
- å›¢é˜ŸC++ç»éªŒä¸°å¯Œ

**é€‰Java/Go if**:

- å¿«é€Ÿè¿­ä»£ä¼˜å…ˆ
- GCåœé¡¿å¯æ¥å—
- ç”Ÿæ€æˆç†Ÿåº¦é‡è¦

---

## åã€å»¶ä¼¸é˜…è¯»

**Rustæ€§èƒ½**:

- *Programming Rust* (Blandy & Orendorff)
- Rust Performance Book

**å¯¹æ¯”åˆ†æ**:

- "Rust vs C++: Which to Choose?" (2023)
- "Rust in Production" (å¤šå®¶å…¬å¸æ¡ˆä¾‹)

**æ‰©å±•æ–¹å‘**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/06-æ‰€æœ‰æƒæ¨¡å‹(Rust).md` â†’ Rustè¯¦ç»†æœºåˆ¶
- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/07-å†…å­˜æ¨¡å‹ä¸æ’åº.md` â†’ åº•å±‚åŸç†
- `05-å®ç°æœºåˆ¶/04-Rust-æ‰€æœ‰æƒå®ç°.md` â†’ ç¼–è¯‘å™¨å®ç°

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 Rustæ‰€æœ‰æƒæ£€æŸ¥å™¨æ¨¡æ‹Ÿå®ç°

```rust
// ç®€åŒ–çš„å€Ÿç”¨æ£€æŸ¥å™¨æ¨¡æ‹Ÿ
use std::collections::HashMap;

struct BorrowChecker {
    variables: HashMap<String, BorrowState>,
}

enum BorrowState {
    Owned,
    BorrowedImmutable(usize),  // ä¸å¯å˜å€Ÿç”¨è®¡æ•°
    BorrowedMutable,           // å¯å˜å€Ÿç”¨ï¼ˆç‹¬å ï¼‰
}

impl BorrowChecker {
    fn new() -> Self {
        Self {
            variables: HashMap::new(),
        }
    }

    fn declare(&mut self, name: String) {
        self.variables.insert(name, BorrowState::Owned);
    }

    fn borrow_immutable(&mut self, name: &str) -> Result<(), String> {
        match self.variables.get_mut(name) {
            Some(BorrowState::Owned) => {
                *self.variables.get_mut(name).unwrap() = BorrowState::BorrowedImmutable(1);
                Ok(())
            }
            Some(BorrowState::BorrowedImmutable(count)) => {
                *count += 1;
                Ok(())
            }
            Some(BorrowState::BorrowedMutable) => {
                Err(format!("Cannot borrow `{}` as immutable, it is already borrowed as mutable", name))
            }
            None => Err(format!("Variable `{}` not found", name))
        }
    }

    fn borrow_mutable(&mut self, name: &str) -> Result<(), String> {
        match self.variables.get(name) {
            Some(BorrowState::Owned) => {
                *self.variables.get_mut(name).unwrap() = BorrowState::BorrowedMutable;
                Ok(())
            }
            Some(BorrowState::BorrowedImmutable(_)) => {
                Err(format!("Cannot borrow `{}` as mutable, it is already borrowed as immutable", name))
            }
            Some(BorrowState::BorrowedMutable) => {
                Err(format!("Cannot borrow `{}` as mutable, it is already borrowed as mutable", name))
            }
            None => Err(format!("Variable `{}` not found", name))
        }
    }
}
```

### 11.2 è¿è¡Œæ—¶é”ç®¡ç†å™¨å®ç°

```python
from threading import Lock, RLock
from typing import Dict, Set

class RuntimeLockManager:
    """è¿è¡Œæ—¶é”ç®¡ç†å™¨ï¼ˆå¯¹æ¯”ç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰"""

    def __init__(self):
        self.locks: Dict[str, RLock] = {}
        self.lock_holder: Dict[str, int] = {}  # resource -> thread_id
        self.global_lock = Lock()

    def acquire_lock(self, resource: str, thread_id: int, exclusive: bool = False):
        """è·å–é”ï¼ˆè¿è¡Œæ—¶æ£€æŸ¥ï¼‰"""
        with self.global_lock:
            if resource not in self.locks:
                self.locks[resource] = RLock()

        lock = self.locks[resource]

        if exclusive:
            lock.acquire()  # å¯èƒ½é˜»å¡
            self.lock_holder[resource] = thread_id
        else:
            lock.acquire()  # å…±äº«é”

        # é—®é¢˜: å¦‚æœå¿˜è®°é‡Šæ”¾ï¼Œä¼šå¯¼è‡´æ­»é”ï¼ˆè¿è¡Œæ—¶æ‰å‘ç°ï¼‰

    def release_lock(self, resource: str, thread_id: int):
        """é‡Šæ”¾é”"""
        if resource in self.lock_holder:
            if self.lock_holder[resource] == thread_id:
                self.locks[resource].release()
                del self.lock_holder[resource]
            else:
                raise Exception(f"Thread {thread_id} cannot release lock held by {self.lock_holder[resource]}")
```

---

## åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 12.1 æ¡ˆä¾‹: æ•°æ®åº“è¿æ¥æ± ï¼ˆRust vs Goï¼‰

**åœºæ™¯**: PostgreSQLè¿æ¥æ± 

**Rustå®ç°** (ç¼–è¯‘æ—¶æ£€æŸ¥):

```rust
use std::sync::Arc;
use tokio::sync::Mutex;

struct ConnectionPool {
    connections: Arc<Mutex<Vec<tokio_postgres::Client>>>,
}

impl ConnectionPool {
    async fn get_connection(&self) -> Option<tokio_postgres::Client> {
        let mut conns = self.connections.lock().await;
        conns.pop()  // æ‰€æœ‰æƒè½¬ç§»ï¼Œç¼–è¯‘æœŸä¿è¯ä¸ä¼šé‡å¤ä½¿ç”¨
    }

    fn return_connection(&self, conn: tokio_postgres::Client) {
        // ç¼–è¯‘æœŸä¿è¯: connåªèƒ½ä½¿ç”¨ä¸€æ¬¡
        let mut conns = self.connections.lock().await;
        conns.push(conn);
    }
}
```

**Goå®ç°** (è¿è¡Œæ—¶æ£€æŸ¥):

```go
type ConnectionPool struct {
    connections []*sql.DB
    mu sync.Mutex
}

func (p *ConnectionPool) GetConnection() *sql.DB {
    p.mu.Lock()
    defer p.mu.Unlock()

    if len(p.connections) > 0 {
        conn := p.connections[0]
        p.connections = p.connections[1:]
        return conn
    }
    // é—®é¢˜: å¯èƒ½è¿”å›nilï¼Œéœ€è¦è¿è¡Œæ—¶æ£€æŸ¥
    return nil
}
```

**æ€§èƒ½å¯¹æ¯”**:

| æŒ‡æ ‡ | Rust | Go |
|-----|------|-----|
| **ç¼–è¯‘æ—¶é”™è¯¯** | 100% âœ… | 0% |
| **è¿è¡Œæ—¶é”™è¯¯** | 0 âœ… | å¯èƒ½å‘ç”Ÿ |
| **æ€§èƒ½** | ç›¸å½“ | ç›¸å½“ |

### 12.2 æ¡ˆä¾‹: é«˜å¹¶å‘è®¡æ•°å™¨ï¼ˆç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶ï¼‰

**Rustå®ç°** (ç¼–è¯‘æ—¶ä¿è¯):

```rust
use std::sync::atomic::AtomicUsize;

struct Counter {
    count: AtomicUsize,
}

impl Counter {
    fn increment(&self) {
        // ç¼–è¯‘æœŸä¿è¯: &selfæ˜¯å…±äº«å¼•ç”¨ï¼Œä½†AtomicUsizeæ˜¯Sync
        self.count.fetch_add(1, Ordering::Relaxed);
    }
}
```

**C++å®ç°** (è¿è¡Œæ—¶æ£€æŸ¥):

```cpp
class Counter {
    std::atomic<int> count;
    std::mutex mu;  // è¿è¡Œæ—¶é”

public:
    void increment() {
        std::lock_guard<std::mutex> lock(mu);  // è¿è¡Œæ—¶åŠ é”
        count++;
        // é—®é¢˜: å¿˜è®°åŠ é”æ—¶æ•°æ®ç«äº‰ï¼ˆè¿è¡Œæ—¶æ‰å‘ç°ï¼‰
    }
};
```

---

## åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: è¯¯ç”¨Unsafeç»•è¿‡æ£€æŸ¥

**é”™è¯¯è®¾è®¡**:

```rust
// é”™è¯¯: è¿‡åº¦ä½¿ç”¨unsafeç»•è¿‡å€Ÿç”¨æ£€æŸ¥
unsafe fn dangerous_function() {
    let mut x = 5;
    let ptr1 = &mut x as *mut i32;
    let ptr2 = &mut x as *mut i32;  // ç»•è¿‡æ£€æŸ¥

    *ptr1 = 10;
    *ptr2 = 20;  // æœªå®šä¹‰è¡Œä¸ºï¼
}
```

**é—®é¢˜**: å¤±å»ç¼–è¯‘æœŸå®‰å…¨ä¿è¯

**æ­£ç¡®è®¾è®¡**:

```rust
// æ­£ç¡®: ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨unsafeï¼Œå¹¶æ·»åŠ å®‰å…¨æ³¨é‡Š
/// SAFETY: ä¿è¯ptr1å’Œptr2ä¸é‡å 
unsafe fn safe_unsafe_function(ptr1: *mut i32, ptr2: *mut i32) {
    // ä½¿ç”¨å‰éªŒè¯
    assert!(ptr1 != ptr2);
    *ptr1 = 10;
    *ptr2 = 20;
}
```

### åä¾‹2: è¿‡åº¦ä¾èµ–è¿è¡Œæ—¶æ£€æŸ¥

**é”™è¯¯è®¾è®¡**:

```python
# é”™è¯¯: æ‰€æœ‰æ£€æŸ¥éƒ½åœ¨è¿è¡Œæ—¶
def transfer(from_account, to_account, amount):
    # è¿è¡Œæ—¶æ£€æŸ¥ä½™é¢
    balance = get_balance(from_account)
    if balance < amount:
        raise InsufficientFunds()  # è¿è¡Œæ—¶é”™è¯¯

    # è¿è¡Œæ—¶åŠ é”
    lock = acquire_lock(from_account)
    try:
        update_balance(from_account, -amount)
        update_balance(to_account, amount)
    finally:
        release_lock(lock)  # å¯èƒ½å¿˜è®°é‡Šæ”¾
```

**é—®é¢˜**: é”™è¯¯åœ¨è¿è¡Œæ—¶æ‰å‘ç°ï¼Œå¯èƒ½å·²é€ æˆæŸå¤±

**æ­£ç¡®è®¾è®¡**:

```rust
// æ­£ç¡®: ç¼–è¯‘æœŸä¿è¯
fn transfer(
    from_account: &mut Account,
    to_account: &mut Account,
    amount: u64
) -> Result<(), TransferError> {
    // ç¼–è¯‘æœŸä¿è¯: from_accountå’Œto_accountä¸é‡å 
    if from_account.balance < amount {
        return Err(TransferError::InsufficientFunds);
    }

    from_account.balance -= amount;
    to_account.balance += amount;
    // ç¼–è¯‘æœŸä¿è¯: æ‰€æœ‰æƒç®¡ç†ï¼Œä¸ä¼šæ³„æ¼
    Ok(())
}
```

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´æ‰€æœ‰æƒæ£€æŸ¥å™¨/é”ç®¡ç†å™¨å®ç°ã€å®é™…æ¡ˆä¾‹ã€åä¾‹åˆ†æ

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/06-æ‰€æœ‰æƒæ¨¡å‹(Rust).md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md`
- `05-å®ç°æœºåˆ¶/04-Rust-æ‰€æœ‰æƒå®ç°.md`
