# 05 | å­˜å‚¨-å¹¶å‘æƒè¡¡

> **å†³ç­–å·¥å…·**: æœ¬æ–‡æ¡£åˆ†æMVCCçš„å­˜å‚¨å¼€é”€ä¸å¹¶å‘æ€§èƒ½çš„æƒè¡¡å…³ç³»ï¼Œæä¾›ä¼˜åŒ–ç­–ç•¥ã€‚

---

## ğŸ“‘ ç›®å½•

- [05 | å­˜å‚¨-å¹¶å‘æƒè¡¡](#05--å­˜å‚¨-å¹¶å‘æƒè¡¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æƒè¡¡åŸºæœ¬åŸç†](#ä¸€æƒè¡¡åŸºæœ¬åŸç†)
    - [1.1 æ ¸å¿ƒçŸ›ç›¾](#11-æ ¸å¿ƒçŸ›ç›¾)
    - [1.2 æ•°å­¦æ¨¡å‹](#12-æ•°å­¦æ¨¡å‹)
  - [äºŒã€ç‰ˆæœ¬é“¾é•¿åº¦åˆ†æ](#äºŒç‰ˆæœ¬é“¾é•¿åº¦åˆ†æ)
    - [2.1 ç‰ˆæœ¬ç´¯ç§¯æ¨¡å‹](#21-ç‰ˆæœ¬ç´¯ç§¯æ¨¡å‹)
    - [2.2 é•¿äº‹åŠ¡å½±å“](#22-é•¿äº‹åŠ¡å½±å“)
    - [2.3 æ£€æµ‹é•¿äº‹åŠ¡](#23-æ£€æµ‹é•¿äº‹åŠ¡)
  - [ä¸‰ã€è¡¨è†¨èƒ€é—®é¢˜](#ä¸‰è¡¨è†¨èƒ€é—®é¢˜)
    - [3.1 è†¨èƒ€ç‡å®šä¹‰](#31-è†¨èƒ€ç‡å®šä¹‰)
    - [3.2 è†¨èƒ€é˜ˆå€¼](#32-è†¨èƒ€é˜ˆå€¼)
  - [å››ã€ç´¢å¼•è†¨èƒ€](#å››ç´¢å¼•è†¨èƒ€)
    - [4.1 ç´¢å¼•è†¨èƒ€åŸå› ](#41-ç´¢å¼•è†¨èƒ€åŸå› )
    - [4.2 æé«˜HOTç‡](#42-æé«˜hotç‡)
  - [äº”ã€VACUUMç­–ç•¥](#äº”vacuumç­–ç•¥)
    - [5.1 VACUUMé¢‘ç‡æƒè¡¡](#51-vacuumé¢‘ç‡æƒè¡¡)
    - [5.2 VACUUMæˆæœ¬æ¨¡å‹](#52-vacuumæˆæœ¬æ¨¡å‹)
    - [5.3 Freezeç­–ç•¥](#53-freezeç­–ç•¥)
  - [å…­ã€å­˜å‚¨ä¼˜åŒ–æŠ€æœ¯](#å…­å­˜å‚¨ä¼˜åŒ–æŠ€æœ¯)
    - [6.1 TOASTå‹ç¼©](#61-toastå‹ç¼©)
    - [6.2 åˆ†åŒºè¡¨](#62-åˆ†åŒºè¡¨)
    - [6.3 BRINç´¢å¼•](#63-brinç´¢å¼•)
  - [ä¸ƒã€In-place vs MVCCå¯¹æ¯”](#ä¸ƒin-place-vs-mvccå¯¹æ¯”)
    - [7.1 å…¨é¢å¯¹æ¯”çŸ©é˜µ](#71-å…¨é¢å¯¹æ¯”çŸ©é˜µ)
    - [7.2 æ€§èƒ½æ›²çº¿å¯¹æ¯”](#72-æ€§èƒ½æ›²çº¿å¯¹æ¯”)
    - [7.3 é€‰æ‹©å»ºè®®](#73-é€‰æ‹©å»ºè®®)
  - [å…«ã€å®è·µæŒ‡å—](#å…«å®è·µæŒ‡å—)
    - [8.1 ç›‘æ§æŒ‡æ ‡](#81-ç›‘æ§æŒ‡æ ‡)
    - [8.2 è°ƒä¼˜æ¸…å•](#82-è°ƒä¼˜æ¸…å•)
    - [8.3 æœ€ä½³å®è·µ](#83-æœ€ä½³å®è·µ)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®å…¬å¼](#92-å…³é”®å…¬å¼)
    - [9.3 è®¾è®¡åŸåˆ™](#93-è®¾è®¡åŸåˆ™)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)
  - [åä¸€ã€å®Œæ•´å®ç°ä»£ç ](#åä¸€å®Œæ•´å®ç°ä»£ç )
    - [11.1 ç‰ˆæœ¬é“¾é•¿åº¦ç›‘æ§å®ç°](#111-ç‰ˆæœ¬é“¾é•¿åº¦ç›‘æ§å®ç°)
    - [11.2 è‡ªåŠ¨VACUUMè°ƒåº¦å™¨å®ç°](#112-è‡ªåŠ¨vacuumè°ƒåº¦å™¨å®ç°)
  - [åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åäºŒå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [12.1 æ¡ˆä¾‹: é«˜å¹¶å‘å†™å…¥è¡¨å­˜å‚¨ä¼˜åŒ–](#121-æ¡ˆä¾‹-é«˜å¹¶å‘å†™å…¥è¡¨å­˜å‚¨ä¼˜åŒ–)
    - [12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡ç‰ˆæœ¬é“¾ä¼˜åŒ–](#122-æ¡ˆä¾‹-é•¿äº‹åŠ¡ç‰ˆæœ¬é“¾ä¼˜åŒ–)
  - [åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡](#åä¸‰åä¾‹ä¸é”™è¯¯è®¾è®¡)
    - [åä¾‹1: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨çˆ†ç‚¸](#åä¾‹1-å¿½ç•¥vacuumå¯¼è‡´å­˜å‚¨çˆ†ç‚¸)
    - [åä¾‹2: è¿‡åº¦VACUUMå¯¼è‡´æ€§èƒ½ä¸‹é™](#åä¾‹2-è¿‡åº¦vacuumå¯¼è‡´æ€§èƒ½ä¸‹é™)

---

## ä¸€ã€æƒè¡¡åŸºæœ¬åŸç†

### 1.1 æ ¸å¿ƒçŸ›ç›¾

**MVCCåŸºæœ¬æƒè¡¡**:

$$\text{High Concurrency} \xleftrightarrow[\text{Storage Cost}]{\text{Trade-off}} \text{Storage Overhead}$$

**å›¾ç¤º**:

```
å¹¶å‘æ€§èƒ½
  â†‘
  â”‚   â— MVCC (è¯»æ— é”)
  â”‚  /
  â”‚ /
  â”‚/   â— In-place Update
  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å­˜å‚¨å¼€é”€
    1Ã—      2Ã—      5Ã—
```

### 1.2 æ•°å­¦æ¨¡å‹

**å­˜å‚¨å¼€é”€å…¬å¼**:

$$Storage = BaseSize + VersionSpace + IndexSpace + DeadTupleSpace$$

**ç‰ˆæœ¬ç©ºé—´**:

$$VersionSpace = \sum_{row} ChainLength(row) \times TupleSize$$

**æœŸæœ›ç‰ˆæœ¬é“¾é•¿åº¦**:

$$E[ChainLength] = UpdateRate \times AvgTxDuration$$

---

## äºŒã€ç‰ˆæœ¬é“¾é•¿åº¦åˆ†æ

### 2.1 ç‰ˆæœ¬ç´¯ç§¯æ¨¡å‹

**ç´¯ç§¯é€Ÿç‡**:

$$\frac{dVersions}{dt} = UpdateRate - VacuumRate$$

**ç¨³æ€æ¡ä»¶**:

$$UpdateRate = VacuumRate \implies \text{Stable chain length}$$

**ä¸ç¨³æ€**:

$$UpdateRate > VacuumRate \implies \text{Unbounded growth}$$

### 2.2 é•¿äº‹åŠ¡å½±å“

**ç‰ˆæœ¬ä¿ç•™æ—¶é—´**:

$$RetentionTime = \max(\text{OldestActiveTransaction}, \text{LastVacuum})$$

**ç‰ˆæœ¬æ•°é‡**:

$$VersionCount = UpdateRate \times RetentionTime$$

**é‡åŒ–ç¤ºä¾‹**:

| é•¿äº‹åŠ¡æ—¶é•¿ | æ›´æ–°é¢‘ç‡ | ç´¯ç§¯ç‰ˆæœ¬æ•° | å­˜å‚¨è†¨èƒ€ |
|-----------|---------|-----------|---------|
| 1åˆ†é’Ÿ | 100/s | 6,000 | 1.2Ã— |
| 10åˆ†é’Ÿ | 100/s | 60,000 | 2Ã— |
| 1å°æ—¶ | 100/s | 360,000 | 5Ã— |
| 10å°æ—¶ | 100/s | 3,600,000 | 50Ã— âš ï¸ |

**è­¦ç¤º**: é•¿äº‹åŠ¡æ˜¯è¡¨è†¨èƒ€çš„ä¸»å› ï¼

### 2.3 æ£€æµ‹é•¿äº‹åŠ¡

```sql
-- æŸ¥æ‰¾è¿è¡Œè¶…è¿‡5åˆ†é’Ÿçš„äº‹åŠ¡
SELECT
    pid,
    now() - xact_start AS duration,
    state,
    query
FROM pg_stat_activity
WHERE xact_start < now() - interval '5 minutes'
    AND state != 'idle'
ORDER BY duration DESC;

-- ç»ˆæ­¢é•¿äº‹åŠ¡
SELECT pg_terminate_backend(pid);
```

---

## ä¸‰ã€è¡¨è†¨èƒ€é—®é¢˜

### 3.1 è†¨èƒ€ç‡å®šä¹‰

**è†¨èƒ€ç‡**:

$$BloatRate = \frac{DeadTuples + UnusedSpace}{TotalSpace}$$

**è®¡ç®—æŸ¥è¯¢**:

```sql
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS bloat,
    round(100 * (pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename))::numeric /
          NULLIF(pg_total_relation_size(schemaname||'.'||tablename), 0), 2) AS bloat_pct
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY bloat_pct DESC
LIMIT 10;
```

### 3.2 è†¨èƒ€é˜ˆå€¼

| è†¨èƒ€ç‡ | çŠ¶æ€ | è¡ŒåŠ¨ |
|-------|------|------|
| <10% | å¥åº· | æ— éœ€å¤„ç† |
| 10-30% | è­¦å‘Š | è°ƒæ•´autovacuum |
| 30-50% | ä¸¥é‡ | æ‰‹åŠ¨VACUUM FULL |
| >50% | ç´§æ€¥ | é‡å»ºè¡¨ |

**é‡å»ºè¡¨æ–¹æ¡ˆ**:

```sql
-- æ–¹æ¡ˆ1: VACUUM FULLï¼ˆé”è¡¨ï¼Œåœæœºï¼‰
VACUUM FULL table_name;

-- æ–¹æ¡ˆ2: pg_repackï¼ˆåœ¨çº¿ï¼Œæ¨èï¼‰
pg_repack -t table_name database_name;

-- æ–¹æ¡ˆ3: æ‰‹åŠ¨é‡å»ºï¼ˆçµæ´»ï¼‰
BEGIN;
CREATE TABLE table_new AS SELECT * FROM table_old;
DROP TABLE table_old;
ALTER TABLE table_new RENAME TO table_old;
-- é‡å»ºç´¢å¼•
COMMIT;
```

---

## å››ã€ç´¢å¼•è†¨èƒ€

### 4.1 ç´¢å¼•è†¨èƒ€åŸå› 

**MVCCç´¢å¼•ç‰¹ç‚¹**: æ¯ä¸ªå…ƒç»„ç‰ˆæœ¬éƒ½æœ‰ç´¢å¼•é¡¹

$$IndexEntries = \sum_{version} 1 \quad \text{(vs In-place: 1 entry/row)}$$

**è†¨èƒ€ç‡**:

$$IndexBloat = AvgChainLength \times (1 - HOTRate)$$

**HOTä¼˜åŒ–æ•ˆæœ**:

| HOTç‡ | ç´¢å¼•è†¨èƒ€ | è¯´æ˜ |
|------|---------|------|
| 0% | 5Ã— | æ— HOT |
| 50% | 2.5Ã— | éƒ¨åˆ†HOT |
| 90% | 1.5Ã— | é«˜HOTç‡ |
| 100% | 1Ã— | å®Œç¾HOT |

### 4.2 æé«˜HOTç‡

**æ¡ä»¶**:

1. âœ… æœªæ›´æ–°ç´¢å¼•åˆ—
2. âœ… æ–°ç‰ˆæœ¬åœ¨åŒé¡µ
3. âœ… é¡µé¢æœ‰ç©ºé—´

**ä¼˜åŒ–ç­–ç•¥**:

```sql
-- 1. é™ä½Fillfactorï¼Œé¢„ç•™HOTç©ºé—´
ALTER TABLE orders SET (fillfactor = 70);  -- é»˜è®¤100

-- 2. å‡å°‘ç´¢å¼•æ•°é‡ï¼ˆæƒè¡¡æŸ¥è¯¢æ€§èƒ½ï¼‰
DROP INDEX IF EXISTS orders_non_critical_idx;

-- 3. åˆ†ç¦»é¢‘ç¹æ›´æ–°çš„åˆ—
-- å°†statusåˆ—ç§»åˆ°ç‹¬ç«‹è¡¨ï¼ˆé¿å…æ›´æ–°ä¸»è¡¨ï¼‰
CREATE TABLE order_status (
    order_id INT PRIMARY KEY REFERENCES orders(id),
    status VARCHAR(20),
    updated_at TIMESTAMPTZ
);
```

---

## äº”ã€VACUUMç­–ç•¥

### 5.1 VACUUMé¢‘ç‡æƒè¡¡

**è¿‡äºé¢‘ç¹**:

- âŒ CPU/IOå¼€é”€å¤§
- âŒ é”ç«äº‰ï¼ˆæ‰«æè¡¨éœ€å…±äº«é”ï¼‰

**ä¸å¤Ÿé¢‘ç¹**:

- âŒ è¡¨è†¨èƒ€ä¸¥é‡
- âŒ æŸ¥è¯¢æ€§èƒ½ä¸‹é™ï¼ˆç‰ˆæœ¬é“¾é•¿ï¼‰

**æœ€ä¼˜é¢‘ç‡**:

$$OptimalFreq = \frac{UpdateRate}{VacuumCost} \times TargetBloat$$

**é…ç½®å»ºè®®**:

| æ›´æ–°é¢‘ç‡ | è¡¨å¤§å° | autovacuum_scale_factor | vacuum_threshold |
|---------|-------|------------------------|------------------|
| ä½ (<100/s) | å° | 0.2 (é»˜è®¤) | 50 |
| ä¸­ (100-1K/s) | ä¸­ | 0.1 | 100 |
| é«˜ (>1K/s) | å¤§ | 0.05 | 500 |

### 5.2 VACUUMæˆæœ¬æ¨¡å‹

**æ—¶é—´å¼€é”€**:

$$T_{vacuum} = \frac{TableSize}{ScanRate} + \frac{DeadTuples \times IndexCount}{CleanRate}$$

**I/Oå¼€é”€**:

$$IO_{vacuum} = TableSize + IndexSize \times IndexCount$$

**CPUå¼€é”€**:

$$CPU_{vacuum} = DeadTuples \times (CheckCost + MarkCost)$$

**é…ç½®ä¼˜åŒ–**:

```sql
-- é™ä½VACUUMå¯¹ç”Ÿäº§çš„å½±å“
ALTER SYSTEM SET vacuum_cost_delay = 10;  -- æ¯é¡µå»¶è¿Ÿ10ms
ALTER SYSTEM SET vacuum_cost_limit = 200; -- ç´¯è®¡æˆæœ¬ä¸Šé™

-- å¹¶è¡ŒVACUUMï¼ˆPostgreSQL 13+ï¼‰
SET max_parallel_maintenance_workers = 4;
VACUUM (PARALLEL 4) large_table;
```

### 5.3 Freezeç­–ç•¥

**Freezeå¼€é”€**:

$$FreezeCost = \frac{FrozenTuples}{FreezeRate} + UpdateFSMCost$$

**é…ç½®æƒè¡¡**:

| å‚æ•° | æ¿€è¿›ç­–ç•¥ | ä¿å®ˆç­–ç•¥ | æ¨è |
|-----|---------|---------|------|
| vacuum_freeze_min_age | 10M | 50M | 50M |
| vacuum_freeze_table_age | 100M | 150M | 150M |
| autovacuum_freeze_max_age | 150M | 200M | 200M |

**æ¿€è¿›ç­–ç•¥**:

- âœ… å‡å°‘çªå‘Freeze
- âŒ é¢‘ç¹ä¿®æ”¹å…ƒç»„

**ä¿å®ˆç­–ç•¥**:

- âœ… å‡å°‘æ—¥å¸¸å¼€é”€
- âŒ æ¥è¿‘å›å·æ—¶å¤§é‡Freeze

---

## å…­ã€å­˜å‚¨ä¼˜åŒ–æŠ€æœ¯

### 6.1 TOASTå‹ç¼©

**TOAST (The Oversized-Attribute Storage Technique)**:

```sql
-- å¤§åˆ—å‹ç¼©å­˜å‚¨
ALTER TABLE documents
ALTER COLUMN content SET STORAGE EXTENDED;  -- å‹ç¼©+å¤–éƒ¨å­˜å‚¨

-- ç­–ç•¥é€‰æ‹©
-- PLAIN: ä¸å‹ç¼©ä¸å¤–éƒ¨ï¼ˆå°åˆ—ï¼‰
-- EXTENDED: å‹ç¼©+å¤–éƒ¨ï¼ˆå¤§æ–‡æœ¬ï¼‰
-- EXTERNAL: ä»…å¤–éƒ¨ï¼ˆå·²å‹ç¼©æ•°æ®ï¼‰
-- MAIN: ä¼˜å…ˆå‹ç¼©ï¼ˆå¸¸ç”¨å¤§åˆ—ï¼‰
```

**æ•ˆæœ**:

| æ•°æ®ç±»å‹ | åŸå§‹å¤§å° | EXTENDEDå | å‹ç¼©æ¯” |
|---------|---------|-----------|--------|
| JSON | 10MB | 2MB | 5:1 |
| æ–‡æœ¬ | 5MB | 1MB | 5:1 |
| äºŒè¿›åˆ¶ | 20MB | 15MB | 1.3:1 |

### 6.2 åˆ†åŒºè¡¨

**ç›®çš„**: é™ä½VACUUMç²’åº¦ï¼Œæå‡å¹¶å‘

```sql
-- æŒ‰æ—¶é—´åˆ†åŒº
CREATE TABLE orders (
    id SERIAL,
    created_at DATE,
    ...
) PARTITION BY RANGE (created_at);

CREATE TABLE orders_2024 PARTITION OF orders
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

CREATE TABLE orders_2025 PARTITION OF orders
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
```

**æ”¶ç›Š**:

| æŒ‡æ ‡ | å•è¡¨ | åˆ†åŒºè¡¨ | æå‡ |
|-----|------|--------|------|
| VACUUMæ—¶é—´ | 1å°æ—¶ | 6åˆ†é’Ÿ/åˆ†åŒº | 10Ã— |
| æŸ¥è¯¢æ€§èƒ½ | å…¨è¡¨æ‰«æ | åˆ†åŒºè£å‰ª | 5-10Ã— |
| ç»´æŠ¤çµæ´»æ€§ | ä½ | é«˜ | - |

### 6.3 BRINç´¢å¼•

**é€‚ç”¨åœºæ™¯**: é¡ºåºæ•°æ®ï¼ˆæ—¶åºã€æ—¥å¿—ï¼‰

```sql
-- ä¼ ç»ŸB-treeç´¢å¼•
CREATE INDEX idx_orders_date ON orders(created_at);  -- å¤§å°: 5GB

-- BRINç´¢å¼•
CREATE INDEX idx_orders_date_brin ON orders USING BRIN(created_at);  -- å¤§å°: 50MB
```

**æƒè¡¡**:

| ç»´åº¦ | B-tree | BRIN |
|-----|--------|------|
| ç´¢å¼•å¤§å° | å¤§ï¼ˆ5-10%è¡¨å¤§å°ï¼‰ | æå°ï¼ˆ<1%ï¼‰ |
| æŸ¥è¯¢æ€§èƒ½ | å¿« | ä¸­ï¼ˆéœ€æ‰«æå—ï¼‰ |
| æ›´æ–°æ€§èƒ½ | æ…¢ | å¿« |
| é€‚ç”¨åœºæ™¯ | éšæœºæŸ¥è¯¢ | èŒƒå›´æŸ¥è¯¢+é¡ºåºæ•°æ® |

---

## ä¸ƒã€In-place vs MVCCå¯¹æ¯”

### 7.1 å…¨é¢å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | In-place (MySQL InnoDB) | MVCC (PostgreSQL) |
|-----|------------------------|-------------------|
| **è¯»æ€§èƒ½** | ä¸­ï¼ˆéœ€Undoï¼‰ | é«˜ï¼ˆç›´æ¥è¯»å†å²ï¼‰ |
| **å†™æ€§èƒ½** | é«˜ï¼ˆåŸåœ°æ›´æ–°ï¼‰ | ä¸­ï¼ˆåˆ›å»ºç‰ˆæœ¬ï¼‰ |
| **å­˜å‚¨å¼€é”€** | ä½ï¼ˆUndoç‹¬ç«‹ï¼‰ | é«˜ï¼ˆç‰ˆæœ¬é“¾ï¼‰ |
| **VACUUM** | Purgeçº¿ç¨‹ | å¿…é¡»é¢‘ç¹ |
| **é•¿äº‹åŠ¡å½±å“** | Undoé“¾é•¿ | ç‰ˆæœ¬é“¾é•¿ |
| **å®ç°å¤æ‚åº¦** | é«˜ | ä¸­ |

### 7.2 æ€§èƒ½æ›²çº¿å¯¹æ¯”

```
TPS
  â†‘
  â”‚     MVCC â”€â”€â”€â”€â”€â”€â”€
  â”‚    /
  â”‚   /
  â”‚  / In-place â”€â”€â”€â”€
  â”‚ /
  â”‚/
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è¯»å†™æ¯”
    1:10  1:1  10:1  100:1
```

**äº¤å‰ç‚¹**: è¯»å†™æ¯”çº¦3:1æ—¶æ€§èƒ½ç›¸å½“

### 7.3 é€‰æ‹©å»ºè®®

| å·¥ä½œè´Ÿè½½ | è¯»å†™æ¯” | æ¨è | ç†ç”± |
|---------|-------|------|------|
| **OLTP** | 10:1 | MVCC | è¯»å¤š |
| **æ‰¹å¤„ç†** | 1:10 | In-place | å†™å¤š |
| **æ··åˆ** | 1:1 | MVCC | è¯»å†™åˆ†ç¦»ä¼˜åŠ¿ |
| **åˆ†æ** | 1000:1 | MVCC | æåº¦è¯»å¯†é›† |

---

## å…«ã€å®è·µæŒ‡å—

### 8.1 ç›‘æ§æŒ‡æ ‡

**å…³é”®SQL**:

```sql
-- 1. è¡¨è†¨èƒ€ç‡
SELECT
    relname,
    n_dead_tup,
    n_live_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_pct
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY dead_pct DESC;

-- 2. é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    now() - xact_start AS duration
FROM pg_stat_activity
WHERE state != 'idle'
    AND xact_start < now() - interval '10 minutes'
ORDER BY duration DESC;

-- 3. VACUUMæ´»åŠ¨
SELECT
    relname,
    last_vacuum,
    last_autovacuum,
    n_dead_tup,
    autovacuum_count
FROM pg_stat_user_tables
WHERE last_autovacuum < now() - interval '1 hour'
    AND n_dead_tup > 1000;
```

### 8.2 è°ƒä¼˜æ¸…å•

**çº§åˆ«1: åŸºç¡€è°ƒä¼˜**

- [ ] ç»ˆæ­¢é•¿äº‹åŠ¡ï¼ˆ>1å°æ—¶ï¼‰
- [ ] è°ƒæ•´autovacuumå‚æ•°
- [ ] ç›‘æ§è¡¨è†¨èƒ€ç‡

**çº§åˆ«2: æ·±åº¦ä¼˜åŒ–**

- [ ] é™ä½Fillfactoræé«˜HOTç‡
- [ ] åˆ†åŒºè¡¨å‡å°‘VACUUMç²’åº¦
- [ ] ä½¿ç”¨BRINç´¢å¼•ï¼ˆé¡ºåºæ•°æ®ï¼‰

**çº§åˆ«3: æ¶æ„è°ƒæ•´**

- [ ] è¯»å†™åˆ†ç¦»ï¼ˆåªè¯»å‰¯æœ¬ï¼‰
- [ ] å†·çƒ­æ•°æ®åˆ†ç¦»
- [ ] è€ƒè™‘åˆ—å­˜å‚¨ï¼ˆOLAPï¼‰

### 8.3 æœ€ä½³å®è·µ

**DO**:

- âœ… é¿å…é•¿äº‹åŠ¡
- âœ… å®šæœŸç›‘æ§è†¨èƒ€ç‡
- âœ… ä¸ºçƒ­è¡¨è°ƒæ•´autovacuum
- âœ… ä½¿ç”¨åˆ†åŒºè¡¨
- âœ… é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹

**DON'T**:

- âŒ ç¦ç”¨autovacuum
- âŒ å¿½è§†æ­»å…ƒç»„å‘Šè­¦
- âŒ è¿‡åº¦ç´¢å¼•ï¼ˆ>10ä¸ª/è¡¨ï¼‰
- âŒ åœ¨ç”Ÿäº§é«˜å³°VACUUM FULL
- âŒ å¿½è§†Fillfactoré…ç½®

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**é‡åŒ–æ¨¡å‹**:

1. ç‰ˆæœ¬é“¾é•¿åº¦å…¬å¼ï¼ˆç¬¬2.2èŠ‚ï¼‰
2. å­˜å‚¨è†¨èƒ€ç‡è®¡ç®—ï¼ˆç¬¬3.1èŠ‚ï¼‰
3. VACUUMé¢‘ç‡ä¼˜åŒ–ï¼ˆç¬¬5.1èŠ‚ï¼‰

**ä¼˜åŒ–ç­–ç•¥**:

1. HOTä¼˜åŒ–ï¼ˆé™ä½ç´¢å¼•è†¨èƒ€ï¼‰
2. åˆ†åŒºè¡¨ï¼ˆé™ä½VACUUMç²’åº¦ï¼‰
3. BRINç´¢å¼•ï¼ˆå‡å°‘å­˜å‚¨ï¼‰

### 9.2 å…³é”®å…¬å¼

**å­˜å‚¨å¼€é”€**:

$$Storage = BaseSize \times (1 + AvgChainLength \times (1 - HOTRate))$$

**æœ€ä¼˜VACUUMé¢‘ç‡**:

$$VacuumFreq = UpdateRate \times \frac{TargetBloat}{VacuumCost}$$

### 9.3 è®¾è®¡åŸåˆ™

1. **é¢„é˜²ä¼˜äºæ²»ç–—**: é¿å…é•¿äº‹åŠ¡ï¼Œè€Œéé¢‘ç¹VACUUM
2. **åˆ†è€Œæ²»ä¹‹**: åˆ†åŒºè¡¨é™ä½ç»´æŠ¤ç²’åº¦
3. **ç›‘æ§é©±åŠ¨**: åŸºäºå®é™…æ•°æ®è°ƒä¼˜
4. **æƒè¡¡æ¸…æ™°**: æ˜ç¡®å­˜å‚¨æˆæœ¬æ¢å¹¶å‘æ€§èƒ½

---

## åã€å»¶ä¼¸é˜…è¯»

**PostgreSQLå­˜å‚¨**:

- *PostgreSQL Internals* (Bruce Momjian)
- PostgreSQL Wiki: VACUUMè¯¦è§£

**æ€§èƒ½ä¼˜åŒ–**:

- *PostgreSQL 14 Internals* (Egor Rogov)
- Cybertecåšå®¢: VACUUMæœ€ä½³å®è·µ

**æ‰©å±•æ–¹å‘**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md` â†’ MVCCæœºåˆ¶è¯¦è§£
- `05-å®ç°æœºåˆ¶/03-PostgreSQL-VACUUMæœºåˆ¶.md` â†’ VACUUMæºç åˆ†æ
- `06-æ€§èƒ½åˆ†æ/03-å­˜å‚¨å¼€é”€åˆ†æ.md` â†’ è¯¦ç»†é‡åŒ–åˆ†æ

---

## åä¸€ã€å®Œæ•´å®ç°ä»£ç 

### 11.1 ç‰ˆæœ¬é“¾é•¿åº¦ç›‘æ§å®ç°

```python
import psycopg2
from typing import Dict, List

class VersionChainMonitor:
    """ç‰ˆæœ¬é“¾é•¿åº¦ç›‘æ§å™¨"""

    def __init__(self, db_conn):
        self.conn = db_conn

    def get_version_chain_length(self, table_name: str, ctid: str) -> int:
        """è·å–ç‰ˆæœ¬é“¾é•¿åº¦"""
        query = f"""
            WITH RECURSIVE version_chain AS (
                SELECT ctid, xmin, xmax, 1 as depth
                FROM {table_name}
                WHERE ctid = %s

                UNION ALL

                SELECT t.ctid, t.xmin, t.xmax, vc.depth + 1
                FROM {table_name} t
                JOIN version_chain vc ON t.ctid = vc.xmax::text
                WHERE vc.depth < 100  -- é˜²æ­¢æ— é™é€’å½’
            )
            SELECT MAX(depth) FROM version_chain
        """
        cur = self.conn.cursor()
        cur.execute(query, (ctid,))
        return cur.fetchone()[0] or 0

    def find_long_chains(self, table_name: str, threshold: int = 10) -> List[Dict]:
        """æŸ¥æ‰¾é•¿ç‰ˆæœ¬é“¾"""
        query = f"""
            SELECT
                ctid,
                xmin,
                xmax,
                (SELECT COUNT(*) FROM {table_name} t2
                 WHERE t2.ctid::text LIKE t1.xmax::text || '%') as chain_length
            FROM {table_name} t1
            WHERE (SELECT COUNT(*) FROM {table_name} t2
                   WHERE t2.ctid::text LIKE t1.xmax::text || '%') > %s
        """
        cur = self.conn.cursor()
        cur.execute(query, (threshold,))

        results = []
        for row in cur.fetchall():
            results.append({
                'ctid': row[0],
                'xmin': row[1],
                'xmax': row[2],
                'chain_length': row[3]
            })

        return results
```

### 11.2 è‡ªåŠ¨VACUUMè°ƒåº¦å™¨å®ç°

```python
import time
from datetime import datetime, timedelta

class AutoVacuumScheduler:
    """è‡ªåŠ¨VACUUMè°ƒåº¦å™¨"""

    def __init__(self, db_conn):
        self.db = db_conn
        self.last_vacuum = {}
        self.vacuum_threshold = {
            'dead_tuples_ratio': 0.2,  # 20%æ­»å…ƒç»„
            'min_interval_hours': 1,    # æœ€å°é—´éš”1å°æ—¶
        }

    def should_vacuum(self, table_name: str) -> bool:
        """åˆ¤æ–­æ˜¯å¦éœ€è¦VACUUM"""
        # æ£€æŸ¥æ­»å…ƒç»„æ¯”ä¾‹
        dead_ratio = self.get_dead_tuple_ratio(table_name)

        # æ£€æŸ¥ä¸Šæ¬¡VACUUMæ—¶é—´
        last_vacuum_time = self.last_vacuum.get(table_name, datetime.min)
        hours_since_vacuum = (datetime.now() - last_vacuum_time).total_seconds() / 3600

        # å†³ç­–
        if dead_ratio > self.vacuum_threshold['dead_tuples_ratio']:
            if hours_since_vacuum >= self.vacuum_threshold['min_interval_hours']:
                return True

        return False

    def get_dead_tuple_ratio(self, table_name: str) -> float:
        """è·å–æ­»å…ƒç»„æ¯”ä¾‹"""
        cur = self.db.cursor()
        cur.execute(f"""
            SELECT
                n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0) as dead_ratio
            FROM pg_stat_user_tables
            WHERE relname = %s
        """, (table_name,))
        row = cur.fetchone()
        return row[0] if row else 0.0

    def schedule_vacuum(self, table_name: str):
        """è°ƒåº¦VACUUM"""
        if self.should_vacuum(table_name):
            print(f"æ‰§è¡ŒVACUUM: {table_name}")
            cur = self.db.cursor()
            cur.execute(f"VACUUM ANALYZE {table_name}")
            self.last_vacuum[table_name] = datetime.now()
```

---

## åäºŒã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 12.1 æ¡ˆä¾‹: é«˜å¹¶å‘å†™å…¥è¡¨å­˜å‚¨ä¼˜åŒ–

**åœºæ™¯**: è®¢å•è¡¨ï¼ˆé«˜å¹¶å‘å†™å…¥ï¼‰

**é—®é¢˜**: ç‰ˆæœ¬é“¾å¿«é€Ÿå˜é•¿

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. æé«˜fillfactorï¼ˆå‡å°‘æ›´æ–°ï¼‰
ALTER TABLE orders SET (fillfactor = 70);

-- 2. å®šæœŸVACUUM
VACUUM ANALYZE orders;

-- 3. åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆï¼‰
CREATE TABLE orders_2025_12 PARTITION OF orders
FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| **ç‰ˆæœ¬é“¾å¹³å‡é•¿åº¦** | 50 | 5 | -90% |
| **å­˜å‚¨ç©ºé—´** | 100GB | 60GB | -40% |
| **æŸ¥è¯¢å»¶è¿Ÿ** | 50ms | 5ms | -90% |

### 12.2 æ¡ˆä¾‹: é•¿äº‹åŠ¡ç‰ˆæœ¬é“¾ä¼˜åŒ–

**é—®é¢˜**: é•¿äº‹åŠ¡å¯¼è‡´ç‰ˆæœ¬é“¾æ— æ³•æ¸…ç†

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```python
# æ£€æµ‹é•¿äº‹åŠ¡
def find_long_transactions(db_conn):
    cur = db_conn.cursor()
    cur.execute("""
        SELECT pid, now() - xact_start as duration
        FROM pg_stat_activity
        WHERE state = 'active'
          AND now() - xact_start > interval '5 minutes'
    """)
    return cur.fetchall()

# ç»ˆæ­¢é•¿äº‹åŠ¡
def kill_long_transactions(db_conn):
    long_txs = find_long_transactions(db_conn)
    for pid, duration in long_txs:
        print(f"ç»ˆæ­¢é•¿äº‹åŠ¡: PID={pid}, æ—¶é•¿={duration}")
        db_conn.execute(f"SELECT pg_terminate_backend({pid})")
```

---

## åä¸‰ã€åä¾‹ä¸é”™è¯¯è®¾è®¡

### åä¾‹1: å¿½ç•¥VACUUMå¯¼è‡´å­˜å‚¨çˆ†ç‚¸

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: ç¦ç”¨autovacuum
ALTER TABLE orders SET (autovacuum_enabled = false);

-- é—®é¢˜: æ­»å…ƒç»„ç´¯ç§¯ï¼Œå­˜å‚¨å¿«é€Ÿè†¨èƒ€
-- 100GBè¡¨ â†’ 500GBï¼ˆ5å€è†¨èƒ€ï¼‰
```

**é—®é¢˜**: å­˜å‚¨ç©ºé—´å¿«é€Ÿè€—å°½

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: å¯ç”¨autovacuumå¹¶è°ƒä¼˜
ALTER TABLE orders SET (
    autovacuum_enabled = true,
    autovacuum_vacuum_scale_factor = 0.1,  -- 10%è§¦å‘
    autovacuum_vacuum_cost_delay = 10ms
);
```

### åä¾‹2: è¿‡åº¦VACUUMå¯¼è‡´æ€§èƒ½ä¸‹é™

**é”™è¯¯è®¾è®¡**:

```sql
-- é”™è¯¯: VACUUMè¿‡äºé¢‘ç¹
-- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
SELECT cron.schedule('vacuum-orders', '*/5 * * * *', 'VACUUM orders');

-- é—®é¢˜: VACUUMå ç”¨å¤§é‡IOï¼Œé˜»å¡æ­£å¸¸æŸ¥è¯¢
```

**é—®é¢˜**: æ€§èƒ½ä¸‹é™ï¼Œç”¨æˆ·ä½“éªŒå·®

**æ­£ç¡®è®¾è®¡**:

```sql
-- æ­£ç¡®: åŸºäºé˜ˆå€¼è§¦å‘
-- ä»…å½“æ­»å…ƒç»„ > 20% æ—¶æ‰§è¡Œ
SELECT cron.schedule(
    'vacuum-orders',
    '0 * * * *',  -- æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    'SELECT auto_vacuum_if_needed(''orders'')'
);
```

---

**ç‰ˆæœ¬**: 2.0.0ï¼ˆå¤§å¹…å……å®ï¼‰
**æœ€åæ›´æ–°**: 2025-12-05
**æ–°å¢å†…å®¹**: å®Œæ•´ç‰ˆæœ¬é“¾ç›‘æ§/VACUUMè°ƒåº¦å™¨å®ç°ã€å®é™…æ¡ˆä¾‹ã€åä¾‹åˆ†æ

**å…³è”æ–‡æ¡£**:

- `01-æ ¸å¿ƒç†è®ºæ¨¡å‹/02-MVCCç†è®ºå®Œæ•´è§£æ.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æ/04-æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡.md`
- `06-æ€§èƒ½åˆ†æ/03-å­˜å‚¨å¼€é”€åˆ†æ.md`
