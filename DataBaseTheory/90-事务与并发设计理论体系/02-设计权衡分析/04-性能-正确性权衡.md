# 04 | æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡

> **å†³ç­–å·¥å…·**: æœ¬æ–‡æ¡£æä¾›æ€§èƒ½ä¸Žæ­£ç¡®æ€§çš„é‡åŒ–æƒè¡¡åˆ†æžï¼Œå¸®åŠ©åœ¨è®¾è®¡æ—¶åšå‡ºæ˜Žæ™ºçš„å–èˆå†³ç­–ã€‚

---

## ðŸ“‘ ç›®å½•

- [04 | æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡](#04--æ€§èƒ½-æ­£ç¡®æ€§æƒè¡¡)
  - [ðŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æƒè¡¡æ¡†æž¶](#ä¸€æƒè¡¡æ¡†æž¶)
    - [1.1 æ ¸å¿ƒçŸ›ç›¾](#11-æ ¸å¿ƒçŸ›ç›¾)
    - [1.2 æƒè¡¡ç©ºé—´](#12-æƒè¡¡ç©ºé—´)
  - [äºŒã€éš”ç¦»çº§åˆ«æ€§èƒ½æƒè¡¡](#äºŒéš”ç¦»çº§åˆ«æ€§èƒ½æƒè¡¡)
    - [2.1 é‡åŒ–å¯¹æ¯”çŸ©é˜µ](#21-é‡åŒ–å¯¹æ¯”çŸ©é˜µ)
    - [2.2 å¼‚å¸¸çŽ°è±¡ä»£ä»·](#22-å¼‚å¸¸çŽ°è±¡ä»£ä»·)
    - [2.3 ä¸­æ­¢é‡è¯•æˆæœ¬](#23-ä¸­æ­¢é‡è¯•æˆæœ¬)
  - [ä¸‰ã€é”ç²’åº¦æƒè¡¡](#ä¸‰é”ç²’åº¦æƒè¡¡)
    - [3.1 é”ç²’åº¦å±‚æ¬¡](#31-é”ç²’åº¦å±‚æ¬¡)
    - [3.2 æ€§èƒ½æ¨¡åž‹](#32-æ€§èƒ½æ¨¡åž‹)
    - [3.3 çƒ­ç‚¹è¡Œé—®é¢˜](#33-çƒ­ç‚¹è¡Œé—®é¢˜)
  - [å››ã€å¹¶å‘æŽ§åˆ¶æœºåˆ¶æƒè¡¡](#å››å¹¶å‘æŽ§åˆ¶æœºåˆ¶æƒè¡¡)
    - [4.1 ä¸‰å¤§æœºåˆ¶å¯¹æ¯”](#41-ä¸‰å¤§æœºåˆ¶å¯¹æ¯”)
    - [4.2 è¯»å†™æ¯”ä¾‹å½±å“](#42-è¯»å†™æ¯”ä¾‹å½±å“)
    - [4.3 VACUUMå¼€é”€æƒè¡¡](#43-vacuumå¼€é”€æƒè¡¡)
  - [äº”ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§æƒè¡¡](#äº”åˆ†å¸ƒå¼ä¸€è‡´æ€§æƒè¡¡)
    - [5.1 CAPæƒè¡¡æ›²çº¿](#51-capæƒè¡¡æ›²çº¿)
    - [5.2 å¯ç”¨æ€§æƒè¡¡](#52-å¯ç”¨æ€§æƒè¡¡)
  - [å…­ã€ä¼˜åŒ–ç­–ç•¥æƒè¡¡](#å…­ä¼˜åŒ–ç­–ç•¥æƒè¡¡)
    - [6.1 ç´¢å¼•æ•°é‡æƒè¡¡](#61-ç´¢å¼•æ•°é‡æƒè¡¡)
    - [6.2 è¿žæŽ¥æ± å¤§å°æƒè¡¡](#62-è¿žæŽ¥æ± å¤§å°æƒè¡¡)
    - [6.3 æ‰¹é‡æäº¤æƒè¡¡](#63-æ‰¹é‡æäº¤æƒè¡¡)
  - [ä¸ƒã€é‡åŒ–åˆ†æžæ¨¡åž‹](#ä¸ƒé‡åŒ–åˆ†æžæ¨¡åž‹)
    - [7.1 æ€§èƒ½-æ­£ç¡®æ€§æ›²çº¿](#71-æ€§èƒ½-æ­£ç¡®æ€§æ›²çº¿)
    - [7.2 æˆæœ¬-æ”¶ç›Šåˆ†æž](#72-æˆæœ¬-æ”¶ç›Šåˆ†æž)
    - [7.3 å“åº”æ—¶é—´åˆ†è§£](#73-å“åº”æ—¶é—´åˆ†è§£)
  - [å…«ã€å®žè·µæ¡ˆä¾‹](#å…«å®žè·µæ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–](#æ¡ˆä¾‹1-ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–)
    - [æ¡ˆä¾‹2: å®žæ—¶åˆ†æžç³»ç»Ÿ](#æ¡ˆä¾‹2-å®žæ—¶åˆ†æžç³»ç»Ÿ)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [9.1 æ ¸å¿ƒè´¡çŒ®](#91-æ ¸å¿ƒè´¡çŒ®)
    - [9.2 å…³é”®å…¬å¼](#92-å…³é”®å…¬å¼)
    - [9.3 è®¾è®¡åŽŸåˆ™](#93-è®¾è®¡åŽŸåˆ™)
  - [åã€å»¶ä¼¸é˜…è¯»](#åå»¶ä¼¸é˜…è¯»)

---

## ä¸€ã€æƒè¡¡æ¡†æž¶

### 1.1 æ ¸å¿ƒçŸ›ç›¾

**åŸºæœ¬å®šå¾‹**:

$$\text{Performance} \propto \frac{1}{\text{Correctness Guarantee}}$$

**å›¾ç¤º**:

```
æ­£ç¡®æ€§ä¿è¯
  â†‘
  â”‚    Serializable â—
  â”‚
  â”‚         Repeatable Read â—
  â”‚
  â”‚              Read Committed â—
  â”‚
  â”‚                     Relaxed â—
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ€§èƒ½
```

### 1.2 æƒè¡¡ç©ºé—´

**ä¸‰ç»´æƒè¡¡ç©ºé—´**:

```
         æ­£ç¡®æ€§
          â†‘
         /|\
        / | \
       /  |  \
      /   |   \
     â—â”€â”€â”€â”€â—â”€â”€â”€â”€â— â† æ€§èƒ½
      \   |   /
       \  |  /
        \ | /
         \|/
          â†“
        å¤æ‚åº¦
```

**å¸•ç´¯æ‰˜è¾¹ç•Œ**: æ— æ³•åŒæ—¶ä¼˜åŒ–ä¸‰ä¸ªç»´åº¦

---

## äºŒã€éš”ç¦»çº§åˆ«æ€§èƒ½æƒè¡¡

### 2.1 é‡åŒ–å¯¹æ¯”çŸ©é˜µ

| éš”ç¦»çº§åˆ« | TPS | å»¶è¿Ÿ(P99) | ä¸­æ­¢çŽ‡ | CPU | å†…å­˜ | å¤æ‚åº¦ |
|---------|-----|----------|--------|-----|------|--------|
| **Read Committed** | 10,000 | 10ms | 1% | 50% | 2GB | â˜…â˜†â˜†â˜†â˜† |
| **Repeatable Read** | 8,000 | 15ms | 5% | 60% | 3GB | â˜…â˜…â˜†â˜†â˜† |
| **Serializable** | 5,000 | 30ms | 15% | 80% | 4GB | â˜…â˜…â˜…â˜…â˜† |

**æ€§èƒ½è¡°å‡å…¬å¼**:

$$TPS_{level} = TPS_{base} \times (1 - 0.2 \times level)$$

å…¶ä¸­ level: RC=0, RR=1, Serializable=2

### 2.2 å¼‚å¸¸çŽ°è±¡ä»£ä»·

| å¼‚å¸¸ | å½±å“ | æ£€æµ‹æˆæœ¬ | é¢„é˜²æˆæœ¬ |
|-----|------|---------|---------|
| **è„è¯»** | é«˜ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰ | ä½Ž | ä½Žï¼ˆè¯­å¥çº§å¿«ç…§ï¼‰ |
| **ä¸å¯é‡å¤è¯»** | ä¸­ï¼ˆç»Ÿè®¡é”™è¯¯ï¼‰ | ä½Ž | ä¸­ï¼ˆäº‹åŠ¡çº§å¿«ç…§ï¼‰ |
| **å¹»è¯»** | ä¸­ï¼ˆè®¡æ•°é”™è¯¯ï¼‰ | ä¸­ | ä¸­ï¼ˆèŒƒå›´é”ï¼‰ |
| **å†™å€¾æ–œ** | é«˜ï¼ˆçº¦æŸè¿åï¼‰ | é«˜ | é«˜ï¼ˆSSIæ£€æµ‹ï¼‰ |

**é€‰æ‹©å†³ç­–**:

```python
def choose_isolation_level(business_requirement):
    """
    æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©éš”ç¦»çº§åˆ«
    """
    if business_requirement.requires_serializability:
        # é‡‘èžã€åº“å­˜ç­‰æ ¸å¿ƒä¸šåŠ¡
        return 'SERIALIZABLE'

    elif business_requirement.requires_consistent_view:
        # æŠ¥è¡¨ã€åˆ†æžç­‰
        return 'REPEATABLE READ'

    else:
        # å¸¸è§„Webåº”ç”¨
        return 'READ COMMITTED'
```

### 2.3 ä¸­æ­¢é‡è¯•æˆæœ¬

**ä¸­æ­¢çŽ‡æ¨¡åž‹**:

$$AbortRate = k \times Concurrency \times ConflictProbability$$

**é‡è¯•æˆæœ¬**:

$$TotalCost = BaseCost + AbortRate \times RetryCost$$

**é‡åŒ–ç¤ºä¾‹**:

| å¹¶å‘åº¦ | RCä¸­æ­¢çŽ‡ | RRä¸­æ­¢çŽ‡ | Serializableä¸­æ­¢çŽ‡ |
|-------|---------|---------|-------------------|
| 10 | 0.1% | 0.5% | 2% |
| 100 | 1% | 5% | 15% |
| 1000 | 5% | 20% | 50% |

**å†³ç­–é˜ˆå€¼**: ä¸­æ­¢çŽ‡>10%æ—¶è€ƒè™‘é™çº§éš”ç¦»çº§åˆ«

---

## ä¸‰ã€é”ç²’åº¦æƒè¡¡

### 3.1 é”ç²’åº¦å±‚æ¬¡

```text
æ•°æ®åº“çº§é” (æœ€ç²—)
    â†“
è¡¨çº§é”
    â†“
é¡µçº§é”
    â†“
è¡Œçº§é”
    â†“
å­—æ®µçº§é” (æœ€ç»†ï¼ŒPostgreSQLä¸æ”¯æŒ)
```

### 3.2 æ€§èƒ½æ¨¡åž‹

**åžåé‡å…¬å¼**:

$$TPS = \frac{Concurrency}{LockTime + ConflictWaitTime}$$

**å†²çªæ¦‚çŽ‡**:

$$P_{conflict} = \frac{LockedRows}{TotalRows} \times ConcurrentWriters$$

**é‡åŒ–å¯¹æ¯”**:

| é”ç²’åº¦ | å†²çªæ¦‚çŽ‡ | å¹³å‡ç­‰å¾… | TPS | é€‚ç”¨åœºæ™¯ |
|-------|---------|---------|-----|---------|
| **è¡¨çº§** | 100% | 100ms | 10 | DDLæ“ä½œ |
| **é¡µçº§** | 10% | 10ms | 100 | æ‰¹é‡æ›´æ–° |
| **è¡Œçº§** | 0.1% | 1ms | 1000 | OLTP |

### 3.3 çƒ­ç‚¹è¡Œé—®é¢˜

**é—®é¢˜**: å¤šä¸ªäº‹åŠ¡ç«žäº‰åŒä¸€è¡Œ

$$WaitTime = QueueLength \times AvgHoldTime$$

**è§£å†³æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | åŽŸç† | æ€§èƒ½æå‡ | å®žçŽ°å¤æ‚åº¦ |
|-----|------|---------|-----------|
| **è¡Œåˆ†æ•£** | é¢„åˆ†é…å¤šè¡Œåˆ†æ‘Šè´Ÿè½½ | 10Ã— | â˜…â˜…â˜†â˜†â˜† |
| **ä¹è§‚é”** | ç‰ˆæœ¬å·CASï¼Œæ— é”ç­‰å¾… | 5Ã— | â˜…â˜…â˜…â˜†â˜† |
| **é˜Ÿåˆ—åŒ–** | ä¸²è¡Œå¤„ç†ï¼Œæ‰¹é‡æäº¤ | 3Ã— | â˜…â˜…â˜…â˜…â˜† |
| **ç¼“å­˜** | Redisè®¡æ•°ï¼Œå®šæœŸåŒæ­¥ | 100Ã— | â˜…â˜…â˜…â˜†â˜† |

**ç¤ºä¾‹ï¼šç§’æ€åº“å­˜**

```python
# æ–¹æ¡ˆ1: å•è¡Œçƒ­ç‚¹ï¼ˆæ€§èƒ½å·®ï¼‰
UPDATE inventory SET stock = stock - 1 WHERE product_id = 1;

# æ–¹æ¡ˆ2: è¡Œåˆ†æ•£ï¼ˆæ€§èƒ½å¥½ï¼‰
# é¢„åˆ†é…10è¡Œ
INSERT INTO inventory VALUES (1, 1000), (1, 1000), ..., (1, 1000);

# éšæœºé€‰æ‹©ä¸€è¡Œæ‰£å‡
shard_id = random.randint(0, 9)
UPDATE inventory
SET stock = stock - 1
WHERE product_id = 1 AND shard_id = {shard_id} AND stock > 0;
```

---

## å››ã€å¹¶å‘æŽ§åˆ¶æœºåˆ¶æƒè¡¡

### 4.1 ä¸‰å¤§æœºåˆ¶å¯¹æ¯”

| æœºåˆ¶ | è¯»æ€§èƒ½ | å†™æ€§èƒ½ | å­˜å‚¨å¼€é”€ | å®žçŽ°å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|-----|-------|-------|---------|-----------|---------|
| **2PL** | ä½Ž | ä½Ž | ä½Ž | â˜…â˜…â˜†â˜†â˜† | å†™å¤šåœºæ™¯ |
| **OCC** | é«˜ | ä¸­ | ä½Ž | â˜…â˜…â˜…â˜†â˜† | ä½Žå†²çª |
| **MVCC** | æžé«˜ | ä¸­ | é«˜ | â˜…â˜…â˜…â˜…â˜† | è¯»å¤šåœºæ™¯ |

### 4.2 è¯»å†™æ¯”ä¾‹å½±å“

**æ€§èƒ½æ›²çº¿**:

```text
TPS
  â†‘
  â”‚   â—â”€â”€â”€â”€â”€ MVCC
  â”‚  /
  â”‚ /  â—â”€â”€ OCC
  â”‚/  /
  â”‚  /
  â”‚ / â—â”€â”€ 2PL
  â”‚/
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è¯»å†™æ¯” (R/W)
  1:1            100:1
```

**é€‰æ‹©å…¬å¼**:

$$
Mechanism = \begin{cases}
\text{MVCC} & \text{if } R/W > 10 \\
\text{OCC} & \text{if } 1 < R/W \leq 10 \\
\text{2PL} & \text{if } R/W \leq 1
\end{cases}
$$

### 4.3 VACUUMå¼€é”€æƒè¡¡

**MVCCä»£ä»·**:

$$StorageCost = BaseSize \times (1 + AvgChainLength)$$

$$VacuumCPU = ScanRate \times TableSize \times VacuumFrequency$$

**é‡åŒ–ç¤ºä¾‹**:

| æ›´æ–°é¢‘çŽ‡ | è¡¨å¤§å° | ç‰ˆæœ¬é“¾é•¿åº¦ | å­˜å‚¨è†¨èƒ€ | VACUUMå¼€é”€ |
|---------|-------|-----------|---------|-----------|
| 1K/s | 100GB | 2 | 200GB | 10% CPU |
| 10K/s | 100GB | 5 | 500GB | 30% CPU |
| 100K/s | 100GB | 10 | 1TB | 60% CPU |

**ä¼˜åŒ–ç­–ç•¥**:

```sql
-- 1. æé«˜VACUUMé¢‘çŽ‡
ALTER TABLE hot_table SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- é»˜è®¤0.2
    autovacuum_vacuum_threshold = 100        -- é»˜è®¤50
);

-- 2. é™ä½ŽFillfactoré¢„ç•™ç©ºé—´ç»™HOT
ALTER TABLE hot_table SET (fillfactor = 70);  -- é»˜è®¤100

-- 3. åˆ†åŒºè¡¨é™ä½ŽVACUUMç²’åº¦
CREATE TABLE orders_2025 PARTITION OF orders
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
```

---

## äº”ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§æƒè¡¡

### 5.1 CAPæƒè¡¡æ›²çº¿

**å»¶è¿Ÿ-ä¸€è‡´æ€§æ›²çº¿**:

```
å»¶è¿Ÿ(ms)
  â†‘
100â”‚                      â— åŒæ­¥å¤åˆ¶(CP)
 50â”‚              â— Quorum
 10â”‚      â— å¼‚æ­¥å¤åˆ¶(AP)
  1â”‚  â— æœ¬åœ°ç¼“å­˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¸€è‡´æ€§å¼ºåº¦
    Eventual  Causal  Linearizable
```

**å…¬å¼**:

$$Latency = BaseLatency + \alpha \times ConsistencyStrength + \beta \times NetworkRTT$$

**å‚æ•°ä¼°ç®—**:

| ä¸€è‡´æ€§çº§åˆ« | Î±ç³»æ•° | ç¤ºä¾‹å»¶è¿Ÿ(RTT=5ms) |
|-----------|-------|------------------|
| Eventual | 0 | 5ms |
| Causal | 1 | 10ms |
| Sequential | 2 | 15ms |
| Linearizable | 3 | 20ms |

### 5.2 å¯ç”¨æ€§æƒè¡¡

**å¯ç”¨æ€§è®¡ç®—**:

$$Availability_{sync} = Availability_{primary} \times Availability_{standby}$$

**ç¤ºä¾‹**:

| é…ç½® | ä¸»åº“ | å¤‡åº“ | ç»„åˆå¯ç”¨æ€§ |
|-----|------|------|-----------|
| å•æœº | 99.9% | - | **99.9%** |
| å¼‚æ­¥å¤åˆ¶ | 99.9% | 99.9% | **99.9%** (æ•…éšœåˆ‡æ¢) |
| åŒæ­¥å¤åˆ¶ | 99.9% | 99.9% | **99.8%** (éœ€ä¸¤è€…éƒ½å¯ç”¨) |
| Raft 3èŠ‚ç‚¹ | 99.9% Ã— 3 | - | **99.999%** (å¤šæ•°æ´¾) |

**å†³ç­–çŸ©é˜µ**:

| åœºæ™¯ | ä¸€è‡´æ€§éœ€æ±‚ | å¯ç”¨æ€§éœ€æ±‚ | æŽ¨èé…ç½® | å¯ç”¨æ€§ |
|-----|-----------|-----------|---------|--------|
| é‡‘èžæ ¸å¿ƒ | å¼º | ä¸­ | åŒæ­¥å¤åˆ¶ | 99.9% |
| Webåº”ç”¨ | ä¸­ | é«˜ | å¼‚æ­¥å¤åˆ¶ | 99.99% |
| é…ç½®ä¸­å¿ƒ | å¼º | é«˜ | Raft | 99.999% |
| æ—¥å¿—ç³»ç»Ÿ | å¼± | æžé«˜ | å¼‚æ­¥+ç¼“å­˜ | 99.999% |

---

## å…­ã€ä¼˜åŒ–ç­–ç•¥æƒè¡¡

### 6.1 ç´¢å¼•æ•°é‡æƒè¡¡

**å…¬å¼**:

$$ReadCost = BaseCost \times (1 - 0.5 \times \log(IndexCount))$$

$$WriteCost = BaseCost \times (1 + 0.1 \times IndexCount)$$

**æƒè¡¡ç‚¹**:

| è¯»å†™æ¯” | æœ€ä¼˜ç´¢å¼•æ•° | ç†ç”± |
|-------|-----------|------|
| 100:1 | 8-10 | è¯»ä¼˜åŒ–ä¼˜å…ˆ |
| 10:1 | 3-5 | å¹³è¡¡ç‚¹ |
| 1:1 | 1-2 | å†™æ€§èƒ½é‡è¦ |
| 1:10 | 0-1 | ä»…ä¸»é”® |

**é‡åŒ–ç¤ºä¾‹**:

```python
def optimal_index_count(read_ratio, write_ratio):
    """
    è®¡ç®—æœ€ä¼˜ç´¢å¼•æ•°é‡
    """
    # è¯»æ”¶ç›Š: æ¯ä¸ªç´¢å¼•æå‡æŸ¥è¯¢50%
    read_benefit = read_ratio * 0.5

    # å†™æƒ©ç½š: æ¯ä¸ªç´¢å¼•å¢žåŠ 10%å»¶è¿Ÿ
    write_penalty = write_ratio * 0.1

    # è¾¹é™…æ”¶ç›Šé€’å‡
    optimal = int((read_benefit / write_penalty) ** 0.5)

    return min(max(optimal, 1), 10)  # é™åˆ¶åœ¨[1, 10]

# ç¤ºä¾‹
print(optimal_index_count(0.9, 0.1))  # è¾“å‡º: 5ä¸ªç´¢å¼•
```

### 6.2 è¿žæŽ¥æ± å¤§å°æƒè¡¡

**Little's Law**:

$$Connections = TPS \times Latency_{avg}$$

**è¿‡å°çš„ä»£ä»·**: è¿žæŽ¥ç­‰å¾…

$$WaitTime = \frac{\lambda}{\mu(\mu - \lambda)} \quad \text{(M/M/1é˜Ÿåˆ—)}$$

**è¿‡å¤§çš„ä»£ä»·**: èµ„æºæµªè´¹ + ä¸Šä¸‹æ–‡åˆ‡æ¢

$$ContextSwitchCost = n \times SwitchTime$$

**æœ€ä¼˜å…¬å¼**:

$$Optimal_{connections} = TPS \times (Latency + SafetyMargin)$$

**é‡åŒ–ç¤ºä¾‹**:

| TPS | å¹³å‡å»¶è¿Ÿ | æŽ¨èè¿žæŽ¥æ•° | ç†ç”± |
|-----|---------|-----------|------|
| 100 | 10ms | 2-5 | ä½Žè´Ÿè½½ |
| 1,000 | 10ms | 10-20 | ä¸­è´Ÿè½½ |
| 10,000 | 10ms | 100-150 | é«˜è´Ÿè½½ |

**é…ç½®å»ºè®®**:

```python
# åŸºäºŽå®žé™…è´Ÿè½½åŠ¨æ€è°ƒæ•´
def calculate_pool_size(tps, avg_latency_ms):
    base = int(tps * avg_latency_ms / 1000)
    min_size = max(base // 2, 5)
    max_size = base * 2

    return {
        'min': min_size,
        'max': max_size,
        'initial': base
    }
```

### 6.3 æ‰¹é‡æäº¤æƒè¡¡

**å•æ¡æäº¤**:

- âœ… å»¶è¿Ÿä½Žï¼ˆå³æ—¶å“åº”ï¼‰
- âŒ åžåé‡ä½Žï¼ˆWALå¼€é”€å¤§ï¼‰

**æ‰¹é‡æäº¤**:

- âœ… åžåé‡é«˜ï¼ˆåˆ†æ‘ŠWALå¼€é”€ï¼‰
- âŒ å»¶è¿Ÿé«˜ï¼ˆç­‰å¾…æ‰¹æ¬¡ï¼‰

**æƒè¡¡å…¬å¼**:

$$Throughput_{batch} = \frac{BatchSize}{Latency_{batch}}$$

$$Latency_{batch} = BaseLat + BatchWaitTime$$

**æœ€ä¼˜æ‰¹æ¬¡å¤§å°**:

```python
def optimal_batch_size(target_latency_ms, wal_sync_time_ms):
    """
    è®¡ç®—æœ€ä¼˜æ‰¹æ¬¡å¤§å°

    target_latency: ç›®æ ‡å»¶è¿Ÿ
    wal_sync_time: WALåŒæ­¥æ—¶é—´
    """
    # æ¯mså¯ç§¯ç´¯çš„è¯·æ±‚æ•°
    request_rate = 1000  # å‡è®¾1000 TPS

    # æœ€å¤šç­‰å¾…æ—¶é—´
    max_wait = target_latency_ms - wal_sync_time_ms

    # æœ€ä¼˜æ‰¹æ¬¡
    batch_size = int(request_rate * max_wait / 1000)

    return max(batch_size, 1)

# ç¤ºä¾‹
print(optimal_batch_size(100, 10))  # ç›®æ ‡100mså»¶è¿Ÿ
# è¾“å‡º: 90ä¸ªè¯·æ±‚/æ‰¹æ¬¡
```

---

## ä¸ƒã€é‡åŒ–åˆ†æžæ¨¡åž‹

### 7.1 æ€§èƒ½-æ­£ç¡®æ€§æ›²çº¿

**æ•°å­¦æ¨¡åž‹**:

$$Performance = P_{max} \times (1 - e^{-\alpha \times ErrorTolerance})$$

**å›¾ç¤º**:

```
TPS (K)
  â†‘
12â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  æœ€å¤§æ€§èƒ½ï¼ˆRelaxedï¼‰
10â”‚           â•±
 8â”‚        â•±
 6â”‚     â•±  â— MVCC RC
 4â”‚  â•±
 2â”‚â•±  â— Serializable
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ é”™è¯¯å®¹å¿åº¦
    0%    5%    10%   15%
```

### 7.2 æˆæœ¬-æ”¶ç›Šåˆ†æž

**æ€»æˆæœ¬æ¨¡åž‹**:

$$TotalCost = HardwareCost + OperationCost + ErrorCost$$

**é”™è¯¯æˆæœ¬**:

$$ErrorCost = ErrorRate \times AvgErrorImpact$$

**é‡åŒ–ç¤ºä¾‹ï¼šé€‰æ‹©éš”ç¦»çº§åˆ«**

| éš”ç¦»çº§åˆ« | ç¡¬ä»¶ | è¿ç»´ | é”™è¯¯æˆæœ¬ | æ€»æˆæœ¬ | ROI |
|---------|------|------|---------|--------|-----|
| RC | $100 | $50 | $200 | $350 | 2.0Ã— |
| RR | $120 | $60 | $50 | $230 | 3.0Ã— âœ… |
| Serializable | $150 | $80 | $10 | $240 | 2.9Ã— |

**å†³ç­–**: RRæä¾›æœ€ä½³ROI

### 7.3 å“åº”æ—¶é—´åˆ†è§£

**åˆ†è§£æ¨¡åž‹**:

$$Latency_{total} = Latency_{network} + Latency_{queue} + Latency_{process} + Latency_{io}$$

**ä¼˜åŒ–ä¼˜å…ˆçº§**:

```python
def analyze_latency(trace):
    """
    åˆ†æžå»¶è¿Ÿç“¶é¢ˆ
    """
    components = {
        'network': measure_network_latency(),
        'queue': measure_queue_time(),
        'lock': measure_lock_wait(),
        'cpu': measure_cpu_time(),
        'io': measure_io_time()
    }

    # æŒ‰è´¡çŒ®æŽ’åº
    sorted_components = sorted(
        components.items(),
        key=lambda x: x[1],
        reverse=True
    )

    # ä¼˜åŒ–æœ€å¤§è´¡çŒ®è€…
    bottleneck = sorted_components[0]

    return {
        'bottleneck': bottleneck[0],
        'impact': bottleneck[1] / sum(components.values()),
        'components': components
    }
```

---

## å…«ã€å®žè·µæ¡ˆä¾‹

### æ¡ˆä¾‹1: ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–

**åˆå§‹çŠ¶æ€**:

- éš”ç¦»çº§åˆ«: Serializable
- TPS: 500
- P99å»¶è¿Ÿ: 200ms
- ä¸­æ­¢çŽ‡: 20%

**é—®é¢˜åˆ†æž**:

1. **é«˜ä¸­æ­¢çŽ‡**: Serializableè¿‡äºŽä¸¥æ ¼
2. **çƒ­ç‚¹è¡¨**: ordersè¡¨è¢«é¢‘ç¹æ›´æ–°
3. **é”ç«žäº‰**: è®¢å•å·åºåˆ—æˆä¸ºç“¶é¢ˆ

**ä¼˜åŒ–æ–¹æ¡ˆ**:

| ä¼˜åŒ– | æŽªæ–½ | æ€§èƒ½æå‡ |
|-----|------|---------|
| 1 | é™çº§åˆ°Repeatable Read | TPS +40% |
| 2 | è®¢å•è¡¨åˆ†åŒºï¼ˆæŒ‰æœˆï¼‰ | P99å»¶è¿Ÿ -30% |
| 3 | ä½¿ç”¨UUIDæ›¿ä»£è‡ªå¢žID | é”ç«žäº‰ -80% |
| 4 | å¢žåŠ 5ä¸ªç´¢å¼•ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰ | æŸ¥è¯¢æ—¶é—´ -50% |

**ä¼˜åŒ–åŽ**:

- TPS: 1,200 (+140%)
- P99å»¶è¿Ÿ: 80ms (-60%)
- ä¸­æ­¢çŽ‡: 3% (-85%)

**æˆæœ¬**:

- å­˜å‚¨å¢žåŠ : 20% (ç´¢å¼•)
- VACUUMé¢‘çŽ‡: 2Ã— (åˆ†åŒºä¼˜åŒ–)

**ROI**: æ€§èƒ½æå‡2.4Ã—ï¼Œæˆæœ¬å¢žåŠ ä»…20%

### æ¡ˆä¾‹2: å®žæ—¶åˆ†æžç³»ç»Ÿ

**éœ€æ±‚**:

- æŸ¥è¯¢å¤æ‚ï¼ˆJOINã€èšåˆï¼‰
- æ•°æ®å®žæ—¶æ€§è¦æ±‚ï¼ˆ<5ç§’ï¼‰
- è¯»å†™æ¯”: 1000:1

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | éš”ç¦»çº§åˆ« | æŸ¥è¯¢å»¶è¿Ÿ | æ•°æ®å»¶è¿Ÿ | æˆæœ¬ |
|-----|---------|---------|---------|------|
| A: ä¸»åº“ç›´æŽ¥æŸ¥è¯¢ | RR | 5s | 0s | ä½Ž |
| B: åªè¯»å‰¯æœ¬ | RC | 5s | 2s | ä¸­ |
| C: ç‰©åŒ–è§†å›¾ | RC | 0.1s | 5s | é«˜ |

**å†³ç­–**: é€‰æ‹©æ–¹æ¡ˆBï¼ˆå¹³è¡¡ï¼‰

```sql
-- é…ç½®åªè¯»å‰¯æœ¬
ALTER SYSTEM SET hot_standby = on;

-- åº”ç”¨å±‚é…ç½®
# è¯»è¯·æ±‚è·¯ç”±åˆ°åªè¯»å‰¯æœ¬
read_connection = connect('standby.db.com')
write_connection = connect('primary.db.com')

# æŸ¥è¯¢åˆ†ç¦»
def query(sql):
    if is_select(sql):
        return read_connection.execute(sql)
    else:
        return write_connection.execute(sql)
```

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè´¡çŒ®

**é‡åŒ–æ¨¡åž‹**:

1. éš”ç¦»çº§åˆ«æ€§èƒ½å…¬å¼ï¼ˆç¬¬2.1èŠ‚ï¼‰
2. é”ç²’åº¦å†²çªæ¦‚çŽ‡ï¼ˆç¬¬3.2èŠ‚ï¼‰
3. æ‰¹é‡æäº¤ä¼˜åŒ–å…¬å¼ï¼ˆç¬¬3.3èŠ‚ï¼‰
4. æˆæœ¬-æ”¶ç›Šåˆ†æžï¼ˆç¬¬7.2èŠ‚ï¼‰

**å®žè·µæ¡ˆä¾‹**:

1. ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡140%ï¼‰
2. å®žæ—¶åˆ†æžç³»ç»Ÿè®¾è®¡

### 9.2 å…³é”®å…¬å¼

**æ€§èƒ½-æ­£ç¡®æ€§åŸºæœ¬å…³ç³»**:

$$TPS \propto \frac{1}{IsolationLevel} \times (1 - AbortRate)$$

**æœ€ä¼˜åŒ–ç›®æ ‡**:

$$\max\left(\frac{Performance}{Cost}\right) \quad \text{subject to } Correctness \geq Threshold$$

### 9.3 è®¾è®¡åŽŸåˆ™

1. **éœ€æ±‚é©±åŠ¨**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ­£ç¡®æ€§çº§åˆ«
2. **é‡åŒ–åˆ†æž**: ç”¨æ•°æ®æ”¯æŒå†³ç­–ï¼Œè€Œéžç›´è§‰
3. **æŒç»­ç›‘æŽ§**: å»ºç«‹æŒ‡æ ‡ä½“ç³»ï¼ŒåŠ¨æ€è°ƒæ•´
4. **æ¸è¿›ä¼˜åŒ–**: ä»Žç®€å•å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–ç“¶é¢ˆ

---

## åã€å»¶ä¼¸é˜…è¯»

**ç†è®ºåŸºç¡€**:

- Hellerstein, J. M., et al. (2007). "Architecture of a Database System"
- Harizopoulos, S., et al. (2008). "OLTP Through the Looking Glass"

**æ€§èƒ½ä¼˜åŒ–**:

- Smith, G. (2010). *PostgreSQL 9.0 High Performance*
- Winand, M. (2012). *SQL Performance Explained*

**æƒè¡¡åˆ†æž**:

- Kleppmann, M. (2017). *Designing Data-Intensive Applications* Chapter 7

**æ‰©å±•æ–¹å‘**:

- `02-è®¾è®¡æƒè¡¡åˆ†æž/02-éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ.md` â†’ è¯¦ç»†éš”ç¦»çº§åˆ«å¯¹æ¯”
- `06-æ€§èƒ½åˆ†æž/01-åžåé‡å…¬å¼æŽ¨å¯¼.md` â†’ å®Œæ•´æ€§èƒ½æ¨¡åž‹
- `06-æ€§èƒ½åˆ†æž/04-é‡åŒ–å¯¹æ¯”å®žéªŒ.md` â†’ å®žæµ‹æ•°æ®

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åŽæ›´æ–°**: 2025-12-05
**å…³è”æ–‡æ¡£**:

- `02-è®¾è®¡æƒè¡¡åˆ†æž/01-å¹¶å‘æŽ§åˆ¶å†³ç­–æ ‘.md`
- `02-è®¾è®¡æƒè¡¡åˆ†æž/02-éš”ç¦»çº§åˆ«æƒè¡¡çŸ©é˜µ.md`
- `06-æ€§èƒ½åˆ†æž/01-åžåé‡å…¬å¼æŽ¨å¯¼.md`
