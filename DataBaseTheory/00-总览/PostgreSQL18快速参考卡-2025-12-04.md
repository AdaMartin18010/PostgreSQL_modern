# PostgreSQL 18å¿«é€Ÿå‚è€ƒå¡

> **ä¸€é¡µçº¸é€ŸæŸ¥æ‰‹å†Œ**

---

## â­ æ ¸å¿ƒæ–°ç‰¹æ€§

```ini
# å¯ç”¨æ–°ç‰¹æ€§
enable_builtin_connection_pooling = on    # å†…ç½®è¿æ¥æ±  -97%å»¶è¿Ÿ
enable_async_io = on                      # å¼‚æ­¥I/O +60%åå
jit = on                                  # JITç¼–è¯‘ -27%æŸ¥è¯¢æ—¶é—´
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ä¼˜åŒ–

```sql
-- B-tree Skip Scanï¼ˆè‡ªåŠ¨ï¼‰
CREATE INDEX idx_multi ON table(col1, col2);
-- æŸ¥è¯¢åªç”¨col2ä¹Ÿèƒ½ç”¨ç´¢å¼•ï¼

-- BRINç´¢å¼•ï¼ˆæ—¶åºæ•°æ®ï¼‰
CREATE INDEX idx_time ON sensor_data USING BRIN (timestamp);
-- ç´¢å¼•å¤§å°-95%

-- å¤šå˜é‡ç»Ÿè®¡
CREATE STATISTICS tbl_stats (dependencies, ndistinct)
ON col1, col2, col3 FROM table;
ANALYZE table;
```

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¢é‡æ’åºï¼ˆè‡ªåŠ¨ï¼‰
-- å¦‚æœæ•°æ®å·²éƒ¨åˆ†æ’åºï¼Œå†…å­˜-95%

-- å¹¶è¡ŒVACUUM
VACUUM (PARALLEL 8) large_table;
-- æ—¶é—´-31%

-- LZ4å‹ç¼©
ALTER TABLE tbl ALTER COLUMN col SET COMPRESSION lz4;
-- å­˜å‚¨-70%
```

---

## ğŸ“Š ç›‘æ§SQL

### æ…¢æŸ¥è¯¢

```sql
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC LIMIT 10;
```

### ç¼“å­˜å‘½ä¸­ç‡

```sql
SELECT ROUND(
    sum(heap_blks_hit) * 100.0 /
    NULLIF(sum(heap_blks_hit + heap_blks_read), 0), 2
) FROM pg_statio_user_tables;
-- åº”è¯¥>95%
```

### è¡¨è†¨èƒ€

```sql
SELECT tablename, n_dead_tup,
    ROUND(n_dead_tup * 100.0 /
        NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_pct
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY dead_pct DESC;
```

### é”ç­‰å¾…

```sql
SELECT blocked.pid, blocked.query,
    blocking.pid, blocking.query
FROM pg_stat_activity blocked
JOIN pg_locks blocked_lock ON blocked.pid = blocked_lock.pid
JOIN pg_locks blocking_lock ON ...
WHERE NOT blocked_lock.granted;
```

---

## ğŸ”§ å¸¸ç”¨é…ç½®

### å†…å­˜é…ç½®

```ini
shared_buffers = 32GB           # 25%æ€»å†…å­˜
effective_cache_size = 90GB     # 70%æ€»å†…å­˜
work_mem = 256MB                # æ ¹æ®å¹¶å‘è°ƒæ•´
maintenance_work_mem = 2GB
```

### å¹¶è¡ŒæŸ¥è¯¢

```ini
max_parallel_workers = 16
max_parallel_workers_per_gather = 8
parallel_tuple_cost = 0.001
```

### è¿æ¥ç®¡ç†

```ini
max_connections = 500
connection_pool_size = 200
```

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### è¯Šæ–­

```sql
-- æŸ¥çœ‹ç‰ˆæœ¬
SHOW server_version;

-- å½“å‰è¿æ¥
SELECT count(*), state FROM pg_stat_activity GROUP BY state;

-- æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size(current_database()));

-- è¡¨å¤§å°
SELECT pg_size_pretty(pg_total_relation_size('table_name'));
```

### ç»´æŠ¤

```sql
-- åˆ†æç»Ÿè®¡
ANALYZE table_name;

-- æ¸…ç†æ­»å…ƒç»„
VACUUM table_name;

-- é‡å»ºç´¢å¼•
REINDEX TABLE CONCURRENTLY table_name;
```

---

## ğŸ“ˆ æ€§èƒ½æå‡é€ŸæŸ¥

| æ“ä½œ | PG17 | PG18 | æå‡ |
|------|------|------|------|
| è¿æ¥ | 30ms | 0.8ms | **-97%** |
| æŸ¥è¯¢(Skip Scan) | 8.5s | 1.2s | **-86%** |
| æ’åº(å¢é‡) | 16GBå†…å­˜ | 800MB | **-95%** |
| COPYå¯¼å…¥ | 8MB/s | 50MB/s | **+525%** |
| VACUUM | 65s | 45s | **-31%** |
| å­˜å‚¨(å‹ç¼©) | 10TB | 1.2TB | **-88%** |

---

## ğŸš¨ æ•…éšœé€ŸæŸ¥

### æ…¢æŸ¥è¯¢

1. `EXPLAIN ANALYZE` æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
2. æ£€æŸ¥æ˜¯å¦ç¼ºç´¢å¼•
3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ `ANALYZE`

### è¿æ¥è€—å°½

1. å¯ç”¨å†…ç½®è¿æ¥æ± 
2. åº”ç”¨å±‚ä½¿ç”¨è¿æ¥æ± 
3. å¢åŠ  `max_connections`

### å†…å­˜æº¢å‡º

1. é™ä½ `work_mem`
2. æŸ¥è¯¢åŠ  `LIMIT`
3. æ£€æŸ¥æ­»å…ƒç»„ `VACUUM`

### é”ç­‰å¾…

1. æŸ¥æ‰¾é˜»å¡ä¼šè¯
2. `pg_terminate_backend(pid)`
3. è®¾ç½® `statement_timeout`

---

**æ‰“å°æ­¤é¡µä½œä¸ºé€ŸæŸ¥æ‰‹å†Œ** ğŸ“‹
