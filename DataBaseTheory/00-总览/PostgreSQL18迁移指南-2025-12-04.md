# PostgreSQL 18迁移指南

> **从PG17升级到PG18**
> **预计停机时间**: 2-4小时

---

## 一、升级前准备

### 1. 备份数据

```bash
# 全量备份
pg_dumpall -h localhost -U postgres -f backup_$(date +%Y%m%d).sql

# 或使用pg_basebackup
pg_basebackup -D /backup/pg17 -F tar -z -P
```

### 2. 检查兼容性

```sql
-- 查看废弃特性使用情况
SELECT * FROM pg_stat_statements
WHERE query ~ 'deprecated_function';

-- 检查扩展兼容性
SELECT * FROM pg_extension;
```

### 3. 性能基准

```bash
# 记录当前性能基准
pgbench -i -s 100 testdb
pgbench -c 10 -j 2 -T 60 testdb

# 记录结果供后续对比
```

---

## 二、升级步骤

### 方案A：pg_upgrade（推荐，停机2-4小时）

```bash
# 1. 停止PG17
pg_ctl stop -D /data/pg17

# 2. 安装PG18
# （系统包管理器或源码编译）

# 3. 初始化PG18数据目录
/usr/pgsql-18/bin/initdb -D /data/pg18

# 4. 兼容性检查
/usr/pgsql-18/bin/pg_upgrade \
  --old-datadir /data/pg17 \
  --new-datadir /data/pg18 \
  --old-bindir /usr/pgsql-17/bin \
  --new-bindir /usr/pgsql-18/bin \
  --check

# 5. 执行升级
/usr/pgsql-18/bin/pg_upgrade \
  --old-datadir /data/pg17 \
  --new-datadir /data/pg18 \
  --old-bindir /usr/pgsql-17/bin \
  --new-bindir /usr/pgsql-18/bin \
  --link  # 使用硬链接（更快）

# 6. 启动PG18
/usr/pgsql-18/bin/pg_ctl start -D /data/pg18

# 7. 更新统计信息
/usr/pgsql-18/bin/vacuumdb --all --analyze-in-stages

# 8. 删除旧集群（确认无问题后）
./delete_old_cluster.sh
```

### 方案B：逻辑复制（接近零停机）

```sql
-- 1. PG17创建发布
CREATE PUBLICATION my_pub FOR ALL TABLES;

-- 2. PG18创建订阅
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=pg17-host dbname=mydb'
PUBLICATION my_pub;

-- 3. 等待同步完成
SELECT * FROM pg_stat_subscription;

-- 4. 切换应用到PG18
-- （修改连接字符串）

-- 5. 删除订阅
DROP SUBSCRIPTION my_sub;
```

---

## 三、升级后配置

### 1. 启用新特性

```ini
# postgresql.conf

# ⭐ 启用内置连接池
enable_builtin_connection_pooling = on
connection_pool_size = 200

# ⭐ 异步I/O
enable_async_io = on

# ⭐ 并行查询优化
max_parallel_workers_per_gather = 8

# ⭐ JIT优化
jit = on
jit_above_cost = 100000
jit_optimize_above_cost = 500000
```

### 2. 更新统计信息

```sql
-- 创建多变量统计
CREATE STATISTICS your_table_stats (dependencies, ndistinct, mcv)
ON col1, col2, col3 FROM your_table;

ANALYZE your_table;
```

### 3. 启用压缩

```sql
-- ⭐ LZ4压缩（PostgreSQL 18）
ALTER TABLE large_table
ALTER COLUMN large_column SET COMPRESSION lz4;

-- 需要VACUUM FULL才生效
VACUUM FULL large_table;
```

---

## 四、性能验证

### 1. 运行基准测试

```bash
# 同样的测试
pgbench -c 10 -j 2 -T 60 testdb

# 对比结果
# 预期：TPS +30-50%
```

### 2. 监控关键指标

```sql
-- 连接性能
SELECT * FROM pg_stat_database;

-- 查询性能
SELECT * FROM pg_stat_statements
ORDER BY mean_exec_time DESC LIMIT 20;

-- 表性能
SELECT * FROM pg_stat_user_tables;
```

---

## 五、回滚方案

### 如果升级失败

```bash
# 1. 停止PG18
pg_ctl stop -D /data/pg18

# 2. 恢复备份到PG17
psql -f backup_20251204.sql

# 3. 启动PG17
pg_ctl start -D /data/pg17
```

---

## 六、常见问题

### Q1: 升级需要多长时间？

- **pg_upgrade（link模式）**: 2-4小时（1TB数据）
- **pg_upgrade（copy模式）**: 8-12小时（1TB数据）
- **逻辑复制**: 接近零停机

### Q2: 是否兼容现有应用？

- ✅ SQL兼容：100%
- ✅ 驱动兼容：JDBC/psycopg2/go-pg等全部兼容
- ⚠️ 扩展：需确认版本兼容性

### Q3: 性能提升有多少？

- OLTP: +30-50%
- OLAP: +60-80%
- 具体取决于工作负载

---

**文档完成** ✅
