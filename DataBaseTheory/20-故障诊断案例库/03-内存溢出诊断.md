# 内存溢出诊断案例

> **PostgreSQL 18**

---

## 案例1：work_mem溢出

### 症状

```text
系统日志：
temporary file: path "base/pgsql_tmp/pgsql_tmp12345.0", size 8589934592
查询：ORDER BY操作慢
```

### 诊断

```sql
-- 查看临时文件使用
SELECT
    datname,
    temp_files,
    temp_bytes,
    pg_size_pretty(temp_bytes) as temp_size
FROM pg_stat_database
WHERE datname = current_database();

/*
temp_files: 150
temp_bytes: 85899345920 (80GB!)
*/

-- 查看当前work_mem
SHOW work_mem;  -- 4MB（太小）
```

### 解决

```sql
-- 方案1：增加work_mem（会话级）
SET work_mem = '256MB';

-- 方案2：优化查询
-- 原查询
SELECT * FROM orders
WHERE order_date > '2025-01-01'
ORDER BY amount DESC;

-- 优化：先过滤再排序
SELECT * FROM orders
WHERE order_date > '2025-01-01'
  AND amount > 1000  -- 增加过滤
ORDER BY amount DESC
LIMIT 1000;  -- 限制结果

-- 方案3：创建索引
CREATE INDEX idx_orders_amount ON orders(amount DESC)
WHERE order_date > '2025-01-01';
```

---

## 案例2：OOM Killer

### 症状

```text
系统日志：
Out of memory: Kill process 12345 (postgres) score 850
数据库进程被杀
连接断开
```

### 诊断

```sql
-- ⭐ PostgreSQL 18：增强的内存诊断
SELECT
    name,
    type,  -- 新增
    path,  -- 新增
    pg_size_pretty(total_bytes) as total,
    pg_size_pretty(used_bytes) as used,
    pg_size_pretty(free_bytes) as free
FROM pg_backend_memory_contexts
WHERE used_bytes > 100 * 1024 * 1024  -- >100MB
ORDER BY used_bytes DESC;

/*
name: ExecutorState
type: AllocSet
used: 15GB (异常大！)
*/

-- 查看查询
SELECT pid, query, state, backend_type
FROM pg_stat_activity
WHERE pid = 12345;
```

### 解决

```sql
-- 1. 找到问题查询
SELECT
    pid,
    usename,
    query,
    state,
    pg_size_pretty(
        (SELECT sum(used_bytes)
         FROM pg_backend_memory_contexts
         WHERE pid = pg_stat_activity.pid)
    ) as mem_used
FROM pg_stat_activity
ORDER BY mem_used DESC;

-- 2. 杀死问题查询
SELECT pg_cancel_backend(problematic_pid);

-- 3. 优化查询
-- 避免：SELECT * FROM huge_table
-- 使用：SELECT id, name FROM huge_table LIMIT 1000

-- 4. 配置限制
ALTER ROLE app_user SET work_mem = '128MB';
```

---

## 案例3：shared_buffers不足

### 症状

```text
缓存命中率低：70%（应该>95%）
I/O高
查询慢
```

### 诊断

```sql
-- 检查缓存命中率
SELECT
    sum(heap_blks_hit) * 100.0 /
    NULLIF(sum(heap_blks_hit + heap_blks_read), 0) as cache_hit_ratio
FROM pg_statio_user_tables;

-- 70%（太低）

-- 检查shared_buffers
SHOW shared_buffers;  -- 128MB（太小）
```

### 解决

```ini
# postgresql.conf
# 设置为物理内存的25%
shared_buffers = 32GB

# 重启PostgreSQL
pg_ctl restart
```

---

**文档完成** ✅
