# 案例5：金融交易系统 - 架构设计

## 元数据

- **创建日期**: 2025-12-04
- **架构模式**: CQRS + Event Sourcing
- **ACID**: SERIALIZABLE隔离级别

---

## 1. 总体架构

```text
┌──────────────────────────────────────────────────────────┐
│              金融交易系统架构                             │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  [交易请求]                                               │
│      │                                                     │
│  [API Gateway]                                            │
│      │                                                     │
│  [交易服务] ──> [PostgreSQL 18]                          │
│      │            (SERIALIZABLE)                          │
│      │                 │                                   │
│      │                 ├─> [账户表]                       │
│      │                 ├─> [交易表]                       │
│      │                 ├─> [审计日志]                     │
│      │                 └─> [事件表]                       │
│      │                                                     │
│  [对账服务] ──> 定时对账                                  │
│      │                                                     │
│  [审计服务] ──> 审计日志分析                              │
│                                                            │
│  [监控告警]                                               │
│  ├─ TPS监控                                               │
│  ├─ 延迟监控                                              │
│  └─ 异常检测                                              │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

---

## 2. ACID保证设计

### 2.1 强一致性策略

**隔离级别**: SERIALIZABLE

```sql
-- 全局配置
ALTER SYSTEM SET default_transaction_isolation = 'serializable';

-- 或单个事务
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
-- 交易操作
COMMIT;
```

**原子性保证**:

- ✅ 转账操作要么全部成功，要么全部失败
- ✅ 使用事务确保原子性
- ✅ 乐观锁处理并发冲突

**持久性保证**:

- ✅ 同步提交WAL
- ✅ 主从同步复制
- ✅ 定期备份

---

## 3. 核心业务流程

### 3.1 转账流程

```text
转账请求
  │
  ├─> 参数验证
  │
  ├─> BEGIN TRANSACTION (SERIALIZABLE)
  │
  ├─> 检查余额
  │
  ├─> 扣款（乐观锁）
  │
  ├─> 入账
  │
  ├─> 记录交易
  │
  ├─> 记录审计日志
  │
  ├─> COMMIT
  │
  └─> 返回成功
```

---

## 4. 高可用设计

```text
主从架构:
  [Primary] ──同步复制──> [Standby 1]
      │
      └──异步复制──> [Standby 2]

故障转移:
  Primary故障 → Standby 1自动提升
  ├─ RPO: 0（同步复制）
  └─ RTO: <30秒（自动故障转移）
```

---

**完成日期**: 2025-12-04
**ACID级别**: 最高
**可用性**: 99.99%

**返回**: [案例5主页](./README.md)
