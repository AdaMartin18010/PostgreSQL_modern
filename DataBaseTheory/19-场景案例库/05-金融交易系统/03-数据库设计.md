# 案例5：金融交易系统 - 数据库设计

## 元数据

- **创建日期**: 2025-12-04
- **隔离级别**: SERIALIZABLE
- **审计**: 完整审计轨迹

---

## 1. 核心表设计

```sql
-- 1. 账户表
CREATE TABLE accounts (
    account_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    account_number VARCHAR(32) UNIQUE NOT NULL,
    balance NUMERIC(20, 2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(3) NOT NULL DEFAULT 'CNY',
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/frozen/closed
    version INT NOT NULL DEFAULT 0,  -- 乐观锁版本号
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_balance_non_negative CHECK (balance >= 0)
);

CREATE INDEX idx_accounts_user ON accounts (user_id);
CREATE INDEX idx_accounts_number ON accounts (account_number);

-- 2. 交易表
CREATE TABLE transactions (
    transaction_id BIGSERIAL PRIMARY KEY,
    from_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    to_account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    amount NUMERIC(20, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,  -- transfer/deposit/withdraw
    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending/success/failed
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    CONSTRAINT chk_amount_positive CHECK (amount > 0),
    CONSTRAINT chk_different_accounts CHECK (from_account_id != to_account_id)
);

CREATE INDEX idx_transactions_from ON transactions (from_account_id, created_at);
CREATE INDEX idx_transactions_to ON transactions (to_account_id, created_at);
CREATE INDEX idx_transactions_status ON transactions (status);

-- 3. 审计日志表
CREATE TABLE audit_logs (
    log_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT REFERENCES transactions(transaction_id),
    account_id BIGINT REFERENCES accounts(account_id),
    action VARCHAR(50) NOT NULL,
    old_value JSONB,
    new_value JSONB,
    user_id BIGINT,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_transaction ON audit_logs (transaction_id);
CREATE INDEX idx_audit_account ON audit_logs (account_id);
CREATE INDEX idx_audit_created ON audit_logs (created_at);

-- 4. 事件表（Event Sourcing）
CREATE TABLE account_events (
    event_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES accounts(account_id),
    event_type VARCHAR(50) NOT NULL,
    event_data JSONB NOT NULL,
    sequence_number BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (account_id, sequence_number)
);

CREATE INDEX idx_events_account ON account_events (account_id, sequence_number);
```

---

## 2. 核心业务函数

```sql
-- 转账函数（带乐观锁）
CREATE OR REPLACE FUNCTION transfer_money(
    p_from_account BIGINT,
    p_to_account BIGINT,
    p_amount NUMERIC,
    p_user_id BIGINT
) RETURNS BIGINT AS $$
DECLARE
    v_from_version INT;
    v_to_version INT;
    v_transaction_id BIGINT;
BEGIN
    -- 1. 锁定并检查源账户
    SELECT version, balance INTO v_from_version
    FROM accounts
    WHERE account_id = p_from_account
    FOR UPDATE;

    IF NOT FOUND THEN
        RAISE EXCEPTION '源账户不存在';
    END IF;

    IF (SELECT balance FROM accounts WHERE account_id = p_from_account) < p_amount THEN
        RAISE EXCEPTION '余额不足';
    END IF;

    -- 2. 锁定目标账户
    SELECT version INTO v_to_version
    FROM accounts
    WHERE account_id = p_to_account
    FOR UPDATE;

    IF NOT FOUND THEN
        RAISE EXCEPTION '目标账户不存在';
    END IF;

    -- 3. 创建交易记录
    INSERT INTO transactions (from_account_id, to_account_id, amount, currency, transaction_type)
    VALUES (p_from_account, p_to_account, p_amount, 'CNY', 'transfer')
    RETURNING transaction_id INTO v_transaction_id;

    -- 4. 扣款（乐观锁）
    UPDATE accounts
    SET balance = balance - p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_from_account
      AND version = v_from_version;

    IF NOT FOUND THEN
        RAISE EXCEPTION '源账户版本冲突，请重试';
    END IF;

    -- 5. 入账
    UPDATE accounts
    SET balance = balance + p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_to_account
      AND version = v_to_version;

    IF NOT FOUND THEN
        RAISE EXCEPTION '目标账户版本冲突，请重试';
    END IF;

    -- 6. 更新交易状态
    UPDATE transactions
    SET status = 'success',
        completed_at = CURRENT_TIMESTAMP
    WHERE transaction_id = v_transaction_id;

    -- 7. 记录审计日志
    INSERT INTO audit_logs (transaction_id, account_id, action, user_id)
    VALUES (v_transaction_id, p_from_account, 'debit', p_user_id),
           (v_transaction_id, p_to_account, 'credit', p_user_id);

    RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

---

**完成日期**: 2025-12-04
**事务模型**: ACID + 乐观锁
**审计**: 完整审计日志

**返回**: [案例5主页](./README.md)
