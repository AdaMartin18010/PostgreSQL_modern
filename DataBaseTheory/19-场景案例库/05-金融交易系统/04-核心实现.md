# 案例5：金融交易系统 - 核心实现

## 元数据

- **创建日期**: 2025-12-04
**技术栈**: PostgreSQL 18 + Python 3.11+
- **TPS目标**: 10,000+

---

## 1. 交易处理模块

```python
"""
金融交易核心模块
特点: ACID保证、乐观锁、完整审计
"""

import psycopg2
from decimal import Decimal
import logging

class TransactionProcessor:
    """交易处理器"""

    def __init__(self, conn_str):
        self.conn = psycopg2.connect(conn_str)
        self.cursor = self.conn.cursor()
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)

    def transfer(self, from_account, to_account, amount, user_id, max_retries=3):
        """
        转账（带重试）

        Args:
            from_account: 源账户ID
            to_account: 目标账户ID
            amount: 金额
            user_id: 操作用户ID
            max_retries: 最大重试次数
        """

        for attempt in range(max_retries):
            try:
                # 调用数据库函数
                self.cursor.execute("""
                    SELECT transfer_money(%s, %s, %s, %s);
                """, (from_account, to_account, amount, user_id))

                transaction_id = self.cursor.fetchone()[0]
                self.conn.commit()

                self.logger.info(f"✅ 转账成功: {transaction_id}")
                return transaction_id

            except psycopg2.Error as e:
                self.conn.rollback()

                # 版本冲突，重试
                if '版本冲突' in str(e):
                    self.logger.warning(f"版本冲突，重试 {attempt + 1}/{max_retries}")
                    continue
                else:
                    # 其他错误，直接抛出
                    self.logger.error(f"❌ 转账失败: {e}")
                    raise

        # 重试耗尽
        raise Exception("转账失败: 达到最大重试次数")

    def get_account_balance(self, account_id):
        """查询账户余额"""

        self.cursor.execute("""
            SELECT balance, currency
            FROM accounts
            WHERE account_id = %s;
        """, (account_id,))

        result = self.cursor.fetchone()
        if not result:
            raise ValueError("账户不存在")

        return {'balance': float(result[0]), 'currency': result[1]}

    def get_transaction_history(self, account_id, limit=100):
        """查询交易历史"""

        self.cursor.execute("""
            SELECT
                transaction_id,
                CASE
                    WHEN from_account_id = %s THEN 'debit'
                    ELSE 'credit'
                END AS type,
                amount,
                CASE
                    WHEN from_account_id = %s THEN to_account_id
                    ELSE from_account_id
                END AS other_account,
                status,
                created_at
            FROM transactions
            WHERE from_account_id = %s OR to_account_id = %s
            ORDER BY created_at DESC
            LIMIT %s;
        """, (account_id, account_id, account_id, account_id, limit))

        return self.cursor.fetchall()
```

---

## 2. 对账模块

```python
class ReconciliationService:
    """对账服务"""

    def __init__(self, conn):
        self.conn = conn
        self.cursor = conn.cursor()

    def daily_reconciliation(self, date):
        """日终对账"""

        # 1. 检查账户余额一致性
        inconsistencies = self._check_balance_consistency(date)

        if inconsistencies:
            self.logger.error(f"发现{len(inconsistencies)}个账户余额不一致")
            return False

        # 2. 检查交易完整性
        incomplete_txs = self._check_transaction_completeness(date)

        if incomplete_txs:
            self.logger.error(f"发现{len(incomplete_txs)}个未完成交易")
            return False

        # 3. 生成对账报告
        report = self._generate_report(date)

        self.logger.info(f"✅ {date}对账完成")
        return True

    def _check_balance_consistency(self, date):
        """检查余额一致性"""

        self.cursor.execute("""
            WITH calculated_balance AS (
                SELECT
                    account_id,
                    COALESCE(SUM(
                        CASE
                            WHEN to_account_id = account_id THEN amount
                            WHEN from_account_id = account_id THEN -amount
                            ELSE 0
                        END
                    ), 0) AS calc_balance
                FROM accounts a
                LEFT JOIN transactions t ON (
                    (t.from_account_id = a.account_id OR t.to_account_id = a.account_id)
                    AND t.status = 'success'
                    AND DATE(t.completed_at) <= %s
                )
                GROUP BY account_id
            )
            SELECT
                a.account_id,
                a.balance AS actual_balance,
                cb.calc_balance AS calculated_balance,
                a.balance - cb.calc_balance AS diff
            FROM accounts a
            JOIN calculated_balance cb ON a.account_id = cb.account_id
            WHERE ABS(a.balance - cb.calc_balance) > 0.01;  -- 容差0.01元
        """, (date,))

        return self.cursor.fetchall()
```

---

**完成日期**: 2025-12-04
**表结构**: 账户 + 交易 + 审计 + 事件
**完整性**: 乐观锁 + 约束

**返回**: [案例5主页](./README.md)
