# 案例4：多租户SaaS系统 - 架构设计

## 元数据

- **创建日期**: 2025-12-04
- **架构模式**: 共享数据库 + RLS隔离
- **租户数**: 1000+

---

## 1. 总体架构

```text
┌──────────────────────────────────────────────────────────┐
│              多租户SaaS系统架构                           │
├──────────────────────────────────────────────────────────┤
│                                                          │
│    [租户A] [租户B] [租户C] ... [租户N]                    │
│     │        │        │            │                     │
│     └────────┴────────┴────────────┘                     │
│                 │                                        │
│           [API Gateway]                                  │
│                 │                                        │
│          [租户识别中间件]                                 │
│                 │                                        │
│           [Application]                                  │
│                 │                                        │
│         [Connection Pool]                                │
│                 │                                        │
│         [PostgreSQL 18]                                  │
│          Row Level Security (RLS)                        │
│                 │                                        │
│     ┌───────────┼───────────┐                            │
│     │           │           │                            │
│  [租户A数据] [租户B数据] [租户C数据]                       │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 2. 隔离策略

### 2.1 数据隔离（RLS）

**优点**:

- ✅ 共享Schema，降低维护成本
- ✅ 数据库层面强制隔离
- ✅ 应用代码简单

**实现方式**:

```sql
-- 1. 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 2. 创建策略
CREATE POLICY tenant_isolation_policy ON users
    USING (tenant_id = current_setting('app.current_tenant')::integer);

-- 3. 应用设置租户ID
SET app.current_tenant = '123';
SELECT * FROM users;  -- 只返回租户123的数据
```

---

### 2.2 资源隔离

**配额管理**:

| 资源 | 配额策略 | 实现方式 |
|------|---------|----------|
| **存储** | 每租户10GB | 触发器检查 |
| **连接数** | 每租户10个 | pgBouncer pool_mode |
| **查询时间** | 最大30秒 | statement_timeout |
| **并发查询** | 每租户5个 | 应用层限流 |

---

## 3. 技术选型

### 3.1 核心技术栈

| 组件 | 技术选择 | 理由 |
|------|---------|------|
| **数据库** | PostgreSQL 18 | RLS性能优化 |
| **连接池** | pgBouncer | 租户级连接池 |
| **缓存** | Redis | 租户配置缓存 |
| **API** | FastAPI | 高性能异步 |
| **认证** | JWT | 无状态认证 |
| **监控** | Prometheus | 租户级监控 |

---

## 4. 关键设计决策

### 4.1 共享 vs 独立数据库

**选择**: 共享数据库 + RLS隔离

**对比**:

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **共享数据库** | 成本低、维护简单 | 隔离性较弱 | 1000+小租户 |
| **独立数据库** | 隔离性强、定制化 | 成本高、维护复杂 | <100大租户 |
| **混合模式** | 灵活 | 复杂度高 | 差异化需求 |

**我们的选择理由**:

- ✅ 1000+小租户，共享更经济
- ✅ RLS提供足够的数据隔离
- ✅ 维护成本可控

---

### 4.2 RLS性能优化

**PostgreSQL 18优化**:

```sql
-- 1. 创建租户ID索引
CREATE INDEX idx_users_tenant ON users (tenant_id);

-- 2. 使用分区表（如果租户数巨大）
CREATE TABLE users (
    id BIGSERIAL,
    tenant_id INT NOT NULL,
    ...
) PARTITION BY HASH (tenant_id);

-- 创建16个分区
CREATE TABLE users_p0 PARTITION OF users
    FOR VALUES WITH (MODULUS 16, REMAINDER 0);
-- ... 其他15个分区
```

---

## 5. 数据流设计

```text
写入流程:
  用户请求 → API Gateway → 租户识别
      → SET app.current_tenant → INSERT/UPDATE
      → RLS自动过滤 → 写入数据库

查询流程:
  用户请求 → API Gateway → 租户识别
      → SET app.current_tenant → SELECT
      → RLS自动过滤 → 返回租户数据

租户创建流程:
  管理员请求 → 创建租户记录 → 初始化租户数据
      → 设置配额 → 返回租户凭证
```

---

**完成日期**: 2025-12-04
**架构模式**: 共享数据库 + RLS
**租户数**: 1000+

**返回**: [案例4主页](./README.md)
