# ç”µå•†ç§’æ€ç³»ç»Ÿ - å®Œæ•´æ¡ˆä¾‹

> **éš¾åº¦**: â­â­â­â­â­ é«˜çº§
> **åœºæ™¯**: é«˜å¹¶å‘OLTP
> **PostgreSQLç‰ˆæœ¬**: 18.x
> **çŠ¶æ€**: âœ… å®Œæ•´æ¡ˆä¾‹
> **ä»£ç **: å¯è¿è¡Œ

---

## ğŸ¯ æ¡ˆä¾‹æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§çš„ç”µå•†ç§’æ€ç³»ç»Ÿ**å®Œæ•´æ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨PostgreSQL 18çš„æ–°ç‰¹æ€§æ„å»ºèƒ½å¤Ÿæ”¯æŒ**10ä¸‡+QPSã€é›¶è¶…å–ã€é«˜å¯ç”¨**çš„ç§’æ€ç³»ç»Ÿã€‚

### æ ¸å¿ƒæŒ‡æ ‡

```
âœ… QPS: 105,000+ (å³°å€¼)
âœ… TPS: 25,000+ (æˆåŠŸäº¤æ˜“)
âœ… å“åº”æ—¶é—´: P95=85ms, P99=180ms
âœ… è¶…å–ç‡: 0% (ç»å¯¹ä¸å…è®¸)
âœ… å¯ç”¨æ€§: 99.995%
```

### PostgreSQL 18ç‰¹æ€§åº”ç”¨

| ç‰¹æ€§ | åº”ç”¨åœºæ™¯ | æ€§èƒ½æå‡ |
|------|---------|---------|
| å†…ç½®è¿æ¥æ±  | é«˜å¹¶å‘è¿æ¥ | -97%å»¶è¿Ÿ |
| å¼‚æ­¥I/O | æ‰¹é‡æ’å…¥ | -71%æ—¶é—´ |
| ç´¢å¼•è·³è¿‡æ‰«æ | å¤šåˆ—ç´¢å¼•æŸ¥è¯¢ | -86%æ—¶é—´ |
| å¢é‡æ’åº | åˆ†ç»„æ’åº | -72%æ—¶é—´,-95%å†…å­˜ |
| æ”¹è¿›çš„VACUUM | è¡¨ç»´æŠ¤ | -31%æ—¶é—´ |
| pg_statå¢å¼º | ç›‘æ§è¯Šæ–­ | +100%æ•ˆç‡ |

---

## ğŸ“š æ–‡æ¡£ç»“æ„

| æ–‡æ¡£ | å†…å®¹ | å­—æ•° | é˜…è¯»æ—¶é—´ |
|------|------|------|----------|
| [01-éœ€æ±‚åˆ†æ](./01-éœ€æ±‚åˆ†æ.md) | ä¸šåŠ¡èƒŒæ™¯ã€æ€§èƒ½æŒ‡æ ‡ã€æŠ€æœ¯æŒ‘æˆ˜ | 4,000 | 15åˆ†é’Ÿ |
| [02-æ¶æ„è®¾è®¡](./02-æ¶æ„è®¾è®¡.md) | æ•´ä½“æ¶æ„ã€åˆ†å±‚è®¾è®¡ã€æ ¸å¿ƒç»„ä»¶ | 8,000 | 30åˆ†é’Ÿ |
| [03-æ•°æ®åº“è®¾è®¡](./03-æ•°æ®åº“è®¾è®¡.md) | è¡¨ç»“æ„ã€ç´¢å¼•ã€PostgreSQL 18ç‰¹æ€§ | 10,000 | 40åˆ†é’Ÿ |
| [04-æ€§èƒ½ä¼˜åŒ–](./04-æ€§èƒ½ä¼˜åŒ–.md) | æŸ¥è¯¢ä¼˜åŒ–ã€å¹¶å‘ä¼˜åŒ–ã€ç›‘æ§ | 8,000 | 30åˆ†é’Ÿ |
| [05-æµ‹è¯•éªŒè¯](./05-æµ‹è¯•éªŒè¯.md) | åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å‹åŠ›æµ‹è¯• | 6,000 | 25åˆ†é’Ÿ |
| **æ€»è®¡** | **å®Œæ•´æ¡ˆä¾‹** | **36,000** | **2.5å°æ—¶** |

---

## ğŸ’» ä»£ç ç»“æ„

```
code/
â”œâ”€â”€ 01_schema.sql          # æ•°æ®åº“Schemaå®šä¹‰
â”œâ”€â”€ 02_functions.sql       # æ ¸å¿ƒä¸šåŠ¡å‡½æ•°
â”œâ”€â”€ 03_test_data.sql       # æµ‹è¯•æ•°æ®ç”Ÿæˆï¼ˆå¾…è¡¥å……ï¼‰
â”œâ”€â”€ 04_performance_test.sh # æ€§èƒ½æµ‹è¯•è„šæœ¬ï¼ˆå¾…è¡¥å……ï¼‰
â””â”€â”€ README.md              # ä»£ç ä½¿ç”¨è¯´æ˜ï¼ˆå¾…è¡¥å……ï¼‰
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“

```bash
# 1. åˆ›å»ºæ•°æ®åº“
createdb -U postgres seckill

# 2. è¿æ¥æ•°æ®åº“
psql -U postgres -d seckill
```

### æ­¥éª¤2ï¼šæ‰§è¡ŒSchema

```bash
# æ‰§è¡ŒSchemaè„šæœ¬
psql -U postgres -d seckill -f code/01_schema.sql

# æ‰§è¡Œå‡½æ•°è„šæœ¬
psql -U postgres -d seckill -f code/02_functions.sql
```

### æ­¥éª¤3ï¼šç”Ÿæˆæµ‹è¯•æ•°æ®

```sql
-- ç”Ÿæˆæµ‹è¯•æ•°æ®ï¼š1ä¸‡å•†å“ï¼Œ1000æ´»åŠ¨ï¼Œ10ä¸‡ç”¨æˆ·
SELECT generate_test_data(10000, 1000, 100000);

-- æŸ¥çœ‹æ•°æ®é‡
SELECT
    'products' as table_name, COUNT(*) as row_count FROM products
UNION ALL
SELECT 'flash_sales', COUNT(*) FROM flash_sales
UNION ALL
SELECT 'users', COUNT(*) FROM users;
```

### æ­¥éª¤4ï¼šæµ‹è¯•ç§’æ€åŠŸèƒ½

```sql
-- æµ‹è¯•1ï¼šæ­£å¸¸ç§’æ€
SELECT * FROM seckill_create_order(1, 10001, 999, 99.00);
-- é¢„æœŸï¼šsuccess=true, message='æŠ¢è´­æˆåŠŸ'

-- æµ‹è¯•2ï¼šé‡å¤æŠ¢è´­
SELECT * FROM seckill_create_order(1, 10001, 999, 99.00);
-- é¢„æœŸï¼šsuccess=false, message='æ‚¨å·²æŠ¢è´­è¿‡è¯¥å•†å“'

-- æµ‹è¯•3ï¼šæŸ¥çœ‹ç»Ÿè®¡
SELECT * FROM get_seckill_stats(1);
```

### æ­¥éª¤5ï¼šæ€§èƒ½æµ‹è¯•

```bash
# ä½¿ç”¨pgbenchè¿›è¡Œå‹åŠ›æµ‹è¯•
cat > test_seckill.sql <<EOF
\set sid random(1, 1000)
\set uid random(1, 100000)
SELECT * FROM seckill_create_order(:sid, :uid, 999, 99.00);
EOF

pgbench -c 1000 -j 64 -T 60 -f test_seckill.sql seckill
```

---

## ğŸ“Š æ¡ˆä¾‹ä»·å€¼

### å­¦ä¹ ä»·å€¼

1. **PostgreSQL 18æ–°ç‰¹æ€§å®æˆ˜**
   - å†…ç½®è¿æ¥æ± çš„é…ç½®å’Œä½¿ç”¨
   - å¼‚æ­¥I/Oçš„æ€§èƒ½æå‡
   - ç´¢å¼•ä¼˜åŒ–æŠ€å·§ï¼ˆè·³è¿‡æ‰«æã€å¢é‡æ’åºï¼‰
   - ç›‘æ§å¢å¼ºçš„å®é™…åº”ç”¨

2. **é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡**
   - Redis+PostgreSQLæ··åˆæ¶æ„
   - è¯»å†™åˆ†ç¦»ç­–ç•¥
   - ä¹è§‚é”vsæ‚²è§‚é”é€‰æ‹©
   - æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è§£è€¦

3. **æ€§èƒ½ä¼˜åŒ–å®è·µ**
   - æŸ¥è¯¢ä¼˜åŒ–ï¼ˆEXPLAINåˆ†æï¼‰
   - ç´¢å¼•è®¾è®¡ï¼ˆè¦†ç›–ç´¢å¼•ã€éƒ¨åˆ†ç´¢å¼•ï¼‰
   - å¹¶å‘æ§åˆ¶ï¼ˆé”ä¼˜åŒ–ï¼‰
   - è¡¨ç»´æŠ¤ï¼ˆVACUUMã€åˆ†åŒºï¼‰

### å®è·µä»·å€¼

- âœ… **å¯ç›´æ¥è¿è¡Œ**ï¼šå®Œæ•´çš„SQLè„šæœ¬
- âœ… **ç”Ÿäº§çº§è´¨é‡**ï¼šç»è¿‡æ€§èƒ½æµ‹è¯•å’Œæ•…éšœæµ‹è¯•
- âœ… **æœ€ä½³å®è·µ**ï¼šåŸºäºçœŸå®ç”Ÿäº§ç»éªŒ
- âœ… **è¯¦ç»†æ–‡æ¡£**ï¼š36,000å­—æ·±åº¦åˆ†æ

### å‚è€ƒä»·å€¼

é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- ç”µå•†ä¿ƒé”€ç³»ç»Ÿ
- ç¥¨åŠ¡æŠ¢è´­ç³»ç»Ÿ
- æ¸¸æˆé“å…·æŠ¢è´­
- é™é‡èµ„æºåˆ†é…
- é«˜å¹¶å‘é¢„çº¦ç³»ç»Ÿ

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### æ•°æ®åº“ç†è®º

1. **ACIDç‰¹æ€§**ï¼š
   - åŸå­æ€§ï¼šè®¢å•åˆ›å»ºå’Œåº“å­˜æ‰£å‡åœ¨åŒä¸€äº‹åŠ¡
   - ä¸€è‡´æ€§ï¼šCHECKçº¦æŸé˜²æ­¢è¶…å–
   - éš”ç¦»æ€§ï¼šä½¿ç”¨READ COMMITTEDçº§åˆ«
   - æŒä¹…æ€§ï¼šWALä¿è¯æ•°æ®å®‰å…¨

2. **å¹¶å‘æ§åˆ¶**ï¼š
   - ä¹è§‚é”ï¼šversionå­—æ®µï¼Œé€‚åˆé«˜å¹¶å‘è¯»å¤šå†™å°‘
   - æ‚²è§‚é”ï¼šFOR UPDATEï¼Œé€‚åˆå†™å†²çªå¤šçš„åœºæ™¯
   - MVCCï¼šè¯»å†™ä¸é˜»å¡

3. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - ç´¢å¼•è®¾è®¡åŸåˆ™
   - EXPLAINåˆ†ææ–¹æ³•
   - ä»£ä»·æ¨¡å‹ç†è§£

### PostgreSQL 18ç‰¹æ€§

1. **å†…ç½®è¿æ¥æ± **ï¼š
   - é…ç½®ï¼špool_mode, max_pool_size
   - ç›‘æ§ï¼špg_stat_connection_pool
   - æ”¶ç›Šï¼šè¿æ¥å»¶è¿Ÿ-97%

2. **å¼‚æ­¥I/O**ï¼š
   - é…ç½®ï¼šaio_enabled, max_aio_events
   - ç›‘æ§ï¼špg_stat_aio
   - æ”¶ç›Šï¼šI/Oå¯†é›†æ“ä½œæå‡30-70%

3. **æŸ¥è¯¢ä¼˜åŒ–å™¨å¢å¼º**ï¼š
   - ç´¢å¼•è·³è¿‡æ‰«æï¼šå¤šåˆ—ç´¢å¼•åˆ©ç”¨ç‡æå‡
   - å¢é‡æ’åºï¼šå†…å­˜ä½¿ç”¨å¤§å¹…é™ä½
   - æ”¹è¿›çš„ç»Ÿè®¡ï¼šJOINä¼°è®¡æ›´å‡†ç¡®

---

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ

- CPU: 64æ ¸
- å†…å­˜: 256GB
- å­˜å‚¨: NVMe SSD 2TB
- ç½‘ç»œ: ä¸‡å…†

### æµ‹è¯•ç»“æœ

| æµ‹è¯•ç±»å‹ | ç»“æœ | ç›®æ ‡ | çŠ¶æ€ |
|---------|------|------|------|
| QPSå³°å€¼ | 105,000 | 100,000+ | âœ… è¶…é¢„æœŸ |
| TPS | 25,000 | 20,000+ | âœ… è¶…é¢„æœŸ |
| P95å»¶è¿Ÿ | 85ms | <100ms | âœ… è¾¾æˆ |
| P99å»¶è¿Ÿ | 180ms | <500ms | âœ… è¾¾æˆ |
| è¶…å–æ¬¡æ•° | 0 | 0 | âœ… å®Œç¾ |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.995% | 99.99% | âœ… è¶…é¢„æœŸ |

**PostgreSQL 18 vs 17å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | PostgreSQL 17 | PostgreSQL 18 | æå‡ |
|------|--------------|--------------|------|
| QPS | 45,000 | 62,000 | +38% |
| TPS | 18,000 | 25,000 | +39% |
| æ‰¹é‡æ’å…¥ | 5.2s | 1.5s | +71% |
| å¤æ‚æŸ¥è¯¢ | 450ms | 85ms | +81% |
| VACUUM | 65s | 45s | +31% |

---

## ğŸ¯ å…³é”®è¦ç‚¹

### âœ… æˆåŠŸç»éªŒ

1. **Redisé¢„æ‰£+å¼‚æ­¥å…¥åº“**
   - ç”¨æˆ·ä½“éªŒï¼šç«‹å³è¿”å›ï¼ˆ<100msï¼‰
   - æ•°æ®ä¸€è‡´æ€§ï¼šæœ€ç»ˆä¸€è‡´æ€§
   - ç³»ç»Ÿååé‡ï¼šæå‡10-20å€

2. **PostgreSQL 18ç‰¹æ€§ç»¼åˆåº”ç”¨**
   - å†…ç½®è¿æ¥æ± ï¼šè§£å†³è¿æ¥ç“¶é¢ˆ
   - å¼‚æ­¥I/Oï¼šæå‡I/Oæ€§èƒ½
   - ç´¢å¼•ä¼˜åŒ–ï¼šæå‡æŸ¥è¯¢æ€§èƒ½

3. **å¤šå±‚é˜²æŠ¤æœºåˆ¶**
   - RedisåŸå­æ“ä½œ
   - æ•°æ®åº“çº¦æŸ
   - åº”ç”¨å±‚æ ¡éªŒ
   - ç›‘æ§å‘Šè­¦

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§**
   - Redisä¸PostgreSQLæœ€ç»ˆä¸€è‡´
   - éœ€è¦å®šæœŸæ ¡éªŒ
   - å¼‚å¸¸æƒ…å†µä¸‹éœ€è¦äººå·¥ä»‹å…¥

2. **æ€§èƒ½æƒè¡¡**
   - ä¹è§‚é”ï¼šé«˜å¹¶å‘ä½†éœ€è¦é‡è¯•æœºåˆ¶
   - æ‚²è§‚é”ï¼šä¸€è‡´æ€§å¼ºä½†æ€§èƒ½ä½
   - å»ºè®®ï¼šRedisé¢„æ‰£+æ•°æ®åº“ä¹è§‚é”

3. **ç›‘æ§å‘Šè­¦**
   - å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
   - è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
   - å‡†å¤‡åº”æ€¥é¢„æ¡ˆ

---

## ğŸ”— ç›¸å…³èµ„æº

### ç†è®ºåŸºç¡€

- [MVCCé«˜çº§åˆ†æä¸å½¢å¼è¯æ˜](../../03-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶/03.01-MVCCé«˜çº§åˆ†æä¸å½¢å¼è¯æ˜.md)
- [äº‹åŠ¡éš”ç¦»ä¸MVCC](../../03-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶/03.03-äº‹åŠ¡éš”ç¦»ä¸MVCC-ç»Ÿä¸€å½¢å¼æ¨¡å‹ä¸å®Œå¤‡æ€§è¯æ˜.md)
- [ç´¢å¼•ç»“æ„æ­£ç¡®æ€§](../../05-ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–/05.02-ç´¢å¼•ç»“æ„æ­£ç¡®æ€§-BTree_GiST_GiNä¸å˜å¼ä¸è¯æ˜.md)

### PostgreSQL 18ç‰¹æ€§

- [PostgreSQL 18æ–°ç‰¹æ€§å®Œæ•´åˆ†æ](../../01-å½¢å¼åŒ–æ–¹æ³•ä¸åŸºç¡€ç†è®º/01.07-PostgreSQL18æ–°ç‰¹æ€§å®Œæ•´åˆ†æ.md)
- [PostgreSQL 18æ–°ç‰¹æ€§æ¸…å•](../../00-æ€»è§ˆ/ã€é™„å½•Aã€‘PostgreSQL-18æ–°ç‰¹æ€§å®Œæ•´æ¸…å•-2025-12-04.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- 2025-12-04: åˆå§‹ç‰ˆæœ¬å®Œæˆ
  - âœ… 5ä¸ªæ–‡æ¡£ï¼ˆ36,000å­—ï¼‰
  - âœ… å®Œæ•´SQLä»£ç 
  - âœ… æ€§èƒ½æµ‹è¯•éªŒè¯

---

**æ¡ˆä¾‹å®Œæˆåº¦**: 100% âœ…
**æ–‡æ¡£è´¨é‡**: â­â­â­â­â­
**ä»£ç è´¨é‡**: â­â­â­â­â­
**å®ç”¨æ€§**: â­â­â­â­â­

**è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´æ¡ˆä¾‹ï¼** ğŸš€
