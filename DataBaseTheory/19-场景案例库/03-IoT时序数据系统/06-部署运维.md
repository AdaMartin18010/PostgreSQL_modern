# 案例3：IoT时序数据系统 - 部署运维

## 元数据

- **创建日期**: 2025-12-04
- **部署方式**: Docker + TimescaleDB
- **监控**: Prometheus + Grafana

---

## 1. 部署配置

### 1.1 Docker Compose

```yaml
version: '3.8'

services:
  timescaledb:
    image: timescale/timescaledb:latest-pg18
    container_name: iot-timescaledb
    environment:
      POSTGRES_DB: iot_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=2GB"
      - "-c"
      - "work_mem=128MB"
      - "-c"
      - "maintenance_work_mem=512MB"
      - "-c"
      - "max_connections=500"
      - "-c"
      - "effective_cache_size=6GB"

  collector:
    build: ./collector
    container_name: iot-collector
    depends_on:
      - timescaledb
    environment:
      DB_HOST: timescaledb
      DB_NAME: iot_db

  api:
    build: ./api
    container_name: iot-api
    depends_on:
      - timescaledb
    ports:
      - "8001:8001"

volumes:
  timescale-data:
```

---

## 2. PostgreSQL优化配置

### 2.1 IoT时序优化

```ini
# postgresql.conf - IoT时序优化

# 内存配置（写优化）
shared_buffers = 2GB
work_mem = 128MB
maintenance_work_mem = 512MB

# WAL配置（高频写入）
wal_buffers = 16MB
max_wal_size = 4GB
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# 异步I/O (PostgreSQL 18)
io_direct = data
io_combine_limit = 128kB

# 连接
max_connections = 500

# 统计
track_io_timing = on
```

---

## 3. 数据保留策略

### 3.1 自动删除旧数据

```sql
-- TimescaleDB数据保留策略
SELECT add_retention_policy('iot_data', INTERVAL '365 days');

-- 手动删除（如果不使用TimescaleDB）
DELETE FROM iot_data
WHERE timestamp < NOW() - INTERVAL '365 days';
```

---

## 4. 监控告警

### 4.1 关键监控指标

```text
写入性能:
├─ 写入吞吐量 (points/秒)
├─ 写入延迟
└─ 批次大小

查询性能:
├─ 查询延迟
├─ 缓存命中率
└─ 并发查询数

存储:
├─ 数据库大小
├─ 压缩率
├─ 磁盘使用率
└─ 分区数量

系统:
├─ CPU使用率
├─ 内存使用率
└─ 磁盘I/O
```

---

**完成日期**: 2025-12-04
**部署方式**: Docker Compose + TimescaleDB
**监控**: Prometheus + Grafana

**返回**: [案例3主页](./README.md)
