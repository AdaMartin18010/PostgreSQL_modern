# 案例7：实时推荐系统 - 性能测试

## 测试环境

- PostgreSQL 18
- 16核CPU, 64GB内存
- NVMe SSD
- 数据规模: 1000万用户, 1亿商品, 10亿行为

---

## 测试结果

### 1. 推荐延迟

| 召回路径 | P50 | P95 | P99 |
|---------|-----|-----|-----|
| User CF | 25ms | 55ms | 85ms |
| Item CF | 20ms | 45ms | 75ms |
| Vector召回 | 8ms | 18ms | 30ms |
| 热门推荐 | 5ms | 12ms | 20ms |
| **综合推荐** | **45ms** | **85ms** | **120ms** |

**结论**: ✅ P95 < 100ms目标达成

---

### 2. 向量检索性能（HNSW）

```sql
-- 测试向量相似度查询
SELECT item_id, embedding <-> '[0.1, 0.2, ...]'::vector AS distance
FROM items
ORDER BY embedding <-> '[0.1, 0.2, ...]'::vector
LIMIT 200;
```

| 数据量 | 查询时间 (P95) | 索引大小 |
|--------|----------------|----------|
| 100万 | 8ms | 1.2GB |
| 1000万 | 12ms | 12GB |
| 1亿 | 18ms | 120GB |

**vs 全表扫描**: 快**500倍**

---

### 3. 协同过滤性能

```sql
-- Item-Based CF性能
EXPLAIN ANALYZE
SELECT * FROM recommend_item_cf(123456, 200);
```

| 指标 | 值 |
|------|-----|
| 执行时间 | 22ms |
| 扫描行数 | ~50K |
| 索引命中率 | 98% |
| 并行度 | 4 |

---

### 4. 并发测试

```bash
# wrk压测
wrk -t 8 -c 100 -d 60s http://localhost:8003/api/recommend/123456
```

| 并发数 | QPS | P95延迟 |
|--------|-----|---------|
| 10 | 220 | 50ms |
| 50 | 980 | 75ms |
| 100 | 1850 | 95ms |
| **200** | **2100** | **145ms** |

**结论**: ✅ 支持2000+ QPS

---

### 5. 缓存命中率

| 场景 | 命中率 |
|------|--------|
| 活跃用户 | 85% |
| 普通用户 | 45% |
| 平均 | 62% |

**Redis缓存延迟**: P95 < 5ms

---

## PostgreSQL 18 vs 17对比

| 指标 | PG17 | PG18 | 提升 |
|------|------|------|------|
| HNSW索引构建 | 45分钟 | 12分钟 | **-73%** |
| 向量查询延迟 | 28ms | 18ms | **-36%** |
| Skip Scan优化 | 不支持 | 支持 | **新特性** |
| 并行查询 | 4并发 | 8并发 | **+100%** |

---

**返回**: [案例7主页](./README.md)
