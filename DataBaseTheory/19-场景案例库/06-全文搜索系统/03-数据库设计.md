# 案例6：全文搜索系统 - 数据库设计

## 元数据

- **创建日期**: 2025-12-04
- **索引**: GIN索引
- **分词**: zhparser (中文)

---

## 1. Schema设计

```sql
-- 1. 文档表
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    doc_length INT,  -- 文档长度（分词后）
    search_vector tsvector,  -- 全文搜索向量
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 2. 创建GIN索引
CREATE INDEX idx_documents_search
ON documents
USING GIN (search_vector);

-- 3. 自动更新search_vector触发器
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('zh_parser', COALESCE(NEW.title, '')), 'A') ||
        setweight(to_tsvector('zh_parser', COALESCE(NEW.content, '')), 'B');

    NEW.doc_length := array_length(
        string_to_array(to_tsvector('zh_parser', NEW.content)::text, ' '), 1
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_search_vector
    BEFORE INSERT OR UPDATE ON documents
    FOR EACH ROW EXECUTE FUNCTION update_search_vector();

-- 4. 搜索统计表
CREATE TABLE search_logs (
    log_id BIGSERIAL PRIMARY KEY,
    query_text VARCHAR(500),
    result_count INT,
    duration_ms FLOAT,
    user_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_search_logs_query ON search_logs (query_text);
CREATE INDEX idx_search_logs_created ON search_logs (created_at);
```

---

## 2. 搜索查询函数

```sql
-- 基础搜索函数
CREATE OR REPLACE FUNCTION search_documents(
    p_query TEXT,
    p_limit INT DEFAULT 20,
    p_offset INT DEFAULT 0
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    content_snippet TEXT,
    rank REAL,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_headline('zh_parser', d.content, query, 'MaxWords=50, MinWords=30') AS content_snippet,
        ts_rank_cd(d.search_vector, query) AS rank,
        d.created_at
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
    ORDER BY rank DESC, d.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;

-- 高级搜索（带过滤）
CREATE OR REPLACE FUNCTION search_documents_advanced(
    p_query TEXT,
    p_category VARCHAR DEFAULT NULL,
    p_tags TEXT[] DEFAULT NULL,
    p_limit INT DEFAULT 20
) RETURNS TABLE (
    doc_id BIGINT,
    title VARCHAR,
    rank REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.title,
        ts_rank_cd(d.search_vector, query) AS rank
    FROM documents d,
         to_tsquery('zh_parser', p_query) query
    WHERE d.search_vector @@ query
      AND (p_category IS NULL OR d.category = p_category)
      AND (p_tags IS NULL OR d.tags && p_tags)
    ORDER BY rank DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

**完成日期**: 2025-12-04
**索引类型**: GIN
**分词器**: zhparser

**返回**: [案例6主页](./README.md)
