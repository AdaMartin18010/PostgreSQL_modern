# ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§-ç›´æ–¹å›¾ä¸é‡‡æ ·è¯¯å·®ç•Œ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§-ç›´æ–¹å›¾ä¸é‡‡æ ·è¯¯å·®ç•Œ](#ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§-ç›´æ–¹å›¾ä¸é‡‡æ ·è¯¯å·®ç•Œ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§å·¥ä½œåŸç†æ¦‚è¿°](#10-ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 ä¸€è‡´æ€§ç†è®º](#21-ä¸€è‡´æ€§ç†è®º)
    - [2.2 ç›´æ–¹å›¾è¯¯å·®ç•Œ](#22-ç›´æ–¹å›¾è¯¯å·®ç•Œ)
    - [2.3 é‡‡æ ·è¯¯å·®ç•Œ](#23-é‡‡æ ·è¯¯å·®ç•Œ)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 ä¸€è‡´æ€§å½¢å¼åŒ–](#31-ä¸€è‡´æ€§å½¢å¼åŒ–)
    - [3.2 ç›´æ–¹å›¾è¯¯å·®ç•Œå½¢å¼åŒ–](#32-ç›´æ–¹å›¾è¯¯å·®ç•Œå½¢å¼åŒ–)
    - [3.3 é‡‡æ ·è¯¯å·®ç•Œå½¢å¼åŒ–](#33-é‡‡æ ·è¯¯å·®ç•Œå½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 ç›´æ–¹å›¾ä¸€è‡´æ€§å®šç†](#41-ç›´æ–¹å›¾ä¸€è‡´æ€§å®šç†)
    - [4.2 é‡‡æ ·ä¸€è‡´æ€§å®šç†](#42-é‡‡æ ·ä¸€è‡´æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯å®ç°](#51-postgresql-18ç»Ÿè®¡ä¿¡æ¯å®ç°)
    - [5.2 å®é™…åº”ç”¨åœºæ™¯](#52-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#åœºæ™¯1ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
      - [åœºæ™¯2ï¼šé‡‡æ ·ç»Ÿè®¡ä¸è¯¯å·®åˆ†æ](#åœºæ™¯2é‡‡æ ·ç»Ÿè®¡ä¸è¯¯å·®åˆ†æ)
    - [5.3 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–](#53-postgresql-18ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–)
      - [5.3.1 è°ƒæ•´ç»Ÿè®¡ç›®æ ‡](#531-è°ƒæ•´ç»Ÿè®¡ç›®æ ‡)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 ç»Ÿè®¡ä¼°è®¡ç›¸å…³](#72-ç»Ÿè®¡ä¼°è®¡ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§å·¥ä½œåŸç†æ¦‚è¿°

**ç»Ÿè®¡ä¼°è®¡ä¸€è‡´æ€§**ï¼š

ç»Ÿè®¡ä¼°è®¡çš„ä¸€è‡´æ€§æ˜¯æŒ‡éšç€æ ·æœ¬é‡å¢åŠ ï¼Œä¼°è®¡å€¼æ”¶æ•›åˆ°çœŸå®å€¼ã€‚ç›´æ–¹å›¾å’Œé‡‡æ ·æ˜¯ä¸¤ç§ä¸»è¦çš„ä¼°è®¡æ–¹æ³•ï¼Œå„æœ‰ä¸åŒçš„è¯¯å·®ç•Œã€‚

**ç»Ÿè®¡ä¼°è®¡ä½“ç³»æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((ç»Ÿè®¡ä¼°è®¡))
    ä¼°è®¡æ–¹æ³•
      ç›´æ–¹å›¾
      ç­‰å®½ç›´æ–¹å›¾
      ç­‰é«˜ç›´æ–¹å›¾
      é‡‡æ ·
      ç®€å•éšæœºé‡‡æ ·
      åˆ†å±‚é‡‡æ ·
    ä¸€è‡´æ€§
      æ— åæ€§
      ä¸€è‡´æ€§
      æ¸è¿‘æ­£æ€æ€§
    è¯¯å·®ç•Œ
      ç›´æ–¹å›¾è¯¯å·®ç•Œ
      é‡‡æ ·è¯¯å·®ç•Œ
      ç½®ä¿¡åŒºé—´
    ä¼˜åŒ–ç­–ç•¥
      è‡ªé€‚åº”åˆ†ç®±
      å¢é‡æ›´æ–°
      å¤šåˆ—ç»Ÿè®¡
```

**ç»Ÿè®¡ä¼°è®¡æ–¹æ³•å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®åˆ†å¸ƒ] --> B{æ•°æ®ç‰¹å¾}
    B -->|å‡åŒ€åˆ†å¸ƒ| C[ç­‰å®½ç›´æ–¹å›¾]
    B -->|å€¾æ–œåˆ†å¸ƒ| D[ç­‰é«˜ç›´æ–¹å›¾]
    B -->|å¤æ‚åˆ†å¸ƒ| E[é‡‡æ ·ä¼°è®¡]
    C --> F[è®¡ç®—è¯¯å·®ç•Œ]
    D --> F
    E --> G[è®¡ç®—é‡‡æ ·è¯¯å·®ç•Œ]
    F --> H[ä¸€è‡´æ€§éªŒè¯]
    G --> H

    style A fill:#FFD700
    style H fill:#90EE90
```

**ä¼°è®¡æ–¹æ³•å¯¹æ¯”çŸ©é˜µ**ï¼š

| æ–¹æ³• | ä¸€è‡´æ€§ | è¯¯å·®ç•Œ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|--------|---------|
| **ç­‰å®½ç›´æ–¹å›¾** | æ˜¯ | O(1/B) | ä½ | å‡åŒ€åˆ†å¸ƒ |
| **ç­‰é«˜ç›´æ–¹å›¾** | æ˜¯ | O(1/B) | ä¸­ | å€¾æ–œåˆ†å¸ƒ |
| **ç®€å•é‡‡æ ·** | æ˜¯ | O(1/âˆšn) | ä¸­ | å¤æ‚åˆ†å¸ƒ |
| **åˆ†å±‚é‡‡æ ·** | æ˜¯ | O(1/âˆšn) | é«˜ | åˆ†å±‚æ•°æ® |

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **ä¸€è‡´æ€§ç†è®º**ï¼šç»Ÿè®¡ä¼°è®¡çš„ä¸€è‡´æ€§å’Œæ”¶æ•›æ€§
- **ç›´æ–¹å›¾è¯¯å·®ç•Œ**ï¼šç›´æ–¹å›¾ä¼°è®¡çš„è¯¯å·®ä¸Šç•Œ
- **é‡‡æ ·è¯¯å·®ç•Œ**ï¼šé‡‡æ ·ä¼°è®¡çš„è¯¯å·®ä¸Šç•Œå’Œç½®ä¿¡åŒºé—´
- **å®é™…åº”ç”¨**ï¼šPostgreSQLç»Ÿè®¡ä¼°è®¡çš„å®ç°

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 ä¸€è‡´æ€§ç†è®º

**ä¸€è‡´æ€§å®šä¹‰**ï¼š

```haskell
-- ä¼°è®¡ä¸€è‡´æ€§
consistent :: Estimator -> Bool
consistent est =
    forall dist:
      lim_{nâ†’âˆ} est(n) = true_value(dist)

-- æ— åæ€§
unbiased :: Estimator -> Bool
unbiased est =
    forall dist: E[est(n)] = true_value(dist)
```

**ä¸€è‡´æ€§åˆ¤å®šæµç¨‹**ï¼š

```mermaid
graph TD
    A[ä¼°è®¡å™¨est] --> B[è®¡ç®—æœŸæœ›E[est]]
    B --> C{E[est] = çœŸå€¼?}
    C -->|æ˜¯| D[æ— å]
    C -->|å¦| E[æœ‰å]
    D --> F[è®¡ç®—æ–¹å·®Var[est]]
    E --> F
    F --> G{Var[est] â†’ 0?}
    G -->|æ˜¯| H[ä¸€è‡´]
    G -->|å¦| I[ä¸ä¸€è‡´]

    style A fill:#FFD700
    style H fill:#90EE90
    style I fill:#FF6B6B
```

### 2.2 ç›´æ–¹å›¾è¯¯å·®ç•Œ

**ç›´æ–¹å›¾ä¼°è®¡**ï¼š

```haskell
-- ç­‰å®½ç›´æ–¹å›¾
equalWidthHistogram :: Data -> Int -> Histogram
equalWidthHistogram data bucketCount =
    let width = (max(data) - min(data)) / bucketCount
        buckets = partitionByWidth(data, width)
    in Histogram {buckets = buckets}

-- ç­‰é«˜ç›´æ–¹å›¾
equalHeightHistogram :: Data -> Int -> Histogram
equalHeightHistogram data bucketCount =
    let sorted = sort(data)
        bucketSize = length(data) / bucketCount
        buckets = partitionBySize(sorted, bucketSize)
    in Histogram {buckets = buckets}
```

**è¯¯å·®ç•Œ**ï¼š

```haskell
-- ç›´æ–¹å›¾è¯¯å·®ä¸Šç•Œ
histogramErrorBound :: Histogram -> ErrorBound
histogramErrorBound hist =
    1 / length(hist.buckets)  -- æœ€åæƒ…å†µè¯¯å·®
```

### 2.3 é‡‡æ ·è¯¯å·®ç•Œ

**é‡‡æ ·ä¼°è®¡**ï¼š

```haskell
-- ç®€å•éšæœºé‡‡æ ·
simpleRandomSample :: Data -> Int -> Sample
simpleRandomSample data sampleSize =
    take sampleSize (randomPermutation(data))

-- é‡‡æ ·ä¼°è®¡
sampleEstimate :: Sample -> Estimator
sampleEstimate sample =
    mean(sample)  -- æ ·æœ¬å‡å€¼
```

**è¯¯å·®ç•Œ**ï¼š

```haskell
-- é‡‡æ ·è¯¯å·®ä¸Šç•Œï¼ˆChernoffç•Œï¼‰
sampleErrorBound :: Sample -> Confidence -> ErrorBound
sampleErrorBound sample confidence =
    -- ä½¿ç”¨Chernoffç•Œ
    sqrt(2 * log(1 / (1 - confidence)) / sampleSize)

-- ç½®ä¿¡åŒºé—´
confidenceInterval :: Sample -> Confidence -> Interval
confidenceInterval sample confidence =
    let mean = sampleMean(sample)
        std = sampleStd(sample)
        margin = zScore(confidence) * std / sqrt(sampleSize)
    in (mean - margin, mean + margin)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 ä¸€è‡´æ€§å½¢å¼åŒ–

**ä¸€è‡´æ€§**ï¼š

```haskell
-- ä¼°è®¡ä¸€è‡´æ€§
consistent(est) iff
    forall Îµ > 0: lim_{nâ†’âˆ} P[|est(n) - Î¸| > Îµ] = 0

å…¶ä¸­Î¸æ˜¯çœŸå®å‚æ•°å€¼
```

### 3.2 ç›´æ–¹å›¾è¯¯å·®ç•Œå½¢å¼åŒ–

**ç›´æ–¹å›¾è¯¯å·®ç•Œ**ï¼š

```haskell
-- ç­‰å®½ç›´æ–¹å›¾è¯¯å·®ä¸Šç•Œ
Îµ_bound(hist) â‰¤ 1 / B

å…¶ä¸­Bæ˜¯æ¡¶æ•°
```

### 3.3 é‡‡æ ·è¯¯å·®ç•Œå½¢å¼åŒ–

**é‡‡æ ·è¯¯å·®ç•Œ**ï¼š

```haskell
-- é‡‡æ ·è¯¯å·®ä¸Šç•Œï¼ˆHoeffdingç•Œï¼‰
P[|est(n) - Î¸| > Îµ] â‰¤ 2 * exp(-2 * n * ÎµÂ²)

-- ç½®ä¿¡åŒºé—´
P[Î¸ âˆˆ (est(n) - margin, est(n) + margin)] â‰¥ 1 - Î´

å…¶ä¸­margin = z_{Î´/2} * Ïƒ / âˆšn
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 ç›´æ–¹å›¾ä¸€è‡´æ€§å®šç†

**å®šç†1ï¼ˆç›´æ–¹å›¾ä¸€è‡´æ€§ï¼‰**ï¼š

ç›´æ–¹å›¾ä¼°è®¡æ˜¯ä¸€è‡´ä¼°è®¡ï¼Œè¯¯å·®ä¸Šç•Œä¸º1/Bã€‚å³å¯¹äºä»»æ„æŸ¥è¯¢æ¡ä»¶condï¼Œå½“æ¡¶æ•°B â†’ âˆæ—¶ï¼Œä¼°è®¡è¯¯å·®Îµ â†’ 0ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ç›´æ–¹å›¾ä¼°è®¡hist_estï¼ŒçœŸå®å€¼Î¸ï¼Œæ¡¶æ•°Bã€‚åˆ™ï¼š

```text
âˆ€Îµ > 0: lim_{Bâ†’âˆ} P[|hist_est(B) - Î¸| > Îµ] = 0
ä¸”
Îµ_bound(hist_est) â‰¤ 1/B
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šæ¡¶æ•°å¢åŠ çš„å½±å“**ï¼š

- å½“æ¡¶æ•°B â†’ âˆæ—¶ï¼Œæ¯ä¸ªæ¡¶çš„å®½åº¦/é«˜åº¦ â†’ 0
- ç›´æ–¹å›¾èƒ½å¤Ÿæ›´ç²¾ç¡®åœ°è¡¨ç¤ºæ•°æ®åˆ†å¸ƒ

**æ­¥éª¤2ï¼šä¼°è®¡å€¼æ”¶æ•›**ï¼š

- éšç€æ¡¶æ•°å¢åŠ ï¼Œä¼°è®¡å€¼æ”¶æ•›åˆ°çœŸå®å€¼
- è¯¯å·®ä¸Šç•Œæ˜¯1/Bï¼Œå½“B â†’ âˆæ—¶è¯¯å·® â†’ 0

**æ­¥éª¤3ï¼šä¸€è‡´æ€§å®šä¹‰**ï¼š

- æ ¹æ®ä¸€è‡´æ€§å®šä¹‰ï¼Œå½“B â†’ âˆæ—¶ï¼Œä¼°è®¡è¯¯å·®ä»¥æ¦‚ç‡1æ”¶æ•›åˆ°0
- å› æ­¤ç›´æ–¹å›¾ä¼°è®¡æ˜¯ä¸€è‡´ä¼°è®¡

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- ç›´æ–¹å›¾ä¸€è‡´æ€§å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[ç›´æ–¹å›¾ä¸€è‡´æ€§å®šç†] --> B[æ¡¶æ•°å¢åŠ çš„å½±å“]
    B --> C[ä¼°è®¡å€¼æ”¶æ•›]
    C --> D[ä¸€è‡´æ€§å®šä¹‰]
    D --> E[å®šç†å¾—è¯]

    style A fill:#FFD700
    style E fill:#90EE90
```

### 4.2 é‡‡æ ·ä¸€è‡´æ€§å®šç†

**å®šç†2ï¼ˆé‡‡æ ·ä¸€è‡´æ€§ï¼‰**ï¼š

ç®€å•éšæœºé‡‡æ ·ä¼°è®¡æ˜¯ä¸€è‡´ä¼°è®¡ï¼Œè¯¯å·®ä¸Šç•Œä¸ºO(1/âˆšn)ã€‚å³å¯¹äºä»»æ„æŸ¥è¯¢æ¡ä»¶condï¼Œå½“æ ·æœ¬é‡n â†’ âˆæ—¶ï¼Œä¼°è®¡è¯¯å·®Îµ â†’ 0ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾é‡‡æ ·ä¼°è®¡sample_estï¼ŒçœŸå®å€¼Î¸ï¼Œæ ·æœ¬é‡nã€‚åˆ™ï¼š

```text
âˆ€Îµ > 0: lim_{nâ†’âˆ} P[|sample_est(n) - Î¸| > Îµ] = 0
ä¸”
Îµ_bound(sample_est) = O(1/âˆšn)
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šå¤§æ•°å®šå¾‹**ï¼š

- æ ¹æ®å¤§æ•°å®šå¾‹ï¼Œæ ·æœ¬å‡å€¼æ”¶æ•›åˆ°æ€»ä½“å‡å€¼
- å½“n â†’ âˆæ—¶ï¼Œæ ·æœ¬å‡å€¼ä»¥æ¦‚ç‡1æ”¶æ•›åˆ°çœŸå®å€¼

**æ­¥éª¤2ï¼šä¸­å¿ƒæé™å®šç†**ï¼š

- æ ¹æ®ä¸­å¿ƒæé™å®šç†ï¼Œä¼°è®¡è¯¯å·®æ¸è¿‘æ­£æ€åˆ†å¸ƒ
- è¯¯å·®çš„æ ‡å‡†å·®ä¸ºÏƒ/âˆšnï¼Œå…¶ä¸­Ïƒæ˜¯æ€»ä½“æ ‡å‡†å·®

**æ­¥éª¤3ï¼šHoeffdingç•Œ**ï¼š

- ä½¿ç”¨Hoeffdingç•Œï¼Œè¯¯å·®ä¸Šç•Œä¸ºO(1/âˆšn)
- å½“n â†’ âˆæ—¶ï¼Œè¯¯å·® â†’ 0

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- é‡‡æ ·ä¸€è‡´æ€§å®šç†å¾—è¯

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯å®ç°

**æŸ¥çœ‹ç›´æ–¹å›¾**ï¼š

```sql
-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒ…å«ç›´æ–¹å›¾ï¼‰
SELECT
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE tablename = 'orders' AND attname = 'order_date';

-- histogram_boundsåŒ…å«ç›´æ–¹å›¾çš„è¾¹ç•Œ
```

**ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼š

```sql
-- æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´
SELECT
    schemaname,
    tablename,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'orders';
```

### 5.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

éœ€è¦ç›‘æ§å’Œç®¡ç†è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œç¡®ä¿æŸ¥è¯¢ä¼˜åŒ–å™¨èƒ½å¤Ÿå‡†ç¡®ä¼°è®¡æŸ¥è¯¢æˆæœ¬ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯ç®¡ç†
-- 1. æŸ¥çœ‹ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs,
    histogram_bounds
FROM pg_stats
WHERE tablename = 'orders'
  AND attname IN ('order_date', 'customer_id', 'status')
ORDER BY attname;

-- 2. åˆ†æç›´æ–¹å›¾æ¡¶æ•°
SELECT
    attname,
    array_length(histogram_bounds, 1) + 1 AS bucket_count,
    (SELECT COUNT(*) FROM orders) AS total_rows,
    n_distinct AS distinct_values
FROM pg_stats
WHERE tablename = 'orders'
  AND histogram_bounds IS NOT NULL;

-- 3. è¯„ä¼°ç›´æ–¹å›¾è´¨é‡
CREATE OR REPLACE FUNCTION evaluate_histogram_quality(
    p_table_name VARCHAR,
    p_column_name VARCHAR
)
RETURNS TABLE (
    bucket_count INTEGER,
    distinct_values REAL,
    coverage_ratio DOUBLE PRECISION,
    quality_score DOUBLE PRECISION
) AS $$
DECLARE
    v_bucket_count INTEGER;
    v_distinct_values REAL;
    v_total_rows BIGINT;
BEGIN
    -- è·å–ç»Ÿè®¡ä¿¡æ¯
    SELECT
        array_length(histogram_bounds, 1) + 1,
        n_distinct,
        (SELECT COUNT(*) FROM pg_class WHERE relname = p_table_name)
    INTO v_bucket_count, v_distinct_values, v_total_rows
    FROM pg_stats
    WHERE tablename = p_table_name
      AND attname = p_column_name;

    -- è®¡ç®—è¦†ç›–ç‡ï¼ˆæ¡¶æ•°/ä¸åŒå€¼æ•°ï¼‰
    RETURN QUERY SELECT
        v_bucket_count,
        v_distinct_values,
        CASE
            WHEN v_distinct_values > 0 THEN
                LEAST(v_bucket_count::DOUBLE PRECISION / v_distinct_values, 1.0)
            ELSE 0.0
        END AS coverage_ratio,
        -- è´¨é‡è¯„åˆ†ï¼šè¦†ç›–ç‡è¶Šé«˜ï¼Œè´¨é‡è¶Šå¥½
        CASE
            WHEN v_distinct_values > 0 THEN
                LEAST(v_bucket_count::DOUBLE PRECISION / v_distinct_values, 1.0) * 100
            ELSE 0.0
        END AS quality_score;
END;
$$ LANGUAGE plpgsql;
```

#### åœºæ™¯2ï¼šé‡‡æ ·ç»Ÿè®¡ä¸è¯¯å·®åˆ†æ

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

ä½¿ç”¨é‡‡æ ·ç»Ÿè®¡è¿›è¡Œå¿«é€Ÿæ•°æ®åˆ†æï¼Œå¹¶è¯„ä¼°é‡‡æ ·è¯¯å·®ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šé‡‡æ ·ç»Ÿè®¡ä¸è¯¯å·®åˆ†æ
-- 1. ä½¿ç”¨è¡¨é‡‡æ ·è¿›è¡Œå¿«é€Ÿç»Ÿè®¡
WITH sampled_data AS (
    SELECT *
    FROM orders TABLESAMPLE SYSTEM (10)  -- 10%é‡‡æ ·
)
SELECT
    status,
    COUNT(*) AS sample_count,
    COUNT(*) * 10 AS estimated_total  -- æ”¾å¤§10å€ä¼°è®¡æ€»æ•°
FROM sampled_data
GROUP BY status;

-- 2. å¯¹æ¯”é‡‡æ ·ä¼°è®¡å’Œå®é™…å€¼
WITH actual_stats AS (
    SELECT status, COUNT(*) AS actual_count
    FROM orders
    GROUP BY status
),
sampled_stats AS (
    SELECT
        status,
        COUNT(*) AS sample_count,
        COUNT(*) * 10 AS estimated_count
    FROM orders TABLESAMPLE SYSTEM (10)
    GROUP BY status
)
SELECT
    COALESCE(a.status, s.status) AS status,
    a.actual_count,
    s.estimated_count,
    ABS(a.actual_count - s.estimated_count) AS error_abs,
    CASE
        WHEN a.actual_count > 0 THEN
            ABS(a.actual_count - s.estimated_count)::DOUBLE PRECISION / a.actual_count * 100
        ELSE NULL
    END AS error_rel_pct
FROM actual_stats a
FULL OUTER JOIN sampled_stats s ON a.status = s.status;

-- 3. è®¡ç®—é‡‡æ ·è¯¯å·®ç½®ä¿¡åŒºé—´
CREATE OR REPLACE FUNCTION calculate_sampling_error(
    p_sample_size INTEGER,
    p_sample_mean DOUBLE PRECISION,
    p_confidence DOUBLE PRECISION DEFAULT 0.95
)
RETURNS TABLE (
    sample_mean DOUBLE PRECISION,
    margin_of_error DOUBLE PRECISION,
    confidence_interval_lower DOUBLE PRECISION,
    confidence_interval_upper DOUBLE PRECISION
) AS $$
DECLARE
    v_z_score DOUBLE PRECISION;
    v_std_error DOUBLE PRECISION;
    v_margin DOUBLE PRECISION;
BEGIN
    -- ç®€åŒ–ï¼šå‡è®¾æ ‡å‡†å·®ä¸ºæ ·æœ¬å‡å€¼çš„10%
    v_std_error := p_sample_mean * 0.1 / SQRT(p_sample_size);

    -- Zåˆ†æ•°ï¼ˆ95%ç½®ä¿¡åº¦çº¦ä¸º1.96ï¼‰
    v_z_score := CASE
        WHEN p_confidence = 0.95 THEN 1.96
        WHEN p_confidence = 0.99 THEN 2.58
        ELSE 1.96
    END;

    v_margin := v_z_score * v_std_error;

    RETURN QUERY SELECT
        p_sample_mean,
        v_margin,
        p_sample_mean - v_margin,
        p_sample_mean + v_margin;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 PostgreSQL 18ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–

#### 5.3.1 è°ƒæ•´ç»Ÿè®¡ç›®æ ‡

**PostgreSQL 18ç»Ÿè®¡ç›®æ ‡è®¾ç½®**ï¼š

```sql
-- è®¾ç½®åˆ—çš„ç»Ÿè®¡ç›®æ ‡ï¼ˆå½±å“ç›´æ–¹å›¾æ¡¶æ•°ï¼‰
ALTER TABLE orders
ALTER COLUMN order_date SET STATISTICS 1000;

-- é»˜è®¤æ˜¯100ï¼Œå¢åŠ å¯ä»¥æé«˜ä¼°è®¡ç²¾åº¦
-- ä½†ä¼šå¢åŠ ANALYZEçš„æ—¶é—´å’Œå­˜å‚¨ç©ºé—´

-- é‡æ–°åˆ†æ
ANALYZE orders;
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ](./15.01-é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Ioannidis, Y. E., & Poosala, V. (1999). "Histogram-Based Approximation of Set-Valued Query-Answers."**
  - ä¼šè®®: VLDB 1999
  - **é‡è¦æ€§**: ç›´æ–¹å›¾ä¼°è®¡çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ç›´æ–¹å›¾ä¼°è®¡çš„è¯¯å·®ç•Œ

- **Hoeffding, W. (1963). "Probability Inequalities for Sums of Bounded Random Variables."**
  - æœŸåˆŠ: Journal of the American Statistical Association 1963
  - **é‡è¦æ€§**: é‡‡æ ·è¯¯å·®ç•Œçš„ç»å…¸ç†è®º
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†Hoeffdingä¸ç­‰å¼

### 7.2 ç»Ÿè®¡ä¼°è®¡ç›¸å…³

- **Chaudhuri, S., et al. (2007). "Optimizing Queries with Materialized Views."**
  - ä¼šè®®: ICDE 2007
  - **é‡è¦æ€§**: ç»Ÿè®¡ä¼°è®¡ä¼˜åŒ–çš„ç»å…¸ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†è‡ªé€‚åº”ç»Ÿè®¡ä¼°è®¡æ–¹æ³•

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯](<https://www.postgresql.org/docs/current/planner-stats.html>)**
  - PostgreSQLç»Ÿè®¡ä¿¡æ¯å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ](./15.01-é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
