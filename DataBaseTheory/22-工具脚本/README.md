# PostgreSQLå·¥å…·è„šæœ¬é›†

> **å®ç”¨å·¥å…·ä¸è‡ªåŠ¨åŒ–è„šæœ¬**

---

## è„šæœ¬æ¸…å•

### 1. æ€§èƒ½ç›‘æ§è„šæœ¬

**æ–‡ä»¶**: `01-æ€§èƒ½ç›‘æ§è„šæœ¬.sh`

**åŠŸèƒ½**:
- æ•°æ®åº“å¤§å°ç»Ÿè®¡
- Top 10æ…¢æŸ¥è¯¢
- è¿æ¥çŠ¶æ€åˆ†æ
- è¡¨è†¨èƒ€æ£€æµ‹
- ç¼“å­˜å‘½ä¸­ç‡
- é”ç­‰å¾…æ£€æµ‹
- â­ PostgreSQL 18ç‰¹æ€§ä½¿ç”¨æƒ…å†µ

**ä½¿ç”¨**:
```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=mydb
export DB_USER=postgres

./01-æ€§èƒ½ç›‘æ§è„šæœ¬.sh
```

**è¾“å‡ºç¤ºä¾‹**:
```
=== PostgreSQL 18æ€§èƒ½ç›‘æ§ ===
æ—¶é—´: 2025-12-04 10:30:00

ã€æ•°æ®åº“å¤§å°ã€‘
datname     size
mydb        125GB
testdb      15GB

ã€Top 10æ…¢æŸ¥è¯¢ã€‘
query                                                    calls  avg_ms  total_ms
SELECT * FROM orders WHERE customer_id = ...            1250   850.5   1063125
...

âœ… æ— é”ç­‰å¾…
```

---

### 2. è‡ªåŠ¨ä¼˜åŒ–å»ºè®®

**æ–‡ä»¶**: `02-è‡ªåŠ¨ä¼˜åŒ–å»ºè®®.sql`

**åŠŸèƒ½**:
- æ£€æµ‹ç¼ºå¤±çš„ç´¢å¼•
- è¯†åˆ«æœªä½¿ç”¨çš„ç´¢å¼•
- è¡¨è†¨èƒ€æ£€æµ‹
- ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸæ£€æµ‹
- â­ PostgreSQL 18ç‰¹æ€§å»ºè®®
- é…ç½®å‚æ•°ä¼˜åŒ–å»ºè®®

**ä½¿ç”¨**:
```sql
psql -d mydb -f 02-è‡ªåŠ¨ä¼˜åŒ–å»ºè®®.sql

-- æˆ–
SELECT * FROM generate_optimization_suggestions();
```

**è¾“å‡ºç¤ºä¾‹**:
```
category   | severity | suggestion                                    | current_value | recommended_value
-----------+----------+-----------------------------------------------+---------------+-------------------
Index      | HIGH     | Table public.orders has seq_scan=5000...    | No index      | CREATE INDEX ON...
Vacuum     | HIGH     | Table public.logs has 25% dead tuples       | dead_pct=25%  | VACUUM (ANALYZE)...
PG18 Feature| MEDIUM   | Enable async I/O for better throughput       | off           | ALTER SYSTEM SET...
```

---

### 3. å¥åº·æ£€æŸ¥å·¥å…·

**æ–‡ä»¶**: `03-å¥åº·æ£€æŸ¥.py`

**åŠŸèƒ½**:
- ç‰ˆæœ¬æ£€æŸ¥
- è¿æ¥æ•°ç›‘æ§
- ç¼“å­˜å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢ç»Ÿè®¡
- è¡¨è†¨èƒ€æ£€æµ‹
- é”ç­‰å¾…æ£€æµ‹
- å¤åˆ¶å»¶è¿Ÿ
- â­ PostgreSQL 18ç‰¹æ€§æ£€æŸ¥

**ä½¿ç”¨**:
```bash
# å®‰è£…ä¾èµ–
pip install psycopg2-binary

# è¿è¡Œ
python3 03-å¥åº·æ£€æŸ¥.py

# æˆ–è®¾ç½®ç¯å¢ƒå˜é‡
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=mydb
export DB_USER=postgres
python3 03-å¥åº·æ£€æŸ¥.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
============================================================
PostgreSQLå¥åº·æ£€æŸ¥ - 2025-12-04 10:30:00
============================================================

âœ… PostgreSQLç‰ˆæœ¬: PostgreSQL 18.0
âœ… è¿æ¥æ•°æ­£å¸¸: 45/200 (22.5%)
âœ… ç¼“å­˜å‘½ä¸­ç‡: 96.5%
âš ï¸  å‘ç°15ä¸ªå¹³å‡æ‰§è¡Œæ—¶é—´>1ç§’çš„æŸ¥è¯¢
   Top 3æ…¢æŸ¥è¯¢:
   - 2500ms: SELECT * FROM orders WHERE...
âœ… æ— ä¸¥é‡è¡¨è†¨èƒ€
âœ… æ— é”ç­‰å¾…
âœ… ä»åº“192.168.1.10å»¶è¿Ÿæ­£å¸¸: 15KB

ã€PostgreSQL 18ç‰¹æ€§ã€‘
âœ… å·²å¯ç”¨ å†…ç½®è¿æ¥æ± : on
âœ… å·²å¯ç”¨ å¼‚æ­¥I/O: on
âš ï¸  æœªå¯ç”¨ JITç¼–è¯‘: off

============================================================
âš ï¸  å‘ç° 1 ä¸ªé—®é¢˜:
âš ï¸  å‘ç°15ä¸ªå¹³å‡æ‰§è¡Œæ—¶é—´>1ç§’çš„æŸ¥è¯¢

å»ºè®®è¿è¡Œä¼˜åŒ–å»ºè®®è„šæœ¬: psql -f 02-è‡ªåŠ¨ä¼˜åŒ–å»ºè®®.sql
============================================================
```

---

## å®šæ—¶ä»»åŠ¡é…ç½®

### Cronå®šæ—¶ç›‘æ§

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡
# æ¯å°æ—¶æ‰§è¡Œæ€§èƒ½ç›‘æ§
0 * * * * /path/to/01-æ€§èƒ½ç›‘æ§è„šæœ¬.sh >> /var/log/pg_monitor.log 2>&1

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¥åº·æ£€æŸ¥
0 2 * * * /path/to/03-å¥åº·æ£€æŸ¥.py >> /var/log/pg_health.log 2>&1

# æ¯å‘¨æ‰§è¡Œä¼˜åŒ–å»ºè®®
0 3 * * 0 psql -d mydb -f /path/to/02-è‡ªåŠ¨ä¼˜åŒ–å»ºè®®.sql >> /var/log/pg_optimize.log 2>&1
```

---

## å‘Šè­¦é›†æˆ

### é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ

```python
# é›†æˆPrometheus
from prometheus_client import Gauge, start_http_server

# å®šä¹‰æŒ‡æ ‡
pg_cache_hit_ratio = Gauge('pg_cache_hit_ratio', 'Cache hit ratio')
pg_slow_queries = Gauge('pg_slow_queries', 'Number of slow queries')

# æ›´æ–°æŒ‡æ ‡
checker = PostgreSQLHealthCheck()
# ... è·å–æŒ‡æ ‡å€¼
pg_cache_hit_ratio.set(hit_ratio)
pg_slow_queries.set(slow_count)

# å¯åŠ¨HTTPæœåŠ¡å™¨
start_http_server(8000)
```

---

## æœ€ä½³å®è·µ

1. **å®šæœŸè¿è¡Œ**ï¼šæ¯å°æ—¶æˆ–æ¯å¤©è¿è¡Œå¥åº·æ£€æŸ¥
2. **ä¿ç•™æ—¥å¿—**ï¼šä¿å­˜ç›‘æ§è¾“å‡ºï¼Œè¿½è¸ªè¶‹åŠ¿
3. **è®¾ç½®å‘Šè­¦**ï¼šå…³é”®æŒ‡æ ‡è¶…é˜ˆå€¼æ—¶å‘Šè­¦
4. **å®šæœŸä¼˜åŒ–**ï¼šæ¯å‘¨æŸ¥çœ‹ä¼˜åŒ–å»ºè®®å¹¶å®æ–½
5. **æµ‹è¯•éªŒè¯**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯ä¼˜åŒ–æ•ˆæœ

---

**æŒç»­æ›´æ–°ä¸­** ğŸš€
