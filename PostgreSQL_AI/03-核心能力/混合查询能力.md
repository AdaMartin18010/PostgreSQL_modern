# æ··åˆæŸ¥è¯¢èƒ½åŠ›

> **æ–‡æ¡£ç¼–å·**: AI-03-03  
> **æœ€åæ›´æ–°**: 2025å¹´1æœˆ  
> **ä¸»é¢˜**: 03-æ ¸å¿ƒèƒ½åŠ›  
> **å­ä¸»é¢˜**: 03-æ··åˆæŸ¥è¯¢èƒ½åŠ›

## ğŸ“‘ ç›®å½•

- [æ··åˆæŸ¥è¯¢èƒ½åŠ›](#æ··åˆæŸ¥è¯¢èƒ½åŠ›)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€æ··åˆæŸ¥è¯¢ç±»å‹](#äºŒæ··åˆæŸ¥è¯¢ç±»å‹)
    - [2.1 å‘é‡+SQLè”åˆæŸ¥è¯¢](#21-å‘é‡sqlè”åˆæŸ¥è¯¢)
    - [2.2 å‘é‡+å…¨æ–‡æœç´¢](#22-å‘é‡å…¨æ–‡æœç´¢)
    - [2.3 å‘é‡+åœ°ç†ç©ºé—´æŸ¥è¯¢](#23-å‘é‡åœ°ç†ç©ºé—´æŸ¥è¯¢)
    - [2.4 å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢](#24-å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢)
  - [ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#ä¸‰æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [3.1 ç´¢å¼•ç»„åˆç­–ç•¥](#31-ç´¢å¼•ç»„åˆç­–ç•¥)
    - [3.2 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–](#32-æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–)
    - [3.3 ç»“æœèåˆç®—æ³•](#33-ç»“æœèåˆç®—æ³•)
  - [å››ã€æ€§èƒ½ä¼˜åŒ–](#å››æ€§èƒ½ä¼˜åŒ–)
    - [4.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#41-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
    - [4.2 ç´¢å¼•ä¼˜åŒ–](#42-ç´¢å¼•ä¼˜åŒ–)
    - [4.3 ç¼“å­˜ç­–ç•¥](#43-ç¼“å­˜ç­–ç•¥)
  - [äº”ã€æœ€ä½³å®è·µ](#äº”æœ€ä½³å®è·µ)
  - [å…­ã€å…³è”ä¸»é¢˜](#å…­å…³è”ä¸»é¢˜)
  - [ä¸ƒã€å¯¹æ ‡èµ„æº](#ä¸ƒå¯¹æ ‡èµ„æº)

## ä¸€ã€æ¦‚è¿°

PostgreSQLçš„æ··åˆæŸ¥è¯¢èƒ½åŠ›å…è®¸åœ¨å•æ¡SQLè¯­å¥ä¸­åŒæ—¶ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€ä¼ ç»ŸSQLæŸ¥è¯¢ã€å…¨æ–‡æœç´¢ã€åœ°ç†ç©ºé—´æŸ¥è¯¢ç­‰å¤šç§æŸ¥è¯¢æ–¹å¼ï¼Œå®ç°å¤æ‚ä¸šåŠ¡åœºæ™¯çš„ç»Ÿä¸€æŸ¥è¯¢æ¥å£ã€‚

## äºŒã€æ··åˆæŸ¥è¯¢ç±»å‹

### 2.1 å‘é‡+SQLè”åˆæŸ¥è¯¢

ç»“åˆå‘é‡ç›¸ä¼¼åº¦å’Œä¼ ç»ŸSQLæ¡ä»¶ï¼š

```sql
-- å‘é‡ç›¸ä¼¼åº¦ + æ¡ä»¶è¿‡æ»¤
SELECT 
    id,
    title,
    category,
    price,
    description_vector <=> query_vector AS similarity
FROM products
WHERE category = 'electronics'
  AND price < 1000
  AND description_vector <=> query_vector < 0.8
ORDER BY description_vector <=> query_vector
LIMIT 20;
```

**ä¼˜åŒ–æŠ€å·§**:
- å…ˆä½¿ç”¨æ¡ä»¶è¿‡æ»¤å‡å°‘æœç´¢ç©ºé—´
- å†æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦è®¡ç®—
- ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–

### 2.2 å‘é‡+å…¨æ–‡æœç´¢

ç»“åˆå‘é‡è¯­ä¹‰æœç´¢å’Œå…³é”®è¯å…¨æ–‡æœç´¢ï¼š

```sql
-- å‘é‡æœç´¢ + å…¨æ–‡æœç´¢
WITH vector_results AS (
    SELECT 
        id, content, 
        description_vector <=> query_vector AS vector_distance
    FROM documents
    WHERE description_vector <=> query_vector < 0.8
    ORDER BY description_vector <=> query_vector
    LIMIT 50
),
text_results AS (
    SELECT 
        id, content,
        ts_rank(content_tsv, plainto_tsquery(:query_text)) AS text_rank
    FROM documents
    WHERE content_tsv @@ plainto_tsquery(:query_text)
    ORDER BY text_rank DESC
    LIMIT 50
)
SELECT DISTINCT
    COALESCE(v.id, t.id) AS id,
    COALESCE(v.content, t.content) AS content,
    COALESCE(1 - v.vector_distance, 0) * 0.7 + 
    COALESCE(t.text_rank, 0) * 0.3 AS combined_score
FROM vector_results v
FULL OUTER JOIN text_results t ON v.id = t.id
ORDER BY combined_score DESC
LIMIT 20;
```

### 2.3 å‘é‡+åœ°ç†ç©ºé—´æŸ¥è¯¢

ç»“åˆå‘é‡ç›¸ä¼¼åº¦å’Œåœ°ç†ä½ç½®è¿‡æ»¤ï¼š

```sql
-- å‘é‡æœç´¢ + åœ°ç†ç©ºé—´æŸ¥è¯¢
SELECT 
    l.id,
    l.title,
    l.description_vector <=> query_vector AS similarity,
    ST_Distance(l.geom, user_location) / 1000.0 AS distance_km
FROM listings l
WHERE l.description_vector <=> query_vector < 0.8
  AND ST_DWithin(l.geom, user_location, 5000)  -- 5å…¬é‡Œå†…
  AND l.rating > 4.5
ORDER BY 
    (l.description_vector <=> query_vector) * 0.6 +  -- ç›¸ä¼¼åº¦æƒé‡60%
    (ST_Distance(l.geom, user_location) / 5000.0) * 0.4  -- è·ç¦»æƒé‡40%
LIMIT 20;
```

### 2.4 å¤šæ¨¡æ€æ•°æ®æŸ¥è¯¢

åŒæ—¶æŸ¥è¯¢æ–‡æœ¬ã€å›¾åƒã€JSONç­‰å¤šç§æ•°æ®ç±»å‹ï¼š

```sql
-- å¤šæ¨¡æ€æŸ¥è¯¢ï¼šæ–‡æœ¬å‘é‡ + å›¾åƒå‘é‡ + JSONè¿‡æ»¤
SELECT 
    p.id,
    p.title,
    p.description_vector <=> text_query_vector AS text_similarity,
    p.image_vector <=> image_query_vector AS image_similarity,
    p.metadata->>'brand' AS brand
FROM products p
WHERE p.description_vector <=> text_query_vector < 0.8
  AND p.image_vector <=> image_query_vector < 0.8
  AND p.metadata->>'brand' = 'Apple'
  AND (p.metadata->>'price')::numeric < 1000
ORDER BY 
    (p.description_vector <=> text_query_vector) * 0.5 +
    (p.image_vector <=> image_query_vector) * 0.5
LIMIT 20;
```

## ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

### 3.1 ç´¢å¼•ç»„åˆç­–ç•¥

```sql
-- å¤åˆç´¢å¼•ï¼šæ¡ä»¶ + å‘é‡
CREATE INDEX ON products 
USING btree (category, price, (description_vector <=> query_vector));

-- GINç´¢å¼•ï¼šå…¨æ–‡æœç´¢
CREATE INDEX ON documents 
USING gin (content_tsv);

-- GISTç´¢å¼•ï¼šåœ°ç†ç©ºé—´
CREATE INDEX ON listings 
USING gist (geom);

-- è¦†ç›–ç´¢å¼•ï¼šåŒ…å«å¸¸ç”¨åˆ—
CREATE INDEX ON products 
USING btree (category) 
INCLUDE (title, price, description_vector);
```

### 3.2 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–

```sql
-- ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM products
WHERE category = 'electronics'
  AND description_vector <=> query_vector < 0.8
ORDER BY description_vector <=> query_vector
LIMIT 20;

-- ä¼˜åŒ–å»ºè®®ï¼š
-- 1. ç¡®ä¿æ¡ä»¶è¿‡æ»¤åœ¨å‘é‡æœç´¢ä¹‹å‰
-- 2. ä½¿ç”¨LIMITå‡å°‘ç»“æœé›†
-- 3. åˆç†è®¾ç½®work_mem
SET work_mem = '256MB';
```

### 3.3 ç»“æœèåˆç®—æ³•

```sql
-- RRF (Reciprocal Rank Fusion) ç®—æ³•
CREATE OR REPLACE FUNCTION rrf_fusion(
    vector_ranks INTEGER[],
    text_ranks INTEGER[],
    k INTEGER DEFAULT 60
) RETURNS DECIMAL AS $$
BEGIN
    RETURN (
        SELECT SUM(1.0 / (k + rank)) 
        FROM (
            SELECT unnest(vector_ranks) AS rank
            UNION ALL
            SELECT unnest(text_ranks) AS rank
        ) ranks
    );
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨RRFèåˆç»“æœ
WITH vector_ranked AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY vector_distance) AS rank
    FROM vector_results
),
text_ranked AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY text_rank DESC) AS rank
    FROM text_results
)
SELECT 
    COALESCE(v.id, t.id) AS id,
    rrf_fusion(
        ARRAY[v.rank],
        ARRAY[t.rank]
    ) AS rrf_score
FROM vector_ranked v
FULL OUTER JOIN text_ranked t ON v.id = t.id
ORDER BY rrf_score DESC;
```

## å››ã€æ€§èƒ½ä¼˜åŒ–

### 4.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

```sql
-- 1. ä½¿ç”¨å­æŸ¥è¯¢å…ˆè¿‡æ»¤
SELECT * FROM (
    SELECT * FROM products
    WHERE category = 'electronics'
      AND price < 1000
) filtered
WHERE description_vector <=> query_vector < 0.8
ORDER BY description_vector <=> query_vector
LIMIT 20;

-- 2. ä½¿ç”¨ç‰©åŒ–CTE
WITH filtered_products AS MATERIALIZED (
    SELECT * FROM products
    WHERE category = 'electronics'
)
SELECT * FROM filtered_products
WHERE description_vector <=> query_vector < 0.8
ORDER BY description_vector <=> query_vector
LIMIT 20;
```

### 4.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ†åŒºè¡¨ + åˆ†åŒºç´¢å¼•
CREATE TABLE products_2024 PARTITION OF products
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

CREATE INDEX ON products_2024 
USING hnsw (description_vector vector_cosine_ops);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰
CREATE INDEX ON products 
USING hnsw (description_vector vector_cosine_ops)
WHERE status = 'active';
```

### 4.3 ç¼“å­˜ç­–ç•¥

```sql
-- æŸ¥è¯¢ç»“æœç¼“å­˜
CREATE TABLE query_cache (
    query_hash TEXT PRIMARY KEY,
    query_vector vector(1536),
    filter_conditions JSONB,
    result_ids INTEGER[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);

-- ä½¿ç”¨ç¼“å­˜
CREATE OR REPLACE FUNCTION get_cached_results(
    p_query_vector vector(1536),
    p_filters JSONB
) RETURNS INTEGER[] AS $$
DECLARE
    v_hash TEXT;
    v_results INTEGER[];
BEGIN
    v_hash := md5(p_query_vector::text || p_filters::text);
    
    SELECT result_ids INTO v_results
    FROM query_cache
    WHERE query_hash = v_hash
      AND expires_at > NOW();
    
    IF v_results IS NOT NULL THEN
        RETURN v_results;
    END IF;
    
    -- æ‰§è¡ŒæŸ¥è¯¢å¹¶ç¼“å­˜ç»“æœ
    -- ...
    
    RETURN v_results;
END;
$$ LANGUAGE plpgsql;
```

## äº”ã€æœ€ä½³å®è·µ

1. **æŸ¥è¯¢é¡ºåºä¼˜åŒ–**:
   - å…ˆæ‰§è¡Œé€‰æ‹©æ€§é«˜çš„æ¡ä»¶è¿‡æ»¤
   - å†æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢
   - æœ€åè¿›è¡Œç»“æœæ’åº

2. **ç´¢å¼•ç­–ç•¥**:
   - ä¸ºå¸¸ç”¨è¿‡æ»¤æ¡ä»¶åˆ›å»ºB-treeç´¢å¼•
   - ä¸ºå‘é‡åˆ—åˆ›å»ºHNSWç´¢å¼•
   - ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–æ··åˆæŸ¥è¯¢

3. **æƒé‡è®¾ç½®**:
   - æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´å„ç»´åº¦æƒé‡
   - ä½¿ç”¨A/Bæµ‹è¯•ä¼˜åŒ–æƒé‡å‚æ•°

4. **æ€§èƒ½ç›‘æ§**:
   ```sql
   -- ç›‘æ§æ··åˆæŸ¥è¯¢æ€§èƒ½
   SELECT 
       query_type,
       AVG(execution_time) AS avg_time,
       P95(execution_time) AS p95_time
   FROM query_log
   WHERE query_type = 'hybrid'
   GROUP BY query_type;
   ```

## å…­ã€å…³è”ä¸»é¢˜

- [å‘é‡å¤„ç†èƒ½åŠ› (pgvector)](./å‘é‡å¤„ç†èƒ½åŠ›-pgvector.md) - å‘é‡æœç´¢åŸºç¡€
- [æ™ºèƒ½æ¨èç³»ç»Ÿ](../04-åº”ç”¨åœºæ™¯/æ™ºèƒ½æ¨èç³»ç»Ÿ.md) - æ··åˆæ¨èåº”ç”¨
- [Qunaré€”å®¶æ¡ˆä¾‹](../05-å®è·µæ¡ˆä¾‹/Qunaré€”å®¶æ¡ˆä¾‹.md) - å®é™…åº”ç”¨æ¡ˆä¾‹

## ä¸ƒã€å¯¹æ ‡èµ„æº

### æŠ€æœ¯æ–‡æ¡£
- [PostgreSQLå…¨æ–‡æœç´¢æ–‡æ¡£](https://www.postgresql.org/docs/current/textsearch.html)
- [PostGISç©ºé—´æŸ¥è¯¢æ–‡æ¡£](https://postgis.net/docs/)
- [pgvectoræ··åˆæŸ¥è¯¢ç¤ºä¾‹](https://github.com/pgvector/pgvector/tree/master/examples)

### å­¦æœ¯è®ºæ–‡
- Reciprocal Rank Fusionç®—æ³•è®ºæ–‡
- å¤šæ¨¡æ€æ£€ç´¢æŠ€æœ¯ç ”ç©¶

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team  
**æ–‡æ¡£ç¼–å·**: AI-03-03

