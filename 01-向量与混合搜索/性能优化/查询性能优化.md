# æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 01-04-02

## ğŸ“‘ ç›®å½•

- [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¼˜åŒ–ç›®æ ‡](#11-ä¼˜åŒ–ç›®æ ‡)
    - [1.2 ä¼˜åŒ–ç­–ç•¥](#12-ä¼˜åŒ–ç­–ç•¥)
  - [2. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§](#2-æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§)
    - [2.1 ä½¿ç”¨ LIMIT é™åˆ¶ç»“æœ](#21-ä½¿ç”¨-limit-é™åˆ¶ç»“æœ)
    - [2.2 é¿å…ä¸å¿…è¦çš„è®¡ç®—](#22-é¿å…ä¸å¿…è¦çš„è®¡ç®—)
    - [2.3 ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥](#23-ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥)
  - [3. ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–](#3-ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–)
    - [3.1 ç¡®ä¿ä½¿ç”¨ç´¢å¼•](#31-ç¡®ä¿ä½¿ç”¨ç´¢å¼•)
    - [3.2 ç´¢å¼•å‚æ•°è°ƒä¼˜](#32-ç´¢å¼•å‚æ•°è°ƒä¼˜)
  - [4. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–](#4-æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–)
    - [4.1 æ‰¹é‡å‘é‡æŸ¥è¯¢](#41-æ‰¹é‡å‘é‡æŸ¥è¯¢)
    - [4.2 ä½¿ç”¨æ•°ç»„æŸ¥è¯¢](#42-ä½¿ç”¨æ•°ç»„æŸ¥è¯¢)
  - [5. å®è·µæ¡ˆä¾‹](#5-å®è·µæ¡ˆä¾‹)
    - [5.1 é«˜å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–](#51-é«˜å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¼˜åŒ–ç›®æ ‡

- **æŸ¥è¯¢é€Ÿåº¦**: P99 å»¶è¿Ÿ < 100ms
- **ååé‡**: QPS > 1000
- **èµ„æºåˆ©ç”¨**: CPU å’Œå†…å­˜é«˜æ•ˆåˆ©ç”¨

### 1.2 ä¼˜åŒ–ç­–ç•¥

1. **ç´¢å¼•ä¼˜åŒ–**: é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹å’Œå‚æ•°
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢è¯­å¥å’Œå‚æ•°
3. **æ‰¹é‡ä¼˜åŒ–**: æ‰¹é‡æŸ¥è¯¢å‡å°‘å¼€é”€
4. **ç¼“å­˜ä¼˜åŒ–**: ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›

## 2. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

### 2.1 ä½¿ç”¨ LIMIT é™åˆ¶ç»“æœ

```sql
-- å¥½çš„åšæ³•ï¼šä½¿ç”¨ LIMIT
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- ä¸å¥½çš„åšæ³•ï¼šä¸ä½¿ç”¨ LIMIT
SELECT * FROM vectors
ORDER BY embedding <=> query_vector;
```

### 2.2 é¿å…ä¸å¿…è¦çš„è®¡ç®—

```sql
-- å¥½çš„åšæ³•ï¼šåªé€‰æ‹©éœ€è¦çš„åˆ—
SELECT id, metadata
FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- ä¸å¥½çš„åšæ³•ï¼šé€‰æ‹©æ‰€æœ‰åˆ—
SELECT *
FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;
```

### 2.3 ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥

```python
# ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥æå‡æ€§èƒ½
class OptimizedQuery:
    async def search(self, query_vector, limit=10):
        # é¢„ç¼–è¯‘æŸ¥è¯¢
        query = """
            SELECT id, metadata,
                   1 - (embedding <=> $1::vector) AS similarity
            FROM vectors
            ORDER BY embedding <=> $1::vector
            LIMIT $2
        """

        async with self.db_pool.acquire() as conn:
            # ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
            stmt = await conn.prepare(query)
            return await stmt.fetch(query_vector, limit)
```

## 3. ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–

### 3.1 ç¡®ä¿ä½¿ç”¨ç´¢å¼•

```sql
-- æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- åº”è¯¥çœ‹åˆ° Index Scan using vectors_embedding_idx
```

### 3.2 ç´¢å¼•å‚æ•°è°ƒä¼˜

```sql
-- æ ¹æ®æŸ¥è¯¢æ¨¡å¼è°ƒæ•´ ef_search
SET hnsw.ef_search = 100;  -- é«˜å¬å›ç‡
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

SET hnsw.ef_search = 20;  -- å¿«é€ŸæŸ¥è¯¢
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;
```

## 4. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

### 4.1 æ‰¹é‡å‘é‡æŸ¥è¯¢

```python
# æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
class BatchQueryOptimizer:
    async def batch_search(self, query_vectors, limit=10):
        """æ‰¹é‡æŸ¥è¯¢å¤šä¸ªå‘é‡"""
        tasks = []
        for query_vector in query_vectors:
            task = self.search(query_vector, limit)
            tasks.append(task)

        # å¹¶è¡Œæ‰§è¡Œ
        results = await asyncio.gather(*tasks)
        return results
```

### 4.2 ä½¿ç”¨æ•°ç»„æŸ¥è¯¢

```sql
-- ä½¿ç”¨æ•°ç»„è¿›è¡Œæ‰¹é‡æŸ¥è¯¢
WITH query_vectors AS (
    SELECT unnest(ARRAY[
        '[0.1, 0.2, 0.3]'::vector,
        '[0.4, 0.5, 0.6]'::vector
    ]) AS query_vector
)
SELECT
    query_vector,
    id,
    embedding <=> query_vector AS distance
FROM vectors, query_vectors
ORDER BY embedding <=> query_vector
LIMIT 10;
```

## 5. å®è·µæ¡ˆä¾‹

### 5.1 é«˜å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–

```python
# é«˜å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–
class HighConcurrencyQuery:
    def __init__(self):
        self.pool = create_pool(max_size=200)
        self.cache = RedisCache()

    async def search(self, query_vector, limit=10):
        # 1. æ£€æŸ¥ç¼“å­˜
        cache_key = self._get_cache_key(query_vector, limit)
        cached = await self.cache.get(cache_key)
        if cached:
            return cached

        # 2. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆä½¿ç”¨è¾ƒä½çš„ ef_searchï¼‰
        async with self.pool.acquire() as conn:
            await conn.execute("SET hnsw.ef_search = 20")

            result = await conn.fetch("""
                SELECT id, metadata
                FROM vectors
                ORDER BY embedding <=> $1::vector
                LIMIT $2
            """, query_vector, limit)

        # 3. ç¼“å­˜ç»“æœ
        await self.cache.set(cache_key, result, ttl=300)
        return result
```

## 6. å‚è€ƒèµ„æ–™

- [æ€§èƒ½è°ƒä¼˜æŠ€å·§](../æœ€ä½³å®è·µ/æ€§èƒ½è°ƒä¼˜æŠ€å·§.md)
- [HNSW æ€§èƒ½ä¼˜åŒ–](./HNSWæ€§èƒ½ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 01-04-02
