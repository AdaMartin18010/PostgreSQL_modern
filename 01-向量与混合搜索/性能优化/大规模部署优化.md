# å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 01-04-03

## ğŸ“‘ ç›®å½•

- [å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–](#å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 å¤§è§„æ¨¡éƒ¨ç½²æŒ‘æˆ˜](#11-å¤§è§„æ¨¡éƒ¨ç½²æŒ‘æˆ˜)
    - [1.2 ä¼˜åŒ–ç­–ç•¥](#12-ä¼˜åŒ–ç­–ç•¥)
  - [2. æ°´å¹³æ‰©å±•](#2-æ°´å¹³æ‰©å±•)
    - [2.1 åˆ†ç‰‡ç­–ç•¥](#21-åˆ†ç‰‡ç­–ç•¥)
    - [2.2 åŠ¨æ€æ‰©å®¹](#22-åŠ¨æ€æ‰©å®¹)
  - [3. è¯»å†™åˆ†ç¦»](#3-è¯»å†™åˆ†ç¦»)
    - [3.1 ä¸»ä»æ¶æ„](#31-ä¸»ä»æ¶æ„)
  - [4. è´Ÿè½½å‡è¡¡](#4-è´Ÿè½½å‡è¡¡)
    - [4.1 æŸ¥è¯¢è·¯ç”±](#41-æŸ¥è¯¢è·¯ç”±)
  - [5. ç›‘æ§ä¸å‘Šè­¦](#5-ç›‘æ§ä¸å‘Šè­¦)
    - [5.1 æ€§èƒ½ç›‘æ§](#51-æ€§èƒ½ç›‘æ§)
  - [6. å®è·µæ¡ˆä¾‹](#6-å®è·µæ¡ˆä¾‹)
    - [6.1 åäº¿çº§å‘é‡éƒ¨ç½²](#61-åäº¿çº§å‘é‡éƒ¨ç½²)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 å¤§è§„æ¨¡éƒ¨ç½²æŒ‘æˆ˜

- **æ•°æ®é‡**: åäº¿çº§å‘é‡
- **å¹¶å‘é‡**: æ¯ç§’æ•°ä¸‡æ¬¡æŸ¥è¯¢
- **å¯ç”¨æ€§**: 99.9%+ å¯ç”¨æ€§è¦æ±‚
- **æ‰©å±•æ€§**: æ”¯æŒåŠ¨æ€æ‰©å®¹

### 1.2 ä¼˜åŒ–ç­–ç•¥

1. **æ°´å¹³æ‰©å±•**: åˆ†ç‰‡å­˜å‚¨å’ŒæŸ¥è¯¢
2. **è¯»å†™åˆ†ç¦»**: ä¸»ä»æ¶æ„åˆ†ç¦»è¯»å†™
3. **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½è·¯ç”±å’Œè´Ÿè½½åˆ†é…
4. **ç›‘æ§å‘Šè­¦**: å®æ—¶ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦

## 2. æ°´å¹³æ‰©å±•

### 2.1 åˆ†ç‰‡ç­–ç•¥

```python
# åˆ†ç‰‡ç®¡ç†
class ShardManager:
    def __init__(self, shard_configs):
        self.shards = [Shard(config) for config in shard_configs]

    async def search(self, query_vector, limit=10):
        """åœ¨æ‰€æœ‰åˆ†ç‰‡ä¸Šæœç´¢å¹¶åˆå¹¶ç»“æœ"""
        tasks = [
            shard.search(query_vector, limit * 2)
            for shard in self.shards
        ]

        results = await asyncio.gather(*tasks)
        return self._merge_results(results, limit)
```

### 2.2 åŠ¨æ€æ‰©å®¹

```python
# åŠ¨æ€æ‰©å®¹ç®¡ç†
class DynamicScaling:
    async def add_shard(self, shard_config):
        """æ·»åŠ æ–°åˆ†ç‰‡"""
        new_shard = Shard(shard_config)
        self.shards.append(new_shard)

        # é‡æ–°å¹³è¡¡æ•°æ®
        await self.rebalance()

    async def rebalance(self):
        """é‡æ–°å¹³è¡¡æ•°æ®åˆ†å¸ƒ"""
        # è¿ç§»éƒ¨åˆ†æ•°æ®åˆ°æ–°åˆ†ç‰‡
        pass
```

## 3. è¯»å†™åˆ†ç¦»

### 3.1 ä¸»ä»æ¶æ„

```python
# è¯»å†™åˆ†ç¦»
class ReadWriteSplit:
    def __init__(self):
        self.master = DatabaseConnection(master_config)
        self.replicas = [
            DatabaseConnection(replica_config)
            for replica_config in replica_configs
        ]

    async def write(self, vectors):
        """å†™å…¥ä¸»åº“"""
        return await self.master.insert(vectors)

    async def read(self, query_vector, limit=10):
        """ä»ä»åº“è¯»å–ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰"""
        replica = self._select_replica()
        return await replica.search(query_vector, limit)

    def _select_replica(self):
        """é€‰æ‹©ä»åº“ï¼ˆè½®è¯¢æˆ–åŸºäºè´Ÿè½½ï¼‰"""
        return random.choice(self.replicas)
```

## 4. è´Ÿè½½å‡è¡¡

### 4.1 æŸ¥è¯¢è·¯ç”±

```python
# æ™ºèƒ½æŸ¥è¯¢è·¯ç”±
class QueryRouter:
    def __init__(self, shard_manager):
        self.shard_manager = shard_manager

    async def route_query(self, query_vector, limit=10):
        """æ ¹æ®æŸ¥è¯¢ç‰¹å¾è·¯ç”±åˆ°åˆé€‚çš„åˆ†ç‰‡"""
        # 1. åˆ†ææŸ¥è¯¢ç‰¹å¾
        query_features = self._analyze_query(query_vector)

        # 2. é€‰æ‹©ç›®æ ‡åˆ†ç‰‡
        target_shards = self._select_shards(query_features)

        # 3. æ‰§è¡ŒæŸ¥è¯¢
        if len(target_shards) == 1:
            return await target_shards[0].search(query_vector, limit)
        else:
            return await self._multi_shard_search(target_shards, query_vector, limit)
```

## 5. ç›‘æ§ä¸å‘Šè­¦

### 5.1 æ€§èƒ½ç›‘æ§

```python
# æ€§èƒ½ç›‘æ§
class PerformanceMonitor:
    def __init__(self):
        self.metrics = {
            'query_latency': [],
            'throughput': [],
            'error_rate': []
        }

    async def record_query(self, latency, success):
        """è®°å½•æŸ¥è¯¢æŒ‡æ ‡"""
        self.metrics['query_latency'].append(latency)
        self.metrics['throughput'].append(1)
        if not success:
            self.metrics['error_rate'].append(1)

    def get_stats(self):
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        return {
            'p99_latency': self._percentile(self.metrics['query_latency'], 99),
            'qps': len(self.metrics['throughput']) / 60,
            'error_rate': len(self.metrics['error_rate']) / len(self.metrics['throughput'])
        }
```

## 6. å®è·µæ¡ˆä¾‹

### 6.1 åäº¿çº§å‘é‡éƒ¨ç½²

```python
# åäº¿çº§å‘é‡éƒ¨ç½²æ–¹æ¡ˆ
class BillionVectorDeployment:
    def __init__(self):
        # 100 ä¸ªåˆ†ç‰‡
        self.shard_manager = ShardManager([
            {'id': i, 'host': f'shard-{i}.example.com'}
            for i in range(100)
        ])

        # è¯»å†™åˆ†ç¦»
        self.read_write_split = ReadWriteSplit()

        # è´Ÿè½½å‡è¡¡
        self.query_router = QueryRouter(self.shard_manager)

        # ç›‘æ§
        self.monitor = PerformanceMonitor()

    async def search(self, query_vector, limit=10):
        """å…¨å±€æœç´¢"""
        start_time = time.time()
        try:
            result = await self.query_router.route_query(query_vector, limit)
            latency = time.time() - start_time
            await self.monitor.record_query(latency, True)
            return result
        except Exception as e:
            latency = time.time() - start_time
            await self.monitor.record_query(latency, False)
            raise
```

## 7. å‚è€ƒèµ„æ–™

- [å¤§è§„æ¨¡å‘é‡å­˜å‚¨æ–¹æ¡ˆ](../æ¶æ„è®¾è®¡/å¤§è§„æ¨¡å‘é‡å­˜å‚¨æ–¹æ¡ˆ.md)
- [å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡](../æ¶æ„è®¾è®¡/å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 01-04-03
