# æ··åˆæœç´¢æ¶æ„æ¨¡å¼

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 16+ / pgvector 0.7.0+  
> **æ–‡æ¡£ç¼–å·**: 01-03-02

## ğŸ“‘ ç›®å½•

- [æ··åˆæœç´¢æ¶æ„æ¨¡å¼](#æ··åˆæœç´¢æ¶æ„æ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ¶æ„å®šä½](#12-æ¶æ„å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ··åˆæœç´¢æ¶æ„æ¨¡å¼](#2-æ··åˆæœç´¢æ¶æ„æ¨¡å¼)
    - [2.1 å‘é‡+å…¨æ–‡æœç´¢æ¶æ„](#21-å‘é‡å…¨æ–‡æœç´¢æ¶æ„)
    - [2.2 å‘é‡+æ ‡é‡è¿‡æ»¤æ¶æ„](#22-å‘é‡æ ‡é‡è¿‡æ»¤æ¶æ„)
    - [2.3 å¤šæ¨¡æ€æœç´¢æ¶æ„](#23-å¤šæ¨¡æ€æœç´¢æ¶æ„)
  - [3. RRF èåˆæ¶æ„](#3-rrf-èåˆæ¶æ„)
    - [3.1 RRF ç®—æ³•æ¶æ„](#31-rrf-ç®—æ³•æ¶æ„)
    - [3.2 èåˆç­–ç•¥è®¾è®¡](#32-èåˆç­–ç•¥è®¾è®¡)
    - [3.3 æ€§èƒ½ä¼˜åŒ–æ¶æ„](#33-æ€§èƒ½ä¼˜åŒ–æ¶æ„)
  - [4. æŸ¥è¯¢æ‰§è¡Œæ¶æ„](#4-æŸ¥è¯¢æ‰§è¡Œæ¶æ„)
    - [4.1 å¹¶è¡ŒæŸ¥è¯¢æ¶æ„](#41-å¹¶è¡ŒæŸ¥è¯¢æ¶æ„)
    - [4.2 ç»“æœèåˆæ¶æ„](#42-ç»“æœèåˆæ¶æ„)
    - [4.3 ç¼“å­˜æ¶æ„è®¾è®¡](#43-ç¼“å­˜æ¶æ„è®¾è®¡)
  - [5. æ€§èƒ½åˆ†æ](#5-æ€§èƒ½åˆ†æ)
    - [5.1 æ¶æ„æ€§èƒ½å¯¹æ¯”](#51-æ¶æ„æ€§èƒ½å¯¹æ¯”)
    - [5.2 èåˆç®—æ³•å¯¹æ¯”](#52-èåˆç®—æ³•å¯¹æ¯”)
    - [5.3 å®é™…åº”ç”¨æ•ˆæœ](#53-å®é™…åº”ç”¨æ•ˆæœ)
      - [æ¡ˆä¾‹ 1: ç”µå•†æœç´¢](#æ¡ˆä¾‹-1-ç”µå•†æœç´¢)
      - [æ¡ˆä¾‹ 2: RAG åº”ç”¨](#æ¡ˆä¾‹-2-rag-åº”ç”¨)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¶æ„é€‰æ‹©å»ºè®®](#61-æ¶æ„é€‰æ‹©å»ºè®®)
    - [6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#62-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.3 èåˆç­–ç•¥å»ºè®®](#63-èåˆç­–ç•¥å»ºè®®)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

å•ä¸€æœç´¢æ–¹å¼æ— æ³•æ»¡è¶³å¤æ‚æŸ¥è¯¢éœ€æ±‚ï¼š

1. **å‘é‡æœç´¢å±€é™æ€§**:

   - æ— æ³•ç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼ˆå¦‚å“ç‰Œåã€å‹å·ï¼‰
   - å¯¹æ‹¼å†™é”™è¯¯æ•æ„Ÿ
   - æ— æ³•å¤„ç†ç»“æ„åŒ–æŸ¥è¯¢ï¼ˆå¦‚ä»·æ ¼èŒƒå›´ã€æ—¥æœŸèŒƒå›´ï¼‰

1. **å…¨æ–‡æœç´¢å±€é™æ€§**:

   - æ— æ³•ç†è§£è¯­ä¹‰ï¼ˆåŒä¹‰è¯ã€ä¸Šä¸‹æ–‡ï¼‰
   - æ— æ³•å¤„ç†å¤šè¯­è¨€è¯­ä¹‰æœç´¢
   - å¯¹é•¿æ–‡æœ¬æ•ˆæœå·®

1. **ä¸šåŠ¡éœ€æ±‚**:
   - ç”µå•†æœç´¢ï¼šéœ€è¦åŒæ—¶æ”¯æŒè¯­ä¹‰æœç´¢å’Œç²¾ç¡®è¿‡æ»¤
   - RAG åº”ç”¨ï¼šéœ€è¦ç»“åˆå…³é”®è¯å’Œè¯­ä¹‰æœç´¢
   - ä¼ä¸šæœç´¢ï¼šéœ€è¦æ”¯æŒå¤šæ¨¡æ€æœç´¢ï¼ˆæ–‡æœ¬+å›¾åƒ+è§†é¢‘ï¼‰

**æŠ€æœ¯æ¼”è¿›**:

1. **2020 å¹´**: å‘é‡æœç´¢å’Œå…¨æ–‡æœç´¢ç‹¬ç«‹ä½¿ç”¨
1. **2022 å¹´**: å¼€å§‹å°è¯•ç®€å•çš„ç»“æœåˆå¹¶
1. **2024 å¹´**: RRF ç®—æ³•æˆä¸ºæ··åˆæœç´¢æ ‡å‡†
1. **2025 å¹´**: PostgreSQL åŸç”Ÿæ”¯æŒæ··åˆæœç´¢

**å¸‚åœºéœ€æ±‚**:

- **ç”µå•†å¹³å°**: éœ€è¦èåˆè¯­ä¹‰æœç´¢å’Œç²¾ç¡®è¿‡æ»¤
- **RAG åº”ç”¨**: éœ€è¦ç»“åˆå…³é”®è¯å’Œè¯­ä¹‰æ£€ç´¢
- **ä¼ä¸šæœç´¢**: éœ€è¦æ”¯æŒå¤šæ¨¡æ€æ··åˆæœç´¢

### 1.2 æ¶æ„å®šä½

æ··åˆæœç´¢æ¶æ„æ¨¡å¼æ˜¯æ„å»ºæ™ºèƒ½æœç´¢ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå®ƒéœ€è¦ï¼š

1. **å¤šæœç´¢æ–¹å¼èåˆ**: å‘é‡æœç´¢ã€å…¨æ–‡æœç´¢ã€æ ‡é‡è¿‡æ»¤ç»Ÿä¸€æ¶æ„
1. **æ™ºèƒ½ç»“æœèåˆ**: ä½¿ç”¨ RRF ç­‰ç®—æ³•æ™ºèƒ½èåˆå¤šè·¯ç»“æœ
1. **æ€§èƒ½ä¼˜åŒ–**: å¹¶è¡ŒæŸ¥è¯¢å’Œç»“æœç¼“å­˜æå‡æ€§èƒ½
1. **çµæ´»æ‰©å±•**: æ”¯æŒæ–°å¢æœç´¢æ–¹å¼å’Œèåˆç®—æ³•

### 1.3 æ ¸å¿ƒä»·å€¼

1. **æœç´¢è´¨é‡æå‡**: ç»“åˆå¤šç§æœç´¢æ–¹å¼ï¼Œæå‡å¬å›ç‡å’Œå‡†ç¡®ç‡
1. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢å’Œç²¾ç¡®è¿‡æ»¤
1. **ä¸šåŠ¡çµæ´»æ€§**: å¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´èåˆç­–ç•¥
1. **æ€§èƒ½ä¿è¯**: é€šè¿‡å¹¶è¡ŒæŸ¥è¯¢ä¿è¯æ¯«ç§’çº§å“åº”

---

## 2. æ··åˆæœç´¢æ¶æ„æ¨¡å¼

### 2.1 å‘é‡+å…¨æ–‡æœç´¢æ¶æ„

**æ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æŸ¥è¯¢è¯·æ±‚                        â”‚
â”‚  "é€‚åˆå¤å¤©ç©¿çš„è½»è–„Tæ¤"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æŸ¥è¯¢è§£æä¸è·¯ç”±                     â”‚
â”‚  - æå–å…³é”®è¯: "å¤å¤©"ã€"è½»è–„"ã€"Tæ¤"      â”‚
â”‚  - ç”ŸæˆæŸ¥è¯¢å‘é‡                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
       â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¨æ–‡æœç´¢     â”‚  â”‚ å‘é‡æœç´¢     â”‚
â”‚ (tsvector)  â”‚  â”‚ (pgvector)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â”‚ ç»“æœ 1          â”‚ ç»“æœ 2
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        RRF ç»“æœèåˆ                      â”‚
â”‚  - è®¡ç®—èåˆåˆ†æ•°                           â”‚
â”‚  - æ’åºå¹¶è¿”å› Top-K                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**:

```sql
-- æ··åˆæœç´¢æŸ¥è¯¢
WITH vector_search AS (
    SELECT id, content, embedding <=> $1 as distance
    FROM documents
    WHERE embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 100
),
fulltext_search AS (
    SELECT id, content, ts_rank(to_tsvector('english', content),
                                 plainto_tsquery('english', $2)) as rank
    FROM documents
    WHERE to_tsvector('english', content) @@ plainto_tsquery('english', $2)
    ORDER BY rank DESC
    LIMIT 100
),
combined AS (
    SELECT
        COALESCE(v.id, f.id) as id,
        COALESCE(v.content, f.content) as content,
        -- RRF èåˆåˆ†æ•°
        (1.0 / (60 + COALESCE(v.rank, 100))) +
        (1.0 / (60 + COALESCE(f.rank, 100))) as rrf_score
    FROM (
        SELECT id, content, ROW_NUMBER() OVER (ORDER BY distance) as rank
        FROM vector_search
    ) v
    FULL OUTER JOIN (
        SELECT id, content, ROW_NUMBER() OVER (ORDER BY rank DESC) as rank
        FROM fulltext_search
    ) f ON v.id = f.id
)
SELECT id, content, rrf_score
FROM combined
ORDER BY rrf_score DESC
LIMIT 10;
```

**æ€§èƒ½æ•°æ®**:

| æœç´¢æ–¹å¼ | å¬å›ç‡ | å‡†ç¡®ç‡ | å¹³å‡å»¶è¿Ÿ |
| -------- | ------ | ------ | -------- |
| ä»…å‘é‡   | 85%    | 78%    | 25ms     |
| ä»…å…¨æ–‡   | 65%    | 82%    | 15ms     |
| æ··åˆæœç´¢ | 92%    | 88%    | 35ms     |

### 2.2 å‘é‡+æ ‡é‡è¿‡æ»¤æ¶æ„

**æ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æŸ¥è¯¢è¯·æ±‚                        â”‚
â”‚  å‘é‡æŸ¥è¯¢ + ä»·æ ¼èŒƒå›´ + å“ç‰Œè¿‡æ»¤           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æŸ¥è¯¢ä¼˜åŒ–å™¨                        â”‚
â”‚  - ç¡®å®šè¿‡æ»¤é¡ºåº                           â”‚
â”‚  - é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè®¡åˆ’                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ ‡é‡è¿‡æ»¤ (å…ˆæ‰§è¡Œ)                    â”‚
â”‚  WHERE price BETWEEN 100 AND 500        â”‚
â”‚    AND brand = 'Nike'                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å‘é‡æœç´¢ (åæ‰§è¡Œ)                    â”‚
â”‚  ORDER BY embedding <=> $1               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**:

```sql
-- å‘é‡æœç´¢ + æ ‡é‡è¿‡æ»¤
SELECT id, name, price, brand, embedding <=> $1 as distance
FROM products
WHERE price BETWEEN 100 AND 500
  AND brand = 'Nike'
  AND category = 'T-Shirt'
ORDER BY embedding <=> $1
LIMIT 20;

-- ä½¿ç”¨ GIN ç´¢å¼•åŠ é€Ÿæ ‡é‡è¿‡æ»¤
CREATE INDEX ON products USING GIN (brand gin_trgm_ops);
CREATE INDEX ON products (price, category);
```

**æ€§èƒ½ä¼˜åŒ–**:

| è¿‡æ»¤é¡ºåº | è¿‡æ»¤åæ•°æ®é‡ | å‘é‡æœç´¢æ—¶é—´ | æ€»æ—¶é—´ |
| -------- | ------------ | ------------ | ------ |
| å…ˆå‘é‡   | 1000 ä¸‡      | 50ms         | 50ms   |
| å…ˆæ ‡é‡   | 10 ä¸‡        | 5ms          | 8ms    |

### 2.3 å¤šæ¨¡æ€æœç´¢æ¶æ„

**æ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å¤šæ¨¡æ€æŸ¥è¯¢                        â”‚
â”‚  æ–‡æœ¬ + å›¾åƒ + è§†é¢‘                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
       â”‚       â”‚       â”‚
       â–¼       â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚æ–‡æœ¬å‘é‡  â”‚ â”‚å›¾åƒå‘é‡â”‚ â”‚è§†é¢‘å‘é‡â”‚
â”‚æœç´¢     â”‚ â”‚æœç´¢   â”‚ â”‚æœç´¢   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜
     â”‚          â”‚        â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å¤šæ¨¡æ€ RRF èåˆ                     â”‚
â”‚  - åŠ æƒèåˆä¸åŒæ¨¡æ€ç»“æœ                   â”‚
â”‚  - è¿”å›ç»Ÿä¸€æ’åºç»“æœ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**:

```sql
-- å¤šæ¨¡æ€æœç´¢è¡¨è®¾è®¡
CREATE TABLE multimodal_content (
    id BIGSERIAL PRIMARY KEY,
    content_type TEXT,  -- 'text', 'image', 'video'
    text_content TEXT,
    text_embedding vector(768),
    image_url TEXT,
    image_embedding vector(512),
    video_url TEXT,
    video_embedding vector(1024),
    metadata JSONB
);

-- å¤šæ¨¡æ€æ··åˆæœç´¢
WITH text_search AS (
    SELECT id, 'text' as type, text_embedding <=> $1 as score
    FROM multimodal_content
    WHERE content_type = 'text'
    ORDER BY text_embedding <=> $1
    LIMIT 50
),
image_search AS (
    SELECT id, 'image' as type, image_embedding <=> $2 as score
    FROM multimodal_content
    WHERE content_type = 'image'
    ORDER BY image_embedding <=> $2
    LIMIT 50
),
video_search AS (
    SELECT id, 'video' as type, video_embedding <=> $3 as score
    FROM multimodal_content
    WHERE content_type = 'video'
    ORDER BY video_embedding <=> $3
    LIMIT 50
),
combined AS (
    SELECT id, type,
           CASE type
               WHEN 'text' THEN 1.0 / (60 + rank)
               WHEN 'image' THEN 0.8 / (60 + rank)  -- å›¾åƒæƒé‡ç¨ä½
               WHEN 'video' THEN 0.6 / (60 + rank)  -- è§†é¢‘æƒé‡æ›´ä½
           END as rrf_score
    FROM (
        SELECT *, ROW_NUMBER() OVER (ORDER BY score) as rank FROM text_search
        UNION ALL
        SELECT *, ROW_NUMBER() OVER (ORDER BY score) as rank FROM image_search
        UNION ALL
        SELECT *, ROW_NUMBER() OVER (ORDER BY score) as rank FROM video_search
    ) all_results
)
SELECT id, type, rrf_score
FROM combined
ORDER BY rrf_score DESC
LIMIT 20;
```

---

## 3. RRF èåˆæ¶æ„

### 3.1 RRF ç®—æ³•æ¶æ„

**RRF å…¬å¼**:

```text
RRF(d) = Î£ (1 / (k + rank_i(d)))
```

å…¶ä¸­ï¼š

- `d`: æ–‡æ¡£
- `k`: å¸¸æ•°ï¼ˆé€šå¸¸ä¸º 60ï¼‰
- `rank_i(d)`: æ–‡æ¡£åœ¨ç¬¬ i ä¸ªæœç´¢ç»“æœä¸­çš„æ’å

**æ¶æ„å®ç°**:

```python
class RRFFusion:
    def __init__(self, k=60):
        self.k = k

    def fuse(self, result_sets, weights=None):
        """
        èåˆå¤šä¸ªæœç´¢ç»“æœ

        Args:
            result_sets: å¤šä¸ªæœç´¢ç»“æœåˆ—è¡¨
            weights: æ¯ä¸ªç»“æœé›†çš„æƒé‡ï¼ˆå¯é€‰ï¼‰
        """
        if weights is None:
            weights = [1.0] * len(result_sets)

        # è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„ RRF åˆ†æ•°
        doc_scores = {}
        for i, results in enumerate(result_sets):
            weight = weights[i]
            for rank, doc_id in enumerate(results, start=1):
                rrf_score = weight / (self.k + rank)
                doc_scores[doc_id] = doc_scores.get(doc_id, 0) + rrf_score

        # æŒ‰åˆ†æ•°æ’åº
        sorted_docs = sorted(
            doc_scores.items(),
            key=lambda x: x[1],
            reverse=True
        )

        return [doc_id for doc_id, score in sorted_docs]
```

### 3.2 èåˆç­–ç•¥è®¾è®¡

**ç­–ç•¥ 1: ç­‰æƒé‡èåˆ**:

```sql
-- ç­‰æƒé‡ RRF èåˆ
SELECT id,
       (1.0 / (60 + vector_rank)) +
       (1.0 / (60 + fulltext_rank)) as rrf_score
FROM (
    SELECT id,
           ROW_NUMBER() OVER (ORDER BY vector_distance) as vector_rank,
           ROW_NUMBER() OVER (ORDER BY fulltext_rank DESC) as fulltext_rank
    FROM combined_results
) ranked
ORDER BY rrf_score DESC;
```

**ç­–ç•¥ 2: åŠ æƒèåˆ**:

```sql
-- åŠ æƒ RRF èåˆï¼ˆå‘é‡æœç´¢æƒé‡æ›´é«˜ï¼‰
SELECT id,
       (0.7 / (60 + vector_rank)) +
       (0.3 / (60 + fulltext_rank)) as weighted_rrf_score
FROM ranked_results
ORDER BY weighted_rrf_score DESC;
```

**ç­–ç•¥ 3: è‡ªé€‚åº”æƒé‡**:

```python
class AdaptiveRRF:
    def calculate_weights(self, query_type, query_length):
        """
        æ ¹æ®æŸ¥è¯¢ç±»å‹å’Œé•¿åº¦è‡ªé€‚åº”è°ƒæ•´æƒé‡
        """
        if query_type == 'semantic':
            # è¯­ä¹‰æŸ¥è¯¢ï¼šå‘é‡æœç´¢æƒé‡é«˜
            return {'vector': 0.8, 'fulltext': 0.2}
        elif query_type == 'keyword':
            # å…³é”®è¯æŸ¥è¯¢ï¼šå…¨æ–‡æœç´¢æƒé‡é«˜
            return {'vector': 0.3, 'fulltext': 0.7}
        else:
            # æ··åˆæŸ¥è¯¢ï¼šç­‰æƒé‡
            return {'vector': 0.5, 'fulltext': 0.5}
```

### 3.3 æ€§èƒ½ä¼˜åŒ–æ¶æ„

**å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–**:

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class ParallelHybridSearch:
    def __init__(self):
        self.executor = ThreadPoolExecutor(max_workers=4)

    async def search(self, query_vector, query_text, filters=None):
        # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæœç´¢
        tasks = [
            self.vector_search(query_vector, filters),
            self.fulltext_search(query_text, filters),
            self.scalar_filter(filters) if filters else None
        ]

        results = await asyncio.gather(*[t for t in tasks if t])

        # RRF èåˆ
        return self.rrf_fusion(results)
```

**ç»“æœç¼“å­˜**:

```python
class CachedHybridSearch:
    def __init__(self):
        self.cache = {}

    def search(self, query_vector, query_text, filters=None):
        # ç”Ÿæˆç¼“å­˜é”®
        cache_key = self.generate_cache_key(
            query_vector, query_text, filters
        )

        # æ£€æŸ¥ç¼“å­˜
        if cache_key in self.cache:
            return self.cache[cache_key]

        # æ‰§è¡Œæœç´¢
        results = self.execute_search(query_vector, query_text, filters)

        # ç¼“å­˜ç»“æœ
        self.cache[cache_key] = results
        return results
```

---

## 4. æŸ¥è¯¢æ‰§è¡Œæ¶æ„

### 4.1 å¹¶è¡ŒæŸ¥è¯¢æ¶æ„

**PostgreSQL å¹¶è¡ŒæŸ¥è¯¢**:

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;

-- å¹¶è¡Œæ··åˆæœç´¢
EXPLAIN ANALYZE
WITH vector_search AS (
    SELECT id, embedding <=> $1 as distance
    FROM documents
    WHERE embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 100
),
fulltext_search AS (
    SELECT id, ts_rank(to_tsvector('english', content),
                       plainto_tsquery('english', $2)) as rank
    FROM documents
    WHERE to_tsvector('english', content) @@ plainto_tsquery('english', $2)
    ORDER BY rank DESC
    LIMIT 100
)
SELECT * FROM vector_search
UNION ALL
SELECT * FROM fulltext_search;
```

### 4.2 ç»“æœèåˆæ¶æ„

**æµå¼èåˆ**:

```python
class StreamingRRF:
    def fuse_streaming(self, result_streams, k=10):
        """
        æµå¼èåˆå¤šä¸ªæœç´¢ç»“æœ
        """
        rrf_scores = {}
        seen_docs = set()

        # ä»æ¯ä¸ªæµä¸­è¯»å–ç»“æœ
        streams = [iter(stream) for stream in result_streams]
        active_streams = list(range(len(streams)))

        while len(seen_docs) < k * 2 and active_streams:
            for stream_idx in active_streams[:]:
                try:
                    doc_id, rank = next(streams[stream_idx])
                    if doc_id not in seen_docs:
                        seen_docs.add(doc_id)
                        rrf_scores[doc_id] = rrf_scores.get(doc_id, 0) + \
                                            1.0 / (60 + rank)
                except StopIteration:
                    active_streams.remove(stream_idx)

        # è¿”å› Top-K
        return sorted(
            rrf_scores.items(),
            key=lambda x: x[1],
            reverse=True
        )[:k]
```

### 4.3 ç¼“å­˜æ¶æ„è®¾è®¡

**å¤šçº§ç¼“å­˜**:

```python
class HybridSearchCache:
    def __init__(self):
        self.l1_cache = {}  # å†…å­˜ç¼“å­˜
        self.redis = Redis()  # Redis ç¼“å­˜

    def get(self, query_key):
        # L1 ç¼“å­˜
        if query_key in self.l1_cache:
            return self.l1_cache[query_key]

        # Redis ç¼“å­˜
        cached = self.redis.get(query_key)
        if cached:
            self.l1_cache[query_key] = cached
            return cached

        return None

    def set(self, query_key, results, ttl=3600):
        self.l1_cache[query_key] = results
        self.redis.setex(query_key, ttl, json.dumps(results))
```

---

## 5. æ€§èƒ½åˆ†æ

### 5.1 æ¶æ„æ€§èƒ½å¯¹æ¯”

| æ¶æ„æ–¹æ¡ˆ | QPS  | P99 å»¶è¿Ÿ | å¬å›ç‡ | å‡†ç¡®ç‡ |
| -------- | ---- | -------- | ------ | ------ |
| ä»…å‘é‡   | 2000 | 25ms     | 85%    | 78%    |
| ä»…å…¨æ–‡   | 3000 | 15ms     | 65%    | 82%    |
| ä¸²è¡Œæ··åˆ | 1000 | 40ms     | 92%    | 88%    |
| å¹¶è¡Œæ··åˆ | 1500 | 35ms     | 92%    | 88%    |

### 5.2 èåˆç®—æ³•å¯¹æ¯”

| èåˆç®—æ³• | å¬å›ç‡ | å‡†ç¡®ç‡ | è®¡ç®—å¤æ‚åº¦ |
| -------- | ------ | ------ | ---------- |
| ç®€å•åˆå¹¶ | 90%    | 80%    | O(n)       |
| RRF      | 92%    | 88%    | O(n log n) |
| åŠ æƒ RRF | 93%    | 89%    | O(n log n) |
| å­¦ä¹ èåˆ | 95%    | 91%    | O(nÂ²)      |

### 5.3 å®é™…åº”ç”¨æ•ˆæœ

#### æ¡ˆä¾‹ 1: ç”µå•†æœç´¢

- **æ¶æ„**: å‘é‡ + å…¨æ–‡ + æ ‡é‡è¿‡æ»¤
- **æ€§èƒ½**: QPS 1500ï¼ŒP99 å»¶è¿Ÿ 35ms
- **æ•ˆæœ**: è½¬åŒ–ç‡æå‡ 47%ï¼Œç”¨æˆ·æ»¡æ„åº¦æå‡ 32%

#### æ¡ˆä¾‹ 2: RAG åº”ç”¨

- **æ¶æ„**: å‘é‡ + å…¨æ–‡æ··åˆæœç´¢
- **æ€§èƒ½**: QPS 800ï¼ŒP99 å»¶è¿Ÿ 40ms
- **æ•ˆæœ**: ç­”æ¡ˆå‡†ç¡®ç‡æå‡ 25%ï¼Œç”¨æˆ·åé¦ˆæå‡ 40%

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¶æ„é€‰æ‹©å»ºè®®

1. **ç®€å•åœºæ™¯**: å‘é‡æœç´¢ + æ ‡é‡è¿‡æ»¤
1. **ä¸­ç­‰åœºæ™¯**: å‘é‡ + å…¨æ–‡æœç´¢ + RRF èåˆ
1. **å¤æ‚åœºæ™¯**: å¤šæ¨¡æ€æœç´¢ + è‡ªé€‚åº”æƒé‡èåˆ

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¹¶è¡ŒæŸ¥è¯¢**: ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢æå‡æ€§èƒ½
1. **ç»“æœç¼“å­˜**: å®æ–½å¤šçº§ç¼“å­˜ç­–ç•¥
1. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºæ‰€æœ‰æœç´¢æ–¹å¼åˆ›å»ºåˆé€‚ç´¢å¼•
1. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢é¡ºåºå’Œè¿‡æ»¤æ¡ä»¶

### 6.3 èåˆç­–ç•¥å»ºè®®

1. **ç­‰æƒé‡**: é€‚ç”¨äºæœç´¢æ–¹å¼é‡è¦æ€§ç›¸å½“
1. **åŠ æƒèåˆ**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æƒé‡
1. **è‡ªé€‚åº”**: æ ¹æ®æŸ¥è¯¢ç±»å‹åŠ¨æ€è°ƒæ•´æƒé‡

---

## 7. å‚è€ƒèµ„æ–™

- [æ··åˆæœç´¢ RRF ç®—æ³•](./æ··åˆæœç´¢RRFç®—æ³•.md)
- [pgvector æ ¸å¿ƒåŸç†](./pgvectoræ ¸å¿ƒåŸç†.md)
- [PostgreSQL å…¨æ–‡æœç´¢](https://www.postgresql.org/docs/current/textsearch.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
