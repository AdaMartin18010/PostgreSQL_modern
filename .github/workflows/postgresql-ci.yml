name: PostgreSQL 18 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  POSTGRES_VERSION: 18
  POSTGRES_DB: testdb
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: testpass

jobs:
  lint-and-test:
    name: 代码检查和单元测试
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov psycopg2-binary

      - name: 初始化数据库
        run: |
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql \
            -h localhost \
            -U ${{ env.POSTGRES_USER }} \
            -d ${{ env.POSTGRES_DB }} \
            -f configs/init-scripts/01-create-extensions.sql

          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql \
            -h localhost \
            -U ${{ env.POSTGRES_USER }} \
            -d ${{ env.POSTGRES_DB }} \
            -f configs/init-scripts/02-create-roles.sql

      - name: 运行Python脚本测试
        run: |
          python -m pytest tests/ -v --cov=scripts
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGDATABASE: ${{ env.POSTGRES_DB }}
          PGUSER: ${{ env.POSTGRES_USER }}
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}

      - name: SQL语法检查
        run: |
          for file in $(find docs -name "*.md" -exec grep -l "```sql" {} \;); do
            echo "检查 $file"
            # 提取SQL并验证语法
          done

  performance-benchmark:
    name: 性能基准测试
    runs-on: ubuntu-latest
    needs: lint-and-test

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 安装PostgreSQL客户端
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15

      - name: 运行pgbench基准测试
        run: |
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} pgbench \
            -h localhost \
            -U ${{ env.POSTGRES_USER }} \
            -i -s 10 ${{ env.POSTGRES_DB }}

          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} pgbench \
            -h localhost \
            -U ${{ env.POSTGRES_USER }} \
            -c 10 -j 2 -t 1000 ${{ env.POSTGRES_DB }} \
            | tee benchmark_result.txt

      - name: 上传基准测试结果
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark_result.txt

  security-scan:
    name: 安全扫描
    runs-on: ubuntu-latest
    needs: lint-and-test

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 安全配置检查
        run: |
          # 检查密码强度
          if grep -r "password123\|admin123\|test123" configs/; then
            echo "发现弱密码！"
            exit 1
          fi

          # 检查SSL配置
          if ! grep -q "ssl = on" configs/postgresql-18-production.conf; then
            echo "警告: SSL未启用"
          fi

      - name: SQL注入检查
        run: |
          # 检查Python脚本中是否存在SQL注入风险
          if grep -r "execute(.*%.*)" scripts/ | grep -v "%s"; then
            echo "警告: 可能存在SQL注入风险"
          fi

  docker-build:
    name: Docker镜像构建
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan]

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 登录Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 构建测试镜像
        run: |
          docker-compose -f configs/docker-compose.yml build

      - name: 测试Docker部署
        run: |
          docker-compose -f configs/docker-compose.yml up -d
          sleep 10
          docker-compose -f configs/docker-compose.yml ps

          # 验证PostgreSQL可用
          docker-compose -f configs/docker-compose.yml exec -T postgres \
            psql -U postgres -c "SELECT version();"

      - name: 清理
        run: |
          docker-compose -f configs/docker-compose.yml down -v

  deploy-staging:
    name: 部署到测试环境
    runs-on: ubuntu-latest
    needs: [performance-benchmark, docker-build]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 部署到Staging
        run: |
          echo "部署到测试环境..."
          # 这里添加实际的部署脚本
          # 例如: kubectl apply -f k8s/staging/

  deploy-production:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: [performance-benchmark, docker-build]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 备份生产数据库
        run: |
          echo "备份生产数据库..."
          # 这里添加备份脚本

      - name: 部署到Production
        run: |
          echo "部署到生产环境..."
          # 这里添加实际的部署脚本
          # 例如: kubectl apply -f k8s/production/

      - name: 健康检查
        run: |
          echo "执行健康检查..."
          # python3 scripts/health-check-advanced.py --dbname prod

      - name: 发送通知
        if: always()
        run: |
          echo "部署完成，发送通知..."
          # 发送Slack/Email通知
