name: æœˆåº¦ç‰ˆæœ¬æ£€æŸ¥ / Monthly Version Check

on:
  schedule:
    # æ¯æœˆ1å· UTC 00:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 1 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-versions:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: è®¾ç½®æ‰§è¡Œæƒé™ / Set execute permission
        run: chmod +x tools/check_versions.sh
      
      - name: è¿è¡Œç‰ˆæœ¬æ£€æŸ¥ / Run version check
        id: version_check
        run: |
          echo "æ£€æŸ¥å¼€å§‹..."
          ./tools/check_versions.sh > version_report.txt 2>&1
          cat version_report.txt
          echo "æ£€æŸ¥å®Œæˆ"
      
      - name: è·å–GitHubæœ€æ–°ç‰ˆæœ¬ / Get latest releases
        id: get_versions
        run: |
          # pgvector
          PGVECTOR_VERSION=$(curl -s https://api.github.com/repos/pgvector/pgvector/releases/latest | jq -r '.tag_name')
          echo "pgvector_version=$PGVECTOR_VERSION" >> $GITHUB_OUTPUT
          
          # TimescaleDB
          TIMESCALEDB_VERSION=$(curl -s https://api.github.com/repos/timescale/timescaledb/releases/latest | jq -r '.tag_name')
          echo "timescaledb_version=$TIMESCALEDB_VERSION" >> $GITHUB_OUTPUT
          
          # PostGIS
          POSTGIS_VERSION=$(curl -s https://api.github.com/repos/postgis/postgis/releases/latest | jq -r '.tag_name')
          echo "postgis_version=$POSTGIS_VERSION" >> $GITHUB_OUTPUT
          
          # Citus
          CITUS_VERSION=$(curl -s https://api.github.com/repos/citusdata/citus/releases/latest | jq -r '.tag_name')
          echo "citus_version=$CITUS_VERSION" >> $GITHUB_OUTPUT
          
          echo "ç‰ˆæœ¬ä¿¡æ¯å·²æ”¶é›†"
      
      - name: åˆ›å»ºç‰ˆæœ¬æ£€æŸ¥Issue / Create version check issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            const pgvectorVersion = '${{ steps.get_versions.outputs.pgvector_version }}';
            const timescaledbVersion = '${{ steps.get_versions.outputs.timescaledb_version }}';
            const postgisVersion = '${{ steps.get_versions.outputs.postgis_version }}';
            const citusVersion = '${{ steps.get_versions.outputs.citus_version }}';
            
            const issueBody = `## ğŸ“… æ£€æŸ¥æ—¥æœŸ / Check Date
            
            **æ£€æŸ¥æ—¥æœŸ**ï¼š\${year}-\${month}-\${day}  
            **æ£€æŸ¥å‘¨æœŸ**ï¼šæœˆåº¦ï¼ˆæ¯æœˆ1å·è‡ªåŠ¨åˆ›å»ºï¼‰
            
            ---
            
            ## ğŸ” ç‰ˆæœ¬æ£€æŸ¥æ¸…å• / Version Check List
            
            ### 1. PostgreSQLæ ¸å¿ƒ
            
            - [ ] **å½“å‰è¿½è¸ªç‰ˆæœ¬**ï¼š17.0ï¼ˆ2024-09å‘å¸ƒï¼‰
            - [ ] **æœ€æ–°ç¨³å®šç‰ˆæœ¬**ï¼š___ ï¼ˆæ£€æŸ¥ https://www.postgresql.org/download/ï¼‰
            - [ ] **æ˜¯å¦éœ€è¦æ›´æ–°æ–‡æ¡£**ï¼šæ˜¯ / å¦
            - [ ] **æ›´æ–°è¯´æ˜**ï¼š
            
            ---
            
            ### 2. æ ¸å¿ƒæ‰©å±• / Core Extensions
            
            #### 2.1 pgvectorï¼ˆå‘é‡æ£€ç´¢ï¼‰
            
            - [ ] **å½“å‰è¿½è¸ªç‰ˆæœ¬**ï¼šv0.5.1
            - [ ] **æœ€æ–°ç‰ˆæœ¬**ï¼š\${pgvectorVersion}
            - [ ] **å…¼å®¹æ€§**ï¼šä¸PG17å…¼å®¹ âœ… / ä¸å…¼å®¹ âŒ
            - [ ] **æ˜¯å¦éœ€è¦æ›´æ–°**ï¼š\${pgvectorVersion === 'v0.5.1' ? 'å¦' : 'æ˜¯'}
            - [ ] **æ›´æ–°å†…å®¹**ï¼š
            
            #### 2.2 TimescaleDBï¼ˆæ—¶åºæ•°æ®ï¼‰
            
            - [ ] **å½“å‰è¿½è¸ªç‰ˆæœ¬**ï¼š2.13.0
            - [ ] **æœ€æ–°ç‰ˆæœ¬**ï¼š\${timescaledbVersion}
            - [ ] **å…¼å®¹æ€§**ï¼šä¸PG17å…¼å®¹ âœ… / ä¸å…¼å®¹ âŒ
            - [ ] **æ˜¯å¦éœ€è¦æ›´æ–°**ï¼š\${timescaledbVersion === '2.13.0' ? 'å¦' : 'æ˜¯'}
            - [ ] **æ›´æ–°å†…å®¹**ï¼š
            
            #### 2.3 PostGISï¼ˆåœ°ç†ç©ºé—´ï¼‰
            
            - [ ] **å½“å‰è¿½è¸ªç‰ˆæœ¬**ï¼š3.4.0
            - [ ] **æœ€æ–°ç‰ˆæœ¬**ï¼š\${postgisVersion}
            - [ ] **å…¼å®¹æ€§**ï¼šä¸PG17å…¼å®¹ âœ… / ä¸å…¼å®¹ âŒ
            - [ ] **æ˜¯å¦éœ€è¦æ›´æ–°**ï¼š\${postgisVersion === '3.4.0' ? 'å¦' : 'æ˜¯'}
            - [ ] **æ›´æ–°å†…å®¹**ï¼š
            
            #### 2.4 Citusï¼ˆåˆ†å¸ƒå¼ï¼‰
            
            - [ ] **å½“å‰è¿½è¸ªç‰ˆæœ¬**ï¼šv12.1
            - [ ] **æœ€æ–°ç‰ˆæœ¬**ï¼š\${citusVersion}
            - [ ] **å…¼å®¹æ€§**ï¼šä¸PG17å…¼å®¹ âœ… / ä¸å…¼å®¹ âŒ
            - [ ] **æ˜¯å¦éœ€è¦æ›´æ–°**ï¼š\${citusVersion === 'v12.1' ? 'å¦' : 'æ˜¯'}
            - [ ] **æ›´æ–°å†…å®¹**ï¼š
            
            ---
            
            ### 3. å¸¸ç”¨æ‰©å±• / Common Extensions
            
            #### 3.1 pg_stat_statements
            
            - [ ] **å†…ç½®æ‰©å±•**ï¼šéšPG17å‘å¸ƒ
            - [ ] **æ–°ç‰¹æ€§**ï¼š
            
            #### 3.2 pg_trgmï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
            
            - [ ] **å†…ç½®æ‰©å±•**ï¼šéšPG17å‘å¸ƒ
            - [ ] **æ–°ç‰¹æ€§**ï¼š
            
            #### 3.3 å…¶ä»–æ‰©å±•
            
            - [ ] **hstore**ï¼š
            - [ ] **uuid-ossp**ï¼š
            - [ ] **postgres_fdw**ï¼š
            
            ---
            
            ## ğŸ“‹ éœ€è¦æ›´æ–°çš„æ–‡ä»¶æ¸…å• / Files to Update
            
            ### æ–‡æ¡£æ›´æ–°
            
            - [ ] \\\`00_overview/README.md\\\`ï¼ˆç‰ˆæœ¬è¯´æ˜ï¼‰
            - [ ] \\\`04_modern_features/version_diff_16_to_17.md\\\`ï¼ˆè‹¥PGæ›´æ–°åˆ°17.1+ï¼‰
            - [ ] \\\`04_modern_features/pg17_new_features.md\\\`ï¼ˆæ–°ç‰¹æ€§è¡¥å……ï¼‰
            - [ ] \\\`05_ai_vector/pgvector/README.md\\\`ï¼ˆpgvectorç‰ˆæœ¬ï¼‰
            - [ ] \\\`06_timeseries/timescaledb/README.md\\\`ï¼ˆTimescaleDBç‰ˆæœ¬ï¼‰
            - [ ] \\\`07_extensions/postgis/README.md\\\`ï¼ˆPostGISç‰ˆæœ¬ï¼‰
            - [ ] \\\`07_extensions/citus/README.md\\\`ï¼ˆCitusç‰ˆæœ¬ï¼‰
            - [ ] \\\`CHANGELOG.md\\\`ï¼ˆè®°å½•ç‰ˆæœ¬æ›´æ–°ï¼‰
            
            ### ä»£ç ç¤ºä¾‹æ›´æ–°
            
            - [ ] \\\`08_ecosystem_cases/ai_vector/rag_minimal/\\\`ï¼ˆpgvector APIå˜æ›´ï¼‰
            - [ ] \\\`08_ecosystem_cases/distributed_db/citus_demo/\\\`ï¼ˆCitusé…ç½®å˜æ›´ï¼‰
            - [ ] \\\`06_timeseries/timescaledb/continuous_aggregate_example.sql\\\`ï¼ˆTimescaleDBè¯­æ³•å˜æ›´ï¼‰
            
            ---
            
            ## ğŸš¨ é‡å¤§å˜æ›´è­¦å‘Š / Breaking Changes
            
            <!-- å¦‚æœæœ‰ä¸å…¼å®¹çš„å˜æ›´ï¼Œè¯·åœ¨æ­¤è¯¦ç»†è¯´æ˜ -->
            
            ### PostgreSQLæ ¸å¿ƒ
            
            -
            
            ### æ‰©å±•ç”Ÿæ€
            
            -
            
            ---
            
            ## âœ… æ‰§è¡Œæ£€æŸ¥æ¸…å• / Execution Checklist
            
            - [ ] å·²æ£€æŸ¥æ‰€æœ‰ç‰ˆæœ¬é“¾æ¥
            - [ ] å·²éªŒè¯å…¼å®¹æ€§ï¼ˆè‹¥æœ‰æµ‹è¯•ç¯å¢ƒï¼‰
            - [ ] å·²è¯†åˆ«éœ€è¦æ›´æ–°çš„æ–‡ä»¶
            - [ ] å·²è¯„ä¼°å˜æ›´å½±å“èŒƒå›´
            - [ ] å·²åˆ›å»ºå¯¹åº”çš„æ›´æ–°Issueï¼ˆè‹¥éœ€è¦ï¼‰
            - [ ] å·²æ›´æ–°CHANGELOG.md
            
            ---
            
            ## ğŸ”— å‚è€ƒé“¾æ¥ / References
            
            - PostgreSQLå®˜æ–¹ï¼šhttps://www.postgresql.org/support/versioning/
            - pgvectorï¼šhttps://github.com/pgvector/pgvector
            - TimescaleDBï¼šhttps://docs.timescale.com/about/latest/release-notes/
            - PostGISï¼šhttps://postgis.net/news/
            - Citusï¼šhttps://www.citusdata.com/updates/
            
            ---
            
            **ç»´æŠ¤è€…**ï¼šè¯·åœ¨æ¯æœˆ1å·å¡«å†™æ­¤æ£€æŸ¥æ¸…å•  
            **è‡ªåŠ¨åŒ–**ï¼šç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º`.replace(/\${/g, '${');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[VERSION] æœˆåº¦ç‰ˆæœ¬æ£€æŸ¥ ${year}-${month}`,
              body: issueBody,
              labels: ['version-check']
            });
            
            console.log('Issueå·²åˆ›å»º');

