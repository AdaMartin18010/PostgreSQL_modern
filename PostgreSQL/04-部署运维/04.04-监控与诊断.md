# PostgreSQLç›‘æ§ä¸è¯Šæ–­å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒç›‘æ§ã€æ€§èƒ½è¯Šæ–­ã€é—®é¢˜æ’æŸ¥ã€ç³»ç»Ÿå¥åº·æ£€æŸ¥
> ğŸ†• **PostgreSQL 18ç›‘æ§å¢å¼º**
>
> PostgreSQL 18å¼•å…¥å¤šé¡¹ç›‘æ§æ”¹è¿›ï¼š
>
> - âœ… **æ–°å¢ç³»ç»Ÿè§†å›¾**: å¢å¼ºçš„pg_stat_statementsï¼Œæ–°å¢æ ‡å‡†å·®ç»Ÿè®¡
> - âœ… **æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š**: pg_stat_progress_*è§†å›¾æ›´è¯¦ç»†
> - âœ… **å…±äº«å†…å­˜ç›‘æ§**: æ–°å¢pg_shmem_allocationsè§†å›¾
> - âœ… **æ›´ç»†ç²’åº¦çš„ç­‰å¾…äº‹ä»¶**: æ›´å‡†ç¡®çš„æ€§èƒ½è¯Šæ–­

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLç›‘æ§ä¸è¯Šæ–­å®Œæ•´æŒ‡å—](#postgresqlç›‘æ§ä¸è¯Šæ–­å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ç›‘æ§ç›®æ ‡](#11-ç›‘æ§ç›®æ ‡)
    - [1.2 ç›‘æ§ä½“ç³»](#12-ç›‘æ§ä½“ç³»)
    - [1.3 è¯Šæ–­æ–¹æ³•](#13-è¯Šæ–­æ–¹æ³•)
  - [äºŒã€æŒ‡æ ‡ä½“ç³»](#äºŒæŒ‡æ ‡ä½“ç³»)
    - [2.1 å®ä¾‹çº§æŒ‡æ ‡](#21-å®ä¾‹çº§æŒ‡æ ‡)
    - [2.2 è¡¨/ç´¢å¼•çº§æŒ‡æ ‡](#22-è¡¨ç´¢å¼•çº§æŒ‡æ ‡)
    - [2.3 æŸ¥è¯¢çº§æŒ‡æ ‡](#23-æŸ¥è¯¢çº§æŒ‡æ ‡)
    - [2.4 ç³»ç»Ÿèµ„æºæŒ‡æ ‡](#24-ç³»ç»Ÿèµ„æºæŒ‡æ ‡)
  - [2. PostgreSQL 18æ–°å¢ç›‘æ§ç‰¹æ€§](#2-postgresql-18æ–°å¢ç›‘æ§ç‰¹æ€§)
    - [2.1 å¢å¼ºçš„pg\_stat\_statements](#21-å¢å¼ºçš„pg_stat_statements)
    - [2.2 å…±äº«å†…å­˜ç›‘æ§](#22-å…±äº«å†…å­˜ç›‘æ§)
    - [2.3 æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š](#23-æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š)
  - [3. å¸¸ç”¨è§†å›¾ä¸SQL](#3-å¸¸ç”¨è§†å›¾ä¸sql)
    - [3.1 æ´»è·ƒä¼šè¯ç›‘æ§](#31-æ´»è·ƒä¼šè¯ç›‘æ§)
    - [3.2 é”ä¸ç­‰å¾…](#32-é”ä¸ç­‰å¾…)
    - [3.3 è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨](#33-è¡¨æ‰«æç´¢å¼•ä½¿ç”¨)
    - [3.4 I/Oå‘½ä¸­ç‡](#34-ioå‘½ä¸­ç‡)
    - [3.5 æ…¢æŸ¥è¯¢åˆ†æ](#35-æ…¢æŸ¥è¯¢åˆ†æ)
  - [äº”ã€ç›‘æ§å®ç°](#äº”ç›‘æ§å®ç°)
    - [5.1 Prometheus + Grafana](#51-prometheus--grafana)
      - [5.1.1 postgres\_exporteréƒ¨ç½²](#511-postgres_exporteréƒ¨ç½²)
      - [5.1.2 Prometheusé…ç½®](#512-prometheusé…ç½®)
      - [5.1.3 Grafanaä»ªè¡¨ç›˜](#513-grafanaä»ªè¡¨ç›˜)
    - [5.2 ç›‘æ§å·¥å…·é€‰æ‹©](#52-ç›‘æ§å·¥å…·é€‰æ‹©)
    - [5.3 å‘Šè­¦é…ç½®](#53-å‘Šè­¦é…ç½®)
  - [å…­ã€è¯Šæ–­æµç¨‹ï¼ˆSOPï¼‰](#å…­è¯Šæ–­æµç¨‹sop)
    - [6.1 æ€§èƒ½åŠ£åŒ–è¯Šæ–­](#61-æ€§èƒ½åŠ£åŒ–è¯Šæ–­)
    - [6.2 é”ç­‰å¾…/æ­»é”è¯Šæ–­](#62-é”ç­‰å¾…æ­»é”è¯Šæ–­)
    - [6.3 è†¨èƒ€/åƒåœ¾è¯Šæ–­](#63-è†¨èƒ€åƒåœ¾è¯Šæ–­)
    - [6.4 è¿æ¥é—®é¢˜è¯Šæ–­](#64-è¿æ¥é—®é¢˜è¯Šæ–­)
  - [ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¸ƒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [7.1 ç›‘æ§å·¥å…·å¯¹æ¯”](#71-ç›‘æ§å·¥å…·å¯¹æ¯”)
    - [7.2 æŒ‡æ ‡é‡è¦æ€§å¯¹æ¯”](#72-æŒ‡æ ‡é‡è¦æ€§å¯¹æ¯”)
  - [å…«ã€å®è·µæ¡ˆä¾‹](#å…«å®è·µæ¡ˆä¾‹)
    - [8.1 æ¡ˆä¾‹1ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­](#81-æ¡ˆä¾‹1æ…¢æŸ¥è¯¢è¯Šæ–­)
    - [8.2 æ¡ˆä¾‹2ï¼šé”ç­‰å¾…è¯Šæ–­](#82-æ¡ˆä¾‹2é”ç­‰å¾…è¯Šæ–­)
    - [8.3 æ¡ˆä¾‹3ï¼šæ€§èƒ½åŠ£åŒ–è¯Šæ–­](#83-æ¡ˆä¾‹3æ€§èƒ½åŠ£åŒ–è¯Šæ–­)
  - [ä¹ã€æœ€ä½³å®è·µ](#ä¹æœ€ä½³å®è·µ)
    - [9.1 ç›‘æ§æœ€ä½³å®è·µ](#91-ç›‘æ§æœ€ä½³å®è·µ)
    - [9.2 è¯Šæ–­æœ€ä½³å®è·µ](#92-è¯Šæ–­æœ€ä½³å®è·µ)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 å®˜æ–¹æ–‡æ¡£](#101-å®˜æ–¹æ–‡æ¡£)
    - [10.2 ç›¸å…³æ–‡æ¡£](#102-ç›¸å…³æ–‡æ¡£)
  - [åä¸€ã€æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º](#åä¸€æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º)
    - [11.1 æ—¥å¿—é…ç½®](#111-æ—¥å¿—é…ç½®)
    - [11.2 æ…¢æ—¥å¿—é‡‡é›†](#112-æ…¢æ—¥å¿—é‡‡é›†)
  - [åäºŒã€å‚è€ƒæ–‡çŒ®](#åäºŒå‚è€ƒæ–‡çŒ®)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ç›‘æ§ç›®æ ‡

**ç›‘æ§çš„æ ¸å¿ƒç›®æ ‡**ï¼š

- **é¢„é˜²é—®é¢˜**ï¼šæå‰å‘ç°æ½œåœ¨é—®é¢˜
- **å¿«é€Ÿè¯Šæ–­**ï¼šå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’**ï¼šé¢„æµ‹èµ„æºéœ€æ±‚

### 1.2 ç›‘æ§ä½“ç³»

**ç›‘æ§å±‚æ¬¡**ï¼š

1. **ç³»ç»Ÿèµ„æºå±‚**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
2. **æ•°æ®åº“å®ä¾‹å±‚**ï¼šè¿æ¥ã€äº‹åŠ¡ã€ç¼“å†²ã€WAL
3. **å¯¹è±¡å±‚**ï¼šè¡¨ã€ç´¢å¼•ã€æŸ¥è¯¢
4. **åº”ç”¨å±‚**ï¼šä¸šåŠ¡æŒ‡æ ‡ã€ç”¨æˆ·ä½“éªŒ

### 1.3 è¯Šæ–­æ–¹æ³•

**è¯Šæ–­æµç¨‹**ï¼š

1. **æ”¶é›†ä¿¡æ¯**ï¼šæ”¶é›†ç›¸å…³ç›‘æ§æ•°æ®å’Œæ—¥å¿—
2. **åˆ†æé—®é¢˜**ï¼šåˆ†æé—®é¢˜ç‰¹å¾å’Œæ¨¡å¼
3. **å®šä½æ ¹å› **ï¼šå®šä½é—®é¢˜æ ¹æœ¬åŸå› 
4. **åˆ¶å®šæ–¹æ¡ˆ**ï¼šåˆ¶å®šè§£å†³æ–¹æ¡ˆ
5. **éªŒè¯æ•ˆæœ**ï¼šéªŒè¯è§£å†³æ–¹æ¡ˆæ•ˆæœ

## äºŒã€æŒ‡æ ‡ä½“ç³»

### 2.1 å®ä¾‹çº§æŒ‡æ ‡

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š

- **è¿æ¥æ•°**ï¼šå½“å‰è¿æ¥æ•°ã€æœ€å¤§è¿æ¥æ•°ã€è¿æ¥ä½¿ç”¨ç‡
- **äº‹åŠ¡**ï¼šTPSã€äº‹åŠ¡æäº¤/å›æ»šç‡
- **ç¼“å†²å‘½ä¸­ç‡**ï¼šå…±äº«ç¼“å†²åŒºå‘½ä¸­ç‡
- **WAL**ï¼šWALå†™å…¥é€Ÿç‡ã€WALå¤§å°
- **æ£€æŸ¥ç‚¹**ï¼šæ£€æŸ¥ç‚¹é¢‘ç‡ã€æ£€æŸ¥ç‚¹è€—æ—¶
- **Autovacuum**ï¼šAutovacuumè¿›ç¨‹æ•°ã€æ»åæƒ…å†µ

**ç›‘æ§SQL**ï¼š

```sql
-- å®ä¾‹çº§æ¦‚è§ˆ
SELECT
    (SELECT count(*) FROM pg_stat_activity) AS total_connections,
    (SELECT count(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max_connections,
    (SELECT xact_commit FROM pg_stat_database WHERE datname = current_database()) AS xact_commit,
    (SELECT xact_rollback FROM pg_stat_database WHERE datname = current_database()) AS xact_rollback,
    (SELECT round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2)
     FROM pg_stat_database) AS cache_hit_ratio;
```

### 2.2 è¡¨/ç´¢å¼•çº§æŒ‡æ ‡

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š

- **æ‰«æç»Ÿè®¡**ï¼šé¡ºåºæ‰«ææ¬¡æ•°ã€ç´¢å¼•æ‰«ææ¬¡æ•°
- **å…ƒç»„ç»Ÿè®¡**ï¼šæ´»å…ƒç»„æ•°ã€æ­»å…ƒç»„æ•°ã€è†¨èƒ€ç‡
- **I/Oç»Ÿè®¡**ï¼šå †å—è¯»å–ã€å †å—å‘½ä¸­ã€ç´¢å¼•å—è¯»å–ã€ç´¢å¼•å—å‘½ä¸­
- **ç»´æŠ¤ç»Ÿè®¡**ï¼šæœ€åVACUUMæ—¶é—´ã€æœ€åANALYZEæ—¶é—´

### 2.3 æŸ¥è¯¢çº§æŒ‡æ ‡

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š

- **è°ƒç”¨æ¬¡æ•°**ï¼šæŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°
- **æ‰§è¡Œæ—¶é—´**ï¼šå¹³å‡æ—¶é—´ã€æœ€å°æ—¶é—´ã€æœ€å¤§æ—¶é—´ã€æ ‡å‡†å·®
- **è¿”å›è¡Œæ•°**ï¼šå¹³å‡è¿”å›è¡Œæ•°
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šå…±äº«å—å‘½ä¸­ç‡

### 2.4 ç³»ç»Ÿèµ„æºæŒ‡æ ‡

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š

- **CPUä½¿ç”¨ç‡**ï¼šç”¨æˆ·æ€ã€å†…æ ¸æ€ã€I/Oç­‰å¾…
- **å†…å­˜ä½¿ç”¨ç‡**ï¼šæ€»å†…å­˜ã€å·²ç”¨å†…å­˜ã€ç¼“å­˜ã€äº¤æ¢
- **ç£ç›˜I/O**ï¼šè¯»å†™é€Ÿç‡ã€IOPSã€åˆ©ç”¨ç‡
- **ç½‘ç»œI/O**ï¼šå¸¦å®½ä½¿ç”¨ã€è¿æ¥æ•°

## 2. PostgreSQL 18æ–°å¢ç›‘æ§ç‰¹æ€§

### 2.1 å¢å¼ºçš„pg_stat_statements

```sql
-- PostgreSQL 18+: æ–°å¢æ ‡å‡†å·®ç»Ÿè®¡

-- åˆ›å»ºæ‰©å±•ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆå«æ ‡å‡†å·®ï¼‰
SELECT
    query,
    calls,
    mean_exec_time,
    stddev_exec_time,  -- â­ PostgreSQL 17æ–°å¢
    min_exec_time,
    max_exec_time,
    rows,
    shared_blks_hit,
    shared_blks_read,
    -- è®¡ç®—ç¨³å®šæ€§æŒ‡æ ‡
    CASE
        WHEN mean_exec_time > 0
        THEN round((stddev_exec_time / mean_exec_time * 100)::numeric, 2)
        ELSE 0
    END AS cv_percent  -- å˜å¼‚ç³»æ•°ï¼Œè¡¡é‡æŸ¥è¯¢ç¨³å®šæ€§
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;

-- è¯†åˆ«ä¸ç¨³å®šçš„æŸ¥è¯¢ï¼ˆé«˜å˜å¼‚ç³»æ•°ï¼‰
SELECT
    left(query, 60) AS query_preview,
    calls,
    round(mean_exec_time::numeric, 2) AS mean_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,
    round((stddev_exec_time / mean_exec_time * 100)::numeric, 2) AS cv_percent
FROM pg_stat_statements
WHERE calls > 100
  AND mean_exec_time > 10
  AND stddev_exec_time / mean_exec_time > 0.5  -- å˜å¼‚ç³»æ•°>50%
ORDER BY cv_percent DESC
LIMIT 10;
```

### 2.2 å…±äº«å†…å­˜ç›‘æ§

```sql
-- PostgreSQL 18+: ç›‘æ§åŠ¨æ€å…±äº«å†…å­˜ä½¿ç”¨

SELECT
    name,
    allocated_size,
    free_size,
    used_size,
    dynamic,
    pg_size_pretty(allocated_size) AS allocated,
    pg_size_pretty(free_size) AS free,
    pg_size_pretty(used_size) AS used,
    round((used_size::float / allocated_size * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
WHERE allocated_size > 0
ORDER BY allocated_size DESC
LIMIT 20;

-- åŠ¨æ€å…±äº«å†…å­˜æ€»è§ˆ
SELECT
    dynamic,
    count(*) AS segment_count,
    pg_size_pretty(sum(allocated_size)) AS total_allocated,
    pg_size_pretty(sum(used_size)) AS total_used,
    round((sum(used_size)::float / sum(allocated_size) * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
GROUP BY dynamic
ORDER BY dynamic;
```

### 2.3 æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š

```sql
-- PostgreSQL 18+: å¢å¼ºçš„VACUUMè¿›åº¦ç›‘æ§

SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples,
    -- è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
    round((heap_blks_scanned::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS scan_progress,
    round((heap_blks_vacuumed::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS vacuum_progress
FROM pg_stat_progress_vacuum
ORDER BY scan_progress DESC;

-- ANALYZEè¿›åº¦ç›‘æ§
SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    sample_blks_total,
    sample_blks_scanned,
    round((sample_blks_scanned::float / NULLIF(sample_blks_total, 0) * 100)::numeric, 2) AS progress
FROM pg_stat_progress_analyze
ORDER BY progress DESC;
```

---

## 3. å¸¸ç”¨è§†å›¾ä¸SQL

### 3.1 æ´»è·ƒä¼šè¯ç›‘æ§

```sql
-- æ´»è·ƒä¼šè¯ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    xact_start,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    state,
    backend_xid,
    backend_xmin,
    left(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state <> 'idle'
ORDER BY
    CASE state
        WHEN 'active' THEN 1
        WHEN 'idle in transaction' THEN 2
        ELSE 3
    END,
    query_start;

-- é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    now() - xact_start AS transaction_duration,
    now() - query_start AS query_duration,
    left(query, 80) AS query_preview
FROM pg_stat_activity
WHERE xact_start IS NOT NULL
  AND state NOT IN ('idle')
ORDER BY xact_start
LIMIT 20;
```

### 3.2 é”ä¸ç­‰å¾…

```sql
-- é”ä¸ç­‰å¾…
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid
FROM pg_locks
WHERE NOT granted
ORDER BY relation, pid;

-- é”ç­‰å¾…è¯¦æƒ…ï¼ˆå…³è”ä¼šè¯ä¿¡æ¯ï¼‰
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.3 è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨

```sql
-- è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    n_live_tup,
    n_dead_tup,
    round((n_dead_tup::float / NULLIF(n_live_tup, 0) * 100)::numeric, 2) AS dead_tuple_percent,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY (seq_scan + idx_scan) DESC
LIMIT 20;

-- è¯†åˆ«ç¼ºå°‘ç´¢å¼•çš„è¡¨ï¼ˆé¡ºåºæ‰«æè¿‡å¤šï¼‰
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_live_tup,
    round((seq_scan::float / NULLIF(seq_scan + idx_scan, 0) * 100)::numeric, 2) AS seq_scan_percent
FROM pg_stat_user_tables
WHERE seq_scan > 100
  AND n_live_tup > 1000
  AND seq_scan > idx_scan
ORDER BY seq_scan DESC
LIMIT 10;
```

### 3.4 I/Oå‘½ä¸­ç‡

```sql
-- I/O å‘½ä¸­ç‡
SELECT
    schemaname,
    relname,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) AS heap_hit_ratio,
    round(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) AS idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 0
ORDER BY heap_hit_ratio ASC NULLS LAST
LIMIT 20;

-- æ•´ä½“ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    round(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2) AS cache_hit_ratio
FROM pg_statio_user_tables;
```

### 3.5 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æ…¢æŸ¥è¯¢ï¼ˆéœ€ pg_stat_statementsï¼‰
SELECT
    queryid,
    left(query, 80) AS query_preview,
    calls,
    round(total_exec_time::numeric, 2) AS total_time_ms,
    round(mean_exec_time::numeric, 2) AS mean_time_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,  -- PG18+
    round(min_exec_time::numeric, 2) AS min_time_ms,
    round(max_exec_time::numeric, 2) AS max_time_ms,
    rows,
    round(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) AS cache_hit_percent
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## äº”ã€ç›‘æ§å®ç°

### 5.1 Prometheus + Grafana

#### 5.1.1 postgres_exporteréƒ¨ç½²

**åˆ›å»ºç›‘æ§ç”¨æˆ·**ï¼š

```sql
-- åˆ›å»ºç›‘æ§ä¸“ç”¨ç”¨æˆ·
CREATE ROLE metrics WITH LOGIN PASSWORD 'secure_password';
GRANT pg_monitor TO metrics;

-- å¦‚éœ€WAL/å¤åˆ¶ç»†ç²’åº¦æŒ‡æ ‡
GRANT pg_read_all_stats TO metrics;
```

**å¯åŠ¨postgres_exporter**ï¼š

```bash
# æ–¹å¼1ï¼šç¯å¢ƒå˜é‡
export DATA_SOURCE_NAME="postgresql://metrics:password@localhost:5432/postgres?sslmode=disable"
./postgres_exporter

# æ–¹å¼2ï¼šå‘½ä»¤è¡Œå‚æ•°
./postgres_exporter \
  --extend.query-path=/etc/postgres_exporter/queries.yaml \
  --web.listen-address=:9187

# æ–¹å¼3ï¼šsystemdæœåŠ¡
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
Environment="DATA_SOURCE_NAME=postgresql://metrics:password@localhost:5432/postgres?sslmode=disable"
ExecStart=/usr/local/bin/postgres_exporter
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 5.1.2 Prometheusé…ç½®

**prometheus.ymlé…ç½®**ï¼š

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgresql'
    scrape_interval: 15s
    static_configs:
      - targets:
        - 'db1:9187'
        - 'db2:9187'
        - 'db3:9187'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'
```

#### 5.1.3 Grafanaä»ªè¡¨ç›˜

**æ ¸å¿ƒé¢æ¿**ï¼š

1. **æ¦‚è§ˆé¢æ¿**ï¼š
   - è¿æ¥æ•°ã€TPS/QPS
   - ç¼“å†²å‘½ä¸­ç‡
   - WALå†™å…¥é€Ÿç‡
   - æ£€æŸ¥ç‚¹é¢‘ç‡
   - AutovacuumçŠ¶æ€
   - é”ç­‰å¾…

2. **æ˜ç»†é¢æ¿**ï¼š
   - Topè¡¨ä¸ç´¢å¼•
   - TopæŸ¥è¯¢
   - å¤åˆ¶å»¶è¿Ÿ
   - ç£ç›˜I/O
   - CPUä¸å†…å­˜

**GrafanaæŸ¥è¯¢ç¤ºä¾‹**ï¼š

```promql
# è¿æ¥æ•°
pg_stat_database_numbackends{datname="postgres"}

# TPS
rate(pg_stat_database_xact_commit[5m])

# ç¼“å†²å‘½ä¸­ç‡
sum(rate(pg_stat_database_blks_hit[5m])) /
(sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) * 100
```

### 5.2 ç›‘æ§å·¥å…·é€‰æ‹©

**å·¥å…·å¯¹æ¯”**ï¼š

| å·¥å…· | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| postgres_exporter | Exporter | è½»é‡ã€æ˜“éƒ¨ç½² | Prometheusç”Ÿæ€ |
| pg_stat_monitor | æ‰©å±• | å†…ç½®ã€è¯¦ç»† | æ·±åº¦åˆ†æ |
| pgwatch2 | å®Œæ•´æ–¹æ¡ˆ | åŠŸèƒ½å…¨é¢ | ä¼ä¸šçº§ç›‘æ§ |
| Datadog | SaaS | æ‰˜ç®¡ã€æ˜“ç”¨ | äº‘åŸç”Ÿ |

### 5.3 å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
groups:
  - name: postgresql_alerts
    rules:
      # è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"

      # ç¼“å†²å‘½ä¸­ç‡å‘Šè­¦
      - alert: PostgreSQLLowCacheHitRatio
        expr: (sum(rate(pg_stat_database_blks_hit[5m])) /
               (sum(rate(pg_stat_database_blks_hit[5m])) +
                sum(rate(pg_stat_database_blks_read[5m])))) < 0.95
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLç¼“å†²å‘½ä¸­ç‡è¿‡ä½"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 104857600  # 100MB
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
```

## å…­ã€è¯Šæ–­æµç¨‹ï¼ˆSOPï¼‰

### 6.1 æ€§èƒ½åŠ£åŒ–è¯Šæ–­

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥å®ä¾‹å‹åŠ›**ï¼šè¿æ¥æ•°ã€CPUã€I/O
2. **æ…¢æŸ¥è¯¢TopN**ï¼šä½¿ç”¨pg_stat_statements
3. **æ‰§è¡Œè®¡åˆ’åˆ†æ**ï¼šEXPLAIN ANALYZEå¯¹æ¯”ä¼°ç®—/å®é™…åŸºæ•°
4. **ç´¢å¼•/ç»Ÿè®¡ä¿®å¤**ï¼šåˆ›å»ºç´¢å¼•ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
5. **å¤æµ‹éªŒè¯**ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ

**è¯Šæ–­SQL**ï¼š

```sql
-- æ­¥éª¤1ï¼šæ£€æŸ¥ç³»ç»Ÿå‹åŠ›
SELECT
    (SELECT count(*) FROM pg_stat_activity) AS connections,
    (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_conn,
    (SELECT round(100.0 * sum(blks_hit) / NULLIF(sum(blks_hit) + sum(blks_read), 0), 2)
     FROM pg_stat_database) AS cache_hit_ratio;

-- æ­¥éª¤2ï¼šæ…¢æŸ¥è¯¢TopN
SELECT
    left(query, 100) AS query_preview,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æ­¥éª¤3ï¼šæ‰§è¡Œè®¡åˆ’åˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM orders WHERE user_id = 123;
```

### 6.2 é”ç­‰å¾…/æ­»é”è¯Šæ–­

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æŸ¥çœ‹é”ç­‰å¾…é“¾**ï¼šä½¿ç”¨pg_locks
2. **æ‰¾å‡ºæŒé”é•¿äº‹åŠ¡**ï¼šå…³è”pg_stat_activity
3. **è¯„ä¼°ä¸­æ­¢ä¸DDL/äº‹åŠ¡æ‹†åˆ†**ï¼šå†³å®šå¤„ç†æ–¹æ¡ˆ
4. **é˜²å†å‘**ï¼šç´¢å¼•ä¼˜åŒ–ã€é¡ºåºè°ƒæ•´ã€æ‰¹é‡ç­–ç•¥

**è¯Šæ–­SQL**ï¼š

```sql
-- æŸ¥çœ‹é”ç­‰å¾…é“¾
WITH lock_tree AS (
    SELECT
        blocked_locks.pid AS blocked_pid,
        blocking_locks.pid AS blocking_pid,
        blocked_activity.query AS blocked_query,
        blocking_activity.query AS blocking_query
    FROM pg_locks blocked_locks
    JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
    JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
    JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
    WHERE NOT blocked_locks.granted
      AND blocking_locks.granted
)
SELECT * FROM lock_tree;

-- æ‰¾å‡ºæŒé”é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    now() - xact_start AS transaction_duration,
    query
FROM pg_stat_activity
WHERE pid IN (SELECT blocking_pid FROM lock_tree)
ORDER BY xact_start;
```

### 6.3 è†¨èƒ€/åƒåœ¾è¯Šæ–­

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥æ­»å…ƒç»„**ï¼šæŸ¥çœ‹n_dead_tup
2. **æ£€æŸ¥autovacuumé¢‘æ¬¡**ï¼šæŸ¥çœ‹last_autovacuum
3. **æå‡autovacuumå‚æ•°**ï¼šæˆ–ç¦»å³°VACUUM FULL
4. **é•¿äº‹åŠ¡æ’æŸ¥**ï¼šæ‰¾å‡ºé˜»æ­¢VACUUMçš„é•¿äº‹åŠ¡

**è¯Šæ–­SQL**ï¼š

```sql
-- æ£€æŸ¥è¡¨è†¨èƒ€
SELECT
    schemaname,
    relname,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC
LIMIT 20;

-- æ£€æŸ¥é˜»æ­¢VACUUMçš„é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    xact_start,
    now() - xact_start AS transaction_age,
    query
FROM pg_stat_activity
WHERE xact_start IS NOT NULL
  AND now() - xact_start > interval '1 hour'
ORDER BY xact_start;
```

### 6.4 è¿æ¥é—®é¢˜è¯Šæ–­

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥è¿æ¥æ•°**ï¼šå½“å‰è¿æ¥æ•°ã€æœ€å¤§è¿æ¥æ•°
2. **æ£€æŸ¥è¿æ¥çŠ¶æ€**ï¼šæ´»è·ƒè¿æ¥ã€ç©ºé—²è¿æ¥
3. **æ£€æŸ¥è¿æ¥æ¥æº**ï¼šå®¢æˆ·ç«¯IPã€åº”ç”¨åç§°
4. **ä¼˜åŒ–è¿æ¥æ± **ï¼šä½¿ç”¨pgbouncer

**è¯Šæ–­SQL**ï¼š

```sql
-- è¿æ¥æ•°ç»Ÿè®¡
SELECT
    state,
    count(*) AS connection_count
FROM pg_stat_activity
GROUP BY state;

-- æŒ‰åº”ç”¨ç»Ÿè®¡è¿æ¥
SELECT
    application_name,
    state,
    count(*) AS connection_count
FROM pg_stat_activity
GROUP BY application_name, state
ORDER BY connection_count DESC;

-- é•¿æ—¶é—´ç©ºé—²è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    state_change,
    now() - state_change AS idle_duration
FROM pg_stat_activity
WHERE state = 'idle'
  AND now() - state_change > interval '1 hour'
ORDER BY state_change;
```

## ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 7.1 ç›‘æ§å·¥å…·å¯¹æ¯”

| å·¥å…· | éƒ¨ç½²å¤æ‚åº¦ | åŠŸèƒ½å®Œæ•´æ€§ | æ€§èƒ½å¼€é”€ | é€‚ç”¨åœºæ™¯ |
|------|-----------|-----------|---------|---------|
| postgres_exporter | ä½ | ä¸­ | ä½ | Prometheusç”Ÿæ€ |
| pg_stat_monitor | ä¸­ | é«˜ | ä¸­ | æ·±åº¦åˆ†æ |
| pgwatch2 | ä¸­ | é«˜ | ä¸­ | ä¼ä¸šçº§ç›‘æ§ |
| Datadog | ä½ | å¾ˆé«˜ | ä½ | äº‘åŸç”Ÿã€SaaS |

### 7.2 æŒ‡æ ‡é‡è¦æ€§å¯¹æ¯”

| æŒ‡æ ‡ç±»åˆ« | é‡è¦æ€§ | ç›‘æ§é¢‘ç‡ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|---------|
| è¿æ¥æ•° | é«˜ | å®æ—¶ | >80% max_connections |
| ç¼“å†²å‘½ä¸­ç‡ | é«˜ | 5åˆ†é’Ÿ | <95% |
| æ…¢æŸ¥è¯¢ | é«˜ | å®æ—¶ | >1ç§’ |
| é”ç­‰å¾… | ä¸­ | å®æ—¶ | >10ç§’ |
| å¤åˆ¶å»¶è¿Ÿ | é«˜ | 1åˆ†é’Ÿ | >100MB |
| WALå¤§å° | ä¸­ | 5åˆ†é’Ÿ | >80% max_wal_size |

## å…«ã€å®è·µæ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹1ï¼šæ…¢æŸ¥è¯¢è¯Šæ–­

**é—®é¢˜**ï¼šP99å»¶è¿Ÿä»50mså¢åŠ åˆ°500ms

**è¯Šæ–­è¿‡ç¨‹**ï¼š

1. æ£€æŸ¥pg_stat_statementsï¼Œå‘ç°ç‰¹å®šæŸ¥è¯¢å˜æ…¢
2. EXPLAIN ANALYZEæ˜¾ç¤ºé¡ºåºæ‰«æ
3. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯ï¼Œå‘ç°ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
4. æ‰§è¡ŒANALYZEæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
5. åˆ›å»ºç¼ºå¤±çš„ç´¢å¼•

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX CONCURRENTLY idx_orders_user_created
ON orders(user_id, created_at DESC);
```

### 8.2 æ¡ˆä¾‹2ï¼šé”ç­‰å¾…è¯Šæ–­

**é—®é¢˜**ï¼šå¤§é‡æŸ¥è¯¢è¢«é˜»å¡

**è¯Šæ–­è¿‡ç¨‹**ï¼š

1. æŸ¥çœ‹pg_locksï¼Œå‘ç°å¤§é‡æœªæˆäºˆçš„é”
2. æ‰¾å‡ºæŒé”çš„é•¿äº‹åŠ¡
3. å‘ç°æ˜¯DDLæ“ä½œå¯¼è‡´
4. ä¸­æ­¢é•¿äº‹åŠ¡ï¼Œä¼˜åŒ–DDLæ‰§è¡Œæ—¶é—´

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æŸ¥æ‰¾æŒé”äº‹åŠ¡
SELECT pid, query FROM pg_stat_activity
WHERE pid IN (SELECT blocking_pid FROM lock_tree);

-- ä¸­æ­¢é˜»å¡äº‹åŠ¡ï¼ˆè°¨æ…æ“ä½œï¼‰
SELECT pg_terminate_backend(blocking_pid);
```

### 8.3 æ¡ˆä¾‹3ï¼šæ€§èƒ½åŠ£åŒ–è¯Šæ–­

**é—®é¢˜**ï¼šæ•´ä½“æ€§èƒ½ä¸‹é™30%

**è¯Šæ–­è¿‡ç¨‹**ï¼š

1. æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼Œå‘ç°I/Oé¥±å’Œ
2. æ£€æŸ¥ç¼“å†²å‘½ä¸­ç‡ï¼Œå‘ç°å‘½ä¸­ç‡ä¸‹é™
3. æ£€æŸ¥è¡¨è†¨èƒ€ï¼Œå‘ç°å¤šä¸ªè¡¨è†¨èƒ€ä¸¥é‡
4. æ‰§è¡ŒVACUUMå’Œç´¢å¼•é‡å»º

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ‰§è¡ŒVACUUM
VACUUM ANALYZE large_table;

-- é‡å»ºç´¢å¼•
REINDEX TABLE CONCURRENTLY large_table;
```

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 ç›‘æ§æœ€ä½³å®è·µ

1. **åˆ†å±‚ç›‘æ§**ï¼šç³»ç»Ÿèµ„æºã€æ•°æ®åº“å®ä¾‹ã€å¯¹è±¡ã€æŸ¥è¯¢
2. **å…³é”®æŒ‡æ ‡ä¼˜å…ˆ**ï¼šé‡ç‚¹å…³æ³¨è¿æ¥æ•°ã€å‘½ä¸­ç‡ã€æ…¢æŸ¥è¯¢
3. **åˆç†å‘Šè­¦**ï¼šé¿å…å‘Šè­¦ç–²åŠ³ï¼Œè®¾ç½®åˆç†é˜ˆå€¼
4. **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸå®¡æŸ¥ç›‘æ§é…ç½®å’Œå‘Šè­¦è§„åˆ™
5. **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ç›‘æ§é…ç½®å’Œå‘Šè­¦å¤„ç†æµç¨‹

### 9.2 è¯Šæ–­æœ€ä½³å®è·µ

1. **ç³»ç»ŸåŒ–æ–¹æ³•**ï¼šéµå¾ªæ ‡å‡†è¯Šæ–­æµç¨‹
2. **æ•°æ®é©±åŠ¨**ï¼šåŸºäºç›‘æ§æ•°æ®è€ŒéçŒœæµ‹
3. **å¿«é€Ÿå®šä½**ï¼šä½¿ç”¨TopNæŸ¥è¯¢å¿«é€Ÿå®šä½é—®é¢˜
4. **éªŒè¯æ–¹æ¡ˆ**ï¼šéªŒè¯è§£å†³æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§
5. **é¢„é˜²æªæ–½**ï¼šåˆ¶å®šé¢„é˜²æªæ–½é¿å…é—®é¢˜å†æ¬¡å‘ç”Ÿ

## åã€å‚è€ƒèµ„æº

### 10.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)
- [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [PostgreSQLæ—¥å¿—é…ç½®](https://www.postgresql.org/docs/current/runtime-config-logging.html)

### 10.2 ç›¸å…³æ–‡æ¡£

- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æŸ¥è¯¢ä¼˜åŒ–
- [æ€§èƒ½è°ƒä¼˜å®è·µ](./04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½è°ƒä¼˜
- [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - ä¼˜åŒ–å™¨åŸç†

---

## åä¸€ã€æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º

### 11.1 æ—¥å¿—é…ç½®

**postgresql.confå…³é”®é…ç½®**ï¼š

```text
# æ—¥å¿—å‰ç¼€
log_line_prefix = '%m [%p] %u@%d %r %a '

# æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆç”Ÿäº§æŒ‰æµé‡ä¸å­˜å‚¨è°ƒèŠ‚ï¼‰
log_min_duration_statement = 500ms

# æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on

# Autovacuumæ—¥å¿—
log_autovacuum_min_duration = 1s

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

# I/Oæ—¶é—´è·Ÿè¸ª
track_io_timing = on

# æ‰©å±•åŠ è½½
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# auto_explainé…ç½®
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_nested_statements = on
```

### 11.2 æ…¢æ—¥å¿—é‡‡é›†

**æ—¥å¿—é‡‡é›†æµç¨‹**ï¼š

1. **æ—¥å¿—æ”¶é›†**ï¼šFilebeat/Vectoræ”¶é›†PostgreSQLæ—¥å¿—
2. **æ—¥å¿—å­˜å‚¨**ï¼šå‘é€åˆ°Loki/Elasticsearch
3. **æ—¥å¿—åˆ†æ**ï¼šåœ¨Grafanaå»ºç«‹æ…¢SQLé¢æ¿
4. **æ—¥å¿—èšåˆ**ï¼šç”Ÿæˆfingerprintä¾¿äºèšåˆç»Ÿè®¡

**æ—¥å¿—åˆ†æç¤ºä¾‹**ï¼š

```sql
-- ä»æ—¥å¿—ä¸­æå–æ…¢æŸ¥è¯¢ï¼ˆéœ€è¦æ—¥å¿—è§£æå·¥å…·ï¼‰
-- ç”Ÿæˆfingerprintï¼ˆæ­£åˆ™å½’ä¸€åŒ–ï¼‰
SELECT
    regexp_replace(query, '\d+', '?', 'g') AS fingerprint,
    count(*) AS occurrence_count,
    avg(duration) AS avg_duration
FROM slow_query_log
GROUP BY fingerprint
ORDER BY avg_duration DESC;
```

---

## åäºŒã€å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)
3. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
4. Prometheus - [postgres_exporter](https://github.com/prometheus-community/postgres_exporter)
5. Grafana - [PostgreSQL Dashboard](https://grafana.com/grafana/dashboards/)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: Data Science Team
