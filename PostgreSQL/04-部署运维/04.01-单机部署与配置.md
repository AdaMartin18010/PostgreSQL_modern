# PostgreSQLå•æœºéƒ¨ç½²ä¸é…ç½®å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­
> **åº”ç”¨åœºæ™¯**: å•æœºéƒ¨ç½²ã€å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€å°å‹ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå•æœºéƒ¨ç½²ä¸é…ç½®å®Œæ•´æŒ‡å—](#postgresqlå•æœºéƒ¨ç½²ä¸é…ç½®å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 éƒ¨ç½²ç›®æ ‡](#11-éƒ¨ç½²ç›®æ ‡)
    - [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
    - [1.3 ç‰ˆæœ¬é€‰æ‹©](#13-ç‰ˆæœ¬é€‰æ‹©)
  - [äºŒã€å®‰è£…ä¸åˆå§‹åŒ–](#äºŒå®‰è£…ä¸åˆå§‹åŒ–)
    - [2.1 Linuxç³»ç»Ÿå®‰è£…](#21-linuxç³»ç»Ÿå®‰è£…)
    - [2.2 Windowsç³»ç»Ÿå®‰è£…](#22-windowsç³»ç»Ÿå®‰è£…)
    - [2.3 macOSç³»ç»Ÿå®‰è£…](#23-macosç³»ç»Ÿå®‰è£…)
    - [2.4 æºç ç¼–è¯‘å®‰è£…](#24-æºç ç¼–è¯‘å®‰è£…)
    - [2.5 æ•°æ®åº“åˆå§‹åŒ–](#25-æ•°æ®åº“åˆå§‹åŒ–)
  - [ä¸‰ã€åŸºç¡€é…ç½®](#ä¸‰åŸºç¡€é…ç½®)
    - [3.1 postgresql.confé…ç½®](#31-postgresqlconfé…ç½®)
    - [3.2 pg\_hba.confé…ç½®](#32-pg_hbaconfé…ç½®)
    - [3.3 å†…å­˜é…ç½®](#33-å†…å­˜é…ç½®)
    - [3.4 I/Oé…ç½®](#34-ioé…ç½®)
    - [3.5 è¿æ¥é…ç½®](#35-è¿æ¥é…ç½®)
  - [å››ã€PostgreSQL 18ä¼˜åŒ–é…ç½®](#å››postgresql-18ä¼˜åŒ–é…ç½®)
    - [4.1 å¼‚æ­¥I/Oé…ç½®](#41-å¼‚æ­¥ioé…ç½®)
    - [4.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#42-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
    - [4.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#43-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
  - [äº”ã€å®‰å…¨é…ç½®](#äº”å®‰å…¨é…ç½®)
    - [5.1 è®¤è¯é…ç½®](#51-è®¤è¯é…ç½®)
    - [5.2 åŠ å¯†é…ç½®](#52-åŠ å¯†é…ç½®)
    - [5.3 å®¡è®¡é…ç½®](#53-å®¡è®¡é…ç½®)
    - [5.4 é˜²ç«å¢™é…ç½®](#54-é˜²ç«å¢™é…ç½®)
  - [å…­ã€æ€§èƒ½è°ƒä¼˜](#å…­æ€§èƒ½è°ƒä¼˜)
    - [6.1 å†…å­˜è°ƒä¼˜](#61-å†…å­˜è°ƒä¼˜)
    - [6.2 I/Oè°ƒä¼˜](#62-ioè°ƒä¼˜)
    - [6.3 æŸ¥è¯¢ä¼˜åŒ–](#63-æŸ¥è¯¢ä¼˜åŒ–)
  - [ä¸ƒã€ç›‘æ§ä¸ç»´æŠ¤](#ä¸ƒç›‘æ§ä¸ç»´æŠ¤)
    - [7.1 ç›‘æ§é…ç½®](#71-ç›‘æ§é…ç½®)
    - [7.2 æ—¥å¿—é…ç½®](#72-æ—¥å¿—é…ç½®)
    - [7.3 ç»´æŠ¤ä»»åŠ¡](#73-ç»´æŠ¤ä»»åŠ¡)
  - [å…«ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#å…«çŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [8.1 æ“ä½œç³»ç»Ÿå¯¹æ¯”](#81-æ“ä½œç³»ç»Ÿå¯¹æ¯”)
    - [8.2 å®‰è£…æ–¹å¼å¯¹æ¯”](#82-å®‰è£…æ–¹å¼å¯¹æ¯”)
    - [8.3 é…ç½®æ–¹æ¡ˆå¯¹æ¯”](#83-é…ç½®æ–¹æ¡ˆå¯¹æ¯”)
  - [ä¹ã€å®è·µæ¡ˆä¾‹](#ä¹å®è·µæ¡ˆä¾‹)
    - [9.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²](#91-å¼€å‘ç¯å¢ƒéƒ¨ç½²)
    - [9.2 æµ‹è¯•ç¯å¢ƒéƒ¨ç½²](#92-æµ‹è¯•ç¯å¢ƒéƒ¨ç½²)
    - [9.3 å°å‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#93-å°å‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
  - [åã€æ•…éšœæ’æŸ¥](#åæ•…éšœæ’æŸ¥)
    - [10.1 å¸¸è§é—®é¢˜](#101-å¸¸è§é—®é¢˜)
    - [10.2 è¯Šæ–­æ–¹æ³•](#102-è¯Šæ–­æ–¹æ³•)
    - [10.3 è§£å†³æ–¹æ¡ˆ](#103-è§£å†³æ–¹æ¡ˆ)
  - [åä¸€ã€æœ€ä½³å®è·µ](#åä¸€æœ€ä½³å®è·µ)
    - [11.1 éƒ¨ç½²æœ€ä½³å®è·µ](#111-éƒ¨ç½²æœ€ä½³å®è·µ)
    - [11.2 ç»´æŠ¤æœ€ä½³å®è·µ](#112-ç»´æŠ¤æœ€ä½³å®è·µ)
  - [åäºŒã€å‚è€ƒèµ„æº](#åäºŒå‚è€ƒèµ„æº)
    - [12.1 å®˜æ–¹æ–‡æ¡£](#121-å®˜æ–¹æ–‡æ¡£)
    - [12.2 ç½‘ç»œèµ„æº](#122-ç½‘ç»œèµ„æº)
    - [12.3 ç›¸å…³æ–‡æ¡£](#123-ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 éƒ¨ç½²ç›®æ ‡

PostgreSQLå•æœºéƒ¨ç½²ä¸é…ç½®æŒ‡å—æ—¨åœ¨æä¾›å®Œæ•´çš„å•æœºPostgreSQLéƒ¨ç½²ã€é…ç½®å’Œä¼˜åŒ–æ–¹æ¡ˆï¼Œé€‚ç”¨äºå¼€å‘ã€æµ‹è¯•å’Œå°å‹ç”Ÿäº§ç¯å¢ƒã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š

- **å¿«é€Ÿéƒ¨ç½²**ï¼šæä¾›å¿«é€Ÿéƒ¨ç½²æ–¹æ¡ˆ
- **å®‰å…¨é…ç½®**ï¼šç¡®ä¿æ•°æ®åº“å®‰å…¨
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
- **æ˜“äºç»´æŠ¤**ï¼šç®€åŒ–è¿ç»´ç®¡ç†

### 1.2 é€‚ç”¨åœºæ™¯

**å•æœºéƒ¨ç½²é€‚ç”¨åœºæ™¯**ï¼š

- **å¼€å‘ç¯å¢ƒ**ï¼šæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
- **æµ‹è¯•ç¯å¢ƒ**ï¼šåŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
- **å°å‹ç”Ÿäº§ç¯å¢ƒ**ï¼šä½æµé‡ã€å°è§„æ¨¡åº”ç”¨
- **å­¦ä¹ ç¯å¢ƒ**ï¼šå­¦ä¹ å’Œå®éªŒ

**ä¸é€‚ç”¨åœºæ™¯**ï¼š

- é«˜å¯ç”¨éœ€æ±‚çš„ç”Ÿäº§ç¯å¢ƒ
- å¤§è§„æ¨¡å¹¶å‘è®¿é—®
- éœ€è¦æ°´å¹³æ‰©å±•çš„åœºæ™¯

### 1.3 ç‰ˆæœ¬é€‰æ‹©

- **PostgreSQL 18.x**ï¼šæ¨èï¼Œæœ€æ–°ç‰¹æ€§
- **PostgreSQL 17.x**ï¼šæ¨èï¼Œç¨³å®šç‰ˆæœ¬
- **PostgreSQL 16.x**ï¼šå…¼å®¹ï¼Œé•¿æœŸæ”¯æŒ

---

## äºŒã€å®‰è£…ä¸åˆå§‹åŒ–

### 2.1 Linuxç³»ç»Ÿå®‰è£…

**Ubuntu/Debianç³»ç»Ÿ**ï¼š

```bash
# æ·»åŠ PostgreSQLå®˜æ–¹APTä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# å®‰è£…PostgreSQL 18
sudo apt-get install postgresql-18 postgresql-client-18

# å®‰è£…å¸¸ç”¨æ‰©å±•
sudo apt-get install postgresql-contrib-18

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql
```

**CentOS/RHELç³»ç»Ÿ**ï¼š

```bash
# å®‰è£…PostgreSQLå®˜æ–¹YUMä»“åº“
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL 18
sudo yum install -y postgresql18-server postgresql18

# åˆå§‹åŒ–æ•°æ®åº“
sudo /usr/pgsql-18/bin/postgresql-18-setup initdb

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql-18
```

**éªŒè¯å®‰è£…**ï¼š

```bash
# æ£€æŸ¥PostgreSQLç‰ˆæœ¬
psql --version

# è¿æ¥åˆ°æ•°æ®åº“
sudo -u postgres psql

# åœ¨psqlä¸­æ£€æŸ¥ç‰ˆæœ¬
SELECT version();
```

### 2.2 Windowsç³»ç»Ÿå®‰è£…

**ä½¿ç”¨å®‰è£…ç¨‹åº**ï¼š

1. ä¸‹è½½PostgreSQL Windowså®‰è£…ç¨‹åº
   - è®¿é—®ï¼š<https://www.postgresql.org/download/windows/>
   - ä¸‹è½½PostgreSQL 18å®‰è£…ç¨‹åº

2. è¿è¡Œå®‰è£…ç¨‹åº
   - é€‰æ‹©å®‰è£…è·¯å¾„ï¼ˆé»˜è®¤ï¼š`C:\Program Files\PostgreSQL\18`ï¼‰
   - é€‰æ‹©æ•°æ®ç›®å½•ï¼ˆé»˜è®¤ï¼š`C:\Program Files\PostgreSQL\18\data`ï¼‰
   - è®¾ç½®è¶…çº§ç”¨æˆ·å¯†ç 
   - é€‰æ‹©ç«¯å£ï¼ˆé»˜è®¤ï¼š5432ï¼‰
   - é€‰æ‹©åŒºåŸŸè®¾ç½®

3. å®‰è£…å®Œæˆåçš„é…ç½®
   - å®‰è£…ç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºWindowsæœåŠ¡
   - å¯ä»¥é€šè¿‡æœåŠ¡ç®¡ç†å™¨å¯åŠ¨/åœæ­¢PostgreSQL

**ä½¿ç”¨åŒ…ç®¡ç†å™¨ï¼ˆChocolateyï¼‰**ï¼š

```powershell
# å®‰è£…Chocolateyï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# å®‰è£…PostgreSQL
choco install postgresql18

# å¯åŠ¨æœåŠ¡
net start postgresql-x64-18
```

### 2.3 macOSç³»ç»Ÿå®‰è£…

**ä½¿ç”¨Homebrew**ï¼š

```bash
# å®‰è£…Homebrewï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# å®‰è£…PostgreSQL
brew install postgresql@18

# å¯åŠ¨æœåŠ¡
brew services start postgresql@18

# åˆ›å»ºæ•°æ®åº“é›†ç¾¤
initdb /usr/local/var/postgresql@18
```

**ä½¿ç”¨Postgres.app**ï¼š

1. ä¸‹è½½Postgres.appï¼š<https://postgresapp.com/>
2. æ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
3. å¯åŠ¨åº”ç”¨ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“é›†ç¾¤

### 2.4 æºç ç¼–è¯‘å®‰è£…

**ç¼–è¯‘å®‰è£…æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£…ä¾èµ–
# Ubuntu/Debian
sudo apt-get install build-essential libreadline-dev zlib1g-dev flex bison libxml2-dev libxslt-dev libssl-dev

# CentOS/RHEL
sudo yum install gcc make readline-devel zlib-devel flex bison libxml2-devel libxslt-devel openssl-devel

# 2. ä¸‹è½½æºç 
wget https://ftp.postgresql.org/pub/source/v18.0/postgresql-18.0.tar.gz
tar -xzf postgresql-18.0.tar.gz
cd postgresql-18.0

# 3. é…ç½®ç¼–è¯‘é€‰é¡¹
./configure --prefix=/usr/local/pgsql \
            --with-pgport=5432 \
            --with-openssl \
            --with-libxml \
            --with-libxslt \
            --enable-nls \
            --enable-thread-safety

# 4. ç¼–è¯‘
make -j$(nproc)

# 5. å®‰è£…
sudo make install

# 6. åˆ›å»ºç”¨æˆ·å’Œç›®å½•
sudo adduser postgres
sudo mkdir -p /usr/local/pgsql/data
sudo chown postgres:postgres /usr/local/pgsql/data

# 7. åˆå§‹åŒ–æ•°æ®åº“
sudo -u postgres /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
```

### 2.5 æ•°æ®åº“åˆå§‹åŒ–

**åˆå§‹åŒ–æ•°æ®åº“é›†ç¾¤**ï¼š

```bash
# ä½¿ç”¨initdbåˆå§‹åŒ–
initdb -D /var/lib/postgresql/data \
       --locale=zh_CN.UTF-8 \
       --encoding=UTF8 \
       --data-checksums

# å‚æ•°è¯´æ˜ï¼š
# -D: æ•°æ®ç›®å½•
# --locale: åŒºåŸŸè®¾ç½®
# --encoding: å­—ç¬¦ç¼–ç 
# --data-checksums: å¯ç”¨æ•°æ®æ ¡éªŒå’Œï¼ˆPostgreSQL 9.3+ï¼‰
```

**åˆå§‹åŒ–åçš„ç›®å½•ç»“æ„**ï¼š

```text
data/
â”œâ”€â”€ PG_VERSION          # PostgreSQLç‰ˆæœ¬å·
â”œâ”€â”€ pg_hba.conf         # å®¢æˆ·ç«¯è®¤è¯é…ç½®
â”œâ”€â”€ pg_ident.conf       # ç”¨æˆ·åæ˜ å°„é…ç½®
â”œâ”€â”€ postgresql.conf     # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ postgresql.auto.conf # è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
â”œâ”€â”€ base/               # æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ global/             # å…¨å±€ç³»ç»Ÿè¡¨
â”œâ”€â”€ pg_wal/             # WALæ—¥å¿—æ–‡ä»¶
â””â”€â”€ pg_tblspc/          # è¡¨ç©ºé—´é“¾æ¥
```

**å¯åŠ¨æ•°æ®åº“**ï¼š

```bash
# ä½¿ç”¨pg_ctlå¯åŠ¨
pg_ctl -D /var/lib/postgresql/data -l logfile start

# ä½¿ç”¨systemdå¯åŠ¨ï¼ˆLinuxï¼‰
sudo systemctl start postgresql

# ä½¿ç”¨æœåŠ¡ç®¡ç†å™¨å¯åŠ¨ï¼ˆWindowsï¼‰
net start postgresql-x64-18
```

---

## ä¸‰ã€åŸºç¡€é…ç½®

### 3.1 postgresql.confé…ç½®

**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š

- Linux: `/etc/postgresql/18/main/postgresql.conf` æˆ– `$PGDATA/postgresql.conf`
- Windows: `C:\Program Files\PostgreSQL\18\data\postgresql.conf`
- macOS: `/usr/local/var/postgresql@18/postgresql.conf`

**åŸºç¡€é…ç½®å‚æ•°**ï¼š

```conf
# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = 'localhost'          # ç›‘å¬åœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒæ”¹ä¸º'*'æˆ–å…·ä½“IPï¼‰
port = 5432                             # ç›‘å¬ç«¯å£
max_connections = 100                   # æœ€å¤§è¿æ¥æ•°

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 256MB                  # å…±äº«ç¼“å†²åŒºï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„25%ï¼‰
effective_cache_size = 1GB              # æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%ï¼‰
work_mem = 4MB                          # å·¥ä½œå†…å­˜ï¼ˆæ¯ä¸ªæ“ä½œï¼‰
maintenance_work_mem = 64MB             # ç»´æŠ¤å·¥ä½œå†…å­˜

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica                     # WALçº§åˆ«ï¼ˆreplica/logicalï¼‰
max_wal_size = 1GB                      # æœ€å¤§WALå¤§å°
min_wal_size = 80MB                     # æœ€å°WALå¤§å°
checkpoint_timeout = 5min               # æ£€æŸ¥ç‚¹è¶…æ—¶
checkpoint_completion_target = 0.9      # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
random_page_cost = 4.0                  # éšæœºé¡µé¢ä»£ä»·ï¼ˆSSDå»ºè®®1.1-1.5ï¼‰
effective_io_concurrency = 1            # æœ‰æ•ˆIOå¹¶å‘æ•°ï¼ˆSSDå»ºè®®200+ï¼‰
default_statistics_target = 100         # é»˜è®¤ç»Ÿè®¡ç›®æ ‡

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on                  # å¯ç”¨æ—¥å¿—æ”¶é›†
log_directory = 'log'                   # æ—¥å¿—ç›®å½•
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                   # æ—¥å¿—è½®è½¬å¹´é¾„
log_rotation_size = 100MB               # æ—¥å¿—è½®è½¬å¤§å°
log_min_duration_statement = 1000       # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢ï¼ˆæ¯«ç§’ï¼‰
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================
# è‡ªåŠ¨ç»´æŠ¤
# ============================================
autovacuum = on                         # å¯ç”¨è‡ªåŠ¨VACUUM
autovacuum_max_workers = 3              # è‡ªåŠ¨VACUUMæœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
```

**åº”ç”¨é…ç½®**ï¼š

```bash
# é‡æ–°åŠ è½½é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
sudo systemctl reload postgresql

# æˆ–åœ¨psqlä¸­æ‰§è¡Œ
SELECT pg_reload_conf();

# æŸ¥çœ‹å½“å‰é…ç½®
SHOW all;
SHOW shared_buffers;
```

### 3.2 pg_hba.confé…ç½®

**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š

- Linux: `/etc/postgresql/18/main/pg_hba.conf` æˆ– `$PGDATA/pg_hba.conf`
- Windows: `C:\Program Files\PostgreSQL\18\data\pg_hba.conf`

**é…ç½®æ ¼å¼**ï¼š

```text
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             postgres                                peer
local   all             all                                     md5

# IPv4æœ¬åœ°è¿æ¥
host    all             all             127.0.0.1/32            md5

# IPv6æœ¬åœ°è¿æ¥
host    all             all             ::1/128                 md5

# å…è®¸ç‰¹å®šIPè¿æ¥
host    all             all             192.168.1.0/24          md5

# SSLè¿æ¥
hostssl all             all             0.0.0.0/0               md5
```

**è®¤è¯æ–¹æ³•**ï¼š

- **trust**ï¼šæ— æ¡ä»¶å…è®¸è¿æ¥ï¼ˆä¸å®‰å…¨ï¼Œä»…ç”¨äºæœ¬åœ°ï¼‰
- **md5**ï¼šä½¿ç”¨MD5åŠ å¯†å¯†ç 
- **scram-sha-256**ï¼šä½¿ç”¨SCRAM-SHA-256åŠ å¯†ï¼ˆæ¨èï¼‰
- **peer**ï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿç”¨æˆ·åè®¤è¯ï¼ˆä»…æœ¬åœ°ï¼‰
- **cert**ï¼šä½¿ç”¨SSLè¯ä¹¦è®¤è¯

**å®‰å…¨é…ç½®ç¤ºä¾‹**ï¼š

```text
# æœ¬åœ°è¿æ¥ä½¿ç”¨peerè®¤è¯
local   all             postgres                                peer
local   all             all                                     scram-sha-256

# è¿œç¨‹è¿æ¥ä½¿ç”¨SCRAM-SHA-256
host    all             all             0.0.0.0/0               scram-sha-256

# ç‰¹å®šæ•°æ®åº“å’Œç”¨æˆ·
host    mydb            myuser           192.168.1.0/24          scram-sha-256
```

### 3.3 å†…å­˜é…ç½®

**å†…å­˜é…ç½®åŸåˆ™**ï¼š

```conf
# å…±äº«ç¼“å†²åŒºï¼ˆshared_buffersï¼‰
# å»ºè®®å€¼ï¼šç³»ç»Ÿå†…å­˜çš„25%
# æœ€å°ï¼š128MBï¼Œæœ€å¤§ï¼šç³»ç»Ÿå†…å­˜çš„40%
shared_buffers = 256MB                  # 1GBå†…å­˜ç³»ç»Ÿ
shared_buffers = 2GB                    # 8GBå†…å­˜ç³»ç»Ÿ
shared_buffers = 8GB                    # 32GBå†…å­˜ç³»ç»Ÿ

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆeffective_cache_sizeï¼‰
# å»ºè®®å€¼ï¼šç³»ç»Ÿå†…å­˜çš„50-75%
effective_cache_size = 1GB              # 1GBå†…å­˜ç³»ç»Ÿ
effective_cache_size = 6GB              # 8GBå†…å­˜ç³»ç»Ÿ
effective_cache_size = 24GB             # 32GBå†…å­˜ç³»ç»Ÿ

# å·¥ä½œå†…å­˜ï¼ˆwork_memï¼‰
# å»ºè®®å€¼ï¼šshared_buffers / (max_connections * 2)
# æ³¨æ„ï¼šæ¯ä¸ªæ“ä½œå¯èƒ½ä½¿ç”¨å¤šä¸ªwork_mem
work_mem = 4MB                          # 100è¿æ¥
work_mem = 16MB                         # 200è¿æ¥

# ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆmaintenance_work_memï¼‰
# å»ºè®®å€¼ï¼šç³»ç»Ÿå†…å­˜çš„5-10%
maintenance_work_mem = 64MB             # 1GBå†…å­˜ç³»ç»Ÿ
maintenance_work_mem = 512MB            # 8GBå†…å­˜ç³»ç»Ÿ
maintenance_work_mem = 2GB              # 32GBå†…å­˜ç³»ç»Ÿ
```

**å†…å­˜é…ç½®è®¡ç®—**ï¼š

```sql
-- æŸ¥çœ‹ç³»ç»Ÿå†…å­˜
SELECT setting::bigint / 1024 / 1024 AS shared_buffers_mb
FROM pg_settings WHERE name = 'shared_buffers';

-- è®¡ç®—work_memå»ºè®®å€¼
SELECT
    (SELECT setting::bigint FROM pg_settings WHERE name = 'shared_buffers')::bigint /
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections')::int / 2
    AS recommended_work_mem_bytes;
```

### 3.4 I/Oé…ç½®

**I/Oé…ç½®å‚æ•°**ï¼š

```conf
# éšæœºé¡µé¢ä»£ä»·ï¼ˆrandom_page_costï¼‰
# HDD: 4.0ï¼ˆé»˜è®¤ï¼‰
# SSD: 1.1-1.5
# NVMe: 1.0-1.1
random_page_cost = 4.0                  # HDD
random_page_cost = 1.1                  # SSD

# æœ‰æ•ˆIOå¹¶å‘æ•°ï¼ˆeffective_io_concurrencyï¼‰
# HDD: 1-2
# SSD: 200-300
# NVMe: 300+
effective_io_concurrency = 1            # HDD
effective_io_concurrency = 200          # SSD

# é¡ºåºé¡µé¢ä»£ä»·ï¼ˆseq_page_costï¼‰
# é€šå¸¸ä¿æŒé»˜è®¤å€¼1.0
seq_page_cost = 1.0
```

**æ£€æŸ¥å­˜å‚¨ç±»å‹**ï¼š

```bash
# Linux: æ£€æŸ¥ç£ç›˜ç±»å‹
lsblk -d -o name,rota

# rota=1: æœºæ¢°ç¡¬ç›˜ï¼ˆHDDï¼‰
# rota=0: å›ºæ€ç¡¬ç›˜ï¼ˆSSD/NVMeï¼‰

# æ£€æŸ¥IOè°ƒåº¦å™¨
cat /sys/block/sda/queue/scheduler
```

### 3.5 è¿æ¥é…ç½®

**è¿æ¥ç›¸å…³é…ç½®**ï¼š

```conf
# æœ€å¤§è¿æ¥æ•°
max_connections = 100                   # å¼€å‘/æµ‹è¯•ç¯å¢ƒ
max_connections = 200                   # å°å‹ç”Ÿäº§ç¯å¢ƒ

# è¿æ¥è¶…æ—¶
connect_timeout = 10                    # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
tcp_keepalives_idle = 600               # TCP keepaliveç©ºé—²æ—¶é—´ï¼ˆç§’ï¼‰
tcp_keepalives_interval = 30            # TCP keepaliveé—´éš”ï¼ˆç§’ï¼‰
tcp_keepalives_count = 3                # TCP keepaliveè®¡æ•°

# è¯­å¥è¶…æ—¶
statement_timeout = 0                   # è¯­å¥è¶…æ—¶ï¼ˆ0=æ— é™åˆ¶ï¼Œæ¯«ç§’ï¼‰
lock_timeout = 0                        # é”ç­‰å¾…è¶…æ—¶ï¼ˆ0=æ— é™åˆ¶ï¼Œæ¯«ç§’ï¼‰
idle_in_transaction_session_timeout = 0 # ç©ºé—²äº‹åŠ¡è¶…æ—¶ï¼ˆ0=æ— é™åˆ¶ï¼Œæ¯«ç§’ï¼‰
```

**è¿æ¥æ± é…ç½®**ï¼š

```conf
# ä½¿ç”¨pgBouncerè¿æ¥æ± æ—¶ï¼ŒPostgreSQLçš„max_connectionså¯ä»¥è®¾ç½®è¾ƒå°
max_connections = 50                    # ä½¿ç”¨è¿æ¥æ± æ—¶

# è¿æ¥æ± é…ç½®ï¼ˆpgBouncerï¼‰
# pool_mode = transaction
# max_client_conn = 1000
# default_pool_size = 25
```

---

## å››ã€PostgreSQL 18ä¼˜åŒ–é…ç½®

### 4.1 å¼‚æ­¥I/Oé…ç½®

**å¯ç”¨å¼‚æ­¥I/O**ï¼š

```conf
# PostgreSQL 18: å¼‚æ­¥I/Oé…ç½®
# éœ€è¦ç³»ç»Ÿæ”¯æŒio_uringï¼ˆLinux 5.1+ï¼‰
io_uring = on                           # å¯ç”¨io_uringï¼ˆå¦‚æœæ”¯æŒï¼‰
max_io_concurrency = 10                 # å¼‚æ­¥I/Oå¹¶å‘æ•°

# æ£€æŸ¥ç³»ç»Ÿæ”¯æŒ
# Linux: æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
uname -r                                # éœ€è¦5.1+

# æ£€æŸ¥io_uringæ”¯æŒ
grep io_uring /proc/filesystems
```

**æ€§èƒ½æå‡**ï¼š

- å‘é‡æ£€ç´¢I/Oæ€§èƒ½æå‡2-3å€
- å¤§æ–‡ä»¶å†™å…¥æ€§èƒ½æå‡
- å‡å°‘I/Oç­‰å¾…æ—¶é—´

### 4.2 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

**ä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—**ï¼š

```sql
-- PostgreSQL 18: è™šæ‹Ÿç”Ÿæˆåˆ—ç¤ºä¾‹
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price NUMERIC(10,2),
    discount NUMERIC(5,2),
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æœ€ç»ˆä»·æ ¼
    final_price NUMERIC(10,2) GENERATED ALWAYS AS (
        price * (1 - discount / 100)
    ) STORED
);

-- å¯ä»¥ç´¢å¼•è™šæ‹Ÿç”Ÿæˆåˆ—
CREATE INDEX idx_products_final_price ON products(final_price);
```

### 4.3 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```conf
# å¹¶è¡ŒæŸ¥è¯¢è®¾ç½®
max_parallel_workers_per_gather = 2     # æ¯ä¸ªGatherèŠ‚ç‚¹çš„æœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹
max_parallel_workers = 8                # ç³»ç»Ÿæœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
max_worker_processes = 8                # æœ€å¤§åå°å·¥ä½œè¿›ç¨‹æ•°

# å¹¶è¡ŒæŸ¥è¯¢é˜ˆå€¼
min_parallel_table_scan_size = 8MB      # æœ€å°å¹¶è¡Œè¡¨æ‰«æå¤§å°
min_parallel_index_scan_size = 512KB    # æœ€å°å¹¶è¡Œç´¢å¼•æ‰«æå¤§å°
parallel_setup_cost = 1000.0            # å¹¶è¡Œè®¾ç½®ä»£ä»·
parallel_tuple_cost = 0.1               # å¹¶è¡Œå…ƒç»„ä»£ä»·
```

---

## äº”ã€å®‰å…¨é…ç½®

### 5.1 è®¤è¯é…ç½®

**ä¿®æ”¹é»˜è®¤å¯†ç **ï¼š

```sql
-- ä¿®æ”¹postgresç”¨æˆ·å¯†ç 
ALTER USER postgres PASSWORD 'strong_password_here';

-- åˆ›å»ºæ–°ç”¨æˆ·
CREATE USER myuser WITH PASSWORD 'user_password';

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE mydb OWNER myuser;

-- æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;
```

**ä½¿ç”¨SCRAM-SHA-256è®¤è¯**ï¼š

```conf
# pg_hba.conf
host    all             all             0.0.0.0/0               scram-sha-256

# é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

### 5.2 åŠ å¯†é…ç½®

**å¯ç”¨SSL/TLS**ï¼š

```conf
# postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'                  # å¯é€‰ï¼šCAè¯ä¹¦

# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
openssl req -new -x509 -days 365 -nodes -text -out server.crt \
  -keyout server.key -subj "/CN=db.example.com"
```

**æ•°æ®åŠ å¯†**ï¼š

```sql
-- ä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•æ„Ÿæ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†æ•°æ®
INSERT INTO users (email, password_hash)
VALUES (
    'user@example.com',
    crypt('password', gen_salt('bf'))
);

-- éªŒè¯å¯†ç 
SELECT * FROM users
WHERE email = 'user@example.com'
  AND password_hash = crypt('password', password_hash);
```

### 5.3 å®¡è®¡é…ç½®

**å¯ç”¨å®¡è®¡æ—¥å¿—**ï¼š

```conf
# postgresql.conf
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_statement = 'all'                   # è®°å½•æ‰€æœ‰SQLè¯­å¥
# log_statement = 'ddl'                 # åªè®°å½•DDLè¯­å¥
# log_statement = 'mod'                 # è®°å½•DDLå’ŒDMLè¯­å¥
log_min_duration_statement = 1000       # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_connections = on                    # è®°å½•è¿æ¥
log_disconnections = on                 # è®°å½•æ–­å¼€è¿æ¥
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
```

**ä½¿ç”¨pgAuditæ‰©å±•**ï¼š

```sql
-- å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- é…ç½®å®¡è®¡
ALTER SYSTEM SET pgaudit.log = 'read,write,ddl';
ALTER SYSTEM SET pgaudit.log_catalog = off;
SELECT pg_reload_conf();
```

### 5.4 é˜²ç«å¢™é…ç½®

**Linuxé˜²ç«å¢™é…ç½®**ï¼š

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 5432/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=postgresql
sudo firewall-cmd --reload

# æˆ–ä½¿ç”¨iptables
sudo iptables -A INPUT -p tcp --dport 5432 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 5432 -j DROP
```

**Windowsé˜²ç«å¢™é…ç½®**ï¼š

```powershell
# å…è®¸PostgreSQLç«¯å£
New-NetFirewallRule -DisplayName "PostgreSQL" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow
```

---

## å…­ã€æ€§èƒ½è°ƒä¼˜

### 6.1 å†…å­˜è°ƒä¼˜

**å†…å­˜é…ç½®ä¼˜åŒ–**ï¼š

```conf
# æ ¹æ®ç³»ç»Ÿå†…å­˜è°ƒæ•´
# ç³»ç»Ÿå†…å­˜ï¼š8GB
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 16MB
maintenance_work_mem = 512MB

# ç³»ç»Ÿå†…å­˜ï¼š16GB
shared_buffers = 4GB
effective_cache_size = 12GB
work_mem = 32MB
maintenance_work_mem = 1GB

# ç³»ç»Ÿå†…å­˜ï¼š32GB
shared_buffers = 8GB
effective_cache_size = 24GB
work_mem = 64MB
maintenance_work_mem = 2GB
```

### 6.2 I/Oè°ƒä¼˜

**I/Oé…ç½®ä¼˜åŒ–**ï¼š

```conf
# SSDé…ç½®
random_page_cost = 1.1
effective_io_concurrency = 200
seq_page_cost = 1.0

# æ£€æŸ¥ç‚¹ä¼˜åŒ–
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB
checkpoint_completion_target = 0.9

# WALä¼˜åŒ–
wal_buffers = 16MB
wal_compression = on                    # PostgreSQL 9.5+
```

### 6.3 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–é…ç½®**ï¼š

```conf
# ç»Ÿè®¡ä¿¡æ¯
default_statistics_target = 100
autovacuum_analyze_scale_factor = 0.05

# æŸ¥è¯¢è§„åˆ’
enable_seqscan = on
enable_indexscan = on
enable_bitmapscan = on
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# JITç¼–è¯‘ï¼ˆPostgreSQL 11+ï¼‰
jit = on
jit_above_cost = 100000
jit_optimize_above_cost = 500000
jit_inline_above_cost = 500000
```

---

## ä¸ƒã€ç›‘æ§ä¸ç»´æŠ¤

### 7.1 ç›‘æ§é…ç½®

**å¯ç”¨pg_stat_statements**ï¼š

```sql
-- å®‰è£…pg_stat_statementsæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- é…ç½®
ALTER SYSTEM SET pg_stat_statements.track = 'all';
ALTER SYSTEM SET pg_stat_statements.max = 10000;
SELECT pg_reload_conf();

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 20;
```

**ç³»ç»Ÿç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- è¿æ¥æ•°ç›‘æ§
SELECT
    COUNT(*) AS total_connections,
    COUNT(*) FILTER (WHERE state = 'active') AS active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') AS idle_connections
FROM pg_stat_activity;

-- æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7.2 æ—¥å¿—é…ç½®

**æ—¥å¿—é…ç½®ä¼˜åŒ–**ï¼š

```conf
# æ—¥å¿—çº§åˆ«
log_min_messages = warning              # æœ€å°æ—¥å¿—çº§åˆ«
log_min_error_statement = error         # æœ€å°é”™è¯¯è¯­å¥çº§åˆ«

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 1000       # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢

# è¿æ¥æ—¥å¿—
log_connections = on
log_disconnections = on

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on                     # è®°å½•é”ç­‰å¾…

# æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on                    # è®°å½•æ£€æŸ¥ç‚¹
```

### 7.3 ç»´æŠ¤ä»»åŠ¡

**å®šæœŸç»´æŠ¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# maintenance.sh

# VACUUM
psql -U postgres -d mydb -c "VACUUM ANALYZE;"

# æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
psql -U postgres -d mydb -c "ANALYZE;"

# æ£€æŸ¥æ•°æ®åº“å¤§å°
psql -U postgres -d mydb -c "
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
"

# æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
psql -U postgres -d mydb -c "
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;
"
```

**å®šæ—¶ä»»åŠ¡ï¼ˆcronï¼‰**ï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œç»´æŠ¤
0 2 * * * /path/to/maintenance.sh >> /var/log/postgresql/maintenance.log 2>&1
```

---

## å…«ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 8.1 æ“ä½œç³»ç»Ÿå¯¹æ¯”

| æ“ä½œç³»ç»Ÿ | å®‰è£…éš¾åº¦ | æ€§èƒ½ | ç¨³å®šæ€§ | æ¨èåº¦ |
|---------|---------|------|--------|--------|
| **Linux (Ubuntu/Debian)** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **Linux (CentOS/RHEL)** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **Windows** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **macOS** | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |

### 8.2 å®‰è£…æ–¹å¼å¯¹æ¯”

| å®‰è£…æ–¹å¼ | å®‰è£…é€Ÿåº¦ | é…ç½®å¤æ‚åº¦ | çµæ´»æ€§ | æ¨èåœºæ™¯ | æ¨èåº¦ |
|---------|---------|-----------|--------|---------|--------|
| **åŒ…ç®¡ç†å™¨** | â­â­â­â­â­ | â­â­ | â­â­â­ | å¿«é€Ÿéƒ¨ç½² | â­â­â­â­â­ |
| **æºç ç¼–è¯‘** | â­â­ | â­â­â­â­ | â­â­â­â­â­ | è‡ªå®šä¹‰éœ€æ±‚ | â­â­â­ |
| **Docker** | â­â­â­â­â­ | â­ | â­â­â­â­ | å®¹å™¨åŒ–ç¯å¢ƒ | â­â­â­â­ |

### 8.3 é…ç½®æ–¹æ¡ˆå¯¹æ¯”

| é…ç½®æ–¹æ¡ˆ | æ€§èƒ½ | å®‰å…¨æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|------|--------|--------|---------|--------|
| **é»˜è®¤é…ç½®** | â­â­ | â­â­ | â­ | å¼€å‘ç¯å¢ƒ | â­â­ |
| **åŸºç¡€ä¼˜åŒ–** | â­â­â­ | â­â­â­ | â­â­ | æµ‹è¯•ç¯å¢ƒ | â­â­â­â­ |
| **å…¨é¢ä¼˜åŒ–** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | ç”Ÿäº§ç¯å¢ƒ | â­â­â­â­â­ |

---

## ä¹ã€å®è·µæ¡ˆä¾‹

### 9.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²

**å¼€å‘ç¯å¢ƒé…ç½®**ï¼š

```conf
# postgresql.confï¼ˆå¼€å‘ç¯å¢ƒï¼‰
max_connections = 50
shared_buffers = 128MB
effective_cache_size = 512MB
work_mem = 4MB
maintenance_work_mem = 64MB

# æ—¥å¿—é…ç½®ï¼ˆè¯¦ç»†ï¼‰
log_statement = 'all'
log_min_duration_statement = 0
log_connections = on
log_disconnections = on
```

### 9.2 æµ‹è¯•ç¯å¢ƒéƒ¨ç½²

**æµ‹è¯•ç¯å¢ƒé…ç½®**ï¼š

```conf
# postgresql.confï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
max_connections = 100
shared_buffers = 512MB
effective_cache_size = 2GB
work_mem = 8MB
maintenance_work_mem = 128MB

# æ€§èƒ½æµ‹è¯•é…ç½®
log_min_duration_statement = 100
autovacuum = on
```

### 9.3 å°å‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**å°å‹ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š

```conf
# postgresql.confï¼ˆå°å‹ç”Ÿäº§ç¯å¢ƒï¼Œ8GBå†…å­˜ï¼‰
max_connections = 200
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 16MB
maintenance_work_mem = 512MB

# å®‰å…¨é…ç½®
ssl = on
log_statement = 'ddl'
log_min_duration_statement = 1000
log_connections = on
log_disconnections = on

# æ€§èƒ½é…ç½®
random_page_cost = 1.1                  # SSD
effective_io_concurrency = 200          # SSD
checkpoint_timeout = 15min
max_wal_size = 4GB
```

---

## åã€æ•…éšœæ’æŸ¥

### 10.1 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šæ— æ³•å¯åŠ¨PostgreSQL**:

```bash
# æ£€æŸ¥æ—¥å¿—
tail -f /var/log/postgresql/postgresql-18-main.log

# æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la /var/lib/postgresql/data

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 5432

# æ£€æŸ¥PostgreSQLè¿›ç¨‹
ps aux | grep postgres
```

**é—®é¢˜2ï¼šè¿æ¥è¢«æ‹’ç»**:

```bash
# æ£€æŸ¥pg_hba.confé…ç½®
cat /etc/postgresql/18/main/pg_hba.conf

# æ£€æŸ¥ç›‘å¬åœ°å€
sudo netstat -tlnp | grep 5432

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

**é—®é¢˜3ï¼šæ€§èƒ½é—®é¢˜**:

```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- æ£€æŸ¥é”ç­‰å¾…
SELECT * FROM pg_locks
WHERE NOT granted;

-- æ£€æŸ¥è¿æ¥æ•°
SELECT COUNT(*) FROM pg_stat_activity;
```

### 10.2 è¯Šæ–­æ–¹æ³•

**ç³»ç»Ÿèµ„æºè¯Šæ–­**ï¼š

```bash
# CPUä½¿ç”¨ç‡
top
htop

# å†…å­˜ä½¿ç”¨
free -h
cat /proc/meminfo

# ç£ç›˜I/O
iostat -x 1
iotop

# ç½‘ç»œ
netstat -i
iftop
```

**æ•°æ®åº“è¯Šæ–­**ï¼š

```sql
-- æ´»åŠ¨è¿æ¥
SELECT * FROM pg_stat_activity;

-- é”ä¿¡æ¯
SELECT * FROM pg_locks;

-- ç­‰å¾…äº‹ä»¶
SELECT * FROM pg_stat_activity WHERE wait_event_type IS NOT NULL;

-- æ•°æ®åº“ç»Ÿè®¡
SELECT * FROM pg_stat_database;
```

### 10.3 è§£å†³æ–¹æ¡ˆ

**è¿æ¥æ•°è¿‡å¤š**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥è¯¦æƒ…
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query
FROM pg_stat_activity
ORDER BY state_change DESC;

-- ç»ˆæ­¢ç‰¹å®šè¿æ¥
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid <> pg_backend_pid()
  AND state = 'idle in transaction'
  AND state_change < NOW() - INTERVAL '1 hour';
```

**æ€§èƒ½é—®é¢˜**ï¼š

```sql
-- é‡å»ºç´¢å¼•
REINDEX DATABASE mydb;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- VACUUM
VACUUM ANALYZE;
```

---

## åä¸€ã€æœ€ä½³å®è·µ

### 11.1 éƒ¨ç½²æœ€ä½³å®è·µ

1. **ç¯å¢ƒå‡†å¤‡**ï¼š
   - ä½¿ç”¨ä¸“ç”¨æœåŠ¡å™¨
   - é…ç½®è¶³å¤Ÿçš„èµ„æº
   - è®¾ç½®é˜²ç«å¢™è§„åˆ™

2. **å®‰å…¨é…ç½®**ï¼š
   - ä¿®æ”¹é»˜è®¤å¯†ç 
   - ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
   - å¯ç”¨SSL/TLS
   - é…ç½®é˜²ç«å¢™

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æ ¹æ®ç¡¬ä»¶è°ƒæ•´å‚æ•°
   - å¯ç”¨ç›‘æ§
   - å®šæœŸç»´æŠ¤

### 11.2 ç»´æŠ¤æœ€ä½³å®è·µ

1. **å®šæœŸç»´æŠ¤**ï¼š
   - æ¯æ—¥ï¼šæ£€æŸ¥æ—¥å¿—
   - æ¯å‘¨ï¼šVACUUM ANALYZE
   - æ¯æœˆï¼šæ£€æŸ¥æ•°æ®åº“å¤§å°
   - æ¯å­£åº¦ï¼šæ€§èƒ½è¯„ä¼°

2. **å¤‡ä»½ç­–ç•¥**ï¼š
   - æ¯æ—¥å…¨é‡å¤‡ä»½
   - WALå½’æ¡£
   - å®šæœŸæ¢å¤æµ‹è¯•

3. **ç›‘æ§å‘Šè­¦**ï¼š
   - è¿æ¥æ•°å‘Šè­¦
   - ç£ç›˜ç©ºé—´å‘Šè­¦
   - æ…¢æŸ¥è¯¢å‘Šè­¦
   - é”™è¯¯æ—¥å¿—å‘Šè­¦

---

## åäºŒã€å‚è€ƒèµ„æº

### 12.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLå®‰è£…æ–‡æ¡£](https://www.postgresql.org/docs/current/installation.html)
- [PostgreSQLé…ç½®æ–‡æ¡£](https://www.postgresql.org/docs/current/config-setting.html)
- [PostgreSQLå®‰å…¨æ–‡æ¡£](https://www.postgresql.org/docs/current/security.html)

### 12.2 ç½‘ç»œèµ„æº

- [PostgreSQLæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://wiki.postgresql.org/wiki/Performance_Optimization)
- [PostgreSQLé…ç½®ä¼˜åŒ–](https://www.postgresql.org/docs/current/runtime-config.html)

### 12.3 ç›¸å…³æ–‡æ¡£

- `04-éƒ¨ç½²è¿ç»´/04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md` - æ€§èƒ½è°ƒä¼˜è¯¦ç»†æŒ‡å—
- `04-éƒ¨ç½²è¿ç»´/04.04-ç›‘æ§ä¸è¯Šæ–­.md` - ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•
- `04-éƒ¨ç½²è¿ç»´/04.05-å¤‡ä»½ä¸æ¢å¤.md` - å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
- `08-å·¥å…·èµ„æº/08.04-æœ€ä½³å®è·µæ€»ç»“.md` - æœ€ä½³å®è·µæ€»ç»“

---

**ç»´æŠ¤è€…**: Data-Science Team
**æœ€åæ›´æ–°**: 2025-01-15
**ç‰ˆæœ¬**: 3.0
