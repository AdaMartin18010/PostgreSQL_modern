# PostgreSQLå¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å¹¶å‘æ§åˆ¶ã€MVCCã€é”æœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ–ã€é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡
> ğŸ†• **PostgreSQL 18 MVCCæ”¹è¿›**: æ›´é«˜æ•ˆçš„VACUUMï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰ã€æ›´å¥½çš„æ­»é”æ£€æµ‹ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰ã€é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡38%ã€å¼‚æ­¥I/Oæå‡å¹¶å‘æ€§èƒ½ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶å®Œæ•´æŒ‡å—](#postgresqlå¹¶å‘æ§åˆ¶ä¸mvccæœºåˆ¶å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–](#ä¸€å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”](#21-å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”)
    - [2.2 é”ç±»å‹å¯¹æ¯”](#22-é”ç±»å‹å¯¹æ¯”)
  - [ä¸‰ã€ç†è®ºåŸºç¡€](#ä¸‰ç†è®ºåŸºç¡€)
    - [3.1 é”æœºåˆ¶ç†è®º](#31-é”æœºåˆ¶ç†è®º)
    - [3.2 MVCCç†è®º](#32-mvccç†è®º)
    - [3.3 å¯ä¸²è¡ŒåŒ–ç†è®º](#33-å¯ä¸²è¡ŒåŒ–ç†è®º)
  - [å››ã€PostgreSQL MVCCå®ç°](#å››postgresql-mvccå®ç°)
    - [4.1 è¡Œç‰ˆæœ¬ç®¡ç†](#41-è¡Œç‰ˆæœ¬ç®¡ç†)
    - [4.2 äº‹åŠ¡å¿«ç…§](#42-äº‹åŠ¡å¿«ç…§)
    - [4.3 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶](#43-ç‰ˆæœ¬æ¸…ç†æœºåˆ¶)
      - [4.1.1 è¡Œç‰ˆæœ¬å…ƒæ•°æ®è¯¦è§£](#411-è¡Œç‰ˆæœ¬å…ƒæ•°æ®è¯¦è§£)
      - [4.1.2 ç‰ˆæœ¬å¯è§æ€§è§„åˆ™è¯¦è§£](#412-ç‰ˆæœ¬å¯è§æ€§è§„åˆ™è¯¦è§£)
      - [4.2.1 äº‹åŠ¡å¿«ç…§è¯¦è§£](#421-äº‹åŠ¡å¿«ç…§è¯¦è§£)
      - [4.3.1 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶è¯¦è§£](#431-ç‰ˆæœ¬æ¸…ç†æœºåˆ¶è¯¦è§£)
      - [4.3.2 ç‰ˆæœ¬ç®¡ç†å®é™…åº”ç”¨](#432-ç‰ˆæœ¬ç®¡ç†å®é™…åº”ç”¨)
  - [äº”ã€é”æœºåˆ¶å®ç°](#äº”é”æœºåˆ¶å®ç°)
    - [5.1 é”ç±»å‹å’Œæ¨¡å¼](#51-é”ç±»å‹å’Œæ¨¡å¼)
    - [5.2 é”ç›‘æ§](#52-é”ç›‘æ§)
    - [5.3 æ­»é”æ£€æµ‹å’Œå¤„ç†](#53-æ­»é”æ£€æµ‹å’Œå¤„ç†)
  - [å…­ã€éš”ç¦»çº§åˆ«å®ç°](#å…­éš”ç¦»çº§åˆ«å®ç°)
    - [6.1 éš”ç¦»çº§åˆ«é…ç½®](#61-éš”ç¦»çº§åˆ«é…ç½®)
    - [6.2 éš”ç¦»çº§åˆ«æµ‹è¯•](#62-éš”ç¦»çº§åˆ«æµ‹è¯•)
  - [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–](#ä¸ƒæ€§èƒ½ä¼˜åŒ–)
    - [7.0 PostgreSQL 18 MVCCå’ŒVACUUMä¼˜åŒ– ğŸ†•](#70-postgresql-18-mvccå’Œvacuumä¼˜åŒ–-)
    - [7.1 MVCCä¼˜åŒ–](#71-mvccä¼˜åŒ–)
    - [7.2 é”ä¼˜åŒ–](#72-é”ä¼˜åŒ–)
  - [å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#å…«å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [8.1 é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ](#81-é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ)
    - [8.2 å®æ—¶æ•°æ®æ›´æ–°](#82-å®æ—¶æ•°æ®æ›´æ–°)
  - [ä¹ã€ç›¸å…³æ¦‚å¿µ](#ä¹ç›¸å…³æ¦‚å¿µ)
    - [9.1 ä¸Šä½æ¦‚å¿µ](#91-ä¸Šä½æ¦‚å¿µ)
    - [9.2 ä¸‹ä½æ¦‚å¿µ](#92-ä¸‹ä½æ¦‚å¿µ)
    - [9.3 å¹³è¡Œæ¦‚å¿µ](#93-å¹³è¡Œæ¦‚å¿µ)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 ç›¸å…³æ–‡æ¡£](#101-ç›¸å…³æ–‡æ¡£)
    - [10.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#102-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
    - [10.3 å‚è€ƒæ–‡çŒ®](#103-å‚è€ƒæ–‡çŒ®)
    - [10.3 Wikidataå¯¹é½](#103-wikidataå¯¹é½)
  - [åä¸€ã€äº¤å‰å¼•ç”¨](#åä¸€äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¹¶å‘æ§åˆ¶))
    ç†è®ºåŸºç¡€
      é”æœºåˆ¶ç†è®º
      MVCCç†è®º
      å¯ä¸²è¡ŒåŒ–ç†è®º
    MVCCå®ç°
      è¡Œç‰ˆæœ¬ç®¡ç†
      äº‹åŠ¡å¿«ç…§
      ç‰ˆæœ¬æ¸…ç†
    é”æœºåˆ¶
      é”ç±»å‹
      é”ç›‘æ§
      æ­»é”æ£€æµ‹
    éš”ç¦»çº§åˆ«
      é…ç½®
      æµ‹è¯•
    æ€§èƒ½ä¼˜åŒ–
      MVCCä¼˜åŒ–
      é”ä¼˜åŒ–
    å®é™…åº”ç”¨
      é«˜å¹¶å‘è®¢å•
      å®æ—¶æ•°æ®æ›´æ–°
```

---

## ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å¹¶å‘æ§åˆ¶æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç®¡ç†å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®å…±äº«æ•°æ®çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»æ€§ã€‚PostgreSQLé‡‡ç”¨MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ã€‚

**English Definition**: Concurrency control is a mechanism in database systems that manages multiple transactions accessing shared data simultaneously, ensuring data consistency and transaction isolation. PostgreSQL uses MVCC (Multi-Version Concurrency Control) mechanism for efficient concurrency control.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\lock}{\mathcal{L}}
\newcommand{\trans}{\mathcal{T}}
\newcommand{\resource}{\mathcal{R}}
\newcommand{\version}{\mathcal{V}}
\newcommand{\snapshot}{\mathcal{S}}

% é”çš„å½¢å¼åŒ–å®šä¹‰
\lock = \{l_1, l_2, \ldots, l_n\}

å…¶ä¸­æ¯ä¸ªé” l_i = (r_i, t_i, mode_i) è¡¨ç¤ºï¼š
- r_i \in \resource: è¢«é”å®šçš„èµ„æº
- t_i \in \trans: æŒæœ‰é”çš„äº‹åŠ¡
- mode_i \in \{S, X\}: é”æ¨¡å¼ï¼ˆå…±äº«/æ’ä»–ï¼‰

% MVCCçš„å½¢å¼åŒ–å®šä¹‰
\version = \{v_1, v_2, \ldots, v_m\}

å…¶ä¸­æ¯ä¸ªç‰ˆæœ¬ v_i = (data_i, xmin_i, xmax_i) è¡¨ç¤ºï¼š
- data_i: ç‰ˆæœ¬æ•°æ®
- xmin_i: åˆ›å»ºç‰ˆæœ¬çš„äº‹åŠ¡ID
- xmax_i: åˆ é™¤ç‰ˆæœ¬çš„äº‹åŠ¡ID
```

### 1.3 æ ¸å¿ƒå±æ€§

- **éš”ç¦»æ€§**: å¹¶å‘äº‹åŠ¡é—´ç›¸äº’éš”ç¦»
- **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ­»é”é¿å…**: é˜²æ­¢æ­»é”å‘ç”Ÿ
- **æ€§èƒ½ä¼˜åŒ–**: æœ€å¤§åŒ–å¹¶å‘åº¦

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”

| å¹¶å‘æ§åˆ¶æœºåˆ¶ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------------|---------|------|------|---------|
| ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰ | é”æœºåˆ¶ | ç®€å•ã€å¯é  | æ­»é”é£é™©ã€æ€§èƒ½è¾ƒä½ | ä¼ ç»Ÿæ•°æ®åº“ |
| MVCC | å¤šç‰ˆæœ¬ | é«˜å¹¶å‘ã€æ— é”è¯» | å­˜å‚¨å¼€é”€ã€ç‰ˆæœ¬æ¸…ç† | PostgreSQLã€Oracle |
| æ—¶é—´æˆ³æ’åº | æ—¶é—´æˆ³ | æ— æ­»é” | å›æ»šå¼€é”€å¤§ | ç ”ç©¶ç³»ç»Ÿ |
| ä¹è§‚å¹¶å‘æ§åˆ¶ | ç‰ˆæœ¬å· | é«˜å¹¶å‘è¯» | å†²çªæ—¶å›æ»š | è¯»å¤šå†™å°‘åœºæ™¯ |

### 2.2 é”ç±»å‹å¯¹æ¯”

| é”ç±»å‹ | ç²’åº¦ | å…¼å®¹æ€§ | æ€§èƒ½å½±å“ | ä½¿ç”¨åœºæ™¯ |
|-------|------|--------|---------|---------|
| è¡¨çº§é” | è¡¨ | ä½ | é«˜ | DDLæ“ä½œ |
| è¡Œçº§é” | è¡Œ | é«˜ | ä½ | DMLæ“ä½œ |
| é¡µçº§é” | é¡µ | ä¸­ | ä¸­ | è¾ƒå°‘ä½¿ç”¨ |
| æ„å‘é” | è¡¨+è¡Œ | ä¸­ | ä¸­ | é”å‡çº§ |

---

## ä¸‰ã€ç†è®ºåŸºç¡€

### 3.1 é”æœºåˆ¶ç†è®º

```latex
\begin{theorem}[ä¸¤é˜¶æ®µåŠ é”åè®®]
äº‹åŠ¡Tæ»¡è¶³ä¸¤é˜¶æ®µåŠ é”åè®®ï¼Œå½“ä¸”ä»…å½“ï¼š
1. å¢é•¿é˜¶æ®µï¼šTåªèƒ½è·å¾—é”ï¼Œä¸èƒ½é‡Šæ”¾é”
2. æ”¶ç¼©é˜¶æ®µï¼šTåªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½è·å¾—é”
\end{theorem}

\begin{proof}
åŸºäºé”çš„å…¼å®¹æ€§çŸ©é˜µå’Œäº‹åŠ¡çŠ¶æ€è½¬æ¢ï¼Œå¯ä»¥è¯æ˜ä¸¤é˜¶æ®µåŠ é”åè®®çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.2 MVCCç†è®º

```latex
\begin{theorem}[å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶]
MVCCé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°å¹¶å‘æ§åˆ¶ï¼š
1. æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®çš„ä¸€è‡´æ€§å¿«ç…§
2. å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸é˜»å¡è¯»æ“ä½œ
3. åƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†è¿‡æœŸç‰ˆæœ¬
4. ç‰ˆæœ¬å¯è§æ€§åŸºäºäº‹åŠ¡IDæ¯”è¾ƒ
\end{theorem}

\begin{proof}
åŸºäºäº‹åŠ¡IDçš„ååºå…³ç³»å’Œç‰ˆæœ¬å¯è§æ€§è§„åˆ™ï¼Œå¯ä»¥è¯æ˜MVCCçš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.3 å¯ä¸²è¡ŒåŒ–ç†è®º

```latex
\begin{theorem}[å¯ä¸²è¡ŒåŒ–åˆ¤å®š]
è°ƒåº¦Sæ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œå½“ä¸”ä»…å½“ï¼š
1. å†²çªå›¾æ˜¯æ— ç¯çš„
2. å­˜åœ¨æ‹“æ‰‘æ’åº
3. æ‹“æ‰‘æ’åºå¯¹åº”ä¸²è¡Œè°ƒåº¦
\end{theorem}
```

---

## å››ã€PostgreSQL MVCCå®ç°

### 4.1 è¡Œç‰ˆæœ¬ç®¡ç†

```sql
-- æŸ¥çœ‹è¡Œç‰ˆæœ¬ä¿¡æ¯
SELECT
    ctid,
    xmin,
    xmax,
    cmin,
    cmax,
    *
FROM employees
WHERE emp_id = 1001;

-- æŸ¥çœ‹äº‹åŠ¡ID
SELECT txid_current();
SELECT txid_current_snapshot();

-- æŸ¥çœ‹ç‰ˆæœ¬å¯è§æ€§
SELECT
    xmin,
    xmax,
    CASE
        WHEN xmin = 0 THEN 'invalid'
        WHEN xmax != 0 THEN 'deleted'
        ELSE 'visible'
    END as status
FROM employees
WHERE emp_id = 1001;
```

### 4.2 äº‹åŠ¡å¿«ç…§

```sql
-- åˆ›å»ºäº‹åŠ¡å¿«ç…§
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT txid_current_snapshot();

-- æŸ¥çœ‹å¿«ç…§ä¿¡æ¯
SELECT
    txid_snapshot_xmin(txid_current_snapshot()) as xmin,
    txid_snapshot_xmax(txid_current_snapshot()) as xmax,
    txid_snapshot_xip(txid_current_snapshot()) as active_xids;

-- å¿«ç…§éš”ç¦»ç¤ºä¾‹
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM employees WHERE dept_id = 1;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ’å…¥æ•°æ®
SELECT * FROM employees WHERE dept_id = 1; -- ä»ç„¶çœ‹åˆ°ç›¸åŒç»“æœ
COMMIT;
```

### 4.3 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶

```sql
-- æŸ¥çœ‹VACUUMç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_user_tables;

-- æ‰‹åŠ¨VACUUM
VACUUM employees;
VACUUM ANALYZE employees;

-- æŸ¥çœ‹æ­»å…ƒç»„
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 0;
```

#### 4.1.1 è¡Œç‰ˆæœ¬å…ƒæ•°æ®è¯¦è§£

**è¡Œç‰ˆæœ¬å­—æ®µè¯´æ˜**:

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ctid` | è¡Œçš„ç‰©ç†ä½ç½®ï¼ˆé¡µé¢å·+è¡Œå·ï¼‰ | `(0,1)` |
| `xmin` | åˆ›å»ºè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡ID | `12345` |
| `xmax` | åˆ é™¤è¯¥ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼ˆ0è¡¨ç¤ºæœªåˆ é™¤ï¼‰ | `0` æˆ– `12346` |
| `cmin` | åˆ›å»ºè¯¥ç‰ˆæœ¬çš„å‘½ä»¤IDï¼ˆåŒä¸€äº‹åŠ¡å†…ï¼‰ | `0` |
| `cmax` | åˆ é™¤è¯¥ç‰ˆæœ¬çš„å‘½ä»¤IDï¼ˆåŒä¸€äº‹åŠ¡å†…ï¼‰ | `0` |

**è¡Œç‰ˆæœ¬æŸ¥çœ‹ç¤ºä¾‹**:

```sql
-- æŸ¥çœ‹å®Œæ•´çš„è¡Œç‰ˆæœ¬ä¿¡æ¯
SELECT
    ctid,
    xmin,
    xmax,
    cmin,
    cmax,
    emp_id,
    name,
    salary,
    -- åˆ¤æ–­è¡Œç‰ˆæœ¬çŠ¶æ€
    CASE
        WHEN xmin = 0 THEN 'invalid'
        WHEN xmax != 0 THEN 'deleted'
        ELSE 'visible'
    END as version_status,
    -- æŸ¥çœ‹åˆ›å»ºäº‹åŠ¡çŠ¶æ€
    CASE
        WHEN txid_status(xmin) = 'committed' THEN 'committed'
        WHEN txid_status(xmin) = 'aborted' THEN 'aborted'
        ELSE 'in_progress'
    END as creator_status
FROM employees
WHERE emp_id = 1001;

-- æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬å†å²ç‰ˆæœ¬ï¼‰
SELECT
    ctid,
    xmin,
    xmax,
    *
FROM employees
ORDER BY ctid;
```

#### 4.1.2 ç‰ˆæœ¬å¯è§æ€§è§„åˆ™è¯¦è§£

**ç‰ˆæœ¬å¯è§æ€§åˆ¤æ–­è§„åˆ™**:

ä¸€ä¸ªè¡Œç‰ˆæœ¬å¯¹äº‹åŠ¡Tå¯è§ï¼Œå½“ä¸”ä»…å½“ï¼š

1. `xmin`å·²æäº¤ï¼Œä¸”`xmin < T.snapshot.xmin`æˆ–`xmin`åœ¨Tçš„å¿«ç…§ä¸­
2. `xmax`æœªè®¾ç½®ï¼ˆä¸º0ï¼‰ï¼Œæˆ–`xmax`æœªæäº¤ï¼Œæˆ–`xmax > T.snapshot.xmax`

**ç‰ˆæœ¬å¯è§æ€§å‡½æ•°**:

```sql
-- åˆ›å»ºç‰ˆæœ¬å¯è§æ€§æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION is_version_visible(
    p_xmin BIGINT,
    p_xmax BIGINT,
    p_snapshot TEXT
) RETURNS BOOLEAN AS $$
DECLARE
    v_xmin_status TEXT;
    v_xmax_status TEXT;
    v_snapshot_xmin BIGINT;
    v_snapshot_xmax BIGINT;
BEGIN
    -- è·å–å¿«ç…§ä¿¡æ¯
    v_snapshot_xmin := txid_snapshot_xmin(p_snapshot::txid_snapshot);
    v_snapshot_xmax := txid_snapshot_xmax(p_snapshot::txid_snapshot);

    -- æ£€æŸ¥xminçŠ¶æ€
    v_xmin_status := txid_status(p_xmin);
    IF v_xmin_status != 'committed' THEN
        RETURN FALSE;  -- xminæœªæäº¤ï¼Œä¸å¯è§
    END IF;

    IF p_xmin >= v_snapshot_xmax THEN
        RETURN FALSE;  -- xminåœ¨å¿«ç…§ä¹‹åï¼Œä¸å¯è§
    END IF;

    -- æ£€æŸ¥xmaxçŠ¶æ€
    IF p_xmax != 0 THEN
        v_xmax_status := txid_status(p_xmax);
        IF v_xmax_status = 'committed' AND p_xmax < v_snapshot_xmax THEN
            RETURN FALSE;  -- å·²è¢«åˆ é™¤ï¼Œä¸å¯è§
        END IF;
    END IF;

    RETURN TRUE;  -- å¯è§
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç‰ˆæœ¬å¯è§æ€§å‡½æ•°
SELECT
    emp_id,
    xmin,
    xmax,
    is_version_visible(
        xmin,
        xmax,
        txid_current_snapshot()::TEXT
    ) as is_visible
FROM employees;
```

**ç‰ˆæœ¬å¯è§æ€§å®é™…æ¡ˆä¾‹**:

```sql
-- åœºæ™¯ï¼šå¹¶å‘äº‹åŠ¡ä¸­çš„ç‰ˆæœ¬å¯è§æ€§

-- äº‹åŠ¡1ï¼šæ’å…¥æ•°æ®
BEGIN;
INSERT INTO employees (emp_id, name, salary) VALUES (1001, 'Alice', 50000);
-- æ­¤æ—¶xmin = å½“å‰äº‹åŠ¡IDï¼Œxmax = 0
-- å…¶ä»–äº‹åŠ¡çœ‹ä¸åˆ°è¿™ä¸ªç‰ˆæœ¬ï¼ˆxminæœªæäº¤ï¼‰

-- äº‹åŠ¡2ï¼šæŸ¥è¯¢ï¼ˆREAD COMMITTEDï¼‰
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM employees WHERE emp_id = 1001;
-- è¿”å›ï¼šæ— ç»“æœï¼ˆäº‹åŠ¡1æœªæäº¤ï¼‰

-- äº‹åŠ¡1ï¼šæäº¤
COMMIT;
-- æ­¤æ—¶xminå·²æäº¤

-- äº‹åŠ¡2ï¼šå†æ¬¡æŸ¥è¯¢
SELECT * FROM employees WHERE emp_id = 1001;
-- è¿”å›ï¼šAlice, 50000ï¼ˆç°åœ¨å¯è§ï¼‰

-- äº‹åŠ¡3ï¼šæ›´æ–°æ•°æ®
BEGIN;
UPDATE employees SET salary = 55000 WHERE emp_id = 1001;
-- åˆ›å»ºæ–°ç‰ˆæœ¬ï¼šxmin = äº‹åŠ¡3IDï¼Œxmax = 0
-- æ—§ç‰ˆæœ¬ï¼šxmin = äº‹åŠ¡1IDï¼Œxmax = äº‹åŠ¡3ID

-- äº‹åŠ¡2ï¼šå†æ¬¡æŸ¥è¯¢ï¼ˆREPEATABLE READï¼‰
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM employees WHERE emp_id = 1001;
-- è¿”å›ï¼šAlice, 50000ï¼ˆçœ‹åˆ°æ—§ç‰ˆæœ¬ï¼Œå› ä¸ºå¿«ç…§åœ¨äº‹åŠ¡3ä¹‹å‰ï¼‰

-- äº‹åŠ¡3ï¼šæäº¤
COMMIT;

-- äº‹åŠ¡2ï¼šå†æ¬¡æŸ¥è¯¢
SELECT * FROM employees WHERE emp_id = 1001;
-- è¿”å›ï¼šAlice, 50000ï¼ˆä»ç„¶çœ‹åˆ°æ—§ç‰ˆæœ¬ï¼ŒREPEATABLE READä¿æŒå¿«ç…§ï¼‰

-- äº‹åŠ¡2ï¼šæäº¤
COMMIT;

-- æ–°äº‹åŠ¡ï¼šæŸ¥è¯¢
BEGIN;
SELECT * FROM employees WHERE emp_id = 1001;
-- è¿”å›ï¼šAlice, 55000ï¼ˆçœ‹åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰
COMMIT;
```

#### 4.2.1 äº‹åŠ¡å¿«ç…§è¯¦è§£

**äº‹åŠ¡å¿«ç…§ç»“æ„**:

```sql
-- äº‹åŠ¡å¿«ç…§æ ¼å¼ï¼šxmin:xmax:xip_list
-- xmin: æœ€æ—©çš„æ´»åŠ¨äº‹åŠ¡ID
-- xmax: ä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼ˆæ‰€æœ‰å°äºxmaxçš„äº‹åŠ¡è¦ä¹ˆå·²æäº¤ï¼Œè¦ä¹ˆåœ¨xip_listä¸­ï¼‰
-- xip_list: æ´»åŠ¨äº‹åŠ¡IDåˆ—è¡¨

-- æŸ¥çœ‹å½“å‰å¿«ç…§
SELECT txid_current_snapshot();
-- è¿”å›ï¼šä¾‹å¦‚ '100:200:100,150' è¡¨ç¤ºï¼š
-- - xmin = 100ï¼ˆæœ€æ—©æ´»åŠ¨äº‹åŠ¡ï¼‰
-- - xmax = 200ï¼ˆä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼‰
-- - xip_list = [100, 150]ï¼ˆæ´»åŠ¨äº‹åŠ¡åˆ—è¡¨ï¼‰

-- è§£æå¿«ç…§ä¿¡æ¯
SELECT
    txid_snapshot_xmin(txid_current_snapshot()) as xmin,
    txid_snapshot_xmax(txid_current_snapshot()) as xmax,
    txid_snapshot_xip(txid_current_snapshot()) as active_xids;
```

**å¿«ç…§éš”ç¦»çº§åˆ«å·®å¼‚**:

```sql
-- READ COMMITTEDï¼šæ¯ä¸ªè¯­å¥è·å–æ–°å¿«ç…§
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT txid_current_snapshot();  -- å¿«ç…§1
SELECT * FROM employees;  -- ä½¿ç”¨å¿«ç…§1
SELECT txid_current_snapshot();  -- å¿«ç…§2ï¼ˆå¯èƒ½ä¸åŒï¼‰
SELECT * FROM employees;  -- ä½¿ç”¨å¿«ç…§2
COMMIT;

-- REPEATABLE READï¼šæ•´ä¸ªäº‹åŠ¡ä½¿ç”¨åŒä¸€å¿«ç…§
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT txid_current_snapshot();  -- å¿«ç…§1
SELECT * FROM employees;  -- ä½¿ç”¨å¿«ç…§1
SELECT txid_current_snapshot();  -- å¿«ç…§1ï¼ˆç›¸åŒï¼‰
SELECT * FROM employees;  -- ä½¿ç”¨å¿«ç…§1ï¼ˆç›¸åŒç»“æœï¼‰
COMMIT;
```

#### 4.3.1 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶è¯¦è§£

**VACUUMå·¥ä½œåŸç†**:

1. **æ‰«æè¡¨**: æ‰«ææ‰€æœ‰é¡µé¢ï¼Œè¯†åˆ«æ­»å…ƒç»„
2. **æ¸…ç†æ­»å…ƒç»„**: æ ‡è®°æ­»å…ƒç»„ç©ºé—´ä¸ºå¯ç”¨
3. **æ›´æ–°ç»Ÿè®¡ä¿¡æ¯**: æ›´æ–°pg_stat_user_tables
4. **å†»ç»“äº‹åŠ¡ID**: å†»ç»“æ—§çš„äº‹åŠ¡IDï¼Œé˜²æ­¢äº‹åŠ¡IDå›ç»•

**VACUUMç±»å‹**:

```sql
-- æ™®é€šVACUUMï¼šæ¸…ç†æ­»å…ƒç»„ï¼Œä¸é˜»å¡æŸ¥è¯¢
VACUUM employees;

-- VACUUM ANALYZEï¼šæ¸…ç†æ­»å…ƒç»„å¹¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
VACUUM ANALYZE employees;

-- VACUUM FULLï¼šå®Œå…¨é‡å»ºè¡¨ï¼Œé˜»å¡æŸ¥è¯¢
VACUUM FULL employees;

-- VACUUM VERBOSEï¼šæ˜¾ç¤ºè¯¦ç»†è¿›åº¦
VACUUM VERBOSE employees;
```

**è‡ªåŠ¨VACUUMé…ç½®**:

```sql
-- æŸ¥çœ‹è‡ªåŠ¨VACUUMé…ç½®
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_vacuum,
    last_autovacuum,
    autovacuum_count,
    CASE
        WHEN n_live_tup > 0 THEN
            ROUND(n_dead_tup::numeric / n_live_tup * 100, 2)
        ELSE 0
    END as dead_ratio
FROM pg_stat_user_tables
ORDER BY dead_ratio DESC;

-- é…ç½®è¡¨çº§è‡ªåŠ¨VACUUM
ALTER TABLE employees SET (
    autovacuum_vacuum_threshold = 50,
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_threshold = 50,
    autovacuum_analyze_scale_factor = 0.05
);

-- æŸ¥çœ‹VACUUMè¿›åº¦ï¼ˆPostgreSQL 9.6+ï¼‰
SELECT
    pid,
    datname,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples
FROM pg_stat_progress_vacuum;
```

**ç‰ˆæœ¬æ¸…ç†æœ€ä½³å®è·µ**:

```sql
-- ç›‘æ§è¡¨è†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size,
    n_dead_tup,
    n_live_tup,
    CASE
        WHEN n_live_tup > 0 THEN
            ROUND(n_dead_tup::numeric / n_live_tup * 100, 2)
        ELSE 0
    END as dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY dead_ratio DESC;

-- æ‰‹åŠ¨è§¦å‘VACUUMï¼ˆå¯¹äºå¤§è¡¨ï¼‰
VACUUM VERBOSE ANALYZE large_table;

-- å®šæœŸVACUUMï¼ˆç»´æŠ¤ä»»åŠ¡ï¼‰
-- å»ºè®®ï¼šæ¯å¤©å¯¹æ´»è·ƒè¡¨æ‰§è¡ŒVACUUM ANALYZE
```

**ç‰ˆæœ¬æ¸…ç†æ€§èƒ½ä¼˜åŒ–**:

```sql
-- PostgreSQL 18 VACUUMä¼˜åŒ–
-- é…ç½®å‚æ•°
ALTER SYSTEM SET autovacuum_max_workers = 3;
ALTER SYSTEM SET autovacuum_naptime = '1min';
ALTER SYSTEM SET autovacuum_vacuum_cost_delay = 2;

-- è¡¨çº§ä¼˜åŒ–
ALTER TABLE high_update_table SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- æ›´é¢‘ç¹çš„VACUUM
    autovacuum_analyze_scale_factor = 0.02
);

-- ç›‘æ§VACUUMæ€§èƒ½
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    n_dead_tup,
    n_live_tup
FROM pg_stat_user_tables
WHERE last_autovacuum IS NOT NULL
ORDER BY last_autovacuum DESC;
```

#### 4.3.2 ç‰ˆæœ¬ç®¡ç†å®é™…åº”ç”¨

**é«˜å¹¶å‘æ›´æ–°åœºæ™¯**:

```sql
-- åœºæ™¯ï¼šé«˜å¹¶å‘æ›´æ–°å¯¼è‡´ç‰ˆæœ¬è†¨èƒ€

-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE high_update_table (
    id INTEGER PRIMARY KEY,
    counter INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é«˜å¹¶å‘æ›´æ–°ï¼ˆæ¨¡æ‹Ÿï¼‰
-- å¤šä¸ªäº‹åŠ¡åŒæ—¶æ›´æ–°åŒä¸€è¡Œ
BEGIN;
UPDATE high_update_table SET counter = counter + 1, updated_at = NOW() WHERE id = 1;
COMMIT;

-- æŸ¥çœ‹ç‰ˆæœ¬æ•°é‡
SELECT
    ctid,
    xmin,
    xmax,
    counter,
    updated_at
FROM high_update_table
WHERE id = 1;

-- ç›‘æ§ç‰ˆæœ¬è†¨èƒ€
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    ROUND(n_dead_tup::numeric / (n_live_tup + n_dead_tup) * 100, 2) as dead_ratio
FROM pg_stat_user_tables
WHERE tablename = 'high_update_table';

-- å®šæœŸVACUUM
VACUUM ANALYZE high_update_table;
```

**é•¿äº‹åŠ¡å½±å“**:

```sql
-- åœºæ™¯ï¼šé•¿äº‹åŠ¡é˜»æ­¢ç‰ˆæœ¬æ¸…ç†

-- é•¿äº‹åŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM employees WHERE emp_id = 1001;
-- ä¿æŒäº‹åŠ¡æ‰“å¼€ï¼Œä¸æäº¤

-- åœ¨å…¶ä»–ä¼šè¯ä¸­æ›´æ–°æ•°æ®
BEGIN;
UPDATE employees SET salary = 60000 WHERE emp_id = 1001;
COMMIT;

-- å°è¯•VACUUM
VACUUM employees;
-- VACUUMå¯ä»¥è¿è¡Œï¼Œä½†æ— æ³•æ¸…ç†é•¿äº‹åŠ¡å¯è§çš„æ—§ç‰ˆæœ¬

-- æŸ¥çœ‹é˜»å¡VACUUMçš„äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    xact_start,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND xact_start < NOW() - INTERVAL '1 hour';

-- ç»ˆæ­¢é•¿äº‹åŠ¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = <long_transaction_pid>;
---

-- é…ç½®è‡ªåŠ¨VACUUM
ALTER TABLE employees SET (autovacuum_vacuum_threshold = 50);
ALTER TABLE employees SET (autovacuum_analyze_threshold = 50);

```

---

## äº”ã€é”æœºåˆ¶å®ç°

### 5.1 é”ç±»å‹å’Œæ¨¡å¼

```sql
-- è¡¨çº§é”
LOCK TABLE employees IN SHARE MODE;
LOCK TABLE departments IN EXCLUSIVE MODE;

-- è¡Œçº§é”
SELECT * FROM employees WHERE emp_id = 1001 FOR UPDATE;
SELECT * FROM employees WHERE dept_id = 1 FOR SHARE;

-- é¡µçº§é”ï¼ˆè‡ªåŠ¨ï¼‰
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 1;

-- å’¨è¯¢é”
SELECT pg_advisory_lock(12345);
SELECT pg_advisory_unlock(12345);
```

### 5.2 é”ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰é”
SELECT
    locktype,
    database,
    relation,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks
WHERE NOT granted;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS current_statement_in_blocking_process
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 5.3 æ­»é”æ£€æµ‹å’Œå¤„ç†

```sql
-- æ­»é”æ£€æµ‹é…ç½®
SHOW deadlock_timeout;
SET deadlock_timeout = '1s';

-- æŸ¥çœ‹æ­»é”ç»Ÿè®¡
SELECT * FROM pg_stat_database_conflicts;

-- æ­»é”é¿å…ç­–ç•¥
BEGIN;
-- æŒ‰å›ºå®šé¡ºåºè®¿é—®èµ„æº
SELECT * FROM accounts WHERE account_id = 1001 FOR UPDATE;
SELECT * FROM accounts WHERE account_id = 1002 FOR UPDATE;
COMMIT;
```

---

## å…­ã€éš”ç¦»çº§åˆ«å®ç°

### 6.1 éš”ç¦»çº§åˆ«é…ç½®

```sql
-- è®¾ç½®ä¼šè¯éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM employees WHERE dept_id = 1;
COMMIT;

-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SHOW transaction_isolation;
```

### 6.2 éš”ç¦»çº§åˆ«æµ‹è¯•

```sql
-- è„è¯»æµ‹è¯•ï¼ˆPostgreSQLä¸æ”¯æŒï¼‰
-- ä¸å¯é‡å¤è¯»æµ‹è¯•
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM employees WHERE emp_id = 1001;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ›´æ–°æ•°æ®
SELECT * FROM employees WHERE emp_id = 1001; -- å¯èƒ½çœ‹åˆ°ä¸åŒç»“æœ
COMMIT;

-- å¹»è¯»æµ‹è¯•
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM employees WHERE dept_id = 1;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ’å…¥æ•°æ®
SELECT COUNT(*) FROM employees WHERE dept_id = 1; -- ä»ç„¶çœ‹åˆ°ç›¸åŒç»“æœ
COMMIT;
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.0 PostgreSQL 18 MVCCå’ŒVACUUMä¼˜åŒ– ğŸ†•

PostgreSQL 18å¯¹MVCCæœºåˆ¶å’ŒVACUUMè¿›è¡Œäº†å¤šé¡¹ä¼˜åŒ–ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½å’Œå¹¶å‘èƒ½åŠ›ã€‚

**VACUUMä¼˜åŒ–**:

PostgreSQL 18æ”¹è¿›äº†VACUUMæœºåˆ¶ï¼Œä½¿å…¶æ›´é«˜æ•ˆåœ°æ¸…ç†æ­»å…ƒç»„ï¼Œå‡å°‘è¡¨è†¨èƒ€ã€‚

**æ€§èƒ½æå‡**:

- VACUUMæ€§èƒ½æå‡ï¼šæ›´æ™ºèƒ½çš„é¡µé¢æ‰«æç­–ç•¥
- å‡å°‘è¡¨è†¨èƒ€ï¼šæ›´åŠæ—¶çš„æ­»å…ƒç»„æ¸…ç†
- é™ä½é”ç«äº‰ï¼šæ”¹è¿›çš„é”æœºåˆ¶å‡å°‘å¯¹æ­£å¸¸æŸ¥è¯¢çš„å½±å“

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18 VACUUMé…ç½®ä¼˜åŒ–
-- postgresql.conf

-- Autovacuumé…ç½®ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

-- æ‰‹åŠ¨VACUUMï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
VACUUM ANALYZE large_table;  -- æ€§èƒ½æå‡ï¼Œé”ç«äº‰å‡å°‘

-- æŸ¥çœ‹VACUUMç»Ÿè®¡
SELECT * FROM pg_stat_progress_vacuum;
SELECT * FROM pg_stat_user_tables;
```

**æ­»é”æ£€æµ‹ä¼˜åŒ–**:

PostgreSQL 18æ”¹è¿›äº†æ­»é”æ£€æµ‹ç®—æ³•ï¼Œæ›´å¿«åœ°è¯†åˆ«å’Œè§£å†³æ­»é”é—®é¢˜ã€‚

**æ€§èƒ½æå‡**:

- æ­»é”æ£€æµ‹é€Ÿåº¦æå‡ï¼šæ›´å¿«çš„æ­»é”è¯†åˆ«
- å‡å°‘è¯¯æŠ¥ï¼šæ›´å‡†ç¡®çš„æ­»é”åˆ¤æ–­
- é™ä½ç³»ç»Ÿå¼€é”€ï¼šä¼˜åŒ–çš„æ£€æµ‹ç®—æ³•

**é…ç½®æ–¹æ³•**:

```sql
-- æ­»é”æ£€æµ‹é…ç½®
-- postgresql.conf
deadlock_timeout = 1s  -- æ­»é”æ£€æµ‹è¶…æ—¶ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰

-- æŸ¥çœ‹æ­»é”ç»Ÿè®¡
SELECT * FROM pg_stat_database_conflicts;

-- ç›‘æ§æ­»é”
SELECT
    pid,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE wait_event_type = 'Lock';
```

**å¼‚æ­¥I/Oæå‡å¹¶å‘æ€§èƒ½**:

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæå‡å¹¶å‘æŸ¥è¯¢æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ã€‚

**æ€§èƒ½æå‡**:

- å¹¶å‘æŸ¥è¯¢æ€§èƒ½æå‡ï¼šå¼‚æ­¥I/Oå‡å°‘I/Oç­‰å¾…
- ç³»ç»Ÿååé‡æå‡ï¼šæ”¯æŒæ›´é«˜çš„å¹¶å‘è¿æ¥æ•°
- å“åº”æ—¶é—´é™ä½ï¼šå‡å°‘æŸ¥è¯¢å»¶è¿Ÿ

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
-- postgresql.conf
effective_io_concurrency = 200   -- æå‡å¹¶å‘I/Oæ€§èƒ½

-- æŸ¥çœ‹I/Oç»Ÿè®¡
SELECT * FROM pg_stat_io;
```

**æ€§èƒ½å¯¹æ¯”**:

- PostgreSQL 17: VACUUMå’Œæ­»é”æ£€æµ‹åŸºå‡†æ€§èƒ½
- PostgreSQL 18: VACUUMæ€§èƒ½æå‡ï¼Œæ­»é”æ£€æµ‹æ›´å¿«
- PostgreSQL 18: å¹¶å‘æ€§èƒ½æå‡ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹

**æœ€ä½³å®è·µ**:

- åˆç†é…ç½®autovacuumå‚æ•°
- ç›‘æ§VACUUMè¿›åº¦å’Œè¡¨è†¨èƒ€æƒ…å†µ
- ä½¿ç”¨PostgreSQL 18çš„å¼‚æ­¥I/Oæå‡å¹¶å‘æ€§èƒ½
- å®šæœŸæ£€æŸ¥æ­»é”æ—¥å¿—ï¼Œä¼˜åŒ–åº”ç”¨é€»è¾‘

### 7.1 MVCCä¼˜åŒ–

```sql
-- å‡å°‘ç‰ˆæœ¬åˆ›å»º
BEGIN;
-- æ‰¹é‡æ“ä½œå‡å°‘ç‰ˆæœ¬æ•°é‡
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 1;
COMMIT;

-- ä¼˜åŒ–VACUUMç­–ç•¥
ALTER TABLE employees SET (autovacuum_vacuum_scale_factor = 0.1);
ALTER TABLE employees SET (autovacuum_analyze_scale_factor = 0.05);

-- ç›‘æ§ç‰ˆæœ¬è†¨èƒ€
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    ROUND(n_dead_tup::numeric / (n_live_tup + n_dead_tup) * 100, 2) as dead_ratio
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY dead_ratio DESC;
```

### 7.2 é”ä¼˜åŒ–

```sql
-- å‡å°‘é”ç«äº‰
BEGIN;
-- ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
UPDATE employees SET salary = salary * 1.1
WHERE dept_id = 1 AND emp_id > 1000;
COMMIT;

-- ä½¿ç”¨ä¹è§‚é”
BEGIN;
SELECT version, salary FROM employees WHERE emp_id = 1001;
-- åº”ç”¨å±‚å¤„ç†
UPDATE employees SET salary = 60000, version = version + 1
WHERE emp_id = 1001 AND version = 1;
COMMIT;

-- é”å‡çº§é¿å…
BEGIN;
-- é¿å…é•¿æ—¶é—´æŒæœ‰é”
SELECT * FROM employees WHERE dept_id = 1 FOR UPDATE;
-- å¿«é€Ÿå¤„ç†
UPDATE employees SET last_updated = NOW() WHERE dept_id = 1;
COMMIT;
```

---

## å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 8.1 é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ

```sql
-- ä¹è§‚é”å®ç°åº“å­˜æ‰£å‡
BEGIN;
-- æ£€æŸ¥åº“å­˜
SELECT stock_quantity, version FROM products WHERE product_id = 1001;
-- åº”ç”¨å±‚æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
-- æ‰£å‡åº“å­˜
UPDATE products
SET stock_quantity = stock_quantity - 5, version = version + 1
WHERE product_id = 1001 AND stock_quantity >= 5 AND version = :current_version;
-- æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'åº“å­˜ä¸è¶³æˆ–ç‰ˆæœ¬å†²çª';
END IF;
COMMIT;
```

### 8.2 å®æ—¶æ•°æ®æ›´æ–°

```sql
-- ä½¿ç”¨MVCCå®ç°å®æ—¶æ•°æ®è¯»å–
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- è¯»å–å½“å‰æ•°æ®
SELECT * FROM real_time_data WHERE sensor_id = 1001;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ›´æ–°æ•°æ®
-- è¯»å–æœ€æ–°æ•°æ®
SELECT * FROM real_time_data WHERE sensor_id = 1001;
COMMIT;
```

---

## ä¹ã€ç›¸å…³æ¦‚å¿µ

### 9.1 ä¸Šä½æ¦‚å¿µ

- **å¹¶å‘æ§åˆ¶**: æ›´å¹¿æ³›çš„å¹¶å‘ç®¡ç†æœºåˆ¶
- **äº‹åŠ¡ç®¡ç†**: äº‹åŠ¡å¤„ç†æœºåˆ¶
- **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®å®Œæ•´æ€§ä¿è¯

### 9.2 ä¸‹ä½æ¦‚å¿µ

- **MVCC**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
- **é”æœºåˆ¶**: å¹¶å‘æ§åˆ¶å®ç°
- **äº‹åŠ¡éš”ç¦»**: éš”ç¦»çº§åˆ«ç®¡ç†
- **æ­»é”æ£€æµ‹**: æ­»é”å¤„ç†æœºåˆ¶

### 9.3 å¹³è¡Œæ¦‚å¿µ

- **ä¸¤é˜¶æ®µåŠ é”**: ä¼ ç»Ÿé”åè®®
- **æ—¶é—´æˆ³æ’åº**: åŸºäºæ—¶é—´æˆ³çš„å¹¶å‘æ§åˆ¶
- **ä¹è§‚å¹¶å‘æ§åˆ¶**: ä¹è§‚é”æœºåˆ¶

---

## åã€å‚è€ƒèµ„æº

### 10.1 ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](./01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç†è®ºåŸºç¡€
- [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](../04-é«˜çº§ç‰¹æ€§/03.07-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†.md) - åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶
- [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../æ•°æ®åº“ç†è®º/10.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - MVCCæœºåˆ¶å½¢å¼åŒ–éªŒè¯
- [å­¦æœ¯ç ”ç©¶å‰æ²¿](../æ•°æ®åº“ç†è®º/10.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - å¹¶å‘æ§åˆ¶ç†è®ºç ”ç©¶

### 10.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
- [åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜](../08-å®æˆ˜æ¡ˆä¾‹/06.04-åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜.md) - å¹¶å‘æ§åˆ¶å®è·µ
- [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](../09-åº”ç”¨è®¾è®¡/è¡Œä¸šæ¡ˆä¾‹/æ€§èƒ½é—®é¢˜-æ¡ˆä¾‹åº“.md) - å¹¶å‘é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

### 10.3 å‚è€ƒæ–‡çŒ®

1. Berenson, H., et al. (1995). A critique of ANSI SQL isolation levels. ACM SIGMOD Record, 24(2), 1-10.
2. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
3. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
4. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 10.3 Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/mvcc.html>
  - <https://www.postgresql.org/docs/current/explicit-locking.html>

---

## åä¸€ã€äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

- â­â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](./01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç®¡ç†ç†è®ºåŸºç¡€
- â­â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](./01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†
- â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](./01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„ç†è®ºåŸºç¡€
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - å¹¶å‘æ€§èƒ½è°ƒä¼˜
- â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - é”ç›‘æ§
- â­ [æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.04-æ€§èƒ½é—®é¢˜æ¡ˆä¾‹åº“.md) - é”é—®é¢˜æ¡ˆä¾‹

### å¤–éƒ¨èµ„æº

- [PostgreSQL MVCCæ–‡æ¡£](https://www.postgresql.org/docs/current/mvcc.html)
- [PostgreSQLé”æ–‡æ¡£](https://www.postgresql.org/docs/current/explicit-locking.html)
- [MVCCç†è®º](https://en.wikipedia.org/wiki/Multiversion_concurrency_control)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-11-22
**PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
**ç»´æŠ¤è€…**: Documentation Team
