# Azure AIæ‰©å±•å®æˆ˜å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­
> **åº”ç”¨åœºæ™¯**: Azureäº‘æœåŠ¡é›†æˆã€ä¼ä¸šçº§AIåº”ç”¨ã€æ•°æ®éšç§ä¿æŠ¤
> **AzureæœåŠ¡**: Azure Database for PostgreSQL Flexible Server

---

## ğŸ“‘ ç›®å½•

- [Azure AIæ‰©å±•å®æˆ˜å®Œæ•´æŒ‡å—](#azure-aiæ‰©å±•å®æˆ˜å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æ ¸å¿ƒåŠŸèƒ½](#11-æ ¸å¿ƒåŠŸèƒ½)
    - [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
  - [äºŒã€å‰ç½®è¦æ±‚](#äºŒå‰ç½®è¦æ±‚)
    - [2.1 å¿…éœ€èµ„æº](#21-å¿…éœ€èµ„æº)
    - [2.2 æƒé™è¦æ±‚](#22-æƒé™è¦æ±‚)
  - [ä¸‰ã€ç¯å¢ƒå‡†å¤‡](#ä¸‰ç¯å¢ƒå‡†å¤‡)
    - [3.1 åˆ›å»ºAzure PostgreSQL Flexible Server](#31-åˆ›å»ºazure-postgresql-flexible-server)
    - [3.2 åˆ›å»ºAzure OpenAIèµ„æº](#32-åˆ›å»ºazure-openaièµ„æº)
  - [å››ã€å®‰è£…å’Œé…ç½®æ‰©å±•](#å››å®‰è£…å’Œé…ç½®æ‰©å±•)
    - [4.1 å¯ç”¨azure\_aiæ‰©å±•](#41-å¯ç”¨azure_aiæ‰©å±•)
    - [4.2 é…ç½®Azure OpenAIæœåŠ¡](#42-é…ç½®azure-openaiæœåŠ¡)
    - [4.3 é…ç½®Azureè®¤çŸ¥æœåŠ¡ï¼ˆå¯é€‰ï¼‰](#43-é…ç½®azureè®¤çŸ¥æœåŠ¡å¯é€‰)
  - [äº”ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äº”çŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [5.1 Azure AIæ‰©å±•åŠŸèƒ½å¯¹æ¯”](#51-azure-aiæ‰©å±•åŠŸèƒ½å¯¹æ¯”)
    - [5.2 ä¸å…¶ä»–AIé›†æˆæ–¹æ¡ˆå¯¹æ¯”](#52-ä¸å…¶ä»–aié›†æˆæ–¹æ¡ˆå¯¹æ¯”)
  - [å…­ã€åŸºç¡€åŠŸèƒ½ä½¿ç”¨](#å…­åŸºç¡€åŠŸèƒ½ä½¿ç”¨)
    - [6.1 ç”Ÿæˆæ–‡æœ¬åµŒå…¥](#61-ç”Ÿæˆæ–‡æœ¬åµŒå…¥)
    - [6.2 è¯­ä¹‰æœç´¢](#62-è¯­ä¹‰æœç´¢)
    - [6.3 Azureè®¤çŸ¥æœåŠ¡é›†æˆ](#63-azureè®¤çŸ¥æœåŠ¡é›†æˆ)
  - [ä¸ƒã€å®æˆ˜æ¡ˆä¾‹](#ä¸ƒå®æˆ˜æ¡ˆä¾‹)
    - [7.1 æ™ºèƒ½æ–‡æ¡£æ£€ç´¢ç³»ç»Ÿ](#71-æ™ºèƒ½æ–‡æ¡£æ£€ç´¢ç³»ç»Ÿ)
    - [7.2 å¤šè¯­è¨€å®¢æœç³»ç»Ÿ](#72-å¤šè¯­è¨€å®¢æœç³»ç»Ÿ)
  - [å…«ã€æ€§èƒ½ä¼˜åŒ–](#å…«æ€§èƒ½ä¼˜åŒ–)
    - [8.1 æ‰¹é‡å¤„ç†ä¼˜åŒ–](#81-æ‰¹é‡å¤„ç†ä¼˜åŒ–)
    - [8.2 æˆæœ¬æ§åˆ¶](#82-æˆæœ¬æ§åˆ¶)
    - [8.3 ç¼“å­˜ç­–ç•¥](#83-ç¼“å­˜ç­–ç•¥)
  - [ä¹ã€æ•…éšœæ’æŸ¥](#ä¹æ•…éšœæ’æŸ¥)
    - [9.1 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#91-å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)
      - [é—®é¢˜1: æ‰©å±•å®‰è£…å¤±è´¥](#é—®é¢˜1-æ‰©å±•å®‰è£…å¤±è´¥)
      - [é—®é¢˜2: APIè°ƒç”¨è¶…æ—¶](#é—®é¢˜2-apiè°ƒç”¨è¶…æ—¶)
      - [é—®é¢˜3: é™æµé”™è¯¯ (429 Too Many Requests)](#é—®é¢˜3-é™æµé”™è¯¯-429-too-many-requests)
      - [é—®é¢˜4: é…ç½®ä¸¢å¤±](#é—®é¢˜4-é…ç½®ä¸¢å¤±)
  - [åã€æ€§èƒ½åŸºå‡†](#åæ€§èƒ½åŸºå‡†)
    - [10.1 åµŒå…¥ç”Ÿæˆæ€§èƒ½](#101-åµŒå…¥ç”Ÿæˆæ€§èƒ½)
    - [10.2 æˆæœ¬ä¼°ç®—](#102-æˆæœ¬ä¼°ç®—)
  - [åä¸€ã€å‚è€ƒèµ„æº](#åä¸€å‚è€ƒèµ„æº)
    - [11.1 å®˜æ–¹æ–‡æ¡£](#111-å®˜æ–¹æ–‡æ¡£)
    - [11.2 ç›¸å…³æ–‡æ¡£](#112-ç›¸å…³æ–‡æ¡£)
      - [å‰æ²¿æŠ€æœ¯](#å‰æ²¿æŠ€æœ¯)
      - [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)
      - [é¡¹ç›®å¯¼èˆª](#é¡¹ç›®å¯¼èˆª)
    - [11.3 å¯è¿è¡Œç¤ºä¾‹](#113-å¯è¿è¡Œç¤ºä¾‹)
    - [11.4 å¤–éƒ¨ç¤ºä¾‹ä»£ç ](#114-å¤–éƒ¨ç¤ºä¾‹ä»£ç )

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((Azure AIæ‰©å±•))
    æ ¸å¿ƒåŠŸèƒ½
      Azure OpenAI
      è®¤çŸ¥æœåŠ¡
      å‘é‡æ“ä½œ
      æœ¬åœ°å¤„ç†
    ç¯å¢ƒå‡†å¤‡
      PostgreSQLæœåŠ¡å™¨
      OpenAIèµ„æº
      è®¤çŸ¥æœåŠ¡èµ„æº
    é…ç½®æ‰©å±•
      å¯ç”¨æ‰©å±•
      é…ç½®æœåŠ¡
      æƒé™è®¾ç½®
    åŸºç¡€åŠŸèƒ½
      æ–‡æœ¬åµŒå…¥
      è¯­ä¹‰æœç´¢
      æƒ…æ„Ÿåˆ†æ
      è¯­è¨€æ£€æµ‹
    å®æˆ˜æ¡ˆä¾‹
      æ–‡æ¡£æ£€ç´¢
      å¤šè¯­è¨€å®¢æœ
      æ™ºèƒ½æ¨è
    æ€§èƒ½ä¼˜åŒ–
      æ‰¹é‡å¤„ç†
      æˆæœ¬æ§åˆ¶
      ç¼“å­˜ç­–ç•¥
    æ•…éšœæ’æŸ¥
      å¸¸è§é—®é¢˜
      æ€§èƒ½åŸºå‡†
      æœ€ä½³å®è·µ
```

---

## ä¸€ã€æ¦‚è¿°

Azure Database for PostgreSQLæä¾›`azure_ai`æ‰©å±•ï¼Œå®ç°ä¸Azure OpenAIå’ŒAzureè®¤çŸ¥æœåŠ¡çš„æ— ç¼é›†æˆï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨æ•°æ®åº“ä¸­ç›´æ¥è°ƒç”¨è¿™äº›AIæœåŠ¡ã€‚

### 1.1 æ ¸å¿ƒåŠŸèƒ½

- âœ… **Azure OpenAIé›†æˆ**: æ–‡æœ¬åµŒå…¥ã€èŠå¤©å®Œæˆã€æ–‡æœ¬ç”Ÿæˆ
- âœ… **Azureè®¤çŸ¥æœåŠ¡**: æƒ…æ„Ÿåˆ†æã€è¯­è¨€æ£€æµ‹ã€ç¿»è¯‘
- âœ… **å‘é‡æ“ä½œ**: ä¸pgvectoré›†æˆï¼Œæ”¯æŒè¯­ä¹‰æœç´¢
- âœ… **æœ¬åœ°å¤„ç†**: åœ¨æ•°æ®åº“ä¸­å®ŒæˆAIæ¨ç†ï¼Œå‡å°‘æ•°æ®ä¼ è¾“

### 1.2 é€‚ç”¨åœºæ™¯

- ğŸ¯ éœ€è¦Azureäº‘æœåŠ¡çš„ä¼ä¸šåº”ç”¨
- ğŸ¯ å¯¹æ•°æ®éšç§æœ‰ä¸¥æ ¼è¦æ±‚ï¼ˆæ•°æ®ä¸ç¦»å¼€Azureï¼‰
- ğŸ¯ å·²æœ‰Azureè®¢é˜…å’ŒOpenAIèµ„æº
- ğŸ¯ éœ€è¦ä¸Azureç”Ÿæ€ç³»ç»Ÿæ·±åº¦é›†æˆ

---

## äºŒã€å‰ç½®è¦æ±‚

### 2.1 å¿…éœ€èµ„æº

1. **Azure Database for PostgreSQL Flexible Server**
   - PostgreSQL 13+
   - éœ€è¦ç®¡ç†å‘˜æƒé™å®‰è£…æ‰©å±•

2. **Azure OpenAIæœåŠ¡**
   - åˆ›å»ºAzure OpenAIèµ„æº
   - éƒ¨ç½²åµŒå…¥æ¨¡å‹ï¼ˆtext-embedding-ada-002ï¼‰
   - éƒ¨ç½²èŠå¤©æ¨¡å‹ï¼ˆgpt-35-turboæˆ–gpt-4ï¼‰

3. **Azureè®¤çŸ¥æœåŠ¡**ï¼ˆå¯é€‰ï¼‰
   - æ–‡æœ¬åˆ†æèµ„æºï¼ˆç”¨äºæƒ…æ„Ÿåˆ†æã€è¯­è¨€æ£€æµ‹ï¼‰
   - ç¿»è¯‘æœåŠ¡èµ„æºï¼ˆç”¨äºå¤šè¯­è¨€ï¼‰

### 2.2 æƒé™è¦æ±‚

- Azureè®¢é˜…Owneræˆ–Contributoræƒé™
- PostgreSQLæ•°æ®åº“ç®¡ç†å‘˜æƒé™
- Azure OpenAIèµ„æºè®¿é—®æƒé™

---

## ä¸‰ã€ç¯å¢ƒå‡†å¤‡

### 3.1 åˆ›å»ºAzure PostgreSQL Flexible Server

```bash
# ä½¿ç”¨Azure CLIåˆ›å»º
az postgres flexible-server create \
  --resource-group myResourceGroup \
  --name my-pg-ai-server \
  --location eastus \
  --admin-user myadmin \
  --admin-password <YourPassword> \
  --sku-name Standard_D2s_v3 \
  --tier GeneralPurpose \
  --version 16 \
  --storage-size 128

# å…è®¸æœ¬åœ°IPè®¿é—®
az postgres flexible-server firewall-rule create \
  --resource-group myResourceGroup \
  --name my-pg-ai-server \
  --rule-name AllowMyIP \
  --start-ip-address <YourIP> \
  --end-ip-address <YourIP>
```

### 3.2 åˆ›å»ºAzure OpenAIèµ„æº

```bash
# åˆ›å»ºAzure OpenAIèµ„æº
az cognitiveservices account create \
  --name my-openai-resource \
  --resource-group myResourceGroup \
  --kind OpenAI \
  --sku S0 \
  --location eastus \
  --yes

# éƒ¨ç½²åµŒå…¥æ¨¡å‹
az cognitiveservices account deployment create \
  --name my-openai-resource \
  --resource-group myResourceGroup \
  --deployment-name text-embedding-ada-002 \
  --model-name text-embedding-ada-002 \
  --model-version "2" \
  --model-format OpenAI \
  --scale-settings-scale-type "Standard"

# è·å–å¯†é’¥å’Œç«¯ç‚¹
az cognitiveservices account keys list \
  --name my-openai-resource \
  --resource-group myResourceGroup

az cognitiveservices account show \
  --name my-openai-resource \
  --resource-group myResourceGroup \
  --query properties.endpoint
```

---

## å››ã€å®‰è£…å’Œé…ç½®æ‰©å±•

### 4.1 å¯ç”¨azure_aiæ‰©å±•

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
psql "host=my-pg-ai-server.postgres.database.azure.com \
      port=5432 \
      dbname=postgres \
      user=myadmin \
      password=<YourPassword> \
      sslmode=require"

-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS azure_ai CASCADE;

-- éªŒè¯å®‰è£…
SELECT * FROM pg_extension WHERE extname = 'azure_ai';

-- æŸ¥çœ‹æ‰©å±•ç‰ˆæœ¬å’ŒåŠŸèƒ½
\dx+ azure_ai
```

### 4.2 é…ç½®Azure OpenAIæœåŠ¡

```sql
-- è®¾ç½®Azure OpenAIç«¯ç‚¹
SELECT azure_ai.set_setting(
    'azure_openai.endpoint',
    'https://my-openai-resource.openai.azure.com/'
);

-- è®¾ç½®APIå¯†é’¥ï¼ˆæ–¹å¼1ï¼šç›´æ¥è®¾ç½®ï¼Œä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
SELECT azure_ai.set_setting(
    'azure_openai.subscription_key',
    'your-api-key-here'
);

-- è®¾ç½®APIå¯†é’¥ï¼ˆæ–¹å¼2ï¼šä½¿ç”¨Azure Key Vaultï¼Œç”Ÿäº§æ¨èï¼‰
-- é¦–å…ˆåœ¨Azure Key Vaultä¸­å­˜å‚¨å¯†é’¥ï¼Œç„¶åé…ç½®æ•°æ®åº“
SELECT azure_ai.set_setting(
    'azure_openai.subscription_key',
    '@Microsoft.KeyVault(SecretUri=https://myvault.vault.azure.net/secrets/openai-key/)'
);

-- éªŒè¯é…ç½®
SELECT * FROM azure_ai.settings;
```

### 4.3 é…ç½®Azureè®¤çŸ¥æœåŠ¡ï¼ˆå¯é€‰ï¼‰

```sql
-- è®¾ç½®æ–‡æœ¬åˆ†ææœåŠ¡
SELECT azure_ai.set_setting(
    'azure_cognitive.endpoint',
    'https://my-cognitive-service.cognitiveservices.azure.com/'
);

SELECT azure_ai.set_setting(
    'azure_cognitive.subscription_key',
    'your-cognitive-key-here'
);
```

---

## äº”ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 5.1 Azure AIæ‰©å±•åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ”¯æŒæƒ…å†µ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ | æˆæœ¬ |
|------|---------|---------|------|------|
| æ–‡æœ¬åµŒå…¥ | âœ… æ”¯æŒ | è¯­ä¹‰æœç´¢ã€RAG | é«˜ | ä½ |
| èŠå¤©å®Œæˆ | âœ… æ”¯æŒ | å¯¹è¯ç³»ç»Ÿã€æ–‡æœ¬ç”Ÿæˆ | ä¸­ | ä¸­ |
| æƒ…æ„Ÿåˆ†æ | âœ… æ”¯æŒ | ç”¨æˆ·åé¦ˆåˆ†æ | é«˜ | ä½ |
| è¯­è¨€æ£€æµ‹ | âœ… æ”¯æŒ | å¤šè¯­è¨€åº”ç”¨ | é«˜ | ä½ |
| ç¿»è¯‘æœåŠ¡ | âœ… æ”¯æŒ | å›½é™…åŒ–åº”ç”¨ | ä¸­ | ä¸­ |
| å‘é‡æœç´¢ | âœ… æ”¯æŒï¼ˆéœ€pgvectorï¼‰ | ç›¸ä¼¼åº¦æœç´¢ | é«˜ | ä½ |

### 5.2 ä¸å…¶ä»–AIé›†æˆæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | éƒ¨ç½²æ–¹å¼ | æ•°æ®éšç§ | æˆæœ¬ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|------|--------|---------|
| Azure AIæ‰©å±• | äº‘åŸç”Ÿ | é«˜ï¼ˆAzureå†…ï¼‰ | ä¸­ | ä½ | Azureç”Ÿæ€ |
| æœ¬åœ°æ¨¡å‹ | è‡ªæ‰˜ç®¡ | æé«˜ | é«˜ | é«˜ | æ•°æ®æ•æ„Ÿ |
| å¤–éƒ¨API | ç¬¬ä¸‰æ–¹æœåŠ¡ | ä½ | ä½ | ä¸­ | å¿«é€ŸåŸå‹ |
| æ··åˆæ–¹æ¡ˆ | æ··åˆéƒ¨ç½² | ä¸­ | ä¸­ | é«˜ | çµæ´»éœ€æ±‚ |

---

## å…­ã€åŸºç¡€åŠŸèƒ½ä½¿ç”¨

### 6.1 ç”Ÿæˆæ–‡æœ¬åµŒå…¥

```sql
-- å•ä¸ªæ–‡æœ¬åµŒå…¥
SELECT azure_openai.create_embeddings(
    'text-embedding-ada-002',  -- éƒ¨ç½²åç§°
    'PostgreSQL is a powerful open-source database'
)::vector(1536) AS embedding;

-- æ‰¹é‡ç”ŸæˆåµŒå…¥
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    embedding vector(1536),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è‡ªåŠ¨ç”ŸæˆåµŒå…¥çš„è§¦å‘å™¨
CREATE OR REPLACE FUNCTION auto_generate_embedding()
RETURNS TRIGGER AS $$
BEGIN
    NEW.embedding := azure_openai.create_embeddings(
        'text-embedding-ada-002',
        NEW.content
    )::vector(1536);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER embedding_trigger
BEFORE INSERT OR UPDATE OF content ON documents
FOR EACH ROW
EXECUTE FUNCTION auto_generate_embedding();

-- æ’å…¥æ•°æ®ï¼ˆåµŒå…¥è‡ªåŠ¨ç”Ÿæˆï¼‰
INSERT INTO documents (title, content) VALUES
('AIç®€ä»‹', 'Artificial Intelligence is transforming industries'),
('æ•°æ®åº“', 'Databases are essential for data storage'),
('äº‘è®¡ç®—', 'Cloud computing provides scalable resources');

-- éªŒè¯åµŒå…¥å·²ç”Ÿæˆ
SELECT id, title, embedding IS NOT NULL as has_embedding FROM documents;
```

### 6.2 è¯­ä¹‰æœç´¢

```sql
-- åˆ›å»ºHNSWç´¢å¼•åŠ é€Ÿæœç´¢
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- æ‰§è¡Œè¯­ä¹‰æœç´¢
WITH query_embedding AS (
    SELECT azure_openai.create_embeddings(
        'text-embedding-ada-002',
        'machine learning and AI technologies'
    )::vector(1536) AS embedding
)
SELECT
    d.id,
    d.title,
    d.content,
    1 - (d.embedding <=> qe.embedding) AS similarity
FROM documents d, query_embedding qe
WHERE 1 - (d.embedding <=> qe.embedding) > 0.7
ORDER BY d.embedding <=> qe.embedding
LIMIT 5;
```

### 6.3 Azureè®¤çŸ¥æœåŠ¡é›†æˆ

```sql
-- æƒ…æ„Ÿåˆ†æ
SELECT azure_cognitive.analyze_sentiment(
    'This product is amazing! I love it.',
    'en'
) AS sentiment_result;

-- ç»“æœç¤ºä¾‹
-- {"sentiment": "positive", "scores": {"positive": 0.99, "neutral": 0.01, "negative": 0.00}}

-- è¯­è¨€æ£€æµ‹
SELECT azure_cognitive.detect_language(
    'Bonjour le monde'
) AS detected_language;

-- ç»“æœç¤ºä¾‹
-- {"language": "fr", "score": 0.99}

-- æ‰¹é‡å¤„ç†
CREATE TABLE customer_feedback (
    id SERIAL PRIMARY KEY,
    customer_name TEXT,
    feedback TEXT,
    sentiment JSONB,
    language TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è‡ªåŠ¨åˆ†æè§¦å‘å™¨
CREATE OR REPLACE FUNCTION auto_analyze_feedback()
RETURNS TRIGGER AS $$
BEGIN
    -- æ£€æµ‹è¯­è¨€
    NEW.language := (
        azure_cognitive.detect_language(NEW.feedback)->>'language'
    );

    -- åˆ†ææƒ…æ„Ÿ
    NEW.sentiment := azure_cognitive.analyze_sentiment(
        NEW.feedback,
        NEW.language
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER feedback_analysis_trigger
BEFORE INSERT ON customer_feedback
FOR EACH ROW
EXECUTE FUNCTION auto_analyze_feedback();

-- æ’å…¥åé¦ˆï¼ˆè‡ªåŠ¨åˆ†æï¼‰
INSERT INTO customer_feedback (customer_name, feedback) VALUES
('John Doe', 'Great service, very satisfied!'),
('Jane Smith', 'Producto excelente, muy recomendado'),
('ææ˜', 'æœåŠ¡å¾ˆå¥½ï¼Œéå¸¸æ»¡æ„ï¼');

-- æŸ¥è¯¢ç»“æœ
SELECT
    id,
    customer_name,
    feedback,
    language,
    sentiment->>'sentiment' as sentiment,
    (sentiment->'scores'->>'positive')::numeric as positive_score
FROM customer_feedback;
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### 7.1 æ™ºèƒ½æ–‡æ¡£æ£€ç´¢ç³»ç»Ÿ

```sql
-- åˆ›å»ºå®Œæ•´çš„æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    category TEXT,
    tags TEXT[],
    embedding vector(1536),
    sentiment JSONB,
    language TEXT,
    summary TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX ON knowledge_base USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON knowledge_base (category);
CREATE INDEX ON knowledge_base USING GIN (tags);

-- æ™ºèƒ½å¤„ç†å‡½æ•°
CREATE OR REPLACE FUNCTION process_knowledge_article()
RETURNS TRIGGER AS $$
BEGIN
    -- 1. ç”ŸæˆåµŒå…¥
    NEW.embedding := azure_openai.create_embeddings(
        'text-embedding-ada-002',
        NEW.title || ' ' || NEW.content
    )::vector(1536);

    -- 2. æ£€æµ‹è¯­è¨€
    NEW.language := (
        azure_cognitive.detect_language(NEW.content)->>'language'
    );

    -- 3. æƒ…æ„Ÿåˆ†æï¼ˆç”¨äºåˆ†ç±»ï¼‰
    NEW.sentiment := azure_cognitive.analyze_sentiment(
        NEW.content,
        NEW.language
    );

    -- 4. æ›´æ–°æ—¶é—´æˆ³
    NEW.updated_at := NOW();

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER process_article_trigger
BEFORE INSERT OR UPDATE OF title, content ON knowledge_base
FOR EACH ROW
EXECUTE FUNCTION process_knowledge_article();

-- æ™ºèƒ½æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION smart_search(
    query_text TEXT,
    category_filter TEXT DEFAULT NULL,
    similarity_threshold FLOAT DEFAULT 0.6,
    max_results INT DEFAULT 10
) RETURNS TABLE (
    id INT,
    title TEXT,
    content TEXT,
    category TEXT,
    similarity FLOAT,
    language TEXT
) AS $$
DECLARE
    query_embedding vector(1536);
BEGIN
    -- ç”ŸæˆæŸ¥è¯¢åµŒå…¥
    query_embedding := azure_openai.create_embeddings(
        'text-embedding-ada-002',
        query_text
    )::vector(1536);

    -- æ‰§è¡Œæœç´¢
    RETURN QUERY
    SELECT
        kb.id,
        kb.title,
        kb.content,
        kb.category,
        1 - (kb.embedding <=> query_embedding) AS similarity,
        kb.language
    FROM knowledge_base kb
    WHERE
        (category_filter IS NULL OR kb.category = category_filter)
        AND 1 - (kb.embedding <=> query_embedding) > similarity_threshold
    ORDER BY kb.embedding <=> query_embedding
    LIMIT max_results;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
INSERT INTO knowledge_base (title, content, category) VALUES
('Azure AI Services Overview', 'Azure AI services provide comprehensive AI capabilities...', 'AI'),
('PostgreSQL Performance Tuning', 'Optimizing PostgreSQL requires understanding indexes...', 'Database'),
('äº‘åŸç”Ÿæ¶æ„è®¾è®¡', 'äº‘åŸç”Ÿæ¶æ„é‡‡ç”¨å¾®æœåŠ¡ã€å®¹å™¨åŒ–ç­‰ç°ä»£æŠ€æœ¯...', 'Architecture');

-- æ‰§è¡Œæ™ºèƒ½æœç´¢
SELECT * FROM smart_search('artificial intelligence and machine learning', 'AI', 0.5, 5);
```

### 7.2 å¤šè¯­è¨€å®¢æœç³»ç»Ÿ

```sql
-- å®¢æœå¯¹è¯è¡¨
CREATE TABLE customer_conversations (
    id SERIAL PRIMARY KEY,
    customer_id INT,
    message TEXT NOT NULL,
    message_language TEXT,
    message_sentiment JSONB,
    auto_response TEXT,
    response_generated_at TIMESTAMPTZ,
    agent_reviewed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è‡ªåŠ¨å›å¤ç”Ÿæˆå‡½æ•°
CREATE OR REPLACE FUNCTION generate_auto_response()
RETURNS TRIGGER AS $$
DECLARE
    detected_lang TEXT;
    sentiment_score JSONB;
    similar_qa RECORD;
    context_text TEXT;
BEGIN
    -- 1. æ£€æµ‹è¯­è¨€
    detected_lang := (
        azure_cognitive.detect_language(NEW.message)->>'language'
    );
    NEW.message_language := detected_lang;

    -- 2. æƒ…æ„Ÿåˆ†æ
    sentiment_score := azure_cognitive.analyze_sentiment(
        NEW.message,
        detected_lang
    );
    NEW.message_sentiment := sentiment_score;

    -- 3. æŸ¥æ‰¾ç›¸ä¼¼çš„å†å²å¯¹è¯
    SELECT
        message || ' ' || auto_response INTO context_text
    FROM customer_conversations
    WHERE message_language = detected_lang
      AND auto_response IS NOT NULL
      AND agent_reviewed = TRUE
    ORDER BY created_at DESC
    LIMIT 5;

    -- 4. ç”Ÿæˆå›å¤ï¼ˆä½¿ç”¨Azure OpenAI Chatï¼‰
    -- æ³¨æ„ï¼šè¿™éœ€è¦å¦å¤–é…ç½®èŠå¤©æ¨¡å‹éƒ¨ç½²
    -- NEW.auto_response := azure_openai.create_chat_completion(
    --     'gpt-35-turbo',
    --     jsonb_build_array(
    --         jsonb_build_object('role', 'system', 'content', 'You are a helpful customer service assistant.'),
    --         jsonb_build_object('role', 'user', 'content', NEW.message)
    --     )
    -- )->'choices'->0->'message'->>'content';

    NEW.response_generated_at := NOW();

    -- 5. å¦‚æœæ˜¯è´Ÿé¢æƒ…ç»ªï¼Œæ ‡è®°éœ€è¦äººå·¥å®¡æ ¸
    IF (sentiment_score->'scores'->>'negative')::numeric > 0.7 THEN
        -- å‘é€é€šçŸ¥ç»™å®¢æœäººå‘˜
        PERFORM pg_notify('urgent_customer_message', NEW.id::TEXT);
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER auto_response_trigger
BEFORE INSERT ON customer_conversations
FOR EACH ROW
EXECUTE FUNCTION generate_auto_response();

-- æµ‹è¯•
INSERT INTO customer_conversations (customer_id, message) VALUES
(1001, 'I love this product, it works great!'),
(1002, 'This service is terrible, I want a refund!'),
(1003, 'CÃ³mo puedo cambiar mi contraseÃ±a?');

-- æŸ¥çœ‹ç»“æœ
SELECT
    id,
    substring(message, 1, 40) as message_preview,
    message_language,
    message_sentiment->'sentiment' as sentiment,
    (message_sentiment->'scores'->>'negative')::numeric as negative_score,
    created_at
FROM customer_conversations
ORDER BY created_at DESC;
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 æ‰¹é‡å¤„ç†ä¼˜åŒ–

```sql
-- é¿å…é€è¡Œå¤„ç†ï¼Œä½¿ç”¨æ‰¹é‡æ›´æ–°
DO $$
DECLARE
    batch_size INT := 100;
    processed INT := 0;
    total INT;
BEGIN
    SELECT COUNT(*) INTO total FROM documents WHERE embedding IS NULL;

    RAISE NOTICE 'Total documents to process: %', total;

    WHILE processed < total LOOP
        -- æ‰¹é‡æ›´æ–°
        WITH batch AS (
            SELECT id, content
            FROM documents
            WHERE embedding IS NULL
            ORDER BY id
            LIMIT batch_size
        )
        UPDATE documents d
        SET embedding = azure_openai.create_embeddings(
            'text-embedding-ada-002',
            b.content
        )::vector(1536)
        FROM batch b
        WHERE d.id = b.id;

        processed := processed + batch_size;
        RAISE NOTICE 'Processed: % / %', LEAST(processed, total), total;

        -- é¿å…APIé™æµ
        PERFORM pg_sleep(2);
    END LOOP;
END $$;
```

### 8.2 æˆæœ¬æ§åˆ¶

```sql
-- åˆ›å»ºAPIä½¿ç”¨è·Ÿè¸ªè¡¨
CREATE TABLE api_usage_log (
    id SERIAL PRIMARY KEY,
    service_type TEXT, -- 'embedding', 'chat', 'sentiment', etc.
    operation TEXT,
    input_tokens INT,
    output_tokens INT,
    estimated_cost_usd NUMERIC(10,6),
    executed_at TIMESTAMPTZ DEFAULT NOW()
);

-- åµŒå…¥æˆæœ¬è·Ÿè¸ªå‡½æ•°
CREATE OR REPLACE FUNCTION track_embedding_cost()
RETURNS TRIGGER AS $$
DECLARE
    token_count INT;
    cost_per_1k_tokens NUMERIC := 0.0001; -- text-embedding-ada-002å®šä»·
BEGIN
    -- ä¼°ç®—tokenæ•°ï¼ˆçº¦4ä¸ªå­—ç¬¦=1ä¸ªtokenï¼‰
    token_count := length(NEW.content) / 4;

    INSERT INTO api_usage_log (
        service_type,
        operation,
        input_tokens,
        estimated_cost_usd
    ) VALUES (
        'azure_openai',
        'create_embeddings',
        token_count,
        (token_count::NUMERIC / 1000) * cost_per_1k_tokens
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER track_embedding_cost_trigger
AFTER INSERT ON documents
FOR EACH ROW
WHEN (NEW.embedding IS NOT NULL)
EXECUTE FUNCTION track_embedding_cost();

-- æˆæœ¬æŠ¥å‘Š
SELECT
    service_type,
    operation,
    COUNT(*) as operation_count,
    SUM(input_tokens) as total_tokens,
    SUM(estimated_cost_usd) as total_cost_usd,
    AVG(estimated_cost_usd) as avg_cost_per_op
FROM api_usage_log
WHERE executed_at >= NOW() - INTERVAL '30 days'
GROUP BY service_type, operation
ORDER BY total_cost_usd DESC;
```

### 8.3 ç¼“å­˜ç­–ç•¥

```sql
-- åµŒå…¥ç¼“å­˜è¡¨
CREATE TABLE embedding_cache (
    content_hash TEXT PRIMARY KEY,
    content TEXT,
    embedding vector(1536),
    hit_count INT DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_used_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX ON embedding_cache (last_used_at);

-- å¸¦ç¼“å­˜çš„åµŒå…¥ç”Ÿæˆå‡½æ•°
CREATE OR REPLACE FUNCTION get_embedding_cached(input_text TEXT)
RETURNS vector(1536) AS $$
DECLARE
    content_hash TEXT;
    cached_embedding vector(1536);
BEGIN
    -- è®¡ç®—å†…å®¹å“ˆå¸Œ
    content_hash := md5(input_text);

    -- æ£€æŸ¥ç¼“å­˜
    SELECT embedding INTO cached_embedding
    FROM embedding_cache
    WHERE content_hash = content_hash;

    IF cached_embedding IS NOT NULL THEN
        -- æ›´æ–°ç¼“å­˜ç»Ÿè®¡
        UPDATE embedding_cache
        SET hit_count = hit_count + 1,
            last_used_at = NOW()
        WHERE content_hash = content_hash;

        RETURN cached_embedding;
    ELSE
        -- è°ƒç”¨APIç”ŸæˆåµŒå…¥
        cached_embedding := azure_openai.create_embeddings(
            'text-embedding-ada-002',
            input_text
        )::vector(1536);

        -- å­˜å…¥ç¼“å­˜
        INSERT INTO embedding_cache (content_hash, content, embedding)
        VALUES (content_hash, input_text, cached_embedding)
        ON CONFLICT (content_hash) DO NOTHING;

        RETURN cached_embedding;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ç¼“å­˜ç»Ÿè®¡
SELECT
    COUNT(*) as total_cached,
    SUM(hit_count) as total_hits,
    AVG(hit_count) as avg_hits_per_entry,
    pg_size_pretty(pg_total_relation_size('embedding_cache')) as cache_size
FROM embedding_cache;

-- æ¸…ç†æ—§ç¼“å­˜
DELETE FROM embedding_cache
WHERE last_used_at < NOW() - INTERVAL '90 days'
  AND hit_count < 5;
```

---

## ä¹ã€æ•…éšœæ’æŸ¥

### 9.1 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1: æ‰©å±•å®‰è£…å¤±è´¥

```sql
-- æ£€æŸ¥PostgreSQLç‰ˆæœ¬å’ŒæœåŠ¡ç±»å‹
SELECT version();
-- å¿…é¡»æ˜¯Azure Database for PostgreSQL Flexible Server

-- æ£€æŸ¥æ˜¯å¦æœ‰å®‰è£…æƒé™
SELECT current_user, usesuper FROM pg_user WHERE usename = current_user;

-- æŸ¥çœ‹å¯ç”¨æ‰©å±•
SELECT * FROM pg_available_extensions WHERE name = 'azure_ai';
```

**è§£å†³æ–¹æ¡ˆ**:

- ç¡®ä¿ä½¿ç”¨Flexible Serverï¼ˆSingle Serverä¸æ”¯æŒï¼‰
- ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·
- æ£€æŸ¥æœåŠ¡å™¨å‚æ•°`azure.extensions`

#### é—®é¢˜2: APIè°ƒç”¨è¶…æ—¶

```sql
-- å¢åŠ è¶…æ—¶è®¾ç½®
ALTER DATABASE mydb SET azure_ai.timeout = 60000; -- æ¯«ç§’

-- æ£€æŸ¥å½“å‰è®¾ç½®
SHOW azure_ai.timeout;
```

#### é—®é¢˜3: é™æµé”™è¯¯ (429 Too Many Requests)

```sql
-- å®ç°é‡è¯•é€»è¾‘
CREATE OR REPLACE FUNCTION safe_create_embeddings(
    deployment TEXT,
    input_text TEXT,
    max_retries INT DEFAULT 3
) RETURNS vector(1536) AS $$
DECLARE
    result vector(1536);
    retry_count INT := 0;
    wait_seconds INT;
BEGIN
    LOOP
        BEGIN
            result := azure_openai.create_embeddings(deployment, input_text)::vector(1536);
            RETURN result;
        EXCEPTION
            WHEN OTHERS THEN
                retry_count := retry_count + 1;
                IF retry_count >= max_retries THEN
                    RAISE NOTICE 'Max retries reached. Error: %', SQLERRM;
                    RAISE;
                END IF;

                -- æŒ‡æ•°é€€é¿
                wait_seconds := POWER(2, retry_count);
                RAISE NOTICE 'Retry % after % seconds. Error: %', retry_count, wait_seconds, SQLERRM;
                PERFORM pg_sleep(wait_seconds);
        END;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

#### é—®é¢˜4: é…ç½®ä¸¢å¤±

```sql
-- æ£€æŸ¥æ‰€æœ‰é…ç½®
SELECT * FROM azure_ai.settings;

-- é‡æ–°è®¾ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
SELECT azure_ai.set_setting('azure_openai.endpoint', 'https://...');
SELECT azure_ai.set_setting('azure_openai.subscription_key', '...');

-- é…ç½®æŒä¹…åŒ–ï¼ˆå†™å…¥postgresql.confï¼‰
ALTER DATABASE mydb SET azure_ai.azure_openai_endpoint = 'https://...';
```

---

## åã€æ€§èƒ½åŸºå‡†

### 10.1 åµŒå…¥ç”Ÿæˆæ€§èƒ½

| æ“ä½œ | æ–‡æœ¬é•¿åº¦ | å¹³å‡å»¶è¿Ÿ | ååé‡ |
|-----|---------|---------|--------|
| å•æ¬¡åµŒå…¥ | 100å­—ç¬¦ | ~100ms | 10 req/s |
| å•æ¬¡åµŒå…¥ | 1000å­—ç¬¦ | ~150ms | 6-7 req/s |
| æ‰¹é‡åµŒå…¥ | 100æ¡x100å­—ç¬¦ | ~2s | 50 req/s |

### 10.2 æˆæœ¬ä¼°ç®—

| æœåŠ¡ | å®šä»·ï¼ˆ2024å¹´ï¼‰ | 100ä¸‡æ¬¡è°ƒç”¨æˆæœ¬ |
|-----|--------------|---------------|
| text-embedding-ada-002 | $0.0001/1K tokens | ~$10-30 |
| gpt-35-turbo | $0.0005/1K tokens | ~$50-150 |
| æƒ…æ„Ÿåˆ†æ | $1/1Kè®°å½• | $1,000 |

---

## åä¸€ã€å‚è€ƒèµ„æº

### 11.1 å®˜æ–¹æ–‡æ¡£

- [Azure AI Extension for PostgreSQL](https://learn.microsoft.com/azure/postgresql/flexible-server/how-to-integrate-azure-ai)
- [Azure OpenAI Service](https://learn.microsoft.com/azure/ai-services/openai/)
- [Azure Cognitive Services](https://learn.microsoft.com/azure/ai-services/)

### 11.2 ç›¸å…³æ–‡æ¡£

#### å‰æ²¿æŠ€æœ¯

- â­â­â­ [RAGæ¶æ„å®æˆ˜æŒ‡å—](./05.04-RAGæ¶æ„å®æˆ˜æŒ‡å—.md) - RAGæ¶æ„å®è·µ
- â­â­ [AIæ¨¡å‹æ·±åº¦é›†æˆ](./05.02-AIæ¨¡å‹æ·±åº¦é›†æˆ.md) - AIæ¨¡å‹é›†æˆ
- â­â­ [PostgreSQL 2025æ–°ç‰¹æ€§](./05.01-PostgreSQL-2025æ–°ç‰¹æ€§.md) - æ–°ç‰¹æ€§æ€»è§ˆ

#### é«˜çº§ç‰¹æ€§

- â­â­â­ [å‘é‡æ•°æ®åº“æ”¯æŒ](../04-é«˜çº§ç‰¹æ€§/03.05-å‘é‡æ•°æ®åº“æ”¯æŒ.md) - å‘é‡æ•°æ®åº“åŸºç¡€

#### é¡¹ç›®å¯¼èˆª

- â­â­ [AIé›†æˆå¿«é€Ÿå¼€å§‹](../00-é¡¹ç›®å¯¼èˆª/AIé›†æˆå¿«é€Ÿå¼€å§‹.md) - å¿«é€Ÿå…¥é—¨æŒ‡å—

### 11.3 å¯è¿è¡Œç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
  - [åŸºç¡€å‘é‡æœç´¢ç¤ºä¾‹](../../examples/01-basic-vector-search/README.md) - å¿«é€Ÿå…¥é—¨
  - [RAGçŸ¥è¯†åº“ç¤ºä¾‹](../../examples/03-rag-knowledge-base/README.md) - å®Œæ•´RAGç³»ç»Ÿ
- [RAGæ¶æ„å®æˆ˜æŒ‡å—](./05.04-RAGæ¶æ„å®æˆ˜æŒ‡å—.md) - RAGæ¶æ„å®è·µ
- [è¯­ä¹‰æœç´¢ç³»ç»Ÿç«¯åˆ°ç«¯å®ç°](../../08-å®æˆ˜æ¡ˆä¾‹/06.01-è¯­ä¹‰æœç´¢ç³»ç»Ÿç«¯åˆ°ç«¯å®ç°.md) - ç”Ÿäº§çº§é¡¹ç›®

### 11.4 å¤–éƒ¨ç¤ºä¾‹ä»£ç 

- [Azure AI Extension Examples](https://github.com/Azure/azure-postgresql)
- [pgvector Integration](https://github.com/pgvector/pgvector)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-11-22
**ç»´æŠ¤è€…**: Data Science Team
**AzureæœåŠ¡è¦æ±‚**: Flexible Server, OpenAI, Cognitive Services
