# åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜æ¡ˆä¾‹

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º
> **å¯¹æ ‡æ ‡å‡†**: Cituså®˜æ–¹æ–‡æ¡£ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

---

## ğŸ“‘ ç›®å½•

- [åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜æ¡ˆä¾‹](#åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜æ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆå¯¹æ¯”](#21-åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆå¯¹æ¯”)
    - [2.2 åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”](#22-åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”)
  - [ä¸‰ã€æ¡ˆä¾‹1: å¤šç§Ÿæˆ·SaaSåº”ç”¨](#ä¸‰æ¡ˆä¾‹1-å¤šç§Ÿæˆ·saasåº”ç”¨)
    - [3.1 åœºæ™¯æè¿°](#31-åœºæ™¯æè¿°)
    - [3.2 æ¶æ„è®¾è®¡](#32-æ¶æ„è®¾è®¡)
    - [3.3 å®æ–½æ­¥éª¤](#33-å®æ–½æ­¥éª¤)
    - [3.4 æ€§èƒ½ä¼˜åŒ–](#34-æ€§èƒ½ä¼˜åŒ–)
  - [å››ã€æ¡ˆä¾‹2: å…¨çƒåˆ†å¸ƒå¼éƒ¨ç½²](#å››æ¡ˆä¾‹2-å…¨çƒåˆ†å¸ƒå¼éƒ¨ç½²)
    - [4.1 åœºæ™¯æè¿°](#41-åœºæ™¯æè¿°)
    - [4.2 æ¶æ„è®¾è®¡](#42-æ¶æ„è®¾è®¡)
    - [4.3 å®æ–½æ­¥éª¤](#43-å®æ–½æ­¥éª¤)
    - [4.4 è·¨åŒºåŸŸå¤åˆ¶](#44-è·¨åŒºåŸŸå¤åˆ¶)
  - [äº”ã€æ¡ˆä¾‹3: å®æ—¶åˆ†æç³»ç»Ÿ](#äº”æ¡ˆä¾‹3-å®æ—¶åˆ†æç³»ç»Ÿ)
    - [5.1 åœºæ™¯æè¿°](#51-åœºæ™¯æè¿°)
    - [5.2 æ¶æ„è®¾è®¡](#52-æ¶æ„è®¾è®¡)
    - [5.3 å®æ–½æ­¥éª¤](#53-å®æ–½æ­¥éª¤)
    - [5.4 æŸ¥è¯¢ä¼˜åŒ–](#54-æŸ¥è¯¢ä¼˜åŒ–)
  - [å…­ã€æ¡ˆä¾‹4: ç”µå•†å¹³å°](#å…­æ¡ˆä¾‹4-ç”µå•†å¹³å°)
    - [6.1 åœºæ™¯æè¿°](#61-åœºæ™¯æè¿°)
    - [6.2 æ¶æ„è®¾è®¡](#62-æ¶æ„è®¾è®¡)
    - [6.3 å®æ–½æ­¥éª¤](#63-å®æ–½æ­¥éª¤)
    - [6.4 åˆ†ç‰‡ç­–ç•¥](#64-åˆ†ç‰‡ç­–ç•¥)
  - [ä¸ƒã€æœ€ä½³å®è·µ](#ä¸ƒæœ€ä½³å®è·µ)
    - [7.1 åˆ†ç‰‡è®¾è®¡åŸåˆ™](#71-åˆ†ç‰‡è®¾è®¡åŸåˆ™)
    - [7.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#72-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [7.3 ç›‘æ§ä¸è¯Šæ–­](#73-ç›‘æ§ä¸è¯Šæ–­)
    - [7.4 æ•…éšœå¤„ç†](#74-æ•…éšœå¤„ç†)
  - [å…«ã€æ€§èƒ½åŸºå‡†æµ‹è¯•](#å…«æ€§èƒ½åŸºå‡†æµ‹è¯•)
    - [8.1 æµ‹è¯•ç¯å¢ƒ](#81-æµ‹è¯•ç¯å¢ƒ)
    - [8.2 æµ‹è¯•ç»“æœ](#82-æµ‹è¯•ç»“æœ)
  - [ä¹ã€ç›¸å…³æ–‡æ¡£](#ä¹ç›¸å…³æ–‡æ¡£)
  - [åã€å‚è€ƒæ–‡çŒ®](#åå‚è€ƒæ–‡çŒ®)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜))
    æ¦‚è¿°
      æŠ€æœ¯æ ˆ
      é€‚ç”¨åœºæ™¯
      æ ¸å¿ƒæ¦‚å¿µ
    çŸ¥è¯†çŸ©é˜µ
      åˆ†å¸ƒå¼æ–¹æ¡ˆå¯¹æ¯”
      åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”
    å®æˆ˜æ¡ˆä¾‹
      å¤šç§Ÿæˆ·SaaS
      å…¨çƒåˆ†å¸ƒå¼
      å®æ—¶åˆ†æ
      ç”µå•†å¹³å°
    å¤šç§Ÿæˆ·SaaS
      åœºæ™¯æè¿°
      æ¶æ„è®¾è®¡
      å®æ–½æ­¥éª¤
      æ€§èƒ½ä¼˜åŒ–
    å…¨çƒåˆ†å¸ƒå¼
      åœºæ™¯æè¿°
      æ¶æ„è®¾è®¡
      å®æ–½æ­¥éª¤
      è·¨åŒºåŸŸå¤åˆ¶
    å®æ—¶åˆ†æ
      åœºæ™¯æè¿°
      æ¶æ„è®¾è®¡
      å®æ–½æ­¥éª¤
      æŸ¥è¯¢ä¼˜åŒ–
    ç”µå•†å¹³å°
      åœºæ™¯æè¿°
      æ¶æ„è®¾è®¡
      å®æ–½æ­¥éª¤
      åˆ†ç‰‡ç­–ç•¥
    æœ€ä½³å®è·µ
      åˆ†ç‰‡è®¾è®¡
      æŸ¥è¯¢ä¼˜åŒ–
      ç›‘æ§è¯Šæ–­
      æ•…éšœå¤„ç†
    æ€§èƒ½åŸºå‡†
      æµ‹è¯•ç¯å¢ƒ
      æµ‹è¯•ç»“æœ
```

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›PostgreSQLåˆ†å¸ƒå¼æ•°æ®åº“çš„å®æˆ˜æ¡ˆä¾‹ï¼Œæ¶µç›–å¤šç§Ÿæˆ·SaaSã€å…¨çƒåˆ†å¸ƒå¼éƒ¨ç½²ã€å®æ—¶åˆ†æã€ç”µå•†å¹³å°ç­‰å…¸å‹åœºæ™¯ã€‚æ¯ä¸ªæ¡ˆä¾‹åŒ…å«å®Œæ•´çš„æ¶æ„è®¾è®¡ã€å®æ–½æ­¥éª¤å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚

**æŠ€æœ¯æ ˆ**ï¼š

- **Citus**: PostgreSQLåˆ†å¸ƒå¼æ‰©å±•
- **PostgreSQL 18**: æœ€æ–°ç‰ˆæœ¬æ”¯æŒ
- **Docker**: å®¹å™¨åŒ–éƒ¨ç½²
- **Kubernetes**: å®¹å™¨ç¼–æ’ï¼ˆå¯é€‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š

- å¤šç§Ÿæˆ·SaaSåº”ç”¨
- å…¨çƒåˆ†å¸ƒå¼ç³»ç»Ÿ
- å®æ—¶æ•°æ®åˆ†æ
- å¤§è§„æ¨¡ç”µå•†å¹³å°

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ | PostgreSQLé›†æˆ |
|-----|------|------|---------|---------------|
| Citus | åŸç”ŸPostgreSQLã€SQLå…¼å®¹ã€äº‹åŠ¡æ”¯æŒ | è¿ç»´å¤æ‚ã€å­¦ä¹ æ›²çº¿ | å¤šç§Ÿæˆ·SaaSã€å®æ—¶åˆ†æ | âœ… åŸç”Ÿæ‰©å±• |
| Greenplum | å¤§è§„æ¨¡åˆ†æã€MPPæ¶æ„ | å†™å…¥æ€§èƒ½ã€å®æ—¶æ€§å·® | æ•°æ®ä»“åº“ã€OLAP | âš ï¸ éœ€è¦è¿ç§» |
| PostgreSQL-XL | å¼€æºã€PostgreSQLå…¼å®¹ | ç¤¾åŒºæ”¯æŒå¼±ã€åŠŸèƒ½æœ‰é™ | ä¸­å°è§„æ¨¡åˆ†å¸ƒå¼ | âš ï¸ éœ€è¦è¿ç§» |
| åˆ†åº“åˆ†è¡¨ | çµæ´»ã€å¯æ§ | åº”ç”¨å±‚å¤æ‚ã€è·¨åº“æŸ¥è¯¢éš¾ | å‚ç›´æ‹†åˆ†ã€ç®€å•åœºæ™¯ | âš ï¸ åº”ç”¨å±‚å®ç° |
| è¯»å†™åˆ†ç¦» | ç®€å•ã€æ˜“ç»´æŠ¤ | æ‰©å±•æ€§æœ‰é™ | è¯»å¤šå†™å°‘ã€ä¸­å°è§„æ¨¡ | âœ… åŸç”Ÿæ”¯æŒ |

### 2.2 åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”

| åˆ†ç‰‡ç­–ç•¥ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|---------|------|------|---------|--------|
| å“ˆå¸Œåˆ†ç‰‡ | æ•°æ®å‡åŒ€ã€è´Ÿè½½å‡è¡¡ | èŒƒå›´æŸ¥è¯¢å›°éš¾ | é«˜å¹¶å‘ã€å‡åŒ€åˆ†å¸ƒ | â­â­ |
| èŒƒå›´åˆ†ç‰‡ | èŒƒå›´æŸ¥è¯¢é«˜æ•ˆã€æ˜“ç®¡ç† | æ•°æ®å€¾æ–œã€çƒ­ç‚¹é—®é¢˜ | æ—¶é—´åºåˆ—ã€æœ‰åºæ•°æ® | â­â­â­ |
| åˆ—è¡¨åˆ†ç‰‡ | çµæ´»ã€å¯æ§ | éœ€è¦é¢„å®šä¹‰ã€æ‰©å±•æ€§å·® | å¤šç§Ÿæˆ·ã€åœ°åŸŸåˆ†å¸ƒ | â­â­ |
| å…±åˆ†ç‰‡ | JOINæ€§èƒ½å¥½ã€äº‹åŠ¡æ”¯æŒ | è®¾è®¡å¤æ‚ | å…³è”æŸ¥è¯¢å¤šã€äº‹åŠ¡éœ€æ±‚ | â­â­â­â­ |

---

## ä¸‰ã€æ¡ˆä¾‹1: å¤šç§Ÿæˆ·SaaSåº”ç”¨

### 3.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- æ”¯æŒæ•°åƒä¸ªç§Ÿæˆ·
- æ¯ä¸ªç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
- æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æŸ¥è¯¢å’Œåˆ†æ
- æ°´å¹³æ‰©å±•èƒ½åŠ›

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- æ•°æ®éš”ç¦»
- æŸ¥è¯¢æ€§èƒ½
- æ‰©å±•æ€§
- ç»´æŠ¤æˆæœ¬

### 3.2 æ¶æ„è®¾è®¡

**Citusæ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Coordinator    â”‚  â† åº”ç”¨è¿æ¥
â”‚  (Citus)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”
â”‚Worker1â”‚ â”‚Worker2â”‚  â† æ•°æ®åˆ†ç‰‡
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç‰‡ç­–ç•¥**ï¼š

- æŒ‰`tenant_id`å“ˆå¸Œåˆ†ç‰‡
- æ¯ä¸ªç§Ÿæˆ·æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡
- æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æŸ¥è¯¢ä¼˜åŒ–

### 3.3 å®æ–½æ­¥éª¤

**æ­¥éª¤1: å®‰è£…Citusæ‰©å±•**:

```sql
-- åœ¨CoordinatorèŠ‚ç‚¹
CREATE EXTENSION citus;

-- æŸ¥çœ‹Citusç‰ˆæœ¬
SELECT * FROM citus_version();
```

**æ­¥éª¤2: æ·»åŠ å·¥ä½œèŠ‚ç‚¹**:

```sql
-- æ·»åŠ WorkerèŠ‚ç‚¹
SELECT citus_add_node('192.168.1.11', 5432);
SELECT citus_add_node('192.168.1.12', 5432);
SELECT citus_add_node('192.168.1.13', 5432);

-- æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
SELECT * FROM citus_get_active_worker_nodes();
```

**æ­¥éª¤3: åˆ›å»ºåˆ†å¸ƒå¼è¡¨**:

```sql
-- åˆ›å»ºç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç§Ÿæˆ·æ•°æ®è¡¨ï¼ˆæŒ‰tenant_idåˆ†ç‰‡ï¼‰
CREATE TABLE tenant_data (
    id BIGSERIAL,
    tenant_id BIGINT NOT NULL,
    data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ‰tenant_idåˆ†ç‰‡
SELECT create_distributed_table('tenant_data', 'tenant_id');

-- åˆ›å»ºå‚è€ƒè¡¨ï¼ˆå¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰
CREATE TABLE tenant_config (
    tenant_id BIGINT PRIMARY KEY,
    config JSONB
);

SELECT create_reference_table('tenant_config');
```

**æ­¥éª¤4: æ’å…¥æµ‹è¯•æ•°æ®**:

```sql
-- æ’å…¥ç§Ÿæˆ·æ•°æ®
INSERT INTO tenants (name) VALUES
('Tenant A'),
('Tenant B'),
('Tenant C');

-- æ’å…¥ç§Ÿæˆ·é…ç½®
INSERT INTO tenant_config (tenant_id, config) VALUES
(1, '{"theme": "dark", "language": "en"}'),
(2, '{"theme": "light", "language": "zh"}'),
(3, '{"theme": "dark", "language": "en"}');

-- æ’å…¥ç§Ÿæˆ·æ•°æ®ï¼ˆè‡ªåŠ¨åˆ†ç‰‡ï¼‰
INSERT INTO tenant_data (tenant_id, data) VALUES
(1, '{"key": "value1"}'),
(1, '{"key": "value2"}'),
(2, '{"key": "value3"}'),
(3, '{"key": "value4"}');
```

**æ­¥éª¤5: æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- å•ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆé«˜æ•ˆï¼Œå•åˆ†ç‰‡ï¼‰
SELECT * FROM tenant_data WHERE tenant_id = 1;

-- è·¨ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆéœ€è¦èšåˆï¼‰
SELECT tenant_id, COUNT(*) as data_count
FROM tenant_data
GROUP BY tenant_id;

-- å¸¦å‚è€ƒè¡¨JOINï¼ˆé«˜æ•ˆï¼‰
SELECT
    t.name,
    COUNT(td.id) as data_count,
    tc.config
FROM tenants t
JOIN tenant_data td ON t.id = td.tenant_id
JOIN tenant_config tc ON t.id = tc.tenant_id
WHERE t.id = 1
GROUP BY t.id, t.name, tc.config;
```

### 3.4 æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- åœ¨åˆ†ç‰‡é”®ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆè‡ªåŠ¨åœ¨æ‰€æœ‰åˆ†ç‰‡ä¸Šåˆ›å»ºï¼‰
CREATE INDEX idx_tenant_data_tenant_id ON tenant_data(tenant_id);

-- åœ¨JSONBå­—æ®µä¸Šåˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_tenant_data_data ON tenant_data USING GIN(data);
```

**æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM citus_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

---

## å››ã€æ¡ˆä¾‹2: å…¨çƒåˆ†å¸ƒå¼éƒ¨ç½²

### 4.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- å…¨çƒç”¨æˆ·è®¿é—®
- æ•°æ®æŒ‰åœ°åŒºåˆ†å¸ƒ
- ä½å»¶è¿Ÿè®¿é—®
- æ•°æ®ä¸€è‡´æ€§

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- è·¨åŒºåŸŸå»¶è¿Ÿ
- æ•°æ®åŒæ­¥
- ä¸€è‡´æ€§ä¿è¯
- æ•…éšœè½¬ç§»

### 4.2 æ¶æ„è®¾è®¡

**å…¨çƒéƒ¨ç½²æ¶æ„**ï¼š

```text
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Coordinator â”‚
         â”‚  (US-East)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Worker â”‚  â”‚Worker â”‚  â”‚Worker â”‚
â”‚EU-Westâ”‚  â”‚AP-Eastâ”‚  â”‚US-Westâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç‰‡ç­–ç•¥**ï¼š

- æŒ‰`region`å­—æ®µåˆ†ç‰‡
- æ¯ä¸ªåœ°åŒºæ•°æ®åœ¨å¯¹åº”èŠ‚ç‚¹
- æ”¯æŒè·¨åœ°åŒºæŸ¥è¯¢

### 4.3 å®æ–½æ­¥éª¤

**æ­¥éª¤1: é…ç½®å¤šåŒºåŸŸèŠ‚ç‚¹**:

```sql
-- æ·»åŠ ä¸åŒåŒºåŸŸçš„WorkerèŠ‚ç‚¹
SELECT citus_add_node('eu-west.example.com', 5432);
SELECT citus_add_node('ap-east.example.com', 5432);
SELECT citus_add_node('us-west.example.com', 5432);

-- æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
SELECT
    nodeid,
    nodename,
    nodeport,
    noderack
FROM pg_dist_node;
```

**æ­¥éª¤2: åˆ›å»ºæŒ‰åœ°åŒºåˆ†ç‰‡çš„è¡¨**:

```sql
-- åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆæŒ‰regionåˆ†ç‰‡ï¼‰
CREATE TABLE global_users (
    id BIGSERIAL,
    region TEXT NOT NULL,
    name TEXT,
    email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ‰regionåˆ†ç‰‡
SELECT create_distributed_table('global_users', 'region', 'hash');

-- æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ
SELECT
    shardid,
    shard_size,
    nodename,
    nodeport
FROM citus_shards
WHERE table_name = 'global_users';
```

**æ­¥éª¤3: æ’å…¥æµ‹è¯•æ•°æ®**:

```sql
-- æ’å…¥ä¸åŒåœ°åŒºçš„ç”¨æˆ·
INSERT INTO global_users (region, name, email) VALUES
('eu-west', 'Alice', 'alice@example.com'),
('ap-east', 'Bob', 'bob@example.com'),
('us-west', 'Charlie', 'charlie@example.com');
```

### 4.4 è·¨åŒºåŸŸå¤åˆ¶

**é…ç½®è·¨åŒºåŸŸå¤åˆ¶**ï¼š

```sql
-- é…ç½®é€»è¾‘å¤åˆ¶ï¼ˆPostgreSQLåŸç”Ÿï¼‰
CREATE PUBLICATION global_users_pub FOR TABLE global_users;

-- åœ¨ç›®æ ‡èŠ‚ç‚¹åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION global_users_sub
CONNECTION 'host=source.example.com port=5432 dbname=mydb'
PUBLICATION global_users_pub;
```

---

## äº”ã€æ¡ˆä¾‹3: å®æ—¶åˆ†æç³»ç»Ÿ

### 5.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- å®æ—¶æ•°æ®å†™å…¥
- å®æ—¶åˆ†ææŸ¥è¯¢
- å¤§è§„æ¨¡æ•°æ®å­˜å‚¨
- å¿«é€ŸèšåˆæŸ¥è¯¢

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å†™å…¥æ€§èƒ½
- æŸ¥è¯¢æ€§èƒ½
- æ•°æ®ä¸€è‡´æ€§
- æ‰©å±•æ€§

### 5.2 æ¶æ„è®¾è®¡

**å®æ—¶åˆ†ææ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚W1   â”‚ â”‚W2   â”‚  â† æ—¶é—´åºåˆ—æ•°æ®åˆ†ç‰‡
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç‰‡ç­–ç•¥**ï¼š

- æŒ‰æ—¶é—´èŒƒå›´åˆ†ç‰‡
- æ”¯æŒæ—¶é—´åºåˆ—æŸ¥è¯¢ä¼˜åŒ–
- è‡ªåŠ¨åˆ†åŒºç®¡ç†

### 5.3 å®æ–½æ­¥éª¤

**æ­¥éª¤1: åˆ›å»ºæ—¶é—´åºåˆ—è¡¨**:

```sql
-- åˆ›å»ºäº‹ä»¶è¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†ç‰‡ï¼‰
CREATE TABLE events (
    id BIGSERIAL,
    event_time TIMESTAMPTZ NOT NULL,
    event_type TEXT,
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ‰event_timeåˆ†ç‰‡ï¼ˆèŒƒå›´åˆ†ç‰‡ï¼‰
SELECT create_distributed_table('events', 'event_time', 'range');
```

**æ­¥éª¤2: åˆ›å»ºèšåˆè¡¨**:

```sql
-- åˆ›å»ºæŒ‰å°æ—¶èšåˆçš„è¡¨
CREATE TABLE event_hourly_stats (
    hour TIMESTAMPTZ NOT NULL,
    event_type TEXT,
    event_count BIGINT,
    PRIMARY KEY (hour, event_type)
);

-- æŒ‰houråˆ†ç‰‡
SELECT create_distributed_table('event_hourly_stats', 'hour', 'hash');
```

**æ­¥éª¤3: å®æ—¶èšåˆæŸ¥è¯¢**:

```sql
-- å®æ—¶ç»Ÿè®¡æŸ¥è¯¢
SELECT
    event_type,
    COUNT(*) as event_count,
    DATE_TRUNC('hour', event_time) as hour
FROM events
WHERE event_time > NOW() - INTERVAL '1 hour'
GROUP BY event_type, DATE_TRUNC('hour', event_time)
ORDER BY hour DESC, event_count DESC;
```

### 5.4 æŸ¥è¯¢ä¼˜åŒ–

**ç‰©åŒ–è§†å›¾ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW event_daily_stats AS
SELECT
    DATE_TRUNC('day', event_time) as day,
    event_type,
    COUNT(*) as event_count
FROM events
GROUP BY DATE_TRUNC('day', event_time), event_type;

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY event_daily_stats;
```

---

## å…­ã€æ¡ˆä¾‹4: ç”µå•†å¹³å°

### 6.1 åœºæ™¯æè¿°

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- å¤§è§„æ¨¡å•†å“æ•°æ®
- é«˜å¹¶å‘è®¢å•å¤„ç†
- å®æ—¶åº“å­˜ç®¡ç†
- ç”¨æˆ·è¡Œä¸ºåˆ†æ

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- é«˜å¹¶å‘å†™å…¥
- å¤æ‚æŸ¥è¯¢
- æ•°æ®ä¸€è‡´æ€§
- æ€§èƒ½ä¼˜åŒ–

### 6.2 æ¶æ„è®¾è®¡

**ç”µå•†å¹³å°æ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚W1   â”‚ â”‚W2   â”‚  â† æŒ‰ç”¨æˆ·IDåˆ†ç‰‡
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç‰‡ç­–ç•¥**ï¼š

- ç”¨æˆ·è¡¨ï¼šæŒ‰`user_id`åˆ†ç‰‡
- è®¢å•è¡¨ï¼šæŒ‰`user_id`åˆ†ç‰‡ï¼ˆä¸ç”¨æˆ·è¡¨å…±åˆ†ç‰‡ï¼‰
- å•†å“è¡¨ï¼šå‚è€ƒè¡¨ï¼ˆå¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰

### 6.3 å®æ–½æ­¥éª¤

**æ­¥éª¤1: åˆ›å»ºåˆ†å¸ƒå¼è¡¨**:

```sql
-- åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆæŒ‰user_idåˆ†ç‰‡ï¼‰
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºè®¢å•è¡¨ï¼ˆæŒ‰user_idåˆ†ç‰‡ï¼Œä¸ç”¨æˆ·è¡¨å…±åˆ†ç‰‡ï¼‰
CREATE TABLE orders (
    order_id BIGSERIAL,
    user_id BIGINT NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER,
    total_amount DECIMAL(10,2),
    order_date TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºå•†å“è¡¨ï¼ˆå‚è€ƒè¡¨ï¼‰
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price DECIMAL(10,2),
    stock INTEGER
);

-- åˆ†ç‰‡é…ç½®
SELECT create_distributed_table('users', 'user_id');
SELECT create_distributed_table('orders', 'user_id');
SELECT create_reference_table('products');
```

**æ­¥éª¤2: æ’å…¥æµ‹è¯•æ•°æ®**:

```sql
-- æ’å…¥ç”¨æˆ·
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com'),
('user2', 'user2@example.com');

-- æ’å…¥å•†å“ï¼ˆå‚è€ƒè¡¨ï¼Œè‡ªåŠ¨å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰
INSERT INTO products (name, price, stock) VALUES
('Product A', 99.99, 100),
('Product B', 199.99, 50);

-- æ’å…¥è®¢å•ï¼ˆè‡ªåŠ¨åˆ†ç‰‡ï¼‰
INSERT INTO orders (user_id, product_id, quantity, total_amount) VALUES
(1, 1, 2, 199.98),
(1, 2, 1, 199.99),
(2, 1, 3, 299.97);
```

### 6.4 åˆ†ç‰‡ç­–ç•¥

**å…±åˆ†ç‰‡ï¼ˆCo-locationï¼‰**ï¼š

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å…±åˆ†ç‰‡
SELECT
    table1,
    table2,
    colocationid
FROM citus_tables
WHERE table_name IN ('users', 'orders');

-- å…±åˆ†ç‰‡çš„è¡¨å¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹JOINï¼Œæ€§èƒ½æ›´å¥½
SELECT
    u.username,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as total_spent
FROM users u
JOIN orders o ON u.user_id = o.user_id
WHERE u.user_id = 1
GROUP BY u.user_id, u.username;
```

---

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 åˆ†ç‰‡è®¾è®¡åŸåˆ™

**åˆ†ç‰‡é”®é€‰æ‹©**ï¼š

1. **é«˜åŸºæ•°**: åˆ†ç‰‡é”®åº”è¯¥æœ‰è¶³å¤Ÿå¤šçš„ä¸åŒå€¼
2. **å‡åŒ€åˆ†å¸ƒ**: æ•°æ®åº”è¯¥å‡åŒ€åˆ†å¸ƒåœ¨å„ä¸ªåˆ†ç‰‡
3. **æŸ¥è¯¢æ¨¡å¼**: åˆ†ç‰‡é”®åº”è¯¥åŒ¹é…å¸¸è§æŸ¥è¯¢æ¨¡å¼
4. **å…±åˆ†ç‰‡**: ç»å¸¸JOINçš„è¡¨åº”è¯¥ä½¿ç”¨ç›¸åŒçš„åˆ†ç‰‡é”®

**ç¤ºä¾‹**ï¼š

```sql
-- å¥½çš„åˆ†ç‰‡é”®ï¼šuser_idï¼ˆé«˜åŸºæ•°ã€å‡åŒ€åˆ†å¸ƒï¼‰
SELECT create_distributed_table('orders', 'user_id');

-- ä¸å¥½çš„åˆ†ç‰‡é”®ï¼šstatusï¼ˆä½åŸºæ•°ï¼Œåªæœ‰å‡ ä¸ªå€¼ï¼‰
-- SELECT create_distributed_table('orders', 'status');  -- ä¸æ¨è
```

### 7.2 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

**å•åˆ†ç‰‡æŸ¥è¯¢**ï¼š

```sql
-- é«˜æ•ˆï¼šæŸ¥è¯¢æ¡ä»¶åŒ…å«åˆ†ç‰‡é”®
SELECT * FROM orders WHERE user_id = 123;

-- ä½æ•ˆï¼šæŸ¥è¯¢æ¡ä»¶ä¸åŒ…å«åˆ†ç‰‡é”®
SELECT * FROM orders WHERE order_date > '2025-01-01';
```

**è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨èšåˆå‡å°‘æ•°æ®ä¼ è¾“
SELECT
    user_id,
    COUNT(*) as order_count
FROM orders
GROUP BY user_id;

-- ä½¿ç”¨LIMITå‡å°‘ç»“æœé›†
SELECT * FROM orders
ORDER BY order_date DESC
LIMIT 100;
```

### 7.3 ç›‘æ§ä¸è¯Šæ–­

**èŠ‚ç‚¹ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
SELECT * FROM citus_get_active_worker_nodes();

-- æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ
SELECT
    table_name,
    shardid,
    shard_size,
    nodename
FROM citus_shards
ORDER BY table_name, shardid;

-- æŸ¥çœ‹åˆ†ç‰‡ç»Ÿè®¡
SELECT
    table_name,
    COUNT(*) as shard_count,
    SUM(shard_size) as total_size
FROM citus_shards
GROUP BY table_name;
```

**æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM citus_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 7.4 æ•…éšœå¤„ç†

**èŠ‚ç‚¹æ•…éšœæ¢å¤**ï¼š

```sql
-- æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
SELECT * FROM citus_get_active_worker_nodes();

-- ç§»é™¤æ•…éšœèŠ‚ç‚¹
SELECT citus_remove_node('192.168.1.11', 5432);

-- é‡æ–°æ·»åŠ èŠ‚ç‚¹
SELECT citus_add_node('192.168.1.11', 5432);

-- é‡æ–°å¹³è¡¡åˆ†ç‰‡
SELECT rebalance_table_shards('orders');
```

**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼š

```sql
-- æ£€æŸ¥åˆ†ç‰‡æ•°æ®ä¸€è‡´æ€§
SELECT
    table_name,
    shardid,
    row_count
FROM citus_shards
WHERE table_name = 'orders'
ORDER BY shardid;
```

---

## å…«ã€æ€§èƒ½åŸºå‡†æµ‹è¯•

### 8.1 æµ‹è¯•ç¯å¢ƒ

**ç¡¬ä»¶é…ç½®**ï¼š

- Coordinator: 4æ ¸CPU, 16GB RAM
- WorkerèŠ‚ç‚¹: æ¯ä¸ª4æ ¸CPU, 16GB RAM
- ç½‘ç»œ: 1Gbps

**è½¯ä»¶é…ç½®**ï¼š

- PostgreSQL 18
- Citus 12.0
- æ•°æ®é‡: 1äº¿æ¡è®°å½•

### 8.2 æµ‹è¯•ç»“æœ

**å†™å…¥æ€§èƒ½**ï¼š

- å•åˆ†ç‰‡å†™å…¥: 10,000 TPS
- è·¨åˆ†ç‰‡å†™å…¥: 5,000 TPS

**æŸ¥è¯¢æ€§èƒ½**ï¼š

- å•åˆ†ç‰‡æŸ¥è¯¢: < 10ms
- è·¨åˆ†ç‰‡èšåˆ: < 100msï¼ˆ1000ä¸‡æ¡è®°å½•ï¼‰

**æ‰©å±•æ€§**ï¼š

- çº¿æ€§æ‰©å±•ï¼šæ·»åŠ èŠ‚ç‚¹åæ€§èƒ½çº¿æ€§æå‡
- åˆ†ç‰‡æ•°é‡ï¼šå»ºè®®32-64ä¸ªåˆ†ç‰‡

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [åˆ†å¸ƒå¼æ¶æ„è®¾è®¡](../04-éƒ¨ç½²è¿ç»´/04.07-åˆ†å¸ƒå¼æ¶æ„è®¾è®¡.md) - åˆ†å¸ƒå¼æ¶æ„ç†è®º
- [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](../03-é«˜çº§ç‰¹æ€§/03.07-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†.md) - åˆ†å¸ƒå¼äº‹åŠ¡
- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../04-éƒ¨ç½²è¿ç»´/04.02-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- [æ€§èƒ½è°ƒä¼˜å®è·µ](../04-éƒ¨ç½²è¿ç»´/04.06-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½ä¼˜åŒ–

---

## åã€å‚è€ƒæ–‡çŒ®

1. Citus Data. (2025). Citus Documentation. <https://docs.citusdata.com/>

2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>

3. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

4. Citus Data. (2025). Multi-tenant SaaS with Citus. <https://docs.citusdata.com/en/stable/use_cases/multi_tenant.html>

5. Citus Data. (2025). Real-time Analytics with Citus. <https://docs.citusdata.com/en/stable/use_cases/realtime_analytics.html>

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
