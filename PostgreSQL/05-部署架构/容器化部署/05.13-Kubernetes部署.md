# Kubernetes éƒ¨ç½²æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [Kubernetes éƒ¨ç½²æŒ‡å—](#kubernetes-éƒ¨ç½²æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [é€‰æ‹©å»ºè®®](#é€‰æ‹©å»ºè®®)
  - [2. ä½¿ç”¨ PostgreSQL Operator](#2-ä½¿ç”¨-postgresql-operator)
    - [2.1 å®‰è£… Crunchy PostgreSQL Operator](#21-å®‰è£…-crunchy-postgresql-operator)
    - [2.2 åˆ›å»º PostgreSQL é›†ç¾¤](#22-åˆ›å»º-postgresql-é›†ç¾¤)
    - [2.3 è¿æ¥æ•°æ®åº“](#23-è¿æ¥æ•°æ®åº“)
  - [3. ä½¿ç”¨ StatefulSet](#3-ä½¿ç”¨-statefulset)
    - [3.1 åˆ›å»º ConfigMap](#31-åˆ›å»º-configmap)
    - [3.2 åˆ›å»º Secret](#32-åˆ›å»º-secret)
    - [3.3 åˆ›å»º StatefulSet](#33-åˆ›å»º-statefulset)
    - [3.4 åˆ›å»º Service](#34-åˆ›å»º-service)
  - [4. é«˜å¯ç”¨é…ç½®](#4-é«˜å¯ç”¨é…ç½®)
    - [4.1 ä½¿ç”¨ Patroni](#41-ä½¿ç”¨-patroni)
    - [4.2 é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»](#42-é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»)
  - [5. å­˜å‚¨é…ç½®](#5-å­˜å‚¨é…ç½®)
    - [5.1 ä½¿ç”¨ PersistentVolume](#51-ä½¿ç”¨-persistentvolume)
    - [5.2 ä½¿ç”¨ StorageClass](#52-ä½¿ç”¨-storageclass)
  - [6. ç›‘æ§ä¸æ—¥å¿—](#6-ç›‘æ§ä¸æ—¥å¿—)
    - [6.1 ä½¿ç”¨ Prometheus Operator](#61-ä½¿ç”¨-prometheus-operator)
    - [6.2 é…ç½®æ—¥å¿—æ”¶é›†](#62-é…ç½®æ—¥å¿—æ”¶é›†)
  - [7. å¤‡ä»½ä¸æ¢å¤](#7-å¤‡ä»½ä¸æ¢å¤)
    - [7.1 ä½¿ç”¨ pgBackRest](#71-ä½¿ç”¨-pgbackrest)
    - [7.2 æ¢å¤å¤‡ä»½](#72-æ¢å¤å¤‡ä»½)
  - [7. ç”Ÿäº§çº§StatefulSeté…ç½®](#7-ç”Ÿäº§çº§statefulseté…ç½®)
    - [7.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®](#71-å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®)
    - [7.2 èµ„æºé™åˆ¶å’Œä¼˜åŒ–](#72-èµ„æºé™åˆ¶å’Œä¼˜åŒ–)
    - [7.3 æ»šåŠ¨æ›´æ–°ç­–ç•¥](#73-æ»šåŠ¨æ›´æ–°ç­–ç•¥)
    - [7.4 ç½‘ç»œç­–ç•¥é…ç½®](#74-ç½‘ç»œç­–ç•¥é…ç½®)
  - [8. PostgreSQL Operatorè¯¦ç»†é…ç½®](#8-postgresql-operatorè¯¦ç»†é…ç½®)
    - [8.1 Crunchy Operatorå®Œæ•´é…ç½®](#81-crunchy-operatorå®Œæ•´é…ç½®)
    - [8.2 Zalando Operatoré…ç½®](#82-zalando-operatoré…ç½®)
    - [8.3 å¤‡ä»½å’Œæ¢å¤é…ç½®](#83-å¤‡ä»½å’Œæ¢å¤é…ç½®)
    - [8.4 ç›‘æ§å’Œå‘Šè­¦é…ç½®](#84-ç›‘æ§å’Œå‘Šè­¦é…ç½®)
  - [9. é«˜å¯ç”¨é…ç½®](#9-é«˜å¯ç”¨é…ç½®)
    - [9.1 Patronié›†æˆé…ç½®](#91-patronié›†æˆé…ç½®)
    - [9.2 etcdé…ç½®](#92-etcdé…ç½®)
    - [9.3 æ•…éšœè½¬ç§»é…ç½®](#93-æ•…éšœè½¬ç§»é…ç½®)
    - [9.4 è‡ªåŠ¨æ¢å¤é…ç½®](#94-è‡ªåŠ¨æ¢å¤é…ç½®)
  - [10. ç›‘æ§å’Œè¿ç»´](#10-ç›‘æ§å’Œè¿ç»´)
    - [10.1 Prometheusç›‘æ§é…ç½®](#101-prometheusç›‘æ§é…ç½®)
    - [10.2 Grafanaä»ªè¡¨æ¿é…ç½®](#102-grafanaä»ªè¡¨æ¿é…ç½®)
    - [10.3 å‘Šè­¦è§„åˆ™é…ç½®](#103-å‘Šè­¦è§„åˆ™é…ç½®)
    - [10.4 æ—¥å¿—æ”¶é›†é…ç½®](#104-æ—¥å¿—æ”¶é›†é…ç½®)
  - [11. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­](#11-æ•…éšœæ’æŸ¥å’Œè¯Šæ–­)
    - [11.1 Podå¯åŠ¨é—®é¢˜æ’æŸ¥](#111-podå¯åŠ¨é—®é¢˜æ’æŸ¥)
    - [11.2 å­˜å‚¨é—®é¢˜æ’æŸ¥](#112-å­˜å‚¨é—®é¢˜æ’æŸ¥)
    - [11.3 ç½‘ç»œé—®é¢˜æ’æŸ¥](#113-ç½‘ç»œé—®é¢˜æ’æŸ¥)
    - [11.4 æ€§èƒ½é—®é¢˜è¯Šæ–­](#114-æ€§èƒ½é—®é¢˜è¯Šæ–­)
  - [12. å¤‡ä»½ä¸æ¢å¤](#12-å¤‡ä»½ä¸æ¢å¤)
    - [12.1 ä½¿ç”¨ pgBackRest](#121-ä½¿ç”¨-pgbackrest)
    - [12.2 æ¢å¤å¤‡ä»½](#122-æ¢å¤å¤‡ä»½)
    - [12.3 è‡ªåŠ¨å¤‡ä»½é…ç½®](#123-è‡ªåŠ¨å¤‡ä»½é…ç½®)
  - [13. æ·±å…¥é˜…è¯»](#13-æ·±å…¥é˜…è¯»)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

åœ¨ Kubernetes ä¸Šéƒ¨ç½² PostgreSQL æœ‰å¤šç§æ–¹å¼ï¼š

- **PostgreSQL Operator**: è‡ªåŠ¨åŒ–ç®¡ç† PostgreSQL é›†ç¾¤ï¼ˆæ¨èï¼‰
- **StatefulSet**: æ‰‹åŠ¨ç®¡ç† PostgreSQL å®ä¾‹
- **Helm Chart**: ä½¿ç”¨ Helm éƒ¨ç½² PostgreSQL

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| ç”Ÿäº§ç¯å¢ƒ | PostgreSQL Operator | è‡ªåŠ¨åŒ–ç®¡ç†ã€é«˜å¯ç”¨ã€å¤‡ä»½æ¢å¤ |
| å¼€å‘æµ‹è¯• | Helm Chart | å¿«é€Ÿéƒ¨ç½²ã€ç®€å•é…ç½® |
| è‡ªå®šä¹‰éœ€æ±‚ | StatefulSet | å®Œå…¨æ§åˆ¶ã€çµæ´»é…ç½® |

---

## 2. ä½¿ç”¨ PostgreSQL Operator

### 2.1 å®‰è£… Crunchy PostgreSQL Operator

```bash
# æ·»åŠ  Helm ä»“åº“
helm repo add postgres-operator https://opensource.crunchydata.com/postgres-operator
helm repo update

# å®‰è£… Operator
helm install postgres-operator postgres-operator/postgres-operator \
  --namespace postgres-operator \
  --create-namespace
```

### 2.2 åˆ›å»º PostgreSQL é›†ç¾¤

```yaml
# postgres-cluster.yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 3
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 2000m
      dataVolumeClaimSpec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
  proxy:
    pgBouncer:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.19-0
      replicas: 2
      resources:
        requests:
          memory: 64Mi
          cpu: 100m
```

```bash
# åº”ç”¨é…ç½®
kubectl apply -f postgres-cluster.yaml

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl get postgresclusters -n postgres
```

### 2.3 è¿æ¥æ•°æ®åº“

```bash
# è·å–è¿æ¥ä¿¡æ¯
kubectl get secrets postgres-cluster-pguser-postgres -n postgres -o jsonpath='{.data.password}' | base64 -d

# ç«¯å£è½¬å‘
kubectl port-forward -n postgres svc/postgres-cluster-pgbouncer 5432:5432

# è¿æ¥
psql -h localhost -U postgres -d postgres
```

---

## 3. ä½¿ç”¨ StatefulSet

### 3.1 åˆ›å»º ConfigMap

```yaml
# postgres-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: postgres
data:
  postgresql.conf: |
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 4MB
    min_wal_size = 1GB
    max_wal_size = 4GB
```

### 3.2 åˆ›å»º Secret

```yaml
# postgres-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: postgres
type: Opaque
stringData:
  postgres-password: "your-secure-password"
  replication-password: "your-replication-password"
```

### 3.3 åˆ›å»º StatefulSet

```yaml
# postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: POSTGRES_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 3.4 åˆ›å»º Service

```yaml
# postgres-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-read
  namespace: postgres
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
```

---

## 4. é«˜å¯ç”¨é…ç½®

### 4.1 ä½¿ç”¨ Patroni

```yaml
# patroni-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: patroni-config
  namespace: postgres
data:
  patroni.yml: |
    scope: postgres
    namespace: /service/postgres
    name: ${POD_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${POD_IP}:8008

    etcd:
      hosts: etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 30
        maximum_lag_on_failover: 1048576
        postgresql:
          use_pg_rewind: true
          parameters:
            wal_level: replica
            hot_standby: "on"
            max_connections: 100
            max_wal_senders: 10
            wal_keep_size: 1GB
            max_replication_slots: 10

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${POD_IP}:5432
      data_dir: /var/lib/postgresql/data/pgdata
      pgpass: /tmp/pgpass
      authentication:
        replication:
          username: replicator
          password: ${REPLICATION_PASSWORD}
        superuser:
          username: postgres
          password: ${POSTGRES_PASSWORD}
      parameters:
        unix_socket_directories: '/var/run/postgresql'
```

### 4.2 é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»

```yaml
# åœ¨ Patroni é…ç½®ä¸­æ·»åŠ 
bootstrap:
  dcs:
    master_start_timeout: 300
    master_stop_timeout: 0
    postgresql:
      use_slots: true
      parameters:
        synchronous_commit: "on"
        synchronous_standby_names: "ANY 1 (standby1,standby2)"
```

---

## 5. å­˜å‚¨é…ç½®

### 5.1 ä½¿ç”¨ PersistentVolume

```yaml
# pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: fast-ssd
  hostPath:
    path: /data/postgres
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: postgres
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: fast-ssd
```

### 5.2 ä½¿ç”¨ StorageClass

```yaml
# storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

---

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 ä½¿ç”¨ Prometheus Operator

```yaml
# postgres-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
  - port: postgres
    interval: 30s
    path: /metrics
```

### 6.2 é…ç½®æ—¥å¿—æ”¶é›†

```yaml
# åœ¨ StatefulSet ä¸­æ·»åŠ  sidecar
containers:
- name: postgres-exporter
  image: prometheuscommunity/postgres-exporter
  env:
  - name: DATA_SOURCE_NAME
    value: "postgresql://postgres:password@localhost:5432/postgres?sslmode=disable"
  ports:
  - containerPort: 9187
    name: metrics
```

---

## 7. å¤‡ä»½ä¸æ¢å¤

### 7.1 ä½¿ç”¨ pgBackRest

```yaml
# åœ¨ PostgreSQL Operator ä¸­å·²åŒ…å« pgBackRest
# æ‰‹åŠ¨é…ç½®å¤‡ä»½
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: postgres
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: postgres:18
            command:
            - /bin/bash
            - -c
            - |
              pg_dump -h postgres -U postgres -Fc postgres > /backup/postgres-$(date +%Y%m%d).dump
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
          restartPolicy: OnFailure
```

### 7.2 æ¢å¤å¤‡ä»½

```bash
# ä»å¤‡ä»½æ¢å¤
kubectl exec -it postgres-0 -n postgres -- \
  pg_restore -h localhost -U postgres -d postgres /backup/postgres-20251113.dump
```

---

## 7. ç”Ÿäº§çº§StatefulSeté…ç½®

### 7.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®

**ç”Ÿäº§çº§StatefulSeté…ç½®**:

```yaml
# postgres-statefulset-prod.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
  labels:
    app: postgres
    version: "18"
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
        version: "18"
    spec:
      # å®‰å…¨ä¸Šä¸‹æ–‡
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      # æœåŠ¡è´¦æˆ·
      serviceAccountName: postgres

      # åˆå§‹åŒ–å®¹å™¨ï¼ˆæ•°æ®ç›®å½•æƒé™ä¿®å¤ï¼‰
      initContainers:
      - name: init-postgres
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          chown -R 999:999 /var/lib/postgresql/data
          chmod 700 /var/lib/postgresql/data
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data

      containers:
      - name: postgres
        image: postgres:18
        imagePullPolicy: IfNotPresent

        # ç¯å¢ƒå˜é‡
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: POSTGRES_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_DB
          value: "mydb"
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF8 --locale=C --data-checksums"

        # ç«¯å£
        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP

        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"

        # å·æŒ‚è½½
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
          readOnly: true
        - name: postgres-hba
          mountPath: /etc/postgresql/pg_hba.conf
          subPath: pg_hba.conf
          readOnly: true

        # å¥åº·æ£€æŸ¥
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres -d mydb
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres -d mydb
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3

        # å¯åŠ¨å‘½ä»¤
        command:
        - postgres
        - -c
        - config_file=/etc/postgresql/postgresql.conf
        - -c
        - hba_file=/etc/postgresql/pg_hba.conf

        # å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
          readOnlyRootFilesystem: false
          runAsUser: 999
          runAsGroup: 999
          runAsNonRoot: true

      # å·
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-config
      - name: postgres-hba
        configMap:
          name: postgres-hba-config

      # äº²å’Œæ€§
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - postgres
              topologyKey: kubernetes.io/hostname

      # å®¹å¿åº¦
      tolerations:
      - key: "database"
        operator: "Equal"
        value: "postgres"
        effect: "NoSchedule"

  # æŒä¹…åŒ–å·å£°æ˜æ¨¡æ¿
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
```

**ç”Ÿäº§çº§ConfigMapé…ç½®**:

```yaml
# postgres-config-prod.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: postgres
data:
  postgresql.conf: |
    # ============================================
    # è¿æ¥è®¾ç½®
    # ============================================
    listen_addresses = '*'
    port = 5432
    max_connections = 500
    superuser_reserved_connections = 10

    # ============================================
    # å†…å­˜è®¾ç½®
    # ============================================
    shared_buffers = 2GB
    effective_cache_size = 6GB
    work_mem = 16MB
    maintenance_work_mem = 512MB
    temp_buffers = 16MB

    # ============================================
    # WALè®¾ç½®
    # ============================================
    wal_level = replica
    min_wal_size = 1GB
    max_wal_size = 4GB
    checkpoint_completion_target = 0.9
    checkpoint_timeout = 15min
    wal_compression = on
    wal_buffers = 16MB

    # ============================================
    # I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
    # ============================================
    random_page_cost = 1.1
    effective_io_concurrency = 200
    io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
    io_combine_limit = 128              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
    maintenance_io_workers = 4          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
    max_io_workers = 10                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

    # ============================================
    # å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
    # ============================================
    max_parallel_workers_per_gather = 4
    max_parallel_workers = 8
    max_parallel_maintenance_workers = 4
    parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ

    # ============================================
    # æ—¥å¿—è®¾ç½®
    # ============================================
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 500
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on
    log_temp_files = 0

    # ============================================
    # è‡ªåŠ¨æ¸…ç†
    # ============================================
    autovacuum = on
    autovacuum_max_workers = 4
    autovacuum_naptime = 30s
    autovacuum_vacuum_scale_factor = 0.1
    autovacuum_analyze_scale_factor = 0.05
```

### 7.2 èµ„æºé™åˆ¶å’Œä¼˜åŒ–

**èµ„æºé™åˆ¶é…ç½®**:

```yaml
# åœ¨StatefulSetä¸­é…ç½®èµ„æºé™åˆ¶
resources:
  requests:
    memory: "4Gi"
    cpu: "2"
  limits:
    memory: "8Gi"
    cpu: "4"
```

**HPAè‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®**:

```yaml
# postgres-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
  namespace: postgres
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 3
  maxReplicas: 6
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Max
```

### 7.3 æ»šåŠ¨æ›´æ–°ç­–ç•¥

**æ»šåŠ¨æ›´æ–°é…ç½®**:

```yaml
# åœ¨StatefulSetä¸­é…ç½®æ›´æ–°ç­–ç•¥
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0  # ä»ç¬¬0ä¸ªPodå¼€å§‹æ›´æ–°
      maxUnavailable: 1  # æœ€å¤š1ä¸ªPodä¸å¯ç”¨
```

**é‡‘ä¸é›€å‘å¸ƒé…ç½®**:

```yaml
# å…ˆæ›´æ–°ä¸€ä¸ªPodè¿›è¡Œæµ‹è¯•
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 2  # åªæ›´æ–°postgres-2ï¼Œä¿ç•™postgres-0å’Œpostgres-1

# æµ‹è¯•é€šè¿‡åï¼Œé€æ­¥æ›´æ–°å…¶ä»–Pod
# partition: 1  # æ›´æ–°postgres-1å’Œpostgres-2
# partition: 0  # æ›´æ–°æ‰€æœ‰Pod
```

### 7.4 ç½‘ç»œç­–ç•¥é…ç½®

**ç½‘ç»œç­–ç•¥é…ç½®**:

```yaml
# postgres-network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: postgres
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # å…è®¸æ¥è‡ªåŒä¸€å‘½åç©ºé—´çš„Podè®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: postgres
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # å…è®¸æ¥è‡ªåº”ç”¨å‘½åç©ºé—´çš„Podè®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: application
    - podSelector:
        matchLabels:
          app: myapp
    ports:
    - protocol: TCP
      port: 5432
  egress:
  # å…è®¸DNSæŸ¥è¯¢
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # å…è®¸è®¿é—®etcdï¼ˆç”¨äºPatroniï¼‰
  - to:
    - podSelector:
        matchLabels:
          app: etcd
    ports:
    - protocol: TCP
      port: 2379
```

## 8. PostgreSQL Operatorè¯¦ç»†é…ç½®

### 8.1 Crunchy Operatorå®Œæ•´é…ç½®

**å®Œæ•´çš„PostgresClusteré…ç½®**:

```yaml
# postgres-cluster-prod.yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18

  # å®ä¾‹é…ç½®
  instances:
  - name: instance1
    replicas: 3
    resources:
      requests:
        memory: 4Gi
        cpu: 2
      limits:
        memory: 8Gi
        cpu: 4
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast-ssd

    # è‡ªå®šä¹‰PostgreSQLé…ç½®
    postgresql:
      parameters:
        max_connections: "500"
        shared_buffers: "2GB"
        effective_cache_size: "6GB"
        work_mem: "16MB"
        maintenance_work_mem: "512MB"
        wal_level: "replica"
        max_wal_size: "4GB"
        min_wal_size: "1GB"
        checkpoint_completion_target: "0.9"
        # PostgreSQL 18æ–°ç‰¹æ€§
        io_method: "aio"
        io_combine_limit: "128"
        maintenance_io_workers: "4"
        max_io_workers: "10"
        parallel_leader_participation: "on"

    # äº²å’Œæ€§é…ç½®
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: postgres-operator.crunchydata.com/cluster
                operator: In
                values:
                - postgres-cluster
            topologyKey: kubernetes.io/hostname

  # å¤‡ä»½é…ç½®
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 200Gi
            storageClassName: fast-ssd
      global:
        repo1-retention-full: "7"
        repo1-retention-full-type: "count"
        repo1-retention-diff: "3"
        repo1-retention-archive: "7"
      schedules:
        full: "0 2 * * 0"      # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å…¨é‡å¤‡ä»½
        incremental: "0 2 * * *" # æ¯å¤©å‡Œæ™¨2ç‚¹å¢é‡å¤‡ä»½

  # ä»£ç†é…ç½®ï¼ˆPgBouncerï¼‰
  proxy:
    pgBouncer:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.19-0
      replicas: 2
      resources:
        requests:
          memory: 128Mi
          cpu: 100m
        limits:
          memory: 256Mi
          cpu: 500m
      config:
        global:
          pool_mode: transaction
          max_client_conn: 1000
          default_pool_size: 25
          min_pool_size: 5
          reserve_pool_size: 5
          reserve_pool_timeout: 3
          max_db_connections: 100
          max_user_connections: 100

  # ç›‘æ§é…ç½®
  monitoring:
    pgMonitor:
      exporter:
        image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres-exporter:ubi8-5.0.0-0
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 200m
```

### 8.2 Zalando Operatoré…ç½®

**Zalando Postgres Operatoré…ç½®**:

```yaml
# postgres-operator-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-operator
  namespace: postgres-operator
data:
  # é›†ç¾¤é…ç½®
  cluster_name_label: "cluster-name"
  cluster_labels: "application:spilo"
  db_hosted_zone: "db.example.com"

  # èµ„æºé…ç½®
  pod_terminate_grace_period: "300"
  pod_service_account_definition: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: zalando-postgres
      namespace: postgres

  # å­˜å‚¨é…ç½®
  storage_resize_mode: "pvc"
  enable_pod_antiaffinity: "true"
  pod_antiaffinity_topology_key: "kubernetes.io/hostname"

  # å¤‡ä»½é…ç½®
  enable_master_load_balancer: "true"
  enable_replica_load_balancer: "true"

  # ç›‘æ§é…ç½®
  enable_pg_rewind: "true"
  enable_master_pooler_load_balancer: "true"
  enable_replica_pooler_load_balancer: "true"

---
# postgres-cluster-zalando.yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  teamId: "myteam"
  volume:
    size: 100Gi
    storageClass: fast-ssd

  numberOfInstances: 3

  users:
    zalando:
    - superuser
    - createdb

  databases:
    foo: zalando

  postgresql:
    version: "18"
    parameters:
      max_connections: "500"
      shared_buffers: "2GB"
      effective_cache_size: "6GB"
      work_mem: "16MB"
      maintenance_work_mem: "512MB"
      # PostgreSQL 18æ–°ç‰¹æ€§
      io_method: "aio"
      io_combine_limit: "128"
      maintenance_io_workers: "4"
      max_io_workers: "10"

  resources:
    requests:
      cpu: 2
      memory: 4Gi
    limits:
      cpu: 4
      memory: 8Gi

  enableMasterLoadBalancer: true
  enableReplicaLoadBalancer: true

  enableMasterPoolerLoadBalancer: true
  enableReplicaPoolerLoadBalancer: true

  connectionPooler:
    numberOfInstances: 2
    mode: transaction
    schema: pooler
    user: pooler
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
```

### 8.3 å¤‡ä»½å’Œæ¢å¤é…ç½®

**ä½¿ç”¨Crunchy Operatorçš„å¤‡ä»½é…ç½®**:

```yaml
# åœ¨PostgresClusterä¸­é…ç½®å¤‡ä»½
spec:
  backups:
    pgbackrest:
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 200Gi
      schedules:
        full: "0 2 * * 0"      # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å…¨é‡å¤‡ä»½
        incremental: "0 2 * * *" # æ¯å¤©å‡Œæ™¨2ç‚¹å¢é‡å¤‡ä»½
      global:
        repo1-retention-full: "7"
        repo1-retention-full-type: "count"
        repo1-retention-diff: "3"
        repo1-retention-archive: "7"
```

**æ‰‹åŠ¨å¤‡ä»½Job**:

```yaml
# postgres-backup-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-backup
  namespace: postgres
spec:
  template:
    spec:
      containers:
      - name: backup
        image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
        command:
        - pgbackrest
        - backup
        - --type=full
        - --stanza=db
        env:
        - name: PGBACKREST_REPO1_PATH
          value: "/backup/repo1"
        - name: PGBACKREST_DB_PATH
          value: "/var/lib/postgresql/data/pgdata"
        volumeMounts:
        - name: backup-storage
          mountPath: /backup
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
          readOnly: true
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: postgres-backup-pvc
      - name: postgres-data
        persistentVolumeClaim:
          claimName: postgres-cluster-instance1-pgdata-postgres-cluster-instance1-0
      restartPolicy: Never
```

### 8.4 ç›‘æ§å’Œå‘Šè­¦é…ç½®

**ServiceMonitoré…ç½®**:

```yaml
# postgres-servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: postgres
  labels:
    app: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    scheme: http
```

**PrometheusRuleå‘Šè­¦é…ç½®**:

```yaml
# postgres-alerts.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-alerts
  namespace: postgres
spec:
  groups:
  - name: postgres
    interval: 30s
    rules:
    - alert: PostgreSQLDown
      expr: pg_up == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL instance is down"
        description: "PostgreSQL instance {{ $labels.instance }} is down"

    - alert: PostgreSQLHighConnections
      expr: pg_stat_database_numbackends{datname="mydb"} > 400
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL connection count is high"
        description: "PostgreSQL has {{ $value }} connections, threshold is 400"

    - alert: PostgreSQLSlowQueries
      expr: rate(pg_stat_statements_mean_exec_time[5m]) > 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL slow queries detected"
        description: "Query mean execution time is {{ $value }}s"

    - alert: PostgreSQLReplicationLag
      expr: pg_replication_lag > 10485760  # 10MB
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL replication lag is high"
        description: "Replication lag is {{ $value }} bytes"
```

## 9. é«˜å¯ç”¨é…ç½®

### 9.1 Patronié›†æˆé…ç½®

**å®Œæ•´çš„Patroni StatefulSeté…ç½®**:

```yaml
# patroni-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: patroni-postgres
  namespace: postgres
spec:
  serviceName: patroni-postgres
  replicas: 3
  selector:
    matchLabels:
      app: patroni-postgres
  template:
    metadata:
      labels:
        app: patroni-postgres
    spec:
      serviceAccountName: patroni
      containers:
      - name: patroni
        image: patroni/patroni:latest
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: PATRONI_SCOPE
          value: "postgres"
        - name: PATRONI_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PATRONI_NAMESPACE
          value: "/service/postgres"
        - name: PATRONI_LOGLEVEL
          value: "INFO"
        - name: PATRONI_ETCD_HOSTS
          value: "etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379"
        - name: PATRONI_POSTGRESQL_LISTEN
          value: "0.0.0.0:5432"
        - name: PATRONI_POSTGRESQL_CONNECT_ADDRESS
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: PATRONI_POSTGRESQL_DATA_DIR
          value: "/var/lib/postgresql/data/pgdata"
        - name: PATRONI_POSTGRESQL_PGPASS
          value: "/tmp/pgpass"
        - name: PATRONI_SUPERUSER_USERNAME
          value: "postgres"
        - name: PATRONI_SUPERUSER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: PATRONI_REPLICATION_USERNAME
          value: "replicator"
        - name: PATRONI_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        ports:
        - name: postgres
          containerPort: 5432
        - name: patroni
          containerPort: 8008
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: patroni-config
          mountPath: /etc/patroni
        livenessProbe:
          httpGet:
            path: /liveness
            port: 8008
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /readiness
            port: 8008
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: patroni-config
        configMap:
          name: patroni-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
```

**Patroni ConfigMapé…ç½®**:

```yaml
# patroni-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: patroni-config
  namespace: postgres
data:
  patroni.yml: |
    scope: postgres
    namespace: /service/postgres
    name: ${PATRONI_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${PATRONI_POSTGRESQL_CONNECT_ADDRESS}:8008

    etcd:
      hosts: ${PATRONI_ETCD_HOSTS}

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 30
        maximum_lag_on_failover: 10485760  # 10MB
        postgresql:
          use_pg_rewind: true
          use_slots: true
          parameters:
            wal_level: replica
            hot_standby: "on"
            max_connections: 500
            max_wal_senders: 10
            wal_keep_size: 1GB
            max_replication_slots: 10
            synchronous_commit: "on"
            synchronous_standby_names: "ANY 1 (patroni-postgres-1,patroni-postgres-2)"

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${PATRONI_POSTGRESQL_CONNECT_ADDRESS}:5432
      data_dir: ${PATRONI_POSTGRESQL_DATA_DIR}
      pgpass: ${PATRONI_POSTGRESQL_PGPASS}
      authentication:
        replication:
          username: ${PATRONI_REPLICATION_USERNAME}
          password: ${PATRONI_REPLICATION_PASSWORD}
        superuser:
          username: ${PATRONI_SUPERUSER_USERNAME}
          password: ${PATRONI_SUPERUSER_PASSWORD}
      parameters:
        unix_socket_directories: '/var/run/postgresql'
        # PostgreSQL 18æ–°ç‰¹æ€§
        io_method: aio
        io_combine_limit: 128
        maintenance_io_workers: 4
        max_io_workers: 10
        parallel_leader_participation: on
```

### 9.2 etcdé…ç½®

**etcd StatefulSeté…ç½®**:

```yaml
# etcd-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: etcd
  namespace: postgres
spec:
  serviceName: etcd
  replicas: 3
  selector:
    matchLabels:
      app: etcd
  template:
    metadata:
      labels:
        app: etcd
    spec:
      containers:
      - name: etcd
        image: quay.io/coreos/etcd:v3.5.0
        command:
        - /usr/local/bin/etcd
        - --name=$(POD_NAME)
        - --data-dir=/var/lib/etcd
        - --listen-client-urls=http://0.0.0.0:2379
        - --advertise-client-urls=http://$(POD_NAME).etcd:2379
        - --listen-peer-urls=http://0.0.0.0:2380
        - --initial-advertise-peer-urls=http://$(POD_NAME).etcd:2380
        - --initial-cluster=etcd-0=http://etcd-0.etcd:2380,etcd-1=http://etcd-1.etcd:2380,etcd-2=http://etcd-2.etcd:2380
        - --initial-cluster-state=new
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        ports:
        - name: client
          containerPort: 2379
        - name: peer
          containerPort: 2380
        volumeMounts:
        - name: etcd-storage
          mountPath: /var/lib/etcd
  volumeClaimTemplates:
  - metadata:
      name: etcd-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi
```

### 9.3 æ•…éšœè½¬ç§»é…ç½®

**æ•…éšœè½¬ç§»æµ‹è¯•**:

```bash
# 1. æŸ¥çœ‹å½“å‰ä¸»åº“
kubectl exec -it patroni-postgres-0 -n postgres -- \
  patronictl -c /etc/patroni/patroni.yml list

# 2. æ¨¡æ‹Ÿä¸»åº“æ•…éšœï¼ˆåˆ é™¤ä¸»åº“Podï¼‰
kubectl delete pod patroni-postgres-0 -n postgres

# 3. è§‚å¯Ÿæ•…éšœè½¬ç§»è¿‡ç¨‹
kubectl get pods -n postgres -w

# 4. éªŒè¯æ–°ä¸»åº“
kubectl exec -it patroni-postgres-1 -n postgres -- \
  patronictl -c /etc/patroni/patroni.yml list
```

### 9.4 è‡ªåŠ¨æ¢å¤é…ç½®

**è‡ªåŠ¨æ¢å¤é…ç½®**:

```yaml
# åœ¨Patronié…ç½®ä¸­å¯ç”¨è‡ªåŠ¨æ¢å¤
bootstrap:
  dcs:
    postgresql:
      use_pg_rewind: true
      recovery_conf:
        restore_command: 'cp /var/lib/postgresql/wal_archive/%f %p'
```

## 10. ç›‘æ§å’Œè¿ç»´

### 10.1 Prometheusç›‘æ§é…ç½®

**å®Œæ•´çš„Prometheusé…ç½®**:

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
    - job_name: 'postgres'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - postgres
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: postgres
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        action: keep
        regex: metrics
```

### 10.2 Grafanaä»ªè¡¨æ¿é…ç½®

**Grafanaæ•°æ®æºé…ç½®**:

```yaml
# grafana-datasource.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource
  namespace: monitoring
data:
  datasource.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus:9090
      isDefault: true
```

### 10.3 å‘Šè­¦è§„åˆ™é…ç½®

**å‘Šè­¦è§„åˆ™å·²åœ¨8.4èŠ‚ä¸­é…ç½®**:

### 10.4 æ—¥å¿—æ”¶é›†é…ç½®

**ä½¿ç”¨Fluentdæ”¶é›†æ—¥å¿—**:

```yaml
# fluentd-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: logging
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.logging.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

## 11. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­

### 11.1 Podå¯åŠ¨é—®é¢˜æ’æŸ¥

**Podå¯åŠ¨é—®é¢˜æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n postgres

# 2. æŸ¥çœ‹Podè¯¦ç»†ä¿¡æ¯
kubectl describe pod postgres-0 -n postgres

# 3. æŸ¥çœ‹Podæ—¥å¿—
kubectl logs postgres-0 -n postgres
kubectl logs postgres-0 -n postgres --previous  # æŸ¥çœ‹ä¹‹å‰å®¹å™¨çš„æ—¥å¿—

# 4. è¿›å…¥Podè°ƒè¯•
kubectl exec -it postgres-0 -n postgres -- bash

# 5. æ£€æŸ¥äº‹ä»¶
kubectl get events -n postgres --sort-by='.lastTimestamp'

# 6. æ£€æŸ¥èµ„æºä½¿ç”¨
kubectl top pod postgres-0 -n postgres
```

**å¸¸è§å¯åŠ¨é—®é¢˜**:

```bash
# é—®é¢˜1: Podä¸€ç›´å¤„äºPendingçŠ¶æ€
# åŸå› : èµ„æºä¸è¶³æˆ–è°ƒåº¦é—®é¢˜
# è§£å†³: æ£€æŸ¥èŠ‚ç‚¹èµ„æº
kubectl describe node <node-name>
kubectl get nodes

# é—®é¢˜2: Podä¸€ç›´å¤„äºCrashLoopBackOffçŠ¶æ€
# åŸå› : å®¹å™¨å¯åŠ¨å¤±è´¥
# è§£å†³: æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºé”™è¯¯
kubectl logs postgres-0 -n postgres --previous

# é—®é¢˜3: Podæ— æ³•æŒ‚è½½å·
# åŸå› : PVCæœªåˆ›å»ºæˆ–å­˜å‚¨ç±»é—®é¢˜
# è§£å†³: æ£€æŸ¥PVCçŠ¶æ€
kubectl get pvc -n postgres
kubectl describe pvc postgres-storage-postgres-0 -n postgres
```

### 11.2 å­˜å‚¨é—®é¢˜æ’æŸ¥

**å­˜å‚¨é—®é¢˜æ’æŸ¥**:

```bash
# 1. æ£€æŸ¥PVCçŠ¶æ€
kubectl get pvc -n postgres

# 2. æ£€æŸ¥PVçŠ¶æ€
kubectl get pv

# 3. æ£€æŸ¥å­˜å‚¨ç±»
kubectl get storageclass

# 4. æ£€æŸ¥æ•°æ®ç›®å½•
kubectl exec -it postgres-0 -n postgres -- ls -la /var/lib/postgresql/data

# 5. æ£€æŸ¥ç£ç›˜ä½¿ç”¨
kubectl exec -it postgres-0 -n postgres -- df -h /var/lib/postgresql/data
```

### 11.3 ç½‘ç»œé—®é¢˜æ’æŸ¥

**ç½‘ç»œé—®é¢˜æ’æŸ¥**:

```bash
# 1. æ£€æŸ¥Service
kubectl get svc -n postgres
kubectl describe svc postgres -n postgres

# 2. æ£€æŸ¥Endpoint
kubectl get endpoints -n postgres

# 3. æµ‹è¯•Podé—´è¿æ¥
kubectl exec -it postgres-0 -n postgres -- ping -c 3 postgres-1.postgres

# 4. æµ‹è¯•Serviceè¿æ¥
kubectl exec -it postgres-0 -n postgres -- psql -h postgres -U postgres -d mydb

# 5. æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicies -n postgres
kubectl describe networkpolicy postgres-network-policy -n postgres
```

### 11.4 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# scripts/k8s_performance_diagnosis.sh

echo "=== Kubernetes PostgreSQLæ€§èƒ½è¯Šæ–­ ==="

# 1. Podèµ„æºä½¿ç”¨
echo "=== Podèµ„æºä½¿ç”¨ ==="
kubectl top pods -n postgres

# 2. èŠ‚ç‚¹èµ„æºä½¿ç”¨
echo "=== èŠ‚ç‚¹èµ„æºä½¿ç”¨ ==="
kubectl top nodes

# 3. æ•°æ®åº“è¿æ¥æ•°
echo "=== æ•°æ®åº“è¿æ¥æ•° ==="
kubectl exec -it postgres-0 -n postgres -- \
  psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 4. æ…¢æŸ¥è¯¢
echo "=== æ…¢æŸ¥è¯¢Top 10 ==="
kubectl exec -it postgres-0 -n postgres -- \
  psql -U postgres -c "SELECT query, calls, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# 5. è¡¨å¤§å°
echo "=== è¡¨å¤§å°Top 10 ==="
kubectl exec -it postgres-0 -n postgres -- \
  psql -U postgres -c "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_stat_user_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;"
```

## 12. å¤‡ä»½ä¸æ¢å¤

### 12.1 ä½¿ç”¨ pgBackRest

**pgBackResté…ç½®å·²åœ¨8.3èŠ‚ä¸­è¯´æ˜**:

### 12.2 æ¢å¤å¤‡ä»½

**ä»å¤‡ä»½æ¢å¤**:

```bash
# 1. æŸ¥çœ‹å¯ç”¨å¤‡ä»½
kubectl exec -it postgres-cluster-instance1-0 -n postgres -- \
  pgbackrest info --stanza=db

# 2. æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
kubectl exec -it postgres-cluster-instance1-0 -n postgres -- \
  pgbackrest restore --stanza=db --type=time --target="2025-01-16 12:00:00"

# 3. æ¢å¤åˆ°æœ€æ–°å¤‡ä»½
kubectl exec -it postgres-cluster-instance1-0 -n postgres -- \
  pgbackrest restore --stanza=db --type=immediate
```

### 12.3 è‡ªåŠ¨å¤‡ä»½é…ç½®

**è‡ªåŠ¨å¤‡ä»½å·²åœ¨8.3èŠ‚ä¸­é…ç½®**:

---

## 13. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [äº‘åŸç”Ÿä¸å®¹å™¨åŒ–](./05.12-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–.md) - äº‘åŸç”Ÿæ¶æ„
- â­â­â­ [Docker éƒ¨ç½²æŒ‡å—](./05.12-Dockeréƒ¨ç½².md) - Dockeréƒ¨ç½²
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­ [Serverlesséƒ¨ç½²](./05.15-Serverlesséƒ¨ç½².md) - Serverlessæ¶æ„

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­â­ [å¤‡ä»½ä¸æ¢å¤](../../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

### å¤–éƒ¨èµ„æº

- [Crunchy PostgreSQL Operator æ–‡æ¡£](https://access.crunchydata.com/documentation/postgres-operator/)
- [Kubernetes StatefulSet æ–‡æ¡£](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)
- [PostgreSQL on Kubernetes æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/)

---

**æœ€åæ›´æ–°**: 2025-11-13
