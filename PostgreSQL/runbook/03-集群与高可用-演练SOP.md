# 集群与高可用-演练SOP（Runbook）

参考：`04-部署运维/04.02-集群部署与高可用.md`

## 1. 目标

- 定期演练主故障切换，验证 RTO/RPO，确保读写分离策略有效。

## 2. 演练准备

- Patroni/etcd 集群健康；复制延迟 < 阈值；读写 VIP 配置正常；
- 业务灰度与只读副本路由策略确认；备份/回滚方案。

## 3. 步骤

1) 触发主下线（演练环境）：暂停/停止主节点服务；
2) 观察Leader 选举与复制追赶；
3) 验证：
   - 写连接是否切到新主（主写 VIP）；
   - 读连接是否仅路由到只读；
4) 旧主恢复为副本：基于 `pg_basebackup` 或增量追日志恢复；
5) 验证复制延迟、业务错误率。

## 4. 回滚与复盘

- 异常则回切到原主（必要时手动 promote/demote），记录时间线与延迟；
- 输出演练报告：步骤用时、RTO/RPO、问题与改进项。
