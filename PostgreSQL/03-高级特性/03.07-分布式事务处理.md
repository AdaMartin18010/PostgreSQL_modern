# PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­â­
> **åº”ç”¨åœºæ™¯**: åˆ†å¸ƒå¼æ•°æ®åº“ã€è·¨èŠ‚ç‚¹äº‹åŠ¡ã€å¾®æœåŠ¡äº‹åŠ¡ã€åˆ†å¸ƒå¼ç³»ç»Ÿ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†å®Œæ•´æŒ‡å—](#postgresqlåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µ](#11-åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µ)
    - [1.2 æ ¸å¿ƒæŒ‘æˆ˜](#12-æ ¸å¿ƒæŒ‘æˆ˜)
    - [1.3 PostgreSQLè§£å†³æ–¹æ¡ˆ](#13-postgresqlè§£å†³æ–¹æ¡ˆ)
    - [1.4 åº”ç”¨åœºæ™¯](#14-åº”ç”¨åœºæ™¯)
  - [2. åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€](#2-åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€)
    - [2.1 ACIDåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜](#21-acidåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜)
    - [2.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰](#22-ä¸¤é˜¶æ®µæäº¤2pc)
      - [2.2.1 é˜¶æ®µ1ï¼šå‡†å¤‡ï¼ˆPrepareï¼‰](#221-é˜¶æ®µ1å‡†å¤‡prepare)
      - [2.2.2 é˜¶æ®µ2ï¼šæäº¤ï¼ˆCommitï¼‰](#222-é˜¶æ®µ2æäº¤commit)
      - [2.2.3 2PCé—®é¢˜](#223-2pcé—®é¢˜)
    - [2.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰](#23-ä¸‰é˜¶æ®µæäº¤3pc)
    - [2.4 SAGAæ¨¡å¼](#24-sagaæ¨¡å¼)
      - [2.4.1 SAGAæ¨¡å¼ç±»å‹](#241-sagaæ¨¡å¼ç±»å‹)
      - [2.4.2 SAGAå®ç°ç¤ºä¾‹](#242-sagaå®ç°ç¤ºä¾‹)
      - [2.4.3 SAGAçŠ¶æ€ç®¡ç†](#243-sagaçŠ¶æ€ç®¡ç†)
    - [2.5 TCCæ¨¡å¼](#25-tccæ¨¡å¼)
    - [2.6 åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”](#26-åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”)
  - [ä¸‰ã€PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å®ç°](#ä¸‰postgresqlåˆ†å¸ƒå¼äº‹åŠ¡å®ç°)
    - [3.1 ä¸¤é˜¶æ®µæäº¤å®ç°](#31-ä¸¤é˜¶æ®µæäº¤å®ç°)
      - [3.1.1 åŸºæœ¬2PCå®ç°](#311-åŸºæœ¬2pcå®ç°)
      - [3.1.2 2PCåè°ƒå™¨å®ç°](#312-2pcåè°ƒå™¨å®ç°)
      - [3.1.3 æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡](#313-æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡)
    - [3.2 åˆ†å¸ƒå¼é”ç®¡ç†](#32-åˆ†å¸ƒå¼é”ç®¡ç†)
      - [3.2.1 Advisory Locks](#321-advisory-locks)
      - [3.2.2 åˆ†å¸ƒå¼é”å®ç°](#322-åˆ†å¸ƒå¼é”å®ç°)
    - [3.3 äº‹åŠ¡åè°ƒå™¨](#33-äº‹åŠ¡åè°ƒå™¨)
      - [3.3.1 åº”ç”¨å±‚åè°ƒå™¨](#331-åº”ç”¨å±‚åè°ƒå™¨)
      - [3.3.2 ä¸­é—´ä»¶åè°ƒå™¨](#332-ä¸­é—´ä»¶åè°ƒå™¨)
    - [3.4 å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼ˆFDWï¼‰åè°ƒ](#34-å¤–éƒ¨æ•°æ®åŒ…è£…å™¨fdwåè°ƒ)
  - [å››ã€Citusåˆ†å¸ƒå¼äº‹åŠ¡](#å››citusåˆ†å¸ƒå¼äº‹åŠ¡)
    - [4.1 Citusäº‹åŠ¡æ¨¡å‹](#41-citusäº‹åŠ¡æ¨¡å‹)
    - [4.2 è·¨åˆ†ç‰‡äº‹åŠ¡](#42-è·¨åˆ†ç‰‡äº‹åŠ¡)
      - [4.2.1 è·¨åˆ†ç‰‡æ›´æ–°](#421-è·¨åˆ†ç‰‡æ›´æ–°)
      - [4.2.2 è·¨åˆ†ç‰‡æ’å…¥](#422-è·¨åˆ†ç‰‡æ’å…¥)
    - [4.3 äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯](#43-äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯)
    - [4.4 æ€§èƒ½ä¼˜åŒ–](#44-æ€§èƒ½ä¼˜åŒ–)
  - [äº”ã€PostgreSQL 18ä¼˜åŒ–](#äº”postgresql-18ä¼˜åŒ–)
    - [5.1 å¼‚æ­¥I/Oä¼˜åŒ–](#51-å¼‚æ­¥ioä¼˜åŒ–)
    - [5.2 ç›‘æ§å¢å¼º](#52-ç›‘æ§å¢å¼º)
  - [å…­ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#å…­çŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [6.1 åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”](#61-åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”)
    - [6.2 å®ç°æ–¹æ¡ˆå¯¹æ¯”](#62-å®ç°æ–¹æ¡ˆå¯¹æ¯”)
  - [ä¸ƒã€æ•…éšœå¤„ç†ä¸æ¢å¤](#ä¸ƒæ•…éšœå¤„ç†ä¸æ¢å¤)
    - [7.1 æ•…éšœåœºæ™¯](#71-æ•…éšœåœºæ™¯)
      - [7.1.1 åè°ƒè€…æ•…éšœ](#711-åè°ƒè€…æ•…éšœ)
      - [7.1.2 å‚ä¸è€…æ•…éšœ](#712-å‚ä¸è€…æ•…éšœ)
      - [7.1.3 ç½‘ç»œåˆ†åŒº](#713-ç½‘ç»œåˆ†åŒº)
    - [7.2 æ¢å¤ç­–ç•¥](#72-æ¢å¤ç­–ç•¥)
      - [7.2.1 è‡ªåŠ¨æ¢å¤](#721-è‡ªåŠ¨æ¢å¤)
      - [7.2.2 æ‰‹åŠ¨æ¢å¤](#722-æ‰‹åŠ¨æ¢å¤)
    - [7.3 æ•…éšœæ¼”ç»ƒ](#73-æ•…éšœæ¼”ç»ƒ)
  - [å…«ã€å®è·µæ¡ˆä¾‹](#å…«å®è·µæ¡ˆä¾‹)
    - [8.1 ç”µå•†è®¢å•å¤„ç†](#81-ç”µå•†è®¢å•å¤„ç†)
    - [8.2 å¤šç§Ÿæˆ·æ•°æ®è¿ç§»](#82-å¤šç§Ÿæˆ·æ•°æ®è¿ç§»)
    - [8.3 å¾®æœåŠ¡äº‹åŠ¡åè°ƒ](#83-å¾®æœåŠ¡äº‹åŠ¡åè°ƒ)
  - [ä¹ã€æœ€ä½³å®è·µ](#ä¹æœ€ä½³å®è·µ)
    - [9.1 è®¾è®¡æœ€ä½³å®è·µ](#91-è®¾è®¡æœ€ä½³å®è·µ)
    - [9.2 å¼€å‘æœ€ä½³å®è·µ](#92-å¼€å‘æœ€ä½³å®è·µ)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 å®˜æ–¹æ–‡æ¡£](#101-å®˜æ–¹æ–‡æ¡£)
    - [10.2 ç›¸å…³æ–‡æ¡£](#102-ç›¸å…³æ–‡æ¡£)
  - [åä¸€ã€å‚è€ƒæ–‡çŒ®](#åä¸€å‚è€ƒæ–‡çŒ®)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µ

**åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆDistributed Transactionï¼‰**æ˜¯æŒ‡æ¶‰åŠå¤šä¸ªæ•°æ®åº“èŠ‚ç‚¹æˆ–æœåŠ¡çš„äº‹åŠ¡æ“ä½œï¼Œéœ€è¦ä¿è¯æ‰€æœ‰å‚ä¸èŠ‚ç‚¹è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

**åˆ†å¸ƒå¼äº‹åŠ¡çš„ç‰¹ç‚¹**ï¼š

- **è·¨èŠ‚ç‚¹æ“ä½œ**ï¼šäº‹åŠ¡æ¶‰åŠå¤šä¸ªæ•°æ®åº“èŠ‚ç‚¹
- **ç½‘ç»œé€šä¿¡**ï¼šèŠ‚ç‚¹é—´éœ€è¦ç½‘ç»œé€šä¿¡åè°ƒ
- **æ•…éšœå®¹é”™**ï¼šéœ€è¦å¤„ç†èŠ‚ç‚¹æ•…éšœå’Œç½‘ç»œåˆ†åŒº
- **æ€§èƒ½å¼€é”€**ï¼šç›¸æ¯”æœ¬åœ°äº‹åŠ¡æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€

### 1.2 æ ¸å¿ƒæŒ‘æˆ˜

**åˆ†å¸ƒå¼äº‹åŠ¡é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜**ï¼š

1. **ç½‘ç»œåˆ†åŒº**ï¼šç½‘ç»œæ•…éšœå¯¼è‡´èŠ‚ç‚¹é—´æ— æ³•é€šä¿¡
2. **èŠ‚ç‚¹æ•…éšœ**ï¼šå‚ä¸èŠ‚ç‚¹å¯èƒ½éšæ—¶æ•…éšœ
3. **æ—¶é’ŸåŒæ­¥**ï¼šä¸åŒèŠ‚ç‚¹çš„æ—¶é’Ÿå¯èƒ½ä¸åŒæ­¥
4. **äº‹åŠ¡åè°ƒ**ï¼šéœ€è¦åè°ƒå¤šä¸ªèŠ‚ç‚¹çš„äº‹åŠ¡çŠ¶æ€
5. **æ€§èƒ½å¼€é”€**ï¼šç½‘ç»œé€šä¿¡å’Œåè°ƒå¸¦æ¥çš„å»¶è¿Ÿ
6. **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯è·¨èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§

### 1.3 PostgreSQLè§£å†³æ–¹æ¡ˆ

PostgreSQLæä¾›äº†å¤šç§æœºåˆ¶æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼š

**æ ¸å¿ƒæœºåˆ¶**ï¼š

1. **ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰**ï¼šæ ‡å‡†åˆ†å¸ƒå¼äº‹åŠ¡åè®®
2. **åˆ†å¸ƒå¼é”ç®¡ç†**ï¼šä½¿ç”¨advisory lockså®ç°åˆ†å¸ƒå¼é”
3. **äº‹åŠ¡åè°ƒå™¨**ï¼šå¤–éƒ¨æˆ–åº”ç”¨å±‚åè°ƒå™¨
4. **SAGAè¡¥å¿äº‹åŠ¡**ï¼šé•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
5. **å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼ˆFDWï¼‰**ï¼šé€šè¿‡FDWåè°ƒå¤šä¸ªPostgreSQLå®ä¾‹

### 1.4 åº”ç”¨åœºæ™¯

**PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡é€‚ç”¨äº**ï¼š

- âœ… **åˆ†å¸ƒå¼æ•°æ®åº“**ï¼šCitusã€PostgreSQL-XLç­‰åˆ†å¸ƒå¼æ–¹æ¡ˆ
- âœ… **å¾®æœåŠ¡æ¶æ„**ï¼šè·¨æœåŠ¡çš„ä¸šåŠ¡äº‹åŠ¡
- âœ… **æ•°æ®åˆ†ç‰‡**ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®æ“ä½œ
- âœ… **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šè·¨ç§Ÿæˆ·çš„æ•°æ®è¿ç§»
- âœ… **æ•°æ®åŒæ­¥**ï¼šå¤šæ•°æ®ä¸­å¿ƒæ•°æ®åŒæ­¥

**ä¸é€‚ç”¨åœºæ™¯**ï¼š

- âŒ å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå»ºè®®ä½¿ç”¨æœ¬åœ°äº‹åŠ¡ï¼‰
- âŒ å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ï¼ˆå»ºè®®ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼‰

---

## 2. åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€

### 2.1 ACIDåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜

**ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å®ç°**ï¼š

| ç‰¹æ€§ | å•æœºç¯å¢ƒ | åˆ†å¸ƒå¼ç¯å¢ƒ | æŒ‘æˆ˜ |
|-----|---------|-----------|------|
| **åŸå­æ€§** | æœ¬åœ°äº‹åŠ¡ | åˆ†å¸ƒå¼äº‹åŠ¡ | åè°ƒå¤šä¸ªèŠ‚ç‚¹ |
| **ä¸€è‡´æ€§** | æœ¬åœ°çº¦æŸ | å…¨å±€çº¦æŸ | è·¨èŠ‚ç‚¹ä¸€è‡´æ€§ |
| **éš”ç¦»æ€§** | æœ¬åœ°é” | åˆ†å¸ƒå¼é” | æ­»é”æ£€æµ‹ |
| **æŒä¹…æ€§** | æœ¬åœ°WAL | åˆ†å¸ƒå¼WAL | æ•…éšœæ¢å¤ |

### 2.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

**2PCåè®®**æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ‡å‡†åè®®ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

#### 2.2.1 é˜¶æ®µ1ï¼šå‡†å¤‡ï¼ˆPrepareï¼‰

åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€PREPAREè¯·æ±‚ï¼Œå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡ä½†ä¸æäº¤ã€‚

```sql
-- åœ¨å‚ä¸è€…èŠ‚ç‚¹1
BEGIN;
UPDATE table1 SET value = 'new1' WHERE id = 1;
PREPARE TRANSACTION 'distributed-txn-001';

-- åœ¨å‚ä¸è€…èŠ‚ç‚¹2
BEGIN;
UPDATE table2 SET value = 'new2' WHERE id = 2;
PREPARE TRANSACTION 'distributed-txn-001';
```

**å‚ä¸è€…å“åº”**ï¼š

- **YES**ï¼šäº‹åŠ¡å¯ä»¥æäº¤ï¼Œèµ„æºå·²é”å®š
- **NO**ï¼šäº‹åŠ¡æ— æ³•æäº¤ï¼Œéœ€è¦å›æ»š

#### 2.2.2 é˜¶æ®µ2ï¼šæäº¤ï¼ˆCommitï¼‰

åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„YESå“åº”åï¼Œå‘é€COMMITè¯·æ±‚ã€‚

```sql
-- åè°ƒè€…æ”¶åˆ°æ‰€æœ‰YESå
COMMIT PREPARED 'distributed-txn-001';
```

**2PCæµç¨‹**ï¼š

```text
åè°ƒè€…                    å‚ä¸è€…1                    å‚ä¸è€…2
   |                         |                         |
   |--- PREPARE ------------>|                         |
   |                         |--- æ‰§è¡Œäº‹åŠ¡ ------------|
   |                         |--- PREPARE TRANSACTION -|
   |<-- YES -----------------|                         |
   |                         |                         |
   |--- PREPARE -------------------------------------->|
   |                         |                         |--- æ‰§è¡Œäº‹åŠ¡
   |                         |                         |--- PREPARE TRANSACTION
   |<-- YES -------------------------------------------|
   |                         |                         |
   |--- COMMIT PREPARED ---->|                         |
   |                         |--- COMMIT --------------|
   |                         |                         |
   |--- COMMIT PREPARED ------------------------------>|
   |                         |                         |--- COMMIT
```

#### 2.2.3 2PCé—®é¢˜

**2PCçš„ä¸»è¦é—®é¢˜**ï¼š

1. **é˜»å¡é—®é¢˜**ï¼šåè°ƒè€…æ•…éšœå¯¼è‡´å‚ä¸è€…é˜»å¡
2. **æ€§èƒ½å¼€é”€**ï¼šéœ€è¦ä¸¤è½®ç½‘ç»œé€šä¿¡
3. **å•ç‚¹æ•…éšœ**ï¼šåè°ƒè€…æ•…éšœå½±å“å…¨å±€
4. **æ•°æ®ä¸ä¸€è‡´**ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### 2.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰

**3PCæ”¹è¿›**ï¼šåœ¨2PCåŸºç¡€ä¸Šå¢åŠ é¢„æäº¤é˜¶æ®µï¼Œå‡å°‘é˜»å¡æ—¶é—´ã€‚

**3PCé˜¶æ®µ**ï¼š

1. **CanCommit**ï¼šè¯¢é—®æ˜¯å¦å¯ä»¥æäº¤
2. **PreCommit**ï¼šé¢„æäº¤ï¼Œé”å®šèµ„æº
3. **DoCommit**ï¼šæ‰§è¡Œæäº¤

**3PCä¼˜åŠ¿**ï¼š

- å¢åŠ è¶…æ—¶æœºåˆ¶ï¼Œå‡å°‘é˜»å¡
- æé«˜å¯ç”¨æ€§
- æ›´å¥½çš„æ•…éšœæ¢å¤

**3PCé—®é¢˜**ï¼š

- å¤æ‚åº¦æ›´é«˜
- ä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´é£é™©
- å®é™…åº”ç”¨è¾ƒå°‘

### 2.4 SAGAæ¨¡å¼

**SAGAæ¨¡å¼**å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªçŸ­äº‹åŠ¡æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

#### 2.4.1 SAGAæ¨¡å¼ç±»å‹

**ç¼–æ’å¼SAGAï¼ˆOrchestrationï¼‰**ï¼š

- ä¸­å¤®åè°ƒå™¨æ§åˆ¶æµç¨‹
- é›†ä¸­å¼ç®¡ç†
- æ˜“äºç†è§£å’Œè°ƒè¯•

**ååŒå¼SAGAï¼ˆChoreographyï¼‰**ï¼š

- æ— ä¸­å¤®åè°ƒå™¨
- äº‹ä»¶é©±åŠ¨
- å»ä¸­å¿ƒåŒ–

#### 2.4.2 SAGAå®ç°ç¤ºä¾‹

**è®¢å•å¤„ç†SAGA**ï¼š

```sql
-- æ­¥éª¤1: åˆ›å»ºè®¢å•
BEGIN;
INSERT INTO orders (user_id, total, status)
VALUES (1, 100.00, 'pending');
COMMIT;

-- æ­¥éª¤2: æ‰£å‡åº“å­˜
BEGIN;
UPDATE inventory SET quantity = quantity - 1
WHERE product_id = 1 AND quantity > 0;
COMMIT;

-- æ­¥éª¤3: æ‰£å‡ä½™é¢
BEGIN;
UPDATE accounts SET balance = balance - 100.00
WHERE user_id = 1 AND balance >= 100.00;
COMMIT;

-- å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
-- è¡¥å¿1: åˆ é™¤è®¢å•
DELETE FROM orders WHERE order_id = ?;

-- è¡¥å¿2: æ¢å¤åº“å­˜
UPDATE inventory SET quantity = quantity + 1 WHERE product_id = 1;

-- è¡¥å¿3: æ¢å¤ä½™é¢
UPDATE accounts SET balance = balance + 100.00 WHERE user_id = 1;
```

#### 2.4.3 SAGAçŠ¶æ€ç®¡ç†

```sql
-- SAGAçŠ¶æ€è¡¨
CREATE TABLE saga_state (
    saga_id UUID PRIMARY KEY,
    saga_type VARCHAR(50) NOT NULL,
    current_step INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL,  -- pending, completed, failed, compensating
    context JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- SAGAæ­¥éª¤è¡¨
CREATE TABLE saga_steps (
    step_id UUID PRIMARY KEY,
    saga_id UUID REFERENCES saga_state(saga_id),
    step_number INTEGER NOT NULL,
    step_type VARCHAR(50) NOT NULL,  -- action, compensation
    status VARCHAR(20) NOT NULL,
    executed_at TIMESTAMPTZ,
    UNIQUE(saga_id, step_number, step_type)
);
```

### 2.5 TCCæ¨¡å¼

**TCCæ¨¡å¼ï¼ˆTry-Confirm-Cancelï¼‰**æ˜¯ä¸€ç§è¡¥å¿å‹åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼ã€‚

**TCCä¸‰ä¸ªé˜¶æ®µ**ï¼š

1. **Try**ï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
2. **Confirm**ï¼šç¡®è®¤æ‰§è¡Œï¼Œæäº¤èµ„æº
3. **Cancel**ï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº

**TCCç¤ºä¾‹**ï¼š

```sql
-- Tryé˜¶æ®µï¼šé¢„ç•™åº“å­˜
UPDATE inventory
SET reserved_quantity = reserved_quantity + 1,
    available_quantity = available_quantity - 1
WHERE product_id = 1 AND available_quantity > 0;

-- Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£å‡
UPDATE inventory
SET reserved_quantity = reserved_quantity - 1
WHERE product_id = 1;

-- Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„ç•™
UPDATE inventory
SET reserved_quantity = reserved_quantity - 1,
    available_quantity = available_quantity + 1
WHERE product_id = 1;
```

### 2.6 åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”

| åè®® | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|---------|
| 2PC | å¼ºä¸€è‡´ | ä½ | ä¸­ | å¼ºä¸€è‡´æ€§è¦æ±‚ |
| 3PC | å¼ºä¸€è‡´ | ä¸­ | é«˜ | é«˜å¯ç”¨è¦æ±‚ |
| SAGA | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | é•¿äº‹åŠ¡ã€å¾®æœåŠ¡ |
| TCC | æœ€ç»ˆä¸€è‡´ | é«˜ | é«˜ | èµ„æºé¢„ç•™åœºæ™¯ |

---

## ä¸‰ã€PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å®ç°

### 3.1 ä¸¤é˜¶æ®µæäº¤å®ç°

#### 3.1.1 åŸºæœ¬2PCå®ç°

**å‡†å¤‡é˜¶æ®µ**ï¼š

```sql
-- åœ¨å‚ä¸è€…èŠ‚ç‚¹1
BEGIN;
UPDATE table1 SET value = 'new1' WHERE id = 1;
PREPARE TRANSACTION 'distributed-txn-001';

-- åœ¨å‚ä¸è€…èŠ‚ç‚¹2
BEGIN;
UPDATE table2 SET value = 'new2' WHERE id = 2;
PREPARE TRANSACTION 'distributed-txn-001';
```

**æäº¤é˜¶æ®µ**ï¼š

```sql
-- åè°ƒè€…æ£€æŸ¥æ‰€æœ‰å‚ä¸è€…çŠ¶æ€
SELECT * FROM pg_prepared_xacts;

-- å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡æˆåŠŸï¼Œæ‰§è¡Œæäº¤
COMMIT PREPARED 'distributed-txn-001';
```

**å›æ»šé˜¶æ®µ**ï¼š

```sql
-- å¦‚æœä»»ä½•å‚ä¸è€…å‡†å¤‡å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š
ROLLBACK PREPARED 'distributed-txn-001';
```

#### 3.1.2 2PCåè°ƒå™¨å®ç°

**Pythonåè°ƒå™¨ç¤ºä¾‹**ï¼š

```python
import psycopg2
from typing import List, Tuple

class TwoPhaseCommitCoordinator:
    def __init__(self, participants: List[Tuple[str, int, str, str, str]]):
        """
        participants: [(host, port, database, user, password), ...]
        """
        self.participants = participants
        self.connections = []
        self.transaction_id = None

    def begin_transaction(self, transaction_id: str):
        """å¼€å§‹åˆ†å¸ƒå¼äº‹åŠ¡"""
        self.transaction_id = transaction_id
        self.connections = []

        for host, port, db, user, password in self.participants:
            conn = psycopg2.connect(
                host=host, port=port, database=db,
                user=user, password=password
            )
            conn.autocommit = False
            self.connections.append(conn)

    def prepare(self) -> bool:
        """å‡†å¤‡é˜¶æ®µï¼šæ‰€æœ‰å‚ä¸è€…å‡†å¤‡äº‹åŠ¡"""
        prepared = []

        for conn in self.connections:
            try:
                cur = conn.cursor()
                cur.execute(f"PREPARE TRANSACTION '{self.transaction_id}'")
                prepared.append(True)
            except Exception as e:
                print(f"Prepare failed: {e}")
                prepared.append(False)

        return all(prepared)

    def commit(self) -> bool:
        """æäº¤é˜¶æ®µï¼šæ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡"""
        if not self.prepare():
            self.rollback()
            return False

        committed = []
        for conn in self.connections:
            try:
                cur = conn.cursor()
                cur.execute(f"COMMIT PREPARED '{self.transaction_id}'")
                conn.commit()
                committed.append(True)
            except Exception as e:
                print(f"Commit failed: {e}")
                committed.append(False)

        return all(committed)

    def rollback(self):
        """å›æ»šé˜¶æ®µï¼šæ‰€æœ‰å‚ä¸è€…å›æ»šäº‹åŠ¡"""
        for conn in self.connections:
            try:
                cur = conn.cursor()
                cur.execute(f"ROLLBACK PREPARED '{self.transaction_id}'")
                conn.commit()
            except Exception as e:
                print(f"Rollback failed: {e}")

    def close(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        for conn in self.connections:
            conn.close()
```

#### 3.1.3 æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡

```sql
-- æŸ¥çœ‹æ‰€æœ‰å‡†å¤‡çš„äº‹åŠ¡
SELECT
    transaction,
    gid,
    prepared,
    owner,
    database
FROM pg_prepared_xacts;

-- æŸ¥çœ‹ç‰¹å®šäº‹åŠ¡
SELECT * FROM pg_prepared_xacts
WHERE gid = 'distributed-txn-001';
```

### 3.2 åˆ†å¸ƒå¼é”ç®¡ç†

#### 3.2.1 Advisory Locks

PostgreSQLæä¾›advisory lockså®ç°åˆ†å¸ƒå¼é”ã€‚

```sql
-- è·å–ä¼šè¯çº§é”ï¼ˆé˜»å¡ï¼‰
SELECT pg_advisory_lock(123456);

-- å°è¯•è·å–é”ï¼ˆéé˜»å¡ï¼‰
SELECT pg_try_advisory_lock(123456);

-- é‡Šæ”¾é”
SELECT pg_advisory_unlock(123456);

-- è·å–äº‹åŠ¡çº§é”ï¼ˆäº‹åŠ¡ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼‰
SELECT pg_advisory_xact_lock(123456);

-- å°è¯•è·å–äº‹åŠ¡çº§é”
SELECT pg_try_advisory_xact_lock(123456);
```

#### 3.2.2 åˆ†å¸ƒå¼é”å®ç°

```sql
-- åˆ›å»ºåˆ†å¸ƒå¼é”è¡¨
CREATE TABLE distributed_locks (
    lock_name VARCHAR(255) PRIMARY KEY,
    lock_holder VARCHAR(255) NOT NULL,
    acquired_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL
);

-- è·å–åˆ†å¸ƒå¼é”å‡½æ•°
CREATE OR REPLACE FUNCTION acquire_distributed_lock(
    p_lock_name VARCHAR(255),
    p_holder VARCHAR(255),
    p_timeout INTEGER DEFAULT 30
)
RETURNS BOOLEAN
AS $$
DECLARE
    v_expires_at TIMESTAMPTZ;
BEGIN
    v_expires_at := NOW() + (p_timeout || ' seconds')::INTERVAL;

    -- å°è¯•æ’å…¥é”è®°å½•
    INSERT INTO distributed_locks (lock_name, lock_holder, expires_at)
    VALUES (p_lock_name, p_holder, v_expires_at)
    ON CONFLICT (lock_name) DO UPDATE SET
        lock_holder = p_holder,
        acquired_at = NOW(),
        expires_at = v_expires_at
    WHERE distributed_locks.expires_at < NOW();

    RETURN FOUND;
END;
$$ LANGUAGE plpgsql;

-- é‡Šæ”¾åˆ†å¸ƒå¼é”å‡½æ•°
CREATE OR REPLACE FUNCTION release_distributed_lock(
    p_lock_name VARCHAR(255),
    p_holder VARCHAR(255)
)
RETURNS BOOLEAN
AS $$
BEGIN
    DELETE FROM distributed_locks
    WHERE lock_name = p_lock_name
      AND lock_holder = p_holder;

    RETURN FOUND;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 äº‹åŠ¡åè°ƒå™¨

#### 3.3.1 åº”ç”¨å±‚åè°ƒå™¨

åº”ç”¨å±‚å®ç°2PCåè°ƒé€»è¾‘ï¼Œæ§åˆ¶åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹ã€‚

**åè°ƒå™¨èŒè´£**ï¼š

1. ç®¡ç†äº‹åŠ¡ID
2. å‘æ‰€æœ‰å‚ä¸è€…å‘é€PREPAREè¯·æ±‚
3. æ”¶é›†å‚ä¸è€…å“åº”
4. å†³å®šæäº¤æˆ–å›æ»š
5. å¤„ç†æ•…éšœæ¢å¤

#### 3.3.2 ä¸­é—´ä»¶åè°ƒå™¨

ä½¿ç”¨äº‹åŠ¡ä¸­é—´ä»¶ï¼ˆå¦‚Seataã€Atomikosï¼‰åè°ƒåˆ†å¸ƒå¼äº‹åŠ¡ã€‚

**ä¸­é—´ä»¶ä¼˜åŠ¿**ï¼š

- æˆç†Ÿçš„å®ç°
- å®Œå–„çš„æ•…éšœæ¢å¤
- ç›‘æ§å’Œç®¡ç†åŠŸèƒ½

### 3.4 å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼ˆFDWï¼‰åè°ƒ

**ä½¿ç”¨postgres_fdwåè°ƒå¤šä¸ªPostgreSQLå®ä¾‹**ï¼š

```sql
-- åˆ›å»ºå¤–éƒ¨æœåŠ¡å™¨
CREATE SERVER foreign_server
FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host 'remote_host', port '5432', dbname 'remote_db');

-- åˆ›å»ºç”¨æˆ·æ˜ å°„
CREATE USER MAPPING FOR current_user
SERVER foreign_server
OPTIONS (user 'remote_user', password 'remote_password');

-- åˆ›å»ºå¤–éƒ¨è¡¨
CREATE FOREIGN TABLE remote_table (
    id INTEGER,
    value TEXT
)
SERVER foreign_server
OPTIONS (schema_name 'public', table_name 'remote_table');

-- ä½¿ç”¨2PCè¿›è¡Œè·¨èŠ‚ç‚¹äº‹åŠ¡
BEGIN;
UPDATE local_table SET value = 'new' WHERE id = 1;
UPDATE remote_table SET value = 'new' WHERE id = 1;
COMMIT;  -- postgres_fdwè‡ªåŠ¨ä½¿ç”¨2PC
```

---

## å››ã€Citusåˆ†å¸ƒå¼äº‹åŠ¡

### 4.1 Citusäº‹åŠ¡æ¨¡å‹

**Citusäº‹åŠ¡ç±»å‹**ï¼š

1. **å•åˆ†ç‰‡äº‹åŠ¡**ï¼šåªæ¶‰åŠå•ä¸ªåˆ†ç‰‡ï¼Œä½¿ç”¨æœ¬åœ°äº‹åŠ¡ï¼Œé«˜æ€§èƒ½
2. **å¤šåˆ†ç‰‡äº‹åŠ¡**ï¼šæ¶‰åŠå¤šä¸ªåˆ†ç‰‡ï¼Œè‡ªåŠ¨ä½¿ç”¨2PCï¼Œä¿è¯ä¸€è‡´æ€§
3. **å‚è€ƒè¡¨äº‹åŠ¡**ï¼šåªæ¶‰åŠå‚è€ƒè¡¨ï¼Œä½¿ç”¨æœ¬åœ°äº‹åŠ¡

**äº‹åŠ¡ç±»å‹åˆ¤æ–­**ï¼š

```sql
-- å•åˆ†ç‰‡äº‹åŠ¡ï¼ˆé«˜æ€§èƒ½ï¼‰
BEGIN;
UPDATE users SET status = 'active' WHERE id = 123;  -- id=123åœ¨åŒä¸€åˆ†ç‰‡
COMMIT;

-- å¤šåˆ†ç‰‡äº‹åŠ¡ï¼ˆè‡ªåŠ¨2PCï¼‰
BEGIN;
UPDATE users SET status = 'active' WHERE id = 123;  -- id=123åœ¨åˆ†ç‰‡1
UPDATE orders SET status = 'paid' WHERE user_id = 456;  -- user_id=456åœ¨åˆ†ç‰‡2
COMMIT;  -- Citusè‡ªåŠ¨ä½¿ç”¨2PC
```

### 4.2 è·¨åˆ†ç‰‡äº‹åŠ¡

#### 4.2.1 è·¨åˆ†ç‰‡æ›´æ–°

```sql
BEGIN;

-- è·¨åˆ†ç‰‡æ›´æ–°
UPDATE users SET status = 'active' WHERE id = 123;
UPDATE orders SET status = 'paid' WHERE user_id = 123;

-- Citusè‡ªåŠ¨æ£€æµ‹è·¨åˆ†ç‰‡æ“ä½œï¼Œä½¿ç”¨2PC
COMMIT;
```

#### 4.2.2 è·¨åˆ†ç‰‡æ’å…¥

```sql
BEGIN;

-- è·¨åˆ†ç‰‡æ’å…¥
INSERT INTO users (id, name) VALUES (123, 'Alice');
INSERT INTO orders (user_id, total) VALUES (123, 100.00);

-- Citusè‡ªåŠ¨ä½¿ç”¨2PC
COMMIT;
```

### 4.3 äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯

**ä¸€è‡´æ€§çº§åˆ«**ï¼š

- **å¼ºä¸€è‡´æ€§**ï¼šä½¿ç”¨2PCï¼ˆé»˜è®¤ï¼‰ï¼Œä¿è¯ACIDç‰¹æ€§
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šå¼‚æ­¥å¤åˆ¶ï¼Œæé«˜æ€§èƒ½ä½†é™ä½ä¸€è‡´æ€§

**é…ç½®ä¸€è‡´æ€§çº§åˆ«**ï¼š

```sql
-- è®¾ç½®äº‹åŠ¡ä¸€è‡´æ€§çº§åˆ«
SET citus.multi_shard_commit_protocol = '2pc';  -- å¼ºä¸€è‡´æ€§ï¼ˆé»˜è®¤ï¼‰
SET citus.multi_shard_commit_protocol = '1pc';  -- æœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
```

### 4.4 æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **å‡å°‘è·¨åˆ†ç‰‡äº‹åŠ¡**ï¼šå°½é‡å°†ç›¸å…³æ•°æ®æ”¾åœ¨åŒä¸€åˆ†ç‰‡
2. **ä½¿ç”¨æœ¬åœ°äº‹åŠ¡**ï¼šå•åˆ†ç‰‡æ“ä½œä½¿ç”¨æœ¬åœ°äº‹åŠ¡
3. **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ’å…¥/æ›´æ–°å‡å°‘äº‹åŠ¡æ•°é‡
4. **å¼‚æ­¥æäº¤**ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ä½¿ç”¨å¼‚æ­¥æäº¤

```sql
-- ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œ
BEGIN;
INSERT INTO orders (user_id, total)
SELECT user_id, total FROM temp_orders;
COMMIT;  -- å•æ¬¡äº‹åŠ¡ï¼Œå‡å°‘å¼€é”€
```

---

## äº”ã€PostgreSQL 18ä¼˜åŒ–

### 5.1 å¼‚æ­¥I/Oä¼˜åŒ–

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡åˆ†å¸ƒå¼äº‹åŠ¡çš„I/Oæ€§èƒ½ã€‚

```sql
-- å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_direct = on;
ALTER SYSTEM SET io_direct_threshold = 0;
SELECT pg_reload_conf();
```

**æ€§èƒ½æå‡**ï¼š

- åˆ†å¸ƒå¼äº‹åŠ¡I/Oæ€§èƒ½æå‡2-3å€
- å‡å°‘é˜»å¡ç­‰å¾…æ—¶é—´
- æé«˜å¹¶å‘äº‹åŠ¡å¤„ç†èƒ½åŠ›

### 5.2 ç›‘æ§å¢å¼º

PostgreSQL 18å¢å¼ºäº†äº‹åŠ¡ç›‘æ§èƒ½åŠ›ã€‚

```sql
-- æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡è¯¦æƒ…
SELECT
    transaction,
    gid,
    prepared,
    owner,
    database,
    prepared_timestamp
FROM pg_prepared_xacts;

-- ç›‘æ§åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½
SELECT
    datname,
    usename,
    application_name,
    state,
    wait_event_type,
    wait_event,
    query_start,
    state_change
FROM pg_stat_activity
WHERE state = 'active';
```

## å…­ã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 6.1 åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”

| åè®® | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é˜»å¡é£é™© | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|---------|---------|
| 2PC | å¼ºä¸€è‡´ | ä½ | ä¸­ | é«˜ | å¼ºä¸€è‡´æ€§è¦æ±‚ |
| 3PC | å¼ºä¸€è‡´ | ä¸­ | é«˜ | ä¸­ | é«˜å¯ç”¨è¦æ±‚ |
| SAGA | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | ä½ | é•¿äº‹åŠ¡ã€å¾®æœåŠ¡ |
| TCC | æœ€ç»ˆä¸€è‡´ | é«˜ | é«˜ | ä½ | èµ„æºé¢„ç•™åœºæ™¯ |

### 6.2 å®ç°æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ€§èƒ½ | å¤æ‚åº¦ | å¯é æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|--------|---------|
| åº”ç”¨å±‚åè°ƒ | ä¸­ | ä¸­ | ä¸­ | ç®€å•åœºæ™¯ |
| ä¸­é—´ä»¶åè°ƒ | ä¸­ | ä½ | é«˜ | ä¼ä¸šçº§åº”ç”¨ |
| FDWåè°ƒ | ä¸­ | ä¸­ | ä¸­ | PostgreSQLé›†ç¾¤ |
| Citusè‡ªåŠ¨ | é«˜ | ä½ | é«˜ | Citusåˆ†å¸ƒå¼æ•°æ®åº“ |

## ä¸ƒã€æ•…éšœå¤„ç†ä¸æ¢å¤

### 7.1 æ•…éšœåœºæ™¯

#### 7.1.1 åè°ƒè€…æ•…éšœ

**ç—‡çŠ¶**ï¼šåè°ƒè€…èŠ‚ç‚¹æ•…éšœï¼Œå‚ä¸è€…å¤„äºPREPAREDçŠ¶æ€

**å½±å“**ï¼šå‚ä¸è€…é˜»å¡ï¼Œç­‰å¾…åè°ƒè€…æ¢å¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡
SELECT * FROM pg_prepared_xacts;

-- æ‰‹åŠ¨æäº¤æˆ–å›æ»š
COMMIT PREPARED 'txn-001';
-- æˆ–
ROLLBACK PREPARED 'txn-001';
```

#### 7.1.2 å‚ä¸è€…æ•…éšœ

**ç—‡çŠ¶**ï¼šå‚ä¸è€…èŠ‚ç‚¹æ•…éšœï¼Œæ— æ³•å“åº”PREPAREè¯·æ±‚

**å½±å“**ï¼šäº‹åŠ¡æ— æ³•æäº¤ï¼Œéœ€è¦å›æ»š

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- åè°ƒè€…æ£€æµ‹åˆ°å‚ä¸è€…æ•…éšœï¼Œå›æ»šæ‰€æœ‰å‚ä¸è€…
ROLLBACK PREPARED 'txn-001';
```

#### 7.1.3 ç½‘ç»œåˆ†åŒº

**ç—‡çŠ¶**ï¼šèŠ‚ç‚¹é—´ç½‘ç»œä¸­æ–­ï¼Œæ— æ³•é€šä¿¡

**å½±å“**ï¼šäº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ç­‰å¾…ç½‘ç»œæ¢å¤
- ä½¿ç”¨è¶…æ—¶æœºåˆ¶
- æ‰‹åŠ¨å¹²é¢„æ¢å¤

### 7.2 æ¢å¤ç­–ç•¥

#### 7.2.1 è‡ªåŠ¨æ¢å¤

**é…ç½®è¶…æ—¶**ï¼š

```sql
-- è®¾ç½®å‡†å¤‡äº‹åŠ¡è¶…æ—¶
ALTER SYSTEM SET max_prepared_transactions = 100;
ALTER SYSTEM SET statement_timeout = '30s';
SELECT pg_reload_conf();
```

#### 7.2.2 æ‰‹åŠ¨æ¢å¤

**æ¢å¤æµç¨‹**ï¼š

1. æ£€æŸ¥å‡†å¤‡çš„äº‹åŠ¡
2. ç¡®å®šäº‹åŠ¡çŠ¶æ€
3. å†³å®šæäº¤æˆ–å›æ»š
4. æ‰§è¡Œæ¢å¤æ“ä½œ

```sql
-- æ¢å¤è„šæœ¬
DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN SELECT gid FROM pg_prepared_xacts
    LOOP
        -- æ ¹æ®ä¸šåŠ¡é€»è¾‘å†³å®šæäº¤æˆ–å›æ»š
        -- è¿™é‡Œç¤ºä¾‹ï¼šè¶…è¿‡1å°æ—¶çš„äº‹åŠ¡å›æ»š
        IF (SELECT prepared FROM pg_prepared_xacts WHERE gid = r.gid) < NOW() - interval '1 hour' THEN
            EXECUTE format('ROLLBACK PREPARED %L', r.gid);
        END IF;
    END LOOP;
END $$;
```

### 7.3 æ•…éšœæ¼”ç»ƒ

**å®šæœŸæ¼”ç»ƒ**ï¼š

1. æ¨¡æ‹Ÿåè°ƒè€…æ•…éšœ
2. æ¨¡æ‹Ÿå‚ä¸è€…æ•…éšœ
3. æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒº
4. éªŒè¯æ¢å¤æµç¨‹
5. è®°å½•æ¼”ç»ƒç»“æœ

## å…«ã€å®è·µæ¡ˆä¾‹

### 8.1 ç”µå•†è®¢å•å¤„ç†

**åœºæ™¯**ï¼šåˆ›å»ºè®¢å•ã€æ‰£å‡åº“å­˜ã€æ‰£å‡ä½™é¢

**å®ç°ï¼ˆä½¿ç”¨2PCï¼‰**ï¼š

```sql
-- åè°ƒè€…ä»£ç ï¼ˆPythonç¤ºä¾‹ï¼‰
coordinator = TwoPhaseCommitCoordinator([
    ('order_db', 5432, 'orders', 'user', 'pass'),
    ('inventory_db', 5432, 'inventory', 'user', 'pass'),
    ('account_db', 5432, 'accounts', 'user', 'pass')
])

coordinator.begin_transaction('order-001')

# åœ¨è®¢å•åº“åˆ›å»ºè®¢å•
# åœ¨åº“å­˜åº“æ‰£å‡åº“å­˜
# åœ¨è´¦æˆ·åº“æ‰£å‡ä½™é¢

if coordinator.commit():
    print("è®¢å•åˆ›å»ºæˆåŠŸ")
else:
    print("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œå·²å›æ»š")
```

**å®ç°ï¼ˆä½¿ç”¨SAGAï¼‰**ï¼š

```sql
-- æ­¥éª¤1: åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, total, status)
VALUES (1, 100.00, 'pending');

-- æ­¥éª¤2: æ‰£å‡åº“å­˜
UPDATE inventory SET quantity = quantity - 1
WHERE product_id = 100;

-- æ­¥éª¤3: æ‰£å‡ä½™é¢
UPDATE accounts SET balance = balance - 100.00
WHERE user_id = 1;

-- å¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
-- è¡¥å¿é€»è¾‘åœ¨åº”ç”¨å±‚å®ç°
```

### 8.2 å¤šç§Ÿæˆ·æ•°æ®è¿ç§»

**åœºæ™¯**ï¼šè·¨åˆ†ç‰‡æ•°æ®è¿ç§»

**å®ç°**ï¼š

```sql
BEGIN;

-- ä»æºåˆ†ç‰‡åˆ é™¤
DELETE FROM tenant_data
WHERE tenant_id = 1 AND id = 100;

-- æ’å…¥åˆ°ç›®æ ‡åˆ†ç‰‡
INSERT INTO tenant_data (tenant_id, id, data)
VALUES (2, 100, '{"migrated": true}');

COMMIT;  -- Citusè‡ªåŠ¨ä½¿ç”¨2PC
```

### 8.3 å¾®æœåŠ¡äº‹åŠ¡åè°ƒ

**åœºæ™¯**ï¼šè·¨å¾®æœåŠ¡çš„ä¸šåŠ¡äº‹åŠ¡

**å®ç°ï¼ˆä½¿ç”¨SAGAï¼‰**ï¼š

```sql
-- SAGAçŠ¶æ€ç®¡ç†
CREATE TABLE saga_instances (
    saga_id UUID PRIMARY KEY,
    saga_type VARCHAR(50),
    status VARCHAR(20),
    context JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•
INSERT INTO orders (user_id, total) VALUES (1, 100.00);

-- åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ï¼ˆé€šè¿‡HTTPè°ƒç”¨ï¼‰
-- è´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢ï¼ˆé€šè¿‡HTTPè°ƒç”¨ï¼‰

-- å¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
UPDATE saga_instances
SET status = 'compensating'
WHERE saga_id = ?;
```

---

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 è®¾è®¡æœ€ä½³å®è·µ

1. **å‡å°‘è·¨èŠ‚ç‚¹äº‹åŠ¡**ï¼šå°½é‡å°†ç›¸å…³æ•°æ®æ”¾åœ¨åŒä¸€èŠ‚ç‚¹
2. **ä½¿ç”¨æœ¬åœ°äº‹åŠ¡**ï¼šå•èŠ‚ç‚¹æ“ä½œä½¿ç”¨æœ¬åœ°äº‹åŠ¡
3. **åˆç†é€‰æ‹©åè®®**ï¼šæ ¹æ®ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©åˆé€‚çš„åè®®
4. **è¶…æ—¶è®¾ç½®**ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
5. **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€

### 9.2 å¼€å‘æœ€ä½³å®è·µ

1. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
2. **å¹‚ç­‰æ€§**ï¼šç¡®ä¿æ“ä½œå¹‚ç­‰ï¼Œæ”¯æŒé‡è¯•
3. **è¡¥å¿é€»è¾‘**ï¼šè®¾è®¡å®Œå–„çš„è¡¥å¿é€»è¾‘
4. **æµ‹è¯•éªŒè¯**ï¼šå……åˆ†æµ‹è¯•å„ç§æ•…éšœåœºæ™¯
5. **æ–‡æ¡£ç»´æŠ¤**ï¼šä¿æŒä»£ç å’Œæ–‡æ¡£åŒæ­¥æ›´æ–°

## åã€å‚è€ƒèµ„æº

### 10.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQL Prepared Transactions](https://www.postgresql.org/docs/current/sql-prepare-transaction.html)
- [PostgreSQL Advisory Locks](https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS)
- [Citus Distributed Transactions](https://docs.citusdata.com/en/stable/develop/api_udf.html#distributed-transactions)
- [PostgreSQL Foreign Data Wrappers](https://www.postgresql.org/docs/current/fdwhandler.html)

### 10.2 ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../01-æ ¸å¿ƒè¯¾ç¨‹/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç†è®ºåŸºç¡€
- [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../01-æ ¸å¿ƒè¯¾ç¨‹/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶æœºåˆ¶
- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../04-éƒ¨ç½²è¿ç»´/04.02-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- [åˆ†å¸ƒå¼æ¶æ„è®¾è®¡](../04-éƒ¨ç½²è¿ç»´/04.07-åˆ†å¸ƒå¼æ¶æ„è®¾è®¡.md) - åˆ†å¸ƒå¼æ¶æ„

---

## åä¸€ã€å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>

2. Gray, J., & Lamport, L. (2006). Consensus on transaction commit. ACM Transactions on Database Systems, 31(1), 133-160.

3. Garcia-Molina, H., & Salem, K. (1987). Sagas. ACM SIGMOD Record, 16(3), 249-259.

4. Citus Data. (2025). Citus Distributed Transactions. <https://docs.citusdata.com/en/stable/develop/api_udf.html#distributed-transactions>

5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

6. Skeen, D. (1981). Nonblocking commit protocols. ACM SIGMOD Record, 11(2), 133-142.

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: Data Science Team
