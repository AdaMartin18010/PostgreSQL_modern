# PostgreSQLæ‰©å±•ç³»ç»Ÿä¸æ’ä»¶å¼€å‘å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­â­
> **åº”ç”¨åœºæ™¯**: è‡ªå®šä¹‰åŠŸèƒ½å¼€å‘ã€ç¬¬ä¸‰æ–¹é›†æˆã€æ€§èƒ½ä¼˜åŒ–ã€åŠŸèƒ½æ‰©å±•

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLæ‰©å±•ç³»ç»Ÿä¸æ’ä»¶å¼€å‘å®Œæ•´æŒ‡å—](#postgresqlæ‰©å±•ç³»ç»Ÿä¸æ’ä»¶å¼€å‘å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æ‰©å±•ç³»ç»Ÿæ¦‚å¿µ](#11-æ‰©å±•ç³»ç»Ÿæ¦‚å¿µ)
    - [1.2 æ‰©å±•ç±»å‹](#12-æ‰©å±•ç±»å‹)
    - [1.3 PostgreSQL 18æ–°ç‰¹æ€§](#13-postgresql-18æ–°ç‰¹æ€§)
  - [äºŒã€å®šä¹‰ä¸å½¢å¼åŒ–](#äºŒå®šä¹‰ä¸å½¢å¼åŒ–)
    - [2.1 æ¦‚å¿µå®šä¹‰](#21-æ¦‚å¿µå®šä¹‰)
    - [2.2 å½¢å¼åŒ–å®šä¹‰](#22-å½¢å¼åŒ–å®šä¹‰)
    - [2.3 æ ¸å¿ƒç‰¹æ€§](#23-æ ¸å¿ƒç‰¹æ€§)
  - [ä¸‰ã€æ‰©å±•ç³»ç»Ÿæ¶æ„](#ä¸‰æ‰©å±•ç³»ç»Ÿæ¶æ„)
    - [3.1 æ‰©å±•ç®¡ç†](#31-æ‰©å±•ç®¡ç†)
    - [3.2 æ‰©å±•é…ç½®](#32-æ‰©å±•é…ç½®)
    - [3.3 æ‰©å±•ç”Ÿå‘½å‘¨æœŸ](#33-æ‰©å±•ç”Ÿå‘½å‘¨æœŸ)
  - [å››ã€Cè¯­è¨€æ‰©å±•å¼€å‘](#å››cè¯­è¨€æ‰©å±•å¼€å‘)
    - [4.1 æ‰©å±•ç»“æ„](#41-æ‰©å±•ç»“æ„)
    - [4.2 æ•°æ®ç±»å‹æ‰©å±•](#42-æ•°æ®ç±»å‹æ‰©å±•)
    - [4.3 æ“ä½œç¬¦æ‰©å±•](#43-æ“ä½œç¬¦æ‰©å±•)
    - [4.4 å‡½æ•°æ‰©å±•](#44-å‡½æ•°æ‰©å±•)
  - [äº”ã€SQLæ‰©å±•å¼€å‘](#äº”sqlæ‰©å±•å¼€å‘)
    - [5.1 æ§åˆ¶æ–‡ä»¶](#51-æ§åˆ¶æ–‡ä»¶)
    - [5.2 å®‰è£…è„šæœ¬](#52-å®‰è£…è„šæœ¬)
    - [5.3 å‡çº§è„šæœ¬](#53-å‡çº§è„šæœ¬)
    - [5.4 å¸è½½è„šæœ¬](#54-å¸è½½è„šæœ¬)
  - [å…­ã€ç¬¬ä¸‰æ–¹æ‰©å±•é›†æˆ](#å…­ç¬¬ä¸‰æ–¹æ‰©å±•é›†æˆ)
    - [6.1 æµè¡Œæ‰©å±•](#61-æµè¡Œæ‰©å±•)
    - [6.2 åœ°ç†ç©ºé—´æ‰©å±•](#62-åœ°ç†ç©ºé—´æ‰©å±•)
    - [6.3 æ—¶é—´åºåˆ—æ‰©å±•](#63-æ—¶é—´åºåˆ—æ‰©å±•)
    - [6.4 å‘é‡æ•°æ®åº“æ‰©å±•](#64-å‘é‡æ•°æ®åº“æ‰©å±•)
    - [6.5 åˆ—å­˜å‚¨æ‰©å±• ğŸ†•](#65-åˆ—å­˜å‚¨æ‰©å±•-)
  - [ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¸ƒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [7.1 æ‰©å±•ç±»å‹å¯¹æ¯”](#71-æ‰©å±•ç±»å‹å¯¹æ¯”)
    - [7.2 å¼€å‘è¯­è¨€å¯¹æ¯”](#72-å¼€å‘è¯­è¨€å¯¹æ¯”)
  - [å…«ã€æ‰©å±•å¼€å‘æœ€ä½³å®è·µ](#å…«æ‰©å±•å¼€å‘æœ€ä½³å®è·µ)
    - [8.1 é”™è¯¯å¤„ç†](#81-é”™è¯¯å¤„ç†)
    - [8.2 å†…å­˜ç®¡ç†](#82-å†…å­˜ç®¡ç†)
    - [8.3 æ€§èƒ½ä¼˜åŒ–](#83-æ€§èƒ½ä¼˜åŒ–)
  - [ä¹ã€å®è·µæ¡ˆä¾‹](#ä¹å®è·µæ¡ˆä¾‹)
    - [9.1 æ¡ˆä¾‹1ï¼šè‡ªå®šä¹‰èšåˆå‡½æ•°](#91-æ¡ˆä¾‹1è‡ªå®šä¹‰èšåˆå‡½æ•°)
    - [9.2 æ¡ˆä¾‹2ï¼šè‡ªå®šä¹‰ç´¢å¼•](#92-æ¡ˆä¾‹2è‡ªå®šä¹‰ç´¢å¼•)
    - [9.3 æ¡ˆä¾‹3ï¼šå®Œæ•´æ‰©å±•ç¤ºä¾‹](#93-æ¡ˆä¾‹3å®Œæ•´æ‰©å±•ç¤ºä¾‹)
  - [åã€æ•…éšœæ’æŸ¥](#åæ•…éšœæ’æŸ¥)
    - [10.1 å¸¸è§é—®é¢˜](#101-å¸¸è§é—®é¢˜)
    - [10.2 è°ƒè¯•æŠ€å·§](#102-è°ƒè¯•æŠ€å·§)
  - [åä¸€ã€å‚è€ƒèµ„æº](#åä¸€å‚è€ƒèµ„æº)
    - [11.1 å®˜æ–¹æ–‡æ¡£](#111-å®˜æ–¹æ–‡æ¡£)
    - [11.2 ç›¸å…³æ–‡æ¡£](#112-ç›¸å…³æ–‡æ¡£)
  - [åäºŒã€å‚è€ƒæ–‡çŒ®](#åäºŒå‚è€ƒæ–‡çŒ®)
    - [8.1 ä¸Šä½æ¦‚å¿µ](#81-ä¸Šä½æ¦‚å¿µ)
    - [8.2 ä¸‹ä½æ¦‚å¿µ](#82-ä¸‹ä½æ¦‚å¿µ)
    - [8.3 å¹³è¡Œæ¦‚å¿µ](#83-å¹³è¡Œæ¦‚å¿µ)
  - [9. å‚è€ƒæ–‡çŒ®](#9-å‚è€ƒæ–‡çŒ®)
  - [10. Wikidataå¯¹é½](#10-wikidataå¯¹é½)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 æ‰©å±•ç³»ç»Ÿæ¦‚å¿µ

**PostgreSQLæ‰©å±•ç³»ç»Ÿ**æ˜¯PostgreSQLæä¾›çš„æ’ä»¶åŒ–æ¶æ„ï¼Œå…è®¸å¼€å‘è€…åˆ›å»ºè‡ªå®šä¹‰æ‰©å±•æ¥å¢å¼ºæ•°æ®åº“åŠŸèƒ½ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

- **æ¨¡å—åŒ–è®¾è®¡**ï¼šåŠŸèƒ½æ¨¡å—åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒæ‰©å±•ç‰ˆæœ¬æ§åˆ¶å’Œå‡çº§
- **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†æ‰©å±•ä¾èµ–å…³ç³»
- **çƒ­æ’æ‹”**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ è½½å’Œå¸è½½æ‰©å±•

### 1.2 æ‰©å±•ç±»å‹

**ä¸»è¦æ‰©å±•ç±»å‹**ï¼š

1. **Cè¯­è¨€æ‰©å±•**ï¼šé«˜æ€§èƒ½ï¼Œåº•å±‚åŠŸèƒ½
2. **SQLæ‰©å±•**ï¼šçº¯SQLå®ç°ï¼Œæ˜“äºå¼€å‘
3. **ç¬¬ä¸‰æ–¹æ‰©å±•**ï¼šç¤¾åŒºè´¡çŒ®çš„æ‰©å±•

### 1.3 PostgreSQL 18æ–°ç‰¹æ€§

**PostgreSQL 18æ‰©å±•ç³»ç»Ÿæ”¹è¿›**ï¼š

- **æ‰©å±•ä¾èµ–ä¼˜åŒ–**ï¼šæ›´æ™ºèƒ½çš„ä¾èµ–ç®¡ç†
- **å¹¶è¡ŒåŠ è½½**ï¼šæ”¯æŒå¹¶è¡ŒåŠ è½½æ‰©å±•
- **æ€§èƒ½æå‡**ï¼šæ‰©å±•åŠ è½½æ€§èƒ½æå‡

## äºŒã€å®šä¹‰ä¸å½¢å¼åŒ–

### 2.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: æ‰©å±•ç³»ç»Ÿæ˜¯PostgreSQLæä¾›çš„æ’ä»¶åŒ–æ¶æ„ï¼Œå…è®¸å¼€å‘è€…åˆ›å»ºè‡ªå®šä¹‰æ‰©å±•æ¥å¢å¼ºæ•°æ®åº“åŠŸèƒ½ã€‚æ’ä»¶å¼€å‘åŒ…æ‹¬Cè¯­è¨€æ‰©å±•ã€SQLæ‰©å±•å’Œç¬¬ä¸‰æ–¹é›†æˆï¼Œå®ç°åŠŸèƒ½çš„æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ã€‚

**English Definition**: The extension system is a plugin architecture provided by PostgreSQL that allows developers to create custom extensions to enhance database functionality. Plugin development includes C language extensions, SQL extensions, and third-party integrations, achieving modularity and extensibility of functionality.

### 2.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\extension}{\mathcal{E}}
\newcommand{\plugin}{\mathcal{P}}
\newcommand{\interface}{\mathcal{I}}

% æ‰©å±•ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰
\extension = \{p_1, p_2, \ldots, p_n\}

å…¶ä¸­æ¯ä¸ªæ’ä»¶ p_i = (name_i, version_i, interfaces_i, dependencies_i) è¡¨ç¤ºï¼š
- name_i: æ’ä»¶åç§°
- version_i: æ’ä»¶ç‰ˆæœ¬
- interfaces_i: æ¥å£é›†åˆ
- dependencies_i: ä¾èµ–å…³ç³»
```

### 2.3 æ ¸å¿ƒç‰¹æ€§

- **æ¨¡å—åŒ–è®¾è®¡**: åŠŸèƒ½æ¨¡å—åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒæ‰©å±•ç‰ˆæœ¬æ§åˆ¶å’Œå‡çº§
- **ä¾èµ–ç®¡ç†**: è‡ªåŠ¨å¤„ç†æ‰©å±•ä¾èµ–å…³ç³»
- **æ¥å£æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„æ‰©å±•æ¥å£è§„èŒƒ
- **çƒ­æ’æ‹”**: æ”¯æŒè¿è¡Œæ—¶åŠ è½½å’Œå¸è½½æ‰©å±•

## ä¸‰ã€æ‰©å±•ç³»ç»Ÿæ¶æ„

### 3.1 æ‰©å±•ç®¡ç†

```sql
-- æŸ¥çœ‹å·²å®‰è£…æ‰©å±•
SELECT
    extname,
    extversion,
    extrelocatable,
    extconfig,
    extcondition
FROM pg_extension
ORDER BY extname;

-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS hstore;
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- æ›´æ–°æ‰©å±•
ALTER EXTENSION hstore UPDATE TO '1.8';

-- å¸è½½æ‰©å±•
DROP EXTENSION IF EXISTS hstore;
```

### 3.2 æ‰©å±•é…ç½®

```sql
-- æŸ¥çœ‹æ‰©å±•é…ç½®
SELECT
    name,
    setting,
    unit,
    context,
    vartype,
    source,
    min_val,
    max_val,
    enumvals
FROM pg_settings
WHERE name LIKE '%extension%';

-- é…ç½®æ‰©å±•å‚æ•°
ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements';
SELECT pg_reload_conf();
```

### 3.3 æ‰©å±•ç”Ÿå‘½å‘¨æœŸ

**æ‰©å±•ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```sql
-- 1. åˆ›å»ºæ‰©å±•
CREATE EXTENSION my_extension;

-- 2. æ›´æ–°æ‰©å±•
ALTER EXTENSION my_extension UPDATE TO '1.1';

-- 3. æŸ¥çœ‹æ‰©å±•ç‰ˆæœ¬
SELECT extname, extversion FROM pg_extension WHERE extname = 'my_extension';

-- 4. å¸è½½æ‰©å±•
DROP EXTENSION my_extension;
```

## å››ã€Cè¯­è¨€æ‰©å±•å¼€å‘

### 4.1 æ‰©å±•ç»“æ„

```c
// æ‰©å±•å¤´æ–‡ä»¶
#include "postgres.h"
#include "fmgr.h"
#include "utils/builtins.h"

PG_MODULE_MAGIC;

// å‡½æ•°å£°æ˜
PG_FUNCTION_INFO_V1(my_function);

// å‡½æ•°å®ç°
Datum
my_function(PG_FUNCTION_ARGS)
{
    text *arg1 = PG_GETARG_TEXT_PP(0);
    int32 arg2 = PG_GETARG_INT32(1);

    // å‡½æ•°é€»è¾‘
    text *result = cstring_to_text("Hello from extension!");

    PG_RETURN_TEXT_P(result);
}
```

### 4.2 æ•°æ®ç±»å‹æ‰©å±•

```c
// è‡ªå®šä¹‰æ•°æ®ç±»å‹
typedef struct {
    int32 x;
    int32 y;
} Point2D;

// è¾“å…¥å‡½æ•°
PG_FUNCTION_INFO_V1(point2d_in);
Datum
point2d_in(PG_FUNCTION_ARGS)
{
    char *str = PG_GETARG_CSTRING(0);
    Point2D *point = (Point2D *) palloc(sizeof(Point2D));

    if (sscanf(str, "(%d,%d)", &point->x, &point->y) != 2)
        ereport(ERROR,
                (errcode(ERRCODE_INVALID_TEXT_REPRESENTATION),
                 errmsg("invalid input syntax for type point2d: \"%s\"", str)));

    PG_RETURN_POINTER(point);
}

// è¾“å‡ºå‡½æ•°
PG_FUNCTION_INFO_V1(point2d_out);
Datum
point2d_out(PG_FUNCTION_ARGS)
{
    Point2D *point = (Point2D *) PG_GETARG_POINTER(0);
    char *result = psprintf("(%d,%d)", point->x, point->y);

    PG_RETURN_CSTRING(result);
}
```

### 4.3 æ“ä½œç¬¦æ‰©å±•

```c
// æ“ä½œç¬¦å‡½æ•°
PG_FUNCTION_INFO_V1(point2d_add);
Datum
point2d_add(PG_FUNCTION_ARGS)
{
    Point2D *p1 = (Point2D *) PG_GETARG_POINTER(0);
    Point2D *p2 = (Point2D *) PG_GETARG_POINTER(1);
    Point2D *result = (Point2D *) palloc(sizeof(Point2D));

    result->x = p1->x + p2->x;
    result->y = p1->y + p2->y;

    PG_RETURN_POINTER(result);
}

// æ¯”è¾ƒå‡½æ•°
PG_FUNCTION_INFO_V1(point2d_eq);
Datum
point2d_eq(PG_FUNCTION_ARGS)
{
    Point2D *p1 = (Point2D *) PG_GETARG_POINTER(0);
    Point2D *p2 = (Point2D *) PG_GETARG_POINTER(1);

    PG_RETURN_BOOL(p1->x == p2->x && p1->y == p2->y);
}
```

### 4.4 å‡½æ•°æ‰©å±•

**å‡½æ•°æ‰©å±•ç¤ºä¾‹**ï¼š

```c
// å­—ç¬¦ä¸²å¤„ç†å‡½æ•°
PG_FUNCTION_INFO_V1(reverse_string);
Datum
reverse_string(PG_FUNCTION_ARGS)
{
    text *input = PG_GETARG_TEXT_PP(0);
    int len = VARSIZE_ANY_EXHDR(input);
    text *result;
    char *in_str, *out_str;
    int i;

    if (len == 0)
        PG_RETURN_TEXT_P(input);

    result = (text *) palloc(VARHDRSZ + len);
    SET_VARSIZE(result, VARHDRSZ + len);

    in_str = VARDATA_ANY(input);
    out_str = VARDATA(result);

    for (i = 0; i < len; i++)
        out_str[i] = in_str[len - 1 - i];

    PG_RETURN_TEXT_P(result);
}
```

## äº”ã€SQLæ‰©å±•å¼€å‘

### 5.1 æ§åˆ¶æ–‡ä»¶

```sql
-- æ‰©å±•æ§åˆ¶æ–‡ä»¶ (my_extension.control)
comment = 'My custom extension'
default_version = '1.0'
module_pathname = '$libdir/my_extension'
relocatable = true
```

### 5.2 å®‰è£…è„šæœ¬

```sql
-- æ‰©å±•å®‰è£…è„šæœ¬ (my_extension--1.0.sql)
-- åˆ›å»ºè‡ªå®šä¹‰ç±»å‹
CREATE TYPE point2d;

-- åˆ›å»ºè¾“å…¥è¾“å‡ºå‡½æ•°
CREATE FUNCTION point2d_in(cstring)
RETURNS point2d
AS 'MODULE_PATHNAME'
LANGUAGE C IMMUTABLE STRICT;

CREATE FUNCTION point2d_out(point2d)
RETURNS cstring
AS 'MODULE_PATHNAME'
LANGUAGE C IMMUTABLE STRICT;

-- åˆ›å»ºç±»å‹
CREATE TYPE point2d (
    INPUT = point2d_in,
    OUTPUT = point2d_out,
    INTERNALLENGTH = 8,
    ALIGNMENT = int4,
    STORAGE = plain
);

-- åˆ›å»ºæ“ä½œç¬¦
CREATE OPERATOR + (
    LEFTARG = point2d,
    RIGHTARG = point2d,
    PROCEDURE = point2d_add,
    COMMUTATOR = +
);

CREATE OPERATOR = (
    LEFTARG = point2d,
    RIGHTARG = point2d,
    PROCEDURE = point2d_eq,
    COMMUTATOR = =,
    NEGATOR = <>
);
```

### 5.3 å‡çº§è„šæœ¬

```sql
-- æ‰©å±•å‡çº§è„šæœ¬ (my_extension--1.0--1.1.sql)
-- æ·»åŠ æ–°å‡½æ•°
CREATE FUNCTION point2d_distance(point2d, point2d)
RETURNS float8
AS 'MODULE_PATHNAME'
LANGUAGE C IMMUTABLE STRICT;

-- æ·»åŠ æ–°æ“ä½œç¬¦
CREATE OPERATOR <-> (
    LEFTARG = point2d,
    RIGHTARG = point2d,
    PROCEDURE = point2d_distance,
    COMMUTATOR = <->
);
```

### 5.4 å¸è½½è„šæœ¬

```sql
-- æ‰©å±•å¸è½½è„šæœ¬ (my_extension--1.1--uninstall.sql)
-- åˆ é™¤æ“ä½œç¬¦
DROP OPERATOR IF EXISTS <-> (point2d, point2d);

-- åˆ é™¤å‡½æ•°
DROP FUNCTION IF EXISTS point2d_distance(point2d, point2d);
```

## å…­ã€ç¬¬ä¸‰æ–¹æ‰©å±•é›†æˆ

### 6.1 æµè¡Œæ‰©å±•

```sql
-- å…¨æ–‡æœç´¢æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS btree_gin;

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_content_trgm ON documents USING gin (content gin_trgm_ops);

-- ç›¸ä¼¼åº¦æœç´¢
SELECT title, similarity(title, 'postgresql database') as sim
FROM documents
WHERE title % 'postgresql database'
ORDER BY sim DESC;

-- ç»Ÿè®¡ä¿¡æ¯æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡
SELECT
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

### 6.2 åœ°ç†ç©ºé—´æ‰©å±•

```sql
-- PostGISæ‰©å±•
CREATE EXTENSION IF NOT EXISTS postgis;

-- åˆ›å»ºåœ°ç†ç©ºé—´è¡¨
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    geom GEOMETRY(POINT, 4326)
);

-- æ’å…¥åœ°ç†æ•°æ®
INSERT INTO locations (name, geom) VALUES
('New York', ST_GeomFromText('POINT(-74.0059 40.7128)', 4326)),
('London', ST_GeomFromText('POINT(-0.1276 51.5074)', 4326));

-- åœ°ç†ç©ºé—´æŸ¥è¯¢
SELECT
    name,
    ST_Distance(geom, ST_GeomFromText('POINT(-74.0059 40.7128)', 4326)) as distance
FROM locations
ORDER BY distance;
```

### 6.3 æ—¶é—´åºåˆ—æ‰©å±•

```sql
-- TimescaleDBæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- åˆ›å»ºæ—¶é—´åºåˆ—è¡¨
CREATE TABLE sensor_data (
    time TIMESTAMPTZ NOT NULL,
    sensor_id INTEGER NOT NULL,
    temperature DOUBLE PRECISION NULL,
    humidity DOUBLE PRECISION NULL
);

-- è½¬æ¢ä¸ºè¶…è¡¨
SELECT create_hypertable('sensor_data', 'time');

-- æ—¶é—´åºåˆ—æŸ¥è¯¢
SELECT
    time_bucket('1 hour', time) as hour,
    sensor_id,
    AVG(temperature) as avg_temp,
    MAX(temperature) as max_temp
FROM sensor_data
WHERE time >= NOW() - INTERVAL '24 hours'
GROUP BY hour, sensor_id
ORDER BY hour;
```

### 6.4 å‘é‡æ•°æ®åº“æ‰©å±•

```sql
-- pgvectoræ‰©å±•ï¼ˆPostgreSQL 18æ¨èï¼‰
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºå‘é‡è¡¨
CREATE TABLE embeddings (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX ON embeddings USING ivfflat (embedding vector_cosine_ops);

-- å‘é‡ç›¸ä¼¼åº¦æœç´¢
SELECT id, content, 1 - (embedding <=> query_embedding) AS similarity
FROM embeddings
ORDER BY embedding <=> query_embedding
LIMIT 10;
```

### 6.5 åˆ—å­˜å‚¨æ‰©å±• ğŸ†•

**åˆ—å­˜å‚¨æ‰©å±•æ¦‚è¿°**ï¼š

PostgreSQLåŸç”Ÿé‡‡ç”¨è¡Œå­˜å‚¨ï¼Œä½†é€šè¿‡æ‰©å±•å¯ä»¥å®ç°åˆ—å­˜å‚¨ï¼Œç‰¹åˆ«é€‚åˆOLAPï¼ˆåœ¨çº¿åˆ†æå¤„ç†ï¼‰åœºæ™¯ã€‚

**ä¸»è¦åˆ—å­˜å‚¨æ‰©å±•**ï¼š

| æ‰©å±• | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **cstore_fdw** | å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ | åªè¯»ã€é«˜å‹ç¼©ç‡ | å†å²æ•°æ®åˆ†æ |
| **Citusåˆ—å­˜å‚¨** | åˆ†å¸ƒå¼æ‰©å±• | åˆ†å¸ƒå¼ã€å¯æ‰©å±• | å¤§è§„æ¨¡æ•°æ®ä»“åº“ |
| **Greenplum** | ç‹¬ç«‹ç³»ç»Ÿ | å®Œæ•´åˆ—å­˜å‚¨ã€é«˜æ€§èƒ½ | ä¼ä¸šçº§æ•°æ®ä»“åº“ |

**cstore_fdwåˆ—å­˜å‚¨æ‰©å±•**ï¼š

```sql
-- 1. å®‰è£…cstore_fdwæ‰©å±•
CREATE EXTENSION IF NOT EXISTS cstore_fdw;

-- 2. åˆ›å»ºåˆ—å­˜å‚¨æœåŠ¡å™¨
CREATE SERVER cstore_server
FOREIGN DATA WRAPPER cstore_fdw;

-- 3. åˆ›å»ºåˆ—å­˜å‚¨è¡¨
CREATE FOREIGN TABLE sales_columnar (
    id BIGINT,
    product_id INTEGER,
    sale_date DATE,
    amount DECIMAL(10,2),
    quantity INTEGER,
    customer_id INTEGER
) SERVER cstore_server
OPTIONS (
    compression 'pglz',  -- å‹ç¼©ç®—æ³•ï¼špglz, lz4, zstd
    stripe_row_count '150000'  -- æ¡å¸¦è¡Œæ•°
);

-- 4. ä»è¡Œå­˜å‚¨è¡¨å¯¼å…¥æ•°æ®
INSERT INTO sales_columnar
SELECT id, product_id, sale_date, amount, quantity, customer_id
FROM sales
WHERE sale_date < '2024-01-01';  -- å†å²æ•°æ®

-- 5. åˆ—å­˜å‚¨æŸ¥è¯¢ï¼ˆåªæ‰«æéœ€è¦çš„åˆ—ï¼‰
SELECT
    product_id,
    SUM(amount) as total_amount,
    SUM(quantity) as total_quantity,
    AVG(amount) as avg_amount
FROM sales_columnar
WHERE sale_date BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY product_id
ORDER BY total_amount DESC
LIMIT 100;

-- æ€§èƒ½ä¼˜åŠ¿ï¼š
-- - åªæ‰«æproduct_id, amount, quantity, sale_dateåˆ—
-- - I/Oå‡å°‘50-90%
-- - å‹ç¼©ç‡70-80%
-- - æŸ¥è¯¢æ€§èƒ½æå‡5-10å€
```

**åˆ—å­˜å‚¨å‹ç¼©é…ç½®**ï¼š

```sql
-- ä½¿ç”¨zstdå‹ç¼©ï¼ˆæ›´é«˜å‹ç¼©ç‡ï¼‰
CREATE FOREIGN TABLE analytics_columnar (
    id BIGINT,
    metric_name TEXT,
    metric_value DOUBLE PRECISION,
    timestamp TIMESTAMP
) SERVER cstore_server
OPTIONS (
    compression 'zstd',  -- zstdå‹ç¼©ï¼Œå‹ç¼©ç‡æ›´é«˜
    stripe_row_count '150000'
);

-- å‹ç¼©ç®—æ³•å¯¹æ¯”ï¼š
-- pglz: å‹ç¼©ç‡70%ï¼Œå‹ç¼©é€Ÿåº¦å¿«
-- lz4: å‹ç¼©ç‡60%ï¼Œå‹ç¼©é€Ÿåº¦æœ€å¿«
-- zstd: å‹ç¼©ç‡80%ï¼Œå‹ç¼©ç‡æœ€é«˜
```

**Citusåˆ—å­˜å‚¨ï¼ˆåˆ†å¸ƒå¼ï¼‰**ï¼š

```sql
-- 1. å®‰è£…Citusæ‰©å±•
CREATE EXTENSION IF NOT EXISTS citus;

-- 2. åˆ›å»ºåˆ†å¸ƒå¼åˆ—å­˜å‚¨è¡¨
CREATE TABLE sales_distributed_columnar (
    id BIGINT,
    product_id INTEGER,
    sale_date DATE,
    amount DECIMAL(10,2)
) USING columnar;  -- åˆ—å­˜å‚¨æ¨¡å¼

-- 3. åˆ†å¸ƒè¡¨
SELECT create_distributed_table('sales_distributed_columnar', 'product_id');

-- 4. åˆ—å­˜å‚¨æŸ¥è¯¢
SELECT product_id, SUM(amount)
FROM sales_distributed_columnar
WHERE sale_date >= '2024-01-01'
GROUP BY product_id;
```

**åˆ—å­˜å‚¨æ‰©å±•ä½¿ç”¨å»ºè®®**ï¼š

1. **é€‚ç”¨åœºæ™¯**ï¼š
   - âœ… å†å²æ•°æ®åˆ†æï¼ˆåªè¯»ï¼‰
   - âœ… OLAPæŸ¥è¯¢ï¼ˆèšåˆã€ç»Ÿè®¡ï¼‰
   - âœ… æ•°æ®ä»“åº“åœºæ™¯
   - âŒ OLTPåœºæ™¯ï¼ˆé¢‘ç¹æ›´æ–°ï¼‰
   - âŒ ç‚¹æŸ¥è¯¢ï¼ˆå•è¡ŒæŸ¥è¯¢ï¼‰

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - åªæŸ¥è¯¢éœ€è¦çš„åˆ—
   - ä½¿ç”¨åˆé€‚çš„å‹ç¼©ç®—æ³•
   - åˆç†è®¾ç½®æ¡å¸¦è¡Œæ•°
   - å®šæœŸå½’æ¡£å†å²æ•°æ®åˆ°åˆ—å­˜å‚¨

3. **æ··åˆå­˜å‚¨æ¶æ„**ï¼š

   ```text
   çƒ­æ•°æ®ï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰â†’ è¡Œå­˜å‚¨è¡¨ï¼ˆæ”¯æŒæ›´æ–°ï¼‰
   æ¸©æ•°æ®ï¼ˆ3-12ä¸ªæœˆï¼‰â†’ è¡Œå­˜å‚¨åˆ†åŒºè¡¨ï¼ˆåªè¯»ï¼‰
   å†·æ•°æ®ï¼ˆ12ä¸ªæœˆ+ï¼‰â†’ åˆ—å­˜å‚¨è¡¨ï¼ˆåˆ†ææŸ¥è¯¢ï¼‰
   ```

## ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 7.1 æ‰©å±•ç±»å‹å¯¹æ¯”

| æ‰©å±•ç±»å‹ | å¼€å‘éš¾åº¦ | æ€§èƒ½ | çµæ´»æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|--------|---------|
| Cè¯­è¨€æ‰©å±• | é«˜ | æé«˜ | é«˜ | é«˜æ€§èƒ½ã€åº•å±‚åŠŸèƒ½ |
| SQLæ‰©å±• | ä½ | ä¸­ | ä¸­ | ç®€å•åŠŸèƒ½ã€å¿«é€Ÿå¼€å‘ |
| ç¬¬ä¸‰æ–¹æ‰©å±• | ä¸­ | é«˜ | é«˜ | æˆç†ŸåŠŸèƒ½ã€ç¤¾åŒºæ”¯æŒ |

### 7.2 å¼€å‘è¯­è¨€å¯¹æ¯”

| è¯­è¨€ | æ€§èƒ½ | å¼€å‘æ•ˆç‡ | ç»´æŠ¤æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|---------|---------|
| C | æé«˜ | ä½ | é«˜ | æ ¸å¿ƒåŠŸèƒ½ã€é«˜æ€§èƒ½ |
| SQL | ä¸­ | é«˜ | ä½ | ç®€å•åŠŸèƒ½ã€å¿«é€Ÿå¼€å‘ |
| PL/pgSQL | ä¸­ | ä¸­ | ä¸­ | ä¸šåŠ¡é€»è¾‘ã€å­˜å‚¨è¿‡ç¨‹ |

## å…«ã€æ‰©å±•å¼€å‘æœ€ä½³å®è·µ

### 8.1 é”™è¯¯å¤„ç†

```c
// é”™è¯¯å¤„ç†ç¤ºä¾‹
PG_FUNCTION_INFO_V1(safe_divide);
Datum
safe_divide(PG_FUNCTION_ARGS)
{
    float8 arg1 = PG_GETARG_FLOAT8(0);
    float8 arg2 = PG_GETARG_FLOAT8(1);

    if (arg2 == 0.0)
        ereport(ERROR,
                (errcode(ERRCODE_DIVISION_BY_ZERO),
                 errmsg("division by zero")));

    PG_RETURN_FLOAT8(arg1 / arg2);
}
```

### 8.2 å†…å­˜ç®¡ç†

```c
// å†…å­˜ç®¡ç†ç¤ºä¾‹
PG_FUNCTION_INFO_V1(create_array);
Datum
create_array(PG_FUNCTION_ARGS)
{
    int32 count = PG_GETARG_INT32(0);
    ArrayType *result;
    Datum *values;
    bool *nulls;
    int i;

    // åˆ†é…å†…å­˜
    values = (Datum *) palloc(sizeof(Datum) * count);
    nulls = (bool *) palloc(sizeof(bool) * count);

    // å¡«å……æ•°ç»„
    for (i = 0; i < count; i++) {
        values[i] = Int32GetDatum(i * i);
        nulls[i] = false;
    }

    // åˆ›å»ºæ•°ç»„
    result = construct_array(values, count, INT4OID, 4, true, 'i');

    // æ¸…ç†å†…å­˜
    pfree(values);
    pfree(nulls);

    PG_RETURN_ARRAYTYPE_P(result);
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–

```c
// æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
PG_FUNCTION_INFO_V1(fast_string_compare);
Datum
fast_string_compare(PG_FUNCTION_ARGS)
{
    text *arg1 = PG_GETARG_TEXT_PP(0);
    text *arg2 = PG_GETARG_TEXT_PP(1);
    int result;

    // ä½¿ç”¨å¿«é€Ÿæ¯”è¾ƒ
    result = text_cmp(arg1, arg2);

    if (result < 0)
        PG_RETURN_INT32(-1);
    else if (result > 0)
        PG_RETURN_INT32(1);
    else
        PG_RETURN_INT32(0);
}
```

## ä¹ã€å®è·µæ¡ˆä¾‹

### 9.1 æ¡ˆä¾‹1ï¼šè‡ªå®šä¹‰èšåˆå‡½æ•°

```c
// è‡ªå®šä¹‰èšåˆå‡½æ•°
typedef struct {
    int64 sum;
    int64 count;
} MyAggState;

PG_FUNCTION_INFO_V1(my_agg_transfn);
Datum
my_agg_transfn(PG_FUNCTION_ARGS)
{
    MyAggState *state;
    int64 value = PG_GETARG_INT64(0);

    if (PG_ARGISNULL(0))
        PG_RETURN_NULL();

    if (PG_ARGISNULL(1)) {
        state = (MyAggState *) palloc(sizeof(MyAggState));
        state->sum = 0;
        state->count = 0;
    } else {
        state = (MyAggState *) PG_GETARG_POINTER(1);
    }

    state->sum += value;
    state->count++;

    PG_RETURN_POINTER(state);
}

PG_FUNCTION_INFO_V1(my_agg_finalfn);
Datum
my_agg_finalfn(PG_FUNCTION_ARGS)
{
    MyAggState *state = (MyAggState *) PG_GETARG_POINTER(0);

    if (state == NULL || state->count == 0)
        PG_RETURN_NULL();

    PG_RETURN_FLOAT8((double) state->sum / state->count);
}
```

### 9.2 æ¡ˆä¾‹2ï¼šè‡ªå®šä¹‰ç´¢å¼•

```c
// è‡ªå®šä¹‰ç´¢å¼•æ“ä½œç¬¦ç±»
PG_FUNCTION_INFO_V1(my_btree_compare);
Datum
my_btree_compare(PG_FUNCTION_ARGS)
{
    MyType *a = (MyType *) PG_GETARG_POINTER(0);
    MyType *b = (MyType *) PG_GETARG_POINTER(1);

    if (a->value < b->value)
        PG_RETURN_INT32(-1);
    else if (a->value > b->value)
        PG_RETURN_INT32(1);
    else
        PG_RETURN_INT32(0);
}
```

### 9.3 æ¡ˆä¾‹3ï¼šå®Œæ•´æ‰©å±•ç¤ºä¾‹

**åˆ›å»ºå®Œæ•´æ‰©å±•çš„æ­¥éª¤**ï¼š

1. **åˆ›å»ºç›®å½•ç»“æ„**ï¼š

    ```bash
    my_extension/
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ my_extension.control
    â”œâ”€â”€ my_extension--1.0.sql
    â””â”€â”€ my_extension.c
    ```

2. **Makefile**ï¼š

    ```makefile
    MODULES = my_extension
    PG_CONFIG = pg_config
    PGXS := $(shell $(PG_CONFIG) --pgxs)
    include $(PGXS)
    ```

3. **ç¼–è¯‘å’Œå®‰è£…**ï¼š

    ```bash
    make
    make install
    ```

4. **ä½¿ç”¨æ‰©å±•**ï¼š

    ```sql
    CREATE EXTENSION my_extension;
    ```

## åã€æ•…éšœæ’æŸ¥

### 10.1 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šæ‰©å±•åŠ è½½å¤±è´¥**:

```sql
-- æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'my_extension';

-- æŸ¥çœ‹é”™è¯¯æ—¥å¿—
SHOW log_min_messages;
```

**é—®é¢˜2ï¼šå‡½æ•°æ‰¾ä¸åˆ°**:

```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT proname, pronargs FROM pg_proc WHERE proname = 'my_function';

-- æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²åŠ è½½
SELECT * FROM pg_extension WHERE extname = 'my_extension';
```

### 10.2 è°ƒè¯•æŠ€å·§

**è°ƒè¯•æ–¹æ³•**ï¼š

1. **ä½¿ç”¨RAISE NOTICE**ï¼š

    ```sql
    RAISE NOTICE 'Debug: value = %', my_value;
    ```

2. **æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’**ï¼š

    ```sql
    EXPLAIN ANALYZE SELECT my_function(...);
    ```

3. **æ£€æŸ¥ç³»ç»Ÿè¡¨**ï¼š

    ```sql
    SELECT * FROM pg_proc WHERE proname LIKE 'my_%';
    ```

## åä¸€ã€å‚è€ƒèµ„æº

### 11.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQLæ‰©å±•å¼€å‘](https://www.postgresql.org/docs/current/extend.html)
- [PostgreSQL Cè¯­è¨€æ‰©å±•](https://www.postgresql.org/docs/current/xfunc-c.html)
- [PostgreSQLæ‰©å±•ç³»ç»Ÿ](https://www.postgresql.org/docs/current/extend-extensions.html)

### 11.2 ç›¸å…³æ–‡æ¡£

- [PostgreSQLç³»ç»Ÿæ¶æ„](../01-æ ¸å¿ƒè¯¾ç¨‹/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„
- [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../01-æ ¸å¿ƒåŸºç¡€/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†ã€åˆ—å­˜å‚¨æ¶æ„åˆ†æã€åˆ—å‹ç¼©æŠ€æœ¯è¯¦è§£ ğŸ†•
- [ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–](../02-æŸ¥è¯¢å¤„ç†/02.02-ç´¢å¼•ç»“æ„ä¸ä¼˜åŒ–.md) - åˆ—å­˜å‚¨ç´¢å¼•ä¼˜åŒ– ğŸ†•
- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../02-æŸ¥è¯¢å¤„ç†/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŒ– ğŸ†•
- [æ•°æ®ä»“åº“å®è·µæ¡ˆä¾‹](../12-å…¨é¢ä½¿ç”¨åˆ†æ/09-å®è·µæ¡ˆä¾‹/09.05-æ•°æ®ä»“åº“å®è·µæ¡ˆä¾‹.md) - åˆ—å­˜å‚¨å®è·µ ğŸ†•
- [åˆ—å­˜å‚¨ç¤ºä¾‹ä»£ç ](../examples/09-columnar-storage/README.md) - 3ä¸ªå®Œæ•´ç¤ºä¾‹ ğŸ†•

---

## åäºŒã€å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. Obe, R., & Hsu, L. (2015). PostgreSQL: Up and Running (2nd ed.). O'Reilly Media.
3. Krosing, H., & Roybal, K. (2019). PostgreSQL 11 Server Side Programming Quick Start Guide. Packt Publishing.
4. Riggs, S., et al. (2017). PostgreSQL 9.6 High Performance. Packt Publishing.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: Data Science Team

### 8.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„æ•°æ®åº“ç³»ç»Ÿ
- **è½¯ä»¶æ¶æ„**: è½¯ä»¶æ¶æ„è®¾è®¡
- **æ¨¡å—åŒ–è®¾è®¡**: æ¨¡å—åŒ–ç¼–ç¨‹

### 8.2 ä¸‹ä½æ¦‚å¿µ

- **Cè¯­è¨€æ‰©å±•**: Cè¯­è¨€æ’ä»¶å¼€å‘
- **SQLæ‰©å±•**: SQLè„šæœ¬æ‰©å±•
- **ç¬¬ä¸‰æ–¹é›†æˆ**: ç¬¬ä¸‰æ–¹åº“é›†æˆ

### 8.3 å¹³è¡Œæ¦‚å¿µ

- **æ’ä»¶ç³»ç»Ÿ**: æ’ä»¶æ¶æ„
- **æ¨¡å—ç³»ç»Ÿ**: æ¨¡å—åŒ–ç³»ç»Ÿ
- **APIè®¾è®¡**: åº”ç”¨ç¨‹åºæ¥å£è®¾è®¡

## 9. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. Obe, R., & Hsu, L. (2015). PostgreSQL: Up and Running (2nd ed.). O'Reilly Media.
3. Krosing, H., & Roybal, K. (2019). PostgreSQL 11 Server Side Programming Quick Start Guide. Packt Publishing.
4. Riggs, S., et al. (2017). PostgreSQL 9.6 High Performance. Packt Publishing.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

## 10. Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/extend.html>
  - <https://www.postgresql.org/docs/current/contrib.html>
