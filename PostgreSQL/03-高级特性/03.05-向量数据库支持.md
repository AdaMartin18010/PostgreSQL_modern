# PostgreSQLå‘é‡æ•°æ®åº“æ”¯æŒå®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€è¯­ä¹‰æœç´¢ã€æ¨èç³»ç»Ÿã€RAGç³»ç»Ÿ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå‘é‡æ•°æ®åº“æ”¯æŒå®Œæ•´æŒ‡å—](#postgresqlå‘é‡æ•°æ®åº“æ”¯æŒå®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 å‘é‡æ•°æ®åº“æ¦‚å¿µ](#11-å‘é‡æ•°æ®åº“æ¦‚å¿µ)
    - [1.2 pgvectoræ‰©å±•](#12-pgvectoræ‰©å±•)
    - [1.3 åº”ç”¨åœºæ™¯](#13-åº”ç”¨åœºæ™¯)
    - [1.4 ç‰ˆæœ¬è¦æ±‚](#14-ç‰ˆæœ¬è¦æ±‚)
  - [äºŒã€æ ¸å¿ƒæ¦‚å¿µ](#äºŒæ ¸å¿ƒæ¦‚å¿µ)
    - [2.1 å‘é‡ç±»å‹](#21-å‘é‡ç±»å‹)
    - [2.2 è·ç¦»åº¦é‡](#22-è·ç¦»åº¦é‡)
    - [2.3 ç›¸ä¼¼åº¦è®¡ç®—](#23-ç›¸ä¼¼åº¦è®¡ç®—)
    - [2.4 æ€ç»´å¯¼å›¾](#24-æ€ç»´å¯¼å›¾)
  - [ä¸‰ã€å®‰è£…ä¸é…ç½®](#ä¸‰å®‰è£…ä¸é…ç½®)
    - [3.1 å®‰è£…pgvectoræ‰©å±•](#31-å®‰è£…pgvectoræ‰©å±•)
    - [3.2 åŸºç¡€é…ç½®](#32-åŸºç¡€é…ç½®)
    - [3.3 PostgreSQL 18ä¼˜åŒ–é…ç½®](#33-postgresql-18ä¼˜åŒ–é…ç½®)
  - [å››ã€ç´¢å¼•ä¸ç®—æ³•](#å››ç´¢å¼•ä¸ç®—æ³•)
    - [4.1 HNSWç´¢å¼•](#41-hnswç´¢å¼•)
    - [4.2 IVFFlatç´¢å¼•](#42-ivfflatç´¢å¼•)
    - [4.3 ç´¢å¼•é€‰æ‹©ç­–ç•¥](#43-ç´¢å¼•é€‰æ‹©ç­–ç•¥)
  - [äº”ã€æŸ¥è¯¢ä¸æ£€ç´¢](#äº”æŸ¥è¯¢ä¸æ£€ç´¢)
    - [5.1 åŸºç¡€å‘é‡æŸ¥è¯¢](#51-åŸºç¡€å‘é‡æŸ¥è¯¢)
    - [5.2 æ··åˆæ£€ç´¢](#52-æ··åˆæ£€ç´¢)
    - [5.3 æ‰¹é‡æŸ¥è¯¢](#53-æ‰¹é‡æŸ¥è¯¢)
  - [å…­ã€PostgreSQL 18ä¼˜åŒ–](#å…­postgresql-18ä¼˜åŒ–)
    - [6.1 å¼‚æ­¥I/Oä¼˜åŒ–](#61-å¼‚æ­¥ioä¼˜åŒ–)
    - [6.2 pgvector 2.0æ–°ç‰¹æ€§](#62-pgvector-20æ–°ç‰¹æ€§)
    - [6.3 æ€§èƒ½æå‡](#63-æ€§èƒ½æå‡)
  - [ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#ä¸ƒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [7.1 ç´¢å¼•ç®—æ³•å¯¹æ¯”](#71-ç´¢å¼•ç®—æ³•å¯¹æ¯”)
    - [7.2 è·ç¦»åº¦é‡å¯¹æ¯”](#72-è·ç¦»åº¦é‡å¯¹æ¯”)
    - [7.3 åº”ç”¨åœºæ™¯å¯¹æ¯”](#73-åº”ç”¨åœºæ™¯å¯¹æ¯”)
  - [å…«ã€å®è·µæ¡ˆä¾‹](#å…«å®è·µæ¡ˆä¾‹)
    - [8.1 è¯­ä¹‰æœç´¢ç³»ç»Ÿ](#81-è¯­ä¹‰æœç´¢ç³»ç»Ÿ)
    - [8.2 RAGçŸ¥è¯†åº“](#82-ragçŸ¥è¯†åº“)
    - [8.3 æ¨èç³»ç»Ÿ](#83-æ¨èç³»ç»Ÿ)
  - [ä¹ã€æ€§èƒ½ä¼˜åŒ–](#ä¹æ€§èƒ½ä¼˜åŒ–)
    - [9.1 ç´¢å¼•ä¼˜åŒ–](#91-ç´¢å¼•ä¼˜åŒ–)
    - [9.2 æŸ¥è¯¢ä¼˜åŒ–](#92-æŸ¥è¯¢ä¼˜åŒ–)
    - [9.3 å­˜å‚¨ä¼˜åŒ–](#93-å­˜å‚¨ä¼˜åŒ–)
  - [åã€ç›‘æ§ä¸è¯Šæ–­](#åç›‘æ§ä¸è¯Šæ–­)
    - [10.1 æ€§èƒ½ç›‘æ§](#101-æ€§èƒ½ç›‘æ§)
    - [10.2 ç´¢å¼•è¯Šæ–­](#102-ç´¢å¼•è¯Šæ–­)
    - [10.3 é—®é¢˜æ’æŸ¥](#103-é—®é¢˜æ’æŸ¥)
  - [åä¸€ã€æœ€ä½³å®è·µ](#åä¸€æœ€ä½³å®è·µ)
    - [11.1 è®¾è®¡æœ€ä½³å®è·µ](#111-è®¾è®¡æœ€ä½³å®è·µ)
    - [11.2 æ€§èƒ½æœ€ä½³å®è·µ](#112-æ€§èƒ½æœ€ä½³å®è·µ)
  - [åäºŒã€å‚è€ƒèµ„æº](#åäºŒå‚è€ƒèµ„æº)
    - [12.1 å®˜æ–¹æ–‡æ¡£](#121-å®˜æ–¹æ–‡æ¡£)
    - [12.2 ç½‘ç»œèµ„æº](#122-ç½‘ç»œèµ„æº)
    - [12.3 ç›¸å…³æ–‡æ¡£](#123-ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 å‘é‡æ•°æ®åº“æ¦‚å¿µ

å‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®çš„æ•°æ®åº“ç³»ç»Ÿã€‚åœ¨AIå’Œæœºå™¨å­¦ä¹ åº”ç”¨ä¸­ï¼Œå‘é‡é€šå¸¸è¡¨ç¤ºï¼š

- **æ–‡æœ¬åµŒå…¥**ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å€¼å‘é‡
- **å›¾åƒç‰¹å¾**ï¼šå›¾åƒçš„ç‰¹å¾å‘é‡è¡¨ç¤º
- **ç”¨æˆ·/ç‰©å“ç‰¹å¾**ï¼šæ¨èç³»ç»Ÿä¸­çš„ç‰¹å¾å‘é‡
- **éŸ³é¢‘ç‰¹å¾**ï¼šéŸ³é¢‘ä¿¡å·çš„ç‰¹å¾å‘é‡

**å‘é‡æ•°æ®åº“çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š

- é«˜æ•ˆçš„å‘é‡å­˜å‚¨
- å¿«é€Ÿçš„ç›¸ä¼¼åº¦æœç´¢
- æ”¯æŒå¤§è§„æ¨¡å‘é‡æ•°æ®
- ä¸å…³ç³»å‹æ•°æ®æ··åˆæŸ¥è¯¢

### 1.2 pgvectoræ‰©å±•

**pgvectoræ˜¯PostgreSQLçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢æ‰©å±•**ï¼Œæä¾›ï¼š

- âœ… **vectorç±»å‹**ï¼šå­˜å‚¨é«˜ç»´å‘é‡
- âœ… **ç›¸ä¼¼åº¦æ“ä½œç¬¦**ï¼šL2è·ç¦»ã€å†…ç§¯ã€ä½™å¼¦ç›¸ä¼¼åº¦
- âœ… **é«˜æ•ˆç´¢å¼•**ï¼šHNSWã€IVFFlatç´¢å¼•
- âœ… **æ··åˆæŸ¥è¯¢**ï¼šå‘é‡+ç»“æ„åŒ–+å…¨æ–‡æœç´¢

**pgvectorç‰ˆæœ¬**ï¼š

- **pgvector 0.5+**ï¼šæ”¯æŒHNSWå’ŒIVFFlatç´¢å¼•
- **pgvector 2.0+**ï¼šSIMDä¼˜åŒ–ï¼Œæ€§èƒ½æå‡35-45%ï¼ˆPostgreSQL 18+ï¼‰

### 1.3 åº”ç”¨åœºæ™¯

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

- **è¯­ä¹‰æœç´¢**ï¼šåŸºäºæ–‡æœ¬è¯­ä¹‰çš„æœç´¢
- **æ¨èç³»ç»Ÿ**ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„æ¨è
- **RAGç³»ç»Ÿ**ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆ
- **å›¾åƒæœç´¢**ï¼šåŸºäºå›¾åƒç‰¹å¾çš„æœç´¢
- **å¼‚å¸¸æ£€æµ‹**ï¼šåŸºäºå‘é‡è·ç¦»çš„å¼‚å¸¸æ£€æµ‹

### 1.4 ç‰ˆæœ¬è¦æ±‚

- **PostgreSQL 18.x**ï¼šæ¨èï¼Œæ”¯æŒå¼‚æ­¥I/Oã€pgvector 2.0
- **PostgreSQL 17.x**ï¼šæ¨èï¼ŒåŠŸèƒ½å®Œæ•´
- **PostgreSQL 16.x**ï¼šå…¼å®¹ï¼ŒåŸºç¡€åŠŸèƒ½æ”¯æŒ
- **pgvector 0.5+**ï¼šåŸºç¡€åŠŸèƒ½
- **pgvector 2.0+**ï¼šæ¨èï¼Œæ€§èƒ½ä¼˜åŒ–

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µ

### 2.1 å‘é‡ç±»å‹

**vectorç±»å‹å®šä¹‰**ï¼š

```sql
-- åˆ›å»ºå‘é‡ç±»å‹åˆ—
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(384)  -- 384ç»´å‘é‡
);

-- å¸¸ç”¨å‘é‡ç»´åº¦
-- 384: all-MiniLM-L6-v2
-- 768: BERT-base
-- 1536: OpenAI text-embedding-3-large
-- 3072: OpenAI text-embedding-3-large (æœ€å¤§ç»´åº¦)
```

**å‘é‡æ’å…¥**ï¼š

```sql
-- æ’å…¥å‘é‡æ•°æ®
INSERT INTO documents (content, embedding)
VALUES (
    'PostgreSQL is a powerful database',
    '[0.1, 0.2, 0.3, ...]'::vector(384)
);

-- ä»æ•°ç»„è½¬æ¢
INSERT INTO documents (content, embedding)
VALUES (
    'Another document',
    ARRAY[0.1, 0.2, 0.3, ...]::vector(384)
);
```

### 2.2 è·ç¦»åº¦é‡

**ä¸‰ç§è·ç¦»åº¦é‡**ï¼š

1. **L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰**ï¼š`<->` æ“ä½œç¬¦
2. **å†…ç§¯ï¼ˆInner Productï¼‰**ï¼š`<#>` æ“ä½œç¬¦
3. **ä½™å¼¦è·ç¦»ï¼ˆCosine Distanceï¼‰**ï¼š`<=>` æ“ä½œç¬¦

**è·ç¦»è®¡ç®—ç¤ºä¾‹**ï¼š

```sql
-- L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰
SELECT embedding <-> '[0.1, 0.2, ...]'::vector(384) AS l2_distance
FROM documents;

-- å†…ç§¯
SELECT embedding <#> '[0.1, 0.2, ...]'::vector(384) AS inner_product
FROM documents;

-- ä½™å¼¦è·ç¦»
SELECT embedding <=> '[0.1, 0.2, ...]'::vector(384) AS cosine_distance
FROM documents;
```

**è·ç¦»åº¦é‡é€‰æ‹©**ï¼š

| è·ç¦»åº¦é‡ | æ“ä½œç¬¦ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------|--------|---------|------|
| **L2è·ç¦»** | `<->` | ä¸€èˆ¬å‘é‡ç›¸ä¼¼åº¦ | è€ƒè™‘å‘é‡å¤§å°å’Œæ–¹å‘ |
| **å†…ç§¯** | `<#>` | å½’ä¸€åŒ–å‘é‡ | åªè€ƒè™‘æ–¹å‘ï¼Œä¸è€ƒè™‘å¤§å° |
| **ä½™å¼¦è·ç¦»** | `<=>` | æ–‡æœ¬åµŒå…¥ | å½’ä¸€åŒ–åçš„å†…ç§¯ |

### 2.3 ç›¸ä¼¼åº¦è®¡ç®—

**ç›¸ä¼¼åº¦ä¸è·ç¦»çš„å…³ç³»**ï¼š

```sql
-- ä½™å¼¦ç›¸ä¼¼åº¦ = 1 - ä½™å¼¦è·ç¦»
SELECT
    1 - (embedding <=> query_vector) AS cosine_similarity
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- L2ç›¸ä¼¼åº¦ï¼ˆè·ç¦»è¶Šå°ï¼Œç›¸ä¼¼åº¦è¶Šé«˜ï¼‰
SELECT
    1 / (1 + (embedding <-> query_vector)) AS l2_similarity
FROM documents
ORDER BY embedding <-> query_vector
LIMIT 10;
```

### 2.4 æ€ç»´å¯¼å›¾

```mermaid
graph TD
    A[pgvectorå‘é‡æ•°æ®åº“] --> B[å‘é‡ç±»å‹]
    A --> C[è·ç¦»åº¦é‡]
    A --> D[ç´¢å¼•ç®—æ³•]
    A --> E[æŸ¥è¯¢æ–¹å¼]

    B --> B1[vectorç±»å‹]
    B --> B2[ç»´åº¦é€‰æ‹©]
    B --> B3[å‘é‡å­˜å‚¨]

    C --> C1[L2è·ç¦»]
    C --> C2[å†…ç§¯]
    C --> C3[ä½™å¼¦è·ç¦»]

    D --> D1[HNSWç´¢å¼•]
    D --> D2[IVFFlatç´¢å¼•]
    D --> D3[ç´¢å¼•é€‰æ‹©]

    E --> E1[å‘é‡æŸ¥è¯¢]
    E --> E2[æ··åˆæŸ¥è¯¢]
    E --> E3[æ‰¹é‡æŸ¥è¯¢]
```

---

## ä¸‰ã€å®‰è£…ä¸é…ç½®

### 3.1 å®‰è£…pgvectoræ‰©å±•

**ä»æºç å®‰è£…**ï¼š

```bash
# å…‹éš†pgvectorä»“åº“
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector

# ç¼–è¯‘å®‰è£…
make
sudo make install

# åœ¨PostgreSQLä¸­åˆ›å»ºæ‰©å±•
psql -d mydb -c "CREATE EXTENSION IF NOT EXISTS vector;"
```

**ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…**ï¼š

```bash
# Ubuntu/Debian
sudo apt-get install postgresql-18-pgvector

# CentOS/RHEL
sudo yum install postgresql18-pgvector

# åœ¨PostgreSQLä¸­åˆ›å»ºæ‰©å±•
psql -d mydb -c "CREATE EXTENSION IF NOT EXISTS vector;"
```

**Dockerå®‰è£…**ï¼š

```bash
# ä½¿ç”¨åŒ…å«pgvectorçš„PostgreSQLé•œåƒ
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=mydb \
  pgvector/pgvector:pg18

# æˆ–ä½¿ç”¨å®˜æ–¹é•œåƒåå®‰è£…
docker exec -it postgres psql -U postgres -d mydb -c "CREATE EXTENSION IF NOT EXISTS vector;"
```

**éªŒè¯å®‰è£…**ï¼š

```sql
-- æŸ¥çœ‹æ‰©å±•ç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';

-- æŸ¥çœ‹å‘é‡ç±»å‹
SELECT typname, typlen FROM pg_type WHERE typname = 'vector';

-- æµ‹è¯•å‘é‡æ“ä½œ
SELECT '[1,2,3]'::vector(3) <-> '[4,5,6]'::vector(3) AS distance;
```

### 3.2 åŸºç¡€é…ç½®

**PostgreSQLé…ç½®ä¼˜åŒ–**ï¼š

```conf
# postgresql.conf
# å†…å­˜é…ç½®ï¼ˆå‘é‡ç´¢å¼•éœ€è¦æ›´å¤šå†…å­˜ï¼‰
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 64MB
maintenance_work_mem = 2GB

# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18+ï¼‰
max_parallel_workers_per_gather = 4
max_parallel_workers = 8

# I/Oé…ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
io_uring = on
max_io_concurrency = 10
```

### 3.3 PostgreSQL 18ä¼˜åŒ–é…ç½®

**å¯ç”¨å¼‚æ­¥I/O**ï¼š

```sql
-- PostgreSQL 18: å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_uring = on;
ALTER SYSTEM SET max_io_concurrency = 10;
SELECT pg_reload_conf();

-- éªŒè¯å¼‚æ­¥I/O
SHOW io_uring;
SHOW max_io_concurrency;
```

**pgvector 2.0é…ç½®**ï¼š

```sql
-- pgvector 2.0: å¯ç”¨SIMDä¼˜åŒ–ï¼ˆè‡ªåŠ¨ï¼‰
-- æ— éœ€é¢å¤–é…ç½®ï¼Œè‡ªåŠ¨ä½¿ç”¨SIMDæŒ‡ä»¤åŠ é€Ÿ

-- æŸ¥çœ‹pgvectorç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';
```

---

## å››ã€ç´¢å¼•ä¸ç®—æ³•

### 4.1 HNSWç´¢å¼•

**HNSWï¼ˆHierarchical Navigable Small Worldï¼‰ç´¢å¼•**ï¼š

- **ç‰¹ç‚¹**ï¼šé«˜å¬å›ç‡ã€æŸ¥è¯¢é€Ÿåº¦å¿«ã€å†…å­˜å ç”¨å¤§
- **é€‚ç”¨åœºæ™¯**ï¼šé«˜å¬å›ç‡è¦æ±‚ã€å®æ—¶æ›´æ–°ã€ä¸­å°è§„æ¨¡æ•°æ®
- **å‚æ•°**ï¼š
  - `m`ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼ˆ4-64ï¼Œé»˜è®¤16ï¼‰
  - `ef_construction`ï¼šæ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼ˆ10-1000ï¼Œé»˜è®¤64ï¼‰
  - `ef_search`ï¼šæŸ¥è¯¢æ—¶çš„æœç´¢èŒƒå›´ï¼ˆé»˜è®¤40ï¼‰

**åˆ›å»ºHNSWç´¢å¼•**ï¼š

```sql
-- åŸºç¡€HNSWç´¢å¼•
CREATE INDEX idx_docs_embed_hnsw ON documents
USING hnsw (embedding vector_cosine_ops);

-- è‡ªå®šä¹‰å‚æ•°HNSWç´¢å¼•
CREATE INDEX idx_docs_embed_hnsw_custom ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 32,              -- æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼ˆè¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†ç´¢å¼•è¶Šå¤§ï¼‰
    ef_construction = 200  -- æ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼ˆè¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æ„å»ºè¶Šæ…¢ï¼‰
);

-- æŸ¥è¯¢æ—¶è®¾ç½®ef_search
SET hnsw.ef_search = 100;  -- æŸ¥è¯¢æ—¶çš„æœç´¢èŒƒå›´ï¼ˆè¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æŸ¥è¯¢è¶Šæ…¢ï¼‰

SELECT id, content, embedding <=> query_vector AS distance
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;
```

**HNSWç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- é«˜å¬å›ç‡é…ç½®ï¼ˆå†…å­˜å……è¶³ï¼‰
CREATE INDEX idx_docs_hnsw_high_recall ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);

SET hnsw.ef_search = 200;  -- æŸ¥è¯¢æ—¶é«˜å¬å›

-- å¿«é€ŸæŸ¥è¯¢é…ç½®ï¼ˆå†…å­˜æœ‰é™ï¼‰
CREATE INDEX idx_docs_hnsw_fast ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

SET hnsw.ef_search = 40;  -- æŸ¥è¯¢æ—¶å¿«é€Ÿ
```

### 4.2 IVFFlatç´¢å¼•

**IVFFlatï¼ˆInverted File with Flat Compressionï¼‰ç´¢å¼•**ï¼š

- **ç‰¹ç‚¹**ï¼šå†…å­˜å ç”¨å°ã€é€‚åˆå¤§è§„æ¨¡æ•°æ®ã€éœ€è¦è®­ç»ƒ
- **é€‚ç”¨åœºæ™¯**ï¼šå¤§è§„æ¨¡æ•°æ®ã€æ‰¹é‡æŸ¥è¯¢ã€å†…å­˜æœ‰é™
- **å‚æ•°**ï¼š
  - `lists`ï¼šèšç±»ä¸­å¿ƒæ•°ï¼ˆå»ºè®®ï¼šrows/1000 åˆ° rows/10000ï¼‰
  - `probes`ï¼šæŸ¥è¯¢æ—¶æœç´¢çš„èšç±»æ•°ï¼ˆ1åˆ°listsï¼Œé»˜è®¤1ï¼‰

**åˆ›å»ºIVFFlatç´¢å¼•**ï¼š

```sql
-- å…ˆæ’å…¥æ•°æ®å¹¶åˆ†æ
INSERT INTO documents (content, embedding) VALUES ...;
ANALYZE documents;

-- åˆ›å»ºIVFFlatç´¢å¼•
CREATE INDEX idx_docs_embed_ivfflat ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);  -- èšç±»ä¸­å¿ƒæ•°

-- æŸ¥è¯¢æ—¶è®¾ç½®probes
SET ivfflat.probes = 10;  -- æœç´¢çš„èšç±»æ•°ï¼ˆè¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æŸ¥è¯¢è¶Šæ…¢ï¼‰

SELECT id, content, embedding <=> query_vector AS distance
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;
```

**IVFFlatç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- è®¡ç®—åˆé€‚çš„listså€¼
SELECT
    COUNT(*) AS total_rows,
    CASE
        WHEN COUNT(*) < 1000 THEN 10
        WHEN COUNT(*) < 10000 THEN COUNT(*) / 100
        ELSE COUNT(*) / 1000
    END AS recommended_lists
FROM documents;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_docs_ivfflat ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- æŸ¥è¯¢æ—¶è°ƒæ•´probes
SET ivfflat.probes = 10;  -- é»˜è®¤1ï¼Œå¢åŠ åˆ°10æå‡å¬å›ç‡
```

### 4.3 ç´¢å¼•é€‰æ‹©ç­–ç•¥

**ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
graph TD
    A[é€‰æ‹©ç´¢å¼•ç±»å‹] --> B{æ•°æ®è§„æ¨¡}
    B -->|å°äº100ä¸‡| C[HNSW]
    B -->|å¤§äº100ä¸‡| D{å†…å­˜å……è¶³?}
    D -->|æ˜¯| C
    D -->|å¦| E[IVFFlat]

    C --> F{æ›´æ–°é¢‘ç‡}
    F -->|å®æ—¶æ›´æ–°| C
    F -->|æ‰¹é‡æ›´æ–°| E

    E --> G{æŸ¥è¯¢æ¨¡å¼}
    G -->|å•æ¡æŸ¥è¯¢| E
    G -->|æ‰¹é‡æŸ¥è¯¢| E
```

**ç´¢å¼•å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§ | HNSW | IVFFlat |
|------|------|---------|
| **å¬å›ç‡** | â­â­â­â­â­ | â­â­â­ |
| **æŸ¥è¯¢é€Ÿåº¦** | â­â­â­â­â­ | â­â­â­ |
| **å†…å­˜å ç”¨** | â­â­ | â­â­â­â­â­ |
| **æ„å»ºé€Ÿåº¦** | â­â­â­ | â­â­â­â­ |
| **æ›´æ–°æ”¯æŒ** | â­â­â­â­â­ | â­â­ |
| **é€‚ç”¨è§„æ¨¡** | ä¸­å°è§„æ¨¡ | å¤§è§„æ¨¡ |

---

## äº”ã€æŸ¥è¯¢ä¸æ£€ç´¢

### 5.1 åŸºç¡€å‘é‡æŸ¥è¯¢

**æœ€è¿‘é‚»æŸ¥è¯¢**ï¼š

```sql
-- åŸºç¡€æœ€è¿‘é‚»æŸ¥è¯¢
SELECT
    id,
    content,
    embedding <=> query_vector AS distance,
    1 - (embedding <=> query_vector) AS similarity
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- å¸¦è·ç¦»é˜ˆå€¼è¿‡æ»¤
SELECT
    id,
    content,
    embedding <=> query_vector AS distance
FROM documents
WHERE embedding <=> query_vector < 0.5  -- è·ç¦»é˜ˆå€¼
ORDER BY embedding <=> query_vector
LIMIT 10;
```

**Top-KæŸ¥è¯¢**ï¼š

```sql
-- Top-Kæœ€è¿‘é‚»æŸ¥è¯¢
CREATE OR REPLACE FUNCTION find_similar_documents(
    p_query_vector vector(384),
    p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
    id BIGINT,
    content TEXT,
    distance NUMERIC,
    similarity NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.id,
        d.content,
        d.embedding <=> p_query_vector AS distance,
        1 - (d.embedding <=> p_query_vector) AS similarity
    FROM documents d
    ORDER BY d.embedding <=> p_query_vector
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 æ··åˆæ£€ç´¢

**å‘é‡ + ç»“æ„åŒ–è¿‡æ»¤**ï¼š

```sql
-- å…ˆè¿‡æ»¤å†å‘é‡æ£€ç´¢
SELECT
    id,
    content,
    embedding <=> query_vector AS distance
FROM documents
WHERE created_at >= NOW() - INTERVAL '7 days'
  AND category = 'technology'
ORDER BY embedding <=> query_vector
LIMIT 20;

-- å…ˆå‘é‡æ£€ç´¢å†è¿‡æ»¤
WITH vector_results AS (
    SELECT id, content, embedding <=> query_vector AS distance
    FROM documents
    ORDER BY embedding <=> query_vector
    LIMIT 100
)
SELECT *
FROM vector_results
WHERE created_at >= NOW() - INTERVAL '7 days'
ORDER BY distance
LIMIT 20;
```

**å‘é‡ + å…¨æ–‡æœç´¢**ï¼š

```sql
-- å…¨æ–‡æœç´¢ + å‘é‡æ£€ç´¢èåˆ
WITH fulltext_results AS (
    SELECT
        id,
        content,
        ts_rank(to_tsvector('simple', content), plainto_tsquery('simple', $1)) AS text_rank
    FROM documents
    WHERE to_tsvector('simple', content) @@ plainto_tsquery('simple', $1)
    ORDER BY text_rank DESC
    LIMIT 500
),
vector_results AS (
    SELECT
        id,
        embedding <=> $2::vector(384) AS vector_distance
    FROM documents
    WHERE id IN (SELECT id FROM fulltext_results)
    ORDER BY embedding <=> $2::vector(384)
    LIMIT 100
)
SELECT
    d.id,
    d.content,
    f.text_rank,
    1 - v.vector_distance AS vector_similarity,
    -- åŠ æƒèåˆåˆ†æ•°
    0.4 * f.text_rank + 0.6 * (1 - v.vector_distance) AS final_score
FROM documents d
JOIN fulltext_results f ON f.id = d.id
JOIN vector_results v ON v.id = d.id
ORDER BY final_score DESC
LIMIT 20;
```

**RRFï¼ˆReciprocal Rank Fusionï¼‰èåˆ**ï¼š

```sql
-- RRFèåˆç®—æ³•
WITH fulltext_ranked AS (
    SELECT
        id,
        content,
        ROW_NUMBER() OVER (ORDER BY ts_rank(to_tsvector('simple', content), plainto_tsquery('simple', $1)) DESC) AS rank
    FROM documents
    WHERE to_tsvector('simple', content) @@ plainto_tsquery('simple', $1)
    LIMIT 500
),
vector_ranked AS (
    SELECT
        id,
        content,
        ROW_NUMBER() OVER (ORDER BY embedding <=> $2::vector(384)) AS rank
    FROM documents
    ORDER BY embedding <=> $2::vector(384)
    LIMIT 500
)
SELECT
    COALESCE(f.id, v.id) AS id,
    COALESCE(f.content, v.content) AS content,
    -- RRFåˆ†æ•°ï¼š1/(60 + rank)
    COALESCE(1.0 / (60 + f.rank), 0) + COALESCE(1.0 / (60 + v.rank), 0) AS rrf_score
FROM fulltext_ranked f
FULL OUTER JOIN vector_ranked v ON v.id = f.id
ORDER BY rrf_score DESC
LIMIT 20;
```

### 5.3 æ‰¹é‡æŸ¥è¯¢

**æ‰¹é‡å‘é‡æŸ¥è¯¢**ï¼š

```sql
-- æ‰¹é‡æŸ¥è¯¢å¤šä¸ªå‘é‡
CREATE OR REPLACE FUNCTION batch_vector_search(
    p_query_vectors vector(384)[],
    p_limit_per_query INTEGER DEFAULT 10
)
RETURNS TABLE (
    query_idx INTEGER,
    id BIGINT,
    content TEXT,
    distance NUMERIC
) AS $$
DECLARE
    v_vector vector(384);
    v_idx INTEGER := 0;
BEGIN
    FOREACH v_vector IN ARRAY p_query_vectors
    LOOP
        RETURN QUERY
        SELECT
            v_idx,
            d.id,
            d.content,
            d.embedding <=> v_vector AS distance
        FROM documents d
        ORDER BY d.embedding <=> v_vector
        LIMIT p_limit_per_query;

        v_idx := v_idx + 1;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM batch_vector_search(
    ARRAY[
        '[0.1, 0.2, ...]'::vector(384),
        '[0.3, 0.4, ...]'::vector(384)
    ],
    10
);
```

---

## å…­ã€PostgreSQL 18ä¼˜åŒ–

### 6.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¯ç”¨å¼‚æ­¥I/O**ï¼š

```sql
-- PostgreSQL 18: å¯ç”¨å¼‚æ­¥I/O
ALTER SYSTEM SET io_uring = on;
ALTER SYSTEM SET max_io_concurrency = 10;
SELECT pg_reload_conf();

-- å‘é‡æ£€ç´¢è‡ªåŠ¨åˆ©ç”¨å¼‚æ­¥I/O
SELECT id, content
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 100;
-- è‡ªåŠ¨ä½¿ç”¨å¼‚æ­¥I/Oï¼Œæ€§èƒ½æå‡2-3å€
```

### 6.2 pgvector 2.0æ–°ç‰¹æ€§

**SIMDä¼˜åŒ–**ï¼š

```sql
-- pgvector 2.0: è‡ªåŠ¨ä½¿ç”¨SIMDä¼˜åŒ–
-- æ— éœ€é¢å¤–é…ç½®ï¼Œè‡ªåŠ¨åŠ é€Ÿå‘é‡æ“ä½œ

-- æ€§èƒ½æå‡ï¼š
-- - å‘é‡è·ç¦»è®¡ç®—ï¼šæå‡35-45%
-- - ç´¢å¼•æ„å»ºï¼šæå‡20-30%
-- - æ‰¹é‡æŸ¥è¯¢ï¼šæå‡40-50%
```

**ç¨€ç–å‘é‡æ”¯æŒï¼ˆpgvector 2.0+ï¼‰**ï¼š

```sql
-- pgvector 2.0: æ”¯æŒç¨€ç–å‘é‡ï¼ˆsparsevecç±»å‹ï¼‰
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºç¨€ç–å‘é‡åˆ—
CREATE TABLE sparse_documents (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    sparse_embedding sparsevec(10000)  -- 10000ç»´ç¨€ç–å‘é‡
);

-- åˆ›å»ºç¨€ç–å‘é‡ç´¢å¼•
CREATE INDEX idx_sparse_embed ON sparse_documents
USING hnsw (sparse_embedding sparsevec_l2_ops)
WITH (m = 16, ef_construction = 64);
```

### 6.3 æ€§èƒ½æå‡

**PostgreSQL 18 + pgvector 2.0æ€§èƒ½æå‡**ï¼š

| æ“ä½œ | æ€§èƒ½æå‡ | è¯´æ˜ |
|------|---------|------|
| **å‘é‡è·ç¦»è®¡ç®—** | +35-45% | SIMDä¼˜åŒ– |
| **ç´¢å¼•æ„å»º** | +20-30% | SIMD + å¼‚æ­¥I/O |
| **å‘é‡æ£€ç´¢** | +2-3å€ | å¼‚æ­¥I/Oä¼˜åŒ– |
| **æ‰¹é‡æŸ¥è¯¢** | +40-50% | SIMD + å¹¶è¡ŒæŸ¥è¯¢ |

---

## ä¸ƒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 7.1 ç´¢å¼•ç®—æ³•å¯¹æ¯”

| ç´¢å¼•ç±»å‹ | å¬å›ç‡ | æŸ¥è¯¢é€Ÿåº¦ | å†…å­˜å ç”¨ | æ„å»ºé€Ÿåº¦ | æ›´æ–°æ”¯æŒ | é€‚ç”¨è§„æ¨¡ | æ¨èåº¦ |
|---------|--------|---------|---------|---------|---------|---------|--------|
| **HNSW** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­ | â­â­â­â­â­ | ä¸­å°è§„æ¨¡ | â­â­â­â­â­ |
| **IVFFlat** | â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | å¤§è§„æ¨¡ | â­â­â­â­ |
| **æ— ç´¢å¼•** | â­â­â­â­â­ | â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | å°è§„æ¨¡ | â­â­ |

### 7.2 è·ç¦»åº¦é‡å¯¹æ¯”

| è·ç¦»åº¦é‡ | è®¡ç®—é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ | å½’ä¸€åŒ–è¦æ±‚ | æ¨èåº¦ |
|---------|---------|---------|-----------|--------|
| **L2è·ç¦»** | â­â­â­â­ | ä¸€èˆ¬å‘é‡ | å¯é€‰ | â­â­â­â­ |
| **å†…ç§¯** | â­â­â­â­â­ | å½’ä¸€åŒ–å‘é‡ | å¿…éœ€ | â­â­â­ |
| **ä½™å¼¦è·ç¦»** | â­â­â­â­ | æ–‡æœ¬åµŒå…¥ | è‡ªåŠ¨å½’ä¸€åŒ– | â­â­â­â­â­ |

### 7.3 åº”ç”¨åœºæ™¯å¯¹æ¯”

| åº”ç”¨åœºæ™¯ | æ¨èç´¢å¼• | æ¨èè·ç¦» | å‘é‡ç»´åº¦ | æ¨èåº¦ |
|---------|---------|---------|---------|--------|
| **è¯­ä¹‰æœç´¢** | HNSW | ä½™å¼¦è·ç¦» | 384-1536 | â­â­â­â­â­ |
| **æ¨èç³»ç»Ÿ** | HNSW/IVFFlat | ä½™å¼¦è·ç¦» | 128-768 | â­â­â­â­â­ |
| **å›¾åƒæœç´¢** | HNSW | L2è·ç¦» | 512-2048 | â­â­â­â­ |
| **å¼‚å¸¸æ£€æµ‹** | IVFFlat | L2è·ç¦» | 64-256 | â­â­â­â­ |

---

## å…«ã€å®è·µæ¡ˆä¾‹

### 8.1 è¯­ä¹‰æœç´¢ç³»ç»Ÿ

**å®Œæ•´å®ç°**ï¼š

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE search_documents (
    id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    embedding vector(384),
    category TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    -- å…¨æ–‡æœç´¢å‘é‡
    search_vector tsvector GENERATED ALWAYS AS (
        to_tsvector('simple', title || ' ' || content)
    ) STORED
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_search_embed_hnsw ON search_documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_search_vector_gin ON search_documents
USING GIN (search_vector);

-- è¯­ä¹‰æœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION semantic_search(
    p_query_text TEXT,
    p_query_vector vector(384),
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    id BIGINT,
    title TEXT,
    content TEXT,
    score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH fulltext_results AS (
        SELECT
            id,
            ts_rank(search_vector, plainto_tsquery('simple', p_query_text)) AS text_score
        FROM search_documents
        WHERE search_vector @@ plainto_tsquery('simple', p_query_text)
        LIMIT 500
    ),
    vector_results AS (
        SELECT
            id,
            1 - (embedding <=> p_query_vector) AS vector_score
        FROM search_documents
        WHERE id IN (SELECT id FROM fulltext_results)
        ORDER BY embedding <=> p_query_vector
        LIMIT 100
    )
    SELECT
        d.id,
        d.title,
        d.content,
        0.4 * f.text_score + 0.6 * v.vector_score AS final_score
    FROM search_documents d
    JOIN fulltext_results f ON f.id = d.id
    JOIN vector_results v ON v.id = d.id
    ORDER BY final_score DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 RAGçŸ¥è¯†åº“

**RAGç³»ç»Ÿå®ç°**ï¼š

```sql
-- çŸ¥è¯†åº“æ–‡æ¡£è¡¨
CREATE TABLE knowledge_base (
    id BIGSERIAL PRIMARY KEY,
    chunk_text TEXT NOT NULL,
    chunk_index INTEGER,
    parent_doc_id BIGINT,
    embedding vector(1536),  -- OpenAI text-embedding-3-large
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºHNSWç´¢å¼•
CREATE INDEX idx_kb_embed_hnsw ON knowledge_base
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- RAGæ£€ç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION rag_retrieve(
    p_query_vector vector(1536),
    p_top_k INTEGER DEFAULT 5,
    p_score_threshold NUMERIC DEFAULT 0.7
)
RETURNS TABLE (
    id BIGINT,
    chunk_text TEXT,
    metadata JSONB,
    similarity NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        kb.id,
        kb.chunk_text,
        kb.metadata,
        1 - (kb.embedding <=> p_query_vector) AS similarity
    FROM knowledge_base kb
    WHERE 1 - (kb.embedding <=> p_query_vector) >= p_score_threshold
    ORDER BY kb.embedding <=> p_query_vector
    LIMIT p_top_k;
END;
$$ LANGUAGE plpgsql;
```

### 8.3 æ¨èç³»ç»Ÿ

**æ¨èç³»ç»Ÿå®ç°**ï¼š

```sql
-- ç‰©å“ç‰¹å¾è¡¨
CREATE TABLE items (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT,
    embedding vector(768),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç”¨æˆ·ç‰¹å¾è¡¨
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    embedding vector(768),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_items_embed_hnsw ON items
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_users_embed_hnsw ON users
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- æ¨èå‡½æ•°
CREATE OR REPLACE FUNCTION recommend_items(
    p_user_id BIGINT,
    p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
    item_id BIGINT,
    item_name TEXT,
    similarity NUMERIC
) AS $$
DECLARE
    v_user_embedding vector(768);
BEGIN
    -- è·å–ç”¨æˆ·å‘é‡
    SELECT embedding INTO v_user_embedding
    FROM users
    WHERE id = p_user_id;

    IF v_user_embedding IS NULL THEN
        RETURN;
    END IF;

    -- æ¨èç›¸ä¼¼ç‰©å“
    RETURN QUERY
    SELECT
        i.id,
        i.name,
        1 - (i.embedding <=> v_user_embedding) AS similarity
    FROM items i
    WHERE i.embedding IS NOT NULL
    ORDER BY i.embedding <=> v_user_embedding
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### 9.1 ç´¢å¼•ä¼˜åŒ–

**HNSWç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- é«˜å¬å›ç‡é…ç½®
CREATE INDEX idx_docs_hnsw_high_recall ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);

SET hnsw.ef_search = 200;  -- æŸ¥è¯¢æ—¶é«˜å¬å›

-- å¿«é€ŸæŸ¥è¯¢é…ç½®
CREATE INDEX idx_docs_hnsw_fast ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

SET hnsw.ef_search = 40;  -- æŸ¥è¯¢æ—¶å¿«é€Ÿ
```

**IVFFlatç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- è®¡ç®—åˆé€‚çš„listså€¼
SELECT
    COUNT(*) AS total_rows,
    CASE
        WHEN COUNT(*) < 1000 THEN 10
        WHEN COUNT(*) < 10000 THEN COUNT(*) / 100
        ELSE COUNT(*) / 1000
    END AS recommended_lists
FROM documents;

-- åˆ›å»ºä¼˜åŒ–çš„IVFFlatç´¢å¼•
CREATE INDEX idx_docs_ivfflat_optimized ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- æŸ¥è¯¢æ—¶è°ƒæ•´probes
SET ivfflat.probes = 10;  -- æå‡å¬å›ç‡
```

### 9.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆå¦‚æœå¯èƒ½ï¼‰
CREATE INDEX idx_docs_cover ON documents (id, content)
INCLUDE (embedding);

-- é™åˆ¶æŸ¥è¯¢èŒƒå›´
SELECT id, content
FROM documents
WHERE category = 'technology'  -- å…ˆè¿‡æ»¤
ORDER BY embedding <=> query_vector
LIMIT 20;

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨æŸ¥è¯¢
CREATE MATERIALIZED VIEW mv_popular_vectors AS
SELECT
    id,
    content,
    embedding
FROM documents
WHERE created_at >= NOW() - INTERVAL '30 days'
ORDER BY view_count DESC
LIMIT 10000;

CREATE INDEX idx_mv_popular_vectors_hnsw ON mv_popular_vectors
USING hnsw (embedding vector_cosine_ops);
```

### 9.3 å­˜å‚¨ä¼˜åŒ–

**å‘é‡å­˜å‚¨ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨TOASTå­˜å‚¨å¤§å‘é‡
ALTER TABLE documents ALTER COLUMN embedding SET STORAGE EXTENDED;

-- åˆ†ç¦»çƒ­æ•°æ®å’Œå†·æ•°æ®
CREATE TABLE documents_hot (
    LIKE documents INCLUDING ALL
);
CREATE TABLE documents_cold (
    LIKE documents INCLUDING ALL
);

-- çƒ­æ•°æ®ä½¿ç”¨HNSWï¼Œå†·æ•°æ®ä½¿ç”¨IVFFlat
CREATE INDEX idx_docs_hot_hnsw ON documents_hot
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_docs_cold_ivfflat ON documents_cold
USING ivfflat (embedding vector_cosine_ops);
```

---

## åã€ç›‘æ§ä¸è¯Šæ–­

### 10.1 æ€§èƒ½ç›‘æ§

**æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- å¯ç”¨pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹å‘é‡æŸ¥è¯¢æ€§èƒ½
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%' OR query LIKE '%<#%'
ORDER BY mean_exec_time DESC
LIMIT 20;
```

**ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡**ï¼š

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE indexname LIKE '%hnsw%' OR indexname LIKE '%ivfflat%'
ORDER BY idx_scan DESC;
```

### 10.2 ç´¢å¼•è¯Šæ–­

**ç´¢å¼•å¤§å°å’ŒçŠ¶æ€**ï¼š

```sql
-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE indexname LIKE '%hnsw%' OR indexname LIKE '%ivfflat%'
ORDER BY pg_relation_size(indexrelid) DESC;

-- æŸ¥çœ‹ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    pg_size_pretty(pg_relation_size(indexrelid) - pg_relation_size(indexrelid, 'vm')) AS bloat_size
FROM pg_stat_user_indexes
WHERE indexname LIKE '%hnsw%' OR indexname LIKE '%ivfflat%';
```

### 10.3 é—®é¢˜æ’æŸ¥

**å¸¸è§é—®é¢˜è¯Šæ–­**ï¼š

```sql
-- æ£€æŸ¥å‘é‡ç»´åº¦ä¸€è‡´æ€§
SELECT
    id,
    array_length(embedding::text::float[], 1) AS dimension
FROM documents
WHERE array_length(embedding::text::float[], 1) != 384;

-- æ£€æŸ¥NULLå‘é‡
SELECT COUNT(*) FROM documents WHERE embedding IS NULL;

-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, content
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;
```

---

## åä¸€ã€æœ€ä½³å®è·µ

### 11.1 è®¾è®¡æœ€ä½³å®è·µ

1. **å‘é‡ç»´åº¦é€‰æ‹©**ï¼š
   - æ ¹æ®æ¨¡å‹é€‰æ‹©åˆé€‚ç»´åº¦
   - é¿å…è¿‡å¤§çš„ç»´åº¦ï¼ˆ>2048ï¼‰
   - è€ƒè™‘å­˜å‚¨å’Œæ€§èƒ½å¹³è¡¡

2. **ç´¢å¼•é€‰æ‹©**ï¼š
   - ä¸­å°è§„æ¨¡æ•°æ®ä½¿ç”¨HNSW
   - å¤§è§„æ¨¡æ•°æ®ä½¿ç”¨IVFFlat
   - æ ¹æ®å¬å›ç‡è¦æ±‚è°ƒæ•´å‚æ•°

3. **è·ç¦»åº¦é‡é€‰æ‹©**ï¼š
   - æ–‡æœ¬åµŒå…¥ä½¿ç”¨ä½™å¼¦è·ç¦»
   - ä¸€èˆ¬å‘é‡ä½¿ç”¨L2è·ç¦»
   - å½’ä¸€åŒ–å‘é‡ä½¿ç”¨å†…ç§¯

### 11.2 æ€§èƒ½æœ€ä½³å®è·µ

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - åˆç†è®¾ç½®ç´¢å¼•å‚æ•°
   - å®šæœŸé‡å»ºç´¢å¼•
   - ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ

2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - å…ˆè¿‡æ»¤å†å‘é‡æ£€ç´¢
   - ä½¿ç”¨æ··åˆæ£€ç´¢æå‡æ•ˆæœ
   - é™åˆ¶æŸ¥è¯¢ç»“æœæ•°é‡

3. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - åˆ†ç¦»çƒ­æ•°æ®å’Œå†·æ•°æ®
   - ä½¿ç”¨TOASTå­˜å‚¨å¤§å‘é‡
   - å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

---

## åäºŒã€å‚è€ƒèµ„æº

### 12.1 å®˜æ–¹æ–‡æ¡£

- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [PostgreSQLå‘é‡ç±»å‹](https://www.postgresql.org/docs/current/)
- [PostgreSQLç´¢å¼•ç±»å‹](https://www.postgresql.org/docs/current/indexes-types.html)

### 12.2 ç½‘ç»œèµ„æº

- [pgvectoræ–‡æ¡£](https://github.com/pgvector/pgvector#documentation)
- [å‘é‡æ•°æ®åº“æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/)

### 12.3 ç›¸å…³æ–‡æ¡£

- `07-å‰æ²¿æŠ€æœ¯/05.05-å‘é‡æ£€ç´¢æ€§èƒ½è°ƒä¼˜æŒ‡å—.md` - å®Œæ•´çš„æ€§èƒ½è°ƒä¼˜æ–¹æ³•
- `07-å‰æ²¿æŠ€æœ¯/AI-æ—¶ä»£/01-å‘é‡ä¸æ··åˆæœç´¢-pgvectorä¸RRF.md` - pgvector 2.0 + RRFèåˆ
- `09-åº”ç”¨è®¾è®¡/è¡Œä¸šæ¡ˆä¾‹/å‘é‡æ£€ç´¢ä¸RAG.md` - RAGç³»ç»Ÿå®Œæ•´å®ç°
- `06-è¿ç»´å®è·µ/è¿ç»´æ‰‹å†Œ/04-å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—.md` - ç”Ÿäº§éƒ¨ç½²æŒ‡å—

---

**ç»´æŠ¤è€…**: Data-Science Team
**æœ€åæ›´æ–°**: 2025-01-15
**ç‰ˆæœ¬**: 3.0
