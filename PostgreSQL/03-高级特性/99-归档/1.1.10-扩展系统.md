# 扩展系统

## 1. 定义

**中文**: 扩展系统是PostgreSQL中用于扩展数据库功能的机制，支持自定义数据类型、函数、操作符和存储引擎。

**English**: The extension system in PostgreSQL is a mechanism for extending database functionality, supporting custom data types, functions, operators, and storage engines.

## 2. 形式化定义

```latex
\newcommand{\extension}{\mathcal{E}}
\newcommand{\type}{\mathcal{T}}
\newcommand{\function}{\mathcal{F}}

\extension = \{(name, \type, \function, operator, engine)\}

其中：
name: 扩展名称
\type: 自定义数据类型集合
\function: 自定义函数集合
operator: 自定义操作符集合
engine: 存储引擎
```

## 3. 核心属性

- **可扩展性**: 支持功能扩展
- **模块化**: 独立的功能模块
- **兼容性**: 与核心系统兼容
- **性能**: 接近原生性能

## 4. 理论基础

```latex
\begin{theorem}[扩展系统完备性]
PostgreSQL扩展系统支持：
1. 自定义数据类型和操作符
2. 自定义函数和存储过程
3. 自定义索引和存储引擎
4. 插件化架构设计
\end{theorem}
```

## 5. 算法实现

### 5.1 扩展管理

```sql
-- 查看可用扩展
SELECT * FROM pg_available_extensions;

-- 安装扩展
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS btree_gin;

-- 查看已安装扩展
SELECT extname, extversion FROM pg_extension;

-- 卸载扩展
DROP EXTENSION postgis CASCADE;
```

### 5.2 自定义数据类型

```sql
-- 创建自定义类型
CREATE TYPE currency AS (
    amount DECIMAL(10,2),
    currency_code CHAR(3)
);

-- 创建枚举类型
CREATE TYPE order_status AS ENUM ('pending', 'processing', 'completed', 'cancelled');

-- 使用自定义类型
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    total currency,
    status order_status DEFAULT 'pending'
);

INSERT INTO orders (total) VALUES (ROW(100.50, 'USD'));
```

### 5.3 自定义函数

```sql
-- 创建自定义函数
CREATE OR REPLACE FUNCTION calculate_tax(amount DECIMAL, rate DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
    RETURN amount * rate;
END;
$$ LANGUAGE plpgsql;

-- 创建聚合函数
CREATE OR REPLACE FUNCTION string_agg_concat(text, text)
RETURNS text AS $$
BEGIN
    IF $1 IS NULL THEN
        RETURN $2;
    ELSE
        RETURN $1 || ', ' || $2;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 创建聚合
CREATE AGGREGATE string_concat(text) (
    SFUNC = string_agg_concat,
    STYPE = text,
    INITCOND = ''
);
```

## 6. 应用实例

### 6.1 地理信息扩展

```sql
-- 安装PostGIS扩展
CREATE EXTENSION postgis;

-- 创建地理数据表
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    location GEOMETRY(POINT, 4326)
);

-- 插入地理数据
INSERT INTO locations (name, location) VALUES
('北京', ST_GeomFromText('POINT(116.4074 39.9042)', 4326)),
('上海', ST_GeomFromText('POINT(121.4737 31.2304)', 4326));

-- 地理查询
SELECT name, ST_Distance(location, ST_GeomFromText('POINT(116.4074 39.9042)', 4326)) as distance
FROM locations
ORDER BY distance;
```

### 6.2 全文搜索扩展

```sql
-- 安装全文搜索扩展
CREATE EXTENSION pg_trgm;

-- 创建全文搜索索引
CREATE INDEX idx_emp_name_trgm ON employees USING gin(name gin_trgm_ops);

-- 模糊搜索
SELECT name, similarity(name, 'John') as sim
FROM employees
WHERE name % 'John'
ORDER BY sim DESC;
```

### 6.3 JSON扩展

```sql
-- 使用JSONB类型
CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY,
    profile JSONB
);

-- 插入JSON数据
INSERT INTO user_profiles VALUES (1, '{"name": "John", "age": 30, "skills": ["SQL", "Python"]}');

-- JSON查询
SELECT user_id, profile->>'name' as name, profile->'skills' as skills
FROM user_profiles
WHERE profile @> '{"skills": ["SQL"]}';
```

## 7. 性能分析

- **扩展加载**: O(1) 加载时间
- **函数调用**: 接近原生性能
- **类型转换**: O(1) 到 O(n)
- **内存使用**: 取决于扩展复杂度

## 8. 相关概念

- **上位概念**: 数据库系统、插件架构
- **下位概念**: 自定义类型、函数、操作符
- **平行概念**: 存储过程、触发器

## 9. 参考文献

1. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation.
2. PostGIS Development Team. (2024). PostGIS Documentation.

## 10. Wikidata对齐

- **ID**: Q186929 (database extension)
- **属性**: database concept, plugin system
- **链接**: <https://en.wikipedia.org/wiki/Database_extension>
