# PostgreSQL 18 å¼€å‘å·¥å…·ä¸è°ƒè¯•

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 å¼€å‘å·¥å…·ä¸è°ƒè¯•](#postgresql-18-å¼€å‘å·¥å…·ä¸è°ƒè¯•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 å¼€å‘å·¥å…·å¯¹æ¯”](#21-å¼€å‘å·¥å…·å¯¹æ¯”)
    - [2.2 è°ƒè¯•å·¥å…·å¯¹æ¯”](#22-è°ƒè¯•å·¥å…·å¯¹æ¯”)
  - [ä¸‰ã€å‘½ä»¤è¡Œå·¥å…·](#ä¸‰å‘½ä»¤è¡Œå·¥å…·)
    - [3.1 psqlåŸºç¡€](#31-psqlåŸºç¡€)
      - [3.1.1 psqlå·¥å…·çš„é‡è¦æ€§](#311-psqlå·¥å…·çš„é‡è¦æ€§)
      - [3.1.2 è¿æ¥æ•°æ®åº“](#312-è¿æ¥æ•°æ®åº“)
      - [3.1.3 åŸºæœ¬å‘½ä»¤](#313-åŸºæœ¬å‘½ä»¤)
    - [3.2 psqlé«˜çº§åŠŸèƒ½](#32-psqlé«˜çº§åŠŸèƒ½)
    - [3.3 è„šæœ¬æ‰§è¡Œ](#33-è„šæœ¬æ‰§è¡Œ)
  - [å››ã€GUIå·¥å…·](#å››guiå·¥å…·)
    - [4.1 pgAdmin](#41-pgadmin)
    - [4.2 DBeaver](#42-dbeaver)
    - [4.3 DataGrip](#43-datagrip)
  - [äº”ã€è°ƒè¯•æŠ€æœ¯](#äº”è°ƒè¯•æŠ€æœ¯)
    - [5.1 æŸ¥è¯¢è°ƒè¯•](#51-æŸ¥è¯¢è°ƒè¯•)
    - [5.2 å‡½æ•°è°ƒè¯•](#52-å‡½æ•°è°ƒè¯•)
    - [5.3 æ€§èƒ½è°ƒè¯•](#53-æ€§èƒ½è°ƒè¯•)
  - [å…­ã€æ—¥å¿—åˆ†æ](#å…­æ—¥å¿—åˆ†æ)
    - [6.1 æ—¥å¿—é…ç½®](#61-æ—¥å¿—é…ç½®)
    - [6.2 æ—¥å¿—åˆ†æå·¥å…·](#62-æ—¥å¿—åˆ†æå·¥å…·)
    - [6.3 æ…¢æŸ¥è¯¢æ—¥å¿—](#63-æ…¢æŸ¥è¯¢æ—¥å¿—)
  - [ä¸ƒã€æ€§èƒ½åˆ†æå·¥å…·](#ä¸ƒæ€§èƒ½åˆ†æå·¥å…·)
    - [7.1 EXPLAINåˆ†æ](#71-explainåˆ†æ)
    - [7.2 pg\_stat\_statements](#72-pg_stat_statements)
    - [7.3 auto\_explain](#73-auto_explain)
  - [å…«ã€å¼€å‘ç¯å¢ƒé…ç½®](#å…«å¼€å‘ç¯å¢ƒé…ç½®)
    - [8.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ](#81-æœ¬åœ°å¼€å‘ç¯å¢ƒ)
    - [8.2 Dockerå¼€å‘ç¯å¢ƒ](#82-dockerå¼€å‘ç¯å¢ƒ)
    - [8.3 æµ‹è¯•æ•°æ®ç”Ÿæˆ](#83-æµ‹è¯•æ•°æ®ç”Ÿæˆ)
  - [ä¹ã€æœ€ä½³å®è·µ](#ä¹æœ€ä½³å®è·µ)
    - [9.1 è°ƒè¯•æµç¨‹](#91-è°ƒè¯•æµç¨‹)
    - [9.2 å·¥å…·é€‰æ‹©](#92-å·¥å…·é€‰æ‹©)
    - [9.3 æ•ˆç‡æå‡](#93-æ•ˆç‡æå‡)
  - [åã€ç›¸å…³æ–‡æ¡£](#åç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¼€å‘å·¥å…·ä¸è°ƒè¯•))
    å‘½ä»¤è¡Œå·¥å…·
      psqlåŸºç¡€
        è¿æ¥æ•°æ®åº“
        åŸºæœ¬å‘½ä»¤
        æŸ¥è¯¢æ‰§è¡Œ
      psqlé«˜çº§
        å˜é‡ä½¿ç”¨
        è„šæœ¬ç¼–å†™
        è¾“å‡ºæ ¼å¼åŒ–
      è„šæœ¬æ‰§è¡Œ
        è„šæœ¬æ–‡ä»¶
        æ‰¹é‡æ‰§è¡Œ
        é”™è¯¯å¤„ç†
    GUIå·¥å…·
      pgAdmin
        åŠŸèƒ½ç‰¹ç‚¹
        ä½¿ç”¨æŠ€å·§
        é€‚ç”¨åœºæ™¯
      DBeaver
        åŠŸèƒ½ç‰¹ç‚¹
        ä½¿ç”¨æŠ€å·§
        é€‚ç”¨åœºæ™¯
      DataGrip
        åŠŸèƒ½ç‰¹ç‚¹
        ä½¿ç”¨æŠ€å·§
        é€‚ç”¨åœºæ™¯
    è°ƒè¯•æŠ€æœ¯
      æŸ¥è¯¢è°ƒè¯•
        æŸ¥è¯¢åˆ†æ
        æ‰§è¡Œè®¡åˆ’
        æ€§èƒ½ä¼˜åŒ–
      å‡½æ•°è°ƒè¯•
        å‡½æ•°æµ‹è¯•
        æ–­ç‚¹è°ƒè¯•
        æ—¥å¿—è°ƒè¯•
      æ€§èƒ½è°ƒè¯•
        æ€§èƒ½åˆ†æ
        ç“¶é¢ˆè¯†åˆ«
        ä¼˜åŒ–å»ºè®®
    æ—¥å¿—åˆ†æ
      æ—¥å¿—é…ç½®
        æ—¥å¿—çº§åˆ«
        æ—¥å¿—æ ¼å¼
        æ—¥å¿—è¾“å‡º
      æ—¥å¿—å·¥å…·
        æ—¥å¿—æŸ¥çœ‹
        æ—¥å¿—è¿‡æ»¤
        æ—¥å¿—åˆ†æ
      æ…¢æŸ¥è¯¢æ—¥å¿—
        æ…¢æŸ¥è¯¢é…ç½®
        æ…¢æŸ¥è¯¢åˆ†æ
        æ…¢æŸ¥è¯¢ä¼˜åŒ–
    æ€§èƒ½åˆ†æ
      EXPLAIN
        æ‰§è¡Œè®¡åˆ’
        è®¡åˆ’åˆ†æ
        ä¼˜åŒ–å»ºè®®
      pg_stat_statements
        æŸ¥è¯¢ç»Ÿè®¡
        æ€§èƒ½åˆ†æ
        ä¼˜åŒ–å»ºè®®
      auto_explain
        è‡ªåŠ¨åˆ†æ
        é…ç½®ä½¿ç”¨
        æ€§èƒ½ç›‘æ§
    å¼€å‘ç¯å¢ƒ
      æœ¬åœ°ç¯å¢ƒ
        ç¯å¢ƒæ­å»º
        é…ç½®ä¼˜åŒ–
        æ•°æ®å‡†å¤‡
      Dockerç¯å¢ƒ
        å®¹å™¨é…ç½®
        æ•°æ®æŒä¹…åŒ–
        ç½‘ç»œé…ç½®
      æµ‹è¯•æ•°æ®
        æ•°æ®ç”Ÿæˆ
        æ•°æ®å¯¼å…¥
        æ•°æ®æ¸…ç†
    æœ€ä½³å®è·µ
      è°ƒè¯•æµç¨‹
        é—®é¢˜å®šä½
        é—®é¢˜åˆ†æ
        é—®é¢˜è§£å†³
      å·¥å…·é€‰æ‹©
        å·¥å…·å¯¹æ¯”
        é€‰æ‹©åŸåˆ™
        ä½¿ç”¨å»ºè®®
      æ•ˆç‡æå‡
        å¿«æ·é”®ä½¿ç”¨
        è„šæœ¬è‡ªåŠ¨åŒ–
        å·¥å…·é›†æˆ
```

**æ€ç»´å¯¼å›¾è¯´æ˜**ï¼š

æœ¬æ€ç»´å¯¼å›¾å±•ç¤ºäº†å¼€å‘å·¥å…·ä¸è°ƒè¯•çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»å‘½ä»¤è¡Œå·¥å…·åˆ°GUIå·¥å…·ï¼Œä»è°ƒè¯•æŠ€æœ¯åˆ°æ€§èƒ½åˆ†æï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«ç†è®ºåŸºç¡€ã€ä½¿ç”¨æ–¹æ³•å’Œå®è·µç»éªŒã€‚é€šè¿‡è¿™ä¸ªæ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£PostgreSQLå¼€å‘å·¥å…·ï¼Œå¹¶æ ¹æ®å…·ä½“éœ€æ±‚æ·±å…¥ç›¸å…³ç« èŠ‚ã€‚

**ä½¿ç”¨å»ºè®®**ï¼š

- **å¼€å‘äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨å¼€å‘å·¥å…·çš„ä½¿ç”¨å’Œè°ƒè¯•æŠ€æœ¯ï¼Œç†è§£å¦‚ä½•æé«˜å¼€å‘æ•ˆç‡
- **è¿ç»´äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨æ€§èƒ½åˆ†æå·¥å…·å’Œæ—¥å¿—åˆ†æï¼Œç†è§£å¦‚ä½•æ’æŸ¥é—®é¢˜
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šé‡ç‚¹å…³æ³¨æœ€ä½³å®è·µå’Œå·¥å…·é€‰æ‹©ï¼Œç†è§£å¦‚ä½•å»ºç«‹é«˜æ•ˆçš„å¼€å‘ç¯å¢ƒ

---

## ä¸€ã€æ¦‚è¿°

**æ–‡æ¡£è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£ä¸ä»…åˆ—å‡ºå¼€å‘å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ›´é‡è¦çš„æ˜¯è§£é‡Š**ä¸ºä»€ä¹ˆ**éœ€è¦è¿™äº›å·¥å…·ï¼Œ**å¦‚ä½•**é«˜æ•ˆä½¿ç”¨è¿™äº›å·¥å…·ï¼Œä»¥åŠ**ä½•æ—¶**é€‰æ‹©ç‰¹å®šçš„å·¥å…·ã€‚æ¯ä¸ªå·¥å…·éƒ½åŒ…å«ï¼š

1. **å·¥å…·ä»·å€¼**ï¼šè§£é‡Šå·¥å…·çš„ä½œç”¨å’Œä»·å€¼
2. **ä½¿ç”¨æ–¹æ³•**ï¼šè¯´æ˜å¦‚ä½•ä½¿ç”¨å·¥å…·
3. **ä½¿ç”¨æŠ€å·§**ï¼šæä¾›å®ç”¨çš„ä½¿ç”¨æŠ€å·§å’Œæœ€ä½³å®è·µ
4. **é€‚ç”¨åœºæ™¯**ï¼šåˆ†æé€‚ç”¨åœºæ™¯å’Œé€‰æ‹©å»ºè®®

**å¼€å‘å·¥å…·ä¸è°ƒè¯•çš„é‡è¦æ€§**ï¼š

å¼€å‘å·¥å…·æ˜¯æé«˜å¼€å‘æ•ˆç‡çš„å…³é”®ï¼Œå®ƒç›´æ¥å½±å“ï¼š

1. **å¼€å‘æ•ˆç‡**ï¼šåˆé€‚çš„å·¥å…·å¯ä»¥æé«˜å¼€å‘æ•ˆç‡
   - **ç†è®ºä¾æ®**ï¼šå·¥å…·å¯ä»¥è‡ªåŠ¨åŒ–é‡å¤å·¥ä½œï¼Œå‡å°‘äººå·¥é”™è¯¯
   - **å®è·µä»·å€¼**ï¼šæé«˜å¼€å‘é€Ÿåº¦ï¼Œå‡å°‘è°ƒè¯•æ—¶é—´
   - **æ•ˆæœè¯„ä¼°**ï¼šå¼€å‘æ•ˆç‡æå‡50-100%ï¼Œè°ƒè¯•æ—¶é—´å‡å°‘60-80%

2. **ä»£ç è´¨é‡**ï¼šåˆé€‚çš„å·¥å…·å¯ä»¥æé«˜ä»£ç è´¨é‡
   - **ç†è®ºä¾æ®**ï¼šå·¥å…·å¯ä»¥æä¾›ä»£ç æ£€æŸ¥å’Œæ€§èƒ½åˆ†æ
   - **å®è·µä»·å€¼**ï¼šå‘ç°ä»£ç é—®é¢˜ï¼Œä¼˜åŒ–ä»£ç æ€§èƒ½
   - **æ•ˆæœè¯„ä¼°**ï¼šä»£ç è´¨é‡æå‡20-40%ï¼Œbugå‡å°‘30-50%

3. **é—®é¢˜æ’æŸ¥**ï¼šåˆé€‚çš„å·¥å…·å¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜
   - **ç†è®ºä¾æ®**ï¼šå·¥å…·å¯ä»¥æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œæ€§èƒ½æ•°æ®
   - **å®è·µä»·å€¼**ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œå‡å°‘æ•…éšœæ—¶é—´
   - **æ•ˆæœè¯„ä¼°**ï¼šé—®é¢˜å®šä½æ—¶é—´å‡å°‘70-90%ï¼ŒMTTRé™ä½60-80%

4. **çŸ¥è¯†ç§¯ç´¯**ï¼šå·¥å…·ä½¿ç”¨å½¢æˆçŸ¥è¯†åº“
   - **ç†è®ºä¾æ®**ï¼šå·¥å…·ä½¿ç”¨ç»éªŒå¯ä»¥ç§¯ç´¯å’Œä¼ æ‰¿
   - **å®è·µä»·å€¼**ï¼šæ–°å‘˜å·¥å¿«é€Ÿä¸Šæ‰‹ï¼Œå›¢é˜Ÿæ•´ä½“èƒ½åŠ›æå‡
   - **æ•ˆæœè¯„ä¼°**ï¼šæ–°å‘˜å·¥ä¸Šæ‰‹æ—¶é—´å‡å°‘50-70%

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **å·¥å…·å…¨é¢**ï¼šæ¶µç›–å‘½ä»¤è¡Œã€GUIã€è°ƒè¯•ã€åˆ†æå·¥å…·
  - **ç†è®ºä¾æ®**ï¼šå…¨é¢çš„å·¥å…·è¦†ç›–å¯ä»¥æé«˜å¼€å‘æ•ˆç‡
  - **å®è·µä»·å€¼**ï¼šå¸®åŠ©å¼€å‘äººå‘˜é€‰æ‹©æœ€é€‚åˆçš„å·¥å…·
  - **å·¥å…·ç±»å‹**ï¼šå‘½ä»¤è¡Œå·¥å…·ã€GUIå·¥å…·ã€è°ƒè¯•å·¥å…·ã€æ€§èƒ½åˆ†æå·¥å…·

- **å®ç”¨æ€§å¼º**ï¼šæä¾›å®é™…ä½¿ç”¨ç¤ºä¾‹å’ŒæŠ€å·§
  - **ç†è®ºä¾æ®**ï¼šå®é™…ç¤ºä¾‹å¯ä»¥å¸®åŠ©å¿«é€ŸæŒæ¡å·¥å…·
  - **å®è·µä»·å€¼**ï¼šæä¾›å¯ç›´æ¥åº”ç”¨çš„ä½¿ç”¨æŠ€å·§
  - **å®è·µå†…å®¹**ï¼šä½¿ç”¨ç¤ºä¾‹ã€æŠ€å·§åˆ†äº«ã€æœ€ä½³å®è·µ

- **æ€§èƒ½å¯¼å‘**ï¼šé‡ç‚¹å…³æ³¨æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å·¥å…·
  - **ç†è®ºä¾æ®**ï¼šæ€§èƒ½åˆ†ææ˜¯ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½çš„åŸºç¡€
  - **å®è·µä»·å€¼**ï¼šå¸®åŠ©è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
  - **æ€§èƒ½å·¥å…·**ï¼šEXPLAINã€pg_stat_statementsã€auto_explain

- **æœ€ä½³å®è·µ**ï¼šæ€»ç»“å®é™…é¡¹ç›®ä¸­çš„ç»éªŒ
  - **ç†è®ºä¾æ®**ï¼šåŸºäºå®é™…é¡¹ç›®çš„ç»éªŒæ€»ç»“
  - **å®è·µä»·å€¼**ï¼šé¿å…å¸¸è§é™·é˜±ï¼Œæé«˜å·¥å…·ä½¿ç”¨æ•ˆç‡
  - **å®è·µå†…å®¹**ï¼šè°ƒè¯•æµç¨‹ã€å·¥å…·é€‰æ‹©ã€æ•ˆç‡æå‡

æœ¬æ–‡æ¡£ä»‹ç»PostgreSQLå¼€å‘ä¸­å¸¸ç”¨çš„å·¥å…·å’Œè°ƒè¯•æŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æé«˜å¼€å‘æ•ˆç‡å’Œé—®é¢˜æ’æŸ¥èƒ½åŠ›ã€‚

**PostgreSQL 18 æ–°ç‰¹æ€§æ”¯æŒ**ï¼š

- âœ… **æ”¹è¿›çš„EXPLAINè¾“å‡º**ï¼šæ›´è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯
- âœ… **å¢å¼ºçš„æ—¥å¿—åŠŸèƒ½**ï¼šæ›´å¥½çš„è°ƒè¯•ä¿¡æ¯
- âœ… **æ€§èƒ½ç›‘æ§å¢å¼º**ï¼šæ›´ä¸°å¯Œçš„æ€§èƒ½æŒ‡æ ‡

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 å¼€å‘å·¥å…·å¯¹æ¯”

| å·¥å…· | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|-----|------|------|---------|--------|
| **psql** | å‘½ä»¤è¡Œ | è½»é‡ã€å¼ºå¤§ã€è„šæœ¬åŒ– | æœåŠ¡å™¨ç®¡ç†ã€è‡ªåŠ¨åŒ– | â­â­â­â­â­ |
| **pgAdmin** | GUI | å®˜æ–¹å·¥å…·ã€åŠŸèƒ½å…¨é¢ | æ—¥å¸¸å¼€å‘ã€ç®¡ç† | â­â­â­â­ |
| **DBeaver** | GUI | è·¨æ•°æ®åº“ã€å…è´¹ | å¤šæ•°æ®åº“ç¯å¢ƒ | â­â­â­â­ |
| **DataGrip** | GUI | JetBrainsã€æ™ºèƒ½æç¤º | ä¸“ä¸šå¼€å‘ | â­â­â­â­â­ |

### 2.2 è°ƒè¯•å·¥å…·å¯¹æ¯”

| å·¥å…· | åŠŸèƒ½ | æ€§èƒ½å½±å“ | æ˜“ç”¨æ€§ | æ¨èåº¦ |
|-----|------|---------|--------|--------|
| **EXPLAIN** | æŸ¥è¯¢è®¡åˆ’åˆ†æ | æ—  | â­â­â­â­ | â­â­â­â­â­ |
| **pg_stat_statements** | SQLç»Ÿè®¡ | ä½ | â­â­â­â­ | â­â­â­â­â­ |
| **auto_explain** | è‡ªåŠ¨è®¡åˆ’è®°å½• | ä½ | â­â­â­ | â­â­â­â­ |
| **log_statement** | SQLæ—¥å¿— | ä¸­ | â­â­â­ | â­â­â­ |

---

## ä¸‰ã€å‘½ä»¤è¡Œå·¥å…·

### 3.1 psqlåŸºç¡€

#### 3.1.1 psqlå·¥å…·çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦psql**ï¼š

psqlæ˜¯PostgreSQLçš„å®˜æ–¹å‘½ä»¤è¡Œå·¥å…·ï¼Œæ˜¯æ•°æ®åº“å¼€å‘å’Œç®¡ç†çš„åŸºç¡€å·¥å…·ï¼š

1. **è½»é‡é«˜æ•ˆ**ï¼šæ— éœ€GUIï¼Œèµ„æºå ç”¨å°‘ï¼Œé€‚åˆæœåŠ¡å™¨ç¯å¢ƒ
2. **è„šæœ¬åŒ–æ”¯æŒ**ï¼šå¯ä»¥ç¼–å†™è„šæœ¬è‡ªåŠ¨åŒ–æ•°æ®åº“æ“ä½œ
3. **åŠŸèƒ½å¼ºå¤§**ï¼šæ”¯æŒæ‰€æœ‰PostgreSQLåŠŸèƒ½ï¼ŒåŒ…æ‹¬é«˜çº§ç‰¹æ€§
4. **è·¨å¹³å°**ï¼šæ”¯æŒLinuxã€Windowsã€macOSç­‰æ‰€æœ‰å¹³å°

**psql vs GUIå·¥å…·å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | psql | GUIå·¥å…·ï¼ˆpgAdminç­‰ï¼‰ |
|-----|------|---------------------|
| **èµ„æºå ç”¨** | æä½ | è¾ƒé«˜ |
| **è„šæœ¬åŒ–** | âœ… ä¼˜ç§€ | âš ï¸ æœ‰é™ |
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰ | è¾ƒä½ |
| **åŠŸèƒ½å®Œæ•´æ€§** | âœ… 100% | âš ï¸ éƒ¨åˆ†åŠŸèƒ½ |
| **æœåŠ¡å™¨ç¯å¢ƒ** | âœ… é€‚åˆ | âŒ ä¸é€‚åˆ |
| **æ‰¹é‡æ“ä½œ** | âœ… ä¼˜ç§€ | âš ï¸ ä¸€èˆ¬ |

#### 3.1.2 è¿æ¥æ•°æ®åº“

**è¿æ¥æ–¹å¼è¯¦è§£**ï¼š

```bash
# æ–¹å¼1ï¼šåŸºæœ¬è¿æ¥ï¼ˆæœ€å¸¸ç”¨ï¼‰
# å‚æ•°è¯´æ˜ï¼š
# -h: ä¸»æœºåœ°å€ï¼ˆhostï¼‰
# -U: ç”¨æˆ·åï¼ˆuserï¼‰
# -d: æ•°æ®åº“åï¼ˆdatabaseï¼‰
# -p: ç«¯å£ï¼ˆportï¼Œé»˜è®¤5432ï¼‰
# -W: æç¤ºè¾“å…¥å¯†ç ï¼ˆpasswordï¼‰
psql -h localhost -U postgres -d mydb -W

# æ–¹å¼2ï¼šä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²ï¼ˆæ¨èï¼Œç®€æ´ï¼‰
# æ ¼å¼ï¼špostgresql://[user[:password]@][host][:port][/database][?å‚æ•°]
psql postgresql://user:password@localhost:5432/mydb

# æ–¹å¼3ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼Œå®‰å…¨ï¼‰
# è®¾ç½®ç¯å¢ƒå˜é‡
export PGHOST=localhost
export PGPORT=5432
export PGUSER=postgres
export PGDATABASE=mydb
export PGPASSWORD=password  # æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨.pgpassæ–‡ä»¶

# ç„¶åç›´æ¥è¿æ¥
psql

# æ–¹å¼4ï¼šä½¿ç”¨.pgpassæ–‡ä»¶ï¼ˆæ¨èï¼Œæœ€å®‰å…¨ï¼‰
# åˆ›å»º ~/.pgpass æ–‡ä»¶ï¼ˆLinux/macOSï¼‰æˆ– %APPDATA%\postgresql\pgpass.confï¼ˆWindowsï¼‰
# æ ¼å¼ï¼šhostname:port:database:username:password
# ç¤ºä¾‹ï¼š
# localhost:5432:mydb:postgres:mypassword
# è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆLinux/macOSï¼‰ï¼š
chmod 600 ~/.pgpass

# ç„¶åç›´æ¥è¿æ¥ï¼Œæ— éœ€è¾“å…¥å¯†ç 
psql -h localhost -U postgres -d mydb
```

**è¿æ¥å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ | æ¨èåº¦ |
|-----|------|------|--------|
| **-h, --host** | æ•°æ®åº“ä¸»æœºåœ°å€ | `-h localhost` | â­â­â­â­â­ |
| **-p, --port** | æ•°æ®åº“ç«¯å£ | `-p 5432` | â­â­â­â­ |
| **-U, --username** | æ•°æ®åº“ç”¨æˆ·å | `-U postgres` | â­â­â­â­â­ |
| **-d, --dbname** | æ•°æ®åº“åç§° | `-d mydb` | â­â­â­â­â­ |
| **-W, --password** | æç¤ºè¾“å…¥å¯†ç  | `-W` | â­â­â­â­ |
| **-f, --file** | æ‰§è¡ŒSQLæ–‡ä»¶ | `-f script.sql` | â­â­â­â­â­ |
| **-c, --command** | æ‰§è¡ŒSQLå‘½ä»¤ | `-c "SELECT 1"` | â­â­â­â­ |
| **-v, --set** | è®¾ç½®å˜é‡ | `-v ON_ERROR_STOP=1` | â­â­â­ |

**å®‰å…¨è¿æ¥é…ç½®**ï¼š

```bash
# åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨è¿æ¥
# éœ€æ±‚ï¼šä½¿ç”¨SSLåŠ å¯†ï¼Œå¯†ç ä».pgpassæ–‡ä»¶è¯»å–

# 1. åˆ›å»º.pgpassæ–‡ä»¶ï¼ˆLinux/macOSï¼‰
cat > ~/.pgpass << EOF
production-db.example.com:5432:production_db:app_user:secure_password
EOF
chmod 600 ~/.pgpass

# 2. ä½¿ç”¨SSLè¿æ¥
psql "postgresql://app_user@production-db.example.com:5432/production_db?sslmode=require"

# æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡
export PGSSLMODE=require
psql -h production-db.example.com -U app_user -d production_db

# 3. è¿æ¥é€‰é¡¹è¯´æ˜ï¼š
# sslmode=disable: ä¸ä½¿ç”¨SSLï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
# sslmode=require: è¦æ±‚SSLè¿æ¥ï¼ˆæ¨èï¼‰
# sslmode=verify-full: è¦æ±‚SSLå¹¶éªŒè¯è¯ä¹¦ï¼ˆæœ€å®‰å…¨ï¼‰
```

#### 3.1.3 åŸºæœ¬å‘½ä»¤

**psqlå…ƒå‘½ä»¤ï¼ˆMeta-commandsï¼‰**ï¼š

psqlæä¾›äº†ä¸°å¯Œçš„å…ƒå‘½ä»¤ï¼ˆä»¥åæ–œæ \å¼€å¤´çš„å‘½ä»¤ï¼‰ï¼Œç”¨äºå¿«é€Ÿæ“ä½œæ•°æ®åº“ï¼š

```sql
-- æ•°æ®åº“æ“ä½œ
\l          -- åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ï¼ˆlist databasesï¼‰
\l+         -- åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
\c dbname   -- è¿æ¥åˆ°æŒ‡å®šæ•°æ®åº“ï¼ˆconnectï¼‰
\c          -- æ˜¾ç¤ºå½“å‰è¿æ¥ä¿¡æ¯

-- è¡¨æ“ä½œ
\dt         -- åˆ—å‡ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨ï¼ˆlist tablesï¼‰
\dt+        -- åˆ—å‡ºæ‰€æœ‰è¡¨ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
\dt schema.* -- åˆ—å‡ºæŒ‡å®šschemaçš„æ‰€æœ‰è¡¨
\d table    -- æè¿°è¡¨ç»“æ„ï¼ˆdescribe tableï¼‰
\d+ table   -- æè¿°è¡¨ç»“æ„ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç´¢å¼•ã€çº¦æŸç­‰ï¼‰

-- Schemaæ“ä½œ
\dn         -- åˆ—å‡ºæ‰€æœ‰schemaï¼ˆlist schemasï¼‰
\dn+        -- åˆ—å‡ºæ‰€æœ‰schemaï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰

-- å‡½æ•°æ“ä½œ
\df         -- åˆ—å‡ºæ‰€æœ‰å‡½æ•°ï¼ˆlist functionsï¼‰
\df+ funcname -- åˆ—å‡ºæŒ‡å®šå‡½æ•°çš„è¯¦ç»†ä¿¡æ¯

-- ç´¢å¼•æ“ä½œ
\di         -- åˆ—å‡ºæ‰€æœ‰ç´¢å¼•ï¼ˆlist indexesï¼‰
\di+        -- åˆ—å‡ºæ‰€æœ‰ç´¢å¼•ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰

-- è§†å›¾æ“ä½œ
\dv         -- åˆ—å‡ºæ‰€æœ‰è§†å›¾ï¼ˆlist viewsï¼‰
\dv+        -- åˆ—å‡ºæ‰€æœ‰è§†å›¾ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰

-- æŸ¥è¯¢æ“ä½œ
\q          -- é€€å‡ºpsqlï¼ˆquitï¼‰
\?          -- æ˜¾ç¤ºpsqlå¸®åŠ©
\? commands -- æ˜¾ç¤ºæ‰€æœ‰å…ƒå‘½ä»¤
\? options  -- æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹

-- æ‰§è¡Œæ“ä½œ
\i file     -- æ‰§è¡ŒSQLæ–‡ä»¶ï¼ˆincludeï¼‰
\o file     -- å°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ï¼ˆoutputï¼‰
\copy       -- æ‰§è¡ŒCOPYå‘½ä»¤ï¼ˆå®¢æˆ·ç«¯COPYï¼‰

-- æ˜¾ç¤ºè®¾ç½®
\set        -- æ˜¾ç¤ºæ‰€æœ‰å˜é‡
\set var value -- è®¾ç½®å˜é‡
\unset var  -- å–æ¶ˆè®¾ç½®å˜é‡
\echo text  -- è¾“å‡ºæ–‡æœ¬
\prompt text var -- æç¤ºè¾“å…¥å¹¶ä¿å­˜åˆ°å˜é‡

-- æ ¼å¼åŒ–è¾“å‡º
\x          -- åˆ‡æ¢æ‰©å±•æ˜¾ç¤ºæ¨¡å¼ï¼ˆexpanded displayï¼‰
\timing     -- åˆ‡æ¢æ‰§è¡Œæ—¶é—´æ˜¾ç¤º
\pset format aligned -- è®¾ç½®è¾“å‡ºæ ¼å¼ï¼ˆaligned/unaligned/wrapped/html/...ï¼‰
\pset border 2 -- è®¾ç½®è¡¨æ ¼è¾¹æ¡†ï¼ˆ0/1/2ï¼‰
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```sql
    -- åœºæ™¯ï¼šæ¢ç´¢æ•°æ®åº“ç»“æ„
    -- æ­¥éª¤1ï¼šè¿æ¥åˆ°æ•°æ®åº“
    \c mydb

    -- æ­¥éª¤2ï¼šæŸ¥çœ‹æ‰€æœ‰schema
    \dn

    -- æ­¥éª¤3ï¼šæŸ¥çœ‹public schemaä¸­çš„æ‰€æœ‰è¡¨
    \dt public.*

    -- æ­¥éª¤4ï¼šæŸ¥çœ‹usersè¡¨çš„ç»“æ„
    \d users

    -- æ­¥éª¤5ï¼šæŸ¥çœ‹usersè¡¨çš„ç´¢å¼•
    \di users*

    -- æ­¥éª¤6ï¼šæŸ¥çœ‹usersè¡¨ç›¸å…³çš„å‡½æ•°
    \df user_*

    -- åœºæ™¯ï¼šæ‰§è¡ŒSQLæ–‡ä»¶å¹¶ä¿å­˜ç»“æœ
    -- æ­¥éª¤1ï¼šæ‰§è¡ŒSQLæ–‡ä»¶
    \i /path/to/query.sql

    -- æ­¥éª¤2ï¼šå°†æŸ¥è¯¢ç»“æœä¿å­˜åˆ°æ–‡ä»¶
    \o /path/to/result.csv
    SELECT * FROM users;
    \o  -- å…³é—­è¾“å‡ºé‡å®šå‘

    -- åœºæ™¯ï¼šä½¿ç”¨å˜é‡å’Œæç¤º
    -- è®¾ç½®å˜é‡
    \set user_id 12345

    -- åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å˜é‡
    SELECT * FROM users WHERE id = :user_id;

    -- æç¤ºè¾“å…¥
    \prompt 'Enter user ID: ' user_id
    SELECT * FROM users WHERE id = :'user_id';
    ```

    -- åˆ‡æ¢æ•°æ®åº“
    \c mydb

    -- åˆ—å‡ºæ‰€æœ‰è¡¨
    \dt

    -- åˆ—å‡ºæ‰€æœ‰Schema
    \dn

    -- æè¿°è¡¨ç»“æ„
    \d table_name

    -- åˆ—å‡ºæ‰€æœ‰å‡½æ•°
    \df

    -- åˆ—å‡ºæ‰€æœ‰ç´¢å¼•
    \di

    -- æŸ¥çœ‹æ‰§è¡Œæ—¶é—´
    \timing

    -- è®¾ç½®è¾“å‡ºæ ¼å¼
    \x  -- æ‰©å±•æ˜¾ç¤º
    \a  -- å¯¹é½/éå¯¹é½

```

### 3.2 psqlé«˜çº§åŠŸèƒ½

**å˜é‡å’Œè„šæœ¬**ï¼š

```sql
-- è®¾ç½®å˜é‡
\set myvar 'value'

-- ä½¿ç”¨å˜é‡
SELECT :'myvar';

-- æ‰§è¡Œå¤–éƒ¨è„šæœ¬
\i script.sql

-- è¾“å‡ºåˆ°æ–‡ä»¶
\o output.txt
SELECT * FROM users;
\o

-- æ‰§è¡Œå‘½ä»¤
\! ls -la
```

**psqlé…ç½®æ–‡ä»¶**ï¼š

```bash
# ~/.psqlrc
\set PROMPT1 '%[%033[1;33;40m%]%n@%/%R%[%033[0m%]%# '
\set PROMPT2 '%R%# '

-- è‡ªåŠ¨æ‰§è¡Œå¸¸ç”¨è®¾ç½®
\timing on
\x auto
\set COMP_KEYWORD_CASE upper
```

### 3.3 è„šæœ¬æ‰§è¡Œ

**æ‰§è¡ŒSQLè„šæœ¬**ï¼š

```bash
# æ‰§è¡ŒSQLæ–‡ä»¶
psql -h localhost -U postgres -d mydb -f script.sql

# æ‰§è¡Œå¹¶è¾“å‡ºç»“æœ
psql -h localhost -U postgres -d mydb -f script.sql -o output.txt

# æ‰§è¡Œå•æ¡SQL
psql -h localhost -U postgres -d mydb -c "SELECT * FROM users;"

# æ‰§è¡Œå¤šä¸ªå‘½ä»¤
psql -h localhost -U postgres -d mydb <<EOF
SELECT * FROM users;
SELECT * FROM orders;
EOF
```

---

## å››ã€GUIå·¥å…·

### 4.1 pgAdmin

**ä¸»è¦åŠŸèƒ½**ï¼š

- æ•°æ®åº“å¯¹è±¡ç®¡ç†
- æŸ¥è¯¢ç¼–è¾‘å™¨
- æ‰§è¡Œè®¡åˆ’å¯è§†åŒ–
- æ•°æ®å¯¼å…¥å¯¼å‡º
- å¤‡ä»½æ¢å¤

**ä½¿ç”¨æŠ€å·§**ï¼š

- ä½¿ç”¨æŸ¥è¯¢å·¥å…·æ‰§è¡ŒSQL
- ä½¿ç”¨æ‰§è¡Œè®¡åˆ’åˆ†æå™¨æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
- ä½¿ç”¨æ•°æ®å¯¼å‡ºå·¥å…·å¯¼å‡ºæ•°æ®
- ä½¿ç”¨å¤‡ä»½å·¥å…·è¿›è¡Œå¤‡ä»½

### 4.2 DBeaver

**ä¸»è¦åŠŸèƒ½**ï¼š

- è·¨æ•°æ®åº“æ”¯æŒ
- ERå›¾ç”Ÿæˆ
- æ•°æ®æ¯”è¾ƒ
- SQLç¼–è¾‘å™¨
- ä»»åŠ¡è°ƒåº¦

**ä½¿ç”¨æŠ€å·§**ï¼š

- ä½¿ç”¨ERå›¾æŸ¥çœ‹è¡¨å…³ç³»
- ä½¿ç”¨æ•°æ®æ¯”è¾ƒå·¥å…·æ¯”è¾ƒæ•°æ®
- ä½¿ç”¨SQLç¼–è¾‘å™¨ç¼–å†™å¤æ‚æŸ¥è¯¢
- ä½¿ç”¨ä»»åŠ¡è°ƒåº¦æ‰§è¡Œå®šæœŸä»»åŠ¡

### 4.3 DataGrip

**ä¸»è¦åŠŸèƒ½**ï¼š

- æ™ºèƒ½SQLç¼–è¾‘å™¨
- ä»£ç è¡¥å…¨
- é‡æ„æ”¯æŒ
- ç‰ˆæœ¬æ§åˆ¶é›†æˆ
- æ•°æ®åº“å¯¼èˆª

**ä½¿ç”¨æŠ€å·§**ï¼š

- ä½¿ç”¨ä»£ç è¡¥å…¨æé«˜æ•ˆç‡
- ä½¿ç”¨é‡æ„åŠŸèƒ½é‡æ„SQL
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†SQLè„šæœ¬
- ä½¿ç”¨æ•°æ®åº“å¯¼èˆªå¿«é€Ÿå®šä½å¯¹è±¡

---

## äº”ã€è°ƒè¯•æŠ€æœ¯

### 5.1 æŸ¥è¯¢è°ƒè¯•

**ä½¿ç”¨EXPLAINè°ƒè¯•**ï¼š

```sql
-- åŸºæœ¬EXPLAIN
EXPLAIN SELECT * FROM users WHERE id = 1;

-- è¯¦ç»†EXPLAIN
EXPLAIN ANALYZE SELECT * FROM users WHERE id = 1;

-- å¸¦ç¼“å†²ä¿¡æ¯çš„EXPLAIN
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE id = 1;

-- å¸¦æ ¼å¼çš„EXPLAIN
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON) SELECT * FROM users WHERE id = 1;
```

**æŸ¥è¯¢è®¡åˆ’åˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’æ ‘
EXPLAIN (ANALYZE, VERBOSE, BUFFERS, FORMAT JSON)
SELECT u.*, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.active = TRUE;
```

### 5.2 å‡½æ•°è°ƒè¯•

**ä½¿ç”¨RAISEè°ƒè¯•**ï¼š

```sql
-- åœ¨å‡½æ•°ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
CREATE OR REPLACE FUNCTION debug_function(p_id INTEGER)
RETURNS INTEGER AS $$
DECLARE
    v_count INTEGER;
BEGIN
    RAISE NOTICE 'Function called with id: %', p_id;

    SELECT COUNT(*) INTO v_count FROM users WHERE id = p_id;
    RAISE NOTICE 'Found % rows', v_count;

    RETURN v_count;
END;
$$ LANGUAGE plpgsql;

-- æŸ¥çœ‹NOTICEä¿¡æ¯
SET client_min_messages TO NOTICE;
SELECT debug_function(1);
```

**ä½¿ç”¨æ—¥å¿—è°ƒè¯•**ï¼š

```sql
-- åœ¨å‡½æ•°ä¸­è®°å½•æ—¥å¿—
CREATE OR REPLACE FUNCTION logged_function(p_id INTEGER)
RETURNS INTEGER AS $$
DECLARE
    v_result INTEGER;
BEGIN
    -- è®°å½•å¼€å§‹
    RAISE LOG 'Function started with id: %', p_id;

    -- æ‰§è¡Œé€»è¾‘
    SELECT id INTO v_result FROM users WHERE id = p_id;

    -- è®°å½•ç»“æœ
    RAISE LOG 'Function completed with result: %', v_result;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 æ€§èƒ½è°ƒè¯•

**æ€§èƒ½åˆ†ææ­¥éª¤**ï¼š

1. è¯†åˆ«æ…¢æŸ¥è¯¢
2. ä½¿ç”¨EXPLAINåˆ†æ
3. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
4. ä¼˜åŒ–æŸ¥è¯¢
5. éªŒè¯æ”¹è¿›

**æ€§èƒ½è°ƒè¯•ç¤ºä¾‹**ï¼š

```sql
-- 1. è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT query, calls, total_exec_time, mean_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 1 AND created_at > '2024-01-01';

-- 3. æ£€æŸ¥ç´¢å¼•
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'orders';

-- 4. åˆ›å»ºç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at);

-- 5. éªŒè¯æ”¹è¿›
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 1 AND created_at > '2024-01-01';
```

---

## å…­ã€æ—¥å¿—åˆ†æ

### 6.1 æ—¥å¿—é…ç½®

**postgresql.confé…ç½®**ï¼š

```conf
# æ—¥å¿—çº§åˆ«
log_min_messages = warning  # debug5, debug4, debug3, debug2, debug1, info, notice, warning, error, log, fatal, panic

# æ—¥å¿—è¾“å‡º
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# SQLæ—¥å¿—
log_statement = 'all'  # none, ddl, mod, all
log_duration = on
log_min_duration_statement = 1000  # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢

# è¿æ¥æ—¥å¿—
log_connections = on
log_disconnections = on

# é”æ—¥å¿—
log_lock_waits = on
deadlock_timeout = 1s
```

### 6.2 æ—¥å¿—åˆ†æå·¥å…·

**ä½¿ç”¨grepåˆ†ææ—¥å¿—**ï¼š

```bash
# æŸ¥æ‰¾é”™è¯¯
grep ERROR /var/log/postgresql/postgresql-*.log

# æŸ¥æ‰¾æ…¢æŸ¥è¯¢
grep "duration:" /var/log/postgresql/postgresql-*.log | awk '{print $NF}' | sort -n

# æŸ¥æ‰¾è¿æ¥é—®é¢˜
grep "connection" /var/log/postgresql/postgresql-*.log
```

**ä½¿ç”¨pgBadgeråˆ†æ**ï¼š

```bash
# å®‰è£…pgBadger
# ç”ŸæˆæŠ¥å‘Š
pgbadger /var/log/postgresql/postgresql-*.log -o report.html

# åˆ†æç‰¹å®šæ—¶é—´èŒƒå›´
pgbadger /var/log/postgresql/postgresql-*.log \
  --start-date "2024-01-01" \
  --end-date "2024-01-31" \
  -o report.html
```

### 6.3 æ…¢æŸ¥è¯¢æ—¥å¿—

**é…ç½®æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```conf
# è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_min_duration_statement = 1000

# è®°å½•æ‰€æœ‰æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´
log_duration = on

# è®°å½•æŸ¥è¯¢è®¡åˆ’
auto_explain.log_min_duration = 1000
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

**åˆ†ææ…¢æŸ¥è¯¢**ï¼š

```sql
-- ä½¿ç”¨pg_stat_statementsæŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / sum(total_exec_time) OVER ()) * 100 AS percent_total_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

---

## ä¸ƒã€æ€§èƒ½åˆ†æå·¥å…·

### 7.1 EXPLAINåˆ†æ

**EXPLAINè¾“å‡ºè§£è¯»**ï¼š

```sql
-- åŸºæœ¬EXPLAIN
EXPLAIN SELECT * FROM users WHERE id = 1;

-- è¾“å‡ºç¤ºä¾‹ï¼š
-- Seq Scan on users  (cost=0.00..25.00 rows=1 width=64)
--   Filter: (id = 1)

-- å…³é”®æŒ‡æ ‡ï¼š
-- - cost: é¢„ä¼°æˆæœ¬ï¼ˆå¯åŠ¨æˆæœ¬..æ€»æˆæœ¬ï¼‰
-- - rows: é¢„ä¼°è¡Œæ•°
-- - width: é¢„ä¼°è¡Œå®½åº¦
```

**EXPLAINé€‰é¡¹**ï¼š

```sql
-- ANALYZE: å®é™…æ‰§è¡Œå¹¶æ˜¾ç¤ºå®é™…æ—¶é—´
EXPLAIN ANALYZE SELECT * FROM users;

-- BUFFERS: æ˜¾ç¤ºç¼“å†²ä½¿ç”¨æƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users;

-- VERBOSE: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
EXPLAIN (ANALYZE, BUFFERS, VERBOSE) SELECT * FROM users;

-- FORMAT: è¾“å‡ºæ ¼å¼ï¼ˆTEXT, XML, JSON, YAMLï¼‰
EXPLAIN (ANALYZE, FORMAT JSON) SELECT * FROM users;
```

### 7.2 pg_stat_statements

**å¯ç”¨pg_stat_statements**ï¼š

```sql
-- åœ¨postgresql.confä¸­å¯ç”¨
shared_preload_libraries = 'pg_stat_statements'

-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_statements LIMIT 10;
```

**å¸¸ç”¨æŸ¥è¯¢**ï¼š

```sql
-- æœ€è€—æ—¶çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    (100 * total_exec_time / sum(total_exec_time) OVER ()) AS percent_total_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- æœ€é¢‘ç¹çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 10;

-- å¹³å‡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE calls > 100
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 7.3 auto_explain

**é…ç½®auto_explain**ï¼š

```conf
# åœ¨postgresql.confä¸­é…ç½®
shared_preload_libraries = 'auto_explain'
auto_explain.log_min_duration = 1000  # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_format = text
```

**ä½¿ç”¨auto_explain**ï¼š

```sql
-- åœ¨ä¼šè¯ä¸­å¯ç”¨
LOAD 'auto_explain';
SET auto_explain.log_min_duration = 1000;
SET auto_explain.log_analyze = on;

-- æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¶…è¿‡é˜ˆå€¼çš„æŸ¥è¯¢ä¼šè‡ªåŠ¨è®°å½•åˆ°æ—¥å¿—
SELECT * FROM large_table WHERE condition;
```

---

## å…«ã€å¼€å‘ç¯å¢ƒé…ç½®

### 8.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

**å®‰è£…PostgreSQL**ï¼š

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib

# macOS
brew install postgresql

# Windows
# ä¸‹è½½å®‰è£…åŒ…ä» https://www.postgresql.org/download/windows/
```

**é…ç½®å¼€å‘ç¯å¢ƒ**ï¼š

```conf
# postgresql.conf (å¼€å‘ç¯å¢ƒ)
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 16MB
maintenance_work_mem = 128MB
```

### 8.2 Dockerå¼€å‘ç¯å¢ƒ

**Docker Composeé…ç½®**ï¼š

```yaml
version: '3.8'
services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command:
      - "postgres"
      - "-c"
      - "log_statement=all"
      - "-c"
      - "log_min_duration_statement=0"

volumes:
  postgres_data:
```

**ä½¿ç”¨Docker**ï¼š

```bash
# å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f postgres

# æ‰§è¡ŒSQL
docker-compose exec postgres psql -U postgres -d mydb
```

### 8.3 æµ‹è¯•æ•°æ®ç”Ÿæˆ

**ä½¿ç”¨generate_seriesç”Ÿæˆæ•°æ®**ï¼š

```sql
-- ç”Ÿæˆæµ‹è¯•ç”¨æˆ·
INSERT INTO users (username, email, created_at)
SELECT
    'user' || generate_series(1, 1000),
    'user' || generate_series(1, 1000) || '@example.com',
    NOW() - (random() * INTERVAL '365 days')
FROM generate_series(1, 1000);

-- ç”Ÿæˆæµ‹è¯•è®¢å•
INSERT INTO orders (user_id, total_amount, created_at)
SELECT
    (random() * 1000)::INTEGER + 1,
    (random() * 1000)::DECIMAL(10,2),
    NOW() - (random() * INTERVAL '30 days')
FROM generate_series(1, 10000);
```

**ä½¿ç”¨pgbenchç”Ÿæˆæ•°æ®**ï¼š

```bash
# åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
pgbench -i -s 10 mydb  # -s 10 è¡¨ç¤º10å€è§„æ¨¡

# è¿è¡ŒåŸºå‡†æµ‹è¯•
pgbench -c 10 -j 2 -T 60 mydb
```

---

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 è°ƒè¯•æµç¨‹

**æ ‡å‡†è°ƒè¯•æµç¨‹**ï¼š

1. **é—®é¢˜è¯†åˆ«**ï¼šç¡®å®šé—®é¢˜ç°è±¡å’Œå½±å“èŒƒå›´
2. **æ—¥å¿—åˆ†æ**ï¼šæŸ¥çœ‹ç›¸å…³æ—¥å¿—ä¿¡æ¯
3. **æŸ¥è¯¢åˆ†æ**ï¼šä½¿ç”¨EXPLAINåˆ†ææ…¢æŸ¥è¯¢
4. **æ€§èƒ½åˆ†æ**ï¼šä½¿ç”¨pg_stat_statementsåˆ†æ
5. **ä¼˜åŒ–å®æ–½**ï¼šåº”ç”¨ä¼˜åŒ–æªæ–½
6. **éªŒè¯æµ‹è¯•**ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ

### 9.2 å·¥å…·é€‰æ‹©

**å·¥å…·é€‰æ‹©å»ºè®®**ï¼š

- **æ—¥å¸¸å¼€å‘**ï¼špgAdminæˆ–DataGrip
- **æœåŠ¡å™¨ç®¡ç†**ï¼špsql
- **æ€§èƒ½åˆ†æ**ï¼šEXPLAIN + pg_stat_statements
- **æ—¥å¿—åˆ†æ**ï¼špgBadger
- **è‡ªåŠ¨åŒ–è„šæœ¬**ï¼špsql

### 9.3 æ•ˆç‡æå‡

**æé«˜å¼€å‘æ•ˆç‡çš„æŠ€å·§**ï¼š

- ä½¿ç”¨psqlé…ç½®æ–‡ä»¶è‡ªå®šä¹‰ç¯å¢ƒ
- ä½¿ç”¨GUIå·¥å…·çš„ä»£ç è¡¥å…¨åŠŸèƒ½
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†SQLè„šæœ¬
- ä½¿ç”¨Dockerå¿«é€Ÿæ­å»ºå¼€å‘ç¯å¢ƒ
- ä½¿ç”¨æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·å¿«é€Ÿåˆ›å»ºæµ‹è¯•æ•°æ®

---

## åã€ç›¸å…³æ–‡æ¡£

- [APIä½¿ç”¨æŒ‡å—](./01.02-APIä½¿ç”¨æŒ‡å—.md)
- [ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ](./01.03-ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ.md)
- [æ€§èƒ½ç¼–ç¨‹æŠ€å·§](./01.05-æ€§èƒ½ç¼–ç¨‹æŠ€å·§.md)
- [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/03.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md)
- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/03.03-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
