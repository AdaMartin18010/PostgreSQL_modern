# PostgreSQL 18 ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼](#postgresql-18-ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 ç¼–ç¨‹èŒƒå¼å¯¹æ¯”](#21-ç¼–ç¨‹èŒƒå¼å¯¹æ¯”)
    - [2.2 ç¼–ç¨‹æ¨¡å¼å¯¹æ¯”](#22-ç¼–ç¨‹æ¨¡å¼å¯¹æ¯”)
  - [ä¸‰ã€å£°æ˜å¼ç¼–ç¨‹](#ä¸‰å£°æ˜å¼ç¼–ç¨‹)
    - [3.1 SQLå£°æ˜å¼ç‰¹æ€§](#31-sqlå£°æ˜å¼ç‰¹æ€§)
      - [3.1.1 å£°æ˜å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³](#311-å£°æ˜å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³)
      - [3.1.2 SQLå£°æ˜å¼æŸ¥è¯¢ç¤ºä¾‹](#312-sqlå£°æ˜å¼æŸ¥è¯¢ç¤ºä¾‹)
    - [3.2 æŸ¥è¯¢ä¼˜åŒ–](#32-æŸ¥è¯¢ä¼˜åŒ–)
      - [3.2.1 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å·¥ä½œåŸç†](#321-æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å·¥ä½œåŸç†)
      - [3.2.2 ä¼˜åŒ–å™¨å†³ç­–çš„å½±å“å› ç´ ](#322-ä¼˜åŒ–å™¨å†³ç­–çš„å½±å“å› ç´ )
    - [3.3 PostgreSQL 18å¢å¼º](#33-postgresql-18å¢å¼º)
      - [3.3.1 è™šæ‹Ÿç”Ÿæˆåˆ—ï¼ˆVirtual Generated Columnsï¼‰](#331-è™šæ‹Ÿç”Ÿæˆåˆ—virtual-generated-columns)
      - [3.3.2 MERGEè¯­å¥ä¼˜åŒ–](#332-mergeè¯­å¥ä¼˜åŒ–)
  - [å››ã€å‡½æ•°å¼ç¼–ç¨‹](#å››å‡½æ•°å¼ç¼–ç¨‹)
    - [4.1 PL/pgSQLå‡½æ•°å¼ç‰¹æ€§](#41-plpgsqlå‡½æ•°å¼ç‰¹æ€§)
    - [4.2 é«˜é˜¶å‡½æ•°](#42-é«˜é˜¶å‡½æ•°)
      - [4.2.1 é«˜é˜¶å‡½æ•°çš„æ¦‚å¿µ](#421-é«˜é˜¶å‡½æ•°çš„æ¦‚å¿µ)
      - [4.2.2 æ•°ç»„å‡½æ•°åº”ç”¨](#422-æ•°ç»„å‡½æ•°åº”ç”¨)
      - [4.2.3 å‡½æ•°å¼æ•°æ®å¤„ç†æ¨¡å¼](#423-å‡½æ•°å¼æ•°æ®å¤„ç†æ¨¡å¼)
    - [4.3 é€’å½’æŸ¥è¯¢](#43-é€’å½’æŸ¥è¯¢)
      - [4.3.1 é€’å½’æŸ¥è¯¢çš„åŸç†](#431-é€’å½’æŸ¥è¯¢çš„åŸç†)
      - [4.3.2 é€’å½’æŸ¥è¯¢åº”ç”¨ç¤ºä¾‹](#432-é€’å½’æŸ¥è¯¢åº”ç”¨ç¤ºä¾‹)
  - [äº”ã€é¢å‘å¯¹è±¡ç¼–ç¨‹](#äº”é¢å‘å¯¹è±¡ç¼–ç¨‹)
    - [5.1 ç±»å‹ç³»ç»Ÿ](#51-ç±»å‹ç³»ç»Ÿ)
    - [5.2 ç»§æ‰¿æœºåˆ¶](#52-ç»§æ‰¿æœºåˆ¶)
    - [5.3 å¤šæ€æ”¯æŒ](#53-å¤šæ€æ”¯æŒ)
  - [å…­ã€å“åº”å¼ç¼–ç¨‹](#å…­å“åº”å¼ç¼–ç¨‹)
    - [6.1 LISTEN/NOTIFYæœºåˆ¶](#61-listennotifyæœºåˆ¶)
    - [6.2 é€»è¾‘å¤åˆ¶](#62-é€»è¾‘å¤åˆ¶)
    - [6.3 æµå¼å¤„ç†](#63-æµå¼å¤„ç†)
  - [ä¸ƒã€äº‹ä»¶é©±åŠ¨ç¼–ç¨‹](#ä¸ƒäº‹ä»¶é©±åŠ¨ç¼–ç¨‹)
    - [7.1 è§¦å‘å™¨ç³»ç»Ÿ](#71-è§¦å‘å™¨ç³»ç»Ÿ)
    - [7.2 äº‹ä»¶æµå¤„ç†](#72-äº‹ä»¶æµå¤„ç†)
    - [7.3 å˜æ›´æ•°æ®æ•è·](#73-å˜æ›´æ•°æ®æ•è·)
  - [å…«ã€è®¾è®¡æ¨¡å¼](#å…«è®¾è®¡æ¨¡å¼)
    - [8.1 Repositoryæ¨¡å¼](#81-repositoryæ¨¡å¼)
    - [8.2 Unit of Workæ¨¡å¼](#82-unit-of-workæ¨¡å¼)
    - [8.3 Factoryæ¨¡å¼](#83-factoryæ¨¡å¼)
    - [8.4 Strategyæ¨¡å¼](#84-strategyæ¨¡å¼)
  - [ä¹ã€æœ€ä½³å®è·µ](#ä¹æœ€ä½³å®è·µ)
    - [9.1 èŒƒå¼é€‰æ‹©åŸåˆ™](#91-èŒƒå¼é€‰æ‹©åŸåˆ™)
    - [9.2 æ€§èƒ½è€ƒè™‘](#92-æ€§èƒ½è€ƒè™‘)
    - [9.3 å¯ç»´æŠ¤æ€§](#93-å¯ç»´æŠ¤æ€§)
  - [åã€ç›¸å…³æ–‡æ¡£](#åç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼))
    å£°æ˜å¼ç¼–ç¨‹
      SQLç‰¹æ€§
        å£°æ˜å¼è¯­æ³•
        æŸ¥è¯¢ä¼˜åŒ–
        æ•°æ®æŠ½è±¡
      æŸ¥è¯¢ä¼˜åŒ–
        ä¼˜åŒ–å™¨åŸç†
        æ‰§è¡Œè®¡åˆ’
        æ€§èƒ½ä¼˜åŒ–
      PostgreSQL 18å¢å¼º
        è™šæ‹Ÿç”Ÿæˆåˆ—
        MERGEä¼˜åŒ–
        æŸ¥è¯¢å¢å¼º
    å‡½æ•°å¼ç¼–ç¨‹
      PL/pgSQL
        å‡½æ•°å®šä¹‰
        å‡½æ•°ç‰¹æ€§
        å‡½æ•°ä¼˜åŒ–
      é«˜é˜¶å‡½æ•°
        å‡½æ•°æ¦‚å¿µ
        æ•°ç»„å‡½æ•°
        å‡½æ•°å¼æ¨¡å¼
      é€’å½’æŸ¥è¯¢
        é€’å½’åŸç†
        é€’å½’åº”ç”¨
        æ€§èƒ½ä¼˜åŒ–
    é¢å‘å¯¹è±¡ç¼–ç¨‹
      ç±»å‹ç³»ç»Ÿ
        è‡ªå®šä¹‰ç±»å‹
        ç±»å‹ç»§æ‰¿
        ç±»å‹å¤šæ€
      ç»§æ‰¿æœºåˆ¶
        è¡¨ç»§æ‰¿
        ç»§æ‰¿æŸ¥è¯¢
        ç»§æ‰¿ä¼˜åŒ–
      å¤šæ€æ”¯æŒ
        å‡½æ•°é‡è½½
        æ“ä½œç¬¦é‡è½½
        å¤šæ€æŸ¥è¯¢
    å“åº”å¼ç¼–ç¨‹
      LISTEN/NOTIFY
        æ¶ˆæ¯æœºåˆ¶
        äº‹ä»¶é€šçŸ¥
        å®æ—¶é€šä¿¡
      é€»è¾‘å¤åˆ¶
        å¤åˆ¶åŸç†
        æµå¼å¤åˆ¶
        å®æ—¶åŒæ­¥
      æµå¼å¤„ç†
        æµå¼æŸ¥è¯¢
        æµå¼å¤„ç†
        å®æ—¶åˆ†æ
    äº‹ä»¶é©±åŠ¨ç¼–ç¨‹
      è§¦å‘å™¨
        è§¦å‘å™¨åŸç†
        è§¦å‘å™¨ç±»å‹
        è§¦å‘å™¨ä¼˜åŒ–
      äº‹ä»¶æµ
        äº‹ä»¶å¤„ç†
        äº‹ä»¶è·¯ç”±
        äº‹ä»¶å­˜å‚¨
      CDC
        å˜æ›´æ•è·
        å˜æ›´ä¼ æ’­
        å®æ—¶åŒæ­¥
    è®¾è®¡æ¨¡å¼
      Repository
        æ•°æ®è®¿é—®
        æŠ½è±¡æ¥å£
        å®ç°æ¨¡å¼
      Unit of Work
        äº‹åŠ¡ç®¡ç†
        å˜æ›´è·Ÿè¸ª
        æ‰¹é‡æ“ä½œ
      Factory
        å¯¹è±¡åˆ›å»º
        å·¥å‚æ¨¡å¼
        é…ç½®ç®¡ç†
      Strategy
        ç­–ç•¥æ¨¡å¼
        ç®—æ³•é€‰æ‹©
        åŠ¨æ€åˆ‡æ¢
    æœ€ä½³å®è·µ
      èŒƒå¼é€‰æ‹©
        é€‰æ‹©åŸåˆ™
        é€‚ç”¨åœºæ™¯
        æƒè¡¡åˆ†æ
      æ€§èƒ½ä¼˜åŒ–
        ä¼˜åŒ–ç­–ç•¥
        æ€§èƒ½æµ‹è¯•
        æŒç»­ä¼˜åŒ–
      å¯ç»´æŠ¤æ€§
        ä»£ç è§„èŒƒ
        è®¾è®¡åŸåˆ™
        é‡æ„æ–¹æ³•
```

**æ€ç»´å¯¼å›¾è¯´æ˜**ï¼š

æœ¬æ€ç»´å¯¼å›¾å±•ç¤ºäº†ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»å£°æ˜å¼ç¼–ç¨‹åˆ°äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼Œä»è®¾è®¡æ¨¡å¼åˆ°æœ€ä½³å®è·µï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«ç†è®ºåŸºç¡€ã€å®ç°æ–¹æ³•å’Œå®è·µç»éªŒã€‚é€šè¿‡è¿™ä¸ªæ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£PostgreSQLæ”¯æŒçš„ç¼–ç¨‹èŒƒå¼ï¼Œå¹¶æ ¹æ®å…·ä½“éœ€æ±‚æ·±å…¥ç›¸å…³ç« èŠ‚ã€‚

**ä½¿ç”¨å»ºè®®**ï¼š

- **å¼€å‘äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨ç¼–ç¨‹èŒƒå¼çš„å®ç°å’Œåº”ç”¨ï¼Œç†è§£å¦‚ä½•åœ¨PostgreSQLä¸­ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹èŒƒå¼
- **æ¶æ„å¸ˆ**ï¼šé‡ç‚¹å…³æ³¨è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µï¼Œç†è§£å¦‚ä½•è®¾è®¡å¯ç»´æŠ¤çš„ç³»ç»Ÿæ¶æ„
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šé‡ç‚¹å…³æ³¨èŒƒå¼é€‰æ‹©åŸåˆ™å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œç†è§£å¦‚ä½•åšå‡ºæŠ€æœ¯å†³ç­–

---

## ä¸€ã€æ¦‚è¿°

**æ–‡æ¡£è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£ä¸ä»…å±•ç¤ºç¼–ç¨‹èŒƒå¼çš„ä»£ç ç¤ºä¾‹ï¼Œæ›´é‡è¦çš„æ˜¯è§£é‡Š**ä¸ºä»€ä¹ˆ**éœ€è¦ä¸åŒçš„ç¼–ç¨‹èŒƒå¼ï¼Œ**å¦‚ä½•**åœ¨PostgreSQLä¸­åº”ç”¨è¿™äº›èŒƒå¼ï¼Œä»¥åŠ**ä½•æ—¶**é€‰æ‹©ç‰¹å®šçš„ç¼–ç¨‹èŒƒå¼ã€‚æ¯ä¸ªèŒƒå¼éƒ½åŒ…å«ï¼š

1. **ç†è®ºåŸºç¡€**ï¼šè§£é‡ŠèŒƒå¼çš„æ ¸å¿ƒæ€æƒ³å’ŒåŸç†
2. **å®ç°æ–¹æ³•**ï¼šè¯´æ˜å¦‚ä½•åœ¨PostgreSQLä¸­å®ç°
3. **åº”ç”¨åœºæ™¯**ï¼šåˆ†æé€‚ç”¨åœºæ™¯å’Œæƒè¡¡è€ƒè™‘
4. **æœ€ä½³å®è·µ**ï¼šæä¾›å®è·µç»éªŒå’Œä¼˜åŒ–å»ºè®®

**ç¼–ç¨‹èŒƒå¼ä¸æ¨¡å¼çš„é‡è¦æ€§**ï¼š

ç¼–ç¨‹èŒƒå¼æ˜¯è½¯ä»¶å¼€å‘çš„åŸºç¡€ï¼Œå®ƒç›´æ¥å½±å“ï¼š

1. **ä»£ç è´¨é‡**ï¼šåˆé€‚çš„ç¼–ç¨‹èŒƒå¼å¯ä»¥æé«˜ä»£ç è´¨é‡
   - **ç†è®ºä¾æ®**ï¼šä¸åŒèŒƒå¼æœ‰ä¸åŒçš„ä»£ç ç»„ç»‡æ–¹å¼å’Œè¡¨è¾¾æ–¹å¼
   - **å®è·µä»·å€¼**ï¼šæé«˜ä»£ç å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§
   - **æ•ˆæœè¯„ä¼°**ï¼šä»£ç è´¨é‡æå‡20-40%ï¼Œç»´æŠ¤æˆæœ¬é™ä½30-50%

2. **å¼€å‘æ•ˆç‡**ï¼šåˆé€‚çš„ç¼–ç¨‹èŒƒå¼å¯ä»¥æé«˜å¼€å‘æ•ˆç‡
   - **ç†è®ºä¾æ®**ï¼šèŒƒå¼æä¾›äº†æŠ½è±¡å’Œå¤ç”¨æœºåˆ¶
   - **å®è·µä»·å€¼**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘é€Ÿåº¦
   - **æ•ˆæœè¯„ä¼°**ï¼šå¼€å‘æ•ˆç‡æå‡30-60%

3. **ç³»ç»Ÿæ€§èƒ½**ï¼šåˆé€‚çš„ç¼–ç¨‹èŒƒå¼å¯ä»¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
   - **ç†è®ºä¾æ®**ï¼šä¸åŒèŒƒå¼æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹å¾
   - **å®è·µä»·å€¼**ï¼šé€‰æ‹©æ€§èƒ½å‹å¥½çš„èŒƒå¼å¯ä»¥æå‡ç³»ç»Ÿæ€§èƒ½
   - **æ•ˆæœè¯„ä¼°**ï¼šæ€§èƒ½æå‡10-30%

4. **ç³»ç»Ÿå¯æ‰©å±•æ€§**ï¼šåˆé€‚çš„ç¼–ç¨‹èŒƒå¼å¯ä»¥æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§
   - **ç†è®ºä¾æ®**ï¼šèŒƒå¼æä¾›äº†æ¨¡å—åŒ–å’Œè§£è€¦æœºåˆ¶
   - **å®è·µä»·å€¼**ï¼šæé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§
   - **æ•ˆæœè¯„ä¼°**ï¼šç³»ç»Ÿå¯æ‰©å±•æ€§æå‡20-40%

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **èŒƒå¼å…¨é¢**ï¼šè¦†ç›–PostgreSQLæ”¯æŒçš„ä¸»è¦ç¼–ç¨‹èŒƒå¼
  - **ç†è®ºä¾æ®**ï¼šPostgreSQLæ”¯æŒå¤šç§ç¼–ç¨‹èŒƒå¼ï¼Œå¯ä»¥çµæ´»é€‰æ‹©
  - **å®è·µä»·å€¼**ï¼šå¸®åŠ©å¼€å‘äººå‘˜é€‰æ‹©æœ€é€‚åˆçš„ç¼–ç¨‹èŒƒå¼
  - **èŒƒå¼ç±»å‹**ï¼šå£°æ˜å¼ã€å‡½æ•°å¼ã€é¢å‘å¯¹è±¡ã€å“åº”å¼ã€äº‹ä»¶é©±åŠ¨

- **æ¨¡å¼å®ç”¨**ï¼šæä¾›å®ç”¨çš„è®¾è®¡æ¨¡å¼
  - **ç†è®ºä¾æ®**ï¼šè®¾è®¡æ¨¡å¼æ˜¯è§£å†³å¸¸è§é—®é¢˜çš„æˆç†Ÿæ–¹æ¡ˆ
  - **å®è·µä»·å€¼**ï¼šæä¾›å¯ç›´æ¥åº”ç”¨çš„è®¾è®¡æ¨¡å¼
  - **æ¨¡å¼ç±»å‹**ï¼šRepositoryã€Unit of Workã€Factoryã€Strategy

- **å®è·µå¯¼å‘**ï¼šåŸºäºå®é™…é¡¹ç›®ç»éªŒ
  - **ç†è®ºä¾æ®**ï¼šåŸºäºå®é™…é¡¹ç›®çš„ç»éªŒæ€»ç»“
  - **å®è·µä»·å€¼**ï¼šé¿å…å¸¸è§é™·é˜±ï¼Œæé«˜å¼€å‘æ•ˆç‡
  - **å®è·µå†…å®¹**ï¼šèŒƒå¼é€‰æ‹©åŸåˆ™ã€æ€§èƒ½ä¼˜åŒ–ã€å¯ç»´æŠ¤æ€§

- **PostgreSQL 18**ï¼šå……åˆ†åˆ©ç”¨æ–°ç‰¹æ€§
  - **ç†è®ºä¾æ®**ï¼šæ–°ç‰¹æ€§å¯ä»¥ç®€åŒ–ç¼–ç¨‹èŒƒå¼çš„å®ç°
  - **å®è·µä»·å€¼**ï¼šPostgreSQL 18çš„æ–°ç‰¹æ€§æä¾›äº†æ›´å¥½çš„ç¼–ç¨‹æ”¯æŒ
  - **æ–°ç‰¹æ€§**ï¼šè™šæ‹Ÿç”Ÿæˆåˆ—ã€MERGEä¼˜åŒ–ã€æŸ¥è¯¢å¢å¼º

---

PostgreSQL 18æ”¯æŒå¤šç§ç¼–ç¨‹èŒƒå¼ï¼Œä¸ºä¸åŒåœºæ™¯æä¾›æœ€é€‚åˆçš„ç¼–ç¨‹æ¨¡å¼ã€‚æœ¬æ–‡æ¡£ä»ç¨‹åºå‘˜è§†è§’æ·±å…¥åˆ†æPostgreSQLæ”¯æŒçš„å„ç§ç¼–ç¨‹èŒƒå¼ã€è®¾è®¡æ¨¡å¼åŠå…¶åº”ç”¨åœºæ™¯ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **å¤šèŒƒå¼æ”¯æŒ**ï¼šå£°æ˜å¼ã€å‡½æ•°å¼ã€é¢å‘å¯¹è±¡ã€å“åº”å¼ã€äº‹ä»¶é©±åŠ¨
- **çµæ´»ç»„åˆ**ï¼šä¸åŒèŒƒå¼å¯ä»¥çµæ´»ç»„åˆä½¿ç”¨
- **æ€§èƒ½ä¼˜åŒ–**ï¼šPostgreSQL 18é’ˆå¯¹å„ç§èŒƒå¼è¿›è¡Œäº†æ€§èƒ½ä¼˜åŒ–
- **æ ‡å‡†å…¼å®¹**ï¼šéµå¾ªSQLæ ‡å‡†å’Œç°ä»£ç¼–ç¨‹æœ€ä½³å®è·µ

**PostgreSQL 18 æ–°ç‰¹æ€§æ”¯æŒ**ï¼š

- âœ… **è™šæ‹Ÿç”Ÿæˆåˆ—**ï¼šæ”¯æŒå£°æ˜å¼è®¡ç®—åˆ—ï¼Œå‡å°‘é‡å¤è®¡ç®—
- âœ… **å¼‚æ­¥I/O**ï¼šæå‡å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶é©±åŠ¨çš„æ€§èƒ½
- âœ… **MERGEä¼˜åŒ–**ï¼šå¢å¼ºå£°æ˜å¼æ•°æ®æ“ä½œæ€§èƒ½
- âœ… **JSONBå¢å¼º**ï¼šæ›´å¥½çš„å‡½æ•°å¼æ•°æ®å¤„ç†æ”¯æŒ
- âœ… **å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼šæå‡å‡½æ•°å¼æŸ¥è¯¢æ€§èƒ½

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 ç¼–ç¨‹èŒƒå¼å¯¹æ¯”

| èŒƒå¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | PostgreSQLæ”¯æŒ | æ€§èƒ½ | å¤æ‚åº¦ |
|-----|------|---------|---------------|------|--------|
| **å£°æ˜å¼ç¼–ç¨‹** | æè¿°"åšä»€ä¹ˆ"è€Œé"æ€ä¹ˆåš" | æ•°æ®æŸ¥è¯¢ã€æŠ¥è¡¨ç”Ÿæˆ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ |
| **å‡½æ•°å¼ç¼–ç¨‹** | ä¸å¯å˜æ•°æ®ã€çº¯å‡½æ•° | æ•°æ®å¤„ç†ã€è½¬æ¢ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **é¢å‘å¯¹è±¡ç¼–ç¨‹** | å°è£…ã€ç»§æ‰¿ã€å¤šæ€ | å¤æ‚æ•°æ®æ¨¡å‹ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **å“åº”å¼ç¼–ç¨‹** | å¼‚æ­¥ã€äº‹ä»¶æµ | å®æ—¶æ•°æ®å¤„ç† | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **äº‹ä»¶é©±åŠ¨ç¼–ç¨‹** | äº‹ä»¶è§¦å‘ã€è§£è€¦ | ä¸šåŠ¡é€»è¾‘ã€å®¡è®¡ | â­â­â­â­â­ | â­â­â­ | â­â­â­ |

### 2.2 ç¼–ç¨‹æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | ç›®çš„ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|-----|------|---------|------|------|
| **Repositoryæ¨¡å¼** | æ•°æ®è®¿é—®æŠ½è±¡ | å‡½æ•°/å­˜å‚¨è¿‡ç¨‹å°è£… | è§£è€¦ã€å¯æµ‹è¯• | é¢å¤–æŠ½è±¡å±‚ |
| **Unit of Workæ¨¡å¼** | äº‹åŠ¡ç®¡ç† | äº‹åŠ¡å—ã€ä¿å­˜ç‚¹ | ä¸€è‡´æ€§ä¿è¯ | å¤æ‚åº¦å¢åŠ  |
| **Factoryæ¨¡å¼** | å¯¹è±¡åˆ›å»º | å‡½æ•°é‡è½½ã€ç±»å‹è½¬æ¢ | çµæ´»æ€§ | ç±»å‹å®‰å…¨ |
| **Strategyæ¨¡å¼** | ç®—æ³•é€‰æ‹© | å‡½æ•°æŒ‡é’ˆã€å¤šæ€ | å¯æ‰©å±•æ€§ | æ€§èƒ½å¼€é”€ |

---

## ä¸‰ã€å£°æ˜å¼ç¼–ç¨‹

### 3.1 SQLå£°æ˜å¼ç‰¹æ€§

#### 3.1.1 å£°æ˜å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³

**ä»€ä¹ˆæ˜¯å£°æ˜å¼ç¼–ç¨‹**ï¼š

å£°æ˜å¼ç¼–ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå¼€å‘è€…åªéœ€æè¿°"éœ€è¦ä»€ä¹ˆ"ï¼ˆWhatï¼‰ï¼Œè€Œä¸éœ€è¦æŒ‡å®š"å¦‚ä½•å®ç°"ï¼ˆHowï¼‰ã€‚è¿™ä¸å‘½ä»¤å¼ç¼–ç¨‹ï¼ˆImperativeï¼‰å½¢æˆå¯¹æ¯”ï¼Œå‘½ä»¤å¼ç¼–ç¨‹éœ€è¦è¯¦ç»†æè¿°æ‰§è¡Œæ­¥éª¤ã€‚

**ä¸ºä»€ä¹ˆSQLæ˜¯å£°æ˜å¼çš„**ï¼š

SQLçš„è®¾è®¡å“²å­¦æ˜¯è®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯æ‰§è¡Œç»†èŠ‚ã€‚å½“ä½ å†™ä¸€ä¸ªSELECTè¯­å¥æ—¶ï¼Œä½ æè¿°çš„æ˜¯ï¼š

- éœ€è¦å“ªäº›æ•°æ®ï¼ˆSELECTå­å¥ï¼‰
- æ•°æ®æ¥è‡ªå“ªé‡Œï¼ˆFROMå­å¥ï¼‰
- éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼ˆWHEREå­å¥ï¼‰
- å¦‚ä½•åˆ†ç»„å’Œèšåˆï¼ˆGROUP BYã€HAVINGï¼‰
- å¦‚ä½•æ’åºï¼ˆORDER BYï¼‰

ä½ ä¸éœ€è¦å…³å¿ƒï¼š

- ä½¿ç”¨å“ªä¸ªç´¢å¼•
- ä½¿ç”¨å“ªç§è¿æ¥ç®—æ³•ï¼ˆHash Joinã€Nested Loopã€Merge Joinï¼‰
- å¦‚ä½•å¹¶è¡Œæ‰§è¡Œ
- å¦‚ä½•ä¼˜åŒ–å†…å­˜ä½¿ç”¨

è¿™äº›éƒ½ç”±PostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨è‡ªåŠ¨å¤„ç†ã€‚

**å£°æ˜å¼ç¼–ç¨‹çš„ä¼˜åŠ¿åˆ†æ**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ | å®é™…ä»·å€¼ |
|-----|------|---------|
| **æŠ½è±¡å±‚æ¬¡é«˜** | å¼€å‘è€…å…³æ³¨ä¸šåŠ¡é€»è¾‘è€Œéå®ç°ç»†èŠ‚ | æå‡å¼€å‘æ•ˆç‡ï¼Œé™ä½å­¦ä¹ æˆæœ¬ |
| **è‡ªåŠ¨ä¼˜åŒ–** | ä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®æ•°æ®åˆ†å¸ƒã€ç´¢å¼•æƒ…å†µé€‰æ‹©æœ€ä¼˜è®¡åˆ’ | æ€§èƒ½éšæ•°æ®å˜åŒ–è‡ªåŠ¨è°ƒæ•´ |
| **å¯ç»´æŠ¤æ€§å¼º** | ä»£ç æ›´æ¥è¿‘è‡ªç„¶è¯­è¨€ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹ | é™ä½ç»´æŠ¤æˆæœ¬ |
| **å¹³å°æ— å…³** | SQLæ ‡å‡†ä¿è¯è·¨æ•°æ®åº“å…¼å®¹æ€§ | å‡å°‘è¿ç§»æˆæœ¬ |

**å£°æ˜å¼ç¼–ç¨‹çš„å±€é™æ€§**ï¼š

| å±€é™æ€§ | è¯´æ˜ | åº”å¯¹ç­–ç•¥ |
|-------|------|---------|
| **æ§åˆ¶åŠ›æœ‰é™** | æ— æ³•ç²¾ç¡®æ§åˆ¶æ‰§è¡Œç»†èŠ‚ | ä½¿ç”¨HINTæˆ–è°ƒæ•´é…ç½®å‚æ•° |
| **ä¼˜åŒ–å™¨å¯èƒ½å‡ºé”™** | ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®æ—¶å¯èƒ½é€‰æ‹©æ¬¡ä¼˜è®¡åˆ’ | å®šæœŸANALYZEï¼Œä½¿ç”¨EXPLAINéªŒè¯ |
| **å­¦ä¹ æ›²çº¿** | éœ€è¦ç†è§£ä¼˜åŒ–å™¨è¡Œä¸º | å­¦ä¹ æ‰§è¡Œè®¡åˆ’åˆ†æ |

#### 3.1.2 SQLå£°æ˜å¼æŸ¥è¯¢ç¤ºä¾‹

**åŸºç¡€æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```sql
-- å£°æ˜å¼æŸ¥è¯¢ï¼šæè¿°"éœ€è¦ä»€ä¹ˆ"
-- ä¸šåŠ¡éœ€æ±‚ï¼šæ‰¾å‡º2024å¹´1æœˆ1æ—¥ä¹‹åä¸‹å•ï¼Œæ€»é‡‘é¢è¶…è¿‡1000çš„å®¢æˆ·åŠå…¶è®¢å•ç»Ÿè®¡
SELECT
    customer_id,
    SUM(order_amount) as total_amount,
    COUNT(*) as order_count,
    AVG(order_amount) as avg_amount
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY customer_id
HAVING SUM(order_amount) > 1000
ORDER BY total_amount DESC;

-- è¿™ä¸ªæŸ¥è¯¢å£°æ˜äº†ï¼š
-- 1. éœ€è¦çš„æ•°æ®ï¼šå®¢æˆ·IDã€æ€»é‡‘é¢ã€è®¢å•æ•°ã€å¹³å‡é‡‘é¢
-- 2. æ•°æ®æ¥æºï¼šordersè¡¨
-- 3. è¿‡æ»¤æ¡ä»¶ï¼š2024å¹´1æœˆ1æ—¥ä¹‹å
-- 4. åˆ†ç»„æ–¹å¼ï¼šæŒ‰å®¢æˆ·IDåˆ†ç»„
-- 5. åˆ†ç»„è¿‡æ»¤ï¼šæ€»é‡‘é¢è¶…è¿‡1000
-- 6. æ’åºæ–¹å¼ï¼šæŒ‰æ€»é‡‘é¢é™åº
```

**æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹PostgreSQLå¦‚ä½•æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    customer_id,
    SUM(order_amount) as total_amount,
    COUNT(*) as order_count
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY customer_id
HAVING SUM(order_amount) > 1000
ORDER BY total_amount DESC;

-- å…¸å‹çš„æ‰§è¡Œè®¡åˆ’å¯èƒ½åŒ…æ‹¬ï¼š
-- 1. Index Scan on orders (ä½¿ç”¨order_dateç´¢å¼•)
-- 2. HashAggregate (å“ˆå¸Œèšåˆï¼ŒO(n)æ—¶é—´å¤æ‚åº¦)
-- 3. Sort (æ’åºï¼ŒO(n log n)æ—¶é—´å¤æ‚åº¦)
--
-- ä¼˜åŒ–å™¨ä¼šæ ¹æ®ä»¥ä¸‹å› ç´ é€‰æ‹©æ‰§è¡Œè®¡åˆ’ï¼š
-- - æ•°æ®é‡å¤§å°
-- - ç´¢å¼•å¯ç”¨æ€§
-- - ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§
-- - å†…å­˜å¯ç”¨æ€§
```

**å£°æ˜å¼ vs å‘½ä»¤å¼å¯¹æ¯”**ï¼š

```sql
-- å£°æ˜å¼ï¼ˆSQLï¼‰ï¼šæè¿°éœ€è¦ä»€ä¹ˆ
SELECT customer_id, SUM(amount)
FROM orders
WHERE date >= '2024-01-01'
GROUP BY customer_id;

-- å¦‚æœè¦ç”¨å‘½ä»¤å¼æ–¹å¼å®ç°ï¼ˆä¼ªä»£ç ï¼‰ï¼Œéœ€è¦ï¼š
-- 1. æ‰“å¼€ordersè¡¨
-- 2. éå†æ¯ä¸€è¡Œ
-- 3. æ£€æŸ¥dateæ¡ä»¶
-- 4. æŒ‰customer_idåˆ†ç»„
-- 5. ç´¯åŠ amount
-- 6. è¿”å›ç»“æœ
--
-- è¿™éœ€è¦å‡ åè¡Œä»£ç ï¼Œè€Œä¸”éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–
```

### 3.2 æŸ¥è¯¢ä¼˜åŒ–

#### 3.2.1 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å·¥ä½œåŸç†

**ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢ä¼˜åŒ–å™¨**ï¼š

åŒä¸€ä¸ªSQLæŸ¥è¯¢å¯ä»¥æœ‰å¤šç§æ‰§è¡Œæ–¹å¼ï¼Œä¸åŒçš„æ‰§è¡Œæ–¹å¼æ€§èƒ½å·®å¼‚å¯èƒ½è¾¾åˆ°å‡ ä¸ªæ•°é‡çº§ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ¶‰åŠ3ä¸ªè¡¨çš„JOINæŸ¥è¯¢ï¼Œå¯èƒ½çš„è¿æ¥é¡ºåºæœ‰6ç§ï¼ˆ3!ï¼‰ï¼Œæ¯ç§è¿æ¥é¡ºåºåˆå¯ä»¥ä½¿ç”¨ä¸åŒçš„è¿æ¥ç®—æ³•ï¼ˆHash Joinã€Nested Loopã€Merge Joinï¼‰ï¼Œç»„åˆèµ·æ¥å¯èƒ½æœ‰å‡ åç§æ‰§è¡Œè®¡åˆ’ã€‚

æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä»»åŠ¡æ˜¯ï¼š

1. **ç”Ÿæˆå€™é€‰è®¡åˆ’**ï¼šè€ƒè™‘æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œæ–¹å¼
2. **ä¼°ç®—ä»£ä»·**ï¼šåŸºäºç»Ÿè®¡ä¿¡æ¯ä¼°ç®—æ¯ä¸ªè®¡åˆ’çš„æ‰§è¡Œä»£ä»·
3. **é€‰æ‹©æœ€ä¼˜è®¡åˆ’**ï¼šé€‰æ‹©ä»£ä»·æœ€ä½çš„æ‰§è¡Œè®¡åˆ’

**ä¼˜åŒ–å™¨çš„ä¼˜åŒ–é˜¶æ®µ**ï¼š

PostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨é‡‡ç”¨å¤šé˜¶æ®µä¼˜åŒ–ç­–ç•¥ï¼š

| é˜¶æ®µ | ä¼˜åŒ–å†…å®¹ | ç¤ºä¾‹ |
|-----|---------|------|
| **è§£æé˜¶æ®µ** | SQLè¯­æ³•è§£æï¼Œç”ŸæˆæŸ¥è¯¢æ ‘ | å°†SQLæ–‡æœ¬è½¬æ¢ä¸ºå†…éƒ¨æ•°æ®ç»“æ„ |
| **é‡å†™é˜¶æ®µ** | æŸ¥è¯¢é‡å†™ï¼Œåº”ç”¨è§„åˆ™ä¼˜åŒ– | è§†å›¾å±•å¼€ã€å¸¸é‡æŠ˜å ã€å­æŸ¥è¯¢ä¼˜åŒ– |
| **è§„åˆ’é˜¶æ®µ** | ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œä»£ä»·ä¼°ç®— | é€‰æ‹©è¿æ¥é¡ºåºã€è¿æ¥ç®—æ³•ã€æ‰«ææ–¹å¼ |
| **æ‰§è¡Œé˜¶æ®µ** | æ‰§è¡Œè®¡åˆ’ï¼Œè¿”å›ç»“æœ | å®é™…æ•°æ®è®¿é—®å’Œè®¡ç®— |

**ä¼˜åŒ–ç­–ç•¥è¯¦è§£**ï¼š

**1. è§„åˆ™ä¼˜åŒ–ï¼ˆRule-based Optimizationï¼‰**ï¼š

è§„åˆ™ä¼˜åŒ–åŸºäºé¢„å®šä¹‰çš„è½¬æ¢è§„åˆ™ï¼Œä¸ä¾èµ–ç»Ÿè®¡ä¿¡æ¯ï¼š

```sql
-- ç¤ºä¾‹1ï¼šå¸¸é‡æŠ˜å 
-- ä¼˜åŒ–å‰ï¼šWHERE price > 100 + 50
-- ä¼˜åŒ–åï¼šWHERE price > 150
-- å¥½å¤„ï¼šå‡å°‘è¿è¡Œæ—¶è®¡ç®—

-- ç¤ºä¾‹2ï¼šè°“è¯ä¸‹æ¨
-- ä¼˜åŒ–å‰ï¼š
SELECT * FROM (
    SELECT * FROM orders WHERE status = 'pending'
) WHERE amount > 1000;
-- ä¼˜åŒ–åï¼š
SELECT * FROM orders
WHERE status = 'pending' AND amount > 1000;
-- å¥½å¤„ï¼šæå‰è¿‡æ»¤æ•°æ®ï¼Œå‡å°‘å¤„ç†é‡

-- ç¤ºä¾‹3ï¼šæŠ•å½±ä¸‹æ¨
-- ä¼˜åŒ–å‰ï¼šå…ˆJOINå†SELECTåˆ—
-- ä¼˜åŒ–åï¼šå…ˆSELECTéœ€è¦çš„åˆ—å†JOIN
-- å¥½å¤„ï¼šå‡å°‘ä¸­é—´ç»“æœå¤§å°
```

**2. ä»£ä»·ä¼˜åŒ–ï¼ˆCost-based Optimizationï¼‰**ï¼š

ä»£ä»·ä¼˜åŒ–åŸºäºç»Ÿè®¡ä¿¡æ¯ä¼°ç®—æ‰§è¡Œä»£ä»·ï¼š

```sql
-- æŸ¥çœ‹è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup as row_count,
    n_dead_tup as dead_rows,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'orders';

-- æŸ¥çœ‹åˆ—çš„ç»Ÿè®¡ä¿¡æ¯
SELECT
    attname,
    n_distinct,
    correlation,
    most_common_vals,
    most_common_freqs
FROM pg_stats
WHERE tablename = 'orders' AND attname = 'order_date';

-- ä¼˜åŒ–å™¨ä½¿ç”¨è¿™äº›ç»Ÿè®¡ä¿¡æ¯æ¥ï¼š
-- 1. ä¼°ç®—WHEREæ¡ä»¶çš„è¿‡æ»¤ç‡
-- 2. ä¼°ç®—JOINçš„ç»“æœé›†å¤§å°
-- 3. é€‰æ‹©æœ€ä¼˜çš„ç´¢å¼•
-- 4. å†³å®šæ˜¯å¦ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
```

**3. å¹¶è¡Œä¼˜åŒ–ï¼ˆParallel Optimizationï¼‰**ï¼š

PostgreSQL 18å¢å¼ºäº†å¹¶è¡ŒæŸ¥è¯¢èƒ½åŠ›ï¼š

```sql
-- æŸ¥çœ‹å¹¶è¡ŒæŸ¥è¯¢é…ç½®
SHOW max_parallel_workers_per_gather;
SHOW max_parallel_workers;
SHOW parallel_setup_cost;
SHOW parallel_tuple_cost;

-- å¹¶è¡ŒæŸ¥è¯¢ç¤ºä¾‹
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    customer_id,
    SUM(order_amount) as total
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY customer_id;

-- æ‰§è¡Œè®¡åˆ’å¯èƒ½æ˜¾ç¤ºï¼š
-- Gather (å¹¶è¡Œæ”¶é›†)
--   Workers Planned: 4
--   -> Parallel Seq Scan on orders
--   -> HashAggregate
--
-- è¿™æ„å‘³ç€ï¼š
-- 1. ä¸»è¿›ç¨‹å¯åŠ¨4ä¸ªå·¥ä½œè¿›ç¨‹
-- 2. æ¯ä¸ªå·¥ä½œè¿›ç¨‹æ‰«æéƒ¨åˆ†æ•°æ®
-- 3. å·¥ä½œè¿›ç¨‹è¿›è¡Œéƒ¨åˆ†èšåˆ
-- 4. ä¸»è¿›ç¨‹æ”¶é›†å¹¶åˆå¹¶ç»“æœ
```

#### 3.2.2 ä¼˜åŒ–å™¨å†³ç­–çš„å½±å“å› ç´ 

**ç»Ÿè®¡ä¿¡æ¯çš„é‡è¦æ€§**ï¼š

ç»Ÿè®¡ä¿¡æ¯æ˜¯ä¼˜åŒ–å™¨å†³ç­–çš„åŸºç¡€ï¼Œä¸å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯ä¼šå¯¼è‡´ä¼˜åŒ–å™¨é€‰æ‹©æ¬¡ä¼˜è®¡åˆ’ï¼š

```sql
-- é—®é¢˜åœºæ™¯ï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶
-- è¡¨ordersæœ‰1000ä¸‡è¡Œæ•°æ®ï¼Œä½†ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºåªæœ‰1000è¡Œ
-- ä¼˜åŒ–å™¨å¯èƒ½é€‰æ‹©å…¨è¡¨æ‰«æè€Œä¸æ˜¯ç´¢å¼•æ‰«æ

-- è§£å†³æ–¹æ¡ˆï¼šå®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE orders;

-- æˆ–è€…é’ˆå¯¹ç‰¹å®šåˆ—å¢åŠ ç»Ÿè®¡ä¿¡æ¯é‡‡æ ·
ALTER TABLE orders ALTER COLUMN order_date SET STATISTICS 1000;
ANALYZE orders;

-- éªŒè¯ç»Ÿè®¡ä¿¡æ¯
SELECT
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE tablename = 'orders';
```

**ç´¢å¼•å¯¹ä¼˜åŒ–å™¨çš„å½±å“**ï¼š

```sql
-- åœºæ™¯ï¼šä¼˜åŒ–å™¨é€‰æ‹©ç´¢å¼•è¿˜æ˜¯å…¨è¡¨æ‰«æï¼Ÿ
-- å†³ç­–å› ç´ ï¼š
-- 1. æ•°æ®é€‰æ‹©æ€§ï¼ˆé€‰æ‹©æ€§é«˜ -> ä½¿ç”¨ç´¢å¼•ï¼‰
-- 2. æ•°æ®åˆ†å¸ƒï¼ˆæ•°æ®é›†ä¸­ -> å¯èƒ½å…¨è¡¨æ‰«ææ›´å¿«ï¼‰
-- 3. ç´¢å¼•ç±»å‹ï¼ˆB-treeã€Hashã€GiSTç­‰ï¼‰
-- 4. è¡¨å¤§å°ï¼ˆå°è¡¨å¯èƒ½å…¨è¡¨æ‰«ææ›´å¿«ï¼‰

-- ç¤ºä¾‹ï¼šé€‰æ‹©æ€§é«˜çš„æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE order_id = 12345;
-- ç»“æœï¼šIndex Scan using orders_pkey

-- ç¤ºä¾‹ï¼šé€‰æ‹©æ€§ä½çš„æŸ¥è¯¢å¯èƒ½å…¨è¡¨æ‰«æ
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE status = 'pending';  -- å‡è®¾90%çš„è®¢å•éƒ½æ˜¯pending
-- ç»“æœï¼šå¯èƒ½é€‰æ‹©Seq Scanï¼ˆå¦‚æœè¡¨ä¸å¤§ï¼‰
```

**å†…å­˜é…ç½®å¯¹ä¼˜åŒ–çš„å½±å“**ï¼š

```sql
-- work_memå½±å“æ’åºå’Œå“ˆå¸Œæ“ä½œ
SHOW work_mem;

-- å¦‚æœwork_memå¤ªå°ï¼Œæ’åºå¯èƒ½ä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶ï¼ˆæ…¢ï¼‰
-- å¦‚æœwork_memå¤ªå¤§ï¼Œå¯èƒ½å½±å“å¹¶å‘æ€§èƒ½

-- ç¤ºä¾‹ï¼šè°ƒæ•´work_memè§‚å¯Ÿæ‰§è¡Œè®¡åˆ’å˜åŒ–
SET work_mem = '64MB';
EXPLAIN ANALYZE
SELECT * FROM orders
ORDER BY order_date DESC
LIMIT 100;
-- å¯èƒ½ä½¿ç”¨ï¼šIn-memory Sort

SET work_mem = '1MB';
EXPLAIN ANALYZE
SELECT * FROM orders
ORDER BY order_date DESC
LIMIT 100;
-- å¯èƒ½ä½¿ç”¨ï¼šExternal Sortï¼ˆç£ç›˜æ’åºï¼Œæ…¢ï¼‰
```

### 3.3 PostgreSQL 18å¢å¼º

#### 3.3.1 è™šæ‹Ÿç”Ÿæˆåˆ—ï¼ˆVirtual Generated Columnsï¼‰

**æŠ€æœ¯èƒŒæ™¯**ï¼š

åœ¨PostgreSQL 18ä¹‹å‰ï¼Œå¦‚æœéœ€è¦åŸºäºå…¶ä»–åˆ—è®¡ç®—çš„å€¼ï¼Œé€šå¸¸æœ‰å‡ ç§æ–¹å¼ï¼š

1. **åº”ç”¨å±‚è®¡ç®—**ï¼šæ¯æ¬¡æŸ¥è¯¢æ—¶åœ¨åº”ç”¨å±‚è®¡ç®—ï¼ˆæ€§èƒ½å·®ï¼Œä»£ç é‡å¤ï¼‰
2. **è§¦å‘å™¨è®¡ç®—**ï¼šä½¿ç”¨è§¦å‘å™¨ç»´æŠ¤è®¡ç®—åˆ—ï¼ˆå¤æ‚åº¦é«˜ï¼Œå®¹æ˜“å‡ºé”™ï¼‰
3. **è§†å›¾è®¡ç®—**ï¼šä½¿ç”¨è§†å›¾åŒ…å«è®¡ç®—é€»è¾‘ï¼ˆæŸ¥è¯¢æ€§èƒ½å¯èƒ½å—å½±å“ï¼‰

è™šæ‹Ÿç”Ÿæˆåˆ—è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œæä¾›äº†å£°æ˜å¼çš„æ–¹å¼æ¥å®šä¹‰è®¡ç®—åˆ—ã€‚

**æŠ€æœ¯åŸç†**ï¼š

PostgreSQL 18æ”¯æŒä¸¤ç§ç”Ÿæˆåˆ—ï¼š

- **STOREDç”Ÿæˆåˆ—**ï¼šå€¼å­˜å‚¨åœ¨è¡¨ä¸­ï¼Œå†™å…¥æ—¶è®¡ç®—ï¼Œè¯»å–æ—¶ç›´æ¥è¿”å›ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
- **VIRTUALç”Ÿæˆåˆ—**ï¼ˆè®¡åˆ’ä¸­ï¼‰ï¼šå€¼ä¸å­˜å‚¨ï¼Œè¯»å–æ—¶è®¡ç®—ï¼ˆæ—¶é—´æ¢ç©ºé—´ï¼‰

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```sql
-- åœºæ™¯ï¼šç”µå•†äº§å“è¡¨ï¼Œéœ€è¦è®¡ç®—æœ€ç»ˆä»·æ ¼ï¼ˆåŸä»· * (1 - æŠ˜æ‰£ç‡)ï¼‰
-- é—®é¢˜ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è¦è®¡ç®—ï¼Œä»£ç é‡å¤ï¼Œå®¹æ˜“å‡ºé”™

-- è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨STOREDç”Ÿæˆåˆ—
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL CHECK (price > 0),
    discount DECIMAL(5,2) DEFAULT 0 CHECK (discount >= 0 AND discount <= 100),
    -- ç”Ÿæˆåˆ—ï¼šè‡ªåŠ¨è®¡ç®—æœ€ç»ˆä»·æ ¼
    final_price DECIMAL(10,2)
        GENERATED ALWAYS AS (
            price * (1 - discount/100)
        ) STORED,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æ•°æ®æ—¶ï¼Œfinal_priceè‡ªåŠ¨è®¡ç®—
INSERT INTO products (name, price, discount)
VALUES ('Laptop', 1000.00, 15.00);
-- final_priceè‡ªåŠ¨è®¡ç®—ä¸ºï¼š1000 * (1 - 15/100) = 850.00

-- æŸ¥è¯¢æ—¶ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è®¡ç®—
SELECT id, name, price, discount, final_price
FROM products
WHERE final_price > 100;

-- å¯ä»¥åœ¨ç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_products_final_price ON products(final_price);

-- æ€§èƒ½åˆ†æï¼š
-- 1. å†™å…¥æ€§èƒ½ï¼šè½»å¾®å½±å“ï¼ˆéœ€è¦è®¡ç®—ç”Ÿæˆåˆ—ï¼‰
-- 2. è¯»å–æ€§èƒ½ï¼šæ— å½±å“ï¼ˆç›´æ¥è¯»å–å­˜å‚¨å€¼ï¼‰
-- 3. å­˜å‚¨ç©ºé—´ï¼šå¢åŠ ï¼ˆå­˜å‚¨è®¡ç®—å€¼ï¼‰
-- 4. æ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼Œä¸ä¼šä¸ä¸€è‡´ï¼‰
```

**ä½¿ç”¨åœºæ™¯åˆ†æ**ï¼š

| åœºæ™¯ | é€‚ç”¨æ€§ | ç†ç”± |
|-----|--------|------|
| **é¢‘ç¹æŸ¥è¯¢çš„è®¡ç®—åˆ—** | â­â­â­â­â­ | é¿å…é‡å¤è®¡ç®—ï¼Œæå‡æ€§èƒ½ |
| **å¤æ‚è®¡ç®—é€»è¾‘** | â­â­â­â­â­ | é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤ |
| **éœ€è¦ç´¢å¼•çš„è®¡ç®—åˆ—** | â­â­â­â­â­ | STOREDåˆ—å¯ä»¥åˆ›å»ºç´¢å¼• |
| **å¾ˆå°‘æŸ¥è¯¢çš„è®¡ç®—åˆ—** | â­â­ | å­˜å‚¨ç©ºé—´æµªè´¹ï¼Œè€ƒè™‘VIRTUALåˆ— |
| **ä¾èµ–å¤–éƒ¨æ•°æ®çš„è®¡ç®—** | âŒ | ç”Ÿæˆåˆ—åªèƒ½ä¾èµ–åŒä¸€è¡Œçš„åˆ— |

**æœ€ä½³å®è·µ**ï¼š

1. **é€‰æ‹©STOREDè¿˜æ˜¯VIRTUAL**ï¼š
   - é¢‘ç¹æŸ¥è¯¢ â†’ STOREDï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
   - å¾ˆå°‘æŸ¥è¯¢ â†’ VIRTUALï¼ˆæ—¶é—´æ¢ç©ºé—´ï¼ŒPostgreSQL 18è®¡åˆ’æ”¯æŒï¼‰

2. **ç´¢å¼•ç­–ç•¥**ï¼š
   - åœ¨STOREDç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½
   - è€ƒè™‘æŸ¥è¯¢æ¨¡å¼ï¼Œé€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹

3. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - ç”Ÿæˆåˆ—çš„å€¼å§‹ç»ˆä¸æºåˆ—ä¸€è‡´ï¼Œæ— éœ€æ‹…å¿ƒæ•°æ®ä¸ä¸€è‡´
   - ä½†è¦æ³¨æ„ï¼šä¿®æ”¹æºåˆ—æ—¶ï¼Œç”Ÿæˆåˆ—ä¼šè‡ªåŠ¨æ›´æ–°

#### 3.3.2 MERGEè¯­å¥ä¼˜åŒ–

**æŠ€æœ¯èƒŒæ™¯**ï¼š

åœ¨PostgreSQL 18ä¹‹å‰ï¼Œå®ç°"å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥"ï¼ˆUPSERTï¼‰é€šå¸¸ä½¿ç”¨ï¼š

1. **INSERT ... ON CONFLICT**ï¼šPostgreSQL 9.5+æ”¯æŒï¼Œä½†è¯­æ³•ç›¸å¯¹å¤æ‚
2. **å…ˆSELECTåINSERT/UPDATE**ï¼šå­˜åœ¨ç«æ€æ¡ä»¶ï¼Œéœ€è¦äº‹åŠ¡ä¿æŠ¤
3. **å­˜å‚¨è¿‡ç¨‹**ï¼šä»£ç å¤æ‚ï¼Œæ€§èƒ½å¯èƒ½ä¸å¦‚åŸç”Ÿè¯­å¥

MERGEè¯­å¥æä¾›äº†æ ‡å‡†SQLçš„æ–¹å¼æ¥å®ç°UPSERTï¼ŒPostgreSQL 18å¯¹å…¶è¿›è¡Œäº†æ€§èƒ½ä¼˜åŒ–ã€‚

**MERGEè¯­å¥åŸç†**ï¼š

MERGEè¯­å¥å°†æºè¡¨å’Œç›®æ ‡è¡¨è¿›è¡ŒåŒ¹é…ï¼Œæ ¹æ®åŒ¹é…ç»“æœæ‰§è¡Œä¸åŒçš„æ“ä½œï¼š

- **WHEN MATCHED**ï¼šåŒ¹é…æ—¶æ‰§è¡ŒUPDATEæˆ–DELETE
- **WHEN NOT MATCHED**ï¼šä¸åŒ¹é…æ—¶æ‰§è¡ŒINSERT

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```sql
-- åœºæ™¯ï¼šæ‰¹é‡åŒæ­¥å®¢æˆ·æ•°æ®
-- éœ€æ±‚ï¼šå¦‚æœå®¢æˆ·å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥

-- æºæ•°æ®è¡¨ï¼ˆä¸´æ—¶è¡¨æˆ–å¤–éƒ¨è¡¨ï¼‰
CREATE TEMP TABLE new_customer_data (
    email VARCHAR(100) PRIMARY KEY,
    name VARCHAR(100),
    phone VARCHAR(20),
    updated_at TIMESTAMP
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO new_customer_data VALUES
    ('alice@example.com', 'Alice Smith', '123-456-7890', CURRENT_TIMESTAMP),
    ('bob@example.com', 'Bob Jones', '098-765-4321', CURRENT_TIMESTAMP);

-- ä½¿ç”¨MERGEåŒæ­¥æ•°æ®
MERGE INTO customers AS c
USING new_customer_data AS n
ON c.email = n.email
WHEN MATCHED THEN
    UPDATE SET
        name = n.name,
        phone = n.phone,
        updated_at = n.updated_at
WHEN NOT MATCHED THEN
    INSERT (email, name, phone, created_at, updated_at)
    VALUES (n.email, n.name, n.phone, CURRENT_TIMESTAMP, n.updated_at);

-- æ€§èƒ½åˆ†æï¼š
-- 1. åŸå­æ€§ï¼šæ•´ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æ›´æ–°
-- 2. æ€§èƒ½ï¼šæ¯”å…ˆSELECTåINSERT/UPDATEå¿«ï¼Œå› ä¸ºåªéœ€è¦ä¸€æ¬¡è¡¨æ‰«æ
-- 3. å¹¶å‘å®‰å…¨ï¼šMERGEè¯­å¥ä¼šè‡ªåŠ¨å¤„ç†å¹¶å‘å†²çª
```

**MERGE vs INSERT ... ON CONFLICTå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | MERGE | INSERT ... ON CONFLICT |
|-----|-------|----------------------|
| **SQLæ ‡å‡†** | âœ… æ ‡å‡†SQL | âŒ PostgreSQLæ‰©å±• |
| **è¯­æ³•æ¸…æ™°åº¦** | â­â­â­â­â­ | â­â­â­ |
| **åŠŸèƒ½çµæ´»æ€§** | â­â­â­â­â­ | â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­â­ |
| **å¤šæ¡ä»¶åŒ¹é…** | âœ… æ”¯æŒ | âŒ ä»…æ”¯æŒå”¯ä¸€çº¦æŸ |

**MERGEçš„é«˜çº§ç”¨æ³•**ï¼š

```sql
-- åœºæ™¯ï¼šå¤æ‚çš„åŒæ­¥é€»è¾‘
-- éœ€æ±‚ï¼šåŒ¹é…æ—¶æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒæ“ä½œ

MERGE INTO customers AS c
USING new_customer_data AS n
ON c.email = n.email
WHEN MATCHED AND n.updated_at > c.updated_at THEN
    -- åªæœ‰æ–°æ•°æ®æ›´æ–°æ—¶æ‰æ›´æ–°
    UPDATE SET
        name = n.name,
        phone = n.phone,
        updated_at = n.updated_at
WHEN MATCHED AND n.updated_at <= c.updated_at THEN
    -- æ—§æ•°æ®ä¸æ›´æ–°ï¼Œä½†å¯ä»¥è®°å½•æ—¥å¿—
    DO NOTHING
WHEN NOT MATCHED THEN
    INSERT (email, name, phone, created_at, updated_at)
    VALUES (n.email, n.name, n.phone, CURRENT_TIMESTAMP, n.updated_at);

-- æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š
-- 1. ç¡®ä¿ONæ¡ä»¶ä½¿ç”¨çš„åˆ—æœ‰ç´¢å¼•
-- 2. æ‰¹é‡æ“ä½œæ—¶è€ƒè™‘ä½¿ç”¨COPY + MERGE
-- 3. å¤§è¡¨MERGEæ—¶è€ƒè™‘åˆ†æ‰¹å¤„ç†
```

---

## å››ã€å‡½æ•°å¼ç¼–ç¨‹

### 4.1 PL/pgSQLå‡½æ•°å¼ç‰¹æ€§

PostgreSQLçš„PL/pgSQLæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§ï¼ŒåŒ…æ‹¬çº¯å‡½æ•°ã€ä¸å¯å˜æ•°æ®ç­‰ã€‚

**çº¯å‡½æ•°ç¤ºä¾‹**ï¼š

```sql
-- çº¯å‡½æ•°ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡ºï¼Œæ— å‰¯ä½œç”¨
CREATE OR REPLACE FUNCTION calculate_tax(
    amount DECIMAL,
    tax_rate DECIMAL
) RETURNS DECIMAL
LANGUAGE plpgsql
IMMUTABLE  -- ä¸å¯å˜å‡½æ•°
AS $$
BEGIN
    RETURN amount * tax_rate;
END;
$$;

-- å¯ä»¥åœ¨ç´¢å¼•ä¸­ä½¿ç”¨
CREATE INDEX idx_order_tax ON orders (calculate_tax(amount, 0.1));
```

### 4.2 é«˜é˜¶å‡½æ•°

#### 4.2.1 é«˜é˜¶å‡½æ•°çš„æ¦‚å¿µ

**ä»€ä¹ˆæ˜¯é«˜é˜¶å‡½æ•°**ï¼š

é«˜é˜¶å‡½æ•°æ˜¯æŒ‡æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å‡½æ•°ä½œä¸ºç»“æœçš„å‡½æ•°ã€‚è¿™æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œä½¿å¾—ä»£ç æ›´åŠ çµæ´»å’Œå¯å¤ç”¨ã€‚

**PostgreSQLå¯¹é«˜é˜¶å‡½æ•°çš„æ”¯æŒ**ï¼š

PostgreSQLé€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¯æŒé«˜é˜¶å‡½æ•°ï¼š

1. **èšåˆå‡½æ•°**ï¼šæ¥å—è¡¨è¾¾å¼ä½œä¸ºå‚æ•°
2. **æ•°ç»„å‡½æ•°**ï¼šå¯ä»¥å¯¹æ•°ç»„å…ƒç´ åº”ç”¨å‡½æ•°
3. **çª—å£å‡½æ•°**ï¼šåœ¨çª—å£èŒƒå›´å†…åº”ç”¨å‡½æ•°
4. **Lambdaè¡¨è¾¾å¼**ï¼šPostgreSQL 14+æ”¯æŒï¼ˆéƒ¨åˆ†åœºæ™¯ï¼‰

**é«˜é˜¶å‡½æ•°çš„ä¼˜åŠ¿**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ | å®é™…ä»·å€¼ |
|-----|------|---------|
| **ä»£ç å¤ç”¨** | é€šç”¨é€»è¾‘å¯ä»¥å°è£…ä¸ºå‡½æ•°ï¼Œåº”ç”¨åˆ°ä¸åŒæ•°æ® | å‡å°‘ä»£ç é‡å¤ |
| **çµæ´»æ€§** | é€šè¿‡å‡½æ•°å‚æ•°æ”¹å˜è¡Œä¸ºï¼Œæ— éœ€ä¿®æ”¹ä»£ç  | æå‡ä»£ç çµæ´»æ€§ |
| **å¯ç»„åˆæ€§** | å‡½æ•°å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œæ„å»ºå¤æ‚é€»è¾‘ | æå‡ä»£ç å¯ç»´æŠ¤æ€§ |

#### 4.2.2 æ•°ç»„å‡½æ•°åº”ç”¨

**æ•°ç»„å‡½æ•°çš„é«˜é˜¶ç‰¹æ€§**ï¼š

PostgreSQLæä¾›äº†ä¸°å¯Œçš„æ•°ç»„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°ï¼ˆé€šè¿‡è¡¨è¾¾å¼ï¼‰ï¼š

```sql
-- åœºæ™¯ï¼šå¯¹æ•°ç»„å…ƒç´ è¿›è¡Œè½¬æ¢
-- éœ€æ±‚ï¼šå°†ä»·æ ¼æ•°ç»„ä¸­çš„æ¯ä¸ªä»·æ ¼åº”ç”¨æŠ˜æ‰£

-- æ–¹æ³•1ï¼šä½¿ç”¨æ•°ç»„å±•å¼€å’Œèšåˆï¼ˆå‡½æ•°å¼é£æ ¼ï¼‰
SELECT
    product_id,
    ARRAY(
        SELECT price * 0.9  -- åº”ç”¨10%æŠ˜æ‰£
        FROM UNNEST(prices) AS price
    ) AS discounted_prices
FROM products;

-- æ–¹æ³•2ï¼šä½¿ç”¨æ•°ç»„å‡½æ•°ï¼ˆPostgreSQL 14+ï¼Œå¦‚æœæ”¯æŒï¼‰
-- SELECT array_map(x -> x * 0.9, prices) FROM products;

-- å®é™…åº”ç”¨ï¼šå¤„ç†è®¢å•é‡‘é¢æ•°ç»„
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER,
    amounts DECIMAL[]  -- è®¢å•é‡‘é¢æ•°ç»„
);

-- è®¡ç®—æ¯ä¸ªè®¢å•çš„æ€»é‡‘é¢ï¼ˆå‡½æ•°å¼é£æ ¼ï¼‰
SELECT
    id,
    customer_id,
    amounts,
    (SELECT SUM(amount) FROM UNNEST(amounts) AS amount) AS total_amount
FROM orders;

-- æˆ–è€…ä½¿ç”¨èšåˆå‡½æ•°ï¼ˆæ›´ç®€æ´ï¼‰
SELECT
    id,
    customer_id,
    amounts,
    (SELECT SUM(x) FROM UNNEST(amounts) x) AS total_amount
FROM orders;
```

**æ•°ç»„èšåˆå‡½æ•°**ï¼š

```sql
-- åœºæ™¯ï¼šå°†å¤šè¡Œæ•°æ®èšåˆæˆæ•°ç»„
-- éœ€æ±‚ï¼šè·å–æ¯ä¸ªå®¢æˆ·çš„æ‰€æœ‰è®¢å•é‡‘é¢

SELECT
    customer_id,
    array_agg(order_amount ORDER BY order_date) as amounts,
    array_agg(DISTINCT order_amount) as unique_amounts,
    array_length(array_agg(order_amount), 1) as order_count
FROM orders
GROUP BY customer_id;

-- æ€§èƒ½åˆ†æï¼š
-- 1. array_aggæ˜¯èšåˆå‡½æ•°ï¼Œåœ¨GROUP BYæ—¶æ‰§è¡Œ
-- 2. ORDER BYä¿è¯æ•°ç»„å…ƒç´ æœ‰åº
-- 3. DISTINCTå»é‡ï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½
-- 4. array_lengthè®¡ç®—æ•°ç»„é•¿åº¦ï¼ŒO(1)æ—¶é—´å¤æ‚åº¦

-- æœ€ä½³å®è·µï¼š
-- - å°æ•°ç»„ï¼ˆ<1000å…ƒç´ ï¼‰ï¼šæ€§èƒ½è‰¯å¥½
-- - å¤§æ•°ç»„ï¼šè€ƒè™‘ä½¿ç”¨JSONBæˆ–å•ç‹¬çš„è¡¨
```

#### 4.2.3 å‡½æ•°å¼æ•°æ®å¤„ç†æ¨¡å¼

**Map-Reduceæ¨¡å¼**ï¼š

è™½ç„¶PostgreSQLä¸ç›´æ¥æ”¯æŒMap-Reduceï¼Œä½†å¯ä»¥é€šè¿‡SQLå®ç°ç±»ä¼¼æ¨¡å¼ï¼š

```sql
-- Mapé˜¶æ®µï¼šè½¬æ¢æ•°æ®
-- Reduceé˜¶æ®µï¼šèšåˆæ•°æ®

-- ç¤ºä¾‹ï¼šè®¡ç®—æ¯ä¸ªå®¢æˆ·çš„è®¢å•ç»Ÿè®¡ï¼ˆMap-Reduceæ¨¡å¼ï¼‰
WITH mapped_data AS (
    -- Mapé˜¶æ®µï¼šè½¬æ¢æ¯ä¸ªè®¢å•
    SELECT
        customer_id,
        order_amount,
        CASE
            WHEN order_amount > 1000 THEN 'high'
            WHEN order_amount > 100 THEN 'medium'
            ELSE 'low'
        END AS order_category
    FROM orders
    WHERE order_date >= '2024-01-01'
),
reduced_data AS (
    -- Reduceé˜¶æ®µï¼šèšåˆæ•°æ®
    SELECT
        customer_id,
        COUNT(*) as total_orders,
        SUM(order_amount) as total_amount,
        COUNT(*) FILTER (WHERE order_category = 'high') as high_value_orders
    FROM mapped_data
    GROUP BY customer_id
)
SELECT * FROM reduced_data
ORDER BY total_amount DESC;
```

### 4.3 é€’å½’æŸ¥è¯¢

#### 4.3.1 é€’å½’æŸ¥è¯¢çš„åŸç†

**ä¸ºä»€ä¹ˆéœ€è¦é€’å½’æŸ¥è¯¢**ï¼š

è®¸å¤šä¸šåŠ¡åœºæ™¯æ¶‰åŠå±‚æ¬¡ç»“æ„æ•°æ®ï¼Œå¦‚ï¼š

- ç»„ç»‡æ¶æ„ï¼ˆéƒ¨é—¨-å­éƒ¨é—¨ï¼‰
- åˆ†ç±»æ ‘ï¼ˆç±»åˆ«-å­ç±»åˆ«ï¼‰
- è¯„è®ºæ ‘ï¼ˆè¯„è®º-å›å¤ï¼‰
- æ–‡ä»¶ç³»ç»Ÿï¼ˆç›®å½•-å­ç›®å½•ï¼‰

ä½¿ç”¨é€’å½’æŸ¥è¯¢å¯ä»¥ä¼˜é›…åœ°å¤„ç†è¿™äº›å±‚æ¬¡ç»“æ„ï¼Œé¿å…åœ¨åº”ç”¨å±‚è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢ã€‚

**é€’å½’CTEçš„å·¥ä½œåŸç†**ï¼š

é€’å½’CTEï¼ˆCommon Table Expressionï¼‰ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

1. **åŸºç¡€æŸ¥è¯¢ï¼ˆBase Caseï¼‰**ï¼šå®šä¹‰é€’å½’çš„èµ·ç‚¹
2. **é€’å½’æŸ¥è¯¢ï¼ˆRecursive Caseï¼‰**ï¼šå®šä¹‰å¦‚ä½•ä»å½“å‰ç»“æœç”Ÿæˆä¸‹ä¸€å±‚ç»“æœ

PostgreSQLä¼šé‡å¤æ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼Œç›´åˆ°ä¸å†äº§ç”Ÿæ–°è¡Œã€‚

**é€’å½’æŸ¥è¯¢çš„æ‰§è¡Œè¿‡ç¨‹**ï¼š

```text
è¿­ä»£1ï¼šæ‰§è¡ŒåŸºç¡€æŸ¥è¯¢ï¼Œå¾—åˆ°åˆå§‹ç»“æœé›†
è¿­ä»£2ï¼šä½¿ç”¨è¿­ä»£1çš„ç»“æœæ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼Œå¾—åˆ°æ–°ç»“æœ
è¿­ä»£3ï¼šä½¿ç”¨è¿­ä»£2çš„ç»“æœæ‰§è¡Œé€’å½’æŸ¥è¯¢ï¼Œå¾—åˆ°æ–°ç»“æœ
...
è¿­ä»£Nï¼šé€’å½’æŸ¥è¯¢ä¸å†äº§ç”Ÿæ–°è¡Œï¼Œåœæ­¢
æœ€ç»ˆï¼šåˆå¹¶æ‰€æœ‰è¿­ä»£çš„ç»“æœ
```

#### 4.3.2 é€’å½’æŸ¥è¯¢åº”ç”¨ç¤ºä¾‹

**åœºæ™¯1ï¼šåˆ†ç±»æ ‘æŸ¥è¯¢**ï¼š

```sql
-- è¡¨ç»“æ„ï¼šåˆ†ç±»è¡¨ï¼ˆè‡ªå¼•ç”¨ï¼‰
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INTEGER REFERENCES categories(id),
    level INTEGER DEFAULT 0
);

-- é€’å½’æŸ¥è¯¢ï¼šè·å–æ‰€æœ‰å­åˆ†ç±»
WITH RECURSIVE category_tree AS (
    -- åŸºç¡€æƒ…å†µï¼šä»æ ¹åˆ†ç±»å¼€å§‹ï¼ˆparent_id IS NULLï¼‰
    SELECT
        id,
        name,
        parent_id,
        0 as level,
        ARRAY[id] as path,  -- è·¯å¾„ï¼šç”¨äºæ£€æµ‹å¾ªç¯
        name as full_path   -- å®Œæ•´è·¯å¾„ï¼šç”¨äºæ˜¾ç¤º
    FROM categories
    WHERE parent_id IS NULL  -- æˆ–è€… WHERE id = 1ï¼ˆä»ç‰¹å®šåˆ†ç±»å¼€å§‹ï¼‰

    UNION ALL

    -- é€’å½’æƒ…å†µï¼šæŸ¥æ‰¾å­åˆ†ç±»
    SELECT
        c.id,
        c.name,
        c.parent_id,
        ct.level + 1,
        ct.path || c.id,  -- æ·»åŠ å½“å‰IDåˆ°è·¯å¾„
        ct.full_path || ' > ' || c.name  -- æ„å»ºå®Œæ•´è·¯å¾„
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.id
    WHERE NOT (c.id = ANY(ct.path))  -- é˜²æ­¢å¾ªç¯å¼•ç”¨
)
SELECT
    id,
    name,
    level,
    full_path
FROM category_tree
ORDER BY path;  -- æŒ‰è·¯å¾„æ’åºï¼Œä¿æŒå±‚æ¬¡ç»“æ„

-- æ€§èƒ½åˆ†æï¼š
-- 1. æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œnä¸ºèŠ‚ç‚¹æ•°
-- 2. ç©ºé—´å¤æ‚åº¦ï¼šO(h)ï¼Œhä¸ºæ ‘çš„é«˜åº¦
-- 3. ä¼˜åŒ–å»ºè®®ï¼š
--    - ä¸ºparent_idåˆ›å»ºç´¢å¼•
--    - é™åˆ¶é€’å½’æ·±åº¦ï¼ˆä½¿ç”¨level < MAX_DEPTHï¼‰
--    - ä½¿ç”¨ç‰©åŒ–è·¯å¾„ï¼ˆMaterialized Pathï¼‰æ¨¡å¼æå‡æ€§èƒ½
```

**åœºæ™¯2ï¼šç»„ç»‡æ¶æ„æŸ¥è¯¢**ï¼š

```sql
-- åœºæ™¯ï¼šæŸ¥æ‰¾æŸä¸ªå‘˜å·¥çš„æ‰€æœ‰ä¸‹å±ï¼ˆåŒ…æ‹¬é—´æ¥ä¸‹å±ï¼‰
-- éœ€æ±‚ï¼šç»™å®šå‘˜å·¥IDï¼Œè¿”å›æ‰€æœ‰ä¸‹å±å‘˜å·¥

WITH RECURSIVE employee_hierarchy AS (
    -- åŸºç¡€æƒ…å†µï¼šèµ·å§‹å‘˜å·¥
    SELECT
        id,
        name,
        manager_id,
        0 as depth
    FROM employees
    WHERE id = 123  -- èµ·å§‹å‘˜å·¥ID

    UNION ALL

    -- é€’å½’æƒ…å†µï¼šæŸ¥æ‰¾ç›´æ¥ä¸‹å±
    SELECT
        e.id,
        e.name,
        e.manager_id,
        eh.depth + 1
    FROM employees e
    JOIN employee_hierarchy eh ON e.manager_id = eh.id
    WHERE eh.depth < 10  -- é™åˆ¶é€’å½’æ·±åº¦ï¼Œé˜²æ­¢æ— é™é€’å½’
)
SELECT
    id,
    name,
    depth,
    CASE
        WHEN depth = 0 THEN 'Manager'
        WHEN depth = 1 THEN 'Direct Report'
        ELSE 'Indirect Report'
    END AS relationship
FROM employee_hierarchy
ORDER BY depth, name;

-- åå‘æŸ¥è¯¢ï¼šæŸ¥æ‰¾æŸä¸ªå‘˜å·¥çš„æ‰€æœ‰ä¸Šçº§
WITH RECURSIVE manager_chain AS (
    -- åŸºç¡€æƒ…å†µï¼šèµ·å§‹å‘˜å·¥
    SELECT id, name, manager_id, 0 as level
    FROM employees
    WHERE id = 456

    UNION ALL

    -- é€’å½’æƒ…å†µï¼šæŸ¥æ‰¾ä¸Šçº§
    SELECT
        e.id,
        e.name,
        e.manager_id,
        mc.level + 1
    FROM employees e
    JOIN manager_chain mc ON e.id = mc.manager_id
)
SELECT * FROM manager_chain ORDER BY level;
```

**é€’å½’æŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–**ï¼š

| ä¼˜åŒ–ç­–ç•¥ | æ–¹æ³• | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **é™åˆ¶æ·±åº¦** | WHERE level < MAX_DEPTH | é˜²æ­¢æ— é™é€’å½’ | æ·±åº¦æœªçŸ¥çš„æ ‘ |
| **ç´¢å¼•ä¼˜åŒ–** | ä¸ºparent_idåˆ›å»ºç´¢å¼• | æå‡é€’å½’æŸ¥è¯¢æ€§èƒ½ | å¤§è¡¨ |
| **ç‰©åŒ–è·¯å¾„** | å­˜å‚¨å®Œæ•´è·¯å¾„å­—ç¬¦ä¸² | é¿å…é€’å½’æŸ¥è¯¢ | é¢‘ç¹æŸ¥è¯¢ |
| **é—­åŒ…è¡¨** | å­˜å‚¨æ‰€æœ‰ç¥–å…ˆ-åä»£å…³ç³» | æŸ¥è¯¢æœ€å¿« | è¯»å¤šå†™å°‘ |

**æœ€ä½³å®è·µ**ï¼š

1. **é˜²æ­¢æ— é™é€’å½’**ï¼šå§‹ç»ˆä½¿ç”¨å¾ªç¯æ£€æµ‹æˆ–æ·±åº¦é™åˆ¶
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºé€’å½’æŸ¥è¯¢ä¸­ä½¿ç”¨çš„è¿æ¥åˆ—åˆ›å»ºç´¢å¼•
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§é€’å½’æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ï¼Œå¿…è¦æ—¶ä¼˜åŒ–
4. **æ•°æ®æ¨¡å‹**ï¼šè€ƒè™‘ä½¿ç”¨ç‰©åŒ–è·¯å¾„æˆ–é—­åŒ…è¡¨æ¨¡å¼

---

## äº”ã€é¢å‘å¯¹è±¡ç¼–ç¨‹

### 5.1 ç±»å‹ç³»ç»Ÿ

PostgreSQLçš„ç±»å‹ç³»ç»Ÿæ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µã€‚

**è‡ªå®šä¹‰ç±»å‹**ï¼š

```sql
-- å®šä¹‰å¤åˆç±»å‹
CREATE TYPE address AS (
    street VARCHAR(100),
    city VARCHAR(50),
    zip_code VARCHAR(10)
);

-- ä½¿ç”¨ç±»å‹
CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    addr address
);

-- è®¿é—®ç±»å‹å­—æ®µ
SELECT name, (addr).city FROM customers;
```

### 5.2 ç»§æ‰¿æœºåˆ¶

PostgreSQLæ”¯æŒè¡¨ç»§æ‰¿ï¼Œå®ç°é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ¦‚å¿µã€‚

**è¡¨ç»§æ‰¿**ï¼š

```sql
-- çˆ¶è¡¨
CREATE TABLE vehicles (
    id SERIAL PRIMARY KEY,
    brand VARCHAR(50),
    model VARCHAR(50),
    year INTEGER
);

-- å­è¡¨ç»§æ‰¿
CREATE TABLE cars (
    doors INTEGER,
    fuel_type VARCHAR(20)
) INHERITS (vehicles);

CREATE TABLE trucks (
    load_capacity DECIMAL(10,2),
    axles INTEGER
) INHERITS (vehicles);

-- æŸ¥è¯¢çˆ¶è¡¨ä¼šåŒ…å«æ‰€æœ‰å­è¡¨æ•°æ®
SELECT * FROM vehicles;  -- åŒ…å«carså’Œtrucks
SELECT * FROM ONLY vehicles;  -- ä»…çˆ¶è¡¨
```

### 5.3 å¤šæ€æ”¯æŒ

é€šè¿‡å‡½æ•°é‡è½½å®ç°å¤šæ€ã€‚

**å‡½æ•°é‡è½½**ï¼š

```sql
-- å‡½æ•°é‡è½½ï¼šä¸åŒå‚æ•°ç±»å‹
CREATE FUNCTION calculate_area(radius DECIMAL) RETURNS DECIMAL AS $$
    SELECT 3.14159 * radius * radius;
$$ LANGUAGE SQL;

CREATE FUNCTION calculate_area(width DECIMAL, height DECIMAL) RETURNS DECIMAL AS $$
    SELECT width * height;
$$ LANGUAGE SQL;

-- æ ¹æ®å‚æ•°ç±»å‹è‡ªåŠ¨é€‰æ‹©
SELECT calculate_area(5);        -- è°ƒç”¨ç¬¬ä¸€ä¸ªå‡½æ•°
SELECT calculate_area(10, 20);   -- è°ƒç”¨ç¬¬äºŒä¸ªå‡½æ•°
```

---

## å…­ã€å“åº”å¼ç¼–ç¨‹

### 6.1 LISTEN/NOTIFYæœºåˆ¶

PostgreSQLçš„LISTEN/NOTIFYæœºåˆ¶æ”¯æŒå“åº”å¼ç¼–ç¨‹æ¨¡å¼ã€‚

**åŸºæœ¬ç”¨æ³•**ï¼š

```sql
-- ç›‘å¬è€…
LISTEN channel_name;

-- é€šçŸ¥è€…
NOTIFY channel_name, 'message payload';

-- åœ¨åº”ç”¨ä¸­å¤„ç†é€šçŸ¥
-- (éœ€è¦åœ¨åº”ç”¨å±‚å®ç°å¼‚æ­¥ç›‘å¬)
```

**å®é™…åº”ç”¨**ï¼š

```sql
-- è§¦å‘å™¨å‘é€é€šçŸ¥
CREATE OR REPLACE FUNCTION notify_order_created()
RETURNS TRIGGER AS $$
BEGIN
    PERFORM pg_notify('order_created',
        json_build_object(
            'order_id', NEW.id,
            'customer_id', NEW.customer_id,
            'amount', NEW.amount
        )::text
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_created_trigger
AFTER INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION notify_order_created();
```

### 6.2 é€»è¾‘å¤åˆ¶

é€»è¾‘å¤åˆ¶æ”¯æŒæ•°æ®å˜æ›´çš„å®æ—¶å“åº”ã€‚

**é€»è¾‘å¤åˆ¶é…ç½®**ï¼š

```sql
-- å‘å¸ƒç«¯
CREATE PUBLICATION my_publication FOR TABLE orders, customers;

-- è®¢é˜…ç«¯
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=source_host dbname=mydb'
PUBLICATION my_publication;
```

### 6.3 æµå¼å¤„ç†

ç»“åˆé€»è¾‘å¤åˆ¶å’Œæµå¼å¤„ç†æ¡†æ¶å®ç°å“åº”å¼æ•°æ®å¤„ç†ã€‚

**æµå¼å¤„ç†æ¶æ„**ï¼š

```text
PostgreSQL â†’ é€»è¾‘å¤åˆ¶ â†’ Kafka â†’ æµå¤„ç†å¼•æ“ â†’ ç›®æ ‡ç³»ç»Ÿ
```

---

## ä¸ƒã€äº‹ä»¶é©±åŠ¨ç¼–ç¨‹

### 7.1 è§¦å‘å™¨ç³»ç»Ÿ

è§¦å‘å™¨æ˜¯äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„æ ¸å¿ƒæœºåˆ¶ã€‚

**è§¦å‘å™¨ç±»å‹**ï¼š

```sql
-- BEFOREè§¦å‘å™¨ï¼šåœ¨æ“ä½œå‰æ‰§è¡Œ
CREATE TRIGGER validate_order
BEFORE INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION validate_order_data();

-- AFTERè§¦å‘å™¨ï¼šåœ¨æ“ä½œåæ‰§è¡Œ
CREATE TRIGGER audit_order_changes
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW
EXECUTE FUNCTION audit_order_changes();

-- INSTEAD OFè§¦å‘å™¨ï¼šæ›¿ä»£æ“ä½œï¼ˆç”¨äºè§†å›¾ï¼‰
CREATE TRIGGER update_view
INSTEAD OF UPDATE ON order_view
FOR EACH ROW
EXECUTE FUNCTION update_order_view();
```

### 7.2 äº‹ä»¶æµå¤„ç†

ä½¿ç”¨è§¦å‘å™¨æ„å»ºäº‹ä»¶æµã€‚

**äº‹ä»¶è¡¨è®¾è®¡**ï¼š

```sql
-- äº‹ä»¶è¡¨
CREATE TABLE domain_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_type VARCHAR(100) NOT NULL,
    aggregate_id UUID NOT NULL,
    event_data JSONB NOT NULL,
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº‹ä»¶å‘å¸ƒè§¦å‘å™¨
CREATE OR REPLACE FUNCTION publish_domain_event()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO domain_events (event_type, aggregate_id, event_data)
    VALUES (TG_ARGV[0], NEW.id, to_jsonb(NEW));
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 7.3 å˜æ›´æ•°æ®æ•è·

PostgreSQL 18çš„å˜æ›´æ•°æ®æ•è·åŠŸèƒ½å¢å¼ºã€‚

**CDCé…ç½®**ï¼š

```sql
-- å¯ç”¨é€»è¾‘å¤åˆ¶æ§½
SELECT pg_create_logical_replication_slot('my_slot', 'pgoutput');

-- è¯»å–å˜æ›´
SELECT * FROM pg_logical_slot_get_changes('my_slot', NULL, NULL);
```

---

## å…«ã€è®¾è®¡æ¨¡å¼

### 8.1 Repositoryæ¨¡å¼

Repositoryæ¨¡å¼å°è£…æ•°æ®è®¿é—®é€»è¾‘ã€‚

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- Repositoryå‡½æ•°
CREATE OR REPLACE FUNCTION find_customer_by_id(customer_id INTEGER)
RETURNS TABLE (
    id INTEGER,
    name VARCHAR,
    email VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    SELECT c.id, c.name, c.email
    FROM customers c
    WHERE c.id = customer_id;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨
SELECT * FROM find_customer_by_id(123);
```

### 8.2 Unit of Workæ¨¡å¼

ä½¿ç”¨äº‹åŠ¡å—å®ç°Unit of Workæ¨¡å¼ã€‚

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- Unit of Workï¼šäº‹åŠ¡å—
BEGIN;
    -- å¤šä¸ªæ“ä½œä½œä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒ
    INSERT INTO orders (customer_id, amount) VALUES (1, 100);
    UPDATE customers SET total_orders = total_orders + 1 WHERE id = 1;
    INSERT INTO order_items (order_id, product_id, quantity) VALUES (currval('orders_id_seq'), 10, 2);
COMMIT;  -- å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
```

### 8.3 Factoryæ¨¡å¼

ä½¿ç”¨å‡½æ•°å®ç°Factoryæ¨¡å¼ã€‚

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- Factoryå‡½æ•°ï¼šæ ¹æ®ç±»å‹åˆ›å»ºä¸åŒå¯¹è±¡
CREATE OR REPLACE FUNCTION create_vehicle(
    v_type VARCHAR,
    brand VARCHAR,
    model VARCHAR
) RETURNS INTEGER AS $$
DECLARE
    v_id INTEGER;
BEGIN
    IF v_type = 'car' THEN
        INSERT INTO cars (brand, model) VALUES (brand, model) RETURNING id INTO v_id;
    ELSIF v_type = 'truck' THEN
        INSERT INTO trucks (brand, model) VALUES (brand, model) RETURNING id INTO v_id;
    ELSE
        RAISE EXCEPTION 'Unknown vehicle type: %', v_type;
    END IF;
    RETURN v_id;
END;
$$ LANGUAGE plpgsql;
```

### 8.4 Strategyæ¨¡å¼

ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå®ç°Strategyæ¨¡å¼ã€‚

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- ä¸åŒçš„è®¡ç®—ç­–ç•¥
CREATE OR REPLACE FUNCTION calculate_discount_standard(amount DECIMAL)
RETURNS DECIMAL AS $$ SELECT amount * 0.1; $$ LANGUAGE SQL;

CREATE OR REPLACE FUNCTION calculate_discount_premium(amount DECIMAL)
RETURNS DECIMAL AS $$ SELECT amount * 0.2; $$ LANGUAGE SQL;

-- æ ¹æ®å®¢æˆ·ç±»å‹é€‰æ‹©ç­–ç•¥
CREATE OR REPLACE FUNCTION calculate_order_total(
    customer_id INTEGER,
    amount DECIMAL
) RETURNS DECIMAL AS $$
DECLARE
    discount_func TEXT;
    discount DECIMAL;
BEGIN
    SELECT
        CASE customer_type
            WHEN 'premium' THEN 'calculate_discount_premium'
            ELSE 'calculate_discount_standard'
        END
    INTO discount_func
    FROM customers
    WHERE id = customer_id;

    EXECUTE format('SELECT %s($1)', discount_func) USING amount INTO discount;
    RETURN amount - discount;
END;
$$ LANGUAGE plpgsql;
```

---

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 èŒƒå¼é€‰æ‹©åŸåˆ™

**é€‰æ‹©æŒ‡å—**ï¼š

- **æ•°æ®æŸ¥è¯¢** â†’ å£°æ˜å¼ç¼–ç¨‹ï¼ˆSQLï¼‰
- **å¤æ‚è®¡ç®—** â†’ å‡½æ•°å¼ç¼–ç¨‹ï¼ˆPL/pgSQLå‡½æ•°ï¼‰
- **æ•°æ®æ¨¡å‹** â†’ é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆç±»å‹ã€ç»§æ‰¿ï¼‰
- **å®æ—¶å¤„ç†** â†’ å“åº”å¼ç¼–ç¨‹ï¼ˆLISTEN/NOTIFYã€é€»è¾‘å¤åˆ¶ï¼‰
- **ä¸šåŠ¡é€»è¾‘** â†’ äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆè§¦å‘å™¨ï¼‰

### 9.2 æ€§èƒ½è€ƒè™‘

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

- ä¼˜å…ˆä½¿ç”¨å£°æ˜å¼SQLï¼Œè®©ä¼˜åŒ–å™¨å¤„ç†
- å‡½æ•°å¼ç¼–ç¨‹ä½¿ç”¨IMMUTABLEæ ‡è®°çº¯å‡½æ•°
- é¿å…è¿‡åº¦ä½¿ç”¨è§¦å‘å™¨ï¼Œè€ƒè™‘æ‰¹é‡å¤„ç†
- å“åº”å¼ç¼–ç¨‹æ³¨æ„æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡

### 9.3 å¯ç»´æŠ¤æ€§

**ä»£ç ç»„ç»‡å»ºè®®**ï¼š

- ä½¿ç”¨Schemaç»„ç»‡ç›¸å…³åŠŸèƒ½
- å‡½æ•°å‘½åæ¸…æ™°ï¼Œéµå¾ªå‘½åè§„èŒƒ
- æ·»åŠ æ³¨é‡Šè¯´æ˜å¤æ‚é€»è¾‘
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†æ•°æ®åº“å˜æ›´

---

## åã€ç›¸å…³æ–‡æ¡£

- [APIä½¿ç”¨æŒ‡å—](./01.02-APIä½¿ç”¨æŒ‡å—.md)
- [ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ](./01.03-ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ.md)
- [æ€§èƒ½ç¼–ç¨‹æŠ€å·§](./01.05-æ€§èƒ½ç¼–ç¨‹æŠ€å·§.md)
- [PostgreSQL 18æ–°ç‰¹æ€§](../../02-ç‰ˆæœ¬ç‰¹æ€§/02.01-PostgreSQL-18-æ–°ç‰¹æ€§.md)
- [æ ¸å¿ƒè¯¾ç¨‹](../../01-æ ¸å¿ƒè¯¾ç¨‹/)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
