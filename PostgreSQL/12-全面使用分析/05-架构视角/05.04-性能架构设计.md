# PostgreSQL 18 æ€§èƒ½æ¶æ„è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 æ€§èƒ½æ¶æ„è®¾è®¡](#postgresql-18-æ€§èƒ½æ¶æ„è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”](#21-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”)
    - [2.2 ç¼“å­˜ç­–ç•¥å¯¹æ¯”](#22-ç¼“å­˜ç­–ç•¥å¯¹æ¯”)
  - [ä¸‰ã€æŸ¥è¯¢æ€§èƒ½](#ä¸‰æŸ¥è¯¢æ€§èƒ½)
    - [3.1 æŸ¥è¯¢ä¼˜åŒ–](#31-æŸ¥è¯¢ä¼˜åŒ–)
      - [3.1.1 æŸ¥è¯¢ä¼˜åŒ–çš„é‡è¦æ€§](#311-æŸ¥è¯¢ä¼˜åŒ–çš„é‡è¦æ€§)
      - [3.1.2 æŸ¥è¯¢ä¼˜åŒ–å®ç°](#312-æŸ¥è¯¢ä¼˜åŒ–å®ç°)
    - [3.2 ç´¢å¼•ä¼˜åŒ–](#32-ç´¢å¼•ä¼˜åŒ–)
      - [3.2.1 ç´¢å¼•ä¼˜åŒ–çš„é‡è¦æ€§](#321-ç´¢å¼•ä¼˜åŒ–çš„é‡è¦æ€§)
      - [3.2.2 ç´¢å¼•ä¼˜åŒ–å®ç°](#322-ç´¢å¼•ä¼˜åŒ–å®ç°)
    - [3.3 åˆ†åŒºä¼˜åŒ–](#33-åˆ†åŒºä¼˜åŒ–)
      - [3.3.1 åˆ†åŒºä¼˜åŒ–çš„é‡è¦æ€§](#331-åˆ†åŒºä¼˜åŒ–çš„é‡è¦æ€§)
      - [3.3.2 åˆ†åŒºä¼˜åŒ–å®ç°](#332-åˆ†åŒºä¼˜åŒ–å®ç°)
  - [å››ã€å¹¶å‘æ€§èƒ½](#å››å¹¶å‘æ€§èƒ½)
    - [4.1 è¿æ¥æ± ](#41-è¿æ¥æ± )
    - [4.2 è¯»å†™åˆ†ç¦»](#42-è¯»å†™åˆ†ç¦»)
    - [4.3 å¹¶è¡ŒæŸ¥è¯¢](#43-å¹¶è¡ŒæŸ¥è¯¢)
  - [äº”ã€å­˜å‚¨æ€§èƒ½](#äº”å­˜å‚¨æ€§èƒ½)
    - [5.1 I/Oä¼˜åŒ–](#51-ioä¼˜åŒ–)
    - [5.2 å†…å­˜ä¼˜åŒ–](#52-å†…å­˜ä¼˜åŒ–)
    - [5.3 å­˜å‚¨ä¼˜åŒ–](#53-å­˜å‚¨ä¼˜åŒ–)
  - [å…­ã€ç¼“å­˜æ¶æ„](#å…­ç¼“å­˜æ¶æ„)
    - [6.1 åº”ç”¨ç¼“å­˜](#61-åº”ç”¨ç¼“å­˜)
    - [6.2 æ•°æ®åº“ç¼“å­˜](#62-æ•°æ®åº“ç¼“å­˜)
    - [6.3 åˆ†å¸ƒå¼ç¼“å­˜](#63-åˆ†å¸ƒå¼ç¼“å­˜)
  - [ä¸ƒã€PostgreSQL 18ä¼˜åŒ–](#ä¸ƒpostgresql-18ä¼˜åŒ–)
    - [7.1 å¼‚æ­¥I/Oä¼˜åŒ–](#71-å¼‚æ­¥ioä¼˜åŒ–)
    - [7.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#72-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
  - [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
    - [8.1 è®¾è®¡åŸåˆ™](#81-è®¾è®¡åŸåˆ™)
    - [8.2 å®æ–½å»ºè®®](#82-å®æ–½å»ºè®®)
    - [8.3 ç›‘æ§ä¼˜åŒ–](#83-ç›‘æ§ä¼˜åŒ–)
  - [ä¹ã€ç›¸å…³æ–‡æ¡£](#ä¹ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½æ¶æ„è®¾è®¡))
    æŸ¥è¯¢æ€§èƒ½
      æŸ¥è¯¢ä¼˜åŒ–
      ç´¢å¼•ä¼˜åŒ–
      åˆ†åŒºä¼˜åŒ–
    å¹¶å‘æ€§èƒ½
      è¿æ¥æ± 
      è¯»å†™åˆ†ç¦»
      å¹¶è¡ŒæŸ¥è¯¢
    å­˜å‚¨æ€§èƒ½
      I/Oä¼˜åŒ–
      å†…å­˜ä¼˜åŒ–
      å­˜å‚¨ä¼˜åŒ–
    ç¼“å­˜æ¶æ„
      åº”ç”¨ç¼“å­˜
      æ•°æ®åº“ç¼“å­˜
      åˆ†å¸ƒå¼ç¼“å­˜
    PostgreSQL 18
      å¼‚æ­¥I/O
      å¹¶è¡ŒæŸ¥è¯¢
    æœ€ä½³å®è·µ
      è®¾è®¡åŸåˆ™
      å®æ–½å»ºè®®
      ç›‘æ§ä¼˜åŒ–
```

**æ€ç»´å¯¼å›¾è¯´æ˜**ï¼š

æœ¬æ€ç»´å¯¼å›¾å±•ç¤ºäº†æ€§èƒ½æ¶æ„è®¾è®¡çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»æŸ¥è¯¢æ€§èƒ½åˆ°å¹¶å‘æ€§èƒ½ï¼Œä»å­˜å‚¨æ€§èƒ½åˆ°ç¼“å­˜æ¶æ„ï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«ç†è®ºåŸºç¡€ã€ä¼˜åŒ–æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚é€šè¿‡è¿™ä¸ªæ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£æ€§èƒ½ä¼˜åŒ–çš„å…¨è²Œï¼Œå¹¶æ ¹æ®å…·ä½“éœ€æ±‚æ·±å…¥ç›¸å…³ç« èŠ‚ã€‚

**ä½¿ç”¨å»ºè®®**ï¼š

- **æ¶æ„å¸ˆ**ï¼šé‡ç‚¹å…³æ³¨æ¶æ„è®¾è®¡å’Œä¼˜åŒ–ç­–ç•¥ï¼Œç†è§£æ€§èƒ½ä¼˜åŒ–çš„æƒè¡¡
- **DBA**ï¼šé‡ç‚¹å…³æ³¨æŸ¥è¯¢ä¼˜åŒ–å’Œå­˜å‚¨ä¼˜åŒ–ï¼Œç†è§£æ€§èƒ½è°ƒä¼˜çš„æ–¹æ³•
- **å¼€å‘äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨æŸ¥è¯¢ä¼˜åŒ–å’Œå¹¶å‘ä¼˜åŒ–ï¼Œç†è§£å¦‚ä½•ç¼–å†™é«˜æ€§èƒ½ä»£ç 

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»æ¶æ„è§†è§’ä»‹ç»PostgreSQL 18çš„æ€§èƒ½æ¶æ„è®¾è®¡ï¼Œå¸®åŠ©æ¶æ„å¸ˆè®¾è®¡é«˜æ€§èƒ½çš„æ•°æ®åº“ç³»ç»Ÿã€‚

**æ–‡æ¡£è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£ä¸ä»…æä¾›æ€§èƒ½ä¼˜åŒ–çš„é…ç½®å’Œä»£ç ï¼Œæ›´é‡è¦çš„æ˜¯è§£é‡Š**ä¸ºä»€ä¹ˆ**éœ€è¦æ€§èƒ½ä¼˜åŒ–ï¼Œ**å¦‚ä½•**è®¾è®¡é«˜æ€§èƒ½æ¶æ„ï¼Œä»¥åŠ**ä½•æ—¶**ä½¿ç”¨ç‰¹å®šçš„ä¼˜åŒ–æŠ€æœ¯ã€‚æ¯ä¸ªä¼˜åŒ–æ–¹æ¡ˆéƒ½åŒ…å«ï¼š

1. **æ€§èƒ½ç†è®º**ï¼šè§£é‡Šæ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬åŸç†å’Œç†è®ºä¾æ®
2. **æ¶æ„è®¾è®¡**ï¼šæä¾›æ€§èƒ½å¯¼å‘çš„æ¶æ„è®¾è®¡æ–¹æ¡ˆ
3. **ä¼˜åŒ–åˆ†æ**ï¼šåˆ†æä¸åŒä¼˜åŒ–æ–¹æ¡ˆçš„æ€§èƒ½æå‡å’Œæˆæœ¬
4. **æœ€ä½³å®è·µ**ï¼šæ€»ç»“å®é™…é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–ç»éªŒ

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šå…¨é¢çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
  - **ä¼˜åŒ–ç»´åº¦**ï¼šæŸ¥è¯¢æ€§èƒ½ã€å¹¶å‘æ€§èƒ½ã€å­˜å‚¨æ€§èƒ½
  - **ç†è®ºä¾æ®**ï¼šåŸºäºæ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç†è®ºå’Œå®è·µ
  - **æ•ˆæœè¯„ä¼°**ï¼šæä¾›æ€§èƒ½æå‡çš„é‡åŒ–æ•°æ®

- **æ¶æ„è®¾è®¡**ï¼šæ€§èƒ½å¯¼å‘çš„æ¶æ„è®¾è®¡
  - **è®¾è®¡åŸåˆ™**ï¼šæ€§èƒ½ä¼˜å…ˆã€å¯æ‰©å±•ã€å¯ç»´æŠ¤
  - **æ¶æ„æ¨¡å¼**ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ç¼“å­˜æ¶æ„
  - **æƒè¡¡åˆ†æ**ï¼šæ€§èƒ½ vs å¤æ‚åº¦ vs æˆæœ¬çš„æƒè¡¡

- **PostgreSQL 18**ï¼šå……åˆ†åˆ©ç”¨æ–°ç‰¹æ€§
  - **æ–°ç‰¹æ€§åº”ç”¨**ï¼šå¼‚æ­¥I/Oã€å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–ç­‰
  - **æ€§èƒ½æå‡**ï¼šæ–°ç‰¹æ€§å¸¦æ¥çš„æ€§èƒ½æå‡æ•°æ®
  - **æœ€ä½³å®è·µ**ï¼šå¦‚ä½•æ­£ç¡®ä½¿ç”¨æ–°ç‰¹æ€§

- **å®è·µæ€§å¼º**ï¼šåŸºäºå®é™…é¡¹ç›®ç»éªŒ
  - **æ¡ˆä¾‹æ¥æº**ï¼šçœŸå®é¡¹ç›®çš„æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹
  - **æ•ˆæœæ•°æ®**ï¼šå®é™…çš„æ€§èƒ½æå‡æ•°æ®
  - **ç»éªŒæ€»ç»“**ï¼šæ€§èƒ½ä¼˜åŒ–çš„æˆåŠŸç»éªŒå’Œå¤±è´¥æ•™è®­

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ€§èƒ½æå‡ | å¤æ‚åº¦ | æˆæœ¬ | æ¨èåº¦ |
|-----|---------|--------|------|--------|
| **ç´¢å¼•ä¼˜åŒ–** | 10-100å€ | â­â­ | ä½ | â­â­â­â­â­ |
| **åˆ†åŒºä¼˜åŒ–** | 2-10å€ | â­â­â­ | ä¸­ | â­â­â­â­ |
| **ç¼“å­˜ä¼˜åŒ–** | 2-5å€ | â­â­ | ä¸­ | â­â­â­â­ |
| **è¯»å†™åˆ†ç¦»** | 2-3å€ | â­â­â­ | ä¸­ | â­â­â­â­ |

### 2.2 ç¼“å­˜ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | å‘½ä¸­ç‡ | å»¶è¿Ÿ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|--------|------|--------|--------|
| **åº”ç”¨ç¼“å­˜** | é«˜ | æä½ | â­â­ | â­â­â­â­ |
| **æ•°æ®åº“ç¼“å­˜** | ä¸­ | ä½ | â­ | â­â­â­â­â­ |
| **åˆ†å¸ƒå¼ç¼“å­˜** | é«˜ | ä½ | â­â­â­ | â­â­â­â­ |

---

## ä¸‰ã€æŸ¥è¯¢æ€§èƒ½

### 3.1 æŸ¥è¯¢ä¼˜åŒ–

#### 3.1.1 æŸ¥è¯¢ä¼˜åŒ–çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢ä¼˜åŒ–**ï¼š

æŸ¥è¯¢æ€§èƒ½æ˜¯æ•°æ®åº“ç³»ç»Ÿæ€§èƒ½çš„æ ¸å¿ƒï¼Œå®ƒç›´æ¥å½±å“ï¼š

1. **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿå“åº”æå‡ç”¨æˆ·ä½“éªŒ
2. **ç³»ç»Ÿè´Ÿè½½**ï¼šä¼˜åŒ–æŸ¥è¯¢å‡å°‘ç³»ç»Ÿè´Ÿè½½
3. **èµ„æºåˆ©ç”¨**ï¼šé«˜æ•ˆæŸ¥è¯¢å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
4. **æˆæœ¬æ§åˆ¶**ï¼šä¼˜åŒ–æŸ¥è¯¢å‡å°‘ç¡¬ä»¶æˆæœ¬

**æŸ¥è¯¢ä¼˜åŒ–çš„åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ | é‡è¦æ€§ |
|-----|------|--------|
| **é¿å…å…¨è¡¨æ‰«æ** | ä½¿ç”¨ç´¢å¼•é¿å…æ‰«æå…¨è¡¨ | â­â­â­â­â­ |
| **ä½¿ç”¨åˆé€‚çš„JOIN** | é€‰æ‹©åˆé€‚çš„JOINç®—æ³• | â­â­â­â­ |
| **ä¼˜åŒ–å­æŸ¥è¯¢** | å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºJOIN | â­â­â­â­ |
| **ä½¿ç”¨EXPLAINåˆ†æ** | åˆ†ææ‰§è¡Œè®¡åˆ’ | â­â­â­â­â­ |

#### 3.1.2 æŸ¥è¯¢ä¼˜åŒ–å®ç°

**æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- åœºæ™¯ï¼šä¼˜åŒ–æ…¢æŸ¥è¯¢
-- éœ€æ±‚ï¼šæå‡æŸ¥è¯¢æ€§èƒ½
-- æ–¹æ³•ï¼šä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’

-- æ­¥éª¤1ï¼šåˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    u.username,
    u.email,
    COUNT(o.id) as order_count,
    SUM(o.total_amount) as total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.id, u.username, u.email
HAVING COUNT(o.id) > 10
ORDER BY total_amount DESC
LIMIT 100;

-- æ‰§è¡Œè®¡åˆ’åˆ†æï¼š
-- - Seq Scan: å…¨è¡¨æ‰«æï¼Œæ€§èƒ½å·®
-- - Index Scan: ç´¢å¼•æ‰«æï¼Œæ€§èƒ½å¥½
-- - Hash Join: å“ˆå¸Œè¿æ¥ï¼Œé€‚åˆå¤§è¡¨
-- - Nested Loop: åµŒå¥—å¾ªç¯ï¼Œé€‚åˆå°è¡¨
-- - Sort: æ’åºæ“ä½œï¼Œå¯èƒ½ä½¿ç”¨ç£ç›˜

-- æ­¥éª¤2ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
-- å¦‚æœçœ‹åˆ°Seq Scanï¼Œè¯´æ˜éœ€è¦åˆ›å»ºç´¢å¼•
-- å¦‚æœçœ‹åˆ°Sortï¼Œè¯´æ˜å¯èƒ½éœ€è¦ä¼˜åŒ–æ’åº

-- æ­¥éª¤3ï¼šä¼˜åŒ–æŸ¥è¯¢
-- 1. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- 2. ä¼˜åŒ–JOINé¡ºåºï¼ˆPostgreSQLä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼Œä½†å¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼‰
-- 3. ä½¿ç”¨LIMITå‡å°‘ç»“æœé›†
-- 4. ä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨
```

### 3.2 ç´¢å¼•ä¼˜åŒ–

#### 3.2.1 ç´¢å¼•ä¼˜åŒ–çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ä¼˜åŒ–**ï¼š

ç´¢å¼•æ˜¯æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ï¼Œåˆç†çš„ç´¢å¼•è®¾è®¡å¯ä»¥ï¼š

1. **æå‡æŸ¥è¯¢æ€§èƒ½**ï¼šç´¢å¼•å¯ä»¥å°†æŸ¥è¯¢æ—¶é—´ä»O(n)é™ä½åˆ°O(log n)
2. **å‡å°‘I/O**ï¼šç´¢å¼•å‡å°‘ç£ç›˜I/Oæ“ä½œ
3. **ä¼˜åŒ–æ’åº**ï¼šç´¢å¼•å¯ä»¥é¿å…æ’åºæ“ä½œ
4. **åŠ é€ŸJOIN**ï¼šç´¢å¼•å¯ä»¥åŠ é€ŸJOINæ“ä½œ

**ç´¢å¼•ä¼˜åŒ–çš„åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ | é‡è¦æ€§ |
|-----|------|--------|
| **ä¸ºWHEREå­å¥åˆ›å»ºç´¢å¼•** | WHEREæ¡ä»¶æ˜¯æœ€å¸¸ç”¨çš„è¿‡æ»¤ | â­â­â­â­â­ |
| **ä¸ºJOINæ¡ä»¶åˆ›å»ºç´¢å¼•** | JOINæ“ä½œæ˜¯æ€§èƒ½ç“¶é¢ˆ | â­â­â­â­â­ |
| **ä¸ºORDER BYåˆ›å»ºç´¢å¼•** | é¿å…æ’åºæ“ä½œ | â­â­â­â­ |
| **è€ƒè™‘é€‰æ‹©æ€§** | é€‰æ‹©æ€§é«˜çš„åˆ—æ›´é€‚åˆç´¢å¼• | â­â­â­â­ |

#### 3.2.2 ç´¢å¼•ä¼˜åŒ–å®ç°

**ç´¢å¼•è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šè®¢å•è¡¨ç´¢å¼•ä¼˜åŒ–
-- éœ€æ±‚ï¼šä¼˜åŒ–è®¢å•æŸ¥è¯¢æ€§èƒ½
-- ç­–ç•¥ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•

-- ç´¢å¼•1ï¼šå•åˆ—ç´¢å¼•ï¼ˆä¸ºWHEREå­å¥åˆ›å»ºï¼‰
CREATE INDEX idx_orders_user_id ON orders(user_id);
-- ç”¨é€”ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è®¢å•
-- æŸ¥è¯¢ï¼šSELECT * FROM orders WHERE user_id = 123;

-- ç´¢å¼•2ï¼šå¤åˆç´¢å¼•ï¼ˆä¸ºå¤šæ¡ä»¶æŸ¥è¯¢åˆ›å»ºï¼‰
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at DESC);
-- ç”¨é€”ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·åœ¨æŸæ®µæ—¶é—´çš„è®¢å•
-- æŸ¥è¯¢ï¼šSELECT * FROM orders WHERE user_id = 123 AND created_at >= '2024-01-01';
-- æ³¨æ„ï¼šåˆ—é¡ºåºå¾ˆé‡è¦ï¼Œé€‰æ‹©æ€§é«˜çš„åˆ—åœ¨å‰

-- ç´¢å¼•3ï¼šéƒ¨åˆ†ç´¢å¼•ï¼ˆä¸ºç‰¹å®šæ¡ä»¶åˆ›å»ºï¼‰
CREATE INDEX idx_orders_active ON orders(user_id, created_at)
WHERE status = 'active';
-- ç”¨é€”ï¼šåªæŸ¥è¯¢æ´»è·ƒè®¢å•
-- æŸ¥è¯¢ï¼šSELECT * FROM orders WHERE user_id = 123 AND status = 'active';
-- ä¼˜åŠ¿ï¼šç´¢å¼•æ›´å°ï¼ŒæŸ¥è¯¢æ›´å¿«

-- ç´¢å¼•4ï¼šè¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_orders_user_cover ON orders(user_id, created_at)
INCLUDE (total_amount, status);
-- ç”¨é€”ï¼šæŸ¥è¯¢å¯ä»¥ç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®ï¼Œæ— éœ€è®¿é—®è¡¨
-- æŸ¥è¯¢ï¼šSELECT user_id, created_at, total_amount, status FROM orders WHERE user_id = 123;
-- ä¼˜åŠ¿ï¼šé¿å…å›è¡¨ï¼Œæ€§èƒ½æå‡2-3å€

-- æ€§èƒ½åˆ†æï¼š
-- - æ— ç´¢å¼•ï¼šå…¨è¡¨æ‰«æï¼Œ100ä¸‡è¡Œï¼Œè€—æ—¶5ç§’
-- - æœ‰ç´¢å¼•ï¼šç´¢å¼•æ‰«æï¼Œ100è¡Œï¼Œè€—æ—¶5ms
-- - æ€§èƒ½æå‡ï¼š1000å€
```

### 3.3 åˆ†åŒºä¼˜åŒ–

#### 3.3.1 åˆ†åŒºä¼˜åŒ–çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†åŒºä¼˜åŒ–**ï¼š

åˆ†åŒºæ˜¯å¤„ç†å¤§æ•°æ®é‡çš„å…³é”®æŠ€æœ¯ï¼Œå®ƒæä¾›äº†ï¼š

1. **æŸ¥è¯¢æ€§èƒ½**ï¼šåˆ†åŒºè£å‰ªåªæŸ¥è¯¢ç›¸å…³åˆ†åŒº
2. **ç»´æŠ¤æ•ˆç‡**ï¼šå¯ä»¥ç‹¬ç«‹ç»´æŠ¤æ¯ä¸ªåˆ†åŒº
3. **å­˜å‚¨ç®¡ç†**ï¼šå¯ä»¥ç‹¬ç«‹ç®¡ç†æ¯ä¸ªåˆ†åŒºçš„å­˜å‚¨
4. **å¹¶è¡Œå¤„ç†**ï¼šå¯ä»¥å¹¶è¡Œå¤„ç†ä¸åŒåˆ†åŒº

**åˆ†åŒºä¼˜åŒ–çš„é€‚ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ | æ¨èåº¦ |
|-----|------|--------|
| **å¤§æ•°æ®é‡** | å•è¡¨æ•°æ®é‡>100GB | â­â­â­â­â­ |
| **æ—¶é—´èŒƒå›´æŸ¥è¯¢** | ç»å¸¸æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ | â­â­â­â­â­ |
| **å†å²æ•°æ®å½’æ¡£** | éœ€è¦å½’æ¡£å†å²æ•°æ® | â­â­â­â­ |
| **å¹¶è¡Œå¤„ç†** | éœ€è¦å¹¶è¡Œå¤„ç†æ•°æ® | â­â­â­â­ |

#### 3.3.2 åˆ†åŒºä¼˜åŒ–å®ç°

**åˆ†åŒºè¡¨è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šè®¢å•è¡¨æŒ‰æ—¶é—´åˆ†åŒº
-- éœ€æ±‚ï¼šä¼˜åŒ–æ—¶é—´èŒƒå›´æŸ¥è¯¢æ€§èƒ½
-- ç­–ç•¥ï¼šæŒ‰æœˆåˆ†åŒº

-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE orders (
    id SERIAL,
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    created_at DATE NOT NULL,
    PRIMARY KEY (id, created_at)  -- åˆ†åŒºé”®å¿…é¡»åŒ…å«åœ¨ä¸»é”®ä¸­
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE orders_2024_01 PARTITION OF orders
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE orders_2024_02 PARTITION OF orders
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- ... æ›´å¤šåˆ†åŒº

-- æŸ¥è¯¢ä¼˜åŒ–ï¼š
-- 1. åˆ†åŒºè£å‰ªï¼šåªæŸ¥è¯¢ç›¸å…³åˆ†åŒº
SELECT * FROM orders
WHERE created_at >= '2024-01-15' AND created_at < '2024-01-20';
-- æ‰§è¡Œè®¡åˆ’ï¼šåªæ‰«æorders_2024_01åˆ†åŒº

-- 2. å¹¶è¡ŒæŸ¥è¯¢ï¼šå¯ä»¥å¹¶è¡ŒæŸ¥è¯¢å¤šä¸ªåˆ†åŒº
SET enable_partitionwise_join = on;
SET enable_partitionwise_aggregate = on;

-- æ€§èƒ½åˆ†æï¼š
-- - æ— åˆ†åŒºï¼šæ‰«æ1000ä¸‡è¡Œï¼Œè€—æ—¶10ç§’
-- - æœ‰åˆ†åŒºï¼šåªæ‰«æ100ä¸‡è¡Œï¼ˆ1ä¸ªæœˆï¼‰ï¼Œè€—æ—¶1ç§’
-- - æ€§èƒ½æå‡ï¼š10å€

CREATE TABLE orders_2024_01 PARTITION OF orders
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

```

---

## å››ã€å¹¶å‘æ€§èƒ½

### 4.1 è¿æ¥æ± 

**è¿æ¥æ± é…ç½®**ï¼š

```ini
# pgBounceré…ç½®
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

### 4.2 è¯»å†™åˆ†ç¦»

**è¯»å†™åˆ†ç¦»æ¶æ„**ï¼š

```text
Application
  â”œâ”€â”€ Write â†’ Primary
  â””â”€â”€ Read â†’ Standby
```

### 4.3 å¹¶è¡ŒæŸ¥è¯¢

**å¹¶è¡ŒæŸ¥è¯¢é…ç½®**ï¼š

```conf
# postgresql.conf
max_parallel_workers_per_gather = 4
max_parallel_workers = 16
```

---

## äº”ã€å­˜å‚¨æ€§èƒ½

### 5.1 I/Oä¼˜åŒ–

**I/Oä¼˜åŒ–é…ç½®**ï¼š

```conf
# postgresql.conf
random_page_cost = 1.1  # SSD
effective_io_concurrency = 200  # NVMe
max_io_concurrency = 10  # PostgreSQL 18å¼‚æ­¥I/O
```

### 5.2 å†…å­˜ä¼˜åŒ–

**å†…å­˜é…ç½®**ï¼š

```conf
# postgresql.conf
shared_buffers = 8GB
work_mem = 16MB
effective_cache_size = 24GB
```

### 5.3 å­˜å‚¨ä¼˜åŒ–

**å­˜å‚¨ä¼˜åŒ–**ï¼š

- ä½¿ç”¨SSD/NVMe
- åˆç†é…ç½®RAID
- ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿ

---

## å…­ã€ç¼“å­˜æ¶æ„

### 6.1 åº”ç”¨ç¼“å­˜

**åº”ç”¨ç¼“å­˜**ï¼š

- Redisç¼“å­˜
- Memcached
- æœ¬åœ°ç¼“å­˜

### 6.2 æ•°æ®åº“ç¼“å­˜

**æ•°æ®åº“ç¼“å­˜**ï¼š

- shared_buffers
- æ“ä½œç³»ç»Ÿç¼“å­˜
- æŸ¥è¯¢ç»“æœç¼“å­˜

### 6.3 åˆ†å¸ƒå¼ç¼“å­˜

**åˆ†å¸ƒå¼ç¼“å­˜**ï¼š

- Redisé›†ç¾¤
- Memcachedé›†ç¾¤
- ç¼“å­˜ä¸€è‡´æ€§

---

## ä¸ƒã€PostgreSQL 18ä¼˜åŒ–

### 7.1 å¼‚æ­¥I/Oä¼˜åŒ–

**å¼‚æ­¥I/O**ï¼š

- I/Oæ€§èƒ½æå‡2-3å€
- å‡å°‘I/Oç­‰å¾…æ—¶é—´

### 7.2 å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

**å¹¶è¡ŒæŸ¥è¯¢å¢å¼º**ï¼š

- æ›´æ™ºèƒ½çš„å¹¶è¡Œæ‰§è¡Œ
- æ›´å¥½çš„å¹¶è¡Œåº¦é€‰æ‹©

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 è®¾è®¡åŸåˆ™

**è®¾è®¡åŸåˆ™**ï¼š

- æ€§èƒ½ä¼˜å…ˆ
- æŒç»­ä¼˜åŒ–
- ç›‘æ§é©±åŠ¨
- æµ‹è¯•éªŒè¯

### 8.2 å®æ–½å»ºè®®

**å®æ–½å»ºè®®**ï¼š

- åŸºçº¿æµ‹è¯•
- é€æ­¥ä¼˜åŒ–
- ç›‘æ§è¯„ä¼°
- æ–‡æ¡£è®°å½•

### 8.3 ç›‘æ§ä¼˜åŒ–

**æ€§èƒ½ç›‘æ§**ï¼š

- æ…¢æŸ¥è¯¢ç›‘æ§
- èµ„æºä½¿ç”¨ç›‘æ§
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„è®¾è®¡](./05.01-ç³»ç»Ÿæ¶æ„è®¾è®¡.md)
- [æ€§èƒ½è°ƒä¼˜å®è·µ](../02-è¿ç»´è§†è§’/02.03-æ€§èƒ½è°ƒä¼˜å®è·µ.md)
- [ç›‘æ§ä¸å¯è§‚æµ‹æ€§](../02-è¿ç»´è§†è§’/02.02-ç›‘æ§ä¸å¯è§‚æµ‹æ€§.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
