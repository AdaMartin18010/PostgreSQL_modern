# PostgreSQL 18 å®¹é‡è§„åˆ’ä¸æ‰©å±•

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 å®¹é‡è§„åˆ’ä¸æ‰©å±•](#postgresql-18-å®¹é‡è§„åˆ’ä¸æ‰©å±•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 æ‰©å±•æ–¹æ¡ˆå¯¹æ¯”](#21-æ‰©å±•æ–¹æ¡ˆå¯¹æ¯”)
    - [2.2 å®¹é‡è¯„ä¼°æ–¹æ³•å¯¹æ¯”](#22-å®¹é‡è¯„ä¼°æ–¹æ³•å¯¹æ¯”)
  - [ä¸‰ã€å®¹é‡è§„åˆ’](#ä¸‰å®¹é‡è§„åˆ’)
    - [3.1 å­˜å‚¨å®¹é‡è§„åˆ’](#31-å­˜å‚¨å®¹é‡è§„åˆ’)
      - [3.1.1 å­˜å‚¨å®¹é‡è§„åˆ’çš„é‡è¦æ€§](#311-å­˜å‚¨å®¹é‡è§„åˆ’çš„é‡è¦æ€§)
      - [3.1.2 å­˜å‚¨å®¹é‡è®¡ç®—](#312-å­˜å‚¨å®¹é‡è®¡ç®—)
    - [3.2 è®¡ç®—èµ„æºè§„åˆ’](#32-è®¡ç®—èµ„æºè§„åˆ’)
    - [3.3 ç½‘ç»œå®¹é‡è§„åˆ’](#33-ç½‘ç»œå®¹é‡è§„åˆ’)
  - [å››ã€å‚ç›´æ‰©å±•](#å››å‚ç›´æ‰©å±•)
    - [4.1 ç¡¬ä»¶å‡çº§](#41-ç¡¬ä»¶å‡çº§)
    - [4.2 å‚æ•°è°ƒä¼˜](#42-å‚æ•°è°ƒä¼˜)
    - [4.3 æ€§èƒ½ä¼˜åŒ–](#43-æ€§èƒ½ä¼˜åŒ–)
  - [äº”ã€æ°´å¹³æ‰©å±•](#äº”æ°´å¹³æ‰©å±•)
    - [5.1 è¯»å†™åˆ†ç¦»](#51-è¯»å†™åˆ†ç¦»)
    - [5.2 åˆ†ç‰‡æ¶æ„](#52-åˆ†ç‰‡æ¶æ„)
    - [5.3 åˆ†å¸ƒå¼æ¶æ„](#53-åˆ†å¸ƒå¼æ¶æ„)
  - [å…­ã€æ‰©å±•ç­–ç•¥](#å…­æ‰©å±•ç­–ç•¥)
    - [6.1 æ‰©å±•æ—¶æœº](#61-æ‰©å±•æ—¶æœº)
    - [6.2 æ‰©å±•æ–¹æ¡ˆé€‰æ‹©](#62-æ‰©å±•æ–¹æ¡ˆé€‰æ‹©)
    - [6.3 æ‰©å±•å®æ–½](#63-æ‰©å±•å®æ–½)
  - [ä¸ƒã€å®¹é‡ç›‘æ§](#ä¸ƒå®¹é‡ç›‘æ§)
    - [7.1 å®¹é‡æŒ‡æ ‡](#71-å®¹é‡æŒ‡æ ‡)
    - [7.2 è¶‹åŠ¿åˆ†æ](#72-è¶‹åŠ¿åˆ†æ)
    - [7.3 å‘Šè­¦é…ç½®](#73-å‘Šè­¦é…ç½®)
  - [å…«ã€ç›¸å…³æ–‡æ¡£](#å…«ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å®¹é‡è§„åˆ’ä¸æ‰©å±•))
    å®¹é‡è§„åˆ’
      å­˜å‚¨å®¹é‡
        å®¹é‡è¯„ä¼°
        å®¹é‡é¢„æµ‹
        å®¹é‡ä¼˜åŒ–
      è®¡ç®—èµ„æº
        CPUè¯„ä¼°
        å†…å­˜è¯„ä¼°
        èµ„æºä¼˜åŒ–
      ç½‘ç»œå®¹é‡
        å¸¦å®½è¯„ä¼°
        ç½‘ç»œä¼˜åŒ–
        ç½‘ç»œç›‘æ§
    å‚ç›´æ‰©å±•
      ç¡¬ä»¶å‡çº§
        ç¡¬ä»¶é€‰æ‹©
        å‡çº§æµç¨‹
        æ€§èƒ½æå‡
      å‚æ•°è°ƒä¼˜
        å‚æ•°ä¼˜åŒ–
        æ€§èƒ½è°ƒä¼˜
        èµ„æºä¼˜åŒ–
      æ€§èƒ½ä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
        ç´¢å¼•ä¼˜åŒ–
        å­˜å‚¨ä¼˜åŒ–
    æ°´å¹³æ‰©å±•
      è¯»å†™åˆ†ç¦»
        è¯»å†™åˆ†ç¦»åŸç†
        é…ç½®æ–¹æ³•
        è´Ÿè½½å‡è¡¡
      åˆ†ç‰‡æ¶æ„
        åˆ†ç‰‡åŸç†
        åˆ†ç‰‡ç­–ç•¥
        åˆ†ç‰‡ç®¡ç†
      åˆ†å¸ƒå¼æ¶æ„
        åˆ†å¸ƒå¼åŸç†
        é…ç½®æ–¹æ³•
        æ•°æ®ä¸€è‡´æ€§
    æ‰©å±•ç­–ç•¥
      æ‰©å±•æ—¶æœº
        æ‰©å±•æŒ‡æ ‡
        æ‰©å±•è§¦å‘
        æ‰©å±•è¯„ä¼°
      æ–¹æ¡ˆé€‰æ‹©
        æ–¹æ¡ˆå¯¹æ¯”
        é€‰æ‹©åŸåˆ™
        å†³ç­–æµç¨‹
      æ‰©å±•å®æ–½
        å®æ–½è®¡åˆ’
        å®æ–½æ­¥éª¤
        æ•ˆæœéªŒè¯
    å®¹é‡ç›‘æ§
      å®¹é‡æŒ‡æ ‡
        å­˜å‚¨æŒ‡æ ‡
        è®¡ç®—æŒ‡æ ‡
        ç½‘ç»œæŒ‡æ ‡
      è¶‹åŠ¿åˆ†æ
        è¶‹åŠ¿é¢„æµ‹
        å®¹é‡é¢„æµ‹
        å‘Šè­¦é…ç½®
      å‘Šè­¦é…ç½®
        å‘Šè­¦è§„åˆ™
        å‘Šè­¦é€šçŸ¥
        å‘Šè­¦ä¼˜åŒ–
```

**æ€ç»´å¯¼å›¾è¯´æ˜**ï¼š

æœ¬æ€ç»´å¯¼å›¾å±•ç¤ºäº†å®¹é‡è§„åˆ’ä¸æ‰©å±•çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»å®¹é‡è§„åˆ’åˆ°æ‰©å±•ç­–ç•¥ï¼Œä»å‚ç›´æ‰©å±•åˆ°æ°´å¹³æ‰©å±•ï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«ç†è®ºåŸºç¡€ã€è§„åˆ’æ–¹æ³•å’Œå®è·µç»éªŒã€‚é€šè¿‡è¿™ä¸ªæ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£å®¹é‡è§„åˆ’ä¸æ‰©å±•çš„å…¨è²Œï¼Œå¹¶æ ¹æ®å…·ä½“éœ€æ±‚æ·±å…¥ç›¸å…³ç« èŠ‚ã€‚

**ä½¿ç”¨å»ºè®®**ï¼š

- **è¿ç»´äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨å®¹é‡ç›‘æ§å’Œæ‰©å±•å®æ–½ï¼Œç†è§£å¦‚ä½•ç›‘æ§å®¹é‡å’Œè¿›è¡Œæ‰©å±•
- **æ¶æ„å¸ˆ**ï¼šé‡ç‚¹å…³æ³¨æ‰©å±•ç­–ç•¥å’Œæ–¹æ¡ˆé€‰æ‹©ï¼Œç†è§£å¦‚ä½•é€‰æ‹©æœ€é€‚åˆçš„æ‰©å±•æ–¹æ¡ˆ
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šé‡ç‚¹å…³æ³¨å®¹é‡è§„åˆ’å’Œæˆæœ¬ä¼˜åŒ–ï¼Œç†è§£å¦‚ä½•åˆç†è§„åˆ’èµ„æº

---

## ä¸€ã€æ¦‚è¿°

**æ–‡æ¡£è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£ä¸ä»…å±•ç¤ºå®¹é‡è§„åˆ’çš„å…¬å¼å’Œæ‰©å±•çš„æ­¥éª¤ï¼Œæ›´é‡è¦çš„æ˜¯è§£é‡Š**ä¸ºä»€ä¹ˆ**éœ€è¦å®¹é‡è§„åˆ’ï¼Œ**å¦‚ä½•**è¿›è¡Œå®¹é‡è§„åˆ’å’Œæ‰©å±•ï¼Œä»¥åŠ**ä½•æ—¶**è¿›è¡Œæ‰©å±•ã€‚æ¯ä¸ªæ–¹æ¡ˆéƒ½åŒ…å«ï¼š

1. **è§„åˆ’ç†è®º**ï¼šè§£é‡Šå®¹é‡è§„åˆ’çš„åŸç†å’Œæ–¹æ³•
2. **æ‰©å±•æ–¹æ³•**ï¼šè¯´æ˜å¦‚ä½•è¿›è¡Œç³»ç»Ÿæ‰©å±•
3. **æˆæœ¬åˆ†æ**ï¼šåˆ†ææ‰©å±•æˆæœ¬å’Œæ€§èƒ½æå‡
4. **æœ€ä½³å®è·µ**ï¼šæä¾›å®è·µç»éªŒå’Œä¼˜åŒ–å»ºè®®

**å®¹é‡è§„åˆ’ä¸æ‰©å±•çš„é‡è¦æ€§**ï¼š

å®¹é‡è§„åˆ’ä¸æ‰©å±•æ˜¯ä¿è¯ç³»ç»Ÿå¯æ‰©å±•æ€§çš„å…³é”®ï¼Œå®ƒç›´æ¥å½±å“ï¼š

1. **ç³»ç»Ÿå¯æ‰©å±•æ€§**ï¼šåˆç†çš„å®¹é‡è§„åˆ’å¯ä»¥æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§
   - **ç†è®ºä¾æ®**ï¼šå®¹é‡è§„åˆ’å¯ä»¥æå‰é¢„æµ‹èµ„æºéœ€æ±‚
   - **å®è·µä»·å€¼**ï¼šæ”¯æŒä¸šåŠ¡å¢é•¿ï¼Œé€‚åº”æ•°æ®é‡å¢é•¿
   - **æ•ˆæœè¯„ä¼°**ï¼šç³»ç»Ÿå¯æ‰©å±•æ€§æå‡50-200%ï¼Œæ”¯æŒæ›´å¤§è§„æ¨¡

2. **ç³»ç»Ÿæ€§èƒ½**ï¼šåˆé€‚çš„æ‰©å±•å¯ä»¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
   - **ç†è®ºä¾æ®**ï¼šæ‰©å±•å¯ä»¥å¢åŠ ç³»ç»Ÿå¤„ç†èƒ½åŠ›
   - **å®è·µä»·å€¼**ï¼šæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œæ”¯æŒæ›´å¤šå¹¶å‘ç”¨æˆ·
   - **æ•ˆæœè¯„ä¼°**ï¼šç³»ç»Ÿæ€§èƒ½æå‡20-100%ï¼Œå¹¶å‘èƒ½åŠ›æå‡2-10å€

3. **ç³»ç»Ÿæˆæœ¬**ï¼šåˆç†çš„å®¹é‡è§„åˆ’å¯ä»¥ä¼˜åŒ–ç³»ç»Ÿæˆæœ¬
   - **ç†è®ºä¾æ®**ï¼šå®¹é‡è§„åˆ’å¯ä»¥é¿å…èµ„æºæµªè´¹
   - **å®è·µä»·å€¼**ï¼šé™ä½ç¡¬ä»¶æˆæœ¬ã€è¿ç»´æˆæœ¬
   - **æ•ˆæœè¯„ä¼°**ï¼šç³»ç»Ÿæˆæœ¬é™ä½20-40%ï¼Œèµ„æºåˆ©ç”¨ç‡æå‡30-60%

4. **ä¸šåŠ¡è¿ç»­æ€§**ï¼šåˆé€‚çš„æ‰©å±•å¯ä»¥ä¿è¯ä¸šåŠ¡è¿ç»­æ€§
   - **ç†è®ºä¾æ®**ï¼šæ‰©å±•å¯ä»¥é˜²æ­¢ç³»ç»Ÿå®¹é‡ç“¶é¢ˆ
   - **å®è·µä»·å€¼**ï¼šä¿è¯ä¸šåŠ¡æ­£å¸¸è¿è¡Œï¼Œæ”¯æŒä¸šåŠ¡å¢é•¿
   - **æ•ˆæœè¯„ä¼°**ï¼šä¸šåŠ¡è¿ç»­æ€§æå‡ï¼Œæ”¯æŒä¸šåŠ¡å¢é•¿

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **å‰ç»æ€§**ï¼šæå‰è§„åˆ’å®¹é‡éœ€æ±‚
  - **ç†è®ºä¾æ®**ï¼šå‰ç»æ€§è§„åˆ’å¯ä»¥é¿å…å®¹é‡ç“¶é¢ˆ
  - **å®è·µä»·å€¼**ï¼šæå‰å‡†å¤‡èµ„æºï¼Œé¿å…ç³»ç»Ÿå®¹é‡ä¸è¶³
  - **è§„åˆ’æ–¹æ³•**ï¼šå®¹é‡è¯„ä¼°ã€å®¹é‡é¢„æµ‹ã€å®¹é‡ä¼˜åŒ–

- **çµæ´»æ€§**ï¼šæ”¯æŒå‚ç›´å’Œæ°´å¹³æ‰©å±•
  - **ç†è®ºä¾æ®**ï¼šä¸åŒåœºæ™¯éœ€è¦ä¸åŒçš„æ‰©å±•æ–¹å¼
  - **å®è·µä»·å€¼**ï¼šæä¾›çµæ´»çš„æ‰©å±•æ–¹æ¡ˆï¼Œé€‚åº”ä¸åŒéœ€æ±‚
  - **æ‰©å±•æ–¹å¼**ï¼šå‚ç›´æ‰©å±•ã€æ°´å¹³æ‰©å±•ã€æ··åˆæ‰©å±•

- **å¯æ“ä½œæ€§**ï¼šæä¾›å…·ä½“çš„æ‰©å±•æ–¹æ¡ˆ
  - **ç†è®ºä¾æ®**ï¼šå…·ä½“çš„æ–¹æ¡ˆå¯ä»¥æé«˜æ‰©å±•æ•ˆç‡
  - **å®è·µä»·å€¼**ï¼šæä¾›å¯ç›´æ¥åº”ç”¨çš„æ‰©å±•æ–¹æ¡ˆ
  - **æ‰©å±•æ–¹æ¡ˆ**ï¼šç¡¬ä»¶å‡çº§ã€è¯»å†™åˆ†ç¦»ã€åˆ†ç‰‡æ¶æ„ã€åˆ†å¸ƒå¼æ¶æ„

- **æˆæœ¬ä¼˜åŒ–**ï¼šå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬
  - **ç†è®ºä¾æ®**ï¼šæˆæœ¬ä¼˜åŒ–å¯ä»¥æé«˜æŠ•èµ„å›æŠ¥ç‡
  - **å®è·µä»·å€¼**ï¼šåœ¨ä¿è¯æ€§èƒ½çš„å‰æä¸‹ä¼˜åŒ–æˆæœ¬
  - **ä¼˜åŒ–æ–¹æ³•**ï¼šèµ„æºä¼˜åŒ–ã€æˆæœ¬åˆ†æã€æŠ•èµ„å›æŠ¥ç‡åˆ†æ

æœ¬æ–‡æ¡£ä»‹ç»PostgreSQL 18çš„å®¹é‡è§„åˆ’ä¸æ‰©å±•ç­–ç•¥ï¼Œå¸®åŠ©è¿ç»´äººå‘˜åˆç†è§„åˆ’èµ„æºå¹¶å®ç°ç³»ç»Ÿæ‰©å±•ã€‚

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 æ‰©å±•æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ‰©å±•èƒ½åŠ› | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|-----|---------|--------|------|---------|--------|
| **å‚ç›´æ‰©å±•** | æœ‰é™ | â­â­ | ä¸­ | ä¸­å°è§„æ¨¡ | â­â­â­ |
| **è¯»å†™åˆ†ç¦»** | ä¸­ç­‰ | â­â­â­ | ä¸­ | è¯»å¤šå†™å°‘ | â­â­â­â­ |
| **åˆ†ç‰‡** | é«˜ | â­â­â­â­â­ | é«˜ | è¶…å¤§è§„æ¨¡ | â­â­â­â­ |
| **åˆ†å¸ƒå¼** | æé«˜ | â­â­â­â­â­ | é«˜ | è¶…å¤§è§„æ¨¡ | â­â­â­â­ |

### 2.2 å®¹é‡è¯„ä¼°æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | å‡†ç¡®æ€§ | å¤æ‚åº¦ | é€‚ç”¨é˜¶æ®µ | æ¨èåº¦ |
|-----|--------|--------|---------|--------|
| **å†å²è¶‹åŠ¿åˆ†æ** | â­â­â­â­ | â­â­ | æŒç»­ç›‘æ§ | â­â­â­â­â­ |
| **å‹åŠ›æµ‹è¯•** | â­â­â­â­â­ | â­â­â­â­ | ä¸Šçº¿å‰ | â­â­â­â­ |
| **å®¹é‡æ¨¡å‹** | â­â­â­ | â­â­â­ | è§„åˆ’é˜¶æ®µ | â­â­â­ |

---

## ä¸‰ã€å®¹é‡è§„åˆ’

### 3.1 å­˜å‚¨å®¹é‡è§„åˆ’

#### 3.1.1 å­˜å‚¨å®¹é‡è§„åˆ’çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦å­˜å‚¨å®¹é‡è§„åˆ’**ï¼š

å­˜å‚¨å®¹é‡è§„åˆ’æ˜¯ç³»ç»Ÿè¿ç»´çš„åŸºç¡€å·¥ä½œï¼Œå®ƒå¯ä»¥å¸®åŠ©ï¼š

1. **æå‰å‡†å¤‡**ï¼šæå‰å‡†å¤‡å­˜å‚¨èµ„æºï¼Œé¿å…å­˜å‚¨ä¸è¶³
2. **æˆæœ¬æ§åˆ¶**ï¼šåˆç†è§„åˆ’å­˜å‚¨ï¼Œæ§åˆ¶æˆæœ¬
3. **æ€§èƒ½ä¿éšœ**ï¼šå……è¶³çš„å­˜å‚¨ç©ºé—´ä¿éšœç³»ç»Ÿæ€§èƒ½
4. **ä¸šåŠ¡è¿ç»­æ€§**ï¼šé¿å…å› å­˜å‚¨ä¸è¶³å¯¼è‡´ä¸šåŠ¡ä¸­æ–­

**å­˜å‚¨å®¹é‡è§„åˆ’çš„å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | é‡è¦æ€§ |
|-----|------|--------|
| **å½“å‰ä½¿ç”¨é‡** | å½“å‰æ•°æ®åº“/è¡¨çš„å¤§å° | â­â­â­â­â­ |
| **å¢é•¿ç‡** | æ•°æ®å¢é•¿é€Ÿåº¦ | â­â­â­â­â­ |
| **ä¿ç•™ç­–ç•¥** | æ•°æ®ä¿ç•™æ—¶é—´ | â­â­â­â­ |
| **å¤‡ä»½ç©ºé—´** | å¤‡ä»½æ‰€éœ€ç©ºé—´ | â­â­â­â­ |

#### 3.1.2 å­˜å‚¨å®¹é‡è®¡ç®—

**æ•°æ®åº“å¤§å°è®¡ç®—**ï¼š

```sql
-- åœºæ™¯ï¼šè®¡ç®—æ•°æ®åº“å¤§å°
-- éœ€æ±‚ï¼šäº†è§£æ¯ä¸ªæ•°æ®åº“çš„å­˜å‚¨ä½¿ç”¨æƒ…å†µ
-- ç”¨é€”ï¼šå®¹é‡è§„åˆ’ã€èµ„æºåˆ†é…

-- æŸ¥è¯¢1ï¼šè®¡ç®—æ‰€æœ‰æ•°æ®åº“çš„å¤§å°
SELECT
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size,
    pg_database_size(pg_database.datname) AS size_bytes,
    ROUND(
        100.0 * pg_database_size(pg_database.datname) /
        (SELECT SUM(pg_database_size(datname)) FROM pg_database),
        2
    ) AS percent_of_total
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;

-- æŸ¥è¯¢ç»“æœåˆ†æï¼š
-- - size: æ•°æ®åº“å¤§å°ï¼ˆäººç±»å¯è¯»æ ¼å¼ï¼‰
-- - size_bytes: æ•°æ®åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰
-- - percent_of_total: å æ€»å­˜å‚¨çš„ç™¾åˆ†æ¯”

-- æŸ¥è¯¢2ï¼šè®¡ç®—è¡¨çš„å¤§å°ï¼ˆåŒ…æ‹¬ç´¢å¼•ï¼‰
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    pg_total_relation_size(schemaname||'.'||tablename) AS total_size_bytes,
    ROUND(
        100.0 * pg_total_relation_size(schemaname||'.'||tablename) /
        (SELECT SUM(pg_total_relation_size(schemaname||'.'||tablename))
         FROM pg_tables WHERE schemaname = 'public'),
        2
    ) AS percent_of_total
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥è¯¢ç»“æœåˆ†æï¼š
-- - total_size: è¡¨æ€»å¤§å°ï¼ˆåŒ…æ‹¬ç´¢å¼•ï¼‰
-- - table_size: è¡¨æ•°æ®å¤§å°
-- - indexes_size: ç´¢å¼•å¤§å°
-- - percent_of_total: å æ€»å­˜å‚¨çš„ç™¾åˆ†æ¯”

-- æ€§èƒ½åˆ†æï¼š
-- - è¯†åˆ«å ç”¨å­˜å‚¨æœ€å¤šçš„è¡¨
-- - è¯†åˆ«ç´¢å¼•å ç”¨ç©ºé—´
-- - ä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ
```

**å­˜å‚¨å¢é•¿é¢„æµ‹**ï¼š

```python
# åœºæ™¯ï¼šé¢„æµ‹å­˜å‚¨å¢é•¿
# éœ€æ±‚ï¼šæ ¹æ®å†å²æ•°æ®é¢„æµ‹æœªæ¥å­˜å‚¨éœ€æ±‚
# ç”¨é€”ï¼šå®¹é‡è§„åˆ’ã€èµ„æºé‡‡è´­

def predict_storage_growth(current_size_gb, growth_rate_per_month, months):
    """
    é¢„æµ‹å­˜å‚¨å¢é•¿

    å‚æ•°ï¼š
        current_size_gb: å½“å‰å¤§å°ï¼ˆGBï¼‰
        growth_rate_per_month: æœˆå¢é•¿ç‡ï¼ˆå¦‚0.1è¡¨ç¤º10%ï¼‰
        months: é¢„æµ‹æœˆæ•°

    è¿”å›ï¼š
        é¢„æµ‹çš„å­˜å‚¨å¤§å°ï¼ˆGBï¼‰
    """
    future_size = current_size_gb * ((1 + growth_rate_per_month) ** months)
    return future_size

# ä½¿ç”¨ç¤ºä¾‹
current = 100  # å½“å‰100GB
growth = 0.1   # æ¯æœˆå¢é•¿10%
months = 12    # é¢„æµ‹12ä¸ªæœˆå
future = predict_storage_growth(current, growth, months)
print(f"12ä¸ªæœˆåé¢„è®¡å­˜å‚¨: {future:.2f}GB")

# è¾“å‡ºï¼š12ä¸ªæœˆåé¢„è®¡å­˜å‚¨: 313.84GB

# æ›´å¤æ‚çš„é¢„æµ‹æ¨¡å‹ï¼ˆè€ƒè™‘çº¿æ€§å¢é•¿å’ŒæŒ‡æ•°å¢é•¿ï¼‰
def predict_storage_growth_advanced(historical_data, months):
    """
    åŸºäºå†å²æ•°æ®é¢„æµ‹å­˜å‚¨å¢é•¿

    å‚æ•°ï¼š
        historical_data: å†å²æ•°æ®åˆ—è¡¨ï¼Œæ ¼å¼ï¼š[(month, size_gb), ...]
        months: é¢„æµ‹æœˆæ•°

    è¿”å›ï¼š
        é¢„æµ‹çš„å­˜å‚¨å¤§å°ï¼ˆGBï¼‰
    """
    import numpy as np
    from scipy import stats

    # æå–æ—¶é—´å’Œå¤§å°
    months_list = [d[0] for d in historical_data]
    sizes = [d[1] for d in historical_data]

    # è®¡ç®—å¢é•¿ç‡
    growth_rates = []
    for i in range(1, len(sizes)):
        rate = (sizes[i] - sizes[i-1]) / sizes[i-1]
        growth_rates.append(rate)

    # ä½¿ç”¨å¹³å‡å¢é•¿ç‡é¢„æµ‹
    avg_growth_rate = np.mean(growth_rates)
    current_size = sizes[-1]
    future_size = current_size * ((1 + avg_growth_rate) ** months)

    return future_size

# ä½¿ç”¨ç¤ºä¾‹
historical = [
    (1, 100),   # ç¬¬1ä¸ªæœˆï¼š100GB
    (2, 110),   # ç¬¬2ä¸ªæœˆï¼š110GB
    (3, 121),   # ç¬¬3ä¸ªæœˆï¼š121GB
    (4, 133),   # ç¬¬4ä¸ªæœˆï¼š133GB
    (5, 146),   # ç¬¬5ä¸ªæœˆï¼š146GB
]
future = predict_storage_growth_advanced(historical, 6)  # é¢„æµ‹6ä¸ªæœˆå
print(f"6ä¸ªæœˆåé¢„è®¡å­˜å‚¨: {future:.2f}GB")
print(f"12ä¸ªæœˆåé¢„è®¡å¤§å°: {future:.2f}GB")

```

### 3.2 è®¡ç®—èµ„æºè§„åˆ’

**CPUè§„åˆ’**ï¼š

```sql
-- æ£€æŸ¥CPUä½¿ç”¨æƒ…å†µ
SELECT
    pid,
    usename,
    application_name,
    state,
    query,
    cpu_time
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY cpu_time DESC;
```

**å†…å­˜è§„åˆ’**ï¼š

```sql
-- æ£€æŸ¥å†…å­˜ä½¿ç”¨
SELECT
    name,
    setting,
    unit,
    context
FROM pg_settings
WHERE name IN (
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'effective_cache_size'
);
```

### 3.3 ç½‘ç»œå®¹é‡è§„åˆ’

**ç½‘ç»œæµé‡ç›‘æ§**ï¼š

```sql
-- æ£€æŸ¥å¤åˆ¶æµé‡
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag
FROM pg_stat_replication;
```

---

## å››ã€å‚ç›´æ‰©å±•

### 4.1 ç¡¬ä»¶å‡çº§

**ç¡¬ä»¶å‡çº§æ¸…å•**ï¼š

- CPUï¼šå¢åŠ æ ¸å¿ƒæ•°æˆ–æå‡é¢‘ç‡
- å†…å­˜ï¼šå¢åŠ å†…å­˜å®¹é‡
- å­˜å‚¨ï¼šå‡çº§åˆ°SSD/NVMe
- ç½‘ç»œï¼šå‡çº§ç½‘ç»œå¸¦å®½

### 4.2 å‚æ•°è°ƒä¼˜

**å‚æ•°è°ƒä¼˜ç¤ºä¾‹**ï¼š

```conf
# å¢åŠ å†…å­˜å‚æ•°
shared_buffers = 8GB  # ä»4GBå¢åŠ åˆ°8GB
work_mem = 32MB       # ä»16MBå¢åŠ åˆ°32MB
effective_cache_size = 24GB  # ä»12GBå¢åŠ åˆ°24GB
```

### 4.3 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æªæ–½**ï¼š

- ç´¢å¼•ä¼˜åŒ–
- æŸ¥è¯¢ä¼˜åŒ–
- åˆ†åŒºè¡¨
- ç‰©åŒ–è§†å›¾

---

## äº”ã€æ°´å¹³æ‰©å±•

### 5.1 è¯»å†™åˆ†ç¦»

**è¯»å†™åˆ†ç¦»æ¶æ„**ï¼š

```text
åº”ç”¨å±‚
  â”œâ”€â”€ å†™è¯·æ±‚ â†’ ä¸»åº“
  â””â”€â”€ è¯»è¯·æ±‚ â†’ ä»åº“ï¼ˆå¤šä¸ªï¼‰
```

**é…ç½®ç¤ºä¾‹**ï¼š

```python
# è¯»å†™åˆ†ç¦»é…ç½®
write_pool = pool.SimpleConnectionPool(
    minconn=1, maxconn=10,
    host="primary_host", database="mydb"
)

read_pool = pool.SimpleConnectionPool(
    minconn=1, maxconn=20,
    host="replica_host", database="mydb"
)
```

### 5.2 åˆ†ç‰‡æ¶æ„

**åˆ†ç‰‡ç­–ç•¥**ï¼š

```python
# æŒ‰ç”¨æˆ·IDåˆ†ç‰‡
def get_shard(user_id):
    shard_count = 4
    return user_id % shard_count

# è·å–åˆ†ç‰‡è¿æ¥
def get_connection(user_id):
    shard = get_shard(user_id)
    shard_hosts = {
        0: "shard0_host",
        1: "shard1_host",
        2: "shard2_host",
        3: "shard3_host"
    }
    return psycopg2.connect(host=shard_hosts[shard], ...)
```

### 5.3 åˆ†å¸ƒå¼æ¶æ„

**Citusåˆ†å¸ƒå¼æ¶æ„**ï¼š

```sql
-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨
SELECT create_distributed_table('users', 'id');
SELECT create_distributed_table('orders', 'user_id');

-- æ·»åŠ å·¥ä½œèŠ‚ç‚¹
SELECT citus_add_node('worker1_host', 5432);
SELECT citus_add_node('worker2_host', 5432);
```

---

## å…­ã€æ‰©å±•ç­–ç•¥

### 6.1 æ‰©å±•æ—¶æœº

**æ‰©å±•è§¦å‘æ¡ä»¶**ï¼š

- CPUä½¿ç”¨ç‡æŒç»­>80%
- å†…å­˜ä½¿ç”¨ç‡æŒç»­>85%
- ç£ç›˜ä½¿ç”¨ç‡>80%
- æŸ¥è¯¢å“åº”æ—¶é—´æ˜¾è‘—å¢åŠ 
- è¿æ¥æ•°æ¥è¿‘ä¸Šé™

### 6.2 æ‰©å±•æ–¹æ¡ˆé€‰æ‹©

**æ–¹æ¡ˆé€‰æ‹©æŒ‡å—**ï¼š

- **å‚ç›´æ‰©å±•**ï¼šé€‚ç”¨äºå•æœºæ€§èƒ½ç“¶é¢ˆ
- **è¯»å†™åˆ†ç¦»**ï¼šé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯
- **åˆ†ç‰‡**ï¼šé€‚ç”¨äºæ•°æ®é‡è¶…å¤§åœºæ™¯
- **åˆ†å¸ƒå¼**ï¼šé€‚ç”¨äºè¶…å¤§è§„æ¨¡åœºæ™¯

### 6.3 æ‰©å±•å®æ–½

**æ‰©å±•å®æ–½æ­¥éª¤**ï¼š

1. è¯„ä¼°å½“å‰å®¹é‡
2. åˆ¶å®šæ‰©å±•æ–¹æ¡ˆ
3. å‡†å¤‡æ‰©å±•èµ„æº
4. æ‰§è¡Œæ‰©å±•æ“ä½œ
5. éªŒè¯æ‰©å±•æ•ˆæœ
6. ç›‘æ§ç³»ç»ŸçŠ¶æ€

---

## ä¸ƒã€å®¹é‡ç›‘æ§

### 7.1 å®¹é‡æŒ‡æ ‡

**å…³é”®å®¹é‡æŒ‡æ ‡**ï¼š

- å­˜å‚¨ä½¿ç”¨ç‡
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- è¿æ¥æ•°ä½¿ç”¨ç‡
- ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡

### 7.2 è¶‹åŠ¿åˆ†æ

**è¶‹åŠ¿åˆ†ææŸ¥è¯¢**ï¼š

```sql
-- å­˜å‚¨å¢é•¿è¶‹åŠ¿
SELECT
    date_trunc('day', recorded_at) as date,
    AVG(storage_used_gb) as avg_storage
FROM capacity_metrics
WHERE recorded_at > NOW() - INTERVAL '30 days'
GROUP BY date_trunc('day', recorded_at)
ORDER BY date;
```

### 7.3 å‘Šè­¦é…ç½®

**å®¹é‡å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
- alert: HighStorageUsage
  expr: (pg_database_size_bytes / pg_database_size_limit_bytes) > 0.8
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Database storage usage is high"
```

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ¶æ„è®¾è®¡](./02.01-éƒ¨ç½²æ¶æ„è®¾è®¡.md)
- [ç›‘æ§ä¸å¯è§‚æµ‹æ€§](./02.02-ç›‘æ§ä¸å¯è§‚æµ‹æ€§.md)
- [æ€§èƒ½è°ƒä¼˜å®è·µ](./02.03-æ€§èƒ½è°ƒä¼˜å®è·µ.md)
- [åˆ†å¸ƒå¼æ¶æ„è®¾è®¡](../../05-æ¶æ„è§†è§’/05.02-åˆ†å¸ƒå¼æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
