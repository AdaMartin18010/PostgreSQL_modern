# PostgreSQL 18 æ•…éšœæ’æŸ¥ä¸æ¢å¤

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 æ•…éšœæ’æŸ¥ä¸æ¢å¤](#postgresql-18-æ•…éšœæ’æŸ¥ä¸æ¢å¤)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 æ•…éšœç±»å‹å¯¹æ¯”](#21-æ•…éšœç±»å‹å¯¹æ¯”)
    - [2.2 æ¢å¤ç­–ç•¥å¯¹æ¯”](#22-æ¢å¤ç­–ç•¥å¯¹æ¯”)
  - [ä¸‰ã€å¸¸è§æ•…éšœè¯Šæ–­](#ä¸‰å¸¸è§æ•…éšœè¯Šæ–­)
    - [3.1 è¿æ¥é—®é¢˜](#31-è¿æ¥é—®é¢˜)
      - [3.1.1 è¿æ¥æ•°è€—å°½é—®é¢˜](#311-è¿æ¥æ•°è€—å°½é—®é¢˜)
    - [3.2 æ€§èƒ½é—®é¢˜](#32-æ€§èƒ½é—®é¢˜)
    - [3.3 é”é—®é¢˜](#33-é”é—®é¢˜)
    - [3.4 æ•°æ®æŸå](#34-æ•°æ®æŸå)
  - [å››ã€æ•…éšœæ’æŸ¥æµç¨‹](#å››æ•…éšœæ’æŸ¥æµç¨‹)
    - [4.1 é—®é¢˜å®šä½](#41-é—®é¢˜å®šä½)
    - [4.2 æ—¥å¿—åˆ†æ](#42-æ—¥å¿—åˆ†æ)
    - [4.3 ç³»ç»Ÿæ£€æŸ¥](#43-ç³»ç»Ÿæ£€æŸ¥)
  - [äº”ã€æ•…éšœæ¢å¤](#äº”æ•…éšœæ¢å¤)
    - [5.1 ä¸»ä»åˆ‡æ¢](#51-ä¸»ä»åˆ‡æ¢)
    - [5.2 æ•°æ®æ¢å¤](#52-æ•°æ®æ¢å¤)
    - [5.3 æœåŠ¡æ¢å¤](#53-æœåŠ¡æ¢å¤)
  - [å…­ã€ç¾éš¾æ¢å¤](#å…­ç¾éš¾æ¢å¤)
    - [6.1 å¤‡ä»½æ¢å¤](#61-å¤‡ä»½æ¢å¤)
    - [6.2 PITRæ¢å¤](#62-pitræ¢å¤)
    - [6.3 å¢é‡å¤‡ä»½æ¢å¤](#63-å¢é‡å¤‡ä»½æ¢å¤)
  - [ä¸ƒã€é¢„é˜²æªæ–½](#ä¸ƒé¢„é˜²æªæ–½)
    - [7.1 ç›‘æ§å‘Šè­¦](#71-ç›‘æ§å‘Šè­¦)
    - [7.2 å®šæœŸæ¼”ç»ƒ](#72-å®šæœŸæ¼”ç»ƒ)
    - [7.3 æœ€ä½³å®è·µ](#73-æœ€ä½³å®è·µ)
  - [å…«ã€ç›¸å…³æ–‡æ¡£](#å…«ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•…éšœæ’æŸ¥ä¸æ¢å¤))
    æ•…éšœè¯Šæ–­
      è¿æ¥é—®é¢˜
        è¿æ¥æ•°è€—å°½
        è¿æ¥æ³„æ¼
        ç½‘ç»œé—®é¢˜
      æ€§èƒ½é—®é¢˜
        æ…¢æŸ¥è¯¢
        èµ„æºç“¶é¢ˆ
        é”ç«äº‰
      é”é—®é¢˜
        æ­»é”
        é”ç­‰å¾…
        é”è¶…æ—¶
      æ•°æ®æŸå
        æ•°æ®ä¸ä¸€è‡´
        ç´¢å¼•æŸå
        è¡¨æŸå
    æ’æŸ¥æµç¨‹
      é—®é¢˜å®šä½
        é—®é¢˜æ”¶é›†
        é—®é¢˜åˆ†æ
        æ ¹å› å®šä½
      æ—¥å¿—åˆ†æ
        æ—¥å¿—æŸ¥çœ‹
        æ—¥å¿—è¿‡æ»¤
        æ—¥å¿—åˆ†æ
      ç³»ç»Ÿæ£€æŸ¥
        ç³»ç»Ÿèµ„æº
        æ•°æ®åº“çŠ¶æ€
        é…ç½®æ£€æŸ¥
    æ•…éšœæ¢å¤
      ä¸»ä»åˆ‡æ¢
        åˆ‡æ¢æµç¨‹
        åˆ‡æ¢éªŒè¯
        æ•°æ®ä¸€è‡´æ€§
      æ•°æ®æ¢å¤
        æ•°æ®æ¢å¤æ–¹æ³•
        æ¢å¤æµç¨‹
        æ¢å¤éªŒè¯
      æœåŠ¡æ¢å¤
        æœåŠ¡é‡å¯
        æœåŠ¡éªŒè¯
        æœåŠ¡ç›‘æ§
    ç¾éš¾æ¢å¤
      å¤‡ä»½æ¢å¤
        å¤‡ä»½ç­–ç•¥
        æ¢å¤æµç¨‹
        æ¢å¤éªŒè¯
      PITRæ¢å¤
        PITRåŸç†
        æ¢å¤æµç¨‹
        æ—¶é—´ç‚¹é€‰æ‹©
      å¢é‡å¤‡ä»½
        å¢é‡å¤‡ä»½åŸç†
        æ¢å¤æµç¨‹
        æ€§èƒ½ä¼˜åŒ–
    é¢„é˜²æªæ–½
      ç›‘æ§å‘Šè­¦
        ç›‘æ§é…ç½®
        å‘Šè­¦è§„åˆ™
        å‘Šè­¦é€šçŸ¥
      å®šæœŸæ¼”ç»ƒ
        æ¼”ç»ƒè®¡åˆ’
        æ¼”ç»ƒæ‰§è¡Œ
        æ¼”ç»ƒæ€»ç»“
      æœ€ä½³å®è·µ
        é¢„é˜²ç­–ç•¥
        åº”æ€¥æµç¨‹
        ç»éªŒæ€»ç»“
```

**æ€ç»´å¯¼å›¾è¯´æ˜**ï¼š

æœ¬æ€ç»´å¯¼å›¾å±•ç¤ºäº†æ•…éšœæ’æŸ¥ä¸æ¢å¤çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»æ•…éšœè¯Šæ–­åˆ°æ•…éšœæ¢å¤ï¼Œä»ç¾éš¾æ¢å¤åˆ°é¢„é˜²æªæ–½ï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«ç†è®ºåŸºç¡€ã€è¯Šæ–­æ–¹æ³•å’Œå®è·µç»éªŒã€‚é€šè¿‡è¿™ä¸ªæ€ç»´å¯¼å›¾ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£æ•…éšœæ’æŸ¥ä¸æ¢å¤çš„å…¨è²Œï¼Œå¹¶æ ¹æ®å…·ä½“éœ€æ±‚æ·±å…¥ç›¸å…³ç« èŠ‚ã€‚

**ä½¿ç”¨å»ºè®®**ï¼š

- **è¿ç»´äººå‘˜**ï¼šé‡ç‚¹å…³æ³¨æ•…éšœè¯Šæ–­å’Œæ•…éšœæ¢å¤ï¼Œç†è§£å¦‚ä½•å¿«é€Ÿå®šä½å’Œæ¢å¤æ•…éšœ
- **æ¶æ„å¸ˆ**ï¼šé‡ç‚¹å…³æ³¨é¢„é˜²æªæ–½å’Œæœ€ä½³å®è·µï¼Œç†è§£å¦‚ä½•å»ºç«‹å®Œå–„çš„æ•…éšœé¢„é˜²ä½“ç³»
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šé‡ç‚¹å…³æ³¨ç¾éš¾æ¢å¤å’Œåº”æ€¥æµç¨‹ï¼Œç†è§£å¦‚ä½•ä¿è¯ä¸šåŠ¡è¿ç»­æ€§

---

## ä¸€ã€æ¦‚è¿°

**æ–‡æ¡£è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£ä¸ä»…åˆ—å‡ºæ•…éšœæ’æŸ¥çš„æ­¥éª¤ï¼Œæ›´é‡è¦çš„æ˜¯è§£é‡Š**ä¸ºä»€ä¹ˆ**ä¼šå‡ºç°è¿™äº›æ•…éšœï¼Œ**å¦‚ä½•**ç³»ç»Ÿæ€§åœ°æ’æŸ¥å’Œæ¢å¤ï¼Œä»¥åŠ**ä½•æ—¶**é‡‡å–é¢„é˜²æªæ–½ã€‚æ¯ä¸ªæ•…éšœéƒ½åŒ…å«ï¼š

1. **æ•…éšœèƒŒæ™¯**ï¼šè§£é‡Šæ•…éšœçš„äº§ç”ŸåŸå› å’Œå½±å“
2. **è¯Šæ–­æ–¹æ³•**ï¼šæä¾›ç³»ç»Ÿæ€§çš„è¯Šæ–­æµç¨‹å’Œå·¥å…·
3. **æ¢å¤æ–¹æ¡ˆ**ï¼šæä¾›å®ç”¨çš„æ¢å¤æ–¹æ¡ˆå’Œæœ€ä½³å®è·µ
4. **é¢„é˜²æªæ–½**ï¼šè¯´æ˜å¦‚ä½•é¢„é˜²æ•…éšœçš„å†æ¬¡å‘ç”Ÿ

**æ•…éšœæ’æŸ¥ä¸æ¢å¤çš„é‡è¦æ€§**ï¼š

æ•…éšœæ’æŸ¥ä¸æ¢å¤æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å…³é”®ï¼Œå®ƒç›´æ¥å½±å“ï¼š

1. **ç³»ç»Ÿå¯ç”¨æ€§**ï¼šå¿«é€Ÿçš„æ•…éšœæ¢å¤å¯ä»¥æé«˜ç³»ç»Ÿå¯ç”¨æ€§
   - **ç†è®ºä¾æ®**ï¼šæ•…éšœæ¢å¤æ—¶é—´ç›´æ¥å½±å“ç³»ç»Ÿå¯ç”¨æ€§
   - **å®è·µä»·å€¼**ï¼šå‡å°‘æœåŠ¡ä¸­æ–­æ—¶é—´ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
   - **æ•ˆæœè¯„ä¼°**ï¼šç³»ç»Ÿå¯ç”¨æ€§æå‡10-30%ï¼Œæ•…éšœæ¢å¤æ—¶é—´å‡å°‘60-90%

2. **æ•°æ®å®‰å…¨**ï¼šåˆé€‚çš„æ¢å¤æ–¹æ¡ˆå¯ä»¥ä¿è¯æ•°æ®å®‰å…¨
   - **ç†è®ºä¾æ®**ï¼šæ•°æ®æ¢å¤å¯ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±
   - **å®è·µä»·å€¼**ï¼šä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®æŸå
   - **æ•ˆæœè¯„ä¼°**ï¼šæ•°æ®æ¢å¤æˆåŠŸç‡æå‡åˆ°99%+ï¼Œæ•°æ®ä¸¢å¤±é£é™©é™ä½90%+

3. **ä¸šåŠ¡è¿ç»­æ€§**ï¼šå®Œå–„çš„æ¢å¤æ–¹æ¡ˆå¯ä»¥ä¿è¯ä¸šåŠ¡è¿ç»­æ€§
   - **ç†è®ºä¾æ®**ï¼šä¸šåŠ¡è¿ç»­æ€§æ˜¯ä¼ä¸šè¿è¥çš„åŸºç¡€
   - **å®è·µä»·å€¼**ï¼šå‡å°‘ä¸šåŠ¡ä¸­æ–­æ—¶é—´ï¼Œä¿è¯ä¸šåŠ¡æ­£å¸¸è¿è¡Œ
   - **æ•ˆæœè¯„ä¼°**ï¼šä¸šåŠ¡ä¸­æ–­æ—¶é—´å‡å°‘70-95%ï¼Œä¸šåŠ¡è¿ç»­æ€§æå‡æ˜¾è‘—

4. **çŸ¥è¯†ç§¯ç´¯**ï¼šæ•…éšœæ’æŸ¥å½¢æˆçŸ¥è¯†åº“
   - **ç†è®ºä¾æ®**ï¼šçŸ¥è¯†ç§¯ç´¯å¯ä»¥é¿å…é‡å¤çŠ¯é”™
   - **å®è·µä»·å€¼**ï¼šæ–°å‘˜å·¥å¿«é€Ÿä¸Šæ‰‹ï¼Œå›¢é˜Ÿæ•´ä½“èƒ½åŠ›æå‡
   - **æ•ˆæœè¯„ä¼°**ï¼šæ–°å‘˜å·¥ä¸Šæ‰‹æ—¶é—´å‡å°‘50-70%ï¼Œå›¢é˜Ÿæ•´ä½“èƒ½åŠ›æå‡20-40%

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **ç³»ç»Ÿæ€§**ï¼šå®Œæ•´çš„æ•…éšœæ’æŸ¥æµç¨‹
  - **ç†è®ºä¾æ®**ï¼šç³»ç»Ÿæ€§çš„æ’æŸ¥æµç¨‹å¯ä»¥æé«˜æ’æŸ¥æ•ˆç‡
  - **å®è·µä»·å€¼**ï¼šå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½å’Œè§£å†³æ•…éšœ
  - **æ’æŸ¥æµç¨‹**ï¼šé—®é¢˜å®šä½ã€æ—¥å¿—åˆ†æã€ç³»ç»Ÿæ£€æŸ¥

- **å®ç”¨æ€§**ï¼šåŸºäºå®é™…æ•…éšœæ¡ˆä¾‹
  - **ç†è®ºä¾æ®**ï¼šåŸºäºå®é™…æ•…éšœæ¡ˆä¾‹çš„ç»éªŒæ€»ç»“
  - **å®è·µä»·å€¼**ï¼šæä¾›å¯ç›´æ¥åº”ç”¨çš„æ•…éšœæ’æŸ¥æ–¹æ³•
  - **å®è·µå†…å®¹**ï¼šæ•…éšœæ¡ˆä¾‹ã€æ’æŸ¥æ–¹æ³•ã€æ¢å¤æ–¹æ¡ˆ

- **å¿«é€Ÿå“åº”**ï¼šæä¾›å¿«é€Ÿè¯Šæ–­æ–¹æ³•
  - **ç†è®ºä¾æ®**ï¼šå¿«é€Ÿè¯Šæ–­å¯ä»¥å‡å°‘æ•…éšœå½±å“æ—¶é—´
  - **å®è·µä»·å€¼**ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œå‡å°‘æ•…éšœæ¢å¤æ—¶é—´
  - **è¯Šæ–­æ–¹æ³•**ï¼šå¿«é€Ÿè¯Šæ–­å·¥å…·ã€è¯Šæ–­æµç¨‹ã€è¯Šæ–­æŠ€å·§

- **æ¢å¤ç­–ç•¥**ï¼šå¤šç§æ¢å¤æ–¹æ¡ˆ
  - **ç†è®ºä¾æ®**ï¼šä¸åŒæ•…éšœéœ€è¦ä¸åŒçš„æ¢å¤æ–¹æ¡ˆ
  - **å®è·µä»·å€¼**ï¼šæä¾›å¤šç§æ¢å¤æ–¹æ¡ˆï¼Œé€‚åº”ä¸åŒåœºæ™¯
  - **æ¢å¤æ–¹æ¡ˆ**ï¼šä¸»ä»åˆ‡æ¢ã€æ•°æ®æ¢å¤ã€æœåŠ¡æ¢å¤ã€ç¾éš¾æ¢å¤

æœ¬æ–‡æ¡£ä»‹ç»PostgreSQL 18çš„æ•…éšœæ’æŸ¥ä¸æ¢å¤å®è·µï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½å’Œè§£å†³ç”Ÿäº§ç¯å¢ƒé—®é¢˜ã€‚

**PostgreSQL 18 æ–°ç‰¹æ€§æ”¯æŒ**ï¼š

- âœ… **å¢é‡å¤‡ä»½**ï¼šæ›´å¿«çš„å¤‡ä»½å’Œæ¢å¤
- âœ… **æ”¹è¿›çš„æ—¥å¿—**ï¼šæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… **å¢å¼ºçš„ç›‘æ§**ï¼šæ›´å¥½çš„æ•…éšœè¯Šæ–­èƒ½åŠ›

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 æ•…éšœç±»å‹å¯¹æ¯”

| æ•…éšœç±»å‹ | é¢‘ç‡ | å½±å“ | æ¢å¤éš¾åº¦ | é¢„é˜²éš¾åº¦ |
|---------|------|------|---------|---------|
| **è¿æ¥é—®é¢˜** | é«˜ | ä¸­ | â­â­ | â­â­ |
| **æ€§èƒ½é—®é¢˜** | é«˜ | ä¸­ | â­â­â­ | â­â­â­ |
| **é”é—®é¢˜** | ä¸­ | é«˜ | â­â­â­ | â­â­â­ |
| **æ•°æ®æŸå** | ä½ | æé«˜ | â­â­â­â­â­ | â­â­â­â­ |

### 2.2 æ¢å¤ç­–ç•¥å¯¹æ¯”

| æ¢å¤ç­–ç•¥ | RTO | RPO | å¤æ‚åº¦ | æ¨èåº¦ |
|---------|-----|-----|--------|--------|
| **ä¸»ä»åˆ‡æ¢** | åˆ†é’Ÿçº§ | ç§’çº§ | â­â­â­ | â­â­â­â­â­ |
| **å¤‡ä»½æ¢å¤** | å°æ—¶çº§ | å°æ—¶çº§ | â­â­ | â­â­â­â­ |
| **PITRæ¢å¤** | å°æ—¶çº§ | åˆ†é’Ÿçº§ | â­â­â­â­ | â­â­â­â­â­ |
| **å¢é‡å¤‡ä»½æ¢å¤** | åˆ†é’Ÿçº§ | åˆ†é’Ÿçº§ | â­â­â­ | â­â­â­â­â­ |

---

## ä¸‰ã€å¸¸è§æ•…éšœè¯Šæ–­

### 3.1 è¿æ¥é—®é¢˜

#### 3.1.1 è¿æ¥æ•°è€—å°½é—®é¢˜

**ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿æ¥æ•°è€—å°½**ï¼š

è¿æ¥æ•°è€—å°½æ˜¯PostgreSQLæœ€å¸¸è§çš„æ•…éšœä¹‹ä¸€ï¼ŒåŸå› åŒ…æ‹¬ï¼š

1. **è¿æ¥æ³„æ¼**ï¼šåº”ç”¨æ²¡æœ‰æ­£ç¡®å…³é—­è¿æ¥
2. **è¿æ¥æ± é…ç½®ä¸å½“**ï¼šè¿æ¥æ± å¤§å°è¶…è¿‡max_connections
3. **é•¿æ—¶é—´äº‹åŠ¡**ï¼šäº‹åŠ¡æŒæœ‰è¿æ¥æ—¶é—´è¿‡é•¿
4. **åƒµå°¸è¿æ¥**ï¼šè¿æ¥å¤„äºidleçŠ¶æ€ä½†æœªé‡Šæ”¾

**è¿æ¥æ•°è€—å°½çš„å±å®³**ï¼š

| å±å®³ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|-----|------|---------|
| **æ–°è¿æ¥æ— æ³•å»ºç«‹** | æœåŠ¡ä¸å¯ç”¨ | â­â­â­â­â­ |
| **åº”ç”¨æŠ¥é”™** | ç”¨æˆ·ä½“éªŒå·® | â­â­â­â­â­ |
| **ç³»ç»Ÿè´Ÿè½½é«˜** | æ€§èƒ½ä¸‹é™ | â­â­â­â­ |

**è¿æ¥æ•°è€—å°½è¯Šæ–­**ï¼š

```sql
-- åœºæ™¯ï¼šè¯Šæ–­è¿æ¥æ•°è€—å°½é—®é¢˜
-- éœ€æ±‚ï¼šå¿«é€Ÿè¯†åˆ«è¿æ¥æ•°ä½¿ç”¨æƒ…å†µå’Œé—®é¢˜è¿æ¥
-- ç”¨é€”ï¼šæ•…éšœæ’æŸ¥å’Œå®¹é‡è§„åˆ’

-- æŸ¥è¯¢1ï¼šæ£€æŸ¥è¿æ¥æ•°ä½¿ç”¨æƒ…å†µ
SELECT
    COUNT(*) as total_connections,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') as max_connections,
    ROUND(100.0 * COUNT(*) / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) as usage_percent,
    CASE
        WHEN 100.0 * COUNT(*) / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') > 90
        THEN 'CRITICAL: Connection usage > 90%'
        WHEN 100.0 * COUNT(*) / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') > 80
        THEN 'WARNING: Connection usage > 80%'
        ELSE 'OK'
    END as status
FROM pg_stat_activity;

-- æŸ¥è¯¢ç»“æœåˆ†æï¼š
-- - total_connections: å½“å‰è¿æ¥æ•°
-- - max_connections: æœ€å¤§è¿æ¥æ•°
-- - usage_percent: è¿æ¥æ•°ä½¿ç”¨ç‡
-- - status: çŠ¶æ€ï¼ˆOK/WARNING/CRITICALï¼‰

-- æŸ¥è¯¢2ï¼šæŸ¥çœ‹è¿æ¥è¯¦æƒ…ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼‰
SELECT
    datname,
    usename,
    application_name,
    client_addr,
    state,
    COUNT(*) as connection_count,
    MAX(EXTRACT(EPOCH FROM (NOW() - state_change))) as max_idle_seconds
FROM pg_stat_activity
WHERE datname IS NOT NULL
GROUP BY datname, usename, application_name, client_addr, state
ORDER BY connection_count DESC;

-- æŸ¥è¯¢ç»“æœåˆ†æï¼š
-- - è¯†åˆ«å ç”¨è¿æ¥æ•°æœ€å¤šçš„åº”ç”¨
-- - è¯†åˆ«é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
-- - è¯†åˆ«å¼‚å¸¸çŠ¶æ€çš„è¿æ¥

-- æŸ¥è¯¢3ï¼šæŸ¥æ‰¾é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥ï¼ˆå¯èƒ½çš„è¿æ¥æ³„æ¼ï¼‰
SELECT
    pid,
    datname,
    usename,
    application_name,
    client_addr,
    state,
    EXTRACT(EPOCH FROM (NOW() - state_change)) as idle_seconds,
    query_start,
    state_change,
    query
FROM pg_stat_activity
WHERE state = 'idle'
  AND EXTRACT(EPOCH FROM (NOW() - state_change)) > 300  -- ç©ºé—²è¶…è¿‡5åˆ†é’Ÿ
ORDER BY state_change;

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. ç»ˆæ­¢é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE state = 'idle' AND EXTRACT(EPOCH FROM (NOW() - state_change)) > 3600;

-- 2. æ£€æŸ¥åº”ç”¨è¿æ¥æ± é…ç½®
-- 3. ä¼˜åŒ–åº”ç”¨ä»£ç ï¼Œç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­
-- 4. å¢åŠ max_connectionsï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
```

**è¿æ¥è¶…æ—¶é—®é¢˜**ï¼š

```sql
-- åœºæ™¯ï¼šè¯Šæ–­è¿æ¥è¶…æ—¶é—®é¢˜
-- é—®é¢˜ï¼šåº”ç”¨è¿æ¥æ•°æ®åº“æ—¶è¶…æ—¶
-- åŸå› ï¼šç½‘ç»œé—®é¢˜ã€é˜²ç«å¢™ã€è¿æ¥æ•°è€—å°½ã€æ•°æ®åº“è´Ÿè½½é«˜

-- æŸ¥è¯¢1ï¼šæ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ï¼ˆå¯èƒ½å¯¼è‡´è¿æ¥è¶…æ—¶ï¼‰
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    EXTRACT(EPOCH FROM (NOW() - query_start)) as query_duration_seconds,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE state = 'active'
  AND EXTRACT(EPOCH FROM (NOW() - query_start)) > 60  -- è¿è¡Œè¶…è¿‡1åˆ†é’Ÿ
ORDER BY query_start;

-- æŸ¥è¯¢ç»“æœåˆ†æï¼š
-- - query_duration_seconds: æŸ¥è¯¢è¿è¡Œæ—¶é—´
-- - wait_event_type: ç­‰å¾…äº‹ä»¶ç±»å‹ï¼ˆå¯èƒ½è¡¨ç¤ºé”ç­‰å¾…ã€I/Oç­‰å¾…ç­‰ï¼‰
-- - wait_event: å…·ä½“ç­‰å¾…äº‹ä»¶

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. ä¼˜åŒ–æ…¢æŸ¥è¯¢
-- 2. ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ï¼ˆå¦‚æœå…è®¸ï¼‰
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE state = 'active' AND EXTRACT(EPOCH FROM (NOW() - query_start)) > 300;

-- 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
-- 4. æ£€æŸ¥é˜²ç«å¢™é…ç½®
-- 5. æ£€æŸ¥æ•°æ®åº“è´Ÿè½½
    query
FROM pg_stat_activity
WHERE state != 'idle'
AND now() - query_start > interval '5 minutes'
ORDER BY query_start;
```

### 3.2 æ€§èƒ½é—®é¢˜

**æ…¢æŸ¥è¯¢è¯Šæ–­**ï¼š

```sql
-- ä½¿ç”¨pg_stat_statementsæŸ¥æ‰¾æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY total_exec_time DESC
LIMIT 10;
```

**èµ„æºç“¶é¢ˆ**ï¼š

```sql
-- æ£€æŸ¥ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) as count
FROM pg_stat_activity
WHERE wait_event IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY count DESC;
```

### 3.3 é”é—®é¢˜

**é”ç­‰å¾…è¯Šæ–­**ï¼š

```sql
-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**æ­»é”å¤„ç†**ï¼š

```sql
-- ç»ˆæ­¢é˜»å¡çš„æŸ¥è¯¢
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid IN (
    SELECT blocking_pid
    FROM (
        -- ä½¿ç”¨ä¸Šé¢çš„é”ç­‰å¾…æŸ¥è¯¢
    ) blocked_queries
);
```

### 3.4 æ•°æ®æŸå

**æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**ï¼š

```sql
-- æ£€æŸ¥è¡¨æŸå
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public';

-- ä½¿ç”¨pg_amcheckæ£€æŸ¥ï¼ˆPostgreSQL 14+ï¼‰
-- pg_amcheck -d mydb -t public.users
```

---

## å››ã€æ•…éšœæ’æŸ¥æµç¨‹

### 4.1 é—®é¢˜å®šä½

**é—®é¢˜å®šä½æ­¥éª¤**ï¼š

1. æ”¶é›†é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
3. æ£€æŸ¥ç³»ç»Ÿèµ„æº
4. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
5. åˆ†æé—®é¢˜åŸå› 

### 4.2 æ—¥å¿—åˆ†æ

**æ—¥å¿—ä½ç½®**ï¼š

```bash
# æ—¥å¿—ç›®å½•
/var/log/postgresql/
# æˆ–
/var/lib/postgresql/18/data/log/

# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log

# æŸ¥æ‰¾é”™è¯¯
grep ERROR /var/log/postgresql/postgresql-*.log

# æŸ¥æ‰¾æ…¢æŸ¥è¯¢
grep "duration:" /var/log/postgresql/postgresql-*.log | \
    awk '{print $NF}' | sort -n | tail -20
```

### 4.3 ç³»ç»Ÿæ£€æŸ¥

**ç³»ç»Ÿèµ„æºæ£€æŸ¥**ï¼š

```bash
# CPUä½¿ç”¨ç‡
top -p $(pgrep -f postgres)

# å†…å­˜ä½¿ç”¨
free -h
ps aux | grep postgres

# ç£ç›˜ä½¿ç”¨
df -h
du -sh /var/lib/postgresql/18/data/

# I/Oç»Ÿè®¡
iostat -x 1
```

---

## äº”ã€æ•…éšœæ¢å¤

### 5.1 ä¸»ä»åˆ‡æ¢

**è‡ªåŠ¨åˆ‡æ¢ï¼ˆPatroniï¼‰**ï¼š

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list

# æ‰‹åŠ¨åˆ‡æ¢
patronictl -c /etc/patroni/patroni.yml switchover

# æ•…éšœè½¬ç§»
patronictl -c /etc/patroni/patroni.yml failover
```

**æ‰‹åŠ¨åˆ‡æ¢**ï¼š

```sql
-- åœ¨ä»åº“ä¸Šæå‡ä¸ºä¸»åº“
SELECT pg_promote();

-- æˆ–ä½¿ç”¨pg_ctl
pg_ctl promote -D /var/lib/postgresql/18/data
```

### 5.2 æ•°æ®æ¢å¤

**ä»å¤‡ä»½æ¢å¤**ï¼š

```bash
# åœæ­¢PostgreSQL
sudo systemctl stop postgresql

# å¤‡ä»½å½“å‰æ•°æ®
sudo mv /var/lib/postgresql/18/data /var/lib/postgresql/18/data.backup

# æ¢å¤å¤‡ä»½
pg_restore -d mydb /backup/mydb_backup.dump

# æˆ–ä½¿ç”¨pg_basebackup
pg_basebackup -h primary_host -U replicator -D /var/lib/postgresql/18/data -X stream -R
```

### 5.3 æœåŠ¡æ¢å¤

**æœåŠ¡é‡å¯**ï¼š

```bash
# æ­£å¸¸é‡å¯
sudo systemctl restart postgresql

# å¼ºåˆ¶é‡å¯
sudo systemctl stop postgresql
sudo systemctl start postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql
```

---

## å…­ã€ç¾éš¾æ¢å¤

### 6.1 å¤‡ä»½æ¢å¤

**é€»è¾‘å¤‡ä»½æ¢å¤**ï¼š

```bash
# æ¢å¤æ•°æ®åº“
pg_restore -d mydb -v /backup/mydb_backup.dump

# æˆ–ä½¿ç”¨psql
psql -d mydb < /backup/mydb_backup.sql
```

**ç‰©ç†å¤‡ä»½æ¢å¤**ï¼š

```bash
# ä½¿ç”¨pg_basebackupæ¢å¤
pg_basebackup -h primary_host -U replicator \
    -D /var/lib/postgresql/18/data \
    -X stream -R -C -S replica1
```

### 6.2 PITRæ¢å¤

**PITRæ¢å¤æ­¥éª¤**ï¼š

```bash
# 1. æ¢å¤åŸºç¡€å¤‡ä»½
pg_combinebackup /backup/base_backup -o /restore/data

# 2. é…ç½®æ¢å¤å‚æ•°
cat > /restore/data/postgresql.auto.conf <<EOF
restore_command = 'cp /backup/wal_archive/%f %p'
recovery_target_time = '2024-01-15 10:00:00'
EOF

# 3. å¯åŠ¨æ•°æ®åº“
pg_ctl -D /restore/data start
```

### 6.3 å¢é‡å¤‡ä»½æ¢å¤

**PostgreSQL 18å¢é‡å¤‡ä»½æ¢å¤**ï¼š

```bash
# æ¢å¤å¢é‡å¤‡ä»½
pg_combinebackup \
    --manifest=/backup/manifest \
    --backup=/backup/base_backup \
    --incremental=/backup/incremental_backup \
    -o /restore/data
```

---

## ä¸ƒã€é¢„é˜²æªæ–½

### 7.1 ç›‘æ§å‘Šè­¦

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

- è¿æ¥æ•°ä½¿ç”¨ç‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- é”ç­‰å¾…æ—¶é—´
- å¤åˆ¶å»¶è¿Ÿ
- ç£ç›˜ä½¿ç”¨ç‡

### 7.2 å®šæœŸæ¼”ç»ƒ

**æ¼”ç»ƒè®¡åˆ’**ï¼š

- æ¯æœˆè¿›è¡Œæ•…éšœåˆ‡æ¢æ¼”ç»ƒ
- æ¯å­£åº¦è¿›è¡Œå¤‡ä»½æ¢å¤æ¼”ç»ƒ
- æ¯å¹´è¿›è¡Œç¾éš¾æ¢å¤æ¼”ç»ƒ

### 7.3 æœ€ä½³å®è·µ

**é¢„é˜²æªæ–½æ¸…å•**ï¼š

- âœ… é…ç½®ç›‘æ§å‘Šè­¦
- âœ… å®šæœŸå¤‡ä»½
- âœ… æµ‹è¯•æ¢å¤æµç¨‹
- âœ… æ–‡æ¡£åŒ–æ“ä½œæµç¨‹
- âœ… åŸ¹è®­è¿ç»´äººå‘˜

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ¶æ„è®¾è®¡](./02.01-éƒ¨ç½²æ¶æ„è®¾è®¡.md)
- [ç›‘æ§ä¸å¯è§‚æµ‹æ€§](./02.02-ç›‘æ§ä¸å¯è§‚æµ‹æ€§.md)
- [æ€§èƒ½è°ƒä¼˜å®è·µ](./02.03-æ€§èƒ½è°ƒä¼˜å®è·µ.md)
- [å¤‡ä»½ä¸æ¢å¤](../../04-éƒ¨ç½²è¿ç»´/04.05-å¤‡ä»½ä¸æ¢å¤.md)
- [æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º](../../06-è¿ç»´å®è·µ/è¿ç»´æ‰‹å†Œ/æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
