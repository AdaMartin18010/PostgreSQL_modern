# çª—å£èšåˆè¯­ä¹‰-ç¨³å®šæ€§ä¸ç­‰ä»·å˜æ¢

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [çª—å£èšåˆè¯­ä¹‰-ç¨³å®šæ€§ä¸ç­‰ä»·å˜æ¢](#çª—å£èšåˆè¯­ä¹‰-ç¨³å®šæ€§ä¸ç­‰ä»·å˜æ¢)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 çª—å£èšåˆè¯­ä¹‰å·¥ä½œåŸç†æ¦‚è¿°](#10-çª—å£èšåˆè¯­ä¹‰å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 çª—å£è¯­ä¹‰](#21-çª—å£è¯­ä¹‰)
    - [2.2 ç¨³å®šæ€§](#22-ç¨³å®šæ€§)
    - [2.3 ç­‰ä»·å˜æ¢](#23-ç­‰ä»·å˜æ¢)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 çª—å£è¯­ä¹‰å½¢å¼åŒ–](#31-çª—å£è¯­ä¹‰å½¢å¼åŒ–)
    - [3.2 ç¨³å®šæ€§å½¢å¼åŒ–](#32-ç¨³å®šæ€§å½¢å¼åŒ–)
    - [3.3 ç­‰ä»·å˜æ¢å½¢å¼åŒ–](#33-ç­‰ä»·å˜æ¢å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 çª—å£å‡½æ•°ç¨³å®šæ€§å®šç†](#41-çª—å£å‡½æ•°ç¨³å®šæ€§å®šç†)
    - [4.2 ç­‰ä»·å˜æ¢å®šç†](#42-ç­‰ä»·å˜æ¢å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQLçª—å£å‡½æ•°](#51-postgresqlçª—å£å‡½æ•°)
    - [5.2 çª—å£æ¡†æ¶](#52-çª—å£æ¡†æ¶)
    - [5.3 çª—å£å‡½æ•°ä¼˜åŒ–](#53-çª—å£å‡½æ•°ä¼˜åŒ–)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 çª—å£å‡½æ•°ç›¸å…³](#72-çª—å£å‡½æ•°ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 çª—å£èšåˆè¯­ä¹‰å·¥ä½œåŸç†æ¦‚è¿°

**çª—å£å‡½æ•°**ï¼š

çª—å£å‡½æ•°åœ¨æŸ¥è¯¢ç»“æœçš„çª—å£ï¼ˆåˆ†åŒºï¼‰ä¸Šè®¡ç®—èšåˆå€¼ï¼Œè€Œä¸æ”¹å˜ç»“æœé›†çš„è¡Œæ•°ã€‚çª—å£èšåˆçš„è¯­ä¹‰ç¨³å®šæ€§ä¿è¯åœ¨ç­‰ä»·å˜æ¢ä¸‹ç»“æœä¸€è‡´ã€‚

**çª—å£å‡½æ•°ä½“ç³»æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((çª—å£å‡½æ•°))
    çª—å£å®šä¹‰
      åˆ†åŒºPARTITION BY
      æ’åºORDER BY
      çª—å£æ¡†æ¶
    çª—å£æ¡†æ¶
      ROWS
      RANGE
      GROUPS
    èšåˆå‡½æ•°
      æ’åå‡½æ•°
      èšåˆå‡½æ•°
      å€¼å‡½æ•°
    è¯­ä¹‰ç¨³å®šæ€§
      ç­‰ä»·å˜æ¢
      ç»“æœä¸€è‡´æ€§
      ä¼˜åŒ–å®‰å…¨æ€§
```

**çª—å£å‡½æ•°è®¡ç®—å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[çª—å£å‡½æ•°æŸ¥è¯¢] --> B[åˆ†åŒºæ•°æ®]
    B --> C[å¯¹æ¯ä¸ªåˆ†åŒº]
    C --> D[æ’åºæ•°æ®]
    D --> E[å®šä¹‰çª—å£æ¡†æ¶]
    E --> F[è®¡ç®—çª—å£å‡½æ•°]
    F --> G{æ‰€æœ‰åˆ†åŒºå¤„ç†å®Œ?}
    G -->|å¦| C
    G -->|æ˜¯| H[åˆå¹¶ç»“æœ]
    H --> I[è¿”å›ç»“æœé›†]

    style A fill:#FFD700
    style I fill:#90EE90
```

**çª—å£æ¡†æ¶ç±»å‹å¯¹æ¯”çŸ©é˜µ**ï¼š

| ç±»å‹ | è¯­ä¹‰ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **ROWS** | ç‰©ç†è¡Œæ•° | é«˜ | å›ºå®šè¡Œæ•°çª—å£ |
| **RANGE** | é€»è¾‘å€¼èŒƒå›´ | ä¸­ | å€¼èŒƒå›´çª—å£ |
| **GROUPS** | ç»„æ•° | ä¸­ | åˆ†ç»„çª—å£ |

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **çª—å£è¯­ä¹‰**ï¼šçª—å£å‡½æ•°çš„å®šä¹‰å’Œè®¡ç®—è¯­ä¹‰
- **ç¨³å®šæ€§**ï¼šçª—å£èšåˆåœ¨ç­‰ä»·å˜æ¢ä¸‹çš„ç¨³å®šæ€§
- **ç­‰ä»·å˜æ¢**ï¼šçª—å£æŸ¥è¯¢çš„ç­‰ä»·å˜æ¢è§„åˆ™
- **å®é™…åº”ç”¨**ï¼šPostgreSQLçª—å£å‡½æ•°çš„å®ç°å’Œåº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 çª—å£è¯­ä¹‰

**çª—å£å‡½æ•°å®šä¹‰**ï¼š

```haskell
-- çª—å£å‡½æ•°
windowFunction :: Aggregation -> Window -> Relation -> Relation
windowFunction agg window r =
    map (Î»t. t âˆª {agg_name: agg(window(t, r))}) r

-- çª—å£å®šä¹‰
window :: Tuple -> Relation -> Relation
window t r =
    filter (Î»t'. inWindow(t', t, windowDef)) r

-- çª—å£æ¡†æ¶
inWindow :: Tuple -> Tuple -> WindowFrame -> Bool
inWindow t' t (ROWS n PRECEDING) =
    rowNumber(t') >= rowNumber(t) - n
inWindow t' t (RANGE value PRECEDING) =
    t'.value >= t.value - value
```

**çª—å£è®¡ç®—æµç¨‹**ï¼š

```mermaid
graph TD
    A[æŸ¥è¯¢ç»“æœé›†] --> B[æŒ‰PARTITION BYåˆ†åŒº]
    B --> C[å¯¹æ¯ä¸ªåˆ†åŒº]
    C --> D[æŒ‰ORDER BYæ’åº]
    D --> E[å¯¹æ¯è¡Œå®šä¹‰çª—å£]
    E --> F[è®¡ç®—çª—å£å‡½æ•°å€¼]
    F --> G{æ‰€æœ‰è¡Œå¤„ç†å®Œ?}
    G -->|å¦| E
    G -->|æ˜¯| H{æ‰€æœ‰åˆ†åŒºå¤„ç†å®Œ?}
    H -->|å¦| C
    H -->|æ˜¯| I[è¿”å›ç»“æœ]

    style A fill:#FFD700
    style I fill:#90EE90
```

### 2.2 ç¨³å®šæ€§

**ç¨³å®šæ€§å®šä¹‰**ï¼š

```haskell
-- çª—å£å‡½æ•°ç¨³å®šæ€§
stable :: Query -> Query -> Bool
stable Q1 Q2 =
    if Q1 â‰¡ Q2 then
        forall DB: windowResult(Q1, DB) = windowResult(Q2, DB)
    else
        False
```

**ç¨³å®šæ€§åˆ¤å®šçŸ©é˜µ**ï¼š

| å˜æ¢ç±»å‹ | æ˜¯å¦ç¨³å®š | æ¡ä»¶ |
|---------|---------|------|
| **é€‰æ‹©ä¸‹æ¨** | æ˜¯ | é€‰æ‹©æ¡ä»¶ä¸æ¶‰åŠçª—å£å‡½æ•° |
| **æŠ•å½±ä¸‹æ¨** | æ˜¯ | æŠ•å½±åŒ…å«çª—å£å‡½æ•° |
| **è¿æ¥äº¤æ¢** | å¦ | çª—å£å‡½æ•°ä¾èµ–è¿æ¥é¡ºåº |
| **æ’åºäº¤æ¢** | å¦ | çª—å£å‡½æ•°ä¾èµ–æ’åº |

### 2.3 ç­‰ä»·å˜æ¢

**ç­‰ä»·å˜æ¢è§„åˆ™**ï¼š

```haskell
-- çª—å£å‡½æ•°ç­‰ä»·å˜æ¢
-- è§„åˆ™1: åˆ†åŒºä¸å˜æ€§
window(agg, partition, r) = window(agg, partition, filter(cond, r))
  if cond does not affect partition

-- è§„åˆ™2: æ’åºä¸å˜æ€§
window(agg, partition, order, r) =
    window(agg, partition, order', r)
  if order and order' are equivalent for window
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 çª—å£è¯­ä¹‰å½¢å¼åŒ–

**çª—å£å‡½æ•°**ï¼š

```haskell
-- çª—å£å‡½æ•°
WINDOW agg OVER (PARTITION BY p ORDER BY o ROWS BETWEEN n1 AND n2)

è¯­ä¹‰:
  for each tuple t:
    window(t) = {t' | t' in partition(t.p) and
                     row_number(t') between row_number(t) + n1 and row_number(t) + n2}
    result(t) = agg(window(t))
```

### 3.2 ç¨³å®šæ€§å½¢å¼åŒ–

**ç¨³å®šæ€§**ï¼š

```haskell
-- çª—å£å‡½æ•°ç¨³å®šæ€§
stable(Q) iff
    forall Q' such that Q â‰¡ Q':
        windowResult(Q) = windowResult(Q')
```

### 3.3 ç­‰ä»·å˜æ¢å½¢å¼åŒ–

**ç­‰ä»·å˜æ¢**ï¼š

```haskell
-- çª—å£æŸ¥è¯¢ç­‰ä»·
Q1 â‰¡_window Q2 iff
    forall DB: windowResult(Q1, DB) = windowResult(Q2, DB)
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 çª—å£å‡½æ•°ç¨³å®šæ€§å®šç†

**å®šç†**ï¼šçª—å£å‡½æ•°åœ¨ç­‰ä»·æŸ¥è¯¢å˜æ¢ä¸‹ä¿æŒç¨³å®šã€‚

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[çª—å£å‡½æ•°ç¨³å®šæ€§] --> B[åˆ†åŒºä¸å˜æ€§]
    A --> C[æ’åºä¸å˜æ€§]
    A --> D[æ¡†æ¶ä¸å˜æ€§]
    B --> E[ç­‰ä»·å˜æ¢ä¿æŒåˆ†åŒº]
    C --> F[ç­‰ä»·å˜æ¢ä¿æŒæ’åº]
    D --> G[ç­‰ä»·å˜æ¢ä¿æŒæ¡†æ¶]
    E --> H[çª—å£ç»“æœä¸€è‡´]
    F --> H
    G --> H
    H --> I[ç¨³å®šæ€§å¾—è¯]

    style A fill:#FFD700
    style I fill:#90EE90
```

**è¯æ˜**ï¼š

1. çª—å£å‡½æ•°çš„ç»“æœåªä¾èµ–äºåˆ†åŒºã€æ’åºå’Œçª—å£æ¡†æ¶
2. ç­‰ä»·å˜æ¢ä¿æŒè¿™äº›å±æ€§
3. å› æ­¤çª—å£å‡½æ•°ç»“æœåœ¨ç­‰ä»·å˜æ¢ä¸‹ä¿æŒä¸å˜

### 4.2 ç­‰ä»·å˜æ¢å®šç†

**å®šç†**ï¼šçª—å£æŸ¥è¯¢çš„ç­‰ä»·å˜æ¢è§„åˆ™æ˜¯æ­£ç¡®çš„ã€‚

**è¯æ˜**ï¼š

1. æ¯ä¸ªç­‰ä»·å˜æ¢è§„åˆ™éƒ½æœ‰å¯¹åº”çš„è¯­ä¹‰ç­‰ä»·æ€§
2. è¯­ä¹‰ç­‰ä»·æ€§ä¿è¯ç»“æœä¸€è‡´
3. å› æ­¤ç­‰ä»·å˜æ¢è§„åˆ™æ­£ç¡®

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQLçª—å£å‡½æ•°

**åŸºæœ¬çª—å£å‡½æ•°**ï¼š

```sql
-- æ’åå‡½æ•°
SELECT
    employee_id,
    employee_name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department_id ORDER BY salary DESC) as rank,
    RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) as rank_with_ties,
    DENSE_RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) as dense_rank
FROM employees;

-- èšåˆå‡½æ•°
SELECT
    order_id,
    order_date,
    amount,
    SUM(amount) OVER (PARTITION BY customer_id ORDER BY order_date
                       ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as running_total,
    AVG(amount) OVER (PARTITION BY customer_id) as avg_amount
FROM orders;
```

### 5.2 çª—å£æ¡†æ¶

**ä¸åŒçª—å£æ¡†æ¶**ï¼š

```sql
-- ROWSæ¡†æ¶ï¼šç‰©ç†è¡Œæ•°
SELECT
    date,
    sales,
    SUM(sales) OVER (ORDER BY date
                     ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) as moving_avg_3days
FROM daily_sales;

-- RANGEæ¡†æ¶ï¼šé€»è¾‘å€¼èŒƒå›´
SELECT
    date,
    sales,
    SUM(sales) OVER (ORDER BY date
                     RANGE BETWEEN INTERVAL '2 days' PRECEDING AND CURRENT ROW) as moving_avg_range
FROM daily_sales;

-- GROUPSæ¡†æ¶ï¼šç»„æ•°
SELECT
    category,
    product,
    sales,
    SUM(sales) OVER (ORDER BY category
                     GROUPS BETWEEN 1 PRECEDING AND 1 FOLLOWING) as group_sum
FROM products;
```

### 5.3 çª—å£å‡½æ•°ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨ç´¢å¼•åŠ é€Ÿçª—å£å‡½æ•°
CREATE INDEX idx_dept_salary ON employees(department_id, salary DESC);

-- çª—å£å‡½æ•°æŸ¥è¯¢
SELECT
    employee_id,
    salary,
    RANK() OVER (PARTITION BY department_id ORDER BY salary DESC)
FROM employees
WHERE department_id = 1;  -- ç´¢å¼•å¯ä»¥åŠ é€Ÿåˆ†åŒºå’Œæ’åº

-- é¿å…é‡å¤è®¡ç®—
WITH ranked AS (
    SELECT
        employee_id,
        RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) as rank
    FROM employees
)
SELECT * FROM ranked WHERE rank <= 10;
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å¤šé‡é›†è¯­ä¹‰-SQLä¸å…³ç³»ä»£æ•°çš„bagå½¢å¼åŒ–](./08.11-å¤šé‡é›†è¯­ä¹‰-SQLä¸å…³ç³»ä»£æ•°çš„bagå½¢å¼åŒ–.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Leis, V., et al. (2015). "How Good Are Query Optimizers, Really?"**
  - ä¼šè®®: VLDB 2015
  - **é‡è¦æ€§**: æŸ¥è¯¢ä¼˜åŒ–å™¨è¯„ä¼°çš„ç»å…¸ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: è¯„ä¼°äº†çª—å£å‡½æ•°çš„ä¼˜åŒ–æ•ˆæœ

- **Leis, V., et al. (2018). "Query Optimization Through the Looking Glass, and What We Found Running the Join Order Benchmark."**
  - ä¼šè®®: VLDB 2018
  - **é‡è¦æ€§**: æŸ¥è¯¢ä¼˜åŒ–çš„æ·±å…¥åˆ†æ
  - **æ ¸å¿ƒè´¡çŒ®**: åˆ†æäº†çª—å£å‡½æ•°çš„ä¼˜åŒ–ç­–ç•¥

### 7.2 çª—å£å‡½æ•°ç›¸å…³

- **ISO/IEC 9075:2016. "Information technology â€” Database languages â€” SQL."**
  - æ ‡å‡†: SQLæ ‡å‡†
  - **é‡è¦æ€§**: SQLçª—å£å‡½æ•°çš„å®˜æ–¹è§„èŒƒ
  - **æ ¸å¿ƒè´¡çŒ®**: å®šä¹‰äº†çª—å£å‡½æ•°çš„è¯­ä¹‰

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - çª—å£å‡½æ•°](<https://www.postgresql.org/docs/current/tutorial-window.html>)**
  - PostgreSQLçª—å£å‡½æ•°å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [å¤šé‡é›†è¯­ä¹‰-SQLä¸å…³ç³»ä»£æ•°çš„bagå½¢å¼åŒ–](./08.11-å¤šé‡é›†è¯­ä¹‰-SQLä¸å…³ç³»ä»£æ•°çš„bagå½¢å¼åŒ–.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
