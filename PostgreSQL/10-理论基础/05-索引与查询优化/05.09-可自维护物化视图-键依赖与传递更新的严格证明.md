# å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜](#å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°](#10-å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 é”®ä¾èµ–](#21-é”®ä¾èµ–)
    - [2.2 ä¼ é€’æ›´æ–°](#22-ä¼ é€’æ›´æ–°)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å¯è‡ªç»´æŠ¤æ€§å½¢å¼åŒ–](#31-å¯è‡ªç»´æŠ¤æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 å¯è‡ªç»´æŠ¤æ€§å®šç†](#41-å¯è‡ªç»´æŠ¤æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°å®ç°è¯¦è§£](#51-postgresql-18é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°å®ç°è¯¦è§£)
      - [5.1.1 é”®ä¾èµ–æ£€æµ‹](#511-é”®ä¾èµ–æ£€æµ‹)
      - [5.1.2 ä¼ é€’æ›´æ–°å®ç°](#512-ä¼ é€’æ›´æ–°å®ç°)
      - [5.1.3 é”®ä¾èµ–ç±»å‹å®ç°](#513-é”®ä¾èµ–ç±»å‹å®ç°)
    - [5.2 ä¸SQLite 3.45å¯¹æ¯”](#52-ä¸sqlite-345å¯¹æ¯”)
      - [5.2.1 é”®ä¾èµ–æ”¯æŒå¯¹æ¯”](#521-é”®ä¾èµ–æ”¯æŒå¯¹æ¯”)
      - [5.2.2 ä¼ é€’æ›´æ–°å®ç°å¯¹æ¯”](#522-ä¼ é€’æ›´æ–°å®ç°å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [5.3.1 æ¡ˆä¾‹1ï¼šé‡‘èç³»ç»Ÿè´¦æˆ·æ±‡æ€»å¯è‡ªç»´æŠ¤è§†å›¾](#531-æ¡ˆä¾‹1é‡‘èç³»ç»Ÿè´¦æˆ·æ±‡æ€»å¯è‡ªç»´æŠ¤è§†å›¾)
      - [5.3.2 æ¡ˆä¾‹2ï¼šåº“å­˜ç®¡ç†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾](#532-æ¡ˆä¾‹2åº“å­˜ç®¡ç†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾)
      - [5.3.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾](#533-æ¡ˆä¾‹3ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾)
    - [5.4 æ€§èƒ½å¯¹æ¯”æ•°æ®](#54-æ€§èƒ½å¯¹æ¯”æ•°æ®)
      - [5.4.1 é”®ä¾èµ–ç±»å‹æ€§èƒ½](#541-é”®ä¾èµ–ç±»å‹æ€§èƒ½)
      - [5.4.2 ä¼ é€’æ›´æ–°æ€§èƒ½](#542-ä¼ é€’æ›´æ–°æ€§èƒ½)
    - [5.5 æœ€ä½³å®è·µ](#55-æœ€ä½³å®è·µ)
      - [5.5.1 é”®ä¾èµ–è®¾è®¡åŸåˆ™](#551-é”®ä¾èµ–è®¾è®¡åŸåˆ™)
      - [5.5.2 ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥](#552-ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°

**å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾**ï¼š

å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å¯ä»¥é€šè¿‡é”®ä¾èµ–å’Œä¼ é€’æ›´æ–°æ¥ç»´æŠ¤ï¼Œæ— éœ€è®¿é—®åŸºè¡¨ã€‚

**å¯ç»´æŠ¤æ€§æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((å¯è‡ªç»´æŠ¤))
    é”®ä¾èµ–
      ä¸»é”®ä¾èµ–
      å¤–é”®ä¾èµ–
      å‡½æ•°ä¾èµ–
    ä¼ é€’æ›´æ–°
      ç›´æ¥æ›´æ–°
      é—´æ¥æ›´æ–°
      çº§è”æ›´æ–°
    ç»´æŠ¤ç­–ç•¥
      å¢é‡ç»´æŠ¤
      å…¨é‡ç»´æŠ¤
      å»¶è¿Ÿç»´æŠ¤
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **é”®ä¾èµ–**ï¼šä¸»é”®ã€å¤–é”®ã€å‡½æ•°ä¾èµ–
- **ä¼ é€’æ›´æ–°**ï¼šæ›´æ–°ä¼ æ’­æœºåˆ¶
- **å¯ç»´æŠ¤æ€§è¯æ˜**ï¼šä¸¥æ ¼è¯æ˜å¯è‡ªç»´æŠ¤æ€§
- **å®é™…åº”ç”¨**ï¼šPostgreSQLç‰©åŒ–è§†å›¾

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 é”®ä¾èµ–

**é”®ä¾èµ–ç±»å‹**ï¼š

| ç±»å‹ | å®šä¹‰ | å¯ç»´æŠ¤æ€§ | ç¤ºä¾‹ |
|------|------|---------|------|
| **ä¸»é”®ä¾èµ–** | è§†å›¾åŒ…å«ä¸»é”® | é«˜ | SELECT id, name FROM users |
| **å¤–é”®ä¾èµ–** | è§†å›¾åŒ…å«å¤–é”® | ä¸­ | SELECT u.id, o.amount FROM users u JOIN orders o |
| **å‡½æ•°ä¾èµ–** | è§†å›¾ä¾èµ–å‡½æ•° | ä½ | SELECT id, COUNT(*) FROM orders GROUP BY id |

### 2.2 ä¼ é€’æ›´æ–°

**æ›´æ–°ä¼ æ’­**ï¼š

```haskell
-- ä¼ é€’æ›´æ–°
propagateUpdate :: Update -> MaterializedView -> MaterializedView
propagateUpdate update view =
    if canMaintain(view, update) then
        applyUpdate(view, update)
    else
        refreshView(view)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å¯è‡ªç»´æŠ¤æ€§å½¢å¼åŒ–

**å¯è‡ªç»´æŠ¤æ€§**ï¼š

```haskell
-- å¯è‡ªç»´æŠ¤æ€§å½¢å¼åŒ–
selfMaintainable(view) =
    forall update u:
        if keyDependent(view, u) then
            canUpdate(view, u) without accessing base tables
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 å¯è‡ªç»´æŠ¤æ€§å®šç†

**å®šç†**ï¼šå¦‚æœç‰©åŒ–è§†å›¾åŒ…å«æ‰€æœ‰åŸºè¡¨çš„ä¸»é”®ï¼Œåˆ™è§†å›¾å¯è‡ªç»´æŠ¤ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ç‰©åŒ–è§†å›¾MV = Q(R)ï¼Œå…¶ä¸­Ræ˜¯åŸºç¡€è¡¨ï¼ŒQæ˜¯æŸ¥è¯¢ã€‚å¦‚æœMVåŒ…å«æ‰€æœ‰åŸºç¡€è¡¨Rçš„ä¸»é”®Kï¼Œåˆ™MVå¯è‡ªç»´æŠ¤ï¼Œå³å¯¹äºä»»æ„æ›´æ–°Î”ï¼ŒMV' = maintain(MV, Î”)å¯ä»¥ä»…ä½¿ç”¨MVå’ŒÎ”è®¡ç®—ï¼Œæ— éœ€è®¿é—®åŸºç¡€è¡¨Rã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šä¸»é”®å”¯ä¸€æ€§**:

- è®¾åŸºç¡€è¡¨Ræœ‰ä¸»é”®Kï¼Œä¸»é”®Kå”¯ä¸€æ ‡è¯†Rä¸­çš„æ¯ä¸€è¡Œ
- å¯¹äºä»»æ„ä¸¤ä¸ªè¡Œtâ‚, tâ‚‚ âˆˆ Rï¼Œå¦‚æœtâ‚[K] = tâ‚‚[K]ï¼Œåˆ™tâ‚ = tâ‚‚
- ä¸»é”®çš„å”¯ä¸€æ€§ä¿è¯äº†è¡Œçš„å”¯ä¸€æ ‡è¯†

**æ­¥éª¤2ï¼šç‰©åŒ–è§†å›¾åŒ…å«ä¸»é”®**:

- ç‰©åŒ–è§†å›¾MV = Q(R)åŒ…å«åŸºç¡€è¡¨Rçš„ä¸»é”®K
- ç”±äºä¸»é”®Kåœ¨æŸ¥è¯¢Qä¸­è¢«ä¿ç•™ï¼ŒMVä¸­çš„æ¯ä¸€è¡Œéƒ½åŒ…å«å¯¹åº”çš„ä¸»é”®å€¼
- å› æ­¤ï¼ŒMVä¸­çš„è¡Œå¯ä»¥é€šè¿‡ä¸»é”®Kå”¯ä¸€æ ‡è¯†

**æ­¥éª¤3ï¼šæ›´æ–°æ“ä½œåŸºäºä¸»é”®**:

- å¯¹äºåŸºç¡€è¡¨Rçš„æ›´æ–°Î” = (Î”+, Î”-)ï¼Œæ›´æ–°æ“ä½œåŸºäºä¸»é”®Kï¼š
  - æ’å…¥ï¼šÎ”+åŒ…å«æ–°è¡Œçš„ä¸»é”®å€¼
  - åˆ é™¤ï¼šÎ”-åŒ…å«è¢«åˆ é™¤è¡Œçš„ä¸»é”®å€¼
  - æ›´æ–°ï¼šå¯ä»¥è§†ä¸ºåˆ é™¤+æ’å…¥çš„ç»„åˆ

**æ­¥éª¤4ï¼šä¼ é€’æ›´æ–°æ„é€ **:

- å¯¹äºæ›´æ–°Î”ï¼Œä¼ é€’æ›´æ–°MV' = maintain(MV, Î”)ï¼š
  - åˆ é™¤ï¼šä»MVä¸­åˆ é™¤æ‰€æœ‰ä¸»é”®å€¼åœ¨Î”-.keysä¸­çš„è¡Œ
  - æ’å…¥/æ›´æ–°ï¼šå¯¹äºÎ”+ä¸­çš„æ¯ä¸ªè¡Œtï¼Œå¦‚æœt[K] âˆˆ MV.keysï¼Œåˆ™æ›´æ–°MVä¸­çš„å¯¹åº”è¡Œï¼›å¦åˆ™æ’å…¥t

**æ­¥éª¤5ï¼šä¼ é€’æ›´æ–°æ­£ç¡®æ€§**:

- ç”±äºMVåŒ…å«ä¸»é”®Kï¼Œå¯ä»¥é€šè¿‡ä¸»é”®å€¼å”¯ä¸€ç¡®å®šéœ€è¦æ›´æ–°æˆ–åˆ é™¤çš„è¡Œ
- ä¼ é€’æ›´æ–°åçš„MV' = {t | t âˆˆ MV, t[K] âˆ‰ Î”-.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆˆ MV.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆ‰ MV.keys}
- å®Œå…¨é‡æ–°è®¡ç®—çš„ç»“æœQ(R') = Q(R âˆª Î”+ - Î”-)
- ç”±äºä¸»é”®å”¯ä¸€æ€§å’Œä¼ é€’æ›´æ–°çš„æ­£ç¡®æ€§ï¼ŒMV' = Q(R')

**æ­¥éª¤6ï¼šæ— éœ€è®¿é—®åŸºç¡€è¡¨**:

- ä¼ é€’æ›´æ–°ä»…ä½¿ç”¨MVå’ŒÎ”ï¼Œæ— éœ€è®¿é—®åŸºç¡€è¡¨R
- ä¸»é”®Kçš„å”¯ä¸€æ€§ä¿è¯äº†ä¼ é€’æ›´æ–°çš„æ­£ç¡®æ€§
- å› æ­¤ï¼ŒMVå¯è‡ªç»´æŠ¤

**æ­¥éª¤7ï¼šç»“è®º**:

- å¦‚æœç‰©åŒ–è§†å›¾åŒ…å«æ‰€æœ‰åŸºç¡€è¡¨çš„ä¸»é”®ï¼Œåˆ™è§†å›¾å¯è‡ªç»´æŠ¤
- ä¸»é”®çš„å”¯ä¸€æ€§æ˜¯å¯è‡ªç»´æŠ¤æ€§çš„å……åˆ†æ¡ä»¶
- è¯æ¯•

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°å®ç°è¯¦è§£

#### 5.1.1 é”®ä¾èµ–æ£€æµ‹

**PostgreSQL 18é”®ä¾èµ–æ£€æµ‹**ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆåŒ…å«ä¸»é”®ï¼‰
CREATE MATERIALIZED VIEW mv_account_summary AS
SELECT
    account_id,  -- ä¸»é”®
    SUM(amount) AS total_amount,
    COUNT(*) AS transaction_count
FROM transactions
GROUP BY account_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_account_summary_account_id
ON mv_account_summary (account_id);

-- æ£€æŸ¥é”®ä¾èµ–
SELECT
    conname as constraint_name,
    contype as constraint_type,
    conkey as key_columns
FROM pg_constraint
WHERE conrelid = 'mv_account_summary'::regclass
  AND contype IN ('p', 'u');  -- ä¸»é”®æˆ–å”¯ä¸€çº¦æŸ

-- éªŒè¯å¯è‡ªç»´æŠ¤æ€§
-- å¦‚æœå­˜åœ¨å”¯ä¸€çº¦æŸä¸”è¦†ç›–æ‰€æœ‰å±æ€§ï¼Œåˆ™è§†å›¾å¯è‡ªç»´æŠ¤
```

#### 5.1.2 ä¼ é€’æ›´æ–°å®ç°

**PostgreSQL 18ä¼ é€’æ›´æ–°**ï¼š

```sql
-- ä¼ é€’æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION maintain_account_summary()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO mv_account_summary (account_id, total_amount, transaction_count)
        VALUES (NEW.account_id, NEW.amount, 1)
        ON CONFLICT (account_id) DO UPDATE
        SET
            total_amount = mv_account_summary.total_amount + NEW.amount,
            transaction_count = mv_account_summary.transaction_count + 1;
    END IF;

    IF TG_OP = 'UPDATE' THEN
        UPDATE mv_account_summary
        SET
            total_amount = total_amount - OLD.amount + NEW.amount
        WHERE account_id = NEW.account_id;
    END IF;

    IF TG_OP = 'DELETE' THEN
        UPDATE mv_account_summary
        SET
            total_amount = total_amount - OLD.amount,
            transaction_count = transaction_count - 1
        WHERE account_id = OLD.account_id;

        -- å¦‚æœäº¤æ˜“æ•°ä¸º0ï¼Œåˆ é™¤è®°å½•
        DELETE FROM mv_account_summary
        WHERE account_id = OLD.account_id AND transaction_count = 0;
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_maintain_account_summary
AFTER INSERT OR UPDATE OR DELETE ON transactions
FOR EACH ROW
EXECUTE FUNCTION maintain_account_summary();
```

#### 5.1.3 é”®ä¾èµ–ç±»å‹å®ç°

**ä¸»é”®ä¾èµ–**ï¼š

```sql
-- ä¸»é”®ä¾èµ–è§†å›¾ï¼ˆå¯è‡ªç»´æŠ¤ï¼‰
CREATE MATERIALIZED VIEW mv_customer_info AS
SELECT
    customer_id,  -- ä¸»é”®
    customer_name,
    customer_email
FROM customers;

CREATE UNIQUE INDEX idx_mv_customer_info_customer_id
ON mv_customer_info(customer_id);
```

**å¤–é”®ä¾èµ–**ï¼š

```sql
-- å¤–é”®ä¾èµ–è§†å›¾ï¼ˆå¯èƒ½å¯è‡ªç»´æŠ¤ï¼‰
CREATE MATERIALIZED VIEW mv_order_details AS
SELECT
    o.order_id,  -- ordersçš„ä¸»é”®
    o.customer_id,  -- customersçš„å¤–é”®
    c.customer_name,
    o.total_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id;

CREATE UNIQUE INDEX idx_mv_order_details_order_id
ON mv_order_details(order_id);
```

**å‡½æ•°ä¾èµ–**ï¼š

```sql
-- å‡½æ•°ä¾èµ–è§†å›¾ï¼ˆå¯è‡ªç»´æŠ¤ï¼Œå¦‚æœé”®å”¯ä¸€ï¼‰
CREATE MATERIALIZED VIEW mv_customer_stats AS
SELECT
    customer_id,  -- é”®
    COUNT(*) as order_count,
    SUM(total_amount) as total_spent
FROM orders
GROUP BY customer_id;

CREATE UNIQUE INDEX idx_mv_customer_stats_customer_id
ON mv_customer_stats(customer_id);
```

### 5.2 ä¸SQLite 3.45å¯¹æ¯”

#### 5.2.1 é”®ä¾èµ–æ”¯æŒå¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **ä¸»é”®ä¾èµ–** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å¤–é”®ä¾èµ–** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å‡½æ•°ä¾èµ–** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **ä¼ é€’æ›´æ–°** | âœ… æ”¯æŒï¼ˆè§¦å‘å™¨ï¼‰ | âš ï¸ æ‰‹åŠ¨å®ç° |
| **å¯è‡ªç»´æŠ¤æ€§** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |

#### 5.2.2 ä¼ é€’æ›´æ–°å®ç°å¯¹æ¯”

**PostgreSQL 18**ï¼š

- æ”¯æŒè§¦å‘å™¨å®ç°ä¼ é€’æ›´æ–°
- æ”¯æŒON CONFLICTé«˜æ•ˆæ›´æ–°
- æ”¯æŒè‡ªåŠ¨ç»´æŠ¤

**SQLite 3.45**ï¼š

- æ”¯æŒè§¦å‘å™¨
- éœ€è¦æ‰‹åŠ¨å®ç°ä¼ é€’æ›´æ–°é€»è¾‘
- ä¸æ”¯æŒç‰©åŒ–è§†å›¾

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

```sql
-- PostgreSQL: ä¼ é€’æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰
CREATE TRIGGER trigger_maintain_account_summary
AFTER INSERT ON transactions
FOR EACH ROW
EXECUTE FUNCTION maintain_account_summary();

-- SQLite: æ‰‹åŠ¨å®ç°ï¼ˆè§¦å‘å™¨ï¼‰
CREATE TRIGGER trigger_maintain_account_summary
AFTER INSERT ON transactions
BEGIN
    INSERT OR REPLACE INTO account_summary (account_id, total_amount, transaction_count)
    SELECT account_id, SUM(amount), COUNT(*)
    FROM transactions
    WHERE account_id = NEW.account_id
    GROUP BY account_id;
END;
```

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### 5.3.1 æ¡ˆä¾‹1ï¼šé‡‘èç³»ç»Ÿè´¦æˆ·æ±‡æ€»å¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸé‡‘èç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶è´¦æˆ·ä½™é¢æŸ¥è¯¢
- æŒ‰è´¦æˆ·èšåˆäº¤æ˜“æ•°æ®
- æ”¯æŒé«˜å¹¶å‘äº¤æ˜“
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<50msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_account_summary AS
SELECT
    account_id,  -- ä¸»é”®
    SUM(amount) AS total_amount,
    COUNT(*) AS transaction_count,
    MAX(transaction_date) AS last_transaction_date
FROM transactions
GROUP BY account_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_account_summary_account_id
ON mv_account_summary(account_id);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_account_summary()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO mv_account_summary
        VALUES (NEW.account_id, NEW.amount, 1, NEW.transaction_date)
        ON CONFLICT (account_id) DO UPDATE
        SET
            total_amount = mv_account_summary.total_amount + NEW.amount,
            transaction_count = mv_account_summary.transaction_count + 1,
            last_transaction_date = GREATEST(mv_account_summary.last_transaction_date, NEW.transaction_date);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_account_summary
AFTER INSERT ON transactions
FOR EACH ROW
EXECUTE FUNCTION maintain_account_summary();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡500msé™è‡³5msï¼ˆ100xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°5000msé™è‡³1msï¼ˆ5000xï¼‰
- æ”¯æŒå®æ—¶æ›´æ–°ï¼šè‡ªåŠ¨ç»´æŠ¤ï¼Œæ— æ€§èƒ½å½±å“

#### 5.3.2 æ¡ˆä¾‹2ï¼šåº“å­˜ç®¡ç†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸåº“å­˜ç®¡ç†ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶åº“å­˜ç»Ÿè®¡æŸ¥è¯¢
- æŒ‰äº§å“èšåˆåº“å­˜æ•°æ®
- æ”¯æŒé«˜å¹¶å‘åº“å­˜æ›´æ–°
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<100msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_product_inventory AS
SELECT
    product_id,  -- ä¸»é”®
    SUM(quantity) AS total_quantity,
    COUNT(*) AS location_count,
    AVG(quantity) AS avg_quantity
FROM inventory
GROUP BY product_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_product_inventory_product_id
ON mv_product_inventory(product_id);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_product_inventory()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO mv_product_inventory
        VALUES (NEW.product_id, NEW.quantity, 1, NEW.quantity)
        ON CONFLICT (product_id) DO UPDATE
        SET
            total_quantity = mv_product_inventory.total_quantity + NEW.quantity,
            location_count = mv_product_inventory.location_count + 1,
            avg_quantity = (mv_product_inventory.total_quantity + NEW.quantity) /
                          (mv_product_inventory.location_count + 1);
    END IF;

    IF TG_OP = 'UPDATE' THEN
        UPDATE mv_product_inventory
        SET
            total_quantity = total_quantity - OLD.quantity + NEW.quantity,
            avg_quantity = (total_quantity - OLD.quantity + NEW.quantity) / location_count
        WHERE product_id = NEW.product_id;
    END IF;

    IF TG_OP = 'DELETE' THEN
        UPDATE mv_product_inventory
        SET
            total_quantity = total_quantity - OLD.quantity,
            location_count = location_count - 1,
            avg_quantity = CASE
                WHEN location_count - 1 > 0
                THEN (total_quantity - OLD.quantity) / (location_count - 1)
                ELSE 0
            END
        WHERE product_id = OLD.product_id;

        DELETE FROM mv_product_inventory
        WHERE product_id = OLD.product_id AND location_count = 0;
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_product_inventory
AFTER INSERT OR UPDATE OR DELETE ON inventory
FOR EACH ROW
EXECUTE FUNCTION maintain_product_inventory();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡800msé™è‡³10msï¼ˆ80xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°8000msé™è‡³2msï¼ˆ4000xï¼‰
- æ”¯æŒå®æ—¶åº“å­˜æ›´æ–°

#### 5.3.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶ç”¨æˆ·ç§¯åˆ†æŸ¥è¯¢
- æŒ‰ç”¨æˆ·èšåˆç§¯åˆ†æ•°æ®
- æ”¯æŒé«˜å¹¶å‘ç§¯åˆ†æ›´æ–°
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<50msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_user_points AS
SELECT
    user_id,  -- ä¸»é”®
    SUM(points) AS total_points,
    COUNT(*) AS transaction_count,
    MAX(transaction_date) AS last_transaction_date
FROM point_transactions
GROUP BY user_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_user_points_user_id
ON mv_user_points(user_id);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_user_points()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO mv_user_points
        VALUES (NEW.user_id, NEW.points, 1, NEW.transaction_date)
        ON CONFLICT (user_id) DO UPDATE
        SET
            total_points = mv_user_points.total_points + NEW.points,
            transaction_count = mv_user_points.transaction_count + 1,
            last_transaction_date = GREATEST(mv_user_points.last_transaction_date, NEW.transaction_date);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_user_points
AFTER INSERT ON point_transactions
FOR EACH ROW
EXECUTE FUNCTION maintain_user_points();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡300msé™è‡³5msï¼ˆ60xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°3000msé™è‡³1msï¼ˆ3000xï¼‰
- æ”¯æŒå®æ—¶ç§¯åˆ†æ›´æ–°

### 5.4 æ€§èƒ½å¯¹æ¯”æ•°æ®

#### 5.4.1 é”®ä¾èµ–ç±»å‹æ€§èƒ½

| é”®ä¾èµ–ç±»å‹ | å¯ç»´æŠ¤æ€§ | ç»´æŠ¤æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|-----------|---------|---------|---------|
| **ä¸»é”®ä¾èµ–** | é«˜ | æé«˜ | å•è¡¨è§†å›¾ |
| **å¤–é”®ä¾èµ–** | ä¸­ | é«˜ | è¿æ¥è§†å›¾ |
| **å‡½æ•°ä¾èµ–** | ä¸­ | é«˜ | èšåˆè§†å›¾ |

#### 5.4.2 ä¼ é€’æ›´æ–°æ€§èƒ½

| æ“ä½œ | å®Œå…¨åˆ·æ–° | ä¼ é€’æ›´æ–° | æ€§èƒ½æå‡ |
|------|---------|---------|---------|
| **æ’å…¥ç»´æŠ¤** | 5000ms | 1ms | 5000x |
| **æ›´æ–°ç»´æŠ¤** | 5000ms | 2ms | 2500x |
| **åˆ é™¤ç»´æŠ¤** | 5000ms | 1ms | 5000x |

### 5.5 æœ€ä½³å®è·µ

#### 5.5.1 é”®ä¾èµ–è®¾è®¡åŸåˆ™

1. **ç¡®ä¿ä¸»é”®åŒ…å«**ï¼š
   - ç‰©åŒ–è§†å›¾å¿…é¡»åŒ…å«åŸºç¡€è¡¨çš„ä¸»é”®
   - ä¸»é”®ä¿è¯è¡Œçš„å”¯ä¸€æ ‡è¯†

2. **è®¾è®¡å”¯ä¸€ç´¢å¼•**ï¼š
   - åˆ›å»ºå”¯ä¸€ç´¢å¼•æ”¯æŒé”®ä¾èµ–
   - å”¯ä¸€ç´¢å¼•ä¿è¯ä¼ é€’æ›´æ–°çš„æ­£ç¡®æ€§

3. **éªŒè¯é”®ä¾èµ–**ï¼š

   ```sql
   -- æ£€æŸ¥å”¯ä¸€çº¦æŸ
   SELECT conname, contype
   FROM pg_constraint
   WHERE conrelid = 'mv_account_summary'::regclass
     AND contype IN ('p', 'u');
   ```

#### 5.5.2 ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥

1. **ä½¿ç”¨ON CONFLICT**ï¼š

   ```sql
   -- é«˜æ•ˆçš„ä¼ é€’æ›´æ–°
   INSERT INTO mv_account_summary ...
   ON CONFLICT (account_id) DO UPDATE
   SET total_amount = mv_account_summary.total_amount + NEW.amount;
   ```

2. **æ‰¹é‡æ›´æ–°ä¼˜åŒ–**ï¼š

   ```sql
   -- æ‰¹é‡æ’å…¥æ—¶ä½¿ç”¨æ‰¹é‡æ›´æ–°
   INSERT INTO mv_account_summary ...
   ON CONFLICT (account_id) DO UPDATE
   SET total_amount = mv_account_summary.total_amount + EXCLUDED.total_amount;
   ```

3. **ç›‘æ§ç»´æŠ¤æ€§èƒ½**ï¼š

   ```sql
   -- ç›‘æ§è§¦å‘å™¨æ‰§è¡Œæ—¶é—´
   SELECT * FROM pg_stat_user_tables
   WHERE relname = 'transactions';
   ```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Gupta, A., & Mumick, I. S. (1995). "Maintenance of Materialized Views: Problems, Techniques, and Applications."**
  - ä¼šè®®: IEEE Data Engineering Bulletin 1995
  - **é‡è¦æ€§**: ç‰©åŒ–è§†å›¾ç»´æŠ¤çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¢é‡ç»´æŠ¤ç®—æ³•å’Œå¯è‡ªç»´æŠ¤æ€§ç†è®º

- **Blakeley, J. A., et al. (1986). "On the Correctness Criteria for Updating Materialized Views."**
  - ä¼šè®®: SIGMOD 1986
  - **é‡è¦æ€§**: ç‰©åŒ–è§†å›¾æ›´æ–°çš„æ­£ç¡®æ€§æ ‡å‡†
  - **æ ¸å¿ƒè´¡çŒ®**: å®šä¹‰äº†å¯ç»´æŠ¤æ€§æ¡ä»¶

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - ç‰©åŒ–è§†å›¾](<https://www.postgresql.org/docs/current/sql-creatematerializedview.html>)**
  - PostgreSQLç‰©åŒ–è§†å›¾å®ç°è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§](./05.04-å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
