# BTreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [BTreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜](#btreeæ’å…¥ä¸å˜å¼-ä¸¥æ ¼å½’çº³è¯æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 B-Treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°](#10-b-treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 B-Treeæ’å…¥ç®—æ³•](#21-b-treeæ’å…¥ç®—æ³•)
    - [2.2 ä¸å˜å¼ç»´æŠ¤](#22-ä¸å˜å¼ç»´æŠ¤)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 æ’å…¥æ“ä½œå½¢å¼åŒ–](#31-æ’å…¥æ“ä½œå½¢å¼åŒ–)
    - [3.2 ä¸å˜å¼å½¢å¼åŒ–](#32-ä¸å˜å¼å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 æ’å…¥ä¸å˜å¼å®šç†](#41-æ’å…¥ä¸å˜å¼å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL B-Treeæ’å…¥](#51-postgresql-b-treeæ’å…¥)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 å½¢å¼åŒ–è¯æ˜ç›¸å…³](#72-å½¢å¼åŒ–è¯æ˜ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 B-Treeæ’å…¥ä¸å˜å¼å·¥ä½œåŸç†æ¦‚è¿°

**B-Treeä¸å˜å¼**ï¼š

B-Treeçš„ä¸å˜å¼æ˜¯ä¿è¯B-Treeæ­£ç¡®æ€§çš„å…³é”®æ€§è´¨ã€‚æ’å…¥æ“ä½œå¿…é¡»ç»´æŠ¤è¿™äº›ä¸å˜å¼ï¼Œå¦åˆ™B-Treeçš„ç»“æ„ä¼šè¢«ç ´åï¼Œå¯¼è‡´æŸ¥è¯¢ç»“æœé”™è¯¯ã€‚

**B-Treeä¸å˜å¼**ï¼š

```mermaid
flowchart TD
    A[B-Treeä¸å˜å¼] --> B[èŠ‚ç‚¹é”®æ•°é™åˆ¶]
    A --> C[é”®é¡ºåºæ€§]
    A --> D[æ ‘å¹³è¡¡æ€§]
    B --> E[æœ€å°é”®æ•°: âŒˆm/2âŒ‰-1]
    B --> F[æœ€å¤§é”®æ•°: m-1]
    C --> G[å·¦å­æ ‘ < é”® < å³å­æ ‘]
    D --> H[æ‰€æœ‰å¶å­èŠ‚ç‚¹åŒå±‚]
    E --> I[ç»“æ„æ­£ç¡®æ€§]
    F --> I
    G --> I
    H --> I

    style A fill:#FFD700
    style I fill:#87CEEB
```

**æ’å…¥æ“ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥é”®å€¼] --> B[æŸ¥æ‰¾æ’å…¥ä½ç½®]
    B --> C{èŠ‚ç‚¹æœªæ»¡?}
    C -->|æ˜¯| D[ç›´æ¥æ’å…¥]
    C -->|å¦| E[èŠ‚ç‚¹åˆ†è£‚]
    E --> F[å‘ä¸Šä¼ æ’­]
    F --> G{æ ¹èŠ‚ç‚¹åˆ†è£‚?}
    G -->|æ˜¯| H[åˆ›å»ºæ–°æ ¹]
    G -->|å¦| F
    D --> I[éªŒè¯ä¸å˜å¼]
    H --> I
    I --> J{ä¸å˜å¼æ»¡è¶³?}
    J -->|æ˜¯| K[æ’å…¥æˆåŠŸ]
    J -->|å¦| L[æ’å…¥å¤±è´¥]

    style A fill:#FFD700
    style I fill:#90EE90
    style K fill:#87CEEB
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **ä¸å˜å¼å®šä¹‰**ï¼šB-Treeä¸å˜å¼çš„ä¸¥æ ¼æ•°å­¦å®šä¹‰
- **æ’å…¥ç®—æ³•**ï¼šB-Treeæ’å…¥æ“ä½œçš„ç®—æ³•æè¿°
- **å½’çº³è¯æ˜**ï¼šä½¿ç”¨æ•°å­¦å½’çº³æ³•ä¸¥æ ¼è¯æ˜æ’å…¥æ“ä½œç»´æŠ¤ä¸å˜å¼
- **æ­£ç¡®æ€§ä¿è¯**ï¼šè¯æ˜æ’å…¥æ“ä½œçš„æ­£ç¡®æ€§

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 B-Treeæ’å…¥ç®—æ³•

**æ’å…¥ç®—æ³•**ï¼š

```haskell
-- B-Treeæ’å…¥
insert :: BTree -> Key -> Value -> BTree
insert tree key value =
    let (newTree, split) = insertNode(tree.root, key, value)
    in if split then
        createNewRoot(newTree)
    else
        newTree

-- èŠ‚ç‚¹æ’å…¥
insertNode :: Node -> Key -> Value -> (Node, Bool)
insertNode node key value =
    if isLeaf(node) then
        insertIntoLeaf(node, key, value)
    else
        let (child, split) = insertNode(findChild(node, key), key, value)
        in if split then
            splitNode(node, child)
        else
            (updateChild(node, child), False)
```

**æ’å…¥æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ’å…¥é”®å€¼] --> B[æŸ¥æ‰¾æ’å…¥ä½ç½®]
    B --> C{å¶å­èŠ‚ç‚¹?}
    C -->|æ˜¯| D{èŠ‚ç‚¹æœªæ»¡?}
    C -->|å¦| E[é€’å½’æ’å…¥å­èŠ‚ç‚¹]
    D -->|æ˜¯| F[ç›´æ¥æ’å…¥]
    D -->|å¦| G[èŠ‚ç‚¹åˆ†è£‚]
    E --> H{å­èŠ‚ç‚¹åˆ†è£‚?}
    H -->|æ˜¯| G
    H -->|å¦| I[æ›´æ–°èŠ‚ç‚¹]
    G --> J[å‘ä¸Šä¼ æ’­]
    J --> K{æ ¹èŠ‚ç‚¹åˆ†è£‚?}
    K -->|æ˜¯| L[åˆ›å»ºæ–°æ ¹]
    K -->|å¦| I
    F --> M[éªŒè¯ä¸å˜å¼]
    I --> M
    L --> M

    style A fill:#FFD700
    style M fill:#90EE90
```

### 2.2 ä¸å˜å¼ç»´æŠ¤

**ä¸å˜å¼ç»´æŠ¤ç­–ç•¥**ï¼š

| ä¸å˜å¼ | ç»´æŠ¤æ–¹æ³• | éªŒè¯æ—¶æœº |
|--------|---------|---------|
| **é”®æ•°é™åˆ¶** | èŠ‚ç‚¹åˆ†è£‚ | æ’å…¥å |
| **é”®é¡ºåº** | æœ‰åºæ’å…¥ | æ’å…¥æ—¶ |
| **æ ‘å¹³è¡¡** | åˆ†è£‚ä¼ æ’­ | åˆ†è£‚å |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 æ’å…¥æ“ä½œå½¢å¼åŒ–

**æ’å…¥æ“ä½œ**ï¼š

```haskell
-- æ’å…¥æ“ä½œå½¢å¼åŒ–
insert(T, k, v) =
    let T' = insertIntoTree(T, k, v)
    in
        if violatesInvariant(T') then
            fixInvariant(T')
        else
            T'
```

### 3.2 ä¸å˜å¼å½¢å¼åŒ–

**ä¸å˜å¼**ï¼š

```haskell
-- ä¸å˜å¼å½¢å¼åŒ–
Invariant(T) =
    forall node n in T:
        âŒˆm/2âŒ‰ - 1 <= |n.keys| <= m - 1
        and
        keys(n) are sorted
        and
        all leaves at same level
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 æ’å…¥ä¸å˜å¼å®šç†

**å®šç†**ï¼šB-Treeæ’å…¥æ“ä½œç»´æŠ¤æ‰€æœ‰ä¸å˜å¼ã€‚

**å½’çº³è¯æ˜**ï¼š

**åŸºç¡€æƒ…å†µ**ï¼šç©ºæ ‘æ’å…¥åæ»¡è¶³ä¸å˜å¼ã€‚

**å½’çº³æ­¥éª¤**ï¼š

1. å‡è®¾æ’å…¥å‰æ ‘æ»¡è¶³ä¸å˜å¼
2. æ’å…¥æ“ä½œå¯èƒ½è¿åé”®æ•°é™åˆ¶
3. èŠ‚ç‚¹åˆ†è£‚æ¢å¤é”®æ•°é™åˆ¶
4. åˆ†è£‚å¯èƒ½å‘ä¸Šä¼ æ’­ï¼Œä½†æœ€ç»ˆæ¢å¤ä¸å˜å¼
5. å› æ­¤æ’å…¥åæ ‘ä»æ»¡è¶³ä¸å˜å¼

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ’å…¥ä¸å˜å¼] --> B[åŸºç¡€æƒ…å†µ]
    A --> C[å½’çº³æ­¥éª¤]
    B --> D[ç©ºæ ‘æ’å…¥]
    C --> E[å‡è®¾æ’å…¥å‰æ»¡è¶³]
    E --> F[æ’å…¥æ“ä½œ]
    F --> G{è¿åä¸å˜å¼?}
    G -->|æ˜¯| H[èŠ‚ç‚¹åˆ†è£‚]
    G -->|å¦| I[æ»¡è¶³ä¸å˜å¼]
    H --> J[æ¢å¤ä¸å˜å¼]
    J --> I

    style A fill:#FFD700
    style I fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL B-Treeæ’å…¥

**B-Treeç»´æŠ¤**ï¼š

```sql
-- æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨ç»´æŠ¤B-Treeï¼‰
INSERT INTO accounts (id, name, balance)
VALUES (1, 'Alice', 1000.00);

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨
EXPLAIN SELECT * FROM accounts WHERE id = 1;
-- æ˜¾ç¤ºä½¿ç”¨B-Treeç´¢å¼•

-- ç›‘æ§ç´¢å¼•è†¨èƒ€
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE indexname LIKE 'idx_%';
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Bayer, R., & McCreight, E. (1972). "Organization and Maintenance of Large Ordered Indexes."**
  - ä¼šè®®: Acta Informatica 1972
  - **é‡è¦æ€§**: B-Treeæ•°æ®ç»“æ„çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†B-Treeæ•°æ®ç»“æ„å’Œæ’å…¥ç®—æ³•

- **Comer, D. (1979). "The Ubiquitous B-Tree."**
  - ä¼šè®®: ACM Computing Surveys 1979
  - **é‡è¦æ€§**: B-Treeçš„ç»¼è¿°æ€§è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†B-Treeçš„æ€§è´¨å’Œæ“ä½œ

### 7.2 å½¢å¼åŒ–è¯æ˜ç›¸å…³

- **Leis, V., et al. (2013). "The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases."**
  - ä¼šè®®: ICDE 2013
  - **é‡è¦æ€§**: ç°ä»£ç´¢å¼•ç»“æ„çš„å½¢å¼åŒ–åˆ†æ
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†ç´¢å¼•ç»“æ„å½¢å¼åŒ–åˆ†æçš„æ–¹æ³•

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - B-Treeç´¢å¼•](<https://www.postgresql.org/docs/current/btree.html>)**
  - PostgreSQL B-Treeç´¢å¼•å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [ç´¢å¼•ç»“æ„æ­£ç¡®æ€§-BTree_GiST_GiNä¸å˜å¼ä¸è¯æ˜](./05.02-ç´¢å¼•ç»“æ„æ­£ç¡®æ€§-BTree_GiST_GiNä¸å˜å¼ä¸è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
