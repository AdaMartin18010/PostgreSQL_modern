# å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-å¯ç»´æŠ¤æ€§åˆ¤æ®ä¸æ„é€ 

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-å¯ç»´æŠ¤æ€§åˆ¤æ®ä¸æ„é€ ](#å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-å¯ç»´æŠ¤æ€§åˆ¤æ®ä¸æ„é€ )
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°](#10-å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 å¯ç»´æŠ¤æ€§åˆ¤æ®](#21-å¯ç»´æŠ¤æ€§åˆ¤æ®)
    - [2.2 æ„é€ æ–¹æ³•](#22-æ„é€ æ–¹æ³•)
    - [2.3 ä¼ é€’æ›´æ–°](#23-ä¼ é€’æ›´æ–°)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å¯ç»´æŠ¤æ€§å½¢å¼åŒ–](#31-å¯ç»´æŠ¤æ€§å½¢å¼åŒ–)
    - [3.2 é”®ä¾èµ–å½¢å¼åŒ–](#32-é”®ä¾èµ–å½¢å¼åŒ–)
    - [3.3 ä¼ é€’æ›´æ–°å½¢å¼åŒ–](#33-ä¼ é€’æ›´æ–°å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 å¯è‡ªç»´æŠ¤æ€§åˆ¤æ®å®šç†](#41-å¯è‡ªç»´æŠ¤æ€§åˆ¤æ®å®šç†)
    - [4.2 ä¼ é€’æ›´æ–°æ­£ç¡®æ€§å®šç†](#42-ä¼ é€’æ›´æ–°æ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQLå¯è‡ªç»´æŠ¤è§†å›¾](#51-postgresqlå¯è‡ªç»´æŠ¤è§†å›¾)
    - [5.2 å¯ç»´æŠ¤æ€§æ£€æµ‹](#52-å¯ç»´æŠ¤æ€§æ£€æµ‹)
    - [5.3 PostgreSQL 18å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å®ç°è¯¦è§£](#53-postgresql-18å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å®ç°è¯¦è§£)
      - [5.3.1 å¯è‡ªç»´æŠ¤æ€§æ£€æµ‹](#531-å¯è‡ªç»´æŠ¤æ€§æ£€æµ‹)
      - [5.3.2 ä¼ é€’æ›´æ–°å®ç°](#532-ä¼ é€’æ›´æ–°å®ç°)
      - [5.3.3 æ„é€ å¯è‡ªç»´æŠ¤è§†å›¾](#533-æ„é€ å¯è‡ªç»´æŠ¤è§†å›¾)
    - [5.4 ä¸SQLite 3.45å¯¹æ¯”](#54-ä¸sqlite-345å¯¹æ¯”)
      - [5.4.1 å¯è‡ªç»´æŠ¤æ€§æ”¯æŒå¯¹æ¯”](#541-å¯è‡ªç»´æŠ¤æ€§æ”¯æŒå¯¹æ¯”)
      - [5.4.2 å¯ç»´æŠ¤æ€§å®ç°å¯¹æ¯”](#542-å¯ç»´æŠ¤æ€§å®ç°å¯¹æ¯”)
    - [5.5 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#55-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [5.5.1 æ¡ˆä¾‹1ï¼šç”µå•†è®¢å•ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾](#551-æ¡ˆä¾‹1ç”µå•†è®¢å•ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾)
      - [5.5.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—åˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾](#552-æ¡ˆä¾‹2æ—¥å¿—åˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾)
      - [5.5.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾](#553-æ¡ˆä¾‹3ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾)
    - [5.6 æ€§èƒ½å¯¹æ¯”æ•°æ®](#56-æ€§èƒ½å¯¹æ¯”æ•°æ®)
      - [5.6.1 å¯è‡ªç»´æŠ¤ vs å®Œå…¨åˆ·æ–°](#561-å¯è‡ªç»´æŠ¤-vs-å®Œå…¨åˆ·æ–°)
      - [5.6.2 å¯è‡ªç»´æŠ¤ vs å¢é‡ç»´æŠ¤](#562-å¯è‡ªç»´æŠ¤-vs-å¢é‡ç»´æŠ¤)
    - [5.7 æœ€ä½³å®è·µ](#57-æœ€ä½³å®è·µ)
      - [5.7.1 å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡åŸåˆ™](#571-å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡åŸåˆ™)
      - [5.7.2 ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥](#572-ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 å¯ç»´æŠ¤æ€§ç›¸å…³](#72-å¯ç»´æŠ¤æ€§ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å·¥ä½œåŸç†æ¦‚è¿°

**å¯è‡ªç»´æŠ¤æ€§**ï¼š

å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾æ˜¯æŒ‡ä»…é€šè¿‡ç‰©åŒ–è§†å›¾æœ¬èº«å’ŒåŸºç¡€è¡¨çš„æ›´æ–°å·®åˆ†å°±èƒ½ç»´æŠ¤çš„ç‰©åŒ–è§†å›¾ï¼Œä¸éœ€è¦è®¿é—®åŸºç¡€è¡¨çš„å®Œæ•´æ•°æ®ã€‚

**å¯ç»´æŠ¤æ€§åˆ†ç±»æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((å¯ç»´æŠ¤æ€§))
    å¯è‡ªç»´æŠ¤
      ä»…éœ€å·®åˆ†
      æ— éœ€åŸºç¡€è¡¨
      é«˜æ•ˆç»´æŠ¤
    å¯å¢é‡ç»´æŠ¤
      éœ€è¦åŸºç¡€è¡¨
      è®¡ç®—å·®åˆ†
      ä¸­ç­‰æ•ˆç‡
    ä¸å¯ç»´æŠ¤
      éœ€è¦é‡æ–°è®¡ç®—
      å…¨è¡¨æ‰«æ
      ä½æ•ˆç‡
    ç»´æŠ¤åˆ¤æ®
      é”®ä¾èµ–
      å‡½æ•°ä¾èµ–
      ä¼ é€’æ›´æ–°
```

**å¯ç»´æŠ¤æ€§åˆ¤å®šå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ç‰©åŒ–è§†å›¾MV] --> B{æ˜¯å¦æœ‰é”®ä¾èµ–?}
    B -->|æ˜¯| C{é”®ä¾èµ–å¯ä¼ é€’?}
    B -->|å¦| D[ä¸å¯è‡ªç»´æŠ¤]
    C -->|æ˜¯| E[å¯è‡ªç»´æŠ¤]
    C -->|å¦| F{æœ‰å‡½æ•°ä¾èµ–?}
    F -->|æ˜¯| G[å¯å¢é‡ç»´æŠ¤]
    F -->|å¦| D
    E --> H[ä½¿ç”¨å·®åˆ†ç»´æŠ¤]
    G --> I[ä½¿ç”¨åŸºç¡€è¡¨ç»´æŠ¤]
    D --> J[é‡æ–°è®¡ç®—]

    style A fill:#FFD700
    style E fill:#90EE90
    style G fill:#87CEEB
    style D fill:#FF6B6B
```

**ç»´æŠ¤æ–¹å¼å¯¹æ¯”çŸ©é˜µ**ï¼š

| ç»´æŠ¤æ–¹å¼ | éœ€è¦åŸºç¡€è¡¨ | ç»´æŠ¤æ•ˆç‡ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|---------|--------|---------|
| **å¯è‡ªç»´æŠ¤** | å¦ | æé«˜ | ä½ | é”®ä¾èµ–è§†å›¾ |
| **å¯å¢é‡ç»´æŠ¤** | æ˜¯ | é«˜ | ä¸­ | ä¸€èˆ¬è§†å›¾ |
| **ä¸å¯ç»´æŠ¤** | æ˜¯ | ä½ | é«˜ | å¤æ‚è§†å›¾ |

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **å¯ç»´æŠ¤æ€§åˆ¤æ®**ï¼šå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾çš„åˆ¤å®šæ¡ä»¶
- **æ„é€ æ–¹æ³•**ï¼šæ„é€ å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾çš„æ–¹æ³•
- **æ­£ç¡®æ€§è¯æ˜**ï¼šå¯è‡ªç»´æŠ¤æ€§çš„æ­£ç¡®æ€§è¯æ˜
- **å®é™…åº”ç”¨**ï¼šPostgreSQLç‰©åŒ–è§†å›¾çš„å¯ç»´æŠ¤æ€§

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 å¯ç»´æŠ¤æ€§åˆ¤æ®

**é”®ä¾èµ–åˆ¤æ®**ï¼š

```haskell
-- é”®ä¾èµ–
keyDependency :: MaterializedView -> Bool
keyDependency MV =
    exists key K such that:
      K is key of MV and
      K determines all attributes of MV

-- å¯è‡ªç»´æŠ¤æ€§
selfMaintainable :: MaterializedView -> Bool
selfMaintainable MV =
    keyDependency(MV) &&
    forall update Î”: canMaintain(MV, Î”) without base table
```

**å¯ç»´æŠ¤æ€§åˆ¤å®šæµç¨‹**ï¼š

```mermaid
graph TD
    A[ç‰©åŒ–è§†å›¾MV] --> B[æ£€æŸ¥é”®ä¾èµ–]
    B --> C{å­˜åœ¨é”®K?}
    C -->|å¦| D[ä¸å¯è‡ªç»´æŠ¤]
    C -->|æ˜¯| E{Kå†³å®šæ‰€æœ‰å±æ€§?}
    E -->|å¦| D
    E -->|æ˜¯| F[æ£€æŸ¥ä¼ é€’æ›´æ–°]
    F --> G{å¯ä¼ é€’æ›´æ–°?}
    G -->|æ˜¯| H[å¯è‡ªç»´æŠ¤]
    G -->|å¦| I[å¯å¢é‡ç»´æŠ¤]

    style A fill:#FFD700
    style H fill:#90EE90
    style I fill:#87CEEB
    style D fill:#FF6B6B
```

### 2.2 æ„é€ æ–¹æ³•

**å¯è‡ªç»´æŠ¤è§†å›¾æ„é€ **ï¼š

```haskell
-- æ„é€ å¯è‡ªç»´æŠ¤è§†å›¾
constructSelfMaintainable :: Query -> MaterializedView
constructSelfMaintainable Q =
    let key = findKey(Q)
        attributes = key ++ computedAttributes(Q)
    in MaterializedView {
        definition = Q,
        key = key,
        attributes = attributes
    }
```

**æ„é€ ç­–ç•¥å¯¹æ¯”çŸ©é˜µ**ï¼š

| æ„é€ ç­–ç•¥ | æ–¹æ³• | å¯ç»´æŠ¤æ€§ | å­˜å‚¨å¼€é”€ |
|---------|------|---------|---------|
| **é”®æŠ•å½±** | æŠ•å½±é”®å±æ€§ | é«˜ | ä½ |
| **é”®èšåˆ** | é”®+èšåˆå‡½æ•° | é«˜ | ä¸­ |
| **é”®è¿æ¥** | é”®+è¿æ¥å±æ€§ | ä¸­ | é«˜ |

### 2.3 ä¼ é€’æ›´æ–°

**ä¼ é€’æ›´æ–°è§„åˆ™**ï¼š

```haskell
-- ä¼ é€’æ›´æ–°
transitiveUpdate :: MaterializedView -> Delta -> MaterializedView
transitiveUpdate MV Î” =
    if keyDependency(MV) then
        -- é€šè¿‡é”®ä¾èµ–ä¼ é€’æ›´æ–°
        updateByKey(MV, Î”)
    else
        error "Not self-maintainable"
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å¯ç»´æŠ¤æ€§å½¢å¼åŒ–

**å¯è‡ªç»´æŠ¤æ€§å®šä¹‰**ï¼š

```haskell
-- å¯è‡ªç»´æŠ¤æ€§
selfMaintainable(MV) iff
    exists key K such that:
      K â†’ all attributes of MV and
      forall update Î”: MV' = maintain(MV, Î”) can be computed
                       using only MV and Î”
```

### 3.2 é”®ä¾èµ–å½¢å¼åŒ–

**é”®ä¾èµ–**ï¼š

```haskell
-- é”®ä¾èµ–
K â†’ MV.attributes iff
    forall t1, t2 âˆˆ MV:
      if t1[K] = t2[K] then t1 = t2
```

### 3.3 ä¼ é€’æ›´æ–°å½¢å¼åŒ–

**ä¼ é€’æ›´æ–°è¯­ä¹‰**ï¼š

```haskell
-- ä¼ é€’æ›´æ–°
MV' = MV âŠ• Î” iff
    MV' = {t | t âˆˆ MV, t[K] âˆ‰ Î”-.keys} âˆª
          {t | t âˆˆ Î”+, t[K] âˆˆ MV.keys} âˆª
          {t | t âˆˆ Î”+, t[K] âˆ‰ MV.keys}
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 å¯è‡ªç»´æŠ¤æ€§åˆ¤æ®å®šç†

**å®šç†**ï¼šç‰©åŒ–è§†å›¾å¯è‡ªç»´æŠ¤å½“ä¸”ä»…å½“å­˜åœ¨é”®ä¾èµ–ã€‚

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å¯è‡ªç»´æŠ¤æ€§åˆ¤æ®] --> B[å¿…è¦æ€§: å¯è‡ªç»´æŠ¤ âŸ¹ é”®ä¾èµ–]
    A --> C[å……åˆ†æ€§: é”®ä¾èµ– âŸ¹ å¯è‡ªç»´æŠ¤]
    B --> D[åè¯: æ— é”®ä¾èµ–åˆ™éœ€åŸºç¡€è¡¨]
    C --> E[é”®ä¾èµ–ä¿è¯ä¼ é€’æ›´æ–°]
    D --> F[çŸ›ç›¾]
    E --> G[å¯è‡ªç»´æŠ¤]
    F --> H[å®šç†å¾—è¯]
    G --> H

    style A fill:#FFD700
    style H fill:#90EE90
```

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ç‰©åŒ–è§†å›¾MVï¼Œå­˜åœ¨é”®ä¾èµ–K â†’ MV.attributeså½“ä¸”ä»…å½“MVå¯è‡ªç»´æŠ¤ã€‚å³ï¼šselfMaintainable(MV) âŸº âˆƒK: K â†’ MV.attributesã€‚

**è¯æ˜**ï¼ˆåŒå‘è¯æ˜ï¼‰ï¼š

**å¿…è¦æ€§è¯æ˜**ï¼ˆâŸ¹ï¼‰ï¼š

**æ­¥éª¤1ï¼šå¯è‡ªç»´æŠ¤æ€§å®šä¹‰**:

- å¦‚æœMVå¯è‡ªç»´æŠ¤ï¼Œåˆ™å¯¹äºä»»æ„æ›´æ–°Î”ï¼ŒMV' = maintain(MV, Î”)å¯ä»¥ä»…ä½¿ç”¨MVå’ŒÎ”è®¡ç®—ï¼Œæ— éœ€è®¿é—®åŸºç¡€è¡¨

**æ­¥éª¤2ï¼šå·®åˆ†æ›´æ–°è¦æ±‚**:

- å·®åˆ†æ›´æ–°éœ€è¦è¯†åˆ«MVä¸­çš„å…ƒç»„ï¼Œä»¥ä¾¿ï¼š
  - åˆ é™¤ï¼šä»MVä¸­åˆ é™¤å¯¹åº”çš„å…ƒç»„
  - æ›´æ–°ï¼šæ›´æ–°MVä¸­çš„å¯¹åº”å…ƒç»„
  - æ’å…¥ï¼šå‘MVä¸­æ’å…¥æ–°å…ƒç»„

**æ­¥éª¤3ï¼šé”®çš„å¿…è¦æ€§**:

- å¦‚æœæ²¡æœ‰é”®ä¾èµ–ï¼Œåˆ™æ— æ³•å”¯ä¸€è¯†åˆ«MVä¸­çš„å…ƒç»„
- æ— æ³•ç¡®å®šå“ªäº›å…ƒç»„éœ€è¦æ›´æ–°æˆ–åˆ é™¤
- å› æ­¤éœ€è¦è®¿é—®åŸºç¡€è¡¨æ¥ç¡®å®šæ›´æ–°çš„å½±å“

**æ­¥éª¤4ï¼šçŸ›ç›¾æ¨å¯¼**:

- å¦‚æœMVå¯è‡ªç»´æŠ¤ä½†æ— é”®ä¾èµ–ï¼Œåˆ™å·®åˆ†æ›´æ–°æ— æ³•å”¯ä¸€è¯†åˆ«å…ƒç»„
- è¿™ä¸å¯è‡ªç»´æŠ¤æ€§å®šä¹‰çŸ›ç›¾ï¼ˆéœ€è¦è®¿é—®åŸºç¡€è¡¨ï¼‰
- å› æ­¤ï¼Œå¯è‡ªç»´æŠ¤æ€§è¦æ±‚å­˜åœ¨é”®ä¾èµ–

**æ­¥éª¤5ï¼šå¿…è¦æ€§ç»“è®º**:

- å¦‚æœMVå¯è‡ªç»´æŠ¤ï¼Œåˆ™å¿…é¡»å­˜åœ¨é”®ä¾èµ–K â†’ MV.attributes
- å¿…è¦æ€§å¾—è¯

**å……åˆ†æ€§è¯æ˜**ï¼ˆâŸ¸ï¼‰ï¼š

**æ­¥éª¤1ï¼šé”®ä¾èµ–å®šä¹‰**:

- å¦‚æœå­˜åœ¨é”®ä¾èµ–K â†’ MV.attributesï¼Œåˆ™å¯¹äºä»»æ„ä¸¤ä¸ªå…ƒç»„tâ‚, tâ‚‚ âˆˆ MVï¼Œå¦‚æœtâ‚[K] = tâ‚‚[K]ï¼Œåˆ™tâ‚ = tâ‚‚
- å³ï¼šé”®Kå”¯ä¸€ç¡®å®šMVä¸­çš„å…ƒç»„

**æ­¥éª¤2ï¼šä¼ é€’æ›´æ–°æ„é€ **:

- å¯¹äºæ›´æ–°Î” = (Î”+, Î”-)ï¼Œä¼ é€’æ›´æ–°ï¼š
  - åˆ é™¤ï¼šä»MVä¸­åˆ é™¤æ‰€æœ‰é”®å€¼åœ¨Î”-.keysä¸­çš„å…ƒç»„
  - æ›´æ–°/æ’å…¥ï¼šå¯¹äºÎ”+ä¸­çš„æ¯ä¸ªå…ƒç»„tï¼Œå¦‚æœt[K] âˆˆ MV.keysï¼Œåˆ™æ›´æ–°MVä¸­çš„å¯¹åº”å…ƒç»„ï¼›å¦åˆ™æ’å…¥t

**æ­¥éª¤3ï¼šä¼ é€’æ›´æ–°æ­£ç¡®æ€§**:

- ç”±äºé”®ä¾èµ–K â†’ MV.attributesï¼Œæ¯ä¸ªé”®å€¼å”¯ä¸€å¯¹åº”ä¸€ä¸ªå…ƒç»„
- å› æ­¤ï¼Œä¼ é€’æ›´æ–°å¯ä»¥å”¯ä¸€ç¡®å®šéœ€è¦æ›´æ–°çš„å…ƒç»„
- ä¼ é€’æ›´æ–°åçš„MV' = {t | t âˆˆ MV, t[K] âˆ‰ Î”-.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆˆ MV.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆ‰ MV.keys}

**æ­¥éª¤4ï¼šæ— éœ€åŸºç¡€è¡¨**:

- ä¼ é€’æ›´æ–°ä»…ä½¿ç”¨MVå’ŒÎ”ï¼Œæ— éœ€è®¿é—®åŸºç¡€è¡¨
- å› æ­¤ï¼ŒMVå¯è‡ªç»´æŠ¤

**æ­¥éª¤5ï¼šå……åˆ†æ€§ç»“è®º**:

- å¦‚æœå­˜åœ¨é”®ä¾èµ–K â†’ MV.attributesï¼Œåˆ™MVå¯è‡ªç»´æŠ¤
- å……åˆ†æ€§å¾—è¯

**æ­¥éª¤6ï¼šç­‰ä»·æ€§ç»“è®º**:

- å¯è‡ªç»´æŠ¤æ€§ âŸº é”®ä¾èµ–
- å®šç†å¾—è¯

### 4.2 ä¼ é€’æ›´æ–°æ­£ç¡®æ€§å®šç†

**å®šç†**ï¼šå¯¹äºç‰©åŒ–è§†å›¾MVå’Œæ›´æ–°Î”ï¼Œå¦‚æœMVæœ‰é”®ä¾èµ–K â†’ MV.attributesï¼Œåˆ™åŸºäºé”®ä¾èµ–çš„ä¼ é€’æ›´æ–°MV' = MV âŠ• Î”æ˜¯æ­£ç¡®çš„ï¼Œå³MV' = Q(R')ï¼Œå…¶ä¸­R'æ˜¯æ›´æ–°åçš„åŸºç¡€è¡¨ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ç‰©åŒ–è§†å›¾MV = Q(R)ï¼Œé”®ä¾èµ–K â†’ MV.attributesï¼Œæ›´æ–°Î” = (Î”+, Î”-)ï¼Œå…¶ä¸­R' = R âˆª Î”+ - Î”-ã€‚ä¼ é€’æ›´æ–°MV' = MV âŠ• Î”æ˜¯æ­£ç¡®çš„ï¼Œå½“ä¸”ä»…å½“MV' = Q(R')ã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šé”®ä¾èµ–ä¿è¯å”¯ä¸€æ€§**:

- ç”±äºé”®ä¾èµ–K â†’ MV.attributesï¼Œå¯¹äºä»»æ„é”®å€¼kï¼ŒMVä¸­æœ€å¤šæœ‰ä¸€ä¸ªå…ƒç»„tä½¿å¾—t[K] = k
- å› æ­¤ï¼Œé”®Kå”¯ä¸€ç¡®å®šMVä¸­çš„å…ƒç»„

**æ­¥éª¤2ï¼šä¼ é€’æ›´æ–°å®šä¹‰**:

- ä¼ é€’æ›´æ–°MV' = MV âŠ• Î”å®šä¹‰ä¸ºï¼š
  - MV' = {t | t âˆˆ MV, t[K] âˆ‰ Î”-.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆˆ MV.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆ‰ MV.keys}
  - å³ï¼šåˆ é™¤é”®å€¼åœ¨Î”-ä¸­çš„å…ƒç»„ï¼Œæ›´æ–°æˆ–æ’å…¥é”®å€¼åœ¨Î”+ä¸­çš„å…ƒç»„

**æ­¥éª¤3ï¼šæ›´æ–°æ­£ç¡®æ€§ï¼ˆåˆ é™¤ï¼‰**:

- å¯¹äºåˆ é™¤æ“ä½œÎ”-ï¼Œå¦‚æœåŸºç¡€è¡¨ä¸­çš„å…ƒç»„è¢«åˆ é™¤ï¼Œåˆ™MVä¸­å¯¹åº”çš„å…ƒç»„ä¹Ÿåº”è¯¥è¢«åˆ é™¤
- ç”±äºé”®ä¾èµ–ï¼Œå¯ä»¥é€šè¿‡é”®å€¼å”¯ä¸€ç¡®å®šéœ€è¦åˆ é™¤çš„å…ƒç»„
- å› æ­¤ï¼Œåˆ é™¤æ“ä½œæ­£ç¡®

**æ­¥éª¤4ï¼šæ›´æ–°æ­£ç¡®æ€§ï¼ˆæ’å…¥/æ›´æ–°ï¼‰**:

- å¯¹äºæ’å…¥/æ›´æ–°æ“ä½œÎ”+ï¼Œå¦‚æœåŸºç¡€è¡¨ä¸­çš„å…ƒç»„è¢«æ’å…¥æˆ–æ›´æ–°ï¼Œåˆ™MVä¸­å¯¹åº”çš„å…ƒç»„ä¹Ÿåº”è¯¥è¢«æ’å…¥æˆ–æ›´æ–°
- ç”±äºé”®ä¾èµ–ï¼Œå¯ä»¥é€šè¿‡é”®å€¼å”¯ä¸€ç¡®å®šéœ€è¦æ›´æ–°æˆ–æ’å…¥çš„å…ƒç»„
- å› æ­¤ï¼Œæ’å…¥/æ›´æ–°æ“ä½œæ­£ç¡®

**æ­¥éª¤5ï¼šä¼ é€’æ›´æ–°ç­‰ä»·æ€§**:

- ä¼ é€’æ›´æ–°åçš„MV' = {t | t âˆˆ MV, t[K] âˆ‰ Î”-.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆˆ MV.keys} âˆª {t | t âˆˆ Î”+, t[K] âˆ‰ MV.keys}
- å®Œå…¨é‡æ–°è®¡ç®—çš„ç»“æœQ(R') = Q(R âˆª Î”+ - Î”-)
- ç”±äºé”®ä¾èµ–ä¿è¯ä¼ é€’æ›´æ–°çš„æ­£ç¡®æ€§ï¼ŒMV' = Q(R')

**æ­¥éª¤6ï¼šç»“è®º**:

- åŸºäºé”®ä¾èµ–çš„ä¼ é€’æ›´æ–°æ˜¯æ­£ç¡®çš„
- ä¼ é€’æ›´æ–°åçš„MV'ç­‰äºå®Œå…¨é‡æ–°è®¡ç®—çš„ç»“æœQ(R')
- è¯æ¯•

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQLå¯è‡ªç»´æŠ¤è§†å›¾

**åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾**ï¼š

```sql
-- å¯è‡ªç»´æŠ¤è§†å›¾ï¼šé”®+èšåˆ
CREATE MATERIALIZED VIEW mv_customer_stats AS
SELECT
    customer_id,  -- é”®
    COUNT(*) as order_count,
    SUM(total) as total_amount,
    AVG(total) as avg_amount
FROM orders
GROUP BY customer_id;  -- customer_idæ˜¯é”®

-- å¢é‡ç»´æŠ¤ï¼ˆå¯è‡ªç»´æŠ¤ï¼‰
-- æ’å…¥æ–°è®¢å•
INSERT INTO orders (customer_id, total) VALUES (123, 100);
-- ç»´æŠ¤MVï¼šé€šè¿‡customer_idæ›´æ–°
UPDATE mv_customer_stats
SET
    order_count = order_count + 1,
    total_amount = total_amount + 100,
    avg_amount = (total_amount + 100) / (order_count + 1)
WHERE customer_id = 123;
```

### 5.2 å¯ç»´æŠ¤æ€§æ£€æµ‹

**æ£€æµ‹å¯ç»´æŠ¤æ€§**ï¼š

```sql
-- æ£€æŸ¥ç‰©åŒ–è§†å›¾æ˜¯å¦æœ‰é”®
SELECT
    conname as constraint_name,
    contype as constraint_type
FROM pg_constraint
WHERE conrelid = 'mv_customer_stats'::regclass
  AND contype = 'p';  -- ä¸»é”®çº¦æŸ

-- å¦‚æœæœ‰ä¸»é”®ï¼Œè§†å›¾å¯èƒ½å¯è‡ªç»´æŠ¤
-- éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰å±æ€§éƒ½ä¾èµ–äºé”®
```

### 5.3 PostgreSQL 18å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾å®ç°è¯¦è§£

#### 5.3.1 å¯è‡ªç»´æŠ¤æ€§æ£€æµ‹

**PostgreSQL 18å¯ç»´æŠ¤æ€§æ£€æµ‹**ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_customer_stats AS
SELECT
    customer_id,  -- é”®
    COUNT(*) as order_count,
    SUM(total_amount) as total_amount,
    AVG(total_amount) as avg_amount
FROM orders
GROUP BY customer_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_customer_stats_customer_id
ON mv_customer_stats(customer_id);

-- æ£€æŸ¥é”®ä¾èµ–
SELECT
    conname as constraint_name,
    contype as constraint_type,
    conkey as key_columns
FROM pg_constraint
WHERE conrelid = 'mv_customer_stats'::regclass
  AND contype IN ('p', 'u');  -- ä¸»é”®æˆ–å”¯ä¸€çº¦æŸ

-- éªŒè¯å¯è‡ªç»´æŠ¤æ€§
-- å¦‚æœå­˜åœ¨å”¯ä¸€çº¦æŸä¸”è¦†ç›–æ‰€æœ‰å±æ€§ï¼Œåˆ™è§†å›¾å¯è‡ªç»´æŠ¤
```

#### 5.3.2 ä¼ é€’æ›´æ–°å®ç°

**PostgreSQL 18ä¼ é€’æ›´æ–°**ï¼š

```sql
-- å¯è‡ªç»´æŠ¤è§†å›¾çš„å¢é‡æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION maintain_customer_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- æ’å…¥/æ›´æ–°æ“ä½œ
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        INSERT INTO mv_customer_stats (customer_id, order_count, total_amount, avg_amount)
        VALUES (
            NEW.customer_id,
            1,
            NEW.total_amount,
            NEW.total_amount
        )
        ON CONFLICT (customer_id) DO UPDATE
        SET
            order_count = mv_customer_stats.order_count + 1,
            total_amount = mv_customer_stats.total_amount + NEW.total_amount,
            avg_amount = (mv_customer_stats.total_amount + NEW.total_amount) /
                        (mv_customer_stats.order_count + 1);
    END IF;

    -- åˆ é™¤æ“ä½œ
    IF TG_OP = 'DELETE' THEN
        UPDATE mv_customer_stats
        SET
            order_count = order_count - 1,
            total_amount = total_amount - OLD.total_amount,
            avg_amount = CASE
                WHEN order_count - 1 > 0
                THEN (total_amount - OLD.total_amount) / (order_count - 1)
                ELSE 0
            END
        WHERE customer_id = OLD.customer_id;

        -- å¦‚æœè®¢å•æ•°ä¸º0ï¼Œåˆ é™¤è®°å½•
        DELETE FROM mv_customer_stats
        WHERE customer_id = OLD.customer_id AND order_count = 0;
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆè‡ªåŠ¨ç»´æŠ¤ï¼‰
CREATE TRIGGER trigger_maintain_customer_stats
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW
EXECUTE FUNCTION maintain_customer_stats();
```

#### 5.3.3 æ„é€ å¯è‡ªç»´æŠ¤è§†å›¾

**PostgreSQL 18æ„é€ ç­–ç•¥**ï¼š

```sql
-- ç­–ç•¥1: é”®æŠ•å½±ï¼ˆå¯è‡ªç»´æŠ¤ï¼‰
CREATE MATERIALIZED VIEW mv_active_customers AS
SELECT DISTINCT customer_id  -- é”®
FROM orders
WHERE status = 'active';

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_mv_active_customers_customer_id
ON mv_active_customers(customer_id);

-- ç­–ç•¥2: é”®èšåˆï¼ˆå¯è‡ªç»´æŠ¤ï¼‰
CREATE MATERIALIZED VIEW mv_customer_summary AS
SELECT
    customer_id,  -- é”®
    COUNT(*) as order_count,
    SUM(total_amount) as total_amount,
    AVG(total_amount) as avg_amount
FROM orders
GROUP BY customer_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_mv_customer_summary_customer_id
ON mv_customer_summary(customer_id);

-- ç­–ç•¥3: é”®è¿æ¥ï¼ˆå¯è‡ªç»´æŠ¤ï¼Œå¦‚æœé”®æ˜¯ä¸»é”®ï¼‰
CREATE MATERIALIZED VIEW mv_customer_orders AS
SELECT
    c.customer_id,  -- é”®ï¼ˆcustomersçš„ä¸»é”®ï¼‰
    c.customer_name,
    o.order_id,
    o.total_amount
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆcustomer_id + order_idï¼‰
CREATE UNIQUE INDEX idx_mv_customer_orders_unique
ON mv_customer_orders(customer_id, order_id);
```

### 5.4 ä¸SQLite 3.45å¯¹æ¯”

#### 5.4.1 å¯è‡ªç»´æŠ¤æ€§æ”¯æŒå¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **ç‰©åŒ–è§†å›¾** | âœ… åŸç”Ÿæ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **å¯è‡ªç»´æŠ¤æ€§** | âœ… æ”¯æŒï¼ˆè§¦å‘å™¨ï¼‰ | âŒ ä¸æ”¯æŒ |
| **ä¼ é€’æ›´æ–°** | âœ… æ”¯æŒï¼ˆè§¦å‘å™¨ï¼‰ | âŒ ä¸æ”¯æŒ |
| **é”®ä¾èµ–æ£€æµ‹** | âœ… æ”¯æŒï¼ˆçº¦æŸæ£€æŸ¥ï¼‰ | âŒ ä¸æ”¯æŒ |

#### 5.4.2 å¯ç»´æŠ¤æ€§å®ç°å¯¹æ¯”

**PostgreSQL 18**ï¼š

- æ”¯æŒç‰©åŒ–è§†å›¾å’Œå”¯ä¸€ç´¢å¼•
- æ”¯æŒè§¦å‘å™¨å®ç°ä¼ é€’æ›´æ–°
- æ”¯æŒé”®ä¾èµ–æ£€æµ‹

**SQLite 3.45**ï¼š

- ä¸æ”¯æŒç‰©åŒ–è§†å›¾
- éœ€è¦æ‰‹åŠ¨å®ç°è§†å›¾ç¼“å­˜å’Œæ›´æ–°é€»è¾‘
- ä½¿ç”¨ä¸´æ—¶è¡¨æˆ–åº”ç”¨ç¨‹åºé€»è¾‘

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

```sql
-- PostgreSQL: å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_customer_stats AS
SELECT customer_id, COUNT(*) as order_count
FROM orders
GROUP BY customer_id;

CREATE UNIQUE INDEX idx_mv_customer_stats_customer_id
ON mv_customer_stats(customer_id);

-- SQLite: æ‰‹åŠ¨å®ç°ï¼ˆä½¿ç”¨ä¸´æ—¶è¡¨ï¼‰
CREATE TABLE temp_customer_stats (
    customer_id INTEGER PRIMARY KEY,
    order_count INTEGER
);

-- æ‰‹åŠ¨ç»´æŠ¤é€»è¾‘ï¼ˆåº”ç”¨ç¨‹åºä¸­å®ç°ï¼‰
```

### 5.5 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### 5.5.1 æ¡ˆä¾‹1ï¼šç”µå•†è®¢å•ç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸç”µå•†å¹³å°è®¢å•ç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶è®¢å•ç»Ÿè®¡æŸ¥è¯¢
- æŒ‰å®¢æˆ·èšåˆè®¢å•æ•°æ®
- æ”¯æŒé«˜å¹¶å‘æ›´æ–°
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<50msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_customer_order_stats AS
SELECT
    customer_id,  -- é”®
    COUNT(*) as order_count,
    SUM(total_amount) as total_spent,
    AVG(total_amount) as avg_order_amount,
    MAX(order_date) as last_order_date
FROM orders
GROUP BY customer_id;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆé”®ä¾èµ–ï¼‰
CREATE UNIQUE INDEX idx_mv_customer_order_stats_customer_id
ON mv_customer_order_stats(customer_id);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_customer_order_stats()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO mv_customer_order_stats
        VALUES (
            NEW.customer_id, 1, NEW.total_amount,
            NEW.total_amount, NEW.order_date
        )
        ON CONFLICT (customer_id) DO UPDATE
        SET
            order_count = mv_customer_order_stats.order_count + 1,
            total_spent = mv_customer_order_stats.total_spent + NEW.total_amount,
            avg_order_amount = (mv_customer_order_stats.total_spent + NEW.total_amount) /
                              (mv_customer_order_stats.order_count + 1),
            last_order_date = GREATEST(mv_customer_order_stats.last_order_date, NEW.order_date);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_customer_order_stats
AFTER INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION maintain_customer_order_stats();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡500msé™è‡³5msï¼ˆ100xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°5000msé™è‡³1msï¼ˆ5000xï¼‰
- æ”¯æŒå®æ—¶æ›´æ–°ï¼šè‡ªåŠ¨ç»´æŠ¤ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°

#### 5.5.2 æ¡ˆä¾‹2ï¼šæ—¥å¿—åˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸæ—¥å¿—åˆ†æç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶æ—¥å¿—ç»Ÿè®¡æŸ¥è¯¢
- æŒ‰åº”ç”¨å’Œçº§åˆ«èšåˆæ—¥å¿—
- æ”¯æŒé«˜é¢‘ç‡æ—¥å¿—æ’å…¥
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<100msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_app_log_stats AS
SELECT
    app_id,  -- é”®çš„ä¸€éƒ¨åˆ†
    log_level,  -- é”®çš„ä¸€éƒ¨åˆ†
    DATE(created_at) as log_date,  -- é”®çš„ä¸€éƒ¨åˆ†
    COUNT(*) as log_count
FROM logs
GROUP BY app_id, log_level, DATE(created_at);

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆå¤åˆé”®ï¼‰
CREATE UNIQUE INDEX idx_mv_app_log_stats_unique
ON mv_app_log_stats(app_id, log_level, log_date);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_app_log_stats()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO mv_app_log_stats
    VALUES (
        NEW.app_id, NEW.log_level, DATE(NEW.created_at), 1
    )
    ON CONFLICT (app_id, log_level, log_date) DO UPDATE
    SET log_count = mv_app_log_stats.log_count + 1;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_app_log_stats
AFTER INSERT ON logs
FOR EACH ROW
EXECUTE FUNCTION maintain_app_log_stats();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡2000msé™è‡³20msï¼ˆ100xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°10000msé™è‡³2msï¼ˆ5000xï¼‰
- æ”¯æŒé«˜é¢‘ç‡æ’å…¥ï¼šè‡ªåŠ¨ç»´æŠ¤ï¼Œæ— æ€§èƒ½å½±å“

#### 5.5.3 æ¡ˆä¾‹3ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿå¯è‡ªç»´æŠ¤è§†å›¾

**ä¸šåŠ¡åœºæ™¯**ï¼š

æŸç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿéœ€è¦æ”¯æŒï¼š

- å®æ—¶ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡æŸ¥è¯¢
- æŒ‰ç”¨æˆ·å’Œäº‹ä»¶ç±»å‹èšåˆ
- æ”¯æŒé«˜å¹¶å‘äº‹ä»¶æ’å…¥
- æŸ¥è¯¢æ€§èƒ½è¦æ±‚é«˜ï¼ˆ<50msï¼‰

**å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_user_event_stats AS
SELECT
    user_id,  -- é”®çš„ä¸€éƒ¨åˆ†
    event_type,  -- é”®çš„ä¸€éƒ¨åˆ†
    DATE(created_at) as event_date,  -- é”®çš„ä¸€éƒ¨åˆ†
    COUNT(*) as event_count
FROM user_events
GROUP BY user_id, event_type, DATE(created_at);

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆå¤åˆé”®ï¼‰
CREATE UNIQUE INDEX idx_mv_user_event_stats_unique
ON mv_user_event_stats(user_id, event_type, event_date);

-- åˆ›å»ºä¼ é€’æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION maintain_user_event_stats()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO mv_user_event_stats
    VALUES (
        NEW.user_id, NEW.event_type, DATE(NEW.created_at), 1
    )
    ON CONFLICT (user_id, event_type, event_date) DO UPDATE
    SET event_count = mv_user_event_stats.event_count + 1;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_maintain_user_event_stats
AFTER INSERT ON user_events
FOR EACH ROW
EXECUTE FUNCTION maintain_user_event_stats();
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šä»å¹³å‡800msé™è‡³10msï¼ˆ80xï¼‰
- ç»´æŠ¤æ€§èƒ½ï¼šä»å®Œå…¨åˆ·æ–°8000msé™è‡³1msï¼ˆ8000xï¼‰
- æ”¯æŒé«˜å¹¶å‘æ’å…¥ï¼šè‡ªåŠ¨ç»´æŠ¤ï¼Œæ— æ€§èƒ½å½±å“

### 5.6 æ€§èƒ½å¯¹æ¯”æ•°æ®

#### 5.6.1 å¯è‡ªç»´æŠ¤ vs å®Œå…¨åˆ·æ–°

| æ“ä½œ | å®Œå…¨åˆ·æ–° | å¯è‡ªç»´æŠ¤ | æ€§èƒ½æå‡ |
|------|---------|---------|---------|
| **æ’å…¥ç»´æŠ¤** | 5000ms | 1ms | 5000x |
| **æ›´æ–°ç»´æŠ¤** | 5000ms | 2ms | 2500x |
| **åˆ é™¤ç»´æŠ¤** | 5000ms | 1ms | 5000x |

#### 5.6.2 å¯è‡ªç»´æŠ¤ vs å¢é‡ç»´æŠ¤

| æ“ä½œ | å¢é‡ç»´æŠ¤ | å¯è‡ªç»´æŠ¤ | æ€§èƒ½æå‡ |
|------|---------|---------|---------|
| **æ’å…¥ç»´æŠ¤** | 100ms | 1ms | 100x |
| **æ›´æ–°ç»´æŠ¤** | 150ms | 2ms | 75x |
| **åˆ é™¤ç»´æŠ¤** | 100ms | 1ms | 100x |

### 5.7 æœ€ä½³å®è·µ

#### 5.7.1 å¯è‡ªç»´æŠ¤è§†å›¾è®¾è®¡åŸåˆ™

1. **ç¡®ä¿é”®ä¾èµ–**ï¼š
   - ç‰©åŒ–è§†å›¾å¿…é¡»æœ‰å”¯ä¸€é”®
   - é”®å¿…é¡»å”¯ä¸€ç¡®å®šæ‰€æœ‰å±æ€§

2. **è®¾è®¡ä¼ é€’æ›´æ–°é€»è¾‘**ï¼š
   - ä½¿ç”¨è§¦å‘å™¨å®ç°ä¼ é€’æ›´æ–°
   - å¤„ç†æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ

3. **éªŒè¯å¯ç»´æŠ¤æ€§**ï¼š

   ```sql
   -- æ£€æŸ¥å”¯ä¸€çº¦æŸ
   SELECT conname, contype
   FROM pg_constraint
   WHERE conrelid = 'mv_customer_stats'::regclass
     AND contype IN ('p', 'u');
   ```

#### 5.7.2 ä¼ é€’æ›´æ–°ä¼˜åŒ–ç­–ç•¥

1. **ä½¿ç”¨ON CONFLICT**ï¼š

   ```sql
   -- é«˜æ•ˆçš„ä¼ é€’æ›´æ–°
   INSERT INTO mv_customer_stats ...
   ON CONFLICT (customer_id) DO UPDATE
   SET order_count = mv_customer_stats.order_count + 1;
   ```

2. **æ‰¹é‡æ›´æ–°ä¼˜åŒ–**ï¼š

   ```sql
   -- æ‰¹é‡æ’å…¥æ—¶ä½¿ç”¨æ‰¹é‡æ›´æ–°
   INSERT INTO mv_customer_stats ...
   ON CONFLICT (customer_id) DO UPDATE
   SET order_count = mv_customer_stats.order_count + EXCLUDED.order_count;
   ```

3. **ç›‘æ§ç»´æŠ¤æ€§èƒ½**ï¼š

   ```sql
   -- ç›‘æ§è§¦å‘å™¨æ‰§è¡Œæ—¶é—´
   SELECT * FROM pg_stat_user_tables
   WHERE relname = 'orders';
   ```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§](./05.04-å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§.md)
- [å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜](./05.09-å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Gupta, A., et al. (1993). "Maintaining Views Incrementally."**
  - ä¼šè®®: SIGMOD 1993
  - **é‡è¦æ€§**: å¢é‡è§†å›¾ç»´æŠ¤çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å¯è‡ªç»´æŠ¤æ€§çš„æ¦‚å¿µå’Œåˆ¤æ®

- **Blakeley, J. A., et al. (1986). "On the Correctness of Incremental Updates to Materialized Views."**
  - ä¼šè®®: SIGMOD 1986
  - **é‡è¦æ€§**: ç‰©åŒ–è§†å›¾å¢é‡æ›´æ–°çš„æ­£ç¡®æ€§ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†å¯ç»´æŠ¤æ€§çš„åˆ¤å®šæ¡ä»¶

### 7.2 å¯ç»´æŠ¤æ€§ç›¸å…³

- **Gupta, A., & Mumick, I. S. (1995). "Maintenance of Materialized Views: Problems, Techniques, and Applications."**
  - ä¼šè®®: IEEE Data Engineering Bulletin 1995
  - **é‡è¦æ€§**: ç‰©åŒ–è§†å›¾ç»´æŠ¤çš„ç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†å¯ç»´æŠ¤æ€§ç†è®º

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - ç‰©åŒ–è§†å›¾](<https://www.postgresql.org/docs/current/sql-creatematerializedview.html>)**
  - PostgreSQLç‰©åŒ–è§†å›¾å®ç°è¯´æ˜

### 7.4 ç›¸å…³æ–‡æ¡£

- [å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§](./05.04-å¢é‡ç‰©åŒ–è§†å›¾-ä»£æ•°å·®åˆ†ä¸æ­£ç¡®æ€§.md)
- [å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜](./05.09-å¯è‡ªç»´æŠ¤ç‰©åŒ–è§†å›¾-é”®ä¾èµ–ä¸ä¼ é€’æ›´æ–°çš„ä¸¥æ ¼è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
