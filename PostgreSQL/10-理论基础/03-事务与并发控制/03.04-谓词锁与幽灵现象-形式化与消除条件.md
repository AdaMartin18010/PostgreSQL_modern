# è°“è¯é”ä¸å¹½çµç°è±¡-å½¢å¼åŒ–ä¸æ¶ˆé™¤æ¡ä»¶

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [è°“è¯é”ä¸å¹½çµç°è±¡-å½¢å¼åŒ–ä¸æ¶ˆé™¤æ¡ä»¶](#è°“è¯é”ä¸å¹½çµç°è±¡-å½¢å¼åŒ–ä¸æ¶ˆé™¤æ¡ä»¶)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 è°“è¯é”ä¸å¹½çµç°è±¡å·¥ä½œåŸç†æ¦‚è¿°](#10-è°“è¯é”ä¸å¹½çµç°è±¡å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 è°“è¯é”å®šä¹‰](#21-è°“è¯é”å®šä¹‰)
    - [2.2 å¹½çµç°è±¡å½¢å¼åŒ–](#22-å¹½çµç°è±¡å½¢å¼åŒ–)
    - [2.3 è°“è¯é”æ£€æµ‹](#23-è°“è¯é”æ£€æµ‹)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 è°“è¯é”è¯­ä¹‰](#31-è°“è¯é”è¯­ä¹‰)
    - [3.2 å¹½çµç°è±¡å½¢å¼åŒ–](#32-å¹½çµç°è±¡å½¢å¼åŒ–)
    - [3.3 æ¶ˆé™¤æ¡ä»¶](#33-æ¶ˆé™¤æ¡ä»¶)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 è°“è¯é”æ¶ˆé™¤å¹½çµç°è±¡å®šç†](#41-è°“è¯é”æ¶ˆé™¤å¹½çµç°è±¡å®šç†)
    - [4.2 è°“è¯é”å¤æ‚åº¦](#42-è°“è¯é”å¤æ‚åº¦)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQLä¸­çš„è°“è¯é”](#51-postgresqlä¸­çš„è°“è¯é”)
    - [5.2 ç´¢å¼•ä¸è°“è¯é”ä¼˜åŒ–](#52-ç´¢å¼•ä¸è°“è¯é”ä¼˜åŒ–)
    - [5.3 åº”ç”¨åœºæ™¯](#53-åº”ç”¨åœºæ™¯)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 è°“è¯é”ä¸å¹½çµç°è±¡å·¥ä½œåŸç†æ¦‚è¿°

**è°“è¯é”**ï¼š

è°“è¯é”æ˜¯ä¸€ç§ç”¨äºé˜²æ­¢"å¹½çµç°è±¡"ï¼ˆPhantom Phenomenonï¼‰çš„é”æœºåˆ¶ã€‚ä¸ä¼ ç»Ÿçš„è¡Œé”ä¸åŒï¼Œè°“è¯é”é”å®šæ»¡è¶³æŸä¸ªè°“è¯çš„æ‰€æœ‰è¡Œï¼ŒåŒ…æ‹¬å½“å‰å­˜åœ¨å’Œæœªæ¥å¯èƒ½æ’å…¥çš„è¡Œã€‚

**å¹½çµç°è±¡**ï¼š

å¹½çµç°è±¡æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡è¯»å–ä¹‹é—´ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„æ–°è¡Œï¼Œå¯¼è‡´ä¸¤æ¬¡è¯»å–ç»“æœä¸ä¸€è‡´ã€‚

**è°“è¯é”æœºåˆ¶**ï¼š

```mermaid
flowchart TD
    A[äº‹åŠ¡æŸ¥è¯¢] --> B[æ„å»ºæŸ¥è¯¢è°“è¯]
    B --> C[è·å–è°“è¯é”]
    C --> D{é”å†²çª?}
    D -->|æ˜¯| E[ç­‰å¾…æˆ–ä¸­æ­¢]
    D -->|å¦| F[æ‰§è¡ŒæŸ¥è¯¢]
    F --> G[æ’å…¥æ–°è¡Œ]
    G --> H[æ£€æŸ¥è°“è¯é”]
    H --> I{è¿åé”?}
    I -->|æ˜¯| J[é˜»å¡æ’å…¥]
    I -->|å¦| K[å…è®¸æ’å…¥]

    style A fill:#FFD700
    style C fill:#90EE90
    style J fill:#FF6B6B
    style K fill:#87CEEB
```

**å¹½çµç°è±¡ç¤ºä¾‹**ï¼š

```mermaid
flowchart TD
    A[äº‹åŠ¡T1: SELECT WHERE age < 18] --> B[è¿”å›5è¡Œ]
    B --> C[äº‹åŠ¡T2: INSERT age=15]
    C --> D[äº‹åŠ¡T1: SELECT WHERE age < 18]
    D --> E[è¿”å›6è¡Œ - å¹½çµè¡Œ!]

    style A fill:#FFD700
    style E fill:#FF6B6B
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **è°“è¯é”æœºåˆ¶**ï¼šè°“è¯é”çš„å½¢å¼åŒ–å®šä¹‰å’Œå®ç°
- **å¹½çµç°è±¡**ï¼šå¹½çµç°è±¡çš„å½¢å¼åŒ–æè¿°å’Œæ£€æµ‹
- **æ¶ˆé™¤æ¡ä»¶**ï¼šæ¶ˆé™¤å¹½çµç°è±¡çš„å¿…è¦æ¡ä»¶
- **å®é™…åº”ç”¨**ï¼šè°“è¯é”åœ¨PostgreSQLä¸­çš„åº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 è°“è¯é”å®šä¹‰

**è°“è¯é”ç»“æ„**ï¼š

```haskell
-- è°“è¯é”
data PredicateLock = PredicateLock {
    predicate :: Predicate,
    lockMode :: LockMode,
    transaction :: TransactionID
}

-- è°“è¯
data Predicate =
    Comparison Column Operator Value
  | Conjunction [Predicate]
  | Disjunction [Predicate]

-- é”æ¨¡å¼
data LockMode =
    SharedLock    -- å…±äº«é”ï¼ˆè¯»ï¼‰
  | ExclusiveLock -- æ’ä»–é”ï¼ˆå†™ï¼‰
```

### 2.2 å¹½çµç°è±¡å½¢å¼åŒ–

**å¹½çµç°è±¡å®šä¹‰**ï¼š

```haskell
-- å¹½çµç°è±¡
phantomPhenomenon :: Transaction -> Transaction -> Bool
phantomPhenomenon T1 T2 =
    exists query Q, row r such that:
      T1 executes Q at time t1, returns result R1
      T2 inserts r at time t2, where t1 < t2 < T1.commit
      r satisfies Q
      T1 executes Q at time t3, returns result R2
      |R2| > |R1|  -- ç»“æœé›†å¤§å°å¢åŠ 
```

### 2.3 è°“è¯é”æ£€æµ‹

**é”å†²çªæ£€æµ‹**ï¼š

```haskell
-- è°“è¯é”å†²çª
predicateLockConflict :: PredicateLock -> PredicateLock -> Bool
predicateLockConflict lock1 lock2 =
    -- æ£€æŸ¥è°“è¯æ˜¯å¦é‡å 
    predicatesOverlap (predicate lock1) (predicate lock2) &&
    -- æ£€æŸ¥é”æ¨¡å¼æ˜¯å¦å†²çª
    lockModesConflict (lockMode lock1) (lockMode lock2)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 è°“è¯é”è¯­ä¹‰

**è°“è¯é”è¯­ä¹‰**ï¼š

```haskell
-- è°“è¯é”è¯­ä¹‰
âŸ¦PredicateLock PâŸ§(r) =
    if r satisfies P then Locked else Unlocked

-- é”å†²çª
conflict(L1, L2) =
    exists r such that âŸ¦L1âŸ§(r) = Locked âˆ§ âŸ¦L2âŸ§(r) = Locked
```

### 3.2 å¹½çµç°è±¡å½¢å¼åŒ–

**å¹½çµç°è±¡æ¡ä»¶**ï¼š

```haskell
-- å¹½çµç°è±¡
Phantom(T1, T2, Q, r) iff
    T1.read(Q, t1) = R1
    T2.insert(r, t2) where t1 < t2 < T1.commit
    r âˆˆ âŸ¦QâŸ§
    T1.read(Q, t3) = R2 where t2 < t3 < T1.commit
    |R2| > |R1|
```

### 3.3 æ¶ˆé™¤æ¡ä»¶

**æ¶ˆé™¤å¹½çµç°è±¡çš„æ¡ä»¶**ï¼š

```haskell
-- æ¶ˆé™¤æ¡ä»¶
eliminatePhantom :: Schedule -> Bool
eliminatePhantom s =
    forall T1, T2, Q, r:
      if Phantom(T1, T2, Q, r) then
        exists PredicateLock L such that:
          L.predicate = Q
          L.transaction = T1
          T2.insert(r) conflicts with L
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 è°“è¯é”æ¶ˆé™¤å¹½çµç°è±¡å®šç†

**å®šç†**ï¼šå¦‚æœè°ƒåº¦ä¸­æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨è°“è¯é”ï¼Œåˆ™ä¸å­˜åœ¨å¹½çµç°è±¡ã€‚

**è¯æ˜**ï¼š

1. å‡è®¾å­˜åœ¨å¹½çµç°è±¡ï¼šT1æŸ¥è¯¢Qï¼ŒT2æ’å…¥æ»¡è¶³Qçš„è¡Œr
2. T1åœ¨æŸ¥è¯¢Qæ—¶è·å–è°“è¯é”L(Q)
3. T2æ’å…¥ræ—¶ï¼Œræ»¡è¶³Qï¼Œå› æ­¤ä¸L(Q)å†²çª
4. T2å¿…é¡»ç­‰å¾…T1æäº¤æˆ–ä¸­æ­¢
5. å› æ­¤ï¼ŒT1çš„ä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´ä¸ä¼šå‡ºç°æ–°è¡Œ
6. çŸ›ç›¾ï¼Œå› æ­¤ä¸å­˜åœ¨å¹½çµç°è±¡

### 4.2 è°“è¯é”å¤æ‚åº¦

**å®šç†**ï¼šè°“è¯é”çš„æ£€æµ‹å¤æ‚åº¦ä¸ºO(nÂ·m)ï¼Œå…¶ä¸­næ˜¯é”æ•°é‡ï¼Œmæ˜¯è°“è¯å¤æ‚åº¦ã€‚

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQLä¸­çš„è°“è¯é”

**PostgreSQLå®ç°**ï¼š

PostgreSQLåœ¨å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ä½¿ç”¨è°“è¯é”æ¥é˜²æ­¢å¹½çµç°è±¡ã€‚

```sql
-- å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«è‡ªåŠ¨ä½¿ç”¨è°“è¯é”
BEGIN ISOLATION LEVEL SERIALIZABLE;

-- æŸ¥è¯¢ä¼šè·å–è°“è¯é”
SELECT * FROM employees WHERE age < 18;

-- å…¶ä»–äº‹åŠ¡æ’å…¥æ»¡è¶³æ¡ä»¶çš„è¡Œä¼šè¢«é˜»å¡
-- ä¼šè¯2
BEGIN ISOLATION LEVEL SERIALIZABLE;
INSERT INTO employees (name, age) VALUES ('Alice', 16);
-- å¦‚æœä¼šè¯1æœªæäº¤ï¼Œæ­¤æ’å…¥ä¼šè¢«é˜»å¡
COMMIT;
```

### 5.2 ç´¢å¼•ä¸è°“è¯é”ä¼˜åŒ–

**ç´¢å¼•è¾…åŠ©è°“è¯é”**ï¼š

```sql
-- åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–è°“è¯é”æ£€æµ‹
CREATE INDEX idx_employees_age ON employees(age);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼Œè°“è¯é”æ£€æµ‹æ›´é«˜æ•ˆ
SELECT * FROM employees WHERE age < 18;
-- PostgreSQLå¯ä»¥ä½¿ç”¨ç´¢å¼•æ¥å¿«é€Ÿæ£€æµ‹è°“è¯é”å†²çª
```

### 5.3 åº”ç”¨åœºæ™¯

**é€‚ç”¨åœºæ™¯**ï¼š

- éœ€è¦é˜²æ­¢å¹½çµç°è±¡çš„åº”ç”¨
- èŒƒå›´æŸ¥è¯¢å’ŒèšåˆæŸ¥è¯¢
- å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«

**æ³¨æ„äº‹é¡¹**ï¼š

- è°“è¯é”å¯èƒ½å½±å“å¹¶å‘æ€§èƒ½
- éœ€è¦åˆç†è®¾è®¡ç´¢å¼•ä»¥ä¼˜åŒ–é”æ£€æµ‹
- è€ƒè™‘ä½¿ç”¨è¾ƒä½çš„éš”ç¦»çº§åˆ«ä»¥å¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Eswaran, K. P., et al. (1976). "The Notions of Consistency and Predicate Locks in a Database System."**
  - ä¼šè®®: Communications of the ACM 1976
  - **é‡è¦æ€§**: è°“è¯é”çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†è°“è¯é”çš„æ¦‚å¿µå’Œå½¢å¼åŒ–å®šä¹‰

- **Gray, J., et al. (1976). "Granularity of Locks and Degrees of Consistency in a Shared Data Base."**
  - ä¼šè®®: IFIP Working Conference 1976
  - **é‡è¦æ€§**: é”ç²’åº¦çš„ç»å…¸ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: è®¨è®ºäº†ä¸åŒç²’åº¦çš„é”ï¼ŒåŒ…æ‹¬è°“è¯é”

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - äº‹åŠ¡éš”ç¦»](<https://www.postgresql.org/docs/current/transaction-iso.html>)**
  - PostgreSQLäº‹åŠ¡éš”ç¦»çº§åˆ«å’Œè°“è¯é”å®ç°è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [å¿«ç…§éš”ç¦»å¼‚å¸¸è°±ç³»-å½¢å¼åˆ†ç±»ä¸å¿…è¦æ¡ä»¶](./03.06-å¿«ç…§éš”ç¦»å¼‚å¸¸è°±ç³»-å½¢å¼åˆ†ç±»ä¸å¿…è¦æ¡ä»¶.md)
- [äº‹åŠ¡éš”ç¦»ä¸MVCC-ç»Ÿä¸€å½¢å¼æ¨¡å‹ä¸å®Œå¤‡æ€§è¯æ˜](./03.03-äº‹åŠ¡éš”ç¦»ä¸MVCC-ç»Ÿä¸€å½¢å¼æ¨¡å‹ä¸å®Œå¤‡æ€§è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
