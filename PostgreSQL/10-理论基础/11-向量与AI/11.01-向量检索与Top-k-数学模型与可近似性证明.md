# å‘é‡æ£€ç´¢ä¸Top-k-æ•°å­¦æ¨¡å‹ä¸å¯è¿‘ä¼¼æ€§è¯æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [å‘é‡æ£€ç´¢ä¸Top-k-æ•°å­¦æ¨¡å‹ä¸å¯è¿‘ä¼¼æ€§è¯æ˜](#å‘é‡æ£€ç´¢ä¸top-k-æ•°å­¦æ¨¡å‹ä¸å¯è¿‘ä¼¼æ€§è¯æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 å‘é‡æ£€ç´¢å·¥ä½œåŸç†æ¦‚è¿°](#10-å‘é‡æ£€ç´¢å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 å‘é‡ç©ºé—´æ¨¡å‹](#21-å‘é‡ç©ºé—´æ¨¡å‹)
    - [2.2 Top-kæŸ¥è¯¢](#22-top-kæŸ¥è¯¢)
    - [2.3 è¿‘ä¼¼æœ€è¿‘é‚»](#23-è¿‘ä¼¼æœ€è¿‘é‚»)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å‘é‡ç©ºé—´å½¢å¼åŒ–](#31-å‘é‡ç©ºé—´å½¢å¼åŒ–)
    - [3.2 Top-kæŸ¥è¯¢å½¢å¼åŒ–](#32-top-kæŸ¥è¯¢å½¢å¼åŒ–)
    - [3.3 å¯è¿‘ä¼¼æ€§å®šä¹‰](#33-å¯è¿‘ä¼¼æ€§å®šä¹‰)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 Top-kå¯è¿‘ä¼¼æ€§å®šç†](#41-top-kå¯è¿‘ä¼¼æ€§å®šç†)
    - [4.2 å¬å›ç‡ä¸‹ç•Œ](#42-å¬å›ç‡ä¸‹ç•Œ)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL pgvectoræ‰©å±•](#51-postgresql-pgvectoræ‰©å±•)
    - [5.2 è¿‘ä¼¼æœç´¢ä¼˜åŒ–](#52-è¿‘ä¼¼æœç´¢ä¼˜åŒ–)
    - [5.3 æ··åˆæ£€ç´¢](#53-æ··åˆæ£€ç´¢)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 Top-kæŸ¥è¯¢ç›¸å…³](#72-top-kæŸ¥è¯¢ç›¸å…³)
    - [7.3 PostgreSQLå®ç°ç›¸å…³](#73-postgresqlå®ç°ç›¸å…³)
    - [7.4 ç›¸å…³æ–‡æ¡£](#74-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 å‘é‡æ£€ç´¢å·¥ä½œåŸç†æ¦‚è¿°

**å‘é‡æ£€ç´¢**ï¼š

å‘é‡æ£€ç´¢æ˜¯AIå’Œæœºå™¨å­¦ä¹ åº”ç”¨ä¸­çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œç”¨äºåœ¨é«˜ç»´å‘é‡ç©ºé—´ä¸­å¿«é€Ÿæ‰¾åˆ°æœ€ç›¸ä¼¼çš„å‘é‡ã€‚æœ¬æ–‡æ¡£æä¾›å‘é‡æ£€ç´¢çš„æ•°å­¦æ¨¡å‹å’ŒTop-kæŸ¥è¯¢çš„å¯è¿‘ä¼¼æ€§è¯æ˜ã€‚

**å‘é‡æ£€ç´¢æ¶æ„**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢å‘é‡] --> B[å‘é‡ç©ºé—´]
    B --> C[è·ç¦»è®¡ç®—]
    C --> D[ç›¸ä¼¼åº¦æ’åº]
    D --> E[Top-ké€‰æ‹©]
    E --> F[è¿”å›ç»“æœ]

    style A fill:#FFD700
    style C fill:#90EE90
    style F fill:#87CEEB
```

**è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢å‘é‡] --> B[ç´¢å¼•ç»“æ„]
    B --> C[å€™é€‰é›†ç”Ÿæˆ]
    C --> D[è·ç¦»è®¡ç®—]
    D --> E[Top-ké€‰æ‹©]
    E --> F{ç²¾åº¦æ»¡è¶³?}
    F -->|æ˜¯| G[è¿”å›ç»“æœ]
    F -->|å¦| H[æ‰©å±•æœç´¢]
    H --> C

    style A fill:#FFD700
    style C fill:#90EE90
    style G fill:#87CEEB
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **å‘é‡ç©ºé—´æ¨¡å‹**ï¼šé«˜ç»´å‘é‡ç©ºé—´å’Œè·ç¦»åº¦é‡çš„æ•°å­¦å®šä¹‰
- **Top-kæŸ¥è¯¢**ï¼šTop-kæŸ¥è¯¢çš„ç®—æ³•å’Œå¤æ‚åº¦åˆ†æ
- **å¯è¿‘ä¼¼æ€§è¯æ˜**ï¼šè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢çš„å¯è¿‘ä¼¼æ€§ç†è®º
- **å®é™…åº”ç”¨**ï¼šå‘é‡æ£€ç´¢åœ¨PostgreSQL pgvectorä¸­çš„åº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 å‘é‡ç©ºé—´æ¨¡å‹

**å‘é‡ç©ºé—´å®šä¹‰**ï¼š

```haskell
-- dç»´å‘é‡ç©ºé—´
type Vector = [Double]  -- dç»´å‘é‡

-- å‘é‡è·ç¦»åº¦é‡
distance :: DistanceMetric -> Vector -> Vector -> Double

-- L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰
l2Distance :: Vector -> Vector -> Double
l2Distance v1 v2 = sqrt $ sum $ zipWith (\x y -> (x - y)^2) v1 v2

-- ä½™å¼¦ç›¸ä¼¼åº¦
cosineSimilarity :: Vector -> Vector -> Double
cosineSimilarity v1 v2 =
    dotProduct v1 v2 / (norm v1 * norm v2)
```

### 2.2 Top-kæŸ¥è¯¢

**Top-kæŸ¥è¯¢å®šä¹‰**ï¼š

```haskell
-- Top-kæŸ¥è¯¢
topK :: Int -> Vector -> [Vector] -> [Vector]
topK k query vectors =
    take k $ sortBy (compareDistance query) vectors

compareDistance :: Vector -> Vector -> Vector -> Ordering
compareDistance q v1 v2 =
    compare (distance q v1) (distance q v2)
```

### 2.3 è¿‘ä¼¼æœ€è¿‘é‚»

**è¿‘ä¼¼æœ€è¿‘é‚»ç®—æ³•**ï¼š

```haskell
-- (c, Îµ)-è¿‘ä¼¼æœ€è¿‘é‚»
data ApproximateNN = ApproximateNN {
    query :: Vector,
    candidates :: [Vector],
    approximationFactor :: Double  -- c > 1
}

-- LSH (Locality-Sensitive Hashing)
lshHash :: Vector -> Int -> Int
lshHash v seed = hash (dotProduct v randomVector seed)
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å‘é‡ç©ºé—´å½¢å¼åŒ–

**åº¦é‡ç©ºé—´**ï¼š

```haskell
-- åº¦é‡ç©ºé—´
(M, d) å…¶ä¸­:
  M = R^d  (dç»´å‘é‡ç©ºé—´)
  d: M Ã— M â†’ R  (è·ç¦»å‡½æ•°)

-- è·ç¦»å…¬ç†
âˆ€x, y, z âˆˆ M:
  1. d(x, y) â‰¥ 0  (éè´Ÿæ€§)
  2. d(x, y) = 0 âŸº x = y  (åŒä¸€æ€§)
  3. d(x, y) = d(y, x)  (å¯¹ç§°æ€§)
  4. d(x, z) â‰¤ d(x, y) + d(y, z)  (ä¸‰è§’ä¸ç­‰å¼)
```

### 3.2 Top-kæŸ¥è¯¢å½¢å¼åŒ–

**Top-kæŸ¥è¯¢è¯­ä¹‰**ï¼š

```haskell
-- Top-kæŸ¥è¯¢
TopK_k(q, S) = {v âˆˆ S | |{u âˆˆ S | d(q, u) < d(q, v)}| < k}
```

### 3.3 å¯è¿‘ä¼¼æ€§å®šä¹‰

**(c, Îµ)-è¿‘ä¼¼æœ€è¿‘é‚»**ï¼š

```haskell
-- (c, Îµ)-è¿‘ä¼¼æœ€è¿‘é‚»
(c, Îµ)-ANN(q, S) = v âˆˆ S ä½¿å¾—:
  d(q, v) â‰¤ c Â· d(q, v*) + Îµ

å…¶ä¸­ v* = argmin_{u âˆˆ S} d(q, u)
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 Top-kå¯è¿‘ä¼¼æ€§å®šç†

**å®šç†**: å¯¹äºä»»æ„æŸ¥è¯¢å‘é‡qå’Œå‘é‡é›†åˆSï¼Œå­˜åœ¨(c, Îµ)-è¿‘ä¼¼Top-kç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(d Â· n^Ï)ï¼Œå…¶ä¸­Ï < 1ä¾èµ–äºcã€‚

**è¯æ˜æ€è·¯**:

1. ä½¿ç”¨LSHæ„å»ºå“ˆå¸Œè¡¨
2. åœ¨å“ˆå¸Œæ¡¶ä¸­æœç´¢å€™é€‰å‘é‡
3. è¯æ˜å€™é€‰é›†åŒ…å«è¿‘ä¼¼æœ€è¿‘é‚»çš„æ¦‚ç‡
4. åˆ†ææ—¶é—´å¤æ‚åº¦å’Œè¿‘ä¼¼è¯¯å·®

### 4.2 å¬å›ç‡ä¸‹ç•Œ

**å®šç†**: å¯¹äºLSH-basedè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼Œå¬å›ç‡ä¸‹ç•Œä¸º1 - (1 - p^k)^Lï¼Œå…¶ä¸­pæ˜¯LSHå‡½æ•°ç¢°æ’æ¦‚ç‡ï¼ŒLæ˜¯å“ˆå¸Œè¡¨æ•°é‡ã€‚

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL pgvectoræ‰©å±•

**å‘é‡å­˜å‚¨å’Œç´¢å¼•**ï¼š

```sql
-- åˆ›å»ºå‘é‡åˆ—
CREATE TABLE embeddings (
    id SERIAL PRIMARY KEY,
    text_content TEXT,
    embedding vector(1536)  -- OpenAI embeddingç»´åº¦
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX ON embeddings
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- Top-kç›¸ä¼¼åº¦æŸ¥è¯¢
SELECT
    id,
    text_content,
    1 - (embedding <=> query_embedding) AS similarity
FROM embeddings
ORDER BY embedding <=> query_embedding
LIMIT 10;
```

### 5.2 è¿‘ä¼¼æœç´¢ä¼˜åŒ–

**IVFFlatç´¢å¼•**ï¼š

```sql
-- IVFFlatç´¢å¼•å‚æ•°è°ƒä¼˜
CREATE INDEX idx_embeddings_ivfflat
ON embeddings
USING ivfflat (embedding vector_l2_ops)
WITH (
    lists = 100,  -- èšç±»ä¸­å¿ƒæ•°é‡
    probes = 10   -- æœç´¢çš„èšç±»æ•°é‡
);

-- æŸ¥è¯¢æ—¶è®¾ç½®probeså‚æ•°
SET ivfflat.probes = 20;
SELECT * FROM embeddings
ORDER BY embedding <-> query_vector
LIMIT 10;
```

### 5.3 æ··åˆæ£€ç´¢

**å‘é‡+å…³é”®è¯æ··åˆæ£€ç´¢**ï¼š

```sql
-- ç»“åˆå‘é‡æ£€ç´¢å’Œå…¨æ–‡æœç´¢
SELECT
    id,
    text_content,
    (
        0.7 * (1 - (embedding <=> query_embedding)) +
        0.3 * ts_rank(to_tsvector('english', text_content), query_ts)
    ) AS combined_score
FROM embeddings
WHERE to_tsvector('english', text_content) @@ query_ts
ORDER BY combined_score DESC
LIMIT 10;
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Indyk, P., & Motwani, R. (1998). "Approximate Nearest Neighbors: Towards Removing the Curse of Dimensionality."**
  - ä¼šè®®: STOC 1998
  - **é‡è¦æ€§**: LSHç®—æ³•çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†LSHç®—æ³•å’Œå¯è¿‘ä¼¼æ€§ç†è®º

- **Andoni, A., & Indyk, P. (2008). "Near-Optimal Hashing Algorithms for Approximate Nearest Neighbor in High Dimensions."**
  - ä¼šè®®: Communications of the ACM 2008
  - **é‡è¦æ€§**: LSHä¼˜åŒ–çš„ç»å…¸ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†æœ€ä¼˜çš„LSHæ„é€ æ–¹æ³•

### 7.2 Top-kæŸ¥è¯¢ç›¸å…³

- **Fagin, R., et al. (2003). "Optimal Aggregation Algorithms for Middleware."**
  - ä¼šè®®: Journal of Computer and System Sciences 2003
  - **é‡è¦æ€§**: Top-kæŸ¥è¯¢çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†Top-kæŸ¥è¯¢çš„ç®—æ³•æ¡†æ¶

### 7.3 PostgreSQLå®ç°ç›¸å…³

- **[pgvectoræ–‡æ¡£](<https://github.com/pgvector/pgvector>)**
  - pgvectoræ‰©å±•æ–‡æ¡£

- **[å‘é‡æ•°æ®èŒƒç•´è®ºæ¨¡å‹](../02-èŒƒç•´è®ºåº”ç”¨/02.02-å‘é‡æ•°æ®èŒƒç•´è®ºæ¨¡å‹.md)**
  - PostgreSQLå‘é‡æ£€ç´¢çš„èŒƒç•´è®ºè§†è§’

### 7.4 ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æœºå™¨å­¦ä¹ é›†æˆ-æ¨¡å‹ç®¡ç†ä¸æ¨ç†ä¼˜åŒ–çš„å½¢å¼åŒ–](./11.02-æ•°æ®åº“æœºå™¨å­¦ä¹ é›†æˆ-æ¨¡å‹ç®¡ç†ä¸æ¨ç†ä¼˜åŒ–çš„å½¢å¼åŒ–.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
