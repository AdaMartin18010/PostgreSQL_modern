# æ•°æ®åº“åŒºå—é“¾æ¨¡å‹-åˆ†å¸ƒå¼è´¦æœ¬ä¸å…±è¯†æœºåˆ¶çš„å½¢å¼åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“åŒºå—é“¾æ¨¡å‹-åˆ†å¸ƒå¼è´¦æœ¬ä¸å…±è¯†æœºåˆ¶çš„å½¢å¼åŒ–](#æ•°æ®åº“åŒºå—é“¾æ¨¡å‹-åˆ†å¸ƒå¼è´¦æœ¬ä¸å…±è¯†æœºåˆ¶çš„å½¢å¼åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 åŒºå—é“¾æ•°æ®åº“å·¥ä½œåŸç†æ¦‚è¿°](#10-åŒºå—é“¾æ•°æ®åº“å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 åˆ†å¸ƒå¼è´¦æœ¬](#21-åˆ†å¸ƒå¼è´¦æœ¬)
    - [2.2 å…±è¯†æœºåˆ¶](#22-å…±è¯†æœºåˆ¶)
    - [2.3 æ•°æ®æ¨¡å‹](#23-æ•°æ®æ¨¡å‹)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 åŒºå—é“¾å½¢å¼åŒ–](#31-åŒºå—é“¾å½¢å¼åŒ–)
    - [3.2 å…±è¯†æœºåˆ¶å½¢å¼åŒ–](#32-å…±è¯†æœºåˆ¶å½¢å¼åŒ–)
    - [3.3 å®‰å…¨æ€§å½¢å¼åŒ–](#33-å®‰å…¨æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 åŒºå—é“¾ä¸å¯ç¯¡æ”¹æ€§å®šç†](#41-åŒºå—é“¾ä¸å¯ç¯¡æ”¹æ€§å®šç†)
    - [4.2 å…±è¯†æœºåˆ¶æ­£ç¡®æ€§å®šç†](#42-å…±è¯†æœºåˆ¶æ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [4.1 PostgreSQLåŒºå—é“¾å®ç°](#41-postgresqlåŒºå—é“¾å®ç°)
    - [4.2 å…±è¯†æœºåˆ¶å®ç°](#42-å…±è¯†æœºåˆ¶å®ç°)
  - [5. ç›¸å…³æ–‡æ¡£](#5-ç›¸å…³æ–‡æ¡£)
    - [5.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#51-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [6. å‚è€ƒæ–‡çŒ®](#6-å‚è€ƒæ–‡çŒ®)
    - [6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#61-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [6.2 åŒºå—é“¾æ•°æ®åº“ç›¸å…³](#62-åŒºå—é“¾æ•°æ®åº“ç›¸å…³)
    - [6.3 ç›¸å…³æ–‡æ¡£](#63-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 åŒºå—é“¾æ•°æ®åº“å·¥ä½œåŸç†æ¦‚è¿°

**åŒºå—é“¾æ•°æ®åº“**ï¼š

åŒºå—é“¾æ•°æ®åº“ç»“åˆäº†åŒºå—é“¾çš„ä¸å¯ç¯¡æ”¹æ€§å’Œæ•°æ®åº“çš„æŸ¥è¯¢èƒ½åŠ›ï¼Œæä¾›åˆ†å¸ƒå¼è´¦æœ¬å’Œå…±è¯†æœºåˆ¶çš„å½¢å¼åŒ–æ¨¡å‹ã€‚

**åŒºå—é“¾æ¶æ„æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((åŒºå—é“¾æ•°æ®åº“))
    åˆ†å¸ƒå¼è´¦æœ¬
      åŒºå—é“¾
      å“ˆå¸Œé“¾æ¥
      ä¸å¯ç¯¡æ”¹
    å…±è¯†æœºåˆ¶
      PoWå·¥ä½œé‡è¯æ˜
      PoSæƒç›Šè¯æ˜
      PBFTå®ç”¨æ‹œå åº­å®¹é”™
    æ•°æ®æ¨¡å‹
      äº¤æ˜“
      åŒºå—
      çŠ¶æ€
    æŸ¥è¯¢èƒ½åŠ›
      SQLæŸ¥è¯¢
      ç´¢å¼•
      äº‹åŠ¡
```

**åŒºå—é“¾å·¥ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ–°äº¤æ˜“] --> B[éªŒè¯äº¤æ˜“]
    B --> C{æœ‰æ•ˆ?}
    C -->|æ˜¯| D[æ‰“åŒ…åˆ°åŒºå—]
    C -->|å¦| E[æ‹’ç»]
    D --> F[å…±è¯†æœºåˆ¶]
    F --> G{è¾¾æˆå…±è¯†?}
    G -->|æ˜¯| H[æ·»åŠ åˆ°é“¾]
    G -->|å¦| I[é‡æ–°å…±è¯†]
    H --> J[æ›´æ–°çŠ¶æ€]

    style A fill:#FFD700
    style H fill:#90EE90
    style E fill:#FF6B6B
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **åˆ†å¸ƒå¼è´¦æœ¬**ï¼šåŒºå—é“¾è´¦æœ¬çš„å½¢å¼åŒ–æ¨¡å‹
- **å…±è¯†æœºåˆ¶**ï¼šPoWã€PoSã€PBFTç­‰å…±è¯†ç®—æ³•çš„å½¢å¼åŒ–
- **æ•°æ®æ¨¡å‹**ï¼šåŒºå—é“¾æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢èƒ½åŠ›
- **å®é™…åº”ç”¨**ï¼šåŒºå—é“¾æ•°æ®åº“çš„å®ç°å’Œåº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 åˆ†å¸ƒå¼è´¦æœ¬

**åŒºå—ç»“æ„**ï¼š

```haskell
-- åŒºå—
data Block = Block {
    index :: Integer,
    timestamp :: Timestamp,
    transactions :: [Transaction],
    previousHash :: Hash,
    hash :: Hash,
    nonce :: Integer
}

-- åŒºå—é“¾
data Blockchain = Blockchain {
    blocks :: [Block],
    currentState :: State
}
```

**åŒºå—é“¾éªŒè¯**ï¼š

```haskell
-- éªŒè¯åŒºå—
validateBlock :: Block -> Block -> Bool
validateBlock prev current =
    current.previousHash == hash(prev) &&
    hash(current) == calculateHash(current) &&
    validateTransactions(current.transactions)
```

### 2.2 å…±è¯†æœºåˆ¶

**å…±è¯†æœºåˆ¶å¯¹æ¯”**ï¼š

| æœºåˆ¶ | ç±»å‹ | èƒ½è€— | å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **PoW** | ç«äº‰æ€§ | é«˜ | é«˜ | å…¬é“¾ |
| **PoS** | ç«äº‰æ€§ | ä½ | ä¸­ | å…¬é“¾/è”ç›Ÿé“¾ |
| **PBFT** | åä½œæ€§ | ä½ | ä½ | è”ç›Ÿé“¾ |
| **Raft** | åä½œæ€§ | ä½ | ä½ | ç§æœ‰é“¾ |

**å…±è¯†æœºåˆ¶é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©å…±è¯†æœºåˆ¶] --> B{å…¬å¼€ç½‘ç»œ?}
    B -->|æ˜¯| C{éœ€è¦å»ä¸­å¿ƒåŒ–?}
    B -->|å¦| D[PBFT/Raft]
    C -->|æ˜¯| E[PoW/PoS]
    C -->|å¦| F[PoS]
    E --> G[é«˜èƒ½è€—]
    F --> H[ä½èƒ½è€—]
    D --> I[ä½å»¶è¿Ÿ]

    style A fill:#FFD700
    style G fill:#FFA500
    style H fill:#90EE90
    style I fill:#87CEEB
```

### 2.3 æ•°æ®æ¨¡å‹

**åŒºå—é“¾æ•°æ®æ¨¡å‹**ï¼š

```haskell
-- äº¤æ˜“
data Transaction = Transaction {
    from :: Address,
    to :: Address,
    value :: Amount,
    data :: Data,
    signature :: Signature
}

-- çŠ¶æ€
data State = State {
    accounts :: Map Address Account,
    contracts :: Map Address Contract
}
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 åŒºå—é“¾å½¢å¼åŒ–

**åŒºå—é“¾**ï¼š

```haskell
-- åŒºå—é“¾å½¢å¼åŒ–
Blockchain = (B, â‰¤, H, V)
where
    B = {b0, b1, ..., bn}  -- åŒºå—é›†åˆ
    â‰¤ = chain order  -- é“¾é¡ºåº
    H = hash function  -- å“ˆå¸Œå‡½æ•°
    V = validation function  -- éªŒè¯å‡½æ•°
```

### 3.2 å…±è¯†æœºåˆ¶å½¢å¼åŒ–

**PoWå…±è¯†**ï¼š

```haskell
-- PoWå…±è¯†
PoW(block, difficulty) =
    exists nonce such that:
        hash(block || nonce) < 2^(256 - difficulty)
```

**PBFTå…±è¯†**ï¼š

```haskell
-- PBFTå…±è¯†
PBFT(request, replicas) =
    if 2f + 1 replicas agree then
        commit
    else
        abort
    where f = number of faulty replicas
```

### 3.3 å®‰å…¨æ€§å½¢å¼åŒ–

**å®‰å…¨æ€§**ï¼š

```haskell
-- å®‰å…¨æ€§
secure(blockchain) =
    forall block b:
        if b in chain then
            validate(b) = true
            and
            cannot modify b without breaking chain
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 åŒºå—é“¾ä¸å¯ç¯¡æ”¹æ€§å®šç†

**å®šç†**ï¼šå¦‚æœåŒºå—é“¾ä½¿ç”¨å¯†ç å­¦å“ˆå¸Œé“¾ä¿æŠ¤ï¼Œåˆ™å·²ç¡®è®¤çš„åŒºå—æ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾åŒºå—é“¾C = [bâ‚€, bâ‚, ..., bâ‚™]ï¼Œå…¶ä¸­æ¯ä¸ªåŒºå—báµ¢åŒ…å«å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼háµ¢â‚‹â‚ã€‚å¦‚æœæ”»å‡»è€…è¯•å›¾ä¿®æ”¹åŒºå—bâ±¼ï¼ˆj < nï¼‰ï¼Œåˆ™å¿…é¡»ä¿®æ”¹æ‰€æœ‰åç»­åŒºå—bâ±¼â‚Šâ‚, ..., bâ‚™çš„å“ˆå¸Œå€¼ï¼Œè¿™åœ¨è®¡ç®—ä¸Šä¸å¯è¡Œã€‚

**è¯æ˜**ï¼ˆå¯†ç å­¦å®‰å…¨æ€§ï¼‰ï¼š

**æ­¥éª¤1ï¼šå“ˆå¸Œé“¾ç»“æ„**

- æ¯ä¸ªåŒºå—báµ¢åŒ…å«ï¼šháµ¢ = Hash(báµ¢â‚‹â‚ || dataáµ¢)
- åŒºå—é€šè¿‡å“ˆå¸Œå€¼é“¾æ¥ï¼šbáµ¢.previous_hash = háµ¢â‚‹â‚

**æ­¥éª¤2ï¼šç¯¡æ”¹åˆ†æ**

- å¦‚æœæ”»å‡»è€…ä¿®æ”¹åŒºå—bâ±¼çš„æ•°æ®ï¼Œåˆ™hâ±¼æ”¹å˜
- ä½†bâ±¼â‚Šâ‚.previous_hash = hâ±¼ï¼Œå› æ­¤bâ±¼â‚Šâ‚çš„å“ˆå¸Œå€¼ä¹Ÿæ”¹å˜
- è¿™å¯¼è‡´bâ±¼â‚Šâ‚‚, ..., bâ‚™çš„æ‰€æœ‰å“ˆå¸Œå€¼éƒ½éœ€è¦é‡æ–°è®¡ç®—

**æ­¥éª¤3ï¼šè®¡ç®—å¤æ‚åº¦**

- ä¿®æ”¹ä¸€ä¸ªåŒºå—éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰åç»­åŒºå—çš„å“ˆå¸Œ
- å¯¹äºPoWå…±è¯†ï¼Œæ¯ä¸ªåŒºå—éœ€è¦å¤§é‡è®¡ç®—ï¼ˆæŒ–çŸ¿ï¼‰
- æ”»å‡»è€…éœ€è¦è¶…è¿‡50%çš„ç®—åŠ›æ‰èƒ½æˆåŠŸï¼ˆ51%æ”»å‡»ï¼‰

**æ­¥éª¤4ï¼šç»“è®º**

- åŒºå—é“¾çš„ä¸å¯ç¯¡æ”¹æ€§ç”±å¯†ç å­¦å“ˆå¸Œå’Œå…±è¯†æœºåˆ¶ä¿è¯
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[åŒºå—é“¾ä¸å¯ç¯¡æ”¹æ€§] --> B[å“ˆå¸Œé“¾ç»“æ„]
    B --> C[ç¯¡æ”¹åˆ†æ]
    C --> D[è®¡ç®—å¤æ‚åº¦]
    D --> E[ä¸å¯ç¯¡æ”¹]
    
    style A fill:#FFD700
    style E fill:#90EE90
```

### 4.2 å…±è¯†æœºåˆ¶æ­£ç¡®æ€§å®šç†

**å®šç†**ï¼šå¦‚æœå…±è¯†æœºåˆ¶æ»¡è¶³å®¹é”™è¦æ±‚ï¼Œåˆ™ç³»ç»Ÿåœ¨fä¸ªæ•…éšœèŠ‚ç‚¹ä¸‹ä»èƒ½è¾¾æˆä¸€è‡´ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾ç³»ç»Ÿæœ‰nä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­fä¸ªå¯èƒ½æ•…éšœã€‚å¦‚æœå…±è¯†æœºåˆ¶è¦æ±‚è‡³å°‘(n+f+1)/2ä¸ªèŠ‚ç‚¹åŒæ„ï¼Œåˆ™ç³»ç»Ÿå¯ä»¥å®¹å¿fä¸ªæ•…éšœèŠ‚ç‚¹ã€‚

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šå®¹é”™è¦æ±‚**

- å¯¹äºPBFTï¼šéœ€è¦2f+1ä¸ªèŠ‚ç‚¹åŒæ„ï¼ˆn â‰¥ 3f+1ï¼‰
- å¯¹äºPoWï¼šéœ€è¦è¶…è¿‡50%ç®—åŠ›ï¼ˆn > 2fï¼‰

**æ­¥éª¤2ï¼šä¸€è‡´æ€§ä¿è¯**

- å¦‚æœ2f+1ä¸ªèŠ‚ç‚¹åŒæ„ï¼Œåˆ™å³ä½¿fä¸ªèŠ‚ç‚¹æ•…éšœï¼Œä»æœ‰f+1ä¸ªæ­£å¸¸èŠ‚ç‚¹
- è¿™ä¿è¯äº†å¤§å¤šæ•°èŠ‚ç‚¹çš„ä¸€è‡´æ€§

**æ­¥éª¤3ï¼šç»“è®º**

- å…±è¯†æœºåˆ¶çš„æ­£ç¡®æ€§ç”±å®¹é”™è¦æ±‚ä¿è¯
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å…±è¯†æœºåˆ¶æ­£ç¡®æ€§] --> B[å®¹é”™è¦æ±‚]
    B --> C[ä¸€è‡´æ€§ä¿è¯]
    C --> D[æ­£ç¡®æ€§]
    
    style A fill:#FFD700
    style D fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 åŒºå—é“¾å®ç°è¯¦è§£

**ä½¿ç”¨PostgreSQLå®ç°åŒºå—é“¾**ï¼š

```sql
-- åˆ›å»ºåŒºå—è¡¨
CREATE TABLE blocks (
    index BIGINT PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    previous_hash VARCHAR(64) NOT NULL,
    hash VARCHAR(64) NOT NULL UNIQUE,
    nonce BIGINT,
    merkle_root VARCHAR(64)
);

-- åˆ›å»ºäº¤æ˜“è¡¨
CREATE TABLE transactions (
    id UUID PRIMARY KEY,
    block_index BIGINT REFERENCES blocks(index),
    from_address VARCHAR(42),
    to_address VARCHAR(42),
    value NUMERIC(20, 8),
    data JSONB,
    signature TEXT,
    created_at TIMESTAMP
);

-- åˆ›å»ºçŠ¶æ€è¡¨
CREATE TABLE state (
    address VARCHAR(42) PRIMARY KEY,
    balance NUMERIC(20, 8) DEFAULT 0,
    nonce BIGINT DEFAULT 0,
    data JSONB
);

-- éªŒè¯åŒºå—å‡½æ•°
CREATE OR REPLACE FUNCTION validate_block(
    p_index BIGINT,
    p_previous_hash VARCHAR,
    p_hash VARCHAR
) RETURNS BOOLEAN AS $$
DECLARE
    v_prev_hash VARCHAR;
BEGIN
    -- æ£€æŸ¥å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œ
    SELECT hash INTO v_prev_hash
    FROM blocks
    WHERE index = p_index - 1;

    RETURN v_prev_hash = p_previous_hash;
END;
$$ LANGUAGE plpgsql;

-- æ·»åŠ åŒºå—
CREATE OR REPLACE FUNCTION add_block(
    p_index BIGINT,
    p_timestamp TIMESTAMP,
    p_previous_hash VARCHAR,
    p_hash VARCHAR,
    p_nonce BIGINT
) RETURNS VOID AS $$
BEGIN
    -- éªŒè¯åŒºå—
    IF NOT validate_block(p_index, p_previous_hash, p_hash) THEN
        RAISE EXCEPTION 'Invalid block';
    END IF;

    -- æ’å…¥åŒºå—
    INSERT INTO blocks (index, timestamp, previous_hash, hash, nonce)
    VALUES (p_index, p_timestamp, p_previous_hash, p_hash, p_nonce);
END;
$$ LANGUAGE plpgsql;
```

### 5.2 SQLite 3.45 åŒºå—é“¾å¯¹æ¯”

**SQLite 3.45åŒºå—é“¾æ”¯æŒ**ï¼š

SQLite 3.45ä¸æ”¯æŒåŸç”ŸåŒºå—é“¾åŠŸèƒ½ï¼Œä½†å¯ä»¥é€šè¿‡åº”ç”¨å±‚å®ç°ã€‚

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **åŒºå—é“¾å®ç°** | âœ… æ”¯æŒï¼ˆè¡¨ç»“æ„+å‡½æ•°ï¼‰ | âš ï¸ åº”ç”¨å±‚å®ç° |
| **å…±è¯†æœºåˆ¶** | âš ï¸ åº”ç”¨å±‚å®ç° | âš ï¸ åº”ç”¨å±‚å®ç° |
| **åˆ†å¸ƒå¼è´¦æœ¬** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **æ€§èƒ½** | âœ… é«˜ | âš ï¸ ä¸­ç­‰ |

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### åœºæ™¯1ï¼šä¾›åº”é“¾æº¯æºç³»ç»Ÿ

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- é£Ÿå“ä¾›åº”é“¾ç³»ç»Ÿï¼Œéœ€è¦è¿½è¸ªäº§å“ä»ç”Ÿäº§åˆ°é”€å”®çš„å®Œæ•´æµç¨‹
- éœ€è¦ä¿è¯æ•°æ®ä¸å¯ç¯¡æ”¹
- éœ€è¦å¤šæ–¹å‚ä¸éªŒè¯

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šä¾›åº”é“¾æº¯æºç³»ç»Ÿ
-- 1. åˆ›å»ºäº§å“è¡¨
CREATE TABLE products (
    id UUID PRIMARY KEY,
    name VARCHAR(200),
    producer_id UUID,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºæº¯æºé“¾è¡¨ï¼ˆåŒºå—é“¾ï¼‰
CREATE TABLE supply_chain_blocks (
    index BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    previous_hash VARCHAR(64),
    hash VARCHAR(64) UNIQUE,
    data JSONB,
    signature TEXT
);

-- 3. æ·»åŠ æº¯æºè®°å½•
CREATE OR REPLACE FUNCTION add_supply_chain_record(
    p_product_id UUID,
    p_action VARCHAR(50),
    p_actor_id UUID,
    p_location VARCHAR(100)
) RETURNS VOID AS $$
DECLARE
    v_prev_hash VARCHAR(64);
    v_hash VARCHAR(64);
    v_data JSONB;
BEGIN
    -- è·å–å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œ
    SELECT hash INTO v_prev_hash
    FROM supply_chain_blocks
    ORDER BY index DESC
    LIMIT 1;
    
    -- æ„å»ºæ•°æ®
    v_data := jsonb_build_object(
        'product_id', p_product_id,
        'action', p_action,
        'actor_id', p_actor_id,
        'location', p_location,
        'timestamp', NOW()
    );
    
    -- è®¡ç®—å“ˆå¸Œ
    v_hash := encode(
        digest(COALESCE(v_prev_hash, '') || v_data::TEXT, 'sha256'),
        'hex'
    );
    
    -- æ’å…¥åŒºå—
    INSERT INTO supply_chain_blocks (previous_hash, hash, data)
    VALUES (v_prev_hash, v_hash, v_data);
END;
$$ LANGUAGE plpgsql;

-- 4. æŸ¥è¯¢æº¯æºé“¾
CREATE OR REPLACE FUNCTION get_supply_chain(
    p_product_id UUID
) RETURNS TABLE (
    index BIGINT,
    timestamp TIMESTAMPTZ,
    action VARCHAR(50),
    actor_id UUID,
    location VARCHAR(100)
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        b.index,
        b.timestamp,
        b.data->>'action' AS action,
        (b.data->>'actor_id')::UUID AS actor_id,
        b.data->>'location' AS location
    FROM supply_chain_blocks b
    WHERE b.data->>'product_id' = p_product_id::TEXT
    ORDER BY b.index;
END;
$$ LANGUAGE plpgsql;
```

#### åœºæ™¯2ï¼šæ•°å­—èµ„äº§äº¤æ˜“ç³»ç»Ÿ

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- NFTäº¤æ˜“å¹³å°ï¼Œéœ€è¦è®°å½•æ•°å­—èµ„äº§çš„æ‰€æœ‰æƒå˜æ›´
- éœ€è¦ä¿è¯äº¤æ˜“ä¸å¯ç¯¡æ”¹
- éœ€è¦æ”¯æŒæ™ºèƒ½åˆçº¦

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šæ•°å­—èµ„äº§äº¤æ˜“ç³»ç»Ÿ
-- 1. åˆ›å»ºèµ„äº§è¡¨
CREATE TABLE digital_assets (
    id UUID PRIMARY KEY,
    token_id VARCHAR(100) UNIQUE,
    owner_address VARCHAR(42),
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºäº¤æ˜“é“¾ï¼ˆåŒºå—é“¾ï¼‰
CREATE TABLE asset_transactions (
    index BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    previous_hash VARCHAR(64),
    hash VARCHAR(64) UNIQUE,
    transaction_type VARCHAR(20),
    from_address VARCHAR(42),
    to_address VARCHAR(42),
    token_id VARCHAR(100),
    value NUMERIC(20, 8),
    signature TEXT
);

-- 3. æ‰§è¡Œäº¤æ˜“
CREATE OR REPLACE FUNCTION execute_transfer(
    p_token_id VARCHAR(100),
    p_from VARCHAR(42),
    p_to VARCHAR(42),
    p_value NUMERIC
) RETURNS BOOLEAN AS $$
DECLARE
    v_prev_hash VARCHAR(64);
    v_hash VARCHAR(64);
BEGIN
    -- éªŒè¯æ‰€æœ‰æƒ
    IF NOT EXISTS (
        SELECT 1 FROM digital_assets
        WHERE token_id = p_token_id AND owner_address = p_from
    ) THEN
        RETURN FALSE;
    END IF;
    
    -- è·å–å‰ä¸€ä¸ªåŒºå—å“ˆå¸Œ
    SELECT hash INTO v_prev_hash
    FROM asset_transactions
    ORDER BY index DESC
    LIMIT 1;
    
    -- è®¡ç®—å“ˆå¸Œ
    v_hash := encode(
        digest(COALESCE(v_prev_hash, '') || p_token_id || p_from || p_to || p_value::TEXT, 'sha256'),
        'hex'
    );
    
    -- æ’å…¥äº¤æ˜“
    INSERT INTO asset_transactions (previous_hash, hash, transaction_type, from_address, to_address, token_id, value)
    VALUES (v_prev_hash, v_hash, 'transfer', p_from, p_to, p_token_id, p_value);
    
    -- æ›´æ–°æ‰€æœ‰æƒ
    UPDATE digital_assets
    SET owner_address = p_to
    WHERE token_id = p_token_id;
    
    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

### 5.4 å…±è¯†æœºåˆ¶å®ç°

**PoWå®ç°**ï¼š

```sql
-- PoWæŒ–çŸ¿å‡½æ•°
CREATE OR REPLACE FUNCTION mine_block(
    p_previous_hash VARCHAR,
    p_transactions JSONB,
    p_difficulty INTEGER
) RETURNS JSONB AS $$
DECLARE
    v_nonce BIGINT := 0;
    v_hash VARCHAR;
    v_target VARCHAR;
BEGIN
    -- è®¡ç®—ç›®æ ‡å“ˆå¸Œ
    v_target := LPAD('', p_difficulty, '0');

    -- æŒ–çŸ¿å¾ªç¯
    LOOP
        v_hash := encode(
            digest(p_previous_hash || p_transactions::TEXT || v_nonce::TEXT, 'sha256'),
            'hex'
        );

        IF LEFT(v_hash, p_difficulty) = v_target THEN
            EXIT;
        END IF;

        v_nonce := v_nonce + 1;
    END LOOP;

    RETURN jsonb_build_object(
        'hash', v_hash,
        'nonce', v_nonce
    );
END;
$$ LANGUAGE plpgsql;
```

---

### 5.5 æ€§èƒ½å¯¹æ¯”æ•°æ®

| æŒ‡æ ‡ | PostgreSQL 18 | SQLite 3.45 | è¯´æ˜ |
|------|--------------|-------------|------|
| **åŒºå—å†™å…¥æ€§èƒ½** | 1000 TPS | 500 TPS | PostgreSQLæ€§èƒ½æ›´é«˜ |
| **æŸ¥è¯¢æ€§èƒ½** | 10ms | 15ms | PostgreSQLæŸ¥è¯¢æ›´å¿« |
| **å¹¶å‘æ”¯æŒ** | âœ… é«˜ | âš ï¸ ä¸­ç­‰ | PostgreSQLå¹¶å‘æ›´å¥½ |

## 6. ç›¸å…³æ–‡æ¡£

### 5.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡](./04.02-åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Nakamoto, S. (2008). "Bitcoin: A Peer-to-Peer Electronic Cash System."**
  - ä¼šè®®: Bitcoin Whitepaper
  - **é‡è¦æ€§**: åŒºå—é“¾çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†åŒºå—é“¾å’ŒPoWå…±è¯†æœºåˆ¶
  - **æ‰¹åˆ¤æ€§åˆ†æ**: PoWèƒ½è€—é—®é¢˜å¯¼è‡´åç»­ç ”ç©¶è½¬å‘PoSç­‰æ›´é«˜æ•ˆçš„å…±è¯†æœºåˆ¶

- **Castro, M., & Liskov, B. (1999). "Practical Byzantine Fault Tolerance."**
  - ä¼šè®®: OSDI 1999
  - **é‡è¦æ€§**: PBFTå…±è¯†çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†å®ç”¨çš„æ‹œå åº­å®¹é”™ç®—æ³•
  - **æ‰¹åˆ¤æ€§åˆ†æ**: PBFTé€‚ç”¨äºè”ç›Ÿé“¾ï¼Œä½†ä¸é€‚ç”¨äºå¤§è§„æ¨¡å…¬é“¾

### 6.2 åŒºå—é“¾æ•°æ®åº“ç›¸å…³

- **Zheng, Z., et al. (2017). "An Overview of Blockchain Technology: Architecture, Consensus, and Future Trends."**
  - ä¼šè®®: IEEE BigData 2017
  - **é‡è¦æ€§**: åŒºå—é“¾æŠ€æœ¯ç»¼è¿°
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†åŒºå—é“¾æ¶æ„å’Œå…±è¯†æœºåˆ¶

### 6.3 ç›¸å…³æ–‡æ¡£

- [åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡](./04.02-åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¸CAP-å½¢å¼åŒ–åˆ»ç”»ä¸æƒè¡¡.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”
