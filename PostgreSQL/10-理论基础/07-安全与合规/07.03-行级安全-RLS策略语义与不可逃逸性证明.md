# è¡Œçº§å®‰å…¨-RLSç­–ç•¥è¯­ä¹‰ä¸ä¸å¯é€ƒé€¸æ€§è¯æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„

---

## ğŸ“‹ ç›®å½•

- [è¡Œçº§å®‰å…¨-RLSç­–ç•¥è¯­ä¹‰ä¸ä¸å¯é€ƒé€¸æ€§è¯æ˜](#è¡Œçº§å®‰å…¨-rlsç­–ç•¥è¯­ä¹‰ä¸ä¸å¯é€ƒé€¸æ€§è¯æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 è¡Œçº§å®‰å…¨å·¥ä½œåŸç†æ¦‚è¿°](#10-è¡Œçº§å®‰å…¨å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 RLSç­–ç•¥è¯­ä¹‰](#21-rlsç­–ç•¥è¯­ä¹‰)
    - [2.2 ä¸å¯é€ƒé€¸æ€§](#22-ä¸å¯é€ƒé€¸æ€§)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 RLSç­–ç•¥å½¢å¼åŒ–](#31-rlsç­–ç•¥å½¢å¼åŒ–)
    - [3.2 ä¸å¯é€ƒé€¸æ€§å½¢å¼åŒ–](#32-ä¸å¯é€ƒé€¸æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 ä¸å¯é€ƒé€¸æ€§å®šç†](#41-ä¸å¯é€ƒé€¸æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL RLS](#51-postgresql-rls)
    - [5.2 å®‰å…¨å‡½æ•°](#52-å®‰å…¨å‡½æ•°)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 è¡Œçº§å®‰å…¨å·¥ä½œåŸç†æ¦‚è¿°

**è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰**ï¼š

è¡Œçº§å®‰å…¨æ˜¯PostgreSQLæä¾›çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œå…è®¸åŸºäºè¡Œçº§åˆ«çš„å®‰å…¨ç­–ç•¥æ§åˆ¶æ•°æ®è®¿é—®ã€‚æœ¬æ–‡æ¡£ä¸¥æ ¼è¯æ˜RLSç­–ç•¥çš„è¯­ä¹‰å’Œä¸å¯é€ƒé€¸æ€§ã€‚

**RLSç­–ç•¥åº”ç”¨æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æŸ¥è¯¢è¯·æ±‚] --> B[æ£€æŸ¥RLSç­–ç•¥]
    B --> C{ç­–ç•¥å­˜åœ¨?}
    C -->|æ˜¯| D[è¯„ä¼°ç­–ç•¥è¡¨è¾¾å¼]
    C -->|å¦| E[å…è®¸è®¿é—®]
    D --> F{ç­–ç•¥å…è®¸?}
    F -->|æ˜¯| G[åº”ç”¨ç­–ç•¥è¿‡æ»¤]
    F -->|å¦| H[æ‹’ç»è®¿é—®]
    G --> I[è¿”å›ç»“æœ]
    E --> I

    style A fill:#FFD700
    style D fill:#90EE90
    style I fill:#87CEEB
    style H fill:#FF6B6B
```

**ä¸å¯é€ƒé€¸æ€§éªŒè¯**ï¼š

```mermaid
flowchart TD
    A[è®¿é—®å°è¯•] --> B[åº”ç”¨RLSç­–ç•¥]
    B --> C[ç­–ç•¥è¯„ä¼°]
    C --> D{ç­–ç•¥å…è®¸?}
    D -->|æ˜¯| E[æ£€æŸ¥ç»•è¿‡è·¯å¾„]
    D -->|å¦| F[æ‹’ç»è®¿é—®]
    E --> G{å­˜åœ¨ç»•è¿‡?}
    G -->|æ˜¯| H[å®‰å…¨æ¼æ´]
    G -->|å¦| I[å®‰å…¨ä¿è¯]
    F --> I

    style A fill:#FFD700
    style G fill:#90EE90
    style I fill:#87CEEB
    style H fill:#FF6B6B
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **RLSç­–ç•¥**ï¼šè¡Œçº§å®‰å…¨ç­–ç•¥çš„è¯­ä¹‰å®šä¹‰
- **ä¸å¯é€ƒé€¸æ€§**ï¼šä¸¥æ ¼è¯æ˜RLSç­–ç•¥çš„ä¸å¯é€ƒé€¸æ€§
- **å®‰å…¨æ€§è¯æ˜**ï¼šè¯æ˜RLSç­–ç•¥çš„å®‰å…¨æ€§ä¿è¯
- **å®é™…åº”ç”¨**ï¼šRLSåœ¨PostgreSQLä¸­çš„åº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 RLSç­–ç•¥è¯­ä¹‰

**RLSç­–ç•¥å®šä¹‰**ï¼š

```haskell
-- RLSç­–ç•¥
data RLSPolicy = RLSPolicy {
    name :: String,
    command :: Command,  -- SELECT, INSERT, UPDATE, DELETE
    usingExpression :: Expression,  -- è¡Œå¯è§æ€§æ¡ä»¶
    withCheckExpression :: Maybe Expression  -- è¡Œä¿®æ”¹æ¡ä»¶
}

-- ç­–ç•¥åº”ç”¨
applyPolicy :: RLSPolicy -> Query -> Query
applyPolicy policy query =
    query {
        whereClause = And(query.whereClause, policy.usingExpression)
    }
```

**ç­–ç•¥ç±»å‹å¯¹æ¯”**ï¼š

| ç±»å‹ | ç”¨é€” | è¡¨è¾¾å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|---------|
| **USING** | è¡Œå¯è§æ€§ | å¸ƒå°”è¡¨è¾¾å¼ | SELECT |
| **WITH CHECK** | è¡Œä¿®æ”¹ | å¸ƒå°”è¡¨è¾¾å¼ | INSERT/UPDATE |
| **ç»„åˆç­–ç•¥** | å¤šç­–ç•¥ | é€»è¾‘ç»„åˆ | å¤æ‚åœºæ™¯ |

### 2.2 ä¸å¯é€ƒé€¸æ€§

**ä¸å¯é€ƒé€¸æ€§å®šä¹‰**ï¼š

```haskell
-- ä¸å¯é€ƒé€¸æ€§
nonEscapable :: RLSPolicy -> Bool
nonEscapable policy =
    forall access path p:
        if p bypasses policy then
            p is blocked by system
        else
            True
```

**ç»•è¿‡è·¯å¾„æ£€æŸ¥**ï¼š

```mermaid
flowchart TD
    A[è®¿é—®è·¯å¾„] --> B{ç›´æ¥æŸ¥è¯¢?}
    B -->|æ˜¯| C[åº”ç”¨RLSç­–ç•¥]
    B -->|å¦| D{å‡½æ•°è°ƒç”¨?}
    D -->|æ˜¯| E[æ£€æŸ¥å‡½æ•°æƒé™]
    D -->|å¦| F{è§†å›¾?}
    F -->|æ˜¯| G[åº”ç”¨è§†å›¾RLS]
    F -->|å¦| H[æ‹’ç»è®¿é—®]
    C --> I[ç­–ç•¥æ£€æŸ¥]
    E --> I
    G --> I
    I --> J{é€šè¿‡?}
    J -->|æ˜¯| K[å…è®¸è®¿é—®]
    J -->|å¦| L[æ‹’ç»è®¿é—®]

    style A fill:#FFD700
    style K fill:#90EE90
    style L fill:#FF6B6B
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 RLSç­–ç•¥å½¢å¼åŒ–

**RLSç­–ç•¥**ï¼š

```haskell
-- RLSç­–ç•¥å½¢å¼åŒ–
RLS_Policy = (C, E_u, E_w)
where
    C = command type
    E_u = USING expression
    E_w = WITH CHECK expression
```

### 3.2 ä¸å¯é€ƒé€¸æ€§å½¢å¼åŒ–

**ä¸å¯é€ƒé€¸æ€§**ï¼š

```haskell
-- ä¸å¯é€ƒé€¸æ€§å½¢å¼åŒ–
nonEscapable(policy) =
    forall access path p, row r:
        if visible(r, policy) then
            forall alternative path p':
                if p' bypasses policy then
                    blocked(p')
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 ä¸å¯é€ƒé€¸æ€§å®šç†

**å®šç†**ï¼šå¦‚æœRLSç­–ç•¥æ­£ç¡®å®æ–½ï¼Œåˆ™ä¸å­˜åœ¨ç»•è¿‡ç­–ç•¥çš„è®¿é—®è·¯å¾„ã€‚

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[ä¸å¯é€ƒé€¸æ€§] --> B[æ‰€æœ‰è·¯å¾„æ£€æŸ¥]
    B --> C[ç›´æ¥æŸ¥è¯¢åº”ç”¨ç­–ç•¥]
    B --> D[å‡½æ•°è°ƒç”¨æ£€æŸ¥æƒé™]
    B --> E[è§†å›¾åº”ç”¨ç­–ç•¥]
    C --> F[æ— ç»•è¿‡è·¯å¾„]
    D --> F
    E --> F

    style A fill:#FFD700
    style F fill:#90EE90
```

**è¯æ˜**ï¼š

1. **ç›´æ¥æŸ¥è¯¢**ï¼šæ‰€æœ‰ç›´æ¥æŸ¥è¯¢éƒ½åº”ç”¨RLSç­–ç•¥
2. **å‡½æ•°è°ƒç”¨**ï¼šå‡½æ•°éœ€è¦SECURITY DEFINERæˆ–æ£€æŸ¥è°ƒç”¨è€…æƒé™
3. **è§†å›¾**ï¼šè§†å›¾ç»§æ‰¿è¡¨çš„RLSç­–ç•¥
4. å› æ­¤ä¸å­˜åœ¨ç»•è¿‡ç­–ç•¥çš„è®¿é—®è·¯å¾„

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL RLS

**åˆ›å»ºRLSç­–ç•¥**ï¼š

```sql
-- å¯ç”¨RLS
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºSELECTç­–ç•¥
CREATE POLICY account_select_policy ON accounts
    FOR SELECT
    USING (user_id = current_user_id());

-- åˆ›å»ºINSERTç­–ç•¥
CREATE POLICY account_insert_policy ON accounts
    FOR INSERT
    WITH CHECK (user_id = current_user_id());

-- åˆ›å»ºUPDATEç­–ç•¥
CREATE POLICY account_update_policy ON accounts
    FOR UPDATE
    USING (user_id = current_user_id())
    WITH CHECK (user_id = current_user_id());
```

**ç­–ç•¥ç»„åˆ**ï¼š

```sql
-- å¤šç­–ç•¥ç»„åˆï¼ˆORé€»è¾‘ï¼‰
CREATE POLICY manager_policy ON accounts
    FOR ALL
    USING (
        user_id = current_user_id() OR
        current_user_role() = 'manager'
    );
```

### 5.2 å®‰å…¨å‡½æ•°

**SECURITY DEFINERå‡½æ•°**ï¼š

```sql
-- åˆ›å»ºå®‰å…¨å‡½æ•°
CREATE FUNCTION get_account_balance(account_id INTEGER)
RETURNS NUMERIC
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    -- å‡½æ•°å†…éƒ¨å¯ä»¥ç»•è¿‡RLSï¼Œä½†éœ€è¦é¢å¤–æƒé™æ£€æŸ¥
    RETURN (SELECT balance FROM accounts WHERE id = account_id);
END;
$$ LANGUAGE plpgsql;
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Denning, D. E. (1976). "A Lattice Model of Secure Information Flow."**
  - ä¼šè®®: Communications of the ACM 1976
  - **é‡è¦æ€§**: ä¿¡æ¯æµå®‰å…¨çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ä¿¡æ¯æµå®‰å…¨çš„ç†è®ºæ¡†æ¶

- **Sabelfeld, A., & Myers, A. C. (2003). "Language-Based Information-Flow Security."**
  - ä¼šè®®: IEEE Journal on Selected Areas in Communications 2003
  - **é‡è¦æ€§**: åŸºäºè¯­è¨€çš„ä¿¡æ¯æµå®‰å…¨ç ”ç©¶
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†ä¿¡æ¯æµå®‰å…¨çš„å½¢å¼åŒ–æ–¹æ³•

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - è¡Œçº§å®‰å…¨](<https://www.postgresql.org/docs/current/ddl-rowsecurity.html>)**
  - PostgreSQL RLSå®ç°è¯´æ˜

- **[PostgreSQLå®˜æ–¹æ–‡æ¡£ - å®‰å…¨](<https://www.postgresql.org/docs/current/security.html>)**
  - PostgreSQLå®‰å…¨æœºåˆ¶è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: ğŸŸ¡ æ¡†æ¶å·²åˆ›å»ºï¼Œå†…å®¹å¾…å®Œå–„
