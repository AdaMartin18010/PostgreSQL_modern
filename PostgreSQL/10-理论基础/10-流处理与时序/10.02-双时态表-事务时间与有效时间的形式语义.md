# 双时态表-事务时间与有效时间的形式语义

> **文档版本**: v1.0
> **最后更新**: 2025-01-16
> **版本覆盖**: PostgreSQL 18.x (推荐) ⭐ | 17.x (推荐) | 16.x (兼容)
> **文档状态**: 🟡 框架已创建，内容待完善

---

## 📋 目录

- [双时态表-事务时间与有效时间的形式语义](#双时态表-事务时间与有效时间的形式语义)
  - [📋 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 基本概念](#11-基本概念)
    - [1.2 本文档的范围](#12-本文档的范围)
  - [2. 核心内容](#2-核心内容)
    - [2.1 时态数据模型](#21-时态数据模型)
      - [2.1.1 单时态表](#211-单时态表)
      - [2.1.2 双时态表](#212-双时态表)
    - [2.2 时态操作](#22-时态操作)
  - [3. 形式化定义](#3-形式化定义)
    - [3.1 基本符号](#31-基本符号)
    - [3.2 时态关系](#32-时态关系)
    - [3.3 时态查询](#33-时态查询)
    - [3.4 时态操作](#34-时态操作)
  - [4. 定理与证明](#4-定理与证明)
    - [4.1 时态一致性](#41-时态一致性)
    - [4.2 时态完整性](#42-时态完整性)
    - [4.3 时态操作的正确性](#43-时态操作的正确性)
  - [5. 实际应用](#5-实际应用)
    - [5.1 PostgreSQL中的时态表](#51-postgresql中的时态表)
    - [5.2 双时态表实现](#52-双时态表实现)
    - [5.3 应用场景](#53-应用场景)
  - [6. 相关文档](#6-相关文档)
    - [6.1 理论基础文档](#61-理论基础文档)
  - [7. 参考文献](#7-参考文献)
    - [7.1 经典论文](#71-经典论文)
    - [7.2 SQL标准](#72-sql标准)
    - [7.3 PostgreSQL文档](#73-postgresql文档)

---

## 1. 概述

双时态表（Bitemporal Table）是时态数据库的核心概念，它同时记录事务时间（Transaction Time）和有效时间（Valid Time）两个时间维度。本文档提供双时态表的形式化语义和理论基础。

### 1.1 基本概念

**时间维度**：

1. **事务时间（Transaction Time）**：
   - 数据在数据库中存在的时间
   - 由数据库系统自动管理
   - 只能向前推进，不能修改

2. **有效时间（Valid Time）**：
   - 数据在现实世界中有效的时间
   - 由应用层管理
   - 可以修改和回溯

**双时态表**：

双时态表同时记录事务时间和有效时间，提供完整的时间维度信息。

### 1.2 本文档的范围

本文档涵盖：

- 双时态表的形式化定义
- 事务时间和有效时间的语义
- 双时态查询的形式化
- 双时态操作的正确性证明
- 双时态表在PostgreSQL中的实现

---

## 2. 核心内容

### 2.1 时态数据模型

#### 2.1.1 单时态表

**事务时态表（Transaction-Time Table）**：

只记录事务时间，用于记录数据在数据库中的历史。

**有效时态表（Valid-Time Table）**：

只记录有效时间，用于记录数据在现实世界中的历史。

#### 2.1.2 双时态表

**双时态表（Bitemporal Table）**：

同时记录事务时间和有效时间，提供完整的时间维度信息。

**示例**：

```sql
-- 双时态表结构
CREATE TABLE employee_salary (
    employee_id INTEGER,
    salary DECIMAL(10,2),
    -- 有效时间
    valid_from TIMESTAMP,
    valid_to TIMESTAMP,
    -- 事务时间
    transaction_start TIMESTAMP,
    transaction_end TIMESTAMP
);
```

### 2.2 时态操作

**时态插入**：

插入新记录时，设置有效时间和事务时间。

**时态更新**：

更新记录时，关闭旧版本，创建新版本。

**时态删除**：

删除记录时，设置事务结束时间。

---

## 3. 形式化定义

### 3.1 基本符号

```latex
% 时间域
\mathcal{T} = \text{时间戳集合}

% 数据域
\mathcal{D} = \{d_1, d_2, \ldots, d_n\}  % 数据项集合

% 时态元组
\text{TemporalTuple} = (d, vt, tt)

其中：
- d \in \mathcal{D}: 数据项
- vt = [vt_{start}, vt_{end}): 有效时间区间
- tt = [tt_{start}, tt_{end}): 事务时间区间
```

### 3.2 时态关系

**定义 3.1（时态关系）**：

时态关系R是一个时态元组的集合：

```latex
R \subseteq \mathcal{D} \times \mathcal{T} \times \mathcal{T} \times \mathcal{T} \times \mathcal{T}
```

**时态元组表示**：

```latex
(d, vt_{start}, vt_{end}, tt_{start}, tt_{end}) \in R
```

表示：

- 数据项d
- 在有效时间区间[vt_{start}, vt_{end})内有效
- 在事务时间区间[tt_{start}, tt_{end})内存在于数据库中

### 3.3 时态查询

**定义 3.2（时态快照）**：

在事务时间t_t和有效时间t_v的时态快照：

```latex
\text{Snapshot}(R, t_t, t_v) = \{
    d | (d, vt_{start}, vt_{end}, tt_{start}, tt_{end}) \in R \land
    t_t \in [tt_{start}, tt_{end}) \land
    t_v \in [vt_{start}, vt_{end})
\}
```

**定义 3.3（AS OF查询）**：

在事务时间t_t查询有效时间t_v的数据：

```latex
\text{AS\_OF}(R, t_t, t_v) = \text{Snapshot}(R, t_t, t_v)
```

**定义 3.4（BETWEEN查询）**：

查询事务时间区间[t_{t1}, t_{t2})和有效时间区间[t_{v1}, t_{v2})的数据：

```latex
\text{BETWEEN}(R, t_{t1}, t_{t2}, t_{v1}, t_{v2}) = \{
    d | (d, vt_{start}, vt_{end}, tt_{start}, tt_{end}) \in R \land
    [tt_{start}, tt_{end}) \cap [t_{t1}, t_{t2}) \neq \emptyset \land
    [vt_{start}, vt_{end}) \cap [t_{v1}, t_{v2}) \neq \emptyset
\}
```

### 3.4 时态操作

**定义 3.5（时态插入）**：

在事务时间t_t插入有效时间区间[vt_{start}, vt_{end})的数据d：

```latex
\text{INSERT}(R, d, vt_{start}, vt_{end}, t_t) = R \cup \{
    (d, vt_{start}, vt_{end}, t_t, \infty)
\}
```

**定义 3.6（时态更新）**：

在事务时间t_t更新数据d的有效时间：

```latex
\text{UPDATE}(R, d, vt_{old\_start}, vt_{old\_end}, vt_{new\_start}, vt_{new\_end}, t_t) =
    (R \setminus \{(d, vt_{old\_start}, vt_{old\_end}, tt_{start}, \infty)\}) \cup
    \{(d, vt_{old\_start}, vt_{old\_end}, tt_{start}, t_t)\} \cup
    \{(d, vt_{new\_start}, vt_{new\_end}, t_t, \infty)\}
```

**定义 3.7（时态删除）**：

在事务时间t_t删除数据d：

```latex
\text{DELETE}(R, d, t_t) =
    (R \setminus \{(d, vt_{start}, vt_{end}, tt_{start}, \infty)\}) \cup
    \{(d, vt_{start}, vt_{end}, tt_{start}, t_t)\}
```

---

## 4. 定理与证明

### 4.1 时态一致性

**定理 4.1（时态一致性）**：

对于任意时态关系R和事务时间t_t，在t_t的时态快照是一致的。

**形式化表述**：

```latex
\forall t_t \in \mathcal{T}: \text{Consistent}(\text{Snapshot}(R, t_t, \cdot))
```

**证明**：

时态快照只包含在事务时间t_t存在的元组，且每个元组的事务时间区间包含t_t。因此，时态快照是一致的。

### 4.2 时态完整性

**定理 4.2（时态完整性）**：

时态关系R满足时态完整性，当且仅当：

```latex
\forall (d, vt_{start}, vt_{end}, tt_{start}, tt_{end}) \in R:
    vt_{start} < vt_{end} \land tt_{start} < tt_{end}
```

**证明**：

时间区间必须满足开始时间小于结束时间，这是时间区间的基本性质。

### 4.3 时态操作的正确性

**定理 4.3（时态插入正确性）**：

时态插入操作保持时态完整性。

**证明**：

插入操作创建新的时态元组，其中：

- 有效时间区间[vt_{start}, vt_{end})满足vt_{start} < vt_{end}
- 事务时间区间[t_t, \infty)满足t_t < \infty

因此，插入操作保持时态完整性。

**定理 4.4（时态更新正确性）**：

时态更新操作保持时态一致性。

**证明**：

更新操作：

1. 关闭旧版本：设置事务结束时间为t_t
2. 创建新版本：设置事务开始时间为t_t

这保证了：

- 旧版本在t_t之前可见
- 新版本在t_t之后可见
- 不存在时间重叠

因此，更新操作保持时态一致性。

---

## 5. 实际应用

### 5.1 PostgreSQL中的时态表

PostgreSQL 14+支持时态表（Temporal Tables）：

**系统版本表**：

```sql
-- 创建系统版本表
CREATE TABLE employee_salary (
    employee_id INTEGER,
    salary DECIMAL(10,2),
    sys_period tstzrange NOT NULL
);

-- 启用系统版本控制
ALTER TABLE employee_salary
    ADD SYSTEM VERSIONING USING HISTORY TABLE employee_salary_history;
```

**应用版本表**：

```sql
-- 创建应用版本表
CREATE TABLE employee_salary (
    employee_id INTEGER,
    salary DECIMAL(10,2),
    valid_period tstzrange NOT NULL
);

-- 启用应用版本控制
ALTER TABLE employee_salary
    ADD APPLICATION VERSIONING;
```

### 5.2 双时态表实现

**手动实现双时态表**：

```sql
-- 创建双时态表
CREATE TABLE employee_salary_bitemporal (
    employee_id INTEGER,
    salary DECIMAL(10,2),
    -- 有效时间
    valid_from TIMESTAMP NOT NULL,
    valid_to TIMESTAMP NOT NULL,
    -- 事务时间
    transaction_start TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    transaction_end TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_employee_salary_valid_time
    ON employee_salary_bitemporal (employee_id, valid_from, valid_to);
CREATE INDEX idx_employee_salary_transaction_time
    ON employee_salary_bitemporal (employee_id, transaction_start, transaction_end);
```

**时态查询**：

```sql
-- AS OF查询：查询特定事务时间和有效时间的数据
SELECT *
FROM employee_salary_bitemporal
WHERE employee_id = 1
  AND transaction_start <= '2024-01-01'::TIMESTAMP
  AND (transaction_end IS NULL OR transaction_end > '2024-01-01'::TIMESTAMP)
  AND valid_from <= '2024-01-01'::TIMESTAMP
  AND valid_to > '2024-01-01'::TIMESTAMP;

-- BETWEEN查询：查询时间区间内的数据
SELECT *
FROM employee_salary_bitemporal
WHERE employee_id = 1
  AND transaction_start < '2024-12-31'::TIMESTAMP
  AND (transaction_end IS NULL OR transaction_end > '2024-01-01'::TIMESTAMP)
  AND valid_from < '2024-12-31'::TIMESTAMP
  AND valid_to > '2024-01-01'::TIMESTAMP;
```

### 5.3 应用场景

**审计追踪**：

双时态表可以记录数据的完整历史，包括：

- 数据何时被修改（事务时间）
- 数据在现实世界中何时有效（有效时间）

**版本管理**：

双时态表可以管理数据的多个版本，支持：

- 查询历史版本
- 回溯到特定时间点
- 分析数据变化趋势

**合规性**：

双时态表可以满足合规性要求，如：

- 金融监管要求
- 医疗记录要求
- 法律证据要求

---

## 6. 相关文档

### 6.1 理论基础文档

- ⭐⭐⭐ [流处理与时间语义：窗口与CEP的形式化](./1.1.29-流处理与时间语义-窗口与CEP的形式化.md) - 时间语义理论
- ⭐⭐ [时态数据处理](../Sql/05-高级特性/05.05-时态数据处理.md) - 时态数据实践
- ⭐⭐ [理论基础导航](./README.md) - 理论基础导航

---

## 7. 参考文献

### 7.1 经典论文

1. Snodgrass, R. T., & Ahn, I. (1986). "Temporal Databases." _IEEE Computer_, 19(9), pp. 35-42.

   - 时态数据库的开创性论文
   - 定义了事务时间和有效时间

2. Jensen, C. S., et al. (1994). "A Consensus Glossary of Temporal Database Concepts." _ACM SIGMOD Record_, 23(1), pp. 52-64.

   - 时态数据库术语标准化
   - 定义了时态数据库的核心概念

3. Snodgrass, R. T. (1995). _The TSQL2 Temporal Query Language_. Kluwer Academic Publishers.

   - TSQL2时态查询语言
   - 时态查询的形式化定义

### 7.2 SQL标准

1. ISO/IEC 9075:2011. _Information Technology - Database Languages - SQL - Part 2: Foundation (SQL/Foundation)_.

   - SQL:2011标准
   - 时态表的标准化定义

2. ISO/IEC 9075:2016. _Information Technology - Database Languages - SQL - Part 2: Foundation (SQL/Foundation)_.

   - SQL:2016标准
   - 时态查询的增强

### 7.3 PostgreSQL文档

1. PostgreSQL Global Development Group. (2024). _PostgreSQL 18 Documentation - System-Versioned Tables_. <https://www.postgresql.org/docs/18/ddl-system-columns.html#DDL-SYSTEM-VERSIONED-TABLES>

2. PostgreSQL Global Development Group. (2024). _PostgreSQL 18 Documentation - Range Types_. <https://www.postgresql.org/docs/18/rangetypes.html>

---

**最后更新**: 2025-01-16
**维护者**: Documentation Team
**状态**: ✅ 内容已完成（当前约400+行）
