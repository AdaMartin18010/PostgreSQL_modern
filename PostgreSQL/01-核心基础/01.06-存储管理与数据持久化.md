# PostgreSQL å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°
> ğŸ†• **PostgreSQL 18å­˜å‚¨æ”¹è¿›**: å¼‚æ­¥I/Oå­ç³»ç»Ÿï¼ˆI/Oæ€§èƒ½æå‡2-3å€ï¼‰ã€å¢é‡å¤‡ä»½ï¼ˆèŠ‚çœ94%æ—¶é—´ï¼‰ã€WALæ±‡æ€»æœºåˆ¶ã€åŠ¨æ€å…±äº«å†…å­˜ï¼ˆæå‡20%æ•ˆç‡ï¼‰

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](#postgresql-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. å®šä¹‰ä¸å½¢å¼åŒ–](#1-å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1 ç¼“å†²åŒºç®¡ç†ç†è®º](#21-ç¼“å†²åŒºç®¡ç†ç†è®º)
    - [2.2 WALç†è®º](#22-walç†è®º)
    - [2.3 æ£€æŸ¥ç‚¹ç†è®º](#23-æ£€æŸ¥ç‚¹ç†è®º)
  - [3. PostgreSQLå­˜å‚¨æ¶æ„](#3-postgresqlå­˜å‚¨æ¶æ„)
    - [3.1 å­˜å‚¨ç»“æ„](#31-å­˜å‚¨ç»“æ„)
    - [3.2 é¡µé¢ç»“æ„](#32-é¡µé¢ç»“æ„)
    - [3.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€](#33-æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€)
  - [4. ç¼“å†²åŒºç®¡ç†](#4-ç¼“å†²åŒºç®¡ç†)
    - [4.1 ç¼“å†²åŒºé…ç½®](#41-ç¼“å†²åŒºé…ç½®)
    - [4.2 ç¼“å†²åŒºä¼˜åŒ–](#42-ç¼“å†²åŒºä¼˜åŒ–)
  - [5. WALæœºåˆ¶](#5-walæœºåˆ¶)
    - [5.1 WALé…ç½®](#51-walé…ç½®)
    - [5.2 WALå½’æ¡£](#52-walå½’æ¡£)
    - [5.3 æµå¤åˆ¶](#53-æµå¤åˆ¶)
  - [6. æ£€æŸ¥ç‚¹æœºåˆ¶](#6-æ£€æŸ¥ç‚¹æœºåˆ¶)
    - [6.1 æ£€æŸ¥ç‚¹é…ç½®](#61-æ£€æŸ¥ç‚¹é…ç½®)
    - [6.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–](#62-æ£€æŸ¥ç‚¹ä¼˜åŒ–)
  - [7. å­˜å‚¨ä¼˜åŒ–](#7-å­˜å‚¨ä¼˜åŒ–)
    - [7.1 è¡¨ç©ºé—´ç®¡ç†](#71-è¡¨ç©ºé—´ç®¡ç†)
    - [7.2 åˆ†åŒºè¡¨ä¼˜åŒ–](#72-åˆ†åŒºè¡¨ä¼˜åŒ–)
    - [7.3 å‹ç¼©å’ŒTOAST](#73-å‹ç¼©å’Œtoast)
    - [7.4 åˆ—å­˜å‚¨æ¶æ„åˆ†æ ğŸ†•](#74-åˆ—å­˜å‚¨æ¶æ„åˆ†æ-)
      - [åˆ—å­˜å‚¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#åˆ—å­˜å‚¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
      - [å­˜å‚¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘](#å­˜å‚¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘)
      - [è¡Œå­˜å‚¨ vs åˆ—å­˜å‚¨ vs æ··åˆå­˜å‚¨å¯¹æ¯”çŸ©é˜µ](#è¡Œå­˜å‚¨-vs-åˆ—å­˜å‚¨-vs-æ··åˆå­˜å‚¨å¯¹æ¯”çŸ©é˜µ)
      - [åˆ—å­˜å‚¨ç‰©ç†æ¶æ„å›¾](#åˆ—å­˜å‚¨ç‰©ç†æ¶æ„å›¾)
      - [åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œæµç¨‹å›¾](#åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œæµç¨‹å›¾)
      - [PostgreSQLåˆ—å­˜å‚¨æ‰©å±•å¯¹æ¯”çŸ©é˜µ](#postgresqlåˆ—å­˜å‚¨æ‰©å±•å¯¹æ¯”çŸ©é˜µ)
    - [7.5 åˆ—å‹ç¼©æŠ€æœ¯è¯¦è§£ ğŸ†•](#75-åˆ—å‹ç¼©æŠ€æœ¯è¯¦è§£-)
      - [7.5.1. å­—å…¸ç¼–ç ï¼ˆDictionary Encodingï¼‰](#751-å­—å…¸ç¼–ç dictionary-encoding)
      - [7.5.2. å¢é‡ç¼–ç ï¼ˆDelta Encodingï¼‰](#752-å¢é‡ç¼–ç delta-encoding)
      - [7.5.3. é€šç”¨å‹ç¼©ç®—æ³•](#753-é€šç”¨å‹ç¼©ç®—æ³•)
      - [åˆ—å­˜å‚¨æŠ€æœ¯æ ˆå¯¹æ¯”çŸ©é˜µ](#åˆ—å­˜å‚¨æŠ€æœ¯æ ˆå¯¹æ¯”çŸ©é˜µ)
  - [8. æ€§èƒ½ç›‘æ§](#8-æ€§èƒ½ç›‘æ§)
    - [8.1 I/Oæ€§èƒ½ç›‘æ§](#81-ioæ€§èƒ½ç›‘æ§)
    - [8.2 å­˜å‚¨æ€§èƒ½åˆ†æ](#82-å­˜å‚¨æ€§èƒ½åˆ†æ)
  - [9. å®é™…åº”ç”¨æ¡ˆä¾‹](#9-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [9.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–](#91-å¤§æ•°æ®è¡¨ä¼˜åŒ–)
    - [9.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–](#92-é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–)
  - [10. ç›¸å…³æ¦‚å¿µ](#10-ç›¸å…³æ¦‚å¿µ)
    - [10.1 ä¸Šä½æ¦‚å¿µ](#101-ä¸Šä½æ¦‚å¿µ)
    - [10.2 ä¸‹ä½æ¦‚å¿µ](#102-ä¸‹ä½æ¦‚å¿µ)
    - [10.3 å¹³è¡Œæ¦‚å¿µ](#103-å¹³è¡Œæ¦‚å¿µ)
  - [11. å‚è€ƒæ–‡çŒ®](#11-å‚è€ƒæ–‡çŒ®)
  - [12. Wikidataå¯¹é½](#12-wikidataå¯¹é½)

---

## 1. å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å­˜å‚¨ç®¡ç†æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç®¡ç†æ•°æ®æŒä¹…åŒ–å­˜å‚¨çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬ç¼“å†²åŒºç®¡ç†ã€WALæ—¥å¿—ã€æ£€æŸ¥ç‚¹ç­‰æ ¸å¿ƒç»„ä»¶ã€‚PostgreSQLé€šè¿‡é«˜æ•ˆçš„å­˜å‚¨ç®¡ç†ç¡®ä¿æ•°æ®çš„æŒä¹…æ€§å’Œç³»ç»Ÿçš„é«˜æ€§èƒ½ã€‚

**English Definition**: Storage management is a mechanism in database systems that manages persistent data storage, including buffer management, WAL logging, checkpoints, and other core components. PostgreSQL ensures data durability and high system performance through efficient storage management.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\storage}{\mathcal{S}}
\newcommand{\buffer}{\mathcal{B}}
\newcommand{\wal}{\mathcal{W}}
\newcommand{\page}{\mathcal{P}}
\newcommand{\disk}{\mathcal{D}}

% å­˜å‚¨ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰
\storage = (\buffer, \wal, \page, \disk)

å…¶ä¸­ï¼š
\buffer = \{b_1, b_2, \ldots, b_n\}: ç¼“å†²åŒºé¡µé¢é›†åˆ
\wal = \{w_1, w_2, \ldots, w_m\}: WALæ—¥å¿—è®°å½•é›†åˆ
\page = \{p_1, p_2, \ldots, p_k\}: ç£ç›˜é¡µé¢é›†åˆ
\disk = \{d_1, d_2, \ldots, d_l\}: ç£ç›˜å­˜å‚¨é›†åˆ
```

### 1.3 æ ¸å¿ƒå±æ€§

- **æŒä¹…æ€§**: ç¡®ä¿æ•°æ®æ°¸ä¹…ä¿å­˜
- **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ€§èƒ½**: ä¼˜åŒ–I/Oæ“ä½œæ•ˆç‡
- **å¯æ¢å¤æ€§**: æ”¯æŒæ•…éšœæ¢å¤

## 2. ç†è®ºåŸºç¡€

### 2.1 ç¼“å†²åŒºç®¡ç†ç†è®º

```latex
\begin{theorem}[ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥]
LRU (Least Recently Used) ç­–ç•¥ï¼š
1. æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢ä¼˜å…ˆè¢«æ›¿æ¢
2. æ—¶é—´å¤æ‚åº¦ï¼šO(1) æŸ¥æ‰¾å’Œæ›´æ–°
3. ç©ºé—´å¤æ‚åº¦ï¼šO(n) å­˜å‚¨å¼€é”€
\end{theorem}

\begin{proof}
åŸºäºè®¿é—®æ—¶é—´æˆ³å’ŒåŒå‘é“¾è¡¨ç»“æ„ï¼Œå¯ä»¥è¯æ˜LRUç­–ç•¥çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 2.2 WALç†è®º

```latex
\begin{theorem}[WALåè®®]
Write-Ahead Loggingåè®®è¦æ±‚ï¼š
1. åœ¨ä¿®æ”¹æ•°æ®é¡µé¢å‰ï¼Œå¿…é¡»å…ˆå†™WALæ—¥å¿—
2. æ—¥å¿—è®°å½•å¿…é¡»æŒä¹…åŒ–åˆ°ç£ç›˜
3. æ£€æŸ¥ç‚¹æœºåˆ¶ç¡®ä¿æ•°æ®é¡µé¢çš„æŒä¹…åŒ–
\end{theorem}

\begin{proof}
åŸºäºæ•…éšœæ¢å¤çš„éœ€æ±‚å’Œæ—¥å¿—çš„å®Œæ•´æ€§ï¼Œå¯ä»¥è¯æ˜WALåè®®çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 2.3 æ£€æŸ¥ç‚¹ç†è®º

```latex
\begin{theorem}[æ£€æŸ¥ç‚¹ä¸€è‡´æ€§]
æ£€æŸ¥ç‚¹ç¡®ä¿ï¼š
1. æ‰€æœ‰è„é¡µè¢«å†™å…¥ç£ç›˜
2. WALæ—¥å¿—è¢«æˆªæ–­
3. ç³»ç»ŸçŠ¶æ€ä¸€è‡´
\end{theorem}
```

## 3. PostgreSQLå­˜å‚¨æ¶æ„

### 3.1 å­˜å‚¨ç»“æ„

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹è¡¨ç©ºé—´
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) as size
FROM pg_tablespace;
```

### 3.2 é¡µé¢ç»“æ„

```sql
-- æŸ¥çœ‹é¡µé¢ä¿¡æ¯
SELECT
    relname,
    relpages,
    reltuples,
    relallvisible,
    relfrozenxid
FROM pg_class
WHERE relkind = 'r'
ORDER BY relpages DESC;

-- æŸ¥çœ‹é¡µé¢ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables;
```

### 3.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€

```sql
-- æŸ¥çœ‹æ•°æ®ç›®å½•
SHOW data_directory;

-- æŸ¥çœ‹WALç›®å½•
SHOW log_directory;

-- æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®
SHOW config_file;
SHOW hba_file;
SHOW ident_file;
```

## 4. ç¼“å†²åŒºç®¡ç†

### 4.1 ç¼“å†²åŒºé…ç½®

```sql
-- æŸ¥çœ‹ç¼“å†²åŒºé…ç½®
SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;
SHOW maintenance_work_mem;

-- æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æŸ¥çœ‹ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
SELECT
    c.relname,
    c.relkind,
    pg_size_pretty(pg_relation_size(c.oid)) as size,
    pg_stat_get_tuples_returned(c.oid) as tuples_returned,
    pg_stat_get_tuples_fetched(c.oid) as tuples_fetched,
    pg_stat_get_tuples_inserted(c.oid) as tuples_inserted,
    pg_stat_get_tuples_updated(c.oid) as tuples_updated,
    pg_stat_get_tuples_deleted(c.oid) as tuples_deleted
FROM pg_class c
WHERE c.relkind IN ('r', 'i')
ORDER BY pg_relation_size(c.oid) DESC;
```

### 4.2 ç¼“å†²åŒºä¼˜åŒ–

```sql
-- ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    round(100.0 * sum(blks_hit) / (sum(blks_hit) + sum(blks_read)), 2) as hit_ratio
FROM pg_stat_database;

-- è¡¨çº§ç¼“å†²åŒºç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 0
ORDER BY hit_ratio ASC;
```

## 5. WALæœºåˆ¶

### 5.1 WALé…ç½®

```sql
-- WALé…ç½®å‚æ•°
SHOW wal_level;
SHOW wal_buffers;
SHOW checkpoint_timeout;
SHOW max_wal_size;
SHOW min_wal_size;
SHOW wal_compression;
SHOW wal_log_hints;

-- WALç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_wal;

-- WALä½ç½®ä¿¡æ¯
SELECT pg_current_wal_lsn();
SELECT pg_walfile_name(pg_current_wal_lsn());
SELECT pg_walfile_name_offset(pg_current_wal_lsn());
```

### 5.2 WALå½’æ¡£

```sql
-- WALå½’æ¡£é…ç½®
SHOW archive_mode;
SHOW archive_command;
SHOW archive_timeout;

-- æŸ¥çœ‹å½’æ¡£çŠ¶æ€
SELECT * FROM pg_stat_archiver;

-- æ‰‹åŠ¨å½’æ¡£
SELECT pg_switch_wal();

-- æŸ¥çœ‹WALæ–‡ä»¶
SELECT
    name,
    size,
    modification
FROM pg_ls_waldir()
ORDER BY modification DESC;
```

### 5.3 æµå¤åˆ¶

```sql
-- æµå¤åˆ¶é…ç½®
SHOW wal_sender_timeout;
SHOW wal_receiver_timeout;
SHOW max_wal_senders;
SHOW max_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;
```

## 6. æ£€æŸ¥ç‚¹æœºåˆ¶

### 6.1 æ£€æŸ¥ç‚¹é…ç½®

```sql
-- æ£€æŸ¥ç‚¹é…ç½®
SHOW checkpoint_timeout;
SHOW checkpoint_completion_target;
SHOW max_wal_size;
SHOW min_wal_size;

-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æ‰‹åŠ¨æ£€æŸ¥ç‚¹
CHECKPOINT;
```

### 6.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–

```sql
-- æ£€æŸ¥ç‚¹æ€§èƒ½åˆ†æ
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;

-- æ£€æŸ¥ç‚¹é¢‘ç‡åˆ†æ
SELECT
    checkpoints_timed + checkpoints_req as total_checkpoints,
    round(extract(epoch from now() - pg_postmaster_start_time()) / (checkpoints_timed + checkpoints_req), 2) as avg_interval_seconds
FROM pg_stat_bgwriter;
```

## 7. å­˜å‚¨ä¼˜åŒ–

### 7.1 è¡¨ç©ºé—´ç®¡ç†

```sql
-- åˆ›å»ºè¡¨ç©ºé—´
CREATE TABLESPACE fastspace LOCATION '/fast/disk/postgresql';

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨
CREATE TABLE large_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) TABLESPACE fastspace;

-- ç§»åŠ¨è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE large_table SET TABLESPACE fastspace;

-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    t.spcname,
    pg_size_pretty(pg_tablespace_size(t.spcname)) as size
FROM pg_tablespace t;
```

### 7.2 åˆ†åŒºè¡¨ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE sales (
    id SERIAL,
    sale_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2023 PARTITION OF sales
FOR VALUES FROM ('2023-01-01') TO ('2024-01-01')
TABLESPACE fastspace;

CREATE TABLE sales_2024 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01')
TABLESPACE fastspace;

-- æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE tablename LIKE 'sales_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7.3 å‹ç¼©å’ŒTOAST

```sql
-- æŸ¥çœ‹TOASTè¡¨
SELECT
    c.relname,
    t.relname as toast_table,
    pg_size_pretty(pg_total_relation_size(t.oid)) as toast_size
FROM pg_class c
JOIN pg_class t ON t.oid = c.reltoastrelid
WHERE c.relkind = 'r'
ORDER BY pg_total_relation_size(t.oid) DESC;

-- å‹ç¼©é…ç½®
ALTER TABLE large_table SET (toast_tuple_target = 128);
ALTER TABLE large_table SET (fillfactor = 80);
```

### 7.4 åˆ—å­˜å‚¨æ¶æ„åˆ†æ ğŸ†•

#### åˆ—å­˜å‚¨çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((åˆ—å­˜å‚¨çŸ¥è¯†ä½“ç³»))
    ç†è®ºåŸºç¡€
      åˆ—å­˜å‚¨ç†è®º
        C-Storeç†è®º
        åˆ—å­˜å‚¨ä¼˜åŠ¿
        åˆ—å­˜å‚¨åŠ£åŠ¿
      å‹ç¼©ç†è®º
        å­—å…¸ç¼–ç 
        æ¸¸ç¨‹ç¼–ç 
        å¢é‡ç¼–ç 
        é€šç”¨å‹ç¼©
      æŸ¥è¯¢ä¼˜åŒ–ç†è®º
        æŠ•å½±ä¸‹æ¨
        è°“è¯ä¸‹æ¨
        å‘é‡åŒ–æ‰§è¡Œ
    PostgreSQLå®ç°
      æ‰©å±•æ–¹æ¡ˆ
        cstore_fdw
        Citusåˆ—å­˜å‚¨
        Greenplum
      å­˜å‚¨æ¶æ„
        åˆ—å­˜å‚¨æ–‡ä»¶ç»“æ„
        å‹ç¼©å­˜å‚¨
        ç´¢å¼•æ”¯æŒ
      æŸ¥è¯¢ä¼˜åŒ–
        åˆ—é€‰æ‹©ä¼˜åŒ–
        èšåˆä¼˜åŒ–
        å¹¶è¡ŒæŸ¥è¯¢
    åº”ç”¨åœºæ™¯
      æ•°æ®ä»“åº“
        OLAPæŸ¥è¯¢
        æ‰¹é‡åˆ†æ
        æŠ¥è¡¨ç”Ÿæˆ
      æ•°æ®åˆ†æ
        æ—¶é—´åºåˆ—åˆ†æ
        ç”¨æˆ·è¡Œä¸ºåˆ†æ
        å®æ—¶åˆ†æ
      æ··åˆè´Ÿè½½
        çƒ­æ•°æ®è¡Œå­˜å‚¨
        å†·æ•°åˆ—å­˜å‚¨
    æ€§èƒ½ä¼˜åŒ–
      å‹ç¼©ä¼˜åŒ–
        ç®—æ³•é€‰æ‹©
        å‹ç¼©å‚æ•°
        å‹ç¼©ç‡ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–
        åˆ—é€‰æ‹©
        èšåˆä¼˜åŒ–
        å¹¶è¡Œå¤„ç†
      å­˜å‚¨ä¼˜åŒ–
        åˆ†åŒºç­–ç•¥
        å†·çƒ­åˆ†ç¦»
        æ··åˆå­˜å‚¨
```

#### å­˜å‚¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å­˜å‚¨æ¶æ„] --> B{æŸ¥è¯¢æ¨¡å¼}

    B -->|ç‚¹æŸ¥è¯¢ä¸ºä¸»<br/>SELECT * WHERE id = ?| C[è¡Œå­˜å‚¨ âœ…]
    B -->|åˆ†ææŸ¥è¯¢ä¸ºä¸»<br/>SELECT col1, SUM col2 GROUP BY| D{æ•°æ®é‡}
    B -->|æ··åˆåœºæ™¯<br/>ç‚¹æŸ¥è¯¢+åˆ†ææŸ¥è¯¢| J[æ··åˆå­˜å‚¨æ¶æ„ âœ…]

    D -->|< 100GB| E{æ›´æ–°é¢‘ç‡}
    D -->|100GB - 1TB| F{æ›´æ–°é¢‘ç‡}
    D -->|> 1TB| I[åˆ—å­˜å‚¨ âœ…]

    E -->|é¢‘ç¹æ›´æ–°| G[è¡Œå­˜å‚¨ + ç´¢å¼• âœ…]
    E -->|åªè¯»/å¾ˆå°‘æ›´æ–°| H[åˆ—å­˜å‚¨ âœ…]

    F -->|é¢‘ç¹æ›´æ–°| G1[è¡Œå­˜å‚¨ + åˆ†åŒº âœ…]
    F -->|åªè¯»/å¾ˆå°‘æ›´æ–°| H1[åˆ—å­˜å‚¨ âœ…]

    J --> J1[çƒ­æ•°æ®: è¡Œå­˜å‚¨<br/>æœ€è¿‘æ•°æ®]
    J --> J2[å†·æ•°æ®: åˆ—å­˜å‚¨<br/>å†å²æ•°æ®]

    style C fill:#90EE90
    style G fill:#90EE90
    style G1 fill:#90EE90
    style H fill:#87CEEB
    style H1 fill:#87CEEB
    style I fill:#87CEEB
    style J fill:#FFD700
    style J1 fill:#90EE90
    style J2 fill:#87CEEB
```

#### è¡Œå­˜å‚¨ vs åˆ—å­˜å‚¨ vs æ··åˆå­˜å‚¨å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | è¡Œå­˜å‚¨ | åˆ—å­˜å‚¨ | æ··åˆå­˜å‚¨ | æœ€ä½³é€‰æ‹© |
|------|--------|--------|---------|---------|
| **ç‚¹æŸ¥è¯¢ï¼ˆå•è¡Œï¼‰** | â­â­â­â­â­ | â­â­ | â­â­â­â­ | è¡Œå­˜å‚¨ |
| **åˆ—æ‰«æï¼ˆå•åˆ—ï¼‰** | â­â­ | â­â­â­â­â­ | â­â­â­â­ | åˆ—å­˜å‚¨ |
| **èšåˆæŸ¥è¯¢** | â­â­ | â­â­â­â­â­ | â­â­â­â­ | åˆ—å­˜å‚¨ |
| **æ’å…¥å•è¡Œ** | â­â­â­â­â­ | â­â­ | â­â­â­ | è¡Œå­˜å‚¨ |
| **æ›´æ–°å•è¡Œ** | â­â­â­â­â­ | â­â­ | â­â­â­ | è¡Œå­˜å‚¨ |
| **æ‰¹é‡æ’å…¥** | â­â­â­â­ | â­â­â­ | â­â­â­ | è¡Œå­˜å‚¨ç•¥ä¼˜ |
| **å‹ç¼©ç‡** | â­â­ (10-30%) | â­â­â­â­â­ (70-90%) | â­â­â­â­ (50-70%) | åˆ—å­˜å‚¨ |
| **OLTPè´Ÿè½½** | â­â­â­â­â­ | â­â­ | â­â­â­â­ | è¡Œå­˜å‚¨ |
| **OLAPè´Ÿè½½** | â­â­ | â­â­â­â­â­ | â­â­â­â­ | åˆ—å­˜å‚¨ |
| **å­˜å‚¨æˆæœ¬** | â­â­ | â­â­â­â­â­ | â­â­â­â­ | åˆ—å­˜å‚¨ |
| **æŸ¥è¯¢å»¶è¿Ÿ** | â­â­â­â­ (ä½) | â­â­â­ (ä¸­) | â­â­â­â­ (ä½-ä¸­) | è¡Œå­˜å‚¨ |
| **ååé‡** | â­â­â­ (ä¸­) | â­â­â­â­â­ (é«˜) | â­â­â­â­ (ä¸­-é«˜) | åˆ—å­˜å‚¨ |
| **ç»´æŠ¤å¤æ‚åº¦** | â­â­â­â­â­ (ä½) | â­â­â­ (ä¸­) | â­â­ (é«˜) | è¡Œå­˜å‚¨ |
| **é€‚ç”¨åœºæ™¯** | OLTPã€ç‚¹æŸ¥è¯¢ | OLAPã€åˆ†ææŸ¥è¯¢ | æ··åˆè´Ÿè½½ | - |

**PostgreSQLçš„è¡Œå­˜å‚¨æ¶æ„**ï¼š

PostgreSQLé‡‡ç”¨**è¡Œå­˜å‚¨ï¼ˆRow-Oriented Storageï¼‰**ä½œä¸ºé»˜è®¤å­˜å‚¨æ–¹å¼ï¼Œæ¯æ¡è®°å½•ï¼ˆè¡Œï¼‰çš„æ‰€æœ‰åˆ—å€¼è¿ç»­å­˜å‚¨åœ¨å †æ–‡ä»¶ä¸­ï¼š

```text
å †æ–‡ä»¶ç»“æ„ï¼ˆè¡Œå­˜å‚¨ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ é¡µå¤´éƒ¨ (Page Header)             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ è¡ŒæŒ‡é’ˆæ•°ç»„ (Line Pointers)       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å…ƒç»„1: [id, name, age, email]   â”‚ â† å®Œæ•´è¡Œ
  â”‚ å…ƒç»„2: [id, name, age, email]   â”‚ â† å®Œæ•´è¡Œ
  â”‚ å…ƒç»„3: [id, name, age, email]   â”‚ â† å®Œæ•´è¡Œ
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡Œå­˜å‚¨ä¼˜åŠ¿**ï¼š

1. **äº‹åŠ¡æ€§èƒ½**ï¼šå•è¡Œæ›´æ–°åªéœ€ä¿®æ”¹ä¸€ä¸ªå…ƒç»„
2. **ç‚¹æŸ¥è¯¢**ï¼šé€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½æ•´è¡Œæ•°æ®
3. **æ’å…¥æ€§èƒ½**ï¼šæ’å…¥æ–°è¡Œåªéœ€è¿½åŠ ä¸€ä¸ªå…ƒç»„
4. **OLTPåœºæ™¯**ï¼šé€‚åˆäº‹åŠ¡å¤„ç†ï¼Œè¯»å†™æ··åˆè´Ÿè½½

**åˆ—å­˜å‚¨æ¶æ„ç†è®º**ï¼š

è™½ç„¶PostgreSQLåŸç”Ÿæ˜¯è¡Œå­˜å‚¨ï¼Œä½†å¯ä»¥é€šè¿‡æ‰©å±•å®ç°åˆ—å­˜å‚¨ï¼š

```text
åˆ—å­˜å‚¨æ–‡ä»¶ç»“æ„ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ åˆ—1æ•°æ®å—: [valâ‚, valâ‚‚, ..., valâ‚™] â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ åˆ—2æ•°æ®å—: [valâ‚, valâ‚‚, ..., valâ‚™] â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ åˆ—3æ•°æ®å—: [valâ‚, valâ‚‚, ..., valâ‚™] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ—å­˜å‚¨ä¼˜åŠ¿**ï¼š

1. **åˆ—æ‰«ææ•ˆç‡**ï¼šåªè¯»å–éœ€è¦çš„åˆ—ï¼ŒI/Oå‡å°‘
2. **å‹ç¼©æ•ˆç‡**ï¼šåŒåˆ—æ•°æ®ç±»å‹ç›¸åŒï¼Œå‹ç¼©ç‡é«˜
3. **èšåˆæŸ¥è¯¢**ï¼šé€‚åˆSUMã€AVGã€COUNTç­‰èšåˆæ“ä½œ
4. **å‘é‡åŒ–å¤„ç†**ï¼šåˆ—æ•°æ®å¯æ‰¹é‡å¤„ç†ï¼ŒSIMDä¼˜åŒ–

#### åˆ—å­˜å‚¨ç‰©ç†æ¶æ„å›¾

```mermaid
graph TB
    subgraph "PostgreSQLåˆ—å­˜å‚¨æ¶æ„"
        A[åº”ç”¨å±‚] --> B[æŸ¥è¯¢ä¼˜åŒ–å™¨]
        B --> C{å­˜å‚¨ç±»å‹}

        C -->|è¡Œå­˜å‚¨| D[å †æ–‡ä»¶<br/>Heap File]
        C -->|åˆ—å­˜å‚¨| E[cstore_fdwæ‰©å±•]

        D --> D1[é¡µé¢1: è¡Œ1, è¡Œ2, è¡Œ3...]
        D --> D2[é¡µé¢2: è¡Œ4, è¡Œ5, è¡Œ6...]

        E --> E1[åˆ—æ–‡ä»¶1<br/>Column File 1]
        E --> E2[åˆ—æ–‡ä»¶2<br/>Column File 2]
        E --> E3[åˆ—æ–‡ä»¶N<br/>Column File N]

        E1 --> F1[å‹ç¼©å—1]
        E1 --> F2[å‹ç¼©å—2]

        E2 --> G1[å‹ç¼©å—1]
        E2 --> G2[å‹ç¼©å—2]

        F1 --> H1[å­—å…¸ç¼–ç ]
        F2 --> H2[å¢é‡ç¼–ç ]
        G1 --> H3[é€šç”¨å‹ç¼©]
    end

    style D fill:#90EE90
    style E fill:#87CEEB
    style E1 fill:#87CEEB
    style E2 fill:#87CEEB
    style E3 fill:#87CEEB
```

#### åˆ—å­˜å‚¨æŸ¥è¯¢æ‰§è¡Œæµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client
    participant Query Optimizer
    participant cstore_fdw
    participant Column Files
    participant Compression

    Client->>Query Optimizer: SELECT col1, SUM(col2) GROUP BY col1
    Query Optimizer->>Query Optimizer: åˆ†ææŸ¥è¯¢ï¼Œè¯†åˆ«åˆ—å­˜å‚¨è¡¨
    Query Optimizer->>Query Optimizer: ä¼˜åŒ–ï¼šåªè¯»å–éœ€è¦çš„åˆ—
    Query Optimizer->>cstore_fdw: æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’

    cstore_fdw->>Column Files: è¯»å–col1åˆ—æ–‡ä»¶
    Column Files->>Compression: è§£å‹ç¼©col1æ•°æ®
    Compression-->>Column Files: è¿”å›col1æ•°æ®

    cstore_fdw->>Column Files: è¯»å–col2åˆ—æ–‡ä»¶
    Column Files->>Compression: è§£å‹ç¼©col2æ•°æ®
    Compression-->>Column Files: è¿”å›col2æ•°æ®

    cstore_fdw->>cstore_fdw: æ‰§è¡ŒGROUP BYå’ŒSUMèšåˆ
    cstore_fdw-->>Query Optimizer: è¿”å›èšåˆç»“æœ
    Query Optimizer-->>Client: è¿”å›æœ€ç»ˆç»“æœ

    Note over cstore_fdw,Column Files: åªè¯»å–éœ€è¦çš„åˆ—ï¼ŒI/Oå‡å°‘50-90%
    Note over Compression: åˆ—å‹ç¼©ç‡70-90%
```

#### PostgreSQLåˆ—å­˜å‚¨æ‰©å±•å¯¹æ¯”çŸ©é˜µ

| æ‰©å±• | ç±»å‹ | æ€§èƒ½ | å‹ç¼©ç‡ | æ˜“ç”¨æ€§ | ç»´æŠ¤çŠ¶æ€ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|--------|---------|---------|
| **cstore_fdw** | å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | âœ… æ´»è·ƒ | å•æœºåˆ—å­˜å‚¨ |
| **Citusåˆ—å­˜å‚¨** | åˆ†å¸ƒå¼æ‰©å±• | â­â­â­â­ | â­â­â­â­ | â­â­â­ | âœ… æ´»è·ƒ | åˆ†å¸ƒå¼åˆ—å­˜å‚¨ |
| **Greenplum** | æ•°æ®ä»“åº“ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | âœ… æ´»è·ƒ | ä¼ä¸šæ•°æ®ä»“åº“ |
| **PostgreSQLåŸç”Ÿ** | è¡Œå­˜å‚¨ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | âœ… å®˜æ–¹ | OLTPåœºæ™¯ |

**PostgreSQLåˆ—å­˜å‚¨æ‰©å±•**ï¼š

PostgreSQLæ”¯æŒé€šè¿‡æ‰©å±•å®ç°åˆ—å­˜å‚¨ï¼š

1. **cstore_fdwæ‰©å±•**ï¼šåˆ—å­˜å‚¨å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼Œé€‚åˆå•æœºåˆ—å­˜å‚¨åœºæ™¯
2. **Citusåˆ—å­˜å‚¨**ï¼šåˆ†å¸ƒå¼åˆ—å­˜å‚¨ï¼Œé€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼åœºæ™¯
3. **Greenplum**ï¼šåŸºäºPostgreSQLçš„åˆ—å­˜å‚¨æ•°æ®ä»“åº“ï¼Œé€‚åˆä¼ä¸šçº§æ•°æ®ä»“åº“

**åˆ—å­˜å‚¨æ‰©å±•ä½¿ç”¨ç¤ºä¾‹**ï¼š

```sql
-- å®‰è£…cstore_fdwæ‰©å±•
CREATE EXTENSION cstore_fdw;

-- åˆ›å»ºåˆ—å­˜å‚¨å¤–éƒ¨è¡¨
CREATE SERVER cstore_server
FOREIGN DATA WRAPPER cstore_fdw;

-- åˆ›å»ºåˆ—å­˜å‚¨è¡¨
CREATE FOREIGN TABLE sales_columnar (
    id INTEGER,
    product_id INTEGER,
    sale_date DATE,
    amount DECIMAL(10,2),
    quantity INTEGER
) SERVER cstore_server
OPTIONS (compression 'pglz');

-- æ’å…¥æ•°æ®
INSERT INTO sales_columnar
SELECT id, product_id, sale_date, amount, quantity
FROM sales;

-- åˆ—å­˜å‚¨æŸ¥è¯¢ä¼˜åŠ¿
SELECT product_id, SUM(amount), AVG(quantity)
FROM sales_columnar
WHERE sale_date >= '2024-01-01'
GROUP BY product_id;
-- åªæ‰«æproduct_id, amount, quantity, sale_dateåˆ—
```

### 7.5 åˆ—å‹ç¼©æŠ€æœ¯è¯¦è§£ ğŸ†•

**åˆ—å‹ç¼©æ¦‚è¿°**ï¼š

åˆ—å‹ç¼©æ˜¯åˆ—å­˜å‚¨çš„æ ¸å¿ƒä¼˜åŠ¿ä¹‹ä¸€ã€‚ç”±äºåˆ—å­˜å‚¨ä¸­åŒä¸€åˆ—çš„æ•°æ®ç±»å‹ç›¸åŒï¼Œæ•°æ®åˆ†å¸ƒç›¸ä¼¼ï¼Œå‹ç¼©æ•ˆç‡è¿œé«˜äºè¡Œå­˜å‚¨ã€‚

**PostgreSQLåˆ—å‹ç¼©ç®—æ³•**ï¼š

#### 7.5.1. å­—å…¸ç¼–ç ï¼ˆDictionary Encodingï¼‰

**åŸç†**ï¼šå°†é‡å¤å€¼æ˜ å°„åˆ°å­—å…¸ç´¢å¼•ï¼Œç”¨çŸ­æ•´æ•°ä»£æ›¿é•¿å­—ç¬¦ä¸²ã€‚

```sql
-- cstore_fdwè‡ªåŠ¨åº”ç”¨å­—å…¸ç¼–ç 
CREATE FOREIGN TABLE logs_columnar (
    id INTEGER,
    action TEXT,  -- ä½åŸºæ•°åˆ—ï¼Œè‡ªåŠ¨å­—å…¸ç¼–ç 
    user_id INTEGER,
    timestamp TIMESTAMP
) SERVER cstore_server
OPTIONS (compression 'pglz');

-- å­—å…¸ç¼–ç æ•ˆæœ
-- åŸå§‹: ['login', 'logout', 'login', 'view', 'login']
-- ç¼–ç : [0, 1, 0, 2, 0]
-- å‹ç¼©ç‡: é€šå¸¸40-60%
```

#### 7.5.2. å¢é‡ç¼–ç ï¼ˆDelta Encodingï¼‰

**åŸç†**ï¼šå­˜å‚¨ç›¸é‚»å€¼çš„å·®å€¼è€Œéç»å¯¹å€¼ã€‚

```sql
-- å¯¹æœ‰åºæ—¶é—´æˆ³åˆ—åº”ç”¨å¢é‡ç¼–ç 
CREATE FOREIGN TABLE events_columnar (
    id INTEGER,
    event_time TIMESTAMP,  -- æœ‰åºåˆ—ï¼Œå¢é‡ç¼–ç 
    value INTEGER
) SERVER cstore_server
OPTIONS (compression 'pglz');

-- å¢é‡ç¼–ç æ•ˆæœ
-- åŸå§‹: [1000, 1005, 1007, 1010, 1015]
-- ç¼–ç : [1000, +5, +2, +3, +5]
-- å‹ç¼©ç‡: é€šå¸¸50-70%
```

#### 7.5.3. é€šç”¨å‹ç¼©ç®—æ³•

**PostgreSQLæ”¯æŒçš„å‹ç¼©ç®—æ³•**ï¼š

| å‹ç¼©ç®—æ³• | å‹ç¼©ç‡ | å‹ç¼©é€Ÿåº¦ | è§£å‹é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|---------|--------|---------|---------|---------|
| **pglz** | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | é»˜è®¤å‹ç¼© |
| **lz4** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | å¿«é€Ÿå‹ç¼© |
| **zstd** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | é«˜å‹ç¼©ç‡ |

**å‹ç¼©é…ç½®**ï¼š

```sql
-- åˆ›å»ºåˆ—å­˜å‚¨è¡¨ï¼ŒæŒ‡å®šå‹ç¼©ç®—æ³•
CREATE FOREIGN TABLE analytics_columnar (
    id INTEGER,
    metric_name TEXT,
    metric_value DOUBLE PRECISION,
    timestamp TIMESTAMP
) SERVER cstore_server
OPTIONS (
    compression 'zstd',  -- ä½¿ç”¨zstdå‹ç¼©
    stripe_row_count '150000'  -- æ¡å¸¦è¡Œæ•°
);
```

**åˆ—å‹ç¼©æ€§èƒ½åˆ†æ**ï¼š

```text
å‹ç¼©æ”¶ç›Šè®¡ç®—ï¼š
  CompressionBenefit = {
    StorageSavings: OriginalSize - CompressedSize
    IOReduction: (1 - CompressedSize/OriginalSize) Ã— ReadIO
    CacheEfficiency: MoreDataInCache
  }

å‹ç¼©æˆæœ¬ï¼š
  CompressionCost = {
    CPU: CompressTime + DecompressTime
    Memory: CompressBuffer + DecompressBuffer
    Latency: DecompressOverhead
  }

å‹ç¼©å†³ç­–ï¼š
  UseCompression âŸº CompressionBenefit > CompressionCost
```

#### åˆ—å­˜å‚¨æŠ€æœ¯æ ˆå¯¹æ¯”çŸ©é˜µ

**PostgreSQLåˆ—å­˜å‚¨ vs ä¸»æµåˆ—å­˜å‚¨æ•°æ®åº“**ï¼š

| ç»´åº¦ | PostgreSQL + cstore_fdw | ClickHouse | DuckDB | Snowflake | BigQuery | Redshift |
|------|------------------------|------------|--------|-----------|----------|----------|
| **ç±»å‹** | æ‰©å±• | ä¸“ç”¨åˆ—å­˜å‚¨ | åµŒå…¥å¼ | äº‘åŸç”Ÿ | äº‘åŸç”Ÿ | äº‘åŸç”Ÿ |
| **æ€§èƒ½** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **å‹ç¼©ç‡** | â­â­â­ (50-70%) | â­â­â­â­â­ (70-90%) | â­â­â­â­ (60-80%) | â­â­â­â­ (60-80%) | â­â­â­â­ (60-80%) | â­â­â­â­ (60-80%) |
| **äº‹åŠ¡æ”¯æŒ** | â­â­â­â­â­ (ACID) | â­ (æœ‰é™) | â­â­â­ (ACID) | â­â­â­â­ (ACID) | â­â­â­â­ (ACID) | â­â­â­â­ (ACID) |
| **SQLå…¼å®¹** | â­â­â­â­â­ (å®Œæ•´SQL) | â­â­â­ (ç±»SQL) | â­â­â­â­ (SQL) | â­â­â­â­â­ (å®Œæ•´SQL) | â­â­â­â­â­ (å®Œæ•´SQL) | â­â­â­â­â­ (å®Œæ•´SQL) |
| **æ˜“ç”¨æ€§** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **æˆæœ¬** | â­â­â­â­â­ (å¼€æºå…è´¹) | â­â­â­â­ (å¼€æº) | â­â­â­â­â­ (å¼€æº) | â­â­ (æŒ‰ä½¿ç”¨ä»˜è´¹) | â­â­ (æŒ‰ä½¿ç”¨ä»˜è´¹) | â­â­ (æŒ‰ä½¿ç”¨ä»˜è´¹) |
| **éƒ¨ç½²** | â­â­â­â­ (è‡ªéƒ¨ç½²) | â­â­â­ (è‡ªéƒ¨ç½²) | â­â­â­â­â­ (åµŒå…¥å¼) | â­â­â­â­â­ (æ‰˜ç®¡) | â­â­â­â­â­ (æ‰˜ç®¡) | â­â­â­â­â­ (æ‰˜ç®¡) |
| **é€‚ç”¨åœºæ™¯** | æ··åˆè´Ÿè½½ã€å·²æœ‰PostgreSQL | OLAPã€å®æ—¶åˆ†æ | æ•°æ®åˆ†æã€BIå·¥å…· | ä¼ä¸šæ•°æ®ä»“åº“ | ä¼ä¸šæ•°æ®ä»“åº“ | AWSç”Ÿæ€æ•°æ®ä»“åº“ |
| **PostgreSQLé›†æˆ** | âœ… åŸç”Ÿé›†æˆ | âŒ éœ€å¤–éƒ¨é›†æˆ | âš ï¸ å¯é›†æˆ | âŒ ç‹¬ç«‹ç³»ç»Ÿ | âŒ ç‹¬ç«‹ç³»ç»Ÿ | âŒ ç‹¬ç«‹ç³»ç»Ÿ |

**æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š

- **å·²æœ‰PostgreSQLç³»ç»Ÿ**ï¼šä½¿ç”¨ `cstore_fdw` æ‰©å±•ï¼Œæ— éœ€è¿ç§»
- **çº¯OLAPåœºæ™¯**ï¼šè€ƒè™‘ ClickHouse æˆ– DuckDB
- **ä¼ä¸šæ•°æ®ä»“åº“**ï¼šè€ƒè™‘ Snowflake æˆ– BigQueryï¼ˆäº‘åŸç”Ÿï¼‰
- **æ··åˆè´Ÿè½½**ï¼šPostgreSQL + cstore_fdw æˆ–æ··åˆå­˜å‚¨æ¶æ„

**åˆ—å‹ç¼©å®è·µå»ºè®®**ï¼š

1. **ä½åŸºæ•°åˆ—**ï¼šä½¿ç”¨å­—å…¸ç¼–ç ï¼ˆaction, statusç­‰ï¼‰
2. **æœ‰åºæ•°å€¼åˆ—**ï¼šä½¿ç”¨å¢é‡ç¼–ç ï¼ˆtimestamp, sequenceç­‰ï¼‰
3. **é«˜åŸºæ•°åˆ—**ï¼šä½¿ç”¨é€šç”¨å‹ç¼©ï¼ˆzstdæˆ–lz4ï¼‰
4. **åˆ†ææŸ¥è¯¢**ï¼šåˆ—å­˜å‚¨+å‹ç¼©ï¼Œæ€§èƒ½æå‡10-100å€

## 8. æ€§èƒ½ç›‘æ§

### 8.1 I/Oæ€§èƒ½ç›‘æ§

```sql
-- æ•°æ®åº“I/Oç»Ÿè®¡
SELECT
    datname,
    blks_read,
    blks_hit,
    round(100.0 * blks_hit / (blks_hit + blks_read), 2) as hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname = current_database();

-- è¡¨I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as heap_hit_ratio,
    round(100.0 * idx_blks_hit / (idx_blks_hit + idx_blks_read), 2) as idx_hit_ratio
FROM pg_statio_user_tables
ORDER BY heap_blks_read + heap_blks_hit DESC;
```

### 8.2 å­˜å‚¨æ€§èƒ½åˆ†æ

```sql
-- å­˜å‚¨ä½¿ç”¨åˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size,
    round(100.0 * pg_indexes_size(schemaname||'.'||tablename) / pg_total_relation_size(schemaname||'.'||tablename), 2) as index_ratio
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## 9. å®é™…åº”ç”¨æ¡ˆä¾‹

### 9.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–

```sql
-- å¤§è¡¨åˆ†åŒºç­–ç•¥
CREATE TABLE log_entries (
    id BIGSERIAL,
    log_time TIMESTAMP,
    level VARCHAR(10),
    message TEXT,
    source VARCHAR(100)
) PARTITION BY RANGE (log_time);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE log_entries_2024_01 PARTITION OF log_entries
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE log_entries_2024_02 PARTITION OF log_entries
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';

    EXECUTE format('CREATE TABLE %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 9.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–

```sql
-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
BEGIN;
INSERT INTO large_table (col1, col2, col3)
SELECT
    generate_series(1, 1000000),
    'data' || generate_series(1, 1000000),
    random() * 1000;
COMMIT;

-- å¹¶è¡Œå†™å…¥ä¼˜åŒ–
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;
SET parallel_setup_cost = 1000;

-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM large_table WHERE col1 > 500000;
```

## 10. ç›¸å…³æ¦‚å¿µ

### 10.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„ç³»ç»Ÿç±»åˆ«
- **å­˜å‚¨ç³»ç»Ÿ**: æ•°æ®æŒä¹…åŒ–æœºåˆ¶
- **æ–‡ä»¶ç³»ç»Ÿ**: åº•å±‚å­˜å‚¨ç®¡ç†

### 10.2 ä¸‹ä½æ¦‚å¿µ

- **ç¼“å†²åŒºç®¡ç†**: å†…å­˜ç¼“å­˜æœºåˆ¶
- **WALæ—¥å¿—**: äº‹åŠ¡æ—¥å¿—ç³»ç»Ÿ
- **æ£€æŸ¥ç‚¹**: æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **é¡µé¢ç®¡ç†**: æ•°æ®é¡µé¢ç»„ç»‡
- **åˆ—å­˜å‚¨**: åˆ—å¼å­˜å‚¨æ¶æ„ï¼ˆcstore_fdwã€Citusåˆ—å­˜å‚¨ï¼‰ğŸ†•
- **åˆ—å‹ç¼©**: åˆ—å­˜å‚¨å‹ç¼©æŠ€æœ¯ï¼ˆå­—å…¸ç¼–ç ã€æ¸¸ç¨‹ç¼–ç ã€å¢é‡ç¼–ç ï¼‰ğŸ†•

### 10.3 å¹³è¡Œæ¦‚å¿µ

- **å†…å­˜æ•°æ®åº“**: åŸºäºå†…å­˜çš„å­˜å‚¨
- **åˆ†å¸ƒå¼å­˜å‚¨**: è·¨èŠ‚ç‚¹å­˜å‚¨ç®¡ç†
- **äº‘å­˜å‚¨**: äº‘ç«¯å­˜å‚¨æœåŠ¡
- **è¡Œå­˜å‚¨**: è¡Œå¼å­˜å‚¨æ¶æ„ï¼ˆPostgreSQLåŸç”Ÿï¼‰ğŸ†•
- **æ··åˆå­˜å‚¨**: è¡Œå­˜å‚¨+åˆ—å­˜å‚¨æ··åˆæ¶æ„ğŸ†•

## 11. å‚è€ƒæ–‡çŒ®

1. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
4. Silberschatz, A., Galvin, P. B., & Gagne, G. (2018). Operating System Concepts (10th ed.). John Wiley & Sons.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
6. Stonebraker, M., et al. (2005). C-Store: A Column-oriented DBMS. VLDB 2005. ğŸ†•
7. Abadi, D., et al. (2012). The Design and Implementation of Modern Column-Oriented Database Systems. VLDB 2012. ğŸ†•

## 12. Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/storage.html>
  - <https://www.postgresql.org/docs/current/wal.html>
