# å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½ï¼š`../../04-é«˜çº§ç‰¹æ€§/03.05-å‘é‡æ•°æ®åº“æ”¯æŒ.md`

---

## ğŸ“‹ ç›®å½•

- [å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#å‘é‡æ£€ç´¢ä¸æ··åˆæŸ¥è¯¢-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç›®æ ‡](#1-ç›®æ ‡)
  - [2. å‰ç½®](#2-å‰ç½®)
    - [2.1 pgvectorå®‰è£…](#21-pgvectorå®‰è£…)
    - [2.2 å¯ç”¨æ‰©å±•](#22-å¯ç”¨æ‰©å±•)
    - [2.3 å‡†å¤‡æ•°æ®è¡¨](#23-å‡†å¤‡æ•°æ®è¡¨)
  - [3. æ­¥éª¤](#3-æ­¥éª¤)
    - [3.1 ç´¢å¼•ç±»å‹é€‰æ‹©](#31-ç´¢å¼•ç±»å‹é€‰æ‹©)
    - [3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰](#32-åœ¨çº¿æŸ¥è¯¢ç»“æ„åŒ–--å‘é‡)
    - [3.3 å…¨æ–‡ + å‘é‡èåˆ](#33-å…¨æ–‡--å‘é‡èåˆ)
  - [4. è¿è¡Œå‚æ•°](#4-è¿è¡Œå‚æ•°)
    - [4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜](#41-æ€§èƒ½å‚æ•°è°ƒä¼˜)
    - [4.2 æ€§èƒ½ç›‘æ§](#42-æ€§èƒ½ç›‘æ§)
    - [4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•](#43-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [5. éªŒè¯](#5-éªŒè¯)
    - [5.1 å¬å›ç‡éªŒè¯](#51-å¬å›ç‡éªŒè¯)
    - [5.2 æ€§èƒ½åŸºçº¿è®°å½•](#52-æ€§èƒ½åŸºçº¿è®°å½•)
  - [6. æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)
    - [6.1 å¸¸è§é—®é¢˜](#61-å¸¸è§é—®é¢˜)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)

---

## 1. ç›®æ ‡

- å»ºç«‹"å‘é‡å¬å› + ç»“æ„åŒ–è¿‡æ»¤ + å…¨æ–‡æƒé‡"çš„æ··åˆæ£€ç´¢æµæ°´çº¿ï¼Œæ”¯æŒåœ¨çº¿æŸ¥è¯¢ä¸ç¦»çº¿é‡æ’ã€‚

## 2. å‰ç½®

- å®‰è£… `pgvector`ï¼›å‡†å¤‡ `docs(id, text, embedding vector(n))`ï¼›é€‰æ‹©ç´¢å¼•ï¼ˆHNSW/IVFFlat/PQï¼‰å¹¶ ANALYZEã€‚

### 2.1 pgvectorå®‰è£…

```bash
# æ–¹æ³•1: ä½¿ç”¨aptå®‰è£…ï¼ˆUbuntu/Debianï¼‰
sudo apt-get install postgresql-14-pgvector

# æ–¹æ³•2: ä»æºç ç¼–è¯‘
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# æ–¹æ³•3: ä½¿ç”¨Docker
docker pull pgvector/pgvector:pg14
```

### 2.2 å¯ç”¨æ‰©å±•

```sql
-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- éªŒè¯å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- æ£€æŸ¥ç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';
```

### 2.3 å‡†å¤‡æ•°æ®è¡¨

```sql
-- åˆ›å»ºæ–‡æ¡£è¡¨
CREATE TABLE docs (
    id SERIAL PRIMARY KEY,
    text TEXT NOT NULL,
    embedding vector(1536),  -- OpenAI ada-002ç»´åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    category VARCHAR(100),
    metadata JSONB
);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX docs_text_gin ON docs USING gin(to_tsvector('simple', text));

-- åˆ›å»ºç»“æ„åŒ–å­—æ®µç´¢å¼•
CREATE INDEX docs_created_at_idx ON docs(created_at);
CREATE INDEX docs_category_idx ON docs(category);
```

## 3. æ­¥éª¤

1) åˆ›å»ºç´¢å¼•ï¼š

    ```sql
    CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
    ```

### 3.1 ç´¢å¼•ç±»å‹é€‰æ‹©

**HNSWç´¢å¼•ï¼ˆæ¨èç”¨äºé«˜ç»´å‘é‡ï¼‰**:

```sql
-- HNSWç´¢å¼•åˆ›å»º
CREATE INDEX docs_hnsw ON docs
USING hnsw (embedding vector_l2_ops)
WITH (
    m = 32,              -- æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼ˆ16-64ï¼‰
    ef_construction = 200  -- æ„å»ºæ—¶çš„å€™é€‰æ•°ï¼ˆ100-1000ï¼‰
);

-- æŸ¥è¯¢æ—¶è®¾ç½®ef_searchï¼ˆå½±å“å¬å›ç‡å’Œæ€§èƒ½ï¼‰
SET ivfflat.probes = 100;  -- æ³¨æ„ï¼šHNSWä½¿ç”¨ef_searchå‚æ•°
```

**IVFFlatç´¢å¼•ï¼ˆæ¨èç”¨äºå¤§è§„æ¨¡æ•°æ®ï¼‰**:

```sql
-- IVFFlatç´¢å¼•åˆ›å»º
CREATE INDEX docs_ivfflat ON docs
USING ivfflat (embedding vector_l2_ops)
WITH (
    lists = 100  -- èšç±»ä¸­å¿ƒæ•°ï¼ˆå»ºè®®ï¼šrows/1000ï¼‰
);

-- æŸ¥è¯¢æ—¶è®¾ç½®probes
SET ivfflat.probes = 10;  -- æœç´¢çš„èšç±»æ•°ï¼ˆ1-listsï¼‰
```

**ç´¢å¼•é€‰æ‹©å»ºè®®**:

| åœºæ™¯ | æ¨èç´¢å¼• | åŸå›  |
|------|---------|------|
| é«˜ç»´å‘é‡(>100ç»´) | HNSW | æ›´å¥½çš„å¬å›ç‡ |
| å¤§è§„æ¨¡æ•°æ®(>100ä¸‡) | IVFFlat | æ›´å¿«çš„æ„å»ºé€Ÿåº¦ |
| å®æ—¶æŸ¥è¯¢ | HNSW | æ›´ä½çš„å»¶è¿Ÿ |
| æ‰¹é‡æŸ¥è¯¢ | IVFFlat | æ›´å¥½çš„ååé‡ |

### 3.2 åœ¨çº¿æŸ¥è¯¢ï¼ˆç»“æ„åŒ– + å‘é‡ï¼‰

```sql
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- æ–¹æ³•1: å…ˆè¿‡æ»¤åæ’åºï¼ˆæ¨èï¼‰
SELECT id, text, embedding <-> $1 AS distance
FROM docs
WHERE created_at >= now() - interval '7 day'
  AND category = 'technology'
ORDER BY embedding <-> $1
LIMIT 50;

-- æ–¹æ³•2: ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–
WITH filtered AS (
    SELECT id, text, embedding
    FROM docs
    WHERE created_at >= now() - interval '7 day'
      AND category = 'technology'
)
SELECT id, text, embedding <-> $1 AS distance
FROM filtered
ORDER BY embedding <-> $1
LIMIT 50;
```

### 3.3 å…¨æ–‡ + å‘é‡èåˆ

```sql
WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
    ORDER BY tr DESC LIMIT 500
), v AS (
    SELECT id, embedding <-> $1 AS dist
    FROM docs
    WHERE id IN (SELECT id FROM s)
    ORDER BY dist ASC LIMIT 100
)
SELECT d.id, d.text, 0.6*(1.0/v.dist) + 0.4*s.tr AS score
FROM v d JOIN s ON d.id = s.id
ORDER BY score DESC LIMIT 50;
```

**ä¼˜åŒ–ç‰ˆæœ¬**:

```sql
-- ä½¿ç”¨åŠ æƒèåˆ
WITH text_results AS (
    SELECT
        id,
        text,
        ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', $2)) AS text_score
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', $2)
    ORDER BY text_score DESC
    LIMIT 500
),
vector_results AS (
    SELECT
        id,
        embedding <-> $1 AS vector_distance
    FROM docs
    WHERE id IN (SELECT id FROM text_results)
    ORDER BY embedding <-> $1
    LIMIT 100
)
SELECT
    d.id,
    d.text,
    -- å½’ä¸€åŒ–åˆ†æ•°å¹¶åŠ æƒèåˆ
    0.6 * (1.0 / (1.0 + v.vector_distance)) + 0.4 * t.text_score AS combined_score
FROM vector_results v
JOIN text_results t ON v.id = t.id
JOIN docs d ON v.id = d.id
ORDER BY combined_score DESC
LIMIT 50;
```

## 4. è¿è¡Œå‚æ•°

- `SET ivfflat.probes = 10;` æŸ¥è¯¢é«˜å¬å›æ—¶è°ƒå¤§ï¼›
- æ§åˆ¶ `work_mem`ï¼Œé¿å…ANNä¸æ’åºå†…å­˜çˆ†ï¼›
- ç›‘æ§å»¶è¿ŸTP95/TP99 ä¸å¬å›æŒ‡æ ‡ã€‚

### 4.1 æ€§èƒ½å‚æ•°è°ƒä¼˜

```sql
-- 1. è°ƒæ•´work_memï¼ˆå‘é‡æŸ¥è¯¢éœ€è¦æ›´å¤šå†…å­˜ï¼‰
SET work_mem = '256MB';

-- 2. è°ƒæ•´IVFFlat probesï¼ˆå¬å›ç‡ vs æ€§èƒ½æƒè¡¡ï¼‰
SET ivfflat.probes = 10;   -- é»˜è®¤å€¼ï¼Œå¿«é€Ÿä½†å¬å›ç‡è¾ƒä½
SET ivfflat.probes = 50;   -- å¹³è¡¡æ¨¡å¼
SET ivfflat.probes = 100;  -- é«˜å¬å›ç‡ï¼Œä½†è¾ƒæ…¢

-- 3. è°ƒæ•´HNSW ef_searchï¼ˆä»…HNSWç´¢å¼•ï¼‰
-- æ³¨æ„ï¼špgvectorçš„HNSWå®ç°å¯èƒ½ä½¿ç”¨ä¸åŒå‚æ•°å
-- æŸ¥è¯¢æ—¶åœ¨ORDER BYå­å¥ä¸­æŒ‡å®šLIMITä¼šå½±å“æœç´¢èŒƒå›´

-- 4. å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
```

### 4.2 æ€§èƒ½ç›‘æ§

```sql
-- 1. æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> $1
LIMIT 50;

-- 2. ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'docs'
AND indexname LIKE '%vector%';

-- 3. è¡¨å¤§å°å’Œç´¢å¼•å¤§å°
SELECT
    pg_size_pretty(pg_relation_size('docs')) AS table_size,
    pg_size_pretty(pg_relation_size('docs_hnsw')) AS index_size;
```

### 4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- åˆ›å»ºæµ‹è¯•å‡½æ•°
CREATE OR REPLACE FUNCTION benchmark_vector_search(
    query_vector vector(1536),
    limit_count INTEGER DEFAULT 50
)
RETURNS TABLE (
    execution_time_ms NUMERIC,
    result_count BIGINT
) AS $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    result_count BIGINT;
BEGIN
    start_time := clock_timestamp();

    SELECT COUNT(*) INTO result_count
    FROM (
        SELECT id
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT limit_count
    ) sub;

    end_time := clock_timestamp();

    RETURN QUERY SELECT
        EXTRACT(EPOCH FROM (end_time - start_time)) * 1000 AS execution_time_ms,
        result_count;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒåŸºå‡†æµ‹è¯•
SELECT * FROM benchmark_vector_search(
    (SELECT embedding FROM docs LIMIT 1),
    50
);
```

## 5. éªŒè¯

- ä¸æš´åŠ›çœŸå€¼å¯¹æ¯” Recall@kï¼›æ€§èƒ½åŸºçº¿è®°å½•ä¸å›å½’æ£€æŸ¥ã€‚

### 5.1 å¬å›ç‡éªŒè¯

```sql
-- åˆ›å»ºå¬å›ç‡éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION verify_recall_at_k(
    query_vector vector(1536),
    k INTEGER DEFAULT 50,
    ground_truth_limit INTEGER DEFAULT 1000
)
RETURNS TABLE (
    recall_at_k NUMERIC,
    precision_at_k NUMERIC
) AS $$
DECLARE
    approximate_results INTEGER[];
    ground_truth_results INTEGER[];
    intersection_count INTEGER;
BEGIN
    -- è¿‘ä¼¼æœç´¢ç»“æœ
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO approximate_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT k
    ) sub;

    -- çœŸå®ç»“æœï¼ˆæš´åŠ›æœç´¢ï¼‰
    SELECT ARRAY_AGG(id ORDER BY embedding <-> query_vector)
    INTO ground_truth_results
    FROM (
        SELECT id, embedding
        FROM docs
        ORDER BY embedding <-> query_vector
        LIMIT ground_truth_limit
    ) sub;

    -- è®¡ç®—äº¤é›†
    SELECT COUNT(*) INTO intersection_count
    FROM unnest(approximate_results) AS a(id)
    WHERE id = ANY(ground_truth_results[1:k]);

    RETURN QUERY SELECT
        intersection_count::NUMERIC / k AS recall_at_k,
        intersection_count::NUMERIC / k AS precision_at_k;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡ŒéªŒè¯
SELECT * FROM verify_recall_at_k(
    (SELECT embedding FROM docs LIMIT 1),
    50,
    1000
);
```

### 5.2 æ€§èƒ½åŸºçº¿è®°å½•

```sql
-- åˆ›å»ºæ€§èƒ½åŸºçº¿è¡¨
CREATE TABLE IF NOT EXISTS vector_search_performance_baseline (
    test_id SERIAL PRIMARY KEY,
    test_time TIMESTAMP DEFAULT NOW(),
    query_type VARCHAR(50),  -- 'vector_only', 'hybrid', 'fulltext'
    index_type VARCHAR(50),   -- 'hnsw', 'ivfflat', 'none'
    k_value INTEGER,
    execution_time_ms NUMERIC,
    recall_at_k NUMERIC,
    result_count BIGINT,
    notes TEXT
);

-- è®°å½•æ€§èƒ½åŸºçº¿
INSERT INTO vector_search_performance_baseline (
    query_type,
    index_type,
    k_value,
    execution_time_ms,
    recall_at_k
)
VALUES (
    'vector_only',
    'hnsw',
    50,
    25.5,
    0.95
);
```

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: ç´¢å¼•æ„å»ºæ…¢**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ„å»ºè¿›åº¦
SELECT
    pid,
    datname,
    usename,
    application_name,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%';

-- è§£å†³æ–¹æ¡ˆï¼šåˆ†æ‰¹æ„å»ºæˆ–ä½¿ç”¨CONCURRENTLY
CREATE INDEX CONCURRENTLY docs_hnsw ON docs USING hnsw (embedding vector_l2_ops);
```

**é—®é¢˜2: æŸ¥è¯¢æ€§èƒ½å·®**:

```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, text
FROM docs
ORDER BY embedding <-> $1
LIMIT 50;

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. å¢åŠ ivfflat.probes
-- 2. æ£€æŸ¥work_memè®¾ç½®
-- 3. è€ƒè™‘é‡å»ºç´¢å¼•
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**:

```sql
-- æ£€æŸ¥å½“å‰work_mem
SHOW work_mem;

-- è§£å†³æ–¹æ¡ˆï¼šå¢åŠ work_memæˆ–å‡å°‘æŸ¥è¯¢èŒƒå›´
SET work_mem = '512MB';
```

## 7. æœ€ä½³å®è·µ

1. **ç´¢å¼•é€‰æ‹©**: é«˜ç»´å‘é‡ç”¨HNSWï¼Œå¤§è§„æ¨¡æ•°æ®ç”¨IVFFlat
2. **å‚æ•°è°ƒä¼˜**: æ ¹æ®å¬å›ç‡å’Œæ€§èƒ½éœ€æ±‚å¹³è¡¡probes/ef_search
3. **æ··åˆæŸ¥è¯¢**: å…ˆç»“æ„åŒ–è¿‡æ»¤ï¼Œå†å‘é‡æœç´¢ï¼Œæœ€åèåˆæ’åº
4. **ç›‘æ§æŒ‡æ ‡**: å®šæœŸæ£€æŸ¥æŸ¥è¯¢å»¶è¿Ÿã€å¬å›ç‡ã€ç´¢å¼•ä½¿ç”¨æƒ…å†µ
5. **å®šæœŸç»´æŠ¤**: å®šæœŸVACUUMå’ŒANALYZEï¼Œé‡å»ºç´¢å¼•ä»¥ä¼˜åŒ–æ€§èƒ½
