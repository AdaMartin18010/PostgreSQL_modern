# æ—¥å¿—ä¸å¯è§‚æµ‹æ€§-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-22
> **PostgreSQLç‰ˆæœ¬**: 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> å¯¹é½ï¼š`../../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.04-ç›‘æ§ä¸è¯Šæ–­.md`

---

## ğŸ“‹ ç›®å½•

- [æ—¥å¿—ä¸å¯è§‚æµ‹æ€§-è½åœ°æŒ‡å—ï¼ˆRunbookï¼‰](#æ—¥å¿—ä¸å¯è§‚æµ‹æ€§-è½åœ°æŒ‡å—runbook)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ—¥å¿—é…ç½®å»ºè®®](#1-æ—¥å¿—é…ç½®å»ºè®®)
    - [1.1 å®Œæ•´æ—¥å¿—é…ç½®](#11-å®Œæ•´æ—¥å¿—é…ç½®)
    - [1.2 æ—¥å¿—æ ¼å¼è¯´æ˜](#12-æ—¥å¿—æ ¼å¼è¯´æ˜)
  - [2. æ—¥å¿—é‡‡é›†](#2-æ—¥å¿—é‡‡é›†)
    - [2.1 Filebeaté…ç½®](#21-filebeaté…ç½®)
    - [2.2 Vectoré…ç½®](#22-vectoré…ç½®)
    - [2.3 æ…¢SQLå½’ä¸€åŒ–](#23-æ…¢sqlå½’ä¸€åŒ–)
  - [3. é¢æ¿ä¸å‘Šè­¦](#3-é¢æ¿ä¸å‘Šè­¦)
    - [3.1 Grafanaä»ªè¡¨æ¿è®¾è®¡](#31-grafanaä»ªè¡¨æ¿è®¾è®¡)
    - [3.2 å‘Šè­¦è§„åˆ™é…ç½®](#32-å‘Šè­¦è§„åˆ™é…ç½®)
  - [4. å…³è”è¿½è¸ª](#4-å…³è”è¿½è¸ª)
    - [4.1 åº”ç”¨è¿½è¸ªé…ç½®](#41-åº”ç”¨è¿½è¸ªé…ç½®)
    - [4.2 æ…¢SQLåˆ°æœåŠ¡æ˜ å°„](#42-æ…¢sqlåˆ°æœåŠ¡æ˜ å°„)
    - [4.3 åˆ†å¸ƒå¼è¿½è¸ªé›†æˆ](#43-åˆ†å¸ƒå¼è¿½è¸ªé›†æˆ)

---

## 1. æ—¥å¿—é…ç½®å»ºè®®

```text
log_line_prefix = '%m [%p] %u@%d %r %a '
log_min_duration_statement = 500ms
log_checkpoints = on
log_autovacuum_min_duration = 1s
log_lock_waits = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

### 1.1 å®Œæ•´æ—¥å¿—é…ç½®

```sql
-- postgresql.confå®Œæ•´æ—¥å¿—é…ç½®

-- åŸºæœ¬æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

-- æ—¥å¿—æ ¼å¼
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'Asia/Shanghai'

-- æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500  -- è®°å½•æ‰§è¡Œæ—¶é—´>500msçš„æŸ¥è¯¢
log_min_messages = warning  -- è®°å½•warningåŠä»¥ä¸Šçº§åˆ«

-- æ£€æŸ¥ç‚¹æ—¥å¿—
log_checkpoints = on

-- Autovacuumæ—¥å¿—
log_autovacuum_min_duration = 1s  -- è®°å½•æ‰§è¡Œæ—¶é—´>1sçš„autovacuum

-- é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on  -- è®°å½•é”ç­‰å¾…>deadlock_timeoutçš„äº‹ä»¶

-- I/Oæ—¶é—´è·Ÿè¸ª
track_io_timing = on

-- æ‰©å±•ç»Ÿè®¡
shared_preload_libraries = 'pg_stat_statements,auto_explain'

-- auto_explainé…ç½®
auto_explain.log_min_duration = 200  -- è®°å½•æ‰§è¡Œæ—¶é—´>200msçš„æŸ¥è¯¢è®¡åˆ’
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_verbose = on
auto_explain.log_format = json  -- JSONæ ¼å¼ä¾¿äºè§£æ
```

### 1.2 æ—¥å¿—æ ¼å¼è¯´æ˜

```text
log_line_prefixæ ¼å¼è¯´æ˜ï¼š
%t: æ—¶é—´æˆ³ï¼ˆå¸¦æ¯«ç§’ï¼‰
%p: è¿›ç¨‹ID
%l: æ—¥å¿—è¡Œå·
%u: ç”¨æˆ·å
%d: æ•°æ®åº“å
%a: åº”ç”¨åç§°
%h: å®¢æˆ·ç«¯åœ°å€
%r: å®¢æˆ·ç«¯åœ°å€å’Œç«¯å£
%m: æ—¶é—´æˆ³ï¼ˆä¸å¸¦æ¯«ç§’ï¼‰
%s: ä¼šè¯å¼€å§‹æ—¶é—´
%i: å‘½ä»¤æ ‡ç­¾
%e: SQLçŠ¶æ€ç 
```

## 2. æ—¥å¿—é‡‡é›†

- Filebeat/Vector â†’ Loki/Elasticï¼›å»ºç«‹ç´¢å¼•/ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼›
- æ…¢SQLå½’ä¸€åŒ–ï¼ˆfingerprintï¼‰ç”¨äºTopN èšåˆä¸ç”»åƒã€‚

### 2.1 Filebeaté…ç½®

```yaml
# filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/lib/postgresql/14/data/log/postgresql-*.log
    fields:
      service: postgresql
      environment: production
    fields_under_root: true
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after

processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_fields:
      target: ''
      fields:
        log_type: postgresql

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "postgresql-logs-%{+yyyy.MM.dd}"

# æˆ–è¾“å‡ºåˆ°Loki
output.loki:
  hosts: ["loki:3100"]
  labels:
    job: postgresql
    service: postgresql
```

### 2.2 Vectoré…ç½®

```toml
# vector.toml
[sources.postgresql_logs]
type = "file"
include = ["/var/lib/postgresql/14/data/log/postgresql-*.log"]
read_from = "beginning"

[transforms.postgresql_parse]
type = "regex_parser"
inputs = ["postgresql_logs"]
field = "message"
patterns = ['^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<pid>\d+)\]: \[(?P<log_level>\w+)\] (?P<message>.*)']

[transforms.postgresql_enrich]
type = "remap"
inputs = ["postgresql_parse"]
source = '''
.@timestamp = parse_timestamp(.timestamp, format: "%Y-%m-%d %H:%M:%S")
.service = "postgresql"
'''

[sinks.loki]
type = "loki"
inputs = ["postgresql_enrich"]
endpoint = "http://loki:3100"
labels.service = "{{ service }}"
labels.level = "{{ log_level }}"
```

### 2.3 æ…¢SQLå½’ä¸€åŒ–

```sql
-- ä½¿ç”¨pg_stat_statementsè¿›è¡Œæ…¢SQLå½’ä¸€åŒ–
SELECT
    LEFT(query, 200) as query_preview,
    calls,
    mean_exec_time,
    max_exec_time,
    total_exec_time,
    rows,
    -- å½’ä¸€åŒ–æŸ¥è¯¢ï¼ˆç§»é™¤å‚æ•°å€¼ï¼‰
    regexp_replace(
        regexp_replace(query, '\$\d+', '?', 'g'),
        '\d{4}-\d{2}-\d{2}', 'YYYY-MM-DD', 'g'
    ) as normalized_query
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY total_exec_time DESC
LIMIT 20;

-- åˆ›å»ºæ…¢SQLæŒ‡çº¹è¡¨
CREATE TABLE IF NOT EXISTS slow_query_fingerprints (
    fingerprint_id SERIAL PRIMARY KEY,
    normalized_query TEXT UNIQUE,
    first_seen TIMESTAMP DEFAULT NOW(),
    last_seen TIMESTAMP DEFAULT NOW(),
    total_calls BIGINT DEFAULT 0,
    total_time NUMERIC DEFAULT 0,
    avg_time NUMERIC DEFAULT 0,
    max_time NUMERIC DEFAULT 0
);

-- å®šæœŸæ›´æ–°æ…¢SQLæŒ‡çº¹
INSERT INTO slow_query_fingerprints (normalized_query, last_seen, total_calls, total_time, avg_time, max_time)
SELECT
    regexp_replace(
        regexp_replace(query, '\$\d+', '?', 'g'),
        '\d{4}-\d{2}-\d{2}', 'YYYY-MM-DD', 'g'
    ) as normalized_query,
    NOW() as last_seen,
    calls as total_calls,
    total_exec_time as total_time,
    mean_exec_time as avg_time,
    max_exec_time as max_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ON CONFLICT (normalized_query) DO UPDATE
SET
    last_seen = EXCLUDED.last_seen,
    total_calls = slow_query_fingerprints.total_calls + EXCLUDED.total_calls,
    total_time = slow_query_fingerprints.total_time + EXCLUDED.total_time,
    avg_time = (slow_query_fingerprints.total_time + EXCLUDED.total_time) /
               (slow_query_fingerprints.total_calls + EXCLUDED.total_calls),
    max_time = GREATEST(slow_query_fingerprints.max_time, EXCLUDED.max_time);
```

## 3. é¢æ¿ä¸å‘Šè­¦

- è¿æ¥/äº‹åŠ¡ã€å‘½ä¸­ç‡/WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€Autovacuumã€é”ç­‰å¾…ã€æ…¢SQLï¼›
- å‘Šè­¦ï¼šè¿æ¥>80%ã€å‘½ä¸­ç‡<95%ã€WAL æš´æ¶¨ã€æ£€æŸ¥ç‚¹é¢‘ç¹ã€Vacuum æ»åã€æ­»é”äº‹ä»¶ã€‚

### 3.1 Grafanaä»ªè¡¨æ¿è®¾è®¡

**é¢æ¿1: æ¦‚è§ˆ**:

```json
{
  "panels": [
    {
      "title": "è¿æ¥æ•°",
      "targets": [
        {
          "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
        }
      ]
    },
    {
      "title": "äº‹åŠ¡é€Ÿç‡",
      "targets": [
        {
          "expr": "rate(pg_stat_database_xact_commit{datname=\"postgres\"}[5m])"
        }
      ]
    },
    {
      "title": "ç¼“å†²åŒºå‘½ä¸­ç‡",
      "targets": [
        {
          "expr": "100 * (pg_stat_database_blks_hit{datname=\"postgres\"} / (pg_stat_database_blks_hit{datname=\"postgres\"} + pg_stat_database_blks_read{datname=\"postgres\"}))"
        }
      ]
    }
  ]
}
```

**é¢æ¿2: æŸ¥è¯¢æ€§èƒ½**:

```json
{
  "panels": [
    {
      "title": "Top 10 æ…¢æŸ¥è¯¢",
      "targets": [
        {
          "expr": "topk(10, pg_stat_statements_mean_exec_time)"
        }
      ]
    },
    {
      "title": "æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(pg_stat_statements_calls[5m]))"
        }
      ]
    }
  ]
}
```

### 3.2 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# prometheus_alerts.yml
groups:
  - name: postgresql_logs
    rules:
      - alert: PostgreSQLSlowQueries
        expr: |
          count(
            pg_stat_statements_mean_exec_time > 1000
          ) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢è¿‡å¤š"
          description: "æ‰§è¡Œæ—¶é—´>1ç§’çš„æŸ¥è¯¢æ•°é‡: {{ $value }}"

      - alert: PostgreSQLDeadlocks
        expr: |
          increase(
            pg_stat_database_deadlocks{datname="postgres"}[5m]
          ) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLæ£€æµ‹åˆ°æ­»é”"
          description: "æ•°æ®åº“å‘ç”Ÿæ­»é”äº‹ä»¶"

      - alert: PostgreSQLLockWaits
        expr: |
          count(
            pg_stat_activity_wait_event_type{wait_event_type="Lock"}
          ) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLé”ç­‰å¾…è¿‡å¤š"
          description: "é”ç­‰å¾…æ•°é‡: {{ $value }}"
```

## 4. å…³è”è¿½è¸ª

- é€šè¿‡ `log_line_prefix` æ³¨å…¥ `application_name`/è¯·æ±‚IDï¼Œæ‰“é€šåº”ç”¨è¿½è¸ªï¼›
- å°† TopN è¯­å¥æ˜ å°„å›æœåŠ¡/æ¥å£ï¼Œå½¢æˆä¼˜åŒ–é—­ç¯ã€‚

### 4.1 åº”ç”¨è¿½è¸ªé…ç½®

```sql
-- 1. åœ¨åº”ç”¨è¿æ¥å­—ç¬¦ä¸²ä¸­è®¾ç½®application_name
-- ç¤ºä¾‹ï¼špostgresql://user:pass@host/db?application_name=order-service-v1.2.3

-- 2. åœ¨log_line_prefixä¸­åŒ…å«application_name
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h,request_id=%i '

-- 3. ä½¿ç”¨sessionå˜é‡ä¼ é€’è¯·æ±‚ID
SET application_name = 'order-service';
SET log_statement = 'all';  -- ä¸´æ—¶å¯ç”¨ï¼Œç”¨äºè°ƒè¯•

-- 4. æŸ¥è¯¢æ—¶åŒ…å«è¯·æ±‚ID
SELECT set_config('application_name', 'order-service-request-12345', false);
SELECT * FROM orders WHERE order_id = 100;
```

### 4.2 æ…¢SQLåˆ°æœåŠ¡æ˜ å°„

```sql
-- åˆ›å»ºæœåŠ¡-æŸ¥è¯¢æ˜ å°„è¡¨
CREATE TABLE IF NOT EXISTS service_query_mapping (
    mapping_id SERIAL PRIMARY KEY,
    service_name VARCHAR(100),
    normalized_query TEXT,
    endpoint VARCHAR(200),
    first_seen TIMESTAMP DEFAULT NOW(),
    last_seen TIMESTAMP DEFAULT NOW()
);

-- ä»æ—¥å¿—ä¸­æå–æœåŠ¡-æŸ¥è¯¢æ˜ å°„
-- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£ææ—¥å¿—
-- ç¤ºä¾‹æ—¥å¿—æ ¼å¼ï¼š
-- 2024-11-22 10:00:00 [12345]: [1-1] user=app_user,db=postgres,app=order-service,client=10.0.0.1 SELECT * FROM orders WHERE order_id = 100;

-- å®šæœŸæ›´æ–°æ˜ å°„
INSERT INTO service_query_mapping (service_name, normalized_query, endpoint)
SELECT DISTINCT
    application_name as service_name,
    regexp_replace(
        regexp_replace(query, '\$\d+', '?', 'g'),
        '\d{4}-\d{2}-\d{2}', 'YYYY-MM-DD', 'g'
    ) as normalized_query,
    '/api/orders' as endpoint  -- ä»åº”ç”¨æ—¥å¿—ä¸­æå–
FROM pg_stat_statements
WHERE application_name IS NOT NULL
ON CONFLICT DO NOTHING;

-- æŸ¥è¯¢æœåŠ¡çº§åˆ«çš„æ…¢SQL
SELECT
    s.service_name,
    s.endpoint,
    q.normalized_query,
    q.mean_exec_time,
    q.calls
FROM service_query_mapping s
JOIN (
    SELECT
        regexp_replace(
            regexp_replace(query, '\$\d+', '?', 'g'),
            '\d{4}-\d{2}-\d{2}', 'YYYY-MM-DD', 'g'
        ) as normalized_query,
        mean_exec_time,
        calls
    FROM pg_stat_statements
    WHERE mean_exec_time > 100
) q ON s.normalized_query = q.normalized_query
ORDER BY q.mean_exec_time DESC;
```

### 4.3 åˆ†å¸ƒå¼è¿½è¸ªé›†æˆ

```sql
-- ä½¿ç”¨OpenTelemetryé›†æˆ
-- 1. å®‰è£…pg_telemetryæ‰©å±•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
-- CREATE EXTENSION pg_telemetry;

-- 2. åœ¨log_line_prefixä¸­åŒ…å«trace_id
log_line_prefix = '%t [%p]: trace_id=%i span_id=%i '

-- 3. ä»åº”ç”¨ä¼ é€’trace_id
SET trace_id = 'abc123def456';
SET span_id = 'span789';

-- 4. æŸ¥è¯¢è¿½è¸ªä¿¡æ¯
SELECT
    application_name,
    query,
    query_start,
    state,
    wait_event_type,
    wait_event
FROM pg_stat_activity
WHERE application_name LIKE '%order-service%'
ORDER BY query_start DESC;
```
