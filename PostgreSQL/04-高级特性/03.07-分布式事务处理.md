# PostgreSQL åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º
> **å¯¹æ ‡æ ‡å‡†**: MIT/Stanfordåˆ†å¸ƒå¼æ•°æ®åº“è¯¾ç¨‹

---

## ğŸ“‹ ç›®å½•

- [PostgreSQL åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](#postgresql-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#-å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”çŸ©é˜µ](#åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”çŸ©é˜µ)
    - [ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å®ç°å¯¹æ¯”](#acidç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å®ç°å¯¹æ¯”)
    - [åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æ–¹æ¡ˆå¯¹æ¯”](#åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æ–¹æ¡ˆå¯¹æ¯”)
  - [ğŸŒ Wikipediaå¯¹é½](#-wikipediaå¯¹é½)
    - [åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½](#åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½)
    - [ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½](#ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½)
    - [ACIDç‰¹æ€§å¯¹é½](#acidç‰¹æ€§å¯¹é½)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€](#2-åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€)
    - [2.1 ACIDåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜](#21-acidåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜)
    - [2.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰](#22-ä¸¤é˜¶æ®µæäº¤2pc)
    - [2.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰](#23-ä¸‰é˜¶æ®µæäº¤3pc)
    - [2.4 SAGAæ¨¡å¼](#24-sagaæ¨¡å¼)
  - [3. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å®ç°](#3-postgresqlåˆ†å¸ƒå¼äº‹åŠ¡å®ç°)
    - [3.1 ä¸¤é˜¶æ®µæäº¤å®ç°](#31-ä¸¤é˜¶æ®µæäº¤å®ç°)
    - [3.2 åˆ†å¸ƒå¼é”ç®¡ç†](#32-åˆ†å¸ƒå¼é”ç®¡ç†)
    - [3.3 äº‹åŠ¡åè°ƒå™¨](#33-äº‹åŠ¡åè°ƒå™¨)
  - [4. Citusåˆ†å¸ƒå¼äº‹åŠ¡](#4-citusåˆ†å¸ƒå¼äº‹åŠ¡)
    - [4.1 Citusäº‹åŠ¡æ¨¡å‹](#41-citusäº‹åŠ¡æ¨¡å‹)
    - [4.2 è·¨åˆ†ç‰‡äº‹åŠ¡](#42-è·¨åˆ†ç‰‡äº‹åŠ¡)
    - [4.3 äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯](#43-äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯)
  - [5. åˆ†å¸ƒå¼äº‹åŠ¡ä¼˜åŒ–](#5-åˆ†å¸ƒå¼äº‹åŠ¡ä¼˜åŒ–)
    - [5.1 æ€§èƒ½ä¼˜åŒ–](#51-æ€§èƒ½ä¼˜åŒ–)
    - [5.2 PostgreSQL 18ä¼˜åŒ–](#52-postgresql-18ä¼˜åŒ–)
  - [6. æ•…éšœå¤„ç†ä¸æ¢å¤](#6-æ•…éšœå¤„ç†ä¸æ¢å¤)
    - [6.1 æ•…éšœåœºæ™¯](#61-æ•…éšœåœºæ™¯)
    - [6.2 æ¢å¤ç­–ç•¥](#62-æ¢å¤ç­–ç•¥)
  - [7. å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
    - [7.1 ç”µå•†è®¢å•å¤„ç†](#71-ç”µå•†è®¢å•å¤„ç†)
    - [7.2 å¤šç§Ÿæˆ·æ•°æ®è¿ç§»](#72-å¤šç§Ÿæˆ·æ•°æ®è¿ç§»)
  - [8. ç›¸å…³æ–‡æ¡£](#8-ç›¸å…³æ–‡æ¡£)
    - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
    - [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
    - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
    - [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
    - [è¡Œä¸šæ¡ˆä¾‹](#è¡Œä¸šæ¡ˆä¾‹)
    - [8.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#81-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
  - [9. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯](#9-å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯)
    - [9.1 ä¸¤é˜¶æ®µæäº¤åŸå­æ€§è¯æ˜](#91-ä¸¤é˜¶æ®µæäº¤åŸå­æ€§è¯æ˜)
    - [9.2 ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„ä¿è¯](#92-acidç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„ä¿è¯)
    - [9.3 SAGAæ¨¡å¼æœ€ç»ˆä¸€è‡´æ€§è¯æ˜](#93-sagaæ¨¡å¼æœ€ç»ˆä¸€è‡´æ€§è¯æ˜)
  - [10. Wikipediaå¯¹é½](#10-wikipediaå¯¹é½)
    - [10.1 åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½](#101-åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½)
    - [10.2 ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½](#102-ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½)
    - [10.3 ACIDç‰¹æ€§å¯¹é½](#103-acidç‰¹æ€§å¯¹é½)
  - [11. å‚è€ƒæ–‡çŒ®](#11-å‚è€ƒæ–‡çŒ®)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†))
    ç†è®ºåŸºç¡€
      ACIDç‰¹æ€§
        åŸå­æ€§
        ä¸€è‡´æ€§
        éš”ç¦»æ€§
        æŒä¹…æ€§
      åˆ†å¸ƒå¼æŒ‘æˆ˜
        ç½‘ç»œåˆ†åŒº
        èŠ‚ç‚¹æ•…éšœ
        æ—¶é’ŸåŒæ­¥
        äº‹åŠ¡åè°ƒ
    åè®®æœºåˆ¶
      ä¸¤é˜¶æ®µæäº¤
        å‡†å¤‡é˜¶æ®µ
        æäº¤é˜¶æ®µ
        æ•…éšœå¤„ç†
      ä¸‰é˜¶æ®µæäº¤
        é¢„æäº¤é˜¶æ®µ
        æ”¹è¿›2PC
      SAGAæ¨¡å¼
        è¡¥å¿äº‹åŠ¡
        æœ€ç»ˆä¸€è‡´æ€§
        é•¿äº‹åŠ¡å¤„ç†
    PostgreSQLå®ç°
      2PCå®ç°
        PREPARE TRANSACTION
        COMMIT PREPARED
        ROLLBACK PREPARED
      åˆ†å¸ƒå¼é”
        å…¨å±€é”ç®¡ç†
        æ­»é”æ£€æµ‹
        é”è¶…æ—¶
      äº‹åŠ¡åè°ƒå™¨
        åè°ƒèŠ‚ç‚¹
        å‚ä¸è€…ç®¡ç†
    Citusé›†æˆ
      è·¨åˆ†ç‰‡äº‹åŠ¡
        åˆ†å¸ƒå¼æŸ¥è¯¢
        ä¸€è‡´æ€§ä¿è¯
      äº‹åŠ¡æ¨¡å‹
        å•åˆ†ç‰‡äº‹åŠ¡
        å¤šåˆ†ç‰‡äº‹åŠ¡
      æ€§èƒ½ä¼˜åŒ–
        æœ¬åœ°äº‹åŠ¡ä¼˜å…ˆ
        æ‰¹é‡æäº¤
    æ•…éšœå¤„ç†
      æ•…éšœåœºæ™¯
        èŠ‚ç‚¹æ•…éšœ
        ç½‘ç»œåˆ†åŒº
        è¶…æ—¶å¤„ç†
      æ¢å¤ç­–ç•¥
        è‡ªåŠ¨æ¢å¤
        æ‰‹åŠ¨æ¢å¤
        æ•°æ®ä¸€è‡´æ€§
    åº”ç”¨åœºæ™¯
      ç”µå•†è®¢å•
        è®¢å•å¤„ç†
        åº“å­˜ç®¡ç†
        æ”¯ä»˜å¤„ç†
      æ•°æ®è¿ç§»
        å¤šç§Ÿæˆ·è¿ç§»
        æ•°æ®åŒæ­¥
        ä¸€è‡´æ€§ä¿è¯
```

---

## ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### åˆ†å¸ƒå¼äº‹åŠ¡åè®®å¯¹æ¯”çŸ©é˜µ

| åè®® | ä¸€è‡´æ€§ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | æ•…éšœæ¢å¤ | é€‚ç”¨åœºæ™¯ |
|-----|--------|--------|------|--------|---------|---------|
| **ä¸¤é˜¶æ®µæäº¤(2PC)** | å¼ºä¸€è‡´æ€§ | ä½ï¼ˆé˜»å¡ï¼‰ | ä¸­ç­‰ | ä¸­ç­‰ | å›°éš¾ | å¼ºä¸€è‡´æ€§è¦æ±‚ |
| **ä¸‰é˜¶æ®µæäº¤(3PC)** | å¼ºä¸€è‡´æ€§ | ä¸­ï¼ˆéé˜»å¡ï¼‰ | ä¸­ç­‰ | é«˜ | ä¸­ç­‰ | æ”¹è¿›2PC |
| **SAGAæ¨¡å¼** | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ï¼ˆéé˜»å¡ï¼‰ | é«˜ | é«˜ | å®¹æ˜“ | é•¿äº‹åŠ¡ã€å¾®æœåŠ¡ |
| **TCCæ¨¡å¼** | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | é«˜ | é«˜ | å®¹æ˜“ | è¡¥å¿äº‹åŠ¡ |
| **Seata ATæ¨¡å¼** | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | é«˜ | ä½ | å®¹æ˜“ | è‡ªåŠ¨è¡¥å¿ |

### ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å®ç°å¯¹æ¯”

| ACIDç‰¹æ€§ | å•æœºç¯å¢ƒ | åˆ†å¸ƒå¼ç¯å¢ƒ | å®ç°æŒ‘æˆ˜ | PostgreSQLè§£å†³æ–¹æ¡ˆ |
|---------|---------|-----------|---------|-------------------|
| **åŸå­æ€§(Atomicity)** | æœ¬åœ°äº‹åŠ¡ | åˆ†å¸ƒå¼äº‹åŠ¡ | åè°ƒå¤šä¸ªèŠ‚ç‚¹ | 2PCã€PREPARE TRANSACTION |
| **ä¸€è‡´æ€§(Consistency)** | æœ¬åœ°çº¦æŸ | å…¨å±€çº¦æŸ | è·¨èŠ‚ç‚¹ä¸€è‡´æ€§ | åˆ†å¸ƒå¼é”ã€å…¨å±€çº¦æŸ |
| **éš”ç¦»æ€§(Isolation)** | æœ¬åœ°é” | åˆ†å¸ƒå¼é” | æ­»é”æ£€æµ‹ | åˆ†å¸ƒå¼æ­»é”æ£€æµ‹ |
| **æŒä¹…æ€§(Durability)** | æœ¬åœ°WAL | åˆ†å¸ƒå¼WAL | æ•…éšœæ¢å¤ | åˆ†å¸ƒå¼WALã€å¤åˆ¶ |

### åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | äº‹åŠ¡ç±»å‹ | ä¸€è‡´æ€§çº§åˆ« | æ€§èƒ½ | å¤æ‚åº¦ | PostgreSQLæ”¯æŒ |
|-----|---------|-----------|------|--------|---------------|
| **æœ¬åœ°äº‹åŠ¡** | å•èŠ‚ç‚¹ | å¼ºä¸€è‡´æ€§ | é«˜ | ä½ | âœ… åŸç”Ÿæ”¯æŒ |
| **2PC** | å¤šèŠ‚ç‚¹ | å¼ºä¸€è‡´æ€§ | ä¸­ | ä¸­ | âœ… åŸç”Ÿæ”¯æŒ |
| **Citusåˆ†å¸ƒå¼äº‹åŠ¡** | è·¨åˆ†ç‰‡ | å¼ºä¸€è‡´æ€§ | ä¸­ | é«˜ | âœ… Citusæ‰©å±• |
| **SAGAè¡¥å¿** | é•¿äº‹åŠ¡ | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | é«˜ | âœ… åº”ç”¨å±‚å®ç° |
| **æœ€ç»ˆä¸€è‡´æ€§** | å¼‚æ­¥å¤åˆ¶ | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | ä¸­ | âœ… é€»è¾‘å¤åˆ¶ |

---

## ğŸŒ Wikipediaå¯¹é½

### åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Distributed transaction](https://en.wikipedia.org/wiki/Distributed_transaction)

> A distributed transaction is a database transaction in which two or more network hosts are involved. Usually, hosts provide transactional resources, while a transaction manager is responsible for creating and managing a global transaction that encompasses all operations against such resources.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒæ¶‰åŠå¤šä¸ªç½‘ç»œä¸»æœºçš„äº‹åŠ¡
- âœ… **æ ¸å¿ƒç»„ä»¶**: éƒ½æåˆ°äº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨
- âœ… **ACIDç‰¹æ€§**: éƒ½å¼ºè°ƒåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯ACIDç‰¹æ€§

### ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½

**Wikipediaå®šä¹‰**: [Two-phase commit protocol](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)

> In transaction processing, databases, and computer networking, the two-phase commit protocol (2PC) is a type of atomic commitment protocol. It is a distributed algorithm that coordinates all the processes that participate in a distributed atomic transaction on whether to commit or abort (roll back) the transaction.

**å¯¹é½è¯´æ˜**:

- âœ… **åè®®å®šä¹‰**: PostgreSQLçš„2PCå®ç°ç¬¦åˆWikipediaçš„2PCåè®®å®šä¹‰
- âœ… **ä¸¤é˜¶æ®µ**: éƒ½åŒ…å«å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µ
- âœ… **åŸå­æ€§**: éƒ½å¼ºè°ƒåŸå­æ€§ä¿è¯

### ACIDç‰¹æ€§å¯¹é½

**Wikipediaå®šä¹‰**: [ACID](https://en.wikipedia.org/wiki/ACID)

> In computer science, ACID (Atomicity, Consistency, Isolation, Durability) is a set of properties of database transactions intended to guarantee data validity despite errors, power failures, and other mishaps.

**å¯¹é½è¯´æ˜**:

- âœ… **ç‰¹æ€§å®šä¹‰**: PostgreSQLçš„ACIDå®ç°ç¬¦åˆWikipediaçš„ACIDå®šä¹‰
- âœ… **å››ä¸ªç‰¹æ€§**: éƒ½åŒ…å«åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
- âœ… **ä¿è¯æœºåˆ¶**: éƒ½å¼ºè°ƒé€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®æœ‰æ•ˆæ€§

---

## 1. æ¦‚è¿°

åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€ã€‚
PostgreSQLé€šè¿‡å¤šç§æœºåˆ¶æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒåŒ…æ‹¬ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ã€SAGAæ¨¡å¼ç­‰ï¼Œç¡®ä¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ACIDç‰¹æ€§ã€‚

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š

- ç½‘ç»œåˆ†åŒº
- èŠ‚ç‚¹æ•…éšœ
- æ—¶é’ŸåŒæ­¥
- äº‹åŠ¡åè°ƒ

**PostgreSQLè§£å†³æ–¹æ¡ˆ**ï¼š

- ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰
- åˆ†å¸ƒå¼é”ç®¡ç†
- äº‹åŠ¡åè°ƒå™¨
- SAGAè¡¥å¿äº‹åŠ¡

---

## 2. åˆ†å¸ƒå¼äº‹åŠ¡ç†è®ºåŸºç¡€

### 2.1 ACIDåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æŒ‘æˆ˜

**ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å®ç°**ï¼š

| ç‰¹æ€§ | å•æœºç¯å¢ƒ | åˆ†å¸ƒå¼ç¯å¢ƒ | æŒ‘æˆ˜ |
|-----|---------|-----------|------|
| **åŸå­æ€§** | æœ¬åœ°äº‹åŠ¡ | åˆ†å¸ƒå¼äº‹åŠ¡ | åè°ƒå¤šä¸ªèŠ‚ç‚¹ |
| **ä¸€è‡´æ€§** | æœ¬åœ°çº¦æŸ | å…¨å±€çº¦æŸ | è·¨èŠ‚ç‚¹ä¸€è‡´æ€§ |
| **éš”ç¦»æ€§** | æœ¬åœ°é” | åˆ†å¸ƒå¼é” | æ­»é”æ£€æµ‹ |
| **æŒä¹…æ€§** | æœ¬åœ°WAL | åˆ†å¸ƒå¼WAL | æ•…éšœæ¢å¤ |

### 2.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

**2PCåè®®**ï¼š

**é˜¶æ®µ1ï¼šå‡†å¤‡ï¼ˆPrepareï¼‰**:

```sql
-- åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€PREPARE
BEGIN;
UPDATE distributed_table SET value = 'new' WHERE id = 1;
PREPARE TRANSACTION 'txn-001';
```

**é˜¶æ®µ2ï¼šæäº¤ï¼ˆCommitï¼‰**:

```sql
-- åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ACKåï¼Œå‘é€COMMIT
COMMIT PREPARED 'txn-001';
```

**2PCé—®é¢˜**ï¼š

- é˜»å¡é—®é¢˜ï¼šåè°ƒè€…æ•…éšœå¯¼è‡´é˜»å¡
- æ€§èƒ½å¼€é”€ï¼šä¸¤è½®ç½‘ç»œé€šä¿¡
- å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœå½±å“å…¨å±€

### 2.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰

**3PCæ”¹è¿›**ï¼š

- å¢åŠ è¶…æ—¶æœºåˆ¶
- å‡å°‘é˜»å¡æ—¶é—´
- æé«˜å¯ç”¨æ€§

### 2.4 SAGAæ¨¡å¼

**SAGAæ¨¡å¼**ï¼š

- é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
- æ¯ä¸ªçŸ­äº‹åŠ¡æœ‰è¡¥å¿æ“ä½œ
- å¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿

**SAGAç¤ºä¾‹**ï¼š

```sql
-- è®¢å•å¤„ç†SAGA
BEGIN;
-- æ­¥éª¤1: åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, total) VALUES (1, 100.00);

-- æ­¥éª¤2: æ‰£å‡åº“å­˜
UPDATE inventory SET quantity = quantity - 1 WHERE product_id = 1;

-- æ­¥éª¤3: æ‰£å‡ä½™é¢
UPDATE accounts SET balance = balance - 100.00 WHERE user_id = 1;

-- å¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
-- è¡¥å¿1: åˆ é™¤è®¢å•
-- è¡¥å¿2: æ¢å¤åº“å­˜
-- è¡¥å¿3: æ¢å¤ä½™é¢
COMMIT;
```

---

## 3. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡å®ç°

### 3.1 ä¸¤é˜¶æ®µæäº¤å®ç°

**PostgreSQL 2PCæ”¯æŒ**ï¼š

```sql
-- å‡†å¤‡é˜¶æ®µ
BEGIN;
UPDATE table1 SET value = 'new1' WHERE id = 1;
UPDATE table2 SET value = 'new2' WHERE id = 2;
PREPARE TRANSACTION 'distributed-txn-001';

-- æäº¤é˜¶æ®µï¼ˆåœ¨å¦ä¸€ä¸ªä¼šè¯ï¼‰
COMMIT PREPARED 'distributed-txn-001';

-- å›æ»šé˜¶æ®µ
ROLLBACK PREPARED 'distributed-txn-001';
```

**æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡**ï¼š

```sql
SELECT * FROM pg_prepared_xacts;
```

### 3.2 åˆ†å¸ƒå¼é”ç®¡ç†

**åˆ†å¸ƒå¼é”**ï¼š

```sql
-- è·å–åˆ†å¸ƒå¼é”
SELECT pg_advisory_lock(123456);

-- å°è¯•è·å–é”ï¼ˆéé˜»å¡ï¼‰
SELECT pg_try_advisory_lock(123456);

-- é‡Šæ”¾é”
SELECT pg_advisory_unlock(123456);
```

### 3.3 äº‹åŠ¡åè°ƒå™¨

**å¤–éƒ¨äº‹åŠ¡åè°ƒå™¨**ï¼š

- **PostgreSQL FDW**: é€šè¿‡å¤–éƒ¨æ•°æ®åŒ…è£…å™¨åè°ƒ
- **åº”ç”¨å±‚åè°ƒ**: åº”ç”¨ä»£ç å®ç°2PC
- **ä¸­é—´ä»¶åè°ƒ**: ä½¿ç”¨äº‹åŠ¡ä¸­é—´ä»¶

---

## 4. Citusåˆ†å¸ƒå¼äº‹åŠ¡

### 4.1 Citusäº‹åŠ¡æ¨¡å‹

**Citusäº‹åŠ¡ç‰¹æ€§**ï¼š

- å•åˆ†ç‰‡äº‹åŠ¡ï¼šæœ¬åœ°äº‹åŠ¡ï¼Œé«˜æ€§èƒ½
- å¤šåˆ†ç‰‡äº‹åŠ¡ï¼š2PCï¼Œä¿è¯ä¸€è‡´æ€§
- å‚è€ƒè¡¨äº‹åŠ¡ï¼šæœ¬åœ°äº‹åŠ¡

### 4.2 è·¨åˆ†ç‰‡äº‹åŠ¡

**è·¨åˆ†ç‰‡äº‹åŠ¡ç¤ºä¾‹**ï¼š

```sql
BEGIN;

-- è·¨åˆ†ç‰‡æ›´æ–°
UPDATE users SET status = 'active' WHERE id = 123;
UPDATE orders SET status = 'paid' WHERE user_id = 123;

-- Citusè‡ªåŠ¨ä½¿ç”¨2PC
COMMIT;
```

### 4.3 äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯

**ä¸€è‡´æ€§çº§åˆ«**ï¼š

- **å¼ºä¸€è‡´æ€§**: ä½¿ç”¨2PCï¼ˆé»˜è®¤ï¼‰
- **æœ€ç»ˆä¸€è‡´æ€§**: å¼‚æ­¥å¤åˆ¶

---

## 5. åˆ†å¸ƒå¼äº‹åŠ¡ä¼˜åŒ–

### 5.1 æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

- å‡å°‘è·¨åˆ†ç‰‡äº‹åŠ¡
- ä½¿ç”¨æœ¬åœ°äº‹åŠ¡
- æ‰¹é‡æ“ä½œ
- å¼‚æ­¥æäº¤

### 5.2 PostgreSQL 18ä¼˜åŒ–

**æ–°ç‰¹æ€§åº”ç”¨**ï¼š

- **å¼‚æ­¥I/O**: æå‡åˆ†å¸ƒå¼äº‹åŠ¡I/Oæ€§èƒ½
- **å¹¶è¡ŒæŸ¥è¯¢**: ä¼˜åŒ–åˆ†å¸ƒå¼æŸ¥è¯¢
- **ç›‘æ§å¢å¼º**: æ›´å¥½çš„äº‹åŠ¡ç›‘æ§

---

## 6. æ•…éšœå¤„ç†ä¸æ¢å¤

### 6.1 æ•…éšœåœºæ™¯

**å¸¸è§æ•…éšœ**ï¼š

- åè°ƒè€…æ•…éšœ
- å‚ä¸è€…æ•…éšœ
- ç½‘ç»œåˆ†åŒº
- è¶…æ—¶

### 6.2 æ¢å¤ç­–ç•¥

**æ¢å¤æ–¹æ³•**ï¼š

```sql
-- æŸ¥çœ‹å‡†å¤‡çš„äº‹åŠ¡
SELECT * FROM pg_prepared_xacts;

-- æ‰‹åŠ¨æäº¤æˆ–å›æ»š
COMMIT PREPARED 'txn-001';
-- æˆ–
ROLLBACK PREPARED 'txn-001';
```

---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 ç”µå•†è®¢å•å¤„ç†

**åœºæ™¯**: åˆ›å»ºè®¢å•ã€æ‰£å‡åº“å­˜ã€æ‰£å‡ä½™é¢

**å®ç°**ï¼š

```sql
BEGIN;

-- åˆ›å»ºè®¢å•
INSERT INTO orders (user_id, product_id, quantity, total)
VALUES (1, 100, 1, 99.00);

-- æ‰£å‡åº“å­˜
UPDATE inventory SET quantity = quantity - 1
WHERE product_id = 100;

-- æ‰£å‡ä½™é¢
UPDATE accounts SET balance = balance - 99.00
WHERE user_id = 1;

COMMIT;
```

### 7.2 å¤šç§Ÿæˆ·æ•°æ®è¿ç§»

**åœºæ™¯**: è·¨åˆ†ç‰‡æ•°æ®è¿ç§»

**å®ç°**ï¼š

```sql
BEGIN;

-- ä»æºåˆ†ç‰‡åˆ é™¤
DELETE FROM tenant_data WHERE tenant_id = 1 AND id = 100;

-- æ’å…¥åˆ°ç›®æ ‡åˆ†ç‰‡
INSERT INTO tenant_data (tenant_id, id, data)
VALUES (2, 100, '{"migrated": true}');

COMMIT;
```

---

## 8. ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒè¯¾ç¨‹

- â­â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç†è®ºåŸºç¡€
- â­â­ [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶æœºåˆ¶

### æ•°æ®æ¨¡å‹è®¾è®¡

- â­â­ [ETLæµç¨‹å®Œæ•´æŒ‡å—](../../09-åº”ç”¨è®¾è®¡/æ•°æ®æ¨¡å‹è®¾è®¡/09.04-ETLæµç¨‹å®Œæ•´æŒ‡å—.md) - åˆ†å¸ƒå¼ETLå¤„ç†
- â­ [æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—](../../09-åº”ç”¨è®¾è®¡/æ•°æ®æ¨¡å‹è®¾è®¡/09.03-æ•°æ®ä»“åº“è®¾è®¡æŒ‡å—.md) - åˆ†å¸ƒå¼æ•°æ®ä»“åº“

### éƒ¨ç½²æ¶æ„

- â­â­ [åˆ†å¸ƒå¼æ¶æ„è®¾è®¡](../../05-éƒ¨ç½²æ¶æ„/åˆ†å¸ƒå¼éƒ¨ç½²/05.08-åˆ†å¸ƒå¼æ¶æ„è®¾è®¡.md) - åˆ†å¸ƒå¼æ¶æ„
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../../05-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„

### ç†è®ºåŸºç¡€

- â­â­ [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../../10-ç†è®ºåŸºç¡€/10.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - åˆ†å¸ƒå¼åè®®å½¢å¼åŒ–éªŒè¯
- â­ [å­¦æœ¯ç ”ç©¶å‰æ²¿](../../10-ç†è®ºåŸºç¡€/10.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - åˆ†å¸ƒå¼äº‹åŠ¡ç ”ç©¶

### è¡Œä¸šæ¡ˆä¾‹

- â­â­ [é‡‘èè´¦åŠ¡ä¸€è‡´æ€§](../../09-åº”ç”¨è®¾è®¡/è¡Œä¸šæ¡ˆä¾‹/é‡‘èè´¦åŠ¡ä¸€è‡´æ€§.md) - ACIDç‰¹æ€§åº”ç”¨æ¡ˆä¾‹

### 8.1 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
- [åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜](../../08-å®æˆ˜æ¡ˆä¾‹/06.04-åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜.md) - åˆ†å¸ƒå¼äº‹åŠ¡å®è·µ
- [é‡‘èè´¦åŠ¡ä¸€è‡´æ€§](../../09-åº”ç”¨è®¾è®¡/è¡Œä¸šæ¡ˆä¾‹/é‡‘èè´¦åŠ¡ä¸€è‡´æ€§.md) - ACIDç‰¹æ€§åº”ç”¨æ¡ˆä¾‹

---

## 9. å½¢å¼è¯æ˜ä¸ç†è®ºè®ºè¯

### 9.1 ä¸¤é˜¶æ®µæäº¤åŸå­æ€§è¯æ˜

**å®šç†**: ä¸¤é˜¶æ®µæäº¤åè®®ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„åŸå­æ€§ï¼Œå³è¦ä¹ˆæ‰€æœ‰å‚ä¸è€…éƒ½æäº¤ï¼Œè¦ä¹ˆéƒ½å›æ»šã€‚

**è¯æ˜**:

```latex
\begin{theorem}[2PCåŸå­æ€§]
è®¾åˆ†å¸ƒå¼äº‹åŠ¡ T æ¶‰åŠ n ä¸ªå‚ä¸è€… P_1, P_2, \ldots, P_nï¼Œåè°ƒè€…ä¸º Cã€‚

é˜¶æ®µ1ï¼ˆå‡†å¤‡é˜¶æ®µï¼‰ï¼š
- C å‘æ‰€æœ‰ P_i å‘é€ PREPARE æ¶ˆæ¯
- æ¯ä¸ª P_i æ‰§è¡Œæœ¬åœ°æ“ä½œå¹¶è¿”å› ACK æˆ– ABORT
- å¦‚æœæ‰€æœ‰ P_i è¿”å› ACKï¼Œåˆ™è¿›å…¥é˜¶æ®µ2ï¼›å¦åˆ™å›æ»š

é˜¶æ®µ2ï¼ˆæäº¤é˜¶æ®µï¼‰ï¼š
- å¦‚æœæ‰€æœ‰ P_i è¿”å› ACKï¼ŒC å‘é€ COMMIT æ¶ˆæ¯
- æ‰€æœ‰ P_i æäº¤æœ¬åœ°äº‹åŠ¡
- å¦‚æœä»»ä½• P_i è¿”å› ABORTï¼ŒC å‘é€ ROLLBACK æ¶ˆæ¯
- æ‰€æœ‰ P_i å›æ»šæœ¬åœ°äº‹åŠ¡

åŸå­æ€§ä¿è¯ï¼š
- æƒ…å†µ1ï¼šæ‰€æœ‰ P_i æäº¤ \Rightarrow å…¨å±€æäº¤
- æƒ…å†µ2ï¼šä»»ä½• P_i å›æ»š \Rightarrow å…¨å±€å›æ»š
- ä¸å­˜åœ¨éƒ¨åˆ†æäº¤çš„æƒ…å†µ

å› æ­¤ï¼Œ2PCä¿è¯åŸå­æ€§ã€‚
\end{theorem}
```

### 9.2 ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„ä¿è¯

**å®šç†**: åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé€šè¿‡2PCåè®®å¯ä»¥å®ç°ACIDç‰¹æ€§çš„åˆ†å¸ƒå¼ä¿è¯ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[åˆ†å¸ƒå¼ACIDä¿è¯]
è®¾åˆ†å¸ƒå¼äº‹åŠ¡ T åœ¨åˆ†å¸ƒå¼ç¯å¢ƒ D ä¸­æ‰§è¡Œï¼Œä½¿ç”¨2PCåè®®ã€‚

åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼š
- 2PCåè®®ä¿è¯ï¼š\forall P_i: commit(T) \lor rollback(T)
- ä¸å­˜åœ¨éƒ¨åˆ†æäº¤çš„æƒ…å†µ
- å› æ­¤ï¼ŒåŸå­æ€§å¾—åˆ°ä¿è¯

ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼š
- æ¯ä¸ª P_i çš„æœ¬åœ°çº¦æŸåœ¨æäº¤å‰éªŒè¯
- å…¨å±€çº¦æŸé€šè¿‡åˆ†å¸ƒå¼é”ä¿è¯
- å› æ­¤ï¼Œä¸€è‡´æ€§å¾—åˆ°ä¿è¯

éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼š
- é€šè¿‡åˆ†å¸ƒå¼é”å®ç°
- æ­»é”æ£€æµ‹ç®—æ³•ä¿è¯æ— æ­»é”
- å› æ­¤ï¼Œéš”ç¦»æ€§å¾—åˆ°ä¿è¯

æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼š
- æ¯ä¸ª P_i çš„WALä¿è¯æœ¬åœ°æŒä¹…æ€§
- åˆ†å¸ƒå¼WALä¿è¯å…¨å±€æŒä¹…æ€§
- å› æ­¤ï¼ŒæŒä¹…æ€§å¾—åˆ°ä¿è¯

å› æ­¤ï¼Œ2PCåè®®å¯ä»¥ä¿è¯åˆ†å¸ƒå¼ACIDç‰¹æ€§ã€‚
\end{theorem}
```

### 9.3 SAGAæ¨¡å¼æœ€ç»ˆä¸€è‡´æ€§è¯æ˜

**å®šç†**: SAGAæ¨¡å¼é€šè¿‡è¡¥å¿äº‹åŠ¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå³ç³»ç»Ÿæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚

**è¯æ˜**:

```latex
\begin{theorem}[SAGAæœ€ç»ˆä¸€è‡´æ€§]
è®¾SAGAäº‹åŠ¡ S = \{T_1, T_2, \ldots, T_n\}ï¼Œæ¯ä¸ª T_i æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ C_iã€‚

SAGAæ‰§è¡Œè§„åˆ™ï¼š
- å¦‚æœæ‰€æœ‰ T_i æˆåŠŸï¼Œåˆ™ S æˆåŠŸ
- å¦‚æœä»»ä½• T_i å¤±è´¥ï¼Œåˆ™æ‰§è¡Œ C_{i-1}, C_{i-2}, \ldots, C_1

æœ€ç»ˆä¸€è‡´æ€§ä¿è¯ï¼š
- æƒ…å†µ1ï¼šæ‰€æœ‰ T_i æˆåŠŸ \Rightarrow ç³»ç»Ÿå¤„äºä¸€è‡´çŠ¶æ€
- æƒ…å†µ2ï¼šT_k å¤±è´¥ï¼Œæ‰§è¡Œ C_{k-1}, \ldots, C_1 \Rightarrow ç³»ç»Ÿå›é€€åˆ°åˆå§‹çŠ¶æ€

ç”±äºè¡¥å¿äº‹åŠ¡çš„å¹‚ç­‰æ€§ï¼Œç³»ç»Ÿæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚

å› æ­¤ï¼ŒSAGAæ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚
\end{theorem}
```

---

## 10. Wikipediaå¯¹é½

### 10.1 åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Distributed transaction](https://en.wikipedia.org/wiki/Distributed_transaction)

> A distributed transaction is a database transaction in which two or more network hosts are involved. Usually, hosts provide transactional resources, while a transaction manager is responsible for creating and managing a global transaction that encompasses all operations against such resources.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒæ¶‰åŠå¤šä¸ªç½‘ç»œä¸»æœºçš„äº‹åŠ¡
- âœ… **æ ¸å¿ƒç»„ä»¶**: éƒ½æåˆ°äº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨
- âœ… **ACIDç‰¹æ€§**: éƒ½å¼ºè°ƒåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯ACIDç‰¹æ€§

### 10.2 ä¸¤é˜¶æ®µæäº¤åè®®å¯¹é½

**Wikipediaå®šä¹‰**: [Two-phase commit protocol](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)

> In transaction processing, databases, and computer networking, the two-phase commit protocol (2PC) is a type of atomic commitment protocol. It is a distributed algorithm that coordinates all the processes that participate in a distributed atomic transaction on whether to commit or abort (roll back) the transaction.

**å¯¹é½è¯´æ˜**:

- âœ… **åè®®å®šä¹‰**: PostgreSQLçš„2PCå®ç°ç¬¦åˆWikipediaçš„2PCåè®®å®šä¹‰
- âœ… **ä¸¤é˜¶æ®µ**: éƒ½åŒ…å«å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µ
- âœ… **åŸå­æ€§**: éƒ½å¼ºè°ƒåŸå­æ€§ä¿è¯

### 10.3 ACIDç‰¹æ€§å¯¹é½

**Wikipediaå®šä¹‰**: [ACID](https://en.wikipedia.org/wiki/ACID)

> In computer science, ACID (Atomicity, Consistency, Isolation, Durability) is a set of properties of database transactions intended to guarantee data validity despite errors, power failures, and other mishaps.

**å¯¹é½è¯´æ˜**:

- âœ… **ç‰¹æ€§å®šä¹‰**: PostgreSQLçš„ACIDå®ç°ç¬¦åˆWikipediaçš„ACIDå®šä¹‰
- âœ… **å››ä¸ªç‰¹æ€§**: éƒ½åŒ…å«åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
- âœ… **ä¿è¯æœºåˆ¶**: éƒ½å¼ºè°ƒé€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®æœ‰æ•ˆæ€§

---

## 11. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>

2. Gray, J., & Lamport, L. (2006). Consensus on transaction commit. ACM Transactions on Database Systems, 31(1), 133-160.

3. Garcia-Molina, H., & Salem, K. (1987). Sagas. ACM SIGMOD Record, 16(3), 249-259.

4. Citus Data. (2025). Citus Distributed Transactions. <https://docs.citusdata.com/en/stable/develop/api_udf.html#distributed-transactions>

5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-12
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
