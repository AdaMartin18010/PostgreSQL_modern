# 向量数据库支持

> **文档版本**: v2.0
> **最后更新**: 2025-11-12
> **版本覆盖**: PostgreSQL 17+ | PostgreSQL 18 ⭐
> **文档状态**: ✅ 基础概述文档
> 📖 **文档说明**
>
> 本文档提供向量数据库的**基础概述**。如需详细内容，请参考：
>
> - 🚀 [向量检索性能调优指南](../../07-前沿技术/05.05-向量检索性能调优指南.md) - 完整的性能调优方法 (PG 18+ ⭐)
> - 🔍 [向量与混合搜索](../../07-前沿技术/AI-时代/01-向量与混合搜索-pgvector与RRF.md) - pgvector 2.0 + RRF 融合 (PG 18+ ⭐)
> - 📋 [AI 时代专题](../ai_view.md) ⭐⭐⭐ (v3.0, 2025-11-11)
> - 🛠️ [向量检索落地指南](../runbook/04-向量检索与混合查询-落地指南.md) - 生产部署指南

---

## 1. 概述

PostgreSQL通过pgvector扩展提供向量数据库支持，包括：

- **向量类型**: `vector(n)` 类型存储高维向量
- **相似度检索**: L2、内积、余弦相似度
- **混合查询**: 向量+结构化/全文搜索融合

## 2. 类型与距离

- 类型：`vector(n)`（pgvector 扩展），`n` 为维度。
- 距离度量：`L2`（欧氏）、`IP`（内积）、`COSINE`（余弦）。
- 相似度与排序：`ORDER BY embedding <-> query_vec`（L2/余弦），`<#>`（内积）。

## 3. 索引与算法

- HNSW：近似NN图检索，召回高、查询快，内存占用较大。
- IVFFlat：倒排粗量化，适合批量查询与大规模数据，需 `ANALYZE` 以良好分桶。
- PQ/IVFPQ：乘积量化压缩，显著节省存储但牺牲精度。

```sql
-- 安装与类型
CREATE EXTENSION IF NOT EXISTS vector;

-- 基础表
CREATE TABLE docs (
  id bigserial PRIMARY KEY,
  text text,
  embedding vector(768)
);

-- 索引：HNSW/IVFFlat/PQ
CREATE INDEX ON docs USING hnsw (embedding vector_l2_ops);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_cosine_ops) WITH (lists = 200);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_ip_ops) WITH (lists = 100);

-- 典型查询
WITH q AS (
  SELECT '[0.1,0.2,...]'::vector AS qv
)
SELECT id, text
FROM docs, q
ORDER BY embedding <-> q.qv
LIMIT 20;
```

## 4. 混合检索（结构化/全文/向量）

- 与结构化过滤：先用结构化谓词裁剪候选，再进行ANN；或以 ANN 返回候选后再做结构化过滤/重排。
- 与全文搜索：`to_tsvector` + GIN 与向量召回的交集/加权融合。

```sql
-- 结构化 + 向量
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> '[...]'::vector
LIMIT 50;

-- 全文 + 向量（粗召回 + 精重排）
WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple','postgres')) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple','postgres')
  ORDER BY tr DESC
  LIMIT 500
), v AS (
  SELECT id, embedding <-> '[...]'::vector AS dist
  FROM docs WHERE id IN (SELECT id FROM s)
  ORDER BY dist ASC LIMIT 100
)
SELECT * FROM v ORDER BY dist ASC;
```

## 5. 存储布局与冷热分层

- 行存 + 大向量：考虑 `TOAST` 与I/O；热字段与向量分表或列化（如外部对象存储/FDW）。
- 冷热分层：热集合保留高精度HNSW，冷集合采用IVFPQ压缩，统一在视图/UNION层聚合。

## 6. 参数与调优

- HNSW：`M`、`ef_construction`（建索引质量）、`ef_search`（查询召回/延迟权衡）。
- IVFFlat：`lists`（分桶数）与 `probes`（查询桶数）；分桶需 `ANALYZE` 充足统计。
- PQ：`m`（子空间数）、`nbits`（码本位数）。
- 维度与归一化：余弦相似度常需单位化；内积需向量中心化/归一化以稳定排序。

### 6.1 训练与索引构建流程

```sql
-- 1) 向量生成（外部/UDF），写入 docs(embedding)
-- 2) 统计信息
ANALYZE docs;

-- 3) 选择索引
CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
-- 或者
CREATE INDEX IF NOT EXISTS docs_ivf ON docs USING ivfflat (embedding vector_cosine_ops) WITH (lists=100);

-- 4) 运行时权衡
SET ivfflat.probes = 10;  -- 提升召回降低延迟；按查询动态调整
```

### 6.2 版本特性提示（PG15/16/17）

- 并行扫描与JIT 对 ANN 影响有限，更多落在算子与扩展层；
- PG17 起 pgvector 引入更快的 build/search 优化（根据扩展版本）；
- 注意 `shared_buffers` 与 `work_mem` 对 ANN 的缓存与内存占用约束。

## 7. 基准与正确性

- 召回/精度：与暴力真值（Brute-Force）对比；评估 Recall@k、MRR、延迟TP50/TP99。
- 可重复性：固定随机种子、记录版本与参数；离线批量重建评估。

## 8. 深入阅读

### 性能调优

- 📊 [向量检索性能调优指南](../../07-前沿技术/05.05-向量检索性能调优指南.md) - HNSW vs IVFFlat对比、参数调优、性能基准
- 🔍 [向量与混合搜索](../../07-前沿技术/AI-时代/01-向量与混合搜索-pgvector与RRF.md) - pgvector 2.0 + RRF 融合算法

### 实战应用

- 🚀 [RAG架构实战指南](../../07-前沿技术/05.04-RAG架构实战指南.md) - 完整的RAG系统实现
- 🛠️ [向量检索落地指南](../runbook/04-向量检索与混合查询-落地指南.md) - 生产部署最佳实践
- 📋 [AI 时代专题](../ai_view.md) - PostgreSQL在AI时代的全面演进

### 相关主题

- [查询优化器原理](../../03-查询与优化/02.01-查询优化器原理.md) - 查询优化基础
- [索引结构与优化](../../03-查询与优化/02.02-索引结构与优化.md) - 索引设计原理
- [执行计划与性能调优](../../03-查询与优化/02.04-执行计划与性能调优.md) - 性能分析

## 9. 参考文献

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
3. pgvector官方文档 - [pgvector GitHub](https://github.com/pgvector/pgvector)
4. PostgreSQL官方文档 - [索引类型](https://www.postgresql.org/docs/current/indexes-types.html)
