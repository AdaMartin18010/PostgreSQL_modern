# 向量数据库快速参考指南

> **文档版本**: v1.0
> **最后更新**: 2025-01-XX
> **快速参考**: 常用命令和模式速查

---

## 📋 目录

- [向量数据库快速参考指南](#向量数据库快速参考指南)
  - [📋 目录](#-目录)
  - [1. 快速开始](#1-快速开始)
    - [1.1 安装和启用](#11-安装和启用)
    - [1.2 创建表和索引](#12-创建表和索引)
    - [1.3 基础查询](#13-基础查询)
  - [2. 常用SQL模式](#2-常用sql模式)
    - [2.1 基础向量查询](#21-基础向量查询)
    - [2.2 混合检索模式](#22-混合检索模式)
    - [2.3 RRF融合](#23-rrf融合)
  - [3. 索引选择快速决策](#3-索引选择快速决策)
    - [3.1 决策树](#31-决策树)
    - [3.2 常用配置](#32-常用配置)
  - [4. 性能优化检查清单](#4-性能优化检查清单)
    - [4.1 索引优化](#41-索引优化)
    - [4.2 查询优化](#42-查询优化)
    - [4.3 资源优化](#43-资源优化)
  - [5. 故障排查快速指南](#5-故障排查快速指南)
    - [5.1 查询慢](#51-查询慢)
    - [5.2 召回率低](#52-召回率低)
    - [5.3 内存不足](#53-内存不足)
    - [5.4 索引构建慢](#54-索引构建慢)
  - [6. 常用参数速查](#6-常用参数速查)
    - [6.1 PostgreSQL参数](#61-postgresql参数)
    - [6.2 索引参数](#62-索引参数)
  - [7. 性能基准参考](#7-性能基准参考)
    - [7.1 查询延迟（P95）](#71-查询延迟p95)
    - [7.2 索引构建时间](#72-索引构建时间)
    - [7.3 索引大小](#73-索引大小)
  - [8. 相关文档](#8-相关文档)
    - [详细指南](#详细指南)
    - [快速参考](#快速参考)

---

## 1. 快速开始

### 1.1 安装和启用

```sql
-- 安装扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 验证安装
SELECT extversion FROM pg_extension WHERE extname = 'vector';
```

### 1.2 创建表和索引

```sql
-- 创建表
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536),
    metadata JSONB
);

-- 创建HNSW索引（推荐）
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=64);

-- 创建IVFFlat索引（大规模数据）
CREATE INDEX ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists=100);
```

### 1.3 基础查询

```sql
-- 向量相似度搜索
SELECT id, content, embedding <=> query_vector AS distance
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 混合查询（向量+文本）
SELECT id, content
FROM documents
WHERE category = 'tech'
ORDER BY embedding <=> query_vector
LIMIT 10;
```

---

## 2. 常用SQL模式

### 2.1 基础向量查询

```sql
-- L2距离
SELECT * FROM docs ORDER BY embedding <-> query_vector LIMIT 10;

-- 余弦相似度（推荐）
SELECT * FROM docs ORDER BY embedding <=> query_vector LIMIT 10;

-- 内积
SELECT * FROM docs ORDER BY embedding <#> query_vector LIMIT 10;
```

### 2.2 混合检索模式

```sql
-- 模式1: 结构化过滤 + 向量排序
SELECT id, content
FROM documents
WHERE created_at >= NOW() - INTERVAL '7 days'
ORDER BY embedding <=> query_vector
LIMIT 50;

-- 模式2: 全文搜索 + 向量重排序
WITH text_results AS (
    SELECT id, ts_rank(to_tsvector('english', content),
        plainto_tsquery('english', 'search term')) AS score
    FROM documents
    WHERE to_tsvector('english', content) @@ plainto_tsquery('english', 'search term')
    LIMIT 500
)
SELECT d.id, d.content
FROM documents d
JOIN text_results t ON d.id = t.id
ORDER BY d.embedding <=> query_vector
LIMIT 50;
```

### 2.3 RRF融合

```sql
-- RRF融合查询（简化版）
WITH text_ranks AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY ts_rank(...) DESC) AS rank
    FROM documents WHERE ...
    LIMIT 60
),
vector_ranks AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY embedding <=> query_vector) AS rank
    FROM documents
    ORDER BY embedding <=> query_vector
    LIMIT 60
)
SELECT COALESCE(t.id, v.id) AS id,
       COALESCE(1.0/(60+t.rank), 0) + COALESCE(1.0/(60+v.rank), 0) AS rrf_score
FROM text_ranks t
FULL OUTER JOIN vector_ranks v ON t.id = v.id
ORDER BY rrf_score DESC
LIMIT 50;
```

---

## 3. 索引选择快速决策

### 3.1 决策树

```text
数据规模 < 100万?
├─ 是 → HNSW (m=16, ef_construction=64)
└─ 否 → 查询延迟要求?
    ├─ < 10ms → HNSW (m=32, ef_construction=128)
    └─ 10-50ms → IVFFlat (lists=N/1000, probes=lists*0.05)
```

### 3.2 常用配置

| 场景 | 索引类型 | 参数 | 召回率 | 延迟 |
|------|---------|------|--------|------|
| 小规模(<100万) | HNSW | m=16, ef_construction=64 | 98% | 5ms |
| 中规模(100-1000万) | HNSW | m=32, ef_construction=128 | 99% | 8ms |
| 大规模(>1000万) | IVFFlat | lists=10000, probes=500 | 95% | 30ms |
| 高精度 | HNSW | m=64, ef_construction=200 | 99.5% | 5ms |

---

## 4. 性能优化检查清单

### 4.1 索引优化

- [ ] 选择合适的索引类型（HNSW vs IVFFlat）
- [ ] 正确设置索引参数（m, ef_construction, lists）
- [ ] 执行ANALYZE更新统计信息
- [ ] 检查索引是否被使用（EXPLAIN ANALYZE）
- [ ] 监控索引大小和内存占用

### 4.2 查询优化

- [ ] 使用适当的距离度量（余弦 vs L2）
- [ ] 设置合适的LIMIT值
- [ ] 优化混合查询顺序（先过滤后排序）
- [ ] 调整ivfflat.probes参数（IVFFlat索引）
- [ ] 使用work_mem优化排序

### 4.3 资源优化

- [ ] 监控shared_buffers使用率
- [ ] 优化work_mem设置
- [ ] 检查TOAST压缩效果
- [ ] 考虑使用halfvec减少存储
- [ ] 实施冷热数据分层

---

## 5. 故障排查快速指南

### 5.1 查询慢

```sql
-- 1. 检查执行计划
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 2. 检查索引使用情况
SELECT indexname, idx_scan, idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename = 'documents';

-- 3. 检查统计信息
SELECT schemaname, tablename, n_live_tup, last_analyze
FROM pg_stat_user_tables
WHERE tablename = 'documents';

-- 解决方案:
-- - 重建索引: REINDEX INDEX documents_embedding_idx;
-- - 更新统计: ANALYZE documents;
-- - 增加probes: SET ivfflat.probes = 100;
```

### 5.2 召回率低

```sql
-- 1. 检查索引参数
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'documents';

-- 2. 对比精确搜索和索引搜索
-- 精确搜索（无索引，暴力搜索）
EXPLAIN ANALYZE
SELECT id FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 索引搜索
EXPLAIN ANALYZE
SELECT id FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 解决方案:
-- - 增加ef_construction（HNSW）
-- - 增加probes（IVFFlat）
-- - 重建索引
```

### 5.3 内存不足

```sql
-- 1. 检查当前设置
SHOW work_mem;
SHOW shared_buffers;

-- 2. 检查内存使用
SELECT pg_size_pretty(pg_database_size(current_database()));
SELECT pg_size_pretty(sum(pg_relation_size(indexrelid)))
FROM pg_stat_user_indexes
WHERE tablename = 'documents';

-- 解决方案:
-- - 增加work_mem: SET work_mem = '512MB';
-- - 使用halfvec减少存储
-- - 考虑分片或分区
```

### 5.4 索引构建慢

```sql
-- 1. 检查构建进度
SELECT pid, datname, query, state
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%';

-- 2. 优化构建参数
SET maintenance_work_mem = '2GB';  -- 增加内存
SET max_parallel_workers_per_gather = 4;  -- 并行构建

-- 解决方案:
-- - 使用CONCURRENTLY避免锁表
-- - 降低ef_construction（HNSW）
-- - 分批构建（分区表）
```

---

## 6. 常用参数速查

### 6.1 PostgreSQL参数

```sql
-- 内存相关
SET work_mem = '256MB';              -- 查询内存
SET maintenance_work_mem = '2GB';    -- 维护操作内存
SET shared_buffers = '8GB';          -- 共享缓冲区

-- IVFFlat参数
SET ivfflat.probes = 50;             -- 搜索的聚类数

-- 并行相关
SET max_parallel_workers_per_gather = 4;  -- 并行工作进程
```

### 6.2 索引参数

```sql
-- HNSW参数
CREATE INDEX ... WITH (
    m = 16,                    -- 每层连接数 (8-64)
    ef_construction = 64       -- 构建时候选数 (100-1000)
);

-- IVFFlat参数
CREATE INDEX ... WITH (
    lists = 100                -- 聚类中心数 (N/1000)
);
```

---

## 7. 性能基准参考

### 7.1 查询延迟（P95）

| 数据规模 | HNSW | IVFFlat | 召回率 |
|---------|------|---------|--------|
| 100万 | 5ms | 25ms | 98% / 95% |
| 1000万 | 8ms | 35ms | 98% / 94% |
| 1亿 | 13ms | 52ms | 97% / 95% |

### 7.2 索引构建时间

| 数据规模 | HNSW | IVFFlat |
|---------|------|---------|
| 1000万 | 2.1小时 | 25分钟 |
| 1亿 | 8.5小时 | 4.5小时 |

### 7.3 索引大小

| 数据规模 | 数据大小 | HNSW索引 | IVFFlat索引 |
|---------|---------|---------|------------|
| 1000万 | 29GB | 52GB (1.8x) | 20GB (0.7x) |
| 1亿 | 290GB | 520GB (1.8x) | 180GB (0.6x) |

---

## 8. 相关文档

### 详细指南

- [向量数据库支持](./04.05-向量数据库支持.md) - 完整指南
- [竞争对手对比](./04.05.01-向量数据库竞争对手对比.md) - 对比分析
- [落地指南](../../06-运维实践/运维手册/04-向量检索与混合查询-落地指南.md) - 生产部署

### 快速参考

- [多模型集成目录](./README.md) - 文档索引
- [改进推进总结](./00-改进推进总结-2025-01.md) - 最新更新

---

**最后更新**: 2025-01-XX
**维护者**: PostgreSQL Modern Team
