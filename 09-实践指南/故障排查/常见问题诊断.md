# 9.3.1 å¸¸è§é—®é¢˜è¯Šæ–­

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æ–‡æ¡£ç¼–å·**: 09-03-01

## ğŸ“‘ ç›®å½•

- [9.3.1 å¸¸è§é—®é¢˜è¯Šæ–­](#931-å¸¸è§é—®é¢˜è¯Šæ–­)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ–‡æ¡£ç›®æ ‡](#11-æ–‡æ¡£ç›®æ ‡)
    - [1.2 é—®é¢˜åˆ†ç±»](#12-é—®é¢˜åˆ†ç±»)
    - [1.3 è¯Šæ–­æµç¨‹](#13-è¯Šæ–­æµç¨‹)
  - [2. æ€§èƒ½é—®é¢˜](#2-æ€§èƒ½é—®é¢˜)
    - [2.1 å‘é‡æŸ¥è¯¢æ€§èƒ½æ…¢](#21-å‘é‡æŸ¥è¯¢æ€§èƒ½æ…¢)
      - [2.1.1 ç—‡çŠ¶æè¿°](#211-ç—‡çŠ¶æè¿°)
      - [2.1.2 è¯Šæ–­æ­¥éª¤](#212-è¯Šæ–­æ­¥éª¤)
      - [2.1.3 è§£å†³æ–¹æ¡ˆ](#213-è§£å†³æ–¹æ¡ˆ)
      - [2.1.4 æ€§èƒ½ä¼˜åŒ–](#214-æ€§èƒ½ä¼˜åŒ–)
    - [2.2 ç´¢å¼•æ„å»ºå¤±è´¥](#22-ç´¢å¼•æ„å»ºå¤±è´¥)
      - [2.2.1 ç—‡çŠ¶æè¿°](#221-ç—‡çŠ¶æè¿°)
      - [2.2.2 è¯Šæ–­æ­¥éª¤](#222-è¯Šæ–­æ­¥éª¤)
      - [2.2.3 è§£å†³æ–¹æ¡ˆ](#223-è§£å†³æ–¹æ¡ˆ)
  - [3. èµ„æºé—®é¢˜](#3-èµ„æºé—®é¢˜)
    - [3.1 å†…å­˜ä¸è¶³](#31-å†…å­˜ä¸è¶³)
      - [3.1.1 ç—‡çŠ¶æè¿°](#311-ç—‡çŠ¶æè¿°)
      - [3.1.2 è¯Šæ–­æ­¥éª¤](#312-è¯Šæ–­æ­¥éª¤)
      - [3.1.3 è§£å†³æ–¹æ¡ˆ](#313-è§£å†³æ–¹æ¡ˆ)
    - [3.2 è¿æ¥æ•°è¶…é™](#32-è¿æ¥æ•°è¶…é™)
      - [3.2.1 ç—‡çŠ¶æè¿°](#321-ç—‡çŠ¶æè¿°)
      - [3.2.2 è¯Šæ–­æ­¥éª¤](#322-è¯Šæ–­æ­¥éª¤)
      - [3.2.3 è§£å†³æ–¹æ¡ˆ](#323-è§£å†³æ–¹æ¡ˆ)
  - [4. æ•°æ®é—®é¢˜](#4-æ•°æ®é—®é¢˜)
    - [4.1 æŸ¥è¯¢ç»“æœä¸å‡†ç¡®](#41-æŸ¥è¯¢ç»“æœä¸å‡†ç¡®)
      - [4.1.1 ç—‡çŠ¶æè¿°](#411-ç—‡çŠ¶æè¿°)
      - [4.1.2 è¯Šæ–­æ­¥éª¤](#412-è¯Šæ–­æ­¥éª¤)
      - [4.1.3 è§£å†³æ–¹æ¡ˆ](#413-è§£å†³æ–¹æ¡ˆ)
    - [4.2 æ•°æ®ä¸ä¸€è‡´](#42-æ•°æ®ä¸ä¸€è‡´)
      - [4.2.1 ç—‡çŠ¶æè¿°](#421-ç—‡çŠ¶æè¿°)
      - [4.2.2 è¯Šæ–­æ­¥éª¤](#422-è¯Šæ–­æ­¥éª¤)
      - [4.2.3 è§£å†³æ–¹æ¡ˆ](#423-è§£å†³æ–¹æ¡ˆ)
  - [5. æ‰©å±•é—®é¢˜](#5-æ‰©å±•é—®é¢˜)
    - [5.1 pgvector æ‰©å±•é—®é¢˜](#51-pgvector-æ‰©å±•é—®é¢˜)
    - [5.2 TimescaleDB æ‰©å±•é—®é¢˜](#52-timescaledb-æ‰©å±•é—®é¢˜)
  - [6. è¯Šæ–­å·¥å…·](#6-è¯Šæ–­å·¥å…·)
    - [6.1 æ€§èƒ½è¯Šæ–­è„šæœ¬](#61-æ€§èƒ½è¯Šæ–­è„šæœ¬)
    - [6.2 ç›‘æ§æŸ¥è¯¢](#62-ç›‘æ§æŸ¥è¯¢)
    - [6.3 è‡ªåŠ¨åŒ–è¯Šæ–­](#63-è‡ªåŠ¨åŒ–è¯Šæ–­)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 é¢„é˜²æªæ–½](#71-é¢„é˜²æªæ–½)
    - [7.2 æ•…éšœå“åº”](#72-æ•…éšœå“åº”)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯æ–‡æ¡£](#82-æŠ€æœ¯æ–‡æ¡£)
    - [8.3 ç›¸å…³èµ„æº](#83-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**:

æœ¬æ–‡æ¡£æä¾› PostgreSQL + pgvector å¸¸è§é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

**æ–‡æ¡£ä»·å€¼**:

| ä»·å€¼é¡¹       | è¯´æ˜               | å½±å“         |
| ------------ | ------------------ | ------------ |
| **å¿«é€Ÿè¯Šæ–­** | æä¾›ç³»ç»ŸåŒ–è¯Šæ–­æµç¨‹ | å‡å°‘æ•…éšœæ—¶é—´ |
| **è§£å†³æ–¹æ¡ˆ** | æä¾›å¤šç§è§£å†³æ–¹æ¡ˆ   | æé«˜è§£å†³æ•ˆç‡ |
| **é¢„é˜²æªæ–½** | æä¾›é¢„é˜²å»ºè®®       | å‡å°‘æ•…éšœå‘ç”Ÿ |

### 1.2 é—®é¢˜åˆ†ç±»

**é—®é¢˜åˆ†ç±»**:

1. **æ€§èƒ½é—®é¢˜**:

   - å‘é‡æŸ¥è¯¢æ€§èƒ½æ…¢
   - ç´¢å¼•æ„å»ºå¤±è´¥
   - æŸ¥è¯¢è¶…æ—¶

2. **èµ„æºé—®é¢˜**:

   - å†…å­˜ä¸è¶³
   - è¿æ¥æ•°è¶…é™
   - ç£ç›˜ç©ºé—´ä¸è¶³

3. **æ•°æ®é—®é¢˜**:

   - æŸ¥è¯¢ç»“æœä¸å‡†ç¡®
   - æ•°æ®ä¸ä¸€è‡´
   - æ•°æ®æŸå

4. **æ‰©å±•é—®é¢˜**:
   - pgvector æ‰©å±•é—®é¢˜
   - TimescaleDB æ‰©å±•é—®é¢˜
   - å…¶ä»–æ‰©å±•é—®é¢˜

**é—®é¢˜ä¼˜å…ˆçº§**:

| ä¼˜å…ˆçº§        | é—®é¢˜ç±»å‹     | å“åº”æ—¶é—´     |
| ------------- | ------------ | ------------ |
| **P0 - ç´§æ€¥** | æœåŠ¡ä¸å¯ç”¨   | **<15 åˆ†é’Ÿ** |
| **P1 - é«˜**   | æ€§èƒ½ä¸¥é‡ä¸‹é™ | **<1 å°æ—¶**  |
| **P2 - ä¸­**   | åŠŸèƒ½å¼‚å¸¸     | **<4 å°æ—¶**  |
| **P3 - ä½**   | ä¼˜åŒ–å»ºè®®     | **<24 å°æ—¶** |

### 1.3 è¯Šæ–­æµç¨‹

**è¯Šæ–­æµç¨‹**:

```text
é—®é¢˜æŠ¥å‘Š
    â†“
1. é—®é¢˜åˆ†ç±»ï¼ˆæ€§èƒ½/èµ„æº/æ•°æ®/æ‰©å±•ï¼‰
    â†“
2. ç—‡çŠ¶è¯†åˆ«ï¼ˆé”™è¯¯ä¿¡æ¯ã€æ€§èƒ½æŒ‡æ ‡ï¼‰
    â†“
3. è¯Šæ–­æ­¥éª¤ï¼ˆæ‰§è¡Œè¯Šæ–­æŸ¥è¯¢ï¼‰
    â†“
4. é—®é¢˜å®šä½ï¼ˆç¡®å®šæ ¹æœ¬åŸå› ï¼‰
    â†“
5. è§£å†³æ–¹æ¡ˆï¼ˆé€‰æ‹©åˆé€‚æ–¹æ¡ˆï¼‰
    â†“
6. éªŒè¯ä¿®å¤ï¼ˆç¡®è®¤é—®é¢˜è§£å†³ï¼‰
    â†“
7. é¢„é˜²æªæ–½ï¼ˆé¿å…å†æ¬¡å‘ç”Ÿï¼‰
```

## 2. æ€§èƒ½é—®é¢˜

### 2.1 å‘é‡æŸ¥è¯¢æ€§èƒ½æ…¢

#### 2.1.1 ç—‡çŠ¶æè¿°

**å¸¸è§ç—‡çŠ¶**:

1. **æŸ¥è¯¢å»¶è¿Ÿé«˜**:

   - å‘é‡æŸ¥è¯¢å»¶è¿Ÿ >100ms
   - ç”¨æˆ·åé¦ˆæŸ¥è¯¢æ…¢
   - ç³»ç»Ÿå“åº”æ—¶é—´é•¿

2. **æ€§èƒ½æŒ‡æ ‡å¼‚å¸¸**:
   - QPS ä¸‹é™
   - CPU ä½¿ç”¨ç‡å‡é«˜
   - ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™

**æ€§èƒ½åŸºå‡†**:

| æ•°æ®é‡     | æ­£å¸¸å»¶è¿Ÿ  | è­¦å‘Šå»¶è¿Ÿ     | ä¸¥é‡å»¶è¿Ÿ   |
| ---------- | --------- | ------------ | ---------- |
| **1 ä¸‡**   | **<5ms**  | **5-10ms**   | **>10ms**  |
| **10 ä¸‡**  | **<10ms** | **10-20ms**  | **>20ms**  |
| **100 ä¸‡** | **<50ms** | **50-100ms** | **>100ms** |

#### 2.1.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤è¯¦è§£**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
SELECT
    indexname,
    indexdef,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_indexes
WHERE tablename = 'documents'
  AND indexdef LIKE '%vector%';

-- é¢„æœŸç»“æœï¼šåº”è¯¥è‡³å°‘æœ‰ä¸€ä¸ªå‘é‡ç´¢å¼•
-- å¦‚æœä¸ºç©ºï¼Œè¯´æ˜ç¼ºå°‘ç´¢å¼•

-- æ­¥éª¤ 2: æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan as scan_count,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched,
    CASE
        WHEN idx_scan = 0 THEN 'æœªä½¿ç”¨'
        WHEN idx_scan < 10 THEN 'ä½ä½¿ç”¨'
        WHEN idx_scan < 100 THEN 'ä¸­ä½¿ç”¨'
        ELSE 'é«˜ä½¿ç”¨'
    END as usage_status
FROM pg_stat_user_indexes
WHERE tablename = 'documents'
  AND indexdef LIKE '%vector%';

-- æ­¥éª¤ 3: æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    id,
    content,
    1 - (embedding <=> '[0.1, 0.2, ...]'::vector(1536)) as similarity
FROM documents
ORDER BY embedding <=> '[0.1, 0.2, ...]'::vector(1536)
LIMIT 10;

-- å…³é”®æŒ‡æ ‡ï¼š
-- - æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼ˆåº”è¯¥æ˜¾ç¤º Index Scan using ...ï¼‰
-- - æ‰§è¡Œæ—¶é—´ï¼ˆExecution Timeï¼‰
-- - ç¼“å­˜å‘½ä¸­ç‡ï¼ˆBuffers: shared hitï¼‰
```

**è¯Šæ–­æŒ‡æ ‡è¯´æ˜**:

| æŒ‡æ ‡             | æ­£å¸¸å€¼    | è­¦å‘Šå€¼  | ä¸¥é‡å€¼    |
| ---------------- | --------- | ------- | --------- |
| **ç´¢å¼•æ‰«ææ¬¡æ•°** | **>100**  | 10-100  | **<10**   |
| **æŸ¥è¯¢å»¶è¿Ÿ**     | **<10ms** | 10-50ms | **>50ms** |
| **ç¼“å­˜å‘½ä¸­ç‡**   | **>90%**  | 80-90%  | **<80%**  |

#### 2.1.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: åˆ›å»º HNSW ç´¢å¼•ï¼ˆé«˜ç²¾åº¦åœºæ™¯ï¼Œ<100 ä¸‡æ•°æ®ï¼‰
CREATE INDEX documents_embedding_hnsw_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,              -- æ¯å±‚æœ€å¤§è¿æ¥æ•°
    ef_construction = 64  -- æ„å»ºæ—¶æœç´¢èŒƒå›´
);

-- æŸ¥è¯¢æ—¶è°ƒæ•´æœç´¢èŒƒå›´
SET hnsw.ef_search = 40;  -- æé«˜å¬å›ç‡ï¼Œå¯èƒ½é™ä½é€Ÿåº¦

-- æ–¹æ¡ˆ 2: ä½¿ç”¨ IVFFlatï¼ˆå¤§è§„æ¨¡åœºæ™¯ï¼Œ>100 ä¸‡æ•°æ®ï¼‰
CREATE INDEX documents_embedding_ivfflat_idx ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (
    lists = 1000  -- èšç±»æ•°é‡ï¼Œå»ºè®® = rows/1000
);

-- æŸ¥è¯¢æ—¶è°ƒæ•´æœç´¢èšç±»æ•°
SET ivfflat.probes = 10;  -- æœç´¢çš„èšç±»æ•°é‡

-- æ–¹æ¡ˆ 3: ä¼˜åŒ–ç°æœ‰ç´¢å¼•å‚æ•°
-- å¦‚æœç´¢å¼•å·²å­˜åœ¨ä½†æ€§èƒ½ä¸ä½³ï¼Œå¯ä»¥é‡å»ºç´¢å¼•

-- å…ˆåˆ é™¤æ—§ç´¢å¼•
DROP INDEX IF EXISTS documents_embedding_idx;

-- é‡å»ºç´¢å¼•ï¼ˆä½¿ç”¨æ›´ä¼˜å‚æ•°ï¼‰
CREATE INDEX documents_embedding_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 32,              -- æé«˜ç²¾åº¦
    ef_construction = 200  -- æé«˜æ„å»ºè´¨é‡
);

-- æ–¹æ¡ˆ 4: åˆ†åŒºè¡¨ä¼˜åŒ–
-- å¯¹äºè¶…å¤§è§„æ¨¡æ•°æ®ï¼Œä½¿ç”¨åˆ†åŒºè¡¨

CREATE TABLE documents (
    id SERIAL,
    content TEXT,
    embedding vector(1536),
    created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY RANGE (created_at);

CREATE TABLE documents_recent PARTITION OF documents
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

CREATE TABLE documents_archive PARTITION OF documents
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºç´¢å¼•
CREATE INDEX ON documents_recent
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX ON documents_archive
USING ivfflat (embedding vector_cosine_ops);
```

**æ–¹æ¡ˆé€‰æ‹©å»ºè®®**:

| åœºæ™¯                    | æ¨èæ–¹æ¡ˆ       | ç†ç”±             |
| ----------------------- | -------------- | ---------------- |
| **<100 ä¸‡æ•°æ®ï¼Œé«˜ç²¾åº¦** | HNSW (m=32)    | ç²¾åº¦å’Œé€Ÿåº¦éƒ½ä¼˜ç§€ |
| **<100 ä¸‡æ•°æ®ï¼Œé«˜æ€§èƒ½** | HNSW (m=16)    | å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦   |
| **>100 ä¸‡æ•°æ®**         | IVFFlat        | é€‚åˆå¤§è§„æ¨¡æ•°æ®   |
| **>1000 ä¸‡æ•°æ®**        | åˆ†åŒº + IVFFlat | è¶…å¤§è§„æ¨¡ä¼˜åŒ–     |

#### 2.1.4 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. è°ƒæ•´æŸ¥è¯¢æ—¶å‚æ•°
SET hnsw.ef_search = 40;  -- HNSW æœç´¢èŒƒå›´ï¼ˆé»˜è®¤ 40ï¼‰

-- 2. è°ƒæ•´ IVFFlat æ¢æµ‹æ•°
SET ivfflat.probes = 10;  -- IVFFlat æœç´¢èšç±»æ•°ï¼ˆé»˜è®¤ 1ï¼‰

-- 3. ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼ˆå‡å°‘æ•°æ®åº“å¾€è¿”ï¼‰
WITH queries AS (
    SELECT query_vector1::vector as vec, 1 as query_id UNION ALL
    SELECT query_vector2::vector, 2
)
SELECT
    q.query_id,
    d.*,
    d.embedding <=> q.vec as distance
FROM queries q
CROSS JOIN LATERAL (
    SELECT * FROM documents
    ORDER BY embedding <=> q.vec
    LIMIT 10
) d
ORDER BY q.query_id, distance;

-- 4. ä½¿ç”¨è¿æ¥æ± ï¼ˆæé«˜å¹¶å‘æ€§èƒ½ï¼‰
-- é…ç½® PgBouncer æˆ–å…¶ä»–è¿æ¥æ± å·¥å…·
```

### 2.2 ç´¢å¼•æ„å»ºå¤±è´¥

#### 2.2.1 ç—‡çŠ¶æè¿°

**å¸¸è§é”™è¯¯**:

1. **ç´¢å¼•è¡Œå¤§å°è¶…é™**:

   ```text
   ERROR: index row size exceeds maximum
   DETAIL: Maximum size is 2712, but index row size is 3072
   ```

2. **å†…å­˜ä¸è¶³**:

   ```text
   ERROR: out of memory
   DETAIL: Failed on request of size 4294967296
   ```

3. **æ„å»ºè¶…æ—¶**:

   ```text
   ERROR: canceling statement due to statement timeout
   ```

**å¸¸è§åŸå› **:

| åŸå›              | è¯´æ˜     | å½±å“           |
| ---------------- | -------- | -------------- |
| **å‘é‡ç»´åº¦è¿‡é«˜** | >1536 ç»´ | ç´¢å¼•è¡Œå¤§å°è¶…é™ |
| **æ•°æ®é‡è¿‡å¤§**   | >1 äº¿    | å†…å­˜ä¸è¶³       |
| **ç´¢å¼•å‚æ•°è¿‡å¤§** | m > 64   | å†…å­˜å ç”¨è¿‡å¤§   |

#### 2.2.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥å‘é‡ç»´åº¦
SELECT
    table_name,
    column_name,
    data_type,
    udt_name
FROM information_schema.columns
WHERE table_name = 'documents'
  AND column_name = 'embedding';

-- æ­¥éª¤ 2: æ£€æŸ¥æ•°æ®åˆ†å¸ƒ
SELECT
    COUNT(*) as total_rows,
    COUNT(DISTINCT embedding) as unique_vectors,
    pg_size_pretty(pg_total_relation_size('documents')) as table_size
FROM documents;

-- æ­¥éª¤ 3: æ£€æŸ¥å†…å­˜é…ç½®
SELECT
    name,
    setting,
    unit,
    context
FROM pg_settings
WHERE name IN (
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'max_connections'
);

-- æ­¥éª¤ 4: æµ‹è¯•ç´¢å¼•åˆ›å»ºï¼ˆå°æ•°æ®é›†ï¼‰
CREATE TABLE test_documents (
    id SERIAL PRIMARY KEY,
    embedding vector(1536)
);

INSERT INTO test_documents (embedding)
SELECT (SELECT array_agg(random())::vector(1536)
        FROM generate_series(1, 1536))
FROM generate_series(1, 1000);

-- å°è¯•åˆ›å»ºç´¢å¼•
CREATE INDEX test_documents_idx ON test_documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- å¦‚æœæˆåŠŸï¼Œè¯´æ˜é…ç½®æ²¡é—®é¢˜ï¼Œé—®é¢˜åœ¨æ•°æ®è§„æ¨¡æˆ–ç»´åº¦
```

#### 2.2.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: é™ç»´ï¼ˆæ¨èï¼‰
-- ä½¿ç”¨ PCA æˆ–å…¶ä»–é™ç»´æŠ€æœ¯ï¼Œä» 3072 ç»´é™åˆ° 768 ç»´
-- Python ç¤ºä¾‹ï¼š
-- from sklearn.decomposition import PCA
-- pca = PCA(n_components=768)
-- embeddings_768d = pca.fit_transform(embeddings_3072d)

-- æ›´æ–°è¡¨ç»“æ„
ALTER TABLE documents ALTER COLUMN embedding TYPE vector(768);

-- æ–¹æ¡ˆ 2: ä½¿ç”¨ IVFFlatï¼ˆé€‚åˆé«˜ç»´ï¼‰
CREATE INDEX documents_embedding_idx ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (
    lists = 1000  -- æ ¹æ®æ•°æ®é‡è°ƒæ•´
);

-- æ–¹æ¡ˆ 3: å‡å° HNSW å‚æ•°
CREATE INDEX documents_embedding_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 8,               -- å‡å° m å€¼ï¼ˆé»˜è®¤ 16ï¼‰
    ef_construction = 32  -- å‡å° ef_constructionï¼ˆé»˜è®¤ 64ï¼‰
);

-- æ–¹æ¡ˆ 4: åˆ†åŒºè¡¨ + åˆ†åŒºç´¢å¼•
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
) PARTITION BY RANGE (id);

CREATE TABLE documents_p1 PARTITION OF documents
FOR VALUES FROM (1) TO (1000000);

CREATE TABLE documents_p2 PARTITION OF documents
FOR VALUES FROM (1000000) TO (2000000);

-- ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºç´¢å¼•
CREATE INDEX ON documents_p1
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX ON documents_p2
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- æ–¹æ¡ˆ 5: å¢åŠ å†…å­˜é…ç½®
ALTER SYSTEM SET shared_buffers = '8GB';
ALTER SYSTEM SET maintenance_work_mem = '2GB';
SELECT pg_reload_conf();
```

**æ–¹æ¡ˆé€‰æ‹©çŸ©é˜µ**:

| å‘é‡ç»´åº¦  | æ•°æ®é‡       | æ¨èæ–¹æ¡ˆ       | è¯´æ˜         |
| --------- | ------------ | -------------- | ------------ |
| **<768**  | **<100 ä¸‡**  | HNSW (m=16)    | æ ‡å‡†é…ç½®     |
| **<1536** | **<1000 ä¸‡** | IVFFlat        | é€‚åˆä¸­å¤§è§„æ¨¡ |
| **>1536** | **<100 ä¸‡**  | é™ç»´ + HNSW    | å¿…é¡»é™ç»´     |
| **>1536** | **>100 ä¸‡**  | é™ç»´ + IVFFlat | å¿…é¡»é™ç»´     |

## 3. èµ„æºé—®é¢˜

### 3.1 å†…å­˜ä¸è¶³

#### 3.1.1 ç—‡çŠ¶æè¿°

**å¸¸è§ç—‡çŠ¶**:

1. **é”™è¯¯ä¿¡æ¯**:

   ```text
   ERROR: out of memory
   DETAIL: Failed on request of size 4294967296
   ERROR: could not allocate memory for query
   ```

2. **æ€§èƒ½ä¸‹é™**:
   - æŸ¥è¯¢è¶…æ—¶
   - ç´¢å¼•æ„å»ºå¤±è´¥
   - ç³»ç»Ÿå“åº”ç¼“æ…¢

**å†…å­˜ä½¿ç”¨åˆ†æ**:

| æ“ä½œ              | å†…å­˜éœ€æ±‚            | è¯´æ˜         |
| ----------------- | ------------------- | ------------ |
| **HNSW ç´¢å¼•æ„å»º** | æ•°æ®å¤§å° Ã— 2-3 å€   | éœ€è¦è¾ƒå¤§å†…å­˜ |
| **å‘é‡æŸ¥è¯¢**      | æŸ¥è¯¢æ•°é‡ Ã— å‘é‡å¤§å° | ç›¸å¯¹è¾ƒå°     |
| **æ‰¹é‡æ’å…¥**      | æ‰¹æ¬¡å¤§å° Ã— å‘é‡å¤§å° | å¯è°ƒæ•´       |

#### 3.1.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥å†…å­˜é…ç½®
SELECT
    name,
    setting,
    unit,
    context,
    CASE
        WHEN name = 'shared_buffers' AND setting::INTEGER < 1024 THEN 'è­¦å‘Šï¼šå†…å­˜é…ç½®è¿‡ä½'
        WHEN name = 'work_mem' AND setting::INTEGER < 64 THEN 'è­¦å‘Šï¼šå·¥ä½œå†…å­˜ä¸è¶³'
        ELSE 'æ­£å¸¸'
    END as status
FROM pg_settings
WHERE name IN (
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'effective_cache_size',
    'max_connections'
);

-- æ­¥éª¤ 2: æ£€æŸ¥å½“å‰å†…å­˜ä½¿ç”¨
SELECT
    pid,
    usename,
    datname,
    application_name,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- æ­¥éª¤ 3: æ£€æŸ¥ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as table_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 10;

-- æ­¥éª¤ 4: æ£€æŸ¥è¿æ¥æ•°å’Œå†…å­˜è®¡ç®—
SELECT
    setting::INTEGER as max_connections,
    (SELECT COUNT(*) FROM pg_stat_activity) as current_connections,
    (SELECT setting FROM pg_settings WHERE name = 'work_mem')::INTEGER as work_mem_mb,
    (SELECT setting::INTEGER FROM pg_settings WHERE name = 'max_connections') *
    (SELECT setting::INTEGER FROM pg_settings WHERE name = 'work_mem') as max_work_mem_mb
FROM pg_settings
WHERE name = 'max_connections';
```

#### 3.1.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: å¢åŠ å†…å­˜é…ç½®ï¼ˆæ¨èï¼‰
-- ç¼–è¾‘ postgresql.conf æˆ–ä½¿ç”¨ ALTER SYSTEM

ALTER SYSTEM SET shared_buffers = '4GB';  -- æ€»å†…å­˜çš„ 25%
ALTER SYSTEM SET work_mem = '256MB';  -- æ ¹æ® max_connections è°ƒæ•´
ALTER SYSTEM SET maintenance_work_mem = '1GB';  -- ç´¢å¼•æ„å»ºå’Œ VACUUM
ALTER SYSTEM SET effective_cache_size = '12GB';  -- æ€»å†…å­˜çš„ 50-75%

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();

-- æ³¨æ„ï¼šæŸäº›å‚æ•°éœ€è¦é‡å¯ PostgreSQL
SELECT pg_reload_conf();  -- éƒ¨åˆ†å‚æ•°å¯çƒ­é‡è½½
-- systemctl restart postgresql  -- æŸäº›å‚æ•°éœ€é‡å¯

-- æ–¹æ¡ˆ 2: ä½¿ç”¨ IVFFlatï¼ˆå†…å­˜å ç”¨å°ï¼‰
-- IVFFlat ç´¢å¼•å†…å­˜å ç”¨çº¦ä¸º HNSW çš„ 1/3

DROP INDEX IF EXISTS documents_embedding_idx;
CREATE INDEX documents_embedding_idx ON documents
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 1000);

-- æ–¹æ¡ˆ 3: å‡å° HNSW ç´¢å¼•å‚æ•°
DROP INDEX IF EXISTS documents_embedding_idx;
CREATE INDEX documents_embedding_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 8,               -- å‡å° mï¼ˆé»˜è®¤ 16ï¼‰
    ef_construction = 32  -- å‡å° ef_constructionï¼ˆé»˜è®¤ 64ï¼‰
);

-- æ–¹æ¡ˆ 4: åˆ†æ‰¹æ„å»ºç´¢å¼•
-- å¯¹äºè¶…å¤§è§„æ¨¡æ•°æ®ï¼Œåˆ†æ‰¹å¤„ç†

-- åˆ›å»ºä¸´æ—¶è¡¨
CREATE TABLE documents_temp AS
SELECT * FROM documents
WHERE id % 10 = 0;  -- æ¯æ¬¡å¤„ç† 10% æ•°æ®

-- ä¸ºä¸´æ—¶è¡¨åˆ›å»ºç´¢å¼•
CREATE INDEX documents_temp_idx ON documents_temp
USING hnsw (embedding vector_cosine_ops);

-- æ–¹æ¡ˆ 5: å‡å°‘å¹¶å‘è¿æ¥æ•°
ALTER SYSTEM SET max_connections = 100;  -- å‡å°‘æœ€å¤§è¿æ¥æ•°
SELECT pg_reload_conf();

-- æˆ–ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBouncerï¼‰é™åˆ¶è¿æ¥æ•°
```

**å†…å­˜é…ç½®å»ºè®®**:

| æ€»å†…å­˜   | shared_buffers | work_mem | maintenance_work_mem | effective_cache_size |
| -------- | -------------- | -------- | -------------------- | -------------------- |
| **8GB**  | 2GB            | 64MB     | 512MB                | 6GB                  |
| **16GB** | 4GB            | 128MB    | 1GB                  | 12GB                 |
| **32GB** | 8GB            | 256MB    | 2GB                  | 24GB                 |

### 3.2 è¿æ¥æ•°è¶…é™

#### 3.2.1 ç—‡çŠ¶æè¿°

**å¸¸è§é”™è¯¯**:

```text
ERROR: remaining connection slots are reserved
FATAL: too many connections
ERROR: new connection rejected because system limit exceeded
```

**å¸¸è§åŸå› **:

| åŸå›          | è¯´æ˜                     | å½±å“           |
| ------------ | ------------------------ | -------------- |
| **è¿æ¥æ³„æ¼** | åº”ç”¨æœªæ­£ç¡®å…³é—­è¿æ¥       | è¿æ¥æ•°æŒç»­å¢é•¿ |
| **å¹¶å‘è¿‡é«˜** | å®é™…å¹¶å‘è¶…è¿‡é…ç½®         | è¿æ¥æ•°è€—å°½     |
| **é…ç½®è¿‡ä½** | max_connections è®¾ç½®è¿‡å° | æ— æ³•æ»¡è¶³éœ€æ±‚   |

#### 3.2.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥æœ€å¤§è¿æ¥æ•°é…ç½®
SHOW max_connections;

-- æ­¥éª¤ 2: æ£€æŸ¥å½“å‰è¿æ¥æ•°
SELECT
    COUNT(*) as total_connections,
    COUNT(*) FILTER (WHERE state = 'active') as active_connections,
    COUNT(*) FILTER (WHERE state = 'idle') as idle_connections,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction
FROM pg_stat_activity;

-- æ­¥éª¤ 3: æ£€æŸ¥è¿æ¥è¯¦æƒ…
SELECT
    datname,
    usename,
    application_name,
    state,
    state_change,
    wait_event_type,
    wait_event,
    query_start,
    LEFT(query, 100) as query_preview
FROM pg_stat_activity
WHERE datname = 'vector_db'
ORDER BY state_change DESC;

-- æ­¥éª¤ 4: æ£€æŸ¥é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    state,
    state_change,
    NOW() - state_change as idle_duration
FROM pg_stat_activity
WHERE state = 'idle'
  AND state_change < NOW() - INTERVAL '10 minutes'
ORDER BY state_change;

-- æ­¥éª¤ 5: æ£€æŸ¥è¿æ¥æ•°è¶‹åŠ¿ï¼ˆéœ€è¦ç›‘æ§å·¥å…·ï¼‰
-- å¯ä»¥ä½¿ç”¨ pg_stat_statements æˆ–ç›‘æ§ç³»ç»Ÿ
```

#### 3.2.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: å¢åŠ æœ€å¤§è¿æ¥æ•°
ALTER SYSTEM SET max_connections = 200;
SELECT pg_reload_conf();

-- æ³¨æ„ï¼šmax_connections éœ€è¦é‡å¯ PostgreSQL
-- systemctl restart postgresql

-- æ–¹æ¡ˆ 2: æ¸…ç†ç©ºé—²è¿æ¥
-- æ¸…ç†é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = 'vector_db'
  AND state = 'idle'
  AND state_change < NOW() - INTERVAL '10 minutes';

-- æ–¹æ¡ˆ 3: ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBouncerï¼‰ï¼ˆå¼ºçƒˆæ¨èï¼‰
-- é…ç½® PgBouncerï¼Œå‡å°‘æ•°æ®åº“è¿æ¥æ•°

-- PgBouncer é…ç½®ç¤ºä¾‹ï¼ˆpgbouncer.iniï¼‰
-- [databases]
-- vector_db = host=localhost port=5432 dbname=vector_db
--
-- [pgbouncer]
-- pool_mode = transaction
-- max_client_conn = 1000
-- default_pool_size = 25
-- reserve_pool_size = 5

-- æ–¹æ¡ˆ 4: ä¼˜åŒ–åº”ç”¨è¿æ¥ç®¡ç†
-- ä½¿ç”¨è¿æ¥æ± ï¼ŒåŠæ—¶é‡Šæ”¾è¿æ¥
-- Python ç¤ºä¾‹ï¼š
-- from psycopg2 import pool
-- connection_pool = pool.SimpleConnectionPool(5, 20, ...)

-- æ–¹æ¡ˆ 5: ç›‘æ§å’Œå‘Šè­¦
-- è®¾ç½®è¿æ¥æ•°ç›‘æ§å’Œå‘Šè­¦
-- å½“è¿æ¥æ•° > 80% max_connections æ—¶å‘Šè­¦
```

**è¿æ¥æ•°é…ç½®å»ºè®®**:

| åœºæ™¯         | max_connections | è¿æ¥æ±    | è¯´æ˜       |
| ------------ | --------------- | -------- | ---------- |
| **å°å‹åº”ç”¨** | 50              | ä¸éœ€è¦   | ä½å¹¶å‘     |
| **ä¸­å‹åº”ç”¨** | 100             | æ¨è     | ä¸­ç­‰å¹¶å‘   |
| **å¤§å‹åº”ç”¨** | 200             | **å¿…éœ€** | **é«˜å¹¶å‘** |

## 4. æ•°æ®é—®é¢˜

### 4.1 æŸ¥è¯¢ç»“æœä¸å‡†ç¡®

#### 4.1.1 ç—‡çŠ¶æè¿°

**å¸¸è§ç—‡çŠ¶**:

1. **å¬å›ç‡ä½**:

   - æŸ¥è¯¢ç»“æœä¸ç›¸å…³
   - ç›¸å…³æ–‡æ¡£æœªè¢«æ£€ç´¢åˆ°
   - ç»“æœé¡ºåºä¸åˆç†

2. **ç›¸ä¼¼åº¦å¼‚å¸¸**:
   - ç›¸ä¼¼åº¦åˆ†æ•°å¼‚å¸¸
   - æ’åºä¸æ­£ç¡®

**å‡†ç¡®ç‡åŸºå‡†**:

| ç´¢å¼•ç±»å‹                 | å¬å›ç‡    | è¯´æ˜         |
| ------------------------ | --------- | ------------ |
| **HNSW (ef_search=40)**  | **98%**   | æ¥è¿‘ç²¾ç¡®æœç´¢ |
| **HNSW (ef_search=100)** | **99.5%** | é«˜ç²¾åº¦       |
| **IVFFlat (probes=10)**  | **95%**   | ä¸­ç­‰ç²¾åº¦     |
| **IVFFlat (probes=50)**  | **98%**   | é«˜ç²¾åº¦       |

#### 4.1.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥ç´¢å¼•å‚æ•°
SELECT
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'documents'
  AND indexname LIKE '%embedding%';

-- æ­¥éª¤ 2: æ£€æŸ¥æŸ¥è¯¢æ—¶å‚æ•°
SHOW hnsw.ef_search;
SHOW ivfflat.probes;

-- æ­¥éª¤ 3: å¯¹æ¯”ç´¢å¼•æŸ¥è¯¢å’Œç²¾ç¡®æŸ¥è¯¢
-- ä½¿ç”¨ç´¢å¼•ï¼ˆè¿‘ä¼¼æœç´¢ï¼‰
SET hnsw.ef_search = 40;
EXPLAIN ANALYZE
SELECT
    id,
    content,
    1 - (embedding <=> query_vector::vector) as similarity
FROM documents
ORDER BY embedding <=> query_vector::vector
LIMIT 10;

-- ç¦ç”¨ç´¢å¼•ï¼ˆç²¾ç¡®æœç´¢ï¼‰
SET enable_indexscan = off;
EXPLAIN ANALYZE
SELECT
    id,
    content,
    1 - (embedding <=> query_vector::vector) as similarity
FROM documents
ORDER BY embedding <=> query_vector::vector
LIMIT 10;

-- å¯¹æ¯”ç»“æœï¼Œè®¡ç®—å¬å›ç‡

-- æ­¥éª¤ 4: æ£€æŸ¥å‘é‡æ•°æ®è´¨é‡
SELECT
    COUNT(*) as total_vectors,
    COUNT(DISTINCT embedding) as unique_vectors,
    COUNT(*) FILTER (WHERE embedding IS NULL) as null_vectors
FROM documents;
```

#### 4.1.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: æé«˜ HNSW æœç´¢ç²¾åº¦
SET hnsw.ef_search = 100;  -- å¢åŠ æœç´¢èŒƒå›´ï¼ˆé»˜è®¤ 40ï¼‰

-- æ³¨æ„ï¼šef_search è¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œä½†é€Ÿåº¦è¶Šæ…¢

-- æ–¹æ¡ˆ 2: æé«˜ IVFFlat æœç´¢èšç±»æ•°
SET ivfflat.probes = 50;  -- å¢åŠ æœç´¢èšç±»æ•°ï¼ˆé»˜è®¤ 1ï¼‰

-- æ³¨æ„ï¼šprobes è¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œä½†é€Ÿåº¦è¶Šæ…¢

-- æ–¹æ¡ˆ 3: é‡å»ºç´¢å¼•ï¼ˆæé«˜æ„å»ºç²¾åº¦ï¼‰
DROP INDEX documents_embedding_idx;
CREATE INDEX documents_embedding_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 32,              -- æé«˜ m å€¼ï¼ˆé»˜è®¤ 16ï¼‰
    ef_construction = 200  -- æé«˜ ef_constructionï¼ˆé»˜è®¤ 64ï¼‰
);

-- æ–¹æ¡ˆ 4: ä½¿ç”¨ç²¾ç¡®æœç´¢ï¼ˆå°æ•°æ®é›†ï¼‰
-- å¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç²¾ç¡®æœç´¢
SET enable_indexscan = off;

SELECT
    id,
    content,
    1 - (embedding <=> query_vector::vector) as similarity
FROM documents
ORDER BY embedding <=> query_vector::vector
LIMIT 10;

-- æ–¹æ¡ˆ 5: éªŒè¯å‘é‡æ•°æ®è´¨é‡
-- æ£€æŸ¥å‘é‡æ˜¯å¦å½’ä¸€åŒ–
SELECT
    AVG(array_length(embedding::text::numeric[], 1)) as avg_dimensions,
    MIN(array_length(embedding::text::numeric[], 1)) as min_dimensions,
    MAX(array_length(embedding::text::numeric[], 1)) as max_dimensions
FROM documents
LIMIT 1000;
```

**ç²¾åº¦ä¼˜åŒ–å»ºè®®**:

| åœºæ™¯           | æ¨èé…ç½®             | å¬å›ç‡    | æŸ¥è¯¢å»¶è¿Ÿ |
| -------------- | -------------------- | --------- | -------- |
| **é«˜ç²¾åº¦éœ€æ±‚** | HNSW (ef_search=100) | **99.5%** | ~20ms    |
| **å¹³è¡¡éœ€æ±‚**   | HNSW (ef_search=40)  | **98%**   | ~10ms    |
| **é«˜æ€§èƒ½éœ€æ±‚** | HNSW (ef_search=20)  | **95%**   | ~5ms     |

### 4.2 æ•°æ®ä¸ä¸€è‡´

#### 4.2.1 ç—‡çŠ¶æè¿°

**å¸¸è§ç—‡çŠ¶**:

1. **ç»Ÿè®¡ä¿¡æ¯ä¸ä¸€è‡´**:

   - `COUNT(*)` ç»“æœå¼‚å¸¸
   - ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
   - æŸ¥è¯¢ç»“æœæ•°é‡ä¸åŒ¹é…

2. **æ•°æ®ä¸ä¸€è‡´**:
   - æ­»å…ƒç»„è¿‡å¤š
   - ç´¢å¼•ä¸å®é™…æ•°æ®ä¸ç¬¦
   - æŸ¥è¯¢ç»“æœé‡å¤

**å¸¸è§åŸå› **:

| åŸå›                 | è¯´æ˜               | å½±å“         |
| ------------------- | ------------------ | ------------ |
| **é•¿æ—¶é—´æœª VACUUM** | æ­»å…ƒç»„ç§¯ç´¯         | æŸ¥è¯¢æ€§èƒ½ä¸‹é™ |
| **ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ**    | é•¿æ—¶é—´æœª ANALYZE   | æŸ¥è¯¢è®¡åˆ’ä¸ä¼˜ |
| **ç´¢å¼•æŸå**        | ç´¢å¼•ä¸å®é™…æ•°æ®ä¸ç¬¦ | æŸ¥è¯¢ç»“æœé”™è¯¯ |

#### 4.2.2 è¯Šæ–­æ­¥éª¤

**è¯Šæ–­æ­¥éª¤**:

```sql
-- æ­¥éª¤ 1: æ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup as live_tuples,
    n_dead_tup as dead_tuples,
    (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) * 100 as dead_tuple_ratio,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
WHERE tablename = 'documents';

-- æ­¥éª¤ 2: æ£€æŸ¥æ­»å…ƒç»„æ¯”ä¾‹
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) * 100 as dead_ratio,
    CASE
        WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.2 THEN 'ç´§æ€¥ VACUUM'
        WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.1 THEN 'å»ºè®® VACUUM'
        ELSE 'æ­£å¸¸'
    END as recommendation
FROM pg_stat_user_tables
WHERE tablename = 'documents';

-- æ­¥éª¤ 3: æ£€æŸ¥ç´¢å¼•å¥åº·åº¦
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE tablename = 'documents';

-- æ­¥éª¤ 4: å¯¹æ¯”å®é™…æ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯
SELECT
    COUNT(*) as actual_count
FROM documents;

-- å¯¹æ¯” pg_stat_user_tables ä¸­çš„ n_live_tup
```

#### 4.2.3 è§£å†³æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆè¯¦è§£**:

```sql
-- æ–¹æ¡ˆ 1: æ‰§è¡Œ VACUUM ANALYZEï¼ˆæ¨èï¼‰
VACUUM ANALYZE documents;

-- VACUUM: æ¸…ç†æ­»å…ƒç»„ï¼Œå›æ”¶ç©ºé—´
-- ANALYZE: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’

-- æ–¹æ¡ˆ 2: å¹¶å‘ VACUUMï¼ˆä¸é”è¡¨ï¼‰
VACUUM ANALYZE documents;

-- PostgreSQL 13+ æ”¯æŒ VACUUM ANALYZE çš„å¹¶å‘ç‰ˆæœ¬
-- ä¸ä¼šé˜»å¡æŸ¥è¯¢

-- æ–¹æ¡ˆ 3: é‡å»ºç´¢å¼•
REINDEX INDEX CONCURRENTLY documents_embedding_idx;

-- CONCURRENTLY: åœ¨çº¿é‡å»ºï¼Œä¸é˜»å¡æŸ¥è¯¢
-- é€‚ç”¨äºç´¢å¼•æŸåæˆ–ç»Ÿè®¡ä¿¡æ¯å¼‚å¸¸

-- æ–¹æ¡ˆ 4: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE documents;

-- ä»…æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸æ¸…ç†æ­»å…ƒç»„
-- æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œé€‚åˆé¢‘ç¹æ‰§è¡Œ

-- æ–¹æ¡ˆ 5: é…ç½®è‡ªåŠ¨ VACUUM
ALTER TABLE documents SET (
    autovacuum_vacuum_scale_factor = 0.1,  -- æ­»å…ƒç»„ >10% æ—¶è§¦å‘
    autovacuum_analyze_scale_factor = 0.05,  -- å˜æ›´ >5% æ—¶è§¦å‘
    autovacuum_vacuum_cost_delay = 10,  -- å»¶è¿Ÿ 10msï¼ˆå‡å°‘ I/O å½±å“ï¼‰
    autovacuum_vacuum_cost_limit = 200  -- æ¯æ¬¡å¤„ç†æˆæœ¬é™åˆ¶
);

-- å…¨å±€é…ç½®ï¼ˆpostgresql.confï¼‰
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
```

**VACUUM ç­–ç•¥å»ºè®®**:

| æ­»å…ƒç»„æ¯”ä¾‹ | æ“ä½œ            | é¢‘ç‡             |
| ---------- | --------------- | ---------------- |
| **>20%**   | **ç´§æ€¥ VACUUM** | ç«‹å³æ‰§è¡Œ         |
| **>10%**   | **å»ºè®® VACUUM** | å°½å¿«æ‰§è¡Œ         |
| **<10%**   | **æ­£å¸¸**        | è‡ªåŠ¨ VACUUM å¤„ç† |

## 5. æ‰©å±•é—®é¢˜

### 5.1 pgvector æ‰©å±•é—®é¢˜

**å¸¸è§é—®é¢˜**:

```sql
-- é—®é¢˜ 1: æ‰©å±•æœªæ‰¾åˆ°
ERROR: extension "vector" does not exist

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. æ£€æŸ¥æ‰©å±•æ˜¯å¦å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- 2. å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å®‰è£… pgvector
-- Ubuntu/Debian:
-- sudo apt-get install postgresql-18-pgvector
-- æˆ–ä»æºç å®‰è£…

-- é—®é¢˜ 2: ç‰ˆæœ¬ä¸å…¼å®¹
ERROR: incompatible extension version

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. æ£€æŸ¥ PostgreSQL ç‰ˆæœ¬
SELECT version();

-- 2. æ£€æŸ¥ pgvector ç‰ˆæœ¬
SELECT extversion FROM pg_extension WHERE extname = 'vector';

-- 3. å‡çº§ pgvector åˆ°å…¼å®¹ç‰ˆæœ¬

-- é—®é¢˜ 3: å‘é‡ç»´åº¦ä¸åŒ¹é…
ERROR: operator does not exist: vector(768) <=> vector(1536)

-- è§£å†³æ–¹æ¡ˆï¼š
-- ç¡®ä¿æ‰€æœ‰å‘é‡ä½¿ç”¨ç›¸åŒç»´åº¦
ALTER TABLE documents ALTER COLUMN embedding TYPE vector(1536);
```

### 5.2 TimescaleDB æ‰©å±•é—®é¢˜

**å¸¸è§é—®é¢˜**:

```sql
-- é—®é¢˜ 1: TimescaleDB æ‰©å±•æœªåŠ è½½
ERROR: could not access file "$libdir/timescaledb-2.11"

-- è§£å†³æ–¹æ¡ˆï¼š
-- 1. æ£€æŸ¥ TimescaleDB æ˜¯å¦å®‰è£…
SELECT * FROM pg_available_extensions WHERE name = 'timescaledb';

-- 2. é‡æ–°é…ç½® TimescaleDB
-- sudo timescaledb-tune --quiet --yes
-- sudo systemctl restart postgresql

-- é—®é¢˜ 2: è¶…è¡¨åˆ›å»ºå¤±è´¥
ERROR: hypertable does not exist

-- è§£å†³æ–¹æ¡ˆï¼š
-- ç¡®ä¿è¡¨å­˜åœ¨ä¸”ç¬¦åˆè¶…è¡¨è¦æ±‚
SELECT create_hypertable('table_name', 'time_column');
```

## 6. è¯Šæ–­å·¥å…·

### 6.1 æ€§èƒ½è¯Šæ–­è„šæœ¬

**æ€§èƒ½è¯Šæ–­å‡½æ•°**:

```sql
-- åˆ›å»ºç»¼åˆè¯Šæ–­å‡½æ•°
CREATE OR REPLACE FUNCTION diagnose_vector_performance(
    p_table_name TEXT DEFAULT 'documents'
)
RETURNS TABLE (
    check_item TEXT,
    status TEXT,
    details TEXT,
    recommendation TEXT
) AS $$
BEGIN
    -- 1. æ£€æŸ¥ç´¢å¼•
    RETURN QUERY
    SELECT
        'ç´¢å¼•æ£€æŸ¥'::TEXT,
        CASE WHEN COUNT(*) > 0 THEN 'æ­£å¸¸' ELSE 'ç¼ºå¤±' END,
        COALESCE(STRING_AGG(indexname, ', '), 'æ— å‘é‡ç´¢å¼•'),
        CASE
            WHEN COUNT(*) = 0 THEN 'åˆ›å»º HNSW æˆ– IVFFlat ç´¢å¼•'
            ELSE 'ç´¢å¼•å­˜åœ¨ï¼Œæ£€æŸ¥å‚æ•°'
        END
    FROM pg_indexes
    WHERE tablename = p_table_name
      AND indexdef LIKE '%vector%';

    -- 2. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
    RETURN QUERY
    SELECT
        'ç»Ÿè®¡ä¿¡æ¯'::TEXT,
        CASE
            WHEN last_autovacuum > NOW() - INTERVAL '7 days' THEN 'æ­£å¸¸'
            WHEN last_autovacuum > NOW() - INTERVAL '30 days' THEN 'éœ€è¦æ›´æ–°'
            ELSE 'ä¸¥é‡è¿‡æœŸ'
        END,
        COALESCE(last_autovacuum::TEXT, 'ä»æœªæ‰§è¡Œ'),
        CASE
            WHEN last_autovacuum IS NULL OR last_autovacuum < NOW() - INTERVAL '7 days'
            THEN 'æ‰§è¡Œ VACUUM ANALYZE ' || p_table_name
            ELSE 'ç»Ÿè®¡ä¿¡æ¯æ­£å¸¸'
        END
    FROM pg_stat_user_tables
    WHERE tablename = p_table_name;

    -- 3. æ£€æŸ¥å†…å­˜é…ç½®
    RETURN QUERY
    SELECT
        'å†…å­˜é…ç½®'::TEXT,
        CASE
            WHEN setting::INTEGER >= 4096 THEN 'å……è¶³'
            WHEN setting::INTEGER >= 2048 THEN 'ä¸€èˆ¬'
            ELSE 'ä¸è¶³'
        END,
        setting || ' ' || unit,
        CASE
            WHEN setting::INTEGER < 2048 THEN 'å»ºè®®å¢åŠ  shared_buffers åˆ° 4GB+'
            ELSE 'å†…å­˜é…ç½®æ­£å¸¸'
        END
    FROM pg_settings
    WHERE name = 'shared_buffers';

    -- 4. æ£€æŸ¥è¿æ¥æ•°
    RETURN QUERY
    SELECT
        'è¿æ¥æ•°æ£€æŸ¥'::TEXT,
        CASE
            WHEN (SELECT COUNT(*) FROM pg_stat_activity)::NUMERIC /
                 (SELECT setting::NUMERIC FROM pg_settings WHERE name = 'max_connections') > 0.8
            THEN 'è­¦å‘Š'
            ELSE 'æ­£å¸¸'
        END,
        (SELECT COUNT(*) FROM pg_stat_activity)::TEXT || ' / ' ||
        (SELECT setting FROM pg_settings WHERE name = 'max_connections'),
        CASE
            WHEN (SELECT COUNT(*) FROM pg_stat_activity)::NUMERIC /
                 (SELECT setting::NUMERIC FROM pg_settings WHERE name = 'max_connections') > 0.8
            THEN 'è€ƒè™‘ä½¿ç”¨è¿æ¥æ± æˆ–å¢åŠ  max_connections'
            ELSE 'è¿æ¥æ•°æ­£å¸¸'
        END
    FROM pg_settings
    WHERE name = 'max_connections'
    LIMIT 1;

    -- 5. æ£€æŸ¥æ­»å…ƒç»„
    RETURN QUERY
    SELECT
        'æ­»å…ƒç»„æ£€æŸ¥'::TEXT,
        CASE
            WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.2 THEN 'ä¸¥é‡'
            WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.1 THEN 'è­¦å‘Š'
            ELSE 'æ­£å¸¸'
        END,
        n_dead_tup::TEXT || ' / ' || (n_live_tup + n_dead_tup)::TEXT ||
        ' (' || ROUND((n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) * 100, 2) || '%)',
        CASE
            WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.2
            THEN 'ç´§æ€¥æ‰§è¡Œ VACUUM ANALYZE ' || p_table_name
            WHEN (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) > 0.1
            THEN 'å»ºè®®æ‰§è¡Œ VACUUM ANALYZE ' || p_table_name
            ELSE 'æ­»å…ƒç»„æ¯”ä¾‹æ­£å¸¸'
        END
    FROM pg_stat_user_tables
    WHERE tablename = p_table_name;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨è¯Šæ–­å‡½æ•°
SELECT * FROM diagnose_vector_performance('documents');
```

### 6.2 ç›‘æ§æŸ¥è¯¢

**ç›‘æ§æŸ¥è¯¢é›†åˆ**:

```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT
    LEFT(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (shared_blks_hit::float / NULLIF(shared_blks_hit + shared_blks_read, 0)) * 100 as cache_hit_rate,
    CASE
        WHEN mean_exec_time > 1000 THEN 'ä¸¥é‡'
        WHEN mean_exec_time > 500 THEN 'è­¦å‘Š'
        WHEN mean_exec_time > 100 THEN 'æ³¨æ„'
        ELSE 'æ­£å¸¸'
    END as severity
FROM pg_stat_statements
WHERE query LIKE '%<=>%' OR query LIKE '%<->%' OR query LIKE '%<#%'
ORDER BY mean_exec_time DESC
LIMIT 20;

-- ç´¢å¼•ä½¿ç”¨ç›‘æ§
SELECT
    tablename,
    indexname,
    idx_scan as scan_count,
    idx_tup_read as tuples_read,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size,
    CASE
        WHEN idx_scan = 0 THEN 'æœªä½¿ç”¨ - è€ƒè™‘åˆ é™¤'
        WHEN idx_scan < 10 THEN 'ä½ä½¿ç”¨ - ç›‘æ§'
        ELSE 'æ­£å¸¸ä½¿ç”¨'
    END as usage_status
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan;
```

### 6.3 è‡ªåŠ¨åŒ–è¯Šæ–­

**Python è‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬**:

```python
# diagnose.py
import psycopg2
from psycopg2.extras import RealDictCursor
import sys

def diagnose_database(conn_params):
    """è‡ªåŠ¨åŒ–è¯Šæ–­"""
    conn = psycopg2.connect(**conn_params)
    cur = conn.cursor(cursor_factory=RealDictCursor)

    issues = []

    # 1. æ£€æŸ¥ç´¢å¼•
    cur.execute("""
        SELECT COUNT(*) as index_count
        FROM pg_indexes
        WHERE tablename = 'documents'
          AND indexdef LIKE '%vector%'
    """)
    if cur.fetchone()['index_count'] == 0:
        issues.append({
            'severity': 'CRITICAL',
            'issue': 'ç¼ºå°‘å‘é‡ç´¢å¼•',
            'recommendation': 'åˆ›å»º HNSW æˆ– IVFFlat ç´¢å¼•'
        })

    # 2. æ£€æŸ¥æ­»å…ƒç»„
    cur.execute("""
        SELECT
            n_dead_tup,
            n_live_tup,
            (n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0)) * 100 as dead_ratio
        FROM pg_stat_user_tables
        WHERE tablename = 'documents'
    """)
    row = cur.fetchone()
    if row and row['dead_ratio'] > 20:
        issues.append({
            'severity': 'WARNING',
            'issue': f"æ­»å…ƒç»„æ¯”ä¾‹è¿‡é«˜: {row['dead_ratio']:.2f}%",
            'recommendation': 'æ‰§è¡Œ VACUUM ANALYZE documents'
        })

    # 3. æ£€æŸ¥è¿æ¥æ•°
    cur.execute("""
        SELECT
            (SELECT COUNT(*) FROM pg_stat_activity)::NUMERIC as current,
            (SELECT setting::NUMERIC FROM pg_settings WHERE name = 'max_connections') as max_conn
    """)
    row = cur.fetchone()
    if row and row['current'] / row['max_conn'] > 0.8:
        issues.append({
            'severity': 'WARNING',
            'issue': f"è¿æ¥æ•°æ¥è¿‘ä¸Šé™: {row['current']}/{row['max_conn']}",
            'recommendation': 'è€ƒè™‘ä½¿ç”¨è¿æ¥æ± æˆ–å¢åŠ  max_connections'
        })

    # è¾“å‡ºè¯Šæ–­ç»“æœ
    if issues:
        print("å‘ç°é—®é¢˜:")
        for issue in issues:
            print(f"  [{issue['severity']}] {issue['issue']}")
            print(f"    å»ºè®®: {issue['recommendation']}")
        return False
    else:
        print("âœ… æœªå‘ç°é—®é¢˜")
        return True

if __name__ == "__main__":
    conn_params = {
        'host': 'localhost',
        'port': 5432,
        'user': 'postgres',
        'password': 'postgres',
        'database': 'vector_db'
    }
    diagnose_database(conn_params)
```

## 7. æœ€ä½³å®è·µ

### 7.1 é¢„é˜²æªæ–½

**é¢„é˜²æªæ–½æ¸…å•**:

1. **å®šæœŸç›‘æ§**:

   - æ¯å¤©æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
   - æ¯å‘¨æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
   - æ¯æœˆæ£€æŸ¥ç»Ÿè®¡æ•°æ®

2. **å®šæœŸç»´æŠ¤**:

   - æ¯å¤©æ‰§è¡Œ ANALYZE
   - æ¯å‘¨æ‰§è¡Œ VACUUM ANALYZE
   - æ¯æœˆæ£€æŸ¥ç´¢å¼•æ•ˆç‡

3. **é…ç½®ä¼˜åŒ–**:
   - åˆç†é…ç½®å†…å­˜å‚æ•°
   - ä½¿ç”¨è¿æ¥æ± 
   - å¯ç”¨è‡ªåŠ¨ VACUUM

### 7.2 æ•…éšœå“åº”

**æ•…éšœå“åº”æµç¨‹**:

1. **é—®é¢˜æŠ¥å‘Š**: è®°å½•é—®é¢˜ç—‡çŠ¶å’Œé”™è¯¯ä¿¡æ¯
2. **å¿«é€Ÿè¯Šæ–­**: ä½¿ç”¨è¯Šæ–­å·¥å…·å¿«é€Ÿå®šä½é—®é¢˜
3. **è§£å†³æ–¹æ¡ˆ**: é€‰æ‹©åˆé€‚çš„è§£å†³æ–¹æ¡ˆ
4. **éªŒè¯ä¿®å¤**: ç¡®è®¤é—®é¢˜å·²è§£å†³
5. **æ€»ç»“è®°å½•**: è®°å½•é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQL æ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/performance-tips.html) - Performance
  Tips
- [pgvector æ•…éšœæ’æŸ¥](https://github.com/pgvector/pgvector#troubleshooting) - pgvector
  Troubleshooting

### 8.2 æŠ€æœ¯æ–‡æ¡£

- [æ€§èƒ½è°ƒä¼˜æŠ€å·§](../../01-å‘é‡ä¸æ··åˆæœç´¢/æœ€ä½³å®è·µ/æ€§èƒ½è°ƒä¼˜æŠ€å·§.md) - Performance Tuning
- [ç›‘æ§ä¸å‘Šè­¦](../è¿ç»´æ‰‹å†Œ/ç›‘æ§ä¸å‘Šè­¦.md) - Monitoring and Alerting

### 8.3 ç›¸å…³èµ„æº

- [PostgreSQL æ•…éšœæ’æŸ¥æŒ‡å—](https://www.postgresql.org/docs/current/maintenance.html) - Maintenance
- [pg_stat_statements æ–‡æ¡£](https://www.postgresql.org/docs/current/pgstatstatements.html) -
  pg_stat_statements

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team  
**æ–‡æ¡£ç¼–å·**: 09-03-01
