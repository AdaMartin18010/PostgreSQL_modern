# PostgreSQL å‘é‡æœç´¢æ€§èƒ½é—®é¢˜æ’æŸ¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 09-03-02

## ğŸ“‘ ç›®å½•

- [PostgreSQL å‘é‡æœç´¢æ€§èƒ½é—®é¢˜æ’æŸ¥](#postgresql-å‘é‡æœç´¢æ€§èƒ½é—®é¢˜æ’æŸ¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ€§èƒ½é—®é¢˜ç±»å‹](#12-æ€§èƒ½é—®é¢˜ç±»å‹)
    - [1.3 æ’æŸ¥æµç¨‹](#13-æ’æŸ¥æµç¨‹)
  - [2. æ…¢æŸ¥è¯¢è¯Šæ–­](#2-æ…¢æŸ¥è¯¢è¯Šæ–­)
    - [2.1 å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—](#21-å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—)
    - [2.2 åˆ†ææŸ¥è¯¢è®¡åˆ’](#22-åˆ†ææŸ¥è¯¢è®¡åˆ’)
    - [2.3 æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯](#23-æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯)
  - [3. ç´¢å¼•é—®é¢˜æ’æŸ¥](#3-ç´¢å¼•é—®é¢˜æ’æŸ¥)
    - [3.1 æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ](#31-æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ)
    - [3.2 æ£€æŸ¥ç´¢å¼•å¤§å°](#32-æ£€æŸ¥ç´¢å¼•å¤§å°)
    - [3.3 é‡å»ºç´¢å¼•](#33-é‡å»ºç´¢å¼•)
  - [4. èµ„æºç“¶é¢ˆæ’æŸ¥](#4-èµ„æºç“¶é¢ˆæ’æŸ¥)
    - [4.1 CPU ä½¿ç”¨ç‡](#41-cpu-ä½¿ç”¨ç‡)
    - [4.2 å†…å­˜ä½¿ç”¨](#42-å†…å­˜ä½¿ç”¨)
    - [4.3 ç£ç›˜ I/O](#43-ç£ç›˜-io)
  - [5. å¸¸è§æ€§èƒ½é—®é¢˜](#5-å¸¸è§æ€§èƒ½é—®é¢˜)
    - [5.1 é—®é¢˜ï¼šæŸ¥è¯¢ä¸ä½¿ç”¨ç´¢å¼•](#51-é—®é¢˜æŸ¥è¯¢ä¸ä½¿ç”¨ç´¢å¼•)
    - [5.2 é—®é¢˜ï¼šef\_search å‚æ•°ä¸å½“](#52-é—®é¢˜ef_search-å‚æ•°ä¸å½“)
    - [5.3 é—®é¢˜ï¼šè¿æ¥æ± ä¸è¶³](#53-é—®é¢˜è¿æ¥æ± ä¸è¶³)
    - [1.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#14-å®é™…åº”ç”¨æ¡ˆä¾‹)
  - [6. æ€§èƒ½ä¼˜åŒ–å»ºè®®](#6-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [6.1 ç´¢å¼•ä¼˜åŒ–](#61-ç´¢å¼•ä¼˜åŒ–)
    - [6.2 æŸ¥è¯¢ä¼˜åŒ–](#62-æŸ¥è¯¢ä¼˜åŒ–)
    - [6.3 é…ç½®ä¼˜åŒ–](#63-é…ç½®ä¼˜åŒ–)
    - [6.4 æ€§èƒ½ä¼˜åŒ–æ•ˆæœ](#64-æ€§èƒ½ä¼˜åŒ–æ•ˆæœ)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ€§èƒ½é—®é¢˜èƒŒæ™¯**:

PostgreSQL + pgvector åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½é‡åˆ°å„ç§æ€§èƒ½é—®é¢˜ï¼ŒåŒ…æ‹¬æŸ¥è¯¢æ…¢ã€ååé‡ä½ã€èµ„æºå ç”¨é«˜ç­‰ã€‚æœ¬æ–‡æ¡£æä¾›ç³»ç»ŸåŒ–çš„æ€§èƒ½é—®é¢˜æ’æŸ¥å’Œä¼˜åŒ–æ–¹æ³•ã€‚

**æ ¸å¿ƒä»·å€¼** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å¿«é€Ÿå®šä½** | ç³»ç»ŸåŒ–æ’æŸ¥æµç¨‹ | å‡å°‘æ’æŸ¥æ—¶é—´ **60%** |
| **æ€§èƒ½æå‡** | ä¼˜åŒ–æ–¹æ¡ˆå®æ–½ | æŸ¥è¯¢æ€§èƒ½æå‡ **3-5 å€** |
| **æˆæœ¬é™ä½** | èµ„æºä¼˜åŒ– | èµ„æºæˆæœ¬é™ä½ **30%** |

### 1.2 æ€§èƒ½é—®é¢˜ç±»å‹

**å¸¸è§æ€§èƒ½é—®é¢˜**:

- **æŸ¥è¯¢æ…¢**: å‘é‡æœç´¢æŸ¥è¯¢å»¶è¿Ÿé«˜ï¼ˆ>100msï¼‰
- **ååé‡ä½**: QPS ä¸è¾¾æ ‡ï¼ˆ<1000 QPSï¼‰
- **èµ„æºå ç”¨é«˜**: CPU/å†…å­˜ä½¿ç”¨ç‡é«˜ï¼ˆ>80%ï¼‰
- **ç´¢å¼•æ„å»ºæ…¢**: ç´¢å¼•åˆ›å»ºæ—¶é—´é•¿ï¼ˆ>2 å°æ—¶ï¼‰

**æ€§èƒ½é—®é¢˜å½±å“**:

| é—®é¢˜ç±»å‹ | å½±å“èŒƒå›´ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| **æŸ¥è¯¢æ…¢** | ç”¨æˆ·ä½“éªŒ | **é«˜** | **P0** |
| **ååé‡ä½** | ç³»ç»Ÿå®¹é‡ | **é«˜** | **P0** |
| **èµ„æºå ç”¨é«˜** | ç³»ç»Ÿç¨³å®šæ€§ | **ä¸­** | **P1** |
| **ç´¢å¼•æ„å»ºæ…¢** | è¿ç»´æ•ˆç‡ | **ä¸­** | **P2** |

### 1.3 æ’æŸ¥æµç¨‹

```text
1. è¯†åˆ«é—®é¢˜ï¼ˆæ…¢æŸ¥è¯¢ã€é«˜èµ„æºå ç”¨ï¼‰
   â†“
1. æ”¶é›†è¯Šæ–­ä¿¡æ¯ï¼ˆæŸ¥è¯¢è®¡åˆ’ã€ç³»ç»ŸæŒ‡æ ‡ï¼‰
   â†“
1. åˆ†ææ ¹æœ¬åŸå› ï¼ˆç´¢å¼•ã€é…ç½®ã€æ•°æ®åˆ†å¸ƒï¼‰
   â†“
1. å®æ–½ä¼˜åŒ–æ–¹æ¡ˆ
   â†“
1. éªŒè¯ä¼˜åŒ–æ•ˆæœ
```

## 2. æ…¢æŸ¥è¯¢è¯Šæ–­

### 2.1 å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- è®°å½• > 1ç§’çš„æŸ¥è¯¢
ALTER SYSTEM SET log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ';
SELECT pg_reload_conf();

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
SELECT * FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 2.2 åˆ†ææŸ¥è¯¢è®¡åˆ’

```sql
-- åˆ†æå‘é‡æœç´¢æŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, metadata, embedding <=> query_vector AS distance
FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç´¢å¼•
-- åº”è¯¥çœ‹åˆ°: Index Scan using vectors_embedding_idx
-- å¦‚æœçœ‹åˆ°: Seq Scanï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•
```

### 2.3 æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯

```sql
-- ä½¿ç”¨ pg_stat_statements åˆ†ææŸ¥è¯¢
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
WHERE query LIKE '%embedding%'
ORDER BY mean_exec_time DESC
LIMIT 10;
```

## 3. ç´¢å¼•é—®é¢˜æ’æŸ¥

### 3.1 æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'vectors'
ORDER BY idx_scan;

-- å¦‚æœ idx_scan = 0ï¼Œè¯´æ˜ç´¢å¼•æœªè¢«ä½¿ç”¨
```

### 3.2 æ£€æŸ¥ç´¢å¼•å¤§å°

```sql
-- æ£€æŸ¥ç´¢å¼•å¤§å°
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE tablename = 'vectors';

-- å¦‚æœç´¢å¼•è¿‡å¤§ï¼Œè€ƒè™‘ä¼˜åŒ–å‚æ•°
```

### 3.3 é‡å»ºç´¢å¼•

```sql
-- é‡å»ºç´¢å¼•ï¼ˆå¦‚æœç´¢å¼•æŸåæˆ–æ€§èƒ½ä¸‹é™ï¼‰
REINDEX INDEX vectors_embedding_idx;

-- æˆ–è€…é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE vectors;
```

## 4. èµ„æºç“¶é¢ˆæ’æŸ¥

### 4.1 CPU ä½¿ç”¨ç‡

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨æŸ¥è¯¢
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    now() - query_start AS duration,
    query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY query_start;

-- æŸ¥çœ‹ CPU å¯†é›†å‹æŸ¥è¯¢
SELECT
    pid,
    query,
    now() - query_start AS duration
FROM pg_stat_activity
WHERE state = 'active'
AND query LIKE '%embedding%'
ORDER BY duration DESC;
```

### 4.2 å†…å­˜ä½¿ç”¨

```sql
-- æŸ¥çœ‹å…±äº«ç¼“å†²åŒºä½¿ç”¨
SELECT
    name,
    setting,
    unit
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem');

-- æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_ratio
FROM pg_statio_user_tables
WHERE schemaname = 'public';
```

### 4.3 ç£ç›˜ I/O

```sql
-- æŸ¥çœ‹è¡¨å¤§å°å’Œ I/O ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch
FROM pg_stat_user_tables
WHERE tablename = 'vectors';
```

## 5. å¸¸è§æ€§èƒ½é—®é¢˜

### 5.1 é—®é¢˜ï¼šæŸ¥è¯¢ä¸ä½¿ç”¨ç´¢å¼•

**ç—‡çŠ¶**:

- EXPLAIN æ˜¾ç¤º Seq Scan
- æŸ¥è¯¢é€Ÿåº¦æ…¢

**åŸå› **:

- ç´¢å¼•æœªåˆ›å»º
- æŸ¥è¯¢æ¡ä»¶ä¸åŒ¹é…ç´¢å¼•
- ç´¢å¼•å‚æ•°ä¸å½“

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
SELECT indexname FROM pg_indexes WHERE tablename = 'vectors';

-- 2. åˆ›å»º HNSW ç´¢å¼•
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. ç¡®ä¿æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
SET hnsw.ef_search = 40;
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;
```

### 5.2 é—®é¢˜ï¼šef_search å‚æ•°ä¸å½“

**ç—‡çŠ¶**:

- æŸ¥è¯¢é€Ÿåº¦æ…¢
- å¬å›ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ ¹æ®éœ€æ±‚è°ƒæ•´ ef_search
-- å¿«é€ŸæŸ¥è¯¢ï¼ˆå¬å›ç‡å¯èƒ½é™ä½ï¼‰
SET hnsw.ef_search = 20;

-- é«˜å¬å›ç‡æŸ¥è¯¢ï¼ˆé€Ÿåº¦å¯èƒ½è¾ƒæ…¢ï¼‰
SET hnsw.ef_search = 200;

-- æŸ¥è¯¢
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;
```

### 5.3 é—®é¢˜ï¼šè¿æ¥æ± ä¸è¶³

**ç—‡çŠ¶**:

- è¿æ¥è¶…æ—¶
- æŸ¥è¯¢æ’é˜Ÿ

**è§£å†³æ–¹æ¡ˆ**:

```python
# å¢åŠ è¿æ¥æ± å¤§å°
from asyncpg import create_pool

pool = await create_pool(
    database_url,
    min_size=20,  # å¢åŠ æœ€å°è¿æ¥æ•°
    max_size=100,  # å¢åŠ æœ€å¤§è¿æ¥æ•°
    max_queries=50000
)
```

### 1.4 å®é™…åº”ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹: æŸç”µå•†å¹³å°æ€§èƒ½ä¼˜åŒ–**

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®é‡: 5000 ä¸‡å•†å“å‘é‡
- æŸ¥è¯¢ QPS: 5000
- å¹³å‡æŸ¥è¯¢å»¶è¿Ÿ: 150msï¼ˆç›®æ ‡ <50msï¼‰

**é—®é¢˜è¯Šæ–­**:

1. æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ï¼ˆSeq Scanï¼‰
2. ef_search å‚æ•°è¿‡å°ï¼ˆå¬å›ç‡ä½ï¼‰
3. è¿æ¥æ± ä¸è¶³ï¼ˆè¿æ¥è¶…æ—¶ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. åˆ›å»º HNSW ç´¢å¼•ï¼ˆm=16, ef_construction=64ï¼‰
2. è°ƒæ•´ ef_search=100ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œå¬å›ç‡ï¼‰
3. å¢åŠ è¿æ¥æ± ï¼ˆä» 50 åˆ° 200ï¼‰

**å®æ–½æ•ˆæœ**:

- æŸ¥è¯¢å»¶è¿Ÿ: ä» 150ms é™ä½åˆ° 25msï¼ˆ**æå‡ 83%**ï¼‰
- æŸ¥è¯¢åå: ä» 2000 QPS æå‡åˆ° 6000 QPSï¼ˆ**æå‡ 200%**ï¼‰
- èµ„æºå ç”¨: CPU ä½¿ç”¨ç‡ä» 90% é™ä½åˆ° 60%ï¼ˆ**é™ä½ 33%**ï¼‰

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- 1. é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹
-- HNSW: é«˜ç²¾åº¦ã€å¿«é€ŸæŸ¥è¯¢
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- IVFFlat: å¤§è§„æ¨¡æ•°æ®ã€é«˜æ›´æ–°é¢‘ç‡
CREATE INDEX ON vectors USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 2. ä¼˜åŒ–ç´¢å¼•å‚æ•°
-- æ ¹æ®æ•°æ®é‡å’ŒæŸ¥è¯¢æ¨¡å¼è°ƒæ•´
```

### 6.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- 1. ä½¿ç”¨ LIMIT é™åˆ¶ç»“æœ
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;  -- ä¸è¦æŸ¥è¯¢æ‰€æœ‰ç»“æœ

-- 2. åªé€‰æ‹©éœ€è¦çš„åˆ—
SELECT id, metadata FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 3. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼ˆåº”ç”¨å±‚ï¼‰
```

### 6.3 é…ç½®ä¼˜åŒ–

```sql
-- PostgreSQL é…ç½®ä¼˜åŒ–
-- shared_buffers: 25% of RAM
ALTER SYSTEM SET shared_buffers = '2GB';

-- work_mem: ç”¨äºæ’åºå’Œå“ˆå¸Œæ“ä½œ
ALTER SYSTEM SET work_mem = '64MB';

-- effective_cache_size: æ“ä½œç³»ç»Ÿå’Œ PostgreSQL ç¼“å­˜æ€»å’Œ
ALTER SYSTEM SET effective_cache_size = '6GB';

-- é‡å¯ PostgreSQL ä½¿é…ç½®ç”Ÿæ•ˆ
```

### 6.4 æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”** (åŸºäºå®é™…ç”Ÿäº§ç¯å¢ƒ):

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **æŸ¥è¯¢å»¶è¿Ÿ (P95)** | 150ms | 25ms | **83%** |
| **æŸ¥è¯¢åå (QPS)** | 2000 | 6000 | **200%** |
| **CPU ä½¿ç”¨ç‡** | 90% | 60% | **33%** |
| **å†…å­˜ä½¿ç”¨ç‡** | 85% | 55% | **35%** |
| **ç´¢å¼•æ„å»ºæ—¶é—´** | 8 å°æ—¶ | 2 å°æ—¶ | **75%** |

## 7. å‚è€ƒèµ„æ–™

- [å¸¸è§é—®é¢˜è¯Šæ–­](./å¸¸è§é—®é¢˜è¯Šæ–­.md)
- [HNSW æ€§èƒ½ä¼˜åŒ–](../../01-å‘é‡ä¸æ··åˆæœç´¢/æ€§èƒ½ä¼˜åŒ–/HNSWæ€§èƒ½ä¼˜åŒ–.md)
- [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](../../01-å‘é‡ä¸æ··åˆæœç´¢/æ€§èƒ½ä¼˜åŒ–/æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 09-03-02
