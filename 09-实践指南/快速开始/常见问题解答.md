# PostgreSQL 向量搜索常见问题解答

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+, pgvector 0.7.0+
> **文档编号**: 09-01-03

## 📑 目录

- [PostgreSQL 向量搜索常见问题解答](#postgresql-向量搜索常见问题解答)
  - [📑 目录](#-目录)
  - [1. 安装问题](#1-安装问题)
    - [Q1: 如何安装 pgvector 扩展？](#q1-如何安装-pgvector-扩展)
    - [Q2: 安装后无法创建扩展？](#q2-安装后无法创建扩展)
  - [2. 使用问题](#2-使用问题)
    - [Q3: 如何选择向量维度？](#q3-如何选择向量维度)
    - [Q4: 如何计算向量相似度？](#q4-如何计算向量相似度)
    - [Q5: 如何插入向量数据？](#q5-如何插入向量数据)
  - [3. 性能问题](#3-性能问题)
    - [Q6: 查询速度慢怎么办？](#q6-查询速度慢怎么办)
    - [Q7: 索引构建很慢怎么办？](#q7-索引构建很慢怎么办)
  - [4. 索引问题](#4-索引问题)
    - [Q8: HNSW 和 IVFFlat 如何选择？](#q8-hnsw-和-ivfflat-如何选择)
    - [Q9: 索引占用空间太大怎么办？](#q9-索引占用空间太大怎么办)
  - [5. 迁移问题](#5-迁移问题)
    - [Q10: 如何从其他向量数据库迁移？](#q10-如何从其他向量数据库迁移)
    - [Q11: 迁移后性能不如原数据库？](#q11-迁移后性能不如原数据库)
  - [6. 参考资料](#6-参考资料)

---

## 1. 安装问题

### Q1: 如何安装 pgvector 扩展？

**A**: 根据您的操作系统选择安装方式：

**Ubuntu/Debian**:

```bash
sudo apt-get install postgresql-14-pgvector
```

**macOS**:

```bash
brew install pgvector
```

**Docker**:

```bash
docker run -d \
  --name postgres-pgvector \
  -e POSTGRES_PASSWORD=password \
  pgvector/pgvector:pg16
```

**从源码编译**:

```bash
git clone --branch v0.7.0 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install
```

### Q2: 安装后无法创建扩展？

**A**: 检查以下几点：

```sql
-- 1. 检查扩展是否已安装
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- 2. 检查 PostgreSQL 版本（需要 11+）
SELECT version();

-- 3. 检查是否有权限
-- 需要 superuser 或数据库所有者权限

-- 4. 手动指定路径（如果找不到）
CREATE EXTENSION vector WITH SCHEMA public;
```

## 2. 使用问题

### Q3: 如何选择向量维度？

**A**: 向量维度取决于您使用的嵌入模型：

```sql
-- OpenAI text-embedding-ada-002: 1536 维
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- OpenAI text-embedding-3-small: 1536 维
-- OpenAI text-embedding-3-large: 3072 维
-- sentence-transformers: 通常 384 或 768 维
```

### Q4: 如何计算向量相似度？

**A**: pgvector 支持三种距离计算：

```sql
-- 余弦距离（推荐用于文本嵌入）
SELECT embedding <=> query_vector AS cosine_distance FROM vectors;

-- 内积距离
SELECT embedding <#> query_vector AS inner_product FROM vectors;

-- 欧氏距离
SELECT embedding <-> query_vector AS euclidean_distance FROM vectors;
```

### Q5: 如何插入向量数据？

**A**: 使用 Python 示例：

```python
import asyncpg
import numpy as np

async def insert_vector():
    conn = await asyncpg.connect('postgresql://user:password@localhost/db')

    # 生成向量（示例）
    vector = np.random.rand(1536).tolist()
    vector_str = '[' + ','.join(map(str, vector)) + ']'

    await conn.execute("""
        INSERT INTO vectors (embedding, metadata)
        VALUES ($1::vector, $2::jsonb)
    """, vector_str, {'text': 'example'})

    await conn.close()
```

## 3. 性能问题

### Q6: 查询速度慢怎么办？

**A**: 检查以下几点：

```sql
-- 1. 检查是否使用了索引
EXPLAIN ANALYZE
SELECT * FROM vectors
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 应该看到: Index Scan using vectors_embedding_idx
-- 如果看到: Seq Scan，需要创建索引

-- 2. 创建 HNSW 索引
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. 调整 ef_search 参数
SET hnsw.ef_search = 40;  -- 默认值
-- 降低值可以加快查询，但可能降低召回率
```

### Q7: 索引构建很慢怎么办？

**A**: 优化索引构建参数：

```sql
-- 1. 降低 ef_construction（加快构建，可能降低质量）
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- 2. 降低 m 参数（减少内存占用）
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);

-- 3. 在低峰期构建索引
-- 4. 使用 CONCURRENTLY（PostgreSQL 12+）
CREATE INDEX CONCURRENTLY ON vectors USING hnsw (embedding vector_cosine_ops);
```

## 4. 索引问题

### Q8: HNSW 和 IVFFlat 如何选择？

**A**: 根据场景选择：

| 场景 | 推荐索引 | 原因 |
|------|---------|------|
| 查询为主，高精度要求 | HNSW | 召回率高，查询快 |
| 大规模数据，高更新频率 | IVFFlat | 更新成本低，内存占用小 |
| 内存受限 | IVFFlat | 内存占用更小 |

```sql
-- HNSW 示例
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- IVFFlat 示例
CREATE INDEX ON vectors USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

### Q9: 索引占用空间太大怎么办？

**A**: 优化索引参数：

```sql
-- 1. 降低 m 参数（HNSW）
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 8);  -- 默认是 16

-- 2. 降低 lists 参数（IVFFlat）
CREATE INDEX ON vectors USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 50);  -- 默认是 100

-- 3. 查看索引大小
SELECT
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_indexes
WHERE tablename = 'vectors';
```

## 5. 迁移问题

### Q10: 如何从其他向量数据库迁移？

**A**: 参考迁移指南：

- [从 Milvus 迁移](../迁移指南/从专用向量数据库迁移.md#3-milvus-迁移)
- [从 Pinecone 迁移](../迁移指南/从专用向量数据库迁移.md#4-pinecone-迁移)
- [从 MongoDB 迁移](../迁移指南/从MongoDB迁移.md)

### Q11: 迁移后性能不如原数据库？

**A**: 优化配置：

```sql
-- 1. 确保使用了合适的索引
CREATE INDEX ON vectors USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 2. 调整 PostgreSQL 配置
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET effective_cache_size = '6GB';

-- 3. 调整查询参数
SET hnsw.ef_search = 100;  -- 提高召回率

-- 4. 使用连接池
-- 参考: [连接池优化](../../01-向量与混合搜索/性能优化/HNSW性能优化.md#51-连接池优化)
```

## 6. 参考资料

- [快速开始指南](../../01-向量与混合搜索/最佳实践/快速开始指南.md)
- [索引选择策略](../../01-向量与混合搜索/最佳实践/索引选择策略.md)
- [性能调优技巧](../../01-向量与混合搜索/最佳实践/性能调优技巧.md)
- [常见问题诊断](../故障排查/常见问题诊断.md)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 09-01-03
