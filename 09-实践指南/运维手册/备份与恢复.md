# 9.2.3 å¤‡ä»½ä¸æ¢å¤

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æ–‡æ¡£ç¼–å·**: 09-02-03

## ğŸ“‘ ç›®å½•

- [9.2.3 å¤‡ä»½ä¸æ¢å¤](#923-å¤‡ä»½ä¸æ¢å¤)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 å¤‡ä»½ç›®æ ‡](#11-å¤‡ä»½ç›®æ ‡)
    - [1.2 æ¢å¤ç­–ç•¥](#12-æ¢å¤ç­–ç•¥)
    - [1.3 å¤‡ä»½æ¶æ„](#13-å¤‡ä»½æ¶æ„)
  - [2. å¤‡ä»½ç­–ç•¥](#2-å¤‡ä»½ç­–ç•¥)
    - [2.1 é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰](#21-é€»è¾‘å¤‡ä»½pg_dump)
      - [2.1.1 å®Œæ•´å¤‡ä»½](#211-å®Œæ•´å¤‡ä»½)
      - [2.1.2 è¡¨çº§å¤‡ä»½](#212-è¡¨çº§å¤‡ä»½)
      - [2.1.3 ä»…æ•°æ®/ç»“æ„å¤‡ä»½](#213-ä»…æ•°æ®ç»“æ„å¤‡ä»½)
    - [2.2 ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰](#22-ç‰©ç†å¤‡ä»½pg_basebackup)
      - [2.2.1 å®Œæ•´ç‰©ç†å¤‡ä»½](#221-å®Œæ•´ç‰©ç†å¤‡ä»½)
      - [2.2.2 æµå¼å¤‡ä»½](#222-æµå¼å¤‡ä»½)
    - [2.3 è¿ç»­å½’æ¡£ï¼ˆWALï¼‰](#23-è¿ç»­å½’æ¡£wal)
      - [2.3.1 WAL å½’æ¡£é…ç½®](#231-wal-å½’æ¡£é…ç½®)
      - [2.3.2 åŸºç¡€å¤‡ä»½åˆ›å»º](#232-åŸºç¡€å¤‡ä»½åˆ›å»º)
  - [3. æ¢å¤ç­–ç•¥](#3-æ¢å¤ç­–ç•¥)
    - [3.1 é€»è¾‘æ¢å¤ï¼ˆpg_restoreï¼‰](#31-é€»è¾‘æ¢å¤pg_restore)
      - [3.1.1 å®Œæ•´æ•°æ®åº“æ¢å¤](#311-å®Œæ•´æ•°æ®åº“æ¢å¤)
      - [3.1.2 éƒ¨åˆ†æ¢å¤](#312-éƒ¨åˆ†æ¢å¤)
    - [3.2 ç‚¹å¯¹ç‚¹æ¢å¤ï¼ˆPITRï¼‰](#32-ç‚¹å¯¹ç‚¹æ¢å¤pitr)
      - [3.2.1 PITR é…ç½®](#321-pitr-é…ç½®)
      - [3.2.2 æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹](#322-æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹)
  - [4. è‡ªåŠ¨åŒ–å¤‡ä»½](#4-è‡ªåŠ¨åŒ–å¤‡ä»½)
    - [4.1 Python å¤‡ä»½è„šæœ¬](#41-python-å¤‡ä»½è„šæœ¬)
      - [4.1.1 å¤‡ä»½ç®¡ç†å™¨ç±»](#411-å¤‡ä»½ç®¡ç†å™¨ç±»)
      - [4.1.2 å¤‡ä»½è°ƒåº¦](#412-å¤‡ä»½è°ƒåº¦)
    - [4.2 å¤‡ä»½ç­–ç•¥é…ç½®](#42-å¤‡ä»½ç­–ç•¥é…ç½®)
  - [5. å¤‡ä»½éªŒè¯](#5-å¤‡ä»½éªŒè¯)
    - [5.1 å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥](#51-å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥)
      - [5.1.1 å¤‡ä»½æ–‡ä»¶éªŒè¯](#511-å¤‡ä»½æ–‡ä»¶éªŒè¯)
      - [5.1.2 å¤‡ä»½å†…å®¹éªŒè¯](#512-å¤‡ä»½å†…å®¹éªŒè¯)
    - [5.2 æ¢å¤æµ‹è¯•](#52-æ¢å¤æµ‹è¯•)
      - [5.2.1 æ¢å¤æµ‹è¯•æµç¨‹](#521-æ¢å¤æµ‹è¯•æµç¨‹)
      - [5.2.2 æ•°æ®éªŒè¯](#522-æ•°æ®éªŒè¯)
  - [6. å¤‡ä»½å­˜å‚¨ç­–ç•¥](#6-å¤‡ä»½å­˜å‚¨ç­–ç•¥)
    - [6.1 æœ¬åœ°å­˜å‚¨](#61-æœ¬åœ°å­˜å‚¨)
    - [6.2 è¿œç¨‹å­˜å‚¨](#62-è¿œç¨‹å­˜å‚¨)
    - [6.3 å¤‡ä»½ä¿ç•™ç­–ç•¥](#63-å¤‡ä»½ä¿ç•™ç­–ç•¥)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 å¤‡ä»½ç­–ç•¥](#71-å¤‡ä»½ç­–ç•¥)
    - [7.2 æ¢å¤ç­–ç•¥](#72-æ¢å¤ç­–ç•¥)
    - [7.3 å®¹ç¾æ¼”ç»ƒ](#73-å®¹ç¾æ¼”ç»ƒ)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1 å®˜æ–¹æ–‡æ¡£](#81-å®˜æ–¹æ–‡æ¡£)
    - [8.2 æŠ€æœ¯æ–‡æ¡£](#82-æŠ€æœ¯æ–‡æ¡£)
    - [8.3 ç›¸å…³èµ„æº](#83-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 å¤‡ä»½ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**:

æœ¬æ–‡æ¡£æä¾› PostgreSQL + pgvector ç”Ÿäº§ç¯å¢ƒçš„å¤‡ä»½ä¸æ¢å¤ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œé«˜å¯ç”¨æ€§ã€‚

**å¤‡ä»½ç›®æ ‡**:

1. **æ•°æ®ä¿æŠ¤**: ä¿æŠ¤é‡è¦æ•°æ®ä¸ä¸¢å¤±
2. **å¿«é€Ÿæ¢å¤**: æ”¯æŒå¿«é€Ÿæ¢å¤ï¼Œå‡å°‘åœæœºæ—¶é—´
3. **ç‚¹å¯¹ç‚¹æ¢å¤**: æ”¯æŒæ¢å¤åˆ°ä»»æ„æ—¶é—´ç‚¹ï¼ˆPITRï¼‰
4. **è‡ªåŠ¨åŒ–ç®¡ç†**: è‡ªåŠ¨åŒ–å¤‡ä»½å’Œæ¢å¤æµç¨‹

**å¤‡ä»½ä»·å€¼**:

| å¤‡ä»½ç±»å‹     | æ¢å¤æ—¶é—´   | æ•°æ®æŸå¤±     | é€‚ç”¨åœºæ™¯         |
| ------------ | ---------- | ------------ | ---------------- |
| **é€»è¾‘å¤‡ä»½** | 10-60 åˆ†é’Ÿ | å¤‡ä»½ç‚¹æ•°æ®   | å®šæœŸå¤‡ä»½ã€è¿ç§»   |
| **ç‰©ç†å¤‡ä»½** | 5-30 åˆ†é’Ÿ  | å¤‡ä»½ç‚¹æ•°æ®   | å¿«é€Ÿæ¢å¤         |
| **WAL å½’æ¡£** | 1-10 åˆ†é’Ÿ  | **å‡ ä¹ä¸ºé›¶** | **ç”Ÿäº§ç¯å¢ƒæ¨è** |

### 1.2 æ¢å¤ç­–ç•¥

**æ¢å¤ç­–ç•¥**:

1. **å®Œæ•´æ¢å¤**: æ¢å¤æ•´ä¸ªæ•°æ®åº“
2. **éƒ¨åˆ†æ¢å¤**: æ¢å¤ç‰¹å®šè¡¨æˆ–æ•°æ®
3. **ç‚¹å¯¹ç‚¹æ¢å¤**: æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
4. **å¢é‡æ¢å¤**: åŸºäºåŸºç¡€å¤‡ä»½å’Œ WAL æ—¥å¿—æ¢å¤

**æ¢å¤æ—¶é—´ç›®æ ‡ï¼ˆRTOï¼‰**:

| æ¢å¤ç±»å‹      | RTO         | è¯´æ˜         |
| ------------- | ----------- | ------------ |
| **å®Œæ•´æ¢å¤**  | 30 åˆ†é’Ÿ     | é€»è¾‘å¤‡ä»½æ¢å¤ |
| **ç‰©ç†æ¢å¤**  | 15 åˆ†é’Ÿ     | ç‰©ç†å¤‡ä»½æ¢å¤ |
| **PITR æ¢å¤** | **10 åˆ†é’Ÿ** | WAL å½’æ¡£æ¢å¤ |

**æ¢å¤ç‚¹ç›®æ ‡ï¼ˆRPOï¼‰**:

| å¤‡ä»½ç±»å‹     | RPO         | è¯´æ˜         |
| ------------ | ----------- | ------------ |
| **å®Œæ•´å¤‡ä»½** | 24 å°æ—¶     | æ¯å¤©å¤‡ä»½ä¸€æ¬¡ |
| **ç‰©ç†å¤‡ä»½** | 24 å°æ—¶     | æ¯å¤©å¤‡ä»½ä¸€æ¬¡ |
| **WAL å½’æ¡£** | **<1 åˆ†é’Ÿ** | **å®æ—¶å½’æ¡£** |

### 1.3 å¤‡ä»½æ¶æ„

**å¤‡ä»½æ¶æ„è®¾è®¡**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL + pgvector                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚Database  â”‚  â”‚WAL Logs  â”‚                    â”‚
â”‚  â”‚Files     â”‚  â”‚          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   pg_dump          â”‚  â”‚  pg_basebackup  â”‚
â”‚   (é€»è¾‘å¤‡ä»½)        â”‚  â”‚  (ç‰©ç†å¤‡ä»½)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WAL Archive      â”‚  â”‚  Backup Storage â”‚
â”‚   (è¿ç»­å½’æ¡£)        â”‚  â”‚  (å¤‡ä»½å­˜å‚¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backup Storage                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚Local     â”‚  â”‚Remote    â”‚            â”‚
â”‚  â”‚Storage   â”‚  â”‚Storage   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. å¤‡ä»½ç­–ç•¥

### 2.1 é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰

#### 2.1.1 å®Œæ•´å¤‡ä»½

**å®Œæ•´æ•°æ®åº“å¤‡ä»½**:

```bash
# å®Œæ•´æ•°æ®åº“å¤‡ä»½ï¼ˆè‡ªå®šä¹‰æ ¼å¼ï¼Œæ”¯æŒå‹ç¼©ï¼‰
pg_dump -U postgres -d vector_db \
  -F c \
  -Z 9 \
  -f backup_vector_db_$(date +%Y%m%d_%H%M%S).dump

# å‚æ•°è¯´æ˜ï¼š
# -U: ç”¨æˆ·å
# -d: æ•°æ®åº“å
# -F c: è‡ªå®šä¹‰æ ¼å¼ï¼ˆæ”¯æŒå‹ç¼©å’Œé€‰æ‹©æ€§æ¢å¤ï¼‰
# -Z 9: å‹ç¼©çº§åˆ«ï¼ˆ0-9ï¼Œ9 ä¸ºæœ€é«˜å‹ç¼©ï¼‰
# -f: è¾“å‡ºæ–‡ä»¶
```

**å¤‡ä»½æ€§èƒ½**:

| æ•°æ®é‡    | å¤‡ä»½æ—¶é—´       | å¤‡ä»½å¤§å°  | å‹ç¼©ç‡     |
| --------- | -------------- | --------- | ---------- |
| **1GB**   | **2-5 åˆ†é’Ÿ**   | 200-500MB | **50-80%** |
| **10GB**  | **20-50 åˆ†é’Ÿ** | 2-5GB     | **50-80%** |
| **100GB** | **3-8 å°æ—¶**   | 20-50GB   | **50-80%** |

#### 2.1.2 è¡¨çº§å¤‡ä»½

**è¡¨çº§å¤‡ä»½**:

```bash
# å¤‡ä»½ç‰¹å®šè¡¨
pg_dump -U postgres -d vector_db \
  -t documents \
  -F c \
  -Z 9 \
  -f backup_documents_$(date +%Y%m%d_%H%M%S).dump

# å¤‡ä»½å¤šä¸ªè¡¨
pg_dump -U postgres -d vector_db \
  -t documents \
  -t account_behaviors \
  -t product_embeddings \
  -F c \
  -Z 9 \
  -f backup_tables_$(date +%Y%m%d_%H%M%S).dump

# å¤‡ä»½å¤šä¸ªè¡¨ï¼ˆä½¿ç”¨æ­£åˆ™ï¼‰
pg_dump -U postgres -d vector_db \
  -t 'documents*' \
  -F c \
  -Z 9 \
  -f backup_documents_all_$(date +%Y%m%d_%H%M%S).dump
```

**è¡¨çº§å¤‡ä»½åœºæ™¯**:

| åœºæ™¯           | å¤‡ä»½æ–¹å¼ | è¯´æ˜           |
| -------------- | -------- | -------------- |
| **å•è¡¨æ¢å¤**   | è¡¨çº§å¤‡ä»½ | å¿«é€Ÿæ¢å¤å•ä¸ªè¡¨ |
| **æ‰¹é‡è¡¨æ¢å¤** | å¤šè¡¨å¤‡ä»½ | æ¢å¤ç›¸å…³è¡¨     |
| **è¡¨è¿ç§»**     | è¡¨çº§å¤‡ä»½ | è¿ç§»ç‰¹å®šè¡¨     |

#### 2.1.3 ä»…æ•°æ®/ç»“æ„å¤‡ä»½

**ä»…æ•°æ®å¤‡ä»½**:

```bash
# ä»…å¤‡ä»½æ•°æ®ï¼ˆä¸å«ç»“æ„ï¼‰
pg_dump -U postgres -d vector_db \
  --data-only \
  -F c \
  -Z 9 \
  -f backup_data_$(date +%Y%m%d_%H%M%S).dump

# ä»…å¤‡ä»½ç»“æ„ï¼ˆä¸å«æ•°æ®ï¼‰
pg_dump -U postgres -d vector_db \
  --schema-only \
  -F c \
  -f backup_schema_$(date +%Y%m%d_%H%M%S).dump

# ä»…å¤‡ä»½ç‰¹å®š schema
pg_dump -U postgres -d vector_db \
  -n public \
  -F c \
  -f backup_schema_public_$(date +%Y%m%d_%H%M%S).dump
```

**å¤‡ä»½ç±»å‹é€‰æ‹©**:

| å¤‡ä»½ç±»å‹       | é€‚ç”¨åœºæ™¯ | è¯´æ˜                       |
| -------------- | -------- | -------------------------- |
| **å®Œæ•´å¤‡ä»½**   | å®šæœŸå¤‡ä»½ | åŒ…å«ç»“æ„å’Œæ•°æ®             |
| **ä»…æ•°æ®å¤‡ä»½** | æ•°æ®è¿ç§» | ä»…æ•°æ®ï¼Œç”¨äºå¯¼å…¥åˆ°å·²æœ‰ç»“æ„ |
| **ä»…ç»“æ„å¤‡ä»½** | ç»“æ„è¿ç§» | ä»…ç»“æ„ï¼Œç”¨äºåˆ›å»ºç›¸åŒè¡¨ç»“æ„ |

### 2.2 ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰

#### 2.2.1 å®Œæ•´ç‰©ç†å¤‡ä»½

**ç‰©ç†å¤‡ä»½æ­¥éª¤**:

```bash
# å®Œæ•´ç‰©ç†å¤‡ä»½
pg_basebackup -U postgres \
  -D /backup/postgres_$(date +%Y%m%d_%H%M%S) \
  -Ft \
  -z \
  -P \
  -v

# å‚æ•°è¯´æ˜ï¼š
# -U: ç”¨æˆ·å
# -D: å¤‡ä»½ç›®å½•
# -Ft: Tar æ ¼å¼
# -z: å‹ç¼©
# -P: æ˜¾ç¤ºè¿›åº¦
# -v: è¯¦ç»†è¾“å‡º
```

**ç‰©ç†å¤‡ä»½æ€§èƒ½**:

| æ•°æ®é‡    | å¤‡ä»½æ—¶é—´       | å¤‡ä»½å¤§å°  | å‹ç¼©ç‡     |
| --------- | -------------- | --------- | ---------- |
| **1GB**   | **1-2 åˆ†é’Ÿ**   | 200-400MB | **60-80%** |
| **10GB**  | **10-20 åˆ†é’Ÿ** | 2-4GB     | **60-80%** |
| **100GB** | **1-3 å°æ—¶**   | 20-40GB   | **60-80%** |

#### 2.2.2 æµå¼å¤‡ä»½

**æµå¼å¤‡ä»½**:

```bash
# æµå¼å¤‡ä»½ï¼ˆåŒ…å« WAL æ—¥å¿—ï¼‰
pg_basebackup -U postgres \
  -D /backup/postgres_$(date +%Y%m%d_%H%M%S) \
  -Ft \
  -z \
  -P \
  -X stream \
  -v

# å‚æ•°è¯´æ˜ï¼š
# -X stream: æµå¼ä¼ è¾“ WAL æ—¥å¿—
# å…¶ä»–å‚æ•°åŒä¸Š
```

**ç‰©ç†å¤‡ä»½å¯¹æ¯”**:

| å¤‡ä»½æ–¹å¼     | ä¼˜ç‚¹                | ç¼ºç‚¹       | é€‚ç”¨åœºæ™¯         |
| ------------ | ------------------- | ---------- | ---------------- |
| **åŸºç¡€å¤‡ä»½** | é€Ÿåº¦å¿«ï¼Œæ¢å¤å¿«      | å ç”¨ç©ºé—´å¤§ | å¿«é€Ÿæ¢å¤         |
| **æµå¼å¤‡ä»½** | åŒ…å« WALï¼Œæ”¯æŒ PITR | éœ€è¦ç½‘ç»œ   | **ç”Ÿäº§ç¯å¢ƒæ¨è** |

### 2.3 è¿ç»­å½’æ¡£ï¼ˆWALï¼‰

#### 2.3.1 WAL å½’æ¡£é…ç½®

**WAL å½’æ¡£é…ç½®**:

```sql
-- postgresql.conf é…ç½®
wal_level = replica  -- æˆ– logicalï¼ˆå¦‚æœéœ€è¦é€»è¾‘å¤åˆ¶ï¼‰
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'

-- æˆ–è€…ä½¿ç”¨æ›´å®‰å…¨çš„å‘½ä»¤
archive_command = 'test ! -f /backup/wal/%f && cp %p /backup/wal/%f'

-- éªŒè¯é…ç½®
SHOW wal_level;
SHOW archive_mode;
SHOW archive_command;
```

**WAL å½’æ¡£å­˜å‚¨**:

```bash
# åˆ›å»º WAL å½’æ¡£ç›®å½•
mkdir -p /backup/wal
chown postgres:postgres /backup/wal
chmod 700 /backup/wal

# è®¾ç½®å½’æ¡£è„šæœ¬ï¼ˆæ›´é«˜çº§ï¼‰
archive_command = '/usr/local/bin/archive_wal.sh %p %f'

# archive_wal.sh è„šæœ¬å†…å®¹
#!/bin/bash
WAL_FILE=$1
WAL_NAME=$2
ARCHIVE_DIR=/backup/wal

# å¤åˆ¶åˆ°æœ¬åœ°
cp "$WAL_FILE" "$ARCHIVE_DIR/$WAL_NAME"

# å¯é€‰ï¼šåŒæ­¥åˆ°è¿œç¨‹
rsync -av "$ARCHIVE_DIR/$WAL_NAME" remote-backup:/backup/wal/

exit 0
```

#### 2.3.2 åŸºç¡€å¤‡ä»½åˆ›å»º

**åŸºç¡€å¤‡ä»½åˆ›å»º**:

```bash
# åˆ›å»ºåŸºç¡€å¤‡ä»½ï¼ˆæ‰‹åŠ¨ï¼‰
pg_basebackup -U postgres \
  -D /backup/base_$(date +%Y%m%d_%H%M%S) \
  -Ft \
  -z \
  -P \
  -X stream \
  -v

# æˆ–è€…åœ¨ PostgreSQL ä¸­æ ‡è®°å¤‡ä»½ç‚¹
psql -U postgres -c "SELECT pg_start_backup('backup_label');"
# ... å¤‡ä»½æ•°æ®åº“æ–‡ä»¶ ...
psql -U postgres -c "SELECT pg_stop_backup();"
```

**WAL å½’æ¡£ç­–ç•¥**:

| ç­–ç•¥         | WAL ä¿ç•™æ—¶é—´ | è¯´æ˜     |
| ------------ | ------------ | -------- |
| **çŸ­æœŸä¿ç•™** | 7 å¤©         | æœ¬åœ°å­˜å‚¨ |
| **ä¸­æœŸä¿ç•™** | 30 å¤©        | è¿œç¨‹å­˜å‚¨ |
| **é•¿æœŸä¿ç•™** | 90 å¤©        | å½’æ¡£å­˜å‚¨ |

## 3. æ¢å¤ç­–ç•¥

### 3.1 é€»è¾‘æ¢å¤ï¼ˆpg_restoreï¼‰

#### 3.1.1 å®Œæ•´æ•°æ®åº“æ¢å¤

**å®Œæ•´æ•°æ®åº“æ¢å¤**:

```bash
# æ¢å¤å®Œæ•´æ•°æ®åº“ï¼ˆè¦†ç›–ï¼‰
pg_restore -U postgres \
  -d vector_db \
  -F c \
  --clean \
  --if-exists \
  backup_vector_db_20251101_120000.dump

# æ¢å¤å®Œæ•´æ•°æ®åº“ï¼ˆä¸è¦†ç›–ï¼‰
pg_restore -U postgres \
  -d vector_db \
  -F c \
  backup_vector_db_20251101_120000.dump

# å‚æ•°è¯´æ˜ï¼š
# -U: ç”¨æˆ·å
# -d: ç›®æ ‡æ•°æ®åº“
# -F c: è‡ªå®šä¹‰æ ¼å¼
# --clean: åˆ é™¤å·²å­˜åœ¨çš„å¯¹è±¡
# --if-exists: å¦‚æœå¯¹è±¡ä¸å­˜åœ¨ä¸æŠ¥é”™
```

**æ¢å¤æ€§èƒ½**:

| å¤‡ä»½å¤§å°  | æ¢å¤æ—¶é—´       | è¯´æ˜         |
| --------- | -------------- | ------------ |
| **1GB**   | **3-8 åˆ†é’Ÿ**   | é€»è¾‘å¤‡ä»½æ¢å¤ |
| **10GB**  | **30-80 åˆ†é’Ÿ** | é€»è¾‘å¤‡ä»½æ¢å¤ |
| **100GB** | **5-13 å°æ—¶**  | é€»è¾‘å¤‡ä»½æ¢å¤ |

#### 3.1.2 éƒ¨åˆ†æ¢å¤

**éƒ¨åˆ†æ¢å¤**:

```bash
# ä»…æ¢å¤æ•°æ®
pg_restore -U postgres \
  -d vector_db \
  --data-only \
  -F c \
  backup_data_20251101_120000.dump

# ä»…æ¢å¤ç»“æ„
pg_restore -U postgres \
  -d vector_db \
  --schema-only \
  -F c \
  backup_schema_20251101_120000.dump

# æ¢å¤ç‰¹å®šè¡¨
pg_restore -U postgres \
  -d vector_db \
  -t documents \
  -F c \
  backup_vector_db_20251101_120000.dump

# æ¢å¤æ—¶å¹¶è¡Œå¤„ç†ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
pg_restore -U postgres \
  -d vector_db \
  -F c \
  -j 4 \
  backup_vector_db_20251101_120000.dump

# å‚æ•°è¯´æ˜ï¼š
# -j: å¹¶è¡Œä»»åŠ¡æ•°ï¼ˆå»ºè®® = CPU æ ¸å¿ƒæ•°ï¼‰
```

**æ¢å¤ç­–ç•¥é€‰æ‹©**:

| æ¢å¤åœºæ™¯     | æ¢å¤æ–¹å¼   | è¯´æ˜               |
| ------------ | ---------- | ------------------ |
| **å®Œæ•´æ¢å¤** | å®Œæ•´å¤‡ä»½   | æ¢å¤åˆ°å¤‡ä»½ç‚¹       |
| **è¡¨æ¢å¤**   | è¡¨çº§å¤‡ä»½   | æ¢å¤å•ä¸ªè¡¨         |
| **æ•°æ®æ¢å¤** | ä»…æ•°æ®å¤‡ä»½ | æ¢å¤æ•°æ®åˆ°å·²æœ‰ç»“æ„ |
| **ç»“æ„æ¢å¤** | ä»…ç»“æ„å¤‡ä»½ | åˆ›å»ºè¡¨ç»“æ„         |

### 3.2 ç‚¹å¯¹ç‚¹æ¢å¤ï¼ˆPITRï¼‰

#### 3.2.1 PITR é…ç½®

**PITR æ¢å¤å‡†å¤‡**:

```bash
# 1. æ¢å¤åŸºç¡€å¤‡ä»½
pg_basebackup -U postgres -D /var/lib/postgresql/data -Ft -z -P

# æˆ–ä»å¤‡ä»½æ¢å¤
tar -xzf /backup/base_20251101_120000.tar.gz -C /var/lib/postgresql/data

# 2. é…ç½®æ¢å¤å‚æ•°
cat > /var/lib/postgresql/data/recovery.conf <<EOF
restore_command = 'cp /backup/wal/%f %p'
recovery_target_time = '2025-11-01 10:00:00'
recovery_target_action = 'promote'
EOF

# PostgreSQL 13+ ä½¿ç”¨ postgresql.conf
# recovery_target_time = '2025-11-01 10:00:00'
# restore_command = 'cp /backup/wal/%f %p'
```

**PITR é…ç½®å‚æ•°**:

| å‚æ•°                       | è¯´æ˜           | ç¤ºä¾‹                    |
| -------------------------- | -------------- | ----------------------- |
| `restore_command`          | WAL æ¢å¤å‘½ä»¤   | `cp /backup/wal/%f %p`  |
| `recovery_target_time`     | æ¢å¤ç›®æ ‡æ—¶é—´   | `'2025-11-01 10:00:00'` |
| `recovery_target_timeline` | æ¢å¤ç›®æ ‡æ—¶é—´çº¿ | `'latest'`              |
| `recovery_target_action`   | æ¢å¤åæ“ä½œ     | `'promote'`             |

#### 3.2.2 æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹

**PITR æ¢å¤æ­¥éª¤**:

```bash
# 1. åœæ­¢ PostgreSQLï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
systemctl stop postgresql

# 2. æ¢å¤åŸºç¡€å¤‡ä»½
rm -rf /var/lib/postgresql/data/*
tar -xzf /backup/base_20251101_120000.tar.gz -C /var/lib/postgresql/data

# 3. åˆ›å»ºæ¢å¤é…ç½®æ–‡ä»¶ï¼ˆPostgreSQL 12+ï¼‰
cat > /var/lib/postgresql/data/postgresql.conf <<EOF
# PITR é…ç½®
recovery_target_time = '2025-11-01 10:00:00'
restore_command = 'cp /backup/wal/%f %p'
recovery_target_action = 'promote'
EOF

# 4. åˆ›å»ºä¿¡å·æ–‡ä»¶ï¼ˆPostgreSQL 12+ï¼‰
touch /var/lib/postgresql/data/recovery.signal

# 5. å¯åŠ¨ PostgreSQLï¼ˆè‡ªåŠ¨æ¢å¤ï¼‰
systemctl start postgresql

# 6. ç›‘æ§æ¢å¤è¿›åº¦
tail -f /var/lib/postgresql/data/log/postgresql.log
```

**PITR æ¢å¤æ€§èƒ½**:

| WAL æ•°é‡     | æ¢å¤æ—¶é—´       | è¯´æ˜          |
| ------------ | -------------- | ------------- |
| **<100**     | **<5 åˆ†é’Ÿ**    | å°‘é‡ WAL æ—¥å¿— |
| **100-1000** | **5-15 åˆ†é’Ÿ**  | ä¸­ç­‰ WAL æ—¥å¿— |
| **>1000**    | **15-60 åˆ†é’Ÿ** | å¤§é‡ WAL æ—¥å¿— |

## 4. è‡ªåŠ¨åŒ–å¤‡ä»½

### 4.1 Python å¤‡ä»½è„šæœ¬

#### 4.1.1 å¤‡ä»½ç®¡ç†å™¨ç±»

**å®Œæ•´çš„å¤‡ä»½ç®¡ç†å™¨**:

```python
# backup_manager.py
import subprocess
import os
import shutil
from datetime import datetime, timedelta
import psycopg2
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/postgres_backup.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class BackupManager:
    """å¤‡ä»½ç®¡ç†å™¨"""

    def __init__(self, db_config, backup_dir="/backup/postgres"):
        self.db_config = db_config
        self.backup_dir = backup_dir
        self.wal_dir = os.path.join(backup_dir, "wal")
        os.makedirs(self.backup_dir, exist_ok=True)
        os.makedirs(self.wal_dir, exist_ok=True)

    def full_backup(self):
        """å®Œæ•´å¤‡ä»½"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_file = os.path.join(
            self.backup_dir,
            f"full_backup_{timestamp}.dump"
        )

        try:
            cmd = [
                "pg_dump",
                "-U", self.db_config["user"],
                "-d", self.db_config["database"],
                "-F", "c",
                "-Z", "9",
                "-f", backup_file
            ]

            # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœä½¿ç”¨å¯†ç æ–‡ä»¶ï¼‰
            env = os.environ.copy()
            if "password" in self.db_config:
                env["PGPASSWORD"] = self.db_config["password"]

            result = subprocess.run(
                cmd,
                env=env,
                capture_output=True,
                check=True,
                timeout=3600  # 1 å°æ—¶è¶…æ—¶
            )

            # éªŒè¯å¤‡ä»½æ–‡ä»¶
            if os.path.exists(backup_file) and os.path.getsize(backup_file) > 0:
                logger.info(f"âœ… å®Œæ•´å¤‡ä»½å®Œæˆ: {backup_file}")
                return backup_file
            else:
                logger.error(f"âŒ å¤‡ä»½æ–‡ä»¶æ— æ•ˆ: {backup_file}")
                return None

        except subprocess.TimeoutExpired:
            logger.error("âŒ å¤‡ä»½è¶…æ—¶")
            return None
        except subprocess.CalledProcessError as e:
            logger.error(f"âŒ å¤‡ä»½å¤±è´¥: {e.stderr.decode()}")
            return None
        except Exception as e:
            logger.error(f"âŒ å¤‡ä»½å¼‚å¸¸: {str(e)}")
            return None

    def physical_backup(self):
        """ç‰©ç†å¤‡ä»½"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_dir = os.path.join(
            self.backup_dir,
            f"physical_backup_{timestamp}"
        )
        os.makedirs(backup_dir, exist_ok=True)

        try:
            cmd = [
                "pg_basebackup",
                "-U", self.db_config["user"],
                "-D", backup_dir,
                "-Ft",
                "-z",
                "-P",
                "-X", "stream",
                "-v"
            ]

            env = os.environ.copy()
            if "password" in self.db_config:
                env["PGPASSWORD"] = self.db_config["password"]

            result = subprocess.run(
                cmd,
                env=env,
                capture_output=True,
                check=True,
                timeout=7200  # 2 å°æ—¶è¶…æ—¶
            )

            if os.path.exists(backup_dir):
                logger.info(f"âœ… ç‰©ç†å¤‡ä»½å®Œæˆ: {backup_dir}")
                return backup_dir
            else:
                logger.error(f"âŒ å¤‡ä»½ç›®å½•æ— æ•ˆ: {backup_dir}")
                return None

        except Exception as e:
            logger.error(f"âŒ ç‰©ç†å¤‡ä»½å¤±è´¥: {str(e)}")
            return None

    def verify_backup(self, backup_file):
        """éªŒè¯å¤‡ä»½æ–‡ä»¶"""
        try:
            # å°è¯•åˆ—å‡ºå¤‡ä»½å†…å®¹
            result = subprocess.run(
                ["pg_restore", "-l", backup_file],
                capture_output=True,
                check=True,
                timeout=300
            )
            logger.info(f"âœ… å¤‡ä»½æ–‡ä»¶å®Œæ•´: {backup_file}")
            return True
        except subprocess.CalledProcessError:
            logger.error(f"âŒ å¤‡ä»½æ–‡ä»¶æŸå: {backup_file}")
            return False
        except Exception as e:
            logger.error(f"âŒ éªŒè¯å¤±è´¥: {str(e)}")
            return False

    def cleanup_old_backups(self, days=7):
        """æ¸…ç†æ—§å¤‡ä»½"""
        cutoff_time = datetime.now() - timedelta(days=days)
        cutoff_timestamp = cutoff_time.timestamp()

        cleaned_count = 0
        for file in os.listdir(self.backup_dir):
            file_path = os.path.join(self.backup_dir, file)
            if os.path.isfile(file_path):
                if os.path.getmtime(file_path) < cutoff_timestamp:
                    try:
                        os.remove(file_path)
                        logger.info(f"âœ… åˆ é™¤æ—§å¤‡ä»½: {file}")
                        cleaned_count += 1
                    except Exception as e:
                        logger.error(f"âŒ åˆ é™¤å¤±è´¥: {file}, {str(e)}")

        logger.info(f"âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤ {cleaned_count} ä¸ªæ—§å¤‡ä»½")
        return cleaned_count

    def cleanup_old_wal(self, days=3):
        """æ¸…ç†æ—§ WAL æ—¥å¿—"""
        cutoff_time = datetime.now() - timedelta(days=days)
        cutoff_timestamp = cutoff_time.timestamp()

        cleaned_count = 0
        for file in os.listdir(self.wal_dir):
            file_path = os.path.join(self.wal_dir, file)
            if os.path.isfile(file_path):
                if os.path.getmtime(file_path) < cutoff_timestamp:
                    try:
                        os.remove(file_path)
                        logger.info(f"âœ… åˆ é™¤æ—§ WAL: {file}")
                        cleaned_count += 1
                    except Exception as e:
                        logger.error(f"âŒ åˆ é™¤å¤±è´¥: {file}, {str(e)}")

        logger.info(f"âœ… WAL æ¸…ç†å®Œæˆï¼Œåˆ é™¤ {cleaned_count} ä¸ªæ—§æ–‡ä»¶")
        return cleaned_count


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    backup_manager = BackupManager({
        "user": "postgres",
        "database": "vector_db",
        "password": "postgres"
    })

    # æ‰§è¡Œå®Œæ•´å¤‡ä»½
    backup_file = backup_manager.full_backup()

    # éªŒè¯å¤‡ä»½
    if backup_file:
        backup_manager.verify_backup(backup_file)

    # æ¸…ç†æ—§å¤‡ä»½
    backup_manager.cleanup_old_backups(days=7)
    backup_manager.cleanup_old_wal(days=3)
```

#### 4.1.2 å¤‡ä»½è°ƒåº¦

**ä½¿ç”¨ cron è°ƒåº¦**:

```bash
# crontab -e

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œå®Œæ•´å¤‡ä»½
0 2 * * * /usr/bin/python3 /path/to/backup_manager.py full_backup >> /var/log/backup.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œç‰©ç†å¤‡ä»½
0 1 * * 0 /usr/bin/python3 /path/to/backup_manager.py physical_backup >> /var/log/backup.log 2>&1

# æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ¸…ç†æ—§å¤‡ä»½
0 3 * * * /usr/bin/python3 /path/to/backup_manager.py cleanup >> /var/log/backup.log 2>&1
```

**ä½¿ç”¨ systemd timer**:

```ini
# /etc/systemd/system/postgres-backup.service
[Unit]
Description=PostgreSQL Backup Service
After=postgresql.service

[Service]
Type=oneshot
ExecStart=/usr/bin/python3 /path/to/backup_manager.py full_backup
User=postgres
StandardOutput=journal
StandardError=journal

# /etc/systemd/system/postgres-backup.timer
[Unit]
Description=PostgreSQL Backup Timer
Requires=postgres-backup.service

[Timer]
OnCalendar=daily
OnCalendar=*-*-* 02:00:00
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target
```

### 4.2 å¤‡ä»½ç­–ç•¥é…ç½®

**å¤‡ä»½ç­–ç•¥é…ç½®**:

| å¤‡ä»½ç±»å‹     | é¢‘ç‡ | ä¿ç•™æ—¶é—´ | å­˜å‚¨ä½ç½®    |
| ------------ | ---- | -------- | ----------- |
| **å®Œæ•´å¤‡ä»½** | æ¯å¤© | 7 å¤©     | æœ¬åœ°        |
| **ç‰©ç†å¤‡ä»½** | æ¯å‘¨ | 30 å¤©    | æœ¬åœ° + è¿œç¨‹ |
| **WAL å½’æ¡£** | å®æ—¶ | 3 å¤©     | æœ¬åœ°        |
| **é•¿æœŸå¤‡ä»½** | æ¯æœˆ | 1 å¹´     | å½’æ¡£å­˜å‚¨    |

## 5. å¤‡ä»½éªŒè¯

### 5.1 å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥

#### 5.1.1 å¤‡ä»½æ–‡ä»¶éªŒè¯

**å¤‡ä»½æ–‡ä»¶éªŒè¯**:

```python
def verify_backup(backup_file):
    """éªŒè¯å¤‡ä»½æ–‡ä»¶"""
    try:
        # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(backup_file):
            logger.error(f"âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: {backup_file}")
            return False

        # 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size = os.path.getsize(backup_file)
        if file_size == 0:
            logger.error(f"âŒ å¤‡ä»½æ–‡ä»¶ä¸ºç©º: {backup_file}")
            return False

        # 3. å°è¯•åˆ—å‡ºå¤‡ä»½å†…å®¹
        result = subprocess.run(
            ["pg_restore", "-l", backup_file],
            capture_output=True,
            check=True,
            timeout=300
        )

        # 4. è§£æå¤‡ä»½å†…å®¹
        backup_items = result.stdout.decode().split('\n')
        item_count = len([item for item in backup_items if item.strip()])

        logger.info(f"âœ… å¤‡ä»½æ–‡ä»¶å®Œæ•´: {backup_file}")
        logger.info(f"   æ–‡ä»¶å¤§å°: {file_size / 1024 / 1024:.2f} MB")
        logger.info(f"   å¤‡ä»½é¡¹æ•°: {item_count}")

        return True

    except subprocess.CalledProcessError as e:
        logger.error(f"âŒ å¤‡ä»½æ–‡ä»¶æŸå: {backup_file}")
        logger.error(f"   é”™è¯¯: {e.stderr.decode()}")
        return False
    except Exception as e:
        logger.error(f"âŒ éªŒè¯å¤±è´¥: {str(e)}")
        return False
```

#### 5.1.2 å¤‡ä»½å†…å®¹éªŒè¯

**å¤‡ä»½å†…å®¹éªŒè¯**:

```python
def verify_backup_content(backup_file, expected_tables):
    """éªŒè¯å¤‡ä»½å†…å®¹"""
    try:
        # åˆ—å‡ºå¤‡ä»½ä¸­çš„è¡¨
        result = subprocess.run(
            ["pg_restore", "-l", backup_file],
            capture_output=True,
            check=True
        )

        backup_content = result.stdout.decode()

        # æ£€æŸ¥æ˜¯å¦åŒ…å«é¢„æœŸçš„è¡¨
        missing_tables = []
        for table in expected_tables:
            if table not in backup_content:
                missing_tables.append(table)

        if missing_tables:
            logger.warning(f"âš ï¸ å¤‡ä»½ä¸­ç¼ºå°‘è¡¨: {missing_tables}")
            return False
        else:
            logger.info(f"âœ… å¤‡ä»½åŒ…å«æ‰€æœ‰é¢„æœŸçš„è¡¨")
            return True

    except Exception as e:
        logger.error(f"âŒ éªŒè¯å¤±è´¥: {str(e)}")
        return False
```

### 5.2 æ¢å¤æµ‹è¯•

#### 5.2.1 æ¢å¤æµ‹è¯•æµç¨‹

**æ¢å¤æµ‹è¯•è„šæœ¬**:

```bash
#!/bin/bash
# restore_test.sh

BACKUP_FILE=$1
TEST_DB="test_restore_$(date +%Y%m%d_%H%M%S)"

echo "å¼€å§‹æ¢å¤æµ‹è¯•..."
echo "å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
echo "æµ‹è¯•æ•°æ®åº“: $TEST_DB"

# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb -U postgres "$TEST_DB"

# 2. æ¢å¤å¤‡ä»½
pg_restore -U postgres \
  -d "$TEST_DB" \
  -F c \
  "$BACKUP_FILE"

# 3. éªŒè¯æ•°æ®
echo "éªŒè¯æ•°æ®..."
psql -U postgres -d "$TEST_DB" <<EOF
SELECT
    COUNT(*) as total_tables
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_type = 'BASE TABLE';

SELECT
    schemaname,
    tablename,
    n_live_tup as row_count
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC
LIMIT 10;
EOF

# 4. æ¸…ç†æµ‹è¯•æ•°æ®åº“
echo "æ¸…ç†æµ‹è¯•æ•°æ®åº“..."
dropdb -U postgres "$TEST_DB"

echo "æ¢å¤æµ‹è¯•å®Œæˆ"
```

#### 5.2.2 æ•°æ®éªŒè¯

**æ•°æ®éªŒè¯æŸ¥è¯¢**:

```sql
-- éªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT
    schemaname,
    tablename,
    n_live_tup as row_count,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as table_size
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC;

-- éªŒè¯å‘é‡æ•°æ®
SELECT
    COUNT(*) as total_vectors,
    AVG(vector_dims) as avg_dimensions
FROM (
    SELECT
        pg_typeof(embedding)::text,
        array_length(embedding::text::int[], 1) as vector_dims
    FROM documents
    LIMIT 1000
) t;

-- éªŒè¯ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

## 6. å¤‡ä»½å­˜å‚¨ç­–ç•¥

### 6.1 æœ¬åœ°å­˜å‚¨

**æœ¬åœ°å­˜å‚¨é…ç½®**:

```bash
# æœ¬åœ°å¤‡ä»½ç›®å½•ç»“æ„
/backup/postgres/
â”œâ”€â”€ full_backup_20251101_020000.dump
â”œâ”€â”€ full_backup_20251102_020000.dump
â”œâ”€â”€ ...
â”œâ”€â”€ physical_backup_20251101_010000/
â”‚   â”œâ”€â”€ base.tar.gz
â”‚   â”œâ”€â”€ pg_wal.tar.gz
â”‚   â””â”€â”€ ...
â””â”€â”€ wal/
    â”œâ”€â”€ 000000010000000000000001
    â”œâ”€â”€ 000000010000000000000002
    â””â”€â”€ ...
```

**æœ¬åœ°å­˜å‚¨ç­–ç•¥**:

| å¤‡ä»½ç±»å‹     | ä¿ç•™æ—¶é—´ | å­˜å‚¨ç©ºé—´    | è¯´æ˜      |
| ------------ | -------- | ----------- | --------- |
| **å®Œæ•´å¤‡ä»½** | 7 å¤©     | çº¦ 10-50GB  | æ—¥å¸¸æ¢å¤  |
| **ç‰©ç†å¤‡ä»½** | 30 å¤©    | çº¦ 50-200GB | å¿«é€Ÿæ¢å¤  |
| **WAL å½’æ¡£** | 3 å¤©     | çº¦ 5-20GB   | PITR æ¢å¤ |

### 6.2 è¿œç¨‹å­˜å‚¨

**è¿œç¨‹å­˜å‚¨é…ç½®**:

```bash
# ä½¿ç”¨ rsync åŒæ­¥åˆ°è¿œç¨‹
rsync -av --delete \
  /backup/postgres/ \
  user@remote-backup:/backup/postgres/

# ä½¿ç”¨ S3 å­˜å‚¨
aws s3 sync \
  /backup/postgres/ \
  s3://backup-bucket/postgres/ \
  --storage-class STANDARD_IA

# ä½¿ç”¨äº‘å­˜å‚¨ï¼ˆå¦‚é˜¿é‡Œäº‘ OSSï¼‰
ossutil cp \
  /backup/postgres/ \
  oss://backup-bucket/postgres/ \
  --recursive
```

**è¿œç¨‹å­˜å‚¨ç­–ç•¥**:

| å­˜å‚¨ç±»å‹               | è®¿é—®é€Ÿåº¦ | æˆæœ¬   | é€‚ç”¨åœºæ™¯ |
| ---------------------- | -------- | ------ | -------- |
| **è¿œç¨‹æœåŠ¡å™¨**         | ä¸­       | ä½     | é•¿æœŸå¤‡ä»½ |
| **å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰** | ä¸­       | ä¸­     | äº‘ç«¯å¤‡ä»½ |
| **å½’æ¡£å­˜å‚¨**           | ä½       | **ä½** | é•¿æœŸå½’æ¡£ |

### 6.3 å¤‡ä»½ä¿ç•™ç­–ç•¥

**å¤‡ä»½ä¿ç•™ç­–ç•¥**:

| å¤‡ä»½ç±»å‹     | æœ¬åœ°ä¿ç•™ | è¿œç¨‹ä¿ç•™ | å½’æ¡£ä¿ç•™ |
| ------------ | -------- | -------- | -------- |
| **å®Œæ•´å¤‡ä»½** | 7 å¤©     | 30 å¤©    | 1 å¹´     |
| **ç‰©ç†å¤‡ä»½** | 7 å¤©     | 30 å¤©    | 6 ä¸ªæœˆ   |
| **WAL å½’æ¡£** | 3 å¤©     | 7 å¤©     | -        |

## 7. æœ€ä½³å®è·µ

### 7.1 å¤‡ä»½ç­–ç•¥

**å¤‡ä»½ç­–ç•¥æœ€ä½³å®è·µ**:

1. **å¤šé‡å¤‡ä»½**: ä½¿ç”¨å¤šç§å¤‡ä»½æ–¹å¼ï¼ˆé€»è¾‘å¤‡ä»½ + ç‰©ç†å¤‡ä»½ + WAL å½’æ¡£ï¼‰
2. **å®šæœŸå¤‡ä»½**: æ¯å¤©æ‰§è¡Œå®Œæ•´å¤‡ä»½ï¼Œæ¯å‘¨æ‰§è¡Œç‰©ç†å¤‡ä»½
3. **å¼‚åœ°å¤‡ä»½**: è‡³å°‘ä¸€ä»½å¤‡ä»½å­˜å‚¨åœ¨å¼‚åœ°
4. **å¤‡ä»½éªŒè¯**: å®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§
5. **è‡ªåŠ¨åŒ–**: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬å’Œè°ƒåº¦ç³»ç»Ÿ

**å¤‡ä»½é¢‘ç‡å»ºè®®**:

| æ•°æ®é‡è¦æ€§   | å¤‡ä»½é¢‘ç‡   | å¤‡ä»½æ–¹å¼            |
| ------------ | ---------- | ------------------- |
| **å…³é”®æ•°æ®** | æ¯å¤© + WAL | å®Œæ•´å¤‡ä»½ + WAL å½’æ¡£ |
| **é‡è¦æ•°æ®** | æ¯å¤©       | å®Œæ•´å¤‡ä»½            |
| **ä¸€èˆ¬æ•°æ®** | æ¯å‘¨       | å®Œæ•´å¤‡ä»½            |

### 7.2 æ¢å¤ç­–ç•¥

**æ¢å¤ç­–ç•¥æœ€ä½³å®è·µ**:

1. **æ¢å¤æµ‹è¯•**: æ¯æœˆè‡³å°‘æµ‹è¯•ä¸€æ¬¡æ¢å¤æµç¨‹
2. **æ–‡æ¡£è®°å½•**: è®°å½•æ¢å¤æµç¨‹å’Œæ—¶é—´
3. **æ¢å¤æ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ¢å¤æ¼”ç»ƒ
4. **ç›‘æ§å‘Šè­¦**: ç›‘æ§å¤‡ä»½çŠ¶æ€ï¼ŒåŠæ—¶å‘Šè­¦

### 7.3 å®¹ç¾æ¼”ç»ƒ

**å®¹ç¾æ¼”ç»ƒæ­¥éª¤**:

1. **å‡†å¤‡é˜¶æ®µ**: å‡†å¤‡å¤‡ä»½æ–‡ä»¶ã€æ¢å¤è„šæœ¬
2. **æ¼”ç»ƒæ‰§è¡Œ**: åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œæ¢å¤
3. **éªŒè¯é˜¶æ®µ**: éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œä¸šåŠ¡åŠŸèƒ½
4. **æ€»ç»“é˜¶æ®µ**: æ€»ç»“æ¼”ç»ƒç»“æœï¼Œä¼˜åŒ–æµç¨‹

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- [PostgreSQL å¤‡ä»½æ–‡æ¡£](https://www.postgresql.org/docs/current/backup.html) - Backup Documentation
- [pg_dump æ–‡æ¡£](https://www.postgresql.org/docs/current/app-pgdump.html) - pg_dump Documentation
- [pg_basebackup æ–‡æ¡£](https://www.postgresql.org/docs/current/app-pgbasebackup.html) -
  pg_basebackup Documentation
- [WAL å½’æ¡£æ–‡æ¡£](https://www.postgresql.org/docs/current/continuous-archiving.html) - Continuous
  Archiving

### 8.2 æŠ€æœ¯æ–‡æ¡£

- [ç›‘æ§ä¸å‘Šè­¦](./ç›‘æ§ä¸å‘Šè­¦.md) - Monitoring and Alerting
- [æ€§èƒ½ç›‘æ§](./æ€§èƒ½ç›‘æ§.md) - Performance Monitoring

### 8.3 ç›¸å…³èµ„æº

- [PostgreSQL å¤‡ä»½æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/backup-best-practices.html) -
  Backup Best Practices
- [PITR æ¢å¤æŒ‡å—](https://www.postgresql.org/docs/current/backup-pitr.html) - Point-in-Time Recovery

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team  
**æ–‡æ¡£ç¼–å·**: 09-02-03
