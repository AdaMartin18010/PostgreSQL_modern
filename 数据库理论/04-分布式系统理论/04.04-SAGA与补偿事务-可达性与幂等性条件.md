# SAGAä¸è¡¥å¿äº‹åŠ¡-å¯è¾¾æ€§ä¸å¹‚ç­‰æ€§æ¡ä»¶

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”

---

## ğŸ“‹ ç›®å½•

- [SAGAä¸è¡¥å¿äº‹åŠ¡-å¯è¾¾æ€§ä¸å¹‚ç­‰æ€§æ¡ä»¶](#sagaä¸è¡¥å¿äº‹åŠ¡-å¯è¾¾æ€§ä¸å¹‚ç­‰æ€§æ¡ä»¶)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 SAGAä¸è¡¥å¿äº‹åŠ¡å·¥ä½œåŸç†æ¦‚è¿°](#10-sagaä¸è¡¥å¿äº‹åŠ¡å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 SAGAæ¨¡å¼](#21-sagaæ¨¡å¼)
    - [2.2 å¯è¾¾æ€§](#22-å¯è¾¾æ€§)
    - [2.3 å¹‚ç­‰æ€§](#23-å¹‚ç­‰æ€§)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 SAGAå½¢å¼åŒ–](#31-sagaå½¢å¼åŒ–)
    - [3.2 å¯è¾¾æ€§å½¢å¼åŒ–](#32-å¯è¾¾æ€§å½¢å¼åŒ–)
    - [3.3 å¹‚ç­‰æ€§å½¢å¼åŒ–](#33-å¹‚ç­‰æ€§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 å¯è¾¾æ€§å®šç†](#41-å¯è¾¾æ€§å®šç†)
    - [4.2 å¹‚ç­‰æ€§æ¡ä»¶å®šç†](#42-å¹‚ç­‰æ€§æ¡ä»¶å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18 SAGAæ¨¡å¼å®ç°è¯¦è§£](#51-postgresql-18-sagaæ¨¡å¼å®ç°è¯¦è§£)
    - [5.2 SQLite 3.45 äº‹åŠ¡å¤„ç†å¯¹æ¯”](#52-sqlite-345-äº‹åŠ¡å¤„ç†å¯¹æ¯”)
    - [5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹](#53-å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹)
      - [åœºæ™¯1ï¼šç”µå•†è®¢å•å¤„ç†çš„SAGAæ¨¡å¼](#åœºæ™¯1ç”µå•†è®¢å•å¤„ç†çš„sagaæ¨¡å¼)
      - [åœºæ™¯2ï¼šå¾®æœåŠ¡æ¶æ„çš„SAGAç¼–æ’](#åœºæ™¯2å¾®æœåŠ¡æ¶æ„çš„sagaç¼–æ’)
    - [5.4 SAGAæœ€ä½³å®è·µ](#54-sagaæœ€ä½³å®è·µ)
    - [5.5 æ¨¡å‹é€‰æ‹©å»ºè®®](#55-æ¨¡å‹é€‰æ‹©å»ºè®®)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 å¾®æœåŠ¡æ¶æ„ç›¸å…³](#72-å¾®æœåŠ¡æ¶æ„ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 SAGAä¸è¡¥å¿äº‹åŠ¡å·¥ä½œåŸç†æ¦‚è¿°

**SAGAæ¨¡å¼**ï¼š

SAGAæ˜¯ä¸€ç§é•¿äº‹åŠ¡å¤„ç†æ¨¡å¼ï¼Œé€šè¿‡å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¹¶ä½¿ç”¨è¡¥å¿äº‹åŠ¡æ¥å¤„ç†å¤±è´¥æƒ…å†µã€‚æœ¬æ–‡æ¡£ä¸¥æ ¼è¯æ˜SAGAçš„å¯è¾¾æ€§å’Œè¡¥å¿äº‹åŠ¡çš„å¹‚ç­‰æ€§æ¡ä»¶ã€‚

**SAGAæ‰§è¡Œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹SAGA] --> B[æ‰§è¡Œäº‹åŠ¡1]
    B --> C{æˆåŠŸ?}
    C -->|æ˜¯| D[æ‰§è¡Œäº‹åŠ¡2]
    C -->|å¦| E[æ‰§è¡Œè¡¥å¿1]
    D --> F{æˆåŠŸ?}
    F -->|æ˜¯| G[æ‰§è¡Œäº‹åŠ¡3]
    F -->|å¦| H[æ‰§è¡Œè¡¥å¿2]
    G --> I{æˆåŠŸ?}
    I -->|æ˜¯| J[SAGAå®Œæˆ]
    I -->|å¦| K[æ‰§è¡Œè¡¥å¿3]
    E --> L[SAGAä¸­æ­¢]
    H --> M[æ‰§è¡Œè¡¥å¿1]
    K --> N[æ‰§è¡Œè¡¥å¿2]
    M --> L
    N --> O[æ‰§è¡Œè¡¥å¿1]
    O --> L

    style A fill:#FFD700
    style J fill:#87CEEB
    style L fill:#FF6B6B
```

**è¡¥å¿äº‹åŠ¡å¹‚ç­‰æ€§**ï¼š

```mermaid
flowchart TD
    A[è¡¥å¿äº‹åŠ¡] --> B[æ£€æŸ¥çŠ¶æ€]
    B --> C{å·²è¡¥å¿?}
    C -->|æ˜¯| D[è·³è¿‡æ‰§è¡Œ]
    C -->|å¦| E[æ‰§è¡Œè¡¥å¿]
    E --> F[æ ‡è®°å·²è¡¥å¿]
    D --> G[å¹‚ç­‰å®Œæˆ]
    F --> G

    style A fill:#FFD700
    style G fill:#87CEEB
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **SAGAæ¨¡å¼**ï¼šSAGAæ¨¡å¼çš„å®Œæ•´æè¿°
- **å¯è¾¾æ€§**ï¼šä¸¥æ ¼è¯æ˜SAGAçš„å¯è¾¾æ€§æ¡ä»¶
- **å¹‚ç­‰æ€§**ï¼šè¡¥å¿äº‹åŠ¡çš„å¹‚ç­‰æ€§æ¡ä»¶å’Œè¯æ˜
- **å®é™…åº”ç”¨**ï¼šSAGAåœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 SAGAæ¨¡å¼

**SAGAå®šä¹‰**ï¼š

```haskell
-- SAGAäº‹åŠ¡
data Saga = Saga {
    steps :: [SagaStep],
    compensations :: [Compensation]
}

-- SAGAæ­¥éª¤
data SagaStep = SagaStep {
    transaction :: Transaction,
    compensation :: Compensation
}

-- è¡¥å¿äº‹åŠ¡
data Compensation = Compensation {
    action :: Action,
    idempotent :: Bool
}
```

**SAGAæ‰§è¡ŒçŠ¶æ€æœº**ï¼š

```mermaid
stateDiagram-v2
    [*] --> Initial
    Initial --> Step1: æ‰§è¡Œäº‹åŠ¡1
    Step1 --> Step2: æˆåŠŸ
    Step1 --> Compensate1: å¤±è´¥
    Step2 --> Step3: æˆåŠŸ
    Step2 --> Compensate2: å¤±è´¥
    Step3 --> Completed: æˆåŠŸ
    Step3 --> Compensate3: å¤±è´¥
    Compensate3 --> Compensate2
    Compensate2 --> Compensate1
    Compensate1 --> Aborted
    Completed --> [*]
    Aborted --> [*]
```

### 2.2 å¯è¾¾æ€§

**å¯è¾¾æ€§å®šä¹‰**ï¼š

```haskell
-- å¯è¾¾æ€§
reachable :: Saga -> State -> Bool
reachable saga target =
    exists execution path from initial state to target state
```

**å¯è¾¾æ€§åˆ†æ**ï¼š

```mermaid
flowchart TD
    A[åˆå§‹çŠ¶æ€] --> B[æ‰§è¡Œæ­¥éª¤1]
    B --> C{æˆåŠŸ?}
    C -->|æ˜¯| D[æ‰§è¡Œæ­¥éª¤2]
    C -->|å¦| E[è¡¥å¿æ­¥éª¤1]
    D --> F{æˆåŠŸ?}
    F -->|æ˜¯| G[æ‰§è¡Œæ­¥éª¤3]
    F -->|å¦| H[è¡¥å¿æ­¥éª¤2]
    G --> I{æˆåŠŸ?}
    I -->|æ˜¯| J[å®ŒæˆçŠ¶æ€]
    I -->|å¦| K[è¡¥å¿æ­¥éª¤3]
    E --> L[ä¸­æ­¢çŠ¶æ€]
    H --> M[è¡¥å¿æ­¥éª¤1]
    K --> N[è¡¥å¿æ­¥éª¤2]
    M --> L
    N --> M

    style A fill:#FFD700
    style J fill:#90EE90
    style L fill:#FF6B6B
```

### 2.3 å¹‚ç­‰æ€§

**å¹‚ç­‰æ€§æ¡ä»¶**ï¼š

```haskell
-- å¹‚ç­‰æ€§
idempotent :: Compensation -> Bool
idempotent comp =
    forall state s:
        comp(comp(s)) = comp(s)
```

**å¹‚ç­‰æ€§ä¿è¯ç­–ç•¥**ï¼š

| ç­–ç•¥ | æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **çŠ¶æ€æ£€æŸ¥** | æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ | ç®€å• | éœ€è¦çŠ¶æ€å­˜å‚¨ |
| **ç‰ˆæœ¬å·** | ä½¿ç”¨ç‰ˆæœ¬å·æ ‡è®° | å¯é  | éœ€è¦ç‰ˆæœ¬ç®¡ç† |
| **å¹‚ç­‰é”®** | ä½¿ç”¨å”¯ä¸€é”® | é«˜æ•ˆ | éœ€è¦é”®ç”Ÿæˆ |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 SAGAå½¢å¼åŒ–

**SAGA**ï¼š

```haskell
-- SAGAå½¢å¼åŒ–
SAGA = (S, T, C, â†’)
where
    S = {s0, s1, ..., sn}  -- çŠ¶æ€é›†åˆ
    T = {t1, t2, ..., tn}  -- äº‹åŠ¡é›†åˆ
    C = {c1, c2, ..., cn}  -- è¡¥å¿é›†åˆ
    â†’ = transition relation
```

### 3.2 å¯è¾¾æ€§å½¢å¼åŒ–

**å¯è¾¾æ€§**ï¼š

```haskell
-- å¯è¾¾æ€§
reachable(saga, s) =
    exists path p: s0 â†’* s
    where â†’* is reflexive transitive closure
```

### 3.3 å¹‚ç­‰æ€§å½¢å¼åŒ–

**å¹‚ç­‰æ€§**ï¼š

```haskell
-- å¹‚ç­‰æ€§
idempotent(c) =
    forall s: c(c(s)) = c(s)
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 å¯è¾¾æ€§å®šç†

**å®šç†**ï¼šå¦‚æœæ‰€æœ‰è¡¥å¿äº‹åŠ¡éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œåˆ™SAGAå¯ä»¥ä»ä»»ä½•ä¸­é—´çŠ¶æ€åˆ°è¾¾å®Œæˆæˆ–ä¸­æ­¢çŠ¶æ€ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾SAGA = (S, T, C, â†’)ï¼Œå…¶ä¸­Sæ˜¯çŠ¶æ€é›†åˆï¼ŒTæ˜¯äº‹åŠ¡é›†åˆï¼ŒCæ˜¯è¡¥å¿é›†åˆï¼Œâ†’æ˜¯çŠ¶æ€è½¬æ¢å…³ç³»ã€‚å¦‚æœæ‰€æœ‰è¡¥å¿c âˆˆ Céƒ½æ˜¯å¹‚ç­‰çš„ï¼Œåˆ™å¯¹äºä»»æ„çŠ¶æ€s âˆˆ Sï¼Œå­˜åœ¨è·¯å¾„ä»såˆ°è¾¾å®ŒæˆçŠ¶æ€s_completedæˆ–ä¸­æ­¢çŠ¶æ€s_abortedã€‚

**å®šä¹‰**ï¼š

- **çŠ¶æ€é›†åˆ**ï¼šS = {sâ‚€, sâ‚, ..., sâ‚™, s_completed, s_aborted}
- **çŠ¶æ€è½¬æ¢**ï¼šs â†’ s' è¡¨ç¤ºä»çŠ¶æ€sè½¬æ¢åˆ°çŠ¶æ€s'
- **å¯è¾¾æ€§**ï¼šreachable(s, s') = å­˜åœ¨è·¯å¾„s â†’*s'ï¼ˆâ†’*æ˜¯ä¼ é€’é—­åŒ…ï¼‰
- **å¹‚ç­‰æ€§**ï¼šidempotent(c) = âˆ€s: c(c(s)) = c(s)

**è¯æ˜**ï¼ˆæ„é€ æ€§è¯æ˜ï¼‰ï¼š

**æ­¥éª¤1ï¼šåˆ†æSAGAçŠ¶æ€ç©ºé—´**:

- SAGAçš„çŠ¶æ€ç©ºé—´æ˜¯ä¸€ä¸ªæœ‰å‘å›¾G = (S, â†’)
- åˆå§‹çŠ¶æ€sâ‚€ï¼šSAGAå¼€å§‹
- ä¸­é—´çŠ¶æ€sâ‚, sâ‚‚, ..., sâ‚™ï¼šæ‰§è¡Œéƒ¨åˆ†äº‹åŠ¡åçš„çŠ¶æ€
- å®ŒæˆçŠ¶æ€s_completedï¼šæ‰€æœ‰äº‹åŠ¡æˆåŠŸæ‰§è¡Œ
- ä¸­æ­¢çŠ¶æ€s_abortedï¼šæ‰€æœ‰è¡¥å¿æ‰§è¡Œå®Œæˆ

**æ­¥éª¤2ï¼šè¯æ˜ä»ä¸­é—´çŠ¶æ€å¯è¾¾ä¸­æ­¢çŠ¶æ€**:

- å¯¹äºä»»æ„ä¸­é—´çŠ¶æ€sáµ¢ï¼ˆi > 0ï¼‰ï¼š
  - è®¾sáµ¢æ˜¯é€šè¿‡æ‰§è¡Œäº‹åŠ¡tâ‚, tâ‚‚, ..., táµ¢åˆ°è¾¾çš„
  - ç”±äºè¡¥å¿å¹‚ç­‰æ€§ï¼Œå¯ä»¥æ‰§è¡Œè¡¥å¿cáµ¢, cáµ¢â‚‹â‚, ..., câ‚
  - æ‰§è¡Œè·¯å¾„ï¼šsáµ¢ â†’[cáµ¢] sáµ¢â‚‹â‚ â†’[cáµ¢â‚‹â‚] ... â†’[câ‚] sâ‚€ â†’[abort] s_aborted
  - ç”±äºè¡¥å¿å¹‚ç­‰ï¼Œå³ä½¿é‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šæ”¹å˜çŠ¶æ€
  - å› æ­¤ï¼Œä»sáµ¢å¯ä»¥åˆ°è¾¾s_aborted

**æ­¥éª¤3ï¼šè¯æ˜ä»ä¸­é—´çŠ¶æ€å¯è¾¾å®ŒæˆçŠ¶æ€**:

- å¯¹äºä»»æ„ä¸­é—´çŠ¶æ€sáµ¢ï¼š
  - å¦‚æœåç»­äº‹åŠ¡táµ¢â‚Šâ‚, táµ¢â‚Šâ‚‚, ..., tâ‚™éƒ½æˆåŠŸæ‰§è¡Œ
  - æ‰§è¡Œè·¯å¾„ï¼šsáµ¢ â†’[táµ¢â‚Šâ‚] sáµ¢â‚Šâ‚ â†’[táµ¢â‚Šâ‚‚] ... â†’[tâ‚™] s_completed
  - å› æ­¤ï¼Œä»sáµ¢å¯ä»¥åˆ°è¾¾s_completed

**æ­¥éª¤4ï¼šå¤„ç†æ•…éšœæƒ…å†µ**:

- å¦‚æœåœ¨æ‰§è¡Œtâ±¼ï¼ˆj > iï¼‰æ—¶å¤±è´¥ï¼š
  - çŠ¶æ€ä»sâ±¼â‚‹â‚è½¬æ¢åˆ°æ•…éšœçŠ¶æ€s_failed
  - ç”±äºè¡¥å¿å¹‚ç­‰æ€§ï¼Œå¯ä»¥æ‰§è¡Œè¡¥å¿câ±¼, câ±¼â‚‹â‚, ..., cáµ¢â‚Šâ‚
  - æ‰§è¡Œè·¯å¾„ï¼šs_failed â†’[câ±¼] sâ±¼â‚‹â‚ â†’[câ±¼â‚‹â‚] ... â†’[cáµ¢â‚Šâ‚] sáµ¢ â†’[ç»§ç»­è¡¥å¿] s_aborted
  - å› æ­¤ï¼Œä»æ•…éšœçŠ¶æ€å¯ä»¥åˆ°è¾¾s_aborted

**æ­¥éª¤5ï¼šè¯æ˜è·¯å¾„çš„å”¯ä¸€æ€§ï¼ˆåœ¨ç»™å®šæ‰§è¡Œåºåˆ—ä¸‹ï¼‰**:

- å¯¹äºç»™å®šçš„æ‰§è¡Œåºåˆ—ï¼Œä»ä»»æ„çŠ¶æ€sáµ¢åˆ°ç›®æ ‡çŠ¶æ€çš„è·¯å¾„æ˜¯å”¯ä¸€çš„
- å¦‚æœç›®æ ‡æ˜¯å®Œæˆï¼Œè·¯å¾„æ˜¯ï¼šsáµ¢ â†’ sáµ¢â‚Šâ‚ â†’ ... â†’ s_completed
- å¦‚æœç›®æ ‡æ˜¯ä¸­æ­¢ï¼Œè·¯å¾„æ˜¯ï¼šsáµ¢ â†’ sáµ¢â‚‹â‚ â†’ ... â†’ s_aborted
- ç”±äºè¡¥å¿å¹‚ç­‰æ€§ï¼Œè·¯å¾„ä¸ä¼šå› ä¸ºé‡å¤æ‰§è¡Œè€Œæ”¹å˜

**æ­¥éª¤6ï¼šç»“è®º**:

- å¯¹äºä»»æ„ä¸­é—´çŠ¶æ€sáµ¢ï¼Œéƒ½å­˜åœ¨è·¯å¾„åˆ°è¾¾s_completedæˆ–s_aborted
- å› æ­¤ï¼ŒSAGAçš„å¯è¾¾æ€§å¾—åˆ°ä¿è¯
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å¯è¾¾æ€§å®šç†] --> B[åˆ†æSAGAçŠ¶æ€ç©ºé—´]
    B --> C[ä¸­é—´çŠ¶æ€sáµ¢]
    C --> D{ç›®æ ‡çŠ¶æ€}
    D -->|å®Œæˆ| E[æ‰§è¡Œåç»­äº‹åŠ¡]
    D -->|ä¸­æ­¢| F[æ‰§è¡Œè¡¥å¿äº‹åŠ¡]
    E --> G[sáµ¢ â†’ sáµ¢â‚Šâ‚ â†’ ... â†’ s_completed]
    F --> H[sáµ¢ â†’ sáµ¢â‚‹â‚ â†’ ... â†’ s_aborted]
    G --> I[å¯è¾¾å®ŒæˆçŠ¶æ€]
    H --> J[å¯è¾¾ä¸­æ­¢çŠ¶æ€]
    I --> K[å¯è¾¾æ€§ä¿è¯]
    J --> K

    style A fill:#FFD700
    style K fill:#90EE90
```

### 4.2 å¹‚ç­‰æ€§æ¡ä»¶å®šç†

**å®šç†**ï¼šè¡¥å¿äº‹åŠ¡å¹‚ç­‰å½“ä¸”ä»…å½“æ‰§è¡Œç»“æœä¸ä¾èµ–äºæ‰§è¡Œæ¬¡æ•°ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾è¡¥å¿äº‹åŠ¡cï¼Œåˆ™idempotent(c) âŸº âˆ€s, n, m: câ¿(s) = cáµ(s)ï¼Œå…¶ä¸­n, m â‰¥ 1ï¼Œcâ¿è¡¨ç¤ºæ‰§è¡Œnæ¬¡cã€‚

**å®šä¹‰**ï¼š

- **è¡¥å¿äº‹åŠ¡**ï¼šc: State â†’ State
- **å¹‚ç­‰æ€§**ï¼šidempotent(c) = âˆ€s: c(c(s)) = c(s)
- **æ‰§è¡Œç»“æœ**ï¼šresult(c, s, n) = câ¿(s)ï¼ˆæ‰§è¡Œnæ¬¡cåçš„çŠ¶æ€ï¼‰

**è¯æ˜**ï¼ˆåŒå‘è¯æ˜ï¼‰ï¼š

**æ­£å‘è¯æ˜ï¼šå¹‚ç­‰ âŸ¹ ç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•°**:

**æ­¥éª¤1ï¼šå‡è®¾è¡¥å¿cæ˜¯å¹‚ç­‰çš„**:

- å‡è®¾idempotent(c)ï¼Œå³âˆ€s: c(c(s)) = c(s)

**æ­¥éª¤2ï¼šè¯æ˜cÂ²(s) = c(s)**:

- å¯¹äºä»»æ„çŠ¶æ€sï¼š
  - cÂ²(s) = c(c(s))
  - æ ¹æ®å¹‚ç­‰æ€§ï¼Œc(c(s)) = c(s)
  - å› æ­¤ï¼ŒcÂ²(s) = c(s)

**æ­¥éª¤3ï¼šå½’çº³è¯æ˜câ¿(s) = c(s)**:

- **åŸºç¡€æƒ…å†µ**ï¼šcÂ¹(s) = c(s)ï¼ˆæ˜¾ç„¶æˆç«‹ï¼‰
- **å½’çº³å‡è®¾**ï¼šå‡è®¾cáµ(s) = c(s)å¯¹äºk â‰¥ 1æˆç«‹
- **å½’çº³æ­¥éª¤**ï¼š
  - cáµâºÂ¹(s) = c(cáµ(s))
  - æ ¹æ®å½’çº³å‡è®¾ï¼Œcáµ(s) = c(s)
  - å› æ­¤ï¼ŒcáµâºÂ¹(s) = c(c(s))
  - æ ¹æ®å¹‚ç­‰æ€§ï¼Œc(c(s)) = c(s)
  - å› æ­¤ï¼ŒcáµâºÂ¹(s) = c(s)

**æ­¥éª¤4ï¼šå¾—å‡ºç»“è®º**:

- å¯¹äºä»»æ„n, m â‰¥ 1ï¼Œcâ¿(s) = c(s) = cáµ(s)
- å› æ­¤ï¼Œæ‰§è¡Œç»“æœä¸ä¾èµ–äºæ‰§è¡Œæ¬¡æ•°
- è¯æ¯•ï¼ˆæ­£å‘ï¼‰

**åå‘è¯æ˜ï¼šç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•° âŸ¹ å¹‚ç­‰**:

**æ­¥éª¤1ï¼šå‡è®¾æ‰§è¡Œç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•°**:

- å‡è®¾âˆ€s, n, m: câ¿(s) = cáµ(s)

**æ­¥éª¤2ï¼šç‰¹æ®Šæƒ…å†µï¼šn=1, m=2**:

- å¯¹äºä»»æ„çŠ¶æ€sï¼š
  - cÂ¹(s) = cÂ²(s)ï¼ˆæ ¹æ®å‡è®¾ï¼‰
  - cÂ²(s) = c(c(s))
  - å› æ­¤ï¼Œc(s) = c(c(s))

**æ­¥éª¤3ï¼šå¾—å‡ºç»“è®º**:

- å¯¹äºä»»æ„çŠ¶æ€sï¼Œc(c(s)) = c(s)
- å› æ­¤ï¼Œè¡¥å¿cæ˜¯å¹‚ç­‰çš„
- è¯æ¯•ï¼ˆåå‘ï¼‰

**æ­¥éª¤4ï¼šå……è¦å…³ç³»**:

- ç”±æ­£å‘å’Œåå‘è¯æ˜ï¼Œå¹‚ç­‰æ€§ âŸº ç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•°
- è¯æ¯•

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[å¹‚ç­‰æ€§ âŸº ç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•°] --> B[æ­£å‘ï¼šå¹‚ç­‰ âŸ¹ ç»“æœä¸ä¾èµ–]
    A --> C[åå‘ï¼šç»“æœä¸ä¾èµ– âŸ¹ å¹‚ç­‰]
    B --> D[å¹‚ç­‰æ€§ï¼šc c s = c s]
    D --> E[å½’çº³è¯æ˜ï¼šcâ¿ s = c s]
    E --> F[ç»“æœä¸ä¾èµ–æ‰§è¡Œæ¬¡æ•°]
    C --> G[å‡è®¾ï¼šcâ¿ s = cáµ s]
    G --> H[ç‰¹æ®Šæƒ…å†µï¼šc s = cÂ² s]
    H --> I[å¹‚ç­‰æ€§ï¼šc c s = c s]
    F --> J[å……è¦å…³ç³»æˆç«‹]
    I --> J

    style A fill:#FFD700
    style J fill:#90EE90
```

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18 SAGAæ¨¡å¼å®ç°è¯¦è§£

**PostgreSQL 18 SAGAæ”¯æŒ**ï¼š

PostgreSQL 18æœ¬èº«ä¸ç›´æ¥æ”¯æŒSAGAæ¨¡å¼ï¼Œä½†å¯ä»¥é€šè¿‡åº”ç”¨å±‚å®ç°SAGAæ¨¡å¼ã€‚PostgreSQL 18æä¾›äº†äº‹åŠ¡ã€å‡½æ•°ã€è§¦å‘å™¨ç­‰æœºåˆ¶æ¥æ”¯æŒSAGAå®ç°ã€‚

**PostgreSQL 18 SAGAå®ç°æ¶æ„**ï¼š

```sql
-- åˆ›å»ºSAGAçŠ¶æ€è¡¨
CREATE TABLE saga_state (
    saga_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    saga_name VARCHAR(100),
    current_step INTEGER DEFAULT 0,
    total_steps INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, in_progress, completed, aborted
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºSAGAæ­¥éª¤è¡¨
CREATE TABLE saga_steps (
    id BIGSERIAL PRIMARY KEY,
    saga_id UUID REFERENCES saga_state(saga_id),
    step_number INTEGER NOT NULL,
    step_name VARCHAR(100),
    transaction_sql TEXT,
    compensation_sql TEXT,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, executed, compensated
    executed_at TIMESTAMPTZ,
    compensated_at TIMESTAMPTZ,
    UNIQUE(saga_id, step_number)
);

-- åˆ›å»ºè¡¥å¿æ—¥å¿—è¡¨
CREATE TABLE compensation_log (
    id BIGSERIAL PRIMARY KEY,
    saga_id UUID REFERENCES saga_state(saga_id),
    step_number INTEGER NOT NULL,
    compensation_sql TEXT,
    executed BOOLEAN DEFAULT FALSE,
    execution_count INTEGER DEFAULT 0,
    first_executed_at TIMESTAMPTZ,
    last_executed_at TIMESTAMPTZ,
    UNIQUE(saga_id, step_number)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_saga_state_status ON saga_state(status);
CREATE INDEX idx_saga_steps_saga ON saga_steps(saga_id, step_number);
CREATE INDEX idx_compensation_log_saga ON compensation_log(saga_id, step_number);
```

**PostgreSQL 18 SAGAæ‰§è¡Œå‡½æ•°**ï¼š

```sql
-- SAGAæ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_saga_step(
    p_saga_id UUID,
    p_step_number INTEGER
) RETURNS BOOLEAN AS $$
DECLARE
    v_step_record RECORD;
    v_result BOOLEAN := FALSE;
BEGIN
    -- è·å–æ­¥éª¤ä¿¡æ¯
    SELECT * INTO v_step_record
    FROM saga_steps
    WHERE saga_id = p_saga_id AND step_number = p_step_number;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Step % not found for saga %', p_step_number, p_saga_id;
    END IF;

    -- æ‰§è¡Œäº‹åŠ¡æ­¥éª¤
    BEGIN
        EXECUTE v_step_record.transaction_sql;

        -- æ›´æ–°æ­¥éª¤çŠ¶æ€
        UPDATE saga_steps
        SET status = 'executed', executed_at = NOW()
        WHERE saga_id = p_saga_id AND step_number = p_step_number;

        -- æ›´æ–°SAGAçŠ¶æ€
        UPDATE saga_state
        SET current_step = p_step_number,
            status = CASE
                WHEN p_step_number = total_steps THEN 'completed'
                ELSE 'in_progress'
            END,
            updated_at = NOW()
        WHERE saga_id = p_saga_id;

        v_result := TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            -- æ‰§è¡Œè¡¥å¿
            PERFORM execute_compensation(p_saga_id, p_step_number);
            v_result := FALSE;
    END;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

**PostgreSQL 18 å¹‚ç­‰è¡¥å¿å‡½æ•°**ï¼š

```sql
-- å¹‚ç­‰è¡¥å¿å‡½æ•°
CREATE OR REPLACE FUNCTION idempotent_compensate(
    p_saga_id UUID,
    p_step_number INTEGER
) RETURNS VOID AS $$
DECLARE
    v_compensation_record RECORD;
    v_executed BOOLEAN;
    v_execution_count INTEGER;
BEGIN
    -- æ£€æŸ¥è¡¥å¿æ—¥å¿—
    SELECT executed, execution_count INTO v_executed, v_execution_count
    FROM compensation_log
    WHERE saga_id = p_saga_id AND step_number = p_step_number;

    -- å¦‚æœä¸å­˜åœ¨è®°å½•ï¼Œåˆ›å»ºè®°å½•
    IF NOT FOUND THEN
        INSERT INTO compensation_log (saga_id, step_number, compensation_sql, executed, execution_count)
        SELECT p_saga_id, p_step_number, compensation_sql, FALSE, 0
        FROM saga_steps
        WHERE saga_id = p_saga_id AND step_number = p_step_number;

        v_executed := FALSE;
        v_execution_count := 0;
    END IF;

    -- å¹‚ç­‰æ€§æ£€æŸ¥ï¼šå¦‚æœå·²æ‰§è¡Œï¼Œè·³è¿‡
    IF v_executed THEN
        -- æ›´æ–°æ‰§è¡Œè®¡æ•°ï¼ˆç”¨äºç›‘æ§ï¼‰
        UPDATE compensation_log
        SET execution_count = execution_count + 1,
            last_executed_at = NOW()
        WHERE saga_id = p_saga_id AND step_number = p_step_number;

        RETURN;  -- å¹‚ç­‰ï¼šå·²æ‰§è¡Œï¼Œè·³è¿‡
    END IF;

    -- æ‰§è¡Œè¡¥å¿
    BEGIN
        SELECT compensation_sql INTO v_compensation_record.compensation_sql
        FROM saga_steps
        WHERE saga_id = p_saga_id AND step_number = p_step_number;

        EXECUTE v_compensation_record.compensation_sql;

        -- æ ‡è®°å·²æ‰§è¡Œ
        UPDATE compensation_log
        SET executed = TRUE,
            execution_count = 1,
            first_executed_at = NOW(),
            last_executed_at = NOW()
        WHERE saga_id = p_saga_id AND step_number = p_step_number;

        -- æ›´æ–°æ­¥éª¤çŠ¶æ€
        UPDATE saga_steps
        SET status = 'compensated', compensated_at = NOW()
        WHERE saga_id = p_saga_id AND step_number = p_step_number;
    EXCEPTION
        WHEN OTHERS THEN
            -- è¡¥å¿å¤±è´¥ï¼Œè®°å½•é”™è¯¯
            RAISE EXCEPTION 'Compensation failed for saga %, step %: %',
                p_saga_id, p_step_number, SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 SQLite 3.45 äº‹åŠ¡å¤„ç†å¯¹æ¯”

**SQLite 3.45 SAGAæ”¯æŒ**ï¼š

SQLite 3.45**ä¸æ”¯æŒSAGAæ¨¡å¼**ï¼Œåªæ”¯æŒæœ¬åœ°äº‹åŠ¡ã€‚SAGAæ¨¡å¼éœ€è¦åœ¨åº”ç”¨å±‚å®ç°ã€‚

| ç‰¹æ€§ | PostgreSQL 18 | SQLite 3.45 |
|------|--------------|-------------|
| **SAGAæ”¯æŒ** | âœ… åº”ç”¨å±‚å®ç° | âš ï¸ åº”ç”¨å±‚å®ç°ï¼ˆæœ‰é™ï¼‰ |
| **å‡½æ•°æ”¯æŒ** | âœ… å®Œæ•´æ”¯æŒ | âš ï¸ æœ‰é™æ”¯æŒ |
| **UUIDæ”¯æŒ** | âœ… åŸç”Ÿæ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **äº‹åŠ¡åµŒå¥—** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **è¡¥å¿æ—¥å¿—** | âœ… å®Œæ•´æ”¯æŒ | âš ï¸ éœ€è¦åº”ç”¨å±‚å®ç° |

**SQLite 3.45æ›¿ä»£æ–¹æ¡ˆ**ï¼š

```sql
-- SQLite 3.45ï¼šç®€åŒ–çš„SAGAå®ç°
-- åˆ›å»ºSAGAçŠ¶æ€è¡¨
CREATE TABLE saga_state (
    saga_id TEXT PRIMARY KEY,
    current_step INTEGER DEFAULT 0,
    status TEXT DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- SQLite 3.45ï¼šä½¿ç”¨TEXTä½œä¸ºIDï¼ˆæ— UUIDï¼‰
-- ä½¿ç”¨åº”ç”¨å±‚ç”Ÿæˆå”¯ä¸€ID
-- SAGAæ‰§è¡Œé€»è¾‘éœ€è¦åœ¨åº”ç”¨å±‚å®ç°
```

### 5.3 å®é™…ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

#### åœºæ™¯1ï¼šç”µå•†è®¢å•å¤„ç†çš„SAGAæ¨¡å¼

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- ç”µå•†è®¢å•å¤„ç†æ¶‰åŠå¤šä¸ªæœåŠ¡ï¼šè®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç‰©æµæœåŠ¡
- éœ€è¦ä¿è¯è®¢å•åˆ›å»ºçš„åŸå­æ€§
- å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œéœ€è¦å›æ»šæ‰€æœ‰å·²æ‰§è¡Œçš„æ­¥éª¤

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å®ç°è·¨æœåŠ¡çš„SAGAæ¨¡å¼
- ä¿è¯è¡¥å¿äº‹åŠ¡çš„å¹‚ç­‰æ€§
- å¤„ç†æœåŠ¡æ•…éšœå’Œç½‘ç»œåˆ†åŒº

**PostgreSQL 18å®ç°**ï¼š

```sql
-- è®¢å•æœåŠ¡æ•°æ®åº“
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    customer_id BIGINT,
    total_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åº“å­˜æœåŠ¡æ•°æ®åº“
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    product_name VARCHAR(200),
    stock_quantity INTEGER NOT NULL DEFAULT 0
);

-- æ”¯ä»˜æœåŠ¡æ•°æ®åº“
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    payment_id VARCHAR(50) UNIQUE NOT NULL,
    order_id BIGINT,
    amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åœºæ™¯ï¼šè®¢å•åˆ›å»ºSAGA
-- æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
INSERT INTO saga_state (saga_id, saga_name, total_steps, status)
VALUES ('saga_001', 'order_creation', 3, 'pending');

INSERT INTO saga_steps (saga_id, step_number, step_name, transaction_sql, compensation_sql)
VALUES
    ('saga_001', 1, 'create_order',
     'INSERT INTO orders (order_number, customer_id, total_amount, status) VALUES (''ORD001'', 1, 1000.00, ''processing'')',
     'DELETE FROM orders WHERE order_number = ''ORD001'''),
    ('saga_001', 2, 'reduce_stock',
     'UPDATE products SET stock_quantity = stock_quantity - 10 WHERE id = 1',
     'UPDATE products SET stock_quantity = stock_quantity + 10 WHERE id = 1'),
    ('saga_001', 3, 'create_payment',
     'INSERT INTO payments (payment_id, order_id, amount, status) VALUES (''PAY001'', 1, 1000.00, ''processing'')',
     'DELETE FROM payments WHERE payment_id = ''PAY001''');

-- æ‰§è¡ŒSAGA
-- æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
SELECT execute_saga_step('saga_001', 1);
-- æˆåŠŸ

-- æ­¥éª¤2ï¼šå‡å°‘åº“å­˜
SELECT execute_saga_step('saga_001', 2);
-- æˆåŠŸ

-- æ­¥éª¤3ï¼šåˆ›å»ºæ”¯ä»˜ï¼ˆå‡è®¾å¤±è´¥ï¼‰
SELECT execute_saga_step('saga_001', 3);
-- å¤±è´¥ï¼Œè§¦å‘è¡¥å¿

-- è¡¥å¿æ‰§è¡Œï¼ˆå¹‚ç­‰ï¼‰
-- è¡¥å¿æ­¥éª¤3ï¼ˆå·²å¤±è´¥ï¼Œæ— éœ€è¡¥å¿ï¼‰
-- è¡¥å¿æ­¥éª¤2ï¼šæ¢å¤åº“å­˜
SELECT idempotent_compensate('saga_001', 2);
-- è¡¥å¿æ­¥éª¤1ï¼šåˆ é™¤è®¢å•
SELECT idempotent_compensate('saga_001', 1);

-- éªŒè¯ï¼šæ‰€æœ‰æ­¥éª¤å·²å›æ»š
SELECT * FROM orders WHERE order_number = 'ORD001';
-- ç»“æœï¼šç©ºï¼ˆè®¢å•å·²åˆ é™¤ï¼‰

SELECT stock_quantity FROM products WHERE id = 1;
-- ç»“æœï¼šåº“å­˜å·²æ¢å¤
```

**æ€§èƒ½æ•°æ®**ï¼š

| æŒ‡æ ‡ | SAGAæ¨¡å¼ | 2PCæ¨¡å¼ | è¯´æ˜ |
|------|---------|---------|------|
| **äº‹åŠ¡å»¶è¿Ÿ** | 100-200ms | 50-100ms | SAGAéœ€è¦å¤šæ­¥æ‰§è¡Œ |
| **ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ | SAGAæ˜¯æœ€ç»ˆä¸€è‡´æ€§ |
| **å¯ç”¨æ€§** | é«˜å¯ç”¨ | å—é˜»å¡å½±å“ | SAGAä¸é˜»å¡ |
| **è¡¥å¿å¼€é”€** | 10-20ms | æ—  | SAGAéœ€è¦è¡¥å¿ |

#### åœºæ™¯2ï¼šå¾®æœåŠ¡æ¶æ„çš„SAGAç¼–æ’

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

- å¾®æœåŠ¡æ¶æ„ï¼Œæ¯ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- éœ€è¦è·¨æœåŠ¡çš„äº‹åŠ¡åè°ƒ
- ä½¿ç”¨SAGAç¼–æ’å™¨ç®¡ç†SAGAæ‰§è¡Œ

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- å®ç°SAGAç¼–æ’å™¨
- ä¿è¯è¡¥å¿å¹‚ç­‰æ€§
- å¤„ç†æœåŠ¡æ•…éšœ

**PostgreSQL 18å®ç°**ï¼š

```sql
-- SAGAç¼–æ’å™¨æ•°æ®åº“
CREATE TABLE saga_orchestrator (
    saga_id UUID PRIMARY KEY,
    saga_name VARCHAR(100),
    current_step INTEGER DEFAULT 0,
    total_steps INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- SAGAæ­¥éª¤é…ç½®
CREATE TABLE saga_step_config (
    id BIGSERIAL PRIMARY KEY,
    saga_id UUID REFERENCES saga_orchestrator(saga_id),
    step_number INTEGER NOT NULL,
    service_name VARCHAR(100),
    endpoint VARCHAR(200),
    request_payload JSONB,
    compensation_endpoint VARCHAR(200),
    compensation_payload JSONB,
    status VARCHAR(20) DEFAULT 'pending',
    UNIQUE(saga_id, step_number)
);

-- SAGAç¼–æ’æ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION orchestrate_saga(
    p_saga_id UUID
) RETURNS VOID AS $$
DECLARE
    v_step_config RECORD;
    v_total_steps INTEGER;
    v_current_step INTEGER := 0;
    v_result BOOLEAN;
BEGIN
    -- è·å–æ€»æ­¥éª¤æ•°
    SELECT total_steps INTO v_total_steps
    FROM saga_orchestrator
    WHERE saga_id = p_saga_id;

    -- æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
    FOR v_current_step IN 1..v_total_steps LOOP
        -- è·å–æ­¥éª¤é…ç½®
        SELECT * INTO v_step_config
        FROM saga_step_config
        WHERE saga_id = p_saga_id AND step_number = v_current_step;

        -- è°ƒç”¨æœåŠ¡ï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦HTTPè°ƒç”¨ï¼‰
        -- v_result := call_service(v_step_config.service_name, v_step_config.endpoint, v_step_config.request_payload);

        -- å¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
        IF NOT v_result THEN
            -- æ‰§è¡Œå·²æ‰§è¡Œæ­¥éª¤çš„è¡¥å¿ï¼ˆé€†åºï¼‰
            FOR i IN REVERSE v_current_step-1..1 LOOP
                PERFORM idempotent_compensate(p_saga_id, i);
            END LOOP;

            -- æ›´æ–°SAGAçŠ¶æ€ä¸ºä¸­æ­¢
            UPDATE saga_orchestrator
            SET status = 'aborted', updated_at = NOW()
            WHERE saga_id = p_saga_id;

            RETURN;
        END IF;

        -- æ›´æ–°å½“å‰æ­¥éª¤
        UPDATE saga_orchestrator
        SET current_step = v_current_step, updated_at = NOW()
        WHERE saga_id = p_saga_id;
    END LOOP;

    -- æ‰€æœ‰æ­¥éª¤æˆåŠŸï¼Œæ›´æ–°ä¸ºå®Œæˆ
    UPDATE saga_orchestrator
    SET status = 'completed', updated_at = NOW()
    WHERE saga_id = p_saga_id;
END;
$$ LANGUAGE plpgsql;
```

### 5.4 SAGAæœ€ä½³å®è·µ

**PostgreSQL 18æœ€ä½³å®è·µ**ï¼š

```sql
-- 1. ä¿è¯è¡¥å¿å¹‚ç­‰æ€§
-- ä½¿ç”¨çŠ¶æ€æ£€æŸ¥æˆ–ç‰ˆæœ¬å·
CREATE OR REPLACE FUNCTION idempotent_compensate_with_version(
    p_saga_id UUID,
    p_step_number INTEGER,
    p_version INTEGER
) RETURNS VOID AS $$
DECLARE
    v_current_version INTEGER;
BEGIN
    -- æ£€æŸ¥ç‰ˆæœ¬å·
    SELECT version INTO v_current_version
    FROM compensation_log
    WHERE saga_id = p_saga_id AND step_number = p_step_number;

    -- å¦‚æœç‰ˆæœ¬å·ç›¸åŒæˆ–æ›´å¤§ï¼Œè·³è¿‡ï¼ˆå¹‚ç­‰ï¼‰
    IF v_current_version IS NOT NULL AND v_current_version >= p_version THEN
        RETURN;
    END IF;

    -- æ‰§è¡Œè¡¥å¿å¹¶æ›´æ–°ç‰ˆæœ¬å·
    -- ...
END;
$$ LANGUAGE plpgsql;

-- 2. ç›‘æ§SAGAæ‰§è¡Œ
SELECT
    saga_id,
    saga_name,
    current_step,
    total_steps,
    status,
    NOW() - created_at AS duration
FROM saga_state
WHERE status IN ('in_progress', 'pending')
ORDER BY created_at DESC;

-- 3. æ¸…ç†å®Œæˆçš„SAGA
DELETE FROM saga_state
WHERE status IN ('completed', 'aborted')
  AND updated_at < NOW() - INTERVAL '30 days';

-- 4. å®ç°SAGAæ¢å¤æœºåˆ¶
CREATE OR REPLACE FUNCTION recover_saga(
    p_saga_id UUID
) RETURNS VOID AS $$
DECLARE
    v_saga_record RECORD;
    v_step_record RECORD;
BEGIN
    -- è·å–SAGAçŠ¶æ€
    SELECT * INTO v_saga_record
    FROM saga_state
    WHERE saga_id = p_saga_id;

    -- å¦‚æœSAGAå¤„äºin_progressçŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤
    IF v_saga_record.status = 'in_progress' THEN
        -- æ£€æŸ¥æœ€åæ‰§è¡Œçš„æ­¥éª¤
        SELECT * INTO v_step_record
        FROM saga_steps
        WHERE saga_id = p_saga_id
          AND step_number = v_saga_record.current_step
          AND status = 'executed';

        -- å¦‚æœæ­¥éª¤å·²æ‰§è¡Œä½†SAGAæœªå®Œæˆï¼Œç»§ç»­æ‰§è¡Œ
        IF FOUND THEN
            -- ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥
            PERFORM execute_saga_step(p_saga_id, v_saga_record.current_step + 1);
        END IF;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### 5.5 æ¨¡å‹é€‰æ‹©å»ºè®®

**é€‰æ‹©PostgreSQL 18 SAGAçš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- å¾®æœåŠ¡æ¶æ„
- é•¿äº‹åŠ¡å¤„ç†
- éœ€è¦æœ€ç»ˆä¸€è‡´æ€§
- å¯ä»¥å®¹å¿è¡¥å¿å¼€é”€

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- éœ€è¦å¼ºä¸€è‡´æ€§
- çŸ­äº‹åŠ¡å¤„ç†
- å¯¹å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨

**é€‰æ‹©SQLite 3.45çš„åœºæ™¯**ï¼š

âœ… **æ¨èåœºæ™¯**ï¼š

- å•æœºåº”ç”¨
- ç®€å•çš„æœ¬åœ°äº‹åŠ¡
- ä¸éœ€è¦SAGAæ¨¡å¼

âŒ **ä¸æ¨èåœºæ™¯**ï¼š

- å¾®æœåŠ¡æ¶æ„
- éœ€è¦è·¨æœåŠ¡äº‹åŠ¡
- éœ€è¦SAGAæ¨¡å¼

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [ä¸¤é˜¶æ®µæäº¤-å¯æ¢å¤æ€§ä¸é˜»å¡ç‰¹æ€§è¯æ˜](./04.03-ä¸¤é˜¶æ®µæäº¤-å¯æ¢å¤æ€§ä¸é˜»å¡ç‰¹æ€§è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Garcia-Molina, H., & Salem, K. (1987). "Sagas."**
  - ä¼šè®®: SIGMOD 1987
  - **é‡è¦æ€§**: SAGAæ¨¡å¼çš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†SAGAæ¨¡å¼å’Œè¡¥å¿äº‹åŠ¡æ¦‚å¿µ

- **Bernstein, P. A., & Newcomer, E. (2009). "Principles of Transaction Processing."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: äº‹åŠ¡å¤„ç†çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†SAGAæ¨¡å¼å’Œè¡¥å¿äº‹åŠ¡ç†è®º

### 7.2 å¾®æœåŠ¡æ¶æ„ç›¸å…³

- **Richardson, C. (2018). "Microservices Patterns: With Examples in Java."**
  - å‡ºç‰ˆç¤¾: Manning Publications
  - **é‡è¦æ€§**: å¾®æœåŠ¡æ¨¡å¼çš„å®è·µæŒ‡å—
  - **æ ¸å¿ƒè´¡çŒ®**: æä¾›äº†SAGAåœ¨å¾®æœåŠ¡ä¸­çš„åº”ç”¨æ¨¡å¼

### 7.3 ç›¸å…³æ–‡æ¡£

- [ä¸¤é˜¶æ®µæäº¤-å¯æ¢å¤æ€§ä¸é˜»å¡ç‰¹æ€§è¯æ˜](./04.03-ä¸¤é˜¶æ®µæäº¤-å¯æ¢å¤æ€§ä¸é˜»å¡ç‰¹æ€§è¯æ˜.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²æ·±åŒ–ï¼ŒåŒ…å«å®Œæ•´è¯æ˜ã€åœºæ™¯æ¡ˆä¾‹å’ŒPostgreSQL 18/SQLiteå¯¹æ¯”
