# å¬å›ç‡ä¼˜åŒ–ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ / Apache AGE 1.5+ / pgvector 0.7.0+  
> **æ–‡æ¡£ç¼–å·**: 04-03-03

## ğŸ“‘ ç›®å½•

- [å¬å›ç‡ä¼˜åŒ–ç­–ç•¥](#å¬å›ç‡ä¼˜åŒ–ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ä¼˜åŒ–ç­–ç•¥](#2-ä¼˜åŒ–ç­–ç•¥)
    - [2.1 å›¾æŸ¥è¯¢ä¼˜åŒ–](#21-å›¾æŸ¥è¯¢ä¼˜åŒ–)
    - [2.2 å‘é‡æœç´¢ä¼˜åŒ–](#22-å‘é‡æœç´¢ä¼˜åŒ–)
    - [2.3 ç»“æœèåˆä¼˜åŒ–](#23-ç»“æœèåˆä¼˜åŒ–)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 å¤šé˜¶æ®µå¬å›](#31-å¤šé˜¶æ®µå¬å›)
  - [4. æ€§èƒ½åˆ†æ](#4-æ€§èƒ½åˆ†æ)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

å¬å›ç‡ä¼˜åŒ–ç­–ç•¥é€šè¿‡ä¼˜åŒ–å›¾æŸ¥è¯¢å’Œå‘é‡æœç´¢ï¼Œæå‡è”åˆæŸ¥è¯¢çš„å¬å›ç‡ã€‚

---

## 2. ä¼˜åŒ–ç­–ç•¥

### 2.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æ‰©å±•å›¾æŸ¥è¯¢èŒƒå›´
WITH expanded_graph AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User {id: $user_id})-[:FOLLOWS*1..4]->(recommended:User)
        RETURN recommended.id as user_id, length(path) as depth
    $$) AS (user_id agtype, depth agtype)
)
SELECT user_id, depth
FROM expanded_graph
WHERE depth <= 3;
```

### 2.2 å‘é‡æœç´¢ä¼˜åŒ–

```sql
-- å¢åŠ å‘é‡æœç´¢èŒƒå›´
SELECT user_id, embedding <=> $1 as distance
FROM user_embeddings
WHERE embedding <=> $1 < 0.9  -- æé«˜é˜ˆå€¼
ORDER BY embedding <=> $1
LIMIT 100;  -- å¢åŠ è¿”å›æ•°é‡
```

### 2.3 ç»“æœèåˆä¼˜åŒ–

```sql
-- ä½¿ç”¨åŠ æƒèåˆ
WITH graph_results AS (
    SELECT user_id, 1.0 as graph_score
    FROM graph_query
),
vector_results AS (
    SELECT user_id, 1 - distance as vector_score
    FROM vector_search
),
combined AS (
    SELECT
        COALESCE(g.user_id, v.user_id) as user_id,
        COALESCE(g.graph_score * 0.6, 0) +
        COALESCE(v.vector_score * 0.4, 0) as combined_score
    FROM graph_results g
    FULL OUTER JOIN vector_results v ON g.user_id = v.user_id
)
SELECT user_id, combined_score
FROM combined
ORDER BY combined_score DESC
LIMIT 20;
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 å¤šé˜¶æ®µå¬å›

```python
def multi_stage_recall(query_vector, user_id):
    """å¤šé˜¶æ®µå¬å›"""
    # é˜¶æ®µ1: å›¾æŸ¥è¯¢ï¼ˆé«˜ç²¾åº¦ï¼‰
    graph_results = graph_query(user_id, depth=2)

    # é˜¶æ®µ2: å‘é‡æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼‰
    vector_results = vector_search(query_vector, threshold=0.8, limit=50)

    # é˜¶æ®µ3: æ‰©å±•å›¾æŸ¥è¯¢ï¼ˆä½ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰
    expanded_graph = graph_query(user_id, depth=4)

    # èåˆç»“æœ
    combined = merge_results(graph_results, vector_results, expanded_graph)

    return combined
```

---

## 4. æ€§èƒ½åˆ†æ

**ä¼˜åŒ–æ•ˆæœ**:

| ç­–ç•¥     | å¬å›ç‡ | å‡†ç¡®ç‡ | å»¶è¿Ÿ |
| -------- | ------ | ------ | ---- |
| åŸºç¡€æŸ¥è¯¢ | 75%    | 85%    | 20ms |
| ä¼˜åŒ–å   | 92%    | 82%    | 35ms |

---

## 5. æœ€ä½³å®è·µ

1. **å¹³è¡¡å¬å›å’Œå‡†ç¡®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®ç‡
2. **å¤šé˜¶æ®µå¬å›**: ä½¿ç”¨å¤šé˜¶æ®µå¬å›ç­–ç•¥
3. **ç»“æœèåˆ**: ä½¿ç”¨åŠ æƒèåˆæå‡æ•ˆæœ

---

## 6. å‚è€ƒèµ„æ–™

- [å›¾å‘é‡è”åˆæŸ¥è¯¢](./å›¾å‘é‡è”åˆæŸ¥è¯¢.md)
- [é‡‘èåæ¬ºè¯ˆåº”ç”¨](./é‡‘èåæ¬ºè¯ˆåº”ç”¨.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
