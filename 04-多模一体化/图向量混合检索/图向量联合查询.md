# 4.5 å›¾å‘é‡è”åˆæŸ¥è¯¢

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ / Apache AGE 1.5+ / pgvector 0.7.0+  
> **æ–‡æ¡£ç¼–å·**: 04-03-01

## ğŸ“‘ ç›®å½•

- [4.5 å›¾å‘é‡è”åˆæŸ¥è¯¢](#45-å›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŸ¥è¯¢å®šä½](#12-æŸ¥è¯¢å®šä½)
  - [2. å›¾å‘é‡è”åˆæŸ¥è¯¢](#2-å›¾å‘é‡è”åˆæŸ¥è¯¢)
    - [2.1 å›¾æŸ¥è¯¢åŸºç¡€](#21-å›¾æŸ¥è¯¢åŸºç¡€)
    - [2.2 å‘é‡æŸ¥è¯¢åŸºç¡€](#22-å‘é‡æŸ¥è¯¢åŸºç¡€)
    - [2.3 è”åˆæŸ¥è¯¢å®ç°](#23-è”åˆæŸ¥è¯¢å®ç°)
  - [3. åº”ç”¨åœºæ™¯](#3-åº”ç”¨åœºæ™¯)
    - [3.1 æ¨èç³»ç»Ÿ](#31-æ¨èç³»ç»Ÿ)
    - [3.2 åæ¬ºè¯ˆç³»ç»Ÿ](#32-åæ¬ºè¯ˆç³»ç»Ÿ)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

å›¾å‘é‡è”åˆæŸ¥è¯¢ç»“åˆå›¾æ•°æ®åº“çš„å…³ç³»æŸ¥è¯¢èƒ½åŠ›å’Œå‘é‡æ•°æ®åº“çš„ç›¸ä¼¼åº¦æœç´¢èƒ½åŠ›ï¼Œå®ç°æ›´æ™ºèƒ½çš„æŸ¥è¯¢ã€‚

### 1.2 æŸ¥è¯¢å®šä½

å›¾å‘é‡è”åˆæŸ¥è¯¢æ˜¯æ¨èç³»ç»Ÿã€åæ¬ºè¯ˆç­‰åº”ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

---

## 2. å›¾å‘é‡è”åˆæŸ¥è¯¢

### 2.1 å›¾æŸ¥è¯¢åŸºç¡€

**Apache AGE å›¾æŸ¥è¯¢**:

```sql
-- åŠ è½½ AGE æ‰©å±•
LOAD 'age';

-- åˆ›å»ºå›¾
SELECT create_graph('social_network');

-- åˆ›å»ºèŠ‚ç‚¹
SELECT * FROM cypher('social_network', $$
    CREATE (u:User {id: 1, name: 'Alice'})
    CREATE (u:User {id: 2, name: 'Bob'})
    CREATE (u)-[:FOLLOWS]->(u2:User {id: 2})
$$) AS (a agtype);
```

### 2.2 å‘é‡æŸ¥è¯¢åŸºç¡€

**å‘é‡ç›¸ä¼¼åº¦æœç´¢**:

```sql
-- åˆ›å»ºå‘é‡è¡¨
CREATE TABLE user_embeddings (
    user_id BIGINT PRIMARY KEY,
    embedding vector(768)
);

-- å‘é‡æœç´¢
SELECT user_id, embedding <=> $1 as distance
FROM user_embeddings
ORDER BY embedding <=> $1
LIMIT 10;
```

### 2.3 è”åˆæŸ¥è¯¢å®ç°

**å›¾ + å‘é‡è”åˆæŸ¥è¯¢**:

```sql
-- è”åˆæŸ¥è¯¢ï¼šå›¾æŸ¥è¯¢ + å‘é‡æœç´¢
WITH graph_query AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User)-[:FOLLOWS*2..3]->(recommended:User)
        WHERE u.id = 1
        RETURN recommended.id as user_id
    $$) AS (user_id agtype)
),
vector_search AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 20
),
combined AS (
    SELECT
        COALESCE(g.user_id::bigint, v.user_id) as user_id,
        COALESCE(v.distance, 1.0) as distance,
        CASE WHEN g.user_id IS NOT NULL THEN 1 ELSE 0 END as in_graph
    FROM graph_query g
    FULL OUTER JOIN vector_search v ON g.user_id::bigint = v.user_id
)
SELECT user_id, distance, in_graph
FROM combined
ORDER BY in_graph DESC, distance
LIMIT 10;
```

---

## 3. åº”ç”¨åœºæ™¯

### 3.1 æ¨èç³»ç»Ÿ

**ç¤¾äº¤æ¨è**:

```sql
-- åŸºäºå›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦çš„æ¨è
WITH user_friends AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User {id: $user_id})-[:FOLLOWS]->(f:User)
        RETURN f.id as friend_id
    $$) AS (friend_id agtype)
),
similar_users AS (
    SELECT user_id, embedding <=> $user_embedding as distance
    FROM user_embeddings
    WHERE embedding <=> $user_embedding < 0.8
    ORDER BY embedding <=> $user_embedding
    LIMIT 50
),
friend_similar AS (
    SELECT s.user_id, s.distance
    FROM similar_users s
    WHERE s.user_id IN (SELECT friend_id::bigint FROM user_friends)
)
SELECT * FROM friend_similar
ORDER BY distance
LIMIT 10;
```

### 3.2 åæ¬ºè¯ˆç³»ç»Ÿ

**æ¬ºè¯ˆæ£€æµ‹**:

```sql
-- åŸºäºå›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦çš„æ¬ºè¯ˆæ£€æµ‹
WITH suspicious_pattern AS (
    SELECT pattern_vector
    FROM fraud_patterns
    WHERE pattern_type = 'account_takeover'
),
similar_transactions AS (
    SELECT transaction_id, embedding <=> (SELECT pattern_vector FROM suspicious_pattern) as distance
    FROM transaction_embeddings
    WHERE embedding <=> (SELECT pattern_vector FROM suspicious_pattern) < 0.7
),
related_accounts AS (
    SELECT * FROM cypher('transaction_graph', $$
        MATCH (t:Transaction)-[:INVOLVES]->(a:Account)
        WHERE t.id IN $transaction_ids
        RETURN a.id as account_id, COUNT(*) as transaction_count
    $$) AS (account_id agtype, transaction_count agtype)
)
SELECT
    a.account_id,
    a.transaction_count,
    MIN(s.distance) as min_distance
FROM related_accounts a
JOIN similar_transactions s ON s.transaction_id = a.transaction_id::bigint
GROUP BY a.account_id, a.transaction_count
HAVING COUNT(*) > 3
ORDER BY min_distance;
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- å›¾ç´¢å¼•
CREATE INDEX ON user_embeddings (user_id);

-- å‘é‡ç´¢å¼•
CREATE INDEX ON user_embeddings USING hnsw (embedding vector_cosine_ops);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- é™åˆ¶å›¾æŸ¥è¯¢æ·±åº¦
SET age.max_path_depth = 3;

-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
```

---

## 5. æœ€ä½³å®è·µ

1. **æŸ¥è¯¢é¡ºåº**: å…ˆæ‰§è¡Œå›¾æŸ¥è¯¢è¿‡æ»¤ï¼Œå†æ‰§è¡Œå‘é‡æœç´¢
2. **ç´¢å¼•ç­–ç•¥**: ä¸ºå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢åˆ›å»ºåˆé€‚ç´¢å¼•
3. **ç»“æœèåˆ**: ä½¿ç”¨ RRF ç®—æ³•èåˆå›¾æŸ¥è¯¢å’Œå‘é‡æŸ¥è¯¢ç»“æœ

---

## 6. å‚è€ƒèµ„æ–™

- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)
- [é‡‘èåæ¬ºè¯ˆåº”ç”¨](./é‡‘èåæ¬ºè¯ˆåº”ç”¨.md)
- [Apache AGE å®˜æ–¹æ–‡æ¡£](https://age.apache.org/)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
