# 4.4 性能优化策略

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: PostgreSQL 18+ / TimescaleDB 2.13+  
> **文档编号**: 04-02-03

## 📑 目录

- [4.4 性能优化策略](#44-性能优化策略)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 存储优化](#2-存储优化)
    - [2.1 分区策略](#21-分区策略)
    - [2.2 数据压缩](#22-数据压缩)
  - [3. 查询优化](#3-查询优化)
    - [3.1 连续聚合](#31-连续聚合)
    - [3.2 查询重写](#32-查询重写)
  - [4. 索引优化](#4-索引优化)
    - [4.1 复合索引](#41-复合索引)
    - [4.2 部分索引](#42-部分索引)
  - [5. 最佳实践](#5-最佳实践)
  - [6. 参考资料](#6-参考资料)

---

## 1. 概述

性能优化策略针对 JSONB + 时序 + 向量混合数据模型，提供全面的性能优化方案。

---

## 2. 存储优化

### 2.1 分区策略

```sql
-- TimescaleDB 自动分区
SELECT create_hypertable('device_data', 'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE);

-- 压缩旧数据
SELECT add_compression_policy('device_data', INTERVAL '30 days');
```

### 2.2 数据压缩

```sql
-- 启用压缩
ALTER TABLE device_data SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id'
);
```

---

## 3. 查询优化

### 3.1 连续聚合

```sql
-- 创建连续聚合
CREATE MATERIALIZED VIEW device_hourly_agg
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) as hour,
    device_id,
    AVG(temperature) as avg_temp,
    MAX(temperature) as max_temp,
    MIN(temperature) as min_temp
FROM device_data
GROUP BY hour, device_id;
```

### 3.2 查询重写

```sql
-- 使用物化视图加速查询
SELECT * FROM device_hourly_agg
WHERE hour > NOW() - INTERVAL '7 days'
  AND device_id = 'device_001';
```

---

## 4. 索引优化

### 4.1 复合索引

```sql
-- 创建覆盖索引
CREATE INDEX ON device_data (device_id, time DESC)
INCLUDE (temperature, humidity, behavior_vector);
```

### 4.2 部分索引

```sql
-- 只索引活跃设备
CREATE INDEX ON device_data (device_id, time)
WHERE device_info->>'status' = 'active';
```

---

## 5. 最佳实践

1. **分区管理**: 合理设置分区大小
2. **索引策略**: 平衡索引数量和查询性能
3. **查询优化**: 使用连续聚合加速查询
4. **监控告警**: 持续监控性能指标

---

## 6. 参考资料

- [混合数据模型设计](./混合数据模型设计.md)
- [IoT 异常检测方案](./IoT异常检测方案.md)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team
