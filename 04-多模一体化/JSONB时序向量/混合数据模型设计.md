# æ··åˆæ•°æ®æ¨¡å‹è®¾è®¡

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ / TimescaleDB 2.13+ / pgvector 0.7.0+  
> **æ–‡æ¡£ç¼–å·**: 04-02-01

## ğŸ“‘ ç›®å½•

- [æ··åˆæ•°æ®æ¨¡å‹è®¾è®¡](#æ··åˆæ•°æ®æ¨¡å‹è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ¨¡å‹å®šä½](#12-æ¨¡å‹å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ•°æ®æ¨¡å‹è®¾è®¡](#2-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [2.1 JSONB + æ—¶åº + å‘é‡ä¸€ä½“åŒ–](#21-jsonb--æ—¶åº--å‘é‡ä¸€ä½“åŒ–)
    - [2.2 è¡¨ç»“æ„è®¾è®¡](#22-è¡¨ç»“æ„è®¾è®¡)
    - [2.3 ç´¢å¼•è®¾è®¡](#23-ç´¢å¼•è®¾è®¡)
  - [3. æŸ¥è¯¢è®¾è®¡](#3-æŸ¥è¯¢è®¾è®¡)
    - [3.1 æ—¶åºæŸ¥è¯¢](#31-æ—¶åºæŸ¥è¯¢)
    - [3.2 å‘é‡æŸ¥è¯¢](#32-å‘é‡æŸ¥è¯¢)
    - [3.3 æ··åˆæŸ¥è¯¢](#33-æ··åˆæŸ¥è¯¢)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 å­˜å‚¨ä¼˜åŒ–](#41-å­˜å‚¨ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 IoT å¼‚å¸¸æ£€æµ‹](#51-iot-å¼‚å¸¸æ£€æµ‹)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

IoT åº”ç”¨éœ€è¦åŒæ—¶å¤„ç†ï¼š

- **æ—¶åºæ•°æ®**: ä¼ æ„Ÿå™¨è¯»æ•°ã€ç›‘æ§æŒ‡æ ‡
- **JSONB æ•°æ®**: è®¾å¤‡å…ƒæ•°æ®ã€é…ç½®ä¿¡æ¯
- **å‘é‡æ•°æ®**: è®¾å¤‡è¡Œä¸ºæ¨¡å¼ã€å¼‚å¸¸æ£€æµ‹

ä¼ ç»Ÿæ–¹å¼éœ€è¦å¤šä¸ªæ•°æ®åº“ï¼Œæ•°æ®åŒæ­¥å¤æ‚ï¼ŒæŸ¥è¯¢æ€§èƒ½å·®ã€‚

### 1.2 æ¨¡å‹å®šä½

æ··åˆæ•°æ®æ¨¡å‹å°† JSONBã€æ—¶åºå’Œå‘é‡æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨åŒä¸€è¡¨ä¸­ï¼Œå®ç°ä¸€ä½“åŒ–æŸ¥è¯¢ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

1. **ç»Ÿä¸€å­˜å‚¨**: å‡å°‘æ•°æ®åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§
1. **æ··åˆæŸ¥è¯¢**: æ”¯æŒæ—¶åºã€JSONBã€å‘é‡æ··åˆæŸ¥è¯¢
1. **æ€§èƒ½ä¼˜åŒ–**: é€šè¿‡å…±ç°‡å­˜å‚¨æå‡æŸ¥è¯¢æ€§èƒ½

---

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 JSONB + æ—¶åº + å‘é‡ä¸€ä½“åŒ–

**è¡¨è®¾è®¡**:

```sql
-- åˆ›å»ºæ—¶åºè¡¨ï¼ˆTimescaleDBï¼‰
CREATE TABLE device_metrics (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,
    metric_type TEXT NOT NULL,
    value DOUBLE PRECISION,
    metadata JSONB,  -- JSONB å­˜å‚¨è®¾å¤‡å…ƒæ•°æ®
    behavior_vector vector(128)  -- å‘é‡å­˜å‚¨è¡Œä¸ºæ¨¡å¼
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('device_metrics', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON device_metrics (device_id, time DESC);
CREATE INDEX ON device_metrics USING GIN (metadata);
CREATE INDEX ON device_metrics USING hnsw (behavior_vector vector_cosine_ops);
```

### 2.2 è¡¨ç»“æ„è®¾è®¡

**å®Œæ•´è¡¨ç»“æ„**:

```sql
CREATE TABLE device_data (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,

    -- æ—¶åºæ•°æ®
    temperature DOUBLE PRECISION,
    humidity DOUBLE PRECISION,
    pressure DOUBLE PRECISION,

    -- JSONB å…ƒæ•°æ®
    device_info JSONB,  -- è®¾å¤‡ä¿¡æ¯
    location JSONB,     -- ä½ç½®ä¿¡æ¯
    config JSONB,       -- é…ç½®ä¿¡æ¯

    -- å‘é‡æ•°æ®
    behavior_vector vector(128),  -- è¡Œä¸ºå‘é‡
    anomaly_vector vector(64)     -- å¼‚å¸¸å‘é‡
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('device_data', 'time',
    chunk_time_interval => INTERVAL '1 day');

-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX ON device_data (device_id, time DESC);
CREATE INDEX ON device_data USING GIN (device_info);
CREATE INDEX ON device_data USING hnsw (behavior_vector vector_cosine_ops);
```

### 2.3 ç´¢å¼•è®¾è®¡

**å¤šç´¢å¼•ç­–ç•¥**:

```sql
-- 1. æ—¶åºç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- TimescaleDB è‡ªåŠ¨ä¸ºæ—¶é—´åˆ—åˆ›å»ºç´¢å¼•

-- 2. JSONB ç´¢å¼•
CREATE INDEX ON device_data USING GIN (device_info);
CREATE INDEX ON device_data USING GIN (device_info jsonb_path_ops);

-- 3. å‘é‡ç´¢å¼•
CREATE INDEX ON device_data USING hnsw (behavior_vector vector_cosine_ops);
CREATE INDEX ON device_data USING hnsw (anomaly_vector vector_cosine_ops);

-- 4. å¤åˆç´¢å¼•
CREATE INDEX ON device_data (device_id, time DESC, metric_type);
```

---

## 3. æŸ¥è¯¢è®¾è®¡

### 3.1 æ—¶åºæŸ¥è¯¢

**æ—¶é—´èŒƒå›´æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢æœ€è¿‘ 24 å°æ—¶çš„æ•°æ®
SELECT time, device_id, temperature, humidity
FROM device_data
WHERE device_id = 'device_001'
  AND time > NOW() - INTERVAL '24 hours'
ORDER BY time DESC;
```

**èšåˆæŸ¥è¯¢**:

```sql
-- æŒ‰å°æ—¶èšåˆ
SELECT
    time_bucket('1 hour', time) as hour,
    device_id,
    AVG(temperature) as avg_temp,
    MAX(temperature) as max_temp,
    MIN(temperature) as min_temp
FROM device_data
WHERE time > NOW() - INTERVAL '7 days'
GROUP BY hour, device_id
ORDER BY hour DESC;
```

### 3.2 å‘é‡æŸ¥è¯¢

**ç›¸ä¼¼åº¦æœç´¢**:

```sql
-- æŸ¥æ‰¾ç›¸ä¼¼è¡Œä¸ºæ¨¡å¼
SELECT device_id, time, behavior_vector <=> $1 as distance
FROM device_data
WHERE behavior_vector <=> $1 < 0.8
ORDER BY behavior_vector <=> $1
LIMIT 10;
```

### 3.3 æ··åˆæŸ¥è¯¢

**æ—¶åº + JSONB + å‘é‡**:

```sql
-- æ··åˆæŸ¥è¯¢ï¼šæ—¶åºèŒƒå›´ + JSONB è¿‡æ»¤ + å‘é‡æœç´¢
WITH time_filtered AS (
    SELECT *
    FROM device_data
    WHERE time > NOW() - INTERVAL '7 days'
      AND device_info->>'status' = 'active'
      AND device_info->>'location'->>'region' = 'north'
),
vector_search AS (
    SELECT device_id, time, behavior_vector <=> $1 as distance
    FROM time_filtered
    WHERE behavior_vector <=> $1 < 0.8
    ORDER BY behavior_vector <=> $1
    LIMIT 20
)
SELECT
    v.device_id,
    v.time,
    v.distance,
    d.temperature,
    d.humidity,
    d.device_info
FROM vector_search v
JOIN device_data d ON v.device_id = d.device_id AND v.time = d.time
ORDER BY v.distance;
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 å­˜å‚¨ä¼˜åŒ–

**åˆ†åŒºç­–ç•¥**:

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºï¼ˆTimescaleDB è‡ªåŠ¨ç®¡ç†ï¼‰
SELECT create_hypertable('device_data', 'time',
    chunk_time_interval => INTERVAL '1 day',
    if_not_exists => TRUE);

-- æŒ‰è®¾å¤‡åˆ†åŒº
CREATE TABLE device_data (
    ...
) PARTITION BY HASH (device_id);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨è¿ç»­èšåˆï¼ˆContinuous Aggregatesï¼‰
CREATE MATERIALIZED VIEW device_hourly_stats
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) as hour,
    device_id,
    AVG(temperature) as avg_temp
FROM device_data
GROUP BY hour, device_id;

-- 2. ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;

-- 3. ä½¿ç”¨ç´¢å¼•æç¤º
SET enable_seqscan = off;
```

---

## 5. å®é™…åº”ç”¨

### 5.1 IoT å¼‚å¸¸æ£€æµ‹

**åº”ç”¨åœºæ™¯**:

```sql
-- å¼‚å¸¸æ£€æµ‹æŸ¥è¯¢
WITH recent_data AS (
    SELECT *
    FROM device_data
    WHERE time > NOW() - INTERVAL '1 hour'
      AND device_id = 'device_001'
),
anomaly_patterns AS (
    SELECT anomaly_vector
    FROM anomaly_patterns
    WHERE pattern_type = 'temperature_spike'
),
detected AS (
    SELECT
        r.device_id,
        r.time,
        r.temperature,
        MIN(r.anomaly_vector <=> a.anomaly_vector) as anomaly_score
    FROM recent_data r
    CROSS JOIN anomaly_patterns a
    WHERE r.anomaly_vector <=> a.anomaly_vector < 0.7
    GROUP BY r.device_id, r.time, r.temperature
)
SELECT * FROM detected
WHERE anomaly_score < 0.5
ORDER BY time DESC;
```

---

## 6. æœ€ä½³å®è·µ

1. **è¡¨è®¾è®¡**: åˆç†è®¾è®¡è¡¨ç»“æ„ï¼Œå¹³è¡¡æŸ¥è¯¢æ€§èƒ½å’Œå­˜å‚¨æˆæœ¬
1. **ç´¢å¼•ç­–ç•¥**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºåˆé€‚ç´¢å¼•
1. **åˆ†åŒºç­–ç•¥**: ä½¿ç”¨ TimescaleDB è‡ªåŠ¨åˆ†åŒºç®¡ç†
1. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢é¡ºåºï¼Œå…ˆè¿‡æ»¤åè®¡ç®—

---

## 7. å‚è€ƒèµ„æ–™

- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)
- [IoT å¼‚å¸¸æ£€æµ‹æ–¹æ¡ˆ](./IoTå¼‚å¸¸æ£€æµ‹æ–¹æ¡ˆ.md)
- [TimescaleDB å®˜æ–¹æ–‡æ¡£](https://docs.timescale.com/)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
