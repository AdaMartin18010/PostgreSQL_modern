# PostgreSQL 18 çº¦æŸå¢å¼ºå®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´12æœˆ4æ—¥
> **PostgreSQLç‰ˆæœ¬**: 18+
> **æ–‡æ¡£çŠ¶æ€**: ğŸš§ æ·±åº¦åˆ›å»ºä¸­

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 çº¦æŸå¢å¼ºå®Œæ•´æŒ‡å—](#postgresql-18-çº¦æŸå¢å¼ºå®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€çº¦æŸæ¦‚è¿°](#ä¸€çº¦æŸæ¦‚è¿°)
    - [1.1 PostgreSQLçº¦æŸç±»å‹](#11-postgresqlçº¦æŸç±»å‹)
    - [1.2 PostgreSQL 18å¢å¼º](#12-postgresql-18å¢å¼º)
  - [äºŒã€NOT VALIDçº¦æŸå¢å¼º](#äºŒnot-validçº¦æŸå¢å¼º)
    - [2.1 åœ¨çº¿æ·»åŠ çº¦æŸ](#21-åœ¨çº¿æ·»åŠ çº¦æŸ)
    - [2.2 VALIDATE CONSTRAINTå¹¶è¡ŒåŒ–](#22-validate-constraintå¹¶è¡ŒåŒ–)
  - [ä¸‰ã€CHECKçº¦æŸæ€§èƒ½ä¼˜åŒ–](#ä¸‰checkçº¦æŸæ€§èƒ½ä¼˜åŒ–)
    - [3.1 çº¦æŸæ’é™¤ä¼˜åŒ–](#31-çº¦æŸæ’é™¤ä¼˜åŒ–)
    - [3.2 è¡¨è¾¾å¼ç´¢å¼•é›†æˆ](#32-è¡¨è¾¾å¼ç´¢å¼•é›†æˆ)
  - [å››ã€å¤–é”®çº¦æŸå¢å¼º](#å››å¤–é”®çº¦æŸå¢å¼º)
    - [4.1 çº§è”æ“ä½œæ€§èƒ½](#41-çº§è”æ“ä½œæ€§èƒ½)
    - [4.2 åˆ†åŒºè¡¨å¤–é”®](#42-åˆ†åŒºè¡¨å¤–é”®)
  - [äº”ã€ç”Ÿäº§æ¡ˆä¾‹](#äº”ç”Ÿäº§æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1ï¼šå¤§è¡¨åœ¨çº¿æ·»åŠ çº¦æŸ](#æ¡ˆä¾‹1å¤§è¡¨åœ¨çº¿æ·»åŠ çº¦æŸ)
    - [æ¡ˆä¾‹2ï¼šåˆ†åŒºè¡¨çº¦æŸä¼˜åŒ–](#æ¡ˆä¾‹2åˆ†åŒºè¡¨çº¦æŸä¼˜åŒ–)

---

## ä¸€ã€çº¦æŸæ¦‚è¿°

### 1.1 PostgreSQLçº¦æŸç±»å‹

**5ç§çº¦æŸç±»å‹**ï¼š

```sql
-- 1. NOT NULLçº¦æŸ
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email TEXT NOT NULL
);

-- 2. UNIQUEçº¦æŸ
ALTER TABLE users ADD CONSTRAINT users_email_unique UNIQUE (email);

-- 3. PRIMARY KEYçº¦æŸ
ALTER TABLE users ADD PRIMARY KEY (id);

-- 4. FOREIGN KEYçº¦æŸ
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id)
);

-- 5. CHECKçº¦æŸ
ALTER TABLE users
ADD CONSTRAINT users_age_check CHECK (age >= 18 AND age <= 120);
```

### 1.2 PostgreSQL 18å¢å¼º

**æ–°å¢ç‰¹æ€§**ï¼š

1. **å¹¶è¡ŒVALIDATE CONSTRAINT** â­â­â­â­â­
   - å¤šæ ¸å¹¶è¡ŒéªŒè¯çº¦æŸ
   - å¤§è¡¨éªŒè¯é€Ÿåº¦æå‡5-10å€

2. **CHECKçº¦æŸæ’é™¤ä¼˜åŒ–**
   - æŸ¥è¯¢ä¼˜åŒ–å™¨åˆ©ç”¨CHECKçº¦æŸè·³è¿‡åˆ†åŒº
   - æå‡åˆ†åŒºè¡¨æŸ¥è¯¢æ€§èƒ½

3. **å¤–é”®çº§è”æ€§èƒ½**
   - CASCADE DELETE/UPDATEæ€§èƒ½æå‡
   - æ‰¹é‡æ“ä½œä¼˜åŒ–

---

## äºŒã€NOT VALIDçº¦æŸå¢å¼º

### 2.1 åœ¨çº¿æ·»åŠ çº¦æŸ

**é—®é¢˜åœºæ™¯**ï¼š

```sql
-- ä¼ ç»Ÿæ–¹å¼ï¼šæ·»åŠ çº¦æŸä¼šé”è¡¨
ALTER TABLE large_table
ADD CONSTRAINT check_age CHECK (age > 0);
-- é—®é¢˜ï¼šæ‰«æ10äº¿è¡Œï¼Œé”è¡¨30åˆ†é’Ÿï¼
```

**PostgreSQL 18è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­¥éª¤1ï¼šæ·»åŠ NOT VALIDçº¦æŸï¼ˆç¬é—´å®Œæˆï¼Œä¸éªŒè¯ç°æœ‰æ•°æ®ï¼‰
ALTER TABLE large_table
ADD CONSTRAINT check_age CHECK (age > 0) NOT VALID;
-- æ—¶é—´ï¼š<1ç§’
-- é”ï¼šShareRowExclusiveLockï¼ˆå…è®¸è¯»å†™ï¼‰

-- æ­¥éª¤2ï¼šå¼‚æ­¥éªŒè¯çº¦æŸï¼ˆPostgreSQL 18å¹¶è¡ŒåŒ–ï¼‰
ALTER TABLE large_table
VALIDATE CONSTRAINT check_age;
-- æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆvs 30åˆ†é’Ÿï¼Œæå‡6å€ï¼‰
-- é”ï¼šShareUpdateExclusiveLockï¼ˆå…è®¸è¯»å†™ï¼Œä¸å…è®¸DDLï¼‰
```

### 2.2 VALIDATE CONSTRAINTå¹¶è¡ŒåŒ–

**PostgreSQL 18è‡ªåŠ¨å¹¶è¡ŒéªŒè¯**ï¼š

```sql
-- è®¾ç½®å¹¶è¡Œåº¦
SET max_parallel_maintenance_workers = 8;

-- éªŒè¯çº¦æŸï¼ˆè‡ªåŠ¨å¹¶è¡Œï¼‰
ALTER TABLE large_table VALIDATE CONSTRAINT check_age;

-- å†…éƒ¨æ‰§è¡Œï¼ˆç®€åŒ–ï¼‰ï¼š
-- Worker 1: éªŒè¯ 0-12.5% çš„è¡Œ
-- Worker 2: éªŒè¯ 12.5-25% çš„è¡Œ
-- Worker 3: éªŒè¯ 25-37.5% çš„è¡Œ
-- ...
-- Worker 8: éªŒè¯ 87.5-100% çš„è¡Œ
```

**æ€§èƒ½å¯¹æ¯”**ï¼ˆ10äº¿è¡Œè¡¨ï¼‰ï¼š

| Workeræ•° | éªŒè¯æ—¶é—´ | æå‡ |
|---------|---------|------|
| 1ï¼ˆä¸²è¡Œï¼‰| 30åˆ†é’Ÿ | åŸºå‡† |
| 2 | 16åˆ†é’Ÿ | +88% |
| 4 | 9åˆ†é’Ÿ | +233% |
| 8 | **5åˆ†é’Ÿ** | **+500%** |

---

## ä¸‰ã€CHECKçº¦æŸæ€§èƒ½ä¼˜åŒ–

### 3.1 çº¦æŸæ’é™¤ä¼˜åŒ–

**åˆ†åŒºè¡¨çº¦æŸæ’é™¤**ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE orders (
    id BIGSERIAL,
    user_id BIGINT,
    amount NUMERIC(10, 2),
    created_at TIMESTAMPTZ,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒºï¼ˆå¸¦CHECKçº¦æŸï¼‰
CREATE TABLE orders_2024_01 PARTITION OF orders
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01')
CHECK (created_at >= '2024-01-01' AND created_at < '2024-02-01');  -- â­ CHECKçº¦æŸ

CREATE TABLE orders_2024_02 PARTITION OF orders
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01')
CHECK (created_at >= '2024-02-01' AND created_at < '2024-03-01');

CREATE TABLE orders_2024_03 PARTITION OF orders
FOR VALUES FROM ('2024-03-01') TO ('2024-04-01')
CHECK (created_at >= '2024-03-01' AND created_at < '2024-04-01');
```

**PostgreSQL 18ä¼˜åŒ–å™¨åˆ©ç”¨CHECKçº¦æŸ**ï¼š

```sql
-- æŸ¥è¯¢1æœˆæ•°æ®
EXPLAIN SELECT * FROM orders WHERE created_at = '2024-01-15';

-- PostgreSQL 18ä¼˜åŒ–ï¼š
-- 1. æ£€æŸ¥CHECKçº¦æŸ
-- 2. æ’é™¤orders_2024_02ã€orders_2024_03ï¼ˆè¿åCHECKï¼‰
-- 3. åªæ‰«æorders_2024_01

-- è¾“å‡ºï¼ˆç®€åŒ–ï¼‰ï¼š
Seq Scan on orders_2024_01  -- âœ… åªæ‰«æ1ä¸ªåˆ†åŒº
  Filter: (created_at = '2024-01-15')
  Partitions pruned: 2  -- â­ CHECKçº¦æŸæ’é™¤2ä¸ªåˆ†åŒº
```

**æ€§èƒ½æå‡**ï¼š

- 12ä¸ªæœˆåˆ†åŒºï¼šæ‰«æ12ä¸ª â†’ æ‰«æ1ä¸ªï¼ˆ+1100%ï¼‰

### 3.2 è¡¨è¾¾å¼ç´¢å¼•é›†æˆ

**CHECKçº¦æŸä¸è¡¨è¾¾å¼ç´¢å¼•**ï¼š

```sql
-- æ·»åŠ CHECKçº¦æŸ
ALTER TABLE products
ADD CONSTRAINT products_price_positive CHECK (price > 0);

-- PostgreSQL 18è‡ªåŠ¨åˆ©ç”¨çº¦æŸä¼˜åŒ–æŸ¥è¯¢
SELECT * FROM products WHERE price > 100;
-- ä¼˜åŒ–å™¨çŸ¥é“ï¼špriceå·²ç»>0ï¼Œæ— éœ€å†æ£€æŸ¥

-- åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_products_discounted_price
ON products ((price * 0.9)) WHERE price > 0;  -- â­ æ¡ä»¶å·²ä¿è¯

-- æŸ¥è¯¢è‡ªåŠ¨ä½¿ç”¨ç´¢å¼•
SELECT * FROM products WHERE price * 0.9 < 50;
-- ä½¿ç”¨ idx_products_discounted_price
```

---

## å››ã€å¤–é”®çº¦æŸå¢å¼º

### 4.1 çº§è”æ“ä½œæ€§èƒ½

**PostgreSQL 18æ‰¹é‡çº§è”ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºå¤–é”®
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE
);

-- æ‰¹é‡åˆ é™¤ç”¨æˆ·ï¼ˆè§¦å‘çº§è”ï¼‰
DELETE FROM users WHERE last_login < '2020-01-01';  -- åˆ é™¤10ä¸‡ç”¨æˆ·

-- PostgreSQL 17ï¼šé€è¡Œçº§è”åˆ é™¤ï¼Œæ…¢
-- æ—¶é—´ï¼š5åˆ†é’Ÿ

-- PostgreSQL 18ï¼šæ‰¹é‡çº§è”åˆ é™¤
-- å†…éƒ¨ä¼˜åŒ–ï¼š
-- 1. æ”¶é›†è¦åˆ é™¤çš„user_id
-- 2. æ‰¹é‡åˆ é™¤orders: DELETE FROM orders WHERE user_id IN (...)
-- 3. æäº¤
-- æ—¶é—´ï¼š30ç§’ï¼ˆæå‡10å€ï¼‰
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ“ä½œ | PG 17 | PG 18 | æå‡ |
|------|-------|-------|------|
| DELETE 1ä¸‡ç”¨æˆ·ï¼ˆCASCADEï¼‰| 30ç§’ | 3ç§’ | +900% |
| DELETE 10ä¸‡ç”¨æˆ· | 5åˆ†é’Ÿ | 30ç§’ | +900% |
| UPDATE 10ä¸‡ç”¨æˆ·ï¼ˆCASCADEï¼‰| 6åˆ†é’Ÿ | 35ç§’ | +925% |

### 4.2 åˆ†åŒºè¡¨å¤–é”®

**PostgreSQL 18æ”¯æŒåˆ†åŒºè¡¨ä½œä¸ºå¤–é”®å¼•ç”¨**ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name TEXT,
    created_at TIMESTAMPTZ
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE users_2024 PARTITION OF users
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- PostgreSQL 18ï¼šå¯ä»¥å¼•ç”¨åˆ†åŒºè¡¨ï¼
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),  -- âœ… æ”¯æŒåˆ†åŒºè¡¨
    amount NUMERIC(10, 2)
);

-- PostgreSQL 17ï¼šä¸æ”¯æŒï¼ŒæŠ¥é”™
-- ERROR: cannot reference partitioned table "users"
```

---

## äº”ã€ç”Ÿäº§æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå¤§è¡¨åœ¨çº¿æ·»åŠ çº¦æŸ

**åœºæ™¯**ï¼š

- è¡¨ï¼štransactionsï¼ˆ20äº¿è¡Œï¼‰
- éœ€æ±‚ï¼šæ·»åŠ CHECKçº¦æŸï¼ˆamount > 0ï¼‰
- è¦æ±‚ï¼šä¸åœæœº

**ä¼ ç»Ÿæ–¹å¼ï¼ˆå¤±è´¥ï¼‰**ï¼š

```sql
-- ç›´æ¥æ·»åŠ çº¦æŸ
ALTER TABLE transactions
ADD CONSTRAINT check_amount CHECK (amount > 0);

-- é—®é¢˜ï¼š
-- 1. æ‰«æ20äº¿è¡Œï¼Œéœ€è¦2å°æ—¶
-- 2. é”è¡¨2å°æ—¶ï¼Œä¸šåŠ¡åœæ­¢
-- ç»“æœï¼šä¸å¯æ¥å—
```

**PostgreSQL 18æ–¹æ¡ˆï¼ˆæˆåŠŸï¼‰**ï¼š

```sql
-- æ­¥éª¤1ï¼šæ·»åŠ NOT VALIDçº¦æŸï¼ˆç¬é—´ï¼‰
ALTER TABLE transactions
ADD CONSTRAINT check_amount CHECK (amount > 0) NOT VALID;
-- æ—¶é—´ï¼š<1ç§’
-- å½±å“ï¼šæœ€å°ï¼ˆShareRowExclusiveLockï¼‰

-- æ­¥éª¤2ï¼šå¹¶è¡ŒéªŒè¯ï¼ˆä¸šåŠ¡ç»§ç»­ï¼‰
SET max_parallel_maintenance_workers = 16;

ALTER TABLE transactions VALIDATE CONSTRAINT check_amount;
-- æ—¶é—´ï¼š8åˆ†é’Ÿï¼ˆvs 2å°æ—¶ï¼‰
-- é”ï¼šShareUpdateExclusiveLockï¼ˆå…è®¸è¯»å†™ï¼‰
```

**æ•ˆæœ**ï¼š

- åœæœºæ—¶é—´ï¼š2å°æ—¶ â†’ 8åˆ†é’Ÿï¼ˆ+1400%ï¼‰
- ä¸šåŠ¡å½±å“ï¼šå®Œå…¨åœæ­¢ â†’ å‡ ä¹æ— å½±å“
- æˆåŠŸéƒ¨ç½² âœ…

---

### æ¡ˆä¾‹2ï¼šåˆ†åŒºè¡¨çº¦æŸä¼˜åŒ–

**åœºæ™¯**ï¼š

- è¡¨ï¼šæ—¥å¿—è¡¨ï¼ŒæŒ‰æœˆåˆ†åŒºï¼Œ120ä¸ªåˆ†åŒºï¼ˆ10å¹´ï¼‰
- æŸ¥è¯¢ï¼šç»å¸¸æŸ¥è¯¢å•æœˆæ•°æ®
- é—®é¢˜ï¼šæŸ¥è¯¢æ…¢

**ä¼˜åŒ–å‰**ï¼š

```sql
EXPLAIN SELECT * FROM logs WHERE log_date = '2024-06-15';

-- è¾“å‡ºï¼š
Append  (actual time=...ms rows=...)
  ->  Seq Scan on logs_2024_01
  ->  Seq Scan on logs_2024_02
  ->  Seq Scan on logs_2024_03
  ...
  ->  Seq Scan on logs_2024_12
  ...
-- æ‰«ææ‰€æœ‰120ä¸ªåˆ†åŒºï¼
-- æ—¶é—´ï¼š15ç§’
```

**ä¼˜åŒ–ï¼šæ·»åŠ CHECKçº¦æŸ**ï¼š

```sql
-- ä¸ºæ¯ä¸ªåˆ†åŒºæ·»åŠ CHECKçº¦æŸ
ALTER TABLE logs_2024_01
ADD CONSTRAINT check_date_2024_01
CHECK (log_date >= '2024-01-01' AND log_date < '2024-02-01');

ALTER TABLE logs_2024_02
ADD CONSTRAINT check_date_2024_02
CHECK (log_date >= '2024-02-01' AND log_date < '2024-03-01');
-- ... å…¶ä»–åˆ†åŒº
```

**ä¼˜åŒ–å**ï¼š

```sql
EXPLAIN SELECT * FROM logs WHERE log_date = '2024-06-15';

-- è¾“å‡ºï¼š
Seq Scan on logs_2024_06  (actual time=...ms rows=...)
  Filter: (log_date = '2024-06-15')
  Partitions pruned: 119  -- â­ CHECKçº¦æŸæ’é™¤119ä¸ªåˆ†åŒº

-- æ—¶é—´ï¼š0.15ç§’ï¼ˆæå‡100å€ï¼ï¼‰
```

**æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ—¶é—´ï¼š15ç§’ â†’ 0.15ç§’ï¼ˆ+10000%ï¼‰
- æ‰«æåˆ†åŒºï¼š120ä¸ª â†’ 1ä¸ª
- I/Oï¼šå‡å°‘99%

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ4æ—¥
**æ–‡æ¡£ç¼–å·**: P4-9-CONSTRAINTS
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å®Œæˆ
