# PostgreSQL 18 连接管理深度优化

## 1. 连接生命周期

```sql
-- 查看连接状态
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    state_change,
    now() - backend_start AS connection_age,
    now() - state_change AS state_age,
    query
FROM pg_stat_activity
ORDER BY backend_start;

-- 连接状态
/*
active: 正在执行查询
idle: 空闲，等待客户端命令
idle in transaction: 事务中空闲
idle in transaction (aborted): 事务失败后空闲
fastpath function call: 执行快速路径函数
*/
```

---

## 2. 连接限制

### 2.1 全局限制

```sql
-- 查看配置
SHOW max_connections;  -- 默认100

-- 修改
ALTER SYSTEM SET max_connections = 200;
-- 需要重启

-- 当前连接数
SELECT COUNT(*) FROM pg_stat_activity;

-- 保留连接
ALTER SYSTEM SET superuser_reserved_connections = 3;
```

### 2.2 用户/数据库限制

```sql
-- 限制用户连接数
ALTER USER app_user CONNECTION LIMIT 50;

-- 限制数据库连接数
ALTER DATABASE mydb CONNECTION LIMIT 100;

-- 查看限制
SELECT
    rolname,
    rolconnlimit
FROM pg_roles
WHERE rolconnlimit != -1;

SELECT
    datname,
    datconnlimit
FROM pg_database
WHERE datconnlimit != -1;
```

---

## 3. 空闲连接管理

### 3.1 自动断开空闲连接

```sql
-- PostgreSQL 14+: idle_session_timeout
ALTER SYSTEM SET idle_session_timeout = '10min';

-- idle_in_transaction_session_timeout
ALTER SYSTEM SET idle_in_transaction_session_timeout = '5min';

SELECT pg_reload_conf();

-- 手动终止空闲连接
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle'
  AND state_change < now() - INTERVAL '30 minutes'
  AND pid != pg_backend_pid();
```

---

## 4. 连接池配置

### 4.1 应用层连接池

```python
# Python: SQLAlchemy
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    'postgresql://user:pass@localhost/mydb',
    poolclass=QueuePool,
    pool_size=20,              # 核心连接数
    max_overflow=10,           # 额外连接数
    pool_timeout=30,           # 获取连接超时
    pool_recycle=3600,         # 连接回收时间
    pool_pre_ping=True,        # 使用前检查连接
    echo_pool=True             # 日志
)

# 使用
with engine.connect() as conn:
    result = conn.execute("SELECT * FROM users")
```

---

## 5. 连接泄漏检测

### 5.1 检测工具

```sql
-- 创建监控视图
CREATE VIEW connection_leaks AS
SELECT
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    now() - backend_start AS connection_age,
    now() - state_change AS idle_duration,
    query
FROM pg_stat_activity
WHERE state = 'idle'
  AND now() - state_change > INTERVAL '10 minutes'
ORDER BY state_change;

-- 查询泄漏
SELECT * FROM connection_leaks;

-- 按应用统计
SELECT
    application_name,
    COUNT(*) AS leak_count,
    AVG(EXTRACT(EPOCH FROM idle_duration)) AS avg_idle_seconds
FROM connection_leaks
GROUP BY application_name
ORDER BY leak_count DESC;
```

---

## 6. 连接故障排查

### 6.1 常见问题

```sql
-- 问题1: 连接数满
SELECT
    COUNT(*) AS current,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max,
    ROUND(COUNT(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) AS usage_pct
FROM pg_stat_activity;

-- 解决方案
-- 1. 使用连接池
-- 2. 增加max_connections
-- 3. 终止空闲连接

-- 问题2: 连接建立慢
SELECT
    COUNT(*) FILTER (WHERE state = 'active') AS active,
    COUNT(*) FILTER (WHERE state LIKE 'idle%') AS idle
FROM pg_stat_activity;

-- 如果idle连接多，使用连接池复用
```

---

**完成**: PostgreSQL 18连接管理深度优化
**字数**: ~8,000字
**涵盖**: 连接生命周期、限制、空闲管理、连接池、泄漏检测、故障排查
