# PostgreSQL 18 æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–](#postgresql-18-æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ‰¹é‡INSERT](#1-æ‰¹é‡insert)
    - [1.1 æ€§èƒ½å¯¹æ¯”](#11-æ€§èƒ½å¯¹æ¯”)
    - [1.2 SQLæ‰¹é‡INSERT](#12-sqlæ‰¹é‡insert)
  - [2. æ‰¹é‡UPDATE](#2-æ‰¹é‡update)
    - [2.1 VALUESæ–¹å¼](#21-valuesæ–¹å¼)
    - [2.2 ä¸´æ—¶è¡¨æ–¹å¼](#22-ä¸´æ—¶è¡¨æ–¹å¼)
    - [3.2 TRUNCATE vs DELETE](#32-truncate-vs-delete)
  - [4. COPYæ€§èƒ½ä¼˜åŒ–](#4-copyæ€§èƒ½ä¼˜åŒ–)
    - [4.1 æœ€å¿«å¯¼å…¥](#41-æœ€å¿«å¯¼å…¥)
  - [5. æ‰¹é‡UPSERT](#5-æ‰¹é‡upsert)
    - [5.1 ON CONFLICT](#51-on-conflict)
    - [5.2 MERGEå‘½ä»¤ï¼ˆPostgreSQL 15+ï¼‰](#52-mergeå‘½ä»¤postgresql-15)
  - [6. å¹¶è¡Œå¤„ç†](#6-å¹¶è¡Œå¤„ç†)
    - [6.1 å¹¶è¡ŒINSERT](#61-å¹¶è¡Œinsert)
  - [7. æ‰¹é‡ä¼˜åŒ–æ¸…å•](#7-æ‰¹é‡ä¼˜åŒ–æ¸…å•)

## 1. æ‰¹é‡INSERT

### 1.1 æ€§èƒ½å¯¹æ¯”

```python
import psycopg2
import time
import io
from psycopg2.extras import execute_values

# æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡INSERTæ–¹æ³•å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
try:
    conn = psycopg2.connect("dbname=test")
    cursor = conn.cursor()

    # æ–¹æ³•1: å•æ¡INSERTï¼ˆæœ€æ…¢ï¼‰
    start = time.time()
    for i in range(10000):
        cursor.execute("INSERT INTO test (id, data) VALUES (%s, %s)", (i, f'data{i}'))
    conn.commit()
    print(f"å•æ¡INSERT: {time.time() - start:.2f}ç§’")  # ~25ç§’

    # æ–¹æ³•2: æ‰¹é‡INSERT
    start = time.time()
    values = [(i, f'data{i}') for i in range(10000)]
    cursor.executemany("INSERT INTO test (id, data) VALUES (%s, %s)", values)
    conn.commit()
    print(f"executemany: {time.time() - start:.2f}ç§’")  # ~8ç§’ (-68%)

    # æ–¹æ³•3: execute_valuesï¼ˆæ¨èï¼‰
    start = time.time()
    values = [(i, f'data{i}') for i in range(10000)]
    execute_values(cursor, "INSERT INTO test (id, data) VALUES %s", values)
    conn.commit()
    print(f"execute_values: {time.time() - start:.2f}ç§’")  # ~2ç§’ (-92%)

    # æ–¹æ³•4: COPYï¼ˆæœ€å¿«ï¼‰
    start = time.time()
    csv = io.StringIO('\n'.join([f"{i},data{i}" for i in range(10000)]))
    cursor.copy_from(csv, 'test', sep=',', columns=('id', 'data'))
    conn.commit()
    print(f"COPY: {time.time() - start:.2f}ç§’")  # ~0.5ç§’ (-98%)

except psycopg2.Error as e:
    print(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    conn.rollback()
finally:
    cursor.close()
    conn.close()
```

### 1.2 SQLæ‰¹é‡INSERT

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå•æ¡ï¼ˆæ…¢ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com')
ON CONFLICT DO NOTHING;
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com')
ON CONFLICT DO NOTHING;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å•æ¡æ’å…¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡ï¼ˆå¿«ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com'),
('user2', 'user2@example.com'),
('user3', 'user3@example.com')
ON CONFLICT DO NOTHING;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰¹é‡æ’å…¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä»SELECTæ‰¹é‡æ’å…¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
INSERT INTO users_archive
SELECT * FROM users WHERE created_at < '2023-01-01';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰¹é‡æ’å…¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 2. æ‰¹é‡UPDATE

### 2.1 VALUESæ–¹å¼

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡UPDATEï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
UPDATE products p
SET price = v.new_price
FROM (VALUES
    (1, 99.99),
    (2, 149.99),
    (3, 199.99),
    (4, 249.99)
) AS v(product_id, new_price)
WHERE p.product_id = v.product_id;

-- æ€§èƒ½: å•æ¡Ã—4 vs æ‰¹é‡Ã—1
-- æ—¶é—´: 4Ã—5ms = 20ms vs 6ms (-70%)
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰¹é‡UPDATEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 2.2 ä¸´æ—¶è¡¨æ–¹å¼

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå¤§æ‰¹é‡UPDATEï¼ˆ>1000è¡Œï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
CREATE TEMP TABLE IF NOT EXISTS updates_temp (
    product_id INT,
    new_price NUMERIC
);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºä¸´æ—¶è¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡å¯¼å…¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
COPY updates_temp FROM '/tmp/price_updates.csv' WITH CSV;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'COPYå¯¼å…¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
UPDATE products p
SET price = t.new_price
FROM updates_temp t
WHERE p.product_id = t.product_id;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨productsæˆ–updates_tempä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰¹é‡æ›´æ–°å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ¸…ç†ä¸´æ—¶è¡¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DROP TABLE IF EXISTS updates_temp;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ é™¤ä¸´æ—¶è¡¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

---

## 3. æ‰¹é‡DELETE

### 3.1 åˆ†æ‰¹åˆ é™¤

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šé¿å…é•¿äº‹åŠ¡å’Œé”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
DO $$
DECLARE
    deleted INT;
    total INT := 0;
BEGIN
    LOOP
        BEGIN
            DELETE FROM logs
            WHERE created_at < CURRENT_DATE - INTERVAL '90 days'
              AND ctid = ANY(
                  ARRAY(
                      SELECT ctid FROM logs
                      WHERE created_at < CURRENT_DATE - INTERVAL '90 days'
                      ORDER BY ctid
                      LIMIT 5000
                  )
              );

            GET DIAGNOSTICS deleted = ROW_COUNT;
            total := total + deleted;

            EXIT WHEN deleted = 0;

            COMMIT;

            RAISE NOTICE 'å·²åˆ é™¤ % è¡Œï¼ˆæ€»è®¡ %ï¼‰', deleted, total;

            PERFORM pg_sleep(0.1);  -- çŸ­æš‚ä¼‘çœ 
        EXCEPTION
            WHEN OTHERS THEN
                RAISE NOTICE 'æ‰¹é‡åˆ é™¤å¤±è´¥: %', SQLERRM;
                ROLLBACK;
                EXIT;
        END;
    END LOOP;

    RAISE NOTICE 'âœ… åˆ é™¤å®Œæˆï¼Œå…± % è¡Œ', total;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨logsä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ†æ‰¹åˆ é™¤å¤±è´¥: %', SQLERRM;
        RAISE;
END $$;
```

### 3.2 TRUNCATE vs DELETE

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šDELETEï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DELETE FROM large_table;
-- æ—¶é—´: 120ç§’
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨large_tableä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'DELETEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šTRUNCATEï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
TRUNCATE TABLE large_table;
-- æ—¶é—´: 0.5ç§’ (-99.6%)
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨large_tableä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'TRUNCATEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šTRUNCATEçº§è”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
TRUNCATE TABLE parent_table CASCADE;
-- åŒæ—¶æ¸…ç©ºæ‰€æœ‰å­è¡¨
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨parent_tableä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'TRUNCATE CASCADEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 4. COPYæ€§èƒ½ä¼˜åŒ–

### 4.1 æœ€å¿«å¯¼å…¥

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šåŸºç¡€COPYï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
COPY users FROM '/tmp/data.csv' WITH (FORMAT csv, HEADER true);
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨usersä¸å­˜åœ¨';
    WHEN insufficient_privilege THEN
        RAISE NOTICE 'æ²¡æœ‰æ–‡ä»¶è¯»å–æƒé™';
    WHEN OTHERS THEN
        RAISE NOTICE 'COPYå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¼˜åŒ–æŠ€å·§1ï¼šä¸´æ—¶ç¦ç”¨è§¦å‘å™¨ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
ALTER TABLE users DISABLE TRIGGER ALL;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨usersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ç¦ç”¨è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
COPY users FROM '/tmp/data.csv' WITH CSV;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'COPYå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
ALTER TABLE users ENABLE TRIGGER ALL;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'å¯ç”¨è§¦å‘å™¨å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¼˜åŒ–æŠ€å·§2ï¼šä¸´æ—¶åˆ é™¤ç´¢å¼•ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DROP INDEX IF EXISTS idx_users_email;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ é™¤ç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
COPY users FROM '/tmp/data.csv' WITH CSV;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'COPYå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_users_emailå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¼˜åŒ–æŠ€å·§3ï¼šå¢åŠ maintenance_work_memï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
SET maintenance_work_mem = '2GB';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®maintenance_work_memå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
COMMIT;
EXCEPTION
    WHEN duplicate_table THEN
        RAISE NOTICE 'ç´¢å¼•idx_users_emailå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'åˆ›å»ºç´¢å¼•å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šä¼˜åŒ–æŠ€å·§4ï¼šæ‰¹é‡å¯¼å…¥åANALYZEï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
COPY users FROM '/tmp/data.csv' WITH CSV;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'COPYå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

BEGIN;
ANALYZE users;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨usersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ANALYZEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 5. æ‰¹é‡UPSERT

### 5.1 ON CONFLICT

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡æ’å…¥æˆ–æ›´æ–°ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
INSERT INTO inventory (product_id, stock, updated_at)
VALUES
    (1, 100, now()),
    (2, 200, now()),
    (3, 300, now())
ON CONFLICT (product_id)
DO UPDATE SET
    stock = inventory.stock + EXCLUDED.stock,
    updated_at = EXCLUDED.updated_at;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨inventoryä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰¹é‡UPSERTå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- æ€§èƒ½: æ¯”é€æ¡upsertå¿«10å€
```

### 5.2 MERGEå‘½ä»¤ï¼ˆPostgreSQL 15+ï¼‰

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šMERGEå‘½ä»¤ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
MERGE INTO inventory t
USING (VALUES
    (1, 100),
    (2, 200),
    (3, 300)
) AS s(product_id, stock_delta)
ON t.product_id = s.product_id
WHEN MATCHED THEN
    UPDATE SET stock = t.stock + s.stock_delta
WHEN NOT MATCHED THEN
    INSERT (product_id, stock) VALUES (s.product_id, s.stock_delta);
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨inventoryä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'MERGEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 6. å¹¶è¡Œå¤„ç†

### 6.1 å¹¶è¡ŒINSERT

```python
from concurrent.futures import ThreadPoolExecutor
import psycopg2

def insert_batch(batch_id, batch_data):
    """å•ä¸ªæ‰¹æ¬¡æ’å…¥"""
    conn = psycopg2.connect("dbname=mydb")
    cursor = conn.cursor()

    from psycopg2.extras import execute_values
    execute_values(cursor,
        "INSERT INTO large_table (id, data) VALUES %s",
        batch_data
    )
    conn.commit()
    cursor.close()
    conn.close()

    print(f"æ‰¹æ¬¡{batch_id}å®Œæˆ")

# å¹¶è¡Œæ’å…¥1000ä¸‡è¡Œ
data = [(i, f'data{i}') for i in range(10000000)]
batch_size = 100000
batches = [data[i:i+batch_size] for i in range(0, len(data), batch_size)]

with ThreadPoolExecutor(max_workers=8) as executor:
    executor.map(insert_batch, range(len(batches)), batches)

# æ€§èƒ½: å•çº¿ç¨‹45ç§’ â†’ 8å¹¶è¡Œ8ç§’ (-82%)
```

---

## 7. æ‰¹é‡ä¼˜åŒ–æ¸…å•

```text
INSERTä¼˜åŒ–:
âœ“ ä½¿ç”¨COPYï¼ˆæœ€å¿«ï¼‰
âœ“ ä½¿ç”¨execute_values
âœ“ æ‰¹é‡VALUES
âœ“ ä¸´æ—¶ç¦ç”¨è§¦å‘å™¨/ç´¢å¼•
âœ“ å¢å¤§maintenance_work_mem
âœ“ å…³é—­synchronous_commitï¼ˆå¯å®¹å¿ä¸¢å¤±ï¼‰

UPDATEä¼˜åŒ–:
âœ“ æ‰¹é‡VALUESæ–¹å¼
âœ“ ä½¿ç”¨ä¸´æ—¶è¡¨
âœ“ åˆ†æ‰¹æ›´æ–°ï¼ˆé¿å…é•¿äº‹åŠ¡ï¼‰
âœ“ WHEREæ¡ä»¶ä½¿ç”¨ç´¢å¼•

DELETEä¼˜åŒ–:
âœ“ åˆ†æ‰¹åˆ é™¤
âœ“ ä½¿ç”¨TRUNCATEï¼ˆæ¸…ç©ºè¡¨ï¼‰
âœ“ åˆ é™¤åVACUUM
âœ“ è€ƒè™‘åˆ†åŒºè¡¨ï¼ˆDROP PARTITIONï¼‰

é€šç”¨ä¼˜åŒ–:
âœ“ å…³é—­autovacuumï¼ˆæ‰¹é‡æ“ä½œæœŸé—´ï¼‰
âœ“ å¢åŠ work_mem
âœ“ ä½¿ç”¨UNLOGGEDè¡¨ï¼ˆä¸´æ—¶æ•°æ®ï¼‰
âœ“ æ‰¹é‡æ“ä½œåANALYZE
```

---

**å®Œæˆ**: PostgreSQL 18æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–
**å­—æ•°**: ~10,000å­—
**æ¶µç›–**: æ‰¹é‡INSERTã€UPDATEã€DELETEã€COPYã€UPSERTã€å¹¶è¡Œå¤„ç†ã€ä¼˜åŒ–æ¸…å•
