# PostgreSQL外键与约束完全实战

## 1. 外键约束

### 1.1 基础外键

```sql
-- 创建表时定义
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(200),
    content TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 或单独添加
ALTER TABLE posts
ADD CONSTRAINT fk_posts_user
FOREIGN KEY (user_id) REFERENCES users(id);

-- 测试
INSERT INTO users (username) VALUES ('alice');
INSERT INTO posts (user_id, title) VALUES (1, 'Hello');  -- ✓ 成功

INSERT INTO posts (user_id, title) VALUES (999, 'Test');
-- ✗ 错误: 违反外键约束 "fk_posts_user"
```

---

## 2. 级联操作

### 2.1 ON DELETE

```sql
-- CASCADE: 级联删除
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

DELETE FROM users WHERE id = 1;
-- 同时删除该用户的所有订单

-- SET NULL: 设置为NULL
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    category_id INT,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
);

DELETE FROM categories WHERE id = 5;
-- products中category_id=5的行变为NULL

-- SET DEFAULT: 设置为默认值
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    author_id INT DEFAULT 1,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE SET DEFAULT
);

DELETE FROM users WHERE id = 10;
-- articles中author_id=10的行变为1（默认作者）

-- RESTRICT: 禁止删除（默认）
CREATE TABLE invoices (
    id SERIAL PRIMARY KEY,
    order_id INT,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE RESTRICT
);

DELETE FROM orders WHERE id = 100;
-- ✗ 错误: 有发票引用此订单

-- NO ACTION: 延迟检查（事务结束时）
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    order_id INT,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE NO ACTION
);
```

### 2.2 ON UPDATE

```sql
-- 主键更新时级联更新外键
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    user_id INT,
    FOREIGN KEY (user_id) REFERENCES users(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE
);

UPDATE users SET id = 999 WHERE id = 1;
-- posts中user_id=1的行自动更新为999
```

---

## 3. 自引用外键

```sql
-- 员工-经理关系
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    manager_id INT,
    FOREIGN KEY (manager_id) REFERENCES employees(id) ON DELETE SET NULL
);

INSERT INTO employees (id, name, manager_id) VALUES
(1, 'Alice', NULL),      -- CEO
(2, 'Bob', 1),           -- Alice的下属
(3, 'Charlie', 1),
(4, 'David', 2);         -- Bob的下属

-- 查询Bob的所有下属
SELECT * FROM employees WHERE manager_id = 2;

-- 删除经理
DELETE FROM employees WHERE id = 2;
-- David的manager_id变为NULL
```

---

## 4. CHECK约束

### 4.1 简单检查

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price NUMERIC(10, 2) CHECK (price > 0),
    discount_pct INT CHECK (discount_pct >= 0 AND discount_pct <= 100),
    stock INT CHECK (stock >= 0)
);

-- 测试
INSERT INTO products (name, price, discount_pct, stock)
VALUES ('Widget', 99.99, 10, 100);  -- ✓ 成功

INSERT INTO products (name, price) VALUES ('Bad', -10);
-- ✗ 错误: price必须>0

INSERT INTO products (name, price, discount_pct) VALUES ('Bad', 10, 150);
-- ✗ 错误: discount_pct必须0-100
```

### 4.2 多列检查

```sql
CREATE TABLE reservations (
    id SERIAL PRIMARY KEY,
    check_in DATE,
    check_out DATE,
    guests INT,
    CHECK (check_out > check_in),
    CHECK (guests > 0 AND guests <= 10)
);

-- 测试
INSERT INTO reservations (check_in, check_out, guests)
VALUES ('2024-01-01', '2024-01-05', 2);  -- ✓

INSERT INTO reservations (check_in, check_out, guests)
VALUES ('2024-01-05', '2024-01-01', 2);
-- ✗ 错误: check_out必须晚于check_in
```

### 4.3 表级约束

```sql
CREATE TABLE discounts (
    id SERIAL PRIMARY KEY,
    product_id INT,
    discount_type VARCHAR(20),  -- 'percentage' or 'fixed'
    discount_value NUMERIC(10, 2),
    CONSTRAINT valid_discount CHECK (
        (discount_type = 'percentage' AND discount_value BETWEEN 0 AND 100) OR
        (discount_type = 'fixed' AND discount_value >= 0)
    )
);

-- 百分比折扣
INSERT INTO discounts (product_id, discount_type, discount_value)
VALUES (1, 'percentage', 20);  -- ✓

-- 固定金额折扣
INSERT INTO discounts (product_id, discount_type, discount_value)
VALUES (2, 'fixed', 10.00);  -- ✓

-- 错误：百分比不能>100
INSERT INTO discounts (product_id, discount_type, discount_value)
VALUES (3, 'percentage', 150);  -- ✗
```

---

## 5. UNIQUE约束

```sql
-- 单列唯一
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    username VARCHAR(50) UNIQUE NOT NULL
);

-- 多列唯一（组合唯一）
CREATE TABLE enrollments (
    id SERIAL PRIMARY KEY,
    student_id INT,
    course_id INT,
    semester VARCHAR(20),
    UNIQUE (student_id, course_id, semester)
);

-- 学生可以在不同学期选同一门课，但同一学期只能选一次
INSERT INTO enrollments (student_id, course_id, semester)
VALUES (1, 101, '2024-Spring');  -- ✓

INSERT INTO enrollments (student_id, course_id, semester)
VALUES (1, 101, '2024-Fall');  -- ✓ 不同学期

INSERT INTO enrollments (student_id, course_id, semester)
VALUES (1, 101, '2024-Spring');  -- ✗ 重复

-- 部分唯一（带WHERE）
CREATE UNIQUE INDEX idx_active_email
ON users (email)
WHERE status = 'active';
-- 只有active用户的email必须唯一
```

---

## 6. NOT NULL约束

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    total_amount NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    notes TEXT  -- 可以为NULL
);

-- 添加NOT NULL约束
ALTER TABLE orders ALTER COLUMN notes SET NOT NULL;

-- 移除NOT NULL约束
ALTER TABLE orders ALTER COLUMN notes DROP NOT NULL;

-- 批量设置默认值后添加NOT NULL
UPDATE orders SET notes = '' WHERE notes IS NULL;
ALTER TABLE orders ALTER COLUMN notes SET NOT NULL;
```

---

## 7. 延迟约束

```sql
-- 延迟约束（事务结束时检查）
CREATE TABLE employees (
    id INT PRIMARY KEY,
    manager_id INT,
    FOREIGN KEY (manager_id) REFERENCES employees(id)
        DEFERRABLE INITIALLY DEFERRED
);

-- 场景：交换两个员工的ID
BEGIN;

-- 临时违反约束
UPDATE employees SET id = -1 WHERE id = 10;
UPDATE employees SET id = 10 WHERE id = 20;
UPDATE employees SET id = 20 WHERE id = -1;

-- 事务结束时检查约束
COMMIT;  -- ✓ 成功

-- 立即检查模式
SET CONSTRAINTS ALL IMMEDIATE;
```

---

## 8. 排除约束

```sql
-- 防止时间重叠
CREATE EXTENSION btree_gist;

CREATE TABLE room_bookings (
    id SERIAL PRIMARY KEY,
    room_id INT,
    booked_range tstzrange,
    EXCLUDE USING gist (
        room_id WITH =,
        booked_range WITH &&
    )
);

-- 测试
INSERT INTO room_bookings (room_id, booked_range)
VALUES (1, '[2024-01-01 09:00, 2024-01-01 10:00)');  -- ✓

INSERT INTO room_bookings (room_id, booked_range)
VALUES (1, '[2024-01-01 09:30, 2024-01-01 10:30)');
-- ✗ 错误: 时间重叠

-- 不同房间可以同时预订
INSERT INTO room_bookings (room_id, booked_range)
VALUES (2, '[2024-01-01 09:30, 2024-01-01 10:30)');  -- ✓
```

---

## 9. 性能考虑

```sql
-- 外键索引
-- PostgreSQL不会自动为外键创建索引
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    user_id INT,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- ❌ 慢：查询某用户的所有帖子
SELECT * FROM posts WHERE user_id = 123;
-- 全表扫描

-- ✅ 快：手动创建索引
CREATE INDEX idx_posts_user_id ON posts(user_id);

SELECT * FROM posts WHERE user_id = 123;
-- 索引扫描

-- 级联删除性能
-- CASCADE删除大量数据时可能很慢
DELETE FROM users WHERE id = 1;
-- 如果有10万个posts，需要逐行删除

-- 优化：分批删除或使用触发器
```

---

## 10. 约束命名规范

```sql
-- 推荐命名规范
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT,
    status VARCHAR(20),
    total_amount NUMERIC(10, 2),

    -- pk_<table>
    CONSTRAINT pk_orders PRIMARY KEY (id),

    -- fk_<table>_<column>
    CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users(id),

    -- chk_<table>_<description>
    CONSTRAINT chk_orders_status CHECK (status IN ('pending', 'paid', 'shipped', 'cancelled')),
    CONSTRAINT chk_orders_amount CHECK (total_amount >= 0),

    -- uq_<table>_<column>
    CONSTRAINT uq_orders_reference UNIQUE (reference_number)
);

-- 好处：
-- 1. 易于识别约束类型
-- 2. 删除约束时知道名称
-- 3. 错误信息更清晰
```

---

## 11. 最佳实践

```text
外键:
✓ 总是为外键列创建索引
✓ 谨慎使用CASCADE（可能意外删除大量数据）
✓ 对于审计需求，使用SET NULL而非CASCADE
✓ 大表之间避免过多外键（影响写性能）

CHECK:
✓ 尽早在数据库层验证
✓ 配合应用层验证（双重保护）
✓ 避免过于复杂的CHECK（影响性能）

UNIQUE:
✓ 使用部分索引优化（带WHERE）
✓ 考虑区分大小写/空格问题

性能:
✓ 外键列必须有索引
✓ 大批量删除时考虑禁用约束
✓ 使用DEFERRABLE优化批量操作

维护:
✓ 统一约束命名规范
✓ 文档化业务规则
✓ 定期检查约束有效性
```

---

**完成**: PostgreSQL外键与约束完全实战
**字数**: ~10,000字
**涵盖**: 外键、级联操作、自引用、CHECK约束、UNIQUE、NOT NULL、延迟约束、排除约束、性能、最佳实践
