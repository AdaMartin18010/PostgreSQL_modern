# PostgreSQL 18 æŸ¥è¯¢è®¡åˆ’ç¼“å­˜ä¼˜åŒ–

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 æŸ¥è¯¢è®¡åˆ’ç¼“å­˜ä¼˜åŒ–](#postgresql-18-æŸ¥è¯¢è®¡åˆ’ç¼“å­˜ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. Prepared Statements](#1-prepared-statements)
    - [1.1 åŸºç¡€ä½¿ç”¨](#11-åŸºç¡€ä½¿ç”¨)
    - [1.2 æ€§èƒ½å¯¹æ¯”](#12-æ€§èƒ½å¯¹æ¯”)
  - [2. è®¡åˆ’ç¼“å­˜ç­–ç•¥](#2-è®¡åˆ’ç¼“å­˜ç­–ç•¥)
    - [2.1 Generic vs Custom Plan](#21-generic-vs-custom-plan)
    - [2.2 å¼ºåˆ¶è®¡åˆ’ç±»å‹](#22-å¼ºåˆ¶è®¡åˆ’ç±»å‹)
  - [3. è®¡åˆ’å¤±æ•ˆ](#3-è®¡åˆ’å¤±æ•ˆ)
    - [3.1 ä½•æ—¶å¤±æ•ˆ](#31-ä½•æ—¶å¤±æ•ˆ)
  - [4. è¿æ¥æ± ä¸­çš„Prepared Statements](#4-è¿æ¥æ± ä¸­çš„prepared-statements)
    - [4.1 PgBounceré™åˆ¶](#41-pgbounceré™åˆ¶)
    - [4.2 åº”ç”¨å±‚å¤„ç†](#42-åº”ç”¨å±‚å¤„ç†)
  - [5. æŸ¥è¯¢è®¡åˆ’ç›‘æ§](#5-æŸ¥è¯¢è®¡åˆ’ç›‘æ§)
    - [5.1 æŸ¥çœ‹æ´»è·ƒè®¡åˆ’](#51-æŸ¥çœ‹æ´»è·ƒè®¡åˆ’)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

## 1. Prepared Statements

### 1.1 åŸºç¡€ä½¿ç”¨

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå‡†å¤‡è¯­å¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
PREPARE user_query (INT) AS
SELECT * FROM users WHERE user_id = $1;
COMMIT;
EXCEPTION
    WHEN duplicate_prepared_statement THEN
        RAISE NOTICE 'preparedè¯­å¥user_queryå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å‡†å¤‡è¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæ‰§è¡Œï¼ˆä½¿ç”¨ç¼“å­˜è®¡åˆ’ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
EXECUTE user_query(123);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰§è¡Œpreparedè¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹preparedè¯­å¥ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    statement,
    prepare_time,
    parameter_types
FROM pg_prepared_statements;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æŸ¥è¯¢preparedè¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- é‡Šæ”¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
DEALLOCATE user_query;
DEALLOCATE ALL;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'é‡Šæ”¾preparedè¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 1.2 æ€§èƒ½å¯¹æ¯”

```python
import psycopg2
import time

# æ€§èƒ½æµ‹è¯•ï¼šPrepared Statementæ€§èƒ½å¯¹æ¯”ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
try:
    conn = psycopg2.connect("dbname=mydb")
    cursor = conn.cursor()

    # ä¸ä½¿ç”¨prepared statement
    start = time.time()
    for i in range(1000):
        cursor.execute("SELECT * FROM users WHERE user_id = %s", (i,))
        cursor.fetchall()
    duration_no_prep = time.time() - start
    print(f"æ— prepared: {duration_no_prep:.2f}ç§’")

    # ä½¿ç”¨prepared statement
    cursor.execute("PREPARE user_stmt AS SELECT * FROM users WHERE user_id = $1")
    start = time.time()
    for i in range(1000):
        cursor.execute("EXECUTE user_stmt(%s)", (i,))
        cursor.fetchall()
    duration_prep = time.time() - start
    print(f"æœ‰prepared: {duration_prep:.2f}ç§’")

    # ç»“æœ:
    # æ— prepared: 2.5ç§’
    # æœ‰prepared: 1.8ç§’ (-28%)

    # æ¸…ç†
    cursor.execute("DEALLOCATE user_stmt")
    conn.commit()

except psycopg2.Error as e:
    print(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    conn.rollback()
finally:
    cursor.close()
    conn.close()
```

---

## 2. è®¡åˆ’ç¼“å­˜ç­–ç•¥

### 2.1 Generic vs Custom Plan

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šPostgreSQLè‡ªåŠ¨é€‰æ‹©é€šç”¨æˆ–è‡ªå®šä¹‰è®¡åˆ’ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
PREPARE user_query (INT) AS
SELECT * FROM users WHERE user_id = $1;
COMMIT;
EXCEPTION
    WHEN duplicate_prepared_statement THEN
        RAISE NOTICE 'preparedè¯­å¥user_queryå·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'å‡†å¤‡è¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå‰5æ¬¡ï¼šä½¿ç”¨custom planï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
EXECUTE user_query(1);
EXECUTE user_query(2);
EXECUTE user_query(3);
EXECUTE user_query(4);
EXECUTE user_query(5);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æ‰§è¡Œpreparedè¯­å¥å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- ç¬¬6æ¬¡ï¼šè¯„ä¼°generic plan
-- å¦‚æœgeneric planå¹³å‡æˆæœ¬ <= custom planå¹³å‡æˆæœ¬
-- åˆ™åˆ‡æ¢åˆ°generic plan

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹è®¡åˆ’ç±»å‹ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING) EXECUTE user_query(123);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æŸ¥çœ‹è®¡åˆ’ç±»å‹å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

### 2.2 å¼ºåˆ¶è®¡åˆ’ç±»å‹

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå¼ºåˆ¶custom planï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
SET LOCAL plan_cache_mode = 'force_custom_plan';
RAISE NOTICE 'å·²è®¾ç½®ä¸ºforce_custom_plan';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®plan_cache_modeå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šå¼ºåˆ¶generic planï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
SET LOCAL plan_cache_mode = 'force_generic_plan';
RAISE NOTICE 'å·²è®¾ç½®ä¸ºforce_generic_plan';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®plan_cache_modeå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šè‡ªåŠ¨é€‰æ‹©ï¼ˆé»˜è®¤ï¼‰ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
BEGIN;
SET LOCAL plan_cache_mode = 'auto';
RAISE NOTICE 'å·²è®¾ç½®ä¸ºautoï¼ˆé»˜è®¤ï¼‰';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®plan_cache_modeå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 3. è®¡åˆ’å¤±æ•ˆ

### 3.1 ä½•æ—¶å¤±æ•ˆ

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šå¯¼è‡´è®¡åˆ’å¤±æ•ˆçš„æ“ä½œï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰

-- 1. è¡¨ç»“æ„æ”¹å˜
BEGIN;
ALTER TABLE users ADD COLUMN IF NOT EXISTS status VARCHAR(20);
COMMIT;
EXCEPTION
    WHEN duplicate_column THEN
        RAISE NOTICE 'åˆ—statuså·²å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'æ·»åŠ åˆ—å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- prepared statementè‡ªåŠ¨å¤±æ•ˆ

-- 2. ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
BEGIN;
ANALYZE users;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'è¡¨usersä¸å­˜åœ¨';
    WHEN OTHERS THEN
        RAISE NOTICE 'ANALYZEå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- custom plané‡æ–°ç”Ÿæˆ

-- 3. é…ç½®å‚æ•°æ”¹å˜
BEGIN;
SET LOCAL work_mem = '512MB';
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'è®¾ç½®work_memå¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
-- å½±å“è®¡åˆ’é€‰æ‹©

-- 4. ä¼šè¯æ–­å¼€
-- prepared statementä¸¢å¤±
```

---

## 4. è¿æ¥æ± ä¸­çš„Prepared Statements

### 4.1 PgBounceré™åˆ¶

```ini
# pgbouncer.ini
pool_mode = transaction  # ä¸æ”¯æŒprepared statements

# è§£å†³æ–¹æ¡ˆ:
# 1. ä½¿ç”¨sessionæ¨¡å¼
pool_mode = session

# 2. æˆ–ä½¿ç”¨server_reset_queryæ¸…ç†
server_reset_query = DISCARD ALL

# 3. æˆ–ä¸ä½¿ç”¨prepared statements
```

### 4.2 åº”ç”¨å±‚å¤„ç†

```python
# Django: ç¦ç”¨server-side prepared statements
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'OPTIONS': {
            'options': '-c statement_timeout=30000 -c idle_in_transaction_session_timeout=60000'
        }
    }
}

# ä½¿ç”¨client-side bindingè€Œéserver-side prepared
```

---

## 5. æŸ¥è¯¢è®¡åˆ’ç›‘æ§

### 5.1 æŸ¥çœ‹æ´»è·ƒè®¡åˆ’

```sql
-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹prepared statementsï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    name,
    statement,
    prepare_time,
    parameter_types,
    from_sql  -- æ˜¯å¦æ¥è‡ªSQL PREPAREå‘½ä»¤
FROM pg_prepared_statements;
COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'æŸ¥è¯¢prepared statementså¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥çœ‹æ‰§è¡Œç»Ÿè®¡ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œæ€§èƒ½åˆ†æï¼‰
BEGIN;
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT
    LEFT(query, 100) AS query,
    calls,
    mean_exec_time,
    plans,
    mean_plan_time
FROM pg_stat_statements
WHERE query LIKE 'EXECUTE%'
ORDER BY calls DESC
LIMIT 20;
COMMIT;
EXCEPTION
    WHEN undefined_table THEN
        RAISE NOTICE 'pg_stat_statementsæ‰©å±•æœªå®‰è£…';
    WHEN OTHERS THEN
        RAISE NOTICE 'æŸ¥è¯¢æ‰§è¡Œç»Ÿè®¡å¤±è´¥: %', SQLERRM;
        ROLLBACK;
        RAISE;
```

---

## 6. æœ€ä½³å®è·µ

```text
ä½•æ—¶ä½¿ç”¨Prepared Statements:
âœ“ ç›¸åŒæŸ¥è¯¢å¤šæ¬¡æ‰§è¡Œ
âœ“ åªæœ‰å‚æ•°ä¸åŒ
âœ“ Sessionæ¨¡å¼è¿æ¥æ± 
âœ“ OLTPé«˜é¢‘æŸ¥è¯¢

ä½•æ—¶é¿å…:
âœ— Transactionæ¨¡å¼è¿æ¥æ± 
âœ— æŸ¥è¯¢åªæ‰§è¡Œä¸€æ¬¡
âœ— æŸ¥è¯¢æ¨¡å¼å˜åŒ–é¢‘ç¹
âœ— å‚æ•°åˆ†å¸ƒæä¸å‡åŒ€

æ€§èƒ½ä¼˜åŒ–:
âœ“ æ‰¹é‡æ‰§è¡Œç›¸åŒæŸ¥è¯¢
âœ“ ç›‘æ§è®¡åˆ’ç±»å‹é€‰æ‹©
âœ“ å®šæœŸANALYZEè¡¨
âœ“ ä½¿ç”¨åˆé€‚çš„pool_mode

æ³¨æ„äº‹é¡¹:
âœ“ æ£€æŸ¥è®¡åˆ’æ˜¯å¦æœ€ä¼˜
âœ“ ç›‘æ§å†…å­˜ä½¿ç”¨
âœ“ å¤„ç†è®¡åˆ’å¤±æ•ˆ
âœ“ æ¸…ç†ä¸ç”¨çš„prepared statements
```

---

**å®Œæˆ**: PostgreSQL 18æŸ¥è¯¢è®¡åˆ’ç¼“å­˜ä¼˜åŒ–
**å­—æ•°**: ~8,000å­—
**æ¶µç›–**: Prepared Statementsã€è®¡åˆ’ç¼“å­˜ã€Generic vs Customã€è¿æ¥æ± é›†æˆã€ç›‘æ§
