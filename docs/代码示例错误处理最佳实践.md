# ä»£ç ç¤ºä¾‹é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ
> **ç›®æ ‡**: ä¸ºæ‰€æœ‰ä»£ç ç¤ºä¾‹å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ ‡å‡†
> **çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†PostgreSQL_Moderné¡¹ç›®ä¸­æ‰€æœ‰ä»£ç ç¤ºä¾‹çš„é”™è¯¯å¤„ç†æ ‡å‡†ï¼Œç¡®ä¿ä»£ç ç¤ºä¾‹çš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ¯ é”™è¯¯å¤„ç†åŸåˆ™

### 1. ç»Ÿä¸€æ€§åŸåˆ™

æ‰€æœ‰ä»£ç ç¤ºä¾‹åº”éµå¾ªç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤ã€‚

### 2. å®Œæ•´æ€§åŸåˆ™

æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½åº”åŒ…å«é”™è¯¯å¤„ç†ï¼ŒåŒ…æ‹¬ï¼š
- æ•°æ®åº“è¿æ¥
- SQLæ‰§è¡Œ
- æ–‡ä»¶æ“ä½œ
- ç½‘ç»œè¯·æ±‚

### 3. ç”¨æˆ·å‹å¥½åŸåˆ™

é”™è¯¯ä¿¡æ¯åº”æ¸…æ™°ã€æœ‰ç”¨ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

---

## ğŸ“ SQLä»£ç é”™è¯¯å¤„ç†

### åŸºæœ¬æ¨¡å¼

```sql
-- æ¨¡å¼1: ä½¿ç”¨DOå—
DO $$
BEGIN
    -- å¯èƒ½å¤±è´¥çš„æ“ä½œ
    INSERT INTO users (username, email) VALUES ('alice', 'alice@example.com');
EXCEPTION
    WHEN unique_violation THEN
        RAISE NOTICE 'ç”¨æˆ·å·²å­˜åœ¨: %', SQLERRM;
    WHEN not_null_violation THEN
        RAISE NOTICE 'å¿…å¡«å­—æ®µä¸ºç©º: %', SQLERRM;
    WHEN OTHERS THEN
        RAISE NOTICE 'é”™è¯¯: %', SQLERRM;
        RAISE;
END $$;
```

### äº‹åŠ¡é”™è¯¯å¤„ç†

```sql
BEGIN;
    -- å¯èƒ½å¤±è´¥çš„æ“ä½œ
    INSERT INTO orders (user_id, amount) VALUES (1, 100);
    UPDATE accounts SET balance = balance - 100 WHERE id = 1;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE NOTICE 'äº‹åŠ¡å¤±è´¥: %', SQLERRM;
        RAISE;
COMMIT;
```

### å‡½æ•°é”™è¯¯å¤„ç†

```sql
CREATE OR REPLACE FUNCTION safe_insert_user(
    p_username VARCHAR,
    p_email VARCHAR
) RETURNS INTEGER AS $$
DECLARE
    v_user_id INTEGER;
BEGIN
    -- è¾“å…¥éªŒè¯
    IF p_username IS NULL OR p_username = '' THEN
        RAISE EXCEPTION 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º';
    END IF;

    IF p_email IS NULL OR p_email = '' THEN
        RAISE EXCEPTION 'é‚®ç®±ä¸èƒ½ä¸ºç©º';
    END IF;

    -- æ‰§è¡Œæ’å…¥
    INSERT INTO users (username, email)
    VALUES (p_username, p_email)
    RETURNING id INTO v_user_id;

    RETURN v_user_id;
EXCEPTION
    WHEN unique_violation THEN
        RAISE EXCEPTION 'ç”¨æˆ·å·²å­˜åœ¨: %', p_username;
    WHEN not_null_violation THEN
        RAISE EXCEPTION 'å¿…å¡«å­—æ®µä¸ºç©º';
    WHEN OTHERS THEN
        RAISE EXCEPTION 'æ’å…¥ç”¨æˆ·å¤±è´¥: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ Pythonä»£ç é”™è¯¯å¤„ç†

### åŸºæœ¬æ¨¡å¼

```python
import psycopg2
from psycopg2 import errorcodes

try:
    # è¿æ¥æ•°æ®åº“
    conn = psycopg2.connect(
        host="localhost",
        database="mydb",
        user="postgres",
        password="password"
    )
    cursor = conn.cursor()

    # æ‰§è¡ŒSQL
    cursor.execute(
        "INSERT INTO users (username, email) VALUES (%s, %s)",
        ('alice', 'alice@example.com')
    )
    conn.commit()

except psycopg2.IntegrityError as e:
    if e.pgcode == errorcodes.UNIQUE_VIOLATION:
        print("é”™è¯¯: ç”¨æˆ·å·²å­˜åœ¨")
    elif e.pgcode == errorcodes.NOT_NULL_VIOLATION:
        print("é”™è¯¯: å¿…å¡«å­—æ®µä¸ºç©º")
    conn.rollback()

except psycopg2.OperationalError as e:
    print(f"è¿æ¥é”™è¯¯: {e}")

except psycopg2.Error as e:
    print(f"æ•°æ®åº“é”™è¯¯: {e}")
    conn.rollback()

except Exception as e:
    print(f"æœªçŸ¥é”™è¯¯: {e}")
    if 'conn' in locals():
        conn.rollback()
    raise

finally:
    # æ¸…ç†èµ„æº
    if 'cursor' in locals():
        cursor.close()
    if 'conn' in locals():
        conn.close()
```

### ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¨¡å¼

```python
from contextlib import contextmanager
import psycopg2

@contextmanager
def get_db_connection():
    """æ•°æ®åº“è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    conn = None
    try:
        conn = psycopg2.connect(
            host="localhost",
            database="mydb",
            user="postgres",
            password="password"
        )
        yield conn
        conn.commit()
    except Exception as e:
        if conn:
            conn.rollback()
        raise
    finally:
        if conn:
            conn.close()

# ä½¿ç”¨
try:
    with get_db_connection() as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users")
        results = cursor.fetchall()
except psycopg2.Error as e:
    print(f"æ•°æ®åº“é”™è¯¯: {e}")
```

---

## ğŸš Shellè„šæœ¬é”™è¯¯å¤„ç†

### åŸºæœ¬æ¨¡å¼

```bash
#!/bin/bash

# è®¾ç½®é”™è¯¯å¤„ç†
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™
set -o pipefail  # ç®¡é“å‘½ä»¤å¤±è´¥æ—¶é€€å‡º

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    echo "é”™è¯¯: $1" >&2
    exit 1
}

# æ‰§è¡Œå‘½ä»¤å¹¶æ£€æŸ¥ç»“æœ
psql -h localhost -U postgres -d mydb -c "SELECT * FROM users" || error_exit "æŸ¥è¯¢å¤±è´¥"

# æˆ–è€…ä½¿ç”¨ifè¯­å¥
if ! psql -h localhost -U postgres -d mydb -c "SELECT * FROM users"; then
    echo "é”™è¯¯: æŸ¥è¯¢å¤±è´¥"
    exit 1
fi
```

### å¸¦æ¸…ç†çš„é”™è¯¯å¤„ç†

```bash
#!/bin/bash

set -e
set -u

# æ¸…ç†å‡½æ•°
cleanup() {
    echo "æ‰§è¡Œæ¸…ç†..."
    # æ¸…ç†æ“ä½œ
}

# æ³¨å†Œæ¸…ç†å‡½æ•°
trap cleanup EXIT

# ä¸»é€»è¾‘
psql -h localhost -U postgres -d mydb <<EOF
BEGIN;
    INSERT INTO users (username, email) VALUES ('alice', 'alice@example.com');
COMMIT;
EOF

if [ $? -ne 0 ]; then
    echo "é”™è¯¯: SQLæ‰§è¡Œå¤±è´¥"
    exit 1
fi
```

---

## ğŸ“Š é”™è¯¯å¤„ç†æ£€æŸ¥æ¸…å•

### SQLä»£ç æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰äº‹åŠ¡æ“ä½œåŒ…å«EXCEPTIONå—
- [ ] æ‰€æœ‰å‡½æ•°åŒ…å«é”™è¯¯å¤„ç†
- [ ] é”™è¯¯ä¿¡æ¯æ¸…æ™°æœ‰ç”¨
- [ ] é€‚å½“ä½¿ç”¨ROLLBACK
- [ ] åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯

### Pythonä»£ç æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œåŒ…å«try-except
- [ ] åŒºåˆ†ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼ˆIntegrityErrorã€OperationalErrorç­‰ï¼‰
- [ ] ä½¿ç”¨finallyç¡®ä¿èµ„æºæ¸…ç†
- [ ] é”™è¯¯ä¿¡æ¯åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] é€‚å½“ä½¿ç”¨æ—¥å¿—è®°å½•

### Shellè„šæœ¬æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨set -eã€set -u
- [ ] æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ
- [ ] ä½¿ç”¨é”™è¯¯å¤„ç†å‡½æ•°
- [ ] æ³¨å†Œæ¸…ç†å‡½æ•°ï¼ˆtrapï¼‰
- [ ] æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ”§ å·¥å…·æ”¯æŒ

### è‡ªåŠ¨æ£€æŸ¥å·¥å…·

ä½¿ç”¨ `scripts/code_example_error_handler.py` è‡ªåŠ¨æ‰«æä»£ç ç¤ºä¾‹ï¼š

```bash
# æ‰«ææŒ‡å®šç›®å½•
python scripts/code_example_error_handler.py --root docs --output report.md

# æ‰«ææ•´ä¸ªé¡¹ç›®
python scripts/code_example_error_handler.py --root . --output full_report.md
```

### æŠ¥å‘Šæ ¼å¼

å·¥å…·ä¼šç”ŸæˆåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„æŠ¥å‘Šï¼š
- æ–‡ä»¶è·¯å¾„å’Œè¡Œå·
- ä»£ç è¯­è¨€
- é—®é¢˜ç±»å‹
- æ”¹è¿›å»ºè®®

---

## ğŸ“š å‚è€ƒèµ„æº

### PostgreSQLé”™è¯¯ä»£ç 

- [PostgreSQLé”™è¯¯ä»£ç åˆ—è¡¨](https://www.postgresql.org/docs/current/errcodes-appendix.html)
- [psycopg2é”™è¯¯ä»£ç ](https://www.psycopg.org/docs/errors.html)

### æœ€ä½³å®è·µ

- [PostgreSQLé”™è¯¯å¤„ç†æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html)
- [Pythonå¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ](https://docs.python.org/3/tutorial/errors.html)

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**ç‰ˆæœ¬**: v1.0
