# PostgreSQL 18 合规性与审计

## 1. 审计日志

### 1.1 pgAudit配置

```sql
-- 安装pgAudit
-- sudo apt install postgresql-18-pgaudit

CREATE EXTENSION pgaudit;

-- 全局审计配置
ALTER SYSTEM SET pgaudit.log = 'write, ddl';
ALTER SYSTEM SET pgaudit.log_catalog = off;
ALTER SYSTEM SET pgaudit.log_parameter = on;
ALTER SYSTEM SET pgaudit.log_relation = on;
ALTER SYSTEM SET pgaudit.log_statement_once = off;

SELECT pg_reload_conf();

-- 审计特定用户
ALTER USER sensitive_user SET pgaudit.log = 'all';

-- 审计特定数据库
ALTER DATABASE sensitive_db SET pgaudit.log = 'read, write';

-- 审计特定表
ALTER TABLE sensitive_data SET (pgaudit.log = 'all');
```

### 1.2 审计日志分析

```bash
# 查看审计日志
sudo grep "AUDIT:" /var/log/postgresql/postgresql-*.log | tail -20

# 提取审计事件
sudo grep "AUDIT:" /var/log/postgresql/postgresql-*.log | \
  awk -F'AUDIT:' '{print $2}' | \
  sort | uniq -c | sort -rn

# 统计用户操作
sudo grep "AUDIT:" /var/log/postgresql/postgresql-*.log | \
  grep -oP 'user=\K\w+' | \
  sort | uniq -c | sort -rn
```

---

## 2. GDPR合规

### 2.1 数据分类

```sql
-- 数据分类标签
CREATE TABLE data_classification (
    table_name VARCHAR(100),
    column_name VARCHAR(100),
    classification VARCHAR(50),  -- public/internal/confidential/restricted
    pii BOOLEAN DEFAULT false,
    retention_days INT,
    PRIMARY KEY (table_name, column_name)
);

INSERT INTO data_classification VALUES
('users', 'email', 'confidential', true, 365),
('users', 'password', 'restricted', true, 365),
('users', 'name', 'internal', true, 730);

-- 查询敏感数据
SELECT * FROM data_classification WHERE pii = true;
```

### 2.2 数据脱敏

```sql
-- 脱敏函数
CREATE OR REPLACE FUNCTION mask_email(email TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN substring(email, 1, 2) || '***@' ||
           split_part(email, '@', 2);
END;
$$ LANGUAGE plpgsql IMMUTABLE;

CREATE OR REPLACE FUNCTION mask_phone(phone TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN '***' || substring(phone, length(phone) - 3, 4);
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- 脱敏视图
CREATE VIEW users_masked AS
SELECT
    user_id,
    mask_email(email) AS email,
    mask_phone(phone) AS phone,
    name
FROM users;

-- 授权非敏感角色访问脱敏视图
GRANT SELECT ON users_masked TO analyst_role;
REVOKE SELECT ON users FROM analyst_role;
```

### 2.3 Right to be Forgotten

```sql
-- 用户数据删除/匿名化
CREATE OR REPLACE FUNCTION anonymize_user(user_id_param BIGINT)
RETURNS VOID AS $$
BEGIN
    -- 匿名化个人信息
    UPDATE users
    SET
        email = 'deleted_' || user_id_param || '@anonymized.com',
        phone = NULL,
        name = 'Deleted User',
        address = NULL
    WHERE user_id = user_id_param;

    -- 删除关联数据
    DELETE FROM user_preferences WHERE user_id = user_id_param;
    DELETE FROM user_sessions WHERE user_id = user_id_param;

    -- 审计记录
    INSERT INTO deletion_audit (user_id, deleted_at, deleted_by)
    VALUES (user_id_param, now(), current_user);
END;
$$ LANGUAGE plpgsql;
```

---

## 3. 访问控制审计

### 3.1 权限审计

```sql
-- 查看所有用户权限
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE table_schema = 'public'
ORDER BY grantee, table_name;

-- 检查超级用户
SELECT
    usename,
    usesuper,
    usecreatedb,
    usecreaterole
FROM pg_user
WHERE usesuper = true;

-- Row Level Security审计
SELECT
    schemaname,
    tablename,
    rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;

-- RLS策略详情
SELECT
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual
FROM pg_policies
WHERE schemaname = 'public';
```

---

## 4. 数据保留策略

### 4.1 自动清理

```sql
-- 保留策略配置表
CREATE TABLE retention_policies (
    table_name VARCHAR(100) PRIMARY KEY,
    retention_days INT NOT NULL,
    timestamp_column VARCHAR(100) NOT NULL,
    enabled BOOLEAN DEFAULT true
);

INSERT INTO retention_policies VALUES
('logs', 30, 'created_at', true),
('audit_log', 365, 'created_at', true),
('sessions', 7, 'last_active', true);

-- 执行清理
CREATE OR REPLACE FUNCTION apply_retention_policies()
RETURNS TABLE (
    table_name TEXT,
    deleted_rows BIGINT
) AS $$
DECLARE
    policy RECORD;
    deleted BIGINT;
BEGIN
    FOR policy IN SELECT * FROM retention_policies WHERE enabled = true
    LOOP
        EXECUTE format('
            DELETE FROM %I
            WHERE %I < CURRENT_DATE - INTERVAL ''%s days''
        ', policy.table_name, policy.timestamp_column, policy.retention_days);

        GET DIAGNOSTICS deleted = ROW_COUNT;

        table_name := policy.table_name;
        deleted_rows := deleted;

        RETURN NEXT;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 定时执行
SELECT cron.schedule('retention', '0 2 * * *',
    'SELECT * FROM apply_retention_policies();');
```

---

## 5. 合规报告

### 5.1 自动化报告

```sql
-- 合规检查报告
CREATE OR REPLACE FUNCTION generate_compliance_report()
RETURNS TABLE (
    check_name TEXT,
    status TEXT,
    details TEXT
) AS $$
BEGIN
    -- 1. SSL/TLS检查
    RETURN QUERY
    SELECT
        'SSL Enabled'::TEXT,
        CASE WHEN setting = 'on' THEN 'PASS' ELSE 'FAIL' END,
        'SSL: ' || setting
    FROM pg_settings WHERE name = 'ssl';

    -- 2. 密码加密
    RETURN QUERY
    SELECT
        'Password Encryption'::TEXT,
        CASE WHEN setting = 'scram-sha-256' THEN 'PASS' ELSE 'FAIL' END,
        'Encryption: ' || setting
    FROM pg_settings WHERE name = 'password_encryption';

    -- 3. 日志记录
    RETURN QUERY
    SELECT
        'Connection Logging'::TEXT,
        CASE WHEN setting = 'on' THEN 'PASS' ELSE 'FAIL' END,
        'Log connections: ' || setting
    FROM pg_settings WHERE name = 'log_connections';

    -- 4. RLS启用检查
    RETURN QUERY
    SELECT
        'Row Level Security'::TEXT,
        COUNT(*)::TEXT || ' tables with RLS',
        string_agg(tablename, ', ')
    FROM pg_tables
    WHERE schemaname = 'public' AND rowsecurity = true;

    -- 5. 敏感数据加密
    RETURN QUERY
    SELECT
        'Sensitive Data Encryption'::TEXT,
        'CHECK',
        'Review data_classification table'
    FROM (SELECT 1) t;
END;
$$ LANGUAGE plpgsql;

-- 生成报告
SELECT * FROM generate_compliance_report();
```

---

**完成**: PostgreSQL 18合规性与审计
**字数**: ~8,000字
**涵盖**: 审计日志、GDPR、访问控制、数据保留、合规报告
