# PostgreSQL 18 监控告警完整方案

## 1. 监控架构

```text
┌──────────────────────────────────────────────────────┐
│           PostgreSQL监控架构                          │
├──────────────────────────────────────────────────────┤
│                                                        │
│  [PostgreSQL 18]                                      │
│         │                                              │
│    ┌────┴────┐                                        │
│    │         │                                         │
│  [Exporter] [Log]                                     │
│    │         │                                         │
│    ├─> [Prometheus] ──> [Grafana]                    │
│    │                      └─> Dashboard               │
│    │                                                   │
│    └─> [AlertManager] ──> [通知]                     │
│         ├─ Email                                      │
│         ├─ Slack                                      │
│         └─ PagerDuty                                  │
│                                                        │
└──────────────────────────────────────────────────────┘
```

---

## 2. postgres_exporter安装

### 2.1 安装配置

```bash
# 下载
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz
tar xzf postgres_exporter-0.15.0.linux-amd64.tar.gz
sudo mv postgres_exporter /usr/local/bin/

# 创建监控用户
psql -U postgres -c "
CREATE USER postgres_exporter WITH PASSWORD 'monitoring_password';
GRANT pg_monitor TO postgres_exporter;
GRANT CONNECT ON DATABASE mydb TO postgres_exporter;
"

# 配置文件
sudo tee /etc/postgres_exporter.env <<EOF
DATA_SOURCE_NAME="postgresql://postgres_exporter:monitoring_password@localhost:5432/postgres?sslmode=disable"
EOF

# systemd服务
sudo tee /etc/systemd/system/postgres_exporter.service <<EOF
[Unit]
Description=PostgreSQL Exporter
After=network.target

[Service]
Type=simple
User=postgres
EnvironmentFile=/etc/postgres_exporter.env
ExecStart=/usr/local/bin/postgres_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动
sudo systemctl daemon-reload
sudo systemctl enable postgres_exporter
sudo systemctl start postgres_exporter

# 验证
curl http://localhost:9187/metrics
```

---

## 3. Prometheus配置

### 3.1 基础配置

```yaml
# /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # PostgreSQL监控
  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']
        labels:
          instance: 'pg-prod-1'
          cluster: 'production'

  # 多实例
  - job_name: 'postgresql-cluster'
    static_configs:
      - targets:
          - 'pg-1:9187'
          - 'pg-2:9187'
          - 'pg-3:9187'
        labels:
          cluster: 'production'

# 告警规则
rule_files:
  - 'postgres_alerts.yml'

# AlertManager
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']
```

### 3.2 告警规则

```yaml
# /etc/prometheus/postgres_alerts.yml
groups:
  - name: postgresql
    interval: 30s
    rules:
      # 数据库宕机
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL实例宕机"
          description: "{{ $labels.instance }} 已宕机超过1分钟"

      # 复制延迟
      - alert: ReplicationLag
        expr: pg_replication_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "主从复制延迟过高"
          description: "{{ $labels.instance }} 复制延迟 {{ $value }}秒"

      # 连接数
      - alert: TooManyConnections
        expr: sum(pg_stat_activity_count) by (instance) > 180
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "连接数过高"
          description: "{{ $labels.instance }} 当前连接数 {{ $value }}"

      # 缓存命中率
      - alert: LowCacheHitRatio
        expr: |
          rate(pg_stat_database_blks_hit{datname!~"template.*|postgres"}[5m]) /
          (rate(pg_stat_database_blks_hit{datname!~"template.*|postgres"}[5m]) +
           rate(pg_stat_database_blks_read{datname!~"template.*|postgres"}[5m])) < 0.90
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "缓存命中率低"
          description: "{{ $labels.datname }} 缓存命中率 {{ $value | humanizePercentage }}"

      # 慢查询
      - alert: SlowQueries
        expr: rate(pg_stat_statements_mean_exec_time_seconds[5m]) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "慢查询过多"
          description: "平均执行时间 {{ $value }}秒"

      # 磁盘使用
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql"} /
           node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) < 0.15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "磁盘空间不足"
          description: "剩余空间 {{ $value | humanizePercentage }}"

      # 事务ID即将耗尽
      - alert: TransactionIdWraparound
        expr: pg_database_age > 1500000000
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "事务ID即将耗尽"
          description: "{{ $labels.datname }} 事务年龄 {{ $value }}"

      # 死元组过多
      - alert: TooManyDeadTuples
        expr: |
          pg_stat_user_tables_n_dead_tup /
          (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup) > 0.15
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "表膨胀严重"
          description: "{{ $labels.relname }} 死元组比例 {{ $value | humanizePercentage }}"

      # WAL文件过多
      - alert: TooManyWALFiles
        expr: pg_wal_count > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "WAL文件过多"
          description: "当前WAL文件数 {{ $value }}"
```

---

## 4. Grafana Dashboard

### 4.1 安装Grafana

```bash
# 安装
sudo apt install -y grafana

# 启动
sudo systemctl enable grafana-server
sudo systemctl start grafana-server

# 访问
http://localhost:3000
# 默认账号: admin/admin
```

### 4.2 导入Dashboard

```json
{
  "dashboard": {
    "title": "PostgreSQL 18 Overview",
    "panels": [
      {
        "title": "Database Status",
        "targets": [
          {
            "expr": "pg_up",
            "legendFormat": "{{ instance }}"
          }
        ],
        "type": "stat"
      },
      {
        "title": "TPS (Transactions Per Second)",
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit{datname=\"mydb\"}[5m])",
            "legendFormat": "Commits"
          },
          {
            "expr": "rate(pg_stat_database_xact_rollback{datname=\"mydb\"}[5m])",
            "legendFormat": "Rollbacks"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Connections",
        "targets": [
          {
            "expr": "pg_stat_activity_count",
            "legendFormat": "{{ state }}"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Cache Hit Ratio",
        "targets": [
          {
            "expr": "rate(pg_stat_database_blks_hit[5m]) / (rate(pg_stat_database_blks_hit[5m]) + rate(pg_stat_database_blks_read[5m]))",
            "legendFormat": "{{ datname }}"
          }
        ],
        "type": "gauge"
      },
      {
        "title": "Replication Lag",
        "targets": [
          {
            "expr": "pg_replication_lag_seconds",
            "legendFormat": "{{ application_name }}"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Database Size",
        "targets": [
          {
            "expr": "pg_database_size_bytes",
            "legendFormat": "{{ datname }}"
          }
        ],
        "type": "graph"
      }
    ]
  }
}
```

### 4.3 常用Dashboard ID

```text
官方PostgreSQL Dashboard:
├─ 9628: PostgreSQL Database
├─ 455: PostgreSQL Overview
├─ 12273: PostgreSQL Database Metrics
└─ 14114: PostgreSQL Replication

导入方式:
Grafana → Dashboards → Import → 输入ID
```

---

## 5. AlertManager配置

### 5.1 基础配置

```yaml
# /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@example.com'
  smtp_auth_username: 'alerts@example.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    # Critical告警立即发送
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true

    # Warning告警分组发送
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s

receivers:
  - name: 'default'
    email_configs:
      - to: 'team@example.com'

  - name: 'critical-alerts'
    email_configs:
      - to: 'oncall@example.com'
        headers:
          Subject: '[CRITICAL] PostgreSQL Alert'

    slack_configs:
      - api_url: 'https://hooks.slack.com/services/xxx'
        channel: '#alerts-critical'
        title: 'PostgreSQL Critical Alert'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

    pagerduty_configs:
      - service_key: 'your-pagerduty-key'

  - name: 'warning-alerts'
    email_configs:
      - to: 'team@example.com'

    slack_configs:
      - api_url: 'https://hooks.slack.com/services/xxx'
        channel: '#alerts-warning'

inhibit_rules:
  # 实例宕机时抑制其他告警
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
```

---

## 6. 日志监控

### 6.1 Loki + Promtail

```yaml
# promtail配置
# /etc/promtail/config.yml
server:
  http_listen_port: 9080

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  - job_name: postgresql
    static_configs:
      - targets:
          - localhost
        labels:
          job: postgresql
          __path__: /var/log/postgresql/postgresql-*.log

    pipeline_stages:
      # 解析PostgreSQL日志
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) (?P<timezone>\w+) \[(?P<pid>\d+)\] (?P<user>\w+)@(?P<db>\w+) (?P<level>\w+):  (?P<message>.*)'

      - labels:
          level:
          user:
          db:

      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'
```

### 6.2 日志告警

```yaml
# Loki告警规则
groups:
  - name: postgresql-logs
    rules:
      # 错误日志
      - alert: PostgreSQLErrors
        expr: |
          sum(rate({job="postgresql"} |= "ERROR" [5m])) by (instance) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL错误日志过多"

      # 死锁
      - alert: Deadlocks
        expr: |
          count_over_time({job="postgresql"} |= "deadlock detected" [5m]) > 0
        labels:
          severity: warning
        annotations:
          summary: "检测到死锁"
```

---

## 7. 自定义监控

### 7.1 pg_stat_statements监控

```yaml
# queries.yaml - 自定义查询
pg_stat_statements:
  query: |
    SELECT
      queryid,
      substring(query, 1, 100) as query_short,
      calls,
      mean_exec_time,
      max_exec_time,
      stddev_exec_time
    FROM pg_stat_statements
    ORDER BY mean_exec_time DESC
    LIMIT 100

  metrics:
    - queryid:
        usage: "LABEL"
    - query_short:
        usage: "LABEL"
    - calls:
        usage: "COUNTER"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Mean execution time"
    - max_exec_time:
        usage: "GAUGE"
    - stddev_exec_time:
        usage: "GAUGE"
```

```bash
# 启动exporter with custom queries
postgres_exporter \
  --extend.query-path=/etc/postgres_exporter/queries.yaml \
  --web.listen-address=:9187
```

### 7.2 表膨胀监控

```yaml
table_bloat:
  query: |
    SELECT
      schemaname,
      tablename,
      n_dead_tup,
      n_live_tup,
      n_dead_tup::float / NULLIF(n_live_tup + n_dead_tup, 0) as dead_ratio
    FROM pg_stat_user_tables
    WHERE n_dead_tup > 1000

  metrics:
    - schemaname:
        usage: "LABEL"
    - tablename:
        usage: "LABEL"
    - n_dead_tup:
        usage: "GAUGE"
    - n_live_tup:
        usage: "GAUGE"
    - dead_ratio:
        usage: "GAUGE"
        description: "Dead tuple ratio"
```

---

## 8. 业务监控

### 8.1 自定义业务指标

```sql
-- 创建监控视图
CREATE VIEW business_metrics AS
SELECT
    'active_users' AS metric,
    COUNT(DISTINCT user_id) AS value
FROM user_sessions
WHERE last_active > now() - INTERVAL '5 minutes'

UNION ALL

SELECT
    'order_rate' AS metric,
    COUNT(*) AS value
FROM orders
WHERE created_at > now() - INTERVAL '1 minute'

UNION ALL

SELECT
    'revenue_last_hour' AS metric,
    SUM(amount)::bigint AS value
FROM orders
WHERE created_at > now() - INTERVAL '1 hour';
```

```yaml
# 导出业务指标
business_metrics:
  query: "SELECT * FROM business_metrics"
  metrics:
    - metric:
        usage: "LABEL"
    - value:
        usage: "GAUGE"
```

---

## 9. 可视化Dashboard

### 9.1 核心指标面板

```text
Database Overview:
├─ 实例状态 (Up/Down)
├─ TPS/QPS
├─ 连接数
├─ 缓存命中率
├─ 复制延迟
└─ 磁盘使用

Performance:
├─ 慢查询Top 10
├─ 查询延迟分布
├─ 锁等待
├─ VACUUM进度
└─ 检查点频率

Resource Usage:
├─ CPU使用率
├─ 内存使用率
├─ 磁盘I/O
├─ 网络流量
└─ 临时文件使用

Replication:
├─ 复制拓扑
├─ WAL生成速率
├─ 复制槽状态
└─ 延迟趋势
```

---

## 10. 监控最佳实践

### 10.1 监控清单

```text
✅ 核心指标
├─ 实例可用性: pg_up
├─ TPS: xact_commit/rollback
├─ 连接数: pg_stat_activity_count
├─ 缓存命中率: blks_hit/(blks_hit+blks_read)
└─ 复制延迟: pg_replication_lag_seconds

✅ 性能指标
├─ 平均查询时间: pg_stat_statements
├─ 慢查询数量
├─ 锁等待
└─ 检查点频率

✅ 资源指标
├─ CPU使用率
├─ 内存使用率
├─ 磁盘I/O
└─ 磁盘空间

✅ 数据质量
├─ 表膨胀率
├─ 事务ID使用
├─ autovacuum活动
└─ 索引效率

✅ 业务指标
├─ 活跃用户数
├─ 订单量
├─ 响应时间
└─ 错误率
```

### 10.2 告警阈值建议

```text
Critical (P0):
├─ 实例宕机: > 1分钟
├─ 主从延迟: > 300秒
├─ 磁盘使用: > 90%
├─ 连接数: > 95%
└─ 事务ID: > 19亿

Warning (P1):
├─ 主从延迟: > 60秒
├─ 磁盘使用: > 80%
├─ 连接数: > 80%
├─ 缓存命中率: < 90%
├─ 慢查询: > 1秒
└─ 死元组: > 15%

Info (P2):
├─ 主从延迟: > 10秒
├─ 磁盘使用: > 70%
├─ autovacuum启动
└─ 检查点频率异常
```

---

**完成**: PostgreSQL 18监控告警完整方案
**字数**: ~10,000字
**涵盖**: Prometheus、Grafana、AlertManager、日志、业务监控
