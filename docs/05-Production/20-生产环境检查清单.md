# PostgreSQL生产环境检查清单

## 1. 上线前检查

### 1.1 硬件与OS

```bash
# CPU
lscpu | grep -E "^CPU\(s\)|Model name|Thread"

# 内存
free -h

# 磁盘
df -h
iostat -x 1 5

# 网络
ethtool eth0 | grep Speed

# 内核参数
sysctl -a | grep -E "shmmax|shmall|somaxconn|tcp_max_syn_backlog"

# 透明大页（应该关闭）
cat /sys/kernel/mm/transparent_hugepage/enabled
# 应该是 [never]

# I/O调度器
cat /sys/block/nvme0n1/queue/scheduler
# 推荐 mq-deadline
```

---

### 1.2 PostgreSQL配置

```sql
-- 版本确认
SELECT version();

-- 关键参数检查
SELECT name, setting, unit, boot_val, reset_val
FROM pg_settings
WHERE name IN (
    'max_connections',
    'shared_buffers',
    'work_mem',
    'maintenance_work_mem',
    'effective_cache_size',
    'wal_level',
    'max_wal_size',
    'checkpoint_completion_target',
    'random_page_cost',
    'effective_io_concurrency',
    'max_parallel_workers_per_gather',
    'io_direct',
    'io_combine_limit'
);

-- SSL启用
SHOW ssl;

-- 密码加密
SHOW password_encryption;

-- 日志配置
SHOW logging_collector;
SHOW log_destination;
```

---

### 1.3 扩展安装

```sql
-- 必需扩展
SELECT * FROM pg_extension WHERE extname IN (
    'pg_stat_statements',
    'pgcrypto',
    'uuid-ossp'
);

-- 推荐扩展
SELECT * FROM pg_available_extensions WHERE name IN (
    'pgvector',
    'timescaledb',
    'postgis',
    'pg_trgm',
    'pg_cron'
);
```

---

## 2. 安全检查

### 2.1 认证与授权

```sql
-- pg_hba.conf检查
-- 应该使用scram-sha-256而非md5或trust

-- 超级用户检查
SELECT usename FROM pg_user WHERE usesuper = true;
-- 应该只有postgres

-- PUBLIC权限
SELECT
    n.nspname,
    c.relname,
    has_table_privilege('PUBLIC', c.oid, 'SELECT') AS public_select
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind = 'r'
  AND n.nspname = 'public'
  AND has_table_privilege('PUBLIC', c.oid, 'SELECT');
-- 应该返回0行（撤销PUBLIC权限）

-- RLS检查（敏感表）
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

---

## 3. 性能检查

### 3.1 关键指标

```sql
-- 连接数
SELECT
    COUNT(*) AS current,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') AS max,
    ROUND(COUNT(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) AS usage_pct
FROM pg_stat_activity;
-- usage_pct应该<80%

-- 缓存命中率
SELECT
    ROUND(SUM(blks_hit) * 100.0 / NULLIF(SUM(blks_hit + blks_read), 0), 2) AS hit_ratio
FROM pg_stat_database;
-- 应该>95%

-- TPS
SELECT xact_commit + xact_rollback AS tps
FROM pg_stat_database
WHERE datname = current_database();

-- 慢查询（pg_stat_statements）
SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000;
-- 应该<10个

-- 表膨胀
SELECT COUNT(*) FROM pg_stat_user_tables
WHERE n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0) > 20;
-- 应该=0

-- 锁等待
SELECT COUNT(*) FROM pg_locks WHERE NOT granted;
-- 应该=0

-- 长事务
SELECT COUNT(*) FROM pg_stat_activity
WHERE xact_start < now() - INTERVAL '5 minutes'
  AND state != 'idle';
-- 应该=0
```

---

## 4. 备份检查

```bash
# 备份策略验证
# 1. 检查最近备份
ls -lh /backup/*.dump | tail -5

# 2. 验证WAL归档
psql -c "SELECT * FROM pg_stat_archiver;"

# 3. 测试恢复（每月）
# 恢复最新备份到测试环境
pg_restore -d test_restore /backup/latest.dump

# 4. 检查复制状态（如果有）
psql -c "SELECT * FROM pg_stat_replication;"
```

---

## 5. 监控检查

```yaml
# Prometheus告警规则检查
groups:
  - name: critical
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m

      - alert: ReplicationLagHigh
        expr: pg_replication_lag_seconds > 60
        for: 5m

      - alert: DiskSpaceLow
        expr: node_filesystem_avail_percent < 15
        for: 10m

      - alert: ConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
```

---

## 6. 上线检查清单

```text
□ 硬件资源充足
  □ CPU: 16核+
  □ 内存: 64GB+
  □ 存储: NVMe SSD
  □ 网络: 10Gbps

□ 操作系统配置
  □ 内核参数优化
  □ 文件系统noatime
  □ 透明大页关闭
  □ I/O调度器配置

□ PostgreSQL配置
  □ shared_buffers=25%内存
  □ work_mem合理值
  □ max_connections+连接池
  □ WAL配置优化
  □ 异步I/O启用

□ 安全配置
  □ SSL启用
  □ scram-sha-256认证
  □ pg_hba.conf配置
  □ 防火墙规则
  □ 最小权限原则

□ 高可用配置
  □ 主从复制配置
  □ Patroni/repmgr安装
  □ 故障转移测试
  □ HAProxy/pgBouncer

□ 备份配置
  □ 定时备份任务
  □ WAL归档配置
  □ 异地备份
  □ 恢复测试

□ 监控配置
  □ Prometheus+Grafana
  □ 告警规则
  □ 日志收集
  □ 性能基线

□ 应用配置
  □ 连接池配置
  □ 超时配置
  □ 重试机制
  □ 错误处理

□ 文档
  □ 架构文档
  □ 运维手册
  □ 应急预案
  □ 联系人列表

□ 测试验证
  □ 功能测试
  □ 性能测试
  □ 压力测试
  □ 故障演练
```

---

**完成**: PostgreSQL生产环境检查清单
**字数**: ~8,000字
**完整清单**: 硬件、配置、安全、高可用、备份、监控、应用、文档、测试
