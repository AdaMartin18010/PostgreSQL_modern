# PostgreSQL 升级迁移完整指南

## 1. 升级方式对比

```text
┌──────────────┬──────────┬──────────┬──────────┬─────────────┐
│ 升级方式     │ 停机时间 │ 回退难度 │ 数据复制 │ 适用场景    │
├──────────────┼──────────┼──────────┼──────────┼─────────────┤
│ pg_upgrade   │ 分钟级   │ 中       │ link模式 │ 小型库      │
│ 逻辑复制     │ 近零     │ 易       │ 在线     │ 生产环境    │
│ dump/restore │ 小时级   │ 易       │ 完整     │ 小库/测试   │
│ Slony-I      │ 近零     │ 中       │ 在线     │ 9.x→新版本  │
└──────────────┴──────────┴──────────┴──────────┴─────────────┘
```

---

## 2. pg_upgrade（推荐）

### 2.1 升级准备

```bash
# 检查兼容性
/usr/lib/postgresql/18/bin/pg_upgrade \
  --old-datadir=/var/lib/postgresql/16/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/16/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --check

# 安装新版本
sudo apt install postgresql-18

# 停止两个版本
sudo systemctl stop postgresql@16-main
sudo systemctl stop postgresql@18-main

# 备份
pg_dumpall -h localhost -p 5432 -U postgres -f /backup/before_upgrade.sql
```

### 2.2 执行升级

```bash
# 切换到postgres用户
sudo su - postgres

# link模式升级（最快）
/usr/lib/postgresql/18/bin/pg_upgrade \
  --old-datadir=/var/lib/postgresql/16/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/16/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --link \
  --jobs=4

# copy模式（更安全）
/usr/lib/postgresql/18/bin/pg_upgrade \
  --old-datadir=/var/lib/postgresql/16/main \
  --new-datadir=/var/lib/postgresql/18/main \
  --old-bindir=/usr/lib/postgresql/16/bin \
  --new-bindir=/usr/lib/postgresql/18/bin \
  --jobs=4
```

### 2.3 升级后处理

```bash
# 启动新版本
sudo systemctl start postgresql@18-main

# 运行分析脚本
./analyze_new_cluster.sh

# 更新统计信息
psql -U postgres -d mydb -c "ANALYZE;"

# 删除旧集群（确认无误后）
./delete_old_cluster.sh
```

---

## 3. 逻辑复制升级

### 3.1 配置发布端（旧版本）

```sql
-- PostgreSQL 16配置
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_replication_slots = 10;
ALTER SYSTEM SET max_wal_senders = 10;

-- 重启
SELECT pg_reload_conf();

-- 创建发布
CREATE PUBLICATION my_pub FOR ALL TABLES;

-- 查看发布
SELECT * FROM pg_publication;
```

### 3.2 配置订阅端（新版本）

```sql
-- PostgreSQL 18
-- 创建相同schema
pg_dump -h old-server -U postgres -d mydb -s | psql -h new-server -d mydb

-- 创建订阅
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=old-server port=5432 dbname=mydb user=replicator password=xxx'
PUBLICATION my_pub;

-- 监控同步状态
SELECT * FROM pg_stat_subscription;

-- 查看复制延迟
SELECT
    subname,
    received_lsn,
    latest_end_lsn,
    pg_size_pretty(pg_wal_lsn_diff(latest_end_lsn, received_lsn)) AS lag
FROM pg_stat_subscription;
```

### 3.3 切换流程

```bash
# 1. 确认数据同步完成
psql -h new-server -U postgres -d mydb -c "
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM orders;
"

# 2. 停止应用写入
# 修改应用配置或HAProxy

# 3. 等待最后的数据同步

# 4. 禁用订阅
psql -h new-server -U postgres -d mydb -c "
ALTER SUBSCRIPTION my_sub DISABLE;
"

# 5. 删除发布/订阅（可选）
psql -h old-server -U postgres -d mydb -c "DROP PUBLICATION my_pub;"
psql -h new-server -U postgres -d mydb -c "DROP SUBSCRIPTION my_sub;"

# 6. 切换应用到新服务器
# 更新DNS或修改连接字符串

# 7. 验证
psql -h new-server -U postgres -d mydb -c "SELECT version();"
```

---

## 4. dump/restore升级

### 4.1 导出数据

```bash
# 完整导出
pg_dumpall -h old-server -U postgres -f all_databases.sql

# 单库导出（并行）
pg_dump -h old-server -U postgres -d mydb \
  -F d -j 8 -f mydb_dump

# schema与数据分离
pg_dump -h old-server -U postgres -d mydb -s -f schema.sql
pg_dump -h old-server -U postgres -d mydb -a -f data.sql
```

### 4.2 导入数据

```bash
# 新版本导入
psql -h new-server -U postgres -f all_databases.sql

# 并行恢复
pg_restore -h new-server -U postgres -d mydb \
  -j 8 -F d mydb_dump

# 分步导入（推荐大库）
psql -h new-server -U postgres -d mydb -f schema.sql
psql -h new-server -U postgres -d mydb -f data.sql
```

---

## 5. 跨大版本升级（10/11→18）

### 5.1 兼容性检查

```bash
# 检查废弃特性
psql -U postgres -d mydb -c "
SELECT * FROM pg_extension WHERE extname IN (
    'tsearch2',  -- 已废弃
    'adminpack'  -- 部分功能改变
);
"

# 检查不兼容的数据类型
psql -U postgres -d mydb -c "
SELECT DISTINCT typname
FROM pg_type
WHERE typname IN ('abstime', 'reltime');  -- PostgreSQL 12+废弃
"
```

### 5.2 处理不兼容问题

```sql
-- 示例1: 更新hash索引（PostgreSQL 10）
-- hash索引在PG10后不兼容，需重建
SELECT
    schemaname,
    tablename,
    indexname
FROM pg_indexes
WHERE indexdef LIKE '%USING hash%';

-- 重建hash索引
REINDEX INDEX CONCURRENTLY idx_hash_example;

-- 示例2: 替换废弃函数
-- pg_current_xlog_location() → pg_current_wal_lsn()
UPDATE monitoring_scripts
SET query = replace(query, 'pg_current_xlog_location', 'pg_current_wal_lsn');
```

---

## 6. 最小停机升级

### 6.1 流式复制方案

```text
架构:
┌─────────────────────────────────────────┐
│  Old Primary (PG 16)                    │
│       │                                  │
│       ├──> New Primary (PG 18)          │
│       │     [Streaming Replication]     │
│       └──> Old Standby (PG 16)          │
│                                          │
│  切换后:                                 │
│  New Primary (PG 18) ← 应用             │
└─────────────────────────────────────────┘
```

### 6.2 实施步骤

```bash
# 1. 搭建PG18 Standby（从PG16 Primary复制）
# 使用pg_basebackup
pg_basebackup -h old-primary -U replication -D /var/lib/postgresql/18/main

# 2. 配置流复制
# standby.signal
primary_conninfo = 'host=old-primary port=5432 user=replication'
restore_command = 'cp /backup/wal/%f %p'

# 3. 监控同步延迟
SELECT pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn());

# 4. 停止应用写入（短暂）
# HAProxy设置maintenance模式

# 5. 等待同步完成
# 延迟<1MB

# 6. 提升PG18为Primary
pg_ctl promote -D /var/lib/postgresql/18/main

# 7. 切换应用连接
# 修改HAProxy配置

# 总停机时间: 1-5分钟
```

---

## 7. 云环境升级

### 7.1 AWS RDS升级

```bash
# 创建快照
aws rds create-db-snapshot \
  --db-instance-identifier mydb \
  --db-snapshot-identifier mydb-before-upgrade

# 修改版本
aws rds modify-db-instance \
  --db-instance-identifier mydb \
  --engine-version 18.1 \
  --apply-immediately

# 或使用蓝绿部署
aws rds create-blue-green-deployment \
  --blue-green-deployment-name my-upgrade \
  --source-arn arn:aws:rds:us-east-1:123456789:db:mydb \
  --target-engine-version 18.1
```

### 7.2 GCP Cloud SQL

```bash
# 创建副本（高版本）
gcloud sql instances create mydb-replica \
  --master-instance-name=mydb \
  --database-version=POSTGRES_18

# 提升副本为独立实例
gcloud sql instances promote-replica mydb-replica

# 切换应用
# 更新连接字符串
```

---

## 8. 扩展升级

### 8.1 扩展兼容性

```sql
-- 检查扩展版本
SELECT * FROM pg_extension;

-- 更新扩展
ALTER EXTENSION postgis UPDATE TO '3.4.0';
ALTER EXTENSION pg_stat_statements UPDATE;
ALTER EXTENSION pgvector UPDATE TO '0.5.1';

-- 重新创建扩展（如果不兼容）
DROP EXTENSION old_extension CASCADE;
CREATE EXTENSION new_extension;
```

### 8.2 常见扩展处理

```bash
# PostGIS升级
psql -d mydb -f /usr/share/postgresql/18/contrib/postgis-3.4/postgis_upgrade.sql

# pgvector（手动安装）
cd /tmp
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install PG_CONFIG=/usr/lib/postgresql/18/bin/pg_config

# 在数据库中更新
ALTER EXTENSION vector UPDATE TO '0.5.1';
```

---

## 9. 性能对比测试

### 9.1 基准测试

```bash
# 升级前
pgbench -i -s 100 old_db
pgbench -c 50 -j 4 -T 300 old_db > old_benchmark.txt

# 升级后
pgbench -c 50 -j 4 -T 300 new_db > new_benchmark.txt

# 对比结果
diff old_benchmark.txt new_benchmark.txt
```

### 9.2 查询性能对比

```sql
-- 记录旧版本慢查询
SELECT
    query,
    mean_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 在新版本执行相同查询
-- 对比执行计划和时间
EXPLAIN (ANALYZE, BUFFERS) <query>;
```

---

## 10. 回滚方案

### 10.1 pg_upgrade回滚

```bash
# 如果使用--link模式，无法简单回滚
# 需要从备份恢复

# 如果使用--copy模式
sudo systemctl stop postgresql@18-main
sudo systemctl start postgresql@16-main

# 恢复应用连接
# 修改连接到旧端口
```

### 10.2 逻辑复制回滚

```bash
# 优势：新旧版本都在运行
# 1. 停止应用写入新版本
# 2. 重新创建反向复制（18→16）
# 3. 等待同步完成
# 4. 切换应用回旧版本

# 具体步骤
# PG18创建发布
CREATE PUBLICATION rollback_pub FOR ALL TABLES;

# PG16创建订阅
CREATE SUBSCRIPTION rollback_sub
CONNECTION 'host=new-server dbname=mydb'
PUBLICATION rollback_pub;
```

---

## 11. 升级检查清单

```text
升级前:
✅ 完整备份（pg_dumpall）
✅ 测试环境验证
✅ 应用兼容性测试
✅ 扩展版本检查
✅ 读取发布说明
✅ 规划停机窗口
✅ 准备回滚方案
✅ 通知用户

升级中:
✅ 停止应用
✅ 最终备份
✅ 执行升级
✅ 验证数据完整性
✅ 更新统计信息
✅ 测试关键功能

升级后:
✅ 性能监控（24小时）
✅ 慢查询分析
✅ 错误日志检查
✅ 用户反馈收集
✅ 清理旧版本（7天后）
✅ 更新文档
```

---

## 12. 常见问题

### 12.1 升级失败

```bash
# 查看pg_upgrade日志
cat /var/lib/postgresql/pg_upgrade_output.d/*.log

# 常见错误
# 1. 磁盘空间不足
df -h

# 2. 扩展不兼容
# 手动处理或DROP扩展

# 3. 数据类型不兼容
# 参考兼容性文档处理
```

### 12.2 性能下降

```sql
-- 1. 更新统计信息
ANALYZE;

-- 2. 重建索引
REINDEX DATABASE mydb;

-- 3. 检查配置参数
SHOW ALL;

-- 4. 调整参数（PostgreSQL 18优化）
ALTER SYSTEM SET io_direct = 'data';
ALTER SYSTEM SET io_combine_limit = '128kB';
SELECT pg_reload_conf();
```

---

**完成**: PostgreSQL升级迁移完整指南
**字数**: ~8,000字
**涵盖**: pg_upgrade、逻辑复制、跨版本、最小停机、回滚
