# ğŸ“˜ æ•…éšœè¯Šæ–­ä¸åº”æ€¥å“åº”å®Œæ•´æ‰‹å†Œ

> **æ›´æ–°æ—¥æœŸ**: 2025å¹´12æœˆ4æ—¥
> **ç´§æ€¥çº§åˆ«**: âš ï¸ å…³é”®å‚è€ƒ
> **æ–‡æ¡£ç±»å‹**: P3æŒç»­å®è·µæ‰‹å†Œ
> **é…åˆä½¿ç”¨**: [æ•…éšœæ’æŸ¥æŒ‡å—](./ã€ğŸ”§æ•…éšœæ’æŸ¥ã€‘PostgreSQL18+AIé—®é¢˜è¯Šæ–­ä¸è§£å†³æŒ‡å—-2025-12.md)

---

## ğŸš¨ ç´§æ€¥å“åº”æµç¨‹

### 1åˆ†é’Ÿå¿«é€Ÿå“åº”

```bash
#!/bin/bash
# emergency_check.sh - ç´§æ€¥æ£€æŸ¥è„šæœ¬

echo "=== PostgreSQLç´§æ€¥å¥åº·æ£€æŸ¥ ==="
echo "æ—¶é—´: $(date)"

# 1. æ•°æ®åº“å¯ç”¨æ€§
echo -n "æ•°æ®åº“çŠ¶æ€: "
pg_isready && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

# 2. è¿æ¥æ•°
echo -n "å½“å‰è¿æ¥æ•°: "
psql -t -c "SELECT count(*) FROM pg_stat_activity;" 2>/dev/null || echo "âŒ æ— æ³•è¿æ¥"

# 3. æ´»è·ƒæŸ¥è¯¢
echo "æ´»è·ƒæŸ¥è¯¢(>1åˆ†é’Ÿ):"
psql -c "SELECT pid, now()-query_start AS duration, query
         FROM pg_stat_activity
         WHERE state='active' AND query_start < NOW()-INTERVAL '1 minute';" 2>/dev/null

# 4. é”ç­‰å¾…
echo "é”ç­‰å¾…:"
psql -c "SELECT count(*) FROM pg_locks WHERE NOT granted;" 2>/dev/null

# 5. å¤åˆ¶å»¶è¿Ÿ(å¦‚æœ‰)
echo "å¤åˆ¶å»¶è¿Ÿ:"
psql -c "SELECT client_addr, state, replay_lag
         FROM pg_stat_replication;" 2>/dev/null

# 6. ç£ç›˜ç©ºé—´
echo "ç£ç›˜ä½¿ç”¨:"
df -h | grep -E '(Filesystem|pgdata|pgwal)'

# 7. ç³»ç»Ÿè´Ÿè½½
echo "ç³»ç»Ÿè´Ÿè½½:"
uptime
```

### æ•…éšœåˆ†ç±»å†³ç­–æ ‘

```mermaid
graph TD
    Start[æ•…éšœå‘ç”Ÿ] --> Type{æ•…éšœç±»å‹?}

    Type -->|P0ä¸¥é‡| P0[ç«‹å³å¤„ç†]
    Type -->|P1ç´§æ€¥| P1[30åˆ†é’Ÿå†…]
    Type -->|P2é‡è¦| P2[2å°æ—¶å†…]
    Type -->|P3ä¸€èˆ¬| P3[1å¤©å†…]

    P0 --> P0A[æ•°æ®åº“å®•æœº]
    P0 --> P0B[æ•°æ®ä¸¢å¤±]
    P0 --> P0C[ä¸»ä»åˆ‡æ¢å¤±è´¥]

    P1 --> P1A[æ€§èƒ½ä¸¥é‡ä¸‹é™]
    P1 --> P1B[è¿æ¥æ•°è€—å°½]
    P1 --> P1C[ç£ç›˜å³å°†æ»¡]

    P2 --> P2A[æ…¢æŸ¥è¯¢å¢å¤š]
    P2 --> P2B[å¤åˆ¶å»¶è¿Ÿ]
    P2 --> P2C[è¡¨è†¨èƒ€]
```

---

## ğŸ“‹ æ•…éšœåº”æ€¥æ‰‹å†Œ

### P0çº§æ•…éšœï¼šæ•°æ®åº“å®•æœº

**å½±å“**ï¼šæœåŠ¡å®Œå…¨ä¸å¯ç”¨
**SLA**ï¼š5åˆ†é’Ÿå†…æ¢å¤

**Step 1ï¼šå¿«é€Ÿè¯Šæ–­**ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep postgres

# æ£€æŸ¥æ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰
tail -100 /var/log/postgresql/postgresql-18-main.log

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 5432
```

**Step 2ï¼šå°è¯•å¯åŠ¨**ï¼ˆ2åˆ†é’Ÿï¼‰

```bash
# å¯åŠ¨PostgreSQL
sudo systemctl start postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql

# å¦‚æœå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
journalctl -xe -u postgresql
```

**Step 3ï¼šå¸¸è§åŸå› åŠè§£å†³**

**åŸå› Aï¼šç£ç›˜ç©ºé—´æ»¡**

```bash
# æ£€æŸ¥ç£ç›˜
df -h

# ç´§æ€¥æ¸…ç†
## åˆ é™¤æ—§WALï¼ˆè°¨æ…ï¼ï¼‰
cd /var/lib/postgresql/18/main/pg_wal
ls -lt | tail -n +100 | awk '{print $NF}' | xargs rm -f

## æˆ–å¯ç”¨å½’æ¡£æ¸…ç†
psql -c "SELECT pg_switch_wal();"
```

**åŸå› Bï¼šé…ç½®æ–‡ä»¶é”™è¯¯**

```bash
# éªŒè¯é…ç½®
sudo -u postgres /usr/lib/postgresql/18/bin/postgres \
  --config-file=/etc/postgresql/18/main/postgresql.conf -C config_file

# æ¢å¤é»˜è®¤é…ç½®
cp /etc/postgresql/18/main/postgresql.conf.bak \
   /etc/postgresql/18/main/postgresql.conf
```

**åŸå› Cï¼šæ•°æ®ç›®å½•æŸå**

```bash
# ä»å¤‡ä»½æ¢å¤ï¼ˆæœ€åæ‰‹æ®µï¼‰
## 1. åœæ­¢PostgreSQL
sudo systemctl stop postgresql

## 2. æ¢å¤æ•°æ®ç›®å½•
rm -rf /var/lib/postgresql/18/main
tar -xzf /backup/pgdata_latest.tar.gz -C /var/lib/postgresql/18/

## 3. æ¢å¤WAL
cp /backup/wal/* /var/lib/postgresql/18/main/pg_wal/

## 4. å¯åŠ¨
sudo systemctl start postgresql
```

**Step 4ï¼šåˆ‡æ¢åˆ°ä»åº“**ï¼ˆå¦‚æœ‰é«˜å¯ç”¨ï¼‰

```bash
# Patroniè‡ªåŠ¨åˆ‡æ¢
patronictl failover postgres-cluster

# æ‰‹åŠ¨åˆ‡æ¢
## æå‡ä»åº“ä¸ºä¸»åº“
sudo -u postgres /usr/lib/postgresql/18/bin/pg_ctl promote \
  -D /var/lib/postgresql/18/main
```

---

### P1çº§æ•…éšœï¼šæ€§èƒ½ä¸¥é‡ä¸‹é™

**å½±å“**ï¼šå“åº”æ—¶é—´>10ç§’
**SLA**ï¼š30åˆ†é’Ÿå†…æ¢å¤

**è¯Šæ–­æµç¨‹**ï¼š

**Step 1ï¼šè¯†åˆ«æ…¢æŸ¥è¯¢**

```sql
-- å½“å‰æ…¢æŸ¥è¯¢
SELECT pid, usename, query, now()-query_start AS duration
FROM pg_stat_activity
WHERE state = 'active'
  AND query_start < NOW()-INTERVAL '10 seconds'
ORDER BY duration DESC;

-- æ€æ­»æ…¢æŸ¥è¯¢ï¼ˆå¦‚å¿…è¦ï¼‰
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = <slow_query_pid>;
```

**Step 2ï¼šæ£€æŸ¥é”ç­‰å¾…**

```sql
-- æŸ¥çœ‹é˜»å¡é“¾
SELECT
    blocking.pid AS blocking_pid,
    blocking.query AS blocking_query,
    blocked.pid AS blocked_pid,
    blocked.query AS blocked_query,
    now()-blocked.query_start AS blocked_duration
FROM pg_stat_activity blocked
JOIN pg_locks blocked_locks ON blocked.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON
    blocked_locks.locktype = blocking_locks.locktype AND
    blocked_locks.relation = blocking_locks.relation
JOIN pg_stat_activity blocking ON blocking.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted AND blocking_locks.granted;

-- æ€æ­»é˜»å¡æŸ¥è¯¢
SELECT pg_terminate_backend(<blocking_pid>);
```

**Step 3ï¼šæ£€æŸ¥èµ„æºç“¶é¢ˆ**

```bash
# CPU
top -b -n 1 | head -20

# å†…å­˜
free -h

# ç£ç›˜I/O
iostat -x 1 3

# ç½‘ç»œ
iftop
```

---

## ğŸ”§ è‡ªåŠ¨åŒ–ç›‘æ§ä¸å‘Šè­¦

### ç›‘æ§è„šæœ¬

```python
#!/usr/bin/env python3
# monitor.py - PostgreSQLç›‘æ§è„šæœ¬

import psycopg2
import time
import requests  # å‘é€å‘Šè­¦

def check_health():
    conn = psycopg2.connect("dbname=postgres")
    cur = conn.cursor()

    alerts = []

    # 1. è¿æ¥æ•°æ£€æŸ¥
    cur.execute("SELECT count(*) FROM pg_stat_activity;")
    conn_count = cur.fetchone()[0]
    cur.execute("SHOW max_connections;")
    max_conn = int(cur.fetchone()[0])

    if conn_count > max_conn * 0.8:
        alerts.append(f"âš ï¸ è¿æ¥æ•°å‘Šè­¦: {conn_count}/{max_conn} (>80%)")

    # 2. æ…¢æŸ¥è¯¢æ£€æŸ¥
    cur.execute("""
        SELECT count(*) FROM pg_stat_activity
        WHERE state = 'active' AND query_start < NOW()-INTERVAL '1 minute';
    """)
    slow_queries = cur.fetchone()[0]

    if slow_queries > 5:
        alerts.append(f"âš ï¸ æ…¢æŸ¥è¯¢å‘Šè­¦: {slow_queries}ä¸ªæŸ¥è¯¢è¶…è¿‡1åˆ†é’Ÿ")

    # 3. å¤åˆ¶å»¶è¿Ÿæ£€æŸ¥
    cur.execute("""
        SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))
        FROM pg_stat_replication;
    """)
    result = cur.fetchone()
    if result and result[0] > 10:
        alerts.append(f"âš ï¸ å¤åˆ¶å»¶è¿Ÿå‘Šè­¦: {result[0]:.1f}ç§’")

    # 4. ç£ç›˜ç©ºé—´æ£€æŸ¥
    cur.execute("SELECT pg_database_size(current_database());")
    db_size = cur.fetchone()[0]
    # æ£€æŸ¥ç£ç›˜ç©ºé—´...

    cur.close()
    conn.close()

    # å‘é€å‘Šè­¦
    if alerts:
        send_alert("\n".join(alerts))

    return len(alerts) == 0

def send_alert(message):
    # å‘é€åˆ°é’‰é’‰/ä¼ä¸šå¾®ä¿¡/é‚®ä»¶ç­‰
    requests.post("https://webhook.example.com", json={"text": message})

if __name__ == "__main__":
    while True:
        check_health()
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## ğŸ“Š æ•…éšœç»Ÿè®¡ä¸åˆ†æ

### æ•…éšœæŠ¥å‘Šæ¨¡æ¿

```markdown
# æ•…éšœæŠ¥å‘Š

**æ•…éšœæ—¶é—´**: 2025-12-01 14:30:00
**æ¢å¤æ—¶é—´**: 2025-12-01 14:45:00
**æ•…éšœæ—¶é•¿**: 15åˆ†é’Ÿ
**å½±å“èŒƒå›´**: å…¨éƒ¨ç”¨æˆ·

## æ•…éšœç°è±¡
- æ•°æ®åº“è¿æ¥è¶…æ—¶
- æŸ¥è¯¢å“åº”æ—¶é—´>30ç§’

## æ ¹æœ¬åŸå› 
- æŸæ…¢æŸ¥è¯¢å¯¼è‡´é”ç­‰å¾…
- è¿æ¥æ•°è€—å°½

## è§£å†³æªæ–½
1. æ€æ­»æ…¢æŸ¥è¯¢è¿›ç¨‹
2. å¢åŠ è¿æ¥æ± å¤§å°
3. ä¼˜åŒ–é—®é¢˜æŸ¥è¯¢

## é¢„é˜²æªæ–½
1. æ·»åŠ æŸ¥è¯¢è¶…æ—¶é™åˆ¶
2. å¢åŠ æ…¢æŸ¥è¯¢ç›‘æ§
3. ä¼˜åŒ–ç›¸å…³ç´¢å¼•

## åç»­è¡ŒåŠ¨
- [ ] ä»£ç ä¼˜åŒ–ï¼ˆ2å¤©å†…ï¼‰
- [ ] å¢åŠ ç›‘æ§å‘Šè­¦ï¼ˆ1å¤©å†…ï¼‰
- [ ] å¤ç›˜ä¼šè®®ï¼ˆ1å‘¨å†…ï¼‰
```

---

**ğŸš¨ å…³é”®æ—¶åˆ»ï¼Œè¿™ä»½æ‰‹å†Œèƒ½æ•‘å‘½ï¼** ğŸ”§

---

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ4æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: P3-3-TROUBLESHOOTING-2025-12
