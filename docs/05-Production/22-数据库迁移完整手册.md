# PostgreSQLæ•°æ®åº“è¿ç§»å®Œæ•´æ‰‹å†Œ

ä»MySQL/Oracle/SQL Serverè¿ç§»åˆ°PostgreSQL 18çš„å®Œæ•´æŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [è¿ç§»è§„åˆ’](#è¿ç§»è§„åˆ’)
2. [ä»MySQLè¿ç§»](#ä»MySQLè¿ç§»)
3. [ä»Oracleè¿ç§»](#ä»Oracleè¿ç§»)
4. [ä»SQL Serverè¿ç§»](#ä»SQL Serverè¿ç§»)
5. [è·¨ç‰ˆæœ¬å‡çº§](#è·¨ç‰ˆæœ¬å‡çº§)
6. [éªŒè¯ä¸æµ‹è¯•](#éªŒè¯ä¸æµ‹è¯•)

---

## è¿ç§»è§„åˆ’

### è¿ç§»å‰è¯„ä¼°

```text
è¯„ä¼°æ¸…å•:
â–¡ å½“å‰æ•°æ®åº“ç‰ˆæœ¬å’Œå¤§å°
â–¡ åº”ç”¨ç¨‹åºä¾èµ–åˆ†æ
â–¡ åœæœºæ—¶é—´çª—å£
â–¡ è¿ç§»å·¥å…·é€‰æ‹©
â–¡ å›æ»šæ–¹æ¡ˆ
â–¡ æµ‹è¯•ç¯å¢ƒå‡†å¤‡
â–¡ å›¢é˜ŸåŸ¹è®­è®¡åˆ’
```

### è¿ç§»ç­–ç•¥

| ç­–ç•¥ | åœæœºæ—¶é—´ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|----------|--------|----------|
| **å®Œå…¨åœæœº** | é•¿ | ä½ | å°å‹ç³»ç»Ÿ |
| **é€»è¾‘å¤åˆ¶** | çŸ­ | ä¸­ | ä¸­å‹ç³»ç»Ÿ |
| **åŒå†™ç­–ç•¥** | æ—  | é«˜ | å¤§å‹ç³»ç»Ÿ |

---

## ä»MySQLè¿ç§»

### 1. æ•°æ®ç±»å‹æ˜ å°„

```sql
-- MySQL â†’ PostgreSQLç±»å‹æ˜ å°„

-- æ•°å€¼ç±»å‹
INT             â†’ INTEGER
BIGINT          â†’ BIGINT
TINYINT         â†’ SMALLINT
DECIMAL(M,D)    â†’ NUMERIC(M,D)
FLOAT           â†’ REAL
DOUBLE          â†’ DOUBLE PRECISION

-- å­—ç¬¦ä¸²ç±»å‹
VARCHAR(N)      â†’ VARCHAR(N)
TEXT            â†’ TEXT
CHAR(N)         â†’ CHAR(N)
ENUM('a','b')   â†’ VARCHAR(10) + CHECKçº¦æŸ

-- æ—¥æœŸæ—¶é—´
DATETIME        â†’ TIMESTAMP
TIMESTAMP       â†’ TIMESTAMPTZ
DATE            â†’ DATE
TIME            â†’ TIME

-- äºŒè¿›åˆ¶
BLOB            â†’ BYTEA
LONGBLOB        â†’ BYTEA

-- å…¶ä»–
JSON            â†’ JSONB (æ¨è)
AUTO_INCREMENT  â†’ SERIAL/BIGSERIAL
```

### 2. è¯­æ³•å·®å¼‚

#### AUTO_INCREMENT

```sql
-- MySQL
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY
);

-- PostgreSQL
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY
);
```

#### LIMITè¯­æ³•

```sql
-- MySQL
SELECT * FROM users LIMIT 10, 20;  -- offset 10, limit 20

-- PostgreSQL
SELECT * FROM users LIMIT 20 OFFSET 10;
```

#### å­—ç¬¦ä¸²è¿æ¥

```sql
-- MySQL
SELECT CONCAT(first_name, ' ', last_name) FROM users;

-- PostgreSQL
SELECT first_name || ' ' || last_name FROM users;
-- æˆ–ä½¿ç”¨ CONCAT()
```

#### æ—¥æœŸå‡½æ•°

```sql
-- MySQL
SELECT NOW(), CURDATE(), CURTIME();

-- PostgreSQL
SELECT now(), current_date, current_time;
```

#### GROUP BY

```sql
-- MySQLï¼ˆéä¸¥æ ¼æ¨¡å¼ï¼‰
SELECT user_id, name, MAX(created_at)
FROM orders
GROUP BY user_id;  -- å¯ä»¥

-- PostgreSQLï¼ˆä¸¥æ ¼ï¼‰
SELECT user_id, name, MAX(created_at)
FROM orders
GROUP BY user_id, name;  -- å¿…é¡»åˆ—å‡ºæ‰€æœ‰éèšåˆåˆ—

-- æˆ–ä½¿ç”¨DISTINCT ON
SELECT DISTINCT ON (user_id) user_id, name, created_at
FROM orders
ORDER BY user_id, created_at DESC;
```

### 3. ä½¿ç”¨pgloaderè¿ç§»

```bash
# å®‰è£…pgloader
sudo apt-get install pgloader

# åˆ›å»ºè¿ç§»é…ç½®æ–‡ä»¶ mysql_to_pg.load
cat > mysql_to_pg.load <<EOF
LOAD DATABASE
    FROM mysql://user:password@localhost/mydb
    INTO postgresql://postgres:password@localhost/mydb

WITH include drop, create tables, create indexes, reset sequences,
     workers = 8, concurrency = 4

CAST type bigint when (= precision 20) to bigserial,
     type date drop not null drop default using zero-dates-to-null,
     type datetime drop not null drop default using zero-dates-to-null,
     type enum to varchar using enum-to-text

BEFORE LOAD DO
    \$\$ DROP DATABASE IF EXISTS mydb; \$\$,
    \$\$ CREATE DATABASE mydb; \$\$;
EOF

# æ‰§è¡Œè¿ç§»
pgloader mysql_to_pg.load

# æŸ¥çœ‹è¿ç§»æ—¥å¿—
cat mysql_to_pg.load.log
```

### 4. æ‰‹åŠ¨è¿ç§»æ­¥éª¤

```bash
# 1. å¯¼å‡ºMySQLæ•°æ®
mysqldump -u root -p --compatible=postgresql mydb > mysql_dump.sql

# 2. æ¸…ç†SQLæ–‡ä»¶
# åˆ é™¤MySQLç‰¹æœ‰è¯­æ³•
sed -i 's/ENGINE=InnoDB//g' mysql_dump.sql
sed -i 's/AUTO_INCREMENT//g' mysql_dump.sql
sed -i 's/` /"/g' mysql_dump.sql  # åå¼•å·è½¬åŒå¼•å·

# 3. åˆ›å»ºPostgreSQLæ•°æ®åº“
createdb mydb

# 4. å¯¼å…¥æ•°æ®
psql -d mydb -f mysql_dump.sql

# 5. ä¿®å¤åºåˆ—
# å¯¹äºæ¯ä¸ªSERIALåˆ—
SELECT setval('users_id_seq', (SELECT MAX(id) FROM users));
```

### 5. åº”ç”¨ç¨‹åºè¿ç§»

```python
# MySQLé©±åŠ¨
import MySQLdb
conn = MySQLdb.connect(host='localhost', user='root', passwd='password', db='mydb')

# PostgreSQLé©±åŠ¨
import psycopg2
conn = psycopg2.connect(
    host='localhost',
    database='mydb',
    user='postgres',
    password='password'
)

# ä¸»è¦å·®å¼‚
# 1. å ä½ç¬¦: %s (MySQL) â†’ %s (PostgreSQL) âœ“
# 2. è‡ªåŠ¨æäº¤: MySQLé»˜è®¤å¼€å¯ â†’ PostgreSQLé»˜è®¤å…³é—­
conn.autocommit = False  # æ˜¾å¼è®¾ç½®

# 3. LAST_INSERT_ID()
cursor.execute("INSERT INTO users (name) VALUES (%s) RETURNING id;", ('John',))
user_id = cursor.fetchone()[0]

# 4. LIMITè¯­æ³•
cursor.execute("SELECT * FROM users LIMIT %s OFFSET %s;", (20, 10))
```

---

## ä»Oracleè¿ç§»

### 1. æ•°æ®ç±»å‹æ˜ å°„

```sql
-- Oracle â†’ PostgreSQL

-- æ•°å€¼ç±»å‹
NUMBER          â†’ NUMERIC
NUMBER(P)       â†’ NUMERIC(P)
NUMBER(P,S)     â†’ NUMERIC(P,S)
BINARY_FLOAT    â†’ REAL
BINARY_DOUBLE   â†’ DOUBLE PRECISION

-- å­—ç¬¦ä¸²
VARCHAR2(N)     â†’ VARCHAR(N)
NVARCHAR2(N)    â†’ VARCHAR(N)
CHAR(N)         â†’ CHAR(N)
CLOB            â†’ TEXT

-- æ—¥æœŸæ—¶é—´
DATE            â†’ TIMESTAMP  (æ³¨æ„: Oracle DATEåŒ…å«æ—¶é—´)
TIMESTAMP       â†’ TIMESTAMP
TIMESTAMP WITH TIME ZONE â†’ TIMESTAMPTZ

-- äºŒè¿›åˆ¶
BLOB            â†’ BYTEA
RAW             â†’ BYTEA

-- å…¶ä»–
ROWNUM          â†’ ROW_NUMBER() OVER()
SYSDATE         â†’ now()
```

### 2. åºåˆ—è¿ç§»

```sql
-- Oracle
CREATE SEQUENCE user_seq START WITH 1;
INSERT INTO users VALUES (user_seq.NEXTVAL, 'John');

-- PostgreSQL
CREATE SEQUENCE user_seq START WITH 1;
INSERT INTO users VALUES (nextval('user_seq'), 'John');

-- æˆ–ä½¿ç”¨SERIAL
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,  -- è‡ªåŠ¨åˆ›å»ºåºåˆ—
    name VARCHAR(100)
);
```

### 3. PL/SQL â†’ PL/pgSQL

```sql
-- Oracle PL/SQL
CREATE OR REPLACE PROCEDURE update_user_status(
    p_user_id IN NUMBER,
    p_status IN VARCHAR2
) IS
BEGIN
    UPDATE users SET status = p_status WHERE id = p_user_id;
    COMMIT;
END;
/

-- PostgreSQL PL/pgSQL
CREATE OR REPLACE PROCEDURE update_user_status(
    p_user_id BIGINT,
    p_status VARCHAR
) AS $$
BEGIN
    UPDATE users SET status = p_status WHERE id = p_user_id;
    -- ä¸éœ€è¦COMMITï¼ˆç”±è°ƒç”¨è€…æ§åˆ¶ï¼‰
END;
$$ LANGUAGE plpgsql;
```

### 4. åˆ†é¡µæŸ¥è¯¢

```sql
-- Oracle 12cä¹‹å‰
SELECT * FROM (
    SELECT a.*, ROWNUM rnum FROM (
        SELECT * FROM users ORDER BY id
    ) a WHERE ROWNUM <= 30
) WHERE rnum > 10;

-- Oracle 12c+
SELECT * FROM users ORDER BY id
OFFSET 10 ROWS FETCH NEXT 20 ROWS ONLY;

-- PostgreSQL
SELECT * FROM users ORDER BY id LIMIT 20 OFFSET 10;
```

### 5. ä½¿ç”¨ora2pgè¿ç§»

```bash
# å®‰è£…ora2pg
sudo apt-get install ora2pg

# åˆå§‹åŒ–é…ç½®
ora2pg --init_project my_migration

cd my_migration

# ç¼–è¾‘config/ora2pg.conf
vi config/ora2pg.conf

# å…³é”®é…ç½®:
ORACLE_DSN   dbi:Oracle:host=localhost;sid=ORCL
ORACLE_USER  system
ORACLE_PWD   password
SCHEMA       MYSCHEMA
PG_DSN       dbi:Pg:dbname=mydb;host=localhost
PG_USER      postgres
PG_PWD       password

# è¯„ä¼°è¿ç§»å·¥ä½œé‡
ora2pg -c config/ora2pg.conf -t SHOW_REPORT --estimate_cost

# å¯¼å‡ºDDL
ora2pg -c config/ora2pg.conf -t TABLE -o tables.sql
ora2pg -c config/ora2pg.conf -t VIEW -o views.sql
ora2pg -c config/ora2pg.conf -t PROCEDURE -o procedures.sql

# å¯¼å‡ºæ•°æ®
ora2pg -c config/ora2pg.conf -t COPY -o data.sql

# å¯¼å…¥PostgreSQL
psql -d mydb -f tables.sql
psql -d mydb -f data.sql
```

---

## ä»SQL Serverè¿ç§»

### 1. æ•°æ®ç±»å‹æ˜ å°„

```sql
-- SQL Server â†’ PostgreSQL

-- æ•°å€¼
INT             â†’ INTEGER
BIGINT          â†’ BIGINT
TINYINT         â†’ SMALLINT
DECIMAL(P,S)    â†’ NUMERIC(P,S)
MONEY           â†’ NUMERIC(19,4)

-- å­—ç¬¦ä¸²
VARCHAR(N)      â†’ VARCHAR(N)
NVARCHAR(N)     â†’ VARCHAR(N)
TEXT            â†’ TEXT
NTEXT           â†’ TEXT

-- æ—¥æœŸæ—¶é—´
DATETIME        â†’ TIMESTAMP
DATETIME2       â†’ TIMESTAMP
DATETIMEOFFSET  â†’ TIMESTAMPTZ
DATE            â†’ DATE

-- äºŒè¿›åˆ¶
VARBINARY       â†’ BYTEA
IMAGE           â†’ BYTEA

-- å…¶ä»–
UNIQUEIDENTIFIER â†’ UUID
BIT             â†’ BOOLEAN
IDENTITY        â†’ SERIAL/BIGSERIAL
```

### 2. T-SQL â†’ PL/pgSQL

```sql
-- SQL Server
CREATE PROCEDURE GetUserOrders
    @UserId INT
AS
BEGIN
    SELECT * FROM orders WHERE user_id = @UserId;
END;

-- PostgreSQL
CREATE OR REPLACE FUNCTION get_user_orders(p_user_id INTEGER)
RETURNS TABLE(id BIGINT, order_date TIMESTAMPTZ, total NUMERIC) AS $$
BEGIN
    RETURN QUERY
    SELECT o.id, o.order_date, o.total
    FROM orders o
    WHERE o.user_id = p_user_id;
END;
$$ LANGUAGE plpgsql;
```

### 3. TOP vs LIMIT

```sql
-- SQL Server
SELECT TOP 10 * FROM users ORDER BY id;

-- PostgreSQL
SELECT * FROM users ORDER BY id LIMIT 10;
```

### 4. ISNULL vs COALESCE

```sql
-- SQL Server
SELECT ISNULL(column, 'default') FROM table;

-- PostgreSQL
SELECT COALESCE(column, 'default') FROM table;
-- æˆ–
SELECT NULLIF(column, '') FROM table;
```

---

## è·¨ç‰ˆæœ¬å‡çº§

### PostgreSQL 17 â†’ 18å‡çº§

#### 1. pg_upgradeï¼ˆæœ€å¿«ï¼‰

```bash
# 1. å®‰è£…PostgreSQL 18
sudo apt install postgresql-18

# 2. åœæ­¢ä¸¤ä¸ªç‰ˆæœ¬
sudo systemctl stop postgresql@17-main
sudo systemctl stop postgresql@18-main

# 3. æ‰§è¡Œå‡çº§æ£€æŸ¥
sudo -u postgres /usr/lib/postgresql/18/bin/pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --check

# 4. æ‰§è¡Œå‡çº§ï¼ˆä½¿ç”¨ç¡¬é“¾æ¥ï¼‰
sudo -u postgres /usr/lib/postgresql/18/bin/pg_upgrade \
    --old-datadir=/var/lib/postgresql/17/main \
    --new-datadir=/var/lib/postgresql/18/main \
    --old-bindir=/usr/lib/postgresql/17/bin \
    --new-bindir=/usr/lib/postgresql/18/bin \
    --link

# 5. å¯åŠ¨PostgreSQL 18
sudo systemctl start postgresql@18-main

# 6. è¿è¡Œä¼˜åŒ–è„šæœ¬
./analyze_new_cluster.sh

# 7. åˆ é™¤æ—§é›†ç¾¤ï¼ˆç¡®è®¤æ— è¯¯åï¼‰
./delete_old_cluster.sh
```

#### 2. pg_dump/pg_restoreï¼ˆæœ€å®‰å…¨ï¼‰

```bash
# 1. å¤‡ä»½æ—§ç‰ˆæœ¬
pg_dumpall -h localhost -p 5432 -U postgres > backup.sql

# 2. å®‰è£…å¹¶åˆå§‹åŒ–PostgreSQL 18
sudo apt install postgresql-18
sudo -u postgres /usr/lib/postgresql/18/bin/initdb \
    -D /var/lib/postgresql/18/main

# 3. å¯åŠ¨PostgreSQL 18
sudo systemctl start postgresql@18-main

# 4. æ¢å¤æ•°æ®
psql -h localhost -p 5433 -U postgres -f backup.sql

# 5. éªŒè¯
psql -h localhost -p 5433 -U postgres -c "SELECT version();"
```

#### 3. é€»è¾‘å¤åˆ¶ï¼ˆé›¶åœæœºï¼‰

```sql
-- æ—§æœåŠ¡å™¨(PG 17)
ALTER SYSTEM SET wal_level = logical;
SELECT pg_reload_conf();

CREATE PUBLICATION my_pub FOR ALL TABLES;

-- æ–°æœåŠ¡å™¨(PG 18)
CREATE SUBSCRIPTION my_sub
CONNECTION 'host=old_server dbname=mydb user=rep_user'
PUBLICATION my_pub;

-- ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
SELECT * FROM pg_stat_subscription;

-- åˆ‡æ¢åº”ç”¨åˆ°æ–°æœåŠ¡å™¨
-- åœæ­¢æ—§æœåŠ¡å™¨å†™å…¥
-- ç­‰å¾…å¤åˆ¶è¿½ä¸Š
-- åˆ‡æ¢DNS/è´Ÿè½½å‡è¡¡
```

---

## éªŒè¯ä¸æµ‹è¯•

### 1. æ•°æ®ä¸€è‡´æ€§éªŒè¯

```sql
-- è¡Œæ•°å¯¹æ¯”
SELECT 'source' AS db, COUNT(*) FROM source_users
UNION ALL
SELECT 'target' AS db, COUNT(*) FROM target_users;

-- æ•°æ®æ ¡éªŒå’Œ
SELECT md5(string_agg(md5(users.*::text), '' ORDER BY id))
FROM users;

-- è¯¦ç»†å¯¹æ¯”
SELECT
    COALESCE(s.id, t.id) AS id,
    CASE
        WHEN s.id IS NULL THEN 'Missing in source'
        WHEN t.id IS NULL THEN 'Missing in target'
        WHEN s != t THEN 'Data mismatch'
        ELSE 'OK'
    END AS status
FROM source_users s
FULL OUTER JOIN target_users t ON s.id = t.id
WHERE s IS DISTINCT FROM t;
```

### 2. æ€§èƒ½å¯¹æ¯”

```bash
# ä½¿ç”¨æˆ‘ä»¬çš„æ€§èƒ½æµ‹è¯•è„šæœ¬
cd scripts
./performance-benchmark.sh

# å¯¹æ¯”æ—§ç³»ç»Ÿ
# - TPS
# - æŸ¥è¯¢å»¶è¿Ÿ
# - ååé‡
```

### 3. åº”ç”¨ç¨‹åºæµ‹è¯•

```python
# é›†æˆæµ‹è¯•
def test_migration():
    # 1. è¿æ¥æµ‹è¯•
    conn = psycopg2.connect(...)
    assert conn is not None

    # 2. æŸ¥è¯¢æµ‹è¯•
    cursor.execute("SELECT COUNT(*) FROM users;")
    count = cursor.fetchone()[0]
    assert count > 0

    # 3. å†™å…¥æµ‹è¯•
    cursor.execute("INSERT INTO users (name) VALUES (%s) RETURNING id;", ('Test',))
    user_id = cursor.fetchone()[0]
    assert user_id is not None

    # 4. äº‹åŠ¡æµ‹è¯•
    conn.rollback()

    print("âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡")

test_migration()
```

---

## è¿ç§»æ£€æŸ¥æ¸…å•

### è¿ç§»å‰
```text
â–¡ å®Œæ•´å¤‡ä»½
â–¡ æµ‹è¯•ç¯å¢ƒéªŒè¯
â–¡ è¿ç§»è„šæœ¬å‡†å¤‡
â–¡ å›æ»šæ–¹æ¡ˆ
â–¡ åœæœºé€šçŸ¥
â–¡ ç›‘æ§å‡†å¤‡
```

### è¿ç§»ä¸­
```text
â–¡ åœæ­¢åº”ç”¨å†™å…¥
â–¡ æ‰§è¡Œæœ€ç»ˆåŒæ­¥
â–¡ éªŒè¯æ•°æ®ä¸€è‡´æ€§
â–¡ æ›´æ–°åºåˆ—
â–¡ é‡å»ºç´¢å¼•
â–¡ ANALYZEæ‰€æœ‰è¡¨
```

### è¿ç§»å
```text
â–¡ åº”ç”¨ç¨‹åºæµ‹è¯•
â–¡ æ€§èƒ½æµ‹è¯•
â–¡ ç›‘æ§å‘Šè­¦
â–¡ 7å¤©è§‚å¯ŸæœŸ
â–¡ æ—§ç³»ç»Ÿä¿ç•™30å¤©
â–¡ æ–‡æ¡£æ›´æ–°
```

---

## å¸¸è§é—®é¢˜

### Q1: è¿ç§»éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ
**A**: å–å†³äºæ•°æ®é‡:
- 1GB: ~10åˆ†é’Ÿ
- 10GB: ~1å°æ—¶
- 100GB: ~5å°æ—¶
- 1TB+: è€ƒè™‘é€»è¾‘å¤åˆ¶

### Q2: å¦‚ä½•æœ€å°åŒ–åœæœºæ—¶é—´ï¼Ÿ
**A**: ä½¿ç”¨é€»è¾‘å¤åˆ¶æˆ–åŒå†™ç­–ç•¥

### Q3: å¦‚ä½•å›æ»šï¼Ÿ
**A**:
1. ä¿ç•™æ—§ç³»ç»Ÿ
2. å‡†å¤‡å›æ»šè„šæœ¬
3. DNSå¿«é€Ÿåˆ‡æ¢

---

## å·¥å…·è„šæœ¬

ä½¿ç”¨æˆ‘ä»¬çš„è¿ç§»åŠ©æ‰‹:
```bash
python3 scripts/migration-helper.py \
    --source-host old_db \
    --source-db mydb \
    --target-host new_db \
    --target-db mydb \
    --verify
```

---

**æˆåŠŸè¿ç§»åˆ°PostgreSQL 18ï¼** ğŸš€
