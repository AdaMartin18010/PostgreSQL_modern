# 图数据模型设计

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: Apache AGE 1.5+  
> **文档编号**: 06-02-03

## 📑 目录

- [图数据模型设计](#图数据模型设计)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 模型定位](#12-模型定位)
    - [1.3 核心价值](#13-核心价值)
  - [2. 数据模型设计](#2-数据模型设计)
    - [2.1 节点模型](#21-节点模型)
    - [2.2 边模型](#22-边模型)
    - [2.3 属性模型](#23-属性模型)
  - [3. 图模式设计](#3-图模式设计)
    - [3.1 模式定义](#31-模式定义)
    - [3.2 关系设计](#32-关系设计)
    - [3.3 索引设计](#33-索引设计)
  - [4. 查询设计](#4-查询设计)
    - [4.1 图遍历查询](#41-图遍历查询)
    - [4.2 路径查询](#42-路径查询)
    - [4.3 聚合查询](#43-聚合查询)
  - [5. 性能优化](#5-性能优化)
    - [5.1 存储优化](#51-存储优化)
    - [5.2 查询优化](#52-查询优化)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 模型设计建议](#61-模型设计建议)
    - [6.2 查询优化建议](#62-查询优化建议)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

图数据模型用于表示实体间的关系，适用于社交网络、推荐系统、知识图谱等场景。需要设计合理的图模型以支持
高效的图查询。

**技术演进**:

1. **2020 年**: Apache AGE 项目启动
2. **2022 年**: Apache AGE 1.0 发布
3. **2025 年**: Apache AGE 1.5 优化图模型设计

### 1.2 模型定位

图数据模型设计提供图数据的建模方法，使用 Apache AGE 扩展 PostgreSQL 的图数据库能力。

### 1.3 核心价值

- **关系建模**: 高效表示实体关系
- **图查询**: 支持复杂的图查询
- **性能优化**: 优化图查询性能

---

## 2. 数据模型设计

### 2.1 节点模型

**节点定义**:

```cypher
-- 创建节点标签
CREATE (u:User {
    id: 1,
    name: 'Alice',
    email: 'alice@example.com',
    created_at: timestamp()
});

-- 创建带属性的节点
CREATE (p:Product {
    id: 1,
    name: 'Product A',
    price: 99.99,
    category: 'Electronics'
});
```

### 2.2 边模型

**边定义**:

```cypher
-- 创建关系
MATCH (u:User {id: 1}), (p:Product {id: 1})
CREATE (u)-[r:PURCHASED {
    quantity: 2,
    price: 199.98,
    purchased_at: timestamp()
}]->(p);

-- 创建带权重的边
MATCH (u1:User {id: 1}), (u2:User {id: 2})
CREATE (u1)-[r:FOLLOWS {
    weight: 0.8,
    created_at: timestamp()
}]->(u2);
```

### 2.3 属性模型

**属性设计**:

```cypher
-- 节点属性
CREATE (n:Node {
    id: INTEGER,
    name: STRING,
    metadata: JSONB,
    created_at: TIMESTAMP
});

-- 边属性
CREATE ()-[r:RELATION {
    weight: FLOAT,
    properties: JSONB,
    created_at: TIMESTAMP
}]->();
```

---

## 3. 图模式设计

### 3.1 模式定义

**模式设计**:

```cypher
-- 用户-产品图模式
(:User)-[:PURCHASED]->(:Product)
(:User)-[:VIEWED]->(:Product)
(:User)-[:FOLLOWS]->(:User)
(:Product)-[:SIMILAR_TO]->(:Product)
```

### 3.2 关系设计

**关系类型**:

- **有向关系**: 单向关系
- **无向关系**: 双向关系
- **多重关系**: 多个关系类型

### 3.3 索引设计

**索引创建**:

```sql
-- 节点属性索引
CREATE INDEX ON ag_graph.ag_label USING btree (property_name);

-- 边属性索引
CREATE INDEX ON ag_graph.ag_edge_label USING btree (property_name);

-- 复合索引
CREATE INDEX ON ag_graph.ag_label USING btree (property1, property2);
```

---

## 4. 查询设计

### 4.1 图遍历查询

**遍历查询**:

```cypher
-- 查找用户的朋友
MATCH (u:User {id: 1})-[:FOLLOWS]->(f:User)
RETURN f;

-- 查找用户的朋友的朋友
MATCH (u:User {id: 1})-[:FOLLOWS]->(f:User)-[:FOLLOWS]->(ff:User)
RETURN ff;
```

### 4.2 路径查询

**路径查询**:

```cypher
-- 查找最短路径
MATCH path = shortestPath(
    (u1:User {id: 1})-[*]-(u2:User {id: 2})
)
RETURN path;

-- 查找所有路径
MATCH path = (u1:User {id: 1})-[*1..3]-(u2:User {id: 2})
RETURN path;
```

### 4.3 聚合查询

**聚合查询**:

```cypher
-- 统计节点的度
MATCH (u:User {id: 1})-[r]-()
RETURN u, count(r) AS degree;

-- 查找最受欢迎的节点
MATCH (n)-[r]->()
RETURN n, count(r) AS popularity
ORDER BY popularity DESC
LIMIT 10;
```

---

## 5. 性能优化

### 5.1 存储优化

**优化策略**:

- **节点分区**: 按标签分区节点
- **边存储**: 优化边存储结构
- **属性压缩**: 压缩属性数据

### 5.2 查询优化

**优化技巧**:

- **索引使用**: 使用合适的索引
- **查询重写**: 优化查询语句
- **路径限制**: 限制路径长度

---

## 6. 最佳实践

### 6.1 模型设计建议

- **标签设计**: 设计清晰的节点和边标签
- **属性设计**: 合理设计属性结构
- **关系设计**: 设计合适的关系类型

### 6.2 查询优化建议

- **索引优化**: 为常用查询创建索引
- **路径限制**: 限制路径查询深度
- **批量查询**: 使用批量查询提升性能

---

## 7. 参考资料

- [Apache AGE 文档](https://age.apache.org/)
- [Cypher 查询语言](https://neo4j.com/developer/cypher/)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team
