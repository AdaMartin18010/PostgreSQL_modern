# 向量数据模型设计

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: pgvector 0.7.0+  
> **文档编号**: 06-02-02

## 📑 目录

- [向量数据模型设计](#向量数据模型设计)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 模型定位](#12-模型定位)
    - [1.3 核心价值](#13-核心价值)
  - [2. 数据模型设计](#2-数据模型设计)
    - [2.1 基础向量模型](#21-基础向量模型)
    - [2.2 混合向量模型](#22-混合向量模型)
    - [2.3 多模态向量模型](#23-多模态向量模型)
  - [3. 索引设计](#3-索引设计)
    - [3.1 HNSW 索引设计](#31-hnsw-索引设计)
    - [3.2 IVFFlat 索引设计](#32-ivfflat-索引设计)
    - [3.3 复合索引设计](#33-复合索引设计)
  - [4. 查询设计](#4-查询设计)
    - [4.1 相似度查询](#41-相似度查询)
    - [4.2 混合查询](#42-混合查询)
    - [4.3 聚合查询](#43-聚合查询)
  - [5. 性能优化](#5-性能优化)
    - [5.1 存储优化](#51-存储优化)
    - [5.2 查询优化](#52-查询优化)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 模型设计建议](#61-模型设计建议)
    - [6.2 索引设计建议](#62-索引设计建议)
    - [6.3 查询优化建议](#63-查询优化建议)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

向量数据模型设计需要考虑向量维度、索引类型、查询模式等因素，设计合理的模型以支持高效的向量搜索。

**技术演进**:

1. **2020 年**: pgvector 引入向量数据类型
2. **2022 年**: 支持 HNSW 索引
3. **2025 年**: 优化向量模型设计

### 1.2 模型定位

向量数据模型设计提供向量数据的建模方法，支持高效的向量存储和查询。

### 1.3 核心价值

- **高效存储**: 优化向量存储
- **快速查询**: 支持快速向量搜索
- **灵活扩展**: 支持模型扩展

---

## 2. 数据模型设计

### 2.1 基础向量模型

**基础模型**:

```sql
-- 基础向量表
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    embedding vector(1536),  -- OpenAI embedding 维度
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建向量索引
CREATE INDEX ON documents USING hnsw (embedding vector_cosine_ops);
```

### 2.2 混合向量模型

**混合模型**:

```sql
-- 混合向量表（向量 + 元数据）
CREATE TABLE items (
    id SERIAL PRIMARY KEY,
    title TEXT,
    description TEXT,
    embedding vector(1536),
    category_id INTEGER,
    price DECIMAL(10, 2),
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 复合索引
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);
CREATE INDEX ON items (category_id);
CREATE INDEX ON items USING GIN (metadata);
```

### 2.3 多模态向量模型

**多模态模型**:

```sql
-- 多模态向量表
CREATE TABLE media_items (
    id SERIAL PRIMARY KEY,
    text_content TEXT,
    text_embedding vector(1536),
    image_path TEXT,
    image_embedding vector(2048),
    audio_path TEXT,
    audio_embedding vector(1024),
    metadata JSONB
);

-- 多向量索引
CREATE INDEX ON media_items USING hnsw (text_embedding vector_cosine_ops);
CREATE INDEX ON media_items USING hnsw (image_embedding vector_cosine_ops);
CREATE INDEX ON media_items USING hnsw (audio_embedding vector_cosine_ops);
```

---

## 3. 索引设计

### 3.1 HNSW 索引设计

**索引配置**:

```sql
-- HNSW 索引
CREATE INDEX ON documents USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 参数说明
-- m: 每个节点的最大连接数（默认 16）
-- ef_construction: 构建时的搜索宽度（默认 64）
```

### 3.2 IVFFlat 索引设计

**索引配置**:

```sql
-- IVFFlat 索引
CREATE INDEX ON documents USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 参数说明
-- lists: 聚类数量（建议为 sqrt(行数)）
```

### 3.3 复合索引设计

**复合索引**:

```sql
-- 向量 + 标量复合索引
CREATE INDEX ON items (category_id, embedding vector_cosine_ops);

-- 部分索引
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops)
WHERE category_id = 1;
```

---

## 4. 查询设计

### 4.1 相似度查询

**相似度查询**:

```sql
-- 余弦相似度查询
SELECT id, content, 1 - (embedding <=> $1) AS similarity
FROM documents
ORDER BY embedding <=> $1
LIMIT 10;

-- 内积查询
SELECT id, content, embedding <#> $1 AS similarity
FROM documents
ORDER BY embedding <#> $1
LIMIT 10;
```

### 4.2 混合查询

**混合查询**:

```sql
-- 向量 + 标量过滤
SELECT id, title, 1 - (embedding <=> $1) AS similarity
FROM items
WHERE category_id = 1
  AND price < 100
ORDER BY embedding <=> $1
LIMIT 10;
```

### 4.3 聚合查询

**聚合查询**:

```sql
-- 向量聚类
SELECT
    category_id,
    AVG(1 - (embedding <=> $1)) AS avg_similarity
FROM items
GROUP BY category_id
ORDER BY avg_similarity DESC;
```

---

## 5. 性能优化

### 5.1 存储优化

**优化策略**:

- **向量维度**: 选择合适的向量维度
- **数据类型**: 使用合适的数值类型
- **压缩存储**: 压缩向量数据

### 5.2 查询优化

**优化技巧**:

- **索引选择**: 选择合适的索引类型
- **查询重写**: 优化查询语句
- **批量查询**: 使用批量查询

---

## 6. 最佳实践

### 6.1 模型设计建议

- **维度选择**: 根据 embedding 模型选择维度
- **元数据设计**: 合理设计元数据结构
- **表结构**: 优化表结构设计

### 6.2 索引设计建议

- **索引类型**: 根据场景选择索引类型
- **参数调优**: 调优索引参数
- **复合索引**: 使用复合索引优化查询

### 6.3 查询优化建议

- **相似度函数**: 选择合适的相似度函数
- **过滤条件**: 先过滤后排序
- **批量查询**: 使用批量查询提升性能

---

## 7. 参考资料

- [pgvector 文档](https://github.com/pgvector/pgvector)
- [向量数据模型设计](https://www.postgresql.org/docs/current/vector.html)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team

