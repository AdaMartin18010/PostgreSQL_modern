# PostgreSQL è¾¹ç¼˜è®¡ç®—éƒ¨ç½²

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+, Edge Computing
> **æ–‡æ¡£ç¼–å·**: 06-03-03

## ğŸ“‘ ç›®å½•

- [PostgreSQL è¾¹ç¼˜è®¡ç®—éƒ¨ç½²](#postgresql-è¾¹ç¼˜è®¡ç®—éƒ¨ç½²)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è¾¹ç¼˜éƒ¨ç½²æ¶æ„](#2-è¾¹ç¼˜éƒ¨ç½²æ¶æ„)
    - [2.1 è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²](#21-è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²)
    - [2.2 æ•°æ®åŒæ­¥ç­–ç•¥](#22-æ•°æ®åŒæ­¥ç­–ç•¥)
    - [2.3 ç¦»çº¿æ•°æ®ç®¡ç†](#23-ç¦»çº¿æ•°æ®ç®¡ç†)
  - [3. è¾¹ç¼˜æ•°æ®åº“é…ç½®](#3-è¾¹ç¼˜æ•°æ®åº“é…ç½®)
    - [3.1 è½»é‡çº§é…ç½®](#31-è½»é‡çº§é…ç½®)
    - [3.2 æœ¬åœ°ç¼“å­˜](#32-æœ¬åœ°ç¼“å­˜)
  - [4. æ•°æ®åŒæ­¥](#4-æ•°æ®åŒæ­¥)
    - [4.1 å¢é‡åŒæ­¥](#41-å¢é‡åŒæ­¥)
    - [4.2 å†²çªè§£å†³](#42-å†²çªè§£å†³)
  - [5. å®è·µæ¡ˆä¾‹](#5-å®è·µæ¡ˆä¾‹)
    - [5.1 IoT è¾¹ç¼˜éƒ¨ç½²](#51-iot-è¾¹ç¼˜éƒ¨ç½²)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

PostgreSQL è¾¹ç¼˜è®¡ç®—éƒ¨ç½²éœ€è¦ï¼š

- **ä½å»¶è¿Ÿ**: è¾¹ç¼˜èŠ‚ç‚¹ä½å»¶è¿ŸæŸ¥è¯¢
- **ç¦»çº¿æ”¯æŒ**: æ”¯æŒç¦»çº¿æ•°æ®è®¿é—®
- **æ•°æ®åŒæ­¥**: ä¸ä¸­å¿ƒæ•°æ®åº“åŒæ­¥
- **èµ„æºé™åˆ¶**: é€‚åº”è¾¹ç¼˜è®¾å¤‡èµ„æºé™åˆ¶

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **è¾¹ç¼˜æ•°æ®åº“**: è½»é‡çº§ PostgreSQL éƒ¨ç½²
- **æ•°æ®åŒæ­¥**: å¢é‡æ•°æ®åŒæ­¥
- **æœ¬åœ°ç¼“å­˜**: æœ¬åœ°æ•°æ®ç¼“å­˜

### 1.2 æ ¸å¿ƒä»·å€¼

- **å»¶è¿Ÿ**: é™ä½ 80%ï¼ˆè¾¹ç¼˜æŸ¥è¯¢ï¼‰
- **å¯ç”¨æ€§**: æå‡è‡³ 99.99%ï¼ˆç¦»çº¿æ”¯æŒï¼‰
- **æˆæœ¬**: é™ä½ 50%ï¼ˆè¾¹ç¼˜è®¡ç®—ï¼‰

## 2. è¾¹ç¼˜éƒ¨ç½²æ¶æ„

### 2.1 è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²

```text
ä¸­å¿ƒæ•°æ®åº“ï¼ˆäº‘ï¼‰
  â”œâ”€â”€ å®Œæ•´æ•°æ®
  â””â”€â”€ æ•°æ®åŒæ­¥
      â†“
è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆæœ¬åœ°ï¼‰
  â”œâ”€â”€ æœ¬åœ°ç¼“å­˜æ•°æ®
  â”œâ”€â”€ ç¦»çº¿æŸ¥è¯¢
  â””â”€â”€ å¢é‡åŒæ­¥
```

**é…ç½®ç¤ºä¾‹**:

```bash
# è¾¹ç¼˜èŠ‚ç‚¹ PostgreSQL é…ç½®ï¼ˆpostgresql.confï¼‰
# è½»é‡çº§é…ç½®
max_connections = 50
shared_buffers = 128MB
effective_cache_size = 512MB
maintenance_work_mem = 64MB
work_mem = 4MB
```

### 2.2 æ•°æ®åŒæ­¥ç­–ç•¥

```sql
-- 1. é€»è¾‘å¤åˆ¶åŒæ­¥ï¼ˆå¢é‡åŒæ­¥ï¼‰
CREATE PUBLICATION edge_pub FOR TABLE edge_data;

-- è¾¹ç¼˜èŠ‚ç‚¹è®¢é˜…
CREATE SUBSCRIPTION edge_sub
CONNECTION 'host=<center_db> port=5432 dbname=mydb user=edge_user'
PUBLICATION edge_pub;

-- 2. å®šæ—¶åŒæ­¥ï¼ˆç¦»çº¿åœºæ™¯ï¼‰
-- ä½¿ç”¨ pg_dump å’Œ pg_restore å®šæ—¶åŒæ­¥
```

### 2.3 ç¦»çº¿æ•°æ®ç®¡ç†

```python
# è¾¹ç¼˜èŠ‚ç‚¹ç¦»çº¿æ•°æ®ç®¡ç†
class EdgeDataManager:
    def __init__(self, edge_db, center_db):
        self.edge_db = edge_db
        self.center_db = center_db

    def sync_data(self):
        """åŒæ­¥æ•°æ®ï¼ˆåœ¨çº¿æ—¶ï¼‰"""
        # å¢é‡åŒæ­¥
        # ä½¿ç”¨é€»è¾‘å¤åˆ¶æˆ–å®šæ—¶åŒæ­¥
        pass

    def query_local(self, query):
        """æœ¬åœ°æŸ¥è¯¢ï¼ˆç¦»çº¿æ—¶ï¼‰"""
        # æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“
        return self.edge_db.execute(query)

    def queue_for_sync(self, data):
        """é˜Ÿåˆ—å¾…åŒæ­¥æ•°æ®ï¼ˆç¦»çº¿æ—¶ï¼‰"""
        # ç¦»çº¿æ—¶é˜Ÿåˆ—æ•°æ®ï¼Œåœ¨çº¿æ—¶åŒæ­¥
        pass
```

## 3. è¾¹ç¼˜æ•°æ®åº“é…ç½®

### 3.1 è½»é‡çº§é…ç½®

```sql
-- è¾¹ç¼˜èŠ‚ç‚¹ PostgreSQL é…ç½®
-- postgresql.conf
max_connections = 50
shared_buffers = 128MB
effective_cache_size = 512MB
maintenance_work_mem = 64MB
work_mem = 4MB
checkpoint_completion_target = 0.9
wal_buffers = 4MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 2
work_mem = 4MB
min_wal_size = 100MB
max_wal_size = 1GB
```

### 3.2 æœ¬åœ°ç¼“å­˜

```sql
-- åˆ›å»ºæœ¬åœ°ç¼“å­˜è¡¨
CREATE TABLE edge_cache (
    id SERIAL PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value JSONB,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ON edge_cache (key);
CREATE INDEX ON edge_cache (expires_at);

-- æ¸…ç†è¿‡æœŸç¼“å­˜
DELETE FROM edge_cache WHERE expires_at < NOW();
```

## 4. æ•°æ®åŒæ­¥

### 4.1 å¢é‡åŒæ­¥

```python
# å¢é‡æ•°æ®åŒæ­¥
class IncrementalSync:
    def __init__(self, edge_db, center_db):
        self.edge_db = edge_db
        self.center_db = center_db

    def sync_incremental(self, table_name, last_sync_time):
        """å¢é‡åŒæ­¥"""
        # 1. æŸ¥è¯¢ä¸­å¿ƒæ•°æ®åº“å¢é‡æ•°æ®
        query = f"""
            SELECT * FROM {table_name}
            WHERE updated_at > %s
            ORDER BY updated_at
        """
        incremental_data = self.center_db.fetch(query, last_sync_time)

        # 2. åŒæ­¥åˆ°è¾¹ç¼˜æ•°æ®åº“
        for row in incremental_data:
            self.edge_db.upsert(table_name, row)

        # 3. æ›´æ–°åŒæ­¥æ—¶é—´
        self.update_sync_time(table_name)
```

### 4.2 å†²çªè§£å†³

```python
# å†²çªè§£å†³ç­–ç•¥
class ConflictResolver:
    def resolve_conflict(self, edge_data, center_data):
        """è§£å†³æ•°æ®å†²çª"""
        # ç­–ç•¥ 1: æ—¶é—´æˆ³ä¼˜å…ˆï¼ˆæœ€åå†™å…¥è·èƒœï¼‰
        if edge_data['updated_at'] > center_data['updated_at']:
            return edge_data
        else:
            return center_data

        # ç­–ç•¥ 2: ä¸­å¿ƒä¼˜å…ˆ
        # return center_data

        # ç­–ç•¥ 3: åˆå¹¶æ•°æ®
        # return self.merge_data(edge_data, center_data)
```

## 5. å®è·µæ¡ˆä¾‹

### 5.1 IoT è¾¹ç¼˜éƒ¨ç½²

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸ IoT å¹³å°è¾¹ç¼˜éƒ¨ç½²ï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **è¾¹ç¼˜èŠ‚ç‚¹**: 100+ ä¸ªè¾¹ç¼˜è®¾å¤‡
- **æ•°æ®è§„æ¨¡**: æ¯ä¸ªèŠ‚ç‚¹ 10GB æ•°æ®
- **éœ€æ±‚**: ä½å»¶è¿ŸæŸ¥è¯¢ã€ç¦»çº¿æ”¯æŒ

**å®ç°æ–¹æ¡ˆ**:

```python
# IoT è¾¹ç¼˜æ•°æ®åº“é…ç½®
# 1. è½»é‡çº§ PostgreSQL éƒ¨ç½²
# 2. æœ¬åœ°æ•°æ®ç¼“å­˜
# 3. å¢é‡æ•°æ®åŒæ­¥

class IoTEdgeDatabase:
    def __init__(self):
        self.edge_db = connect_edge_db()
        self.center_db = connect_center_db()

    def query_sensor_data(self, sensor_id, time_range):
        """æŸ¥è¯¢ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼‰"""
        # 1. æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“
        local_data = self.edge_db.query(
            "SELECT * FROM sensor_data WHERE sensor_id = %s AND time BETWEEN %s AND %s",
            sensor_id, time_range[0], time_range[1]
        )

        # 2. å¦‚æœæœ¬åœ°æ•°æ®ä¸è¶³ï¼ŒæŸ¥è¯¢ä¸­å¿ƒæ•°æ®åº“
        if len(local_data) < 100:
            center_data = self.center_db.query(
                "SELECT * FROM sensor_data WHERE sensor_id = %s AND time BETWEEN %s AND %s",
                sensor_id, time_range[0], time_range[1]
            )
            # åˆå¹¶æ•°æ®
            return self.merge_data(local_data, center_data)

        return local_data
```

**æ•ˆæœ**:

- **å»¶è¿Ÿ**: é™ä½ 80%ï¼ˆè¾¹ç¼˜æŸ¥è¯¢ï¼‰
- **å¯ç”¨æ€§**: 99.99%ï¼ˆç¦»çº¿æ”¯æŒï¼‰
- **æˆæœ¬**: é™ä½ 50%ï¼ˆè¾¹ç¼˜è®¡ç®—ï¼‰

## 6. å‚è€ƒèµ„æ–™

- [äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ](./äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ.md)
- [æ··åˆäº‘éƒ¨ç½²ç­–ç•¥](./æ··åˆäº‘éƒ¨ç½²ç­–ç•¥.md)
- [Serverless æ¶æ„åŸç†](../../03-Serverlessä¸åˆ†æ”¯/æŠ€æœ¯åŸç†/Serverlessæ¶æ„åŸç†.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 06-03-03
