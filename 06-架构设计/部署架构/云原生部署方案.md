# PostgreSQL äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: Kubernetes 1.28+, PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 06-03-01

## ğŸ“‘ ç›®å½•

- [PostgreSQL äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ](#postgresql-äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. Kubernetes éƒ¨ç½²](#2-kubernetes-éƒ¨ç½²)
    - [2.1 StatefulSet éƒ¨ç½²](#21-statefulset-éƒ¨ç½²)
    - [2.2 Service é…ç½®](#22-service-é…ç½®)
    - [2.3 ConfigMap é…ç½®](#23-configmap-é…ç½®)
  - [3. é«˜å¯ç”¨éƒ¨ç½²](#3-é«˜å¯ç”¨éƒ¨ç½²)
    - [3.1 ä¸»ä»å¤åˆ¶](#31-ä¸»ä»å¤åˆ¶)
    - [3.2 æ•…éšœè½¬ç§»](#32-æ•…éšœè½¬ç§»)
  - [4. å­˜å‚¨ç®¡ç†](#4-å­˜å‚¨ç®¡ç†)
    - [4.1 PVC é…ç½®](#41-pvc-é…ç½®)
    - [4.2 å¤‡ä»½å­˜å‚¨](#42-å¤‡ä»½å­˜å‚¨)
  - [5. å®è·µæ¡ˆä¾‹](#5-å®è·µæ¡ˆä¾‹)
    - [5.1 ç”Ÿäº§ç¯å¢ƒ Kubernetes éƒ¨ç½²](#51-ç”Ÿäº§ç¯å¢ƒ-kubernetes-éƒ¨ç½²)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

PostgreSQL äº‘åŸç”Ÿéƒ¨ç½²éœ€è¦ï¼š

- **å®¹å™¨åŒ–**: å®¹å™¨åŒ–éƒ¨ç½²ï¼Œæ˜“äºç®¡ç†
- **å¼¹æ€§æ‰©å±•**: æŒ‰éœ€æ‰©å±•è®¡ç®—å’Œå­˜å‚¨
- **é«˜å¯ç”¨**: é«˜å¯ç”¨éƒ¨ç½²ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
- **è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–è¿ç»´ï¼Œå‡å°‘äººå·¥å¹²é¢„

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **Kubernetes**: å®¹å™¨ç¼–æ’å¹³å°
- **StatefulSet**: æœ‰çŠ¶æ€æœåŠ¡éƒ¨ç½²
- **Operator**: PostgreSQL Operatorï¼ˆå¦‚ Crunchy Dataã€Zalandoï¼‰

### 1.2 æ ¸å¿ƒä»·å€¼

- **éƒ¨ç½²æ•ˆç‡**: æå‡ 10 å€
- **è¿ç»´æˆæœ¬**: é™ä½ 60%
- **å¯ç”¨æ€§**: 99.99% SLA

## 2. Kubernetes éƒ¨ç½²

### 2.1 StatefulSet éƒ¨ç½²

```yaml
# postgresql-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgresql
        image: postgres:14
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgresql
        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        - name: postgresql-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
      volumes:
      - name: postgresql-config
        configMap:
          name: postgresql-config
  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
```

### 2.2 Service é…ç½®

```yaml
# postgresql-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgresql
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    name: postgresql
  selector:
    app: postgresql
---
# åªè¯»æœåŠ¡
apiVersion: v1
kind: Service
metadata:
  name: postgresql-read
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    name: postgresql
  selector:
    app: postgresql
    role: replica
```

### 2.3 ConfigMap é…ç½®

```yaml
# postgresql-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
data:
  postgresql.conf: |
    # åŸºç¡€é…ç½®
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB

    # æµå¤åˆ¶é…ç½®
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10

    # pgvector é…ç½®
    shared_preload_libraries = 'vector'
```

## 3. é«˜å¯ç”¨éƒ¨ç½²

### 3.1 ä¸»ä»å¤åˆ¶

```yaml
# PostgreSQL Operator éƒ¨ç½²ï¼ˆCrunchy Dataï¼‰
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgresql-ha
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-14.9-0
  postgresVersion: 14
  instances:
  - name: instance1
    replicas: 1
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
  - name: replica
    replicas: 2
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.45-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 50Gi
```

### 3.2 æ•…éšœè½¬ç§»

```yaml
# Patroni é…ç½®ï¼ˆZalando Operatorï¼‰
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgresql-ha
spec:
  teamId: "myteam"
  volume:
    size: 100Gi
  numberOfInstances: 3
  users:
    zalando:
    - superuser
    - createdb
  databases:
    foo: zalando
  postgresql:
    version: "14"
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
```

## 4. å­˜å‚¨ç®¡ç†

### 4.1 PVC é…ç½®

```yaml
# StorageClass é…ç½®
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

### 4.2 å¤‡ä»½å­˜å‚¨

```yaml
# å¤‡ä»½ Job
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-backup
spec:
  template:
    spec:
      containers:
      - name: backup
        image: postgres:14
        command:
        - /bin/bash
        - -c
        - |
          pg_dump -h postgresql -U postgres mydb | \
          gzip > /backup/mydb_$(date +%Y%m%d_%H%M%S).sql.gz
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        volumeMounts:
        - name: backup-storage
          mountPath: /backup
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: backup-pvc
      restartPolicy: OnFailure
```

## 5. å®è·µæ¡ˆä¾‹

### 5.1 ç”Ÿäº§ç¯å¢ƒ Kubernetes éƒ¨ç½²

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸä¼ä¸šç”Ÿäº§ç¯å¢ƒï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **æ•°æ®è§„æ¨¡**: 1TB æ•°æ®
- **æŸ¥è¯¢ QPS**: 10,000+
- **éœ€æ±‚**: 99.99% å¯ç”¨æ€§

**å®ç°æ–¹æ¡ˆ**:

```yaml
# ä½¿ç”¨ Zalando PostgreSQL Operator
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: production-postgresql
spec:
  teamId: "production"
  volume:
    size: 1Ti
    storageClass: fast-ssd
  numberOfInstances: 3
  users:
    app_user:
    - createdb
  databases:
    app_db: app_user
  postgresql:
    version: "14"
    parameters:
      max_connections: "500"
      shared_buffers: "4GB"
      effective_cache_size: "12GB"
      maintenance_work_mem: "1GB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "20MB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
```

**æ•ˆæœ**:

- **éƒ¨ç½²æ•ˆç‡**: æå‡ 10 å€
- **è¿ç»´æˆæœ¬**: é™ä½ 60%
- **å¯ç”¨æ€§**: 99.99% SLA

## 6. å‚è€ƒèµ„æ–™

- [æ··åˆäº‘éƒ¨ç½²ç­–ç•¥](./æ··åˆäº‘éƒ¨ç½²ç­–ç•¥.md)
- [è¾¹ç¼˜è®¡ç®—éƒ¨ç½²](./è¾¹ç¼˜è®¡ç®—éƒ¨ç½².md)
- [é«˜å¯ç”¨æ¶æ„è®¾è®¡](../é«˜å¯ç”¨æ¶æ„/é«˜å¯ç”¨æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 06-03-01
