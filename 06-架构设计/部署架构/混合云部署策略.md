# PostgreSQL 混合云部署策略

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+, pgvector 0.7.0+
> **文档编号**: 06-03-02

## 📑 目录

- [PostgreSQL 混合云部署策略](#postgresql-混合云部署策略)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 核心价值](#12-核心价值)
  - [2. 部署架构](#2-部署架构)
    - [2.1 主从跨云部署](#21-主从跨云部署)
    - [2.2 读写分离部署](#22-读写分离部署)
    - [2.3 数据同步策略](#23-数据同步策略)
  - [3. 数据同步](#3-数据同步)
    - [3.1 流复制同步](#31-流复制同步)
    - [3.2 逻辑复制同步](#32-逻辑复制同步)
  - [4. 实践案例](#4-实践案例)
    - [4.1 企业混合云部署](#41-企业混合云部署)
  - [5. 参考资料](#5-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

PostgreSQL 混合云部署需要：

- **跨云部署**: 主从节点跨云部署
- **数据同步**: 跨云数据同步
- **故障转移**: 跨云故障转移
- **合规要求**: 满足数据合规要求

**技术方案**:

- **流复制**: PostgreSQL 流复制
- **逻辑复制**: PostgreSQL 逻辑复制
- **VPN/专线**: 跨云网络连接

### 1.2 核心价值

- **可用性**: 提升至 99.99%
- **灾难恢复**: 跨云灾难恢复
- **合规性**: 满足数据合规要求

## 2. 部署架构

### 2.1 主从跨云部署

```text
云 A（主节点）
  ├── 写入请求
  └── WAL 日志
      ↓ (VPN/专线)
云 B（从节点）
  ├── 只读查询
  └── 流复制
```

**配置示例**:

```sql
-- 云 A 主节点配置（postgresql.conf）
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

-- 云 A 主节点配置（pg_hba.conf）
host replication replicator <云B_IP>/32 md5

-- 云 B 从节点配置（recovery.conf）
primary_conninfo = 'host=<云A_IP> port=5432 user=replicator sslmode=require'
standby_mode = 'on'
```

### 2.2 读写分离部署

```text
云 A（主节点）
  ├── 写入请求
  └── WAL 日志
      ↓
云 B（只读副本）
  ├── 只读查询
  └── 流复制
      ↓
云 C（只读副本）
  ├── 只读查询
  └── 流复制
```

### 2.3 数据同步策略

```sql
-- 1. 流复制同步（实时同步）
-- 配置流复制，实时同步 WAL 日志

-- 2. 逻辑复制同步（表级同步）
CREATE PUBLICATION my_publication FOR TABLE table1, table2;

-- 云 B 订阅
CREATE SUBSCRIPTION my_subscription
CONNECTION 'host=<云A_IP> port=5432 dbname=mydb user=replicator'
PUBLICATION my_publication;
```

## 3. 数据同步

### 3.1 流复制同步

```bash
# 云 A 主节点配置
# postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

# pg_hba.conf
host replication replicator <云B_IP>/32 md5

# 云 B 从节点配置
# recovery.conf
primary_conninfo = 'host=<云A_IP> port=5432 user=replicator sslmode=require'
standby_mode = 'on'
```

### 3.2 逻辑复制同步

```sql
-- 云 A 主节点：创建发布
CREATE PUBLICATION cross_cloud_pub FOR ALL TABLES;

-- 云 B 从节点：创建订阅
CREATE SUBSCRIPTION cross_cloud_sub
CONNECTION 'host=<云A_IP> port=5432 dbname=mydb user=replicator password=xxx sslmode=require'
PUBLICATION cross_cloud_pub;

-- 查看同步状态
SELECT * FROM pg_stat_subscription;
```

## 4. 实践案例

### 4.1 企业混合云部署

**案例背景**:

某企业混合云部署（2025 年 11 月）：

- **云 A**: AWS（主节点）
- **云 B**: Azure（从节点）
- **数据规模**: 1TB 数据
- **需求**: 跨云高可用

**实现方案**:

```yaml
# AWS 主节点配置
# postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

# pg_hba.conf
host replication replicator <Azure_IP>/32 md5

# Azure 从节点配置
# recovery.conf
primary_conninfo = 'host=<AWS_IP> port=5432 user=replicator sslmode=require'
standby_mode = 'on'

# VPN 连接配置
# 使用 AWS VPN 或 Azure VPN Gateway 建立连接
```

**效果**:

- **可用性**: 99.99% SLA
- **灾难恢复**: 跨云灾难恢复
- **数据同步**: <1 分钟延迟

## 5. 参考资料

- [云原生部署方案](./云原生部署方案.md)
- [边缘计算部署](./边缘计算部署.md)
- [高可用架构设计](../高可用架构/高可用架构设计.md)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 06-03-02
