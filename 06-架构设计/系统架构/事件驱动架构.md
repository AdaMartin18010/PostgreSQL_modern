# äº‹ä»¶é©±åŠ¨æ¶æ„

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+  
> **æ–‡æ¡£ç¼–å·**: 06-01-03

## ğŸ“‘ ç›®å½•

- [äº‹ä»¶é©±åŠ¨æ¶æ„](#äº‹ä»¶é©±åŠ¨æ¶æ„)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ¶æ„å®šä½](#12-æ¶æ„å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 æ•´ä½“æ¶æ„](#21-æ•´ä½“æ¶æ„)
    - [2.2 äº‹ä»¶æµè®¾è®¡](#22-äº‹ä»¶æµè®¾è®¡)
    - [2.3 äº‹ä»¶å­˜å‚¨](#23-äº‹ä»¶å­˜å‚¨)
  - [3. PostgreSQL é›†æˆ](#3-postgresql-é›†æˆ)
    - [3.1 äº‹ä»¶è¡¨è®¾è®¡](#31-äº‹ä»¶è¡¨è®¾è®¡)
    - [3.2 äº‹ä»¶å‘å¸ƒ](#32-äº‹ä»¶å‘å¸ƒ)
    - [3.3 äº‹ä»¶è®¢é˜…](#33-äº‹ä»¶è®¢é˜…)
  - [4. å®ç°ç»†èŠ‚](#4-å®ç°ç»†èŠ‚)
    - [4.1 äº‹ä»¶æ¨¡å¼](#41-äº‹ä»¶æ¨¡å¼)
    - [4.2 äº‹ä»¶å¤„ç†](#42-äº‹ä»¶å¤„ç†)
    - [4.3 äº‹ä»¶æº¯æº](#43-äº‹ä»¶æº¯æº)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 äº‹ä»¶å­˜å‚¨ä¼˜åŒ–](#51-äº‹ä»¶å­˜å‚¨ä¼˜åŒ–)
    - [5.2 äº‹ä»¶å¤„ç†ä¼˜åŒ–](#52-äº‹ä»¶å¤„ç†ä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¶æ„è®¾è®¡å»ºè®®](#61-æ¶æ„è®¾è®¡å»ºè®®)
    - [6.2 äº‹ä»¶è®¾è®¡å»ºè®®](#62-äº‹ä»¶è®¾è®¡å»ºè®®)
    - [6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#63-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

åœ¨å¾®æœåŠ¡å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡é—´éœ€è¦è§£è€¦å’Œå¼‚æ­¥é€šä¿¡ã€‚äº‹ä»¶é©±åŠ¨æ¶æ„é€šè¿‡äº‹ä»¶å®ç°æœåŠ¡é—´çš„æ¾è€¦åˆé€šä¿¡ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2010 å¹´**: äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚å¿µæå‡º
2. **2015 å¹´**: CQRS å’Œäº‹ä»¶æº¯æºæ¨¡å¼æˆç†Ÿ
3. **2020 å¹´**: PostgreSQL æ”¯æŒäº‹ä»¶å­˜å‚¨
4. **2025 å¹´**: PostgreSQL 18 å¢å¼ºäº‹ä»¶å¤„ç†èƒ½åŠ›

**å¸‚åœºéœ€æ±‚**:

- **æœåŠ¡è§£è€¦**: æœåŠ¡é—´æ¾è€¦åˆ
- **å¼‚æ­¥å¤„ç†**: æ”¯æŒå¼‚æ­¥äº‹ä»¶å¤„ç†
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•
- **äº‹ä»¶æº¯æº**: æ”¯æŒäº‹ä»¶æº¯æºæ¨¡å¼

### 1.2 æ¶æ„å®šä½

äº‹ä»¶é©±åŠ¨æ¶æ„æä¾›åŸºäºäº‹ä»¶çš„ç³»ç»Ÿè®¾è®¡æ¨¡å¼ï¼Œä½¿ç”¨ PostgreSQL ä½œä¸ºäº‹ä»¶å­˜å‚¨å’Œå¤„ç†å¼•æ“ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

- **æœåŠ¡è§£è€¦**: é€šè¿‡äº‹ä»¶å®ç°æœåŠ¡è§£è€¦
- **å¼‚æ­¥å¤„ç†**: æ”¯æŒå¼‚æ­¥äº‹ä»¶å¤„ç†
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•
- **äº‹ä»¶æº¯æº**: æ”¯æŒå®Œæ•´çš„äº‹ä»¶å†å²

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Event Producers                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚         â”‚
â”‚  â”‚   A   â”‚ â”‚   B   â”‚ â”‚   C   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (Publish Events)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Event Store (PostgreSQL)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Event Table                     â”‚  â”‚
â”‚  â”‚  - Event ID                      â”‚  â”‚
â”‚  â”‚  - Event Type                    â”‚  â”‚
â”‚  â”‚  - Event Data                    â”‚  â”‚
â”‚  â”‚  - Timestamp                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (Subscribe Events)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Event Consumers                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚         â”‚
â”‚  â”‚   X   â”‚ â”‚   Y   â”‚ â”‚   Z   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 äº‹ä»¶æµè®¾è®¡

**äº‹ä»¶æµ**:

1. **äº‹ä»¶äº§ç”Ÿ**: æœåŠ¡äº§ç”Ÿäº‹ä»¶
2. **äº‹ä»¶å­˜å‚¨**: å­˜å‚¨åˆ° PostgreSQL
3. **äº‹ä»¶åˆ†å‘**: åˆ†å‘åˆ°è®¢é˜…è€…
4. **äº‹ä»¶å¤„ç†**: è®¢é˜…è€…å¤„ç†äº‹ä»¶

### 2.3 äº‹ä»¶å­˜å‚¨

**å­˜å‚¨è®¾è®¡**:

- **äº‹ä»¶è¡¨**: å­˜å‚¨æ‰€æœ‰äº‹ä»¶
- **äº‹ä»¶ç±»å‹**: æŒ‰ç±»å‹åˆ†ç±»
- **äº‹ä»¶ç‰ˆæœ¬**: æ”¯æŒäº‹ä»¶ç‰ˆæœ¬åŒ–

---

## 3. PostgreSQL é›†æˆ

### 3.1 äº‹ä»¶è¡¨è®¾è®¡

**è¡¨ç»“æ„**:

```sql
CREATE TABLE events (
    id BIGSERIAL PRIMARY KEY,
    event_id UUID NOT NULL UNIQUE,
    event_type VARCHAR(255) NOT NULL,
    aggregate_id VARCHAR(255) NOT NULL,
    aggregate_type VARCHAR(255) NOT NULL,
    event_data JSONB NOT NULL,
    metadata JSONB,
    version INTEGER NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_events_aggregate ON events(aggregate_type, aggregate_id);
CREATE INDEX idx_events_type ON events(event_type);
CREATE INDEX idx_events_time ON events(created_at);
```

### 3.2 äº‹ä»¶å‘å¸ƒ

**å‘å¸ƒå®ç°**:

```sql
-- äº‹ä»¶å‘å¸ƒå‡½æ•°
CREATE OR REPLACE FUNCTION publish_event(
    p_event_type VARCHAR,
    p_aggregate_id VARCHAR,
    p_aggregate_type VARCHAR,
    p_event_data JSONB,
    p_metadata JSONB DEFAULT NULL
) RETURNS UUID AS $$
DECLARE
    v_event_id UUID;
    v_version INTEGER;
BEGIN
    -- ç”Ÿæˆäº‹ä»¶ ID
    v_event_id := gen_random_uuid();
    
    -- è·å–ç‰ˆæœ¬å·
    SELECT COALESCE(MAX(version), 0) + 1 INTO v_version
    FROM events
    WHERE aggregate_type = p_aggregate_type
      AND aggregate_id = p_aggregate_id;
    
    -- æ’å…¥äº‹ä»¶
    INSERT INTO events (
        event_id,
        event_type,
        aggregate_id,
        aggregate_type,
        event_data,
        metadata,
        version
    ) VALUES (
        v_event_id,
        p_event_type,
        p_aggregate_id,
        p_aggregate_type,
        p_event_data,
        p_metadata,
        v_version
    );
    
    -- é€šçŸ¥è®¢é˜…è€…
    PERFORM pg_notify('event_channel', json_build_object(
        'event_id', v_event_id,
        'event_type', p_event_type,
        'aggregate_id', p_aggregate_id
    )::text);
    
    RETURN v_event_id;
END;
$$ LANGUAGE plpgsql;
```

### 3.3 äº‹ä»¶è®¢é˜…

**è®¢é˜…å®ç°**:

```python
import psycopg2
import select

class EventSubscriber:
    """äº‹ä»¶è®¢é˜…è€…"""
    
    def __init__(self, connection_string):
        self.conn = psycopg2.connect(connection_string)
        self.conn.set_isolation_level(
            psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT
        )
        self.cursor = self.conn.cursor()
        self.cursor.execute("LISTEN event_channel")
    
    def subscribe(self, event_handler):
        """è®¢é˜…äº‹ä»¶"""
        while True:
            if select.select([self.conn], [], [], 5) == ([], [], []):
                continue
            
            self.conn.poll()
            while self.conn.notifies:
                notify = self.conn.notifies.pop(0)
                event = json.loads(notify.payload)
                event_handler.handle(event)
```

---

## 4. å®ç°ç»†èŠ‚

### 4.1 äº‹ä»¶æ¨¡å¼

**äº‹ä»¶æ¨¡å¼**:

```python
class Event:
    """äº‹ä»¶åŸºç±»"""
    
    def __init__(self, event_type, aggregate_id, data):
        self.event_id = uuid.uuid4()
        self.event_type = event_type
        self.aggregate_id = aggregate_id
        self.data = data
        self.timestamp = datetime.now()
        self.version = None
```

### 4.2 äº‹ä»¶å¤„ç†

**äº‹ä»¶å¤„ç†**:

```python
class EventHandler:
    """äº‹ä»¶å¤„ç†å™¨"""
    
    def handle(self, event):
        """å¤„ç†äº‹ä»¶"""
        handler_method = getattr(
            self,
            f"handle_{event.event_type}",
            self.handle_default
        )
        handler_method(event)
    
    def handle_user_created(self, event):
        """å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶"""
        # å¤„ç†é€»è¾‘
        pass
```

### 4.3 äº‹ä»¶æº¯æº

**äº‹ä»¶æº¯æº**:

```sql
-- ä»äº‹ä»¶é‡å»ºèšåˆ
CREATE OR REPLACE FUNCTION rebuild_aggregate(
    p_aggregate_type VARCHAR,
    p_aggregate_id VARCHAR
) RETURNS JSONB AS $$
DECLARE
    v_state JSONB := '{}';
    v_event RECORD;
BEGIN
    -- æŒ‰ç‰ˆæœ¬é¡ºåºå¤„ç†äº‹ä»¶
    FOR v_event IN
        SELECT event_type, event_data
        FROM events
        WHERE aggregate_type = p_aggregate_type
          AND aggregate_id = p_aggregate_id
        ORDER BY version
    LOOP
        -- åº”ç”¨äº‹ä»¶åˆ°çŠ¶æ€
        v_state := apply_event(v_state, v_event.event_type, v_event.event_data);
    END LOOP;
    
    RETURN v_state;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 äº‹ä»¶å­˜å‚¨ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**:

- **åˆ†åŒºå­˜å‚¨**: æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨äº‹ä»¶
- **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–äº‹ä»¶æŸ¥è¯¢ç´¢å¼•
- **å‹ç¼©å­˜å‚¨**: å‹ç¼©å†å²äº‹ä»¶

### 5.2 äº‹ä»¶å¤„ç†ä¼˜åŒ–

**ä¼˜åŒ–æŠ€å·§**:

- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¤„ç†äº‹ä»¶
- **å¹¶è¡Œå¤„ç†**: å¹¶è¡Œå¤„ç†äº‹ä»¶
- **å¼‚æ­¥å¤„ç†**: å¼‚æ­¥å¤„ç†äº‹ä»¶

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¶æ„è®¾è®¡å»ºè®®

- **äº‹ä»¶è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„äº‹ä»¶æ¨¡å¼
- **äº‹ä»¶ç‰ˆæœ¬**: æ”¯æŒäº‹ä»¶ç‰ˆæœ¬åŒ–
- **äº‹ä»¶å­˜å‚¨**: ä½¿ç”¨å¯é çš„äº‹ä»¶å­˜å‚¨

### 6.2 äº‹ä»¶è®¾è®¡å»ºè®®

- **ä¸å¯å˜æ€§**: äº‹ä»¶ä¸å¯å˜
- **å¹‚ç­‰æ€§**: äº‹ä»¶å¤„ç†å¹‚ç­‰
- **é¡ºåºæ€§**: ä¿è¯äº‹ä»¶é¡ºåº

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **åˆ†åŒºå­˜å‚¨**: ä½¿ç”¨åˆ†åŒºè¡¨
- **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–ç´¢å¼•è®¾è®¡
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¤„ç†äº‹ä»¶

---

## 7. å‚è€ƒèµ„æ–™

- [äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼](https://martinfowler.com/articles/201701-event-driven.html)
- [äº‹ä»¶æº¯æºæ¨¡å¼](https://martinfowler.com/eaaDev/EventSourcing.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team

