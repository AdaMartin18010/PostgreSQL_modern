# PostgreSQL å‘é‡æœç´¢å¾®æœåŠ¡æ¶æ„é›†æˆ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 06-01-02

## ğŸ“‘ ç›®å½•

- [PostgreSQL å‘é‡æœç´¢å¾®æœåŠ¡æ¶æ„é›†æˆ](#postgresql-å‘é‡æœç´¢å¾®æœåŠ¡æ¶æ„é›†æˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ¶æ„ä¼˜åŠ¿](#11-æ¶æ„ä¼˜åŠ¿)
    - [1.2 æŠ€æœ¯æŒ‘æˆ˜](#12-æŠ€æœ¯æŒ‘æˆ˜)
  - [2. å¾®æœåŠ¡æ¶æ„è®¾è®¡](#2-å¾®æœåŠ¡æ¶æ„è®¾è®¡)
    - [2.1 æœåŠ¡åˆ’åˆ†](#21-æœåŠ¡åˆ’åˆ†)
    - [2.2 æœåŠ¡èŒè´£](#22-æœåŠ¡èŒè´£)
  - [3. æœåŠ¡æ‹†åˆ†ç­–ç•¥](#3-æœåŠ¡æ‹†åˆ†ç­–ç•¥)
    - [3.1 æ•°æ®åº“å…±äº«æ¨¡å¼](#31-æ•°æ®åº“å…±äº«æ¨¡å¼)
    - [3.2 æ•°æ®åº“ç‹¬ç«‹æ¨¡å¼](#32-æ•°æ®åº“ç‹¬ç«‹æ¨¡å¼)
  - [4. æ•°æ®ä¸€è‡´æ€§](#4-æ•°æ®ä¸€è‡´æ€§)
    - [4.1 äº‹ä»¶é©±åŠ¨æ¶æ„](#41-äº‹ä»¶é©±åŠ¨æ¶æ„)
    - [4.2 æœ€ç»ˆä¸€è‡´æ€§](#42-æœ€ç»ˆä¸€è‡´æ€§)
  - [5. æœåŠ¡é€šä¿¡](#5-æœåŠ¡é€šä¿¡)
    - [5.1 REST API](#51-rest-api)
    - [5.2 gRPC](#52-grpc)
  - [6. å®è·µæ¡ˆä¾‹](#6-å®è·µæ¡ˆä¾‹)
    - [6.1 ç”µå•†å¾®æœåŠ¡æ¶æ„](#61-ç”µå•†å¾®æœåŠ¡æ¶æ„)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æ¶æ„ä¼˜åŠ¿

- **æœåŠ¡ç‹¬ç«‹**: å„æœåŠ¡ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•
- **æŠ€æœ¯æ ˆçµæ´»**: ä¸åŒæœåŠ¡å¯ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆ
- **é«˜å¯ç”¨**: å•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿ
- **å¯æ‰©å±•**: æŒ‰éœ€æ‰©å±•ç‰¹å®šæœåŠ¡

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

- **æ•°æ®ä¸€è‡´æ€§**: è·¨æœåŠ¡æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **æœåŠ¡é€šä¿¡**: æœåŠ¡é—´é€šä¿¡æœºåˆ¶
- **äº‹åŠ¡ç®¡ç†**: åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **æ•°æ®å…±äº«**: å…±äº«æ•°æ®åº“ vs ç‹¬ç«‹æ•°æ®åº“

## 2. å¾®æœåŠ¡æ¶æ„è®¾è®¡

### 2.1 æœåŠ¡åˆ’åˆ†

```text
API ç½‘å…³
  â”œâ”€â”€ ç”¨æˆ·æœåŠ¡
  â”œâ”€â”€ å•†å“æœåŠ¡
  â”œâ”€â”€ æœç´¢æœåŠ¡ï¼ˆå‘é‡æœç´¢ï¼‰
  â”œâ”€â”€ æ¨èæœåŠ¡
  â””â”€â”€ è®¢å•æœåŠ¡
  â†“
å…±äº«æ•°æ®åº“ï¼ˆPostgreSQL + pgvectorï¼‰
  â”œâ”€â”€ ç”¨æˆ·æ•°æ®
  â”œâ”€â”€ å•†å“æ•°æ®
  â”œâ”€â”€ å‘é‡æ•°æ®
  â””â”€â”€ è®¢å•æ•°æ®
```

### 2.2 æœåŠ¡èŒè´£

**æœç´¢æœåŠ¡**:

- å‘é‡æœç´¢
- æ··åˆæœç´¢
- æœç´¢ä¼˜åŒ–

**æ¨èæœåŠ¡**:

- ä¸ªæ€§åŒ–æ¨è
- ååŒè¿‡æ»¤
- æ¨èç®—æ³•

**å•†å“æœåŠ¡**:

- å•†å“ç®¡ç†
- å•†å“å‘é‡åŒ–
- å•†å“ä¿¡æ¯æŸ¥è¯¢

## 3. æœåŠ¡æ‹†åˆ†ç­–ç•¥

### 3.1 æ•°æ®åº“å…±äº«æ¨¡å¼

```sql
-- å…±äº«æ•°æ®åº“ï¼ŒæŒ‰ schema åˆ’åˆ†
CREATE SCHEMA user_service;
CREATE SCHEMA product_service;
CREATE SCHEMA search_service;

-- ç”¨æˆ·æœåŠ¡è¡¨
CREATE TABLE user_service.users (
    id SERIAL PRIMARY KEY,
    email TEXT UNIQUE,
    name TEXT
);

-- å•†å“æœåŠ¡è¡¨
CREATE TABLE product_service.products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    price DECIMAL(10, 2)
);

-- æœç´¢æœåŠ¡è¡¨
CREATE TABLE search_service.vectors (
    id SERIAL PRIMARY KEY,
    entity_type TEXT,  -- 'product', 'user'
    entity_id INTEGER,
    embedding vector(1536)
);
```

### 3.2 æ•°æ®åº“ç‹¬ç«‹æ¨¡å¼

```python
# æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“
class MicroserviceArchitecture:
    def __init__(self):
        self.user_db = DatabaseConnection('user_db')
        self.product_db = DatabaseConnection('product_db')
        self.search_db = DatabaseConnection('search_db')

    async def search_products(self, query_vector):
        """æœç´¢æœåŠ¡æŸ¥è¯¢å•†å“"""
        # 1. åœ¨æœç´¢æ•°æ®åº“æŸ¥è¯¢å‘é‡
        vector_results = await self.search_db.fetch("""
            SELECT entity_id FROM vectors
            WHERE entity_type = 'product'
            ORDER BY embedding <=> $1::vector
            LIMIT 20
        """, query_vector)

        product_ids = [r['entity_id'] for r in vector_results]

        # 2. åœ¨å•†å“æ•°æ®åº“æŸ¥è¯¢å•†å“ä¿¡æ¯
        products = await self.product_db.fetch("""
            SELECT * FROM products WHERE id = ANY($1::int[])
        """, product_ids)

        return products
```

## 4. æ•°æ®ä¸€è‡´æ€§

### 4.1 äº‹ä»¶é©±åŠ¨æ¶æ„

```python
# äº‹ä»¶å‘å¸ƒ
class EventPublisher:
    async def publish_product_created(self, product_id, product_data):
        """å‘å¸ƒå•†å“åˆ›å»ºäº‹ä»¶"""
        event = {
            'type': 'product.created',
            'product_id': product_id,
            'data': product_data,
            'timestamp': datetime.now().isoformat()
        }

        # å‘å¸ƒåˆ°æ¶ˆæ¯é˜Ÿåˆ—
        await self.message_queue.publish('product.events', event)

# äº‹ä»¶è®¢é˜…
class SearchService:
    async def handle_product_created(self, event):
        """å¤„ç†å•†å“åˆ›å»ºäº‹ä»¶"""
        product_id = event['product_id']
        product_data = event['data']

        # ç”Ÿæˆå‘é‡
        embedding = await self.generate_embedding(product_data)

        # å­˜å‚¨å‘é‡
        await self.search_db.execute("""
            INSERT INTO vectors (entity_type, entity_id, embedding)
            VALUES ('product', $1, $2::vector)
        """, product_id, embedding)
```

### 4.2 æœ€ç»ˆä¸€è‡´æ€§

```python
# æœ€ç»ˆä¸€è‡´æ€§ä¿è¯
class ConsistencyManager:
    async def sync_product_vector(self, product_id):
        """åŒæ­¥å•†å“å‘é‡ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰"""
        # 1. ä»å•†å“æœåŠ¡è·å–å•†å“ä¿¡æ¯
        product = await self.product_service.get_product(product_id)

        # 2. ç”Ÿæˆå‘é‡
        embedding = await self.generate_embedding(product)

        # 3. æ›´æ–°æœç´¢æœåŠ¡å‘é‡
        await self.search_service.update_vector(product_id, embedding)
```

## 5. æœåŠ¡é€šä¿¡

### 5.1 REST API

```python
# æœç´¢æœåŠ¡ API
from fastapi import FastAPI

app = FastAPI()

@app.post("/api/search/vector")
async def vector_search(query_vector: list[float], limit: int = 10):
    """å‘é‡æœç´¢ API"""
    results = await search_service.search(query_vector, limit)
    return results

@app.get("/api/search/products/{product_id}/similar")
async def similar_products(product_id: int, limit: int = 10):
    """ç›¸ä¼¼å•†å“æ¨è API"""
    results = await search_service.find_similar_products(product_id, limit)
    return results
```

### 5.2 gRPC

```protobuf
// search.proto
syntax = "proto3";

service SearchService {
    rpc VectorSearch(VectorSearchRequest) returns (VectorSearchResponse);
    rpc SimilarProducts(SimilarProductsRequest) returns (SimilarProductsResponse);
}

message VectorSearchRequest {
    repeated float query_vector = 1;
    int32 limit = 2;
}

message VectorSearchResponse {
    repeated Product products = 1;
}
```

## 6. å®è·µæ¡ˆä¾‹

### 6.1 ç”µå•†å¾®æœåŠ¡æ¶æ„

```python
# å®Œæ•´çš„ç”µå•†å¾®æœåŠ¡æ¶æ„
class ECommerceMicroservices:
    def __init__(self):
        self.user_service = UserService()
        self.product_service = ProductService()
        self.search_service = SearchService()
        self.recommendation_service = RecommendationService()
        self.order_service = OrderService()

    async def search_products(self, query, user_id, limit=20):
        """å•†å“æœç´¢æµç¨‹"""
        # 1. æœç´¢æœåŠ¡ï¼šå‘é‡æœç´¢
        search_results = await self.search_service.search(query, limit * 2)

        # 2. æ¨èæœåŠ¡ï¼šä¸ªæ€§åŒ–æ’åº
        personalized_results = await self.recommendation_service.personalize(
            search_results,
            user_id
        )

        # 3. å•†å“æœåŠ¡ï¼šè·å–å•†å“è¯¦æƒ…
        product_ids = [r['id'] for r in personalized_results]
        products = await self.product_service.get_products(product_ids)

        return products
```

## 7. å‚è€ƒèµ„æ–™

- [ä¼ä¸šçº§æ¶æ„è®¾è®¡](./ä¼ä¸šçº§æ¶æ„è®¾è®¡.md)
- [å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡](../../01-å‘é‡ä¸æ··åˆæœç´¢/æ¶æ„è®¾è®¡/å‘é‡æ•°æ®åº“æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 06-01-02
