# PostgreSQL 灾难恢复方案

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+, WAL 归档, PITR
> **文档编号**: 06-04-02

## 📑 目录

- [PostgreSQL 灾难恢复方案](#postgresql-灾难恢复方案)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 核心价值](#12-核心价值)
  - [2. 备份策略](#2-备份策略)
    - [2.1 基础备份](#21-基础备份)
    - [2.2 WAL 归档](#22-wal-归档)
    - [2.3 连续归档](#23-连续归档)
  - [3. 恢复策略](#3-恢复策略)
    - [3.1 完整恢复](#31-完整恢复)
    - [3.2 点对点恢复（PITR）](#32-点对点恢复pitr)
    - [3.3 部分恢复](#33-部分恢复)
  - [4. 实践案例](#4-实践案例)
    - [4.1 生产环境灾难恢复](#41-生产环境灾难恢复)
  - [5. 参考资料](#5-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

PostgreSQL 灾难恢复需要：

- **数据保护**: 保护数据不丢失
- **快速恢复**: 快速恢复，减少停机时间
- **点对点恢复**: 支持恢复到任意时间点
- **自动化**: 自动化备份和恢复流程

**技术方案**:

- **基础备份**: pg_basebackup
- **WAL 归档**: 连续归档 WAL 日志
- **PITR**: 点对点恢复

### 1.2 核心价值

- **RPO**: 数据丢失 <1 分钟
- **RTO**: 恢复时间 <30 分钟
- **可靠性**: 100% 数据恢复成功率

## 2. 备份策略

### 2.1 基础备份

```bash
# 使用 pg_basebackup 创建基础备份
pg_basebackup \
  -h primary_host \
  -U replicator \
  -D /backup/base_backup_$(date +%Y%m%d_%H%M%S) \
  -Ft \
  -z \
  -P \
  -W

# 压缩备份
tar -czf base_backup_$(date +%Y%m%d_%H%M%S).tar.gz /backup/base_backup_*
```

### 2.2 WAL 归档

```sql
-- 配置 WAL 归档（postgresql.conf）
wal_level = replica
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'

-- 创建归档目录
mkdir -p /backup/wal
chown postgres:postgres /backup/wal
```

### 2.3 连续归档

```bash
# 自动化归档脚本
#!/bin/bash
ARCHIVE_DIR="/backup/wal"
WAL_FILE="$1"

# 复制到本地归档
cp "$WAL_FILE" "$ARCHIVE_DIR/$(basename $WAL_FILE)"

# 同步到远程存储（可选）
rsync -av "$ARCHIVE_DIR/" backup-server:/backup/wal/

# 清理旧归档（保留 7 天）
find "$ARCHIVE_DIR" -type f -mtime +7 -delete
```

## 3. 恢复策略

### 3.1 完整恢复

```bash
# 1. 停止 PostgreSQL
systemctl stop postgresql

# 2. 备份当前数据目录
mv /var/lib/postgresql/14/main /var/lib/postgresql/14/main.backup

# 3. 恢复基础备份
mkdir -p /var/lib/postgresql/14/main
tar -xzf base_backup_20251101_020000.tar.gz -C /var/lib/postgresql/14/main

# 4. 配置恢复
cat > /var/lib/postgresql/14/main/postgresql.conf <<EOF
restore_command = 'cp /backup/wal/%f %p'
recovery_target_action = 'promote'
EOF

# 5. 创建恢复信号文件
touch /var/lib/postgresql/14/main/recovery.signal

# 6. 启动 PostgreSQL（自动恢复）
systemctl start postgresql
```

### 3.2 点对点恢复（PITR）

```bash
# 恢复到指定时间点
cat > /var/lib/postgresql/14/main/postgresql.conf <<EOF
restore_command = 'cp /backup/wal/%f %p'
recovery_target_time = '2025-11-01 10:00:00'
recovery_target_action = 'promote'
EOF

touch /var/lib/postgresql/14/main/recovery.signal
systemctl start postgresql
```

### 3.3 部分恢复

```bash
# 恢复特定表
pg_restore \
  -h localhost \
  -U postgres \
  -d target_database \
  -t table_name \
  backup.dump
```

## 4. 实践案例

### 4.1 生产环境灾难恢复

**案例背景**:

某企业生产环境（2025 年 11 月）：

- **数据规模**: 1TB 数据
- **备份策略**: 每日基础备份 + 连续 WAL 归档
- **需求**: RPO <1 分钟，RTO <30 分钟

**实现方案**:

```bash
# 1. 自动化备份脚本
#!/bin/bash
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# 基础备份
pg_basebackup -h localhost -U replicator \
  -D "$BACKUP_DIR/base_$DATE" \
  -Ft -z -P

# 清理旧备份（保留 7 天）
find "$BACKUP_DIR" -name "base_*" -mtime +7 -delete

# 2. WAL 归档配置
# archive_command = '/usr/local/bin/archive_wal.sh %p %f'

# 3. 恢复测试脚本
#!/bin/bash
# 定期测试恢复流程
# 在测试环境执行恢复，验证数据完整性
```

**效果**:

- **RPO**: <1 分钟（WAL 归档）
- **RTO**: <30 分钟（自动化恢复）
- **成功率**: 100% 恢复成功率

## 5. 参考资料

- [高可用架构设计](./高可用架构设计.md)
- [容错机制设计](./容错机制设计.md)
- [备份与恢复](../../09-实践指南/运维手册/备份与恢复.md)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 06-04-02
