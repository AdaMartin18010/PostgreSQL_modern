# PostgreSQL 高可用架构设计

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+, Patroni 3.0+, pgvector 0.7.0+
> **文档编号**: 06-04-01

## 📑 目录

- [PostgreSQL 高可用架构设计](#postgresql-高可用架构设计)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 核心价值](#12-核心价值)
  - [2. 高可用架构](#2-高可用架构)
    - [2.1 主从复制架构](#21-主从复制架构)
    - [2.2 流复制架构](#22-流复制架构)
    - [2.3 Patroni 高可用架构](#23-patroni-高可用架构)
  - [3. 故障转移](#3-故障转移)
    - [3.1 自动故障转移](#31-自动故障转移)
    - [3.2 手动故障转移](#32-手动故障转移)
  - [4. 实践案例](#4-实践案例)
    - [4.1 生产环境高可用部署](#41-生产环境高可用部署)
  - [5. 参考资料](#5-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

PostgreSQL 高可用架构需要：

- **高可用性**: 99.99% 可用性保证
- **自动故障转移**: 自动故障转移，减少停机时间
- **数据一致性**: 保证数据一致性
- **性能**: 不影响查询性能

**技术方案**:

- **流复制**: PostgreSQL 流复制
- **Patroni**: 高可用管理工具
- **负载均衡**: 读写分离、负载均衡

### 1.2 核心价值

- **可用性**: 99.99% SLA
- **故障转移**: <30 秒自动故障转移
- **数据一致性**: 100% 数据一致性

## 2. 高可用架构

### 2.1 主从复制架构

```text
主节点（Primary）
  ├── 写入请求
  └── WAL 日志
      ↓
从节点（Standby）
  ├── 只读查询
  └── 流复制
```

**配置示例**:

```sql
-- 主节点配置（postgresql.conf）
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3

-- 主节点配置（pg_hba.conf）
host replication replicator 192.168.1.0/24 md5
```

### 2.2 流复制架构

```bash
# 从节点配置（recovery.conf）
primary_conninfo = 'host=192.168.1.10 port=5432 user=replicator'
standby_mode = 'on'
```

### 2.3 Patroni 高可用架构

```yaml
# Patroni 配置（patroni.yml）
scope: postgres_cluster
namespace: /db/
name: postgresql-node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.10:8008

etcd3:
  host: 192.168.1.20:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
  initdb:
  - encoding: UTF8
  - data-checksums
  pg_hba:
  - host replication replicator 0.0.0.0/0 md5
  - host all all 0.0.0.0/0 md5
  post_init: /usr/local/bin/postgres_init.sh

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.1.10:5432
  data_dir: /var/lib/postgresql/14/main
  pgpass: /var/lib/postgresql/.pgpass
  authentication:
    replication:
      username: replicator
      password: replicator_password
    superuser:
      username: postgres
      password: postgres_password
  parameters:
    wal_level: replica
    hot_standby: "on"
    max_connections: 100
    max_wal_senders: 10
    max_replication_slots: 10
```

## 3. 故障转移

### 3.1 自动故障转移

```bash
# Patroni 自动故障转移
# 1. 主节点故障检测
# 2. 自动提升从节点为主节点
# 3. 更新 DNS/负载均衡配置

# 查看集群状态
patronictl -c /etc/patroni/patroni.yml list

# 手动故障转移
patronictl -c /etc/patroni/patroni.yml switchover
```

### 3.2 手动故障转移

```sql
-- 1. 在主节点创建恢复点
SELECT pg_create_restore_point('before_failover');

-- 2. 在从节点提升为主节点
SELECT pg_promote();

-- 3. 验证新主节点
SELECT pg_is_in_recovery();
```

## 4. 实践案例

### 4.1 生产环境高可用部署

**案例背景**:

某企业生产环境（2025 年 11 月）：

- **数据规模**: 1TB 数据
- **查询 QPS**: 10,000+
- **需求**: 99.99% 可用性

**实现方案**:

```yaml
# 架构设计
主节点（Primary）
  ├── 写入请求
  └── 3 个从节点（Standby）
      ├── 只读查询
      └── 自动故障转移

# Patroni 配置
scope: production_cluster
name: postgresql-primary

etcd3:
  host: etcd-cluster:2379

postgresql:
  parameters:
    max_connections: 200
    shared_buffers: 4GB
    effective_cache_size: 12GB
```

**效果**:

- **可用性**: 99.99% SLA
- **故障转移**: <30 秒自动故障转移
- **数据一致性**: 100% 数据一致性

## 5. 参考资料

- [灾难恢复方案](./灾难恢复方案.md)
- [容错机制设计](./容错机制设计.md)
- [企业级架构设计](../系统架构/企业级架构设计.md)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 06-04-01
