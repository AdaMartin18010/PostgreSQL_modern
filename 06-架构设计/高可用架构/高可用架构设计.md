# 6.4.1 高可用架构设计

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: PostgreSQL 18+  
> **文档编号**: 06-04-01

## 📑 目录

- [6.4.1 高可用架构设计](#641-高可用架构设计)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 架构定位](#12-架构定位)
    - [1.3 核心价值](#13-核心价值)
  - [2. 架构设计](#2-架构设计)
    - [2.1 主从复制架构](#21-主从复制架构)
    - [2.2 流复制架构](#22-流复制架构)
    - [2.3 集群架构](#23-集群架构)
  - [3. 故障转移](#3-故障转移)
    - [3.1 自动故障转移](#31-自动故障转移)
    - [3.2 手动故障转移](#32-手动故障转移)
    - [3.3 故障恢复](#33-故障恢复)
  - [4. 负载均衡](#4-负载均衡)
    - [4.1 读写分离](#41-读写分离)
    - [4.2 连接池](#42-连接池)
    - [4.3 负载均衡器](#43-负载均衡器)
  - [5. 监控与告警](#5-监控与告警)
    - [5.1 健康检查](#51-健康检查)
    - [5.2 性能监控](#52-性能监控)
    - [5.3 告警配置](#53-告警配置)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 架构设计建议](#61-架构设计建议)
    - [6.2 运维建议](#62-运维建议)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

高可用架构需要保证数据库服务的持续可用性，通过主从复制、故障转移、负载均衡等技术实现高可用。

**技术演进**:

1. **2010 年**: PostgreSQL 9.0 引入流复制
2. **2015 年**: 自动故障转移工具成熟
3. **2020 年**: 高可用方案标准化
4. **2025 年**: PostgreSQL 18 优化高可用特性

### 1.2 架构定位

高可用架构设计提供 PostgreSQL 高可用部署方案，保证服务的持续可用性。

### 1.3 核心价值

- **高可用性**: 保证服务持续可用
- **自动恢复**: 自动故障转移和恢复
- **性能优化**: 优化读写性能
- **数据安全**: 保证数据安全

---

## 2. 架构设计

### 2.1 主从复制架构

**架构图**:

```text
┌─────────────┐
│  Primary    │
│  (Master)   │
└──────┬──────┘
       │ WAL Streaming
       │
┌──────┴──────┐
│   Replica   │
│  (Standby)  │
└─────────────┘
```

**配置示例**:

```sql
-- Primary 配置
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3

-- Replica 配置
hot_standby = on
```

### 2.2 流复制架构

**流复制配置**:

```sql
-- Primary 创建复制用户
CREATE USER replicator WITH REPLICATION PASSWORD 'password';

-- Replica 配置恢复
primary_conninfo = 'host=primary_host port=5432 user=replicator password=password'
```

### 2.3 集群架构

**多节点集群**:

```text
┌─────────────┐
│  Primary    │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
┌──┴──┐ ┌──┴──┐
│ R1  │ │ R2  │
└─────┘ └─────┘
```

---

## 3. 故障转移

### 3.1 自动故障转移

**自动切换**:

- **健康检查**: 定期检查主节点健康
- **自动提升**: 主节点故障自动提升从节点
- **VIP 切换**: 自动切换虚拟 IP

### 3.2 手动故障转移

**手动切换步骤**:

1. 停止主节点写入
2. 提升从节点为主节点
3. 更新应用连接配置
4. 启动新主节点

### 3.3 故障恢复

**恢复流程**:

1. 修复故障节点
2. 重新同步数据
3. 配置为从节点
4. 加入集群

---

## 4. 负载均衡

### 4.1 读写分离

**读写分离配置**:

```python
# 使用连接池实现读写分离
from sqlalchemy import create_engine

# 写连接（主节点）
write_engine = create_engine("postgresql://user:pass@primary/db")

# 读连接（从节点）
read_engine = create_engine("postgresql://user:pass@replica/db")
```

### 4.2 连接池

**连接池配置**:

```python
from sqlalchemy.pool import QueuePool

engine = create_engine(
    connection_string,
    poolclass=QueuePool,
    pool_size=10,
    max_overflow=20
)
```

### 4.3 负载均衡器

**负载均衡配置**:

- **PgBouncer**: 连接池和负载均衡
- **HAProxy**: 高可用负载均衡
- **Keepalived**: VIP 管理

---

## 5. 监控与告警

### 5.1 健康检查

**健康检查**:

```sql
-- 检查主节点状态
SELECT pg_is_in_recovery();

-- 检查复制延迟
SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()));
```

### 5.2 性能监控

**监控指标**:

- **连接数**: 当前连接数
- **查询性能**: 查询延迟
- **复制延迟**: 主从复制延迟
- **资源使用**: CPU、内存、磁盘

### 5.3 告警配置

**告警规则**:

- **主节点故障**: 主节点不可用告警
- **复制延迟**: 复制延迟超过阈值告警
- **资源告警**: 资源使用超过阈值告警

---

## 6. 最佳实践

### 6.1 架构设计建议

- **冗余设计**: 至少 2 个从节点
- **地理分布**: 跨地域部署
- **自动切换**: 配置自动故障转移

### 6.2 运维建议

- **定期演练**: 定期进行故障演练
- **监控告警**: 设置完善的监控告警
- **备份策略**: 制定备份和恢复策略

---

## 7. 参考资料

- [PostgreSQL 高可用](https://www.postgresql.org/docs/current/high-availability.html)
- [流复制配置](https://www.postgresql.org/docs/current/warm-standby.html)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team
