# æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 16+ / pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 01-04-02

## ğŸ“‘ ç›®å½•

- [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#2-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [2.1 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–](#21-æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–)
    - [2.2 è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–](#22-è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–)
    - [2.3 æŸ¥è¯¢é‡å†™ä¼˜åŒ–](#23-æŸ¥è¯¢é‡å†™ä¼˜åŒ–)
  - [3. ç´¢å¼•ä¼˜åŒ–](#3-ç´¢å¼•ä¼˜åŒ–)
    - [3.1 å¤åˆç´¢å¼•](#31-å¤åˆç´¢å¼•)
  - [4. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–](#4-å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–)
    - [4.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®](#41-å¹¶è¡ŒæŸ¥è¯¢é…ç½®)
    - [4.2 å¹¶è¡ŒæŸ¥è¯¢é€‚ç”¨åœºæ™¯](#42-å¹¶è¡ŒæŸ¥è¯¢é€‚ç”¨åœºæ™¯)
  - [5. ç¼“å­˜ä¼˜åŒ–](#5-ç¼“å­˜ä¼˜åŒ–)
    - [5.1 PostgreSQL ç¼“å­˜é…ç½®](#51-postgresql-ç¼“å­˜é…ç½®)
    - [5.2 åº”ç”¨å±‚ç¼“å­˜](#52-åº”ç”¨å±‚ç¼“å­˜)
    - [5.3 ç¼“å­˜ç­–ç•¥](#53-ç¼“å­˜ç­–ç•¥)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥](#61-æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥)
    - [6.2 å®é™…åº”ç”¨æ¡ˆä¾‹](#62-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹ 1: æŸæœç´¢å¹³å°æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#æ¡ˆä¾‹-1-æŸæœç´¢å¹³å°æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
      - [æ¡ˆä¾‹ 2: ç‰©æµç³»ç»ŸæŸ¥è¯¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#æ¡ˆä¾‹-2-ç‰©æµç³»ç»ŸæŸ¥è¯¢ä¼˜åŒ–çœŸå®æ¡ˆä¾‹)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 æŠ€æœ¯åšå®¢](#72-æŠ€æœ¯åšå®¢)
    - [7.3 ç›¸å…³èµ„æº](#73-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

å‘é‡æœç´¢æŸ¥è¯¢æ€§èƒ½é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **æŸ¥è¯¢å»¶è¿Ÿ**: éœ€è¦ < 50ms å“åº”æ—¶é—´
- **å¹¶å‘æŸ¥è¯¢**: éœ€è¦æ”¯æŒ 10K+ QPS
- **æŸ¥è¯¢ç²¾åº¦**: éœ€è¦ä¿è¯é«˜å¬å›ç‡
- **èµ„æºæ¶ˆè€—**: éœ€è¦æ§åˆ¶ CPU å’Œå†…å­˜ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:

æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ä»æŸ¥è¯¢è®¡åˆ’ã€ç´¢å¼•ã€å¹¶è¡ŒæŸ¥è¯¢ã€ç¼“å­˜ç­‰å¤šä¸ªç»´åº¦è¿›è¡Œä¼˜åŒ–ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **æ€§èƒ½æå‡**:
   - æŸ¥è¯¢å»¶è¿Ÿ: ä» 100ms é™ä½åˆ° 20msï¼Œ**æå‡ 80%**
   - æŸ¥è¯¢åå: æå‡ **5 å€**ï¼ˆå¹¶è¡ŒæŸ¥è¯¢+ç¼“å­˜ï¼‰
   - CPU ä½¿ç”¨: é™ä½ **40%**ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰

2. **ä¸šåŠ¡ä»·å€¼**:
   - ç”¨æˆ·ä½“éªŒ: å“åº”é€Ÿåº¦æå‡ **5 å€**
   - ç³»ç»Ÿå®¹é‡: æ”¯æŒæ›´å¤šå¹¶å‘ç”¨æˆ·
   - æˆæœ¬ä¼˜åŒ–: ç¡¬ä»¶æˆæœ¬é™ä½ **30%**

---

## 2. æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

### 2.1 æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–

**æŸ¥è¯¢è®¡åˆ’åˆ†æ**:

```sql
-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, content, embedding <=> $1 as distance
FROM documents
ORDER BY embedding <=> $1
LIMIT 10;

-- å…³é”®æŒ‡æ ‡åˆ†æ
-- Execution Time: åº”è¯¥ < 50ms
-- Planning Time: åº”è¯¥ < 10ms
-- Buffers: shared hit åº”è¯¥ > 90%
```

**æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆå¦‚æœä¼˜åŒ–å™¨é€‰æ‹©é”™è¯¯ï¼‰
SET enable_seqscan = off;
SET enable_indexscan = on;

-- 2. è°ƒæ•´æˆæœ¬å‚æ•°ï¼ˆå½±å“æŸ¥è¯¢è®¡åˆ’å™¨é€‰æ‹©ï¼‰
SET random_page_cost = 1.1;  -- SSD ç¯å¢ƒ
SET seq_page_cost = 1.0;
SET cpu_tuple_cost = 0.01;
SET cpu_index_tuple_cost = 0.005;

-- 3. æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸®åŠ©ä¼˜åŒ–å™¨åšå‡ºæ­£ç¡®å†³ç­–ï¼‰
ANALYZE documents;
```

**æŸ¥è¯¢è®¡åˆ’å…³é”®æŒ‡æ ‡**:

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| **Execution Time** | < 50ms | > 100ms | æ‰§è¡Œæ—¶é—´ |
| **Planning Time** | < 10ms | > 50ms | è®¡åˆ’æ—¶é—´ |
| **Buffers: shared hit** | > 90% | < 80% | ç¼“å­˜å‘½ä¸­ç‡ |
| **Buffers: shared read** | < 100 | > 1000 | ç£ç›˜è¯»å–æ¬¡æ•° |

### 2.2 è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–

**è¿‡æ»¤é¡ºåºä¼˜åŒ–**:

```sql
-- âŒ ä¸æ¨è: å…ˆæœç´¢åè¿‡æ»¤ï¼ˆæ…¢ï¼‰
SELECT id, content, embedding <=> $1 as distance
FROM documents
ORDER BY embedding <=> $1
LIMIT 1000
WHERE category = 'electronics';  -- è¿‡æ»¤åœ¨æ’åºå

-- âœ… æ¨è: å…ˆè¿‡æ»¤åæœç´¢ï¼ˆå¿«ï¼‰
SELECT id, content, embedding <=> $1 as distance
FROM documents
WHERE category = 'electronics'  -- å…ˆè¿‡æ»¤ï¼Œå‡å°‘å‘é‡è®¡ç®—é‡
ORDER BY embedding <=> $1
LIMIT 10;
```

**è¿‡æ»¤æ¡ä»¶æ€§èƒ½å¯¹æ¯”**:

| æŸ¥è¯¢æ–¹å¼ | æ‰§è¡Œæ—¶é—´ | å‘é‡è®¡ç®—æ¬¡æ•° | è¯´æ˜ |
|---------|---------|------------|------|
| **å…ˆæœç´¢åè¿‡æ»¤** | 500ms | 1000 æ¬¡ | éœ€è¦è®¡ç®— 1000 ä¸ªå‘é‡è·ç¦» |
| **å…ˆè¿‡æ»¤åæœç´¢** | 50ms | 100 æ¬¡ | åªè®¡ç®— 100 ä¸ªå‘é‡è·ç¦» |
| **æ€§èƒ½æå‡** | - | **90%** â¬‡ï¸ | å‡å°‘å‘é‡è®¡ç®—é‡ |

**å¤åˆè¿‡æ»¤ä¼˜åŒ–**:

```sql
-- åˆ›å»ºå¤åˆç´¢å¼•æ”¯æŒå¤šæ¡ä»¶è¿‡æ»¤
CREATE INDEX idx_documents_category_price
ON documents (category, price)
WHERE category IS NOT NULL;

-- ä¼˜åŒ–åçš„æŸ¥è¯¢
SELECT id, content, embedding <=> $1 as distance
FROM documents
WHERE category = 'electronics'
  AND price BETWEEN 100 AND 500
  AND status = 'active'
ORDER BY embedding <=> $1
LIMIT 10;

-- æŸ¥è¯¢è®¡åˆ’åº”è¯¥æ˜¾ç¤ºï¼š
-- Index Scan using idx_documents_category_price
-- Index Scan using documents_embedding_idx
```

### 2.3 æŸ¥è¯¢é‡å†™ä¼˜åŒ–

**æŸ¥è¯¢é‡å†™æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨ EXISTS ä»£æ›¿ INï¼ˆå¤§æ•°æ®é›†ï¼‰
-- âŒ ä¸æ¨è
SELECT * FROM documents
WHERE category IN (SELECT category FROM categories WHERE active = true);

-- âœ… æ¨è
SELECT * FROM documents d
WHERE EXISTS (
    SELECT 1 FROM categories c
    WHERE c.category = d.category AND c.active = true
);

-- 2. ä½¿ç”¨ JOIN ä»£æ›¿å­æŸ¥è¯¢
-- âŒ ä¸æ¨è
SELECT * FROM documents
WHERE category IN (SELECT category FROM categories);

-- âœ… æ¨è
SELECT d.* FROM documents d
INNER JOIN categories c ON d.category = c.category;

-- 3. é¿å… SELECT *ï¼Œåªé€‰æ‹©éœ€è¦çš„åˆ—
-- âŒ ä¸æ¨è
SELECT * FROM documents ORDER BY embedding <=> $1 LIMIT 10;

-- âœ… æ¨è
SELECT id, content, embedding <=> $1 as distance
FROM documents
ORDER BY embedding <=> $1
LIMIT 10;
```

---

## 3. ç´¢å¼•ä¼˜åŒ–

### 3.1 å¤åˆç´¢å¼•

```sql
-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX ON documents (category, price)
WHERE category IS NOT NULL;

-- å‘é‡ç´¢å¼•
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops);
```

---

## 4. å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–

### 4.1 å¹¶è¡ŒæŸ¥è¯¢é…ç½®

**å¹¶è¡ŒæŸ¥è¯¢å‚æ•°é…ç½®**:

```sql
-- å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;  -- æ¯ä¸ªæŸ¥è¯¢çš„æœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
SET max_parallel_workers = 16;  -- ç³»ç»Ÿæœ€å¤§å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
SET parallel_tuple_cost = 0.1;  -- å¹¶è¡Œå…ƒç»„ä¼ è¾“æˆæœ¬
SET parallel_setup_cost = 1000.0;  -- å¹¶è¡Œè®¾ç½®æˆæœ¬

-- é’ˆå¯¹ä¸åŒæœåŠ¡å™¨é…ç½®çš„å»ºè®®
-- å°å‹æœåŠ¡å™¨ï¼ˆ4 æ ¸ï¼‰
SET max_parallel_workers_per_gather = 2;
SET max_parallel_workers = 4;

-- ä¸­å‹æœåŠ¡å™¨ï¼ˆ16 æ ¸ï¼‰
SET max_parallel_workers_per_gather = 4;
SET max_parallel_workers = 16;

-- å¤§å‹æœåŠ¡å™¨ï¼ˆ64 æ ¸ï¼‰
SET max_parallel_workers_per_gather = 8;
SET max_parallel_workers = 32;
```

**å¹¶è¡ŒæŸ¥è¯¢æ€§èƒ½å¯¹æ¯”**:

| æ•°æ®é‡ | ä¸²è¡ŒæŸ¥è¯¢ | å¹¶è¡ŒæŸ¥è¯¢ (4 workers) | æ€§èƒ½æå‡ |
|--------|---------|---------------------|---------|
| **100 ä¸‡** | 200ms | 60ms | **3.3x** |
| **1000 ä¸‡** | 2000ms | 500ms | **4x** |
| **1 äº¿** | 20000ms | 4000ms | **5x** |

### 4.2 å¹¶è¡ŒæŸ¥è¯¢é€‚ç”¨åœºæ™¯

**é€‚ç”¨åœºæ™¯**:

1. **å¤§è¡¨æ‰«æ**: å…¨è¡¨æ‰«ææˆ–å¤§èŒƒå›´æ‰«æ
2. **èšåˆæŸ¥è¯¢**: GROUP BYã€COUNTã€SUM ç­‰èšåˆæ“ä½œ
3. **æ’åºæ“ä½œ**: ORDER BY å¤§ç»“æœé›†
4. **JOIN æ“ä½œ**: å¤§è¡¨ JOIN æ“ä½œ

**ä¸é€‚ç”¨åœºæ™¯**:

1. **å°è¡¨æŸ¥è¯¢**: æ•°æ®é‡å°ï¼Œå¹¶è¡Œå¼€é”€å¤§äºæ”¶ç›Š
2. **ç´¢å¼•æŸ¥è¯¢**: å·²ä½¿ç”¨ç´¢å¼•ï¼Œå¹¶è¡Œæ”¶ç›Šä¸æ˜æ˜¾
3. **ç®€å•æŸ¥è¯¢**: æŸ¥è¯¢æœ¬èº«å¾ˆå¿«ï¼Œä¸éœ€è¦å¹¶è¡Œ

**å¹¶è¡ŒæŸ¥è¯¢ç¤ºä¾‹**:

```sql
-- å¹¶è¡ŒèšåˆæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT category, COUNT(*), AVG(price)
FROM documents
WHERE created_at > '2025-01-01'
GROUP BY category;

-- æ‰§è¡Œè®¡åˆ’åº”è¯¥æ˜¾ç¤ºï¼š
-- Gather (workers: 4)
--   -> Parallel Seq Scan on documents
--   -> HashAggregate
--   -> GroupAggregate

-- å¹¶è¡Œæ’åºæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM documents
ORDER BY created_at DESC
LIMIT 1000;

-- æ‰§è¡Œè®¡åˆ’åº”è¯¥æ˜¾ç¤ºï¼š
-- Gather Merge (workers: 4)
--   -> Parallel Index Scan using documents_created_at_idx
```

---

## 5. ç¼“å­˜ä¼˜åŒ–

### 5.1 PostgreSQL ç¼“å­˜é…ç½®

**å…±äº«ç¼“å†²åŒºé…ç½®**:

```sql
-- å…±äº«ç¼“å†²åŒºé…ç½®ï¼ˆPostgreSQL ç¼“å­˜ï¼‰
-- å»ºè®®è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„ 25%

-- å°å‹æœåŠ¡å™¨ï¼ˆ8GB RAMï¼‰
ALTER SYSTEM SET shared_buffers = '2GB';

-- ä¸­å‹æœåŠ¡å™¨ï¼ˆ32GB RAMï¼‰
ALTER SYSTEM SET shared_buffers = '8GB';

-- å¤§å‹æœåŠ¡å™¨ï¼ˆ128GB RAMï¼‰
ALTER SYSTEM SET shared_buffers = '32GB';

-- æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆæ“ä½œç³»ç»Ÿ + PostgreSQL ç¼“å­˜ï¼‰
ALTER SYSTEM SET effective_cache_size = '24GB';  -- 75% of RAM
```

**ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§**:

```sql
-- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) as heap_read,
    sum(heap_blks_hit) as heap_hit,
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) * 100 as cache_hit_rate
FROM pg_statio_user_tables
WHERE schemaname = 'public';

-- ç›®æ ‡ï¼šç¼“å­˜å‘½ä¸­ç‡ > 95%
```

**ç¼“å­˜ä¼˜åŒ–æ•ˆæœ**:

| ç¼“å­˜é…ç½® | ç¼“å­˜å‘½ä¸­ç‡ | æŸ¥è¯¢å»¶è¿Ÿ | ç£ç›˜ I/O |
|---------|-----------|---------|---------|
| **shared_buffers = 1GB** | 60% | 100ms | é«˜ |
| **shared_buffers = 8GB** | 92% | 30ms | ä¸­ |
| **shared_buffers = 32GB** | 98% | 10ms | ä½ |

### 5.2 åº”ç”¨å±‚ç¼“å­˜

**æŸ¥è¯¢ç»“æœç¼“å­˜**:

```python
# Python æŸ¥è¯¢ç»“æœç¼“å­˜
from functools import lru_cache
import hashlib
import json

def vector_to_hash(vector):
    """å°†å‘é‡è½¬æ¢ä¸ºå“ˆå¸Œå€¼ï¼ˆç”¨äºç¼“å­˜é”®ï¼‰"""
    return hashlib.md5(json.dumps(vector).encode()).hexdigest()

@lru_cache(maxsize=10000)
def cached_vector_search(query_vector_hash, limit):
    """ç¼“å­˜å‘é‡æœç´¢ç»“æœ"""
    # å®é™…æŸ¥è¯¢é€»è¾‘
    return execute_vector_search(query_vector, limit)

# ä½¿ç”¨ç¤ºä¾‹
query_vector = [0.1, 0.2, 0.3, ...]
query_hash = vector_to_hash(query_vector)
results = cached_vector_search(query_hash, limit=10)
```

**Redis ç¼“å­˜é›†æˆ**:

```python
# ä½¿ç”¨ Redis ç¼“å­˜æŸ¥è¯¢ç»“æœ
import redis
import json
import hashlib

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cached_vector_search_redis(query_vector, limit=10, ttl=3600):
    """ä½¿ç”¨ Redis ç¼“å­˜å‘é‡æœç´¢ç»“æœ"""
    # ç”Ÿæˆç¼“å­˜é”®
    query_hash = hashlib.md5(json.dumps(query_vector).encode()).hexdigest()
    cache_key = f"vector_search:{query_hash}:{limit}"

    # å°è¯•ä»ç¼“å­˜è·å–
    cached_result = redis_client.get(cache_key)
    if cached_result:
        return json.loads(cached_result)

    # æ‰§è¡ŒæŸ¥è¯¢
    results = execute_vector_search(query_vector, limit)

    # å†™å…¥ç¼“å­˜
    redis_client.setex(
        cache_key,
        ttl,
        json.dumps(results)
    )

    return results
```

**ç¼“å­˜æ€§èƒ½å¯¹æ¯”**:

| ç¼“å­˜æ–¹å¼ | æŸ¥è¯¢å»¶è¿Ÿ | ç¼“å­˜å‘½ä¸­ç‡ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------|---------|
| **æ— ç¼“å­˜** | 50ms | 0% | åŸºå‡† |
| **PostgreSQL ç¼“å­˜** | 10ms | 95% | æ•°æ®åº“å±‚ç¼“å­˜ |
| **åº”ç”¨å±‚ç¼“å­˜** | 1ms | 80% | çƒ­ç‚¹æŸ¥è¯¢ |
| **Redis ç¼“å­˜** | 2ms | 85% | åˆ†å¸ƒå¼ç¼“å­˜ |

### 5.3 ç¼“å­˜ç­–ç•¥

**ç¼“å­˜ç­–ç•¥é€‰æ‹©**:

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **LRU ç¼“å­˜** | çƒ­ç‚¹æŸ¥è¯¢ | ç®€å•ã€é«˜æ•ˆ | å†…å­˜é™åˆ¶ |
| **TTL ç¼“å­˜** | æ—¶æ•ˆæ€§è¦æ±‚ | è‡ªåŠ¨è¿‡æœŸ | å¯èƒ½ç¼“å­˜è¿‡æœŸæ•°æ® |
| **å†™æ—¶å¤±æ•ˆ** | æ•°æ®æ›´æ–°é¢‘ç¹ | æ•°æ®ä¸€è‡´æ€§å¥½ | å®ç°å¤æ‚ |
| **åˆ†å±‚ç¼“å­˜** | å¤§è§„æ¨¡ç³»ç»Ÿ | æ€§èƒ½æœ€ä¼˜ | ç»´æŠ¤å¤æ‚ |

---

## 6. æœ€ä½³å®è·µ

### 6.1 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

**æŸ¥è¯¢ä¼˜åŒ–ä¼˜å…ˆçº§**:

1. **ç´¢å¼•ä½¿ç”¨**: ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨ç´¢å¼•
2. **è¿‡æ»¤ä¼˜åŒ–**: å…ˆè¿‡æ»¤åæœç´¢ï¼Œå‡å°‘å‘é‡è®¡ç®—é‡
3. **å¹¶è¡ŒæŸ¥è¯¢**: å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢æå‡æ€§èƒ½
4. **ç»“æœç¼“å­˜**: ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœ

**æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- âŒ ä¸æ¨è: å…ˆæœç´¢åè¿‡æ»¤
SELECT id, content, embedding <=> $1 as distance
FROM documents
ORDER BY embedding <=> $1
LIMIT 1000
WHERE category = 'electronics';  -- è¿‡æ»¤åœ¨æ’åºå

-- âœ… æ¨è: å…ˆè¿‡æ»¤åæœç´¢
SELECT id, content, embedding <=> $1 as distance
FROM documents
WHERE category = 'electronics'  -- å…ˆè¿‡æ»¤
ORDER BY embedding <=> $1
LIMIT 10;
```

### 6.2 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1: æŸæœç´¢å¹³å°æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**ä¸šåŠ¡åœºæ™¯**:

- æ•°æ®é‡: 1 äº¿æ¡
- æŸ¥è¯¢ QPS: 5000
- å¹³å‡æŸ¥è¯¢å»¶è¿Ÿ: 100ms

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. **æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–**: ä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼Œä¼˜åŒ–ç´¢å¼•ä½¿ç”¨
2. **è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–**: å…ˆè¿‡æ»¤åæœç´¢ï¼Œå‡å°‘å‘é‡è®¡ç®—é‡
3. **å¹¶è¡ŒæŸ¥è¯¢**: å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼Œæå‡èšåˆæŸ¥è¯¢æ€§èƒ½
4. **ç¼“å­˜ä¼˜åŒ–**: ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœ

**å®æ–½æ•ˆæœ**:

- æŸ¥è¯¢å»¶è¿Ÿ: ä» 100ms é™ä½åˆ° 20msï¼ˆ**æå‡ 80%**ï¼‰
- æŸ¥è¯¢åå: æå‡ **5 å€**ï¼ˆä» 1000 QPS åˆ° 5000 QPSï¼‰
- CPU ä½¿ç”¨: é™ä½ **40%**ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰
- ç”¨æˆ·ä½“éªŒ: å“åº”é€Ÿåº¦æå‡ **5 å€**

#### æ¡ˆä¾‹ 2: ç‰©æµç³»ç»ŸæŸ¥è¯¢ä¼˜åŒ–ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸç‰©æµç³»ç»Ÿéœ€è¦é¢‘ç¹æŸ¥è¯¢è®¢å•çŠ¶æ€å’Œä½ç½®ä¿¡æ¯ï¼ŒæŸäº›æŸ¥è¯¢é¢‘ç¹æ‰§è¡Œä½†ç¼ºå°‘ç´¢å¼•ï¼Œå¯¼è‡´æŸ¥è¯¢æ€§èƒ½å·®ã€‚

**é—®é¢˜åˆ†æ**:

```sql
-- é—®é¢˜æŸ¥è¯¢ï¼šé¢‘ç¹æ‰§è¡Œä½†ç¼ºå°‘ç´¢å¼•
SELECT
    order_id,
    status,
    location,
    created_at
FROM orders
WHERE status = 'in_transit'
  AND created_at > NOW() - INTERVAL '7 days'
ORDER BY created_at DESC
LIMIT 100;

-- æ‰§è¡Œè®¡åˆ’åˆ†æ
EXPLAIN ANALYZE ...
-- Seq Scan on orders (cost=0.00..123456.78 rows=...)
-- Execution Time: 5000.123 ms
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_orders_status_created_at
ON orders (status, created_at DESC)
WHERE status = 'in_transit';

-- 2. ä¼˜åŒ–åçš„æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE ...
-- Index Scan using idx_orders_status_created_at
-- Execution Time: 50.123 ms
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æŸ¥è¯¢å»¶è¿Ÿ** | 5000ms | 50ms | **99%** â¬‡ï¸ |
| **ç´¢å¼•ä½¿ç”¨** | Seq Scan | Index Scan | **ä¼˜åŒ–** |
| **CPU ä½¿ç”¨** | 90% | 20% | **78%** â¬‡ï¸ |

**ç»éªŒæ€»ç»“**:

1. **åˆ†ææŸ¥è¯¢æ—¥å¿—**: ä½¿ç”¨ `pg_stat_statements` è¯†åˆ«æ…¢æŸ¥è¯¢
2. **åˆ›å»ºåˆé€‚ç´¢å¼•**: æ ¹æ®æŸ¥è¯¢æ¨¡å¼åˆ›å»ºå¤åˆç´¢å¼•
3. **å®šæœŸç»´æŠ¤**: å®šæœŸ ANALYZE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](https://www.postgresql.org/docs/current/performance-tips.html)**
  - ç‰ˆæœ¬: PostgreSQL æ‰€æœ‰ç‰ˆæœ¬
  - å†…å®¹: PostgreSQL æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–çš„å®Œæ•´æŒ‡å—
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL æŸ¥è¯¢è§„åˆ’å™¨æ–‡æ¡£](https://www.postgresql.org/docs/current/query-optimizer.html)**
  - å†…å®¹: PostgreSQL æŸ¥è¯¢è§„åˆ’å™¨çš„è¯¦ç»†è¯´æ˜

- **[pgvector æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](https://github.com/pgvector/pgvector#performance)**
  - ç‰ˆæœ¬: pgvector 0.7.0+
  - å†…å®¹: pgvector æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µ

### 7.2 æŠ€æœ¯åšå®¢

- **[HNSW æ€§èƒ½ä¼˜åŒ–](./HNSWæ€§èƒ½ä¼˜åŒ–.md)**
  - å†…å®¹: HNSW ç´¢å¼•æ€§èƒ½ä¼˜åŒ–çš„è¯¦ç»†æŒ‡å—

- **[æ€§èƒ½è°ƒä¼˜æŠ€å·§](../æœ€ä½³å®è·µ/æ€§èƒ½è°ƒä¼˜æŠ€å·§.md)**
  - å†…å®¹: å‘é‡æ•°æ®åº“æ€§èƒ½è°ƒä¼˜çš„å®ç”¨æŠ€å·§

### 7.3 ç›¸å…³èµ„æº

- **[PostgreSQL EXPLAIN æ–‡æ¡£](https://www.postgresql.org/docs/current/sql-explain.html)**
  - å†…å®¹: PostgreSQL EXPLAIN å‘½ä»¤çš„è¯¦ç»†è¯´æ˜

- **[PostgreSQL ç´¢å¼•æ–‡æ¡£](https://www.postgresql.org/docs/current/indexes.html)**
  - å†…å®¹: PostgreSQL ç´¢å¼•çš„å®Œæ•´æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
