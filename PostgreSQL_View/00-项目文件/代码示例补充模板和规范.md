# ä»£ç ç¤ºä¾‹è¡¥å……æ¨¡æ¿å’Œè§„èŒƒ

> **åˆ›å»ºæ—¶é—´**: 2025 å¹´ 1 æœˆ
> **æ¨¡æ¿ç‰ˆæœ¬**: v1.0
> **é€‚ç”¨èŒƒå›´**: æ‰€æœ‰æ¡ˆä¾‹æ–‡æ¡£

---

## ğŸ“‹ ä»£ç ç¤ºä¾‹æ ‡å‡†ç»“æ„

æ¯ä¸ªæ¡ˆä¾‹æ–‡æ¡£çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†åº”éµå¾ªä»¥ä¸‹æ ‡å‡†ç»“æ„ï¼š

```markdown
## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ ¸å¿ƒæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨æ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS postgis;  -- å¦‚éœ€è¦

-- åˆ›å»ºæ ¸å¿ƒè¡¨
CREATE TABLE ...
```

### 8.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

**Pythonæ ¸å¿ƒåŠŸèƒ½**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class CoreFunction:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ ¸å¿ƒåŠŸèƒ½ç±»"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def core_method(self, ...):
        """æ ¸å¿ƒæ–¹æ³•å®ç°"""
        # å®ç°ä»£ç 
        pass

# ä½¿ç”¨ç¤ºä¾‹
function = CoreFunction("host=localhost dbname=testdb user=postgres password=secret")
result = function.core_method(...)
```

### 8.3 é«˜çº§åŠŸèƒ½å®ç°ï¼ˆå¯é€‰ï¼‰

**Pythoné«˜çº§åŠŸèƒ½**ï¼š

```python
# é«˜çº§åŠŸèƒ½å®ç°
```

### 8.4 ä½¿ç”¨ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰

**å®Œæ•´ä½¿ç”¨æµç¨‹**ï¼š

```python
# å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
```

```

---

## ğŸ“ ä»£ç ç¤ºä¾‹è¦æ±‚

### 1. SQLä»£ç è¦æ±‚

- âœ… **å®Œæ•´æ€§**: åŒ…å«å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰
- âœ… **æ‰©å±•å¯ç”¨**: æ˜ç¡®å¯ç”¨æ‰€éœ€çš„æ‰©å±•
- âœ… **ç´¢å¼•åˆ›å»º**: åŒ…å«å¿…è¦çš„ç´¢å¼•åˆ›å»ºè¯­å¥
- âœ… **æ³¨é‡Š**: å…³é”®SQLè¯­å¥æœ‰ä¸­æ–‡æ³¨é‡Š
- âœ… **æœ€ä½³å®è·µ**: ä½“ç°PostgreSQLæœ€ä½³å®è·µ

### 2. Pythonä»£ç è¦æ±‚

- âœ… **å¯¼å…¥è¯­å¥**: åŒ…å«æ‰€æœ‰å¿…è¦çš„å¯¼å…¥
- âœ… **ç±»ç»“æ„**: ä½¿ç”¨é¢å‘å¯¹è±¡è®¾è®¡
- âœ… **é”™è¯¯å¤„ç†**: åŒ…å«åŸºæœ¬çš„é”™è¯¯å¤„ç†
- âœ… **ç±»å‹æç¤º**: ä½¿ç”¨ç±»å‹æç¤ºï¼ˆtypingï¼‰
- âœ… **æ³¨é‡Š**: å…³é”®ä»£ç æœ‰ä¸­æ–‡æ³¨é‡Š
- âœ… **ä½¿ç”¨ç¤ºä¾‹**: åŒ…å«å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹

### 3. ä»£ç è´¨é‡è¦æ±‚

- âœ… **å¯è¿è¡Œ**: ä»£ç åº”è¯¥å¯ä»¥ç›´æ¥è¿è¡Œï¼ˆéœ€è¦é€‚å½“çš„ç¯å¢ƒé…ç½®ï¼‰
- âœ… **ä¸€è‡´æ€§**: ä»£ç ç¤ºä¾‹ä¸æ–‡æ¡£æè¿°çš„æŠ€æœ¯æ–¹æ¡ˆä¸€è‡´
- âœ… **æœ€ä½³å®è·µ**: ä½“ç°PostgreSQLã€TimescaleDBã€pgvectorç­‰çš„æœ€ä½³å®è·µ
- âœ… **æ³¨é‡Šè¯´æ˜**: å…³é”®ä»£ç è¦æœ‰ä¸­æ–‡æ³¨é‡Šï¼Œä¾¿äºç†è§£

---

## ğŸ¯ ä¸åŒåœºæ™¯çš„ä»£ç ç¤ºä¾‹æ¨¡æ¿

### æ¨¡æ¿1ï¼šæ¨èç³»ç»Ÿç±»

**æŠ€æœ¯æ ˆ**: pgvector, PostgreSQL

```markdown
### 8.1 æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºæ¨èç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºå†…å®¹è¡¨
CREATE TABLE contents (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    content_vector vector(1536),
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    preference_vector vector(1536),
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX idx_contents_vector ON contents USING hnsw (content_vector vector_cosine_ops);
CREATE INDEX idx_users_preference_vector ON users USING hnsw (preference_vector vector_cosine_ops);
```

### 8.2 æ¨èç®—æ³•å®ç°

**Pythonæ¨èç®—æ³•**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import List, Dict

class Recommender:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ¨èå™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def recommend(self, user_id: int, limit: int = 10) -> List[Dict]:
        """æ¨èå†…å®¹"""
        # è·å–ç”¨æˆ·åå¥½å‘é‡
        self.cur.execute("""
            SELECT preference_vector
            FROM users
            WHERE id = %s
        """, (user_id,))

        result = self.cur.fetchone()
        if not result or not result[0]:
            return []

        preference_vector = result[0]

        # æŸ¥æ‰¾ç›¸ä¼¼å†…å®¹
        self.cur.execute("""
            SELECT
                id,
                title,
                description,
                1 - (content_vector <=> %s) AS similarity
            FROM contents
            ORDER BY content_vector <=> %s
            LIMIT %s
        """, (preference_vector, preference_vector, limit))

        recommendations = []
        for row in self.cur.fetchall():
            recommendations.append({
                'id': row[0],
                'title': row[1],
                'description': row[2],
                'similarity': float(row[3])
            })

        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
recommender = Recommender("host=localhost dbname=testdb user=postgres password=secret")
recommendations = recommender.recommend(user_id=1, limit=10)
for rec in recommendations:
    print(f"{rec['title']}: similarity={rec['similarity']:.4f}")
```

```

### æ¨¡æ¿2ï¼šç›‘æ§ç³»ç»Ÿç±»

**æŠ€æœ¯æ ˆ**: TimescaleDB, pgvector

```markdown
### 8.1 æ—¶åºæ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºç›‘æ§æ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBå’Œpgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºç›‘æ§æŒ‡æ ‡è¡¨
CREATE TABLE monitor_metrics (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,
    metric_name TEXT NOT NULL,
    value DOUBLE PRECISION,
    tags JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è½¬æ¢ä¸ºè¶…è¡¨
SELECT create_hypertable('monitor_metrics', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_monitor_metrics_device_time ON monitor_metrics (device_id, time DESC);
```

### 8.2 æ•°æ®é‡‡é›†å®ç°

**Pythonæ•°æ®é‡‡é›†**ï¼š

```python
import psycopg2
from psycopg2.extras import execute_values
from datetime import datetime
from typing import List, Dict
import json

class MonitorDataCollector:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç›‘æ§æ•°æ®é‡‡é›†å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def insert_metrics(self, device_id: str, metrics: List[Dict]):
        """æ‰¹é‡æ’å…¥ç›‘æ§æŒ‡æ ‡"""
        values = [
            (
                metric['timestamp'],
                device_id,
                metric['metric_name'],
                metric['value'],
                json.dumps(metric.get('tags', {}))
            )
            for metric in metrics
        ]

        execute_values(
            self.cur,
            """
            INSERT INTO monitor_metrics
            (time, device_id, metric_name, value, tags)
            VALUES %s
            """,
            values
        )

        self.conn.commit()

# ä½¿ç”¨ç¤ºä¾‹
collector = MonitorDataCollector("host=localhost dbname=testdb user=postgres password=secret")
metrics = [
    {
        'timestamp': datetime.now(),
        'metric_name': 'temperature',
        'value': 25.5,
        'tags': {'unit': 'celsius'}
    }
]
collector.insert_metrics('device_001', metrics)
```

### 8.3 å¼‚å¸¸æ£€æµ‹å®ç°

**Pythonå¼‚å¸¸æ£€æµ‹**ï¼š

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import numpy as np
from typing import Dict

class AnomalyDetector:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å¼‚å¸¸æ£€æµ‹å™¨"""
        self.conn = psycopg2.connect(conn_str)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def detect_anomaly(self, device_id: str, time_window: str = '1 hour') -> Dict:
        """æ£€æµ‹å¼‚å¸¸"""
        # è·å–å½“å‰æŒ‡æ ‡
        self.cur.execute("""
            SELECT AVG(value) as avg_value, STDDEV(value) as std_value
            FROM monitor_metrics
            WHERE device_id = %s
              AND time > NOW() - INTERVAL %s
        """, (device_id, time_window))

        result = self.cur.fetchone()
        if not result:
            return {'is_anomaly': False}

        avg_value = result[0] or 0
        std_value = result[1] or 0

        # ç®€å•çš„å¼‚å¸¸æ£€æµ‹ï¼ˆ3-sigmaè§„åˆ™ï¼‰
        threshold = avg_value + 3 * std_value
        is_anomaly = avg_value > threshold

        return {
            'is_anomaly': is_anomaly,
            'avg_value': avg_value,
            'std_value': std_value,
            'threshold': threshold
        }

# ä½¿ç”¨ç¤ºä¾‹
detector = AnomalyDetector("host=localhost dbname=testdb user=postgres password=secret")
result = detector.detect_anomaly('device_001', time_window='1 hour')
if result['is_anomaly']:
    print(f"Anomaly detected! Avg: {result['avg_value']:.2f}, Threshold: {result['threshold']:.2f}")
```

```

### æ¨¡æ¿3ï¼šç©ºé—´æ•°æ®ç±»

**æŠ€æœ¯æ ˆ**: PostGIS, pgvector

```markdown
### 8.1 ç©ºé—´æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºç©ºé—´æ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨PostGISå’Œpgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºç©ºé—´å¯¹è±¡è¡¨
CREATE TABLE spatial_objects (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    location GEOMETRY(POINT, 4326),
    properties JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç©ºé—´ç´¢å¼•
CREATE INDEX idx_spatial_objects_location ON spatial_objects USING GIST (location);
```

### 8.2 ç©ºé—´æŸ¥è¯¢å®ç°

**Pythonç©ºé—´æŸ¥è¯¢**ï¼š

```python
import psycopg2
from typing import List, Dict, Tuple

class SpatialQuery:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–ç©ºé—´æŸ¥è¯¢å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def find_nearby(self, center_lat: float, center_lon: float,
                    radius_meters: float, limit: int = 10) -> List[Dict]:
        """æŸ¥æ‰¾é™„è¿‘çš„å¯¹è±¡"""
        self.cur.execute("""
            SELECT
                id,
                name,
                properties,
                ST_Distance(
                    location::geography,
                    ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography
                ) AS distance
            FROM spatial_objects
            WHERE ST_DWithin(
                location::geography,
                ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography,
                %s
            )
            ORDER BY distance
            LIMIT %s
        """, (center_lon, center_lat, center_lon, center_lat, radius_meters, limit))

        results = []
        for row in self.cur.fetchall():
            results.append({
                'id': row[0],
                'name': row[1],
                'properties': row[2],
                'distance': row[3]
            })

        return results

# ä½¿ç”¨ç¤ºä¾‹
spatial_query = SpatialQuery("host=localhost dbname=testdb user=postgres password=secret")
nearby = spatial_query.find_nearby(39.9093, 116.3974, radius_meters=1000, limit=10)
for obj in nearby:
    print(f"{obj['name']}: {obj['distance']:.2f}m")
```

```

---

## âœ… è´¨é‡æ£€æŸ¥æ¸…å•

æ¯ä¸ªæ–‡æ¡£è¡¥å……å®Œæˆåï¼Œéœ€è¦æ£€æŸ¥ï¼š

- [ ] ä»£ç ç¤ºä¾‹éƒ¨åˆ†å·²æ·»åŠ ï¼ˆ## 8. å®Œæ•´ä»£ç ç¤ºä¾‹ï¼‰
- [ ] SQLä»£ç å®Œæ•´ä¸”å¯è¿è¡Œ
- [ ] Pythonä»£ç å®Œæ•´ä¸”å¯è¿è¡Œ
- [ ] åŒ…å«æ•°æ®è¡¨åˆ›å»ºç¤ºä¾‹
- [ ] åŒ…å«æ ¸å¿ƒåŠŸèƒ½å®ç°ç¤ºä¾‹
- [ ] åŒ…å«ä½¿ç”¨ç¤ºä¾‹
- [ ] ä»£ç æœ‰é€‚å½“çš„ä¸­æ–‡æ³¨é‡Š
- [ ] ä»£ç ç¬¦åˆPostgreSQLæœ€ä½³å®è·µ
- [ ] ä»£ç ç¤ºä¾‹ä¸æ–‡æ¡£å†…å®¹ä¸€è‡´
- [ ] å¯¼å…¥è¯­å¥å®Œæ•´
- [ ] ç±»å‹æç¤ºæ­£ç¡®
- [ ] é”™è¯¯å¤„ç†é€‚å½“

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä»£ç ä¸€è‡´æ€§**: ç¡®ä¿ä»£ç ç¤ºä¾‹ä¸æ–‡æ¡£æè¿°çš„æŠ€æœ¯æ–¹æ¡ˆä¸€è‡´
2. **å¯è¿è¡Œæ€§**: ä»£ç åº”è¯¥å¯ä»¥ç›´æ¥è¿è¡Œï¼ˆéœ€è¦é€‚å½“çš„ç¯å¢ƒé…ç½®ï¼‰
3. **æœ€ä½³å®è·µ**: ä½“ç°PostgreSQLã€TimescaleDBã€pgvectorç­‰çš„æœ€ä½³å®è·µ
4. **æ³¨é‡Šè¯´æ˜**: å…³é”®ä»£ç è¦æœ‰ä¸­æ–‡æ³¨é‡Šï¼Œä¾¿äºç†è§£
5. **ç¤ºä¾‹å®Œæ•´**: åŒ…å«å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ä»£ç 
6. **ç¯å¢ƒé…ç½®**: åœ¨ä»£ç æ³¨é‡Šä¸­è¯´æ˜æ‰€éœ€çš„ç¯å¢ƒé…ç½®ï¼ˆå¦‚æ‰©å±•å®‰è£…ï¼‰

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 00-é¡¹ç›®æ–‡ä»¶-ä»£ç ç¤ºä¾‹æ¨¡æ¿è§„èŒƒ-001
