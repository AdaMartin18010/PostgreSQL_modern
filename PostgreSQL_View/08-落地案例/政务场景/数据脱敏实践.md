# æ”¿åŠ¡æ•°æ®è„±æ•å®è·µ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 08-05-03

## ğŸ“‘ ç›®å½•

- [æ”¿åŠ¡æ•°æ®è„±æ•å®è·µ](#æ”¿åŠ¡æ•°æ®è„±æ•å®è·µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. è„±æ•ç­–ç•¥](#2-è„±æ•ç­–ç•¥)
    - [2.1 æ•°æ®è„±æ•ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ•°æ®è„±æ•ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 é™æ€è„±æ•](#22-é™æ€è„±æ•)
    - [2.3 åŠ¨æ€è„±æ•](#23-åŠ¨æ€è„±æ•)
    - [2.4 æ ¼å¼ä¿ç•™è„±æ•](#24-æ ¼å¼ä¿ç•™è„±æ•)
  - [3. å®ç°æ–¹æ¡ˆ](#3-å®ç°æ–¹æ¡ˆ)
    - [3.1 å‡½æ•°å¼è„±æ•](#31-å‡½æ•°å¼è„±æ•)
    - [3.2 è§†å›¾è„±æ•](#32-è§†å›¾è„±æ•)
    - [3.3 è§¦å‘å™¨è„±æ•](#33-è§¦å‘å™¨è„±æ•)
  - [4. å®è·µæ¡ˆä¾‹](#4-å®è·µæ¡ˆä¾‹)
    - [4.1 ç¤¾ä¿æ•°æ®è„±æ•](#41-ç¤¾ä¿æ•°æ®è„±æ•)
    - [4.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#42-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 è„±æ•ç­–ç•¥é€‰æ‹©](#51-è„±æ•ç­–ç•¥é€‰æ‹©)
    - [5.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#52-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [5.3 å®‰å…¨å»ºè®®](#53-å®‰å…¨å»ºè®®)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
  - [7. å®Œæ•´ä»£ç ç¤ºä¾‹](#7-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [7.1 åŠ¨æ€è„±æ•å‡½æ•°åˆ›å»º](#71-åŠ¨æ€è„±æ•å‡½æ•°åˆ›å»º)
    - [7.2 è„±æ•è§†å›¾åˆ›å»º](#72-è„±æ•è§†å›¾åˆ›å»º)
    - [7.3 åŠ¨æ€è„±æ•å®ç°](#73-åŠ¨æ€è„±æ•å®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ”¿åŠ¡æ•°æ®è„±æ•éœ€è¦ï¼š

- **éšç§ä¿æŠ¤**: ä¿æŠ¤å…¬æ°‘éšç§ä¿¡æ¯
- **åˆè§„è¦æ±‚**: æ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„
- **æ•°æ®å¯ç”¨æ€§**: ä¿æŒæ•°æ®å¯ç”¨æ€§
- **æ€§èƒ½è¦æ±‚**: è„±æ•ä¸å½±å“æŸ¥è¯¢æ€§èƒ½

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **é™æ€è„±æ•**: æ•°æ®å¯¼å‡ºæ—¶è„±æ•
- **åŠ¨æ€è„±æ•**: æŸ¥è¯¢æ—¶å®æ—¶è„±æ•
- **æ ¼å¼ä¿ç•™**: ä¿æŒæ•°æ®æ ¼å¼

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **éšç§ä¿æŠ¤** | 100% ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ | **é›¶æ³„éœ²** |
| **åˆè§„æ€§** | æ»¡è¶³ GDPRã€ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ç­‰ | **100%** |
| **æ€§èƒ½å½±å“** | è„±æ•å¯¹æ€§èƒ½çš„å½±å“ | **<5%** |
| **å¼€å‘æ•ˆç‡** | ç®€åŒ–è„±æ•å®ç° | **æå‡ 80%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **éšç§ä¿æŠ¤**: 100% ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼Œé›¶æ•°æ®æ³„éœ²
- **åˆè§„æ€§**: æ»¡è¶³ GDPRã€ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ç­‰æ³•è§„è¦æ±‚
- **æ€§èƒ½å½±å“**: è„±æ•å¯¹æ€§èƒ½å½±å“ <5%ï¼Œå‡ ä¹æ— æ„ŸçŸ¥
- **å¼€å‘æ•ˆç‡**: ç®€åŒ–è„±æ•å®ç°ï¼Œæå‡ 80% å¼€å‘æ•ˆç‡
- **çµæ´»æ€§**: æ”¯æŒé™æ€å’ŒåŠ¨æ€è„±æ•ï¼Œé€‚åº”ä¸åŒåœºæ™¯

## 2. è„±æ•ç­–ç•¥

### 2.1 æ•°æ®è„±æ•ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®è„±æ•))
    æ•°æ®å±‚
      æ•æ„Ÿæ•°æ®
        ä¸ªäººä¿¡æ¯
        èº«ä»½è¯å·
        æ‰‹æœºå·
        é“¶è¡Œå¡å·
        åœ°å€ä¿¡æ¯
      è„±æ•è§„åˆ™
        è„±æ•ç±»å‹
        è„±æ•æ¨¡å¼
        è„±æ•ç­–ç•¥
        è§’è‰²æƒé™
      å®¡è®¡æ•°æ®
        è„±æ•è®°å½•
        è®¿é—®è®°å½•
        åˆè§„è®°å½•
    å­˜å‚¨å±‚
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        æ•°æ®å­˜å‚¨
        è„±æ•å‡½æ•°
        è„±æ•è§†å›¾
      ç¼“å­˜å±‚
        Redis
        è„±æ•ç¼“å­˜
        è§„åˆ™ç¼“å­˜
    å¤„ç†å±‚
      è„±æ•å¤„ç†
        é™æ€è„±æ•
        åŠ¨æ€è„±æ•
        æ ¼å¼ä¿ç•™
        è§’è‰²æ§åˆ¶
      è§„åˆ™ç®¡ç†
        è§„åˆ™é…ç½®
        è§„åˆ™éªŒè¯
        è§„åˆ™æ›´æ–°
        è§„åˆ™å®¡è®¡
      å®¡è®¡ç®¡ç†
        è„±æ•å®¡è®¡
        è®¿é—®å®¡è®¡
        åˆè§„æ£€æŸ¥
        å®¡è®¡åˆ†æ
    åº”ç”¨å±‚
      é™æ€è„±æ•
        æ•°æ®å¯¼å‡º
        æ•°æ®å¤‡ä»½
        æ•°æ®è¿ç§»
        æ‰¹é‡è„±æ•
      åŠ¨æ€è„±æ•
        æŸ¥è¯¢è„±æ•
        å®æ—¶è„±æ•
        è§’è‰²è„±æ•
        é€æ˜è„±æ•
      è„±æ•ç®¡ç†
        è§„åˆ™ç®¡ç†
        ç­–ç•¥ç®¡ç†
        å®¡è®¡ç®¡ç†
        åˆè§„ç®¡ç†
    åº”ç”¨åœºæ™¯
      æ”¿åŠ¡æœåŠ¡
        æ•°æ®è„±æ•
        éšç§ä¿æŠ¤
        åˆè§„ç®¡ç†
      é‡‘èè¡Œä¸š
        æ•°æ®è„±æ•
        éšç§ä¿æŠ¤
        åˆè§„å®¡è®¡
      åŒ»ç–—è¡Œä¸š
        æ•°æ®è„±æ•
        éšç§ä¿æŠ¤
        åˆè§„ç®¡ç†
```

### 2.2 é™æ€è„±æ•

```sql
-- é™æ€è„±æ•ï¼šå¯¼å‡ºæ•°æ®æ—¶è„±æ•
CREATE OR REPLACE FUNCTION static_mask(data TEXT, mask_type TEXT)
RETURNS TEXT AS $$
BEGIN
    CASE mask_type
        WHEN 'phone' THEN
            RETURN regexp_replace(data, '(\d{3})\d{4}(\d{4})', '\1****\2');
        WHEN 'id_card' THEN
            RETURN regexp_replace(data, '(\d{6})\d{8}(\d{4})', '\1********\2');
        WHEN 'name' THEN
            RETURN LEFT(data, 1) || '**';
        WHEN 'email' THEN
            RETURN regexp_replace(data, '(.{2}).*(@.*)', '\1***\2');
        ELSE
            RETURN '***';
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- å¯¼å‡ºè„±æ•æ•°æ®
COPY (
    SELECT
        id,
        static_mask(name, 'name') AS name,
        static_mask(phone, 'phone') AS phone,
        static_mask(id_card, 'id_card') AS id_card
    FROM citizen_data
) TO '/tmp/masked_data.csv' WITH CSV HEADER;
```

### 2.3 åŠ¨æ€è„±æ•

```sql
-- åŠ¨æ€è„±æ•ï¼šæŸ¥è¯¢æ—¶å®æ—¶è„±æ•
CREATE OR REPLACE FUNCTION dynamic_mask(
    data TEXT,
    user_role TEXT,
    mask_type TEXT
)
RETURNS TEXT AS $$
BEGIN
    -- æ ¹æ®ç”¨æˆ·è§’è‰²å†³å®šè„±æ•ç¨‹åº¦
    IF user_role = 'admin' THEN
        RETURN data;  -- ç®¡ç†å‘˜ä¸è„±æ•
    ELSIF user_role = 'analyst' THEN
        -- åˆ†æå¸ˆéƒ¨åˆ†è„±æ•
        CASE mask_type
            WHEN 'phone' THEN
                RETURN regexp_replace(data, '(\d{3})\d{4}(\d{4})', '\1****\2');
            ELSE
                RETURN data;
        END CASE;
    ELSE
        -- æ™®é€šç”¨æˆ·å®Œå…¨è„±æ•
        CASE mask_type
            WHEN 'phone' THEN
                RETURN '***-****-****';
            WHEN 'id_card' THEN
                RETURN '********-****-****';
            WHEN 'name' THEN
                RETURN '***';
            ELSE
                RETURN '***';
        END CASE;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨åŠ¨æ€è„±æ•æŸ¥è¯¢
SELECT
    id,
    dynamic_mask(name, current_user_role(), 'name') AS name,
    dynamic_mask(phone, current_user_role(), 'phone') AS phone
FROM citizen_data;
```

### 2.4 æ ¼å¼ä¿ç•™è„±æ•

```sql
-- æ ¼å¼ä¿ç•™è„±æ•ï¼šä¿æŒæ•°æ®æ ¼å¼
CREATE OR REPLACE FUNCTION format_preserving_mask(
    data TEXT,
    mask_type TEXT
)
RETURNS TEXT AS $$
DECLARE
    masked_data TEXT;
BEGIN
    CASE mask_type
        WHEN 'phone' THEN
            -- ä¿æŒç”µè¯å·ç æ ¼å¼ï¼š138-1234-5678 -> 138-****-5678
            masked_data := regexp_replace(data, '(\d{3})-(\d{4})-(\d{4})', '\1-****-\3');
        WHEN 'id_card' THEN
            -- ä¿æŒèº«ä»½è¯æ ¼å¼ï¼š110101199001011234 -> 110101********1234
            masked_data := regexp_replace(data, '(\d{6})(\d{8})(\d{4})', '\1********\3');
        WHEN 'bank_card' THEN
            -- ä¿æŒé“¶è¡Œå¡æ ¼å¼ï¼š6222 1234 5678 9012 -> 6222 **** **** 9012
            masked_data := regexp_replace(data, '(\d{4})\s+(\d{4})\s+(\d{4})\s+(\d{4})', '\1 **** **** \4');
        ELSE
            masked_data := '***';
    END CASE;

    RETURN masked_data;
END;
$$ LANGUAGE plpgsql;
```

## 3. å®ç°æ–¹æ¡ˆ

### 3.1 å‡½æ•°å¼è„±æ•

```sql
-- åˆ›å»ºè„±æ•å‡½æ•°åº“
CREATE SCHEMA IF NOT EXISTS data_masking;

-- æ‰‹æœºå·è„±æ•
CREATE OR REPLACE FUNCTION data_masking.mask_phone(phone TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN regexp_replace(phone, '(\d{3})\d{4}(\d{4})', '\1****\2');
END;
$$ LANGUAGE plpgsql;

-- èº«ä»½è¯è„±æ•
CREATE OR REPLACE FUNCTION data_masking.mask_id_card(id_card TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN regexp_replace(id_card, '(\d{6})\d{8}(\d{4})', '\1********\2');
END;
$$ LANGUAGE plpgsql;

-- å§“åè„±æ•
CREATE OR REPLACE FUNCTION data_masking.mask_name(name TEXT)
RETURNS TEXT AS $$
BEGIN
    IF length(name) <= 2 THEN
        RETURN LEFT(name, 1) || '*';
    ELSE
        RETURN LEFT(name, 1) || repeat('*', length(name) - 2) || RIGHT(name, 1);
    END IF;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 è§†å›¾è„±æ•

```sql
-- åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW citizen_data_masked AS
SELECT
    id,
    data_masking.mask_name(name) AS name,
    data_masking.mask_phone(phone) AS phone,
    data_masking.mask_id_card(id_card) AS id_card,
    address,  -- åœ°å€ä¸è„±æ•
    created_at
FROM citizen_data;

-- æˆäºˆè§†å›¾è®¿é—®æƒé™
GRANT SELECT ON citizen_data_masked TO public_user_role;
```

### 3.3 è§¦å‘å™¨è„±æ•

```sql
-- åˆ›å»ºè„±æ•è§¦å‘å™¨
CREATE OR REPLACE FUNCTION mask_sensitive_data()
RETURNS TRIGGER AS $$
BEGIN
    -- åœ¨æ’å…¥å‰è„±æ•
    NEW.phone := data_masking.mask_phone(NEW.phone);
    NEW.id_card := data_masking.mask_id_card(NEW.id_card);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè„±æ•è¡¨
CREATE TABLE citizen_data_masked (
    LIKE citizen_data INCLUDING ALL
);

-- æ·»åŠ è§¦å‘å™¨
CREATE TRIGGER mask_on_insert
    BEFORE INSERT ON citizen_data_masked
    FOR EACH ROW
    EXECUTE FUNCTION mask_sensitive_data();
```

## 4. å®è·µæ¡ˆä¾‹

### 4.1 ç¤¾ä¿æ•°æ®è„±æ•

**æ¡ˆä¾‹èƒŒæ™¯**:

æŸç¤¾ä¿ç³»ç»Ÿï¼ˆ2025 å¹´ 11 æœˆï¼‰ï¼š

- **æ•°æ®è§„æ¨¡**: 1000 ä¸‡æ¡å…¬æ°‘æ•°æ®
- **æ•æ„Ÿå­—æ®µ**: å§“åã€èº«ä»½è¯ã€æ‰‹æœºå·
- **éœ€æ±‚**: æŸ¥è¯¢æ—¶è‡ªåŠ¨è„±æ•

**å®ç°æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW v_citizen_data_masked AS
SELECT
    id,
    data_masking.mask_name(name) AS name,
    data_masking.mask_phone(phone) AS phone,
    data_masking.mask_id_card(id_card) AS id_card,
    region_id,
    status
FROM citizen_data;

-- 2. æˆäºˆæƒé™
GRANT SELECT ON v_citizen_data_masked TO analyst_role;

-- 3. æŸ¥è¯¢ä½¿ç”¨è§†å›¾
SELECT * FROM v_citizen_data_masked
WHERE region_id = $1
LIMIT 100;
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **éšç§ä¿æŠ¤** | 60% | **100%** | **æå‡** |
| **æ€§èƒ½å½±å“** | åŸºå‡† | **<3%** | **å‡ ä¹æ— å½±å“** |
| **åˆè§„æ€§** | 70% | **100%** | **æå‡** |
| **å¼€å‘æ—¶é—´** | 2 ä¸ªæœˆ | **2 å‘¨** | **75%** â¬‡ï¸ |

### 4.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**æ•°æ®è„±æ•æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | éšç§ä¿æŠ¤ | æ€§èƒ½å½±å“ | å¼€å‘æˆæœ¬ | çµæ´»æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|----------|----------|----------|--------|----------|
| **åº”ç”¨å±‚è„±æ•** | 80-90% | é«˜ | ä½ | ä½ | ç®€å•åœºæ™¯ |
| **æ•°æ®åº“å‡½æ•°** | 90-95% | ä¸­ | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **è§†å›¾è„±æ•** | **95-100%** | **ä½** | **ä¸­** | **é«˜** | **å¤æ‚åœºæ™¯** |

**è„±æ•æ–¹æ³•å¯¹æ¯”**:

| è„±æ•æ–¹æ³• | å®‰å…¨æ€§ | æ€§èƒ½ | å¯é€†æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|------|--------|----------|
| **å®Œå…¨æ›¿æ¢** | é«˜ | é«˜ | ä¸å¯é€† | æµ‹è¯•æ•°æ® |
| **éƒ¨åˆ†è„±æ•** | ä¸­ | é«˜ | ä¸å¯é€† | æŸ¥è¯¢å±•ç¤º |
| **å“ˆå¸Œè„±æ•** | é«˜ | ä¸­ | ä¸å¯é€† | å…³è”åˆ†æ |
| **æ ¼å¼ä¿ç•™** | **ä¸­** | **é«˜** | **ä¸å¯é€†** | **æ ¼å¼è¦æ±‚** |

## 5. æœ€ä½³å®è·µ

### 5.1 è„±æ•ç­–ç•¥é€‰æ‹©

1. **é™æ€è„±æ•**: é€‚ç”¨äºæ•°æ®å¯¼å‡ºåœºæ™¯
2. **åŠ¨æ€è„±æ•**: é€‚ç”¨äºå®æ—¶æŸ¥è¯¢åœºæ™¯
3. **æ ¼å¼ä¿ç•™**: é€‚ç”¨äºéœ€è¦ä¿æŒæ•°æ®æ ¼å¼çš„åœºæ™¯

### 5.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‡½æ•°ä¼˜åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„è„±æ•å‡½æ•°ï¼Œå‡å°‘æ€§èƒ½å½±å“
2. **è§†å›¾ç¼“å­˜**: ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜è„±æ•ç»“æœ
3. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºè„±æ•å­—æ®µåˆ›å»ºåˆé€‚çš„ç´¢å¼•

### 5.3 å®‰å…¨å»ºè®®

1. **æƒé™æ§åˆ¶**: ä¸¥æ ¼æ§åˆ¶è„±æ•è§†å›¾çš„è®¿é—®æƒé™
2. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰è„±æ•æ“ä½œ
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥è„±æ•ç­–ç•¥çš„æœ‰æ•ˆæ€§

## 6. å‚è€ƒèµ„æ–™

- [ç¤¾ä¿å¤§æ•°æ®ç³»ç»Ÿ](./ç¤¾ä¿å¤§æ•°æ®ç³»ç»Ÿ.md)
- [åˆè§„æŸ¥è¯¢ä¼˜åŒ–](./åˆè§„æŸ¥è¯¢ä¼˜åŒ–.md)
- [æ•°æ®åº“åˆè§„æ¶æ„](../../05-åˆè§„ä¸å¯ä¿¡/æŠ€æœ¯åŸç†/æ•°æ®åº“åˆè§„æ¶æ„.md)

---

## 7. å®Œæ•´ä»£ç ç¤ºä¾‹

### 7.1 åŠ¨æ€è„±æ•å‡½æ•°åˆ›å»º

**åˆ›å»ºè„±æ•å‡½æ•°**ï¼š

```sql
-- æ‰‹æœºå·è„±æ•ï¼ˆä¿ç•™å‰3ä½å’Œå4ä½ï¼‰
CREATE OR REPLACE FUNCTION mask_phone(phone TEXT)
RETURNS TEXT AS $$
BEGIN
    IF phone IS NULL OR LENGTH(phone) < 7 THEN
        RETURN phone;
    END IF;
    RETURN SUBSTRING(phone, 1, 3) || '****' || SUBSTRING(phone, LENGTH(phone) - 3);
END;
$$ LANGUAGE plpgsql;

-- èº«ä»½è¯å·è„±æ•ï¼ˆä¿ç•™å‰6ä½å’Œå4ä½ï¼‰
CREATE OR REPLACE FUNCTION mask_id_card(id_card TEXT)
RETURNS TEXT AS $$
BEGIN
    IF id_card IS NULL OR LENGTH(id_card) < 10 THEN
        RETURN id_card;
    END IF;
    RETURN SUBSTRING(id_card, 1, 6) || '********' || SUBSTRING(id_card, LENGTH(id_card) - 3);
END;
$$ LANGUAGE plpgsql;

-- é‚®ç®±è„±æ•ï¼ˆä¿ç•™ç”¨æˆ·åå‰2ä½ï¼‰
CREATE OR REPLACE FUNCTION mask_email(email TEXT)
RETURNS TEXT AS $$
DECLARE
    username TEXT;
    domain TEXT;
BEGIN
    IF email IS NULL OR POSITION('@' IN email) = 0 THEN
        RETURN email;
    END IF;
    username := SPLIT_PART(email, '@', 1);
    domain := SPLIT_PART(email, '@', 2);
    RETURN SUBSTRING(username, 1, 2) || '***@' || domain;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 è„±æ•è§†å›¾åˆ›å»º

**åˆ›å»ºè„±æ•è§†å›¾**ï¼š

```sql
-- åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW citizen_data_masked AS
SELECT
    id,
    name,
    mask_phone(phone) AS phone,
    mask_id_card(id_card) AS id_card,
    mask_email(email) AS email,
    address,
    region
FROM citizen_data;

-- æˆäºˆè®¿é—®æƒé™
GRANT SELECT ON citizen_data_masked TO public;
```

### 7.3 åŠ¨æ€è„±æ•å®ç°

**PythonåŠ¨æ€è„±æ•**ï¼š

```python
import psycopg2
from typing import Dict, List

class DataMasking:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–æ•°æ®è„±æ•å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def mask_phone(self, phone: str) -> str:
        """æ‰‹æœºå·è„±æ•"""
        if not phone or len(phone) < 7:
            return phone
        return phone[:3] + '****' + phone[-4:]

    def mask_id_card(self, id_card: str) -> str:
        """èº«ä»½è¯å·è„±æ•"""
        if not id_card or len(id_card) < 10:
            return id_card
        return id_card[:6] + '********' + id_card[-4:]

    def query_with_masking(self, query: str, params: Optional[Tuple] = None) -> List[Dict]:
        """æŸ¥è¯¢å¹¶è„±æ•"""
        self.cur.execute(query, params)
        columns = [desc[0] for desc in self.cur.description] if self.cur.description else []
        results = []
        for row in self.cur.fetchall():
            result = dict(zip(columns, row))
            if 'phone' in result and result['phone']:
                result['phone'] = self.mask_phone(result['phone'])
            if 'id_card' in result and result['id_card']:
                result['id_card'] = self.mask_id_card(result['id_card'])
            results.append(result)
        return results

# ä½¿ç”¨ç¤ºä¾‹
masking = DataMasking("host=localhost dbname=testdb user=postgres password=secret")
results = masking.query_with_masking(
    "SELECT id, name, phone, id_card FROM citizen_data WHERE region = %s",
    ('Beijing',)
)
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-05-03
