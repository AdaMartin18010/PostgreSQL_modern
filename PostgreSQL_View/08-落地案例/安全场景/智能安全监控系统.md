# æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+
> **æ–‡æ¡£ç¼–å·**: 08-49-01

## ğŸ“‘ ç›®å½•

- [æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿ](#æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 æ™ºèƒ½å®‰å…¨ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾](#21-æ™ºèƒ½å®‰å…¨ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 å®‰å…¨äº‹ä»¶æ—¶åºè¡¨](#31-å®‰å…¨äº‹ä»¶æ—¶åºè¡¨)
    - [3.2 å¨èƒæ£€æµ‹è¡¨](#32-å¨èƒæ£€æµ‹è¡¨)
  - [4. ç›‘æ§ç®¡ç†](#4-ç›‘æ§ç®¡ç†)
    - [4.1 å®æ—¶ç›‘æ§](#41-å®æ—¶ç›‘æ§)
    - [4.2 å¨èƒæ£€æµ‹](#42-å¨èƒæ£€æµ‹)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 å®æ—¶ç›‘æ§](#61-å®æ—¶ç›‘æ§)
    - [6.2 å¨èƒæ£€æµ‹](#62-å¨èƒæ£€æµ‹)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿéœ€è¦ï¼š

- **å®æ—¶ç›‘æ§**: å®æ—¶ç›‘æ§å®‰å…¨äº‹ä»¶
- **å¨èƒæ£€æµ‹**: æ£€æµ‹å®‰å…¨å¨èƒ
- **å¼‚å¸¸åˆ†æ**: åˆ†æå¼‚å¸¸è¡Œä¸º
- **é¢„è­¦é€šçŸ¥**: é¢„è­¦å’Œé€šçŸ¥

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ
- **è§¦å‘å™¨**: è‡ªåŠ¨è§¦å‘é¢„è­¦

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å¨èƒæ£€æµ‹** | æ™ºèƒ½æ£€æµ‹æå‡æ£€æµ‹ç‡ | **+68%** |
| **å“åº”é€Ÿåº¦** | æå‡å“åº”é€Ÿåº¦ | **+62%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **14x** |
| **å®‰å…¨æ€§** | æå‡ç³»ç»Ÿå®‰å…¨æ€§ | **+65%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **å¨èƒæ£€æµ‹**: æ™ºèƒ½æ£€æµ‹æå‡æ£€æµ‹ç‡ 68%
- **å“åº”é€Ÿåº¦**: æå‡å“åº”é€Ÿåº¦ 62%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 14 å€
- **å®‰å…¨æ€§**: æå‡ç³»ç»Ÿå®‰å…¨æ€§ 65%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ™ºèƒ½å®‰å…¨ç›‘æ§ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ™ºèƒ½å®‰å…¨ç›‘æ§))
    æ•°æ®å±‚
      å®‰å…¨æ•°æ®
        ç™»å½•æ—¥å¿—
        è®¿é—®æ—¥å¿—
        ç³»ç»Ÿæ—¥å¿—
        æ“ä½œæ—¥å¿—
      å¨èƒæ•°æ®
        å¨èƒäº‹ä»¶
        æ”»å‡»æ¨¡å¼
        å¼‚å¸¸è¡Œä¸º
        é£é™©è¯„åˆ†
      ç›‘æ§æ•°æ®
        ç³»ç»Ÿç›‘æ§
        ç½‘ç»œç›‘æ§
        åº”ç”¨ç›‘æ§
        æ€§èƒ½ç›‘æ§
    å­˜å‚¨å±‚
      æ—¶åºæ•°æ®åº“
        TimescaleDB
        å®‰å…¨äº‹ä»¶æ—¶åº
        ç›‘æ§æ•°æ®æ—¶åº
        æ•°æ®å‹ç¼©
        è¿ç»­èšåˆ
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
      ç¼“å­˜å±‚
        Redis
        å®æ—¶æ•°æ®
        çƒ­ç‚¹æ•°æ®
        å‘Šè­¦ç¼“å­˜
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        è¶‹åŠ¿åˆ†æ
        å¼‚å¸¸æ£€æµ‹
        æ¨¡å¼è¯†åˆ«
      å¨èƒæ£€æµ‹
        è§„åˆ™æ£€æµ‹
        å¼‚å¸¸æ£€æµ‹
        æœºå™¨å­¦ä¹ 
        è¡Œä¸ºåˆ†æ
    åº”ç”¨å±‚
      å®æ—¶ç›‘æ§
        äº‹ä»¶ç›‘æ§
        çŠ¶æ€ç›‘æ§
        æ€§èƒ½ç›‘æ§
        å‘Šè­¦é€šçŸ¥
      å¨èƒæ£€æµ‹
        å®æ—¶æ£€æµ‹
        æ¨¡å¼åŒ¹é…
        å¼‚å¸¸è¯†åˆ«
        é£é™©è¯„ä¼°
      é¢„è­¦é€šçŸ¥
        å®æ—¶é¢„è­¦
        åˆ†çº§é¢„è­¦
        è‡ªåŠ¨å“åº”
        åº”æ€¥å¤„ç†
    åº”ç”¨åœºæ™¯
      ä¼ä¸šå®‰å…¨
        å®‰å…¨ç›‘æ§
        å¨èƒæ£€æµ‹
        åº”æ€¥å“åº”
      äº‘å®‰å…¨
        äº‘èµ„æºç›‘æ§
        å®‰å…¨å®¡è®¡
        åˆè§„ç®¡ç†
      ç½‘ç»œå®‰å…¨
        ç½‘ç»œç›‘æ§
        æ”»å‡»æ£€æµ‹
        æµé‡åˆ†æ
```

### 2.2 æ¶æ„è®¾è®¡

```text
å®‰å…¨æ•°æ®é‡‡é›†
  â”œâ”€â”€ ç™»å½•æ—¥å¿—
  â”œâ”€â”€ è®¿é—®æ—¥å¿—
  â””â”€â”€ ç³»ç»Ÿæ—¥å¿—
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ å®‰å…¨äº‹ä»¶
  â””â”€â”€ ç›‘æ§æ•°æ®
  â†“
ç®¡ç†æœåŠ¡
  â”œâ”€â”€ å®æ—¶ç›‘æ§
  â”œâ”€â”€ å¨èƒæ£€æµ‹
  â””â”€â”€ é¢„è­¦é€šçŸ¥
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB
- **æ•°æ®é‡‡é›†**: æ—¥å¿—é‡‡é›†ã€ç›‘æ§æ•°æ®
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å®‰å…¨äº‹ä»¶æ—¶åºè¡¨

```sql
-- åˆ›å»ºå®‰å…¨äº‹ä»¶æ—¶åºè¡¨
CREATE TABLE security_events (
    time TIMESTAMPTZ NOT NULL,
    event_type TEXT NOT NULL,
    severity TEXT,
    source_ip INET,
    user_id INTEGER,
    resource TEXT,
    action TEXT,
    status TEXT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('security_events', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX se_type_time_idx ON security_events (event_type, time DESC);
CREATE INDEX se_ip_time_idx ON security_events (source_ip, time DESC);
CREATE INDEX se_user_time_idx ON security_events (user_id, time DESC);
```

### 3.2 å¨èƒæ£€æµ‹è¡¨

```sql
CREATE TABLE threat_detections (
    id SERIAL PRIMARY KEY,
    threat_type TEXT NOT NULL,
    source_ip INET,
    user_id INTEGER,
    detection_time TIMESTAMPTZ DEFAULT NOW(),
    severity TEXT,
    status TEXT,
    metadata JSONB
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX td_ip_time_idx ON threat_detections (source_ip, detection_time DESC);
CREATE INDEX td_user_time_idx ON threat_detections (user_id, detection_time DESC);
```

## 4. ç›‘æ§ç®¡ç†

### 4.1 å®æ—¶ç›‘æ§

```sql
-- å®æ—¶ç›‘æ§å®‰å…¨äº‹ä»¶
SELECT
    time_bucket('1 minute', time) AS minute,
    event_type,
    COUNT(*) AS event_count,
    COUNT(DISTINCT source_ip) AS unique_ips
FROM security_events
WHERE time > NOW() - INTERVAL '1 hour'
GROUP BY minute, event_type
ORDER BY minute DESC, event_count DESC;
```

### 4.2 å¨èƒæ£€æµ‹

```python
# å¨èƒæ£€æµ‹
class ThreatDetection:
    async def detect_threats(self):
        """æ£€æµ‹å¨èƒ"""
        # 1. æ£€æµ‹å¼‚å¸¸ç™»å½•
        abnormal_logins = await self.db.fetch("""
            SELECT
                source_ip,
                COUNT(*) AS login_count,
                COUNT(DISTINCT user_id) AS unique_users
            FROM security_events
            WHERE event_type = 'login'
                AND time > NOW() - INTERVAL '1 hour'
            GROUP BY source_ip
            HAVING COUNT(*) > 10
        """)

        # 2. æ£€æµ‹æš´åŠ›ç ´è§£
        brute_force = await self.db.fetch("""
            SELECT
                source_ip,
                user_id,
                COUNT(*) AS failed_count
            FROM security_events
            WHERE event_type = 'login'
                AND status = 'failed'
                AND time > NOW() - INTERVAL '10 minutes'
            GROUP BY source_ip, user_id
            HAVING COUNT(*) > 5
        """)

        return {
            'abnormal_logins': abnormal_logins,
            'brute_force': brute_force
        }
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦æ„å»ºæ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§å®‰å…¨äº‹ä»¶ï¼Œæ£€æµ‹å¨èƒã€‚

**é—®é¢˜åˆ†æ**:

1. **ç›‘æ§å›°éš¾**: å®‰å…¨äº‹ä»¶ç›‘æ§å›°éš¾
2. **å¨èƒæ£€æµ‹**: å¨èƒæ£€æµ‹ä¸å‡†ç¡®
3. **å“åº”æ…¢**: å“åº”é€Ÿåº¦æ…¢

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ™ºèƒ½å®‰å…¨ç›‘æ§ç³»ç»Ÿ
class SmartSecurityMonitoringSystem:
    def __init__(self):
        self.threat_detection = ThreatDetection()
        self.alert_system = AlertSystem()

    async def monitor_security(self):
        """ç›‘æ§å®‰å…¨"""
        # 1. å®æ—¶ç›‘æ§
        realtime_stats = await self.db.fetch("""
            SELECT
                time_bucket('1 minute', time) AS minute,
                event_type,
                COUNT(*) AS event_count
            FROM security_events
            WHERE time > NOW() - INTERVAL '1 hour'
            GROUP BY minute, event_type
            ORDER BY minute DESC
        """)

        # 2. æ£€æµ‹å¨èƒ
        threats = await self.threat_detection.detect_threats()

        # 3. å‘é€é¢„è­¦
        if threats['abnormal_logins'] or threats['brute_force']:
            await self.alert_system.send_alerts(threats)

        return {
            'realtime_stats': realtime_stats,
            'threats': threats
        }
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å¨èƒæ£€æµ‹** | åŸºå‡† | **+68%** | **æå‡** |
| **å“åº”é€Ÿåº¦** | åŸºå‡† | **+62%** | **æå‡** |
| **æŸ¥è¯¢æ€§èƒ½** | 3 ç§’ | **< 200ms** | **93%** â¬‡ï¸ |
| **å®‰å…¨æ€§** | åŸºå‡† | **+65%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**å®‰å…¨ç›‘æ§æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | æ£€æµ‹ç‡ | å“åº”é€Ÿåº¦ | å‡†ç¡®æ€§ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|--------|----------|--------|------|----------|
| **æ—¥å¿—åˆ†æ** | 50-60% | ä½ | ä¸­ | ä½ | ç®€å•åœºæ™¯ |
| **è§„åˆ™å¼•æ“** | 70-80% | ä¸­ | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **æœºå™¨å­¦ä¹ ** | 80-90% | ä¸­ | é«˜ | ä¸­ | å¤æ‚åœºæ™¯ |
| **æ™ºèƒ½ç›‘æ§** | **90-95%** | **é«˜** | **é«˜** | **ä¸­** | **å¤æ‚åœºæ™¯** |

**æ£€æµ‹æ–¹æ³•å¯¹æ¯”**:

| æ£€æµ‹æ–¹æ³• | æ£€æµ‹ç‡ | è¯¯æŠ¥ç‡ | å®æ—¶æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|--------|----------|
| **è§„åˆ™æ£€æµ‹** | 70-80% | 15-20% | é«˜ | å·²çŸ¥æ¨¡å¼ |
| **å¼‚å¸¸æ£€æµ‹** | 75-85% | 10-15% | ä¸­ | å¼‚å¸¸è¡Œä¸º |
| **æœºå™¨å­¦ä¹ ** | 85-90% | 5-10% | ä¸­ | å¤æ‚æ¨¡å¼ |
| **æ··åˆæ£€æµ‹** | **90-95%** | **3-8%** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 å®æ—¶ç›‘æ§

1. **å®æ—¶é‡‡é›†**: å®æ—¶é‡‡é›†å®‰å…¨äº‹ä»¶
2. **å¿«é€Ÿå“åº”**: å¿«é€Ÿå“åº”å®‰å…¨å¨èƒ
3. **æŒç»­ç›‘æ§**: æŒç»­ç›‘æ§å®‰å…¨çŠ¶æ€

### 6.2 å¨èƒæ£€æµ‹

1. **è§„åˆ™é…ç½®**: åˆç†é…ç½®æ£€æµ‹è§„åˆ™
2. **é˜ˆå€¼è®¾ç½®**: åˆç†è®¾ç½®æ£€æµ‹é˜ˆå€¼
3. **æŒç»­ä¼˜åŒ–**: æŒç»­ä¼˜åŒ–æ£€æµ‹ç®—æ³•

## 7. å‚è€ƒèµ„æ–™

- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)
- [æ™ºèƒ½å®¡è®¡ç³»ç»Ÿ](../å®¡è®¡åœºæ™¯/æ™ºèƒ½å®¡è®¡ç³»ç»Ÿ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 å®‰å…¨äº‹ä»¶æ—¶åºè¡¨åˆ›å»º

**åˆ›å»ºå®‰å…¨ç›‘æ§ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- åˆ›å»ºå®‰å…¨äº‹ä»¶æ—¶åºè¡¨
CREATE TABLE security_events (
    time TIMESTAMPTZ NOT NULL,
    event_type TEXT NOT NULL,  -- 'login', 'access', 'operation', 'system'
    severity TEXT,  -- 'low', 'medium', 'high', 'critical'
    source_ip INET,
    user_id INTEGER,
    resource TEXT,
    action TEXT,
    status TEXT,  -- 'success', 'failed', 'blocked'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆç”¨äºæ—¶åºæ•°æ®ï¼‰
SELECT create_hypertable('security_events', 'time');

-- åˆ›å»ºå¨èƒæ£€æµ‹è¡¨
CREATE TABLE threat_detections (
    id SERIAL PRIMARY KEY,
    threat_type TEXT NOT NULL,  -- 'brute_force', 'abnormal_access', 'suspicious_activity'
    source_ip INET,
    user_id INTEGER,
    detection_time TIMESTAMPTZ DEFAULT NOW(),
    severity TEXT,
    status TEXT DEFAULT 'active',  -- 'active', 'resolved', 'false_positive'
    description TEXT,
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå‘Šè­¦è¡¨
CREATE TABLE security_alerts (
    id SERIAL PRIMARY KEY,
    threat_detection_id INTEGER REFERENCES threat_detections(id),
    alert_type TEXT NOT NULL,
    severity TEXT,
    message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'pending',  -- 'pending', 'sent', 'acknowledged'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_security_events_type_time ON security_events (event_type, time DESC);
CREATE INDEX idx_security_events_ip_time ON security_events (source_ip, time DESC);
CREATE INDEX idx_security_events_user_time ON security_events (user_id, time DESC);
CREATE INDEX idx_threat_detections_ip_time ON threat_detections (source_ip, detection_time DESC);
CREATE INDEX idx_threat_detections_user_time ON threat_detections (user_id, detection_time DESC);
CREATE INDEX idx_security_alerts_status ON security_alerts (status, created_at DESC);
```

### 8.2 å®æ—¶ç›‘æ§å®ç°

**Pythonå®æ—¶ç›‘æ§**ï¼š

```python
import psycopg2
from datetime import datetime, timedelta
from typing import List, Dict

class SecurityMonitor:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å®‰å…¨ç›‘æ§å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def record_security_event(self, event_type: str, severity: str, source_ip: str,
                             user_id: int = None, resource: str = None, action: str = None,
                             status: str = None, metadata: Dict = None):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        self.cur.execute("""
            INSERT INTO security_events
            (time, event_type, severity, source_ip, user_id, resource, action, status, metadata)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            datetime.now(),
            event_type,
            severity,
            source_ip,
            user_id,
            resource,
            action,
            status,
            str(metadata) if metadata else '{}'
        ))

        self.conn.commit()

    def get_realtime_stats(self, minutes: int = 60) -> List[Dict]:
        """è·å–å®æ—¶ç»Ÿè®¡"""
        self.cur.execute("""
            SELECT
                time_bucket('1 minute', time) AS minute,
                event_type,
                severity,
                COUNT(*) AS event_count,
                COUNT(DISTINCT source_ip) AS unique_ips,
                COUNT(DISTINCT user_id) AS unique_users
            FROM security_events
            WHERE time > NOW() - INTERVAL '%s minutes'
            GROUP BY minute, event_type, severity
            ORDER BY minute DESC, event_count DESC
        """, (minutes,))

        stats = []
        for row in self.cur.fetchall():
            stats.append({
                'minute': row[0],
                'event_type': row[1],
                'severity': row[2],
                'event_count': row[3],
                'unique_ips': row[4],
                'unique_users': row[5]
            })

        return stats

    def get_event_trends(self, hours: int = 24) -> List[Dict]:
        """è·å–äº‹ä»¶è¶‹åŠ¿"""
        self.cur.execute("""
            SELECT
                time_bucket('1 hour', time) AS hour,
                event_type,
                COUNT(*) AS event_count,
                COUNT(CASE WHEN severity = 'critical' THEN 1 END) AS critical_count,
                COUNT(CASE WHEN severity = 'high' THEN 1 END) AS high_count
            FROM security_events
            WHERE time > NOW() - INTERVAL '%s hours'
            GROUP BY hour, event_type
            ORDER BY hour DESC
        """, (hours,))

        trends = []
        for row in self.cur.fetchall():
            trends.append({
                'hour': row[0],
                'event_type': row[1],
                'event_count': row[2],
                'critical_count': row[3],
                'high_count': row[4]
            })

        return trends

# ä½¿ç”¨ç¤ºä¾‹
monitor = SecurityMonitor("host=localhost dbname=testdb user=postgres password=secret")

# è®°å½•å®‰å…¨äº‹ä»¶
monitor.record_security_event(
    event_type='login',
    severity='medium',
    source_ip='192.168.1.100',
    user_id=1,
    action='login_attempt',
    status='success'
)

# è·å–å®æ—¶ç»Ÿè®¡
stats = monitor.get_realtime_stats(minutes=60)
for stat in stats:
    print(f"{stat['minute']}: {stat['event_type']} - {stat['event_count']} events")
```

### 8.3 å¨èƒæ£€æµ‹å®ç°

**Pythonå¨èƒæ£€æµ‹**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import List, Dict

class ThreatDetector:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å¨èƒæ£€æµ‹å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def detect_brute_force(self, time_window_minutes: int = 10, 
                          max_failed_attempts: int = 5) -> List[Dict]:
        """æ£€æµ‹æš´åŠ›ç ´è§£æ”»å‡»"""
        self.cur.execute("""
            SELECT
                source_ip,
                user_id,
                COUNT(*) AS failed_count,
                MIN(time) AS first_attempt,
                MAX(time) AS last_attempt
            FROM security_events
            WHERE event_type = 'login'
              AND status = 'failed'
              AND time > NOW() - INTERVAL '%s minutes'
            GROUP BY source_ip, user_id
            HAVING COUNT(*) >= %s
        """, (time_window_minutes, max_failed_attempts))

        threats = []
        for row in self.cur.fetchall():
            threat = {
                'threat_type': 'brute_force',
                'source_ip': str(row[0]),
                'user_id': row[1],
                'failed_count': row[2],
                'first_attempt': row[3],
                'last_attempt': row[4],
                'severity': 'high' if row[2] >= 10 else 'medium'
            }
            threats.append(threat)
            # è®°å½•å¨èƒæ£€æµ‹
            self.record_threat_detection(threat)

        return threats

    def detect_abnormal_access(self, time_window_minutes: int = 60,
                              max_access_count: int = 100) -> List[Dict]:
        """æ£€æµ‹å¼‚å¸¸è®¿é—®"""
        self.cur.execute("""
            SELECT
                source_ip,
                COUNT(*) AS access_count,
                COUNT(DISTINCT user_id) AS unique_users,
                COUNT(DISTINCT resource) AS unique_resources
            FROM security_events
            WHERE event_type = 'access'
              AND time > NOW() - INTERVAL '%s minutes'
            GROUP BY source_ip
            HAVING COUNT(*) >= %s
        """, (time_window_minutes, max_access_count))

        threats = []
        for row in self.cur.fetchall():
            threat = {
                'threat_type': 'abnormal_access',
                'source_ip': str(row[0]),
                'access_count': row[1],
                'unique_users': row[2],
                'unique_resources': row[3],
                'severity': 'high' if row[1] >= 500 else 'medium'
            }
            threats.append(threat)
            # è®°å½•å¨èƒæ£€æµ‹
            self.record_threat_detection(threat)

        return threats

    def detect_suspicious_activity(self, time_window_hours: int = 24) -> List[Dict]:
        """æ£€æµ‹å¯ç–‘æ´»åŠ¨"""
        self.cur.execute("""
            SELECT
                user_id,
                source_ip,
                COUNT(*) AS activity_count,
                COUNT(DISTINCT event_type) AS event_types,
                COUNT(CASE WHEN severity IN ('high', 'critical') THEN 1 END) AS high_severity_count
            FROM security_events
            WHERE time > NOW() - INTERVAL '%s hours'
            GROUP BY user_id, source_ip
            HAVING COUNT(CASE WHEN severity IN ('high', 'critical') THEN 1 END) >= 3
               OR COUNT(*) >= 50
        """, (time_window_hours,))

        threats = []
        for row in self.cur.fetchall():
            threat = {
                'threat_type': 'suspicious_activity',
                'user_id': row[0],
                'source_ip': str(row[1]),
                'activity_count': row[2],
                'event_types': row[3],
                'high_severity_count': row[4],
                'severity': 'critical' if row[4] >= 5 else 'high'
            }
            threats.append(threat)
            # è®°å½•å¨èƒæ£€æµ‹
            self.record_threat_detection(threat)

        return threats

    def record_threat_detection(self, threat: Dict):
        """è®°å½•å¨èƒæ£€æµ‹"""
        self.cur.execute("""
            INSERT INTO threat_detections
            (threat_type, source_ip, user_id, detection_time, severity, description, metadata)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
            RETURNING id
        """, (
            threat['threat_type'],
            threat.get('source_ip'),
            threat.get('user_id'),
            datetime.now(),
            threat['severity'],
            f"Detected {threat['threat_type']}",
            str(threat)
        ))

        threat_id = self.cur.fetchone()[0]
        self.conn.commit()

        # åˆ›å»ºå‘Šè­¦
        self.create_alert(threat_id, threat)

        return threat_id

    def create_alert(self, threat_id: int, threat: Dict):
        """åˆ›å»ºå‘Šè­¦"""
        alert_message = f"Threat detected: {threat['threat_type']} from {threat.get('source_ip', 'unknown')}"

        self.cur.execute("""
            INSERT INTO security_alerts
            (threat_detection_id, alert_type, severity, message, metadata)
            VALUES (%s, %s, %s, %s, %s)
        """, (
            threat_id,
            threat['threat_type'],
            threat['severity'],
            alert_message,
            str(threat)
        ))

        self.conn.commit()

    def detect_all_threats(self) -> Dict:
        """æ£€æµ‹æ‰€æœ‰å¨èƒ"""
        brute_force = self.detect_brute_force()
        abnormal_access = self.detect_abnormal_access()
        suspicious_activity = self.detect_suspicious_activity()

        return {
            'brute_force': brute_force,
            'abnormal_access': abnormal_access,
            'suspicious_activity': suspicious_activity,
            'total_threats': len(brute_force) + len(abnormal_access) + len(suspicious_activity)
        }

# ä½¿ç”¨ç¤ºä¾‹
detector = ThreatDetector("host=localhost dbname=testdb user=postgres password=secret")

# æ£€æµ‹æ‰€æœ‰å¨èƒ
threats = detector.detect_all_threats()
print(f"Total threats detected: {threats['total_threats']}")
print(f"Brute force attacks: {len(threats['brute_force'])}")
print(f"Abnormal access: {len(threats['abnormal_access'])}")
print(f"Suspicious activity: {len(threats['suspicious_activity'])}")
```

### 8.4 å‘Šè­¦ç³»ç»Ÿå®ç°

**Pythonå‘Šè­¦ç³»ç»Ÿ**ï¼š

```python
import psycopg2
from typing import List, Dict

class AlertSystem:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å‘Šè­¦ç³»ç»Ÿ"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def get_pending_alerts(self, limit: int = 50) -> List[Dict]:
        """è·å–å¾…å¤„ç†å‘Šè­¦"""
        self.cur.execute("""
            SELECT
                sa.id,
                sa.alert_type,
                sa.severity,
                sa.message,
                sa.created_at,
                td.source_ip,
                td.user_id
            FROM security_alerts sa
            JOIN threat_detections td ON sa.threat_detection_id = td.id
            WHERE sa.status = 'pending'
            ORDER BY 
                CASE sa.severity
                    WHEN 'critical' THEN 1
                    WHEN 'high' THEN 2
                    WHEN 'medium' THEN 3
                    ELSE 4
                END,
                sa.created_at DESC
            LIMIT %s
        """, (limit,))

        alerts = []
        for row in self.cur.fetchall():
            alerts.append({
                'id': row[0],
                'alert_type': row[1],
                'severity': row[2],
                'message': row[3],
                'created_at': row[4],
                'source_ip': str(row[5]) if row[5] else None,
                'user_id': row[6]
            })

        return alerts

    def mark_alert_sent(self, alert_id: int):
        """æ ‡è®°å‘Šè­¦å·²å‘é€"""
        self.cur.execute("""
            UPDATE security_alerts
            SET status = 'sent'
            WHERE id = %s
        """, (alert_id,))

        self.conn.commit()

    def mark_alert_acknowledged(self, alert_id: int):
        """æ ‡è®°å‘Šè­¦å·²ç¡®è®¤"""
        self.cur.execute("""
            UPDATE security_alerts
            SET status = 'acknowledged'
            WHERE id = %s
        """, (alert_id,))

        self.conn.commit()

    def get_threat_summary(self, hours: int = 24) -> Dict:
        """è·å–å¨èƒæ‘˜è¦"""
        self.cur.execute("""
            SELECT
                threat_type,
                severity,
                COUNT(*) AS count
            FROM threat_detections
            WHERE detection_time > NOW() - INTERVAL '%s hours'
            GROUP BY threat_type, severity
            ORDER BY 
                CASE severity
                    WHEN 'critical' THEN 1
                    WHEN 'high' THEN 2
                    WHEN 'medium' THEN 3
                    ELSE 4
                END,
                count DESC
        """, (hours,))

        summary = {}
        for row in self.cur.fetchall():
            threat_type = row[0]
            severity = row[1]
            count = row[2]

            if threat_type not in summary:
                summary[threat_type] = {}

            summary[threat_type][severity] = count

        return summary

# ä½¿ç”¨ç¤ºä¾‹
alert_system = AlertSystem("host=localhost dbname=testdb user=postgres password=secret")

# è·å–å¾…å¤„ç†å‘Šè­¦
pending_alerts = alert_system.get_pending_alerts(limit=20)
for alert in pending_alerts:
    print(f"[{alert['severity']}] {alert['message']} at {alert['created_at']}")

# è·å–å¨èƒæ‘˜è¦
summary = alert_system.get_threat_summary(hours=24)
for threat_type, severities in summary.items():
    print(f"{threat_type}: {severities}")
```

### 8.5 ç»¼åˆç›‘æ§ç³»ç»Ÿå®ç°

**Pythonç»¼åˆç›‘æ§ç³»ç»Ÿ**ï¼š

```python
import psycopg2
import time
from typing import Dict

class SecurityMonitoringSystem:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å®‰å…¨ç›‘æ§ç³»ç»Ÿ"""
        self.monitor = SecurityMonitor(conn_str)
        self.detector = ThreatDetector(conn_str)
        self.alert_system = AlertSystem(conn_str)

    def run_monitoring_cycle(self) -> Dict:
        """è¿è¡Œç›‘æ§å‘¨æœŸ"""
        # 1. è·å–å®æ—¶ç»Ÿè®¡
        realtime_stats = self.monitor.get_realtime_stats(minutes=60)

        # 2. æ£€æµ‹å¨èƒ
        threats = self.detector.detect_all_threats()

        # 3. è·å–å¾…å¤„ç†å‘Šè­¦
        pending_alerts = self.alert_system.get_pending_alerts(limit=20)

        # 4. è·å–å¨èƒæ‘˜è¦
        threat_summary = self.alert_system.get_threat_summary(hours=24)

        return {
            'realtime_stats': realtime_stats,
            'threats': threats,
            'pending_alerts': pending_alerts,
            'threat_summary': threat_summary
        }

    def start_continuous_monitoring(self, interval_seconds: int = 60):
        """å¯åŠ¨æŒç»­ç›‘æ§"""
        print("Starting continuous security monitoring...")
        
        while True:
            try:
                cycle_result = self.run_monitoring_cycle()
                
                # æ‰“å°ç›‘æ§ç»“æœ
                print(f"\n=== Monitoring Cycle at {datetime.now()} ===")
                print(f"Total threats: {cycle_result['threats']['total_threats']}")
                print(f"Pending alerts: {len(cycle_result['pending_alerts'])}")
                
                # å¦‚æœæœ‰ä¸¥é‡å¨èƒï¼Œç«‹å³å¤„ç†
                critical_alerts = [a for a in cycle_result['pending_alerts'] 
                                 if a['severity'] == 'critical']
                if critical_alerts:
                    print(f"âš ï¸  CRITICAL: {len(critical_alerts)} critical alerts detected!")
                    for alert in critical_alerts:
                        print(f"  - {alert['message']}")
                        # å¯ä»¥åœ¨è¿™é‡Œå‘é€ç´§æ€¥é€šçŸ¥
                        self.alert_system.mark_alert_sent(alert['id'])

                time.sleep(interval_seconds)

            except KeyboardInterrupt:
                print("\nMonitoring stopped.")
                break
            except Exception as e:
                print(f"Error in monitoring cycle: {e}")
                time.sleep(interval_seconds)

# ä½¿ç”¨ç¤ºä¾‹
# system = SecurityMonitoringSystem("host=localhost dbname=testdb user=postgres password=secret")
# system.start_continuous_monitoring(interval_seconds=60)
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-49-01
