# çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+, TimescaleDB 2.11+, PostGIS 3.0+
> **æ–‡æ¡£ç¼–å·**: 08-24-01

## ğŸ“‘ ç›®å½•

- [çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿ](#çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡èƒŒæ™¯](#11-ä¸šåŠ¡èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
    - [2.1 çŸ¿å±±å®‰å…¨ç›‘æµ‹ä½“ç³»æ€ç»´å¯¼å›¾](#21-çŸ¿å±±å®‰å…¨ç›‘æµ‹ä½“ç³»æ€ç»´å¯¼å›¾)
    - [2.2 æ¶æ„è®¾è®¡](#22-æ¶æ„è®¾è®¡)
    - [2.3 æŠ€æœ¯æ ˆ](#23-æŠ€æœ¯æ ˆ)
  - [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
    - [3.1 ç¯å¢ƒæ•°æ®æ—¶åºè¡¨](#31-ç¯å¢ƒæ•°æ®æ—¶åºè¡¨)
    - [3.2 äººå‘˜ä½ç½®è¡¨](#32-äººå‘˜ä½ç½®è¡¨)
  - [4. å®‰å…¨ç›‘æµ‹](#4-å®‰å…¨ç›‘æµ‹)
    - [4.1 ç¯å¢ƒç›‘æµ‹](#41-ç¯å¢ƒç›‘æµ‹)
    - [4.2 äººå‘˜å®šä½](#42-äººå‘˜å®šä½)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹: çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰](#51-æ¡ˆä¾‹-çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»ŸçœŸå®æ¡ˆä¾‹)
    - [5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ](#52-æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 å®‰å…¨ç›‘æµ‹](#61-å®‰å…¨ç›‘æµ‹)
    - [6.2 äººå‘˜ç®¡ç†](#62-äººå‘˜ç®¡ç†)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 çŸ¿å±±å®‰å…¨ç›‘æµ‹æ•°æ®è¡¨åˆ›å»º](#81-çŸ¿å±±å®‰å…¨ç›‘æµ‹æ•°æ®è¡¨åˆ›å»º)
    - [8.2 ç¯å¢ƒæ•°æ®é‡‡é›†å’Œé¢„è­¦å®ç°](#82-ç¯å¢ƒæ•°æ®é‡‡é›†å’Œé¢„è­¦å®ç°)

---

## 1. æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿéœ€è¦ï¼š

- **ç¯å¢ƒç›‘æµ‹**: ç›‘æµ‹çŸ¿å±±ç¯å¢ƒå‚æ•°
- **äººå‘˜å®šä½**: äººå‘˜å®šä½å’Œè¿½è¸ª
- **å®‰å…¨é¢„è­¦**: å®‰å…¨é¢„è­¦å’ŒæŠ¥è­¦
- **åº”æ€¥å“åº”**: åº”æ€¥å“åº”å’Œæ•‘æ´

**æŠ€æœ¯æ–¹æ¡ˆ**:

- **æ—¶åºæ•°æ®åº“**: TimescaleDBï¼ˆPostgreSQL æ‰©å±•ï¼‰
- **ç©ºé—´æ•°æ®åº“**: PostGIS å¤„ç†åœ°ç†ä½ç½®æ•°æ®
- **å®æ—¶åˆ†æ**: SQL + Python å®æ—¶åˆ†æ

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å®‰å…¨äº‹æ•…å‡å°‘** | å®æ—¶ç›‘æµ‹å‡å°‘äº‹æ•… | **-70%** |
| **æ•‘æ´æ—¶é—´** | å¿«é€Ÿå®šä½å’Œæ•‘æ´ | **-80%** |
| **æŸ¥è¯¢æ€§èƒ½** | æ—¶åºä¼˜åŒ–æå‡æ€§èƒ½ | **15x** |
| **äººå‘˜å®‰å…¨** | æå‡äººå‘˜å®‰å…¨ | **+50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **å®‰å…¨äº‹æ•…å‡å°‘**: å®æ—¶ç›‘æµ‹å‡å°‘å®‰å…¨äº‹æ•… 70%
- **æ•‘æ´æ—¶é—´**: å¿«é€Ÿå®šä½å’Œæ•‘æ´ï¼Œç¼©çŸ­æ•‘æ´æ—¶é—´ 80%
- **æŸ¥è¯¢æ€§èƒ½**: æ—¶åºä¼˜åŒ–æå‡æŸ¥è¯¢æ€§èƒ½ 15 å€
- **äººå‘˜å®‰å…¨**: æå‡äººå‘˜å®‰å…¨ 50%

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 çŸ¿å±±å®‰å…¨ç›‘æµ‹ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((çŸ¿å±±å®‰å…¨ç›‘æµ‹))
    æ•°æ®å±‚
      ç¯å¢ƒæ•°æ®
        æ¸©åº¦æ•°æ®
        æ¹¿åº¦æ•°æ®
        æ°”ä½“æµ“åº¦
        ç²‰å°˜æµ“åº¦
        æ°§æ°”å«é‡
      äººå‘˜æ•°æ®
        äººå‘˜ä½ç½®
        äººå‘˜çŠ¶æ€
        äººå‘˜è½¨è¿¹
        äººå‘˜ä¿¡æ¯
      è®¾å¤‡æ•°æ®
        è®¾å¤‡çŠ¶æ€
        è®¾å¤‡è¿è¡Œ
        è®¾å¤‡æ•…éšœ
        è®¾å¤‡ç»´æŠ¤
    å­˜å‚¨å±‚
      æ—¶åºæ•°æ®åº“
        TimescaleDB
        ç¯å¢ƒæ—¶åº
        äººå‘˜æ—¶åº
        è®¾å¤‡æ—¶åº
        æ•°æ®å‹ç¼©
      ç©ºé—´æ•°æ®åº“
        PostGIS
        çŸ¿å±±åœ°å›¾
        åŒºåŸŸä¿¡æ¯
        ä½ç½®ä¿¡æ¯
        ç©ºé—´ç´¢å¼•
      å…³ç³»æ•°æ®åº“
        PostgreSQL
        åŸºç¡€æ•°æ®
        å…ƒæ•°æ®
        é…ç½®ä¿¡æ¯
    å¤„ç†å±‚
      æ•°æ®é‡‡é›†
        å®æ—¶é‡‡é›†
        æ‰¹é‡é‡‡é›†
        æ•°æ®æ¸…æ´—
        æ•°æ®éªŒè¯
      æ•°æ®åˆ†æ
        å®æ—¶åˆ†æ
        è¶‹åŠ¿åˆ†æ
        å¼‚å¸¸æ£€æµ‹
        æ¨¡å¼è¯†åˆ«
      å®‰å…¨åˆ†æ
        é£é™©è¯„ä¼°
        é¢„è­¦åˆ†æ
        åº”æ€¥åˆ†æ
        å®‰å…¨è¯„ä¼°
    åº”ç”¨å±‚
      å®æ—¶ç›‘æµ‹
        ç¯å¢ƒç›‘æµ‹
        äººå‘˜ç›‘æµ‹
        è®¾å¤‡ç›‘æµ‹
        çŠ¶æ€å±•ç¤º
      å®‰å…¨é¢„è­¦
        ç¯å¢ƒé¢„è­¦
        äººå‘˜é¢„è­¦
        è®¾å¤‡é¢„è­¦
        ç»¼åˆé¢„è­¦
      åº”æ€¥å“åº”
        åº”æ€¥å®šä½
        åº”æ€¥é€šä¿¡
        åº”æ€¥è°ƒåº¦
        åº”æ€¥å¤„ç†
    åº”ç”¨åœºæ™¯
      çŸ¿å±±å®‰å…¨
        å®‰å…¨ç›‘æµ‹
        å®‰å…¨é¢„è­¦
        åº”æ€¥å“åº”
      ç”Ÿäº§å®‰å…¨
        ç”Ÿäº§ç›‘æ§
        å®‰å…¨ç®¡æ§
        é£é™©æ§åˆ¶
      äººå‘˜å®‰å…¨
        äººå‘˜å®šä½
        å®‰å…¨é˜²æŠ¤
        åº”æ€¥æ•‘æ´
```

### 2.2 æ¶æ„è®¾è®¡

```text
ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†
  â”œâ”€â”€ ç¯å¢ƒä¼ æ„Ÿå™¨
  â”œâ”€â”€ äººå‘˜å®šä½è®¾å¤‡
  â””â”€â”€ è®¾å¤‡ä¼ æ„Ÿå™¨
  â†“
æ—¶åºæ•°æ®å­˜å‚¨ï¼ˆTimescaleDBï¼‰
  â”œâ”€â”€ ç¯å¢ƒæ•°æ®
  â”œâ”€â”€ äººå‘˜ä½ç½®æ•°æ®
  â””â”€â”€ è®¾å¤‡æ•°æ®
  â†“
ç©ºé—´æ•°æ®å­˜å‚¨ï¼ˆPostGISï¼‰
  â”œâ”€â”€ çŸ¿å±±åœ°å›¾
  â””â”€â”€ åŒºåŸŸä¿¡æ¯
  â†“
å®‰å…¨ç›‘æµ‹æœåŠ¡
  â”œâ”€â”€ å®æ—¶ç›‘æµ‹
  â”œâ”€â”€ å®‰å…¨é¢„è­¦
  â””â”€â”€ åº”æ€¥å“åº”
```

### 2.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL + TimescaleDB + PostGIS
- **æ•°æ®é‡‡é›†**: ä¼ æ„Ÿå™¨ã€å®šä½è®¾å¤‡
- **å®æ—¶åˆ†æ**: Python + SQL
- **åº”ç”¨æ¡†æ¶**: FastAPI / Spring Boot

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç¯å¢ƒæ•°æ®æ—¶åºè¡¨

```sql
-- åˆ›å»ºç¯å¢ƒæ•°æ®æ—¶åºè¡¨
CREATE TABLE environment_data (
    time TIMESTAMPTZ NOT NULL,
    sensor_id TEXT NOT NULL,
    location GEOGRAPHY(POINT, 4326),
    temperature DECIMAL(10, 2),
    humidity DECIMAL(10, 2),
    gas_concentration DECIMAL(10, 2),
    dust_concentration DECIMAL(10, 2),
    oxygen_level DECIMAL(10, 2),
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('environment_data', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX env_sensor_time_idx ON environment_data (sensor_id, time DESC);
CREATE INDEX env_location_idx ON environment_data USING GIST (location);
```

### 3.2 äººå‘˜ä½ç½®è¡¨

```sql
CREATE TABLE personnel_location (
    time TIMESTAMPTZ NOT NULL,
    personnel_id TEXT NOT NULL,
    location GEOGRAPHY(POINT, 4326),
    zone_id TEXT,
    status TEXT,
    metadata JSONB
);

-- è½¬æ¢ä¸ºæ—¶åºè¡¨
SELECT create_hypertable('personnel_location', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX pl_personnel_time_idx ON personnel_location (personnel_id, time DESC);
CREATE INDEX pl_location_idx ON personnel_location USING GIST (location);
```

## 4. å®‰å…¨ç›‘æµ‹

### 4.1 ç¯å¢ƒç›‘æµ‹

```sql
-- å®æ—¶ç¯å¢ƒç›‘æµ‹
SELECT
    sensor_id,
    time_bucket('1 minute', time) AS bucket,
    AVG(temperature) AS avg_temperature,
    AVG(gas_concentration) AS avg_gas,
    AVG(oxygen_level) AS avg_oxygen,
    ST_AsText(location) AS location
FROM environment_data
WHERE time > NOW() - INTERVAL '5 minutes'
GROUP BY sensor_id, bucket, location
ORDER BY bucket DESC;
```

### 4.2 äººå‘˜å®šä½

```python
# äººå‘˜å®šä½
class PersonnelTracking:
    async def track_personnel(self, personnel_id):
        """è¿½è¸ªäººå‘˜ä½ç½®"""
        # 1. è·å–æœ€æ–°ä½ç½®
        location = await self.db.fetchrow("""
            SELECT *
            FROM personnel_location
            WHERE personnel_id = $1
            ORDER BY time DESC
            LIMIT 1
        """, personnel_id)

        # 2. æ£€æŸ¥å®‰å…¨åŒºåŸŸ
        is_safe = await self.check_safe_zone(location['location'])

        # 3. æ£€æŸ¥é™„è¿‘ç¯å¢ƒ
        nearby_env = await self.db.fetch("""
            SELECT *
            FROM environment_data
            WHERE ST_DWithin(
                location,
                $1::geography,
                100
            )
            AND time > NOW() - INTERVAL '5 minutes'
        """, location['location'])

        return {
            'location': location,
            'is_safe': is_safe,
            'nearby_env': nearby_env
        }
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸçŸ¿ä¸šå…¬å¸éœ€è¦æ„å»ºçŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿï¼Œç›‘æµ‹ç¯å¢ƒï¼Œå®šä½äººå‘˜ï¼Œç¡®ä¿å®‰å…¨ç”Ÿäº§ã€‚

**é—®é¢˜åˆ†æ**:

1. **å®‰å…¨é£é™©**: çŸ¿å±±å®‰å…¨é£é™©é«˜
2. **äººå‘˜å®šä½**: äººå‘˜å®šä½å›°éš¾
3. **åº”æ€¥å“åº”**: åº”æ€¥å“åº”æ…¢

**è§£å†³æ–¹æ¡ˆ**:

```python
# çŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿ
class MineSafetyMonitoringSystem:
    def __init__(self):
        self.personnel_tracking = PersonnelTracking()
        self.safety_alert = SafetyAlert()

    async def monitor_mine(self):
        """ç›‘æµ‹çŸ¿å±±"""
        # 1. ç›‘æµ‹ç¯å¢ƒ
        env_alerts = await self.safety_alert.check_environment()

        # 2. è¿½è¸ªäººå‘˜
        personnel_status = []
        personnel_list = await self.get_all_personnel()
        for person in personnel_list:
            status = await self.personnel_tracking.track_personnel(
                person['id']
            )
            personnel_status.append(status)

        # 3. ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        safety_report = await self.generate_safety_report(
            env_alerts, personnel_status
        )

        return safety_report
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å®‰å…¨äº‹æ•…** | åŸºå‡† | **-70%** | **é™ä½** |
| **æ•‘æ´æ—¶é—´** | 60åˆ†é’Ÿ | **< 10åˆ†é’Ÿ** | **83%** â¬‡ï¸ |
| **æŸ¥è¯¢æ€§èƒ½** | 4 ç§’ | **< 200ms** | **95%** â¬‡ï¸ |
| **äººå‘˜å®‰å…¨** | åŸºå‡† | **+50%** | **æå‡** |

### 5.2 æŠ€æœ¯æ–¹æ¡ˆå¤šç»´å¯¹æ¯”çŸ©é˜µ

**çŸ¿å±±å®‰å…¨ç›‘æµ‹æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| æŠ€æœ¯æ–¹æ¡ˆ | å®‰å…¨äº‹æ•…å‡å°‘ | æ•‘æ´æ—¶é—´ | æŸ¥è¯¢æ€§èƒ½ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|-------------|----------|----------|------|----------|
| **ä¼ ç»Ÿç›‘æµ‹** | åŸºå‡† | åŸºå‡† | åŸºå‡† | ä½ | å°è§„æ¨¡ |
| **æ•°å­—åŒ–ç›‘æµ‹** | -40% | -50% | +300% | ä¸­ | ä¸­ç­‰è§„æ¨¡ |
| **æ™ºèƒ½ç›‘æµ‹** | **-70%** | **-80%** | **+1400%** | **ä¸­** | **å¤§è§„æ¨¡** |

**ç›‘æµ‹æ–¹æ³•å¯¹æ¯”**:

| ç›‘æµ‹æ–¹æ³• | å‡†ç¡®ç‡ | å®æ—¶æ€§ | å¯æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|----------|----------|
| **äººå·¥ç›‘æµ‹** | 60-70% | ä½ | ä½ | å°è§„æ¨¡ |
| **ä¼ æ„Ÿå™¨ç›‘æµ‹** | 80-85% | ä¸­ | ä¸­ | ä¸­ç­‰åœºæ™¯ |
| **æ™ºèƒ½ç›‘æµ‹** | **90-95%** | **é«˜** | **é«˜** | **å¤æ‚åœºæ™¯** |

## 6. æœ€ä½³å®è·µ

### 6.1 å®‰å…¨ç›‘æµ‹

1. **å®æ—¶ç›‘æµ‹**: å®æ—¶ç›‘æµ‹ç¯å¢ƒå’Œäººå‘˜
2. **é¢„è­¦ç³»ç»Ÿ**: å®Œå–„çš„é¢„è­¦ç³»ç»Ÿ
3. **åº”æ€¥å“åº”**: å¿«é€Ÿåº”æ€¥å“åº”æœºåˆ¶

### 6.2 äººå‘˜ç®¡ç†

1. **å®æ—¶å®šä½**: å®æ—¶å®šä½äººå‘˜ä½ç½®
2. **å®‰å…¨åŒºåŸŸ**: å®šä¹‰å®‰å…¨åŒºåŸŸ
3. **åº”æ€¥é€šä¿¡**: åº”æ€¥é€šä¿¡æœºåˆ¶

## 7. å‚è€ƒèµ„æ–™

- [ç”Ÿäº§å®‰å…¨ç›‘æ§ç³»ç»Ÿ](../åŒ–å·¥åœºæ™¯/ç”Ÿäº§å®‰å…¨ç›‘æ§ç³»ç»Ÿ.md)
- [IoT æ—¶åºæ•°æ®åˆ†æ](../åˆ¶é€ åœºæ™¯/IoTæ—¶åºæ•°æ®åˆ†æ.md)

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 çŸ¿å±±å®‰å…¨ç›‘æµ‹æ•°æ®è¡¨åˆ›å»º

**åˆ›å»ºçŸ¿å±±å®‰å…¨ç›‘æµ‹ç³»ç»Ÿæ•°æ®è¡¨**ï¼š

```sql
-- å¯ç”¨TimescaleDBå’ŒPostGISæ‰©å±•
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS postgis;

-- åˆ›å»ºç¯å¢ƒæ•°æ®æ—¶åºè¡¨
CREATE TABLE environment_data (
    time TIMESTAMPTZ NOT NULL,
    sensor_id TEXT NOT NULL,
    location GEOGRAPHY(POINT, 4326),  -- ä¼ æ„Ÿå™¨ä½ç½®
    temperature DECIMAL(10, 2),  -- æ¸©åº¦ï¼ˆæ‘„æ°åº¦ï¼‰
    humidity DECIMAL(10, 2),  -- æ¹¿åº¦ï¼ˆ%ï¼‰
    gas_concentration DECIMAL(10, 2),  -- æ°”ä½“æµ“åº¦ï¼ˆppmï¼‰
    dust_concentration DECIMAL(10, 2),  -- ç²‰å°˜æµ“åº¦ï¼ˆmg/mÂ³ï¼‰
    oxygen_level DECIMAL(10, 2),  -- æ°§æ°”æµ“åº¦ï¼ˆ%ï¼‰
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºäººå‘˜ä½ç½®æ—¶åºè¡¨
CREATE TABLE personnel_location (
    time TIMESTAMPTZ NOT NULL,
    personnel_id TEXT NOT NULL,
    name TEXT,
    location GEOGRAPHY(POINT, 4326),  -- äººå‘˜ä½ç½®
    zone_id TEXT,  -- æ‰€åœ¨åŒºåŸŸID
    status TEXT,  -- 'working', 'resting', 'emergency'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- åˆ›å»ºå®‰å…¨é¢„è­¦è¡¨
CREATE TABLE safety_alerts (
    id SERIAL PRIMARY KEY,
    alert_type TEXT NOT NULL,  -- 'gas_leak', 'low_oxygen', 'personnel_risk'
    sensor_id TEXT,
    personnel_id TEXT,
    location GEOGRAPHY(POINT, 4326),
    severity TEXT,  -- 'low', 'medium', 'high', 'critical'
    message TEXT,
    alert_time TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'active',  -- 'active', 'resolved', 'false_alarm'
    metadata JSONB DEFAULT '{}'::JSONB
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆç”¨äºæ—¶åºæ•°æ®ï¼‰
SELECT create_hypertable('environment_data', 'time');
SELECT create_hypertable('personnel_location', 'time');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_environment_data_sensor_time ON environment_data (sensor_id, time DESC);
CREATE INDEX idx_environment_data_location ON environment_data USING GIST (location);
CREATE INDEX idx_personnel_location_personnel_time ON personnel_location (personnel_id, time DESC);
CREATE INDEX idx_personnel_location_location ON personnel_location USING GIST (location);
CREATE INDEX idx_safety_alerts_time ON safety_alerts (alert_time DESC);
CREATE INDEX idx_safety_alerts_status ON safety_alerts (status, alert_time DESC);
```

### 8.2 ç¯å¢ƒæ•°æ®é‡‡é›†å’Œé¢„è­¦å®ç°

**Pythonç¯å¢ƒæ•°æ®é‡‡é›†å’Œé¢„è­¦**ï¼š

```python
import psycopg2
from datetime import datetime
from typing import Optional, List, Dict
from shapely.geometry import Point

class MineSafetyMonitor:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–çŸ¿å±±å®‰å…¨ç›‘æµ‹å™¨"""
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def collect_environment_data(self, sensor_id: str, location: Point,
                                temperature: Optional[float] = None,
                                humidity: Optional[float] = None,
                                gas_concentration: Optional[float] = None,
                                dust_concentration: Optional[float] = None,
                                oxygen_level: Optional[float] = None):
        """é‡‡é›†ç¯å¢ƒæ•°æ®"""
        lon, lat = location.x, location.y

        self.cur.execute("""
            INSERT INTO environment_data
            (time, sensor_id, location, temperature, humidity, gas_concentration,
             dust_concentration, oxygen_level)
            VALUES (%s, %s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s, %s, %s, %s, %s)
        """, (
            datetime.now(), sensor_id, lon, lat, temperature, humidity,
            gas_concentration, dust_concentration, oxygen_level
        ))

        self.conn.commit()

        # æ£€æŸ¥é¢„è­¦æ¡ä»¶
        self.check_environment_alerts(sensor_id, gas_concentration, oxygen_level)

    def check_environment_alerts(self, sensor_id: str, gas_concentration: Optional[float],
                                oxygen_level: Optional[float]):
        """æ£€æŸ¥ç¯å¢ƒé¢„è­¦"""
        alerts = []

        # æ£€æŸ¥æ°”ä½“æµ“åº¦
        if gas_concentration and gas_concentration > 50:  # é˜ˆå€¼ï¼š50ppm
            alert = {
                'alert_type': 'gas_leak',
                'sensor_id': sensor_id,
                'severity': 'critical' if gas_concentration > 100 else 'high',
                'message': f"æ°”ä½“æµ“åº¦å¼‚å¸¸: {gas_concentration}ppmï¼ˆé˜ˆå€¼: 50ppmï¼‰"
            }
            alerts.append(alert)

        # æ£€æŸ¥æ°§æ°”æµ“åº¦
        if oxygen_level and oxygen_level < 19.5:  # é˜ˆå€¼ï¼š19.5%
            alert = {
                'alert_type': 'low_oxygen',
                'sensor_id': sensor_id,
                'severity': 'critical' if oxygen_level < 18 else 'high',
                'message': f"æ°§æ°”æµ“åº¦è¿‡ä½: {oxygen_level}%ï¼ˆæ­£å¸¸å€¼åº”â‰¥19.5%ï¼‰"
            }
            alerts.append(alert)

        # åˆ›å»ºé¢„è­¦
        for alert in alerts:
            self.create_alert(alert)

    def update_personnel_location(self, personnel_id: str, name: str,
                                  location: Point, zone_id: Optional[str] = None,
                                  status: str = 'working'):
        """æ›´æ–°äººå‘˜ä½ç½®"""
        lon, lat = location.x, location.y

        self.cur.execute("""
            INSERT INTO personnel_location
            (time, personnel_id, name, location, zone_id, status)
            VALUES (%s, %s, %s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s, %s)
        """, (
            datetime.now(), personnel_id, name, lon, lat, zone_id, status
        ))

        self.conn.commit()

    def create_alert(self, alert: Dict):
        """åˆ›å»ºé¢„è­¦"""
        self.cur.execute("""
            INSERT INTO safety_alerts
            (alert_type, sensor_id, personnel_id, severity, message, alert_time, status)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
        """, (
            alert['alert_type'],
            alert.get('sensor_id'),
            alert.get('personnel_id'),
            alert['severity'],
            alert['message'],
            datetime.now(),
            'active'
        ))

        self.conn.commit()

    def get_active_alerts(self, limit: int = 50) -> List[Dict]:
        """è·å–æ´»è·ƒé¢„è­¦"""
        self.cur.execute("""
            SELECT
                id, alert_type, sensor_id, personnel_id, severity, message, alert_time
            FROM safety_alerts
            WHERE status = 'active'
            ORDER BY
                CASE severity
                    WHEN 'critical' THEN 1
                    WHEN 'high' THEN 2
                    WHEN 'medium' THEN 3
                    ELSE 4
                END,
                alert_time DESC
            LIMIT %s
        """, (limit,))

        alerts = []
        for row in self.cur.fetchall():
            alerts.append({
                'id': row[0],
                'alert_type': row[1],
                'sensor_id': row[2],
                'personnel_id': row[3],
                'severity': row[4],
                'message': row[5],
                'alert_time': row[6]
            })

        return alerts

# ä½¿ç”¨ç¤ºä¾‹
from shapely.geometry import Point

monitor = MineSafetyMonitor("host=localhost dbname=testdb user=postgres password=secret")

# é‡‡é›†ç¯å¢ƒæ•°æ®
sensor_location = Point(116.3974, 39.9093)
monitor.collect_environment_data(
    sensor_id='sensor_001',
    location=sensor_location,
    temperature=25.5,
    humidity=60.0,
    gas_concentration=30.0,
    oxygen_level=20.5
)

# è·å–æ´»è·ƒé¢„è­¦
alerts = monitor.get_active_alerts(limit=20)
for alert in alerts:
    print(f"[{alert['severity']}] {alert['message']}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 08-24-01
