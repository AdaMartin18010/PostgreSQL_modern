# 数据主权技术

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 18+, pg_dsr v1.0+
> **文档编号**: 05-01-02

## 📑 目录

- [数据主权技术](#数据主权技术)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 技术背景](#11-技术背景)
    - [1.2 技术定位](#12-技术定位)
    - [1.3 核心价值](#13-核心价值)
  - [2. 技术原理](#2-技术原理)
    - [2.1 数据主权概念](#21-数据主权概念)
    - [2.2 主权标签体系](#22-主权标签体系)
    - [2.3 访问控制机制](#23-访问控制机制)
    - [2.4 跨境数据拦截](#24-跨境数据拦截)
  - [3. 架构设计](#3-架构设计)
    - [3.1 整体架构](#31-整体架构)
    - [3.2 标签管理](#32-标签管理)
    - [3.3 策略引擎](#33-策略引擎)
  - [4. 实现细节](#4-实现细节)
    - [4.1 标签存储](#41-标签存储)
    - [4.2 策略执行](#42-策略执行)
    - [4.3 拦截机制](#43-拦截机制)
  - [5. 性能分析](#5-性能分析)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 标签设计](#61-标签设计)
    - [6.2 策略设计](#62-策略设计)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

### 1.1 技术背景

**问题需求**:

随着数据保护法规的加强（如 GDPR、AI Act），企业需要确保数据主权，控制数据的存储位置和访问权限，防止
数据跨境传输。

**技术演进**:

1. **2018 年**: GDPR 生效，数据主权要求增强
2. **2020 年**: pg_dsr 项目启动
3. **2024 年**: AI Act 生效，数据主权要求更严格
4. **2025 年**: PostgreSQL 18 集成数据主权功能

**市场需求**:

- **合规要求**: 满足 GDPR、AI Act 等法规要求
- **数据控制**: 精确控制数据存储和访问
- **跨境限制**: 防止数据非法跨境传输
- **审计追踪**: 完整的数据访问审计

### 1.2 技术定位

数据主权技术是合规数据库的核心功能，通过主权标签和访问控制，确保数据的主权归属和合规使用。

### 1.3 核心价值

- **合规保障**: 满足数据保护法规要求
- **精确控制**: 精确控制数据访问和传输
- **自动拦截**: 自动拦截违规数据访问
- **完整审计**: 完整的数据访问审计

---

## 2. 技术原理

### 2.1 数据主权概念

**主权定义**:

数据主权是指数据的所有权和控制权，包括：

- **存储主权**: 数据存储的地理位置
- **访问主权**: 谁可以访问数据
- **传输主权**: 数据可以传输到哪些区域
- **处理主权**: 数据可以在哪里处理

**主权标签**:

```sql
-- 创建带主权标签的表
CREATE TABLE user_data (
    id SERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    data_sovereignty TEXT[] DEFAULT ARRAY['EU', 'GDPR']
);
```

### 2.2 主权标签体系

**标签层次**:

- **国家级别**: CN, US, EU, etc.
- **区域级别**: APAC, EMEA, Americas
- **法规级别**: GDPR, CCPA, AI-Act
- **组织级别**: company, department

**标签结构**:

```python
class SovereigntyTag:
    """主权标签"""

    def __init__(self):
        self.country = None      # 国家
        self.region = None       # 区域
        self.regulation = []     # 法规列表
        self.organization = None # 组织
        self.restrictions = []   # 限制列表

    def to_array(self):
        """转换为数组"""
        return [
            f"country:{self.country}",
            f"region:{self.region}",
            *[f"regulation:{r}" for r in self.regulation],
            f"org:{self.organization}",
            *[f"restriction:{r}" for r in self.restrictions]
        ]
```

### 2.3 访问控制机制

**访问控制**:

基于主权标签的访问控制：

```sql
-- 创建访问策略
CREATE POLICY sovereignty_policy ON user_data
    FOR ALL
    USING (
        -- 检查用户是否有权限访问该主权标签的数据
        current_user_sovereignty() && data_sovereignty
    );
```

**访问检查流程**:

1. 提取数据的主权标签
2. 检查用户的主权权限
3. 验证访问是否符合策略
4. 允许或拒绝访问

### 2.4 跨境数据拦截

**拦截机制**:

```python
class CrossBorderInterceptor:
    """跨境数据拦截器"""

    def intercept_query(self, query, user_location):
        """拦截查询"""
        # 1. 分析查询涉及的数据
        data_locations = self.analyze_data_locations(query)

        # 2. 检查是否违反跨境限制
        violations = self.check_cross_border_violations(
            user_location,
            data_locations
        )

        # 3. 拦截违规查询
        if violations:
            raise CrossBorderViolationError(violations)

        # 4. 允许查询
        return self.execute_query(query)
```

---

## 3. 架构设计

### 3.1 整体架构

```text
┌─────────────────────────────────────────┐
│      Data Sovereignty Layer             │
│  ┌──────────────────────────────────┐  │
│  │  Tag Manager                     │  │
│  │  - Tag Storage                   │  │
│  │  - Tag Assignment                │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Policy Engine                   │  │
│  │  - Access Control                │  │
│  │  - Cross-Border Check            │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Interceptor                     │  │
│  │  - Query Interception            │  │
│  │  - Violation Detection           │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 3.2 标签管理

**标签管理功能**:

- **标签创建**: 创建主权标签
- **标签分配**: 自动或手动分配标签
- **标签继承**: 标签继承机制
- **标签更新**: 更新标签信息

### 3.3 策略引擎

**策略功能**:

- **访问策略**: 定义访问控制策略
- **传输策略**: 定义数据传输策略
- **存储策略**: 定义数据存储策略
- **策略评估**: 评估策略合规性

---

## 4. 实现细节

### 4.1 标签存储

**存储方式**:

```sql
-- 使用数组列存储标签
ALTER TABLE user_data
    ADD COLUMN data_sovereignty TEXT[];

-- 创建索引
CREATE INDEX idx_sovereignty ON user_data USING GIN (data_sovereignty);
```

### 4.2 策略执行

**策略执行**:

```sql
-- 启用 Row Level Security
ALTER TABLE user_data ENABLE ROW LEVEL SECURITY;

-- 创建主权策略
CREATE POLICY sovereignty_access ON user_data
    FOR SELECT
    USING (
        -- 检查主权标签
        data_sovereignty && current_user_sovereignty_tags()
    );
```

### 4.3 拦截机制

**拦截实现**:

```python
class QueryInterceptor:
    """查询拦截器"""

    def intercept(self, query):
        """拦截查询"""
        # 1. 解析查询
        parsed_query = self.parse_query(query)

        # 2. 提取数据位置
        data_locations = self.extract_data_locations(parsed_query)

        # 3. 检查跨境限制
        if self.violates_cross_border(data_locations):
            raise CrossBorderViolationError()

        # 4. 执行查询
        return self.execute_query(query)
```

---

## 5. 性能分析

**性能影响**:

- **标签检查**: <1ms 开销
- **策略评估**: <2ms 开销
- **拦截检查**: <1ms 开销

**优化建议**:

- 使用 GIN 索引加速标签查询
- 缓存策略评估结果
- 并行执行检查

---

## 6. 最佳实践

### 6.1 标签设计

- **层次清晰**: 设计清晰的标签层次
- **自动分配**: 使用自动标签分配
- **定期审查**: 定期审查标签准确性

### 6.2 策略设计

- **最小权限**: 使用最小权限原则
- **明确规则**: 定义明确的访问规则
- **定期更新**: 根据法规变化更新策略

---

## 7. 参考资料

- [pg_dsr 文档](https://github.com/pg_dsr/pg_dsr)
- [GDPR 合规指南](https://gdpr.eu/)
- [AI Act 要求](https://digital-strategy.ec.europa.eu/en/policies/regulatory-framework-ai)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
