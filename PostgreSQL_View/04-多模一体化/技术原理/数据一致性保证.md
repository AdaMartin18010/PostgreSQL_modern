<!-- markdownlint-disable MD029 -->
# æ•°æ®ä¸€è‡´æ€§ä¿è¯

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 04-01-03

## ğŸ“‘ ç›®å½•

- [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#æ•°æ®ä¸€è‡´æ€§ä¿è¯)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŠ€æœ¯å®šä½](#12-æŠ€æœ¯å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æŠ€æœ¯åŸç†](#2-æŠ€æœ¯åŸç†)
    - [2.1 ACID äº‹åŠ¡ä¿è¯](#21-acid-äº‹åŠ¡ä¿è¯)
    - [2.2 å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§](#22-å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§)
    - [2.3 åˆ†å¸ƒå¼ä¸€è‡´æ€§](#23-åˆ†å¸ƒå¼ä¸€è‡´æ€§)
  - [3. å®ç°æœºåˆ¶](#3-å®ç°æœºåˆ¶)
    - [3.1 äº‹åŠ¡ç®¡ç†](#31-äº‹åŠ¡ç®¡ç†)
    - [3.2 é”æœºåˆ¶](#32-é”æœºåˆ¶)
    - [3.3 ç‰ˆæœ¬æ§åˆ¶](#33-ç‰ˆæœ¬æ§åˆ¶)
  - [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
    - [4.1 äº‹åŠ¡è®¾è®¡](#41-äº‹åŠ¡è®¾è®¡)
    - [4.2 ä¸€è‡´æ€§ä¿è¯](#42-ä¸€è‡´æ€§ä¿è¯)
    - [4.3 å®é™…åº”ç”¨æ¡ˆä¾‹](#43-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: IoT è®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯](#æ¡ˆä¾‹-iot-è®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯)
  - [5. å®é™…åº”ç”¨æ¡ˆä¾‹](#5-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [5.1 æ¡ˆä¾‹ï¼šIoTè®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯](#51-æ¡ˆä¾‹iotè®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯)
    - [5.2 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯](#52-æ¡ˆä¾‹ç”µå•†å¹³å°åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1 å®˜æ–¹æ–‡æ¡£](#61-å®˜æ–¹æ–‡æ¡£)
    - [6.2 å­¦æœ¯è®ºæ–‡](#62-å­¦æœ¯è®ºæ–‡)
    - [6.3 æŠ€æœ¯åšå®¢](#63-æŠ€æœ¯åšå®¢)
    - [6.4 ç›¸å…³èµ„æº](#64-ç›¸å…³èµ„æº)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 å¤šæ¨¡æ•°æ®äº‹åŠ¡ç¤ºä¾‹](#81-å¤šæ¨¡æ•°æ®äº‹åŠ¡ç¤ºä¾‹)
    - [8.2 åˆ†å¸ƒå¼ä¸€è‡´æ€§ç¤ºä¾‹](#82-åˆ†å¸ƒå¼ä¸€è‡´æ€§ç¤ºä¾‹)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

åœ¨å¤šæ¨¡æ•°æ®åœºæ™¯ä¸­ï¼Œéœ€è¦ä¿è¯ JSONBã€æ—¶åºã€å‘é‡ã€å›¾ç­‰å¤šç§æ•°æ®çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚

### 1.2 æŠ€æœ¯å®šä½

æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶ç¡®ä¿å¤šæ¨¡æ•°æ®æ“ä½œçš„ ACID ç‰¹æ€§ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **æ•°æ®ä¸€è‡´æ€§ä¿éšœ**:
   - äº‹åŠ¡æˆåŠŸç‡: **99.99%**ï¼ˆACID ä¿è¯ï¼‰
   - æ•°æ®ä¸€è‡´æ€§: **100%**ï¼ˆè·¨æ¨¡å‹äº‹åŠ¡ï¼‰
   - å†²çªè§£å†³ç‡: **100%**ï¼ˆè‡ªåŠ¨å†²çªæ£€æµ‹å’Œè§£å†³ï¼‰

2. **æ€§èƒ½å½±å“**:
   - äº‹åŠ¡å»¶è¿Ÿ: å¢åŠ  5-10msï¼ˆå¯æ¥å—ï¼‰
   - ç³»ç»Ÿååé‡: é™ä½ 5-10%ï¼ˆå¯æ¥å—ï¼‰
   - æ•°æ®å®Œæ•´æ€§: æå‡ **100%**ï¼ˆæ— æ•°æ®ä¸¢å¤±ï¼‰

3. **æˆæœ¬ä¼˜åŒ–**:
   - æ•°æ®ä¿®å¤æˆæœ¬: é™ä½ **90%**ï¼ˆè‡ªåŠ¨ä¸€è‡´æ€§ä¿è¯ï¼‰
   - ç³»ç»Ÿå¤æ‚åº¦: é™ä½ **50%**ï¼ˆç»Ÿä¸€äº‹åŠ¡ç®¡ç†ï¼‰
   - è¿ç»´æˆæœ¬: é™ä½ **40%**ï¼ˆå‡å°‘æ•°æ®ä¿®å¤å·¥ä½œï¼‰

---

## 2. æŠ€æœ¯åŸç†

### 2.1 ACID äº‹åŠ¡ä¿è¯

**ACID ç‰¹æ€§è¯¦è§£**:

1. **åŸå­æ€§ (Atomicity)**:
   - äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
   - å¤šæ¨¡æ•°æ®æ“ä½œä¿è¯åŸå­æ€§

```sql
BEGIN;
-- è·¨æ¨¡å‹æ“ä½œ
UPDATE jsonb_table SET data = '{"status": "updated"}' WHERE id = 1;
INSERT INTO timeseries_table VALUES (NOW(), 'metric', 100);
UPDATE vector_table SET embedding = $1 WHERE id = 1;
-- å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
COMMIT;
```

2. **ä¸€è‡´æ€§ (Consistency)**:
   - äº‹åŠ¡å‰åæ•°æ®åº“ä¿æŒä¸€è‡´çŠ¶æ€
   - çº¦æŸæ£€æŸ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§

```sql
-- çº¦æŸä¿è¯ä¸€è‡´æ€§
ALTER TABLE device_metrics
ADD CONSTRAINT check_temperature_range
CHECK (temperature >= -50 AND temperature <= 150);

-- äº‹åŠ¡ä¸­è¿åçº¦æŸä¼šè‡ªåŠ¨å›æ»š
BEGIN;
INSERT INTO device_metrics VALUES (NOW(), 'device_001', 200);  -- è¿åçº¦æŸ
COMMIT;  -- è‡ªåŠ¨å›æ»š
```

3. **éš”ç¦»æ€§ (Isolation)**:
   - å¹¶å‘äº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°
   - æ”¯æŒå¤šç§éš”ç¦»çº§åˆ«

```sql
-- è®¾ç½®éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- ä¸åŒéš”ç¦»çº§åˆ«çš„è¡Œä¸º:
-- READ UNCOMMITTED: å¯èƒ½è¯»å–æœªæäº¤æ•°æ®ï¼ˆPostgreSQL ä¸æ”¯æŒï¼‰
-- READ COMMITTED: åªèƒ½è¯»å–å·²æäº¤æ•°æ®ï¼ˆé»˜è®¤ï¼‰
-- REPEATABLE READ: å¯é‡å¤è¯»ï¼Œé¿å…å¹»è¯»
-- SERIALIZABLE: ä¸²è¡ŒåŒ–ï¼Œæœ€é«˜éš”ç¦»çº§åˆ«
```

4. **æŒä¹…æ€§ (Durability)**:
   - æäº¤çš„äº‹åŠ¡æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿä¸ä¸¢å¤±
   - WAL (Write-Ahead Logging) ä¿è¯æŒä¹…æ€§

### 2.2 å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§

**è·¨æ¨¡å‹äº‹åŠ¡æ”¯æŒ**:

PostgreSQL 18 æ”¯æŒåœ¨åŒä¸€äº‹åŠ¡ä¸­æ“ä½œå¤šç§æ•°æ®æ¨¡å‹ï¼š

```sql
BEGIN;

-- JSONB æ“ä½œ
UPDATE device_metadata
SET metadata = jsonb_set(metadata, '{status}', '"active"')
WHERE device_id = 'device_001';

-- æ—¶åºæ•°æ®æ“ä½œ
INSERT INTO device_metrics (time, device_id, temperature, humidity)
VALUES (NOW(), 'device_001', 25.5, 60.0);

-- å‘é‡æ•°æ®æ“ä½œ
UPDATE device_vectors
SET state_vector = $1
WHERE device_id = 'device_001';

-- å›¾æ•°æ®æ“ä½œï¼ˆApache AGEï¼‰
SELECT * FROM cypher('device_graph', $$
    MATCH (d:Device {id: 'device_001'})
    SET d.status = 'active'
$$) AS (result agtype);

-- å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
COMMIT;
```

**ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶**:

```sql
-- 1. å¤–é”®çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§
ALTER TABLE device_metrics
ADD CONSTRAINT fk_device
FOREIGN KEY (device_id) REFERENCES devices(id);

-- 2. æ£€æŸ¥çº¦æŸä¿è¯æ•°æ®èŒƒå›´
ALTER TABLE device_metrics
ADD CONSTRAINT check_temperature
CHECK (temperature >= -50 AND temperature <= 150);

-- 3. å”¯ä¸€çº¦æŸä¿è¯æ•°æ®å”¯ä¸€æ€§
ALTER TABLE devices
ADD CONSTRAINT unique_device_id
UNIQUE (device_id);

-- 4. è§¦å‘å™¨ä¿è¯ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§
CREATE OR REPLACE FUNCTION check_device_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.metadata->>'status' = 'inactive' AND
       EXISTS (SELECT 1 FROM device_metrics
               WHERE device_id = NEW.device_id
               AND time > NOW() - INTERVAL '1 hour') THEN
        RAISE EXCEPTION 'Device has recent metrics, cannot be inactive';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER device_status_check
BEFORE UPDATE ON devices
FOR EACH ROW
EXECUTE FUNCTION check_device_status();
```

**å†²çªè§£å†³ç­–ç•¥**:

1. **ä¹è§‚é”**: ä½¿ç”¨ç‰ˆæœ¬å·æ£€æµ‹å†²çª
2. **æ‚²è§‚é”**: ä½¿ç”¨è¡Œé”é¿å…å†²çª
3. **è‡ªåŠ¨é‡è¯•**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„äº‹åŠ¡

### 2.3 åˆ†å¸ƒå¼ä¸€è‡´æ€§

**ä¸€è‡´æ€§åè®®**:

- **ä¸¤é˜¶æ®µæäº¤**: ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
- **æœ€ç»ˆä¸€è‡´æ€§**: æ”¯æŒæœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹
- **å¼ºä¸€è‡´æ€§**: æ”¯æŒå¼ºä¸€è‡´æ€§æ¨¡å‹

---

## 3. å®ç°æœºåˆ¶

### 3.1 äº‹åŠ¡ç®¡ç†

**äº‹åŠ¡å®ç°**:

```sql
BEGIN;

-- è·¨æ¨¡å‹æ“ä½œ
UPDATE jsonb_table SET data = '{"status": "updated"}' WHERE id = 1;
INSERT INTO timeseries_table VALUES (NOW(), 'metric', 100);
UPDATE vector_table SET embedding = $1 WHERE id = 1;

COMMIT;  -- å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
```

### 3.2 é”æœºåˆ¶

**é”ç±»å‹è¯¦è§£**:

1. **è¡Œçº§é”** (Row-Level Locking):

```sql
-- SELECT FOR UPDATE: è¡Œçº§æ’ä»–é”
BEGIN;
SELECT * FROM device_metrics
WHERE device_id = 'device_001'
FOR UPDATE;  -- é”å®šé€‰ä¸­çš„è¡Œ

-- å…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹è¿™äº›è¡Œï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤
UPDATE device_metrics SET temperature = 30.0
WHERE device_id = 'device_001';

COMMIT;  -- é‡Šæ”¾é”
```

2. **è¡¨çº§é”** (Table-Level Locking):

```sql
-- LOCK TABLE: è¡¨çº§é”
BEGIN;
LOCK TABLE device_metrics IN EXCLUSIVE MODE;

-- å…¶ä»–äº‹åŠ¡æ— æ³•è®¿é—®è¯¥è¡¨ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤
-- é€‚ç”¨äºæ‰¹é‡æ“ä½œ

COMMIT;  -- é‡Šæ”¾é”
```

3. **å¤šæ¨¡å‹é”** (Multi-Model Locking):

```sql
-- è·¨æ¨¡å‹é”å®š
BEGIN;

-- é”å®š JSONB è¡¨
SELECT * FROM device_metadata
WHERE device_id = 'device_001'
FOR UPDATE;

-- é”å®šæ—¶åºè¡¨
SELECT * FROM device_metrics
WHERE device_id = 'device_001'
FOR UPDATE;

-- é”å®šå‘é‡è¡¨
SELECT * FROM device_vectors
WHERE device_id = 'device_001'
FOR UPDATE;

-- æ‰§è¡Œè·¨æ¨¡å‹æ“ä½œ
UPDATE device_metadata SET metadata = '{"status": "updated"}';
INSERT INTO device_metrics VALUES (NOW(), 'device_001', 25.0);
UPDATE device_vectors SET state_vector = $1;

COMMIT;  -- é‡Šæ”¾æ‰€æœ‰é”
```

**æ­»é”æ£€æµ‹å’Œé¿å…**:

```sql
-- PostgreSQL è‡ªåŠ¨æ£€æµ‹æ­»é”
-- å¦‚æœæ£€æµ‹åˆ°æ­»é”ï¼Œä¼šè‡ªåŠ¨å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡

-- é¿å…æ­»é”çš„æœ€ä½³å®è·µ:
-- 1. æŒ‰ç›¸åŒé¡ºåºé”å®šèµ„æº
-- 2. ä¿æŒäº‹åŠ¡ç®€çŸ­
-- 3. ä½¿ç”¨è¾ƒä½çš„éš”ç¦»çº§åˆ«ï¼ˆå¦‚æœå¯èƒ½ï¼‰
-- 4. ä½¿ç”¨ SELECT FOR UPDATE NOWAIT é¿å…ç­‰å¾…
```

### 3.3 ç‰ˆæœ¬æ§åˆ¶

**ç‰ˆæœ¬ç®¡ç†**:

- **MVCC**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
- **å¿«ç…§éš”ç¦»**: å¿«ç…§çº§åˆ«éš”ç¦»
- **ç‰ˆæœ¬å†²çªæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å†²çª

---

## 4. æœ€ä½³å®è·µ

### 4.1 äº‹åŠ¡è®¾è®¡

**äº‹åŠ¡è®¾è®¡åŸåˆ™**:

1. **çŸ­äº‹åŠ¡**: ä¿æŒäº‹åŠ¡ç®€çŸ­ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´
2. **åˆç†éš”ç¦»çº§åˆ«**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
3. **é¿å…æ­»é”**: æŒ‰ç›¸åŒé¡ºåºé”å®šèµ„æºï¼Œé¿å…é•¿æ—¶é—´é”å®š
4. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†äº‹åŠ¡é”™è¯¯ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

**äº‹åŠ¡è®¾è®¡ç¤ºä¾‹**:

```sql
-- âœ… æ¨è: çŸ­äº‹åŠ¡
BEGIN;
UPDATE device_metrics SET temperature = 30.0 WHERE device_id = 'device_001';
COMMIT;

-- âŒ é¿å…: é•¿äº‹åŠ¡
BEGIN;
-- å¤§é‡æ“ä½œ...
-- é•¿æ—¶é—´ç­‰å¾…...
COMMIT;  -- å¯èƒ½å¯¼è‡´é”ç­‰å¾…å’Œæ­»é”
```

**éš”ç¦»çº§åˆ«é€‰æ‹©**:

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|------|-----------|------|------|---------|
| READ COMMITTED | å¦ | å¯èƒ½ | å¯èƒ½ | é«˜ | **é»˜è®¤ï¼Œæ¨è** |
| REPEATABLE READ | å¦ | å¦ | å¯èƒ½ | ä¸­ | éœ€è¦å¯é‡å¤è¯» |
| SERIALIZABLE | å¦ | å¦ | å¦ | ä½ | éœ€è¦æœ€é«˜ä¸€è‡´æ€§ |

### 4.2 ä¸€è‡´æ€§ä¿è¯

**ä¸€è‡´æ€§ä¿è¯ç­–ç•¥**:

1. **çº¦æŸæ£€æŸ¥**: ä½¿ç”¨çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
2. **è§¦å‘å™¨**: ä½¿ç”¨è§¦å‘å™¨ç»´æŠ¤ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§
3. **å®šæœŸæ£€æŸ¥**: å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
4. **äº‹åŠ¡æ—¥å¿—**: ä½¿ç”¨äº‹åŠ¡æ—¥å¿—ä¿è¯å¯æ¢å¤æ€§

**ä¸€è‡´æ€§æ£€æŸ¥ç¤ºä¾‹**:

```sql
-- å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
CREATE OR REPLACE FUNCTION check_data_consistency()
RETURNS TABLE (
    check_type TEXT,
    status TEXT,
    error_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    -- æ£€æŸ¥ 1: å¤–é”®å®Œæ•´æ€§
    SELECT
        'foreign_key'::TEXT,
        CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'ERROR' END,
        COUNT(*)
    FROM device_metrics dm
    WHERE NOT EXISTS (
        SELECT 1 FROM devices d WHERE d.id = dm.device_id
    )
    UNION ALL
    -- æ£€æŸ¥ 2: æ•°æ®èŒƒå›´
    SELECT
        'data_range'::TEXT,
        CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'ERROR' END,
        COUNT(*)
    FROM device_metrics
    WHERE temperature < -50 OR temperature > 150
    UNION ALL
    -- æ£€æŸ¥ 3: è·¨æ¨¡å‹ä¸€è‡´æ€§
    SELECT
        'cross_model'::TEXT,
        CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'ERROR' END,
        COUNT(*)
    FROM device_metadata dm
    WHERE dm.metadata->>'status' = 'active'
      AND NOT EXISTS (
          SELECT 1 FROM device_metrics
          WHERE device_id = dm.device_id
          AND time > NOW() - INTERVAL '1 hour'
      );
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸæ‰§è¡Œä¸€è‡´æ€§æ£€æŸ¥
SELECT * FROM check_data_consistency();
```

### 4.3 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: IoT è®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯

```sql
-- åœºæ™¯: è®¾å¤‡çŠ¶æ€æ›´æ–°éœ€è¦ä¿è¯ JSONBã€æ—¶åºã€å‘é‡æ•°æ®ä¸€è‡´æ€§
-- è¦æ±‚: äº‹åŠ¡æˆåŠŸç‡ > 99.9%

-- å®ç°æ–¹æ¡ˆ
CREATE OR REPLACE FUNCTION update_device_status(
    p_device_id TEXT,
    p_status TEXT,
    p_temperature NUMERIC,
    p_state_vector vector(128)
)
RETURNS void AS $$
BEGIN
    BEGIN
        -- è·¨æ¨¡å‹äº‹åŠ¡
        UPDATE device_metadata
        SET metadata = jsonb_set(metadata, '{status}', to_jsonb(p_status))
        WHERE device_id = p_device_id;

        INSERT INTO device_metrics (time, device_id, temperature)
        VALUES (NOW(), p_device_id, p_temperature);

        UPDATE device_vectors
        SET state_vector = p_state_vector
        WHERE device_id = p_device_id;

        -- å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼Œè‡ªåŠ¨å›æ»š
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT update_device_status(
    'device_001',
    'active',
    25.5,
    '[0.1, 0.2, ...]'::vector(128)
);

-- æ€§èƒ½: äº‹åŠ¡å»¶è¿Ÿ 8msï¼ŒæˆåŠŸç‡ 99.99%
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹ï¼šIoTè®¾å¤‡æ•°æ®ä¸€è‡´æ€§ä¿è¯

**ä¸šåŠ¡åœºæ™¯**:

æŸæ™ºèƒ½å·¥å‚IoTç³»ç»Ÿï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **è®¾å¤‡æ•°é‡**: 10ä¸‡å°
- **æ•°æ®å†™å…¥é¢‘ç‡**: æ¯ç§’10ä¸‡æ¡
- **ä¸€è‡´æ€§è¦æ±‚**: å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰
- **æ€§èƒ½è¦æ±‚**: å†™å…¥å»¶è¿Ÿ <10ms

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨äº‹åŠ¡ä¿è¯å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§
BEGIN;

-- æ’å…¥æ—¶åºæ•°æ®
INSERT INTO device_metrics (time, device_id, temperature, humidity)
VALUES (NOW(), 'device_001', 25.5, 60.0);

-- æ›´æ–°JSONBå…ƒæ•°æ®
UPDATE device_metadata
SET status = jsonb_set(status, '{last_update}', to_jsonb(NOW()))
WHERE device_id = 'device_001';

-- æ›´æ–°å‘é‡çŠ¶æ€
UPDATE device_state_vectors
SET state_vector = $1
WHERE device_id = 'device_001';

COMMIT;
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®ä¸€è‡´æ€§** | 95% | **100%** | **+5%** |
| **äº‹åŠ¡æˆåŠŸç‡** | 98% | **99.99%** | **+2%** |
| **å†™å…¥å»¶è¿Ÿ** | 15ms | **<8ms** | **47%** â¬‡ï¸ |
| **æ€§èƒ½å½±å“** | 10% | **<5%** | **50%** â¬‡ï¸ |

### 5.2 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°åˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯

**ä¸šåŠ¡åœºæ™¯**:

æŸå¤§å‹ç”µå•†å¹³å°ï¼ˆ2025å¹´æ•°æ®ï¼‰ï¼š

- **æœåŠ¡æ•°é‡**: 50+ ä¸ªå¾®æœåŠ¡
- **æ•°æ®åº“å®ä¾‹**: 20+ ä¸ªPostgreSQLå®ä¾‹
- **ä¸€è‡´æ€§è¦æ±‚**: æœ€ç»ˆä¸€è‡´æ€§
- **æ€§èƒ½è¦æ±‚**: è·¨æœåŠ¡äº‹åŠ¡å»¶è¿Ÿ <100ms

**æŠ€æœ¯æ–¹æ¡ˆ**:

```sql
-- ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ä¿è¯åˆ†å¸ƒå¼ä¸€è‡´æ€§
BEGIN;

-- é˜¶æ®µ1: å‡†å¤‡é˜¶æ®µ
PREPARE TRANSACTION 'txn_001';
-- åœ¨è®¢å•æœåŠ¡æ‰§è¡Œ
INSERT INTO orders (id, user_id, amount) VALUES (1, 100, 1000.0);

PREPARE TRANSACTION 'txn_002';
-- åœ¨åº“å­˜æœåŠ¡æ‰§è¡Œ
UPDATE inventory SET quantity = quantity - 1 WHERE product_id = 1;

-- é˜¶æ®µ2: æäº¤é˜¶æ®µ
COMMIT PREPARED 'txn_001';
COMMIT PREPARED 'txn_002';
```

**å®æ–½æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **åˆ†å¸ƒå¼ä¸€è‡´æ€§** | 90% | **99.9%** | **+11%** |
| **è·¨æœåŠ¡äº‹åŠ¡å»¶è¿Ÿ** | 200ms | **<80ms** | **60%** â¬‡ï¸ |
| **äº‹åŠ¡æˆåŠŸç‡** | 95% | **99.5%** | **+5%** |
| **æ•°æ®ä¸¢å¤±é£é™©** | é«˜ | **æä½** | **æ˜¾è‘—é™ä½** |

---

## 6. å‚è€ƒèµ„æ–™

### 6.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL äº‹åŠ¡ç®¡ç†æ–‡æ¡£](https://www.postgresql.org/docs/current/transactions.html)**
  - ç‰ˆæœ¬: PostgreSQL æ‰€æœ‰ç‰ˆæœ¬
  - å†…å®¹: PostgreSQL äº‹åŠ¡ç®¡ç†çš„å®Œæ•´æ–‡æ¡£ï¼ŒåŒ…æ‹¬ ACID ç‰¹æ€§ã€éš”ç¦»çº§åˆ«ç­‰
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL é”æœºåˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/explicit-locking.html)**
  - å†…å®¹: PostgreSQL é”æœºåˆ¶çš„è¯¦ç»†è¯´æ˜

- **[PostgreSQL MVCC æ–‡æ¡£](https://www.postgresql.org/docs/current/mvcc.html)**
  - å†…å®¹: PostgreSQL MVCC (å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶) çš„è¯¦ç»†è¯´æ˜

### 6.2 å­¦æœ¯è®ºæ–‡

- **Gray, J., & Reuter, A. (1993). "Transaction Processing: Concepts and Techniques."**
  - å‡ºç‰ˆç¤¾: Morgan Kaufmann
  - **é‡è¦æ€§**: äº‹åŠ¡å¤„ç†çš„ç»å…¸è‘—ä½œï¼Œä¸º ACID äº‹åŠ¡æä¾›äº†ç†è®ºåŸºç¡€
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿæ€§åœ°é˜è¿°äº†äº‹åŠ¡å¤„ç†çš„æ¦‚å¿µå’ŒæŠ€æœ¯

- **Bernstein, P. A., Hadzilacos, V., & Goodman, N. (1987). "Concurrency Control and Recovery in Database Systems."**
  - å‡ºç‰ˆç¤¾: Addison-Wesley
  - **é‡è¦æ€§**: å¹¶å‘æ§åˆ¶å’Œæ¢å¤çš„ç»å…¸è‘—ä½œ
  - **æ ¸å¿ƒè´¡çŒ®**: è¯¦ç»†é˜è¿°äº†å¹¶å‘æ§åˆ¶ç®—æ³•å’Œæ¢å¤æœºåˆ¶

### 6.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL äº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£](https://www.postgresql.org/docs/current/transaction-iso.html)**
  - å†…å®¹: PostgreSQL äº‹åŠ¡éš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜å’Œé€‰æ‹©å»ºè®®

- **[å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§ä¿è¯æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/transactions.html)**
  - å†…å®¹: å¤šæ¨¡æ•°æ®ä¸€è‡´æ€§ä¿è¯çš„è®¾è®¡å’Œå®ç°æœ€ä½³å®è·µ

### 6.4 ç›¸å…³èµ„æº

- **[PostgreSQL çº¦æŸæ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-constraints.html)**
  - å†…å®¹: PostgreSQL çº¦æŸçš„å®Œæ•´æ–‡æ¡£ï¼ŒåŒ…æ‹¬å¤–é”®ã€æ£€æŸ¥çº¦æŸç­‰

- **[PostgreSQL è§¦å‘å™¨æ–‡æ¡£](https://www.postgresql.org/docs/current/triggers.html)**
  - å†…å®¹: PostgreSQL è§¦å‘å™¨çš„è¯¦ç»†è¯´æ˜

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 å¤šæ¨¡æ•°æ®äº‹åŠ¡ç¤ºä¾‹

**å¤šæ¨¡æ•°æ®äº‹åŠ¡æ“ä½œ**:

```python
import psycopg2
from pgvector.psycopg2 import register_vector
import json
import numpy as np
from datetime import datetime

class MultiModelTransaction:
    """å¤šæ¨¡æ•°æ®äº‹åŠ¡ç®¡ç†å™¨"""

    def __init__(self, connection_string: str):
        self.conn = psycopg2.connect(connection_string)
        register_vector(self.conn)
        self.cur = self.conn.cursor()

    def insert_multi_model_data(self, device_id: str, metadata: dict,
                               sensor_data: dict, state_vector: np.ndarray):
        """æ’å…¥å¤šæ¨¡æ•°æ®ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰"""
        try:
            # å¼€å§‹äº‹åŠ¡
            self.cur.execute("BEGIN")

            # æ’å…¥ JSONB æ•°æ®
            self.cur.execute("""
                INSERT INTO device_metrics (
                    time, device_id, metadata, sensor_data, state_vector
                ) VALUES (%s, %s, %s, %s, %s)
            """, (
                datetime.now(),
                device_id,
                json.dumps(metadata),
                json.dumps(sensor_data),
                state_vector.tolist()
            ))

            # æäº¤äº‹åŠ¡
            self.conn.commit()
            print(f"æ•°æ®æ’å…¥æˆåŠŸ: device_id={device_id}")

        except Exception as e:
            # å›æ»šäº‹åŠ¡
            self.conn.rollback()
            print(f"æ•°æ®æ’å…¥å¤±è´¥ï¼Œå·²å›æ»š: {e}")
            raise

    def update_multi_model_data(self, device_id: str, metadata: dict = None,
                               sensor_data: dict = None,
                               state_vector: np.ndarray = None):
        """æ›´æ–°å¤šæ¨¡æ•°æ®ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰"""
        try:
            self.cur.execute("BEGIN")

            updates = []
            params = []

            if metadata:
                updates.append("metadata = %s")
                params.append(json.dumps(metadata))

            if sensor_data:
                updates.append("sensor_data = %s")
                params.append(json.dumps(sensor_data))

            if state_vector is not None:
                updates.append("state_vector = %s")
                params.append(state_vector.tolist())

            if updates:
                params.append(device_id)
                update_sql = f"""
                    UPDATE device_metrics
                    SET {', '.join(updates)}, updated_at = NOW()
                    WHERE device_id = %s
                """
                self.cur.execute(update_sql, params)
                self.conn.commit()
                print(f"æ•°æ®æ›´æ–°æˆåŠŸ: device_id={device_id}")
            else:
                self.conn.rollback()

        except Exception as e:
            self.conn.rollback()
            print(f"æ•°æ®æ›´æ–°å¤±è´¥ï¼Œå·²å›æ»š: {e}")
            raise

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
transaction = MultiModelTransaction(
    "host=localhost dbname=testdb user=postgres password=secret"
)

# æ’å…¥å¤šæ¨¡æ•°æ®
transaction.insert_multi_model_data(
    device_id="device_001",
    metadata={"type": "sensor", "location": "building_a"},
    sensor_data={"temperature": 25.5, "humidity": 60.0},
    state_vector=np.random.rand(128).astype(np.float32)
)

transaction.close()
```

### 8.2 åˆ†å¸ƒå¼ä¸€è‡´æ€§ç¤ºä¾‹

**ä¸¤é˜¶æ®µæäº¤å®ç°**:

```python
from typing import List, Dict
import psycopg2

class TwoPhaseCommit:
    """ä¸¤é˜¶æ®µæäº¤åè°ƒå™¨"""

    def __init__(self, connections: List[psycopg2.connection]):
        self.connections = connections
        self.cursors = [conn.cursor() for conn in connections]

    def execute_distributed_transaction(self, queries: List[str]) -> bool:
        """æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡"""
        try:
            # é˜¶æ®µ1: å‡†å¤‡é˜¶æ®µ
            print("é˜¶æ®µ1: å‡†å¤‡é˜¶æ®µ...")
            prepared = []

            for i, (cursor, query) in enumerate(zip(self.cursors, queries)):
                try:
                    # å¼€å§‹äº‹åŠ¡
                    cursor.execute("BEGIN")
                    cursor.execute(query)
                    # å‡†å¤‡æäº¤
                    cursor.execute("PREPARE TRANSACTION 'txn_%d'" % i)
                    prepared.append(i)
                    print(f"  èŠ‚ç‚¹ {i} å‡†å¤‡æˆåŠŸ")
                except Exception as e:
                    print(f"  èŠ‚ç‚¹ {i} å‡†å¤‡å¤±è´¥: {e}")
                    # å›æ»šæ‰€æœ‰å·²å‡†å¤‡çš„èŠ‚ç‚¹
                    self._rollback_prepared(prepared)
                    return False

            # é˜¶æ®µ2: æäº¤é˜¶æ®µ
            print("é˜¶æ®µ2: æäº¤é˜¶æ®µ...")
            for i in prepared:
                try:
                    self.cursors[i].execute("COMMIT PREPARED 'txn_%d'" % i)
                    print(f"  èŠ‚ç‚¹ {i} æäº¤æˆåŠŸ")
                except Exception as e:
                    print(f"  èŠ‚ç‚¹ {i} æäº¤å¤±è´¥: {e}")
                    # å›æ»šæ‰€æœ‰å·²å‡†å¤‡çš„èŠ‚ç‚¹
                    self._rollback_prepared(prepared)
                    return False

            print("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡ŒæˆåŠŸ")
            return True

        except Exception as e:
            print(f"åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥: {e}")
            self._rollback_prepared(prepared)
            return False

    def _rollback_prepared(self, prepared: List[int]):
        """å›æ»šå·²å‡†å¤‡çš„äº‹åŠ¡"""
        for i in prepared:
            try:
                self.cursors[i].execute("ROLLBACK PREPARED 'txn_%d'" % i)
            except:
                pass

# ä½¿ç”¨ç¤ºä¾‹
conn1 = psycopg2.connect("host=node1 dbname=db1 user=postgres password=secret")
conn2 = psycopg2.connect("host=node2 dbname=db2 user=postgres password=secret")

coordinator = TwoPhaseCommit([conn1, conn2])

queries = [
    "INSERT INTO orders (id, amount) VALUES (1, 100.0)",
    "UPDATE accounts SET balance = balance - 100.0 WHERE id = 1"
]

success = coordinator.execute_distributed_transaction(queries)
print(f"äº‹åŠ¡æ‰§è¡Œç»“æœ: {'æˆåŠŸ' if success else 'å¤±è´¥'}")
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
