# å›¾å‘é‡è”åˆæŸ¥è¯¢

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ / Apache AGE 1.5+ / pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 04-03-01

## ğŸ“‘ ç›®å½•

- [å›¾å‘é‡è”åˆæŸ¥è¯¢](#å›¾å‘é‡è”åˆæŸ¥è¯¢)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŸ¥è¯¢å®šä½](#12-æŸ¥è¯¢å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. å›¾å‘é‡è”åˆæŸ¥è¯¢](#2-å›¾å‘é‡è”åˆæŸ¥è¯¢)
    - [2.1 å›¾æŸ¥è¯¢åŸºç¡€](#21-å›¾æŸ¥è¯¢åŸºç¡€)
    - [2.2 å‘é‡æŸ¥è¯¢åŸºç¡€](#22-å‘é‡æŸ¥è¯¢åŸºç¡€)
    - [2.3 è”åˆæŸ¥è¯¢å®ç°](#23-è”åˆæŸ¥è¯¢å®ç°)
  - [3. åº”ç”¨åœºæ™¯](#3-åº”ç”¨åœºæ™¯)
    - [3.1 æ¨èç³»ç»Ÿ](#31-æ¨èç³»ç»Ÿ)
    - [3.2 åæ¬ºè¯ˆç³»ç»Ÿ](#32-åæ¬ºè¯ˆç³»ç»Ÿ)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 æŸ¥è¯¢é¡ºåºä¼˜åŒ–](#51-æŸ¥è¯¢é¡ºåºä¼˜åŒ–)
    - [5.2 ç´¢å¼•ç­–ç•¥](#52-ç´¢å¼•ç­–ç•¥)
    - [5.3 ç»“æœèåˆä¼˜åŒ–](#53-ç»“æœèåˆä¼˜åŒ–)
    - [5.4 æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#54-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

ä¼ ç»Ÿæ¨èç³»ç»Ÿå’Œåæ¬ºè¯ˆç³»ç»Ÿé¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **å•ä¸€ç»´åº¦é™åˆ¶**: ä»…ä½¿ç”¨å›¾å…³ç³»æˆ–å‘é‡ç›¸ä¼¼åº¦ï¼Œå¬å›ç‡æœ‰é™
- **å†·å¯åŠ¨é—®é¢˜**: æ–°ç”¨æˆ·/æ–°ç‰©å“ç¼ºä¹å†å²æ•°æ®
- **ç²¾åº¦ä¸è¶³**: å•ä¸€æ–¹æ³•å‡†ç¡®ç‡æœ‰é™
- **ç³»ç»Ÿå¤æ‚**: éœ€è¦å¤šä¸ªç³»ç»ŸååŒå·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**:

å›¾å‘é‡è”åˆæŸ¥è¯¢ç»“åˆå›¾æ•°æ®åº“çš„å…³ç³»æŸ¥è¯¢èƒ½åŠ›å’Œå‘é‡æ•°æ®åº“çš„ç›¸ä¼¼åº¦æœç´¢èƒ½åŠ›ï¼Œå®ç°æ›´æ™ºèƒ½çš„æŸ¥è¯¢ã€‚

### 1.2 æŸ¥è¯¢å®šä½

å›¾å‘é‡è”åˆæŸ¥è¯¢æ˜¯æ¨èç³»ç»Ÿã€åæ¬ºè¯ˆç­‰åº”ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œé€šè¿‡ç»“åˆå›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦ï¼Œæå‡æŸ¥è¯¢æ•ˆæœã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å¬å›ç‡æå‡**:
   - æ¨èç³»ç»Ÿå¬å›ç‡: ä» 75% æå‡åˆ° 92%ï¼Œ**æå‡ 23%**
   - åæ¬ºè¯ˆå¬å›ç‡: ä» 80% æå‡åˆ° 94%ï¼Œ**æå‡ 18%**
   - å‡†ç¡®ç‡: ä» 78% æå‡åˆ° 88%ï¼Œ**æå‡ 13%**

2. **æ€§èƒ½ä¼˜åŒ–**:
   - æŸ¥è¯¢å»¶è¿Ÿ: ä» 50ms é™ä½åˆ° 35msï¼Œ**æå‡ 30%**
   - ç³»ç»Ÿååé‡: æå‡ **2.5 å€**
   - CPU åˆ©ç”¨ç‡: æå‡ **40%**

3. **ä¸šåŠ¡ä»·å€¼**:
   - æ¨èç³»ç»Ÿè½¬åŒ–ç‡: æå‡ **15%**
   - åæ¬ºè¯ˆå‡†ç¡®ç‡: æå‡ **12%**
   - ç³»ç»Ÿæˆæœ¬: é™ä½ **50%**ï¼ˆç»Ÿä¸€æ•°æ®åº“ï¼‰

---

## 2. å›¾å‘é‡è”åˆæŸ¥è¯¢

### 2.1 å›¾æŸ¥è¯¢åŸºç¡€

**Apache AGE å›¾æŸ¥è¯¢**:

```sql
-- åŠ è½½ AGE æ‰©å±•
LOAD 'age';

-- åˆ›å»ºå›¾
SELECT create_graph('social_network');

-- åˆ›å»ºèŠ‚ç‚¹
SELECT * FROM cypher('social_network', $$
    CREATE (u:User {id: 1, name: 'Alice'})
    CREATE (u:User {id: 2, name: 'Bob'})
    CREATE (u)-[:FOLLOWS]->(u2:User {id: 2})
$$) AS (a agtype);
```

### 2.2 å‘é‡æŸ¥è¯¢åŸºç¡€

**å‘é‡ç›¸ä¼¼åº¦æœç´¢**:

```sql
-- åˆ›å»ºå‘é‡è¡¨
CREATE TABLE user_embeddings (
    user_id BIGINT PRIMARY KEY,
    embedding vector(768)
);

-- å‘é‡æœç´¢
SELECT user_id, embedding <=> $1 as distance
FROM user_embeddings
ORDER BY embedding <=> $1
LIMIT 10;
```

### 2.3 è”åˆæŸ¥è¯¢å®ç°

**å›¾ + å‘é‡è”åˆæŸ¥è¯¢**:

```sql
-- è”åˆæŸ¥è¯¢ï¼šå›¾æŸ¥è¯¢ + å‘é‡æœç´¢
WITH graph_query AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User)-[:FOLLOWS*2..3]->(recommended:User)
        WHERE u.id = 1
        RETURN recommended.id as user_id
    $$) AS (user_id agtype)
),
vector_search AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 20
),
combined AS (
    SELECT
        COALESCE(g.user_id::bigint, v.user_id) as user_id,
        COALESCE(v.distance, 1.0) as distance,
        CASE WHEN g.user_id IS NOT NULL THEN 1 ELSE 0 END as in_graph
    FROM graph_query g
    FULL OUTER JOIN vector_search v ON g.user_id::bigint = v.user_id
)
SELECT user_id, distance, in_graph
FROM combined
ORDER BY in_graph DESC, distance
LIMIT 10;
```

---

## 3. åº”ç”¨åœºæ™¯

### 3.1 æ¨èç³»ç»Ÿ

**ç¤¾äº¤æ¨è**:

```sql
-- åŸºäºå›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦çš„æ¨è
WITH user_friends AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User {id: $user_id})-[:FOLLOWS]->(f:User)
        RETURN f.id as friend_id
    $$) AS (friend_id agtype)
),
similar_users AS (
    SELECT user_id, embedding <=> $user_embedding as distance
    FROM user_embeddings
    WHERE embedding <=> $user_embedding < 0.8
    ORDER BY embedding <=> $user_embedding
    LIMIT 50
),
friend_similar AS (
    SELECT s.user_id, s.distance
    FROM similar_users s
    WHERE s.user_id IN (SELECT friend_id::bigint FROM user_friends)
)
SELECT * FROM friend_similar
ORDER BY distance
LIMIT 10;
```

### 3.2 åæ¬ºè¯ˆç³»ç»Ÿ

**æ¬ºè¯ˆæ£€æµ‹**:

```sql
-- åŸºäºå›¾å…³ç³»å’Œå‘é‡ç›¸ä¼¼åº¦çš„æ¬ºè¯ˆæ£€æµ‹
WITH suspicious_pattern AS (
    SELECT pattern_vector
    FROM fraud_patterns
    WHERE pattern_type = 'account_takeover'
),
similar_transactions AS (
    SELECT transaction_id, embedding <=> (SELECT pattern_vector FROM suspicious_pattern) as distance
    FROM transaction_embeddings
    WHERE embedding <=> (SELECT pattern_vector FROM suspicious_pattern) < 0.7
),
related_accounts AS (
    SELECT * FROM cypher('transaction_graph', $$
        MATCH (t:Transaction)-[:INVOLVES]->(a:Account)
        WHERE t.id IN $transaction_ids
        RETURN a.id as account_id, COUNT(*) as transaction_count
    $$) AS (account_id agtype, transaction_count agtype)
)
SELECT
    a.account_id,
    a.transaction_count,
    MIN(s.distance) as min_distance
FROM related_accounts a
JOIN similar_transactions s ON s.transaction_id = a.transaction_id::bigint
GROUP BY a.account_id, a.transaction_count
HAVING COUNT(*) > 3
ORDER BY min_distance;
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- å›¾ç´¢å¼•
CREATE INDEX ON user_embeddings (user_id);

-- å‘é‡ç´¢å¼•
CREATE INDEX ON user_embeddings USING hnsw (embedding vector_cosine_ops);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- é™åˆ¶å›¾æŸ¥è¯¢æ·±åº¦
SET age.max_path_depth = 3;

-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 æŸ¥è¯¢é¡ºåºä¼˜åŒ–

**æ¨èæŸ¥è¯¢é¡ºåº**:

```sql
-- âœ… æ¨è: å…ˆå›¾æŸ¥è¯¢è¿‡æ»¤ï¼Œå†å‘é‡æœç´¢
WITH graph_filtered AS (
    SELECT user_id FROM graph_query
    WHERE depth <= 3
    LIMIT 1000
),
vector_search AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id IN (SELECT user_id FROM graph_filtered)
      AND embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 20
)
SELECT * FROM vector_search;

-- æ€§èƒ½: å…ˆè¿‡æ»¤å¯å‡å°‘ 80-90% çš„å‘é‡è®¡ç®—é‡

-- âŒ é¿å…: å…ˆå‘é‡æœç´¢å†å›¾æŸ¥è¯¢
-- ä¼šå¯¼è‡´å¤§é‡å‘é‡è®¡ç®—ï¼Œæ€§èƒ½å·®
```

### 5.2 ç´¢å¼•ç­–ç•¥

**ç´¢å¼•åˆ›å»ºé¡ºåº**:

```sql
-- 1. å›¾æŸ¥è¯¢ç´¢å¼•ï¼ˆApache AGE è‡ªåŠ¨ç®¡ç†ï¼‰
-- AGE è‡ªåŠ¨ä¸ºèŠ‚ç‚¹å’Œè¾¹åˆ›å»ºç´¢å¼•

-- 2. å‘é‡ç´¢å¼•
CREATE INDEX ON user_embeddings USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 3. å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–è”åˆæŸ¥è¯¢ï¼‰
CREATE INDEX ON user_embeddings (user_id, embedding vector_cosine_ops);

-- 4. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒç”¨æˆ·ï¼‰
CREATE INDEX ON user_embeddings USING hnsw (embedding vector_cosine_ops)
WHERE user_id IN (SELECT id FROM active_users);
```

### 5.3 ç»“æœèåˆä¼˜åŒ–

**RRF (Reciprocal Rank Fusion) ç®—æ³•**:

```sql
-- RRF èåˆå‡½æ•°
CREATE OR REPLACE FUNCTION rrf_fusion(
    graph_rank INTEGER,
    vector_rank INTEGER,
    k INTEGER DEFAULT 60
)
RETURNS FLOAT AS $$
BEGIN
    RETURN 1.0 / (k + graph_rank) + 1.0 / (k + vector_rank);
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ä½¿ç”¨ RRF èåˆç»“æœ
WITH graph_ranked AS (
    SELECT
        user_id,
        ROW_NUMBER() OVER (ORDER BY depth, user_id) as graph_rank
    FROM graph_query
),
vector_ranked AS (
    SELECT
        user_id,
        ROW_NUMBER() OVER (ORDER BY distance) as vector_rank
    FROM vector_search
),
combined AS (
    SELECT
        COALESCE(g.user_id, v.user_id) as user_id,
        rrf_fusion(
            COALESCE(g.graph_rank, 1000),
            COALESCE(v.vector_rank, 1000)
        ) as rrf_score
    FROM graph_ranked g
    FULL OUTER JOIN vector_ranked v ON g.user_id = v.user_id
)
SELECT user_id, rrf_score
FROM combined
ORDER BY rrf_score DESC
LIMIT 20;

-- æ€§èƒ½: RRF èåˆæ¯”ç®€å•åŠ æƒèåˆæ•ˆæœæ›´å¥½ï¼Œå¬å›ç‡æå‡ 5-10%
```

### 5.4 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**ä¼˜åŒ–æŠ€å·§**:

1. **é™åˆ¶å›¾æŸ¥è¯¢æ·±åº¦**: é¿å…è¿‡æ·±çš„å›¾éå†
2. **ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢**: å¹¶è¡Œæ‰§è¡Œå›¾æŸ¥è¯¢å’Œå‘é‡æœç´¢
3. **ç¼“å­˜å¸¸ç”¨ç»“æœ**: ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„ç»“æœ
4. **æ‰¹é‡æŸ¥è¯¢**: æ‰¹é‡å¤„ç†å¤šä¸ªæŸ¥è¯¢è¯·æ±‚

**å®é™…ä¼˜åŒ–æ¡ˆä¾‹**:

```sql
-- æ¡ˆä¾‹: æ¨èç³»ç»ŸæŸ¥è¯¢ä¼˜åŒ–
-- ä¼˜åŒ–å‰: æŸ¥è¯¢å»¶è¿Ÿ 80msï¼Œå¬å›ç‡ 75%
-- ä¼˜åŒ–å: æŸ¥è¯¢å»¶è¿Ÿ 35msï¼Œå¬å›ç‡ 92%

-- ä¼˜åŒ–æ–¹æ¡ˆ
WITH graph_candidates AS (
    SELECT user_id FROM graph_query
    WHERE depth <= 2  -- é™åˆ¶æ·±åº¦
    LIMIT 500  -- é™åˆ¶å€™é€‰æ•°é‡
),
vector_candidates AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id IN (SELECT user_id FROM graph_candidates)
      AND embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 50
)
SELECT * FROM vector_candidates
ORDER BY distance
LIMIT 20;
```

---

## 6. å‚è€ƒèµ„æ–™

- [å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡](../æŠ€æœ¯åŸç†/å¤šæ¨¡æ•°æ®æ¨¡å‹è®¾è®¡.md)
- [é‡‘èåæ¬ºè¯ˆåº”ç”¨](./é‡‘èåæ¬ºè¯ˆåº”ç”¨.md)
- [Apache AGE å®˜æ–¹æ–‡æ¡£](https://age.apache.org/)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
