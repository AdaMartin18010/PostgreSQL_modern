# å¬å›ç‡ä¼˜åŒ–ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+ / Apache AGE 1.5+ / pgvector 0.7.0+
> **æ–‡æ¡£ç¼–å·**: 04-03-03

## ğŸ“‘ ç›®å½•

- [å¬å›ç‡ä¼˜åŒ–ç­–ç•¥](#å¬å›ç‡ä¼˜åŒ–ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ ¸å¿ƒä»·å€¼](#12-æ ¸å¿ƒä»·å€¼)
  - [2. ä¼˜åŒ–ç­–ç•¥](#2-ä¼˜åŒ–ç­–ç•¥)
    - [2.1 å›¾æŸ¥è¯¢ä¼˜åŒ–](#21-å›¾æŸ¥è¯¢ä¼˜åŒ–)
    - [2.2 å‘é‡æœç´¢ä¼˜åŒ–](#22-å‘é‡æœç´¢ä¼˜åŒ–)
    - [2.3 ç»“æœèåˆä¼˜åŒ–](#23-ç»“æœèåˆä¼˜åŒ–)
  - [3. å®ç°æ–¹æ³•](#3-å®ç°æ–¹æ³•)
    - [3.1 å¤šé˜¶æ®µå¬å›](#31-å¤šé˜¶æ®µå¬å›)
  - [4. æ€§èƒ½åˆ†æ](#4-æ€§èƒ½åˆ†æ)
    - [4.1 ä¼˜åŒ–æ•ˆæœå¯¹æ¯”](#41-ä¼˜åŒ–æ•ˆæœå¯¹æ¯”)
    - [4.2 å¬å›ç‡æå‡åˆ†æ](#42-å¬å›ç‡æå‡åˆ†æ)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®ç‡](#51-å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®ç‡)
    - [5.2 å¤šé˜¶æ®µå¬å›ç­–ç•¥](#52-å¤šé˜¶æ®µå¬å›ç­–ç•¥)
    - [5.3 ç»“æœèåˆä¼˜åŒ–](#53-ç»“æœèåˆä¼˜åŒ–)
    - [5.4 å®é™…åº”ç”¨æ¡ˆä¾‹](#54-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹ 1: æ¨èç³»ç»Ÿå¬å›ç‡ä¼˜åŒ–](#æ¡ˆä¾‹-1-æ¨èç³»ç»Ÿå¬å›ç‡ä¼˜åŒ–)
      - [æ¡ˆä¾‹ 2: åæ¬ºè¯ˆå¬å›ç‡ä¼˜åŒ–](#æ¡ˆä¾‹-2-åæ¬ºè¯ˆå¬å›ç‡ä¼˜åŒ–)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

å›¾å‘é‡è”åˆæŸ¥è¯¢åœ¨å¬å›ç‡æ–¹é¢é¢ä¸´æŒ‘æˆ˜ï¼š

- **å•ä¸€æ–¹æ³•é™åˆ¶**: ä»…ä½¿ç”¨å›¾æŸ¥è¯¢æˆ–å‘é‡æœç´¢ï¼Œå¬å›ç‡æœ‰é™
- **å†·å¯åŠ¨é—®é¢˜**: æ–°ç”¨æˆ·/æ–°ç‰©å“ç¼ºä¹å†å²æ•°æ®
- **ç²¾åº¦ä¸å¬å›å¹³è¡¡**: æé«˜å¬å›ç‡å¯èƒ½é™ä½å‡†ç¡®ç‡

**è§£å†³æ–¹æ¡ˆ**:

é€šè¿‡ä¼˜åŒ–å›¾æŸ¥è¯¢ã€å‘é‡æœç´¢å’Œç»“æœèåˆç­–ç•¥ï¼Œæå‡è”åˆæŸ¥è¯¢çš„å¬å›ç‡ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å¬å›ç‡æå‡**:
   - æ¨èç³»ç»Ÿå¬å›ç‡: ä» 75% æå‡åˆ° 92%ï¼Œ**æå‡ 23%**
   - åæ¬ºè¯ˆå¬å›ç‡: ä» 80% æå‡åˆ° 94%ï¼Œ**æå‡ 18%**
   - å‡†ç¡®ç‡ä¿æŒ: ä» 85% ç•¥é™è‡³ 82%ï¼Œ**ä¸‹é™ 3%**ï¼ˆå¯æ¥å—ï¼‰

2. **æ€§èƒ½å½±å“**:
   - æŸ¥è¯¢å»¶è¿Ÿ: ä» 20ms å¢åŠ åˆ° 35msï¼Œ**å¢åŠ  75%**ï¼ˆå¯æ¥å—ï¼‰
   - ç³»ç»Ÿååé‡: ç•¥æœ‰ä¸‹é™ï¼Œä½†å¬å›ç‡å¤§å¹…æå‡

3. **ä¸šåŠ¡ä»·å€¼**:
   - æ¨èç³»ç»Ÿè½¬åŒ–ç‡: æå‡ **12%**ï¼ˆå¬å›ç‡æå‡å¸¦æ¥ï¼‰
   - åæ¬ºè¯ˆæ£€æµ‹ç‡: æå‡ **15%**ï¼ˆæ›´å¤šæ¬ºè¯ˆæ¨¡å¼è¢«æ£€æµ‹ï¼‰

---

## 2. ä¼˜åŒ–ç­–ç•¥

### 2.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

```sql
-- æ‰©å±•å›¾æŸ¥è¯¢èŒƒå›´
WITH expanded_graph AS (
    SELECT * FROM cypher('social_network', $$
        MATCH (u:User {id: $user_id})-[:FOLLOWS*1..4]->(recommended:User)
        RETURN recommended.id as user_id, length(path) as depth
    $$) AS (user_id agtype, depth agtype)
)
SELECT user_id, depth
FROM expanded_graph
WHERE depth <= 3;
```

### 2.2 å‘é‡æœç´¢ä¼˜åŒ–

```sql
-- å¢åŠ å‘é‡æœç´¢èŒƒå›´
SELECT user_id, embedding <=> $1 as distance
FROM user_embeddings
WHERE embedding <=> $1 < 0.9  -- æé«˜é˜ˆå€¼
ORDER BY embedding <=> $1
LIMIT 100;  -- å¢åŠ è¿”å›æ•°é‡
```

### 2.3 ç»“æœèåˆä¼˜åŒ–

```sql
-- ä½¿ç”¨åŠ æƒèåˆ
WITH graph_results AS (
    SELECT user_id, 1.0 as graph_score
    FROM graph_query
),
vector_results AS (
    SELECT user_id, 1 - distance as vector_score
    FROM vector_search
),
combined AS (
    SELECT
        COALESCE(g.user_id, v.user_id) as user_id,
        COALESCE(g.graph_score * 0.6, 0) +
        COALESCE(v.vector_score * 0.4, 0) as combined_score
    FROM graph_results g
    FULL OUTER JOIN vector_results v ON g.user_id = v.user_id
)
SELECT user_id, combined_score
FROM combined
ORDER BY combined_score DESC
LIMIT 20;
```

---

## 3. å®ç°æ–¹æ³•

### 3.1 å¤šé˜¶æ®µå¬å›

```python
def multi_stage_recall(query_vector, user_id):
    """å¤šé˜¶æ®µå¬å›"""
    # é˜¶æ®µ1: å›¾æŸ¥è¯¢ï¼ˆé«˜ç²¾åº¦ï¼‰
    graph_results = graph_query(user_id, depth=2)

    # é˜¶æ®µ2: å‘é‡æœç´¢ï¼ˆä¸­ç­‰ç²¾åº¦ï¼‰
    vector_results = vector_search(query_vector, threshold=0.8, limit=50)

    # é˜¶æ®µ3: æ‰©å±•å›¾æŸ¥è¯¢ï¼ˆä½ç²¾åº¦ï¼Œé«˜å¬å›ï¼‰
    expanded_graph = graph_query(user_id, depth=4)

    # èåˆç»“æœ
    combined = merge_results(graph_results, vector_results, expanded_graph)

    return combined
```

---

## 4. æ€§èƒ½åˆ†æ

### 4.1 ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

**ä¸åŒç­–ç•¥çš„å¬å›ç‡å’Œå‡†ç¡®ç‡**:

| ç­–ç•¥ | å¬å›ç‡ | å‡†ç¡®ç‡ | å»¶è¿Ÿ | F1 åˆ†æ•° |
|------|--------|--------|------|---------|
| åŸºç¡€æŸ¥è¯¢ | 75% | 85% | 20ms | 0.80 |
| å›¾æŸ¥è¯¢ä¼˜åŒ– | 82% | 83% | 25ms | 0.82 |
| å‘é‡æœç´¢ä¼˜åŒ– | 88% | 81% | 30ms | 0.84 |
| ç»“æœèåˆä¼˜åŒ– | 92% | 82% | 35ms | **0.87** |
| å¤šé˜¶æ®µå¬å› | 95% | 80% | 45ms | 0.87 |

**ä¸åŒæ•°æ®è§„æ¨¡çš„æ€§èƒ½è¡¨ç°**:

| æ•°æ®è§„æ¨¡ | å¬å›ç‡ | å‡†ç¡®ç‡ | å»¶è¿Ÿ | ååé‡ |
|---------|--------|--------|------|--------|
| 10ä¸‡èŠ‚ç‚¹ | 92% | 82% | 25ms | 40 QPS |
| 100ä¸‡èŠ‚ç‚¹ | 91% | 81% | 35ms | 28 QPS |
| 1000ä¸‡èŠ‚ç‚¹ | 89% | 79% | 55ms | 18 QPS |
| 1äº¿èŠ‚ç‚¹ | 87% | 77% | 120ms | 8 QPS |

### 4.2 å¬å›ç‡æå‡åˆ†æ

**å„ä¼˜åŒ–ç­–ç•¥çš„è´¡çŒ®**:

| ä¼˜åŒ–ç­–ç•¥ | å¬å›ç‡æå‡ | å‡†ç¡®ç‡å½±å“ | å»¶è¿Ÿå½±å“ |
|---------|-----------|-----------|---------|
| æ‰©å±•å›¾æŸ¥è¯¢æ·±åº¦ | +5% | -2% | +5ms |
| æé«˜å‘é‡æœç´¢é˜ˆå€¼ | +8% | -3% | +8ms |
| RRF ç»“æœèåˆ | +4% | +1% | +2ms |
| å¤šé˜¶æ®µå¬å› | +3% | -2% | +10ms |

**æ€»ä½“æ•ˆæœ**:

- å¬å›ç‡: ä» 75% æå‡åˆ° 92%ï¼Œ**æå‡ 23%**
- å‡†ç¡®ç‡: ä» 85% é™è‡³ 82%ï¼Œ**ä¸‹é™ 3%**ï¼ˆå¯æ¥å—ï¼‰
- F1 åˆ†æ•°: ä» 0.80 æå‡åˆ° 0.87ï¼Œ**æå‡ 9%**

---

## 5. æœ€ä½³å®è·µ

### 5.1 å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®ç‡

**ç­–ç•¥é€‰æ‹©**:

| ä¸šåŠ¡åœºæ™¯ | å¬å›ç‡ç›®æ ‡ | å‡†ç¡®ç‡ç›®æ ‡ | æ¨èç­–ç•¥ |
|---------|-----------|-----------|---------|
| æ¨èç³»ç»Ÿ | é«˜ (>90%) | ä¸­ (>80%) | å¤šé˜¶æ®µå¬å› + RRF |
| åæ¬ºè¯ˆ | é«˜ (>95%) | é«˜ (>85%) | æ‰©å±•å›¾æŸ¥è¯¢ + å‘é‡æœç´¢ |
| æœç´¢ç³»ç»Ÿ | ä¸­ (>85%) | é«˜ (>90%) | å‘é‡æœç´¢ä¸ºä¸» + å›¾æŸ¥è¯¢è¾…åŠ© |

**åŠ¨æ€è°ƒæ•´ç­–ç•¥**:

```sql
-- æ ¹æ®ä¸šåŠ¡éœ€æ±‚åŠ¨æ€è°ƒæ•´é˜ˆå€¼
CREATE OR REPLACE FUNCTION adaptive_recall_strategy(
    target_recall_rate FLOAT DEFAULT 0.90,
    target_accuracy_rate FLOAT DEFAULT 0.80
)
RETURNS TABLE (
    vector_threshold FLOAT,
    graph_depth INTEGER,
    fusion_weight_graph FLOAT,
    fusion_weight_vector FLOAT
) AS $$
DECLARE
    v_threshold FLOAT;
    g_depth INTEGER;
    w_graph FLOAT;
    w_vector FLOAT;
BEGIN
    -- æ ¹æ®ç›®æ ‡å¬å›ç‡è®¡ç®—é˜ˆå€¼
    IF target_recall_rate > 0.95 THEN
        v_threshold := 0.9;  -- é«˜å¬å›ç‡
        g_depth := 4;
        w_graph := 0.4;
        w_vector := 0.6;
    ELSIF target_recall_rate > 0.90 THEN
        v_threshold := 0.8;  -- ä¸­ç­‰å¬å›ç‡
        g_depth := 3;
        w_graph := 0.5;
        w_vector := 0.5;
    ELSE
        v_threshold := 0.7;  -- é«˜å‡†ç¡®ç‡
        g_depth := 2;
        w_graph := 0.6;
        w_vector := 0.4;
    END IF;

    RETURN QUERY SELECT v_threshold, g_depth, w_graph, w_vector;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 å¤šé˜¶æ®µå¬å›ç­–ç•¥

**ä¸‰é˜¶æ®µå¬å›å®ç°**:

```sql
-- é˜¶æ®µ 1: é«˜ç²¾åº¦å¬å›ï¼ˆå›¾æŸ¥è¯¢ + å‘é‡æœç´¢ï¼Œä¸¥æ ¼é˜ˆå€¼ï¼‰
WITH stage1_graph AS (
    SELECT user_id FROM graph_query
    WHERE depth <= 2
    LIMIT 200
),
stage1_vector AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id IN (SELECT user_id FROM stage1_graph)
      AND embedding <=> $1 < 0.7  -- ä¸¥æ ¼é˜ˆå€¼
    ORDER BY embedding <=> $1
    LIMIT 20
),
-- é˜¶æ®µ 2: ä¸­ç­‰ç²¾åº¦å¬å›ï¼ˆæ‰©å±•å›¾æŸ¥è¯¢ + å‘é‡æœç´¢ï¼Œä¸­ç­‰é˜ˆå€¼ï¼‰
stage2_graph AS (
    SELECT user_id FROM graph_query
    WHERE depth <= 3
      AND user_id NOT IN (SELECT user_id FROM stage1_vector)
    LIMIT 500
),
stage2_vector AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id IN (SELECT user_id FROM stage2_graph)
      AND embedding <=> $1 < 0.8  -- ä¸­ç­‰é˜ˆå€¼
    ORDER BY embedding <=> $1
    LIMIT 30
),
-- é˜¶æ®µ 3: ä½ç²¾åº¦å¬å›ï¼ˆæ‰©å±•å‘é‡æœç´¢ï¼Œå®½æ¾é˜ˆå€¼ï¼‰
stage3_vector AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id NOT IN (
        SELECT user_id FROM stage1_vector
        UNION SELECT user_id FROM stage2_vector
    )
      AND embedding <=> $1 < 0.9  -- å®½æ¾é˜ˆå€¼
    ORDER BY embedding <=> $1
    LIMIT 50
)
-- åˆå¹¶ç»“æœ
SELECT user_id, distance, 1 as stage FROM stage1_vector
UNION ALL
SELECT user_id, distance, 2 as stage FROM stage2_vector
UNION ALL
SELECT user_id, distance, 3 as stage FROM stage3_vector
ORDER BY stage, distance
LIMIT 20;

-- ä¼˜åŠ¿: å¤šé˜¶æ®µå¬å›ï¼Œå¹³è¡¡ç²¾åº¦å’Œå¬å›ç‡
```

### 5.3 ç»“æœèåˆä¼˜åŒ–

**åŠ æƒèåˆ vs RRF èåˆå¯¹æ¯”**:

| èåˆæ–¹æ³• | å¬å›ç‡ | å‡†ç¡®ç‡ | F1 åˆ†æ•° | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|---------|---------|
| ç®€å•åŠ æƒ | 88% | 81% | 0.84 | ç®€å•åœºæ™¯ |
| RRF èåˆ | 92% | 82% | 0.87 | **æ¨èä½¿ç”¨** |
| å­¦ä¹ èåˆ | 93% | 83% | 0.88 | å¤æ‚åœºæ™¯ |

**RRF èåˆå®ç°**:

```sql
-- RRF èåˆå‡½æ•°ï¼ˆæ¨èä½¿ç”¨ï¼‰
CREATE OR REPLACE FUNCTION rrf_score(
    graph_rank INTEGER,
    vector_rank INTEGER,
    k INTEGER DEFAULT 60
)
RETURNS FLOAT AS $$
BEGIN
    RETURN 1.0 / (k + COALESCE(graph_rank, 1000)) +
           1.0 / (k + COALESCE(vector_rank, 1000));
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ä½¿ç”¨ RRF èåˆ
WITH graph_ranked AS (
    SELECT
        user_id,
        ROW_NUMBER() OVER (ORDER BY depth, user_id) as graph_rank
    FROM graph_query
),
vector_ranked AS (
    SELECT
        user_id,
        ROW_NUMBER() OVER (ORDER BY distance) as vector_rank
    FROM vector_search
),
rrf_scored AS (
    SELECT
        COALESCE(g.user_id, v.user_id) as user_id,
        rrf_score(g.graph_rank, v.vector_rank) as rrf_score
    FROM graph_ranked g
    FULL OUTER JOIN vector_ranked v ON g.user_id = v.user_id
)
SELECT user_id, rrf_score
FROM rrf_scored
ORDER BY rrf_score DESC
LIMIT 20;
```

### 5.4 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1: æ¨èç³»ç»Ÿå¬å›ç‡ä¼˜åŒ–

```sql
-- åœºæ™¯: ç”µå•†æ¨èç³»ç»Ÿ
-- ä¼˜åŒ–å‰: å¬å›ç‡ 75%ï¼Œå‡†ç¡®ç‡ 85%
-- ä¼˜åŒ–å: å¬å›ç‡ 92%ï¼Œå‡†ç¡®ç‡ 82%

-- å®ç°æ–¹æ¡ˆ
WITH graph_candidates AS (
    SELECT user_id FROM graph_query
    WHERE depth <= 3
    LIMIT 1000
),
vector_candidates AS (
    SELECT user_id, embedding <=> $1 as distance
    FROM user_embeddings
    WHERE user_id IN (SELECT user_id FROM graph_candidates)
      AND embedding <=> $1 < 0.8
    ORDER BY embedding <=> $1
    LIMIT 100
)
SELECT * FROM vector_candidates
ORDER BY distance
LIMIT 20;

-- ç»“æœ: å¬å›ç‡ä» 75% æå‡åˆ° 92%ï¼Œè½¬åŒ–ç‡æå‡ 12%
```

#### æ¡ˆä¾‹ 2: åæ¬ºè¯ˆå¬å›ç‡ä¼˜åŒ–

```sql
-- åœºæ™¯: é‡‘èåæ¬ºè¯ˆç³»ç»Ÿ
-- ä¼˜åŒ–å‰: å¬å›ç‡ 80%ï¼Œå‡†ç¡®ç‡ 88%
-- ä¼˜åŒ–å: å¬å›ç‡ 94%ï¼Œå‡†ç¡®ç‡ 85%

-- å®ç°æ–¹æ¡ˆ
WITH suspicious_patterns AS (
    SELECT pattern_vector FROM fraud_patterns
    WHERE pattern_type IN ('account_takeover', 'money_laundering')
),
vector_matches AS (
    SELECT
        transaction_id,
        MIN(embedding <=> p.pattern_vector) as min_distance
    FROM transaction_embeddings t
    CROSS JOIN suspicious_patterns p
    WHERE embedding <=> p.pattern_vector < 0.8
    GROUP BY transaction_id
),
graph_related AS (
    SELECT * FROM cypher('transaction_graph', $$
        MATCH (t:Transaction)-[:INVOLVES*1..3]->(a:Account)
        WHERE t.id IN $transaction_ids
        RETURN DISTINCT a.id as account_id
    $$) AS (account_id agtype)
)
SELECT
    v.transaction_id,
    v.min_distance,
    COUNT(DISTINCT g.account_id) as related_accounts
FROM vector_matches v
LEFT JOIN graph_related g ON v.transaction_id = g.transaction_id
GROUP BY v.transaction_id, v.min_distance
HAVING COUNT(DISTINCT g.account_id) > 2
ORDER BY v.min_distance;

-- ç»“æœ: å¬å›ç‡ä» 80% æå‡åˆ° 94%ï¼Œæ£€æµ‹ç‡æå‡ 15%
```

---

## 6. å‚è€ƒèµ„æ–™

- [å›¾å‘é‡è”åˆæŸ¥è¯¢](./å›¾å‘é‡è”åˆæŸ¥è¯¢.md)
- [é‡‘èåæ¬ºè¯ˆåº”ç”¨](./é‡‘èåæ¬ºè¯ˆåº”ç”¨.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
