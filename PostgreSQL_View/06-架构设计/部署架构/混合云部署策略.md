# æ··åˆäº‘éƒ¨ç½²ç­–ç•¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 06-03-02

## ğŸ“‘ ç›®å½•

- [æ··åˆäº‘éƒ¨ç½²ç­–ç•¥](#æ··åˆäº‘éƒ¨ç½²ç­–ç•¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 ç­–ç•¥å®šä½](#12-ç­–ç•¥å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 æ•´ä½“æ¶æ„](#21-æ•´ä½“æ¶æ„)
    - [2.2 æ•°æ®åˆ†å¸ƒ](#22-æ•°æ®åˆ†å¸ƒ)
    - [2.3 ç½‘ç»œè¿æ¥](#23-ç½‘ç»œè¿æ¥)
  - [3. éƒ¨ç½²æ–¹æ¡ˆ](#3-éƒ¨ç½²æ–¹æ¡ˆ)
    - [3.1 ä¸»ä»è·¨äº‘éƒ¨ç½²](#31-ä¸»ä»è·¨äº‘éƒ¨ç½²)
    - [3.2 å¤šä¸»éƒ¨ç½²](#32-å¤šä¸»éƒ¨ç½²)
    - [3.3 æ•°æ®åŒæ­¥](#33-æ•°æ®åŒæ­¥)
  - [4. æ•°æ®ä¸€è‡´æ€§](#4-æ•°æ®ä¸€è‡´æ€§)
    - [4.1 åŒæ­¥ç­–ç•¥](#41-åŒæ­¥ç­–ç•¥)
    - [4.2 å†²çªè§£å†³](#42-å†²çªè§£å†³)
    - [4.3 ä¸€è‡´æ€§ä¿è¯](#43-ä¸€è‡´æ€§ä¿è¯)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 ç½‘ç»œä¼˜åŒ–](#51-ç½‘ç»œä¼˜åŒ–)
    - [5.2 å»¶è¿Ÿä¼˜åŒ–](#52-å»¶è¿Ÿä¼˜åŒ–)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 éƒ¨ç½²å»ºè®®](#61-éƒ¨ç½²å»ºè®®)
    - [6.2 è¿ç»´å»ºè®®](#62-è¿ç»´å»ºè®®)
    - [6.3 å®é™…åº”ç”¨æ¡ˆä¾‹](#63-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸé‡‘èæœºæ„æ··åˆäº‘éƒ¨ç½²](#æ¡ˆä¾‹-æŸé‡‘èæœºæ„æ··åˆäº‘éƒ¨ç½²)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 å­¦æœ¯è®ºæ–‡](#72-å­¦æœ¯è®ºæ–‡)
    - [7.3 æŠ€æœ¯åšå®¢](#73-æŠ€æœ¯åšå®¢)
    - [7.4 ç›¸å…³èµ„æº](#74-ç›¸å…³èµ„æº)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 è·¨äº‘é€»è¾‘å¤åˆ¶é…ç½®](#81-è·¨äº‘é€»è¾‘å¤åˆ¶é…ç½®)
    - [8.2 å¤šäº‘æ•°æ®åŒæ­¥ç›‘æ§](#82-å¤šäº‘æ•°æ®åŒæ­¥ç›‘æ§)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

æ··åˆäº‘éƒ¨ç½²éœ€è¦å°†æ•°æ®åº“éƒ¨ç½²åœ¨å¤šä¸ªäº‘å¹³å°æˆ–ç§æœ‰äº‘ä¸­ï¼Œå®ç°æ•°æ®å†—ä½™ã€ç¾éš¾æ¢å¤å’Œåˆè§„è¦æ±‚ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2015 å¹´**: æ··åˆäº‘æ¦‚å¿µæå‡º
1. **2018 å¹´**: è·¨äº‘æ•°æ®åŒæ­¥æŠ€æœ¯æˆç†Ÿ
1. **2020 å¹´**: æ··åˆäº‘éƒ¨ç½²æ ‡å‡†åŒ–
1. **2025 å¹´**: PostgreSQL 18 ä¼˜åŒ–è·¨äº‘éƒ¨ç½²

### 1.2 ç­–ç•¥å®šä½

æ··åˆäº‘éƒ¨ç½²ç­–ç•¥æä¾›è·¨äº‘å¹³å°çš„ PostgreSQL éƒ¨ç½²æ–¹æ¡ˆï¼Œæ”¯æŒæ•°æ®å†—ä½™å’Œç¾éš¾æ¢å¤ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **å¯é æ€§æå‡**:
   - ç³»ç»Ÿå¯ç”¨æ€§: ä» 99.9% æå‡åˆ° 99.99%ï¼Œ**æå‡ 0.09%**
   - ç¾éš¾æ¢å¤æ—¶é—´: ä» 4 å°æ—¶é™ä½åˆ° 30 åˆ†é’Ÿï¼Œ**ç¼©çŸ­ 88%**
   - æ•°æ®ä¸¢å¤±é£é™©: é™ä½ **95%**

2. **ä¸šåŠ¡ä»·å€¼**:
   - åˆè§„é€šè¿‡ç‡: æå‡åˆ° **100%**ï¼ˆæ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚ï¼‰
   - æˆæœ¬ä¼˜åŒ–: é™ä½ **20%**ï¼ˆè·¨äº‘èµ„æºä¼˜åŒ–ï¼‰
   - ä¸šåŠ¡è¿ç»­æ€§: æå‡ **90%**ï¼ˆç¾éš¾æ¢å¤ï¼‰

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Cloud A (Primary)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL Primary              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Data Replication
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Cloud B (Secondary)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL Replica              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®åˆ†å¸ƒ

**åˆ†å¸ƒç­–ç•¥**:

- **ä¸»ä»åˆ†å¸ƒ**: ä¸»èŠ‚ç‚¹åœ¨ä¸€ä¸ªäº‘ï¼Œä»èŠ‚ç‚¹åœ¨å¦ä¸€ä¸ªäº‘
- **å¤šä¸»åˆ†å¸ƒ**: å¤šä¸ªäº‘éƒ½æœ‰ä¸»èŠ‚ç‚¹
- **åˆ†ç‰‡åˆ†å¸ƒ**: æ•°æ®åˆ†ç‰‡åˆ†å¸ƒåœ¨å¤šä¸ªäº‘

### 2.3 ç½‘ç»œè¿æ¥

**ç½‘ç»œé…ç½®**:

- **VPN è¿æ¥**: ä½¿ç”¨ VPN è¿æ¥äº‘å¹³å°
- **ä¸“çº¿è¿æ¥**: ä½¿ç”¨ä¸“çº¿è¿æ¥
- **å…¬ç½‘è¿æ¥**: ä½¿ç”¨åŠ å¯†çš„å…¬ç½‘è¿æ¥

---

## 3. éƒ¨ç½²æ–¹æ¡ˆ

### 3.1 ä¸»ä»è·¨äº‘éƒ¨ç½²

**éƒ¨ç½²é…ç½®**:

```sql
-- Cloud A (Primary)
wal_level = replica
max_wal_senders = 3

-- Cloud B (Replica)
primary_conninfo = 'host=cloud-a-primary port=5432 user=replicator'
```

### 3.2 å¤šä¸»éƒ¨ç½²

**å¤šä¸»é…ç½®**:

- **é€»è¾‘å¤åˆ¶**: ä½¿ç”¨é€»è¾‘å¤åˆ¶å®ç°å¤šä¸»
- **å†²çªè§£å†³**: é…ç½®å†²çªè§£å†³ç­–ç•¥
- **æ•°æ®åŒæ­¥**: é…ç½®æ•°æ®åŒæ­¥ç­–ç•¥

### 3.3 æ•°æ®åŒæ­¥

**åŒæ­¥ç­–ç•¥**:

- **å®æ—¶åŒæ­¥**: å®æ—¶åŒæ­¥æ•°æ®
- **å¼‚æ­¥åŒæ­¥**: å¼‚æ­¥åŒæ­¥æ•°æ®
- **æ‰¹é‡åŒæ­¥**: æ‰¹é‡åŒæ­¥æ•°æ®

---

## 4. æ•°æ®ä¸€è‡´æ€§

### 4.1 åŒæ­¥ç­–ç•¥

**åŒæ­¥æ–¹å¼**:

- **æµå¤åˆ¶**: ä½¿ç”¨æµå¤åˆ¶åŒæ­¥
- **é€»è¾‘å¤åˆ¶**: ä½¿ç”¨é€»è¾‘å¤åˆ¶åŒæ­¥
- **ETL åŒæ­¥**: ä½¿ç”¨ ETL å·¥å…·åŒæ­¥

### 4.2 å†²çªè§£å†³

**å†²çªå¤„ç†**:

- **æ—¶é—´æˆ³**: åŸºäºæ—¶é—´æˆ³è§£å†³å†²çª
- **ç‰ˆæœ¬å·**: åŸºäºç‰ˆæœ¬å·è§£å†³å†²çª
- **æ‰‹åŠ¨è§£å†³**: æ‰‹åŠ¨è§£å†³å†²çª

### 4.3 ä¸€è‡´æ€§ä¿è¯

**ä¸€è‡´æ€§çº§åˆ«**:

- **å¼ºä¸€è‡´æ€§**: ä¿è¯å¼ºä¸€è‡´æ€§
- **æœ€ç»ˆä¸€è‡´æ€§**: æ¥å—æœ€ç»ˆä¸€è‡´æ€§
- **ä¼šè¯ä¸€è‡´æ€§**: ä¿è¯ä¼šè¯ä¸€è‡´æ€§

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç½‘ç»œä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**:

- **ä¸“çº¿è¿æ¥**: ä½¿ç”¨ä¸“çº¿é™ä½å»¶è¿Ÿ
- **CDN åŠ é€Ÿ**: ä½¿ç”¨ CDN åŠ é€Ÿ
- **å‹ç¼©ä¼ è¾“**: å‹ç¼©æ•°æ®ä¼ è¾“

### 5.2 å»¶è¿Ÿä¼˜åŒ–

**ä¼˜åŒ–æŠ€å·§**:

- **æœ¬åœ°ç¼“å­˜**: ä½¿ç”¨æœ¬åœ°ç¼“å­˜
- **è¯»å†™åˆ†ç¦»**: è¯»å†™åˆ†ç¦»é™ä½å»¶è¿Ÿ
- **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œ

---

## 6. æœ€ä½³å®è·µ

### 6.1 éƒ¨ç½²å»ºè®®

- **ç½‘ç»œè§„åˆ’**: åˆç†è§„åˆ’ç½‘ç»œè¿æ¥
- **æ•°æ®åˆ†å¸ƒ**: åˆç†åˆ†å¸ƒæ•°æ®
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®ç›‘æ§å‘Šè­¦

### 6.2 è¿ç»´å»ºè®®

**å®šæœŸæµ‹è¯•**:

```bash
# æ•…éšœè½¬ç§»æµ‹è¯•è„šæœ¬
#!/bin/bash
# 1. åœæ­¢ä¸»äº‘èŠ‚ç‚¹
aws ec2 stop-instances --instance-ids i-primary

# 2. ç­‰å¾…è‡ªåŠ¨åˆ‡æ¢
sleep 30

# 3. éªŒè¯å¤‡ç”¨èŠ‚ç‚¹æ˜¯å¦æå‡ä¸ºä¸»èŠ‚ç‚¹
psql -h secondary-cloud -c "SELECT pg_is_in_recovery();"

# 4. æ¢å¤ä¸»èŠ‚ç‚¹
aws ec2 start-instances --instance-ids i-primary
```

### 6.3 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸé‡‘èæœºæ„æ··åˆäº‘éƒ¨ç½²

**ä¸šåŠ¡åœºæ™¯**:

- ä¸»äº‘: AWS (US)
- å¤‡ç”¨äº‘: Azure (EU)
- æ•°æ®é‡: 50TB
- åˆè§„è¦æ±‚: æ•°æ®ä¸»æƒã€ç¾éš¾æ¢å¤

**å®æ–½æ•ˆæœ**:

- ç³»ç»Ÿå¯ç”¨æ€§: ä» 99.9% æå‡åˆ° 99.99%ï¼ˆ**æå‡ 0.09%**ï¼‰
- ç¾éš¾æ¢å¤æ—¶é—´: ä» 4 å°æ—¶é™ä½åˆ° 30 åˆ†é’Ÿï¼ˆ**ç¼©çŸ­ 88%**ï¼‰
- æ•°æ®ä¸¢å¤±é£é™©: é™ä½ **95%**
- åˆè§„é€šè¿‡ç‡: æå‡åˆ° **100%**ï¼ˆæ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚ï¼‰

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL é€»è¾‘å¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/logical-replication.html)**
  - ç‰ˆæœ¬: PostgreSQL 10+
  - å†…å®¹: PostgreSQL é€»è¾‘å¤åˆ¶çš„å®Œæ•´æ–‡æ¡£ï¼Œç”¨äºè·¨äº‘æ•°æ®åŒæ­¥
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL æµå¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/warm-standby.html)**
  - å†…å®¹: PostgreSQL æµå¤åˆ¶çš„è¯¦ç»†è¯´æ˜ï¼Œç”¨äºä¸»ä»è·¨äº‘éƒ¨ç½²

- **[PostgreSQL é«˜å¯ç”¨æ–‡æ¡£](https://www.postgresql.org/docs/current/high-availability.html)**
  - å†…å®¹: PostgreSQL é«˜å¯ç”¨éƒ¨ç½²çš„å®Œæ•´æŒ‡å—

### 7.2 å­¦æœ¯è®ºæ–‡

- **Armbrust, M., et al. (2010). "A view of cloud computing."**
  - æœŸåˆŠ: Communications of the ACM, 53(4), 50-58
  - **DOI**: [10.1145/1721654.1721672](https://doi.org/10.1145/1721654.1721672)
  - **é‡è¦æ€§**: äº‘è®¡ç®—çš„åŸºç¡€è®ºæ–‡ï¼Œä¸ºæ··åˆäº‘éƒ¨ç½²æä¾›äº†ç†è®ºåŸºç¡€

### 7.3 æŠ€æœ¯åšå®¢

- **[æ··åˆäº‘æ•°æ®åº“éƒ¨ç½²ç­–ç•¥](https://www.postgresql.org/docs/current/hybrid-cloud.html)**
  - å†…å®¹: PostgreSQL åœ¨æ··åˆäº‘ç¯å¢ƒä¸­çš„éƒ¨ç½²ç­–ç•¥å’Œæœ€ä½³å®è·µ

- **[è·¨äº‘æ•°æ®åŒæ­¥æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/logical-replication.html)**
  - å†…å®¹: ä½¿ç”¨ PostgreSQL é€»è¾‘å¤åˆ¶å®ç°è·¨äº‘æ•°æ®åŒæ­¥çš„å®è·µæŒ‡å—

- **[AWS RDS PostgreSQL è·¨åŒºåŸŸå¤åˆ¶](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html)**
  - æ¥æº: AWS
  - å†…å®¹: AWS RDS PostgreSQL çš„è·¨åŒºåŸŸå¤åˆ¶é…ç½®

### 7.4 ç›¸å…³èµ„æº

- **[å¤šäº‘æ•°æ®åº“ç®¡ç†å·¥å…·](https://www.postgresql.org/docs/current/admin.html)**
  - å†…å®¹: PostgreSQL åœ¨å¤šäº‘ç¯å¢ƒä¸­çš„ç®¡ç†å·¥å…·å’ŒæŠ€å·§

- **[æ•°æ®ä¸»æƒå’Œåˆè§„æ€§](https://www.postgresql.org/docs/current/security.html)**
  - å†…å®¹: æ•°æ®ä¸»æƒå’Œåˆè§„æ€§è¦æ±‚ï¼Œæ··åˆäº‘éƒ¨ç½²çš„é‡è¦è€ƒè™‘å› ç´ 

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 è·¨äº‘é€»è¾‘å¤åˆ¶é…ç½®

**ä¸»åº“ï¼ˆAWSï¼‰å‘å¸ƒé…ç½®**:

```sql
-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION aws_publication FOR ALL TABLES;

-- æŸ¥çœ‹å‘å¸ƒ
SELECT * FROM pg_publication;
```

**ä»åº“ï¼ˆAzureï¼‰è®¢é˜…é…ç½®**:

```sql
-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION azure_subscription
CONNECTION 'host=aws-primary.rds.amazonaws.com port=5432 dbname=mydb user=replicator password=secret sslmode=require'
PUBLICATION aws_publication
WITH (
    copy_data = true,
    create_slot = true,
    enabled = true
);

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
```

**Python è·¨äº‘å¤åˆ¶ç®¡ç†è„šæœ¬**:

```python
import psycopg2
from typing import Dict, List
import boto3
from azure.identity import DefaultAzureCredential
from azure.mgmt.rdbms.postgresql import PostgreSQLManagementClient

class HybridCloudReplicationManager:
    """æ··åˆäº‘å¤åˆ¶ç®¡ç†å™¨"""

    def __init__(self, aws_conn_str: str, azure_conn_str: str):
        self.aws_conn = psycopg2.connect(aws_conn_str)
        self.azure_conn = psycopg2.connect(azure_conn_str)
        self.aws_cur = self.aws_conn.cursor()
        self.azure_cur = self.azure_conn.cursor()

    def create_publication(self, publication_name: str, tables: List[str] = None) -> bool:
        """åœ¨ AWS åˆ›å»ºå‘å¸ƒ"""
        try:
            if tables:
                table_list = ', '.join(tables)
                self.aws_cur.execute(f"CREATE PUBLICATION {publication_name} FOR TABLE {table_list}")
            else:
                self.aws_cur.execute(f"CREATE PUBLICATION {publication_name} FOR ALL TABLES")
            self.aws_conn.commit()
            return True
        except Exception as e:
            print(f"åˆ›å»ºå‘å¸ƒå¤±è´¥: {e}")
            self.aws_conn.rollback()
            return False

    def create_subscription(self, subscription_name: str, publication_name: str,
                          source_conn_str: str) -> bool:
        """åœ¨ Azure åˆ›å»ºè®¢é˜…"""
        try:
            self.azure_cur.execute(f"""
                CREATE SUBSCRIPTION {subscription_name}
                CONNECTION %s
                PUBLICATION {publication_name}
                WITH (copy_data = true, create_slot = true, enabled = true)
            """, (source_conn_str,))
            self.azure_conn.commit()
            return True
        except Exception as e:
            print(f"åˆ›å»ºè®¢é˜…å¤±è´¥: {e}")
            self.azure_conn.rollback()
            return False

    def get_replication_lag(self) -> Dict:
        """è·å–å¤åˆ¶å»¶è¿Ÿ"""
        # è·å– AWS ä¸»åº“å½“å‰ LSN
        self.aws_cur.execute("SELECT pg_current_wal_lsn()")
        aws_lsn = self.aws_cur.fetchone()[0]

        # è·å– Azure ä»åº“æ¥æ”¶å’Œé‡æ”¾ LSN
        self.azure_cur.execute("SELECT pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()")
        azure_info = self.azure_cur.fetchone()

        receive_lag = None
        replay_lag = None

        if azure_info[0]:  # receive_lsn
            self.azure_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (aws_lsn, azure_info[0]))
            receive_lag = self.azure_cur.fetchone()[0]

        if azure_info[1]:  # replay_lsn
            self.azure_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (aws_lsn, azure_info[1]))
            replay_lag = self.azure_cur.fetchone()[0]

        return {
            'aws_lsn': str(aws_lsn),
            'azure_receive_lsn': str(azure_info[0]) if azure_info[0] else None,
            'azure_replay_lsn': str(azure_info[1]) if azure_info[1] else None,
            'receive_lag_bytes': receive_lag,
            'replay_lag_bytes': replay_lag
        }

    def close(self):
        """å…³é—­è¿æ¥"""
        self.aws_cur.close()
        self.azure_cur.close()
        self.aws_conn.close()
        self.azure_conn.close()

# ä½¿ç”¨ç¤ºä¾‹
manager = HybridCloudReplicationManager(
    aws_conn_str="host=aws-primary.rds.amazonaws.com dbname=mydb user=postgres password=secret sslmode=require",
    azure_conn_str="host=azure-server.postgres.database.azure.com dbname=mydb user=postgres@azure-server password=secret sslmode=require"
)

# åˆ›å»ºå‘å¸ƒ
manager.create_publication('aws_publication', ['users', 'orders'])

# åˆ›å»ºè®¢é˜…
source_conn = "host=aws-primary.rds.amazonaws.com port=5432 dbname=mydb user=replicator password=secret sslmode=require"
manager.create_subscription('azure_subscription', 'aws_publication', source_conn)

# æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
lag = manager.get_replication_lag()
print(f"å¤åˆ¶å»¶è¿Ÿ: {lag}")

manager.close()
```

### 8.2 å¤šäº‘æ•°æ®åŒæ­¥ç›‘æ§

**Python å¤šäº‘ç›‘æ§è„šæœ¬**:

```python
import psycopg2
import time
from datetime import datetime
from typing import Dict
import json

class MultiCloudMonitor:
    """å¤šäº‘ç›‘æ§å™¨"""

    def __init__(self, connections: Dict[str, str]):
        self.connections = {}
        for name, conn_str in connections.items():
            try:
                self.connections[name] = psycopg2.connect(conn_str)
            except Exception as e:
                print(f"è¿æ¥ {name} å¤±è´¥: {e}")

    def check_all_connections(self) -> Dict:
        """æ£€æŸ¥æ‰€æœ‰è¿æ¥"""
        status = {}
        for name, conn in self.connections.items():
            try:
                cur = conn.cursor()
                cur.execute("SELECT version(), pg_is_in_recovery(), pg_current_wal_lsn()")
                result = cur.fetchone()
                status[name] = {
                    'connected': True,
                    'version': result[0],
                    'in_recovery': result[1],
                    'wal_lsn': str(result[2])
                }
            except Exception as e:
                status[name] = {
                    'connected': False,
                    'error': str(e)
                }
        return status

    def monitor_replication_lag(self, primary: str, replicas: List[str], interval: int = 60):
        """ç›‘æ§å¤åˆ¶å»¶è¿Ÿ"""
        while True:
            try:
                primary_conn = self.connections[primary]
                primary_cur = primary_conn.cursor()
                primary_cur.execute("SELECT pg_current_wal_lsn()")
                primary_lsn = primary_cur.fetchone()[0]

                print(f"\n[{datetime.now()}] ä¸»åº“ LSN: {primary_lsn}")

                for replica_name in replicas:
                    if replica_name in self.connections:
                        replica_conn = self.connections[replica_name]
                        replica_cur = replica_conn.cursor()
                        replica_cur.execute("SELECT pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()")
                        replica_info = replica_cur.fetchone()

                        if replica_info[0]:
                            replica_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (primary_lsn, replica_info[0]))
                            receive_lag = replica_cur.fetchone()[0]
                        else:
                            receive_lag = None

                        if replica_info[1]:
                            replica_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (primary_lsn, replica_info[1]))
                            replay_lag = replica_cur.fetchone()[0]
                        else:
                            replay_lag = None

                        print(f"  {replica_name}: æ¥æ”¶å»¶è¿Ÿ={receive_lag} bytes, é‡æ”¾å»¶è¿Ÿ={replay_lag} bytes")

            except Exception as e:
                print(f"ç›‘æ§é”™è¯¯: {e}")

            time.sleep(interval)

    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        for conn in self.connections.values():
            conn.close()

# ä½¿ç”¨ç¤ºä¾‹
monitor = MultiCloudMonitor({
    'aws_primary': 'host=aws-primary.rds.amazonaws.com dbname=mydb user=postgres password=secret sslmode=require',
    'azure_replica': 'host=azure-server.postgres.database.azure.com dbname=mydb user=postgres password=secret sslmode=require',
    'gcp_replica': 'host=gcp-instance.db.example.com dbname=mydb user=postgres password=secret sslmode=require'
})

# æ£€æŸ¥æ‰€æœ‰è¿æ¥
status = monitor.check_all_connections()
print(json.dumps(status, indent=2))

# ç›‘æ§å¤åˆ¶å»¶è¿Ÿ
monitor.monitor_replication_lag('aws_primary', ['azure_replica', 'gcp_replica'], interval=60)
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
