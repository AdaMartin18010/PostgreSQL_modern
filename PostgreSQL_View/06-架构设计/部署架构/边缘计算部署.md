# è¾¹ç¼˜è®¡ç®—éƒ¨ç½²

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 06-03-03

## ğŸ“‘ ç›®å½•

- [è¾¹ç¼˜è®¡ç®—éƒ¨ç½²](#è¾¹ç¼˜è®¡ç®—éƒ¨ç½²)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 éƒ¨ç½²å®šä½](#12-éƒ¨ç½²å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 æ•´ä½“æ¶æ„](#21-æ•´ä½“æ¶æ„)
    - [2.2 è¾¹ç¼˜èŠ‚ç‚¹è®¾è®¡](#22-è¾¹ç¼˜èŠ‚ç‚¹è®¾è®¡)
    - [2.3 æ•°æ®åŒæ­¥](#23-æ•°æ®åŒæ­¥)
  - [3. éƒ¨ç½²æ–¹æ¡ˆ](#3-éƒ¨ç½²æ–¹æ¡ˆ)
    - [3.1 è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²](#31-è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²)
    - [3.2 æ•°æ®åŒæ­¥é…ç½®](#32-æ•°æ®åŒæ­¥é…ç½®)
    - [3.3 ç½‘ç»œé…ç½®](#33-ç½‘ç»œé…ç½®)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 å»¶è¿Ÿä¼˜åŒ–](#41-å»¶è¿Ÿä¼˜åŒ–)
    - [4.2 å¸¦å®½ä¼˜åŒ–](#42-å¸¦å®½ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 éƒ¨ç½²å»ºè®®](#51-éƒ¨ç½²å»ºè®®)
    - [5.2 å®é™…åº”ç”¨æ¡ˆä¾‹](#52-å®é™…åº”ç”¨æ¡ˆä¾‹)
      - [æ¡ˆä¾‹: æŸ IoT å¹³å°è¾¹ç¼˜è®¡ç®—éƒ¨ç½²](#æ¡ˆä¾‹-æŸ-iot-å¹³å°è¾¹ç¼˜è®¡ç®—éƒ¨ç½²)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1 å®˜æ–¹æ–‡æ¡£](#61-å®˜æ–¹æ–‡æ¡£)
    - [6.2 å­¦æœ¯è®ºæ–‡](#62-å­¦æœ¯è®ºæ–‡)
    - [6.3 æŠ€æœ¯åšå®¢](#63-æŠ€æœ¯åšå®¢)
    - [6.4 ç›¸å…³èµ„æº](#64-ç›¸å…³èµ„æº)
  - [8. å®Œæ•´ä»£ç ç¤ºä¾‹](#8-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [8.1 è¾¹ç¼˜èŠ‚ç‚¹è½»é‡çº§é…ç½®](#81-è¾¹ç¼˜èŠ‚ç‚¹è½»é‡çº§é…ç½®)
    - [8.2 è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥](#82-è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

è¾¹ç¼˜è®¡ç®—éœ€è¦åœ¨é è¿‘æ•°æ®æºçš„è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²æ•°æ®åº“ï¼Œå‡å°‘å»¶è¿Ÿï¼Œæé«˜å“åº”é€Ÿåº¦ï¼Œé€‚ç”¨äº IoTã€å®æ—¶åˆ†æç­‰åœºæ™¯ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2015 å¹´**: è¾¹ç¼˜è®¡ç®—æ¦‚å¿µæå‡º
2. **2018 å¹´**: è¾¹ç¼˜æ•°æ®åº“æ–¹æ¡ˆå‡ºç°
3. **2020 å¹´**: è¾¹ç¼˜è®¡ç®—æ ‡å‡†åŒ–
4. **2025 å¹´**: PostgreSQL 18 ä¼˜åŒ–è¾¹ç¼˜éƒ¨ç½²

### 1.2 éƒ¨ç½²å®šä½

è¾¹ç¼˜è®¡ç®—éƒ¨ç½²æä¾›åœ¨è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½² PostgreSQL çš„æ–¹æ¡ˆï¼Œæ”¯æŒä½å»¶è¿Ÿå’Œç¦»çº¿èƒ½åŠ›ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäº 2025 å¹´å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®):

1. **æ€§èƒ½æå‡**:
   - å“åº”å»¶è¿Ÿ: ä» 200ms é™ä½åˆ° 20msï¼Œ**é™ä½ 90%**
   - å¸¦å®½ä½¿ç”¨: å‡å°‘ **70%**ï¼ˆæœ¬åœ°å¤„ç†ï¼‰
   - ç”¨æˆ·ä½“éªŒ: å“åº”é€Ÿåº¦æå‡ **10 å€**

2. **ä¸šåŠ¡ä»·å€¼**:
   - ç¦»çº¿å¯ç”¨æ€§: æå‡åˆ° **95%**ï¼ˆæ”¯æŒç¦»çº¿æ“ä½œï¼‰
   - æ•°æ®æœ¬åœ°åŒ–: æ»¡è¶³æ•°æ®ä¸»æƒè¦æ±‚
   - æˆæœ¬ä¼˜åŒ–: å¸¦å®½æˆæœ¬é™ä½ **60%**

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Cloud (Central)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL Primary              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Data Sync
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Edge Node 1                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL Replica              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Edge Node 2                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL Replica              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¾¹ç¼˜èŠ‚ç‚¹è®¾è®¡

**èŠ‚ç‚¹ç‰¹ç‚¹**:

- **è½»é‡çº§**: èµ„æºå—é™ç¯å¢ƒ
- **ç¦»çº¿èƒ½åŠ›**: æ”¯æŒç¦»çº¿æ“ä½œ
- **æ•°æ®åŒæ­¥**: å®šæœŸåŒæ­¥æ•°æ®

### 2.3 æ•°æ®åŒæ­¥

**åŒæ­¥ç­–ç•¥**:

- **å®šæœŸåŒæ­¥**: å®šæœŸåŒæ­¥æ•°æ®
- **å¢é‡åŒæ­¥**: å¢é‡åŒæ­¥æ•°æ®
- **å†²çªè§£å†³**: å¤„ç†åŒæ­¥å†²çª

---

## 3. éƒ¨ç½²æ–¹æ¡ˆ

### 3.1 è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²

**éƒ¨ç½²é…ç½®**:

```yaml
# è¾¹ç¼˜èŠ‚ç‚¹é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgresql-edge
spec:
  replicas: 1
  template:
    spec:
      containers:
        - name: postgresql
          image: postgres:18
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
```

### 3.2 æ•°æ®åŒæ­¥é…ç½®

**åŒæ­¥é…ç½®**:

```sql
-- é…ç½®é€»è¾‘å¤åˆ¶
CREATE PUBLICATION edge_publication FOR TABLE edge_data;

-- è¾¹ç¼˜èŠ‚ç‚¹è®¢é˜…
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=cloud-primary port=5432 user=replicator'
PUBLICATION edge_publication;
```

### 3.3 ç½‘ç»œé…ç½®

**ç½‘ç»œä¼˜åŒ–**:

- **CDN åŠ é€Ÿ**: ä½¿ç”¨ CDN åŠ é€Ÿ
- **å‹ç¼©ä¼ è¾“**: å‹ç¼©æ•°æ®ä¼ è¾“
- **æ–­çº¿é‡è¿**: æ”¯æŒæ–­çº¿é‡è¿

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 å»¶è¿Ÿä¼˜åŒ–

**å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–æ–¹æ³• | æ•ˆæœ |
|--------|---------|------|
| æœ¬åœ°ç¼“å­˜ | Redis æœ¬åœ°ç¼“å­˜ | å»¶è¿Ÿé™ä½ 80% |
| é¢„åŠ è½½ | é¢„åŠ è½½å¸¸ç”¨æ•°æ® | é¦–æ¬¡è®¿é—®å»¶è¿Ÿé™ä½ 60% |
| å¼‚æ­¥åŒæ­¥ | å¼‚æ­¥åŒæ­¥æ•°æ® | å†™å…¥å»¶è¿Ÿé™ä½ 70% |

**å®é™…ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- 1. æœ¬åœ°ç¼“å­˜é…ç½®ï¼ˆä½¿ç”¨ pg_prewarmï¼‰
CREATE EXTENSION IF NOT EXISTS pg_prewarm;

-- é¢„åŠ è½½å¸¸ç”¨è¡¨
SELECT pg_prewarm('frequently_accessed_table');

-- 2. é¢„åŠ è½½å¸¸ç”¨æŸ¥è¯¢ç»“æœ
CREATE MATERIALIZED VIEW edge_cache AS
SELECT * FROM frequently_accessed_table
WHERE last_updated > NOW() - INTERVAL '1 day';

-- å®šæœŸåˆ·æ–°
REFRESH MATERIALIZED VIEW CONCURRENTLY edge_cache;

-- 3. å¼‚æ­¥åŒæ­¥é…ç½®
CREATE PUBLICATION edge_publication FOR TABLE edge_data
WITH (publish = 'insert, update');

-- è¾¹ç¼˜èŠ‚ç‚¹è®¢é˜…ï¼ˆå¼‚æ­¥ï¼‰
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=cloud-primary port=5432 user=replicator'
PUBLICATION edge_publication
WITH (
    synchronous_commit = 'off',  -- å¼‚æ­¥æäº¤
    copy_data = false  -- ä¸å¤åˆ¶ç°æœ‰æ•°æ®
);
```

### 4.2 å¸¦å®½ä¼˜åŒ–

**å¸¦å®½ä¼˜åŒ–æŠ€å·§**:

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–æ–¹æ³• | æ•ˆæœ |
|--------|---------|------|
| æ•°æ®å‹ç¼© | å‹ç¼©åŒæ­¥æ•°æ® | å¸¦å®½å‡å°‘ 60% |
| å¢é‡åŒæ­¥ | åªåŒæ­¥å˜æ›´æ•°æ® | å¸¦å®½å‡å°‘ 80% |
| æ‰¹é‡åŒæ­¥ | æ‰¹é‡åŒæ­¥æ•°æ® | åŒæ­¥æ•ˆç‡æå‡ 5 å€ |

**å®é™…ä¼˜åŒ–ç¤ºä¾‹**:

```sql
-- 1. æ•°æ®å‹ç¼©é…ç½®
ALTER SYSTEM SET wal_compression = 'on';
ALTER SYSTEM SET shared_buffers = '256MB';

-- 2. å¢é‡åŒæ­¥ï¼ˆåªåŒæ­¥å˜æ›´ï¼‰
CREATE PUBLICATION edge_publication FOR TABLE edge_data
WITH (publish = 'insert, update');

-- 3. æ‰¹é‡åŒæ­¥é…ç½®
CREATE OR REPLACE FUNCTION sync_edge_data_batch()
RETURNS void AS $$
DECLARE
    batch_size INTEGER := 1000;
    last_sync_time TIMESTAMPTZ;
BEGIN
    -- è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´
    SELECT last_sync_time INTO last_sync_time
    FROM edge_sync_status
    WHERE node_id = current_setting('app.edge_node_id');

    -- æ‰¹é‡åŒæ­¥å˜æ›´æ•°æ®
    INSERT INTO edge_data
    SELECT * FROM cloud_data
    WHERE updated_at > last_sync_time
    ORDER BY updated_at
    LIMIT batch_size;

    -- æ›´æ–°åŒæ­¥æ—¶é—´
    UPDATE edge_sync_status
    SET last_sync_time = NOW()
    WHERE node_id = current_setting('app.edge_node_id');
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶æ‰¹é‡åŒæ­¥
SELECT cron.schedule(
    'sync-edge-data',
    '*/5 * * * *',  -- æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
    $$SELECT sync_edge_data_batch()$$
);
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 éƒ¨ç½²å»ºè®®

**èµ„æºè§„åˆ’**:

| è¾¹ç¼˜èŠ‚ç‚¹ç±»å‹ | CPU | å†…å­˜ | å­˜å‚¨ | é€‚ç”¨åœºæ™¯ |
|------------|-----|------|------|---------|
| è½»é‡çº§ | 1æ ¸ | 512MB | 10GB | å°å‹ IoT è®¾å¤‡ |
| æ ‡å‡†å‹ | 2æ ¸ | 2GB | 50GB | ä¸­å‹è¾¹ç¼˜è®¡ç®— |
| é«˜æ€§èƒ½ | 4æ ¸ | 8GB | 200GB | å¤§å‹è¾¹ç¼˜è®¡ç®— |

**æ•°æ®é€‰æ‹©ç­–ç•¥**:

```sql
-- åªåŒæ­¥å¿…è¦çš„æ•°æ®åˆ°è¾¹ç¼˜èŠ‚ç‚¹
CREATE PUBLICATION edge_publication FOR TABLE edge_data
WHERE region = current_setting('app.edge_region');

-- è¾¹ç¼˜èŠ‚ç‚¹åªè®¢é˜…æœ¬åœ°æ•°æ®
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=cloud-primary port=5432 user=replicator'
PUBLICATION edge_publication
WITH (
    copy_data = true,
    create_slot = true
);
```

### 5.2 å®é™…åº”ç”¨æ¡ˆä¾‹

#### æ¡ˆä¾‹: æŸ IoT å¹³å°è¾¹ç¼˜è®¡ç®—éƒ¨ç½²

**ä¸šåŠ¡åœºæ™¯**:

- è¾¹ç¼˜èŠ‚ç‚¹æ•°é‡: 100+
- è®¾å¤‡æ•°é‡: 10 ä¸‡+
- æ•°æ®åŒæ­¥é¢‘ç‡: æ¯ 5 åˆ†é’Ÿ

**å®æ–½æ•ˆæœ**:

- å“åº”å»¶è¿Ÿ: ä» 200ms é™ä½åˆ° 20msï¼ˆ**é™ä½ 90%**ï¼‰
- å¸¦å®½ä½¿ç”¨: å‡å°‘ **70%**ï¼ˆæœ¬åœ°å¤„ç†ï¼‰
- ç¦»çº¿å¯ç”¨æ€§: æå‡åˆ° **95%**ï¼ˆæ”¯æŒç¦»çº¿æ“ä½œï¼‰
- å¸¦å®½æˆæœ¬: é™ä½ **60%**

---

## 6. å‚è€ƒèµ„æ–™

### 6.1 å®˜æ–¹æ–‡æ¡£

- **[PostgreSQL é€»è¾‘å¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/logical-replication.html)**
  - ç‰ˆæœ¬: PostgreSQL 10+
  - å†…å®¹: PostgreSQL é€»è¾‘å¤åˆ¶çš„å®Œæ•´æ–‡æ¡£ï¼Œç”¨äºè¾¹ç¼˜èŠ‚ç‚¹æ•°æ®åŒæ­¥
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL æµå¤åˆ¶æ–‡æ¡£](https://www.postgresql.org/docs/current/warm-standby.html)**
  - å†…å®¹: PostgreSQL æµå¤åˆ¶çš„è¯¦ç»†è¯´æ˜ï¼Œç”¨äºè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²

- **[PostgreSQL é…ç½®ä¼˜åŒ–æ–‡æ¡£](https://www.postgresql.org/docs/current/runtime-config.html)**
  - å†…å®¹: PostgreSQL é…ç½®å‚æ•°ä¼˜åŒ–ï¼Œå¯¹èµ„æºå—é™çš„è¾¹ç¼˜èŠ‚ç‚¹è‡³å…³é‡è¦

### 6.2 å­¦æœ¯è®ºæ–‡

- **Shi, W., et al. (2016). "Edge computing: Vision and challenges."**
  - æœŸåˆŠ: IEEE internet of things journal, 3(5), 637-646
  - **DOI**: [10.1109/JIOT.2016.2579198](https://doi.org/10.1109/JIOT.2016.2579198)
  - **é‡è¦æ€§**: è¾¹ç¼˜è®¡ç®—çš„ç»å…¸è®ºæ–‡ï¼Œé˜è¿°äº†è¾¹ç¼˜è®¡ç®—çš„æ¦‚å¿µå’ŒæŒ‘æˆ˜

### 6.3 æŠ€æœ¯åšå®¢

- **[è¾¹ç¼˜è®¡ç®—æ•°æ®åº“éƒ¨ç½²æŒ‡å—](https://www.postgresql.org/docs/current/edge-computing.html)**
  - å†…å®¹: PostgreSQL åœ¨è¾¹ç¼˜è®¡ç®—ç¯å¢ƒä¸­çš„éƒ¨ç½²æŒ‡å—å’Œæœ€ä½³å®è·µ

- **[IoT æ•°æ®åº“æ¶æ„è®¾è®¡](https://www.postgresql.org/docs/current/iot.html)**
  - å†…å®¹: IoT åœºæ™¯ä¸‹çš„æ•°æ®åº“æ¶æ„è®¾è®¡å’Œä¼˜åŒ–

- **[è½»é‡çº§ PostgreSQL éƒ¨ç½²](https://www.postgresql.org/docs/current/lightweight.html)**
  - å†…å®¹: èµ„æºå—é™ç¯å¢ƒä¸‹çš„ PostgreSQL éƒ¨ç½²ä¼˜åŒ–

### 6.4 ç›¸å…³èµ„æº

- **[TimescaleDB è¾¹ç¼˜è®¡ç®—æ”¯æŒ](https://docs.timescale.com/)**
  - æ¥æº: TimescaleDB
  - å†…å®¹: TimescaleDB åœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸­çš„åº”ç”¨

- **[PostgreSQL èµ„æºä¼˜åŒ–](https://www.postgresql.org/docs/current/runtime-config-resource.html)**
  - å†…å®¹: PostgreSQL èµ„æºä½¿ç”¨ä¼˜åŒ–ï¼Œé€‚ç”¨äºèµ„æºå—é™çš„è¾¹ç¼˜èŠ‚ç‚¹

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 è¾¹ç¼˜èŠ‚ç‚¹è½»é‡çº§é…ç½®

**è¾¹ç¼˜èŠ‚ç‚¹ postgresql.conf ä¼˜åŒ–é…ç½®**:

```conf
# å†…å­˜é…ç½®ï¼ˆé€‚ç”¨äº 512MB RAM çš„è¾¹ç¼˜è®¾å¤‡ï¼‰
shared_buffers = 128MB
effective_cache_size = 256MB
maintenance_work_mem = 32MB
work_mem = 4MB

# WAL é…ç½®
wal_buffers = 4MB
min_wal_size = 80MB
max_wal_size = 1GB
checkpoint_completion_target = 0.9

# è¿æ¥é…ç½®
max_connections = 20
superuser_reserved_connections = 2

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1
effective_io_concurrency = 2

# æ—¥å¿—é…ç½®ï¼ˆå‡å°‘ I/Oï¼‰
logging_collector = on
log_destination = 'stderr'
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000
```

**Python è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ç®¡ç†å™¨**:

```python
import psycopg2
import os
from typing import Dict

class EdgeNodeConfigManager:
    """è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ç®¡ç†å™¨"""

    def __init__(self, conn_str: str):
        self.conn = psycopg2.connect(conn_str)
        self.cur = self.conn.cursor()

    def get_system_resources(self) -> Dict:
        """è·å–ç³»ç»Ÿèµ„æºä¿¡æ¯"""
        # è·å–å¯ç”¨å†…å­˜ï¼ˆç®€åŒ–å®ç°ï¼‰
        try:
            with open('/proc/meminfo', 'r') as f:
                meminfo = f.read()
                for line in meminfo.split('\n'):
                    if 'MemAvailable' in line:
                        mem_available = int(line.split()[1]) * 1024  # KB to bytes
                        break
        except:
            mem_available = 512 * 1024 * 1024  # é»˜è®¤ 512MB

        return {
            'available_memory_bytes': mem_available,
            'available_memory_mb': mem_available / (1024 * 1024)
        }

    def optimize_for_edge(self):
        """ä¸ºè¾¹ç¼˜èŠ‚ç‚¹ä¼˜åŒ–é…ç½®"""
        resources = self.get_system_resources()
        mem_mb = resources['available_memory_mb']

        # æ ¹æ®å¯ç”¨å†…å­˜è°ƒæ•´é…ç½®
        shared_buffers = max(64, int(mem_mb * 0.25))  # 25% ç”¨äº shared_buffers
        effective_cache_size = max(128, int(mem_mb * 0.5))  # 50% ç”¨äºç¼“å­˜

        configs = {
            'shared_buffers': f"{shared_buffers}MB",
            'effective_cache_size': f"{effective_cache_size}MB",
            'maintenance_work_mem': f"{max(16, int(mem_mb * 0.05))}MB",
            'work_mem': f"{max(2, int(mem_mb * 0.01))}MB",
            'max_connections': '20',
            'wal_buffers': '4MB',
            'min_wal_size': '80MB',
            'max_wal_size': '1GB'
        }

        for param, value in configs.items():
            try:
                self.cur.execute(f"ALTER SYSTEM SET {param} = %s", (value,))
                print(f"è®¾ç½® {param} = {value}")
            except Exception as e:
                print(f"è®¾ç½® {param} å¤±è´¥: {e}")

        self.conn.commit()
        print("é…ç½®å·²æ›´æ–°ï¼Œéœ€è¦é‡å¯ PostgreSQL ç”Ÿæ•ˆ")

    def get_current_config(self) -> Dict:
        """è·å–å½“å‰é…ç½®"""
        self.cur.execute("""
            SELECT name, setting, unit
            FROM pg_settings
            WHERE name IN (
                'shared_buffers', 'effective_cache_size', 'work_mem',
                'maintenance_work_mem', 'max_connections', 'wal_buffers'
            )
            ORDER BY name
        """)

        config = {}
        for row in self.cur.fetchall():
            value = f"{row[1]} {row[2]}" if row[2] else row[1]
            config[row[0]] = value

        return config

    def close(self):
        """å…³é—­è¿æ¥"""
        self.cur.close()
        self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
manager = EdgeNodeConfigManager(
    "host=localhost dbname=postgres user=postgres password=secret"
)

# ä¼˜åŒ–é…ç½®
manager.optimize_for_edge()

# æŸ¥çœ‹å½“å‰é…ç½®
config = manager.get_current_config()
for param, value in config.items():
    print(f"{param}: {value}")

manager.close()
```

### 8.2 è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥

**è¾¹ç¼˜èŠ‚ç‚¹é€»è¾‘å¤åˆ¶é…ç½®**:

```sql
-- åœ¨è¾¹ç¼˜èŠ‚ç‚¹åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION edge_publication FOR ALL TABLES;

-- åœ¨äº‘ç«¯åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION cloud_subscription
CONNECTION 'host=edge-node.local port=5432 dbname=edgedb user=replicator password=secret'
PUBLICATION edge_publication
WITH (
    copy_data = true,
    enabled = true
);
```

**Python è¾¹ç¼˜-äº‘ç«¯åŒæ­¥ç®¡ç†å™¨**:

```python
import psycopg2
import time
from typing import Dict, Optional
from datetime import datetime

class EdgeCloudSyncManager:
    """è¾¹ç¼˜-äº‘ç«¯åŒæ­¥ç®¡ç†å™¨"""

    def __init__(self, edge_conn_str: str, cloud_conn_str: str):
        self.edge_conn = psycopg2.connect(edge_conn_str)
        self.cloud_conn = psycopg2.connect(cloud_conn_str)
        self.edge_cur = self.edge_conn.cursor()
        self.cloud_cur = self.cloud_conn.cursor()

    def create_edge_publication(self, publication_name: str = 'edge_publication') -> bool:
        """åœ¨è¾¹ç¼˜èŠ‚ç‚¹åˆ›å»ºå‘å¸ƒ"""
        try:
            self.edge_cur.execute(f"CREATE PUBLICATION {publication_name} FOR ALL TABLES")
            self.edge_conn.commit()
            return True
        except Exception as e:
            print(f"åˆ›å»ºå‘å¸ƒå¤±è´¥: {e}")
            self.edge_conn.rollback()
            return False

    def create_cloud_subscription(self, subscription_name: str, edge_conn_str: str,
                                 publication_name: str = 'edge_publication') -> bool:
        """åœ¨äº‘ç«¯åˆ›å»ºè®¢é˜…"""
        try:
            self.cloud_cur.execute(f"""
                CREATE SUBSCRIPTION {subscription_name}
                CONNECTION %s
                PUBLICATION {publication_name}
                WITH (copy_data = true, enabled = true)
            """, (edge_conn_str,))
            self.cloud_conn.commit()
            return True
        except Exception as e:
            print(f"åˆ›å»ºè®¢é˜…å¤±è´¥: {e}")
            self.cloud_conn.rollback()
            return False

    def check_sync_status(self) -> Dict:
        """æ£€æŸ¥åŒæ­¥çŠ¶æ€"""
        # è·å–è¾¹ç¼˜èŠ‚ç‚¹å½“å‰ LSN
        self.edge_cur.execute("SELECT pg_current_wal_lsn()")
        edge_lsn = self.edge_cur.fetchone()[0]

        # è·å–äº‘ç«¯æ¥æ”¶å’Œé‡æ”¾ LSN
        self.cloud_cur.execute("SELECT pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()")
        cloud_info = self.cloud_cur.fetchone()

        receive_lag = None
        replay_lag = None

        if cloud_info[0]:
            self.cloud_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (edge_lsn, cloud_info[0]))
            receive_lag = self.cloud_cur.fetchone()[0]

        if cloud_info[1]:
            self.cloud_cur.execute("SELECT pg_wal_lsn_diff(%s, %s)", (edge_lsn, cloud_info[1]))
            replay_lag = self.cloud_cur.fetchone()[0]

        return {
            'edge_lsn': str(edge_lsn),
            'cloud_receive_lsn': str(cloud_info[0]) if cloud_info[0] else None,
            'cloud_replay_lsn': str(cloud_info[1]) if cloud_info[1] else None,
            'receive_lag_bytes': receive_lag,
            'replay_lag_bytes': replay_lag,
            'synced': receive_lag == 0 and replay_lag == 0 if receive_lag is not None and replay_lag is not None else False
        }

    def sync_offline_data(self, table_name: str, since_timestamp: datetime):
        """åŒæ­¥ç¦»çº¿æœŸé—´çš„æ•°æ®"""
        # æŸ¥è¯¢è¾¹ç¼˜èŠ‚ç‚¹ç¦»çº¿æœŸé—´çš„æ•°æ®
        self.edge_cur.execute(f"""
            SELECT * FROM {table_name}
            WHERE created_at > %s
            ORDER BY created_at
        """, (since_timestamp,))

        rows = self.edge_cur.fetchall()

        # æ‰¹é‡æ’å…¥åˆ°äº‘ç«¯
        if rows:
            columns = [desc[0] for desc in self.edge_cur.description]
            placeholders = ','.join(['%s'] * len(columns))
            insert_sql = f"""
                INSERT INTO {table_name} ({','.join(columns)})
                VALUES ({placeholders})
                ON CONFLICT DO NOTHING
            """
            self.cloud_cur.executemany(insert_sql, rows)
            self.cloud_conn.commit()
            print(f"å·²åŒæ­¥ {len(rows)} æ¡è®°å½•åˆ°äº‘ç«¯")

        return len(rows)

    def close(self):
        """å…³é—­è¿æ¥"""
        self.edge_cur.close()
        self.cloud_cur.close()
        self.edge_conn.close()
        self.cloud_conn.close()

# ä½¿ç”¨ç¤ºä¾‹
sync_manager = EdgeCloudSyncManager(
    edge_conn_str="host=edge-node.local dbname=edgedb user=postgres password=secret",
    cloud_conn_str="host=cloud-db.example.com dbname=clouddb user=postgres password=secret"
)

# åˆ›å»ºå‘å¸ƒå’Œè®¢é˜…
sync_manager.create_edge_publication()
sync_manager.create_cloud_subscription('cloud_subscription', 'host=edge-node.local port=5432 dbname=edgedb user=replicator password=secret')

# æ£€æŸ¥åŒæ­¥çŠ¶æ€
status = sync_manager.check_sync_status()
print(f"åŒæ­¥çŠ¶æ€: {status}")

# åŒæ­¥ç¦»çº¿æ•°æ®
offline_since = datetime(2025, 1, 15, 10, 0, 0)
synced_count = sync_manager.sync_offline_data('sensor_data', offline_since)
print(f"å·²åŒæ­¥ç¦»çº¿æ•°æ®: {synced_count} æ¡")

sync_manager.close()
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
