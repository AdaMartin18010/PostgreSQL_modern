# äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: Kubernetes 1.28+, PostgreSQL 18+
> **æ–‡æ¡£ç¼–å·**: 06-03-01

## ğŸ“‘ ç›®å½•

- [äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ](#äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æ–¹æ¡ˆå®šä½](#12-æ–¹æ¡ˆå®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 æ•´ä½“æ¶æ„](#21-æ•´ä½“æ¶æ„)
    - [2.2 ç»„ä»¶è®¾è®¡](#22-ç»„ä»¶è®¾è®¡)
    - [2.3 ç½‘ç»œè®¾è®¡](#23-ç½‘ç»œè®¾è®¡)
  - [3. Kubernetes éƒ¨ç½²](#3-kubernetes-éƒ¨ç½²)
    - [3.1 StatefulSet éƒ¨ç½²](#31-statefulset-éƒ¨ç½²)
    - [3.2 æœåŠ¡å‘ç°](#32-æœåŠ¡å‘ç°)
    - [3.3 å­˜å‚¨ç®¡ç†](#33-å­˜å‚¨ç®¡ç†)
  - [4. é«˜å¯ç”¨é…ç½®](#4-é«˜å¯ç”¨é…ç½®)
    - [4.1 ä¸»ä»å¤åˆ¶](#41-ä¸»ä»å¤åˆ¶)
    - [4.2 è‡ªåŠ¨æ•…éšœè½¬ç§»](#42-è‡ªåŠ¨æ•…éšœè½¬ç§»)
    - [4.3 è´Ÿè½½å‡è¡¡](#43-è´Ÿè½½å‡è¡¡)
  - [5. ç›‘æ§ä¸è¿ç»´](#5-ç›‘æ§ä¸è¿ç»´)
    - [5.1 ç›‘æ§é…ç½®](#51-ç›‘æ§é…ç½®)
    - [5.2 æ—¥å¿—ç®¡ç†](#52-æ—¥å¿—ç®¡ç†)
    - [5.3 å¤‡ä»½æ¢å¤](#53-å¤‡ä»½æ¢å¤)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 éƒ¨ç½²å»ºè®®](#61-éƒ¨ç½²å»ºè®®)
    - [6.2 è¿ç»´å»ºè®®](#62-è¿ç»´å»ºè®®)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1 å®˜æ–¹æ–‡æ¡£](#71-å®˜æ–¹æ–‡æ¡£)
    - [7.2 å­¦æœ¯è®ºæ–‡](#72-å­¦æœ¯è®ºæ–‡)
    - [7.3 æŠ€æœ¯åšå®¢](#73-æŠ€æœ¯åšå®¢)
    - [7.4 ç›¸å…³èµ„æº](#74-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é—®é¢˜éœ€æ±‚**:

äº‘åŸç”Ÿéƒ¨ç½²éœ€è¦æ”¯æŒå®¹å™¨åŒ–ã€è‡ªåŠ¨åŒ–ã€å¯æ‰©å±•çš„æ•°æ®åº“éƒ¨ç½²ï¼Œä½¿ç”¨ Kubernetes ç­‰å®¹å™¨ç¼–æ’å¹³å°ç®¡ç† PostgreSQL
é›†ç¾¤ã€‚

**æŠ€æœ¯æ¼”è¿›**:

1. **2015 å¹´**: Kubernetes é¡¹ç›®å¯åŠ¨
1. **2018 å¹´**: PostgreSQL Operator å‡ºç°
1. **2020 å¹´**: äº‘åŸç”Ÿæ•°æ®åº“æˆç†Ÿ
1. **2025 å¹´**: PostgreSQL 18 ä¼˜åŒ–äº‘åŸç”Ÿéƒ¨ç½²

### 1.2 æ–¹æ¡ˆå®šä½

äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆæä¾›åŸºäº Kubernetes çš„ PostgreSQL éƒ¨ç½²æ–¹æ¡ˆï¼Œæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†ã€‚

### 1.3 æ ¸å¿ƒä»·å€¼

- **è‡ªåŠ¨åŒ–éƒ¨ç½²**: è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œé…ç½®
- **å¼¹æ€§æ‰©å±•**: æ”¯æŒæ°´å¹³æ‰©å±•
- **é«˜å¯ç”¨æ€§**: ä¿è¯é«˜å¯ç”¨æ€§
- **æ˜“äºç®¡ç†**: ç®€åŒ–è¿ç»´ç®¡ç†

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Kubernetes Cluster                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL StatefulSet          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ Primary  â”‚  â”‚ Replica  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  Pod     â”‚  â”‚  Pod     â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service                         â”‚  â”‚
â”‚  â”‚  - Primary Service               â”‚  â”‚
â”‚  â”‚  - Replica Service               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PersistentVolume                â”‚  â”‚
â”‚  â”‚  - Data Volume                   â”‚  â”‚
â”‚  â”‚  - WAL Volume                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç»„ä»¶è®¾è®¡

**æ ¸å¿ƒç»„ä»¶**:

- **StatefulSet**: ç®¡ç†æœ‰çŠ¶æ€ Pod
- **Service**: æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
- **PersistentVolume**: æŒä¹…åŒ–å­˜å‚¨
- **ConfigMap**: é…ç½®ç®¡ç†
- **Secret**: å¯†é’¥ç®¡ç†

### 2.3 ç½‘ç»œè®¾è®¡

**ç½‘ç»œé…ç½®**:

- **ClusterIP**: é›†ç¾¤å†…éƒ¨è®¿é—®
- **NodePort**: èŠ‚ç‚¹ç«¯å£è®¿é—®
- **LoadBalancer**: è´Ÿè½½å‡è¡¡å™¨è®¿é—®

---

## 3. Kubernetes éƒ¨ç½²

### 3.1 StatefulSet éƒ¨ç½²

**StatefulSet é…ç½®**:

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
        - name: postgresql
          image: postgres:18
          env:
            - name: POSTGRES_DB
              value: mydb
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi
```

### 3.2 æœåŠ¡å‘ç°

**Service é…ç½®**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgresql-primary
spec:
  selector:
    app: postgresql
    role: primary
  ports:
    - port: 5432
      targetPort: 5432
  type: ClusterIP
```

### 3.3 å­˜å‚¨ç®¡ç†

**å­˜å‚¨é…ç½®**:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgresql-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: fast-ssd
```

---

## 4. é«˜å¯ç”¨é…ç½®

### 4.1 ä¸»ä»å¤åˆ¶

**å¤åˆ¶é…ç½®**:

```yaml
# ä½¿ç”¨ PostgreSQL Operator é…ç½®ä¸»ä»å¤åˆ¶
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgresql-cluster
spec:
  instances: 3
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
  bootstrap:
    initdb:
      database: mydb
      owner: myuser
      secret:
        name: postgresql-secret
```

### 4.2 è‡ªåŠ¨æ•…éšœè½¬ç§»

**æ•…éšœè½¬ç§»é…ç½®**:

- **å¥åº·æ£€æŸ¥**: å®šæœŸå¥åº·æ£€æŸ¥
- **è‡ªåŠ¨åˆ‡æ¢**: ä¸»èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨åˆ‡æ¢
- **æ•°æ®åŒæ­¥**: ä¿è¯æ•°æ®åŒæ­¥

### 4.3 è´Ÿè½½å‡è¡¡

**è´Ÿè½½å‡è¡¡é…ç½®**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgresql-read
spec:
  selector:
    app: postgresql
    role: replica
  ports:
    - port: 5432
      targetPort: 5432
  type: LoadBalancer
```

---

## 5. ç›‘æ§ä¸è¿ç»´

### 5.1 ç›‘æ§é…ç½®

**ç›‘æ§æ–¹æ¡ˆ**:

- **Prometheus**: æŒ‡æ ‡æ”¶é›†
- **Grafana**: å¯è§†åŒ–å±•ç¤º
- **AlertManager**: å‘Šè­¦ç®¡ç†

### 5.2 æ—¥å¿—ç®¡ç†

**æ—¥å¿—é…ç½®**:

- **é›†ä¸­æ—¥å¿—**: ä½¿ç”¨ ELK æˆ– Loki
- **æ—¥å¿—è½®è½¬**: è‡ªåŠ¨æ—¥å¿—è½®è½¬
- **æ—¥å¿—æŸ¥è¯¢**: æ”¯æŒæ—¥å¿—æŸ¥è¯¢

### 5.3 å¤‡ä»½æ¢å¤

**å¤‡ä»½é…ç½®**:

- **å®šæœŸå¤‡ä»½**: è‡ªåŠ¨å®šæœŸå¤‡ä»½
- **å¢é‡å¤‡ä»½**: æ”¯æŒå¢é‡å¤‡ä»½
- **å¿«é€Ÿæ¢å¤**: æ”¯æŒå¿«é€Ÿæ¢å¤

---

## 6. æœ€ä½³å®è·µ

### 6.1 éƒ¨ç½²å»ºè®®

- **èµ„æºè§„åˆ’**: åˆç†è§„åˆ’èµ„æº
- **å­˜å‚¨é€‰æ‹©**: é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±»å‹
- **ç½‘ç»œé…ç½®**: ä¼˜åŒ–ç½‘ç»œé…ç½®

### 6.2 è¿ç»´å»ºè®®

- **ç›‘æ§å‘Šè­¦**: è®¾ç½®ç›‘æ§å’Œå‘Šè­¦
- **å®šæœŸå¤‡ä»½**: å®šæœŸå¤‡ä»½æ•°æ®
- **ç‰ˆæœ¬å‡çº§**: è§„åˆ’ç‰ˆæœ¬å‡çº§

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 å®˜æ–¹æ–‡æ¡£

- **[Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)**
  - ç‰ˆæœ¬: Kubernetes 1.28+
  - å†…å®¹: Kubernetes çš„å®Œæ•´æ–‡æ¡£ï¼ŒåŒ…æ‹¬ StatefulSetã€Serviceã€PersistentVolume ç­‰
  - æœ€åæ›´æ–°: 2025å¹´

- **[PostgreSQL Operator (CNPG) æ–‡æ¡£](https://cloudnative-pg.io/)**
  - ç‰ˆæœ¬: CloudNativePG 1.20+
  - å†…å®¹: CloudNativePG (CNPG) çš„å®Œæ•´æ–‡æ¡£ï¼Œç”¨äºåœ¨ Kubernetes ä¸Šéƒ¨ç½² PostgreSQL
  - GitHub: <https://github.com/cloudnative-pg/cloudnative-pg>

- **[Crunchy PostgreSQL Operator æ–‡æ¡£](https://www.crunchydata.com/products/crunchy-postgresql-for-kubernetes)**
  - æ¥æº: Crunchy Data
  - å†…å®¹: Crunchy PostgreSQL Operator çš„ä½¿ç”¨æ–‡æ¡£

### 7.2 å­¦æœ¯è®ºæ–‡

- **Burns, B., & Beda, J. (2019). "Kubernetes: Up and Running."**
  - å‡ºç‰ˆç¤¾: O'Reilly Media
  - **é‡è¦æ€§**: Kubernetes çš„æƒå¨æŒ‡å—ï¼Œè¯¦ç»†é˜è¿°äº† Kubernetes çš„æ ¸å¿ƒæ¦‚å¿µå’Œæœ€ä½³å®è·µ

### 7.3 æŠ€æœ¯åšå®¢

- **[PostgreSQL on Kubernetes æœ€ä½³å®è·µ](https://cloudnative-pg.io/documentation/)**
  - æ¥æº: CloudNativePG
  - å†…å®¹: åœ¨ Kubernetes ä¸Šéƒ¨ç½² PostgreSQL çš„æœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼

- **[Kubernetes StatefulSet è¯¦è§£](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)**
  - å†…å®¹: StatefulSet çš„è¯¦ç»†è¯´æ˜ï¼Œç”¨äºéƒ¨ç½²æœ‰çŠ¶æ€çš„ PostgreSQL åº”ç”¨

- **[äº‘åŸç”Ÿæ•°æ®åº“éƒ¨ç½²æŒ‡å—](https://www.postgresql.org/docs/current/cloud-native.html)**
  - å†…å®¹: PostgreSQL åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­çš„éƒ¨ç½²æŒ‡å—

### 7.4 ç›¸å…³èµ„æº

- **[Helm Charts for PostgreSQL](https://artifacthub.io/packages/helm/bitnami/postgresql)**
  - æ¥æº: Bitnami
  - å†…å®¹: PostgreSQL çš„ Helm Chartï¼Œç®€åŒ– Kubernetes éƒ¨ç½²

- **[Prometheus PostgreSQL Exporter](https://github.com/prometheus-community/postgres_exporter)**
  - å†…å®¹: PostgreSQL çš„ Prometheus ç›‘æ§å¯¼å‡ºå™¨

---

## 8. å®Œæ•´ä»£ç ç¤ºä¾‹

### 8.1 Kubernetes StatefulSet éƒ¨ç½²é…ç½®

**PostgreSQL StatefulSet YAML**:

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:14
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: postgres
type: Opaque
data:
  password: c2VjcmV0  # base64 encoded 'secret'
```

### 8.2 CloudNativePG (CNPG) éƒ¨ç½²é…ç½®

**CNPG Cluster YAML**:

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  instances: 3

  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "4MB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
      max_worker_processes: "4"
      max_parallel_workers_per_gather: "2"
      max_parallel_workers: "4"
      max_parallel_maintenance_workers: "2"

  bootstrap:
    initdb:
      database: mydb
      owner: appuser
      secret:
        name: postgres-credentials
      dataChecksums: true
      encoding: "UTF8"
      localeCType: "C"
      localeCollate: "C"

  storage:
    size: 100Gi
    storageClass: fast-ssd

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  backup:
    barmanObjectStore:
      destinationPath: s3://postgres-backups
      s3Credentials:
        accessKeyId:
          name: backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: backup-credentials
          key: SECRET_ACCESS_KEY
      wal:
        retention: "7d"
      data:
        retention: "30d"

  monitoring:
    enabled: true
    podMonitorEnabled: true
```

**Python Kubernetes å®¢æˆ·ç«¯ç®¡ç†è„šæœ¬**:

```python
from kubernetes import client, config
from kubernetes.client.rest import ApiException
from typing import Dict, List

class KubernetesPostgreSQLManager:
    """Kubernetes PostgreSQL ç®¡ç†å™¨"""

    def __init__(self, namespace: str = "postgres"):
        config.load_incluster_config()  # åœ¨é›†ç¾¤å†…è¿è¡Œ
        # æˆ–ä½¿ç”¨ config.load_kube_config() åœ¨é›†ç¾¤å¤–è¿è¡Œ
        self.namespace = namespace
        self.apps_v1 = client.AppsV1Api()
        self.core_v1 = client.CoreV1Api()

    def get_statefulset_status(self, name: str) -> Dict:
        """è·å– StatefulSet çŠ¶æ€"""
        try:
            sts = self.apps_v1.read_namespaced_stateful_set(
                name=name,
                namespace=self.namespace
            )
            return {
                'name': sts.metadata.name,
                'replicas': sts.spec.replicas,
                'ready_replicas': sts.status.ready_replicas,
                'current_replicas': sts.status.current_replicas,
                'updated_replicas': sts.status.updated_replicas
            }
        except ApiException as e:
            print(f"è·å– StatefulSet çŠ¶æ€å¤±è´¥: {e}")
            return None

    def get_pods(self, label_selector: str = "app=postgres") -> List[Dict]:
        """è·å– Pod åˆ—è¡¨"""
        try:
            pods = self.core_v1.list_namespaced_pod(
                namespace=self.namespace,
                label_selector=label_selector
            )
            pod_list = []
            for pod in pods.items:
                pod_list.append({
                    'name': pod.metadata.name,
                    'status': pod.status.phase,
                    'ready': all(
                        condition.status == 'True'
                        for condition in pod.status.conditions
                        if condition.type == 'Ready'
                    ),
                    'node': pod.spec.node_name,
                    'ip': pod.status.pod_ip
                })
            return pod_list
        except ApiException as e:
            print(f"è·å– Pod åˆ—è¡¨å¤±è´¥: {e}")
            return []

    def scale_statefulset(self, name: str, replicas: int) -> bool:
        """æ‰©ç¼©å®¹ StatefulSet"""
        try:
            body = {"spec": {"replicas": replicas}}
            self.apps_v1.patch_namespaced_stateful_set(
                name=name,
                namespace=self.namespace,
                body=body
            )
            print(f"StatefulSet {name} å·²æ‰©ç¼©å®¹åˆ° {replicas} ä¸ªå‰¯æœ¬")
            return True
        except ApiException as e:
            print(f"æ‰©ç¼©å®¹å¤±è´¥: {e}")
            return False

    def get_service_endpoints(self, service_name: str) -> List[str]:
        """è·å–æœåŠ¡ç«¯ç‚¹"""
        try:
            endpoints = self.core_v1.read_namespaced_endpoints(
                name=service_name,
                namespace=self.namespace
            )
            addresses = []
            for subset in endpoints.subsets:
                for address in subset.addresses:
                    addresses.append(f"{address.ip}:5432")
            return addresses
        except ApiException as e:
            print(f"è·å–æœåŠ¡ç«¯ç‚¹å¤±è´¥: {e}")
            return []

# ä½¿ç”¨ç¤ºä¾‹
manager = KubernetesPostgreSQLManager(namespace="postgres")

# è·å– StatefulSet çŠ¶æ€
status = manager.get_statefulset_status("postgres")
print(f"StatefulSet çŠ¶æ€: {status}")

# è·å– Pod åˆ—è¡¨
pods = manager.get_pods()
for pod in pods:
    print(f"Pod {pod['name']}: {pod['status']}, Ready: {pod['ready']}")

# æ‰©ç¼©å®¹
manager.scale_statefulset("postgres", replicas=5)
```

### 8.3 Helm Chart éƒ¨ç½²ç¤ºä¾‹

**Helm Chart values.yaml**:

```yaml
postgresql:
  auth:
    postgresPassword: "secret"
    database: "mydb"
    username: "appuser"
    password: "appsecret"

  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd

    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "1000m"

    nodeSelector: {}
    tolerations: []
    affinity: {}

  readReplicas:
    replicaCount: 2
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd

    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "1000m"

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  backup:
    enabled: true
    schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
    retention: 7
    s3:
      bucket: "postgres-backups"
      endpoint: "s3.amazonaws.com"
      accessKeyId: "your-access-key"
      secretAccessKey: "your-secret-key"
```

**Helm éƒ¨ç½²è„šæœ¬**:

```bash
#!/bin/bash
# éƒ¨ç½² PostgreSQL Helm Chart

helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

helm install postgres bitnami/postgresql \
  --namespace postgres \
  --create-namespace \
  --set auth.postgresPassword=secret \
  --set auth.database=mydb \
  --set primary.persistence.size=100Gi \
  --set primary.persistence.storageClass=fast-ssd \
  --set readReplicas.replicaCount=2 \
  --set metrics.enabled=true \
  --set backup.enabled=true \
  --values values.yaml
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
