# è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥

> **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 18 with æµå¤åˆ¶
> **æ–‡æ¡£ç¼–å·**: 06-04-02

---

## ğŸ“‘ ç›®å½•

- [è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥](#è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æŠ€æœ¯èƒŒæ™¯](#11-æŠ€æœ¯èƒŒæ™¯)
    - [1.2 æŠ€æœ¯å®šä½](#12-æŠ€æœ¯å®šä½)
    - [1.3 æ ¸å¿ƒä»·å€¼](#13-æ ¸å¿ƒä»·å€¼)
  - [2. æŠ€æœ¯åŸç†](#2-æŠ€æœ¯åŸç†)
    - [2.1 åŒæ­¥æ¶æ„è®¾è®¡](#21-åŒæ­¥æ¶æ„è®¾è®¡)
    - [2.2 åŒæ­¥ç­–ç•¥](#22-åŒæ­¥ç­–ç•¥)
    - [2.3 å†²çªè§£å†³æœºåˆ¶](#23-å†²çªè§£å†³æœºåˆ¶)
  - [3. å®ç°æ–¹æ¡ˆ](#3-å®ç°æ–¹æ¡ˆ)
    - [3.1 æµå¤åˆ¶åŒæ­¥](#31-æµå¤åˆ¶åŒæ­¥)
    - [3.2 é€»è¾‘å¤åˆ¶åŒæ­¥](#32-é€»è¾‘å¤åˆ¶åŒæ­¥)
    - [3.3 åŒå‘åŒæ­¥](#33-åŒå‘åŒæ­¥)
  - [4. é…ç½®ä¸éƒ¨ç½²](#4-é…ç½®ä¸éƒ¨ç½²)
    - [4.1 è¾¹ç¼˜èŠ‚ç‚¹é…ç½®](#41-è¾¹ç¼˜èŠ‚ç‚¹é…ç½®)
    - [4.2 äº‘ç«¯ä¸­å¿ƒé…ç½®](#42-äº‘ç«¯ä¸­å¿ƒé…ç½®)
    - [4.3 åŒæ­¥é“¾è·¯é…ç½®](#43-åŒæ­¥é“¾è·¯é…ç½®)
  - [5. æ€§èƒ½ä¼˜åŒ–](#5-æ€§èƒ½ä¼˜åŒ–)
    - [5.1 å¸¦å®½ä¼˜åŒ–](#51-å¸¦å®½ä¼˜åŒ–)
    - [5.2 å»¶è¿Ÿä¼˜åŒ–](#52-å»¶è¿Ÿä¼˜åŒ–)
    - [5.3 å­˜å‚¨ä¼˜åŒ–](#53-å­˜å‚¨ä¼˜åŒ–)
  - [6. ç›‘æ§ä¸è¯Šæ–­](#6-ç›‘æ§ä¸è¯Šæ–­)
    - [6.1 åŒæ­¥çŠ¶æ€ç›‘æ§](#61-åŒæ­¥çŠ¶æ€ç›‘æ§)
    - [6.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#62-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
    - [6.3 æ•…éšœè¯Šæ–­](#63-æ•…éšœè¯Šæ–­)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1 IoTè¾¹ç¼˜æ•°æ®åŒæ­¥](#71-iotè¾¹ç¼˜æ•°æ®åŒæ­¥)
    - [7.2 é›¶å”®è¾¹ç¼˜æ•°æ®åŒæ­¥](#72-é›¶å”®è¾¹ç¼˜æ•°æ®åŒæ­¥)
  - [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
    - [8.1 åŒæ­¥ç­–ç•¥é€‰æ‹©](#81-åŒæ­¥ç­–ç•¥é€‰æ‹©)
    - [8.2 æ³¨æ„äº‹é¡¹](#82-æ³¨æ„äº‹é¡¹)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
  - [10. å®Œæ•´ä»£ç ç¤ºä¾‹](#10-å®Œæ•´ä»£ç ç¤ºä¾‹)
    - [10.1 æµå¤åˆ¶é…ç½®ç¤ºä¾‹](#101-æµå¤åˆ¶é…ç½®ç¤ºä¾‹)
    - [10.2 é€»è¾‘å¤åˆ¶é…ç½®ç¤ºä¾‹](#102-é€»è¾‘å¤åˆ¶é…ç½®ç¤ºä¾‹)
    - [10.3 Python åŒæ­¥ç›‘æ§è„šæœ¬](#103-python-åŒæ­¥ç›‘æ§è„šæœ¬)
    - [10.4 å†²çªè§£å†³ Python å®ç°](#104-å†²çªè§£å†³-python-å®ç°)
    - [10.5 Docker Compose è¾¹ç¼˜-äº‘ç«¯éƒ¨ç½²](#105-docker-compose-è¾¹ç¼˜-äº‘ç«¯éƒ¨ç½²)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

åœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸­ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å’Œäº‘ç«¯ä¸­å¿ƒéœ€è¦ä¿æŒæ•°æ®åŒæ­¥ï¼š

- **è¾¹ç¼˜èŠ‚ç‚¹**ï¼šå¤„ç†æœ¬åœ°æ•°æ®ï¼Œæä¾›ä½å»¶è¿ŸæœåŠ¡
- **äº‘ç«¯ä¸­å¿ƒ**ï¼šé›†ä¸­å­˜å‚¨ï¼Œæä¾›å…¨å±€è§†å›¾å’Œåˆ†æ
- **æ•°æ®åŒæ­¥**ï¼šç¡®ä¿è¾¹ç¼˜å’Œäº‘ç«¯æ•°æ®ä¸€è‡´æ€§

**æŒ‘æˆ˜**ï¼š

- ç½‘ç»œä¸ç¨³å®šï¼šè¾¹ç¼˜èŠ‚ç‚¹å¯èƒ½é—´æ­‡æ€§æ–­ç½‘
- å¸¦å®½é™åˆ¶ï¼šè¾¹ç¼˜åˆ°äº‘ç«¯çš„å¸¦å®½æœ‰é™
- å»¶è¿Ÿè¦æ±‚ï¼šéœ€è¦å¹³è¡¡ä¸€è‡´æ€§å’Œå»¶è¿Ÿ
- å†²çªå¤„ç†ï¼šå¤šè¾¹ç¼˜èŠ‚ç‚¹å¯èƒ½äº§ç”Ÿæ•°æ®å†²çª

### 1.2 æŠ€æœ¯å®šä½

è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥æ˜¯PostgreSQLåœ¨è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸­çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›ï¼š

- **æµå¤åˆ¶åŒæ­¥**ï¼šåŸºäºWALçš„ç‰©ç†å¤åˆ¶
- **é€»è¾‘å¤åˆ¶åŒæ­¥**ï¼šåŸºäºè¡¨çº§åˆ«çš„é€»è¾‘å¤åˆ¶
- **åŒå‘åŒæ­¥**ï¼šæ”¯æŒè¾¹ç¼˜åˆ°äº‘ç«¯å’Œäº‘ç«¯åˆ°è¾¹ç¼˜çš„åŒå‘åŒæ­¥

### 1.3 æ ¸å¿ƒä»·å€¼

- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯è¾¹ç¼˜å’Œäº‘ç«¯æ•°æ®ä¸€è‡´æ€§
- **é«˜å¯ç”¨æ€§**ï¼šè¾¹ç¼˜èŠ‚ç‚¹æ•…éšœæ—¶äº‘ç«¯å¯æ¥ç®¡
- **ä½å»¶è¿Ÿ**ï¼šè¾¹ç¼˜èŠ‚ç‚¹æä¾›æœ¬åœ°ä½å»¶è¿ŸæœåŠ¡
- **çµæ´»åŒæ­¥**ï¼šæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥å’Œå†²çªè§£å†³æœºåˆ¶

---

## 2. æŠ€æœ¯åŸç†

### 2.1 åŒæ­¥æ¶æ„è®¾è®¡

**åŒæ­¥æ¶æ„**ï¼š

```text
è¾¹ç¼˜èŠ‚ç‚¹1 (Edge Node 1)
    â†“ (æµå¤åˆ¶/é€»è¾‘å¤åˆ¶)
äº‘ç«¯ä¸­å¿ƒ (Cloud Center)
    â†“ (æµå¤åˆ¶/é€»è¾‘å¤åˆ¶)
è¾¹ç¼˜èŠ‚ç‚¹2 (Edge Node 2)
```

**åŒæ­¥æ¨¡å¼**ï¼š

1. **å•å‘åŒæ­¥**ï¼šè¾¹ç¼˜ â†’ äº‘ç«¯ï¼ˆæ•°æ®ä¸Šä¼ ï¼‰
2. **å•å‘åŒæ­¥**ï¼šäº‘ç«¯ â†’ è¾¹ç¼˜ï¼ˆé…ç½®ä¸‹å‘ï¼‰
3. **åŒå‘åŒæ­¥**ï¼šè¾¹ç¼˜ â†” äº‘ç«¯ï¼ˆåŒå‘æ•°æ®åŒæ­¥ï¼‰

### 2.2 åŒæ­¥ç­–ç•¥

**åŒæ­¥ç­–ç•¥ç±»å‹**ï¼š

1. **å®æ—¶åŒæ­¥**ï¼š
   - æ•°æ®å˜æ›´ç«‹å³åŒæ­¥
   - ä½å»¶è¿Ÿï¼Œé«˜å¸¦å®½æ¶ˆè€—

2. **æ‰¹é‡åŒæ­¥**ï¼š
   - å®šæœŸæ‰¹é‡åŒæ­¥
   - ä½å¸¦å®½æ¶ˆè€—ï¼Œè¾ƒé«˜å»¶è¿Ÿ

3. **æŒ‰éœ€åŒæ­¥**ï¼š
   - æ ¹æ®éœ€æ±‚è§¦å‘åŒæ­¥
   - å¹³è¡¡å¸¦å®½å’Œå»¶è¿Ÿ

4. **å¢é‡åŒæ­¥**ï¼š
   - åªåŒæ­¥å˜æ›´æ•°æ®
   - ä¼˜åŒ–å¸¦å®½ä½¿ç”¨

### 2.3 å†²çªè§£å†³æœºåˆ¶

**å†²çªç±»å‹**ï¼š

1. **å†™å†²çª**ï¼šå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®
2. **åˆ é™¤å†²çª**ï¼šä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹ä¿®æ”¹
3. **æ’å…¥å†²çª**ï¼šå¤šä¸ªèŠ‚ç‚¹æ’å…¥ç›¸åŒä¸»é”®

**è§£å†³ç­–ç•¥**ï¼š

1. **æœ€åå†™å…¥è·èƒœï¼ˆLWWï¼‰**ï¼šåŸºäºæ—¶é—´æˆ³
2. **åº”ç”¨å±‚è§£å†³**ï¼šåº”ç”¨å±‚å®šä¹‰è§£å†³è§„åˆ™
3. **æ‰‹åŠ¨è§£å†³**ï¼šäººå·¥ä»‹å…¥è§£å†³å†²çª

---

## 3. å®ç°æ–¹æ¡ˆ

### 3.1 æµå¤åˆ¶åŒæ­¥

**æµå¤åˆ¶é…ç½®ï¼ˆè¾¹ç¼˜ â†’ äº‘ç«¯ï¼‰**ï¼š

```sql
-- äº‘ç«¯ä¸­å¿ƒé…ç½®ï¼ˆä¸»èŠ‚ç‚¹ï¼‰
-- postgresql.conf
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10

-- pg_hba.conf
host replication edge_user 0.0.0.0/0 md5

-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER edge_user REPLICATION LOGIN PASSWORD 'password';

-- è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ï¼ˆä»èŠ‚ç‚¹ï¼‰
-- postgresql.conf
hot_standby = on

-- recovery.conf (PostgreSQL 12+)
primary_conninfo = 'host=cloud-center.example.com port=5432 user=edge_user password=password'
primary_slot_name = 'edge_node_1_slot'
```

**æµå¤åˆ¶ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    sync_standby_names
FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag,
    pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag,
    pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag
FROM pg_stat_replication;
```

### 3.2 é€»è¾‘å¤åˆ¶åŒæ­¥

**é€»è¾‘å¤åˆ¶é…ç½®ï¼ˆè¾¹ç¼˜ â†’ äº‘ç«¯ï¼‰**ï¼š

```sql
-- äº‘ç«¯ä¸­å¿ƒé…ç½®ï¼ˆè®¢é˜…è€…ï¼‰
-- postgresql.conf
wal_level = logical
max_replication_slots = 10
max_logical_replication_workers = 10

-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION edge_publication FOR TABLE sensor_data, device_status;

-- è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ï¼ˆå‘å¸ƒè€…ï¼‰
-- postgresql.conf
wal_level = logical
max_replication_slots = 10

-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=cloud-center.example.com port=5432 dbname=postgres user=replication_user password=password'
PUBLICATION edge_publication
WITH (copy_data = false);
```

**é€»è¾‘å¤åˆ¶ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT
    subname,
    subenabled,
    subpublications,
    subslotname
FROM pg_subscription;

-- æŸ¥çœ‹å¤åˆ¶æ§½çŠ¶æ€
SELECT
    slot_name,
    slot_type,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) AS lag_bytes
FROM pg_replication_slots;
```

### 3.3 åŒå‘åŒæ­¥

**åŒå‘åŒæ­¥æ¶æ„**ï¼š

```text
è¾¹ç¼˜èŠ‚ç‚¹ (Edge Node)
    â”œâ”€â”€ å‘å¸ƒè€… (Publisher) â†’ äº‘ç«¯è®¢é˜…
    â””â”€â”€ è®¢é˜…è€… (Subscriber) â† äº‘ç«¯å‘å¸ƒ
äº‘ç«¯ä¸­å¿ƒ (Cloud Center)
    â”œâ”€â”€ å‘å¸ƒè€… (Publisher) â†’ è¾¹ç¼˜è®¢é˜…
    â””â”€â”€ è®¢é˜…è€… (Subscriber) â† è¾¹ç¼˜å‘å¸ƒ
```

**åŒå‘åŒæ­¥é…ç½®**ï¼š

```sql
-- äº‘ç«¯ä¸­å¿ƒï¼šå‘å¸ƒå’Œè®¢é˜…
CREATE PUBLICATION cloud_publication FOR TABLE config, updates;
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=edge-node.example.com port=5432 dbname=postgres user=replication_user password=password'
PUBLICATION edge_publication;

-- è¾¹ç¼˜èŠ‚ç‚¹ï¼šå‘å¸ƒå’Œè®¢é˜…
CREATE PUBLICATION edge_publication FOR TABLE sensor_data, local_config;
CREATE SUBSCRIPTION cloud_subscription
CONNECTION 'host=cloud-center.example.com port=5432 dbname=postgres user=replication_user password=password'
PUBLICATION cloud_publication;
```

---

## 4. é…ç½®ä¸éƒ¨ç½²

### 4.1 è¾¹ç¼˜èŠ‚ç‚¹é…ç½®

**è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ç¤ºä¾‹**ï¼š

```bash
# postgresql.conf
# æµå¤åˆ¶é…ç½®
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on

# é€»è¾‘å¤åˆ¶é…ç½®
wal_level = logical
max_replication_slots = 5
max_logical_replication_workers = 5

# æ€§èƒ½ä¼˜åŒ–
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB
```

### 4.2 äº‘ç«¯ä¸­å¿ƒé…ç½®

**äº‘ç«¯ä¸­å¿ƒé…ç½®ç¤ºä¾‹**ï¼š

```bash
# postgresql.conf
# æµå¤åˆ¶é…ç½®
wal_level = replica
max_wal_senders = 20
max_replication_slots = 20

# é€»è¾‘å¤åˆ¶é…ç½®
wal_level = logical
max_replication_slots = 50
max_logical_replication_workers = 50

# æ€§èƒ½ä¼˜åŒ–
shared_buffers = 8GB
effective_cache_size = 24GB
maintenance_work_mem = 1GB
checkpoint_completion_target = 0.9
wal_buffers = 64MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 64MB
min_wal_size = 4GB
max_wal_size = 16GB
```

### 4.3 åŒæ­¥é“¾è·¯é…ç½®

**åŒæ­¥é“¾è·¯é…ç½®è„šæœ¬**ï¼š

```bash
#!/bin/bash
# configure_sync.sh

# é…ç½®è¾¹ç¼˜èŠ‚ç‚¹åˆ°äº‘ç«¯çš„åŒæ­¥
EDGE_NODE=$1
CLOUD_CENTER=$2

# åœ¨äº‘ç«¯åˆ›å»ºå¤åˆ¶ç”¨æˆ·
psql -h $CLOUD_CENTER -U postgres <<EOF
CREATE USER edge_replication REPLICATION LOGIN PASSWORD 'secure_password';
CREATE PUBLICATION edge_publication FOR ALL TABLES;
EOF

# åœ¨è¾¹ç¼˜èŠ‚ç‚¹åˆ›å»ºè®¢é˜…
psql -h $EDGE_NODE -U postgres <<EOF
CREATE SUBSCRIPTION cloud_subscription
CONNECTION 'host=$CLOUD_CENTER port=5432 dbname=postgres user=edge_replication password=secure_password'
PUBLICATION edge_publication;
EOF
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å¸¦å®½ä¼˜åŒ–

**å¸¦å®½ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **å‹ç¼©WAL**ï¼š

   ```sql
   ALTER SYSTEM SET wal_compression = on;
   SELECT pg_reload_conf();
   ```

2. **æ‰¹é‡åŒæ­¥**ï¼š

   ```sql
   -- ä½¿ç”¨æ‰¹é‡æ’å…¥å‡å°‘ç½‘ç»œå¾€è¿”
   INSERT INTO target_table SELECT * FROM source_table;
   ```

3. **å¢é‡åŒæ­¥**ï¼š

   ```sql
   -- åªåŒæ­¥å˜æ›´æ•°æ®
   SELECT * FROM source_table
   WHERE updated_at > (SELECT MAX(updated_at) FROM target_table);
   ```

### 5.2 å»¶è¿Ÿä¼˜åŒ–

**å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥**ï¼š

1. **å¼‚æ­¥å¤åˆ¶**ï¼š

   ```sql
   -- ä½¿ç”¨å¼‚æ­¥å¤åˆ¶å‡å°‘å»¶è¿Ÿ
   ALTER SYSTEM SET synchronous_standby_names = '';
   SELECT pg_reload_conf();
   ```

2. **æœ¬åœ°ç¼“å­˜**ï¼š

   ```sql
   -- ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘æŸ¥è¯¢å»¶è¿Ÿ
   CREATE MATERIALIZED VIEW local_cache AS
   SELECT * FROM remote_table;
   ```

### 5.3 å­˜å‚¨ä¼˜åŒ–

**å­˜å‚¨ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **åˆ†åŒºè¡¨**ï¼š

   ```sql
   -- ä½¿ç”¨åˆ†åŒºè¡¨ä¼˜åŒ–å­˜å‚¨
   CREATE TABLE sensor_data (
       id SERIAL,
       sensor_id INT,
       value NUMERIC,
       timestamp TIMESTAMP
   ) PARTITION BY RANGE (timestamp);
   ```

2. **æ•°æ®å½’æ¡£**ï¼š

   ```sql
   -- å½’æ¡£æ—§æ•°æ®
   CREATE TABLE sensor_data_archive (
       LIKE sensor_data INCLUDING ALL
   );
   ```

---

## 6. ç›‘æ§ä¸è¯Šæ–­

### 6.1 åŒæ­¥çŠ¶æ€ç›‘æ§

**åŒæ­¥çŠ¶æ€æŸ¥è¯¢**ï¼š

```sql
-- æµå¤åˆ¶çŠ¶æ€
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS lag_bytes
FROM pg_stat_replication;

-- é€»è¾‘å¤åˆ¶çŠ¶æ€
SELECT
    subname,
    subenabled,
    subslotname,
    (SELECT pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)
     FROM pg_replication_slots
     WHERE slot_name = subslotname) AS lag_bytes
FROM pg_subscription;
```

### 6.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

**æ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢**ï¼š

```sql
-- å¤åˆ¶å»¶è¿Ÿ
SELECT
    application_name,
    EXTRACT(EPOCH FROM (now() - write_lag)) AS write_lag_seconds,
    EXTRACT(EPOCH FROM (now() - flush_lag)) AS flush_lag_seconds,
    EXTRACT(EPOCH FROM (now() - replay_lag)) AS replay_lag_seconds
FROM pg_stat_replication;

-- å¤åˆ¶ååé‡
SELECT
    application_name,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn
FROM pg_stat_replication;
```

### 6.3 æ•…éšœè¯Šæ–­

**æ•…éšœè¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥ç½‘ç»œè¿æ¥**ï¼š

   ```bash
   psql -h cloud-center.example.com -U replication_user -d postgres -c "SELECT 1;"
   ```

2. **æ£€æŸ¥å¤åˆ¶æ§½**ï¼š

   ```sql
   SELECT * FROM pg_replication_slots;
   ```

3. **æ£€æŸ¥WALæ–‡ä»¶**ï¼š

   ```sql
   SELECT * FROM pg_ls_waldir() ORDER BY modification DESC LIMIT 10;
   ```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 IoTè¾¹ç¼˜æ•°æ®åŒæ­¥

**åœºæ™¯**ï¼šIoTè®¾å¤‡åœ¨è¾¹ç¼˜èŠ‚ç‚¹æ”¶é›†æ•°æ®ï¼ŒåŒæ­¥åˆ°äº‘ç«¯è¿›è¡Œåˆ†æ

**å®ç°**ï¼š

```sql
-- è¾¹ç¼˜èŠ‚ç‚¹ï¼šå‘å¸ƒä¼ æ„Ÿå™¨æ•°æ®
CREATE PUBLICATION iot_publication FOR TABLE sensor_readings;

-- äº‘ç«¯ä¸­å¿ƒï¼šè®¢é˜…ä¼ æ„Ÿå™¨æ•°æ®
CREATE SUBSCRIPTION iot_subscription
CONNECTION 'host=edge-node.example.com port=5432 dbname=iot user=replication password=password'
PUBLICATION iot_publication;

-- äº‘ç«¯åˆ†ææŸ¥è¯¢
SELECT
    sensor_id,
    AVG(value) AS avg_value,
    MAX(value) AS max_value,
    MIN(value) AS min_value
FROM sensor_readings
WHERE timestamp > NOW() - INTERVAL '1 hour'
GROUP BY sensor_id;
```

### 7.2 é›¶å”®è¾¹ç¼˜æ•°æ®åŒæ­¥

**åœºæ™¯**ï¼šé›¶å”®é—¨åº—åœ¨è¾¹ç¼˜èŠ‚ç‚¹å¤„ç†äº¤æ˜“ï¼ŒåŒæ­¥åˆ°äº‘ç«¯è¿›è¡Œåº“å­˜ç®¡ç†

**å®ç°**ï¼š

```sql
-- è¾¹ç¼˜èŠ‚ç‚¹ï¼šå‘å¸ƒäº¤æ˜“æ•°æ®
CREATE PUBLICATION retail_publication FOR TABLE transactions, inventory_changes;

-- äº‘ç«¯ä¸­å¿ƒï¼šè®¢é˜…äº¤æ˜“æ•°æ®
CREATE SUBSCRIPTION retail_subscription
CONNECTION 'host=store-edge.example.com port=5432 dbname=retail user=replication password=password'
PUBLICATION retail_publication;

-- äº‘ç«¯åº“å­˜ç®¡ç†
SELECT
    product_id,
    SUM(quantity) AS total_sold,
    SUM(amount) AS total_revenue
FROM transactions
WHERE transaction_date = CURRENT_DATE
GROUP BY product_id;
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 åŒæ­¥ç­–ç•¥é€‰æ‹©

**ç­–ç•¥é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|------|---------|------|
| **å®æ—¶æ•°æ®é‡‡é›†** | æµå¤åˆ¶ | ä½å»¶è¿Ÿï¼Œé«˜ä¸€è‡´æ€§ |
| **æ‰¹é‡æ•°æ®ä¸Šä¼ ** | é€»è¾‘å¤åˆ¶ | çµæ´»ï¼Œå¯é€‰æ‹©æ€§åŒæ­¥ |
| **é…ç½®ä¸‹å‘** | é€»è¾‘å¤åˆ¶ | æŒ‰éœ€åŒæ­¥ï¼Œå‡å°‘å¸¦å®½ |
| **åŒå‘åŒæ­¥** | é€»è¾‘å¤åˆ¶ | æ”¯æŒåŒå‘ï¼Œå†²çªè§£å†³ |

### 8.2 æ³¨æ„äº‹é¡¹

**æ³¨æ„äº‹é¡¹**ï¼š

1. **ç½‘ç»œç¨³å®šæ€§**ï¼šç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šï¼Œé…ç½®é‡è¿æœºåˆ¶
2. **å†²çªå¤„ç†**ï¼šå®šä¹‰æ¸…æ™°çš„å†²çªè§£å†³ç­–ç•¥
3. **æ€§èƒ½ç›‘æ§**ï¼šæŒç»­ç›‘æ§åŒæ­¥å»¶è¿Ÿå’Œååé‡
4. **æ•…éšœæ¢å¤**ï¼šåˆ¶å®šæ•…éšœæ¢å¤å’Œå›æ»šç­–ç•¥

---

## 9. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

1. **PostgreSQLæµå¤åˆ¶**ï¼š
   - [Streaming Replication](https://www.postgresql.org/docs/current/high-availability.html)
   - [Replication Slots](https://www.postgresql.org/docs/current/replication-slots.html)

2. **PostgreSQLé€»è¾‘å¤åˆ¶**ï¼š
   - [Logical Replication](https://www.postgresql.org/docs/current/logical-replication.html)
   - [Publication and Subscription](https://www.postgresql.org/docs/current/logical-replication-publication.html)

### æŠ€æœ¯åšå®¢

1. **è¾¹ç¼˜è®¡ç®—æ•°æ®åŒæ­¥**ï¼š
   - PostgreSQLè¾¹ç¼˜è®¡ç®—æœ€ä½³å®è·µ
   - è¾¹ç¼˜-äº‘ç«¯æ•°æ®åŒæ­¥æ¡ˆä¾‹

---

## 10. å®Œæ•´ä»£ç ç¤ºä¾‹

### 10.1 æµå¤åˆ¶é…ç½®ç¤ºä¾‹

**è¾¹ç¼˜èŠ‚ç‚¹é…ç½®ï¼ˆpostgresql.confï¼‰**ï¼š

```ini
# æµå¤åˆ¶é…ç½®
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on

# åŒæ­¥å¤åˆ¶é…ç½®ï¼ˆå¯é€‰ï¼‰
synchronous_standby_names = 'ANY 1 (edge_node_1, edge_node_2)'
```

**pg_hba.conf é…ç½®**ï¼š

```ini
# å…è®¸äº‘ç«¯ä¸­å¿ƒè¿æ¥
host    replication     postgres     cloud_center_ip/32    md5
```

**åˆ›å»ºå¤åˆ¶æ§½**ï¼š

```sql
-- åœ¨äº‘ç«¯ä¸­å¿ƒåˆ›å»ºå¤åˆ¶æ§½
SELECT pg_create_physical_replication_slot('edge_node_1_slot');

-- æŸ¥çœ‹å¤åˆ¶æ§½çŠ¶æ€
SELECT * FROM pg_replication_slots;
```

### 10.2 é€»è¾‘å¤åˆ¶é…ç½®ç¤ºä¾‹

**äº‘ç«¯ä¸­å¿ƒå‘å¸ƒé…ç½®**ï¼š

```sql
-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION edge_sync_pub FOR TABLE
    products,
    inventory,
    transactions;

-- æŸ¥çœ‹å‘å¸ƒ
SELECT * FROM pg_publication;
SELECT * FROM pg_publication_tables;
```

**è¾¹ç¼˜èŠ‚ç‚¹è®¢é˜…é…ç½®**ï¼š

```sql
-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION edge_subscription
CONNECTION 'host=cloud_center_ip port=5432 dbname=production user=replicator password=secret'
PUBLICATION edge_sync_pub
WITH (
    copy_data = true,
    create_slot = true,
    enabled = true,
    slot_name = 'edge_subscription_slot'
);

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
SELECT * FROM pg_subscription_rel;
```

### 10.3 Python åŒæ­¥ç›‘æ§è„šæœ¬

**åŒæ­¥çŠ¶æ€ç›‘æ§**ï¼š

```python
import psycopg2
import time
from datetime import datetime

class SyncMonitor:
    def __init__(self, edge_conn_str, cloud_conn_str):
        """åˆå§‹åŒ–åŒæ­¥ç›‘æ§å™¨"""
        self.edge_conn = psycopg2.connect(edge_conn_str)
        self.cloud_conn = psycopg2.connect(cloud_conn_str)

    def check_replication_lag(self):
        """æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ"""
        cur = self.edge_conn.cursor()

        # æŸ¥è¯¢å¤åˆ¶å»¶è¿Ÿ
        cur.execute("""
            SELECT
                client_addr,
                state,
                sent_lsn,
                write_lsn,
                flush_lsn,
                replay_lsn,
                sync_state
            FROM pg_stat_replication
        """)

        results = cur.fetchall()
        for row in results:
            print(f"Replication Status: {row[1]}, LSN: {row[2]}")

        return results

    def check_logical_replication(self):
        """æ£€æŸ¥é€»è¾‘å¤åˆ¶çŠ¶æ€"""
        cur = self.edge_conn.cursor()

        # æŸ¥è¯¢è®¢é˜…çŠ¶æ€
        cur.execute("""
            SELECT
                subname,
                subenabled,
                subslotname,
                subpublications
            FROM pg_subscription
        """)

        results = cur.fetchall()
        for row in results:
            print(f"Subscription: {row[0]}, Enabled: {row[1]}")

        return results

    def monitor_sync_health(self):
        """ç›‘æ§åŒæ­¥å¥åº·çŠ¶æ€"""
        while True:
            print(f"\n[{datetime.now()}] Checking sync health...")

            # æ£€æŸ¥æµå¤åˆ¶
            self.check_replication_lag()

            # æ£€æŸ¥é€»è¾‘å¤åˆ¶
            self.check_logical_replication()

            time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

# ä½¿ç”¨ç¤ºä¾‹
monitor = SyncMonitor(
    edge_conn_str="host=localhost dbname=edge_db user=postgres password=secret",
    cloud_conn_str="host=cloud_center dbname=cloud_db user=postgres password=secret"
)

monitor.monitor_sync_health()
```

### 10.4 å†²çªè§£å†³ Python å®ç°

**å†²çªè§£å†³ç­–ç•¥**ï¼š

```python
import psycopg2
from datetime import datetime

class ConflictResolver:
    def __init__(self, conn_str):
        """åˆå§‹åŒ–å†²çªè§£å†³å™¨"""
        self.conn = psycopg2.connect(conn_str)

    def resolve_conflict(self, table_name, local_row, remote_row, conflict_type):
        """è§£å†³å†²çª"""
        cur = self.conn.cursor()

        if conflict_type == 'timestamp':
            # æ—¶é—´æˆ³ç­–ç•¥ï¼šé€‰æ‹©æœ€æ–°çš„
            if local_row['updated_at'] > remote_row['updated_at']:
                return local_row
            else:
                return remote_row

        elif conflict_type == 'merge':
            # åˆå¹¶ç­–ç•¥ï¼šåˆå¹¶ä¸¤ä¸ªç‰ˆæœ¬
            merged = local_row.copy()
            for key, value in remote_row.items():
                if key not in merged or merged[key] is None:
                    merged[key] = value
            return merged

        elif conflict_type == 'manual':
            # æ‰‹åŠ¨è§£å†³ï¼šè®°å½•å†²çªï¼Œç­‰å¾…äººå·¥å¤„ç†
            cur.execute("""
                INSERT INTO conflict_log (table_name, local_data, remote_data, created_at)
                VALUES (%s, %s, %s, %s)
            """, (table_name, str(local_row), str(remote_row), datetime.now()))
            self.conn.commit()
            return None

    def auto_resolve_conflicts(self):
        """è‡ªåŠ¨è§£å†³æ‰€æœ‰å†²çª"""
        cur = self.conn.cursor()

        # æŸ¥è¯¢æ‰€æœ‰å†²çª
        cur.execute("""
            SELECT id, table_name, local_data, remote_data, conflict_type
            FROM conflict_log
            WHERE resolved = false
        """)

        conflicts = cur.fetchall()
        for conflict in conflicts:
            conflict_id, table_name, local_data, remote_data, conflict_type = conflict

            # è§£å†³å†²çª
            resolved_data = self.resolve_conflict(
                table_name,
                local_data,
                remote_data,
                conflict_type
            )

            if resolved_data:
                # æ›´æ–°æ•°æ®
                cur.execute(f"""
                    UPDATE {table_name}
                    SET {', '.join([f"{k} = %s" for k in resolved_data.keys()])}
                    WHERE id = %s
                """, list(resolved_data.values()) + [conflict_id])

                # æ ‡è®°å†²çªå·²è§£å†³
                cur.execute("""
                    UPDATE conflict_log
                    SET resolved = true, resolved_at = %s
                    WHERE id = %s
                """, (datetime.now(), conflict_id))

        self.conn.commit()

# ä½¿ç”¨ç¤ºä¾‹
resolver = ConflictResolver("host=localhost dbname=testdb user=postgres password=secret")
resolver.auto_resolve_conflicts()
```

### 10.5 Docker Compose è¾¹ç¼˜-äº‘ç«¯éƒ¨ç½²

**docker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  cloud_center:
    image: postgres:18
    environment:
      POSTGRES_DB: cloud_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
    ports:
      - "5432:5432"
    volumes:
      - cloud_data:/var/lib/postgresql/data
      - ./cloud_postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf

  edge_node_1:
    image: postgres:18
    environment:
      POSTGRES_DB: edge_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
    ports:
      - "5433:5432"
    volumes:
      - edge1_data:/var/lib/postgresql/data
      - ./edge_postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    depends_on:
      - cloud_center

  edge_node_2:
    image: postgres:18
    environment:
      POSTGRES_DB: edge_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
    ports:
      - "5434:5432"
    volumes:
      - edge2_data:/var/lib/postgresql/data
      - ./edge_postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    depends_on:
      - cloud_center

volumes:
  cloud_data:
  edge1_data:
  edge2_data:
```

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
