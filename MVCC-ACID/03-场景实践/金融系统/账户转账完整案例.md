# é‡‘èç³»ç»Ÿè´¦æˆ·è½¬è´¦å®Œæ•´æ¡ˆä¾‹

> **æ–‡æ¡£ç¼–å·**: SCENARIO-FINANCE-001
> **ä¸»é¢˜**: é‡‘èç³»ç»Ÿè´¦æˆ·è½¬è´¦
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ğŸ“‘ ç›®å½•

- [é‡‘èç³»ç»Ÿè´¦æˆ·è½¬è´¦å®Œæ•´æ¡ˆä¾‹](#é‡‘èç³»ç»Ÿè´¦æˆ·è½¬è´¦å®Œæ•´æ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸šåŠ¡åœºæ™¯åˆ†æ](#-ç¬¬ä¸€éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯åˆ†æ)
    - [1.1 ä¸šåŠ¡éœ€æ±‚](#11-ä¸šåŠ¡éœ€æ±‚)
      - [æ ¸å¿ƒéœ€æ±‚](#æ ¸å¿ƒéœ€æ±‚)
      - [åˆè§„è¦æ±‚](#åˆè§„è¦æ±‚)
      - [å¯é æ€§è¦æ±‚](#å¯é æ€§è¦æ±‚)
    - [1.2 å¹¶å‘åœºæ™¯](#12-å¹¶å‘åœºæ™¯)
      - [å¹¶å‘è½¬è´¦](#å¹¶å‘è½¬è´¦)
      - [ä½™é¢ä¸€è‡´æ€§é—®é¢˜](#ä½™é¢ä¸€è‡´æ€§é—®é¢˜)
      - [æ­»é”é£é™©](#æ­»é”é£é™©)
  - [ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“è®¾è®¡](#-ç¬¬äºŒéƒ¨åˆ†æ•°æ®åº“è®¾è®¡)
    - [2.1 è¡¨ç»“æ„è®¾è®¡](#21-è¡¨ç»“æ„è®¾è®¡)
      - [è´¦æˆ·è¡¨è®¾è®¡](#è´¦æˆ·è¡¨è®¾è®¡)
      - [äº¤æ˜“è®°å½•è¡¨è®¾è®¡](#äº¤æ˜“è®°å½•è¡¨è®¾è®¡)
      - [å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡](#å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡)
    - [2.2 ç´¢å¼•è®¾è®¡](#22-ç´¢å¼•è®¾è®¡)
    - [2.3 MVCCä¼˜åŒ–è®¾è®¡](#23-mvccä¼˜åŒ–è®¾è®¡)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹åŠ¡å®ç°æ–¹æ¡ˆ](#-ç¬¬ä¸‰éƒ¨åˆ†äº‹åŠ¡å®ç°æ–¹æ¡ˆ)
    - [3.1 æ–¹æ¡ˆ1ï¼šREPEATABLE READéš”ç¦»çº§åˆ«](#31-æ–¹æ¡ˆ1repeatable-readéš”ç¦»çº§åˆ«)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç )
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
    - [3.2 æ–¹æ¡ˆ2ï¼šSERIALIZABLEéš”ç¦»çº§åˆ«](#32-æ–¹æ¡ˆ2serializableéš”ç¦»çº§åˆ«)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç -1)
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ-1)
    - [3.3 æ–¹æ¡ˆ3ï¼šåº”ç”¨å±‚é”](#33-æ–¹æ¡ˆ3åº”ç”¨å±‚é”)
      - [å®ç°ä»£ç ](#å®ç°ä»£ç -2)
      - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ-2)
  - [ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¯­è¨€å®ç°](#-ç¬¬å››éƒ¨åˆ†å¤šè¯­è¨€å®ç°)
    - [4.1 Pythonå®ç°](#41-pythonå®ç°)
    - [4.2 Javaå®ç°](#42-javaå®ç°)
    - [4.3 Goå®ç°](#43-goå®ç°)
  - [ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–](#-ç¬¬äº”éƒ¨åˆ†æ€§èƒ½ä¼˜åŒ–)
    - [5.1 è¿æ¥æ± ä¼˜åŒ–](#51-è¿æ¥æ± ä¼˜åŒ–)
    - [5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–](#52-æ‰¹é‡æ“ä½œä¼˜åŒ–)
  - [ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§å’Œå‘Šè­¦](#-ç¬¬å…­éƒ¨åˆ†ç›‘æ§å’Œå‘Šè­¦)
    - [6.1 å…³é”®æŒ‡æ ‡ç›‘æ§](#61-å…³é”®æŒ‡æ ‡ç›‘æ§)
    - [6.2 å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒæ–¹æ¡ˆ](#æ ¸å¿ƒæ–¹æ¡ˆ)
    - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ“‹ æ¦‚è¿°

é‡‘èç³»ç»Ÿè´¦æˆ·è½¬è´¦æ˜¯å…¸å‹çš„ACIDäº‹åŠ¡åœºæ™¯ï¼Œéœ€è¦ä¿è¯èµ„é‡‘å®‰å…¨ã€æ•°æ®ä¸€è‡´æ€§å’Œé«˜å¯é æ€§ã€‚æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–æ•°æ®åº“è®¾è®¡ã€äº‹åŠ¡å®ç°ã€å¤šè¯­è¨€å®ç°ã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§å‘Šè­¦ã€‚

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸šåŠ¡åœºæ™¯åˆ†æ

### 1.1 ä¸šåŠ¡éœ€æ±‚

#### æ ¸å¿ƒéœ€æ±‚

```sql
-- ä¸šåŠ¡åœºæ™¯ï¼šè´¦æˆ·Aå‘è´¦æˆ·Bè½¬è´¦
-- è¦æ±‚ï¼š
-- 1. åŸå­æ€§ï¼šè½¬è´¦å¿…é¡»å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
-- 2. ä¸€è‡´æ€§ï¼šè´¦æˆ·ä½™é¢å¿…é¡»å‡†ç¡®
-- 3. éš”ç¦»æ€§ï¼šå¹¶å‘è½¬è´¦ä¸èƒ½ç›¸äº’å¹²æ‰°
-- 4. æŒä¹…æ€§ï¼šè½¬è´¦è®°å½•å¿…é¡»æŒä¹…åŒ–
-- 5. å¯è¿½æº¯ï¼šæ‰€æœ‰è½¬è´¦å¿…é¡»æœ‰å®¡è®¡æ—¥å¿—
```

#### åˆè§„è¦æ±‚

- **å®¡è®¡è¦æ±‚**ï¼šæ‰€æœ‰äº¤æ˜“å¿…é¡»æœ‰å®Œæ•´å®¡è®¡æ—¥å¿—
- **æ•°æ®ä¿ç•™**ï¼šäº¤æ˜“è®°å½•è‡³å°‘ä¿ç•™7å¹´
- **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¯†å­˜å‚¨
- **è®¿é—®æ§åˆ¶**ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶

#### å¯é æ€§è¦æ±‚

- **å¯ç”¨æ€§**: 99.99%
- **æ•°æ®ä¸€è‡´æ€§**: 100%
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨æ•…éšœè½¬ç§»
- **æ•°æ®å¤‡ä»½**: å®æ—¶å¤‡ä»½

### 1.2 å¹¶å‘åœºæ™¯

#### å¹¶å‘è½¬è´¦

```sql
-- åœºæ™¯ï¼šè´¦æˆ·AåŒæ—¶å‘è´¦æˆ·Bå’Œè´¦æˆ·Cè½¬è´¦
-- é—®é¢˜ï¼šå¦‚ä½•ä¿è¯ä½™é¢ä¸€è‡´æ€§ï¼Ÿ
```

#### ä½™é¢ä¸€è‡´æ€§é—®é¢˜

```sql
-- é—®é¢˜åœºæ™¯ï¼š
-- æ—¶é—´T1: è´¦æˆ·Aä½™é¢=1000ï¼Œå‘Bè½¬è´¦100
-- æ—¶é—´T2: è´¦æˆ·Aä½™é¢=1000ï¼Œå‘Cè½¬è´¦200
-- æ—¶é—´T3: è½¬è´¦1å®Œæˆï¼Œä½™é¢=900
-- æ—¶é—´T4: è½¬è´¦2å®Œæˆï¼Œä½™é¢=800
-- é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªäº‹åŠ¡éƒ½åŸºäºT1çš„ä½™é¢ï¼Œå¯èƒ½å¯¼è‡´ä½™é¢ä¸ä¸€è‡´
```

#### æ­»é”é£é™©

```sql
-- æ­»é”åœºæ™¯ï¼š
-- äº‹åŠ¡1: Aè½¬è´¦ç»™Bï¼ˆé”å®šAï¼Œç„¶åé”å®šBï¼‰
-- äº‹åŠ¡2: Bè½¬è´¦ç»™Aï¼ˆé”å®šBï¼Œç„¶åé”å®šAï¼‰
-- ç»“æœï¼šå¯èƒ½å‘ç”Ÿæ­»é”
```

---

## ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„è®¾è®¡

#### è´¦æˆ·è¡¨è®¾è®¡

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    id BIGSERIAL PRIMARY KEY,
    account_no VARCHAR(50) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    balance DECIMAL(15, 2) NOT NULL DEFAULT 0,
    frozen_balance DECIMAL(15, 2) NOT NULL DEFAULT 0,  -- å†»ç»“é‡‘é¢
    version INT NOT NULL DEFAULT 0,  -- ä¹è§‚é”ç‰ˆæœ¬å·
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- çº¦æŸï¼šä½™é¢ä¸èƒ½ä¸ºè´Ÿ
    CONSTRAINT chk_balance_non_negative CHECK (balance >= 0),
    CONSTRAINT chk_frozen_balance_non_negative CHECK (frozen_balance >= 0)
);

-- ç´¢å¼•
CREATE INDEX idx_accounts_account_no ON accounts(account_no);
CREATE INDEX idx_accounts_user_id ON accounts(user_id);
CREATE INDEX idx_accounts_status ON accounts(status);
```

#### äº¤æ˜“è®°å½•è¡¨è®¾è®¡

```sql
-- äº¤æ˜“è®°å½•è¡¨
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    transaction_no VARCHAR(100) UNIQUE NOT NULL,
    from_account_id BIGINT REFERENCES accounts(id),
    to_account_id BIGINT REFERENCES accounts(id),
    amount DECIMAL(15, 2) NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,  -- transfer, deposit, withdraw
    status VARCHAR(20) DEFAULT 'pending',  -- pending, completed, failed, cancelled
    remark TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,

    -- çº¦æŸï¼šè½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0
    CONSTRAINT chk_amount_positive CHECK (amount > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_transactions_from_account ON transactions(from_account_id);
CREATE INDEX idx_transactions_to_account ON transactions(to_account_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);
CREATE INDEX idx_transactions_transaction_no ON transactions(transaction_no);
```

#### å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡

```sql
-- å®¡è®¡æ—¥å¿—è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼‰
CREATE TABLE audit_logs (
    id BIGSERIAL,
    transaction_id BIGINT,
    account_id BIGINT,
    action VARCHAR(50) NOT NULL,  -- transfer_out, transfer_in, balance_check
    old_balance DECIMAL(15, 2),
    new_balance DECIMAL(15, 2),
    amount DECIMAL(15, 2),
    operator_id BIGINT,
    ip_address INET,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE audit_logs_2024_01 PARTITION OF audit_logs
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE audit_logs_2024_02 PARTITION OF audit_logs
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... å…¶ä»–æœˆä»½åˆ†åŒº

-- ç´¢å¼•
CREATE INDEX idx_audit_logs_transaction_id ON audit_logs(transaction_id);
CREATE INDEX idx_audit_logs_account_id ON audit_logs(account_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

### 2.2 ç´¢å¼•è®¾è®¡

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_transactions_account_status ON transactions(from_account_id, status, created_at);
CREATE INDEX idx_audit_logs_account_created ON audit_logs(account_id, created_at);
```

### 2.3 MVCCä¼˜åŒ–è®¾è®¡

```sql
-- è´¦æˆ·è¡¨ï¼šæ›´æ–°é¢‘ç¹ï¼Œéœ€è¦é¢‘ç¹VACUUM
ALTER TABLE accounts SET (
    fillfactor = 80,
    autovacuum_vacuum_scale_factor = 0.05,
    autovacuum_analyze_scale_factor = 0.02
);

-- äº¤æ˜“è®°å½•è¡¨ï¼šæ’å…¥ä¸ºä¸»
ALTER TABLE transactions SET (
    fillfactor = 100,
    autovacuum_vacuum_scale_factor = 0.1
);
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹åŠ¡å®ç°æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆ1ï¼šREPEATABLE READéš”ç¦»çº§åˆ«

#### å®ç°ä»£ç 

```sql
-- REPEATABLE READéš”ç¦»çº§åˆ«å®ç°è½¬è´¦
BEGIN ISOLATION LEVEL REPEATABLE READ;

-- 1. æ£€æŸ¥è½¬å‡ºè´¦æˆ·ä½™é¢
SELECT balance, frozen_balance
INTO current_balance, current_frozen
FROM accounts
WHERE id = $1;

-- 2. æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
IF current_balance - current_frozen < $3 THEN
    RAISE EXCEPTION 'Insufficient balance';
END IF;

-- 3. æ‰£å‡è½¬å‡ºè´¦æˆ·
UPDATE accounts
SET balance = balance - $3,
    updated_at = NOW()
WHERE id = $1;

-- 4. å¢åŠ è½¬å…¥è´¦æˆ·
UPDATE accounts
SET balance = balance + $3,
    updated_at = NOW()
WHERE id = $2;

-- 5. åˆ›å»ºäº¤æ˜“è®°å½•
INSERT INTO transactions (transaction_no, from_account_id, to_account_id, amount, status)
VALUES ($4, $1, $2, $3, 'completed');

-- 6. è®°å½•å®¡è®¡æ—¥å¿—
INSERT INTO audit_logs (transaction_id, account_id, action, old_balance, new_balance, amount)
VALUES (currval('transactions_id_seq'), $1, 'transfer_out', current_balance, current_balance - $3, $3);

INSERT INTO audit_logs (transaction_id, account_id, action, old_balance, new_balance, amount)
SELECT currval('transactions_id_seq'), $2, 'transfer_in', balance, balance + $3, $3
FROM accounts WHERE id = $2;

COMMIT;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. é¿å…å¹»è¯»
-- 2. ä¿è¯ä¸€è‡´æ€§
--
-- ç¼ºç‚¹ï¼š
-- 1. å¯èƒ½åºåˆ—åŒ–é”™è¯¯ï¼ˆéœ€è¦é‡è¯•ï¼‰
-- 2. æ€§èƒ½ä¸­ç­‰
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 1000-2000
-- P99å»¶è¿Ÿ: 30-60ms
-- åºåˆ—åŒ–é”™è¯¯ç‡: 1-5%
```

### 3.2 æ–¹æ¡ˆ2ï¼šSERIALIZABLEéš”ç¦»çº§åˆ«

#### å®ç°ä»£ç 

```sql
-- SERIALIZABLEéš”ç¦»çº§åˆ«å®ç°è½¬è´¦ï¼ˆæœ€å¼ºä¸€è‡´æ€§ï¼‰
BEGIN ISOLATION LEVEL SERIALIZABLE;

-- 1. é”å®šè½¬å‡ºè´¦æˆ·ï¼ˆSELECT FOR UPDATEï¼‰
SELECT balance, frozen_balance
INTO current_balance, current_frozen
FROM accounts
WHERE id = $1
FOR UPDATE;

-- 2. é”å®šè½¬å…¥è´¦æˆ·
SELECT balance
INTO to_balance
FROM accounts
WHERE id = $2
FOR UPDATE;

-- 3. æ£€æŸ¥ä½™é¢
IF current_balance - current_frozen < $3 THEN
    RAISE EXCEPTION 'Insufficient balance';
END IF;

-- 4. æ‰£å‡è½¬å‡ºè´¦æˆ·
UPDATE accounts
SET balance = balance - $3,
    updated_at = NOW()
WHERE id = $1;

-- 5. å¢åŠ è½¬å…¥è´¦æˆ·
UPDATE accounts
SET balance = balance + $3,
    updated_at = NOW()
WHERE id = $2;

-- 6. åˆ›å»ºäº¤æ˜“è®°å½•å’Œå®¡è®¡æ—¥å¿—
-- ...ï¼ˆåŒä¸Šï¼‰

COMMIT;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. æœ€å¼ºä¸€è‡´æ€§ä¿è¯
-- 2. å®Œå…¨é¿å…å¹¶å‘é—®é¢˜
--
-- ç¼ºç‚¹ï¼š
-- 1. æ€§èƒ½è¾ƒä½
-- 2. åºåˆ—åŒ–é”™è¯¯ç‡é«˜
-- 3. éœ€è¦é‡è¯•æœºåˆ¶
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 500-1000
-- P99å»¶è¿Ÿ: 50-100ms
-- åºåˆ—åŒ–é”™è¯¯ç‡: 5-10%
```

### 3.3 æ–¹æ¡ˆ3ï¼šåº”ç”¨å±‚é”

#### å®ç°ä»£ç 

```sql
-- åº”ç”¨å±‚é”å®ç°è½¬è´¦ï¼ˆæ¨èï¼‰
-- ä½¿ç”¨è´¦æˆ·IDæ’åºé¿å…æ­»é”
DO $$
DECLARE
    account1_id BIGINT;
    account2_id BIGINT;
    current_balance DECIMAL;
    current_frozen DECIMAL;
BEGIN
    -- æ’åºè´¦æˆ·IDï¼Œé¿å…æ­»é”
    IF $1 < $2 THEN
        account1_id := $1;
        account2_id := $2;
    ELSE
        account1_id := $2;
        account2_id := $1;
    END IF;

    -- æŒ‰é¡ºåºé”å®šè´¦æˆ·
    SELECT balance, frozen_balance
    INTO current_balance, current_frozen
    FROM accounts
    WHERE id = account1_id
    FOR UPDATE;

    SELECT balance
    FROM accounts
    WHERE id = account2_id
    FOR UPDATE;

    -- æ£€æŸ¥ä½™é¢ï¼ˆå¦‚æœæ˜¯è½¬å‡ºè´¦æˆ·ï¼‰
    IF account1_id = $1 AND current_balance - current_frozen < $3 THEN
        RAISE EXCEPTION 'Insufficient balance';
    END IF;

    -- æ‰§è¡Œè½¬è´¦
    UPDATE accounts SET balance = balance - $3 WHERE id = $1;
    UPDATE accounts SET balance = balance + $3 WHERE id = $2;

    -- åˆ›å»ºäº¤æ˜“è®°å½•å’Œå®¡è®¡æ—¥å¿—
    -- ...ï¼ˆåŒä¸Šï¼‰
END $$;
```

#### æ€§èƒ½åˆ†æ

```sql
-- æ€§èƒ½ç‰¹ç‚¹ï¼š
-- ä¼˜ç‚¹ï¼š
-- 1. é¿å…æ­»é”
-- 2. æ€§èƒ½è¾ƒå¥½
-- 3. å®ç°ç›¸å¯¹ç®€å•
--
-- ç¼ºç‚¹ï¼š
-- 1. éœ€è¦åº”ç”¨å±‚å¤„ç†
--
-- æ€§èƒ½æŒ‡æ ‡ï¼š
-- QPS: 2000-3000
-- P99å»¶è¿Ÿ: 20-40ms
-- æ­»é”ç‡: 0%
```

---

## ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šå¤šè¯­è¨€å®ç°

### 4.1 Pythonå®ç°

```python
def transfer_money(from_account_id, to_account_id, amount, transaction_no):
    """è½¬è´¦ï¼ˆåº”ç”¨å±‚é”æ–¹æ¡ˆï¼‰"""
    conn = connection_pool.getconn()
    try:
        cur = conn.cursor()
        conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_REPEATABLE_READ)

        # æ’åºè´¦æˆ·IDï¼Œé¿å…æ­»é”
        account_ids = sorted([from_account_id, to_account_id])

        # æŒ‰é¡ºåºé”å®šè´¦æˆ·
        cur.execute("""
            SELECT balance, frozen_balance
            FROM accounts
            WHERE id = %s FOR UPDATE
        """, (account_ids[0],))
        row1 = cur.fetchone()

        cur.execute("""
            SELECT balance
            FROM accounts
            WHERE id = %s FOR UPDATE
        """, (account_ids[1],))
        row2 = cur.fetchone()

        # æ£€æŸ¥ä½™é¢
        if account_ids[0] == from_account_id:
            if row1[0] - row1[1] < amount:
                raise ValueError("Insufficient balance")

        # æ‰§è¡Œè½¬è´¦
        cur.execute("""
            UPDATE accounts
            SET balance = balance - %s, updated_at = NOW()
            WHERE id = %s
        """, (amount, from_account_id))

        cur.execute("""
            UPDATE accounts
            SET balance = balance + %s, updated_at = NOW()
            WHERE id = %s
        """, (amount, to_account_id))

        # åˆ›å»ºäº¤æ˜“è®°å½•
        cur.execute("""
            INSERT INTO transactions (transaction_no, from_account_id, to_account_id, amount, status)
            VALUES (%s, %s, %s, %s, 'completed')
        """, (transaction_no, from_account_id, to_account_id, amount))

        conn.commit()
        return True

    except Exception as e:
        conn.rollback()
        raise
    finally:
        cur.close()
        connection_pool.putconn(conn)
```

### 4.2 Javaå®ç°

```java
@Transactional(isolation = Isolation.REPEATABLE_READ)
public boolean transferMoney(long fromAccountId, long toAccountId,
                            double amount, String transactionNo) {
    // æ’åºè´¦æˆ·IDï¼Œé¿å…æ­»é”
    long[] accountIds = {fromAccountId, toAccountId};
    Arrays.sort(accountIds);

    // æŒ‰é¡ºåºé”å®šè´¦æˆ·
    Account account1 = accountRepository.findByIdWithLock(accountIds[0]);
    Account account2 = accountRepository.findByIdWithLock(accountIds[1]);

    // æ£€æŸ¥ä½™é¢
    if (accountIds[0] == fromAccountId) {
        if (account1.getBalance() - account1.getFrozenBalance() < amount) {
            throw new InsufficientBalanceException();
        }
    }

    // æ‰§è¡Œè½¬è´¦
    account1.setBalance(account1.getBalance() - amount);
    account2.setBalance(account2.getBalance() + amount);
    accountRepository.save(account1);
    accountRepository.save(account2);

    // åˆ›å»ºäº¤æ˜“è®°å½•
    Transaction transaction = new Transaction();
    transaction.setTransactionNo(transactionNo);
    transaction.setFromAccountId(fromAccountId);
    transaction.setToAccountId(toAccountId);
    transaction.setAmount(amount);
    transaction.setStatus("completed");
    transactionRepository.save(transaction);

    return true;
}
```

### 4.3 Goå®ç°

```go
func TransferMoney(ctx context.Context, pool *pgxpool.Pool,
                   fromAccountID, toAccountID int64, amount float64, transactionNo string) error {
    tx, err := pool.Begin(ctx)
    if err != nil {
        return err
    }
    defer tx.Rollback(ctx)

    // è®¾ç½®éš”ç¦»çº§åˆ«
    _, err = tx.Exec(ctx, "SET TRANSACTION ISOLATION LEVEL REPEATABLE READ")
    if err != nil {
        return err
    }

    // æ’åºè´¦æˆ·IDï¼Œé¿å…æ­»é”
    accountIDs := []int64{fromAccountID, toAccountID}
    if accountIDs[0] > accountIDs[1] {
        accountIDs[0], accountIDs[1] = accountIDs[1], accountIDs[0]
    }

    // æŒ‰é¡ºåºé”å®šè´¦æˆ·
    var balance1, frozenBalance1 float64
    err = tx.QueryRow(ctx,
        "SELECT balance, frozen_balance FROM accounts WHERE id = $1 FOR UPDATE",
        accountIDs[0]).Scan(&balance1, &frozenBalance1)
    if err != nil {
        return err
    }

    var balance2 float64
    err = tx.QueryRow(ctx,
        "SELECT balance FROM accounts WHERE id = $1 FOR UPDATE",
        accountIDs[1]).Scan(&balance2)
    if err != nil {
        return err
    }

    // æ£€æŸ¥ä½™é¢
    if accountIDs[0] == fromAccountID && balance1-frozenBalance1 < amount {
        return fmt.Errorf("insufficient balance")
    }

    // æ‰§è¡Œè½¬è´¦
    _, err = tx.Exec(ctx,
        "UPDATE accounts SET balance = balance - $1, updated_at = NOW() WHERE id = $2",
        amount, fromAccountID)
    if err != nil {
        return err
    }

    _, err = tx.Exec(ctx,
        "UPDATE accounts SET balance = balance + $1, updated_at = NOW() WHERE id = $2",
        amount, toAccountID)
    if err != nil {
        return err
    }

    // åˆ›å»ºäº¤æ˜“è®°å½•
    _, err = tx.Exec(ctx,
        "INSERT INTO transactions (transaction_no, from_account_id, to_account_id, amount, status) "+
        "VALUES ($1, $2, $3, $4, 'completed')",
        transactionNo, fromAccountID, toAccountID, amount)
    if err != nil {
        return err
    }

    return tx.Commit(ctx)
}
```

---

## ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–

### 5.1 è¿æ¥æ± ä¼˜åŒ–

```python
# é‡‘èç³»ç»Ÿè¿æ¥æ± é…ç½®ï¼ˆé«˜å¯é æ€§ï¼‰
connection_pool = psycopg2.pool.ThreadedConnectionPool(
    minconn=10,
    maxconn=50,
    # è¿æ¥éªŒè¯
    connection_factory=psycopg2.extras.LoggingConnection,
    # è¿æ¥ä¿æŒ
    keepalives=1,
    keepalives_idle=30,
)
```

### 5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```python
# æ‰¹é‡è½¬è´¦ï¼ˆå¤šä¸ªè½¬è´¦æ“ä½œï¼‰
def batch_transfer(transfers):
    """æ‰¹é‡è½¬è´¦"""
    conn = connection_pool.getconn()
    try:
        cur = conn.cursor()
        conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_REPEATABLE_READ)

        for transfer in transfers:
            transfer_money_internal(cur, transfer)

        conn.commit()
        return True

    except Exception as e:
        conn.rollback()
        raise
    finally:
        cur.close()
        connection_pool.putconn(conn)
```

---

## ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§å’Œå‘Šè­¦

### 6.1 å…³é”®æŒ‡æ ‡ç›‘æ§

```sql
-- ç›‘æ§è½¬è´¦æˆåŠŸç‡
SELECT
    COUNT(*) FILTER (WHERE status = 'completed') * 100.0 / COUNT(*) as success_rate
FROM transactions
WHERE created_at > NOW() - interval '1 minute';

-- ç›‘æ§è´¦æˆ·ä½™é¢
SELECT
    account_no,
    balance,
    frozen_balance,
    balance - frozen_balance as available_balance
FROM accounts
WHERE balance < 0 OR frozen_balance > balance;
```

### 6.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
- alert: TransferFailure
  expr: rate(transactions_failures[5m]) > 0.01
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "High transfer failure rate"
    description: "Failure rate: {{ $value }}"

- alert: NegativeBalance
  expr: accounts_balance < 0
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "Negative balance detected"
    description: "Account {{ $labels.account_no }} has negative balance"
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ–¹æ¡ˆ

1. **æ¨èæ–¹æ¡ˆ**ï¼šåº”ç”¨å±‚é”ï¼ˆè´¦æˆ·IDæ’åºï¼‰
   - é¿å…æ­»é”
   - æ€§èƒ½è¾ƒå¥½
   - å®ç°ç›¸å¯¹ç®€å•

2. **å¤‡é€‰æ–¹æ¡ˆ**ï¼šREPEATABLE READéš”ç¦»çº§åˆ«
   - é¿å…å¹»è¯»
   - éœ€è¦å¤„ç†åºåˆ—åŒ–é”™è¯¯

3. **ä¿å®ˆæ–¹æ¡ˆ**ï¼šSERIALIZABLEéš”ç¦»çº§åˆ«
   - æœ€å¼ºä¸€è‡´æ€§
   - æ€§èƒ½è¾ƒä½

### æœ€ä½³å®è·µ

1. **æ•°æ®åº“è®¾è®¡**ï¼šåˆç†è®¾è®¡è¡¨ç»“æ„å’Œç´¢å¼•
2. **äº‹åŠ¡è®¾è®¡**ï¼šä½¿ç”¨REPEATABLE READæˆ–åº”ç”¨å±‚é”
3. **æ­»é”é¿å…**ï¼šè´¦æˆ·IDæ’åºé”å®š
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´è®°å½•æ‰€æœ‰æ“ä½œ
5. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘Šè­¦

### æ€§èƒ½æŒ‡æ ‡

- **QPS**: 2000-3000ï¼ˆå•å®ä¾‹ï¼‰
- **P99å»¶è¿Ÿ**: 20-40ms
- **æˆåŠŸç‡**: >99.99%
- **æ­»é”ç‡**: 0%

PostgreSQL 17/18çš„MVCCæœºåˆ¶åœ¨é‡‘èè½¬è´¦åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œé€šè¿‡åˆç†çš„æ•°æ®åº“è®¾è®¡å’Œäº‹åŠ¡å®ç°ï¼Œå¯ä»¥å®ç°é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„é‡‘èç³»ç»Ÿã€‚
