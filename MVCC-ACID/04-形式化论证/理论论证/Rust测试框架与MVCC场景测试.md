# Rustæµ‹è¯•æ¡†æ¶ä¸MVCCåœºæ™¯æµ‹è¯•

> **æ–‡æ¡£ç¼–å·**: RUST-PRACTICE-TESTING-001
> **ä¸»é¢˜**: Rustæµ‹è¯•æ¡†æ¶ä¸PostgreSQL MVCCåœºæ™¯æµ‹è¯•
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **ç›¸å…³æ–‡æ¡£**:
>
> - [Rusté©±åŠ¨PostgreSQLå®è·µ](Rusté©±åŠ¨PostgreSQLå®è·µ.md)
> - [Rusté”™è¯¯å¤„ç†ä¸äº‹åŠ¡å›æ»š](Rusté”™è¯¯å¤„ç†ä¸äº‹åŠ¡å›æ»š.md)
> - [å¯è§æ€§æµ‹è¯•](../../05-éªŒè¯å·¥å…·/æµ‹è¯•ç”¨ä¾‹/å¯è§æ€§æµ‹è¯•.sql)

---

## ğŸ“‘ ç›®å½•

- [Rustæµ‹è¯•æ¡†æ¶ä¸MVCCåœºæ™¯æµ‹è¯•](#rustæµ‹è¯•æ¡†æ¶ä¸mvccåœºæ™¯æµ‹è¯•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ§ª ç¬¬ä¸€éƒ¨åˆ†ï¼šRustæµ‹è¯•æ¡†æ¶](#-ç¬¬ä¸€éƒ¨åˆ†rustæµ‹è¯•æ¡†æ¶)
    - [1.1 å•å…ƒæµ‹è¯•](#11-å•å…ƒæµ‹è¯•)
    - [1.1.1 å•å…ƒæµ‹è¯•ç¤ºä¾‹](#111-å•å…ƒæµ‹è¯•ç¤ºä¾‹)
    - [1.2 é›†æˆæµ‹è¯•](#12-é›†æˆæµ‹è¯•)
    - [1.2.1 é›†æˆæµ‹è¯•ç¤ºä¾‹](#121-é›†æˆæµ‹è¯•ç¤ºä¾‹)
    - [1.3 å¼‚æ­¥æµ‹è¯•](#13-å¼‚æ­¥æµ‹è¯•)
    - [1.3.1 å¼‚æ­¥æµ‹è¯•ç¤ºä¾‹](#131-å¼‚æ­¥æµ‹è¯•ç¤ºä¾‹)
  - [ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCåœºæ™¯æµ‹è¯•](#-ç¬¬äºŒéƒ¨åˆ†mvccåœºæ™¯æµ‹è¯•)
    - [2.1 å¯è§æ€§æµ‹è¯•](#21-å¯è§æ€§æµ‹è¯•)
    - [2.1.1 éš”ç¦»çº§åˆ«æµ‹è¯•](#211-éš”ç¦»çº§åˆ«æµ‹è¯•)
    - [2.2 å¹¶å‘æµ‹è¯•](#22-å¹¶å‘æµ‹è¯•)
    - [2.2.1 å¹¶å‘åœºæ™¯æµ‹è¯•](#221-å¹¶å‘åœºæ™¯æµ‹è¯•)
    - [2.3 äº‹åŠ¡æµ‹è¯•](#23-äº‹åŠ¡æµ‹è¯•)
    - [2.3.1 äº‹åŠ¡å›æ»šæµ‹è¯•](#231-äº‹åŠ¡å›æ»šæµ‹è¯•)
  - [âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæµ‹è¯•å·¥å…·](#-ç¬¬ä¸‰éƒ¨åˆ†æµ‹è¯•å·¥å…·)
    - [3.1 æµ‹è¯•æ•°æ®åº“ç®¡ç†](#31-æµ‹è¯•æ•°æ®åº“ç®¡ç†)
    - [3.1.1 æµ‹è¯•æ•°æ®åº“è®¾ç½®](#311-æµ‹è¯•æ•°æ®åº“è®¾ç½®)
    - [3.2 æµ‹è¯•æ•°æ®å‡†å¤‡](#32-æµ‹è¯•æ•°æ®å‡†å¤‡)
    - [3.2.1 æµ‹è¯•æ•°æ®ç”Ÿæˆ](#321-æµ‹è¯•æ•°æ®ç”Ÿæˆ)
  - [ğŸš€ ç¬¬å››éƒ¨åˆ†ï¼šMVCCæµ‹è¯•æœ€ä½³å®è·µ](#-ç¬¬å››éƒ¨åˆ†mvccæµ‹è¯•æœ€ä½³å®è·µ)
    - [4.1 æµ‹è¯•éš”ç¦»](#41-æµ‹è¯•éš”ç¦»)
    - [4.1.1 æµ‹è¯•éš”ç¦»ç­–ç•¥](#411-æµ‹è¯•éš”ç¦»ç­–ç•¥)
    - [4.2 æµ‹è¯•æ€§èƒ½](#42-æµ‹è¯•æ€§èƒ½)
    - [4.2.1 æ€§èƒ½æµ‹è¯•](#421-æ€§èƒ½æµ‹è¯•)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•ä½¿ç”¨Rustæµ‹è¯•æ¡†æ¶è¿›è¡ŒPostgreSQL MVCCåœºæ™¯æµ‹è¯•ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€MVCCåœºæ™¯æµ‹è¯•å’Œæµ‹è¯•æœ€ä½³å®è·µã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š

- Rustæµ‹è¯•æ¡†æ¶ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€å¼‚æ­¥æµ‹è¯•ï¼‰
- MVCCåœºæ™¯æµ‹è¯•ï¼ˆå¯è§æ€§ã€å¹¶å‘ã€äº‹åŠ¡ï¼‰
- æµ‹è¯•å·¥å…·ï¼ˆæµ‹è¯•æ•°æ®åº“ç®¡ç†ã€æµ‹è¯•æ•°æ®å‡†å¤‡ï¼‰
- MVCCæµ‹è¯•æœ€ä½³å®è·µï¼ˆæµ‹è¯•éš”ç¦»ã€æ€§èƒ½æµ‹è¯•ï¼‰

**ç›®æ ‡è¯»è€…**ï¼š

- Rustå¼€å‘è€…
- æµ‹è¯•å·¥ç¨‹å¸ˆ
- æ•°æ®åº“å¼€å‘è€…

---

## ğŸ§ª ç¬¬ä¸€éƒ¨åˆ†ï¼šRustæµ‹è¯•æ¡†æ¶

### 1.1 å•å…ƒæµ‹è¯•

#### 1.1.1 å•å…ƒæµ‹è¯•ç¤ºä¾‹

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_user_creation() {
        let user = User {
            id: 1,
            name: "Alice".to_string(),
            balance: 1000,
        };

        assert_eq!(user.id, 1);
        assert_eq!(user.name, "Alice");
    }
}
```

### 1.2 é›†æˆæµ‹è¯•

#### 1.2.1 é›†æˆæµ‹è¯•ç¤ºä¾‹

```rust
#[cfg(test)]
mod integration_tests {
    use sqlx::PgPool;

    #[tokio::test]
    async fn test_database_connection() {
        let pool = create_test_pool().await;
        let user = sqlx::query("SELECT * FROM users WHERE id = $1")
            .bind(1i32)
            .fetch_one(&pool)
            .await
            .unwrap();

        assert_eq!(user.get::<i32, _>("id"), 1);
    }
}
```

### 1.3 å¼‚æ­¥æµ‹è¯•

#### 1.3.1 å¼‚æ­¥æµ‹è¯•ç¤ºä¾‹

```rust
#[tokio::test]
async fn test_async_query() {
    let pool = create_test_pool().await;
    let user = sqlx::query("SELECT * FROM users WHERE id = $1")
        .bind(1i32)
        .fetch_one(&pool)
        .await
        .unwrap();

    assert_eq!(user.get::<i32, _>("id"), 1);
}
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šMVCCåœºæ™¯æµ‹è¯•

### 2.1 å¯è§æ€§æµ‹è¯•

#### 2.1.1 éš”ç¦»çº§åˆ«æµ‹è¯•

```rust
#[tokio::test]
async fn test_read_committed() {
    let pool = create_test_pool().await;

    // äº‹åŠ¡1ï¼šæ’å…¥æ•°æ®
    let mut tx1 = pool.begin().await.unwrap();
    sqlx::query("INSERT INTO users (id, name) VALUES ($1, $2)")
        .bind(1i32)
        .bind("Alice")
        .execute(&mut *tx1)
        .await
        .unwrap();

    // äº‹åŠ¡2ï¼šREAD COMMITTEDï¼Œåº”è¯¥çœ‹ä¸åˆ°æœªæäº¤çš„æ•°æ®
    let user = sqlx::query("SELECT * FROM users WHERE id = $1")
        .bind(1i32)
        .fetch_optional(&pool)
        .await
        .unwrap();

    assert!(user.is_none());  // READ COMMITTEDçœ‹ä¸åˆ°æœªæäº¤æ•°æ®

    tx1.commit().await.unwrap();
}
```

### 2.2 å¹¶å‘æµ‹è¯•

#### 2.2.1 å¹¶å‘åœºæ™¯æµ‹è¯•

```rust
#[tokio::test]
async fn test_concurrent_updates() {
    let pool = create_test_pool().await;

    // åˆå§‹åŒ–æ•°æ®
    sqlx::query("INSERT INTO accounts (id, balance) VALUES ($1, $2)")
        .bind(1i32)
        .bind(1000i64)
        .execute(&pool)
        .await
        .unwrap();

    // å¹¶å‘æ›´æ–°
    let handles: Vec<_> = (0..10)
        .map(|_| {
            let pool = pool.clone();
            tokio::spawn(async move {
                let mut tx = pool.begin().await.unwrap();
                sqlx::query("UPDATE accounts SET balance = balance - 10 WHERE id = $1")
                    .bind(1i32)
                    .execute(&mut *tx)
                    .await
                    .unwrap();
                tx.commit().await.unwrap();
            })
        })
        .collect();

    for handle in handles {
        handle.await.unwrap();
    }

    // éªŒè¯æœ€ç»ˆä½™é¢
    let balance: i64 = sqlx::query_scalar("SELECT balance FROM accounts WHERE id = $1")
        .bind(1i32)
        .fetch_one(&pool)
        .await
        .unwrap();

    assert_eq!(balance, 900);  // 1000 - 10*10
}
```

---

## âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæµ‹è¯•å·¥å…·

### 3.1 æµ‹è¯•æ•°æ®åº“ç®¡ç†

#### 3.1.1 æµ‹è¯•æ•°æ®åº“è®¾ç½®

```rust
async fn create_test_pool() -> PgPool {
    let database_url = std::env::var("TEST_DATABASE_URL")
        .unwrap_or_else(|_| "postgres://postgres@localhost/test".to_string());

    PgPool::connect(&database_url).await.unwrap()
}
```

---

## ğŸš€ ç¬¬å››éƒ¨åˆ†ï¼šMVCCæµ‹è¯•æœ€ä½³å®è·µ

### 4.1 æµ‹è¯•éš”ç¦»

#### 4.1.1 æµ‹è¯•éš”ç¦»ç­–ç•¥

```rust
// æµ‹è¯•éš”ç¦»ç­–ç•¥ï¼š
// 1. æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“
// 2. æµ‹è¯•åæ¸…ç†æ•°æ®
// 3. ä½¿ç”¨äº‹åŠ¡å›æ»š
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨Rustæµ‹è¯•æ¡†æ¶è¿›è¡ŒPostgreSQL MVCCåœºæ™¯æµ‹è¯•ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. **Rustæµ‹è¯•æ¡†æ¶**ï¼š
   - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€å¼‚æ­¥æµ‹è¯•

2. **MVCCåœºæ™¯æµ‹è¯•**ï¼š
   - å¯è§æ€§æµ‹è¯•ã€å¹¶å‘æµ‹è¯•ã€äº‹åŠ¡æµ‹è¯•

3. **æµ‹è¯•å·¥å…·**ï¼š
   - æµ‹è¯•æ•°æ®åº“ç®¡ç†ã€æµ‹è¯•æ•°æ®å‡†å¤‡

4. **æµ‹è¯•æœ€ä½³å®è·µ**ï¼š
   - æµ‹è¯•éš”ç¦»ã€æ€§èƒ½æµ‹è¯•

**ä¸‹ä¸€æ­¥**ï¼š

- å®Œå–„æµ‹è¯•æ¡ˆä¾‹
- æ·»åŠ æ›´å¤šæµ‹è¯•åœºæ™¯
- å®Œå–„æµ‹è¯•å·¥å…·æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
