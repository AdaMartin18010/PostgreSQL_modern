# æ€§èƒ½åˆ†æå·¥å…·å¯¹æ¯”

> **æ–‡æ¡£ç¼–å·**: OPS-PERFORMANCE-TOOLS-001
> **ä¸»é¢˜**: Rustä¸PostgreSQLæ€§èƒ½åˆ†æå·¥å…·å¯¹æ¯”
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18
> **ç›¸å…³æ–‡æ¡£**:
>
> - [Ruståº”ç”¨æ€§èƒ½æ•…éšœå¤„ç†](Ruståº”ç”¨æ€§èƒ½æ•…éšœå¤„ç†.md)
> - [Ruståº”ç”¨æ•…éšœè¯Šæ–­](Ruståº”ç”¨æ•…éšœè¯Šæ–­.md)
> - [Rustæ€§èƒ½ä¼˜åŒ–æŠ€å·§](../../04-å½¢å¼åŒ–è®ºè¯/æ€§èƒ½æ¨¡å‹/Rustæ€§èƒ½ä¼˜åŒ–æŠ€å·§.md)

---

## ğŸ“‘ ç›®å½•

- [æ€§èƒ½åˆ†æå·¥å…·å¯¹æ¯”](#æ€§èƒ½åˆ†æå·¥å…·å¯¹æ¯”)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šRustæ€§èƒ½åˆ†æå·¥å…·](#-ç¬¬ä¸€éƒ¨åˆ†rustæ€§èƒ½åˆ†æå·¥å…·)
    - [1.1 perfå·¥å…·](#11-perfå·¥å…·)
      - [1.1.1 perfä½¿ç”¨](#111-perfä½¿ç”¨)
    - [1.2 flamegraphå·¥å…·](#12-flamegraphå·¥å…·)
      - [1.2.1 flamegraphç”Ÿæˆ](#121-flamegraphç”Ÿæˆ)
    - [1.3 cargo-flamegraph](#13-cargo-flamegraph)
      - [1.3.1 cargo-flamegraphä½¿ç”¨](#131-cargo-flamegraphä½¿ç”¨)
  - [ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šPostgreSQLæ€§èƒ½åˆ†æå·¥å…·](#-ç¬¬äºŒéƒ¨åˆ†postgresqlæ€§èƒ½åˆ†æå·¥å…·)
    - [2.1 pg\_stat\_statements](#21-pg_stat_statements)
      - [2.1.1 pg\_stat\_statementsé…ç½®](#211-pg_stat_statementsé…ç½®)
    - [2.2 pg\_stat\_activity](#22-pg_stat_activity)
      - [2.2.1 æ´»åŠ¨è¿æ¥ç›‘æ§](#221-æ´»åŠ¨è¿æ¥ç›‘æ§)
    - [2.3 EXPLAIN ANALYZE](#23-explain-analyze)
      - [2.3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ](#231-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
  - [âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥å…·å¯¹æ¯”åˆ†æ](#-ç¬¬ä¸‰éƒ¨åˆ†å·¥å…·å¯¹æ¯”åˆ†æ)
    - [3.1 åŠŸèƒ½å¯¹æ¯”](#31-åŠŸèƒ½å¯¹æ¯”)
    - [3.2 ä½¿ç”¨åœºæ™¯å¯¹æ¯”](#32-ä½¿ç”¨åœºæ™¯å¯¹æ¯”)
      - [3.2.1 åœºæ™¯é€‰æ‹©](#321-åœºæ™¯é€‰æ‹©)
  - [ğŸš€ ç¬¬å››éƒ¨åˆ†ï¼šé›†æˆä½¿ç”¨æ–¹æ¡ˆ](#-ç¬¬å››éƒ¨åˆ†é›†æˆä½¿ç”¨æ–¹æ¡ˆ)
    - [4.1 ç«¯åˆ°ç«¯æ€§èƒ½åˆ†æ](#41-ç«¯åˆ°ç«¯æ€§èƒ½åˆ†æ)
      - [4.1.1 é›†æˆåˆ†ææµç¨‹](#411-é›†æˆåˆ†ææµç¨‹)
    - [4.2 æ€§èƒ½ç“¶é¢ˆå®šä½](#42-æ€§èƒ½ç“¶é¢ˆå®šä½)
      - [4.2.1 ç“¶é¢ˆå®šä½æµç¨‹](#421-ç“¶é¢ˆå®šä½æµç¨‹)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”Rustæ€§èƒ½åˆ†æå·¥å…·å’ŒPostgreSQLæ€§èƒ½åˆ†æå·¥å…·ï¼Œæä¾›å·¥å…·é€‰æ‹©æŒ‡å—å’Œé›†æˆä½¿ç”¨æ–¹æ¡ˆã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š

- Rustæ€§èƒ½åˆ†æå·¥å…·ï¼ˆperfã€flamegraphã€cargo-flamegraphï¼‰
- PostgreSQLæ€§èƒ½åˆ†æå·¥å…·ï¼ˆpg_stat_statementsã€pg_stat_activityã€EXPLAIN ANALYZEï¼‰
- å·¥å…·å¯¹æ¯”åˆ†æï¼ˆåŠŸèƒ½ã€ä½¿ç”¨åœºæ™¯ã€æ€§èƒ½å¼€é”€ï¼‰
- é›†æˆä½¿ç”¨æ–¹æ¡ˆï¼ˆç«¯åˆ°ç«¯åˆ†æã€ç“¶é¢ˆå®šä½ã€ä¼˜åŒ–æµç¨‹ï¼‰

**ç›®æ ‡è¯»è€…**ï¼š

- æ€§èƒ½ä¼˜åŒ–å·¥ç¨‹å¸ˆ
- è¿ç»´å·¥ç¨‹å¸ˆ
- Rustå¼€å‘è€…
- PostgreSQL DBA

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šRustæ€§èƒ½åˆ†æå·¥å…·

### 1.1 perfå·¥å…·

#### 1.1.1 perfä½¿ç”¨

```bash
# ä½¿ç”¨perfåˆ†æRuståº”ç”¨æ€§èƒ½
perf record -g ./target/release/my_app
perf report

# åˆ†æç‰¹å®šå‡½æ•°
perf record -g -F 99 --call-graph dwarf ./target/release/my_app
```

### 1.2 flamegraphå·¥å…·

#### 1.2.1 flamegraphç”Ÿæˆ

```bash
# ç”Ÿæˆç«ç„°å›¾
perf record -g ./target/release/my_app
perf script | stackcollapse-perf.pl | flamegraph.pl > flamegraph.svg
```

### 1.3 cargo-flamegraph

#### 1.3.1 cargo-flamegraphä½¿ç”¨

```bash
# å®‰è£…cargo-flamegraph
cargo install flamegraph

# ç”Ÿæˆç«ç„°å›¾
cargo flamegraph --bin my_app
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†ï¼šPostgreSQLæ€§èƒ½åˆ†æå·¥å…·

### 2.1 pg_stat_statements

#### 2.1.1 pg_stat_statementsé…ç½®

```sql
-- å¯ç”¨pg_stat_statements
CREATE EXTENSION pg_stat_statements;

-- æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### 2.2 pg_stat_activity

#### 2.2.1 æ´»åŠ¨è¿æ¥ç›‘æ§

```sql
-- ç›‘æ§æ´»åŠ¨è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    state_change,
    query
FROM pg_stat_activity
WHERE state = 'active';
```

### 2.3 EXPLAIN ANALYZE

#### 2.3.1 æŸ¥è¯¢è®¡åˆ’åˆ†æ

```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM users WHERE id = 1;

-- è¯¦ç»†åˆ†æ
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM users WHERE id = 1;
```

---

## âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥å…·å¯¹æ¯”åˆ†æ

### 3.1 åŠŸèƒ½å¯¹æ¯”

| å·¥å…· | åŠŸèƒ½ | Ruståº”ç”¨ | PostgreSQL | MVCCåˆ†æ |
|------|------|---------|-----------|---------|
| **perf** | CPUæ€§èƒ½åˆ†æ | âœ… | âŒ | âŒ |
| **flamegraph** | å¯è§†åŒ–æ€§èƒ½åˆ†æ | âœ… | âŒ | âŒ |
| **pg_stat_statements** | SQLæŸ¥è¯¢ç»Ÿè®¡ | âŒ | âœ… | âœ… |
| **pg_stat_activity** | æ´»åŠ¨è¿æ¥ç›‘æ§ | âŒ | âœ… | âœ… |
| **EXPLAIN ANALYZE** | æŸ¥è¯¢è®¡åˆ’åˆ†æ | âŒ | âœ… | âœ… |

### 3.2 ä½¿ç”¨åœºæ™¯å¯¹æ¯”

#### 3.2.1 åœºæ™¯é€‰æ‹©

```rust
// Ruståº”ç”¨æ€§èƒ½åˆ†æï¼š
// 1. CPUæ€§èƒ½ç“¶é¢ˆï¼šä½¿ç”¨perf + flamegraph
// 2. å†…å­˜æ€§èƒ½ç“¶é¢ˆï¼šä½¿ç”¨valgrindæˆ–AddressSanitizer
// 3. å¹¶å‘æ€§èƒ½ç“¶é¢ˆï¼šä½¿ç”¨ThreadSanitizer

// PostgreSQLæ€§èƒ½åˆ†æï¼š
// 1. SQLæŸ¥è¯¢æ€§èƒ½ï¼šä½¿ç”¨pg_stat_statements
// 2. è¿æ¥æ€§èƒ½ï¼šä½¿ç”¨pg_stat_activity
// 3. æŸ¥è¯¢è®¡åˆ’ï¼šä½¿ç”¨EXPLAIN ANALYZE
```

---

## ğŸš€ ç¬¬å››éƒ¨åˆ†ï¼šé›†æˆä½¿ç”¨æ–¹æ¡ˆ

### 4.1 ç«¯åˆ°ç«¯æ€§èƒ½åˆ†æ

#### 4.1.1 é›†æˆåˆ†ææµç¨‹

```rust
// 1. Ruståº”ç”¨å±‚ï¼šä½¿ç”¨perf/flamegraphåˆ†æåº”ç”¨æ€§èƒ½
// 2. PostgreSQLå±‚ï¼šä½¿ç”¨pg_stat_statementsåˆ†æSQLæ€§èƒ½
// 3. MVCCå±‚ï¼šä½¿ç”¨pg_stat_activityåˆ†æäº‹åŠ¡æ€§èƒ½
// 4. å…³è”åˆ†æï¼šå…³è”Ruståº”ç”¨å’ŒPostgreSQLæ€§èƒ½æ•°æ®
```

### 4.2 æ€§èƒ½ç“¶é¢ˆå®šä½

#### 4.2.1 ç“¶é¢ˆå®šä½æµç¨‹

```rust
// æ€§èƒ½ç“¶é¢ˆå®šä½æµç¨‹ï¼š
// 1. ä½¿ç”¨pg_stat_statementsè¯†åˆ«æ…¢æŸ¥è¯¢
// 2. ä½¿ç”¨EXPLAIN ANALYZEåˆ†ææŸ¥è¯¢è®¡åˆ’
// 3. ä½¿ç”¨perfåˆ†æRuståº”ç”¨CPUä½¿ç”¨
// 4. ä½¿ç”¨flamegraphå¯è§†åŒ–æ€§èƒ½çƒ­ç‚¹
// 5. å…³è”åˆ†æå®šä½ç“¶é¢ˆ
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£å¯¹æ¯”äº†Rustæ€§èƒ½åˆ†æå·¥å…·å’ŒPostgreSQLæ€§èƒ½åˆ†æå·¥å…·ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. **Rustå·¥å…·**ï¼š
   - perfã€flamegraphã€cargo-flamegraph
   - CPUæ€§èƒ½åˆ†æã€å¯è§†åŒ–åˆ†æ

2. **PostgreSQLå·¥å…·**ï¼š
   - pg_stat_statementsã€pg_stat_activityã€EXPLAIN ANALYZE
   - SQLæŸ¥è¯¢ç»Ÿè®¡ã€è¿æ¥ç›‘æ§ã€æŸ¥è¯¢è®¡åˆ’åˆ†æ

3. **å·¥å…·å¯¹æ¯”**ï¼š
   - åŠŸèƒ½å¯¹æ¯”ã€ä½¿ç”¨åœºæ™¯å¯¹æ¯”ã€æ€§èƒ½å¼€é”€å¯¹æ¯”

4. **é›†æˆæ–¹æ¡ˆ**ï¼š
   - ç«¯åˆ°ç«¯æ€§èƒ½åˆ†æã€ç“¶é¢ˆå®šä½ã€ä¼˜åŒ–æµç¨‹

**ä¸‹ä¸€æ­¥**ï¼š

- å®Œå–„å·¥å…·ä½¿ç”¨æ¡ˆä¾‹
- æ·»åŠ æ›´å¤šå·¥å…·å¯¹æ¯”
- å®Œå–„é›†æˆæ–¹æ¡ˆæ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç»´æŠ¤çŠ¶æ€**: âœ… æŒç»­æ›´æ–°
