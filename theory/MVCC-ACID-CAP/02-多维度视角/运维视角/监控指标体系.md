# PostgreSQL MVCC-ACIDç›‘æ§æŒ‡æ ‡ä½“ç³»

> **æ–‡æ¡£ç¼–å·**: OPS-MONITOR-001
> **ä¸»é¢˜**: ç›‘æ§æŒ‡æ ‡ä½“ç³»
> **ç‰ˆæœ¬**: PostgreSQL 17 & 18

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL MVCC-ACIDç›‘æ§æŒ‡æ ‡ä½“ç³»](#postgresql-mvcc-acidç›‘æ§æŒ‡æ ‡ä½“ç³»)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹åŠ¡ç›‘æ§æŒ‡æ ‡](#-ç¬¬ä¸€éƒ¨åˆ†äº‹åŠ¡ç›‘æ§æŒ‡æ ‡)
    - [1.1 æ´»åŠ¨äº‹åŠ¡ç›‘æ§](#11-æ´»åŠ¨äº‹åŠ¡ç›‘æ§)
      - [æ´»åŠ¨äº‹åŠ¡æ•°é‡](#æ´»åŠ¨äº‹åŠ¡æ•°é‡)
      - [é•¿äº‹åŠ¡æ£€æµ‹](#é•¿äº‹åŠ¡æ£€æµ‹)
      - [äº‹åŠ¡æŒç»­æ—¶é—´](#äº‹åŠ¡æŒç»­æ—¶é—´)
    - [1.2 äº‹åŠ¡çŠ¶æ€ç›‘æ§](#12-äº‹åŠ¡çŠ¶æ€ç›‘æ§)
      - [äº‹åŠ¡çŠ¶æ€åˆ†å¸ƒ](#äº‹åŠ¡çŠ¶æ€åˆ†å¸ƒ)
      - [ç­‰å¾…äº‹åŠ¡ç›‘æ§](#ç­‰å¾…äº‹åŠ¡ç›‘æ§)
      - [é˜»å¡äº‹åŠ¡ç›‘æ§](#é˜»å¡äº‹åŠ¡ç›‘æ§)
    - [1.3 éš”ç¦»çº§åˆ«ç›‘æ§](#13-éš”ç¦»çº§åˆ«ç›‘æ§)
      - [éš”ç¦»çº§åˆ«åˆ†å¸ƒ](#éš”ç¦»çº§åˆ«åˆ†å¸ƒ)
      - [åºåˆ—åŒ–é”™è¯¯ç›‘æ§](#åºåˆ—åŒ–é”™è¯¯ç›‘æ§)
      - [æ­»é”ç›‘æ§](#æ­»é”ç›‘æ§)
  - [ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šé”ç›‘æ§æŒ‡æ ‡](#-ç¬¬äºŒéƒ¨åˆ†é”ç›‘æ§æŒ‡æ ‡)
    - [2.1 é”ç­‰å¾…ç›‘æ§](#21-é”ç­‰å¾…ç›‘æ§)
      - [é”ç­‰å¾…æ•°é‡](#é”ç­‰å¾…æ•°é‡)
      - [é”ç­‰å¾…æ—¶é—´](#é”ç­‰å¾…æ—¶é—´)
      - [é”ç­‰å¾…ç±»å‹åˆ†å¸ƒ](#é”ç­‰å¾…ç±»å‹åˆ†å¸ƒ)
    - [2.2 é”æŒæœ‰ç›‘æ§](#22-é”æŒæœ‰ç›‘æ§)
      - [é”æŒæœ‰æ•°é‡](#é”æŒæœ‰æ•°é‡)
      - [é”æŒæœ‰æ—¶é—´](#é”æŒæœ‰æ—¶é—´)
      - [é”å†²çªæ£€æµ‹](#é”å†²çªæ£€æµ‹)
    - [2.3 æ­»é”ç›‘æ§](#23-æ­»é”ç›‘æ§)
      - [æ­»é”æ£€æµ‹](#æ­»é”æ£€æµ‹)
      - [æ­»é”é¢‘ç‡](#æ­»é”é¢‘ç‡)
      - [æ­»é”åˆ†æ](#æ­»é”åˆ†æ)
  - [ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¡¨è†¨èƒ€ç›‘æ§](#-ç¬¬ä¸‰éƒ¨åˆ†è¡¨è†¨èƒ€ç›‘æ§)
    - [3.1 æ­»äº¡å…ƒç»„ç›‘æ§](#31-æ­»äº¡å…ƒç»„ç›‘æ§)
      - [æ­»äº¡å…ƒç»„æ•°é‡](#æ­»äº¡å…ƒç»„æ•°é‡)
      - [æ­»äº¡å…ƒç»„æ¯”ä¾‹](#æ­»äº¡å…ƒç»„æ¯”ä¾‹)
      - [æ­»äº¡å…ƒç»„å¢é•¿è¶‹åŠ¿](#æ­»äº¡å…ƒç»„å¢é•¿è¶‹åŠ¿)
    - [3.2 è¡¨å¤§å°ç›‘æ§](#32-è¡¨å¤§å°ç›‘æ§)
      - [è¡¨å¤§å°](#è¡¨å¤§å°)
      - [è¡¨è†¨èƒ€ç‡](#è¡¨è†¨èƒ€ç‡)
      - [è¡¨å¤§å°å¢é•¿è¶‹åŠ¿](#è¡¨å¤§å°å¢é•¿è¶‹åŠ¿)
    - [3.3 VACUUMç›‘æ§](#33-vacuumç›‘æ§)
      - [VACUUMæ‰§è¡Œé¢‘ç‡](#vacuumæ‰§è¡Œé¢‘ç‡)
      - [VACUUMæ‰§è¡Œæ—¶é—´](#vacuumæ‰§è¡Œæ—¶é—´)
      - [VACUUMæ•ˆæœ](#vacuumæ•ˆæœ)
  - [ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šXIDå¹´é¾„ç›‘æ§](#-ç¬¬å››éƒ¨åˆ†xidå¹´é¾„ç›‘æ§)
    - [4.1 XIDå¹´é¾„ç›‘æ§](#41-xidå¹´é¾„ç›‘æ§)
      - [æ•°æ®åº“XIDå¹´é¾„](#æ•°æ®åº“xidå¹´é¾„)
      - [è¡¨XIDå¹´é¾„](#è¡¨xidå¹´é¾„)
      - [XIDå¹´é¾„è¶‹åŠ¿](#xidå¹´é¾„è¶‹åŠ¿)
    - [4.2 XIDå›å·é£é™©ç›‘æ§](#42-xidå›å·é£é™©ç›‘æ§)
      - [å›å·é£é™©è¯„ä¼°](#å›å·é£é™©è¯„ä¼°)
      - [FREEZEæ“ä½œç›‘æ§](#freezeæ“ä½œç›‘æ§)
      - [é¢„é˜²æªæ–½ç›‘æ§](#é¢„é˜²æªæ–½ç›‘æ§)
  - [ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ç›‘æ§æŒ‡æ ‡](#-ç¬¬äº”éƒ¨åˆ†æ€§èƒ½ç›‘æ§æŒ‡æ ‡)
    - [5.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#51-æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
      - [æ…¢æŸ¥è¯¢ç›‘æ§](#æ…¢æŸ¥è¯¢ç›‘æ§)
      - [æŸ¥è¯¢æ‰§è¡Œæ—¶é—´](#æŸ¥è¯¢æ‰§è¡Œæ—¶é—´)
      - [æŸ¥è¯¢é¢‘ç‡](#æŸ¥è¯¢é¢‘ç‡)
    - [5.2 è¿æ¥ç›‘æ§](#52-è¿æ¥ç›‘æ§)
      - [è¿æ¥æ•°é‡](#è¿æ¥æ•°é‡)
      - [è¿æ¥ä½¿ç”¨ç‡](#è¿æ¥ä½¿ç”¨ç‡)
      - [è¿æ¥ç­‰å¾…](#è¿æ¥ç­‰å¾…)
    - [5.3 å¤åˆ¶ç›‘æ§](#53-å¤åˆ¶ç›‘æ§)
      - [å¤åˆ¶å»¶è¿Ÿ](#å¤åˆ¶å»¶è¿Ÿ)
      - [å¤åˆ¶æ§½ç›‘æ§](#å¤åˆ¶æ§½ç›‘æ§)
      - [WALç›‘æ§](#walç›‘æ§)
  - [ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§SQLæŸ¥è¯¢](#-ç¬¬å…­éƒ¨åˆ†ç›‘æ§sqlæŸ¥è¯¢)
    - [6.1 äº‹åŠ¡ç›‘æ§æŸ¥è¯¢](#61-äº‹åŠ¡ç›‘æ§æŸ¥è¯¢)
    - [6.2 é”ç›‘æ§æŸ¥è¯¢](#62-é”ç›‘æ§æŸ¥è¯¢)
    - [6.3 è¡¨è†¨èƒ€ç›‘æ§æŸ¥è¯¢](#63-è¡¨è†¨èƒ€ç›‘æ§æŸ¥è¯¢)
    - [6.4 XIDå¹´é¾„ç›‘æ§æŸ¥è¯¢](#64-xidå¹´é¾„ç›‘æ§æŸ¥è¯¢)
  - [ğŸ“ æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒç›‘æ§æŒ‡æ ‡](#æ ¸å¿ƒç›‘æ§æŒ‡æ ‡)
    - [å‘Šè­¦é˜ˆå€¼å»ºè®®](#å‘Šè­¦é˜ˆå€¼å»ºè®®)
    - [ç›‘æ§æœ€ä½³å®è·µ](#ç›‘æ§æœ€ä½³å®è·µ)

---

## ğŸ“‹ æ¦‚è¿°

PostgreSQL MVCC-ACIDç›‘æ§æŒ‡æ ‡ä½“ç³»æ˜¯è¿ç»´å·¥ä½œçš„æ ¸å¿ƒï¼Œé€šè¿‡å…¨é¢ç›‘æ§äº‹åŠ¡ã€é”ã€è¡¨è†¨èƒ€ã€XIDå¹´é¾„ç­‰å…³é”®æŒ‡æ ‡ï¼Œå¯ä»¥åŠæ—¶å‘ç°å’Œé¢„é˜²é—®é¢˜ï¼Œç¡®ä¿æ•°æ®åº“ç¨³å®šè¿è¡Œã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æ‰€æœ‰å…³é”®ç›‘æ§æŒ‡æ ‡åŠå…¶ç›‘æ§æ–¹æ³•ã€‚

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹åŠ¡ç›‘æ§æŒ‡æ ‡

### 1.1 æ´»åŠ¨äº‹åŠ¡ç›‘æ§

#### æ´»åŠ¨äº‹åŠ¡æ•°é‡

```sql
-- ç›‘æ§æ´»åŠ¨äº‹åŠ¡æ•°é‡
SELECT
    count(*) as active_transactions,
    count(*) FILTER (WHERE state = 'active') as active_state,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    count(*) FILTER (WHERE state = 'idle in transaction (aborted)') as idle_aborted
FROM pg_stat_activity
WHERE datname = current_database();

-- å‘Šè­¦é˜ˆå€¼ï¼šæ´»åŠ¨äº‹åŠ¡ > 100
```

#### é•¿äº‹åŠ¡æ£€æµ‹

```sql
-- æ£€æµ‹é•¿äº‹åŠ¡ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
SELECT
    pid,
    usename,
    datname,
    state,
    now() - xact_start as transaction_duration,
    now() - query_start as query_duration,
    query
FROM pg_stat_activity
WHERE datname = current_database()
  AND state IN ('active', 'idle in transaction')
  AND now() - xact_start > interval '5 minutes'
ORDER BY xact_start;

-- å‘Šè­¦é˜ˆå€¼ï¼šé•¿äº‹åŠ¡ > 5åˆ†é’Ÿ
```

#### äº‹åŠ¡æŒç»­æ—¶é—´

```sql
-- ç›‘æ§äº‹åŠ¡å¹³å‡æŒç»­æ—¶é—´
SELECT
    state,
    count(*) as count,
    avg(EXTRACT(EPOCH FROM (now() - xact_start))) as avg_duration_seconds,
    max(EXTRACT(EPOCH FROM (now() - xact_start))) as max_duration_seconds,
    percentile_cont(0.95) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (now() - xact_start))) as p95_duration_seconds
FROM pg_stat_activity
WHERE datname = current_database()
  AND xact_start IS NOT NULL
GROUP BY state;
```

### 1.2 äº‹åŠ¡çŠ¶æ€ç›‘æ§

#### äº‹åŠ¡çŠ¶æ€åˆ†å¸ƒ

```sql
-- ç›‘æ§äº‹åŠ¡çŠ¶æ€åˆ†å¸ƒ
SELECT
    state,
    count(*) as count,
    round(count(*) * 100.0 / sum(count(*)) OVER (), 2) as percentage
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY state
ORDER BY count DESC;
```

#### ç­‰å¾…äº‹åŠ¡ç›‘æ§

```sql
-- ç›‘æ§ç­‰å¾…äº‹åŠ¡
SELECT
    pid,
    usename,
    datname,
    wait_event_type,
    wait_event,
    state,
    query
FROM pg_stat_activity
WHERE datname = current_database()
  AND wait_event_type IS NOT NULL
ORDER BY wait_event_type, wait_event;

-- å‘Šè­¦é˜ˆå€¼ï¼šç­‰å¾…äº‹åŠ¡ > 10
```

#### é˜»å¡äº‹åŠ¡ç›‘æ§

```sql
-- æ£€æµ‹é˜»å¡äº‹åŠ¡
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    blocked_activity.application_name AS blocked_application,
    blocking_activity.application_name AS blocking_application
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- å‘Šè­¦é˜ˆå€¼ï¼šé˜»å¡äº‹åŠ¡ > 0
```

### 1.3 éš”ç¦»çº§åˆ«ç›‘æ§

#### éš”ç¦»çº§åˆ«åˆ†å¸ƒ

```sql
-- ç›‘æ§éš”ç¦»çº§åˆ«åˆ†å¸ƒï¼ˆéœ€è¦æ‰©å±•æ”¯æŒï¼‰
-- PostgreSQLé»˜è®¤ä¸ç›´æ¥æä¾›éš”ç¦»çº§åˆ«ç»Ÿè®¡
-- éœ€è¦é€šè¿‡åº”ç”¨å±‚ç›‘æ§æˆ–æ—¥å¿—åˆ†æ
```

#### åºåˆ—åŒ–é”™è¯¯ç›‘æ§

```sql
-- ç›‘æ§åºåˆ—åŒ–é”™è¯¯ï¼ˆé€šè¿‡æ—¥å¿—åˆ†æï¼‰
-- åœ¨postgresql.confä¸­å¯ç”¨ï¼š
-- log_min_messages = 'warning'
-- log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

-- æŸ¥è¯¢åºåˆ—åŒ–é”™è¯¯ç»Ÿè®¡
SELECT
    count(*) as serialization_failures
FROM pg_stat_database
WHERE datname = current_database();
-- æ³¨æ„ï¼šPostgreSQLä¸ç›´æ¥æä¾›åºåˆ—åŒ–é”™è¯¯ç»Ÿè®¡ï¼Œéœ€è¦é€šè¿‡æ—¥å¿—åˆ†æ
```

#### æ­»é”ç›‘æ§

```sql
-- ç›‘æ§æ­»é”ï¼ˆé€šè¿‡æ—¥å¿—åˆ†æï¼‰
-- åœ¨postgresql.confä¸­å¯ç”¨ï¼š
-- log_lock_waits = on
-- log_min_messages = 'warning'

-- æŸ¥è¯¢æ­»é”ç»Ÿè®¡ï¼ˆéœ€è¦æ‰©å±•æ”¯æŒï¼‰
-- å®é™…æ­»é”ä¿¡æ¯åœ¨æ—¥å¿—ä¸­
```

---

## ğŸš€ ç¬¬äºŒéƒ¨åˆ†ï¼šé”ç›‘æ§æŒ‡æ ‡

### 2.1 é”ç­‰å¾…ç›‘æ§

#### é”ç­‰å¾…æ•°é‡

```sql
-- ç›‘æ§é”ç­‰å¾…æ•°é‡
SELECT
    count(*) as lock_waits,
    count(DISTINCT pid) as waiting_processes
FROM pg_locks
WHERE NOT granted;

-- å‘Šè­¦é˜ˆå€¼ï¼šé”ç­‰å¾… > 5
```

#### é”ç­‰å¾…æ—¶é—´

```sql
-- ç›‘æ§é”ç­‰å¾…æ—¶é—´ï¼ˆéœ€è¦pg_stat_statementsæ‰©å±•ï¼‰
-- é€šè¿‡pg_stat_activityçš„wait_eventç›‘æ§
SELECT
    pid,
    wait_event_type,
    wait_event,
    state,
    now() - state_change as wait_duration
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
  AND datname = current_database()
ORDER BY wait_duration DESC;
```

#### é”ç­‰å¾…ç±»å‹åˆ†å¸ƒ

```sql
-- ç›‘æ§é”ç­‰å¾…ç±»å‹åˆ†å¸ƒ
SELECT
    locktype,
    mode,
    count(*) as wait_count
FROM pg_locks
WHERE NOT granted
GROUP BY locktype, mode
ORDER BY wait_count DESC;
```

### 2.2 é”æŒæœ‰ç›‘æ§

#### é”æŒæœ‰æ•°é‡

```sql
-- ç›‘æ§é”æŒæœ‰æ•°é‡
SELECT
    count(*) as held_locks,
    count(DISTINCT pid) as locking_processes
FROM pg_locks
WHERE granted;

-- å‘Šè­¦é˜ˆå€¼ï¼šé”æŒæœ‰ > 1000
```

#### é”æŒæœ‰æ—¶é—´

```sql
-- ç›‘æ§é”æŒæœ‰æ—¶é—´ï¼ˆé€šè¿‡pg_stat_activityï¼‰
SELECT
    l.pid,
    l.locktype,
    l.mode,
    l.relation::regclass,
    now() - a.state_change as lock_hold_duration,
    a.query
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.granted
  AND a.datname = current_database()
ORDER BY lock_hold_duration DESC;
```

#### é”å†²çªæ£€æµ‹

```sql
-- æ£€æµ‹é”å†²çª
SELECT
    l1.pid as waiting_pid,
    l1.locktype,
    l1.mode as waiting_mode,
    l1.relation::regclass,
    l2.pid as holding_pid,
    l2.mode as holding_mode
FROM pg_locks l1
JOIN pg_locks l2 ON l1.locktype = l2.locktype
    AND l1.database IS NOT DISTINCT FROM l2.database
    AND l1.relation IS NOT DISTINCT FROM l2.relation
    AND l1.page IS NOT DISTINCT FROM l2.page
    AND l1.tuple IS NOT DISTINCT FROM l2.tuple
WHERE NOT l1.granted
  AND l2.granted
  AND l1.pid != l2.pid;
```

### 2.3 æ­»é”ç›‘æ§

#### æ­»é”æ£€æµ‹

```sql
-- æ­»é”æ£€æµ‹ï¼ˆé€šè¿‡æ—¥å¿—åˆ†æï¼‰
-- PostgreSQLè‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶è®°å½•åˆ°æ—¥å¿—
-- æŸ¥è¯¢æ­»é”ç›¸å…³ä¿¡æ¯
SELECT
    pid,
    usename,
    datname,
    state,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE datname = current_database()
  AND wait_event_type = 'Lock';
```

#### æ­»é”é¢‘ç‡

```sql
-- æ­»é”é¢‘ç‡éœ€è¦é€šè¿‡æ—¥å¿—åˆ†æ
-- ä½¿ç”¨pgBadgeræˆ–ç±»ä¼¼å·¥å…·åˆ†ææ—¥å¿—
```

#### æ­»é”åˆ†æ

```sql
-- åˆ†ææ½œåœ¨æ­»é”åœºæ™¯
SELECT
    l1.pid as pid1,
    l2.pid as pid2,
    l1.locktype,
    l1.mode as mode1,
    l2.mode as mode2,
    l1.relation::regclass
FROM pg_locks l1
JOIN pg_locks l2 ON l1.locktype = l2.locktype
    AND l1.relation = l2.relation
WHERE l1.pid < l2.pid
  AND l1.mode != l2.mode
  AND l1.granted
  AND l2.granted;
```

---

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¡¨è†¨èƒ€ç›‘æ§

### 3.1 æ­»äº¡å…ƒç»„ç›‘æ§

#### æ­»äº¡å…ƒç»„æ•°é‡

```sql
-- ç›‘æ§æ­»äº¡å…ƒç»„æ•°é‡
SELECT
    schemaname,
    relname,
    n_live_tup as live_tuples,
    n_dead_tup as dead_tuples,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šæ­»äº¡å…ƒç»„ > 1000ä¸‡ æˆ– æ­»äº¡æ¯”ä¾‹ > 20%
```

#### æ­»äº¡å…ƒç»„æ¯”ä¾‹

```sql
-- ç›‘æ§æ­»äº¡å…ƒç»„æ¯”ä¾‹
SELECT
    schemaname,
    relname,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio_percent,
    pg_size_pretty(pg_relation_size(schemaname||'.'||relname)) as table_size
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY dead_ratio_percent DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šæ­»äº¡æ¯”ä¾‹ > 20%
```

#### æ­»äº¡å…ƒç»„å¢é•¿è¶‹åŠ¿

```sql
-- æ­»äº¡å…ƒç»„å¢é•¿è¶‹åŠ¿ï¼ˆéœ€è¦æ—¶é—´åºåˆ—æ•°æ®ï¼‰
-- å»ºè®®ä½¿ç”¨Prometheusç­‰ç›‘æ§ç³»ç»Ÿè®°å½•å†å²æ•°æ®
SELECT
    schemaname,
    relname,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    CASE
        WHEN last_vacuum > last_autovacuum THEN last_vacuum
        ELSE last_autovacuum
    END as last_vacuum_time,
    now() - GREATEST(COALESCE(last_vacuum, '1970-01-01'::timestamp),
                     COALESCE(last_autovacuum, '1970-01-01'::timestamp)) as time_since_vacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC;
```

### 3.2 è¡¨å¤§å°ç›‘æ§

#### è¡¨å¤§å°

```sql
-- ç›‘æ§è¡¨å¤§å°
SELECT
    schemaname,
    relname,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||relname)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||relname)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||relname) -
                   pg_relation_size(schemaname||'.'||relname)) as index_size,
    n_live_tup as row_count
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||relname) DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šè¡¨å¤§å° > 100GB
```

#### è¡¨è†¨èƒ€ç‡

```sql
-- ç›‘æ§è¡¨è†¨èƒ€ç‡
SELECT
    schemaname,
    relname,
    pg_size_pretty(pg_relation_size(schemaname||'.'||relname)) as table_size,
    n_live_tup as live_tuples,
    n_dead_tup as dead_tuples,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio_percent,
    round((pg_relation_size(schemaname||'.'||relname) -
           (n_live_tup * 200)) * 100.0 / NULLIF(pg_relation_size(schemaname||'.'||relname), 0), 2) as bloat_ratio_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY bloat_ratio_percent DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šè†¨èƒ€ç‡ > 30%
```

#### è¡¨å¤§å°å¢é•¿è¶‹åŠ¿

```sql
-- è¡¨å¤§å°å¢é•¿è¶‹åŠ¿ï¼ˆéœ€è¦æ—¶é—´åºåˆ—æ•°æ®ï¼‰
-- å»ºè®®ä½¿ç”¨Prometheusç­‰ç›‘æ§ç³»ç»Ÿè®°å½•å†å²æ•°æ®
SELECT
    schemaname,
    relname,
    pg_size_pretty(pg_relation_size(schemaname||'.'||relname)) as current_size,
    n_live_tup as current_rows
FROM pg_stat_user_tables
ORDER BY pg_relation_size(schemaname||'.'||relname) DESC;
```

### 3.3 VACUUMç›‘æ§

#### VACUUMæ‰§è¡Œé¢‘ç‡

```sql
-- ç›‘æ§VACUUMæ‰§è¡Œé¢‘ç‡
SELECT
    schemaname,
    relname,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    CASE
        WHEN last_vacuum > last_autovacuum THEN last_vacuum
        ELSE last_autovacuum
    END as last_vacuum_time,
    now() - GREATEST(COALESCE(last_vacuum, '1970-01-01'::timestamp),
                     COALESCE(last_autovacuum, '1970-01-01'::timestamp)) as time_since_vacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY time_since_vacuum DESC NULLS LAST
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šè¶…è¿‡24å°æ—¶æœªVACUUMä¸”æ­»äº¡å…ƒç»„ > 100ä¸‡
```

#### VACUUMæ‰§è¡Œæ—¶é—´

```sql
-- ç›‘æ§VACUUMæ‰§è¡Œæ—¶é—´ï¼ˆé€šè¿‡pg_stat_progress_vacuumï¼‰
SELECT
    pid,
    datname,
    relid::regclass,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples
FROM pg_stat_progress_vacuum;

-- å‘Šè­¦é˜ˆå€¼ï¼šVACUUMæ‰§è¡Œæ—¶é—´ > 1å°æ—¶
```

#### VACUUMæ•ˆæœ

```sql
-- ç›‘æ§VACUUMæ•ˆæœ
SELECT
    schemaname,
    relname,
    n_dead_tup as current_dead_tuples,
    last_vacuum,
    last_autovacuum,
    vacuum_count + autovacuum_count as total_vacuum_count,
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_ratio_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC
LIMIT 20;
```

---

## ğŸ”§ ç¬¬å››éƒ¨åˆ†ï¼šXIDå¹´é¾„ç›‘æ§

### 4.1 XIDå¹´é¾„ç›‘æ§

#### æ•°æ®åº“XIDå¹´é¾„

```sql
-- ç›‘æ§æ•°æ®åº“XIDå¹´é¾„
SELECT
    datname,
    age(datfrozenxid) as xid_age,
    pg_size_pretty(pg_database_size(datname)) as database_size
FROM pg_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY xid_age DESC;

-- å‘Šè­¦é˜ˆå€¼ï¼šXIDå¹´é¾„ > 1äº¿ï¼ˆautovacuum_freeze_max_ageçš„80%ï¼‰
```

#### è¡¨XIDå¹´é¾„

```sql
-- ç›‘æ§è¡¨XIDå¹´é¾„
SELECT
    schemaname,
    relname,
    age(relfrozenxid) as table_xid_age,
    pg_size_pretty(pg_relation_size(schemaname||'.'||relname)) as table_size
FROM pg_stat_user_tables
ORDER BY table_xid_age DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šè¡¨XIDå¹´é¾„ > 1äº¿
```

#### XIDå¹´é¾„è¶‹åŠ¿

```sql
-- XIDå¹´é¾„è¶‹åŠ¿ï¼ˆéœ€è¦æ—¶é—´åºåˆ—æ•°æ®ï¼‰
-- å»ºè®®ä½¿ç”¨Prometheusç­‰ç›‘æ§ç³»ç»Ÿè®°å½•å†å²æ•°æ®
SELECT
    datname,
    age(datfrozenxid) as current_xid_age,
    (2^31 - age(datfrozenxid)) as xid_remaining
FROM pg_database
WHERE datname = current_database();
```

### 4.2 XIDå›å·é£é™©ç›‘æ§

#### å›å·é£é™©è¯„ä¼°

```sql
-- è¯„ä¼°XIDå›å·é£é™©
SELECT
    datname,
    age(datfrozenxid) as xid_age,
    (2^31 - age(datfrozenxid)) as xid_remaining,
    round(age(datfrozenxid) * 100.0 / 2000000000, 2) as risk_percent,
    CASE
        WHEN age(datfrozenxid) > 1800000000 THEN 'CRITICAL'
        WHEN age(datfrozenxid) > 1500000000 THEN 'WARNING'
        WHEN age(datfrozenxid) > 1000000000 THEN 'CAUTION'
        ELSE 'OK'
    END as risk_level
FROM pg_database
WHERE datname NOT IN ('template0', 'template1', 'postgres')
ORDER BY xid_age DESC;

-- å‘Šè­¦é˜ˆå€¼ï¼š
-- CRITICAL: XIDå¹´é¾„ > 18äº¿
-- WARNING: XIDå¹´é¾„ > 15äº¿
-- CAUTION: XIDå¹´é¾„ > 10äº¿
```

#### FREEZEæ“ä½œç›‘æ§

```sql
-- ç›‘æ§FREEZEæ“ä½œ
SELECT
    schemaname,
    relname,
    age(relfrozenxid) as table_xid_age,
    last_vacuum,
    last_autovacuum,
    last_freeze,
    last_autovacuum,
    CASE
        WHEN last_vacuum > last_autovacuum THEN last_vacuum
        ELSE last_autovacuum
    END as last_vacuum_time
FROM pg_stat_user_tables
WHERE age(relfrozenxid) > 100000000
ORDER BY table_xid_age DESC
LIMIT 20;
```

#### é¢„é˜²æªæ–½ç›‘æ§

```sql
-- ç›‘æ§é¢„é˜²æªæ–½ï¼ˆautovacuumé…ç½®ï¼‰
SELECT
    name,
    setting,
    unit,
    short_desc
FROM pg_settings
WHERE name IN (
    'autovacuum_freeze_max_age',
    'autovacuum_freeze_min_age',
    'vacuum_freeze_min_age',
    'vacuum_freeze_table_age'
);

-- æ£€æŸ¥autovacuumæ˜¯å¦æ­£å¸¸è¿è¡Œ
SELECT
    count(*) as autovacuum_workers
FROM pg_stat_activity
WHERE query LIKE '%autovacuum%'
  AND state = 'active';
```

---

## ğŸ“ˆ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ç›‘æ§æŒ‡æ ‡

### 5.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§

#### æ…¢æŸ¥è¯¢ç›‘æ§

```sql
-- ç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆéœ€è¦pg_stat_statementsæ‰©å±•ï¼‰
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    round(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) as cache_hit_ratio
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- è¶…è¿‡1ç§’
ORDER BY mean_exec_time DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´ > 1ç§’
```

#### æŸ¥è¯¢æ‰§è¡Œæ—¶é—´

```sql
-- ç›‘æ§å½“å‰æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
SELECT
    pid,
    usename,
    datname,
    state,
    now() - query_start as query_duration,
    query
FROM pg_stat_activity
WHERE datname = current_database()
  AND state = 'active'
  AND query NOT LIKE '%pg_stat_activity%'
ORDER BY query_duration DESC
LIMIT 20;

-- å‘Šè­¦é˜ˆå€¼ï¼šæŸ¥è¯¢æ‰§è¡Œæ—¶é—´ > 30ç§’
```

#### æŸ¥è¯¢é¢‘ç‡

```sql
-- ç›‘æ§æŸ¥è¯¢é¢‘ç‡ï¼ˆéœ€è¦pg_stat_statementsæ‰©å±•ï¼‰
SELECT
    left(query, 100) as query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    round(total_exec_time * 100.0 / sum(total_exec_time) OVER (), 2) as time_percent
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 20;
```

### 5.2 è¿æ¥ç›‘æ§

#### è¿æ¥æ•°é‡

```sql
-- ç›‘æ§è¿æ¥æ•°é‡
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active_connections,
    count(*) FILTER (WHERE state = 'idle') as idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction
FROM pg_stat_activity
WHERE datname = current_database();

-- å‘Šè­¦é˜ˆå€¼ï¼šæ€»è¿æ¥æ•° > max_connections * 0.8
```

#### è¿æ¥ä½¿ç”¨ç‡

```sql
-- ç›‘æ§è¿æ¥ä½¿ç”¨ç‡
SELECT
    count(*) as current_connections,
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') as max_connections,
    round(count(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) as usage_percent
FROM pg_stat_activity;

-- å‘Šè­¦é˜ˆå€¼ï¼šä½¿ç”¨ç‡ > 80%
```

#### è¿æ¥ç­‰å¾…

```sql
-- ç›‘æ§è¿æ¥ç­‰å¾…
SELECT
    count(*) as waiting_connections
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
  AND datname = current_database();

-- å‘Šè­¦é˜ˆå€¼ï¼šç­‰å¾…è¿æ¥ > 10
```

### 5.3 å¤åˆ¶ç›‘æ§

#### å¤åˆ¶å»¶è¿Ÿ

```sql
-- ç›‘æ§å¤åˆ¶å»¶è¿Ÿï¼ˆä¸»åº“ï¼‰
SELECT
    client_addr,
    state,
    sync_state,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn)) as sent_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn)) as write_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn)) as flush_lag,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) as replay_lag
FROM pg_stat_replication;

-- å‘Šè­¦é˜ˆå€¼ï¼šå¤åˆ¶å»¶è¿Ÿ > 1GB æˆ– å»¶è¿Ÿæ—¶é—´ > 1åˆ†é’Ÿ
```

#### å¤åˆ¶æ§½ç›‘æ§

```sql
-- ç›‘æ§å¤åˆ¶æ§½
SELECT
    slot_name,
    slot_type,
    database,
    active,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as lag_size,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) as confirmed_lag
FROM pg_replication_slots;

-- å‘Šè­¦é˜ˆå€¼ï¼šå¤åˆ¶æ§½å»¶è¿Ÿ > 10GB
```

#### WALç›‘æ§

```sql
-- ç›‘æ§WAL
SELECT
    pg_size_pretty(pg_current_wal_lsn() - '0/0') as current_wal_position,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),
        (SELECT restart_lsn FROM pg_replication_slots LIMIT 1))) as wal_retention_size;

-- å‘Šè­¦é˜ˆå€¼ï¼šWALä¿ç•™å¤§å° > 100GB
```

---

## ğŸ¯ ç¬¬å…­éƒ¨åˆ†ï¼šç›‘æ§SQLæŸ¥è¯¢

### 6.1 äº‹åŠ¡ç›‘æ§æŸ¥è¯¢

```sql
-- ç»¼åˆäº‹åŠ¡ç›‘æ§æŸ¥è¯¢
SELECT
    'Active Transactions' as metric,
    count(*) FILTER (WHERE state = 'active') as value
FROM pg_stat_activity
WHERE datname = current_database()
UNION ALL
SELECT
    'Long Transactions (>5min)',
    count(*)
FROM pg_stat_activity
WHERE datname = current_database()
  AND state IN ('active', 'idle in transaction')
  AND now() - xact_start > interval '5 minutes'
UNION ALL
SELECT
    'Blocked Transactions',
    count(DISTINCT blocked_locks.pid)
FROM pg_catalog.pg_locks blocked_locks
WHERE NOT blocked_locks.granted;
```

### 6.2 é”ç›‘æ§æŸ¥è¯¢

```sql
-- ç»¼åˆé”ç›‘æ§æŸ¥è¯¢
SELECT
    'Lock Waits' as metric,
    count(*) as value
FROM pg_locks
WHERE NOT granted
UNION ALL
SELECT
    'Held Locks',
    count(*)
FROM pg_locks
WHERE granted
UNION ALL
SELECT
    'Deadlocks (from logs)',
    0;  -- éœ€è¦é€šè¿‡æ—¥å¿—åˆ†æ
```

### 6.3 è¡¨è†¨èƒ€ç›‘æ§æŸ¥è¯¢

```sql
-- ç»¼åˆè¡¨è†¨èƒ€ç›‘æ§æŸ¥è¯¢
SELECT
    'Tables with Dead Tuples' as metric,
    count(*) as value
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
UNION ALL
SELECT
    'Total Dead Tuples',
    sum(n_dead_tup)
FROM pg_stat_user_tables
UNION ALL
SELECT
    'Tables Needing VACUUM',
    count(*)
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000000
  AND (last_vacuum IS NULL OR last_vacuum < now() - interval '24 hours')
  AND (last_autovacuum IS NULL OR last_autovacuum < now() - interval '24 hours');
```

### 6.4 XIDå¹´é¾„ç›‘æ§æŸ¥è¯¢

```sql
-- ç»¼åˆXIDå¹´é¾„ç›‘æ§æŸ¥è¯¢
SELECT
    'Database XID Age' as metric,
    age(datfrozenxid) as value
FROM pg_database
WHERE datname = current_database()
UNION ALL
SELECT
    'Max Table XID Age',
    max(age(relfrozenxid))
FROM pg_stat_user_tables
UNION ALL
SELECT
    'XID Remaining',
    (2^31 - age(datfrozenxid))
FROM pg_database
WHERE datname = current_database();
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

1. **äº‹åŠ¡ç›‘æ§**ï¼šæ´»åŠ¨äº‹åŠ¡ã€é•¿äº‹åŠ¡ã€é˜»å¡äº‹åŠ¡
2. **é”ç›‘æ§**ï¼šé”ç­‰å¾…ã€é”æŒæœ‰ã€æ­»é”
3. **è¡¨è†¨èƒ€ç›‘æ§**ï¼šæ­»äº¡å…ƒç»„ã€è¡¨å¤§å°ã€VACUUMæ•ˆæœ
4. **XIDå¹´é¾„ç›‘æ§**ï¼šæ•°æ®åº“XIDå¹´é¾„ã€è¡¨XIDå¹´é¾„ã€å›å·é£é™©
5. **æ€§èƒ½ç›‘æ§**ï¼šæ…¢æŸ¥è¯¢ã€è¿æ¥ã€å¤åˆ¶

### å‘Šè­¦é˜ˆå€¼å»ºè®®

| æŒ‡æ ‡ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ |
|------|---------|---------|
| æ´»åŠ¨äº‹åŠ¡ | > 100 | > 500 |
| é•¿äº‹åŠ¡ | > 5åˆ†é’Ÿ | > 30åˆ†é’Ÿ |
| é”ç­‰å¾… | > 5 | > 20 |
| æ­»äº¡å…ƒç»„ | > 1000ä¸‡ | > 1äº¿ |
| è¡¨è†¨èƒ€ç‡ | > 20% | > 50% |
| XIDå¹´é¾„ | > 10äº¿ | > 18äº¿ |
| å¤åˆ¶å»¶è¿Ÿ | > 1GB | > 10GB |

### ç›‘æ§æœ€ä½³å®è·µ

1. **å®æ—¶ç›‘æ§**ï¼šå…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§
2. **å†å²è¶‹åŠ¿**ï¼šä½¿ç”¨æ—¶é—´åºåˆ—æ•°æ®åº“è®°å½•å†å²æ•°æ®
3. **å‘Šè­¦è§„åˆ™**ï¼šè®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
4. **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šè‡ªåŠ¨VACUUMã€è‡ªåŠ¨å‘Šè­¦
5. **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦è§„åˆ™

PostgreSQL 17/18çš„MVCCæœºåˆ¶éœ€è¦å…¨é¢çš„ç›‘æ§ä½“ç³»ï¼Œé€šè¿‡ç›‘æ§è¿™äº›å…³é”®æŒ‡æ ‡ï¼Œå¯ä»¥åŠæ—¶å‘ç°å’Œé¢„é˜²é—®é¢˜ï¼Œç¡®ä¿æ•°æ®åº“ç¨³å®šè¿è¡Œã€‚
