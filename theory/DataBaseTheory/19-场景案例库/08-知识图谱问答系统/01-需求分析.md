# 知识图谱问答系统 - 需求分析

## 元数据
- **案例类型**: 知识图谱 + KBQA + LLM
- **难度等级**: ⭐⭐⭐⭐⭐
- **数据规模**: 百万实体、千万关系
- **技术栈**: Apache AGE + pgvector + GPT-4 + LangChain
- **创建日期**: 2025-12-04

---

## 1. 业务背景

### 1.1 场景描述

某企业需要构建**智能知识问答系统**，让员工能够用自然语言查询企业知识库。

**典型问题**:
- "公司有哪些Python开发工程师？"
- "张三在哪个部门工作？他的上级是谁？"
- "研发中心有多少员工？平均工资是多少？"
- "推荐与李四技能相似的候选人"
- "找出所有参与过AI项目的员工"

### 1.2 业务价值

```
效率提升:
├─ 信息查询时间: 10分钟 → 10秒 (-99%)
├─ 知识获取准确率: 60% → 92% (+53%)
└─ 员工满意度: +40%

成本节省:
├─ HR查询工作量: -70%
├─ 知识管理成本: -50%
└─ 培训成本: -30%

业务赋能:
├─ 辅助招聘决策
├─ 人才盘点分析
└─ 组织结构优化
```

---

## 2. 功能需求

### 2.1 核心功能

#### F1: 自然语言问答

```
输入: "研发中心有哪些Python工程师?"
   ↓
[Text-to-Cypher生成]
   ↓
生成的Cypher:
MATCH (d:Department {name: '研发中心'})<-[:WORKS_IN]-(e:Employee)
WHERE 'Python' IN e.skills
RETURN e.name, e.title, e.years_experience
   ↓
[执行查询]
   ↓
[结果生成]
   ↓
输出: "研发中心有15名Python工程师：张三（高级）、李四（中级）..."
```

#### F2: 多跳推理

```cypher
-- 复杂多跳查询示例

问题: "找出与张三合作过的同事的上级"

MATCH (emp:Employee {name: '张三'})-[:WORKED_WITH]-(colleague)
MATCH (colleague)-[:REPORTS_TO]->(manager)
RETURN DISTINCT manager.name, manager.title
```

#### F3: 推荐查询

```cypher
-- 基于技能和经验的候选人推荐

问题: "推荐与李四技能相似的候选人"

MATCH (target:Employee {name: '李四'})
MATCH (candidate:Employee)
WHERE candidate <> target
  AND SIZE([s IN target.skills WHERE s IN candidate.skills]) > 0
WITH candidate,
     SIZE([s IN target.skills WHERE s IN candidate.skills]) AS common_skills,
     ABS(candidate.years_experience - target.years_experience) AS exp_diff
RETURN
    candidate.name,
    candidate.title,
    common_skills,
    exp_diff,
    common_skills * 10 - exp_diff AS score
ORDER BY score DESC
LIMIT 10
```

### 2.2 辅助功能

- ✅ 问题理解与意图识别
- ✅ 实体识别与链接
- ✅ 查询结果可视化
- ✅ 推理路径解释
- ✅ 历史查询记录

---

## 3. 技术挑战

### 3.1 核心挑战

#### 挑战1: Text-to-Cypher准确率

```
目标: >90%准确率

难点:
├─ 自然语言理解
├─ Schema感知
├─ 复杂查询生成
└─ 语法错误处理

解决方案:
├─ GPT-4 Few-Shot学习
├─ 动态示例选择
├─ 自动错误修复
└─ Schema提示注入
```

#### 挑战2: 实体链接准确率

```
问题:
├─ 实体歧义 (如"张三"可能有多个)
├─ 实体缺失 (知识库中没有)
└─ 实体变体 (昵称、简称)

解决:
├─ 三级匹配 (精确/模糊/语义)
├─ 上下文消歧
└─ 用户交互确认
```

#### 挑战3: 系统性能

```
目标:
├─ 端到端延迟: <2秒
├─ QPS: 100+
└─ 并发: 100+

优化:
├─ Cypher查询缓存
├─ 图索引优化
├─ LLM结果缓存
└─ 异步处理
```

---

## 4. 数据模型

### 4.1 知识图谱Schema

```cypher
// 节点类型

(:Employee)     - 员工
  属性:
  ├─ id: 员工ID
  ├─ name: 姓名
  ├─ title: 职位
  ├─ skills: 技能列表
  ├─ years_experience: 工作年限
  └─ email: 邮箱

(:Department)   - 部门
  属性:
  ├─ id: 部门ID
  ├─ name: 部门名称
  ├─ type: 部门类型
  └─ budget: 预算

(:Project)      - 项目
  属性:
  ├─ id: 项目ID
  ├─ name: 项目名称
  ├─ status: 状态
  ├─ start_date: 开始日期
  └─ budget: 预算

(:Skill)        - 技能
  属性:
  ├─ id: 技能ID
  ├─ name: 技能名称
  └─ category: 类别

// 关系类型

(Employee)-[:WORKS_IN]->(Department)
(Employee)-[:REPORTS_TO]->(Employee)     # 汇报关系
(Employee)-[:HAS_SKILL]->(Skill)
(Employee)-[:PARTICIPATED_IN]->(Project)
(Employee)-[:WORKED_WITH]->(Employee)    # 合作关系
(Project)-[:BELONGS_TO]->(Department)
```

### 4.2 向量索引

```sql
-- 员工技能向量 (用于相似度搜索)
CREATE TABLE employee_embeddings (
    employee_id BIGINT PRIMARY KEY,
    name TEXT,
    skills TEXT[],
    embedding vector(384),
    FOREIGN KEY (employee_id) REFERENCES employees(id)
);

-- pgvector索引
CREATE INDEX idx_employee_emb
ON employee_embeddings
USING hnsw (embedding vector_cosine_ops);
```

---

## 5. 性能指标

### 5.1 功能指标

| 指标 | 目标 | 说明 |
|------|------|------|
| **Text-to-Cypher准确率** | >90% | Cypher生成正确率 |
| **实体链接准确率** | >90% | 实体识别与链接 |
| **问答准确率** | >85% | 端到端准确率 |
| **查询覆盖率** | >80% | 可回答问题比例 |

### 5.2 性能指标

| 指标 | 目标 | 说明 |
|------|------|------|
| **端到端延迟** | <2秒 | P95 |
| **Cypher生成延迟** | <500ms | GPT-4调用 |
| **图查询延迟** | <200ms | Apache AGE |
| **QPS** | 100+ | 并发查询 |
| **系统可用性** | 99.9% | SLA |

---

## 6. 技术选型

### 6.1 核心技术栈

```yaml
数据库:
  PostgreSQL: 18+
  Apache AGE: 1.5+
  pgvector: 0.7+

AI/LLM:
  OpenAI: GPT-4
  LangChain: 0.1+
  SentenceTransformers: all-MiniLM-L6-v2

开发框架:
  Python: 3.11+
  FastAPI: 0.104+

缓存:
  Redis: 7.2+
```

### 6.2 技术决策

| 技术选择 | 原因 |
|----------|------|
| **Apache AGE** | 原生图查询、Cypher支持、与PostgreSQL无缝集成 |
| **pgvector** | 原生向量搜索、HNSW高性能 |
| **GPT-4** | Text-to-Cypher准确率最高 |
| **LangChain** | LLM编排、错误处理完善 |
| **Redis** | 高性能缓存、减少LLM调用 |

---

## 7. 系统边界

### 7.1 包含功能

✅ 自然语言问答
✅ Text-to-Cypher生成
✅ 实体识别与链接
✅ 多跳图推理
✅ 答案生成
✅ 推理路径解释

### 7.2 不包含功能

❌ 知识图谱构建 (假设已有)
❌ 语音交互
❌ 多语言支持 (仅中文)
❌ 图谱可视化前端

---

## 8. 风险与挑战

### 8.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| **LLM幻觉** | 生成错误Cypher | Schema约束、错误修复机制 |
| **图查询性能** | 超时 | 查询优化、超时保护 |
| **成本** | LLM调用费用高 | 缓存策略、批处理 |
| **数据质量** | 知识不完整 | 数据清洗、补全 |

### 8.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| **问答准确率低** | 用户体验差 | A/B测试、持续优化 |
| **响应延迟高** | 用户流失 | 性能优化、异步处理 |
| **知识过时** | 信息错误 | 自动更新机制 |

---

## 9. 验收标准

### 9.1 功能验收

```
测试场景1: 简单查询
问题: "有多少员工?"
预期: 正确返回员工总数
通过标准: 100%正确

测试场景2: 多跳推理
问题: "张三的同事的上级是谁?"
预期: 正确识别2-hop路径
通过标准: 90%正确

测试场景3: 聚合查询
问题: "每个部门的平均工资?"
预期: 正确生成GROUP BY查询
通过标准: 95%正确

测试场景4: 推荐查询
问题: "推荐与李四技能相似的人"
预期: 基于技能向量相似度推荐
通过标准: 85%满意度
```

### 9.2 性能验收

```
负载测试:
├─ 100并发用户
├─ 持续10分钟
├─ P95延迟 < 2秒
└─ 无错误

压力测试:
├─ 200并发用户
├─ 持续5分钟
├─ P99延迟 < 5秒
└─ 错误率 < 1%
```

---

## 10. 预期成果

### 10.1 系统指标

```
端到端延迟: <2秒 (P95)
QPS: 100+
Text-to-Cypher准确率: >90%
问答准确率: >85%
系统可用性: 99.9%
```

### 10.2 技术验证

✅ **Apache AGE知识图谱**: 验证图查询性能
✅ **GPT-4 Text-to-Cypher**: 验证生成准确率
✅ **pgvector语义搜索**: 验证实体链接效果
✅ **混合检索架构**: 验证RAG+KG融合
✅ **LangChain集成**: 验证生产级应用

---

**下一步**: [02-架构设计](./02-架构设计.md) | [返回案例库](../README.md)
