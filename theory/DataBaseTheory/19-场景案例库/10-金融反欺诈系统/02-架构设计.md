# 金融反欺诈系统 - 架构设计

## 元数据
- **创建日期**: 2025-12-04
- **架构类型**: 实时风控 + 图算法 + 规则引擎
- **技术栈**: Apache AGE + 实时流处理 + 机器学习

---

## 1. 系统架构

```
                交易事件流
                    ↓
┌──────────────────────────────────────────────────────────┐
│              实时风控引擎                                 │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────────────────────────────────┐        │
│  │        规则引擎（实时检测 <100ms）           │        │
│  │  ┌────────────┐  ┌────────────┐            │        │
│  │  │ 金额异常   │  │ 地点异常   │            │        │
│  │  └────────────┘  └────────────┘            │        │
│  │  ┌────────────┐  ┌────────────┐            │        │
│  │  │ 频率异常   │  │ 设备异常   │            │        │
│  │  └────────────┘  └────────────┘            │        │
│  └──────────────────┬───────────────────────────┘        │
│                     ↓                                     │
│  ┌──────────────────────────────────────────────┐        │
│  │    图算法检测（批量分析 <1分钟）             │        │
│  │  ┌────────────┐  ┌────────────┐            │        │
│  │  │ 社区发现   │  │ 中心性     │            │        │
│  │  │ (Louvain)  │  │ (PageRank) │            │        │
│  │  └────────────┘  └────────────┘            │        │
│  └──────────────────┬───────────────────────────┘        │
│                     ↓                                     │
│  ┌──────────────────────────────────────────────┐        │
│  │          风险评分模型                        │        │
│  │    规则分数 (40%) + 图分数 (60%)             │        │
│  └──────────────────┬───────────────────────────┘        │
│                     ↓                                     │
└─────────────────────┼─────────────────────────────────────┘
                      ↓
        ┌─────────────────────────┐
        │  风险等级                │
        ├─────────────────────────┤
        │  高风险: 阻断交易        │
        │  中风险: 人工审核        │
        │  低风险: 放行            │
        └─────────────────────────┘
```

---

## 2. 规则检测引擎

```python
class RuleEngine:
    """规则检测引擎"""

    def __init__(self, db_conn):
        self.db = db_conn
        self.rules = self._load_rules()

    async def detect(self, transaction: Dict) -> List[Dict]:
        """实时规则检测"""

        alerts = []

        # 规则1: 异常金额
        if await self._check_abnormal_amount(transaction):
            alerts.append({
                'rule': 'abnormal_amount',
                'severity': 'high',
                'score': 80
            })

        # 规则2: 异常地点
        if await self._check_abnormal_location(transaction):
            alerts.append({
                'rule': 'abnormal_location',
                'severity': 'medium',
                'score': 60
            })

        # 规则3: 高频交易
        if await self._check_high_frequency(transaction):
            alerts.append({
                'rule': 'high_frequency',
                'severity': 'medium',
                'score': 50
            })

        return alerts

    async def _check_abnormal_amount(self, txn: Dict) -> bool:
        """检测异常金额"""
        sql = """
            SELECT
                txn.amount > stats.avg_amount + 3 * stats.stddev_amount AS is_abnormal
            FROM (VALUES (%(user_id)s, %(amount)s)) AS txn(user_id, amount)
            LEFT JOIN (
                SELECT
                    user_id,
                    AVG(amount) AS avg_amount,
                    STDDEV(amount) AS stddev_amount
                FROM transactions
                WHERE user_id = %(user_id)s
                  AND created_at > NOW() - INTERVAL '30 days'
                GROUP BY user_id
            ) stats ON stats.user_id = txn.user_id;
        """

        result = await self.db.fetchone(sql, {
            'user_id': txn['user_id'],
            'amount': txn['amount']
        })

        return result['is_abnormal'] if result else False
```

---

## 3. 图算法检测

```python
class GraphDetector:
    """基于图算法的欺诈检测"""

    def __init__(self, age_conn, graph_name='fraud_graph'):
        self.age = age_conn
        self.graph_name = graph_name

    async def detect_fraud_ring(self, account_id: int) -> Dict:
        """检测欺诈团伙"""

        # Cypher查询：检测可疑转账模式
        cypher = f"""
            SELECT * FROM cypher('{self.graph_name}', $$
                MATCH (a1:Account)-[t1:TRANSFER]->(target:Account)
                      <-[t2:TRANSFER]-(a2:Account)
                WHERE id(target) = {account_id}
                  AND t1.timestamp - t2.timestamp < 3600
                  AND t1.amount > 10000
                  AND t2.amount > 10000
                  AND a1 <> a2
                WITH target,
                     COUNT(DISTINCT a1) AS suspicious_count,
                     SUM(t1.amount + t2.amount) AS total_amount
                WHERE suspicious_count >= 5
                RETURN
                    id(target) AS account_id,
                    suspicious_count,
                    total_amount,
                    suspicious_count * 10 + total_amount / 10000 AS risk_score
                ORDER BY risk_score DESC
            $$) AS (account_id agtype, suspicious_count agtype,
                   total_amount agtype, risk_score agtype);
        """

        result = await self.age.fetchone(cypher)

        if result:
            return {
                'detected': True,
                'pattern': 'fraud_ring',
                'suspicious_count': int(json.loads(result['suspicious_count'])),
                'total_amount': float(json.loads(result['total_amount'])),
                'risk_score': float(json.loads(result['risk_score']))
            }

        return {'detected': False}

    async def compute_centrality(self, account_id: int) -> float:
        """计算账户中心性（PageRank）"""

        cypher = f"""
            SELECT * FROM cypher('{self.graph_name}', $$
                MATCH (a:Account)
                WHERE id(a) = {account_id}
                RETURN a.pagerank AS centrality
            $$) AS (centrality agtype);
        """

        result = await self.age.fetchone(cypher)
        return float(json.loads(result['centrality'])) if result else 0.0
```

---

## 4. 风险评分模型

```python
class RiskScorer:
    """风险评分器"""

    def calculate_risk(self, rule_alerts: List[Dict],
                      graph_features: Dict) -> Dict:
        """计算综合风险分数"""

        # 规则分数（权重40%）
        rule_score = sum(alert['score'] for alert in rule_alerts) / 100.0
        rule_score = min(rule_score, 100)

        # 图分数（权重60%）
        graph_score = (
            graph_features.get('community_risk', 0) * 0.4 +
            graph_features.get('centrality_risk', 0) * 0.3 +
            graph_features.get('pattern_risk', 0) * 0.3
        )

        # 综合分数
        final_score = rule_score * 0.4 + graph_score * 0.6

        # 风险等级
        if final_score >= 80:
            level = 'high'
            action = 'block'
        elif final_score >= 50:
            level = 'medium'
            action = 'review'
        else:
            level = 'low'
            action = 'pass'

        return {
            'risk_score': final_score,
            'risk_level': level,
            'action': action,
            'rule_score': rule_score,
            'graph_score': graph_score,
            'alerts': rule_alerts,
            'graph_features': graph_features
        }
```

---

**下一步**: [03-数据库设计](./03-数据库设计.md) | [返回首页](./README.md)
