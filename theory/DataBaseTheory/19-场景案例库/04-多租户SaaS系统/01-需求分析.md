# 多租户SaaS系统 - 需求分析

## 元数据

- **案例类型**: 多租户架构 + RLS + 性能优化
- **难度等级**: ⭐⭐⭐⭐
- **数据规模**: 1000+租户、千万级数据
- **技术栈**: PostgreSQL 18 + RLS + 连接池
- **创建日期**: 2025-12-04

---

## 1. 业务背景

某SaaS平台为1000+企业客户提供CRM服务，需要确保**数据隔离**和**性能稳定**。

**核心挑战**:

- 数据隔离（绝对安全）
- 性能隔离（互不影响）
- 成本优化（资源复用）
- 弹性扩展（灵活增长）

---

## 2. 隔离策略

### 2.1 三种隔离方案对比

| 方案 | 数据隔离 | 性能隔离 | 成本 | 管理复杂度 | 推荐场景 |
|------|----------|----------|------|------------|----------|
| **独立数据库** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 高 | 高 | 大客户 |
| **独立Schema** | ⭐⭐⭐⭐ | ⭐⭐⭐ | 中 | 中 | 中型客户 |
| **RLS行级安全** | ⭐⭐⭐ | ⭐⭐ | 低 | 低 | 小客户 |

**本案例选择**: RLS行级安全（适合大部分SaaS场景）

---

## 3. RLS设计

### 3.1 基础RLS策略

```sql
-- 启用RLS
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;

-- 创建策略
CREATE POLICY tenant_isolation ON customers
    FOR ALL
    TO app_user
    USING (tenant_id = current_setting('app.current_tenant')::bigint);

-- 使用示例
SET app.current_tenant = 123;
SELECT * FROM customers;  -- 只返回tenant_id=123的数据
```

### 3.2 性能优化RLS

```sql
-- PostgreSQL 18 RLS性能优化

-- 为RLS字段创建索引
CREATE INDEX idx_customers_tenant
ON customers(tenant_id)
WHERE tenant_id IS NOT NULL;

-- 分区表 + RLS
CREATE TABLE customers (
    customer_id BIGSERIAL,
    tenant_id BIGINT NOT NULL,
    name TEXT,
    ...
) PARTITION BY LIST (tenant_id);

-- 为大租户创建独立分区
CREATE TABLE customers_tenant_1
PARTITION OF customers
FOR VALUES IN (1);

CREATE TABLE customers_tenant_default
PARTITION OF customers
DEFAULT;
```

---

## 4. 性能指标

| 指标 | 目标 |
|------|------|
| **查询延迟** | <50ms (P95) |
| **租户QPS** | 1000+ |
| **租户并发** | 100+ |
| **RLS开销** | <10% |
| **数据隔离** | 100% |

---

**下一步**: [02-架构设计](./02-架构设计.md) | [返回案例库](../README.md)
