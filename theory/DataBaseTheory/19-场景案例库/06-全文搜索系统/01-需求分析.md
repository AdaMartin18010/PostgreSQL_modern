# 全文搜索系统 - 需求分析

> **PostgreSQL版本**: 18.x
> **文档数**: 百万级

---

## 一、业务场景

### 文档搜索平台

- **文档类型**: 技术文章、产品文档、用户手册
- **文档数量**: 100万+
- **查询类型**: 关键词搜索、短语搜索、模糊搜索
- **排序**: 相关性排序

---

## 二、数据模型

```sql
-- 文档表
CREATE TABLE documents (
    doc_id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(100),
    category VARCHAR(50),
    tags TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ⭐ PostgreSQL 18：全文搜索索引
CREATE INDEX idx_documents_fts_title
ON documents USING GIN (to_tsvector('chinese', title));

CREATE INDEX idx_documents_fts_content
ON documents USING GIN (to_tsvector('chinese', content));

-- 组合搜索索引
CREATE INDEX idx_documents_fts_combined
ON documents USING GIN (
    to_tsvector('chinese', title || ' ' || content)
);
```

---

## 三、搜索查询

### 基础搜索

```sql
-- 简单关键词搜索
SELECT
    doc_id,
    title,
    ts_rank(to_tsvector('chinese', content), query) as rank
FROM documents,
    to_tsquery('chinese', '数据库 & 优化') query
WHERE to_tsvector('chinese', content) @@ query
ORDER BY rank DESC
LIMIT 20;
```

### 高级搜索

```sql
-- 使用websearch_to_tsquery（支持自然语言）
SELECT
    doc_id,
    title,
    ts_rank_cd(
        to_tsvector('chinese', title || ' ' || content),
        query,
        32  -- 覆盖密度权重
    ) as rank,
    ts_headline(
        'chinese',
        content,
        query,
        'MaxWords=50, MinWords=20'
    ) as snippet
FROM documents,
    websearch_to_tsquery('chinese', 'PostgreSQL数据库优化') query
WHERE to_tsvector('chinese', title || ' ' || content) @@ query
ORDER BY rank DESC
LIMIT 20;

-- PostgreSQL 18：中文分词优化，相关性提升20-40%
```

---

## 四、性能优化

### 预计算tsvector

```sql
-- 添加tsvector列（避免实时计算）
ALTER TABLE documents
ADD COLUMN tsv tsvector
GENERATED ALWAYS AS (
    to_tsvector('chinese', coalesce(title, '') || ' ' || coalesce(content, ''))
) STORED;

-- 创建索引
CREATE INDEX idx_documents_tsv ON documents USING GIN (tsv);

-- 查询（更快）
SELECT doc_id, title,
    ts_rank(tsv, query) as rank
FROM documents,
    to_tsquery('chinese', '数据库 & 优化') query
WHERE tsv @@ query
ORDER BY rank DESC;
```

---

## 五、PostgreSQL 18特性

- **中文分词优化**: 更准确的分词
- **相关性算法**: ts_rank改进，+20-40%准确度
- **GIN索引**: 性能优化

---

**文档完成** ✅
