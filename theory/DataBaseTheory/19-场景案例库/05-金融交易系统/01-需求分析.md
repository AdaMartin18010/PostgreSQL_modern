# 金融交易系统 - 需求分析

> **PostgreSQL版本**: 18.x
> **隔离级别**: Serializable

---

## 一、核心需求

### ACID严格保证

**转账操作必须满足**:

1. **原子性(A)**: 全部成功或全部失败
2. **一致性(C)**: 账户总额不变
3. **隔离性(I)**: Serializable隔离级别
4. **持久性(D)**: 已提交数据永不丢失

---

## 二、典型业务场景

### 转账流程

```sql
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- 1. 扣减源账户
UPDATE accounts
SET balance = balance - 1000,
    updated_at = NOW()
WHERE account_id = 'A001'
  AND balance >= 1000;  -- 余额检查

IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION '余额不足';
END IF;

-- 2. 增加目标账户
UPDATE accounts
SET balance = balance + 1000,
    updated_at = NOW()
WHERE account_id = 'A002';

-- 3. 记录交易
INSERT INTO transactions (
    from_account, to_account, amount, type, status
) VALUES (
    'A001', 'A002', 1000, 'TRANSFER', 'SUCCESS'
);

COMMIT;
```

---

## 三、数据库设计

```sql
-- 账户表
CREATE TABLE accounts (
    account_id VARCHAR(50) PRIMARY KEY,
    customer_id BIGINT,
    balance NUMERIC(18,2) NOT NULL CHECK (balance >= 0),
    currency VARCHAR(3) DEFAULT 'CNY',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 交易表
CREATE TABLE transactions (
    transaction_id BIGSERIAL PRIMARY KEY,
    from_account VARCHAR(50),
    to_account VARCHAR(50),
    amount NUMERIC(18,2),
    currency VARCHAR(3),
    type VARCHAR(20),
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (from_account) REFERENCES accounts(account_id),
    FOREIGN KEY (to_account) REFERENCES accounts(account_id)
);

-- 审计日志表
CREATE TABLE audit_logs (
    audit_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    old_values JSONB,
    new_values JSONB,
    user_id BIGINT,
    client_ip INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 四、幂等性设计

```sql
-- 交易请求表（防止重复提交）
CREATE TABLE transaction_requests (
    request_id VARCHAR(100) PRIMARY KEY,  -- 客户端生成的唯一ID
    transaction_id BIGINT,
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (request_id)
);

-- 转账函数（幂等）
CREATE OR REPLACE FUNCTION transfer_money(
    p_request_id VARCHAR(100),
    p_from_account VARCHAR(50),
    p_to_account VARCHAR(50),
    p_amount NUMERIC(18,2)
) RETURNS BIGINT AS $$
DECLARE
    v_transaction_id BIGINT;
BEGIN
    -- 检查是否已处理
    SELECT transaction_id INTO v_transaction_id
    FROM transaction_requests
    WHERE request_id = p_request_id;

    IF FOUND THEN
        RETURN v_transaction_id;  -- 返回已有交易ID
    END IF;

    -- 执行转账
    -- ... 转账逻辑 ...

    -- 记录请求
    INSERT INTO transaction_requests (request_id, transaction_id, status)
    VALUES (p_request_id, v_transaction_id, 'SUCCESS');

    RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 五、PostgreSQL 18特性

- **事务提交优化**: TPS+30%
- **审计日志增强**: JSON格式，异步写入
- **WAL优化**: 确保零数据丢失
- **Serializable优化**: 减少false positive

---

**文档完成** ✅
