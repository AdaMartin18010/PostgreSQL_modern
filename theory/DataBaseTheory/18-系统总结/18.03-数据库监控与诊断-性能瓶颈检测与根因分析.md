# æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­-æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ä¸æ ¹å› åˆ†æ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­-æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ä¸æ ¹å› åˆ†æ](#æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­-æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ä¸æ ¹å› åˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­å·¥ä½œåŸç†æ¦‚è¿°](#10-æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 æ€§èƒ½ç›‘æ§](#21-æ€§èƒ½ç›‘æ§)
    - [2.2 ç“¶é¢ˆæ£€æµ‹](#22-ç“¶é¢ˆæ£€æµ‹)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 ç›‘æ§å½¢å¼åŒ–](#31-ç›‘æ§å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§å®šç†](#41-æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§å®šç†)
    - [4.2 æ ¹å› åˆ†ææ­£ç¡®æ€§å®šç†](#42-æ ¹å› åˆ†ææ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18ç›‘æ§å·¥å…·å®ç°](#51-postgresql-18ç›‘æ§å·¥å…·å®ç°)
      - [5.1.1 æ€§èƒ½ç›‘æ§](#511-æ€§èƒ½ç›‘æ§)
    - [5.2 å®é™…åº”ç”¨åœºæ™¯](#52-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šæ€§èƒ½ç“¶é¢ˆæ£€æµ‹](#åœºæ™¯1æ€§èƒ½ç“¶é¢ˆæ£€æµ‹)
      - [åœºæ™¯2ï¼šæ ¹å› åˆ†æ](#åœºæ™¯2æ ¹å› åˆ†æ)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [5.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#51-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#61-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [6.2 PostgreSQLå®ç°ç›¸å…³](#62-postgresqlå®ç°ç›¸å…³)
    - [6.3 ç›¸å…³æ–‡æ¡£](#63-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 æ•°æ®åº“ç›‘æ§ä¸è¯Šæ–­å·¥ä½œåŸç†æ¦‚è¿°

**ç›‘æ§è¯Šæ–­**ï¼š

æ•°æ®åº“ç›‘æ§é€šè¿‡æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å’Œæ ¹å› åˆ†ææ¥è¯Šæ–­ç³»ç»Ÿé—®é¢˜ã€‚

**ç›‘æ§è¯Šæ–­æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((ç›‘æ§è¯Šæ–­))
    æ€§èƒ½ç›‘æ§
      æŒ‡æ ‡æ”¶é›†
      é˜ˆå€¼å‘Šè­¦
      è¶‹åŠ¿åˆ†æ
    ç“¶é¢ˆæ£€æµ‹
      CPUç“¶é¢ˆ
      I/Oç“¶é¢ˆ
      å†…å­˜ç“¶é¢ˆ
    æ ¹å› åˆ†æ
      é—®é¢˜å®šä½
      å½±å“åˆ†æ
      è§£å†³æ–¹æ¡ˆ
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **æ€§èƒ½ç›‘æ§**ï¼šæŒ‡æ ‡æ”¶é›†å’Œåˆ†æ
- **ç“¶é¢ˆæ£€æµ‹**ï¼šæ€§èƒ½ç“¶é¢ˆè¯†åˆ«
- **æ ¹å› åˆ†æ**ï¼šé—®é¢˜è¯Šæ–­æ–¹æ³•

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 æ€§èƒ½ç›‘æ§

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | å®šä¹‰ | é˜ˆå€¼ |
|------|------|------|
| **CPUä½¿ç”¨ç‡** | CPUå ç”¨ç™¾åˆ†æ¯” | >80% |
| **I/Oç­‰å¾…** | I/Oç­‰å¾…æ—¶é—´ | >100ms |
| **å†…å­˜ä½¿ç”¨** | å†…å­˜å ç”¨ | >90% |

### 2.2 ç“¶é¢ˆæ£€æµ‹

**æ£€æµ‹ç®—æ³•**ï¼š

```haskell
-- ç“¶é¢ˆæ£€æµ‹
detectBottleneck :: Metrics -> Maybe Bottleneck
detectBottleneck metrics
    | cpuUsage metrics > 0.8 = Just CPUBottleneck
    | ioWait metrics > 100 = Just IOBottleneck
    | memoryUsage metrics > 0.9 = Just MemoryBottleneck
    | otherwise = Nothing
```

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 ç›‘æ§å½¢å¼åŒ–

**ç›‘æ§**ï¼š

```haskell
-- ç›‘æ§å½¢å¼åŒ–
Monitor = (M, T, A)
where
    M = metrics set
    T = threshold set
    A = alert function
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§å®šç†

**å®šç†1ï¼ˆæ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§ï¼‰**ï¼š

æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ç³»ç»Ÿæ˜¯å®Œå¤‡çš„ï¼Œå³å®ƒèƒ½å¤Ÿè¯†åˆ«æ‰€æœ‰ä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆï¼ˆCPUã€I/Oã€å†…å­˜ã€ç½‘ç»œç­‰ï¼‰ï¼Œå¹¶æä¾›å‡†ç¡®çš„è¯Šæ–­ä¿¡æ¯ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ç³»ç»ŸBottleneckDetection = (M, T, D)ï¼ŒæŒ‡æ ‡é›†åˆMï¼Œé˜ˆå€¼é›†åˆTï¼Œè¯Šæ–­å‡½æ•°Dã€‚åˆ™ï¼š

```text
âˆ€bottleneck âˆˆ Bottlenecks: âˆƒm âˆˆ M, t âˆˆ T: detect(bottleneck, m, t)
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šæŒ‡æ ‡è¦†ç›–å®Œå¤‡æ€§**ï¼š

- æ€§èƒ½ç“¶é¢ˆæ£€æµ‹ç³»ç»Ÿæ¶µç›–CPUã€I/Oã€å†…å­˜ã€ç½‘ç»œç­‰å…³é”®æŒ‡æ ‡
- è¿™äº›æŒ‡æ ‡èƒ½å¤Ÿè¯†åˆ«æ‰€æœ‰ä¸»è¦æ€§èƒ½ç“¶é¢ˆ

**æ­¥éª¤2ï¼šé˜ˆå€¼è®¾ç½®åˆç†æ€§**ï¼š

- é˜ˆå€¼è®¾ç½®åŸºäºç³»ç»Ÿç‰¹æ€§å’Œå†å²æ•°æ®
- é˜ˆå€¼èƒ½å¤Ÿå‡†ç¡®è§¦å‘ç“¶é¢ˆå‘Šè­¦

**æ­¥éª¤3ï¼šè¯Šæ–­å‡†ç¡®æ€§**ï¼š

- è¯Šæ–­å‡½æ•°èƒ½å¤Ÿå‡†ç¡®è¯†åˆ«ç“¶é¢ˆç±»å‹å’ŒåŸå› 
- è¯Šæ–­ç»“æœæ”¯æŒé—®é¢˜è§£å†³

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å®Œå¤‡æ€§å®šç†] --> B[æŒ‡æ ‡è¦†ç›–å®Œå¤‡æ€§]
    B --> C[é˜ˆå€¼è®¾ç½®åˆç†æ€§]
    C --> D[è¯Šæ–­å‡†ç¡®æ€§]
    D --> E[å®šç†å¾—è¯]

    style A fill:#FFD700
    style E fill:#90EE90
```

### 4.2 æ ¹å› åˆ†ææ­£ç¡®æ€§å®šç†

**å®šç†2ï¼ˆæ ¹å› åˆ†ææ­£ç¡®æ€§ï¼‰**ï¼š

æ ¹å› åˆ†ææ˜¯æ­£ç¡®çš„ï¼Œå³å¯¹äºä»»æ„æ€§èƒ½é—®é¢˜problemï¼Œæ ¹å› åˆ†æèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œå¹¶æä¾›æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾æ ¹å› åˆ†æå‡½æ•°RootCauseAnalysisï¼Œæ€§èƒ½é—®é¢˜problemã€‚åˆ™ï¼š

```text
root_cause(RootCauseAnalysis(problem)) = true_root_cause(problem)
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šé—®é¢˜åˆ†æ**ï¼š

- æ ¹å› åˆ†æç³»ç»Ÿèƒ½å¤Ÿå…¨é¢åˆ†ææ€§èƒ½é—®é¢˜çš„å„ä¸ªæ–¹é¢
- åˆ†æè¿‡ç¨‹éµå¾ªç³»ç»ŸåŒ–çš„æ–¹æ³•

**æ­¥éª¤2ï¼šåŸå› è¯†åˆ«**ï¼š

- ç³»ç»Ÿèƒ½å¤ŸåŒºåˆ†è¡¨é¢åŸå› å’Œæ ¹æœ¬åŸå› 
- æ ¹å› è¯†åˆ«åŸºäºå› æœå…³ç³»åˆ†æ

**æ­¥éª¤3ï¼šè§£å†³æ–¹æ¡ˆæœ‰æ•ˆæ€§**ï¼š

- é’ˆå¯¹æ ¹å› çš„è§£å†³æ–¹æ¡ˆèƒ½å¤Ÿæœ‰æ•ˆè§£å†³é—®é¢˜
- è§£å†³æ–¹æ¡ˆç»è¿‡éªŒè¯

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- æ ¹å› åˆ†ææ­£ç¡®æ€§å®šç†å¾—è¯

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18ç›‘æ§å·¥å…·å®ç°

#### 5.1.1 æ€§èƒ½ç›‘æ§

**PostgreSQL 18æ€§èƒ½ç›‘æ§**ï¼š

PostgreSQL 18æä¾›äº†ä¸°å¯Œçš„æ€§èƒ½ç›‘æ§è§†å›¾å’Œç»Ÿè®¡ä¿¡æ¯ã€‚

**æ€§èƒ½ç›‘æ§å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šPostgreSQL 18æ€§èƒ½ç›‘æ§
-- 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- 2. æŸ¥çœ‹ç­‰å¾…äº‹ä»¶
SELECT
    wait_event_type,
    wait_event,
    COUNT(*) AS wait_count,
    SUM(EXTRACT(EPOCH FROM (NOW() - state_change))) AS total_wait_time
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL
GROUP BY wait_event_type, wait_event
ORDER BY total_wait_time DESC;

-- 3. æŸ¥çœ‹I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit
FROM pg_statio_user_tables
ORDER BY heap_blks_read + idx_blks_read DESC
LIMIT 10;
```

### 5.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šæ€§èƒ½ç“¶é¢ˆæ£€æµ‹

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

éœ€è¦å®æ—¶ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Œè‡ªåŠ¨æ£€æµ‹æ€§èƒ½ç“¶é¢ˆå¹¶å‘Šè­¦ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šæ€§èƒ½ç“¶é¢ˆæ£€æµ‹
-- 1. åˆ›å»ºæ€§èƒ½ç›‘æ§è¡¨
CREATE TABLE performance_metrics (
    metric_id SERIAL PRIMARY KEY,
    metric_time TIMESTAMPTZ DEFAULT NOW(),
    cpu_usage DOUBLE PRECISION,
    io_wait DOUBLE PRECISION,
    memory_usage DOUBLE PRECISION,
    active_connections INTEGER,
    slow_queries INTEGER
);

-- 2. æ€§èƒ½ç“¶é¢ˆæ£€æµ‹å‡½æ•°
CREATE OR REPLACE FUNCTION detect_performance_bottlenecks()
RETURNS TABLE (
    bottleneck_type VARCHAR,
    severity VARCHAR,
    current_value DOUBLE PRECISION,
    threshold_value DOUBLE PRECISION,
    recommendation TEXT
) AS $$
DECLARE
    v_cpu_usage DOUBLE PRECISION;
    v_io_wait DOUBLE PRECISION;
    v_memory_usage DOUBLE PRECISION;
    v_active_connections INTEGER;
BEGIN
    -- è·å–å½“å‰æŒ‡æ ‡ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
    SELECT
        (SELECT AVG(cpu_usage) FROM performance_metrics WHERE metric_time >= NOW() - INTERVAL '5 minutes'),
        (SELECT AVG(io_wait) FROM performance_metrics WHERE metric_time >= NOW() - INTERVAL '5 minutes'),
        (SELECT AVG(memory_usage) FROM performance_metrics WHERE metric_time >= NOW() - INTERVAL '5 minutes'),
        (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active')
    INTO v_cpu_usage, v_io_wait, v_memory_usage, v_active_connections;

    -- æ£€æµ‹CPUç“¶é¢ˆ
    IF v_cpu_usage > 80.0 THEN
        RETURN QUERY SELECT
            'CPU'::VARCHAR,
            'HIGH'::VARCHAR,
            v_cpu_usage,
            80.0,
            'Consider optimizing queries or adding more CPU resources'::TEXT;
    END IF;

    -- æ£€æµ‹I/Oç“¶é¢ˆ
    IF v_io_wait > 100.0 THEN
        RETURN QUERY SELECT
            'I/O'::VARCHAR,
            'HIGH'::VARCHAR,
            v_io_wait,
            100.0,
            'Consider optimizing I/O or using faster storage'::TEXT;
    END IF;

    -- æ£€æµ‹å†…å­˜ç“¶é¢ˆ
    IF v_memory_usage > 90.0 THEN
        RETURN QUERY SELECT
            'Memory'::VARCHAR,
            'HIGH'::VARCHAR,
            v_memory_usage,
            90.0,
            'Consider increasing shared_buffers or optimizing memory usage'::TEXT;
    END IF;

    -- æ£€æµ‹è¿æ¥æ•°ç“¶é¢ˆ
    IF v_active_connections > 100 THEN
        RETURN QUERY SELECT
            'Connections'::VARCHAR,
            'MEDIUM'::VARCHAR,
            v_active_connections::DOUBLE PRECISION,
            100.0,
            'Consider using connection pooling'::TEXT;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

#### åœºæ™¯2ï¼šæ ¹å› åˆ†æ

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

éœ€è¦åˆ†ææ€§èƒ½é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œæä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šæ ¹å› åˆ†æ
-- 1. åˆ›å»ºæ ¹å› åˆ†æè¡¨
CREATE TABLE root_cause_analysis (
    analysis_id SERIAL PRIMARY KEY,
    problem_description TEXT,
    symptoms JSONB,
    root_cause VARCHAR(200),
    solution TEXT,
    analysis_time TIMESTAMPTZ DEFAULT NOW()
);

-- 2. æ ¹å› åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_root_cause(
    p_symptoms JSONB
)
RETURNS TABLE (
    root_cause VARCHAR,
    confidence DOUBLE PRECISION,
    solution TEXT
) AS $$
DECLARE
    v_slow_queries BOOLEAN;
    v_high_cpu BOOLEAN;
    v_high_io BOOLEAN;
    v_lock_waits BOOLEAN;
BEGIN
    -- åˆ†æç—‡çŠ¶
    v_slow_queries := (p_symptoms->>'slow_queries')::BOOLEAN;
    v_high_cpu := (p_symptoms->>'high_cpu')::BOOLEAN;
    v_high_io := (p_symptoms->>'high_io')::BOOLEAN;
    v_lock_waits := (p_symptoms->>'lock_waits')::BOOLEAN;

    -- æ ¹å› åˆ†æé€»è¾‘
    IF v_slow_queries AND v_high_io THEN
        RETURN QUERY SELECT
            'Inefficient queries causing high I/O'::VARCHAR,
            0.9,
            'Optimize queries, add indexes, or increase shared_buffers'::TEXT;
    ELSIF v_high_cpu AND v_slow_queries THEN
        RETURN QUERY SELECT
            'CPU-intensive queries'::VARCHAR,
            0.85,
            'Optimize query plans, use parallel queries, or add more CPU'::TEXT;
    ELSIF v_lock_waits THEN
        RETURN QUERY SELECT
            'Lock contention'::VARCHAR,
            0.8,
            'Reduce transaction duration, use lower isolation levels, or optimize locking'::TEXT;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

---

---

## 6. ç›¸å…³æ–‡æ¡£

### 5.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 6.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Charity, M., et al. (2021). "Observability Engineering: Achieving Production Excellence."**
  - å‡ºç‰ˆç¤¾: O'Reilly Media
  - **é‡è¦æ€§**: å¯è§‚æµ‹æ€§å·¥ç¨‹çš„ç»å…¸æ•™æ
  - **æ ¸å¿ƒè´¡çŒ®**: ç³»ç»Ÿé˜è¿°äº†ç›‘æ§å’Œè¯Šæ–­æ–¹æ³•

- **Dean, J., & Barroso, L. A. (2013). "The Tail at Scale."**
  - ä¼šè®®: Communications of the ACM 2013
  - **é‡è¦æ€§**: å¤§è§„æ¨¡ç³»ç»Ÿæ€§èƒ½åˆ†æ
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†ç“¶é¢ˆæ£€æµ‹æ–¹æ³•

### 6.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - ç›‘æ§](<https://www.postgresql.org/docs/current/monitoring.html>)**
  - PostgreSQLç›‘æ§è¯´æ˜

### 6.3 ç›¸å…³æ–‡æ¡£

- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
