# é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥-Last-Write-Winsä¸åˆå¹¶å‡½æ•°æ¯”è¾ƒ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-16
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥-Last-Write-Winsä¸åˆå¹¶å‡½æ•°æ¯”è¾ƒ](#é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥-last-write-winsä¸åˆå¹¶å‡½æ•°æ¯”è¾ƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.0 é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥å·¥ä½œåŸç†æ¦‚è¿°](#10-é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥å·¥ä½œåŸç†æ¦‚è¿°)
    - [1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´](#11-æœ¬æ–‡æ¡£çš„èŒƒå›´)
  - [2. æ ¸å¿ƒå†…å®¹](#2-æ ¸å¿ƒå†…å®¹)
    - [2.1 Last-Write-Wins](#21-last-write-wins)
    - [2.2 åˆå¹¶å‡½æ•°](#22-åˆå¹¶å‡½æ•°)
  - [3. å½¢å¼åŒ–å®šä¹‰](#3-å½¢å¼åŒ–å®šä¹‰)
    - [3.1 å†²çªè§£ç®—å½¢å¼åŒ–](#31-å†²çªè§£ç®—å½¢å¼åŒ–)
  - [4. å®šç†ä¸è¯æ˜](#4-å®šç†ä¸è¯æ˜)
    - [4.1 LWWæ­£ç¡®æ€§å®šç†](#41-lwwæ­£ç¡®æ€§å®šç†)
    - [4.2 åˆå¹¶å‡½æ•°æ­£ç¡®æ€§å®šç†](#42-åˆå¹¶å‡½æ•°æ­£ç¡®æ€§å®šç†)
  - [5. å®é™…åº”ç”¨](#5-å®é™…åº”ç”¨)
    - [5.1 PostgreSQL 18å†²çªå¤„ç†å®ç°](#51-postgresql-18å†²çªå¤„ç†å®ç°)
      - [5.1.1 å†²çªå¤„ç†é…ç½®](#511-å†²çªå¤„ç†é…ç½®)
    - [5.2 å®é™…åº”ç”¨åœºæ™¯](#52-å®é™…åº”ç”¨åœºæ™¯)
      - [åœºæ™¯1ï¼šLWWç­–ç•¥åº”ç”¨](#åœºæ™¯1lwwç­–ç•¥åº”ç”¨)
      - [åœºæ™¯2ï¼šåˆå¹¶å‡½æ•°ç­–ç•¥åº”ç”¨](#åœºæ™¯2åˆå¹¶å‡½æ•°ç­–ç•¥åº”ç”¨)
    - [5.3 PostgreSQL 18å†²çªå¤„ç†æœ€ä½³å®è·µ](#53-postgresql-18å†²çªå¤„ç†æœ€ä½³å®è·µ)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)
    - [6.1 ç†è®ºåŸºç¡€æ–‡æ¡£](#61-ç†è®ºåŸºç¡€æ–‡æ¡£)
  - [7. å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
    - [7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®](#71-æ ¸å¿ƒç†è®ºæ–‡çŒ®)
    - [7.2 PostgreSQLå®ç°ç›¸å…³](#72-postgresqlå®ç°ç›¸å…³)
    - [7.3 ç›¸å…³æ–‡æ¡£](#73-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

### 1.0 é€»è¾‘å¤åˆ¶å†²çªç­–ç•¥å·¥ä½œåŸç†æ¦‚è¿°

**å†²çªç­–ç•¥**ï¼š

é€»è¾‘å¤åˆ¶ä½¿ç”¨ä¸åŒç­–ç•¥è§£å†³å†²çªï¼ŒåŒ…æ‹¬Last-Write-Winså’Œåˆå¹¶å‡½æ•°ã€‚

**å†²çªç­–ç•¥æ€ç»´å¯¼å›¾**ï¼š

```mermaid
mindmap
  root((å†²çªç­–ç•¥))
    Last-Write-Wins
      æ—¶é—´æˆ³æ¯”è¾ƒ
      ç®€å•é«˜æ•ˆ
      å¯èƒ½ä¸¢æ•°æ®
    åˆå¹¶å‡½æ•°
      è‡ªå®šä¹‰åˆå¹¶
      ä¿ç•™æ‰€æœ‰å˜æ›´
      å¤æ‚å®ç°
    ç­–ç•¥æ¯”è¾ƒ
      æ­£ç¡®æ€§
      æ€§èƒ½
      é€‚ç”¨åœºæ™¯
```

### 1.1 æœ¬æ–‡æ¡£çš„èŒƒå›´

æœ¬æ–‡æ¡£æ¶µç›–ï¼š

- **Last-Write-Wins**ï¼šåŸºäºæ—¶é—´æˆ³çš„ç­–ç•¥
- **åˆå¹¶å‡½æ•°**ï¼šè‡ªå®šä¹‰åˆå¹¶ç­–ç•¥
- **ç­–ç•¥æ¯”è¾ƒ**ï¼šä¼˜ç¼ºç‚¹å¯¹æ¯”
- **å®é™…åº”ç”¨**ï¼šPostgreSQLå†²çªå¤„ç†

---

## 2. æ ¸å¿ƒå†…å®¹

### 2.1 Last-Write-Wins

**LWWç­–ç•¥**ï¼š

```haskell
-- Last-Write-Wins
lww :: (Row, Timestamp) -> (Row, Timestamp) -> Row
lww (r1, t1) (r2, t2) =
    if t1 > t2 then r1 else r2
```

### 2.2 åˆå¹¶å‡½æ•°

**åˆå¹¶ç­–ç•¥**ï¼š

```haskell
-- åˆå¹¶å‡½æ•°
merge :: Row -> Row -> Row
merge r1 r2 =
    combine(r1, r2)  -- è‡ªå®šä¹‰åˆå¹¶é€»è¾‘
```

**ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **LWW** | ç®€å•é«˜æ•ˆ | å¯èƒ½ä¸¢æ•°æ® | æ—¶é—´æˆ³å¯é  |
| **åˆå¹¶** | ä¿ç•™æ•°æ® | å®ç°å¤æ‚ | éœ€è¦ä¿ç•™æ‰€æœ‰å˜æ›´ |

---

## 3. å½¢å¼åŒ–å®šä¹‰

### 3.1 å†²çªè§£ç®—å½¢å¼åŒ–

**è§£ç®—**ï¼š

```haskell
-- å†²çªè§£ç®—å½¢å¼åŒ–
resolve(conflict, strategy) =
    case strategy of
        LWW -> lww(conflict)
        Merge -> merge(conflict)
```

---

## 4. å®šç†ä¸è¯æ˜

### 4.1 LWWæ­£ç¡®æ€§å®šç†

**å®šç†1ï¼ˆLWWæ­£ç¡®æ€§ï¼‰**ï¼š

Last-Write-Winsï¼ˆLWWï¼‰ç­–ç•¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå³å¯¹äºä»»æ„å†²çªconflictï¼Œä½¿ç”¨LWWç­–ç•¥è§£ç®—åï¼Œæ‰€æœ‰å‰¯æœ¬çš„çŠ¶æ€å°†æ”¶æ•›åˆ°ä¸€è‡´çŠ¶æ€ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾LWWè§£ç®—å‡½æ•°lwwï¼Œå†²çªconflictï¼Œå‰¯æœ¬é›†åˆRã€‚åˆ™ï¼š

```text
âˆ€Râ‚, Râ‚‚ âˆˆ R: eventually(Râ‚ = Râ‚‚) after lww(conflict)
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šæ—¶é—´æˆ³å…¨å±€é¡ºåº**ï¼š

- LWWç­–ç•¥åŸºäºæ—¶é—´æˆ³çš„å…¨å±€é¡ºåº
- æ—¶é—´æˆ³ç¡®ä¿æ‰€æœ‰å‰¯æœ¬å¯¹äº‹ä»¶çš„é¡ºåºè¾¾æˆä¸€è‡´

**æ­¥éª¤2ï¼šå†²çªè§£ç®—**ï¼š

- å½“å‘ç”Ÿå†²çªæ—¶ï¼ŒLWWé€‰æ‹©æ—¶é—´æˆ³æœ€å¤§çš„æ›´æ–°
- æ—¶é—´æˆ³æœ€å¤§çš„æ›´æ–°åœ¨æ‰€æœ‰å‰¯æœ¬ä¸­åº”ç”¨

**æ­¥éª¤3ï¼šæœ€ç»ˆä¸€è‡´æ€§**ï¼š

- æ‰€æœ‰å‰¯æœ¬åº”ç”¨ç›¸åŒçš„æ›´æ–°ï¼ˆæ—¶é—´æˆ³æœ€å¤§çš„ï¼‰
- ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´çŠ¶æ€

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- LWWæ­£ç¡®æ€§å®šç†å¾—è¯

**è¯æ˜æ ‘**ï¼š

```mermaid
graph TD
    A[LWWæ­£ç¡®æ€§å®šç†] --> B[æ—¶é—´æˆ³å…¨å±€é¡ºåº]
    B --> C[å†²çªè§£ç®—]
    C --> D[æœ€ç»ˆä¸€è‡´æ€§]
    D --> E[å®šç†å¾—è¯]

    style A fill:#FFD700
    style E fill:#90EE90
```

### 4.2 åˆå¹¶å‡½æ•°æ­£ç¡®æ€§å®šç†

**å®šç†2ï¼ˆåˆå¹¶å‡½æ•°æ­£ç¡®æ€§ï¼‰**ï¼š

åˆå¹¶å‡½æ•°ç­–ç•¥æ˜¯æ­£ç¡®çš„ï¼Œå³å¯¹äºä»»æ„å†²çªconflictï¼Œåˆå¹¶å‡½æ•°èƒ½å¤Ÿä¿ç•™æ‰€æœ‰æœ‰æ•ˆæ›´æ–°ï¼Œå¹¶äº§ç”Ÿä¸€è‡´çš„çŠ¶æ€ã€‚

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

è®¾åˆå¹¶å‡½æ•°mergeï¼Œå†²çªconflictï¼ŒçŠ¶æ€stateã€‚åˆ™ï¼š

```text
valid(merge(conflict, state)) âˆ§ preserves(merge, conflict)
```

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šåˆå¹¶å‡½æ•°å®šä¹‰**ï¼š

- åˆå¹¶å‡½æ•°èƒ½å¤Ÿåˆå¹¶å¤šä¸ªå¹¶å‘æ›´æ–°
- åˆå¹¶å‡½æ•°ä¿ç•™æ‰€æœ‰æœ‰æ•ˆæ›´æ–°

**æ­¥éª¤2ï¼šåˆå¹¶æ­£ç¡®æ€§**ï¼š

- åˆå¹¶åçš„çŠ¶æ€æ»¡è¶³æ•°æ®å®Œæ•´æ€§çº¦æŸ
- åˆå¹¶æ“ä½œæ˜¯å¹‚ç­‰çš„

**æ­¥éª¤3ï¼šä¸€è‡´æ€§ä¿è¯**ï¼š

- åˆå¹¶å‡½æ•°åœ¨æ‰€æœ‰å‰¯æœ¬ä¸­äº§ç”Ÿç›¸åŒçš„åˆå¹¶ç»“æœ
- ç³»ç»Ÿæ»¡è¶³æœ€ç»ˆä¸€è‡´æ€§è¦æ±‚

**æ­¥éª¤4ï¼šç»“è®º**ï¼š

- åˆå¹¶å‡½æ•°æ­£ç¡®æ€§å®šç†å¾—è¯

---

## 5. å®é™…åº”ç”¨

### 5.1 PostgreSQL 18å†²çªå¤„ç†å®ç°

#### 5.1.1 å†²çªå¤„ç†é…ç½®

**PostgreSQL 18å†²çªå¤„ç†æ”¯æŒ**ï¼š

PostgreSQL 18é€šè¿‡å†²çªå¤„ç†ç­–ç•¥å’Œè‡ªå®šä¹‰å‡½æ•°å®ç°é€»è¾‘å¤åˆ¶å†²çªè§£ç®—ã€‚

**å†²çªå¤„ç†é…ç½®**ï¼š

```sql
-- åœºæ™¯ï¼šé€»è¾‘å¤åˆ¶å†²çªå¤„ç†
-- 1. è®¾ç½®å†²çªå¤„ç†ç­–ç•¥
ALTER SUBSCRIPTION my_subscription
SET (conflict_resolution = 'last_write_wins');

-- 2. æŸ¥çœ‹å†²çªå¤„ç†é…ç½®
SELECT
    subname,
    subpublications,
    subslotname
FROM pg_subscription
WHERE subname = 'my_subscription';
```

### 5.2 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šLWWç­–ç•¥åº”ç”¨

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

éœ€è¦å¤„ç†å¹¶å‘æ›´æ–°å†²çªï¼Œä½¿ç”¨LWWç­–ç•¥é€‰æ‹©æœ€æ–°çš„æ›´æ–°ã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šLWWç­–ç•¥åº”ç”¨
-- 1. åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„è¡¨
CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY,
    profile_data JSONB,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION profile_publication FOR TABLE user_profiles;

-- 3. åˆ›å»ºè®¢é˜…ï¼ˆä½¿ç”¨LWWç­–ç•¥ï¼‰
CREATE SUBSCRIPTION profile_subscription
CONNECTION 'host=primary.example.com port=5432 dbname=mydb user=replicator'
PUBLICATION profile_publication
WITH (
    conflict_resolution = 'last_write_wins'
);

-- 4. è‡ªå®šä¹‰LWWå†²çªå¤„ç†å‡½æ•°
CREATE OR REPLACE FUNCTION resolve_lww_conflict(
    local_row RECORD,
    remote_row RECORD
)
RETURNS RECORD AS $$
BEGIN
    -- æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œé€‰æ‹©æœ€æ–°çš„
    IF local_row.updated_at >= remote_row.updated_at THEN
        RETURN local_row;
    ELSE
        RETURN remote_row;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

#### åœºæ™¯2ï¼šåˆå¹¶å‡½æ•°ç­–ç•¥åº”ç”¨

**ä¸šåŠ¡èƒŒæ™¯**ï¼š

éœ€è¦ä¿ç•™æ‰€æœ‰å¹¶å‘æ›´æ–°ï¼Œä½¿ç”¨åˆå¹¶å‡½æ•°åˆå¹¶å†²çªã€‚

**PostgreSQL 18å®ç°**ï¼š

```sql
-- åœºæ™¯ï¼šåˆå¹¶å‡½æ•°ç­–ç•¥åº”ç”¨
-- 1. åˆ›å»ºæ”¯æŒåˆå¹¶çš„è¡¨
CREATE TABLE inventory (
    product_id INTEGER PRIMARY KEY,
    quantity INTEGER NOT NULL,
    reserved INTEGER DEFAULT 0,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. åˆ›å»ºåˆå¹¶å‡½æ•°
CREATE OR REPLACE FUNCTION merge_inventory_conflict(
    local_row RECORD,
    remote_row RECORD
)
RETURNS RECORD AS $$
DECLARE
    merged_row RECORD;
BEGIN
    -- åˆå¹¶æ•°é‡ï¼ˆç´¯åŠ ï¼‰
    merged_row.product_id := local_row.product_id;
    merged_row.quantity := local_row.quantity + remote_row.quantity;
    merged_row.reserved := GREATEST(local_row.reserved, remote_row.reserved);
    merged_row.updated_at := GREATEST(local_row.updated_at, remote_row.updated_at);

    RETURN merged_row;
END;
$$ LANGUAGE plpgsql;

-- 3. åˆ›å»ºè®¢é˜…ï¼ˆä½¿ç”¨åˆå¹¶å‡½æ•°ï¼‰
CREATE SUBSCRIPTION inventory_subscription
CONNECTION 'host=primary.example.com port=5432 dbname=mydb user=replicator'
PUBLICATION inventory_publication
WITH (
    conflict_resolution = 'custom',
    conflict_handler = 'merge_inventory_conflict'
);
```

### 5.3 PostgreSQL 18å†²çªå¤„ç†æœ€ä½³å®è·µ

**å†²çªå¤„ç†ç­–ç•¥é€‰æ‹©**ï¼š

```sql
-- 1. LWWç­–ç•¥ï¼šé€‚ç”¨äºæ—¶é—´æˆ³å¯é ã€å¯ä»¥æ¥å—æ•°æ®ä¸¢å¤±çš„åœºæ™¯
ALTER SUBSCRIPTION my_subscription
SET (conflict_resolution = 'last_write_wins');

-- 2. åˆå¹¶å‡½æ•°ï¼šé€‚ç”¨äºéœ€è¦ä¿ç•™æ‰€æœ‰æ›´æ–°çš„åœºæ™¯
CREATE OR REPLACE FUNCTION custom_merge(local_row RECORD, remote_row RECORD)
RETURNS RECORD AS $$
BEGIN
    -- è‡ªå®šä¹‰åˆå¹¶é€»è¾‘
    RETURN merge(local_row, remote_row);
END;
$$ LANGUAGE plpgsql;

ALTER SUBSCRIPTION my_subscription
SET (conflict_resolution = 'custom', conflict_handler = 'custom_merge');
```

---

## 6. ç›¸å…³æ–‡æ¡£

### 6.1 ç†è®ºåŸºç¡€æ–‡æ¡£

- [å½¢å¼è¯­è¨€ä¸è¯æ˜ï¼šæ€»è®º](./1.1.25-å½¢å¼è¯­è¨€ä¸è¯æ˜-æ€»è®º.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](./README.md)

---

## 7. å‚è€ƒæ–‡çŒ®

### 7.1 æ ¸å¿ƒç†è®ºæ–‡çŒ®

- **Shapiro, M., et al. (2011). "Conflict-Free Replicated Data Types."**
  - ä¼šè®®: SSS 2011
  - **é‡è¦æ€§**: CRDTçš„ç»å…¸è®ºæ–‡
  - **æ ¸å¿ƒè´¡çŒ®**: æå‡ºäº†æ— å†²çªå¤åˆ¶æ•°æ®ç±»å‹

- **Bailis, P., et al. (2013). "Coordination Avoidance in Database Systems."**
  - ä¼šè®®: VLDB 2013
  - **é‡è¦æ€§**: æ•°æ®åº“åè°ƒé¿å…
  - **æ ¸å¿ƒè´¡çŒ®**: åˆ†æäº†å†²çªè§£ç®—ç­–ç•¥

### 7.2 PostgreSQLå®ç°ç›¸å…³

- **PostgreSQLå®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶å†²çª](<https://www.postgresql.org/docs/current/logical-replication-conflicts.html>)**
  - PostgreSQLé€»è¾‘å¤åˆ¶å†²çªå¤„ç†è¯´æ˜

### 7.3 ç›¸å…³æ–‡æ¡£

- [é€»è¾‘å¤åˆ¶-ä¸€è‡´æ€§è¯­ä¹‰ä¸å†²çªè§£ç®—](./16.01-é€»è¾‘å¤åˆ¶-ä¸€è‡´æ€§è¯­ä¹‰ä¸å†²çªè§£ç®—.md)
- [ç†è®ºåŸºç¡€å¯¼èˆª](../README.md)

---

**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: Documentation Team
**çŠ¶æ€**: âœ… å†…å®¹å·²å®Œæˆ
