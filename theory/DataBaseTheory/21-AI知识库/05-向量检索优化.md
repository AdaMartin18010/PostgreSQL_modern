# pgvector 向量检索优化

## 元数据
- **创建日期**: 2025-12-04
- **技术**: pgvector 0.7+ HNSW
- **性能**: QPS 2000+

---

## 1. HNSW索引优化

```sql
-- 创建HNSW索引
CREATE INDEX idx_doc_embedding
ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,              -- 每层最大连接数
    ef_construction = 64 -- 构建时的动态候选列表
);

-- 查询时参数
SET hnsw.ef_search = 40;  -- 搜索时的候选数

-- 性能对比
-- IVFFlat: 10ms, 95%召回
-- HNSW:    3ms, 98%召回  ✅ 更快更准
```

---

## 2. 批量检索优化

```python
# 批量向量查询
def batch_search(queries: List[str], top_k: int = 10):
    """批量向量检索"""

    # 批量生成向量
    query_embs = embedding_model.encode(queries)

    # 使用UNION ALL合并查询
    union_query = " UNION ALL ".join([
        f"""
        SELECT {i} AS query_idx, doc_id, content,
               1 - (embedding <=> '{emb.tolist()}'::vector) AS similarity
        FROM documents
        ORDER BY embedding <=> '{emb.tolist()}'::vector
        LIMIT {top_k}
        """
        for i, emb in enumerate(query_embs)
    ])

    return execute_query(union_query)
```

---

**返回**: [AI知识库首页](./README.md)
