# 3.2.2 åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: Neon v3.0+  
> **æ–‡æ¡£ç¼–å·**: 03-02-02

## ğŸ“‘ ç›®å½•

- [3.2.2 åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ](#322-åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ–‡æ¡£ç›®æ ‡](#11-æ–‡æ¡£ç›®æ ‡)
    - [1.2 é€‚ç”¨åœºæ™¯](#12-é€‚ç”¨åœºæ™¯)
  - [2. åˆ†æ”¯å‘½åè§„èŒƒ](#2-åˆ†æ”¯å‘½åè§„èŒƒ)
    - [2.1 å‘½åè§„åˆ™](#21-å‘½åè§„åˆ™)
    - [2.2 å‘½åç¤ºä¾‹](#22-å‘½åç¤ºä¾‹)
  - [3. åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†](#3-åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†)
    - [3.1 åˆ›å»ºç­–ç•¥](#31-åˆ›å»ºç­–ç•¥)
    - [3.2 ä½¿ç”¨ç­–ç•¥](#32-ä½¿ç”¨ç­–ç•¥)
    - [3.3 æ¸…ç†ç­–ç•¥](#33-æ¸…ç†ç­–ç•¥)
  - [4. åˆ†æ”¯åˆå¹¶ç­–ç•¥](#4-åˆ†æ”¯åˆå¹¶ç­–ç•¥)
    - [4.1 åˆå¹¶æµç¨‹](#41-åˆå¹¶æµç¨‹)
    - [4.2 å†²çªè§£å†³](#42-å†²çªè§£å†³)
  - [5. æˆæœ¬ä¼˜åŒ–å®è·µ](#5-æˆæœ¬ä¼˜åŒ–å®è·µ)
    - [5.1 åˆ†æ”¯æ•°é‡æ§åˆ¶](#51-åˆ†æ”¯æ•°é‡æ§åˆ¶)
    - [5.2 è‡ªåŠ¨æ¸…ç†æœºåˆ¶](#52-è‡ªåŠ¨æ¸…ç†æœºåˆ¶)
  - [6. å®‰å…¨æœ€ä½³å®è·µ](#6-å®‰å…¨æœ€ä½³å®è·µ)
    - [6.1 è®¿é—®æ§åˆ¶](#61-è®¿é—®æ§åˆ¶)
    - [6.2 æ•°æ®ä¿æŠ¤](#62-æ•°æ®ä¿æŠ¤)
  - [7. ç›‘æ§ä¸å‘Šè­¦](#7-ç›‘æ§ä¸å‘Šè­¦)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£æä¾› Neon å¹³å°åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…é«˜æ•ˆã€å®‰å…¨ã€ç»æµåœ°ä½¿ç”¨æ•°æ®åº“åˆ†æ”¯åŠŸèƒ½ã€‚

### 1.2 é€‚ç”¨åœºæ™¯

- **å¼€å‘æµ‹è¯•ç¯å¢ƒ**: ä¸ºæ¯ä¸ªåŠŸèƒ½åˆ†æ”¯åˆ›å»ºç‹¬ç«‹æ•°æ®åº“
- **AI Agent å®éªŒ**: ä¸ºæ¯æ¬¡å®éªŒåˆ›å»ºç‹¬ç«‹åˆ†æ”¯
- **æ•°æ®ç‰ˆæœ¬ç®¡ç†**: ç®¡ç†æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬
- **A/B æµ‹è¯•**: ä¸ºä¸åŒæµ‹è¯•åˆ›å»ºç‹¬ç«‹ç¯å¢ƒ

---

## 2. åˆ†æ”¯å‘½åè§„èŒƒ

### 2.1 å‘½åè§„åˆ™

**åŸºæœ¬åŸåˆ™**:

- **æ¸…æ™°æ˜ç¡®**: åç§°èƒ½æ¸…æ¥šè¡¨è¾¾åˆ†æ”¯ç”¨é€”
- **æ˜“äºç®¡ç†**: ä¾¿äºæ‰¹é‡æ“ä½œå’Œæ¸…ç†
- **ç¬¦åˆè§„èŒƒ**: éµå¾ªå›¢é˜Ÿå‘½åçº¦å®š

**å‘½åæ ¼å¼**:

```text
{ç±»å‹}/{æ ‡è¯†ç¬¦}-{æè¿°}
```

**ç±»å‹å‰ç¼€**:

- `feature/`: åŠŸèƒ½å¼€å‘åˆ†æ”¯
- `experiment/`: å®éªŒåˆ†æ”¯
- `test/`: æµ‹è¯•åˆ†æ”¯
- `backup/`: å¤‡ä»½åˆ†æ”¯
- `staging/`: é¢„å‘å¸ƒåˆ†æ”¯

### 2.2 å‘½åç¤ºä¾‹

**åŠŸèƒ½å¼€å‘**:

```python
# æ¨è
feature/user-authentication
feature/payment-integration
feature/search-optimization

# ä¸æ¨è
branch1
test-db
my-branch
```

**å®éªŒåˆ†æ”¯**:

```python
# æ¨è
experiment/2025-11-01-rag-v2
experiment/embedding-model-comparison
experiment/2025-11-01-001

# ä¸æ¨è
exp1
test-experiment
```

**æµ‹è¯•åˆ†æ”¯**:

```python
# æ¨è
test/integration-tests
test/performance-tests
test/ci-pipeline-12345

# ä¸æ¨è
test1
testing
```

---

## 3. åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 3.1 åˆ›å»ºç­–ç•¥

**åˆ›å»ºæ—¶æœº**:

- âœ… å¼€å§‹æ–°åŠŸèƒ½å¼€å‘æ—¶
- âœ… è¿›è¡Œå®éªŒæ—¶
- âœ… éœ€è¦ç‹¬ç«‹æµ‹è¯•ç¯å¢ƒæ—¶
- âŒ é¿å…ä¸ºä¸´æ—¶æŸ¥è¯¢åˆ›å»ºåˆ†æ”¯

**åˆ›å»ºç¤ºä¾‹**:

```python
from neon import NeonClient
from datetime import datetime

neon = NeonClient(api_key=os.getenv("NEON_API_KEY"))

def create_feature_branch(feature_name):
    """åˆ›å»ºåŠŸèƒ½åˆ†æ”¯"""
    branch_name = f"feature/{feature_name}"

    branch = neon.branches.create(
        project_id="my-project",
        name=branch_name,
        parent_branch="main"
    )

    # è®°å½•åˆ†æ”¯ä¿¡æ¯
    log_branch_creation(branch.id, branch_name)

    return branch

def create_experiment_branch(experiment_id, description):
    """åˆ›å»ºå®éªŒåˆ†æ”¯"""
    timestamp = datetime.now().strftime("%Y-%m-%d")
    branch_name = f"experiment/{timestamp}-{experiment_id}-{description}"

    branch = neon.branches.create(
        project_id="my-project",
        name=branch_name,
        parent_branch="main"
    )

    return branch
```

### 3.2 ä½¿ç”¨ç­–ç•¥

**ä½¿ç”¨åŸåˆ™**:

- **å•ä¸€èŒè´£**: æ¯ä¸ªåˆ†æ”¯åªç”¨äºä¸€ä¸ªç›®çš„
- **åŠæ—¶æ¸…ç†**: ä½¿ç”¨å®ŒæˆååŠæ—¶åˆ é™¤
- **é¿å…é•¿æœŸåˆ†æ”¯**: é¿å…åˆ›å»ºé•¿æœŸå­˜åœ¨çš„åˆ†æ”¯

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# åœ¨ CI/CD ä¸­ä½¿ç”¨
def ci_test_pipeline():
    """CI æµ‹è¯•æµç¨‹"""
    # åˆ›å»ºæµ‹è¯•åˆ†æ”¯
    test_branch = neon.branches.create(
        project_id="my-project",
        name=f"test/ci-{os.getenv('CI_PIPELINE_ID')}",
        parent_branch="main"
    )

    try:
        # è¿è¡Œæµ‹è¯•
        run_tests(test_branch.connection_string)
    finally:
        # æ¸…ç†åˆ†æ”¯
        neon.branches.delete(
            project_id="my-project",
            branch_id=test_branch.id
        )
```

### 3.3 æ¸…ç†ç­–ç•¥

**æ¸…ç†è§„åˆ™**:

- **è‡ªåŠ¨æ¸…ç†**: è®¾ç½®è‡ªåŠ¨æ¸…ç†è§„åˆ™
- **å®šæœŸæ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸåˆ†æ”¯
- **æ‰‹åŠ¨æ¸…ç†**: åŠæ—¶æ¸…ç†ä¸å†ä½¿ç”¨çš„åˆ†æ”¯

**è‡ªåŠ¨æ¸…ç†å®ç°**:

```python
def cleanup_old_branches(project_id, older_than_days=7):
    """æ¸…ç†æ—§åˆ†æ”¯"""
    branches = neon.branches.list(project_id=project_id)
    cutoff_date = datetime.now() - timedelta(days=older_than_days)

    cleaned = []
    for branch in branches:
        # åªæ¸…ç†å®éªŒå’Œæµ‹è¯•åˆ†æ”¯
        if not (branch.name.startswith("experiment/") or
                branch.name.startswith("test/")):
            continue

        if branch.created_at < cutoff_date:
            neon.branches.delete(
                project_id=project_id,
                branch_id=branch.id
            )
            cleaned.append(branch.name)
            log_branch_deletion(branch.id, branch.name)

    return cleaned

# å®šæœŸæ‰§è¡Œæ¸…ç†
schedule.every().day.at("02:00").do(
    cleanup_old_branches,
    project_id="my-project",
    older_than_days=7
)
```

---

## 4. åˆ†æ”¯åˆå¹¶ç­–ç•¥

### 4.1 åˆå¹¶æµç¨‹

**åˆå¹¶æ­¥éª¤**:

1. **æ£€æŸ¥å†²çª**: æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å†²çª
2. **å¤‡ä»½ç›®æ ‡åˆ†æ”¯**: åˆå¹¶å‰å¤‡ä»½ç›®æ ‡åˆ†æ”¯
3. **æ‰§è¡Œåˆå¹¶**: æ‰§è¡Œåˆå¹¶æ“ä½œ
4. **éªŒè¯ç»“æœ**: éªŒè¯åˆå¹¶ç»“æœ
5. **æ¸…ç†æºåˆ†æ”¯**: åˆå¹¶æˆåŠŸåæ¸…ç†æºåˆ†æ”¯

**åˆå¹¶ç¤ºä¾‹**:

```python
def merge_feature_branch(feature_branch_id, target_branch="main"):
    """åˆå¹¶åŠŸèƒ½åˆ†æ”¯"""
    # 1. æ£€æŸ¥å†²çª
    conflicts = neon.branches.check_conflicts(
        project_id="my-project",
        source_branch_id=feature_branch_id,
        target_branch_id=target_branch
    )

    if conflicts:
        raise MergeConflictError(f"å­˜åœ¨å†²çª: {conflicts}")

    # 2. å¤‡ä»½ç›®æ ‡åˆ†æ”¯
    backup_branch = neon.branches.create(
        project_id="my-project",
        name=f"backup/{target_branch}-{datetime.now().strftime('%Y%m%d-%H%M%S')}",
        parent_branch=target_branch
    )

    try:
        # 3. æ‰§è¡Œåˆå¹¶
        merge_result = neon.branches.merge(
            project_id="my-project",
            source_branch_id=feature_branch_id,
            target_branch_id=target_branch
        )

        # 4. éªŒè¯ç»“æœ
        verify_merge_result(merge_result)

        # 5. æ¸…ç†æºåˆ†æ”¯
        neon.branches.delete(
            project_id="my-project",
            branch_id=feature_branch_id
        )

        return merge_result
    except Exception as e:
        # å›æ»šåˆ°å¤‡ä»½
        neon.branches.merge(
            project_id="my-project",
            source_branch_id=backup_branch.id,
            target_branch_id=target_branch
        )
        raise
```

### 4.2 å†²çªè§£å†³

**å†²çªç±»å‹**:

- **æ•°æ®å†²çª**: åŒä¸€è¡Œæ•°æ®åœ¨ä¸åŒåˆ†æ”¯è¢«ä¿®æ”¹
- **ç»“æ„å†²çª**: è¡¨ç»“æ„åœ¨ä¸åŒåˆ†æ”¯è¢«ä¿®æ”¹
- **çº¦æŸå†²çª**: è¿åå”¯ä¸€æ€§çº¦æŸç­‰

**å†²çªè§£å†³**:

```python
def resolve_conflicts(conflicts):
    """è§£å†³å†²çª"""
    resolutions = []

    for conflict in conflicts:
        if conflict['type'] == 'data':
            # æ•°æ®å†²çªï¼šä½¿ç”¨ç›®æ ‡åˆ†æ”¯çš„å€¼
            resolution = {
                'conflict_id': conflict['id'],
                'resolution': 'use_target',
                'reason': 'ä¿æŒä¸»åˆ†æ”¯æ•°æ®'
            }
        elif conflict['type'] == 'structure':
            # ç»“æ„å†²çªï¼šæ‰‹åŠ¨è§£å†³
            resolution = {
                'conflict_id': conflict['id'],
                'resolution': 'manual',
                'reason': 'éœ€è¦æ‰‹åŠ¨è§£å†³ç»“æ„å†²çª'
            }

        resolutions.append(resolution)

    return resolutions
```

---

## 5. æˆæœ¬ä¼˜åŒ–å®è·µ

### 5.1 åˆ†æ”¯æ•°é‡æ§åˆ¶

**æ§åˆ¶ç­–ç•¥**:

- **é™åˆ¶æ€»æ•°**: è®¾ç½®æœ€å¤§åˆ†æ”¯æ•°é‡
- **é™åˆ¶ç±»å‹**: é™åˆ¶æ¯ç§ç±»å‹çš„åˆ†æ”¯æ•°é‡
- **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥åˆ†æ”¯ä½¿ç”¨æƒ…å†µ

**å®ç°ç¤ºä¾‹**:

```python
def enforce_branch_limits(project_id):
    """å¼ºåˆ¶æ‰§è¡Œåˆ†æ”¯é™åˆ¶"""
    branches = neon.branches.list(project_id=project_id)

    # æŒ‰ç±»å‹ç»Ÿè®¡
    branch_counts = {
        'feature': 0,
        'experiment': 0,
        'test': 0,
        'total': len(branches)
    }

    for branch in branches:
        if branch.name.startswith("feature/"):
            branch_counts['feature'] += 1
        elif branch.name.startswith("experiment/"):
            branch_counts['experiment'] += 1
        elif branch.name.startswith("test/"):
            branch_counts['test'] += 1

    # æ£€æŸ¥é™åˆ¶
    limits = {
        'feature': 10,
        'experiment': 50,
        'test': 20,
        'total': 100
    }

    violations = []
    for branch_type, count in branch_counts.items():
        if count > limits[branch_type]:
            violations.append({
                'type': branch_type,
                'current': count,
                'limit': limits[branch_type]
            })

    if violations:
        raise BranchLimitExceededError(violations)

    return branch_counts
```

### 5.2 è‡ªåŠ¨æ¸…ç†æœºåˆ¶

**æ¸…ç†ç­–ç•¥**:

- **åŸºäºæ—¶é—´**: æ¸…ç†è¶…è¿‡ä¸€å®šæ—¶é—´çš„åˆ†æ”¯
- **åŸºäºä½¿ç”¨**: æ¸…ç†é•¿æ—¶é—´æœªä½¿ç”¨çš„åˆ†æ”¯
- **åŸºäºç±»å‹**: ä¸åŒç±»å‹ä½¿ç”¨ä¸åŒçš„æ¸…ç†ç­–ç•¥

**å®ç°ç¤ºä¾‹**:

```python
def auto_cleanup_branches(project_id):
    """è‡ªåŠ¨æ¸…ç†åˆ†æ”¯"""
    branches = neon.branches.list(project_id=project_id)
    now = datetime.now()

    cleanup_rules = {
        'experiment/': {
            'max_age_days': 7,
            'max_idle_days': 3
        },
        'test/': {
            'max_age_days': 3,
            'max_idle_days': 1
        },
        'feature/': {
            'max_age_days': 30,
            'max_idle_days': 14
        }
    }

    cleaned = []
    for branch in branches:
        # è·³è¿‡ä¸»åˆ†æ”¯
        if branch.name == 'main':
            continue

        # ç¡®å®šæ¸…ç†è§„åˆ™
        rule = None
        for prefix, r in cleanup_rules.items():
            if branch.name.startswith(prefix):
                rule = r
                break

        if not rule:
            continue

        # æ£€æŸ¥å¹´é¾„
        age_days = (now - branch.created_at).days
        if age_days > rule['max_age_days']:
            neon.branches.delete(project_id=project_id, branch_id=branch.id)
            cleaned.append({'branch': branch.name, 'reason': 'age'})
            continue

        # æ£€æŸ¥ç©ºé—²æ—¶é—´
        if hasattr(branch, 'last_accessed'):
            idle_days = (now - branch.last_accessed).days
            if idle_days > rule['max_idle_days']:
                neon.branches.delete(project_id=project_id, branch_id=branch.id)
                cleaned.append({'branch': branch.name, 'reason': 'idle'})

    return cleaned
```

---

## 6. å®‰å…¨æœ€ä½³å®è·µ

### 6.1 è®¿é—®æ§åˆ¶

**è®¿é—®ç­–ç•¥**:

- **æœ€å°æƒé™**: åªæˆäºˆå¿…è¦çš„è®¿é—®æƒé™
- **åˆ†æ”¯éš”ç¦»**: ä¸åŒåˆ†æ”¯ä½¿ç”¨ä¸åŒçš„è®¿é—®å‡­è¯
- **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥è®¿é—®æƒé™

**å®ç°ç¤ºä¾‹**:

```python
def create_branch_with_access_control(project_id, branch_name, user_permissions):
    """åˆ›å»ºå¸¦è®¿é—®æ§åˆ¶çš„åˆ†æ”¯"""
    # åˆ›å»ºåˆ†æ”¯
    branch = neon.branches.create(
        project_id=project_id,
        name=branch_name,
        parent_branch="main"
    )

    # åˆ›å»ºè®¿é—®ä»¤ç‰Œ
    access_token = neon.branches.create_access_token(
        project_id=project_id,
        branch_id=branch.id,
        permissions=user_permissions,
        expires_in=3600  # 1å°æ—¶è¿‡æœŸ
    )

    return branch, access_token
```

### 6.2 æ•°æ®ä¿æŠ¤

**ä¿æŠ¤æªæ–½**:

- **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **è®¿é—®æ—¥å¿—**: è®°å½•æ‰€æœ‰è®¿é—®æ—¥å¿—
- **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½é‡è¦åˆ†æ”¯

---

## 7. ç›‘æ§ä¸å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**:

- åˆ†æ”¯æ•°é‡
- åˆ†æ”¯åˆ›å»º/åˆ é™¤é¢‘ç‡
- åˆ†æ”¯ä½¿ç”¨æƒ…å†µ
- æˆæœ¬æ¶ˆè€—

**å‘Šè­¦è§„åˆ™**:

```python
def setup_branch_alerts(project_id):
    """è®¾ç½®åˆ†æ”¯å‘Šè­¦"""
    # åˆ†æ”¯æ•°é‡å‘Šè­¦
    if branch_count > 100:
        send_alert("åˆ†æ”¯æ•°é‡è¶…è¿‡é™åˆ¶")

    # æˆæœ¬å‘Šè­¦
    if monthly_cost > 1000:
        send_alert("æœˆåº¦æˆæœ¬è¶…è¿‡é¢„ç®—")

    # é•¿æœŸåˆ†æ”¯å‘Šè­¦
    old_branches = get_branches_older_than(30)
    if len(old_branches) > 10:
        send_alert("å­˜åœ¨è¿‡å¤šé•¿æœŸåˆ†æ”¯")
```

---

## 8. å‚è€ƒèµ„æ–™

- [Neon åˆ†æ”¯æ–‡æ¡£](https://neon.tech/docs/concepts/branching)
- [Git åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ](https://git-scm.com/book/en/v2/Git-Branching-Branching-Workflows)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
