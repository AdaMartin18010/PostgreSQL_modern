# æ··åˆæœç´¢é›†æˆ

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥  
> **æŠ€æœ¯ç‰ˆæœ¬**: Supabase v2.0+ / pgvector 0.7.0+  
> **æ–‡æ¡£ç¼–å·**: 03-03-03

## ğŸ“‘ ç›®å½•

- [æ··åˆæœç´¢é›†æˆ](#æ··åˆæœç´¢é›†æˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. é›†æˆæ–¹æ¡ˆ](#2-é›†æˆæ–¹æ¡ˆ)
    - [2.1 æ•°æ®åº“è®¾ç½®](#21-æ•°æ®åº“è®¾ç½®)
    - [2.2 æ··åˆæœç´¢å‡½æ•°](#22-æ··åˆæœç´¢å‡½æ•°)
  - [3. å®ç°ç¤ºä¾‹](#3-å®ç°ç¤ºä¾‹)
    - [3.1 JavaScript å®¢æˆ·ç«¯](#31-javascript-å®¢æˆ·ç«¯)
    - [3.2 Python å®¢æˆ·ç«¯](#32-python-å®¢æˆ·ç«¯)
  - [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
    - [4.1 ç´¢å¼•ä¼˜åŒ–](#41-ç´¢å¼•ä¼˜åŒ–)
    - [4.2 æŸ¥è¯¢ä¼˜åŒ–](#42-æŸ¥è¯¢ä¼˜åŒ–)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

Supabase é›†æˆ pgvector å’Œå…¨æ–‡æœç´¢ï¼Œæä¾›å¼€ç®±å³ç”¨çš„æ··åˆæœç´¢èƒ½åŠ›ã€‚

---

## 2. é›†æˆæ–¹æ¡ˆ

### 2.1 æ•°æ®åº“è®¾ç½®

```sql
-- å¯ç”¨ pgvector æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºå‘é‡è¡¨
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(768),
    metadata JSONB
);

-- åˆ›å»ºå‘é‡ç´¢å¼•
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops);

-- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX ON documents
USING GIN (to_tsvector('english', content));
```

### 2.2 æ··åˆæœç´¢å‡½æ•°

```sql
-- åˆ›å»ºæ··åˆæœç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION hybrid_search(
    query_vector vector(768),
    query_text TEXT,
    match_threshold FLOAT DEFAULT 0.8,
    match_count INT DEFAULT 10
)
RETURNS TABLE (
    id BIGINT,
    content TEXT,
    similarity FLOAT,
    rank FLOAT,
    rrf_score FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    WITH vector_search AS (
        SELECT
            id,
            content,
            1 - (embedding <=> query_vector) as similarity,
            ROW_NUMBER() OVER (ORDER BY embedding <=> query_vector) as rank
        FROM documents
        WHERE embedding <=> query_vector < (1 - match_threshold)
        LIMIT match_count * 2
    ),
    fulltext_search AS (
        SELECT
            id,
            content,
            ts_rank(to_tsvector('english', content),
                   plainto_tsquery('english', query_text)) as rank
        FROM documents
        WHERE to_tsvector('english', content) @@ plainto_tsquery('english', query_text)
        LIMIT match_count * 2
    ),
    combined AS (
        SELECT
            COALESCE(v.id, f.id) as id,
            COALESCE(v.content, f.content) as content,
            COALESCE(v.similarity, 0) as similarity,
            COALESCE(f.rank, 0) as rank,
            (1.0 / (60 + COALESCE(v.rank, 100))) +
            (1.0 / (60 + COALESCE(f.rank, 100))) as rrf_score
        FROM vector_search v
        FULL OUTER JOIN fulltext_search f ON v.id = f.id
    )
    SELECT
        combined.id,
        combined.content,
        combined.similarity,
        combined.rank,
        combined.rrf_score
    FROM combined
    ORDER BY combined.rrf_score DESC
    LIMIT match_count;
END;
$$;
```

---

## 3. å®ç°ç¤ºä¾‹

### 3.1 JavaScript å®¢æˆ·ç«¯

```javascript
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ç”ŸæˆæŸ¥è¯¢å‘é‡
const queryEmbedding = await generateEmbedding("search query");

// æ‰§è¡Œæ··åˆæœç´¢
const { data, error } = await supabase.rpc("hybrid_search", {
  query_vector: queryEmbedding,
  query_text: "search query",
  match_threshold: 0.8,
  match_count: 10
});

console.log("Search results:", data);
```

### 3.2 Python å®¢æˆ·ç«¯

```python
from supabase import create_client
import numpy as np

supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# ç”ŸæˆæŸ¥è¯¢å‘é‡
query_embedding = generate_embedding('search query')

# æ‰§è¡Œæ··åˆæœç´¢
results = supabase.rpc('hybrid_search', {
    'query_vector': query_embedding.tolist(),
    'query_text': 'search query',
    'match_threshold': 0.8,
    'match_count': 10
}).execute()

print('Search results:', results.data)
```

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¼˜åŒ–å‘é‡ç´¢å¼•å‚æ•°
CREATE INDEX ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;

-- ä¼˜åŒ–æŸ¥è¯¢å‚æ•°
SET enable_seqscan = off;
```

---

## 5. æœ€ä½³å®è·µ

1. **ç´¢å¼•é€‰æ‹©**: æ ¹æ®æ•°æ®è§„æ¨¡é€‰æ‹©åˆé€‚çš„ç´¢å¼•å‚æ•°
1. **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æŸ¥è¯¢é˜ˆå€¼å’Œæ•°é‡
1. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœ

---

## 6. å‚è€ƒèµ„æ–™

- [Supabase æ¶æ„è®¾è®¡](./Supabaseæ¶æ„è®¾è®¡.md)
- [å®æ—¶åŠŸèƒ½åº”ç”¨](./å®æ—¶åŠŸèƒ½åº”ç”¨.md)
- [æ··åˆæœç´¢ RRF ç®—æ³•](../../01-å‘é‡ä¸æ··åˆæœç´¢/æŠ€æœ¯åŸç†/æ··åˆæœç´¢RRFç®—æ³•.md)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥  
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
