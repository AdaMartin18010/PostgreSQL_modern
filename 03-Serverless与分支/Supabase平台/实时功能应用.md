# 实时功能应用

> **更新时间**: 2025 年 11 月 1 日  
> **技术版本**: Supabase v2.0+  
> **文档编号**: 03-03-02

## 📑 目录

- [实时功能应用](#实时功能应用)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
  - [2. 实时功能原理](#2-实时功能原理)
  - [3. 应用场景](#3-应用场景)
    - [3.1 协作编辑](#31-协作编辑)
    - [3.2 实时通知](#32-实时通知)
    - [3.3 实时仪表盘](#33-实时仪表盘)
  - [4. 实现示例](#4-实现示例)
  - [5. 性能优化](#5-性能优化)
    - [5.1 订阅优化](#51-订阅优化)
    - [5.2 消息处理](#52-消息处理)
  - [6. 最佳实践](#6-最佳实践)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

Supabase 实时功能基于 PostgreSQL 逻辑复制，提供毫秒级的数据变更推送能力。

---

## 2. 实时功能原理

**架构设计**:

```text
PostgreSQL 数据变更
    │
    ▼
逻辑复制 (Logical Replication)
    │
    ▼
Realtime Engine (Elixir)
    │
    ▼
WebSocket 推送
    │
    ▼
客户端应用
```

---

## 3. 应用场景

### 3.1 协作编辑

**场景**: 多人协作编辑文档

```javascript
// 订阅文档变更
const subscription = supabase
  .channel("document:123")
  .on(
    "postgres_changes",
    { event: "UPDATE", schema: "public", table: "documents", filter: "id=eq.123" },
    (payload) => {
      updateEditor(payload.new);
    }
  )
  .subscribe();
```

### 3.2 实时通知

**场景**: 实时推送通知

```javascript
// 订阅通知表
const subscription = supabase
  .channel("notifications")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "notifications", filter: `user_id=eq.${userId}` },
    (payload) => {
      showNotification(payload.new);
    }
  )
  .subscribe();
```

### 3.3 实时仪表盘

**场景**: 实时数据可视化

```javascript
// 订阅指标表
const subscription = supabase
  .channel("metrics")
  .on("postgres_changes", { event: "*", schema: "public", table: "metrics" }, (payload) => {
    updateDashboard(payload);
  })
  .subscribe();
```

---

## 4. 实现示例

**完整示例**:

```javascript
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// 创建频道
const channel = supabase.channel("room:1");

// 订阅变更
channel
  .on(
    "postgres_changes",
    {
      event: "INSERT",
      schema: "public",
      table: "messages",
      filter: "room_id=eq.1"
    },
    (payload) => {
      console.log("New message:", payload.new);
    }
  )
  .on(
    "postgres_changes",
    {
      event: "UPDATE",
      schema: "public",
      table: "messages"
    },
    (payload) => {
      console.log("Updated message:", payload.new);
    }
  )
  .on(
    "postgres_changes",
    {
      event: "DELETE",
      schema: "public",
      table: "messages"
    },
    (payload) => {
      console.log("Deleted message:", payload.old);
    }
  )
  .subscribe((status) => {
    if (status === "SUBSCRIBED") {
      console.log("Subscribed to changes");
    }
  });
```

---

## 5. 性能优化

### 5.1 订阅优化

1. **精确过滤**: 使用 filter 减少不必要的数据传输
2. **事件选择**: 只订阅需要的事件类型
3. **连接复用**: 复用 WebSocket 连接

### 5.2 消息处理

1. **批量处理**: 批量处理多个变更
2. **防抖节流**: 使用防抖和节流优化更新频率
3. **错误重试**: 实现自动重连机制

---

## 6. 最佳实践

1. **订阅管理**: 及时取消不需要的订阅
2. **错误处理**: 实现完善的错误处理机制
3. **性能监控**: 监控实时功能的性能指标

---

## 7. 参考资料

- [Supabase 架构设计](./Supabase架构设计.md)
- [混合搜索集成](./混合搜索集成.md)

---

**最后更新**: 2025 年 11 月 1 日  
**维护者**: PostgreSQL Modern Team
