# PostgreSQL çº¦æŸç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-34

## ğŸ“‘ ç›®å½•

- [PostgreSQL çº¦æŸç®¡ç†](#postgresql-çº¦æŸç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**çº¦æŸç®¡ç†çš„ä»·å€¼**:

PostgreSQL çº¦æŸæä¾›äº†æ•°æ®å®Œæ•´æ€§ä¿éšœï¼š

1. **æ•°æ®å®Œæ•´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
2. **ä¸šåŠ¡è§„åˆ™**: å®ç°ä¸šåŠ¡è§„åˆ™
3. **æ•°æ®è´¨é‡**: æå‡æ•°æ®è´¨é‡
4. **é”™è¯¯é¢„é˜²**: é¢„é˜²æ•°æ®é”™è¯¯

**åº”ç”¨åœºæ™¯**:

- **ä¸»é”®çº¦æŸ**: ä¿è¯ä¸»é”®å”¯ä¸€
- **å¤–é”®çº¦æŸ**: ä¿è¯å¼•ç”¨å®Œæ•´æ€§
- **å”¯ä¸€çº¦æŸ**: ä¿è¯å”¯ä¸€æ€§
- **æ£€æŸ¥çº¦æŸ**: ä¿è¯æ•°æ®æœ‰æ•ˆæ€§

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®å®Œæ•´æ€§** | ä¿è¯æ•°æ®å®Œæ•´æ€§ | **100%** |
| **é”™è¯¯å‡å°‘** | å‡å°‘æ•°æ®é”™è¯¯ | **-80%** |
| **å¼€å‘æ•ˆç‡** | ç®€åŒ–å¼€å‘ | **+40%** |
| **ç»´æŠ¤æˆæœ¬** | é™ä½ç»´æŠ¤æˆæœ¬ | **-50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®å®Œæ•´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œ100% å¯é 
- **é”™è¯¯å‡å°‘**: å‡å°‘æ•°æ®é”™è¯¯ 80%
- **å¼€å‘æ•ˆç‡**: ç®€åŒ–å¼€å‘ï¼Œæå‡æ•ˆç‡ 40%
- **ç»´æŠ¤æˆæœ¬**: é™ä½ç»´æŠ¤æˆæœ¬ 50%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡çº¦æŸçš„ç±»å‹å’Œåˆ›å»º
- ç†è§£çº¦æŸçš„ç®¡ç†å’Œä¿®æ”¹
- å­¦ä¼šçº¦æŸä¼˜åŒ–
- æŒæ¡å®é™…åº”ç”¨åœºæ™¯

## 2. çº¦æŸç±»å‹

### 2.1 ä¸»é”®çº¦æŸ

**ä¸»é”®çº¦æŸ**:

```sql
-- åˆ›å»ºè¡¨æ—¶å®šä¹‰ä¸»é”®
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT UNIQUE
);

-- æ·»åŠ ä¸»é”®çº¦æŸ
ALTER TABLE users ADD PRIMARY KEY (id);

-- åˆ é™¤ä¸»é”®çº¦æŸ
ALTER TABLE users DROP CONSTRAINT users_pkey;
```

### 2.2 å¤–é”®çº¦æŸ

**å¤–é”®çº¦æŸ**:

```sql
-- åˆ›å»ºå¤–é”®çº¦æŸ
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total_amount DECIMAL(10, 2)
);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE orders
ADD CONSTRAINT fk_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;

-- åˆ é™¤å¤–é”®çº¦æŸ
ALTER TABLE orders DROP CONSTRAINT fk_user;
```

### 2.3 å”¯ä¸€çº¦æŸ

**å”¯ä¸€çº¦æŸ**:

```sql
-- åˆ›å»ºå”¯ä¸€çº¦æŸ
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email TEXT UNIQUE,
    username TEXT UNIQUE
);

-- æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE users ADD CONSTRAINT unique_email UNIQUE (email);

-- åˆ é™¤å”¯ä¸€çº¦æŸ
ALTER TABLE users DROP CONSTRAINT unique_email;
```

### 2.4 æ£€æŸ¥çº¦æŸ

**æ£€æŸ¥çº¦æŸ**:

```sql
-- åˆ›å»ºæ£€æŸ¥çº¦æŸ
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    price DECIMAL(10, 2) CHECK (price > 0),
    stock INTEGER CHECK (stock >= 0)
);

-- æ·»åŠ æ£€æŸ¥çº¦æŸ
ALTER TABLE products
ADD CONSTRAINT check_price
CHECK (price > 0);

-- åˆ é™¤æ£€æŸ¥çº¦æŸ
ALTER TABLE products DROP CONSTRAINT check_price;
```

### 2.5 éç©ºçº¦æŸ

**éç©ºçº¦æŸ**:

```sql
-- åˆ›å»ºéç©ºçº¦æŸ
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT NOT NULL
);

-- æ·»åŠ éç©ºçº¦æŸ
ALTER TABLE users ALTER COLUMN name SET NOT NULL;

-- åˆ é™¤éç©ºçº¦æŸ
ALTER TABLE users ALTER COLUMN name DROP NOT NULL;
```

## 3. çº¦æŸç®¡ç†

### 3.1 æŸ¥çœ‹çº¦æŸ

**æŸ¥çœ‹çº¦æŸ**:

```sql
-- æŸ¥çœ‹è¡¨çš„æ‰€æœ‰çº¦æŸ
SELECT
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'users'::regclass;

-- æŸ¥çœ‹å¤–é”®çº¦æŸ
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_name = 'orders';
```

### 3.2 çº¦æŸä¿®æ”¹

**çº¦æŸä¿®æ”¹**:

```sql
-- ç¦ç”¨çº¦æŸï¼ˆä»…ç”¨äºæ£€æŸ¥çº¦æŸï¼‰
ALTER TABLE products
ALTER CONSTRAINT check_price
NOT DEFERRABLE INITIALLY IMMEDIATE;

-- å¯ç”¨çº¦æŸ
ALTER TABLE products
ALTER CONSTRAINT check_price
DEFERRABLE INITIALLY DEFERRED;
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: æ•°æ®å®Œæ•´æ€§ä¿éšœï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸåº”ç”¨éœ€è¦ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®é”™è¯¯ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ•°æ®é”™è¯¯**: æ•°æ®é”™è¯¯å¤š
2. **å®Œæ•´æ€§**: æ•°æ®å®Œæ•´æ€§å·®
3. **ç»´æŠ¤æˆæœ¬**: ç»´æŠ¤æˆæœ¬é«˜

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. åˆ›å»ºå¸¦çº¦æŸçš„è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    order_number TEXT UNIQUE NOT NULL,
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL CHECK (total_amount > 0),
    status TEXT NOT NULL CHECK (status IN ('pending', 'paid', 'shipped', 'completed')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);

-- 2. æ·»åŠ ç´¢å¼•æ”¯æŒçº¦æŸ
CREATE INDEX idx_orders_user_id ON orders (user_id);
CREATE INDEX idx_orders_status ON orders (status);

-- 3. éªŒè¯çº¦æŸ
INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD001', 1, 100.00, 'pending'); -- æˆåŠŸ

INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD001', 1, 100.00, 'pending'); -- å¤±è´¥ï¼šè¿åå”¯ä¸€çº¦æŸ

INSERT INTO orders (order_number, user_id, total_amount, status)
VALUES ('ORD002', 1, -100.00, 'pending'); -- å¤±è´¥ï¼šè¿åæ£€æŸ¥çº¦æŸ
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **æ•°æ®é”™è¯¯** | åŸºå‡† | **-80%** | **é™ä½** |
| **æ•°æ®å®Œæ•´æ€§** | 85% | **100%** | **18%** â¬†ï¸ |
| **å¼€å‘æ•ˆç‡** | åŸºå‡† | **+40%** | **æå‡** |
| **ç»´æŠ¤æˆæœ¬** | åŸºå‡† | **-50%** | **é™ä½** |

## 5. æœ€ä½³å®è·µ

### 5.1 çº¦æŸè®¾è®¡

1. **åˆç†ä½¿ç”¨**: åˆç†ä½¿ç”¨å„ç§çº¦æŸ
2. **æ€§èƒ½è€ƒè™‘**: è€ƒè™‘çº¦æŸå¯¹æ€§èƒ½çš„å½±å“
3. **å‘½åè§„èŒƒ**: ä½¿ç”¨æ¸…æ™°çš„çº¦æŸå‘½å

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•**: ä¸ºçº¦æŸåˆ—åˆ›å»ºç´¢å¼•
2. **å¤–é”®**: åˆç†ä½¿ç”¨å¤–é”®çº¦æŸ
3. **æ£€æŸ¥**: æ£€æŸ¥çº¦æŸè¦ç®€å•é«˜æ•ˆ

## 6. å‚è€ƒèµ„æ–™

- [æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ](./æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ.md)
- [ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–](./ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ–.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - çº¦æŸ](https://www.postgresql.org/docs/current/ddl-constraints.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-34
