# PostgreSQL æ€§èƒ½è°ƒä¼˜æ·±å…¥

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-12

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ€§èƒ½è°ƒä¼˜æ·±å…¥](#postgresql-æ€§èƒ½è°ƒä¼˜æ·±å…¥)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. é…ç½®å‚æ•°è°ƒä¼˜](#1-é…ç½®å‚æ•°è°ƒä¼˜)
  - [2. æŸ¥è¯¢è®¡åˆ’åˆ†æ](#2-æŸ¥è¯¢è®¡åˆ’åˆ†æ)
  - [3. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†](#3-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†)
  - [4. è¿æ¥æ± ä¼˜åŒ–](#4-è¿æ¥æ± ä¼˜åŒ–)
  - [5. å®è·µç»ƒä¹ ](#5-å®è·µç»ƒä¹ )
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. é…ç½®å‚æ•°è°ƒä¼˜

### 1.1 å†…å­˜é…ç½®

```sql
-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW shared_buffers;
SHOW work_mem;
SHOW maintenance_work_mem;
SHOW effective_cache_size;

-- æ¨èé…ç½®ï¼ˆ8GB RAM æœåŠ¡å™¨ï¼‰
-- shared_buffers = 2GB          # 25% of RAM
-- work_mem = 16MB                # ç”¨äºæ’åºå’Œå“ˆå¸Œæ“ä½œ
-- maintenance_work_mem = 512MB   # ç”¨äº VACUUMã€CREATE INDEX
-- effective_cache_size = 6GB    # æ“ä½œç³»ç»Ÿå’Œ PostgreSQL ç¼“å­˜æ€»å’Œ
```

### 1.2 æ£€æŸ¥ç‚¹é…ç½®

```sql
-- æ£€æŸ¥ç‚¹é…ç½®
-- checkpoint_timeout = 15min     # æ£€æŸ¥ç‚¹é—´éš”
-- max_wal_size = 1GB             # WAL æœ€å¤§å¤§å°
-- min_wal_size = 80MB            # WAL æœ€å°å¤§å°
-- checkpoint_completion_target = 0.9  # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
```

### 1.3 æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®

```sql
-- æŸ¥è¯¢ä¼˜åŒ–å™¨é…ç½®
-- random_page_cost = 1.1         # SSD æ¨èå€¼ï¼ˆHDD ä¸º 4.0ï¼‰
-- effective_io_concurrency = 200 # SSD æ¨èå€¼
-- default_statistics_target = 100 # ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
```

## 2. æŸ¥è¯¢è®¡åˆ’åˆ†æ

### 2.1 EXPLAIN è¯¦è§£

```sql
-- åŸºæœ¬ EXPLAIN
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN ANALYZEï¼ˆå®é™…æ‰§è¡Œï¼‰
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN VERBOSEï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
EXPLAIN VERBOSE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN BUFFERSï¼ˆç¼“å†²åŒºä½¿ç”¨ï¼‰
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN FORMAT JSONï¼ˆJSON æ ¼å¼ï¼‰
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON)
SELECT * FROM users WHERE email = 'john@example.com';
```

### 2.2 ç†è§£æ‰§è¡Œè®¡åˆ’

**å¸¸è§æ“ä½œç±»å‹**:

- **Seq Scan**: é¡ºåºæ‰«æï¼ˆå…¨è¡¨æ‰«æï¼‰
- **Index Scan**: ç´¢å¼•æ‰«æ
- **Index Only Scan**: ä»…ç´¢å¼•æ‰«æï¼ˆæœ€å¿«ï¼‰
- **Bitmap Index Scan**: ä½å›¾ç´¢å¼•æ‰«æ
- **Nested Loop**: åµŒå¥—å¾ªç¯è¿æ¥
- **Hash Join**: å“ˆå¸Œè¿æ¥
- **Merge Join**: å½’å¹¶è¿æ¥

### 2.3 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / 1000 / 60) AS total_minutes
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- å¹³å‡æ‰§è¡Œæ—¶é—´ > 100ms
ORDER BY mean_exec_time DESC
LIMIT 20;

-- é‡ç½®ç»Ÿè®¡ä¿¡æ¯
SELECT pg_stat_statements_reset();
```

## 3. ç»Ÿè®¡ä¿¡æ¯ç®¡ç†

### 3.1 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```sql
-- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;

-- æ›´æ–°æ‰€æœ‰è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- æ›´æ–°ç‰¹å®šåˆ—ç»Ÿè®¡ä¿¡æ¯
ANALYZE users (email, name);

-- è®¾ç½®ç»Ÿè®¡ä¿¡æ¯ç›®æ ‡
ALTER TABLE users ALTER COLUMN email SET STATISTICS 500;
ANALYZE users;
```

### 3.2 æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename = 'users';

-- æŸ¥çœ‹åˆ—ç»Ÿè®¡ä¿¡æ¯
SELECT
    attname,
    n_distinct,
    correlation,
    most_common_vals
FROM pg_stats
WHERE tablename = 'users' AND attname = 'email';
```

## 4. è¿æ¥æ± ä¼˜åŒ–

### 4.1 è¿æ¥æ•°é…ç½®

```sql
-- æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°
SHOW max_connections;

-- æ¨èé…ç½®
-- max_connections = 100          # æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´
-- superuser_reserved_connections = 3
```

### 4.2 ä½¿ç”¨è¿æ¥æ± 

**PgBouncer é…ç½®ç¤ºä¾‹**:

```ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 5
```

**PgBouncer æ¨¡å¼**:

- **session**: ä¼šè¯æ¨¡å¼ï¼ˆæœ€å®‰å…¨ï¼Œä½†è¿æ¥æ—¶é—´é•¿ï¼‰
- **transaction**: äº‹åŠ¡æ¨¡å¼ï¼ˆæ¨èï¼Œè¿æ¥æ—¶é—´çŸ­ï¼‰
- **statement**: è¯­å¥æ¨¡å¼ï¼ˆæœ€å¿«ï¼Œä½†é™åˆ¶å¤šï¼‰

## 5. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ†ææ…¢æŸ¥è¯¢

```sql
-- ä»»åŠ¡: åˆ†æå¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢
-- 1. å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 2. è¿è¡ŒæŸ¥è¯¢
SELECT u.name, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;

-- 3. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN ANALYZE
SELECT u.name, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;

-- 4. åˆ›å»ºç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- 5. å†æ¬¡æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å¯¹æ¯”
```

### ç»ƒä¹  2: é…ç½®ä¼˜åŒ–

```sql
-- ä»»åŠ¡: æ ¹æ®æœåŠ¡å™¨é…ç½®ä¼˜åŒ– PostgreSQL
-- 1. æŸ¥çœ‹å½“å‰é…ç½®
SHOW shared_buffers;
SHOW work_mem;
SHOW effective_cache_size;

-- 2. è®¡ç®—æ¨èå€¼ï¼ˆå‡è®¾ 16GB RAMï¼‰
-- shared_buffers = 4GB
-- work_mem = 32MB
-- effective_cache_size = 12GB

-- 3. ä¿®æ”¹é…ç½®ï¼ˆéœ€è¦é‡å¯ï¼‰
-- ç¼–è¾‘ postgresql.conf
-- shared_buffers = 4GB
-- work_mem = 32MB
-- effective_cache_size = 12GB
```

## 6. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æç¤º](https://www.postgresql.org/docs/current/performance-tips.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é…ç½®](https://www.postgresql.org/docs/current/runtime-config.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-12
