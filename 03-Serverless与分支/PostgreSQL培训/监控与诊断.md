# PostgreSQL ç›‘æ§ä¸è¯Šæ–­

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-13

## ğŸ“‘ ç›®å½•

- [PostgreSQL ç›‘æ§ä¸è¯Šæ–­](#postgresql-ç›‘æ§ä¸è¯Šæ–­)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. ç³»ç»Ÿç›‘æ§](#1-ç³»ç»Ÿç›‘æ§)
  - [2. æ•°æ®åº“ç›‘æ§](#2-æ•°æ®åº“ç›‘æ§)
  - [3. é”ç›‘æ§](#3-é”ç›‘æ§)
  - [4. æ—¥å¿—åˆ†æ](#4-æ—¥å¿—åˆ†æ)
  - [5. å®è·µç»ƒä¹ ](#5-å®è·µç»ƒä¹ )
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. ç³»ç»Ÿç›‘æ§

### 1.1 æ•°æ®åº“æ´»åŠ¨ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    query
FROM pg_stat_activity
WHERE datname = current_database();

-- æŸ¥çœ‹é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT
    pid,
    now() - pg_stat_activity.query_start AS duration,
    query,
    state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes'
AND state != 'idle';
```

### 1.2 æ•°æ®åº“å¤§å°ç›‘æ§

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) -
                   pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 1.3 è¡¨ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    n_mod_since_analyze,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze,
    vacuum_count,
    autovacuum_count,
    analyze_count,
    autoanalyze_count
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;
```

## 2. æ•°æ®åº“ç›‘æ§

### 2.1 ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 2.2 æ…¢æŸ¥è¯¢ç›‘æ§

```sql
-- ä½¿ç”¨ pg_stat_statements ç›‘æ§æ…¢æŸ¥è¯¢
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    LEFT(query, 100) AS query_preview,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    stddev_exec_time,
    (100 * total_exec_time / SUM(total_exec_time) OVER ()) AS percent_total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 3. é”ç›‘æ§

### 3.1 æŸ¥çœ‹å½“å‰é”

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    pg_blocking_pids(pid) AS blocked_by
FROM pg_locks
WHERE relation IS NOT NULL;

-- æŸ¥çœ‹é˜»å¡çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.2 ç»ˆæ­¢é˜»å¡æŸ¥è¯¢

```sql
-- æŸ¥çœ‹é˜»å¡æŸ¥è¯¢çš„ PID
SELECT pid, query FROM pg_stat_activity WHERE state = 'active';

-- ç»ˆæ­¢æŸ¥è¯¢
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;

-- å–æ¶ˆæŸ¥è¯¢ï¼ˆæ›´æ¸©å’Œï¼‰
SELECT pg_cancel_backend(pid) FROM pg_stat_activity
WHERE pid = <blocking_pid>;
```

## 4. æ—¥å¿—åˆ†æ

### 4.1 æ—¥å¿—é…ç½®

```sql
-- æŸ¥çœ‹æ—¥å¿—é…ç½®
SHOW log_destination;
SHOW logging_collector;
SHOW log_directory;
SHOW log_filename;
SHOW log_min_duration_statement;

-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
-- log_min_duration_statement = 1000  # è®°å½•æ‰§è¡Œæ—¶é—´ > 1ç§’çš„æŸ¥è¯¢
```

### 4.2 æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep ERROR

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log | grep "duration:"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep ERROR /var/log/postgresql/postgresql-*.log | \
    awk '{print $NF}' | sort | uniq -c | sort -rn
```

## 5. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å¥åº·æ£€æŸ¥æŸ¥è¯¢
SELECT
    'Database Size' AS metric,
    pg_size_pretty(pg_database_size(current_database())) AS value
UNION ALL
SELECT
    'Active Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'active'
UNION ALL
SELECT
    'Idle Connections',
    COUNT(*)::TEXT
FROM pg_stat_activity
WHERE state = 'idle'
UNION ALL
SELECT
    'Dead Tuples',
    SUM(n_dead_tup)::TEXT
FROM pg_stat_user_tables
UNION ALL
SELECT
    'Unused Indexes',
    COUNT(*)::TEXT
FROM pg_stat_user_indexes
WHERE idx_scan = 0;
```

### ç»ƒä¹  2: åˆ›å»ºç›‘æ§è§†å›¾

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªç›‘æ§è§†å›¾
CREATE VIEW database_health AS
SELECT
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active') AS active_connections,
    (SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'idle') AS idle_connections,
    (SELECT SUM(n_dead_tup) FROM pg_stat_user_tables) AS total_dead_tuples,
    (SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0) AS unused_indexes,
    (SELECT pg_size_pretty(pg_database_size(current_database()))) AS database_size;

-- æŸ¥è¯¢ç›‘æ§è§†å›¾
SELECT * FROM database_health;
```

## 6. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç›‘æ§](https://www.postgresql.org/docs/current/monitoring.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç»Ÿè®¡ä¿¡æ¯è§†å›¾](https://www.postgresql.org/docs/current/monitoring-stats.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-13
