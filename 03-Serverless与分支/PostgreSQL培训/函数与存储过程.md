# PostgreSQL 函数与存储过程

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+
> **文档编号**: 03-03-05

## 📑 目录

- [PostgreSQL 函数与存储过程](#postgresql-函数与存储过程)
  - [📑 目录](#-目录)
  - [1. 概述](#1-概述)
    - [1.1 函数 vs 存储过程](#11-函数-vs-存储过程)
  - [2. 用户定义函数](#2-用户定义函数)
    - [2.1 基本函数](#21-基本函数)
    - [2.2 带默认参数的函数](#22-带默认参数的函数)
    - [2.3 返回表的函数](#23-返回表的函数)
    - [2.4 递归函数](#24-递归函数)
    - [2.5 函数特性](#25-函数特性)
  - [3. 存储过程](#3-存储过程)
    - [3.1 存储过程事务控制](#31-存储过程事务控制)
  - [4. 触发器](#4-触发器)
    - [4.1 基本触发器](#41-基本触发器)
    - [4.2 审计日志触发器](#42-审计日志触发器)
    - [4.3 触发器类型](#43-触发器类型)
    - [4.4 触发器条件](#44-触发器条件)
  - [5. 性能优化](#5-性能优化)
    - [5.1 函数性能优化](#51-函数性能优化)
  - [6. 实践练习](#6-实践练习)
    - [练习 1: 创建计算函数](#练习-1-创建计算函数)
  - [7. 参考资料](#7-参考资料)

---

## 1. 概述

### 1.1 函数 vs 存储过程

| 特性 | 函数 (Function) | 存储过程 (Procedure) |
|------|----------------|---------------------|
| 返回值 | 必须有返回值 | 可以没有返回值 |
| 事务控制 | 不能控制事务 | 可以控制事务 |
| 调用方式 | SELECT function() | CALL procedure() |
| 使用场景 | 计算、查询 | 复杂业务逻辑 |

## 2. 用户定义函数

### 2.1 基本函数

```sql
-- 创建函数
CREATE OR REPLACE FUNCTION calculate_total(price DECIMAL, quantity INTEGER)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price * quantity;
END;
$$ LANGUAGE plpgsql;

-- 使用函数
SELECT calculate_total(100, 5);
```

### 2.2 带默认参数的函数

```sql
CREATE OR REPLACE FUNCTION greet(name TEXT, greeting TEXT DEFAULT 'Hello')
RETURNS TEXT AS $$
BEGIN
    RETURN greeting || ', ' || name || '!';
END;
$$ LANGUAGE plpgsql;

SELECT greet('John');  -- Hello, John!
SELECT greet('John', 'Hi');  -- Hi, John!
```

### 2.3 返回表的函数

```sql
CREATE OR REPLACE FUNCTION get_users_by_age(min_age INTEGER, max_age INTEGER)
RETURNS TABLE(id INTEGER, name TEXT, age INTEGER) AS $$
BEGIN
    RETURN QUERY
    SELECT users.id, users.name, users.age
    FROM users
    WHERE users.age BETWEEN min_age AND max_age;
END;
$$ LANGUAGE plpgsql;

SELECT * FROM get_users_by_age(25, 35);
```

### 2.4 递归函数

```sql
-- 计算阶乘
CREATE OR REPLACE FUNCTION factorial(n INTEGER)
RETURNS INTEGER AS $$
BEGIN
    IF n <= 1 THEN
        RETURN 1;
    ELSE
        RETURN n * factorial(n - 1);
    END IF;
END;
$$ LANGUAGE plpgsql;

SELECT factorial(5);  -- 120
```

### 2.5 函数特性

**函数特性标记**:

```sql
-- IMMUTABLE: 函数结果只依赖于输入参数，不会改变数据库状态
CREATE OR REPLACE FUNCTION calculate_tax(price DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price * 0.1;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- STABLE: 函数结果在同一个事务中不变
CREATE OR REPLACE FUNCTION get_current_user_id()
RETURNS INTEGER AS $$
BEGIN
    RETURN current_setting('app.user_id')::INTEGER;
END;
$$ LANGUAGE plpgsql STABLE;

-- VOLATILE: 默认值，函数结果可能变化
CREATE OR REPLACE FUNCTION get_random_number()
RETURNS INTEGER AS $$
BEGIN
    RETURN floor(random() * 100)::INTEGER;
END;
$$ LANGUAGE plpgsql VOLATILE;
```

## 3. 存储过程

```sql
-- PostgreSQL 11+ 支持存储过程
CREATE OR REPLACE PROCEDURE transfer_money(
    from_account INTEGER,
    to_account INTEGER,
    amount DECIMAL
)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE accounts SET balance = balance - amount WHERE id = from_account;
    UPDATE accounts SET balance = balance + amount WHERE id = to_account;

    IF (SELECT balance FROM accounts WHERE id = from_account) < 0 THEN
        RAISE EXCEPTION 'Insufficient funds';
    END IF;
END;
$$;

-- 调用存储过程
CALL transfer_money(1, 2, 100);
```

### 3.1 存储过程事务控制

```sql
-- 存储过程可以控制事务
CREATE OR REPLACE PROCEDURE complex_operation()
LANGUAGE plpgsql
AS $$
BEGIN
    -- 第一个事务
    INSERT INTO table1 VALUES (1);
    COMMIT;

    -- 第二个事务
    BEGIN
        INSERT INTO table2 VALUES (2);
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END;
END;
$$;
```

## 4. 触发器

### 4.1 基本触发器

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();
```

### 4.2 审计日志触发器

```sql
CREATE OR REPLACE FUNCTION audit_log()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_logs (table_name, operation, old_data, new_data, changed_at)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        row_to_json(OLD),
        row_to_json(NEW),
        NOW()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_log();
```

### 4.3 触发器类型

**触发器类型**:

```sql
-- BEFORE 触发器（在操作前执行）
CREATE TRIGGER before_update_users
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION validate_user_data();

-- AFTER 触发器（在操作后执行）
CREATE TRIGGER after_insert_orders
AFTER INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION update_inventory();

-- INSTEAD OF 触发器（用于视图）
CREATE TRIGGER instead_of_insert_view
INSTEAD OF INSERT ON user_orders_view
FOR EACH ROW
EXECUTE FUNCTION handle_view_insert();
```

### 4.4 触发器条件

```sql
-- 条件触发器（只在满足条件时执行）
CREATE TRIGGER conditional_trigger
AFTER UPDATE ON orders
FOR EACH ROW
WHEN (OLD.status IS DISTINCT FROM NEW.status)
EXECUTE FUNCTION log_status_change();
```

## 5. 性能优化

### 5.1 函数性能优化

**优化技巧**:

1. **使用 IMMUTABLE/STABLE**: 标记函数特性，允许查询优化器优化
2. **避免重复计算**: 缓存计算结果
3. **使用 SQL 函数**: SQL 函数通常比 PL/pgSQL 函数快

**性能对比**:

```sql
-- SQL 函数（更快）
CREATE OR REPLACE FUNCTION calculate_total_sql(price DECIMAL, quantity INTEGER)
RETURNS DECIMAL AS $$
    SELECT price * quantity;
$$ LANGUAGE sql IMMUTABLE;

-- PL/pgSQL 函数（更灵活）
CREATE OR REPLACE FUNCTION calculate_total_plpgsql(price DECIMAL, quantity INTEGER)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price * quantity;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

## 6. 实践练习

### 练习 1: 创建计算函数

```sql
-- 任务: 创建一个函数计算订单总金额
CREATE OR REPLACE FUNCTION calculate_order_total(order_id INTEGER)
RETURNS DECIMAL AS $$
DECLARE
    total DECIMAL := 0;
BEGIN
    SELECT SUM(quantity * price) INTO total
    FROM order_items
    WHERE order_items.order_id = calculate_order_total.order_id;

    RETURN total;
END;
$$ LANGUAGE plpgsql;
```

## 7. 参考资料

- [PostgreSQL 官方文档 - 函数](https://www.postgresql.org/docs/current/xfunc.html)
- [PostgreSQL 官方文档 - 触发器](https://www.postgresql.org/docs/current/triggers.html)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 03-03-05
