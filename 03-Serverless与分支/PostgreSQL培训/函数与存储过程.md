# PostgreSQL 函数与存储过程

> **更新时间**: 2025 年 11 月 1 日
> **技术版本**: PostgreSQL 14+
> **文档编号**: 03-03-05

## 📑 目录

- [PostgreSQL 函数与存储过程](#postgresql-函数与存储过程)
  - [📑 目录](#-目录)
  - [1. 用户定义函数](#1-用户定义函数)
    - [1.1 基本函数](#11-基本函数)
    - [1.2 带默认参数的函数](#12-带默认参数的函数)
    - [1.3 返回表的函数](#13-返回表的函数)
    - [1.4 递归函数](#14-递归函数)
  - [2. 存储过程](#2-存储过程)
  - [3. 触发器](#3-触发器)
    - [3.1 基本触发器](#31-基本触发器)
    - [3.2 审计日志触发器](#32-审计日志触发器)
  - [4. 实践练习](#4-实践练习)
    - [练习 1: 创建计算函数](#练习-1-创建计算函数)
  - [5. 参考资料](#5-参考资料)

---

## 1. 用户定义函数

### 1.1 基本函数

```sql
-- 创建函数
CREATE OR REPLACE FUNCTION calculate_total(price DECIMAL, quantity INTEGER)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price * quantity;
END;
$$ LANGUAGE plpgsql;

-- 使用函数
SELECT calculate_total(100, 5);
```

### 1.2 带默认参数的函数

```sql
CREATE OR REPLACE FUNCTION greet(name TEXT, greeting TEXT DEFAULT 'Hello')
RETURNS TEXT AS $$
BEGIN
    RETURN greeting || ', ' || name || '!';
END;
$$ LANGUAGE plpgsql;

SELECT greet('John');  -- Hello, John!
SELECT greet('John', 'Hi');  -- Hi, John!
```

### 1.3 返回表的函数

```sql
CREATE OR REPLACE FUNCTION get_users_by_age(min_age INTEGER, max_age INTEGER)
RETURNS TABLE(id INTEGER, name TEXT, age INTEGER) AS $$
BEGIN
    RETURN QUERY
    SELECT users.id, users.name, users.age
    FROM users
    WHERE users.age BETWEEN min_age AND max_age;
END;
$$ LANGUAGE plpgsql;

SELECT * FROM get_users_by_age(25, 35);
```

### 1.4 递归函数

```sql
-- 计算阶乘
CREATE OR REPLACE FUNCTION factorial(n INTEGER)
RETURNS INTEGER AS $$
BEGIN
    IF n <= 1 THEN
        RETURN 1;
    ELSE
        RETURN n * factorial(n - 1);
    END IF;
END;
$$ LANGUAGE plpgsql;

SELECT factorial(5);  -- 120
```

## 2. 存储过程

```sql
-- PostgreSQL 11+ 支持存储过程
CREATE OR REPLACE PROCEDURE transfer_money(
    from_account INTEGER,
    to_account INTEGER,
    amount DECIMAL
)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE accounts SET balance = balance - amount WHERE id = from_account;
    UPDATE accounts SET balance = balance + amount WHERE id = to_account;

    IF (SELECT balance FROM accounts WHERE id = from_account) < 0 THEN
        RAISE EXCEPTION 'Insufficient funds';
    END IF;
END;
$$;

-- 调用存储过程
CALL transfer_money(1, 2, 100);
```

## 3. 触发器

### 3.1 基本触发器

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();
```

### 3.2 审计日志触发器

```sql
CREATE OR REPLACE FUNCTION audit_log()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_logs (table_name, operation, old_data, new_data, changed_at)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        row_to_json(OLD),
        row_to_json(NEW),
        NOW()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_log();
```

## 4. 实践练习

### 练习 1: 创建计算函数

```sql
-- 任务: 创建一个函数计算订单总金额
CREATE OR REPLACE FUNCTION calculate_order_total(order_id INTEGER)
RETURNS DECIMAL AS $$
DECLARE
    total DECIMAL := 0;
BEGIN
    SELECT SUM(quantity * price) INTO total
    FROM order_items
    WHERE order_items.order_id = calculate_order_total.order_id;

    RETURN total;
END;
$$ LANGUAGE plpgsql;
```

## 5. 参考资料

- [PostgreSQL 官方文档 - 函数](https://www.postgresql.org/docs/current/xfunc.html)
- [PostgreSQL 官方文档 - 触发器](https://www.postgresql.org/docs/current/triggers.html)

---

**最后更新**: 2025 年 11 月 1 日
**维护者**: PostgreSQL Modern Team
**文档编号**: 03-03-05
