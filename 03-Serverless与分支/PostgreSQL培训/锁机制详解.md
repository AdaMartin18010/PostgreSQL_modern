# PostgreSQL é”æœºåˆ¶è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-32

## ğŸ“‘ ç›®å½•

- [PostgreSQL é”æœºåˆ¶è¯¦è§£](#postgresql-é”æœºåˆ¶è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**é”æœºåˆ¶çš„ä»·å€¼**:

PostgreSQL é”æœºåˆ¶ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§å’Œå¹¶å‘æ§åˆ¶ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ•°æ®ä¸€è‡´æ€§
2. **å¹¶å‘æ§åˆ¶**: æ§åˆ¶å¹¶å‘è®¿é—®
3. **æ­»é”æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æ­»é”
4. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–é”çš„ä½¿ç”¨æå‡æ€§èƒ½

**åº”ç”¨åœºæ™¯**:

- **å¹¶å‘è®¿é—®**: å¤„ç†å¹¶å‘è®¿é—®
- **äº‹åŠ¡ç®¡ç†**: äº‹åŠ¡ä¸­çš„é”ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–é”çš„ä½¿ç”¨
- **æ­»é”å¤„ç†**: å¤„ç†æ­»é”é—®é¢˜

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ•°æ®ä¸€è‡´æ€§** | ä¿è¯æ•°æ®ä¸€è‡´æ€§ | **100%** |
| **å¹¶å‘æ€§èƒ½** | ä¼˜åŒ–é”æå‡æ€§èƒ½ | **+30-50%** |
| **æ­»é”æ£€æµ‹** | è‡ªåŠ¨æ£€æµ‹æ­»é” | **100%** |
| **é”ç­‰å¾…** | å‡å°‘é”ç­‰å¾…æ—¶é—´ | **-60%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œ100% å¯é 
- **å¹¶å‘æ€§èƒ½**: ä¼˜åŒ–é”çš„ä½¿ç”¨æå‡å¹¶å‘æ€§èƒ½ 30-50%
- **æ­»é”æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œ100% æ£€æµ‹ç‡
- **é”ç­‰å¾…**: å‡å°‘é”ç­‰å¾…æ—¶é—´ 60%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡é”çš„ç±»å‹å’Œç‰¹æ€§
- ç†è§£é”çš„å…¼å®¹æ€§
- å­¦ä¼šé”ç›‘æ§å’Œè¯Šæ–­
- æŒæ¡æ­»é”å¤„ç†

## 2. é”ç±»å‹

### 2.1 è¡¨çº§é”

**è¡¨çº§é”ç±»å‹**:

```sql
-- æŸ¥çœ‹é”ä¿¡æ¯
SELECT
    locktype,
    relation::regclass,
    mode,
    granted
FROM pg_locks
WHERE relation = 'users'::regclass;

-- å¸¸è§è¡¨çº§é”
-- ACCESS SHARE: SELECT æŸ¥è¯¢
-- ROW SHARE: SELECT FOR UPDATE
-- ROW EXCLUSIVE: INSERT, UPDATE, DELETE
-- SHARE UPDATE EXCLUSIVE: VACUUM, CREATE INDEX CONCURRENTLY
-- SHARE: CREATE INDEX
-- SHARE ROW EXCLUSIVE: CREATE TRIGGER
-- EXCLUSIVE: ALTER TABLE
-- ACCESS EXCLUSIVE: DROP TABLE, TRUNCATE
```

### 2.2 è¡Œçº§é”

**è¡Œçº§é”ç±»å‹**:

```sql
-- FOR UPDATE: æ’ä»–é”
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- FOR SHARE: å…±äº«é”
SELECT * FROM users WHERE id = 1 FOR SHARE;

-- FOR NO KEY UPDATE: éé”®æ’ä»–é”
SELECT * FROM users WHERE id = 1 FOR NO KEY UPDATE;

-- FOR KEY SHARE: é”®å…±äº«é”
SELECT * FROM users WHERE id = 1 FOR KEY SHARE;
```

### 2.3 é”å…¼å®¹æ€§

**é”å…¼å®¹æ€§çŸ©é˜µ**:

| é”ç±»å‹ | ACCESS SHARE | ROW SHARE | ROW EXCLUSIVE | SHARE | EXCLUSIVE | ACCESS EXCLUSIVE |
|--------|--------------|-----------|---------------|-------|-----------|------------------|
| **ACCESS SHARE** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **ROW SHARE** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **ROW EXCLUSIVE** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **SHARE** | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| **EXCLUSIVE** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **ACCESS EXCLUSIVE** | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |

## 3. é”ç›‘æ§

### 3.1 æŸ¥çœ‹é”ä¿¡æ¯

**æŸ¥çœ‹å½“å‰é”**:

```sql
-- æŸ¥çœ‹æ‰€æœ‰é”
SELECT
    locktype,
    database,
    relation::regclass,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks;

-- æŸ¥çœ‹ç­‰å¾…é”çš„æŸ¥è¯¢
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.2 æ­»é”æ£€æµ‹

**æ­»é”æ£€æµ‹**:

```sql
-- PostgreSQL è‡ªåŠ¨æ£€æµ‹æ­»é”
-- æ­»é”å‘ç”Ÿæ—¶ï¼Œä¼šå›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡

-- æŸ¥çœ‹æ­»é”æ—¥å¿—ï¼ˆéœ€è¦é…ç½® log_lock_waitsï¼‰
-- postgresql.conf:
-- log_lock_waits = on
```

## 4. å®é™…åº”ç”¨æ¡ˆä¾‹

### 4.1 æ¡ˆä¾‹: é”ç­‰å¾…é—®é¢˜è§£å†³ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸåº”ç”¨å‡ºç°é”ç­‰å¾…é—®é¢˜ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ã€‚

**é—®é¢˜åˆ†æ**:

1. **é”ç­‰å¾…**: å¤§é‡æŸ¥è¯¢ç­‰å¾…é”
2. **æ€§èƒ½ä¸‹é™**: æŸ¥è¯¢æ€§èƒ½ä¸‹é™
3. **å¹¶å‘é—®é¢˜**: å¹¶å‘è®¿é—®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- 1. è¯†åˆ«é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocking_locks.pid AS blocking_pid,
    blocked_activity.query AS blocked_query,
    blocking_activity.query AS blocking_query
FROM pg_locks blocked_locks
JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- 2. ä¼˜åŒ–é”ä½¿ç”¨
-- ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”
-- å‡å°‘é”æŒæœ‰æ—¶é—´
-- ä½¿ç”¨åˆé€‚çš„éš”ç¦»çº§åˆ«

-- 3. è°ƒæ•´é”è¶…æ—¶
SET lock_timeout = '5s';
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é”ç­‰å¾…æ—¶é—´** | 10 ç§’ | **< 1ç§’** | **90%** â¬‡ï¸ |
| **æŸ¥è¯¢æ€§èƒ½** | åŸºå‡† | **+40%** | **æå‡** |
| **æ­»é”æ¬¡æ•°** | 10/å¤© | **0** | **100%** â¬‡ï¸ |

## 5. æœ€ä½³å®è·µ

### 5.1 é”ä½¿ç”¨

1. **ç»†ç²’åº¦é”**: ä½¿ç”¨ç»†ç²’åº¦é”
2. **çŸ­æŒæœ‰æ—¶é—´**: å‡å°‘é”æŒæœ‰æ—¶é—´
3. **åˆé€‚éš”ç¦»çº§åˆ«**: ä½¿ç”¨åˆé€‚çš„éš”ç¦»çº§åˆ«

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **é¿å…é•¿äº‹åŠ¡**: é¿å…é•¿äº‹åŠ¡
2. **ç´¢å¼•ä¼˜åŒ–**: ä¼˜åŒ–ç´¢å¼•å‡å°‘é”ç«äº‰
3. **ç›‘æ§**: ç›‘æ§é”ç­‰å¾…æƒ…å†µ

## 6. å‚è€ƒèµ„æ–™

- [å¹¶å‘æ§åˆ¶è¯¦è§£](./å¹¶å‘æ§åˆ¶è¯¦è§£.md)
- [äº‹åŠ¡ç®¡ç†è¯¦è§£](./äº‹åŠ¡ç®¡ç†è¯¦è§£.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é”](https://www.postgresql.org/docs/current/explicit-locking.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-32
