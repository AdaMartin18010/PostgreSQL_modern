# PostgreSQL æƒé™ç®¡ç†

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-08

## ğŸ“‘ ç›®å½•

- [PostgreSQL æƒé™ç®¡ç†](#postgresql-æƒé™ç®¡ç†)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æƒé™æ¨¡å‹](#11-æƒé™æ¨¡å‹)
  - [2. ç”¨æˆ·å’Œè§’è‰²](#2-ç”¨æˆ·å’Œè§’è‰²)
    - [2.1 åˆ›å»ºè§’è‰²](#21-åˆ›å»ºè§’è‰²)
    - [2.2 è§’è‰²ç®¡ç†](#22-è§’è‰²ç®¡ç†)
    - [2.3 è§’è‰²ç»§æ‰¿](#23-è§’è‰²ç»§æ‰¿)
  - [3. æƒé™æˆäºˆ](#3-æƒé™æˆäºˆ)
    - [3.1 è¡¨æƒé™](#31-è¡¨æƒé™)
    - [3.2 æŸ¥çœ‹æƒé™](#32-æŸ¥çœ‹æƒé™)
    - [3.3 åˆ—æƒé™](#33-åˆ—æƒé™)
    - [3.4 å‡½æ•°æƒé™](#34-å‡½æ•°æƒé™)
  - [4. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰](#4-è¡Œçº§å®‰å…¨rls)
    - [4.1 å¯ç”¨ RLS](#41-å¯ç”¨-rls)
    - [4.2 RLS ç­–ç•¥ç±»å‹](#42-rls-ç­–ç•¥ç±»å‹)
    - [4.3 å¤æ‚ RLS ç­–ç•¥](#43-å¤æ‚-rls-ç­–ç•¥)
  - [5. æƒé™ç®¡ç†æœ€ä½³å®è·µ](#5-æƒé™ç®¡ç†æœ€ä½³å®è·µ)
    - [5.1 æœ€å°æƒé™åŸåˆ™](#51-æœ€å°æƒé™åŸåˆ™)
    - [5.2 æƒé™ç®¡ç†è„šæœ¬](#52-æƒé™ç®¡ç†è„šæœ¬)
  - [6. å®è·µç»ƒä¹ ](#6-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºåªè¯»ç”¨æˆ·](#ç»ƒä¹ -1-åˆ›å»ºåªè¯»ç”¨æˆ·)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 æƒé™æ¨¡å‹

PostgreSQL ä½¿ç”¨åŸºäºè§’è‰²çš„æƒé™æ¨¡å‹ï¼š

- **è§’è‰² (Role)**: å¯ä»¥æ‹¥æœ‰æ•°æ®åº“å¯¹è±¡ï¼Œå¯ä»¥æˆäºˆæƒé™
- **ç”¨æˆ· (User)**: å¯ä»¥ç™»å½•çš„è§’è‰²
- **ç»„ (Group)**: ä¸èƒ½ç™»å½•çš„è§’è‰²ï¼Œç”¨äºæƒé™åˆ†ç»„

**æƒé™å±‚æ¬¡**:

```
æ•°æ®åº“ (Database)
  â””â”€â”€ Schema
      â””â”€â”€ è¡¨/è§†å›¾/å‡½æ•°
          â””â”€â”€ åˆ—
```

## 2. ç”¨æˆ·å’Œè§’è‰²

### 2.1 åˆ›å»ºè§’è‰²

```sql
-- åˆ›å»ºè§’è‰²
CREATE ROLE app_user WITH LOGIN PASSWORD 'password';

-- åˆ›å»ºåªè¯»è§’è‰²
CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password';

-- åˆ›å»ºç®¡ç†å‘˜è§’è‰²
CREATE ROLE admin_user WITH SUPERUSER CREATEDB CREATEROLE;
```

### 2.2 è§’è‰²ç®¡ç†

```sql
-- ä¿®æ”¹è§’è‰²å¯†ç 
ALTER ROLE app_user WITH PASSWORD 'new_password';

-- ä¿®æ”¹è§’è‰²å±æ€§
ALTER ROLE app_user WITH CREATEDB;

-- åˆ é™¤è§’è‰²
DROP ROLE app_user;
```

### 2.3 è§’è‰²ç»§æ‰¿

```sql
-- åˆ›å»ºè§’è‰²å±‚æ¬¡
CREATE ROLE app_readonly;
CREATE ROLE app_readwrite;
CREATE ROLE app_admin;

-- è§’è‰²ç»§æ‰¿
GRANT app_readonly TO app_readwrite;
GRANT app_readwrite TO app_admin;

-- ç”¨æˆ·ç»§æ‰¿è§’è‰²
CREATE ROLE app_user WITH LOGIN;
GRANT app_readwrite TO app_user;
```

## 3. æƒé™æˆäºˆ

### 3.1 è¡¨æƒé™

```sql
-- æˆäºˆ SELECT æƒé™
GRANT SELECT ON users TO readonly_user;

-- æˆäºˆæ‰€æœ‰æƒé™
GRANT ALL PRIVILEGES ON users TO app_user;

-- æˆäºˆæ‰€æœ‰è¡¨çš„æƒé™
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- æˆäºˆæœªæ¥è¡¨çš„æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO readonly_user;

-- æ’¤é”€æƒé™
REVOKE SELECT ON users FROM readonly_user;
```

### 3.2 æŸ¥çœ‹æƒé™

```sql
-- æŸ¥çœ‹è¡¨æƒé™
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE grantee = 'readonly_user';
```

### 3.3 åˆ—æƒé™

```sql
-- æˆäºˆåˆ—æƒé™
GRANT SELECT (id, name, email) ON users TO readonly_user;

-- æ’¤é”€åˆ—æƒé™
REVOKE SELECT (password) ON users FROM readonly_user;
```

### 3.4 å‡½æ•°æƒé™

```sql
-- æˆäºˆå‡½æ•°æ‰§è¡Œæƒé™
GRANT EXECUTE ON FUNCTION calculate_total(DECIMAL, INTEGER) TO app_user;

-- æˆäºˆæ‰€æœ‰å‡½æ•°æƒé™
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO app_user;
```

## 4. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰

### 4.1 å¯ç”¨ RLS

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥
CREATE POLICY user_orders_policy ON orders
FOR ALL
TO app_user
USING (user_id = current_setting('app.user_id')::INTEGER);

-- ä½¿ç”¨ç­–ç•¥
SET app.user_id = 1;
SELECT * FROM orders;  -- åªèƒ½çœ‹åˆ° user_id = 1 çš„è®¢å•
```

### 4.2 RLS ç­–ç•¥ç±»å‹

**ç­–ç•¥ç±»å‹**:

```sql
-- 1. SELECT ç­–ç•¥ï¼ˆåªè¯»ï¼‰
CREATE POLICY user_select_policy ON users
FOR SELECT
TO app_user
USING (id = current_setting('app.user_id')::INTEGER);

-- 2. INSERT ç­–ç•¥
CREATE POLICY user_insert_policy ON users
FOR INSERT
TO app_user
WITH CHECK (created_by = current_setting('app.user_id')::INTEGER);

-- 3. UPDATE ç­–ç•¥
CREATE POLICY user_update_policy ON users
FOR UPDATE
TO app_user
USING (id = current_setting('app.user_id')::INTEGER)
WITH CHECK (id = current_setting('app.user_id')::INTEGER);

-- 4. DELETE ç­–ç•¥
CREATE POLICY user_delete_policy ON users
FOR DELETE
TO app_user
USING (id = current_setting('app.user_id')::INTEGER);
```

### 4.3 å¤æ‚ RLS ç­–ç•¥

```sql
-- åŸºäºè§’è‰²çš„ RLS
CREATE POLICY role_based_policy ON orders
FOR ALL
TO app_user
USING (
    CASE
        WHEN current_setting('app.user_role') = 'admin' THEN TRUE
        WHEN current_setting('app.user_role') = 'manager' THEN
            department_id = (SELECT department_id FROM users WHERE id = current_setting('app.user_id')::INTEGER)
        ELSE user_id = current_setting('app.user_id')::INTEGER
    END
);
```

## 5. æƒé™ç®¡ç†æœ€ä½³å®è·µ

### 5.1 æœ€å°æƒé™åŸåˆ™

**æƒé™è®¾è®¡åŸåˆ™**:

1. **æœ€å°æƒé™**: åªæˆäºˆå¿…è¦çš„æƒé™
2. **è§’è‰²åˆ†ç¦»**: ä¸åŒè§’è‰²æˆäºˆä¸åŒæƒé™
3. **å®šæœŸå®¡æŸ¥**: å®šæœŸå®¡æŸ¥å’Œæ’¤é”€ä¸å¿…è¦çš„æƒé™

**æƒé™å®¡æŸ¥æŸ¥è¯¢**:

```sql
-- æŸ¥çœ‹ç”¨æˆ·æƒé™
SELECT
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE grantee = 'app_user'
ORDER BY table_schema, table_name;

-- æŸ¥çœ‹è§’è‰²æƒé™
SELECT
    r.rolname,
    r.rolsuper,
    r.rolinherit,
    r.rolcreaterole,
    r.rolcreatedb,
    r.rolcanlogin
FROM pg_roles r
WHERE r.rolname = 'app_user';
```

### 5.2 æƒé™ç®¡ç†è„šæœ¬

**è‡ªåŠ¨åŒ–æƒé™ç®¡ç†**:

```sql
-- åˆ›å»ºæ ‡å‡†æƒé™æ¨¡æ¿
CREATE OR REPLACE FUNCTION grant_standard_permissions(
    p_role_name TEXT,
    p_schema_name TEXT DEFAULT 'public'
)
RETURNS void AS $$
BEGIN
    -- æˆäºˆ Schema ä½¿ç”¨æƒé™
    EXECUTE format('GRANT USAGE ON SCHEMA %I TO %I', p_schema_name, p_role_name);

    -- æˆäºˆè¡¨ SELECT æƒé™
    EXECUTE format('GRANT SELECT ON ALL TABLES IN SCHEMA %I TO %I', p_schema_name, p_role_name);

    -- æˆäºˆæœªæ¥è¡¨çš„ SELECT æƒé™
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT SELECT ON TABLES TO %I',
                   p_schema_name, p_role_name);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨
SELECT grant_standard_permissions('readonly_user', 'public');
```

## 6. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºåªè¯»ç”¨æˆ·

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªåªèƒ½è¯»å– users è¡¨çš„ç”¨æˆ·
CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password';
GRANT SELECT ON users TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
```

## 7. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§’è‰²å’Œæƒé™](https://www.postgresql.org/docs/current/user-manag.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-08
