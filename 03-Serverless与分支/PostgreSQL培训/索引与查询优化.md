# PostgreSQL ç´¢å¼•ä¸ŽæŸ¥è¯¢ä¼˜åŒ–

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-03

## ðŸ“‘ ç›®å½•

- [PostgreSQL ç´¢å¼•ä¸ŽæŸ¥è¯¢ä¼˜åŒ–](#postgresql-ç´¢å¼•ä¸ŽæŸ¥è¯¢ä¼˜åŒ–)
  - [ðŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. ç´¢å¼•ç±»åž‹](#1-ç´¢å¼•ç±»åž‹)
    - [1.1 B-tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰](#11-b-tree-ç´¢å¼•é»˜è®¤)
    - [1.2 Hash ç´¢å¼•](#12-hash-ç´¢å¼•)
    - [1.3 GiST ç´¢å¼•](#13-gist-ç´¢å¼•)
    - [1.4 GIN ç´¢å¼•](#14-gin-ç´¢å¼•)
    - [1.5 BRIN ç´¢å¼•](#15-brin-ç´¢å¼•)
  - [2. ç´¢å¼•åˆ›å»ºä¸Žç®¡ç†](#2-ç´¢å¼•åˆ›å»ºä¸Žç®¡ç†)
    - [2.1 ç´¢å¼•åˆ›å»ºæœ€ä½³å®žè·µ](#21-ç´¢å¼•åˆ›å»ºæœ€ä½³å®žè·µ)
    - [2.2 ç´¢å¼•ç»´æŠ¤](#22-ç´¢å¼•ç»´æŠ¤)
  - [3. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§](#3-æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§)
    - [3.1 ä½¿ç”¨ EXPLAIN åˆ†æž](#31-ä½¿ç”¨-explain-åˆ†æž)
    - [3.2 æŸ¥è¯¢ä¼˜åŒ–åŽŸåˆ™](#32-æŸ¥è¯¢ä¼˜åŒ–åŽŸåˆ™)
  - [4. EXPLAIN åˆ†æž](#4-explain-åˆ†æž)
    - [4.1 ç†è§£æ‰§è¡Œè®¡åˆ’](#41-ç†è§£æ‰§è¡Œè®¡åˆ’)
    - [4.2 æ€§èƒ½åˆ†æžå·¥å…·](#42-æ€§èƒ½åˆ†æžå·¥å…·)
  - [5. å®žè·µç»ƒä¹ ](#5-å®žè·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºåˆé€‚çš„ç´¢å¼•](#ç»ƒä¹ -1-åˆ›å»ºåˆé€‚çš„ç´¢å¼•)
    - [ç»ƒä¹  2: ä¼˜åŒ–æ…¢æŸ¥è¯¢](#ç»ƒä¹ -2-ä¼˜åŒ–æ…¢æŸ¥è¯¢)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. ç´¢å¼•ç±»åž‹

### 1.1 B-tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰

```sql
-- åŸºæœ¬ B-tree ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_email_unique ON users(email);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_users_name_age ON users(name, age);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ»¡è¶³æ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_active_users ON users(email) WHERE is_active = TRUE;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users(LOWER(email));
```

### 1.2 Hash ç´¢å¼•

```sql
-- Hash ç´¢å¼•ï¼ˆåªæ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼‰
CREATE INDEX idx_users_id_hash ON users USING HASH(id);

-- ä½¿ç”¨åœºæ™¯ï¼šç­‰å€¼æŸ¥è¯¢ï¼Œä¸æŽ’åº
SELECT * FROM users WHERE id = 123;
```

### 1.3 GiST ç´¢å¼•

```sql
-- GiST ç´¢å¼•ï¼ˆé€šç”¨æœç´¢æ ‘ï¼‰
CREATE INDEX idx_documents_content_gist ON documents USING GIST(content);

-- ç”¨äºŽå¤æ‚æ•°æ®ç±»åž‹ï¼šå‡ ä½•ç±»åž‹ã€å…¨æ–‡æœç´¢ç­‰
```

### 1.4 GIN ç´¢å¼•

```sql
-- GIN ç´¢å¼•ï¼ˆå€’æŽ’ç´¢å¼•ï¼‰
-- å…¨æ–‡æœç´¢
CREATE INDEX idx_documents_content_gin ON documents
USING GIN(to_tsvector('english', content));

-- æ•°ç»„
CREATE INDEX idx_users_tags_gin ON users USING GIN(tags);

-- JSONB
CREATE INDEX idx_products_metadata_gin ON products USING GIN(metadata);
```

### 1.5 BRIN ç´¢å¼•

```sql
-- BRIN ç´¢å¼•ï¼ˆå—èŒƒå›´ç´¢å¼•ï¼Œç”¨äºŽå¤§è¡¨ï¼‰
CREATE INDEX idx_orders_date_brin ON orders USING BRIN(order_date);

-- é€‚ç”¨äºŽï¼šå¤§è¡¨ã€æœ‰åºæ•°æ®ã€èŒƒå›´æŸ¥è¯¢
```

## 2. ç´¢å¼•åˆ›å»ºä¸Žç®¡ç†

### 2.1 ç´¢å¼•åˆ›å»ºæœ€ä½³å®žè·µ

```sql
-- 1. ä¸»é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•
CREATE TABLE users (
    id SERIAL PRIMARY KEY  -- è‡ªåŠ¨åˆ›å»ºä¸»é”®ç´¢å¼•
);

-- 2. å¤–é”®åˆ—åˆ›å»ºç´¢å¼•
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id)
);
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- 3. é¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_date ON orders(order_date);

-- 4. å¤åˆç´¢å¼•çš„é¡ºåºå¾ˆé‡è¦
-- æŸ¥è¯¢: WHERE status = 'active' AND created_at > '2024-01-01'
CREATE INDEX idx_orders_status_date ON orders(status, created_at);
-- status åœ¨å‰ï¼Œå› ä¸ºé€‰æ‹©æ€§æ›´é«˜

-- 5. è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_users_covering ON users(email) INCLUDE (name, age);
-- æŸ¥è¯¢åªéœ€è¦ email, name, age æ—¶ï¼Œå¯ä»¥ç›´æŽ¥ä»Žç´¢å¼•èŽ·å–ï¼Œæ— éœ€å›žè¡¨
```

### 2.2 ç´¢å¼•ç»´æŠ¤

```sql
-- æŸ¥çœ‹ç´¢å¼•
SELECT
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public';

-- é‡å»ºç´¢å¼•
REINDEX INDEX idx_users_email;

-- é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE users;

-- åˆ†æžç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
DROP INDEX idx_unused_index;
```

## 3. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

### 3.1 ä½¿ç”¨ EXPLAIN åˆ†æž

```sql
-- EXPLAIN æ˜¾ç¤ºæŸ¥è¯¢è®¡åˆ’
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN ANALYZEï¼ˆå®žé™…æ‰§è¡Œå¹¶æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼‰
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN VERBOSEï¼ˆæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼‰
EXPLAIN VERBOSE SELECT * FROM users WHERE email = 'john@example.com';

-- EXPLAIN BUFFERSï¼ˆæ˜¾ç¤ºç¼“å†²åŒºä½¿ç”¨æƒ…å†µï¼‰
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE email = 'john@example.com';
```

### 3.2 æŸ¥è¯¢ä¼˜åŒ–åŽŸåˆ™

```sql
-- 1. é¿å… SELECT *
SELECT id, name, email FROM users;  -- åªé€‰æ‹©éœ€è¦çš„åˆ—

-- 2. ä½¿ç”¨ LIMIT
SELECT * FROM users ORDER BY id LIMIT 10;  -- é™åˆ¶ç»“æžœé›†å¤§å°

-- 3. ä½¿ç”¨ç´¢å¼•åˆ—è¿›è¡Œè¿‡æ»¤
SELECT * FROM users WHERE email = 'john@example.com';  -- email æœ‰ç´¢å¼•
-- è€Œä¸æ˜¯
SELECT * FROM users WHERE UPPER(email) = 'JOHN@EXAMPLE.COM';  -- å‡½æ•°è°ƒç”¨æ— æ³•ä½¿ç”¨ç´¢å¼•

-- 4. é¿å…åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨å‡½æ•°
-- ä¸å¥½
SELECT * FROM users WHERE EXTRACT(YEAR FROM created_at) = 2024;
-- å¥½
SELECT * FROM users WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01';

-- 5. ä½¿ç”¨ EXISTS è€Œä¸æ˜¯ INï¼ˆå¯¹äºŽå¤§å­æŸ¥è¯¢ï¼‰
-- ä¸å¥½
SELECT * FROM users WHERE id IN (SELECT user_id FROM orders);
-- å¥½
SELECT * FROM users WHERE EXISTS (SELECT 1 FROM orders WHERE orders.user_id = users.id);

-- 6. ä½¿ç”¨ JOIN è€Œä¸æ˜¯å­æŸ¥è¯¢
-- ä¸å¥½
SELECT name, (SELECT COUNT(*) FROM orders WHERE orders.user_id = users.id) FROM users;
-- å¥½
SELECT u.name, COUNT(o.id)
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;
```

## 4. EXPLAIN åˆ†æž

### 4.1 ç†è§£æ‰§è¡Œè®¡åˆ’

```sql
-- é¡ºåºæ‰«æï¼ˆSeq Scanï¼‰- å…¨è¡¨æ‰«æï¼Œæ…¢
EXPLAIN SELECT * FROM users WHERE name LIKE '%John%';

-- ç´¢å¼•æ‰«æï¼ˆIndex Scanï¼‰- ä½¿ç”¨ç´¢å¼•ï¼Œå¿«
EXPLAIN SELECT * FROM users WHERE email = 'john@example.com';

-- ç´¢å¼•å”¯ä¸€æ‰«æï¼ˆIndex Only Scanï¼‰- åªä»Žç´¢å¼•èŽ·å–æ•°æ®ï¼Œæœ€å¿«
EXPLAIN SELECT email FROM users WHERE email = 'john@example.com';

-- ä½å›¾ç´¢å¼•æ‰«æï¼ˆBitmap Index Scanï¼‰- å¤šä¸ªæ¡ä»¶æ—¶ä½¿ç”¨
EXPLAIN SELECT * FROM users WHERE age > 25 AND age < 35;
```

### 4.2 æ€§èƒ½åˆ†æžå·¥å…·

```sql
-- å¯ç”¨ pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- é‡ç½®ç»Ÿè®¡ä¿¡æ¯
SELECT pg_stat_statements_reset();
```

## 5. å®žè·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºåˆé€‚çš„ç´¢å¼•

```sql
-- ä»»åŠ¡: ä¸ºä»¥ä¸‹æŸ¥è¯¢åˆ›å»ºåˆé€‚çš„ç´¢å¼•
-- SELECT * FROM users WHERE email = 'john@example.com';
CREATE INDEX idx_users_email ON users(email);

-- SELECT * FROM orders WHERE user_id = 123 AND status = 'active';
CREATE INDEX idx_orders_user_status ON orders(user_id, status);

-- SELECT * FROM products WHERE category = 'electronics' AND price BETWEEN 100 AND 500;
CREATE INDEX idx_products_category_price ON products(category, price);
```

### ç»ƒä¹  2: ä¼˜åŒ–æ…¢æŸ¥è¯¢

```sql
-- åŽŸå§‹æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT u.name, o.order_date, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email LIKE '%@example.com'
ORDER BY o.order_date DESC
LIMIT 100;

-- ä¼˜åŒ–æ­¥éª¤:
-- 1. åœ¨ users.email ä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- 2. åœ¨ orders.user_id å’Œ orders.order_date ä¸Šåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date DESC);

-- 3. å¦‚æžœå¯èƒ½ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„è¿‡æ»¤æ¡ä»¶
SELECT u.name, o.order_date, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email LIKE 'user%@example.com'  -- æ›´å…·ä½“çš„æ¨¡å¼
ORDER BY o.order_date DESC
LIMIT 100;
```

## 6. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç´¢å¼•](https://www.postgresql.org/docs/current/indexes.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æç¤º](https://www.postgresql.org/docs/current/performance-tips.html)

---

**æœ€åŽæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-03
