# PostgreSQL æ•°æ®ç±»å‹è¯¦è§£

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-04

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ•°æ®ç±»å‹è¯¦è§£](#postgresql-æ•°æ®ç±»å‹è¯¦è§£)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 PostgreSQL æ•°æ®ç±»å‹åˆ†ç±»](#11-postgresql-æ•°æ®ç±»å‹åˆ†ç±»)
  - [2. JSON/JSONB æ“ä½œ](#2-jsonjsonb-æ“ä½œ)
    - [2.1 JSONB æ“ä½œç¬¦](#21-jsonb-æ“ä½œç¬¦)
    - [2.2 JSONB ç´¢å¼•](#22-jsonb-ç´¢å¼•)
    - [2.3 JSONB æ€§èƒ½ä¼˜åŒ–](#23-jsonb-æ€§èƒ½ä¼˜åŒ–)
  - [3. æ•°ç»„æ“ä½œ](#3-æ•°ç»„æ“ä½œ)
    - [3.1 æ•°ç»„æ“ä½œç¬¦](#31-æ•°ç»„æ“ä½œç¬¦)
    - [3.2 æ•°ç»„ç´¢å¼•](#32-æ•°ç»„ç´¢å¼•)
    - [3.3 æ•°ç»„æ€§èƒ½ä¼˜åŒ–](#33-æ•°ç»„æ€§èƒ½ä¼˜åŒ–)
  - [4. èŒƒå›´ç±»å‹](#4-èŒƒå›´ç±»å‹)
    - [4.1 èŒƒå›´ç±»å‹æ“ä½œ](#41-èŒƒå›´ç±»å‹æ“ä½œ)
    - [4.2 èŒƒå›´ç±»å‹ç´¢å¼•](#42-èŒƒå›´ç±»å‹ç´¢å¼•)
  - [5. è‡ªå®šä¹‰ç±»å‹](#5-è‡ªå®šä¹‰ç±»å‹)
    - [5.1 æšä¸¾ç±»å‹](#51-æšä¸¾ç±»å‹)
    - [5.2 å¤åˆç±»å‹](#52-å¤åˆç±»å‹)
    - [5.3 åŸŸç±»å‹](#53-åŸŸç±»å‹)
  - [6. æ•°æ®ç±»å‹é€‰æ‹©æŒ‡å—](#6-æ•°æ®ç±»å‹é€‰æ‹©æŒ‡å—)
    - [6.1 æ•°å€¼ç±»å‹é€‰æ‹©](#61-æ•°å€¼ç±»å‹é€‰æ‹©)
    - [6.2 å­—ç¬¦ç±»å‹é€‰æ‹©](#62-å­—ç¬¦ç±»å‹é€‰æ‹©)
    - [6.3 JSON vs JSONB](#63-json-vs-jsonb)
  - [7. å®è·µç»ƒä¹ ](#7-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: JSONB æŸ¥è¯¢](#ç»ƒä¹ -1-jsonb-æŸ¥è¯¢)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 PostgreSQL æ•°æ®ç±»å‹åˆ†ç±»

PostgreSQL æ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼š

- **æ•°å€¼ç±»å‹**: INTEGER, BIGINT, DECIMAL, NUMERIC, REAL, DOUBLE PRECISION
- **å­—ç¬¦ç±»å‹**: TEXT, VARCHAR, CHAR
- **æ—¥æœŸæ—¶é—´**: DATE, TIME, TIMESTAMP, TIMESTAMPTZ, INTERVAL
- **å¸ƒå°”ç±»å‹**: BOOLEAN
- **JSON ç±»å‹**: JSON, JSONB
- **æ•°ç»„ç±»å‹**: æ‰€æœ‰åŸºç¡€ç±»å‹çš„æ•°ç»„
- **èŒƒå›´ç±»å‹**: INT4RANGE, TSTZRANGE ç­‰
- **è‡ªå®šä¹‰ç±»å‹**: ENUM, COMPOSITE, DOMAIN

## 2. JSON/JSONB æ“ä½œ

### 2.1 JSONB æ“ä½œç¬¦

```sql
-- åˆ›å»ºè¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    metadata JSONB
);

-- æ’å…¥ JSON æ•°æ®
INSERT INTO products (name, metadata) VALUES (
    'Product 1',
    '{"price": 100, "category": "electronics", "tags": ["new", "popular"]}'::jsonb
);

-- è®¿é—® JSON å­—æ®µ
SELECT metadata->>'price' AS price FROM products;
SELECT metadata->'tags' AS tags FROM products;
SELECT metadata->'tags'->0 AS first_tag FROM products;

-- JSONB æŸ¥è¯¢
SELECT * FROM products WHERE metadata @> '{"category": "electronics"}'::jsonb;
SELECT * FROM products WHERE metadata ? 'price';
SELECT * FROM products WHERE metadata ?| array['price', 'category'];
SELECT * FROM products WHERE metadata ?& array['price', 'category'];

-- JSONB æ›´æ–°
UPDATE products
SET metadata = metadata || '{"discount": 10}'::jsonb
WHERE id = 1;

-- JSONB å‡½æ•°
SELECT jsonb_pretty(metadata) FROM products;
SELECT jsonb_object_keys(metadata) FROM products;
SELECT jsonb_array_elements(metadata->'tags') FROM products;
```

### 2.2 JSONB ç´¢å¼•

```sql
-- GIN ç´¢å¼•ï¼ˆæ¨èï¼‰
CREATE INDEX idx_products_metadata_gin ON products USING GIN(metadata);

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_products_category ON products ((metadata->>'category'));

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
SELECT * FROM products WHERE metadata @> '{"category": "electronics"}'::jsonb;
```

### 2.3 JSONB æ€§èƒ½ä¼˜åŒ–

**JSONB ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨ GIN ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
CREATE INDEX idx_products_metadata_gin ON products USING GIN(metadata);

-- 2. ä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•åŠ é€Ÿç‰¹å®šæŸ¥è¯¢
CREATE INDEX idx_products_price ON products ((metadata->>'price')::NUMERIC);

-- 3. ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_products_electronics ON products USING GIN(metadata)
WHERE metadata @> '{"category": "electronics"}'::jsonb;

-- 4. JSONB è·¯å¾„ç´¢å¼•ï¼ˆPostgreSQL 14+ï¼‰
CREATE INDEX idx_products_path ON products USING GIN(metadata jsonb_path_ops);
```

## 3. æ•°ç»„æ“ä½œ

### 3.1 æ•°ç»„æ“ä½œç¬¦

```sql
-- åˆ›å»ºè¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    tags TEXT[]
);

-- æ’å…¥æ•°ç»„
INSERT INTO users (name, tags) VALUES ('John', ARRAY['admin', 'developer']);

-- æ•°ç»„æŸ¥è¯¢
SELECT * FROM users WHERE 'admin' = ANY(tags);
SELECT * FROM users WHERE tags @> ARRAY['admin'];
SELECT * FROM users WHERE tags && ARRAY['admin', 'user'];

-- æ•°ç»„å‡½æ•°
SELECT array_length(tags, 1) FROM users;
SELECT array_append(tags, 'new_tag') FROM users;
SELECT array_remove(tags, 'old_tag') FROM users;
SELECT unnest(tags) FROM users;  -- å±•å¼€æ•°ç»„ä¸ºè¡Œ
```

### 3.2 æ•°ç»„ç´¢å¼•

```sql
-- GIN ç´¢å¼•
CREATE INDEX idx_users_tags_gin ON users USING GIN(tags);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE tags @> ARRAY['admin'];
```

### 3.3 æ•°ç»„æ€§èƒ½ä¼˜åŒ–

**æ•°ç»„ä¼˜åŒ–æŠ€å·§**:

```sql
-- 1. ä½¿ç”¨ GIN ç´¢å¼•åŠ é€Ÿæ•°ç»„æŸ¥è¯¢
CREATE INDEX idx_users_tags_gin ON users USING GIN(tags);

-- 2. ä½¿ç”¨æ•°ç»„é•¿åº¦ç´¢å¼•
CREATE INDEX idx_users_tags_length ON users (array_length(tags, 1));

-- 3. æ•°ç»„å»é‡å’Œæ’åº
SELECT DISTINCT unnest(tags) FROM users ORDER BY 1;
```

## 4. èŒƒå›´ç±»å‹

```sql
-- åˆ›å»ºèŒƒå›´ç±»å‹è¡¨
CREATE TABLE reservations (
    id SERIAL PRIMARY KEY,
    room_id INTEGER,
    reservation_period TSTZRANGE
);

-- æ’å…¥èŒƒå›´æ•°æ®
INSERT INTO reservations (room_id, reservation_period) VALUES (
    1,
    '[2024-01-01 10:00, 2024-01-01 12:00)'
);

-- èŒƒå›´æŸ¥è¯¢
SELECT * FROM reservations
WHERE reservation_period @> TIMESTAMPTZ '2024-01-01 11:00';

-- èŒƒå›´æ“ä½œç¬¦
SELECT * FROM reservations
WHERE reservation_period && '[2024-01-01 11:00, 2024-01-01 13:00)';
```

### 4.1 èŒƒå›´ç±»å‹æ“ä½œ

**èŒƒå›´ç±»å‹æ“ä½œç¬¦**:

```sql
-- èŒƒå›´åŒ…å«
SELECT * FROM reservations
WHERE reservation_period @> TIMESTAMPTZ '2024-01-01 11:00';

-- èŒƒå›´é‡å 
SELECT * FROM reservations
WHERE reservation_period && '[2024-01-01 11:00, 2024-01-01 13:00)';

-- èŒƒå›´ç›¸é‚»
SELECT * FROM reservations
WHERE reservation_period -|- '[2024-01-01 12:00, 2024-01-01 14:00)';

-- èŒƒå›´å‡½æ•°
SELECT
    lower(reservation_period) AS start_time,
    upper(reservation_period) AS end_time,
    upper(reservation_period) - lower(reservation_period) AS duration
FROM reservations;
```

### 4.2 èŒƒå›´ç±»å‹ç´¢å¼•

```sql
-- åˆ›å»ºèŒƒå›´ç´¢å¼•
CREATE INDEX idx_reservations_period ON reservations USING GIST(reservation_period);

-- èŒƒå›´æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
SELECT * FROM reservations
WHERE reservation_period @> TIMESTAMPTZ '2024-01-01 11:00';
```

## 5. è‡ªå®šä¹‰ç±»å‹

### 5.1 æšä¸¾ç±»å‹

```sql
-- åˆ›å»ºæšä¸¾ç±»å‹
CREATE TYPE user_status AS ENUM ('active', 'inactive', 'suspended');

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    status user_status
);

-- ä½¿ç”¨æšä¸¾
INSERT INTO users (name, status) VALUES ('John', 'active');
SELECT * FROM users WHERE status = 'active';
```

### 5.2 å¤åˆç±»å‹

```sql
-- åˆ›å»ºå¤åˆç±»å‹
CREATE TYPE address AS (
    street TEXT,
    city TEXT,
    zip_code TEXT,
    country TEXT
);

-- ä½¿ç”¨å¤åˆç±»å‹
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    address address
);

-- æ’å…¥æ•°æ®
INSERT INTO users (name, address) VALUES (
    'John',
    ROW('123 Main St', 'New York', '10001', 'USA')::address
);

-- æŸ¥è¯¢å¤åˆç±»å‹
SELECT name, (address).city FROM users;
SELECT name, address.* FROM users;
```

### 5.3 åŸŸç±»å‹

```sql
-- åˆ›å»ºåŸŸç±»å‹ï¼ˆå¸¦çº¦æŸçš„åŸºç¡€ç±»å‹ï¼‰
CREATE DOMAIN email_address AS TEXT
CHECK (VALUE ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$');

-- ä½¿ç”¨åŸŸç±»å‹
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    email email_address
);

-- æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
INSERT INTO users (name, email) VALUES ('John', 'john@example.com');  -- OK
INSERT INTO users (name, email) VALUES ('John', 'invalid-email');     -- ERROR
```

## 6. æ•°æ®ç±»å‹é€‰æ‹©æŒ‡å—

### 6.1 æ•°å€¼ç±»å‹é€‰æ‹©

| æ•°æ®ç±»å‹ | èŒƒå›´ | å­˜å‚¨å¤§å° | ä½¿ç”¨åœºæ™¯ |
|---------|------|---------|---------|
| SMALLINT | -32,768 åˆ° 32,767 | 2 å­—èŠ‚ | å°æ•´æ•° |
| INTEGER | -2,147,483,648 åˆ° 2,147,483,647 | 4 å­—èŠ‚ | å¸¸ç”¨æ•´æ•° |
| BIGINT | -9,223,372,036,854,775,808 åˆ° 9,223,372,036,854,775,807 | 8 å­—èŠ‚ | å¤§æ•´æ•° |
| DECIMAL/NUMERIC | æ— é™åˆ¶ | å¯å˜ | ç²¾ç¡®æ•°å€¼ï¼ˆè´§å¸ï¼‰ |
| REAL | 6 ä½ç²¾åº¦ | 4 å­—èŠ‚ | æµ®ç‚¹æ•° |
| DOUBLE PRECISION | 15 ä½ç²¾åº¦ | 8 å­—èŠ‚ | é«˜ç²¾åº¦æµ®ç‚¹æ•° |

### 6.2 å­—ç¬¦ç±»å‹é€‰æ‹©

| æ•°æ®ç±»å‹ | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ |
|---------|------|---------|
| TEXT | æ— é•¿åº¦é™åˆ¶ | **æ¨èä½¿ç”¨** |
| VARCHAR(n) | æœ‰é•¿åº¦é™åˆ¶ | éœ€è¦é™åˆ¶é•¿åº¦ |
| CHAR(n) | å›ºå®šé•¿åº¦ï¼Œå¡«å……ç©ºæ ¼ | å›ºå®šé•¿åº¦å­—ç¬¦ä¸² |

### 6.3 JSON vs JSONB

| ç‰¹æ€§ | JSON | JSONB |
|------|------|-------|
| å­˜å‚¨æ ¼å¼ | æ–‡æœ¬ | äºŒè¿›åˆ¶ |
| æŸ¥è¯¢æ€§èƒ½ | æ…¢ | **å¿«** |
| ç´¢å¼•æ”¯æŒ | æœ‰é™ | **å®Œæ•´æ”¯æŒ** |
| æ¨èä½¿ç”¨ | âŒ | âœ… |

## 7. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: JSONB æŸ¥è¯¢

```sql
-- ä»»åŠ¡: æŸ¥è¯¢ä»·æ ¼åœ¨ 100-500 ä¹‹é—´çš„ç”µå­äº§å“
SELECT name, metadata->>'price' AS price
FROM products
WHERE metadata @> '{"category": "electronics"}'::jsonb
AND (metadata->>'price')::INTEGER BETWEEN 100 AND 500;
```

## 8. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - JSON ç±»å‹](https://www.postgresql.org/docs/current/datatype-json.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - æ•°ç»„ç±»å‹](https://www.postgresql.org/docs/current/arrays.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-04
