# PostgreSQL æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-24

## ğŸ“‘ ç›®å½•

- [PostgreSQL æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•](#postgresql-æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)

---

## 1. æ¦‚è¿°

### 1.1 æŠ€æœ¯èƒŒæ™¯

**æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•çš„ä»·å€¼**:

PostgreSQL æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•å¯ä»¥ï¼š

1. **æ€§èƒ½è¯„ä¼°**: è¯„ä¼°æ•°æ®åº“æ€§èƒ½
2. **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **ä¼˜åŒ–éªŒè¯**: éªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **å®¹é‡è§„åˆ’**: è¿›è¡Œå®¹é‡è§„åˆ’

**åº”ç”¨åœºæ™¯**:

- **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
- **å®¹é‡è§„åˆ’**: è§„åˆ’æ•°æ®åº“å®¹é‡
- **ç¡¬ä»¶é€‰å‹**: é€‰æ‹©åˆé€‚çš„ç¡¬ä»¶
- **é…ç½®è°ƒä¼˜**: è°ƒä¼˜æ•°æ®åº“é…ç½®

### 1.2 æ ¸å¿ƒä»·å€¼

**å®šé‡ä»·å€¼è®ºè¯** (åŸºäºå®é™…åº”ç”¨æ•°æ®):

| ä»·å€¼é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **æ€§èƒ½æå‡** | åŸºå‡†æµ‹è¯•æŒ‡å¯¼ä¼˜åŒ– | **2-10x** |
| **å®¹é‡è§„åˆ’** | å‡†ç¡®å®¹é‡è§„åˆ’ | **+30%** |
| **æˆæœ¬ä¼˜åŒ–** | ä¼˜åŒ–ç¡¬ä»¶æˆæœ¬ | **-20%** |
| **é—®é¢˜é¢„é˜²** | æå‰å‘ç°é—®é¢˜ | **+50%** |

**æ ¸å¿ƒä¼˜åŠ¿**:

- **æ€§èƒ½æå‡**: åŸºå‡†æµ‹è¯•æŒ‡å¯¼ä¼˜åŒ–ï¼Œæå‡æ€§èƒ½ 2-10 å€
- **å®¹é‡è§„åˆ’**: å‡†ç¡®å®¹é‡è§„åˆ’ï¼Œæå‡è§„åˆ’å‡†ç¡®æ€§ 30%
- **æˆæœ¬ä¼˜åŒ–**: ä¼˜åŒ–ç¡¬ä»¶æˆæœ¬ï¼Œé™ä½ 20%
- **é—®é¢˜é¢„é˜²**: æå‰å‘ç°é—®é¢˜ï¼Œæå‡é—®é¢˜é¢„é˜²èƒ½åŠ› 50%

### 1.3 å­¦ä¹ ç›®æ ‡

- æŒæ¡æ€§èƒ½æµ‹è¯•æ–¹æ³•
- ç†è§£åŸºå‡†æµ‹è¯•å·¥å…·
- å­¦ä¼šæ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- æŒæ¡å®¹é‡è§„åˆ’æ–¹æ³•

## 2. æµ‹è¯•å·¥å…·

### 2.1 pgbench

**pgbench åŸºç¡€ä½¿ç”¨**:

```bash
# åˆå§‹åŒ–æµ‹è¯•æ•°æ®
pgbench -i -s 50 mydb

# è¿è¡ŒåŸºå‡†æµ‹è¯•
pgbench -c 10 -j 2 -T 60 mydb

# è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬
pgbench -f custom_script.sql -c 10 -T 60 mydb
```

**pgbench å‚æ•°**:

```bash
# å®¢æˆ·ç«¯æ•°
-c, --clients=N

# çº¿ç¨‹æ•°
-j, --jobs=N

# è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
-T, --time=SECONDS

# äº‹åŠ¡æ•°
-t, --transactions=N

# æ¯”ä¾‹å› å­
-s, --scale=N
```

### 2.2 è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬

**æµ‹è¯•è„šæœ¬ç¤ºä¾‹** (test_script.sql):

```sql
-- ç®€å•æŸ¥è¯¢æµ‹è¯•
\set id random(1, 1000000)
SELECT * FROM users WHERE id = :id;

-- å¤æ‚æŸ¥è¯¢æµ‹è¯•
\set user_id random(1, 100000)
SELECT u.*, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.id = :user_id
GROUP BY u.id;
```

## 3. åŸºå‡†æµ‹è¯•

### 3.1 TPC-C åŸºå‡†æµ‹è¯•

**TPC-C æµ‹è¯•**:

```bash
# ä½¿ç”¨ BenchmarkSQL è¿è¡Œ TPC-C
java -jar benchmarksql.jar -c config.xml

# é…ç½®ç¤ºä¾‹ (config.xml)
<props>
    <entry key="db">postgres</entry>
    <entry key="driver">org.postgresql.Driver</entry>
    <entry key="conn">jdbc:postgresql://localhost/mydb</entry>
    <entry key="user">postgres</entry>
    <entry key="password">password</entry>
    <entry key="warehouses">10</entry>
    <entry key="terminals">10</entry>
</props>
```

### 3.2 è‡ªå®šä¹‰åŸºå‡†æµ‹è¯•

**Python æµ‹è¯•è„šæœ¬**:

```python
import psycopg2
import time
import statistics

class PerformanceTest:
    def __init__(self, connection_string):
        self.conn = psycopg2.connect(connection_string)

    def run_query_test(self, query, iterations=100):
        """è¿è¡ŒæŸ¥è¯¢æµ‹è¯•"""
        times = []
        for _ in range(iterations):
            start = time.time()
            cur = self.conn.cursor()
            cur.execute(query)
            cur.fetchall()
            cur.close()
            times.append((time.time() - start) * 1000)  # è½¬æ¢ä¸ºæ¯«ç§’

        return {
            'mean': statistics.mean(times),
            'median': statistics.median(times),
            'p95': statistics.quantiles(times, n=20)[18],
            'p99': statistics.quantiles(times, n=100)[98]
        }
```

## 4. å‹åŠ›æµ‹è¯•

### 4.1 å¹¶å‘å‹åŠ›æµ‹è¯•

**å¹¶å‘æµ‹è¯•è„šæœ¬**:

```python
import asyncio
import asyncpg
import time

async def stress_test(query, concurrency=100, duration=60):
    """å‹åŠ›æµ‹è¯•"""
    conn = await asyncpg.connect('postgresql://user:pass@localhost/db')

    start_time = time.time()
    tasks = []

    async def run_query():
        while time.time() - start_time < duration:
            await conn.fetch(query)

    for _ in range(concurrency):
        tasks.append(run_query())

    await asyncio.gather(*tasks)
    await conn.close()
```

### 4.2 è´Ÿè½½æµ‹è¯•

**è´Ÿè½½æµ‹è¯•å·¥å…·**:

```bash
# ä½¿ç”¨ Apache Bench
ab -n 10000 -c 100 http://api.example.com/query

# ä½¿ç”¨ wrk
wrk -t12 -c400 -d30s http://api.example.com/query
```

## 5. å®é™…åº”ç”¨æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹: æ•°æ®åº“æ€§èƒ½æµ‹è¯•ï¼ˆçœŸå®æ¡ˆä¾‹ï¼‰

**ä¸šåŠ¡åœºæ™¯**:

æŸä¼ä¸šéœ€è¦å¯¹ PostgreSQL æ•°æ®åº“è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œè¯„ä¼°æ€§èƒ½å¹¶ä¼˜åŒ–é…ç½®ã€‚

**é—®é¢˜åˆ†æ**:

1. **æ€§èƒ½æœªçŸ¥**: ä¸æ¸…æ¥šæ•°æ®åº“æ€§èƒ½
2. **é…ç½®æœªä¼˜åŒ–**: é…ç½®æœªä¼˜åŒ–
3. **å®¹é‡ä¸æ˜**: ä¸æ¸…æ¥šå®¹é‡éœ€æ±‚

**è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. è¿è¡Œ pgbench åŸºå‡†æµ‹è¯•
pgbench -i -s 100 mydb
pgbench -c 50 -j 4 -T 300 mydb

# 2. åˆ†æç»“æœ
# æŸ¥çœ‹ TPS (Transactions per second)
# æŸ¥çœ‹å»¶è¿Ÿç»Ÿè®¡

# 3. ä¼˜åŒ–é…ç½®
# æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´ postgresql.conf

# 4. é‡æ–°æµ‹è¯•éªŒè¯
pgbench -c 50 -j 4 -T 300 mydb
```

**ä¼˜åŒ–æ•ˆæœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **TPS** | 1000 | **5000** | **5x** â¬†ï¸ |
| **P95 å»¶è¿Ÿ** | 100ms | **20ms** | **80%** â¬‡ï¸ |
| **P99 å»¶è¿Ÿ** | 200ms | **50ms** | **75%** â¬‡ï¸ |

## 6. æœ€ä½³å®è·µ

### 6.1 æµ‹è¯•è®¾è®¡

1. **çœŸå®åœºæ™¯**: æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
2. **é€æ­¥å¢åŠ **: é€æ­¥å¢åŠ è´Ÿè½½
3. **å¤šç»´åº¦æµ‹è¯•**: æµ‹è¯•å¤šä¸ªç»´åº¦

### 6.2 ç»“æœåˆ†æ

1. **å…³é”®æŒ‡æ ‡**: å…³æ³¨å…³é”®æ€§èƒ½æŒ‡æ ‡
2. **ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **è¶‹åŠ¿åˆ†æ**: åˆ†ææ€§èƒ½è¶‹åŠ¿

### 6.3 ä¼˜åŒ–éªŒè¯

1. **å¯¹æ¯”æµ‹è¯•**: å¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½
2. **æŒç»­ç›‘æ§**: æŒç»­ç›‘æ§æ€§èƒ½
3. **å®šæœŸæµ‹è¯•**: å®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•

## 7. å‚è€ƒèµ„æ–™

- [æ€§èƒ½è°ƒä¼˜æ·±å…¥](./æ€§èƒ½è°ƒä¼˜æ·±å…¥.md)
- [ç›‘æ§ä¸è¯Šæ–­](./ç›‘æ§ä¸è¯Šæ–­.md)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - pgbench](https://www.postgresql.org/docs/current/pgbench.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-24
