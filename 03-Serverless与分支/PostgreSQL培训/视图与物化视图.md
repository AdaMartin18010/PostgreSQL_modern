# PostgreSQL è§†å›¾ä¸ç‰©åŒ–è§†å›¾

> **æ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 1 æ—¥
> **æŠ€æœ¯ç‰ˆæœ¬**: PostgreSQL 14+
> **æ–‡æ¡£ç¼–å·**: 03-03-07

## ğŸ“‘ ç›®å½•

- [PostgreSQL è§†å›¾ä¸ç‰©åŒ–è§†å›¾](#postgresql-è§†å›¾ä¸ç‰©åŒ–è§†å›¾)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. è§†å›¾ï¼ˆViewsï¼‰](#1-è§†å›¾views)
    - [1.1 åˆ›å»ºè§†å›¾](#11-åˆ›å»ºè§†å›¾)
    - [1.2 å¯æ›´æ–°è§†å›¾](#12-å¯æ›´æ–°è§†å›¾)
    - [1.3 è§†å›¾ç®¡ç†](#13-è§†å›¾ç®¡ç†)
  - [2. ç‰©åŒ–è§†å›¾ï¼ˆMaterialized Viewsï¼‰](#2-ç‰©åŒ–è§†å›¾materialized-views)
    - [2.1 åˆ›å»ºç‰©åŒ–è§†å›¾](#21-åˆ›å»ºç‰©åŒ–è§†å›¾)
    - [2.2 åˆ·æ–°ç‰©åŒ–è§†å›¾](#22-åˆ·æ–°ç‰©åŒ–è§†å›¾)
    - [2.3 ç‰©åŒ–è§†å›¾ç´¢å¼•](#23-ç‰©åŒ–è§†å›¾ç´¢å¼•)
  - [3. å®è·µç»ƒä¹ ](#3-å®è·µç»ƒä¹ )
    - [ç»ƒä¹  1: åˆ›å»ºç»Ÿè®¡è§†å›¾](#ç»ƒä¹ -1-åˆ›å»ºç»Ÿè®¡è§†å›¾)
  - [4. å‚è€ƒèµ„æ–™](#4-å‚è€ƒèµ„æ–™)

---

## 1. è§†å›¾ï¼ˆViewsï¼‰

### 1.1 åˆ›å»ºè§†å›¾

```sql
-- åˆ›å»ºç®€å•è§†å›¾
CREATE VIEW active_users AS
SELECT id, name, email
FROM users
WHERE is_active = TRUE;

-- ä½¿ç”¨è§†å›¾
SELECT * FROM active_users;

-- åˆ›å»ºå¤æ‚è§†å›¾
CREATE VIEW user_order_summary AS
SELECT
    u.id AS user_id,
    u.name,
    COUNT(o.id) AS order_count,
    SUM(o.total_amount) AS total_spent,
    AVG(o.total_amount) AS avg_order_amount
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;

-- æŸ¥çœ‹è§†å›¾å®šä¹‰
SELECT definition FROM pg_views WHERE viewname = 'active_users';
```

### 1.2 å¯æ›´æ–°è§†å›¾

```sql
-- åˆ›å»ºå¯æ›´æ–°è§†å›¾
CREATE VIEW user_orders AS
SELECT u.id AS user_id, u.name, o.id AS order_id, o.total_amount
FROM users u
JOIN orders o ON u.id = o.user_id;

-- æ›´æ–°è§†å›¾ï¼ˆä¼šæ›´æ–°åº•å±‚è¡¨ï¼‰
UPDATE user_orders SET name = 'New Name' WHERE user_id = 1;
```

### 1.3 è§†å›¾ç®¡ç†

```sql
-- ä¿®æ”¹è§†å›¾
CREATE OR REPLACE VIEW active_users AS
SELECT id, name, email, created_at
FROM users
WHERE is_active = TRUE;

-- åˆ é™¤è§†å›¾
DROP VIEW active_users;

-- é‡å‘½åè§†å›¾
ALTER VIEW active_users RENAME TO active_users_view;
```

## 2. ç‰©åŒ–è§†å›¾ï¼ˆMaterialized Viewsï¼‰

### 2.1 åˆ›å»ºç‰©åŒ–è§†å›¾

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW user_order_summary AS
SELECT
    u.id AS user_id,
    u.name,
    COUNT(o.id) AS order_count,
    SUM(o.total_amount) AS total_spent,
    AVG(o.total_amount) AS avg_order_amount
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name;

-- æŸ¥è¯¢ç‰©åŒ–è§†å›¾
SELECT * FROM user_order_summary;
```

### 2.2 åˆ·æ–°ç‰©åŒ–è§†å›¾

```sql
-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW user_order_summary;

-- å¹¶å‘åˆ·æ–°ï¼ˆPostgreSQL 9.4+ï¼Œéœ€è¦å”¯ä¸€ç´¢å¼•ï¼‰
CREATE UNIQUE INDEX ON user_order_summary(user_id);
REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_summary;
```

### 2.3 ç‰©åŒ–è§†å›¾ç´¢å¼•

```sql
-- åœ¨ç‰©åŒ–è§†å›¾ä¸Šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_order_summary_user_id ON user_order_summary(user_id);
CREATE INDEX idx_user_order_summary_total_spent ON user_order_summary(total_spent);
```

## 3. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºç»Ÿè®¡è§†å›¾

```sql
-- ä»»åŠ¡: åˆ›å»ºä¸€ä¸ªè§†å›¾æ˜¾ç¤ºæ¯ä¸ªéƒ¨é—¨çš„ç»Ÿè®¡ä¿¡æ¯
CREATE VIEW department_stats AS
SELECT
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary,
    MIN(salary) AS min_salary,
    MAX(salary) AS max_salary
FROM employees
GROUP BY department;
```

## 4. å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - è§†å›¾](https://www.postgresql.org/docs/current/tutorial-views.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - ç‰©åŒ–è§†å›¾](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)

---

**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 1 æ—¥
**ç»´æŠ¤è€…**: PostgreSQL Modern Team
**æ–‡æ¡£ç¼–å·**: 03-03-07
