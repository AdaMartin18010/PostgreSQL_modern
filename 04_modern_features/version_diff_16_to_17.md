# PostgreSQL 16 → 17 版本差异与迁移注意

> 基于 PostgreSQL 17 官方发行说明（2024年9月26日发布）  
> **最后验证日期**：2025-10-03

## 主要新特性

### 1. JSON 功能大幅增强

- **JSON_TABLE() 函数**：将 JSON 数据转换为表格形式，支持复杂的 JSON 查询
- **新增 JSON 构造函数**：`JSON()`、`JSON_SCALAR()`、`JSON_SERIALIZE()`
- **新增 JSON 查询函数**：`JSON_EXISTS()`、`JSON_QUERY()`、`JSON_VALUE()`
- **影响**：显著提升 JSON 数据处理能力，简化复杂 JSON 查询

### 2. 性能优化

- **VACUUM 内存管理优化**：减少内存消耗，提高清理性能
- **流式 I/O 顺序读取**：提升大表扫描性能
- **高并发写入吞吐量提升**：优化多用户写入场景
- **B-tree 索引多值搜索优化**：提升复合条件查询性能

### 3. 逻辑复制增强

- **故障转移控制**：提高逻辑复制在高可用环境中的可靠性
- **pg_createsubscriber 工具**：在物理备用服务器上创建逻辑复制订阅者
- **升级过程保留状态**：pg_upgrade 保留逻辑复制槽和订阅状态
- **影响**：简化逻辑复制管理，提高高可用部署的稳定性

### 4. 备份恢复改进

- **pg_basebackup 增量备份**：支持增量备份，减少备份时间和存储空间
- **COPY 命令增强**：新增 `ON_ERROR ignore` 选项，提高数据导入容错性
- **影响**：显著提升备份效率，简化数据迁移流程

### 5. 连接与安全

- **sslnegotiation=direct**：新增客户端连接选项，执行直接 TLS 握手
- **影响**：减少连接建立时间，提高连接效率

## 迁移前检查

### 扩展兼容性验证

**pgvector（向量数据库扩展）**：

- **推荐版本**：v0.8.0（2024年12月发布）
- **最低版本**：v0.7.0
- **新特性**：HNSW索引性能优化、Half-precision向量支持、改进的距离计算
- **验证方法**：`SELECT * FROM pg_available_extensions WHERE name = 'vector';`
- **下载地址**：<https://github.com/pgvector/pgvector/releases/tag/v0.8.0>

**TimescaleDB（时序数据库扩展）**：

- **推荐版本**：2.17.2（2024年10月发布）
- **最低版本**：2.16.0
- **新特性**：增强的连续聚合、改进的压缩算法、更快的chunk操作
- **验证方法**：`SELECT extversion FROM pg_extension WHERE extname = 'timescaledb';`
- **下载地址**：<https://github.com/timescale/timescaledb/releases/tag/2.17.2>

**PostGIS（地理空间扩展）**：

- **推荐版本**：3.5.0（2024年11月发布）
- **最低版本**：3.4.0
- **新特性**：性能改进（ST_Intersection优化）、新的几何函数、GEOS 3.13支持
- **验证方法**：`SELECT PostGIS_Full_Version();`
- **下载地址**：<https://postgis.net/source/>

**Citus（分布式PostgreSQL扩展）**：

- **推荐版本**：12.1.4（2024年8月发布）
- **最低版本**：12.0.0
- **新特性**：分布式锁优化、跨分片查询性能提升、改进的重平衡机制
- **验证方法**：`SELECT * FROM citus_version();`
- **下载地址**：<https://github.com/citusdata/citus/releases/tag/v12.1.4>

> **最后验证日期**：2025-10-03  
> **下次验证计划**：2025-11-01（每月1日自动检查）

### 配置参数检查

- **新增参数**：检查是否有新的配置参数需要调整
- **弃用参数**：确认现有配置中无已弃用参数
- **默认值变化**：验证默认值变化对现有应用的影响

### 应用兼容性测试

- **JSON 查询**：测试现有 JSON 查询是否受新函数影响
- **逻辑复制**：验证现有逻辑复制配置的兼容性
- **备份脚本**：测试现有备份脚本与新增量备份功能的兼容性
- **连接字符串**：验证应用连接配置是否需要更新

### 数据一致性验证

- **备份校验**：执行完整备份 + PITR 恢复测试
- **数据完整性**：验证关键业务数据的完整性
- **性能基准**：建立升级前的性能基线

## 迁移路径

### 升级方式选择

- **原地升级（pg_upgrade）**：
  - 优势：速度快，保留所有配置和权限
  - 适用：停机时间可接受，配置复杂的环境
  - 注意：需要验证扩展兼容性
- **逻辑迁移（pg_dump/pg_restore）**：
  - 优势：更安全，可跨平台迁移
  - 适用：需要跨平台或大幅配置变更
  - 注意：需要重新配置权限和扩展

### 风险控制策略

- **灰度发布**：先在测试环境验证，再逐步推广到生产
- **读写分离**：升级期间使用只读副本提供服务
- **回退窗口**：保留足够时间窗口用于回滚操作
- **数据同步**：确保主从数据一致性

### 回滚预案

- **保持旧集群**：升级期间保持旧版本集群运行
- **数据一致性验证**：升级前后对比关键数据
- **快速回切机制**：准备快速切换回旧版本的流程

## 迁移后验证

### 性能基准对比

- **TPS/QPS**：对比升级前后的吞吐量
- **延迟指标**：P95/P99 响应时间对比
- **资源使用**：CPU、内存、I/O 使用率对比
- **锁等待**：检查锁竞争和等待情况
- **WAL 指标**：WAL 生成量和复制延迟

### 功能验证

- **JSON 新功能**：测试 JSON_TABLE() 等新函数
- **逻辑复制**：验证逻辑复制正常工作
- **备份恢复**：测试新增量备份功能
- **连接优化**：验证 sslnegotiation=direct 效果

### 业务验证

- **关键业务**：验证核心业务流程正常
- **数据完整性**：检查关键数据的一致性
- **监控告警**：确认监控系统正常工作
- **备份作业**：验证定时备份任务正常执行

## 参考

- 官方发行说明：`<https://www.postgresql.org/docs/release/`>
- 各扩展 Releases：见 `00_overview/README.md`
