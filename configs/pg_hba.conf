# PostgreSQL Client Authentication Configuration File
# ===================================================
#
# 格式: TYPE  DATABASE  USER  ADDRESS  METHOD  [OPTIONS]

# TYPE 类型:
#   local      - Unix域套接字连接
#   host       - TCP/IP连接（SSL或非SSL）
#   hostssl    - 仅SSL TCP/IP连接
#   hostnossl  - 仅非SSL TCP/IP连接

# DATABASE 数据库:
#   all           - 所有数据库
#   sameuser      - 同名数据库
#   samerole      - 用户角色可访问的数据库
#   replication   - 复制连接
#   database_name - 特定数据库名

# USER 用户:
#   all       - 所有用户
#   username  - 特定用户
#   @file     - 从文件读取用户列表
#   +role     - 特定角色的所有用户

# METHOD 认证方法:
#   trust              - 无密码（不安全，仅本地开发）
#   reject             - 拒绝连接
#   scram-sha-256      - SCRAM认证（推荐）
#   md5                - MD5认证（已过时）
#   password           - 明文密码（不安全）
#   peer               - Unix用户认证
#   cert               - SSL证书认证

#------------------------------------------------------------------------------
# 本地连接（Unix Socket）
#------------------------------------------------------------------------------

# postgres超级用户（仅本地）
local   all             postgres                                peer

# 本地所有用户
local   all             all                                     scram-sha-256

#------------------------------------------------------------------------------
# IPv4本地连接
#------------------------------------------------------------------------------

# localhost连接
host    all             all             127.0.0.1/32            scram-sha-256

#------------------------------------------------------------------------------
# 生产应用连接
#------------------------------------------------------------------------------

# 应用服务器（建议使用SSL）
hostssl all             app_user        10.0.1.0/24             scram-sha-256

# 只读用户（报表、分析）
hostssl all             readonly        10.0.2.0/24             scram-sha-256

# 管理用户（DBA）
hostssl all             dba_user        10.0.0.10/32            scram-sha-256 clientcert=1

#------------------------------------------------------------------------------
# 复制连接
#------------------------------------------------------------------------------

# 主从复制（从服务器）
hostssl replication     replicator      10.0.10.0/24            scram-sha-256

# 逻辑复制
hostssl all             replication     10.0.10.0/24            scram-sha-256

#------------------------------------------------------------------------------
# 开发/测试环境（仅示例，生产环境删除）
#------------------------------------------------------------------------------

# 开发环境（内网）
# host    all             all             192.168.1.0/24          scram-sha-256

#------------------------------------------------------------------------------
# IPv6本地连接
#------------------------------------------------------------------------------

host    all             all             ::1/128                 scram-sha-256

#------------------------------------------------------------------------------
# 拒绝规则（放在最后）
#------------------------------------------------------------------------------

# 拒绝所有其他连接
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject

#------------------------------------------------------------------------------
# 安全建议
#------------------------------------------------------------------------------

# 1. 优先使用 scram-sha-256 而非 md5
# 2. 生产环境使用 hostssl 强制SSL
# 3. 限制IP地址范围，避免 0.0.0.0/0
# 4. 重要账户使用客户端证书认证（clientcert=1）
# 5. 定期审查和更新规则
# 6. 超级用户仅允许本地连接
# 7. 使用专用角色而非超级用户

#------------------------------------------------------------------------------
# 用户创建示例
#------------------------------------------------------------------------------

# 创建应用用户:
# CREATE ROLE app_user LOGIN PASSWORD 'strong_password';
# GRANT CONNECT ON DATABASE mydb TO app_user;
# GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;

# 创建只读用户:
# CREATE ROLE readonly LOGIN PASSWORD 'strong_password';
# GRANT CONNECT ON DATABASE mydb TO readonly;
# GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;

# 创建复制用户:
# CREATE ROLE replicator REPLICATION LOGIN PASSWORD 'strong_password';

#------------------------------------------------------------------------------
# 应用修改
#------------------------------------------------------------------------------

# 修改此文件后，重新加载配置:
# SELECT pg_reload_conf();
# 或
# sudo systemctl reload postgresql

#------------------------------------------------------------------------------
# 故障排查
#------------------------------------------------------------------------------

# 如果连接被拒绝，检查:
# 1. postgresql.conf中的listen_addresses
# 2. 防火墙规则（iptables/firewalld）
# 3. 此文件的规则顺序（从上到下匹配）
# 4. 查看PostgreSQL日志: tail -f /var/log/postgresql/postgresql-*.log
